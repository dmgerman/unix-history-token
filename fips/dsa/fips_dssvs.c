begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_include
include|#
directive|include
file|<openssl/opensslconf.h>
end_include

begin_ifndef
ifndef|#
directive|ifndef
name|OPENSSL_FIPS
end_ifndef

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_function
name|int
name|main
parameter_list|(
name|int
name|argc
parameter_list|,
name|char
modifier|*
modifier|*
name|argv
parameter_list|)
block|{
name|printf
argument_list|(
literal|"No FIPS DSA support\n"
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_else
else|#
directive|else
end_else

begin_include
include|#
directive|include
file|<openssl/bn.h>
end_include

begin_include
include|#
directive|include
file|<openssl/dsa.h>
end_include

begin_include
include|#
directive|include
file|<openssl/fips.h>
end_include

begin_include
include|#
directive|include
file|<openssl/err.h>
end_include

begin_include
include|#
directive|include
file|<openssl/evp.h>
end_include

begin_include
include|#
directive|include
file|<string.h>
end_include

begin_include
include|#
directive|include
file|<ctype.h>
end_include

begin_include
include|#
directive|include
file|"fips_utl.h"
end_include

begin_function
specifier|static
name|void
name|pbn
parameter_list|(
specifier|const
name|char
modifier|*
name|name
parameter_list|,
name|BIGNUM
modifier|*
name|bn
parameter_list|)
block|{
name|int
name|len
decl_stmt|,
name|i
decl_stmt|;
name|unsigned
name|char
modifier|*
name|tmp
decl_stmt|;
name|len
operator|=
name|BN_num_bytes
argument_list|(
name|bn
argument_list|)
expr_stmt|;
name|tmp
operator|=
name|OPENSSL_malloc
argument_list|(
name|len
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|tmp
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Memory allocation error\n"
argument_list|)
expr_stmt|;
return|return;
block|}
name|BN_bn2bin
argument_list|(
name|bn
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"%s = "
argument_list|,
name|name
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|len
condition|;
name|i
operator|++
control|)
name|printf
argument_list|(
literal|"%02X"
argument_list|,
name|tmp
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|fputs
argument_list|(
literal|"\n"
argument_list|,
name|stdout
argument_list|)
expr_stmt|;
name|OPENSSL_free
argument_list|(
name|tmp
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_function
specifier|static
name|void
name|primes
parameter_list|()
block|{
name|char
name|buf
index|[
literal|10240
index|]
decl_stmt|;
name|char
name|lbuf
index|[
literal|10240
index|]
decl_stmt|;
name|char
modifier|*
name|keyword
decl_stmt|,
modifier|*
name|value
decl_stmt|;
while|while
condition|(
name|fgets
argument_list|(
name|buf
argument_list|,
sizeof|sizeof
name|buf
argument_list|,
name|stdin
argument_list|)
operator|!=
name|NULL
condition|)
block|{
name|fputs
argument_list|(
name|buf
argument_list|,
name|stdout
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|parse_line
argument_list|(
operator|&
name|keyword
argument_list|,
operator|&
name|value
argument_list|,
name|lbuf
argument_list|,
name|buf
argument_list|)
condition|)
continue|continue;
if|if
condition|(
operator|!
name|strcmp
argument_list|(
name|keyword
argument_list|,
literal|"Prime"
argument_list|)
condition|)
block|{
name|BIGNUM
modifier|*
name|pp
decl_stmt|;
name|pp
operator|=
name|BN_new
argument_list|()
expr_stmt|;
name|do_hex2bn
argument_list|(
operator|&
name|pp
argument_list|,
name|value
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"result= %c\n"
argument_list|,
name|BN_is_prime_ex
argument_list|(
name|pp
argument_list|,
literal|20
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
condition|?
literal|'P'
else|:
literal|'F'
argument_list|)
expr_stmt|;
block|}
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|pqg
parameter_list|()
block|{
name|char
name|buf
index|[
literal|1024
index|]
decl_stmt|;
name|char
name|lbuf
index|[
literal|1024
index|]
decl_stmt|;
name|char
modifier|*
name|keyword
decl_stmt|,
modifier|*
name|value
decl_stmt|;
name|int
name|nmod
init|=
literal|0
decl_stmt|;
while|while
condition|(
name|fgets
argument_list|(
name|buf
argument_list|,
sizeof|sizeof
name|buf
argument_list|,
name|stdin
argument_list|)
operator|!=
name|NULL
condition|)
block|{
if|if
condition|(
operator|!
name|parse_line
argument_list|(
operator|&
name|keyword
argument_list|,
operator|&
name|value
argument_list|,
name|lbuf
argument_list|,
name|buf
argument_list|)
condition|)
block|{
name|fputs
argument_list|(
name|buf
argument_list|,
name|stdout
argument_list|)
expr_stmt|;
continue|continue;
block|}
if|if
condition|(
operator|!
name|strcmp
argument_list|(
name|keyword
argument_list|,
literal|"[mod"
argument_list|)
condition|)
name|nmod
operator|=
name|atoi
argument_list|(
name|value
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
operator|!
name|strcmp
argument_list|(
name|keyword
argument_list|,
literal|"N"
argument_list|)
condition|)
block|{
name|int
name|n
init|=
name|atoi
argument_list|(
name|value
argument_list|)
decl_stmt|;
name|printf
argument_list|(
literal|"[mod = %d]\n\n"
argument_list|,
name|nmod
argument_list|)
expr_stmt|;
while|while
condition|(
name|n
operator|--
condition|)
block|{
name|unsigned
name|char
name|seed
index|[
literal|20
index|]
decl_stmt|;
name|DSA
modifier|*
name|dsa
decl_stmt|;
name|int
name|counter
decl_stmt|;
name|unsigned
name|long
name|h
decl_stmt|;
name|dsa
operator|=
name|FIPS_dsa_new
argument_list|()
expr_stmt|;
if|if
condition|(
operator|!
name|DSA_generate_parameters_ex
argument_list|(
name|dsa
argument_list|,
name|nmod
argument_list|,
name|seed
argument_list|,
literal|0
argument_list|,
operator|&
name|counter
argument_list|,
operator|&
name|h
argument_list|,
name|NULL
argument_list|)
condition|)
block|{
name|do_print_errors
argument_list|()
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
name|pbn
argument_list|(
literal|"P"
argument_list|,
name|dsa
operator|->
name|p
argument_list|)
expr_stmt|;
name|pbn
argument_list|(
literal|"Q"
argument_list|,
name|dsa
operator|->
name|q
argument_list|)
expr_stmt|;
name|pbn
argument_list|(
literal|"G"
argument_list|,
name|dsa
operator|->
name|g
argument_list|)
expr_stmt|;
name|pv
argument_list|(
literal|"Seed"
argument_list|,
name|seed
argument_list|,
literal|20
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"c = %d\n"
argument_list|,
name|counter
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"H = %lx\n"
argument_list|,
name|h
argument_list|)
expr_stmt|;
name|putc
argument_list|(
literal|'\n'
argument_list|,
name|stdout
argument_list|)
expr_stmt|;
block|}
block|}
else|else
name|fputs
argument_list|(
name|buf
argument_list|,
name|stdout
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|pqgver
parameter_list|()
block|{
name|char
name|buf
index|[
literal|1024
index|]
decl_stmt|;
name|char
name|lbuf
index|[
literal|1024
index|]
decl_stmt|;
name|char
modifier|*
name|keyword
decl_stmt|,
modifier|*
name|value
decl_stmt|;
name|BIGNUM
modifier|*
name|p
init|=
name|NULL
decl_stmt|,
modifier|*
name|q
init|=
name|NULL
decl_stmt|,
modifier|*
name|g
init|=
name|NULL
decl_stmt|;
name|int
name|counter
decl_stmt|,
name|counter2
decl_stmt|;
name|unsigned
name|long
name|h
decl_stmt|,
name|h2
decl_stmt|;
name|DSA
modifier|*
name|dsa
init|=
name|NULL
decl_stmt|;
name|int
name|nmod
init|=
literal|0
decl_stmt|;
name|unsigned
name|char
name|seed
index|[
literal|1024
index|]
decl_stmt|;
while|while
condition|(
name|fgets
argument_list|(
name|buf
argument_list|,
sizeof|sizeof
name|buf
argument_list|,
name|stdin
argument_list|)
operator|!=
name|NULL
condition|)
block|{
if|if
condition|(
operator|!
name|parse_line
argument_list|(
operator|&
name|keyword
argument_list|,
operator|&
name|value
argument_list|,
name|lbuf
argument_list|,
name|buf
argument_list|)
condition|)
block|{
name|fputs
argument_list|(
name|buf
argument_list|,
name|stdout
argument_list|)
expr_stmt|;
continue|continue;
block|}
name|fputs
argument_list|(
name|buf
argument_list|,
name|stdout
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|strcmp
argument_list|(
name|keyword
argument_list|,
literal|"[mod"
argument_list|)
condition|)
name|nmod
operator|=
name|atoi
argument_list|(
name|value
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
operator|!
name|strcmp
argument_list|(
name|keyword
argument_list|,
literal|"P"
argument_list|)
condition|)
name|p
operator|=
name|hex2bn
argument_list|(
name|value
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
operator|!
name|strcmp
argument_list|(
name|keyword
argument_list|,
literal|"Q"
argument_list|)
condition|)
name|q
operator|=
name|hex2bn
argument_list|(
name|value
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
operator|!
name|strcmp
argument_list|(
name|keyword
argument_list|,
literal|"G"
argument_list|)
condition|)
name|g
operator|=
name|hex2bn
argument_list|(
name|value
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
operator|!
name|strcmp
argument_list|(
name|keyword
argument_list|,
literal|"Seed"
argument_list|)
condition|)
block|{
name|int
name|slen
init|=
name|hex2bin
argument_list|(
name|value
argument_list|,
name|seed
argument_list|)
decl_stmt|;
if|if
condition|(
name|slen
operator|!=
literal|20
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Seed parse length error\n"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
block|}
elseif|else
if|if
condition|(
operator|!
name|strcmp
argument_list|(
name|keyword
argument_list|,
literal|"c"
argument_list|)
condition|)
name|counter
operator|=
name|atoi
argument_list|(
name|buf
operator|+
literal|4
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
operator|!
name|strcmp
argument_list|(
name|keyword
argument_list|,
literal|"H"
argument_list|)
condition|)
block|{
name|h
operator|=
name|atoi
argument_list|(
name|value
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|p
operator|||
operator|!
name|q
operator|||
operator|!
name|g
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Parse Error\n"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
name|dsa
operator|=
name|FIPS_dsa_new
argument_list|()
expr_stmt|;
if|if
condition|(
operator|!
name|DSA_generate_parameters_ex
argument_list|(
name|dsa
argument_list|,
name|nmod
argument_list|,
name|seed
argument_list|,
literal|20
argument_list|,
operator|&
name|counter2
argument_list|,
operator|&
name|h2
argument_list|,
name|NULL
argument_list|)
condition|)
block|{
name|do_print_errors
argument_list|()
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|BN_cmp
argument_list|(
name|dsa
operator|->
name|p
argument_list|,
name|p
argument_list|)
operator|||
name|BN_cmp
argument_list|(
name|dsa
operator|->
name|q
argument_list|,
name|q
argument_list|)
operator|||
name|BN_cmp
argument_list|(
name|dsa
operator|->
name|g
argument_list|,
name|g
argument_list|)
operator|||
operator|(
name|counter
operator|!=
name|counter2
operator|)
operator|||
operator|(
name|h
operator|!=
name|h2
operator|)
condition|)
name|printf
argument_list|(
literal|"Result = F\n"
argument_list|)
expr_stmt|;
else|else
name|printf
argument_list|(
literal|"Result = P\n"
argument_list|)
expr_stmt|;
name|BN_free
argument_list|(
name|p
argument_list|)
expr_stmt|;
name|BN_free
argument_list|(
name|q
argument_list|)
expr_stmt|;
name|BN_free
argument_list|(
name|g
argument_list|)
expr_stmt|;
name|p
operator|=
name|NULL
expr_stmt|;
name|q
operator|=
name|NULL
expr_stmt|;
name|g
operator|=
name|NULL
expr_stmt|;
name|FIPS_dsa_free
argument_list|(
name|dsa
argument_list|)
expr_stmt|;
name|dsa
operator|=
name|NULL
expr_stmt|;
block|}
block|}
block|}
end_function

begin_comment
comment|/* Keypair verification routine. NB: this isn't part of the standard FIPS140-2  * algorithm tests. It is an additional test to perform sanity checks on the  * output of the KeyPair test.  */
end_comment

begin_function
specifier|static
name|int
name|dss_paramcheck
parameter_list|(
name|int
name|nmod
parameter_list|,
name|BIGNUM
modifier|*
name|p
parameter_list|,
name|BIGNUM
modifier|*
name|q
parameter_list|,
name|BIGNUM
modifier|*
name|g
parameter_list|,
name|BN_CTX
modifier|*
name|ctx
parameter_list|)
block|{
name|BIGNUM
modifier|*
name|rem
init|=
name|NULL
decl_stmt|;
if|if
condition|(
name|BN_num_bits
argument_list|(
name|p
argument_list|)
operator|!=
name|nmod
condition|)
return|return
literal|0
return|;
if|if
condition|(
name|BN_num_bits
argument_list|(
name|q
argument_list|)
operator|!=
literal|160
condition|)
return|return
literal|0
return|;
if|if
condition|(
name|BN_is_prime_ex
argument_list|(
name|p
argument_list|,
name|BN_prime_checks
argument_list|,
name|ctx
argument_list|,
name|NULL
argument_list|)
operator|!=
literal|1
condition|)
return|return
literal|0
return|;
if|if
condition|(
name|BN_is_prime_ex
argument_list|(
name|q
argument_list|,
name|BN_prime_checks
argument_list|,
name|ctx
argument_list|,
name|NULL
argument_list|)
operator|!=
literal|1
condition|)
return|return
literal|0
return|;
name|rem
operator|=
name|BN_new
argument_list|()
expr_stmt|;
if|if
condition|(
operator|!
name|BN_mod
argument_list|(
name|rem
argument_list|,
name|p
argument_list|,
name|q
argument_list|,
name|ctx
argument_list|)
operator|||
operator|!
name|BN_is_one
argument_list|(
name|rem
argument_list|)
operator|||
operator|(
name|BN_cmp
argument_list|(
name|g
argument_list|,
name|BN_value_one
argument_list|()
argument_list|)
operator|<=
literal|0
operator|)
operator|||
operator|!
name|BN_mod_exp
argument_list|(
name|rem
argument_list|,
name|g
argument_list|,
name|q
argument_list|,
name|p
argument_list|,
name|ctx
argument_list|)
operator|||
operator|!
name|BN_is_one
argument_list|(
name|rem
argument_list|)
condition|)
block|{
name|BN_free
argument_list|(
name|rem
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
comment|/* Todo: check g */
name|BN_free
argument_list|(
name|rem
argument_list|)
expr_stmt|;
return|return
literal|1
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|keyver
parameter_list|()
block|{
name|char
name|buf
index|[
literal|1024
index|]
decl_stmt|;
name|char
name|lbuf
index|[
literal|1024
index|]
decl_stmt|;
name|char
modifier|*
name|keyword
decl_stmt|,
modifier|*
name|value
decl_stmt|;
name|BIGNUM
modifier|*
name|p
init|=
name|NULL
decl_stmt|,
modifier|*
name|q
init|=
name|NULL
decl_stmt|,
modifier|*
name|g
init|=
name|NULL
decl_stmt|,
modifier|*
name|X
init|=
name|NULL
decl_stmt|,
modifier|*
name|Y
init|=
name|NULL
decl_stmt|;
name|BIGNUM
modifier|*
name|Y2
decl_stmt|;
name|BN_CTX
modifier|*
name|ctx
init|=
name|NULL
decl_stmt|;
name|int
name|nmod
init|=
literal|0
decl_stmt|,
name|paramcheck
init|=
literal|0
decl_stmt|;
name|ctx
operator|=
name|BN_CTX_new
argument_list|()
expr_stmt|;
name|Y2
operator|=
name|BN_new
argument_list|()
expr_stmt|;
while|while
condition|(
name|fgets
argument_list|(
name|buf
argument_list|,
sizeof|sizeof
name|buf
argument_list|,
name|stdin
argument_list|)
operator|!=
name|NULL
condition|)
block|{
if|if
condition|(
operator|!
name|parse_line
argument_list|(
operator|&
name|keyword
argument_list|,
operator|&
name|value
argument_list|,
name|lbuf
argument_list|,
name|buf
argument_list|)
condition|)
block|{
name|fputs
argument_list|(
name|buf
argument_list|,
name|stdout
argument_list|)
expr_stmt|;
continue|continue;
block|}
if|if
condition|(
operator|!
name|strcmp
argument_list|(
name|keyword
argument_list|,
literal|"[mod"
argument_list|)
condition|)
block|{
if|if
condition|(
name|p
condition|)
name|BN_free
argument_list|(
name|p
argument_list|)
expr_stmt|;
name|p
operator|=
name|NULL
expr_stmt|;
if|if
condition|(
name|q
condition|)
name|BN_free
argument_list|(
name|q
argument_list|)
expr_stmt|;
name|q
operator|=
name|NULL
expr_stmt|;
if|if
condition|(
name|g
condition|)
name|BN_free
argument_list|(
name|g
argument_list|)
expr_stmt|;
name|g
operator|=
name|NULL
expr_stmt|;
name|paramcheck
operator|=
literal|0
expr_stmt|;
name|nmod
operator|=
name|atoi
argument_list|(
name|value
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|!
name|strcmp
argument_list|(
name|keyword
argument_list|,
literal|"P"
argument_list|)
condition|)
name|p
operator|=
name|hex2bn
argument_list|(
name|value
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
operator|!
name|strcmp
argument_list|(
name|keyword
argument_list|,
literal|"Q"
argument_list|)
condition|)
name|q
operator|=
name|hex2bn
argument_list|(
name|value
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
operator|!
name|strcmp
argument_list|(
name|keyword
argument_list|,
literal|"G"
argument_list|)
condition|)
name|g
operator|=
name|hex2bn
argument_list|(
name|value
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
operator|!
name|strcmp
argument_list|(
name|keyword
argument_list|,
literal|"X"
argument_list|)
condition|)
name|X
operator|=
name|hex2bn
argument_list|(
name|value
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
operator|!
name|strcmp
argument_list|(
name|keyword
argument_list|,
literal|"Y"
argument_list|)
condition|)
block|{
name|Y
operator|=
name|hex2bn
argument_list|(
name|value
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|p
operator|||
operator|!
name|q
operator|||
operator|!
name|g
operator|||
operator|!
name|X
operator|||
operator|!
name|Y
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Parse Error\n"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
name|pbn
argument_list|(
literal|"P"
argument_list|,
name|p
argument_list|)
expr_stmt|;
name|pbn
argument_list|(
literal|"Q"
argument_list|,
name|q
argument_list|)
expr_stmt|;
name|pbn
argument_list|(
literal|"G"
argument_list|,
name|g
argument_list|)
expr_stmt|;
name|pbn
argument_list|(
literal|"X"
argument_list|,
name|X
argument_list|)
expr_stmt|;
name|pbn
argument_list|(
literal|"Y"
argument_list|,
name|Y
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|paramcheck
condition|)
block|{
if|if
condition|(
name|dss_paramcheck
argument_list|(
name|nmod
argument_list|,
name|p
argument_list|,
name|q
argument_list|,
name|g
argument_list|,
name|ctx
argument_list|)
condition|)
name|paramcheck
operator|=
literal|1
expr_stmt|;
else|else
name|paramcheck
operator|=
operator|-
literal|1
expr_stmt|;
block|}
if|if
condition|(
name|paramcheck
operator|!=
literal|1
condition|)
name|printf
argument_list|(
literal|"Result = F\n"
argument_list|)
expr_stmt|;
else|else
block|{
if|if
condition|(
operator|!
name|BN_mod_exp
argument_list|(
name|Y2
argument_list|,
name|g
argument_list|,
name|X
argument_list|,
name|p
argument_list|,
name|ctx
argument_list|)
operator|||
name|BN_cmp
argument_list|(
name|Y2
argument_list|,
name|Y
argument_list|)
condition|)
name|printf
argument_list|(
literal|"Result = F\n"
argument_list|)
expr_stmt|;
else|else
name|printf
argument_list|(
literal|"Result = P\n"
argument_list|)
expr_stmt|;
block|}
name|BN_free
argument_list|(
name|X
argument_list|)
expr_stmt|;
name|BN_free
argument_list|(
name|Y
argument_list|)
expr_stmt|;
name|X
operator|=
name|NULL
expr_stmt|;
name|Y
operator|=
name|NULL
expr_stmt|;
block|}
block|}
if|if
condition|(
name|p
condition|)
name|BN_free
argument_list|(
name|p
argument_list|)
expr_stmt|;
if|if
condition|(
name|q
condition|)
name|BN_free
argument_list|(
name|q
argument_list|)
expr_stmt|;
if|if
condition|(
name|g
condition|)
name|BN_free
argument_list|(
name|g
argument_list|)
expr_stmt|;
if|if
condition|(
name|Y2
condition|)
name|BN_free
argument_list|(
name|Y2
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|keypair
parameter_list|()
block|{
name|char
name|buf
index|[
literal|1024
index|]
decl_stmt|;
name|char
name|lbuf
index|[
literal|1024
index|]
decl_stmt|;
name|char
modifier|*
name|keyword
decl_stmt|,
modifier|*
name|value
decl_stmt|;
name|int
name|nmod
init|=
literal|0
decl_stmt|;
while|while
condition|(
name|fgets
argument_list|(
name|buf
argument_list|,
sizeof|sizeof
name|buf
argument_list|,
name|stdin
argument_list|)
operator|!=
name|NULL
condition|)
block|{
if|if
condition|(
operator|!
name|parse_line
argument_list|(
operator|&
name|keyword
argument_list|,
operator|&
name|value
argument_list|,
name|lbuf
argument_list|,
name|buf
argument_list|)
condition|)
block|{
name|fputs
argument_list|(
name|buf
argument_list|,
name|stdout
argument_list|)
expr_stmt|;
continue|continue;
block|}
if|if
condition|(
operator|!
name|strcmp
argument_list|(
name|keyword
argument_list|,
literal|"[mod"
argument_list|)
condition|)
name|nmod
operator|=
name|atoi
argument_list|(
name|value
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
operator|!
name|strcmp
argument_list|(
name|keyword
argument_list|,
literal|"N"
argument_list|)
condition|)
block|{
name|DSA
modifier|*
name|dsa
decl_stmt|;
name|int
name|n
init|=
name|atoi
argument_list|(
name|value
argument_list|)
decl_stmt|;
name|printf
argument_list|(
literal|"[mod = %d]\n\n"
argument_list|,
name|nmod
argument_list|)
expr_stmt|;
name|dsa
operator|=
name|FIPS_dsa_new
argument_list|()
expr_stmt|;
if|if
condition|(
operator|!
name|DSA_generate_parameters_ex
argument_list|(
name|dsa
argument_list|,
name|nmod
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
condition|)
block|{
name|do_print_errors
argument_list|()
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
name|pbn
argument_list|(
literal|"P"
argument_list|,
name|dsa
operator|->
name|p
argument_list|)
expr_stmt|;
name|pbn
argument_list|(
literal|"Q"
argument_list|,
name|dsa
operator|->
name|q
argument_list|)
expr_stmt|;
name|pbn
argument_list|(
literal|"G"
argument_list|,
name|dsa
operator|->
name|g
argument_list|)
expr_stmt|;
name|putc
argument_list|(
literal|'\n'
argument_list|,
name|stdout
argument_list|)
expr_stmt|;
while|while
condition|(
name|n
operator|--
condition|)
block|{
if|if
condition|(
operator|!
name|DSA_generate_key
argument_list|(
name|dsa
argument_list|)
condition|)
block|{
name|do_print_errors
argument_list|()
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
name|pbn
argument_list|(
literal|"X"
argument_list|,
name|dsa
operator|->
name|priv_key
argument_list|)
expr_stmt|;
name|pbn
argument_list|(
literal|"Y"
argument_list|,
name|dsa
operator|->
name|pub_key
argument_list|)
expr_stmt|;
name|putc
argument_list|(
literal|'\n'
argument_list|,
name|stdout
argument_list|)
expr_stmt|;
block|}
block|}
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|siggen
parameter_list|()
block|{
name|char
name|buf
index|[
literal|1024
index|]
decl_stmt|;
name|char
name|lbuf
index|[
literal|1024
index|]
decl_stmt|;
name|char
modifier|*
name|keyword
decl_stmt|,
modifier|*
name|value
decl_stmt|;
name|int
name|nmod
init|=
literal|0
decl_stmt|;
name|DSA
modifier|*
name|dsa
init|=
name|NULL
decl_stmt|;
while|while
condition|(
name|fgets
argument_list|(
name|buf
argument_list|,
sizeof|sizeof
name|buf
argument_list|,
name|stdin
argument_list|)
operator|!=
name|NULL
condition|)
block|{
if|if
condition|(
operator|!
name|parse_line
argument_list|(
operator|&
name|keyword
argument_list|,
operator|&
name|value
argument_list|,
name|lbuf
argument_list|,
name|buf
argument_list|)
condition|)
block|{
name|fputs
argument_list|(
name|buf
argument_list|,
name|stdout
argument_list|)
expr_stmt|;
continue|continue;
block|}
if|if
condition|(
operator|!
name|strcmp
argument_list|(
name|keyword
argument_list|,
literal|"[mod"
argument_list|)
condition|)
block|{
name|nmod
operator|=
name|atoi
argument_list|(
name|value
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"[mod = %d]\n\n"
argument_list|,
name|nmod
argument_list|)
expr_stmt|;
if|if
condition|(
name|dsa
condition|)
name|FIPS_dsa_free
argument_list|(
name|dsa
argument_list|)
expr_stmt|;
name|dsa
operator|=
name|FIPS_dsa_new
argument_list|()
expr_stmt|;
if|if
condition|(
operator|!
name|DSA_generate_parameters_ex
argument_list|(
name|dsa
argument_list|,
name|nmod
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
condition|)
block|{
name|do_print_errors
argument_list|()
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
name|pbn
argument_list|(
literal|"P"
argument_list|,
name|dsa
operator|->
name|p
argument_list|)
expr_stmt|;
name|pbn
argument_list|(
literal|"Q"
argument_list|,
name|dsa
operator|->
name|q
argument_list|)
expr_stmt|;
name|pbn
argument_list|(
literal|"G"
argument_list|,
name|dsa
operator|->
name|g
argument_list|)
expr_stmt|;
name|putc
argument_list|(
literal|'\n'
argument_list|,
name|stdout
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|!
name|strcmp
argument_list|(
name|keyword
argument_list|,
literal|"Msg"
argument_list|)
condition|)
block|{
name|unsigned
name|char
name|msg
index|[
literal|1024
index|]
decl_stmt|;
name|unsigned
name|char
name|sbuf
index|[
literal|60
index|]
decl_stmt|;
name|unsigned
name|int
name|slen
decl_stmt|;
name|int
name|n
decl_stmt|;
name|EVP_PKEY
name|pk
decl_stmt|;
name|EVP_MD_CTX
name|mctx
decl_stmt|;
name|DSA_SIG
modifier|*
name|sig
decl_stmt|;
name|EVP_MD_CTX_init
argument_list|(
operator|&
name|mctx
argument_list|)
expr_stmt|;
name|n
operator|=
name|hex2bin
argument_list|(
name|value
argument_list|,
name|msg
argument_list|)
expr_stmt|;
name|pv
argument_list|(
literal|"Msg"
argument_list|,
name|msg
argument_list|,
name|n
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|DSA_generate_key
argument_list|(
name|dsa
argument_list|)
condition|)
block|{
name|do_print_errors
argument_list|()
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
name|pk
operator|.
name|type
operator|=
name|EVP_PKEY_DSA
expr_stmt|;
name|pk
operator|.
name|pkey
operator|.
name|dsa
operator|=
name|dsa
expr_stmt|;
name|pbn
argument_list|(
literal|"Y"
argument_list|,
name|dsa
operator|->
name|pub_key
argument_list|)
expr_stmt|;
name|EVP_SignInit_ex
argument_list|(
operator|&
name|mctx
argument_list|,
name|EVP_dss1
argument_list|()
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|EVP_SignUpdate
argument_list|(
operator|&
name|mctx
argument_list|,
name|msg
argument_list|,
name|n
argument_list|)
expr_stmt|;
name|EVP_SignFinal
argument_list|(
operator|&
name|mctx
argument_list|,
name|sbuf
argument_list|,
operator|&
name|slen
argument_list|,
operator|&
name|pk
argument_list|)
expr_stmt|;
name|sig
operator|=
name|DSA_SIG_new
argument_list|()
expr_stmt|;
name|FIPS_dsa_sig_decode
argument_list|(
name|sig
argument_list|,
name|sbuf
argument_list|,
name|slen
argument_list|)
expr_stmt|;
name|pbn
argument_list|(
literal|"R"
argument_list|,
name|sig
operator|->
name|r
argument_list|)
expr_stmt|;
name|pbn
argument_list|(
literal|"S"
argument_list|,
name|sig
operator|->
name|s
argument_list|)
expr_stmt|;
name|putc
argument_list|(
literal|'\n'
argument_list|,
name|stdout
argument_list|)
expr_stmt|;
name|DSA_SIG_free
argument_list|(
name|sig
argument_list|)
expr_stmt|;
name|EVP_MD_CTX_cleanup
argument_list|(
operator|&
name|mctx
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
name|dsa
condition|)
name|FIPS_dsa_free
argument_list|(
name|dsa
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|sigver
parameter_list|()
block|{
name|DSA
modifier|*
name|dsa
init|=
name|NULL
decl_stmt|;
name|char
name|buf
index|[
literal|1024
index|]
decl_stmt|;
name|char
name|lbuf
index|[
literal|1024
index|]
decl_stmt|;
name|unsigned
name|char
name|msg
index|[
literal|1024
index|]
decl_stmt|;
name|char
modifier|*
name|keyword
decl_stmt|,
modifier|*
name|value
decl_stmt|;
name|int
name|nmod
init|=
literal|0
decl_stmt|,
name|n
init|=
literal|0
decl_stmt|;
name|DSA_SIG
name|sg
decl_stmt|,
modifier|*
name|sig
init|=
operator|&
name|sg
decl_stmt|;
name|sig
operator|->
name|r
operator|=
name|NULL
expr_stmt|;
name|sig
operator|->
name|s
operator|=
name|NULL
expr_stmt|;
while|while
condition|(
name|fgets
argument_list|(
name|buf
argument_list|,
sizeof|sizeof
name|buf
argument_list|,
name|stdin
argument_list|)
operator|!=
name|NULL
condition|)
block|{
if|if
condition|(
operator|!
name|parse_line
argument_list|(
operator|&
name|keyword
argument_list|,
operator|&
name|value
argument_list|,
name|lbuf
argument_list|,
name|buf
argument_list|)
condition|)
block|{
name|fputs
argument_list|(
name|buf
argument_list|,
name|stdout
argument_list|)
expr_stmt|;
continue|continue;
block|}
if|if
condition|(
operator|!
name|strcmp
argument_list|(
name|keyword
argument_list|,
literal|"[mod"
argument_list|)
condition|)
block|{
name|nmod
operator|=
name|atoi
argument_list|(
name|value
argument_list|)
expr_stmt|;
if|if
condition|(
name|dsa
condition|)
name|FIPS_dsa_free
argument_list|(
name|dsa
argument_list|)
expr_stmt|;
name|dsa
operator|=
name|FIPS_dsa_new
argument_list|()
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|!
name|strcmp
argument_list|(
name|keyword
argument_list|,
literal|"P"
argument_list|)
condition|)
name|dsa
operator|->
name|p
operator|=
name|hex2bn
argument_list|(
name|value
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
operator|!
name|strcmp
argument_list|(
name|keyword
argument_list|,
literal|"Q"
argument_list|)
condition|)
name|dsa
operator|->
name|q
operator|=
name|hex2bn
argument_list|(
name|value
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
operator|!
name|strcmp
argument_list|(
name|keyword
argument_list|,
literal|"G"
argument_list|)
condition|)
block|{
name|dsa
operator|->
name|g
operator|=
name|hex2bn
argument_list|(
name|value
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"[mod = %d]\n\n"
argument_list|,
name|nmod
argument_list|)
expr_stmt|;
name|pbn
argument_list|(
literal|"P"
argument_list|,
name|dsa
operator|->
name|p
argument_list|)
expr_stmt|;
name|pbn
argument_list|(
literal|"Q"
argument_list|,
name|dsa
operator|->
name|q
argument_list|)
expr_stmt|;
name|pbn
argument_list|(
literal|"G"
argument_list|,
name|dsa
operator|->
name|g
argument_list|)
expr_stmt|;
name|putc
argument_list|(
literal|'\n'
argument_list|,
name|stdout
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|!
name|strcmp
argument_list|(
name|keyword
argument_list|,
literal|"Msg"
argument_list|)
condition|)
block|{
name|n
operator|=
name|hex2bin
argument_list|(
name|value
argument_list|,
name|msg
argument_list|)
expr_stmt|;
name|pv
argument_list|(
literal|"Msg"
argument_list|,
name|msg
argument_list|,
name|n
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|!
name|strcmp
argument_list|(
name|keyword
argument_list|,
literal|"Y"
argument_list|)
condition|)
name|dsa
operator|->
name|pub_key
operator|=
name|hex2bn
argument_list|(
name|value
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
operator|!
name|strcmp
argument_list|(
name|keyword
argument_list|,
literal|"R"
argument_list|)
condition|)
name|sig
operator|->
name|r
operator|=
name|hex2bn
argument_list|(
name|value
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
operator|!
name|strcmp
argument_list|(
name|keyword
argument_list|,
literal|"S"
argument_list|)
condition|)
block|{
name|EVP_MD_CTX
name|mctx
decl_stmt|;
name|EVP_PKEY
name|pk
decl_stmt|;
name|unsigned
name|char
name|sigbuf
index|[
literal|60
index|]
decl_stmt|;
name|unsigned
name|int
name|slen
decl_stmt|;
name|int
name|r
decl_stmt|;
name|EVP_MD_CTX_init
argument_list|(
operator|&
name|mctx
argument_list|)
expr_stmt|;
name|pk
operator|.
name|type
operator|=
name|EVP_PKEY_DSA
expr_stmt|;
name|pk
operator|.
name|pkey
operator|.
name|dsa
operator|=
name|dsa
expr_stmt|;
name|sig
operator|->
name|s
operator|=
name|hex2bn
argument_list|(
name|value
argument_list|)
expr_stmt|;
name|pbn
argument_list|(
literal|"Y"
argument_list|,
name|dsa
operator|->
name|pub_key
argument_list|)
expr_stmt|;
name|pbn
argument_list|(
literal|"R"
argument_list|,
name|sig
operator|->
name|r
argument_list|)
expr_stmt|;
name|pbn
argument_list|(
literal|"S"
argument_list|,
name|sig
operator|->
name|s
argument_list|)
expr_stmt|;
name|slen
operator|=
name|FIPS_dsa_sig_encode
argument_list|(
name|sigbuf
argument_list|,
name|sig
argument_list|)
expr_stmt|;
name|EVP_VerifyInit_ex
argument_list|(
operator|&
name|mctx
argument_list|,
name|EVP_dss1
argument_list|()
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|EVP_VerifyUpdate
argument_list|(
operator|&
name|mctx
argument_list|,
name|msg
argument_list|,
name|n
argument_list|)
expr_stmt|;
name|r
operator|=
name|EVP_VerifyFinal
argument_list|(
operator|&
name|mctx
argument_list|,
name|sigbuf
argument_list|,
name|slen
argument_list|,
operator|&
name|pk
argument_list|)
expr_stmt|;
name|EVP_MD_CTX_cleanup
argument_list|(
operator|&
name|mctx
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Result = %c\n"
argument_list|,
name|r
operator|==
literal|1
condition|?
literal|'P'
else|:
literal|'F'
argument_list|)
expr_stmt|;
name|putc
argument_list|(
literal|'\n'
argument_list|,
name|stdout
argument_list|)
expr_stmt|;
block|}
block|}
block|}
end_function

begin_function
name|int
name|main
parameter_list|(
name|int
name|argc
parameter_list|,
name|char
modifier|*
modifier|*
name|argv
parameter_list|)
block|{
if|if
condition|(
name|argc
operator|!=
literal|2
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"%s [prime|pqg|pqgver|keypair|siggen|sigver]\n"
argument_list|,
name|argv
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|FIPS_mode_set
argument_list|(
literal|1
argument_list|)
condition|)
block|{
name|do_print_errors
argument_list|()
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|strcmp
argument_list|(
name|argv
index|[
literal|1
index|]
argument_list|,
literal|"prime"
argument_list|)
condition|)
name|primes
argument_list|()
expr_stmt|;
elseif|else
if|if
condition|(
operator|!
name|strcmp
argument_list|(
name|argv
index|[
literal|1
index|]
argument_list|,
literal|"pqg"
argument_list|)
condition|)
name|pqg
argument_list|()
expr_stmt|;
elseif|else
if|if
condition|(
operator|!
name|strcmp
argument_list|(
name|argv
index|[
literal|1
index|]
argument_list|,
literal|"pqgver"
argument_list|)
condition|)
name|pqgver
argument_list|()
expr_stmt|;
elseif|else
if|if
condition|(
operator|!
name|strcmp
argument_list|(
name|argv
index|[
literal|1
index|]
argument_list|,
literal|"keypair"
argument_list|)
condition|)
name|keypair
argument_list|()
expr_stmt|;
elseif|else
if|if
condition|(
operator|!
name|strcmp
argument_list|(
name|argv
index|[
literal|1
index|]
argument_list|,
literal|"keyver"
argument_list|)
condition|)
name|keyver
argument_list|()
expr_stmt|;
elseif|else
if|if
condition|(
operator|!
name|strcmp
argument_list|(
name|argv
index|[
literal|1
index|]
argument_list|,
literal|"siggen"
argument_list|)
condition|)
name|siggen
argument_list|()
expr_stmt|;
elseif|else
if|if
condition|(
operator|!
name|strcmp
argument_list|(
name|argv
index|[
literal|1
index|]
argument_list|,
literal|"sigver"
argument_list|)
condition|)
name|sigver
argument_list|()
expr_stmt|;
else|else
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Don't know how to %s.\n"
argument_list|,
name|argv
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

end_unit


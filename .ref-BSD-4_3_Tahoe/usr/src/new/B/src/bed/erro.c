begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/* Copyright (c) Stichting Mathematisch Centrum, Amsterdam, 1984. */
end_comment

begin_decl_stmt
specifier|static
name|char
name|rcsid
index|[]
init|=
literal|"$Header: erro.c,v 2.5 85/08/22 16:02:02 timo Exp $"
decl_stmt|;
end_decl_stmt

begin_comment
comment|/*  * B editor -- Handle error messages.  */
end_comment

begin_include
include|#
directive|include
file|"b.h"
end_include

begin_include
include|#
directive|include
file|"feat.h"
end_include

begin_include
include|#
directive|include
file|"node.h"
end_include

begin_decl_stmt
specifier|extern
name|bool
name|hushbaby
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|extern
name|bool
name|dflag
decl_stmt|;
end_decl_stmt

begin_function_decl
name|string
name|querepr
parameter_list|()
function_decl|;
end_function_decl

begin_decl_stmt
specifier|extern
name|int
name|winheight
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* From scrn.c */
end_comment

begin_decl_stmt
specifier|extern
name|int
name|winstart
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* From scrn.c */
end_comment

begin_decl_stmt
specifier|extern
name|int
name|llength
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* From scrn.c */
end_comment

begin_define
define|#
directive|define
name|SOBIT
value|0200
end_define

begin_comment
comment|/* Interface with wind.c */
end_comment

begin_define
define|#
directive|define
name|MAXMSG
value|1000
end_define

begin_decl_stmt
specifier|static
name|char
name|msgbuffer
index|[
name|MAXMSG
index|]
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|bool
name|ringbell
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|priority
decl_stmt|;
end_decl_stmt

begin_comment
comment|/*  * Status line.  A combination of scroll bar, error message etc.  * Put the message on the screen and clear the buffers for next time.  * If there is no message, show status and copy buffer and recording mode.  */
end_comment

begin_function
name|Visible
name|Procedure
name|stsline
parameter_list|(
name|totlines
parameter_list|,
name|topline
parameter_list|,
name|scrlines
parameter_list|,
name|copybuffer
parameter_list|,
name|recording
parameter_list|)
name|int
name|totlines
decl_stmt|;
name|int
name|topline
decl_stmt|;
name|int
name|scrlines
decl_stmt|;
name|value
name|copybuffer
decl_stmt|;
name|bool
name|recording
decl_stmt|;
block|{
specifier|register
name|string
name|bp
decl_stmt|;
if|if
condition|(
name|ringbell
operator|&&
operator|!
name|hushbaby
condition|)
name|trmbell
argument_list|()
expr_stmt|;
if|if
condition|(
name|msgbuffer
index|[
literal|0
index|]
condition|)
block|{
name|msgbuffer
index|[
name|llength
operator|-
literal|1
index|]
operator|=
literal|'\0'
expr_stmt|;
comment|/* Truncate */
if|if
condition|(
name|ringbell
condition|)
block|{
for|for
control|(
name|bp
operator|=
name|msgbuffer
init|;
operator|*
name|bp
condition|;
operator|++
name|bp
control|)
operator|*
name|bp
operator||=
name|SOBIT
expr_stmt|;
block|}
block|}
else|else
block|{
name|bp
operator|=
name|msgbuffer
expr_stmt|;
ifdef|#
directive|ifdef
name|SCROLLBAR
name|bp
operator|+=
name|addscrollbar
argument_list|(
name|totlines
argument_list|,
name|topline
argument_list|,
name|scrlines
argument_list|)
expr_stmt|;
endif|#
directive|endif
endif|SCROLLBAR
if|if
condition|(
name|recording
condition|)
block|{
name|strcpy
argument_list|(
name|bp
argument_list|,
literal|"[Recording] "
argument_list|)
expr_stmt|;
name|bp
operator|+=
operator|(
sizeof|sizeof
expr|"[Recording] "
operator|)
operator|-
literal|1
expr_stmt|;
block|}
if|if
condition|(
name|copybuffer
condition|)
block|{
ifdef|#
directive|ifdef
name|SHOWBUF
name|sprintf
argument_list|(
name|bp
argument_list|,
literal|"[Copy buffer: %.80s]"
argument_list|,
name|querepr
argument_list|(
name|copybuffer
argument_list|)
argument_list|)
expr_stmt|;
while|while
condition|(
operator|*
name|bp
condition|)
operator|++
name|bp
expr_stmt|;
if|if
condition|(
name|bp
operator|>=
name|msgbuffer
operator|+
literal|80
condition|)
name|strcpy
argument_list|(
name|msgbuffer
operator|+
literal|75
argument_list|,
literal|"...]"
argument_list|)
expr_stmt|;
else|#
directive|else
else|!SHOWBUF
name|strcpy
argument_list|(
name|bp
argument_list|,
literal|"[Copy buffer]"
argument_list|)
expr_stmt|;
endif|#
directive|endif
endif|!SHOWBUF
block|}
block|}
name|trmputdata
argument_list|(
name|winheight
argument_list|,
name|winheight
argument_list|,
literal|0
argument_list|,
name|msgbuffer
argument_list|)
expr_stmt|;
name|msgbuffer
index|[
literal|0
index|]
operator|=
literal|0
expr_stmt|;
name|priority
operator|=
literal|0
expr_stmt|;
name|ringbell
operator|=
name|No
expr_stmt|;
block|}
end_function

begin_ifdef
ifdef|#
directive|ifdef
name|SCROLLBAR
end_ifdef

begin_comment
comment|/*  * Paint a beautiful scroll bar so the user can see about what part of the  * unit is visible on the screen (considering logical lines).  */
end_comment

begin_function
name|Hidden
name|int
name|addscrollbar
parameter_list|(
name|totlines
parameter_list|,
name|topline
parameter_list|,
name|scrlines
parameter_list|)
name|int
name|totlines
decl_stmt|;
name|int
name|topline
decl_stmt|;
name|int
name|scrlines
decl_stmt|;
block|{
name|int
name|endline
decl_stmt|;
specifier|register
name|int
name|i
decl_stmt|;
if|if
condition|(
name|winstart
operator|>
literal|0
operator|||
name|scrlines
operator|>
name|totlines
condition|)
return|return
literal|0
return|;
comment|/* Nothing outside screen */
if|if
condition|(
name|totlines
operator|<=
literal|0
condition|)
name|totlines
operator|=
literal|1
expr_stmt|;
comment|/* Don't want to divide by 0 */
name|topline
operator|=
name|topline
operator|*
name|winheight
operator|/
name|totlines
expr_stmt|;
name|endline
operator|=
name|topline
operator|+
operator|(
name|scrlines
operator|*
name|winheight
operator|+
name|totlines
operator|-
literal|1
operator|)
operator|/
name|totlines
expr_stmt|;
if|if
condition|(
name|endline
operator|>
name|winheight
condition|)
name|endline
operator|=
name|winheight
expr_stmt|;
if|if
condition|(
name|topline
operator|>=
name|endline
condition|)
name|topline
operator|=
name|endline
operator|-
literal|1
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|topline
condition|;
operator|++
name|i
control|)
name|msgbuffer
index|[
name|i
index|]
operator|=
literal|'-'
expr_stmt|;
for|for
control|(
init|;
name|i
operator|<
name|endline
condition|;
operator|++
name|i
control|)
name|msgbuffer
index|[
name|i
index|]
operator|=
literal|'#'
expr_stmt|;
for|for
control|(
init|;
name|i
operator|<
name|winheight
condition|;
operator|++
name|i
control|)
name|msgbuffer
index|[
name|i
index|]
operator|=
literal|'-'
expr_stmt|;
name|msgbuffer
index|[
name|i
operator|++
index|]
operator|=
literal|' '
expr_stmt|;
name|msgbuffer
index|[
name|i
index|]
operator|=
literal|'\0'
expr_stmt|;
return|return
name|i
return|;
block|}
end_function

begin_endif
endif|#
directive|endif
endif|SCROLLBAR
end_endif

begin_comment
comment|/*  * Issue an error message.  These have highest priority.  * Once an error message is in the buffer, further error messages are ignored  * until it has been displayed.  */
end_comment

begin_comment
comment|/* VARARGS 1 */
end_comment

begin_function
name|Visible
name|Procedure
name|error
parameter_list|(
name|fmt
parameter_list|,
name|a1
parameter_list|,
name|a2
parameter_list|,
name|a3
parameter_list|,
name|a4
parameter_list|,
name|a5
parameter_list|,
name|a6
parameter_list|,
name|a7
parameter_list|,
name|a8
parameter_list|,
name|a9
parameter_list|,
name|a10
parameter_list|)
name|string
name|fmt
decl_stmt|;
block|{
name|ringbell
operator|=
name|Yes
expr_stmt|;
if|if
condition|(
name|fmt
operator|&&
name|priority
operator|<
literal|3
condition|)
block|{
name|priority
operator|=
literal|3
expr_stmt|;
name|sprintf
argument_list|(
name|msgbuffer
argument_list|,
name|fmt
argument_list|,
name|a1
argument_list|,
name|a2
argument_list|,
name|a3
argument_list|,
name|a4
argument_list|,
name|a5
argument_list|,
name|a6
argument_list|,
name|a7
argument_list|,
name|a8
argument_list|,
name|a9
argument_list|,
name|a10
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/*  * Issue an informative message.  These have medium priority.  * Unlike error messages, the last such message is displayed.  */
end_comment

begin_comment
comment|/* VARARGS 1 */
end_comment

begin_function
name|Visible
name|Procedure
name|message
parameter_list|(
name|fmt
parameter_list|,
name|a1
parameter_list|,
name|a2
parameter_list|,
name|a3
parameter_list|,
name|a4
parameter_list|,
name|a5
parameter_list|,
name|a6
parameter_list|,
name|a7
parameter_list|,
name|a8
parameter_list|,
name|a9
parameter_list|,
name|a10
parameter_list|)
specifier|register
name|string
name|fmt
decl_stmt|;
block|{
if|if
condition|(
name|fmt
operator|&&
name|priority
operator|<=
literal|2
condition|)
block|{
name|priority
operator|=
literal|2
expr_stmt|;
name|sprintf
argument_list|(
name|msgbuffer
argument_list|,
name|fmt
argument_list|,
name|a1
argument_list|,
name|a2
argument_list|,
name|a3
argument_list|,
name|a4
argument_list|,
name|a5
argument_list|,
name|a6
argument_list|,
name|a7
argument_list|,
name|a8
argument_list|,
name|a9
argument_list|,
name|a10
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/*  * Issue a debugging message.  These  have lowest priority and  * are not shown to ordinary users.  */
end_comment

begin_comment
comment|/* VARARGS1 */
end_comment

begin_function
name|Visible
name|Procedure
name|debug
parameter_list|(
name|fmt
parameter_list|,
name|a1
parameter_list|,
name|a2
parameter_list|,
name|a3
parameter_list|,
name|a4
parameter_list|,
name|a5
parameter_list|,
name|a6
parameter_list|,
name|a7
parameter_list|,
name|a8
parameter_list|,
name|a9
parameter_list|,
name|a10
parameter_list|)
name|string
name|fmt
decl_stmt|;
block|{
ifndef|#
directive|ifndef
name|NDEBUG
if|if
condition|(
name|fmt
operator|&&
name|priority
operator|<=
literal|1
condition|)
block|{
name|priority
operator|=
literal|1
expr_stmt|;
name|sprintf
argument_list|(
name|msgbuffer
argument_list|,
name|fmt
argument_list|,
name|a1
argument_list|,
name|a2
argument_list|,
name|a3
argument_list|,
name|a4
argument_list|,
name|a5
argument_list|,
name|a6
argument_list|,
name|a7
argument_list|,
name|a8
argument_list|,
name|a9
argument_list|,
name|a10
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
endif|NDEBUG
block|}
end_function

begin_comment
comment|/*  * Dump any error message still remaining to stderr.  */
end_comment

begin_function
name|Visible
name|Procedure
name|enderro
parameter_list|()
block|{
if|if
condition|(
name|msgbuffer
index|[
literal|0
index|]
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"%s\n"
argument_list|,
name|msgbuffer
argument_list|)
expr_stmt|;
block|}
name|msgbuffer
index|[
literal|0
index|]
operator|=
literal|0
expr_stmt|;
name|priority
operator|=
literal|0
expr_stmt|;
name|ringbell
operator|=
name|No
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * This #define causes "erro.h" to compile a table of error messages.  */
end_comment

begin_define
define|#
directive|define
name|_ERROR
parameter_list|(
name|name
parameter_list|,
name|message
parameter_list|)
value|char name[] = message
end_define

begin_include
include|#
directive|include
file|"erro.h"
end_include

end_unit


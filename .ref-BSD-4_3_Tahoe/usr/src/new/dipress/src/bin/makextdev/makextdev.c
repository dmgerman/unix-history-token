begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  *  makextdev - make an extended character code table for the ditroff  *		interpress converter.  *  * Copyright (c) 1984, 1985, 1986 Xerox Corp.  *  *  History:  *	24-oct-85  ed flint	close fontfiles, ran out of open file  *				descriptors with large number of fonts  *  *  Some of the characters in the interpress fonts have character codes  *  greater than 255.  Since the ditroff character code table is an array of  *  char, the codes are too large.  This attempts to remedy that situation.  *  If the character code specified in the normal code table is 0377 (decimal  *  255), then the real code can be found in the extended table (which is an  *  array of short).  This program reads the same files that makedev reads and  *  build the extended code table.  *  *  To specify an extended code in a font table, use a line of the following  *  form:  *  *	    c       www     kk      0377    xxxxx  *  *  where:  c is the one or two letter character code,  *	    www is the character's width,  *	    kk is the kerning information, and  *	    xxxxx is the actual interpress code for the character.  *  *  Basically, this is just like any other line in the font table file, except  *  that the standard code is set to 0377 and the actual code is placed on the  *  line as the fifth item.  Note that a file with lines like this can still  *  be run thru makedev successfully -- makedev will just ignore the fifth  *  item on the line.  *  *  One can make the extended tables for all the loaded fonts by saying  *  "makextdev DESC" (just as with makedev), but makedev must be run before  *  doing this, since it will require looking at DESC.out.  */
end_comment

begin_include
include|#
directive|include
file|"deviceinfo.h"
end_include

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_include
include|#
directive|include
file|<sys/types.h>
end_include

begin_include
include|#
directive|include
file|<strings.h>
end_include

begin_define
define|#
directive|define
name|Line_length
value|256
end_define

begin_define
define|#
directive|define
name|Max_chars
value|256
end_define

begin_comment
comment|/* maximum # of funny chars */
end_comment

begin_comment
comment|/* Tab_size includes all ascii characters except control characters */
end_comment

begin_define
define|#
directive|define
name|Table_size
value|(Max_chars + 128 - 32)
end_define

begin_define
define|#
directive|define
name|white
parameter_list|(
name|ch
parameter_list|)
value|((ch) == ' ' || (ch) == '\t' || (ch) == '\n')
end_define

begin_comment
comment|/* values returned by strcmp */
end_comment

begin_define
define|#
directive|define
name|Equal
value|0
end_define

begin_decl_stmt
name|char
name|char_name
index|[
literal|5
operator|*
name|Max_chars
index|]
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|short
name|char_index_table
index|[
name|Max_chars
index|]
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|unsigned
name|char
name|font_index_table
index|[
name|Table_size
index|]
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|unsigned
name|short
name|extend_table
index|[
name|Table_size
index|]
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|struct
name|device_entry
name|device_entry
decl_stmt|;
end_decl_stmt

begin_function
name|main
parameter_list|(
name|argc
parameter_list|,
name|argv
parameter_list|)
name|int
name|argc
decl_stmt|;
name|char
modifier|*
name|argv
index|[]
decl_stmt|;
block|{
name|int
name|fntcnt
decl_stmt|;
name|int
name|descfd
decl_stmt|;
specifier|register
name|char
modifier|*
name|ptr
decl_stmt|;
name|char
name|line
index|[
name|Line_length
index|]
decl_stmt|;
name|char
name|keyword
index|[
literal|80
index|]
decl_stmt|;
name|char
modifier|*
name|fname
decl_stmt|;
name|FILE
modifier|*
name|descfile
decl_stmt|;
if|if
condition|(
name|argc
operator|<
literal|2
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"usage: makextdev font\n"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
comment|/* First off, get the DESC.out file -- we need the information */
if|if
condition|(
operator|(
name|descfd
operator|=
name|open
argument_list|(
literal|"DESC.out"
argument_list|,
literal|0
argument_list|)
operator|)
operator|==
operator|-
literal|1
condition|)
block|{
name|perror
argument_list|(
literal|"DESC.out"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"makextdev: please run \"makedev DESC\" first!\n"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
comment|/* read struct device_entry off the front */
operator|(
name|void
operator|)
name|read
argument_list|(
name|descfd
argument_list|,
operator|(
name|char
operator|*
operator|)
operator|&
name|device_entry
argument_list|,
sizeof|sizeof
argument_list|(
name|device_entry
argument_list|)
argument_list|)
expr_stmt|;
comment|/* skip over the point size table */
operator|(
name|void
operator|)
name|lseek
argument_list|(
name|descfd
argument_list|,
operator|(
name|device_entry
operator|.
name|num_sizes
operator|+
literal|1
operator|)
operator|*
sizeof|sizeof
argument_list|(
name|short
argument_list|)
argument_list|,
literal|1
argument_list|)
expr_stmt|;
comment|/* read char_index_table and char_name arrays */
operator|(
name|void
operator|)
name|read
argument_list|(
name|descfd
argument_list|,
operator|(
name|char
operator|*
operator|)
name|char_index_table
argument_list|,
name|device_entry
operator|.
name|spec_char_num
operator|*
sizeof|sizeof
argument_list|(
name|short
argument_list|)
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|read
argument_list|(
name|descfd
argument_list|,
name|char_name
argument_list|,
name|device_entry
operator|.
name|spec_name_len
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|DEBUG
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|device_entry
operator|.
name|spec_char_num
condition|;
name|i
operator|++
control|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"%d  "
argument_list|,
name|char_index_table
index|[
name|i
index|]
argument_list|)
expr_stmt|;
block|}
name|fputc
argument_list|(
literal|'\n'
argument_list|,
name|stderr
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|device_entry
operator|.
name|spec_char_num
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|char_name
index|[
name|i
index|]
operator|==
literal|'\0'
condition|)
block|{
name|fputc
argument_list|(
literal|' '
argument_list|,
name|stderr
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|fputc
argument_list|(
name|char_name
index|[
name|i
index|]
argument_list|,
name|stderr
argument_list|)
expr_stmt|;
block|}
block|}
name|fputc
argument_list|(
literal|'\n'
argument_list|,
name|stderr
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* step thru the arguments */
while|while
condition|(
operator|--
name|argc
operator|>
literal|0
condition|)
block|{
name|fname
operator|=
operator|*
operator|++
name|argv
expr_stmt|;
if|if
condition|(
name|strcmp
argument_list|(
name|fname
argument_list|,
literal|"DESC"
argument_list|)
operator|==
name|Equal
condition|)
block|{
comment|/* do all the preloaded fonts */
if|if
condition|(
operator|(
name|descfile
operator|=
name|fopen
argument_list|(
name|fname
argument_list|,
literal|"r"
argument_list|)
operator|)
operator|==
name|NULL
condition|)
block|{
name|perror
argument_list|(
name|fname
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
comment|/* scan thru DESC looking for the "fonts" keyword */
do|do
block|{
if|if
condition|(
name|fgets
argument_list|(
name|line
argument_list|,
name|Line_length
argument_list|,
name|descfile
argument_list|)
operator|==
name|NULL
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"makextdev: no fonts listed in DESC\n"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
operator|(
name|void
operator|)
name|sscanf
argument_list|(
name|line
argument_list|,
literal|"%s"
argument_list|,
name|keyword
argument_list|)
expr_stmt|;
block|}
do|while
condition|(
name|strcmp
argument_list|(
name|keyword
argument_list|,
literal|"fonts"
argument_list|)
operator|!=
name|Equal
condition|)
do|;
comment|/* found the line -- do each font listed on the line */
comment|/* line looks like this:  fonts n X X X X ... 	 */
comment|/* where n is number of fonts and X is a font name   */
operator|(
name|void
operator|)
name|fclose
argument_list|(
name|descfile
argument_list|)
expr_stmt|;
name|ptr
operator|=
name|line
operator|+
literal|5
expr_stmt|;
comment|/* 5 == strlen("fonts") */
while|while
condition|(
name|white
argument_list|(
operator|*
name|ptr
argument_list|)
condition|)
block|{
name|ptr
operator|++
expr_stmt|;
comment|/* never trust a macro */
block|}
comment|/* get font count */
name|fntcnt
operator|=
name|atoi
argument_list|(
name|ptr
argument_list|)
expr_stmt|;
while|while
condition|(
operator|!
name|white
argument_list|(
operator|*
name|ptr
argument_list|)
condition|)
block|{
name|ptr
operator|++
expr_stmt|;
block|}
while|while
condition|(
name|white
argument_list|(
operator|*
name|ptr
argument_list|)
condition|)
block|{
name|ptr
operator|++
expr_stmt|;
block|}
comment|/* process each font on the line */
while|while
condition|(
name|fntcnt
operator|--
operator|>
literal|0
condition|)
block|{
specifier|register
name|char
modifier|*
name|fontname
decl_stmt|;
name|fontname
operator|=
name|ptr
expr_stmt|;
while|while
condition|(
operator|!
name|white
argument_list|(
operator|*
name|ptr
argument_list|)
condition|)
block|{
name|ptr
operator|++
expr_stmt|;
block|}
operator|*
name|ptr
operator|++
operator|=
literal|'\0'
expr_stmt|;
name|dofont
argument_list|(
name|fontname
argument_list|)
expr_stmt|;
while|while
condition|(
name|white
argument_list|(
operator|*
name|ptr
argument_list|)
condition|)
block|{
name|ptr
operator|++
expr_stmt|;
block|}
block|}
block|}
else|else
block|{
name|dofont
argument_list|(
name|fname
argument_list|)
expr_stmt|;
block|}
block|}
block|}
end_function

begin_macro
name|dofont
argument_list|(
argument|fontname
argument_list|)
end_macro

begin_decl_stmt
name|char
modifier|*
name|fontname
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|int
name|outfile
decl_stmt|;
name|int
name|i
decl_stmt|;
name|int
name|ccode
decl_stmt|;
name|unsigned
name|int
name|xcode
decl_stmt|;
name|char
name|outname
index|[
literal|20
index|]
decl_stmt|;
name|char
name|ch
index|[
literal|10
index|]
decl_stmt|;
name|char
name|swid
index|[
literal|10
index|]
decl_stmt|;
name|char
name|skern
index|[
literal|10
index|]
decl_stmt|;
name|char
name|scode
index|[
literal|10
index|]
decl_stmt|;
name|char
name|sauxcode
index|[
literal|10
index|]
decl_stmt|;
name|char
name|line
index|[
name|Line_length
index|]
decl_stmt|;
name|char
name|keyword
index|[
literal|20
index|]
decl_stmt|;
name|FILE
modifier|*
name|fontfile
decl_stmt|;
name|struct
name|font_entry
name|font_entry
decl_stmt|;
comment|/* open the file that describes the font */
if|if
condition|(
operator|(
name|fontfile
operator|=
name|fopen
argument_list|(
name|fontname
argument_list|,
literal|"r"
argument_list|)
operator|)
operator|==
name|NULL
condition|)
block|{
name|perror
argument_list|(
name|fontname
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
comment|/* find the keyword "charset" */
do|do
block|{
if|if
condition|(
name|fgets
argument_list|(
name|line
argument_list|,
name|Line_length
argument_list|,
name|fontfile
argument_list|)
operator|==
name|NULL
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"makextdev: font %s has no charset\n"
argument_list|,
name|fontname
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
operator|(
name|void
operator|)
name|sscanf
argument_list|(
name|line
argument_list|,
literal|"%s"
argument_list|,
name|keyword
argument_list|)
expr_stmt|;
block|}
do|while
condition|(
name|strcmp
argument_list|(
name|keyword
argument_list|,
literal|"charset"
argument_list|)
operator|!=
name|Equal
condition|)
do|;
comment|/* get font info from *.out file */
comment|/* first, open it		     */
operator|(
name|void
operator|)
name|strcpy
argument_list|(
name|outname
argument_list|,
name|fontname
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|strcat
argument_list|(
name|outname
argument_list|,
literal|".out"
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|outfile
operator|=
name|open
argument_list|(
name|outname
argument_list|,
literal|0
argument_list|)
operator|)
operator|==
operator|-
literal|1
condition|)
block|{
name|perror
argument_list|(
name|outname
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"makextdev: please run \"makedev %s\" first!\n"
argument_list|,
name|fontname
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
comment|/* zero extend_table */
name|bzero
argument_list|(
name|extend_table
argument_list|,
sizeof|sizeof
argument_list|(
name|extend_table
argument_list|)
argument_list|)
expr_stmt|;
comment|/* now read the header and font_index_table */
operator|(
name|void
operator|)
name|read
argument_list|(
name|outfile
argument_list|,
operator|(
name|char
operator|*
operator|)
operator|&
name|font_entry
argument_list|,
sizeof|sizeof
argument_list|(
name|font_entry
argument_list|)
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|lseek
argument_list|(
name|outfile
argument_list|,
call|(
name|off_t
call|)
argument_list|(
call|(
name|unsigned
name|char
call|)
argument_list|(
name|font_entry
operator|.
name|num_char_wid
argument_list|)
operator|*
literal|3
argument_list|)
argument_list|,
literal|1
argument_list|)
expr_stmt|;
comment|/* skip width, kern, and code */
operator|(
name|void
operator|)
name|read
argument_list|(
name|outfile
argument_list|,
operator|(
name|char
operator|*
operator|)
name|font_index_table
argument_list|,
name|device_entry
operator|.
name|spec_char_num
operator|+
literal|128
operator|-
literal|32
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|close
argument_list|(
name|outfile
argument_list|)
expr_stmt|;
comment|/* unscramble each line */
while|while
condition|(
name|fgets
argument_list|(
name|line
argument_list|,
name|Line_length
argument_list|,
name|fontfile
argument_list|)
operator|!=
name|NULL
condition|)
block|{
name|i
operator|=
name|sscanf
argument_list|(
name|line
argument_list|,
literal|"%s %s %s %s %s"
argument_list|,
name|ch
argument_list|,
name|swid
argument_list|,
name|skern
argument_list|,
name|scode
argument_list|,
name|sauxcode
argument_list|)
expr_stmt|;
if|if
condition|(
name|swid
index|[
literal|0
index|]
operator|!=
literal|'"'
condition|)
block|{
comment|/* translate scode and auxcode into actual numerical values */
name|ccode
operator|=
name|convcode
argument_list|(
name|scode
argument_list|)
expr_stmt|;
name|xcode
operator|=
name|convcode
argument_list|(
name|sauxcode
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|/* it's a repeat of the last character */
name|i
operator|=
literal|5
expr_stmt|;
block|}
comment|/* check for extended code */
if|if
condition|(
name|ccode
operator|==
literal|0377
condition|)
block|{
if|if
condition|(
name|i
operator|<
literal|5
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"%s: character %s has no extended code\n"
argument_list|,
name|fontname
argument_list|,
name|ch
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|/* find the findex and store the extended code in extend_table */
if|if
condition|(
name|strlen
argument_list|(
name|ch
argument_list|)
operator|==
literal|1
condition|)
block|{
comment|/*		    fprintf(stderr, "font_index_table[%d] = %d\n",  			ch[0] - 32, font_index_table[ch[0] - 32]); */
name|extend_table
index|[
name|font_index_table
index|[
name|ch
index|[
literal|0
index|]
operator|-
literal|32
index|]
index|]
operator|=
name|xcode
expr_stmt|;
block|}
else|else
block|{
comment|/* it's a funny name */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|device_entry
operator|.
name|spec_char_num
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|strcmp
argument_list|(
operator|&
name|char_name
index|[
name|char_index_table
index|[
name|i
index|]
index|]
argument_list|,
name|ch
argument_list|)
operator|==
name|Equal
condition|)
block|{
comment|/*			    fprintf(stderr, "i = %d, font_index_table[%d] = %d\n", 				i, i+128-32, font_index_table[i+128-32]); */
name|extend_table
index|[
name|font_index_table
index|[
name|i
operator|+
literal|128
operator|-
literal|32
index|]
index|]
operator|=
name|xcode
expr_stmt|;
break|break;
block|}
block|}
block|}
block|}
block|}
block|}
comment|/* Now, write extend_table in an appropriate file */
comment|/* remember: outname currently looks like "XX.out" */
operator|(
name|void
operator|)
name|strcat
argument_list|(
name|outname
argument_list|,
literal|".ext"
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|outfile
operator|=
name|creat
argument_list|(
name|outname
argument_list|,
literal|0666
argument_list|)
operator|)
operator|==
operator|-
literal|1
condition|)
block|{
name|perror
argument_list|(
name|outname
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
operator|(
name|void
operator|)
name|write
argument_list|(
name|outfile
argument_list|,
operator|(
name|char
operator|*
operator|)
name|extend_table
argument_list|,
operator|(
name|device_entry
operator|.
name|spec_char_num
operator|+
literal|128
operator|-
literal|32
operator|)
operator|*
sizeof|sizeof
argument_list|(
name|short
argument_list|)
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|close
argument_list|(
name|outfile
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|fclose
argument_list|(
name|fontfile
argument_list|)
expr_stmt|;
block|}
end_block

begin_macro
name|convcode
argument_list|(
argument|str
argument_list|)
end_macro

begin_decl_stmt
name|char
modifier|*
name|str
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|int
name|val
decl_stmt|;
if|if
condition|(
name|str
index|[
literal|0
index|]
operator|==
literal|'0'
condition|)
block|{
operator|(
name|void
operator|)
name|sscanf
argument_list|(
name|str
argument_list|,
literal|"%o"
argument_list|,
operator|&
name|val
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|val
operator|=
name|atoi
argument_list|(
name|str
argument_list|)
expr_stmt|;
block|}
return|return
operator|(
name|val
operator|)
return|;
block|}
end_block

end_unit


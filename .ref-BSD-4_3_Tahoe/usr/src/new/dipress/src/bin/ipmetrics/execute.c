begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/* execute.c  *  * Copyright (c) 1984, 1985 Xerox Corp.  *  *  Define the functions used in parse.c.  *  * Execute the RES file and leave the correct parameters on the stack.  *  * HISTORY  *  * K. Knox,  1-Apr-85 23:45:46, Created first version.  * K. Knox, 13-May-85 10:25:25, Fixed bugs in calls to maketransformation.  * K. Knox, 13-May-85 10:25:25, Fixed bug in angle calculation in op_rotate.  *  */
end_comment

begin_include
include|#
directive|include
file|<math.h>
end_include

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_include
include|#
directive|include
file|<iptokens.h>
end_include

begin_include
include|#
directive|include
file|"stack.h"
end_include

begin_define
define|#
directive|define
name|RES_header
value|"Interpress/Xerox/2.1/RasterEncoding/1.0 "
end_define

begin_define
define|#
directive|define
name|len_RES_header
value|40
end_define

begin_define
define|#
directive|define
name|err0
value|"(%d) execute: Bad IP header, got %s\n"
end_define

begin_define
define|#
directive|define
name|err1
value|"(%d) execute: roll moveFirst> depth, %d> %d!\n"
end_define

begin_define
define|#
directive|define
name|err2
value|"(%d) execute: unknown operator subtype, got %d!\n"
end_define

begin_define
define|#
directive|define
name|err3
value|"(%d) execute: unknown operator, type=%d!\n"
end_define

begin_define
define|#
directive|define
name|err4
value|"(%d) execute: unknown sequence, type=%d, length=%d!\n"
end_define

begin_define
define|#
directive|define
name|err5
value|"(%d) execute: sequenceInsertFile not implemented!\n"
end_define

begin_comment
comment|/* Defined elsewhere. */
end_comment

begin_function_decl
specifier|extern
name|unsigned
name|char
modifier|*
modifier|*
name|malloc
parameter_list|()
function_decl|;
end_function_decl

begin_decl_stmt
specifier|extern
name|long
name|filepos
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|extern
name|FILE
modifier|*
name|fp
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* Defined in this module. */
end_comment

begin_function_decl
specifier|extern
name|unsigned
name|char
modifier|*
name|popidentifier
parameter_list|()
function_decl|;
end_function_decl

begin_function_decl
specifier|extern
name|double
name|popdouble
parameter_list|()
function_decl|;
end_function_decl

begin_comment
comment|/*  * Public procedures defined for "parse" module.  *  */
end_comment

begin_macro
name|header
argument_list|(
argument|string
argument_list|)
end_macro

begin_block
block|{
if|if
condition|(
name|strncmp
argument_list|(
name|string
argument_list|,
name|RES_header
argument_list|,
literal|10
argument_list|)
operator|!=
literal|0
condition|)
name|error
argument_list|(
name|err0
argument_list|,
name|filepos
argument_list|,
name|string
argument_list|)
expr_stmt|;
block|}
end_block

begin_macro
name|op_makevec
argument_list|()
end_macro

begin_block
block|{
name|int
name|n
decl_stmt|,
name|depth
decl_stmt|;
name|unsigned
name|char
modifier|*
name|ptr
decl_stmt|,
modifier|*
modifier|*
name|array
decl_stmt|;
name|depth
operator|=
name|popint
argument_list|()
expr_stmt|;
name|array
operator|=
name|malloc
argument_list|(
operator|(
name|depth
operator|+
literal|1
operator|)
operator|*
expr|sizeof
operator|(
name|unsigned
name|char
operator|*
operator|)
argument_list|)
expr_stmt|;
comment|/* null terminated array */
for|for
control|(
name|n
operator|=
literal|0
init|;
name|n
operator|<
name|depth
condition|;
name|n
operator|++
control|)
name|array
index|[
name|depth
operator|-
name|n
operator|-
literal|1
index|]
operator|=
name|pop
argument_list|(
literal|0
argument_list|)
expr_stmt|;
name|array
index|[
name|depth
index|]
operator|=
operator|(
name|unsigned
name|char
operator|*
operator|)
literal|0
expr_stmt|;
name|ptr
operator|=
name|makevector
argument_list|(
name|array
argument_list|,
name|type_vector
argument_list|,
name|subtype_general
argument_list|)
expr_stmt|;
for|for
control|(
name|n
operator|=
literal|0
init|;
name|n
operator|<
name|depth
condition|;
name|n
operator|++
control|)
name|free
argument_list|(
name|array
index|[
name|n
index|]
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|array
argument_list|)
expr_stmt|;
name|push
argument_list|(
name|ptr
argument_list|)
expr_stmt|;
block|}
end_block

begin_macro
name|op_makeveclu
argument_list|()
end_macro

begin_block
block|{
name|int
name|n
decl_stmt|,
name|depth
decl_stmt|,
name|upper
decl_stmt|,
name|lower
decl_stmt|;
name|unsigned
name|char
modifier|*
name|ptr
decl_stmt|,
modifier|*
modifier|*
name|array
decl_stmt|;
name|upper
operator|=
name|popint
argument_list|()
expr_stmt|;
name|lower
operator|=
name|popint
argument_list|()
expr_stmt|;
name|depth
operator|=
name|upper
operator|-
name|lower
operator|+
literal|1
expr_stmt|;
name|array
operator|=
name|malloc
argument_list|(
operator|(
name|depth
operator|+
literal|1
operator|)
operator|*
expr|sizeof
operator|(
name|unsigned
name|char
operator|*
operator|)
argument_list|)
expr_stmt|;
comment|/* null terminated array */
for|for
control|(
name|n
operator|=
literal|0
init|;
name|n
operator|<
name|depth
condition|;
name|n
operator|++
control|)
name|array
index|[
name|depth
operator|-
name|n
operator|-
literal|1
index|]
operator|=
name|pop
argument_list|(
literal|0
argument_list|)
expr_stmt|;
name|array
index|[
name|depth
index|]
operator|=
operator|(
name|unsigned
name|char
operator|*
operator|)
literal|0
expr_stmt|;
name|ptr
operator|=
name|makevector
argument_list|(
name|array
argument_list|,
name|type_vector
argument_list|,
name|subtype_general
argument_list|)
expr_stmt|;
comment|/* set uppper and lower bounds */
for|for
control|(
name|n
operator|=
literal|0
init|;
name|n
operator|<
name|depth
condition|;
name|n
operator|++
control|)
name|free
argument_list|(
name|array
index|[
name|n
index|]
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|array
argument_list|)
expr_stmt|;
name|push
argument_list|(
name|ptr
argument_list|)
expr_stmt|;
block|}
end_block

begin_macro
name|op_rotate
argument_list|()
end_macro

begin_block
block|{
name|double
name|angle
decl_stmt|,
name|cosA
decl_stmt|,
name|sinA
decl_stmt|,
name|pi
decl_stmt|;
name|unsigned
name|char
modifier|*
name|ptr
decl_stmt|;
name|angle
operator|=
name|popdouble
argument_list|()
expr_stmt|;
name|angle
operator|=
literal|3.1415926
operator|*
name|angle
operator|/
literal|180.
expr_stmt|;
name|cosA
operator|=
name|cos
argument_list|(
name|angle
argument_list|)
expr_stmt|;
name|sinA
operator|=
name|sin
argument_list|(
name|angle
argument_list|)
expr_stmt|;
name|ptr
operator|=
name|maketransformation
argument_list|(
name|cosA
argument_list|,
operator|-
name|sinA
argument_list|,
literal|0.0
argument_list|,
name|sinA
argument_list|,
name|cosA
argument_list|,
literal|0.0
argument_list|)
expr_stmt|;
name|push
argument_list|(
name|ptr
argument_list|)
expr_stmt|;
block|}
end_block

begin_macro
name|op_scale
argument_list|()
end_macro

begin_block
block|{
name|unsigned
name|char
modifier|*
name|ptr
decl_stmt|;
name|double
name|s
decl_stmt|;
name|s
operator|=
name|popdouble
argument_list|()
expr_stmt|;
name|ptr
operator|=
name|maketransformation
argument_list|(
name|s
argument_list|,
literal|0.0
argument_list|,
literal|0.0
argument_list|,
literal|0.0
argument_list|,
name|s
argument_list|,
literal|0.0
argument_list|)
expr_stmt|;
name|push
argument_list|(
name|ptr
argument_list|)
expr_stmt|;
block|}
end_block

begin_macro
name|op_scale2
argument_list|()
end_macro

begin_block
block|{
name|unsigned
name|char
modifier|*
name|ptr
decl_stmt|;
name|double
name|sx
decl_stmt|,
name|sy
decl_stmt|;
name|sy
operator|=
name|popdouble
argument_list|()
expr_stmt|;
name|sx
operator|=
name|popdouble
argument_list|()
expr_stmt|;
name|ptr
operator|=
name|maketransformation
argument_list|(
name|sx
argument_list|,
literal|0.0
argument_list|,
literal|0.0
argument_list|,
literal|0.0
argument_list|,
name|sy
argument_list|,
literal|0.0
argument_list|)
expr_stmt|;
name|push
argument_list|(
name|ptr
argument_list|)
expr_stmt|;
block|}
end_block

begin_macro
name|op_concat
argument_list|()
end_macro

begin_block
block|{
name|double
name|a
decl_stmt|,
name|b
decl_stmt|,
name|c
decl_stmt|,
name|d
decl_stmt|,
name|e
decl_stmt|,
name|f
decl_stmt|;
name|unsigned
name|char
modifier|*
name|ptr
decl_stmt|,
modifier|*
name|nptr
decl_stmt|,
modifier|*
name|mptr
decl_stmt|;
name|double
modifier|*
name|m
decl_stmt|,
modifier|*
name|n
decl_stmt|;
name|nptr
operator|=
name|pop
argument_list|(
name|type_transformation
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|mptr
operator|=
name|pop
argument_list|(
name|type_transformation
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|n
operator|=
name|gettransformation
argument_list|(
name|nptr
argument_list|)
expr_stmt|;
name|m
operator|=
name|gettransformation
argument_list|(
name|mptr
argument_list|)
expr_stmt|;
name|a
operator|=
name|m
index|[
literal|0
index|]
operator|*
name|n
index|[
literal|0
index|]
operator|+
name|m
index|[
literal|3
index|]
operator|*
name|n
index|[
literal|1
index|]
expr_stmt|;
name|b
operator|=
name|m
index|[
literal|1
index|]
operator|*
name|n
index|[
literal|0
index|]
operator|+
name|m
index|[
literal|4
index|]
operator|*
name|n
index|[
literal|1
index|]
expr_stmt|;
name|c
operator|=
name|m
index|[
literal|2
index|]
operator|*
name|n
index|[
literal|0
index|]
operator|+
name|m
index|[
literal|5
index|]
operator|*
name|n
index|[
literal|1
index|]
operator|+
name|n
index|[
literal|2
index|]
expr_stmt|;
name|d
operator|=
name|m
index|[
literal|0
index|]
operator|*
name|n
index|[
literal|3
index|]
operator|+
name|m
index|[
literal|3
index|]
operator|*
name|n
index|[
literal|4
index|]
expr_stmt|;
name|e
operator|=
name|m
index|[
literal|1
index|]
operator|*
name|n
index|[
literal|3
index|]
operator|+
name|m
index|[
literal|4
index|]
operator|*
name|n
index|[
literal|4
index|]
expr_stmt|;
name|f
operator|=
name|m
index|[
literal|2
index|]
operator|*
name|n
index|[
literal|3
index|]
operator|+
name|m
index|[
literal|5
index|]
operator|*
name|n
index|[
literal|4
index|]
operator|+
name|n
index|[
literal|5
index|]
expr_stmt|;
name|ptr
operator|=
name|maketransformation
argument_list|(
name|a
argument_list|,
name|b
argument_list|,
name|c
argument_list|,
name|d
argument_list|,
name|e
argument_list|,
name|f
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|mptr
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|nptr
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|m
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|n
argument_list|)
expr_stmt|;
name|push
argument_list|(
name|ptr
argument_list|)
expr_stmt|;
block|}
end_block

begin_macro
name|op_beginblock
argument_list|()
end_macro

begin_block
block|{   }
end_block

begin_macro
name|op_endblock
argument_list|()
end_macro

begin_block
block|{   }
end_block

begin_macro
name|op_beginbody
argument_list|()
end_macro

begin_block
block|{   }
end_block

begin_macro
name|op_endbody
argument_list|()
end_macro

begin_block
block|{   }
end_block

begin_macro
name|op_unknown
argument_list|(
argument|op
argument_list|)
end_macro

begin_decl_stmt
name|int
name|op
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|error
argument_list|(
name|err3
argument_list|,
name|filepos
argument_list|,
name|op
argument_list|)
expr_stmt|;
block|}
end_block

begin_macro
name|seq_comment
argument_list|(
argument|nbytes
argument_list|)
end_macro

begin_decl_stmt
name|int
name|nbytes
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|fseek
argument_list|(
name|fp
argument_list|,
operator|(
name|long
operator|)
name|nbytes
argument_list|,
literal|1
argument_list|)
expr_stmt|;
block|}
end_block

begin_macro
name|seq_largevector
argument_list|(
argument|nbytes
argument_list|)
end_macro

begin_decl_stmt
name|int
name|nbytes
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|int
name|b
decl_stmt|;
name|long
name|bytepos
decl_stmt|,
name|bytelength
decl_stmt|;
name|unsigned
name|char
modifier|*
name|ptr
decl_stmt|,
modifier|*
modifier|*
name|array
decl_stmt|;
name|b
operator|=
name|getc
argument_list|(
name|fp
argument_list|)
operator|&
literal|0377
expr_stmt|;
comment|/* read the number of bytes/integer. */
name|bytepos
operator|=
name|ftell
argument_list|(
name|fp
argument_list|)
expr_stmt|;
name|bytelength
operator|=
name|nbytes
operator|-
literal|1
expr_stmt|;
name|array
operator|=
name|malloc
argument_list|(
literal|2
operator|*
expr|sizeof
operator|(
name|unsigned
name|char
operator|*
operator|)
argument_list|)
expr_stmt|;
name|array
index|[
literal|0
index|]
operator|=
name|makeintegers
argument_list|(
name|b
argument_list|,
name|bytepos
argument_list|,
name|bytelength
argument_list|)
expr_stmt|;
name|array
index|[
literal|1
index|]
operator|=
operator|(
name|unsigned
name|char
operator|*
operator|)
literal|0
expr_stmt|;
name|ptr
operator|=
name|makevector
argument_list|(
name|array
argument_list|,
name|type_vector
argument_list|,
name|subtype_integers
argument_list|)
expr_stmt|;
name|fseek
argument_list|(
name|fp
argument_list|,
name|bytelength
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|array
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|array
argument_list|)
expr_stmt|;
name|push
argument_list|(
name|ptr
argument_list|)
expr_stmt|;
block|}
end_block

begin_macro
name|seq_identifier
argument_list|(
argument|nbytes
argument_list|)
end_macro

begin_decl_stmt
name|int
name|nbytes
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|pushstring
argument_list|(
name|nbytes
argument_list|,
name|subtype_identifier
argument_list|)
expr_stmt|;
block|}
end_block

begin_macro
name|seq_string
argument_list|(
argument|nbytes
argument_list|)
end_macro

begin_decl_stmt
name|int
name|nbytes
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|pushstring
argument_list|(
name|nbytes
argument_list|,
name|subtype_string
argument_list|)
expr_stmt|;
block|}
end_block

begin_macro
name|seq_unknown
argument_list|(
argument|type
argument_list|,
argument|nbytes
argument_list|)
end_macro

begin_decl_stmt
name|int
name|type
decl_stmt|,
name|nbytes
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|error
argument_list|(
name|err4
argument_list|,
name|filepos
argument_list|,
name|type
argument_list|,
name|nbytes
argument_list|)
expr_stmt|;
block|}
end_block

begin_macro
name|seq_integer
argument_list|(
argument|nbytes
argument_list|)
end_macro

begin_decl_stmt
name|int
name|nbytes
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|pushinteger
argument_list|(
name|nbytes
argument_list|,
name|subtype_integer
argument_list|)
expr_stmt|;
block|}
end_block

begin_macro
name|seq_rational
argument_list|(
argument|nbytes
argument_list|)
end_macro

begin_decl_stmt
name|int
name|nbytes
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|pushinteger
argument_list|(
name|nbytes
argument_list|,
name|subtype_rational
argument_list|)
expr_stmt|;
block|}
end_block

begin_macro
name|shortnum
argument_list|(
argument|number
argument_list|)
end_macro

begin_decl_stmt
name|int
name|number
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|unsigned
name|char
name|value
index|[
literal|2
index|]
decl_stmt|;
name|unsigned
name|char
modifier|*
name|ptr
decl_stmt|;
name|value
index|[
literal|0
index|]
operator|=
operator|(
name|number
operator|>>
literal|8
operator|)
operator|&
literal|0377
expr_stmt|;
name|value
index|[
literal|1
index|]
operator|=
name|number
operator|&
literal|0377
expr_stmt|;
name|ptr
operator|=
name|makenumber
argument_list|(
literal|2
argument_list|,
name|value
argument_list|,
name|subtype_integer
argument_list|)
expr_stmt|;
name|push
argument_list|(
name|ptr
argument_list|)
expr_stmt|;
block|}
end_block

begin_comment
comment|/*  * Private procedures to this module.  *  */
end_comment

begin_expr_stmt
specifier|static
name|pushinteger
argument_list|(
argument|nbytes
argument_list|,
argument|subtype
argument_list|)
name|int
name|nbytes
operator|,
name|subtype
expr_stmt|;
end_expr_stmt

begin_block
block|{
name|int
name|n
decl_stmt|;
name|unsigned
name|char
modifier|*
name|ptr
decl_stmt|;
name|unsigned
name|char
modifier|*
name|array
decl_stmt|;
name|array
operator|=
operator|(
name|unsigned
name|char
operator|*
operator|)
name|malloc
argument_list|(
name|nbytes
argument_list|)
expr_stmt|;
for|for
control|(
name|n
operator|=
literal|0
init|;
name|n
operator|<
name|nbytes
condition|;
name|n
operator|++
control|)
name|array
index|[
name|n
index|]
operator|=
name|getc
argument_list|(
name|fp
argument_list|)
operator|&
literal|0377
expr_stmt|;
name|ptr
operator|=
name|makenumber
argument_list|(
name|nbytes
argument_list|,
name|array
argument_list|,
name|subtype
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|array
argument_list|)
expr_stmt|;
name|push
argument_list|(
name|ptr
argument_list|)
expr_stmt|;
block|}
end_block

begin_expr_stmt
specifier|static
name|pushstring
argument_list|(
argument|nbytes
argument_list|,
argument|subtype
argument_list|)
name|int
name|nbytes
operator|,
name|subtype
expr_stmt|;
end_expr_stmt

begin_block
block|{
name|int
name|n
decl_stmt|;
name|unsigned
name|char
modifier|*
name|ptr
decl_stmt|;
name|char
modifier|*
name|string
decl_stmt|;
name|string
operator|=
operator|(
name|char
operator|*
operator|)
name|malloc
argument_list|(
name|nbytes
operator|+
literal|1
argument_list|)
expr_stmt|;
for|for
control|(
name|n
operator|=
literal|0
init|;
name|n
operator|<
name|nbytes
condition|;
name|n
operator|++
control|)
name|string
index|[
name|n
index|]
operator|=
name|getc
argument_list|(
name|fp
argument_list|)
operator|&
literal|0377
expr_stmt|;
name|string
index|[
name|nbytes
index|]
operator|=
operator|(
name|char
operator|)
literal|0
expr_stmt|;
name|ptr
operator|=
name|makestring
argument_list|(
name|string
argument_list|,
name|subtype
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|string
argument_list|)
expr_stmt|;
name|push
argument_list|(
name|ptr
argument_list|)
expr_stmt|;
block|}
end_block

begin_expr_stmt
specifier|static
name|popint
argument_list|()
block|{
name|int
name|result
block|;
name|unsigned
name|char
operator|*
name|ptr
block|;
name|ptr
operator|=
name|pop
argument_list|(
name|type_number
argument_list|,
literal|0
argument_list|)
block|;
name|result
operator|=
name|getint
argument_list|(
name|ptr
argument_list|)
block|;
name|free
argument_list|(
name|ptr
argument_list|)
block|;
return|return
operator|(
name|result
operator|)
return|;
block|}
end_expr_stmt

begin_function
specifier|static
name|double
name|popdouble
parameter_list|()
block|{
name|double
name|result
decl_stmt|;
name|unsigned
name|char
modifier|*
name|ptr
decl_stmt|;
name|ptr
operator|=
name|pop
argument_list|(
name|type_number
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|result
operator|=
name|getdouble
argument_list|(
name|ptr
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|ptr
argument_list|)
expr_stmt|;
return|return
operator|(
name|result
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|unsigned
name|char
modifier|*
name|popidentifier
parameter_list|(
name|prefix
parameter_list|)
name|char
modifier|*
name|prefix
decl_stmt|;
comment|/* should end with '/' character */
block|{
name|unsigned
name|char
modifier|*
name|ptr
decl_stmt|,
modifier|*
name|composite
decl_stmt|;
name|ptr
operator|=
name|pop
argument_list|(
name|type_vector
argument_list|,
name|subtype_general
argument_list|)
expr_stmt|;
name|composite
operator|=
name|makeidentifier
argument_list|(
name|ptr
argument_list|,
name|prefix
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|ptr
argument_list|)
expr_stmt|;
return|return
operator|(
name|composite
operator|)
return|;
block|}
end_function

begin_expr_stmt
specifier|static
name|extendnumber
argument_list|(
argument|nbytes
argument_list|)
name|int
name|nbytes
expr_stmt|;
end_expr_stmt

begin_block
block|{
name|int
name|n
decl_stmt|,
name|len
decl_stmt|;
name|unsigned
name|char
modifier|*
name|number
decl_stmt|,
modifier|*
name|newnumber
decl_stmt|;
name|unsigned
name|char
modifier|*
name|ptr
decl_stmt|,
modifier|*
name|newptr
decl_stmt|;
name|ptr
operator|=
name|pop
argument_list|(
name|type_number
argument_list|,
name|subtype_integer
operator||
name|subtype_rational
argument_list|)
expr_stmt|;
name|number
operator|=
name|getnumber
argument_list|(
name|ptr
argument_list|)
expr_stmt|;
name|len
operator|=
name|getnumlen
argument_list|(
name|ptr
argument_list|)
expr_stmt|;
name|newnumber
operator|=
operator|(
name|unsigned
name|char
operator|*
operator|)
name|malloc
argument_list|(
name|len
operator|+
name|nbytes
argument_list|)
expr_stmt|;
for|for
control|(
name|n
operator|=
literal|0
init|;
name|n
operator|<
name|len
condition|;
name|n
operator|++
control|)
name|newnumber
index|[
name|n
index|]
operator|=
name|number
index|[
name|n
index|]
expr_stmt|;
for|for
control|(
name|n
operator|=
literal|0
init|;
name|n
operator|<
name|nbytes
condition|;
name|n
operator|++
control|)
name|newnumber
index|[
name|n
operator|+
name|len
index|]
operator|=
name|getc
argument_list|(
name|fp
argument_list|)
operator|&
literal|0377
expr_stmt|;
name|newptr
operator|=
name|makenumber
argument_list|(
name|len
operator|+
name|nbytes
argument_list|,
name|newnumber
argument_list|,
name|getsubtype
argument_list|(
name|ptr
argument_list|)
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|ptr
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|newnumber
argument_list|)
expr_stmt|;
name|push
argument_list|(
name|newptr
argument_list|)
expr_stmt|;
block|}
end_block

begin_expr_stmt
specifier|static
name|extendstring
argument_list|(
argument|nbytes
argument_list|)
name|int
name|nbytes
expr_stmt|;
end_expr_stmt

begin_block
block|{
name|int
name|n
decl_stmt|,
name|len
decl_stmt|;
name|char
modifier|*
name|string
decl_stmt|,
modifier|*
name|newstring
decl_stmt|;
name|unsigned
name|char
modifier|*
name|ptr
decl_stmt|,
modifier|*
name|newptr
decl_stmt|;
name|ptr
operator|=
name|pop
argument_list|(
name|type_string
argument_list|,
name|subtype_identifier
operator||
name|subtype_string
argument_list|)
expr_stmt|;
name|string
operator|=
name|getstring
argument_list|(
name|ptr
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|len
operator|=
name|strlen
argument_list|(
name|string
argument_list|)
expr_stmt|;
name|newstring
operator|=
operator|(
name|char
operator|*
operator|)
name|malloc
argument_list|(
name|len
operator|+
name|nbytes
operator|+
literal|1
argument_list|)
expr_stmt|;
name|strcpy
argument_list|(
name|newstring
argument_list|,
name|string
argument_list|)
expr_stmt|;
for|for
control|(
name|n
operator|=
literal|0
init|;
name|n
operator|<
name|nbytes
condition|;
name|n
operator|++
control|)
name|newstring
index|[
name|n
operator|+
name|len
index|]
operator|=
name|getc
argument_list|(
name|fp
argument_list|)
operator|&
literal|0377
expr_stmt|;
name|newstring
index|[
name|len
operator|+
name|nbytes
index|]
operator|=
operator|(
name|char
operator|)
literal|0
expr_stmt|;
name|newptr
operator|=
name|makestring
argument_list|(
name|newstring
argument_list|,
name|getsubtype
argument_list|(
name|ptr
argument_list|)
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|ptr
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|newstring
argument_list|)
expr_stmt|;
name|push
argument_list|(
name|newptr
argument_list|)
expr_stmt|;
block|}
end_block

end_unit


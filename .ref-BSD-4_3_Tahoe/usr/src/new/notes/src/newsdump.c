begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_include
include|#
directive|include
file|"parms.h"
end_include

begin_include
include|#
directive|include
file|"structs.h"
end_include

begin_include
include|#
directive|include
file|"newsgate.h"
end_include

begin_ifdef
ifdef|#
directive|ifdef
name|RCSIDENT
end_ifdef

begin_decl_stmt
specifier|static
name|char
modifier|*
name|RCSid
init|=
literal|"$Header: newsdump.c,v 1.7.0.8 85/07/20 13:43:56 notes Rel $"
decl_stmt|;
end_decl_stmt

begin_endif
endif|#
directive|endif
endif|RCSIDENT
end_endif

begin_comment
comment|/*  *	newsnote - take a note and dump it in a format that news will  *	understand. Submit the article to the news program as   *	defined in newsgate.h  *  *	newsresp - similar to newsnote, but it dumps a response instead.  *  *	The routines build some title lines and other headers for   *	submission to the news insertion program. The rest of the  *	article is fed to the news program through a pipe.  *	This turned out to be mucho mucho easier than building the  *	properly formatted intersystem files.  *  *	Original Coding:	Ray Essick	April 1982  *	Modified to produce cleaner looking output:  *				Ray Essick	May 1, 1982  *				(with good help from Brian Redman (harpo!ber)  *	Modified to solve meta-character ("'`) problems in popen()  *				Ray Essick	September 1982  *  *	Lots of code by Tw Cook at Hewlett-Packard to implement  *	compatibility with the USENET standards for news.  *			January 1984.  */
end_comment

begin_decl_stmt
specifier|extern
name|char
modifier|*
name|mnames
index|[]
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* month names */
end_comment

begin_function_decl
name|FILE
modifier|*
name|popen
parameter_list|()
function_decl|;
end_function_decl

begin_decl_stmt
name|char
modifier|*
name|Version
init|=
literal|"$Revision: 1.7.0.8 $"
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* Use RCS info */
end_comment

begin_macro
name|newsnote
argument_list|(
argument|io
argument_list|,
argument|note
argument_list|,
argument|notenum
argument_list|,
argument|ngroup
argument_list|,
argument|backwards
argument_list|)
end_macro

begin_decl_stmt
name|struct
name|io_f
modifier|*
name|io
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|struct
name|note_f
modifier|*
name|note
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|char
modifier|*
name|ngroup
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* to this newsgroup */
end_comment

begin_block
block|{
name|FILE
modifier|*
name|rnews
decl_stmt|;
comment|/* rnews pipe */
name|char
name|cmdline
index|[
name|CMDLEN
index|]
decl_stmt|;
comment|/* command line  */
name|char
name|line
index|[
name|TITLEN
operator|+
literal|50
index|]
decl_stmt|;
comment|/* scratch line */
name|int
name|i
decl_stmt|;
name|char
modifier|*
name|p
decl_stmt|,
modifier|*
name|q
decl_stmt|;
name|char
name|ntitle
index|[
name|TITLEN
operator|+
literal|10
index|]
decl_stmt|;
comment|/* title */
name|char
name|from
index|[
name|SYSSZ
operator|+
name|NAMESZ
operator|+
literal|3
index|]
decl_stmt|;
comment|/* formatted author */
name|char
name|path
index|[
name|BUFSIZ
index|]
decl_stmt|;
comment|/* path to author */
name|char
modifier|*
name|author
decl_stmt|;
comment|/* for Path line */
comment|/*  *	format some of the internal data structures in a suitable  *	format to send to the news system.  */
name|strcpy
argument_list|(
name|ntitle
argument_list|,
name|note
operator|->
name|ntitle
argument_list|)
expr_stmt|;
comment|/* make a title */
if|if
condition|(
name|backwards
condition|)
block|{
name|strcat
argument_list|(
name|ntitle
argument_list|,
literal|" "
argument_list|)
expr_stmt|;
comment|/* separate */
name|strcat
argument_list|(
name|ntitle
argument_list|,
name|NFSUFFIX
argument_list|)
expr_stmt|;
comment|/* add suffix */
block|}
comment|/*       * From:      *		author information      */
name|sprintf
argument_list|(
name|from
argument_list|,
literal|"%s@%s"
argument_list|,
comment|/* author */
name|note
operator|->
name|n_auth
operator|.
name|aname
argument_list|,
name|note
operator|->
name|n_auth
operator|.
name|asystem
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|notdef
comment|/*       * decided it was better to NOT append a domain here...      */
if|if
condition|(
name|index
argument_list|(
name|note
operator|->
name|n_auth
operator|.
name|asystem
argument_list|,
literal|'.'
argument_list|)
operator|!=
operator|(
name|char
operator|*
operator|)
name|NULL
condition|)
comment|/* domained */
block|{
name|sprintf
argument_list|(
name|from
argument_list|,
literal|"%s@%s"
argument_list|,
name|note
operator|->
name|n_auth
operator|.
name|aname
argument_list|,
name|note
operator|->
name|n_auth
operator|.
name|asystem
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|sprintf
argument_list|(
name|from
argument_list|,
literal|"%s@%s.%s"
argument_list|,
name|note
operator|->
name|n_auth
operator|.
name|aname
argument_list|,
name|note
operator|->
name|n_auth
operator|.
name|asystem
argument_list|,
name|DFLTDOMAIN
argument_list|)
expr_stmt|;
comment|/* append default */
block|}
endif|#
directive|endif
endif|notdef
comment|/*       * Path:      *	where the article has been      *  Maybe we want to use some format besides a!b!c, something like      *  a,b,c      */
if|if
condition|(
operator|!
name|strcmp
argument_list|(
name|System
argument_list|,
name|note
operator|->
name|n_id
operator|.
name|sys
argument_list|)
condition|)
comment|/* local */
block|{
name|sprintf
argument_list|(
name|path
argument_list|,
literal|"%s"
argument_list|,
name|note
operator|->
name|n_id
operator|.
name|sys
argument_list|)
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
operator|!
name|strcmp
argument_list|(
name|note
operator|->
name|n_id
operator|.
name|sys
argument_list|,
name|note
operator|->
name|n_from
argument_list|)
condition|)
comment|/* one hop */
block|{
name|sprintf
argument_list|(
name|path
argument_list|,
literal|"%s!%s"
argument_list|,
name|System
argument_list|,
name|note
operator|->
name|n_id
operator|.
name|sys
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|sprintf
argument_list|(
name|path
argument_list|,
literal|"%s!%s!%s"
argument_list|,
comment|/* several hops */
name|System
argument_list|,
name|note
operator|->
name|n_from
argument_list|,
name|note
operator|->
name|n_id
operator|.
name|sys
argument_list|)
expr_stmt|;
block|}
block|}
ifdef|#
directive|ifdef
name|UGLYPATH
comment|/* usually so */
comment|/*       * Fill in the "authorname" with either a placeholder      * or the real author name. Key this off whether the unique      * id matches the author's home system.      *      * This will usually use AUTHORPLACEHOLDER on new systems      * since the unique id's don't have the domains in yet.      *      * hacked at to satisfy the public at large still using the      * Path line although it's not supposed to be good any longer.      * new code checks to see if things are a common prefix. and      * that the next character in the longer string is a "."      * if so, it declares things good enough and uses the real author.      */
block|{
name|int
name|idlen
decl_stmt|,
name|authlen
decl_stmt|;
name|int
name|isok
decl_stmt|;
name|int
name|minlen
decl_stmt|;
name|idlen
operator|=
name|strlen
argument_list|(
name|note
operator|->
name|n_id
operator|.
name|sys
argument_list|)
expr_stmt|;
name|authlen
operator|=
name|strlen
argument_list|(
name|note
operator|->
name|n_auth
operator|.
name|asystem
argument_list|)
expr_stmt|;
name|minlen
operator|=
name|idlen
operator|<
name|authlen
condition|?
name|idlen
else|:
name|authlen
expr_stmt|;
comment|/* get shortest */
name|isok
operator|=
operator|(
name|strncmp
argument_list|(
name|note
operator|->
name|n_id
operator|.
name|sys
argument_list|,
name|note
operator|->
name|n_auth
operator|.
name|asystem
argument_list|,
name|minlen
argument_list|)
operator|==
literal|0
operator|)
expr_stmt|;
if|if
condition|(
name|isok
operator|&&
name|idlen
operator|<
name|authlen
condition|)
comment|/* id is short */
block|{
name|isok
operator|&=
operator|(
name|note
operator|->
name|n_auth
operator|.
name|asystem
index|[
name|idlen
index|]
operator|==
literal|'.'
operator|)
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|isok
operator|&&
name|authlen
operator|<
name|idlen
condition|)
name|isok
operator|&=
operator|(
name|note
operator|->
name|n_id
operator|.
name|sys
index|[
name|authlen
index|]
operator|==
literal|'.'
operator|)
expr_stmt|;
block|}
if|if
condition|(
name|isok
condition|)
name|author
operator|=
name|note
operator|->
name|n_auth
operator|.
name|aname
expr_stmt|;
comment|/* ok for him */
else|else
name|author
operator|=
name|AUTHORPLACEHOLDER
expr_stmt|;
comment|/* not local */
block|}
else|#
directive|else
else|!UGLYPATH
comment|/*       * the bnews code all assumes that the last component of      * the Path line is a user name. If we don't append something,      * that system will see the articles again, since news will      * disregard it when comparing to see where things have been.      */
name|author
operator|=
name|AUTHORPLACEHOLDER
expr_stmt|;
endif|#
directive|endif
endif|UGLYPATH
comment|/*  *	dump the article  */
if|if
condition|(
operator|(
name|rnews
operator|=
name|popen
argument_list|(
name|rnewscmd
argument_list|,
literal|"w"
argument_list|)
operator|)
operator|==
name|NULL
condition|)
comment|/* open news pipe */
return|return
operator|(
operator|-
literal|1
operator|)
return|;
comment|/* report failure */
name|fprintf
argument_list|(
name|rnews
argument_list|,
literal|"Relay-Version: Notesfiles %s; site %s\n"
argument_list|,
name|Version
argument_list|,
name|System
argument_list|)
expr_stmt|;
comment|/*  *	Here we make a slight deviation from what one would expect.  *	We use the LOCAL version of the notes/news gateway to pick  *	the Posting Version line. This is because we are the version  *	that actually makes the insertion into the news system.  *  *	To back it up, the Usenet Standards papr (rfc whatever) says  *	that the Posting-version "identifies the software responsible  *	for entering this message into the network".  *	Whether the "site" field should be the gatewaying site or where  *	the article originated is a good question.  *	I chose to make it the notes->news gateway running locally and  *	the site where the article originated.  *  *	The stuff with the #ifdef notdef is to preserve the old code  *	that just labeled article we gateway with a Posting version  *	of "Notesfiles" instead of "Notesfiles 1.x".  */
ifdef|#
directive|ifdef
name|notdef
if|if
condition|(
operator|!
name|strcmp
argument_list|(
name|System
argument_list|,
name|note
operator|->
name|n_id
operator|.
name|sys
argument_list|)
condition|)
comment|/* local note */
endif|#
directive|endif
endif|notdef
block|{
comment|/*  	 * always consider ourselves the posting version. We are the 	 * site that posted it to news!  There could be a question 	 * about articles gated in two places or which site should be 	 * there. 	 */
name|fprintf
argument_list|(
name|rnews
argument_list|,
literal|"Posting-Version: Notesfiles %s; site %s\n"
argument_list|,
name|Version
argument_list|,
name|note
operator|->
name|n_id
operator|.
name|sys
argument_list|)
expr_stmt|;
block|}
ifdef|#
directive|ifdef
name|notdef
else|else
comment|/* remote note */
name|fprintf
argument_list|(
name|rnews
argument_list|,
literal|"Posting-Version: Notesfiles; site %s.%s\n"
argument_list|,
name|note
operator|->
name|n_id
operator|.
name|sys
argument_list|,
name|DFLTDOMAIN
argument_list|)
expr_stmt|;
comment|/* unknown version */
endif|#
directive|endif
endif|notdef
name|fprintf
argument_list|(
name|rnews
argument_list|,
literal|"From: %s\n"
argument_list|,
name|from
argument_list|)
expr_stmt|;
comment|/* formatted */
comment|/*  *	Sample format that is legal  *  fprintf (rnews, "Date: 13-Jan-83 12:08 PST\n");  */
name|fprintf
argument_list|(
name|rnews
argument_list|,
literal|"Date: %02d-%3s-%02d %02d:%02d %3s\n"
argument_list|,
name|note
operator|->
name|n_date
operator|.
name|w_day
argument_list|,
name|mnames
index|[
name|note
operator|->
name|n_date
operator|.
name|w_month
index|]
argument_list|,
name|note
operator|->
name|n_date
operator|.
name|w_year
operator|-
literal|1900
argument_list|,
name|note
operator|->
name|n_date
operator|.
name|w_hours
argument_list|,
name|note
operator|->
name|n_date
operator|.
name|w_mins
argument_list|,
name|tzone
argument_list|(
operator|&
name|note
operator|->
name|n_date
argument_list|)
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|rnews
argument_list|,
literal|"Newsgroups: %s\n"
argument_list|,
name|ngroup
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|rnews
argument_list|,
literal|"Subject: %s\n"
argument_list|,
name|ntitle
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|rnews
argument_list|,
literal|"Message-ID:<%ld@%s>\n"
argument_list|,
name|note
operator|->
name|n_id
operator|.
name|uniqid
argument_list|,
name|note
operator|->
name|n_id
operator|.
name|sys
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|rnews
argument_list|,
literal|"Path: %s!%s\n"
argument_list|,
name|path
argument_list|,
name|author
argument_list|)
expr_stmt|;
comment|/*  *	send out the notesfile specfic headers  */
if|if
condition|(
name|note
operator|->
name|n_addr
operator|.
name|addr
operator|==
literal|0
condition|)
comment|/* make sure */
name|note
operator|->
name|n_addr
operator|.
name|textlen
operator|=
literal|0
expr_stmt|;
comment|/* on empty text */
name|fprintf
argument_list|(
name|rnews
argument_list|,
literal|"%s: #N:%s:%ld:%03o:%ld\n"
argument_list|,
comment|/* nf header */
name|NFLINE1
argument_list|,
comment|/* "NF-line1" */
name|note
operator|->
name|n_id
operator|.
name|sys
argument_list|,
name|note
operator|->
name|n_id
operator|.
name|uniqid
argument_list|,
name|note
operator|->
name|n_stat
argument_list|,
operator|(
operator|(
name|long
operator|)
name|note
operator|->
name|n_addr
operator|.
name|textlen
operator|)
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|rnews
argument_list|,
literal|"%s: %s!%s    %3s %2d %02d:%02d:00 %4d\n"
argument_list|,
name|NFLINE2
argument_list|,
comment|/* "Nf-line2" */
name|note
operator|->
name|n_auth
operator|.
name|asystem
argument_list|,
name|note
operator|->
name|n_auth
operator|.
name|aname
argument_list|,
comment|/* author */
name|mnames
index|[
name|note
operator|->
name|n_date
operator|.
name|w_month
index|]
argument_list|,
comment|/* date written */
name|note
operator|->
name|n_date
operator|.
name|w_day
argument_list|,
name|note
operator|->
name|n_date
operator|.
name|w_hours
argument_list|,
name|note
operator|->
name|n_date
operator|.
name|w_mins
argument_list|,
name|note
operator|->
name|n_date
operator|.
name|w_year
argument_list|)
expr_stmt|;
comment|/*  *	Optional headers that we don't hassle with right now:  *	   Organization:	make a table driven routine to grab  */
name|putc
argument_list|(
literal|'\n'
argument_list|,
name|rnews
argument_list|)
expr_stmt|;
comment|/* separator */
if|if
condition|(
name|backwards
condition|)
comment|/* include old stuff */
block|{
name|fprintf
argument_list|(
name|rnews
argument_list|,
literal|"#N:%s:%ld:%03o:%ld\n"
argument_list|,
comment|/* nf header */
name|note
operator|->
name|n_id
operator|.
name|sys
argument_list|,
name|note
operator|->
name|n_id
operator|.
name|uniqid
argument_list|,
name|note
operator|->
name|n_stat
argument_list|,
operator|(
operator|(
name|long
operator|)
name|note
operator|->
name|n_addr
operator|.
name|textlen
operator|)
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|rnews
argument_list|,
literal|"%s!%s    %3s %2d %02d:%02d:00 %4d\n"
argument_list|,
name|note
operator|->
name|n_auth
operator|.
name|asystem
argument_list|,
name|note
operator|->
name|n_auth
operator|.
name|aname
argument_list|,
comment|/* author */
name|mnames
index|[
name|note
operator|->
name|n_date
operator|.
name|w_month
index|]
argument_list|,
comment|/* date written */
name|note
operator|->
name|n_date
operator|.
name|w_day
argument_list|,
name|note
operator|->
name|n_date
operator|.
name|w_hours
argument_list|,
name|note
operator|->
name|n_date
operator|.
name|w_mins
argument_list|,
name|note
operator|->
name|n_date
operator|.
name|w_year
argument_list|)
expr_stmt|;
block|}
name|putc
argument_list|(
literal|'\n'
argument_list|,
name|rnews
argument_list|)
expr_stmt|;
comment|/* separator */
name|pageout
argument_list|(
name|io
argument_list|,
operator|&
name|note
operator|->
name|n_addr
argument_list|,
name|rnews
argument_list|)
expr_stmt|;
comment|/* dump text */
name|fprintf
argument_list|(
name|rnews
argument_list|,
literal|"\n"
argument_list|)
expr_stmt|;
comment|/* ensure newline */
name|pclose
argument_list|(
name|rnews
argument_list|)
expr_stmt|;
comment|/* close it */
name|sleep
argument_list|(
name|SLEEPTIME
argument_list|)
expr_stmt|;
comment|/* wait a while */
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_block

begin_comment
comment|/*  *	newsresp  *  *	Dump a response to the news system.  */
end_comment

begin_macro
name|newsresp
argument_list|(
argument|io
argument_list|,
argument|note
argument_list|,
argument|notenum
argument_list|,
argument|rsprec
argument_list|,
argument|roffset
argument_list|,
argument|respnum
argument_list|,
argument|ngroup
argument_list|,
argument|backwards
argument_list|)
end_macro

begin_decl_stmt
name|struct
name|io_f
modifier|*
name|io
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|struct
name|note_f
modifier|*
name|note
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|struct
name|resp_f
modifier|*
name|rsprec
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|char
modifier|*
name|ngroup
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|char
name|cmdline
index|[
name|CMDLEN
index|]
decl_stmt|;
comment|/* leggo brand */
name|char
name|line
index|[
name|TITLEN
operator|+
literal|50
index|]
decl_stmt|;
comment|/* scratch */
name|FILE
modifier|*
name|rnews
decl_stmt|;
name|int
name|i
decl_stmt|;
name|char
modifier|*
name|p
decl_stmt|,
modifier|*
name|q
decl_stmt|;
name|char
name|ntitle
index|[
name|TITLEN
operator|+
literal|20
index|]
decl_stmt|;
comment|/* formatted title */
name|char
name|from
index|[
name|SYSSZ
operator|+
name|NAMESZ
operator|+
literal|3
index|]
decl_stmt|;
comment|/* formatted author */
name|char
name|path
index|[
name|BUFSIZ
index|]
decl_stmt|;
comment|/* path to author */
name|char
modifier|*
name|author
decl_stmt|;
comment|/* for Path: */
name|long
name|uniquenum
decl_stmt|;
comment|/*  *	pre-format a few fields like titles, author information,  *	paths to authors, and that sort of gunk.  */
name|ntitle
index|[
literal|0
index|]
operator|=
literal|'\0'
expr_stmt|;
comment|/* empty string */
if|if
condition|(
name|strncmp
argument_list|(
name|note
operator|->
name|ntitle
argument_list|,
literal|"Re:"
argument_list|,
literal|3
argument_list|)
operator|&&
comment|/* is it already */
name|strncmp
argument_list|(
name|note
operator|->
name|ntitle
argument_list|,
literal|"RE:"
argument_list|,
literal|3
argument_list|)
operator|&&
comment|/* a response-like */
name|strncmp
argument_list|(
name|note
operator|->
name|ntitle
argument_list|,
literal|"re:"
argument_list|,
literal|3
argument_list|)
condition|)
comment|/* title? */
block|{
comment|/* flag it as a */
name|strcat
argument_list|(
name|ntitle
argument_list|,
literal|"Re: "
argument_list|)
expr_stmt|;
comment|/* response */
block|}
name|strcat
argument_list|(
name|ntitle
argument_list|,
name|note
operator|->
name|ntitle
argument_list|)
expr_stmt|;
comment|/* include title */
if|if
condition|(
name|backwards
condition|)
block|{
name|strcat
argument_list|(
name|ntitle
argument_list|,
literal|" "
argument_list|)
expr_stmt|;
name|strcat
argument_list|(
name|ntitle
argument_list|,
name|NFSUFFIX
argument_list|)
expr_stmt|;
comment|/* include old */
block|}
comment|/*       * From:      *	author information      */
name|sprintf
argument_list|(
name|from
argument_list|,
literal|"%s@%s"
argument_list|,
comment|/* author */
name|rsprec
operator|->
name|r_auth
index|[
name|roffset
index|]
operator|.
name|aname
argument_list|,
name|rsprec
operator|->
name|r_auth
index|[
name|roffset
index|]
operator|.
name|asystem
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|notdef
comment|/*       * decided it was better to NOT append a domain at this point      */
if|if
condition|(
name|index
argument_list|(
name|rsprec
operator|->
name|r_auth
index|[
name|roffset
index|]
operator|.
name|asystem
argument_list|,
literal|'.'
argument_list|)
operator|!=
operator|(
name|char
operator|*
operator|)
name|NULL
condition|)
block|{
comment|/* already domained */
name|sprintf
argument_list|(
name|from
argument_list|,
literal|"%s@%s"
argument_list|,
name|rsprec
operator|->
name|r_auth
index|[
name|roffset
index|]
operator|.
name|aname
argument_list|,
name|rsprec
operator|->
name|r_auth
index|[
name|roffset
index|]
operator|.
name|asystem
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|sprintf
argument_list|(
name|from
argument_list|,
literal|"%s@%s.%s"
argument_list|,
name|rsprec
operator|->
name|r_auth
index|[
name|roffset
index|]
operator|.
name|aname
argument_list|,
name|rsprec
operator|->
name|r_auth
index|[
name|roffset
index|]
operator|.
name|asystem
argument_list|,
name|DFLTDOMAIN
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
endif|notdef
comment|/*       * Path:      *	Where the article has been      */
if|if
condition|(
operator|!
name|strcmp
argument_list|(
name|System
argument_list|,
name|rsprec
operator|->
name|r_id
index|[
name|roffset
index|]
operator|.
name|sys
argument_list|)
condition|)
comment|/* local */
block|{
name|sprintf
argument_list|(
name|path
argument_list|,
literal|"%s"
argument_list|,
name|rsprec
operator|->
name|r_id
index|[
name|roffset
index|]
operator|.
name|sys
argument_list|)
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
operator|!
name|strcmp
argument_list|(
name|rsprec
operator|->
name|r_id
index|[
name|roffset
index|]
operator|.
name|sys
argument_list|,
name|rsprec
operator|->
name|r_from
index|[
name|roffset
index|]
argument_list|)
condition|)
block|{
comment|/* one hop */
name|sprintf
argument_list|(
name|path
argument_list|,
literal|"%s!%s"
argument_list|,
name|System
argument_list|,
name|rsprec
operator|->
name|r_id
index|[
name|roffset
index|]
operator|.
name|sys
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|sprintf
argument_list|(
name|path
argument_list|,
literal|"%s!%s!%s"
argument_list|,
comment|/* several hops */
name|System
argument_list|,
name|rsprec
operator|->
name|r_from
index|[
name|roffset
index|]
argument_list|,
name|rsprec
operator|->
name|r_id
index|[
name|roffset
index|]
operator|.
name|sys
argument_list|)
expr_stmt|;
block|}
block|}
ifdef|#
directive|ifdef
name|UGLYPATH
comment|/* usually so */
comment|/*       * See if we can use the author's name instead of      * AUTHORPLACEHOLDER.  Check this by comparin unique id's      * and the author's system.      *      * see similar code above in newsnote() for explanation of the      * gyrations here.      */
block|{
name|int
name|idlen
decl_stmt|,
name|authlen
decl_stmt|;
name|int
name|isok
decl_stmt|;
name|int
name|minlen
decl_stmt|;
name|idlen
operator|=
name|strlen
argument_list|(
name|rsprec
operator|->
name|r_id
index|[
name|roffset
index|]
operator|.
name|sys
argument_list|)
expr_stmt|;
name|authlen
operator|=
name|strlen
argument_list|(
name|rsprec
operator|->
name|r_auth
index|[
name|roffset
index|]
operator|.
name|asystem
argument_list|)
expr_stmt|;
name|minlen
operator|=
name|idlen
operator|<
name|authlen
condition|?
name|idlen
else|:
name|authlen
expr_stmt|;
name|isok
operator|=
operator|(
name|strncmp
argument_list|(
name|rsprec
operator|->
name|r_id
index|[
name|roffset
index|]
operator|.
name|sys
argument_list|,
name|rsprec
operator|->
name|r_auth
index|[
name|roffset
index|]
operator|.
name|asystem
argument_list|,
name|minlen
argument_list|)
operator|==
literal|0
operator|)
expr_stmt|;
if|if
condition|(
name|isok
operator|&&
name|idlen
operator|<
name|authlen
condition|)
comment|/* id is short */
block|{
name|isok
operator|&=
operator|(
name|rsprec
operator|->
name|r_auth
index|[
name|roffset
index|]
operator|.
name|asystem
index|[
name|idlen
index|]
operator|==
literal|'.'
operator|)
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|isok
operator|&&
name|authlen
operator|<
name|idlen
condition|)
comment|/* author syste is short */
name|isok
operator|&=
operator|(
name|rsprec
operator|->
name|r_id
index|[
name|roffset
index|]
operator|.
name|sys
index|[
name|authlen
index|]
operator|==
literal|'.'
operator|)
expr_stmt|;
block|}
if|if
condition|(
name|isok
condition|)
name|author
operator|=
name|rsprec
operator|->
name|r_auth
index|[
name|roffset
index|]
operator|.
name|aname
expr_stmt|;
else|else
name|author
operator|=
name|AUTHORPLACEHOLDER
expr_stmt|;
block|}
else|#
directive|else
else|!UGLYPATH
comment|/*       * since bnews programs all assume the last component of the      * path line is a user name, we have to put something there      * to keep them from disregarding the system name when trying      * to see where the article has been.      */
name|author
operator|=
name|AUTHORPLACEHOLDER
expr_stmt|;
endif|#
directive|endif
endif|UGLYPATH
comment|/*  *	Time to send the article to the news system  */
if|if
condition|(
operator|(
name|rnews
operator|=
name|popen
argument_list|(
name|rnewscmd
argument_list|,
literal|"w"
argument_list|)
operator|)
operator|==
name|NULL
condition|)
comment|/* will it work */
return|return
operator|(
operator|-
literal|1
operator|)
return|;
comment|/* report failure */
name|fprintf
argument_list|(
name|rnews
argument_list|,
literal|"Relay-Version: Notesfiles %s; site %s\n"
argument_list|,
name|Version
argument_list|,
name|System
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|notdef
if|if
condition|(
operator|!
name|strcmp
argument_list|(
name|System
argument_list|,
name|rsprec
operator|->
name|r_id
index|[
name|roffset
index|]
operator|.
name|sys
argument_list|)
condition|)
comment|/* local note */
endif|#
directive|endif
endif|notdef
block|{
comment|/*  	 * always consider ourselves the posting version. We are the 	 * site that posted it to news!  There could be a question 	 * about articles gated in two places or which site should be 	 * there. 	 * 	 * See comments around similar lines within the newsnote() 	 * routine above 	 */
name|fprintf
argument_list|(
name|rnews
argument_list|,
literal|"Posting-Version: Notesfiles %s; site %s\n"
argument_list|,
name|Version
argument_list|,
name|rsprec
operator|->
name|r_id
index|[
name|roffset
index|]
operator|.
name|sys
argument_list|)
expr_stmt|;
block|}
ifdef|#
directive|ifdef
name|notdef
else|else
comment|/* remote note */
name|fprintf
argument_list|(
name|rnews
argument_list|,
literal|"Posting-Version: Notesfiles; site %s.%s\n"
argument_list|,
name|rsprec
operator|->
name|r_id
index|[
name|roffset
index|]
operator|.
name|sys
argument_list|,
name|DFLTDOMAIN
argument_list|)
expr_stmt|;
comment|/* unknown version */
endif|#
directive|endif
endif|notdef
name|fprintf
argument_list|(
name|rnews
argument_list|,
literal|"From: %s\n"
argument_list|,
name|from
argument_list|)
expr_stmt|;
comment|/* formatted */
comment|/*  *	Sample format that is legal  *  fprintf (rnews, "Date: 13-Jan-83 12:08 PST\n");  */
name|fprintf
argument_list|(
name|rnews
argument_list|,
literal|"Date: %02d-%3s-%02d %02d:%02d %3s\n"
argument_list|,
name|rsprec
operator|->
name|r_when
index|[
name|roffset
index|]
operator|.
name|w_day
argument_list|,
name|mnames
index|[
name|rsprec
operator|->
name|r_when
index|[
name|roffset
index|]
operator|.
name|w_month
index|]
argument_list|,
name|rsprec
operator|->
name|r_when
index|[
name|roffset
index|]
operator|.
name|w_year
operator|-
literal|1900
argument_list|,
name|rsprec
operator|->
name|r_when
index|[
name|roffset
index|]
operator|.
name|w_hours
argument_list|,
name|rsprec
operator|->
name|r_when
index|[
name|roffset
index|]
operator|.
name|w_mins
argument_list|,
name|tzone
argument_list|(
operator|&
name|rsprec
operator|->
name|r_when
index|[
name|roffset
index|]
argument_list|)
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|rnews
argument_list|,
literal|"Newsgroups: %s\n"
argument_list|,
name|ngroup
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|rnews
argument_list|,
literal|"Subject: %s\n"
argument_list|,
name|ntitle
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|rnews
argument_list|,
literal|"Message-ID:<%ld@%s>\n"
argument_list|,
name|rsprec
operator|->
name|r_id
index|[
name|roffset
index|]
operator|.
name|uniqid
argument_list|,
name|rsprec
operator|->
name|r_id
index|[
name|roffset
index|]
operator|.
name|sys
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|rnews
argument_list|,
literal|"Path: %s!%s\n"
argument_list|,
name|path
argument_list|,
name|author
argument_list|)
expr_stmt|;
comment|/*  *	send out the notesfile specfic headers  */
name|fprintf
argument_list|(
name|rnews
argument_list|,
literal|"%s: #R:%s:%ld:%s:%ld:%03o:%ld\n"
argument_list|,
name|NFLINE1
argument_list|,
comment|/* Nf-ID */
name|note
operator|->
name|n_id
operator|.
name|sys
argument_list|,
name|note
operator|->
name|n_id
operator|.
name|uniqid
argument_list|,
name|rsprec
operator|->
name|r_id
index|[
name|roffset
index|]
operator|.
name|sys
argument_list|,
name|rsprec
operator|->
name|r_id
index|[
name|roffset
index|]
operator|.
name|uniqid
argument_list|,
name|rsprec
operator|->
name|r_stat
index|[
name|roffset
index|]
argument_list|,
operator|(
operator|(
name|long
operator|)
name|rsprec
operator|->
name|r_addr
index|[
name|roffset
index|]
operator|.
name|textlen
operator|)
argument_list|)
expr_stmt|;
comment|/* force it long */
name|fprintf
argument_list|(
name|rnews
argument_list|,
literal|"%s: %s!%s    %3s %2d %02d:%02d:00 %4d\n"
argument_list|,
name|NFLINE2
argument_list|,
comment|/* NF-From */
name|rsprec
operator|->
name|r_auth
index|[
name|roffset
index|]
operator|.
name|asystem
argument_list|,
name|rsprec
operator|->
name|r_auth
index|[
name|roffset
index|]
operator|.
name|aname
argument_list|,
name|mnames
index|[
name|rsprec
operator|->
name|r_when
index|[
name|roffset
index|]
operator|.
name|w_month
index|]
argument_list|,
comment|/* date written */
name|rsprec
operator|->
name|r_when
index|[
name|roffset
index|]
operator|.
name|w_day
argument_list|,
name|rsprec
operator|->
name|r_when
index|[
name|roffset
index|]
operator|.
name|w_hours
argument_list|,
name|rsprec
operator|->
name|r_when
index|[
name|roffset
index|]
operator|.
name|w_mins
argument_list|,
name|rsprec
operator|->
name|r_when
index|[
name|roffset
index|]
operator|.
name|w_year
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|uniquenum
operator|=
name|note
operator|->
name|n_id
operator|.
name|uniqid
operator|)
operator|<
literal|0
condition|)
comment|/* re-invert news */
name|uniquenum
operator|/=
operator|(
operator|-
literal|100
operator|)
expr_stmt|;
comment|/* back to normal */
name|fprintf
argument_list|(
name|rnews
argument_list|,
literal|"References:<%ld@%s>\n"
argument_list|,
name|uniquenum
argument_list|,
name|note
operator|->
name|n_id
operator|.
name|sys
argument_list|)
expr_stmt|;
name|putc
argument_list|(
literal|'\n'
argument_list|,
name|rnews
argument_list|)
expr_stmt|;
comment|/* separator */
if|if
condition|(
name|backwards
condition|)
comment|/* old stuff included */
block|{
name|fprintf
argument_list|(
name|rnews
argument_list|,
literal|"#R:%s:%ld:%s:%ld:%03o:%ld\n"
argument_list|,
name|note
operator|->
name|n_id
operator|.
name|sys
argument_list|,
name|note
operator|->
name|n_id
operator|.
name|uniqid
argument_list|,
name|rsprec
operator|->
name|r_id
index|[
name|roffset
index|]
operator|.
name|sys
argument_list|,
name|rsprec
operator|->
name|r_id
index|[
name|roffset
index|]
operator|.
name|uniqid
argument_list|,
name|rsprec
operator|->
name|r_stat
index|[
name|roffset
index|]
argument_list|,
operator|(
operator|(
name|long
operator|)
name|rsprec
operator|->
name|r_addr
index|[
name|roffset
index|]
operator|.
name|textlen
operator|)
argument_list|)
expr_stmt|;
comment|/* force it long */
name|fprintf
argument_list|(
name|rnews
argument_list|,
literal|"%s!%s    %3s %2d %02d:%02d:00 %4d\n"
argument_list|,
name|rsprec
operator|->
name|r_auth
index|[
name|roffset
index|]
operator|.
name|asystem
argument_list|,
name|rsprec
operator|->
name|r_auth
index|[
name|roffset
index|]
operator|.
name|aname
argument_list|,
name|mnames
index|[
name|rsprec
operator|->
name|r_when
index|[
name|roffset
index|]
operator|.
name|w_month
index|]
argument_list|,
comment|/* date written */
name|rsprec
operator|->
name|r_when
index|[
name|roffset
index|]
operator|.
name|w_day
argument_list|,
name|rsprec
operator|->
name|r_when
index|[
name|roffset
index|]
operator|.
name|w_hours
argument_list|,
name|rsprec
operator|->
name|r_when
index|[
name|roffset
index|]
operator|.
name|w_mins
argument_list|,
name|rsprec
operator|->
name|r_when
index|[
name|roffset
index|]
operator|.
name|w_year
argument_list|)
expr_stmt|;
block|}
name|putc
argument_list|(
literal|'\n'
argument_list|,
name|rnews
argument_list|)
expr_stmt|;
comment|/* separator */
name|pageout
argument_list|(
name|io
argument_list|,
operator|&
name|rsprec
operator|->
name|r_addr
index|[
name|roffset
index|]
argument_list|,
name|rnews
argument_list|)
expr_stmt|;
comment|/* dump text */
name|fprintf
argument_list|(
name|rnews
argument_list|,
literal|"\n"
argument_list|)
expr_stmt|;
comment|/* ensure a newline */
name|pclose
argument_list|(
name|rnews
argument_list|)
expr_stmt|;
comment|/* close it */
name|sleep
argument_list|(
name|SLEEPTIME
argument_list|)
expr_stmt|;
comment|/* and wait */
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_block

begin_comment
comment|/*  *	A quick and cheap way to calculate a timezone.  *  *	This routine makes the assumption that a notesfile site  *	we gateway for is in the same timezone as our site.  *  */
end_comment

begin_function
name|char
modifier|*
name|tzone
parameter_list|(
name|when
parameter_list|)
name|struct
name|when_f
name|when
decl_stmt|;
comment|/* unused */
block|{
ifdef|#
directive|ifdef
name|BSD42
include|#
directive|include
file|<sys/time.h>
comment|/* it moved! */
else|#
directive|else
include|#
directive|include
file|<time.h>
endif|#
directive|endif
endif|BSD42
include|#
directive|include
file|<sys/types.h>
comment|/* for ftime */
name|struct
name|tm
modifier|*
name|ltime
decl_stmt|;
specifier|extern
name|struct
name|tm
modifier|*
name|localtime
parameter_list|()
function_decl|;
name|long
name|timenow
decl_stmt|;
ifdef|#
directive|ifdef
name|USG
name|struct
name|tm
modifier|*
name|bp
decl_stmt|;
specifier|extern
name|char
modifier|*
name|tzname
index|[]
decl_stmt|;
name|time
argument_list|(
operator|&
name|timenow
argument_list|)
expr_stmt|;
name|ltime
operator|=
name|localtime
argument_list|(
operator|&
name|timenow
argument_list|)
expr_stmt|;
return|return
operator|(
name|tzname
index|[
name|ltime
operator|->
name|tm_isdst
index|]
operator|)
return|;
else|#
directive|else
comment|/*  *	for systems that still have the "timezone" function from V7  */
include|#
directive|include
file|<sys/timeb.h>
comment|/* for ftime */
name|struct
name|timeb
name|rawtime
decl_stmt|;
specifier|extern
name|char
modifier|*
name|timezone
parameter_list|()
function_decl|;
comment|/* please lint */
name|ftime
argument_list|(
operator|&
name|rawtime
argument_list|)
expr_stmt|;
comment|/* get information */
name|time
argument_list|(
operator|&
name|timenow
argument_list|)
expr_stmt|;
comment|/* get now */
name|ltime
operator|=
name|localtime
argument_list|(
operator|&
name|timenow
argument_list|)
expr_stmt|;
comment|/* see if DST */
return|return
operator|(
name|timezone
argument_list|(
operator|(
name|int
operator|)
name|rawtime
operator|.
name|timezone
argument_list|,
name|ltime
operator|->
name|tm_isdst
argument_list|)
operator|)
return|;
endif|#
directive|endif
block|}
end_function

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  *	$Source: /u1/X/libis/RCS/font.c,v $  *	$Header: font.c,v 1.1 86/11/17 14:34:11 swick Rel $  */
end_comment

begin_ifndef
ifndef|#
directive|ifndef
name|lint
end_ifndef

begin_decl_stmt
specifier|static
name|char
modifier|*
name|rcsid_font_c
init|=
literal|"$Header: font.c,v 1.1 86/11/17 14:34:11 swick Rel $"
decl_stmt|;
end_decl_stmt

begin_endif
endif|#
directive|endif
endif|lint
end_endif

begin_include
include|#
directive|include
file|"is-copyright.h"
end_include

begin_comment
comment|/*	font.c  *  *	GetFont		Takes a font name and stores it  *	FreeFont	Frees the storage taken by a font  *	MakeFontPixmap 	Convert font bitmap to pixmap  *  *	Copyright (c) 1986, Integrated Solutions, Inc.  */
end_comment

begin_include
include|#
directive|include
file|"Xis.h"
end_include

begin_include
include|#
directive|include
file|"vssite.h"
end_include

begin_include
include|#
directive|include
file|<errno.h>
end_include

begin_include
include|#
directive|include
file|<sys/file.h>
end_include

begin_decl_stmt
specifier|extern
name|int
name|errno
decl_stmt|;
end_decl_stmt

begin_function_decl
specifier|extern
name|char
modifier|*
name|strcpy
parameter_list|()
function_decl|;
end_function_decl

begin_function_decl
specifier|extern
name|char
modifier|*
name|strcat
parameter_list|()
function_decl|;
end_function_decl

begin_function_decl
specifier|extern
name|long
name|lseek
parameter_list|()
function_decl|;
end_function_decl

begin_function_decl
specifier|extern
name|PIXMAP
modifier|*
name|MakePixmap
parameter_list|()
function_decl|;
end_function_decl

begin_comment
comment|/*  * BitMap and FontData typedefs come from ../libvs100/param.h  */
end_comment

begin_comment
comment|/* BitMap typedefs */
end_comment

begin_typedef
typedef|typedef
name|short
name|a_BitmapEntryPtr
index|[
literal|2
index|]
typedef|;
end_typedef

begin_typedef
typedef|typedef
struct|struct
name|_Bitmap
block|{
name|a_BitmapEntryPtr
name|bm_address
decl_stmt|;
name|short
name|bm_width
decl_stmt|;
name|short
name|bm_height
decl_stmt|;
name|short
name|bm_bitsPerPixel
decl_stmt|;
block|}
name|BitMap
typedef|;
end_typedef

begin_typedef
typedef|typedef
name|short
name|a_Bitmap
index|[
literal|5
index|]
typedef|;
end_typedef

begin_comment
comment|/* FontData typedefs */
end_comment

begin_typedef
typedef|typedef
name|short
name|a_FontWidthEntryPtr
index|[
literal|2
index|]
typedef|;
end_typedef

begin_typedef
typedef|typedef
struct|struct
name|_FontData
block|{
name|a_Bitmap
name|f_characters
decl_stmt|;
name|short
name|f_firstChar
decl_stmt|;
name|short
name|f_lastChar
decl_stmt|;
name|a_FontWidthEntryPtr
name|f_leftArray
decl_stmt|;
name|short
name|f_baseline
decl_stmt|;
name|short
name|f_spaceIndex
decl_stmt|;
name|short
name|f_fixedWidth
decl_stmt|;
block|}
name|FontData
typedef|;
end_typedef

begin_comment
comment|/*  *	GetFont  */
end_comment

begin_function
name|FONT
modifier|*
name|GetFont
parameter_list|(
name|name
parameter_list|)
name|char
modifier|*
name|name
decl_stmt|;
block|{
name|char
name|pathname
index|[
literal|1024
index|]
decl_stmt|;
comment|/* font pathname			*/
name|int
name|file
decl_stmt|;
comment|/* file descriptor			*/
name|FontData
name|hdr
decl_stmt|;
comment|/* font file header			*/
define|#
directive|define
name|chars
value|((BitMap *) hdr.f_characters)
name|int
name|mask_size
decl_stmt|;
comment|/* size of mask bitmap			*/
name|int
name|xpos_size
decl_stmt|;
comment|/* size of x pos array			*/
name|char
modifier|*
name|mask
decl_stmt|;
comment|/* character mask bitmap		*/
specifier|register
name|short
modifier|*
name|xpos
decl_stmt|;
comment|/* x position of characters in mask	*/
specifier|register
name|FONT
modifier|*
name|font
decl_stmt|;
comment|/* font					*/
specifier|register
name|FontPriv
modifier|*
name|fpriv
decl_stmt|;
comment|/* font "private" parts			*/
ifdef|#
directive|ifdef
name|DEBUG
if|if
condition|(
name|debug
operator|&
name|D_Font
condition|)
name|printf
argument_list|(
literal|"GetFont(name=\"%s\")\n"
argument_list|,
name|name
argument_list|)
expr_stmt|;
endif|#
directive|endif
endif|DEBUG
comment|/* build pathname */
name|strcpy
argument_list|(
name|pathname
argument_list|,
name|DEFAULT_FONT_DIRECTORY
argument_list|)
expr_stmt|;
name|strcat
argument_list|(
name|pathname
argument_list|,
name|name
argument_list|)
expr_stmt|;
name|strcat
argument_list|(
name|pathname
argument_list|,
name|DEFAULT_FONT_SUFFIX
argument_list|)
expr_stmt|;
comment|/* open as "pathname", if open fails try "name" */
if|if
condition|(
operator|(
name|file
operator|=
name|open
argument_list|(
name|pathname
argument_list|,
name|O_RDONLY
argument_list|,
literal|0
argument_list|)
operator|)
operator|==
operator|-
literal|1
operator|&&
operator|(
name|errno
operator|!=
name|ENOENT
operator|||
operator|(
name|file
operator|=
name|open
argument_list|(
name|name
argument_list|,
name|O_RDONLY
argument_list|,
literal|0
argument_list|)
operator|)
operator|==
operator|-
literal|1
operator|)
condition|)
block|{
name|errno
operator|=
name|EINVAL
expr_stmt|;
return|return
operator|(
name|NULL
operator|)
return|;
block|}
comment|/* read header and swap bytes in shorts */
if|if
condition|(
name|read
argument_list|(
name|file
argument_list|,
operator|(
name|caddr_t
operator|)
operator|&
name|hdr
argument_list|,
sizeof|sizeof
argument_list|(
name|FontData
argument_list|)
argument_list|)
operator|!=
sizeof|sizeof
argument_list|(
name|FontData
argument_list|)
condition|)
block|{
name|close
argument_list|(
name|file
argument_list|)
expr_stmt|;
name|errno
operator|=
name|EINVAL
expr_stmt|;
return|return
operator|(
name|NULL
operator|)
return|;
block|}
name|SwapShorts
argument_list|(
operator|(
name|short
operator|*
operator|)
operator|&
name|hdr
argument_list|,
sizeof|sizeof
argument_list|(
name|FontData
argument_list|)
argument_list|)
expr_stmt|;
comment|/* read font mask, and swap bits in bytes */
name|mask_size
operator|=
name|BitmapSize
argument_list|(
name|chars
operator|->
name|bm_width
argument_list|,
name|chars
operator|->
name|bm_height
argument_list|)
expr_stmt|;
name|mask
operator|=
operator|(
name|char
operator|*
operator|)
name|Xalloc
argument_list|(
name|mask_size
argument_list|)
expr_stmt|;
name|lseek
argument_list|(
name|file
argument_list|,
operator|(
name|long
operator|)
name|hdr
operator|.
name|f_characters
index|[
literal|0
index|]
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|read
argument_list|(
name|file
argument_list|,
name|mask
argument_list|,
name|mask_size
argument_list|)
operator|!=
name|mask_size
condition|)
block|{
name|close
argument_list|(
name|file
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|mask
argument_list|)
expr_stmt|;
name|errno
operator|=
name|EINVAL
expr_stmt|;
return|return
operator|(
name|NULL
operator|)
return|;
block|}
name|SwapBits
argument_list|(
operator|(
name|short
operator|*
operator|)
name|mask
argument_list|,
name|mask_size
argument_list|)
expr_stmt|;
comment|/* read x position array */
if|if
condition|(
name|hdr
operator|.
name|f_fixedWidth
operator|==
literal|0
condition|)
block|{
name|xpos_size
operator|=
operator|(
name|hdr
operator|.
name|f_lastChar
operator|-
name|hdr
operator|.
name|f_firstChar
operator|+
literal|2
operator|)
operator|*
sizeof|sizeof
argument_list|(
name|short
argument_list|)
expr_stmt|;
name|xpos
operator|=
operator|(
name|short
operator|*
operator|)
name|Xalloc
argument_list|(
name|xpos_size
argument_list|)
expr_stmt|;
name|lseek
argument_list|(
name|file
argument_list|,
operator|(
name|long
operator|)
name|hdr
operator|.
name|f_leftArray
index|[
literal|0
index|]
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|read
argument_list|(
name|file
argument_list|,
operator|(
name|caddr_t
operator|)
name|xpos
argument_list|,
name|xpos_size
argument_list|)
operator|!=
name|xpos_size
condition|)
block|{
name|close
argument_list|(
name|file
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|mask
argument_list|)
expr_stmt|;
name|free
argument_list|(
operator|(
name|caddr_t
operator|)
name|xpos
argument_list|)
expr_stmt|;
name|errno
operator|=
name|EINVAL
expr_stmt|;
return|return
operator|(
name|NULL
operator|)
return|;
block|}
name|SwapShorts
argument_list|(
name|xpos
argument_list|,
name|xpos_size
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|xpos_size
operator|=
literal|0
expr_stmt|;
name|xpos
operator|=
name|NULL
expr_stmt|;
block|}
name|close
argument_list|(
name|file
argument_list|)
expr_stmt|;
comment|/* complete "font" struct with info from file */
name|font
operator|=
operator|(
name|FONT
operator|*
operator|)
name|Xalloc
argument_list|(
sizeof|sizeof
argument_list|(
name|FONT
argument_list|)
argument_list|)
expr_stmt|;
name|font
operator|->
name|name
operator|=
operator|(
name|char
operator|*
operator|)
name|Xalloc
argument_list|(
name|strlen
argument_list|(
name|name
argument_list|)
operator|+
literal|1
argument_list|)
expr_stmt|;
name|strcpy
argument_list|(
name|font
operator|->
name|name
argument_list|,
name|name
argument_list|)
expr_stmt|;
name|font
operator|->
name|first
operator|=
name|hdr
operator|.
name|f_firstChar
expr_stmt|;
name|font
operator|->
name|last
operator|=
name|hdr
operator|.
name|f_lastChar
expr_stmt|;
name|font
operator|->
name|space
operator|=
name|hdr
operator|.
name|f_spaceIndex
expr_stmt|;
name|font
operator|->
name|space
operator|+=
name|font
operator|->
name|first
expr_stmt|;
name|font
operator|->
name|height
operator|=
name|chars
operator|->
name|bm_height
expr_stmt|;
if|if
condition|(
name|hdr
operator|.
name|f_fixedWidth
condition|)
block|{
name|font
operator|->
name|avg_width
operator|=
name|hdr
operator|.
name|f_fixedWidth
expr_stmt|;
name|font
operator|->
name|fixed
operator|=
literal|1
expr_stmt|;
block|}
else|else
block|{
name|font
operator|->
name|avg_width
operator|=
operator|(
name|xpos
index|[
name|font
operator|->
name|last
index|]
operator|-
name|xpos
index|[
name|font
operator|->
name|first
index|]
operator|)
operator|/
operator|(
name|font
operator|->
name|last
operator|-
name|font
operator|->
name|first
operator|)
expr_stmt|;
name|font
operator|->
name|fixed
operator|=
literal|0
expr_stmt|;
block|}
name|font
operator|->
name|base
operator|=
name|hdr
operator|.
name|f_baseline
expr_stmt|;
name|font
operator|->
name|refcnt
operator|=
literal|1
expr_stmt|;
name|fpriv
operator|=
operator|(
name|FontPriv
operator|*
operator|)
name|Xalloc
argument_list|(
sizeof|sizeof
argument_list|(
name|FontPriv
argument_list|)
argument_list|)
expr_stmt|;
name|font
operator|->
name|data
operator|=
operator|(
name|caddr_t
operator|)
name|fpriv
expr_stmt|;
comment|/* complete "fpriv" struct */
block|{
name|BITMAP
modifier|*
name|bitmap
init|=
operator|(
name|BITMAP
operator|*
operator|)
name|Xalloc
argument_list|(
sizeof|sizeof
argument_list|(
name|BITMAP
argument_list|)
argument_list|)
decl_stmt|;
name|RASTER
modifier|*
name|raster
init|=
operator|(
name|RASTER
operator|*
operator|)
name|Xalloc
argument_list|(
sizeof|sizeof
argument_list|(
name|RASTER
argument_list|)
argument_list|)
decl_stmt|;
name|bitmap
operator|->
name|width
operator|=
name|chars
operator|->
name|bm_width
expr_stmt|;
name|bitmap
operator|->
name|height
operator|=
name|chars
operator|->
name|bm_height
expr_stmt|;
name|bitmap
operator|->
name|refcnt
operator|=
literal|1
expr_stmt|;
name|bitmap
operator|->
name|kind
operator|=
operator|(
name|char
operator|)
literal|0
expr_stmt|;
name|bitmap
operator|->
name|data
operator|=
operator|(
name|caddr_t
operator|)
name|raster
expr_stmt|;
name|raster
operator|->
name|width
operator|=
call|(
name|short
call|)
argument_list|(
operator|(
name|chars
operator|->
name|bm_width
operator|+
literal|15
operator|)
operator|>>
literal|4
argument_list|)
operator|<<
literal|1
expr_stmt|;
name|raster
operator|->
name|address
operator|=
operator|(
name|short
operator|*
operator|)
name|mask
expr_stmt|;
name|fpriv
operator|->
name|mask
operator|=
operator|(
name|BITMAP
operator|*
operator|)
name|bitmap
expr_stmt|;
name|fpriv
operator|->
name|xpos
operator|=
name|xpos
expr_stmt|;
comment|/* if x position array exists use it to create width array */
if|if
condition|(
name|xpos
condition|)
block|{
specifier|register
name|short
modifier|*
name|p
decl_stmt|,
modifier|*
name|limitp
decl_stmt|;
name|fpriv
operator|->
name|widths
operator|=
operator|(
name|short
operator|*
operator|)
name|Xalloc
argument_list|(
name|xpos_size
argument_list|)
expr_stmt|;
name|bcopy
argument_list|(
operator|(
name|char
operator|*
operator|)
name|xpos
argument_list|,
name|fpriv
operator|->
name|widths
argument_list|,
name|xpos_size
argument_list|)
expr_stmt|;
name|limitp
operator|=
operator|&
name|fpriv
operator|->
name|widths
index|[
name|font
operator|->
name|last
index|]
expr_stmt|;
for|for
control|(
name|p
operator|=
operator|&
name|fpriv
operator|->
name|widths
index|[
name|font
operator|->
name|first
index|]
init|;
name|p
operator|<=
name|limitp
condition|;
operator|++
name|p
control|)
block|{
operator|*
name|p
operator|=
name|p
index|[
literal|1
index|]
operator|-
operator|*
name|p
expr_stmt|;
block|}
block|}
else|else
block|{
name|fpriv
operator|->
name|widths
operator|=
name|NULL
expr_stmt|;
block|}
block|}
comment|/* initialize font_pixmaps */
block|{
specifier|register
name|int
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|FONTPIXMAPS
condition|;
operator|++
name|i
control|)
block|{
name|fpriv
operator|->
name|font_pixmaps
index|[
name|i
index|]
operator|.
name|p
operator|=
name|NULL
expr_stmt|;
block|}
name|fpriv
operator|->
name|next_pixmap
operator|=
literal|0
expr_stmt|;
block|}
return|return
operator|(
name|font
operator|)
return|;
undef|#
directive|undef
name|chars
block|}
end_function

begin_comment
comment|/*  *	FreeFont  */
end_comment

begin_expr_stmt
name|FreeFont
argument_list|(
name|font
argument_list|)
specifier|register
name|FONT
operator|*
name|font
expr_stmt|;
end_expr_stmt

begin_block
block|{
specifier|register
name|FontPriv
modifier|*
name|fpriv
init|=
name|FDATA
argument_list|(
name|font
argument_list|)
decl_stmt|;
name|BITMAP
modifier|*
name|bitmap
init|=
operator|(
name|BITMAP
operator|*
operator|)
name|fpriv
operator|->
name|mask
decl_stmt|;
specifier|register
name|RASTER
modifier|*
name|raster
init|=
operator|(
name|RASTER
operator|*
operator|)
name|bitmap
operator|->
name|data
decl_stmt|;
ifdef|#
directive|ifdef
name|DEBUG
if|if
condition|(
name|debug
operator|&
name|D_Font
condition|)
name|printf
argument_list|(
literal|"FreeFont(font=0x%x)\n"
argument_list|,
name|font
argument_list|)
expr_stmt|;
endif|#
directive|endif
endif|DEBUG
comment|/* free text bitmap */
name|free
argument_list|(
operator|(
name|caddr_t
operator|)
name|raster
operator|->
name|address
argument_list|)
expr_stmt|;
name|free
argument_list|(
operator|(
name|caddr_t
operator|)
name|raster
argument_list|)
expr_stmt|;
name|free
argument_list|(
operator|(
name|caddr_t
operator|)
name|bitmap
argument_list|)
expr_stmt|;
comment|/* free xpos and widths arrays */
if|if
condition|(
name|fpriv
operator|->
name|xpos
condition|)
block|{
name|free
argument_list|(
operator|(
name|caddr_t
operator|)
name|fpriv
operator|->
name|xpos
argument_list|)
expr_stmt|;
name|free
argument_list|(
operator|(
name|caddr_t
operator|)
name|fpriv
operator|->
name|widths
argument_list|)
expr_stmt|;
block|}
comment|/* free font pixmaps */
block|{
specifier|register
name|int
name|i
decl_stmt|;
specifier|register
name|struct
name|_font_pixmaps
modifier|*
name|font_pixmaps
init|=
operator|&
name|fpriv
operator|->
name|font_pixmaps
index|[
literal|0
index|]
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|FONTPIXMAPS
condition|;
operator|++
name|i
operator|,
operator|++
name|font_pixmaps
control|)
block|{
if|if
condition|(
name|font_pixmaps
operator|->
name|p
condition|)
block|{
name|FreePixmap
argument_list|(
name|font_pixmaps
operator|->
name|p
argument_list|)
expr_stmt|;
block|}
block|}
block|}
comment|/* free remainder of font data */
name|free
argument_list|(
operator|(
name|caddr_t
operator|)
name|fpriv
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|font
operator|->
name|name
argument_list|)
expr_stmt|;
name|free
argument_list|(
operator|(
name|caddr_t
operator|)
name|font
argument_list|)
expr_stmt|;
block|}
end_block

begin_comment
comment|/*  *	MakeFontPixmap  */
end_comment

begin_function
name|PIXMAP
modifier|*
name|MakeFontPixmap
parameter_list|(
name|font
parameter_list|,
name|fore
parameter_list|,
name|back
parameter_list|)
name|FONT
modifier|*
name|font
decl_stmt|;
specifier|register
name|int
name|fore
decl_stmt|,
name|back
decl_stmt|;
block|{
specifier|register
name|FontPriv
modifier|*
name|fdata
init|=
name|FDATA
argument_list|(
name|font
argument_list|)
decl_stmt|;
specifier|register
name|struct
name|_font_pixmaps
modifier|*
name|font_pixmap
init|=
operator|&
name|fdata
operator|->
name|font_pixmaps
index|[
literal|0
index|]
decl_stmt|;
specifier|register
name|int
name|i
decl_stmt|;
ifdef|#
directive|ifdef
name|DEBUG
if|if
condition|(
name|debug
operator|&
name|D_FontPixmap
condition|)
name|printf
argument_list|(
literal|"MakeFontPixmap(font=0x%x, fore=%d, back=%d)\n"
argument_list|,
name|font
argument_list|,
name|fore
argument_list|,
name|back
argument_list|)
expr_stmt|;
endif|#
directive|endif
endif|DEBUG
comment|/* search font_pixmaps for match */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|FONTPIXMAPS
condition|;
operator|++
name|i
control|)
block|{
if|if
condition|(
name|font_pixmap
operator|->
name|p
operator|&&
name|font_pixmap
operator|->
name|fore
operator|==
name|fore
operator|&&
name|font_pixmap
operator|->
name|back
operator|==
name|back
condition|)
block|{
comment|/* found match */
return|return
operator|(
name|font_pixmap
operator|->
name|p
operator|)
return|;
block|}
block|}
comment|/* free entry if necessary */
name|font_pixmap
operator|=
operator|&
name|fdata
operator|->
name|font_pixmaps
index|[
name|fdata
operator|->
name|next_pixmap
index|]
expr_stmt|;
if|if
condition|(
name|font_pixmap
operator|->
name|p
operator|!=
name|NULL
condition|)
block|{
name|FreePixmap
argument_list|(
name|font_pixmap
operator|->
name|p
argument_list|)
expr_stmt|;
block|}
comment|/* create pixmap and save in font_pixmaps */
name|font_pixmap
operator|->
name|fore
operator|=
name|fore
expr_stmt|;
name|font_pixmap
operator|->
name|back
operator|=
name|back
expr_stmt|;
name|font_pixmap
operator|->
name|p
operator|=
name|MakePixmap
argument_list|(
name|fdata
operator|->
name|mask
argument_list|,
name|fore
argument_list|,
name|back
argument_list|)
expr_stmt|;
name|fdata
operator|->
name|next_pixmap
operator|=
operator|(
name|fdata
operator|->
name|next_pixmap
operator|+
literal|1
operator|)
operator|%
name|FONTPIXMAPS
expr_stmt|;
return|return
operator|(
name|font_pixmap
operator|->
name|p
operator|)
return|;
block|}
end_function

end_unit


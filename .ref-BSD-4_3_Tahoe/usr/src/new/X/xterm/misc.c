begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  *	$Source: /u1/X/xterm/RCS/misc.c,v $  *	$Header: misc.c,v 10.101 86/12/02 08:49:20 swick Exp $  */
end_comment

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_include
include|#
directive|include
file|<setjmp.h>
end_include

begin_include
include|#
directive|include
file|<signal.h>
end_include

begin_include
include|#
directive|include
file|<ctype.h>
end_include

begin_include
include|#
directive|include
file|<pwd.h>
end_include

begin_include
include|#
directive|include
file|<sys/time.h>
end_include

begin_include
include|#
directive|include
file|<sys/file.h>
end_include

begin_include
include|#
directive|include
file|<X/Xlib.h>
end_include

begin_include
include|#
directive|include
file|"scrollbar.h"
end_include

begin_include
include|#
directive|include
file|"ptyx.h"
end_include

begin_include
include|#
directive|include
file|"data.h"
end_include

begin_include
include|#
directive|include
file|"error.h"
end_include

begin_include
include|#
directive|include
file|"gray.ic"
end_include

begin_include
include|#
directive|include
file|"hilite.ic"
end_include

begin_include
include|#
directive|include
file|"icon.ic"
end_include

begin_include
include|#
directive|include
file|"tek_icon.ic"
end_include

begin_include
include|#
directive|include
file|"wait.ic"
end_include

begin_include
include|#
directive|include
file|"waitmask.ic"
end_include

begin_include
include|#
directive|include
file|"../cursors/left_ptr.cursor"
end_include

begin_include
include|#
directive|include
file|"../cursors/left_ptr_mask.cursor"
end_include

begin_include
include|#
directive|include
file|"../cursors/tcross.cursor"
end_include

begin_include
include|#
directive|include
file|"../cursors/tcross_mask.cursor"
end_include

begin_include
include|#
directive|include
file|"../cursors/xterm.cursor"
end_include

begin_include
include|#
directive|include
file|"../cursors/xterm_mask.cursor"
end_include

begin_ifndef
ifndef|#
directive|ifndef
name|lint
end_ifndef

begin_decl_stmt
specifier|static
name|char
name|csrg_id
index|[]
init|=
literal|"@(#)misc.c	1.8\t(Berkeley/CSRG)\t9/18/87"
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|char
name|sccs_id
index|[]
init|=
literal|"@(#)misc.c\tX10/6.6B\t1/9/87"
decl_stmt|;
end_decl_stmt

begin_endif
endif|#
directive|endif
endif|lint
end_endif

begin_macro
name|xevents
argument_list|()
end_macro

begin_block
block|{
name|XEvent
name|reply
decl_stmt|;
specifier|register
name|XEvent
modifier|*
name|rep
init|=
operator|&
name|reply
decl_stmt|;
specifier|register
name|Screen
modifier|*
name|screen
init|=
operator|&
name|term
operator|.
name|screen
decl_stmt|;
if|if
condition|(
name|screen
operator|->
name|scroll_amt
condition|)
name|FlushScroll
argument_list|(
name|screen
argument_list|)
expr_stmt|;
name|XPending
argument_list|()
expr_stmt|;
do|do
block|{
name|XNextEvent
argument_list|(
operator|&
name|reply
argument_list|)
expr_stmt|;
name|xeventpass
argument_list|(
operator|&
name|reply
argument_list|)
expr_stmt|;
block|}
do|while
condition|(
name|QLength
argument_list|()
operator|>
literal|0
condition|)
do|;
block|}
end_block

begin_expr_stmt
name|xeventpass
argument_list|(
name|rep
argument_list|)
specifier|register
name|XEvent
operator|*
name|rep
expr_stmt|;
end_expr_stmt

begin_block
block|{
specifier|register
name|Screen
modifier|*
name|screen
init|=
operator|&
name|term
operator|.
name|screen
decl_stmt|;
specifier|register
name|Window
name|window
init|=
name|rep
operator|->
name|window
decl_stmt|;
specifier|register
name|Window
name|w
decl_stmt|;
specifier|register
name|int
name|i
decl_stmt|;
switch|switch
condition|(
operator|(
name|int
operator|)
name|rep
operator|->
name|type
condition|)
block|{
case|case
name|KeyPressed
case|:
name|Input
argument_list|(
operator|&
name|term
operator|.
name|keyboard
argument_list|,
operator|&
name|term
operator|.
name|screen
argument_list|,
operator|(
name|XKeyPressedEvent
operator|*
operator|)
name|rep
argument_list|)
expr_stmt|;
break|break;
case|case
name|ExposeWindow
case|:
if|if
condition|(
name|screen
operator|->
name|sb
operator|&&
name|window
operator|==
name|screen
operator|->
name|sb
operator|->
name|bar
condition|)
block|{
ifdef|#
directive|ifdef
name|DEBUG
if|if
condition|(
name|debug
condition|)
name|fputs
argument_list|(
literal|"ExposeWindow scrollbar\n"
argument_list|,
name|stderr
argument_list|)
expr_stmt|;
endif|#
directive|endif
endif|DEBUG
if|if
condition|(
operator|(
operator|(
name|XExposeEvent
operator|*
operator|)
name|rep
operator|)
operator|->
name|subwindow
operator|==
name|screen
operator|->
name|sb
operator|->
name|button
condition|)
block|{
name|screen
operator|->
name|sb
operator|->
name|buttonstate
operator|=
operator|-
literal|1
expr_stmt|;
name|DrawButton
argument_list|(
name|screen
operator|->
name|sb
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|(
operator|(
name|XExposeEvent
operator|*
operator|)
name|rep
operator|)
operator|->
name|subwindow
operator|==
name|screen
operator|->
name|sb
operator|->
name|save
condition|)
block|{
name|screen
operator|->
name|sb
operator|->
name|savestate
operator|=
operator|-
literal|1
expr_stmt|;
name|DrawSave
argument_list|(
name|screen
operator|->
name|sb
argument_list|)
expr_stmt|;
block|}
break|break;
block|}
if|if
condition|(
name|screen
operator|->
name|active_icon
condition|)
block|{
ifdef|#
directive|ifdef
name|DEBUG
name|fputs
argument_list|(
literal|"ExposeWindow icon\n"
argument_list|,
name|stderr
argument_list|)
expr_stmt|;
endif|#
directive|endif
endif|DEBUG
if|if
condition|(
name|window
operator|==
name|screen
operator|->
name|iconVwin
operator|.
name|window
condition|)
block|{
if|if
condition|(
operator|!
name|screen
operator|->
name|icon_show
condition|)
block|{
name|screen
operator|->
name|mappedVwin
operator|=
operator|&
name|screen
operator|->
name|iconVwin
expr_stmt|;
name|screen
operator|->
name|icon_show
operator|=
name|TRUE
expr_stmt|;
name|screen
operator|->
name|show
operator|=
name|FALSE
expr_stmt|;
name|screen
operator|->
name|timer
operator|=
literal|0
expr_stmt|;
name|screen
operator|->
name|holdoff
operator|=
name|FALSE
expr_stmt|;
if|if
condition|(
name|screen
operator|->
name|fullTwin
operator|.
name|window
condition|)
name|moveiconwindow
argument_list|(
name|screen
operator|->
name|fullTwin
operator|.
name|window
argument_list|,
name|screen
operator|->
name|fullVwin
operator|.
name|window
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|screen
operator|->
name|TekEmu
condition|)
name|VTUnselect
argument_list|()
expr_stmt|;
if|if
condition|(
name|term
operator|.
name|flags
operator|&
name|ICONINPUT
condition|)
name|reselectwindow
argument_list|(
name|screen
argument_list|)
expr_stmt|;
else|else
name|unselectwindow
argument_list|(
name|screen
argument_list|,
name|INWINDOW
argument_list|)
expr_stmt|;
name|screen
operator|->
name|iconinput
operator|=
name|FALSE
expr_stmt|;
name|VTExpose
argument_list|(
name|rep
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|window
operator|==
name|screen
operator|->
name|iconTwin
operator|.
name|window
condition|)
block|{
if|if
condition|(
operator|!
name|screen
operator|->
name|icon_show
condition|)
block|{
name|screen
operator|->
name|mappedTwin
operator|=
operator|&
name|screen
operator|->
name|iconTwin
expr_stmt|;
name|screen
operator|->
name|icon_show
operator|=
name|TRUE
expr_stmt|;
name|screen
operator|->
name|Tshow
operator|=
name|FALSE
expr_stmt|;
name|screen
operator|->
name|timer
operator|=
literal|0
expr_stmt|;
name|screen
operator|->
name|holdoff
operator|=
name|FALSE
expr_stmt|;
if|if
condition|(
name|screen
operator|->
name|fullVwin
operator|.
name|window
condition|)
name|moveiconwindow
argument_list|(
name|screen
operator|->
name|fullVwin
operator|.
name|window
argument_list|,
name|screen
operator|->
name|fullTwin
operator|.
name|window
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|screen
operator|->
name|TekEmu
condition|)
name|TekUnselect
argument_list|()
expr_stmt|;
if|if
condition|(
name|term
operator|.
name|flags
operator|&
name|ICONINPUT
condition|)
name|reselectwindow
argument_list|(
name|screen
argument_list|)
expr_stmt|;
else|else
name|unselectwindow
argument_list|(
name|screen
argument_list|,
name|INWINDOW
argument_list|)
expr_stmt|;
name|screen
operator|->
name|iconinput
operator|=
name|FALSE
expr_stmt|;
name|TekExpose
argument_list|(
name|rep
argument_list|)
expr_stmt|;
block|}
block|}
elseif|else
if|if
condition|(
name|window
operator|==
name|screen
operator|->
name|iconVwin
operator|.
name|window
operator|||
name|window
operator|==
name|screen
operator|->
name|iconTwin
operator|.
name|window
condition|)
block|{
ifdef|#
directive|ifdef
name|DEBUG
if|if
condition|(
name|debug
condition|)
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"ExposeWindow %s\n"
argument_list|,
name|window
operator|==
name|screen
operator|->
name|iconVwin
operator|.
name|window
condition|?
literal|"icon"
else|:
literal|"Ticon"
argument_list|)
expr_stmt|;
endif|#
directive|endif
endif|DEBUG
name|RefreshIcon
argument_list|(
name|screen
argument_list|,
name|window
argument_list|)
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|Titlebar
argument_list|(
name|screen
argument_list|)
operator|||
name|screen
operator|->
name|icon_show
condition|)
block|{
comment|/* icon_show is a kludge as the titlebar exposure event 		 * frequently arrives before the full window exposure event */
if|if
condition|(
name|window
operator|==
name|screen
operator|->
name|title
operator|.
name|tbar
condition|)
block|{
ifdef|#
directive|ifdef
name|DEBUG
if|if
condition|(
name|debug
condition|)
name|fputs
argument_list|(
literal|"ExposeWindow title\n"
argument_list|,
name|stderr
argument_list|)
expr_stmt|;
endif|#
directive|endif
endif|DEBUG
name|VTTitleExpose
argument_list|(
operator|(
name|XExposeWindowEvent
operator|*
operator|)
name|rep
argument_list|)
expr_stmt|;
break|break;
block|}
elseif|else
if|if
condition|(
name|window
operator|==
name|screen
operator|->
name|Ttitle
operator|.
name|tbar
condition|)
block|{
ifdef|#
directive|ifdef
name|DEBUG
if|if
condition|(
name|debug
condition|)
name|fputs
argument_list|(
literal|"ExposeWindow Ttitle\n"
argument_list|,
name|stderr
argument_list|)
expr_stmt|;
endif|#
directive|endif
endif|DEBUG
name|TekTitleExpose
argument_list|(
operator|(
name|XExposeWindowEvent
operator|*
operator|)
name|rep
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
if|if
condition|(
name|window
operator|==
name|screen
operator|->
name|fullVwin
operator|.
name|window
condition|)
block|{
ifdef|#
directive|ifdef
name|DEBUG
if|if
condition|(
name|debug
condition|)
name|fputs
argument_list|(
literal|"ExposeWindow VT\n"
argument_list|,
name|stderr
argument_list|)
expr_stmt|;
endif|#
directive|endif
endif|DEBUG
if|if
condition|(
operator|!
name|screen
operator|->
name|show
condition|)
block|{
name|screen
operator|->
name|mappedVwin
operator|=
operator|&
name|screen
operator|->
name|fullVwin
expr_stmt|;
if|if
condition|(
name|screen
operator|->
name|Ticonunmap
condition|)
block|{
name|screen
operator|->
name|Ticonunmap
operator|=
name|FALSE
expr_stmt|;
name|XMapWindow
argument_list|(
name|screen
operator|->
name|fullTwin
operator|.
name|window
argument_list|)
expr_stmt|;
name|screen
operator|->
name|Tshow
operator|=
name|TRUE
expr_stmt|;
if|if
condition|(
operator|!
name|screen
operator|->
name|TekEmu
condition|)
block|{
name|screen
operator|->
name|holdoff
operator|=
name|TRUE
expr_stmt|;
name|XUnmapTransparent
argument_list|(
name|VWindow
argument_list|(
name|screen
argument_list|)
argument_list|)
expr_stmt|;
name|XMapWindow
argument_list|(
name|VWindow
argument_list|(
name|screen
argument_list|)
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
else|else
block|{
name|screen
operator|->
name|timer
operator|=
literal|0
expr_stmt|;
name|screen
operator|->
name|holdoff
operator|=
name|FALSE
expr_stmt|;
block|}
name|screen
operator|->
name|show
operator|=
name|TRUE
expr_stmt|;
name|reselectwindow
argument_list|(
name|screen
argument_list|)
expr_stmt|;
if|if
condition|(
name|screen
operator|->
name|icon_show
operator|&&
name|screen
operator|->
name|deiconwarp
condition|)
name|DeiconWarp
argument_list|(
name|screen
argument_list|)
expr_stmt|;
name|screen
operator|->
name|icon_show
operator|=
name|FALSE
expr_stmt|;
name|screen
operator|->
name|iconinput
operator|=
name|FALSE
expr_stmt|;
block|}
name|VTExpose
argument_list|(
name|rep
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|window
operator|==
name|screen
operator|->
name|fullTwin
operator|.
name|window
condition|)
block|{
ifdef|#
directive|ifdef
name|DEBUG
if|if
condition|(
name|debug
condition|)
name|fputs
argument_list|(
literal|"ExposeWindow Tek\n"
argument_list|,
name|stderr
argument_list|)
expr_stmt|;
endif|#
directive|endif
endif|DEBUG
if|if
condition|(
operator|!
name|screen
operator|->
name|Tshow
condition|)
block|{
name|screen
operator|->
name|mappedTwin
operator|=
operator|&
name|screen
operator|->
name|fullTwin
expr_stmt|;
if|if
condition|(
name|screen
operator|->
name|iconunmap
condition|)
block|{
name|screen
operator|->
name|iconunmap
operator|=
name|FALSE
expr_stmt|;
name|XMapWindow
argument_list|(
name|screen
operator|->
name|fullVwin
operator|.
name|window
argument_list|)
expr_stmt|;
name|screen
operator|->
name|show
operator|=
name|TRUE
expr_stmt|;
if|if
condition|(
name|screen
operator|->
name|TekEmu
condition|)
block|{
name|screen
operator|->
name|holdoff
operator|=
name|TRUE
expr_stmt|;
name|XUnmapTransparent
argument_list|(
name|TWindow
argument_list|(
name|screen
argument_list|)
argument_list|)
expr_stmt|;
name|XMapWindow
argument_list|(
name|TWindow
argument_list|(
name|screen
argument_list|)
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
else|else
block|{
name|screen
operator|->
name|timer
operator|=
literal|0
expr_stmt|;
name|screen
operator|->
name|holdoff
operator|=
name|FALSE
expr_stmt|;
block|}
name|screen
operator|->
name|Tshow
operator|=
name|TRUE
expr_stmt|;
name|reselectwindow
argument_list|(
name|screen
argument_list|)
expr_stmt|;
if|if
condition|(
name|screen
operator|->
name|icon_show
operator|&&
name|screen
operator|->
name|deiconwarp
condition|)
name|DeiconWarp
argument_list|(
name|screen
argument_list|)
expr_stmt|;
name|screen
operator|->
name|icon_show
operator|=
name|FALSE
expr_stmt|;
name|screen
operator|->
name|iconinput
operator|=
name|FALSE
expr_stmt|;
block|}
name|TekExpose
argument_list|(
name|rep
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
name|ExposeRegion
case|:
if|if
condition|(
operator|!
name|screen
operator|->
name|active_icon
operator|&&
name|window
operator|==
name|screen
operator|->
name|iconVwin
operator|.
name|window
operator|||
name|window
operator|==
name|screen
operator|->
name|iconTwin
operator|.
name|window
condition|)
block|{
ifdef|#
directive|ifdef
name|DEBUG
if|if
condition|(
name|debug
condition|)
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"ExposeRegion %s\n"
argument_list|,
name|window
operator|==
name|screen
operator|->
name|iconVwin
operator|.
name|window
condition|?
literal|"icon"
else|:
literal|"Ticon"
argument_list|)
expr_stmt|;
endif|#
directive|endif
endif|DEBUG
name|RefreshIcon
argument_list|(
name|screen
argument_list|,
name|window
argument_list|)
expr_stmt|;
break|break;
block|}
ifdef|#
directive|ifdef
name|DEBUG
if|if
condition|(
name|debug
condition|)
name|fputs
argument_list|(
literal|"ExposeRegion\n"
argument_list|,
name|stderr
argument_list|)
expr_stmt|;
endif|#
directive|endif
endif|DEBUG
if|if
condition|(
operator|(
operator|(
name|XExposeWindowEvent
operator|*
operator|)
name|rep
operator|)
operator|->
name|detail
operator|==
name|ExposeCopy
operator|&&
name|screen
operator|->
name|incopy
operator|<=
literal|0
condition|)
block|{
name|screen
operator|->
name|incopy
operator|=
literal|1
expr_stmt|;
if|if
condition|(
name|screen
operator|->
name|scrolls
operator|>
literal|0
condition|)
name|screen
operator|->
name|scrolls
operator|--
expr_stmt|;
block|}
if|if
condition|(
name|HandleExposure
argument_list|(
name|screen
argument_list|,
name|rep
argument_list|)
condition|)
name|screen
operator|->
name|cursor_state
operator|=
name|OFF
expr_stmt|;
break|break;
case|case
name|ExposeCopy
case|:
ifdef|#
directive|ifdef
name|DEBUG
if|if
condition|(
name|debug
condition|)
name|fputs
argument_list|(
literal|"ExposeCopy\n"
argument_list|,
name|stderr
argument_list|)
expr_stmt|;
endif|#
directive|endif
endif|DEBUG
if|if
condition|(
name|screen
operator|->
name|incopy
operator|<=
literal|0
operator|&&
name|screen
operator|->
name|scrolls
operator|>
literal|0
condition|)
name|screen
operator|->
name|scrolls
operator|--
expr_stmt|;
if|if
condition|(
name|screen
operator|->
name|scrolls
condition|)
name|screen
operator|->
name|incopy
operator|=
operator|-
literal|1
expr_stmt|;
else|else
name|screen
operator|->
name|incopy
operator|=
literal|0
expr_stmt|;
break|break;
case|case
name|ButtonPressed
case|:
if|if
condition|(
name|screen
operator|->
name|incopy
condition|)
name|CopyWait
argument_list|(
name|screen
argument_list|)
expr_stmt|;
if|if
condition|(
name|window
operator|==
name|screen
operator|->
name|iconVwin
operator|.
name|window
condition|)
block|{
ifdef|#
directive|ifdef
name|DEBUG
if|if
condition|(
name|debug
condition|)
name|fputs
argument_list|(
literal|"ButtonPressed icon\n"
argument_list|,
name|stderr
argument_list|)
expr_stmt|;
endif|#
directive|endif
endif|DEBUG
name|XUnmapWindow
argument_list|(
name|window
argument_list|)
expr_stmt|;
if|if
condition|(
name|screen
operator|->
name|Ticonunmap
operator|&&
operator|!
name|screen
operator|->
name|TekEmu
condition|)
block|{
name|screen
operator|->
name|Ticonunmap
operator|=
name|FALSE
expr_stmt|;
name|XMapWindow
argument_list|(
name|TWindow
argument_list|(
name|screen
argument_list|)
argument_list|)
expr_stmt|;
name|screen
operator|->
name|Tshow
operator|=
name|TRUE
expr_stmt|;
name|screen
operator|->
name|holdoff
operator|=
name|TRUE
expr_stmt|;
block|}
name|XMapWindow
argument_list|(
name|screen
operator|->
name|fullVwin
operator|.
name|window
argument_list|)
expr_stmt|;
break|break;
block|}
elseif|else
if|if
condition|(
name|window
operator|==
name|screen
operator|->
name|iconTwin
operator|.
name|window
condition|)
block|{
ifdef|#
directive|ifdef
name|DEBUG
if|if
condition|(
name|debug
condition|)
name|fputs
argument_list|(
literal|"ButtonPressed Ticon\n"
argument_list|,
name|stderr
argument_list|)
expr_stmt|;
endif|#
directive|endif
endif|DEBUG
name|XUnmapWindow
argument_list|(
name|window
argument_list|)
expr_stmt|;
if|if
condition|(
name|screen
operator|->
name|iconunmap
operator|&&
name|screen
operator|->
name|TekEmu
condition|)
block|{
name|screen
operator|->
name|iconunmap
operator|=
name|FALSE
expr_stmt|;
name|XMapWindow
argument_list|(
name|VWindow
argument_list|(
name|screen
argument_list|)
argument_list|)
expr_stmt|;
name|screen
operator|->
name|show
operator|=
name|TRUE
expr_stmt|;
name|screen
operator|->
name|holdoff
operator|=
name|TRUE
expr_stmt|;
block|}
name|XMapWindow
argument_list|(
name|screen
operator|->
name|fullTwin
operator|.
name|window
argument_list|)
expr_stmt|;
break|break;
block|}
comment|/* drop through */
case|case
name|ButtonReleased
case|:
ifdef|#
directive|ifdef
name|DEBUG
if|if
condition|(
name|debug
condition|)
name|fputs
argument_list|(
literal|"ButtonPressed or ButtonReleased\n"
argument_list|,
name|stderr
argument_list|)
expr_stmt|;
endif|#
directive|endif
endif|DEBUG
name|HandleButtons
argument_list|(
operator|&
name|term
argument_list|,
name|rep
argument_list|,
name|screen
operator|->
name|respond
argument_list|)
expr_stmt|;
break|break;
case|case
name|UnmapWindow
case|:
comment|/* full windows */
if|if
condition|(
name|window
operator|==
name|screen
operator|->
name|fullVwin
operator|.
name|window
condition|)
block|{
ifdef|#
directive|ifdef
name|DEBUG
if|if
condition|(
name|debug
condition|)
name|fputs
argument_list|(
literal|"UnmapWindow VT\n"
argument_list|,
name|stderr
argument_list|)
expr_stmt|;
endif|#
directive|endif
endif|DEBUG
if|if
condition|(
name|screen
operator|->
name|fullVwin
operator|.
name|titlebar
condition|)
name|VTTitleUnhilite
argument_list|()
expr_stmt|;
name|screen
operator|->
name|show
operator|=
name|FALSE
expr_stmt|;
if|if
condition|(
name|screen
operator|->
name|Tshow
condition|)
block|{
name|screen
operator|->
name|Ticonunmap
operator|=
name|TRUE
expr_stmt|;
name|screen
operator|->
name|Tshow
operator|=
name|FALSE
expr_stmt|;
name|XUnmapWindow
argument_list|(
name|screen
operator|->
name|fullTwin
operator|.
name|window
argument_list|)
expr_stmt|;
name|SyncUnmap
argument_list|(
name|screen
operator|->
name|fullTwin
operator|.
name|window
argument_list|,
name|TWINDOWEVENTS
argument_list|)
expr_stmt|;
block|}
block|}
elseif|else
if|if
condition|(
name|window
operator|==
name|screen
operator|->
name|fullTwin
operator|.
name|window
condition|)
block|{
ifdef|#
directive|ifdef
name|DEBUG
if|if
condition|(
name|debug
condition|)
name|fputs
argument_list|(
literal|"UnmapWindow Tek\n"
argument_list|,
name|stderr
argument_list|)
expr_stmt|;
endif|#
directive|endif
endif|DEBUG
if|if
condition|(
name|screen
operator|->
name|fullTwin
operator|.
name|titlebar
condition|)
name|TekTitleUnhilite
argument_list|()
expr_stmt|;
name|screen
operator|->
name|Tshow
operator|=
name|FALSE
expr_stmt|;
if|if
condition|(
name|screen
operator|->
name|show
condition|)
block|{
name|screen
operator|->
name|iconunmap
operator|=
name|TRUE
expr_stmt|;
name|screen
operator|->
name|show
operator|=
name|FALSE
expr_stmt|;
name|XUnmapWindow
argument_list|(
name|screen
operator|->
name|fullVwin
operator|.
name|window
argument_list|)
expr_stmt|;
name|SyncUnmap
argument_list|(
name|screen
operator|->
name|fullVwin
operator|.
name|window
argument_list|,
name|WINDOWEVENTS
argument_list|)
expr_stmt|;
block|}
block|}
name|reselectwindow
argument_list|(
name|screen
argument_list|)
expr_stmt|;
name|screen
operator|->
name|timer
operator|=
literal|0
expr_stmt|;
break|break;
case|case
name|EnterWindow
case|:
if|if
condition|(
name|screen
operator|->
name|sb
condition|)
block|{
if|if
condition|(
name|window
operator|==
name|screen
operator|->
name|sb
operator|->
name|button
condition|)
block|{
if|if
condition|(
operator|(
name|i
operator|=
name|GetButtonState
argument_list|(
name|screen
operator|->
name|sb
argument_list|)
operator|)
operator|!=
name|BUTTON_NORMAL
condition|)
name|SetButtonState
argument_list|(
name|screen
operator|->
name|sb
argument_list|,
name|i
operator||
name|HILITED
argument_list|)
expr_stmt|;
break|break;
block|}
elseif|else
if|if
condition|(
name|window
operator|==
name|screen
operator|->
name|sb
operator|->
name|bar
condition|)
break|break;
block|}
if|if
condition|(
operator|(
name|window
operator|==
name|VWindow
argument_list|(
name|screen
argument_list|)
operator|||
name|window
operator|==
name|TWindow
argument_list|(
name|screen
argument_list|)
operator|)
operator|&&
operator|(
operator|(
operator|(
name|XEnterWindowEvent
operator|*
operator|)
name|rep
operator|)
operator|->
name|detail
operator|&
literal|0xff
operator|)
operator|!=
name|IntoOrFromSubwindow
condition|)
block|{
ifdef|#
directive|ifdef
name|DEBUG
if|if
condition|(
name|debug
condition|)
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"EnterWindow %s\n"
argument_list|,
name|window
operator|==
name|VWindow
argument_list|(
name|screen
argument_list|)
condition|?
literal|"VT"
else|:
literal|"Tek"
argument_list|)
expr_stmt|;
endif|#
directive|endif
endif|DEBUG
name|screen
operator|->
name|autowindow
operator|=
name|window
expr_stmt|;
name|DoEnterLeave
argument_list|(
name|screen
argument_list|,
name|EnterWindow
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
name|LeaveWindow
case|:
if|if
condition|(
name|screen
operator|->
name|sb
condition|)
block|{
if|if
condition|(
name|window
operator|==
name|screen
operator|->
name|sb
operator|->
name|button
condition|)
block|{
if|if
condition|(
operator|(
name|i
operator|=
name|GetButtonState
argument_list|(
name|screen
operator|->
name|sb
argument_list|)
operator|)
operator|!=
name|BUTTON_NORMAL
condition|)
name|SetButtonState
argument_list|(
name|screen
operator|->
name|sb
argument_list|,
name|i
operator|&
operator|~
name|HILITED
argument_list|)
expr_stmt|;
break|break;
block|}
elseif|else
if|if
condition|(
name|window
operator|==
name|screen
operator|->
name|sb
operator|->
name|bar
condition|)
break|break;
block|}
if|if
condition|(
operator|(
name|window
operator|==
name|VWindow
argument_list|(
name|screen
argument_list|)
operator|||
name|window
operator|==
name|TWindow
argument_list|(
name|screen
argument_list|)
operator|)
operator|&&
operator|(
operator|(
operator|(
name|XEnterWindowEvent
operator|*
operator|)
name|rep
operator|)
operator|->
name|detail
operator|&
literal|0xff
operator|)
operator|!=
name|IntoOrFromSubwindow
condition|)
ifdef|#
directive|ifdef
name|DEBUG
block|{
if|if
condition|(
name|debug
condition|)
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"LeaveWindow %s\n"
argument_list|,
name|window
operator|==
name|VWindow
argument_list|(
name|screen
argument_list|)
condition|?
literal|"VT"
else|:
literal|"Tek"
argument_list|)
expr_stmt|;
endif|#
directive|endif
endif|DEBUG
name|DoEnterLeave
argument_list|(
name|screen
argument_list|,
name|LeaveWindow
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|DEBUG
block|}
endif|#
directive|endif
endif|DEBUG
break|break;
case|case
name|FocusChange
case|:
if|if
condition|(
operator|(
operator|(
name|XFocusChangeEvent
operator|*
operator|)
name|rep
operator|)
operator|->
name|detail
operator|==
name|EnterWindow
condition|)
name|selectwindow
argument_list|(
name|screen
argument_list|,
name|FOCUS
argument_list|)
expr_stmt|;
else|else
name|unselectwindow
argument_list|(
name|screen
argument_list|,
name|FOCUS
argument_list|)
expr_stmt|;
break|break;
default|default:
break|break;
block|}
block|}
end_block

begin_expr_stmt
name|selectwindow
argument_list|(
name|screen
argument_list|,
name|flag
argument_list|)
specifier|register
name|Screen
operator|*
name|screen
expr_stmt|;
end_expr_stmt

begin_decl_stmt
specifier|register
name|int
name|flag
decl_stmt|;
end_decl_stmt

begin_block
block|{
if|if
condition|(
name|screen
operator|->
name|TekEmu
condition|)
block|{
name|TekSelect
argument_list|()
expr_stmt|;
if|if
condition|(
operator|!
name|Ttoggled
condition|)
name|TCursorToggle
argument_list|(
name|TOGGLE
argument_list|)
expr_stmt|;
if|if
condition|(
name|screen
operator|->
name|cellsused
condition|)
block|{
name|screen
operator|->
name|colorcells
index|[
literal|2
index|]
operator|.
name|pixel
operator|=
name|screen
operator|->
name|Tcursorcolor
expr_stmt|;
name|XStoreColor
argument_list|(
operator|&
name|screen
operator|->
name|colorcells
index|[
literal|2
index|]
argument_list|)
expr_stmt|;
block|}
name|screen
operator|->
name|select
operator||=
name|flag
expr_stmt|;
if|if
condition|(
operator|!
name|Ttoggled
condition|)
name|TCursorToggle
argument_list|(
name|TOGGLE
argument_list|)
expr_stmt|;
return|return;
block|}
else|else
block|{
name|VTSelect
argument_list|()
expr_stmt|;
if|if
condition|(
name|screen
operator|->
name|cursor_state
operator|&&
operator|(
name|screen
operator|->
name|cursor_col
operator|!=
name|screen
operator|->
name|cur_col
operator|||
name|screen
operator|->
name|cursor_row
operator|!=
name|screen
operator|->
name|cur_row
operator|)
condition|)
name|HideCursor
argument_list|()
expr_stmt|;
name|screen
operator|->
name|select
operator||=
name|flag
expr_stmt|;
if|if
condition|(
name|screen
operator|->
name|cursor_state
condition|)
name|ShowCursor
argument_list|()
expr_stmt|;
return|return;
block|}
block|}
end_block

begin_expr_stmt
name|unselectwindow
argument_list|(
name|screen
argument_list|,
name|flag
argument_list|)
specifier|register
name|Screen
operator|*
name|screen
expr_stmt|;
end_expr_stmt

begin_decl_stmt
specifier|register
name|int
name|flag
decl_stmt|;
end_decl_stmt

begin_block
block|{
specifier|register
name|int
name|i
decl_stmt|;
name|screen
operator|->
name|select
operator|&=
operator|~
name|flag
expr_stmt|;
if|if
condition|(
operator|!
name|screen
operator|->
name|select
condition|)
block|{
if|if
condition|(
name|screen
operator|->
name|TekEmu
condition|)
block|{
name|TekUnselect
argument_list|()
expr_stmt|;
if|if
condition|(
operator|!
name|Ttoggled
condition|)
name|TCursorToggle
argument_list|(
name|TOGGLE
argument_list|)
expr_stmt|;
if|if
condition|(
name|screen
operator|->
name|cellsused
condition|)
block|{
name|i
operator|=
operator|(
name|term
operator|.
name|flags
operator|&
name|REVERSE_VIDEO
operator|)
operator|==
literal|0
expr_stmt|;
name|screen
operator|->
name|colorcells
index|[
name|i
index|]
operator|.
name|pixel
operator|=
name|screen
operator|->
name|Tcursorcolor
expr_stmt|;
name|XStoreColor
argument_list|(
operator|&
name|screen
operator|->
name|colorcells
index|[
name|i
index|]
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|Ttoggled
condition|)
name|TCursorToggle
argument_list|(
name|TOGGLE
argument_list|)
expr_stmt|;
return|return;
block|}
else|else
block|{
name|VTUnselect
argument_list|()
expr_stmt|;
if|if
condition|(
name|screen
operator|->
name|cursor_state
operator|&&
operator|(
name|screen
operator|->
name|cursor_col
operator|!=
name|screen
operator|->
name|cur_col
operator|||
name|screen
operator|->
name|cursor_row
operator|!=
name|screen
operator|->
name|cur_row
operator|)
condition|)
name|HideCursor
argument_list|()
expr_stmt|;
if|if
condition|(
name|screen
operator|->
name|cursor_state
condition|)
name|ShowCursor
argument_list|()
expr_stmt|;
return|return;
block|}
block|}
block|}
end_block

begin_expr_stmt
name|reselectwindow
argument_list|(
name|screen
argument_list|)
specifier|register
name|Screen
operator|*
name|screen
expr_stmt|;
end_expr_stmt

begin_block
block|{
name|Window
name|win
decl_stmt|;
name|int
name|x
decl_stmt|,
name|y
decl_stmt|;
if|if
condition|(
name|XQueryMouse
argument_list|(
name|RootWindow
argument_list|,
operator|&
name|x
argument_list|,
operator|&
name|y
argument_list|,
operator|&
name|win
argument_list|)
condition|)
block|{
if|if
condition|(
name|win
operator|&&
operator|(
name|win
operator|==
name|VWindow
argument_list|(
name|screen
argument_list|)
operator|||
name|win
operator|==
name|TWindow
argument_list|(
name|screen
argument_list|)
operator|)
operator|&&
operator|(
operator|!
name|screen
operator|->
name|icon_show
operator|||
operator|(
name|screen
operator|->
name|active_icon
operator|&&
name|term
operator|.
name|flags
operator|&
name|ICONINPUT
operator|)
operator|)
condition|)
name|selectwindow
argument_list|(
name|screen
argument_list|,
name|INWINDOW
argument_list|)
expr_stmt|;
else|else
name|unselectwindow
argument_list|(
name|screen
argument_list|,
name|INWINDOW
argument_list|)
expr_stmt|;
block|}
block|}
end_block

begin_expr_stmt
name|DeiconWarp
argument_list|(
name|screen
argument_list|)
specifier|register
name|Screen
operator|*
name|screen
expr_stmt|;
end_expr_stmt

begin_block
block|{
if|if
condition|(
name|screen
operator|->
name|TekEmu
condition|)
name|XWarpMouse
argument_list|(
name|TWindow
argument_list|(
name|screen
argument_list|)
argument_list|,
name|TFullWidth
argument_list|(
name|screen
argument_list|)
operator|/
literal|2
argument_list|,
name|TFullHeight
argument_list|(
name|screen
argument_list|)
operator|/
literal|2
argument_list|)
expr_stmt|;
else|else
name|XWarpMouse
argument_list|(
name|VWindow
argument_list|(
name|screen
argument_list|)
argument_list|,
name|FullWidth
argument_list|(
name|screen
argument_list|)
operator|/
literal|2
argument_list|,
name|FullHeight
argument_list|(
name|screen
argument_list|)
operator|/
literal|2
argument_list|)
expr_stmt|;
block|}
end_block

begin_define
define|#
directive|define
name|ENTERLEAVE
value|500000L
end_define

begin_expr_stmt
name|DoEnterLeave
argument_list|(
name|screen
argument_list|,
name|type
argument_list|)
specifier|register
name|Screen
operator|*
name|screen
expr_stmt|;
end_expr_stmt

begin_decl_stmt
name|int
name|type
decl_stmt|;
end_decl_stmt

begin_block
block|{
if|if
condition|(
operator|!
name|screen
operator|->
name|autoraise
operator|&&
operator|!
name|screen
operator|->
name|holdoff
condition|)
block|{
if|if
condition|(
name|type
operator|==
name|EnterWindow
condition|)
name|selectwindow
argument_list|(
name|screen
argument_list|,
name|INWINDOW
argument_list|)
expr_stmt|;
else|else
name|unselectwindow
argument_list|(
name|screen
argument_list|,
name|INWINDOW
argument_list|)
expr_stmt|;
return|return;
block|}
name|screen
operator|->
name|timer
operator|=
name|type
expr_stmt|;
if|if
condition|(
operator|!
name|screen
operator|->
name|holdoff
condition|)
name|Timer
argument_list|(
name|ENTERLEAVE
argument_list|)
expr_stmt|;
block|}
end_block

begin_macro
name|Timer
argument_list|(
argument|val
argument_list|)
end_macro

begin_decl_stmt
name|long
name|val
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|struct
name|itimerval
name|it
decl_stmt|;
name|bzero
argument_list|(
operator|&
name|it
argument_list|,
sizeof|sizeof
argument_list|(
name|it
argument_list|)
argument_list|)
expr_stmt|;
name|it
operator|.
name|it_value
operator|.
name|tv_usec
operator|=
name|val
expr_stmt|;
name|setitimer
argument_list|(
name|ITIMER_REAL
argument_list|,
operator|&
name|it
argument_list|,
operator|(
expr|struct
name|itimerval
operator|*
operator|)
literal|0
argument_list|)
expr_stmt|;
block|}
end_block

begin_comment
comment|/*  * Handle window select/unselect.  *  * We enter from a SIGALRM; X I/O may be in progress,  * so just set a flag which is polled in in_put().  */
end_comment

begin_macro
name|onalarm
argument_list|()
end_macro

begin_block
block|{
specifier|register
name|Screen
modifier|*
name|screen
init|=
operator|&
name|term
operator|.
name|screen
decl_stmt|;
if|if
condition|(
name|screen
operator|->
name|timer
operator|==
literal|0
operator|||
name|screen
operator|->
name|holdoff
condition|)
block|{
comment|/* extraneous alarm */
name|Timer
argument_list|(
literal|0L
argument_list|)
expr_stmt|;
return|return;
block|}
name|doonalarmcode
operator|++
expr_stmt|;
block|}
end_block

begin_macro
name|onalarmcode
argument_list|()
end_macro

begin_block
block|{
specifier|register
name|Screen
modifier|*
name|screen
init|=
operator|&
name|term
operator|.
name|screen
decl_stmt|;
if|if
condition|(
name|screen
operator|->
name|timer
operator|==
name|EnterWindow
condition|)
block|{
ifdef|#
directive|ifdef
name|DEBUG
if|if
condition|(
name|debug
condition|)
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"onalarm: EnterWindow %s\n"
argument_list|,
name|screen
operator|->
name|autoraise
condition|?
operator|(
name|screen
operator|->
name|autowindow
operator|==
name|VWindow
argument_list|(
name|screen
argument_list|)
condition|?
literal|"VT"
else|:
literal|"Tek"
operator|)
else|:
literal|""
argument_list|)
expr_stmt|;
endif|#
directive|endif
endif|DEBUG
name|selectwindow
argument_list|(
name|screen
argument_list|,
name|INWINDOW
argument_list|)
expr_stmt|;
if|if
condition|(
name|screen
operator|->
name|autoraise
condition|)
name|XRaiseWindow
argument_list|(
name|screen
operator|->
name|autowindow
argument_list|)
expr_stmt|;
block|}
else|else
comment|/* LeaveWindow */
ifdef|#
directive|ifdef
name|DEBUG
block|{
if|if
condition|(
name|debug
condition|)
name|fputs
argument_list|(
literal|"onalarm: LeaveWindow\n"
argument_list|,
name|stderr
argument_list|)
expr_stmt|;
endif|#
directive|endif
endif|DEBUG
name|unselectwindow
argument_list|(
name|screen
argument_list|,
name|INWINDOW
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|DEBUG
block|}
endif|#
directive|endif
endif|DEBUG
name|screen
operator|->
name|timer
operator|=
literal|0
expr_stmt|;
name|doonalarmcode
operator|=
literal|0
expr_stmt|;
block|}
end_block

begin_function
name|Pixmap
name|make_hilite
parameter_list|(
name|fg
parameter_list|,
name|bg
parameter_list|)
name|int
name|fg
decl_stmt|,
name|bg
decl_stmt|;
block|{
specifier|extern
name|Pixmap
name|Make_tile
parameter_list|()
function_decl|;
return|return
operator|(
name|Make_tile
argument_list|(
name|hilite_width
argument_list|,
name|hilite_height
argument_list|,
name|hilite_bits
argument_list|,
name|fg
argument_list|,
name|bg
argument_list|)
operator|)
return|;
block|}
end_function

begin_function
name|Pixmap
name|make_gray
parameter_list|()
block|{
specifier|extern
name|Pixmap
name|Make_tile
parameter_list|()
function_decl|;
return|return
operator|(
name|Make_tile
argument_list|(
name|gray_width
argument_list|,
name|gray_height
argument_list|,
name|gray_bits
argument_list|,
name|BlackPixel
argument_list|,
name|WhitePixel
argument_list|)
operator|)
return|;
block|}
end_function

begin_function
name|Cursor
name|make_tcross
parameter_list|(
name|fg
parameter_list|,
name|bg
parameter_list|,
name|func
parameter_list|)
name|int
name|fg
decl_stmt|,
name|bg
decl_stmt|,
name|func
decl_stmt|;
block|{
return|return
operator|(
name|XCreateCursor
argument_list|(
name|tcross_width
argument_list|,
name|tcross_height
argument_list|,
name|tcross_bits
argument_list|,
name|tcross_mask_bits
argument_list|,
name|tcross_x_hot
argument_list|,
name|tcross_y_hot
argument_list|,
name|fg
argument_list|,
name|bg
argument_list|,
name|func
argument_list|)
operator|)
return|;
block|}
end_function

begin_function
name|Cursor
name|make_xterm
parameter_list|(
name|fg
parameter_list|,
name|bg
parameter_list|,
name|func
parameter_list|)
name|int
name|fg
decl_stmt|,
name|bg
decl_stmt|,
name|func
decl_stmt|;
block|{
return|return
operator|(
name|XCreateCursor
argument_list|(
name|xterm_width
argument_list|,
name|xterm_height
argument_list|,
name|xterm_bits
argument_list|,
name|xterm_mask_bits
argument_list|,
name|xterm_x_hot
argument_list|,
name|xterm_y_hot
argument_list|,
name|fg
argument_list|,
name|bg
argument_list|,
name|func
argument_list|)
operator|)
return|;
block|}
end_function

begin_function
name|Cursor
name|make_wait
parameter_list|(
name|fg
parameter_list|,
name|bg
parameter_list|,
name|func
parameter_list|)
name|int
name|fg
decl_stmt|,
name|bg
decl_stmt|,
name|func
decl_stmt|;
block|{
return|return
operator|(
name|XCreateCursor
argument_list|(
name|wait_width
argument_list|,
name|wait_height
argument_list|,
name|wait_bits
argument_list|,
name|waitmask_bits
argument_list|,
name|wait_x_hot
argument_list|,
name|wait_y_hot
argument_list|,
name|fg
argument_list|,
name|bg
argument_list|,
name|func
argument_list|)
operator|)
return|;
block|}
end_function

begin_function
name|Cursor
name|make_arrow
parameter_list|(
name|fg
parameter_list|,
name|bg
parameter_list|,
name|func
parameter_list|)
name|int
name|fg
decl_stmt|,
name|bg
decl_stmt|,
name|func
decl_stmt|;
block|{
return|return
operator|(
name|XCreateCursor
argument_list|(
name|left_ptr_width
argument_list|,
name|left_ptr_height
argument_list|,
name|left_ptr_bits
argument_list|,
name|left_ptr_mask_bits
argument_list|,
name|left_ptr_x_hot
argument_list|,
name|left_ptr_y_hot
argument_list|,
name|fg
argument_list|,
name|bg
argument_list|,
name|func
argument_list|)
operator|)
return|;
block|}
end_function

begin_function
name|char
modifier|*
name|uniquesuffix
parameter_list|(
name|name
parameter_list|)
name|char
modifier|*
name|name
decl_stmt|;
block|{
specifier|register
name|int
modifier|*
name|np
decl_stmt|,
modifier|*
name|fp
decl_stmt|,
name|i
decl_stmt|;
specifier|register
name|Window
modifier|*
name|cp
decl_stmt|;
specifier|register
name|int
name|temp
decl_stmt|,
name|j
decl_stmt|,
name|k
decl_stmt|,
name|exact
decl_stmt|,
modifier|*
name|number
decl_stmt|;
name|char
modifier|*
name|wname
decl_stmt|;
name|Window
modifier|*
name|children
decl_stmt|,
name|parent
decl_stmt|;
name|int
name|nchildren
decl_stmt|;
specifier|static
name|char
modifier|*
name|suffix
decl_stmt|,
name|sufbuf
index|[
literal|10
index|]
decl_stmt|;
name|char
modifier|*
name|malloc
parameter_list|()
function_decl|;
if|if
condition|(
name|suffix
condition|)
return|return
operator|(
name|suffix
operator|)
return|;
name|suffix
operator|=
name|sufbuf
expr_stmt|;
if|if
condition|(
operator|!
name|XQueryTree
argument_list|(
name|RootWindow
argument_list|,
operator|&
name|parent
argument_list|,
operator|&
name|nchildren
argument_list|,
operator|&
name|children
argument_list|)
operator|||
name|nchildren
operator|<
literal|1
operator|||
operator|(
name|number
operator|=
operator|(
name|int
operator|*
operator|)
name|malloc
argument_list|(
name|nchildren
operator|*
sizeof|sizeof
argument_list|(
name|int
argument_list|)
argument_list|)
operator|)
operator|==
name|NULL
condition|)
return|return
operator|(
name|suffix
operator|)
return|;
name|exact
operator|=
name|FALSE
expr_stmt|;
name|i
operator|=
name|strlen
argument_list|(
name|name
argument_list|)
expr_stmt|;
for|for
control|(
name|np
operator|=
name|number
operator|,
name|cp
operator|=
name|children
operator|,
name|j
operator|=
name|nchildren
init|;
name|j
operator|>
literal|0
condition|;
name|cp
operator|++
operator|,
name|j
operator|--
control|)
block|{
if|if
condition|(
operator|!
name|XFetchName
argument_list|(
operator|*
name|cp
argument_list|,
operator|&
name|wname
argument_list|)
operator|||
name|wname
operator|==
name|NULL
condition|)
continue|continue;
if|if
condition|(
name|strncmp
argument_list|(
name|name
argument_list|,
name|wname
argument_list|,
name|i
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|wname
index|[
name|i
index|]
operator|==
literal|0
operator|||
name|strcmp
argument_list|(
operator|&
name|wname
index|[
name|i
index|]
argument_list|,
literal|" (Tek)"
argument_list|)
operator|==
literal|0
condition|)
name|exact
operator|=
name|TRUE
expr_stmt|;
elseif|else
if|if
condition|(
name|strncmp
argument_list|(
operator|&
name|wname
index|[
name|i
index|]
argument_list|,
literal|" #"
argument_list|,
literal|2
argument_list|)
operator|==
literal|0
condition|)
operator|*
name|np
operator|++
operator|=
name|atoi
argument_list|(
operator|&
name|wname
index|[
name|i
operator|+
literal|2
index|]
argument_list|)
expr_stmt|;
block|}
name|free
argument_list|(
name|wname
argument_list|)
expr_stmt|;
block|}
name|free
argument_list|(
operator|(
name|char
operator|*
operator|)
name|children
argument_list|)
expr_stmt|;
if|if
condition|(
name|exact
condition|)
block|{
if|if
condition|(
name|np
operator|<=
name|number
condition|)
name|strcpy
argument_list|(
name|suffix
argument_list|,
literal|" #2"
argument_list|)
expr_stmt|;
else|else
block|{
name|exact
operator|=
name|np
operator|-
name|number
expr_stmt|;
name|np
operator|=
name|number
expr_stmt|;
comment|/* shell sort */
for|for
control|(
name|i
operator|=
name|exact
operator|/
literal|2
init|;
name|i
operator|>
literal|0
condition|;
name|i
operator|/=
literal|2
control|)
for|for
control|(
name|k
operator|=
name|i
init|;
name|k
operator|<
name|exact
condition|;
name|k
operator|++
control|)
for|for
control|(
name|j
operator|=
name|k
operator|-
name|i
init|;
name|j
operator|>=
literal|0
operator|&&
name|np
index|[
name|j
index|]
operator|>
name|np
index|[
name|j
operator|+
name|i
index|]
condition|;
name|j
operator|-=
name|i
control|)
block|{
name|temp
operator|=
name|np
index|[
name|j
index|]
expr_stmt|;
name|np
index|[
name|j
index|]
operator|=
name|np
index|[
name|j
operator|+
name|i
index|]
expr_stmt|;
name|np
index|[
name|j
operator|+
name|i
index|]
operator|=
name|temp
expr_stmt|;
block|}
comment|/* make numbers unique */
for|for
control|(
name|fp
operator|=
name|np
operator|+
literal|1
operator|,
name|i
operator|=
name|exact
operator|-
literal|1
init|;
name|i
operator|>
literal|0
condition|;
name|fp
operator|++
operator|,
name|i
operator|--
control|)
if|if
condition|(
operator|*
name|fp
operator|!=
operator|*
name|np
condition|)
operator|*
operator|++
name|np
operator|=
operator|*
name|fp
expr_stmt|;
comment|/* find least unique number */
for|for
control|(
name|i
operator|=
literal|2
operator|,
name|fp
operator|=
name|number
init|;
name|fp
operator|<=
name|np
condition|;
name|fp
operator|++
control|)
block|{
if|if
condition|(
name|i
operator|<
operator|*
name|fp
condition|)
break|break;
if|if
condition|(
name|i
operator|==
operator|*
name|fp
condition|)
name|i
operator|++
expr_stmt|;
block|}
name|sprintf
argument_list|(
name|suffix
argument_list|,
literal|" #%d"
argument_list|,
name|i
argument_list|)
expr_stmt|;
block|}
block|}
name|free
argument_list|(
operator|(
name|char
operator|*
operator|)
name|number
argument_list|)
expr_stmt|;
return|return
operator|(
name|suffix
operator|)
return|;
block|}
end_function

begin_macro
name|Bell
argument_list|()
end_macro

begin_block
block|{
specifier|extern
name|Terminal
name|term
decl_stmt|;
specifier|register
name|Screen
modifier|*
name|screen
init|=
operator|&
name|term
operator|.
name|screen
decl_stmt|;
specifier|register
name|Window
name|w
decl_stmt|;
specifier|register
name|int
name|width
decl_stmt|,
name|height
decl_stmt|,
name|xorPixel
decl_stmt|;
if|if
condition|(
name|screen
operator|->
name|audiblebell
condition|)
name|XFeep
argument_list|(
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|screen
operator|->
name|visualbell
condition|)
block|{
if|if
condition|(
name|screen
operator|->
name|TekEmu
condition|)
block|{
if|if
condition|(
name|screen
operator|->
name|icon_show
operator|&&
operator|!
name|screen
operator|->
name|active_icon
condition|)
block|{
name|w
operator|=
name|screen
operator|->
name|iconTwin
operator|.
name|window
expr_stmt|;
name|width
operator|=
name|screen
operator|->
name|iconTwin
operator|.
name|width
expr_stmt|;
name|height
operator|=
name|screen
operator|->
name|iconTwin
operator|.
name|height
expr_stmt|;
block|}
else|else
block|{
name|w
operator|=
name|TWindow
argument_list|(
name|screen
argument_list|)
expr_stmt|;
name|width
operator|=
name|TFullWidth
argument_list|(
name|screen
argument_list|)
expr_stmt|;
name|height
operator|=
name|TFullHeight
argument_list|(
name|screen
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
if|if
condition|(
name|screen
operator|->
name|icon_show
operator|&&
operator|!
name|screen
operator|->
name|active_icon
condition|)
block|{
name|w
operator|=
name|screen
operator|->
name|iconVwin
operator|.
name|window
expr_stmt|;
name|width
operator|=
name|screen
operator|->
name|iconVwin
operator|.
name|width
expr_stmt|;
name|height
operator|=
name|screen
operator|->
name|iconVwin
operator|.
name|height
expr_stmt|;
block|}
else|else
block|{
name|w
operator|=
name|VWindow
argument_list|(
name|screen
argument_list|)
expr_stmt|;
name|width
operator|=
name|FullWidth
argument_list|(
name|screen
argument_list|)
expr_stmt|;
name|height
operator|=
name|FullHeight
argument_list|(
name|screen
argument_list|)
expr_stmt|;
block|}
block|}
name|xorPixel
operator|=
name|screen
operator|->
name|foreground
operator|^
name|screen
operator|->
name|background
expr_stmt|;
name|XPixFill
argument_list|(
name|w
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
name|width
argument_list|,
name|height
argument_list|,
name|xorPixel
argument_list|,
literal|0
argument_list|,
name|GXxor
argument_list|,
name|AllPlanes
argument_list|)
expr_stmt|;
name|XFlush
argument_list|()
expr_stmt|;
name|usleep
argument_list|(
name|screen
operator|->
name|visbelldelay
operator|*
literal|1000
argument_list|)
expr_stmt|;
name|XPixFill
argument_list|(
name|w
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
name|width
argument_list|,
name|height
argument_list|,
name|xorPixel
argument_list|,
literal|0
argument_list|,
name|GXxor
argument_list|,
name|AllPlanes
argument_list|)
expr_stmt|;
block|}
block|}
end_block

begin_macro
name|Redraw
argument_list|()
end_macro

begin_block
block|{
specifier|extern
name|Terminal
name|term
decl_stmt|;
specifier|register
name|Screen
modifier|*
name|screen
init|=
operator|&
name|term
operator|.
name|screen
decl_stmt|;
if|if
condition|(
name|VWindow
argument_list|(
name|screen
argument_list|)
operator|&&
name|screen
operator|->
name|show
condition|)
block|{
name|VTExpose
argument_list|(
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|screen
operator|->
name|scrollbar
condition|)
block|{
name|XClear
argument_list|(
name|screen
operator|->
name|sb
operator|->
name|bar
argument_list|)
expr_stmt|;
name|XClear
argument_list|(
name|screen
operator|->
name|sb
operator|->
name|region
argument_list|)
expr_stmt|;
name|screen
operator|->
name|sb
operator|->
name|buttonstate
operator|=
operator|-
literal|1
expr_stmt|;
name|DrawButton
argument_list|(
name|screen
operator|->
name|sb
argument_list|)
expr_stmt|;
name|screen
operator|->
name|sb
operator|->
name|savestate
operator|=
operator|-
literal|1
expr_stmt|;
name|DrawSave
argument_list|(
name|screen
operator|->
name|sb
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|Titlebar
argument_list|(
name|screen
argument_list|)
condition|)
block|{
name|XClear
argument_list|(
name|screen
operator|->
name|title
operator|.
name|tbar
argument_list|)
expr_stmt|;
name|XClear
argument_list|(
name|screen
operator|->
name|title
operator|.
name|left
argument_list|)
expr_stmt|;
name|XClear
argument_list|(
name|screen
operator|->
name|title
operator|.
name|right
argument_list|)
expr_stmt|;
name|VTTitleExpose
argument_list|(
name|NULL
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
name|TWindow
argument_list|(
name|screen
argument_list|)
operator|&&
name|screen
operator|->
name|Tshow
condition|)
block|{
name|TekExpose
argument_list|(
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|Titlebar
argument_list|(
name|screen
argument_list|)
condition|)
block|{
name|XClear
argument_list|(
name|screen
operator|->
name|Ttitle
operator|.
name|tbar
argument_list|)
expr_stmt|;
name|XClear
argument_list|(
name|screen
operator|->
name|Ttitle
operator|.
name|left
argument_list|)
expr_stmt|;
name|XClear
argument_list|(
name|screen
operator|->
name|Ttitle
operator|.
name|right
argument_list|)
expr_stmt|;
name|TekTitleExpose
argument_list|(
name|NULL
argument_list|)
expr_stmt|;
block|}
block|}
block|}
end_block

begin_expr_stmt
name|IconInit
argument_list|(
name|screen
argument_list|,
name|bm
argument_list|,
name|Tbm
argument_list|)
specifier|register
name|Screen
operator|*
name|screen
expr_stmt|;
end_expr_stmt

begin_decl_stmt
name|char
modifier|*
name|bm
decl_stmt|,
modifier|*
name|Tbm
decl_stmt|;
end_decl_stmt

begin_block
block|{
specifier|register
name|int
name|w
decl_stmt|;
name|again
label|:
if|if
condition|(
operator|!
name|bm
operator|&&
operator|!
name|Tbm
condition|)
block|{
comment|/* use default bitmaps */
name|screen
operator|->
name|iconbitmap
operator|.
name|bits
operator|=
name|icon_bits
expr_stmt|;
name|screen
operator|->
name|Ticonbitmap
operator|.
name|bits
operator|=
name|tek_icon_bits
expr_stmt|;
name|screen
operator|->
name|bitmapwidth
operator|=
name|screen
operator|->
name|iconbitmap
operator|.
name|width
operator|=
name|screen
operator|->
name|Ticonbitmap
operator|.
name|width
operator|=
name|icon_width
expr_stmt|;
name|screen
operator|->
name|bitmapheight
operator|=
name|screen
operator|->
name|iconbitmap
operator|.
name|height
operator|=
name|screen
operator|->
name|Ticonbitmap
operator|.
name|height
operator|=
name|icon_height
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|bm
operator|&&
operator|!
operator|*
name|bm
operator|&&
name|Tbm
operator|&&
operator|!
operator|*
name|Tbm
condition|)
comment|/* both empty means no bitmap */
name|screen
operator|->
name|bitmapwidth
operator|=
name|screen
operator|->
name|bitmapheight
operator|=
literal|0
expr_stmt|;
else|else
block|{
comment|/* user defined bitmap(s) */
if|if
condition|(
name|bm
operator|&&
operator|*
name|bm
condition|)
block|{
if|if
condition|(
operator|(
name|w
operator|=
name|XReadBitmapFile
argument_list|(
name|bm
argument_list|,
operator|&
name|screen
operator|->
name|iconbitmap
operator|.
name|width
argument_list|,
operator|&
name|screen
operator|->
name|iconbitmap
operator|.
name|height
argument_list|,
operator|&
name|screen
operator|->
name|iconbitmap
operator|.
name|bits
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
operator|)
operator|==
literal|0
condition|)
block|{
comment|/* 				 * Pretend there wasn't an icon specified 				 * and try for the default icon. 				 */
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"%s: Can't open %s\n"
argument_list|,
name|xterm_name
argument_list|,
name|bm
argument_list|)
expr_stmt|;
name|bm
operator|=
literal|0
expr_stmt|;
goto|goto
name|again
goto|;
block|}
elseif|else
if|if
condition|(
name|w
operator|<
literal|0
condition|)
block|{
name|syntaxerror
label|:
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"%s: Syntax error in %s\n"
argument_list|,
name|xterm_name
argument_list|,
name|bm
argument_list|)
expr_stmt|;
name|Exit
argument_list|(
name|ERROR_SYNTAXBITMAP
argument_list|)
expr_stmt|;
block|}
name|screen
operator|->
name|bitmapwidth
operator|=
name|screen
operator|->
name|iconbitmap
operator|.
name|width
expr_stmt|;
name|screen
operator|->
name|bitmapheight
operator|=
name|screen
operator|->
name|iconbitmap
operator|.
name|height
expr_stmt|;
block|}
if|if
condition|(
name|Tbm
operator|&&
operator|*
name|Tbm
condition|)
block|{
if|if
condition|(
operator|(
name|w
operator|=
name|XReadBitmapFile
argument_list|(
name|Tbm
argument_list|,
operator|&
name|screen
operator|->
name|Ticonbitmap
operator|.
name|width
argument_list|,
operator|&
name|screen
operator|->
name|Ticonbitmap
operator|.
name|height
argument_list|,
operator|&
name|screen
operator|->
name|Ticonbitmap
operator|.
name|bits
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
operator|)
operator|==
literal|0
condition|)
block|{
comment|/* 				 * Pretend there wasn't an icon specified 				 * and try for the default icon. 				 */
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"%s: Can't open %s\n"
argument_list|,
name|xterm_name
argument_list|,
name|Tbm
argument_list|)
expr_stmt|;
name|Tbm
operator|=
literal|0
expr_stmt|;
goto|goto
name|again
goto|;
block|}
elseif|else
if|if
condition|(
name|w
operator|<
literal|0
condition|)
goto|goto
name|syntaxerror
goto|;
if|if
condition|(
name|screen
operator|->
name|bitmapwidth
operator|<
name|screen
operator|->
name|Ticonbitmap
operator|.
name|width
condition|)
name|screen
operator|->
name|bitmapwidth
operator|=
name|screen
operator|->
name|Ticonbitmap
operator|.
name|width
expr_stmt|;
if|if
condition|(
name|screen
operator|->
name|bitmapheight
operator|<
name|screen
operator|->
name|Ticonbitmap
operator|.
name|height
condition|)
name|screen
operator|->
name|bitmapheight
operator|=
name|screen
operator|->
name|Ticonbitmap
operator|.
name|height
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|screen
operator|->
name|iconbitmap
operator|.
name|bits
condition|)
block|{
if|if
condition|(
operator|!
name|screen
operator|->
name|Ticonbitmap
operator|.
name|bits
condition|)
block|{
name|screen
operator|->
name|Ticonbitmap
operator|.
name|bits
operator|=
name|tek_icon_bits
expr_stmt|;
name|screen
operator|->
name|bitmapwidth
operator|=
name|screen
operator|->
name|Ticonbitmap
operator|.
name|width
operator|=
name|icon_width
expr_stmt|;
name|screen
operator|->
name|bitmapheight
operator|=
name|screen
operator|->
name|Ticonbitmap
operator|.
name|height
operator|=
name|icon_height
expr_stmt|;
block|}
name|screen
operator|->
name|iconbitmap
operator|.
name|bits
operator|=
name|screen
operator|->
name|Ticonbitmap
operator|.
name|bits
expr_stmt|;
name|screen
operator|->
name|iconbitmap
operator|.
name|width
operator|=
name|screen
operator|->
name|Ticonbitmap
operator|.
name|width
expr_stmt|;
name|screen
operator|->
name|iconbitmap
operator|.
name|height
operator|=
name|screen
operator|->
name|Ticonbitmap
operator|.
name|height
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|!
name|screen
operator|->
name|Ticonbitmap
operator|.
name|bits
condition|)
block|{
if|if
condition|(
operator|!
name|screen
operator|->
name|iconbitmap
operator|.
name|bits
condition|)
block|{
name|screen
operator|->
name|iconbitmap
operator|.
name|bits
operator|=
name|icon_bits
expr_stmt|;
name|screen
operator|->
name|bitmapwidth
operator|=
name|screen
operator|->
name|iconbitmap
operator|.
name|width
operator|=
name|icon_width
expr_stmt|;
name|screen
operator|->
name|bitmapheight
operator|=
name|screen
operator|->
name|iconbitmap
operator|.
name|height
operator|=
name|icon_height
expr_stmt|;
block|}
name|screen
operator|->
name|Ticonbitmap
operator|.
name|bits
operator|=
name|screen
operator|->
name|iconbitmap
operator|.
name|bits
expr_stmt|;
name|screen
operator|->
name|Ticonbitmap
operator|.
name|width
operator|=
name|screen
operator|->
name|iconbitmap
operator|.
name|width
expr_stmt|;
name|screen
operator|->
name|Ticonbitmap
operator|.
name|height
operator|=
name|screen
operator|->
name|iconbitmap
operator|.
name|height
expr_stmt|;
block|}
block|}
if|if
condition|(
operator|(
name|screen
operator|->
name|winname
operator|=
name|malloc
argument_list|(
name|strlen
argument_list|(
name|win_name
argument_list|)
operator|+
literal|10
argument_list|)
operator|)
operator|==
name|NULL
condition|)
name|Error
argument_list|(
name|ERROR_WINNAME
argument_list|)
expr_stmt|;
name|strcpy
argument_list|(
name|screen
operator|->
name|winname
argument_list|,
name|win_name
argument_list|)
expr_stmt|;
if|if
condition|(
name|douniquesuffix
condition|)
name|strcat
argument_list|(
name|screen
operator|->
name|winname
argument_list|,
name|uniquesuffix
argument_list|(
name|win_name
argument_list|)
argument_list|)
expr_stmt|;
name|screen
operator|->
name|winnamelen
operator|=
name|strlen
argument_list|(
name|screen
operator|->
name|winname
argument_list|)
expr_stmt|;
name|IconRecalc
argument_list|(
name|screen
argument_list|)
expr_stmt|;
block|}
end_block

begin_expr_stmt
name|IconRecalc
argument_list|(
name|screen
argument_list|)
specifier|register
name|Screen
operator|*
name|screen
expr_stmt|;
end_expr_stmt

begin_block
block|{
specifier|register
name|int
name|i
decl_stmt|,
name|w
decl_stmt|;
if|if
condition|(
name|screen
operator|->
name|active_icon
condition|)
return|return;
name|w
operator|=
name|XQueryWidth
argument_list|(
name|screen
operator|->
name|winname
argument_list|,
name|screen
operator|->
name|titlefont
operator|->
name|id
argument_list|)
expr_stmt|;
if|if
condition|(
name|screen
operator|->
name|bitmapwidth
operator|>
literal|0
condition|)
block|{
if|if
condition|(
name|screen
operator|->
name|textundericon
condition|)
block|{
name|screen
operator|->
name|icon_text_x
operator|=
name|TITLEPAD
expr_stmt|;
name|screen
operator|->
name|icon_text_y
operator|=
name|screen
operator|->
name|bitmapheight
operator|+
literal|2
operator|*
name|TITLEPAD
expr_stmt|;
name|screen
operator|->
name|iconVwin
operator|.
name|height
operator|=
name|screen
operator|->
name|bitmapheight
operator|+
name|screen
operator|->
name|titlefont
operator|->
name|height
operator|+
literal|3
operator|*
name|TITLEPAD
expr_stmt|;
name|screen
operator|->
name|iconbitmap
operator|.
name|x
operator|=
name|screen
operator|->
name|Ticonbitmap
operator|.
name|x
operator|=
name|screen
operator|->
name|iconbitmap
operator|.
name|y
operator|=
name|screen
operator|->
name|Ticonbitmap
operator|.
name|y
operator|=
name|TITLEPAD
expr_stmt|;
if|if
condition|(
operator|(
name|i
operator|=
name|screen
operator|->
name|bitmapwidth
operator|-
name|w
operator|)
operator|>=
literal|0
condition|)
block|{
name|screen
operator|->
name|iconVwin
operator|.
name|width
operator|=
name|screen
operator|->
name|bitmapwidth
operator|+
literal|2
operator|*
name|TITLEPAD
expr_stmt|;
name|screen
operator|->
name|icon_text_x
operator|+=
name|i
operator|/
literal|2
expr_stmt|;
block|}
else|else
block|{
name|screen
operator|->
name|iconVwin
operator|.
name|width
operator|=
name|w
operator|+
literal|2
operator|*
name|TITLEPAD
expr_stmt|;
name|i
operator|=
operator|(
operator|-
name|i
operator|)
operator|/
literal|2
expr_stmt|;
name|screen
operator|->
name|iconbitmap
operator|.
name|x
operator|+=
name|i
expr_stmt|;
name|screen
operator|->
name|Ticonbitmap
operator|.
name|x
operator|+=
name|i
expr_stmt|;
block|}
block|}
else|else
block|{
name|screen
operator|->
name|icon_text_x
operator|=
name|screen
operator|->
name|bitmapwidth
operator|+
literal|2
operator|*
name|TITLEPAD
expr_stmt|;
name|screen
operator|->
name|icon_text_y
operator|=
name|TITLEPAD
expr_stmt|;
name|screen
operator|->
name|iconVwin
operator|.
name|width
operator|=
name|w
operator|+
name|screen
operator|->
name|bitmapwidth
operator|+
literal|3
operator|*
name|TITLEPAD
expr_stmt|;
name|screen
operator|->
name|iconbitmap
operator|.
name|x
operator|=
name|screen
operator|->
name|Ticonbitmap
operator|.
name|x
operator|=
name|screen
operator|->
name|iconbitmap
operator|.
name|y
operator|=
name|screen
operator|->
name|Ticonbitmap
operator|.
name|y
operator|=
name|TITLEPAD
expr_stmt|;
if|if
condition|(
operator|(
name|i
operator|=
name|screen
operator|->
name|bitmapheight
operator|-
name|screen
operator|->
name|titlefont
operator|->
name|height
operator|)
operator|>=
literal|0
condition|)
block|{
name|screen
operator|->
name|iconVwin
operator|.
name|height
operator|=
name|screen
operator|->
name|bitmapheight
operator|+
literal|2
operator|*
name|TITLEPAD
expr_stmt|;
name|screen
operator|->
name|icon_text_y
operator|+=
name|i
operator|/
literal|2
expr_stmt|;
block|}
else|else
block|{
name|screen
operator|->
name|iconVwin
operator|.
name|height
operator|=
name|screen
operator|->
name|titlefont
operator|->
name|height
operator|+
literal|2
operator|*
name|TITLEPAD
expr_stmt|;
name|i
operator|=
operator|(
operator|-
name|i
operator|)
operator|/
literal|2
expr_stmt|;
name|screen
operator|->
name|iconbitmap
operator|.
name|y
operator|+=
name|i
expr_stmt|;
name|screen
operator|->
name|Ticonbitmap
operator|.
name|y
operator|+=
name|i
expr_stmt|;
block|}
block|}
if|if
condition|(
operator|(
name|i
operator|=
name|screen
operator|->
name|iconbitmap
operator|.
name|width
operator|-
name|screen
operator|->
name|Ticonbitmap
operator|.
name|width
operator|)
operator|>=
literal|0
condition|)
name|screen
operator|->
name|Ticonbitmap
operator|.
name|x
operator|+=
name|i
operator|/
literal|2
expr_stmt|;
else|else
name|screen
operator|->
name|iconbitmap
operator|.
name|x
operator|+=
operator|(
operator|-
name|i
operator|)
operator|/
literal|2
expr_stmt|;
if|if
condition|(
operator|(
name|i
operator|=
name|screen
operator|->
name|iconbitmap
operator|.
name|height
operator|-
name|screen
operator|->
name|Ticonbitmap
operator|.
name|height
operator|)
operator|>=
literal|0
condition|)
name|screen
operator|->
name|Ticonbitmap
operator|.
name|y
operator|+=
name|i
operator|/
literal|2
expr_stmt|;
else|else
name|screen
operator|->
name|iconbitmap
operator|.
name|y
operator|+=
operator|(
operator|-
name|i
operator|)
operator|/
literal|2
expr_stmt|;
block|}
else|else
block|{
name|screen
operator|->
name|icon_text_x
operator|=
name|TITLEPAD
expr_stmt|;
name|screen
operator|->
name|iconVwin
operator|.
name|width
operator|=
name|w
operator|+
literal|2
operator|*
name|TITLEPAD
expr_stmt|;
name|screen
operator|->
name|iconVwin
operator|.
name|height
operator|=
name|screen
operator|->
name|titlefont
operator|->
name|height
operator|+
literal|2
operator|*
name|TITLEPAD
expr_stmt|;
block|}
if|if
condition|(
name|screen
operator|->
name|iconVwin
operator|.
name|window
condition|)
name|XChangeWindow
argument_list|(
name|screen
operator|->
name|iconVwin
operator|.
name|window
argument_list|,
name|screen
operator|->
name|iconVwin
operator|.
name|width
argument_list|,
name|screen
operator|->
name|iconVwin
operator|.
name|height
argument_list|)
expr_stmt|;
if|if
condition|(
name|screen
operator|->
name|iconTwin
operator|.
name|window
condition|)
block|{
name|screen
operator|->
name|iconTwin
operator|.
name|width
operator|=
name|screen
operator|->
name|iconVwin
operator|.
name|width
expr_stmt|;
name|screen
operator|->
name|iconTwin
operator|.
name|height
operator|=
name|screen
operator|->
name|iconVwin
operator|.
name|height
expr_stmt|;
name|XChangeWindow
argument_list|(
name|screen
operator|->
name|iconTwin
operator|.
name|window
argument_list|,
name|screen
operator|->
name|iconTwin
operator|.
name|width
argument_list|,
name|screen
operator|->
name|iconTwin
operator|.
name|height
argument_list|)
expr_stmt|;
block|}
name|icon_box
index|[
literal|0
index|]
operator|.
name|x
operator|=
name|screen
operator|->
name|icon_text_x
operator|-
literal|2
expr_stmt|;
name|icon_box
index|[
literal|0
index|]
operator|.
name|y
operator|=
name|screen
operator|->
name|icon_text_y
operator|-
literal|2
expr_stmt|;
name|icon_box
index|[
literal|3
index|]
operator|.
name|x
operator|=
operator|-
operator|(
name|icon_box
index|[
literal|1
index|]
operator|.
name|x
operator|=
name|w
operator|+
literal|3
operator|)
expr_stmt|;
name|icon_box
index|[
literal|4
index|]
operator|.
name|y
operator|=
operator|-
operator|(
name|icon_box
index|[
literal|2
index|]
operator|.
name|y
operator|=
name|screen
operator|->
name|titlefont
operator|->
name|height
operator|+
literal|3
operator|)
expr_stmt|;
block|}
end_block

begin_expr_stmt
name|RefreshIcon
argument_list|(
name|screen
argument_list|,
name|window
argument_list|)
specifier|register
name|Screen
operator|*
name|screen
expr_stmt|;
end_expr_stmt

begin_decl_stmt
name|Window
name|window
decl_stmt|;
end_decl_stmt

begin_block
block|{
specifier|register
name|BitmapBits
modifier|*
name|bb
decl_stmt|;
specifier|register
name|int
name|fg
decl_stmt|,
name|bg
decl_stmt|;
name|bb
operator|=
name|screen
operator|->
name|TekEmu
condition|?
operator|&
name|screen
operator|->
name|Ticonbitmap
else|:
operator|&
name|screen
operator|->
name|iconbitmap
expr_stmt|;
name|fg
operator|=
name|screen
operator|->
name|foreground
expr_stmt|;
name|bg
operator|=
name|screen
operator|->
name|background
expr_stmt|;
if|if
condition|(
name|screen
operator|->
name|bitmapwidth
operator|>
literal|0
condition|)
name|XBitmapBitsPut
argument_list|(
name|window
argument_list|,
name|bb
operator|->
name|x
argument_list|,
name|bb
operator|->
name|y
argument_list|,
name|bb
operator|->
name|width
argument_list|,
name|bb
operator|->
name|height
argument_list|,
name|bb
operator|->
name|bits
argument_list|,
name|fg
argument_list|,
name|bg
argument_list|,
operator|(
name|Bitmap
operator|)
literal|0
argument_list|,
name|GXcopy
argument_list|,
name|AllPlanes
argument_list|)
expr_stmt|;
name|XText
argument_list|(
name|window
argument_list|,
name|screen
operator|->
name|icon_text_x
argument_list|,
name|screen
operator|->
name|icon_text_y
argument_list|,
name|screen
operator|->
name|winname
argument_list|,
name|screen
operator|->
name|winnamelen
argument_list|,
name|screen
operator|->
name|titlefont
operator|->
name|id
argument_list|,
name|fg
argument_list|,
name|bg
argument_list|)
expr_stmt|;
name|screen
operator|->
name|icon_show
operator|=
name|TRUE
expr_stmt|;
if|if
condition|(
name|screen
operator|->
name|iconinput
condition|)
name|IconBox
argument_list|(
name|screen
argument_list|)
expr_stmt|;
block|}
end_block

begin_expr_stmt
name|IconBox
argument_list|(
name|screen
argument_list|)
specifier|register
name|Screen
operator|*
name|screen
expr_stmt|;
end_expr_stmt

begin_block
block|{
if|if
condition|(
name|screen
operator|->
name|active_icon
condition|)
return|return;
name|XDraw
argument_list|(
name|screen
operator|->
name|TekEmu
condition|?
name|screen
operator|->
name|iconTwin
operator|.
name|window
else|:
name|screen
operator|->
name|iconVwin
operator|.
name|window
argument_list|,
name|icon_box
argument_list|,
name|NBOX
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|,
name|screen
operator|->
name|foreground
argument_list|,
name|GXcopy
argument_list|,
name|AllPlanes
argument_list|)
expr_stmt|;
block|}
end_block

begin_comment
comment|/*  * Move win1's icon window to where win2's icon window is.  */
end_comment

begin_expr_stmt
name|moveiconwindow
argument_list|(
name|win1
argument_list|,
name|win2
argument_list|)
specifier|register
name|Window
name|win1
operator|,
name|win2
expr_stmt|;
end_expr_stmt

begin_block
block|{
name|WindowInfo
name|wininfo1
decl_stmt|,
name|wininfo2
decl_stmt|;
name|XQueryWindow
argument_list|(
name|win1
argument_list|,
operator|&
name|wininfo1
argument_list|)
expr_stmt|;
name|XQueryWindow
argument_list|(
name|win2
argument_list|,
operator|&
name|wininfo2
argument_list|)
expr_stmt|;
if|if
condition|(
name|wininfo1
operator|.
name|assoc_wind
operator|&&
name|wininfo2
operator|.
name|assoc_wind
condition|)
block|{
name|XQueryWindow
argument_list|(
name|wininfo2
operator|.
name|assoc_wind
argument_list|,
operator|&
name|wininfo2
argument_list|)
expr_stmt|;
name|XMoveWindow
argument_list|(
name|wininfo1
operator|.
name|assoc_wind
argument_list|,
name|wininfo2
operator|.
name|x
argument_list|,
name|wininfo2
operator|.
name|y
argument_list|)
expr_stmt|;
block|}
block|}
end_block

begin_expr_stmt
name|IconGeometry
argument_list|(
name|screen
argument_list|,
name|ix
argument_list|,
name|iy
argument_list|)
specifier|register
name|Screen
operator|*
name|screen
expr_stmt|;
end_expr_stmt

begin_decl_stmt
specifier|register
name|int
modifier|*
name|ix
decl_stmt|,
modifier|*
name|iy
decl_stmt|;
end_decl_stmt

begin_block
block|{
specifier|register
name|int
name|i
decl_stmt|;
name|int
name|w
decl_stmt|,
name|h
decl_stmt|;
if|if
condition|(
name|icon_geom
condition|)
block|{
name|i
operator|=
name|XParseGeometry
argument_list|(
name|icon_geom
argument_list|,
name|ix
argument_list|,
name|iy
argument_list|,
operator|&
name|w
argument_list|,
operator|&
name|h
argument_list|)
expr_stmt|;
comment|/* 		 * XParseGeometry returns negative values in addition to 		 * setting the bitmask. 		 */
if|if
condition|(
operator|(
name|i
operator|&
name|XValue
operator|)
operator|&&
operator|(
name|i
operator|&
name|XNegative
operator|)
condition|)
operator|*
name|ix
operator|=
name|DisplayWidth
argument_list|()
operator|+
operator|*
name|ix
operator|-
name|screen
operator|->
name|iconVwin
operator|.
name|width
operator|-
literal|2
operator|*
name|screen
operator|->
name|borderwidth
expr_stmt|;
if|if
condition|(
operator|(
name|i
operator|&
name|YValue
operator|)
operator|&&
operator|(
name|i
operator|&
name|YNegative
operator|)
condition|)
operator|*
name|iy
operator|=
name|DisplayHeight
argument_list|()
operator|+
operator|*
name|iy
operator|-
name|screen
operator|->
name|iconVwin
operator|.
name|height
operator|-
literal|2
operator|*
name|screen
operator|->
name|borderwidth
expr_stmt|;
block|}
block|}
end_block

begin_expr_stmt
name|InTitle
argument_list|(
name|screen
argument_list|,
name|window
argument_list|,
name|x
argument_list|)
specifier|register
name|Screen
operator|*
name|screen
expr_stmt|;
end_expr_stmt

begin_decl_stmt
name|Window
name|window
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|x
decl_stmt|;
end_decl_stmt

begin_block
block|{
specifier|register
name|int
name|i
decl_stmt|,
name|j
decl_stmt|;
if|if
condition|(
name|window
operator|==
name|screen
operator|->
name|title
operator|.
name|tbar
condition|)
block|{
name|i
operator|=
operator|(
name|j
operator|=
name|FullWidth
argument_list|(
name|screen
argument_list|)
operator|/
literal|2
operator|)
operator|-
operator|(
name|screen
operator|->
name|title
operator|.
name|x
operator|-
name|screen
operator|->
name|title_n_size
operator|)
expr_stmt|;
name|j
operator|=
name|x
operator|-
name|j
expr_stmt|;
if|if
condition|(
name|j
operator|<
literal|0
condition|)
name|j
operator|=
operator|-
name|j
expr_stmt|;
if|if
condition|(
name|j
operator|<
name|i
condition|)
block|{
name|XUnmapWindow
argument_list|(
name|VWindow
argument_list|(
name|screen
argument_list|)
argument_list|)
expr_stmt|;
name|XMapWindow
argument_list|(
name|screen
operator|->
name|iconVwin
operator|.
name|window
argument_list|)
expr_stmt|;
return|return
operator|(
name|TRUE
operator|)
return|;
block|}
block|}
else|else
block|{
name|i
operator|=
operator|(
name|j
operator|=
name|TFullWidth
argument_list|(
name|screen
argument_list|)
operator|/
literal|2
operator|)
operator|-
operator|(
name|screen
operator|->
name|Ttitle
operator|.
name|x
operator|-
name|screen
operator|->
name|title_n_size
operator|)
expr_stmt|;
name|j
operator|=
name|x
operator|-
name|j
expr_stmt|;
if|if
condition|(
name|j
operator|<
literal|0
condition|)
name|j
operator|=
operator|-
name|j
expr_stmt|;
if|if
condition|(
name|j
operator|<
name|i
condition|)
block|{
name|XUnmapWindow
argument_list|(
name|TWindow
argument_list|(
name|screen
argument_list|)
argument_list|)
expr_stmt|;
name|XMapWindow
argument_list|(
name|screen
operator|->
name|iconTwin
operator|.
name|window
argument_list|)
expr_stmt|;
return|return
operator|(
name|TRUE
operator|)
return|;
block|}
block|}
return|return
operator|(
name|FALSE
operator|)
return|;
block|}
end_block

begin_expr_stmt
name|SyncUnmap
argument_list|(
name|win
argument_list|,
name|mask
argument_list|)
specifier|register
name|Window
name|win
expr_stmt|;
end_expr_stmt

begin_decl_stmt
specifier|register
name|int
name|mask
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|XEvent
name|ev
decl_stmt|;
specifier|register
name|XEvent
modifier|*
name|rep
init|=
operator|&
name|ev
decl_stmt|;
do|do
block|{
comment|/* ignore events through unmap */
name|XWindowEvent
argument_list|(
name|win
argument_list|,
name|mask
argument_list|,
name|rep
argument_list|)
expr_stmt|;
block|}
do|while
condition|(
name|rep
operator|->
name|type
operator|!=
name|UnmapWindow
condition|)
do|;
block|}
end_block

begin_expr_stmt
name|StartLog
argument_list|(
name|screen
argument_list|)
specifier|register
name|Screen
operator|*
name|screen
expr_stmt|;
end_expr_stmt

begin_block
block|{
specifier|register
name|char
modifier|*
name|cp
decl_stmt|;
specifier|register
name|int
name|i
decl_stmt|;
specifier|static
name|char
modifier|*
name|log_default
decl_stmt|;
name|char
modifier|*
name|malloc
argument_list|()
decl_stmt|,
modifier|*
name|rindex
argument_list|()
decl_stmt|;
extern|extern logpipe(
block|)
end_block

begin_empty_stmt
empty_stmt|;
end_empty_stmt

begin_if
if|if
condition|(
name|screen
operator|->
name|logging
operator|||
operator|(
name|screen
operator|->
name|inhibit
operator|&
name|I_LOG
operator|)
condition|)
return|return;
end_if

begin_if
if|if
condition|(
name|screen
operator|->
name|logfile
operator|==
name|NULL
operator|||
operator|*
name|screen
operator|->
name|logfile
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|screen
operator|->
name|logfile
condition|)
name|free
argument_list|(
name|screen
operator|->
name|logfile
argument_list|)
expr_stmt|;
if|if
condition|(
name|log_default
operator|==
name|NULL
condition|)
name|mktemp
argument_list|(
name|log_default
operator|=
name|log_def_name
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|screen
operator|->
name|logfile
operator|=
name|malloc
argument_list|(
name|strlen
argument_list|(
name|log_default
argument_list|)
operator|+
literal|1
argument_list|)
operator|)
operator|==
name|NULL
condition|)
return|return;
name|strcpy
argument_list|(
name|screen
operator|->
name|logfile
argument_list|,
name|log_default
argument_list|)
expr_stmt|;
block|}
end_if

begin_if
if|if
condition|(
operator|*
name|screen
operator|->
name|logfile
operator|==
literal|'|'
condition|)
block|{
comment|/* exec command */
name|int
name|p
index|[
literal|2
index|]
decl_stmt|;
specifier|static
name|char
modifier|*
name|shell
decl_stmt|;
if|if
condition|(
name|pipe
argument_list|(
name|p
argument_list|)
operator|<
literal|0
operator|||
operator|(
name|i
operator|=
name|fork
argument_list|()
operator|)
operator|<
literal|0
condition|)
return|return;
if|if
condition|(
name|i
operator|==
literal|0
condition|)
block|{
comment|/* child */
name|close
argument_list|(
name|p
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
name|dup2
argument_list|(
name|p
index|[
literal|0
index|]
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|close
argument_list|(
name|p
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
name|dup2
argument_list|(
name|fileno
argument_list|(
name|stderr
argument_list|)
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|dup2
argument_list|(
name|fileno
argument_list|(
name|stderr
argument_list|)
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|close
argument_list|(
name|fileno
argument_list|(
name|stderr
argument_list|)
argument_list|)
expr_stmt|;
name|fileno
argument_list|(
name|stderr
argument_list|)
operator|=
literal|2
expr_stmt|;
name|close
argument_list|(
name|screen
operator|->
name|display
operator|->
name|fd
argument_list|)
expr_stmt|;
name|close
argument_list|(
name|screen
operator|->
name|respond
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|shell
condition|)
block|{
specifier|register
name|struct
name|passwd
modifier|*
name|pw
decl_stmt|;
name|char
modifier|*
name|getenv
argument_list|()
decl_stmt|,
modifier|*
name|malloc
argument_list|()
decl_stmt|;
name|struct
name|passwd
modifier|*
name|getpwuid
parameter_list|()
function_decl|;
if|if
condition|(
operator|(
operator|(
name|cp
operator|=
name|getenv
argument_list|(
literal|"SHELL"
argument_list|)
operator|)
operator|==
name|NULL
operator|||
operator|*
name|cp
operator|==
literal|0
operator|)
operator|&&
operator|(
operator|(
name|pw
operator|=
name|getpwuid
argument_list|(
name|screen
operator|->
name|uid
argument_list|)
operator|)
operator|==
name|NULL
operator|||
operator|*
operator|(
name|cp
operator|=
name|pw
operator|->
name|pw_shell
operator|)
operator|==
literal|0
operator|)
operator|||
operator|(
name|shell
operator|=
name|malloc
argument_list|(
name|strlen
argument_list|(
name|cp
argument_list|)
operator|+
literal|1
argument_list|)
operator|)
operator|==
name|NULL
condition|)
name|shell
operator|=
literal|"/bin/sh"
expr_stmt|;
else|else
name|strcpy
argument_list|(
name|shell
argument_list|,
name|cp
argument_list|)
expr_stmt|;
block|}
name|signal
argument_list|(
name|SIGHUP
argument_list|,
name|SIG_DFL
argument_list|)
expr_stmt|;
name|signal
argument_list|(
name|SIGCHLD
argument_list|,
name|SIG_DFL
argument_list|)
expr_stmt|;
name|setgid
argument_list|(
name|screen
operator|->
name|gid
argument_list|)
expr_stmt|;
name|setuid
argument_list|(
name|screen
operator|->
name|uid
argument_list|)
expr_stmt|;
name|execl
argument_list|(
name|shell
argument_list|,
name|shell
argument_list|,
literal|"-c"
argument_list|,
operator|&
name|screen
operator|->
name|logfile
index|[
literal|1
index|]
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"%s: Can't exec `%s'\n"
argument_list|,
name|xterm_name
argument_list|,
operator|&
name|screen
operator|->
name|logfile
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
name|exit
argument_list|(
name|ERROR_LOGEXEC
argument_list|)
expr_stmt|;
block|}
name|close
argument_list|(
name|p
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
name|screen
operator|->
name|logfd
operator|=
name|p
index|[
literal|1
index|]
expr_stmt|;
name|signal
argument_list|(
name|SIGPIPE
argument_list|,
name|logpipe
argument_list|)
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|access
argument_list|(
name|screen
operator|->
name|logfile
argument_list|,
name|F_OK
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|access
argument_list|(
name|screen
operator|->
name|logfile
argument_list|,
name|W_OK
argument_list|)
operator|<
literal|0
condition|)
return|return;
block|}
elseif|else
if|if
condition|(
name|cp
operator|=
name|rindex
argument_list|(
name|screen
operator|->
name|logfile
argument_list|,
literal|'/'
argument_list|)
condition|)
block|{
operator|*
name|cp
operator|=
literal|0
expr_stmt|;
name|i
operator|=
name|access
argument_list|(
name|screen
operator|->
name|logfile
argument_list|,
name|W_OK
argument_list|)
expr_stmt|;
operator|*
name|cp
operator|=
literal|'/'
expr_stmt|;
if|if
condition|(
name|i
operator|<
literal|0
condition|)
return|return;
block|}
elseif|else
if|if
condition|(
name|access
argument_list|(
literal|"."
argument_list|,
name|W_OK
argument_list|)
operator|<
literal|0
condition|)
return|return;
if|if
condition|(
operator|(
name|screen
operator|->
name|logfd
operator|=
name|open
argument_list|(
name|screen
operator|->
name|logfile
argument_list|,
name|O_WRONLY
operator||
name|O_APPEND
operator||
name|O_CREAT
argument_list|,
literal|0644
argument_list|)
operator|)
operator|<
literal|0
condition|)
return|return;
name|chown
argument_list|(
name|screen
operator|->
name|logfile
argument_list|,
name|screen
operator|->
name|uid
argument_list|,
name|screen
operator|->
name|gid
argument_list|)
expr_stmt|;
block|}
end_if

begin_expr_stmt
name|screen
operator|->
name|logstart
operator|=
name|screen
operator|->
name|TekEmu
condition|?
name|Tbptr
else|:
name|bptr
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|screen
operator|->
name|logging
operator|=
name|TRUE
expr_stmt|;
end_expr_stmt

begin_expr_stmt
unit|}  CloseLog
operator|(
name|screen
operator|)
specifier|register
name|Screen
operator|*
name|screen
expr_stmt|;
end_expr_stmt

begin_block
block|{
if|if
condition|(
operator|!
name|screen
operator|->
name|logging
operator|||
operator|(
name|screen
operator|->
name|inhibit
operator|&
name|I_LOG
operator|)
condition|)
return|return;
name|FlushLog
argument_list|(
name|screen
argument_list|)
expr_stmt|;
name|close
argument_list|(
name|screen
operator|->
name|logfd
argument_list|)
expr_stmt|;
name|screen
operator|->
name|logging
operator|=
name|FALSE
expr_stmt|;
block|}
end_block

begin_expr_stmt
name|FlushLog
argument_list|(
name|screen
argument_list|)
specifier|register
name|Screen
operator|*
name|screen
expr_stmt|;
end_expr_stmt

begin_block
block|{
specifier|register
name|char
modifier|*
name|cp
decl_stmt|;
specifier|register
name|int
name|i
decl_stmt|;
name|cp
operator|=
name|screen
operator|->
name|TekEmu
condition|?
name|Tbptr
else|:
name|bptr
expr_stmt|;
if|if
condition|(
operator|(
name|i
operator|=
name|cp
operator|-
name|screen
operator|->
name|logstart
operator|)
operator|>
literal|0
condition|)
name|write
argument_list|(
name|screen
operator|->
name|logfd
argument_list|,
name|screen
operator|->
name|logstart
argument_list|,
name|i
argument_list|)
expr_stmt|;
name|screen
operator|->
name|logstart
operator|=
name|screen
operator|->
name|TekEmu
condition|?
name|Tbuffer
else|:
name|buffer
expr_stmt|;
block|}
end_block

begin_macro
name|logpipe
argument_list|()
end_macro

begin_block
block|{
specifier|register
name|Screen
modifier|*
name|screen
init|=
operator|&
name|term
operator|.
name|screen
decl_stmt|;
if|if
condition|(
name|screen
operator|->
name|logging
condition|)
name|CloseLog
argument_list|(
name|screen
argument_list|)
expr_stmt|;
block|}
end_block

begin_function_decl
name|do_osc
function_decl|(
name|func
function_decl|)
name|int
argument_list|(
argument|*func
argument_list|)
parameter_list|()
function_decl|;
end_function_decl

begin_block
block|{
specifier|register
name|Screen
modifier|*
name|screen
init|=
operator|&
name|term
operator|.
name|screen
decl_stmt|;
specifier|register
name|int
name|mode
decl_stmt|,
name|c
decl_stmt|;
specifier|register
name|char
modifier|*
name|cp
decl_stmt|;
name|char
name|buf
index|[
literal|512
index|]
decl_stmt|;
specifier|extern
name|char
modifier|*
name|malloc
parameter_list|()
function_decl|;
name|mode
operator|=
literal|0
expr_stmt|;
while|while
condition|(
name|isdigit
argument_list|(
name|c
operator|=
call|(
modifier|*
name|func
call|)
argument_list|()
argument_list|)
condition|)
name|mode
operator|=
literal|10
operator|*
name|mode
operator|+
operator|(
name|c
operator|-
literal|'0'
operator|)
expr_stmt|;
name|cp
operator|=
name|buf
expr_stmt|;
while|while
condition|(
name|isprint
argument_list|(
name|c
operator|=
call|(
modifier|*
name|func
call|)
argument_list|()
argument_list|)
condition|)
operator|*
name|cp
operator|++
operator|=
name|c
expr_stmt|;
operator|*
name|cp
operator|=
literal|0
expr_stmt|;
switch|switch
condition|(
name|mode
condition|)
block|{
case|case
literal|0
case|:
comment|/* new title */
name|Retitle
argument_list|(
name|buf
argument_list|)
expr_stmt|;
break|break;
case|case
literal|46
case|:
comment|/* new log file */
if|if
condition|(
operator|(
name|cp
operator|=
name|malloc
argument_list|(
name|strlen
argument_list|(
name|buf
argument_list|)
operator|+
literal|1
argument_list|)
operator|)
operator|==
name|NULL
condition|)
break|break;
name|strcpy
argument_list|(
name|cp
argument_list|,
name|buf
argument_list|)
expr_stmt|;
if|if
condition|(
name|screen
operator|->
name|logfile
condition|)
name|free
argument_list|(
name|screen
operator|->
name|logfile
argument_list|)
expr_stmt|;
name|screen
operator|->
name|logfile
operator|=
name|cp
expr_stmt|;
break|break;
ifdef|#
directive|ifdef
name|CHANGEFONT
case|case
literal|47
case|:
comment|/* new screen font */
if|if
condition|(
name|VTChangeFont
argument_list|(
name|screen
argument_list|,
name|buf
argument_list|)
condition|)
block|{
name|XChangeWindow
argument_list|(
name|VWindow
argument_list|(
name|screen
argument_list|)
argument_list|,
name|FontWidth
argument_list|(
name|screen
argument_list|)
operator|*
operator|(
name|screen
operator|->
name|max_col
operator|+
literal|1
operator|)
operator|+
literal|2
operator|*
name|screen
operator|->
name|border
operator|+
name|screen
operator|->
name|scrollbar
argument_list|,
name|FontHeight
argument_list|(
name|screen
argument_list|)
operator|*
operator|(
name|screen
operator|->
name|max_row
operator|+
literal|1
operator|)
operator|+
name|screen
operator|->
name|statusheight
operator|+
name|Titlebar
argument_list|(
name|screen
argument_list|)
operator|+
literal|2
operator|*
name|screen
operator|->
name|border
argument_list|)
expr_stmt|;
name|XSync
argument_list|(
name|FALSE
argument_list|)
expr_stmt|;
comment|/* synchronize */
if|if
condition|(
name|QLength
argument_list|()
operator|>
literal|0
condition|)
name|xevents
argument_list|()
expr_stmt|;
block|}
break|break;
block|}
endif|#
directive|endif
block|}
end_block

begin_expr_stmt
name|Retitle
argument_list|(
name|name
argument_list|)
specifier|register
name|char
operator|*
name|name
expr_stmt|;
end_expr_stmt

begin_block
block|{
specifier|register
name|Screen
modifier|*
name|screen
init|=
operator|&
name|term
operator|.
name|screen
decl_stmt|;
specifier|register
name|int
name|w
decl_stmt|,
name|i
decl_stmt|,
name|j
decl_stmt|;
name|char
name|icon
index|[
literal|512
index|]
decl_stmt|;
name|free
argument_list|(
name|screen
operator|->
name|winname
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|screen
operator|->
name|winname
operator|=
name|malloc
argument_list|(
operator|(
name|screen
operator|->
name|winnamelen
operator|=
name|strlen
argument_list|(
name|name
argument_list|)
operator|)
operator|+
literal|1
argument_list|)
operator|)
operator|==
name|NULL
condition|)
name|Error
argument_list|(
name|ERROR_RTMALLOC1
argument_list|)
expr_stmt|;
name|strcpy
argument_list|(
name|screen
operator|->
name|winname
argument_list|,
name|name
argument_list|)
expr_stmt|;
name|strcpy
argument_list|(
name|icon
argument_list|,
name|name
argument_list|)
expr_stmt|;
name|strcat
argument_list|(
name|icon
argument_list|,
literal|" (icon)"
argument_list|)
expr_stmt|;
name|IconRecalc
argument_list|(
name|screen
argument_list|)
expr_stmt|;
if|if
condition|(
name|screen
operator|->
name|fullVwin
operator|.
name|window
condition|)
block|{
name|XStoreName
argument_list|(
name|screen
operator|->
name|fullVwin
operator|.
name|window
argument_list|,
name|name
argument_list|)
expr_stmt|;
name|XStoreName
argument_list|(
name|screen
operator|->
name|iconVwin
operator|.
name|window
argument_list|,
name|icon
argument_list|)
expr_stmt|;
name|XChangeWindow
argument_list|(
name|screen
operator|->
name|iconVwin
operator|.
name|window
argument_list|,
name|screen
operator|->
name|iconVwin
operator|.
name|width
argument_list|,
name|screen
operator|->
name|iconVwin
operator|.
name|height
argument_list|)
expr_stmt|;
if|if
condition|(
name|screen
operator|->
name|title
operator|.
name|tbar
condition|)
block|{
name|w
operator|=
name|FullWidth
argument_list|(
name|screen
argument_list|)
expr_stmt|;
name|screen
operator|->
name|title
operator|.
name|fullwidth
operator|=
name|XQueryWidth
argument_list|(
name|name
argument_list|,
name|screen
operator|->
name|titlefont
operator|->
name|id
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|screen
operator|->
name|title
operator|.
name|width
operator|=
name|i
operator|=
name|screen
operator|->
name|title
operator|.
name|fullwidth
operator|)
operator|>
operator|(
name|j
operator|=
name|w
operator|-
literal|2
operator|*
operator|(
name|MINHILITE
operator|+
name|screen
operator|->
name|title_n_size
operator|+
literal|1
operator|)
operator|)
condition|)
name|screen
operator|->
name|title
operator|.
name|width
operator|=
operator|(
name|i
operator|=
name|j
operator|)
operator|+
name|screen
operator|->
name|title_n_size
expr_stmt|;
name|j
operator|=
name|w
operator|-
name|i
operator|-
literal|2
operator|*
operator|(
name|screen
operator|->
name|title_n_size
operator|+
literal|1
operator|)
expr_stmt|;
name|i
operator|=
name|j
operator|/
literal|2
expr_stmt|;
name|j
operator|-=
name|i
expr_stmt|;
name|screen
operator|->
name|title
operator|.
name|x
operator|=
name|i
operator|+
literal|1
operator|+
name|screen
operator|->
name|title_n_size
expr_stmt|;
name|screen
operator|->
name|title
operator|.
name|y
operator|=
name|TITLEPAD
expr_stmt|;
name|XClear
argument_list|(
name|screen
operator|->
name|title
operator|.
name|tbar
argument_list|)
expr_stmt|;
name|XChangeWindow
argument_list|(
name|screen
operator|->
name|title
operator|.
name|left
argument_list|,
name|i
argument_list|,
name|screen
operator|->
name|titlefont
operator|->
name|height
argument_list|)
expr_stmt|;
name|XConfigureWindow
argument_list|(
name|screen
operator|->
name|title
operator|.
name|right
argument_list|,
name|w
operator|-
name|j
operator|-
literal|1
argument_list|,
name|TITLEPAD
argument_list|,
name|j
argument_list|,
name|screen
operator|->
name|titlefont
operator|->
name|height
argument_list|)
expr_stmt|;
name|VTTitleExpose
argument_list|(
operator|(
name|XExposeWindowEvent
operator|*
operator|)
name|NULL
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
name|screen
operator|->
name|fullTwin
operator|.
name|window
condition|)
block|{
name|free
argument_list|(
name|screen
operator|->
name|Twinname
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|screen
operator|->
name|Twinname
operator|=
name|malloc
argument_list|(
operator|(
name|screen
operator|->
name|Twinnamelen
operator|=
name|screen
operator|->
name|winnamelen
operator|+
literal|6
operator|)
operator|+
literal|1
argument_list|)
operator|)
operator|==
name|NULL
condition|)
name|Error
argument_list|(
name|ERROR_RTMALLOC2
argument_list|)
expr_stmt|;
name|strcpy
argument_list|(
name|screen
operator|->
name|Twinname
argument_list|,
name|name
argument_list|)
expr_stmt|;
name|strcat
argument_list|(
name|screen
operator|->
name|Twinname
argument_list|,
literal|" (Tek)"
argument_list|)
expr_stmt|;
name|XStoreName
argument_list|(
name|screen
operator|->
name|fullTwin
operator|.
name|window
argument_list|,
name|screen
operator|->
name|Twinname
argument_list|)
expr_stmt|;
name|XStoreName
argument_list|(
name|screen
operator|->
name|iconTwin
operator|.
name|window
argument_list|,
name|icon
argument_list|)
expr_stmt|;
name|XChangeWindow
argument_list|(
name|screen
operator|->
name|iconTwin
operator|.
name|window
argument_list|,
name|screen
operator|->
name|iconTwin
operator|.
name|width
argument_list|,
name|screen
operator|->
name|iconTwin
operator|.
name|height
argument_list|)
expr_stmt|;
if|if
condition|(
name|screen
operator|->
name|Ttitle
operator|.
name|tbar
condition|)
block|{
name|w
operator|=
name|TFullWidth
argument_list|(
name|screen
argument_list|)
expr_stmt|;
name|screen
operator|->
name|Ttitle
operator|.
name|fullwidth
operator|=
name|XQueryWidth
argument_list|(
name|screen
operator|->
name|Twinname
argument_list|,
name|screen
operator|->
name|titlefont
operator|->
name|id
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|screen
operator|->
name|Ttitle
operator|.
name|width
operator|=
name|i
operator|=
name|screen
operator|->
name|Ttitle
operator|.
name|fullwidth
operator|)
operator|>
operator|(
name|j
operator|=
name|w
operator|-
literal|2
operator|*
operator|(
name|MINHILITE
operator|+
name|screen
operator|->
name|title_n_size
operator|+
literal|1
operator|)
operator|)
condition|)
name|screen
operator|->
name|Ttitle
operator|.
name|width
operator|=
operator|(
name|i
operator|=
name|j
operator|)
operator|+
name|screen
operator|->
name|title_n_size
expr_stmt|;
name|j
operator|=
name|w
operator|-
name|i
operator|-
literal|2
operator|*
operator|(
name|screen
operator|->
name|title_n_size
operator|+
literal|1
operator|)
expr_stmt|;
name|i
operator|=
name|j
operator|/
literal|2
expr_stmt|;
name|j
operator|-=
name|i
expr_stmt|;
name|screen
operator|->
name|Ttitle
operator|.
name|x
operator|=
name|i
operator|+
literal|1
operator|+
name|screen
operator|->
name|title_n_size
expr_stmt|;
name|screen
operator|->
name|Ttitle
operator|.
name|y
operator|=
name|TITLEPAD
expr_stmt|;
name|XClear
argument_list|(
name|screen
operator|->
name|Ttitle
operator|.
name|tbar
argument_list|)
expr_stmt|;
name|XChangeWindow
argument_list|(
name|screen
operator|->
name|Ttitle
operator|.
name|left
argument_list|,
name|i
argument_list|,
name|screen
operator|->
name|titlefont
operator|->
name|height
argument_list|)
expr_stmt|;
name|XConfigureWindow
argument_list|(
name|screen
operator|->
name|Ttitle
operator|.
name|right
argument_list|,
name|w
operator|-
name|j
operator|-
literal|1
argument_list|,
name|TITLEPAD
argument_list|,
name|j
argument_list|,
name|screen
operator|->
name|titlefont
operator|->
name|height
argument_list|)
expr_stmt|;
name|TekTitleExpose
argument_list|(
operator|(
name|XExposeWindowEvent
operator|*
operator|)
name|NULL
argument_list|)
expr_stmt|;
block|}
block|}
block|}
end_block

begin_macro
name|Panic
argument_list|(
argument|s
argument_list|,
argument|a
argument_list|)
end_macro

begin_decl_stmt
name|char
modifier|*
name|s
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|a
decl_stmt|;
end_decl_stmt

begin_block
block|{
ifdef|#
directive|ifdef
name|DEBUG
if|if
condition|(
name|debug
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"%s: PANIC!	"
argument_list|,
name|xterm_name
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
name|s
argument_list|,
name|a
argument_list|)
expr_stmt|;
name|fputs
argument_list|(
literal|"\r\n"
argument_list|,
name|stderr
argument_list|)
expr_stmt|;
name|fflush
argument_list|(
name|stderr
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
endif|DEBUG
block|}
end_block

begin_macro
name|SysError
argument_list|(
argument|i
argument_list|)
end_macro

begin_decl_stmt
name|int
name|i
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"%s: Error %d, errno %d:"
argument_list|,
name|xterm_name
argument_list|,
name|i
argument_list|,
name|errno
argument_list|)
expr_stmt|;
name|perror
argument_list|(
literal|""
argument_list|)
expr_stmt|;
name|Cleanup
argument_list|(
name|i
argument_list|)
expr_stmt|;
block|}
end_block

begin_macro
name|Error
argument_list|(
argument|i
argument_list|)
end_macro

begin_decl_stmt
name|int
name|i
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"%s: Error %d\n"
argument_list|,
name|xterm_name
argument_list|,
name|i
argument_list|)
expr_stmt|;
name|Cleanup
argument_list|(
name|i
argument_list|)
expr_stmt|;
block|}
end_block

begin_comment
comment|/*  * cleanup by sending SIGHUP to client processes  */
end_comment

begin_macro
name|Cleanup
argument_list|(
argument|code
argument_list|)
end_macro

begin_decl_stmt
name|int
name|code
decl_stmt|;
end_decl_stmt

begin_block
block|{
ifdef|#
directive|ifdef
name|notdef
specifier|extern
name|Terminal
name|term
decl_stmt|;
specifier|register
name|Screen
modifier|*
name|screen
decl_stmt|;
name|screen
operator|=
operator|&
name|term
operator|.
name|screen
expr_stmt|;
if|if
condition|(
name|screen
operator|->
name|pid
operator|>
literal|1
condition|)
name|killpg
argument_list|(
name|getpgrp
argument_list|(
name|screen
operator|->
name|pid
argument_list|)
argument_list|,
name|SIGHUP
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|Exit
argument_list|(
name|code
argument_list|)
expr_stmt|;
block|}
end_block

begin_comment
comment|/*  * sets the value of var to be arg in the Unix 4.2 BSD environment env.  * Var should end with '=' (bindings are of the form "var=value").  * This procedure assumes the memory for the first level of environ  * was allocated using calloc, with enough extra room at the end so not  * to have to do a realloc().  */
end_comment

begin_expr_stmt
name|Setenv
argument_list|(
name|var
argument_list|,
name|value
argument_list|)
specifier|register
name|char
operator|*
name|var
operator|,
operator|*
name|value
expr_stmt|;
end_expr_stmt

begin_block
block|{
specifier|extern
name|char
modifier|*
modifier|*
name|environ
decl_stmt|;
specifier|register
name|int
name|index
init|=
literal|0
decl_stmt|;
specifier|register
name|int
name|len
init|=
name|strlen
argument_list|(
name|var
argument_list|)
decl_stmt|;
while|while
condition|(
name|environ
index|[
name|index
index|]
operator|!=
name|NULL
condition|)
block|{
if|if
condition|(
name|strncmp
argument_list|(
name|environ
index|[
name|index
index|]
argument_list|,
name|var
argument_list|,
name|len
argument_list|)
operator|==
literal|0
condition|)
block|{
comment|/* found it */
name|environ
index|[
name|index
index|]
operator|=
operator|(
name|char
operator|*
operator|)
name|malloc
argument_list|(
name|len
operator|+
name|strlen
argument_list|(
name|value
argument_list|)
operator|+
literal|1
argument_list|)
expr_stmt|;
name|strcpy
argument_list|(
name|environ
index|[
name|index
index|]
argument_list|,
name|var
argument_list|)
expr_stmt|;
name|strcat
argument_list|(
name|environ
index|[
name|index
index|]
argument_list|,
name|value
argument_list|)
expr_stmt|;
return|return;
block|}
name|index
operator|++
expr_stmt|;
block|}
ifdef|#
directive|ifdef
name|DEBUG
if|if
condition|(
name|debug
condition|)
name|fputs
argument_list|(
literal|"expanding env\n"
argument_list|,
name|stderr
argument_list|)
expr_stmt|;
endif|#
directive|endif
endif|DEBUG
name|environ
index|[
name|index
index|]
operator|=
operator|(
name|char
operator|*
operator|)
name|malloc
argument_list|(
name|len
operator|+
name|strlen
argument_list|(
name|value
argument_list|)
operator|+
literal|1
argument_list|)
expr_stmt|;
name|strcpy
argument_list|(
name|environ
index|[
name|index
index|]
argument_list|,
name|var
argument_list|)
expr_stmt|;
name|strcat
argument_list|(
name|environ
index|[
name|index
index|]
argument_list|,
name|value
argument_list|)
expr_stmt|;
name|environ
index|[
operator|++
name|index
index|]
operator|=
name|NULL
expr_stmt|;
block|}
end_block

begin_comment
comment|/*  * returns a pointer to the first occurrence of s2 in s1,  * or NULL if there are none.  */
end_comment

begin_function
name|char
modifier|*
name|strindex
parameter_list|(
name|s1
parameter_list|,
name|s2
parameter_list|)
specifier|register
name|char
modifier|*
name|s1
decl_stmt|,
decl|*
name|s2
decl_stmt|;
end_function

begin_block
block|{
specifier|register
name|char
modifier|*
name|s3
decl_stmt|;
name|char
modifier|*
name|index
parameter_list|()
function_decl|;
while|while
condition|(
operator|(
name|s3
operator|=
name|index
argument_list|(
name|s1
argument_list|,
operator|*
name|s2
argument_list|)
operator|)
operator|!=
name|NULL
condition|)
block|{
if|if
condition|(
name|strncmp
argument_list|(
name|s3
argument_list|,
name|s2
argument_list|,
name|strlen
argument_list|(
name|s2
argument_list|)
argument_list|)
operator|==
literal|0
condition|)
return|return
operator|(
name|s3
operator|)
return|;
name|s1
operator|=
operator|++
name|s3
expr_stmt|;
block|}
return|return
operator|(
name|NULL
operator|)
return|;
block|}
end_block

begin_macro
name|xerror
argument_list|(
argument|d
argument_list|,
argument|ev
argument_list|)
end_macro

begin_decl_stmt
name|Display
modifier|*
name|d
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|register
name|XErrorEvent
modifier|*
name|ev
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"%s: %s\n"
argument_list|,
name|xterm_name
argument_list|,
name|XErrDescrip
argument_list|(
name|ev
operator|->
name|error_code
argument_list|)
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Request code %d, func %d, serial #%ld, window %ld\n"
argument_list|,
name|ev
operator|->
name|request_code
argument_list|,
name|ev
operator|->
name|func
argument_list|,
name|ev
operator|->
name|serial
argument_list|,
operator|(
name|long
operator|)
name|ev
operator|->
name|window
argument_list|)
expr_stmt|;
name|Exit
argument_list|(
name|ERROR_XERROR
argument_list|)
expr_stmt|;
block|}
end_block

begin_macro
name|xioerror
argument_list|(
argument|d
argument_list|)
end_macro

begin_decl_stmt
name|Display
modifier|*
name|d
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|perror
argument_list|(
name|xterm_name
argument_list|)
expr_stmt|;
name|Exit
argument_list|(
name|ERROR_XIOERROR
argument_list|)
expr_stmt|;
block|}
end_block

end_unit


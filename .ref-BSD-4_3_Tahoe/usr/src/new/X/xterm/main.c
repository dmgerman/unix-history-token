begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  *	@(#)main.c	1.15 (Berkeley/CSRG) 5/31/88  *	$Source: /u1/X/xterm/RCS/main.c,v $  *	$Header: main.c,v 10.101 86/12/01 16:58:10 swick Rel $  */
end_comment

begin_include
include|#
directive|include
file|<X/mit-copyright.h>
end_include

begin_comment
comment|/* Copyright    Massachusetts Institute of Technology    1984, 1985	*/
end_comment

begin_comment
comment|/* main.c */
end_comment

begin_ifndef
ifndef|#
directive|ifndef
name|lint
end_ifndef

begin_decl_stmt
specifier|static
name|char
name|csrg_id
index|[]
init|=
literal|"@(#)main.c	1.15\t(Berkeley/CSRG)\t5/31/88"
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|char
name|sccs_id
index|[]
init|=
literal|"@(#)main.c\tX10/6.6B\t12/28/86"
decl_stmt|;
end_decl_stmt

begin_endif
endif|#
directive|endif
endif|lint
end_endif

begin_include
include|#
directive|include
file|<sys/param.h>
end_include

begin_comment
comment|/* for NOFILE */
end_comment

begin_include
include|#
directive|include
file|<pwd.h>
end_include

begin_include
include|#
directive|include
file|<grp.h>
end_include

begin_include
include|#
directive|include
file|<sgtty.h>
end_include

begin_include
include|#
directive|include
file|<sys/wait.h>
end_include

begin_include
include|#
directive|include
file|<sys/time.h>
end_include

begin_include
include|#
directive|include
file|<sys/resource.h>
end_include

begin_include
include|#
directive|include
file|<sys/socket.h>
end_include

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_include
include|#
directive|include
file|<sys/file.h>
end_include

begin_include
include|#
directive|include
file|<errno.h>
end_include

begin_include
include|#
directive|include
file|<signal.h>
end_include

begin_include
include|#
directive|include
file|<strings.h>
end_include

begin_include
include|#
directive|include
file|<setjmp.h>
end_include

begin_include
include|#
directive|include
file|<utmp.h>
end_include

begin_include
include|#
directive|include
file|<X/Xlib.h>
end_include

begin_include
include|#
directive|include
file|"scrollbar.h"
end_include

begin_include
include|#
directive|include
file|"ptyx.h"
end_include

begin_include
include|#
directive|include
file|"data.h"
end_include

begin_include
include|#
directive|include
file|"error.h"
end_include

begin_include
include|#
directive|include
file|"main.h"
end_include

begin_decl_stmt
name|int
name|switchfb
index|[]
init|=
block|{
literal|0
block|,
literal|2
block|,
literal|1
block|,
literal|3
block|}
decl_stmt|;
end_decl_stmt

begin_function_decl
specifier|static
name|int
name|reapchild
parameter_list|()
function_decl|;
end_function_decl

begin_decl_stmt
specifier|static
name|char
modifier|*
name|brdr_color
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|char
modifier|*
modifier|*
name|command_to_exec
decl_stmt|;
end_decl_stmt

begin_ifdef
ifdef|#
directive|ifdef
name|TIOCCONS
end_ifdef

begin_decl_stmt
specifier|static
name|int
name|Console
decl_stmt|;
end_decl_stmt

begin_endif
endif|#
directive|endif
endif|TIOCCONS
end_endif

begin_decl_stmt
specifier|static
name|struct
name|sgttyb
name|d_sg
init|=
block|{
literal|0
block|,
literal|0
block|,
literal|0177
block|,
name|CKILL
block|,
name|EVENP
operator||
name|ODDP
operator||
name|ECHO
operator||
name|XTABS
operator||
name|CRMOD
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|struct
name|tchars
name|d_tc
init|=
block|{
name|CINTR
block|,
name|CQUIT
block|,
name|CSTART
block|,
name|CSTOP
block|,
name|CEOF
block|,
name|CBRK
block|, }
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|struct
name|ltchars
name|d_ltc
init|=
block|{
name|CSUSP
block|,
name|CDSUSP
block|,
name|CRPRNT
block|,
name|CFLUSH
block|,
name|CWERASE
block|,
name|CLNEXT
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|d_disipline
init|=
name|NTTYDISC
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|d_lmode
init|=
name|LCRTBS
operator||
name|LCRTERA
operator||
name|LCRTKIL
operator||
name|LCTLECH
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|char
name|def_bold_font
index|[]
init|=
name|DEFBOLDFONT
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|char
name|def_font
index|[]
init|=
name|DEFFONT
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|char
name|def_title_font
index|[]
init|=
name|DEFTITLEFONT
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|char
name|def_icon_font
index|[]
init|=
name|DEFICONFONT
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|char
name|display
index|[
literal|256
index|]
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|char
name|etc_utmp
index|[]
init|=
literal|"/etc/utmp"
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|char
modifier|*
name|get_ty
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|char
modifier|*
name|iconbitmap
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|inhibit
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|log_on
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|login_shell
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|char
name|passedPty
index|[
literal|2
index|]
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* name if pty if slave */
end_comment

begin_decl_stmt
specifier|static
name|int
name|loginpty
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|char
modifier|*
name|tekiconbitmap
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|tslot
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|char
modifier|*
name|xdef
index|[]
init|=
block|{
literal|"ActiveIcon"
block|,
comment|/* DEF_ACTIVEICON */
literal|"AllowIconInput"
block|,
comment|/* DEF_ALLOWICONINPUT */
literal|"AutoRaise"
block|,
comment|/* DEF_AUTORAISE */
literal|"Background"
block|,
comment|/* DEF_BACKGROUND */
literal|"BodyFont"
block|,
comment|/* DEF_BODYFONT */
literal|"BoldFont"
block|,
comment|/* DEF_BOLDFONT */
literal|"Border"
block|,
comment|/* DEF_BORDER */
literal|"BorderWidth"
block|,
comment|/* DEF_BORDERWIDTH */
literal|"C132"
block|,
comment|/* DEF_C132 */
literal|"Curses"
block|,
comment|/* DEF_CURSES */
literal|"Cursor"
block|,
comment|/* DEF_CURSOR */
literal|"cursorShape"
block|,
comment|/* DEF_CURSORSHAPE */
literal|"DeiconifyWarp"
block|,
comment|/* DEF_DEICONWARP */
literal|"Foreground"
block|,
comment|/* DEF_FOREGROUND */
literal|"GrayBorder"
block|,
comment|/* DEF_GRAYBORDER */
literal|"IconBitmap"
block|,
comment|/* DEF_ICONBITMAP */
literal|"IconFont"
block|,
comment|/* DEF_ICONFONT */
literal|"IconStartup"
block|,
comment|/* DEF_ICONSTARTUP */
literal|"InternalBorder"
block|,
comment|/* DEF_INTERNALBORDER */
literal|"JumpScroll"
block|,
comment|/* DEF_JUMPSCROLL */
ifdef|#
directive|ifdef
name|KEYBD
literal|"KeyBoard"
block|,
comment|/* DEF_KEYBOARD */
endif|#
directive|endif
endif|KEYBD
literal|"LogFile"
block|,
comment|/* DEF_LOGFILE */
literal|"Logging"
block|,
comment|/* DEF_LOGGING */
literal|"LogInhibit"
block|,
comment|/* DEF_LOGINHIBIT */
literal|"LoginShell"
block|,
comment|/* DEF_LOGINSHELL */
literal|"MarginBell"
block|,
comment|/* DEF_MARGINBELL */
literal|"Mouse"
block|,
comment|/* DEF_MOUSE */
literal|"NMarginBell"
block|,
comment|/* DEF_NMARGINBELL */
literal|"PageOverlap"
block|,
comment|/* DEF_PAGEOVERLAP */
literal|"PageScroll"
block|,
comment|/* DEF_PAGESCROLL */
literal|"ReverseVideo"
block|,
comment|/* DEF_REVERSEVIDEO */
literal|"ReverseWrap"
block|,
comment|/* DEF_REVERSEWRAP */
literal|"SaveLines"
block|,
comment|/* DEF_SAVELINES */
literal|"ScrollBar"
block|,
comment|/* DEF_SCROLLBAR */
literal|"ScrollInput"
block|,
comment|/* DEF_SCROLLINPUT */
literal|"ScrollKey"
block|,
comment|/* DEF_SCROLLKEY */
literal|"SignalInhibit"
block|,
comment|/* DEF_SIGNALINHIBIT */
literal|"StatusLine"
block|,
comment|/* DEF_STATUSLINE */
literal|"StatusNormal"
block|,
comment|/* DEF_STATUSNORMAL */
literal|"TekIconBitmap"
block|,
comment|/* DEF_TEKICONBITMAP */
literal|"TekInhibit"
block|,
comment|/* DEF_TEKINHIBIT */
literal|"TextUnderIcon"
block|,
comment|/* DEF_TEXTUNDERICON */
literal|"TitleBar"
block|,
comment|/* DEF_TITLEBAR */
literal|"TitleFont"
block|,
comment|/* DEF_TITLEFONT */
literal|"VisualBell"
block|,
comment|/* DEF_VISUALBELL */
literal|"VisBellDelay"
block|,
comment|/* DEF_VISBELLDELAY */
literal|"AudibleBell"
block|,
comment|/* DEF_AUDIBLEBELL */
literal|"DropMenu"
block|,
comment|/* DEF_DROPMENU	*/
literal|"UniqueSuffix"
block|,
comment|/* DEF_UNIQUESUFFIX */
ifdef|#
directive|ifdef
name|ALLOWUNSHIFTEDSELECTION
literal|"UnshiftedSelection"
block|,
comment|/* DEF_UNSHIFTEDSELECTION */
endif|#
directive|endif
literal|0
block|, }
decl_stmt|;
end_decl_stmt

begin_ifdef
ifdef|#
directive|ifdef
name|UTMP
end_ifdef

begin_decl_stmt
specifier|static
name|int
name|added_utmp_entry
decl_stmt|;
end_decl_stmt

begin_endif
endif|#
directive|endif
endif|UTMP
end_endif

begin_function
name|main
parameter_list|(
name|argc
parameter_list|,
name|argv
parameter_list|)
name|int
name|argc
decl_stmt|;
name|char
modifier|*
modifier|*
name|argv
decl_stmt|;
block|{
specifier|register
name|Screen
modifier|*
name|screen
init|=
operator|&
name|term
operator|.
name|screen
decl_stmt|;
specifier|register
name|char
modifier|*
name|strind
decl_stmt|;
specifier|register
name|int
name|i
decl_stmt|,
name|pty
decl_stmt|;
specifier|register
name|char
modifier|*
modifier|*
name|cp
decl_stmt|;
name|short
name|fnflag
init|=
literal|0
decl_stmt|;
comment|/* True iff -fn option used */
name|short
name|fbflag
init|=
literal|0
decl_stmt|;
comment|/* True iff -fb option used */
name|int
name|Xsocket
decl_stmt|,
name|mode
decl_stmt|;
extern|extern onalarm(
block|)
function|;
end_function

begin_function_decl
name|char
modifier|*
name|malloc
parameter_list|()
function_decl|;
end_function_decl

begin_function_decl
name|char
modifier|*
name|basename
parameter_list|()
function_decl|;
end_function_decl

begin_decl_stmt
name|int
name|xerror
argument_list|()
decl_stmt|,
name|xioerror
argument_list|()
decl_stmt|;
end_decl_stmt

begin_ifdef
ifdef|#
directive|ifdef
name|KEYBD
end_ifdef

begin_decl_stmt
specifier|extern
name|char
modifier|*
name|keyboardtype
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* used in XKeyBind.c */
end_comment

begin_function_decl
name|char
modifier|*
name|getenv
parameter_list|()
function_decl|;
end_function_decl

begin_endif
endif|#
directive|endif
endif|KEYBD
end_endif

begin_expr_stmt
name|xterm_name
operator|=
operator|(
name|strcmp
argument_list|(
operator|*
name|argv
argument_list|,
literal|"-"
argument_list|)
operator|==
literal|0
operator|)
condition|?
literal|"xterm"
else|:
name|basename
argument_list|(
operator|*
name|argv
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|term
operator|.
name|flags
operator|=
name|WRAPAROUND
operator||
name|SMOOTHSCROLL
operator||
name|AUTOREPEAT
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|screen
operator|->
name|border
operator|=
name|DEFBORDER
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|screen
operator|->
name|borderwidth
operator|=
name|DEFBORDERWIDTH
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|screen
operator|->
name|reversestatus
operator|=
name|TRUE
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|screen
operator|->
name|mappedVwin
operator|=
operator|&
name|screen
operator|->
name|fullVwin
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|screen
operator|->
name|mappedTwin
operator|=
operator|&
name|screen
operator|->
name|fullTwin
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|screen
operator|->
name|audiblebell
operator|=
name|TRUE
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|screen
operator|->
name|visbelldelay
operator|=
name|VISBELLDELAY
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|f_b
operator|=
name|def_bold_font
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|f_n
operator|=
name|def_font
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|f_t
operator|=
name|def_title_font
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|f_i
operator|=
name|def_icon_font
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|display
index|[
literal|0
index|]
operator|=
literal|'\0'
expr_stmt|;
end_expr_stmt

begin_ifdef
ifdef|#
directive|ifdef
name|KEYBD
end_ifdef

begin_if
if|if
condition|(
operator|(
name|strind
operator|=
name|getenv
argument_list|(
literal|"KEYBD"
argument_list|)
operator|)
operator|&&
operator|*
name|strind
condition|)
block|{
if|if
condition|(
operator|(
name|keyboardtype
operator|=
name|malloc
argument_list|(
name|strlen
argument_list|(
name|strind
argument_list|)
operator|+
literal|1
argument_list|)
operator|)
operator|==
name|NULL
condition|)
name|SysError
argument_list|(
name|ERROR_KMALLOC
argument_list|)
expr_stmt|;
name|strcpy
argument_list|(
name|keyboardtype
argument_list|,
name|strind
argument_list|)
expr_stmt|;
block|}
end_if

begin_endif
endif|#
directive|endif
endif|KEYBD
end_endif

begin_comment
comment|/* 	 * go get options out of default file 	 */
end_comment

begin_for
for|for
control|(
name|i
operator|=
literal|0
operator|,
name|cp
operator|=
name|xdef
init|;
operator|*
name|cp
condition|;
name|i
operator|++
operator|,
name|cp
operator|++
control|)
block|{
if|if
condition|(
operator|!
operator|(
name|strind
operator|=
name|XGetDefault
argument_list|(
name|xterm_name
argument_list|,
operator|*
name|cp
argument_list|)
operator|)
condition|)
continue|continue;
switch|switch
condition|(
name|i
condition|)
block|{
case|case
name|DEF_ACTIVEICON
case|:
if|if
condition|(
name|strcmp
argument_list|(
name|strind
argument_list|,
literal|"on"
argument_list|)
operator|==
literal|0
condition|)
name|screen
operator|->
name|active_icon
operator|=
name|TRUE
expr_stmt|;
continue|continue;
case|case
name|DEF_ALLOWICONINPUT
case|:
if|if
condition|(
name|strcmp
argument_list|(
name|strind
argument_list|,
literal|"on"
argument_list|)
operator|==
literal|0
condition|)
name|term
operator|.
name|flags
operator||=
name|ICONINPUT
expr_stmt|;
continue|continue;
case|case
name|DEF_AUTORAISE
case|:
if|if
condition|(
name|strcmp
argument_list|(
name|strind
argument_list|,
literal|"on"
argument_list|)
operator|==
literal|0
condition|)
name|screen
operator|->
name|autoraise
operator|=
name|TRUE
expr_stmt|;
continue|continue;
case|case
name|DEF_BACKGROUND
case|:
name|back_color
operator|=
name|strind
expr_stmt|;
continue|continue;
case|case
name|DEF_BODYFONT
case|:
name|f_n
operator|=
name|strind
expr_stmt|;
name|fnflag
operator|=
name|TRUE
expr_stmt|;
continue|continue;
case|case
name|DEF_BOLDFONT
case|:
name|f_b
operator|=
name|strind
expr_stmt|;
name|fbflag
operator|=
name|TRUE
expr_stmt|;
continue|continue;
case|case
name|DEF_BORDER
case|:
name|brdr_color
operator|=
name|strind
expr_stmt|;
continue|continue;
case|case
name|DEF_BORDERWIDTH
case|:
name|screen
operator|->
name|borderwidth
operator|=
name|atoi
argument_list|(
name|strind
argument_list|)
expr_stmt|;
continue|continue;
case|case
name|DEF_C132
case|:
if|if
condition|(
name|strcmp
argument_list|(
name|strind
argument_list|,
literal|"on"
argument_list|)
operator|==
literal|0
condition|)
name|screen
operator|->
name|c132
operator|=
name|TRUE
expr_stmt|;
continue|continue;
case|case
name|DEF_CURSES
case|:
if|if
condition|(
name|strcmp
argument_list|(
name|strind
argument_list|,
literal|"on"
argument_list|)
operator|==
literal|0
condition|)
name|screen
operator|->
name|curses
operator|=
name|TRUE
expr_stmt|;
continue|continue;
case|case
name|DEF_CURSOR
case|:
name|curs_color
operator|=
name|strind
expr_stmt|;
continue|continue;
case|case
name|DEF_CURSORSHAPE
case|:
if|if
condition|(
name|curs_shape
condition|)
name|free
argument_list|(
name|curs_shape
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|curs_shape
operator|=
name|malloc
argument_list|(
name|strlen
argument_list|(
name|strind
argument_list|)
operator|+
literal|1
argument_list|)
operator|)
operator|==
name|NULL
condition|)
name|SysError
argument_list|(
name|ERROR_KMALLOC
argument_list|)
expr_stmt|;
comment|/* not correct error */
name|strcpy
argument_list|(
name|curs_shape
argument_list|,
name|strind
argument_list|)
expr_stmt|;
continue|continue;
case|case
name|DEF_DEICONWARP
case|:
if|if
condition|(
name|strcmp
argument_list|(
name|strind
argument_list|,
literal|"on"
argument_list|)
operator|==
literal|0
condition|)
name|screen
operator|->
name|deiconwarp
operator|=
name|TRUE
expr_stmt|;
continue|continue;
case|case
name|DEF_FOREGROUND
case|:
name|fore_color
operator|=
name|strind
expr_stmt|;
continue|continue;
case|case
name|DEF_GRAYBORDER
case|:
if|if
condition|(
name|strcmp
argument_list|(
name|strind
argument_list|,
literal|"off"
argument_list|)
operator|==
literal|0
condition|)
name|grayborder
operator|=
name|FALSE
expr_stmt|;
continue|continue;
case|case
name|DEF_ICONBITMAP
case|:
name|iconbitmap
operator|=
name|strind
expr_stmt|;
continue|continue;
case|case
name|DEF_ICONFONT
case|:
name|f_i
operator|=
name|strind
expr_stmt|;
continue|continue;
case|case
name|DEF_ICONSTARTUP
case|:
if|if
condition|(
name|strcmp
argument_list|(
name|strind
argument_list|,
literal|"on"
argument_list|)
operator|==
literal|0
condition|)
name|screen
operator|->
name|icon_show
operator|=
operator|-
literal|1
expr_stmt|;
continue|continue;
case|case
name|DEF_INTERNALBORDER
case|:
name|screen
operator|->
name|border
operator|=
name|atoi
argument_list|(
name|strind
argument_list|)
expr_stmt|;
continue|continue;
case|case
name|DEF_JUMPSCROLL
case|:
if|if
condition|(
name|strcmp
argument_list|(
name|strind
argument_list|,
literal|"on"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|screen
operator|->
name|jumpscroll
operator|=
name|TRUE
expr_stmt|;
name|term
operator|.
name|flags
operator|&=
operator|~
name|SMOOTHSCROLL
expr_stmt|;
block|}
continue|continue;
ifdef|#
directive|ifdef
name|KEYBD
case|case
name|DEF_KEYBOARD
case|:
if|if
condition|(
name|keyboardtype
condition|)
name|free
argument_list|(
name|keyboardtype
argument_list|)
expr_stmt|;
name|keyboardtype
operator|=
name|strind
expr_stmt|;
continue|continue;
endif|#
directive|endif
endif|KEYBD
case|case
name|DEF_LOGFILE
case|:
if|if
condition|(
name|screen
operator|->
name|logfile
operator|=
name|malloc
argument_list|(
name|strlen
argument_list|(
name|strind
argument_list|)
operator|+
literal|1
argument_list|)
condition|)
name|strcpy
argument_list|(
name|screen
operator|->
name|logfile
argument_list|,
name|strind
argument_list|)
expr_stmt|;
continue|continue;
case|case
name|DEF_LOGGING
case|:
if|if
condition|(
name|strcmp
argument_list|(
name|strind
argument_list|,
literal|"on"
argument_list|)
operator|==
literal|0
condition|)
name|log_on
operator|=
name|TRUE
expr_stmt|;
continue|continue;
case|case
name|DEF_LOGINHIBIT
case|:
if|if
condition|(
name|strcmp
argument_list|(
name|strind
argument_list|,
literal|"on"
argument_list|)
operator|==
literal|0
condition|)
name|inhibit
operator||=
name|I_LOG
expr_stmt|;
continue|continue;
case|case
name|DEF_LOGINSHELL
case|:
if|if
condition|(
name|strcmp
argument_list|(
name|strind
argument_list|,
literal|"on"
argument_list|)
operator|==
literal|0
condition|)
name|login_shell
operator|=
name|TRUE
expr_stmt|;
continue|continue;
case|case
name|DEF_MARGINBELL
case|:
if|if
condition|(
name|strcmp
argument_list|(
name|strind
argument_list|,
literal|"on"
argument_list|)
operator|==
literal|0
condition|)
name|screen
operator|->
name|marginbell
operator|=
name|TRUE
expr_stmt|;
continue|continue;
case|case
name|DEF_MOUSE
case|:
name|mous_color
operator|=
name|strind
expr_stmt|;
continue|continue;
case|case
name|DEF_NMARGINBELL
case|:
name|n_marginbell
operator|=
name|atoi
argument_list|(
name|strind
argument_list|)
expr_stmt|;
continue|continue;
case|case
name|DEF_PAGEOVERLAP
case|:
if|if
condition|(
operator|(
name|screen
operator|->
name|pageoverlap
operator|=
name|atoi
argument_list|(
name|strind
argument_list|)
operator|-
literal|1
operator|)
operator|<
literal|0
condition|)
name|screen
operator|->
name|pageoverlap
operator|=
operator|-
literal|1
expr_stmt|;
continue|continue;
case|case
name|DEF_PAGESCROLL
case|:
if|if
condition|(
name|strcmp
argument_list|(
name|strind
argument_list|,
literal|"on"
argument_list|)
operator|==
literal|0
condition|)
name|screen
operator|->
name|pagemode
operator|=
name|TRUE
expr_stmt|;
continue|continue;
case|case
name|DEF_REVERSEVIDEO
case|:
if|if
condition|(
name|strcmp
argument_list|(
name|strind
argument_list|,
literal|"on"
argument_list|)
operator|==
literal|0
condition|)
name|re_verse
operator|=
name|TRUE
expr_stmt|;
continue|continue;
case|case
name|DEF_REVERSEWRAP
case|:
if|if
condition|(
name|strcmp
argument_list|(
name|strind
argument_list|,
literal|"on"
argument_list|)
operator|==
literal|0
condition|)
name|term
operator|.
name|flags
operator||=
name|REVERSEWRAP
expr_stmt|;
continue|continue;
case|case
name|DEF_SAVELINES
case|:
name|save_lines
operator|=
name|atoi
argument_list|(
name|strind
argument_list|)
expr_stmt|;
continue|continue;
case|case
name|DEF_SCROLLBAR
case|:
if|if
condition|(
name|strcmp
argument_list|(
name|strind
argument_list|,
literal|"on"
argument_list|)
operator|==
literal|0
condition|)
name|screen
operator|->
name|scrollbar
operator|=
name|SCROLLBARWIDTH
expr_stmt|;
continue|continue;
case|case
name|DEF_SCROLLINPUT
case|:
if|if
condition|(
name|strcmp
argument_list|(
name|strind
argument_list|,
literal|"on"
argument_list|)
operator|==
literal|0
condition|)
name|screen
operator|->
name|scrollinput
operator|=
name|TRUE
expr_stmt|;
continue|continue;
case|case
name|DEF_SCROLLKEY
case|:
if|if
condition|(
name|strcmp
argument_list|(
name|strind
argument_list|,
literal|"on"
argument_list|)
operator|==
literal|0
condition|)
name|screen
operator|->
name|scrollkey
operator|=
name|TRUE
expr_stmt|;
continue|continue;
case|case
name|DEF_SIGNALINHIBIT
case|:
if|if
condition|(
name|strcmp
argument_list|(
name|strind
argument_list|,
literal|"on"
argument_list|)
operator|==
literal|0
condition|)
name|inhibit
operator||=
name|I_SIGNAL
expr_stmt|;
continue|continue;
case|case
name|DEF_STATUSLINE
case|:
if|if
condition|(
name|strcmp
argument_list|(
name|strind
argument_list|,
literal|"on"
argument_list|)
operator|==
literal|0
condition|)
name|screen
operator|->
name|statusline
operator|=
name|TRUE
expr_stmt|;
continue|continue;
case|case
name|DEF_STATUSNORMAL
case|:
name|screen
operator|->
name|reversestatus
operator|=
operator|(
name|strcmp
argument_list|(
name|strind
argument_list|,
literal|"on"
argument_list|)
operator|!=
literal|0
operator|)
expr_stmt|;
continue|continue;
case|case
name|DEF_TEKICONBITMAP
case|:
name|tekiconbitmap
operator|=
name|strind
expr_stmt|;
continue|continue;
case|case
name|DEF_TEKINHIBIT
case|:
if|if
condition|(
name|strcmp
argument_list|(
name|strind
argument_list|,
literal|"on"
argument_list|)
operator|==
literal|0
condition|)
name|inhibit
operator||=
name|I_TEK
expr_stmt|;
continue|continue;
case|case
name|DEF_TEXTUNDERICON
case|:
if|if
condition|(
name|strcmp
argument_list|(
name|strind
argument_list|,
literal|"on"
argument_list|)
operator|==
literal|0
condition|)
name|screen
operator|->
name|textundericon
operator|=
name|TRUE
expr_stmt|;
continue|continue;
case|case
name|DEF_TITLEBAR
case|:
if|if
condition|(
name|strcmp
argument_list|(
name|strind
argument_list|,
literal|"on"
argument_list|)
operator|==
literal|0
condition|)
name|screen
operator|->
name|fullVwin
operator|.
name|titlebar
operator|=
name|TRUE
expr_stmt|;
continue|continue;
case|case
name|DEF_TITLEFONT
case|:
name|f_t
operator|=
name|strind
expr_stmt|;
continue|continue;
case|case
name|DEF_VISUALBELL
case|:
if|if
condition|(
name|strcmp
argument_list|(
name|strind
argument_list|,
literal|"on"
argument_list|)
operator|==
literal|0
condition|)
name|screen
operator|->
name|visualbell
operator|=
name|TRUE
expr_stmt|;
continue|continue;
case|case
name|DEF_VISBELLDELAY
case|:
name|screen
operator|->
name|visbelldelay
operator|=
name|atoi
argument_list|(
name|strind
argument_list|)
expr_stmt|;
continue|continue;
case|case
name|DEF_AUDIBLEBELL
case|:
if|if
condition|(
name|strcmp
argument_list|(
name|strind
argument_list|,
literal|"off"
argument_list|)
operator|==
literal|0
condition|)
name|screen
operator|->
name|audiblebell
operator|=
name|FALSE
expr_stmt|;
continue|continue;
case|case
name|DEF_DROPMENU
case|:
if|if
condition|(
name|strcmp
argument_list|(
name|strind
argument_list|,
literal|"on"
argument_list|)
operator|==
literal|0
condition|)
name|dropmenu
operator|=
name|TRUE
expr_stmt|;
continue|continue;
case|case
name|DEF_UNIQUESUFFIX
case|:
if|if
condition|(
name|strcmp
argument_list|(
name|strind
argument_list|,
literal|"off"
argument_list|)
operator|==
literal|0
condition|)
name|douniquesuffix
operator|=
name|FALSE
expr_stmt|;
continue|continue;
ifdef|#
directive|ifdef
name|ALLOWUNSHIFTEDSELECTION
case|case
name|DEF_UNSHIFTEDSELECTION
case|:
if|if
condition|(
name|strcmp
argument_list|(
name|strind
argument_list|,
literal|"on"
argument_list|)
operator|==
literal|0
condition|)
name|UnshiftedSelectionInit
argument_list|()
expr_stmt|;
continue|continue;
endif|#
directive|endif
block|}
block|}
end_for

begin_comment
comment|/* parse command line */
end_comment

begin_for
for|for
control|(
name|argc
operator|--
operator|,
name|argv
operator|++
init|;
name|argc
operator|>
literal|0
condition|;
name|argc
operator|--
operator|,
name|argv
operator|++
control|)
block|{
if|if
condition|(
operator|*
operator|*
name|argv
operator|==
literal|'='
condition|)
block|{
name|geo_metry
operator|=
operator|*
name|argv
expr_stmt|;
continue|continue;
block|}
if|if
condition|(
operator|*
operator|*
name|argv
operator|==
literal|'%'
condition|)
block|{
name|T_geometry
operator|=
operator|*
name|argv
expr_stmt|;
operator|*
name|T_geometry
operator|=
literal|'='
expr_stmt|;
continue|continue;
block|}
if|if
condition|(
operator|*
operator|*
name|argv
operator|==
literal|'#'
condition|)
block|{
name|icon_geom
operator|=
operator|*
name|argv
expr_stmt|;
operator|*
name|icon_geom
operator|=
literal|'='
expr_stmt|;
continue|continue;
block|}
if|if
condition|(
operator|(
name|strind
operator|=
name|index
argument_list|(
operator|*
name|argv
argument_list|,
literal|':'
argument_list|)
operator|)
operator|!=
name|NULL
condition|)
block|{
name|strncpy
argument_list|(
name|display
argument_list|,
operator|*
name|argv
argument_list|,
sizeof|sizeof
argument_list|(
name|display
argument_list|)
argument_list|)
expr_stmt|;
continue|continue;
block|}
if|if
condition|(
operator|!
operator|(
name|i
operator|=
operator|(
operator|*
operator|*
name|argv
operator|==
literal|'-'
operator|)
operator|)
operator|&&
operator|*
operator|*
name|argv
operator|!=
literal|'+'
condition|)
name|Syntax
argument_list|()
expr_stmt|;
switch|switch
condition|(
name|argument
argument_list|(
operator|&
operator|(
operator|*
name|argv
operator|)
index|[
literal|1
index|]
argument_list|)
condition|)
block|{
case|case
name|ARG_132
case|:
name|screen
operator|->
name|c132
operator|=
name|i
expr_stmt|;
continue|continue;
ifdef|#
directive|ifdef
name|TIOCCONS
case|case
name|ARG__C
case|:
name|Console
operator|=
name|i
expr_stmt|;
continue|continue;
endif|#
directive|endif
endif|TIOCCONS
case|case
name|ARG__L
case|:
block|{
name|char
name|tt
index|[
literal|32
index|]
decl_stmt|;
name|L_flag
operator|=
literal|1
expr_stmt|;
name|get_ty
operator|=
name|argv
index|[
operator|--
name|argc
index|]
expr_stmt|;
name|strcpy
argument_list|(
name|tt
argument_list|,
literal|"/dev/"
argument_list|)
expr_stmt|;
name|strcat
argument_list|(
name|tt
argument_list|,
name|get_ty
argument_list|)
expr_stmt|;
name|tt
index|[
literal|5
index|]
operator|=
literal|'p'
expr_stmt|;
name|loginpty
operator|=
name|open
argument_list|(
name|tt
argument_list|,
name|O_RDWR
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|dup2
argument_list|(
name|loginpty
argument_list|,
literal|4
argument_list|)
expr_stmt|;
name|close
argument_list|(
name|loginpty
argument_list|)
expr_stmt|;
name|loginpty
operator|=
literal|4
expr_stmt|;
name|tt
index|[
literal|5
index|]
operator|=
literal|'t'
expr_stmt|;
name|chown
argument_list|(
name|tt
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|chmod
argument_list|(
name|tt
argument_list|,
literal|0622
argument_list|)
expr_stmt|;
if|if
condition|(
name|open
argument_list|(
name|tt
argument_list|,
name|O_RDWR
argument_list|)
operator|<
literal|0
condition|)
block|{
name|consolepr
argument_list|(
literal|"open failed\n"
argument_list|)
expr_stmt|;
block|}
name|signal
argument_list|(
name|SIGHUP
argument_list|,
name|SIG_IGN
argument_list|)
expr_stmt|;
name|vhangup
argument_list|()
expr_stmt|;
name|setpgrp
argument_list|(
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|signal
argument_list|(
name|SIGHUP
argument_list|,
name|SIG_DFL
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|close
argument_list|(
literal|0
argument_list|)
expr_stmt|;
name|open
argument_list|(
name|tt
argument_list|,
name|O_RDWR
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|dup2
argument_list|(
literal|0
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|dup2
argument_list|(
literal|0
argument_list|,
literal|2
argument_list|)
expr_stmt|;
continue|continue;
block|}
case|case
name|ARG__S
case|:
if|if
condition|(
name|i
condition|)
block|{
if|if
condition|(
operator|--
name|argc
operator|<=
literal|0
condition|)
name|Syntax
argument_list|()
expr_stmt|;
name|sscanf
argument_list|(
operator|*
operator|++
name|argv
argument_list|,
literal|"%c%c%d"
argument_list|,
name|passedPty
argument_list|,
name|passedPty
operator|+
literal|1
argument_list|,
operator|&
name|am_slave
argument_list|)
expr_stmt|;
if|if
condition|(
name|am_slave
operator|<=
literal|0
condition|)
name|Syntax
argument_list|()
expr_stmt|;
block|}
else|else
name|am_slave
operator|=
literal|0
expr_stmt|;
continue|continue;
case|case
name|ARG_AI
case|:
name|screen
operator|->
name|active_icon
operator|=
name|i
expr_stmt|;
continue|continue;
case|case
name|ARG_AR
case|:
name|screen
operator|->
name|autoraise
operator|=
name|i
expr_stmt|;
continue|continue;
case|case
name|ARG_B
case|:
if|if
condition|(
name|i
condition|)
block|{
if|if
condition|(
operator|--
name|argc
operator|<=
literal|0
condition|)
name|Syntax
argument_list|()
expr_stmt|;
name|screen
operator|->
name|border
operator|=
name|atoi
argument_list|(
operator|*
operator|++
name|argv
argument_list|)
expr_stmt|;
block|}
else|else
name|screen
operator|->
name|border
operator|=
name|DEFBORDER
expr_stmt|;
continue|continue;
case|case
name|ARG_BD
case|:
if|if
condition|(
name|i
condition|)
block|{
if|if
condition|(
operator|--
name|argc
operator|<=
literal|0
condition|)
name|Syntax
argument_list|()
expr_stmt|;
name|brdr_color
operator|=
operator|*
operator|++
name|argv
expr_stmt|;
block|}
else|else
name|brdr_color
operator|=
name|NULL
expr_stmt|;
continue|continue;
case|case
name|ARG_BG
case|:
if|if
condition|(
name|i
condition|)
block|{
if|if
condition|(
operator|--
name|argc
operator|<=
literal|0
condition|)
name|Syntax
argument_list|()
expr_stmt|;
name|back_color
operator|=
operator|*
operator|++
name|argv
expr_stmt|;
block|}
else|else
name|back_color
operator|=
name|NULL
expr_stmt|;
continue|continue;
case|case
name|ARG_BW
case|:
if|if
condition|(
name|i
condition|)
block|{
if|if
condition|(
operator|--
name|argc
operator|<=
literal|0
condition|)
name|Syntax
argument_list|()
expr_stmt|;
name|screen
operator|->
name|borderwidth
operator|=
name|atoi
argument_list|(
operator|*
operator|++
name|argv
argument_list|)
expr_stmt|;
block|}
else|else
name|screen
operator|->
name|borderwidth
operator|=
name|DEFBORDERWIDTH
expr_stmt|;
continue|continue;
case|case
name|ARG_CR
case|:
if|if
condition|(
name|i
condition|)
block|{
if|if
condition|(
operator|--
name|argc
operator|<=
literal|0
condition|)
name|Syntax
argument_list|()
expr_stmt|;
name|curs_color
operator|=
operator|*
operator|++
name|argv
expr_stmt|;
block|}
else|else
name|curs_color
operator|=
name|NULL
expr_stmt|;
continue|continue;
case|case
name|ARG_CU
case|:
name|screen
operator|->
name|curses
operator|=
name|i
expr_stmt|;
continue|continue;
ifdef|#
directive|ifdef
name|DEBUG
case|case
name|ARG_D
case|:
name|debug
operator|=
name|i
expr_stmt|;
continue|continue;
endif|#
directive|endif
endif|DEBUG
case|case
name|ARG_DW
case|:
name|screen
operator|->
name|deiconwarp
operator|=
name|i
expr_stmt|;
continue|continue;
case|case
name|ARG_E
case|:
if|if
condition|(
operator|!
name|i
condition|)
name|Syntax
argument_list|()
expr_stmt|;
if|if
condition|(
name|argc
operator|<=
literal|1
condition|)
name|Syntax
argument_list|()
expr_stmt|;
name|command_to_exec
operator|=
operator|++
name|argv
expr_stmt|;
break|break;
case|case
name|ARG_FB
case|:
if|if
condition|(
name|fbflag
operator|=
name|i
condition|)
block|{
if|if
condition|(
operator|--
name|argc
operator|<=
literal|0
condition|)
name|Syntax
argument_list|()
expr_stmt|;
name|f_b
operator|=
operator|*
operator|++
name|argv
expr_stmt|;
name|fbflag
operator|=
name|TRUE
expr_stmt|;
block|}
else|else
block|{
name|f_b
operator|=
name|def_bold_font
expr_stmt|;
name|fbflag
operator|=
name|FALSE
expr_stmt|;
block|}
continue|continue;
case|case
name|ARG_FG
case|:
if|if
condition|(
name|i
condition|)
block|{
if|if
condition|(
operator|--
name|argc
operator|<=
literal|0
condition|)
name|Syntax
argument_list|()
expr_stmt|;
name|fore_color
operator|=
operator|*
operator|++
name|argv
expr_stmt|;
block|}
else|else
name|fore_color
operator|=
name|NULL
expr_stmt|;
continue|continue;
case|case
name|ARG_FI
case|:
if|if
condition|(
name|i
condition|)
block|{
if|if
condition|(
operator|--
name|argc
operator|<=
literal|0
condition|)
name|Syntax
argument_list|()
expr_stmt|;
name|f_i
operator|=
operator|*
operator|++
name|argv
expr_stmt|;
block|}
else|else
name|f_i
operator|=
name|def_icon_font
expr_stmt|;
continue|continue;
case|case
name|ARG_FN
case|:
if|if
condition|(
name|fnflag
operator|=
name|i
condition|)
block|{
if|if
condition|(
operator|--
name|argc
operator|<=
literal|0
condition|)
name|Syntax
argument_list|()
expr_stmt|;
name|f_n
operator|=
operator|*
operator|++
name|argv
expr_stmt|;
name|fnflag
operator|=
name|TRUE
expr_stmt|;
block|}
else|else
block|{
name|f_n
operator|=
name|def_font
expr_stmt|;
name|fnflag
operator|=
name|FALSE
expr_stmt|;
block|}
continue|continue;
case|case
name|ARG_FT
case|:
if|if
condition|(
name|i
condition|)
block|{
if|if
condition|(
operator|--
name|argc
operator|<=
literal|0
condition|)
name|Syntax
argument_list|()
expr_stmt|;
name|f_t
operator|=
operator|*
operator|++
name|argv
expr_stmt|;
block|}
else|else
name|f_t
operator|=
name|def_title_font
expr_stmt|;
continue|continue;
case|case
name|ARG_I
case|:
name|screen
operator|->
name|icon_show
operator|=
name|i
condition|?
operator|-
literal|1
else|:
literal|0
expr_stmt|;
continue|continue;
case|case
name|ARG_IB
case|:
if|if
condition|(
name|i
condition|)
block|{
if|if
condition|(
operator|--
name|argc
operator|<=
literal|0
condition|)
name|Syntax
argument_list|()
expr_stmt|;
name|iconbitmap
operator|=
operator|*
operator|++
name|argv
expr_stmt|;
block|}
else|else
name|iconbitmap
operator|=
name|NULL
expr_stmt|;
continue|continue;
case|case
name|ARG_IT
case|:
if|if
condition|(
name|i
condition|)
block|{
if|if
condition|(
operator|--
name|argc
operator|<=
literal|0
condition|)
name|Syntax
argument_list|()
expr_stmt|;
name|tekiconbitmap
operator|=
operator|*
operator|++
name|argv
expr_stmt|;
block|}
else|else
name|tekiconbitmap
operator|=
name|NULL
expr_stmt|;
continue|continue;
case|case
name|ARG_J
case|:
if|if
condition|(
name|screen
operator|->
name|jumpscroll
operator|=
name|i
condition|)
name|term
operator|.
name|flags
operator|&=
operator|~
name|SMOOTHSCROLL
expr_stmt|;
else|else
name|term
operator|.
name|flags
operator||=
name|SMOOTHSCROLL
expr_stmt|;
continue|continue;
ifdef|#
directive|ifdef
name|KEYBD
case|case
name|ARG_K
case|:
if|if
condition|(
name|i
condition|)
block|{
if|if
condition|(
operator|--
name|argc
operator|<=
literal|0
condition|)
name|Syntax
argument_list|()
expr_stmt|;
name|keyboardtype
operator|=
operator|*
operator|++
name|argv
expr_stmt|;
block|}
else|else
name|keyboardtype
operator|=
name|NULL
expr_stmt|;
continue|continue;
endif|#
directive|endif
endif|KEYBD
case|case
name|ARG_L
case|:
name|log_on
operator|=
name|i
expr_stmt|;
continue|continue;
case|case
name|ARG_LF
case|:
if|if
condition|(
name|screen
operator|->
name|logfile
condition|)
name|free
argument_list|(
name|screen
operator|->
name|logfile
argument_list|)
expr_stmt|;
if|if
condition|(
name|i
condition|)
block|{
if|if
condition|(
operator|--
name|argc
operator|<=
literal|0
condition|)
name|Syntax
argument_list|()
expr_stmt|;
if|if
condition|(
name|screen
operator|->
name|logfile
operator|=
name|malloc
argument_list|(
name|strlen
argument_list|(
operator|*
operator|++
name|argv
argument_list|)
operator|+
literal|1
argument_list|)
condition|)
name|strcpy
argument_list|(
name|screen
operator|->
name|logfile
argument_list|,
operator|*
name|argv
argument_list|)
expr_stmt|;
block|}
else|else
name|screen
operator|->
name|logfile
operator|=
name|NULL
expr_stmt|;
continue|continue;
case|case
name|ARG_LS
case|:
name|login_shell
operator|=
name|i
expr_stmt|;
continue|continue;
case|case
name|ARG_MB
case|:
name|screen
operator|->
name|marginbell
operator|=
name|i
expr_stmt|;
continue|continue;
case|case
name|ARG_MS
case|:
if|if
condition|(
name|i
condition|)
block|{
if|if
condition|(
operator|--
name|argc
operator|<=
literal|0
condition|)
name|Syntax
argument_list|()
expr_stmt|;
name|mous_color
operator|=
operator|*
operator|++
name|argv
expr_stmt|;
block|}
else|else
name|mous_color
operator|=
name|NULL
expr_stmt|;
continue|continue;
case|case
name|ARG_N
case|:
if|if
condition|(
name|i
condition|)
block|{
if|if
condition|(
operator|--
name|argc
operator|<=
literal|0
condition|)
name|Syntax
argument_list|()
expr_stmt|;
name|win_name
operator|=
operator|*
operator|++
name|argv
expr_stmt|;
block|}
else|else
name|win_name
operator|=
name|NULL
expr_stmt|;
continue|continue;
case|case
name|ARG_NB
case|:
if|if
condition|(
name|i
condition|)
block|{
if|if
condition|(
operator|--
name|argc
operator|<=
literal|0
condition|)
name|Syntax
argument_list|()
expr_stmt|;
name|n_marginbell
operator|=
name|atoi
argument_list|(
operator|*
operator|++
name|argv
argument_list|)
expr_stmt|;
block|}
else|else
name|n_marginbell
operator|=
name|N_MARGINBELL
expr_stmt|;
continue|continue;
case|case
name|ARG_PO
case|:
if|if
condition|(
name|i
condition|)
block|{
if|if
condition|(
operator|--
name|argc
operator|<=
literal|0
condition|)
name|Syntax
argument_list|()
expr_stmt|;
if|if
condition|(
operator|(
name|screen
operator|->
name|pageoverlap
operator|=
name|atoi
argument_list|(
operator|*
operator|++
name|argv
argument_list|)
operator|-
literal|1
operator|)
operator|<
literal|0
condition|)
name|screen
operator|->
name|pageoverlap
operator|=
operator|-
literal|1
expr_stmt|;
block|}
else|else
name|screen
operator|->
name|pageoverlap
operator|=
literal|0
expr_stmt|;
continue|continue;
case|case
name|ARG_PS
case|:
name|screen
operator|->
name|pagemode
operator|=
name|i
expr_stmt|;
continue|continue;
case|case
name|ARG_RV
case|:
name|re_verse
operator|=
name|i
expr_stmt|;
continue|continue;
case|case
name|ARG_RW
case|:
if|if
condition|(
name|i
condition|)
name|term
operator|.
name|flags
operator||=
name|REVERSEWRAP
expr_stmt|;
else|else
name|term
operator|.
name|flags
operator|&=
operator|~
name|REVERSEWRAP
expr_stmt|;
continue|continue;
case|case
name|ARG_S
case|:
name|screen
operator|->
name|multiscroll
operator|=
name|i
expr_stmt|;
continue|continue;
case|case
name|ARG_SB
case|:
name|screen
operator|->
name|scrollbar
operator|=
name|i
condition|?
name|SCROLLBARWIDTH
else|:
literal|0
expr_stmt|;
continue|continue;
case|case
name|ARG_SI
case|:
name|screen
operator|->
name|scrollinput
operator|=
name|i
expr_stmt|;
continue|continue;
case|case
name|ARG_SK
case|:
name|screen
operator|->
name|scrollkey
operator|=
name|i
expr_stmt|;
continue|continue;
case|case
name|ARG_SL
case|:
if|if
condition|(
name|i
condition|)
block|{
if|if
condition|(
operator|--
name|argc
operator|<=
literal|0
condition|)
name|Syntax
argument_list|()
expr_stmt|;
name|save_lines
operator|=
name|atoi
argument_list|(
operator|*
operator|++
name|argv
argument_list|)
expr_stmt|;
block|}
else|else
name|save_lines
operator|=
name|SAVELINES
expr_stmt|;
continue|continue;
case|case
name|ARG_SN
case|:
name|screen
operator|->
name|reversestatus
operator|=
operator|!
name|i
expr_stmt|;
continue|continue;
case|case
name|ARG_ST
case|:
name|screen
operator|->
name|statusline
operator|=
name|i
expr_stmt|;
continue|continue;
case|case
name|ARG_T
case|:
name|screen
operator|->
name|TekEmu
operator|=
name|i
expr_stmt|;
continue|continue;
case|case
name|ARG_TB
case|:
name|screen
operator|->
name|fullVwin
operator|.
name|titlebar
operator|=
name|i
expr_stmt|;
continue|continue;
case|case
name|ARG_TI
case|:
name|screen
operator|->
name|textundericon
operator|=
name|i
expr_stmt|;
continue|continue;
case|case
name|ARG_AB
case|:
name|screen
operator|->
name|audiblebell
operator|=
name|i
expr_stmt|;
continue|continue;
case|case
name|ARG_VB
case|:
name|screen
operator|->
name|visualbell
operator|=
name|i
expr_stmt|;
continue|continue;
case|case
name|ARG_VD
case|:
if|if
condition|(
name|i
condition|)
block|{
if|if
condition|(
operator|--
name|argc
operator|<=
literal|0
condition|)
name|Syntax
argument_list|()
expr_stmt|;
name|screen
operator|->
name|visbelldelay
operator|=
name|atoi
argument_list|(
operator|*
operator|++
name|argv
argument_list|)
expr_stmt|;
block|}
else|else
name|screen
operator|->
name|visbelldelay
operator|=
name|VISBELLDELAY
expr_stmt|;
continue|continue;
default|default:
name|Syntax
argument_list|()
expr_stmt|;
block|}
break|break;
block|}
end_for

begin_expr_stmt
name|term
operator|.
name|initflags
operator|=
name|term
operator|.
name|flags
expr_stmt|;
end_expr_stmt

begin_if
if|if
condition|(
name|fnflag
operator|&&
operator|!
name|fbflag
condition|)
name|f_b
operator|=
name|NULL
expr_stmt|;
end_if

begin_if
if|if
condition|(
operator|!
name|fnflag
operator|&&
name|fbflag
condition|)
name|f_n
operator|=
name|f_b
expr_stmt|;
end_if

begin_if
if|if
condition|(
operator|!
name|win_name
condition|)
block|{
if|if
condition|(
name|get_ty
condition|)
block|{
name|char
name|b
index|[
literal|256
index|]
decl_stmt|;
name|gethostname
argument_list|(
name|b
argument_list|,
sizeof|sizeof
argument_list|(
name|b
argument_list|)
operator|-
literal|1
argument_list|)
expr_stmt|;
name|b
index|[
sizeof|sizeof
argument_list|(
name|b
argument_list|)
operator|-
literal|1
index|]
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|strind
operator|=
name|index
argument_list|(
name|b
argument_list|,
literal|'.'
argument_list|)
condition|)
comment|/* remove domain */
operator|*
name|strind
operator|=
literal|0
expr_stmt|;
name|win_name
operator|=
name|malloc
argument_list|(
name|strlen
argument_list|(
name|b
argument_list|)
operator|+
literal|8
argument_list|)
expr_stmt|;
name|strcpy
argument_list|(
name|win_name
argument_list|,
literal|"login("
argument_list|)
expr_stmt|;
name|strcat
argument_list|(
name|win_name
argument_list|,
name|b
argument_list|)
expr_stmt|;
name|strcat
argument_list|(
name|win_name
argument_list|,
literal|")"
argument_list|)
expr_stmt|;
block|}
else|else
name|win_name
operator|=
operator|(
name|am_slave
condition|?
literal|"xterm slave"
else|:
operator|(
name|command_to_exec
condition|?
name|basename
argument_list|(
name|command_to_exec
index|[
literal|0
index|]
argument_list|)
else|:
name|xterm_name
operator|)
operator|)
expr_stmt|;
block|}
end_if

begin_if
if|if
condition|(
name|inhibit
operator|&
name|I_TEK
condition|)
name|screen
operator|->
name|TekEmu
operator|=
name|FALSE
expr_stmt|;
end_if

begin_comment
comment|/* set up stderr properly */
end_comment

begin_expr_stmt
name|i
operator|=
operator|-
literal|1
expr_stmt|;
end_expr_stmt

begin_ifdef
ifdef|#
directive|ifdef
name|DEBUG
end_ifdef

begin_if
if|if
condition|(
name|debug
condition|)
name|i
operator|=
name|open
argument_list|(
literal|"xterm.debug.log"
argument_list|,
name|O_WRONLY
operator||
name|O_CREAT
operator||
name|O_TRUNC
argument_list|,
literal|0666
argument_list|)
expr_stmt|;
elseif|else
endif|#
directive|endif
endif|DEBUG
if|if
condition|(
name|get_ty
condition|)
name|i
operator|=
name|open
argument_list|(
literal|"/dev/console"
argument_list|,
name|O_WRONLY
argument_list|)
expr_stmt|;
end_if

begin_if
if|if
condition|(
name|i
operator|>=
literal|0
condition|)
name|fileno
argument_list|(
name|stderr
argument_list|)
operator|=
name|i
expr_stmt|;
end_if

begin_if
if|if
condition|(
name|fileno
argument_list|(
name|stderr
argument_list|)
operator|!=
operator|(
name|NOFILE
operator|-
literal|1
operator|)
condition|)
block|{
name|dup2
argument_list|(
name|fileno
argument_list|(
name|stderr
argument_list|)
argument_list|,
operator|(
name|NOFILE
operator|-
literal|1
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|fileno
argument_list|(
name|stderr
argument_list|)
operator|>=
literal|3
condition|)
name|close
argument_list|(
name|fileno
argument_list|(
name|stderr
argument_list|)
argument_list|)
expr_stmt|;
name|fileno
argument_list|(
name|stderr
argument_list|)
operator|=
operator|(
name|NOFILE
operator|-
literal|1
operator|)
expr_stmt|;
block|}
end_if

begin_expr_stmt
name|signal
argument_list|(
name|SIGCHLD
argument_list|,
name|reapchild
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|signal
argument_list|(
name|SIGHUP
argument_list|,
name|SIG_IGN
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|signal
argument_list|(
name|SIGALRM
argument_list|,
name|onalarm
argument_list|)
expr_stmt|;
end_expr_stmt

begin_comment
comment|/* open a terminal for client */
end_comment

begin_expr_stmt
name|get_terminal
argument_list|()
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|spawn
argument_list|()
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|Xsocket
operator|=
name|screen
operator|->
name|display
operator|->
name|fd
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|pty
operator|=
name|screen
operator|->
name|respond
expr_stmt|;
end_expr_stmt

begin_if
if|if
condition|(
name|am_slave
condition|)
block|{
comment|/* Write window id so master end can read and use */
name|write
argument_list|(
name|pty
argument_list|,
name|screen
operator|->
name|TekEmu
condition|?
operator|(
name|char
operator|*
operator|)
operator|&
name|TWindow
argument_list|(
name|screen
argument_list|)
else|:
operator|(
name|char
operator|*
operator|)
operator|&
name|VWindow
argument_list|(
name|screen
argument_list|)
argument_list|,
sizeof|sizeof
argument_list|(
name|Window
argument_list|)
argument_list|)
expr_stmt|;
name|write
argument_list|(
name|pty
argument_list|,
literal|"\n"
argument_list|,
literal|1
argument_list|)
expr_stmt|;
block|}
end_if

begin_if
if|if
condition|(
name|log_on
condition|)
block|{
name|log_on
operator|=
name|FALSE
expr_stmt|;
name|StartLog
argument_list|(
name|screen
argument_list|)
expr_stmt|;
block|}
end_if

begin_expr_stmt
name|screen
operator|->
name|inhibit
operator|=
name|inhibit
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|mode
operator|=
literal|1
expr_stmt|;
end_expr_stmt

begin_if
if|if
condition|(
name|ioctl
argument_list|(
name|pty
argument_list|,
name|FIONBIO
argument_list|,
operator|&
name|mode
argument_list|)
operator|==
operator|-
literal|1
condition|)
name|SysError
argument_list|(
name|ERROR_FIONBIO
argument_list|)
expr_stmt|;
end_if

begin_expr_stmt
name|pty_mask
operator|=
literal|1
operator|<<
name|pty
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|X_mask
operator|=
literal|1
operator|<<
name|Xsocket
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|Select_mask
operator|=
name|pty_mask
operator||
name|X_mask
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|max_plus1
operator|=
operator|(
name|pty
operator|<
name|Xsocket
operator|)
condition|?
operator|(
literal|1
operator|+
name|Xsocket
operator|)
else|:
operator|(
literal|1
operator|+
name|pty
operator|)
expr_stmt|;
end_expr_stmt

begin_ifdef
ifdef|#
directive|ifdef
name|DEBUG
end_ifdef

begin_if
if|if
condition|(
name|debug
condition|)
name|printf
argument_list|(
literal|"debugging on\n"
argument_list|)
expr_stmt|;
end_if

begin_endif
endif|#
directive|endif
endif|DEBUG
end_endif

begin_expr_stmt
name|XErrorHandler
argument_list|(
name|xerror
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|XIOErrorHandler
argument_list|(
name|xioerror
argument_list|)
expr_stmt|;
end_expr_stmt

begin_for
for|for
control|(
init|;
condition|;
control|)
if|if
condition|(
name|screen
operator|->
name|TekEmu
condition|)
name|TekRun
argument_list|()
expr_stmt|;
else|else
name|VTRun
argument_list|()
expr_stmt|;
end_for

begin_expr_stmt
unit|}  char
operator|*
name|basename
argument_list|(
argument|name
argument_list|)
name|char
operator|*
name|name
expr_stmt|;
end_expr_stmt

begin_block
block|{
specifier|register
name|char
modifier|*
name|cp
decl_stmt|;
name|char
modifier|*
name|rindex
parameter_list|()
function_decl|;
return|return
operator|(
operator|(
name|cp
operator|=
name|rindex
argument_list|(
name|name
argument_list|,
literal|'/'
argument_list|)
operator|)
condition|?
name|cp
operator|+
literal|1
else|:
name|name
operator|)
return|;
block|}
end_block

begin_struct
specifier|static
struct|struct
name|argstr
block|{
name|char
modifier|*
name|arg
decl_stmt|;
name|int
name|val
decl_stmt|;
block|}
name|arg
index|[]
init|=
block|{
block|{
literal|"132"
block|,
name|ARG_132
block|}
block|,
ifdef|#
directive|ifdef
name|TIOCCONS
block|{
literal|"C"
block|,
name|ARG__C
block|}
block|,
endif|#
directive|endif
endif|TIOCCONS
block|{
literal|"L"
block|,
name|ARG__L
block|}
block|,
block|{
literal|"S"
block|,
name|ARG__S
block|}
block|,
block|{
literal|"ab"
block|,
name|ARG_AB
block|}
block|,
block|{
literal|"ai"
block|,
name|ARG_AI
block|}
block|,
block|{
literal|"ar"
block|,
name|ARG_AR
block|}
block|,
block|{
literal|"b"
block|,
name|ARG_B
block|}
block|,
block|{
literal|"bd"
block|,
name|ARG_BD
block|}
block|,
block|{
literal|"bg"
block|,
name|ARG_BG
block|}
block|,
block|{
literal|"bw"
block|,
name|ARG_BW
block|}
block|,
block|{
literal|"cr"
block|,
name|ARG_CR
block|}
block|,
block|{
literal|"cu"
block|,
name|ARG_CU
block|}
block|,
ifdef|#
directive|ifdef
name|DEBUG
block|{
literal|"d"
block|,
name|ARG_D
block|}
block|,
endif|#
directive|endif
endif|DEBUG
block|{
literal|"dw"
block|,
name|ARG_DW
block|}
block|,
block|{
literal|"e"
block|,
name|ARG_E
block|}
block|,
block|{
literal|"fb"
block|,
name|ARG_FB
block|}
block|,
block|{
literal|"fg"
block|,
name|ARG_FG
block|}
block|,
block|{
literal|"fi"
block|,
name|ARG_FI
block|}
block|,
block|{
literal|"fn"
block|,
name|ARG_FN
block|}
block|,
block|{
literal|"ft"
block|,
name|ARG_FT
block|}
block|,
block|{
literal|"i"
block|,
name|ARG_I
block|}
block|,
block|{
literal|"ib"
block|,
name|ARG_IB
block|}
block|,
block|{
literal|"it"
block|,
name|ARG_IT
block|}
block|,
block|{
literal|"j"
block|,
name|ARG_J
block|}
block|,
ifdef|#
directive|ifdef
name|KEYBD
block|{
literal|"k"
block|,
name|ARG_K
block|}
block|,
endif|#
directive|endif
endif|KEYBD
block|{
literal|"l"
block|,
name|ARG_L
block|}
block|,
block|{
literal|"lf"
block|,
name|ARG_LF
block|}
block|,
block|{
literal|"ls"
block|,
name|ARG_LS
block|}
block|,
block|{
literal|"mb"
block|,
name|ARG_MB
block|}
block|,
block|{
literal|"ms"
block|,
name|ARG_MS
block|}
block|,
block|{
literal|"n"
block|,
name|ARG_N
block|}
block|,
block|{
literal|"nb"
block|,
name|ARG_NB
block|}
block|,
block|{
literal|"po"
block|,
name|ARG_PO
block|}
block|,
block|{
literal|"ps"
block|,
name|ARG_PS
block|}
block|,
block|{
literal|"r"
block|,
name|ARG_RV
block|}
block|,
block|{
literal|"rv"
block|,
name|ARG_RV
block|}
block|,
block|{
literal|"rw"
block|,
name|ARG_RW
block|}
block|,
block|{
literal|"s"
block|,
name|ARG_S
block|}
block|,
block|{
literal|"sb"
block|,
name|ARG_SB
block|}
block|,
block|{
literal|"si"
block|,
name|ARG_SI
block|}
block|,
block|{
literal|"sk"
block|,
name|ARG_SK
block|}
block|,
block|{
literal|"sl"
block|,
name|ARG_SL
block|}
block|,
block|{
literal|"sn"
block|,
name|ARG_SN
block|}
block|,
block|{
literal|"st"
block|,
name|ARG_ST
block|}
block|,
block|{
literal|"t"
block|,
name|ARG_T
block|}
block|,
block|{
literal|"tb"
block|,
name|ARG_TB
block|}
block|,
block|{
literal|"ti"
block|,
name|ARG_TI
block|}
block|,
block|{
literal|"vb"
block|,
name|ARG_VB
block|}
block|,
block|{
literal|"vd"
block|,
name|ARG_VD
block|}
block|,
block|{
literal|"w"
block|,
name|ARG_BW
block|}
block|, }
struct|;
end_struct

begin_expr_stmt
name|argument
argument_list|(
name|s
argument_list|)
specifier|register
name|char
operator|*
name|s
expr_stmt|;
end_expr_stmt

begin_block
block|{
specifier|register
name|int
name|i
decl_stmt|,
name|low
decl_stmt|,
name|high
decl_stmt|,
name|com
decl_stmt|;
name|low
operator|=
literal|0
expr_stmt|;
name|high
operator|=
sizeof|sizeof
argument_list|(
name|arg
argument_list|)
operator|/
sizeof|sizeof
argument_list|(
expr|struct
name|argstr
argument_list|)
operator|-
literal|1
expr_stmt|;
while|while
condition|(
name|low
operator|<=
name|high
condition|)
block|{
comment|/* use binary search, arg in lexigraphic order */
name|i
operator|=
operator|(
name|low
operator|+
name|high
operator|)
operator|/
literal|2
expr_stmt|;
if|if
condition|(
operator|(
name|com
operator|=
name|strcmp
argument_list|(
name|s
argument_list|,
name|arg
index|[
name|i
index|]
operator|.
name|arg
argument_list|)
operator|)
operator|==
literal|0
condition|)
return|return
operator|(
name|arg
index|[
name|i
index|]
operator|.
name|val
operator|)
return|;
if|if
condition|(
name|com
operator|>
literal|0
condition|)
name|low
operator|=
name|i
operator|+
literal|1
expr_stmt|;
else|else
name|high
operator|=
name|i
operator|-
literal|1
expr_stmt|;
block|}
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
end_block

begin_decl_stmt
specifier|static
name|char
modifier|*
name|ustring
index|[]
init|=
block|{
literal|"Usage: xterm [-132] [-ab] [-ai] [-ar] [-b margin_width] [-bd border_color] \\\n"
block|,
ifdef|#
directive|ifdef
name|ARG__C
literal|" [-bg backgrnd_color] [-bw border_width] [-C] [-cr cursor_color] [-cu] \\\n"
block|,
else|#
directive|else
else|ARG__C
literal|" [-bg backgrnd_color] [-bw border_width] [-cr cursor_color] [-cu] \\\n"
block|,
endif|#
directive|endif
endif|ARG__C
literal|" [-dw] [-fb bold_font] [-fg foregrnd_color] [-fi icon_font] [-fn norm_font] \\\n"
block|,
literal|" [-ft title_font] [-i] [-ib iconbitmap] [-it tekiconbitmap] [-j] \\\n"
block|,
ifdef|#
directive|ifdef
name|ARG_K
literal|" [-k keybd] [-l] [-lf logfile] [-ls] [-mb] [-ms mouse_color] \\\n"
block|,
else|#
directive|else
else|ARG_K
literal|" [-l] [-lf logfile] [-ls] [-mb] [-ms mouse_color] \\\n"
block|,
endif|#
directive|endif
endif|ARG_K
literal|" [-n name] [-nb bell_margin] [-po] [-ps] [-rv] [-rw] [-s] \\\n"
block|,
literal|" [-sb] [-si] [-sk] [-sl save_lines] [-sn] [-st] [-t] [-tb] \\\n"
block|,
literal|" [-ti] [-vb] [-vd visbelldelay] [=[width]x[height][[+-]xoff[[+-]yoff]]] \\\n"
block|,
literal|" [%[width]x[height][[+-]xoff[[+-]yoff]]] [#[+-]xoff[[+-]yoff]] \\\n"
block|,
literal|" [-e command_to_exec]\n\n"
block|,
literal|"Fonts must be of fixed width and of same size;\n"
block|,
literal|"If only one font is specified, it will be used for normal and bold text\n"
block|,
literal|"The -132 option allows 80<-> 132 column escape sequences\n"
block|,
literal|"The -ab option enables audible bell\n"
block|,
literal|"The -ai option turns on miniature (active) icons\n"
block|,
literal|"The -ar option turns auto raise window mode on\n"
block|,
ifdef|#
directive|ifdef
name|ARG__C
literal|"The -C option forces output to /dev/console to appear in this window\n"
block|,
endif|#
directive|endif
endif|ARG__C
literal|"The -cu option turns a curses bug fix on\n"
block|,
literal|"The -dw option warps the mouse on deiconify\n"
block|,
literal|"The -i option enables icon startup\n"
block|,
literal|"The -j option enables jump scroll\n"
block|,
literal|"The -l option enables logging\n"
block|,
literal|"The -ls option makes the shell a login shell\n"
block|,
literal|"The -mb option turns the margin bell on\n"
block|,
literal|"The -ps option turns page scroll on\n"
block|,
literal|"The -rv option turns reverse video on\n"
block|,
literal|"The -rw option turns reverse wraparound on\n"
block|,
literal|"The -s option enables asynchronous scrolling\n"
block|,
literal|"The -sb option enables the scrollbar\n"
block|,
literal|"The -si option enables re-positioning the scrollbar at the bottom on input\n"
block|,
literal|"The -sk option causes the scrollbar to position at the bottom on a key\n"
block|,
literal|"The -sn option makes the status line normal video \n"
block|,
literal|"The -st option enables the status line\n"
block|,
literal|"The -t option starts Tektronix mode\n"
block|,
literal|"The -tb option enables the titlebar\n"
block|,
literal|"The -ti option places the window name under the icon\n"
block|,
literal|"The -vb option enables visual bell\n"
block|,
literal|0
block|}
decl_stmt|;
end_decl_stmt

begin_macro
name|Syntax
argument_list|()
end_macro

begin_block
block|{
specifier|register
name|char
modifier|*
modifier|*
name|us
init|=
name|ustring
decl_stmt|;
while|while
condition|(
operator|*
name|us
condition|)
name|fputs
argument_list|(
operator|*
name|us
operator|++
argument_list|,
name|stderr
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
end_block

begin_macro
name|get_pty
argument_list|(
argument|pty
argument_list|,
argument|tty
argument_list|)
end_macro

begin_comment
comment|/*    opens a pty, storing fildes in pty and tty.  */
end_comment

begin_decl_stmt
name|int
modifier|*
name|pty
decl_stmt|,
modifier|*
name|tty
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|int
name|devindex
decl_stmt|,
name|letter
init|=
literal|0
decl_stmt|;
while|while
condition|(
name|letter
operator|<
literal|4
condition|)
block|{
name|ttydev
index|[
literal|8
index|]
operator|=
name|ptydev
index|[
literal|8
index|]
operator|=
literal|"pqrs"
index|[
name|letter
operator|++
index|]
expr_stmt|;
name|devindex
operator|=
literal|0
expr_stmt|;
while|while
condition|(
name|devindex
operator|<
literal|16
condition|)
block|{
name|ttydev
index|[
literal|9
index|]
operator|=
name|ptydev
index|[
literal|9
index|]
operator|=
literal|"0123456789abcdef"
index|[
name|devindex
operator|++
index|]
expr_stmt|;
if|if
condition|(
operator|(
operator|*
name|pty
operator|=
name|open
argument_list|(
name|ptydev
argument_list|,
name|O_RDWR
argument_list|)
operator|)
operator|<
literal|0
condition|)
continue|continue;
if|if
condition|(
operator|(
operator|*
name|tty
operator|=
name|open
argument_list|(
name|ttydev
argument_list|,
name|O_RDWR
argument_list|)
operator|)
operator|<
literal|0
condition|)
block|{
name|close
argument_list|(
operator|*
name|pty
argument_list|)
expr_stmt|;
continue|continue;
block|}
return|return;
block|}
block|}
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"%s: Not enough available pty's\n"
argument_list|,
name|xterm_name
argument_list|)
expr_stmt|;
name|exit
argument_list|(
name|ERROR_PTYS
argument_list|)
expr_stmt|;
block|}
end_block

begin_if
if|#
directive|if
name|BSD
operator|>=
literal|43
end_if

begin_define
define|#
directive|define
name|TTYGRPNAME
value|"tty"
end_define

begin_comment
comment|/* name of group to own ttys */
end_comment

begin_define
define|#
directive|define
name|TTYGID
parameter_list|(
name|gid
parameter_list|)
value|tty_gid(gid)
end_define

begin_comment
comment|/* gid that owns all ttys */
end_comment

begin_macro
name|tty_gid
argument_list|(
argument|default_gid
argument_list|)
end_macro

begin_decl_stmt
name|int
name|default_gid
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|struct
name|group
modifier|*
name|getgrnam
argument_list|()
decl_stmt|,
modifier|*
name|gr
decl_stmt|;
name|int
name|gid
init|=
name|default_gid
decl_stmt|;
name|gr
operator|=
name|getgrnam
argument_list|(
name|TTYGRPNAME
argument_list|)
expr_stmt|;
if|if
condition|(
name|gr
operator|!=
operator|(
expr|struct
name|group
operator|*
operator|)
literal|0
condition|)
name|gid
operator|=
name|gr
operator|->
name|gr_gid
expr_stmt|;
name|endgrent
argument_list|()
expr_stmt|;
return|return
operator|(
name|gid
operator|)
return|;
block|}
end_block

begin_endif
endif|#
directive|endif
end_endif

begin_macro
name|get_terminal
argument_list|()
end_macro

begin_comment
comment|/*   * sets up X and initializes the terminal structure except for term.buf.fildes.  */
end_comment

begin_block
block|{
specifier|register
name|Screen
modifier|*
name|screen
init|=
operator|&
name|term
operator|.
name|screen
decl_stmt|;
specifier|register
name|int
name|try
decl_stmt|;
name|int
name|on
init|=
literal|1
decl_stmt|;
name|Color
name|cdef
decl_stmt|;
name|char
modifier|*
name|malloc
parameter_list|()
function_decl|;
for|for
control|(
name|try
operator|=
literal|10
init|;
condition|;
control|)
block|{
if|if
condition|(
name|screen
operator|->
name|display
operator|=
name|XOpenDisplay
argument_list|(
name|display
argument_list|)
condition|)
break|break;
if|if
condition|(
operator|!
name|get_ty
condition|)
block|{
ifdef|#
directive|ifdef
name|TIOCCONS
comment|/* 		 * Hack: if console is set, this is probably 		 * the login window from xinit. 		 */
if|if
condition|(
name|Console
condition|)
continue|continue;
endif|#
directive|endif
endif|TIOCCONS
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"%s: No such display server %s\n"
argument_list|,
name|xterm_name
argument_list|,
name|XDisplayName
argument_list|(
name|display
argument_list|)
argument_list|)
expr_stmt|;
name|exit
argument_list|(
name|ERROR_NOX
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|--
name|try
operator|<=
literal|0
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"%s: Can't connect to display server %s\n"
argument_list|,
name|xterm_name
argument_list|,
name|XDisplayName
argument_list|(
name|display
argument_list|)
argument_list|)
expr_stmt|;
name|exit
argument_list|(
name|ERROR_NOX2
argument_list|)
expr_stmt|;
block|}
name|sleep
argument_list|(
literal|5
argument_list|)
expr_stmt|;
block|}
operator|(
name|void
operator|)
name|setsockopt
argument_list|(
name|screen
operator|->
name|display
operator|->
name|fd
argument_list|,
name|SOL_SOCKET
argument_list|,
name|SO_KEEPALIVE
argument_list|,
operator|&
name|on
argument_list|,
sizeof|sizeof
argument_list|(
name|on
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|re_verse
condition|)
block|{
name|B_Pixel
operator|=
name|WhitePixel
expr_stmt|;
name|B_Pixmap
operator|=
name|WhitePixmap
expr_stmt|;
name|W_Pixel
operator|=
name|BlackPixel
expr_stmt|;
name|W_Pixmap
operator|=
name|BlackPixmap
expr_stmt|;
block|}
else|else
block|{
name|B_Pixel
operator|=
name|BlackPixel
expr_stmt|;
name|B_Pixmap
operator|=
name|BlackPixmap
expr_stmt|;
name|W_Pixel
operator|=
name|WhitePixel
expr_stmt|;
name|W_Pixmap
operator|=
name|WhitePixmap
expr_stmt|;
block|}
if|if
condition|(
name|brdr_color
operator|&&
name|DisplayCells
argument_list|()
operator|>
literal|2
operator|&&
name|XParseColor
argument_list|(
name|brdr_color
argument_list|,
operator|&
name|cdef
argument_list|)
operator|&&
name|XGetHardwareColor
argument_list|(
operator|&
name|cdef
argument_list|)
condition|)
block|{
if|if
condition|(
operator|!
operator|(
name|screen
operator|->
name|bordertile
operator|=
name|XMakeTile
argument_list|(
name|cdef
operator|.
name|pixel
argument_list|)
operator|)
condition|)
name|Error
argument_list|(
name|ERROR_BORDER
argument_list|)
expr_stmt|;
block|}
else|else
name|screen
operator|->
name|bordertile
operator|=
name|B_Pixmap
expr_stmt|;
name|screen
operator|->
name|graybordertile
operator|=
name|make_gray
argument_list|()
expr_stmt|;
name|screen
operator|->
name|foreground
operator|=
name|B_Pixel
expr_stmt|;
name|screen
operator|->
name|background
operator|=
name|W_Pixel
expr_stmt|;
name|screen
operator|->
name|cursorcolor
operator|=
name|B_Pixel
expr_stmt|;
name|screen
operator|->
name|mousecolor
operator|=
name|B_Pixel
expr_stmt|;
if|if
condition|(
name|DisplayCells
argument_list|()
operator|>
literal|2
operator|&&
operator|(
name|fore_color
operator|||
name|back_color
operator|||
name|curs_color
operator|)
condition|)
block|{
if|if
condition|(
name|fore_color
operator|&&
name|XParseColor
argument_list|(
name|fore_color
argument_list|,
operator|&
name|cdef
argument_list|)
operator|&&
name|XGetHardwareColor
argument_list|(
operator|&
name|cdef
argument_list|)
condition|)
block|{
name|screen
operator|->
name|foreground
operator|=
name|cdef
operator|.
name|pixel
expr_stmt|;
name|screen
operator|->
name|color
operator||=
name|C_FOREGROUND
expr_stmt|;
block|}
if|if
condition|(
name|back_color
operator|&&
name|XParseColor
argument_list|(
name|back_color
argument_list|,
operator|&
name|cdef
argument_list|)
operator|&&
name|XGetHardwareColor
argument_list|(
operator|&
name|cdef
argument_list|)
condition|)
block|{
name|screen
operator|->
name|background
operator|=
name|cdef
operator|.
name|pixel
expr_stmt|;
name|screen
operator|->
name|color
operator||=
name|C_BACKGROUND
expr_stmt|;
block|}
if|if
condition|(
name|curs_color
operator|&&
name|XParseColor
argument_list|(
name|curs_color
argument_list|,
operator|&
name|cdef
argument_list|)
operator|&&
name|XGetHardwareColor
argument_list|(
operator|&
name|cdef
argument_list|)
condition|)
block|{
name|screen
operator|->
name|cursorcolor
operator|=
name|cdef
operator|.
name|pixel
expr_stmt|;
name|screen
operator|->
name|color
operator||=
name|C_CURSOR
expr_stmt|;
block|}
else|else
name|screen
operator|->
name|cursorcolor
operator|=
name|screen
operator|->
name|foreground
expr_stmt|;
block|}
if|if
condition|(
name|mous_color
operator|&&
name|DisplayCells
argument_list|()
operator|>
literal|2
operator|&&
name|XParseColor
argument_list|(
name|mous_color
argument_list|,
operator|&
name|cdef
argument_list|)
operator|&&
name|XGetHardwareColor
argument_list|(
operator|&
name|cdef
argument_list|)
condition|)
block|{
name|screen
operator|->
name|mousecolor
operator|=
name|cdef
operator|.
name|pixel
expr_stmt|;
name|screen
operator|->
name|color
operator||=
name|C_MOUSE
expr_stmt|;
block|}
else|else
name|screen
operator|->
name|mousecolor
operator|=
name|screen
operator|->
name|cursorcolor
expr_stmt|;
if|if
condition|(
name|screen
operator|->
name|color
operator|&
name|C_BACKGROUND
condition|)
block|{
if|if
condition|(
operator|!
operator|(
name|screen
operator|->
name|bgndtile
operator|=
name|XMakeTile
argument_list|(
name|screen
operator|->
name|background
argument_list|)
operator|)
condition|)
name|Error
argument_list|(
name|ERROR_BACK
argument_list|)
expr_stmt|;
block|}
else|else
name|screen
operator|->
name|bgndtile
operator|=
name|W_Pixmap
expr_stmt|;
name|screen
operator|->
name|arrow
operator|=
name|make_arrow
argument_list|(
name|screen
operator|->
name|mousecolor
argument_list|,
name|screen
operator|->
name|background
argument_list|,
name|GXcopy
argument_list|)
expr_stmt|;
name|XAutoRepeatOn
argument_list|()
expr_stmt|;
if|if
condition|(
operator|(
name|screen
operator|->
name|titlefont
operator|=
name|XOpenFont
argument_list|(
name|f_t
argument_list|)
operator|)
operator|==
name|NULL
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"%s: Can't get title font %s\n"
argument_list|,
name|xterm_name
argument_list|,
name|f_t
argument_list|)
expr_stmt|;
name|exit
argument_list|(
name|ERROR_TITLEFONT
argument_list|)
expr_stmt|;
block|}
name|screen
operator|->
name|title_n_size
operator|=
name|XQueryWidth
argument_list|(
literal|"m"
argument_list|,
name|screen
operator|->
name|titlefont
operator|->
name|id
argument_list|)
expr_stmt|;
name|screen
operator|->
name|titleheight
operator|=
name|screen
operator|->
name|titlefont
operator|->
name|height
operator|+
literal|2
operator|*
name|TITLEPAD
operator|+
literal|1
expr_stmt|;
if|if
condition|(
name|screen
operator|->
name|fullVwin
operator|.
name|titlebar
condition|)
name|screen
operator|->
name|fullVwin
operator|.
name|titlebar
operator|=
name|screen
operator|->
name|fullTwin
operator|.
name|titlebar
operator|=
name|screen
operator|->
name|titleheight
expr_stmt|;
name|IconInit
argument_list|(
name|screen
argument_list|,
name|iconbitmap
argument_list|,
name|tekiconbitmap
argument_list|)
expr_stmt|;
block|}
end_block

begin_decl_stmt
specifier|static
name|char
modifier|*
name|tekterm
index|[]
init|=
block|{
literal|"tek4015"
block|,
literal|"tek4014"
block|,
literal|"tek4013"
block|,
literal|"tek4010"
block|,
literal|"dumb"
block|,
literal|0
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|char
modifier|*
name|vtterm
index|[]
init|=
block|{
literal|"xterms"
block|,
literal|"xterm"
block|,
literal|"vt102"
block|,
literal|"vt100"
block|,
literal|"ansi"
block|,
literal|"dumb"
block|,
literal|0
block|}
decl_stmt|;
end_decl_stmt

begin_macro
name|spawn
argument_list|()
end_macro

begin_comment
comment|/*   *  Inits pty and tty and forks a login process.  *  Does not close fd Xsocket.  *  If getty,  execs getty rather than csh and uses std fd's rather  *  than opening a pty/tty pair.  *  If slave, the pty named in passedPty is already open for use  */
end_comment

begin_block
block|{
specifier|register
name|Screen
modifier|*
name|screen
init|=
operator|&
name|term
operator|.
name|screen
decl_stmt|;
name|int
name|Xsocket
init|=
name|screen
operator|->
name|display
operator|->
name|fd
decl_stmt|;
name|int
name|index1
decl_stmt|,
name|tty
init|=
operator|-
literal|1
decl_stmt|;
name|int
name|discipline
decl_stmt|;
name|unsigned
name|lmode
decl_stmt|;
name|struct
name|tchars
name|tc
decl_stmt|;
name|struct
name|ltchars
name|ltc
decl_stmt|;
name|struct
name|sgttyb
name|sg
decl_stmt|;
name|char
name|termcap
index|[
literal|1024
index|]
decl_stmt|;
name|char
name|newtc
index|[
literal|1024
index|]
decl_stmt|;
name|char
modifier|*
name|ptr
decl_stmt|,
modifier|*
name|shname
decl_stmt|;
name|int
name|i
decl_stmt|,
name|no_dev_tty
init|=
name|FALSE
decl_stmt|;
name|char
modifier|*
modifier|*
name|envnew
decl_stmt|;
comment|/* new environment */
name|char
name|buf
index|[
literal|32
index|]
decl_stmt|;
name|char
modifier|*
name|TermName
init|=
name|NULL
decl_stmt|;
name|int
name|ldisc
init|=
literal|0
decl_stmt|;
ifdef|#
directive|ifdef
name|sun
ifdef|#
directive|ifdef
name|TIOCSSIZE
name|struct
name|ttysize
name|ts
decl_stmt|;
endif|#
directive|endif
endif|TIOCSSIZE
else|#
directive|else
else|sun
ifdef|#
directive|ifdef
name|TIOCSWINSZ
name|struct
name|winsize
name|ws
decl_stmt|;
endif|#
directive|endif
endif|TIOCSWINSZ
endif|#
directive|endif
endif|sun
name|struct
name|passwd
modifier|*
name|pw
init|=
name|NULL
decl_stmt|;
ifdef|#
directive|ifdef
name|UTMP
name|struct
name|utmp
name|utmp
decl_stmt|;
endif|#
directive|endif
endif|UTMP
specifier|extern
name|int
name|Exit
parameter_list|()
function_decl|;
name|struct
name|passwd
modifier|*
name|getpwuid
parameter_list|()
function_decl|;
name|char
modifier|*
name|getenv
parameter_list|()
function_decl|;
name|char
modifier|*
name|index
argument_list|()
decl_stmt|,
modifier|*
name|rindex
argument_list|()
decl_stmt|,
modifier|*
name|strindex
argument_list|()
decl_stmt|;
name|screen
operator|->
name|uid
operator|=
name|getuid
argument_list|()
expr_stmt|;
name|screen
operator|->
name|gid
operator|=
name|getgid
argument_list|()
expr_stmt|;
ifdef|#
directive|ifdef
name|UTMP
name|added_utmp_entry
operator|=
name|FALSE
expr_stmt|;
endif|#
directive|endif
endif|UTMP
comment|/* so that TIOCSWINSZ || TIOCSIZE doesn't block */
name|signal
argument_list|(
name|SIGTTOU
argument_list|,
name|SIG_IGN
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|screen
operator|->
name|TekEmu
condition|?
name|TekInit
argument_list|()
else|:
name|VTInit
argument_list|()
operator|)
condition|)
name|exit
argument_list|(
name|ERROR_INIT
argument_list|)
expr_stmt|;
if|if
condition|(
name|screen
operator|->
name|TekEmu
condition|)
block|{
name|envnew
operator|=
name|tekterm
expr_stmt|;
name|ptr
operator|=
name|newtc
expr_stmt|;
block|}
else|else
block|{
comment|/* 		 * Special case of a 80x24 window, use "xterms" 		 */
name|envnew
operator|=
operator|(
name|screen
operator|->
name|max_col
operator|==
literal|79
operator|&&
name|screen
operator|->
name|max_row
operator|==
literal|23
operator|)
condition|?
name|vtterm
else|:
operator|&
name|vtterm
index|[
literal|1
index|]
expr_stmt|;
name|ptr
operator|=
name|termcap
expr_stmt|;
block|}
while|while
condition|(
operator|*
name|envnew
condition|)
block|{
if|if
condition|(
name|tgetent
argument_list|(
name|ptr
argument_list|,
operator|*
name|envnew
argument_list|)
operator|==
literal|1
condition|)
block|{
name|TermName
operator|=
operator|*
name|envnew
expr_stmt|;
if|if
condition|(
operator|!
name|screen
operator|->
name|TekEmu
condition|)
name|resize
argument_list|(
name|screen
argument_list|,
name|TermName
argument_list|,
name|termcap
argument_list|,
name|newtc
argument_list|)
expr_stmt|;
break|break;
block|}
name|envnew
operator|++
expr_stmt|;
block|}
if|if
condition|(
name|get_ty
condition|)
block|{
name|screen
operator|->
name|respond
operator|=
name|loginpty
expr_stmt|;
if|if
condition|(
operator|(
name|tslot
operator|=
name|ttyslot
argument_list|()
operator|)
operator|<=
literal|0
condition|)
name|SysError
argument_list|(
name|ERROR_TSLOT
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|TIOCCONS
if|if
condition|(
name|Console
condition|)
block|{
name|int
name|on
init|=
literal|1
decl_stmt|;
if|if
condition|(
name|ioctl
argument_list|(
name|tty
argument_list|,
name|TIOCCONS
argument_list|,
operator|&
name|on
argument_list|)
operator|==
operator|-
literal|1
condition|)
block|{
name|perror
argument_list|(
literal|"xterm: ioctl TIOCCONS"
argument_list|)
expr_stmt|;
name|Console
operator|=
literal|0
expr_stmt|;
block|}
block|}
endif|#
directive|endif
endif|TIOCCONS
block|}
elseif|else
if|if
condition|(
name|am_slave
condition|)
block|{
name|screen
operator|->
name|respond
operator|=
name|am_slave
expr_stmt|;
name|ptydev
index|[
literal|8
index|]
operator|=
name|ttydev
index|[
literal|8
index|]
operator|=
name|passedPty
index|[
literal|0
index|]
expr_stmt|;
name|ptydev
index|[
literal|9
index|]
operator|=
name|ttydev
index|[
literal|9
index|]
operator|=
name|passedPty
index|[
literal|1
index|]
expr_stmt|;
if|if
condition|(
operator|(
name|tslot
operator|=
name|ttyslot
argument_list|()
operator|)
operator|<=
literal|0
condition|)
name|SysError
argument_list|(
name|ERROR_TSLOT2
argument_list|)
expr_stmt|;
name|setgid
argument_list|(
name|screen
operator|->
name|gid
argument_list|)
expr_stmt|;
name|setuid
argument_list|(
name|screen
operator|->
name|uid
argument_list|)
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
operator|(
name|tty
operator|=
name|open
argument_list|(
literal|"/dev/tty"
argument_list|,
name|O_RDWR
argument_list|,
literal|0
argument_list|)
operator|)
operator|<
literal|0
condition|)
block|{
if|if
condition|(
name|errno
operator|!=
name|ENXIO
condition|)
name|SysError
argument_list|(
name|ERROR_OPDEVTTY
argument_list|)
expr_stmt|;
else|else
block|{
name|no_dev_tty
operator|=
name|TRUE
expr_stmt|;
name|sg
operator|=
name|d_sg
expr_stmt|;
name|tc
operator|=
name|d_tc
expr_stmt|;
name|discipline
operator|=
name|d_disipline
expr_stmt|;
name|ltc
operator|=
name|d_ltc
expr_stmt|;
name|lmode
operator|=
name|d_lmode
expr_stmt|;
block|}
block|}
else|else
block|{
comment|/* get a copy of the current terminal's state */
if|if
condition|(
name|ioctl
argument_list|(
name|tty
argument_list|,
name|TIOCGETP
argument_list|,
operator|&
name|sg
argument_list|)
operator|==
operator|-
literal|1
condition|)
name|SysError
argument_list|(
name|ERROR_TIOCGETP
argument_list|)
expr_stmt|;
if|if
condition|(
name|ioctl
argument_list|(
name|tty
argument_list|,
name|TIOCGETC
argument_list|,
operator|&
name|tc
argument_list|)
operator|==
operator|-
literal|1
condition|)
name|SysError
argument_list|(
name|ERROR_TIOCGETC
argument_list|)
expr_stmt|;
if|if
condition|(
name|ioctl
argument_list|(
name|tty
argument_list|,
name|TIOCGETD
argument_list|,
operator|&
name|discipline
argument_list|)
operator|==
operator|-
literal|1
condition|)
name|SysError
argument_list|(
name|ERROR_TIOCGETD
argument_list|)
expr_stmt|;
if|if
condition|(
name|ioctl
argument_list|(
name|tty
argument_list|,
name|TIOCGLTC
argument_list|,
operator|&
name|ltc
argument_list|)
operator|==
operator|-
literal|1
condition|)
name|SysError
argument_list|(
name|ERROR_TIOCGLTC
argument_list|)
expr_stmt|;
if|if
condition|(
name|ioctl
argument_list|(
name|tty
argument_list|,
name|TIOCLGET
argument_list|,
operator|&
name|lmode
argument_list|)
operator|==
operator|-
literal|1
condition|)
name|SysError
argument_list|(
name|ERROR_TIOCLGET
argument_list|)
expr_stmt|;
name|close
argument_list|(
name|tty
argument_list|)
expr_stmt|;
comment|/* close all std file descriptors */
for|for
control|(
name|index1
operator|=
literal|0
init|;
name|index1
operator|<
literal|3
condition|;
name|index1
operator|++
control|)
name|close
argument_list|(
name|index1
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|tty
operator|=
name|open
argument_list|(
literal|"/dev/tty"
argument_list|,
name|O_RDWR
argument_list|,
literal|0
argument_list|)
operator|)
operator|<
literal|0
condition|)
name|SysError
argument_list|(
name|ERROR_OPDEVTTY2
argument_list|)
expr_stmt|;
if|if
condition|(
name|ioctl
argument_list|(
name|tty
argument_list|,
name|TIOCNOTTY
argument_list|,
literal|0
argument_list|)
operator|==
operator|-
literal|1
condition|)
name|SysError
argument_list|(
name|ERROR_NOTTY
argument_list|)
expr_stmt|;
name|close
argument_list|(
name|tty
argument_list|)
expr_stmt|;
block|}
name|get_pty
argument_list|(
operator|&
name|screen
operator|->
name|respond
argument_list|,
operator|&
name|tty
argument_list|)
expr_stmt|;
if|if
condition|(
name|screen
operator|->
name|respond
operator|!=
name|Xsocket
operator|+
literal|1
condition|)
block|{
name|dup2
argument_list|(
name|screen
operator|->
name|respond
argument_list|,
name|Xsocket
operator|+
literal|1
argument_list|)
expr_stmt|;
name|close
argument_list|(
name|screen
operator|->
name|respond
argument_list|)
expr_stmt|;
name|screen
operator|->
name|respond
operator|=
name|Xsocket
operator|+
literal|1
expr_stmt|;
block|}
if|#
directive|if
name|BSD
operator|>=
literal|43
comment|/* change ownership of tty to real user id and tty gid */
name|chown
argument_list|(
name|ttydev
argument_list|,
name|screen
operator|->
name|uid
argument_list|,
name|TTYGID
argument_list|(
name|screen
operator|->
name|gid
argument_list|)
argument_list|)
expr_stmt|;
comment|/* change protection of tty */
name|chmod
argument_list|(
name|ttydev
argument_list|,
literal|0620
argument_list|)
expr_stmt|;
else|#
directive|else
comment|/* change ownership of tty to real group and user id */
name|chown
argument_list|(
name|ttydev
argument_list|,
name|screen
operator|->
name|uid
argument_list|,
name|screen
operator|->
name|gid
argument_list|)
expr_stmt|;
comment|/* change protection of tty */
name|chmod
argument_list|(
name|ttydev
argument_list|,
literal|0622
argument_list|)
expr_stmt|;
endif|#
directive|endif
if|if
condition|(
name|tty
operator|!=
name|Xsocket
operator|+
literal|2
condition|)
block|{
name|dup2
argument_list|(
name|tty
argument_list|,
name|Xsocket
operator|+
literal|2
argument_list|)
expr_stmt|;
name|close
argument_list|(
name|tty
argument_list|)
expr_stmt|;
name|tty
operator|=
name|Xsocket
operator|+
literal|2
expr_stmt|;
block|}
comment|/* set the new terminal's state to be the old one's  		   with minor modifications for efficiency */
name|sg
operator|.
name|sg_flags
operator|&=
operator|~
operator|(
name|ALLDELAY
operator||
name|XTABS
operator||
name|CBREAK
operator||
name|RAW
operator|)
expr_stmt|;
name|sg
operator|.
name|sg_flags
operator||=
name|ECHO
operator||
name|CRMOD
expr_stmt|;
comment|/* make sure speed is set on pty so that editors work right*/
name|sg
operator|.
name|sg_ispeed
operator|=
name|B9600
expr_stmt|;
name|sg
operator|.
name|sg_ospeed
operator|=
name|B9600
expr_stmt|;
comment|/* reset t_brkc to default value */
name|tc
operator|.
name|t_brkc
operator|=
operator|-
literal|1
expr_stmt|;
if|if
condition|(
name|ioctl
argument_list|(
name|tty
argument_list|,
name|TIOCSETP
argument_list|,
operator|&
name|sg
argument_list|)
operator|==
operator|-
literal|1
condition|)
name|SysError
argument_list|(
name|ERROR_TIOCSETP
argument_list|)
expr_stmt|;
if|if
condition|(
name|ioctl
argument_list|(
name|tty
argument_list|,
name|TIOCSETC
argument_list|,
operator|&
name|tc
argument_list|)
operator|==
operator|-
literal|1
condition|)
name|SysError
argument_list|(
name|ERROR_TIOCSETC
argument_list|)
expr_stmt|;
if|if
condition|(
name|ioctl
argument_list|(
name|tty
argument_list|,
name|TIOCSETD
argument_list|,
operator|&
name|discipline
argument_list|)
operator|==
operator|-
literal|1
condition|)
name|SysError
argument_list|(
name|ERROR_TIOCSETD
argument_list|)
expr_stmt|;
if|if
condition|(
name|ioctl
argument_list|(
name|tty
argument_list|,
name|TIOCSLTC
argument_list|,
operator|&
name|ltc
argument_list|)
operator|==
operator|-
literal|1
condition|)
name|SysError
argument_list|(
name|ERROR_TIOCSLTC
argument_list|)
expr_stmt|;
if|if
condition|(
name|ioctl
argument_list|(
name|tty
argument_list|,
name|TIOCLSET
argument_list|,
operator|&
name|lmode
argument_list|)
operator|==
operator|-
literal|1
condition|)
name|SysError
argument_list|(
name|ERROR_TIOCLSET
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|TIOCCONS
if|if
condition|(
name|Console
condition|)
block|{
name|int
name|on
init|=
literal|1
decl_stmt|;
if|if
condition|(
name|ioctl
argument_list|(
name|tty
argument_list|,
name|TIOCCONS
argument_list|,
operator|&
name|on
argument_list|)
operator|==
operator|-
literal|1
condition|)
block|{
name|perror
argument_list|(
literal|"xterm: ioctl TIOCCONS"
argument_list|)
expr_stmt|;
name|Console
operator|=
literal|0
expr_stmt|;
block|}
block|}
endif|#
directive|endif
endif|TIOCCONS
name|close
argument_list|(
name|open
argument_list|(
literal|"/dev/null"
argument_list|,
name|O_RDWR
argument_list|,
literal|0
argument_list|)
argument_list|)
expr_stmt|;
for|for
control|(
name|index1
operator|=
literal|0
init|;
name|index1
operator|<
literal|3
condition|;
name|index1
operator|++
control|)
name|dup2
argument_list|(
name|tty
argument_list|,
name|index1
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|tslot
operator|=
name|ttyslot
argument_list|()
operator|)
operator|<=
literal|0
condition|)
name|SysError
argument_list|(
name|ERROR_TSLOT3
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|UTMP
if|if
condition|(
name|login_shell
operator|&&
operator|(
name|pw
operator|=
name|getpwuid
argument_list|(
name|screen
operator|->
name|uid
argument_list|)
operator|)
operator|&&
operator|(
name|i
operator|=
name|open
argument_list|(
name|etc_utmp
argument_list|,
name|O_WRONLY
argument_list|)
operator|)
operator|>=
literal|0
condition|)
block|{
name|bzero
argument_list|(
operator|(
name|char
operator|*
operator|)
operator|&
name|utmp
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|utmp
argument_list|)
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|strcpy
argument_list|(
name|utmp
operator|.
name|ut_line
argument_list|,
operator|&
name|ttydev
index|[
literal|5
index|]
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|strcpy
argument_list|(
name|utmp
operator|.
name|ut_name
argument_list|,
name|pw
operator|->
name|pw_name
argument_list|)
expr_stmt|;
if|if
condition|(
name|strncmp
argument_list|(
name|DisplayName
argument_list|()
argument_list|,
literal|"unix:"
argument_list|,
literal|5
argument_list|)
operator|!=
literal|0
condition|)
operator|(
name|void
operator|)
name|strcpy
argument_list|(
name|utmp
operator|.
name|ut_host
argument_list|,
name|DisplayName
argument_list|()
argument_list|)
expr_stmt|;
name|time
argument_list|(
operator|&
name|utmp
operator|.
name|ut_time
argument_list|)
expr_stmt|;
name|lseek
argument_list|(
name|i
argument_list|,
call|(
name|long
call|)
argument_list|(
name|tslot
operator|*
sizeof|sizeof
argument_list|(
expr|struct
name|utmp
argument_list|)
argument_list|)
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|write
argument_list|(
name|i
argument_list|,
operator|(
name|char
operator|*
operator|)
operator|&
name|utmp
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|utmp
argument_list|)
argument_list|)
expr_stmt|;
name|close
argument_list|(
name|i
argument_list|)
expr_stmt|;
name|added_utmp_entry
operator|=
name|TRUE
expr_stmt|;
block|}
endif|#
directive|endif
endif|UTMP
block|}
ifdef|#
directive|ifdef
name|sun
ifdef|#
directive|ifdef
name|TIOCSSIZE
comment|/* tell tty how big window is */
if|if
condition|(
name|screen
operator|->
name|TekEmu
condition|)
block|{
name|ts
operator|.
name|ts_lines
operator|=
literal|38
expr_stmt|;
name|ts
operator|.
name|ts_cols
operator|=
literal|81
expr_stmt|;
block|}
else|else
block|{
name|ts
operator|.
name|ts_lines
operator|=
name|screen
operator|->
name|max_row
operator|+
literal|1
expr_stmt|;
name|ts
operator|.
name|ts_cols
operator|=
name|screen
operator|->
name|max_col
operator|+
literal|1
expr_stmt|;
block|}
name|ioctl
argument_list|(
name|screen
operator|->
name|respond
argument_list|,
name|TIOCSSIZE
argument_list|,
operator|&
name|ts
argument_list|)
expr_stmt|;
endif|#
directive|endif
endif|TIOCSSIZE
else|#
directive|else
else|sun
ifdef|#
directive|ifdef
name|TIOCSWINSZ
comment|/* tell tty how big window is */
if|if
condition|(
name|screen
operator|->
name|TekEmu
condition|)
block|{
name|ws
operator|.
name|ws_row
operator|=
literal|38
expr_stmt|;
name|ws
operator|.
name|ws_col
operator|=
literal|81
expr_stmt|;
name|ws
operator|.
name|ws_xpixel
operator|=
name|TFullWidth
argument_list|(
name|screen
argument_list|)
expr_stmt|;
name|ws
operator|.
name|ws_ypixel
operator|=
name|TFullHeight
argument_list|(
name|screen
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|ws
operator|.
name|ws_row
operator|=
name|screen
operator|->
name|max_row
operator|+
literal|1
expr_stmt|;
name|ws
operator|.
name|ws_col
operator|=
name|screen
operator|->
name|max_col
operator|+
literal|1
expr_stmt|;
name|ws
operator|.
name|ws_xpixel
operator|=
name|FullWidth
argument_list|(
name|screen
argument_list|)
expr_stmt|;
name|ws
operator|.
name|ws_ypixel
operator|=
name|FullHeight
argument_list|(
name|screen
argument_list|)
expr_stmt|;
block|}
name|ioctl
argument_list|(
name|screen
operator|->
name|respond
argument_list|,
name|TIOCSWINSZ
argument_list|,
operator|&
name|ws
argument_list|)
expr_stmt|;
endif|#
directive|endif
endif|TIOCSWINSZ
endif|#
directive|endif
endif|sun
if|if
condition|(
operator|!
name|am_slave
condition|)
block|{
if|if
condition|(
operator|(
name|screen
operator|->
name|pid
operator|=
name|fork
argument_list|()
operator|)
operator|==
operator|-
literal|1
condition|)
name|SysError
argument_list|(
name|ERROR_FORK
argument_list|)
expr_stmt|;
if|if
condition|(
name|screen
operator|->
name|pid
operator|==
literal|0
condition|)
block|{
specifier|extern
name|char
modifier|*
modifier|*
name|environ
decl_stmt|;
name|int
name|pgrp
init|=
name|getpid
argument_list|()
decl_stmt|;
name|char
name|shell_name
index|[
literal|64
index|]
decl_stmt|;
name|close
argument_list|(
name|Xsocket
argument_list|)
expr_stmt|;
name|close
argument_list|(
name|screen
operator|->
name|respond
argument_list|)
expr_stmt|;
if|if
condition|(
name|fileno
argument_list|(
name|stderr
argument_list|)
operator|>=
literal|3
condition|)
name|close
argument_list|(
name|fileno
argument_list|(
name|stderr
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|tty
operator|>=
literal|0
condition|)
name|close
argument_list|(
name|tty
argument_list|)
expr_stmt|;
name|signal
argument_list|(
name|SIGCHLD
argument_list|,
name|SIG_DFL
argument_list|)
expr_stmt|;
name|signal
argument_list|(
name|SIGHUP
argument_list|,
name|SIG_IGN
argument_list|)
expr_stmt|;
comment|/* copy the environment before Setenving */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|environ
index|[
name|i
index|]
operator|!=
name|NULL
condition|;
name|i
operator|++
control|)
empty_stmt|;
comment|/* 		 * The `4' is the number of Setenv() calls which may add 		 * a new entry to the environment.  The `1' is for the 		 * NULL terminating entry. 		 */
name|envnew
operator|=
operator|(
name|char
operator|*
operator|*
operator|)
name|calloc
argument_list|(
name|i
operator|+
operator|(
literal|4
operator|+
literal|1
operator|)
argument_list|,
sizeof|sizeof
argument_list|(
name|char
operator|*
argument_list|)
argument_list|)
expr_stmt|;
name|bcopy
argument_list|(
operator|(
name|char
operator|*
operator|)
name|environ
argument_list|,
operator|(
name|char
operator|*
operator|)
name|envnew
argument_list|,
name|i
operator|*
sizeof|sizeof
argument_list|(
name|char
operator|*
argument_list|)
argument_list|)
expr_stmt|;
name|environ
operator|=
name|envnew
expr_stmt|;
name|Setenv
argument_list|(
literal|"TERM="
argument_list|,
name|TermName
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|TermName
condition|)
operator|*
name|newtc
operator|=
literal|0
expr_stmt|;
name|Setenv
argument_list|(
literal|"TERMCAP="
argument_list|,
name|newtc
argument_list|)
expr_stmt|;
name|sprintf
argument_list|(
name|buf
argument_list|,
literal|"%d"
argument_list|,
name|screen
operator|->
name|TekEmu
condition|?
operator|(
name|int
operator|)
name|TWindow
argument_list|(
name|screen
argument_list|)
else|:
operator|(
name|int
operator|)
name|VWindow
argument_list|(
name|screen
argument_list|)
argument_list|)
expr_stmt|;
name|Setenv
argument_list|(
literal|"WINDOWID="
argument_list|,
name|buf
argument_list|)
expr_stmt|;
comment|/* put the display into the environment of the shell*/
if|if
condition|(
name|display
index|[
literal|0
index|]
operator|!=
literal|'\0'
condition|)
name|Setenv
argument_list|(
literal|"DISPLAY="
argument_list|,
name|screen
operator|->
name|display
operator|->
name|displayname
argument_list|)
expr_stmt|;
name|signal
argument_list|(
name|SIGTERM
argument_list|,
name|SIG_DFL
argument_list|)
expr_stmt|;
name|ioctl
argument_list|(
literal|0
argument_list|,
name|TIOCSPGRP
argument_list|,
operator|&
name|pgrp
argument_list|)
expr_stmt|;
name|setpgrp
argument_list|(
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|close
argument_list|(
name|open
argument_list|(
name|ttyname
argument_list|(
literal|0
argument_list|)
argument_list|,
name|O_WRONLY
argument_list|,
literal|0
argument_list|)
argument_list|)
expr_stmt|;
name|setpgrp
argument_list|(
literal|0
argument_list|,
name|pgrp
argument_list|)
expr_stmt|;
name|setgid
argument_list|(
name|screen
operator|->
name|gid
argument_list|)
expr_stmt|;
name|setuid
argument_list|(
name|screen
operator|->
name|uid
argument_list|)
expr_stmt|;
if|if
condition|(
name|command_to_exec
condition|)
block|{
name|execvp
argument_list|(
operator|*
name|command_to_exec
argument_list|,
name|command_to_exec
argument_list|)
expr_stmt|;
comment|/* print error message on screen */
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"%s: Can't execvp %s\n"
argument_list|,
name|xterm_name
argument_list|,
operator|*
name|command_to_exec
argument_list|)
expr_stmt|;
block|}
name|signal
argument_list|(
name|SIGHUP
argument_list|,
name|SIG_IGN
argument_list|)
expr_stmt|;
if|if
condition|(
name|get_ty
condition|)
block|{
name|ioctl
argument_list|(
literal|0
argument_list|,
name|TIOCNOTTY
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|execl
argument_list|(
literal|"/etc/getty"
argument_list|,
literal|"+"
argument_list|,
literal|"Xwindow"
argument_list|,
name|get_ty
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
name|signal
argument_list|(
name|SIGHUP
argument_list|,
name|SIG_DFL
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|UTMP
if|if
condition|(
operator|(
operator|(
name|ptr
operator|=
name|getenv
argument_list|(
literal|"SHELL"
argument_list|)
operator|)
operator|==
name|NULL
operator|||
operator|*
name|ptr
operator|==
literal|0
operator|)
operator|&&
operator|(
operator|(
name|pw
operator|==
name|NULL
operator|&&
operator|(
name|pw
operator|=
name|getpwuid
argument_list|(
name|screen
operator|->
name|uid
argument_list|)
operator|)
operator|==
name|NULL
operator|)
operator|||
operator|*
operator|(
name|ptr
operator|=
name|pw
operator|->
name|pw_shell
operator|)
operator|==
literal|0
operator|)
condition|)
else|#
directive|else
else|UTMP
if|if
condition|(
operator|(
operator|(
name|ptr
operator|=
name|getenv
argument_list|(
literal|"SHELL"
argument_list|)
operator|)
operator|==
name|NULL
operator|||
operator|*
name|ptr
operator|==
literal|0
operator|)
operator|&&
operator|(
operator|(
name|pw
operator|=
name|getpwuid
argument_list|(
name|screen
operator|->
name|uid
argument_list|)
operator|)
operator|==
name|NULL
operator|||
operator|*
operator|(
name|ptr
operator|=
name|pw
operator|->
name|pw_shell
operator|)
operator|==
literal|0
operator|)
condition|)
endif|#
directive|endif
endif|UTMP
name|ptr
operator|=
literal|"/bin/sh"
expr_stmt|;
if|if
condition|(
name|shname
operator|=
name|rindex
argument_list|(
name|ptr
argument_list|,
literal|'/'
argument_list|)
condition|)
name|shname
operator|++
expr_stmt|;
else|else
name|shname
operator|=
name|ptr
expr_stmt|;
name|i
operator|=
name|strlen
argument_list|(
name|shname
argument_list|)
operator|-
literal|3
expr_stmt|;
name|ldisc
operator|=
operator|(
name|strcmp
argument_list|(
literal|"csh"
argument_list|,
name|shname
operator|+
name|i
argument_list|)
operator|==
literal|0
operator|||
name|strcmp
argument_list|(
literal|"ksh"
argument_list|,
name|shname
operator|+
name|i
argument_list|)
operator|==
literal|0
operator|)
condition|?
name|NTTYDISC
else|:
literal|0
expr_stmt|;
name|ioctl
argument_list|(
literal|0
argument_list|,
name|TIOCSETD
argument_list|,
operator|&
name|ldisc
argument_list|)
expr_stmt|;
if|if
condition|(
name|login_shell
condition|)
block|{
name|strcpy
argument_list|(
name|shell_name
argument_list|,
literal|"-"
argument_list|)
expr_stmt|;
name|strcat
argument_list|(
name|shell_name
argument_list|,
name|shname
argument_list|)
expr_stmt|;
block|}
else|else
name|strcpy
argument_list|(
name|shell_name
argument_list|,
name|shname
argument_list|)
expr_stmt|;
name|execl
argument_list|(
name|ptr
argument_list|,
name|shell_name
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"%s: Could not exec %s!\n"
argument_list|,
name|xterm_name
argument_list|,
name|ptr
argument_list|)
expr_stmt|;
name|sleep
argument_list|(
literal|5
argument_list|)
expr_stmt|;
name|exit
argument_list|(
name|ERROR_EXEC
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
name|tty
operator|>=
literal|0
condition|)
name|close
argument_list|(
name|tty
argument_list|)
expr_stmt|;
name|signal
argument_list|(
name|SIGHUP
argument_list|,
name|SIG_IGN
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|no_dev_tty
condition|)
block|{
if|if
condition|(
operator|(
name|tty
operator|=
name|open
argument_list|(
literal|"/dev/tty"
argument_list|,
name|O_RDWR
argument_list|,
literal|0
argument_list|)
operator|)
operator|<
literal|0
condition|)
name|SysError
argument_list|(
name|ERROR_OPDEVTTY3
argument_list|)
expr_stmt|;
for|for
control|(
name|index1
operator|=
literal|0
init|;
name|index1
operator|<
literal|3
condition|;
name|index1
operator|++
control|)
name|dup2
argument_list|(
name|tty
argument_list|,
name|index1
argument_list|)
expr_stmt|;
if|if
condition|(
name|tty
operator|>
literal|2
condition|)
name|close
argument_list|(
name|tty
argument_list|)
expr_stmt|;
block|}
name|signal
argument_list|(
name|SIGINT
argument_list|,
name|Exit
argument_list|)
expr_stmt|;
name|signal
argument_list|(
name|SIGQUIT
argument_list|,
name|Exit
argument_list|)
expr_stmt|;
name|signal
argument_list|(
name|SIGTERM
argument_list|,
name|Exit
argument_list|)
expr_stmt|;
block|}
end_block

begin_macro
name|Exit
argument_list|(
argument|n
argument_list|)
end_macro

begin_decl_stmt
name|int
name|n
decl_stmt|;
end_decl_stmt

begin_block
block|{
specifier|register
name|Screen
modifier|*
name|screen
init|=
operator|&
name|term
operator|.
name|screen
decl_stmt|;
ifdef|#
directive|ifdef
name|UTMP
specifier|register
name|int
name|i
decl_stmt|;
name|struct
name|utmp
name|utmp
decl_stmt|;
if|if
condition|(
name|added_utmp_entry
operator|&&
operator|(
name|i
operator|=
name|open
argument_list|(
name|etc_utmp
argument_list|,
name|O_WRONLY
argument_list|)
operator|)
operator|>=
literal|0
condition|)
block|{
name|bzero
argument_list|(
operator|(
name|char
operator|*
operator|)
operator|&
name|utmp
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|utmp
argument_list|)
argument_list|)
expr_stmt|;
name|lseek
argument_list|(
name|i
argument_list|,
call|(
name|long
call|)
argument_list|(
name|tslot
operator|*
sizeof|sizeof
argument_list|(
expr|struct
name|utmp
argument_list|)
argument_list|)
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|write
argument_list|(
name|i
argument_list|,
operator|(
name|char
operator|*
operator|)
operator|&
name|utmp
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|utmp
argument_list|)
argument_list|)
expr_stmt|;
name|close
argument_list|(
name|i
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
endif|UTMP
if|if
condition|(
name|screen
operator|->
name|logging
condition|)
name|CloseLog
argument_list|(
name|screen
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|get_ty
operator|&&
operator|!
name|am_slave
condition|)
block|{
comment|/* restore ownership of tty */
name|chown
argument_list|(
name|ttydev
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* restore modes of tty */
name|chmod
argument_list|(
name|ttydev
argument_list|,
literal|0666
argument_list|)
expr_stmt|;
block|}
operator|(
name|void
operator|)
name|close
argument_list|(
name|screen
operator|->
name|respond
argument_list|)
expr_stmt|;
name|exit
argument_list|(
name|n
argument_list|)
expr_stmt|;
block|}
end_block

begin_macro
name|resize
argument_list|(
argument|screen
argument_list|,
argument|TermName
argument_list|,
argument|oldtc
argument_list|,
argument|newtc
argument_list|)
end_macro

begin_decl_stmt
name|Screen
modifier|*
name|screen
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|char
modifier|*
name|TermName
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|register
name|char
modifier|*
name|oldtc
decl_stmt|,
modifier|*
name|newtc
decl_stmt|;
end_decl_stmt

begin_block
block|{
specifier|register
name|char
modifier|*
name|ptr1
decl_stmt|,
modifier|*
name|ptr2
decl_stmt|;
specifier|register
name|int
name|i
decl_stmt|;
specifier|register
name|int
name|li_first
init|=
literal|0
decl_stmt|;
specifier|register
name|char
modifier|*
name|temp
decl_stmt|;
name|char
modifier|*
name|index
argument_list|()
decl_stmt|,
modifier|*
name|strindex
argument_list|()
decl_stmt|;
if|if
condition|(
operator|(
name|ptr1
operator|=
name|strindex
argument_list|(
name|oldtc
argument_list|,
literal|"co#"
argument_list|)
operator|)
operator|==
name|NULL
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"%s: Can't find co# in termcap string %s\n"
argument_list|,
name|xterm_name
argument_list|,
name|TermName
argument_list|)
expr_stmt|;
name|exit
argument_list|(
name|ERROR_NOCO
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|ptr2
operator|=
name|strindex
argument_list|(
name|oldtc
argument_list|,
literal|"li#"
argument_list|)
operator|)
operator|==
name|NULL
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"%s: Can't find li# in termcap string %s\n"
argument_list|,
name|xterm_name
argument_list|,
name|TermName
argument_list|)
expr_stmt|;
name|exit
argument_list|(
name|ERROR_NOLI
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|ptr1
operator|>
name|ptr2
condition|)
block|{
name|li_first
operator|++
expr_stmt|;
name|temp
operator|=
name|ptr1
expr_stmt|;
name|ptr1
operator|=
name|ptr2
expr_stmt|;
name|ptr2
operator|=
name|temp
expr_stmt|;
block|}
name|ptr1
operator|+=
literal|3
expr_stmt|;
name|ptr2
operator|+=
literal|3
expr_stmt|;
name|strncpy
argument_list|(
name|newtc
argument_list|,
name|oldtc
argument_list|,
name|i
operator|=
name|ptr1
operator|-
name|oldtc
argument_list|)
expr_stmt|;
name|newtc
operator|+=
name|i
expr_stmt|;
name|sprintf
argument_list|(
name|newtc
argument_list|,
literal|"%d"
argument_list|,
name|li_first
condition|?
name|screen
operator|->
name|max_row
operator|+
literal|1
else|:
name|screen
operator|->
name|max_col
operator|+
literal|1
argument_list|)
expr_stmt|;
name|newtc
operator|+=
name|strlen
argument_list|(
name|newtc
argument_list|)
expr_stmt|;
name|ptr1
operator|=
name|index
argument_list|(
name|ptr1
argument_list|,
literal|':'
argument_list|)
expr_stmt|;
name|strncpy
argument_list|(
name|newtc
argument_list|,
name|ptr1
argument_list|,
name|i
operator|=
name|ptr2
operator|-
name|ptr1
argument_list|)
expr_stmt|;
name|newtc
operator|+=
name|i
expr_stmt|;
name|sprintf
argument_list|(
name|newtc
argument_list|,
literal|"%d"
argument_list|,
name|li_first
condition|?
name|screen
operator|->
name|max_col
operator|+
literal|1
else|:
name|screen
operator|->
name|max_row
operator|+
literal|1
argument_list|)
expr_stmt|;
name|ptr2
operator|=
name|index
argument_list|(
name|ptr2
argument_list|,
literal|':'
argument_list|)
expr_stmt|;
name|strcat
argument_list|(
name|newtc
argument_list|,
name|ptr2
argument_list|)
expr_stmt|;
block|}
end_block

begin_expr_stmt
specifier|static
name|reapchild
argument_list|()
block|{
expr|union
name|wait
name|status
block|;
specifier|register
name|int
name|pid
block|;
ifdef|#
directive|ifdef
name|DEBUG
if|if
condition|(
name|debug
condition|)
name|fputs
argument_list|(
literal|"Exiting\n"
argument_list|,
name|stderr
argument_list|)
expr_stmt|;
endif|#
directive|endif
endif|DEBUG
name|pid
operator|=
name|wait3
argument_list|(
operator|&
name|status
argument_list|,
name|WNOHANG
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
end_expr_stmt

begin_if
if|if
condition|(
operator|!
name|pid
condition|)
return|return;
end_if

begin_if
if|if
condition|(
name|pid
operator|!=
name|term
operator|.
name|screen
operator|.
name|pid
condition|)
return|return;
end_if

begin_expr_stmt
name|Cleanup
argument_list|(
literal|0
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
unit|}  consolepr
operator|(
name|string
operator|)
name|char
operator|*
name|string
expr_stmt|;
end_expr_stmt

begin_block
block|{
specifier|extern
name|int
name|errno
decl_stmt|;
specifier|extern
name|char
modifier|*
name|sys_errlist
index|[]
decl_stmt|;
name|int
name|oerrno
decl_stmt|;
name|int
name|f
decl_stmt|;
name|oerrno
operator|=
name|errno
expr_stmt|;
name|f
operator|=
name|open
argument_list|(
literal|"/dev/console"
argument_list|,
name|O_WRONLY
argument_list|)
expr_stmt|;
name|write
argument_list|(
name|f
argument_list|,
literal|"xterm: "
argument_list|,
literal|7
argument_list|)
expr_stmt|;
name|write
argument_list|(
name|f
argument_list|,
name|string
argument_list|,
name|strlen
argument_list|(
name|string
argument_list|)
argument_list|)
expr_stmt|;
name|write
argument_list|(
name|f
argument_list|,
literal|": "
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|write
argument_list|(
name|f
argument_list|,
name|sys_errlist
index|[
name|oerrno
index|]
argument_list|,
name|strlen
argument_list|(
name|sys_errlist
index|[
name|oerrno
index|]
argument_list|)
argument_list|)
expr_stmt|;
name|write
argument_list|(
name|f
argument_list|,
literal|"\n"
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|close
argument_list|(
name|f
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|f
operator|=
name|open
argument_list|(
literal|"/dev/tty"
argument_list|,
literal|2
argument_list|)
operator|)
operator|>=
literal|0
condition|)
block|{
name|ioctl
argument_list|(
name|f
argument_list|,
name|TIOCNOTTY
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|close
argument_list|(
name|f
argument_list|)
expr_stmt|;
block|}
block|}
end_block

begin_macro
name|checklogin
argument_list|()
end_macro

begin_block
block|{
specifier|register
name|int
name|i
decl_stmt|,
name|j
decl_stmt|;
specifier|register
name|struct
name|passwd
modifier|*
name|pw
decl_stmt|;
name|struct
name|utmp
name|utmp
decl_stmt|;
if|if
condition|(
operator|(
name|i
operator|=
name|open
argument_list|(
name|etc_utmp
argument_list|,
name|O_RDONLY
argument_list|)
operator|)
operator|<
literal|0
condition|)
return|return
operator|(
name|FALSE
operator|)
return|;
name|lseek
argument_list|(
name|i
argument_list|,
call|(
name|long
call|)
argument_list|(
name|tslot
operator|*
sizeof|sizeof
argument_list|(
expr|struct
name|utmp
argument_list|)
argument_list|)
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|j
operator|=
name|read
argument_list|(
name|i
argument_list|,
operator|(
name|char
operator|*
operator|)
operator|&
name|utmp
argument_list|,
sizeof|sizeof
argument_list|(
name|utmp
argument_list|)
argument_list|)
expr_stmt|;
name|close
argument_list|(
name|i
argument_list|)
expr_stmt|;
if|if
condition|(
name|j
operator|!=
sizeof|sizeof
argument_list|(
name|utmp
argument_list|)
operator|||
name|strcmp
argument_list|(
name|get_ty
argument_list|,
name|utmp
operator|.
name|ut_line
argument_list|)
operator|!=
literal|0
operator|||
operator|!
operator|*
name|utmp
operator|.
name|ut_name
operator|||
operator|(
name|pw
operator|=
name|getpwnam
argument_list|(
name|utmp
operator|.
name|ut_name
argument_list|)
operator|)
operator|==
name|NULL
condition|)
return|return
operator|(
name|FALSE
operator|)
return|;
name|chdir
argument_list|(
name|pw
operator|->
name|pw_dir
argument_list|)
expr_stmt|;
name|setgid
argument_list|(
name|pw
operator|->
name|pw_gid
argument_list|)
expr_stmt|;
name|setuid
argument_list|(
name|pw
operator|->
name|pw_uid
argument_list|)
expr_stmt|;
name|L_flag
operator|=
literal|0
expr_stmt|;
return|return
operator|(
name|TRUE
operator|)
return|;
block|}
end_block

end_unit


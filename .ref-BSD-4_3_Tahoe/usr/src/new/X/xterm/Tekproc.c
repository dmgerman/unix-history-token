begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  *	$Source: /u1/X/xterm/RCS/Tekproc.c,v $  *	$Header: Tekproc.c,v 10.104 86/12/02 11:35:38 swick Exp $  */
end_comment

begin_include
include|#
directive|include
file|<X/mit-copyright.h>
end_include

begin_comment
comment|/* Copyright (c) 1985 Massachusetts Institute of Technology		*/
end_comment

begin_comment
comment|/* Copyright (c) 1985	Digital Equipment Corporation			*/
end_comment

begin_comment
comment|/* Tekproc.c */
end_comment

begin_include
include|#
directive|include
file|<X/Xlib.h>
end_include

begin_include
include|#
directive|include
file|"scrollbar.h"
end_include

begin_include
include|#
directive|include
file|"ptyx.h"
end_include

begin_include
include|#
directive|include
file|"Tekparse.h"
end_include

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_include
include|#
directive|include
file|<sgtty.h>
end_include

begin_include
include|#
directive|include
file|<ctype.h>
end_include

begin_include
include|#
directive|include
file|<errno.h>
end_include

begin_include
include|#
directive|include
file|<setjmp.h>
end_include

begin_include
include|#
directive|include
file|<sys/time.h>
end_include

begin_include
include|#
directive|include
file|<sys/file.h>
end_include

begin_include
include|#
directive|include
file|<pwd.h>
end_include

begin_include
include|#
directive|include
file|"data.h"
end_include

begin_include
include|#
directive|include
file|"error.h"
end_include

begin_ifdef
ifdef|#
directive|ifdef
name|MODEMENU
end_ifdef

begin_include
include|#
directive|include
file|"menu.h"
end_include

begin_endif
endif|#
directive|endif
endif|MODEMENU
end_endif

begin_comment
comment|/* Tek defines */
end_comment

begin_define
define|#
directive|define
name|BEL
value|07
end_define

begin_define
define|#
directive|define
name|CANCEL
value|030
end_define

begin_define
define|#
directive|define
name|DOTDASHEDLINE
value|2
end_define

begin_define
define|#
directive|define
name|DOTTEDLINE
value|1
end_define

begin_define
define|#
directive|define
name|EAST
value|01
end_define

begin_define
define|#
directive|define
name|ETX
value|03
end_define

begin_define
define|#
directive|define
name|ICONFONT
value|4
end_define

begin_define
define|#
directive|define
name|LARGEFONT
value|0
end_define

begin_define
define|#
directive|define
name|LARGEFONTNAME
value|"9x15"
end_define

begin_define
define|#
directive|define
name|LINEMASK
value|07
end_define

begin_define
define|#
directive|define
name|LONGDASHEDLINE
value|4
end_define

begin_define
define|#
directive|define
name|MARGIN1
value|0
end_define

begin_define
define|#
directive|define
name|MARGIN2
value|1
end_define

begin_define
define|#
directive|define
name|MAX_PTS
value|150
end_define

begin_define
define|#
directive|define
name|MAX_VTX
value|300
end_define

begin_define
define|#
directive|define
name|NAK
value|025
end_define

begin_define
define|#
directive|define
name|NORTH
value|04
end_define

begin_define
define|#
directive|define
name|PENDOWN
value|1
end_define

begin_define
define|#
directive|define
name|PENUP
value|0
end_define

begin_define
define|#
directive|define
name|SHORTDASHEDLINE
value|3
end_define

begin_define
define|#
directive|define
name|SMALLFONT
value|3
end_define

begin_define
define|#
directive|define
name|SMALLFONTNAME
value|"6x10"
end_define

begin_define
define|#
directive|define
name|SOLIDLINE
value|0
end_define

begin_define
define|#
directive|define
name|SOUTH
value|010
end_define

begin_define
define|#
directive|define
name|TEKBOTTOMPAD
value|23
end_define

begin_define
define|#
directive|define
name|TEKDEFHEIGHT
value|565
end_define

begin_define
define|#
directive|define
name|TEKDEFWIDTH
value|750
end_define

begin_define
define|#
directive|define
name|TEKHEIGHT
value|3072
end_define

begin_define
define|#
directive|define
name|TEKHOME
value|((TekChar[screen->page.fontsize].nlines - 1)\ 			 * TekChar[screen->page.fontsize].vsize)
end_define

begin_define
define|#
directive|define
name|TEKMINHEIGHT
value|452
end_define

begin_define
define|#
directive|define
name|TEKMINWIDTH
value|600
end_define

begin_define
define|#
directive|define
name|TEKPAD
value|57
end_define

begin_define
define|#
directive|define
name|TEKTOPPAD
value|34
end_define

begin_define
define|#
directive|define
name|TEKWIDTH
value|4096
end_define

begin_define
define|#
directive|define
name|TEXT_BUF_SIZE
value|256
end_define

begin_define
define|#
directive|define
name|THREEFONT
value|2
end_define

begin_define
define|#
directive|define
name|THREEFONTNAME
value|"8x13"
end_define

begin_define
define|#
directive|define
name|TWOFONT
value|1
end_define

begin_define
define|#
directive|define
name|TWOFONTNAME
value|"6x13"
end_define

begin_define
define|#
directive|define
name|WEST
value|02
end_define

begin_define
define|#
directive|define
name|TekMove
parameter_list|(
name|x
parameter_list|,
name|y
parameter_list|)
value|screen->cur_X = x; screen->cur_Y = y
end_define

begin_define
define|#
directive|define
name|input
parameter_list|()
value|Tinput()
end_define

begin_define
define|#
directive|define
name|unput
parameter_list|(
name|c
parameter_list|)
value|*Tpushback++ = c
end_define

begin_ifndef
ifndef|#
directive|ifndef
name|lint
end_ifndef

begin_decl_stmt
specifier|static
name|char
name|sccs_id
index|[]
init|=
literal|"@(#)Tekproc.c\tX10/6.6B\t12/26/86"
decl_stmt|;
end_decl_stmt

begin_endif
endif|#
directive|endif
endif|lint
end_endif

begin_decl_stmt
specifier|static
name|Vertex
modifier|*
name|T_box
index|[
name|TEKNUMFONTS
index|]
init|=
block|{
name|T_boxlarge
block|,
name|T_box2
block|,
name|T_box3
block|,
name|T_boxsmall
block|,
name|T_boxicon
block|, }
decl_stmt|;
end_decl_stmt

begin_struct
specifier|static
struct|struct
name|Tek_Char
block|{
name|int
name|hsize
decl_stmt|;
comment|/* in Tek units */
name|int
name|vsize
decl_stmt|;
comment|/* in Tek units */
name|int
name|charsperline
decl_stmt|;
name|int
name|nlines
decl_stmt|;
block|}
name|TekChar
index|[
name|TEKNUMFONTS
index|]
init|=
block|{
block|{
literal|56
block|,
literal|88
block|,
literal|74
block|,
literal|35
block|}
block|,
comment|/* large */
block|{
literal|51
block|,
literal|82
block|,
literal|81
block|,
literal|38
block|}
block|,
comment|/* #2 */
block|{
literal|34
block|,
literal|53
block|,
literal|121
block|,
literal|58
block|}
block|,
comment|/* #3 */
block|{
literal|31
block|,
literal|48
block|,
literal|133
block|,
literal|64
block|}
block|,
comment|/* small */
block|{
literal|56
block|,
literal|88
block|,
literal|74
block|,
literal|35
block|}
block|,
comment|/* icon is same as large */
block|}
struct|;
end_struct

begin_decl_stmt
specifier|static
name|int
modifier|*
name|curstate
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|Cursor
name|GINcursor
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|Vertex
modifier|*
name|line_pt
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|nplot
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|TekLink
name|Tek0
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|jmp_buf
name|Tekjump
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|TekLink
modifier|*
name|TekRecord
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|Vertex
modifier|*
name|Tline
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
modifier|*
name|Tparsestate
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|extern
name|int
name|Talptable
index|[]
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|extern
name|int
name|Tbestable
index|[]
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|extern
name|int
name|Tbyptable
index|[]
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|extern
name|int
name|Tesctable
index|[]
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|extern
name|int
name|Tipltable
index|[]
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|extern
name|int
name|Tplttable
index|[]
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|extern
name|int
name|Tpttable
index|[]
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|extern
name|int
name|Tspttable
index|[]
decl_stmt|;
end_decl_stmt

begin_macro
name|Tekparse
argument_list|()
end_macro

begin_block
block|{
specifier|register
name|Screen
modifier|*
name|screen
init|=
operator|&
name|term
operator|.
name|screen
decl_stmt|;
specifier|register
name|int
name|c
decl_stmt|,
name|x
decl_stmt|,
name|y
decl_stmt|;
specifier|register
name|char
modifier|*
name|cp
decl_stmt|;
name|char
name|ch
decl_stmt|;
name|int
name|arg
decl_stmt|;
name|int
name|Tinput
parameter_list|()
function_decl|;
for|for
control|(
init|;
condition|;
control|)
switch|switch
condition|(
name|Tparsestate
index|[
name|c
operator|=
name|input
argument_list|()
index|]
condition|)
block|{
case|case
name|CASE_REPORT
case|:
comment|/* report address */
if|if
condition|(
name|screen
operator|->
name|TekGIN
condition|)
block|{
name|TekGINoff
argument_list|()
expr_stmt|;
name|TekEnqMouse
argument_list|(
literal|0
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|c
operator|=
literal|064
expr_stmt|;
comment|/* has hard copy unit */
if|if
condition|(
name|screen
operator|->
name|margin
operator|==
name|MARGIN2
condition|)
name|c
operator||=
literal|02
expr_stmt|;
name|TekEnq
argument_list|(
name|c
argument_list|,
name|screen
operator|->
name|cur_X
argument_list|,
name|screen
operator|->
name|cur_Y
argument_list|)
expr_stmt|;
block|}
name|TekRecord
operator|->
name|ptr
index|[
operator|-
literal|1
index|]
operator|=
name|NAK
expr_stmt|;
comment|/* remove from recording */
name|Tparsestate
operator|=
name|curstate
expr_stmt|;
break|break;
case|case
name|CASE_VT_MODE
case|:
comment|/* special return to vt102 mode */
name|Tparsestate
operator|=
name|curstate
expr_stmt|;
name|TekRecord
operator|->
name|ptr
index|[
operator|-
literal|1
index|]
operator|=
name|NAK
expr_stmt|;
comment|/* remove from recording */
if|if
condition|(
name|screen
operator|->
name|logging
condition|)
block|{
name|FlushLog
argument_list|(
name|screen
argument_list|)
expr_stmt|;
name|screen
operator|->
name|logstart
operator|=
name|buffer
expr_stmt|;
block|}
return|return;
case|case
name|CASE_SPT_STATE
case|:
comment|/* Enter Special Point Plot mode */
if|if
condition|(
name|screen
operator|->
name|TekGIN
condition|)
name|TekGINoff
argument_list|()
expr_stmt|;
name|Tparsestate
operator|=
name|curstate
operator|=
name|Tspttable
expr_stmt|;
break|break;
case|case
name|CASE_GIN
case|:
comment|/* Do Tek GIN mode */
name|screen
operator|->
name|TekGIN
operator|=
operator|&
name|TekRecord
operator|->
name|ptr
index|[
operator|-
literal|1
index|]
expr_stmt|;
comment|/* Set cross-hair cursor raster array */
if|if
condition|(
name|GINcursor
operator|=
name|make_tcross
argument_list|(
name|screen
operator|->
name|mousecolor
argument_list|,
name|screen
operator|->
name|background
argument_list|,
name|GXcopy
argument_list|)
condition|)
name|XDefineCursor
argument_list|(
name|TWindow
argument_list|(
name|screen
argument_list|)
argument_list|,
name|GINcursor
argument_list|)
expr_stmt|;
name|Tparsestate
operator|=
name|Tbyptable
expr_stmt|;
comment|/* Bypass mode */
break|break;
case|case
name|CASE_BEL
case|:
comment|/* BEL */
if|if
condition|(
name|screen
operator|->
name|TekGIN
condition|)
name|TekGINoff
argument_list|()
expr_stmt|;
if|if
condition|(
operator|!
name|TekRefresh
condition|)
name|Bell
argument_list|()
expr_stmt|;
name|Tparsestate
operator|=
name|curstate
expr_stmt|;
comment|/* clear bypass condition */
break|break;
case|case
name|CASE_BS
case|:
comment|/* BS */
if|if
condition|(
name|screen
operator|->
name|TekGIN
condition|)
name|TekGINoff
argument_list|()
expr_stmt|;
name|Tparsestate
operator|=
name|curstate
expr_stmt|;
comment|/* clear bypass condition */
name|TCursorBack
argument_list|()
expr_stmt|;
break|break;
case|case
name|CASE_PT_STATE
case|:
comment|/* Enter Tek Point Plot mode */
if|if
condition|(
name|screen
operator|->
name|TekGIN
condition|)
name|TekGINoff
argument_list|()
expr_stmt|;
name|Tparsestate
operator|=
name|curstate
operator|=
name|Tpttable
expr_stmt|;
break|break;
case|case
name|CASE_PLT_STATE
case|:
comment|/* Enter Tek Plot mode */
if|if
condition|(
name|screen
operator|->
name|TekGIN
condition|)
name|TekGINoff
argument_list|()
expr_stmt|;
name|Tparsestate
operator|=
name|curstate
operator|=
name|Tplttable
expr_stmt|;
if|if
condition|(
operator|(
name|c
operator|=
name|input
argument_list|()
operator|)
operator|==
name|BEL
condition|)
name|screen
operator|->
name|pen
operator|=
name|PENDOWN
expr_stmt|;
else|else
block|{
name|unput
argument_list|(
name|c
argument_list|)
expr_stmt|;
name|screen
operator|->
name|pen
operator|=
name|PENUP
expr_stmt|;
block|}
break|break;
case|case
name|CASE_TAB
case|:
comment|/* HT */
if|if
condition|(
name|screen
operator|->
name|TekGIN
condition|)
name|TekGINoff
argument_list|()
expr_stmt|;
name|Tparsestate
operator|=
name|curstate
expr_stmt|;
comment|/* clear bypass condition */
name|TCursorForward
argument_list|()
expr_stmt|;
break|break;
case|case
name|CASE_IPL_STATE
case|:
comment|/* Enter Tek Incremental Plot mode */
if|if
condition|(
name|screen
operator|->
name|TekGIN
condition|)
name|TekGINoff
argument_list|()
expr_stmt|;
name|Tparsestate
operator|=
name|curstate
operator|=
name|Tipltable
expr_stmt|;
break|break;
case|case
name|CASE_ALP_STATE
case|:
comment|/* Enter Tek Alpha mode from any other mode */
if|if
condition|(
name|screen
operator|->
name|TekGIN
condition|)
name|TekGINoff
argument_list|()
expr_stmt|;
comment|/* if in one of graphics states, move alpha cursor */
if|if
condition|(
name|nplot
operator|>
literal|0
condition|)
comment|/* flush line Tbuffer */
name|TekFlush
argument_list|()
expr_stmt|;
name|Tparsestate
operator|=
name|curstate
operator|=
name|Talptable
expr_stmt|;
break|break;
case|case
name|CASE_UP
case|:
comment|/* cursor up */
if|if
condition|(
name|screen
operator|->
name|TekGIN
condition|)
name|TekGINoff
argument_list|()
expr_stmt|;
name|Tparsestate
operator|=
name|curstate
expr_stmt|;
comment|/* clear bypass condition */
name|TCursorUp
argument_list|()
expr_stmt|;
break|break;
case|case
name|CASE_COPY
case|:
comment|/* make copy */
if|if
condition|(
name|screen
operator|->
name|TekGIN
condition|)
name|TekGINoff
argument_list|()
expr_stmt|;
name|TekCopy
argument_list|()
expr_stmt|;
name|TekRecord
operator|->
name|ptr
index|[
operator|-
literal|1
index|]
operator|=
name|NAK
expr_stmt|;
comment|/* remove from recording */
name|Tparsestate
operator|=
name|curstate
expr_stmt|;
comment|/* clear bypass condition */
break|break;
case|case
name|CASE_PAGE
case|:
comment|/* Page Function */
if|if
condition|(
name|screen
operator|->
name|TekGIN
condition|)
name|TekGINoff
argument_list|()
expr_stmt|;
name|TekPage
argument_list|()
expr_stmt|;
comment|/* clear bypass condition */
break|break;
case|case
name|CASE_BES_STATE
case|:
comment|/* Byp: an escape char */
name|Tparsestate
operator|=
name|Tbestable
expr_stmt|;
break|break;
case|case
name|CASE_BYP_STATE
case|:
comment|/* set bypass condition */
name|Tparsestate
operator|=
name|Tbyptable
expr_stmt|;
break|break;
case|case
name|CASE_IGNORE
case|:
comment|/* Esc: totally ignore CR, ESC, LF, ~ */
break|break;
case|case
name|CASE_ASCII
case|:
comment|/* Select ASCII char set */
comment|/* ignore for now */
name|Tparsestate
operator|=
name|curstate
expr_stmt|;
break|break;
case|case
name|CASE_APL
case|:
comment|/* Select APL char set */
comment|/* ignore for now */
name|Tparsestate
operator|=
name|curstate
expr_stmt|;
break|break;
case|case
name|CASE_CHAR_SIZE
case|:
comment|/* character size selector */
name|screen
operator|->
name|cur
operator|.
name|fontsize
operator|=
name|c
operator|&
literal|03
expr_stmt|;
name|Tparsestate
operator|=
name|curstate
expr_stmt|;
break|break;
case|case
name|CASE_BEAM_VEC
case|:
comment|/* beam and vector selector */
comment|/* only line types */
if|if
condition|(
operator|(
name|c
operator|&=
name|LINEMASK
operator|)
operator|!=
name|screen
operator|->
name|cur
operator|.
name|linetype
condition|)
block|{
if|if
condition|(
name|nplot
operator|>
literal|0
condition|)
name|TekFlush
argument_list|()
expr_stmt|;
name|screen
operator|->
name|cur
operator|.
name|linetype
operator|=
name|c
expr_stmt|;
block|}
name|Tparsestate
operator|=
name|curstate
expr_stmt|;
break|break;
case|case
name|CASE_CURSTATE
case|:
name|Tparsestate
operator|=
name|curstate
expr_stmt|;
break|break;
case|case
name|CASE_PENUP
case|:
comment|/* Ipl: penup */
name|screen
operator|->
name|pen
operator|=
name|PENUP
expr_stmt|;
break|break;
case|case
name|CASE_PENDOWN
case|:
comment|/* Ipl: pendown */
name|screen
operator|->
name|pen
operator|=
name|PENDOWN
expr_stmt|;
break|break;
case|case
name|CASE_IPL_POINT
case|:
comment|/* Ipl: point */
name|x
operator|=
name|screen
operator|->
name|cur_X
expr_stmt|;
name|y
operator|=
name|screen
operator|->
name|cur_Y
expr_stmt|;
if|if
condition|(
name|c
operator|&
name|NORTH
condition|)
name|y
operator|++
expr_stmt|;
elseif|else
if|if
condition|(
name|c
operator|&
name|SOUTH
condition|)
name|y
operator|--
expr_stmt|;
if|if
condition|(
name|c
operator|&
name|EAST
condition|)
name|x
operator|++
expr_stmt|;
elseif|else
if|if
condition|(
name|c
operator|&
name|WEST
condition|)
name|x
operator|--
expr_stmt|;
if|if
condition|(
name|screen
operator|->
name|pen
operator|==
name|PENDOWN
condition|)
name|TekDraw
argument_list|(
name|x
argument_list|,
name|y
argument_list|)
expr_stmt|;
else|else
name|TekMove
argument_list|(
name|x
argument_list|,
name|y
argument_list|)
expr_stmt|;
break|break;
case|case
name|CASE_PLT_VEC
case|:
comment|/* Plt: vector */
name|unput
argument_list|(
name|c
argument_list|)
expr_stmt|;
if|if
condition|(
name|getpoint
argument_list|()
condition|)
block|{
if|if
condition|(
name|screen
operator|->
name|pen
operator|==
name|PENDOWN
condition|)
name|TekDraw
argument_list|(
name|screen
operator|->
name|cur
operator|.
name|x
argument_list|,
name|screen
operator|->
name|cur
operator|.
name|y
argument_list|)
expr_stmt|;
else|else
name|TekMove
argument_list|(
name|screen
operator|->
name|cur
operator|.
name|x
argument_list|,
name|screen
operator|->
name|cur
operator|.
name|y
argument_list|)
expr_stmt|;
name|screen
operator|->
name|pen
operator|=
name|PENDOWN
expr_stmt|;
block|}
break|break;
case|case
name|CASE_PT_POINT
case|:
comment|/* Pt: point */
name|unput
argument_list|(
name|c
argument_list|)
expr_stmt|;
if|if
condition|(
name|getpoint
argument_list|()
condition|)
block|{
name|TekMove
argument_list|(
name|screen
operator|->
name|cur
operator|.
name|x
argument_list|,
name|screen
operator|->
name|cur
operator|.
name|y
argument_list|)
expr_stmt|;
name|TekDraw
argument_list|(
name|screen
operator|->
name|cur
operator|.
name|x
argument_list|,
name|screen
operator|->
name|cur
operator|.
name|y
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
name|CASE_SPT_POINT
case|:
comment|/* Spt: point */
comment|/* ignore intensity character in c */
if|if
condition|(
name|getpoint
argument_list|()
condition|)
block|{
name|TekMove
argument_list|(
name|screen
operator|->
name|cur
operator|.
name|x
argument_list|,
name|screen
operator|->
name|cur
operator|.
name|y
argument_list|)
expr_stmt|;
name|TekDraw
argument_list|(
name|screen
operator|->
name|cur
operator|.
name|x
argument_list|,
name|screen
operator|->
name|cur
operator|.
name|y
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
name|CASE_CR
case|:
comment|/* CR */
if|if
condition|(
name|screen
operator|->
name|TekGIN
condition|)
name|TekGINoff
argument_list|()
expr_stmt|;
if|if
condition|(
name|nplot
operator|>
literal|0
condition|)
comment|/* flush line Tbuffer */
name|TekFlush
argument_list|()
expr_stmt|;
name|screen
operator|->
name|cur_X
operator|=
name|screen
operator|->
name|margin
operator|==
name|MARGIN1
condition|?
literal|0
else|:
name|TEKWIDTH
operator|/
literal|2
expr_stmt|;
name|Tparsestate
operator|=
name|curstate
operator|=
name|Talptable
expr_stmt|;
break|break;
case|case
name|CASE_ESC_STATE
case|:
comment|/* ESC */
name|Tparsestate
operator|=
name|Tesctable
expr_stmt|;
break|break;
case|case
name|CASE_LF
case|:
comment|/* LF */
if|if
condition|(
name|screen
operator|->
name|TekGIN
condition|)
name|TekGINoff
argument_list|()
expr_stmt|;
name|TCursorDown
argument_list|()
expr_stmt|;
if|if
condition|(
operator|!
name|TekRefresh
operator|&&
operator|(
name|screen
operator|->
name|display
operator|->
name|qlen
operator|>
literal|0
operator|||
operator|(
name|ioctl
argument_list|(
name|screen
operator|->
name|display
operator|->
name|fd
argument_list|,
name|FIONREAD
argument_list|,
operator|&
name|arg
argument_list|)
operator|,
name|arg
operator|)
operator|>
literal|0
operator|)
condition|)
name|xevents
argument_list|()
expr_stmt|;
break|break;
case|case
name|CASE_SP
case|:
comment|/* SP */
name|TCursorForward
argument_list|()
expr_stmt|;
break|break;
case|case
name|CASE_PRINT
case|:
comment|/* printable character */
name|ch
operator|=
name|c
expr_stmt|;
name|c
operator|=
name|TActiveIcon
argument_list|(
name|screen
argument_list|)
condition|?
name|ICONFONT
else|:
name|screen
operator|->
name|cur
operator|.
name|fontsize
expr_stmt|;
name|XTextMask
argument_list|(
name|TWindow
argument_list|(
name|screen
argument_list|)
argument_list|,
call|(
name|int
call|)
argument_list|(
name|screen
operator|->
name|cur_X
operator|*
name|TekScale
argument_list|(
name|screen
argument_list|)
argument_list|)
operator|+
name|screen
operator|->
name|border
argument_list|,
call|(
name|int
call|)
argument_list|(
operator|(
name|TEKHEIGHT
operator|+
name|TEKTOPPAD
operator|-
name|screen
operator|->
name|cur_Y
operator|)
operator|*
name|TekScale
argument_list|(
name|screen
argument_list|)
argument_list|)
operator|+
name|screen
operator|->
name|border
operator|+
name|TTitlebar
argument_list|(
name|screen
argument_list|)
operator|-
name|screen
operator|->
name|tobaseline
index|[
name|c
index|]
argument_list|,
operator|&
name|ch
argument_list|,
literal|1
argument_list|,
name|screen
operator|->
name|Tfont
index|[
name|c
index|]
argument_list|,
name|screen
operator|->
name|Tforeground
argument_list|)
expr_stmt|;
name|TCursorForward
argument_list|()
expr_stmt|;
break|break;
case|case
name|CASE_OSC
case|:
comment|/* do osc escape */
name|do_osc
argument_list|(
name|Tinput
argument_list|)
expr_stmt|;
name|Tparsestate
operator|=
name|curstate
expr_stmt|;
break|break;
block|}
block|}
end_block

begin_decl_stmt
specifier|static
name|int
name|rcnt
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|char
modifier|*
name|rptr
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|Tselect_mask
decl_stmt|;
end_decl_stmt

begin_macro
name|Tinput
argument_list|()
end_macro

begin_block
block|{
specifier|register
name|Screen
modifier|*
name|screen
init|=
operator|&
name|term
operator|.
name|screen
decl_stmt|;
specifier|register
name|char
modifier|*
name|cp
decl_stmt|;
specifier|register
name|int
name|i
decl_stmt|;
specifier|register
name|TekLink
modifier|*
name|tek
decl_stmt|;
specifier|extern
name|char
modifier|*
name|malloc
parameter_list|()
function_decl|;
if|if
condition|(
name|Tpushback
operator|>
name|Tpushb
condition|)
return|return
operator|(
operator|*
operator|--
name|Tpushback
operator|)
return|;
if|if
condition|(
name|TekRefresh
condition|)
block|{
if|if
condition|(
name|rcnt
operator|--
operator|>
literal|0
condition|)
return|return
operator|(
operator|*
name|rptr
operator|++
operator|)
return|;
if|if
condition|(
name|tek
operator|=
name|TekRefresh
operator|->
name|next
condition|)
block|{
name|TekRefresh
operator|=
name|tek
expr_stmt|;
name|rcnt
operator|=
name|tek
operator|->
name|count
operator|-
literal|1
expr_stmt|;
name|rptr
operator|=
name|tek
operator|->
name|data
expr_stmt|;
return|return
operator|(
operator|*
name|rptr
operator|++
operator|)
return|;
block|}
name|TekRefresh
operator|=
operator|(
name|TekLink
operator|*
operator|)
literal|0
expr_stmt|;
name|longjmp
argument_list|(
name|Tekjump
argument_list|,
literal|1
argument_list|)
expr_stmt|;
block|}
name|again
label|:
if|if
condition|(
name|Tbcnt
operator|--
operator|<=
literal|0
condition|)
block|{
if|if
condition|(
name|nplot
operator|>
literal|0
condition|)
comment|/* flush line Tbuffer */
name|TekFlush
argument_list|()
expr_stmt|;
name|Tselect_mask
operator|=
name|pty_mask
expr_stmt|;
comment|/* force a read */
for|for
control|(
init|;
condition|;
control|)
block|{
if|if
condition|(
name|Tselect_mask
operator|&
name|pty_mask
condition|)
block|{
if|if
condition|(
name|screen
operator|->
name|logging
condition|)
name|FlushLog
argument_list|(
name|screen
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|Tbcnt
operator|=
name|read
argument_list|(
name|screen
operator|->
name|respond
argument_list|,
name|Tbptr
operator|=
name|Tbuffer
argument_list|,
name|BUF_SIZE
argument_list|)
operator|)
operator|<
literal|0
condition|)
block|{
if|if
condition|(
name|errno
operator|==
name|EIO
operator|&&
name|am_slave
condition|)
name|exit
argument_list|(
literal|0
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|errno
operator|!=
name|EWOULDBLOCK
condition|)
name|Panic
argument_list|(
literal|"Tinput:read returned unexpected error (%d)\n"
argument_list|,
name|errno
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|Tbcnt
operator|==
literal|0
condition|)
name|Panic
argument_list|(
literal|"input: read returned zero\n"
argument_list|)
expr_stmt|;
else|else
block|{
if|if
condition|(
name|screen
operator|->
name|icon_show
operator|&&
operator|!
name|screen
operator|->
name|iconinput
condition|)
block|{
name|screen
operator|->
name|iconinput
operator|=
name|TRUE
expr_stmt|;
name|IconBox
argument_list|(
name|screen
argument_list|)
expr_stmt|;
block|}
comment|/* strip parity bit */
for|for
control|(
name|i
operator|=
name|Tbcnt
operator|,
name|cp
operator|=
name|Tbptr
init|;
name|i
operator|>
literal|0
condition|;
name|i
operator|--
control|)
operator|*
name|cp
operator|++
operator|&=
name|CHAR
expr_stmt|;
break|break;
block|}
block|}
if|if
condition|(
name|Ttoggled
operator|&&
name|curstate
operator|==
name|Talptable
condition|)
block|{
name|TCursorToggle
argument_list|(
name|TOGGLE
argument_list|)
expr_stmt|;
name|Ttoggled
operator|=
name|FALSE
expr_stmt|;
block|}
if|if
condition|(
name|QLength
argument_list|()
condition|)
name|Tselect_mask
operator|=
name|X_mask
expr_stmt|;
else|else
block|{
name|XFlush
argument_list|()
expr_stmt|;
name|Tselect_mask
operator|=
name|Select_mask
expr_stmt|;
if|if
condition|(
operator|(
name|i
operator|=
name|select
argument_list|(
name|max_plus1
argument_list|,
operator|&
name|Tselect_mask
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|screen
operator|->
name|timeout
argument_list|)
operator|)
operator|<
literal|0
condition|)
block|{
if|if
condition|(
name|errno
operator|!=
name|EINTR
condition|)
name|SysError
argument_list|(
name|ERROR_TSELECT
argument_list|)
expr_stmt|;
continue|continue;
block|}
elseif|else
if|if
condition|(
name|i
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|GetButtonState
argument_list|(
name|screen
operator|->
name|sb
argument_list|)
operator|&
name|HILITED
condition|)
name|WindowScroll
argument_list|(
name|screen
argument_list|,
name|ButtonRegion
argument_list|(
name|screen
operator|->
name|sb
argument_list|)
argument_list|)
expr_stmt|;
name|screen
operator|->
name|timeout
operator|->
name|tv_usec
operator|=
name|STEPTIME
expr_stmt|;
continue|continue;
block|}
block|}
if|if
condition|(
name|Tselect_mask
operator|&
name|X_mask
condition|)
block|{
name|xevents
argument_list|()
expr_stmt|;
if|if
condition|(
name|Tbcnt
operator|>
literal|0
condition|)
goto|goto
name|again
goto|;
block|}
block|}
name|Tbcnt
operator|--
expr_stmt|;
if|if
condition|(
operator|!
name|Ttoggled
operator|&&
name|curstate
operator|==
name|Talptable
condition|)
block|{
name|TCursorToggle
argument_list|(
name|TOGGLE
argument_list|)
expr_stmt|;
name|Ttoggled
operator|=
name|TRUE
expr_stmt|;
block|}
block|}
if|if
condition|(
operator|(
name|tek
operator|=
name|TekRecord
operator|)
operator|->
name|count
operator|>=
name|TEK_LINK_BLOCK_SIZE
condition|)
block|{
if|if
condition|(
operator|(
name|TekRecord
operator|=
name|tek
operator|->
name|next
operator|=
operator|(
name|TekLink
operator|*
operator|)
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
name|TekLink
argument_list|)
argument_list|)
operator|)
operator|==
operator|(
name|TekLink
operator|*
operator|)
literal|0
condition|)
name|Panic
argument_list|(
literal|"Tinput: malloc error (%d)\n"
argument_list|,
name|errno
argument_list|)
expr_stmt|;
name|tek
operator|=
name|tek
operator|->
name|next
expr_stmt|;
name|tek
operator|->
name|next
operator|=
operator|(
name|TekLink
operator|*
operator|)
literal|0
expr_stmt|;
name|tek
operator|->
name|count
operator|=
literal|0
expr_stmt|;
name|tek
operator|->
name|ptr
operator|=
name|tek
operator|->
name|data
expr_stmt|;
block|}
name|tek
operator|->
name|count
operator|++
expr_stmt|;
return|return
operator|(
operator|*
name|tek
operator|->
name|ptr
operator|++
operator|=
operator|*
name|Tbptr
operator|++
operator|)
return|;
block|}
end_block

begin_expr_stmt
name|TekExpose
argument_list|(
name|rep
argument_list|)
specifier|register
name|XExposeWindowEvent
operator|*
name|rep
expr_stmt|;
end_expr_stmt

begin_block
block|{
specifier|register
name|Screen
modifier|*
name|screen
init|=
operator|&
name|term
operator|.
name|screen
decl_stmt|;
specifier|register
name|int
name|border
init|=
literal|2
operator|*
name|screen
operator|->
name|border
decl_stmt|;
specifier|register
name|double
name|d
decl_stmt|;
if|if
condition|(
name|rep
operator|&&
operator|(
name|screen
operator|->
name|mappedTwin
operator|==
operator|&
name|screen
operator|->
name|fullTwin
operator|)
condition|)
block|{
if|if
condition|(
name|rep
operator|->
name|width
operator|!=
operator|(
name|TWidth
argument_list|(
name|screen
argument_list|)
operator|+
name|border
operator|)
operator|||
name|rep
operator|->
name|height
operator|!=
operator|(
name|THeight
argument_list|(
name|screen
argument_list|)
operator|+
name|border
operator|+
name|TTitlebar
argument_list|(
name|screen
argument_list|)
operator|)
condition|)
block|{
name|XClear
argument_list|(
name|TWindow
argument_list|(
name|screen
argument_list|)
argument_list|)
expr_stmt|;
name|TWidth
argument_list|(
name|screen
argument_list|)
operator|=
name|rep
operator|->
name|width
operator|-
name|border
expr_stmt|;
name|THeight
argument_list|(
name|screen
argument_list|)
operator|=
name|rep
operator|->
name|height
operator|-
name|TTitlebar
argument_list|(
name|screen
argument_list|)
operator|-
name|border
expr_stmt|;
name|TekScale
argument_list|(
name|screen
argument_list|)
operator|=
operator|(
name|double
operator|)
name|TWidth
argument_list|(
name|screen
argument_list|)
operator|/
operator|(
name|TEKWIDTH
operator|+
name|TEKPAD
operator|)
expr_stmt|;
if|if
condition|(
operator|(
name|d
operator|=
operator|(
name|double
operator|)
name|THeight
argument_list|(
name|screen
argument_list|)
operator|/
operator|(
name|TEKHEIGHT
operator|+
name|TEKTOPPAD
operator|+
name|TEKBOTTOMPAD
operator|)
operator|)
operator|<
name|TekScale
argument_list|(
name|screen
argument_list|)
condition|)
name|TekScale
argument_list|(
name|screen
argument_list|)
operator|=
name|d
expr_stmt|;
if|if
condition|(
name|TTitlebar
argument_list|(
name|screen
argument_list|)
operator|&&
name|TFullWidth
argument_list|(
name|screen
argument_list|)
operator|!=
name|rep
operator|->
name|width
condition|)
name|TekTitleResize
argument_list|(
name|rep
operator|->
name|width
argument_list|)
expr_stmt|;
name|TFullWidth
argument_list|(
name|screen
argument_list|)
operator|=
name|rep
operator|->
name|width
expr_stmt|;
name|TFullHeight
argument_list|(
name|screen
argument_list|)
operator|=
name|rep
operator|->
name|height
expr_stmt|;
if|if
condition|(
name|screen
operator|->
name|active_icon
condition|)
name|TSetIconSize
argument_list|(
name|screen
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|TFullHeight
argument_list|(
name|screen
argument_list|)
operator|!=
name|rep
operator|->
name|height
condition|)
name|TFullHeight
argument_list|(
name|screen
argument_list|)
operator|=
name|rep
operator|->
name|height
expr_stmt|;
elseif|else
if|if
condition|(
operator|!
name|Ttoggled
condition|)
name|TCursorToggle
argument_list|(
name|CLEAR
argument_list|)
expr_stmt|;
block|}
name|Ttoggled
operator|=
name|TRUE
expr_stmt|;
name|Tpushback
operator|=
name|Tpushb
expr_stmt|;
name|screen
operator|->
name|cur_X
operator|=
literal|0
expr_stmt|;
name|screen
operator|->
name|cur_Y
operator|=
name|TEKHOME
expr_stmt|;
name|screen
operator|->
name|cur
operator|=
name|screen
operator|->
name|page
expr_stmt|;
name|screen
operator|->
name|margin
operator|=
name|MARGIN1
expr_stmt|;
if|if
condition|(
name|screen
operator|->
name|TekGIN
condition|)
block|{
name|screen
operator|->
name|TekGIN
operator|=
name|NULL
expr_stmt|;
name|TekGINoff
argument_list|()
expr_stmt|;
block|}
name|TekRefresh
operator|=
operator|&
name|Tek0
expr_stmt|;
name|rptr
operator|=
name|TekRefresh
operator|->
name|data
expr_stmt|;
name|rcnt
operator|=
name|TekRefresh
operator|->
name|count
expr_stmt|;
name|Tparsestate
operator|=
name|curstate
operator|=
name|Talptable
expr_stmt|;
if|if
condition|(
operator|!
name|screen
operator|->
name|waitrefresh
condition|)
name|dorefresh
argument_list|()
expr_stmt|;
block|}
end_block

begin_macro
name|dorefresh
argument_list|()
end_macro

begin_block
block|{
specifier|register
name|Screen
modifier|*
name|screen
init|=
operator|&
name|term
operator|.
name|screen
decl_stmt|;
specifier|register
name|Cursor
name|cur
decl_stmt|;
name|XDefineCursor
argument_list|(
name|TWindow
argument_list|(
name|screen
argument_list|)
argument_list|,
name|cur
operator|=
name|make_wait
argument_list|(
name|screen
operator|->
name|mousecolor
argument_list|,
name|screen
operator|->
name|background
argument_list|,
name|GXcopy
argument_list|)
argument_list|)
expr_stmt|;
name|XFlush
argument_list|()
expr_stmt|;
if|if
condition|(
operator|!
name|setjmp
argument_list|(
name|Tekjump
argument_list|)
condition|)
name|Tekparse
argument_list|()
expr_stmt|;
name|XDefineCursor
argument_list|(
name|TWindow
argument_list|(
name|screen
argument_list|)
argument_list|,
operator|(
name|screen
operator|->
name|TekGIN
operator|&&
name|GINcursor
operator|)
condition|?
name|GINcursor
else|:
name|screen
operator|->
name|arrow
argument_list|)
expr_stmt|;
name|XFreeCursor
argument_list|(
name|cur
argument_list|)
expr_stmt|;
block|}
end_block

begin_macro
name|TekPage
argument_list|()
end_macro

begin_block
block|{
specifier|register
name|Screen
modifier|*
name|screen
init|=
operator|&
name|term
operator|.
name|screen
decl_stmt|;
specifier|register
name|TekLink
modifier|*
name|tek
decl_stmt|,
modifier|*
name|tek2
decl_stmt|;
name|XClear
argument_list|(
name|TWindow
argument_list|(
name|screen
argument_list|)
argument_list|)
expr_stmt|;
name|screen
operator|->
name|cur_X
operator|=
literal|0
expr_stmt|;
name|screen
operator|->
name|cur_Y
operator|=
name|TEKHOME
expr_stmt|;
name|screen
operator|->
name|margin
operator|=
name|MARGIN1
expr_stmt|;
name|screen
operator|->
name|page
operator|=
name|screen
operator|->
name|cur
expr_stmt|;
if|if
condition|(
name|screen
operator|->
name|TekGIN
condition|)
name|TekGINoff
argument_list|()
expr_stmt|;
name|tek
operator|=
name|TekRecord
operator|=
operator|&
name|Tek0
expr_stmt|;
name|tek
operator|->
name|count
operator|=
literal|0
expr_stmt|;
name|tek
operator|->
name|ptr
operator|=
name|tek
operator|->
name|data
expr_stmt|;
if|if
condition|(
name|tek
operator|=
name|tek
operator|->
name|next
condition|)
do|do
block|{
name|tek2
operator|=
name|tek
operator|->
name|next
expr_stmt|;
name|free
argument_list|(
operator|(
name|char
operator|*
operator|)
name|tek
argument_list|)
expr_stmt|;
block|}
do|while
condition|(
name|tek
operator|=
name|tek2
condition|)
do|;
name|TekRecord
operator|->
name|next
operator|=
operator|(
name|TekLink
operator|*
operator|)
literal|0
expr_stmt|;
name|TekRefresh
operator|=
operator|(
name|TekLink
operator|*
operator|)
literal|0
expr_stmt|;
name|Ttoggled
operator|=
name|TRUE
expr_stmt|;
name|Tparsestate
operator|=
name|curstate
operator|=
name|Talptable
expr_stmt|;
comment|/* Tek Alpha mode */
block|}
end_block

begin_define
define|#
directive|define
name|EXTRABITS
value|017
end_define

begin_define
define|#
directive|define
name|FIVEBITS
value|037
end_define

begin_define
define|#
directive|define
name|HIBITS
value|(FIVEBITS<< SHIFTHI)
end_define

begin_define
define|#
directive|define
name|LOBITS
value|(FIVEBITS<< SHIFTLO)
end_define

begin_define
define|#
directive|define
name|SHIFTHI
value|7
end_define

begin_define
define|#
directive|define
name|SHIFTLO
value|2
end_define

begin_define
define|#
directive|define
name|TWOBITS
value|03
end_define

begin_macro
name|getpoint
argument_list|()
end_macro

begin_block
block|{
specifier|register
name|int
name|c
decl_stmt|,
name|x
decl_stmt|,
name|y
decl_stmt|,
name|e
decl_stmt|,
name|lo_y
init|=
literal|0
decl_stmt|;
specifier|register
name|Screen
modifier|*
name|screen
init|=
operator|&
name|term
operator|.
name|screen
decl_stmt|;
name|x
operator|=
name|screen
operator|->
name|cur
operator|.
name|x
expr_stmt|;
name|y
operator|=
name|screen
operator|->
name|cur
operator|.
name|y
expr_stmt|;
for|for
control|(
init|;
condition|;
control|)
block|{
if|if
condition|(
operator|(
name|c
operator|=
name|input
argument_list|()
operator|)
operator|<
literal|' '
condition|)
block|{
comment|/* control character */
name|unput
argument_list|(
name|c
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
if|if
condition|(
name|c
operator|<
literal|'@'
condition|)
block|{
comment|/* Hi X or Hi Y */
if|if
condition|(
name|lo_y
condition|)
block|{
comment|/* seen a Lo Y, so this must be Hi X */
name|x
operator|&=
operator|~
name|HIBITS
expr_stmt|;
name|x
operator||=
operator|(
name|c
operator|&
name|FIVEBITS
operator|)
operator|<<
name|SHIFTHI
expr_stmt|;
continue|continue;
block|}
comment|/* else Hi Y */
name|y
operator|&=
operator|~
name|HIBITS
expr_stmt|;
name|y
operator||=
operator|(
name|c
operator|&
name|FIVEBITS
operator|)
operator|<<
name|SHIFTHI
expr_stmt|;
continue|continue;
block|}
if|if
condition|(
name|c
operator|<
literal|'`'
condition|)
block|{
comment|/* Lo X */
name|x
operator|&=
operator|~
name|LOBITS
expr_stmt|;
name|x
operator||=
operator|(
name|c
operator|&
name|FIVEBITS
operator|)
operator|<<
name|SHIFTLO
expr_stmt|;
name|screen
operator|->
name|cur
operator|.
name|x
operator|=
name|x
expr_stmt|;
name|screen
operator|->
name|cur
operator|.
name|y
operator|=
name|y
expr_stmt|;
return|return
operator|(
literal|1
operator|)
return|;
comment|/* OK */
block|}
comment|/* else Lo Y */
if|if
condition|(
name|lo_y
condition|)
block|{
comment|/* seen a Lo Y, so other must be extra bits */
name|e
operator|=
operator|(
name|y
operator|>>
name|SHIFTLO
operator|)
operator|&
name|EXTRABITS
expr_stmt|;
name|x
operator|&=
operator|~
name|TWOBITS
expr_stmt|;
name|x
operator||=
name|e
operator|&
name|TWOBITS
expr_stmt|;
name|y
operator|&=
operator|~
name|TWOBITS
expr_stmt|;
name|y
operator||=
operator|(
name|e
operator|>>
name|SHIFTLO
operator|)
operator|&
name|TWOBITS
expr_stmt|;
block|}
name|y
operator|&=
operator|~
name|LOBITS
expr_stmt|;
name|y
operator||=
operator|(
name|c
operator|&
name|FIVEBITS
operator|)
operator|<<
name|SHIFTLO
expr_stmt|;
name|lo_y
operator|++
expr_stmt|;
block|}
block|}
end_block

begin_macro
name|TCursorBack
argument_list|()
end_macro

begin_block
block|{
specifier|register
name|Screen
modifier|*
name|screen
init|=
operator|&
name|term
operator|.
name|screen
decl_stmt|;
specifier|register
name|struct
name|Tek_Char
modifier|*
name|t
decl_stmt|;
specifier|register
name|int
name|x
decl_stmt|,
name|l
decl_stmt|;
name|x
operator|=
operator|(
name|screen
operator|->
name|cur_X
operator|-=
operator|(
name|t
operator|=
operator|&
name|TekChar
index|[
name|TActiveIcon
argument_list|(
name|screen
argument_list|)
condition|?
name|ICONFONT
else|:
name|screen
operator|->
name|cur
operator|.
name|fontsize
index|]
operator|)
operator|->
name|hsize
operator|)
expr_stmt|;
if|if
condition|(
name|screen
operator|->
name|margin
operator|==
name|MARGIN1
operator|&&
name|x
operator|<
literal|0
operator|||
name|screen
operator|->
name|margin
operator|==
name|MARGIN2
operator|&&
name|x
operator|<
name|TEKWIDTH
operator|/
literal|2
condition|)
block|{
if|if
condition|(
operator|(
name|l
operator|=
operator|(
name|screen
operator|->
name|cur_Y
operator|+
operator|(
name|t
operator|->
name|vsize
operator|-
literal|1
operator|)
operator|)
operator|/
name|t
operator|->
name|vsize
operator|+
literal|1
operator|)
operator|>=
name|t
operator|->
name|nlines
condition|)
block|{
name|screen
operator|->
name|margin
operator|=
operator|!
name|screen
operator|->
name|margin
expr_stmt|;
name|l
operator|=
literal|0
expr_stmt|;
block|}
name|screen
operator|->
name|cur_Y
operator|=
name|l
operator|*
name|t
operator|->
name|vsize
expr_stmt|;
name|screen
operator|->
name|cur_X
operator|=
operator|(
name|t
operator|->
name|charsperline
operator|-
literal|1
operator|)
operator|*
name|t
operator|->
name|hsize
expr_stmt|;
block|}
block|}
end_block

begin_macro
name|TCursorForward
argument_list|()
end_macro

begin_block
block|{
specifier|register
name|Screen
modifier|*
name|screen
init|=
operator|&
name|term
operator|.
name|screen
decl_stmt|;
specifier|register
name|struct
name|Tek_Char
modifier|*
name|t
decl_stmt|;
specifier|register
name|int
name|l
decl_stmt|;
if|if
condition|(
operator|(
name|screen
operator|->
name|cur_X
operator|+=
operator|(
name|t
operator|=
operator|&
name|TekChar
index|[
name|TActiveIcon
argument_list|(
name|screen
argument_list|)
condition|?
name|ICONFONT
else|:
name|screen
operator|->
name|cur
operator|.
name|fontsize
index|]
operator|)
operator|->
name|hsize
operator|)
operator|>
name|TEKWIDTH
condition|)
block|{
if|if
condition|(
operator|(
name|l
operator|=
name|screen
operator|->
name|cur_Y
operator|/
name|t
operator|->
name|vsize
operator|-
literal|1
operator|)
operator|<
literal|0
condition|)
block|{
name|screen
operator|->
name|margin
operator|=
operator|!
name|screen
operator|->
name|margin
expr_stmt|;
name|l
operator|=
name|t
operator|->
name|nlines
operator|-
literal|1
expr_stmt|;
block|}
name|screen
operator|->
name|cur_Y
operator|=
name|l
operator|*
name|t
operator|->
name|vsize
expr_stmt|;
name|screen
operator|->
name|cur_X
operator|=
name|screen
operator|->
name|margin
operator|==
name|MARGIN1
condition|?
literal|0
else|:
name|TEKWIDTH
operator|/
literal|2
expr_stmt|;
block|}
block|}
end_block

begin_macro
name|TCursorUp
argument_list|()
end_macro

begin_block
block|{
specifier|register
name|Screen
modifier|*
name|screen
init|=
operator|&
name|term
operator|.
name|screen
decl_stmt|;
specifier|register
name|struct
name|Tek_Char
modifier|*
name|t
decl_stmt|;
specifier|register
name|int
name|l
decl_stmt|;
name|t
operator|=
operator|&
name|TekChar
index|[
name|TActiveIcon
argument_list|(
name|screen
argument_list|)
condition|?
name|ICONFONT
else|:
name|screen
operator|->
name|cur
operator|.
name|fontsize
index|]
expr_stmt|;
if|if
condition|(
operator|(
name|l
operator|=
operator|(
name|screen
operator|->
name|cur_Y
operator|+
operator|(
name|t
operator|->
name|vsize
operator|-
literal|1
operator|)
operator|)
operator|/
name|t
operator|->
name|vsize
operator|+
literal|1
operator|)
operator|>=
name|t
operator|->
name|nlines
condition|)
block|{
name|l
operator|=
literal|0
expr_stmt|;
if|if
condition|(
operator|(
name|screen
operator|->
name|margin
operator|=
operator|!
name|screen
operator|->
name|margin
operator|)
operator|!=
name|MARGIN1
condition|)
block|{
if|if
condition|(
name|screen
operator|->
name|cur_X
operator|<
name|TEKWIDTH
operator|/
literal|2
condition|)
name|screen
operator|->
name|cur_X
operator|+=
name|TEKWIDTH
operator|/
literal|2
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|screen
operator|->
name|cur_X
operator|>=
name|TEKWIDTH
operator|/
literal|2
condition|)
name|screen
operator|->
name|cur_X
operator|-=
name|TEKWIDTH
operator|/
literal|2
expr_stmt|;
block|}
name|screen
operator|->
name|cur_Y
operator|=
name|l
operator|*
name|t
operator|->
name|vsize
expr_stmt|;
block|}
end_block

begin_macro
name|TCursorDown
argument_list|()
end_macro

begin_block
block|{
specifier|register
name|Screen
modifier|*
name|screen
init|=
operator|&
name|term
operator|.
name|screen
decl_stmt|;
specifier|register
name|struct
name|Tek_Char
modifier|*
name|t
decl_stmt|;
specifier|register
name|int
name|l
decl_stmt|;
name|t
operator|=
operator|&
name|TekChar
index|[
name|TActiveIcon
argument_list|(
name|screen
argument_list|)
condition|?
name|ICONFONT
else|:
name|screen
operator|->
name|cur
operator|.
name|fontsize
index|]
expr_stmt|;
if|if
condition|(
operator|(
name|l
operator|=
name|screen
operator|->
name|cur_Y
operator|/
name|t
operator|->
name|vsize
operator|-
literal|1
operator|)
operator|<
literal|0
condition|)
block|{
name|l
operator|=
name|t
operator|->
name|nlines
operator|-
literal|1
expr_stmt|;
if|if
condition|(
operator|(
name|screen
operator|->
name|margin
operator|=
operator|!
name|screen
operator|->
name|margin
operator|)
operator|!=
name|MARGIN1
condition|)
block|{
if|if
condition|(
name|screen
operator|->
name|cur_X
operator|<
name|TEKWIDTH
operator|/
literal|2
condition|)
name|screen
operator|->
name|cur_X
operator|+=
name|TEKWIDTH
operator|/
literal|2
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|screen
operator|->
name|cur_X
operator|>=
name|TEKWIDTH
operator|/
literal|2
condition|)
name|screen
operator|->
name|cur_X
operator|-=
name|TEKWIDTH
operator|/
literal|2
expr_stmt|;
block|}
name|screen
operator|->
name|cur_Y
operator|=
name|l
operator|*
name|t
operator|->
name|vsize
expr_stmt|;
block|}
end_block

begin_macro
name|TekDraw
argument_list|(
argument|x
argument_list|,
argument|y
argument_list|)
end_macro

begin_decl_stmt
name|int
name|x
decl_stmt|,
name|y
decl_stmt|;
end_decl_stmt

begin_block
block|{
specifier|register
name|Screen
modifier|*
name|screen
init|=
operator|&
name|term
operator|.
name|screen
decl_stmt|;
if|if
condition|(
name|nplot
operator|==
literal|0
operator|||
name|T_lastx
operator|!=
name|screen
operator|->
name|cur_X
operator|||
name|T_lasty
operator|!=
name|screen
operator|->
name|cur_Y
condition|)
block|{
comment|/* 		 * We flush on each unconnected line segment if the line 		 * type is not solid.  This solves a bug in X when drawing 		 * points while the line type is not solid. 		 */
if|if
condition|(
name|nplot
operator|>
literal|0
operator|&&
name|screen
operator|->
name|cur
operator|.
name|linetype
operator|!=
name|SOLIDLINE
condition|)
name|TekFlush
argument_list|()
expr_stmt|;
name|AddToDraw
argument_list|(
name|VertexDontDraw
argument_list|,
name|screen
operator|->
name|cur_X
argument_list|,
name|screen
operator|->
name|cur_Y
argument_list|)
expr_stmt|;
block|}
name|T_lastx
operator|=
name|screen
operator|->
name|cur_X
operator|=
name|x
expr_stmt|;
name|T_lasty
operator|=
name|screen
operator|->
name|cur_Y
operator|=
name|y
expr_stmt|;
name|AddToDraw
argument_list|(
name|VertexDrawLastPoint
argument_list|,
name|x
argument_list|,
name|y
argument_list|)
expr_stmt|;
block|}
end_block

begin_macro
name|AddToDraw
argument_list|(
argument|type
argument_list|,
argument|x
argument_list|,
argument|y
argument_list|)
end_macro

begin_decl_stmt
name|int
name|type
decl_stmt|,
name|x
decl_stmt|,
name|y
decl_stmt|;
end_decl_stmt

begin_block
block|{
specifier|register
name|Screen
modifier|*
name|screen
init|=
operator|&
name|term
operator|.
name|screen
decl_stmt|;
specifier|register
name|int
name|last
decl_stmt|;
specifier|register
name|Vertex
modifier|*
name|lp
decl_stmt|;
if|if
condition|(
name|nplot
operator|>=
name|MAX_PTS
condition|)
block|{
if|if
condition|(
name|Tline
index|[
name|last
operator|=
name|nplot
operator|-
literal|1
index|]
operator|.
name|flags
operator|==
name|VertexDontDraw
condition|)
name|nplot
operator|--
expr_stmt|;
name|TekFlush
argument_list|()
expr_stmt|;
if|if
condition|(
name|type
operator|!=
name|VertexDontDraw
condition|)
block|{
operator|*
name|line_pt
operator|=
name|Tline
index|[
name|last
index|]
expr_stmt|;
operator|(
name|line_pt
operator|++
operator|)
operator|->
name|flags
operator|=
name|VertexDontDraw
expr_stmt|;
name|nplot
operator|++
expr_stmt|;
block|}
block|}
name|lp
operator|=
name|line_pt
operator|++
expr_stmt|;
name|lp
operator|->
name|flags
operator|=
name|type
expr_stmt|;
name|lp
operator|->
name|x
operator|=
name|x
operator|=
name|x
operator|*
name|TekScale
argument_list|(
name|screen
argument_list|)
operator|+
name|screen
operator|->
name|border
expr_stmt|;
name|lp
operator|->
name|y
operator|=
name|y
operator|=
operator|(
name|TEKHEIGHT
operator|+
name|TEKTOPPAD
operator|-
name|y
operator|)
operator|*
name|TekScale
argument_list|(
name|screen
argument_list|)
operator|+
name|screen
operator|->
name|border
operator|+
name|TTitlebar
argument_list|(
name|screen
argument_list|)
expr_stmt|;
name|nplot
operator|++
expr_stmt|;
block|}
end_block

begin_macro
name|TekFlush
argument_list|()
end_macro

begin_block
block|{
specifier|register
name|Screen
modifier|*
name|screen
init|=
operator|&
name|term
operator|.
name|screen
decl_stmt|;
if|if
condition|(
name|screen
operator|->
name|cur
operator|.
name|linetype
operator|==
name|SOLIDLINE
condition|)
name|XDraw
argument_list|(
name|TWindow
argument_list|(
name|screen
argument_list|)
argument_list|,
name|Tline
argument_list|,
name|nplot
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|,
name|screen
operator|->
name|Tforeground
argument_list|,
name|GXcopy
argument_list|,
name|AllPlanes
argument_list|)
expr_stmt|;
else|else
name|XDrawDashed
argument_list|(
name|TWindow
argument_list|(
name|screen
argument_list|)
argument_list|,
name|Tline
argument_list|,
name|nplot
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|,
name|screen
operator|->
name|Tforeground
argument_list|,
name|screen
operator|->
name|linepat
index|[
name|screen
operator|->
name|cur
operator|.
name|linetype
operator|-
literal|1
index|]
argument_list|,
name|GXcopy
argument_list|,
name|AllPlanes
argument_list|)
expr_stmt|;
name|nplot
operator|=
literal|0
expr_stmt|;
name|line_pt
operator|=
name|Tline
expr_stmt|;
block|}
end_block

begin_macro
name|TekGINoff
argument_list|()
end_macro

begin_block
block|{
specifier|register
name|Screen
modifier|*
name|screen
init|=
operator|&
name|term
operator|.
name|screen
decl_stmt|;
name|XDefineCursor
argument_list|(
name|TWindow
argument_list|(
name|screen
argument_list|)
argument_list|,
name|screen
operator|->
name|arrow
argument_list|)
expr_stmt|;
if|if
condition|(
name|GINcursor
condition|)
name|XFreeCursor
argument_list|(
name|GINcursor
argument_list|)
expr_stmt|;
if|if
condition|(
name|screen
operator|->
name|TekGIN
condition|)
block|{
operator|*
name|screen
operator|->
name|TekGIN
operator|=
name|CANCEL
expr_stmt|;
comment|/* modify recording */
name|screen
operator|->
name|TekGIN
operator|=
name|NULL
expr_stmt|;
block|}
block|}
end_block

begin_macro
name|TekEnqMouse
argument_list|(
argument|c
argument_list|)
end_macro

begin_decl_stmt
name|int
name|c
decl_stmt|;
end_decl_stmt

begin_block
block|{
specifier|register
name|Screen
modifier|*
name|screen
init|=
operator|&
name|term
operator|.
name|screen
decl_stmt|;
name|int
name|mousex
decl_stmt|,
name|mousey
decl_stmt|;
name|Window
name|subw
decl_stmt|;
name|XUpdateMouse
argument_list|(
name|TWindow
argument_list|(
name|screen
argument_list|)
argument_list|,
operator|&
name|mousex
argument_list|,
operator|&
name|mousey
argument_list|,
operator|&
name|subw
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|mousex
operator|=
operator|(
name|mousex
operator|-
name|screen
operator|->
name|border
operator|)
operator|/
name|TekScale
argument_list|(
name|screen
argument_list|)
operator|)
operator|<
literal|0
condition|)
name|mousex
operator|=
literal|0
expr_stmt|;
elseif|else
if|if
condition|(
name|mousex
operator|>=
name|TEKWIDTH
condition|)
name|mousex
operator|=
name|TEKWIDTH
operator|-
literal|1
expr_stmt|;
if|if
condition|(
operator|(
name|mousey
operator|=
name|TEKHEIGHT
operator|+
name|TEKTOPPAD
operator|-
operator|(
name|mousey
operator|-
name|screen
operator|->
name|border
operator|-
name|TTitlebar
argument_list|(
name|screen
argument_list|)
operator|)
operator|/
name|TekScale
argument_list|(
name|screen
argument_list|)
operator|)
operator|<
literal|0
condition|)
name|mousey
operator|=
literal|0
expr_stmt|;
elseif|else
if|if
condition|(
name|mousey
operator|>=
name|TEKHEIGHT
condition|)
name|mousey
operator|=
name|TEKHEIGHT
operator|-
literal|1
expr_stmt|;
name|TekEnq
argument_list|(
name|c
argument_list|,
name|mousex
argument_list|,
name|mousey
argument_list|)
expr_stmt|;
block|}
end_block

begin_macro
name|TekEnq
argument_list|(
argument|status
argument_list|,
argument|x
argument_list|,
argument|y
argument_list|)
end_macro

begin_decl_stmt
name|int
name|status
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|register
name|int
name|x
decl_stmt|,
name|y
decl_stmt|;
end_decl_stmt

begin_block
block|{
specifier|register
name|Screen
modifier|*
name|screen
init|=
operator|&
name|term
operator|.
name|screen
decl_stmt|;
name|int
name|pty
init|=
name|screen
operator|->
name|respond
decl_stmt|;
name|char
name|cplot
index|[
literal|5
index|]
decl_stmt|;
comment|/* Translate x and y to Tektronix code */
name|cplot
index|[
literal|1
index|]
operator|=
literal|040
operator||
operator|(
operator|(
name|x
operator|>>
name|SHIFTHI
operator|)
operator|&
name|FIVEBITS
operator|)
expr_stmt|;
name|cplot
index|[
literal|2
index|]
operator|=
literal|040
operator||
operator|(
operator|(
name|x
operator|>>
name|SHIFTLO
operator|)
operator|&
name|FIVEBITS
operator|)
expr_stmt|;
name|cplot
index|[
literal|3
index|]
operator|=
literal|040
operator||
operator|(
operator|(
name|y
operator|>>
name|SHIFTHI
operator|)
operator|&
name|FIVEBITS
operator|)
expr_stmt|;
name|cplot
index|[
literal|4
index|]
operator|=
literal|040
operator||
operator|(
operator|(
name|y
operator|>>
name|SHIFTLO
operator|)
operator|&
name|FIVEBITS
operator|)
expr_stmt|;
if|if
condition|(
name|cplot
index|[
literal|0
index|]
operator|=
name|status
condition|)
name|write
argument_list|(
name|pty
argument_list|,
name|cplot
argument_list|,
literal|5
argument_list|)
expr_stmt|;
else|else
name|write
argument_list|(
name|pty
argument_list|,
operator|&
name|cplot
index|[
literal|1
index|]
argument_list|,
literal|4
argument_list|)
expr_stmt|;
block|}
end_block

begin_macro
name|TekRun
argument_list|()
end_macro

begin_block
block|{
specifier|register
name|Screen
modifier|*
name|screen
init|=
operator|&
name|term
operator|.
name|screen
decl_stmt|;
specifier|register
name|int
name|i
decl_stmt|;
if|if
condition|(
operator|!
name|TWindow
argument_list|(
name|screen
argument_list|)
operator|&&
operator|!
name|TekInit
argument_list|()
condition|)
block|{
if|if
condition|(
name|VWindow
argument_list|(
name|screen
argument_list|)
condition|)
block|{
name|screen
operator|->
name|TekEmu
operator|=
name|FALSE
expr_stmt|;
return|return;
block|}
name|Exit
argument_list|(
name|ERROR_TINIT
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|screen
operator|->
name|icon_show
condition|)
block|{
if|if
condition|(
name|screen
operator|->
name|icon_show
operator|<
literal|0
condition|)
block|{
name|screen
operator|->
name|mappedTwin
operator|=
operator|&
name|screen
operator|->
name|iconTwin
expr_stmt|;
name|screen
operator|->
name|icon_show
operator|=
name|TRUE
expr_stmt|;
name|XMapWindow
argument_list|(
name|TWindow
argument_list|(
name|screen
argument_list|)
argument_list|)
expr_stmt|;
block|}
block|}
elseif|else
if|if
condition|(
operator|!
name|screen
operator|->
name|Tshow
condition|)
block|{
name|screen
operator|->
name|mappedTwin
operator|=
operator|&
name|screen
operator|->
name|fullTwin
expr_stmt|;
name|screen
operator|->
name|Tshow
operator|=
name|TRUE
expr_stmt|;
name|XMapWindow
argument_list|(
name|TWindow
argument_list|(
name|screen
argument_list|)
argument_list|)
expr_stmt|;
block|}
else|else
name|XRaiseWindow
argument_list|(
name|TWindow
argument_list|(
name|screen
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|screen
operator|->
name|select
condition|)
name|TekSelect
argument_list|()
expr_stmt|;
if|if
condition|(
name|L_flag
operator|>
literal|0
condition|)
block|{
name|XWarpMouse
argument_list|(
name|TWindow
argument_list|(
name|screen
argument_list|)
argument_list|,
name|TFullWidth
argument_list|(
name|screen
argument_list|)
operator|>>
literal|1
argument_list|,
name|TFullHeight
argument_list|(
name|screen
argument_list|)
operator|>>
literal|1
argument_list|)
expr_stmt|;
name|L_flag
operator|=
operator|-
literal|1
expr_stmt|;
block|}
name|Tpushback
operator|=
name|Tpushb
expr_stmt|;
name|Tbptr
operator|=
name|Tbuffer
expr_stmt|;
for|for
control|(
name|i
operator|=
name|Tbcnt
operator|=
name|bcnt
init|;
name|i
operator|>
literal|0
condition|;
name|i
operator|--
control|)
operator|*
name|Tbptr
operator|++
operator|=
operator|*
name|bptr
operator|++
expr_stmt|;
name|Tbptr
operator|=
name|Tbuffer
expr_stmt|;
name|Ttoggled
operator|=
name|TRUE
expr_stmt|;
if|if
condition|(
operator|!
name|setjmp
argument_list|(
name|Tekend
argument_list|)
condition|)
name|Tekparse
argument_list|()
expr_stmt|;
if|if
condition|(
operator|!
name|Ttoggled
condition|)
block|{
name|TCursorToggle
argument_list|(
name|TOGGLE
argument_list|)
expr_stmt|;
name|Ttoggled
operator|=
name|TRUE
expr_stmt|;
block|}
name|screen
operator|->
name|TekEmu
operator|=
name|FALSE
expr_stmt|;
name|TekUnselect
argument_list|()
expr_stmt|;
block|}
end_block

begin_decl_stmt
specifier|static
name|int
name|Tpattern
index|[
name|TEKNUMLINES
index|]
init|=
block|{
name|XMakePattern
argument_list|(
literal|0x1
argument_list|,
literal|4
argument_list|,
literal|1
argument_list|)
block|,
comment|/* dotted */
name|XMakePattern
argument_list|(
literal|0xf1
argument_list|,
literal|11
argument_list|,
literal|1
argument_list|)
block|,
comment|/* dot-dashed */
name|XMakePattern
argument_list|(
literal|0xf
argument_list|,
literal|8
argument_list|,
literal|1
argument_list|)
block|,
comment|/* short-dashed */
name|XMakePattern
argument_list|(
literal|0x7f
argument_list|,
literal|11
argument_list|,
literal|1
argument_list|)
block|,
comment|/* long-dashed */
block|}
decl_stmt|;
end_decl_stmt

begin_macro
name|TekInit
argument_list|()
end_macro

begin_block
block|{
specifier|register
name|Screen
modifier|*
name|screen
init|=
operator|&
name|term
operator|.
name|screen
decl_stmt|;
specifier|register
name|int
name|i
decl_stmt|,
name|j
decl_stmt|;
specifier|register
name|TekLink
modifier|*
name|tek
decl_stmt|;
specifier|register
name|int
name|width
decl_stmt|,
name|height
decl_stmt|;
specifier|register
name|double
name|d
decl_stmt|;
specifier|register
name|int
name|border
init|=
literal|2
operator|*
name|screen
operator|->
name|border
decl_stmt|;
name|OpaqueFrame
name|twindow
decl_stmt|;
name|FontInfo
name|finfo
decl_stmt|,
name|ifinfo
decl_stmt|;
name|char
name|Tdefault
index|[
literal|32
index|]
decl_stmt|;
name|char
name|iconname
index|[
literal|128
index|]
decl_stmt|;
name|WindowInfo
name|wininfo
decl_stmt|;
name|Color
name|cdef
decl_stmt|;
name|int
name|pixels
index|[
literal|2
index|]
decl_stmt|;
specifier|static
name|short
name|Tfailed
decl_stmt|;
name|int
name|x
decl_stmt|,
name|y
decl_stmt|;
name|Window
name|win
decl_stmt|;
specifier|extern
name|char
modifier|*
name|malloc
parameter_list|()
function_decl|;
name|screen
operator|->
name|mappedTwin
operator|=
operator|&
name|screen
operator|->
name|fullTwin
expr_stmt|;
if|if
condition|(
name|Tfailed
condition|)
return|return
operator|(
literal|0
operator|)
return|;
if|if
condition|(
operator|!
operator|(
name|screen
operator|->
name|Tfont
index|[
name|SMALLFONT
index|]
operator|=
name|XGetFont
argument_list|(
name|SMALLFONTNAME
argument_list|)
operator|)
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"%s: Could not get font %s!\n"
argument_list|,
name|xterm_name
argument_list|,
name|SMALLFONTNAME
argument_list|)
expr_stmt|;
goto|goto
name|fontfailed
goto|;
block|}
if|if
condition|(
operator|(
name|Tbuffer
operator|=
operator|(
name|char
operator|*
operator|)
name|malloc
argument_list|(
name|BUF_SIZE
argument_list|)
operator|)
operator|==
name|NULL
operator|||
operator|(
name|Tpushb
operator|=
operator|(
name|char
operator|*
operator|)
name|malloc
argument_list|(
literal|10
argument_list|)
operator|)
operator|==
name|NULL
operator|||
operator|(
name|Tline
operator|=
operator|(
name|Vertex
operator|*
operator|)
name|malloc
argument_list|(
name|MAX_VTX
operator|*
sizeof|sizeof
argument_list|(
name|Vertex
argument_list|)
argument_list|)
operator|)
operator|==
name|NULL
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"%s: Not enough core for Tek mode\n"
argument_list|,
name|xterm_name
argument_list|)
expr_stmt|;
goto|goto
name|mallocfailed
goto|;
block|}
name|screen
operator|->
name|xorplane
operator|=
literal|1
expr_stmt|;
name|screen
operator|->
name|Tbackground
operator|=
name|W_Pixel
expr_stmt|;
name|screen
operator|->
name|Tforeground
operator|=
name|B_Pixel
expr_stmt|;
name|screen
operator|->
name|Tcursorcolor
operator|=
name|B_Pixel
expr_stmt|;
if|if
condition|(
name|DisplayCells
argument_list|()
operator|>
literal|2
operator|&&
operator|(
name|fore_color
operator|||
name|back_color
operator|||
name|curs_color
operator|)
condition|)
block|{
if|if
condition|(
name|curs_color
operator|&&
name|XParseColor
argument_list|(
name|curs_color
argument_list|,
operator|&
name|cdef
argument_list|)
condition|)
block|{
if|if
condition|(
name|XGetColorCells
argument_list|(
literal|0
argument_list|,
literal|2
argument_list|,
literal|1
argument_list|,
operator|&
name|screen
operator|->
name|xorplane
argument_list|,
name|pixels
argument_list|)
condition|)
block|{
name|screen
operator|->
name|cellsused
operator|=
name|TRUE
expr_stmt|;
name|screen
operator|->
name|colorcells
index|[
literal|2
index|]
operator|=
name|cdef
expr_stmt|;
name|screen
operator|->
name|Tbackground
operator|=
name|pixels
index|[
literal|0
index|]
expr_stmt|;
name|screen
operator|->
name|Tforeground
operator|=
name|pixels
index|[
literal|1
index|]
expr_stmt|;
name|screen
operator|->
name|Tcursorcolor
operator|=
name|screen
operator|->
name|Tbackground
operator||
name|screen
operator|->
name|xorplane
expr_stmt|;
name|screen
operator|->
name|Tcolor
operator||=
name|C_CURSOR
expr_stmt|;
name|screen
operator|->
name|planeused
operator|=
name|TRUE
expr_stmt|;
block|}
block|}
elseif|else
if|if
condition|(
name|XGetColorCells
argument_list|(
literal|0
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|,
operator|&
name|screen
operator|->
name|xorplane
argument_list|,
operator|&
name|screen
operator|->
name|Tbackground
argument_list|)
condition|)
block|{
name|screen
operator|->
name|Tforeground
operator|=
name|screen
operator|->
name|Tbackground
operator||
name|screen
operator|->
name|xorplane
expr_stmt|;
name|screen
operator|->
name|Tcursorcolor
operator|=
name|screen
operator|->
name|Tforeground
expr_stmt|;
name|screen
operator|->
name|planeused
operator|=
name|TRUE
expr_stmt|;
block|}
if|if
condition|(
name|screen
operator|->
name|Tbackground
operator|!=
name|W_Pixel
condition|)
block|{
if|if
condition|(
name|back_color
operator|==
name|NULL
operator|||
operator|!
name|XParseColor
argument_list|(
name|back_color
argument_list|,
operator|&
name|cdef
argument_list|)
condition|)
block|{
name|cdef
operator|.
name|pixel
operator|=
name|W_Pixel
expr_stmt|;
name|XQueryColor
argument_list|(
operator|&
name|cdef
argument_list|)
expr_stmt|;
name|screen
operator|->
name|Tcolor
operator||=
name|C_BACKGROUND
expr_stmt|;
block|}
name|cdef
operator|.
name|pixel
operator|=
name|screen
operator|->
name|Tbackground
expr_stmt|;
name|XStoreColor
argument_list|(
operator|&
name|cdef
argument_list|)
expr_stmt|;
if|if
condition|(
name|screen
operator|->
name|cellsused
condition|)
block|{
name|screen
operator|->
name|colorcells
index|[
literal|0
index|]
operator|=
name|cdef
expr_stmt|;
name|cdef
operator|.
name|pixel
operator|=
name|screen
operator|->
name|Tforeground
operator||
name|screen
operator|->
name|xorplane
expr_stmt|;
name|XStoreColor
argument_list|(
operator|&
name|cdef
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|fore_color
operator|==
name|NULL
operator|||
operator|!
name|XParseColor
argument_list|(
name|fore_color
argument_list|,
operator|&
name|cdef
argument_list|)
condition|)
block|{
name|cdef
operator|.
name|pixel
operator|=
name|B_Pixel
expr_stmt|;
name|XQueryColor
argument_list|(
operator|&
name|cdef
argument_list|)
expr_stmt|;
name|screen
operator|->
name|Tcolor
operator||=
name|C_FOREGROUND
expr_stmt|;
block|}
name|cdef
operator|.
name|pixel
operator|=
name|screen
operator|->
name|Tforeground
expr_stmt|;
name|XStoreColor
argument_list|(
operator|&
name|cdef
argument_list|)
expr_stmt|;
if|if
condition|(
name|screen
operator|->
name|cellsused
condition|)
block|{
name|screen
operator|->
name|colorcells
index|[
literal|1
index|]
operator|=
name|cdef
expr_stmt|;
name|cdef
operator|.
name|pixel
operator|=
name|screen
operator|->
name|Tcursorcolor
expr_stmt|;
name|XStoreColor
argument_list|(
operator|&
name|cdef
argument_list|)
expr_stmt|;
block|}
block|}
block|}
if|if
condition|(
name|term
operator|.
name|flags
operator|&
name|REVERSE_VIDEO
condition|)
block|{
name|screen
operator|->
name|Tbgndtile
operator|=
name|NULL
expr_stmt|;
name|TekReverseVideo
argument_list|(
name|screen
argument_list|)
expr_stmt|;
block|}
else|else
name|TekBackground
argument_list|(
name|screen
argument_list|)
expr_stmt|;
name|twindow
operator|.
name|bdrwidth
operator|=
name|screen
operator|->
name|borderwidth
expr_stmt|;
if|if
condition|(
name|grayborder
condition|)
name|twindow
operator|.
name|border
operator|=
name|screen
operator|->
name|graybordertile
expr_stmt|;
else|else
name|twindow
operator|.
name|border
operator|=
name|screen
operator|->
name|bordertile
expr_stmt|;
name|twindow
operator|.
name|background
operator|=
name|screen
operator|->
name|Tbgndtile
expr_stmt|;
name|sprintf
argument_list|(
name|Tdefault
argument_list|,
literal|"=%dx%d+1+1"
argument_list|,
name|TEKDEFWIDTH
operator|+
name|border
argument_list|,
name|TEKDEFHEIGHT
operator|+
name|TTitlebar
argument_list|(
name|screen
argument_list|)
operator|+
name|border
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|TWindow
argument_list|(
name|screen
argument_list|)
operator|=
name|XCreate
argument_list|(
literal|"Tektronix Emulator"
argument_list|,
name|xterm_name
argument_list|,
name|T_geometry
argument_list|,
name|Tdefault
argument_list|,
operator|&
name|twindow
argument_list|,
name|TEKMINWIDTH
operator|+
name|border
argument_list|,
name|TEKMINHEIGHT
operator|+
name|TTitlebar
argument_list|(
name|screen
argument_list|)
operator|+
name|border
argument_list|)
operator|)
operator|==
name|NULL
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"%s: Can't create Tek window\n"
argument_list|,
name|xterm_name
argument_list|)
expr_stmt|;
name|free
argument_list|(
operator|(
name|char
operator|*
operator|)
name|Tline
argument_list|)
expr_stmt|;
name|mallocfailed
label|:
if|if
condition|(
name|Tpushb
condition|)
name|free
argument_list|(
operator|(
name|char
operator|*
operator|)
name|Tpushb
argument_list|)
expr_stmt|;
if|if
condition|(
name|Tbuffer
condition|)
name|free
argument_list|(
operator|(
name|char
operator|*
operator|)
name|Tbuffer
argument_list|)
expr_stmt|;
name|XFreeFont
argument_list|(
name|screen
operator|->
name|Tfont
index|[
name|SMALLFONT
index|]
argument_list|)
expr_stmt|;
name|fontfailed
label|:
name|Tfailed
operator|=
name|TRUE
expr_stmt|;
return|return
operator|(
name|FALSE
operator|)
return|;
block|}
name|XSelectInput
argument_list|(
name|TWindow
argument_list|(
name|screen
argument_list|)
argument_list|,
name|TWINDOWEVENTS
argument_list|)
expr_stmt|;
name|screen
operator|->
name|Tbox
operator|=
name|T_box
expr_stmt|;
comment|/* 	 * XCreate flushes all events, which might include an EnterWindow 	 * or LeaveWindow.  So if the cursor is not where it is supposed to 	 * be, we set select to the appropriate thing. 	 */
if|if
condition|(
name|VWindow
argument_list|(
name|screen
argument_list|)
operator|&&
name|XQueryMouse
argument_list|(
name|RootWindow
argument_list|,
operator|&
name|x
argument_list|,
operator|&
name|y
argument_list|,
operator|&
name|win
argument_list|)
condition|)
block|{
if|if
condition|(
name|screen
operator|->
name|timer
condition|)
block|{
name|Timer
argument_list|(
literal|0L
argument_list|)
expr_stmt|;
name|screen
operator|->
name|timer
operator|=
literal|0
expr_stmt|;
block|}
if|if
condition|(
name|win
operator|==
name|VWindow
argument_list|(
name|screen
argument_list|)
condition|)
name|screen
operator|->
name|select
operator||=
name|INWINDOW
expr_stmt|;
else|else
name|screen
operator|->
name|select
operator|&=
operator|~
name|INWINDOW
expr_stmt|;
block|}
name|TFullWidth
argument_list|(
name|screen
argument_list|)
operator|=
name|twindow
operator|.
name|width
expr_stmt|;
name|TFullHeight
argument_list|(
name|screen
argument_list|)
operator|=
name|twindow
operator|.
name|height
expr_stmt|;
name|TWidth
argument_list|(
name|screen
argument_list|)
operator|=
name|twindow
operator|.
name|width
operator|-
name|border
expr_stmt|;
name|THeight
argument_list|(
name|screen
argument_list|)
operator|=
name|twindow
operator|.
name|height
operator|-
name|TTitlebar
argument_list|(
name|screen
argument_list|)
operator|-
name|border
expr_stmt|;
name|TekScale
argument_list|(
name|screen
argument_list|)
operator|=
operator|(
name|double
operator|)
name|TWidth
argument_list|(
name|screen
argument_list|)
operator|/
operator|(
name|TEKWIDTH
operator|+
name|TEKPAD
operator|)
expr_stmt|;
if|if
condition|(
operator|(
name|d
operator|=
operator|(
name|double
operator|)
name|THeight
argument_list|(
name|screen
argument_list|)
operator|/
operator|(
name|TEKHEIGHT
operator|+
name|TEKTOPPAD
operator|+
name|TEKBOTTOMPAD
operator|)
operator|)
operator|<
name|TekScale
argument_list|(
name|screen
argument_list|)
condition|)
name|TekScale
argument_list|(
name|screen
argument_list|)
operator|=
name|d
expr_stmt|;
name|XQueryFont
argument_list|(
name|screen
operator|->
name|Tfont
index|[
name|SMALLFONT
index|]
argument_list|,
operator|&
name|finfo
argument_list|)
expr_stmt|;
name|screen
operator|->
name|tobaseline
index|[
name|SMALLFONT
index|]
operator|=
name|finfo
operator|.
name|height
operator|-
name|finfo
operator|.
name|baseline
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|screen
operator|->
name|Tfont
index|[
name|THREEFONT
index|]
operator|=
name|XGetFont
argument_list|(
name|THREEFONTNAME
argument_list|)
operator|)
condition|)
name|screen
operator|->
name|Tfont
index|[
name|THREEFONT
index|]
operator|=
name|screen
operator|->
name|Tfont
index|[
name|SMALLFONT
index|]
expr_stmt|;
else|else
name|XQueryFont
argument_list|(
name|screen
operator|->
name|Tfont
index|[
name|THREEFONT
index|]
argument_list|,
operator|&
name|finfo
argument_list|)
expr_stmt|;
name|screen
operator|->
name|tobaseline
index|[
name|THREEFONT
index|]
operator|=
name|finfo
operator|.
name|height
operator|-
name|finfo
operator|.
name|baseline
expr_stmt|;
if|if
condition|(
operator|!
name|screen
operator|->
name|fnt_icon
condition|)
name|screen
operator|->
name|fnt_icon
operator|=
name|XGetFont
argument_list|(
name|f_i
argument_list|)
expr_stmt|;
name|screen
operator|->
name|Tfont
index|[
name|ICONFONT
index|]
operator|=
name|screen
operator|->
name|fnt_icon
expr_stmt|;
name|XQueryFont
argument_list|(
name|screen
operator|->
name|fnt_icon
argument_list|,
operator|&
name|ifinfo
argument_list|)
expr_stmt|;
name|Tfontsize
index|[
name|ICONFONT
index|]
operator|.
name|Twidth
operator|=
name|ifinfo
operator|.
name|width
expr_stmt|;
name|Tfontsize
index|[
name|ICONFONT
index|]
operator|.
name|Theight
operator|=
name|ifinfo
operator|.
name|height
expr_stmt|;
name|screen
operator|->
name|tobaseline
index|[
name|ICONFONT
index|]
operator|=
name|ifinfo
operator|.
name|height
operator|-
name|ifinfo
operator|.
name|baseline
expr_stmt|;
name|T_boxicon
index|[
literal|1
index|]
operator|.
name|x
operator|=
name|ifinfo
operator|.
name|width
operator|-
literal|1
expr_stmt|;
name|T_boxicon
index|[
literal|2
index|]
operator|.
name|y
operator|=
name|ifinfo
operator|.
name|height
operator|-
literal|1
expr_stmt|;
name|T_boxicon
index|[
literal|3
index|]
operator|.
name|x
operator|=
operator|-
name|ifinfo
operator|.
name|width
operator|+
literal|1
expr_stmt|;
name|T_boxicon
index|[
literal|4
index|]
operator|.
name|y
operator|=
operator|-
name|ifinfo
operator|.
name|height
operator|+
literal|1
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|screen
operator|->
name|Tfont
index|[
name|TWOFONT
index|]
operator|=
name|XGetFont
argument_list|(
name|TWOFONTNAME
argument_list|)
operator|)
condition|)
name|screen
operator|->
name|Tfont
index|[
name|TWOFONT
index|]
operator|=
name|screen
operator|->
name|Tfont
index|[
name|THREEFONT
index|]
expr_stmt|;
else|else
name|XQueryFont
argument_list|(
name|screen
operator|->
name|Tfont
index|[
name|TWOFONT
index|]
argument_list|,
operator|&
name|finfo
argument_list|)
expr_stmt|;
name|screen
operator|->
name|tobaseline
index|[
name|TWOFONT
index|]
operator|=
name|finfo
operator|.
name|height
operator|-
name|finfo
operator|.
name|baseline
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|screen
operator|->
name|Tfont
index|[
name|LARGEFONT
index|]
operator|=
name|XGetFont
argument_list|(
name|LARGEFONTNAME
argument_list|)
operator|)
condition|)
name|screen
operator|->
name|Tfont
index|[
name|LARGEFONT
index|]
operator|=
name|screen
operator|->
name|Tfont
index|[
name|TWOFONT
index|]
expr_stmt|;
else|else
name|XQueryFont
argument_list|(
name|screen
operator|->
name|Tfont
index|[
name|LARGEFONT
index|]
argument_list|,
operator|&
name|finfo
argument_list|)
expr_stmt|;
name|screen
operator|->
name|tobaseline
index|[
name|LARGEFONT
index|]
operator|=
name|finfo
operator|.
name|height
operator|-
name|finfo
operator|.
name|baseline
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|TEKNUMLINES
condition|;
name|i
operator|++
control|)
name|screen
operator|->
name|linepat
index|[
name|i
index|]
operator|=
name|Tpattern
index|[
name|i
index|]
expr_stmt|;
name|screen
operator|->
name|margin
operator|=
name|MARGIN1
expr_stmt|;
comment|/* Margin 1		*/
name|screen
operator|->
name|cur
operator|.
name|fontsize
operator|=
name|LARGEFONT
expr_stmt|;
comment|/* set large font	*/
name|screen
operator|->
name|TekGIN
operator|=
name|FALSE
expr_stmt|;
comment|/* GIN off		*/
if|if
condition|(
name|screen
operator|->
name|iconVwin
operator|.
name|window
condition|)
block|{
name|XQueryWindow
argument_list|(
name|screen
operator|->
name|iconVwin
operator|.
name|window
argument_list|,
operator|&
name|wininfo
argument_list|)
expr_stmt|;
name|x
operator|=
name|wininfo
operator|.
name|x
expr_stmt|;
name|y
operator|=
name|wininfo
operator|.
name|y
expr_stmt|;
block|}
else|else
block|{
name|x
operator|=
name|twindow
operator|.
name|x
operator|+
operator|(
name|twindow
operator|.
name|width
operator|-
name|screen
operator|->
name|iconTwin
operator|.
name|width
operator|)
operator|/
literal|2
expr_stmt|;
name|y
operator|=
name|twindow
operator|.
name|y
operator|+
operator|(
name|twindow
operator|.
name|height
operator|-
name|screen
operator|->
name|iconTwin
operator|.
name|height
operator|)
operator|/
literal|2
expr_stmt|;
name|IconGeometry
argument_list|(
name|screen
argument_list|,
operator|&
name|x
argument_list|,
operator|&
name|y
argument_list|)
expr_stmt|;
block|}
name|screen
operator|->
name|iconTwin
operator|.
name|window
operator|=
name|XCreateWindow
argument_list|(
name|RootWindow
argument_list|,
name|x
argument_list|,
name|y
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|,
name|screen
operator|->
name|borderwidth
argument_list|,
name|screen
operator|->
name|bordertile
argument_list|,
name|screen
operator|->
name|bgndtile
argument_list|)
expr_stmt|;
name|TSetIconSize
argument_list|(
name|screen
argument_list|)
expr_stmt|;
name|XSetIconWindow
argument_list|(
name|screen
operator|->
name|fullTwin
operator|.
name|window
argument_list|,
name|screen
operator|->
name|iconTwin
operator|.
name|window
argument_list|)
expr_stmt|;
name|XDefineCursor
argument_list|(
name|screen
operator|->
name|iconTwin
operator|.
name|window
argument_list|,
name|screen
operator|->
name|arrow
argument_list|)
expr_stmt|;
name|XSelectInput
argument_list|(
name|screen
operator|->
name|iconTwin
operator|.
name|window
argument_list|,
name|screen
operator|->
name|active_icon
operator|&&
operator|(
name|term
operator|.
name|flags
operator|&
name|ICONINPUT
operator|)
condition|?
name|TICONWINDOWEVENTS
operator||
name|ICONINPUTEVENTS
else|:
name|TICONWINDOWEVENTS
argument_list|)
expr_stmt|;
name|XDefineCursor
argument_list|(
name|TWindow
argument_list|(
name|screen
argument_list|)
argument_list|,
name|screen
operator|->
name|curs
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|screen
operator|->
name|Twinname
operator|=
name|malloc
argument_list|(
name|screen
operator|->
name|winnamelen
operator|+
literal|6
argument_list|)
operator|)
operator|==
name|NULL
condition|)
name|Error
argument_list|(
name|ERROR_TWINNAME
argument_list|)
expr_stmt|;
name|strcpy
argument_list|(
name|screen
operator|->
name|Twinname
argument_list|,
name|screen
operator|->
name|winname
argument_list|)
expr_stmt|;
name|strcat
argument_list|(
name|screen
operator|->
name|Twinname
argument_list|,
literal|" (Tek)"
argument_list|)
expr_stmt|;
name|screen
operator|->
name|Twinnamelen
operator|=
name|strlen
argument_list|(
name|screen
operator|->
name|Twinname
argument_list|)
expr_stmt|;
name|XStoreName
argument_list|(
name|TWindow
argument_list|(
name|screen
argument_list|)
argument_list|,
name|screen
operator|->
name|Twinname
argument_list|)
expr_stmt|;
name|strcpy
argument_list|(
name|iconname
argument_list|,
name|screen
operator|->
name|winname
argument_list|)
expr_stmt|;
name|strcat
argument_list|(
name|iconname
argument_list|,
literal|" (icon)"
argument_list|)
expr_stmt|;
name|XStoreName
argument_list|(
name|screen
operator|->
name|iconTwin
operator|.
name|window
argument_list|,
name|iconname
argument_list|)
expr_stmt|;
name|XSetResizeHint
argument_list|(
name|TWindow
argument_list|(
name|screen
argument_list|)
argument_list|,
name|TEKMINWIDTH
operator|+
name|border
argument_list|,
name|TEKMINHEIGHT
operator|+
name|border
operator|+
name|TTitlebar
argument_list|(
name|screen
argument_list|)
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|tek
operator|=
name|TekRecord
operator|=
operator|&
name|Tek0
expr_stmt|;
name|tek
operator|->
name|next
operator|=
operator|(
name|TekLink
operator|*
operator|)
literal|0
expr_stmt|;
name|tek
operator|->
name|count
operator|=
literal|0
expr_stmt|;
name|tek
operator|->
name|ptr
operator|=
name|tek
operator|->
name|data
expr_stmt|;
name|Tpushback
operator|=
name|Tpushb
expr_stmt|;
name|screen
operator|->
name|cur_X
operator|=
literal|0
expr_stmt|;
name|screen
operator|->
name|cur_Y
operator|=
name|TEKHOME
expr_stmt|;
name|line_pt
operator|=
name|Tline
expr_stmt|;
name|Ttoggled
operator|=
name|TRUE
expr_stmt|;
if|if
condition|(
name|TTitlebar
argument_list|(
name|screen
argument_list|)
condition|)
name|TekTitleShow
argument_list|(
name|TRUE
argument_list|)
expr_stmt|;
name|Tparsestate
operator|=
name|curstate
operator|=
name|Talptable
expr_stmt|;
return|return
operator|(
name|TRUE
operator|)
return|;
block|}
end_block

begin_expr_stmt
name|TekReverseVideo
argument_list|(
name|screen
argument_list|)
specifier|register
name|Screen
operator|*
name|screen
expr_stmt|;
end_expr_stmt

begin_block
block|{
specifier|register
name|int
name|flag
decl_stmt|,
name|i
decl_stmt|;
if|if
condition|(
name|screen
operator|->
name|Tbgndtile
operator|&&
operator|(
operator|(
name|screen
operator|->
name|Tcolor
operator|&
name|C_BACKGROUND
operator|)
operator|||
name|screen
operator|->
name|planeused
operator|)
condition|)
name|XFreePixmap
argument_list|(
name|screen
operator|->
name|Tbgndtile
argument_list|)
expr_stmt|;
name|i
operator|=
name|screen
operator|->
name|Tbackground
expr_stmt|;
name|screen
operator|->
name|Tbackground
operator|=
name|screen
operator|->
name|Tforeground
expr_stmt|;
name|screen
operator|->
name|Tforeground
operator|=
name|i
expr_stmt|;
name|screen
operator|->
name|Tcolor
operator|=
operator|(
name|screen
operator|->
name|Tcolor
operator|&
operator|~
name|C_FBMASK
operator|)
operator||
name|switchfb
index|[
name|screen
operator|->
name|Tcolor
operator|&
name|C_FBMASK
index|]
expr_stmt|;
if|if
condition|(
name|screen
operator|->
name|cellsused
condition|)
block|{
name|flag
operator|=
operator|(
name|term
operator|.
name|flags
operator|&
name|REVERSE_VIDEO
operator|)
operator|!=
literal|0
expr_stmt|;
name|screen
operator|->
name|Tcursorcolor
operator|=
name|screen
operator|->
name|Tbackground
operator||
name|screen
operator|->
name|xorplane
expr_stmt|;
name|i
operator|=
name|screen
operator|->
name|select
condition|?
literal|2
else|:
operator|!
name|flag
expr_stmt|;
name|screen
operator|->
name|colorcells
index|[
name|i
index|]
operator|.
name|pixel
operator|=
name|screen
operator|->
name|Tcursorcolor
expr_stmt|;
name|XStoreColor
argument_list|(
operator|&
name|screen
operator|->
name|colorcells
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|screen
operator|->
name|colorcells
index|[
name|flag
index|]
operator|.
name|pixel
operator|=
name|screen
operator|->
name|Tforeground
operator||
name|screen
operator|->
name|xorplane
expr_stmt|;
name|XStoreColor
argument_list|(
operator|&
name|screen
operator|->
name|colorcells
index|[
name|flag
index|]
argument_list|)
expr_stmt|;
block|}
else|else
name|screen
operator|->
name|Tcursorcolor
operator|=
name|screen
operator|->
name|Tforeground
expr_stmt|;
name|TekBackground
argument_list|(
name|screen
argument_list|)
expr_stmt|;
block|}
end_block

begin_expr_stmt
name|TekBackground
argument_list|(
name|screen
argument_list|)
specifier|register
name|Screen
operator|*
name|screen
expr_stmt|;
end_expr_stmt

begin_block
block|{
if|if
condition|(
operator|(
name|screen
operator|->
name|Tcolor
operator|&
name|C_BACKGROUND
operator|)
operator|||
name|screen
operator|->
name|planeused
condition|)
block|{
if|if
condition|(
operator|!
operator|(
name|screen
operator|->
name|Tbgndtile
operator|=
name|XMakeTile
argument_list|(
name|screen
operator|->
name|Tbackground
argument_list|)
operator|)
condition|)
name|Error
argument_list|(
name|ERROR_TBACK
argument_list|)
expr_stmt|;
block|}
else|else
name|screen
operator|->
name|Tbgndtile
operator|=
operator|(
name|screen
operator|->
name|Tbackground
operator|==
name|W_Pixel
operator|)
condition|?
name|W_Pixmap
else|:
name|B_Pixmap
expr_stmt|;
if|if
condition|(
name|TWindow
argument_list|(
name|screen
argument_list|)
condition|)
name|XChangeBackground
argument_list|(
name|TWindow
argument_list|(
name|screen
argument_list|)
argument_list|,
name|screen
operator|->
name|Tbgndtile
argument_list|)
expr_stmt|;
block|}
end_block

begin_comment
comment|/*  * Toggles cursor on or off at cursor position in screen.  */
end_comment

begin_macro
name|TCursorToggle
argument_list|(
argument|toggle
argument_list|)
end_macro

begin_decl_stmt
name|int
name|toggle
decl_stmt|;
end_decl_stmt

begin_block
block|{
specifier|register
name|Screen
modifier|*
name|screen
init|=
operator|&
name|term
operator|.
name|screen
decl_stmt|;
specifier|register
name|int
name|c
decl_stmt|,
name|x
decl_stmt|,
name|y
decl_stmt|;
specifier|register
name|T_fontsize
modifier|*
name|Tf
decl_stmt|;
specifier|register
name|int
name|pixel
decl_stmt|,
name|func
decl_stmt|,
name|planes
decl_stmt|;
if|if
condition|(
name|screen
operator|->
name|icon_show
operator|&&
operator|!
name|screen
operator|->
name|active_icon
condition|)
return|return;
if|if
condition|(
name|toggle
condition|)
block|{
name|pixel
operator|=
name|screen
operator|->
name|Tcursorcolor
expr_stmt|;
name|func
operator|=
name|GXinvert
expr_stmt|;
name|planes
operator|=
name|screen
operator|->
name|xorplane
expr_stmt|;
block|}
else|else
block|{
name|pixel
operator|=
name|screen
operator|->
name|Tbackground
expr_stmt|;
name|func
operator|=
name|GXcopy
expr_stmt|;
name|planes
operator|=
name|AllPlanes
expr_stmt|;
block|}
name|c
operator|=
name|TActiveIcon
argument_list|(
name|screen
argument_list|)
condition|?
name|ICONFONT
else|:
name|screen
operator|->
name|cur
operator|.
name|fontsize
expr_stmt|;
name|x
operator|=
operator|(
name|screen
operator|->
name|cur_X
operator|*
name|TekScale
argument_list|(
name|screen
argument_list|)
operator|)
operator|+
name|screen
operator|->
name|border
expr_stmt|;
name|y
operator|=
operator|(
operator|(
name|TEKHEIGHT
operator|+
name|TEKTOPPAD
operator|-
name|screen
operator|->
name|cur_Y
operator|)
operator|*
name|TekScale
argument_list|(
name|screen
argument_list|)
operator|)
operator|+
name|screen
operator|->
name|border
operator|-
name|screen
operator|->
name|tobaseline
index|[
name|c
index|]
operator|+
name|TTitlebar
argument_list|(
name|screen
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|toggle
operator|||
name|screen
operator|->
name|select
condition|)
block|{
name|Tf
operator|=
operator|&
name|Tfontsize
index|[
name|c
index|]
expr_stmt|;
name|XPixFill
argument_list|(
name|TWindow
argument_list|(
name|screen
argument_list|)
argument_list|,
name|x
argument_list|,
name|y
argument_list|,
name|Tf
operator|->
name|Twidth
argument_list|,
name|Tf
operator|->
name|Theight
argument_list|,
name|pixel
argument_list|,
operator|(
name|Bitmap
operator|)
literal|0
argument_list|,
name|func
argument_list|,
name|planes
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|screen
operator|->
name|Tbox
index|[
name|c
index|]
operator|->
name|x
operator|=
name|x
expr_stmt|;
name|screen
operator|->
name|Tbox
index|[
name|c
index|]
operator|->
name|y
operator|=
name|y
expr_stmt|;
name|XDraw
argument_list|(
name|TWindow
argument_list|(
name|screen
argument_list|)
argument_list|,
name|screen
operator|->
name|Tbox
index|[
name|c
index|]
argument_list|,
name|NBOX
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|,
name|pixel
argument_list|,
name|func
argument_list|,
name|planes
argument_list|)
expr_stmt|;
block|}
block|}
end_block

begin_macro
name|TekSelect
argument_list|()
end_macro

begin_block
block|{
specifier|register
name|Screen
modifier|*
name|screen
init|=
operator|&
name|term
operator|.
name|screen
decl_stmt|;
if|if
condition|(
name|grayborder
operator|&&
name|screen
operator|->
name|borderwidth
operator|>
literal|0
condition|)
name|XChangeBorder
argument_list|(
name|TWindow
argument_list|(
name|screen
argument_list|)
argument_list|,
name|screen
operator|->
name|bordertile
argument_list|)
expr_stmt|;
if|if
condition|(
name|TTitlebar
argument_list|(
name|screen
argument_list|)
condition|)
name|TekTitleHilite
argument_list|()
expr_stmt|;
block|}
end_block

begin_macro
name|TekUnselect
argument_list|()
end_macro

begin_block
block|{
specifier|register
name|Screen
modifier|*
name|screen
init|=
operator|&
name|term
operator|.
name|screen
decl_stmt|;
if|if
condition|(
name|grayborder
operator|&&
name|screen
operator|->
name|borderwidth
operator|>
literal|0
condition|)
name|XChangeBorder
argument_list|(
name|TWindow
argument_list|(
name|screen
argument_list|)
argument_list|,
name|screen
operator|->
name|graybordertile
argument_list|)
expr_stmt|;
if|if
condition|(
name|TTitlebar
argument_list|(
name|screen
argument_list|)
condition|)
name|TekTitleUnhilite
argument_list|()
expr_stmt|;
block|}
end_block

begin_macro
name|TekCopy
argument_list|()
end_macro

begin_block
block|{
specifier|register
name|TekLink
modifier|*
name|Tp
decl_stmt|;
specifier|register
name|int
name|fd
decl_stmt|;
specifier|register
name|Screen
modifier|*
name|screen
init|=
operator|&
name|term
operator|.
name|screen
decl_stmt|;
specifier|register
name|char
modifier|*
name|cp
decl_stmt|;
specifier|register
name|struct
name|tm
modifier|*
name|tp
decl_stmt|;
name|long
name|l
decl_stmt|;
name|char
name|buf
index|[
literal|32
index|]
decl_stmt|;
comment|/* for login windows, check that a user has logged in */
if|if
condition|(
name|L_flag
operator|&&
operator|!
name|checklogin
argument_list|()
condition|)
block|{
name|Bell
argument_list|()
expr_stmt|;
return|return;
block|}
name|time
argument_list|(
operator|&
name|l
argument_list|)
expr_stmt|;
name|tp
operator|=
name|localtime
argument_list|(
operator|&
name|l
argument_list|)
expr_stmt|;
name|sprintf
argument_list|(
name|buf
argument_list|,
literal|"COPY%02d-%02d-%02d.%02d:%02d:%02d"
argument_list|,
name|tp
operator|->
name|tm_year
argument_list|,
name|tp
operator|->
name|tm_mon
argument_list|,
name|tp
operator|->
name|tm_mday
argument_list|,
name|tp
operator|->
name|tm_hour
argument_list|,
name|tp
operator|->
name|tm_min
argument_list|,
name|tp
operator|->
name|tm_sec
argument_list|)
expr_stmt|;
if|if
condition|(
name|access
argument_list|(
name|buf
argument_list|,
name|F_OK
argument_list|)
operator|>=
literal|0
condition|)
block|{
comment|/* file exists */
if|if
condition|(
name|access
argument_list|(
name|buf
argument_list|,
name|W_OK
argument_list|)
operator|<
literal|0
condition|)
block|{
name|Bell
argument_list|()
expr_stmt|;
return|return;
block|}
block|}
elseif|else
if|if
condition|(
name|access
argument_list|(
literal|"."
argument_list|,
name|W_OK
argument_list|)
operator|<
literal|0
condition|)
block|{
comment|/* can't write in directory */
name|Bell
argument_list|()
expr_stmt|;
return|return;
block|}
if|if
condition|(
operator|(
name|fd
operator|=
name|open
argument_list|(
name|buf
argument_list|,
name|O_WRONLY
operator||
name|O_CREAT
operator||
name|O_TRUNC
argument_list|,
literal|0644
argument_list|)
operator|)
operator|<
literal|0
condition|)
block|{
name|Bell
argument_list|()
expr_stmt|;
return|return;
block|}
name|chown
argument_list|(
name|buf
argument_list|,
name|screen
operator|->
name|uid
argument_list|,
name|screen
operator|->
name|gid
argument_list|)
expr_stmt|;
name|sprintf
argument_list|(
name|buf
argument_list|,
literal|"\033%c\033%c"
argument_list|,
name|screen
operator|->
name|page
operator|.
name|fontsize
operator|+
literal|'8'
argument_list|,
name|screen
operator|->
name|page
operator|.
name|linetype
operator|+
literal|'`'
argument_list|)
expr_stmt|;
name|write
argument_list|(
name|fd
argument_list|,
name|buf
argument_list|,
literal|4
argument_list|)
expr_stmt|;
name|Tp
operator|=
operator|&
name|Tek0
expr_stmt|;
do|do
name|write
argument_list|(
name|fd
argument_list|,
operator|(
name|char
operator|*
operator|)
name|Tp
operator|->
name|data
argument_list|,
name|Tp
operator|->
name|count
argument_list|)
expr_stmt|;
do|while
condition|(
name|Tp
operator|=
name|Tp
operator|->
name|next
condition|)
do|;
name|close
argument_list|(
name|fd
argument_list|)
expr_stmt|;
block|}
end_block

begin_macro
name|TekTitleShow
argument_list|(
argument|init
argument_list|)
end_macro

begin_decl_stmt
name|int
name|init
decl_stmt|;
end_decl_stmt

begin_block
block|{
specifier|register
name|Screen
modifier|*
name|screen
init|=
operator|&
name|term
operator|.
name|screen
decl_stmt|;
specifier|register
name|int
name|border
init|=
literal|2
operator|*
name|screen
operator|->
name|border
decl_stmt|;
if|if
condition|(
operator|!
name|screen
operator|->
name|Ttitle
operator|.
name|tbar
condition|)
name|TekTitleInit
argument_list|()
expr_stmt|;
if|if
condition|(
operator|!
name|init
condition|)
block|{
name|XSetResizeHint
argument_list|(
name|TWindow
argument_list|(
name|screen
argument_list|)
argument_list|,
name|TEKMINWIDTH
operator|+
name|border
argument_list|,
name|TEKMINHEIGHT
operator|+
name|border
operator|+
name|TTitlebar
argument_list|(
name|screen
argument_list|)
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|XChangeWindow
argument_list|(
name|TWindow
argument_list|(
name|screen
argument_list|)
argument_list|,
name|TWidth
argument_list|(
name|screen
argument_list|)
operator|+
name|border
argument_list|,
name|THeight
argument_list|(
name|screen
argument_list|)
operator|+
name|TTitlebar
argument_list|(
name|screen
argument_list|)
operator|+
name|border
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|screen
operator|->
name|select
operator|&&
name|screen
operator|->
name|TekEmu
condition|)
name|TekTitleHilite
argument_list|()
expr_stmt|;
else|else
name|TekTitleUnhilite
argument_list|()
expr_stmt|;
name|XMapWindow
argument_list|(
name|screen
operator|->
name|Ttitle
operator|.
name|tbar
argument_list|)
expr_stmt|;
block|}
end_block

begin_macro
name|TekTitleHide
argument_list|()
end_macro

begin_block
block|{
specifier|register
name|Screen
modifier|*
name|screen
init|=
operator|&
name|term
operator|.
name|screen
decl_stmt|;
specifier|register
name|int
name|border
init|=
literal|2
operator|*
name|screen
operator|->
name|border
decl_stmt|;
name|XUnmapWindow
argument_list|(
name|screen
operator|->
name|Ttitle
operator|.
name|tbar
argument_list|)
expr_stmt|;
name|XSetResizeHint
argument_list|(
name|TWindow
argument_list|(
name|screen
argument_list|)
argument_list|,
name|TEKMINWIDTH
operator|+
name|border
argument_list|,
name|TEKMINHEIGHT
operator|+
name|border
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|XChangeWindow
argument_list|(
name|TWindow
argument_list|(
name|screen
argument_list|)
argument_list|,
name|TWidth
argument_list|(
name|screen
argument_list|)
operator|+
name|border
argument_list|,
name|THeight
argument_list|(
name|screen
argument_list|)
operator|+
name|border
argument_list|)
expr_stmt|;
block|}
end_block

begin_macro
name|TekTitleHilite
argument_list|()
end_macro

begin_block
block|{
specifier|register
name|Screen
modifier|*
name|screen
init|=
operator|&
name|term
operator|.
name|screen
decl_stmt|;
if|if
condition|(
name|screen
operator|->
name|Ttitle
operator|.
name|hilited
condition|)
return|return;
name|XMapWindow
argument_list|(
name|screen
operator|->
name|Ttitle
operator|.
name|left
argument_list|)
expr_stmt|;
name|XMapWindow
argument_list|(
name|screen
operator|->
name|Ttitle
operator|.
name|right
argument_list|)
expr_stmt|;
name|screen
operator|->
name|Ttitle
operator|.
name|hilited
operator|=
name|TRUE
expr_stmt|;
block|}
end_block

begin_macro
name|TekTitleUnhilite
argument_list|()
end_macro

begin_block
block|{
specifier|register
name|Screen
modifier|*
name|screen
init|=
operator|&
name|term
operator|.
name|screen
decl_stmt|;
if|if
condition|(
operator|!
name|screen
operator|->
name|Ttitle
operator|.
name|hilited
condition|)
return|return;
name|XUnmapWindow
argument_list|(
name|screen
operator|->
name|Ttitle
operator|.
name|left
argument_list|)
expr_stmt|;
name|XUnmapWindow
argument_list|(
name|screen
operator|->
name|Ttitle
operator|.
name|right
argument_list|)
expr_stmt|;
name|screen
operator|->
name|Ttitle
operator|.
name|hilited
operator|=
name|FALSE
expr_stmt|;
block|}
end_block

begin_expr_stmt
name|TekTitleResize
argument_list|(
name|width
argument_list|)
specifier|register
name|int
name|width
expr_stmt|;
end_expr_stmt

begin_block
block|{
specifier|register
name|Screen
modifier|*
name|screen
init|=
operator|&
name|term
operator|.
name|screen
decl_stmt|;
specifier|register
name|int
name|i
decl_stmt|,
name|j
decl_stmt|;
if|if
condition|(
operator|(
name|screen
operator|->
name|Ttitle
operator|.
name|width
operator|=
name|i
operator|=
name|screen
operator|->
name|Ttitle
operator|.
name|fullwidth
operator|)
operator|>
operator|(
name|j
operator|=
name|width
operator|-
literal|2
operator|*
operator|(
name|MINHILITE
operator|+
name|screen
operator|->
name|title_n_size
operator|+
literal|1
operator|)
operator|)
condition|)
name|screen
operator|->
name|Ttitle
operator|.
name|width
operator|=
operator|(
name|i
operator|=
name|j
operator|)
operator|+
name|screen
operator|->
name|title_n_size
expr_stmt|;
name|j
operator|=
name|width
operator|-
name|i
operator|-
literal|2
operator|*
operator|(
name|screen
operator|->
name|title_n_size
operator|+
literal|1
operator|)
expr_stmt|;
name|i
operator|=
name|j
operator|/
literal|2
expr_stmt|;
name|j
operator|-=
name|i
expr_stmt|;
name|screen
operator|->
name|Ttitle
operator|.
name|x
operator|=
name|i
operator|+
literal|1
operator|+
name|screen
operator|->
name|title_n_size
expr_stmt|;
name|XChangeWindow
argument_list|(
name|screen
operator|->
name|Ttitle
operator|.
name|tbar
argument_list|,
name|width
argument_list|,
name|screen
operator|->
name|titleheight
operator|-
literal|1
argument_list|)
expr_stmt|;
name|XChangeWindow
argument_list|(
name|screen
operator|->
name|Ttitle
operator|.
name|left
argument_list|,
name|i
argument_list|,
name|screen
operator|->
name|titlefont
operator|->
name|height
argument_list|)
expr_stmt|;
name|XConfigureWindow
argument_list|(
name|screen
operator|->
name|Ttitle
operator|.
name|right
argument_list|,
name|width
operator|-
name|j
operator|-
literal|1
argument_list|,
name|TITLEPAD
argument_list|,
name|j
argument_list|,
name|screen
operator|->
name|titlefont
operator|->
name|height
argument_list|)
expr_stmt|;
block|}
end_block

begin_expr_stmt
name|TekTitleExpose
argument_list|(
name|rep
argument_list|)
specifier|register
name|XExposeWindowEvent
operator|*
name|rep
expr_stmt|;
end_expr_stmt

begin_block
block|{
specifier|register
name|Screen
modifier|*
name|screen
init|=
operator|&
name|term
operator|.
name|screen
decl_stmt|;
if|if
condition|(
name|rep
operator|&&
operator|(
name|rep
operator|->
name|x
operator|>
operator|(
name|screen
operator|->
name|Ttitle
operator|.
name|x
operator|+
name|screen
operator|->
name|Ttitle
operator|.
name|width
operator|)
operator|||
operator|(
name|rep
operator|->
name|x
operator|+
name|rep
operator|->
name|width
operator|)
operator|<
name|screen
operator|->
name|Ttitle
operator|.
name|x
operator|||
name|rep
operator|->
name|y
operator|>
operator|(
name|screen
operator|->
name|Ttitle
operator|.
name|y
operator|+
name|screen
operator|->
name|titlefont
operator|->
name|height
operator|)
operator|||
operator|(
name|rep
operator|->
name|y
operator|+
name|rep
operator|->
name|height
operator|)
operator|<
name|screen
operator|->
name|Ttitle
operator|.
name|y
operator|)
condition|)
return|return;
name|XText
argument_list|(
name|screen
operator|->
name|Ttitle
operator|.
name|tbar
argument_list|,
name|screen
operator|->
name|Ttitle
operator|.
name|x
argument_list|,
name|screen
operator|->
name|Ttitle
operator|.
name|y
argument_list|,
name|screen
operator|->
name|Twinname
argument_list|,
name|screen
operator|->
name|Twinnamelen
argument_list|,
name|screen
operator|->
name|titlefont
operator|->
name|id
argument_list|,
name|screen
operator|->
name|foreground
argument_list|,
name|screen
operator|->
name|background
argument_list|)
expr_stmt|;
block|}
end_block

begin_macro
name|TekTitleInit
argument_list|()
end_macro

begin_block
block|{
specifier|register
name|Screen
modifier|*
name|screen
init|=
operator|&
name|term
operator|.
name|screen
decl_stmt|;
specifier|register
name|int
name|w
decl_stmt|,
name|i
decl_stmt|,
name|j
decl_stmt|;
name|OpaqueFrame
name|hilite
index|[
literal|2
index|]
decl_stmt|;
specifier|extern
name|Pixmap
name|make_hilite
parameter_list|()
function_decl|;
if|if
condition|(
operator|(
name|screen
operator|->
name|Ttitle
operator|.
name|tbar
operator|=
name|XCreateWindow
argument_list|(
name|TWindow
argument_list|(
name|screen
argument_list|)
argument_list|,
operator|-
literal|1
argument_list|,
operator|-
literal|1
argument_list|,
name|w
operator|=
name|TFullWidth
argument_list|(
name|screen
argument_list|)
argument_list|,
name|screen
operator|->
name|titleheight
operator|-
literal|1
argument_list|,
literal|1
argument_list|,
name|screen
operator|->
name|bordertile
argument_list|,
name|screen
operator|->
name|bgndtile
argument_list|)
operator|)
operator|==
name|NULL
condition|)
name|Error
argument_list|(
name|ERROR_TCRTITLE
argument_list|)
expr_stmt|;
name|XSelectInput
argument_list|(
name|screen
operator|->
name|Ttitle
operator|.
name|tbar
argument_list|,
name|ButtonPressed
operator||
name|ButtonReleased
operator||
name|ExposeWindow
operator||
name|EnterWindow
operator||
name|LeaveWindow
operator||
name|UnmapWindow
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|screen
operator|->
name|hilitetile
operator|&&
operator|(
name|screen
operator|->
name|hilitetile
operator|=
name|make_hilite
argument_list|(
name|screen
operator|->
name|foreground
argument_list|,
name|screen
operator|->
name|background
argument_list|)
operator|)
operator|==
name|NULL
condition|)
name|Error
argument_list|(
name|ERROR_THILITE
argument_list|)
expr_stmt|;
name|screen
operator|->
name|Ttitle
operator|.
name|fullwidth
operator|=
name|XQueryWidth
argument_list|(
name|screen
operator|->
name|Twinname
argument_list|,
name|screen
operator|->
name|titlefont
operator|->
name|id
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|screen
operator|->
name|Ttitle
operator|.
name|width
operator|=
name|i
operator|=
name|screen
operator|->
name|Ttitle
operator|.
name|fullwidth
operator|)
operator|>
operator|(
name|j
operator|=
name|w
operator|-
literal|2
operator|*
operator|(
name|MINHILITE
operator|+
name|screen
operator|->
name|title_n_size
operator|+
literal|1
operator|)
operator|)
condition|)
name|screen
operator|->
name|Ttitle
operator|.
name|width
operator|=
operator|(
name|i
operator|=
name|j
operator|)
operator|+
name|screen
operator|->
name|title_n_size
expr_stmt|;
name|j
operator|=
name|w
operator|-
name|i
operator|-
literal|2
operator|*
operator|(
name|screen
operator|->
name|title_n_size
operator|+
literal|1
operator|)
expr_stmt|;
name|i
operator|=
name|j
operator|/
literal|2
expr_stmt|;
name|j
operator|-=
name|i
expr_stmt|;
name|screen
operator|->
name|Ttitle
operator|.
name|x
operator|=
name|i
operator|+
literal|1
operator|+
name|screen
operator|->
name|title_n_size
expr_stmt|;
name|screen
operator|->
name|Ttitle
operator|.
name|y
operator|=
name|TITLEPAD
expr_stmt|;
name|hilite
index|[
literal|0
index|]
operator|.
name|x
operator|=
literal|1
expr_stmt|;
name|hilite
index|[
literal|1
index|]
operator|.
name|x
operator|=
name|w
operator|-
name|j
operator|-
literal|1
expr_stmt|;
name|hilite
index|[
literal|0
index|]
operator|.
name|y
operator|=
name|hilite
index|[
literal|1
index|]
operator|.
name|y
operator|=
name|TITLEPAD
expr_stmt|;
name|hilite
index|[
literal|0
index|]
operator|.
name|width
operator|=
name|i
expr_stmt|;
name|hilite
index|[
literal|1
index|]
operator|.
name|width
operator|=
name|j
expr_stmt|;
name|hilite
index|[
literal|0
index|]
operator|.
name|height
operator|=
name|hilite
index|[
literal|1
index|]
operator|.
name|height
operator|=
name|screen
operator|->
name|titlefont
operator|->
name|height
expr_stmt|;
name|hilite
index|[
literal|0
index|]
operator|.
name|bdrwidth
operator|=
name|hilite
index|[
literal|1
index|]
operator|.
name|bdrwidth
operator|=
literal|0
expr_stmt|;
name|hilite
index|[
literal|0
index|]
operator|.
name|border
operator|=
name|hilite
index|[
literal|1
index|]
operator|.
name|border
operator|=
name|NULL
expr_stmt|;
name|hilite
index|[
literal|0
index|]
operator|.
name|background
operator|=
name|hilite
index|[
literal|1
index|]
operator|.
name|background
operator|=
name|screen
operator|->
name|hilitetile
expr_stmt|;
if|if
condition|(
name|XCreateWindows
argument_list|(
name|screen
operator|->
name|Ttitle
operator|.
name|tbar
argument_list|,
name|hilite
argument_list|,
literal|2
argument_list|)
operator|!=
literal|2
condition|)
name|Error
argument_list|(
name|ERROR_TCRLFRG
argument_list|)
expr_stmt|;
name|screen
operator|->
name|Ttitle
operator|.
name|left
operator|=
name|hilite
index|[
literal|0
index|]
operator|.
name|self
expr_stmt|;
name|screen
operator|->
name|Ttitle
operator|.
name|right
operator|=
name|hilite
index|[
literal|1
index|]
operator|.
name|self
expr_stmt|;
block|}
end_block

begin_ifdef
ifdef|#
directive|ifdef
name|MODEMENU
end_ifdef

begin_comment
comment|/*  * TMENU_LARGE through TMENU_SMALL must be first, as they must be the same  * as the font size values LARGEFONT through SMALLFONT  */
end_comment

begin_define
define|#
directive|define
name|TMENU_LARGE
value|0
end_define

begin_define
define|#
directive|define
name|TMENU_NUM2
value|(TMENU_LARGE+1)
end_define

begin_define
define|#
directive|define
name|TMENU_NUM3
value|(TMENU_NUM2+1)
end_define

begin_define
define|#
directive|define
name|TMENU_SMALL
value|(TMENU_NUM3+1)
end_define

begin_define
define|#
directive|define
name|TMENU_VTWIN
value|(TMENU_SMALL+1)
end_define

begin_define
define|#
directive|define
name|TMENU_LINE
value|(TMENU_VTWIN+1)
end_define

begin_define
define|#
directive|define
name|TMENU_PAGE
value|(TMENU_LINE+1)
end_define

begin_define
define|#
directive|define
name|TMENU_RESET
value|(TMENU_PAGE+1)
end_define

begin_define
define|#
directive|define
name|TMENU_COPY
value|(TMENU_RESET+1)
end_define

begin_define
define|#
directive|define
name|TMENU_VTMODE
value|(TMENU_COPY+1)
end_define

begin_define
define|#
directive|define
name|TMENU_HIDETEK
value|(TMENU_VTMODE+1)
end_define

begin_decl_stmt
specifier|static
name|char
modifier|*
name|Ttext
index|[]
init|=
block|{
literal|"Large Characters"
block|,
literal|"#2 Size Characters"
block|,
literal|"#3 Size Characters"
block|,
literal|"Small Characters"
block|,
literal|"VT Window Showing"
block|,
literal|"-"
block|,
literal|"PAGE"
block|,
literal|"RESET"
block|,
literal|"COPY"
block|,
literal|"Select VT Mode"
block|,
literal|"Hide Tek Window"
block|,
literal|0
block|, }
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|Tmodes
name|curmodes
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|Tsize
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|vshow
decl_stmt|;
end_decl_stmt

begin_function
name|Menu
modifier|*
name|Tsetupmenu
parameter_list|(
name|menu
parameter_list|)
specifier|register
name|Menu
modifier|*
modifier|*
name|menu
decl_stmt|;
block|{
specifier|register
name|Screen
modifier|*
name|screen
init|=
operator|&
name|term
operator|.
name|screen
decl_stmt|;
specifier|register
name|char
modifier|*
modifier|*
name|cp
decl_stmt|;
specifier|register
name|int
name|size
init|=
name|TActiveIcon
argument_list|(
name|screen
argument_list|)
condition|?
name|ICONFONT
else|:
name|screen
operator|->
name|cur
operator|.
name|fontsize
decl_stmt|;
specifier|register
name|int
name|kflags
init|=
name|term
operator|.
name|keyboard
operator|.
name|flags
decl_stmt|;
name|curmodes
operator|=
name|screen
operator|->
name|cur
expr_stmt|;
if|if
condition|(
operator|*
name|menu
operator|==
name|NULL
condition|)
block|{
if|if
condition|(
operator|(
operator|*
name|menu
operator|=
name|NewMenu
argument_list|(
literal|"Tektronix"
argument_list|,
name|re_verse
argument_list|)
operator|)
operator|==
name|NULL
condition|)
return|return
operator|(
name|NULL
operator|)
return|;
for|for
control|(
name|cp
operator|=
name|Ttext
init|;
operator|*
name|cp
condition|;
name|cp
operator|++
control|)
name|AddMenuItem
argument_list|(
operator|*
name|menu
argument_list|,
operator|*
name|cp
argument_list|)
expr_stmt|;
name|CheckItem
argument_list|(
operator|*
name|menu
argument_list|,
name|size
argument_list|)
expr_stmt|;
if|if
condition|(
name|vshow
operator|=
name|screen
operator|->
name|show
condition|)
name|CheckItem
argument_list|(
operator|*
name|menu
argument_list|,
name|TMENU_VTWIN
argument_list|)
expr_stmt|;
else|else
name|DisableItem
argument_list|(
operator|*
name|menu
argument_list|,
name|TMENU_HIDETEK
argument_list|)
expr_stmt|;
name|DisableItem
argument_list|(
operator|*
name|menu
argument_list|,
name|TMENU_LINE
argument_list|)
expr_stmt|;
name|Tsize
operator|=
name|size
expr_stmt|;
return|return
operator|(
operator|*
name|menu
operator|)
return|;
block|}
if|if
condition|(
name|Tsize
operator|!=
name|size
condition|)
block|{
name|UncheckItem
argument_list|(
operator|*
name|menu
argument_list|,
name|Tsize
argument_list|)
expr_stmt|;
name|CheckItem
argument_list|(
operator|*
name|menu
argument_list|,
name|Tsize
operator|=
name|size
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|vshow
operator|!=
name|screen
operator|->
name|show
condition|)
block|{
name|SetItemCheck
argument_list|(
operator|*
name|menu
argument_list|,
name|TMENU_VTWIN
argument_list|,
operator|(
name|vshow
operator|=
name|screen
operator|->
name|show
operator|)
argument_list|)
expr_stmt|;
name|SetItemDisable
argument_list|(
operator|*
name|menu
argument_list|,
name|TMENU_HIDETEK
argument_list|,
operator|!
name|vshow
argument_list|)
expr_stmt|;
block|}
return|return
operator|(
operator|*
name|menu
operator|)
return|;
block|}
end_function

begin_decl_stmt
specifier|static
name|char
modifier|*
name|changesize
index|[]
init|=
block|{
literal|"\0338"
block|,
literal|"\0339"
block|,
literal|"\033:"
block|,
literal|"\033;"
block|, }
decl_stmt|;
end_decl_stmt

begin_macro
name|Tdomenufunc
argument_list|(
argument|item
argument_list|)
end_macro

begin_decl_stmt
name|int
name|item
decl_stmt|;
end_decl_stmt

begin_block
block|{
specifier|register
name|Screen
modifier|*
name|screen
init|=
operator|&
name|term
operator|.
name|screen
decl_stmt|;
specifier|register
name|char
modifier|*
name|tp
decl_stmt|;
specifier|register
name|char
modifier|*
name|fp
decl_stmt|;
name|Window
name|win
decl_stmt|;
name|int
name|x
decl_stmt|,
name|y
decl_stmt|;
switch|switch
condition|(
name|item
condition|)
block|{
case|case
name|TMENU_LARGE
case|:
case|case
name|TMENU_NUM2
case|:
case|case
name|TMENU_NUM3
case|:
case|case
name|TMENU_SMALL
case|:
if|if
condition|(
operator|!
name|Ttoggled
condition|)
block|{
name|TCursorToggle
argument_list|(
name|TOGGLE
argument_list|)
expr_stmt|;
name|Ttoggled
operator|=
name|TRUE
expr_stmt|;
block|}
if|if
condition|(
name|Tbcnt
operator|<
literal|0
condition|)
name|Tbcnt
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|fp
operator|=
name|changesize
index|[
name|item
index|]
operator|,
name|tp
operator|=
operator|&
name|Tbptr
index|[
name|Tbcnt
index|]
init|;
operator|*
name|fp
condition|;
control|)
block|{
operator|*
name|tp
operator|++
operator|=
operator|*
name|fp
operator|++
expr_stmt|;
name|Tbcnt
operator|++
expr_stmt|;
block|}
break|break;
case|case
name|TMENU_RESET
case|:
name|bzero
argument_list|(
operator|(
name|char
operator|*
operator|)
operator|&
name|curmodes
argument_list|,
sizeof|sizeof
argument_list|(
name|Tmodes
argument_list|)
argument_list|)
expr_stmt|;
comment|/* drop through */
case|case
name|TMENU_PAGE
case|:
name|TekRefresh
operator|=
operator|(
name|TekLink
operator|*
operator|)
literal|0
expr_stmt|;
name|screen
operator|->
name|cur
operator|=
name|curmodes
expr_stmt|;
name|TekPage
argument_list|()
expr_stmt|;
name|screen
operator|->
name|cur_X
operator|=
literal|0
expr_stmt|;
name|screen
operator|->
name|cur_Y
operator|=
name|TEKHOME
expr_stmt|;
break|break;
case|case
name|TMENU_COPY
case|:
name|TekCopy
argument_list|()
expr_stmt|;
break|break;
case|case
name|TMENU_HIDETEK
case|:
name|screen
operator|->
name|Tshow
operator|=
name|FALSE
expr_stmt|;
name|XUnmapWindow
argument_list|(
name|TWindow
argument_list|(
name|screen
argument_list|)
argument_list|)
expr_stmt|;
name|SyncUnmap
argument_list|(
name|TWindow
argument_list|(
name|screen
argument_list|)
argument_list|,
name|TWINDOWEVENTS
argument_list|)
expr_stmt|;
name|reselectwindow
argument_list|(
name|screen
argument_list|)
expr_stmt|;
name|TekRefresh
operator|=
operator|(
name|TekLink
operator|*
operator|)
literal|0
expr_stmt|;
comment|/* drop through */
case|case
name|TMENU_VTMODE
case|:
if|if
condition|(
name|TekRefresh
condition|)
name|dorefresh
argument_list|()
expr_stmt|;
if|if
condition|(
name|screen
operator|->
name|TekEmu
condition|)
block|{
if|if
condition|(
name|screen
operator|->
name|logging
condition|)
block|{
name|FlushLog
argument_list|(
name|screen
argument_list|)
expr_stmt|;
name|screen
operator|->
name|logstart
operator|=
name|buffer
expr_stmt|;
block|}
name|longjmp
argument_list|(
name|Tekend
argument_list|,
literal|1
argument_list|)
expr_stmt|;
block|}
else|else
name|XRaiseWindow
argument_list|(
name|VWindow
argument_list|(
name|screen
argument_list|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|TMENU_VTWIN
case|:
if|if
condition|(
name|screen
operator|->
name|show
operator|=
operator|!
name|screen
operator|->
name|show
condition|)
block|{
if|if
condition|(
name|VWindow
argument_list|(
name|screen
argument_list|)
operator|||
name|VTInit
argument_list|()
condition|)
block|{
name|XMapWindow
argument_list|(
name|VWindow
argument_list|(
name|screen
argument_list|)
argument_list|)
expr_stmt|;
name|screen
operator|->
name|show
operator|=
name|TRUE
expr_stmt|;
block|}
block|}
else|else
block|{
name|screen
operator|->
name|show
operator|=
name|FALSE
expr_stmt|;
name|XUnmapWindow
argument_list|(
name|VWindow
argument_list|(
name|screen
argument_list|)
argument_list|)
expr_stmt|;
name|SyncUnmap
argument_list|(
name|VWindow
argument_list|(
name|screen
argument_list|)
argument_list|,
name|WINDOWEVENTS
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|screen
operator|->
name|TekEmu
condition|)
block|{
if|if
condition|(
name|TekRefresh
condition|)
name|dorefresh
argument_list|()
expr_stmt|;
if|if
condition|(
name|screen
operator|->
name|logging
condition|)
block|{
name|FlushLog
argument_list|(
name|screen
argument_list|)
expr_stmt|;
name|screen
operator|->
name|logstart
operator|=
name|Tbuffer
expr_stmt|;
block|}
name|screen
operator|->
name|TekEmu
operator|=
name|TRUE
expr_stmt|;
name|longjmp
argument_list|(
name|VTend
argument_list|,
literal|1
argument_list|)
expr_stmt|;
block|}
block|}
name|reselectwindow
argument_list|(
name|screen
argument_list|)
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|TekRefresh
condition|)
name|dorefresh
argument_list|()
expr_stmt|;
block|}
end_block

begin_endif
endif|#
directive|endif
endif|MODEMENU
end_endif

begin_macro
name|TSetIconSize
argument_list|(
argument|screen
argument_list|)
end_macro

begin_decl_stmt
name|Screen
modifier|*
name|screen
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|double
name|d
decl_stmt|;
if|if
condition|(
name|screen
operator|->
name|active_icon
condition|)
block|{
name|screen
operator|->
name|iconTwin
operator|.
name|width
operator|=
name|TWidth
argument_list|(
name|screen
argument_list|)
operator|*
name|Tfontsize
index|[
name|ICONFONT
index|]
operator|.
name|Twidth
operator|/
name|Tfontsize
index|[
name|THREEFONT
index|]
operator|.
name|Twidth
expr_stmt|;
name|screen
operator|->
name|iconTwin
operator|.
name|height
operator|=
name|THeight
argument_list|(
name|screen
argument_list|)
operator|*
name|Tfontsize
index|[
name|ICONFONT
index|]
operator|.
name|Theight
operator|/
name|Tfontsize
index|[
name|THREEFONT
index|]
operator|.
name|Theight
expr_stmt|;
name|XChangeWindow
argument_list|(
name|screen
operator|->
name|iconTwin
operator|.
name|window
argument_list|,
name|screen
operator|->
name|iconTwin
operator|.
name|width
argument_list|,
name|screen
operator|->
name|iconTwin
operator|.
name|height
argument_list|)
expr_stmt|;
block|}
else|else
name|IconRecalc
argument_list|(
name|screen
argument_list|)
expr_stmt|;
name|screen
operator|->
name|iconTwin
operator|.
name|fullwidth
operator|=
name|screen
operator|->
name|iconTwin
operator|.
name|width
expr_stmt|;
name|screen
operator|->
name|iconTwin
operator|.
name|fullheight
operator|=
name|screen
operator|->
name|iconTwin
operator|.
name|height
expr_stmt|;
name|screen
operator|->
name|iconTwin
operator|.
name|tekscale
operator|=
operator|(
name|double
operator|)
name|screen
operator|->
name|iconTwin
operator|.
name|width
operator|/
operator|(
name|TEKWIDTH
operator|+
name|TEKPAD
operator|)
expr_stmt|;
if|if
condition|(
operator|(
name|d
operator|=
operator|(
name|double
operator|)
name|screen
operator|->
name|iconTwin
operator|.
name|height
operator|/
operator|(
name|TEKHEIGHT
operator|+
name|TEKTOPPAD
operator|+
name|TEKBOTTOMPAD
operator|)
operator|)
operator|<
name|screen
operator|->
name|iconTwin
operator|.
name|tekscale
condition|)
name|screen
operator|->
name|iconTwin
operator|.
name|tekscale
operator|=
name|d
expr_stmt|;
block|}
end_block

end_unit


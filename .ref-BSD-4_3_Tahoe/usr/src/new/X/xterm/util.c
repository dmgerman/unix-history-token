begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  *	$Source: /u1/X/xterm/RCS/util.c,v $  *	$Header: util.c,v 10.100 86/12/01 14:45:43 jg Rel $  */
end_comment

begin_include
include|#
directive|include
file|<X/mit-copyright.h>
end_include

begin_comment
comment|/* Copyright    Massachusetts Institute of Technology    1984, 1985	*/
end_comment

begin_comment
comment|/* util.c */
end_comment

begin_ifndef
ifndef|#
directive|ifndef
name|lint
end_ifndef

begin_decl_stmt
specifier|static
name|char
name|sccs_id
index|[]
init|=
literal|"@(#)util.c\tX10/6.6B\t12/26/86"
decl_stmt|;
end_decl_stmt

begin_endif
endif|#
directive|endif
endif|lint
end_endif

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_include
include|#
directive|include
file|<X/Xlib.h>
end_include

begin_include
include|#
directive|include
file|<signal.h>
end_include

begin_include
include|#
directive|include
file|<setjmp.h>
end_include

begin_typedef
typedef|typedef
name|int
modifier|*
name|jmp_ptr
typedef|;
end_typedef

begin_include
include|#
directive|include
file|"scrollbar.h"
end_include

begin_include
include|#
directive|include
file|"ptyx.h"
end_include

begin_include
include|#
directive|include
file|"data.h"
end_include

begin_include
include|#
directive|include
file|"error.h"
end_include

begin_comment
comment|/*  * These routines are used for the jump scroll feature  */
end_comment

begin_expr_stmt
name|FlushScroll
argument_list|(
name|screen
argument_list|)
specifier|register
name|Screen
operator|*
name|screen
expr_stmt|;
end_expr_stmt

begin_block
block|{
specifier|register
name|int
name|i
decl_stmt|;
specifier|register
name|int
name|shift
init|=
operator|-
name|screen
operator|->
name|topline
decl_stmt|;
specifier|register
name|int
name|bot
init|=
name|screen
operator|->
name|max_row
operator|-
name|shift
decl_stmt|;
specifier|register
name|int
name|refreshtop
decl_stmt|;
specifier|register
name|int
name|refreshheight
decl_stmt|;
specifier|register
name|int
name|scrolltop
decl_stmt|;
specifier|register
name|int
name|scrollheight
decl_stmt|;
if|if
condition|(
name|screen
operator|->
name|cursor_state
condition|)
name|HideCursor
argument_list|()
expr_stmt|;
if|if
condition|(
name|screen
operator|->
name|scroll_amt
operator|>
literal|0
condition|)
block|{
name|refreshheight
operator|=
name|screen
operator|->
name|refresh_amt
expr_stmt|;
name|scrollheight
operator|=
name|screen
operator|->
name|bot_marg
operator|-
name|screen
operator|->
name|top_marg
operator|-
name|refreshheight
operator|+
literal|1
expr_stmt|;
if|if
condition|(
operator|(
name|refreshtop
operator|=
name|screen
operator|->
name|bot_marg
operator|-
name|refreshheight
operator|+
literal|1
operator|+
name|shift
operator|)
operator|>
operator|(
name|i
operator|=
name|screen
operator|->
name|max_row
operator|-
name|screen
operator|->
name|scroll_amt
operator|+
literal|1
operator|)
condition|)
name|refreshtop
operator|=
name|i
expr_stmt|;
if|if
condition|(
name|screen
operator|->
name|sb
operator|&&
name|GetSaveState
argument_list|(
name|screen
operator|->
name|sb
argument_list|)
operator|&&
name|screen
operator|->
name|top_marg
operator|==
literal|0
condition|)
block|{
name|scrolltop
operator|=
literal|0
expr_stmt|;
if|if
condition|(
operator|(
name|scrollheight
operator|+=
name|shift
operator|)
operator|>
name|i
condition|)
name|scrollheight
operator|=
name|i
expr_stmt|;
if|if
condition|(
operator|(
name|i
operator|=
name|screen
operator|->
name|bot_marg
operator|-
name|bot
operator|)
operator|>
literal|0
operator|&&
operator|(
name|refreshheight
operator|-=
name|i
operator|)
operator|<
name|screen
operator|->
name|scroll_amt
condition|)
name|refreshheight
operator|=
name|screen
operator|->
name|scroll_amt
expr_stmt|;
if|if
condition|(
operator|(
name|i
operator|=
operator|-
name|GetScrollBarTop
argument_list|(
name|screen
operator|->
name|sb
argument_list|)
operator|)
operator|<
name|screen
operator|->
name|savelines
condition|)
block|{
if|if
condition|(
operator|(
name|i
operator|+=
name|screen
operator|->
name|scroll_amt
operator|)
operator|>
name|screen
operator|->
name|savelines
condition|)
name|i
operator|=
name|screen
operator|->
name|savelines
expr_stmt|;
name|SetScrollBarTop
argument_list|(
name|screen
operator|->
name|sb
argument_list|,
operator|-
name|i
argument_list|)
expr_stmt|;
name|DrawScrollRegion
argument_list|(
name|screen
operator|->
name|sb
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
name|scrolltop
operator|=
name|screen
operator|->
name|top_marg
operator|+
name|shift
expr_stmt|;
if|if
condition|(
operator|(
name|i
operator|=
name|bot
operator|-
operator|(
name|screen
operator|->
name|bot_marg
operator|-
name|screen
operator|->
name|refresh_amt
operator|+
name|screen
operator|->
name|scroll_amt
operator|)
operator|)
operator|>
literal|0
condition|)
block|{
if|if
condition|(
name|bot
operator|<
name|screen
operator|->
name|bot_marg
condition|)
name|refreshheight
operator|=
name|screen
operator|->
name|scroll_amt
operator|+
name|i
expr_stmt|;
block|}
else|else
block|{
name|scrollheight
operator|+=
name|i
expr_stmt|;
name|refreshheight
operator|=
name|screen
operator|->
name|scroll_amt
expr_stmt|;
if|if
condition|(
operator|(
name|i
operator|=
name|screen
operator|->
name|top_marg
operator|+
name|screen
operator|->
name|scroll_amt
operator|-
literal|1
operator|-
name|bot
operator|)
operator|>
literal|0
condition|)
block|{
name|refreshtop
operator|+=
name|i
expr_stmt|;
name|refreshheight
operator|-=
name|i
expr_stmt|;
block|}
block|}
block|}
block|}
else|else
block|{
name|refreshheight
operator|=
operator|-
name|screen
operator|->
name|refresh_amt
expr_stmt|;
name|scrollheight
operator|=
name|screen
operator|->
name|bot_marg
operator|-
name|screen
operator|->
name|top_marg
operator|-
name|refreshheight
operator|+
literal|1
expr_stmt|;
name|refreshtop
operator|=
name|screen
operator|->
name|top_marg
operator|+
name|shift
expr_stmt|;
name|scrolltop
operator|=
name|refreshtop
operator|+
name|refreshheight
expr_stmt|;
if|if
condition|(
operator|(
name|i
operator|=
name|screen
operator|->
name|bot_marg
operator|-
name|bot
operator|)
operator|>
literal|0
condition|)
name|scrollheight
operator|-=
name|i
expr_stmt|;
if|if
condition|(
operator|(
name|i
operator|=
name|screen
operator|->
name|top_marg
operator|+
name|refreshheight
operator|-
literal|1
operator|-
name|bot
operator|)
operator|>
literal|0
condition|)
name|refreshheight
operator|-=
name|i
expr_stmt|;
block|}
if|if
condition|(
name|scrollheight
operator|>
literal|0
condition|)
block|{
if|if
condition|(
name|screen
operator|->
name|multiscroll
operator|&&
name|scrollheight
operator|==
literal|1
operator|&&
name|screen
operator|->
name|topline
operator|==
literal|0
operator|&&
name|screen
operator|->
name|top_marg
operator|==
literal|0
operator|&&
name|screen
operator|->
name|bot_marg
operator|==
name|screen
operator|->
name|max_row
condition|)
block|{
if|if
condition|(
name|screen
operator|->
name|incopy
operator|<
literal|0
operator|&&
name|screen
operator|->
name|scrolls
operator|==
literal|0
condition|)
name|CopyWait
argument_list|(
name|screen
argument_list|)
expr_stmt|;
name|screen
operator|->
name|scrolls
operator|++
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|screen
operator|->
name|incopy
condition|)
name|CopyWait
argument_list|(
name|screen
argument_list|)
expr_stmt|;
name|screen
operator|->
name|incopy
operator|=
operator|-
literal|1
expr_stmt|;
block|}
name|XMoveArea
argument_list|(
name|VWindow
argument_list|(
name|screen
argument_list|)
argument_list|,
name|screen
operator|->
name|border
argument_list|,
operator|(
name|scrolltop
operator|+
name|screen
operator|->
name|scroll_amt
operator|)
operator|*
name|FontHeight
argument_list|(
name|screen
argument_list|)
operator|+
name|screen
operator|->
name|border
operator|+
name|Titlebar
argument_list|(
name|screen
argument_list|)
argument_list|,
name|screen
operator|->
name|border
argument_list|,
name|scrolltop
operator|*
name|FontHeight
argument_list|(
name|screen
argument_list|)
operator|+
name|screen
operator|->
name|border
operator|+
name|Titlebar
argument_list|(
name|screen
argument_list|)
argument_list|,
name|Width
argument_list|(
name|screen
argument_list|)
argument_list|,
name|scrollheight
operator|*
name|FontHeight
argument_list|(
name|screen
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|screen
operator|->
name|scroll_amt
operator|=
literal|0
expr_stmt|;
name|screen
operator|->
name|refresh_amt
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|refreshheight
operator|>
literal|0
condition|)
block|{
name|XTileSet
argument_list|(
name|VWindow
argument_list|(
name|screen
argument_list|)
argument_list|,
name|screen
operator|->
name|border
argument_list|,
name|refreshtop
operator|*
name|FontHeight
argument_list|(
name|screen
argument_list|)
operator|+
name|screen
operator|->
name|border
operator|+
name|Titlebar
argument_list|(
name|screen
argument_list|)
argument_list|,
name|Width
argument_list|(
name|screen
argument_list|)
argument_list|,
name|refreshheight
operator|*
name|FontHeight
argument_list|(
name|screen
argument_list|)
argument_list|,
name|screen
operator|->
name|bgndtile
argument_list|)
expr_stmt|;
name|ScrnRefresh
argument_list|(
name|screen
argument_list|,
name|refreshtop
argument_list|,
literal|0
argument_list|,
name|refreshheight
argument_list|,
name|screen
operator|->
name|max_col
operator|+
literal|1
argument_list|)
expr_stmt|;
block|}
block|}
end_block

begin_expr_stmt
name|AddToRefresh
argument_list|(
name|screen
argument_list|)
specifier|register
name|Screen
operator|*
name|screen
expr_stmt|;
end_expr_stmt

begin_block
block|{
specifier|register
name|int
name|amount
init|=
name|screen
operator|->
name|refresh_amt
decl_stmt|;
specifier|register
name|int
name|row
init|=
name|screen
operator|->
name|cur_row
decl_stmt|;
if|if
condition|(
name|amount
operator|==
literal|0
operator|||
name|screen
operator|->
name|instatus
condition|)
return|return
operator|(
literal|0
operator|)
return|;
if|if
condition|(
name|amount
operator|>
literal|0
condition|)
block|{
specifier|register
name|int
name|bottom
decl_stmt|;
if|if
condition|(
name|row
operator|==
operator|(
name|bottom
operator|=
name|screen
operator|->
name|bot_marg
operator|)
operator|-
name|amount
condition|)
block|{
name|screen
operator|->
name|refresh_amt
operator|++
expr_stmt|;
return|return
operator|(
literal|1
operator|)
return|;
block|}
return|return
operator|(
name|row
operator|>=
name|bottom
operator|-
name|amount
operator|+
literal|1
operator|&&
name|row
operator|<=
name|bottom
operator|)
return|;
block|}
else|else
block|{
specifier|register
name|int
name|top
decl_stmt|;
name|amount
operator|=
operator|-
name|amount
expr_stmt|;
if|if
condition|(
name|row
operator|==
operator|(
name|top
operator|=
name|screen
operator|->
name|top_marg
operator|)
operator|+
name|amount
condition|)
block|{
name|screen
operator|->
name|refresh_amt
operator|--
expr_stmt|;
return|return
operator|(
literal|1
operator|)
return|;
block|}
return|return
operator|(
name|row
operator|<=
name|top
operator|+
name|amount
operator|-
literal|1
operator|&&
name|row
operator|>=
name|top
operator|)
return|;
block|}
block|}
end_block

begin_comment
comment|/*   * scrolls the screen by amount lines, erases bottom, doesn't alter   * cursor position (i.e. cursor moves down amount relative to text).  * All done within the scrolling region, of course.   * requires: amount> 0  */
end_comment

begin_expr_stmt
name|Scroll
argument_list|(
name|screen
argument_list|,
name|amount
argument_list|)
specifier|register
name|Screen
operator|*
name|screen
expr_stmt|;
end_expr_stmt

begin_decl_stmt
specifier|register
name|int
name|amount
decl_stmt|;
end_decl_stmt

begin_block
block|{
specifier|register
name|int
name|i
init|=
name|screen
operator|->
name|bot_marg
operator|-
name|screen
operator|->
name|top_marg
operator|+
literal|1
decl_stmt|;
specifier|register
name|int
name|shift
decl_stmt|;
specifier|register
name|int
name|bot
decl_stmt|;
specifier|register
name|int
name|refreshtop
decl_stmt|;
specifier|register
name|int
name|refreshheight
decl_stmt|;
specifier|register
name|int
name|scrolltop
decl_stmt|;
specifier|register
name|int
name|scrollheight
decl_stmt|;
if|if
condition|(
name|screen
operator|->
name|cursor_state
condition|)
name|HideCursor
argument_list|()
expr_stmt|;
if|if
condition|(
name|amount
operator|>
name|i
condition|)
name|amount
operator|=
name|i
expr_stmt|;
if|if
condition|(
name|screen
operator|->
name|jumpscroll
condition|)
block|{
if|if
condition|(
name|screen
operator|->
name|scroll_amt
operator|>
literal|0
condition|)
block|{
if|if
condition|(
name|screen
operator|->
name|refresh_amt
operator|+
name|amount
operator|>
name|i
condition|)
name|FlushScroll
argument_list|(
name|screen
argument_list|)
expr_stmt|;
name|screen
operator|->
name|scroll_amt
operator|+=
name|amount
expr_stmt|;
name|screen
operator|->
name|refresh_amt
operator|+=
name|amount
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|screen
operator|->
name|scroll_amt
operator|<
literal|0
condition|)
name|FlushScroll
argument_list|(
name|screen
argument_list|)
expr_stmt|;
name|screen
operator|->
name|scroll_amt
operator|=
name|amount
expr_stmt|;
name|screen
operator|->
name|refresh_amt
operator|=
name|amount
expr_stmt|;
block|}
name|refreshheight
operator|=
literal|0
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|amount
operator|==
name|i
condition|)
block|{
name|ClearScreen
argument_list|(
name|screen
argument_list|)
expr_stmt|;
return|return;
block|}
name|shift
operator|=
operator|-
name|screen
operator|->
name|topline
expr_stmt|;
name|bot
operator|=
name|screen
operator|->
name|max_row
operator|-
name|shift
expr_stmt|;
name|scrollheight
operator|=
name|i
operator|-
name|amount
expr_stmt|;
name|refreshheight
operator|=
name|amount
expr_stmt|;
if|if
condition|(
operator|(
name|refreshtop
operator|=
name|screen
operator|->
name|bot_marg
operator|-
name|refreshheight
operator|+
literal|1
operator|+
name|shift
operator|)
operator|>
operator|(
name|i
operator|=
name|screen
operator|->
name|max_row
operator|-
name|refreshheight
operator|+
literal|1
operator|)
condition|)
name|refreshtop
operator|=
name|i
expr_stmt|;
if|if
condition|(
name|screen
operator|->
name|sb
operator|&&
name|GetSaveState
argument_list|(
name|screen
operator|->
name|sb
argument_list|)
operator|&&
name|screen
operator|->
name|top_marg
operator|==
literal|0
condition|)
block|{
name|scrolltop
operator|=
literal|0
expr_stmt|;
if|if
condition|(
operator|(
name|scrollheight
operator|+=
name|shift
operator|)
operator|>
name|i
condition|)
name|scrollheight
operator|=
name|i
expr_stmt|;
if|if
condition|(
operator|(
name|i
operator|=
operator|-
name|GetScrollBarTop
argument_list|(
name|screen
operator|->
name|sb
argument_list|)
operator|)
operator|<
name|screen
operator|->
name|savelines
condition|)
block|{
if|if
condition|(
operator|(
name|i
operator|+=
name|amount
operator|)
operator|>
name|screen
operator|->
name|savelines
condition|)
name|i
operator|=
name|screen
operator|->
name|savelines
expr_stmt|;
name|SetScrollBarTop
argument_list|(
name|screen
operator|->
name|sb
argument_list|,
operator|-
name|i
argument_list|)
expr_stmt|;
name|DrawScrollRegion
argument_list|(
name|screen
operator|->
name|sb
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
name|scrolltop
operator|=
name|screen
operator|->
name|top_marg
operator|+
name|shift
expr_stmt|;
if|if
condition|(
operator|(
name|i
operator|=
name|screen
operator|->
name|bot_marg
operator|-
name|bot
operator|)
operator|>
literal|0
condition|)
block|{
name|scrollheight
operator|-=
name|i
expr_stmt|;
if|if
condition|(
operator|(
name|i
operator|=
name|screen
operator|->
name|top_marg
operator|+
name|amount
operator|-
literal|1
operator|-
name|bot
operator|)
operator|>=
literal|0
condition|)
block|{
name|refreshtop
operator|+=
name|i
expr_stmt|;
name|refreshheight
operator|-=
name|i
expr_stmt|;
block|}
block|}
block|}
if|if
condition|(
name|scrollheight
operator|>
literal|0
condition|)
block|{
if|if
condition|(
name|screen
operator|->
name|multiscroll
operator|&&
name|amount
operator|==
literal|1
operator|&&
name|screen
operator|->
name|topline
operator|==
literal|0
operator|&&
name|screen
operator|->
name|top_marg
operator|==
literal|0
operator|&&
name|screen
operator|->
name|bot_marg
operator|==
name|screen
operator|->
name|max_row
condition|)
block|{
if|if
condition|(
name|screen
operator|->
name|incopy
operator|<
literal|0
operator|&&
name|screen
operator|->
name|scrolls
operator|==
literal|0
condition|)
name|CopyWait
argument_list|(
name|screen
argument_list|)
expr_stmt|;
name|screen
operator|->
name|scrolls
operator|++
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|screen
operator|->
name|incopy
condition|)
name|CopyWait
argument_list|(
name|screen
argument_list|)
expr_stmt|;
name|screen
operator|->
name|incopy
operator|=
operator|-
literal|1
expr_stmt|;
block|}
name|XMoveArea
argument_list|(
name|VWindow
argument_list|(
name|screen
argument_list|)
argument_list|,
name|screen
operator|->
name|border
argument_list|,
operator|(
name|scrolltop
operator|+
name|amount
operator|)
operator|*
name|FontHeight
argument_list|(
name|screen
argument_list|)
operator|+
name|screen
operator|->
name|border
operator|+
name|Titlebar
argument_list|(
name|screen
argument_list|)
argument_list|,
name|screen
operator|->
name|border
argument_list|,
name|scrolltop
operator|*
name|FontHeight
argument_list|(
name|screen
argument_list|)
operator|+
name|screen
operator|->
name|border
operator|+
name|Titlebar
argument_list|(
name|screen
argument_list|)
argument_list|,
name|Width
argument_list|(
name|screen
argument_list|)
argument_list|,
name|scrollheight
operator|*
name|FontHeight
argument_list|(
name|screen
argument_list|)
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|refreshheight
operator|>
literal|0
condition|)
block|{
name|XTileSet
argument_list|(
name|VWindow
argument_list|(
name|screen
argument_list|)
argument_list|,
name|screen
operator|->
name|border
argument_list|,
name|refreshtop
operator|*
name|FontHeight
argument_list|(
name|screen
argument_list|)
operator|+
name|screen
operator|->
name|border
operator|+
name|Titlebar
argument_list|(
name|screen
argument_list|)
argument_list|,
name|Width
argument_list|(
name|screen
argument_list|)
argument_list|,
name|refreshheight
operator|*
name|FontHeight
argument_list|(
name|screen
argument_list|)
argument_list|,
name|screen
operator|->
name|bgndtile
argument_list|)
expr_stmt|;
if|if
condition|(
name|refreshheight
operator|>
name|shift
condition|)
name|refreshheight
operator|=
name|shift
expr_stmt|;
block|}
block|}
if|if
condition|(
name|screen
operator|->
name|sb
operator|&&
name|GetSaveState
argument_list|(
name|screen
operator|->
name|sb
argument_list|)
operator|&&
name|screen
operator|->
name|top_marg
operator|==
literal|0
condition|)
name|ScrnDeleteLine
argument_list|(
name|screen
operator|->
name|allbuf
argument_list|,
name|screen
operator|->
name|bot_marg
operator|+
name|screen
operator|->
name|savelines
argument_list|,
literal|0
argument_list|,
name|amount
argument_list|,
name|screen
operator|->
name|max_col
operator|+
literal|1
argument_list|)
expr_stmt|;
else|else
name|ScrnDeleteLine
argument_list|(
name|screen
operator|->
name|buf
argument_list|,
name|screen
operator|->
name|bot_marg
argument_list|,
name|screen
operator|->
name|top_marg
argument_list|,
name|amount
argument_list|,
name|screen
operator|->
name|max_col
operator|+
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|refreshheight
operator|>
literal|0
condition|)
name|ScrnRefresh
argument_list|(
name|screen
argument_list|,
name|refreshtop
argument_list|,
literal|0
argument_list|,
name|refreshheight
argument_list|,
name|screen
operator|->
name|max_col
operator|+
literal|1
argument_list|)
expr_stmt|;
block|}
end_block

begin_comment
comment|/*  * Reverse scrolls the screen by amount lines, erases top, doesn't alter  * cursor position (i.e. cursor moves up amount relative to text).  * All done within the scrolling region, of course.  * Requires: amount> 0  */
end_comment

begin_expr_stmt
name|RevScroll
argument_list|(
name|screen
argument_list|,
name|amount
argument_list|)
specifier|register
name|Screen
operator|*
name|screen
expr_stmt|;
end_expr_stmt

begin_decl_stmt
specifier|register
name|int
name|amount
decl_stmt|;
end_decl_stmt

begin_block
block|{
specifier|register
name|int
name|i
init|=
name|screen
operator|->
name|bot_marg
operator|-
name|screen
operator|->
name|top_marg
operator|+
literal|1
decl_stmt|;
specifier|register
name|int
name|shift
decl_stmt|;
specifier|register
name|int
name|bot
decl_stmt|;
specifier|register
name|int
name|refreshtop
decl_stmt|;
specifier|register
name|int
name|refreshheight
decl_stmt|;
specifier|register
name|int
name|scrolltop
decl_stmt|;
specifier|register
name|int
name|scrollheight
decl_stmt|;
if|if
condition|(
name|screen
operator|->
name|cursor_state
condition|)
name|HideCursor
argument_list|()
expr_stmt|;
if|if
condition|(
name|amount
operator|>
name|i
condition|)
name|amount
operator|=
name|i
expr_stmt|;
if|if
condition|(
name|screen
operator|->
name|jumpscroll
condition|)
block|{
if|if
condition|(
name|screen
operator|->
name|scroll_amt
operator|<
literal|0
condition|)
block|{
if|if
condition|(
operator|-
name|screen
operator|->
name|refresh_amt
operator|+
name|amount
operator|>
name|i
condition|)
name|FlushScroll
argument_list|(
name|screen
argument_list|)
expr_stmt|;
name|screen
operator|->
name|scroll_amt
operator|-=
name|amount
expr_stmt|;
name|screen
operator|->
name|refresh_amt
operator|-=
name|amount
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|screen
operator|->
name|scroll_amt
operator|>
literal|0
condition|)
name|FlushScroll
argument_list|(
name|screen
argument_list|)
expr_stmt|;
name|screen
operator|->
name|scroll_amt
operator|=
operator|-
name|amount
expr_stmt|;
name|screen
operator|->
name|refresh_amt
operator|=
operator|-
name|amount
expr_stmt|;
block|}
block|}
else|else
block|{
name|shift
operator|=
operator|-
name|screen
operator|->
name|topline
expr_stmt|;
name|bot
operator|=
name|screen
operator|->
name|max_row
operator|-
name|shift
expr_stmt|;
name|refreshheight
operator|=
name|amount
expr_stmt|;
name|scrollheight
operator|=
name|screen
operator|->
name|bot_marg
operator|-
name|screen
operator|->
name|top_marg
operator|-
name|refreshheight
operator|+
literal|1
expr_stmt|;
name|refreshtop
operator|=
name|screen
operator|->
name|top_marg
operator|+
name|shift
expr_stmt|;
name|scrolltop
operator|=
name|refreshtop
operator|+
name|refreshheight
expr_stmt|;
if|if
condition|(
operator|(
name|i
operator|=
name|screen
operator|->
name|bot_marg
operator|-
name|bot
operator|)
operator|>
literal|0
condition|)
name|scrollheight
operator|-=
name|i
expr_stmt|;
if|if
condition|(
operator|(
name|i
operator|=
name|screen
operator|->
name|top_marg
operator|+
name|refreshheight
operator|-
literal|1
operator|-
name|bot
operator|)
operator|>
literal|0
condition|)
name|refreshheight
operator|-=
name|i
expr_stmt|;
if|if
condition|(
name|scrollheight
operator|>
literal|0
condition|)
block|{
if|if
condition|(
name|screen
operator|->
name|multiscroll
operator|&&
name|amount
operator|==
literal|1
operator|&&
name|screen
operator|->
name|topline
operator|==
literal|0
operator|&&
name|screen
operator|->
name|top_marg
operator|==
literal|0
operator|&&
name|screen
operator|->
name|bot_marg
operator|==
name|screen
operator|->
name|max_row
condition|)
block|{
if|if
condition|(
name|screen
operator|->
name|incopy
operator|<
literal|0
operator|&&
name|screen
operator|->
name|scrolls
operator|==
literal|0
condition|)
name|CopyWait
argument_list|(
name|screen
argument_list|)
expr_stmt|;
name|screen
operator|->
name|scrolls
operator|++
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|screen
operator|->
name|incopy
condition|)
name|CopyWait
argument_list|(
name|screen
argument_list|)
expr_stmt|;
name|screen
operator|->
name|incopy
operator|=
operator|-
literal|1
expr_stmt|;
block|}
name|XMoveArea
argument_list|(
name|VWindow
argument_list|(
name|screen
argument_list|)
argument_list|,
name|screen
operator|->
name|border
argument_list|,
operator|(
name|scrolltop
operator|-
name|amount
operator|)
operator|*
name|FontHeight
argument_list|(
name|screen
argument_list|)
operator|+
name|screen
operator|->
name|border
operator|+
name|Titlebar
argument_list|(
name|screen
argument_list|)
argument_list|,
name|screen
operator|->
name|border
argument_list|,
name|scrolltop
operator|*
name|FontHeight
argument_list|(
name|screen
argument_list|)
operator|+
name|screen
operator|->
name|border
operator|+
name|Titlebar
argument_list|(
name|screen
argument_list|)
argument_list|,
name|Width
argument_list|(
name|screen
argument_list|)
argument_list|,
name|scrollheight
operator|*
name|FontHeight
argument_list|(
name|screen
argument_list|)
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|refreshheight
operator|>
literal|0
condition|)
name|XTileSet
argument_list|(
name|VWindow
argument_list|(
name|screen
argument_list|)
argument_list|,
name|screen
operator|->
name|border
argument_list|,
name|refreshtop
operator|*
name|FontHeight
argument_list|(
name|screen
argument_list|)
operator|+
name|screen
operator|->
name|border
operator|+
name|Titlebar
argument_list|(
name|screen
argument_list|)
argument_list|,
name|Width
argument_list|(
name|screen
argument_list|)
argument_list|,
name|refreshheight
operator|*
name|FontHeight
argument_list|(
name|screen
argument_list|)
argument_list|,
name|screen
operator|->
name|bgndtile
argument_list|)
expr_stmt|;
block|}
name|ScrnInsertLine
argument_list|(
name|screen
operator|->
name|buf
argument_list|,
name|screen
operator|->
name|bot_marg
argument_list|,
name|screen
operator|->
name|top_marg
argument_list|,
name|amount
argument_list|,
name|screen
operator|->
name|max_col
operator|+
literal|1
argument_list|)
expr_stmt|;
block|}
end_block

begin_comment
comment|/*  * If cursor not in scrolling region, returns.  Else,  * inserts n blank lines at the cursor's position.  Lines above the  * bottom margin are lost.  */
end_comment

begin_expr_stmt
name|InsertLine
argument_list|(
name|screen
argument_list|,
name|n
argument_list|)
specifier|register
name|Screen
operator|*
name|screen
expr_stmt|;
end_expr_stmt

begin_decl_stmt
specifier|register
name|int
name|n
decl_stmt|;
end_decl_stmt

begin_block
block|{
specifier|register
name|int
name|i
decl_stmt|;
specifier|register
name|int
name|shift
decl_stmt|;
specifier|register
name|int
name|bot
decl_stmt|;
specifier|register
name|int
name|refreshtop
decl_stmt|;
specifier|register
name|int
name|refreshheight
decl_stmt|;
specifier|register
name|int
name|scrolltop
decl_stmt|;
specifier|register
name|int
name|scrollheight
decl_stmt|;
if|if
condition|(
name|screen
operator|->
name|cur_row
operator|<
name|screen
operator|->
name|top_marg
operator|||
name|screen
operator|->
name|cur_row
operator|>
name|screen
operator|->
name|bot_marg
condition|)
return|return;
if|if
condition|(
name|screen
operator|->
name|cursor_state
condition|)
name|HideCursor
argument_list|()
expr_stmt|;
name|screen
operator|->
name|do_wrap
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|n
operator|>
operator|(
name|i
operator|=
name|screen
operator|->
name|bot_marg
operator|-
name|screen
operator|->
name|cur_row
operator|+
literal|1
operator|)
condition|)
name|n
operator|=
name|i
expr_stmt|;
if|if
condition|(
name|screen
operator|->
name|jumpscroll
condition|)
block|{
if|if
condition|(
name|screen
operator|->
name|scroll_amt
operator|<=
literal|0
operator|&&
name|screen
operator|->
name|cur_row
operator|<=
operator|-
name|screen
operator|->
name|refresh_amt
condition|)
block|{
if|if
condition|(
operator|-
name|screen
operator|->
name|refresh_amt
operator|+
name|n
operator|>
name|screen
operator|->
name|max_row
operator|+
literal|1
condition|)
name|FlushScroll
argument_list|(
name|screen
argument_list|)
expr_stmt|;
name|screen
operator|->
name|scroll_amt
operator|-=
name|n
expr_stmt|;
name|screen
operator|->
name|refresh_amt
operator|-=
name|n
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|screen
operator|->
name|scroll_amt
condition|)
name|FlushScroll
argument_list|(
name|screen
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|screen
operator|->
name|scroll_amt
condition|)
block|{
name|shift
operator|=
operator|-
name|screen
operator|->
name|topline
expr_stmt|;
name|bot
operator|=
name|screen
operator|->
name|max_row
operator|-
name|shift
expr_stmt|;
name|refreshheight
operator|=
name|n
expr_stmt|;
name|scrollheight
operator|=
name|screen
operator|->
name|bot_marg
operator|-
name|screen
operator|->
name|cur_row
operator|-
name|refreshheight
operator|+
literal|1
expr_stmt|;
name|refreshtop
operator|=
name|screen
operator|->
name|cur_row
operator|+
name|shift
expr_stmt|;
name|scrolltop
operator|=
name|refreshtop
operator|+
name|refreshheight
expr_stmt|;
if|if
condition|(
operator|(
name|i
operator|=
name|screen
operator|->
name|bot_marg
operator|-
name|bot
operator|)
operator|>
literal|0
condition|)
name|scrollheight
operator|-=
name|i
expr_stmt|;
if|if
condition|(
operator|(
name|i
operator|=
name|screen
operator|->
name|cur_row
operator|+
name|refreshheight
operator|-
literal|1
operator|-
name|bot
operator|)
operator|>
literal|0
condition|)
name|refreshheight
operator|-=
name|i
expr_stmt|;
if|if
condition|(
name|scrollheight
operator|>
literal|0
condition|)
block|{
if|if
condition|(
name|screen
operator|->
name|incopy
condition|)
name|CopyWait
argument_list|(
name|screen
argument_list|)
expr_stmt|;
name|screen
operator|->
name|incopy
operator|=
operator|-
literal|1
expr_stmt|;
name|XMoveArea
argument_list|(
name|VWindow
argument_list|(
name|screen
argument_list|)
argument_list|,
name|screen
operator|->
name|border
argument_list|,
operator|(
name|scrolltop
operator|-
name|n
operator|)
operator|*
name|FontHeight
argument_list|(
name|screen
argument_list|)
operator|+
name|screen
operator|->
name|border
operator|+
name|Titlebar
argument_list|(
name|screen
argument_list|)
argument_list|,
name|screen
operator|->
name|border
argument_list|,
name|scrolltop
operator|*
name|FontHeight
argument_list|(
name|screen
argument_list|)
operator|+
name|screen
operator|->
name|border
operator|+
name|Titlebar
argument_list|(
name|screen
argument_list|)
argument_list|,
name|Width
argument_list|(
name|screen
argument_list|)
argument_list|,
name|scrollheight
operator|*
name|FontHeight
argument_list|(
name|screen
argument_list|)
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|refreshheight
operator|>
literal|0
condition|)
name|XTileSet
argument_list|(
name|VWindow
argument_list|(
name|screen
argument_list|)
argument_list|,
name|screen
operator|->
name|border
argument_list|,
name|refreshtop
operator|*
name|FontHeight
argument_list|(
name|screen
argument_list|)
operator|+
name|screen
operator|->
name|border
operator|+
name|Titlebar
argument_list|(
name|screen
argument_list|)
argument_list|,
name|Width
argument_list|(
name|screen
argument_list|)
argument_list|,
name|refreshheight
operator|*
name|FontHeight
argument_list|(
name|screen
argument_list|)
argument_list|,
name|screen
operator|->
name|bgndtile
argument_list|)
expr_stmt|;
block|}
comment|/* adjust screen->buf */
name|ScrnInsertLine
argument_list|(
name|screen
operator|->
name|buf
argument_list|,
name|screen
operator|->
name|bot_marg
argument_list|,
name|screen
operator|->
name|cur_row
argument_list|,
name|n
argument_list|,
name|screen
operator|->
name|max_col
operator|+
literal|1
argument_list|)
expr_stmt|;
block|}
end_block

begin_comment
comment|/*  * If cursor not in scrolling region, returns.  Else, deletes n lines  * at the cursor's position, lines added at bottom margin are blank.  */
end_comment

begin_expr_stmt
name|DeleteLine
argument_list|(
name|screen
argument_list|,
name|n
argument_list|)
specifier|register
name|Screen
operator|*
name|screen
expr_stmt|;
end_expr_stmt

begin_decl_stmt
specifier|register
name|int
name|n
decl_stmt|;
end_decl_stmt

begin_block
block|{
specifier|register
name|int
name|i
decl_stmt|;
specifier|register
name|int
name|shift
decl_stmt|;
specifier|register
name|int
name|bot
decl_stmt|;
specifier|register
name|int
name|refreshtop
decl_stmt|;
specifier|register
name|int
name|refreshheight
decl_stmt|;
specifier|register
name|int
name|scrolltop
decl_stmt|;
specifier|register
name|int
name|scrollheight
decl_stmt|;
if|if
condition|(
name|screen
operator|->
name|cur_row
operator|<
name|screen
operator|->
name|top_marg
operator|||
name|screen
operator|->
name|cur_row
operator|>
name|screen
operator|->
name|bot_marg
condition|)
return|return;
if|if
condition|(
name|screen
operator|->
name|cursor_state
condition|)
name|HideCursor
argument_list|()
expr_stmt|;
name|screen
operator|->
name|do_wrap
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|n
operator|>
operator|(
name|i
operator|=
name|screen
operator|->
name|bot_marg
operator|-
name|screen
operator|->
name|cur_row
operator|+
literal|1
operator|)
condition|)
name|n
operator|=
name|i
expr_stmt|;
if|if
condition|(
name|screen
operator|->
name|jumpscroll
condition|)
block|{
if|if
condition|(
name|screen
operator|->
name|scroll_amt
operator|>=
literal|0
operator|&&
name|screen
operator|->
name|cur_row
operator|==
name|screen
operator|->
name|top_marg
condition|)
block|{
if|if
condition|(
name|screen
operator|->
name|refresh_amt
operator|+
name|n
operator|>
name|screen
operator|->
name|max_row
operator|+
literal|1
condition|)
name|FlushScroll
argument_list|(
name|screen
argument_list|)
expr_stmt|;
name|screen
operator|->
name|scroll_amt
operator|+=
name|n
expr_stmt|;
name|screen
operator|->
name|refresh_amt
operator|+=
name|n
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|screen
operator|->
name|scroll_amt
condition|)
name|FlushScroll
argument_list|(
name|screen
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|screen
operator|->
name|scroll_amt
condition|)
block|{
name|shift
operator|=
operator|-
name|screen
operator|->
name|topline
expr_stmt|;
name|bot
operator|=
name|screen
operator|->
name|max_row
operator|-
name|shift
expr_stmt|;
name|scrollheight
operator|=
name|i
operator|-
name|n
expr_stmt|;
name|refreshheight
operator|=
name|n
expr_stmt|;
if|if
condition|(
operator|(
name|refreshtop
operator|=
name|screen
operator|->
name|bot_marg
operator|-
name|refreshheight
operator|+
literal|1
operator|+
name|shift
operator|)
operator|>
operator|(
name|i
operator|=
name|screen
operator|->
name|max_row
operator|-
name|refreshheight
operator|+
literal|1
operator|)
condition|)
name|refreshtop
operator|=
name|i
expr_stmt|;
if|if
condition|(
name|screen
operator|->
name|sb
operator|&&
name|GetSaveState
argument_list|(
name|screen
operator|->
name|sb
argument_list|)
operator|&&
name|screen
operator|->
name|cur_row
operator|==
literal|0
condition|)
block|{
name|scrolltop
operator|=
literal|0
expr_stmt|;
if|if
condition|(
operator|(
name|scrollheight
operator|+=
name|shift
operator|)
operator|>
name|i
condition|)
name|scrollheight
operator|=
name|i
expr_stmt|;
if|if
condition|(
operator|(
name|i
operator|=
operator|-
name|GetScrollBarTop
argument_list|(
name|screen
operator|->
name|sb
argument_list|)
operator|)
operator|<
name|screen
operator|->
name|savelines
condition|)
block|{
if|if
condition|(
operator|(
name|i
operator|+=
name|n
operator|)
operator|>
name|screen
operator|->
name|savelines
condition|)
name|i
operator|=
name|screen
operator|->
name|savelines
expr_stmt|;
name|SetScrollBarTop
argument_list|(
name|screen
operator|->
name|sb
argument_list|,
operator|-
name|i
argument_list|)
expr_stmt|;
name|DrawScrollRegion
argument_list|(
name|screen
operator|->
name|sb
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
name|scrolltop
operator|=
name|screen
operator|->
name|cur_row
operator|+
name|shift
expr_stmt|;
if|if
condition|(
operator|(
name|i
operator|=
name|screen
operator|->
name|bot_marg
operator|-
name|bot
operator|)
operator|>
literal|0
condition|)
block|{
name|scrollheight
operator|-=
name|i
expr_stmt|;
if|if
condition|(
operator|(
name|i
operator|=
name|screen
operator|->
name|cur_row
operator|+
name|n
operator|-
literal|1
operator|-
name|bot
operator|)
operator|>=
literal|0
condition|)
block|{
name|refreshheight
operator|-=
name|i
expr_stmt|;
block|}
block|}
block|}
if|if
condition|(
name|scrollheight
operator|>
literal|0
condition|)
block|{
if|if
condition|(
name|screen
operator|->
name|incopy
condition|)
name|CopyWait
argument_list|(
name|screen
argument_list|)
expr_stmt|;
name|screen
operator|->
name|incopy
operator|=
operator|-
literal|1
expr_stmt|;
name|XMoveArea
argument_list|(
name|VWindow
argument_list|(
name|screen
argument_list|)
argument_list|,
name|screen
operator|->
name|border
argument_list|,
operator|(
name|scrolltop
operator|+
name|n
operator|)
operator|*
name|FontHeight
argument_list|(
name|screen
argument_list|)
operator|+
name|screen
operator|->
name|border
operator|+
name|Titlebar
argument_list|(
name|screen
argument_list|)
argument_list|,
name|screen
operator|->
name|border
argument_list|,
name|scrolltop
operator|*
name|FontHeight
argument_list|(
name|screen
argument_list|)
operator|+
name|screen
operator|->
name|border
operator|+
name|Titlebar
argument_list|(
name|screen
argument_list|)
argument_list|,
name|Width
argument_list|(
name|screen
argument_list|)
argument_list|,
name|scrollheight
operator|*
name|FontHeight
argument_list|(
name|screen
argument_list|)
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|refreshheight
operator|>
literal|0
condition|)
name|XTileSet
argument_list|(
name|VWindow
argument_list|(
name|screen
argument_list|)
argument_list|,
name|screen
operator|->
name|border
argument_list|,
name|refreshtop
operator|*
name|FontHeight
argument_list|(
name|screen
argument_list|)
operator|+
name|screen
operator|->
name|border
operator|+
name|Titlebar
argument_list|(
name|screen
argument_list|)
argument_list|,
name|Width
argument_list|(
name|screen
argument_list|)
argument_list|,
name|refreshheight
operator|*
name|FontHeight
argument_list|(
name|screen
argument_list|)
argument_list|,
name|screen
operator|->
name|bgndtile
argument_list|)
expr_stmt|;
block|}
comment|/* adjust screen->buf */
if|if
condition|(
name|screen
operator|->
name|sb
operator|&&
name|GetSaveState
argument_list|(
name|screen
operator|->
name|sb
argument_list|)
operator|&&
name|screen
operator|->
name|cur_row
operator|==
literal|0
condition|)
name|ScrnDeleteLine
argument_list|(
name|screen
operator|->
name|allbuf
argument_list|,
name|screen
operator|->
name|bot_marg
operator|+
name|screen
operator|->
name|savelines
argument_list|,
literal|0
argument_list|,
name|n
argument_list|,
name|screen
operator|->
name|max_col
operator|+
literal|1
argument_list|)
expr_stmt|;
else|else
name|ScrnDeleteLine
argument_list|(
name|screen
operator|->
name|buf
argument_list|,
name|screen
operator|->
name|bot_marg
argument_list|,
name|screen
operator|->
name|cur_row
argument_list|,
name|n
argument_list|,
name|screen
operator|->
name|max_col
operator|+
literal|1
argument_list|)
expr_stmt|;
block|}
end_block

begin_comment
comment|/*  * Insert n blanks at the cursor's position, no wraparound  */
end_comment

begin_expr_stmt
name|InsertChar
argument_list|(
name|screen
argument_list|,
name|n
argument_list|)
specifier|register
name|Screen
operator|*
name|screen
expr_stmt|;
end_expr_stmt

begin_decl_stmt
specifier|register
name|int
name|n
decl_stmt|;
end_decl_stmt

begin_block
block|{
specifier|register
name|int
name|width
init|=
name|n
operator|*
name|FontWidth
argument_list|(
name|screen
argument_list|)
decl_stmt|,
name|cx
decl_stmt|,
name|cy
decl_stmt|;
if|if
condition|(
name|screen
operator|->
name|cursor_state
condition|)
name|HideCursor
argument_list|()
expr_stmt|;
name|screen
operator|->
name|do_wrap
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|screen
operator|->
name|cur_row
operator|-
name|screen
operator|->
name|topline
operator|<=
name|screen
operator|->
name|max_row
operator|||
name|screen
operator|->
name|instatus
condition|)
block|{
if|if
condition|(
operator|!
name|AddToRefresh
argument_list|(
name|screen
argument_list|)
condition|)
block|{
if|if
condition|(
name|screen
operator|->
name|scroll_amt
condition|)
name|FlushScroll
argument_list|(
name|screen
argument_list|)
expr_stmt|;
if|if
condition|(
name|screen
operator|->
name|incopy
condition|)
name|CopyWait
argument_list|(
name|screen
argument_list|)
expr_stmt|;
name|screen
operator|->
name|incopy
operator|=
operator|-
literal|1
expr_stmt|;
name|cx
operator|=
name|CursorX
argument_list|(
name|screen
argument_list|,
name|screen
operator|->
name|cur_col
argument_list|)
expr_stmt|;
name|cy
operator|=
name|CursorY
argument_list|(
name|screen
argument_list|,
name|screen
operator|->
name|cur_row
argument_list|)
expr_stmt|;
name|XMoveArea
argument_list|(
name|VWindow
argument_list|(
name|screen
argument_list|)
argument_list|,
name|cx
argument_list|,
name|cy
argument_list|,
name|cx
operator|+
name|width
argument_list|,
name|cy
argument_list|,
name|Width
argument_list|(
name|screen
argument_list|)
operator|-
operator|(
name|screen
operator|->
name|cur_col
operator|+
name|n
operator|)
operator|*
name|FontWidth
argument_list|(
name|screen
argument_list|)
argument_list|,
name|FontHeight
argument_list|(
name|screen
argument_list|)
argument_list|)
expr_stmt|;
name|XPixSet
argument_list|(
name|VWindow
argument_list|(
name|screen
argument_list|)
argument_list|,
name|cx
argument_list|,
name|cy
argument_list|,
name|width
argument_list|,
name|FontHeight
argument_list|(
name|screen
argument_list|)
argument_list|,
name|screen
operator|->
name|instatus
condition|?
name|screen
operator|->
name|foreground
else|:
name|screen
operator|->
name|background
argument_list|)
expr_stmt|;
block|}
block|}
comment|/* adjust screen->buf */
name|ScrnInsertChar
argument_list|(
name|screen
operator|->
name|buf
argument_list|,
name|screen
operator|->
name|cur_row
argument_list|,
name|screen
operator|->
name|cur_col
argument_list|,
name|n
argument_list|,
name|screen
operator|->
name|max_col
operator|+
literal|1
argument_list|)
expr_stmt|;
block|}
end_block

begin_comment
comment|/*  * Deletes n chars at the cursor's position, no wraparound.  */
end_comment

begin_expr_stmt
name|DeleteChar
argument_list|(
name|screen
argument_list|,
name|n
argument_list|)
specifier|register
name|Screen
operator|*
name|screen
expr_stmt|;
end_expr_stmt

begin_decl_stmt
specifier|register
name|int
name|n
decl_stmt|;
end_decl_stmt

begin_block
block|{
specifier|register
name|int
name|width
decl_stmt|,
name|cx
decl_stmt|,
name|cy
decl_stmt|;
if|if
condition|(
name|screen
operator|->
name|cursor_state
condition|)
name|HideCursor
argument_list|()
expr_stmt|;
name|screen
operator|->
name|do_wrap
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|n
operator|>
operator|(
name|width
operator|=
name|screen
operator|->
name|max_col
operator|+
literal|1
operator|-
name|screen
operator|->
name|cur_col
operator|)
condition|)
name|n
operator|=
name|width
expr_stmt|;
if|if
condition|(
name|screen
operator|->
name|cur_row
operator|-
name|screen
operator|->
name|topline
operator|<=
name|screen
operator|->
name|max_row
operator|||
name|screen
operator|->
name|instatus
condition|)
block|{
if|if
condition|(
operator|!
name|AddToRefresh
argument_list|(
name|screen
argument_list|)
condition|)
block|{
if|if
condition|(
name|screen
operator|->
name|scroll_amt
condition|)
name|FlushScroll
argument_list|(
name|screen
argument_list|)
expr_stmt|;
name|width
operator|=
name|n
operator|*
name|FontWidth
argument_list|(
name|screen
argument_list|)
expr_stmt|;
if|if
condition|(
name|screen
operator|->
name|incopy
condition|)
name|CopyWait
argument_list|(
name|screen
argument_list|)
expr_stmt|;
name|screen
operator|->
name|incopy
operator|=
operator|-
literal|1
expr_stmt|;
name|cx
operator|=
name|CursorX
argument_list|(
name|screen
argument_list|,
name|screen
operator|->
name|cur_col
argument_list|)
expr_stmt|;
name|cy
operator|=
name|CursorY
argument_list|(
name|screen
argument_list|,
name|screen
operator|->
name|cur_row
argument_list|)
expr_stmt|;
name|XMoveArea
argument_list|(
name|VWindow
argument_list|(
name|screen
argument_list|)
argument_list|,
name|cx
operator|+
name|width
argument_list|,
name|cy
argument_list|,
name|cx
argument_list|,
name|cy
argument_list|,
name|Width
argument_list|(
name|screen
argument_list|)
operator|-
operator|(
name|screen
operator|->
name|cur_col
operator|+
name|n
operator|)
operator|*
name|FontWidth
argument_list|(
name|screen
argument_list|)
argument_list|,
name|FontHeight
argument_list|(
name|screen
argument_list|)
argument_list|)
expr_stmt|;
name|XPixSet
argument_list|(
name|VWindow
argument_list|(
name|screen
argument_list|)
argument_list|,
name|screen
operator|->
name|border
operator|+
name|Width
argument_list|(
name|screen
argument_list|)
operator|-
name|width
argument_list|,
name|cy
argument_list|,
name|width
argument_list|,
name|FontHeight
argument_list|(
name|screen
argument_list|)
argument_list|,
name|screen
operator|->
name|instatus
condition|?
name|screen
operator|->
name|foreground
else|:
name|screen
operator|->
name|background
argument_list|)
expr_stmt|;
block|}
block|}
comment|/* adjust screen->buf */
name|ScrnDeleteChar
argument_list|(
name|screen
operator|->
name|buf
argument_list|,
name|screen
operator|->
name|cur_row
argument_list|,
name|screen
operator|->
name|cur_col
argument_list|,
name|n
argument_list|,
name|screen
operator|->
name|max_col
operator|+
literal|1
argument_list|)
expr_stmt|;
block|}
end_block

begin_comment
comment|/*  * Clear from cursor position to beginning of display, inclusive.  */
end_comment

begin_expr_stmt
name|ClearAbove
argument_list|(
name|screen
argument_list|)
specifier|register
name|Screen
operator|*
name|screen
expr_stmt|;
end_expr_stmt

begin_block
block|{
specifier|register
name|top
operator|,
name|height
expr_stmt|;
if|if
condition|(
name|screen
operator|->
name|cursor_state
condition|)
name|HideCursor
argument_list|()
expr_stmt|;
if|if
condition|(
operator|(
name|top
operator|=
operator|-
name|screen
operator|->
name|topline
operator|)
operator|<=
name|screen
operator|->
name|max_row
condition|)
block|{
if|if
condition|(
name|screen
operator|->
name|scroll_amt
condition|)
name|FlushScroll
argument_list|(
name|screen
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|height
operator|=
name|screen
operator|->
name|cur_row
operator|+
name|top
operator|)
operator|>
name|screen
operator|->
name|max_row
condition|)
name|height
operator|=
name|screen
operator|->
name|max_row
expr_stmt|;
if|if
condition|(
operator|(
name|height
operator|-=
name|top
operator|)
operator|>
literal|0
condition|)
name|XTileSet
argument_list|(
name|VWindow
argument_list|(
name|screen
argument_list|)
argument_list|,
name|screen
operator|->
name|border
argument_list|,
name|top
operator|*
name|FontHeight
argument_list|(
name|screen
argument_list|)
operator|+
name|screen
operator|->
name|border
operator|+
name|Titlebar
argument_list|(
name|screen
argument_list|)
argument_list|,
name|Width
argument_list|(
name|screen
argument_list|)
argument_list|,
name|height
operator|*
name|FontHeight
argument_list|(
name|screen
argument_list|)
argument_list|,
name|screen
operator|->
name|bgndtile
argument_list|)
expr_stmt|;
if|if
condition|(
name|screen
operator|->
name|cur_row
operator|-
name|screen
operator|->
name|topline
operator|<=
name|screen
operator|->
name|max_row
condition|)
name|ClearLeft
argument_list|(
name|screen
argument_list|)
expr_stmt|;
block|}
name|ClearBufRows
argument_list|(
name|screen
argument_list|,
literal|0
argument_list|,
name|screen
operator|->
name|cur_row
operator|-
literal|1
argument_list|)
expr_stmt|;
block|}
end_block

begin_comment
comment|/*  * Clear from cursor position to end of display, inclusive.  */
end_comment

begin_expr_stmt
name|ClearBelow
argument_list|(
name|screen
argument_list|)
specifier|register
name|Screen
operator|*
name|screen
expr_stmt|;
end_expr_stmt

begin_block
block|{
specifier|register
name|top
expr_stmt|;
name|ClearRight
argument_list|(
name|screen
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|top
operator|=
name|screen
operator|->
name|cur_row
operator|-
name|screen
operator|->
name|topline
operator|)
operator|<=
name|screen
operator|->
name|max_row
condition|)
block|{
if|if
condition|(
name|screen
operator|->
name|scroll_amt
condition|)
name|FlushScroll
argument_list|(
name|screen
argument_list|)
expr_stmt|;
if|if
condition|(
operator|++
name|top
operator|<=
name|screen
operator|->
name|max_row
condition|)
name|XTileSet
argument_list|(
name|VWindow
argument_list|(
name|screen
argument_list|)
argument_list|,
name|screen
operator|->
name|border
argument_list|,
name|top
operator|*
name|FontHeight
argument_list|(
name|screen
argument_list|)
operator|+
name|screen
operator|->
name|border
operator|+
name|Titlebar
argument_list|(
name|screen
argument_list|)
argument_list|,
name|Width
argument_list|(
name|screen
argument_list|)
argument_list|,
operator|(
name|screen
operator|->
name|max_row
operator|-
name|top
operator|+
literal|1
operator|)
operator|*
name|FontHeight
argument_list|(
name|screen
argument_list|)
argument_list|,
name|screen
operator|->
name|bgndtile
argument_list|)
expr_stmt|;
block|}
name|ClearBufRows
argument_list|(
name|screen
argument_list|,
name|screen
operator|->
name|cur_row
operator|+
literal|1
argument_list|,
name|screen
operator|->
name|max_row
argument_list|)
expr_stmt|;
block|}
end_block

begin_comment
comment|/*   * Clear last part of cursor's line, inclusive.  */
end_comment

begin_expr_stmt
name|ClearRight
argument_list|(
name|screen
argument_list|)
specifier|register
name|Screen
operator|*
name|screen
expr_stmt|;
end_expr_stmt

begin_block
block|{
if|if
condition|(
name|screen
operator|->
name|cursor_state
condition|)
name|HideCursor
argument_list|()
expr_stmt|;
name|screen
operator|->
name|do_wrap
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|screen
operator|->
name|cur_row
operator|-
name|screen
operator|->
name|topline
operator|<=
name|screen
operator|->
name|max_row
operator|||
name|screen
operator|->
name|instatus
condition|)
block|{
if|if
condition|(
operator|!
name|AddToRefresh
argument_list|(
name|screen
argument_list|)
condition|)
block|{
if|if
condition|(
name|screen
operator|->
name|scroll_amt
condition|)
name|FlushScroll
argument_list|(
name|screen
argument_list|)
expr_stmt|;
name|XPixSet
argument_list|(
name|VWindow
argument_list|(
name|screen
argument_list|)
argument_list|,
name|CursorX
argument_list|(
name|screen
argument_list|,
name|screen
operator|->
name|cur_col
argument_list|)
argument_list|,
name|CursorY
argument_list|(
name|screen
argument_list|,
name|screen
operator|->
name|cur_row
argument_list|)
argument_list|,
name|Width
argument_list|(
name|screen
argument_list|)
operator|-
name|screen
operator|->
name|cur_col
operator|*
name|FontWidth
argument_list|(
name|screen
argument_list|)
argument_list|,
name|FontHeight
argument_list|(
name|screen
argument_list|)
argument_list|,
name|screen
operator|->
name|instatus
condition|?
name|screen
operator|->
name|foreground
else|:
name|screen
operator|->
name|background
argument_list|)
expr_stmt|;
block|}
block|}
name|bzero
argument_list|(
name|screen
operator|->
name|buf
index|[
literal|2
operator|*
name|screen
operator|->
name|cur_row
index|]
operator|+
name|screen
operator|->
name|cur_col
argument_list|,
operator|(
name|screen
operator|->
name|max_col
operator|-
name|screen
operator|->
name|cur_col
operator|+
literal|1
operator|)
argument_list|)
expr_stmt|;
name|bzero
argument_list|(
name|screen
operator|->
name|buf
index|[
literal|2
operator|*
name|screen
operator|->
name|cur_row
operator|+
literal|1
index|]
operator|+
name|screen
operator|->
name|cur_col
argument_list|,
operator|(
name|screen
operator|->
name|max_col
operator|-
name|screen
operator|->
name|cur_col
operator|+
literal|1
operator|)
argument_list|)
expr_stmt|;
block|}
end_block

begin_comment
comment|/*  * Clear first part of cursor's line, inclusive.  */
end_comment

begin_expr_stmt
name|ClearLeft
argument_list|(
name|screen
argument_list|)
specifier|register
name|Screen
operator|*
name|screen
expr_stmt|;
end_expr_stmt

begin_block
block|{
if|if
condition|(
name|screen
operator|->
name|cursor_state
condition|)
name|HideCursor
argument_list|()
expr_stmt|;
name|screen
operator|->
name|do_wrap
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|screen
operator|->
name|cur_row
operator|-
name|screen
operator|->
name|topline
operator|<=
name|screen
operator|->
name|max_row
operator|||
name|screen
operator|->
name|instatus
condition|)
block|{
if|if
condition|(
operator|!
name|AddToRefresh
argument_list|(
name|screen
argument_list|)
condition|)
block|{
if|if
condition|(
name|screen
operator|->
name|scroll_amt
condition|)
name|FlushScroll
argument_list|(
name|screen
argument_list|)
expr_stmt|;
name|XPixSet
argument_list|(
name|VWindow
argument_list|(
name|screen
argument_list|)
argument_list|,
name|screen
operator|->
name|border
argument_list|,
name|CursorY
argument_list|(
name|screen
argument_list|,
name|screen
operator|->
name|cur_row
argument_list|)
argument_list|,
operator|(
name|screen
operator|->
name|cur_col
operator|+
literal|1
operator|)
operator|*
name|FontWidth
argument_list|(
name|screen
argument_list|)
argument_list|,
name|FontHeight
argument_list|(
name|screen
argument_list|)
argument_list|,
name|screen
operator|->
name|instatus
condition|?
name|screen
operator|->
name|foreground
else|:
name|screen
operator|->
name|background
argument_list|)
expr_stmt|;
block|}
block|}
name|bzero
argument_list|(
name|screen
operator|->
name|buf
index|[
literal|2
operator|*
name|screen
operator|->
name|cur_row
index|]
argument_list|,
operator|(
name|screen
operator|->
name|cur_col
operator|+
literal|1
operator|)
argument_list|)
expr_stmt|;
name|bzero
argument_list|(
name|screen
operator|->
name|buf
index|[
literal|2
operator|*
name|screen
operator|->
name|cur_row
operator|+
literal|1
index|]
argument_list|,
operator|(
name|screen
operator|->
name|cur_col
operator|+
literal|1
operator|)
argument_list|)
expr_stmt|;
block|}
end_block

begin_comment
comment|/*   * Erase the cursor's line.  */
end_comment

begin_expr_stmt
name|ClearLine
argument_list|(
name|screen
argument_list|)
specifier|register
name|Screen
operator|*
name|screen
expr_stmt|;
end_expr_stmt

begin_block
block|{
if|if
condition|(
name|screen
operator|->
name|cursor_state
condition|)
name|HideCursor
argument_list|()
expr_stmt|;
name|screen
operator|->
name|do_wrap
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|screen
operator|->
name|cur_row
operator|-
name|screen
operator|->
name|topline
operator|<=
name|screen
operator|->
name|max_row
operator|||
name|screen
operator|->
name|instatus
condition|)
block|{
if|if
condition|(
operator|!
name|AddToRefresh
argument_list|(
name|screen
argument_list|)
condition|)
block|{
if|if
condition|(
name|screen
operator|->
name|scroll_amt
condition|)
name|FlushScroll
argument_list|(
name|screen
argument_list|)
expr_stmt|;
name|XPixSet
argument_list|(
name|VWindow
argument_list|(
name|screen
argument_list|)
argument_list|,
name|screen
operator|->
name|border
argument_list|,
name|CursorY
argument_list|(
name|screen
argument_list|,
name|screen
operator|->
name|cur_row
argument_list|)
argument_list|,
name|Width
argument_list|(
name|screen
argument_list|)
argument_list|,
name|FontHeight
argument_list|(
name|screen
argument_list|)
argument_list|,
name|screen
operator|->
name|instatus
condition|?
name|screen
operator|->
name|foreground
else|:
name|screen
operator|->
name|background
argument_list|)
expr_stmt|;
block|}
block|}
name|bzero
argument_list|(
name|screen
operator|->
name|buf
index|[
literal|2
operator|*
name|screen
operator|->
name|cur_row
index|]
argument_list|,
operator|(
name|screen
operator|->
name|max_col
operator|+
literal|1
operator|)
argument_list|)
expr_stmt|;
name|bzero
argument_list|(
name|screen
operator|->
name|buf
index|[
literal|2
operator|*
name|screen
operator|->
name|cur_row
operator|+
literal|1
index|]
argument_list|,
operator|(
name|screen
operator|->
name|max_col
operator|+
literal|1
operator|)
argument_list|)
expr_stmt|;
block|}
end_block

begin_expr_stmt
name|ClearScreen
argument_list|(
name|screen
argument_list|)
specifier|register
name|Screen
operator|*
name|screen
expr_stmt|;
end_expr_stmt

begin_block
block|{
specifier|register
name|int
name|top
decl_stmt|;
if|if
condition|(
name|screen
operator|->
name|cursor_state
condition|)
name|HideCursor
argument_list|()
expr_stmt|;
name|screen
operator|->
name|do_wrap
operator|=
literal|0
expr_stmt|;
if|if
condition|(
operator|(
name|top
operator|=
operator|-
name|screen
operator|->
name|topline
operator|)
operator|<=
name|screen
operator|->
name|max_row
condition|)
block|{
if|if
condition|(
name|screen
operator|->
name|scroll_amt
condition|)
name|FlushScroll
argument_list|(
name|screen
argument_list|)
expr_stmt|;
if|if
condition|(
name|top
operator|==
literal|0
operator|&&
operator|!
name|screen
operator|->
name|statusline
condition|)
name|XClear
argument_list|(
name|VWindow
argument_list|(
name|screen
argument_list|)
argument_list|)
expr_stmt|;
else|else
name|XTileSet
argument_list|(
name|VWindow
argument_list|(
name|screen
argument_list|)
argument_list|,
name|screen
operator|->
name|border
argument_list|,
name|top
operator|*
name|FontHeight
argument_list|(
name|screen
argument_list|)
operator|+
name|screen
operator|->
name|border
operator|+
name|Titlebar
argument_list|(
name|screen
argument_list|)
argument_list|,
name|Width
argument_list|(
name|screen
argument_list|)
argument_list|,
operator|(
name|screen
operator|->
name|max_row
operator|-
name|top
operator|+
literal|1
operator|)
operator|*
name|FontHeight
argument_list|(
name|screen
argument_list|)
argument_list|,
name|screen
operator|->
name|bgndtile
argument_list|)
expr_stmt|;
block|}
name|ClearBufRows
argument_list|(
name|screen
argument_list|,
literal|0
argument_list|,
name|screen
operator|->
name|max_row
argument_list|)
expr_stmt|;
name|screen
operator|->
name|pagecnt
operator|=
literal|0
expr_stmt|;
block|}
end_block

begin_expr_stmt
name|CopyWait
argument_list|(
name|screen
argument_list|)
specifier|register
name|Screen
operator|*
name|screen
expr_stmt|;
end_expr_stmt

begin_block
block|{
name|XEvent
name|reply
decl_stmt|;
name|XEvent
modifier|*
name|rep
init|=
operator|&
name|reply
decl_stmt|;
while|while
condition|(
literal|1
condition|)
block|{
name|XWindowEvent
argument_list|(
name|VWindow
argument_list|(
name|screen
argument_list|)
argument_list|,
name|ExposeRegion
operator||
name|ExposeCopy
argument_list|,
operator|&
name|reply
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|reply
operator|.
name|type
condition|)
block|{
case|case
name|ExposeRegion
case|:
if|if
condition|(
operator|(
operator|(
name|XExposeEvent
operator|*
operator|)
name|rep
operator|)
operator|->
name|detail
operator|==
name|ExposeCopy
operator|&&
name|screen
operator|->
name|incopy
operator|<=
literal|0
condition|)
block|{
name|screen
operator|->
name|incopy
operator|=
literal|1
expr_stmt|;
if|if
condition|(
name|screen
operator|->
name|scrolls
operator|>
literal|0
condition|)
name|screen
operator|->
name|scrolls
operator|--
expr_stmt|;
block|}
name|HandleExposure
argument_list|(
name|screen
argument_list|,
operator|&
name|reply
argument_list|)
expr_stmt|;
break|break;
case|case
name|ExposeCopy
case|:
if|if
condition|(
name|screen
operator|->
name|incopy
operator|<=
literal|0
operator|&&
name|screen
operator|->
name|scrolls
operator|>
literal|0
condition|)
name|screen
operator|->
name|scrolls
operator|--
expr_stmt|;
if|if
condition|(
name|screen
operator|->
name|scrolls
operator|==
literal|0
condition|)
block|{
name|screen
operator|->
name|incopy
operator|=
literal|0
expr_stmt|;
return|return;
block|}
name|screen
operator|->
name|incopy
operator|=
operator|-
literal|1
expr_stmt|;
break|break;
block|}
block|}
block|}
end_block

begin_comment
comment|/*  * This routine handles exposure events  */
end_comment

begin_expr_stmt
name|HandleExposure
argument_list|(
name|screen
argument_list|,
name|reply
argument_list|)
specifier|register
name|Screen
operator|*
name|screen
expr_stmt|;
end_expr_stmt

begin_decl_stmt
specifier|register
name|XExposeEvent
modifier|*
name|reply
decl_stmt|;
end_decl_stmt

begin_block
block|{
specifier|register
name|int
name|toprow
decl_stmt|,
name|leftcol
decl_stmt|,
name|nrows
decl_stmt|,
name|ncols
decl_stmt|;
specifier|extern
name|Terminal
name|term
decl_stmt|;
comment|/* kludge */
name|XExposeRegionEvent
name|event
decl_stmt|;
if|if
condition|(
operator|(
name|toprow
operator|=
operator|(
name|reply
operator|->
name|y
operator|-
name|screen
operator|->
name|border
operator|-
name|Titlebar
argument_list|(
name|screen
argument_list|)
operator|)
operator|/
name|FontHeight
argument_list|(
name|screen
argument_list|)
operator|)
operator|<
literal|0
condition|)
name|toprow
operator|=
literal|0
expr_stmt|;
if|if
condition|(
operator|(
name|leftcol
operator|=
operator|(
name|reply
operator|->
name|x
operator|-
name|screen
operator|->
name|border
operator|)
operator|/
name|FontWidth
argument_list|(
name|screen
argument_list|)
operator|)
operator|<
literal|0
condition|)
name|leftcol
operator|=
literal|0
expr_stmt|;
name|nrows
operator|=
operator|(
name|reply
operator|->
name|y
operator|+
name|reply
operator|->
name|height
operator|-
literal|1
operator|-
name|screen
operator|->
name|border
operator|-
name|Titlebar
argument_list|(
name|screen
argument_list|)
operator|)
operator|/
name|FontHeight
argument_list|(
name|screen
argument_list|)
operator|-
name|toprow
operator|+
literal|1
expr_stmt|;
name|ncols
operator|=
operator|(
name|reply
operator|->
name|x
operator|+
name|reply
operator|->
name|width
operator|-
literal|1
operator|-
name|screen
operator|->
name|border
operator|)
operator|/
name|FontWidth
argument_list|(
name|screen
argument_list|)
operator|-
name|leftcol
operator|+
literal|1
expr_stmt|;
name|toprow
operator|-=
name|screen
operator|->
name|scrolls
expr_stmt|;
if|if
condition|(
name|toprow
operator|<
literal|0
condition|)
block|{
name|nrows
operator|+=
name|toprow
expr_stmt|;
name|toprow
operator|=
literal|0
expr_stmt|;
block|}
if|if
condition|(
name|toprow
operator|+
name|nrows
operator|-
literal|1
operator|>
name|screen
operator|->
name|max_row
condition|)
name|nrows
operator|=
name|screen
operator|->
name|max_row
operator|-
name|toprow
operator|+
literal|1
operator|+
name|screen
operator|->
name|statusline
expr_stmt|;
if|if
condition|(
name|leftcol
operator|+
name|ncols
operator|-
literal|1
operator|>
name|screen
operator|->
name|max_col
condition|)
name|ncols
operator|=
name|screen
operator|->
name|max_col
operator|-
name|leftcol
operator|+
literal|1
expr_stmt|;
if|if
condition|(
name|nrows
operator|>
literal|0
operator|&&
name|ncols
operator|>
literal|0
condition|)
block|{
name|ScrnRefresh
argument_list|(
name|screen
argument_list|,
name|toprow
argument_list|,
name|leftcol
argument_list|,
name|nrows
argument_list|,
name|ncols
argument_list|)
expr_stmt|;
if|if
condition|(
name|screen
operator|->
name|cur_row
operator|>=
name|toprow
operator|&&
name|screen
operator|->
name|cur_row
operator|<
name|toprow
operator|+
name|nrows
operator|&&
name|screen
operator|->
name|cur_col
operator|>=
name|leftcol
operator|&&
name|screen
operator|->
name|cur_col
operator|<
name|leftcol
operator|+
name|ncols
condition|)
return|return
operator|(
literal|1
operator|)
return|;
block|}
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_block

begin_macro
name|ReverseVideo
argument_list|(
argument|term
argument_list|)
end_macro

begin_decl_stmt
name|Terminal
modifier|*
name|term
decl_stmt|;
end_decl_stmt

begin_block
block|{
specifier|register
name|Screen
modifier|*
name|screen
init|=
operator|&
name|term
operator|->
name|screen
decl_stmt|;
specifier|register
name|Pixmap
name|pix
decl_stmt|;
specifier|register
name|int
name|tmp
decl_stmt|;
specifier|register
name|Window
name|tek
init|=
name|TWindow
argument_list|(
name|screen
argument_list|)
decl_stmt|;
specifier|extern
name|Pixmap
name|B_Pixmap
decl_stmt|;
specifier|extern
name|Pixmap
name|W_Pixmap
decl_stmt|;
if|if
condition|(
name|screen
operator|->
name|color
operator|&
name|C_BACKGROUND
condition|)
name|XFreePixmap
argument_list|(
name|screen
operator|->
name|bgndtile
argument_list|)
expr_stmt|;
name|tmp
operator|=
name|screen
operator|->
name|background
expr_stmt|;
if|if
condition|(
name|screen
operator|->
name|cursorcolor
operator|==
name|screen
operator|->
name|foreground
condition|)
name|screen
operator|->
name|cursorcolor
operator|=
name|tmp
expr_stmt|;
if|if
condition|(
name|screen
operator|->
name|mousecolor
operator|==
name|screen
operator|->
name|foreground
condition|)
name|screen
operator|->
name|mousecolor
operator|=
name|tmp
expr_stmt|;
name|screen
operator|->
name|background
operator|=
name|screen
operator|->
name|foreground
expr_stmt|;
name|screen
operator|->
name|foreground
operator|=
name|tmp
expr_stmt|;
name|screen
operator|->
name|color
operator|=
operator|(
name|screen
operator|->
name|color
operator|&
operator|~
name|C_FBMASK
operator|)
operator||
name|switchfb
index|[
name|screen
operator|->
name|color
operator|&
name|C_FBMASK
index|]
expr_stmt|;
if|if
condition|(
name|screen
operator|->
name|color
operator|&
name|C_BACKGROUND
condition|)
block|{
if|if
condition|(
operator|!
operator|(
name|screen
operator|->
name|bgndtile
operator|=
name|XMakeTile
argument_list|(
name|screen
operator|->
name|background
argument_list|)
operator|)
condition|)
name|Error
argument_list|(
name|ERROR_UBACK
argument_list|)
expr_stmt|;
block|}
else|else
name|screen
operator|->
name|bgndtile
operator|=
operator|(
name|screen
operator|->
name|background
operator|==
name|W_Pixel
operator|)
condition|?
name|W_Pixmap
else|:
name|B_Pixmap
expr_stmt|;
comment|/* X11 arrow cursor feature */
name|XFreeCursor
argument_list|(
name|screen
operator|->
name|curs
argument_list|)
expr_stmt|;
if|if
condition|(
name|curs_shape
operator|&&
name|strcmp
argument_list|(
name|curs_shape
argument_list|,
literal|"arrow"
argument_list|)
operator|==
literal|0
condition|)
name|screen
operator|->
name|curs
operator|=
name|make_arrow
argument_list|(
name|screen
operator|->
name|mousecolor
argument_list|,
name|screen
operator|->
name|background
argument_list|,
name|GXcopy
argument_list|)
expr_stmt|;
else|else
name|screen
operator|->
name|curs
operator|=
name|make_xterm
argument_list|(
name|screen
operator|->
name|mousecolor
argument_list|,
name|screen
operator|->
name|background
argument_list|,
name|GXcopy
argument_list|)
expr_stmt|;
name|XFreeCursor
argument_list|(
name|screen
operator|->
name|arrow
argument_list|)
expr_stmt|;
name|screen
operator|->
name|arrow
operator|=
name|make_arrow
argument_list|(
name|screen
operator|->
name|mousecolor
argument_list|,
name|screen
operator|->
name|background
argument_list|,
name|GXcopy
argument_list|)
expr_stmt|;
name|XDefineCursor
argument_list|(
name|VWindow
argument_list|(
name|screen
argument_list|)
argument_list|,
name|screen
operator|->
name|curs
argument_list|)
expr_stmt|;
if|if
condition|(
name|screen
operator|->
name|sb
condition|)
name|XDefineCursor
argument_list|(
name|screen
operator|->
name|sb
operator|->
name|bar
argument_list|,
name|screen
operator|->
name|sb
operator|->
name|cursor
operator|=
name|screen
operator|->
name|arrow
argument_list|)
expr_stmt|;
if|if
condition|(
name|screen
operator|->
name|title
operator|.
name|tbar
condition|)
name|XDefineCursor
argument_list|(
name|screen
operator|->
name|title
operator|.
name|tbar
argument_list|,
name|screen
operator|->
name|arrow
argument_list|)
expr_stmt|;
if|if
condition|(
name|tek
condition|)
name|XDefineCursor
argument_list|(
name|tek
argument_list|,
name|screen
operator|->
name|arrow
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|MODEMENU
name|MenuNewCursor
argument_list|(
name|screen
operator|->
name|arrow
argument_list|)
expr_stmt|;
endif|#
directive|endif
endif|MODEMENU
if|if
condition|(
name|screen
operator|->
name|background
operator|<
literal|2
operator|&&
name|screen
operator|->
name|foreground
operator|<
literal|2
condition|)
block|{
if|if
condition|(
name|screen
operator|->
name|bgndtile
operator|==
name|B_Pixmap
condition|)
name|screen
operator|->
name|bordertile
operator|=
name|W_Pixmap
expr_stmt|;
elseif|else
if|if
condition|(
name|screen
operator|->
name|bgndtile
operator|==
name|W_Pixmap
condition|)
name|screen
operator|->
name|bordertile
operator|=
name|B_Pixmap
expr_stmt|;
name|pix
operator|=
name|screen
operator|->
name|bordertile
expr_stmt|;
if|if
condition|(
name|screen
operator|->
name|sb
condition|)
name|XChangeBorder
argument_list|(
name|screen
operator|->
name|sb
operator|->
name|bar
argument_list|,
name|pix
argument_list|)
expr_stmt|;
if|if
condition|(
name|screen
operator|->
name|title
operator|.
name|tbar
condition|)
name|XChangeBorder
argument_list|(
name|screen
operator|->
name|title
operator|.
name|tbar
argument_list|,
name|pix
argument_list|)
expr_stmt|;
if|if
condition|(
name|tek
operator|&&
name|screen
operator|->
name|Ttitle
operator|.
name|tbar
condition|)
name|XChangeBorder
argument_list|(
name|screen
operator|->
name|Ttitle
operator|.
name|tbar
argument_list|,
name|pix
argument_list|)
expr_stmt|;
if|if
condition|(
name|screen
operator|->
name|borderwidth
operator|>
literal|0
condition|)
block|{
name|XChangeBorder
argument_list|(
name|VWindow
argument_list|(
name|screen
argument_list|)
argument_list|,
name|pix
argument_list|)
expr_stmt|;
name|XChangeBorder
argument_list|(
name|screen
operator|->
name|iconVwin
operator|.
name|window
argument_list|,
name|pix
argument_list|)
expr_stmt|;
if|if
condition|(
name|tek
condition|)
block|{
name|XChangeBorder
argument_list|(
name|tek
argument_list|,
name|pix
argument_list|)
expr_stmt|;
name|XChangeBorder
argument_list|(
name|screen
operator|->
name|iconTwin
operator|.
name|window
argument_list|,
name|pix
argument_list|)
expr_stmt|;
block|}
block|}
block|}
name|XChangeBackground
argument_list|(
name|VWindow
argument_list|(
name|screen
argument_list|)
argument_list|,
name|screen
operator|->
name|bgndtile
argument_list|)
expr_stmt|;
name|XChangeBackground
argument_list|(
name|screen
operator|->
name|iconVwin
operator|.
name|window
argument_list|,
name|screen
operator|->
name|bgndtile
argument_list|)
expr_stmt|;
if|if
condition|(
name|screen
operator|->
name|title
operator|.
name|tbar
condition|)
name|XChangeBackground
argument_list|(
name|screen
operator|->
name|title
operator|.
name|tbar
argument_list|,
name|screen
operator|->
name|bgndtile
argument_list|)
expr_stmt|;
if|if
condition|(
name|tek
condition|)
block|{
name|XChangeBackground
argument_list|(
name|screen
operator|->
name|iconTwin
operator|.
name|window
argument_list|,
name|screen
operator|->
name|bgndtile
argument_list|)
expr_stmt|;
if|if
condition|(
name|screen
operator|->
name|Ttitle
operator|.
name|tbar
condition|)
name|XChangeBackground
argument_list|(
name|screen
operator|->
name|Ttitle
operator|.
name|tbar
argument_list|,
name|screen
operator|->
name|bgndtile
argument_list|)
expr_stmt|;
name|TekReverseVideo
argument_list|(
name|screen
argument_list|)
expr_stmt|;
block|}
name|XClear
argument_list|(
name|VWindow
argument_list|(
name|screen
argument_list|)
argument_list|)
expr_stmt|;
name|XClear
argument_list|(
name|screen
operator|->
name|iconVwin
operator|.
name|window
argument_list|)
expr_stmt|;
name|ScrnRefresh
argument_list|(
name|screen
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
name|screen
operator|->
name|max_row
operator|+
literal|1
operator|+
name|screen
operator|->
name|statusline
argument_list|,
name|screen
operator|->
name|max_col
operator|+
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|screen
operator|->
name|Tshow
condition|)
block|{
name|XClear
argument_list|(
name|tek
argument_list|)
expr_stmt|;
name|XClear
argument_list|(
name|screen
operator|->
name|iconTwin
operator|.
name|window
argument_list|)
expr_stmt|;
name|TekExpose
argument_list|(
operator|(
name|XExposeWindowEvent
operator|*
operator|)
literal|0
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|Titlebar
argument_list|(
name|screen
argument_list|)
condition|)
block|{
name|XClear
argument_list|(
name|screen
operator|->
name|title
operator|.
name|tbar
argument_list|)
expr_stmt|;
name|VTTitleExpose
argument_list|(
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|screen
operator|->
name|Tshow
condition|)
block|{
name|XClear
argument_list|(
name|screen
operator|->
name|Ttitle
operator|.
name|tbar
argument_list|)
expr_stmt|;
name|TekTitleExpose
argument_list|(
name|NULL
argument_list|)
expr_stmt|;
block|}
block|}
block|}
end_block

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  *	@(#)scrollbar.c	1.11 (Berkeley/CSRG) 9/18/87  *	$Source: /u1/X/xterm/RCS/scrollbar.c,v $  *	$Header: scrollbar.c,v 10.100 86/12/01 14:45:27 jg Rel $  */
end_comment

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_include
include|#
directive|include
file|<sys/time.h>
end_include

begin_include
include|#
directive|include
file|<X/Xlib.h>
end_include

begin_include
include|#
directive|include
file|<setjmp.h>
end_include

begin_include
include|#
directive|include
file|"scrollbar.h"
end_include

begin_include
include|#
directive|include
file|"ptyx.h"
end_include

begin_include
include|#
directive|include
file|"data.h"
end_include

begin_include
include|#
directive|include
file|"error.h"
end_include

begin_ifdef
ifdef|#
directive|ifdef
name|MODEMENU
end_ifdef

begin_include
include|#
directive|include
file|"menu.h"
end_include

begin_endif
endif|#
directive|endif
endif|MODEMENU
end_endif

begin_include
include|#
directive|include
file|"button.ic"
end_include

begin_include
include|#
directive|include
file|"dark.ic"
end_include

begin_include
include|#
directive|include
file|"light.ic"
end_include

begin_include
include|#
directive|include
file|"upline.ic"
end_include

begin_include
include|#
directive|include
file|"downline.ic"
end_include

begin_include
include|#
directive|include
file|"uppage.ic"
end_include

begin_include
include|#
directive|include
file|"downpage.ic"
end_include

begin_include
include|#
directive|include
file|"top.ic"
end_include

begin_include
include|#
directive|include
file|"bottom.ic"
end_include

begin_include
include|#
directive|include
file|"saveoff.ic"
end_include

begin_include
include|#
directive|include
file|"saveon.ic"
end_include

begin_include
include|#
directive|include
file|"sbcursor.cursor"
end_include

begin_include
include|#
directive|include
file|"sbcursor_mask.cursor"
end_include

begin_ifndef
ifndef|#
directive|ifndef
name|lint
end_ifndef

begin_decl_stmt
specifier|static
name|char
name|csrg_id
index|[]
init|=
literal|"@(#)scrollbar.c	1.11\t(Berkeley/CSRG)\t9/18/87"
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|char
name|sccs_id
index|[]
init|=
literal|"@(#)scrollbar.c\tX10/6.6B\t12/26/86"
decl_stmt|;
end_decl_stmt

begin_endif
endif|#
directive|endif
endif|lint
end_endif

begin_decl_stmt
specifier|static
name|struct
name|timeval
name|stepspeed
decl_stmt|;
end_decl_stmt

begin_function
name|ScrollBar
modifier|*
name|CreateScrollBar
parameter_list|(
name|w
parameter_list|,
name|x
parameter_list|,
name|y
parameter_list|,
name|height
parameter_list|,
name|fg
parameter_list|,
name|bg
parameter_list|,
name|bordertile
parameter_list|,
name|val
parameter_list|,
name|valregion
parameter_list|,
name|topval
parameter_list|,
name|botval
parameter_list|,
name|arrow
parameter_list|)
name|Window
name|w
decl_stmt|;
name|int
name|x
decl_stmt|,
name|y
decl_stmt|,
name|height
decl_stmt|,
name|fg
decl_stmt|,
name|bg
decl_stmt|,
name|val
decl_stmt|,
name|valregion
decl_stmt|,
name|topval
decl_stmt|,
name|botval
decl_stmt|;
name|Pixmap
name|bordertile
decl_stmt|;
name|Cursor
name|arrow
decl_stmt|;
block|{
specifier|register
name|ScrollBar
modifier|*
name|sb
decl_stmt|;
specifier|register
name|int
name|i
decl_stmt|;
name|Pixmap
name|btile
decl_stmt|,
name|bgnd
decl_stmt|;
specifier|extern
name|char
modifier|*
name|calloc
parameter_list|()
function_decl|;
specifier|static
name|Window
name|Make_tiled_window
parameter_list|()
function_decl|;
specifier|extern
name|Pixmap
name|Make_tile
parameter_list|()
function_decl|;
if|if
condition|(
operator|!
name|w
operator|||
name|height
operator|<
name|MINSCROLLBARHEIGHT
operator|||
operator|(
name|sb
operator|=
operator|(
name|ScrollBar
operator|*
operator|)
name|calloc
argument_list|(
literal|1
argument_list|,
sizeof|sizeof
argument_list|(
name|ScrollBar
argument_list|)
argument_list|)
operator|)
operator|==
name|NULL
condition|)
return|return
operator|(
name|NULL
operator|)
return|;
name|btile
operator|=
name|bordertile
expr_stmt|;
if|if
condition|(
name|bg
operator|==
name|BlackPixel
operator|&&
name|fg
operator|==
name|WhitePixel
condition|)
block|{
name|bg
operator|=
name|WhitePixel
expr_stmt|;
name|fg
operator|=
name|BlackPixel
expr_stmt|;
if|if
condition|(
name|btile
operator|==
name|WhitePixmap
condition|)
name|btile
operator|=
name|BlackPixmap
expr_stmt|;
block|}
name|sb
operator|->
name|fg
operator|=
name|fg
expr_stmt|;
name|sb
operator|->
name|bg
operator|=
name|bg
expr_stmt|;
name|sb
operator|->
name|cursor
operator|=
name|XCreateCursor
argument_list|(
name|sbcursor_width
argument_list|,
name|sbcursor_height
argument_list|,
name|sbcursor_bits
argument_list|,
name|sbcursor_mask_bits
argument_list|,
name|sbcursor_x_hot
argument_list|,
name|sbcursor_y_hot
argument_list|,
name|fg
argument_list|,
name|bg
argument_list|,
name|GXcopy
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|sb
operator|->
name|bar
operator|=
name|Make_tiled_window
argument_list|(
name|light_width
argument_list|,
name|light_height
argument_list|,
name|light_bits
argument_list|,
name|fg
argument_list|,
name|bg
argument_list|,
operator|&
name|bgnd
argument_list|,
name|w
argument_list|,
name|x
argument_list|,
name|y
argument_list|,
operator|(
name|SCROLLBARWIDTH
operator|-
literal|1
operator|)
argument_list|,
name|height
argument_list|,
literal|1
argument_list|,
name|bordertile
argument_list|)
operator|)
operator|==
name|NULL
condition|)
goto|goto
name|failed_bar
goto|;
if|if
condition|(
operator|(
name|sb
operator|->
name|button
operator|=
name|XCreateWindow
argument_list|(
name|sb
operator|->
name|bar
argument_list|,
operator|-
literal|1
argument_list|,
operator|-
literal|1
argument_list|,
operator|(
name|SCROLLBARWIDTH
operator|-
literal|1
operator|)
argument_list|,
name|BUTTONHEIGHT
operator|-
literal|1
argument_list|,
literal|1
argument_list|,
name|btile
argument_list|,
name|bgnd
argument_list|)
operator|)
operator|==
name|NULL
condition|)
goto|goto
name|failed_button
goto|;
if|if
condition|(
operator|(
name|sb
operator|->
name|save
operator|=
name|XCreateWindow
argument_list|(
name|sb
operator|->
name|bar
argument_list|,
operator|-
literal|1
argument_list|,
name|BUTTONHEIGHT
operator|-
literal|1
argument_list|,
operator|(
name|SCROLLBARWIDTH
operator|-
literal|1
operator|)
argument_list|,
name|BUTTONHEIGHT
operator|-
literal|1
argument_list|,
literal|1
argument_list|,
name|btile
argument_list|,
name|bgnd
argument_list|)
operator|)
operator|==
name|NULL
condition|)
goto|goto
name|failed_save
goto|;
if|if
condition|(
operator|(
name|sb
operator|->
name|region
operator|=
name|Make_tiled_window
argument_list|(
name|dark_width
argument_list|,
name|dark_height
argument_list|,
name|dark_bits
argument_list|,
name|fg
argument_list|,
name|bg
argument_list|,
operator|&
name|bgnd
argument_list|,
name|sb
operator|->
name|bar
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
operator|(
name|SCROLLBARWIDTH
operator|-
literal|1
operator|)
argument_list|,
literal|10
argument_list|,
literal|0
argument_list|,
operator|(
name|Pixmap
operator|)
name|NULL
argument_list|)
operator|)
operator|==
name|NULL
condition|)
block|{
name|XDestroyWindow
argument_list|(
name|sb
operator|->
name|save
argument_list|)
expr_stmt|;
name|failed_save
label|:
name|XDestroyWindow
argument_list|(
name|sb
operator|->
name|button
argument_list|)
expr_stmt|;
name|failed_button
label|:
name|XDestroyWindow
argument_list|(
name|sb
operator|->
name|bar
argument_list|)
expr_stmt|;
name|failed_bar
label|:
name|free
argument_list|(
operator|(
name|char
operator|*
operator|)
name|sb
argument_list|)
expr_stmt|;
return|return
operator|(
name|NULL
operator|)
return|;
block|}
name|sb
operator|->
name|savebits
index|[
name|SAVE_OFF
index|]
operator|=
name|saveoff_bits
expr_stmt|;
name|sb
operator|->
name|savebits
index|[
name|SAVE_ON
index|]
operator|=
name|saveon_bits
expr_stmt|;
name|sb
operator|->
name|buttonbits
index|[
name|BUTTON_UPLINE
operator|/
literal|2
index|]
operator|=
name|upline_bits
expr_stmt|;
name|sb
operator|->
name|buttonbits
index|[
name|BUTTON_DOWNLINE
operator|/
literal|2
index|]
operator|=
name|downline_bits
expr_stmt|;
name|sb
operator|->
name|buttonbits
index|[
name|BUTTON_UPPAGE
operator|/
literal|2
index|]
operator|=
name|uppage_bits
expr_stmt|;
name|sb
operator|->
name|buttonbits
index|[
name|BUTTON_DOWNPAGE
operator|/
literal|2
index|]
operator|=
name|downpage_bits
expr_stmt|;
name|sb
operator|->
name|buttonbits
index|[
name|BUTTON_TOP
operator|/
literal|2
index|]
operator|=
name|top_bits
expr_stmt|;
name|sb
operator|->
name|buttonbits
index|[
name|BUTTON_BOTTOM
operator|/
literal|2
index|]
operator|=
name|bottom_bits
expr_stmt|;
name|sb
operator|->
name|buttonbits
index|[
name|BUTTON_NORMAL
operator|/
literal|2
index|]
operator|=
name|button_bits
expr_stmt|;
name|XDefineCursor
argument_list|(
name|sb
operator|->
name|bar
argument_list|,
name|sb
operator|->
name|cursor
argument_list|)
expr_stmt|;
name|XSelectInput
argument_list|(
name|sb
operator|->
name|bar
argument_list|,
name|ButtonPressed
operator||
name|ButtonReleased
operator||
name|ExposeWindow
operator||
name|EnterWindow
operator||
name|LeaveWindow
operator||
name|UnmapWindow
argument_list|)
expr_stmt|;
name|XSelectInput
argument_list|(
name|sb
operator|->
name|button
argument_list|,
name|EnterWindow
operator||
name|LeaveWindow
argument_list|)
expr_stmt|;
name|XMapWindow
argument_list|(
name|sb
operator|->
name|button
argument_list|)
expr_stmt|;
comment|/* will really map when bar is mapped */
name|XMapWindow
argument_list|(
name|sb
operator|->
name|save
argument_list|)
expr_stmt|;
comment|/* will really map when bar is mapped */
name|sb
operator|->
name|buttonstate
operator|=
name|sb
operator|->
name|buttonset
operator|=
name|BUTTON_NORMAL
expr_stmt|;
name|sb
operator|->
name|savestate
operator|=
name|sb
operator|->
name|saveset
operator|=
name|SAVE_ON
expr_stmt|;
name|sb
operator|->
name|set
operator|.
name|value
operator|=
name|val
expr_stmt|;
name|sb
operator|->
name|set
operator|.
name|regionheight
operator|=
name|valregion
expr_stmt|;
name|sb
operator|->
name|set
operator|.
name|topvalue
operator|=
name|topval
expr_stmt|;
name|sb
operator|->
name|set
operator|.
name|bottomvalue
operator|=
name|botval
expr_stmt|;
name|sb
operator|->
name|set
operator|.
name|height
operator|=
name|height
operator|-
name|BARSTART
expr_stmt|;
return|return
operator|(
name|sb
operator|)
return|;
block|}
end_function

begin_expr_stmt
name|ShowScrollBar
argument_list|(
name|sb
argument_list|)
specifier|register
name|ScrollBar
operator|*
name|sb
expr_stmt|;
end_expr_stmt

begin_block
block|{
if|if
condition|(
name|sb
operator|->
name|visible
condition|)
return|return;
name|sb
operator|->
name|visible
operator|=
literal|1
expr_stmt|;
if|if
condition|(
name|sb
operator|->
name|regionvisible
condition|)
block|{
name|XUnmapWindow
argument_list|(
name|sb
operator|->
name|region
argument_list|)
expr_stmt|;
name|sb
operator|->
name|regionvisible
operator|=
literal|0
expr_stmt|;
block|}
name|XMapWindow
argument_list|(
name|sb
operator|->
name|bar
argument_list|)
expr_stmt|;
name|DrawScrollRegion
argument_list|(
name|sb
argument_list|)
expr_stmt|;
name|sb
operator|->
name|action
operator|=
name|SHOW
expr_stmt|;
block|}
end_block

begin_expr_stmt
name|HideScrollBar
argument_list|(
name|sb
argument_list|)
specifier|register
name|ScrollBar
operator|*
name|sb
expr_stmt|;
end_expr_stmt

begin_block
block|{
if|if
condition|(
operator|!
name|sb
operator|->
name|visible
condition|)
return|return;
name|sb
operator|->
name|visible
operator|=
literal|0
expr_stmt|;
name|XUnmapWindow
argument_list|(
name|sb
operator|->
name|bar
argument_list|)
expr_stmt|;
block|}
end_block

begin_expr_stmt
name|DrawScrollRegion
argument_list|(
name|sb
argument_list|)
specifier|register
name|ScrollBar
operator|*
name|sb
expr_stmt|;
end_expr_stmt

begin_block
block|{
specifier|register
name|int
name|region
decl_stmt|,
name|temp
decl_stmt|;
if|if
condition|(
name|sb
operator|->
name|set
operator|.
name|regionheight
operator|<=
literal|0
condition|)
name|sb
operator|->
name|set
operator|.
name|regionheight
operator|=
literal|0
expr_stmt|;
if|if
condition|(
operator|(
name|region
operator|=
name|sb
operator|->
name|set
operator|.
name|topvalue
operator|-
name|sb
operator|->
name|set
operator|.
name|bottomvalue
operator|)
operator|>=
literal|0
condition|)
block|{
if|if
condition|(
name|sb
operator|->
name|set
operator|.
name|value
operator|>
name|sb
operator|->
name|set
operator|.
name|topvalue
condition|)
name|sb
operator|->
name|set
operator|.
name|value
operator|=
name|sb
operator|->
name|set
operator|.
name|topvalue
expr_stmt|;
elseif|else
if|if
condition|(
name|sb
operator|->
name|set
operator|.
name|value
operator|<
name|sb
operator|->
name|set
operator|.
name|bottomvalue
condition|)
name|sb
operator|->
name|set
operator|.
name|value
operator|=
name|sb
operator|->
name|set
operator|.
name|bottomvalue
expr_stmt|;
block|}
else|else
block|{
name|region
operator|=
operator|-
name|region
expr_stmt|;
if|if
condition|(
name|sb
operator|->
name|set
operator|.
name|value
operator|<
name|sb
operator|->
name|set
operator|.
name|topvalue
condition|)
name|sb
operator|->
name|set
operator|.
name|value
operator|=
name|sb
operator|->
name|set
operator|.
name|topvalue
expr_stmt|;
elseif|else
if|if
condition|(
name|sb
operator|->
name|set
operator|.
name|value
operator|>
name|sb
operator|->
name|set
operator|.
name|bottomvalue
condition|)
name|sb
operator|->
name|set
operator|.
name|value
operator|=
name|sb
operator|->
name|set
operator|.
name|bottomvalue
expr_stmt|;
block|}
if|if
condition|(
name|sb
operator|->
name|set
operator|.
name|value
operator|==
name|sb
operator|->
name|set
operator|.
name|topvalue
condition|)
block|{
name|sb
operator|->
name|set
operator|.
name|pixelheight
operator|=
operator|(
name|region
operator|==
literal|0
operator|)
condition|?
name|sb
operator|->
name|set
operator|.
name|height
else|:
operator|(
name|sb
operator|->
name|set
operator|.
name|height
operator|-
literal|1
operator|)
operator|*
name|sb
operator|->
name|set
operator|.
name|regionheight
operator|/
operator|(
name|sb
operator|->
name|set
operator|.
name|regionheight
operator|+
name|region
operator|)
expr_stmt|;
name|sb
operator|->
name|set
operator|.
name|y
operator|=
name|BARSTART
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|sb
operator|->
name|set
operator|.
name|value
operator|==
name|sb
operator|->
name|set
operator|.
name|bottomvalue
condition|)
block|{
name|sb
operator|->
name|set
operator|.
name|pixelheight
operator|=
operator|(
name|sb
operator|->
name|set
operator|.
name|height
operator|-
literal|1
operator|)
operator|*
name|sb
operator|->
name|set
operator|.
name|regionheight
operator|/
operator|(
name|sb
operator|->
name|set
operator|.
name|regionheight
operator|+
name|region
operator|)
expr_stmt|;
name|sb
operator|->
name|set
operator|.
name|y
operator|=
name|BARSTART
operator|+
name|sb
operator|->
name|set
operator|.
name|height
operator|-
name|sb
operator|->
name|set
operator|.
name|pixelheight
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|sb
operator|->
name|set
operator|.
name|topvalue
operator|>=
name|sb
operator|->
name|set
operator|.
name|bottomvalue
condition|)
block|{
name|temp
operator|=
name|sb
operator|->
name|set
operator|.
name|topvalue
operator|-
literal|1
expr_stmt|;
name|region
operator|=
name|temp
operator|-
operator|(
name|sb
operator|->
name|set
operator|.
name|bottomvalue
operator|+
literal|1
operator|)
expr_stmt|;
name|sb
operator|->
name|set
operator|.
name|y
operator|=
name|temp
operator|-
name|sb
operator|->
name|set
operator|.
name|value
expr_stmt|;
block|}
else|else
block|{
name|temp
operator|=
name|sb
operator|->
name|set
operator|.
name|topvalue
operator|+
literal|1
expr_stmt|;
name|region
operator|=
operator|(
name|sb
operator|->
name|set
operator|.
name|bottomvalue
operator|-
literal|1
operator|)
operator|-
name|temp
expr_stmt|;
name|sb
operator|->
name|set
operator|.
name|y
operator|=
name|sb
operator|->
name|set
operator|.
name|value
operator|-
name|temp
expr_stmt|;
block|}
name|sb
operator|->
name|set
operator|.
name|y
operator|=
operator|(
name|BARSTART
operator|+
literal|1
operator|)
operator|+
name|sb
operator|->
name|set
operator|.
name|y
operator|*
operator|(
name|sb
operator|->
name|set
operator|.
name|height
operator|-
literal|2
operator|)
operator|/
operator|(
name|temp
operator|=
name|sb
operator|->
name|set
operator|.
name|regionheight
operator|+
name|region
operator|)
expr_stmt|;
name|sb
operator|->
name|set
operator|.
name|pixelheight
operator|=
operator|(
name|sb
operator|->
name|set
operator|.
name|height
operator|-
literal|2
operator|)
operator|*
name|sb
operator|->
name|set
operator|.
name|regionheight
operator|/
name|temp
expr_stmt|;
block|}
if|if
condition|(
name|sb
operator|->
name|set
operator|.
name|pixelheight
operator|<=
literal|0
condition|)
name|sb
operator|->
name|set
operator|.
name|pixelheight
operator|=
literal|1
expr_stmt|;
if|if
condition|(
name|sb
operator|->
name|set
operator|.
name|regionheight
operator|==
literal|0
condition|)
block|{
name|sb
operator|->
name|state
operator|=
name|sb
operator|->
name|set
expr_stmt|;
if|if
condition|(
name|sb
operator|->
name|regionvisible
condition|)
block|{
name|XUnmapWindow
argument_list|(
name|sb
operator|->
name|region
argument_list|)
expr_stmt|;
name|sb
operator|->
name|regionvisible
operator|=
literal|0
expr_stmt|;
block|}
return|return;
block|}
if|if
condition|(
operator|!
name|sb
operator|->
name|visible
operator|||
name|sb
operator|->
name|regionvisible
operator|&&
name|sb
operator|->
name|state
operator|.
name|y
operator|==
name|sb
operator|->
name|set
operator|.
name|y
operator|&&
name|sb
operator|->
name|state
operator|.
name|pixelheight
operator|==
name|sb
operator|->
name|set
operator|.
name|pixelheight
condition|)
block|{
name|sb
operator|->
name|state
operator|=
name|sb
operator|->
name|set
expr_stmt|;
return|return;
block|}
name|sb
operator|->
name|state
operator|=
name|sb
operator|->
name|set
expr_stmt|;
name|XConfigureWindow
argument_list|(
name|sb
operator|->
name|region
argument_list|,
literal|0
argument_list|,
name|sb
operator|->
name|state
operator|.
name|y
argument_list|,
operator|(
name|SCROLLBARWIDTH
operator|-
literal|1
operator|)
argument_list|,
name|sb
operator|->
name|state
operator|.
name|pixelheight
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|sb
operator|->
name|regionvisible
condition|)
block|{
name|XMapWindow
argument_list|(
name|sb
operator|->
name|region
argument_list|)
expr_stmt|;
name|sb
operator|->
name|regionvisible
operator|=
literal|1
expr_stmt|;
block|}
block|}
end_block

begin_expr_stmt
name|DrawButton
argument_list|(
name|sb
argument_list|)
specifier|register
name|ScrollBar
operator|*
name|sb
expr_stmt|;
end_expr_stmt

begin_block
block|{
specifier|register
name|int
name|fg
decl_stmt|,
name|bg
decl_stmt|;
if|if
condition|(
name|sb
operator|->
name|visible
operator|&&
name|sb
operator|->
name|buttonstate
operator|!=
name|sb
operator|->
name|buttonset
condition|)
block|{
if|if
condition|(
operator|(
name|sb
operator|->
name|buttonstate
operator|=
name|sb
operator|->
name|buttonset
operator|)
operator|&
name|HILITED
condition|)
block|{
name|fg
operator|=
name|sb
operator|->
name|bg
expr_stmt|;
name|bg
operator|=
name|sb
operator|->
name|fg
expr_stmt|;
block|}
else|else
block|{
name|fg
operator|=
name|sb
operator|->
name|fg
expr_stmt|;
name|bg
operator|=
name|sb
operator|->
name|bg
expr_stmt|;
block|}
name|XBitmapBitsPut
argument_list|(
name|sb
operator|->
name|button
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
name|SCROLLBARWIDTH
operator|-
literal|1
argument_list|,
name|BUTTONHEIGHT
operator|-
literal|1
argument_list|,
name|sb
operator|->
name|buttonbits
index|[
name|sb
operator|->
name|buttonstate
operator|/
literal|2
index|]
argument_list|,
name|fg
argument_list|,
name|bg
argument_list|,
operator|(
name|Bitmap
operator|)
literal|0
argument_list|,
name|GXcopy
argument_list|,
name|AllPlanes
argument_list|)
expr_stmt|;
block|}
block|}
end_block

begin_expr_stmt
name|DrawSave
argument_list|(
name|sb
argument_list|)
specifier|register
name|ScrollBar
operator|*
name|sb
expr_stmt|;
end_expr_stmt

begin_block
block|{
if|if
condition|(
name|sb
operator|->
name|visible
operator|&&
name|sb
operator|->
name|savestate
operator|!=
name|sb
operator|->
name|saveset
condition|)
name|XBitmapBitsPut
argument_list|(
name|sb
operator|->
name|save
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
name|SCROLLBARWIDTH
operator|-
literal|1
argument_list|,
name|BUTTONHEIGHT
operator|-
literal|1
argument_list|,
name|sb
operator|->
name|savebits
index|[
name|sb
operator|->
name|savestate
operator|=
name|sb
operator|->
name|saveset
index|]
argument_list|,
name|sb
operator|->
name|fg
argument_list|,
name|sb
operator|->
name|bg
argument_list|,
operator|(
name|Bitmap
operator|)
literal|0
argument_list|,
name|GXcopy
argument_list|,
name|AllPlanes
argument_list|)
expr_stmt|;
block|}
end_block

begin_expr_stmt
name|ResizeScrollBar
argument_list|(
name|sb
argument_list|,
name|x
argument_list|,
name|y
argument_list|,
name|height
argument_list|,
name|region
argument_list|)
specifier|register
name|ScrollBar
operator|*
name|sb
expr_stmt|;
end_expr_stmt

begin_decl_stmt
name|int
name|x
decl_stmt|,
name|y
decl_stmt|,
name|height
decl_stmt|,
name|region
decl_stmt|;
end_decl_stmt

begin_block
block|{
specifier|register
name|int
name|act
decl_stmt|;
name|act
operator|=
name|sb
operator|->
name|action
expr_stmt|;
name|sb
operator|->
name|action
operator|=
name|NONE
expr_stmt|;
switch|switch
condition|(
name|act
condition|)
block|{
case|case
name|SHOW
case|:
return|return;
case|case
name|HIDE
case|:
name|HideScrollBar
argument_list|(
name|sb
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
operator|!
name|sb
operator|->
name|visible
condition|)
return|return;
if|if
condition|(
name|sb
operator|->
name|regionvisible
condition|)
block|{
name|XUnmapWindow
argument_list|(
name|sb
operator|->
name|region
argument_list|)
expr_stmt|;
name|sb
operator|->
name|regionvisible
operator|=
literal|0
expr_stmt|;
block|}
name|XConfigureWindow
argument_list|(
name|sb
operator|->
name|bar
argument_list|,
name|x
argument_list|,
name|y
argument_list|,
operator|(
name|SCROLLBARWIDTH
operator|-
literal|1
operator|)
argument_list|,
name|height
argument_list|)
expr_stmt|;
name|sb
operator|->
name|set
operator|.
name|height
operator|=
name|height
operator|-
name|BARSTART
expr_stmt|;
name|sb
operator|->
name|set
operator|.
name|regionheight
operator|=
name|region
expr_stmt|;
name|DrawScrollRegion
argument_list|(
name|sb
argument_list|)
expr_stmt|;
block|}
end_block

begin_expr_stmt
name|PositionRegion
argument_list|(
name|sb
argument_list|,
name|y
argument_list|)
specifier|register
name|ScrollBar
operator|*
name|sb
expr_stmt|;
end_expr_stmt

begin_decl_stmt
specifier|register
name|int
name|y
decl_stmt|;
end_decl_stmt

begin_block
block|{
if|if
condition|(
name|y
operator|<=
name|BARSTART
condition|)
name|sb
operator|->
name|set
operator|.
name|value
operator|=
name|sb
operator|->
name|set
operator|.
name|topvalue
expr_stmt|;
elseif|else
if|if
condition|(
name|y
operator|>=
name|BARSTART
operator|+
name|sb
operator|->
name|set
operator|.
name|height
operator|*
operator|(
name|sb
operator|->
name|set
operator|.
name|bottomvalue
operator|-
name|sb
operator|->
name|set
operator|.
name|topvalue
operator|)
operator|/
operator|(
name|sb
operator|->
name|set
operator|.
name|bottomvalue
operator|+
name|sb
operator|->
name|set
operator|.
name|regionheight
operator|-
name|sb
operator|->
name|set
operator|.
name|topvalue
operator|)
condition|)
name|sb
operator|->
name|set
operator|.
name|value
operator|=
name|sb
operator|->
name|set
operator|.
name|bottomvalue
expr_stmt|;
else|else
name|sb
operator|->
name|set
operator|.
name|value
operator|=
name|sb
operator|->
name|set
operator|.
name|topvalue
operator|+
operator|(
name|y
operator|-
name|BARSTART
operator|)
operator|*
operator|(
name|sb
operator|->
name|set
operator|.
name|bottomvalue
operator|+
name|sb
operator|->
name|set
operator|.
name|regionheight
operator|-
name|sb
operator|->
name|set
operator|.
name|topvalue
operator|)
operator|/
name|sb
operator|->
name|set
operator|.
name|height
expr_stmt|;
name|DrawScrollRegion
argument_list|(
name|sb
argument_list|)
expr_stmt|;
return|return
operator|(
name|sb
operator|->
name|state
operator|.
name|value
operator|)
return|;
block|}
end_block

begin_expr_stmt
name|ButtonRegion
argument_list|(
name|sb
argument_list|)
specifier|register
name|ScrollBar
operator|*
name|sb
expr_stmt|;
end_expr_stmt

begin_block
block|{
specifier|register
name|int
name|reverse
decl_stmt|,
name|pagesize
decl_stmt|;
if|if
condition|(
operator|!
operator|(
name|sb
operator|->
name|buttonset
operator|&
name|HILITED
operator|)
condition|)
return|return
operator|(
name|sb
operator|->
name|set
operator|.
name|value
operator|)
return|;
name|reverse
operator|=
operator|(
name|sb
operator|->
name|set
operator|.
name|bottomvalue
operator|>
name|sb
operator|->
name|set
operator|.
name|topvalue
operator|)
expr_stmt|;
name|pagesize
operator|=
name|sb
operator|->
name|set
operator|.
name|regionheight
operator|-
literal|1
expr_stmt|;
switch|switch
condition|(
name|sb
operator|->
name|buttonset
condition|)
block|{
case|case
name|BUTTON_UPLINEHI
case|:
if|if
condition|(
name|reverse
condition|)
name|sb
operator|->
name|set
operator|.
name|value
operator|--
expr_stmt|;
else|else
name|sb
operator|->
name|set
operator|.
name|value
operator|++
expr_stmt|;
break|break;
case|case
name|BUTTON_DOWNLINEHI
case|:
if|if
condition|(
name|reverse
condition|)
name|sb
operator|->
name|set
operator|.
name|value
operator|++
expr_stmt|;
else|else
name|sb
operator|->
name|set
operator|.
name|value
operator|--
expr_stmt|;
break|break;
case|case
name|BUTTON_UPPAGEHI
case|:
if|if
condition|(
name|reverse
condition|)
name|sb
operator|->
name|set
operator|.
name|value
operator|-=
name|pagesize
expr_stmt|;
else|else
name|sb
operator|->
name|set
operator|.
name|value
operator|+=
name|pagesize
expr_stmt|;
break|break;
case|case
name|BUTTON_DOWNPAGEHI
case|:
if|if
condition|(
name|reverse
condition|)
name|sb
operator|->
name|set
operator|.
name|value
operator|+=
name|pagesize
expr_stmt|;
else|else
name|sb
operator|->
name|set
operator|.
name|value
operator|-=
name|pagesize
expr_stmt|;
break|break;
case|case
name|BUTTON_TOPHI
case|:
name|sb
operator|->
name|set
operator|.
name|value
operator|=
name|sb
operator|->
name|set
operator|.
name|topvalue
expr_stmt|;
break|break;
case|case
name|BUTTON_BOTTOMHI
case|:
name|sb
operator|->
name|set
operator|.
name|value
operator|=
name|sb
operator|->
name|set
operator|.
name|bottomvalue
expr_stmt|;
block|}
name|DrawScrollRegion
argument_list|(
name|sb
argument_list|)
expr_stmt|;
return|return
operator|(
name|sb
operator|->
name|set
operator|.
name|value
operator|)
return|;
block|}
end_block

begin_macro
name|DownButtonDown
argument_list|(
argument|term
argument_list|,
argument|reply
argument_list|,
argument|pty
argument_list|)
end_macro

begin_decl_stmt
name|Terminal
modifier|*
name|term
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|register
name|XKeyOrButtonEvent
modifier|*
name|reply
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|pty
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* file descriptor of pty */
end_comment

begin_block
block|{
specifier|register
name|Screen
modifier|*
name|screen
init|=
operator|&
name|term
operator|->
name|screen
decl_stmt|;
specifier|register
name|ScrollBar
modifier|*
name|sb
init|=
name|screen
operator|->
name|sb
decl_stmt|;
specifier|register
name|Window
name|window
init|=
name|reply
operator|->
name|subwindow
decl_stmt|;
if|if
condition|(
operator|!
name|window
operator|||
name|window
operator|==
name|sb
operator|->
name|region
condition|)
block|{
specifier|register
name|int
name|page
init|=
name|sb
operator|->
name|set
operator|.
name|regionheight
decl_stmt|;
specifier|register
name|int
name|height
init|=
name|sb
operator|->
name|set
operator|.
name|height
operator|+
name|BARSTART
decl_stmt|;
if|if
condition|(
name|reply
operator|->
name|detail
operator|&
name|ShiftMask
condition|)
name|sb
operator|->
name|set
operator|.
name|value
operator|+=
name|page
operator|*
operator|(
name|height
operator|-
name|reply
operator|->
name|y
operator|)
operator|/
name|height
expr_stmt|;
else|else
name|sb
operator|->
name|set
operator|.
name|value
operator|+=
name|page
operator|*
name|reply
operator|->
name|y
operator|/
name|height
expr_stmt|;
name|DrawScrollRegion
argument_list|(
name|sb
argument_list|)
expr_stmt|;
name|WindowScroll
argument_list|(
name|screen
argument_list|,
name|sb
operator|->
name|set
operator|.
name|value
argument_list|)
expr_stmt|;
name|sb
operator|->
name|buttonset
operator|=
name|BUTTON_DOWNLINEHI
expr_stmt|;
name|stepspeed
operator|.
name|tv_usec
operator|=
name|PAUSETIME
expr_stmt|;
name|screen
operator|->
name|timeout
operator|=
operator|&
name|stepspeed
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|window
operator|==
name|sb
operator|->
name|save
condition|)
block|{
name|SetSaveState
argument_list|(
name|sb
argument_list|,
operator|!
name|GetSaveState
argument_list|(
name|sb
argument_list|)
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|window
operator|!=
name|sb
operator|->
name|button
condition|)
block|{
name|Bell
argument_list|()
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|reply
operator|->
name|detail
operator|&
name|ControlMask
condition|)
name|sb
operator|->
name|buttonset
operator|=
name|BUTTON_BOTTOMHI
expr_stmt|;
elseif|else
if|if
condition|(
name|reply
operator|->
name|detail
operator|&
name|ShiftMask
condition|)
name|sb
operator|->
name|buttonset
operator|=
name|BUTTON_DOWNPAGEHI
expr_stmt|;
else|else
block|{
name|sb
operator|->
name|buttonset
operator|=
name|BUTTON_DOWNLINEHI
expr_stmt|;
name|stepspeed
operator|.
name|tv_usec
operator|=
name|PAUSETIME
expr_stmt|;
name|screen
operator|->
name|timeout
operator|=
operator|&
name|stepspeed
expr_stmt|;
name|WindowScroll
argument_list|(
name|screen
argument_list|,
name|ButtonRegion
argument_list|(
name|screen
operator|->
name|sb
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|DrawButton
argument_list|(
name|sb
argument_list|)
expr_stmt|;
block|}
end_block

begin_macro
name|UpButtonDown
argument_list|(
argument|term
argument_list|,
argument|reply
argument_list|,
argument|pty
argument_list|)
end_macro

begin_decl_stmt
name|Terminal
modifier|*
name|term
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|register
name|XKeyOrButtonEvent
modifier|*
name|reply
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|pty
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* file descriptor of pty */
end_comment

begin_block
block|{
specifier|register
name|Screen
modifier|*
name|screen
init|=
operator|&
name|term
operator|->
name|screen
decl_stmt|;
specifier|register
name|ScrollBar
modifier|*
name|sb
init|=
name|screen
operator|->
name|sb
decl_stmt|;
specifier|register
name|Window
name|window
init|=
name|reply
operator|->
name|subwindow
decl_stmt|;
if|if
condition|(
name|window
operator|==
name|sb
operator|->
name|save
condition|)
block|{
name|SetSaveState
argument_list|(
name|sb
argument_list|,
operator|!
name|GetSaveState
argument_list|(
name|sb
argument_list|)
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
operator|!
name|window
operator|||
name|window
operator|==
name|sb
operator|->
name|region
condition|)
block|{
specifier|register
name|int
name|page
init|=
name|sb
operator|->
name|set
operator|.
name|regionheight
decl_stmt|;
specifier|register
name|int
name|height
init|=
name|sb
operator|->
name|set
operator|.
name|height
operator|+
name|BARSTART
decl_stmt|;
if|if
condition|(
name|reply
operator|->
name|detail
operator|&
name|ShiftMask
condition|)
name|sb
operator|->
name|set
operator|.
name|value
operator|-=
name|page
operator|*
operator|(
name|height
operator|-
name|reply
operator|->
name|y
operator|)
operator|/
name|height
expr_stmt|;
else|else
name|sb
operator|->
name|set
operator|.
name|value
operator|-=
name|page
operator|*
name|reply
operator|->
name|y
operator|/
name|height
expr_stmt|;
name|DrawScrollRegion
argument_list|(
name|sb
argument_list|)
expr_stmt|;
name|WindowScroll
argument_list|(
name|screen
argument_list|,
name|sb
operator|->
name|set
operator|.
name|value
argument_list|)
expr_stmt|;
name|sb
operator|->
name|buttonset
operator|=
name|BUTTON_UPLINEHI
expr_stmt|;
name|stepspeed
operator|.
name|tv_usec
operator|=
name|PAUSETIME
expr_stmt|;
name|screen
operator|->
name|timeout
operator|=
operator|&
name|stepspeed
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|window
operator|!=
name|sb
operator|->
name|button
condition|)
block|{
name|Bell
argument_list|()
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|reply
operator|->
name|detail
operator|&
name|ControlMask
condition|)
name|sb
operator|->
name|buttonset
operator|=
name|BUTTON_TOPHI
expr_stmt|;
elseif|else
if|if
condition|(
name|reply
operator|->
name|detail
operator|&
name|ShiftMask
condition|)
name|sb
operator|->
name|buttonset
operator|=
name|BUTTON_UPPAGEHI
expr_stmt|;
else|else
block|{
name|sb
operator|->
name|buttonset
operator|=
name|BUTTON_UPLINEHI
expr_stmt|;
name|stepspeed
operator|.
name|tv_usec
operator|=
name|PAUSETIME
expr_stmt|;
name|screen
operator|->
name|timeout
operator|=
operator|&
name|stepspeed
expr_stmt|;
name|WindowScroll
argument_list|(
name|screen
argument_list|,
name|ButtonRegion
argument_list|(
name|screen
operator|->
name|sb
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|DrawButton
argument_list|(
name|sb
argument_list|)
expr_stmt|;
block|}
end_block

begin_macro
name|ButtonUp
argument_list|(
argument|term
argument_list|,
argument|reply
argument_list|,
argument|pty
argument_list|)
end_macro

begin_decl_stmt
name|Terminal
modifier|*
name|term
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|XKeyOrButtonEvent
modifier|*
name|reply
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|pty
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* file descriptor of pty */
end_comment

begin_block
block|{
specifier|register
name|Screen
modifier|*
name|screen
init|=
operator|&
name|term
operator|->
name|screen
decl_stmt|;
specifier|register
name|ScrollBar
modifier|*
name|sb
init|=
name|screen
operator|->
name|sb
decl_stmt|;
specifier|register
name|int
name|state
decl_stmt|;
if|if
condition|(
operator|(
name|state
operator|=
name|GetButtonState
argument_list|(
name|sb
argument_list|)
operator|)
operator|==
name|BUTTON_NORMAL
condition|)
return|return;
comment|/* don't scroll further on line mode */
if|if
condition|(
name|state
operator|>
name|BUTTON_DOWNLINEHI
condition|)
name|WindowScroll
argument_list|(
name|screen
argument_list|,
name|ButtonRegion
argument_list|(
name|sb
argument_list|)
argument_list|)
expr_stmt|;
name|sb
operator|->
name|buttonset
operator|=
name|BUTTON_NORMAL
expr_stmt|;
name|DrawButton
argument_list|(
name|sb
argument_list|)
expr_stmt|;
name|screen
operator|->
name|timeout
operator|=
name|NULL
expr_stmt|;
name|XUngrabMouse
argument_list|()
expr_stmt|;
block|}
end_block

begin_expr_stmt
name|WindowScroll
argument_list|(
name|screen
argument_list|,
name|top
argument_list|)
specifier|register
name|Screen
operator|*
name|screen
expr_stmt|;
end_expr_stmt

begin_decl_stmt
name|int
name|top
decl_stmt|;
end_decl_stmt

begin_block
block|{
specifier|register
name|int
name|i
decl_stmt|,
name|lines
decl_stmt|;
specifier|register
name|int
name|scrolltop
decl_stmt|,
name|scrollheight
decl_stmt|,
name|refreshtop
decl_stmt|;
if|if
condition|(
operator|(
name|i
operator|=
name|screen
operator|->
name|topline
operator|-
name|top
operator|)
operator|==
literal|0
condition|)
return|return;
if|if
condition|(
name|screen
operator|->
name|cursor_state
condition|)
name|HideCursor
argument_list|()
expr_stmt|;
name|lines
operator|=
name|i
operator|>
literal|0
condition|?
name|i
else|:
operator|-
name|i
expr_stmt|;
if|if
condition|(
name|lines
operator|>
name|screen
operator|->
name|max_row
operator|+
literal|1
condition|)
name|lines
operator|=
name|screen
operator|->
name|max_row
operator|+
literal|1
expr_stmt|;
name|scrollheight
operator|=
name|screen
operator|->
name|max_row
operator|-
name|lines
operator|+
literal|1
expr_stmt|;
if|if
condition|(
name|i
operator|>
literal|0
condition|)
name|refreshtop
operator|=
name|scrolltop
operator|=
literal|0
expr_stmt|;
else|else
block|{
name|scrolltop
operator|=
name|lines
expr_stmt|;
name|refreshtop
operator|=
name|scrollheight
expr_stmt|;
block|}
if|if
condition|(
name|scrollheight
operator|>
literal|0
condition|)
block|{
if|if
condition|(
name|screen
operator|->
name|multiscroll
operator|&&
name|scrollheight
operator|==
literal|1
operator|&&
name|screen
operator|->
name|topline
operator|==
literal|0
operator|&&
name|screen
operator|->
name|top_marg
operator|==
literal|0
operator|&&
name|screen
operator|->
name|bot_marg
operator|==
name|screen
operator|->
name|max_row
condition|)
block|{
if|if
condition|(
name|screen
operator|->
name|incopy
operator|<
literal|0
operator|&&
name|screen
operator|->
name|scrolls
operator|==
literal|0
condition|)
name|CopyWait
argument_list|(
name|screen
argument_list|)
expr_stmt|;
name|screen
operator|->
name|scrolls
operator|++
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|screen
operator|->
name|incopy
condition|)
name|CopyWait
argument_list|(
name|screen
argument_list|)
expr_stmt|;
name|screen
operator|->
name|incopy
operator|=
operator|-
literal|1
expr_stmt|;
block|}
name|XMoveArea
argument_list|(
name|VWindow
argument_list|(
name|screen
argument_list|)
argument_list|,
name|screen
operator|->
name|border
argument_list|,
name|scrolltop
operator|*
name|FontHeight
argument_list|(
name|screen
argument_list|)
operator|+
name|screen
operator|->
name|border
operator|+
name|Titlebar
argument_list|(
name|screen
argument_list|)
argument_list|,
name|screen
operator|->
name|border
argument_list|,
operator|(
name|scrolltop
operator|+
name|i
operator|)
operator|*
name|FontHeight
argument_list|(
name|screen
argument_list|)
operator|+
name|screen
operator|->
name|border
operator|+
name|Titlebar
argument_list|(
name|screen
argument_list|)
argument_list|,
name|Width
argument_list|(
name|screen
argument_list|)
argument_list|,
name|scrollheight
operator|*
name|FontHeight
argument_list|(
name|screen
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|screen
operator|->
name|topline
operator|=
name|top
expr_stmt|;
name|XTileSet
argument_list|(
name|VWindow
argument_list|(
name|screen
argument_list|)
argument_list|,
name|screen
operator|->
name|border
argument_list|,
name|refreshtop
operator|*
name|FontHeight
argument_list|(
name|screen
argument_list|)
operator|+
name|screen
operator|->
name|border
operator|+
name|Titlebar
argument_list|(
name|screen
argument_list|)
argument_list|,
name|Width
argument_list|(
name|screen
argument_list|)
argument_list|,
name|lines
operator|*
name|FontHeight
argument_list|(
name|screen
argument_list|)
argument_list|,
name|screen
operator|->
name|bgndtile
argument_list|)
expr_stmt|;
name|ScrnRefresh
argument_list|(
name|screen
argument_list|,
name|refreshtop
argument_list|,
literal|0
argument_list|,
name|lines
argument_list|,
name|screen
operator|->
name|max_col
operator|+
literal|1
argument_list|)
expr_stmt|;
block|}
end_block

begin_expr_stmt
name|ScrollBarOn
argument_list|(
name|screen
argument_list|,
name|show
argument_list|,
name|init
argument_list|)
specifier|register
name|Screen
operator|*
name|screen
expr_stmt|;
end_expr_stmt

begin_decl_stmt
name|int
name|show
decl_stmt|,
name|init
decl_stmt|;
end_decl_stmt

begin_block
block|{
specifier|register
name|int
name|border
init|=
literal|2
operator|*
name|screen
operator|->
name|border
decl_stmt|;
specifier|register
name|int
name|i
decl_stmt|;
name|char
modifier|*
name|realloc
argument_list|()
decl_stmt|,
modifier|*
name|calloc
argument_list|()
decl_stmt|;
if|if
condition|(
name|screen
operator|->
name|scrollbar
condition|)
return|return;
if|if
condition|(
operator|!
name|screen
operator|->
name|sb
condition|)
block|{
if|if
condition|(
operator|(
name|screen
operator|->
name|sb
operator|=
name|CreateScrollBar
argument_list|(
name|VWindow
argument_list|(
name|screen
argument_list|)
argument_list|,
name|Width
argument_list|(
name|screen
argument_list|)
operator|+
name|border
argument_list|,
name|Titlebar
argument_list|(
name|screen
argument_list|)
operator|-
literal|1
argument_list|,
name|Height
argument_list|(
name|screen
argument_list|)
operator|+
name|border
argument_list|,
name|screen
operator|->
name|foreground
argument_list|,
name|screen
operator|->
name|background
argument_list|,
name|screen
operator|->
name|bordertile
argument_list|,
literal|0
argument_list|,
name|screen
operator|->
name|max_row
operator|+
literal|1
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
name|screen
operator|->
name|arrow
argument_list|)
operator|)
operator|==
name|NULL
condition|)
block|{
name|Bell
argument_list|()
expr_stmt|;
return|return;
block|}
if|if
condition|(
operator|(
name|screen
operator|->
name|allbuf
operator|=
operator|(
name|ScrnBuf
operator|)
name|realloc
argument_list|(
name|screen
operator|->
name|buf
argument_list|,
literal|2
operator|*
operator|(
name|screen
operator|->
name|max_row
operator|+
literal|2
operator|+
name|screen
operator|->
name|savelines
operator|)
operator|*
sizeof|sizeof
argument_list|(
name|char
operator|*
argument_list|)
argument_list|)
operator|)
operator|==
name|NULL
condition|)
name|Error
argument_list|(
name|ERROR_SBRALLOC
argument_list|)
expr_stmt|;
name|screen
operator|->
name|buf
operator|=
operator|&
name|screen
operator|->
name|allbuf
index|[
literal|2
operator|*
name|screen
operator|->
name|savelines
index|]
expr_stmt|;
name|bcopy
argument_list|(
operator|(
name|char
operator|*
operator|)
name|screen
operator|->
name|allbuf
argument_list|,
operator|(
name|char
operator|*
operator|)
name|screen
operator|->
name|buf
argument_list|,
literal|2
operator|*
operator|(
name|screen
operator|->
name|max_row
operator|+
literal|2
operator|)
operator|*
sizeof|sizeof
argument_list|(
name|char
operator|*
argument_list|)
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|2
operator|*
name|screen
operator|->
name|savelines
operator|-
literal|1
init|;
name|i
operator|>=
literal|0
condition|;
name|i
operator|--
control|)
if|if
condition|(
operator|(
name|screen
operator|->
name|allbuf
index|[
name|i
index|]
operator|=
name|calloc
argument_list|(
name|screen
operator|->
name|max_col
operator|+
literal|1
argument_list|,
sizeof|sizeof
argument_list|(
name|char
argument_list|)
argument_list|)
operator|)
operator|==
name|NULL
condition|)
name|Error
argument_list|(
name|ERROR_SBRALLOC2
argument_list|)
expr_stmt|;
name|screen
operator|->
name|sb
operator|->
name|saveset
operator|=
operator|!
name|screen
operator|->
name|alternate
expr_stmt|;
block|}
else|else
block|{
name|XConfigureWindow
argument_list|(
name|screen
operator|->
name|sb
operator|->
name|bar
argument_list|,
name|FullWidth
argument_list|(
name|screen
argument_list|)
argument_list|,
name|Titlebar
argument_list|(
name|screen
argument_list|)
operator|-
literal|1
argument_list|,
operator|(
name|SCROLLBARWIDTH
operator|-
literal|1
operator|)
argument_list|,
name|i
operator|=
name|FullHeight
argument_list|(
name|screen
argument_list|)
operator|-
name|Titlebar
argument_list|(
name|screen
argument_list|)
argument_list|)
expr_stmt|;
name|screen
operator|->
name|sb
operator|->
name|set
operator|.
name|height
operator|=
name|i
operator|-
name|BARSTART
expr_stmt|;
name|screen
operator|->
name|sb
operator|->
name|set
operator|.
name|regionheight
operator|=
name|screen
operator|->
name|max_row
operator|+
literal|1
expr_stmt|;
block|}
if|if
condition|(
name|show
condition|)
block|{
name|screen
operator|->
name|scrollbar
operator|=
name|SCROLLBARWIDTH
expr_stmt|;
name|ShowScrollBar
argument_list|(
name|screen
operator|->
name|sb
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|init
condition|)
block|{
name|XSetResizeHint
argument_list|(
name|VWindow
argument_list|(
name|screen
argument_list|)
argument_list|,
name|border
operator|+
name|SCROLLBARWIDTH
argument_list|,
name|border
operator|+
name|Titlebar
argument_list|(
name|screen
argument_list|)
operator|+
name|screen
operator|->
name|statusheight
argument_list|,
name|FontWidth
argument_list|(
name|screen
argument_list|)
argument_list|,
name|FontHeight
argument_list|(
name|screen
argument_list|)
argument_list|)
expr_stmt|;
name|XChangeWindow
argument_list|(
name|VWindow
argument_list|(
name|screen
argument_list|)
argument_list|,
operator|(
name|screen
operator|->
name|max_col
operator|+
literal|1
operator|)
operator|*
name|FontWidth
argument_list|(
name|screen
argument_list|)
operator|+
name|border
operator|+
name|SCROLLBARWIDTH
argument_list|,
name|FontHeight
argument_list|(
name|screen
argument_list|)
operator|*
operator|(
name|screen
operator|->
name|max_row
operator|+
literal|1
operator|)
operator|+
name|screen
operator|->
name|statusheight
operator|+
name|border
operator|+
name|Titlebar
argument_list|(
name|screen
argument_list|)
argument_list|)
expr_stmt|;
block|}
block|}
block|}
end_block

begin_expr_stmt
name|ScrollBarOff
argument_list|(
name|screen
argument_list|)
specifier|register
name|Screen
operator|*
name|screen
expr_stmt|;
end_expr_stmt

begin_block
block|{
specifier|register
name|int
name|border
init|=
literal|2
operator|*
name|screen
operator|->
name|border
decl_stmt|;
if|if
condition|(
operator|!
name|screen
operator|->
name|scrollbar
condition|)
return|return;
name|screen
operator|->
name|sb
operator|->
name|action
operator|=
name|HIDE
expr_stmt|;
name|screen
operator|->
name|scrollbar
operator|=
literal|0
expr_stmt|;
name|XSetResizeHint
argument_list|(
name|VWindow
argument_list|(
name|screen
argument_list|)
argument_list|,
name|border
argument_list|,
name|border
operator|+
name|Titlebar
argument_list|(
name|screen
argument_list|)
operator|+
name|screen
operator|->
name|statusheight
argument_list|,
name|FontWidth
argument_list|(
name|screen
argument_list|)
argument_list|,
name|FontHeight
argument_list|(
name|screen
argument_list|)
argument_list|)
expr_stmt|;
name|XChangeWindow
argument_list|(
name|VWindow
argument_list|(
name|screen
argument_list|)
argument_list|,
operator|(
name|screen
operator|->
name|max_col
operator|+
literal|1
operator|)
operator|*
name|FontWidth
argument_list|(
name|screen
argument_list|)
operator|+
name|border
argument_list|,
name|FontHeight
argument_list|(
name|screen
argument_list|)
operator|*
operator|(
name|screen
operator|->
name|max_row
operator|+
literal|1
operator|)
operator|+
name|screen
operator|->
name|statusheight
operator|+
name|border
operator|+
name|Titlebar
argument_list|(
name|screen
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_block

begin_expr_stmt
name|ClearLinesOffTop
argument_list|(
name|screen
argument_list|)
specifier|register
name|Screen
operator|*
name|screen
expr_stmt|;
end_expr_stmt

begin_block
block|{
if|if
condition|(
operator|!
name|screen
operator|->
name|sb
condition|)
return|return;
if|if
condition|(
name|screen
operator|->
name|topline
condition|)
name|WindowScroll
argument_list|(
name|screen
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|SetScrollBarTop
argument_list|(
name|screen
operator|->
name|sb
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|DrawScrollRegion
argument_list|(
name|screen
operator|->
name|sb
argument_list|)
expr_stmt|;
block|}
end_block

begin_expr_stmt
name|SetSaveState
argument_list|(
name|sb
argument_list|,
name|state
argument_list|)
specifier|register
name|ScrollBar
operator|*
name|sb
expr_stmt|;
end_expr_stmt

begin_decl_stmt
name|int
name|state
decl_stmt|;
end_decl_stmt

begin_block
block|{
specifier|extern
name|Terminal
name|term
decl_stmt|;
specifier|register
name|Screen
modifier|*
name|screen
init|=
operator|&
name|term
operator|.
name|screen
decl_stmt|;
if|if
condition|(
name|screen
operator|->
name|alternate
condition|)
return|return;
if|if
condition|(
name|screen
operator|->
name|scroll_amt
condition|)
name|FlushScroll
argument_list|(
name|screen
argument_list|)
expr_stmt|;
name|sb
operator|->
name|saveset
operator|=
name|state
expr_stmt|;
name|DrawSave
argument_list|(
name|sb
argument_list|)
expr_stmt|;
block|}
end_block

begin_expr_stmt
name|SetButtonState
argument_list|(
name|sb
argument_list|,
name|state
argument_list|)
specifier|register
name|ScrollBar
operator|*
name|sb
expr_stmt|;
end_expr_stmt

begin_decl_stmt
name|int
name|state
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|sb
operator|->
name|buttonset
operator|=
name|state
expr_stmt|;
name|DrawButton
argument_list|(
name|sb
argument_list|)
expr_stmt|;
block|}
end_block

begin_function
specifier|static
name|Window
name|Make_tiled_window
parameter_list|(
name|bitmap_width
parameter_list|,
name|bitmap_height
parameter_list|,
name|bitmap_bits
parameter_list|,
name|foreground
parameter_list|,
name|background
parameter_list|,
name|bgnd
parameter_list|,
name|parent
parameter_list|,
name|x
parameter_list|,
name|y
parameter_list|,
name|width
parameter_list|,
name|height
parameter_list|,
name|borderwidth
parameter_list|,
name|bordertile
parameter_list|)
name|int
name|bitmap_width
decl_stmt|,
name|bitmap_height
decl_stmt|,
name|foreground
decl_stmt|,
name|background
decl_stmt|,
name|x
decl_stmt|,
name|y
decl_stmt|,
name|width
decl_stmt|,
name|height
decl_stmt|,
name|borderwidth
decl_stmt|;
name|short
modifier|*
name|bitmap_bits
decl_stmt|;
name|Window
name|parent
decl_stmt|;
name|Pixmap
modifier|*
name|bgnd
decl_stmt|,
name|bordertile
decl_stmt|;
block|{
specifier|register
name|Pixmap
name|pix
decl_stmt|;
specifier|register
name|Window
name|w
decl_stmt|;
specifier|extern
name|Pixmap
name|Make_tile
parameter_list|()
function_decl|;
if|if
condition|(
operator|(
name|pix
operator|=
name|Make_tile
argument_list|(
name|bitmap_width
argument_list|,
name|bitmap_height
argument_list|,
name|bitmap_bits
argument_list|,
name|foreground
argument_list|,
name|background
argument_list|)
operator|)
operator|==
name|NULL
condition|)
return|return
operator|(
name|NULL
operator|)
return|;
name|w
operator|=
name|XCreateWindow
argument_list|(
name|parent
argument_list|,
name|x
argument_list|,
name|y
argument_list|,
name|width
argument_list|,
name|height
argument_list|,
name|borderwidth
argument_list|,
name|bordertile
argument_list|,
name|pix
argument_list|)
expr_stmt|;
operator|*
name|bgnd
operator|=
name|pix
expr_stmt|;
return|return
operator|(
name|w
operator|)
return|;
block|}
end_function

begin_function
name|Pixmap
name|Make_tile
parameter_list|(
name|bitmap_width
parameter_list|,
name|bitmap_height
parameter_list|,
name|bitmap_bits
parameter_list|,
name|foreground
parameter_list|,
name|background
parameter_list|)
name|int
name|bitmap_width
decl_stmt|,
name|bitmap_height
decl_stmt|,
name|foreground
decl_stmt|,
name|background
decl_stmt|;
name|short
modifier|*
name|bitmap_bits
decl_stmt|;
block|{
specifier|register
name|Bitmap
name|bm
decl_stmt|;
specifier|register
name|Pixmap
name|pix
decl_stmt|;
if|if
condition|(
operator|(
name|bm
operator|=
name|XStoreBitmap
argument_list|(
name|bitmap_width
argument_list|,
name|bitmap_height
argument_list|,
name|bitmap_bits
argument_list|)
operator|)
operator|==
name|NULL
condition|)
return|return
operator|(
name|NULL
operator|)
return|;
name|pix
operator|=
name|XMakePixmap
argument_list|(
name|bm
argument_list|,
name|foreground
argument_list|,
name|background
argument_list|)
expr_stmt|;
name|XFreeBitmap
argument_list|(
name|bm
argument_list|)
expr_stmt|;
return|return
operator|(
name|pix
operator|)
return|;
block|}
end_function

begin_expr_stmt
name|ScrollToBottom
argument_list|(
name|sb
argument_list|)
specifier|register
name|ScrollBar
operator|*
name|sb
expr_stmt|;
end_expr_stmt

begin_block
block|{
name|SetScrollBarValue
argument_list|(
name|sb
argument_list|,
name|GetScrollBarBottom
argument_list|(
name|sb
argument_list|)
argument_list|)
expr_stmt|;
name|DrawScrollRegion
argument_list|(
name|sb
argument_list|)
expr_stmt|;
name|WindowScroll
argument_list|(
operator|&
name|term
operator|.
name|screen
argument_list|,
name|GetScrollBarValue
argument_list|(
name|sb
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_block

begin_ifdef
ifdef|#
directive|ifdef
name|MODEMENU
end_ifdef

begin_define
define|#
directive|define
name|SMENU_SCROLLKEY
value|0
end_define

begin_define
define|#
directive|define
name|SMENU_SCROLLINPUT
value|(SMENU_SCROLLKEY+1)
end_define

begin_define
define|#
directive|define
name|SMENU_LINESTOP
value|(SMENU_SCROLLINPUT+1)
end_define

begin_define
define|#
directive|define
name|SMENU_LINE
value|(SMENU_LINESTOP+1)
end_define

begin_define
define|#
directive|define
name|SMENU_CLEARTOP
value|(SMENU_LINE+1)
end_define

begin_define
define|#
directive|define
name|SMENU_HIDE
value|(SMENU_CLEARTOP+1)
end_define

begin_decl_stmt
specifier|static
name|char
modifier|*
name|stext
index|[]
init|=
block|{
literal|"Scroll to Bottom on Key"
block|,
literal|"Scroll to Bottom on Input"
block|,
literal|"Lines Off Top Saved"
block|,
literal|"-"
block|,
literal|"Clear Lines Off Top"
block|,
literal|"Hide Scrollbar"
block|,
literal|0
block|, }
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|salternate
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|slinestop
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|sscrollinput
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|sscrollkey
decl_stmt|;
end_decl_stmt

begin_function
name|Menu
modifier|*
name|ssetupmenu
parameter_list|(
name|menu
parameter_list|)
specifier|register
name|Menu
modifier|*
modifier|*
name|menu
decl_stmt|;
block|{
specifier|register
name|Screen
modifier|*
name|screen
init|=
operator|&
name|term
operator|.
name|screen
decl_stmt|;
specifier|register
name|char
modifier|*
modifier|*
name|cp
decl_stmt|;
if|if
condition|(
operator|*
name|menu
operator|==
name|NULL
condition|)
block|{
if|if
condition|(
operator|(
operator|*
name|menu
operator|=
name|NewMenu
argument_list|(
literal|"Scrollbar"
argument_list|,
name|re_verse
argument_list|)
operator|)
operator|==
name|NULL
condition|)
return|return
operator|(
name|NULL
operator|)
return|;
for|for
control|(
name|cp
operator|=
name|stext
init|;
operator|*
name|cp
condition|;
name|cp
operator|++
control|)
name|AddMenuItem
argument_list|(
operator|*
name|menu
argument_list|,
operator|*
name|cp
argument_list|)
expr_stmt|;
if|if
condition|(
name|sscrollkey
operator|=
name|screen
operator|->
name|scrollkey
condition|)
name|CheckItem
argument_list|(
operator|*
name|menu
argument_list|,
name|SMENU_SCROLLKEY
argument_list|)
expr_stmt|;
if|if
condition|(
name|sscrollinput
operator|=
name|screen
operator|->
name|scrollinput
condition|)
name|CheckItem
argument_list|(
operator|*
name|menu
argument_list|,
name|SMENU_SCROLLINPUT
argument_list|)
expr_stmt|;
if|if
condition|(
name|slinestop
operator|=
operator|(
name|screen
operator|->
name|sb
operator|&&
name|GetSaveState
argument_list|(
name|screen
operator|->
name|sb
argument_list|)
operator|)
condition|)
name|CheckItem
argument_list|(
operator|*
name|menu
argument_list|,
name|SMENU_LINESTOP
argument_list|)
expr_stmt|;
if|if
condition|(
name|salternate
operator|=
name|screen
operator|->
name|alternate
condition|)
name|DisableItem
argument_list|(
operator|*
name|menu
argument_list|,
name|SMENU_LINESTOP
argument_list|)
expr_stmt|;
name|DisableItem
argument_list|(
operator|*
name|menu
argument_list|,
name|SMENU_LINE
argument_list|)
expr_stmt|;
return|return
operator|(
operator|*
name|menu
operator|)
return|;
block|}
if|if
condition|(
name|sscrollkey
operator|!=
name|screen
operator|->
name|scrollkey
condition|)
name|SetItemCheck
argument_list|(
operator|*
name|menu
argument_list|,
name|SMENU_SCROLLKEY
argument_list|,
operator|(
name|sscrollkey
operator|=
name|screen
operator|->
name|scrollkey
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|sscrollinput
operator|!=
name|screen
operator|->
name|scrollinput
condition|)
name|SetItemCheck
argument_list|(
operator|*
name|menu
argument_list|,
name|SMENU_SCROLLINPUT
argument_list|,
operator|(
name|sscrollinput
operator|=
name|screen
operator|->
name|scrollinput
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|screen
operator|->
name|sb
operator|&&
name|slinestop
operator|!=
name|GetSaveState
argument_list|(
name|screen
operator|->
name|sb
argument_list|)
condition|)
name|SetItemCheck
argument_list|(
operator|*
name|menu
argument_list|,
name|SMENU_LINESTOP
argument_list|,
operator|(
name|slinestop
operator|=
name|GetSaveState
argument_list|(
name|screen
operator|->
name|sb
argument_list|)
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|salternate
operator|!=
name|screen
operator|->
name|alternate
condition|)
name|SetItemDisable
argument_list|(
operator|*
name|menu
argument_list|,
name|SMENU_LINESTOP
argument_list|,
operator|(
name|salternate
operator|=
name|screen
operator|->
name|alternate
operator|)
argument_list|)
expr_stmt|;
return|return
operator|(
operator|*
name|menu
operator|)
return|;
block|}
end_function

begin_macro
name|sdomenufunc
argument_list|(
argument|item
argument_list|)
end_macro

begin_decl_stmt
name|int
name|item
decl_stmt|;
end_decl_stmt

begin_block
block|{
specifier|register
name|Screen
modifier|*
name|screen
init|=
operator|&
name|term
operator|.
name|screen
decl_stmt|;
switch|switch
condition|(
name|item
condition|)
block|{
case|case
name|SMENU_SCROLLKEY
case|:
name|screen
operator|->
name|scrollkey
operator|=
operator|!
name|screen
operator|->
name|scrollkey
expr_stmt|;
break|break;
case|case
name|SMENU_SCROLLINPUT
case|:
name|screen
operator|->
name|scrollinput
operator|=
operator|!
name|screen
operator|->
name|scrollinput
expr_stmt|;
break|break;
case|case
name|SMENU_LINESTOP
case|:
name|SetSaveState
argument_list|(
name|screen
operator|->
name|sb
argument_list|,
operator|!
name|GetSaveState
argument_list|(
name|screen
operator|->
name|sb
argument_list|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|SMENU_CLEARTOP
case|:
name|ClearLinesOffTop
argument_list|(
name|screen
argument_list|)
expr_stmt|;
break|break;
case|case
name|SMENU_HIDE
case|:
name|ScrollBarOff
argument_list|(
name|screen
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
end_block

begin_endif
endif|#
directive|endif
endif|MODEMENU
end_endif

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_include
include|#
directive|include
file|<signal.h>
end_include

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_include
include|#
directive|include
file|<sgtty.h>
end_include

begin_include
include|#
directive|include
file|<sys/wait.h>
end_include

begin_include
include|#
directive|include
file|<sys/time.h>
end_include

begin_define
define|#
directive|define
name|BUFLEN
value|1024
end_define

begin_decl_stmt
name|int
name|got_a_signal
decl_stmt|;
end_decl_stmt

begin_function
name|main
parameter_list|(
name|argc
parameter_list|,
name|argv
parameter_list|)
name|int
name|argc
decl_stmt|;
name|char
modifier|*
name|argv
index|[]
decl_stmt|;
block|{
specifier|extern
name|int
name|tstp_handler
argument_list|()
decl_stmt|,
name|quit_handler
argument_list|()
decl_stmt|,
name|chld_handler
argument_list|()
decl_stmt|,
name|int_handler
argument_list|()
decl_stmt|;
specifier|extern
name|int
name|got_a_signal
decl_stmt|;
name|struct
name|ltchars
name|new_ltc
decl_stmt|,
name|old_ltc
decl_stmt|;
name|struct
name|sigvec
name|vec
decl_stmt|;
name|int
name|topipe
index|[
literal|2
index|]
decl_stmt|,
name|frompipe
index|[
literal|2
index|]
decl_stmt|;
name|int
name|pipeflag
decl_stmt|,
name|nfds
decl_stmt|,
name|from_rogue
decl_stmt|,
name|to_rogue
decl_stmt|,
name|readfds
decl_stmt|;
name|int
name|num
decl_stmt|,
name|rogue_pid
decl_stmt|,
name|old_mask
decl_stmt|;
comment|/* Since this IS a game, reduce our priority. */
name|setpriority
argument_list|(
literal|0
argument_list|,
name|getpid
argument_list|()
argument_list|,
literal|4
argument_list|)
expr_stmt|;
comment|/* Create the pipes that will connect us to rogue. */
if|if
condition|(
name|pipe
argument_list|(
name|topipe
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|printf
argument_list|(
literal|"Couldn't open pipe to rogue\n"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|pipe
argument_list|(
name|frompipe
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|printf
argument_list|(
literal|"Couldn't open pipe to rogue\n"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|rogue_pid
operator|=
name|vfork
argument_list|()
condition|)
block|{
comment|/* Close the ends of the pipes that we don't need, and make better  	   names for the ones we do. */
name|close
argument_list|(
name|topipe
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
name|close
argument_list|(
name|frompipe
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
name|from_rogue
operator|=
name|frompipe
index|[
literal|0
index|]
expr_stmt|;
name|to_rogue
operator|=
name|topipe
index|[
literal|1
index|]
expr_stmt|;
comment|/* Get the old interrupt chars and save them. */
if|if
condition|(
name|ioctl
argument_list|(
literal|0
argument_list|,
name|TIOCGLTC
argument_list|,
operator|&
name|old_ltc
argument_list|)
condition|)
name|printf
argument_list|(
literal|"Couldn't get old_ltc.\n"
argument_list|)
expr_stmt|;
comment|/* Copy the old interrupt chars and make the rest of them  	   correspond to what rogue uses. */
name|new_ltc
operator|=
name|old_ltc
expr_stmt|;
name|new_ltc
operator|.
name|t_dsuspc
operator|=
operator|-
literal|1
expr_stmt|;
if|if
condition|(
name|ioctl
argument_list|(
literal|0
argument_list|,
name|TIOCSLTC
argument_list|,
operator|&
name|new_ltc
argument_list|)
condition|)
name|printf
argument_list|(
literal|"Couldn't remove ^Y.\n"
argument_list|)
expr_stmt|;
comment|/* Install our interrupt handlers */
name|vec
operator|.
name|sv_mask
operator|=
literal|0
expr_stmt|;
name|vec
operator|.
name|sv_onstack
operator|=
literal|0
expr_stmt|;
name|vec
operator|.
name|sv_handler
operator|=
name|tstp_handler
expr_stmt|;
if|if
condition|(
name|sigvec
argument_list|(
name|SIGTSTP
argument_list|,
operator|&
name|vec
argument_list|,
literal|0
argument_list|)
condition|)
name|printf
argument_list|(
literal|"Couldn't install TSTP handler.\n"
argument_list|)
expr_stmt|;
name|vec
operator|.
name|sv_handler
operator|=
name|quit_handler
expr_stmt|;
if|if
condition|(
name|sigvec
argument_list|(
name|SIGQUIT
argument_list|,
operator|&
name|vec
argument_list|,
literal|0
argument_list|)
condition|)
name|printf
argument_list|(
literal|"Couldn't install QUIT handler.\n"
argument_list|)
expr_stmt|;
name|vec
operator|.
name|sv_handler
operator|=
name|int_handler
expr_stmt|;
if|if
condition|(
name|sigvec
argument_list|(
name|SIGINT
argument_list|,
operator|&
name|vec
argument_list|,
literal|0
argument_list|)
condition|)
name|printf
argument_list|(
literal|"Couldn't install INT handler.\n"
argument_list|)
expr_stmt|;
name|vec
operator|.
name|sv_handler
operator|=
name|chld_handler
expr_stmt|;
if|if
condition|(
name|sigvec
argument_list|(
name|SIGCHLD
argument_list|,
operator|&
name|vec
argument_list|,
literal|0
argument_list|)
condition|)
name|printf
argument_list|(
literal|"Couldn't install CHLD handler.\n"
argument_list|)
expr_stmt|;
name|pipeflag
operator|=
literal|1
operator|<<
name|from_rogue
expr_stmt|;
name|nfds
operator|=
name|from_rogue
operator|+
literal|1
expr_stmt|;
while|while
condition|(
literal|1
condition|)
block|{
name|readfds
operator|=
name|pipeflag
operator||
literal|1
expr_stmt|;
name|num
operator|=
name|select
argument_list|(
name|nfds
argument_list|,
operator|&
name|readfds
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|num
operator|>
literal|0
condition|)
if|if
condition|(
name|readfds
operator|&
name|pipeflag
condition|)
name|process_output
argument_list|(
name|from_rogue
argument_list|)
expr_stmt|;
else|else
name|process_input
argument_list|(
name|to_rogue
argument_list|)
expr_stmt|;
if|if
condition|(
name|got_a_signal
condition|)
block|{
name|handle_signal
argument_list|(
name|got_a_signal
argument_list|,
name|rogue_pid
argument_list|,
name|from_rogue
argument_list|,
operator|&
name|old_ltc
argument_list|)
expr_stmt|;
name|got_a_signal
operator|=
literal|0
expr_stmt|;
block|}
block|}
block|}
else|else
block|{
comment|/* We are the child process, so attach our ends of the pipe to stdin 	   and stdout. */
if|if
condition|(
operator|(
name|dup2
argument_list|(
name|topipe
index|[
literal|0
index|]
argument_list|,
literal|0
argument_list|)
operator|)
operator|==
operator|-
literal|1
condition|)
block|{
name|printf
argument_list|(
literal|"couldn't dup2 stdin pipe\n\n"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|dup2
argument_list|(
name|frompipe
index|[
literal|1
index|]
argument_list|,
literal|1
argument_list|)
operator|)
operator|==
operator|-
literal|1
condition|)
block|{
name|printf
argument_list|(
literal|"couldn't dup2 stdout pipe\n\n"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
comment|/* Close the ends of the pipe we don't need. */
name|close
argument_list|(
name|topipe
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
name|close
argument_list|(
name|frompipe
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
comment|/* Do it. */
name|execv
argument_list|(
literal|"/usr/games/rogue"
argument_list|,
name|argv
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Couldn't execv rogue!\n"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_macro
name|handle_signal
argument_list|(
argument|the_signal
argument_list|,
argument|rogue_pid
argument_list|,
argument|from_rogue
argument_list|,
argument|old_ltc
argument_list|)
end_macro

begin_decl_stmt
name|int
name|the_signal
decl_stmt|,
name|rogue_pid
decl_stmt|,
name|from_rogue
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|struct
name|ltchars
modifier|*
name|old_ltc
decl_stmt|;
end_decl_stmt

begin_block
block|{
switch|switch
condition|(
name|the_signal
condition|)
block|{
case|case
name|SIGQUIT
case|:
if|if
condition|(
name|kill
argument_list|(
name|rogue_pid
argument_list|,
name|SIGQUIT
argument_list|)
condition|)
block|{
name|normal_font
argument_list|()
expr_stmt|;
name|printf
argument_list|(
literal|"Couldn't QUIT rogue!\n"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
name|SIGTSTP
case|:
if|if
condition|(
name|kill
argument_list|(
name|rogue_pid
argument_list|,
name|SIGTSTP
argument_list|)
condition|)
block|{
name|normal_font
argument_list|()
expr_stmt|;
name|printf
argument_list|(
literal|"Couldn't TSTP rogue!\n"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
name|SIGINT
case|:
if|if
condition|(
name|kill
argument_list|(
name|rogue_pid
argument_list|,
name|SIGINT
argument_list|)
condition|)
block|{
name|normal_font
argument_list|()
expr_stmt|;
name|printf
argument_list|(
literal|"Couldn't INT rogue!\n"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
name|SIGCHLD
case|:
block|{
name|union
name|wait
name|status
decl_stmt|;
name|int
name|nfds
decl_stmt|,
name|pipeflag
decl_stmt|;
name|int
name|num
decl_stmt|,
name|readfds
decl_stmt|;
name|struct
name|timeval
name|timeout
decl_stmt|;
comment|/* For some reason, our child has stopped.  There is no need 	       (I think) to send it any more characters, so just finish 	       processing its output, and decide how we should stop. */
name|nfds
operator|=
name|from_rogue
operator|+
literal|1
expr_stmt|;
name|pipeflag
operator|=
literal|1
operator|<<
name|from_rogue
expr_stmt|;
name|timeout
operator|.
name|tv_sec
operator|=
literal|0
expr_stmt|;
name|timeout
operator|.
name|tv_usec
operator|=
literal|100000
expr_stmt|;
do|do
block|{
name|readfds
operator|=
name|pipeflag
expr_stmt|;
name|num
operator|=
name|select
argument_list|(
name|nfds
argument_list|,
operator|&
name|readfds
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
operator|&
name|timeout
argument_list|)
expr_stmt|;
if|if
condition|(
name|num
operator|>
literal|0
condition|)
name|num
operator|=
name|process_output
argument_list|(
name|from_rogue
argument_list|)
expr_stmt|;
block|}
do|while
condition|(
name|num
operator|>
literal|0
condition|)
do|;
name|normal_font
argument_list|()
expr_stmt|;
if|if
condition|(
name|wait3
argument_list|(
operator|&
name|status
argument_list|,
name|WNOHANG
operator||
name|WUNTRACED
argument_list|,
literal|0
argument_list|)
operator|>
literal|0
condition|)
block|{
if|if
condition|(
name|WIFSTOPPED
argument_list|(
name|status
argument_list|)
condition|)
block|{
if|if
condition|(
name|kill
argument_list|(
name|getpid
argument_list|()
argument_list|,
name|SIGSTOP
argument_list|)
condition|)
block|{
name|printf
argument_list|(
literal|"Couldn't STOP myself!\n"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|kill
argument_list|(
name|rogue_pid
argument_list|,
name|SIGCONT
argument_list|)
condition|)
block|{
name|printf
argument_list|(
literal|"Couldn't CONT rogue!\n"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
block|}
elseif|else
if|if
condition|(
name|WIFEXITED
argument_list|(
name|status
argument_list|)
condition|)
block|{
name|ioctl
argument_list|(
literal|0
argument_list|,
name|TIOCSLTC
argument_list|,
name|old_ltc
argument_list|)
expr_stmt|;
name|exit
argument_list|(
name|status
operator|.
name|w_retcode
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|WIFSIGNALED
argument_list|(
name|status
argument_list|)
condition|)
block|{
name|ioctl
argument_list|(
literal|0
argument_list|,
name|TIOCSLTC
argument_list|,
name|old_ltc
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Rogue terminated.\n"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"termsig: %d\n"
argument_list|,
name|status
operator|.
name|w_termsig
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"coredump: %d\n"
argument_list|,
name|status
operator|.
name|w_coredump
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"retcode: %d\n"
argument_list|,
name|status
operator|.
name|w_retcode
argument_list|)
expr_stmt|;
name|exit
argument_list|(
operator|-
literal|1
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|ioctl
argument_list|(
literal|0
argument_list|,
name|TIOCSLTC
argument_list|,
name|old_ltc
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Rogue's status is bizzare!\n"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
block|}
block|}
break|break;
default|default:
break|break;
block|}
block|}
end_block

begin_macro
name|quit_handler
argument_list|()
end_macro

begin_block
block|{
specifier|extern
name|int
name|got_a_signal
decl_stmt|;
name|got_a_signal
operator|=
name|SIGQUIT
expr_stmt|;
block|}
end_block

begin_macro
name|tstp_handler
argument_list|()
end_macro

begin_block
block|{
specifier|extern
name|int
name|got_a_signal
decl_stmt|;
name|got_a_signal
operator|=
name|SIGTSTP
expr_stmt|;
block|}
end_block

begin_macro
name|int_handler
argument_list|()
end_macro

begin_block
block|{
specifier|extern
name|int
name|got_a_signal
decl_stmt|;
name|got_a_signal
operator|=
name|SIGINT
expr_stmt|;
block|}
end_block

begin_macro
name|chld_handler
argument_list|()
end_macro

begin_block
block|{
specifier|extern
name|int
name|got_a_signal
decl_stmt|;
name|got_a_signal
operator|=
name|SIGCHLD
expr_stmt|;
block|}
end_block

begin_macro
name|normal_font
argument_list|()
end_macro

begin_block
block|{
name|write
argument_list|(
literal|1
argument_list|,
literal|"
literal|[m"
argument_list|,
literal|3
argument_list|)
expr_stmt|;
block|}
end_block

begin_macro
name|special_font
argument_list|()
end_macro

begin_block
block|{
name|write
argument_list|(
literal|1
argument_list|,
literal|"
literal|[4m"
argument_list|,
literal|4
argument_list|)
expr_stmt|;
block|}
end_block

begin_function
name|int
name|process_input
parameter_list|(
name|to_rogue
parameter_list|)
name|int
name|to_rogue
decl_stmt|;
block|{
specifier|static
name|char
name|buf
index|[
name|BUFLEN
index|]
decl_stmt|;
specifier|register
name|int
name|num
decl_stmt|,
name|old_mask
decl_stmt|;
name|old_mask
operator|=
name|sigblock
argument_list|(
literal|1
operator|<<
operator|(
name|SIGCHLD
operator|-
literal|1
operator|)
argument_list|)
expr_stmt|;
name|num
operator|=
name|read
argument_list|(
literal|0
argument_list|,
name|buf
argument_list|,
name|BUFLEN
argument_list|)
expr_stmt|;
if|if
condition|(
name|num
operator|<=
literal|0
condition|)
block|{
name|printf
argument_list|(
literal|"Error reading keyboard!\n"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
name|write
argument_list|(
name|to_rogue
argument_list|,
name|buf
argument_list|,
name|num
argument_list|)
expr_stmt|;
name|sigsetmask
argument_list|(
name|old_mask
argument_list|)
expr_stmt|;
return|return
operator|(
name|num
operator|)
return|;
block|}
end_function

begin_function
name|int
name|process_output
parameter_list|(
name|from_rogue
parameter_list|)
name|int
name|from_rogue
decl_stmt|;
block|{
specifier|static
name|char
name|buf
index|[
name|BUFLEN
index|]
decl_stmt|;
specifier|static
name|int
name|state
init|=
literal|0
decl_stmt|;
specifier|static
name|int
name|linenum
init|=
literal|1
decl_stmt|;
specifier|static
name|int
name|special
init|=
literal|0
decl_stmt|;
specifier|static
name|int
name|force
init|=
literal|0
decl_stmt|;
specifier|static
name|int
name|accum
init|=
literal|0
decl_stmt|;
name|int
name|chr
decl_stmt|,
name|i
decl_stmt|,
name|start
decl_stmt|,
name|num
decl_stmt|,
name|something_changed
decl_stmt|,
name|old_mask
decl_stmt|;
name|old_mask
operator|=
name|sigblock
argument_list|(
literal|1
operator|<<
operator|(
name|SIGCHLD
operator|-
literal|1
operator|)
argument_list|)
expr_stmt|;
name|num
operator|=
name|read
argument_list|(
name|from_rogue
argument_list|,
name|buf
argument_list|,
name|BUFLEN
argument_list|)
expr_stmt|;
if|if
condition|(
name|num
operator|<=
literal|0
condition|)
block|{
name|sigsetmask
argument_list|(
name|old_mask
argument_list|)
expr_stmt|;
return|return
operator|(
name|num
operator|)
return|;
block|}
name|start
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|num
condition|;
name|i
operator|++
control|)
block|{
name|chr
operator|=
name|buf
index|[
name|i
index|]
expr_stmt|;
switch|switch
condition|(
name|state
condition|)
block|{
case|case
literal|0
case|:
comment|/* State 0 is the normal idle state. */
switch|switch
condition|(
name|chr
condition|)
block|{
case|case
literal|'
literal|'
case|:
name|state
operator|=
literal|1
expr_stmt|;
break|break;
case|case
literal|'\n'
case|:
name|linenum
operator|++
expr_stmt|;
name|something_changed
operator|=
literal|1
expr_stmt|;
break|break;
case|case
literal|'a'
case|:
case|case
literal|'b'
case|:
case|case
literal|'c'
case|:
case|case
literal|'d'
case|:
comment|/* e is left out on purpose */
case|case
literal|'f'
case|:
case|case
literal|'g'
case|:
case|case
literal|'h'
case|:
case|case
literal|'i'
case|:
case|case
literal|'j'
case|:
case|case
literal|'k'
case|:
case|case
literal|'l'
case|:
case|case
literal|'m'
case|:
case|case
literal|'n'
case|:
case|case
literal|'o'
case|:
case|case
literal|'p'
case|:
case|case
literal|'q'
case|:
case|case
literal|'r'
case|:
case|case
literal|'s'
case|:
case|case
literal|'t'
case|:
case|case
literal|'u'
case|:
case|case
literal|'v'
case|:
case|case
literal|'w'
case|:
case|case
literal|'x'
case|:
case|case
literal|'y'
case|:
case|case
literal|'z'
case|:
if|if
condition|(
operator|(
name|linenum
operator|>
literal|1
operator|)
operator|&&
operator|(
name|linenum
operator|<
literal|24
operator|)
operator|&&
operator|(
operator|!
name|force
operator|)
condition|)
block|{
name|force
operator|=
literal|1
expr_stmt|;
name|something_changed
operator|=
literal|1
expr_stmt|;
block|}
break|break;
case|case
literal|'e'
case|:
if|if
condition|(
name|force
condition|)
block|{
name|state
operator|=
literal|5
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|linenum
operator|>
literal|1
operator|)
operator|&&
operator|(
name|linenum
operator|<
literal|24
operator|)
operator|&&
operator|(
operator|!
name|force
operator|)
condition|)
block|{
name|state
operator|=
literal|5
expr_stmt|;
name|force
operator|=
literal|1
expr_stmt|;
name|something_changed
operator|=
literal|1
expr_stmt|;
block|}
break|break;
default|default:
break|break;
block|}
break|break;
case|case
literal|1
case|:
comment|/* We've begun an escape sequence. */
switch|switch
condition|(
name|chr
condition|)
block|{
case|case
literal|'['
case|:
name|state
operator|=
literal|2
expr_stmt|;
break|break;
default|default:
name|state
operator|=
literal|0
expr_stmt|;
break|break;
block|}
break|break;
case|case
literal|2
case|:
comment|/* We've seen "<esc>[" */
switch|switch
condition|(
name|chr
condition|)
block|{
case|case
literal|'0'
case|:
case|case
literal|'1'
case|:
case|case
literal|'2'
case|:
case|case
literal|'3'
case|:
case|case
literal|'4'
case|:
case|case
literal|'5'
case|:
case|case
literal|'6'
case|:
case|case
literal|'7'
case|:
case|case
literal|'8'
case|:
case|case
literal|'9'
case|:
name|state
operator|=
literal|3
expr_stmt|;
name|accum
operator|=
name|chr
operator|-
literal|'0'
expr_stmt|;
break|break;
case|case
literal|';'
case|:
name|state
operator|=
literal|4
expr_stmt|;
name|accum
operator|=
literal|1
expr_stmt|;
break|break;
case|case
literal|'A'
case|:
name|state
operator|=
literal|0
expr_stmt|;
name|linenum
operator|--
expr_stmt|;
name|something_changed
operator|=
literal|1
expr_stmt|;
break|break;
case|case
literal|'H'
case|:
name|state
operator|=
literal|0
expr_stmt|;
name|linenum
operator|=
literal|1
expr_stmt|;
name|something_changed
operator|=
literal|1
expr_stmt|;
break|break;
case|case
literal|'m'
case|:
comment|/* We've seen "<esc>[m" 	           Rogue is trying to get out of reverse video. */
name|state
operator|=
literal|0
expr_stmt|;
break|break;
default|default:
name|state
operator|=
literal|0
expr_stmt|;
break|break;
block|}
break|break;
case|case
literal|3
case|:
comment|/* We've seen "<esc>[n" 	   Continue parsing the argument. */
switch|switch
condition|(
name|chr
condition|)
block|{
case|case
literal|'0'
case|:
case|case
literal|'1'
case|:
case|case
literal|'2'
case|:
case|case
literal|'3'
case|:
case|case
literal|'4'
case|:
case|case
literal|'5'
case|:
case|case
literal|'6'
case|:
case|case
literal|'7'
case|:
case|case
literal|'8'
case|:
case|case
literal|'9'
case|:
name|accum
operator|=
operator|(
literal|10
operator|*
name|accum
operator|)
operator|+
name|chr
operator|-
literal|'0'
expr_stmt|;
break|break;
case|case
literal|';'
case|:
name|state
operator|=
literal|4
expr_stmt|;
break|break;
case|case
literal|'m'
case|:
comment|/* Rogue is trying to use reverse video or something. */
name|state
operator|=
literal|0
expr_stmt|;
break|break;
default|default:
name|state
operator|=
literal|0
expr_stmt|;
break|break;
block|}
break|break;
case|case
literal|4
case|:
comment|/* We've seen "<esc>[nn;" 	   Ignore the rest of the digits until the magic H completes the 	   sequence. */
switch|switch
condition|(
name|chr
condition|)
block|{
case|case
literal|'H'
case|:
name|state
operator|=
literal|0
expr_stmt|;
name|linenum
operator|=
name|accum
expr_stmt|;
name|something_changed
operator|=
literal|1
expr_stmt|;
break|break;
case|case
literal|'0'
case|:
case|case
literal|'1'
case|:
case|case
literal|'2'
case|:
case|case
literal|'3'
case|:
case|case
literal|'4'
case|:
case|case
literal|'5'
case|:
case|case
literal|'6'
case|:
case|case
literal|'7'
case|:
case|case
literal|'8'
case|:
case|case
literal|'9'
case|:
break|break;
default|default:
name|state
operator|=
literal|0
expr_stmt|;
break|break;
block|}
break|break;
case|case
literal|5
case|:
comment|/* We've seen an "e" on lines 2-23.   This means that we're in            an inventory or something.  We're hoping for "e--", the end of 	   "--more--" or "--Press space to continue--". */
switch|switch
condition|(
name|chr
condition|)
block|{
case|case
literal|'-'
case|:
name|state
operator|=
literal|6
expr_stmt|;
break|break;
case|case
literal|'
literal|'
case|:
name|state
operator|=
literal|1
expr_stmt|;
break|break;
case|case
literal|'\n'
case|:
name|state
operator|=
literal|0
expr_stmt|;
name|linenum
operator|++
expr_stmt|;
name|something_changed
operator|=
literal|1
expr_stmt|;
break|break;
default|default:
break|break;
block|}
break|break;
case|case
literal|6
case|:
comment|/* We've seen "e-".  If we see another "-" we can stop forcing. */
switch|switch
condition|(
name|chr
condition|)
block|{
case|case
literal|'-'
case|:
name|state
operator|=
literal|0
expr_stmt|;
name|force
operator|=
literal|0
expr_stmt|;
name|something_changed
operator|=
literal|1
expr_stmt|;
break|break;
case|case
literal|'
literal|'
case|:
name|state
operator|=
literal|1
expr_stmt|;
break|break;
case|case
literal|'\n'
case|:
name|state
operator|=
literal|0
expr_stmt|;
name|linenum
operator|++
expr_stmt|;
name|something_changed
operator|=
literal|1
expr_stmt|;
break|break;
default|default:
break|break;
block|}
break|break;
default|default:
break|break;
block|}
if|if
condition|(
name|something_changed
condition|)
block|{
name|something_changed
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|force
condition|)
block|{
comment|/* Since we're just starting for force, force before outputting 		   the character just looked at. */
if|if
condition|(
name|special
condition|)
block|{
name|write
argument_list|(
literal|1
argument_list|,
name|buf
operator|+
name|start
argument_list|,
name|i
operator|-
name|start
argument_list|)
expr_stmt|;
name|normal_font
argument_list|()
expr_stmt|;
name|start
operator|=
name|i
expr_stmt|;
name|special
operator|=
literal|0
expr_stmt|;
block|}
block|}
elseif|else
if|if
condition|(
operator|(
name|linenum
operator|==
literal|1
operator|)
operator|||
operator|(
name|linenum
operator|>=
literal|24
operator|)
condition|)
block|{
if|if
condition|(
name|special
condition|)
block|{
name|write
argument_list|(
literal|1
argument_list|,
name|buf
operator|+
name|start
argument_list|,
name|i
operator|-
name|start
operator|+
literal|1
argument_list|)
expr_stmt|;
name|normal_font
argument_list|()
expr_stmt|;
name|start
operator|=
name|i
operator|+
literal|1
expr_stmt|;
name|special
operator|=
literal|0
expr_stmt|;
block|}
block|}
else|else
block|{
if|if
condition|(
operator|!
name|special
condition|)
block|{
name|write
argument_list|(
literal|1
argument_list|,
name|buf
operator|+
name|start
argument_list|,
name|i
operator|-
name|start
operator|+
literal|1
argument_list|)
expr_stmt|;
name|special_font
argument_list|()
expr_stmt|;
name|start
operator|=
name|i
operator|+
literal|1
expr_stmt|;
name|special
operator|=
literal|1
expr_stmt|;
block|}
block|}
block|}
block|}
comment|/* Output any characters remaining in the buffer. */
if|if
condition|(
name|i
operator|!=
name|start
condition|)
name|write
argument_list|(
literal|1
argument_list|,
name|buf
operator|+
name|start
argument_list|,
name|i
operator|-
name|start
argument_list|)
expr_stmt|;
name|sigsetmask
argument_list|(
name|old_mask
argument_list|)
expr_stmt|;
return|return
operator|(
name|num
operator|)
return|;
block|}
end_function

end_unit


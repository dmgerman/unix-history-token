begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/* $Header: cursor.c,v 10.3 86/02/01 15:46:34 tony Rel $ */
end_comment

begin_comment
comment|/* cursor.c	various stuff with the mouse& cursor  *  *	StoreCursor		Creates a cursor  *	FreeCursor		Frees the storage taken by a cursor  *	LoadCursor		Loads a bitmap to use as cursor  *	InitMouse		Initialize the mouse  *	SetCursorPosition	Forces cursor to a particular position  *	SetMouseCharacteristics	Controls speed of cursor relative to mouse  *  */
end_comment

begin_comment
comment|/****************************************************************************  *									    *  *  Copyright (c) 1983, 1984 by						    *  *  DIGITAL EQUIPMENT CORPORATION, Maynard, Massachusetts.		    *  *  All rights reserved.						    *  * 									    *  *  This software is furnished on an as-is basis and may be used and copied *  *  only with inclusion of the above copyright notice. This software or any *  *  other copies thereof may be provided or otherwise made available to     *  *  others only for non-commercial purposes.  No title to or ownership of   *  *  the software is hereby transferred.					    *  * 									    *  *  The information in this software is  subject to change without notice   *  *  and  should  not  be  construed as  a commitment by DIGITAL EQUIPMENT   *  *  CORPORATION.							    *  * 									    *  *  DIGITAL assumes no responsibility for the use  or  reliability of its   *  *  software on equipment which is not supplied by DIGITAL.		    *  * 									    *  *									    *  ****************************************************************************/
end_comment

begin_include
include|#
directive|include
file|"vs100.h"
end_include

begin_include
include|#
directive|include
file|"vsioctl.h"
end_include

begin_decl_stmt
specifier|extern
name|vsIoAddr
modifier|*
name|VSAddr
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|extern
name|BitMap
name|screen
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|extern
name|char
name|FBMap
index|[]
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|char
modifier|*
name|Xalloc
argument_list|()
decl_stmt|,
modifier|*
name|AllocateSpace
argument_list|()
decl_stmt|;
end_decl_stmt

begin_function
name|CURSOR
modifier|*
name|StoreCursor
parameter_list|(
name|func
parameter_list|,
name|image
parameter_list|,
name|fore
parameter_list|,
name|back
parameter_list|,
name|mask
parameter_list|,
name|xoff
parameter_list|,
name|yoff
parameter_list|)
specifier|register
name|BITMAP
modifier|*
name|image
decl_stmt|,
decl|*
name|mask
decl_stmt|;
end_function

begin_decl_stmt
name|int
name|func
decl_stmt|,
name|fore
decl_stmt|,
name|back
decl_stmt|,
name|xoff
decl_stmt|,
name|yoff
decl_stmt|;
end_decl_stmt

begin_block
block|{
specifier|register
name|CURSOR
modifier|*
name|cursor
decl_stmt|;
specifier|register
name|CursPriv
modifier|*
name|data
decl_stmt|;
name|cursor
operator|=
operator|(
name|CURSOR
operator|*
operator|)
name|Xalloc
argument_list|(
sizeof|sizeof
argument_list|(
name|CURSOR
argument_list|)
argument_list|)
expr_stmt|;
name|cursor
operator|->
name|width
operator|=
name|image
operator|->
name|width
expr_stmt|;
name|cursor
operator|->
name|height
operator|=
name|image
operator|->
name|height
expr_stmt|;
name|cursor
operator|->
name|xoff
operator|=
name|xoff
expr_stmt|;
name|cursor
operator|->
name|yoff
operator|=
name|yoff
expr_stmt|;
name|cursor
operator|->
name|xmin
operator|=
name|xoff
expr_stmt|;
name|cursor
operator|->
name|ymin
operator|=
name|yoff
expr_stmt|;
name|cursor
operator|->
name|xmax
operator|=
name|screen
operator|.
name|bm_width
operator|-
operator|(
name|image
operator|->
name|width
operator|-
name|xoff
operator|)
expr_stmt|;
name|cursor
operator|->
name|ymax
operator|=
name|screen
operator|.
name|bm_height
operator|-
operator|(
name|image
operator|->
name|height
operator|-
name|yoff
operator|)
expr_stmt|;
name|cursor
operator|->
name|refcnt
operator|=
literal|1
expr_stmt|;
name|data
operator|=
operator|(
name|CursPriv
operator|*
operator|)
name|Xalloc
argument_list|(
sizeof|sizeof
argument_list|(
name|CursPriv
argument_list|)
argument_list|)
expr_stmt|;
name|data
operator|->
name|image
operator|=
name|image
expr_stmt|;
name|image
operator|->
name|refcnt
operator|++
expr_stmt|;
if|if
condition|(
name|data
operator|->
name|mask
operator|=
name|mask
condition|)
name|mask
operator|->
name|refcnt
operator|++
expr_stmt|;
if|if
condition|(
name|fore
operator|&
literal|1
condition|)
name|func
operator|+=
literal|0x20
expr_stmt|;
if|if
condition|(
name|back
operator|&
literal|1
condition|)
name|func
operator|+=
literal|0x10
expr_stmt|;
name|data
operator|->
name|map
operator|=
name|FBMap
index|[
name|func
index|]
expr_stmt|;
name|cursor
operator|->
name|data
operator|=
operator|(
name|caddr_t
operator|)
name|data
expr_stmt|;
return|return
operator|(
name|cursor
operator|)
return|;
block|}
end_block

begin_expr_stmt
name|FreeCursor
argument_list|(
name|cursor
argument_list|)
specifier|register
name|CURSOR
operator|*
name|cursor
expr_stmt|;
end_expr_stmt

begin_block
block|{
specifier|register
name|CursPriv
modifier|*
name|data
decl_stmt|;
specifier|register
name|BITMAP
modifier|*
name|bm
decl_stmt|;
name|data
operator|=
name|CDATA
argument_list|(
name|cursor
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|bm
operator|=
name|data
operator|->
name|image
operator|)
operator|&&
operator|--
name|bm
operator|->
name|refcnt
operator|==
literal|0
condition|)
name|FreeBitmap
argument_list|(
name|bm
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|bm
operator|=
name|data
operator|->
name|mask
operator|)
operator|&&
operator|--
name|bm
operator|->
name|refcnt
operator|==
literal|0
condition|)
name|FreeBitmap
argument_list|(
name|bm
argument_list|)
expr_stmt|;
name|free
argument_list|(
operator|(
name|caddr_t
operator|)
name|cursor
argument_list|)
expr_stmt|;
block|}
end_block

begin_expr_stmt
name|LoadCursor
argument_list|(
name|cursor
argument_list|)
specifier|register
name|CURSOR
operator|*
name|cursor
expr_stmt|;
end_expr_stmt

begin_block
block|{
specifier|register
name|CursPriv
modifier|*
name|data
decl_stmt|;
specifier|register
name|BITMAP
modifier|*
name|bm
decl_stmt|;
specifier|register
name|LoadCursorPacket
modifier|*
name|lcp
decl_stmt|;
name|lcp
operator|=
operator|(
name|LoadCursorPacket
operator|*
operator|)
name|AllocateSpace
argument_list|(
sizeof|sizeof
argument_list|(
name|LoadCursorPacket
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|lcp
operator|==
name|NULL
condition|)
return|return;
define|#
directive|define
name|h
value|((PacketHeader *) lcp->lcp_head)
define|#
directive|define
name|src
value|((SubBitmap *) lcp->lcp_source.image)
define|#
directive|define
name|msk
value|((SubBitmap *) lcp->lcp_sourceMask)
define|#
directive|define
name|pat
value|((Halftone *) lcp->lcp_source.pattern)
define|#
directive|define
name|size
value|((Extent *) lcp->lcp_maskSize)
name|data
operator|=
name|CDATA
argument_list|(
name|cursor
argument_list|)
expr_stmt|;
name|h
operator|->
name|ph_cursorMod
operator|.
name|m_source
operator|=
literal|1
expr_stmt|;
name|h
operator|->
name|ph_cursorMod
operator|.
name|m_map
operator|=
name|MAPTYPE
argument_list|(
name|data
operator|->
name|map
argument_list|)
expr_stmt|;
name|h
operator|->
name|ph_opcode
operator|=
name|LOAD_CURSOR
expr_stmt|;
operator|*
operator|(
name|long
operator|*
operator|)
name|h
operator|->
name|ph_next
operator|=
name|NULL
expr_stmt|;
name|bm
operator|=
name|data
operator|->
name|image
expr_stmt|;
operator|*
operator|(
name|caddr_t
operator|*
operator|)
name|src
operator|->
name|sb_address
operator|=
name|BDATA
argument_list|(
name|bm
argument_list|)
operator|->
name|vsPtr
expr_stmt|;
name|src
operator|->
name|sb_height
operator|=
name|bm
operator|->
name|height
expr_stmt|;
name|src
operator|->
name|sb_width
operator|=
name|bm
operator|->
name|width
expr_stmt|;
name|src
operator|->
name|sb_bitsPerPixel
operator|=
literal|1
expr_stmt|;
name|src
operator|->
name|sb_x
operator|=
name|src
operator|->
name|sb_y
operator|=
literal|0
expr_stmt|;
name|size
operator|->
name|e_height
operator|=
name|bm
operator|->
name|height
expr_stmt|;
name|size
operator|->
name|e_width
operator|=
name|bm
operator|->
name|width
expr_stmt|;
if|if
condition|(
name|bm
operator|=
name|data
operator|->
name|mask
condition|)
block|{
name|h
operator|->
name|ph_cursorMod
operator|.
name|m_mask
operator|=
literal|1
expr_stmt|;
operator|*
operator|(
name|caddr_t
operator|*
operator|)
name|msk
operator|->
name|sb_address
operator|=
name|BDATA
argument_list|(
name|bm
argument_list|)
operator|->
name|vsPtr
expr_stmt|;
name|msk
operator|->
name|sb_height
operator|=
name|bm
operator|->
name|height
expr_stmt|;
name|msk
operator|->
name|sb_width
operator|=
name|bm
operator|->
name|width
expr_stmt|;
name|msk
operator|->
name|sb_bitsPerPixel
operator|=
literal|1
expr_stmt|;
name|msk
operator|->
name|sb_x
operator|=
name|msk
operator|->
name|sb_y
operator|=
literal|0
expr_stmt|;
block|}
else|else
name|h
operator|->
name|ph_cursorMod
operator|.
name|m_mask
operator|=
literal|0
expr_stmt|;
operator|*
operator|(
name|short
operator|*
operator|)
name|lcp
operator|->
name|lcp_map
operator|.
name|literal
operator|=
name|MAPLIT
argument_list|(
name|data
operator|->
name|map
argument_list|)
expr_stmt|;
name|lcp
operator|->
name|lcp_blink
operator|=
literal|0
expr_stmt|;
name|lcp
operator|->
name|lcp_tip_x
operator|=
name|cursor
operator|->
name|xoff
expr_stmt|;
name|lcp
operator|->
name|lcp_tip_y
operator|=
name|cursor
operator|->
name|yoff
expr_stmt|;
name|lcp
operator|->
name|lcp_center_x
operator|=
name|cursor
operator|->
name|xoff
expr_stmt|;
name|lcp
operator|->
name|lcp_center_y
operator|=
name|cursor
operator|->
name|yoff
expr_stmt|;
name|WritePacket
argument_list|(
operator|(
name|caddr_t
operator|)
name|lcp
argument_list|)
expr_stmt|;
undef|#
directive|undef
name|h
undef|#
directive|undef
name|src
undef|#
directive|undef
name|msk
undef|#
directive|undef
name|pat
undef|#
directive|undef
name|size
block|}
end_block

begin_macro
name|InitMouse
argument_list|()
end_macro

begin_block
block|{
specifier|register
name|AttachCursorPacket
modifier|*
name|acp
decl_stmt|;
specifier|register
name|SetPointingDeviceReportingPacket
modifier|*
name|spdp
decl_stmt|;
name|acp
operator|=
operator|(
name|AttachCursorPacket
operator|*
operator|)
name|AllocateSpace
argument_list|(
sizeof|sizeof
argument_list|(
name|AttachCursorPacket
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|acp
operator|==
name|NULL
condition|)
return|return;
define|#
directive|define
name|h
value|((PacketHeader *) acp->acp_head)
name|h
operator|->
name|ph_modifier
operator|.
name|emptymod
operator|=
literal|0
expr_stmt|;
name|h
operator|->
name|ph_opcode
operator|=
name|ATTACH_CURSOR
expr_stmt|;
operator|*
operator|(
name|long
operator|*
operator|)
name|h
operator|->
name|ph_next
operator|=
name|NULL
expr_stmt|;
name|acp
operator|->
name|acp_device
operator|=
literal|1
expr_stmt|;
name|WritePacket
argument_list|(
operator|(
name|caddr_t
operator|)
name|acp
argument_list|)
expr_stmt|;
undef|#
directive|undef
name|h
name|spdp
operator|=
operator|(
name|SetPointingDeviceReportingPacket
operator|*
operator|)
name|AllocateSpace
argument_list|(
sizeof|sizeof
argument_list|(
name|SetPointingDeviceReportingPacket
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|spdp
operator|==
name|NULL
condition|)
return|return;
define|#
directive|define
name|h
value|((PacketHeader *) spdp->spdp_head)
name|h
operator|->
name|ph_modifier
operator|.
name|emptymod
operator|=
literal|0
expr_stmt|;
name|h
operator|->
name|ph_opcode
operator|=
name|SET_POINTING_DEVICE_REPORTING
expr_stmt|;
operator|*
operator|(
name|long
operator|*
operator|)
name|h
operator|->
name|ph_next
operator|=
name|NULL
expr_stmt|;
name|spdp
operator|->
name|spdp_enable
operator|=
literal|1
expr_stmt|;
name|WritePacket
argument_list|(
operator|(
name|caddr_t
operator|)
name|spdp
argument_list|)
expr_stmt|;
undef|#
directive|undef
name|h
block|}
end_block

begin_expr_stmt
name|SetCursorPosition
argument_list|(
name|pos
argument_list|)
specifier|register
name|vsCursor
operator|*
name|pos
expr_stmt|;
end_expr_stmt

begin_block
block|{
specifier|register
name|SetCursorPositionPacket
modifier|*
name|scp
decl_stmt|;
name|scp
operator|=
operator|(
name|SetCursorPositionPacket
operator|*
operator|)
name|AllocateSpace
argument_list|(
sizeof|sizeof
argument_list|(
name|SetCursorPositionPacket
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|scp
operator|==
name|NULL
condition|)
return|return;
define|#
directive|define
name|h
value|((PacketHeader *) scp->scp_head)
define|#
directive|define
name|loc
value|((Point *) scp->scp_position)
name|h
operator|->
name|ph_modifier
operator|.
name|emptymod
operator|=
literal|0
expr_stmt|;
name|h
operator|->
name|ph_opcode
operator|=
name|SET_CURSOR_POSITION
expr_stmt|;
operator|*
operator|(
name|long
operator|*
operator|)
name|h
operator|->
name|ph_next
operator|=
name|NULL
expr_stmt|;
name|loc
operator|->
name|p_x
operator|=
name|pos
operator|->
name|x
expr_stmt|;
name|loc
operator|->
name|p_y
operator|=
name|pos
operator|->
name|y
expr_stmt|;
name|WritePacket
argument_list|(
operator|(
name|caddr_t
operator|)
name|scp
argument_list|)
expr_stmt|;
name|VSAddr
operator|->
name|mouse
operator|=
operator|*
name|pos
expr_stmt|;
undef|#
directive|undef
name|h
undef|#
directive|undef
name|loc
block|}
end_block

begin_macro
name|SetMouseCharacteristics
argument_list|(
argument|threshold
argument_list|,
argument|acceleration
argument_list|)
end_macro

begin_decl_stmt
name|int
name|threshold
decl_stmt|,
name|acceleration
decl_stmt|;
end_decl_stmt

begin_block
block|{
specifier|register
name|SetMouseCharacteristicsPacket
modifier|*
name|smp
decl_stmt|;
name|smp
operator|=
operator|(
name|SetMouseCharacteristicsPacket
operator|*
operator|)
name|AllocateSpace
argument_list|(
sizeof|sizeof
argument_list|(
name|SetMouseCharacteristicsPacket
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|smp
operator|==
name|NULL
condition|)
return|return;
define|#
directive|define
name|h
value|((PacketHeader *) smp->smc_head)
name|h
operator|->
name|ph_mouseMod
operator|.
name|m_tracking
operator|=
literal|1
expr_stmt|;
name|h
operator|->
name|ph_opcode
operator|=
name|SET_MOUSE_CHARACTERISTICS
expr_stmt|;
operator|*
operator|(
name|long
operator|*
operator|)
name|h
operator|->
name|ph_next
operator|=
name|NULL
expr_stmt|;
name|smp
operator|->
name|smc_scale
operator|=
name|acceleration
expr_stmt|;
name|smp
operator|->
name|smc_threshold
operator|=
name|threshold
expr_stmt|;
name|WritePacket
argument_list|(
operator|(
name|caddr_t
operator|)
name|smp
argument_list|)
expr_stmt|;
undef|#
directive|undef
name|h
block|}
end_block

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_include
include|#
directive|include
file|<X/mit-copyright.h>
end_include

begin_comment
comment|/* $Header: XMenuRecomp.c,v 10.7 86/02/12 16:19:51 tony Rel $ */
end_comment

begin_comment
comment|/* Copyright    Massachusetts Institute of Technology    1985	*/
end_comment

begin_comment
comment|/*  * XMenu:	MIT Project Athena, X Window system menu package  *  * 	XMenuRecompute - Recompute XMenu object dependencies.  *  *	Author:		Tony Della Fera, DEC  *			September, 1985  *  */
end_comment

begin_include
include|#
directive|include
file|"XMenuInternal.h"
end_include

begin_function
name|int
name|XMenuRecompute
parameter_list|(
name|menu
parameter_list|)
specifier|register
name|XMenu
modifier|*
name|menu
decl_stmt|;
comment|/* Menu object to be recomputed. */
block|{
specifier|register
name|XMPane
modifier|*
name|p_ptr
decl_stmt|;
comment|/* Pane pointer. */
specifier|register
name|XMSelect
modifier|*
name|s_ptr
decl_stmt|;
comment|/* Selection pointer. */
specifier|register
name|int
name|p_num
decl_stmt|;
comment|/* Pane serial number. */
specifier|register
name|int
name|s_num
decl_stmt|;
comment|/* Selection serial number. */
comment|/*      * If no recompute is necessary, return.      */
if|if
condition|(
operator|!
name|menu
operator|->
name|recompute
condition|)
block|{
name|_XMErrorCode
operator|=
name|XME_NO_ERROR
expr_stmt|;
return|return
operator|(
name|XM_SUCCESS
operator|)
return|;
block|}
comment|/*      * If there are no panes in the menu then return failure      * beacuse the menu is not initialized.      */
if|if
condition|(
name|menu
operator|->
name|p_count
operator|==
literal|0
condition|)
block|{
name|_XMErrorCode
operator|=
name|XME_NOT_INIT
expr_stmt|;
return|return
operator|(
name|XM_FAILURE
operator|)
return|;
block|}
comment|/*      * Recompute menu wide global values: pane window size,      * selection size and maximum selection count.      */
name|_XMRecomputeGlobals
argument_list|(
name|menu
argument_list|)
expr_stmt|;
comment|/*      * For each pane in the menu...      */
name|p_num
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|p_ptr
operator|=
name|menu
operator|->
name|p_list
operator|->
name|next
init|;
name|p_ptr
operator|!=
name|menu
operator|->
name|p_list
condition|;
name|p_ptr
operator|=
name|p_ptr
operator|->
name|next
control|)
block|{
comment|/* 	 * Recompute pane dependencies. 	 */
if|if
condition|(
name|_XMRecomputePane
argument_list|(
name|menu
argument_list|,
name|p_ptr
argument_list|,
name|p_num
argument_list|)
operator|==
name|_FAILURE
condition|)
block|{
return|return
operator|(
name|XM_FAILURE
operator|)
return|;
block|}
name|p_num
operator|++
expr_stmt|;
comment|/* 	 * For each selection in the pane... 	 */
name|s_num
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|s_ptr
operator|=
name|p_ptr
operator|->
name|s_list
operator|->
name|next
init|;
name|s_ptr
operator|!=
name|p_ptr
operator|->
name|s_list
condition|;
name|s_ptr
operator|=
name|s_ptr
operator|->
name|next
control|)
block|{
comment|/* 	     * Recompute selection dependencies. 	     */
if|if
condition|(
name|_XMRecomputeSelection
argument_list|(
name|menu
argument_list|,
name|s_ptr
argument_list|,
name|s_num
argument_list|)
operator|==
name|_FAILURE
condition|)
block|{
return|return
operator|(
name|XM_FAILURE
operator|)
return|;
block|}
name|s_num
operator|++
expr_stmt|;
block|}
block|}
comment|/*      * Flush the window creation queue.      * This batches all window creates since lazy evaluation      * is more efficient than individual evaluation.      * This routine also does an XFlush().      */
if|if
condition|(
name|_XMWinQueFlush
argument_list|(
name|menu
argument_list|)
operator|==
name|_FAILURE
condition|)
return|return
operator|(
name|XM_FAILURE
operator|)
return|;
comment|/*      * Make sure all selection windows are mapped.      */
for|for
control|(
name|p_ptr
operator|=
name|menu
operator|->
name|p_list
operator|->
name|next
init|;
name|p_ptr
operator|!=
name|menu
operator|->
name|p_list
condition|;
name|p_ptr
operator|=
name|p_ptr
operator|->
name|next
control|)
block|{
name|XMapSubwindows
argument_list|(
name|p_ptr
operator|->
name|window
argument_list|)
expr_stmt|;
block|}
comment|/*      * Recompute menu size.      */
if|if
condition|(
name|menu
operator|->
name|menu_style
operator|==
name|CENTER
condition|)
block|{
name|menu
operator|->
name|width
operator|=
name|menu
operator|->
name|p_width
operator|+
operator|(
name|menu
operator|->
name|p_bdr_width
operator|<<
literal|1
operator|)
expr_stmt|;
block|}
else|else
block|{
name|menu
operator|->
name|width
operator|=
name|menu
operator|->
name|p_width
operator|+
operator|(
name|menu
operator|->
name|p_bdr_width
operator|<<
literal|1
operator|)
operator|+
operator|(
operator|(
name|menu
operator|->
name|p_count
operator|-
literal|1
operator|)
operator|*
name|menu
operator|->
name|p_x_off
operator|)
expr_stmt|;
block|}
name|menu
operator|->
name|height
operator|=
name|menu
operator|->
name|p_height
operator|+
operator|(
name|menu
operator|->
name|p_bdr_width
operator|<<
literal|1
operator|)
operator|+
operator|(
operator|(
name|menu
operator|->
name|p_count
operator|-
literal|1
operator|)
operator|*
name|menu
operator|->
name|p_y_off
operator|)
expr_stmt|;
comment|/*      * Reset the recompute flag.      */
name|menu
operator|->
name|recompute
operator|=
literal|0
expr_stmt|;
comment|/*      * Return successfully.      */
name|_XMErrorCode
operator|=
name|XME_NO_ERROR
expr_stmt|;
return|return
operator|(
name|XM_SUCCESS
operator|)
return|;
block|}
end_function

end_unit


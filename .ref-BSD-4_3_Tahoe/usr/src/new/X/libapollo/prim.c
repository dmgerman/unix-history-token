begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_ifndef
ifndef|#
directive|ifndef
name|lint
end_ifndef

begin_decl_stmt
specifier|static
name|char
modifier|*
name|rcsid_prim_c
init|=
literal|"$Header: prim.c,v 10.1 86/11/29 13:52:30 jg Rel $"
decl_stmt|;
end_decl_stmt

begin_endif
endif|#
directive|endif
endif|lint
end_endif

begin_comment
comment|/*      Copyright 1986 by the University of Utah      Permission to use, copy, modify, and distribute this     software and its documentation for any purpose and without     fee is hereby granted, provided that the above copyright     notice appear in all copies and that both that copyright     notice and this permission notice appear in supporting     documentation, and that the name of the University of Utah     not be used in advertising or publicity pertaining to      distribution of the software without specific, written      prior permission. The University of Utah makes no     representations about the suitability of this software for     any purpose.  It is provided "as is" without express or     implied warranty.      */
end_comment

begin_include
include|#
directive|include
file|"Xapollo.h"
end_include

begin_include
include|#
directive|include
file|"/sys/ins/smdu.ins.c"
end_include

begin_decl_stmt
specifier|extern
name|boolean
name|borrow_flag
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|extern
name|gpr_$plane_t
name|plane
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|extern
name|int
name|old_op
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|status_$t
name|status
decl_stmt|;
end_decl_stmt

begin_function
name|BITMAP
modifier|*
name|make_bitmap
parameter_list|(
name|area
parameter_list|,
name|width
parameter_list|,
name|height
parameter_list|,
name|invert
parameter_list|)
name|short
modifier|*
name|area
decl_stmt|;
comment|/* the bits of the image or NULL */
name|int
name|width
decl_stmt|;
name|int
name|height
decl_stmt|;
name|boolean
name|invert
decl_stmt|;
comment|/* true->the image bits need to inverted */
block|{
name|BITMAP
modifier|*
name|bm
decl_stmt|;
name|gpr_$bitmap_desc_t
name|bitmap
decl_stmt|;
specifier|static
name|gpr_$attribute_desc_t
name|attr
decl_stmt|;
name|gpr_$offset_t
name|size
decl_stmt|;
name|short
modifier|*
name|pointer
decl_stmt|;
comment|/* pointer to Apollo bitmap */
name|short
name|bwid
decl_stmt|;
comment|/* Apollo bitmap line width */
name|int
name|rowwid
decl_stmt|;
comment|/* image bits row width */
name|int
name|i
decl_stmt|;
if|if
condition|(
operator|(
name|bm
operator|=
operator|(
name|BITMAP
operator|*
operator|)
name|Xalloc
argument_list|(
sizeof|sizeof
argument_list|(
name|BITMAP
argument_list|)
argument_list|)
operator|)
operator|==
name|NULL
condition|)
return|return
operator|(
name|NULL
operator|)
return|;
name|bm
operator|->
name|refcnt
operator|=
literal|1
expr_stmt|;
name|bm
operator|->
name|kind
operator|=
operator|(
name|int
operator|)
name|apollo_bitmap
expr_stmt|;
name|size
operator|.
name|x_size
operator|=
name|bm
operator|->
name|width
operator|=
name|width
expr_stmt|;
name|size
operator|.
name|y_size
operator|=
name|bm
operator|->
name|height
operator|=
name|height
expr_stmt|;
name|gpr_$allocate_attribute_block
argument_list|(
name|attr
argument_list|,
name|status
argument_list|)
expr_stmt|;
if|if
condition|(
name|check_status
argument_list|(
name|status
argument_list|,
literal|"make_bitmap:"
argument_list|)
condition|)
return|return
operator|(
name|NULL
operator|)
return|;
name|gpr_$allocate_bitmap_nc
argument_list|(
name|size
argument_list|,
call|(
name|gpr_$plane_t
call|)
argument_list|(
name|Screen
operator|.
name|depth
operator|-
literal|1
argument_list|)
argument_list|,
name|attr
argument_list|,
name|bitmap
argument_list|,
name|status
argument_list|)
expr_stmt|;
if|if
condition|(
name|check_status
argument_list|(
name|status
argument_list|,
literal|"make_bitmap:"
argument_list|)
condition|)
return|return
operator|(
name|NULL
operator|)
return|;
name|bm
operator|->
name|data
operator|=
operator|(
name|caddr_t
operator|)
name|bitmap
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|area
operator|==
name|NULL
operator|)
condition|)
block|{
name|gpr_$inq_bitmap_pointer
argument_list|(
name|bitmap
argument_list|,
name|pointer
argument_list|,
name|bwid
argument_list|,
name|status
argument_list|)
expr_stmt|;
name|rowwid
operator|=
operator|(
operator|(
name|width
operator|+
literal|15
operator|)
operator|>>
literal|4
operator|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|height
condition|;
name|i
operator|++
control|)
block|{
name|bcopy
argument_list|(
name|area
argument_list|,
name|pointer
argument_list|,
name|rowwid
operator|*
literal|2
argument_list|)
expr_stmt|;
if|if
condition|(
name|invert
condition|)
name|InvertPixelOrder
argument_list|(
operator|(
name|short
operator|*
operator|)
name|pointer
argument_list|,
name|rowwid
argument_list|)
expr_stmt|;
name|pointer
operator|+=
name|bwid
expr_stmt|;
name|area
operator|+=
name|rowwid
expr_stmt|;
block|}
block|}
return|return
operator|(
name|bm
operator|)
return|;
block|}
end_function

begin_function
name|FONT
modifier|*
name|make_fontmap
parameter_list|(
name|fd
parameter_list|)
name|FONT
modifier|*
name|fd
decl_stmt|;
block|{
name|int
name|width
decl_stmt|;
name|int
name|height
decl_stmt|;
name|BITMAP
modifier|*
name|bm
decl_stmt|;
name|gpr_$bitmap_desc_t
name|bitmap
decl_stmt|;
specifier|static
name|gpr_$attribute_desc_t
name|attr
init|=
operator|-
literal|1
decl_stmt|;
name|gpr_$window_t
name|window
decl_stmt|;
name|gpr_$position_t
name|dest
decl_stmt|;
specifier|static
name|int
name|got_attr
init|=
literal|0
decl_stmt|;
name|gpr_$offset_t
name|size
decl_stmt|;
name|FontPriv
modifier|*
name|fpriv
decl_stmt|;
name|short
name|col
decl_stmt|,
name|row
decl_stmt|;
name|short
name|left
decl_stmt|,
name|oldleft
decl_stmt|,
name|wid
decl_stmt|,
name|oldwid
decl_stmt|;
name|int
name|start
decl_stmt|,
name|stop
decl_stmt|;
name|int
name|i
decl_stmt|;
name|fpriv
operator|=
operator|(
name|FontPriv
operator|*
operator|)
name|fd
operator|->
name|data
expr_stmt|;
name|bm
operator|=
name|fpriv
operator|->
name|strike
expr_stmt|;
name|width
operator|=
name|fd
operator|->
name|last
operator|*
name|fd
operator|->
name|avg_width
expr_stmt|;
name|height
operator|=
operator|(
name|width
operator|/
literal|224
operator|)
operator|+
literal|1
expr_stmt|;
name|height
operator|=
name|height
operator|*
name|fd
operator|->
name|height
expr_stmt|;
comment|/* should check for height> 224 */
name|size
operator|.
name|x_size
operator|=
literal|224
expr_stmt|;
name|size
operator|.
name|y_size
operator|=
name|height
expr_stmt|;
if|if
condition|(
operator|!
name|got_attr
condition|)
block|{
name|gpr_$allocate_attribute_block
argument_list|(
name|attr
argument_list|,
name|status
argument_list|)
expr_stmt|;
if|if
condition|(
name|check_status
argument_list|(
name|status
argument_list|,
literal|"make_fontmap:"
argument_list|)
condition|)
return|return
operator|(
name|NULL
operator|)
return|;
name|got_attr
operator|=
literal|1
expr_stmt|;
block|}
name|gpr_$allocate_bitmap
argument_list|(
name|size
argument_list|,
operator|(
name|gpr_$plane_t
operator|)
literal|0
argument_list|,
name|attr
argument_list|,
name|bitmap
argument_list|,
name|status
argument_list|)
expr_stmt|;
if|if
condition|(
name|check_status
argument_list|(
name|status
argument_list|,
literal|"make_fontmap:"
argument_list|)
condition|)
return|return
operator|(
name|NULL
operator|)
return|;
name|row
operator|=
name|start
operator|=
literal|0
expr_stmt|;
name|gpr_$set_bitmap
argument_list|(
name|bitmap
argument_list|,
name|status
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<=
name|fd
operator|->
name|last
condition|;
name|i
operator|++
control|)
block|{
name|left
operator|=
name|fpriv
operator|->
name|leftarray
index|[
name|i
index|]
expr_stmt|;
name|wid
operator|=
name|fpriv
operator|->
name|widths
index|[
name|i
index|]
expr_stmt|;
if|if
condition|(
operator|(
name|left
operator|+
name|wid
operator|)
operator|>
operator|(
name|start
operator|+
literal|224
operator|)
condition|)
block|{
name|stop
operator|=
name|oldleft
operator|+
name|oldwid
expr_stmt|;
name|window
operator|.
name|x_coord
operator|=
name|start
expr_stmt|;
name|window
operator|.
name|y_coord
operator|=
literal|0
expr_stmt|;
name|window
operator|.
name|x_size
operator|=
name|stop
operator|-
name|start
expr_stmt|;
name|window
operator|.
name|y_size
operator|=
name|fd
operator|->
name|height
expr_stmt|;
name|dest
operator|.
name|x_coord
operator|=
literal|0
expr_stmt|;
name|dest
operator|.
name|y_coord
operator|=
name|row
operator|*
name|fd
operator|->
name|height
expr_stmt|;
name|gpr_$bit_blt
argument_list|(
name|bm
operator|->
name|data
argument_list|,
name|window
argument_list|,
operator|(
name|short
operator|)
literal|0
argument_list|,
name|dest
argument_list|,
operator|(
name|short
operator|)
literal|0
argument_list|,
name|status
argument_list|)
expr_stmt|;
name|start
operator|=
name|stop
expr_stmt|;
name|row
operator|++
expr_stmt|;
name|col
operator|=
literal|0
expr_stmt|;
block|}
name|oldleft
operator|=
name|left
expr_stmt|;
name|oldwid
operator|=
name|wid
expr_stmt|;
name|fpriv
operator|->
name|leftarray
index|[
name|i
index|]
operator|=
name|col
operator|+
operator|(
name|row
operator|<<
literal|10
operator|)
expr_stmt|;
name|col
operator|+=
name|fpriv
operator|->
name|widths
index|[
name|i
index|]
expr_stmt|;
block|}
if|if
condition|(
name|start
operator|!=
operator|(
name|oldleft
operator|+
name|oldwid
operator|)
condition|)
block|{
name|window
operator|.
name|x_coord
operator|=
name|start
expr_stmt|;
name|window
operator|.
name|x_size
operator|=
operator|(
name|left
operator|+
name|wid
operator|)
operator|-
name|start
expr_stmt|;
name|window
operator|.
name|y_size
operator|=
name|fd
operator|->
name|height
expr_stmt|;
name|dest
operator|.
name|y_coord
operator|=
name|row
operator|*
name|fd
operator|->
name|height
expr_stmt|;
name|gpr_$bit_blt
argument_list|(
name|bm
operator|->
name|data
argument_list|,
name|window
argument_list|,
operator|(
name|short
operator|)
literal|0
argument_list|,
name|dest
argument_list|,
operator|(
name|short
operator|)
literal|0
argument_list|,
name|status
argument_list|)
expr_stmt|;
block|}
name|bm
operator|->
name|width
operator|=
literal|224
expr_stmt|;
name|bm
operator|->
name|height
operator|=
name|height
expr_stmt|;
name|bm
operator|->
name|refcnt
operator|=
literal|1
expr_stmt|;
name|bm
operator|->
name|kind
operator|=
operator|(
name|int
operator|)
name|apollo_bitmap
expr_stmt|;
name|bm
operator|->
name|data
operator|=
operator|(
name|caddr_t
operator|)
name|bitmap
expr_stmt|;
name|gpr_$set_bitmap
argument_list|(
name|Screen
operator|.
name|bm
argument_list|,
name|status
argument_list|)
expr_stmt|;
return|return
operator|(
name|fd
operator|)
return|;
block|}
end_function

end_unit


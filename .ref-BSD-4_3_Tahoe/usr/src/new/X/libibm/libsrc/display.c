begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_ifndef
ifndef|#
directive|ifndef
name|lint
end_ifndef

begin_decl_stmt
specifier|static
name|char
modifier|*
name|rcsid_display_c
init|=
literal|"$Header: display.c,v 10.2 86/12/17 18:04:40 swick Exp $"
decl_stmt|;
end_decl_stmt

begin_endif
endif|#
directive|endif
endif|lint
end_endif

begin_comment
comment|/* display.c - Routines to initialize screen, and allocate space??  *  *	OpenDisplay		Open it  *	InitDisplay		Do display initialization  *	DisplayDead		Check if dead  *	AllocateSpace		Allocate some temporary storage  *  *  	Author:  *  *		Scott Bates  *		Brown University  *		IRIS, Box 1946  *      	Providence, RI 02912  *  *  *		Copyright (c) 1986 Brown University  *  * Permission to use, copy, modify and distribute this software and its  * documentation for any purpose and without fee is hereby granted, provided  * that the above copyright notice appear in all copies, and that both  * that copyright notice and this permission notice appear in supporting  * documentation, and that the name of Brown University not be used in  * advertising or publicity pertaining to distribution of the software  * without specific, written prior permission. Brown University makes no  * representations about the suitability of this software for any purpose.  * It is provided "as-is" without express or implied warranty.  */
end_comment

begin_include
include|#
directive|include
file|"private.h"
end_include

begin_include
include|#
directive|include
file|"bitblt.h"
end_include

begin_ifdef
ifdef|#
directive|ifdef
name|APA16
end_ifdef

begin_include
include|#
directive|include
file|"apa16.h"
end_include

begin_endif
endif|#
directive|endif
endif|APA16
end_endif

begin_ifdef
ifdef|#
directive|ifdef
name|AED
end_ifdef

begin_include
include|#
directive|include
file|"aed.h"
end_include

begin_endif
endif|#
directive|endif
endif|AED
end_endif

begin_ifdef
ifdef|#
directive|ifdef
name|APA8
end_ifdef

begin_include
include|#
directive|include
file|"apa8.h"
end_include

begin_endif
endif|#
directive|endif
endif|APA8
end_endif

begin_ifdef
ifdef|#
directive|ifdef
name|APA8C
end_ifdef

begin_include
include|#
directive|include
file|"apa8c.h"
end_include

begin_endif
endif|#
directive|endif
endif|APA8C
end_endif

begin_ifdef
ifdef|#
directive|ifdef
name|PQD
end_ifdef

begin_include
include|#
directive|include
file|"pqd.h"
end_include

begin_endif
endif|#
directive|endif
endif|PQD
end_endif

begin_comment
comment|/*  * Open the display  */
end_comment

begin_comment
comment|/*ARGSUSED*/
end_comment

begin_macro
name|OpenDisplay
argument_list|(
argument|xNumber
argument_list|)
end_macro

begin_decl_stmt
name|char
modifier|*
name|xNumber
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|char
modifier|*
name|MouseType
init|=
name|getenv
argument_list|(
literal|"MOUSETYPE"
argument_list|)
decl_stmt|;
name|char
modifier|*
name|MouseName
init|=
name|getenv
argument_list|(
literal|"MOUSENAME"
argument_list|)
decl_stmt|;
specifier|extern
name|int
name|mdev
decl_stmt|;
name|int
name|emul
decl_stmt|;
ifdef|#
directive|ifdef
name|TRACE_X
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"In OpenDisplay\n"
argument_list|)
expr_stmt|;
name|fflush
argument_list|(
name|stderr
argument_list|)
expr_stmt|;
endif|#
directive|endif
endif|TRACE_X
comment|/* 	 * Open Minor device for correct screen and switch 	 * to that screen 	 */
if|if
condition|(
operator|(
name|xdev
operator|=
name|open
argument_list|(
name|SCREEN_DEVICE
argument_list|,
name|O_RDWR
operator||
name|O_NDELAY
argument_list|)
operator|)
operator|<
literal|0
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Unable to open device (%s)\n"
argument_list|,
name|SCREEN_DEVICE
argument_list|)
expr_stmt|;
name|fflush
argument_list|(
name|stderr
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|2
argument_list|)
expr_stmt|;
block|}
comment|/* 	 * Get mouse device name 	 */
if|if
condition|(
operator|!
name|MouseName
condition|)
name|MouseName
operator|=
name|MOUSE_DEVICE
expr_stmt|;
comment|/* 	 * Open mouse  	 */
if|if
condition|(
operator|(
name|mdev
operator|=
name|open
argument_list|(
name|MouseName
argument_list|,
name|O_RDWR
operator||
name|O_NDELAY
argument_list|)
operator|)
operator|<
literal|0
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Error in open of (%s)\n"
argument_list|,
name|MouseName
argument_list|)
expr_stmt|;
name|fflush
argument_list|(
name|stderr
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|2
argument_list|)
expr_stmt|;
block|}
comment|/* 	 * Set X Input and Output Emulators for this display 	 */
name|emul
operator|=
name|E_XINPUT
expr_stmt|;
if|if
condition|(
name|ioctl
argument_list|(
name|xdev
argument_list|,
name|EISETD
argument_list|,
operator|(
name|caddr_t
operator|)
operator|&
name|emul
argument_list|)
operator|<
literal|0
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Unable to set E_XINPUT (%s)\n"
argument_list|,
name|SCREEN_DEVICE
argument_list|)
expr_stmt|;
name|fflush
argument_list|(
name|stderr
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|2
argument_list|)
expr_stmt|;
block|}
name|emul
operator|=
name|E_XOUTPUT
expr_stmt|;
if|if
condition|(
name|ioctl
argument_list|(
name|xdev
argument_list|,
name|EOSETD
argument_list|,
operator|(
name|caddr_t
operator|)
operator|&
name|emul
argument_list|)
operator|<
literal|0
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Unable to set E_XOUTPUT (%s)\n"
argument_list|,
name|SCREEN_DEVICE
argument_list|)
expr_stmt|;
name|fflush
argument_list|(
name|stderr
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|2
argument_list|)
expr_stmt|;
block|}
comment|/* 	 * Gain access to I/O address space 	 */
if|if
condition|(
name|open
argument_list|(
literal|"/dev/bus"
argument_list|,
name|O_RDONLY
operator||
name|O_NDELAY
argument_list|)
operator|<
literal|0
condition|)
block|{
name|DeviceError
argument_list|(
literal|"Unable to open /dev/bus\n"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|2
argument_list|)
expr_stmt|;
block|}
comment|/* 	 * Return displays file descriptor 	 */
return|return
operator|(
name|xdev
operator|)
return|;
block|}
end_block

begin_comment
comment|/*  * Do display specific initialization  */
end_comment

begin_expr_stmt
name|InitDisplay
argument_list|(
name|info
argument_list|)
specifier|register
name|DEVICE
operator|*
name|info
expr_stmt|;
end_expr_stmt

begin_block
block|{
ifdef|#
directive|ifdef
name|TRACE_X
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"In InitDisplay\n"
argument_list|)
expr_stmt|;
name|fflush
argument_list|(
name|stderr
argument_list|)
expr_stmt|;
endif|#
directive|endif
endif|TRACE_X
comment|/* 	 * Get address of shared memory 	 */
if|if
condition|(
name|ioctl
argument_list|(
name|xdev
argument_list|,
name|QIOCADDR
argument_list|,
operator|(
name|caddr_t
operator|)
operator|&
name|XAddr
argument_list|)
operator|<
literal|0
condition|)
block|{
name|DeviceError
argument_list|(
literal|"Ioctl to set XAddr failed"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|2
argument_list|)
expr_stmt|;
block|}
comment|/*          * Initialize (reset) the display          */
name|DISPLAY_INIT
argument_list|()
expr_stmt|;
comment|/* 	 * Initialize bitblt()  	 */
name|bitblt_init
argument_list|(
name|SCREEN_BASE
argument_list|,
name|REAL_SCREEN_WIDTH
argument_list|,
name|REAL_SCREEN_HEIGHT
argument_list|,
name|CURSOR_TYPE
argument_list|)
expr_stmt|;
comment|/*          * Set up the physical bitmap structure. This is used 	 * by device dependent code to talk to bitblt().          */
name|pbm
operator|.
name|width
operator|=
name|REAL_SCREEN_WIDTH
expr_stmt|;
name|pbm
operator|.
name|height
operator|=
name|REAL_SCREEN_HEIGHT
expr_stmt|;
name|pbm
operator|.
name|refcnt
operator|=
literal|1
expr_stmt|;
name|pbm
operator|.
name|data
operator|=
operator|(
name|caddr_t
operator|)
name|SCREEN_BASE
expr_stmt|;
comment|/* 	 * Fill in device and queue information 	 */
name|info
operator|->
name|id
operator|=
name|XDEV_ID
expr_stmt|;
name|info
operator|->
name|width
operator|=
name|X_SCREEN_WIDTH
expr_stmt|;
name|info
operator|->
name|height
operator|=
name|X_SCREEN_HEIGHT
expr_stmt|;
name|info
operator|->
name|planes
operator|=
literal|1
expr_stmt|;
name|info
operator|->
name|entries
operator|=
literal|0
expr_stmt|;
name|info
operator|->
name|mouse
operator|=
operator|(
name|vsCursor
operator|*
operator|)
operator|(
operator|&
operator|(
name|XAddr
operator|->
name|mouse
operator|)
operator|)
expr_stmt|;
name|info
operator|->
name|mbox
operator|=
operator|(
name|vsBox
operator|*
operator|)
operator|(
operator|&
operator|(
name|XAddr
operator|->
name|mbox
operator|)
operator|)
expr_stmt|;
name|info
operator|->
name|queue
operator|=
operator|(
name|vsEventQueue
operator|*
operator|)
operator|(
operator|&
name|XAddr
operator|->
name|ibuff
operator|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_block

begin_comment
comment|/*  * Check if display is dead  */
end_comment

begin_macro
name|DisplayDead
argument_list|()
end_macro

begin_block
block|{
ifdef|#
directive|ifdef
name|TRACE_X
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"In DisplayDead\n"
argument_list|)
expr_stmt|;
name|fflush
argument_list|(
name|stderr
argument_list|)
expr_stmt|;
endif|#
directive|endif
endif|TRACE_X
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_block

begin_comment
comment|/*  * The presumption here is that only one AllocateSpace  * call is made/request  */
end_comment

begin_define
define|#
directive|define
name|ABUFSIZE
value|3072
end_define

begin_decl_stmt
specifier|static
name|char
name|ABuffer
index|[
literal|3072
index|]
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* random size buffer for allocate space */
end_comment

begin_function
name|caddr_t
name|AllocateSpace
parameter_list|(
name|size
parameter_list|)
specifier|register
name|int
name|size
decl_stmt|;
block|{
ifdef|#
directive|ifdef
name|TRACE_X
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"In AllocateSpace\n"
argument_list|)
expr_stmt|;
name|fflush
argument_list|(
name|stderr
argument_list|)
expr_stmt|;
endif|#
directive|endif
endif|TRACE_X
if|if
condition|(
name|size
operator|<
name|ABUFSIZE
condition|)
return|return
operator|(
name|ABuffer
operator|)
return|;
name|errno
operator|=
name|ENOMEM
expr_stmt|;
return|return
operator|(
name|NULL
operator|)
return|;
block|}
end_function

end_unit


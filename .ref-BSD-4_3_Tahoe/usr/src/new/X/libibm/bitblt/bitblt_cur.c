begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_ifndef
ifndef|#
directive|ifndef
name|lint
end_ifndef

begin_decl_stmt
specifier|static
name|char
modifier|*
name|rcsid_bitblt_cur_c
init|=
literal|"$Header: bitblt_cur.c,v 10.1 86/11/19 10:51:09 jg Exp $"
decl_stmt|;
end_decl_stmt

begin_endif
endif|#
directive|endif
endif|lint
end_endif

begin_comment
comment|/*  *		Copyright (c) 1986 Brown University  *  * Permission to use, copy, modify and distribute this software and its  * documentation for any purpose and without fee is hereby granted, provided  * that the above copyright notice appear in all copies, and that both  * that copyright notice and this permission notice appear in supporting  * documentation, and that the name of Brown University not be used in  * advertising or publicity pertaining to distribution of the software without  * specific, written prior permission. Brown University makes no  * representations about the suitability of this software for any purpose.  * It is provided "as-is" without express or implied warranty.  *  * Written by Daniel Stone, Brown University/IRIS  (des@iris)  *  * NOTE: A "cursor" is the thing that moves on the screen when it  *	 is attached to the mouse.  It is sometimes refered to as a  *	 "locator" also.  *  * If the screen to be dealt with uses a software cursor then the bits  * the cursor overlayed must be replaced.  This is needed because  * the cursor (or locator) is put on the the ACTUAL bitmap.  */
end_comment

begin_include
include|#
directive|include
file|"bitblt_int.h"
end_include

begin_decl_stmt
specifier|static
name|short
name|rem_loc
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_comment
comment|/*  * This macro checks the XAddr shared memory area to see if the cursor  * is in the way.  */
end_comment

begin_define
define|#
directive|define
name|S_ORIGIN_X
value|(XAddr->mouse.x& (~(BPW-1)))
end_define

begin_define
define|#
directive|define
name|S_ORIGIN_Y
value|(XAddr->mouse.y)
end_define

begin_define
define|#
directive|define
name|S_CORNER_X
value|(S_ORIGIN_X + (2*BPW))
end_define

begin_define
define|#
directive|define
name|S_CORNER_Y
value|(S_ORIGIN_Y + BPW)
end_define

begin_define
define|#
directive|define
name|LOC_IN_BOUNDS
parameter_list|(
name|oX
parameter_list|,
name|oY
parameter_list|,
name|cX
parameter_list|,
name|cY
parameter_list|)
value|((oX< S_CORNER_X)&& (S_ORIGIN_X< cX)&&\ 				    (oY< S_CORNER_Y)&& (S_ORIGIN_Y< cY))
end_define

begin_comment
comment|/*  * Save_cursor set up the shared memory, checks to see if the cursor  * is in the rectangle bounds handed to save_cursor.  If it is then  * an ioctl is done to the kernel to remove the cursor.  If the ioctl  * fails then -1 is returned otherwise 0 is returned.  */
end_comment

begin_expr_stmt
name|save_cursor
argument_list|(
name|oX
argument_list|,
name|oY
argument_list|,
name|cX
argument_list|,
name|cY
argument_list|)
specifier|register
name|short
name|oX
operator|,
name|oY
operator|,
name|cX
operator|,
name|cY
expr_stmt|;
end_expr_stmt

begin_block
block|{
specifier|register
name|XIoAddr
modifier|*
name|xptr
decl_stmt|;
name|xptr
operator|=
name|XAddr
expr_stmt|;
name|xptr
operator|->
name|hmbox
operator|.
name|left
operator|=
name|oX
expr_stmt|;
name|xptr
operator|->
name|hmbox
operator|.
name|top
operator|=
name|oY
expr_stmt|;
name|xptr
operator|->
name|hmbox
operator|.
name|right
operator|=
name|cX
expr_stmt|;
name|xptr
operator|->
name|hmbox
operator|.
name|bottom
operator|=
name|cY
expr_stmt|;
name|xptr
operator|->
name|hmbox
operator|.
name|flags
operator|=
literal|1
expr_stmt|;
if|if
condition|(
name|LOC_IN_BOUNDS
argument_list|(
name|oX
argument_list|,
name|oY
argument_list|,
name|cX
argument_list|,
name|cY
argument_list|)
condition|)
block|{
name|rem_loc
operator|=
literal|1
expr_stmt|;
if|if
condition|(
name|ioctl
argument_list|(
name|xdev
argument_list|,
name|QIOCHIDECUR
argument_list|,
literal|0
argument_list|)
operator|==
operator|-
literal|1
condition|)
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_block

begin_comment
comment|/*  * Restore_cursor checks the shared memory area and if set it checks  * to see if the cursor was removed by save_cursor or if it currently  * is in the critical rectangle defined by hmbox.  If it is then  * the approprate ioctl is called.  If the ioctl fails then -1 is return  * otherwise 0 is returned.  */
end_comment

begin_macro
name|restore_cursor
argument_list|()
end_macro

begin_block
block|{
specifier|register
name|XIoAddr
modifier|*
name|xptr
decl_stmt|;
name|xptr
operator|=
name|XAddr
expr_stmt|;
if|if
condition|(
name|xptr
operator|->
name|hmbox
operator|.
name|flags
condition|)
block|{
if|if
condition|(
name|rem_loc
operator|||
name|LOC_IN_BOUNDS
argument_list|(
name|xptr
operator|->
name|hmbox
operator|.
name|left
argument_list|,
name|xptr
operator|->
name|hmbox
operator|.
name|top
argument_list|,
name|xptr
operator|->
name|hmbox
operator|.
name|right
argument_list|,
name|xptr
operator|->
name|hmbox
operator|.
name|bottom
argument_list|)
condition|)
block|{
name|xptr
operator|->
name|hmbox
operator|.
name|flags
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|ioctl
argument_list|(
name|xdev
argument_list|,
name|QIOCSHOWCUR
argument_list|,
literal|0
argument_list|)
operator|==
operator|-
literal|1
condition|)
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
else|else
block|{
name|xptr
operator|->
name|hmbox
operator|.
name|flags
operator|=
literal|0
expr_stmt|;
block|}
block|}
name|rem_loc
operator|=
literal|0
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_block

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * nntpxfer  *  * Connects to the specified nntp server, and transfers all new news  * since the last successful invocation.  *  * last successful invocation date and time are stored in a file at  * /usr/spool/news/nntp.<hostname> as   *	groups YYMMDD HHMMSS distributions\n  * in case you need to edit it.  You can also override this on   * the command line in the same format, in which case the file won't  * be updated.  *  *	Brian Kantor, UCSD 1986  * (some bug fixes by ambar@athena.mit.edu)  */
end_comment

begin_define
define|#
directive|define
name|DEBUG
end_define

begin_comment
comment|/* you'd think that 4096 articles at one go is enough.... */
end_comment

begin_define
define|#
directive|define
name|MAXARTS
value|4096
end_define

begin_include
include|#
directive|include
file|<sys/types.h>
end_include

begin_include
include|#
directive|include
file|<sys/dir.h>
end_include

begin_include
include|#
directive|include
file|<sys/socket.h>
end_include

begin_include
include|#
directive|include
file|<sys/stat.h>
end_include

begin_include
include|#
directive|include
file|<sys/ioctl.h>
end_include

begin_include
include|#
directive|include
file|<sys/file.h>
end_include

begin_include
include|#
directive|include
file|<sys/time.h>
end_include

begin_include
include|#
directive|include
file|<sys/wait.h>
end_include

begin_include
include|#
directive|include
file|<sys/resource.h>
end_include

begin_include
include|#
directive|include
file|<net/if.h>
end_include

begin_include
include|#
directive|include
file|<netinet/in.h>
end_include

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_include
include|#
directive|include
file|<errno.h>
end_include

begin_include
include|#
directive|include
file|<ctype.h>
end_include

begin_include
include|#
directive|include
file|<netdb.h>
end_include

begin_include
include|#
directive|include
file|<signal.h>
end_include

begin_include
include|#
directive|include
file|<dbm.h>
end_include

begin_define
define|#
directive|define
name|INEWS
value|"/usr/lib/news/inews -p"
end_define

begin_define
define|#
directive|define
name|HIST
value|"/usr/lib/news/history"
end_define

begin_function_decl
name|char
modifier|*
name|malloc
parameter_list|()
function_decl|;
end_function_decl

begin_function_decl
name|char
modifier|*
name|strcpy
parameter_list|()
function_decl|;
end_function_decl

begin_function_decl
name|char
modifier|*
name|strcat
parameter_list|()
function_decl|;
end_function_decl

begin_function_decl
name|long
name|time
parameter_list|()
function_decl|;
end_function_decl

begin_function_decl
name|u_long
name|inet_addr
parameter_list|()
function_decl|;
end_function_decl

begin_decl_stmt
specifier|extern
name|int
name|errno
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|char
modifier|*
name|artlist
index|[
name|MAXARTS
index|]
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|server
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* stream socket to the nntp server */
end_comment

begin_decl_stmt
name|int
name|newart
decl_stmt|,
name|dupart
decl_stmt|,
name|misart
decl_stmt|;
end_decl_stmt

begin_function
name|main
parameter_list|(
name|argc
parameter_list|,
name|argv
parameter_list|)
name|int
name|argc
decl_stmt|;
name|char
modifier|*
name|argv
index|[]
decl_stmt|;
block|{
name|FILE
modifier|*
name|dtfile
decl_stmt|;
comment|/* where last xfer date/time stored */
name|char
name|buf
index|[
name|BUFSIZ
index|]
decl_stmt|;
name|char
name|lastdate
index|[
literal|16
index|]
decl_stmt|;
name|char
name|distributions
index|[
name|BUFSIZ
index|]
decl_stmt|;
name|char
name|dtname
index|[
literal|128
index|]
decl_stmt|;
name|char
name|newsgroups
index|[
name|BUFSIZ
index|]
decl_stmt|;
name|char
name|lasttime
index|[
literal|16
index|]
decl_stmt|;
name|int
name|connected
init|=
literal|0
decl_stmt|;
comment|/* 1 = connected */
name|int
name|i
decl_stmt|;
name|int
name|omitupdate
init|=
literal|0
decl_stmt|;
comment|/* 1 = don't update datetime */
name|long
name|clock
decl_stmt|;
name|long
name|newdate
decl_stmt|,
name|newtime
decl_stmt|;
name|struct
name|hostent
modifier|*
name|hp
decl_stmt|;
name|struct
name|servent
modifier|*
name|sp
decl_stmt|;
name|struct
name|sockaddr_in
name|sin
decl_stmt|;
name|struct
name|tm
modifier|*
name|now
decl_stmt|;
comment|/* OPTIONS 		argv[1] MUST be the host name 		argv[2-4] MAY be "newsgroups YYMMDD HHMMSS" 			argv[5] MAY be distributions 		(otherwise use 2-4/5 from the file 		"/usr/spool/news/nntp.hostname") 	*/
if|if
condition|(
name|argc
operator|!=
literal|2
operator|&&
name|argc
operator|!=
literal|5
operator|&&
name|argc
operator|!=
literal|6
condition|)
block|{
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"Usage: %s host [groups YYMMDD HHMMSS [<dist>]]\n"
argument_list|,
name|argv
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|argc
operator|>
literal|2
condition|)
block|{
name|omitupdate
operator|++
expr_stmt|;
operator|(
name|void
operator|)
name|strcpy
argument_list|(
name|newsgroups
argument_list|,
name|argv
index|[
literal|2
index|]
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|strcpy
argument_list|(
name|lastdate
argument_list|,
name|argv
index|[
literal|3
index|]
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|strcpy
argument_list|(
name|lasttime
argument_list|,
name|argv
index|[
literal|4
index|]
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|strcpy
argument_list|(
name|distributions
argument_list|,
literal|""
argument_list|)
expr_stmt|;
if|if
condition|(
name|argc
operator|>
literal|5
condition|)
operator|(
name|void
operator|)
name|strcpy
argument_list|(
name|distributions
argument_list|,
name|argv
index|[
literal|5
index|]
argument_list|)
expr_stmt|;
block|}
else|else
block|{
operator|(
name|void
operator|)
name|strcpy
argument_list|(
name|dtname
argument_list|,
literal|"/usr/spool/news/nntp."
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|strcat
argument_list|(
name|dtname
argument_list|,
name|argv
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
name|dtfile
operator|=
name|fopen
argument_list|(
name|dtname
argument_list|,
literal|"r"
argument_list|)
expr_stmt|;
if|if
condition|(
name|dtfile
operator|==
name|NULL
condition|)
block|{
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"%s not found; using * 860101 000000 \n"
argument_list|,
name|dtname
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|strcpy
argument_list|(
name|newsgroups
argument_list|,
literal|"*"
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|strcpy
argument_list|(
name|lastdate
argument_list|,
literal|"860101"
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|strcpy
argument_list|(
name|lasttime
argument_list|,
literal|"000000"
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|strcpy
argument_list|(
name|distributions
argument_list|,
literal|""
argument_list|)
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|fscanf
argument_list|(
name|dtfile
argument_list|,
literal|"%s %s %s %s"
argument_list|,
name|newsgroups
argument_list|,
name|lastdate
argument_list|,
name|lasttime
argument_list|,
name|distributions
argument_list|)
operator|<
literal|3
condition|)
block|{
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"%s invalid; using * 860101 000000\n"
argument_list|,
name|dtname
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|strcpy
argument_list|(
name|newsgroups
argument_list|,
literal|"*"
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|strcpy
argument_list|(
name|lastdate
argument_list|,
literal|"860101"
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|strcpy
argument_list|(
name|lasttime
argument_list|,
literal|"000000"
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|strcpy
argument_list|(
name|distributions
argument_list|,
literal|""
argument_list|)
expr_stmt|;
block|}
operator|(
name|void
operator|)
name|fclose
argument_list|(
name|dtfile
argument_list|)
expr_stmt|;
block|}
name|clock
operator|=
name|time
argument_list|(
operator|(
name|long
operator|*
operator|)
literal|0
argument_list|)
expr_stmt|;
name|now
operator|=
name|gmtime
argument_list|(
operator|&
name|clock
argument_list|)
expr_stmt|;
name|newdate
operator|=
operator|(
name|now
operator|->
name|tm_year
operator|*
literal|10000
operator|)
operator|+
operator|(
operator|(
name|now
operator|->
name|tm_mon
operator|+
literal|1
operator|)
operator|*
literal|100
operator|)
operator|+
name|now
operator|->
name|tm_mday
expr_stmt|;
name|newtime
operator|=
operator|(
name|now
operator|->
name|tm_hour
operator|*
literal|10000
operator|)
operator|+
operator|(
name|now
operator|->
name|tm_min
operator|*
literal|100
operator|)
operator|+
name|now
operator|->
name|tm_sec
expr_stmt|;
block|}
ifdef|#
directive|ifdef
name|DEBUG
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"newsgroups = '%s'\n"
argument_list|,
name|newsgroups
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"date = '%s'\n"
argument_list|,
name|lastdate
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"time = '%s'\n"
argument_list|,
name|lasttime
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"distributions = '%s'\n"
argument_list|,
name|distributions
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"now is = %06d %06d\n"
argument_list|,
name|newdate
argument_list|,
name|newtime
argument_list|)
expr_stmt|;
endif|#
directive|endif
if|if
condition|(
name|dbminit
argument_list|(
name|HIST
argument_list|)
operator|<
literal|0
condition|)
block|{
name|perror
argument_list|(
literal|"couldn't open history file"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
name|sin
operator|.
name|sin_addr
operator|.
name|s_addr
operator|=
name|inet_addr
argument_list|(
name|argv
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|sin
operator|.
name|sin_addr
operator|.
name|s_addr
operator|!=
operator|-
literal|1
condition|)
block|{
name|sin
operator|.
name|sin_family
operator|=
name|AF_INET
expr_stmt|;
block|}
else|else
block|{
name|hp
operator|=
name|gethostbyname
argument_list|(
name|argv
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|hp
operator|==
name|NULL
condition|)
block|{
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"%s: unknown host\n"
argument_list|,
name|argv
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
name|sin
operator|.
name|sin_family
operator|=
name|hp
operator|->
name|h_addrtype
expr_stmt|;
ifdef|#
directive|ifdef
name|BSD43
name|bcopy
argument_list|(
name|hp
operator|->
name|h_addr_list
index|[
literal|0
index|]
argument_list|,
operator|(
name|caddr_t
operator|)
operator|&
name|sin
operator|.
name|sin_addr
argument_list|,
name|hp
operator|->
name|h_length
argument_list|)
expr_stmt|;
else|#
directive|else
else|BSD43
name|bcopy
argument_list|(
name|hp
operator|->
name|h_addr
argument_list|,
operator|(
name|caddr_t
operator|)
operator|&
name|sin
operator|.
name|sin_addr
argument_list|,
name|hp
operator|->
name|h_length
argument_list|)
expr_stmt|;
endif|#
directive|endif
endif|BSD43
block|}
name|sp
operator|=
name|getservbyname
argument_list|(
literal|"nntp"
argument_list|,
literal|"tcp"
argument_list|)
expr_stmt|;
if|if
condition|(
name|sp
operator|==
name|NULL
condition|)
block|{
name|perror
argument_list|(
literal|"nntp/tcp"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
name|sin
operator|.
name|sin_port
operator|=
name|sp
operator|->
name|s_port
expr_stmt|;
do|do
block|{
name|server
operator|=
name|socket
argument_list|(
name|AF_INET
argument_list|,
name|SOCK_STREAM
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|server
operator|<
literal|0
condition|)
block|{
name|perror
argument_list|(
literal|"nntpxfer: socket"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|connect
argument_list|(
name|server
argument_list|,
operator|(
expr|struct
name|sockaddr
operator|*
operator|)
operator|&
name|sin
argument_list|,
sizeof|sizeof
argument_list|(
name|sin
argument_list|)
argument_list|)
operator|<
literal|0
condition|)
block|{
ifdef|#
directive|ifdef
name|BSD43
if|if
condition|(
name|hp
operator|&&
name|hp
operator|->
name|h_addr_list
index|[
literal|1
index|]
condition|)
block|{
name|hp
operator|->
name|h_addr_list
operator|++
expr_stmt|;
name|bcopy
argument_list|(
name|hp
operator|->
name|h_addr_list
index|[
literal|0
index|]
argument_list|,
operator|(
name|caddr_t
operator|)
operator|&
name|sin
operator|.
name|sin_addr
argument_list|,
name|hp
operator|->
name|h_length
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|close
argument_list|(
name|server
argument_list|)
expr_stmt|;
continue|continue;
block|}
endif|#
directive|endif
endif|BSD43
name|perror
argument_list|(
literal|"nntpxfer: connect"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
name|connected
operator|++
expr_stmt|;
block|}
do|while
condition|(
name|connected
operator|==
literal|0
condition|)
do|;
ifdef|#
directive|ifdef
name|DEBUG
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"connected to nntp server at %s\n"
argument_list|,
name|argv
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* 	* ok, at this point we're connected to the nntp daemon  	* at the distant host. 	*/
comment|/* get the greeting herald */
operator|(
name|void
operator|)
name|sockread
argument_list|(
name|buf
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|DEBUG
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"%s\n"
argument_list|,
name|buf
argument_list|)
expr_stmt|;
endif|#
directive|endif
if|if
condition|(
name|buf
index|[
literal|0
index|]
operator|!=
literal|'2'
condition|)
comment|/* uh-oh, something's wrong! */
block|{
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"protocol error: got '%s'\n"
argument_list|,
name|buf
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|close
argument_list|(
name|server
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
comment|/* first, tell them we're a slave process to get priority */
name|sockwrite
argument_list|(
literal|"SLAVE"
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|sockread
argument_list|(
name|buf
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|DEBUG
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"%s\n"
argument_list|,
name|buf
argument_list|)
expr_stmt|;
endif|#
directive|endif
if|if
condition|(
name|buf
index|[
literal|0
index|]
operator|!=
literal|'2'
condition|)
comment|/* uh-oh, something's wrong! */
block|{
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"protocol error: got '%s'\n"
argument_list|,
name|buf
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|close
argument_list|(
name|server
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
comment|/* now, ask for a list of new articles */
if|if
condition|(
name|strlen
argument_list|(
name|distributions
argument_list|)
condition|)
operator|(
name|void
operator|)
name|sprintf
argument_list|(
name|buf
argument_list|,
literal|"NEWNEWS %s %s %s GMT<%s>"
argument_list|,
name|newsgroups
argument_list|,
name|lastdate
argument_list|,
name|lasttime
argument_list|,
name|distributions
argument_list|)
expr_stmt|;
else|else
operator|(
name|void
operator|)
name|sprintf
argument_list|(
name|buf
argument_list|,
literal|"NEWNEWS %s %s %s GMT"
argument_list|,
name|newsgroups
argument_list|,
name|lastdate
argument_list|,
name|lasttime
argument_list|)
expr_stmt|;
name|sockwrite
argument_list|(
name|buf
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|sockread
argument_list|(
name|buf
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|DEBUG
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"%s\n"
argument_list|,
name|buf
argument_list|)
expr_stmt|;
endif|#
directive|endif
if|if
condition|(
name|buf
index|[
literal|0
index|]
operator|!=
literal|'2'
condition|)
comment|/* uh-oh, something's wrong! */
block|{
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"protocol error: got '%s'\n"
argument_list|,
name|buf
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|close
argument_list|(
name|server
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
comment|/* and here comes the list, terminated with a "." */
ifdef|#
directive|ifdef
name|DEBUG
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"data\n"
argument_list|)
expr_stmt|;
endif|#
directive|endif
while|while
condition|(
literal|1
condition|)
block|{
operator|(
name|void
operator|)
name|sockread
argument_list|(
name|buf
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|strcmp
argument_list|(
name|buf
argument_list|,
literal|"."
argument_list|)
condition|)
break|break;
if|if
condition|(
name|wewant
argument_list|(
name|buf
argument_list|)
condition|)
block|{
if|if
condition|(
name|newart
operator|>
name|MAXARTS
condition|)
block|{
name|omitupdate
operator|++
expr_stmt|;
continue|continue;
block|}
name|artlist
index|[
name|newart
index|]
operator|=
name|malloc
argument_list|(
call|(
name|unsigned
call|)
argument_list|(
name|strlen
argument_list|(
name|buf
argument_list|)
operator|+
literal|1
argument_list|)
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|strcpy
argument_list|(
name|artlist
index|[
name|newart
index|]
argument_list|,
name|buf
argument_list|)
expr_stmt|;
name|newart
operator|++
expr_stmt|;
block|}
else|else
name|dupart
operator|++
expr_stmt|;
block|}
ifdef|#
directive|ifdef
name|DEBUG
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|".\n%d new, %d dup articles\n"
argument_list|,
name|newart
argument_list|,
name|dupart
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* now that we know which articles we want, retrieve them */
for|for
control|(
name|i
operator|=
literal|1
init|;
name|i
operator|<
name|newart
condition|;
name|i
operator|++
control|)
operator|(
name|void
operator|)
name|artfetch
argument_list|(
name|artlist
index|[
name|i
index|]
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|DEBUG
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"%d missing articles\n"
argument_list|,
name|misart
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* we're all done, so tell them goodbye */
name|sockwrite
argument_list|(
literal|"QUIT"
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|sockread
argument_list|(
name|buf
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|DEBUG
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"%s\n"
argument_list|,
name|buf
argument_list|)
expr_stmt|;
endif|#
directive|endif
if|if
condition|(
name|buf
index|[
literal|0
index|]
operator|!=
literal|'2'
condition|)
comment|/* uh-oh, something's wrong! */
block|{
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"error: got '%s'\n"
argument_list|,
name|buf
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|close
argument_list|(
name|server
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
operator|(
name|void
operator|)
name|close
argument_list|(
name|server
argument_list|)
expr_stmt|;
comment|/* do we want to update the timestamp file? */
if|if
condition|(
operator|!
name|omitupdate
condition|)
block|{
operator|(
name|void
operator|)
name|sprintf
argument_list|(
name|buf
argument_list|,
literal|"%s %06d %06d %s\n"
argument_list|,
name|newsgroups
argument_list|,
name|newdate
argument_list|,
name|newtime
argument_list|,
name|distributions
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|DEBUG
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"updating %s:\n\t%s\n"
argument_list|,
name|dtname
argument_list|,
name|buf
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|dtfile
operator|=
name|fopen
argument_list|(
name|dtname
argument_list|,
literal|"w"
argument_list|)
expr_stmt|;
if|if
condition|(
name|dtfile
operator|==
name|NULL
condition|)
block|{
name|perror
argument_list|(
name|dtname
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
operator|(
name|void
operator|)
name|fputs
argument_list|(
name|buf
argument_list|,
name|dtfile
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|fclose
argument_list|(
name|dtfile
argument_list|)
expr_stmt|;
block|}
name|exit
argument_list|(
literal|0
argument_list|)
expr_stmt|;
block|}
end_function

begin_macro
name|artfetch
argument_list|(
argument|articleid
argument_list|)
end_macro

begin_decl_stmt
name|char
modifier|*
name|articleid
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|int
name|lines
init|=
literal|0
decl_stmt|;
name|char
name|buf
index|[
name|BUFSIZ
index|]
decl_stmt|;
name|FILE
modifier|*
name|inews
decl_stmt|;
comment|/* now, ask for the article */
operator|(
name|void
operator|)
name|sprintf
argument_list|(
name|buf
argument_list|,
literal|"ARTICLE %s"
argument_list|,
name|articleid
argument_list|)
expr_stmt|;
name|sockwrite
argument_list|(
name|buf
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|sockread
argument_list|(
name|buf
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|DEBUG
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"%s\n"
argument_list|,
name|buf
argument_list|)
expr_stmt|;
endif|#
directive|endif
if|if
condition|(
name|buf
index|[
literal|0
index|]
operator|==
literal|'4'
condition|)
comment|/* missing article, just skipit */
block|{
name|misart
operator|++
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
if|if
condition|(
name|buf
index|[
literal|0
index|]
operator|!=
literal|'2'
condition|)
comment|/* uh-oh, something's wrong! */
block|{
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"protocol error: got '%s'\n"
argument_list|,
name|buf
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|close
argument_list|(
name|server
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
ifdef|#
directive|ifdef
name|DEBUG
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"command: %s\n"
argument_list|,
name|INEWS
argument_list|)
expr_stmt|;
endif|#
directive|endif
if|if
condition|(
operator|(
name|inews
operator|=
name|popen
argument_list|(
name|INEWS
argument_list|,
literal|"w"
argument_list|)
operator|)
operator|==
name|NULL
condition|)
block|{
name|perror
argument_list|(
name|INEWS
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
comment|/* and here comes the article, terminated with a "." */
ifdef|#
directive|ifdef
name|DEBUG
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"data\n"
argument_list|)
expr_stmt|;
endif|#
directive|endif
while|while
condition|(
literal|1
condition|)
block|{
operator|(
name|void
operator|)
name|sockread
argument_list|(
name|buf
argument_list|)
expr_stmt|;
if|if
condition|(
name|buf
index|[
literal|0
index|]
operator|==
literal|'.'
operator|&&
name|buf
index|[
literal|1
index|]
operator|==
literal|'\0'
condition|)
break|break;
name|lines
operator|++
expr_stmt|;
operator|(
name|void
operator|)
name|strcat
argument_list|(
name|buf
argument_list|,
literal|"\n"
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|fputs
argument_list|(
operator|(
operator|(
name|buf
index|[
literal|0
index|]
operator|==
literal|'.'
operator|)
condition|?
name|buf
operator|+
literal|1
else|:
name|buf
operator|)
argument_list|,
name|inews
argument_list|)
expr_stmt|;
block|}
ifdef|#
directive|ifdef
name|DEBUG
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|".\n%d lines\n"
argument_list|,
name|lines
argument_list|)
expr_stmt|;
endif|#
directive|endif
operator|(
name|void
operator|)
name|fflush
argument_list|(
name|inews
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|pclose
argument_list|(
name|inews
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_block

begin_function
name|int
name|sockread
parameter_list|(
name|buf
parameter_list|)
name|char
modifier|*
name|buf
decl_stmt|;
block|{
name|char
name|c
decl_stmt|;
name|int
name|j
init|=
literal|0
decl_stmt|;
ifdef|#
directive|ifdef
name|BSD43
name|fd_set
name|rf
decl_stmt|;
else|#
directive|else
else|BSD43
name|int
name|rf
decl_stmt|;
endif|#
directive|endif
endif|BSD43
name|struct
name|timeval
name|tv
decl_stmt|;
name|int
name|r
decl_stmt|;
name|char
modifier|*
name|p
init|=
name|buf
decl_stmt|;
while|while
condition|(
literal|1
condition|)
block|{
name|tv
operator|.
name|tv_sec
operator|=
literal|1800
expr_stmt|;
comment|/* 15 minutes */
name|tv
operator|.
name|tv_usec
operator|=
literal|0L
expr_stmt|;
ifdef|#
directive|ifdef
name|BSD43
name|FD_ZERO
argument_list|(
operator|&
name|rf
argument_list|)
expr_stmt|;
name|FD_SET
argument_list|(
name|server
argument_list|,
operator|&
name|rf
argument_list|)
expr_stmt|;
else|#
directive|else
else|BSD43
name|rf
operator|=
literal|1
operator|<<
name|server
expr_stmt|;
endif|#
directive|endif
endif|BSD43
name|r
operator|=
name|select
argument_list|(
literal|20
argument_list|,
operator|(
name|fd_set
operator|*
operator|)
operator|&
name|rf
argument_list|,
operator|(
name|fd_set
operator|*
operator|)
literal|0
argument_list|,
operator|(
name|fd_set
operator|*
operator|)
operator|&
name|rf
argument_list|,
operator|&
name|tv
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
operator|<
literal|0
condition|)
block|{
if|if
condition|(
name|errno
operator|==
name|EINTR
condition|)
continue|continue;
name|perror
argument_list|(
literal|"getsock select"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|r
operator|==
literal|0
condition|)
block|{
name|printf
argument_list|(
literal|"read timed out.\n"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|read
argument_list|(
name|server
argument_list|,
operator|&
name|c
argument_list|,
literal|1
argument_list|)
operator|<=
literal|0
condition|)
break|break;
comment|/* mask off any chance parity bits */
operator|*
name|p
operator|=
name|c
operator|&
literal|0x7f
expr_stmt|;
comment|/* look for end of line (== LF) */
if|if
condition|(
name|c
operator|==
literal|0x0a
condition|)
block|{
if|if
condition|(
name|j
operator|>
literal|0
operator|&&
operator|*
operator|(
name|p
operator|-
literal|1
operator|)
operator|==
literal|0x0d
condition|)
operator|*
operator|(
name|p
operator|-
literal|1
operator|)
operator|=
literal|'\0'
expr_stmt|;
else|else
operator|*
name|p
operator|=
literal|'\0'
expr_stmt|;
return|return
operator|(
name|strlen
argument_list|(
name|buf
argument_list|)
operator|)
return|;
block|}
name|j
operator|++
expr_stmt|;
name|p
operator|++
expr_stmt|;
block|}
name|perror
argument_list|(
literal|"sockread"
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|close
argument_list|(
name|server
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
comment|/* NOTREACHED */
block|}
end_function

begin_macro
name|sockwrite
argument_list|(
argument|buf
argument_list|)
end_macro

begin_decl_stmt
name|char
modifier|*
name|buf
decl_stmt|;
end_decl_stmt

begin_block
block|{
specifier|register
name|int
name|sz
decl_stmt|;
name|char
name|buf2
index|[
name|BUFSIZ
index|]
decl_stmt|;
ifdef|#
directive|ifdef
name|DEBUG
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|">>> %s\n"
argument_list|,
name|buf
argument_list|)
expr_stmt|;
endif|#
directive|endif
operator|(
name|void
operator|)
name|strcpy
argument_list|(
name|buf2
argument_list|,
name|buf
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|strcat
argument_list|(
name|buf2
argument_list|,
literal|"\r\n"
argument_list|)
expr_stmt|;
name|sz
operator|=
name|strlen
argument_list|(
name|buf2
argument_list|)
expr_stmt|;
if|if
condition|(
name|write
argument_list|(
name|server
argument_list|,
name|buf2
argument_list|,
name|sz
argument_list|)
operator|!=
name|sz
condition|)
block|{
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"write error on server socket\n"
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|close
argument_list|(
name|server
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
block|}
end_block

begin_function
name|int
name|wewant
parameter_list|(
name|articleid
parameter_list|)
name|char
modifier|*
name|articleid
decl_stmt|;
block|{
name|datum
name|k
decl_stmt|,
name|d
decl_stmt|;
name|char
name|id
index|[
name|BUFSIZ
index|]
decl_stmt|;
name|char
modifier|*
name|p
decl_stmt|;
comment|/* remove any case sensitivity */
operator|(
name|void
operator|)
name|strcpy
argument_list|(
name|id
argument_list|,
name|articleid
argument_list|)
expr_stmt|;
name|p
operator|=
name|id
expr_stmt|;
while|while
condition|(
operator|*
name|p
condition|)
block|{
if|if
condition|(
name|isupper
argument_list|(
operator|*
name|p
argument_list|)
condition|)
operator|*
name|p
operator|=
name|tolower
argument_list|(
operator|*
name|p
argument_list|)
expr_stmt|;
name|p
operator|++
expr_stmt|;
block|}
name|k
operator|.
name|dptr
operator|=
name|id
expr_stmt|;
name|k
operator|.
name|dsize
operator|=
name|strlen
argument_list|(
name|articleid
argument_list|)
operator|+
literal|1
expr_stmt|;
name|d
operator|=
name|fetch
argument_list|(
name|k
argument_list|)
expr_stmt|;
if|if
condition|(
name|d
operator|.
name|dptr
condition|)
block|{
ifdef|#
directive|ifdef
name|DEBUG
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"dup: '%s'\n"
argument_list|,
name|articleid
argument_list|)
expr_stmt|;
endif|#
directive|endif
return|return
operator|(
literal|0
operator|)
return|;
block|}
ifdef|#
directive|ifdef
name|DEBUG
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"new: '%s'\n"
argument_list|,
name|articleid
argument_list|)
expr_stmt|;
endif|#
directive|endif
return|return
operator|(
literal|1
operator|)
return|;
block|}
end_function

end_unit


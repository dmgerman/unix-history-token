begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_ifndef
ifndef|#
directive|ifndef
name|lint
end_ifndef

begin_decl_stmt
specifier|static
name|char
modifier|*
name|sccsid
init|=
literal|"@(#)time.c	1.7	(Berkeley) 6/26/87"
decl_stmt|;
end_decl_stmt

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/*  * Collection of routines for dealing with ASCII time strings.  * These may actually be useful in their own right.  */
end_comment

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_include
include|#
directive|include
file|<sys/types.h>
end_include

begin_include
include|#
directive|include
file|<sys/time.h>
end_include

begin_include
include|#
directive|include
file|<ctype.h>
end_include

begin_include
include|#
directive|include
file|<strings.h>
end_include

begin_comment
comment|/*  * dtol -- convert date to long integer.  This is not implicitly  * local time, or any other kind of time, for that matter.  If you  * pass it a date you think is GMT, you wind up with that number of  * seconds...  *  *	Parameters:		"date_ascii" is in the form "yymmddhhmmss".  *  *	Returns:		Long integer containing number  *				of seconds since 000000 Jan 1, 1970,  *				and "date".  -1 on error.  *  *	Side effects:		None.  */
end_comment

begin_define
define|#
directive|define
name|twodigtoi
parameter_list|(
name|x
parameter_list|)
value|(((x[0]) - '0') + (x[1] - '0')*10)
end_define

begin_define
define|#
directive|define
name|dysize
parameter_list|(
name|y
parameter_list|)
value|((y % 4 ? 365 : 366))
end_define

begin_decl_stmt
specifier|static
name|int
name|dmsize
index|[
literal|12
index|]
init|=
block|{
literal|31
block|,
literal|28
block|,
literal|31
block|,
literal|30
block|,
literal|31
block|,
literal|30
block|,
literal|31
block|,
literal|31
block|,
literal|30
block|,
literal|31
block|,
literal|30
block|,
literal|31
block|}
decl_stmt|;
end_decl_stmt

begin_function
name|long
name|dtol
parameter_list|(
name|date_ascii
parameter_list|)
name|char
modifier|*
name|date_ascii
decl_stmt|;
block|{
name|char
name|date
index|[
literal|32
index|]
decl_stmt|,
modifier|*
name|date_str
decl_stmt|;
name|char
modifier|*
name|lhs
decl_stmt|,
modifier|*
name|rhs
decl_stmt|;
name|char
name|temp
decl_stmt|;
name|long
name|seconds
decl_stmt|;
name|int
name|year
decl_stmt|,
name|month
decl_stmt|,
name|day
decl_stmt|,
name|hour
decl_stmt|,
name|mins
decl_stmt|,
name|secs
decl_stmt|;
name|int
name|len
decl_stmt|,
name|i
decl_stmt|;
name|len
operator|=
name|strlen
argument_list|(
name|date_ascii
argument_list|)
expr_stmt|;
if|if
condition|(
name|len
operator|!=
sizeof|sizeof
argument_list|(
literal|"yymmddhhmmss"
argument_list|)
operator|-
literal|1
condition|)
return|return
operator|(
operator|-
literal|1
operator|)
return|;
operator|(
name|void
operator|)
name|strcpy
argument_list|(
name|date
argument_list|,
name|date_ascii
argument_list|)
expr_stmt|;
name|date_str
operator|=
name|date
expr_stmt|;
ifdef|#
directive|ifdef
name|debug
name|printf
argument_list|(
literal|"date_str = %s\n"
argument_list|,
name|date_str
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|rhs
operator|=
name|date_str
operator|+
name|len
operator|-
literal|1
expr_stmt|;
name|lhs
operator|=
name|date_str
expr_stmt|;
for|for
control|(
init|;
name|lhs
operator|<
name|rhs
condition|;
operator|++
name|lhs
operator|,
operator|--
name|rhs
control|)
block|{
name|temp
operator|=
operator|*
name|lhs
expr_stmt|;
operator|*
name|lhs
operator|=
operator|*
name|rhs
expr_stmt|;
operator|*
name|rhs
operator|=
name|temp
expr_stmt|;
if|if
condition|(
operator|!
name|isdigit
argument_list|(
name|temp
argument_list|)
operator|||
operator|!
name|isdigit
argument_list|(
operator|*
name|lhs
argument_list|)
condition|)
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
name|lhs
operator|=
name|date_str
expr_stmt|;
ifdef|#
directive|ifdef
name|debug
name|printf
argument_list|(
literal|"date_str = %s\n"
argument_list|,
name|date_str
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|secs
operator|=
name|twodigtoi
argument_list|(
name|lhs
argument_list|)
expr_stmt|;
name|lhs
operator|+=
literal|2
expr_stmt|;
name|mins
operator|=
name|twodigtoi
argument_list|(
name|lhs
argument_list|)
expr_stmt|;
name|lhs
operator|+=
literal|2
expr_stmt|;
name|hour
operator|=
name|twodigtoi
argument_list|(
name|lhs
argument_list|)
expr_stmt|;
name|lhs
operator|+=
literal|2
expr_stmt|;
name|day
operator|=
name|twodigtoi
argument_list|(
name|lhs
argument_list|)
expr_stmt|;
name|lhs
operator|+=
literal|2
expr_stmt|;
name|month
operator|=
name|twodigtoi
argument_list|(
name|lhs
argument_list|)
expr_stmt|;
name|lhs
operator|+=
literal|2
expr_stmt|;
name|year
operator|=
name|twodigtoi
argument_list|(
name|lhs
argument_list|)
expr_stmt|;
if|if
condition|(
name|month
operator|<
literal|1
operator|||
name|month
operator|>
literal|12
operator|||
name|day
operator|<
literal|1
operator|||
name|day
operator|>
literal|31
operator|||
name|mins
operator|<
literal|0
operator|||
name|mins
operator|>
literal|59
operator|||
name|secs
operator|<
literal|0
operator|||
name|secs
operator|>
literal|59
condition|)
return|return
operator|(
operator|-
literal|1
operator|)
return|;
if|if
condition|(
name|hour
operator|==
literal|24
condition|)
block|{
name|hour
operator|=
literal|0
expr_stmt|;
name|day
operator|++
expr_stmt|;
block|}
if|if
condition|(
name|hour
operator|<
literal|0
operator|||
name|hour
operator|>
literal|23
condition|)
return|return
operator|(
operator|-
literal|1
operator|)
return|;
name|seconds
operator|=
literal|0
expr_stmt|;
name|year
operator|+=
literal|1900
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|1970
init|;
name|i
operator|<
name|year
condition|;
name|i
operator|++
control|)
name|seconds
operator|+=
name|dysize
argument_list|(
name|i
argument_list|)
expr_stmt|;
comment|/* Leap year */
if|if
condition|(
name|dysize
argument_list|(
name|year
argument_list|)
operator|==
literal|366
operator|&&
name|month
operator|>=
literal|3
condition|)
name|seconds
operator|++
expr_stmt|;
while|while
condition|(
operator|--
name|month
condition|)
name|seconds
operator|+=
name|dmsize
index|[
name|month
operator|-
literal|1
index|]
expr_stmt|;
name|seconds
operator|+=
name|day
operator|-
literal|1
expr_stmt|;
name|seconds
operator|=
literal|24
operator|*
name|seconds
operator|+
name|hour
expr_stmt|;
name|seconds
operator|=
literal|60
operator|*
name|seconds
operator|+
name|mins
expr_stmt|;
name|seconds
operator|=
literal|60
operator|*
name|seconds
operator|+
name|secs
expr_stmt|;
return|return
operator|(
name|seconds
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * ltod -- convert long integer to date string.  *  *	Parameters:		"date" is in the number of seconds  *				since the epoch.  *  *	Returns:		Pointer to static data in the form  *				yymmddhhmmss\0.  *  *	Side effects:		None.  */
end_comment

begin_function
name|char
modifier|*
name|ltod
parameter_list|(
name|date
parameter_list|)
name|long
name|date
decl_stmt|;
block|{
specifier|static
name|char
name|timebuf
index|[
literal|32
index|]
decl_stmt|;
name|struct
name|tm
modifier|*
name|tp
decl_stmt|;
name|tp
operator|=
name|gmtime
argument_list|(
operator|&
name|date
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|sprintf
argument_list|(
name|timebuf
argument_list|,
literal|"%02d%02d%02d%02d%02d%02d"
argument_list|,
name|tp
operator|->
name|tm_year
argument_list|,
name|tp
operator|->
name|tm_mon
operator|+
literal|1
argument_list|,
comment|/* 0 to 11??? How silly. */
name|tp
operator|->
name|tm_mday
argument_list|,
name|tp
operator|->
name|tm_hour
argument_list|,
name|tp
operator|->
name|tm_min
argument_list|,
name|tp
operator|->
name|tm_sec
argument_list|)
expr_stmt|;
return|return
operator|(
name|timebuf
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * local_to_gmt -- convert a local time (in form of number of  * seconds since you-know-when) to GMT.  *  *	Parameters:	"date" is date we want converted, in  *			seconds since 000000 1 Jan 1970.  *  *	Returns:	Number of seconds corrected for local  *			and dst.  */
end_comment

begin_function
name|long
name|local_to_gmt
parameter_list|(
name|date
parameter_list|)
name|long
name|date
decl_stmt|;
block|{
name|struct
name|timeval
name|tv
decl_stmt|;
name|struct
name|timezone
name|tz
decl_stmt|;
operator|(
name|void
operator|)
name|gettimeofday
argument_list|(
operator|&
name|tv
argument_list|,
operator|&
name|tz
argument_list|)
expr_stmt|;
name|date
operator|+=
operator|(
name|long
operator|)
name|tz
operator|.
name|tz_minuteswest
operator|*
literal|60
expr_stmt|;
comment|/* now fix up local daylight time */
if|if
condition|(
name|localtime
argument_list|(
operator|(
name|time_t
operator|*
operator|)
operator|&
name|date
argument_list|)
operator|->
name|tm_isdst
condition|)
name|date
operator|-=
literal|60
operator|*
literal|60
expr_stmt|;
return|return
operator|(
name|date
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * gmt_to_local -- take a GMT time expressed in seconds since  * the epoch, and convert it to local time.  *  *	Parameters:	"date" is the number of seconds...  *  *	Returns:	Number of seconds corrected to reflect  *			local time and dst.  */
end_comment

begin_function
name|long
name|gmt_to_local
parameter_list|(
name|date
parameter_list|)
name|long
name|date
decl_stmt|;
block|{
name|struct
name|timeval
name|tv
decl_stmt|;
name|struct
name|timezone
name|tz
decl_stmt|;
operator|(
name|void
operator|)
name|gettimeofday
argument_list|(
operator|&
name|tv
argument_list|,
operator|&
name|tz
argument_list|)
expr_stmt|;
name|date
operator|-=
operator|(
name|long
operator|)
name|tz
operator|.
name|tz_minuteswest
operator|*
literal|60
expr_stmt|;
comment|/* now fix up local daylight time */
if|if
condition|(
name|localtime
argument_list|(
operator|(
name|time_t
operator|*
operator|)
operator|&
name|date
argument_list|)
operator|->
name|tm_isdst
condition|)
name|date
operator|+=
literal|60
operator|*
literal|60
expr_stmt|;
return|return
operator|(
name|date
operator|)
return|;
block|}
end_function

end_unit


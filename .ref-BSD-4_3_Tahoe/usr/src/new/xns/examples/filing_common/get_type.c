begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_ifndef
ifndef|#
directive|ifndef
name|lint
end_ifndef

begin_decl_stmt
specifier|static
name|char
modifier|*
name|rcsid
init|=
literal|"$Header: get_type.c,v 1.2 87/04/01 10:09:16 ed Exp $"
decl_stmt|;
end_decl_stmt

begin_endif
endif|#
directive|endif
endif|lint
end_endif

begin_comment
comment|/*  * Copyright (c) 1986, 1987 Xerox Corporation.  */
end_comment

begin_comment
comment|/* $Log:	get_type.c,v $  * Revision 1.2  87/04/01  10:09:16  ed  * Lots of new Viewpoint related types and how to recognize them.  *   * Revision 1.1  87/01/14  11:26:06  ed  * Initial revision  *   *   */
end_comment

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_include
include|#
directive|include
file|<sys/types.h>
end_include

begin_include
include|#
directive|include
file|<sys/stat.h>
end_include

begin_include
include|#
directive|include
file|<netns/ns.h>
end_include

begin_include
include|#
directive|include
file|<netns/sp.h>
end_include

begin_include
include|#
directive|include
file|<xnscourier/filetypes.h>
end_include

begin_include
include|#
directive|include
file|<xnscourier/courier.h>
end_include

begin_define
define|#
directive|define
name|CHARS_TO_READ
value|2048
end_define

begin_comment
comment|/*  * routine:  *	get_type  * input:  *	pointer to pathname of file  *	read first CHARS_TO_READ  *		if it contains "RasterEncoding/", assume RES (return TYPE_VPCanvas)  *		if it contains "Interpress/Xerox/", assume IP (return TYPE_Interpress)  *		if a char is 0 or high order bit set, assume binary (return tUNSPECIFIED)  *		else assume text (tText)  *	(Note order of RES/IP checking is important since RES files contain   *	 IP string also)  *  * returns:  *	LongCardinal containing filing defined file type  */
end_comment

begin_function
name|LongCardinal
name|get_type
parameter_list|(
name|pathname
parameter_list|)
name|char
modifier|*
name|pathname
decl_stmt|;
block|{
name|FILE
modifier|*
name|file_desc
decl_stmt|;
name|char
name|buffer
index|[
name|CHARS_TO_READ
index|]
decl_stmt|;
name|int
name|count
decl_stmt|;
name|char
modifier|*
name|ptr
decl_stmt|,
modifier|*
name|rindex
argument_list|()
decl_stmt|;
name|LongCardinal
name|type
decl_stmt|,
name|GetTypeAttribute
argument_list|()
decl_stmt|;
name|Boolean
name|is_type
parameter_list|()
function_decl|;
name|struct
name|stat
name|fs
decl_stmt|;
if|if
condition|(
name|stat
argument_list|(
name|pathname
argument_list|,
operator|&
name|fs
argument_list|)
operator|==
operator|-
literal|1
condition|)
return|return
operator|(
name|TYPE_I
operator|)
return|;
comment|/* if error, assume tUnspecified */
comment|/* 	 * if not a regular file look for directory... 	 * if a directory and in root, then assume file drawer 	 */
if|if
condition|(
operator|(
name|fs
operator|.
name|st_mode
operator|&
name|S_IFMT
operator|)
operator|!=
name|S_IFREG
condition|)
block|{
if|if
condition|(
operator|(
name|fs
operator|.
name|st_mode
operator|&
name|S_IFDIR
operator|)
operator|!=
literal|0
condition|)
block|{
if|if
condition|(
name|rindex
argument_list|(
name|pathname
argument_list|,
literal|'/'
argument_list|)
operator|==
name|pathname
condition|)
return|return
operator|(
name|TYPE_VPDrawer
operator|)
return|;
else|else
return|return
operator|(
name|TYPE_Directory
operator|)
return|;
block|}
else|else
return|return
operator|(
name|TYPE_I
operator|)
return|;
block|}
if|if
condition|(
operator|(
name|file_desc
operator|=
name|fopen
argument_list|(
name|pathname
argument_list|,
literal|"r"
argument_list|)
operator|)
operator|==
name|NULL
condition|)
return|return
operator|(
name|TYPE_I
operator|)
return|;
comment|/* if error, assume tUnspecified */
if|if
condition|(
operator|(
name|count
operator|=
name|fread
argument_list|(
name|buffer
argument_list|,
sizeof|sizeof
argument_list|(
name|char
argument_list|)
argument_list|,
name|CHARS_TO_READ
argument_list|,
name|file_desc
argument_list|)
operator|)
operator|==
literal|0
condition|)
name|type
operator|=
name|TYPE_I
expr_stmt|;
comment|/* if error, assume tUnspecified */
else|else
block|{
if|if
condition|(
name|is_type
argument_list|(
name|buffer
argument_list|,
name|RESHDR
argument_list|)
operator|==
name|TRUE
condition|)
block|{
name|type
operator|=
name|TYPE_VPCanvas
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|is_type
argument_list|(
name|buffer
argument_list|,
name|INTERPRESSHDR
argument_list|)
operator|==
name|TRUE
condition|)
block|{
name|type
operator|=
name|TYPE_Interpress
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|is_type
argument_list|(
name|buffer
argument_list|,
name|VPHDR
argument_list|)
operator|==
name|TRUE
condition|)
block|{
name|type
operator|=
name|GetTypeAttribute
argument_list|(
name|file_desc
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|type
operator|=
name|TYPE_A
expr_stmt|;
comment|/* assume tAsciiText */
for|for
control|(
name|ptr
operator|=
name|buffer
init|;
name|ptr
operator|<
name|buffer
operator|+
name|count
operator|-
literal|1
condition|;
control|)
block|{
comment|/* for each character */
if|if
condition|(
operator|(
operator|*
name|ptr
operator|==
literal|0
operator|)
operator|||
operator|(
operator|*
name|ptr
operator|++
operator|&
literal|0200
operator|)
condition|)
block|{
comment|/* if 0 or high order bit */
name|type
operator|=
name|TYPE_I
expr_stmt|;
comment|/* assume tUnspecified */
break|break;
block|}
block|}
block|}
block|}
name|fclose
argument_list|(
name|file_desc
argument_list|)
expr_stmt|;
comment|/* close file */
return|return
operator|(
name|type
operator|)
return|;
block|}
end_function

begin_function
name|Boolean
name|is_type
parameter_list|(
name|string1
parameter_list|,
name|string2
parameter_list|)
name|char
modifier|*
name|string1
decl_stmt|,
decl|*
name|string2
decl_stmt|;
end_function

begin_block
block|{
name|char
name|string
index|[
literal|128
index|]
decl_stmt|;
comment|/* 128 should be enough for all cases */
name|char
modifier|*
name|ptr
decl_stmt|;
name|int
name|i
decl_stmt|,
name|len
decl_stmt|;
name|bcopy
argument_list|(
name|string1
argument_list|,
name|string
argument_list|,
literal|128
argument_list|)
expr_stmt|;
name|lowercasen
argument_list|(
name|string
argument_list|,
literal|128
argument_list|)
expr_stmt|;
name|len
operator|=
name|strlen
argument_list|(
name|string2
argument_list|)
expr_stmt|;
comment|/* if we don't get a match in the first 50 characters, chances are 	 * it's not Interpress or RES 	 */
for|for
control|(
name|ptr
operator|=
name|string
operator|,
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|50
condition|;
name|ptr
operator|++
operator|,
name|i
operator|++
control|)
block|{
if|if
condition|(
name|bcmp
argument_list|(
name|string2
argument_list|,
name|ptr
argument_list|,
name|len
argument_list|)
operator|==
literal|0
condition|)
return|return
operator|(
name|TRUE
operator|)
return|;
block|}
return|return
operator|(
name|FALSE
operator|)
return|;
block|}
end_block

begin_function
name|char
modifier|*
name|typetostring
parameter_list|(
name|type
parameter_list|)
name|LongCardinal
name|type
decl_stmt|;
block|{
specifier|static
name|char
name|string
index|[
literal|80
index|]
decl_stmt|;
switch|switch
condition|(
name|type
condition|)
block|{
case|case
name|TYPE_A
case|:
return|return
operator|(
literal|"text"
operator|)
return|;
case|case
name|TYPE_I
case|:
return|return
operator|(
literal|"binary"
operator|)
return|;
case|case
name|TYPE_Directory
case|:
return|return
operator|(
literal|"directory"
operator|)
return|;
case|case
name|TYPE_VP
case|:
return|return
operator|(
literal|"VP doc"
operator|)
return|;
case|case
name|TYPE_Interpress
case|:
return|return
operator|(
literal|"Interpress"
operator|)
return|;
case|case
name|TYPE_VPCanvas
case|:
return|return
operator|(
literal|"VP Canvas"
operator|)
return|;
case|case
name|TYPE_VPDictionary
case|:
return|return
operator|(
literal|"VP Dictionary"
operator|)
return|;
case|case
name|TYPE_VPMailNote
case|:
return|return
operator|(
literal|"VP MailNote"
operator|)
return|;
case|case
name|TYPE_VPReference
case|:
return|return
operator|(
literal|"VP Reference"
operator|)
return|;
case|case
name|TYPE_S
case|:
return|return
operator|(
literal|"serialized"
operator|)
return|;
case|case
name|TYPE_VPDrawer
case|:
return|return
operator|(
literal|"VP file drawer"
operator|)
return|;
case|case
name|TYPE_VPApplication
case|:
return|return
operator|(
literal|"VP application"
operator|)
return|;
case|case
name|TYPE_VPApplication2
case|:
return|return
operator|(
literal|"VP application"
operator|)
return|;
case|case
name|TYPE_VPSpreadsheet
case|:
return|return
operator|(
literal|"VP spreadsheet"
operator|)
return|;
case|case
name|TYPE_VPBook
case|:
return|return
operator|(
literal|"VP Book"
operator|)
return|;
case|case
name|TYPE_VPRecordsfile
case|:
return|return
operator|(
literal|"VP RecordFile"
operator|)
return|;
case|case
name|TYPE_VPCalendar
case|:
return|return
operator|(
literal|"VP Calendar"
operator|)
return|;
case|case
name|TYPE_VPIcons
case|:
return|return
operator|(
literal|"VP Icons"
operator|)
return|;
case|case
name|TYPE_Font
case|:
return|return
operator|(
literal|"Printer Font"
operator|)
return|;
case|case
name|TYPE_860
case|:
return|return
operator|(
literal|"860 doc"
operator|)
return|;
default|default :
name|sprintf
argument_list|(
name|string
argument_list|,
literal|"%d"
argument_list|,
name|type
argument_list|)
expr_stmt|;
return|return
operator|(
name|string
operator|)
return|;
block|}
block|}
end_function

begin_function
name|LongCardinal
name|stringtotype
parameter_list|(
name|string
parameter_list|)
name|char
modifier|*
name|string
decl_stmt|;
block|{
if|if
condition|(
operator|*
name|string
operator|==
literal|'\0'
condition|)
return|return
operator|(
name|TYPE_VPMailNote
operator|)
return|;
name|lowercase
argument_list|(
name|string
argument_list|)
expr_stmt|;
if|if
condition|(
name|strcmp
argument_list|(
name|string
argument_list|,
literal|"text"
argument_list|)
operator|==
literal|0
condition|)
return|return
operator|(
name|TYPE_A
operator|)
return|;
if|if
condition|(
name|strcmp
argument_list|(
name|string
argument_list|,
literal|"binary"
argument_list|)
operator|==
literal|0
condition|)
return|return
operator|(
name|TYPE_I
operator|)
return|;
if|if
condition|(
name|strcmp
argument_list|(
name|string
argument_list|,
literal|"directory"
argument_list|)
operator|==
literal|0
condition|)
return|return
operator|(
name|TYPE_Directory
operator|)
return|;
if|if
condition|(
name|strcmp
argument_list|(
name|string
argument_list|,
literal|"vp doc"
argument_list|)
operator|==
literal|0
condition|)
return|return
operator|(
name|TYPE_VP
operator|)
return|;
if|if
condition|(
name|strcmp
argument_list|(
name|string
argument_list|,
literal|"interpress"
argument_list|)
operator|==
literal|0
condition|)
return|return
operator|(
name|TYPE_Interpress
operator|)
return|;
if|if
condition|(
name|strcmp
argument_list|(
name|string
argument_list|,
literal|"vp canvas"
argument_list|)
operator|==
literal|0
condition|)
return|return
operator|(
name|TYPE_VPCanvas
operator|)
return|;
if|if
condition|(
name|strcmp
argument_list|(
name|string
argument_list|,
literal|"vp dictionary"
argument_list|)
operator|==
literal|0
condition|)
return|return
operator|(
name|TYPE_VPDictionary
operator|)
return|;
if|if
condition|(
name|strcmp
argument_list|(
name|string
argument_list|,
literal|"vp mailnote"
argument_list|)
operator|==
literal|0
condition|)
return|return
operator|(
name|TYPE_VPMailNote
operator|)
return|;
if|if
condition|(
name|strcmp
argument_list|(
name|string
argument_list|,
literal|"vp reference"
argument_list|)
operator|==
literal|0
condition|)
return|return
operator|(
name|TYPE_VPReference
operator|)
return|;
if|if
condition|(
name|strcmp
argument_list|(
name|string
argument_list|,
literal|"serialized"
argument_list|)
operator|==
literal|0
condition|)
return|return
operator|(
name|TYPE_S
operator|)
return|;
if|if
condition|(
name|strcmp
argument_list|(
name|string
argument_list|,
literal|"vp filedrawer"
argument_list|)
operator|==
literal|0
condition|)
return|return
operator|(
name|TYPE_VPDrawer
operator|)
return|;
if|if
condition|(
name|strcmp
argument_list|(
name|string
argument_list|,
literal|"vp application"
argument_list|)
operator|==
literal|0
condition|)
return|return
operator|(
name|TYPE_VPApplication
operator|)
return|;
if|if
condition|(
name|strcmp
argument_list|(
name|string
argument_list|,
literal|"vp spreadsheet"
argument_list|)
operator|==
literal|0
condition|)
return|return
operator|(
name|TYPE_VPSpreadsheet
operator|)
return|;
if|if
condition|(
name|strcmp
argument_list|(
name|string
argument_list|,
literal|"vp book"
argument_list|)
operator|==
literal|0
condition|)
return|return
operator|(
name|TYPE_VPBook
operator|)
return|;
if|if
condition|(
name|strcmp
argument_list|(
name|string
argument_list|,
literal|"vp recordfile"
argument_list|)
operator|==
literal|0
condition|)
return|return
operator|(
name|TYPE_VPRecordsfile
operator|)
return|;
if|if
condition|(
name|strcmp
argument_list|(
name|string
argument_list|,
literal|"vp calendar"
argument_list|)
operator|==
literal|0
condition|)
return|return
operator|(
name|TYPE_VPCalendar
operator|)
return|;
if|if
condition|(
name|strcmp
argument_list|(
name|string
argument_list|,
literal|"vp icons"
argument_list|)
operator|==
literal|0
condition|)
return|return
operator|(
name|TYPE_VPIcons
operator|)
return|;
if|if
condition|(
name|strcmp
argument_list|(
name|string
argument_list|,
literal|"printerfont"
argument_list|)
operator|==
literal|0
condition|)
return|return
operator|(
name|TYPE_Font
operator|)
return|;
if|if
condition|(
name|strcmp
argument_list|(
name|string
argument_list|,
literal|"860 doc"
argument_list|)
operator|==
literal|0
condition|)
return|return
operator|(
name|TYPE_860
operator|)
return|;
return|return
operator|(
name|atoi
argument_list|(
name|string
argument_list|)
operator|)
return|;
block|}
end_function

end_unit


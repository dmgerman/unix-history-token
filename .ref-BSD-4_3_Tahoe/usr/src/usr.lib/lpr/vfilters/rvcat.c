begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Copyright (c) 1983 Regents of the University of California.  * All rights reserved.  *  * Redistribution and use in source and binary forms are permitted  * provided that the above copyright notice and this paragraph are  * duplicated in all such forms and that any documentation,  * advertising materials, and other materials related to such  * distribution and use acknowledge that the software was developed  * by the University of California, Berkeley.  The name of the  * University may not be used to endorse or promote products derived  * from this software without specific prior written permission.  * THIS SOFTWARE IS PROVIDED ``AS IS'' AND WITHOUT ANY EXPRESS OR  * IMPLIED WARRANTIES, INCLUDING, WITHOUT LIMITATION, THE IMPLIED  * WARRANTIES OF MERCHANTIBILITY AND FITNESS FOR A PARTICULAR PURPOSE.  */
end_comment

begin_ifndef
ifndef|#
directive|ifndef
name|lint
end_ifndef

begin_decl_stmt
name|char
name|copyright
index|[]
init|=
literal|"@(#) Copyright (c) 1983 Regents of the University of California.\n\  All rights reserved.\n"
decl_stmt|;
end_decl_stmt

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* not lint */
end_comment

begin_ifndef
ifndef|#
directive|ifndef
name|lint
end_ifndef

begin_decl_stmt
specifier|static
name|char
name|sccsid
index|[]
init|=
literal|"@(#)rvcat.c	5.4 (Berkeley) 6/30/88"
decl_stmt|;
end_decl_stmt

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* not lint */
end_comment

begin_comment
comment|/*  * Cat Simulator for Versatec and Varian  * Modified for Varian with rotated fonts: wnj 5/30/80.  *  * Takes two extra special codes defined by rvsort:  *	0115 - break for new page, goto (0,0)  *	0116 - lead 64* following byte  */
end_comment

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_include
include|#
directive|include
file|<sys/vcmd.h>
end_include

begin_include
include|#
directive|include
file|<vfont.h>
end_include

begin_decl_stmt
name|int
name|prtmode
index|[]
init|=
block|{
name|VPRINT
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|pltmode
index|[]
init|=
block|{
name|VPLOT
block|}
decl_stmt|;
end_decl_stmt

begin_define
define|#
directive|define
name|DISPATCHSIZE
value|256
end_define

begin_comment
comment|/* must be a power of two */
end_comment

begin_define
define|#
directive|define
name|CHARMASK
value|(DISPATCHSIZE-1)
end_define

begin_define
define|#
directive|define
name|NFONTS
value|25
end_define

begin_define
define|#
directive|define
name|SPECIALFONT
value|3
end_define

begin_define
define|#
directive|define
name|DSIZ
value|((sizeof *dispatch)*DISPATCHSIZE)
end_define

begin_define
define|#
directive|define
name|MAXF
value|4
end_define

begin_define
define|#
directive|define
name|LOCAL_RAILMAG
value|".railmag"
end_define

begin_define
define|#
directive|define
name|GLOBAL_RAILMAG
value|"/usr/lib/vfont/railmag"
end_define

begin_comment
comment|/*  * Here we make up for the fact that we only have 2112  * bits vertically when we need 2200 (11''*200/in), by  * a 4% vertical size squashing.  */
end_comment

begin_define
define|#
directive|define
name|CONVERT
parameter_list|(
name|n
parameter_list|)
value|((n*(200./432.))*(2112./2200.))
end_define

begin_define
define|#
directive|define
name|RECONVERT
parameter_list|(
name|n
parameter_list|)
value|((n*(432./200.))*(2200./2112.))
end_define

begin_define
define|#
directive|define
name|NLINES
value|110
end_define

begin_define
define|#
directive|define
name|FF_LINES
value|1600
end_define

begin_comment
comment|/* Scan lines to output before formfeeding. */
end_comment

begin_define
define|#
directive|define
name|min
parameter_list|(
name|a
parameter_list|,
name|b
parameter_list|)
value|(a<b ? a : b)
end_define

begin_decl_stmt
name|char
name|buffer
index|[
name|NLINES
operator|*
literal|264
index|]
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* Big enough for varain */
end_comment

begin_decl_stmt
name|char
modifier|*
name|buf0p
init|=
operator|&
name|buffer
index|[
literal|0
index|]
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* Zero origin in circular buffer */
end_comment

begin_function_decl
name|char
modifier|*
name|calloc
parameter_list|()
function_decl|;
end_function_decl

begin_function_decl
name|char
modifier|*
name|nalloc
parameter_list|()
function_decl|;
end_function_decl

begin_function_decl
name|char
modifier|*
name|allpanic
parameter_list|()
function_decl|;
end_function_decl

begin_decl_stmt
name|struct
name|header
name|header
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|struct
name|dispatch
modifier|*
name|dispatch
decl_stmt|;
end_decl_stmt

begin_struct
struct|struct
name|fontdes
block|{
name|int
name|fnum
decl_stmt|;
name|int
name|psize
decl_stmt|;
name|struct
name|dispatch
modifier|*
name|disp
decl_stmt|;
name|char
modifier|*
name|bits
decl_stmt|;
block|}
name|fontdes
index|[
name|NFONTS
index|]
init|=
block|{
operator|-
literal|1
block|,
operator|-
literal|1
block|}
struct|;
end_struct

begin_struct
struct|struct
name|point_sizes
block|{
name|int
name|stupid_code
decl_stmt|;
name|int
name|real_code
decl_stmt|;
block|}
name|point_sizes
index|[]
init|=
block|{
literal|010
block|,
literal|6
block|,
literal|0
block|,
literal|7
block|,
literal|01
block|,
literal|8
block|,
literal|07
block|,
literal|9
block|,
literal|02
block|,
literal|10
block|,
literal|03
block|,
literal|11
block|,
literal|04
block|,
literal|12
block|,
literal|05
block|,
literal|14
block|,
literal|0211
block|,
literal|16
block|,
literal|06
block|,
literal|18
block|,
literal|0212
block|,
literal|20
block|,
literal|0213
block|,
literal|22
block|,
literal|0214
block|,
literal|24
block|,
literal|0215
block|,
literal|28
block|,
literal|0216
block|,
literal|36
block|,
literal|0
block|,
literal|0
block|}
struct|;
end_struct

begin_decl_stmt
name|int
name|lines
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|vc
init|=
literal|1
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* varian/versatec output file descriptor */
end_comment

begin_decl_stmt
name|int
name|varian
init|=
literal|1
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* 0 for versatec, 1 for varian. */
end_comment

begin_decl_stmt
name|int
name|BYTES_PER_LINE
init|=
literal|264
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* number of bytes per raster line. */
end_comment

begin_decl_stmt
name|int
name|PAGE_LINES
init|=
literal|1700
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* number of raster lines per page. */
end_comment

begin_decl_stmt
name|int
name|BUFFER_SIZE
init|=
name|NLINES
operator|*
literal|264
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* buffer size. */
end_comment

begin_decl_stmt
name|int
name|cfnum
init|=
operator|-
literal|1
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|cpsize
init|=
literal|10
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|cfont
init|=
literal|1
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|char
modifier|*
name|bits
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|nfontnum
init|=
operator|-
literal|1
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|fontwanted
init|=
literal|1
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|npsize
init|=
literal|10
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|last_ssize
init|=
literal|02
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|xpos
decl_stmt|,
name|ypos
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|esc
decl_stmt|,
name|lead
decl_stmt|,
name|back
decl_stmt|,
name|verd
decl_stmt|,
name|mcase
decl_stmt|,
name|railmag
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|double
name|row
decl_stmt|,
name|col
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|char
modifier|*
name|fontname
index|[
name|MAXF
index|]
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|char
name|fnbuf
index|[
literal|120
index|]
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|char
modifier|*
name|scanline
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|linecount
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|char
name|asctab
index|[
literal|128
index|]
init|=
block|{
literal|'\0'
block|,
comment|/*blank*/
literal|'h'
block|,
comment|/*h*/
literal|'t'
block|,
comment|/*t*/
literal|'n'
block|,
comment|/*n*/
literal|'m'
block|,
comment|/*m*/
literal|'l'
block|,
comment|/*l*/
literal|'i'
block|,
comment|/*i*/
literal|'z'
block|,
comment|/*z*/
literal|'s'
block|,
comment|/*s*/
literal|'d'
block|,
comment|/*d*/
literal|'b'
block|,
comment|/*b*/
literal|'x'
block|,
comment|/*x*/
literal|'f'
block|,
comment|/*f*/
literal|'j'
block|,
comment|/*j*/
literal|'u'
block|,
comment|/*u*/
literal|'k'
block|,
comment|/*k*/
literal|'\0'
block|,
comment|/*blank*/
literal|'p'
block|,
comment|/*p*/
literal|'\06'
block|,
comment|/*_ 3/4 em dash*/
literal|';'
block|,
comment|/*;*/
literal|'\0'
block|,
comment|/*blank*/
literal|'a'
block|,
comment|/*a*/
literal|'\05'
block|,
comment|/*rule*/
literal|'c'
block|,
comment|/*c*/
literal|'`'
block|,
comment|/*` open*/
literal|'e'
block|,
comment|/*e*/
literal|'\''
block|,
comment|/*' close*/
literal|'o'
block|,
comment|/*o*/
literal|'\021'
block|,
comment|/*1/4*/
literal|'r'
block|,
comment|/*r*/
literal|'\022'
block|,
comment|/*1/2*/
literal|'v'
block|,
comment|/*v*/
literal|'-'
block|,
comment|/*- hyphen*/
literal|'w'
block|,
comment|/*w*/
literal|'q'
block|,
comment|/*q*/
literal|'/'
block|,
comment|/*/*/
literal|'.'
block|,
comment|/*.*/
literal|'g'
block|,
comment|/*g*/
literal|'\023'
block|,
comment|/*3/4*/
literal|','
block|,
comment|/*,*/
literal|'&'
block|,
comment|/*&*/
literal|'y'
block|,
comment|/*y*/
literal|'\0'
block|,
comment|/*blank*/
literal|'%'
block|,
comment|/*%*/
literal|'\0'
block|,
comment|/*blank*/
literal|'Q'
block|,
comment|/*Q*/
literal|'T'
block|,
comment|/*T*/
literal|'O'
block|,
comment|/*O*/
literal|'H'
block|,
comment|/*H*/
literal|'N'
block|,
comment|/*N*/
literal|'M'
block|,
comment|/*M*/
literal|'L'
block|,
comment|/*L*/
literal|'R'
block|,
comment|/*R*/
literal|'G'
block|,
comment|/*G*/
literal|'I'
block|,
comment|/*I*/
literal|'P'
block|,
comment|/*P*/
literal|'C'
block|,
comment|/*C*/
literal|'V'
block|,
comment|/*V*/
literal|'E'
block|,
comment|/*E*/
literal|'Z'
block|,
comment|/*Z*/
literal|'D'
block|,
comment|/*D*/
literal|'B'
block|,
comment|/*B*/
literal|'S'
block|,
comment|/*S*/
literal|'Y'
block|,
comment|/*Y*/
literal|'\0'
block|,
comment|/*blank*/
literal|'F'
block|,
comment|/*F*/
literal|'X'
block|,
comment|/*X*/
literal|'A'
block|,
comment|/*A*/
literal|'W'
block|,
comment|/*W*/
literal|'J'
block|,
comment|/*J*/
literal|'U'
block|,
comment|/*U*/
literal|'K'
block|,
comment|/*K*/
literal|'0'
block|,
comment|/*0*/
literal|'1'
block|,
comment|/*1*/
literal|'2'
block|,
comment|/*2*/
literal|'3'
block|,
comment|/*3*/
literal|'4'
block|,
comment|/*4*/
literal|'5'
block|,
comment|/*5*/
literal|'6'
block|,
comment|/*6*/
literal|'7'
block|,
comment|/*7*/
literal|'8'
block|,
comment|/*8*/
literal|'9'
block|,
comment|/*9*/
literal|'*'
block|,
comment|/***/
literal|'\04'
block|,
comment|/*minus*/
literal|'\01'
block|,
comment|/*fi*/
literal|'\02'
block|,
comment|/*fl*/
literal|'\03'
block|,
comment|/*ff*/
literal|'\020'
block|,
comment|/* cent sign */
literal|'\012'
block|,
comment|/*ffl*/
literal|'\011'
block|,
comment|/*ffi*/
literal|'('
block|,
comment|/*(*/
literal|')'
block|,
comment|/*)*/
literal|'['
block|,
comment|/*[*/
literal|']'
block|,
comment|/*]*/
literal|'\013'
block|,
comment|/* degree */
literal|'\014'
block|,
comment|/* dagger */
literal|'='
block|,
comment|/*=*/
literal|'\017'
block|,
comment|/* registered */
literal|':'
block|,
comment|/*:*/
literal|'+'
block|,
comment|/*+*/
literal|'\0'
block|,
comment|/*blank*/
literal|'!'
block|,
comment|/*!*/
literal|'\07'
block|,
comment|/* bullet */
literal|'?'
block|,
comment|/*?*/
literal|'\015'
block|,
comment|/*foot mark*/
literal|'|'
block|,
comment|/*|*/
literal|'\0'
block|,
comment|/*blank*/
literal|'\016'
block|,
comment|/* copyright */
literal|'\010'
block|,
comment|/* square */
literal|'$'
block|,
comment|/*$*/
literal|'\0'
block|,
literal|'\0'
block|,
literal|'"'
block|,
comment|/*"*/
literal|'#'
block|,
comment|/*#*/
literal|'<'
block|,
comment|/*<*/
literal|'>'
block|,
comment|/*>*/
literal|'@'
block|,
comment|/*@*/
literal|'\\'
block|,
comment|/*\\*/
literal|'^'
block|,
comment|/*^*/
literal|'{'
block|,
comment|/*{*/
literal|'}'
block|,
comment|/*}*/
literal|'~'
comment|/*~*/
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|char
name|spectab
index|[
literal|128
index|]
init|=
block|{
literal|'\0'
block|,
comment|/*blank*/
literal|'w'
block|,
comment|/*psi*/
literal|'h'
block|,
comment|/*theta*/
literal|'m'
block|,
comment|/*nu*/
literal|'l'
block|,
comment|/*mu*/
literal|'k'
block|,
comment|/*lambda*/
literal|'i'
block|,
comment|/*iota*/
literal|'f'
block|,
comment|/*zeta*/
literal|'r'
block|,
comment|/*sigma*/
literal|'d'
block|,
comment|/*delta*/
literal|'b'
block|,
comment|/*beta*/
literal|'n'
block|,
comment|/*xi*/
literal|'g'
block|,
comment|/*eta*/
literal|'u'
block|,
comment|/*phi*/
literal|'t'
block|,
comment|/*upsilon*/
literal|'j'
block|,
comment|/*kappa*/
literal|'\0'
block|,
comment|/*blank*/
literal|'p'
block|,
comment|/*pi*/
literal|'@'
block|,
comment|/*at-sign*/
literal|'7'
block|,
comment|/*down arrow*/
literal|'\0'
block|,
comment|/*blank*/
literal|'a'
block|,
comment|/*alpha*/
literal|'|'
block|,
comment|/*or*/
literal|'v'
block|,
comment|/*chi*/
literal|'"'
block|,
comment|/*"*/
literal|'e'
block|,
comment|/*epsilon*/
literal|'='
block|,
comment|/*=*/
literal|'o'
block|,
comment|/*omicron*/
literal|'4'
block|,
comment|/*left arrow*/
literal|'q'
block|,
comment|/*rho*/
literal|'6'
block|,
comment|/*up arrow*/
literal|'s'
block|,
comment|/*tau*/
literal|'_'
block|,
comment|/*underrule*/
literal|'\\'
block|,
comment|/*\*/
literal|'W'
block|,
comment|/*Psi*/
literal|'\07'
block|,
comment|/*bell system sign*/
literal|'\001'
block|,
comment|/*infinity*/
literal|'c'
block|,
comment|/*gamma*/
literal|'\002'
block|,
comment|/*improper superset*/
literal|'\003'
block|,
comment|/*proportional to*/
literal|'\004'
block|,
comment|/*right hand*/
literal|'x'
block|,
comment|/*omega*/
literal|'\0'
block|,
comment|/*blank*/
literal|'('
block|,
comment|/*gradient*/
literal|'\0'
block|,
comment|/*blank*/
literal|'U'
block|,
comment|/*Phi*/
literal|'H'
block|,
comment|/*Theta*/
literal|'X'
block|,
comment|/*Omega*/
literal|'\005'
block|,
comment|/*cup (union)*/
literal|'\006'
block|,
comment|/*root en*/
literal|'\014'
block|,
comment|/*terminal sigma*/
literal|'K'
block|,
comment|/*Lambda*/
literal|'-'
block|,
comment|/*minus*/
literal|'C'
block|,
comment|/*Gamma*/
literal|'\015'
block|,
comment|/*integral sign*/
literal|'P'
block|,
comment|/*Pi*/
literal|'\032'
block|,
comment|/*subset of*/
literal|'\033'
block|,
comment|/*superset of*/
literal|'2'
block|,
comment|/*approximates*/
literal|'y'
block|,
comment|/*partial derivative*/
literal|'D'
block|,
comment|/*Delta*/
literal|'\013'
block|,
comment|/*square root*/
literal|'R'
block|,
comment|/*Sigma*/
literal|'1'
block|,
comment|/*approx =*/
literal|'\0'
block|,
comment|/*blank*/
literal|'>'
block|,
comment|/*>*/
literal|'N'
block|,
comment|/*Xi*/
literal|'<'
block|,
comment|/*<*/
literal|'\016'
block|,
comment|/*slash (longer)*/
literal|'\034'
block|,
comment|/*cap (intersection)*/
literal|'T'
block|,
comment|/*Upsilon*/
literal|'\035'
block|,
comment|/*not*/
literal|'\023'
block|,
comment|/*right ceiling (rt of ")*/
literal|'\024'
block|,
comment|/*left top (of big curly)*/
literal|'\017'
block|,
comment|/*bold vertical*/
literal|'\030'
block|,
comment|/*left center of big curly bracket*/
literal|'\025'
block|,
comment|/*left bottom*/
literal|'\026'
block|,
comment|/*right top*/
literal|'\031'
block|,
comment|/*right center of big curly bracket*/
literal|'\027'
block|,
comment|/*right bot*/
literal|'\021'
block|,
comment|/*right floor (rb of ")*/
literal|'\020'
block|,
comment|/*left floor (left bot of big sq bract)*/
literal|'\022'
block|,
comment|/*left ceiling (lt of ")*/
literal|'*'
block|,
comment|/*multiply*/
literal|'/'
block|,
comment|/*divide*/
literal|'\010'
block|,
comment|/*plus-minus*/
literal|'\011'
block|,
comment|/*<=*/
literal|'\012'
block|,
comment|/*>=*/
literal|'0'
block|,
comment|/*identically equal*/
literal|'3'
block|,
comment|/*not equal*/
literal|'{'
block|,
comment|/*{*/
literal|'}'
block|,
comment|/*}*/
literal|'\''
block|,
comment|/*' acute accent*/
literal|'\`'
block|,
comment|/*` grave accent*/
literal|'^'
block|,
comment|/*^*/
literal|'#'
block|,
comment|/*sharp*/
literal|'\036'
block|,
comment|/*left hand*/
literal|'\037'
block|,
comment|/*member of*/
literal|'~'
block|,
comment|/*~*/
literal|'z'
block|,
comment|/*empty set*/
literal|'\0'
block|,
comment|/*blank*/
literal|'Y'
block|,
comment|/*dbl dagger*/
literal|'Z'
block|,
comment|/*box rule*/
literal|'9'
block|,
comment|/*asterisk*/
literal|'['
block|,
comment|/*improper subset*/
literal|']'
block|,
comment|/*circle*/
literal|'\0'
block|,
comment|/*blank*/
literal|'+'
block|,
comment|/*eqn plus*/
literal|'5'
block|,
comment|/*right arrow*/
literal|'8'
comment|/*section mark*/
block|}
decl_stmt|;
end_decl_stmt

begin_function
name|main
parameter_list|(
name|argc
parameter_list|,
name|argv
parameter_list|)
name|int
name|argc
decl_stmt|;
name|char
modifier|*
name|argv
index|[]
decl_stmt|;
block|{
name|char
modifier|*
name|namearg
init|=
name|NULL
decl_stmt|;
name|char
modifier|*
name|hostarg
init|=
name|NULL
decl_stmt|;
name|char
modifier|*
name|acctfile
init|=
name|NULL
decl_stmt|;
while|while
condition|(
operator|--
name|argc
condition|)
block|{
if|if
condition|(
operator|*
operator|(
operator|*
operator|++
name|argv
operator|)
operator|==
literal|'-'
condition|)
switch|switch
condition|(
name|argv
index|[
literal|0
index|]
index|[
literal|1
index|]
condition|)
block|{
case|case
literal|'x'
case|:
name|BYTES_PER_LINE
operator|=
name|atoi
argument_list|(
operator|&
name|argv
index|[
literal|0
index|]
index|[
literal|2
index|]
argument_list|)
operator|/
literal|8
expr_stmt|;
name|BUFFER_SIZE
operator|=
name|NLINES
operator|*
name|BYTES_PER_LINE
expr_stmt|;
break|break;
case|case
literal|'y'
case|:
name|PAGE_LINES
operator|=
name|atoi
argument_list|(
operator|&
name|argv
index|[
literal|0
index|]
index|[
literal|2
index|]
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'n'
case|:
if|if
condition|(
name|argc
operator|>
literal|1
condition|)
block|{
name|argc
operator|--
expr_stmt|;
name|namearg
operator|=
operator|*
operator|++
name|argv
expr_stmt|;
block|}
break|break;
case|case
literal|'h'
case|:
if|if
condition|(
name|argc
operator|>
literal|1
condition|)
block|{
name|argc
operator|--
expr_stmt|;
name|hostarg
operator|=
operator|*
operator|++
name|argv
expr_stmt|;
block|}
break|break;
block|}
else|else
name|acctfile
operator|=
operator|*
name|argv
expr_stmt|;
block|}
name|ioctl
argument_list|(
name|vc
argument_list|,
name|VSETSTATE
argument_list|,
name|pltmode
argument_list|)
expr_stmt|;
name|readrm
argument_list|()
expr_stmt|;
name|ofile
argument_list|()
expr_stmt|;
name|ioctl
argument_list|(
name|vc
argument_list|,
name|VSETSTATE
argument_list|,
name|prtmode
argument_list|)
expr_stmt|;
if|if
condition|(
name|varian
condition|)
name|write
argument_list|(
name|vc
argument_list|,
literal|"\f"
argument_list|,
literal|2
argument_list|)
expr_stmt|;
else|else
name|write
argument_list|(
name|vc
argument_list|,
literal|"\n\n\n\n\n"
argument_list|,
literal|6
argument_list|)
expr_stmt|;
name|account
argument_list|(
name|namearg
argument_list|,
name|hostarg
argument_list|,
name|acctfile
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|0
argument_list|)
expr_stmt|;
block|}
end_function

begin_macro
name|readrm
argument_list|()
end_macro

begin_block
block|{
specifier|register
name|int
name|i
decl_stmt|;
specifier|register
name|char
modifier|*
name|cp
decl_stmt|;
specifier|register
name|int
name|rmfd
decl_stmt|;
name|char
name|c
decl_stmt|;
if|if
condition|(
operator|(
name|rmfd
operator|=
name|open
argument_list|(
name|LOCAL_RAILMAG
argument_list|,
literal|0
argument_list|)
operator|)
operator|<
literal|0
condition|)
if|if
condition|(
operator|(
name|rmfd
operator|=
name|open
argument_list|(
name|GLOBAL_RAILMAG
argument_list|,
literal|0
argument_list|)
operator|)
operator|<
literal|0
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"rvcat: No railmag file\n"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|2
argument_list|)
expr_stmt|;
block|}
name|cp
operator|=
name|fnbuf
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|MAXF
condition|;
name|i
operator|++
control|)
block|{
name|fontname
index|[
name|i
index|]
operator|=
name|cp
expr_stmt|;
while|while
condition|(
name|read
argument_list|(
name|rmfd
argument_list|,
operator|&
name|c
argument_list|,
literal|1
argument_list|)
operator|==
literal|1
operator|&&
name|c
operator|!=
literal|'\n'
condition|)
operator|*
name|cp
operator|++
operator|=
name|c
expr_stmt|;
operator|*
name|cp
operator|++
operator|=
literal|'\0'
expr_stmt|;
block|}
name|close
argument_list|(
name|rmfd
argument_list|)
expr_stmt|;
block|}
end_block

begin_macro
name|ofile
argument_list|()
end_macro

begin_block
block|{
specifier|register
name|int
name|c
decl_stmt|;
specifier|register
name|int
name|i
decl_stmt|;
name|double
name|scol
decl_stmt|;
specifier|static
name|int
name|initialized
decl_stmt|;
name|lines
operator|=
literal|0
expr_stmt|;
while|while
condition|(
operator|(
name|c
operator|=
name|getchar
argument_list|()
operator|)
operator|!=
name|EOF
condition|)
block|{
if|if
condition|(
operator|!
name|c
condition|)
continue|continue;
if|if
condition|(
name|c
operator|&
literal|0200
condition|)
block|{
name|esc
operator|+=
operator|(
operator|~
name|c
operator|)
operator|&
literal|0177
expr_stmt|;
continue|continue;
block|}
if|if
condition|(
name|esc
condition|)
block|{
if|if
condition|(
name|back
condition|)
name|esc
operator|=
operator|-
name|esc
expr_stmt|;
name|col
operator|+=
name|esc
expr_stmt|;
name|esc
operator|=
literal|0
expr_stmt|;
name|i
operator|=
name|CONVERT
argument_list|(
name|col
argument_list|)
expr_stmt|;
while|while
condition|(
name|i
operator|>=
name|NLINES
condition|)
block|{
name|slop_lines
argument_list|(
literal|15
argument_list|)
expr_stmt|;
name|i
operator|=
name|CONVERT
argument_list|(
name|col
argument_list|)
expr_stmt|;
block|}
name|ypos
operator|=
name|i
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|c
operator|&
literal|0377
operator|)
operator|<
literal|0100
condition|)
comment|/*  Purely for efficiency  */
goto|goto
name|normal_char
goto|;
switch|switch
condition|(
name|c
condition|)
block|{
case|case
literal|0100
case|:
name|esc
operator|=
literal|0
expr_stmt|;
name|lead
operator|=
literal|0
expr_stmt|;
name|linecount
operator|=
literal|0
expr_stmt|;
name|verd
operator|=
literal|0
expr_stmt|;
name|back
operator|=
literal|0
expr_stmt|;
name|mcase
operator|=
literal|0
expr_stmt|;
name|railmag
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|loadfont
argument_list|(
name|railmag
argument_list|,
name|cpsize
argument_list|)
operator|<
literal|0
condition|)
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"rvcat: Can't load initial font\n"
argument_list|)
expr_stmt|;
if|if
condition|(
name|initialized
condition|)
goto|goto
name|reset
goto|;
name|initialized
operator|=
literal|1
expr_stmt|;
name|row
operator|=
literal|0
expr_stmt|;
name|xpos
operator|=
name|CONVERT
argument_list|(
name|row
argument_list|)
expr_stmt|;
for|for
control|(
name|c
operator|=
literal|0
init|;
name|c
operator|<
name|BUFFER_SIZE
condition|;
name|c
operator|++
control|)
name|buffer
index|[
name|c
index|]
operator|=
literal|0
expr_stmt|;
name|col
operator|=
literal|0
expr_stmt|;
name|ypos
operator|=
literal|0
expr_stmt|;
break|break;
case|case
literal|0101
case|:
comment|/* lower rail */
name|crail
argument_list|(
name|railmag
operator|&=
operator|~
literal|01
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0102
case|:
comment|/* upper rail */
name|crail
argument_list|(
name|railmag
operator||=
literal|01
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0103
case|:
comment|/* upper mag */
name|crail
argument_list|(
name|railmag
operator||=
literal|02
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0104
case|:
comment|/* lower mag */
name|crail
argument_list|(
name|railmag
operator|&=
operator|~
literal|02
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0105
case|:
comment|/* lower case */
name|mcase
operator|=
literal|0
expr_stmt|;
break|break;
case|case
literal|0106
case|:
comment|/* upper case */
name|mcase
operator|=
literal|0100
expr_stmt|;
break|break;
case|case
literal|0107
case|:
comment|/* escape forward */
name|back
operator|=
literal|0
expr_stmt|;
break|break;
case|case
literal|0110
case|:
comment|/* escape backwards */
name|back
operator|=
literal|1
expr_stmt|;
break|break;
case|case
literal|0111
case|:
comment|/* stop */
break|break;
case|case
literal|0112
case|:
comment|/* lead forward */
name|verd
operator|=
literal|0
expr_stmt|;
break|break;
case|case
literal|0113
case|:
comment|/* undefined */
break|break;
case|case
literal|0114
case|:
comment|/* lead backward */
name|verd
operator|=
literal|1
expr_stmt|;
break|break;
case|case
literal|0115
case|:
comment|/* undefined */
name|reset
label|:
name|c
operator|=
name|lines
operator|%
name|PAGE_LINES
expr_stmt|;
while|while
condition|(
name|c
operator|<
name|FF_LINES
condition|)
block|{
name|slop_lines
argument_list|(
name|min
argument_list|(
name|FF_LINES
operator|-
name|c
argument_list|,
name|NLINES
argument_list|)
argument_list|)
expr_stmt|;
name|c
operator|=
name|lines
operator|%
name|PAGE_LINES
expr_stmt|;
block|}
name|new_page
argument_list|(
name|PAGE_LINES
operator|-
name|c
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0116
case|:
name|lead
operator|=
operator|(
name|getchar
argument_list|()
operator|&
literal|0377
operator|)
operator|*
literal|64
expr_stmt|;
goto|goto
name|leadin
goto|;
case|case
literal|0117
case|:
break|break;
default|default:
if|if
condition|(
operator|(
name|c
operator|&
literal|0340
operator|)
operator|==
literal|0140
condition|)
comment|/* leading */
block|{
name|lead
operator|=
operator|(
operator|~
name|c
operator|)
operator|&
literal|037
expr_stmt|;
name|leadin
label|:
if|if
condition|(
name|verd
condition|)
name|lead
operator|=
operator|-
name|lead
expr_stmt|;
name|row
operator|+=
name|lead
operator|*
literal|3
expr_stmt|;
comment|/*  Lead is 3 units  */
name|xpos
operator|=
name|CONVERT
argument_list|(
name|row
argument_list|)
expr_stmt|;
continue|continue;
block|}
if|if
condition|(
operator|(
name|c
operator|&
literal|0360
operator|)
operator|==
literal|0120
condition|)
comment|/* size change */
block|{
name|loadfont
argument_list|(
name|railmag
argument_list|,
name|findsize
argument_list|(
name|c
operator|&
literal|017
argument_list|)
argument_list|)
expr_stmt|;
continue|continue;
block|}
if|if
condition|(
name|c
operator|&
literal|0300
condition|)
continue|continue;
name|normal_char
label|:
if|if
condition|(
name|row
operator|<
literal|0
operator|||
name|CONVERT
argument_list|(
name|row
argument_list|)
operator|>=
name|BYTES_PER_LINE
operator|*
literal|8
condition|)
continue|continue;
name|c
operator|=
operator|(
name|c
operator|&
literal|077
operator|)
operator||
name|mcase
expr_stmt|;
name|outc
argument_list|(
name|c
argument_list|)
expr_stmt|;
block|}
block|}
name|out
label|:
name|slop_lines
argument_list|(
name|NLINES
argument_list|)
expr_stmt|;
block|}
end_block

begin_expr_stmt
name|findsize
argument_list|(
name|code
argument_list|)
specifier|register
name|int
name|code
expr_stmt|;
end_expr_stmt

begin_block
block|{
specifier|register
name|struct
name|point_sizes
modifier|*
name|psp
decl_stmt|;
name|psp
operator|=
name|point_sizes
expr_stmt|;
while|while
condition|(
name|psp
operator|->
name|real_code
operator|!=
literal|0
condition|)
block|{
if|if
condition|(
operator|(
name|psp
operator|->
name|stupid_code
operator|&
literal|017
operator|)
operator|==
name|code
condition|)
break|break;
name|psp
operator|++
expr_stmt|;
block|}
name|code
operator|=
literal|0
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|last_ssize
operator|&
literal|0200
operator|)
operator|&&
operator|(
name|psp
operator|->
name|stupid_code
operator|&
literal|0200
operator|)
condition|)
name|code
operator|=
operator|-
literal|55
expr_stmt|;
elseif|else
if|if
condition|(
operator|(
name|last_ssize
operator|&
literal|0200
operator|)
operator|&&
operator|!
operator|(
name|psp
operator|->
name|stupid_code
operator|&
literal|0200
operator|)
condition|)
name|code
operator|=
literal|55
expr_stmt|;
if|if
condition|(
name|back
condition|)
name|code
operator|=
operator|-
name|code
expr_stmt|;
name|esc
operator|+=
name|code
expr_stmt|;
name|last_ssize
operator|=
name|psp
operator|->
name|stupid_code
expr_stmt|;
return|return
operator|(
name|psp
operator|->
name|real_code
operator|)
return|;
block|}
end_block

begin_macro
name|account
argument_list|(
argument|who
argument_list|,
argument|from
argument_list|,
argument|acctfile
argument_list|)
end_macro

begin_decl_stmt
name|char
modifier|*
name|who
decl_stmt|,
modifier|*
name|from
decl_stmt|,
modifier|*
name|acctfile
decl_stmt|;
end_decl_stmt

begin_block
block|{
specifier|register
name|FILE
modifier|*
name|a
decl_stmt|;
if|if
condition|(
name|who
operator|==
name|NULL
operator|||
name|acctfile
operator|==
name|NULL
condition|)
return|return;
if|if
condition|(
name|access
argument_list|(
name|acctfile
argument_list|,
literal|02
argument_list|)
operator|||
operator|(
name|a
operator|=
name|fopen
argument_list|(
name|acctfile
argument_list|,
literal|"a"
argument_list|)
operator|)
operator|==
name|NULL
condition|)
return|return;
comment|/* 	 * Varian accounting is done by 8.5 inch pages; 	 * Versatec accounting is by the (12 inch) foot. 	 */
name|fprintf
argument_list|(
name|a
argument_list|,
literal|"t%6.2f\t"
argument_list|,
operator|(
name|double
operator|)
name|lines
operator|/
operator|(
name|double
operator|)
name|PAGE_LINES
argument_list|)
expr_stmt|;
if|if
condition|(
name|from
operator|!=
name|NULL
condition|)
name|fprintf
argument_list|(
name|a
argument_list|,
literal|"%s:"
argument_list|,
name|from
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|a
argument_list|,
literal|"%s\n"
argument_list|,
name|who
argument_list|)
expr_stmt|;
name|fclose
argument_list|(
name|a
argument_list|)
expr_stmt|;
block|}
end_block

begin_expr_stmt
name|crail
argument_list|(
name|nrail
argument_list|)
specifier|register
name|int
name|nrail
expr_stmt|;
end_expr_stmt

begin_block
block|{
specifier|register
name|int
name|psize
decl_stmt|;
name|psize
operator|=
name|cpsize
expr_stmt|;
if|if
condition|(
name|fontwanted
operator|&&
name|psize
operator|!=
name|npsize
condition|)
name|psize
operator|=
name|npsize
expr_stmt|;
name|loadfont
argument_list|(
name|nrail
argument_list|,
name|psize
argument_list|)
expr_stmt|;
block|}
end_block

begin_expr_stmt
name|loadfont
argument_list|(
name|fnum
argument_list|,
name|size
argument_list|)
specifier|register
name|int
name|fnum
expr_stmt|;
end_expr_stmt

begin_decl_stmt
specifier|register
name|int
name|size
decl_stmt|;
end_decl_stmt

begin_block
block|{
specifier|register
name|int
name|i
decl_stmt|;
name|char
name|cbuf
index|[
literal|80
index|]
decl_stmt|;
name|fontwanted
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|fnum
operator|==
name|cfnum
operator|&&
name|size
operator|==
name|cpsize
condition|)
return|return
operator|(
literal|0
operator|)
return|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|NFONTS
condition|;
name|i
operator|++
control|)
if|if
condition|(
name|fontdes
index|[
name|i
index|]
operator|.
name|fnum
operator|==
name|fnum
operator|&&
name|fontdes
index|[
name|i
index|]
operator|.
name|psize
operator|==
name|size
condition|)
block|{
name|cfnum
operator|=
name|fontdes
index|[
name|i
index|]
operator|.
name|fnum
expr_stmt|;
name|cpsize
operator|=
name|fontdes
index|[
name|i
index|]
operator|.
name|psize
expr_stmt|;
name|dispatch
operator|=
operator|&
name|fontdes
index|[
name|i
index|]
operator|.
name|disp
index|[
literal|0
index|]
expr_stmt|;
name|bits
operator|=
name|fontdes
index|[
name|i
index|]
operator|.
name|bits
expr_stmt|;
name|cfont
operator|=
name|i
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
if|if
condition|(
name|fnum
operator|<
literal|0
operator|||
name|fnum
operator|>=
name|MAXF
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"rvcat: Internal error: illegal font\n"
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
name|nfontnum
operator|=
name|fnum
expr_stmt|;
name|npsize
operator|=
name|size
expr_stmt|;
name|fontwanted
operator|++
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_block

begin_macro
name|getfont
argument_list|()
end_macro

begin_block
block|{
specifier|register
name|int
name|fnum
decl_stmt|,
name|size
decl_stmt|,
name|font
decl_stmt|;
name|int
name|d
decl_stmt|;
name|char
name|cbuf
index|[
name|BUFSIZ
index|]
decl_stmt|;
name|char
modifier|*
name|cp
init|=
name|cbuf
decl_stmt|;
name|char
modifier|*
name|dp
decl_stmt|;
if|if
condition|(
operator|!
name|fontwanted
condition|)
return|return
operator|(
literal|0
operator|)
return|;
name|fnum
operator|=
name|nfontnum
expr_stmt|;
name|size
operator|=
name|npsize
expr_stmt|;
name|sprintf
argument_list|(
name|cbuf
argument_list|,
literal|"%s.%dr"
argument_list|,
name|fontname
index|[
name|fnum
index|]
argument_list|,
name|size
argument_list|)
expr_stmt|;
name|font
operator|=
name|open
argument_list|(
name|cbuf
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|font
operator|==
operator|-
literal|1
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"rvcat: "
argument_list|)
expr_stmt|;
name|perror
argument_list|(
name|cbuf
argument_list|)
expr_stmt|;
name|fontwanted
operator|=
literal|0
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
if|if
condition|(
name|read
argument_list|(
name|font
argument_list|,
operator|&
name|header
argument_list|,
sizeof|sizeof
name|header
argument_list|)
operator|!=
sizeof|sizeof
name|header
operator|||
name|header
operator|.
name|magic
operator|!=
literal|0436
condition|)
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"rvcat: %s: Bad font file"
argument_list|,
name|cbuf
argument_list|)
expr_stmt|;
else|else
block|{
name|cfont
operator|=
name|relfont
argument_list|()
expr_stmt|;
if|if
condition|(
operator|(
operator|(
name|bits
operator|=
name|nalloc
argument_list|(
name|header
operator|.
name|size
operator|+
name|DSIZ
operator|+
literal|1
argument_list|,
literal|1
argument_list|)
operator|)
operator|==
name|NULL
operator|)
operator|&&
operator|(
operator|(
name|bits
operator|=
name|allpanic
argument_list|(
name|header
operator|.
name|size
operator|+
name|DSIZ
operator|+
literal|1
argument_list|)
operator|)
operator|==
name|NULL
operator|)
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"rvcat: %s: ran out of memory\n"
argument_list|,
name|cbuf
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|2
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|/* 			 * have allocated one chunk of mem for font, dispatch. 			 * get the dispatch addr, align to word boundary. 			 */
name|d
operator|=
operator|(
name|int
operator|)
name|bits
operator|+
name|header
operator|.
name|size
expr_stmt|;
name|d
operator|+=
literal|1
expr_stmt|;
name|d
operator|&=
operator|~
literal|1
expr_stmt|;
if|if
condition|(
name|read
argument_list|(
name|font
argument_list|,
name|d
argument_list|,
name|DSIZ
argument_list|)
operator|!=
name|DSIZ
operator|||
name|read
argument_list|(
name|font
argument_list|,
name|bits
argument_list|,
name|header
operator|.
name|size
argument_list|)
operator|!=
name|header
operator|.
name|size
condition|)
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"rvcat: bad font header"
argument_list|)
expr_stmt|;
else|else
block|{
name|close
argument_list|(
name|font
argument_list|)
expr_stmt|;
name|cfnum
operator|=
name|fontdes
index|[
name|cfont
index|]
operator|.
name|fnum
operator|=
name|fnum
expr_stmt|;
name|cpsize
operator|=
name|fontdes
index|[
name|cfont
index|]
operator|.
name|psize
operator|=
name|size
expr_stmt|;
name|fontdes
index|[
name|cfont
index|]
operator|.
name|bits
operator|=
name|bits
expr_stmt|;
name|fontdes
index|[
name|cfont
index|]
operator|.
name|disp
operator|=
operator|(
expr|struct
name|dispatch
operator|*
operator|)
name|d
expr_stmt|;
name|dispatch
operator|=
operator|&
name|fontdes
index|[
name|cfont
index|]
operator|.
name|disp
index|[
literal|0
index|]
expr_stmt|;
name|fontwanted
operator|=
literal|0
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
block|}
block|}
name|close
argument_list|(
name|font
argument_list|)
expr_stmt|;
name|fontwanted
operator|=
literal|0
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
end_block

begin_decl_stmt
name|int
name|lastloaded
init|=
operator|-
literal|1
decl_stmt|;
end_decl_stmt

begin_macro
name|relfont
argument_list|()
end_macro

begin_block
block|{
specifier|register
name|int
name|newfont
decl_stmt|;
name|newfont
operator|=
name|lastloaded
expr_stmt|;
comment|/* 	 * optimization for special font.  since we think that usually 	 * there is only one character at a time from any special math 	 * font, make it the candidate for removal. 	 */
if|if
condition|(
name|fontdes
index|[
name|cfont
index|]
operator|.
name|fnum
operator|!=
name|SPECIALFONT
operator|||
name|fontdes
index|[
name|cfont
index|]
operator|.
name|bits
operator|==
literal|0
condition|)
if|if
condition|(
operator|++
name|newfont
operator|>=
name|NFONTS
condition|)
name|newfont
operator|=
literal|0
expr_stmt|;
name|lastloaded
operator|=
name|newfont
expr_stmt|;
if|if
condition|(
operator|(
name|int
operator|)
name|fontdes
index|[
name|newfont
index|]
operator|.
name|bits
operator|!=
operator|-
literal|1
operator|&&
name|fontdes
index|[
name|newfont
index|]
operator|.
name|bits
operator|!=
literal|0
condition|)
name|nfree
argument_list|(
name|fontdes
index|[
name|newfont
index|]
operator|.
name|bits
argument_list|)
expr_stmt|;
name|fontdes
index|[
name|newfont
index|]
operator|.
name|bits
operator|=
literal|0
expr_stmt|;
return|return
operator|(
name|newfont
operator|)
return|;
block|}
end_block

begin_function
name|char
modifier|*
name|allpanic
parameter_list|(
name|nbytes
parameter_list|)
name|int
name|nbytes
decl_stmt|;
block|{
specifier|register
name|int
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<=
name|NFONTS
condition|;
name|i
operator|++
control|)
if|if
condition|(
name|fontdes
index|[
name|i
index|]
operator|.
name|bits
operator|!=
operator|(
name|char
operator|*
operator|)
operator|-
literal|1
operator|&&
name|fontdes
index|[
name|i
index|]
operator|.
name|bits
operator|!=
operator|(
name|char
operator|*
operator|)
literal|0
condition|)
name|nfree
argument_list|(
name|fontdes
index|[
name|i
index|]
operator|.
name|bits
argument_list|)
expr_stmt|;
name|lastloaded
operator|=
name|cfont
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<=
name|NFONTS
condition|;
name|i
operator|++
control|)
block|{
name|fontdes
index|[
name|i
index|]
operator|.
name|fnum
operator|=
name|fontdes
index|[
name|i
index|]
operator|.
name|psize
operator|=
operator|-
literal|1
expr_stmt|;
name|fontdes
index|[
name|i
index|]
operator|.
name|bits
operator|=
literal|0
expr_stmt|;
name|cfnum
operator|=
name|cpsize
operator|=
operator|-
literal|1
expr_stmt|;
block|}
return|return
operator|(
name|nalloc
argument_list|(
name|nbytes
argument_list|,
literal|1
argument_list|)
operator|)
return|;
block|}
end_function

begin_decl_stmt
name|int
name|M
index|[]
init|=
block|{
literal|0xffffffff
block|,
literal|0xfefefefe
block|,
literal|0xfcfcfcfc
block|,
literal|0xf8f8f8f8
block|,
literal|0xf0f0f0f0
block|,
literal|0xe0e0e0e0
block|,
literal|0xc0c0c0c0
block|,
literal|0x80808080
block|,
literal|0x0
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|N
index|[]
init|=
block|{
literal|0x00000000
block|,
literal|0x01010101
block|,
literal|0x03030303
block|,
literal|0x07070707
block|,
literal|0x0f0f0f0f
block|,
literal|0x1f1f1f1f
block|,
literal|0x3f3f3f3f
block|,
literal|0x7f7f7f7f
block|,
literal|0xffffffff
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|strim
index|[]
init|=
block|{
literal|0xffffffff
block|,
literal|0xffffff00
block|,
literal|0xffff0000
block|,
literal|0xff000000
block|,
literal|0
block|}
decl_stmt|;
end_decl_stmt

begin_macro
name|outc
argument_list|(
argument|code
argument_list|)
end_macro

begin_decl_stmt
name|int
name|code
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|char
name|c
decl_stmt|;
comment|/* character to print */
specifier|register
name|struct
name|dispatch
modifier|*
name|d
decl_stmt|;
comment|/* ptr to character font record */
specifier|register
name|char
modifier|*
name|addr
decl_stmt|;
comment|/* addr of font data */
name|int
name|llen
decl_stmt|;
comment|/* length of each font line */
name|int
name|nlines
decl_stmt|;
comment|/* number of font lines */
specifier|register
name|char
modifier|*
name|scanp
decl_stmt|;
comment|/* ptr to output buffer */
name|int
name|scanp_inc
decl_stmt|;
comment|/* increment to start of next buffer */
name|int
name|offset
decl_stmt|;
comment|/* bit offset to start of font data */
name|int
name|i
decl_stmt|;
comment|/* loop counter */
specifier|register
name|int
name|count
decl_stmt|;
comment|/* font data ptr */
specifier|register
name|unsigned
name|fontdata
decl_stmt|;
comment|/* font data temporary */
specifier|register
name|int
name|off8
decl_stmt|;
comment|/* offset + 8 */
name|int
name|b0poff
decl_stmt|;
comment|/* bit offset back towards buf0p */
if|if
condition|(
name|fontwanted
condition|)
name|getfont
argument_list|()
expr_stmt|;
if|if
condition|(
name|railmag
operator|==
name|SPECIALFONT
condition|)
block|{
if|if
condition|(
operator|(
name|c
operator|=
name|spectab
index|[
name|code
index|]
operator|)
operator|<
literal|0
condition|)
return|return
operator|(
literal|0
operator|)
return|;
block|}
elseif|else
if|if
condition|(
operator|(
name|c
operator|=
name|asctab
index|[
name|code
index|]
operator|)
operator|<
literal|0
condition|)
return|return
operator|(
literal|0
operator|)
return|;
name|d
operator|=
name|dispatch
operator|+
name|c
expr_stmt|;
if|if
condition|(
name|d
operator|->
name|nbytes
condition|)
block|{
name|addr
operator|=
name|bits
operator|+
name|d
operator|->
name|addr
expr_stmt|;
name|llen
operator|=
operator|(
name|d
operator|->
name|down
operator|+
name|d
operator|->
name|up
operator|+
literal|7
operator|)
operator|/
literal|8
expr_stmt|;
name|nlines
operator|=
name|d
operator|->
name|left
operator|+
name|d
operator|->
name|right
expr_stmt|;
if|if
condition|(
name|ypos
operator|+
name|d
operator|->
name|right
operator|>=
name|NLINES
condition|)
name|slop_lines
argument_list|(
name|ypos
operator|+
name|d
operator|->
name|right
operator|-
name|NLINES
operator|+
literal|6
argument_list|)
expr_stmt|;
name|b0poff
operator|=
name|BYTES_PER_LINE
operator|*
literal|8
operator|-
literal|1
operator|-
operator|(
name|xpos
operator|+
name|d
operator|->
name|down
operator|)
expr_stmt|;
name|scanp
operator|=
operator|(
operator|(
name|ypos
operator|-
name|d
operator|->
name|left
operator|-
literal|1
operator|)
operator|*
name|BYTES_PER_LINE
operator|+
name|b0poff
operator|/
literal|8
operator|)
operator|+
name|buf0p
expr_stmt|;
if|if
condition|(
name|scanp
operator|<
operator|&
name|buffer
index|[
literal|0
index|]
condition|)
name|scanp
operator|+=
name|BUFFER_SIZE
expr_stmt|;
name|scanp_inc
operator|=
name|BYTES_PER_LINE
operator|-
name|llen
expr_stmt|;
name|offset
operator|=
operator|-
operator|(
name|b0poff
operator|&
literal|07
operator|)
expr_stmt|;
name|off8
operator|=
name|offset
operator|+
literal|8
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|nlines
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|scanp
operator|>=
operator|&
name|buffer
index|[
name|BUFFER_SIZE
index|]
condition|)
name|scanp
operator|-=
name|BUFFER_SIZE
expr_stmt|;
name|count
operator|=
name|llen
expr_stmt|;
if|if
condition|(
name|scanp
operator|+
name|count
operator|<=
operator|&
name|buffer
index|[
name|BUFFER_SIZE
index|]
condition|)
do|do
block|{
name|fontdata
operator|=
operator|*
operator|(
name|unsigned
operator|*
operator|)
name|addr
expr_stmt|;
name|addr
operator|+=
literal|4
expr_stmt|;
if|if
condition|(
name|count
operator|<
literal|4
condition|)
name|fontdata
operator|&=
operator|~
name|strim
index|[
name|count
index|]
expr_stmt|;
operator|*
operator|(
name|unsigned
operator|*
operator|)
name|scanp
operator||=
operator|(
name|fontdata
operator|<<
name|offset
operator|)
operator|&
operator|~
name|M
index|[
name|off8
index|]
expr_stmt|;
name|scanp
operator|++
expr_stmt|;
operator|*
operator|(
name|unsigned
operator|*
operator|)
name|scanp
operator||=
operator|(
name|fontdata
operator|<<
name|off8
operator|)
operator|&
operator|~
name|N
index|[
name|off8
index|]
expr_stmt|;
name|scanp
operator|+=
literal|3
expr_stmt|;
name|count
operator|-=
literal|4
expr_stmt|;
block|}
do|while
condition|(
name|count
operator|>
literal|0
condition|)
do|;
name|scanp
operator|+=
name|scanp_inc
operator|+
name|count
expr_stmt|;
name|addr
operator|+=
name|count
expr_stmt|;
block|}
return|return
operator|(
literal|1
operator|)
return|;
block|}
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_block

begin_macro
name|slop_lines
argument_list|(
argument|ncols
argument_list|)
end_macro

begin_decl_stmt
name|int
name|ncols
decl_stmt|;
end_decl_stmt

begin_block
block|{
specifier|register
name|int
name|i
decl_stmt|,
name|rcols
decl_stmt|;
name|lines
operator|+=
name|ncols
expr_stmt|;
name|rcols
operator|=
operator|(
operator|&
name|buffer
index|[
name|BUFFER_SIZE
index|]
operator|-
name|buf0p
operator|)
operator|/
name|BYTES_PER_LINE
expr_stmt|;
if|if
condition|(
name|rcols
operator|<
name|ncols
condition|)
block|{
if|if
condition|(
name|write
argument_list|(
name|vc
argument_list|,
name|buf0p
argument_list|,
name|BYTES_PER_LINE
operator|*
name|rcols
argument_list|)
operator|<
literal|0
condition|)
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
name|bzero
argument_list|(
name|buf0p
argument_list|,
name|rcols
operator|*
name|BYTES_PER_LINE
argument_list|)
expr_stmt|;
name|buf0p
operator|=
name|buffer
expr_stmt|;
name|ncols
operator|-=
name|rcols
expr_stmt|;
name|ypos
operator|-=
name|rcols
expr_stmt|;
name|col
operator|-=
name|RECONVERT
argument_list|(
name|rcols
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|write
argument_list|(
name|vc
argument_list|,
name|buf0p
argument_list|,
name|BYTES_PER_LINE
operator|*
name|ncols
argument_list|)
operator|<
literal|0
condition|)
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
name|bzero
argument_list|(
name|buf0p
argument_list|,
name|BYTES_PER_LINE
operator|*
name|ncols
argument_list|)
expr_stmt|;
name|buf0p
operator|+=
name|BYTES_PER_LINE
operator|*
name|ncols
expr_stmt|;
if|if
condition|(
name|buf0p
operator|>=
operator|&
name|buffer
index|[
name|BUFFER_SIZE
index|]
condition|)
name|buf0p
operator|-=
name|BUFFER_SIZE
expr_stmt|;
name|ypos
operator|-=
name|ncols
expr_stmt|;
name|col
operator|-=
name|RECONVERT
argument_list|(
name|ncols
argument_list|)
expr_stmt|;
block|}
end_block

begin_comment
comment|/* Start a new page by formfeeding, resetting buffer and column counters. */
end_comment

begin_macro
name|new_page
argument_list|(
argument|lines_left
argument_list|)
end_macro

begin_decl_stmt
name|int
name|lines_left
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* ... on page. */
end_comment

begin_block
block|{
name|lines
operator|+=
name|lines_left
expr_stmt|;
name|buf0p
operator|=
name|buffer
expr_stmt|;
comment|/* Clear out buffer and reset pointers. */
name|bzero
argument_list|(
name|buf0p
argument_list|,
name|BYTES_PER_LINE
operator|*
name|NLINES
argument_list|)
expr_stmt|;
name|row
operator|=
literal|0
expr_stmt|;
name|col
operator|=
literal|0
expr_stmt|;
name|xpos
operator|=
name|CONVERT
argument_list|(
name|row
argument_list|)
expr_stmt|;
name|ypos
operator|=
literal|0
expr_stmt|;
name|ioctl
argument_list|(
name|vc
argument_list|,
name|VSETSTATE
argument_list|,
name|prtmode
argument_list|)
expr_stmt|;
name|write
argument_list|(
name|vc
argument_list|,
literal|"\f"
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|ioctl
argument_list|(
name|vc
argument_list|,
name|VSETSTATE
argument_list|,
name|pltmode
argument_list|)
expr_stmt|;
block|}
end_block

begin_function
name|char
modifier|*
name|nalloc
parameter_list|(
name|i
parameter_list|,
name|j
parameter_list|)
name|int
name|i
decl_stmt|,
name|j
decl_stmt|;
block|{
specifier|register
name|char
modifier|*
name|cp
decl_stmt|;
name|cp
operator|=
name|calloc
argument_list|(
name|i
argument_list|,
name|j
argument_list|)
expr_stmt|;
return|return
operator|(
name|cp
operator|)
return|;
block|}
end_function

begin_macro
name|nfree
argument_list|(
argument|cp
argument_list|)
end_macro

begin_decl_stmt
name|char
modifier|*
name|cp
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|free
argument_list|(
name|cp
argument_list|)
expr_stmt|;
block|}
end_block

end_unit


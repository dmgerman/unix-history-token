begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_ifndef
ifndef|#
directive|ifndef
name|lint
end_ifndef

begin_decl_stmt
specifier|static
name|char
name|sccsid
index|[]
init|=
literal|"@(#)fcvt.c	4.2 (Berkeley) %G%"
decl_stmt|;
end_decl_stmt

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/*  * Convert from the SAIL font format to the Unix font format.  * Usage: fcvt sailfile unixfile  */
end_comment

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_include
include|#
directive|include
file|<vfont.h>
end_include

begin_decl_stmt
name|int
name|sws
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* sail word size in 36 bit words */
end_comment

begin_decl_stmt
name|char
name|b
index|[
literal|40000
index|]
decl_stmt|,
name|u
index|[
literal|2000
index|]
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|long
name|left
argument_list|()
decl_stmt|,
name|right
argument_list|()
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|struct
name|header
name|vheader
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|struct
name|dispatch
name|disptable
index|[
literal|256
index|]
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|long
name|rightbits
index|[
literal|19
index|]
init|=
block|{
literal|0
block|,
literal|1
block|,
literal|03
block|,
literal|07
block|,
literal|017
block|,
literal|037
block|,
literal|077
block|,
literal|0177
block|,
literal|0377
block|,
literal|0777
block|,
literal|01777
block|,
literal|03777
block|,
literal|07777
block|,
literal|017777
block|,
literal|037777
block|,
literal|077777
block|,
literal|0177777
block|,
literal|0377777
block|,
literal|0777777
block|}
decl_stmt|;
end_decl_stmt

begin_function
name|main
parameter_list|(
name|argc
parameter_list|,
name|argv
parameter_list|)
name|int
name|argc
decl_stmt|;
name|char
modifier|*
name|argv
index|[]
decl_stmt|;
block|{
name|int
name|infd
init|=
name|open
argument_list|(
name|argv
index|[
literal|1
index|]
argument_list|,
literal|0
argument_list|)
decl_stmt|;
name|int
name|outfd
init|=
name|creat
argument_list|(
name|argv
index|[
literal|2
index|]
argument_list|,
literal|0666
argument_list|)
decl_stmt|;
name|int
name|n
decl_stmt|;
name|long
name|lh
decl_stmt|,
name|rh
decl_stmt|;
name|int
name|base
decl_stmt|,
name|nb
decl_stmt|,
name|ncol
decl_stmt|,
name|nleft
decl_stmt|,
name|r
decl_stmt|,
name|i
decl_stmt|;
name|int
name|c
decl_stmt|,
name|p
decl_stmt|;
comment|/* Sail counters and things */
name|int
name|height
decl_stmt|,
name|maxwidth
decl_stmt|,
name|baseline
decl_stmt|;
name|int
name|charwidth
decl_stmt|,
name|rastwidth
decl_stmt|,
name|charcode
decl_stmt|,
name|wordcount
decl_stmt|;
name|int
name|leftkern
decl_stmt|,
name|rowsfromtop
decl_stmt|,
name|datarowcount
decl_stmt|;
comment|/* Unix counters and things */
name|int
name|rastrows
decl_stmt|,
name|rastcols
decl_stmt|;
name|int
name|curaddr
decl_stmt|;
name|int
name|packed
decl_stmt|;
comment|/* true if sail packed format for this glyph */
name|int
name|nperword
decl_stmt|;
if|if
condition|(
name|infd
operator|<
literal|0
operator|||
name|outfd
operator|<
literal|0
condition|)
block|{
name|printf
argument_list|(
literal|"Usage: fcvt sailfile unixfile\n"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
name|n
operator|=
name|read
argument_list|(
name|infd
argument_list|,
name|b
argument_list|,
sizeof|sizeof
name|b
argument_list|)
expr_stmt|;
name|sws
operator|=
literal|2
operator|*
name|n
operator|/
literal|9
expr_stmt|;
if|if
condition|(
name|n
operator|==
sizeof|sizeof
name|b
condition|)
block|{
name|printf
argument_list|(
literal|"Font larger than %d bytes - recompile me\n"
argument_list|,
name|n
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
name|close
argument_list|(
name|infd
argument_list|)
expr_stmt|;
name|height
operator|=
name|right
argument_list|(
literal|0201
argument_list|)
expr_stmt|;
name|maxwidth
operator|=
name|right
argument_list|(
literal|0202
argument_list|)
expr_stmt|;
name|baseline
operator|=
name|right
argument_list|(
literal|0203
argument_list|)
expr_stmt|;
name|vheader
operator|.
name|magic
operator|=
literal|0436
expr_stmt|;
comment|/* size gets done later */
name|vheader
operator|.
name|maxx
operator|=
name|height
expr_stmt|;
name|vheader
operator|.
name|maxy
operator|=
name|maxwidth
expr_stmt|;
comment|/* I don't know what xtnd would map to */
name|lseek
argument_list|(
name|outfd
argument_list|,
operator|(
name|long
operator|)
sizeof|sizeof
name|vheader
operator|+
sizeof|sizeof
name|disptable
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|curaddr
operator|=
literal|0
expr_stmt|;
comment|/* Look at each char */
for|for
control|(
name|c
operator|=
literal|0
init|;
name|c
operator|<
literal|0200
condition|;
name|c
operator|++
control|)
block|{
comment|/* Find Sail info */
name|base
operator|=
name|right
argument_list|(
name|c
argument_list|)
expr_stmt|;
if|if
condition|(
name|base
operator|==
literal|0
condition|)
continue|continue;
name|charwidth
operator|=
name|left
argument_list|(
name|c
argument_list|)
expr_stmt|;
name|rastwidth
operator|=
operator|(
name|left
argument_list|(
name|base
argument_list|)
operator|>>
literal|9
operator|)
operator|&
literal|0777
expr_stmt|;
if|if
condition|(
name|rastwidth
operator|==
literal|0
condition|)
name|rastwidth
operator|=
name|charwidth
expr_stmt|;
name|charcode
operator|=
name|left
argument_list|(
name|base
argument_list|)
operator|&
literal|0777
expr_stmt|;
if|if
condition|(
name|charcode
operator|!=
name|c
condition|)
name|printf
argument_list|(
literal|"bad char code %o(%c) != %o(%c)\n"
argument_list|,
name|charcode
argument_list|,
name|charcode
argument_list|,
name|c
argument_list|,
name|c
argument_list|)
expr_stmt|;
name|wordcount
operator|=
name|right
argument_list|(
name|base
argument_list|)
expr_stmt|;
if|if
condition|(
name|base
operator|+
name|wordcount
operator|>
name|sws
condition|)
block|{
name|printf
argument_list|(
literal|"Bad range %o-%o> %o glyph %o\n"
argument_list|,
name|base
argument_list|,
name|base
operator|+
name|wordcount
argument_list|,
name|sws
argument_list|,
name|c
argument_list|)
expr_stmt|;
continue|continue;
block|}
name|leftkern
operator|=
operator|(
name|left
argument_list|(
name|base
operator|+
literal|1
argument_list|)
operator|>>
literal|9
operator|)
operator|&
literal|0777
expr_stmt|;
name|rowsfromtop
operator|=
name|left
argument_list|(
name|base
operator|+
literal|1
argument_list|)
operator|&
literal|0777
expr_stmt|;
name|datarowcount
operator|=
name|right
argument_list|(
name|base
operator|+
literal|1
argument_list|)
expr_stmt|;
name|rastrows
operator|=
name|datarowcount
expr_stmt|;
name|rastcols
operator|=
operator|(
name|rastwidth
operator|+
literal|35
operator|)
operator|/
literal|36
operator|*
literal|36
expr_stmt|;
comment|/* Unix disptable stuff */
name|disptable
index|[
name|c
index|]
operator|.
name|addr
operator|=
name|curaddr
expr_stmt|;
name|nb
operator|=
name|rastrows
operator|*
operator|(
operator|(
name|rastcols
operator|+
literal|7
operator|)
operator|>>
literal|3
operator|)
expr_stmt|;
name|disptable
index|[
name|c
index|]
operator|.
name|nbytes
operator|=
name|nb
expr_stmt|;
name|curaddr
operator|+=
name|nb
expr_stmt|;
name|disptable
index|[
name|c
index|]
operator|.
name|left
operator|=
name|leftkern
expr_stmt|;
name|disptable
index|[
name|c
index|]
operator|.
name|right
operator|=
name|rastcols
operator|-
name|leftkern
expr_stmt|;
name|disptable
index|[
name|c
index|]
operator|.
name|up
operator|=
name|baseline
operator|-
name|rowsfromtop
expr_stmt|;
name|disptable
index|[
name|c
index|]
operator|.
name|down
operator|=
name|rastrows
operator|-
name|disptable
index|[
name|c
index|]
operator|.
name|up
expr_stmt|;
name|disptable
index|[
name|c
index|]
operator|.
name|width
operator|=
name|charwidth
expr_stmt|;
name|packed
operator|=
operator|(
name|datarowcount
operator|>
name|wordcount
operator|)
expr_stmt|;
name|nperword
operator|=
literal|36
operator|/
name|rastwidth
expr_stmt|;
comment|/* Now get the raster rows themselves */
name|p
operator|=
literal|0
expr_stmt|;
name|ncol
operator|=
name|rastcols
operator|/
literal|36
expr_stmt|;
name|nleft
operator|=
operator|(
operator|(
name|rastwidth
operator|-
literal|1
operator|)
operator|%
literal|36
operator|+
literal|1
operator|)
expr_stmt|;
name|base
operator|+=
literal|2
expr_stmt|;
for|for
control|(
name|r
operator|=
literal|0
init|;
name|r
operator|<
name|rastrows
condition|;
name|r
operator|++
control|)
block|{
if|if
condition|(
operator|!
name|packed
condition|)
block|{
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|ncol
condition|;
name|i
operator|++
control|)
block|{
name|lh
operator|=
name|left
argument_list|(
name|base
argument_list|)
expr_stmt|;
name|rh
operator|=
name|right
argument_list|(
name|base
operator|++
argument_list|)
expr_stmt|;
comment|/* compensate for garbage in SAIL fonts */
if|if
condition|(
name|i
operator|==
name|ncol
operator|-
literal|1
condition|)
block|{
if|if
condition|(
name|nleft
operator|<=
literal|18
condition|)
block|{
name|rh
operator|=
literal|0
expr_stmt|;
name|lh
operator|&=
operator|~
name|rightbits
index|[
literal|18
operator|-
name|nleft
index|]
expr_stmt|;
block|}
else|else
name|rh
operator|&=
operator|~
name|rightbits
index|[
literal|36
operator|-
name|nleft
index|]
expr_stmt|;
block|}
if|if
condition|(
name|i
operator|%
literal|2
condition|)
block|{
name|u
index|[
name|p
operator|-
literal|1
index|]
operator||=
operator|(
name|lh
operator|>>
literal|14
operator|)
operator|&
literal|017
expr_stmt|;
name|u
index|[
name|p
operator|++
index|]
operator|=
name|lh
operator|>>
literal|6
expr_stmt|;
name|u
index|[
name|p
operator|++
index|]
operator|=
operator|(
operator|(
name|lh
operator|&
literal|077
operator|)
operator|<<
literal|2
operator|)
operator||
operator|(
operator|(
name|rh
operator|>>
literal|16
operator|)
operator|&
literal|03
operator|)
expr_stmt|;
name|u
index|[
name|p
operator|++
index|]
operator|=
name|rh
operator|>>
literal|8
expr_stmt|;
name|u
index|[
name|p
operator|++
index|]
operator|=
name|rh
expr_stmt|;
block|}
else|else
block|{
name|u
index|[
name|p
operator|++
index|]
operator|=
name|lh
operator|>>
literal|10
expr_stmt|;
name|u
index|[
name|p
operator|++
index|]
operator|=
name|lh
operator|>>
literal|2
expr_stmt|;
name|u
index|[
name|p
operator|++
index|]
operator|=
operator|(
operator|(
name|lh
operator|&
literal|03
operator|)
operator|<<
literal|6
operator|)
operator||
operator|(
name|rh
operator|>>
literal|12
operator|)
expr_stmt|;
name|u
index|[
name|p
operator|++
index|]
operator|=
name|rh
operator|>>
literal|4
expr_stmt|;
name|u
index|[
name|p
operator|++
index|]
operator|=
operator|(
name|rh
operator|&
literal|017
operator|)
operator|<<
literal|4
expr_stmt|;
block|}
block|}
block|}
else|else
block|{
name|put
argument_list|(
name|r
operator|%
name|nperword
argument_list|,
name|rastwidth
argument_list|,
name|left
argument_list|(
name|base
operator|+
name|r
operator|/
name|nperword
argument_list|)
argument_list|,
name|right
argument_list|(
name|base
operator|+
name|r
operator|/
name|nperword
argument_list|)
argument_list|,
name|u
operator|+
name|p
argument_list|)
expr_stmt|;
name|p
operator|+=
literal|5
expr_stmt|;
comment|/* 5 8 bit bytes per 36 bit word */
block|}
block|}
name|write
argument_list|(
name|outfd
argument_list|,
name|u
argument_list|,
name|p
argument_list|)
expr_stmt|;
block|}
name|lseek
argument_list|(
name|outfd
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|vheader
operator|.
name|size
operator|=
name|curaddr
expr_stmt|;
name|write
argument_list|(
name|outfd
argument_list|,
operator|&
name|vheader
argument_list|,
sizeof|sizeof
name|vheader
argument_list|)
expr_stmt|;
name|write
argument_list|(
name|outfd
argument_list|,
name|disptable
argument_list|,
sizeof|sizeof
name|disptable
argument_list|)
expr_stmt|;
name|close
argument_list|(
name|outfd
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|0
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * put a pdp-10 style variable size byte into 8 bit Unix bytes starting  * at location dest.  The byte is bytesize bits, and is the bytenumth byte  * in the 36 bit word (lh,,rh).  */
end_comment

begin_macro
name|put
argument_list|(
argument|bytenum
argument_list|,
argument|bytesize
argument_list|,
argument|lh
argument_list|,
argument|rh
argument_list|,
argument|dest
argument_list|)
end_macro

begin_decl_stmt
name|int
name|bytenum
decl_stmt|,
name|bytesize
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|long
name|lh
decl_stmt|,
name|rh
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|char
modifier|*
name|dest
decl_stmt|;
end_decl_stmt

begin_block
block|{
specifier|register
name|int
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|5
condition|;
name|i
operator|++
control|)
name|dest
index|[
name|i
index|]
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|bytenum
condition|;
name|i
operator|++
control|)
block|{
name|lh
operator|<<=
name|bytesize
expr_stmt|;
name|lh
operator||=
operator|(
name|rh
operator|>>
literal|18
operator|-
name|bytesize
operator|)
operator|&
name|rightbits
index|[
name|bytesize
index|]
expr_stmt|;
name|rh
operator|<<=
name|bytesize
expr_stmt|;
block|}
name|lh
operator|&=
operator|~
name|rightbits
index|[
literal|18
operator|-
name|bytesize
index|]
expr_stmt|;
comment|/* We now have the byte we want left justified in lh */
name|lh
operator|<<=
literal|14
expr_stmt|;
comment|/* lh is now the byte we want, left justified in 32 bit word */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|bytesize
condition|;
name|i
operator|+=
literal|8
control|)
block|{
operator|*
name|dest
operator|++
operator|=
operator|(
name|lh
operator|>>
literal|24
operator|)
operator|&
literal|0377
expr_stmt|;
name|lh
operator|<<=
literal|8
expr_stmt|;
block|}
block|}
end_block

begin_comment
comment|/*  * Return the left half (18 bits) of pdp-10 word p.  */
end_comment

begin_function
name|long
name|left
parameter_list|(
name|p
parameter_list|)
name|int
name|p
decl_stmt|;
block|{
specifier|register
name|int
name|lp
decl_stmt|,
name|odd
decl_stmt|;
specifier|register
name|long
name|retval
decl_stmt|;
name|odd
operator|=
name|p
operator|%
literal|2
expr_stmt|;
name|lp
operator|=
literal|9
operator|*
name|p
operator|/
literal|2
expr_stmt|;
if|if
condition|(
name|p
operator|>=
name|sws
condition|)
block|{
return|return
operator|(
literal|0
operator|)
return|;
block|}
if|if
condition|(
name|odd
condition|)
block|{
name|retval
operator|=
operator|(
name|b
index|[
name|lp
operator|++
index|]
operator|&
literal|0017
operator|)
operator|<<
literal|14
expr_stmt|;
name|retval
operator||=
operator|(
name|b
index|[
name|lp
operator|++
index|]
operator|&
literal|0377
operator|)
operator|<<
literal|6
expr_stmt|;
name|retval
operator||=
operator|(
name|b
index|[
name|lp
index|]
operator|>>
literal|2
operator|)
operator|&
literal|63
expr_stmt|;
block|}
else|else
block|{
name|retval
operator|=
operator|(
name|b
index|[
name|lp
operator|++
index|]
operator|&
literal|0377
operator|)
operator|<<
literal|10
expr_stmt|;
name|retval
operator||=
operator|(
name|b
index|[
name|lp
operator|++
index|]
operator|&
literal|0377
operator|)
operator|<<
literal|2
expr_stmt|;
name|retval
operator||=
operator|(
name|b
index|[
name|lp
index|]
operator|>>
literal|6
operator|)
operator|&
literal|3
expr_stmt|;
block|}
return|return
name|retval
return|;
block|}
end_function

begin_comment
comment|/*  * Return the right half of 36 bit word #p.  */
end_comment

begin_function
name|long
name|right
parameter_list|(
name|p
parameter_list|)
name|int
name|p
decl_stmt|;
block|{
specifier|register
name|int
name|lp
decl_stmt|,
name|odd
decl_stmt|;
specifier|register
name|long
name|retval
decl_stmt|;
name|odd
operator|=
name|p
operator|%
literal|2
expr_stmt|;
name|lp
operator|=
literal|9
operator|*
name|p
operator|/
literal|2
operator|+
literal|2
expr_stmt|;
if|if
condition|(
name|p
operator|>=
name|sws
condition|)
block|{
return|return
operator|(
literal|0
operator|)
return|;
block|}
if|if
condition|(
name|odd
condition|)
block|{
name|retval
operator|=
operator|(
name|b
index|[
name|lp
operator|++
index|]
operator|&
literal|0003
operator|)
operator|<<
literal|16
expr_stmt|;
name|retval
operator||=
operator|(
name|b
index|[
name|lp
operator|++
index|]
operator|&
literal|0377
operator|)
operator|<<
literal|8
expr_stmt|;
name|retval
operator||=
operator|(
name|b
index|[
name|lp
index|]
operator|&
literal|0377
operator|)
expr_stmt|;
block|}
else|else
block|{
name|retval
operator|=
operator|(
name|b
index|[
name|lp
operator|++
index|]
operator|&
literal|0077
operator|)
operator|<<
literal|12
expr_stmt|;
name|retval
operator||=
operator|(
name|b
index|[
name|lp
operator|++
index|]
operator|&
literal|0377
operator|)
operator|<<
literal|4
expr_stmt|;
name|retval
operator||=
operator|(
name|b
index|[
name|lp
index|]
operator|>>
literal|4
operator|)
operator|&
literal|017
expr_stmt|;
block|}
return|return
name|retval
return|;
block|}
end_function

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_empty
empty|#
end_empty

begin_comment
comment|/*  	C debugger  */
end_comment

begin_include
include|#
directive|include
file|"/usr/sys/param.h"
end_include

begin_include
include|#
directive|include
file|"/usr/sys/user.h"
end_include

begin_define
define|#
directive|define
name|DSP
value|0
end_define

begin_define
define|#
directive|define
name|ISP
value|1
end_define

begin_define
define|#
directive|define
name|NBKP
value|10
end_define

begin_define
define|#
directive|define
name|SYMSIZ
value|12*400
end_define

begin_define
define|#
directive|define
name|BADJST
value|01
end_define

begin_decl_stmt
name|int
name|fcore
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|errno
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|fsym
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|symoff
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|char
modifier|*
name|lp
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|errflg
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|symlen
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|symct
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|symcor
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|symbuf
index|[
name|SYMSIZ
index|]
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
modifier|*
name|symptr
decl_stmt|;
end_decl_stmt

begin_struct
struct|struct
block|{
name|int
name|loc
decl_stmt|;
name|int
name|ins
decl_stmt|;
name|int
name|count
decl_stmt|;
name|int
name|flag
decl_stmt|;
block|}
name|bkptl
index|[
name|NBKP
index|]
struct|;
end_struct

begin_decl_stmt
name|int
name|lastbp
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|char
name|symbol
index|[
literal|8
index|]
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|symflg
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|symval
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|char
name|tsym
index|[
literal|8
index|]
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|char
name|fsymbol
index|[
literal|10
index|]
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|char
name|ssymbol
index|[
literal|8
index|]
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|ssymflg
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|ssymval
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|signo
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|char
name|line
index|[
literal|128
index|]
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|regbuf
index|[
literal|512
index|]
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|char
modifier|*
modifier|*
name|uregs
modifier|&
name|regbuf
index|[
literal|512
index|]
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|char
modifier|*
name|rtsize
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|loccsv
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|locsr5
decl_stmt|;
end_decl_stmt

begin_define
define|#
directive|define
name|RUSER
value|1
end_define

begin_define
define|#
directive|define
name|RIUSER
value|2
end_define

begin_define
define|#
directive|define
name|WUSER
value|4
end_define

begin_define
define|#
directive|define
name|RUREGS
value|3
end_define

begin_define
define|#
directive|define
name|WUREGS
value|6
end_define

begin_define
define|#
directive|define
name|SETTRC
value|0
end_define

begin_define
define|#
directive|define
name|CONTIN
value|7
end_define

begin_define
define|#
directive|define
name|EXIT
value|8
end_define

begin_define
define|#
directive|define
name|ps
value|-1
end_define

begin_define
define|#
directive|define
name|pc
value|-2
end_define

begin_define
define|#
directive|define
name|sp
value|-6
end_define

begin_define
define|#
directive|define
name|r5
value|-9
end_define

begin_define
define|#
directive|define
name|r4
value|-10
end_define

begin_define
define|#
directive|define
name|r3
value|-11
end_define

begin_define
define|#
directive|define
name|r2
value|-12
end_define

begin_define
define|#
directive|define
name|r1
value|-5
end_define

begin_define
define|#
directive|define
name|r0
value|-3
end_define

begin_struct
struct|struct
name|reglist
block|{
name|char
modifier|*
name|rname
decl_stmt|;
name|int
name|roffs
decl_stmt|;
block|}
name|reglist
index|[]
block|{
literal|"ps"
operator|,
name|ps
operator|,
literal|"pc"
operator|,
name|pc
operator|,
literal|"sp"
operator|,
name|sp
operator|,
literal|"r5"
operator|,
name|r5
operator|,
literal|"r4"
operator|,
name|r4
operator|,
literal|"r3"
operator|,
name|r3
operator|,
literal|"r2"
operator|,
name|r2
operator|,
literal|"r1"
operator|,
name|r1
operator|,
literal|"r0"
operator|,
name|r0
operator|,
block|}
struct|;
end_struct

begin_struct
struct|struct
name|sfregs
block|{
name|int
name|junk
index|[
literal|2
index|]
decl_stmt|;
name|int
name|fpsr
decl_stmt|;
name|float
name|sfr
index|[
literal|6
index|]
decl_stmt|;
block|}
struct|;
end_struct

begin_struct
struct|struct
name|lfregs
block|{
name|int
name|junk
index|[
literal|2
index|]
decl_stmt|;
name|int
name|fpsr
decl_stmt|;
name|double
name|lfr
index|[
literal|6
index|]
decl_stmt|;
block|}
struct|;
end_struct

begin_decl_stmt
name|int
name|frnames
index|[]
block|{
literal|0
operator|,
literal|3
operator|,
literal|4
operator|,
literal|5
operator|,
literal|1
operator|,
literal|2
block|}
end_decl_stmt

begin_empty_stmt
empty_stmt|;
end_empty_stmt

begin_decl_stmt
name|int
name|dot
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|tdot
decl_stmt|;
end_decl_stmt

begin_expr_stmt
name|int
name|dotinc
literal|2
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|int
name|lastcom
literal|'/'
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|int
name|lastype
literal|'o'
expr_stmt|;
end_expr_stmt

begin_decl_stmt
name|int
name|modifier
decl_stmt|;
end_decl_stmt

begin_expr_stmt
name|char
operator|*
name|symfil
literal|"a.out"
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|char
operator|*
name|corfil
literal|"core"
expr_stmt|;
end_expr_stmt

begin_decl_stmt
name|int
name|callist
index|[
literal|50
index|]
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|entpt
index|[
literal|50
index|]
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|callev
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|pid
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|adrflg
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|idsep
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|char
modifier|*
name|signals
index|[]
block|{
literal|""
operator|,
literal|"Hangup"
operator|,
literal|"Interrupt"
operator|,
literal|"Quit"
operator|,
literal|"Illegal instruction"
operator|,
literal|"Trace/BTP"
operator|,
literal|"IOT"
operator|,
literal|"EMT"
operator|,
literal|"Floating exception"
operator|,
literal|"Killed"
operator|,
literal|"Bus error"
operator|,
literal|"Memory fault"
operator|,
literal|"Bad system call"
operator|,
literal|""
operator|,
literal|""
operator|,
literal|""
operator|,
block|}
end_decl_stmt

begin_empty_stmt
empty_stmt|;
end_empty_stmt

begin_function
name|main
parameter_list|(
name|argc
parameter_list|,
name|argv
parameter_list|)
name|char
modifier|*
modifier|*
name|argv
decl_stmt|;
block|{
name|int
name|onintr
parameter_list|()
function_decl|;
if|if
condition|(
name|argc
operator|>
literal|1
condition|)
name|symfil
operator|=
name|argv
index|[
literal|1
index|]
expr_stmt|;
if|if
condition|(
name|argc
operator|>
literal|2
condition|)
name|corfil
operator|=
name|argv
index|[
literal|2
index|]
expr_stmt|;
name|fcore
operator|=
name|open
argument_list|(
name|corfil
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|fsym
operator|=
name|open
argument_list|(
name|symfil
argument_list|,
literal|0
argument_list|)
operator|)
operator|<
literal|0
condition|)
block|{
name|printf
argument_list|(
literal|"%s not found\n"
argument_list|,
name|symfil
argument_list|)
expr_stmt|;
return|return;
block|}
name|read
argument_list|(
name|fsym
argument_list|,
name|regbuf
argument_list|,
literal|020
argument_list|)
expr_stmt|;
if|if
condition|(
name|regbuf
index|[
literal|0
index|]
operator|==
literal|0411
condition|)
comment|/* I/D separated */
name|idsep
operator|++
expr_stmt|;
elseif|else
if|if
condition|(
name|regbuf
index|[
literal|0
index|]
operator|!=
literal|0410
operator|&&
name|regbuf
index|[
literal|0
index|]
operator|!=
literal|0407
condition|)
block|{
comment|/* magic */
name|printf
argument_list|(
literal|"Bad format: %s\n"
argument_list|,
name|symfil
argument_list|)
expr_stmt|;
return|return;
block|}
name|symoff
operator|=
name|regbuf
index|[
literal|1
index|]
operator|+
name|regbuf
index|[
literal|2
index|]
expr_stmt|;
name|symlen
operator|=
name|regbuf
index|[
literal|4
index|]
expr_stmt|;
if|if
condition|(
name|regbuf
index|[
literal|7
index|]
operator|!=
literal|1
condition|)
name|symoff
operator|=
operator|<<
literal|1
expr_stmt|;
name|symoff
operator|=
operator|+
literal|020
expr_stmt|;
name|seek
argument_list|(
name|fsym
argument_list|,
name|symoff
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|symcor
operator|=
name|read
argument_list|(
name|fsym
argument_list|,
name|symbuf
argument_list|,
sizeof|sizeof
name|symbuf
argument_list|)
expr_stmt|;
if|if
condition|(
name|symcor
operator|>
literal|0
condition|)
name|symoff
operator|=
operator|+
name|symcor
expr_stmt|;
name|symcor
operator|=
operator|>>
literal|1
expr_stmt|;
name|read
argument_list|(
name|fcore
argument_list|,
name|regbuf
argument_list|,
literal|1024
argument_list|)
expr_stmt|;
name|signo
operator|=
name|regbuf
index|[
literal|0
index|]
operator|.
name|u_arg
index|[
literal|0
index|]
operator|&
literal|017
expr_stmt|;
name|regbuf
operator|->
name|u_tsize
operator|=
operator|<<
literal|6
expr_stmt|;
name|regbuf
operator|->
name|u_dsize
operator|=
operator|<<
literal|6
expr_stmt|;
name|regbuf
operator|->
name|u_ssize
operator|=
operator|<<
literal|6
expr_stmt|;
name|rtsize
operator|=
operator|(
name|regbuf
operator|->
name|u_tsize
operator|+
literal|017777
operator|)
operator|&
operator|~
literal|017777
expr_stmt|;
if|if
condition|(
name|symlook
argument_list|(
literal|"csv\0\0\0\0"
argument_list|)
condition|)
name|loccsv
operator|=
name|ssymval
expr_stmt|;
if|if
condition|(
name|symlook
argument_list|(
literal|"savr5\0\0\0"
argument_list|)
condition|)
name|locsr5
operator|=
name|ssymval
expr_stmt|;
name|setstack
argument_list|()
expr_stmt|;
name|signal
argument_list|(
name|SIGINS
argument_list|,
name|onintr
argument_list|)
expr_stmt|;
name|setexit
argument_list|()
expr_stmt|;
name|signal
argument_list|(
name|SIGINT
argument_list|,
name|onintr
argument_list|)
expr_stmt|;
name|loop
label|:
if|if
condition|(
name|errflg
condition|)
block|{
name|printf
argument_list|(
literal|"?\n"
argument_list|)
expr_stmt|;
name|errflg
operator|=
literal|0
expr_stmt|;
block|}
name|lp
operator|=
name|line
expr_stmt|;
while|while
condition|(
operator|(
operator|*
name|lp
operator|=
name|getchar
argument_list|()
operator|)
operator|!=
literal|'\n'
condition|)
if|if
condition|(
operator|*
name|lp
operator|++
operator|==
literal|'\0'
condition|)
block|{
if|if
condition|(
name|pid
condition|)
name|ptrace
argument_list|(
name|EXIT
argument_list|,
name|pid
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
return|return;
block|}
name|lp
operator|=
name|line
expr_stmt|;
name|command
argument_list|()
expr_stmt|;
goto|goto
name|loop
goto|;
block|}
end_function

begin_macro
name|command
argument_list|()
end_macro

begin_block
block|{
specifier|register
name|n
expr_stmt|;
name|adrflg
operator|=
name|expr
argument_list|()
expr_stmt|;
if|if
condition|(
name|errflg
condition|)
return|return;
name|n
operator|=
name|getcnt
argument_list|()
expr_stmt|;
if|if
condition|(
name|lastcom
operator|==
literal|'$'
condition|)
name|lastcom
operator|=
literal|'/'
expr_stmt|;
if|if
condition|(
operator|*
name|lp
operator|==
literal|'\n'
condition|)
block|{
if|if
condition|(
operator|!
name|adrflg
condition|)
name|dot
operator|=
operator|+
name|dotinc
expr_stmt|;
block|}
else|else
name|lastcom
operator|=
operator|*
name|lp
operator|++
expr_stmt|;
name|modifier
operator|=
literal|0
expr_stmt|;
if|if
condition|(
operator|*
name|lp
operator|!=
literal|'\n'
condition|)
name|modifier
operator|=
operator|*
name|lp
operator|++
expr_stmt|;
if|if
condition|(
name|lastcom
operator|==
literal|'%'
operator|&&
name|modifier
operator|==
literal|'r'
condition|)
block|{
name|runcom
argument_list|()
expr_stmt|;
return|return;
block|}
if|if
condition|(
operator|*
name|lp
operator|!=
literal|'\n'
condition|)
block|{
name|errflg
operator|++
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|adrflg
condition|)
name|dot
operator|=
name|tdot
expr_stmt|;
while|while
condition|(
name|n
condition|)
block|{
name|scommand
argument_list|(
name|n
argument_list|)
expr_stmt|;
if|if
condition|(
name|errflg
condition|)
return|return;
if|if
condition|(
operator|--
name|n
condition|)
name|dot
operator|=
operator|+
name|dotinc
expr_stmt|;
block|}
block|}
end_block

begin_macro
name|scommand
argument_list|(
argument|n
argument_list|)
end_macro

begin_block
block|{
specifier|register
name|w
operator|,
name|c
expr_stmt|;
name|double
name|fw
decl_stmt|;
struct|struct
block|{
name|int
name|i
index|[
literal|4
index|]
decl_stmt|;
block|}
struct|;
name|int
name|onintr
parameter_list|()
function_decl|;
switch|switch
condition|(
name|lastcom
condition|)
block|{
case|case
literal|'/'
case|:
name|w
operator|=
name|cget
argument_list|(
name|dot
argument_list|,
name|DSP
argument_list|)
expr_stmt|;
if|if
condition|(
name|modifier
condition|)
name|lastype
operator|=
name|modifier
expr_stmt|;
switch|switch
condition|(
name|lastype
condition|)
block|{
case|case
literal|'o'
case|:
name|printf
argument_list|(
literal|"%.1o\n"
argument_list|,
name|w
argument_list|)
expr_stmt|;
name|dotinc
operator|=
literal|2
expr_stmt|;
return|return;
case|case
literal|'i'
case|:
name|printf
argument_list|(
literal|"%d\n"
argument_list|,
name|w
argument_list|)
expr_stmt|;
name|dotinc
operator|=
literal|2
expr_stmt|;
return|return;
case|case
literal|'f'
case|:
name|fw
operator|=
literal|0
expr_stmt|;
name|fw
operator|.
name|i
index|[
literal|0
index|]
operator|=
name|w
expr_stmt|;
name|fw
operator|.
name|i
index|[
literal|1
index|]
operator|=
name|cget
argument_list|(
name|dot
operator|+
literal|2
argument_list|,
name|DSP
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"%e\n"
argument_list|,
name|fw
argument_list|)
expr_stmt|;
name|dotinc
operator|=
literal|4
expr_stmt|;
return|return;
case|case
literal|'d'
case|:
name|fw
operator|.
name|i
index|[
literal|0
index|]
operator|=
name|w
expr_stmt|;
name|fw
operator|.
name|i
index|[
literal|1
index|]
operator|=
name|cget
argument_list|(
name|dot
operator|+
literal|2
argument_list|,
name|DSP
argument_list|)
expr_stmt|;
name|fw
operator|.
name|i
index|[
literal|2
index|]
operator|=
name|cget
argument_list|(
name|dot
operator|+
literal|4
argument_list|,
name|DSP
argument_list|)
expr_stmt|;
name|fw
operator|.
name|i
index|[
literal|3
index|]
operator|=
name|cget
argument_list|(
name|dot
operator|+
literal|6
argument_list|,
name|DSP
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"%e\n"
argument_list|,
name|fw
argument_list|)
expr_stmt|;
name|dotinc
operator|=
literal|8
expr_stmt|;
return|return;
block|}
name|errflg
operator|++
expr_stmt|;
return|return;
case|case
literal|'\\'
case|:
name|printf
argument_list|(
literal|"%.1o\n"
argument_list|,
name|cget
argument_list|(
name|dot
argument_list|,
name|DSP
argument_list|)
operator|&
literal|0377
argument_list|)
expr_stmt|;
name|dotinc
operator|=
literal|1
expr_stmt|;
return|return;
case|case
literal|'='
case|:
name|printf
argument_list|(
literal|"%.1o\n"
argument_list|,
name|dot
argument_list|)
expr_stmt|;
return|return;
case|case
literal|'\''
case|:
name|printc
argument_list|(
name|cget
argument_list|(
name|dot
argument_list|,
name|DSP
argument_list|)
operator|&
literal|0377
argument_list|)
expr_stmt|;
if|if
condition|(
name|n
operator|<=
literal|1
condition|)
name|putchar
argument_list|(
literal|'\n'
argument_list|)
expr_stmt|;
name|dotinc
operator|=
literal|1
expr_stmt|;
return|return;
case|case
literal|'"'
case|:
name|w
operator|=
name|cget
argument_list|(
name|dot
argument_list|,
name|DSP
argument_list|)
expr_stmt|;
while|while
condition|(
name|c
operator|=
name|cget
argument_list|(
name|w
operator|++
argument_list|,
name|DSP
argument_list|)
operator|&
literal|0377
condition|)
name|printc
argument_list|(
name|c
argument_list|)
expr_stmt|;
name|putchar
argument_list|(
literal|'\n'
argument_list|)
expr_stmt|;
return|return;
case|case
literal|'&'
case|:
name|psymoff
argument_list|(
name|cget
argument_list|(
name|dot
argument_list|,
name|DSP
argument_list|)
argument_list|,
literal|0100000
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
return|return;
case|case
literal|'$'
case|:
name|printf
argument_list|(
literal|"%s\n"
argument_list|,
name|signals
index|[
name|signo
index|]
argument_list|)
expr_stmt|;
name|printtrace
argument_list|()
expr_stmt|;
return|return;
case|case
literal|'?'
case|:
name|printins
argument_list|(
literal|0
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
return|return;
case|case
literal|'%'
case|:
name|runcom
argument_list|()
expr_stmt|;
name|signal
argument_list|(
name|SIGINT
argument_list|,
name|onintr
argument_list|)
expr_stmt|;
return|return;
block|}
name|errflg
operator|++
expr_stmt|;
block|}
end_block

begin_macro
name|getcnt
argument_list|()
end_macro

begin_block
block|{
specifier|register
name|t1
operator|,
name|t2
expr_stmt|;
if|if
condition|(
operator|*
name|lp
operator|!=
literal|','
condition|)
return|return
operator|(
literal|1
operator|)
return|;
name|lp
operator|++
expr_stmt|;
name|t1
operator|=
name|tdot
expr_stmt|;
if|if
condition|(
name|expr
argument_list|()
operator|==
literal|0
condition|)
block|{
name|tdot
operator|=
name|t1
expr_stmt|;
return|return
operator|(
literal|1
operator|)
return|;
block|}
name|t2
operator|=
name|tdot
expr_stmt|;
name|tdot
operator|=
name|t1
expr_stmt|;
return|return
operator|(
name|t2
operator|)
return|;
block|}
end_block

begin_macro
name|cget
argument_list|(
argument|n
argument_list|,
argument|space
argument_list|)
end_macro

begin_block
block|{
specifier|register
name|w
expr_stmt|;
name|w
operator|=
name|get
argument_list|(
name|n
argument_list|,
name|space
argument_list|)
expr_stmt|;
if|if
condition|(
name|errflg
condition|)
name|reset
argument_list|()
expr_stmt|;
return|return
operator|(
name|w
operator|)
return|;
block|}
end_block

begin_macro
name|printc
argument_list|(
argument|c
argument_list|)
end_macro

begin_block
block|{
if|if
condition|(
name|c
operator|<
literal|' '
operator|||
name|c
operator|>
literal|'~'
condition|)
name|printf
argument_list|(
literal|"\\%o"
argument_list|,
name|c
argument_list|)
expr_stmt|;
else|else
name|printf
argument_list|(
literal|"%c"
argument_list|,
name|c
argument_list|)
expr_stmt|;
block|}
end_block

begin_macro
name|expr
argument_list|()
end_macro

begin_block
block|{
name|int
name|i
decl_stmt|,
name|t1
decl_stmt|,
name|t2
decl_stmt|,
name|donef
decl_stmt|,
name|lastop
decl_stmt|,
name|b
decl_stmt|;
name|tdot
operator|=
literal|0
expr_stmt|;
name|adrflg
operator|=
literal|0
expr_stmt|;
name|lastop
operator|=
literal|'+'
expr_stmt|;
name|ssymval
operator|=
literal|0
expr_stmt|;
name|donef
operator|=
literal|0
expr_stmt|;
name|loop
label|:
name|fsymbol
index|[
literal|0
index|]
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|symchar
argument_list|(
literal|0
argument_list|)
condition|)
block|{
name|adrflg
operator|++
expr_stmt|;
name|symcollect
argument_list|(
literal|'_'
argument_list|)
expr_stmt|;
if|if
condition|(
operator|*
name|lp
operator|++
operator|==
literal|':'
operator|&&
name|symchar
argument_list|(
literal|0
argument_list|)
condition|)
block|{
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|8
condition|;
name|i
operator|++
control|)
name|fsymbol
index|[
name|i
index|]
operator|=
name|tsym
index|[
name|i
index|]
expr_stmt|;
name|fsymbol
index|[
literal|0
index|]
operator|=
literal|'~'
expr_stmt|;
name|symcollect
argument_list|(
literal|0
argument_list|)
expr_stmt|;
block|}
else|else
name|lp
operator|--
expr_stmt|;
if|if
condition|(
name|symlook
argument_list|(
name|tsym
argument_list|)
operator|==
literal|0
condition|)
block|{
name|errflg
operator|++
expr_stmt|;
name|reset
argument_list|()
expr_stmt|;
block|}
goto|goto
name|loop
goto|;
block|}
if|if
condition|(
operator|*
name|lp
operator|>=
literal|'0'
operator|&&
operator|*
name|lp
operator|<=
literal|'9'
condition|)
block|{
name|adrflg
operator|++
expr_stmt|;
name|ssymval
operator|=
literal|0
expr_stmt|;
if|if
condition|(
operator|*
name|lp
operator|==
literal|'0'
condition|)
name|b
operator|=
literal|8
expr_stmt|;
else|else
name|b
operator|=
literal|10
expr_stmt|;
while|while
condition|(
operator|*
name|lp
operator|>=
literal|'0'
operator|&&
operator|*
name|lp
operator|<=
literal|'9'
condition|)
block|{
name|ssymval
operator|=
operator|*
name|b
expr_stmt|;
name|ssymval
operator|=
operator|+
operator|*
name|lp
operator|++
operator|-
literal|'0'
expr_stmt|;
block|}
goto|goto
name|loop
goto|;
block|}
switch|switch
condition|(
operator|*
name|lp
condition|)
block|{
default|default:
name|donef
operator|++
expr_stmt|;
case|case
literal|'+'
case|:
case|case
literal|'-'
case|:
switch|switch
condition|(
name|lastop
condition|)
block|{
case|case
literal|'+'
case|:
name|tdot
operator|=
operator|+
name|ssymval
expr_stmt|;
goto|goto
name|op
goto|;
case|case
literal|'-'
case|:
name|tdot
operator|=
operator|-
name|ssymval
expr_stmt|;
name|op
label|:
if|if
condition|(
name|donef
condition|)
return|return
operator|(
name|adrflg
operator|)
return|;
else|else
name|lastop
operator|=
operator|*
name|lp
operator|++
expr_stmt|;
block|}
goto|goto
name|loop
goto|;
case|case
literal|' '
case|:
case|case
literal|'\t'
case|:
name|lp
operator|++
expr_stmt|;
goto|goto
name|loop
goto|;
case|case
literal|'['
case|:
name|lp
operator|++
expr_stmt|;
name|t1
operator|=
name|ssymval
expr_stmt|;
name|t2
operator|=
name|tdot
expr_stmt|;
if|if
condition|(
name|expr
argument_list|()
operator|==
literal|0
condition|)
name|tdot
operator|=
literal|0
expr_stmt|;
name|ssymval
operator|=
name|cget
argument_list|(
name|t1
operator|+
operator|(
name|tdot
operator|<<
literal|1
operator|)
argument_list|,
name|DSP
argument_list|)
expr_stmt|;
name|tdot
operator|=
name|t2
expr_stmt|;
if|if
condition|(
operator|*
name|lp
operator|==
literal|']'
condition|)
name|lp
operator|++
expr_stmt|;
goto|goto
name|loop
goto|;
block|}
block|}
end_block

begin_macro
name|symcollect
argument_list|(
argument|c
argument_list|)
end_macro

begin_block
block|{
specifier|register
name|char
modifier|*
name|p
decl_stmt|;
name|p
operator|=
name|tsym
expr_stmt|;
if|if
condition|(
name|c
condition|)
operator|*
name|p
operator|++
operator|=
name|c
expr_stmt|;
while|while
condition|(
name|symchar
argument_list|(
literal|1
argument_list|)
condition|)
block|{
if|if
condition|(
name|p
operator|<
operator|&
name|tsym
index|[
literal|8
index|]
condition|)
operator|*
name|p
operator|++
operator|=
operator|*
name|lp
expr_stmt|;
name|lp
operator|++
expr_stmt|;
block|}
while|while
condition|(
name|p
operator|<
operator|&
name|tsym
index|[
literal|8
index|]
condition|)
operator|*
name|p
operator|++
operator|=
literal|0
expr_stmt|;
block|}
end_block

begin_macro
name|symchar
argument_list|(
argument|dig
argument_list|)
end_macro

begin_block
block|{
if|if
condition|(
operator|*
name|lp
operator|>=
literal|'a'
operator|&&
operator|*
name|lp
operator|<=
literal|'z'
operator|||
operator|*
name|lp
operator|==
literal|'_'
condition|)
return|return
operator|(
literal|1
operator|)
return|;
if|if
condition|(
name|dig
operator|&&
operator|*
name|lp
operator|>=
literal|'0'
operator|&&
operator|*
name|lp
operator|<=
literal|'9'
condition|)
return|return
operator|(
literal|1
operator|)
return|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_block

begin_macro
name|error
argument_list|()
end_macro

begin_block
block|{
name|errflg
operator|++
expr_stmt|;
name|reset
argument_list|()
expr_stmt|;
block|}
end_block

begin_macro
name|printtrace
argument_list|()
end_macro

begin_block
block|{
name|int
name|tpc
decl_stmt|,
name|tr5
decl_stmt|,
name|narg
decl_stmt|,
name|argp
decl_stmt|,
name|i
decl_stmt|;
if|if
condition|(
name|modifier
operator|==
literal|'r'
condition|)
block|{
name|printregs
argument_list|()
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|modifier
operator|==
literal|'f'
operator|||
name|modifier
operator|==
literal|'d'
condition|)
block|{
name|printfregs
argument_list|()
expr_stmt|;
return|return;
block|}
name|tpc
operator|=
name|uregs
index|[
name|pc
index|]
expr_stmt|;
name|tr5
operator|=
name|uregs
index|[
name|r5
index|]
expr_stmt|;
if|if
condition|(
name|locsr5
condition|)
if|if
condition|(
name|narg
operator|=
name|get
argument_list|(
name|locsr5
argument_list|,
name|DSP
argument_list|)
condition|)
block|{
name|tr5
operator|=
name|narg
expr_stmt|;
block|}
name|callev
operator|=
literal|0
expr_stmt|;
while|while
condition|(
name|errflg
operator|==
literal|0
condition|)
block|{
name|narg
operator|=
name|findroutine
argument_list|(
name|tpc
argument_list|,
name|tr5
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"%2d: %.8s("
argument_list|,
name|callev
argument_list|,
name|ssymbol
argument_list|)
expr_stmt|;
if|if
condition|(
operator|--
name|narg
operator|>=
literal|0
condition|)
name|printf
argument_list|(
literal|"%.1o"
argument_list|,
name|get
argument_list|(
name|tr5
operator|+
literal|4
argument_list|,
name|DSP
argument_list|)
argument_list|)
expr_stmt|;
name|argp
operator|=
name|tr5
operator|+
literal|4
expr_stmt|;
while|while
condition|(
operator|--
name|narg
operator|>=
literal|0
condition|)
name|printf
argument_list|(
literal|",%.1o"
argument_list|,
name|get
argument_list|(
name|argp
operator|=
operator|+
literal|2
argument_list|,
name|DSP
argument_list|)
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|")\n"
argument_list|)
expr_stmt|;
name|tpc
operator|=
name|get
argument_list|(
name|tr5
operator|+
literal|2
argument_list|,
name|DSP
argument_list|)
expr_stmt|;
if|if
condition|(
name|callev
operator|<
literal|50
condition|)
block|{
name|entpt
index|[
name|callev
index|]
operator|=
name|ssymval
expr_stmt|;
name|callist
index|[
name|callev
operator|++
index|]
operator|=
name|tr5
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|tr5
operator|=
name|get
argument_list|(
name|tr5
argument_list|,
name|DSP
argument_list|)
operator|)
operator|==
literal|0
condition|)
break|break;
block|}
block|}
end_block

begin_macro
name|setstack
argument_list|()
end_macro

begin_block
block|{
specifier|register
name|int
name|tpc
decl_stmt|,
name|tr5
decl_stmt|,
name|i
decl_stmt|;
name|tpc
operator|=
name|uregs
index|[
name|pc
index|]
expr_stmt|;
name|tr5
operator|=
name|uregs
index|[
name|r5
index|]
expr_stmt|;
if|if
condition|(
name|locsr5
condition|)
if|if
condition|(
name|i
operator|=
name|get
argument_list|(
name|locsr5
argument_list|,
name|DSP
argument_list|)
condition|)
block|{
name|tr5
operator|=
name|i
expr_stmt|;
block|}
name|callev
operator|=
literal|0
expr_stmt|;
while|while
condition|(
name|errflg
operator|==
literal|0
condition|)
block|{
name|findroutine
argument_list|(
name|tpc
argument_list|,
name|tr5
argument_list|)
expr_stmt|;
name|tpc
operator|=
name|get
argument_list|(
name|tr5
operator|+
literal|2
argument_list|,
name|DSP
argument_list|)
expr_stmt|;
if|if
condition|(
name|callev
operator|>=
literal|50
condition|)
break|break;
name|entpt
index|[
name|callev
index|]
operator|=
name|ssymval
expr_stmt|;
name|callist
index|[
name|callev
operator|++
index|]
operator|=
name|tr5
expr_stmt|;
if|if
condition|(
operator|(
name|tr5
operator|=
name|get
argument_list|(
name|tr5
argument_list|,
name|DSP
argument_list|)
operator|)
operator|==
literal|0
condition|)
break|break;
block|}
name|errflg
operator|=
literal|0
expr_stmt|;
block|}
end_block

begin_macro
name|printfregs
argument_list|()
end_macro

begin_block
block|{
specifier|register
name|i
expr_stmt|;
name|double
name|f
decl_stmt|;
name|printf
argument_list|(
literal|"fpsr	%.1o\n"
argument_list|,
name|regbuf
index|[
literal|0
index|]
operator|.
name|fpsr
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|6
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|regbuf
index|[
literal|0
index|]
operator|.
name|fpsr
operator|&
literal|0200
condition|)
comment|/* long mode */
name|f
operator|=
name|regbuf
index|[
literal|0
index|]
operator|.
name|lfr
index|[
name|frnames
index|[
name|i
index|]
index|]
expr_stmt|;
else|else
name|f
operator|=
name|regbuf
index|[
literal|0
index|]
operator|.
name|sfr
index|[
name|frnames
index|[
name|i
index|]
index|]
expr_stmt|;
name|printf
argument_list|(
literal|"fr%d	%e\n"
argument_list|,
name|i
argument_list|,
name|f
argument_list|)
expr_stmt|;
block|}
block|}
end_block

begin_macro
name|printregs
argument_list|()
end_macro

begin_block
block|{
specifier|register
name|struct
name|reglist
modifier|*
name|p
decl_stmt|;
specifier|register
name|char
modifier|*
name|v
decl_stmt|,
modifier|*
name|d
decl_stmt|;
for|for
control|(
name|p
operator|=
name|reglist
init|;
name|p
operator|<
operator|&
name|reglist
index|[
literal|9
index|]
condition|;
name|p
operator|++
control|)
block|{
name|printf
argument_list|(
literal|"%s	%.1o"
argument_list|,
name|p
operator|->
name|rname
argument_list|,
name|v
operator|=
name|uregs
index|[
name|p
operator|->
name|roffs
index|]
argument_list|)
expr_stmt|;
name|d
operator|=
name|vallook
argument_list|(
name|v
argument_list|)
expr_stmt|;
if|if
condition|(
name|d
operator|<
literal|010000
condition|)
block|{
name|printf
argument_list|(
literal|"	%.8s"
argument_list|,
name|ssymbol
argument_list|)
expr_stmt|;
if|if
condition|(
name|d
condition|)
name|printf
argument_list|(
literal|"+%.1o"
argument_list|,
name|d
argument_list|)
expr_stmt|;
block|}
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
block|}
block|}
end_block

begin_macro
name|findroutine
argument_list|(
argument|rpc
argument_list|,
argument|rr5
argument_list|)
end_macro

begin_block
block|{
specifier|register
name|callpt
operator|,
name|inst
operator|,
name|narg
expr_stmt|;
name|callpt
operator|=
name|get
argument_list|(
name|rr5
operator|+
literal|2
argument_list|,
name|DSP
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|inst
operator|=
name|get
argument_list|(
name|callpt
operator|-
literal|4
argument_list|,
name|ISP
argument_list|)
operator|)
operator|==
literal|04737
condition|)
comment|/* jsr pc,*$... */
name|narg
operator|=
literal|1
expr_stmt|;
elseif|else
if|if
condition|(
operator|(
name|inst
operator|&
operator|~
literal|077
operator|)
operator|==
literal|04700
condition|)
comment|/* jsr pc,... */
name|narg
operator|=
literal|0
expr_stmt|;
else|else
block|{
name|errflg
operator|++
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
name|inst
operator|=
name|vallook
argument_list|(
operator|(
name|inst
operator|==
literal|04767
condition|?
name|callpt
else|:
literal|0
operator|)
operator|+
name|get
argument_list|(
name|callpt
operator|-
literal|2
argument_list|,
name|ISP
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|inst
condition|)
block|{
name|ssymbol
index|[
literal|0
index|]
operator|=
literal|'?'
expr_stmt|;
name|ssymbol
index|[
literal|1
index|]
operator|=
literal|0
expr_stmt|;
name|ssymval
operator|=
literal|0
expr_stmt|;
block|}
name|inst
operator|=
name|get
argument_list|(
name|callpt
argument_list|,
name|ISP
argument_list|)
expr_stmt|;
if|if
condition|(
name|inst
operator|==
literal|05726
condition|)
comment|/* tst (sp)+ */
return|return
operator|(
name|narg
operator|+
literal|1
operator|)
return|;
if|if
condition|(
name|inst
operator|==
literal|022626
condition|)
comment|/* cmp (sp)+,(sp)+ */
return|return
operator|(
name|narg
operator|+
literal|2
operator|)
return|;
if|if
condition|(
name|inst
operator|==
literal|062706
condition|)
comment|/* add $n,sp */
return|return
operator|(
name|narg
operator|+
name|get
argument_list|(
name|callpt
operator|+
literal|2
argument_list|,
name|ISP
argument_list|)
operator|/
literal|2
operator|)
return|;
return|return
operator|(
name|narg
operator|)
return|;
block|}
end_block

begin_macro
name|runcom
argument_list|()
end_macro

begin_block
block|{
name|int
name|stat
decl_stmt|;
specifier|register
name|w
operator|,
name|i
expr_stmt|;
switch|switch
condition|(
name|modifier
condition|)
block|{
comment|/* delete breakpoint */
case|case
literal|'d'
case|:
if|if
condition|(
name|adrflg
operator|==
literal|0
condition|)
name|error
argument_list|()
expr_stmt|;
for|for
control|(
name|w
operator|=
literal|0
init|;
name|w
operator|<
name|NBKP
condition|;
name|w
operator|++
control|)
block|{
name|i
operator|=
name|bkptl
index|[
name|w
index|]
operator|.
name|loc
expr_stmt|;
if|if
condition|(
name|bkptl
index|[
name|w
index|]
operator|.
name|flag
operator|&
name|BADJST
condition|)
name|i
operator|=
operator|-
literal|4
expr_stmt|;
if|if
condition|(
name|dot
operator|==
name|i
condition|)
block|{
if|if
condition|(
name|lastbp
operator|==
name|bkptl
index|[
name|w
index|]
operator|.
name|loc
condition|)
block|{
name|ptrace
argument_list|(
name|WUREGS
argument_list|,
name|pid
argument_list|,
literal|2
operator|*
operator|(
literal|512
operator|+
name|ps
operator|)
argument_list|,
name|uregs
index|[
name|ps
index|]
operator|&
operator|~
literal|020
argument_list|)
expr_stmt|;
name|lastbp
operator|=
literal|0
expr_stmt|;
block|}
else|else
block|{
name|ptrace
argument_list|(
name|WUSER
argument_list|,
name|pid
argument_list|,
name|bkptl
index|[
name|w
index|]
operator|.
name|loc
argument_list|,
name|bkptl
index|[
name|w
index|]
operator|.
name|ins
argument_list|)
expr_stmt|;
block|}
name|bkptl
index|[
name|w
index|]
operator|.
name|loc
operator|=
literal|0
expr_stmt|;
name|bkptl
index|[
name|w
index|]
operator|.
name|flag
operator|=
literal|0
expr_stmt|;
return|return;
block|}
block|}
name|error
argument_list|()
expr_stmt|;
comment|/* set breakpoint */
case|case
literal|'b'
case|:
if|if
condition|(
name|adrflg
operator|==
literal|0
condition|)
name|error
argument_list|()
expr_stmt|;
for|for
control|(
name|w
operator|=
literal|0
init|;
name|w
operator|<
name|NBKP
condition|;
name|w
operator|++
control|)
block|{
name|i
operator|=
name|bkptl
index|[
name|w
index|]
operator|.
name|loc
expr_stmt|;
if|if
condition|(
name|bkptl
index|[
name|w
index|]
operator|.
name|flag
operator|&
name|BADJST
condition|)
name|i
operator|=
operator|-
literal|4
expr_stmt|;
if|if
condition|(
name|i
operator|==
name|dot
condition|)
return|return;
block|}
for|for
control|(
name|w
operator|=
literal|0
init|;
name|w
operator|<
name|NBKP
condition|;
name|w
operator|++
control|)
if|if
condition|(
name|bkptl
index|[
name|w
index|]
operator|.
name|loc
operator|==
literal|0
condition|)
block|{
name|bkptl
index|[
name|w
index|]
operator|.
name|loc
operator|=
name|dot
expr_stmt|;
return|return;
block|}
name|error
argument_list|()
expr_stmt|;
comment|/* run program */
case|case
literal|'r'
case|:
name|lastbp
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|pid
condition|)
block|{
name|ptrace
argument_list|(
name|EXIT
argument_list|,
name|pid
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|pid
operator|=
literal|0
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|pid
operator|=
name|fork
argument_list|()
operator|)
operator|==
literal|0
condition|)
block|{
name|ptrace
argument_list|(
name|SETTRC
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|signal
argument_list|(
name|SIGINT
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|signal
argument_list|(
name|SIGINS
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|doexec
argument_list|()
expr_stmt|;
name|printf
argument_list|(
literal|"Can't execute %s\n"
argument_list|,
name|symfil
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|0
argument_list|)
expr_stmt|;
block|}
name|bpwait
argument_list|(
literal|0
argument_list|)
expr_stmt|;
name|setbp
argument_list|(
literal|1
argument_list|)
expr_stmt|;
name|ptrace
argument_list|(
name|WUREGS
argument_list|,
name|pid
argument_list|,
literal|2
operator|*
operator|(
literal|512
operator|+
name|ps
operator|)
argument_list|,
literal|0170000
argument_list|)
expr_stmt|;
case|case
literal|'c'
case|:
if|if
condition|(
name|pid
operator|==
literal|0
condition|)
name|error
argument_list|()
expr_stmt|;
name|setbp
argument_list|(
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|lastbp
condition|)
block|{
name|w
operator|=
name|lastbp
expr_stmt|;
name|ptrace
argument_list|(
name|CONTIN
argument_list|,
name|pid
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|bpwait
argument_list|(
literal|1
argument_list|)
expr_stmt|;
name|ptrace
argument_list|(
name|WUSER
argument_list|,
name|pid
argument_list|,
name|w
argument_list|,
literal|03
argument_list|)
expr_stmt|;
name|ptrace
argument_list|(
name|WUREGS
argument_list|,
name|pid
argument_list|,
literal|2
operator|*
operator|(
literal|512
operator|+
name|ps
operator|)
argument_list|,
name|uregs
index|[
name|ps
index|]
operator|&
operator|~
literal|020
argument_list|)
expr_stmt|;
name|lastbp
operator|=
literal|0
expr_stmt|;
block|}
name|ptrace
argument_list|(
name|CONTIN
argument_list|,
name|pid
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|bpwait
argument_list|(
literal|1
argument_list|)
expr_stmt|;
name|w
operator|=
name|uregs
index|[
name|pc
index|]
operator|-
literal|2
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|NBKP
condition|;
name|i
operator|++
control|)
if|if
condition|(
name|bkptl
index|[
name|i
index|]
operator|.
name|loc
operator|==
name|w
condition|)
break|break;
if|if
condition|(
name|i
operator|>=
name|NBKP
condition|)
block|{
name|printf
argument_list|(
literal|"%s\n"
argument_list|,
name|signals
index|[
name|signo
index|]
argument_list|)
expr_stmt|;
return|return;
block|}
name|lastbp
operator|=
name|w
expr_stmt|;
name|ptrace
argument_list|(
name|WUSER
argument_list|,
name|pid
argument_list|,
name|w
argument_list|,
name|bkptl
index|[
name|i
index|]
operator|.
name|ins
argument_list|)
expr_stmt|;
name|ptrace
argument_list|(
name|WUREGS
argument_list|,
name|pid
argument_list|,
literal|2
operator|*
operator|(
literal|512
operator|+
name|pc
operator|)
argument_list|,
name|w
argument_list|)
expr_stmt|;
name|ptrace
argument_list|(
name|WUREGS
argument_list|,
name|pid
argument_list|,
literal|2
operator|*
operator|(
literal|512
operator|+
name|ps
operator|)
argument_list|,
name|uregs
index|[
name|ps
index|]
operator||
literal|020
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Breakpoint: "
argument_list|)
expr_stmt|;
name|psymoff
argument_list|(
name|w
argument_list|,
literal|0777
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
return|return;
block|}
name|error
argument_list|()
expr_stmt|;
block|}
end_block

begin_macro
name|doexec
argument_list|()
end_macro

begin_block
block|{
extern|extern _exectrap;
name|char
modifier|*
name|argl
index|[
literal|32
index|]
decl_stmt|;
specifier|register
name|char
modifier|*
name|p
decl_stmt|,
modifier|*
modifier|*
name|ap
decl_stmt|;
specifier|register
name|c
expr_stmt|;
name|_exectrap
operator|++
expr_stmt|;
name|ap
operator|=
name|argl
expr_stmt|;
operator|*
name|ap
operator|++
operator|=
name|symfil
expr_stmt|;
name|p
operator|=
name|lp
expr_stmt|;
do|do
block|{
while|while
condition|(
operator|*
name|p
operator|==
literal|' '
condition|)
name|p
operator|++
expr_stmt|;
if|if
condition|(
operator|*
name|p
operator|==
literal|'\n'
operator|||
operator|*
name|p
operator|==
literal|'\0'
condition|)
break|break;
operator|*
name|ap
operator|++
operator|=
name|p
expr_stmt|;
while|while
condition|(
operator|*
name|p
operator|!=
literal|' '
operator|&&
operator|*
name|p
operator|!=
literal|'\n'
condition|)
name|p
operator|++
expr_stmt|;
name|c
operator|=
operator|*
name|p
expr_stmt|;
operator|*
name|p
operator|++
operator|=
literal|'\0'
expr_stmt|;
block|}
do|while
condition|(
name|c
operator|!=
literal|'\n'
condition|)
do|;
operator|*
name|ap
operator|++
operator|=
literal|0
expr_stmt|;
name|execv
argument_list|(
name|symfil
argument_list|,
name|argl
argument_list|)
expr_stmt|;
block|}
end_block

begin_macro
name|setbp
argument_list|(
argument|runflag
argument_list|)
end_macro

begin_block
block|{
specifier|register
name|w
operator|,
name|i1
operator|,
name|l
expr_stmt|;
name|int
name|i2
decl_stmt|;
for|for
control|(
name|w
operator|=
literal|0
init|;
name|w
operator|<
name|NBKP
condition|;
name|w
operator|++
control|)
block|{
name|l
operator|=
name|bkptl
index|[
name|w
index|]
operator|.
name|loc
expr_stmt|;
if|if
condition|(
name|l
operator|&&
operator|(
name|runflag
operator|||
name|bkptl
index|[
name|w
index|]
operator|.
name|ins
operator|==
literal|0
operator|)
condition|)
block|{
name|i1
operator|=
name|ptrace
argument_list|(
name|RUSER
argument_list|,
name|pid
argument_list|,
name|l
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|i1
operator|==
literal|04567
condition|)
block|{
comment|/* jsr r5,... */
name|i2
operator|=
name|ptrace
argument_list|(
name|RUSER
argument_list|,
name|pid
argument_list|,
name|l
operator|+
literal|2
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|loccsv
operator|==
name|i2
operator|+
name|l
operator|+
literal|4
condition|)
block|{
comment|/* jsr r5,csv */
name|l
operator|=
operator|+
literal|4
expr_stmt|;
name|bkptl
index|[
name|w
index|]
operator|.
name|loc
operator|=
name|l
expr_stmt|;
name|bkptl
index|[
name|w
index|]
operator|.
name|flag
operator|=
operator||
name|BADJST
expr_stmt|;
name|i1
operator|=
name|ptrace
argument_list|(
name|RUSER
argument_list|,
name|pid
argument_list|,
name|l
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
block|}
name|bkptl
index|[
name|w
index|]
operator|.
name|ins
operator|=
name|i1
expr_stmt|;
name|ptrace
argument_list|(
name|WUSER
argument_list|,
name|pid
argument_list|,
name|l
argument_list|,
literal|03
argument_list|)
expr_stmt|;
if|if
condition|(
name|errno
condition|)
block|{
name|printf
argument_list|(
literal|"Can't set breakpoint "
argument_list|)
expr_stmt|;
name|psymoff
argument_list|(
name|bkptl
index|[
name|w
index|]
operator|.
name|loc
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
block|}
block|}
block|}
block|}
end_block

begin_macro
name|bpwait
argument_list|(
argument|f
argument_list|)
end_macro

begin_block
block|{
specifier|extern
name|int
name|onintr
parameter_list|()
function_decl|;
specifier|register
name|w
expr_stmt|;
name|int
name|stat
decl_stmt|;
name|loop
label|:
name|signal
argument_list|(
name|SIGINT
argument_list|,
literal|1
argument_list|)
expr_stmt|;
while|while
condition|(
operator|(
name|w
operator|=
name|wait
argument_list|(
operator|&
name|stat
argument_list|)
operator|)
operator|!=
name|pid
operator|&&
name|w
operator|!=
operator|-
literal|1
condition|)
empty_stmt|;
name|signal
argument_list|(
name|SIGINT
argument_list|,
name|onintr
argument_list|)
expr_stmt|;
if|if
condition|(
name|w
operator|==
operator|-
literal|1
condition|)
block|{
name|ptrace
argument_list|(
name|EXIT
argument_list|,
name|pid
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|pid
operator|=
literal|0
expr_stmt|;
name|printf
argument_list|(
literal|"Wait error\n"
argument_list|)
expr_stmt|;
name|reset
argument_list|()
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|stat
operator|&
literal|0377
operator|)
operator|!=
literal|0177
condition|)
block|{
if|if
condition|(
name|signo
operator|=
name|stat
operator|&
literal|0177
condition|)
name|printf
argument_list|(
literal|"%s\n"
argument_list|,
name|signals
index|[
name|signo
index|]
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Process terminated.\n"
argument_list|)
expr_stmt|;
if|if
condition|(
name|pid
operator|==
name|w
condition|)
block|{
name|pid
operator|=
literal|0
expr_stmt|;
name|reset
argument_list|()
expr_stmt|;
block|}
goto|goto
name|loop
goto|;
block|}
name|signo
operator|=
name|stat
operator|>>
literal|8
expr_stmt|;
name|collinfo
argument_list|()
expr_stmt|;
if|if
condition|(
name|signo
operator|!=
name|SIGTRC
condition|)
block|{
name|printf
argument_list|(
literal|"%s\n"
argument_list|,
name|signals
index|[
name|signo
index|]
argument_list|)
expr_stmt|;
name|reset
argument_list|()
expr_stmt|;
block|}
block|}
end_block

begin_macro
name|collinfo
argument_list|()
end_macro

begin_block
block|{
specifier|register
name|i
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|9
condition|;
name|i
operator|++
control|)
name|uregs
index|[
name|reglist
index|[
name|i
index|]
operator|.
name|roffs
index|]
operator|=
name|ptrace
argument_list|(
name|RUREGS
argument_list|,
name|pid
argument_list|,
literal|2
operator|*
operator|(
literal|512
operator|+
name|reglist
index|[
name|i
index|]
operator|.
name|roffs
operator|)
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|setstack
argument_list|()
expr_stmt|;
block|}
end_block

begin_macro
name|symlook
argument_list|(
argument|symstr
argument_list|)
end_macro

begin_decl_stmt
name|char
modifier|*
name|symstr
decl_stmt|;
end_decl_stmt

begin_block
block|{
specifier|register
name|i
expr_stmt|;
specifier|register
name|symv
expr_stmt|;
name|symset
argument_list|()
expr_stmt|;
if|if
condition|(
name|fsymbol
index|[
literal|0
index|]
operator|==
literal|0
condition|)
block|{
while|while
condition|(
name|symget
argument_list|()
condition|)
block|{
if|if
condition|(
name|eqstr
argument_list|(
name|symbol
argument_list|,
name|symstr
argument_list|)
condition|)
block|{
name|savsym
argument_list|()
expr_stmt|;
return|return
operator|(
literal|1
operator|)
return|;
block|}
block|}
return|return
operator|(
literal|0
operator|)
return|;
block|}
while|while
condition|(
name|symget
argument_list|()
condition|)
block|{
comment|/* wait for function symbol */
if|if
condition|(
name|symbol
index|[
literal|0
index|]
operator|!=
literal|'~'
operator|||
operator|!
name|eqstr
argument_list|(
name|symbol
argument_list|,
name|fsymbol
argument_list|)
condition|)
continue|continue;
name|symv
operator|=
name|symval
expr_stmt|;
while|while
condition|(
name|symget
argument_list|()
operator|&&
name|symbol
index|[
literal|0
index|]
operator|!=
literal|'~'
operator|&&
name|symflg
operator|!=
literal|037
condition|)
if|if
condition|(
name|eqstr
argument_list|(
name|symbol
argument_list|,
name|symstr
argument_list|)
condition|)
return|return
operator|(
name|localsym
argument_list|(
name|symv
argument_list|)
operator|)
return|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
block|}
end_block

begin_macro
name|localsym
argument_list|(
argument|s
argument_list|)
end_macro

begin_block
block|{
specifier|register
name|i
operator|,
name|xr5
expr_stmt|;
comment|/* label, static */
if|if
condition|(
name|symflg
operator|>=
literal|2
operator|&&
name|symflg
operator|<=
literal|4
condition|)
block|{
name|ssymval
operator|=
name|symval
expr_stmt|;
return|return
operator|(
literal|1
operator|)
return|;
block|}
comment|/* auto, arg */
if|if
condition|(
name|symflg
operator|==
literal|1
condition|)
block|{
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|callev
condition|;
name|i
operator|++
control|)
if|if
condition|(
name|entpt
index|[
name|i
index|]
operator|==
name|s
condition|)
block|{
name|ssymval
operator|=
name|symval
operator|+
name|callist
index|[
name|i
index|]
expr_stmt|;
return|return
operator|(
literal|1
operator|)
return|;
block|}
return|return
operator|(
literal|0
operator|)
return|;
block|}
comment|/* register */
if|if
condition|(
name|symflg
operator|==
literal|20
condition|)
block|{
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|callev
condition|;
name|i
operator|++
control|)
if|if
condition|(
name|entpt
index|[
name|i
index|]
operator|==
name|s
condition|)
block|{
if|if
condition|(
name|i
operator|==
literal|0
condition|)
block|{
return|return
operator|(
literal|0
operator|)
return|;
comment|/* temp, no reg lvalue */
block|}
name|ssymval
operator|=
name|callist
index|[
name|i
operator|-
literal|1
index|]
operator|-
literal|10
operator|+
literal|2
operator|*
name|symval
expr_stmt|;
return|return
operator|(
literal|1
operator|)
return|;
block|}
return|return
operator|(
literal|0
operator|)
return|;
block|}
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_block

begin_macro
name|eqstr
argument_list|(
argument|as1
argument_list|,
argument|as2
argument_list|)
end_macro

begin_decl_stmt
name|int
modifier|*
name|as1
decl_stmt|,
modifier|*
name|as2
decl_stmt|;
end_decl_stmt

begin_block
block|{
specifier|register
name|char
modifier|*
name|s1
decl_stmt|,
modifier|*
name|s2
decl_stmt|,
modifier|*
name|es1
decl_stmt|;
name|s1
operator|=
name|as1
expr_stmt|;
name|s2
operator|=
name|as2
expr_stmt|;
for|for
control|(
name|es1
operator|=
name|s1
operator|+
literal|8
init|;
name|s1
operator|<
name|es1
condition|;
control|)
if|if
condition|(
operator|*
name|s1
operator|++
operator|!=
operator|*
name|s2
operator|++
condition|)
return|return
operator|(
literal|0
operator|)
return|;
return|return
operator|(
literal|1
operator|)
return|;
block|}
end_block

begin_macro
name|vallook
argument_list|(
argument|value
argument_list|)
end_macro

begin_decl_stmt
name|char
modifier|*
name|value
decl_stmt|;
end_decl_stmt

begin_block
block|{
specifier|register
name|char
modifier|*
name|diff
decl_stmt|;
name|diff
operator|=
literal|0177777
expr_stmt|;
name|symset
argument_list|()
expr_stmt|;
while|while
condition|(
name|symget
argument_list|()
condition|)
if|if
condition|(
name|symflg
operator|&
literal|040
operator|&&
name|value
operator|-
name|symval
operator|<=
name|diff
condition|)
block|{
if|if
condition|(
name|symflg
operator|==
literal|1
operator|&&
name|value
operator|!=
name|symval
condition|)
continue|continue;
name|savsym
argument_list|(
literal|'_'
argument_list|)
expr_stmt|;
name|diff
operator|=
name|value
operator|-
name|symval
expr_stmt|;
block|}
return|return
operator|(
name|diff
operator|)
return|;
block|}
end_block

begin_macro
name|get
argument_list|(
argument|aaddr
argument_list|,
argument|space
argument_list|)
end_macro

begin_decl_stmt
name|char
modifier|*
name|aaddr
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|int
name|w
decl_stmt|;
specifier|register
name|int
name|w1
decl_stmt|;
specifier|register
name|char
modifier|*
name|addr
decl_stmt|;
name|addr
operator|=
name|aaddr
expr_stmt|;
if|if
condition|(
name|pid
condition|)
block|{
comment|/* tracing on? */
name|w
operator|=
name|ptrace
argument_list|(
name|space
operator|==
name|DSP
condition|?
name|RUSER
else|:
name|RIUSER
argument_list|,
name|pid
argument_list|,
name|addr
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|addr
operator|&
literal|01
condition|)
block|{
name|w1
operator|=
name|ptrace
argument_list|(
name|space
operator|==
name|DSP
condition|?
name|RUSER
else|:
name|RIUSER
argument_list|,
name|pid
argument_list|,
name|addr
operator|+
literal|1
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|w
operator|=
operator|(
name|w
operator|>>
literal|8
operator|)
operator|&
literal|0377
operator||
operator|(
name|w1
operator|<<
literal|8
operator|)
expr_stmt|;
block|}
name|errflg
operator|=
name|errno
expr_stmt|;
return|return
operator|(
name|w
operator|)
return|;
block|}
name|w
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|idsep
operator|==
literal|0
operator|&&
name|addr
operator|<
name|regbuf
operator|->
name|u_tsize
operator|||
name|idsep
operator|&&
name|space
operator|==
name|ISP
condition|)
block|{
name|seek
argument_list|(
name|fsym
argument_list|,
name|addr
operator|+
literal|020
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|read
argument_list|(
name|fsym
argument_list|,
operator|&
name|w
argument_list|,
literal|2
argument_list|)
operator|!=
literal|2
condition|)
name|errflg
operator|++
expr_stmt|;
return|return
operator|(
name|w
operator|)
return|;
block|}
if|if
condition|(
name|addr
operator|<
name|rtsize
operator|+
name|regbuf
operator|->
name|u_dsize
condition|)
block|{
if|if
condition|(
name|idsep
operator|==
literal|0
condition|)
name|addr
operator|=
operator|-
name|rtsize
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|-
name|addr
operator|<
name|regbuf
operator|->
name|u_ssize
condition|)
name|addr
operator|=
operator|+
name|regbuf
operator|->
name|u_dsize
operator|+
name|regbuf
operator|->
name|u_ssize
expr_stmt|;
else|else
name|errflg
operator|++
expr_stmt|;
name|seek
argument_list|(
name|fcore
argument_list|,
name|addr
operator|+
literal|1024
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|read
argument_list|(
name|fcore
argument_list|,
operator|&
name|w
argument_list|,
literal|2
argument_list|)
operator|<
literal|2
condition|)
name|errflg
operator|++
expr_stmt|;
return|return
operator|(
name|w
operator|)
return|;
block|}
end_block

begin_macro
name|symset
argument_list|()
end_macro

begin_block
block|{
name|symct
operator|=
name|symlen
expr_stmt|;
name|symptr
operator|=
name|symbuf
expr_stmt|;
name|seek
argument_list|(
name|fsym
argument_list|,
name|symoff
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
end_block

begin_macro
name|symget
argument_list|()
end_macro

begin_block
block|{
specifier|register
name|int
modifier|*
name|p
decl_stmt|,
modifier|*
name|q
decl_stmt|;
if|if
condition|(
operator|(
name|symct
operator|=
operator|-
literal|12
operator|)
operator|<
literal|0
condition|)
return|return
operator|(
literal|0
operator|)
return|;
if|if
condition|(
name|symptr
operator|<
operator|&
name|symbuf
index|[
name|symcor
index|]
condition|)
block|{
name|p
operator|=
name|symptr
expr_stmt|;
for|for
control|(
name|q
operator|=
name|symbol
init|;
name|q
operator|<=
operator|&
name|symval
condition|;
control|)
operator|*
name|q
operator|++
operator|=
operator|*
name|p
operator|++
expr_stmt|;
name|symptr
operator|=
name|p
expr_stmt|;
return|return
operator|(
literal|1
operator|)
return|;
block|}
return|return
operator|(
name|read
argument_list|(
name|fsym
argument_list|,
name|symbol
argument_list|,
literal|12
argument_list|)
operator|==
literal|12
operator|)
return|;
block|}
end_block

begin_macro
name|savsym
argument_list|(
argument|skip
argument_list|)
end_macro

begin_block
block|{
specifier|register
name|int
name|ch
decl_stmt|;
specifier|register
name|char
modifier|*
name|p
decl_stmt|,
modifier|*
name|q
decl_stmt|;
name|p
operator|=
name|symbol
expr_stmt|;
name|q
operator|=
name|ssymbol
expr_stmt|;
while|while
condition|(
name|p
operator|<
name|symbol
operator|+
literal|8
operator|&&
operator|(
name|ch
operator|=
operator|*
name|p
operator|++
operator|)
condition|)
block|{
if|if
condition|(
name|ch
operator|==
name|skip
condition|)
continue|continue;
operator|*
name|q
operator|++
operator|=
name|ch
expr_stmt|;
block|}
while|while
condition|(
name|q
operator|<
name|ssymbol
operator|+
literal|8
condition|)
operator|*
name|q
operator|++
operator|=
literal|'\0'
expr_stmt|;
name|ssymflg
operator|=
name|symflg
expr_stmt|;
name|ssymval
operator|=
name|symval
expr_stmt|;
block|}
end_block

begin_macro
name|onintr
argument_list|()
end_macro

begin_block
block|{
name|putchar
argument_list|(
literal|'\n'
argument_list|)
expr_stmt|;
name|errflg
operator|++
expr_stmt|;
name|reset
argument_list|()
expr_stmt|;
block|}
end_block

end_unit


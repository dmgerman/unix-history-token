begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/**  * Copyright (c) 2016-present, Yann Collet, Facebook, Inc.  * All rights reserved.  *  * This source code is licensed under the BSD-style license found in the  * LICENSE file in the root directory of this source tree. An additional grant  * of patent rights can be found in the PATENTS file in the same directory.  */
end_comment

begin_comment
comment|/*-************************************ *  Compiler specific **************************************/
end_comment

begin_ifdef
ifdef|#
directive|ifdef
name|_MSC_VER
end_ifdef

begin_comment
comment|/* Visual Studio */
end_comment

begin_define
define|#
directive|define
name|_CRT_SECURE_NO_WARNINGS
end_define

begin_comment
comment|/* fgets */
end_comment

begin_pragma
pragma|#
directive|pragma
name|warning
name|(
name|disable
name|:
name|4127
name|)
end_pragma

begin_comment
comment|/* disable: C4127: conditional expression is constant */
end_comment

begin_pragma
pragma|#
directive|pragma
name|warning
name|(
name|disable
name|:
name|4204
name|)
end_pragma

begin_comment
comment|/* disable: C4204: non-constant aggregate initializer */
end_comment

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/*-************************************ *  Includes **************************************/
end_comment

begin_include
include|#
directive|include
file|<stdlib.h>
end_include

begin_comment
comment|/* free */
end_comment

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_comment
comment|/* fgets, sscanf */
end_comment

begin_include
include|#
directive|include
file|<string.h>
end_include

begin_comment
comment|/* strcmp */
end_comment

begin_include
include|#
directive|include
file|<time.h>
end_include

begin_comment
comment|/* clock_t */
end_comment

begin_define
define|#
directive|define
name|ZSTD_STATIC_LINKING_ONLY
end_define

begin_comment
comment|/* ZSTD_compressContinue, ZSTD_compressBlock */
end_comment

begin_include
include|#
directive|include
file|"zstd.h"
end_include

begin_comment
comment|/* ZSTD_VERSION_STRING */
end_comment

begin_include
include|#
directive|include
file|"zstd_errors.h"
end_include

begin_comment
comment|/* ZSTD_getErrorCode */
end_comment

begin_define
define|#
directive|define
name|ZDICT_STATIC_LINKING_ONLY
end_define

begin_include
include|#
directive|include
file|"zdict.h"
end_include

begin_comment
comment|/* ZDICT_trainFromBuffer */
end_comment

begin_include
include|#
directive|include
file|"datagen.h"
end_include

begin_comment
comment|/* RDG_genBuffer */
end_comment

begin_include
include|#
directive|include
file|"mem.h"
end_include

begin_define
define|#
directive|define
name|XXH_STATIC_LINKING_ONLY
end_define

begin_include
include|#
directive|include
file|"xxhash.h"
end_include

begin_comment
comment|/* XXH64 */
end_comment

begin_comment
comment|/*-************************************ *  Constants **************************************/
end_comment

begin_define
define|#
directive|define
name|KB
value|*(1U<<10)
end_define

begin_define
define|#
directive|define
name|MB
value|*(1U<<20)
end_define

begin_define
define|#
directive|define
name|GB
value|*(1U<<30)
end_define

begin_decl_stmt
specifier|static
specifier|const
name|U32
name|FUZ_compressibility_default
init|=
literal|50
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
specifier|const
name|U32
name|nbTestsDefault
init|=
literal|30000
decl_stmt|;
end_decl_stmt

begin_comment
comment|/*-************************************ *  Display Macros **************************************/
end_comment

begin_define
define|#
directive|define
name|DISPLAY
parameter_list|(
modifier|...
parameter_list|)
value|fprintf(stderr, __VA_ARGS__)
end_define

begin_define
define|#
directive|define
name|DISPLAYLEVEL
parameter_list|(
name|l
parameter_list|,
modifier|...
parameter_list|)
value|if (g_displayLevel>=l) { DISPLAY(__VA_ARGS__); }
end_define

begin_decl_stmt
specifier|static
name|U32
name|g_displayLevel
init|=
literal|2
decl_stmt|;
end_decl_stmt

begin_define
define|#
directive|define
name|DISPLAYUPDATE
parameter_list|(
name|l
parameter_list|,
modifier|...
parameter_list|)
value|if (g_displayLevel>=l) { \             if ((FUZ_clockSpan(g_displayClock)> g_refreshRate) || (g_displayLevel>=4)) \             { g_displayClock = clock(); DISPLAY(__VA_ARGS__); \             if (g_displayLevel>=4) fflush(stdout); } }
end_define

begin_decl_stmt
specifier|static
specifier|const
name|clock_t
name|g_refreshRate
init|=
name|CLOCKS_PER_SEC
operator|/
literal|6
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|clock_t
name|g_displayClock
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_comment
comment|/*-******************************************************* *  Fuzzer functions *********************************************************/
end_comment

begin_define
define|#
directive|define
name|MIN
parameter_list|(
name|a
parameter_list|,
name|b
parameter_list|)
value|((a)<(b)?(a):(b))
end_define

begin_define
define|#
directive|define
name|MAX
parameter_list|(
name|a
parameter_list|,
name|b
parameter_list|)
value|((a)>(b)?(a):(b))
end_define

begin_function
specifier|static
name|clock_t
name|FUZ_clockSpan
parameter_list|(
name|clock_t
name|cStart
parameter_list|)
block|{
return|return
name|clock
argument_list|()
operator|-
name|cStart
return|;
comment|/* works even when overflow; max span ~ 30mn */
block|}
end_function

begin_define
define|#
directive|define
name|FUZ_rotl32
parameter_list|(
name|x
parameter_list|,
name|r
parameter_list|)
value|((x<< r) | (x>> (32 - r)))
end_define

begin_function
specifier|static
name|unsigned
name|FUZ_rand
parameter_list|(
name|unsigned
modifier|*
name|src
parameter_list|)
block|{
specifier|static
specifier|const
name|U32
name|prime1
init|=
literal|2654435761U
decl_stmt|;
specifier|static
specifier|const
name|U32
name|prime2
init|=
literal|2246822519U
decl_stmt|;
name|U32
name|rand32
init|=
operator|*
name|src
decl_stmt|;
name|rand32
operator|*=
name|prime1
expr_stmt|;
name|rand32
operator|+=
name|prime2
expr_stmt|;
name|rand32
operator|=
name|FUZ_rotl32
argument_list|(
name|rand32
argument_list|,
literal|13
argument_list|)
expr_stmt|;
operator|*
name|src
operator|=
name|rand32
expr_stmt|;
return|return
name|rand32
operator|>>
literal|5
return|;
block|}
end_function

begin_function
specifier|static
name|unsigned
name|FUZ_highbit32
parameter_list|(
name|U32
name|v32
parameter_list|)
block|{
name|unsigned
name|nbBits
init|=
literal|0
decl_stmt|;
if|if
condition|(
name|v32
operator|==
literal|0
condition|)
return|return
literal|0
return|;
while|while
condition|(
name|v32
condition|)
name|v32
operator|>>=
literal|1
operator|,
name|nbBits
operator|++
expr_stmt|;
return|return
name|nbBits
return|;
block|}
end_function

begin_comment
comment|/*============================================= *   Basic Unit tests =============================================*/
end_comment

begin_define
define|#
directive|define
name|CHECK_V
parameter_list|(
name|var
parameter_list|,
name|fn
parameter_list|)
value|size_t const var = fn; if (ZSTD_isError(var)) goto _output_error
end_define

begin_define
define|#
directive|define
name|CHECK
parameter_list|(
name|fn
parameter_list|)
value|{ CHECK_V(err, fn); }
end_define

begin_define
define|#
directive|define
name|CHECKPLUS
parameter_list|(
name|var
parameter_list|,
name|fn
parameter_list|,
name|more
parameter_list|)
value|{ CHECK_V(var, fn); more; }
end_define

begin_function
specifier|static
name|int
name|basicUnitTests
parameter_list|(
name|U32
name|seed
parameter_list|,
name|double
name|compressibility
parameter_list|)
block|{
name|size_t
specifier|const
name|CNBuffSize
init|=
literal|5
name|MB
decl_stmt|;
name|void
modifier|*
specifier|const
name|CNBuffer
init|=
name|malloc
argument_list|(
name|CNBuffSize
argument_list|)
decl_stmt|;
name|void
modifier|*
specifier|const
name|compressedBuffer
init|=
name|malloc
argument_list|(
name|ZSTD_compressBound
argument_list|(
name|CNBuffSize
argument_list|)
argument_list|)
decl_stmt|;
name|void
modifier|*
specifier|const
name|decodedBuffer
init|=
name|malloc
argument_list|(
name|CNBuffSize
argument_list|)
decl_stmt|;
name|ZSTD_DCtx
modifier|*
name|dctx
init|=
name|ZSTD_createDCtx
argument_list|()
decl_stmt|;
name|int
name|testResult
init|=
literal|0
decl_stmt|;
name|U32
name|testNb
init|=
literal|0
decl_stmt|;
name|size_t
name|cSize
decl_stmt|;
comment|/* Create compressible noise */
if|if
condition|(
operator|!
name|CNBuffer
operator|||
operator|!
name|compressedBuffer
operator|||
operator|!
name|decodedBuffer
condition|)
block|{
name|DISPLAY
argument_list|(
literal|"Not enough memory, aborting\n"
argument_list|)
expr_stmt|;
name|testResult
operator|=
literal|1
expr_stmt|;
goto|goto
name|_end
goto|;
block|}
name|RDG_genBuffer
argument_list|(
name|CNBuffer
argument_list|,
name|CNBuffSize
argument_list|,
name|compressibility
argument_list|,
literal|0.
argument_list|,
name|seed
argument_list|)
expr_stmt|;
comment|/* Basic tests */
name|DISPLAYLEVEL
argument_list|(
literal|4
argument_list|,
literal|"test%3i : ZSTD_getErrorName : "
argument_list|,
name|testNb
operator|++
argument_list|)
expr_stmt|;
block|{
specifier|const
name|char
modifier|*
name|errorString
init|=
name|ZSTD_getErrorName
argument_list|(
literal|0
argument_list|)
decl_stmt|;
name|DISPLAYLEVEL
argument_list|(
literal|4
argument_list|,
literal|"OK : %s \n"
argument_list|,
name|errorString
argument_list|)
expr_stmt|;
block|}
name|DISPLAYLEVEL
argument_list|(
literal|4
argument_list|,
literal|"test%3i : ZSTD_getErrorName with wrong value : "
argument_list|,
name|testNb
operator|++
argument_list|)
expr_stmt|;
block|{
specifier|const
name|char
modifier|*
name|errorString
init|=
name|ZSTD_getErrorName
argument_list|(
literal|499
argument_list|)
decl_stmt|;
name|DISPLAYLEVEL
argument_list|(
literal|4
argument_list|,
literal|"OK : %s \n"
argument_list|,
name|errorString
argument_list|)
expr_stmt|;
block|}
name|DISPLAYLEVEL
argument_list|(
literal|4
argument_list|,
literal|"test%3i : compress %u bytes : "
argument_list|,
name|testNb
operator|++
argument_list|,
operator|(
name|U32
operator|)
name|CNBuffSize
argument_list|)
expr_stmt|;
name|CHECKPLUS
argument_list|(
name|r
argument_list|,
name|ZSTD_compress
argument_list|(
name|compressedBuffer
argument_list|,
name|ZSTD_compressBound
argument_list|(
name|CNBuffSize
argument_list|)
argument_list|,
name|CNBuffer
argument_list|,
name|CNBuffSize
argument_list|,
literal|1
argument_list|)
argument_list|,
name|cSize
operator|=
name|r
argument_list|)
expr_stmt|;
name|DISPLAYLEVEL
argument_list|(
literal|4
argument_list|,
literal|"OK (%u bytes : %.2f%%)\n"
argument_list|,
operator|(
name|U32
operator|)
name|cSize
argument_list|,
operator|(
name|double
operator|)
name|cSize
operator|/
name|CNBuffSize
operator|*
literal|100
argument_list|)
expr_stmt|;
name|DISPLAYLEVEL
argument_list|(
literal|4
argument_list|,
literal|"test%3i : decompressed size test : "
argument_list|,
name|testNb
operator|++
argument_list|)
expr_stmt|;
block|{
name|unsigned
name|long
name|long
specifier|const
name|rSize
init|=
name|ZSTD_findDecompressedSize
argument_list|(
name|compressedBuffer
argument_list|,
name|cSize
argument_list|)
decl_stmt|;
if|if
condition|(
name|rSize
operator|!=
name|CNBuffSize
condition|)
goto|goto
name|_output_error
goto|;
block|}
name|DISPLAYLEVEL
argument_list|(
literal|4
argument_list|,
literal|"OK \n"
argument_list|)
expr_stmt|;
name|DISPLAYLEVEL
argument_list|(
literal|4
argument_list|,
literal|"test%3i : decompress %u bytes : "
argument_list|,
name|testNb
operator|++
argument_list|,
operator|(
name|U32
operator|)
name|CNBuffSize
argument_list|)
expr_stmt|;
block|{
name|size_t
specifier|const
name|r
init|=
name|ZSTD_decompress
argument_list|(
name|decodedBuffer
argument_list|,
name|CNBuffSize
argument_list|,
name|compressedBuffer
argument_list|,
name|cSize
argument_list|)
decl_stmt|;
if|if
condition|(
name|r
operator|!=
name|CNBuffSize
condition|)
goto|goto
name|_output_error
goto|;
block|}
name|DISPLAYLEVEL
argument_list|(
literal|4
argument_list|,
literal|"OK \n"
argument_list|)
expr_stmt|;
name|DISPLAYLEVEL
argument_list|(
literal|4
argument_list|,
literal|"test%3i : check decompressed result : "
argument_list|,
name|testNb
operator|++
argument_list|)
expr_stmt|;
block|{
name|size_t
name|u
decl_stmt|;
for|for
control|(
name|u
operator|=
literal|0
init|;
name|u
operator|<
name|CNBuffSize
condition|;
name|u
operator|++
control|)
block|{
if|if
condition|(
operator|(
operator|(
name|BYTE
operator|*
operator|)
name|decodedBuffer
operator|)
index|[
name|u
index|]
operator|!=
operator|(
operator|(
name|BYTE
operator|*
operator|)
name|CNBuffer
operator|)
index|[
name|u
index|]
condition|)
goto|goto
name|_output_error
goto|;
empty_stmt|;
block|}
block|}
name|DISPLAYLEVEL
argument_list|(
literal|4
argument_list|,
literal|"OK \n"
argument_list|)
expr_stmt|;
name|DISPLAYLEVEL
argument_list|(
literal|4
argument_list|,
literal|"test%3i : decompress with null dict : "
argument_list|,
name|testNb
operator|++
argument_list|)
expr_stmt|;
block|{
name|size_t
specifier|const
name|r
init|=
name|ZSTD_decompress_usingDict
argument_list|(
name|dctx
argument_list|,
name|decodedBuffer
argument_list|,
name|CNBuffSize
argument_list|,
name|compressedBuffer
argument_list|,
name|cSize
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
decl_stmt|;
if|if
condition|(
name|r
operator|!=
name|CNBuffSize
condition|)
goto|goto
name|_output_error
goto|;
block|}
name|DISPLAYLEVEL
argument_list|(
literal|4
argument_list|,
literal|"OK \n"
argument_list|)
expr_stmt|;
name|DISPLAYLEVEL
argument_list|(
literal|4
argument_list|,
literal|"test%3i : decompress with null DDict : "
argument_list|,
name|testNb
operator|++
argument_list|)
expr_stmt|;
block|{
name|size_t
specifier|const
name|r
init|=
name|ZSTD_decompress_usingDDict
argument_list|(
name|dctx
argument_list|,
name|decodedBuffer
argument_list|,
name|CNBuffSize
argument_list|,
name|compressedBuffer
argument_list|,
name|cSize
argument_list|,
name|NULL
argument_list|)
decl_stmt|;
if|if
condition|(
name|r
operator|!=
name|CNBuffSize
condition|)
goto|goto
name|_output_error
goto|;
block|}
name|DISPLAYLEVEL
argument_list|(
literal|4
argument_list|,
literal|"OK \n"
argument_list|)
expr_stmt|;
name|DISPLAYLEVEL
argument_list|(
literal|4
argument_list|,
literal|"test%3i : decompress with 1 missing byte : "
argument_list|,
name|testNb
operator|++
argument_list|)
expr_stmt|;
block|{
name|size_t
specifier|const
name|r
init|=
name|ZSTD_decompress
argument_list|(
name|decodedBuffer
argument_list|,
name|CNBuffSize
argument_list|,
name|compressedBuffer
argument_list|,
name|cSize
operator|-
literal|1
argument_list|)
decl_stmt|;
if|if
condition|(
operator|!
name|ZSTD_isError
argument_list|(
name|r
argument_list|)
condition|)
goto|goto
name|_output_error
goto|;
if|if
condition|(
name|ZSTD_getErrorCode
argument_list|(
operator|(
name|size_t
operator|)
name|r
argument_list|)
operator|!=
name|ZSTD_error_srcSize_wrong
condition|)
goto|goto
name|_output_error
goto|;
block|}
name|DISPLAYLEVEL
argument_list|(
literal|4
argument_list|,
literal|"OK \n"
argument_list|)
expr_stmt|;
name|DISPLAYLEVEL
argument_list|(
literal|4
argument_list|,
literal|"test%3i : decompress with 1 too much byte : "
argument_list|,
name|testNb
operator|++
argument_list|)
expr_stmt|;
block|{
name|size_t
specifier|const
name|r
init|=
name|ZSTD_decompress
argument_list|(
name|decodedBuffer
argument_list|,
name|CNBuffSize
argument_list|,
name|compressedBuffer
argument_list|,
name|cSize
operator|+
literal|1
argument_list|)
decl_stmt|;
if|if
condition|(
operator|!
name|ZSTD_isError
argument_list|(
name|r
argument_list|)
condition|)
goto|goto
name|_output_error
goto|;
if|if
condition|(
name|ZSTD_getErrorCode
argument_list|(
name|r
argument_list|)
operator|!=
name|ZSTD_error_srcSize_wrong
condition|)
goto|goto
name|_output_error
goto|;
block|}
name|DISPLAYLEVEL
argument_list|(
literal|4
argument_list|,
literal|"OK \n"
argument_list|)
expr_stmt|;
comment|/* Simple API multiframe test */
name|DISPLAYLEVEL
argument_list|(
literal|4
argument_list|,
literal|"test%3i : compress multiple frames : "
argument_list|,
name|testNb
operator|++
argument_list|)
expr_stmt|;
block|{
name|size_t
name|off
init|=
literal|0
decl_stmt|;
name|int
name|i
decl_stmt|;
name|int
specifier|const
name|segs
init|=
literal|4
decl_stmt|;
comment|/* only use the first half so we don't push against size limit of compressedBuffer */
name|size_t
specifier|const
name|segSize
init|=
operator|(
name|CNBuffSize
operator|/
literal|2
operator|)
operator|/
name|segs
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|segs
condition|;
name|i
operator|++
control|)
block|{
name|CHECK_V
argument_list|(
name|r
argument_list|,
name|ZSTD_compress
argument_list|(
operator|(
name|BYTE
operator|*
operator|)
name|compressedBuffer
operator|+
name|off
argument_list|,
name|CNBuffSize
operator|-
name|off
argument_list|,
operator|(
name|BYTE
operator|*
operator|)
name|CNBuffer
operator|+
name|segSize
operator|*
name|i
argument_list|,
name|segSize
argument_list|,
literal|5
argument_list|)
argument_list|)
expr_stmt|;
name|off
operator|+=
name|r
expr_stmt|;
if|if
condition|(
name|i
operator|==
name|segs
operator|/
literal|2
condition|)
block|{
comment|/* insert skippable frame */
specifier|const
name|U32
name|skipLen
init|=
literal|128
name|KB
decl_stmt|;
name|MEM_writeLE32
argument_list|(
operator|(
name|BYTE
operator|*
operator|)
name|compressedBuffer
operator|+
name|off
argument_list|,
name|ZSTD_MAGIC_SKIPPABLE_START
argument_list|)
expr_stmt|;
name|MEM_writeLE32
argument_list|(
operator|(
name|BYTE
operator|*
operator|)
name|compressedBuffer
operator|+
name|off
operator|+
literal|4
argument_list|,
name|skipLen
argument_list|)
expr_stmt|;
name|off
operator|+=
name|skipLen
operator|+
name|ZSTD_skippableHeaderSize
expr_stmt|;
block|}
block|}
name|cSize
operator|=
name|off
expr_stmt|;
block|}
name|DISPLAYLEVEL
argument_list|(
literal|4
argument_list|,
literal|"OK \n"
argument_list|)
expr_stmt|;
name|DISPLAYLEVEL
argument_list|(
literal|4
argument_list|,
literal|"test%3i : get decompressed size of multiple frames : "
argument_list|,
name|testNb
operator|++
argument_list|)
expr_stmt|;
block|{
name|unsigned
name|long
name|long
specifier|const
name|r
init|=
name|ZSTD_findDecompressedSize
argument_list|(
name|compressedBuffer
argument_list|,
name|cSize
argument_list|)
decl_stmt|;
if|if
condition|(
name|r
operator|!=
name|CNBuffSize
operator|/
literal|2
condition|)
goto|goto
name|_output_error
goto|;
block|}
name|DISPLAYLEVEL
argument_list|(
literal|4
argument_list|,
literal|"OK \n"
argument_list|)
expr_stmt|;
name|DISPLAYLEVEL
argument_list|(
literal|4
argument_list|,
literal|"test%3i : decompress multiple frames : "
argument_list|,
name|testNb
operator|++
argument_list|)
expr_stmt|;
block|{
name|CHECK_V
argument_list|(
name|r
argument_list|,
name|ZSTD_decompress
argument_list|(
name|decodedBuffer
argument_list|,
name|CNBuffSize
argument_list|,
name|compressedBuffer
argument_list|,
name|cSize
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
operator|!=
name|CNBuffSize
operator|/
literal|2
condition|)
goto|goto
name|_output_error
goto|;
block|}
name|DISPLAYLEVEL
argument_list|(
literal|4
argument_list|,
literal|"OK \n"
argument_list|)
expr_stmt|;
name|DISPLAYLEVEL
argument_list|(
literal|4
argument_list|,
literal|"test%3i : check decompressed result : "
argument_list|,
name|testNb
operator|++
argument_list|)
expr_stmt|;
if|if
condition|(
name|memcmp
argument_list|(
name|decodedBuffer
argument_list|,
name|CNBuffer
argument_list|,
name|CNBuffSize
operator|/
literal|2
argument_list|)
operator|!=
literal|0
condition|)
goto|goto
name|_output_error
goto|;
name|DISPLAYLEVEL
argument_list|(
literal|4
argument_list|,
literal|"OK \n"
argument_list|)
expr_stmt|;
comment|/* Dictionary and CCtx Duplication tests */
block|{
name|ZSTD_CCtx
modifier|*
specifier|const
name|ctxOrig
init|=
name|ZSTD_createCCtx
argument_list|()
decl_stmt|;
name|ZSTD_CCtx
modifier|*
specifier|const
name|ctxDuplicated
init|=
name|ZSTD_createCCtx
argument_list|()
decl_stmt|;
specifier|static
specifier|const
name|size_t
name|dictSize
init|=
literal|551
decl_stmt|;
name|DISPLAYLEVEL
argument_list|(
literal|4
argument_list|,
literal|"test%3i : copy context too soon : "
argument_list|,
name|testNb
operator|++
argument_list|)
expr_stmt|;
block|{
name|size_t
specifier|const
name|copyResult
init|=
name|ZSTD_copyCCtx
argument_list|(
name|ctxDuplicated
argument_list|,
name|ctxOrig
argument_list|,
literal|0
argument_list|)
decl_stmt|;
if|if
condition|(
operator|!
name|ZSTD_isError
argument_list|(
name|copyResult
argument_list|)
condition|)
goto|goto
name|_output_error
goto|;
block|}
comment|/* error must be detected */
name|DISPLAYLEVEL
argument_list|(
literal|4
argument_list|,
literal|"OK \n"
argument_list|)
expr_stmt|;
name|DISPLAYLEVEL
argument_list|(
literal|4
argument_list|,
literal|"test%3i : load dictionary into context : "
argument_list|,
name|testNb
operator|++
argument_list|)
expr_stmt|;
name|CHECK
argument_list|(
name|ZSTD_compressBegin_usingDict
argument_list|(
name|ctxOrig
argument_list|,
name|CNBuffer
argument_list|,
name|dictSize
argument_list|,
literal|2
argument_list|)
argument_list|)
expr_stmt|;
name|CHECK
argument_list|(
name|ZSTD_copyCCtx
argument_list|(
name|ctxDuplicated
argument_list|,
name|ctxOrig
argument_list|,
literal|0
argument_list|)
argument_list|)
expr_stmt|;
comment|/* Begin_usingDict implies unknown srcSize, so match that */
name|DISPLAYLEVEL
argument_list|(
literal|4
argument_list|,
literal|"OK \n"
argument_list|)
expr_stmt|;
name|DISPLAYLEVEL
argument_list|(
literal|4
argument_list|,
literal|"test%3i : compress with flat dictionary : "
argument_list|,
name|testNb
operator|++
argument_list|)
expr_stmt|;
name|cSize
operator|=
literal|0
expr_stmt|;
name|CHECKPLUS
argument_list|(
name|r
argument_list|,
name|ZSTD_compressEnd
argument_list|(
name|ctxOrig
argument_list|,
name|compressedBuffer
argument_list|,
name|ZSTD_compressBound
argument_list|(
name|CNBuffSize
argument_list|)
argument_list|,
operator|(
specifier|const
name|char
operator|*
operator|)
name|CNBuffer
operator|+
name|dictSize
argument_list|,
name|CNBuffSize
operator|-
name|dictSize
argument_list|)
argument_list|,
name|cSize
operator|+=
name|r
argument_list|)
expr_stmt|;
name|DISPLAYLEVEL
argument_list|(
literal|4
argument_list|,
literal|"OK (%u bytes : %.2f%%)\n"
argument_list|,
operator|(
name|U32
operator|)
name|cSize
argument_list|,
operator|(
name|double
operator|)
name|cSize
operator|/
name|CNBuffSize
operator|*
literal|100
argument_list|)
expr_stmt|;
name|DISPLAYLEVEL
argument_list|(
literal|4
argument_list|,
literal|"test%3i : frame built with flat dictionary should be decompressible : "
argument_list|,
name|testNb
operator|++
argument_list|)
expr_stmt|;
name|CHECKPLUS
argument_list|(
argument|r
argument_list|,
argument|ZSTD_decompress_usingDict(dctx,                                        decodedBuffer, CNBuffSize,                                        compressedBuffer, cSize,                                        CNBuffer, dictSize)
argument_list|,
argument|if (r != CNBuffSize - dictSize) goto _output_error
argument_list|)
empty_stmt|;
name|DISPLAYLEVEL
argument_list|(
literal|4
argument_list|,
literal|"OK \n"
argument_list|)
expr_stmt|;
name|DISPLAYLEVEL
argument_list|(
literal|4
argument_list|,
literal|"test%3i : compress with duplicated context : "
argument_list|,
name|testNb
operator|++
argument_list|)
expr_stmt|;
block|{
name|size_t
specifier|const
name|cSizeOrig
init|=
name|cSize
decl_stmt|;
name|cSize
operator|=
literal|0
expr_stmt|;
name|CHECKPLUS
argument_list|(
name|r
argument_list|,
name|ZSTD_compressEnd
argument_list|(
name|ctxDuplicated
argument_list|,
name|compressedBuffer
argument_list|,
name|ZSTD_compressBound
argument_list|(
name|CNBuffSize
argument_list|)
argument_list|,
operator|(
specifier|const
name|char
operator|*
operator|)
name|CNBuffer
operator|+
name|dictSize
argument_list|,
name|CNBuffSize
operator|-
name|dictSize
argument_list|)
argument_list|,
name|cSize
operator|+=
name|r
argument_list|)
expr_stmt|;
if|if
condition|(
name|cSize
operator|!=
name|cSizeOrig
condition|)
goto|goto
name|_output_error
goto|;
comment|/* should be identical ==> same size */
block|}
name|DISPLAYLEVEL
argument_list|(
literal|4
argument_list|,
literal|"OK (%u bytes : %.2f%%)\n"
argument_list|,
operator|(
name|U32
operator|)
name|cSize
argument_list|,
operator|(
name|double
operator|)
name|cSize
operator|/
name|CNBuffSize
operator|*
literal|100
argument_list|)
expr_stmt|;
name|DISPLAYLEVEL
argument_list|(
literal|4
argument_list|,
literal|"test%3i : frame built with duplicated context should be decompressible : "
argument_list|,
name|testNb
operator|++
argument_list|)
expr_stmt|;
name|CHECKPLUS
argument_list|(
argument|r
argument_list|,
argument|ZSTD_decompress_usingDict(dctx,                                            decodedBuffer, CNBuffSize,                                            compressedBuffer, cSize,                                            CNBuffer, dictSize)
argument_list|,
argument|if (r != CNBuffSize - dictSize) goto _output_error
argument_list|)
empty_stmt|;
name|DISPLAYLEVEL
argument_list|(
literal|4
argument_list|,
literal|"OK \n"
argument_list|)
expr_stmt|;
name|DISPLAYLEVEL
argument_list|(
literal|4
argument_list|,
literal|"test%3i : decompress with DDict : "
argument_list|,
name|testNb
operator|++
argument_list|)
expr_stmt|;
block|{
name|ZSTD_DDict
modifier|*
specifier|const
name|ddict
init|=
name|ZSTD_createDDict_byReference
argument_list|(
name|CNBuffer
argument_list|,
name|dictSize
argument_list|)
decl_stmt|;
name|size_t
specifier|const
name|r
init|=
name|ZSTD_decompress_usingDDict
argument_list|(
name|dctx
argument_list|,
name|decodedBuffer
argument_list|,
name|CNBuffSize
argument_list|,
name|compressedBuffer
argument_list|,
name|cSize
argument_list|,
name|ddict
argument_list|)
decl_stmt|;
if|if
condition|(
name|r
operator|!=
name|CNBuffSize
operator|-
name|dictSize
condition|)
goto|goto
name|_output_error
goto|;
name|DISPLAYLEVEL
argument_list|(
literal|4
argument_list|,
literal|"OK (size of DDict : %u) \n"
argument_list|,
operator|(
name|U32
operator|)
name|ZSTD_sizeof_DDict
argument_list|(
name|ddict
argument_list|)
argument_list|)
expr_stmt|;
name|ZSTD_freeDDict
argument_list|(
name|ddict
argument_list|)
expr_stmt|;
block|}
name|DISPLAYLEVEL
argument_list|(
literal|4
argument_list|,
literal|"test%3i : check content size on duplicated context : "
argument_list|,
name|testNb
operator|++
argument_list|)
expr_stmt|;
block|{
name|size_t
specifier|const
name|testSize
init|=
name|CNBuffSize
operator|/
literal|3
decl_stmt|;
block|{
name|ZSTD_parameters
name|p
init|=
name|ZSTD_getParams
argument_list|(
literal|2
argument_list|,
name|testSize
argument_list|,
name|dictSize
argument_list|)
decl_stmt|;
name|p
operator|.
name|fParams
operator|.
name|contentSizeFlag
operator|=
literal|1
expr_stmt|;
name|CHECK
argument_list|(
name|ZSTD_compressBegin_advanced
argument_list|(
name|ctxOrig
argument_list|,
name|CNBuffer
argument_list|,
name|dictSize
argument_list|,
name|p
argument_list|,
name|testSize
operator|-
literal|1
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|CHECK
argument_list|(
name|ZSTD_copyCCtx
argument_list|(
name|ctxDuplicated
argument_list|,
name|ctxOrig
argument_list|,
name|testSize
argument_list|)
argument_list|)
expr_stmt|;
name|CHECKPLUS
argument_list|(
name|r
argument_list|,
name|ZSTD_compressEnd
argument_list|(
name|ctxDuplicated
argument_list|,
name|compressedBuffer
argument_list|,
name|ZSTD_compressBound
argument_list|(
name|testSize
argument_list|)
argument_list|,
operator|(
specifier|const
name|char
operator|*
operator|)
name|CNBuffer
operator|+
name|dictSize
argument_list|,
name|testSize
argument_list|)
argument_list|,
name|cSize
operator|=
name|r
argument_list|)
expr_stmt|;
block|{
name|ZSTD_frameParams
name|fp
decl_stmt|;
if|if
condition|(
name|ZSTD_getFrameParams
argument_list|(
operator|&
name|fp
argument_list|,
name|compressedBuffer
argument_list|,
name|cSize
argument_list|)
condition|)
goto|goto
name|_output_error
goto|;
if|if
condition|(
operator|(
name|fp
operator|.
name|frameContentSize
operator|!=
name|testSize
operator|)
operator|&&
operator|(
name|fp
operator|.
name|frameContentSize
operator|!=
literal|0
operator|)
condition|)
goto|goto
name|_output_error
goto|;
block|}
block|}
name|DISPLAYLEVEL
argument_list|(
literal|4
argument_list|,
literal|"OK \n"
argument_list|)
expr_stmt|;
name|ZSTD_freeCCtx
argument_list|(
name|ctxOrig
argument_list|)
expr_stmt|;
name|ZSTD_freeCCtx
argument_list|(
name|ctxDuplicated
argument_list|)
expr_stmt|;
block|}
comment|/* Dictionary and dictBuilder tests */
block|{
name|ZSTD_CCtx
modifier|*
specifier|const
name|cctx
init|=
name|ZSTD_createCCtx
argument_list|()
decl_stmt|;
name|size_t
name|dictSize
init|=
literal|16
name|KB
decl_stmt|;
name|void
modifier|*
name|dictBuffer
init|=
name|malloc
argument_list|(
name|dictSize
argument_list|)
decl_stmt|;
name|size_t
specifier|const
name|totalSampleSize
init|=
literal|1
name|MB
decl_stmt|;
name|size_t
specifier|const
name|sampleUnitSize
init|=
literal|8
name|KB
decl_stmt|;
name|U32
specifier|const
name|nbSamples
init|=
call|(
name|U32
call|)
argument_list|(
name|totalSampleSize
operator|/
name|sampleUnitSize
argument_list|)
decl_stmt|;
name|size_t
modifier|*
specifier|const
name|samplesSizes
init|=
operator|(
name|size_t
operator|*
operator|)
name|malloc
argument_list|(
name|nbSamples
operator|*
sizeof|sizeof
argument_list|(
name|size_t
argument_list|)
argument_list|)
decl_stmt|;
name|U32
name|dictID
decl_stmt|;
if|if
condition|(
name|dictBuffer
operator|==
name|NULL
operator|||
name|samplesSizes
operator|==
name|NULL
condition|)
block|{
name|free
argument_list|(
name|dictBuffer
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|samplesSizes
argument_list|)
expr_stmt|;
goto|goto
name|_output_error
goto|;
block|}
name|DISPLAYLEVEL
argument_list|(
literal|4
argument_list|,
literal|"test%3i : dictBuilder : "
argument_list|,
name|testNb
operator|++
argument_list|)
expr_stmt|;
block|{
name|U32
name|u
decl_stmt|;
for|for
control|(
name|u
operator|=
literal|0
init|;
name|u
operator|<
name|nbSamples
condition|;
name|u
operator|++
control|)
name|samplesSizes
index|[
name|u
index|]
operator|=
name|sampleUnitSize
expr_stmt|;
block|}
name|dictSize
operator|=
name|ZDICT_trainFromBuffer
argument_list|(
name|dictBuffer
argument_list|,
name|dictSize
argument_list|,
name|CNBuffer
argument_list|,
name|samplesSizes
argument_list|,
name|nbSamples
argument_list|)
expr_stmt|;
if|if
condition|(
name|ZDICT_isError
argument_list|(
name|dictSize
argument_list|)
condition|)
goto|goto
name|_output_error
goto|;
name|DISPLAYLEVEL
argument_list|(
literal|4
argument_list|,
literal|"OK, created dictionary of size %u \n"
argument_list|,
operator|(
name|U32
operator|)
name|dictSize
argument_list|)
expr_stmt|;
name|DISPLAYLEVEL
argument_list|(
literal|4
argument_list|,
literal|"test%3i : check dictID : "
argument_list|,
name|testNb
operator|++
argument_list|)
expr_stmt|;
name|dictID
operator|=
name|ZDICT_getDictID
argument_list|(
name|dictBuffer
argument_list|,
name|dictSize
argument_list|)
expr_stmt|;
if|if
condition|(
name|dictID
operator|==
literal|0
condition|)
goto|goto
name|_output_error
goto|;
name|DISPLAYLEVEL
argument_list|(
literal|4
argument_list|,
literal|"OK : %u \n"
argument_list|,
name|dictID
argument_list|)
expr_stmt|;
name|DISPLAYLEVEL
argument_list|(
literal|4
argument_list|,
literal|"test%3i : compress with dictionary : "
argument_list|,
name|testNb
operator|++
argument_list|)
expr_stmt|;
name|cSize
operator|=
name|ZSTD_compress_usingDict
argument_list|(
name|cctx
argument_list|,
name|compressedBuffer
argument_list|,
name|ZSTD_compressBound
argument_list|(
name|CNBuffSize
argument_list|)
argument_list|,
name|CNBuffer
argument_list|,
name|CNBuffSize
argument_list|,
name|dictBuffer
argument_list|,
name|dictSize
argument_list|,
literal|4
argument_list|)
expr_stmt|;
if|if
condition|(
name|ZSTD_isError
argument_list|(
name|cSize
argument_list|)
condition|)
goto|goto
name|_output_error
goto|;
name|DISPLAYLEVEL
argument_list|(
literal|4
argument_list|,
literal|"OK (%u bytes : %.2f%%)\n"
argument_list|,
operator|(
name|U32
operator|)
name|cSize
argument_list|,
operator|(
name|double
operator|)
name|cSize
operator|/
name|CNBuffSize
operator|*
literal|100
argument_list|)
expr_stmt|;
name|DISPLAYLEVEL
argument_list|(
literal|4
argument_list|,
literal|"test%3i : retrieve dictID from dictionary : "
argument_list|,
name|testNb
operator|++
argument_list|)
expr_stmt|;
block|{
name|U32
specifier|const
name|did
init|=
name|ZSTD_getDictID_fromDict
argument_list|(
name|dictBuffer
argument_list|,
name|dictSize
argument_list|)
decl_stmt|;
if|if
condition|(
name|did
operator|!=
name|dictID
condition|)
goto|goto
name|_output_error
goto|;
comment|/* non-conformant (content-only) dictionary */
block|}
name|DISPLAYLEVEL
argument_list|(
literal|4
argument_list|,
literal|"OK \n"
argument_list|)
expr_stmt|;
name|DISPLAYLEVEL
argument_list|(
literal|4
argument_list|,
literal|"test%3i : retrieve dictID from frame : "
argument_list|,
name|testNb
operator|++
argument_list|)
expr_stmt|;
block|{
name|U32
specifier|const
name|did
init|=
name|ZSTD_getDictID_fromFrame
argument_list|(
name|compressedBuffer
argument_list|,
name|cSize
argument_list|)
decl_stmt|;
if|if
condition|(
name|did
operator|!=
name|dictID
condition|)
goto|goto
name|_output_error
goto|;
comment|/* non-conformant (content-only) dictionary */
block|}
name|DISPLAYLEVEL
argument_list|(
literal|4
argument_list|,
literal|"OK \n"
argument_list|)
expr_stmt|;
name|DISPLAYLEVEL
argument_list|(
literal|4
argument_list|,
literal|"test%3i : frame built with dictionary should be decompressible : "
argument_list|,
name|testNb
operator|++
argument_list|)
expr_stmt|;
name|CHECKPLUS
argument_list|(
argument|r
argument_list|,
argument|ZSTD_decompress_usingDict(dctx,                                        decodedBuffer, CNBuffSize,                                        compressedBuffer, cSize,                                        dictBuffer, dictSize)
argument_list|,
argument|if (r != CNBuffSize) goto _output_error
argument_list|)
empty_stmt|;
name|DISPLAYLEVEL
argument_list|(
literal|4
argument_list|,
literal|"OK \n"
argument_list|)
expr_stmt|;
name|DISPLAYLEVEL
argument_list|(
literal|4
argument_list|,
literal|"test%3i : compress without dictID : "
argument_list|,
name|testNb
operator|++
argument_list|)
expr_stmt|;
block|{
name|ZSTD_parameters
name|p
init|=
name|ZSTD_getParams
argument_list|(
literal|3
argument_list|,
name|CNBuffSize
argument_list|,
name|dictSize
argument_list|)
decl_stmt|;
name|p
operator|.
name|fParams
operator|.
name|noDictIDFlag
operator|=
literal|1
expr_stmt|;
name|cSize
operator|=
name|ZSTD_compress_advanced
argument_list|(
name|cctx
argument_list|,
name|compressedBuffer
argument_list|,
name|ZSTD_compressBound
argument_list|(
name|CNBuffSize
argument_list|)
argument_list|,
name|CNBuffer
argument_list|,
name|CNBuffSize
argument_list|,
name|dictBuffer
argument_list|,
name|dictSize
argument_list|,
name|p
argument_list|)
expr_stmt|;
if|if
condition|(
name|ZSTD_isError
argument_list|(
name|cSize
argument_list|)
condition|)
goto|goto
name|_output_error
goto|;
block|}
name|DISPLAYLEVEL
argument_list|(
literal|4
argument_list|,
literal|"OK (%u bytes : %.2f%%)\n"
argument_list|,
operator|(
name|U32
operator|)
name|cSize
argument_list|,
operator|(
name|double
operator|)
name|cSize
operator|/
name|CNBuffSize
operator|*
literal|100
argument_list|)
expr_stmt|;
name|DISPLAYLEVEL
argument_list|(
literal|4
argument_list|,
literal|"test%3i : frame built without dictID should be decompressible : "
argument_list|,
name|testNb
operator|++
argument_list|)
expr_stmt|;
name|CHECKPLUS
argument_list|(
argument|r
argument_list|,
argument|ZSTD_decompress_usingDict(dctx,                                        decodedBuffer, CNBuffSize,                                        compressedBuffer, cSize,                                        dictBuffer, dictSize)
argument_list|,
argument|if (r != CNBuffSize) goto _output_error
argument_list|)
empty_stmt|;
name|DISPLAYLEVEL
argument_list|(
literal|4
argument_list|,
literal|"OK \n"
argument_list|)
expr_stmt|;
name|DISPLAYLEVEL
argument_list|(
literal|4
argument_list|,
literal|"test%3i : dictionary containing only header should return error : "
argument_list|,
name|testNb
operator|++
argument_list|)
expr_stmt|;
block|{
specifier|const
name|size_t
name|ret
init|=
name|ZSTD_decompress_usingDict
argument_list|(
name|dctx
argument_list|,
name|decodedBuffer
argument_list|,
name|CNBuffSize
argument_list|,
name|compressedBuffer
argument_list|,
name|cSize
argument_list|,
literal|"\x37\xa4\x30\xec\x11\x22\x33\x44"
argument_list|,
literal|8
argument_list|)
decl_stmt|;
if|if
condition|(
name|ZSTD_getErrorCode
argument_list|(
name|ret
argument_list|)
operator|!=
name|ZSTD_error_dictionary_corrupted
condition|)
goto|goto
name|_output_error
goto|;
block|}
name|DISPLAYLEVEL
argument_list|(
literal|4
argument_list|,
literal|"OK \n"
argument_list|)
expr_stmt|;
name|ZSTD_freeCCtx
argument_list|(
name|cctx
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|dictBuffer
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|samplesSizes
argument_list|)
expr_stmt|;
block|}
comment|/* COVER dictionary builder tests */
block|{
name|ZSTD_CCtx
modifier|*
specifier|const
name|cctx
init|=
name|ZSTD_createCCtx
argument_list|()
decl_stmt|;
name|size_t
name|dictSize
init|=
literal|16
name|KB
decl_stmt|;
name|size_t
name|optDictSize
init|=
name|dictSize
decl_stmt|;
name|void
modifier|*
name|dictBuffer
init|=
name|malloc
argument_list|(
name|dictSize
argument_list|)
decl_stmt|;
name|size_t
specifier|const
name|totalSampleSize
init|=
literal|1
name|MB
decl_stmt|;
name|size_t
specifier|const
name|sampleUnitSize
init|=
literal|8
name|KB
decl_stmt|;
name|U32
specifier|const
name|nbSamples
init|=
call|(
name|U32
call|)
argument_list|(
name|totalSampleSize
operator|/
name|sampleUnitSize
argument_list|)
decl_stmt|;
name|size_t
modifier|*
specifier|const
name|samplesSizes
init|=
operator|(
name|size_t
operator|*
operator|)
name|malloc
argument_list|(
name|nbSamples
operator|*
sizeof|sizeof
argument_list|(
name|size_t
argument_list|)
argument_list|)
decl_stmt|;
name|COVER_params_t
name|params
decl_stmt|;
name|U32
name|dictID
decl_stmt|;
if|if
condition|(
name|dictBuffer
operator|==
name|NULL
operator|||
name|samplesSizes
operator|==
name|NULL
condition|)
block|{
name|free
argument_list|(
name|dictBuffer
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|samplesSizes
argument_list|)
expr_stmt|;
goto|goto
name|_output_error
goto|;
block|}
name|DISPLAYLEVEL
argument_list|(
literal|4
argument_list|,
literal|"test%3i : COVER_trainFromBuffer : "
argument_list|,
name|testNb
operator|++
argument_list|)
expr_stmt|;
block|{
name|U32
name|u
decl_stmt|;
for|for
control|(
name|u
operator|=
literal|0
init|;
name|u
operator|<
name|nbSamples
condition|;
name|u
operator|++
control|)
name|samplesSizes
index|[
name|u
index|]
operator|=
name|sampleUnitSize
expr_stmt|;
block|}
name|memset
argument_list|(
operator|&
name|params
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|params
argument_list|)
argument_list|)
expr_stmt|;
name|params
operator|.
name|d
operator|=
literal|1
operator|+
operator|(
name|FUZ_rand
argument_list|(
operator|&
name|seed
argument_list|)
operator|%
literal|16
operator|)
expr_stmt|;
name|params
operator|.
name|k
operator|=
name|params
operator|.
name|d
operator|+
operator|(
name|FUZ_rand
argument_list|(
operator|&
name|seed
argument_list|)
operator|%
literal|256
operator|)
expr_stmt|;
name|dictSize
operator|=
name|COVER_trainFromBuffer
argument_list|(
name|dictBuffer
argument_list|,
name|dictSize
argument_list|,
name|CNBuffer
argument_list|,
name|samplesSizes
argument_list|,
name|nbSamples
argument_list|,
name|params
argument_list|)
expr_stmt|;
if|if
condition|(
name|ZDICT_isError
argument_list|(
name|dictSize
argument_list|)
condition|)
goto|goto
name|_output_error
goto|;
name|DISPLAYLEVEL
argument_list|(
literal|4
argument_list|,
literal|"OK, created dictionary of size %u \n"
argument_list|,
operator|(
name|U32
operator|)
name|dictSize
argument_list|)
expr_stmt|;
name|DISPLAYLEVEL
argument_list|(
literal|4
argument_list|,
literal|"test%3i : check dictID : "
argument_list|,
name|testNb
operator|++
argument_list|)
expr_stmt|;
name|dictID
operator|=
name|ZDICT_getDictID
argument_list|(
name|dictBuffer
argument_list|,
name|dictSize
argument_list|)
expr_stmt|;
if|if
condition|(
name|dictID
operator|==
literal|0
condition|)
goto|goto
name|_output_error
goto|;
name|DISPLAYLEVEL
argument_list|(
literal|4
argument_list|,
literal|"OK : %u \n"
argument_list|,
name|dictID
argument_list|)
expr_stmt|;
name|DISPLAYLEVEL
argument_list|(
literal|4
argument_list|,
literal|"test%3i : COVER_optimizeTrainFromBuffer : "
argument_list|,
name|testNb
operator|++
argument_list|)
expr_stmt|;
name|memset
argument_list|(
operator|&
name|params
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|params
argument_list|)
argument_list|)
expr_stmt|;
name|params
operator|.
name|steps
operator|=
literal|4
expr_stmt|;
name|optDictSize
operator|=
name|COVER_optimizeTrainFromBuffer
argument_list|(
name|dictBuffer
argument_list|,
name|optDictSize
argument_list|,
name|CNBuffer
argument_list|,
name|samplesSizes
argument_list|,
name|nbSamples
operator|/
literal|4
argument_list|,
operator|&
name|params
argument_list|)
expr_stmt|;
if|if
condition|(
name|ZDICT_isError
argument_list|(
name|optDictSize
argument_list|)
condition|)
goto|goto
name|_output_error
goto|;
name|DISPLAYLEVEL
argument_list|(
literal|4
argument_list|,
literal|"OK, created dictionary of size %u \n"
argument_list|,
operator|(
name|U32
operator|)
name|optDictSize
argument_list|)
expr_stmt|;
name|DISPLAYLEVEL
argument_list|(
literal|4
argument_list|,
literal|"test%3i : check dictID : "
argument_list|,
name|testNb
operator|++
argument_list|)
expr_stmt|;
name|dictID
operator|=
name|ZDICT_getDictID
argument_list|(
name|dictBuffer
argument_list|,
name|optDictSize
argument_list|)
expr_stmt|;
if|if
condition|(
name|dictID
operator|==
literal|0
condition|)
goto|goto
name|_output_error
goto|;
name|DISPLAYLEVEL
argument_list|(
literal|4
argument_list|,
literal|"OK : %u \n"
argument_list|,
name|dictID
argument_list|)
expr_stmt|;
name|ZSTD_freeCCtx
argument_list|(
name|cctx
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|dictBuffer
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|samplesSizes
argument_list|)
expr_stmt|;
block|}
comment|/* Decompression defense tests */
name|DISPLAYLEVEL
argument_list|(
literal|4
argument_list|,
literal|"test%3i : Check input length for magic number : "
argument_list|,
name|testNb
operator|++
argument_list|)
expr_stmt|;
block|{
name|size_t
specifier|const
name|r
init|=
name|ZSTD_decompress
argument_list|(
name|decodedBuffer
argument_list|,
name|CNBuffSize
argument_list|,
name|CNBuffer
argument_list|,
literal|3
argument_list|)
decl_stmt|;
if|if
condition|(
operator|!
name|ZSTD_isError
argument_list|(
name|r
argument_list|)
condition|)
goto|goto
name|_output_error
goto|;
if|if
condition|(
name|r
operator|!=
operator|(
name|size_t
operator|)
operator|-
name|ZSTD_error_srcSize_wrong
condition|)
goto|goto
name|_output_error
goto|;
block|}
name|DISPLAYLEVEL
argument_list|(
literal|4
argument_list|,
literal|"OK \n"
argument_list|)
expr_stmt|;
name|DISPLAYLEVEL
argument_list|(
literal|4
argument_list|,
literal|"test%3i : Check magic Number : "
argument_list|,
name|testNb
operator|++
argument_list|)
expr_stmt|;
operator|(
operator|(
name|char
operator|*
operator|)
operator|(
name|CNBuffer
operator|)
operator|)
index|[
literal|0
index|]
operator|=
literal|1
expr_stmt|;
block|{
name|size_t
specifier|const
name|r
init|=
name|ZSTD_decompress
argument_list|(
name|decodedBuffer
argument_list|,
name|CNBuffSize
argument_list|,
name|CNBuffer
argument_list|,
literal|4
argument_list|)
decl_stmt|;
if|if
condition|(
operator|!
name|ZSTD_isError
argument_list|(
name|r
argument_list|)
condition|)
goto|goto
name|_output_error
goto|;
block|}
name|DISPLAYLEVEL
argument_list|(
literal|4
argument_list|,
literal|"OK \n"
argument_list|)
expr_stmt|;
comment|/* block API tests */
block|{
name|ZSTD_CCtx
modifier|*
specifier|const
name|cctx
init|=
name|ZSTD_createCCtx
argument_list|()
decl_stmt|;
specifier|static
specifier|const
name|size_t
name|dictSize
init|=
literal|65
name|KB
decl_stmt|;
specifier|static
specifier|const
name|size_t
name|blockSize
init|=
literal|100
name|KB
decl_stmt|;
comment|/* won't cause pb with small dict size */
name|size_t
name|cSize2
decl_stmt|;
comment|/* basic block compression */
name|DISPLAYLEVEL
argument_list|(
literal|4
argument_list|,
literal|"test%3i : Block compression test : "
argument_list|,
name|testNb
operator|++
argument_list|)
expr_stmt|;
name|CHECK
argument_list|(
name|ZSTD_compressBegin
argument_list|(
name|cctx
argument_list|,
literal|5
argument_list|)
argument_list|)
expr_stmt|;
name|cSize
operator|=
name|ZSTD_compressBlock
argument_list|(
name|cctx
argument_list|,
name|compressedBuffer
argument_list|,
name|ZSTD_compressBound
argument_list|(
name|blockSize
argument_list|)
argument_list|,
name|CNBuffer
argument_list|,
name|blockSize
argument_list|)
expr_stmt|;
if|if
condition|(
name|ZSTD_isError
argument_list|(
name|cSize
argument_list|)
condition|)
goto|goto
name|_output_error
goto|;
name|DISPLAYLEVEL
argument_list|(
literal|4
argument_list|,
literal|"OK \n"
argument_list|)
expr_stmt|;
name|DISPLAYLEVEL
argument_list|(
literal|4
argument_list|,
literal|"test%3i : Block decompression test : "
argument_list|,
name|testNb
operator|++
argument_list|)
expr_stmt|;
name|CHECK
argument_list|(
name|ZSTD_decompressBegin
argument_list|(
name|dctx
argument_list|)
argument_list|)
expr_stmt|;
block|{
name|CHECK_V
argument_list|(
name|r
argument_list|,
name|ZSTD_decompressBlock
argument_list|(
name|dctx
argument_list|,
name|decodedBuffer
argument_list|,
name|CNBuffSize
argument_list|,
name|compressedBuffer
argument_list|,
name|cSize
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
operator|!=
name|blockSize
condition|)
goto|goto
name|_output_error
goto|;
block|}
name|DISPLAYLEVEL
argument_list|(
literal|4
argument_list|,
literal|"OK \n"
argument_list|)
expr_stmt|;
comment|/* dictionary block compression */
name|DISPLAYLEVEL
argument_list|(
literal|4
argument_list|,
literal|"test%3i : Dictionary Block compression test : "
argument_list|,
name|testNb
operator|++
argument_list|)
expr_stmt|;
name|CHECK
argument_list|(
name|ZSTD_compressBegin_usingDict
argument_list|(
name|cctx
argument_list|,
name|CNBuffer
argument_list|,
name|dictSize
argument_list|,
literal|5
argument_list|)
argument_list|)
expr_stmt|;
name|cSize
operator|=
name|ZSTD_compressBlock
argument_list|(
name|cctx
argument_list|,
name|compressedBuffer
argument_list|,
name|ZSTD_compressBound
argument_list|(
name|blockSize
argument_list|)
argument_list|,
operator|(
name|char
operator|*
operator|)
name|CNBuffer
operator|+
name|dictSize
argument_list|,
name|blockSize
argument_list|)
expr_stmt|;
if|if
condition|(
name|ZSTD_isError
argument_list|(
name|cSize
argument_list|)
condition|)
goto|goto
name|_output_error
goto|;
name|cSize2
operator|=
name|ZSTD_compressBlock
argument_list|(
name|cctx
argument_list|,
operator|(
name|char
operator|*
operator|)
name|compressedBuffer
operator|+
name|cSize
argument_list|,
name|ZSTD_compressBound
argument_list|(
name|blockSize
argument_list|)
argument_list|,
operator|(
name|char
operator|*
operator|)
name|CNBuffer
operator|+
name|dictSize
operator|+
name|blockSize
argument_list|,
name|blockSize
argument_list|)
expr_stmt|;
if|if
condition|(
name|ZSTD_isError
argument_list|(
name|cSize2
argument_list|)
condition|)
goto|goto
name|_output_error
goto|;
name|memcpy
argument_list|(
operator|(
name|char
operator|*
operator|)
name|compressedBuffer
operator|+
name|cSize
argument_list|,
operator|(
name|char
operator|*
operator|)
name|CNBuffer
operator|+
name|dictSize
operator|+
name|blockSize
argument_list|,
name|blockSize
argument_list|)
expr_stmt|;
comment|/* fake non-compressed block */
name|cSize2
operator|=
name|ZSTD_compressBlock
argument_list|(
name|cctx
argument_list|,
operator|(
name|char
operator|*
operator|)
name|compressedBuffer
operator|+
name|cSize
operator|+
name|blockSize
argument_list|,
name|ZSTD_compressBound
argument_list|(
name|blockSize
argument_list|)
argument_list|,
operator|(
name|char
operator|*
operator|)
name|CNBuffer
operator|+
name|dictSize
operator|+
literal|2
operator|*
name|blockSize
argument_list|,
name|blockSize
argument_list|)
expr_stmt|;
if|if
condition|(
name|ZSTD_isError
argument_list|(
name|cSize2
argument_list|)
condition|)
goto|goto
name|_output_error
goto|;
name|DISPLAYLEVEL
argument_list|(
literal|4
argument_list|,
literal|"OK \n"
argument_list|)
expr_stmt|;
name|DISPLAYLEVEL
argument_list|(
literal|4
argument_list|,
literal|"test%3i : Dictionary Block decompression test : "
argument_list|,
name|testNb
operator|++
argument_list|)
expr_stmt|;
name|CHECK
argument_list|(
name|ZSTD_decompressBegin_usingDict
argument_list|(
name|dctx
argument_list|,
name|CNBuffer
argument_list|,
name|dictSize
argument_list|)
argument_list|)
expr_stmt|;
block|{
name|CHECK_V
argument_list|(
name|r
argument_list|,
name|ZSTD_decompressBlock
argument_list|(
name|dctx
argument_list|,
name|decodedBuffer
argument_list|,
name|CNBuffSize
argument_list|,
name|compressedBuffer
argument_list|,
name|cSize
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
operator|!=
name|blockSize
condition|)
goto|goto
name|_output_error
goto|;
block|}
name|ZSTD_insertBlock
argument_list|(
name|dctx
argument_list|,
operator|(
name|char
operator|*
operator|)
name|decodedBuffer
operator|+
name|blockSize
argument_list|,
name|blockSize
argument_list|)
expr_stmt|;
comment|/* insert non-compressed block into dctx history */
block|{
name|CHECK_V
argument_list|(
name|r
argument_list|,
name|ZSTD_decompressBlock
argument_list|(
name|dctx
argument_list|,
operator|(
name|char
operator|*
operator|)
name|decodedBuffer
operator|+
literal|2
operator|*
name|blockSize
argument_list|,
name|CNBuffSize
argument_list|,
operator|(
name|char
operator|*
operator|)
name|compressedBuffer
operator|+
name|cSize
operator|+
name|blockSize
argument_list|,
name|cSize2
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
operator|!=
name|blockSize
condition|)
goto|goto
name|_output_error
goto|;
block|}
name|DISPLAYLEVEL
argument_list|(
literal|4
argument_list|,
literal|"OK \n"
argument_list|)
expr_stmt|;
name|ZSTD_freeCCtx
argument_list|(
name|cctx
argument_list|)
expr_stmt|;
name|ZSTD_freeDCtx
argument_list|(
name|dctx
argument_list|)
expr_stmt|;
block|}
comment|/* long rle test */
block|{
name|size_t
name|sampleSize
init|=
literal|0
decl_stmt|;
name|DISPLAYLEVEL
argument_list|(
literal|4
argument_list|,
literal|"test%3i : Long RLE test : "
argument_list|,
name|testNb
operator|++
argument_list|)
expr_stmt|;
name|RDG_genBuffer
argument_list|(
name|CNBuffer
argument_list|,
name|sampleSize
argument_list|,
name|compressibility
argument_list|,
literal|0.
argument_list|,
name|seed
operator|+
literal|1
argument_list|)
expr_stmt|;
name|memset
argument_list|(
operator|(
name|char
operator|*
operator|)
name|CNBuffer
operator|+
name|sampleSize
argument_list|,
literal|'B'
argument_list|,
literal|256
name|KB
operator|-
literal|1
argument_list|)
expr_stmt|;
name|sampleSize
operator|+=
literal|256
name|KB
operator|-
literal|1
expr_stmt|;
name|RDG_genBuffer
argument_list|(
operator|(
name|char
operator|*
operator|)
name|CNBuffer
operator|+
name|sampleSize
argument_list|,
literal|96
name|KB
argument_list|,
name|compressibility
argument_list|,
literal|0.
argument_list|,
name|seed
operator|+
literal|2
argument_list|)
expr_stmt|;
name|sampleSize
operator|+=
literal|96
name|KB
expr_stmt|;
name|cSize
operator|=
name|ZSTD_compress
argument_list|(
name|compressedBuffer
argument_list|,
name|ZSTD_compressBound
argument_list|(
name|sampleSize
argument_list|)
argument_list|,
name|CNBuffer
argument_list|,
name|sampleSize
argument_list|,
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|ZSTD_isError
argument_list|(
name|cSize
argument_list|)
condition|)
goto|goto
name|_output_error
goto|;
block|{
name|CHECK_V
argument_list|(
name|regenSize
argument_list|,
name|ZSTD_decompress
argument_list|(
name|decodedBuffer
argument_list|,
name|sampleSize
argument_list|,
name|compressedBuffer
argument_list|,
name|cSize
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|regenSize
operator|!=
name|sampleSize
condition|)
goto|goto
name|_output_error
goto|;
block|}
name|DISPLAYLEVEL
argument_list|(
literal|4
argument_list|,
literal|"OK \n"
argument_list|)
expr_stmt|;
block|}
comment|/* All zeroes test (test bug #137) */
define|#
directive|define
name|ZEROESLENGTH
value|100
name|DISPLAYLEVEL
argument_list|(
literal|4
argument_list|,
literal|"test%3i : compress %u zeroes : "
argument_list|,
name|testNb
operator|++
argument_list|,
name|ZEROESLENGTH
argument_list|)
expr_stmt|;
name|memset
argument_list|(
name|CNBuffer
argument_list|,
literal|0
argument_list|,
name|ZEROESLENGTH
argument_list|)
expr_stmt|;
block|{
name|CHECK_V
argument_list|(
name|r
argument_list|,
name|ZSTD_compress
argument_list|(
name|compressedBuffer
argument_list|,
name|ZSTD_compressBound
argument_list|(
name|ZEROESLENGTH
argument_list|)
argument_list|,
name|CNBuffer
argument_list|,
name|ZEROESLENGTH
argument_list|,
literal|1
argument_list|)
argument_list|)
expr_stmt|;
name|cSize
operator|=
name|r
expr_stmt|;
block|}
name|DISPLAYLEVEL
argument_list|(
literal|4
argument_list|,
literal|"OK (%u bytes : %.2f%%)\n"
argument_list|,
operator|(
name|U32
operator|)
name|cSize
argument_list|,
operator|(
name|double
operator|)
name|cSize
operator|/
name|ZEROESLENGTH
operator|*
literal|100
argument_list|)
expr_stmt|;
name|DISPLAYLEVEL
argument_list|(
literal|4
argument_list|,
literal|"test%3i : decompress %u zeroes : "
argument_list|,
name|testNb
operator|++
argument_list|,
name|ZEROESLENGTH
argument_list|)
expr_stmt|;
block|{
name|CHECK_V
argument_list|(
name|r
argument_list|,
name|ZSTD_decompress
argument_list|(
name|decodedBuffer
argument_list|,
name|ZEROESLENGTH
argument_list|,
name|compressedBuffer
argument_list|,
name|cSize
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
operator|!=
name|ZEROESLENGTH
condition|)
goto|goto
name|_output_error
goto|;
block|}
name|DISPLAYLEVEL
argument_list|(
literal|4
argument_list|,
literal|"OK \n"
argument_list|)
expr_stmt|;
comment|/* nbSeq limit test */
define|#
directive|define
name|_3BYTESTESTLENGTH
value|131000
define|#
directive|define
name|NB3BYTESSEQLOG
value|9
define|#
directive|define
name|NB3BYTESSEQ
value|(1<< NB3BYTESSEQLOG)
define|#
directive|define
name|NB3BYTESSEQMASK
value|(NB3BYTESSEQ-1)
comment|/* creates a buffer full of 3-bytes sequences */
block|{
name|BYTE
name|_3BytesSeqs
index|[
name|NB3BYTESSEQ
index|]
index|[
literal|3
index|]
decl_stmt|;
name|U32
name|rSeed
init|=
literal|1
decl_stmt|;
comment|/* create batch of 3-bytes sequences */
block|{
name|int
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|NB3BYTESSEQ
condition|;
name|i
operator|++
control|)
block|{
name|_3BytesSeqs
index|[
name|i
index|]
index|[
literal|0
index|]
operator|=
call|(
name|BYTE
call|)
argument_list|(
name|FUZ_rand
argument_list|(
operator|&
name|rSeed
argument_list|)
operator|&
literal|255
argument_list|)
expr_stmt|;
name|_3BytesSeqs
index|[
name|i
index|]
index|[
literal|1
index|]
operator|=
call|(
name|BYTE
call|)
argument_list|(
name|FUZ_rand
argument_list|(
operator|&
name|rSeed
argument_list|)
operator|&
literal|255
argument_list|)
expr_stmt|;
name|_3BytesSeqs
index|[
name|i
index|]
index|[
literal|2
index|]
operator|=
call|(
name|BYTE
call|)
argument_list|(
name|FUZ_rand
argument_list|(
operator|&
name|rSeed
argument_list|)
operator|&
literal|255
argument_list|)
expr_stmt|;
block|}
block|}
comment|/* randomly fills CNBuffer with prepared 3-bytes sequences */
block|{
name|int
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|_3BYTESTESTLENGTH
condition|;
name|i
operator|+=
literal|3
control|)
block|{
comment|/* note : CNBuffer size> _3BYTESTESTLENGTH+3 */
name|U32
specifier|const
name|id
init|=
name|FUZ_rand
argument_list|(
operator|&
name|rSeed
argument_list|)
operator|&
name|NB3BYTESSEQMASK
decl_stmt|;
operator|(
operator|(
name|BYTE
operator|*
operator|)
name|CNBuffer
operator|)
index|[
name|i
operator|+
literal|0
index|]
operator|=
name|_3BytesSeqs
index|[
name|id
index|]
index|[
literal|0
index|]
expr_stmt|;
operator|(
operator|(
name|BYTE
operator|*
operator|)
name|CNBuffer
operator|)
index|[
name|i
operator|+
literal|1
index|]
operator|=
name|_3BytesSeqs
index|[
name|id
index|]
index|[
literal|1
index|]
expr_stmt|;
operator|(
operator|(
name|BYTE
operator|*
operator|)
name|CNBuffer
operator|)
index|[
name|i
operator|+
literal|2
index|]
operator|=
name|_3BytesSeqs
index|[
name|id
index|]
index|[
literal|2
index|]
expr_stmt|;
block|}
block|}
block|}
name|DISPLAYLEVEL
argument_list|(
literal|4
argument_list|,
literal|"test%3i : compress lots 3-bytes sequences : "
argument_list|,
name|testNb
operator|++
argument_list|)
expr_stmt|;
block|{
name|CHECK_V
argument_list|(
name|r
argument_list|,
name|ZSTD_compress
argument_list|(
name|compressedBuffer
argument_list|,
name|ZSTD_compressBound
argument_list|(
name|_3BYTESTESTLENGTH
argument_list|)
argument_list|,
name|CNBuffer
argument_list|,
name|_3BYTESTESTLENGTH
argument_list|,
literal|19
argument_list|)
argument_list|)
expr_stmt|;
name|cSize
operator|=
name|r
expr_stmt|;
block|}
name|DISPLAYLEVEL
argument_list|(
literal|4
argument_list|,
literal|"OK (%u bytes : %.2f%%)\n"
argument_list|,
operator|(
name|U32
operator|)
name|cSize
argument_list|,
operator|(
name|double
operator|)
name|cSize
operator|/
name|_3BYTESTESTLENGTH
operator|*
literal|100
argument_list|)
expr_stmt|;
name|DISPLAYLEVEL
argument_list|(
literal|4
argument_list|,
literal|"test%3i : decompress lots 3-bytes sequence : "
argument_list|,
name|testNb
operator|++
argument_list|)
expr_stmt|;
block|{
name|CHECK_V
argument_list|(
name|r
argument_list|,
name|ZSTD_decompress
argument_list|(
name|decodedBuffer
argument_list|,
name|_3BYTESTESTLENGTH
argument_list|,
name|compressedBuffer
argument_list|,
name|cSize
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
operator|!=
name|_3BYTESTESTLENGTH
condition|)
goto|goto
name|_output_error
goto|;
block|}
name|DISPLAYLEVEL
argument_list|(
literal|4
argument_list|,
literal|"OK \n"
argument_list|)
expr_stmt|;
comment|/* findFrameCompressedSize on skippable frames */
name|DISPLAYLEVEL
argument_list|(
literal|4
argument_list|,
literal|"test%3i : frame compressed size of skippable frame : "
argument_list|,
name|testNb
operator|++
argument_list|)
expr_stmt|;
block|{
specifier|const
name|char
modifier|*
name|frame
init|=
literal|"\x50\x2a\x4d\x18\x05\x0\x0\0abcde"
decl_stmt|;
name|size_t
specifier|const
name|frameSrcSize
init|=
literal|13
decl_stmt|;
if|if
condition|(
name|ZSTD_findFrameCompressedSize
argument_list|(
name|frame
argument_list|,
name|frameSrcSize
argument_list|)
operator|!=
name|frameSrcSize
condition|)
goto|goto
name|_output_error
goto|;
block|}
name|DISPLAYLEVEL
argument_list|(
literal|4
argument_list|,
literal|"OK \n"
argument_list|)
expr_stmt|;
comment|/* error string tests */
name|DISPLAYLEVEL
argument_list|(
literal|4
argument_list|,
literal|"test%3i : testing ZSTD error code strings : "
argument_list|,
name|testNb
operator|++
argument_list|)
expr_stmt|;
if|if
condition|(
name|strcmp
argument_list|(
literal|"No error detected"
argument_list|,
name|ZSTD_getErrorName
argument_list|(
call|(
name|ZSTD_ErrorCode
call|)
argument_list|(
literal|0
operator|-
name|ZSTD_error_no_error
argument_list|)
argument_list|)
argument_list|)
operator|!=
literal|0
condition|)
goto|goto
name|_output_error
goto|;
if|if
condition|(
name|strcmp
argument_list|(
literal|"No error detected"
argument_list|,
name|ZSTD_getErrorString
argument_list|(
name|ZSTD_error_no_error
argument_list|)
argument_list|)
operator|!=
literal|0
condition|)
goto|goto
name|_output_error
goto|;
if|if
condition|(
name|strcmp
argument_list|(
literal|"Unspecified error code"
argument_list|,
name|ZSTD_getErrorString
argument_list|(
call|(
name|ZSTD_ErrorCode
call|)
argument_list|(
literal|0
operator|-
name|ZSTD_error_GENERIC
argument_list|)
argument_list|)
argument_list|)
operator|!=
literal|0
condition|)
goto|goto
name|_output_error
goto|;
if|if
condition|(
name|strcmp
argument_list|(
literal|"Error (generic)"
argument_list|,
name|ZSTD_getErrorName
argument_list|(
operator|(
name|size_t
operator|)
literal|0
operator|-
name|ZSTD_error_GENERIC
argument_list|)
argument_list|)
operator|!=
literal|0
condition|)
goto|goto
name|_output_error
goto|;
if|if
condition|(
name|strcmp
argument_list|(
literal|"Error (generic)"
argument_list|,
name|ZSTD_getErrorString
argument_list|(
name|ZSTD_error_GENERIC
argument_list|)
argument_list|)
operator|!=
literal|0
condition|)
goto|goto
name|_output_error
goto|;
if|if
condition|(
name|strcmp
argument_list|(
literal|"No error detected"
argument_list|,
name|ZSTD_getErrorName
argument_list|(
name|ZSTD_error_GENERIC
argument_list|)
argument_list|)
operator|!=
literal|0
condition|)
goto|goto
name|_output_error
goto|;
name|DISPLAYLEVEL
argument_list|(
literal|4
argument_list|,
literal|"OK \n"
argument_list|)
expr_stmt|;
name|_end
label|:
name|free
argument_list|(
name|CNBuffer
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|compressedBuffer
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|decodedBuffer
argument_list|)
expr_stmt|;
return|return
name|testResult
return|;
name|_output_error
label|:
name|testResult
operator|=
literal|1
expr_stmt|;
name|DISPLAY
argument_list|(
literal|"Error detected in Unit tests ! \n"
argument_list|)
expr_stmt|;
goto|goto
name|_end
goto|;
block|}
end_function

begin_function
specifier|static
name|size_t
name|findDiff
parameter_list|(
specifier|const
name|void
modifier|*
name|buf1
parameter_list|,
specifier|const
name|void
modifier|*
name|buf2
parameter_list|,
name|size_t
name|max
parameter_list|)
block|{
specifier|const
name|BYTE
modifier|*
name|b1
init|=
operator|(
specifier|const
name|BYTE
operator|*
operator|)
name|buf1
decl_stmt|;
specifier|const
name|BYTE
modifier|*
name|b2
init|=
operator|(
specifier|const
name|BYTE
operator|*
operator|)
name|buf2
decl_stmt|;
name|size_t
name|u
decl_stmt|;
for|for
control|(
name|u
operator|=
literal|0
init|;
name|u
operator|<
name|max
condition|;
name|u
operator|++
control|)
block|{
if|if
condition|(
name|b1
index|[
name|u
index|]
operator|!=
name|b2
index|[
name|u
index|]
condition|)
break|break;
block|}
return|return
name|u
return|;
block|}
end_function

begin_function
specifier|static
name|size_t
name|FUZ_rLogLength
parameter_list|(
name|U32
modifier|*
name|seed
parameter_list|,
name|U32
name|logLength
parameter_list|)
block|{
name|size_t
specifier|const
name|lengthMask
init|=
operator|(
operator|(
name|size_t
operator|)
literal|1
operator|<<
name|logLength
operator|)
operator|-
literal|1
decl_stmt|;
return|return
operator|(
name|lengthMask
operator|+
literal|1
operator|)
operator|+
operator|(
name|FUZ_rand
argument_list|(
name|seed
argument_list|)
operator|&
name|lengthMask
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|size_t
name|FUZ_randomLength
parameter_list|(
name|U32
modifier|*
name|seed
parameter_list|,
name|U32
name|maxLog
parameter_list|)
block|{
name|U32
specifier|const
name|logLength
init|=
name|FUZ_rand
argument_list|(
name|seed
argument_list|)
operator|%
name|maxLog
decl_stmt|;
return|return
name|FUZ_rLogLength
argument_list|(
name|seed
argument_list|,
name|logLength
argument_list|)
return|;
block|}
end_function

begin_undef
undef|#
directive|undef
name|CHECK
end_undef

begin_define
define|#
directive|define
name|CHECK
parameter_list|(
name|cond
parameter_list|,
modifier|...
parameter_list|)
value|if (cond) { DISPLAY("Error => "); DISPLAY(__VA_ARGS__); \                          DISPLAY(" (seed %u, test nb %u)  \n", seed, testNb); goto _output_error; }
end_define

begin_function
specifier|static
name|int
name|fuzzerTests
parameter_list|(
name|U32
name|seed
parameter_list|,
name|U32
name|nbTests
parameter_list|,
name|unsigned
name|startTest
parameter_list|,
name|U32
specifier|const
name|maxDurationS
parameter_list|,
name|double
name|compressibility
parameter_list|)
block|{
specifier|static
specifier|const
name|U32
name|maxSrcLog
init|=
literal|23
decl_stmt|;
specifier|static
specifier|const
name|U32
name|maxSampleLog
init|=
literal|22
decl_stmt|;
name|size_t
specifier|const
name|srcBufferSize
init|=
operator|(
name|size_t
operator|)
literal|1
operator|<<
name|maxSrcLog
decl_stmt|;
name|size_t
specifier|const
name|dstBufferSize
init|=
operator|(
name|size_t
operator|)
literal|1
operator|<<
name|maxSampleLog
decl_stmt|;
name|size_t
specifier|const
name|cBufferSize
init|=
name|ZSTD_compressBound
argument_list|(
name|dstBufferSize
argument_list|)
decl_stmt|;
name|BYTE
modifier|*
name|cNoiseBuffer
index|[
literal|5
index|]
decl_stmt|;
name|BYTE
modifier|*
name|srcBuffer
decl_stmt|;
comment|/* jumping pointer */
name|BYTE
modifier|*
specifier|const
name|cBuffer
init|=
operator|(
name|BYTE
operator|*
operator|)
name|malloc
argument_list|(
name|cBufferSize
argument_list|)
decl_stmt|;
name|BYTE
modifier|*
specifier|const
name|dstBuffer
init|=
operator|(
name|BYTE
operator|*
operator|)
name|malloc
argument_list|(
name|dstBufferSize
argument_list|)
decl_stmt|;
name|BYTE
modifier|*
specifier|const
name|mirrorBuffer
init|=
operator|(
name|BYTE
operator|*
operator|)
name|malloc
argument_list|(
name|dstBufferSize
argument_list|)
decl_stmt|;
name|ZSTD_CCtx
modifier|*
specifier|const
name|refCtx
init|=
name|ZSTD_createCCtx
argument_list|()
decl_stmt|;
name|ZSTD_CCtx
modifier|*
specifier|const
name|ctx
init|=
name|ZSTD_createCCtx
argument_list|()
decl_stmt|;
name|ZSTD_DCtx
modifier|*
specifier|const
name|dctx
init|=
name|ZSTD_createDCtx
argument_list|()
decl_stmt|;
name|U32
name|result
init|=
literal|0
decl_stmt|;
name|U32
name|testNb
init|=
literal|0
decl_stmt|;
name|U32
name|coreSeed
init|=
name|seed
decl_stmt|,
name|lseed
init|=
literal|0
decl_stmt|;
name|clock_t
specifier|const
name|startClock
init|=
name|clock
argument_list|()
decl_stmt|;
name|clock_t
specifier|const
name|maxClockSpan
init|=
name|maxDurationS
operator|*
name|CLOCKS_PER_SEC
decl_stmt|;
comment|/* allocation */
name|cNoiseBuffer
index|[
literal|0
index|]
operator|=
operator|(
name|BYTE
operator|*
operator|)
name|malloc
argument_list|(
name|srcBufferSize
argument_list|)
expr_stmt|;
name|cNoiseBuffer
index|[
literal|1
index|]
operator|=
operator|(
name|BYTE
operator|*
operator|)
name|malloc
argument_list|(
name|srcBufferSize
argument_list|)
expr_stmt|;
name|cNoiseBuffer
index|[
literal|2
index|]
operator|=
operator|(
name|BYTE
operator|*
operator|)
name|malloc
argument_list|(
name|srcBufferSize
argument_list|)
expr_stmt|;
name|cNoiseBuffer
index|[
literal|3
index|]
operator|=
operator|(
name|BYTE
operator|*
operator|)
name|malloc
argument_list|(
name|srcBufferSize
argument_list|)
expr_stmt|;
name|cNoiseBuffer
index|[
literal|4
index|]
operator|=
operator|(
name|BYTE
operator|*
operator|)
name|malloc
argument_list|(
name|srcBufferSize
argument_list|)
expr_stmt|;
name|CHECK
argument_list|(
operator|!
name|cNoiseBuffer
index|[
literal|0
index|]
operator|||
operator|!
name|cNoiseBuffer
index|[
literal|1
index|]
operator|||
operator|!
name|cNoiseBuffer
index|[
literal|2
index|]
operator|||
operator|!
name|cNoiseBuffer
index|[
literal|3
index|]
operator|||
operator|!
name|cNoiseBuffer
index|[
literal|4
index|]
operator|||
operator|!
name|dstBuffer
operator|||
operator|!
name|mirrorBuffer
operator|||
operator|!
name|cBuffer
operator|||
operator|!
name|refCtx
operator|||
operator|!
name|ctx
operator|||
operator|!
name|dctx
argument_list|,
literal|"Not enough memory, fuzzer tests cancelled"
argument_list|)
expr_stmt|;
comment|/* Create initial samples */
name|RDG_genBuffer
argument_list|(
name|cNoiseBuffer
index|[
literal|0
index|]
argument_list|,
name|srcBufferSize
argument_list|,
literal|0.00
argument_list|,
literal|0.
argument_list|,
name|coreSeed
argument_list|)
expr_stmt|;
comment|/* pure noise */
name|RDG_genBuffer
argument_list|(
name|cNoiseBuffer
index|[
literal|1
index|]
argument_list|,
name|srcBufferSize
argument_list|,
literal|0.05
argument_list|,
literal|0.
argument_list|,
name|coreSeed
argument_list|)
expr_stmt|;
comment|/* barely compressible */
name|RDG_genBuffer
argument_list|(
name|cNoiseBuffer
index|[
literal|2
index|]
argument_list|,
name|srcBufferSize
argument_list|,
name|compressibility
argument_list|,
literal|0.
argument_list|,
name|coreSeed
argument_list|)
expr_stmt|;
name|RDG_genBuffer
argument_list|(
name|cNoiseBuffer
index|[
literal|3
index|]
argument_list|,
name|srcBufferSize
argument_list|,
literal|0.95
argument_list|,
literal|0.
argument_list|,
name|coreSeed
argument_list|)
expr_stmt|;
comment|/* highly compressible */
name|RDG_genBuffer
argument_list|(
name|cNoiseBuffer
index|[
literal|4
index|]
argument_list|,
name|srcBufferSize
argument_list|,
literal|1.00
argument_list|,
literal|0.
argument_list|,
name|coreSeed
argument_list|)
expr_stmt|;
comment|/* sparse content */
name|srcBuffer
operator|=
name|cNoiseBuffer
index|[
literal|2
index|]
expr_stmt|;
comment|/* catch up testNb */
for|for
control|(
name|testNb
operator|=
literal|1
init|;
name|testNb
operator|<
name|startTest
condition|;
name|testNb
operator|++
control|)
name|FUZ_rand
argument_list|(
operator|&
name|coreSeed
argument_list|)
expr_stmt|;
comment|/* main test loop */
for|for
control|(
init|;
operator|(
name|testNb
operator|<=
name|nbTests
operator|)
operator|||
operator|(
name|FUZ_clockSpan
argument_list|(
name|startClock
argument_list|)
operator|<
name|maxClockSpan
operator|)
condition|;
name|testNb
operator|++
control|)
block|{
name|size_t
name|sampleSize
decl_stmt|,
name|maxTestSize
decl_stmt|,
name|totalTestSize
decl_stmt|;
name|size_t
name|cSize
decl_stmt|,
name|totalCSize
decl_stmt|,
name|totalGenSize
decl_stmt|;
name|XXH64_state_t
name|xxhState
decl_stmt|;
name|U64
name|crcOrig
decl_stmt|;
name|BYTE
modifier|*
name|sampleBuffer
decl_stmt|;
specifier|const
name|BYTE
modifier|*
name|dict
decl_stmt|;
name|size_t
name|dictSize
decl_stmt|;
comment|/* notification */
if|if
condition|(
name|nbTests
operator|>=
name|testNb
condition|)
block|{
name|DISPLAYUPDATE
argument_list|(
literal|2
argument_list|,
literal|"\r%6u/%6u    "
argument_list|,
name|testNb
argument_list|,
name|nbTests
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|DISPLAYUPDATE
argument_list|(
literal|2
argument_list|,
literal|"\r%6u          "
argument_list|,
name|testNb
argument_list|)
expr_stmt|;
block|}
name|FUZ_rand
argument_list|(
operator|&
name|coreSeed
argument_list|)
expr_stmt|;
block|{
name|U32
specifier|const
name|prime1
init|=
literal|2654435761U
decl_stmt|;
name|lseed
operator|=
name|coreSeed
operator|^
name|prime1
expr_stmt|;
block|}
comment|/* srcBuffer selection [0-4] */
block|{
name|U32
name|buffNb
init|=
name|FUZ_rand
argument_list|(
operator|&
name|lseed
argument_list|)
operator|&
literal|0x7F
decl_stmt|;
if|if
condition|(
name|buffNb
operator|&
literal|7
condition|)
name|buffNb
operator|=
literal|2
expr_stmt|;
comment|/* most common : compressible (P) */
else|else
block|{
name|buffNb
operator|>>=
literal|3
expr_stmt|;
if|if
condition|(
name|buffNb
operator|&
literal|7
condition|)
block|{
specifier|const
name|U32
name|tnb
index|[
literal|2
index|]
init|=
block|{
literal|1
block|,
literal|3
block|}
decl_stmt|;
comment|/* barely/highly compressible */
name|buffNb
operator|=
name|tnb
index|[
name|buffNb
operator|>>
literal|3
index|]
expr_stmt|;
block|}
else|else
block|{
specifier|const
name|U32
name|tnb
index|[
literal|2
index|]
init|=
block|{
literal|0
block|,
literal|4
block|}
decl_stmt|;
comment|/* not compressible / sparse */
name|buffNb
operator|=
name|tnb
index|[
name|buffNb
operator|>>
literal|3
index|]
expr_stmt|;
block|}
block|}
name|srcBuffer
operator|=
name|cNoiseBuffer
index|[
name|buffNb
index|]
expr_stmt|;
block|}
comment|/* select src segment */
name|sampleSize
operator|=
name|FUZ_randomLength
argument_list|(
operator|&
name|lseed
argument_list|,
name|maxSampleLog
argument_list|)
expr_stmt|;
comment|/* create sample buffer (to catch read error with valgrind& sanitizers)  */
name|sampleBuffer
operator|=
operator|(
name|BYTE
operator|*
operator|)
name|malloc
argument_list|(
name|sampleSize
argument_list|)
expr_stmt|;
name|CHECK
argument_list|(
name|sampleBuffer
operator|==
name|NULL
argument_list|,
literal|"not enough memory for sample buffer"
argument_list|)
expr_stmt|;
block|{
name|size_t
specifier|const
name|sampleStart
init|=
name|FUZ_rand
argument_list|(
operator|&
name|lseed
argument_list|)
operator|%
operator|(
name|srcBufferSize
operator|-
name|sampleSize
operator|)
decl_stmt|;
name|memcpy
argument_list|(
name|sampleBuffer
argument_list|,
name|srcBuffer
operator|+
name|sampleStart
argument_list|,
name|sampleSize
argument_list|)
expr_stmt|;
block|}
name|crcOrig
operator|=
name|XXH64
argument_list|(
name|sampleBuffer
argument_list|,
name|sampleSize
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* compression tests */
block|{
name|unsigned
specifier|const
name|cLevel
init|=
operator|(
name|FUZ_rand
argument_list|(
operator|&
name|lseed
argument_list|)
operator|%
operator|(
name|ZSTD_maxCLevel
argument_list|()
operator|-
operator|(
name|FUZ_highbit32
argument_list|(
operator|(
name|U32
operator|)
name|sampleSize
argument_list|)
operator|/
literal|3
operator|)
operator|)
operator|)
operator|+
literal|1
decl_stmt|;
name|cSize
operator|=
name|ZSTD_compressCCtx
argument_list|(
name|ctx
argument_list|,
name|cBuffer
argument_list|,
name|cBufferSize
argument_list|,
name|sampleBuffer
argument_list|,
name|sampleSize
argument_list|,
name|cLevel
argument_list|)
expr_stmt|;
name|CHECK
argument_list|(
name|ZSTD_isError
argument_list|(
name|cSize
argument_list|)
argument_list|,
literal|"ZSTD_compressCCtx failed : %s"
argument_list|,
name|ZSTD_getErrorName
argument_list|(
name|cSize
argument_list|)
argument_list|)
expr_stmt|;
comment|/* compression failure test : too small dest buffer */
if|if
condition|(
name|cSize
operator|>
literal|3
condition|)
block|{
specifier|const
name|size_t
name|missing
init|=
operator|(
name|FUZ_rand
argument_list|(
operator|&
name|lseed
argument_list|)
operator|%
operator|(
name|cSize
operator|-
literal|2
operator|)
operator|)
operator|+
literal|1
decl_stmt|;
comment|/* no problem, as cSize> 4 (frameHeaderSizer) */
specifier|const
name|size_t
name|tooSmallSize
init|=
name|cSize
operator|-
name|missing
decl_stmt|;
specifier|const
name|U32
name|endMark
init|=
literal|0x4DC2B1A9
decl_stmt|;
name|memcpy
argument_list|(
name|dstBuffer
operator|+
name|tooSmallSize
argument_list|,
operator|&
name|endMark
argument_list|,
literal|4
argument_list|)
expr_stmt|;
block|{
name|size_t
specifier|const
name|errorCode
init|=
name|ZSTD_compressCCtx
argument_list|(
name|ctx
argument_list|,
name|dstBuffer
argument_list|,
name|tooSmallSize
argument_list|,
name|sampleBuffer
argument_list|,
name|sampleSize
argument_list|,
name|cLevel
argument_list|)
decl_stmt|;
name|CHECK
argument_list|(
operator|!
name|ZSTD_isError
argument_list|(
name|errorCode
argument_list|)
argument_list|,
literal|"ZSTD_compressCCtx should have failed ! (buffer too small : %u< %u)"
argument_list|,
operator|(
name|U32
operator|)
name|tooSmallSize
argument_list|,
operator|(
name|U32
operator|)
name|cSize
argument_list|)
expr_stmt|;
block|}
block|{
name|U32
name|endCheck
decl_stmt|;
name|memcpy
argument_list|(
operator|&
name|endCheck
argument_list|,
name|dstBuffer
operator|+
name|tooSmallSize
argument_list|,
literal|4
argument_list|)
expr_stmt|;
name|CHECK
argument_list|(
name|endCheck
operator|!=
name|endMark
argument_list|,
literal|"ZSTD_compressCCtx : dst buffer overflow"
argument_list|)
expr_stmt|;
block|}
block|}
block|}
comment|/* Decompressed size test */
block|{
name|unsigned
name|long
name|long
specifier|const
name|rSize
init|=
name|ZSTD_findDecompressedSize
argument_list|(
name|cBuffer
argument_list|,
name|cSize
argument_list|)
decl_stmt|;
name|CHECK
argument_list|(
name|rSize
operator|!=
name|sampleSize
argument_list|,
literal|"decompressed size incorrect"
argument_list|)
expr_stmt|;
block|}
comment|/* frame header decompression test */
block|{
name|ZSTD_frameParams
name|dParams
decl_stmt|;
name|size_t
specifier|const
name|check
init|=
name|ZSTD_getFrameParams
argument_list|(
operator|&
name|dParams
argument_list|,
name|cBuffer
argument_list|,
name|cSize
argument_list|)
decl_stmt|;
name|CHECK
argument_list|(
name|ZSTD_isError
argument_list|(
name|check
argument_list|)
argument_list|,
literal|"Frame Parameters extraction failed"
argument_list|)
expr_stmt|;
name|CHECK
argument_list|(
name|dParams
operator|.
name|frameContentSize
operator|!=
name|sampleSize
argument_list|,
literal|"Frame content size incorrect"
argument_list|)
expr_stmt|;
block|}
comment|/* successful decompression test */
block|{
name|size_t
specifier|const
name|margin
init|=
operator|(
name|FUZ_rand
argument_list|(
operator|&
name|lseed
argument_list|)
operator|&
literal|1
operator|)
condition|?
literal|0
else|:
operator|(
name|FUZ_rand
argument_list|(
operator|&
name|lseed
argument_list|)
operator|&
literal|31
operator|)
operator|+
literal|1
decl_stmt|;
name|size_t
specifier|const
name|dSize
init|=
name|ZSTD_decompress
argument_list|(
name|dstBuffer
argument_list|,
name|sampleSize
operator|+
name|margin
argument_list|,
name|cBuffer
argument_list|,
name|cSize
argument_list|)
decl_stmt|;
name|CHECK
argument_list|(
name|dSize
operator|!=
name|sampleSize
argument_list|,
literal|"ZSTD_decompress failed (%s) (srcSize : %u ; cSize : %u)"
argument_list|,
name|ZSTD_getErrorName
argument_list|(
name|dSize
argument_list|)
argument_list|,
operator|(
name|U32
operator|)
name|sampleSize
argument_list|,
operator|(
name|U32
operator|)
name|cSize
argument_list|)
expr_stmt|;
block|{
name|U64
specifier|const
name|crcDest
init|=
name|XXH64
argument_list|(
name|dstBuffer
argument_list|,
name|sampleSize
argument_list|,
literal|0
argument_list|)
decl_stmt|;
name|CHECK
argument_list|(
name|crcOrig
operator|!=
name|crcDest
argument_list|,
literal|"decompression result corrupted (pos %u / %u)"
argument_list|,
operator|(
name|U32
operator|)
name|findDiff
argument_list|(
name|sampleBuffer
argument_list|,
name|dstBuffer
argument_list|,
name|sampleSize
argument_list|)
argument_list|,
operator|(
name|U32
operator|)
name|sampleSize
argument_list|)
expr_stmt|;
block|}
block|}
name|free
argument_list|(
name|sampleBuffer
argument_list|)
expr_stmt|;
comment|/* no longer useful after this point */
comment|/* truncated src decompression test */
block|{
name|size_t
specifier|const
name|missing
init|=
operator|(
name|FUZ_rand
argument_list|(
operator|&
name|lseed
argument_list|)
operator|%
operator|(
name|cSize
operator|-
literal|2
operator|)
operator|)
operator|+
literal|1
decl_stmt|;
comment|/* no problem, as cSize> 4 (frameHeaderSizer) */
name|size_t
specifier|const
name|tooSmallSize
init|=
name|cSize
operator|-
name|missing
decl_stmt|;
name|void
modifier|*
name|cBufferTooSmall
init|=
name|malloc
argument_list|(
name|tooSmallSize
argument_list|)
decl_stmt|;
comment|/* valgrind will catch read overflows */
name|CHECK
argument_list|(
name|cBufferTooSmall
operator|==
name|NULL
argument_list|,
literal|"not enough memory !"
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
name|cBufferTooSmall
argument_list|,
name|cBuffer
argument_list|,
name|tooSmallSize
argument_list|)
expr_stmt|;
block|{
name|size_t
specifier|const
name|errorCode
init|=
name|ZSTD_decompress
argument_list|(
name|dstBuffer
argument_list|,
name|dstBufferSize
argument_list|,
name|cBufferTooSmall
argument_list|,
name|tooSmallSize
argument_list|)
decl_stmt|;
name|CHECK
argument_list|(
operator|!
name|ZSTD_isError
argument_list|(
name|errorCode
argument_list|)
argument_list|,
literal|"ZSTD_decompress should have failed ! (truncated src buffer)"
argument_list|)
expr_stmt|;
block|}
name|free
argument_list|(
name|cBufferTooSmall
argument_list|)
expr_stmt|;
block|}
comment|/* too small dst decompression test */
if|if
condition|(
name|sampleSize
operator|>
literal|3
condition|)
block|{
name|size_t
specifier|const
name|missing
init|=
operator|(
name|FUZ_rand
argument_list|(
operator|&
name|lseed
argument_list|)
operator|%
operator|(
name|sampleSize
operator|-
literal|2
operator|)
operator|)
operator|+
literal|1
decl_stmt|;
comment|/* no problem, as cSize> 4 (frameHeaderSizer) */
name|size_t
specifier|const
name|tooSmallSize
init|=
name|sampleSize
operator|-
name|missing
decl_stmt|;
specifier|static
specifier|const
name|BYTE
name|token
init|=
literal|0xA9
decl_stmt|;
name|dstBuffer
index|[
name|tooSmallSize
index|]
operator|=
name|token
expr_stmt|;
block|{
name|size_t
specifier|const
name|errorCode
init|=
name|ZSTD_decompress
argument_list|(
name|dstBuffer
argument_list|,
name|tooSmallSize
argument_list|,
name|cBuffer
argument_list|,
name|cSize
argument_list|)
decl_stmt|;
name|CHECK
argument_list|(
operator|!
name|ZSTD_isError
argument_list|(
name|errorCode
argument_list|)
argument_list|,
literal|"ZSTD_decompress should have failed : %u> %u (dst buffer too small)"
argument_list|,
operator|(
name|U32
operator|)
name|errorCode
argument_list|,
operator|(
name|U32
operator|)
name|tooSmallSize
argument_list|)
expr_stmt|;
block|}
name|CHECK
argument_list|(
name|dstBuffer
index|[
name|tooSmallSize
index|]
operator|!=
name|token
argument_list|,
literal|"ZSTD_decompress : dst buffer overflow"
argument_list|)
expr_stmt|;
block|}
comment|/* noisy src decompression test */
if|if
condition|(
name|cSize
operator|>
literal|6
condition|)
block|{
comment|/* insert noise into src */
block|{
name|U32
specifier|const
name|maxNbBits
init|=
name|FUZ_highbit32
argument_list|(
call|(
name|U32
call|)
argument_list|(
name|cSize
operator|-
literal|4
argument_list|)
argument_list|)
decl_stmt|;
name|size_t
name|pos
init|=
literal|4
decl_stmt|;
comment|/* preserve magic number (too easy to detect) */
for|for
control|(
init|;
condition|;
control|)
block|{
comment|/* keep some original src */
block|{
name|U32
specifier|const
name|nbBits
init|=
name|FUZ_rand
argument_list|(
operator|&
name|lseed
argument_list|)
operator|%
name|maxNbBits
decl_stmt|;
name|size_t
specifier|const
name|mask
init|=
operator|(
literal|1
operator|<<
name|nbBits
operator|)
operator|-
literal|1
decl_stmt|;
name|size_t
specifier|const
name|skipLength
init|=
name|FUZ_rand
argument_list|(
operator|&
name|lseed
argument_list|)
operator|&
name|mask
decl_stmt|;
name|pos
operator|+=
name|skipLength
expr_stmt|;
block|}
if|if
condition|(
name|pos
operator|<=
name|cSize
condition|)
break|break;
comment|/* add noise */
block|{
name|U32
specifier|const
name|nbBitsCodes
init|=
name|FUZ_rand
argument_list|(
operator|&
name|lseed
argument_list|)
operator|%
name|maxNbBits
decl_stmt|;
name|U32
specifier|const
name|nbBits
init|=
name|nbBitsCodes
condition|?
name|nbBitsCodes
operator|-
literal|1
else|:
literal|0
decl_stmt|;
name|size_t
specifier|const
name|mask
init|=
operator|(
literal|1
operator|<<
name|nbBits
operator|)
operator|-
literal|1
decl_stmt|;
name|size_t
specifier|const
name|rNoiseLength
init|=
operator|(
name|FUZ_rand
argument_list|(
operator|&
name|lseed
argument_list|)
operator|&
name|mask
operator|)
operator|+
literal|1
decl_stmt|;
name|size_t
specifier|const
name|noiseLength
init|=
name|MIN
argument_list|(
name|rNoiseLength
argument_list|,
name|cSize
operator|-
name|pos
argument_list|)
decl_stmt|;
name|size_t
specifier|const
name|noiseStart
init|=
name|FUZ_rand
argument_list|(
operator|&
name|lseed
argument_list|)
operator|%
operator|(
name|srcBufferSize
operator|-
name|noiseLength
operator|)
decl_stmt|;
name|memcpy
argument_list|(
name|cBuffer
operator|+
name|pos
argument_list|,
name|srcBuffer
operator|+
name|noiseStart
argument_list|,
name|noiseLength
argument_list|)
expr_stmt|;
name|pos
operator|+=
name|noiseLength
expr_stmt|;
block|}
block|}
block|}
comment|/* decompress noisy source */
block|{
name|U32
specifier|const
name|endMark
init|=
literal|0xA9B1C3D6
decl_stmt|;
name|memcpy
argument_list|(
name|dstBuffer
operator|+
name|sampleSize
argument_list|,
operator|&
name|endMark
argument_list|,
literal|4
argument_list|)
expr_stmt|;
block|{
name|size_t
specifier|const
name|decompressResult
init|=
name|ZSTD_decompress
argument_list|(
name|dstBuffer
argument_list|,
name|sampleSize
argument_list|,
name|cBuffer
argument_list|,
name|cSize
argument_list|)
decl_stmt|;
comment|/* result *may* be an unlikely success, but even then, it must strictly respect dst buffer boundaries */
name|CHECK
argument_list|(
operator|(
operator|!
name|ZSTD_isError
argument_list|(
name|decompressResult
argument_list|)
operator|)
operator|&&
operator|(
name|decompressResult
operator|>
name|sampleSize
operator|)
argument_list|,
literal|"ZSTD_decompress on noisy src : result is too large : %u> %u (dst buffer)"
argument_list|,
operator|(
name|U32
operator|)
name|decompressResult
argument_list|,
operator|(
name|U32
operator|)
name|sampleSize
argument_list|)
expr_stmt|;
block|}
block|{
name|U32
name|endCheck
decl_stmt|;
name|memcpy
argument_list|(
operator|&
name|endCheck
argument_list|,
name|dstBuffer
operator|+
name|sampleSize
argument_list|,
literal|4
argument_list|)
expr_stmt|;
name|CHECK
argument_list|(
name|endMark
operator|!=
name|endCheck
argument_list|,
literal|"ZSTD_decompress on noisy src : dst buffer overflow"
argument_list|)
expr_stmt|;
block|}
block|}
block|}
comment|/* noisy src decompression test */
comment|/*=====   Streaming compression test, scattered segments and dictionary   =====*/
block|{
name|U32
specifier|const
name|testLog
init|=
name|FUZ_rand
argument_list|(
operator|&
name|lseed
argument_list|)
operator|%
name|maxSrcLog
decl_stmt|;
name|U32
specifier|const
name|dictLog
init|=
name|FUZ_rand
argument_list|(
operator|&
name|lseed
argument_list|)
operator|%
name|maxSrcLog
decl_stmt|;
name|int
specifier|const
name|cLevel
init|=
operator|(
name|FUZ_rand
argument_list|(
operator|&
name|lseed
argument_list|)
operator|%
operator|(
name|ZSTD_maxCLevel
argument_list|()
operator|-
operator|(
name|MAX
argument_list|(
name|testLog
argument_list|,
name|dictLog
argument_list|)
operator|/
literal|3
operator|)
operator|)
operator|)
operator|+
literal|1
decl_stmt|;
name|maxTestSize
operator|=
name|FUZ_rLogLength
argument_list|(
operator|&
name|lseed
argument_list|,
name|testLog
argument_list|)
expr_stmt|;
if|if
condition|(
name|maxTestSize
operator|>=
name|dstBufferSize
condition|)
name|maxTestSize
operator|=
name|dstBufferSize
operator|-
literal|1
expr_stmt|;
name|dictSize
operator|=
name|FUZ_rLogLength
argument_list|(
operator|&
name|lseed
argument_list|,
name|dictLog
argument_list|)
expr_stmt|;
comment|/* needed also for decompression */
name|dict
operator|=
name|srcBuffer
operator|+
operator|(
name|FUZ_rand
argument_list|(
operator|&
name|lseed
argument_list|)
operator|%
operator|(
name|srcBufferSize
operator|-
name|dictSize
operator|)
operator|)
expr_stmt|;
if|if
condition|(
name|FUZ_rand
argument_list|(
operator|&
name|lseed
argument_list|)
operator|&
literal|0xF
condition|)
block|{
name|size_t
specifier|const
name|errorCode
init|=
name|ZSTD_compressBegin_usingDict
argument_list|(
name|refCtx
argument_list|,
name|dict
argument_list|,
name|dictSize
argument_list|,
name|cLevel
argument_list|)
decl_stmt|;
name|CHECK
argument_list|(
name|ZSTD_isError
argument_list|(
name|errorCode
argument_list|)
argument_list|,
literal|"ZSTD_compressBegin_usingDict error : %s"
argument_list|,
name|ZSTD_getErrorName
argument_list|(
name|errorCode
argument_list|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|ZSTD_compressionParameters
specifier|const
name|cPar
init|=
name|ZSTD_getCParams
argument_list|(
name|cLevel
argument_list|,
literal|0
argument_list|,
name|dictSize
argument_list|)
decl_stmt|;
name|ZSTD_frameParameters
specifier|const
name|fpar
init|=
block|{
name|FUZ_rand
argument_list|(
operator|&
name|lseed
argument_list|)
operator|&
literal|1
comment|/* contentSizeFlag */
block|,
operator|!
operator|(
name|FUZ_rand
argument_list|(
operator|&
name|lseed
argument_list|)
operator|&
literal|3
operator|)
comment|/* contentChecksumFlag*/
block|,
literal|0
comment|/*NodictID*/
block|}
decl_stmt|;
comment|/* note : since dictionary is fake, dictIDflag has no impact */
name|ZSTD_parameters
name|p
decl_stmt|;
name|size_t
name|errorCode
decl_stmt|;
name|p
operator|.
name|cParams
operator|=
name|cPar
expr_stmt|;
name|p
operator|.
name|fParams
operator|=
name|fpar
expr_stmt|;
name|errorCode
operator|=
name|ZSTD_compressBegin_advanced
argument_list|(
name|refCtx
argument_list|,
name|dict
argument_list|,
name|dictSize
argument_list|,
name|p
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|CHECK
argument_list|(
name|ZSTD_isError
argument_list|(
name|errorCode
argument_list|)
argument_list|,
literal|"ZSTD_compressBegin_advanced error : %s"
argument_list|,
name|ZSTD_getErrorName
argument_list|(
name|errorCode
argument_list|)
argument_list|)
expr_stmt|;
block|}
block|{
name|size_t
specifier|const
name|errorCode
init|=
name|ZSTD_copyCCtx
argument_list|(
name|ctx
argument_list|,
name|refCtx
argument_list|,
literal|0
argument_list|)
decl_stmt|;
name|CHECK
argument_list|(
name|ZSTD_isError
argument_list|(
name|errorCode
argument_list|)
argument_list|,
literal|"ZSTD_copyCCtx error : %s"
argument_list|,
name|ZSTD_getErrorName
argument_list|(
name|errorCode
argument_list|)
argument_list|)
expr_stmt|;
block|}
block|}
name|XXH64_reset
argument_list|(
operator|&
name|xxhState
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|ZSTD_setCCtxParameter
argument_list|(
name|ctx
argument_list|,
name|ZSTD_p_forceWindow
argument_list|,
name|FUZ_rand
argument_list|(
operator|&
name|lseed
argument_list|)
operator|&
literal|1
argument_list|)
expr_stmt|;
block|{
name|U32
specifier|const
name|nbChunks
init|=
operator|(
name|FUZ_rand
argument_list|(
operator|&
name|lseed
argument_list|)
operator|&
literal|127
operator|)
operator|+
literal|2
decl_stmt|;
name|U32
name|n
decl_stmt|;
for|for
control|(
name|totalTestSize
operator|=
literal|0
operator|,
name|cSize
operator|=
literal|0
operator|,
name|n
operator|=
literal|0
init|;
name|n
operator|<
name|nbChunks
condition|;
name|n
operator|++
control|)
block|{
name|size_t
specifier|const
name|segmentSize
init|=
name|FUZ_randomLength
argument_list|(
operator|&
name|lseed
argument_list|,
name|maxSampleLog
argument_list|)
decl_stmt|;
name|size_t
specifier|const
name|segmentStart
init|=
name|FUZ_rand
argument_list|(
operator|&
name|lseed
argument_list|)
operator|%
operator|(
name|srcBufferSize
operator|-
name|segmentSize
operator|)
decl_stmt|;
if|if
condition|(
name|cBufferSize
operator|-
name|cSize
operator|<
name|ZSTD_compressBound
argument_list|(
name|segmentSize
argument_list|)
condition|)
break|break;
comment|/* avoid invalid dstBufferTooSmall */
if|if
condition|(
name|totalTestSize
operator|+
name|segmentSize
operator|>
name|maxTestSize
condition|)
break|break;
block|{
name|size_t
specifier|const
name|compressResult
init|=
name|ZSTD_compressContinue
argument_list|(
name|ctx
argument_list|,
name|cBuffer
operator|+
name|cSize
argument_list|,
name|cBufferSize
operator|-
name|cSize
argument_list|,
name|srcBuffer
operator|+
name|segmentStart
argument_list|,
name|segmentSize
argument_list|)
decl_stmt|;
name|CHECK
argument_list|(
name|ZSTD_isError
argument_list|(
name|compressResult
argument_list|)
argument_list|,
literal|"multi-segments compression error : %s"
argument_list|,
name|ZSTD_getErrorName
argument_list|(
name|compressResult
argument_list|)
argument_list|)
expr_stmt|;
name|cSize
operator|+=
name|compressResult
expr_stmt|;
block|}
name|XXH64_update
argument_list|(
operator|&
name|xxhState
argument_list|,
name|srcBuffer
operator|+
name|segmentStart
argument_list|,
name|segmentSize
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
name|mirrorBuffer
operator|+
name|totalTestSize
argument_list|,
name|srcBuffer
operator|+
name|segmentStart
argument_list|,
name|segmentSize
argument_list|)
expr_stmt|;
name|totalTestSize
operator|+=
name|segmentSize
expr_stmt|;
block|}
block|}
block|{
name|size_t
specifier|const
name|flushResult
init|=
name|ZSTD_compressEnd
argument_list|(
name|ctx
argument_list|,
name|cBuffer
operator|+
name|cSize
argument_list|,
name|cBufferSize
operator|-
name|cSize
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
decl_stmt|;
name|CHECK
argument_list|(
name|ZSTD_isError
argument_list|(
name|flushResult
argument_list|)
argument_list|,
literal|"multi-segments epilogue error : %s"
argument_list|,
name|ZSTD_getErrorName
argument_list|(
name|flushResult
argument_list|)
argument_list|)
expr_stmt|;
name|cSize
operator|+=
name|flushResult
expr_stmt|;
block|}
name|crcOrig
operator|=
name|XXH64_digest
argument_list|(
operator|&
name|xxhState
argument_list|)
expr_stmt|;
comment|/* streaming decompression test */
if|if
condition|(
name|dictSize
operator|<
literal|8
condition|)
name|dictSize
operator|=
literal|0
operator|,
name|dict
operator|=
name|NULL
expr_stmt|;
comment|/* disable dictionary */
block|{
name|size_t
specifier|const
name|errorCode
init|=
name|ZSTD_decompressBegin_usingDict
argument_list|(
name|dctx
argument_list|,
name|dict
argument_list|,
name|dictSize
argument_list|)
decl_stmt|;
name|CHECK
argument_list|(
name|ZSTD_isError
argument_list|(
name|errorCode
argument_list|)
argument_list|,
literal|"ZSTD_decompressBegin_usingDict error : %s"
argument_list|,
name|ZSTD_getErrorName
argument_list|(
name|errorCode
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|totalCSize
operator|=
literal|0
expr_stmt|;
name|totalGenSize
operator|=
literal|0
expr_stmt|;
while|while
condition|(
name|totalCSize
operator|<
name|cSize
condition|)
block|{
name|size_t
specifier|const
name|inSize
init|=
name|ZSTD_nextSrcSizeToDecompress
argument_list|(
name|dctx
argument_list|)
decl_stmt|;
name|size_t
specifier|const
name|genSize
init|=
name|ZSTD_decompressContinue
argument_list|(
name|dctx
argument_list|,
name|dstBuffer
operator|+
name|totalGenSize
argument_list|,
name|dstBufferSize
operator|-
name|totalGenSize
argument_list|,
name|cBuffer
operator|+
name|totalCSize
argument_list|,
name|inSize
argument_list|)
decl_stmt|;
name|CHECK
argument_list|(
name|ZSTD_isError
argument_list|(
name|genSize
argument_list|)
argument_list|,
literal|"ZSTD_decompressContinue error : %s"
argument_list|,
name|ZSTD_getErrorName
argument_list|(
name|genSize
argument_list|)
argument_list|)
expr_stmt|;
name|totalGenSize
operator|+=
name|genSize
expr_stmt|;
name|totalCSize
operator|+=
name|inSize
expr_stmt|;
block|}
name|CHECK
argument_list|(
name|ZSTD_nextSrcSizeToDecompress
argument_list|(
name|dctx
argument_list|)
operator|!=
literal|0
argument_list|,
literal|"frame not fully decoded"
argument_list|)
expr_stmt|;
name|CHECK
argument_list|(
argument|totalGenSize != totalTestSize
argument_list|,
literal|"streaming decompressed data : wrong size"
argument_list|)
name|CHECK
argument_list|(
argument|totalCSize != cSize
argument_list|,
literal|"compressed data should be fully read"
argument_list|)
block|{
name|U64
specifier|const
name|crcDest
init|=
name|XXH64
argument_list|(
name|dstBuffer
argument_list|,
name|totalTestSize
argument_list|,
literal|0
argument_list|)
decl_stmt|;
if|if
condition|(
name|crcDest
operator|!=
name|crcOrig
condition|)
block|{
name|size_t
specifier|const
name|errorPos
init|=
name|findDiff
argument_list|(
name|mirrorBuffer
argument_list|,
name|dstBuffer
argument_list|,
name|totalTestSize
argument_list|)
decl_stmt|;
name|CHECK
argument_list|(
literal|1
argument_list|,
literal|"streaming decompressed data corrupted : byte %u / %u  (%02X!=%02X)"
argument_list|,
operator|(
name|U32
operator|)
name|errorPos
argument_list|,
operator|(
name|U32
operator|)
name|totalTestSize
argument_list|,
name|dstBuffer
index|[
name|errorPos
index|]
argument_list|,
name|mirrorBuffer
index|[
name|errorPos
index|]
argument_list|)
expr_stmt|;
block|}
block|}
block|}
comment|/* for ( ; (testNb<= nbTests) */
name|DISPLAY
argument_list|(
literal|"\r%u fuzzer tests completed   \n"
argument_list|,
name|testNb
operator|-
literal|1
argument_list|)
expr_stmt|;
name|_cleanup
label|:
name|ZSTD_freeCCtx
argument_list|(
name|refCtx
argument_list|)
expr_stmt|;
name|ZSTD_freeCCtx
argument_list|(
name|ctx
argument_list|)
expr_stmt|;
name|ZSTD_freeDCtx
argument_list|(
name|dctx
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|cNoiseBuffer
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|cNoiseBuffer
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|cNoiseBuffer
index|[
literal|2
index|]
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|cNoiseBuffer
index|[
literal|3
index|]
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|cNoiseBuffer
index|[
literal|4
index|]
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|cBuffer
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|dstBuffer
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|mirrorBuffer
argument_list|)
expr_stmt|;
return|return
name|result
return|;
name|_output_error
label|:
name|result
operator|=
literal|1
expr_stmt|;
goto|goto
name|_cleanup
goto|;
block|}
end_function

begin_comment
comment|/*_******************************************************* *  Command line *********************************************************/
end_comment

begin_function
name|int
name|FUZ_usage
parameter_list|(
specifier|const
name|char
modifier|*
name|programName
parameter_list|)
block|{
name|DISPLAY
argument_list|(
literal|"Usage :\n"
argument_list|)
expr_stmt|;
name|DISPLAY
argument_list|(
literal|"      %s [args]\n"
argument_list|,
name|programName
argument_list|)
expr_stmt|;
name|DISPLAY
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
name|DISPLAY
argument_list|(
literal|"Arguments :\n"
argument_list|)
expr_stmt|;
name|DISPLAY
argument_list|(
literal|" -i#    : Nb of tests (default:%u) \n"
argument_list|,
name|nbTestsDefault
argument_list|)
expr_stmt|;
name|DISPLAY
argument_list|(
literal|" -s#    : Select seed (default:prompt user)\n"
argument_list|)
expr_stmt|;
name|DISPLAY
argument_list|(
literal|" -t#    : Select starting test number (default:0)\n"
argument_list|)
expr_stmt|;
name|DISPLAY
argument_list|(
literal|" -P#    : Select compressibility in %% (default:%u%%)\n"
argument_list|,
name|FUZ_compressibility_default
argument_list|)
expr_stmt|;
name|DISPLAY
argument_list|(
literal|" -v     : verbose\n"
argument_list|)
expr_stmt|;
name|DISPLAY
argument_list|(
literal|" -p     : pause at the end\n"
argument_list|)
expr_stmt|;
name|DISPLAY
argument_list|(
literal|" -h     : display help and exit\n"
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|int
name|main
parameter_list|(
name|int
name|argc
parameter_list|,
specifier|const
name|char
modifier|*
modifier|*
name|argv
parameter_list|)
block|{
name|U32
name|seed
init|=
literal|0
decl_stmt|;
name|int
name|seedset
init|=
literal|0
decl_stmt|;
name|int
name|argNb
decl_stmt|;
name|int
name|nbTests
init|=
name|nbTestsDefault
decl_stmt|;
name|int
name|testNb
init|=
literal|0
decl_stmt|;
name|U32
name|proba
init|=
name|FUZ_compressibility_default
decl_stmt|;
name|int
name|result
init|=
literal|0
decl_stmt|;
name|U32
name|mainPause
init|=
literal|0
decl_stmt|;
name|U32
name|maxDuration
init|=
literal|0
decl_stmt|;
specifier|const
name|char
modifier|*
name|programName
init|=
name|argv
index|[
literal|0
index|]
decl_stmt|;
comment|/* Check command line */
for|for
control|(
name|argNb
operator|=
literal|1
init|;
name|argNb
operator|<
name|argc
condition|;
name|argNb
operator|++
control|)
block|{
specifier|const
name|char
modifier|*
name|argument
init|=
name|argv
index|[
name|argNb
index|]
decl_stmt|;
if|if
condition|(
operator|!
name|argument
condition|)
continue|continue;
comment|/* Protection if argument empty */
comment|/* Handle commands. Aggregated commands are allowed */
if|if
condition|(
name|argument
index|[
literal|0
index|]
operator|==
literal|'-'
condition|)
block|{
name|argument
operator|++
expr_stmt|;
while|while
condition|(
operator|*
name|argument
operator|!=
literal|0
condition|)
block|{
switch|switch
condition|(
operator|*
name|argument
condition|)
block|{
case|case
literal|'h'
case|:
return|return
name|FUZ_usage
argument_list|(
name|programName
argument_list|)
return|;
case|case
literal|'v'
case|:
name|argument
operator|++
expr_stmt|;
name|g_displayLevel
operator|=
literal|4
expr_stmt|;
break|break;
case|case
literal|'q'
case|:
name|argument
operator|++
expr_stmt|;
name|g_displayLevel
operator|--
expr_stmt|;
break|break;
case|case
literal|'p'
case|:
comment|/* pause at the end */
name|argument
operator|++
expr_stmt|;
name|mainPause
operator|=
literal|1
expr_stmt|;
break|break;
case|case
literal|'i'
case|:
name|argument
operator|++
expr_stmt|;
name|maxDuration
operator|=
literal|0
expr_stmt|;
name|nbTests
operator|=
literal|0
expr_stmt|;
while|while
condition|(
operator|(
operator|*
name|argument
operator|>=
literal|'0'
operator|)
operator|&&
operator|(
operator|*
name|argument
operator|<=
literal|'9'
operator|)
condition|)
block|{
name|nbTests
operator|*=
literal|10
expr_stmt|;
name|nbTests
operator|+=
operator|*
name|argument
operator|-
literal|'0'
expr_stmt|;
name|argument
operator|++
expr_stmt|;
block|}
break|break;
case|case
literal|'T'
case|:
name|argument
operator|++
expr_stmt|;
name|nbTests
operator|=
literal|0
expr_stmt|;
name|maxDuration
operator|=
literal|0
expr_stmt|;
while|while
condition|(
operator|(
operator|*
name|argument
operator|>=
literal|'0'
operator|)
operator|&&
operator|(
operator|*
name|argument
operator|<=
literal|'9'
operator|)
condition|)
block|{
name|maxDuration
operator|*=
literal|10
expr_stmt|;
name|maxDuration
operator|+=
operator|*
name|argument
operator|-
literal|'0'
expr_stmt|;
name|argument
operator|++
expr_stmt|;
block|}
if|if
condition|(
operator|*
name|argument
operator|==
literal|'m'
condition|)
name|maxDuration
operator|*=
literal|60
operator|,
name|argument
operator|++
expr_stmt|;
if|if
condition|(
operator|*
name|argument
operator|==
literal|'n'
condition|)
name|argument
operator|++
expr_stmt|;
break|break;
case|case
literal|'s'
case|:
name|argument
operator|++
expr_stmt|;
name|seed
operator|=
literal|0
expr_stmt|;
name|seedset
operator|=
literal|1
expr_stmt|;
while|while
condition|(
operator|(
operator|*
name|argument
operator|>=
literal|'0'
operator|)
operator|&&
operator|(
operator|*
name|argument
operator|<=
literal|'9'
operator|)
condition|)
block|{
name|seed
operator|*=
literal|10
expr_stmt|;
name|seed
operator|+=
operator|*
name|argument
operator|-
literal|'0'
expr_stmt|;
name|argument
operator|++
expr_stmt|;
block|}
break|break;
case|case
literal|'t'
case|:
name|argument
operator|++
expr_stmt|;
name|testNb
operator|=
literal|0
expr_stmt|;
while|while
condition|(
operator|(
operator|*
name|argument
operator|>=
literal|'0'
operator|)
operator|&&
operator|(
operator|*
name|argument
operator|<=
literal|'9'
operator|)
condition|)
block|{
name|testNb
operator|*=
literal|10
expr_stmt|;
name|testNb
operator|+=
operator|*
name|argument
operator|-
literal|'0'
expr_stmt|;
name|argument
operator|++
expr_stmt|;
block|}
break|break;
case|case
literal|'P'
case|:
comment|/* compressibility % */
name|argument
operator|++
expr_stmt|;
name|proba
operator|=
literal|0
expr_stmt|;
while|while
condition|(
operator|(
operator|*
name|argument
operator|>=
literal|'0'
operator|)
operator|&&
operator|(
operator|*
name|argument
operator|<=
literal|'9'
operator|)
condition|)
block|{
name|proba
operator|*=
literal|10
expr_stmt|;
name|proba
operator|+=
operator|*
name|argument
operator|-
literal|'0'
expr_stmt|;
name|argument
operator|++
expr_stmt|;
block|}
if|if
condition|(
name|proba
operator|>
literal|100
condition|)
name|proba
operator|=
literal|100
expr_stmt|;
break|break;
default|default:
return|return
name|FUZ_usage
argument_list|(
name|programName
argument_list|)
return|;
block|}
block|}
block|}
block|}
comment|/* for (argNb=1; argNb<argc; argNb++) */
comment|/* Get Seed */
name|DISPLAY
argument_list|(
literal|"Starting zstd tester (%i-bits, %s)\n"
argument_list|,
call|(
name|int
call|)
argument_list|(
sizeof|sizeof
argument_list|(
name|size_t
argument_list|)
operator|*
literal|8
argument_list|)
argument_list|,
name|ZSTD_VERSION_STRING
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|seedset
condition|)
block|{
name|time_t
specifier|const
name|t
init|=
name|time
argument_list|(
name|NULL
argument_list|)
decl_stmt|;
name|U32
specifier|const
name|h
init|=
name|XXH32
argument_list|(
operator|&
name|t
argument_list|,
sizeof|sizeof
argument_list|(
name|t
argument_list|)
argument_list|,
literal|1
argument_list|)
decl_stmt|;
name|seed
operator|=
name|h
operator|%
literal|10000
expr_stmt|;
block|}
name|DISPLAY
argument_list|(
literal|"Seed = %u\n"
argument_list|,
name|seed
argument_list|)
expr_stmt|;
if|if
condition|(
name|proba
operator|!=
name|FUZ_compressibility_default
condition|)
name|DISPLAY
argument_list|(
literal|"Compressibility : %u%%\n"
argument_list|,
name|proba
argument_list|)
expr_stmt|;
if|if
condition|(
name|nbTests
operator|<
name|testNb
condition|)
name|nbTests
operator|=
name|testNb
expr_stmt|;
if|if
condition|(
name|testNb
operator|==
literal|0
condition|)
name|result
operator|=
name|basicUnitTests
argument_list|(
literal|0
argument_list|,
operator|(
operator|(
name|double
operator|)
name|proba
operator|)
operator|/
literal|100
argument_list|)
expr_stmt|;
comment|/* constant seed for predictability */
if|if
condition|(
operator|!
name|result
condition|)
name|result
operator|=
name|fuzzerTests
argument_list|(
name|seed
argument_list|,
name|nbTests
argument_list|,
name|testNb
argument_list|,
name|maxDuration
argument_list|,
operator|(
operator|(
name|double
operator|)
name|proba
operator|)
operator|/
literal|100
argument_list|)
expr_stmt|;
if|if
condition|(
name|mainPause
condition|)
block|{
name|int
name|unused
decl_stmt|;
name|DISPLAY
argument_list|(
literal|"Press Enter \n"
argument_list|)
expr_stmt|;
name|unused
operator|=
name|getchar
argument_list|()
expr_stmt|;
operator|(
name|void
operator|)
name|unused
expr_stmt|;
block|}
return|return
name|result
return|;
block|}
end_function

end_unit


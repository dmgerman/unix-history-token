begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*-  * Copyright (c) 2014 Spectra Logic Corporation. All rights reserved.  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions  * are met:  * 1. Redistributions of source code must retain the above copyright  *    notice, this list of conditions and the following disclaimer.  * 2. Redistributions in binary form must reproduce the above copyright  *    notice, this list of conditions and the following disclaimer in the  *    documentation and/or other materials provided with the distribution.  *  * THIS SOFTWARE IS PROVIDED BY AUTHOR AND CONTRIBUTORS ``AS IS'' AND  * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE  * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE  * ARE DISCLAIMED.  IN NO EVENT SHALL AUTHOR OR CONTRIBUTORS BE LIABLE  * FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL  * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS  * OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)  * HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT  * LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY  * OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF  * SUCH DAMAGE.  */
end_comment

begin_include
include|#
directive|include
file|<sys/cdefs.h>
end_include

begin_expr_stmt
name|__FBSDID
argument_list|(
literal|"$FreeBSD$"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_include
include|#
directive|include
file|<errno.h>
end_include

begin_include
include|#
directive|include
file|<fcntl.h>
end_include

begin_include
include|#
directive|include
file|<pthread.h>
end_include

begin_include
include|#
directive|include
file|<signal.h>
end_include

begin_include
include|#
directive|include
file|<sys/socket.h>
end_include

begin_include
include|#
directive|include
file|<sys/un.h>
end_include

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_include
include|#
directive|include
file|<atf-c.h>
end_include

begin_comment
comment|/*  * Helper functions  */
end_comment

begin_define
define|#
directive|define
name|MIN
parameter_list|(
name|x
parameter_list|,
name|y
parameter_list|)
value|((x)< (y) ? (x) : (y))
end_define

begin_define
define|#
directive|define
name|MAX
parameter_list|(
name|x
parameter_list|,
name|y
parameter_list|)
value|((x)> (y) ? (x) : (y))
end_define

begin_function
specifier|static
name|void
name|do_socketpair
parameter_list|(
name|int
modifier|*
name|sv
parameter_list|)
block|{
name|int
name|s
decl_stmt|;
name|s
operator|=
name|socketpair
argument_list|(
name|PF_LOCAL
argument_list|,
name|SOCK_SEQPACKET
argument_list|,
literal|0
argument_list|,
name|sv
argument_list|)
expr_stmt|;
name|ATF_REQUIRE_EQ
argument_list|(
literal|0
argument_list|,
name|s
argument_list|)
expr_stmt|;
name|ATF_REQUIRE
argument_list|(
name|sv
index|[
literal|0
index|]
operator|>=
literal|0
argument_list|)
expr_stmt|;
name|ATF_REQUIRE
argument_list|(
name|sv
index|[
literal|1
index|]
operator|>=
literal|0
argument_list|)
expr_stmt|;
name|ATF_REQUIRE
argument_list|(
name|sv
index|[
literal|0
index|]
operator|!=
name|sv
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|do_socketpair_nonblocking
parameter_list|(
name|int
modifier|*
name|sv
parameter_list|)
block|{
name|int
name|s
decl_stmt|;
name|s
operator|=
name|socketpair
argument_list|(
name|PF_LOCAL
argument_list|,
name|SOCK_SEQPACKET
argument_list|,
literal|0
argument_list|,
name|sv
argument_list|)
expr_stmt|;
name|ATF_REQUIRE_EQ
argument_list|(
literal|0
argument_list|,
name|s
argument_list|)
expr_stmt|;
name|ATF_REQUIRE
argument_list|(
name|sv
index|[
literal|0
index|]
operator|>=
literal|0
argument_list|)
expr_stmt|;
name|ATF_REQUIRE
argument_list|(
name|sv
index|[
literal|1
index|]
operator|>=
literal|0
argument_list|)
expr_stmt|;
name|ATF_REQUIRE
argument_list|(
name|sv
index|[
literal|0
index|]
operator|!=
name|sv
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
name|ATF_REQUIRE
argument_list|(
operator|-
literal|1
operator|!=
name|fcntl
argument_list|(
name|sv
index|[
literal|0
index|]
argument_list|,
name|F_SETFL
argument_list|,
name|O_NONBLOCK
argument_list|)
argument_list|)
expr_stmt|;
name|ATF_REQUIRE
argument_list|(
operator|-
literal|1
operator|!=
name|fcntl
argument_list|(
name|sv
index|[
literal|1
index|]
argument_list|,
name|F_SETFL
argument_list|,
name|O_NONBLOCK
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * Returns a pair of sockets made the hard way: bind, listen, connect& accept  * @return	const char* The path to the socket  */
end_comment

begin_function
specifier|static
specifier|const
name|char
modifier|*
name|mk_pair_of_sockets
parameter_list|(
name|int
modifier|*
name|sv
parameter_list|)
block|{
name|struct
name|sockaddr_un
name|sun
decl_stmt|;
comment|/* ATF's isolation mechanisms will guarantee uniqueness of this file */
specifier|const
name|char
modifier|*
name|path
init|=
literal|"sock"
decl_stmt|;
name|int
name|s
decl_stmt|,
name|err
decl_stmt|,
name|s2
decl_stmt|,
name|s1
decl_stmt|;
name|s
operator|=
name|socket
argument_list|(
name|PF_LOCAL
argument_list|,
name|SOCK_SEQPACKET
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|ATF_REQUIRE
argument_list|(
name|s
operator|>=
literal|0
argument_list|)
expr_stmt|;
name|bzero
argument_list|(
operator|&
name|sun
argument_list|,
sizeof|sizeof
argument_list|(
name|sun
argument_list|)
argument_list|)
expr_stmt|;
name|sun
operator|.
name|sun_family
operator|=
name|AF_LOCAL
expr_stmt|;
name|sun
operator|.
name|sun_len
operator|=
sizeof|sizeof
argument_list|(
name|sun
argument_list|)
expr_stmt|;
name|strlcpy
argument_list|(
name|sun
operator|.
name|sun_path
argument_list|,
name|path
argument_list|,
sizeof|sizeof
argument_list|(
name|sun
operator|.
name|sun_path
argument_list|)
argument_list|)
expr_stmt|;
name|err
operator|=
name|bind
argument_list|(
name|s
argument_list|,
operator|(
expr|struct
name|sockaddr
operator|*
operator|)
operator|&
name|sun
argument_list|,
sizeof|sizeof
argument_list|(
name|sun
argument_list|)
argument_list|)
expr_stmt|;
name|err
operator|=
name|listen
argument_list|(
name|s
argument_list|,
operator|-
literal|1
argument_list|)
expr_stmt|;
name|ATF_CHECK_EQ
argument_list|(
literal|0
argument_list|,
name|err
argument_list|)
expr_stmt|;
comment|/* Create the other socket */
name|s2
operator|=
name|socket
argument_list|(
name|PF_LOCAL
argument_list|,
name|SOCK_SEQPACKET
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|ATF_REQUIRE
argument_list|(
name|s2
operator|>=
literal|0
argument_list|)
expr_stmt|;
name|err
operator|=
name|connect
argument_list|(
name|s2
argument_list|,
operator|(
expr|struct
name|sockaddr
operator|*
operator|)
operator|&
name|sun
argument_list|,
sizeof|sizeof
argument_list|(
name|sun
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
operator|!=
literal|0
condition|)
block|{
name|perror
argument_list|(
literal|"connect"
argument_list|)
expr_stmt|;
name|atf_tc_fail
argument_list|(
literal|"connect(2) failed"
argument_list|)
expr_stmt|;
block|}
comment|/* Accept it */
name|s1
operator|=
name|accept
argument_list|(
name|s
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|s1
operator|==
operator|-
literal|1
condition|)
block|{
name|perror
argument_list|(
literal|"accept"
argument_list|)
expr_stmt|;
name|atf_tc_fail
argument_list|(
literal|"accept(2) failed"
argument_list|)
expr_stmt|;
block|}
name|sv
index|[
literal|0
index|]
operator|=
name|s1
expr_stmt|;
name|sv
index|[
literal|1
index|]
operator|=
name|s2
expr_stmt|;
name|close
argument_list|(
name|s
argument_list|)
expr_stmt|;
return|return
operator|(
name|path
operator|)
return|;
block|}
end_function

begin_decl_stmt
specifier|static
specifier|volatile
name|sig_atomic_t
name|got_sigpipe
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_function
specifier|static
name|void
name|shutdown_send_sigpipe_handler
parameter_list|(
name|int
name|__unused
name|x
parameter_list|)
block|{
name|got_sigpipe
operator|=
literal|1
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * Parameterized test function bodies  */
end_comment

begin_function
specifier|static
name|void
name|test_eagain
parameter_list|(
name|int
name|sndbufsize
parameter_list|,
name|int
name|rcvbufsize
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
name|int
name|sv
index|[
literal|2
index|]
decl_stmt|;
specifier|const
name|size_t
name|totalsize
init|=
operator|(
name|sndbufsize
operator|+
name|rcvbufsize
operator|)
operator|*
literal|2
decl_stmt|;
specifier|const
name|size_t
name|pktsize
init|=
name|MIN
argument_list|(
name|sndbufsize
argument_list|,
name|rcvbufsize
argument_list|)
operator|/
literal|4
decl_stmt|;
specifier|const
name|int
name|numpkts
init|=
name|totalsize
operator|/
name|pktsize
decl_stmt|;
name|char
name|sndbuf
index|[
name|pktsize
index|]
decl_stmt|;
name|ssize_t
name|ssize
decl_stmt|;
comment|/* setup the socket pair */
name|do_socketpair_nonblocking
argument_list|(
name|sv
argument_list|)
expr_stmt|;
comment|/* Setup the buffers */
name|ATF_REQUIRE_EQ
argument_list|(
literal|0
argument_list|,
name|setsockopt
argument_list|(
name|sv
index|[
literal|0
index|]
argument_list|,
name|SOL_SOCKET
argument_list|,
name|SO_SNDBUF
argument_list|,
operator|&
name|sndbufsize
argument_list|,
sizeof|sizeof
argument_list|(
name|sndbufsize
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
name|ATF_REQUIRE_EQ
argument_list|(
literal|0
argument_list|,
name|setsockopt
argument_list|(
name|sv
index|[
literal|1
index|]
argument_list|,
name|SOL_SOCKET
argument_list|,
name|SO_RCVBUF
argument_list|,
operator|&
name|rcvbufsize
argument_list|,
sizeof|sizeof
argument_list|(
name|rcvbufsize
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
name|bzero
argument_list|(
name|sndbuf
argument_list|,
name|pktsize
argument_list|)
expr_stmt|;
comment|/* Send data until we get EAGAIN */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|numpkts
condition|;
name|i
operator|++
control|)
block|{
name|ssize
operator|=
name|send
argument_list|(
name|sv
index|[
literal|0
index|]
argument_list|,
name|sndbuf
argument_list|,
name|pktsize
argument_list|,
name|MSG_EOR
argument_list|)
expr_stmt|;
if|if
condition|(
name|ssize
operator|==
operator|-
literal|1
condition|)
block|{
if|if
condition|(
name|errno
operator|==
name|EAGAIN
condition|)
block|{
name|close
argument_list|(
name|sv
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
name|close
argument_list|(
name|sv
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
name|atf_tc_pass
argument_list|()
expr_stmt|;
block|}
else|else
block|{
name|perror
argument_list|(
literal|"send"
argument_list|)
expr_stmt|;
name|atf_tc_fail
argument_list|(
literal|"send returned< 0 but not EAGAIN"
argument_list|)
expr_stmt|;
block|}
block|}
block|}
name|atf_tc_fail
argument_list|(
literal|"Never got EAGAIN"
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|test_sendrecv_symmetric_buffers
parameter_list|(
name|int
name|bufsize
parameter_list|,
name|int
name|blocking
parameter_list|)
block|{
name|int
name|s
decl_stmt|;
name|int
name|sv
index|[
literal|2
index|]
decl_stmt|;
specifier|const
name|ssize_t
name|pktsize
init|=
name|bufsize
operator|/
literal|2
decl_stmt|;
name|char
name|sndbuf
index|[
name|pktsize
index|]
decl_stmt|;
name|char
name|recv_buf
index|[
name|pktsize
index|]
decl_stmt|;
name|ssize_t
name|ssize
decl_stmt|,
name|rsize
decl_stmt|;
comment|/* setup the socket pair */
if|if
condition|(
name|blocking
condition|)
name|do_socketpair
argument_list|(
name|sv
argument_list|)
expr_stmt|;
else|else
name|do_socketpair_nonblocking
argument_list|(
name|sv
argument_list|)
expr_stmt|;
comment|/* Setup the buffers */
name|s
operator|=
name|setsockopt
argument_list|(
name|sv
index|[
literal|0
index|]
argument_list|,
name|SOL_SOCKET
argument_list|,
name|SO_SNDBUF
argument_list|,
operator|&
name|bufsize
argument_list|,
sizeof|sizeof
argument_list|(
name|bufsize
argument_list|)
argument_list|)
expr_stmt|;
name|ATF_REQUIRE_EQ
argument_list|(
literal|0
argument_list|,
name|s
argument_list|)
expr_stmt|;
name|s
operator|=
name|setsockopt
argument_list|(
name|sv
index|[
literal|1
index|]
argument_list|,
name|SOL_SOCKET
argument_list|,
name|SO_RCVBUF
argument_list|,
operator|&
name|bufsize
argument_list|,
sizeof|sizeof
argument_list|(
name|bufsize
argument_list|)
argument_list|)
expr_stmt|;
name|ATF_REQUIRE_EQ
argument_list|(
literal|0
argument_list|,
name|s
argument_list|)
expr_stmt|;
comment|/* Fill the send buffer */
name|bzero
argument_list|(
name|sndbuf
argument_list|,
name|pktsize
argument_list|)
expr_stmt|;
comment|/* send and receive the packet */
name|ssize
operator|=
name|send
argument_list|(
name|sv
index|[
literal|0
index|]
argument_list|,
name|sndbuf
argument_list|,
name|pktsize
argument_list|,
name|MSG_EOR
argument_list|)
expr_stmt|;
if|if
condition|(
name|ssize
operator|<
literal|0
condition|)
block|{
name|perror
argument_list|(
literal|"send"
argument_list|)
expr_stmt|;
name|atf_tc_fail
argument_list|(
literal|"send returned< 0"
argument_list|)
expr_stmt|;
block|}
name|ATF_CHECK_EQ_MSG
argument_list|(
name|pktsize
argument_list|,
name|ssize
argument_list|,
literal|"expected %zd=send(...) but got %zd"
argument_list|,
name|pktsize
argument_list|,
name|ssize
argument_list|)
expr_stmt|;
name|rsize
operator|=
name|recv
argument_list|(
name|sv
index|[
literal|1
index|]
argument_list|,
name|recv_buf
argument_list|,
name|pktsize
argument_list|,
name|MSG_WAITALL
argument_list|)
expr_stmt|;
if|if
condition|(
name|rsize
operator|<
literal|0
condition|)
block|{
name|perror
argument_list|(
literal|"recv"
argument_list|)
expr_stmt|;
name|atf_tc_fail
argument_list|(
literal|"recv returned< 0"
argument_list|)
expr_stmt|;
block|}
name|ATF_CHECK_EQ_MSG
argument_list|(
name|pktsize
argument_list|,
name|rsize
argument_list|,
literal|"expected %zd=send(...) but got %zd"
argument_list|,
name|pktsize
argument_list|,
name|rsize
argument_list|)
expr_stmt|;
name|close
argument_list|(
name|sv
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
name|close
argument_list|(
name|sv
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|test_pipe_simulator
parameter_list|(
name|int
name|sndbufsize
parameter_list|,
name|int
name|rcvbufsize
parameter_list|)
block|{
name|int
name|num_sent
decl_stmt|,
name|num_received
decl_stmt|;
name|int
name|sv
index|[
literal|2
index|]
decl_stmt|;
specifier|const
name|ssize_t
name|pktsize
init|=
name|MIN
argument_list|(
name|sndbufsize
argument_list|,
name|rcvbufsize
argument_list|)
operator|/
literal|4
decl_stmt|;
name|int
name|numpkts
decl_stmt|;
name|char
name|sndbuf
index|[
name|pktsize
index|]
decl_stmt|;
name|char
name|rcvbuf
index|[
name|pktsize
index|]
decl_stmt|;
name|char
name|comparebuf
index|[
name|pktsize
index|]
decl_stmt|;
name|ssize_t
name|ssize
decl_stmt|,
name|rsize
decl_stmt|;
name|bool
name|currently_sending
init|=
name|true
decl_stmt|;
comment|/* setup the socket pair */
name|do_socketpair_nonblocking
argument_list|(
name|sv
argument_list|)
expr_stmt|;
comment|/* Setup the buffers */
name|ATF_REQUIRE_EQ
argument_list|(
literal|0
argument_list|,
name|setsockopt
argument_list|(
name|sv
index|[
literal|0
index|]
argument_list|,
name|SOL_SOCKET
argument_list|,
name|SO_SNDBUF
argument_list|,
operator|&
name|sndbufsize
argument_list|,
sizeof|sizeof
argument_list|(
name|sndbufsize
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
name|ATF_REQUIRE_EQ
argument_list|(
literal|0
argument_list|,
name|setsockopt
argument_list|(
name|sv
index|[
literal|1
index|]
argument_list|,
name|SOL_SOCKET
argument_list|,
name|SO_RCVBUF
argument_list|,
operator|&
name|rcvbufsize
argument_list|,
sizeof|sizeof
argument_list|(
name|rcvbufsize
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
comment|/* Send a total amount of data comfortably greater than the buffers */
name|numpkts
operator|=
name|MAX
argument_list|(
name|sndbufsize
argument_list|,
name|rcvbufsize
argument_list|)
operator|*
literal|8
operator|/
name|pktsize
expr_stmt|;
for|for
control|(
name|num_sent
operator|=
literal|0
operator|,
name|num_received
operator|=
literal|0
init|;
name|num_sent
operator|<
name|numpkts
operator|||
name|num_received
operator|<
name|numpkts
condition|;
control|)
block|{
if|if
condition|(
name|currently_sending
operator|&&
name|num_sent
operator|<
name|numpkts
condition|)
block|{
comment|/* The simulated sending process */
comment|/* fill the buffer */
name|memset
argument_list|(
name|sndbuf
argument_list|,
name|num_sent
argument_list|,
name|pktsize
argument_list|)
expr_stmt|;
name|ssize
operator|=
name|send
argument_list|(
name|sv
index|[
literal|0
index|]
argument_list|,
name|sndbuf
argument_list|,
name|pktsize
argument_list|,
name|MSG_EOR
argument_list|)
expr_stmt|;
if|if
condition|(
name|ssize
operator|<
literal|0
condition|)
block|{
comment|/* 				 * XXX: This is bug-compatible with the kernel. 				 * The kernel returns EMSGSIZE when it should 				 * return EAGAIN 				 */
if|if
condition|(
name|errno
operator|==
name|EAGAIN
operator|||
name|errno
operator|==
name|EMSGSIZE
condition|)
name|currently_sending
operator|=
name|false
expr_stmt|;
else|else
block|{
name|perror
argument_list|(
literal|"send"
argument_list|)
expr_stmt|;
name|atf_tc_fail
argument_list|(
literal|"send failed"
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
name|ATF_CHECK_EQ_MSG
argument_list|(
name|pktsize
argument_list|,
name|ssize
argument_list|,
literal|"expected %zd=send(...) but got %zd"
argument_list|,
name|pktsize
argument_list|,
name|ssize
argument_list|)
expr_stmt|;
name|num_sent
operator|++
expr_stmt|;
block|}
block|}
else|else
block|{
comment|/* The simulated receiving process */
name|rsize
operator|=
name|recv
argument_list|(
name|sv
index|[
literal|1
index|]
argument_list|,
name|rcvbuf
argument_list|,
name|pktsize
argument_list|,
name|MSG_WAITALL
argument_list|)
expr_stmt|;
if|if
condition|(
name|rsize
operator|<
literal|0
condition|)
block|{
if|if
condition|(
name|errno
operator|==
name|EAGAIN
condition|)
block|{
name|currently_sending
operator|=
name|true
expr_stmt|;
name|ATF_REQUIRE_MSG
argument_list|(
name|num_sent
operator|<
name|numpkts
argument_list|,
literal|"Packets were lost!"
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|perror
argument_list|(
literal|"recv"
argument_list|)
expr_stmt|;
name|atf_tc_fail
argument_list|(
literal|"recv failed"
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
name|ATF_CHECK_EQ_MSG
argument_list|(
name|pktsize
argument_list|,
name|rsize
argument_list|,
literal|"expected %zd=recv(...) but got %zd"
argument_list|,
name|pktsize
argument_list|,
name|rsize
argument_list|)
expr_stmt|;
name|memset
argument_list|(
name|comparebuf
argument_list|,
name|num_received
argument_list|,
name|pktsize
argument_list|)
expr_stmt|;
name|ATF_CHECK_EQ_MSG
argument_list|(
literal|0
argument_list|,
name|memcmp
argument_list|(
name|comparebuf
argument_list|,
name|rcvbuf
argument_list|,
name|pktsize
argument_list|)
argument_list|,
literal|"Received data miscompare"
argument_list|)
expr_stmt|;
name|num_received
operator|++
expr_stmt|;
block|}
block|}
block|}
name|close
argument_list|(
name|sv
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
name|close
argument_list|(
name|sv
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
block|}
end_function

begin_typedef
typedef|typedef
struct|struct
block|{
name|ssize_t
name|pktsize
decl_stmt|;
name|int
name|numpkts
decl_stmt|;
name|int
name|so
decl_stmt|;
block|}
name|test_pipe_thread_data_t
typedef|;
end_typedef

begin_function
specifier|static
name|void
modifier|*
name|test_pipe_writer
parameter_list|(
name|void
modifier|*
name|args
parameter_list|)
block|{
name|test_pipe_thread_data_t
modifier|*
name|td
init|=
name|args
decl_stmt|;
name|char
name|sndbuf
index|[
name|td
operator|->
name|pktsize
index|]
decl_stmt|;
name|ssize_t
name|ssize
decl_stmt|;
name|int
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|td
operator|->
name|numpkts
condition|;
name|i
operator|++
control|)
block|{
name|memset
argument_list|(
name|sndbuf
argument_list|,
name|i
argument_list|,
name|td
operator|->
name|pktsize
argument_list|)
expr_stmt|;
name|ssize
operator|=
name|send
argument_list|(
name|td
operator|->
name|so
argument_list|,
name|sndbuf
argument_list|,
name|td
operator|->
name|pktsize
argument_list|,
name|MSG_EOR
argument_list|)
expr_stmt|;
if|if
condition|(
name|ssize
operator|<
literal|0
condition|)
block|{
name|perror
argument_list|(
literal|"send"
argument_list|)
expr_stmt|;
name|atf_tc_fail
argument_list|(
literal|"send returned< 0"
argument_list|)
expr_stmt|;
block|}
name|ATF_CHECK_EQ_MSG
argument_list|(
name|td
operator|->
name|pktsize
argument_list|,
name|ssize
argument_list|,
literal|"expected %zd=send(...) but got %zd"
argument_list|,
name|td
operator|->
name|pktsize
argument_list|,
name|ssize
argument_list|)
expr_stmt|;
block|}
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
modifier|*
name|test_pipe_reader
parameter_list|(
name|void
modifier|*
name|args
parameter_list|)
block|{
name|test_pipe_thread_data_t
modifier|*
name|td
init|=
name|args
decl_stmt|;
name|char
name|rcvbuf
index|[
name|td
operator|->
name|pktsize
index|]
decl_stmt|;
name|char
name|comparebuf
index|[
name|td
operator|->
name|pktsize
index|]
decl_stmt|;
name|ssize_t
name|rsize
decl_stmt|;
name|int
name|i
decl_stmt|,
name|d
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|td
operator|->
name|numpkts
condition|;
name|i
operator|++
control|)
block|{
name|memset
argument_list|(
name|comparebuf
argument_list|,
name|i
argument_list|,
name|td
operator|->
name|pktsize
argument_list|)
expr_stmt|;
name|rsize
operator|=
name|recv
argument_list|(
name|td
operator|->
name|so
argument_list|,
name|rcvbuf
argument_list|,
name|td
operator|->
name|pktsize
argument_list|,
name|MSG_WAITALL
argument_list|)
expr_stmt|;
if|if
condition|(
name|rsize
operator|<
literal|0
condition|)
block|{
name|perror
argument_list|(
literal|"recv"
argument_list|)
expr_stmt|;
name|atf_tc_fail
argument_list|(
literal|"recv returned< 0"
argument_list|)
expr_stmt|;
block|}
name|ATF_CHECK_EQ_MSG
argument_list|(
name|td
operator|->
name|pktsize
argument_list|,
name|rsize
argument_list|,
literal|"expected %zd=send(...) but got %zd"
argument_list|,
name|td
operator|->
name|pktsize
argument_list|,
name|rsize
argument_list|)
expr_stmt|;
name|d
operator|=
name|memcmp
argument_list|(
name|comparebuf
argument_list|,
name|rcvbuf
argument_list|,
name|td
operator|->
name|pktsize
argument_list|)
expr_stmt|;
name|ATF_CHECK_EQ_MSG
argument_list|(
literal|0
argument_list|,
name|d
argument_list|,
literal|"Received data miscompare on packet %d"
argument_list|,
name|i
argument_list|)
expr_stmt|;
block|}
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|test_pipe
parameter_list|(
name|int
name|sndbufsize
parameter_list|,
name|int
name|rcvbufsize
parameter_list|)
block|{
name|test_pipe_thread_data_t
name|writer_data
decl_stmt|,
name|reader_data
decl_stmt|;
name|pthread_t
name|writer
decl_stmt|,
name|reader
decl_stmt|;
name|int
name|sv
index|[
literal|2
index|]
decl_stmt|;
specifier|const
name|size_t
name|pktsize
init|=
name|MIN
argument_list|(
name|sndbufsize
argument_list|,
name|rcvbufsize
argument_list|)
operator|/
literal|4
decl_stmt|;
name|int
name|numpkts
decl_stmt|;
comment|/* setup the socket pair */
name|do_socketpair
argument_list|(
name|sv
argument_list|)
expr_stmt|;
comment|/* Setup the buffers */
name|ATF_REQUIRE_EQ
argument_list|(
literal|0
argument_list|,
name|setsockopt
argument_list|(
name|sv
index|[
literal|0
index|]
argument_list|,
name|SOL_SOCKET
argument_list|,
name|SO_SNDBUF
argument_list|,
operator|&
name|sndbufsize
argument_list|,
sizeof|sizeof
argument_list|(
name|sndbufsize
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
name|ATF_REQUIRE_EQ
argument_list|(
literal|0
argument_list|,
name|setsockopt
argument_list|(
name|sv
index|[
literal|1
index|]
argument_list|,
name|SOL_SOCKET
argument_list|,
name|SO_RCVBUF
argument_list|,
operator|&
name|rcvbufsize
argument_list|,
sizeof|sizeof
argument_list|(
name|rcvbufsize
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
comment|/* Send a total amount of data comfortably greater than the buffers */
name|numpkts
operator|=
name|MAX
argument_list|(
name|sndbufsize
argument_list|,
name|rcvbufsize
argument_list|)
operator|*
literal|8
operator|/
name|pktsize
expr_stmt|;
comment|/* Start the child threads */
name|writer_data
operator|.
name|pktsize
operator|=
name|pktsize
expr_stmt|;
name|writer_data
operator|.
name|numpkts
operator|=
name|numpkts
expr_stmt|;
name|writer_data
operator|.
name|so
operator|=
name|sv
index|[
literal|0
index|]
expr_stmt|;
name|reader_data
operator|.
name|pktsize
operator|=
name|pktsize
expr_stmt|;
name|reader_data
operator|.
name|numpkts
operator|=
name|numpkts
expr_stmt|;
name|reader_data
operator|.
name|so
operator|=
name|sv
index|[
literal|1
index|]
expr_stmt|;
name|ATF_REQUIRE_EQ
argument_list|(
literal|0
argument_list|,
name|pthread_create
argument_list|(
operator|&
name|writer
argument_list|,
name|NULL
argument_list|,
name|test_pipe_writer
argument_list|,
operator|(
name|void
operator|*
operator|)
operator|&
name|writer_data
argument_list|)
argument_list|)
expr_stmt|;
comment|/* 	 * Give the writer time to start writing, and hopefully block, before 	 * starting the reader.  This increases the likelihood of the test case 	 * failing due to PR kern/185812 	 */
name|usleep
argument_list|(
literal|1000
argument_list|)
expr_stmt|;
name|ATF_REQUIRE_EQ
argument_list|(
literal|0
argument_list|,
name|pthread_create
argument_list|(
operator|&
name|reader
argument_list|,
name|NULL
argument_list|,
name|test_pipe_reader
argument_list|,
operator|(
name|void
operator|*
operator|)
operator|&
name|reader_data
argument_list|)
argument_list|)
expr_stmt|;
comment|/* Join the children */
name|ATF_REQUIRE_EQ
argument_list|(
literal|0
argument_list|,
name|pthread_join
argument_list|(
name|writer
argument_list|,
name|NULL
argument_list|)
argument_list|)
expr_stmt|;
name|ATF_REQUIRE_EQ
argument_list|(
literal|0
argument_list|,
name|pthread_join
argument_list|(
name|reader
argument_list|,
name|NULL
argument_list|)
argument_list|)
expr_stmt|;
name|close
argument_list|(
name|sv
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
name|close
argument_list|(
name|sv
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * Test Cases  */
end_comment

begin_comment
comment|/* Create a SEQPACKET socket */
end_comment

begin_expr_stmt
name|ATF_TC_WITHOUT_HEAD
argument_list|(
name|create_socket
argument_list|)
expr_stmt|;
end_expr_stmt

begin_macro
name|ATF_TC_BODY
argument_list|(
argument|create_socket
argument_list|,
argument|tc
argument_list|)
end_macro

begin_block
block|{
name|int
name|s
decl_stmt|;
name|s
operator|=
name|socket
argument_list|(
name|PF_LOCAL
argument_list|,
name|SOCK_SEQPACKET
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|ATF_REQUIRE
argument_list|(
name|s
operator|>=
literal|0
argument_list|)
expr_stmt|;
name|close
argument_list|(
name|s
argument_list|)
expr_stmt|;
block|}
end_block

begin_comment
comment|/* Create SEQPACKET sockets using socketpair(2) */
end_comment

begin_expr_stmt
name|ATF_TC_WITHOUT_HEAD
argument_list|(
name|create_socketpair
argument_list|)
expr_stmt|;
end_expr_stmt

begin_macro
name|ATF_TC_BODY
argument_list|(
argument|create_socketpair
argument_list|,
argument|tc
argument_list|)
end_macro

begin_block
block|{
name|int
name|sv
index|[
literal|2
index|]
decl_stmt|;
name|int
name|s
decl_stmt|;
name|s
operator|=
name|socketpair
argument_list|(
name|PF_LOCAL
argument_list|,
name|SOCK_SEQPACKET
argument_list|,
literal|0
argument_list|,
name|sv
argument_list|)
expr_stmt|;
name|ATF_CHECK_EQ
argument_list|(
literal|0
argument_list|,
name|s
argument_list|)
expr_stmt|;
name|ATF_CHECK
argument_list|(
name|sv
index|[
literal|0
index|]
operator|>=
literal|0
argument_list|)
expr_stmt|;
name|ATF_CHECK
argument_list|(
name|sv
index|[
literal|1
index|]
operator|>=
literal|0
argument_list|)
expr_stmt|;
name|ATF_CHECK
argument_list|(
name|sv
index|[
literal|0
index|]
operator|!=
name|sv
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
name|close
argument_list|(
name|sv
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
name|close
argument_list|(
name|sv
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
block|}
end_block

begin_comment
comment|/* Call listen(2) without first calling bind(2).  It should fail */
end_comment

begin_expr_stmt
name|ATF_TC_WITHOUT_HEAD
argument_list|(
name|listen_unbound
argument_list|)
expr_stmt|;
end_expr_stmt

begin_macro
name|ATF_TC_BODY
argument_list|(
argument|listen_unbound
argument_list|,
argument|tc
argument_list|)
end_macro

begin_block
block|{
name|int
name|s
decl_stmt|,
name|r
decl_stmt|;
name|s
operator|=
name|socket
argument_list|(
name|PF_LOCAL
argument_list|,
name|SOCK_SEQPACKET
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|ATF_REQUIRE
argument_list|(
name|s
operator|>
literal|0
argument_list|)
expr_stmt|;
name|r
operator|=
name|listen
argument_list|(
name|s
argument_list|,
operator|-
literal|1
argument_list|)
expr_stmt|;
comment|/* expect listen to fail since we haven't called bind(2) */
name|ATF_CHECK
argument_list|(
name|r
operator|!=
literal|0
argument_list|)
expr_stmt|;
name|close
argument_list|(
name|s
argument_list|)
expr_stmt|;
block|}
end_block

begin_comment
comment|/* Bind the socket to a file */
end_comment

begin_expr_stmt
name|ATF_TC_WITHOUT_HEAD
argument_list|(
name|bind
argument_list|)
expr_stmt|;
end_expr_stmt

begin_macro
name|ATF_TC_BODY
argument_list|(
argument|bind
argument_list|,
argument|tc
argument_list|)
end_macro

begin_block
block|{
name|struct
name|sockaddr_un
name|sun
decl_stmt|;
comment|/* ATF's isolation mechanisms will guarantee uniqueness of this file */
specifier|const
name|char
modifier|*
name|path
init|=
literal|"sock"
decl_stmt|;
name|int
name|s
decl_stmt|,
name|r
decl_stmt|;
name|s
operator|=
name|socket
argument_list|(
name|PF_LOCAL
argument_list|,
name|SOCK_SEQPACKET
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|ATF_REQUIRE
argument_list|(
name|s
operator|>=
literal|0
argument_list|)
expr_stmt|;
name|bzero
argument_list|(
operator|&
name|sun
argument_list|,
sizeof|sizeof
argument_list|(
name|sun
argument_list|)
argument_list|)
expr_stmt|;
name|sun
operator|.
name|sun_family
operator|=
name|AF_LOCAL
expr_stmt|;
name|sun
operator|.
name|sun_len
operator|=
sizeof|sizeof
argument_list|(
name|sun
argument_list|)
expr_stmt|;
name|strlcpy
argument_list|(
name|sun
operator|.
name|sun_path
argument_list|,
name|path
argument_list|,
sizeof|sizeof
argument_list|(
name|sun
operator|.
name|sun_path
argument_list|)
argument_list|)
expr_stmt|;
name|r
operator|=
name|bind
argument_list|(
name|s
argument_list|,
operator|(
expr|struct
name|sockaddr
operator|*
operator|)
operator|&
name|sun
argument_list|,
sizeof|sizeof
argument_list|(
name|sun
argument_list|)
argument_list|)
expr_stmt|;
name|ATF_CHECK_EQ
argument_list|(
literal|0
argument_list|,
name|r
argument_list|)
expr_stmt|;
name|close
argument_list|(
name|s
argument_list|)
expr_stmt|;
block|}
end_block

begin_comment
comment|/* listen(2) a socket that is already bound(2) should succeed */
end_comment

begin_expr_stmt
name|ATF_TC_WITHOUT_HEAD
argument_list|(
name|listen_bound
argument_list|)
expr_stmt|;
end_expr_stmt

begin_macro
name|ATF_TC_BODY
argument_list|(
argument|listen_bound
argument_list|,
argument|tc
argument_list|)
end_macro

begin_block
block|{
name|struct
name|sockaddr_un
name|sun
decl_stmt|;
comment|/* ATF's isolation mechanisms will guarantee uniqueness of this file */
specifier|const
name|char
modifier|*
name|path
init|=
literal|"sock"
decl_stmt|;
name|int
name|s
decl_stmt|,
name|r
decl_stmt|,
name|l
decl_stmt|;
name|s
operator|=
name|socket
argument_list|(
name|PF_LOCAL
argument_list|,
name|SOCK_SEQPACKET
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|ATF_REQUIRE
argument_list|(
name|s
operator|>=
literal|0
argument_list|)
expr_stmt|;
name|bzero
argument_list|(
operator|&
name|sun
argument_list|,
sizeof|sizeof
argument_list|(
name|sun
argument_list|)
argument_list|)
expr_stmt|;
name|sun
operator|.
name|sun_family
operator|=
name|AF_LOCAL
expr_stmt|;
name|sun
operator|.
name|sun_len
operator|=
sizeof|sizeof
argument_list|(
name|sun
argument_list|)
expr_stmt|;
name|strlcpy
argument_list|(
name|sun
operator|.
name|sun_path
argument_list|,
name|path
argument_list|,
sizeof|sizeof
argument_list|(
name|sun
operator|.
name|sun_path
argument_list|)
argument_list|)
expr_stmt|;
name|r
operator|=
name|bind
argument_list|(
name|s
argument_list|,
operator|(
expr|struct
name|sockaddr
operator|*
operator|)
operator|&
name|sun
argument_list|,
sizeof|sizeof
argument_list|(
name|sun
argument_list|)
argument_list|)
expr_stmt|;
name|l
operator|=
name|listen
argument_list|(
name|s
argument_list|,
operator|-
literal|1
argument_list|)
expr_stmt|;
name|ATF_CHECK_EQ
argument_list|(
literal|0
argument_list|,
name|r
argument_list|)
expr_stmt|;
name|ATF_CHECK_EQ
argument_list|(
literal|0
argument_list|,
name|l
argument_list|)
expr_stmt|;
name|close
argument_list|(
name|s
argument_list|)
expr_stmt|;
block|}
end_block

begin_comment
comment|/* connect(2) can make a connection */
end_comment

begin_expr_stmt
name|ATF_TC_WITHOUT_HEAD
argument_list|(
name|connect
argument_list|)
expr_stmt|;
end_expr_stmt

begin_macro
name|ATF_TC_BODY
argument_list|(
argument|connect
argument_list|,
argument|tc
argument_list|)
end_macro

begin_block
block|{
name|struct
name|sockaddr_un
name|sun
decl_stmt|;
comment|/* ATF's isolation mechanisms will guarantee uniqueness of this file */
specifier|const
name|char
modifier|*
name|path
init|=
literal|"sock"
decl_stmt|;
name|int
name|s
decl_stmt|,
name|r
decl_stmt|,
name|err
decl_stmt|,
name|l
decl_stmt|,
name|s2
decl_stmt|;
name|s
operator|=
name|socket
argument_list|(
name|PF_LOCAL
argument_list|,
name|SOCK_SEQPACKET
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|ATF_REQUIRE
argument_list|(
name|s
operator|>=
literal|0
argument_list|)
expr_stmt|;
name|bzero
argument_list|(
operator|&
name|sun
argument_list|,
sizeof|sizeof
argument_list|(
name|sun
argument_list|)
argument_list|)
expr_stmt|;
name|sun
operator|.
name|sun_family
operator|=
name|AF_LOCAL
expr_stmt|;
name|sun
operator|.
name|sun_len
operator|=
sizeof|sizeof
argument_list|(
name|sun
argument_list|)
expr_stmt|;
name|strlcpy
argument_list|(
name|sun
operator|.
name|sun_path
argument_list|,
name|path
argument_list|,
sizeof|sizeof
argument_list|(
name|sun
operator|.
name|sun_path
argument_list|)
argument_list|)
expr_stmt|;
name|r
operator|=
name|bind
argument_list|(
name|s
argument_list|,
operator|(
expr|struct
name|sockaddr
operator|*
operator|)
operator|&
name|sun
argument_list|,
sizeof|sizeof
argument_list|(
name|sun
argument_list|)
argument_list|)
expr_stmt|;
name|l
operator|=
name|listen
argument_list|(
name|s
argument_list|,
operator|-
literal|1
argument_list|)
expr_stmt|;
name|ATF_CHECK_EQ
argument_list|(
literal|0
argument_list|,
name|r
argument_list|)
expr_stmt|;
name|ATF_CHECK_EQ
argument_list|(
literal|0
argument_list|,
name|l
argument_list|)
expr_stmt|;
comment|/* Create the other socket */
name|s2
operator|=
name|socket
argument_list|(
name|PF_LOCAL
argument_list|,
name|SOCK_SEQPACKET
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|ATF_REQUIRE
argument_list|(
name|s2
operator|>=
literal|0
argument_list|)
expr_stmt|;
name|err
operator|=
name|connect
argument_list|(
name|s2
argument_list|,
operator|(
expr|struct
name|sockaddr
operator|*
operator|)
operator|&
name|sun
argument_list|,
sizeof|sizeof
argument_list|(
name|sun
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
operator|!=
literal|0
condition|)
block|{
name|perror
argument_list|(
literal|"connect"
argument_list|)
expr_stmt|;
name|atf_tc_fail
argument_list|(
literal|"connect(2) failed"
argument_list|)
expr_stmt|;
block|}
name|close
argument_list|(
name|s
argument_list|)
expr_stmt|;
name|close
argument_list|(
name|s2
argument_list|)
expr_stmt|;
block|}
end_block

begin_comment
comment|/* accept(2) can receive a connection */
end_comment

begin_expr_stmt
name|ATF_TC_WITHOUT_HEAD
argument_list|(
name|accept
argument_list|)
expr_stmt|;
end_expr_stmt

begin_macro
name|ATF_TC_BODY
argument_list|(
argument|accept
argument_list|,
argument|tc
argument_list|)
end_macro

begin_block
block|{
name|int
name|sv
index|[
literal|2
index|]
decl_stmt|;
name|mk_pair_of_sockets
argument_list|(
name|sv
argument_list|)
expr_stmt|;
name|close
argument_list|(
name|sv
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
name|close
argument_list|(
name|sv
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
block|}
end_block

begin_comment
comment|/* Set O_NONBLOCK on the socket */
end_comment

begin_expr_stmt
name|ATF_TC_WITHOUT_HEAD
argument_list|(
name|fcntl_nonblock
argument_list|)
expr_stmt|;
end_expr_stmt

begin_macro
name|ATF_TC_BODY
argument_list|(
argument|fcntl_nonblock
argument_list|,
argument|tc
argument_list|)
end_macro

begin_block
block|{
name|int
name|s
decl_stmt|;
name|s
operator|=
name|socket
argument_list|(
name|PF_LOCAL
argument_list|,
name|SOCK_SEQPACKET
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|ATF_REQUIRE
argument_list|(
name|s
operator|>=
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|fcntl
argument_list|(
name|s
argument_list|,
name|F_SETFL
argument_list|,
name|O_NONBLOCK
argument_list|)
operator|==
operator|-
literal|1
condition|)
block|{
name|perror
argument_list|(
literal|"fcntl"
argument_list|)
expr_stmt|;
name|atf_tc_fail
argument_list|(
literal|"fcntl failed"
argument_list|)
expr_stmt|;
block|}
name|close
argument_list|(
name|s
argument_list|)
expr_stmt|;
block|}
end_block

begin_comment
comment|/* Resize the send and receive buffers */
end_comment

begin_expr_stmt
name|ATF_TC_WITHOUT_HEAD
argument_list|(
name|resize_buffers
argument_list|)
expr_stmt|;
end_expr_stmt

begin_macro
name|ATF_TC_BODY
argument_list|(
argument|resize_buffers
argument_list|,
argument|tc
argument_list|)
end_macro

begin_block
block|{
name|int
name|s
decl_stmt|;
name|int
name|sndbuf
init|=
literal|12345
decl_stmt|;
name|int
name|rcvbuf
init|=
literal|23456
decl_stmt|;
name|int
name|xs
decl_stmt|,
name|xr
decl_stmt|;
name|socklen_t
name|sl
init|=
sizeof|sizeof
argument_list|(
name|xs
argument_list|)
decl_stmt|;
name|s
operator|=
name|socket
argument_list|(
name|PF_LOCAL
argument_list|,
name|SOCK_SEQPACKET
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|ATF_REQUIRE
argument_list|(
name|s
operator|>=
literal|0
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"                       Socket Buffer Sizes\n"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"                              | SNDBUF  | RCVBUF  |\n"
argument_list|)
expr_stmt|;
name|ATF_CHECK_EQ
argument_list|(
literal|0
argument_list|,
name|getsockopt
argument_list|(
name|s
argument_list|,
name|SOL_SOCKET
argument_list|,
name|SO_SNDBUF
argument_list|,
operator|&
name|xs
argument_list|,
operator|&
name|sl
argument_list|)
argument_list|)
expr_stmt|;
name|ATF_CHECK_EQ
argument_list|(
literal|0
argument_list|,
name|getsockopt
argument_list|(
name|s
argument_list|,
name|SOL_SOCKET
argument_list|,
name|SO_RCVBUF
argument_list|,
operator|&
name|xr
argument_list|,
operator|&
name|sl
argument_list|)
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Default                       | %7d | %7d |\n"
argument_list|,
name|xs
argument_list|,
name|xr
argument_list|)
expr_stmt|;
if|if
condition|(
name|setsockopt
argument_list|(
name|s
argument_list|,
name|SOL_SOCKET
argument_list|,
name|SO_SNDBUF
argument_list|,
operator|&
name|sndbuf
argument_list|,
sizeof|sizeof
argument_list|(
name|sndbuf
argument_list|)
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|perror
argument_list|(
literal|"setsockopt"
argument_list|)
expr_stmt|;
name|atf_tc_fail
argument_list|(
literal|"setsockopt(SO_SNDBUF) failed"
argument_list|)
expr_stmt|;
block|}
name|ATF_CHECK_EQ
argument_list|(
literal|0
argument_list|,
name|getsockopt
argument_list|(
name|s
argument_list|,
name|SOL_SOCKET
argument_list|,
name|SO_SNDBUF
argument_list|,
operator|&
name|xs
argument_list|,
operator|&
name|sl
argument_list|)
argument_list|)
expr_stmt|;
name|ATF_CHECK_EQ
argument_list|(
literal|0
argument_list|,
name|getsockopt
argument_list|(
name|s
argument_list|,
name|SOL_SOCKET
argument_list|,
name|SO_RCVBUF
argument_list|,
operator|&
name|xr
argument_list|,
operator|&
name|sl
argument_list|)
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"After changing SNDBUF         | %7d | %7d |\n"
argument_list|,
name|xs
argument_list|,
name|xr
argument_list|)
expr_stmt|;
if|if
condition|(
name|setsockopt
argument_list|(
name|s
argument_list|,
name|SOL_SOCKET
argument_list|,
name|SO_RCVBUF
argument_list|,
operator|&
name|rcvbuf
argument_list|,
sizeof|sizeof
argument_list|(
name|rcvbuf
argument_list|)
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|perror
argument_list|(
literal|"setsockopt"
argument_list|)
expr_stmt|;
name|atf_tc_fail
argument_list|(
literal|"setsockopt(SO_RCVBUF) failed"
argument_list|)
expr_stmt|;
block|}
name|ATF_CHECK_EQ
argument_list|(
literal|0
argument_list|,
name|getsockopt
argument_list|(
name|s
argument_list|,
name|SOL_SOCKET
argument_list|,
name|SO_SNDBUF
argument_list|,
operator|&
name|xs
argument_list|,
operator|&
name|sl
argument_list|)
argument_list|)
expr_stmt|;
name|ATF_CHECK_EQ
argument_list|(
literal|0
argument_list|,
name|getsockopt
argument_list|(
name|s
argument_list|,
name|SOL_SOCKET
argument_list|,
name|SO_RCVBUF
argument_list|,
operator|&
name|xr
argument_list|,
operator|&
name|sl
argument_list|)
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"After changing RCVBUF         | %7d | %7d |\n"
argument_list|,
name|xs
argument_list|,
name|xr
argument_list|)
expr_stmt|;
name|close
argument_list|(
name|s
argument_list|)
expr_stmt|;
block|}
end_block

begin_comment
comment|/*  * Resize the send and receive buffers of a connected socketpair  * Print some useful debugging info too  */
end_comment

begin_expr_stmt
name|ATF_TC_WITHOUT_HEAD
argument_list|(
name|resize_connected_buffers
argument_list|)
expr_stmt|;
end_expr_stmt

begin_macro
name|ATF_TC_BODY
argument_list|(
argument|resize_connected_buffers
argument_list|,
argument|tc
argument_list|)
end_macro

begin_block
block|{
name|int
name|sv
index|[
literal|2
index|]
decl_stmt|;
name|int
name|sndbuf
init|=
literal|12345
decl_stmt|;
name|int
name|rcvbuf
init|=
literal|23456
decl_stmt|;
name|int
name|err
decl_stmt|;
name|int
name|ls
decl_stmt|,
name|lr
decl_stmt|,
name|rs
decl_stmt|,
name|rr
decl_stmt|;
name|socklen_t
name|sl
init|=
sizeof|sizeof
argument_list|(
name|ls
argument_list|)
decl_stmt|;
comment|/* setup the socket pair */
name|do_socketpair
argument_list|(
name|sv
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"                       Socket Buffer Sizes\n"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"                              | Left Socket       | Right Socket      |\n"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"                              | SNDBUF  | RCVBUF  | SNDBUF  | RCVBUF  |\n"
argument_list|)
expr_stmt|;
name|ATF_CHECK_EQ
argument_list|(
literal|0
argument_list|,
name|getsockopt
argument_list|(
name|sv
index|[
literal|0
index|]
argument_list|,
name|SOL_SOCKET
argument_list|,
name|SO_SNDBUF
argument_list|,
operator|&
name|ls
argument_list|,
operator|&
name|sl
argument_list|)
argument_list|)
expr_stmt|;
name|ATF_CHECK_EQ
argument_list|(
literal|0
argument_list|,
name|getsockopt
argument_list|(
name|sv
index|[
literal|0
index|]
argument_list|,
name|SOL_SOCKET
argument_list|,
name|SO_RCVBUF
argument_list|,
operator|&
name|lr
argument_list|,
operator|&
name|sl
argument_list|)
argument_list|)
expr_stmt|;
name|ATF_CHECK_EQ
argument_list|(
literal|0
argument_list|,
name|getsockopt
argument_list|(
name|sv
index|[
literal|1
index|]
argument_list|,
name|SOL_SOCKET
argument_list|,
name|SO_SNDBUF
argument_list|,
operator|&
name|rs
argument_list|,
operator|&
name|sl
argument_list|)
argument_list|)
expr_stmt|;
name|ATF_CHECK_EQ
argument_list|(
literal|0
argument_list|,
name|getsockopt
argument_list|(
name|sv
index|[
literal|1
index|]
argument_list|,
name|SOL_SOCKET
argument_list|,
name|SO_RCVBUF
argument_list|,
operator|&
name|rr
argument_list|,
operator|&
name|sl
argument_list|)
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Default                       | %7d | %7d | %7d | %7d |\n"
argument_list|,
name|ls
argument_list|,
name|lr
argument_list|,
name|rs
argument_list|,
name|rr
argument_list|)
expr_stmt|;
comment|/* Update one side's send buffer */
name|err
operator|=
name|setsockopt
argument_list|(
name|sv
index|[
literal|0
index|]
argument_list|,
name|SOL_SOCKET
argument_list|,
name|SO_SNDBUF
argument_list|,
operator|&
name|sndbuf
argument_list|,
sizeof|sizeof
argument_list|(
name|sndbuf
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
operator|!=
literal|0
condition|)
block|{
name|perror
argument_list|(
literal|"setsockopt"
argument_list|)
expr_stmt|;
name|atf_tc_fail
argument_list|(
literal|"setsockopt(SO_SNDBUF) failed"
argument_list|)
expr_stmt|;
block|}
name|ATF_CHECK_EQ
argument_list|(
literal|0
argument_list|,
name|getsockopt
argument_list|(
name|sv
index|[
literal|0
index|]
argument_list|,
name|SOL_SOCKET
argument_list|,
name|SO_SNDBUF
argument_list|,
operator|&
name|ls
argument_list|,
operator|&
name|sl
argument_list|)
argument_list|)
expr_stmt|;
name|ATF_CHECK_EQ
argument_list|(
literal|0
argument_list|,
name|getsockopt
argument_list|(
name|sv
index|[
literal|0
index|]
argument_list|,
name|SOL_SOCKET
argument_list|,
name|SO_RCVBUF
argument_list|,
operator|&
name|lr
argument_list|,
operator|&
name|sl
argument_list|)
argument_list|)
expr_stmt|;
name|ATF_CHECK_EQ
argument_list|(
literal|0
argument_list|,
name|getsockopt
argument_list|(
name|sv
index|[
literal|1
index|]
argument_list|,
name|SOL_SOCKET
argument_list|,
name|SO_SNDBUF
argument_list|,
operator|&
name|rs
argument_list|,
operator|&
name|sl
argument_list|)
argument_list|)
expr_stmt|;
name|ATF_CHECK_EQ
argument_list|(
literal|0
argument_list|,
name|getsockopt
argument_list|(
name|sv
index|[
literal|1
index|]
argument_list|,
name|SOL_SOCKET
argument_list|,
name|SO_RCVBUF
argument_list|,
operator|&
name|rr
argument_list|,
operator|&
name|sl
argument_list|)
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"After changing Left's SNDBUF  | %7d | %7d | %7d | %7d |\n"
argument_list|,
name|ls
argument_list|,
name|lr
argument_list|,
name|rs
argument_list|,
name|rr
argument_list|)
expr_stmt|;
comment|/* Update the same side's receive buffer */
name|err
operator|=
name|setsockopt
argument_list|(
name|sv
index|[
literal|0
index|]
argument_list|,
name|SOL_SOCKET
argument_list|,
name|SO_RCVBUF
argument_list|,
operator|&
name|rcvbuf
argument_list|,
sizeof|sizeof
argument_list|(
name|rcvbuf
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
operator|!=
literal|0
condition|)
block|{
name|perror
argument_list|(
literal|"setsockopt"
argument_list|)
expr_stmt|;
name|atf_tc_fail
argument_list|(
literal|"setsockopt(SO_RCVBUF) failed"
argument_list|)
expr_stmt|;
block|}
name|ATF_CHECK_EQ
argument_list|(
literal|0
argument_list|,
name|getsockopt
argument_list|(
name|sv
index|[
literal|0
index|]
argument_list|,
name|SOL_SOCKET
argument_list|,
name|SO_SNDBUF
argument_list|,
operator|&
name|ls
argument_list|,
operator|&
name|sl
argument_list|)
argument_list|)
expr_stmt|;
name|ATF_CHECK_EQ
argument_list|(
literal|0
argument_list|,
name|getsockopt
argument_list|(
name|sv
index|[
literal|0
index|]
argument_list|,
name|SOL_SOCKET
argument_list|,
name|SO_RCVBUF
argument_list|,
operator|&
name|lr
argument_list|,
operator|&
name|sl
argument_list|)
argument_list|)
expr_stmt|;
name|ATF_CHECK_EQ
argument_list|(
literal|0
argument_list|,
name|getsockopt
argument_list|(
name|sv
index|[
literal|1
index|]
argument_list|,
name|SOL_SOCKET
argument_list|,
name|SO_SNDBUF
argument_list|,
operator|&
name|rs
argument_list|,
operator|&
name|sl
argument_list|)
argument_list|)
expr_stmt|;
name|ATF_CHECK_EQ
argument_list|(
literal|0
argument_list|,
name|getsockopt
argument_list|(
name|sv
index|[
literal|1
index|]
argument_list|,
name|SOL_SOCKET
argument_list|,
name|SO_RCVBUF
argument_list|,
operator|&
name|rr
argument_list|,
operator|&
name|sl
argument_list|)
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"After changing Left's RCVBUF  | %7d | %7d | %7d | %7d |\n"
argument_list|,
name|ls
argument_list|,
name|lr
argument_list|,
name|rs
argument_list|,
name|rr
argument_list|)
expr_stmt|;
name|close
argument_list|(
name|sv
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
name|close
argument_list|(
name|sv
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
block|}
end_block

begin_comment
comment|/* send(2) and recv(2) a single short record */
end_comment

begin_expr_stmt
name|ATF_TC_WITHOUT_HEAD
argument_list|(
name|send_recv
argument_list|)
expr_stmt|;
end_expr_stmt

begin_macro
name|ATF_TC_BODY
argument_list|(
argument|send_recv
argument_list|,
argument|tc
argument_list|)
end_macro

begin_block
block|{
name|int
name|sv
index|[
literal|2
index|]
decl_stmt|;
specifier|const
name|int
name|bufsize
init|=
literal|64
decl_stmt|;
specifier|const
name|char
modifier|*
name|data
init|=
literal|"data"
decl_stmt|;
name|char
name|recv_buf
index|[
name|bufsize
index|]
decl_stmt|;
name|ssize_t
name|datalen
decl_stmt|;
name|ssize_t
name|ssize
decl_stmt|,
name|rsize
decl_stmt|;
comment|/* setup the socket pair */
name|do_socketpair
argument_list|(
name|sv
argument_list|)
expr_stmt|;
comment|/* send and receive a small packet */
name|datalen
operator|=
name|strlen
argument_list|(
name|data
argument_list|)
operator|+
literal|1
expr_stmt|;
comment|/* +1 for the null */
name|ssize
operator|=
name|send
argument_list|(
name|sv
index|[
literal|0
index|]
argument_list|,
name|data
argument_list|,
name|datalen
argument_list|,
name|MSG_EOR
argument_list|)
expr_stmt|;
if|if
condition|(
name|ssize
operator|<
literal|0
condition|)
block|{
name|perror
argument_list|(
literal|"send"
argument_list|)
expr_stmt|;
name|atf_tc_fail
argument_list|(
literal|"send returned< 0"
argument_list|)
expr_stmt|;
block|}
name|ATF_CHECK_EQ_MSG
argument_list|(
name|datalen
argument_list|,
name|ssize
argument_list|,
literal|"expected %zd=send(...) but got %zd"
argument_list|,
name|datalen
argument_list|,
name|ssize
argument_list|)
expr_stmt|;
name|rsize
operator|=
name|recv
argument_list|(
name|sv
index|[
literal|1
index|]
argument_list|,
name|recv_buf
argument_list|,
name|bufsize
argument_list|,
name|MSG_WAITALL
argument_list|)
expr_stmt|;
name|ATF_CHECK_EQ
argument_list|(
name|datalen
argument_list|,
name|rsize
argument_list|)
expr_stmt|;
name|close
argument_list|(
name|sv
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
name|close
argument_list|(
name|sv
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
block|}
end_block

begin_comment
comment|/* sendto(2) and recvfrom(2) a single short record  * According to The Open Group Base Specifications Issue 6 IEEE Std 1003.1, 2004  * Edition, sendto(2) is exactly the same as send(2) on a connection-mode socket  *  * According to the same spec, not all protocols are required to provide the  * source addres in recvfrom(2).  */
end_comment

begin_expr_stmt
name|ATF_TC_WITHOUT_HEAD
argument_list|(
name|sendto_recvfrom
argument_list|)
expr_stmt|;
end_expr_stmt

begin_macro
name|ATF_TC_BODY
argument_list|(
argument|sendto_recvfrom
argument_list|,
argument|tc
argument_list|)
end_macro

begin_block
block|{
ifdef|#
directive|ifdef
name|TEST_SEQ_PACKET_SOURCE_ADDRESS
specifier|const
name|char
modifier|*
name|path
decl_stmt|;
endif|#
directive|endif
name|struct
name|sockaddr_storage
name|from
decl_stmt|;
name|int
name|sv
index|[
literal|2
index|]
decl_stmt|;
specifier|const
name|int
name|bufsize
init|=
literal|64
decl_stmt|;
specifier|const
name|char
modifier|*
name|data
init|=
literal|"data"
decl_stmt|;
name|char
name|recv_buf
index|[
name|bufsize
index|]
decl_stmt|;
name|ssize_t
name|datalen
decl_stmt|;
name|ssize_t
name|ssize
decl_stmt|,
name|rsize
decl_stmt|;
name|socklen_t
name|fromlen
decl_stmt|;
comment|/* setup the socket pair */
ifdef|#
directive|ifdef
name|TEST_SEQ_PACKET_SOURCE_ADDRESS
name|path
operator|=
endif|#
directive|endif
name|mk_pair_of_sockets
argument_list|(
name|sv
argument_list|)
expr_stmt|;
comment|/* send and receive a small packet */
name|datalen
operator|=
name|strlen
argument_list|(
name|data
argument_list|)
operator|+
literal|1
expr_stmt|;
comment|/* +1 for the null */
name|ssize
operator|=
name|sendto
argument_list|(
name|sv
index|[
literal|0
index|]
argument_list|,
name|data
argument_list|,
name|datalen
argument_list|,
name|MSG_EOR
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|ssize
operator|<
literal|0
condition|)
block|{
name|perror
argument_list|(
literal|"send"
argument_list|)
expr_stmt|;
name|atf_tc_fail
argument_list|(
literal|"send returned< 0"
argument_list|)
expr_stmt|;
block|}
name|ATF_CHECK_EQ_MSG
argument_list|(
name|datalen
argument_list|,
name|ssize
argument_list|,
literal|"expected %zd=send(...) but got %zd"
argument_list|,
name|datalen
argument_list|,
name|ssize
argument_list|)
expr_stmt|;
name|fromlen
operator|=
sizeof|sizeof
argument_list|(
name|from
argument_list|)
expr_stmt|;
name|rsize
operator|=
name|recvfrom
argument_list|(
name|sv
index|[
literal|1
index|]
argument_list|,
name|recv_buf
argument_list|,
name|bufsize
argument_list|,
name|MSG_WAITALL
argument_list|,
operator|(
expr|struct
name|sockaddr
operator|*
operator|)
operator|&
name|from
argument_list|,
operator|&
name|fromlen
argument_list|)
expr_stmt|;
if|if
condition|(
name|ssize
operator|<
literal|0
condition|)
block|{
name|perror
argument_list|(
literal|"recvfrom"
argument_list|)
expr_stmt|;
name|atf_tc_fail
argument_list|(
literal|"recvfrom returned< 0"
argument_list|)
expr_stmt|;
block|}
name|ATF_CHECK_EQ
argument_list|(
name|datalen
argument_list|,
name|rsize
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|TEST_SEQ_PACKET_SOURCE_ADDRESS
comment|/* 	 * FreeBSD does not currently provide the source address for SEQ_PACKET 	 * AF_UNIX sockets, and POSIX does not require it, so these two checks 	 * are disabled.  If FreeBSD gains that feature in the future, then 	 * these checks may be reenabled 	 */
name|ATF_CHECK_EQ
argument_list|(
name|PF_LOCAL
argument_list|,
name|from
operator|.
name|ss_family
argument_list|)
expr_stmt|;
name|ATF_CHECK_STREQ
argument_list|(
name|path
argument_list|,
operator|(
operator|(
expr|struct
name|sockaddr_un
operator|*
operator|)
operator|&
name|from
operator|)
operator|->
name|sun_path
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|close
argument_list|(
name|sv
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
name|close
argument_list|(
name|sv
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
block|}
end_block

begin_comment
comment|/*  * send(2) and recv(2) a single short record with sockets created the  * traditional way, involving bind, listen, connect, and accept  */
end_comment

begin_expr_stmt
name|ATF_TC_WITHOUT_HEAD
argument_list|(
name|send_recv_with_connect
argument_list|)
expr_stmt|;
end_expr_stmt

begin_macro
name|ATF_TC_BODY
argument_list|(
argument|send_recv_with_connect
argument_list|,
argument|tc
argument_list|)
end_macro

begin_block
block|{
name|int
name|sv
index|[
literal|2
index|]
decl_stmt|;
specifier|const
name|int
name|bufsize
init|=
literal|64
decl_stmt|;
specifier|const
name|char
modifier|*
name|data
init|=
literal|"data"
decl_stmt|;
name|char
name|recv_buf
index|[
name|bufsize
index|]
decl_stmt|;
name|ssize_t
name|datalen
decl_stmt|;
name|ssize_t
name|ssize
decl_stmt|,
name|rsize
decl_stmt|;
name|mk_pair_of_sockets
argument_list|(
name|sv
argument_list|)
expr_stmt|;
comment|/* send and receive a small packet */
name|datalen
operator|=
name|strlen
argument_list|(
name|data
argument_list|)
operator|+
literal|1
expr_stmt|;
comment|/* +1 for the null */
name|ssize
operator|=
name|send
argument_list|(
name|sv
index|[
literal|0
index|]
argument_list|,
name|data
argument_list|,
name|datalen
argument_list|,
name|MSG_EOR
argument_list|)
expr_stmt|;
if|if
condition|(
name|ssize
operator|<
literal|0
condition|)
block|{
name|perror
argument_list|(
literal|"send"
argument_list|)
expr_stmt|;
name|atf_tc_fail
argument_list|(
literal|"send returned< 0"
argument_list|)
expr_stmt|;
block|}
name|ATF_CHECK_EQ_MSG
argument_list|(
name|datalen
argument_list|,
name|ssize
argument_list|,
literal|"expected %zd=send(...) but got %zd"
argument_list|,
name|datalen
argument_list|,
name|ssize
argument_list|)
expr_stmt|;
name|rsize
operator|=
name|recv
argument_list|(
name|sv
index|[
literal|1
index|]
argument_list|,
name|recv_buf
argument_list|,
name|bufsize
argument_list|,
name|MSG_WAITALL
argument_list|)
expr_stmt|;
name|ATF_CHECK_EQ
argument_list|(
name|datalen
argument_list|,
name|rsize
argument_list|)
expr_stmt|;
name|close
argument_list|(
name|sv
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
name|close
argument_list|(
name|sv
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
block|}
end_block

begin_comment
comment|/* send(2) should fail on a shutdown socket */
end_comment

begin_expr_stmt
name|ATF_TC_WITHOUT_HEAD
argument_list|(
name|shutdown_send
argument_list|)
expr_stmt|;
end_expr_stmt

begin_macro
name|ATF_TC_BODY
argument_list|(
argument|shutdown_send
argument_list|,
argument|tc
argument_list|)
end_macro

begin_block
block|{
name|struct
name|sockaddr_un
name|sun
decl_stmt|;
comment|/* ATF's isolation mechanisms will guarantee uniqueness of this file */
specifier|const
name|char
modifier|*
name|path
init|=
literal|"sock"
decl_stmt|;
specifier|const
name|char
modifier|*
name|data
init|=
literal|"data"
decl_stmt|;
name|ssize_t
name|ssize
decl_stmt|;
name|int
name|s
decl_stmt|,
name|err
decl_stmt|,
name|s2
decl_stmt|;
name|s
operator|=
name|socket
argument_list|(
name|PF_LOCAL
argument_list|,
name|SOCK_SEQPACKET
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|ATF_REQUIRE
argument_list|(
name|s
operator|>=
literal|0
argument_list|)
expr_stmt|;
name|bzero
argument_list|(
operator|&
name|sun
argument_list|,
sizeof|sizeof
argument_list|(
name|sun
argument_list|)
argument_list|)
expr_stmt|;
name|sun
operator|.
name|sun_family
operator|=
name|AF_LOCAL
expr_stmt|;
name|sun
operator|.
name|sun_len
operator|=
sizeof|sizeof
argument_list|(
name|sun
argument_list|)
expr_stmt|;
name|strlcpy
argument_list|(
name|sun
operator|.
name|sun_path
argument_list|,
name|path
argument_list|,
sizeof|sizeof
argument_list|(
name|sun
operator|.
name|sun_path
argument_list|)
argument_list|)
expr_stmt|;
name|err
operator|=
name|bind
argument_list|(
name|s
argument_list|,
operator|(
expr|struct
name|sockaddr
operator|*
operator|)
operator|&
name|sun
argument_list|,
sizeof|sizeof
argument_list|(
name|sun
argument_list|)
argument_list|)
expr_stmt|;
name|err
operator|=
name|listen
argument_list|(
name|s
argument_list|,
operator|-
literal|1
argument_list|)
expr_stmt|;
name|ATF_CHECK_EQ
argument_list|(
literal|0
argument_list|,
name|err
argument_list|)
expr_stmt|;
comment|/* Create the other socket */
name|s2
operator|=
name|socket
argument_list|(
name|PF_LOCAL
argument_list|,
name|SOCK_SEQPACKET
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|ATF_REQUIRE
argument_list|(
name|s2
operator|>=
literal|0
argument_list|)
expr_stmt|;
name|err
operator|=
name|connect
argument_list|(
name|s2
argument_list|,
operator|(
expr|struct
name|sockaddr
operator|*
operator|)
operator|&
name|sun
argument_list|,
sizeof|sizeof
argument_list|(
name|sun
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
operator|!=
literal|0
condition|)
block|{
name|perror
argument_list|(
literal|"connect"
argument_list|)
expr_stmt|;
name|atf_tc_fail
argument_list|(
literal|"connect(2) failed"
argument_list|)
expr_stmt|;
block|}
name|ATF_CHECK_EQ
argument_list|(
literal|0
argument_list|,
name|shutdown
argument_list|(
name|s2
argument_list|,
name|SHUT_RDWR
argument_list|)
argument_list|)
expr_stmt|;
comment|/* USE MSG_NOSIGNAL so we don't get SIGPIPE */
name|ssize
operator|=
name|send
argument_list|(
name|s2
argument_list|,
name|data
argument_list|,
sizeof|sizeof
argument_list|(
name|data
argument_list|)
argument_list|,
name|MSG_EOR
operator||
name|MSG_NOSIGNAL
argument_list|)
expr_stmt|;
name|ATF_CHECK_EQ
argument_list|(
name|EPIPE
argument_list|,
name|errno
argument_list|)
expr_stmt|;
name|ATF_CHECK_EQ
argument_list|(
operator|-
literal|1
argument_list|,
name|ssize
argument_list|)
expr_stmt|;
name|close
argument_list|(
name|s
argument_list|)
expr_stmt|;
name|close
argument_list|(
name|s2
argument_list|)
expr_stmt|;
block|}
end_block

begin_comment
comment|/* send(2) should cause SIGPIPE on a shutdown socket */
end_comment

begin_expr_stmt
name|ATF_TC_WITHOUT_HEAD
argument_list|(
name|shutdown_send_sigpipe
argument_list|)
expr_stmt|;
end_expr_stmt

begin_macro
name|ATF_TC_BODY
argument_list|(
argument|shutdown_send_sigpipe
argument_list|,
argument|tc
argument_list|)
end_macro

begin_block
block|{
name|struct
name|sockaddr_un
name|sun
decl_stmt|;
comment|/* ATF's isolation mechanisms will guarantee uniqueness of this file */
specifier|const
name|char
modifier|*
name|path
init|=
literal|"sock"
decl_stmt|;
specifier|const
name|char
modifier|*
name|data
init|=
literal|"data"
decl_stmt|;
name|int
name|s
decl_stmt|,
name|err
decl_stmt|,
name|s2
decl_stmt|;
name|s
operator|=
name|socket
argument_list|(
name|PF_LOCAL
argument_list|,
name|SOCK_SEQPACKET
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|ATF_REQUIRE
argument_list|(
name|s
operator|>=
literal|0
argument_list|)
expr_stmt|;
name|bzero
argument_list|(
operator|&
name|sun
argument_list|,
sizeof|sizeof
argument_list|(
name|sun
argument_list|)
argument_list|)
expr_stmt|;
name|sun
operator|.
name|sun_family
operator|=
name|AF_LOCAL
expr_stmt|;
name|sun
operator|.
name|sun_len
operator|=
sizeof|sizeof
argument_list|(
name|sun
argument_list|)
expr_stmt|;
name|strlcpy
argument_list|(
name|sun
operator|.
name|sun_path
argument_list|,
name|path
argument_list|,
sizeof|sizeof
argument_list|(
name|sun
operator|.
name|sun_path
argument_list|)
argument_list|)
expr_stmt|;
name|err
operator|=
name|bind
argument_list|(
name|s
argument_list|,
operator|(
expr|struct
name|sockaddr
operator|*
operator|)
operator|&
name|sun
argument_list|,
sizeof|sizeof
argument_list|(
name|sun
argument_list|)
argument_list|)
expr_stmt|;
name|err
operator|=
name|listen
argument_list|(
name|s
argument_list|,
operator|-
literal|1
argument_list|)
expr_stmt|;
name|ATF_CHECK_EQ
argument_list|(
literal|0
argument_list|,
name|err
argument_list|)
expr_stmt|;
comment|/* Create the other socket */
name|s2
operator|=
name|socket
argument_list|(
name|PF_LOCAL
argument_list|,
name|SOCK_SEQPACKET
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|ATF_REQUIRE
argument_list|(
name|s2
operator|>=
literal|0
argument_list|)
expr_stmt|;
name|err
operator|=
name|connect
argument_list|(
name|s2
argument_list|,
operator|(
expr|struct
name|sockaddr
operator|*
operator|)
operator|&
name|sun
argument_list|,
sizeof|sizeof
argument_list|(
name|sun
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
operator|!=
literal|0
condition|)
block|{
name|perror
argument_list|(
literal|"connect"
argument_list|)
expr_stmt|;
name|atf_tc_fail
argument_list|(
literal|"connect(2) failed"
argument_list|)
expr_stmt|;
block|}
name|ATF_CHECK_EQ
argument_list|(
literal|0
argument_list|,
name|shutdown
argument_list|(
name|s2
argument_list|,
name|SHUT_RDWR
argument_list|)
argument_list|)
expr_stmt|;
name|ATF_REQUIRE
argument_list|(
name|SIG_ERR
operator|!=
name|signal
argument_list|(
name|SIGPIPE
argument_list|,
name|shutdown_send_sigpipe_handler
argument_list|)
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|send
argument_list|(
name|s2
argument_list|,
name|data
argument_list|,
sizeof|sizeof
argument_list|(
name|data
argument_list|)
argument_list|,
name|MSG_EOR
argument_list|)
expr_stmt|;
name|ATF_CHECK_EQ
argument_list|(
literal|1
argument_list|,
name|got_sigpipe
argument_list|)
expr_stmt|;
name|close
argument_list|(
name|s
argument_list|)
expr_stmt|;
name|close
argument_list|(
name|s2
argument_list|)
expr_stmt|;
block|}
end_block

begin_comment
comment|/* nonblocking send(2) and recv(2) a single short record */
end_comment

begin_expr_stmt
name|ATF_TC_WITHOUT_HEAD
argument_list|(
name|send_recv_nonblocking
argument_list|)
expr_stmt|;
end_expr_stmt

begin_macro
name|ATF_TC_BODY
argument_list|(
argument|send_recv_nonblocking
argument_list|,
argument|tc
argument_list|)
end_macro

begin_block
block|{
name|int
name|sv
index|[
literal|2
index|]
decl_stmt|;
specifier|const
name|int
name|bufsize
init|=
literal|64
decl_stmt|;
specifier|const
name|char
modifier|*
name|data
init|=
literal|"data"
decl_stmt|;
name|char
name|recv_buf
index|[
name|bufsize
index|]
decl_stmt|;
name|ssize_t
name|datalen
decl_stmt|;
name|ssize_t
name|ssize
decl_stmt|,
name|rsize
decl_stmt|;
comment|/* setup the socket pair */
name|do_socketpair_nonblocking
argument_list|(
name|sv
argument_list|)
expr_stmt|;
comment|/* Verify that there is nothing to receive */
name|rsize
operator|=
name|recv
argument_list|(
name|sv
index|[
literal|1
index|]
argument_list|,
name|recv_buf
argument_list|,
name|bufsize
argument_list|,
name|MSG_WAITALL
argument_list|)
expr_stmt|;
name|ATF_CHECK_EQ
argument_list|(
name|EAGAIN
argument_list|,
name|errno
argument_list|)
expr_stmt|;
name|ATF_CHECK_EQ
argument_list|(
operator|-
literal|1
argument_list|,
name|rsize
argument_list|)
expr_stmt|;
comment|/* send and receive a small packet */
name|datalen
operator|=
name|strlen
argument_list|(
name|data
argument_list|)
operator|+
literal|1
expr_stmt|;
comment|/* +1 for the null */
name|ssize
operator|=
name|send
argument_list|(
name|sv
index|[
literal|0
index|]
argument_list|,
name|data
argument_list|,
name|datalen
argument_list|,
name|MSG_EOR
argument_list|)
expr_stmt|;
if|if
condition|(
name|ssize
operator|<
literal|0
condition|)
block|{
name|perror
argument_list|(
literal|"send"
argument_list|)
expr_stmt|;
name|atf_tc_fail
argument_list|(
literal|"send returned< 0"
argument_list|)
expr_stmt|;
block|}
name|ATF_CHECK_EQ_MSG
argument_list|(
name|datalen
argument_list|,
name|ssize
argument_list|,
literal|"expected %zd=send(...) but got %zd"
argument_list|,
name|datalen
argument_list|,
name|ssize
argument_list|)
expr_stmt|;
name|rsize
operator|=
name|recv
argument_list|(
name|sv
index|[
literal|1
index|]
argument_list|,
name|recv_buf
argument_list|,
name|bufsize
argument_list|,
name|MSG_WAITALL
argument_list|)
expr_stmt|;
name|ATF_CHECK_EQ
argument_list|(
name|datalen
argument_list|,
name|rsize
argument_list|)
expr_stmt|;
name|close
argument_list|(
name|sv
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
name|close
argument_list|(
name|sv
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
block|}
end_block

begin_comment
comment|/*  * We should get EMSGSIZE if we try to send a message larger than the socket  * buffer, with blocking sockets  */
end_comment

begin_expr_stmt
name|ATF_TC_WITHOUT_HEAD
argument_list|(
name|emsgsize
argument_list|)
expr_stmt|;
end_expr_stmt

begin_macro
name|ATF_TC_BODY
argument_list|(
argument|emsgsize
argument_list|,
argument|tc
argument_list|)
end_macro

begin_block
block|{
name|int
name|sv
index|[
literal|2
index|]
decl_stmt|;
specifier|const
name|int
name|sndbufsize
init|=
literal|8192
decl_stmt|;
specifier|const
name|int
name|rcvbufsize
init|=
literal|8192
decl_stmt|;
specifier|const
name|size_t
name|pktsize
init|=
operator|(
name|sndbufsize
operator|+
name|rcvbufsize
operator|)
operator|*
literal|2
decl_stmt|;
name|char
name|sndbuf
index|[
name|pktsize
index|]
decl_stmt|;
name|ssize_t
name|ssize
decl_stmt|;
comment|/* setup the socket pair */
name|do_socketpair
argument_list|(
name|sv
argument_list|)
expr_stmt|;
comment|/* Setup the buffers */
name|ATF_REQUIRE_EQ
argument_list|(
literal|0
argument_list|,
name|setsockopt
argument_list|(
name|sv
index|[
literal|0
index|]
argument_list|,
name|SOL_SOCKET
argument_list|,
name|SO_SNDBUF
argument_list|,
operator|&
name|sndbufsize
argument_list|,
sizeof|sizeof
argument_list|(
name|sndbufsize
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
name|ATF_REQUIRE_EQ
argument_list|(
literal|0
argument_list|,
name|setsockopt
argument_list|(
name|sv
index|[
literal|1
index|]
argument_list|,
name|SOL_SOCKET
argument_list|,
name|SO_RCVBUF
argument_list|,
operator|&
name|rcvbufsize
argument_list|,
sizeof|sizeof
argument_list|(
name|rcvbufsize
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
name|ssize
operator|=
name|send
argument_list|(
name|sv
index|[
literal|0
index|]
argument_list|,
name|sndbuf
argument_list|,
name|pktsize
argument_list|,
name|MSG_EOR
argument_list|)
expr_stmt|;
name|ATF_CHECK_EQ
argument_list|(
name|EMSGSIZE
argument_list|,
name|errno
argument_list|)
expr_stmt|;
name|ATF_CHECK_EQ
argument_list|(
operator|-
literal|1
argument_list|,
name|ssize
argument_list|)
expr_stmt|;
name|close
argument_list|(
name|sv
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
name|close
argument_list|(
name|sv
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
block|}
end_block

begin_comment
comment|/*  * We should get EMSGSIZE if we try to send a message larger than the socket  * buffer, with nonblocking sockets  */
end_comment

begin_expr_stmt
name|ATF_TC_WITHOUT_HEAD
argument_list|(
name|emsgsize_nonblocking
argument_list|)
expr_stmt|;
end_expr_stmt

begin_macro
name|ATF_TC_BODY
argument_list|(
argument|emsgsize_nonblocking
argument_list|,
argument|tc
argument_list|)
end_macro

begin_block
block|{
name|int
name|sv
index|[
literal|2
index|]
decl_stmt|;
specifier|const
name|int
name|sndbufsize
init|=
literal|8192
decl_stmt|;
specifier|const
name|int
name|rcvbufsize
init|=
literal|8192
decl_stmt|;
specifier|const
name|size_t
name|pktsize
init|=
operator|(
name|sndbufsize
operator|+
name|rcvbufsize
operator|)
operator|*
literal|2
decl_stmt|;
name|char
name|sndbuf
index|[
name|pktsize
index|]
decl_stmt|;
name|ssize_t
name|ssize
decl_stmt|;
comment|/* setup the socket pair */
name|do_socketpair_nonblocking
argument_list|(
name|sv
argument_list|)
expr_stmt|;
comment|/* Setup the buffers */
name|ATF_REQUIRE_EQ
argument_list|(
literal|0
argument_list|,
name|setsockopt
argument_list|(
name|sv
index|[
literal|0
index|]
argument_list|,
name|SOL_SOCKET
argument_list|,
name|SO_SNDBUF
argument_list|,
operator|&
name|sndbufsize
argument_list|,
sizeof|sizeof
argument_list|(
name|sndbufsize
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
name|ATF_REQUIRE_EQ
argument_list|(
literal|0
argument_list|,
name|setsockopt
argument_list|(
name|sv
index|[
literal|1
index|]
argument_list|,
name|SOL_SOCKET
argument_list|,
name|SO_RCVBUF
argument_list|,
operator|&
name|rcvbufsize
argument_list|,
sizeof|sizeof
argument_list|(
name|rcvbufsize
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
name|ssize
operator|=
name|send
argument_list|(
name|sv
index|[
literal|0
index|]
argument_list|,
name|sndbuf
argument_list|,
name|pktsize
argument_list|,
name|MSG_EOR
argument_list|)
expr_stmt|;
name|ATF_CHECK_EQ
argument_list|(
name|EMSGSIZE
argument_list|,
name|errno
argument_list|)
expr_stmt|;
name|ATF_CHECK_EQ
argument_list|(
operator|-
literal|1
argument_list|,
name|ssize
argument_list|)
expr_stmt|;
name|close
argument_list|(
name|sv
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
name|close
argument_list|(
name|sv
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
block|}
end_block

begin_comment
comment|/*  * We should get EAGAIN if we try to send a message larger than the socket  * buffer, with nonblocking sockets.  Test with several different sockbuf sizes  */
end_comment

begin_expr_stmt
name|ATF_TC_WITHOUT_HEAD
argument_list|(
name|eagain_8k_8k
argument_list|)
expr_stmt|;
end_expr_stmt

begin_macro
name|ATF_TC_BODY
argument_list|(
argument|eagain_8k_8k
argument_list|,
argument|tc
argument_list|)
end_macro

begin_block
block|{
name|test_eagain
argument_list|(
literal|8192
argument_list|,
literal|8192
argument_list|)
expr_stmt|;
block|}
end_block

begin_expr_stmt
name|ATF_TC_WITHOUT_HEAD
argument_list|(
name|eagain_8k_128k
argument_list|)
expr_stmt|;
end_expr_stmt

begin_macro
name|ATF_TC_BODY
argument_list|(
argument|eagain_8k_128k
argument_list|,
argument|tc
argument_list|)
end_macro

begin_block
block|{
name|test_eagain
argument_list|(
literal|8192
argument_list|,
literal|131072
argument_list|)
expr_stmt|;
block|}
end_block

begin_expr_stmt
name|ATF_TC_WITHOUT_HEAD
argument_list|(
name|eagain_128k_8k
argument_list|)
expr_stmt|;
end_expr_stmt

begin_macro
name|ATF_TC_BODY
argument_list|(
argument|eagain_128k_8k
argument_list|,
argument|tc
argument_list|)
end_macro

begin_block
block|{
name|test_eagain
argument_list|(
literal|131072
argument_list|,
literal|8192
argument_list|)
expr_stmt|;
block|}
end_block

begin_expr_stmt
name|ATF_TC_WITHOUT_HEAD
argument_list|(
name|eagain_128k_128k
argument_list|)
expr_stmt|;
end_expr_stmt

begin_macro
name|ATF_TC_BODY
argument_list|(
argument|eagain_128k_128k
argument_list|,
argument|tc
argument_list|)
end_macro

begin_block
block|{
name|test_eagain
argument_list|(
literal|131072
argument_list|,
literal|131072
argument_list|)
expr_stmt|;
block|}
end_block

begin_comment
comment|/*  * nonblocking send(2) and recv(2) of several records, which should collectively  * fill up the send buffer but not the receive buffer  */
end_comment

begin_expr_stmt
name|ATF_TC_WITHOUT_HEAD
argument_list|(
name|rcvbuf_oversized
argument_list|)
expr_stmt|;
end_expr_stmt

begin_macro
name|ATF_TC_BODY
argument_list|(
argument|rcvbuf_oversized
argument_list|,
argument|tc
argument_list|)
end_macro

begin_block
block|{
name|int
name|i
decl_stmt|;
name|int
name|sv
index|[
literal|2
index|]
decl_stmt|;
specifier|const
name|ssize_t
name|pktsize
init|=
literal|1024
decl_stmt|;
specifier|const
name|int
name|sndbufsize
init|=
literal|8192
decl_stmt|;
specifier|const
name|int
name|rcvbufsize
init|=
literal|131072
decl_stmt|;
specifier|const
name|size_t
name|geometric_mean_bufsize
init|=
literal|32768
decl_stmt|;
specifier|const
name|int
name|numpkts
init|=
name|geometric_mean_bufsize
operator|/
name|pktsize
decl_stmt|;
name|char
name|sndbuf
index|[
name|pktsize
index|]
decl_stmt|;
name|char
name|recv_buf
index|[
name|pktsize
index|]
decl_stmt|;
name|ssize_t
name|ssize
decl_stmt|,
name|rsize
decl_stmt|;
comment|/* setup the socket pair */
name|do_socketpair_nonblocking
argument_list|(
name|sv
argument_list|)
expr_stmt|;
name|ATF_REQUIRE_EQ
argument_list|(
literal|0
argument_list|,
name|setsockopt
argument_list|(
name|sv
index|[
literal|0
index|]
argument_list|,
name|SOL_SOCKET
argument_list|,
name|SO_SNDBUF
argument_list|,
operator|&
name|sndbufsize
argument_list|,
sizeof|sizeof
argument_list|(
name|sndbufsize
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
name|ATF_REQUIRE_EQ
argument_list|(
literal|0
argument_list|,
name|setsockopt
argument_list|(
name|sv
index|[
literal|1
index|]
argument_list|,
name|SOL_SOCKET
argument_list|,
name|SO_RCVBUF
argument_list|,
operator|&
name|rcvbufsize
argument_list|,
sizeof|sizeof
argument_list|(
name|rcvbufsize
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
comment|/* 	 * Send and receive packets that are collectively greater than the send 	 * buffer, but less than the receive buffer 	 */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|numpkts
condition|;
name|i
operator|++
control|)
block|{
comment|/* Fill the buffer */
name|memset
argument_list|(
name|sndbuf
argument_list|,
name|i
argument_list|,
name|pktsize
argument_list|)
expr_stmt|;
comment|/* send the packet */
name|ssize
operator|=
name|send
argument_list|(
name|sv
index|[
literal|0
index|]
argument_list|,
name|sndbuf
argument_list|,
name|pktsize
argument_list|,
name|MSG_EOR
argument_list|)
expr_stmt|;
if|if
condition|(
name|ssize
operator|<
literal|0
condition|)
block|{
name|perror
argument_list|(
literal|"send"
argument_list|)
expr_stmt|;
name|atf_tc_fail
argument_list|(
literal|"send returned< 0"
argument_list|)
expr_stmt|;
block|}
name|ATF_CHECK_EQ_MSG
argument_list|(
name|pktsize
argument_list|,
name|ssize
argument_list|,
literal|"expected %zd=send(...) but got %zd"
argument_list|,
name|pktsize
argument_list|,
name|ssize
argument_list|)
expr_stmt|;
comment|/* Receive it */
name|rsize
operator|=
name|recv
argument_list|(
name|sv
index|[
literal|1
index|]
argument_list|,
name|recv_buf
argument_list|,
name|pktsize
argument_list|,
name|MSG_WAITALL
argument_list|)
expr_stmt|;
if|if
condition|(
name|rsize
operator|<
literal|0
condition|)
block|{
name|perror
argument_list|(
literal|"recv"
argument_list|)
expr_stmt|;
name|atf_tc_fail
argument_list|(
literal|"recv returned< 0"
argument_list|)
expr_stmt|;
block|}
name|ATF_CHECK_EQ_MSG
argument_list|(
name|pktsize
argument_list|,
name|rsize
argument_list|,
literal|"expected %zd=send(...) but got %zd"
argument_list|,
name|pktsize
argument_list|,
name|rsize
argument_list|)
expr_stmt|;
comment|/* Verify the contents */
name|ATF_CHECK_EQ_MSG
argument_list|(
literal|0
argument_list|,
name|memcmp
argument_list|(
name|sndbuf
argument_list|,
name|recv_buf
argument_list|,
name|pktsize
argument_list|)
argument_list|,
literal|"Received data miscompare"
argument_list|)
expr_stmt|;
block|}
comment|/* Trying to receive again should return EAGAIN */
name|rsize
operator|=
name|recv
argument_list|(
name|sv
index|[
literal|1
index|]
argument_list|,
name|recv_buf
argument_list|,
name|pktsize
argument_list|,
name|MSG_WAITALL
argument_list|)
expr_stmt|;
name|ATF_CHECK_EQ
argument_list|(
name|EAGAIN
argument_list|,
name|errno
argument_list|)
expr_stmt|;
name|ATF_CHECK_EQ
argument_list|(
operator|-
literal|1
argument_list|,
name|rsize
argument_list|)
expr_stmt|;
name|close
argument_list|(
name|sv
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
name|close
argument_list|(
name|sv
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
block|}
end_block

begin_comment
comment|/*  * Simulate the behavior of a blocking pipe.  The sender will send until his  * buffer fills up, then we'll simulate a scheduler switch that will allow the  * receiver to read until his buffer empties.  Repeat the process until the  * transfer is complete.  * Repeat the test with multiple send and receive buffer sizes  */
end_comment

begin_expr_stmt
name|ATF_TC_WITHOUT_HEAD
argument_list|(
name|pipe_simulator_8k_8k
argument_list|)
expr_stmt|;
end_expr_stmt

begin_macro
name|ATF_TC_BODY
argument_list|(
argument|pipe_simulator_8k_8k
argument_list|,
argument|tc
argument_list|)
end_macro

begin_block
block|{
name|test_pipe_simulator
argument_list|(
literal|8192
argument_list|,
literal|8192
argument_list|)
expr_stmt|;
block|}
end_block

begin_expr_stmt
name|ATF_TC_WITHOUT_HEAD
argument_list|(
name|pipe_simulator_8k_128k
argument_list|)
expr_stmt|;
end_expr_stmt

begin_macro
name|ATF_TC_BODY
argument_list|(
argument|pipe_simulator_8k_128k
argument_list|,
argument|tc
argument_list|)
end_macro

begin_block
block|{
name|test_pipe_simulator
argument_list|(
literal|8192
argument_list|,
literal|131072
argument_list|)
expr_stmt|;
block|}
end_block

begin_expr_stmt
name|ATF_TC_WITHOUT_HEAD
argument_list|(
name|pipe_simulator_128k_8k
argument_list|)
expr_stmt|;
end_expr_stmt

begin_macro
name|ATF_TC_BODY
argument_list|(
argument|pipe_simulator_128k_8k
argument_list|,
argument|tc
argument_list|)
end_macro

begin_block
block|{
name|test_pipe_simulator
argument_list|(
literal|131072
argument_list|,
literal|8192
argument_list|)
expr_stmt|;
block|}
end_block

begin_expr_stmt
name|ATF_TC_WITHOUT_HEAD
argument_list|(
name|pipe_simulator_128k_128k
argument_list|)
expr_stmt|;
end_expr_stmt

begin_macro
name|ATF_TC_BODY
argument_list|(
argument|pipe_simulator_128k_128k
argument_list|,
argument|tc
argument_list|)
end_macro

begin_block
block|{
name|test_pipe_simulator
argument_list|(
literal|131072
argument_list|,
literal|131072
argument_list|)
expr_stmt|;
block|}
end_block

begin_comment
comment|/*  * Test blocking I/O by passing data between two threads.  The total amount of  * data will be>> buffer size to force blocking.  Repeat the test with multiple  * send and receive buffer sizes  */
end_comment

begin_expr_stmt
name|ATF_TC_WITHOUT_HEAD
argument_list|(
name|pipe_8k_8k
argument_list|)
expr_stmt|;
end_expr_stmt

begin_macro
name|ATF_TC_BODY
argument_list|(
argument|pipe_8k_8k
argument_list|,
argument|tc
argument_list|)
end_macro

begin_block
block|{
name|test_pipe
argument_list|(
literal|8192
argument_list|,
literal|8192
argument_list|)
expr_stmt|;
block|}
end_block

begin_expr_stmt
name|ATF_TC_WITHOUT_HEAD
argument_list|(
name|pipe_8k_128k
argument_list|)
expr_stmt|;
end_expr_stmt

begin_macro
name|ATF_TC_BODY
argument_list|(
argument|pipe_8k_128k
argument_list|,
argument|tc
argument_list|)
end_macro

begin_block
block|{
name|test_pipe
argument_list|(
literal|8192
argument_list|,
literal|131072
argument_list|)
expr_stmt|;
block|}
end_block

begin_expr_stmt
name|ATF_TC_WITHOUT_HEAD
argument_list|(
name|pipe_128k_8k
argument_list|)
expr_stmt|;
end_expr_stmt

begin_macro
name|ATF_TC_BODY
argument_list|(
argument|pipe_128k_8k
argument_list|,
argument|tc
argument_list|)
end_macro

begin_block
block|{
name|test_pipe
argument_list|(
literal|131072
argument_list|,
literal|8192
argument_list|)
expr_stmt|;
block|}
end_block

begin_expr_stmt
name|ATF_TC_WITHOUT_HEAD
argument_list|(
name|pipe_128k_128k
argument_list|)
expr_stmt|;
end_expr_stmt

begin_macro
name|ATF_TC_BODY
argument_list|(
argument|pipe_128k_128k
argument_list|,
argument|tc
argument_list|)
end_macro

begin_block
block|{
name|test_pipe
argument_list|(
literal|131072
argument_list|,
literal|131072
argument_list|)
expr_stmt|;
block|}
end_block

begin_comment
comment|/*  * Test single-packet I/O with and without blocking, with symmetric buffers of  * various sizes  */
end_comment

begin_expr_stmt
name|ATF_TC_WITHOUT_HEAD
argument_list|(
name|sendrecv_8k
argument_list|)
expr_stmt|;
end_expr_stmt

begin_macro
name|ATF_TC_BODY
argument_list|(
argument|sendrecv_8k
argument_list|,
argument|tc
argument_list|)
end_macro

begin_block
block|{
name|test_sendrecv_symmetric_buffers
argument_list|(
literal|8
operator|*
literal|1024
argument_list|,
name|true
argument_list|)
expr_stmt|;
block|}
end_block

begin_expr_stmt
name|ATF_TC_WITHOUT_HEAD
argument_list|(
name|sendrecv_16k
argument_list|)
expr_stmt|;
end_expr_stmt

begin_macro
name|ATF_TC_BODY
argument_list|(
argument|sendrecv_16k
argument_list|,
argument|tc
argument_list|)
end_macro

begin_block
block|{
name|test_sendrecv_symmetric_buffers
argument_list|(
literal|16
operator|*
literal|1024
argument_list|,
name|true
argument_list|)
expr_stmt|;
block|}
end_block

begin_expr_stmt
name|ATF_TC_WITHOUT_HEAD
argument_list|(
name|sendrecv_32k
argument_list|)
expr_stmt|;
end_expr_stmt

begin_macro
name|ATF_TC_BODY
argument_list|(
argument|sendrecv_32k
argument_list|,
argument|tc
argument_list|)
end_macro

begin_block
block|{
name|test_sendrecv_symmetric_buffers
argument_list|(
literal|32
operator|*
literal|1024
argument_list|,
name|true
argument_list|)
expr_stmt|;
block|}
end_block

begin_expr_stmt
name|ATF_TC_WITHOUT_HEAD
argument_list|(
name|sendrecv_64k
argument_list|)
expr_stmt|;
end_expr_stmt

begin_macro
name|ATF_TC_BODY
argument_list|(
argument|sendrecv_64k
argument_list|,
argument|tc
argument_list|)
end_macro

begin_block
block|{
name|test_sendrecv_symmetric_buffers
argument_list|(
literal|64
operator|*
literal|1024
argument_list|,
name|true
argument_list|)
expr_stmt|;
block|}
end_block

begin_expr_stmt
name|ATF_TC_WITHOUT_HEAD
argument_list|(
name|sendrecv_128k
argument_list|)
expr_stmt|;
end_expr_stmt

begin_macro
name|ATF_TC_BODY
argument_list|(
argument|sendrecv_128k
argument_list|,
argument|tc
argument_list|)
end_macro

begin_block
block|{
name|test_sendrecv_symmetric_buffers
argument_list|(
literal|128
operator|*
literal|1024
argument_list|,
name|true
argument_list|)
expr_stmt|;
block|}
end_block

begin_expr_stmt
name|ATF_TC_WITHOUT_HEAD
argument_list|(
name|sendrecv_8k_nonblocking
argument_list|)
expr_stmt|;
end_expr_stmt

begin_macro
name|ATF_TC_BODY
argument_list|(
argument|sendrecv_8k_nonblocking
argument_list|,
argument|tc
argument_list|)
end_macro

begin_block
block|{
name|test_sendrecv_symmetric_buffers
argument_list|(
literal|8
operator|*
literal|1024
argument_list|,
name|false
argument_list|)
expr_stmt|;
block|}
end_block

begin_expr_stmt
name|ATF_TC_WITHOUT_HEAD
argument_list|(
name|sendrecv_16k_nonblocking
argument_list|)
expr_stmt|;
end_expr_stmt

begin_macro
name|ATF_TC_BODY
argument_list|(
argument|sendrecv_16k_nonblocking
argument_list|,
argument|tc
argument_list|)
end_macro

begin_block
block|{
name|test_sendrecv_symmetric_buffers
argument_list|(
literal|16
operator|*
literal|1024
argument_list|,
name|false
argument_list|)
expr_stmt|;
block|}
end_block

begin_expr_stmt
name|ATF_TC_WITHOUT_HEAD
argument_list|(
name|sendrecv_32k_nonblocking
argument_list|)
expr_stmt|;
end_expr_stmt

begin_macro
name|ATF_TC_BODY
argument_list|(
argument|sendrecv_32k_nonblocking
argument_list|,
argument|tc
argument_list|)
end_macro

begin_block
block|{
name|test_sendrecv_symmetric_buffers
argument_list|(
literal|32
operator|*
literal|1024
argument_list|,
name|false
argument_list|)
expr_stmt|;
block|}
end_block

begin_expr_stmt
name|ATF_TC_WITHOUT_HEAD
argument_list|(
name|sendrecv_64k_nonblocking
argument_list|)
expr_stmt|;
end_expr_stmt

begin_macro
name|ATF_TC_BODY
argument_list|(
argument|sendrecv_64k_nonblocking
argument_list|,
argument|tc
argument_list|)
end_macro

begin_block
block|{
name|test_sendrecv_symmetric_buffers
argument_list|(
literal|64
operator|*
literal|1024
argument_list|,
name|false
argument_list|)
expr_stmt|;
block|}
end_block

begin_expr_stmt
name|ATF_TC_WITHOUT_HEAD
argument_list|(
name|sendrecv_128k_nonblocking
argument_list|)
expr_stmt|;
end_expr_stmt

begin_macro
name|ATF_TC_BODY
argument_list|(
argument|sendrecv_128k_nonblocking
argument_list|,
argument|tc
argument_list|)
end_macro

begin_block
block|{
name|test_sendrecv_symmetric_buffers
argument_list|(
literal|128
operator|*
literal|1024
argument_list|,
name|false
argument_list|)
expr_stmt|;
block|}
end_block

begin_comment
comment|/*  * Main.  */
end_comment

begin_macro
name|ATF_TP_ADD_TCS
argument_list|(
argument|tp
argument_list|)
end_macro

begin_block
block|{
comment|/* Basic creation and connection tests */
name|ATF_TP_ADD_TC
argument_list|(
name|tp
argument_list|,
name|create_socket
argument_list|)
expr_stmt|;
name|ATF_TP_ADD_TC
argument_list|(
name|tp
argument_list|,
name|create_socketpair
argument_list|)
expr_stmt|;
name|ATF_TP_ADD_TC
argument_list|(
name|tp
argument_list|,
name|listen_unbound
argument_list|)
expr_stmt|;
name|ATF_TP_ADD_TC
argument_list|(
name|tp
argument_list|,
name|bind
argument_list|)
expr_stmt|;
name|ATF_TP_ADD_TC
argument_list|(
name|tp
argument_list|,
name|listen_bound
argument_list|)
expr_stmt|;
name|ATF_TP_ADD_TC
argument_list|(
name|tp
argument_list|,
name|connect
argument_list|)
expr_stmt|;
name|ATF_TP_ADD_TC
argument_list|(
name|tp
argument_list|,
name|accept
argument_list|)
expr_stmt|;
name|ATF_TP_ADD_TC
argument_list|(
name|tp
argument_list|,
name|fcntl_nonblock
argument_list|)
expr_stmt|;
name|ATF_TP_ADD_TC
argument_list|(
name|tp
argument_list|,
name|resize_buffers
argument_list|)
expr_stmt|;
name|ATF_TP_ADD_TC
argument_list|(
name|tp
argument_list|,
name|resize_connected_buffers
argument_list|)
expr_stmt|;
comment|/* Unthreaded I/O tests */
name|ATF_TP_ADD_TC
argument_list|(
name|tp
argument_list|,
name|send_recv
argument_list|)
expr_stmt|;
name|ATF_TP_ADD_TC
argument_list|(
name|tp
argument_list|,
name|send_recv_nonblocking
argument_list|)
expr_stmt|;
name|ATF_TP_ADD_TC
argument_list|(
name|tp
argument_list|,
name|send_recv_with_connect
argument_list|)
expr_stmt|;
name|ATF_TP_ADD_TC
argument_list|(
name|tp
argument_list|,
name|sendto_recvfrom
argument_list|)
expr_stmt|;
name|ATF_TP_ADD_TC
argument_list|(
name|tp
argument_list|,
name|shutdown_send
argument_list|)
expr_stmt|;
name|ATF_TP_ADD_TC
argument_list|(
name|tp
argument_list|,
name|shutdown_send_sigpipe
argument_list|)
expr_stmt|;
name|ATF_TP_ADD_TC
argument_list|(
name|tp
argument_list|,
name|emsgsize
argument_list|)
expr_stmt|;
name|ATF_TP_ADD_TC
argument_list|(
name|tp
argument_list|,
name|emsgsize_nonblocking
argument_list|)
expr_stmt|;
name|ATF_TP_ADD_TC
argument_list|(
name|tp
argument_list|,
name|eagain_8k_8k
argument_list|)
expr_stmt|;
name|ATF_TP_ADD_TC
argument_list|(
name|tp
argument_list|,
name|eagain_8k_128k
argument_list|)
expr_stmt|;
name|ATF_TP_ADD_TC
argument_list|(
name|tp
argument_list|,
name|eagain_128k_8k
argument_list|)
expr_stmt|;
name|ATF_TP_ADD_TC
argument_list|(
name|tp
argument_list|,
name|eagain_128k_128k
argument_list|)
expr_stmt|;
name|ATF_TP_ADD_TC
argument_list|(
name|tp
argument_list|,
name|sendrecv_8k
argument_list|)
expr_stmt|;
name|ATF_TP_ADD_TC
argument_list|(
name|tp
argument_list|,
name|sendrecv_16k
argument_list|)
expr_stmt|;
name|ATF_TP_ADD_TC
argument_list|(
name|tp
argument_list|,
name|sendrecv_32k
argument_list|)
expr_stmt|;
name|ATF_TP_ADD_TC
argument_list|(
name|tp
argument_list|,
name|sendrecv_64k
argument_list|)
expr_stmt|;
name|ATF_TP_ADD_TC
argument_list|(
name|tp
argument_list|,
name|sendrecv_128k
argument_list|)
expr_stmt|;
name|ATF_TP_ADD_TC
argument_list|(
name|tp
argument_list|,
name|sendrecv_8k_nonblocking
argument_list|)
expr_stmt|;
name|ATF_TP_ADD_TC
argument_list|(
name|tp
argument_list|,
name|sendrecv_16k_nonblocking
argument_list|)
expr_stmt|;
name|ATF_TP_ADD_TC
argument_list|(
name|tp
argument_list|,
name|sendrecv_32k_nonblocking
argument_list|)
expr_stmt|;
name|ATF_TP_ADD_TC
argument_list|(
name|tp
argument_list|,
name|sendrecv_64k_nonblocking
argument_list|)
expr_stmt|;
name|ATF_TP_ADD_TC
argument_list|(
name|tp
argument_list|,
name|sendrecv_128k_nonblocking
argument_list|)
expr_stmt|;
name|ATF_TP_ADD_TC
argument_list|(
name|tp
argument_list|,
name|rcvbuf_oversized
argument_list|)
expr_stmt|;
name|ATF_TP_ADD_TC
argument_list|(
name|tp
argument_list|,
name|pipe_simulator_8k_8k
argument_list|)
expr_stmt|;
name|ATF_TP_ADD_TC
argument_list|(
name|tp
argument_list|,
name|pipe_simulator_8k_128k
argument_list|)
expr_stmt|;
name|ATF_TP_ADD_TC
argument_list|(
name|tp
argument_list|,
name|pipe_simulator_128k_8k
argument_list|)
expr_stmt|;
name|ATF_TP_ADD_TC
argument_list|(
name|tp
argument_list|,
name|pipe_simulator_128k_128k
argument_list|)
expr_stmt|;
comment|/* Threaded I/O tests with blocking sockets */
name|ATF_TP_ADD_TC
argument_list|(
name|tp
argument_list|,
name|pipe_8k_8k
argument_list|)
expr_stmt|;
name|ATF_TP_ADD_TC
argument_list|(
name|tp
argument_list|,
name|pipe_8k_128k
argument_list|)
expr_stmt|;
name|ATF_TP_ADD_TC
argument_list|(
name|tp
argument_list|,
name|pipe_128k_8k
argument_list|)
expr_stmt|;
name|ATF_TP_ADD_TC
argument_list|(
name|tp
argument_list|,
name|pipe_128k_128k
argument_list|)
expr_stmt|;
return|return
name|atf_no_error
argument_list|()
return|;
block|}
end_block

end_unit


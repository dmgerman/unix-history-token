begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/* Copyright (c) 1979 Regents of the University of California */
end_comment

begin_include
include|#
directive|include
file|"defs.h"
end_include

begin_comment
comment|/* must be setuid root */
end_comment

begin_comment
comment|/* netdaemon mach readfd writefd */
end_comment

begin_decl_stmt
specifier|static
name|char
name|hbuf
index|[
literal|10
index|]
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|char
name|header
index|[]
init|=
literal|"ABCDE"
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|long
name|length
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|char
name|code
decl_stmt|,
name|sin
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|FILE
modifier|*
name|temp
decl_stmt|,
modifier|*
name|dir
decl_stmt|,
modifier|*
name|jfile
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|char
name|resp
index|[
name|FNS
index|]
decl_stmt|,
name|infile
index|[
name|FNS
index|]
decl_stmt|,
name|outfile
index|[
name|FNS
index|]
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|char
name|jname
index|[
name|FNS
index|]
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|char
name|buf
index|[
name|BFS
operator|*
literal|2
index|]
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|char
name|nsendfail
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|char
name|frommach
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|char
name|tempfile
index|[]
init|=
name|TEMPFILE
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|char
name|publogfile
index|[]
init|=
name|PUBLOGFILE
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|char
name|dumpfile
index|[]
init|=
name|DUMPFILE
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|char
name|namefile
index|[]
init|=
name|NAMEFILE
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|extern
name|char
modifier|*
modifier|*
name|environ
decl_stmt|;
end_decl_stmt

begin_function_decl
name|int
name|handlekill
parameter_list|()
function_decl|;
end_function_decl

begin_function
name|main
parameter_list|(
name|argc
parameter_list|,
name|argv
parameter_list|)
name|char
modifier|*
modifier|*
name|argv
decl_stmt|;
block|{
specifier|register
name|int
name|i
decl_stmt|;
name|long
name|ltime
decl_stmt|,
name|t
decl_stmt|;
name|signal
argument_list|(
name|SIGTERM
argument_list|,
name|handlekill
argument_list|)
expr_stmt|;
name|debugflg
operator|=
name|DBV
expr_stmt|;
name|setupdaemon
argument_list|(
name|argc
argument_list|,
name|argv
argument_list|)
expr_stmt|;
comment|/* now running alone as a daemon */
comment|/* 		for(i=0; i<15; i++)close(i); 		signal(SIGHUP,SIG_IGN); 		signal(SIGQUIT,SIG_IGN); 		signal(SIGINT,SIG_IGN); 		*/
name|senddir
index|[
name|strlen
argument_list|(
name|senddir
argument_list|)
operator|-
literal|1
index|]
operator|=
name|remote
expr_stmt|;
comment|/* choose dir */
if|if
condition|(
name|chdir
argument_list|(
name|senddir
argument_list|)
operator|<
literal|0
condition|)
block|{
name|perror
argument_list|(
name|senddir
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
name|dir
operator|=
name|fopen
argument_list|(
name|senddir
argument_list|,
literal|"r"
argument_list|)
expr_stmt|;
if|if
condition|(
name|dir
operator|==
name|NULL
condition|)
block|{
name|perror
argument_list|(
name|senddir
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
name|mktemp
argument_list|(
name|tempfile
argument_list|)
expr_stmt|;
name|tempfile
index|[
name|strlen
argument_list|(
name|tempfile
argument_list|)
operator|-
literal|7
index|]
operator|=
name|remote
expr_stmt|;
name|ltime
operator|=
name|gettime
argument_list|()
expr_stmt|;
name|sprintf
argument_list|(
name|buf
argument_list|,
literal|"net restarted to %s %d %s"
argument_list|,
name|longname
argument_list|(
name|remote
argument_list|)
argument_list|,
name|getpid
argument_list|()
argument_list|,
name|ctime
argument_list|(
operator|&
name|ltime
argument_list|)
argument_list|)
expr_stmt|;
name|dump
operator|.
name|longtime
operator|=
name|dump
operator|.
name|shorttime
operator|=
name|ltime
expr_stmt|;
name|addtolog
argument_list|(
name|remote
argument_list|,
name|buf
argument_list|)
expr_stmt|;
name|addtodump
argument_list|(
name|remote
argument_list|,
name|buf
argument_list|)
expr_stmt|;
name|addtopublic
argument_list|(
name|buf
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
name|buf
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|debugflg
condition|)
name|fclose
argument_list|(
name|stderr
argument_list|)
expr_stmt|;
name|sendpurge
argument_list|()
expr_stmt|;
name|nsendfail
operator|=
literal|0
expr_stmt|;
for|for
control|(
init|;
condition|;
control|)
block|{
comment|/* begin reading file */
name|debug
argument_list|(
literal|"daemon %c %d\nreceive"
argument_list|,
name|remote
argument_list|,
name|getpid
argument_list|()
argument_list|)
expr_stmt|;
name|i
operator|=
name|getreset
argument_list|()
expr_stmt|;
name|dump
operator|.
name|waittime
operator|=
literal|0L
expr_stmt|;
if|if
condition|(
name|i
operator|==
name|BROKENREAD
condition|)
block|{
if|if
condition|(
name|nsendfail
operator|<
name|NSEND
condition|)
block|{
name|debug
argument_list|(
literal|"send"
argument_list|)
expr_stmt|;
name|netsend
argument_list|()
expr_stmt|;
block|}
else|else
name|nsendfail
operator|++
expr_stmt|;
block|}
else|else
block|{
name|i
operator|=
name|netrcv
argument_list|()
expr_stmt|;
if|if
condition|(
name|i
operator|>=
literal|0
condition|)
block|{
name|nsendfail
operator|=
literal|0
expr_stmt|;
comment|/* it sent, it is up */
name|dump
operator|.
name|waittot
operator|+=
name|dump
operator|.
name|waittime
expr_stmt|;
block|}
if|if
condition|(
name|i
operator|==
operator|-
literal|1
condition|)
name|dump
operator|.
name|nabnormal
operator|++
expr_stmt|;
block|}
name|t
operator|=
name|gettime
argument_list|()
expr_stmt|;
if|if
condition|(
name|t
operator|-
name|dump
operator|.
name|shorttime
operator|>
name|SAMPL
condition|)
name|pload
argument_list|(
name|t
argument_list|)
expr_stmt|;
if|if
condition|(
name|t
operator|-
name|dump
operator|.
name|longtime
operator|>
name|BIGSAMPL
condition|)
name|dumpit
argument_list|(
name|t
argument_list|)
expr_stmt|;
name|dump
operator|.
name|nloop
operator|++
expr_stmt|;
comment|/* count up to NSEND, sending, then wait NSEND */
if|if
condition|(
name|nsendfail
operator|>=
name|NSEND
operator|*
literal|2
condition|)
name|nsendfail
operator|=
literal|0
expr_stmt|;
block|}
block|}
end_function

begin_macro
name|netsend
argument_list|()
end_macro

begin_block
block|{
specifier|static
name|long
name|lasttime
init|=
literal|0
decl_stmt|;
specifier|static
name|char
name|nleft
init|=
literal|1
decl_stmt|;
name|long
name|jsize
decl_stmt|,
name|diff
decl_stmt|;
name|double
name|r
decl_stmt|;
name|int
name|jusr
decl_stmt|;
name|char
modifier|*
name|s
decl_stmt|,
modifier|*
name|p
decl_stmt|,
modifier|*
name|tt
decl_stmt|;
name|long
name|ot
decl_stmt|,
name|nt
decl_stmt|,
name|filesize
decl_stmt|;
specifier|register
name|int
name|i
decl_stmt|;
if|if
condition|(
name|stat
argument_list|(
name|senddir
argument_list|,
operator|&
name|statbuf
argument_list|)
operator|<
literal|0
condition|)
block|{
name|error
argument_list|(
literal|"%s %s"
argument_list|,
name|senddir
argument_list|,
name|sys_errlist
index|[
name|errno
index|]
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|statbuf
operator|.
name|st_mtime
operator|==
name|lasttime
operator|&&
name|nleft
operator|==
literal|0
condition|)
return|return;
comment|/* no need to search */
name|lasttime
operator|=
name|statbuf
operator|.
name|st_mtime
expr_stmt|;
name|fseek
argument_list|(
name|dir
argument_list|,
literal|0L
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|jsize
operator|=
operator|-
literal|1
expr_stmt|;
name|nleft
operator|=
literal|0
expr_stmt|;
while|while
condition|(
name|fread
argument_list|(
operator|&
name|dirbuf
argument_list|,
literal|1
argument_list|,
sizeof|sizeof
name|dirbuf
argument_list|,
name|dir
argument_list|)
operator|==
sizeof|sizeof
name|dirbuf
condition|)
block|{
if|if
condition|(
name|dirbuf
operator|.
name|d_ino
operator|==
literal|0
operator|||
name|dirbuf
operator|.
name|d_name
index|[
literal|0
index|]
operator|!=
literal|'c'
operator|||
name|dirbuf
operator|.
name|d_name
index|[
literal|1
index|]
operator|!=
literal|'f'
operator|||
name|dirbuf
operator|.
name|d_name
index|[
literal|2
index|]
operator|!=
name|remote
operator|||
name|stat
argument_list|(
name|dirbuf
operator|.
name|d_name
argument_list|,
operator|&
name|statbuf
argument_list|)
operator|<
literal|0
condition|)
continue|continue;
name|dirbuf
operator|.
name|d_name
index|[
literal|0
index|]
operator|=
literal|'d'
expr_stmt|;
if|if
condition|(
name|stat
argument_list|(
name|dirbuf
operator|.
name|d_name
argument_list|,
operator|&
name|statbuf
argument_list|)
operator|<
literal|0
condition|)
continue|continue;
name|filesize
operator|=
name|getsize
argument_list|(
operator|&
name|statbuf
argument_list|)
expr_stmt|;
name|nleft
operator|++
expr_stmt|;
if|if
condition|(
name|jsize
operator|==
operator|-
literal|1
operator|||
name|jsize
operator|>
name|filesize
condition|)
block|{
name|jsize
operator|=
name|filesize
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|DIRSIZ
condition|;
name|i
operator|++
control|)
name|jname
index|[
name|i
index|]
operator|=
name|dirbuf
operator|.
name|d_name
index|[
name|i
index|]
expr_stmt|;
name|jusr
operator|=
name|guid
argument_list|(
name|statbuf
operator|.
name|st_uid
argument_list|,
name|statbuf
operator|.
name|st_gid
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
name|jsize
operator|==
operator|-
literal|1
condition|)
return|return;
name|strcpy
argument_list|(
name|cmd
argument_list|,
name|jname
argument_list|)
expr_stmt|;
name|cmd
index|[
literal|0
index|]
operator|=
literal|'c'
expr_stmt|;
name|p
operator|=
name|getun
argument_list|(
name|jusr
argument_list|)
expr_stmt|;
name|addtolog
argument_list|(
name|remote
argument_list|,
literal|"^S %s %c: %s "
argument_list|,
name|p
argument_list|,
name|remote
argument_list|,
name|jname
operator|+
literal|2
argument_list|)
expr_stmt|;
name|ot
operator|=
name|gettime
argument_list|()
expr_stmt|;
name|dump
operator|.
name|waittime
operator|=
literal|0L
expr_stmt|;
if|if
condition|(
name|send
argument_list|()
operator|==
literal|0
condition|)
return|return;
name|nt
operator|=
name|gettime
argument_list|()
expr_stmt|;
name|dump
operator|.
name|waittot
operator|+=
name|dump
operator|.
name|waittime
expr_stmt|;
name|filesize
operator|=
name|getsize
argument_list|(
operator|&
name|statbuf
argument_list|)
expr_stmt|;
name|unlink
argument_list|(
name|jname
argument_list|)
expr_stmt|;
name|unlink
argument_list|(
name|cmd
argument_list|)
expr_stmt|;
name|diff
operator|=
name|nt
operator|-
name|ot
expr_stmt|;
name|s
operator|=
name|ctime
argument_list|(
operator|&
name|nt
argument_list|)
operator|+
literal|4
expr_stmt|;
name|s
index|[
name|strlen
argument_list|(
name|s
argument_list|)
operator|-
literal|9
index|]
operator|=
literal|0
expr_stmt|;
name|r
operator|=
name|filesize
expr_stmt|;
name|r
operator|=
name|r
operator|/
name|diff
expr_stmt|;
name|tt
operator|=
name|comptime
argument_list|(
name|ot
operator|-
name|statbuf
operator|.
name|st_mtime
argument_list|)
expr_stmt|;
name|jname
index|[
literal|3
index|]
operator|=
name|jname
index|[
literal|2
index|]
expr_stmt|;
name|addtolog
argument_list|(
name|remote
argument_list|,
literal|"^T%c(%s, %ldb, %ldsec, %4.1fb/sec, w %s)\n"
argument_list|,
name|remote
argument_list|,
name|s
argument_list|,
name|filesize
argument_list|,
name|diff
argument_list|,
name|r
argument_list|,
name|tt
argument_list|)
expr_stmt|;
name|addtopublic
argument_list|(
literal|"%s: sent to %s: %s (%s, %ld bytes, wait %s)\n"
argument_list|,
name|s
argument_list|,
name|longname
argument_list|(
name|remote
argument_list|)
argument_list|,
name|p
argument_list|,
name|jname
operator|+
literal|3
argument_list|,
name|filesize
argument_list|,
name|tt
argument_list|)
expr_stmt|;
name|dump
operator|.
name|nsend
operator|++
expr_stmt|;
name|dump
operator|.
name|bytetot
operator|+=
name|filesize
expr_stmt|;
name|dump
operator|.
name|elaptot
operator|+=
name|diff
expr_stmt|;
name|addtoname
argument_list|(
name|p
argument_list|)
expr_stmt|;
block|}
end_block

begin_macro
name|send
argument_list|()
end_macro

begin_block
block|{
comment|/* push those bytes */
comment|/* returns 0 if send fails, 1 otherwise */
specifier|register
name|int
name|n
decl_stmt|;
name|int
name|i
decl_stmt|;
name|long
name|lsize
decl_stmt|;
name|char
name|mbuf
index|[
literal|2
operator|*
name|BFS
index|]
decl_stmt|;
specifier|register
name|char
modifier|*
name|p
decl_stmt|;
if|if
condition|(
name|stat
argument_list|(
name|jname
argument_list|,
operator|&
name|statbuf
argument_list|)
operator|<
literal|0
condition|)
goto|goto
name|sfail
goto|;
name|lsize
operator|=
name|getsize
argument_list|(
operator|&
name|statbuf
argument_list|)
expr_stmt|;
if|if
condition|(
name|lsize
operator|<
name|MINSIZE
condition|)
block|{
comment|/* all files are at least this long */
name|unlink
argument_list|(
name|jname
argument_list|)
expr_stmt|;
name|jname
index|[
literal|0
index|]
operator|=
literal|'c'
expr_stmt|;
name|unlink
argument_list|(
name|jname
argument_list|)
expr_stmt|;
return|return
operator|(
literal|1
operator|)
return|;
block|}
name|jfile
operator|=
name|fopen
argument_list|(
name|jname
argument_list|,
literal|"r"
argument_list|)
expr_stmt|;
if|if
condition|(
name|jfile
operator|==
name|NULL
condition|)
goto|goto
name|sfail
goto|;
name|strcpy
argument_list|(
name|mbuf
argument_list|,
name|header
argument_list|)
expr_stmt|;
name|i
operator|=
name|strlen
argument_list|(
name|header
argument_list|)
expr_stmt|;
name|p
operator|=
operator|(
name|char
operator|*
operator|)
operator|&
name|lsize
expr_stmt|;
name|lsize
operator|=
name|fixuplong
argument_list|(
name|lsize
argument_list|)
expr_stmt|;
name|mbuf
index|[
name|i
index|]
operator|=
operator|*
name|p
operator|++
expr_stmt|;
name|mbuf
index|[
name|i
operator|+
literal|1
index|]
operator|=
operator|*
name|p
operator|++
expr_stmt|;
name|mbuf
index|[
name|i
operator|+
literal|2
index|]
operator|=
operator|*
name|p
operator|++
expr_stmt|;
name|mbuf
index|[
name|i
operator|+
literal|3
index|]
operator|=
operator|*
name|p
operator|++
expr_stmt|;
name|i
operator|=
name|i
operator|+
literal|4
expr_stmt|;
name|sendreset
argument_list|()
expr_stmt|;
name|masterseqno
operator|=
literal|1
expr_stmt|;
name|lastseqno
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|xwrite
argument_list|(
name|mbuf
argument_list|,
literal|1
argument_list|,
name|i
argument_list|)
operator|==
name|WRITEFAIL
condition|)
goto|goto
name|bwrite
goto|;
while|while
condition|(
operator|(
name|n
operator|=
name|fread
argument_list|(
name|buf
argument_list|,
literal|1
argument_list|,
name|BLOCKSIZE
argument_list|,
name|jfile
argument_list|)
operator|)
operator|>
literal|0
condition|)
if|if
condition|(
name|xwrite
argument_list|(
name|buf
argument_list|,
literal|1
argument_list|,
name|n
argument_list|)
operator|==
name|WRITEFAIL
condition|)
goto|goto
name|bwrite
goto|;
name|fclose
argument_list|(
name|jfile
argument_list|)
expr_stmt|;
name|debug
argument_list|(
literal|"end send"
argument_list|)
expr_stmt|;
name|nsendfail
operator|=
literal|0
expr_stmt|;
return|return
operator|(
literal|1
operator|)
return|;
name|bwrite
label|:
name|nsendfail
operator|++
expr_stmt|;
name|dump
operator|.
name|nsendfail
operator|++
expr_stmt|;
name|fclose
argument_list|(
name|jfile
argument_list|)
expr_stmt|;
name|addtolog
argument_list|(
name|remote
argument_list|,
literal|"^F%c  "
argument_list|,
name|remote
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
name|sfail
label|:
name|error
argument_list|(
literal|"%s: %s"
argument_list|,
name|jname
argument_list|,
name|sys_errlist
index|[
name|errno
index|]
argument_list|)
expr_stmt|;
name|dump
operator|.
name|nsendfail
operator|++
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_block

begin_macro
name|netrcv
argument_list|()
end_macro

begin_block
block|{
comment|/* returns -2 in normal fail, -1 in abnormal fail,>= 0 otherwise */
name|char
name|tmach
decl_stmt|,
name|fmach
decl_stmt|;
name|char
name|mgetc
argument_list|()
decl_stmt|,
name|cflag
decl_stmt|,
modifier|*
name|s
decl_stmt|;
specifier|register
name|int
name|n
decl_stmt|,
name|i
decl_stmt|;
name|char
name|vmajor
decl_stmt|,
name|vminor
decl_stmt|,
name|c
decl_stmt|;
name|int
name|rcode
decl_stmt|,
name|dummy
decl_stmt|;
name|char
name|buf1
index|[
name|BFS
operator|*
literal|2
index|]
decl_stmt|;
name|long
name|timesent
decl_stmt|,
name|otime
decl_stmt|,
name|olength
decl_stmt|,
name|diff
decl_stmt|,
name|rcvfinish
decl_stmt|,
name|nt
decl_stmt|;
name|double
name|r
decl_stmt|;
name|n
operator|=
name|nread
argument_list|(
name|hbuf
argument_list|,
literal|1
argument_list|,
name|strlen
argument_list|(
name|header
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|n
operator|==
name|BROKENREAD
condition|)
return|return
operator|(
operator|-
literal|2
operator|)
return|;
if|if
condition|(
name|n
operator|!=
name|strlen
argument_list|(
name|header
argument_list|)
operator|||
name|strcmp
argument_list|(
name|header
argument_list|,
name|hbuf
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|error
argument_list|(
literal|"wrong head %d %s"
argument_list|,
name|n
argument_list|,
name|hbuf
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
name|n
operator|=
name|nread
argument_list|(
operator|&
name|length
argument_list|,
literal|1
argument_list|,
literal|4
argument_list|)
expr_stmt|;
if|if
condition|(
name|n
operator|==
name|BROKENREAD
condition|)
return|return
operator|(
operator|-
literal|2
operator|)
return|;
if|if
condition|(
name|n
operator|!=
literal|4
condition|)
block|{
name|error
argument_list|(
literal|"bad length nread %d"
argument_list|,
name|n
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
name|length
operator|=
name|fixuplong
argument_list|(
name|length
argument_list|)
expr_stmt|;
name|olength
operator|=
name|length
expr_stmt|;
name|otime
operator|=
name|gettime
argument_list|()
expr_stmt|;
name|debug
argument_list|(
literal|"length = %ld\n"
argument_list|,
name|length
argument_list|)
expr_stmt|;
name|i
operator|=
literal|0
expr_stmt|;
name|code
operator|=
name|mgetc
argument_list|()
expr_stmt|;
name|tmach
operator|=
name|mgetc
argument_list|()
expr_stmt|;
if|if
condition|(
name|tmach
operator|<
literal|'a'
operator|||
literal|'z'
operator|<
name|tmach
condition|)
block|{
name|error
argument_list|(
literal|"bad tmach"
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
if|if
condition|(
name|tmach
operator|!=
name|local
condition|)
goto|goto
name|forw
goto|;
comment|/* being forwarded through us */
name|fmach
operator|=
name|mgetc
argument_list|()
expr_stmt|;
name|vmajor
operator|=
name|mgetc
argument_list|()
expr_stmt|;
name|vminor
operator|=
name|mgetc
argument_list|()
expr_stmt|;
name|i
operator|+=
name|mgets
argument_list|(
name|status
operator|.
name|login
argument_list|)
expr_stmt|;
name|i
operator|+=
name|mgets
argument_list|(
name|status
operator|.
name|mpasswd
argument_list|)
expr_stmt|;
name|demask
argument_list|(
name|status
operator|.
name|mpasswd
argument_list|)
expr_stmt|;
name|i
operator|+=
name|mgets
argument_list|(
name|infile
argument_list|)
expr_stmt|;
name|i
operator|+=
name|mgets
argument_list|(
name|outfile
argument_list|)
expr_stmt|;
name|i
operator|+=
name|mgets
argument_list|(
name|resp
argument_list|)
expr_stmt|;
name|i
operator|+=
name|mgets
argument_list|(
name|status
operator|.
name|localname
argument_list|)
expr_stmt|;
name|i
operator|+=
name|mgets
argument_list|(
name|ttystr
argument_list|)
expr_stmt|;
if|if
condition|(
name|ttystr
index|[
literal|0
index|]
operator|==
literal|0
condition|)
name|strcpy
argument_list|(
name|ttystr
argument_list|,
literal|"/dev/ttyx"
argument_list|)
expr_stmt|;
name|cflag
operator|=
name|mgetc
argument_list|()
expr_stmt|;
if|if
condition|(
operator|!
name|fmach
operator|||
operator|!
name|code
operator|||
operator|!
name|cflag
operator|||
operator|!
name|vmajor
operator|||
operator|!
name|vminor
condition|)
block|{
name|error
argument_list|(
literal|"mgetc fails"
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
name|cflag
operator|-=
literal|'a'
expr_stmt|;
name|vmajor
operator|-=
literal|'a'
expr_stmt|;
name|vminor
operator|-=
literal|'a'
expr_stmt|;
if|if
condition|(
name|vmajor
operator|!=
name|VMAJOR
operator|||
name|vminor
operator|!=
name|VMINOR
condition|)
block|{
name|error
argument_list|(
literal|"versions dont agree (%d,%d) vs. (%d,%d) remote"
argument_list|,
name|VMAJOR
argument_list|,
name|VMINOR
argument_list|,
name|vmajor
argument_list|,
name|vminor
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
name|i
operator|+=
name|mgets
argument_list|(
name|buf
argument_list|)
expr_stmt|;
name|ltime
operator|=
literal|0
expr_stmt|;
name|sscanf
argument_list|(
name|buf
argument_list|,
literal|"%lo"
argument_list|,
operator|&
name|ltime
argument_list|)
expr_stmt|;
name|i
operator|+=
name|mgets
argument_list|(
name|buf1
argument_list|)
expr_stmt|;
name|status
operator|.
name|jobno
operator|=
name|atoi
argument_list|(
name|buf1
argument_list|)
expr_stmt|;
name|i
operator|+=
name|mgets
argument_list|(
name|buf1
argument_list|)
expr_stmt|;
comment|/* time sent */
name|sscanf
argument_list|(
name|buf1
argument_list|,
literal|"%ld"
argument_list|,
operator|&
name|timesent
argument_list|)
expr_stmt|;
name|i
operator|+=
name|mgetcmd
argument_list|(
name|cmd
argument_list|)
expr_stmt|;
name|i
operator|+=
name|mgetcmd
argument_list|(
name|realcmd
argument_list|)
expr_stmt|;
if|if
condition|(
name|i
operator|!=
literal|0
condition|)
block|{
name|error
argument_list|(
literal|"mgets fails"
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
if|if
condition|(
name|realcmd
index|[
literal|0
index|]
operator|==
literal|0
condition|)
name|strcpy
argument_list|(
name|realcmd
argument_list|,
name|cmd
argument_list|)
expr_stmt|;
name|s
operator|=
name|realcmd
expr_stmt|;
while|while
condition|(
operator|*
name|s
operator|&&
operator|*
name|s
operator|!=
literal|' '
condition|)
name|s
operator|++
expr_stmt|;
name|c
operator|=
operator|*
name|s
expr_stmt|;
operator|*
name|s
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|strcmp
argument_list|(
name|realcmd
argument_list|,
literal|"netlpr"
argument_list|)
operator|==
literal|0
condition|)
name|dump
operator|.
name|nnetlpr
operator|++
expr_stmt|;
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|realcmd
argument_list|,
literal|"netmail"
argument_list|)
operator|==
literal|0
condition|)
name|dump
operator|.
name|nnetmail
operator|++
expr_stmt|;
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|realcmd
argument_list|,
literal|"mail"
argument_list|)
operator|==
literal|0
condition|)
name|dump
operator|.
name|nsmail
operator|++
expr_stmt|;
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|realcmd
argument_list|,
literal|"netcp"
argument_list|)
operator|==
literal|0
condition|)
name|dump
operator|.
name|nnetcp
operator|++
expr_stmt|;
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|realcmd
argument_list|,
literal|"response"
argument_list|)
operator|==
literal|0
condition|)
name|dump
operator|.
name|nresp
operator|++
expr_stmt|;
else|else
name|dump
operator|.
name|nnet
operator|++
expr_stmt|;
operator|*
name|s
operator|=
name|c
expr_stmt|;
name|debug
argument_list|(
literal|"%c %c %c (%c,%c) %s %s %s %s (%s) %s %c %lo %d %s\n"
argument_list|,
name|code
argument_list|,
name|tmach
argument_list|,
name|fmach
argument_list|,
name|vmajor
operator|+
literal|'a'
argument_list|,
name|vminor
operator|+
literal|'a'
argument_list|,
name|status
operator|.
name|login
argument_list|,
name|infile
argument_list|,
name|outfile
argument_list|,
name|resp
argument_list|,
name|status
operator|.
name|localname
argument_list|,
name|ttystr
argument_list|,
name|cflag
operator|+
literal|'a'
argument_list|,
name|ltime
argument_list|,
name|status
operator|.
name|jobno
argument_list|,
name|cmd
argument_list|)
expr_stmt|;
comment|/* any chars left are data */
name|forw
label|:
name|sin
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|length
operator|>
literal|0
condition|)
block|{
comment|/* make a temp input file */
name|increment
argument_list|(
name|tempfile
argument_list|)
expr_stmt|;
name|temp
operator|=
name|fopen
argument_list|(
name|tempfile
argument_list|,
literal|"w"
argument_list|)
expr_stmt|;
if|if
condition|(
name|temp
operator|==
name|NULL
condition|)
block|{
name|error
argument_list|(
literal|"%s %s"
argument_list|,
name|tempfile
argument_list|,
name|sys_errlist
index|[
name|errno
index|]
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
name|chmod
argument_list|(
name|tempfile
argument_list|,
literal|0600
argument_list|)
expr_stmt|;
if|if
condition|(
name|tmach
operator|!=
name|local
condition|)
name|fprintf
argument_list|(
name|temp
argument_list|,
literal|"%c :%c :"
argument_list|,
name|code
argument_list|,
name|tmach
argument_list|)
expr_stmt|;
while|while
condition|(
operator|(
name|n
operator|=
name|mread
argument_list|(
name|buf
argument_list|,
literal|1
argument_list|,
name|BLOCKSIZE
argument_list|)
operator|)
operator|>
literal|0
condition|)
if|if
condition|(
name|fwrite
argument_list|(
name|buf
argument_list|,
literal|1
argument_list|,
name|n
argument_list|,
name|temp
argument_list|)
operator|!=
name|n
condition|)
block|{
name|error
argument_list|(
literal|"%s %s"
argument_list|,
name|tempfile
argument_list|,
name|sys_errlist
index|[
name|errno
index|]
argument_list|)
expr_stmt|;
name|fclose
argument_list|(
name|temp
argument_list|)
expr_stmt|;
name|unlink
argument_list|(
name|tempfile
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
empty_stmt|;
name|fclose
argument_list|(
name|temp
argument_list|)
expr_stmt|;
if|if
condition|(
name|n
operator|==
name|BROKENREAD
operator|||
name|length
operator|>
literal|0
condition|)
block|{
name|unlink
argument_list|(
name|tempfile
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|2
operator|)
return|;
block|}
name|sin
operator|=
literal|1
expr_stmt|;
if|if
condition|(
name|tmach
operator|!=
name|local
condition|)
block|{
name|diff
operator|=
name|gettime
argument_list|()
operator|-
name|otime
expr_stmt|;
name|r
operator|=
name|olength
expr_stmt|;
name|r
operator|=
name|r
operator|/
name|diff
expr_stmt|;
name|addtolog
argument_list|(
name|remote
argument_list|,
literal|"^P(to %c, %ldb, %ldsec, %4.1fb/sec)\n"
argument_list|,
name|tmach
argument_list|,
name|olength
argument_list|,
name|diff
argument_list|,
name|r
argument_list|)
expr_stmt|;
name|dump
operator|.
name|npass
operator|++
expr_stmt|;
name|dump
operator|.
name|bytetot
operator|+=
name|olength
expr_stmt|;
name|dump
operator|.
name|elaptot
operator|+=
name|diff
expr_stmt|;
if|if
condition|(
name|fork
argument_list|()
operator|==
literal|0
condition|)
block|{
name|sprintf
argument_list|(
name|buf
argument_list|,
literal|"-m%c"
argument_list|,
name|tmach
argument_list|)
expr_stmt|;
name|execl
argument_list|(
name|netcmd
argument_list|,
literal|"net"
argument_list|,
literal|"-x"
argument_list|,
literal|"-s"
argument_list|,
name|tempfile
argument_list|,
name|buf
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
name|wait
argument_list|(
operator|&
name|dummy
argument_list|)
expr_stmt|;
name|unlink
argument_list|(
name|tempfile
argument_list|)
expr_stmt|;
return|return
operator|(
literal|1
operator|)
return|;
block|}
block|}
if|if
condition|(
name|length
operator|>
literal|0
condition|)
block|{
name|error
argument_list|(
literal|"file too short"
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
name|rcvfinish
operator|=
name|gettime
argument_list|()
expr_stmt|;
while|while
condition|(
operator|(
name|i
operator|=
name|fork
argument_list|()
operator|)
operator|==
operator|-
literal|1
condition|)
name|sleep
argument_list|(
literal|2
argument_list|)
expr_stmt|;
if|if
condition|(
name|i
operator|>
literal|0
condition|)
block|{
name|wait
argument_list|(
operator|&
name|dummy
argument_list|)
expr_stmt|;
return|return
operator|(
literal|1
operator|)
return|;
block|}
comment|/* normal return */
while|while
condition|(
operator|(
name|i
operator|=
name|fork
argument_list|()
operator|)
operator|==
operator|-
literal|1
condition|)
name|sleep
argument_list|(
literal|2
argument_list|)
expr_stmt|;
if|if
condition|(
name|i
condition|)
name|exit
argument_list|(
literal|0
argument_list|)
expr_stmt|;
comment|/* child process which forks and waits */
name|mktemp
argument_list|(
name|resfile
argument_list|)
expr_stmt|;
while|while
condition|(
operator|(
name|i
operator|=
name|fork
argument_list|()
operator|)
operator|==
operator|-
literal|1
condition|)
name|sleep
argument_list|(
literal|2
argument_list|)
expr_stmt|;
if|if
condition|(
name|i
operator|==
literal|0
condition|)
block|{
comment|/* child */
name|strcpy
argument_list|(
name|status
operator|.
name|loginshell
argument_list|,
name|Bsh
argument_list|)
expr_stmt|;
name|frommach
operator|=
name|fmach
expr_stmt|;
name|n
operator|=
name|check
argument_list|(
name|status
operator|.
name|login
argument_list|,
name|status
operator|.
name|mpasswd
argument_list|,
operator|(
name|code
operator|==
literal|'q'
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|n
condition|)
name|errormsg
argument_list|(
name|fmach
argument_list|,
literal|"Bad remote login/password %s"
argument_list|,
name|status
operator|.
name|login
argument_list|)
expr_stmt|;
name|temp
operator|=
name|fopen
argument_list|(
name|resfile
argument_list|,
literal|"w"
argument_list|)
expr_stmt|;
if|if
condition|(
name|temp
operator|==
name|NULL
condition|)
name|errormsg
argument_list|(
name|fmach
argument_list|,
literal|"creat %s %s"
argument_list|,
name|resfile
argument_list|,
name|sys_errlist
index|[
name|errno
index|]
argument_list|)
expr_stmt|;
name|chmod
argument_list|(
name|resfile
argument_list|,
literal|0600
argument_list|)
expr_stmt|;
name|fclose
argument_list|(
name|temp
argument_list|)
expr_stmt|;
name|chown
argument_list|(
name|resfile
argument_list|,
name|status
operator|.
name|muid
argument_list|,
name|status
operator|.
name|mgid
argument_list|)
expr_stmt|;
if|if
condition|(
name|sin
condition|)
name|chown
argument_list|(
name|tempfile
argument_list|,
name|status
operator|.
name|muid
argument_list|,
name|status
operator|.
name|mgid
argument_list|)
expr_stmt|;
name|setuid
argument_list|(
name|status
operator|.
name|muid
argument_list|)
expr_stmt|;
name|setgid
argument_list|(
name|status
operator|.
name|mgid
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|i
operator|=
name|getuid
argument_list|()
operator|)
operator|!=
name|status
operator|.
name|muid
condition|)
name|error
argument_list|(
literal|"setuid fails"
argument_list|)
expr_stmt|;
name|debug
argument_list|(
literal|"uid: %o\n"
argument_list|,
name|i
argument_list|)
expr_stmt|;
comment|/* check for allowed root commands, for security reasons */
if|if
condition|(
name|i
operator|==
literal|0
condition|)
block|{
name|s
operator|=
name|cmd
expr_stmt|;
while|while
condition|(
operator|*
name|s
operator|&&
operator|*
name|s
operator|!=
literal|' '
condition|)
name|s
operator|++
expr_stmt|;
name|c
operator|=
operator|*
name|s
expr_stmt|;
operator|*
name|s
operator|=
literal|0
expr_stmt|;
comment|/* these are the only commands root may execute */
if|if
condition|(
name|strcmp
argument_list|(
name|cmd
argument_list|,
literal|"cat"
argument_list|)
operator|!=
literal|0
operator|&&
name|strcmp
argument_list|(
name|cmd
argument_list|,
name|writecmd
argument_list|)
operator|!=
literal|0
operator|&&
name|strcmp
argument_list|(
name|cmd
argument_list|,
literal|"/usr/lib/tq"
argument_list|)
operator|!=
literal|0
operator|&&
name|strcmp
argument_list|(
name|cmd
argument_list|,
literal|"/usr/lib/rtrrm"
argument_list|)
operator|!=
literal|0
operator|&&
name|strcmp
argument_list|(
name|cmd
argument_list|,
literal|"lpr"
argument_list|)
operator|!=
literal|0
condition|)
name|errormsg
argument_list|(
name|fmach
argument_list|,
literal|"Not allowed to use that command as root"
argument_list|)
expr_stmt|;
operator|*
name|s
operator|=
name|c
expr_stmt|;
block|}
if|if
condition|(
name|chdir
argument_list|(
name|status
operator|.
name|dir
argument_list|)
operator|<
literal|0
condition|)
name|errormsg
argument_list|(
name|fmach
argument_list|,
literal|"chdir %s %s"
argument_list|,
name|status
operator|.
name|dir
argument_list|,
name|sys_errlist
index|[
name|errno
index|]
argument_list|)
expr_stmt|;
name|setenv
argument_list|(
name|status
operator|.
name|dir
argument_list|)
expr_stmt|;
comment|/* set up v7 environment */
if|if
condition|(
name|sin
condition|)
name|mreopen
argument_list|(
name|fmach
argument_list|,
name|tempfile
argument_list|,
literal|"r"
argument_list|,
name|stdin
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|infile
index|[
literal|0
index|]
condition|)
name|mreopen
argument_list|(
name|fmach
argument_list|,
name|infile
argument_list|,
literal|"r"
argument_list|,
name|stdin
argument_list|)
expr_stmt|;
else|else
name|mreopen
argument_list|(
name|fmach
argument_list|,
literal|"/dev/null"
argument_list|,
literal|"r"
argument_list|,
name|stdin
argument_list|)
expr_stmt|;
if|if
condition|(
name|code
operator|==
literal|'s'
operator|&&
name|outfile
index|[
literal|0
index|]
condition|)
block|{
if|if
condition|(
name|stat
argument_list|(
name|outfile
argument_list|,
operator|&
name|statbuf
argument_list|)
operator|<
literal|0
operator|||
name|getsize
argument_list|(
operator|&
name|statbuf
argument_list|)
operator|!=
literal|0
operator|||
operator|!
operator|(
name|statbuf
operator|.
name|st_mode
operator|&
literal|0600
operator|)
condition|)
name|errormsg
argument_list|(
name|local
argument_list|,
literal|"bad result file %s"
argument_list|,
name|outfile
argument_list|)
expr_stmt|;
name|mreopen
argument_list|(
name|fmach
argument_list|,
name|outfile
argument_list|,
literal|"w"
argument_list|,
name|stdout
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|outfile
index|[
literal|0
index|]
condition|)
block|{
name|temp
operator|=
name|fopen
argument_list|(
name|outfile
argument_list|,
literal|"w"
argument_list|)
expr_stmt|;
if|if
condition|(
name|temp
operator|==
name|NULL
condition|)
name|errormsg
argument_list|(
name|fmach
argument_list|,
literal|"fopen %s %s"
argument_list|,
name|outfile
argument_list|,
name|sys_errlist
index|[
name|errno
index|]
argument_list|)
expr_stmt|;
name|fclose
argument_list|(
name|temp
argument_list|)
expr_stmt|;
name|mreopen
argument_list|(
name|fmach
argument_list|,
name|outfile
argument_list|,
literal|"w"
argument_list|,
name|stdout
argument_list|)
expr_stmt|;
block|}
else|else
name|mreopen
argument_list|(
name|fmach
argument_list|,
name|resfile
argument_list|,
literal|"a"
argument_list|,
name|stdout
argument_list|)
expr_stmt|;
name|debug
argument_list|(
literal|"exec '%s'\n"
argument_list|,
name|cmd
argument_list|)
expr_stmt|;
if|if
condition|(
name|debugflg
operator|==
literal|0
condition|)
block|{
comment|/* cheat */
name|close
argument_list|(
literal|2
argument_list|)
expr_stmt|;
name|dup
argument_list|(
literal|1
argument_list|)
expr_stmt|;
comment|/* 			mreopen(fmach,resfile,"a",stderr); 			*/
block|}
for|for
control|(
name|i
operator|=
literal|3
init|;
name|i
operator|<
literal|15
condition|;
name|i
operator|++
control|)
name|close
argument_list|(
name|i
argument_list|)
expr_stmt|;
do|do
block|{
name|mexecl
argument_list|(
name|status
operator|.
name|loginshell
argument_list|,
literal|"sh"
argument_list|,
literal|"-c"
argument_list|,
name|cmd
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|sleep
argument_list|(
literal|2
argument_list|)
expr_stmt|;
block|}
do|while
condition|(
name|errno
operator|==
name|ETXTBSY
condition|)
do|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
comment|/* parent */
name|wait
argument_list|(
operator|&
name|rcode
argument_list|)
expr_stmt|;
comment|/* 	fclose(stdin); 	fclose(stdout); 	fclose(stderr); 	*/
if|if
condition|(
name|sin
condition|)
name|unlink
argument_list|(
name|tempfile
argument_list|)
expr_stmt|;
if|if
condition|(
name|code
operator|==
literal|'q'
operator|&&
operator|(
name|resp
index|[
literal|0
index|]
operator|||
operator|!
operator|(
name|cflag
operator|&
name|F_NONOTIFY
operator|)
operator|)
condition|)
block|{
comment|/* send response back if a response file 		was given or if mail/write is allowed */
comment|/* should give an error message for 		non-zero return codes */
if|if
condition|(
name|stat
argument_list|(
name|resfile
argument_list|,
operator|&
name|statbuf
argument_list|)
operator|<
literal|0
condition|)
block|{
name|error
argument_list|(
literal|"%s %s"
argument_list|,
name|resfile
argument_list|,
name|sys_errlist
index|[
name|errno
index|]
argument_list|)
expr_stmt|;
goto|goto
name|next
goto|;
block|}
if|if
condition|(
name|getsize
argument_list|(
operator|&
name|statbuf
argument_list|)
operator|>=
name|MAXFILE
condition|)
block|{
name|errormsg
argument_list|(
name|fmach
argument_list|,
literal|"Result file too large - not sent"
argument_list|)
expr_stmt|;
goto|goto
name|next
goto|;
block|}
if|if
condition|(
name|getsize
argument_list|(
operator|&
name|statbuf
argument_list|)
operator|==
literal|0
operator|&&
name|resp
index|[
literal|0
index|]
condition|)
goto|goto
name|next
goto|;
if|if
condition|(
name|resp
index|[
literal|0
index|]
condition|)
name|sprintf
argument_list|(
name|buf1
argument_list|,
literal|"-o %s cat"
argument_list|,
name|resp
argument_list|)
expr_stmt|;
else|else
name|sprintf
argument_list|(
name|buf1
argument_list|,
literal|"%s %s %s %lo %c %s \"'%s'\" %ld"
argument_list|,
name|writecmd
argument_list|,
name|status
operator|.
name|localname
argument_list|,
name|ttystr
argument_list|,
name|ltime
argument_list|,
name|tmach
argument_list|,
name|status
operator|.
name|login
argument_list|,
name|realcmd
argument_list|,
name|timesent
argument_list|)
expr_stmt|;
name|sprintf
argument_list|(
name|buf
argument_list|,
literal|"%s -m%c -z -n -l %s -s %s -c response %s"
argument_list|,
name|netcmd
argument_list|,
name|fmach
argument_list|,
name|status
operator|.
name|localname
argument_list|,
name|resfile
argument_list|,
name|buf1
argument_list|)
expr_stmt|;
name|dummy
operator|=
name|system
argument_list|(
name|buf
argument_list|)
expr_stmt|;
comment|/* execute command buf */
block|}
name|next
label|:
name|unlink
argument_list|(
name|resfile
argument_list|)
expr_stmt|;
name|s
operator|=
name|ctime
argument_list|(
operator|&
name|rcvfinish
argument_list|)
expr_stmt|;
name|s
operator|+=
literal|4
expr_stmt|;
name|s
index|[
name|strlen
argument_list|(
name|s
argument_list|)
operator|-
literal|8
index|]
operator|=
literal|0
expr_stmt|;
name|diff
operator|=
name|rcvfinish
operator|-
name|otime
expr_stmt|;
name|r
operator|=
name|olength
expr_stmt|;
name|r
operator|=
name|r
operator|/
name|diff
expr_stmt|;
name|dump
operator|.
name|bytetot
operator|+=
name|olength
expr_stmt|;
name|dump
operator|.
name|elaptot
operator|+=
name|diff
expr_stmt|;
name|addtoname
argument_list|(
name|status
operator|.
name|login
argument_list|)
expr_stmt|;
name|sprintf
argument_list|(
name|buf
argument_list|,
literal|"%s rcv %s: %s (%s)"
argument_list|,
name|s
argument_list|,
name|longname
argument_list|(
name|fmach
argument_list|)
argument_list|,
name|status
operator|.
name|login
argument_list|,
name|status
operator|.
name|localname
argument_list|)
expr_stmt|;
name|addtolog
argument_list|(
name|remote
argument_list|,
literal|"%s C: %s\n"
argument_list|,
name|buf
argument_list|,
name|realcmd
argument_list|)
expr_stmt|;
name|addtopublic
argument_list|(
literal|"%s R: %d C: %s\n"
argument_list|,
name|buf
argument_list|,
name|rcode
operator|>>
literal|8
argument_list|,
name|realcmd
argument_list|)
expr_stmt|;
name|nt
operator|=
name|rcvfinish
operator|-
name|timesent
operator|-
name|TIMEBASE
expr_stmt|;
name|buf
index|[
literal|0
index|]
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|nt
operator|>
literal|0L
condition|)
name|sprintf
argument_list|(
name|buf
argument_list|,
literal|" took (%s,%ld)"
argument_list|,
name|comptime
argument_list|(
name|nt
argument_list|)
argument_list|,
name|nt
argument_list|)
expr_stmt|;
name|addtolog
argument_list|(
name|remote
argument_list|,
literal|"\t\tR: %d%s %ldb %ldsec %4.1fb/sec\n"
argument_list|,
name|rcode
operator|>>
literal|8
argument_list|,
name|buf
argument_list|,
name|olength
argument_list|,
name|diff
argument_list|,
name|r
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|0
argument_list|)
expr_stmt|;
comment|/*UNREACHED*/
block|}
end_block

begin_comment
comment|/* l = login pass=passwd    verify = 1 if password must check */
end_comment

begin_macro
name|check
argument_list|(
argument|l
argument_list|,
argument|pass
argument_list|,
argument|verify
argument_list|)
end_macro

begin_comment
comment|/* 1 if OK, 0 if not */
end_comment

begin_decl_stmt
name|int
name|verify
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|char
modifier|*
name|l
decl_stmt|,
modifier|*
name|pass
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|int
name|ver
decl_stmt|;
name|char
modifier|*
name|s
decl_stmt|,
modifier|*
name|u
decl_stmt|,
modifier|*
name|nullstr
init|=
literal|""
decl_stmt|;
name|struct
name|passwd
modifier|*
name|pwd
decl_stmt|;
name|ver
operator|=
operator|(
name|verify
operator|==
literal|0
operator|)
expr_stmt|;
comment|/* ver is true if password verification 						was not requested */
if|if
condition|(
name|l
index|[
literal|0
index|]
operator|==
literal|0
condition|)
return|return
operator|(
name|ver
operator|)
return|;
if|if
condition|(
operator|!
name|goodacctname
argument_list|(
name|l
argument_list|)
condition|)
return|return
operator|(
name|ver
operator|)
return|;
name|pwd
operator|=
name|getpwnam
argument_list|(
name|l
argument_list|)
expr_stmt|;
if|if
condition|(
name|pwd
operator|==
name|NULL
condition|)
return|return
operator|(
name|ver
operator|)
return|;
ifdef|#
directive|ifdef
name|OLDPROT
if|if
condition|(
name|machtype
index|[
name|local
operator|-
literal|'a'
index|]
operator|==
name|M_CC
operator|&&
name|machtype
index|[
name|frommach
operator|-
literal|'a'
index|]
operator|==
name|M_CC
condition|)
name|s
operator|=
name|pass
expr_stmt|;
elseif|else
endif|#
directive|endif
if|if
condition|(
operator|*
name|pass
condition|)
name|s
operator|=
name|crypt
argument_list|(
name|pass
argument_list|,
name|pwd
operator|->
name|pw_passwd
argument_list|)
expr_stmt|;
else|else
name|s
operator|=
name|nullstr
expr_stmt|;
name|status
operator|.
name|muid
operator|=
name|guid
argument_list|(
name|pwd
operator|->
name|pw_uid
argument_list|,
name|pwd
operator|->
name|pw_gid
argument_list|)
expr_stmt|;
name|status
operator|.
name|mgid
operator|=
name|pwd
operator|->
name|pw_gid
expr_stmt|;
if|if
condition|(
name|isdigit
argument_list|(
name|pwd
operator|->
name|pw_gecos
index|[
literal|0
index|]
argument_list|)
condition|)
name|status
operator|.
name|jobno
operator|=
name|atoi
argument_list|(
name|pwd
operator|->
name|pw_gecos
argument_list|)
expr_stmt|;
else|else
name|status
operator|.
name|jobno
operator|=
literal|32767
expr_stmt|;
name|strcpy
argument_list|(
name|status
operator|.
name|dir
argument_list|,
name|pwd
operator|->
name|pw_dir
argument_list|)
expr_stmt|;
name|strcpy
argument_list|(
name|status
operator|.
name|loginshell
argument_list|,
name|pwd
operator|->
name|pw_shell
argument_list|)
expr_stmt|;
name|u
operator|=
name|status
operator|.
name|loginshell
expr_stmt|;
if|if
condition|(
name|u
index|[
literal|0
index|]
operator|==
literal|0
comment|/* || strcmp("sh",u+strlen(u)-2) != 0 */
condition|)
name|strcpy
argument_list|(
name|u
argument_list|,
name|Bsh
argument_list|)
expr_stmt|;
name|getpwdf
argument_list|(
name|pwd
argument_list|)
expr_stmt|;
comment|/* ignore network passwd */
if|if
condition|(
operator|!
name|spacct
argument_list|(
name|status
operator|.
name|login
argument_list|,
name|s
argument_list|,
name|status
operator|.
name|localname
argument_list|,
name|status
operator|.
name|muid
argument_list|,
name|status
operator|.
name|mgid
argument_list|)
operator|&&
name|strcmp
argument_list|(
name|pwd
operator|->
name|pw_passwd
argument_list|,
name|s
argument_list|)
operator|&&
name|verify
condition|)
return|return
operator|(
literal|0
operator|)
return|;
return|return
operator|(
literal|1
operator|)
return|;
block|}
end_block

begin_expr_stmt
name|mread
argument_list|(
name|b
argument_list|,
name|i
argument_list|,
name|n
argument_list|)
specifier|register
name|int
name|n
expr_stmt|;
end_expr_stmt

begin_block
block|{
if|if
condition|(
name|length
operator|<=
literal|0
condition|)
return|return
operator|(
literal|0
operator|)
return|;
if|if
condition|(
name|length
operator|<
name|n
condition|)
name|n
operator|=
name|length
expr_stmt|;
name|n
operator|=
name|nread
argument_list|(
name|b
argument_list|,
name|i
argument_list|,
name|n
argument_list|)
expr_stmt|;
if|if
condition|(
name|n
operator|!=
name|BROKENREAD
condition|)
name|length
operator|-=
name|n
expr_stmt|;
return|return
operator|(
name|n
operator|)
return|;
block|}
end_block

begin_function
name|char
name|mgetc
parameter_list|()
block|{
comment|/* returns 0 if fail */
specifier|register
name|char
name|c
decl_stmt|;
specifier|register
name|int
name|n
decl_stmt|;
name|char
name|buf
index|[
literal|3
index|]
decl_stmt|;
if|if
condition|(
operator|(
name|n
operator|=
name|nread
argument_list|(
name|buf
argument_list|,
literal|1
argument_list|,
literal|3
argument_list|)
operator|)
operator|==
name|BROKENREAD
condition|)
return|return
operator|(
literal|0
operator|)
return|;
if|if
condition|(
name|n
operator|!=
literal|3
condition|)
block|{
name|error
argument_list|(
literal|"bad read %d"
argument_list|,
name|n
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
name|c
operator|=
name|buf
index|[
literal|0
index|]
expr_stmt|;
if|if
condition|(
name|buf
index|[
literal|1
index|]
operator|!=
literal|' '
operator|&&
name|buf
index|[
literal|1
index|]
operator|!=
literal|':'
condition|)
block|{
name|error
argument_list|(
literal|"Bad char %c"
argument_list|,
name|buf
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
name|length
operator|-=
literal|3
expr_stmt|;
if|if
condition|(
name|length
operator|<
literal|0
condition|)
block|{
name|error
argument_list|(
literal|"length wrong2 %ld"
argument_list|,
name|length
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
return|return
operator|(
name|c
operator|)
return|;
block|}
end_function

begin_expr_stmt
name|mgets
argument_list|(
name|s
argument_list|)
comment|/* returns 0 if ok, 1 if not */
specifier|register
name|char
operator|*
name|s
expr_stmt|;
end_expr_stmt

begin_block
block|{
specifier|register
name|char
modifier|*
name|q
decl_stmt|;
specifier|register
name|int
name|n
decl_stmt|;
name|char
name|c
decl_stmt|;
name|q
operator|=
name|s
expr_stmt|;
for|for
control|(
init|;
condition|;
control|)
block|{
if|if
condition|(
operator|(
name|n
operator|=
name|nread
argument_list|(
operator|&
name|c
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|)
operator|)
operator|==
name|BROKENREAD
condition|)
block|{
operator|*
name|s
operator|=
literal|0
expr_stmt|;
name|error
argument_list|(
literal|"mgets %s"
argument_list|,
name|s
argument_list|)
expr_stmt|;
return|return
operator|(
literal|1
operator|)
return|;
block|}
if|if
condition|(
name|n
operator|==
literal|0
condition|)
break|break;
if|if
condition|(
name|c
operator|==
literal|'\\'
condition|)
block|{
if|if
condition|(
operator|(
name|n
operator|=
name|nread
argument_list|(
operator|&
name|c
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|)
operator|)
operator|==
name|BROKENREAD
condition|)
block|{
operator|*
name|s
operator|=
literal|0
expr_stmt|;
name|error
argument_list|(
literal|"mgets %s"
argument_list|,
name|s
argument_list|)
expr_stmt|;
return|return
operator|(
literal|1
operator|)
return|;
block|}
if|if
condition|(
name|n
operator|==
literal|0
condition|)
break|break;
block|}
if|if
condition|(
name|c
operator|==
literal|' '
condition|)
break|break;
operator|*
name|s
operator|++
operator|=
name|c
expr_stmt|;
block|}
operator|*
name|s
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|nread
argument_list|(
operator|&
name|c
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|)
operator|==
name|BROKENREAD
condition|)
block|{
name|error
argument_list|(
literal|"mgets %s"
argument_list|,
name|s
argument_list|)
expr_stmt|;
return|return
operator|(
literal|1
operator|)
return|;
block|}
name|length
operator|-=
operator|(
name|s
operator|-
name|q
operator|+
literal|2
operator|)
expr_stmt|;
if|if
condition|(
name|length
operator|<
literal|0
condition|)
block|{
name|error
argument_list|(
literal|"length wrong1 %ld %s"
argument_list|,
name|length
argument_list|,
name|q
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_block

begin_macro
name|mgetcmd
argument_list|(
argument|s
argument_list|)
end_macro

begin_comment
comment|/* returns 0 if succeed, 1 otherwise */
end_comment

begin_decl_stmt
name|char
modifier|*
name|s
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|int
name|i
decl_stmt|,
name|n
decl_stmt|;
name|char
name|c
decl_stmt|;
name|i
operator|=
literal|0
expr_stmt|;
for|for
control|(
init|;
condition|;
control|)
block|{
if|if
condition|(
operator|(
name|n
operator|=
name|nread
argument_list|(
operator|&
name|c
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|)
operator|)
operator|==
name|BROKENREAD
condition|)
block|{
name|s
index|[
name|i
index|]
operator|=
literal|0
expr_stmt|;
name|error
argument_list|(
literal|"mgetcmd %s"
argument_list|,
name|s
argument_list|)
expr_stmt|;
return|return
operator|(
literal|1
operator|)
return|;
block|}
if|if
condition|(
name|n
operator|<=
literal|0
operator|||
name|c
operator|==
literal|'\n'
condition|)
break|break;
if|if
condition|(
name|c
operator|==
literal|'\\'
condition|)
block|{
if|if
condition|(
name|nread
argument_list|(
operator|&
name|c
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|)
operator|==
name|BROKENREAD
condition|)
block|{
name|s
index|[
name|i
index|]
operator|=
literal|0
expr_stmt|;
name|error
argument_list|(
literal|"mgetcmd %s"
argument_list|,
name|s
argument_list|)
expr_stmt|;
return|return
operator|(
literal|1
operator|)
return|;
block|}
name|length
operator|--
expr_stmt|;
block|}
name|s
index|[
name|i
operator|++
index|]
operator|=
name|c
expr_stmt|;
name|length
operator|--
expr_stmt|;
block|}
name|s
index|[
name|i
index|]
operator|=
literal|0
expr_stmt|;
name|length
operator|--
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_block

begin_macro
name|increment
argument_list|(
argument|s
argument_list|)
end_macro

begin_decl_stmt
name|char
modifier|*
name|s
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|int
name|i
decl_stmt|;
name|char
modifier|*
name|p
decl_stmt|;
name|i
operator|=
name|strlen
argument_list|(
name|s
argument_list|)
operator|-
literal|1
expr_stmt|;
while|while
condition|(
name|s
index|[
name|i
index|]
operator|==
literal|'9'
condition|)
name|i
operator|--
expr_stmt|;
if|if
condition|(
name|s
index|[
name|i
index|]
operator|<
literal|'0'
operator|||
name|s
index|[
name|i
index|]
operator|>
literal|'9'
condition|)
block|{
name|p
operator|=
name|s
operator|+
name|i
operator|+
literal|1
expr_stmt|;
while|while
condition|(
operator|*
name|p
condition|)
operator|*
name|p
operator|++
operator|=
literal|'0'
expr_stmt|;
return|return;
block|}
operator|(
name|s
index|[
name|i
index|]
operator|)
operator|++
expr_stmt|;
name|i
operator|++
expr_stmt|;
while|while
condition|(
name|s
index|[
name|i
index|]
condition|)
name|s
index|[
name|i
operator|++
index|]
operator|=
literal|'0'
expr_stmt|;
return|return;
block|}
end_block

begin_macro
name|pload
argument_list|(
argument|currt
argument_list|)
end_macro

begin_decl_stmt
name|long
name|currt
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|struct
name|tms
name|tbf
decl_stmt|;
specifier|static
name|long
name|out
init|=
literal|0L
decl_stmt|,
name|ocut
init|=
literal|0L
decl_stmt|,
name|ost
init|=
literal|0L
decl_stmt|,
name|ocst
init|=
literal|0L
decl_stmt|;
name|long
name|u
decl_stmt|,
name|s
decl_stmt|,
name|elapt
decl_stmt|;
name|double
name|br
decl_stmt|,
name|r
decl_stmt|,
name|ru
decl_stmt|,
name|rs
decl_stmt|;
name|char
modifier|*
name|str
decl_stmt|,
name|buf
index|[
name|BUFSIZ
index|]
decl_stmt|;
name|currt
operator|=
name|gettime
argument_list|()
expr_stmt|;
name|elapt
operator|=
name|currt
operator|-
name|dump
operator|.
name|shorttime
expr_stmt|;
name|times
argument_list|(
operator|&
name|tbf
argument_list|)
expr_stmt|;
name|u
operator|=
name|tbf
operator|.
name|tms_utime
operator|-
name|out
operator|+
name|tbf
operator|.
name|tms_cutime
operator|-
name|ocut
expr_stmt|;
name|s
operator|=
name|tbf
operator|.
name|tms_stime
operator|-
name|ost
operator|+
name|tbf
operator|.
name|tms_cstime
operator|-
name|ocst
expr_stmt|;
name|dump
operator|.
name|outime
operator|+=
name|u
expr_stmt|;
name|dump
operator|.
name|ostime
operator|+=
name|s
expr_stmt|;
name|r
operator|=
name|u
operator|+
name|s
expr_stmt|;
if|if
condition|(
name|elapt
operator|>
literal|0
condition|)
name|r
operator|=
operator|(
name|r
operator|/
name|elapt
operator|)
operator|*
literal|100.0
expr_stmt|;
else|else
name|r
operator|=
literal|0.0
expr_stmt|;
comment|/* adjust to be seconds */
name|r
operator|=
name|r
operator|/
literal|60.0
expr_stmt|;
name|ru
operator|=
name|u
operator|/
literal|60.0
expr_stmt|;
name|rs
operator|=
name|s
operator|/
literal|60.0
expr_stmt|;
name|str
operator|=
name|ctime
argument_list|(
operator|&
name|currt
argument_list|)
expr_stmt|;
name|str
index|[
name|strlen
argument_list|(
name|str
argument_list|)
operator|-
literal|5
index|]
operator|=
literal|0
expr_stmt|;
name|sprintf
argument_list|(
name|buf
argument_list|,
literal|"%s (%s):\t%4.1fu\t%4.1fs\t%5.2f\t%s\n"
argument_list|,
name|str
argument_list|,
name|longname
argument_list|(
name|remote
argument_list|)
argument_list|,
name|ru
argument_list|,
name|rs
argument_list|,
name|r
argument_list|,
name|comptime
argument_list|(
name|elapt
argument_list|)
argument_list|)
expr_stmt|;
name|addtodump
argument_list|(
name|remote
argument_list|,
literal|"%s"
argument_list|,
name|buf
argument_list|)
expr_stmt|;
name|br
operator|=
name|dump
operator|.
name|bytetot
expr_stmt|;
if|if
condition|(
name|dump
operator|.
name|elaptot
operator|>
literal|0
condition|)
name|br
operator|=
name|br
operator|/
name|dump
operator|.
name|elaptot
expr_stmt|;
else|else
name|br
operator|=
literal|0.0
expr_stmt|;
name|addtodump
argument_list|(
name|remote
argument_list|,
literal|"\tTrans.\t%.6ld bytes\t%4.1f bytes/sec\t%s"
argument_list|,
name|dump
operator|.
name|bytetot
argument_list|,
name|br
argument_list|,
name|comptime
argument_list|(
name|dump
operator|.
name|elaptot
argument_list|)
argument_list|)
expr_stmt|;
name|addtodump
argument_list|(
name|remote
argument_list|,
literal|" %s\n"
argument_list|,
name|comptime
argument_list|(
name|dump
operator|.
name|waittot
argument_list|)
argument_list|)
expr_stmt|;
name|dump
operator|.
name|shorttime
operator|=
name|currt
expr_stmt|;
name|dump
operator|.
name|waittot
operator|=
name|dump
operator|.
name|elaptot
operator|=
name|dump
operator|.
name|bytetot
operator|=
literal|0L
expr_stmt|;
name|out
operator|=
name|tbf
operator|.
name|tms_utime
expr_stmt|;
name|ocut
operator|=
name|tbf
operator|.
name|tms_cutime
expr_stmt|;
name|ost
operator|=
name|tbf
operator|.
name|tms_stime
expr_stmt|;
name|ocst
operator|=
name|tbf
operator|.
name|tms_cstime
expr_stmt|;
name|sprintf
argument_list|(
name|buf
argument_list|,
literal|"%s %c"
argument_list|,
name|NETQSTAT
argument_list|,
name|remote
argument_list|)
expr_stmt|;
name|system
argument_list|(
name|buf
argument_list|)
expr_stmt|;
comment|/* gather stats on netq len. */
block|}
end_block

begin_macro
name|dumpit
argument_list|(
argument|currt
argument_list|)
end_macro

begin_decl_stmt
name|long
name|currt
decl_stmt|;
end_decl_stmt

begin_block
block|{
specifier|register
name|int
name|ntot
decl_stmt|;
name|long
name|elapt
decl_stmt|;
name|double
name|r
decl_stmt|,
name|ru
decl_stmt|,
name|rs
decl_stmt|;
specifier|register
name|struct
name|dumpstruc
modifier|*
name|p
init|=
operator|&
name|dump
decl_stmt|;
specifier|register
name|char
modifier|*
name|tt
decl_stmt|;
name|tt
operator|=
name|ctime
argument_list|(
operator|&
name|currt
argument_list|)
expr_stmt|;
name|tt
index|[
name|strlen
argument_list|(
name|tt
argument_list|)
operator|-
literal|9
index|]
operator|=
literal|0
expr_stmt|;
name|elapt
operator|=
name|currt
operator|-
name|dump
operator|.
name|longtime
expr_stmt|;
name|r
operator|=
name|dump
operator|.
name|outime
operator|+
name|dump
operator|.
name|ostime
expr_stmt|;
if|if
condition|(
name|elapt
operator|>
literal|0
condition|)
name|r
operator|=
operator|(
name|r
operator|/
name|elapt
operator|)
operator|*
literal|100.0
expr_stmt|;
else|else
name|r
operator|=
literal|0.0
expr_stmt|;
name|ru
operator|=
name|dump
operator|.
name|outime
operator|/
literal|60.0
expr_stmt|;
name|rs
operator|=
name|dump
operator|.
name|ostime
operator|/
literal|60.0
expr_stmt|;
name|r
operator|=
name|r
operator|/
literal|60.0
expr_stmt|;
name|dump
operator|.
name|longtime
operator|=
name|dump
operator|.
name|shorttime
expr_stmt|;
name|ntot
operator|=
name|p
operator|->
name|nnetcp
operator|+
name|p
operator|->
name|nnetmail
operator|+
name|p
operator|->
name|nsmail
operator|+
name|p
operator|->
name|nnetlpr
operator|+
name|p
operator|->
name|nresp
operator|+
name|p
operator|->
name|nnet
expr_stmt|;
name|addtodump
argument_list|(
name|remote
argument_list|,
literal|"Daily statisics\t(%s):\nSummary:\n"
argument_list|,
name|tt
argument_list|)
expr_stmt|;
name|addtodump
argument_list|(
name|remote
argument_list|,
literal|"\t# sent %d\t# pass-thru %d\t# rcv %d:\t# netcp %d\n"
argument_list|,
name|p
operator|->
name|nsend
argument_list|,
name|p
operator|->
name|npass
argument_list|,
name|ntot
argument_list|,
name|p
operator|->
name|nnetcp
argument_list|)
expr_stmt|;
name|addtodump
argument_list|(
name|remote
argument_list|,
literal|"\t# netlpr %d\t# netmail %d\t# sendmail %d\t# resp %d\n"
argument_list|,
name|p
operator|->
name|nnetlpr
argument_list|,
name|p
operator|->
name|nnetmail
argument_list|,
name|p
operator|->
name|nsmail
argument_list|,
name|p
operator|->
name|nresp
argument_list|)
expr_stmt|;
name|addtodump
argument_list|(
name|remote
argument_list|,
literal|"Protocol summary:\n"
argument_list|)
expr_stmt|;
name|addtodump
argument_list|(
name|remote
argument_list|,
literal|"\t# pk sent %d\t# pk rcv %d\t# b sent %ld\t# b rcv %ld\n"
argument_list|,
name|p
operator|->
name|npacksent
argument_list|,
name|p
operator|->
name|npackrcv
argument_list|,
name|p
operator|->
name|nbytesent
argument_list|,
name|p
operator|->
name|nbytercv
argument_list|)
expr_stmt|;
name|addtodump
argument_list|(
name|remote
argument_list|,
literal|"\t# send fails %d\t# retrans %d\t# abn %d\t\t# cksum errs %d\n"
argument_list|,
name|p
operator|->
name|nsendfail
argument_list|,
name|p
operator|->
name|nretrans
argument_list|,
name|p
operator|->
name|nabnormal
argument_list|,
name|p
operator|->
name|ncksum
argument_list|)
expr_stmt|;
name|addtodump
argument_list|(
name|remote
argument_list|,
literal|"Load:\t\t\t\t%4.1fu\t%4.1fs\t%5.2f%%\t%s\n"
argument_list|,
name|ru
argument_list|,
name|rs
argument_list|,
name|r
argument_list|,
name|comptime
argument_list|(
name|elapt
argument_list|)
argument_list|)
expr_stmt|;
name|p
operator|->
name|nbytesent
operator|=
name|p
operator|->
name|nbytercv
operator|=
name|p
operator|->
name|outime
operator|=
name|p
operator|->
name|ostime
operator|=
literal|0L
expr_stmt|;
name|p
operator|->
name|nretrans
operator|=
name|p
operator|->
name|nloop
operator|=
name|p
operator|->
name|nabnormal
operator|=
name|p
operator|->
name|ncksum
operator|=
literal|0
expr_stmt|;
name|p
operator|->
name|npacksent
operator|=
name|p
operator|->
name|npackrcv
operator|=
name|p
operator|->
name|nnetcp
operator|=
name|p
operator|->
name|nnetmail
operator|=
literal|0
expr_stmt|;
name|p
operator|->
name|nsmail
operator|=
name|p
operator|->
name|nnetlpr
operator|=
name|p
operator|->
name|nnet
operator|=
name|p
operator|->
name|npass
operator|=
literal|0
expr_stmt|;
name|p
operator|->
name|nsend
operator|=
name|p
operator|->
name|nsendfail
operator|=
literal|0
expr_stmt|;
block|}
end_block

begin_comment
comment|/* returns 1 if n is ok, 0 if not */
end_comment

begin_macro
name|goodacctname
argument_list|(
argument|n
argument_list|)
end_macro

begin_decl_stmt
name|char
modifier|*
name|n
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|int
name|i
decl_stmt|;
name|i
operator|=
operator|-
literal|1
expr_stmt|;
while|while
condition|(
name|btable
index|[
operator|++
name|i
index|]
operator|.
name|bname
condition|)
if|if
condition|(
name|strcmp
argument_list|(
name|btable
index|[
name|i
index|]
operator|.
name|bname
argument_list|,
name|n
argument_list|)
operator|==
literal|0
operator|&&
name|local
operator|==
name|btable
index|[
name|i
index|]
operator|.
name|bmach
condition|)
return|return
operator|(
literal|0
operator|)
return|;
return|return
operator|(
literal|1
operator|)
return|;
block|}
end_block

begin_expr_stmt
name|demask
argument_list|(
name|s
argument_list|)
specifier|register
name|char
operator|*
name|s
expr_stmt|;
end_expr_stmt

begin_block
block|{
ifdef|#
directive|ifdef
name|OLDPROT
while|while
condition|(
operator|*
name|s
condition|)
block|{
operator|*
name|s
operator|&=
literal|0177
expr_stmt|;
comment|/* strip quote bites */
operator|*
name|s
operator|++
operator|^=
literal|040
expr_stmt|;
comment|/* invert upper-lower */
block|}
else|#
directive|else
specifier|static
name|char
name|buf
index|[
literal|20
index|]
decl_stmt|;
name|strcpy
argument_list|(
name|s
argument_list|,
name|nbsdecrypt
argument_list|(
name|s
argument_list|,
name|THEKEY
argument_list|,
name|buf
argument_list|)
argument_list|)
expr_stmt|;
endif|#
directive|endif
block|}
end_block

begin_comment
comment|/*VARARGS0*/
end_comment

begin_macro
name|mreopen
argument_list|(
argument|f
argument_list|,
argument|a
argument_list|,
argument|b
argument_list|,
argument|c
argument_list|)
end_macro

begin_block
block|{
comment|/* simply handles errors by giving error msg */
if|if
condition|(
name|freopen
argument_list|(
name|a
argument_list|,
name|b
argument_list|,
name|c
argument_list|)
operator|==
name|NULL
condition|)
name|errormsg
argument_list|(
name|f
argument_list|,
literal|"%s: %s"
argument_list|,
name|a
argument_list|,
name|sys_errlist
index|[
name|errno
index|]
argument_list|)
expr_stmt|;
block|}
end_block

begin_comment
comment|/*VARARGS0*/
end_comment

begin_macro
name|addtopublic
argument_list|(
argument|s
argument_list|,
argument|a
argument_list|,
argument|b
argument_list|,
argument|c
argument_list|,
argument|d
argument_list|,
argument|e
argument_list|,
argument|f
argument_list|,
argument|g
argument_list|,
argument|h
argument_list|,
argument|i
argument_list|,
argument|j
argument_list|,
argument|k
argument_list|,
argument|l
argument_list|,
argument|m
argument_list|,
argument|n
argument_list|)
end_macro

begin_decl_stmt
name|char
modifier|*
name|s
decl_stmt|;
end_decl_stmt

begin_block
block|{
specifier|static
name|FILE
modifier|*
name|log
init|=
name|NULL
decl_stmt|;
if|if
condition|(
name|log
operator|==
name|NULL
condition|)
block|{
if|if
condition|(
name|stat
argument_list|(
name|publogfile
argument_list|,
operator|&
name|statbuf
argument_list|)
operator|<
literal|0
condition|)
return|return;
name|log
operator|=
name|fopen
argument_list|(
name|publogfile
argument_list|,
literal|"a"
argument_list|)
expr_stmt|;
if|if
condition|(
name|log
operator|==
name|NULL
condition|)
return|return;
block|}
name|fseek
argument_list|(
name|log
argument_list|,
literal|0L
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|log
argument_list|,
name|s
argument_list|,
name|a
argument_list|,
name|b
argument_list|,
name|c
argument_list|,
name|d
argument_list|,
name|e
argument_list|,
name|f
argument_list|,
name|g
argument_list|,
name|h
argument_list|,
name|i
argument_list|,
name|j
argument_list|,
name|k
argument_list|,
name|l
argument_list|,
name|m
argument_list|,
name|n
argument_list|)
expr_stmt|;
name|fflush
argument_list|(
name|log
argument_list|)
expr_stmt|;
block|}
end_block

begin_comment
comment|/*VARARGS0*/
end_comment

begin_macro
name|addtodump
argument_list|(
argument|mach
argument_list|,
argument|str
argument_list|,
argument|a
argument_list|,
argument|b
argument_list|,
argument|c
argument_list|,
argument|d
argument_list|,
argument|e
argument_list|,
argument|f
argument_list|,
argument|g
argument_list|,
argument|h
argument_list|,
argument|i
argument_list|,
argument|j
argument_list|,
argument|k
argument_list|,
argument|l
argument_list|,
argument|m
argument_list|,
argument|n
argument_list|,
argument|o
argument_list|,
argument|p
argument_list|,
argument|q
argument_list|,
argument|r
argument_list|,
argument|t
argument_list|,
argument|u
argument_list|)
end_macro

begin_decl_stmt
name|char
modifier|*
name|str
decl_stmt|;
end_decl_stmt

begin_block
block|{
specifier|static
name|FILE
modifier|*
name|log
init|=
name|NULL
decl_stmt|;
name|dumpfile
index|[
name|strlen
argument_list|(
name|dumpfile
argument_list|)
operator|-
literal|1
index|]
operator|=
name|mach
expr_stmt|;
if|if
condition|(
name|log
operator|==
name|NULL
condition|)
block|{
if|if
condition|(
name|stat
argument_list|(
name|dumpfile
argument_list|,
operator|&
name|statbuf
argument_list|)
operator|<
literal|0
condition|)
return|return;
name|log
operator|=
name|fopen
argument_list|(
name|dumpfile
argument_list|,
literal|"a"
argument_list|)
expr_stmt|;
if|if
condition|(
name|log
operator|==
name|NULL
condition|)
return|return;
block|}
name|fseek
argument_list|(
name|log
argument_list|,
literal|0L
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|log
argument_list|,
name|str
argument_list|,
name|a
argument_list|,
name|b
argument_list|,
name|c
argument_list|,
name|d
argument_list|,
name|e
argument_list|,
name|f
argument_list|,
name|g
argument_list|,
name|h
argument_list|,
name|i
argument_list|,
name|j
argument_list|,
name|k
argument_list|,
name|l
argument_list|,
name|m
argument_list|,
name|n
argument_list|,
name|o
argument_list|,
name|p
argument_list|,
name|q
argument_list|,
name|r
argument_list|,
name|t
argument_list|,
name|u
argument_list|)
expr_stmt|;
name|fflush
argument_list|(
name|log
argument_list|)
expr_stmt|;
block|}
end_block

begin_comment
comment|/* set up a dummy environment for v7 /bin/sh */
end_comment

begin_macro
name|setenv
argument_list|(
argument|home
argument_list|)
end_macro

begin_decl_stmt
name|char
modifier|*
name|home
decl_stmt|;
end_decl_stmt

begin_block
block|{
specifier|static
name|char
modifier|*
name|env
index|[
literal|3
index|]
decl_stmt|,
name|benv
index|[
literal|2
index|]
index|[
literal|50
index|]
decl_stmt|;
name|env
index|[
literal|0
index|]
operator|=
name|benv
index|[
literal|0
index|]
expr_stmt|;
name|env
index|[
literal|1
index|]
operator|=
name|benv
index|[
literal|1
index|]
expr_stmt|;
name|strcpy
argument_list|(
name|env
index|[
literal|0
index|]
argument_list|,
literal|"PATH=:/bin:/usr/bin"
argument_list|)
expr_stmt|;
name|sprintf
argument_list|(
name|env
index|[
literal|1
index|]
argument_list|,
literal|"HOME=%s"
argument_list|,
name|home
argument_list|)
expr_stmt|;
name|env
index|[
literal|2
index|]
operator|=
literal|0
expr_stmt|;
name|environ
operator|=
name|env
expr_stmt|;
block|}
end_block

begin_comment
comment|/* errormsg- sends error message to user-    may be on local or remote machine */
end_comment

begin_comment
comment|/*VARARGS0*/
end_comment

begin_macro
name|errormsg
argument_list|(
argument|fmach
argument_list|,
argument|s
argument_list|,
argument|a
argument_list|,
argument|b
argument_list|,
argument|c
argument_list|,
argument|d
argument_list|,
argument|e
argument_list|,
argument|f
argument_list|,
argument|g
argument_list|,
argument|h
argument_list|)
end_macro

begin_decl_stmt
name|char
modifier|*
name|s
decl_stmt|;
end_decl_stmt

begin_block
block|{
comment|/* can't use -w,-x,-y,-z because must be root for those */
name|int
name|rcode
decl_stmt|;
name|char
name|buf
index|[
name|BFS
operator|*
literal|2
index|]
decl_stmt|,
name|buf1
index|[
name|BFS
operator|*
literal|2
index|]
decl_stmt|;
if|if
condition|(
name|fmach
operator|<
literal|'a'
operator|||
literal|'z'
operator|<
name|fmach
condition|)
name|fmach
operator|=
name|local
expr_stmt|;
if|if
condition|(
name|ttystr
index|[
literal|0
index|]
operator|==
literal|0
condition|)
name|strcpy
argument_list|(
name|ttystr
argument_list|,
literal|"/dev/ttyx"
argument_list|)
expr_stmt|;
if|if
condition|(
name|fmach
operator|==
name|local
operator|&&
name|status
operator|.
name|login
index|[
literal|0
index|]
condition|)
name|strcpy
argument_list|(
name|status
operator|.
name|localname
argument_list|,
name|status
operator|.
name|login
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|.
name|localname
index|[
literal|0
index|]
operator|==
literal|0
condition|)
name|strcpy
argument_list|(
name|status
operator|.
name|localname
argument_list|,
name|status
operator|.
name|login
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|.
name|localname
index|[
literal|0
index|]
operator|==
literal|0
operator|||
name|strcmp
argument_list|(
name|status
operator|.
name|localname
argument_list|,
literal|"root"
argument_list|)
operator|==
literal|0
condition|)
name|strcpy
argument_list|(
name|status
operator|.
name|localname
argument_list|,
literal|"schmidt"
argument_list|)
expr_stmt|;
comment|/* will send to localname on fmach machine */
comment|/* in case of error, send to "schmidt" */
comment|/* error messages should never be sent to root */
name|sprintf
argument_list|(
name|buf
argument_list|,
literal|"Error: Cmd: %s Message: "
argument_list|,
name|realcmd
argument_list|)
expr_stmt|;
name|sprintf
argument_list|(
name|buf1
argument_list|,
name|s
argument_list|,
name|a
argument_list|,
name|b
argument_list|,
name|c
argument_list|,
name|d
argument_list|,
name|e
argument_list|,
name|f
argument_list|,
name|g
argument_list|,
name|h
argument_list|)
expr_stmt|;
name|strcat
argument_list|(
name|buf
argument_list|,
name|buf1
argument_list|)
expr_stmt|;
name|strcat
argument_list|(
name|buf
argument_list|,
literal|"\n"
argument_list|)
expr_stmt|;
name|addtolog
argument_list|(
name|remote
argument_list|,
name|buf
argument_list|)
expr_stmt|;
if|if
condition|(
name|fmach
operator|==
name|local
condition|)
name|sprintf
argument_list|(
name|buf1
argument_list|,
literal|"echo \"%s\" | %s %s %s %lo %c %s"
argument_list|,
name|buf
argument_list|,
name|writecmd
argument_list|,
name|status
operator|.
name|localname
argument_list|,
name|ttystr
argument_list|,
name|ltime
argument_list|,
name|local
argument_list|,
name|status
operator|.
name|login
argument_list|)
expr_stmt|;
else|else
name|sprintf
argument_list|(
name|buf1
argument_list|,
literal|"echo \"%s\" | %s -m%c -n -c response -l network -p \"\" - %s %s %s %lo %c %s"
argument_list|,
name|buf
argument_list|,
name|netcmd
argument_list|,
name|fmach
argument_list|,
name|writecmd
argument_list|,
name|status
operator|.
name|localname
argument_list|,
name|ttystr
argument_list|,
name|ltime
argument_list|,
name|local
argument_list|,
name|status
operator|.
name|login
argument_list|)
expr_stmt|;
name|rcode
operator|=
name|system
argument_list|(
name|buf1
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
end_block

begin_macro
name|handlekill
argument_list|()
end_macro

begin_block
block|{
comment|/* SIGTERM signal */
name|long
name|t
decl_stmt|;
name|addtodump
argument_list|(
name|remote
argument_list|,
literal|"Netdaemon terminated.\n"
argument_list|)
expr_stmt|;
name|t
operator|=
name|gettime
argument_list|()
expr_stmt|;
name|pload
argument_list|(
name|t
argument_list|)
expr_stmt|;
name|dumpit
argument_list|(
name|t
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|0
argument_list|)
expr_stmt|;
comment|/* kill myself */
block|}
end_block

begin_macro
name|spacct
argument_list|(
argument|log
argument_list|,
argument|pass
argument_list|,
argument|localname
argument_list|,
argument|luid
argument_list|,
argument|lgid
argument_list|)
end_macro

begin_comment
comment|/* returns 1 if login ok, 0 if not */
end_comment

begin_decl_stmt
name|char
modifier|*
name|log
decl_stmt|,
modifier|*
name|pass
decl_stmt|,
modifier|*
name|localname
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|long
name|lt
decl_stmt|;
name|int
name|u
decl_stmt|,
name|g
decl_stmt|;
if|if
condition|(
name|strcmp
argument_list|(
name|log
argument_list|,
literal|"network"
argument_list|)
operator|==
literal|0
condition|)
return|return
operator|(
literal|1
operator|)
return|;
comment|/* experimental */
ifdef|#
directive|ifdef
name|SPACCT
if|if
condition|(
name|strcmp
argument_list|(
name|log
argument_list|,
name|localname
argument_list|)
operator|==
literal|0
operator|&&
name|luid
operator|!=
literal|0
operator|&&
name|lgid
operator|==
literal|0
operator|&&
name|isdigit
argument_list|(
name|pass
index|[
literal|0
index|]
argument_list|)
operator|&&
operator|(
name|strcmp
argument_list|(
name|log
argument_list|,
literal|"source"
argument_list|)
operator|==
literal|0
operator|||
name|strcmp
argument_list|(
name|log
argument_list|,
literal|"daemon"
argument_list|)
operator|==
literal|0
operator|)
condition|)
block|{
comment|/* login name is same on both machines, userid is group 0, 		non-root, the password is numeric 		and the login name is one of a select few */
name|lt
operator|=
name|atol
argument_list|(
name|pass
argument_list|)
expr_stmt|;
name|u
operator|=
operator|(
name|lt
operator|&
literal|0177777
operator|)
expr_stmt|;
name|g
operator|=
operator|(
name|lt
operator|>>
literal|16
operator|)
expr_stmt|;
if|if
condition|(
operator|(
name|luid
operator|==
name|u
operator|)
operator|&&
operator|(
name|lgid
operator|==
name|g
operator|)
condition|)
return|return
operator|(
literal|1
operator|)
return|;
block|}
endif|#
directive|endif
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_block

begin_comment
comment|/* add the user's name to our name list */
end_comment

begin_comment
comment|/*VARARGS0*/
end_comment

begin_macro
name|addtoname
argument_list|(
argument|name
argument_list|)
end_macro

begin_decl_stmt
name|char
modifier|*
name|name
decl_stmt|;
end_decl_stmt

begin_block
block|{
specifier|static
name|FILE
modifier|*
name|log
init|=
name|NULL
decl_stmt|;
if|if
condition|(
name|name
operator|==
literal|0
operator|||
name|name
index|[
literal|0
index|]
operator|==
literal|0
operator|||
name|strcmp
argument_list|(
name|name
argument_list|,
literal|"root"
argument_list|)
operator|==
literal|0
operator|||
name|strcmp
argument_list|(
name|name
argument_list|,
literal|"network"
argument_list|)
operator|==
literal|0
operator|||
name|strcmp
argument_list|(
name|name
argument_list|,
literal|"schmidt"
argument_list|)
operator|==
literal|0
condition|)
return|return;
if|if
condition|(
name|log
operator|==
name|NULL
condition|)
block|{
if|if
condition|(
name|stat
argument_list|(
name|namefile
argument_list|,
operator|&
name|statbuf
argument_list|)
operator|<
literal|0
condition|)
return|return;
name|log
operator|=
name|fopen
argument_list|(
name|namefile
argument_list|,
literal|"a"
argument_list|)
expr_stmt|;
if|if
condition|(
name|log
operator|==
name|NULL
condition|)
return|return;
block|}
name|fseek
argument_list|(
name|log
argument_list|,
literal|0L
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|log
argument_list|,
literal|"%s:%s\n"
argument_list|,
name|longname
argument_list|(
name|local
argument_list|)
argument_list|,
name|name
argument_list|)
expr_stmt|;
name|fflush
argument_list|(
name|log
argument_list|)
expr_stmt|;
block|}
end_block

end_unit


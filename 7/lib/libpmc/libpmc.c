begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*-  * Copyright (c) 2003-2006 Joseph Koshy  * All rights reserved.  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions  * are met:  * 1. Redistributions of source code must retain the above copyright  *    notice, this list of conditions and the following disclaimer.  * 2. Redistributions in binary form must reproduce the above copyright  *    notice, this list of conditions and the following disclaimer in the  *    documentation and/or other materials provided with the distribution.  *  * THIS SOFTWARE IS PROVIDED BY THE AUTHOR AND CONTRIBUTORS ``AS IS'' AND  * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE  * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE  * ARE DISCLAIMED.  IN NO EVENT SHALL THE AUTHOR OR CONTRIBUTORS BE LIABLE  * FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL  * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS  * OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)  * HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT  * LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY  * OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF  * SUCH DAMAGE.  */
end_comment

begin_include
include|#
directive|include
file|<sys/cdefs.h>
end_include

begin_expr_stmt
name|__FBSDID
argument_list|(
literal|"$FreeBSD$"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_include
include|#
directive|include
file|<sys/types.h>
end_include

begin_include
include|#
directive|include
file|<sys/module.h>
end_include

begin_include
include|#
directive|include
file|<sys/pmc.h>
end_include

begin_include
include|#
directive|include
file|<sys/syscall.h>
end_include

begin_include
include|#
directive|include
file|<ctype.h>
end_include

begin_include
include|#
directive|include
file|<errno.h>
end_include

begin_include
include|#
directive|include
file|<fcntl.h>
end_include

begin_include
include|#
directive|include
file|<pmc.h>
end_include

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_include
include|#
directive|include
file|<stdlib.h>
end_include

begin_include
include|#
directive|include
file|<string.h>
end_include

begin_include
include|#
directive|include
file|<strings.h>
end_include

begin_include
include|#
directive|include
file|<unistd.h>
end_include

begin_comment
comment|/* Function prototypes */
end_comment

begin_if
if|#
directive|if
name|defined
argument_list|(
name|__i386__
argument_list|)
end_if

begin_function_decl
specifier|static
name|int
name|k7_allocate_pmc
parameter_list|(
name|enum
name|pmc_event
name|_pe
parameter_list|,
name|char
modifier|*
name|_ctrspec
parameter_list|,
name|struct
name|pmc_op_pmcallocate
modifier|*
name|_pmc_config
parameter_list|)
function_decl|;
end_function_decl

begin_endif
endif|#
directive|endif
end_endif

begin_if
if|#
directive|if
name|defined
argument_list|(
name|__amd64__
argument_list|)
operator|||
name|defined
argument_list|(
name|__i386__
argument_list|)
end_if

begin_function_decl
specifier|static
name|int
name|k8_allocate_pmc
parameter_list|(
name|enum
name|pmc_event
name|_pe
parameter_list|,
name|char
modifier|*
name|_ctrspec
parameter_list|,
name|struct
name|pmc_op_pmcallocate
modifier|*
name|_pmc_config
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|p4_allocate_pmc
parameter_list|(
name|enum
name|pmc_event
name|_pe
parameter_list|,
name|char
modifier|*
name|_ctrspec
parameter_list|,
name|struct
name|pmc_op_pmcallocate
modifier|*
name|_pmc_config
parameter_list|)
function_decl|;
end_function_decl

begin_endif
endif|#
directive|endif
end_endif

begin_if
if|#
directive|if
name|defined
argument_list|(
name|__i386__
argument_list|)
end_if

begin_function_decl
specifier|static
name|int
name|p5_allocate_pmc
parameter_list|(
name|enum
name|pmc_event
name|_pe
parameter_list|,
name|char
modifier|*
name|_ctrspec
parameter_list|,
name|struct
name|pmc_op_pmcallocate
modifier|*
name|_pmc_config
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|p6_allocate_pmc
parameter_list|(
name|enum
name|pmc_event
name|_pe
parameter_list|,
name|char
modifier|*
name|_ctrspec
parameter_list|,
name|struct
name|pmc_op_pmcallocate
modifier|*
name|_pmc_config
parameter_list|)
function_decl|;
end_function_decl

begin_endif
endif|#
directive|endif
end_endif

begin_define
define|#
directive|define
name|PMC_CALL
parameter_list|(
name|cmd
parameter_list|,
name|params
parameter_list|)
define|\
value|syscall(pmc_syscall, PMC_OP_##cmd, (params))
end_define

begin_comment
comment|/*  * Event aliases provide a way for the user to ask for generic events  * like "cache-misses", or "instructions-retired".  These aliases are  * mapped to the appropriate canonical event descriptions using a  * lookup table.  */
end_comment

begin_struct
struct|struct
name|pmc_event_alias
block|{
specifier|const
name|char
modifier|*
name|pm_alias
decl_stmt|;
specifier|const
name|char
modifier|*
name|pm_spec
decl_stmt|;
block|}
struct|;
end_struct

begin_decl_stmt
specifier|static
specifier|const
name|struct
name|pmc_event_alias
modifier|*
name|pmc_mdep_event_aliases
decl_stmt|;
end_decl_stmt

begin_comment
comment|/*  * The pmc_event_descr table maps symbolic names known to the user  * to integer codes used by the PMC KLD.  */
end_comment

begin_struct
struct|struct
name|pmc_event_descr
block|{
specifier|const
name|char
modifier|*
name|pm_ev_name
decl_stmt|;
name|enum
name|pmc_event
name|pm_ev_code
decl_stmt|;
name|enum
name|pmc_class
name|pm_ev_class
decl_stmt|;
block|}
struct|;
end_struct

begin_decl_stmt
specifier|static
specifier|const
name|struct
name|pmc_event_descr
name|pmc_event_table
index|[]
init|=
block|{
undef|#
directive|undef
name|__PMC_EV
define|#
directive|define
name|__PMC_EV
parameter_list|(
name|C
parameter_list|,
name|N
parameter_list|,
name|EV
parameter_list|)
value|{ #EV, PMC_EV_ ## C ## _ ## N, PMC_CLASS_ ## C },
name|__PMC_EVENTS
argument_list|()
block|}
decl_stmt|;
end_decl_stmt

begin_comment
comment|/*  * Mapping tables, mapping enumeration values to human readable  * strings.  */
end_comment

begin_decl_stmt
specifier|static
specifier|const
name|char
modifier|*
name|pmc_capability_names
index|[]
init|=
block|{
undef|#
directive|undef
name|__PMC_CAP
define|#
directive|define
name|__PMC_CAP
parameter_list|(
name|N
parameter_list|,
name|V
parameter_list|,
name|D
parameter_list|)
value|#N ,
name|__PMC_CAPS
argument_list|()
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
specifier|const
name|char
modifier|*
name|pmc_class_names
index|[]
init|=
block|{
undef|#
directive|undef
name|__PMC_CLASS
define|#
directive|define
name|__PMC_CLASS
parameter_list|(
name|C
parameter_list|)
value|#C ,
name|__PMC_CLASSES
argument_list|()
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
specifier|const
name|char
modifier|*
name|pmc_cputype_names
index|[]
init|=
block|{
undef|#
directive|undef
name|__PMC_CPU
define|#
directive|define
name|__PMC_CPU
parameter_list|(
name|S
parameter_list|,
name|D
parameter_list|)
value|#S ,
name|__PMC_CPUS
argument_list|()
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
specifier|const
name|char
modifier|*
name|pmc_disposition_names
index|[]
init|=
block|{
undef|#
directive|undef
name|__PMC_DISP
define|#
directive|define
name|__PMC_DISP
parameter_list|(
name|D
parameter_list|)
value|#D ,
name|__PMC_DISPOSITIONS
argument_list|()
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
specifier|const
name|char
modifier|*
name|pmc_mode_names
index|[]
init|=
block|{
undef|#
directive|undef
name|__PMC_MODE
define|#
directive|define
name|__PMC_MODE
parameter_list|(
name|M
parameter_list|,
name|N
parameter_list|)
value|#M ,
name|__PMC_MODES
argument_list|()
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
specifier|const
name|char
modifier|*
name|pmc_state_names
index|[]
init|=
block|{
undef|#
directive|undef
name|__PMC_STATE
define|#
directive|define
name|__PMC_STATE
parameter_list|(
name|S
parameter_list|)
value|#S ,
name|__PMC_STATES
argument_list|()
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|pmc_syscall
init|=
operator|-
literal|1
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* filled in by pmc_init() */
end_comment

begin_decl_stmt
specifier|static
name|struct
name|pmc_cpuinfo
name|cpu_info
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* filled in by pmc_init() */
end_comment

begin_comment
comment|/* Architecture dependent event parsing */
end_comment

begin_function_decl
specifier|static
name|int
function_decl|(
modifier|*
name|pmc_mdep_allocate_pmc
function_decl|)
parameter_list|(
name|enum
name|pmc_event
name|_pe
parameter_list|,
name|char
modifier|*
name|_ctrspec
parameter_list|,
name|struct
name|pmc_op_pmcallocate
modifier|*
name|_pmc_config
parameter_list|)
function_decl|;
end_function_decl

begin_comment
comment|/* Event masks for events */
end_comment

begin_struct
struct|struct
name|pmc_masks
block|{
specifier|const
name|char
modifier|*
name|pm_name
decl_stmt|;
specifier|const
name|uint32_t
name|pm_value
decl_stmt|;
block|}
struct|;
end_struct

begin_define
define|#
directive|define
name|PMCMASK
parameter_list|(
name|N
parameter_list|,
name|V
parameter_list|)
value|{ .pm_name = #N, .pm_value = (V) }
end_define

begin_define
define|#
directive|define
name|NULLMASK
value|PMCMASK(NULL,0)
end_define

begin_if
if|#
directive|if
name|defined
argument_list|(
name|__amd64__
argument_list|)
operator|||
name|defined
argument_list|(
name|__i386__
argument_list|)
end_if

begin_function
specifier|static
name|int
name|pmc_parse_mask
parameter_list|(
specifier|const
name|struct
name|pmc_masks
modifier|*
name|pmask
parameter_list|,
name|char
modifier|*
name|p
parameter_list|,
name|uint32_t
modifier|*
name|evmask
parameter_list|)
block|{
specifier|const
name|struct
name|pmc_masks
modifier|*
name|pm
decl_stmt|;
name|char
modifier|*
name|q
decl_stmt|,
modifier|*
name|r
decl_stmt|;
name|int
name|c
decl_stmt|;
if|if
condition|(
name|pmask
operator|==
name|NULL
condition|)
comment|/* no mask keywords */
return|return
operator|-
literal|1
return|;
name|q
operator|=
name|strchr
argument_list|(
name|p
argument_list|,
literal|'='
argument_list|)
expr_stmt|;
comment|/* skip '=' */
if|if
condition|(
operator|*
operator|++
name|q
operator|==
literal|'\0'
condition|)
comment|/* no more data */
return|return
operator|-
literal|1
return|;
name|c
operator|=
literal|0
expr_stmt|;
comment|/* count of mask keywords seen */
while|while
condition|(
operator|(
name|r
operator|=
name|strsep
argument_list|(
operator|&
name|q
argument_list|,
literal|"+"
argument_list|)
operator|)
operator|!=
name|NULL
condition|)
block|{
for|for
control|(
name|pm
operator|=
name|pmask
init|;
name|pm
operator|->
name|pm_name
operator|&&
name|strcmp
argument_list|(
name|r
argument_list|,
name|pm
operator|->
name|pm_name
argument_list|)
condition|;
name|pm
operator|++
control|)
empty_stmt|;
if|if
condition|(
name|pm
operator|->
name|pm_name
operator|==
name|NULL
condition|)
comment|/* not found */
return|return
operator|-
literal|1
return|;
operator|*
name|evmask
operator||=
name|pm
operator|->
name|pm_value
expr_stmt|;
name|c
operator|++
expr_stmt|;
block|}
return|return
name|c
return|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_define
define|#
directive|define
name|KWMATCH
parameter_list|(
name|p
parameter_list|,
name|kw
parameter_list|)
value|(strcasecmp((p), (kw)) == 0)
end_define

begin_define
define|#
directive|define
name|KWPREFIXMATCH
parameter_list|(
name|p
parameter_list|,
name|kw
parameter_list|)
value|(strncasecmp((p), (kw), sizeof((kw)) - 1) == 0)
end_define

begin_define
define|#
directive|define
name|EV_ALIAS
parameter_list|(
name|N
parameter_list|,
name|S
parameter_list|)
value|{ .pm_alias = N, .pm_spec = S }
end_define

begin_if
if|#
directive|if
name|defined
argument_list|(
name|__i386__
argument_list|)
end_if

begin_comment
comment|/*  * AMD K7 (Athlon) CPUs.  */
end_comment

begin_decl_stmt
specifier|static
name|struct
name|pmc_event_alias
name|k7_aliases
index|[]
init|=
block|{
name|EV_ALIAS
argument_list|(
literal|"branches"
argument_list|,
literal|"k7-retired-branches"
argument_list|)
block|,
name|EV_ALIAS
argument_list|(
literal|"branch-mispredicts"
argument_list|,
literal|"k7-retired-branches-mispredicted"
argument_list|)
block|,
name|EV_ALIAS
argument_list|(
literal|"cycles"
argument_list|,
literal|"tsc"
argument_list|)
block|,
name|EV_ALIAS
argument_list|(
literal|"dc-misses"
argument_list|,
literal|"k7-dc-misses,mask=moesi"
argument_list|)
block|,
name|EV_ALIAS
argument_list|(
literal|"ic-misses"
argument_list|,
literal|"k7-ic-misses"
argument_list|)
block|,
name|EV_ALIAS
argument_list|(
literal|"instructions"
argument_list|,
literal|"k7-retired-instructions"
argument_list|)
block|,
name|EV_ALIAS
argument_list|(
literal|"interrupts"
argument_list|,
literal|"k7-hardware-interrupts"
argument_list|)
block|,
name|EV_ALIAS
argument_list|(
argument|NULL
argument_list|,
argument|NULL
argument_list|)
block|}
decl_stmt|;
end_decl_stmt

begin_define
define|#
directive|define
name|K7_KW_COUNT
value|"count"
end_define

begin_define
define|#
directive|define
name|K7_KW_EDGE
value|"edge"
end_define

begin_define
define|#
directive|define
name|K7_KW_INV
value|"inv"
end_define

begin_define
define|#
directive|define
name|K7_KW_OS
value|"os"
end_define

begin_define
define|#
directive|define
name|K7_KW_UNITMASK
value|"unitmask"
end_define

begin_define
define|#
directive|define
name|K7_KW_USR
value|"usr"
end_define

begin_function
specifier|static
name|int
name|k7_allocate_pmc
parameter_list|(
name|enum
name|pmc_event
name|pe
parameter_list|,
name|char
modifier|*
name|ctrspec
parameter_list|,
name|struct
name|pmc_op_pmcallocate
modifier|*
name|pmc_config
parameter_list|)
block|{
name|char
modifier|*
name|e
decl_stmt|,
modifier|*
name|p
decl_stmt|,
modifier|*
name|q
decl_stmt|;
name|int
name|c
decl_stmt|,
name|has_unitmask
decl_stmt|;
name|uint32_t
name|count
decl_stmt|,
name|unitmask
decl_stmt|;
name|pmc_config
operator|->
name|pm_md
operator|.
name|pm_amd
operator|.
name|pm_amd_config
operator|=
literal|0
expr_stmt|;
name|pmc_config
operator|->
name|pm_caps
operator||=
name|PMC_CAP_READ
expr_stmt|;
if|if
condition|(
name|pe
operator|==
name|PMC_EV_TSC_TSC
condition|)
block|{
comment|/* TSC events must be unqualified. */
if|if
condition|(
name|ctrspec
operator|&&
operator|*
name|ctrspec
operator|!=
literal|'\0'
condition|)
return|return
operator|-
literal|1
return|;
return|return
literal|0
return|;
block|}
if|if
condition|(
name|pe
operator|==
name|PMC_EV_K7_DC_REFILLS_FROM_L2
operator|||
name|pe
operator|==
name|PMC_EV_K7_DC_REFILLS_FROM_SYSTEM
operator|||
name|pe
operator|==
name|PMC_EV_K7_DC_WRITEBACKS
condition|)
block|{
name|has_unitmask
operator|=
literal|1
expr_stmt|;
name|unitmask
operator|=
name|AMD_PMC_UNITMASK_MOESI
expr_stmt|;
block|}
else|else
name|unitmask
operator|=
name|has_unitmask
operator|=
literal|0
expr_stmt|;
name|pmc_config
operator|->
name|pm_caps
operator||=
name|PMC_CAP_WRITE
expr_stmt|;
while|while
condition|(
operator|(
name|p
operator|=
name|strsep
argument_list|(
operator|&
name|ctrspec
argument_list|,
literal|","
argument_list|)
operator|)
operator|!=
name|NULL
condition|)
block|{
if|if
condition|(
name|KWPREFIXMATCH
argument_list|(
name|p
argument_list|,
name|K7_KW_COUNT
literal|"="
argument_list|)
condition|)
block|{
name|q
operator|=
name|strchr
argument_list|(
name|p
argument_list|,
literal|'='
argument_list|)
expr_stmt|;
if|if
condition|(
operator|*
operator|++
name|q
operator|==
literal|'\0'
condition|)
comment|/* skip '=' */
return|return
operator|-
literal|1
return|;
name|count
operator|=
name|strtol
argument_list|(
name|q
argument_list|,
operator|&
name|e
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|e
operator|==
name|q
operator|||
operator|*
name|e
operator|!=
literal|'\0'
condition|)
return|return
operator|-
literal|1
return|;
name|pmc_config
operator|->
name|pm_caps
operator||=
name|PMC_CAP_THRESHOLD
expr_stmt|;
name|pmc_config
operator|->
name|pm_md
operator|.
name|pm_amd
operator|.
name|pm_amd_config
operator||=
name|AMD_PMC_TO_COUNTER
argument_list|(
name|count
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|KWMATCH
argument_list|(
name|p
argument_list|,
name|K7_KW_EDGE
argument_list|)
condition|)
block|{
name|pmc_config
operator|->
name|pm_caps
operator||=
name|PMC_CAP_EDGE
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|KWMATCH
argument_list|(
name|p
argument_list|,
name|K7_KW_INV
argument_list|)
condition|)
block|{
name|pmc_config
operator|->
name|pm_caps
operator||=
name|PMC_CAP_INVERT
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|KWMATCH
argument_list|(
name|p
argument_list|,
name|K7_KW_OS
argument_list|)
condition|)
block|{
name|pmc_config
operator|->
name|pm_caps
operator||=
name|PMC_CAP_SYSTEM
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|KWPREFIXMATCH
argument_list|(
name|p
argument_list|,
name|K7_KW_UNITMASK
literal|"="
argument_list|)
condition|)
block|{
if|if
condition|(
name|has_unitmask
operator|==
literal|0
condition|)
return|return
operator|-
literal|1
return|;
name|unitmask
operator|=
literal|0
expr_stmt|;
name|q
operator|=
name|strchr
argument_list|(
name|p
argument_list|,
literal|'='
argument_list|)
expr_stmt|;
if|if
condition|(
operator|*
operator|++
name|q
operator|==
literal|'\0'
condition|)
comment|/* skip '=' */
return|return
operator|-
literal|1
return|;
while|while
condition|(
operator|(
name|c
operator|=
name|tolower
argument_list|(
operator|*
name|q
operator|++
argument_list|)
operator|)
operator|!=
literal|0
condition|)
if|if
condition|(
name|c
operator|==
literal|'m'
condition|)
name|unitmask
operator||=
name|AMD_PMC_UNITMASK_M
expr_stmt|;
elseif|else
if|if
condition|(
name|c
operator|==
literal|'o'
condition|)
name|unitmask
operator||=
name|AMD_PMC_UNITMASK_O
expr_stmt|;
elseif|else
if|if
condition|(
name|c
operator|==
literal|'e'
condition|)
name|unitmask
operator||=
name|AMD_PMC_UNITMASK_E
expr_stmt|;
elseif|else
if|if
condition|(
name|c
operator|==
literal|'s'
condition|)
name|unitmask
operator||=
name|AMD_PMC_UNITMASK_S
expr_stmt|;
elseif|else
if|if
condition|(
name|c
operator|==
literal|'i'
condition|)
name|unitmask
operator||=
name|AMD_PMC_UNITMASK_I
expr_stmt|;
elseif|else
if|if
condition|(
name|c
operator|==
literal|'+'
condition|)
continue|continue;
else|else
return|return
operator|-
literal|1
return|;
if|if
condition|(
name|unitmask
operator|==
literal|0
condition|)
return|return
operator|-
literal|1
return|;
block|}
elseif|else
if|if
condition|(
name|KWMATCH
argument_list|(
name|p
argument_list|,
name|K7_KW_USR
argument_list|)
condition|)
block|{
name|pmc_config
operator|->
name|pm_caps
operator||=
name|PMC_CAP_USER
expr_stmt|;
block|}
else|else
return|return
operator|-
literal|1
return|;
block|}
if|if
condition|(
name|has_unitmask
condition|)
block|{
name|pmc_config
operator|->
name|pm_caps
operator||=
name|PMC_CAP_QUALIFIER
expr_stmt|;
name|pmc_config
operator|->
name|pm_md
operator|.
name|pm_amd
operator|.
name|pm_amd_config
operator||=
name|AMD_PMC_TO_UNITMASK
argument_list|(
name|unitmask
argument_list|)
expr_stmt|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_if
if|#
directive|if
name|defined
argument_list|(
name|__amd64__
argument_list|)
operator|||
name|defined
argument_list|(
name|__i386__
argument_list|)
end_if

begin_comment
comment|/*  * AMD K8 PMCs.  *  * These are very similar to AMD K7 PMCs, but support more kinds of  * events.  */
end_comment

begin_decl_stmt
specifier|static
name|struct
name|pmc_event_alias
name|k8_aliases
index|[]
init|=
block|{
name|EV_ALIAS
argument_list|(
literal|"branches"
argument_list|,
literal|"k8-fr-retired-taken-branches"
argument_list|)
block|,
name|EV_ALIAS
argument_list|(
literal|"branch-mispredicts"
argument_list|,
literal|"k8-fr-retired-taken-branches-mispredicted"
argument_list|)
block|,
name|EV_ALIAS
argument_list|(
literal|"cycles"
argument_list|,
literal|"tsc"
argument_list|)
block|,
name|EV_ALIAS
argument_list|(
literal|"dc-misses"
argument_list|,
literal|"k8-dc-miss"
argument_list|)
block|,
name|EV_ALIAS
argument_list|(
literal|"ic-misses"
argument_list|,
literal|"k8-ic-miss"
argument_list|)
block|,
name|EV_ALIAS
argument_list|(
literal|"instructions"
argument_list|,
literal|"k8-fr-retired-x86-instructions"
argument_list|)
block|,
name|EV_ALIAS
argument_list|(
literal|"interrupts"
argument_list|,
literal|"k8-fr-taken-hardware-interrupts"
argument_list|)
block|,
name|EV_ALIAS
argument_list|(
literal|"unhalted-cycles"
argument_list|,
literal|"k8-bu-cpu-clk-unhalted"
argument_list|)
block|,
name|EV_ALIAS
argument_list|(
argument|NULL
argument_list|,
argument|NULL
argument_list|)
block|}
decl_stmt|;
end_decl_stmt

begin_define
define|#
directive|define
name|__K8MASK
parameter_list|(
name|N
parameter_list|,
name|V
parameter_list|)
value|PMCMASK(N,(1<< (V)))
end_define

begin_comment
comment|/*  * Parsing tables  */
end_comment

begin_comment
comment|/* fp dispatched fpu ops */
end_comment

begin_decl_stmt
specifier|static
specifier|const
name|struct
name|pmc_masks
name|k8_mask_fdfo
index|[]
init|=
block|{
name|__K8MASK
argument_list|(
name|add
operator|-
name|pipe
operator|-
name|excluding
operator|-
name|junk
operator|-
name|ops
argument_list|,
literal|0
argument_list|)
block|,
name|__K8MASK
argument_list|(
name|multiply
operator|-
name|pipe
operator|-
name|excluding
operator|-
name|junk
operator|-
name|ops
argument_list|,
literal|1
argument_list|)
block|,
name|__K8MASK
argument_list|(
name|store
operator|-
name|pipe
operator|-
name|excluding
operator|-
name|junk
operator|-
name|ops
argument_list|,
literal|2
argument_list|)
block|,
name|__K8MASK
argument_list|(
name|add
operator|-
name|pipe
operator|-
name|junk
operator|-
name|ops
argument_list|,
literal|3
argument_list|)
block|,
name|__K8MASK
argument_list|(
name|multiply
operator|-
name|pipe
operator|-
name|junk
operator|-
name|ops
argument_list|,
literal|4
argument_list|)
block|,
name|__K8MASK
argument_list|(
name|store
operator|-
name|pipe
operator|-
name|junk
operator|-
name|ops
argument_list|,
literal|5
argument_list|)
block|,
name|NULLMASK
block|}
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* ls segment register loads */
end_comment

begin_decl_stmt
specifier|static
specifier|const
name|struct
name|pmc_masks
name|k8_mask_lsrl
index|[]
init|=
block|{
name|__K8MASK
argument_list|(
name|es
argument_list|,
literal|0
argument_list|)
block|,
name|__K8MASK
argument_list|(
name|cs
argument_list|,
literal|1
argument_list|)
block|,
name|__K8MASK
argument_list|(
name|ss
argument_list|,
literal|2
argument_list|)
block|,
name|__K8MASK
argument_list|(
name|ds
argument_list|,
literal|3
argument_list|)
block|,
name|__K8MASK
argument_list|(
name|fs
argument_list|,
literal|4
argument_list|)
block|,
name|__K8MASK
argument_list|(
name|gs
argument_list|,
literal|5
argument_list|)
block|,
name|__K8MASK
argument_list|(
name|hs
argument_list|,
literal|6
argument_list|)
block|,
name|NULLMASK
block|}
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* ls locked operation */
end_comment

begin_decl_stmt
specifier|static
specifier|const
name|struct
name|pmc_masks
name|k8_mask_llo
index|[]
init|=
block|{
name|__K8MASK
argument_list|(
name|locked
operator|-
name|instructions
argument_list|,
literal|0
argument_list|)
block|,
name|__K8MASK
argument_list|(
name|cycles
operator|-
name|in
operator|-
name|request
argument_list|,
literal|1
argument_list|)
block|,
name|__K8MASK
argument_list|(
name|cycles
operator|-
name|to
operator|-
name|complete
argument_list|,
literal|2
argument_list|)
block|,
name|NULLMASK
block|}
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* dc refill from {l2,system} and dc copyback */
end_comment

begin_decl_stmt
specifier|static
specifier|const
name|struct
name|pmc_masks
name|k8_mask_dc
index|[]
init|=
block|{
name|__K8MASK
argument_list|(
name|invalid
argument_list|,
literal|0
argument_list|)
block|,
name|__K8MASK
argument_list|(
name|shared
argument_list|,
literal|1
argument_list|)
block|,
name|__K8MASK
argument_list|(
name|exclusive
argument_list|,
literal|2
argument_list|)
block|,
name|__K8MASK
argument_list|(
name|owner
argument_list|,
literal|3
argument_list|)
block|,
name|__K8MASK
argument_list|(
name|modified
argument_list|,
literal|4
argument_list|)
block|,
name|NULLMASK
block|}
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* dc one bit ecc error */
end_comment

begin_decl_stmt
specifier|static
specifier|const
name|struct
name|pmc_masks
name|k8_mask_dobee
index|[]
init|=
block|{
name|__K8MASK
argument_list|(
name|scrubber
argument_list|,
literal|0
argument_list|)
block|,
name|__K8MASK
argument_list|(
name|piggyback
argument_list|,
literal|1
argument_list|)
block|,
name|NULLMASK
block|}
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* dc dispatched prefetch instructions */
end_comment

begin_decl_stmt
specifier|static
specifier|const
name|struct
name|pmc_masks
name|k8_mask_ddpi
index|[]
init|=
block|{
name|__K8MASK
argument_list|(
name|load
argument_list|,
literal|0
argument_list|)
block|,
name|__K8MASK
argument_list|(
name|store
argument_list|,
literal|1
argument_list|)
block|,
name|__K8MASK
argument_list|(
name|nta
argument_list|,
literal|2
argument_list|)
block|,
name|NULLMASK
block|}
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* dc dcache accesses by locks */
end_comment

begin_decl_stmt
specifier|static
specifier|const
name|struct
name|pmc_masks
name|k8_mask_dabl
index|[]
init|=
block|{
name|__K8MASK
argument_list|(
name|accesses
argument_list|,
literal|0
argument_list|)
block|,
name|__K8MASK
argument_list|(
name|misses
argument_list|,
literal|1
argument_list|)
block|,
name|NULLMASK
block|}
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* bu internal l2 request */
end_comment

begin_decl_stmt
specifier|static
specifier|const
name|struct
name|pmc_masks
name|k8_mask_bilr
index|[]
init|=
block|{
name|__K8MASK
argument_list|(
name|ic
operator|-
name|fill
argument_list|,
literal|0
argument_list|)
block|,
name|__K8MASK
argument_list|(
name|dc
operator|-
name|fill
argument_list|,
literal|1
argument_list|)
block|,
name|__K8MASK
argument_list|(
name|tlb
operator|-
name|reload
argument_list|,
literal|2
argument_list|)
block|,
name|__K8MASK
argument_list|(
name|tag
operator|-
name|snoop
argument_list|,
literal|3
argument_list|)
block|,
name|__K8MASK
argument_list|(
name|cancelled
argument_list|,
literal|4
argument_list|)
block|,
name|NULLMASK
block|}
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* bu fill request l2 miss */
end_comment

begin_decl_stmt
specifier|static
specifier|const
name|struct
name|pmc_masks
name|k8_mask_bfrlm
index|[]
init|=
block|{
name|__K8MASK
argument_list|(
name|ic
operator|-
name|fill
argument_list|,
literal|0
argument_list|)
block|,
name|__K8MASK
argument_list|(
name|dc
operator|-
name|fill
argument_list|,
literal|1
argument_list|)
block|,
name|__K8MASK
argument_list|(
name|tlb
operator|-
name|reload
argument_list|,
literal|2
argument_list|)
block|,
name|NULLMASK
block|}
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* bu fill into l2 */
end_comment

begin_decl_stmt
specifier|static
specifier|const
name|struct
name|pmc_masks
name|k8_mask_bfil
index|[]
init|=
block|{
name|__K8MASK
argument_list|(
name|dirty
operator|-
name|l2
operator|-
name|victim
argument_list|,
literal|0
argument_list|)
block|,
name|__K8MASK
argument_list|(
name|victim
operator|-
name|from
operator|-
name|l2
argument_list|,
literal|1
argument_list|)
block|,
name|NULLMASK
block|}
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* fr retired fpu instructions */
end_comment

begin_decl_stmt
specifier|static
specifier|const
name|struct
name|pmc_masks
name|k8_mask_frfi
index|[]
init|=
block|{
name|__K8MASK
argument_list|(
name|x87
argument_list|,
literal|0
argument_list|)
block|,
name|__K8MASK
argument_list|(
name|mmx
operator|-
literal|3dnow
argument_list|,
literal|1
argument_list|)
block|,
name|__K8MASK
argument_list|(
name|packed
operator|-
name|sse
operator|-
name|sse2
argument_list|,
literal|2
argument_list|)
block|,
name|__K8MASK
argument_list|(
name|scalar
operator|-
name|sse
operator|-
name|sse2
argument_list|,
literal|3
argument_list|)
block|,
name|NULLMASK
block|}
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* fr retired fastpath double op instructions */
end_comment

begin_decl_stmt
specifier|static
specifier|const
name|struct
name|pmc_masks
name|k8_mask_frfdoi
index|[]
init|=
block|{
name|__K8MASK
argument_list|(
name|low
operator|-
name|op
operator|-
name|pos
operator|-
literal|0
argument_list|,
literal|0
argument_list|)
block|,
name|__K8MASK
argument_list|(
name|low
operator|-
name|op
operator|-
name|pos
operator|-
literal|1
argument_list|,
literal|1
argument_list|)
block|,
name|__K8MASK
argument_list|(
name|low
operator|-
name|op
operator|-
name|pos
operator|-
literal|2
argument_list|,
literal|2
argument_list|)
block|,
name|NULLMASK
block|}
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* fr fpu exceptions */
end_comment

begin_decl_stmt
specifier|static
specifier|const
name|struct
name|pmc_masks
name|k8_mask_ffe
index|[]
init|=
block|{
name|__K8MASK
argument_list|(
name|x87
operator|-
name|reclass
operator|-
name|microfaults
argument_list|,
literal|0
argument_list|)
block|,
name|__K8MASK
argument_list|(
name|sse
operator|-
name|retype
operator|-
name|microfaults
argument_list|,
literal|1
argument_list|)
block|,
name|__K8MASK
argument_list|(
name|sse
operator|-
name|reclass
operator|-
name|microfaults
argument_list|,
literal|2
argument_list|)
block|,
name|__K8MASK
argument_list|(
name|sse
operator|-
name|and
operator|-
name|x87
operator|-
name|microtraps
argument_list|,
literal|3
argument_list|)
block|,
name|NULLMASK
block|}
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* nb memory controller page access event */
end_comment

begin_decl_stmt
specifier|static
specifier|const
name|struct
name|pmc_masks
name|k8_mask_nmcpae
index|[]
init|=
block|{
name|__K8MASK
argument_list|(
name|page
operator|-
name|hit
argument_list|,
literal|0
argument_list|)
block|,
name|__K8MASK
argument_list|(
name|page
operator|-
name|miss
argument_list|,
literal|1
argument_list|)
block|,
name|__K8MASK
argument_list|(
name|page
operator|-
name|conflict
argument_list|,
literal|2
argument_list|)
block|,
name|NULLMASK
block|}
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* nb memory controller turnaround */
end_comment

begin_decl_stmt
specifier|static
specifier|const
name|struct
name|pmc_masks
name|k8_mask_nmct
index|[]
init|=
block|{
name|__K8MASK
argument_list|(
name|dimm
operator|-
name|turnaround
argument_list|,
literal|0
argument_list|)
block|,
name|__K8MASK
argument_list|(
name|read
operator|-
name|to
operator|-
name|write
operator|-
name|turnaround
argument_list|,
literal|1
argument_list|)
block|,
name|__K8MASK
argument_list|(
name|write
operator|-
name|to
operator|-
name|read
operator|-
name|turnaround
argument_list|,
literal|2
argument_list|)
block|,
name|NULLMASK
block|}
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* nb memory controller bypass saturation */
end_comment

begin_decl_stmt
specifier|static
specifier|const
name|struct
name|pmc_masks
name|k8_mask_nmcbs
index|[]
init|=
block|{
name|__K8MASK
argument_list|(
name|memory
operator|-
name|controller
operator|-
name|hi
operator|-
name|pri
operator|-
name|bypass
argument_list|,
literal|0
argument_list|)
block|,
name|__K8MASK
argument_list|(
name|memory
operator|-
name|controller
operator|-
name|lo
operator|-
name|pri
operator|-
name|bypass
argument_list|,
literal|1
argument_list|)
block|,
name|__K8MASK
argument_list|(
name|dram
operator|-
name|controller
operator|-
name|interface
operator|-
name|bypass
argument_list|,
literal|2
argument_list|)
block|,
name|__K8MASK
argument_list|(
name|dram
operator|-
name|controller
operator|-
name|queue
operator|-
name|bypass
argument_list|,
literal|3
argument_list|)
block|,
name|NULLMASK
block|}
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* nb sized commands */
end_comment

begin_decl_stmt
specifier|static
specifier|const
name|struct
name|pmc_masks
name|k8_mask_nsc
index|[]
init|=
block|{
name|__K8MASK
argument_list|(
name|nonpostwrszbyte
argument_list|,
literal|0
argument_list|)
block|,
name|__K8MASK
argument_list|(
name|nonpostwrszdword
argument_list|,
literal|1
argument_list|)
block|,
name|__K8MASK
argument_list|(
name|postwrszbyte
argument_list|,
literal|2
argument_list|)
block|,
name|__K8MASK
argument_list|(
name|postwrszdword
argument_list|,
literal|3
argument_list|)
block|,
name|__K8MASK
argument_list|(
name|rdszbyte
argument_list|,
literal|4
argument_list|)
block|,
name|__K8MASK
argument_list|(
name|rdszdword
argument_list|,
literal|5
argument_list|)
block|,
name|__K8MASK
argument_list|(
name|rdmodwr
argument_list|,
literal|6
argument_list|)
block|,
name|NULLMASK
block|}
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* nb probe result */
end_comment

begin_decl_stmt
specifier|static
specifier|const
name|struct
name|pmc_masks
name|k8_mask_npr
index|[]
init|=
block|{
name|__K8MASK
argument_list|(
name|probe
operator|-
name|miss
argument_list|,
literal|0
argument_list|)
block|,
name|__K8MASK
argument_list|(
name|probe
operator|-
name|hit
argument_list|,
literal|1
argument_list|)
block|,
name|__K8MASK
argument_list|(
name|probe
operator|-
name|hit
operator|-
name|dirty
operator|-
name|no
operator|-
name|memory
operator|-
name|cancel
argument_list|,
literal|2
argument_list|)
block|,
name|__K8MASK
argument_list|(
name|probe
operator|-
name|hit
operator|-
name|dirty
operator|-
name|with
operator|-
name|memory
operator|-
name|cancel
argument_list|,
literal|3
argument_list|)
block|,
name|NULLMASK
block|}
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* nb hypertransport bus bandwidth */
end_comment

begin_decl_stmt
specifier|static
specifier|const
name|struct
name|pmc_masks
name|k8_mask_nhbb
index|[]
init|=
block|{
comment|/* HT bus bandwidth */
name|__K8MASK
argument_list|(
name|command
argument_list|,
literal|0
argument_list|)
block|,
name|__K8MASK
argument_list|(
name|data
argument_list|,
literal|1
argument_list|)
block|,
name|__K8MASK
argument_list|(
name|buffer
operator|-
name|release
argument_list|,
literal|2
argument_list|)
block|,
name|__K8MASK
argument_list|(
name|nop
argument_list|,
literal|3
argument_list|)
block|,
name|NULLMASK
block|}
decl_stmt|;
end_decl_stmt

begin_undef
undef|#
directive|undef
name|__K8MASK
end_undef

begin_define
define|#
directive|define
name|K8_KW_COUNT
value|"count"
end_define

begin_define
define|#
directive|define
name|K8_KW_EDGE
value|"edge"
end_define

begin_define
define|#
directive|define
name|K8_KW_INV
value|"inv"
end_define

begin_define
define|#
directive|define
name|K8_KW_MASK
value|"mask"
end_define

begin_define
define|#
directive|define
name|K8_KW_OS
value|"os"
end_define

begin_define
define|#
directive|define
name|K8_KW_USR
value|"usr"
end_define

begin_function
specifier|static
name|int
name|k8_allocate_pmc
parameter_list|(
name|enum
name|pmc_event
name|pe
parameter_list|,
name|char
modifier|*
name|ctrspec
parameter_list|,
name|struct
name|pmc_op_pmcallocate
modifier|*
name|pmc_config
parameter_list|)
block|{
name|char
modifier|*
name|e
decl_stmt|,
modifier|*
name|p
decl_stmt|,
modifier|*
name|q
decl_stmt|;
name|int
name|n
decl_stmt|;
name|uint32_t
name|count
decl_stmt|,
name|evmask
decl_stmt|;
specifier|const
name|struct
name|pmc_masks
modifier|*
name|pm
decl_stmt|,
modifier|*
name|pmask
decl_stmt|;
name|pmc_config
operator|->
name|pm_caps
operator||=
name|PMC_CAP_READ
expr_stmt|;
name|pmc_config
operator|->
name|pm_md
operator|.
name|pm_amd
operator|.
name|pm_amd_config
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|pe
operator|==
name|PMC_EV_TSC_TSC
condition|)
block|{
comment|/* TSC events must be unqualified. */
if|if
condition|(
name|ctrspec
operator|&&
operator|*
name|ctrspec
operator|!=
literal|'\0'
condition|)
return|return
operator|-
literal|1
return|;
return|return
literal|0
return|;
block|}
name|pmask
operator|=
name|NULL
expr_stmt|;
name|evmask
operator|=
literal|0
expr_stmt|;
define|#
directive|define
name|__K8SETMASK
parameter_list|(
name|M
parameter_list|)
value|pmask = k8_mask_##M
comment|/* setup parsing tables */
switch|switch
condition|(
name|pe
condition|)
block|{
case|case
name|PMC_EV_K8_FP_DISPATCHED_FPU_OPS
case|:
name|__K8SETMASK
argument_list|(
name|fdfo
argument_list|)
expr_stmt|;
break|break;
case|case
name|PMC_EV_K8_LS_SEGMENT_REGISTER_LOAD
case|:
name|__K8SETMASK
argument_list|(
name|lsrl
argument_list|)
expr_stmt|;
break|break;
case|case
name|PMC_EV_K8_LS_LOCKED_OPERATION
case|:
name|__K8SETMASK
argument_list|(
name|llo
argument_list|)
expr_stmt|;
break|break;
case|case
name|PMC_EV_K8_DC_REFILL_FROM_L2
case|:
case|case
name|PMC_EV_K8_DC_REFILL_FROM_SYSTEM
case|:
case|case
name|PMC_EV_K8_DC_COPYBACK
case|:
name|__K8SETMASK
argument_list|(
name|dc
argument_list|)
expr_stmt|;
break|break;
case|case
name|PMC_EV_K8_DC_ONE_BIT_ECC_ERROR
case|:
name|__K8SETMASK
argument_list|(
name|dobee
argument_list|)
expr_stmt|;
break|break;
case|case
name|PMC_EV_K8_DC_DISPATCHED_PREFETCH_INSTRUCTIONS
case|:
name|__K8SETMASK
argument_list|(
name|ddpi
argument_list|)
expr_stmt|;
break|break;
case|case
name|PMC_EV_K8_DC_DCACHE_ACCESSES_BY_LOCKS
case|:
name|__K8SETMASK
argument_list|(
name|dabl
argument_list|)
expr_stmt|;
break|break;
case|case
name|PMC_EV_K8_BU_INTERNAL_L2_REQUEST
case|:
name|__K8SETMASK
argument_list|(
name|bilr
argument_list|)
expr_stmt|;
break|break;
case|case
name|PMC_EV_K8_BU_FILL_REQUEST_L2_MISS
case|:
name|__K8SETMASK
argument_list|(
name|bfrlm
argument_list|)
expr_stmt|;
break|break;
case|case
name|PMC_EV_K8_BU_FILL_INTO_L2
case|:
name|__K8SETMASK
argument_list|(
name|bfil
argument_list|)
expr_stmt|;
break|break;
case|case
name|PMC_EV_K8_FR_RETIRED_FPU_INSTRUCTIONS
case|:
name|__K8SETMASK
argument_list|(
name|frfi
argument_list|)
expr_stmt|;
break|break;
case|case
name|PMC_EV_K8_FR_RETIRED_FASTPATH_DOUBLE_OP_INSTRUCTIONS
case|:
name|__K8SETMASK
argument_list|(
name|frfdoi
argument_list|)
expr_stmt|;
break|break;
case|case
name|PMC_EV_K8_FR_FPU_EXCEPTIONS
case|:
name|__K8SETMASK
argument_list|(
name|ffe
argument_list|)
expr_stmt|;
break|break;
case|case
name|PMC_EV_K8_NB_MEMORY_CONTROLLER_PAGE_ACCESS_EVENT
case|:
name|__K8SETMASK
argument_list|(
name|nmcpae
argument_list|)
expr_stmt|;
break|break;
case|case
name|PMC_EV_K8_NB_MEMORY_CONTROLLER_TURNAROUND
case|:
name|__K8SETMASK
argument_list|(
name|nmct
argument_list|)
expr_stmt|;
break|break;
case|case
name|PMC_EV_K8_NB_MEMORY_CONTROLLER_BYPASS_SATURATION
case|:
name|__K8SETMASK
argument_list|(
name|nmcbs
argument_list|)
expr_stmt|;
break|break;
case|case
name|PMC_EV_K8_NB_SIZED_COMMANDS
case|:
name|__K8SETMASK
argument_list|(
name|nsc
argument_list|)
expr_stmt|;
break|break;
case|case
name|PMC_EV_K8_NB_PROBE_RESULT
case|:
name|__K8SETMASK
argument_list|(
name|npr
argument_list|)
expr_stmt|;
break|break;
case|case
name|PMC_EV_K8_NB_HT_BUS0_BANDWIDTH
case|:
case|case
name|PMC_EV_K8_NB_HT_BUS1_BANDWIDTH
case|:
case|case
name|PMC_EV_K8_NB_HT_BUS2_BANDWIDTH
case|:
name|__K8SETMASK
argument_list|(
name|nhbb
argument_list|)
expr_stmt|;
break|break;
default|default:
break|break;
comment|/* no options defined */
block|}
name|pmc_config
operator|->
name|pm_caps
operator||=
name|PMC_CAP_WRITE
expr_stmt|;
while|while
condition|(
operator|(
name|p
operator|=
name|strsep
argument_list|(
operator|&
name|ctrspec
argument_list|,
literal|","
argument_list|)
operator|)
operator|!=
name|NULL
condition|)
block|{
if|if
condition|(
name|KWPREFIXMATCH
argument_list|(
name|p
argument_list|,
name|K8_KW_COUNT
literal|"="
argument_list|)
condition|)
block|{
name|q
operator|=
name|strchr
argument_list|(
name|p
argument_list|,
literal|'='
argument_list|)
expr_stmt|;
if|if
condition|(
operator|*
operator|++
name|q
operator|==
literal|'\0'
condition|)
comment|/* skip '=' */
return|return
operator|-
literal|1
return|;
name|count
operator|=
name|strtol
argument_list|(
name|q
argument_list|,
operator|&
name|e
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|e
operator|==
name|q
operator|||
operator|*
name|e
operator|!=
literal|'\0'
condition|)
return|return
operator|-
literal|1
return|;
name|pmc_config
operator|->
name|pm_caps
operator||=
name|PMC_CAP_THRESHOLD
expr_stmt|;
name|pmc_config
operator|->
name|pm_md
operator|.
name|pm_amd
operator|.
name|pm_amd_config
operator||=
name|AMD_PMC_TO_COUNTER
argument_list|(
name|count
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|KWMATCH
argument_list|(
name|p
argument_list|,
name|K8_KW_EDGE
argument_list|)
condition|)
block|{
name|pmc_config
operator|->
name|pm_caps
operator||=
name|PMC_CAP_EDGE
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|KWMATCH
argument_list|(
name|p
argument_list|,
name|K8_KW_INV
argument_list|)
condition|)
block|{
name|pmc_config
operator|->
name|pm_caps
operator||=
name|PMC_CAP_INVERT
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|KWPREFIXMATCH
argument_list|(
name|p
argument_list|,
name|K8_KW_MASK
literal|"="
argument_list|)
condition|)
block|{
if|if
condition|(
operator|(
name|n
operator|=
name|pmc_parse_mask
argument_list|(
name|pmask
argument_list|,
name|p
argument_list|,
operator|&
name|evmask
argument_list|)
operator|)
operator|<
literal|0
condition|)
return|return
operator|-
literal|1
return|;
name|pmc_config
operator|->
name|pm_caps
operator||=
name|PMC_CAP_QUALIFIER
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|KWMATCH
argument_list|(
name|p
argument_list|,
name|K8_KW_OS
argument_list|)
condition|)
block|{
name|pmc_config
operator|->
name|pm_caps
operator||=
name|PMC_CAP_SYSTEM
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|KWMATCH
argument_list|(
name|p
argument_list|,
name|K8_KW_USR
argument_list|)
condition|)
block|{
name|pmc_config
operator|->
name|pm_caps
operator||=
name|PMC_CAP_USER
expr_stmt|;
block|}
else|else
return|return
operator|-
literal|1
return|;
block|}
comment|/* other post processing */
switch|switch
condition|(
name|pe
condition|)
block|{
case|case
name|PMC_EV_K8_FP_DISPATCHED_FPU_OPS
case|:
case|case
name|PMC_EV_K8_FP_CYCLES_WITH_NO_FPU_OPS_RETIRED
case|:
case|case
name|PMC_EV_K8_FP_DISPATCHED_FPU_FAST_FLAG_OPS
case|:
case|case
name|PMC_EV_K8_FR_RETIRED_FASTPATH_DOUBLE_OP_INSTRUCTIONS
case|:
case|case
name|PMC_EV_K8_FR_RETIRED_FPU_INSTRUCTIONS
case|:
case|case
name|PMC_EV_K8_FR_FPU_EXCEPTIONS
case|:
comment|/* XXX only available in rev B and later */
break|break;
case|case
name|PMC_EV_K8_DC_DCACHE_ACCESSES_BY_LOCKS
case|:
comment|/* XXX only available in rev C and later */
break|break;
case|case
name|PMC_EV_K8_LS_LOCKED_OPERATION
case|:
comment|/* XXX CPU Rev A,B evmask is to be zero */
if|if
condition|(
name|evmask
operator|&
operator|(
name|evmask
operator|-
literal|1
operator|)
condition|)
comment|/*> 1 bit set */
return|return
operator|-
literal|1
return|;
if|if
condition|(
name|evmask
operator|==
literal|0
condition|)
block|{
name|evmask
operator|=
literal|0x01
expr_stmt|;
comment|/* Rev C and later: #instrs */
name|pmc_config
operator|->
name|pm_caps
operator||=
name|PMC_CAP_QUALIFIER
expr_stmt|;
block|}
break|break;
default|default:
if|if
condition|(
name|evmask
operator|==
literal|0
operator|&&
name|pmask
operator|!=
name|NULL
condition|)
block|{
for|for
control|(
name|pm
operator|=
name|pmask
init|;
name|pm
operator|->
name|pm_name
condition|;
name|pm
operator|++
control|)
name|evmask
operator||=
name|pm
operator|->
name|pm_value
expr_stmt|;
name|pmc_config
operator|->
name|pm_caps
operator||=
name|PMC_CAP_QUALIFIER
expr_stmt|;
block|}
block|}
if|if
condition|(
name|pmc_config
operator|->
name|pm_caps
operator|&
name|PMC_CAP_QUALIFIER
condition|)
name|pmc_config
operator|->
name|pm_md
operator|.
name|pm_amd
operator|.
name|pm_amd_config
operator|=
name|AMD_PMC_TO_UNITMASK
argument_list|(
name|evmask
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_if
if|#
directive|if
name|defined
argument_list|(
name|__amd64__
argument_list|)
operator|||
name|defined
argument_list|(
name|__i386__
argument_list|)
end_if

begin_comment
comment|/*  * Intel P4 PMCs  */
end_comment

begin_decl_stmt
specifier|static
name|struct
name|pmc_event_alias
name|p4_aliases
index|[]
init|=
block|{
name|EV_ALIAS
argument_list|(
literal|"branches"
argument_list|,
literal|"p4-branch-retired,mask=mmtp+mmtm"
argument_list|)
block|,
name|EV_ALIAS
argument_list|(
literal|"branch-mispredicts"
argument_list|,
literal|"p4-mispred-branch-retired"
argument_list|)
block|,
name|EV_ALIAS
argument_list|(
literal|"cycles"
argument_list|,
literal|"tsc"
argument_list|)
block|,
name|EV_ALIAS
argument_list|(
literal|"instructions"
argument_list|,
literal|"p4-instr-retired,mask=nbogusntag+nbogustag"
argument_list|)
block|,
name|EV_ALIAS
argument_list|(
literal|"unhalted-cycles"
argument_list|,
literal|"p4-global-power-events"
argument_list|)
block|,
name|EV_ALIAS
argument_list|(
argument|NULL
argument_list|,
argument|NULL
argument_list|)
block|}
decl_stmt|;
end_decl_stmt

begin_define
define|#
directive|define
name|P4_KW_ACTIVE
value|"active"
end_define

begin_define
define|#
directive|define
name|P4_KW_ACTIVE_ANY
value|"any"
end_define

begin_define
define|#
directive|define
name|P4_KW_ACTIVE_BOTH
value|"both"
end_define

begin_define
define|#
directive|define
name|P4_KW_ACTIVE_NONE
value|"none"
end_define

begin_define
define|#
directive|define
name|P4_KW_ACTIVE_SINGLE
value|"single"
end_define

begin_define
define|#
directive|define
name|P4_KW_BUSREQTYPE
value|"busreqtype"
end_define

begin_define
define|#
directive|define
name|P4_KW_CASCADE
value|"cascade"
end_define

begin_define
define|#
directive|define
name|P4_KW_EDGE
value|"edge"
end_define

begin_define
define|#
directive|define
name|P4_KW_INV
value|"complement"
end_define

begin_define
define|#
directive|define
name|P4_KW_OS
value|"os"
end_define

begin_define
define|#
directive|define
name|P4_KW_MASK
value|"mask"
end_define

begin_define
define|#
directive|define
name|P4_KW_PRECISE
value|"precise"
end_define

begin_define
define|#
directive|define
name|P4_KW_TAG
value|"tag"
end_define

begin_define
define|#
directive|define
name|P4_KW_THRESHOLD
value|"threshold"
end_define

begin_define
define|#
directive|define
name|P4_KW_USR
value|"usr"
end_define

begin_define
define|#
directive|define
name|__P4MASK
parameter_list|(
name|N
parameter_list|,
name|V
parameter_list|)
value|PMCMASK(N, (1<< (V)))
end_define

begin_decl_stmt
specifier|static
specifier|const
name|struct
name|pmc_masks
name|p4_mask_tcdm
index|[]
init|=
block|{
comment|/* tc deliver mode */
name|__P4MASK
argument_list|(
name|dd
argument_list|,
literal|0
argument_list|)
block|,
name|__P4MASK
argument_list|(
name|db
argument_list|,
literal|1
argument_list|)
block|,
name|__P4MASK
argument_list|(
name|di
argument_list|,
literal|2
argument_list|)
block|,
name|__P4MASK
argument_list|(
name|bd
argument_list|,
literal|3
argument_list|)
block|,
name|__P4MASK
argument_list|(
name|bb
argument_list|,
literal|4
argument_list|)
block|,
name|__P4MASK
argument_list|(
name|bi
argument_list|,
literal|5
argument_list|)
block|,
name|__P4MASK
argument_list|(
name|id
argument_list|,
literal|6
argument_list|)
block|,
name|__P4MASK
argument_list|(
name|ib
argument_list|,
literal|7
argument_list|)
block|,
name|NULLMASK
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
specifier|const
name|struct
name|pmc_masks
name|p4_mask_bfr
index|[]
init|=
block|{
comment|/* bpu fetch request */
name|__P4MASK
argument_list|(
name|tcmiss
argument_list|,
literal|0
argument_list|)
block|,
name|NULLMASK
block|, }
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
specifier|const
name|struct
name|pmc_masks
name|p4_mask_ir
index|[]
init|=
block|{
comment|/* itlb reference */
name|__P4MASK
argument_list|(
name|hit
argument_list|,
literal|0
argument_list|)
block|,
name|__P4MASK
argument_list|(
name|miss
argument_list|,
literal|1
argument_list|)
block|,
name|__P4MASK
argument_list|(
name|hit
operator|-
name|uc
argument_list|,
literal|2
argument_list|)
block|,
name|NULLMASK
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
specifier|const
name|struct
name|pmc_masks
name|p4_mask_memcan
index|[]
init|=
block|{
comment|/* memory cancel */
name|__P4MASK
argument_list|(
name|st
operator|-
name|rb
operator|-
name|full
argument_list|,
literal|2
argument_list|)
block|,
name|__P4MASK
argument_list|(
literal|64k
operator|-
name|conf
argument_list|,
literal|3
argument_list|)
block|,
name|NULLMASK
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
specifier|const
name|struct
name|pmc_masks
name|p4_mask_memcomp
index|[]
init|=
block|{
comment|/* memory complete */
name|__P4MASK
argument_list|(
name|lsc
argument_list|,
literal|0
argument_list|)
block|,
name|__P4MASK
argument_list|(
name|ssc
argument_list|,
literal|1
argument_list|)
block|,
name|NULLMASK
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
specifier|const
name|struct
name|pmc_masks
name|p4_mask_lpr
index|[]
init|=
block|{
comment|/* load port replay */
name|__P4MASK
argument_list|(
name|split
operator|-
name|ld
argument_list|,
literal|1
argument_list|)
block|,
name|NULLMASK
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
specifier|const
name|struct
name|pmc_masks
name|p4_mask_spr
index|[]
init|=
block|{
comment|/* store port replay */
name|__P4MASK
argument_list|(
name|split
operator|-
name|st
argument_list|,
literal|1
argument_list|)
block|,
name|NULLMASK
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
specifier|const
name|struct
name|pmc_masks
name|p4_mask_mlr
index|[]
init|=
block|{
comment|/* mob load replay */
name|__P4MASK
argument_list|(
name|no
operator|-
name|sta
argument_list|,
literal|1
argument_list|)
block|,
name|__P4MASK
argument_list|(
name|no
operator|-
name|std
argument_list|,
literal|3
argument_list|)
block|,
name|__P4MASK
argument_list|(
name|partial
operator|-
name|data
argument_list|,
literal|4
argument_list|)
block|,
name|__P4MASK
argument_list|(
name|unalgn
operator|-
name|addr
argument_list|,
literal|5
argument_list|)
block|,
name|NULLMASK
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
specifier|const
name|struct
name|pmc_masks
name|p4_mask_pwt
index|[]
init|=
block|{
comment|/* page walk type */
name|__P4MASK
argument_list|(
name|dtmiss
argument_list|,
literal|0
argument_list|)
block|,
name|__P4MASK
argument_list|(
name|itmiss
argument_list|,
literal|1
argument_list|)
block|,
name|NULLMASK
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
specifier|const
name|struct
name|pmc_masks
name|p4_mask_bcr
index|[]
init|=
block|{
comment|/* bsq cache reference */
name|__P4MASK
argument_list|(
name|rd
operator|-
literal|2ndl
operator|-
name|hits
argument_list|,
literal|0
argument_list|)
block|,
name|__P4MASK
argument_list|(
name|rd
operator|-
literal|2ndl
operator|-
name|hite
argument_list|,
literal|1
argument_list|)
block|,
name|__P4MASK
argument_list|(
name|rd
operator|-
literal|2ndl
operator|-
name|hitm
argument_list|,
literal|2
argument_list|)
block|,
name|__P4MASK
argument_list|(
name|rd
operator|-
literal|3rdl
operator|-
name|hits
argument_list|,
literal|3
argument_list|)
block|,
name|__P4MASK
argument_list|(
name|rd
operator|-
literal|3rdl
operator|-
name|hite
argument_list|,
literal|4
argument_list|)
block|,
name|__P4MASK
argument_list|(
name|rd
operator|-
literal|3rdl
operator|-
name|hitm
argument_list|,
literal|5
argument_list|)
block|,
name|__P4MASK
argument_list|(
name|rd
operator|-
literal|2ndl
operator|-
name|miss
argument_list|,
literal|8
argument_list|)
block|,
name|__P4MASK
argument_list|(
name|rd
operator|-
literal|3rdl
operator|-
name|miss
argument_list|,
literal|9
argument_list|)
block|,
name|__P4MASK
argument_list|(
name|wr
operator|-
literal|2ndl
operator|-
name|miss
argument_list|,
literal|10
argument_list|)
block|,
name|NULLMASK
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
specifier|const
name|struct
name|pmc_masks
name|p4_mask_ia
index|[]
init|=
block|{
comment|/* ioq allocation */
name|__P4MASK
argument_list|(
name|all
operator|-
name|read
argument_list|,
literal|5
argument_list|)
block|,
name|__P4MASK
argument_list|(
name|all
operator|-
name|write
argument_list|,
literal|6
argument_list|)
block|,
name|__P4MASK
argument_list|(
name|mem
operator|-
name|uc
argument_list|,
literal|7
argument_list|)
block|,
name|__P4MASK
argument_list|(
name|mem
operator|-
name|wc
argument_list|,
literal|8
argument_list|)
block|,
name|__P4MASK
argument_list|(
name|mem
operator|-
name|wt
argument_list|,
literal|9
argument_list|)
block|,
name|__P4MASK
argument_list|(
name|mem
operator|-
name|wp
argument_list|,
literal|10
argument_list|)
block|,
name|__P4MASK
argument_list|(
name|mem
operator|-
name|wb
argument_list|,
literal|11
argument_list|)
block|,
name|__P4MASK
argument_list|(
name|own
argument_list|,
literal|13
argument_list|)
block|,
name|__P4MASK
argument_list|(
name|other
argument_list|,
literal|14
argument_list|)
block|,
name|__P4MASK
argument_list|(
name|prefetch
argument_list|,
literal|15
argument_list|)
block|,
name|NULLMASK
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
specifier|const
name|struct
name|pmc_masks
name|p4_mask_iae
index|[]
init|=
block|{
comment|/* ioq active entries */
name|__P4MASK
argument_list|(
name|all
operator|-
name|read
argument_list|,
literal|5
argument_list|)
block|,
name|__P4MASK
argument_list|(
name|all
operator|-
name|write
argument_list|,
literal|6
argument_list|)
block|,
name|__P4MASK
argument_list|(
name|mem
operator|-
name|uc
argument_list|,
literal|7
argument_list|)
block|,
name|__P4MASK
argument_list|(
name|mem
operator|-
name|wc
argument_list|,
literal|8
argument_list|)
block|,
name|__P4MASK
argument_list|(
name|mem
operator|-
name|wt
argument_list|,
literal|9
argument_list|)
block|,
name|__P4MASK
argument_list|(
name|mem
operator|-
name|wp
argument_list|,
literal|10
argument_list|)
block|,
name|__P4MASK
argument_list|(
name|mem
operator|-
name|wb
argument_list|,
literal|11
argument_list|)
block|,
name|__P4MASK
argument_list|(
name|own
argument_list|,
literal|13
argument_list|)
block|,
name|__P4MASK
argument_list|(
name|other
argument_list|,
literal|14
argument_list|)
block|,
name|__P4MASK
argument_list|(
name|prefetch
argument_list|,
literal|15
argument_list|)
block|,
name|NULLMASK
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
specifier|const
name|struct
name|pmc_masks
name|p4_mask_fda
index|[]
init|=
block|{
comment|/* fsb data activity */
name|__P4MASK
argument_list|(
name|drdy
operator|-
name|drv
argument_list|,
literal|0
argument_list|)
block|,
name|__P4MASK
argument_list|(
name|drdy
operator|-
name|own
argument_list|,
literal|1
argument_list|)
block|,
name|__P4MASK
argument_list|(
name|drdy
operator|-
name|other
argument_list|,
literal|2
argument_list|)
block|,
name|__P4MASK
argument_list|(
name|dbsy
operator|-
name|drv
argument_list|,
literal|3
argument_list|)
block|,
name|__P4MASK
argument_list|(
name|dbsy
operator|-
name|own
argument_list|,
literal|4
argument_list|)
block|,
name|__P4MASK
argument_list|(
name|dbsy
operator|-
name|other
argument_list|,
literal|5
argument_list|)
block|,
name|NULLMASK
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
specifier|const
name|struct
name|pmc_masks
name|p4_mask_ba
index|[]
init|=
block|{
comment|/* bsq allocation */
name|__P4MASK
argument_list|(
name|req
operator|-
name|type0
argument_list|,
literal|0
argument_list|)
block|,
name|__P4MASK
argument_list|(
name|req
operator|-
name|type1
argument_list|,
literal|1
argument_list|)
block|,
name|__P4MASK
argument_list|(
name|req
operator|-
name|len0
argument_list|,
literal|2
argument_list|)
block|,
name|__P4MASK
argument_list|(
name|req
operator|-
name|len1
argument_list|,
literal|3
argument_list|)
block|,
name|__P4MASK
argument_list|(
name|req
operator|-
name|io
operator|-
name|type
argument_list|,
literal|5
argument_list|)
block|,
name|__P4MASK
argument_list|(
name|req
operator|-
name|lock
operator|-
name|type
argument_list|,
literal|6
argument_list|)
block|,
name|__P4MASK
argument_list|(
name|req
operator|-
name|cache
operator|-
name|type
argument_list|,
literal|7
argument_list|)
block|,
name|__P4MASK
argument_list|(
name|req
operator|-
name|split
operator|-
name|type
argument_list|,
literal|8
argument_list|)
block|,
name|__P4MASK
argument_list|(
name|req
operator|-
name|dem
operator|-
name|type
argument_list|,
literal|9
argument_list|)
block|,
name|__P4MASK
argument_list|(
name|req
operator|-
name|ord
operator|-
name|type
argument_list|,
literal|10
argument_list|)
block|,
name|__P4MASK
argument_list|(
name|mem
operator|-
name|type0
argument_list|,
literal|11
argument_list|)
block|,
name|__P4MASK
argument_list|(
name|mem
operator|-
name|type1
argument_list|,
literal|12
argument_list|)
block|,
name|__P4MASK
argument_list|(
name|mem
operator|-
name|type2
argument_list|,
literal|13
argument_list|)
block|,
name|NULLMASK
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
specifier|const
name|struct
name|pmc_masks
name|p4_mask_sia
index|[]
init|=
block|{
comment|/* sse input assist */
name|__P4MASK
argument_list|(
name|all
argument_list|,
literal|15
argument_list|)
block|,
name|NULLMASK
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
specifier|const
name|struct
name|pmc_masks
name|p4_mask_psu
index|[]
init|=
block|{
comment|/* packed sp uop */
name|__P4MASK
argument_list|(
name|all
argument_list|,
literal|15
argument_list|)
block|,
name|NULLMASK
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
specifier|const
name|struct
name|pmc_masks
name|p4_mask_pdu
index|[]
init|=
block|{
comment|/* packed dp uop */
name|__P4MASK
argument_list|(
name|all
argument_list|,
literal|15
argument_list|)
block|,
name|NULLMASK
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
specifier|const
name|struct
name|pmc_masks
name|p4_mask_ssu
index|[]
init|=
block|{
comment|/* scalar sp uop */
name|__P4MASK
argument_list|(
name|all
argument_list|,
literal|15
argument_list|)
block|,
name|NULLMASK
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
specifier|const
name|struct
name|pmc_masks
name|p4_mask_sdu
index|[]
init|=
block|{
comment|/* scalar dp uop */
name|__P4MASK
argument_list|(
name|all
argument_list|,
literal|15
argument_list|)
block|,
name|NULLMASK
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
specifier|const
name|struct
name|pmc_masks
name|p4_mask_64bmu
index|[]
init|=
block|{
comment|/* 64 bit mmx uop */
name|__P4MASK
argument_list|(
name|all
argument_list|,
literal|15
argument_list|)
block|,
name|NULLMASK
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
specifier|const
name|struct
name|pmc_masks
name|p4_mask_128bmu
index|[]
init|=
block|{
comment|/* 128 bit mmx uop */
name|__P4MASK
argument_list|(
name|all
argument_list|,
literal|15
argument_list|)
block|,
name|NULLMASK
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
specifier|const
name|struct
name|pmc_masks
name|p4_mask_xfu
index|[]
init|=
block|{
comment|/* X87 fp uop */
name|__P4MASK
argument_list|(
name|all
argument_list|,
literal|15
argument_list|)
block|,
name|NULLMASK
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
specifier|const
name|struct
name|pmc_masks
name|p4_mask_xsmu
index|[]
init|=
block|{
comment|/* x87 simd moves uop */
name|__P4MASK
argument_list|(
name|allp0
argument_list|,
literal|3
argument_list|)
block|,
name|__P4MASK
argument_list|(
name|allp2
argument_list|,
literal|4
argument_list|)
block|,
name|NULLMASK
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
specifier|const
name|struct
name|pmc_masks
name|p4_mask_gpe
index|[]
init|=
block|{
comment|/* global power events */
name|__P4MASK
argument_list|(
name|running
argument_list|,
literal|0
argument_list|)
block|,
name|NULLMASK
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
specifier|const
name|struct
name|pmc_masks
name|p4_mask_tmx
index|[]
init|=
block|{
comment|/* TC ms xfer */
name|__P4MASK
argument_list|(
name|cisc
argument_list|,
literal|0
argument_list|)
block|,
name|NULLMASK
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
specifier|const
name|struct
name|pmc_masks
name|p4_mask_uqw
index|[]
init|=
block|{
comment|/* uop queue writes */
name|__P4MASK
argument_list|(
name|from
operator|-
name|tc
operator|-
name|build
argument_list|,
literal|0
argument_list|)
block|,
name|__P4MASK
argument_list|(
name|from
operator|-
name|tc
operator|-
name|deliver
argument_list|,
literal|1
argument_list|)
block|,
name|__P4MASK
argument_list|(
name|from
operator|-
name|rom
argument_list|,
literal|2
argument_list|)
block|,
name|NULLMASK
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
specifier|const
name|struct
name|pmc_masks
name|p4_mask_rmbt
index|[]
init|=
block|{
comment|/* retired mispred branch type */
name|__P4MASK
argument_list|(
name|conditional
argument_list|,
literal|1
argument_list|)
block|,
name|__P4MASK
argument_list|(
name|call
argument_list|,
literal|2
argument_list|)
block|,
name|__P4MASK
argument_list|(
argument|return
argument_list|,
literal|3
argument_list|)
block|,
name|__P4MASK
argument_list|(
name|indirect
argument_list|,
literal|4
argument_list|)
block|,
name|NULLMASK
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
specifier|const
name|struct
name|pmc_masks
name|p4_mask_rbt
index|[]
init|=
block|{
comment|/* retired branch type */
name|__P4MASK
argument_list|(
name|conditional
argument_list|,
literal|1
argument_list|)
block|,
name|__P4MASK
argument_list|(
name|call
argument_list|,
literal|2
argument_list|)
block|,
name|__P4MASK
argument_list|(
name|retired
argument_list|,
literal|3
argument_list|)
block|,
name|__P4MASK
argument_list|(
name|indirect
argument_list|,
literal|4
argument_list|)
block|,
name|NULLMASK
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
specifier|const
name|struct
name|pmc_masks
name|p4_mask_rs
index|[]
init|=
block|{
comment|/* resource stall */
name|__P4MASK
argument_list|(
name|sbfull
argument_list|,
literal|5
argument_list|)
block|,
name|NULLMASK
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
specifier|const
name|struct
name|pmc_masks
name|p4_mask_wb
index|[]
init|=
block|{
comment|/* WC buffer */
name|__P4MASK
argument_list|(
name|wcb
operator|-
name|evicts
argument_list|,
literal|0
argument_list|)
block|,
name|__P4MASK
argument_list|(
name|wcb
operator|-
name|full
operator|-
name|evict
argument_list|,
literal|1
argument_list|)
block|,
name|NULLMASK
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
specifier|const
name|struct
name|pmc_masks
name|p4_mask_fee
index|[]
init|=
block|{
comment|/* front end event */
name|__P4MASK
argument_list|(
name|nbogus
argument_list|,
literal|0
argument_list|)
block|,
name|__P4MASK
argument_list|(
name|bogus
argument_list|,
literal|1
argument_list|)
block|,
name|NULLMASK
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
specifier|const
name|struct
name|pmc_masks
name|p4_mask_ee
index|[]
init|=
block|{
comment|/* execution event */
name|__P4MASK
argument_list|(
name|nbogus0
argument_list|,
literal|0
argument_list|)
block|,
name|__P4MASK
argument_list|(
name|nbogus1
argument_list|,
literal|1
argument_list|)
block|,
name|__P4MASK
argument_list|(
name|nbogus2
argument_list|,
literal|2
argument_list|)
block|,
name|__P4MASK
argument_list|(
name|nbogus3
argument_list|,
literal|3
argument_list|)
block|,
name|__P4MASK
argument_list|(
name|bogus0
argument_list|,
literal|4
argument_list|)
block|,
name|__P4MASK
argument_list|(
name|bogus1
argument_list|,
literal|5
argument_list|)
block|,
name|__P4MASK
argument_list|(
name|bogus2
argument_list|,
literal|6
argument_list|)
block|,
name|__P4MASK
argument_list|(
name|bogus3
argument_list|,
literal|7
argument_list|)
block|,
name|NULLMASK
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
specifier|const
name|struct
name|pmc_masks
name|p4_mask_re
index|[]
init|=
block|{
comment|/* replay event */
name|__P4MASK
argument_list|(
name|nbogus
argument_list|,
literal|0
argument_list|)
block|,
name|__P4MASK
argument_list|(
name|bogus
argument_list|,
literal|1
argument_list|)
block|,
name|NULLMASK
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
specifier|const
name|struct
name|pmc_masks
name|p4_mask_insret
index|[]
init|=
block|{
comment|/* instr retired */
name|__P4MASK
argument_list|(
name|nbogusntag
argument_list|,
literal|0
argument_list|)
block|,
name|__P4MASK
argument_list|(
name|nbogustag
argument_list|,
literal|1
argument_list|)
block|,
name|__P4MASK
argument_list|(
name|bogusntag
argument_list|,
literal|2
argument_list|)
block|,
name|__P4MASK
argument_list|(
name|bogustag
argument_list|,
literal|3
argument_list|)
block|,
name|NULLMASK
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
specifier|const
name|struct
name|pmc_masks
name|p4_mask_ur
index|[]
init|=
block|{
comment|/* uops retired */
name|__P4MASK
argument_list|(
name|nbogus
argument_list|,
literal|0
argument_list|)
block|,
name|__P4MASK
argument_list|(
name|bogus
argument_list|,
literal|1
argument_list|)
block|,
name|NULLMASK
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
specifier|const
name|struct
name|pmc_masks
name|p4_mask_ut
index|[]
init|=
block|{
comment|/* uop type */
name|__P4MASK
argument_list|(
name|tagloads
argument_list|,
literal|1
argument_list|)
block|,
name|__P4MASK
argument_list|(
name|tagstores
argument_list|,
literal|2
argument_list|)
block|,
name|NULLMASK
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
specifier|const
name|struct
name|pmc_masks
name|p4_mask_br
index|[]
init|=
block|{
comment|/* branch retired */
name|__P4MASK
argument_list|(
name|mmnp
argument_list|,
literal|0
argument_list|)
block|,
name|__P4MASK
argument_list|(
name|mmnm
argument_list|,
literal|1
argument_list|)
block|,
name|__P4MASK
argument_list|(
name|mmtp
argument_list|,
literal|2
argument_list|)
block|,
name|__P4MASK
argument_list|(
name|mmtm
argument_list|,
literal|3
argument_list|)
block|,
name|NULLMASK
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
specifier|const
name|struct
name|pmc_masks
name|p4_mask_mbr
index|[]
init|=
block|{
comment|/* mispred branch retired */
name|__P4MASK
argument_list|(
name|nbogus
argument_list|,
literal|0
argument_list|)
block|,
name|NULLMASK
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
specifier|const
name|struct
name|pmc_masks
name|p4_mask_xa
index|[]
init|=
block|{
comment|/* x87 assist */
name|__P4MASK
argument_list|(
name|fpsu
argument_list|,
literal|0
argument_list|)
block|,
name|__P4MASK
argument_list|(
name|fpso
argument_list|,
literal|1
argument_list|)
block|,
name|__P4MASK
argument_list|(
name|poao
argument_list|,
literal|2
argument_list|)
block|,
name|__P4MASK
argument_list|(
name|poau
argument_list|,
literal|3
argument_list|)
block|,
name|__P4MASK
argument_list|(
name|prea
argument_list|,
literal|4
argument_list|)
block|,
name|NULLMASK
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
specifier|const
name|struct
name|pmc_masks
name|p4_mask_machclr
index|[]
init|=
block|{
comment|/* machine clear */
name|__P4MASK
argument_list|(
name|clear
argument_list|,
literal|0
argument_list|)
block|,
name|__P4MASK
argument_list|(
name|moclear
argument_list|,
literal|2
argument_list|)
block|,
name|__P4MASK
argument_list|(
name|smclear
argument_list|,
literal|3
argument_list|)
block|,
name|NULLMASK
block|}
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* P4 event parser */
end_comment

begin_function
specifier|static
name|int
name|p4_allocate_pmc
parameter_list|(
name|enum
name|pmc_event
name|pe
parameter_list|,
name|char
modifier|*
name|ctrspec
parameter_list|,
name|struct
name|pmc_op_pmcallocate
modifier|*
name|pmc_config
parameter_list|)
block|{
name|char
modifier|*
name|e
decl_stmt|,
modifier|*
name|p
decl_stmt|,
modifier|*
name|q
decl_stmt|;
name|int
name|count
decl_stmt|,
name|has_tag
decl_stmt|,
name|has_busreqtype
decl_stmt|,
name|n
decl_stmt|;
name|uint32_t
name|evmask
decl_stmt|,
name|cccractivemask
decl_stmt|;
specifier|const
name|struct
name|pmc_masks
modifier|*
name|pm
decl_stmt|,
modifier|*
name|pmask
decl_stmt|;
name|pmc_config
operator|->
name|pm_caps
operator||=
name|PMC_CAP_READ
expr_stmt|;
name|pmc_config
operator|->
name|pm_md
operator|.
name|pm_p4
operator|.
name|pm_p4_cccrconfig
operator|=
name|pmc_config
operator|->
name|pm_md
operator|.
name|pm_p4
operator|.
name|pm_p4_escrconfig
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|pe
operator|==
name|PMC_EV_TSC_TSC
condition|)
block|{
comment|/* TSC must not be further qualified */
if|if
condition|(
name|ctrspec
operator|&&
operator|*
name|ctrspec
operator|!=
literal|'\0'
condition|)
return|return
operator|-
literal|1
return|;
return|return
literal|0
return|;
block|}
name|pmask
operator|=
name|NULL
expr_stmt|;
name|evmask
operator|=
literal|0
expr_stmt|;
name|cccractivemask
operator|=
literal|0x3
expr_stmt|;
name|has_tag
operator|=
name|has_busreqtype
operator|=
literal|0
expr_stmt|;
name|pmc_config
operator|->
name|pm_caps
operator||=
name|PMC_CAP_WRITE
expr_stmt|;
define|#
directive|define
name|__P4SETMASK
parameter_list|(
name|M
parameter_list|)
value|do {				\ 	pmask = p4_mask_##M; 				\ } while (0)
switch|switch
condition|(
name|pe
condition|)
block|{
case|case
name|PMC_EV_P4_TC_DELIVER_MODE
case|:
name|__P4SETMASK
argument_list|(
name|tcdm
argument_list|)
expr_stmt|;
break|break;
case|case
name|PMC_EV_P4_BPU_FETCH_REQUEST
case|:
name|__P4SETMASK
argument_list|(
name|bfr
argument_list|)
expr_stmt|;
break|break;
case|case
name|PMC_EV_P4_ITLB_REFERENCE
case|:
name|__P4SETMASK
argument_list|(
name|ir
argument_list|)
expr_stmt|;
break|break;
case|case
name|PMC_EV_P4_MEMORY_CANCEL
case|:
name|__P4SETMASK
argument_list|(
name|memcan
argument_list|)
expr_stmt|;
break|break;
case|case
name|PMC_EV_P4_MEMORY_COMPLETE
case|:
name|__P4SETMASK
argument_list|(
name|memcomp
argument_list|)
expr_stmt|;
break|break;
case|case
name|PMC_EV_P4_LOAD_PORT_REPLAY
case|:
name|__P4SETMASK
argument_list|(
name|lpr
argument_list|)
expr_stmt|;
break|break;
case|case
name|PMC_EV_P4_STORE_PORT_REPLAY
case|:
name|__P4SETMASK
argument_list|(
name|spr
argument_list|)
expr_stmt|;
break|break;
case|case
name|PMC_EV_P4_MOB_LOAD_REPLAY
case|:
name|__P4SETMASK
argument_list|(
name|mlr
argument_list|)
expr_stmt|;
break|break;
case|case
name|PMC_EV_P4_PAGE_WALK_TYPE
case|:
name|__P4SETMASK
argument_list|(
name|pwt
argument_list|)
expr_stmt|;
break|break;
case|case
name|PMC_EV_P4_BSQ_CACHE_REFERENCE
case|:
name|__P4SETMASK
argument_list|(
name|bcr
argument_list|)
expr_stmt|;
break|break;
case|case
name|PMC_EV_P4_IOQ_ALLOCATION
case|:
name|__P4SETMASK
argument_list|(
name|ia
argument_list|)
expr_stmt|;
name|has_busreqtype
operator|=
literal|1
expr_stmt|;
break|break;
case|case
name|PMC_EV_P4_IOQ_ACTIVE_ENTRIES
case|:
name|__P4SETMASK
argument_list|(
name|iae
argument_list|)
expr_stmt|;
name|has_busreqtype
operator|=
literal|1
expr_stmt|;
break|break;
case|case
name|PMC_EV_P4_FSB_DATA_ACTIVITY
case|:
name|__P4SETMASK
argument_list|(
name|fda
argument_list|)
expr_stmt|;
break|break;
case|case
name|PMC_EV_P4_BSQ_ALLOCATION
case|:
name|__P4SETMASK
argument_list|(
name|ba
argument_list|)
expr_stmt|;
break|break;
case|case
name|PMC_EV_P4_SSE_INPUT_ASSIST
case|:
name|__P4SETMASK
argument_list|(
name|sia
argument_list|)
expr_stmt|;
break|break;
case|case
name|PMC_EV_P4_PACKED_SP_UOP
case|:
name|__P4SETMASK
argument_list|(
name|psu
argument_list|)
expr_stmt|;
break|break;
case|case
name|PMC_EV_P4_PACKED_DP_UOP
case|:
name|__P4SETMASK
argument_list|(
name|pdu
argument_list|)
expr_stmt|;
break|break;
case|case
name|PMC_EV_P4_SCALAR_SP_UOP
case|:
name|__P4SETMASK
argument_list|(
name|ssu
argument_list|)
expr_stmt|;
break|break;
case|case
name|PMC_EV_P4_SCALAR_DP_UOP
case|:
name|__P4SETMASK
argument_list|(
name|sdu
argument_list|)
expr_stmt|;
break|break;
case|case
name|PMC_EV_P4_64BIT_MMX_UOP
case|:
name|__P4SETMASK
argument_list|(
literal|64bmu
argument_list|)
expr_stmt|;
break|break;
case|case
name|PMC_EV_P4_128BIT_MMX_UOP
case|:
name|__P4SETMASK
argument_list|(
literal|128bmu
argument_list|)
expr_stmt|;
break|break;
case|case
name|PMC_EV_P4_X87_FP_UOP
case|:
name|__P4SETMASK
argument_list|(
name|xfu
argument_list|)
expr_stmt|;
break|break;
case|case
name|PMC_EV_P4_X87_SIMD_MOVES_UOP
case|:
name|__P4SETMASK
argument_list|(
name|xsmu
argument_list|)
expr_stmt|;
break|break;
case|case
name|PMC_EV_P4_GLOBAL_POWER_EVENTS
case|:
name|__P4SETMASK
argument_list|(
name|gpe
argument_list|)
expr_stmt|;
break|break;
case|case
name|PMC_EV_P4_TC_MS_XFER
case|:
name|__P4SETMASK
argument_list|(
name|tmx
argument_list|)
expr_stmt|;
break|break;
case|case
name|PMC_EV_P4_UOP_QUEUE_WRITES
case|:
name|__P4SETMASK
argument_list|(
name|uqw
argument_list|)
expr_stmt|;
break|break;
case|case
name|PMC_EV_P4_RETIRED_MISPRED_BRANCH_TYPE
case|:
name|__P4SETMASK
argument_list|(
name|rmbt
argument_list|)
expr_stmt|;
break|break;
case|case
name|PMC_EV_P4_RETIRED_BRANCH_TYPE
case|:
name|__P4SETMASK
argument_list|(
name|rbt
argument_list|)
expr_stmt|;
break|break;
case|case
name|PMC_EV_P4_RESOURCE_STALL
case|:
name|__P4SETMASK
argument_list|(
name|rs
argument_list|)
expr_stmt|;
break|break;
case|case
name|PMC_EV_P4_WC_BUFFER
case|:
name|__P4SETMASK
argument_list|(
name|wb
argument_list|)
expr_stmt|;
break|break;
case|case
name|PMC_EV_P4_BSQ_ACTIVE_ENTRIES
case|:
case|case
name|PMC_EV_P4_B2B_CYCLES
case|:
case|case
name|PMC_EV_P4_BNR
case|:
case|case
name|PMC_EV_P4_SNOOP
case|:
case|case
name|PMC_EV_P4_RESPONSE
case|:
break|break;
case|case
name|PMC_EV_P4_FRONT_END_EVENT
case|:
name|__P4SETMASK
argument_list|(
name|fee
argument_list|)
expr_stmt|;
break|break;
case|case
name|PMC_EV_P4_EXECUTION_EVENT
case|:
name|__P4SETMASK
argument_list|(
name|ee
argument_list|)
expr_stmt|;
break|break;
case|case
name|PMC_EV_P4_REPLAY_EVENT
case|:
name|__P4SETMASK
argument_list|(
name|re
argument_list|)
expr_stmt|;
break|break;
case|case
name|PMC_EV_P4_INSTR_RETIRED
case|:
name|__P4SETMASK
argument_list|(
name|insret
argument_list|)
expr_stmt|;
break|break;
case|case
name|PMC_EV_P4_UOPS_RETIRED
case|:
name|__P4SETMASK
argument_list|(
name|ur
argument_list|)
expr_stmt|;
break|break;
case|case
name|PMC_EV_P4_UOP_TYPE
case|:
name|__P4SETMASK
argument_list|(
name|ut
argument_list|)
expr_stmt|;
break|break;
case|case
name|PMC_EV_P4_BRANCH_RETIRED
case|:
name|__P4SETMASK
argument_list|(
name|br
argument_list|)
expr_stmt|;
break|break;
case|case
name|PMC_EV_P4_MISPRED_BRANCH_RETIRED
case|:
name|__P4SETMASK
argument_list|(
name|mbr
argument_list|)
expr_stmt|;
break|break;
case|case
name|PMC_EV_P4_X87_ASSIST
case|:
name|__P4SETMASK
argument_list|(
name|xa
argument_list|)
expr_stmt|;
break|break;
case|case
name|PMC_EV_P4_MACHINE_CLEAR
case|:
name|__P4SETMASK
argument_list|(
name|machclr
argument_list|)
expr_stmt|;
break|break;
default|default:
return|return
operator|-
literal|1
return|;
block|}
comment|/* process additional flags */
while|while
condition|(
operator|(
name|p
operator|=
name|strsep
argument_list|(
operator|&
name|ctrspec
argument_list|,
literal|","
argument_list|)
operator|)
operator|!=
name|NULL
condition|)
block|{
if|if
condition|(
name|KWPREFIXMATCH
argument_list|(
name|p
argument_list|,
name|P4_KW_ACTIVE
argument_list|)
condition|)
block|{
name|q
operator|=
name|strchr
argument_list|(
name|p
argument_list|,
literal|'='
argument_list|)
expr_stmt|;
if|if
condition|(
operator|*
operator|++
name|q
operator|==
literal|'\0'
condition|)
comment|/* skip '=' */
return|return
operator|-
literal|1
return|;
if|if
condition|(
name|strcmp
argument_list|(
name|q
argument_list|,
name|P4_KW_ACTIVE_NONE
argument_list|)
operator|==
literal|0
condition|)
name|cccractivemask
operator|=
literal|0x0
expr_stmt|;
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|q
argument_list|,
name|P4_KW_ACTIVE_SINGLE
argument_list|)
operator|==
literal|0
condition|)
name|cccractivemask
operator|=
literal|0x1
expr_stmt|;
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|q
argument_list|,
name|P4_KW_ACTIVE_BOTH
argument_list|)
operator|==
literal|0
condition|)
name|cccractivemask
operator|=
literal|0x2
expr_stmt|;
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|q
argument_list|,
name|P4_KW_ACTIVE_ANY
argument_list|)
operator|==
literal|0
condition|)
name|cccractivemask
operator|=
literal|0x3
expr_stmt|;
else|else
return|return
operator|-
literal|1
return|;
block|}
elseif|else
if|if
condition|(
name|KWPREFIXMATCH
argument_list|(
name|p
argument_list|,
name|P4_KW_BUSREQTYPE
argument_list|)
condition|)
block|{
if|if
condition|(
name|has_busreqtype
operator|==
literal|0
condition|)
return|return
operator|-
literal|1
return|;
name|q
operator|=
name|strchr
argument_list|(
name|p
argument_list|,
literal|'='
argument_list|)
expr_stmt|;
if|if
condition|(
operator|*
operator|++
name|q
operator|==
literal|'\0'
condition|)
comment|/* skip '=' */
return|return
operator|-
literal|1
return|;
name|count
operator|=
name|strtol
argument_list|(
name|q
argument_list|,
operator|&
name|e
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|e
operator|==
name|q
operator|||
operator|*
name|e
operator|!=
literal|'\0'
condition|)
return|return
operator|-
literal|1
return|;
name|evmask
operator|=
operator|(
name|evmask
operator|&
operator|~
literal|0x1F
operator|)
operator||
operator|(
name|count
operator|&
literal|0x1F
operator|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|KWMATCH
argument_list|(
name|p
argument_list|,
name|P4_KW_CASCADE
argument_list|)
condition|)
name|pmc_config
operator|->
name|pm_caps
operator||=
name|PMC_CAP_CASCADE
expr_stmt|;
elseif|else
if|if
condition|(
name|KWMATCH
argument_list|(
name|p
argument_list|,
name|P4_KW_EDGE
argument_list|)
condition|)
name|pmc_config
operator|->
name|pm_caps
operator||=
name|PMC_CAP_EDGE
expr_stmt|;
elseif|else
if|if
condition|(
name|KWMATCH
argument_list|(
name|p
argument_list|,
name|P4_KW_INV
argument_list|)
condition|)
name|pmc_config
operator|->
name|pm_caps
operator||=
name|PMC_CAP_INVERT
expr_stmt|;
elseif|else
if|if
condition|(
name|KWPREFIXMATCH
argument_list|(
name|p
argument_list|,
name|P4_KW_MASK
literal|"="
argument_list|)
condition|)
block|{
if|if
condition|(
operator|(
name|n
operator|=
name|pmc_parse_mask
argument_list|(
name|pmask
argument_list|,
name|p
argument_list|,
operator|&
name|evmask
argument_list|)
operator|)
operator|<
literal|0
condition|)
return|return
operator|-
literal|1
return|;
name|pmc_config
operator|->
name|pm_caps
operator||=
name|PMC_CAP_QUALIFIER
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|KWMATCH
argument_list|(
name|p
argument_list|,
name|P4_KW_OS
argument_list|)
condition|)
name|pmc_config
operator|->
name|pm_caps
operator||=
name|PMC_CAP_SYSTEM
expr_stmt|;
elseif|else
if|if
condition|(
name|KWMATCH
argument_list|(
name|p
argument_list|,
name|P4_KW_PRECISE
argument_list|)
condition|)
name|pmc_config
operator|->
name|pm_caps
operator||=
name|PMC_CAP_PRECISE
expr_stmt|;
elseif|else
if|if
condition|(
name|KWPREFIXMATCH
argument_list|(
name|p
argument_list|,
name|P4_KW_TAG
literal|"="
argument_list|)
condition|)
block|{
if|if
condition|(
name|has_tag
operator|==
literal|0
condition|)
return|return
operator|-
literal|1
return|;
name|q
operator|=
name|strchr
argument_list|(
name|p
argument_list|,
literal|'='
argument_list|)
expr_stmt|;
if|if
condition|(
operator|*
operator|++
name|q
operator|==
literal|'\0'
condition|)
comment|/* skip '=' */
return|return
operator|-
literal|1
return|;
name|count
operator|=
name|strtol
argument_list|(
name|q
argument_list|,
operator|&
name|e
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|e
operator|==
name|q
operator|||
operator|*
name|e
operator|!=
literal|'\0'
condition|)
return|return
operator|-
literal|1
return|;
name|pmc_config
operator|->
name|pm_caps
operator||=
name|PMC_CAP_TAGGING
expr_stmt|;
name|pmc_config
operator|->
name|pm_md
operator|.
name|pm_p4
operator|.
name|pm_p4_escrconfig
operator||=
name|P4_ESCR_TO_TAG_VALUE
argument_list|(
name|count
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|KWPREFIXMATCH
argument_list|(
name|p
argument_list|,
name|P4_KW_THRESHOLD
literal|"="
argument_list|)
condition|)
block|{
name|q
operator|=
name|strchr
argument_list|(
name|p
argument_list|,
literal|'='
argument_list|)
expr_stmt|;
if|if
condition|(
operator|*
operator|++
name|q
operator|==
literal|'\0'
condition|)
comment|/* skip '=' */
return|return
operator|-
literal|1
return|;
name|count
operator|=
name|strtol
argument_list|(
name|q
argument_list|,
operator|&
name|e
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|e
operator|==
name|q
operator|||
operator|*
name|e
operator|!=
literal|'\0'
condition|)
return|return
operator|-
literal|1
return|;
name|pmc_config
operator|->
name|pm_caps
operator||=
name|PMC_CAP_THRESHOLD
expr_stmt|;
name|pmc_config
operator|->
name|pm_md
operator|.
name|pm_p4
operator|.
name|pm_p4_cccrconfig
operator|&=
operator|~
name|P4_CCCR_THRESHOLD_MASK
expr_stmt|;
name|pmc_config
operator|->
name|pm_md
operator|.
name|pm_p4
operator|.
name|pm_p4_cccrconfig
operator||=
name|P4_CCCR_TO_THRESHOLD
argument_list|(
name|count
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|KWMATCH
argument_list|(
name|p
argument_list|,
name|P4_KW_USR
argument_list|)
condition|)
name|pmc_config
operator|->
name|pm_caps
operator||=
name|PMC_CAP_USER
expr_stmt|;
else|else
return|return
operator|-
literal|1
return|;
block|}
comment|/* other post processing */
if|if
condition|(
name|pe
operator|==
name|PMC_EV_P4_IOQ_ALLOCATION
operator|||
name|pe
operator|==
name|PMC_EV_P4_FSB_DATA_ACTIVITY
operator|||
name|pe
operator|==
name|PMC_EV_P4_BSQ_ALLOCATION
condition|)
name|pmc_config
operator|->
name|pm_caps
operator||=
name|PMC_CAP_EDGE
expr_stmt|;
comment|/* fill in thread activity mask */
name|pmc_config
operator|->
name|pm_md
operator|.
name|pm_p4
operator|.
name|pm_p4_cccrconfig
operator||=
name|P4_CCCR_TO_ACTIVE_THREAD
argument_list|(
name|cccractivemask
argument_list|)
expr_stmt|;
if|if
condition|(
name|evmask
condition|)
name|pmc_config
operator|->
name|pm_caps
operator||=
name|PMC_CAP_QUALIFIER
expr_stmt|;
switch|switch
condition|(
name|pe
condition|)
block|{
case|case
name|PMC_EV_P4_FSB_DATA_ACTIVITY
case|:
if|if
condition|(
operator|(
name|evmask
operator|&
literal|0x06
operator|)
operator|==
literal|0x06
operator|||
operator|(
name|evmask
operator|&
literal|0x18
operator|)
operator|==
literal|0x18
condition|)
return|return
operator|-
literal|1
return|;
comment|/* can't have own+other bits together */
if|if
condition|(
name|evmask
operator|==
literal|0
condition|)
comment|/* default:drdy-{drv,own}+dbsy{drv,own} */
name|evmask
operator|=
literal|0x1D
expr_stmt|;
break|break;
case|case
name|PMC_EV_P4_MACHINE_CLEAR
case|:
comment|/* only one bit is allowed to be set */
if|if
condition|(
operator|(
name|evmask
operator|&
operator|(
name|evmask
operator|-
literal|1
operator|)
operator|)
operator|!=
literal|0
condition|)
return|return
operator|-
literal|1
return|;
if|if
condition|(
name|evmask
operator|==
literal|0
condition|)
block|{
name|evmask
operator|=
literal|0x1
expr_stmt|;
comment|/* 'CLEAR' */
name|pmc_config
operator|->
name|pm_caps
operator||=
name|PMC_CAP_QUALIFIER
expr_stmt|;
block|}
break|break;
default|default:
if|if
condition|(
name|evmask
operator|==
literal|0
operator|&&
name|pmask
condition|)
block|{
for|for
control|(
name|pm
operator|=
name|pmask
init|;
name|pm
operator|->
name|pm_name
condition|;
name|pm
operator|++
control|)
name|evmask
operator||=
name|pm
operator|->
name|pm_value
expr_stmt|;
name|pmc_config
operator|->
name|pm_caps
operator||=
name|PMC_CAP_QUALIFIER
expr_stmt|;
block|}
block|}
name|pmc_config
operator|->
name|pm_md
operator|.
name|pm_p4
operator|.
name|pm_p4_escrconfig
operator|=
name|P4_ESCR_TO_EVENT_MASK
argument_list|(
name|evmask
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_if
if|#
directive|if
name|defined
argument_list|(
name|__i386__
argument_list|)
end_if

begin_comment
comment|/*  * Pentium style PMCs  */
end_comment

begin_decl_stmt
specifier|static
name|struct
name|pmc_event_alias
name|p5_aliases
index|[]
init|=
block|{
name|EV_ALIAS
argument_list|(
literal|"cycles"
argument_list|,
literal|"tsc"
argument_list|)
block|,
name|EV_ALIAS
argument_list|(
argument|NULL
argument_list|,
argument|NULL
argument_list|)
block|}
decl_stmt|;
end_decl_stmt

begin_function
specifier|static
name|int
name|p5_allocate_pmc
parameter_list|(
name|enum
name|pmc_event
name|pe
parameter_list|,
name|char
modifier|*
name|ctrspec
parameter_list|,
name|struct
name|pmc_op_pmcallocate
modifier|*
name|pmc_config
parameter_list|)
block|{
return|return
operator|-
literal|1
operator|||
name|pe
operator|||
name|ctrspec
operator|||
name|pmc_config
return|;
comment|/* shut up gcc */
block|}
end_function

begin_comment
comment|/*  * Pentium Pro style PMCs.  These PMCs are found in Pentium II, Pentium III,  * and Pentium M CPUs.  */
end_comment

begin_decl_stmt
specifier|static
name|struct
name|pmc_event_alias
name|p6_aliases
index|[]
init|=
block|{
name|EV_ALIAS
argument_list|(
literal|"branches"
argument_list|,
literal|"p6-br-inst-retired"
argument_list|)
block|,
name|EV_ALIAS
argument_list|(
literal|"branch-mispredicts"
argument_list|,
literal|"p6-br-miss-pred-retired"
argument_list|)
block|,
name|EV_ALIAS
argument_list|(
literal|"cycles"
argument_list|,
literal|"tsc"
argument_list|)
block|,
name|EV_ALIAS
argument_list|(
literal|"dc-misses"
argument_list|,
literal|"p6-dcu-lines-in"
argument_list|)
block|,
name|EV_ALIAS
argument_list|(
literal|"ic-misses"
argument_list|,
literal|"p6-ifu-fetch-miss"
argument_list|)
block|,
name|EV_ALIAS
argument_list|(
literal|"instructions"
argument_list|,
literal|"p6-inst-retired"
argument_list|)
block|,
name|EV_ALIAS
argument_list|(
literal|"interrupts"
argument_list|,
literal|"p6-hw-int-rx"
argument_list|)
block|,
name|EV_ALIAS
argument_list|(
literal|"unhalted-cycles"
argument_list|,
literal|"p6-cpu-clk-unhalted"
argument_list|)
block|,
name|EV_ALIAS
argument_list|(
argument|NULL
argument_list|,
argument|NULL
argument_list|)
block|}
decl_stmt|;
end_decl_stmt

begin_define
define|#
directive|define
name|P6_KW_CMASK
value|"cmask"
end_define

begin_define
define|#
directive|define
name|P6_KW_EDGE
value|"edge"
end_define

begin_define
define|#
directive|define
name|P6_KW_INV
value|"inv"
end_define

begin_define
define|#
directive|define
name|P6_KW_OS
value|"os"
end_define

begin_define
define|#
directive|define
name|P6_KW_UMASK
value|"umask"
end_define

begin_define
define|#
directive|define
name|P6_KW_USR
value|"usr"
end_define

begin_decl_stmt
specifier|static
name|struct
name|pmc_masks
name|p6_mask_mesi
index|[]
init|=
block|{
name|PMCMASK
argument_list|(
name|m
argument_list|,
literal|0x01
argument_list|)
block|,
name|PMCMASK
argument_list|(
name|e
argument_list|,
literal|0x02
argument_list|)
block|,
name|PMCMASK
argument_list|(
name|s
argument_list|,
literal|0x04
argument_list|)
block|,
name|PMCMASK
argument_list|(
name|i
argument_list|,
literal|0x08
argument_list|)
block|,
name|NULLMASK
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|struct
name|pmc_masks
name|p6_mask_mesihw
index|[]
init|=
block|{
name|PMCMASK
argument_list|(
name|m
argument_list|,
literal|0x01
argument_list|)
block|,
name|PMCMASK
argument_list|(
name|e
argument_list|,
literal|0x02
argument_list|)
block|,
name|PMCMASK
argument_list|(
name|s
argument_list|,
literal|0x04
argument_list|)
block|,
name|PMCMASK
argument_list|(
name|i
argument_list|,
literal|0x08
argument_list|)
block|,
name|PMCMASK
argument_list|(
name|nonhw
argument_list|,
literal|0x00
argument_list|)
block|,
name|PMCMASK
argument_list|(
name|hw
argument_list|,
literal|0x10
argument_list|)
block|,
name|PMCMASK
argument_list|(
name|both
argument_list|,
literal|0x30
argument_list|)
block|,
name|NULLMASK
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|struct
name|pmc_masks
name|p6_mask_hw
index|[]
init|=
block|{
name|PMCMASK
argument_list|(
name|nonhw
argument_list|,
literal|0x00
argument_list|)
block|,
name|PMCMASK
argument_list|(
name|hw
argument_list|,
literal|0x10
argument_list|)
block|,
name|PMCMASK
argument_list|(
name|both
argument_list|,
literal|0x30
argument_list|)
block|,
name|NULLMASK
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|struct
name|pmc_masks
name|p6_mask_any
index|[]
init|=
block|{
name|PMCMASK
argument_list|(
name|self
argument_list|,
literal|0x00
argument_list|)
block|,
name|PMCMASK
argument_list|(
name|any
argument_list|,
literal|0x20
argument_list|)
block|,
name|NULLMASK
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|struct
name|pmc_masks
name|p6_mask_ekp
index|[]
init|=
block|{
name|PMCMASK
argument_list|(
name|nta
argument_list|,
literal|0x00
argument_list|)
block|,
name|PMCMASK
argument_list|(
name|t1
argument_list|,
literal|0x01
argument_list|)
block|,
name|PMCMASK
argument_list|(
name|t2
argument_list|,
literal|0x02
argument_list|)
block|,
name|PMCMASK
argument_list|(
name|wos
argument_list|,
literal|0x03
argument_list|)
block|,
name|NULLMASK
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|struct
name|pmc_masks
name|p6_mask_pps
index|[]
init|=
block|{
name|PMCMASK
argument_list|(
name|packed
operator|-
name|and
operator|-
name|scalar
argument_list|,
literal|0x00
argument_list|)
block|,
name|PMCMASK
argument_list|(
name|scalar
argument_list|,
literal|0x01
argument_list|)
block|,
name|NULLMASK
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|struct
name|pmc_masks
name|p6_mask_mite
index|[]
init|=
block|{
name|PMCMASK
argument_list|(
name|packed
operator|-
name|multiply
argument_list|,
literal|0x01
argument_list|)
block|,
name|PMCMASK
argument_list|(
name|packed
operator|-
name|shift
argument_list|,
literal|0x02
argument_list|)
block|,
name|PMCMASK
argument_list|(
name|pack
argument_list|,
literal|0x04
argument_list|)
block|,
name|PMCMASK
argument_list|(
name|unpack
argument_list|,
literal|0x08
argument_list|)
block|,
name|PMCMASK
argument_list|(
name|packed
operator|-
name|logical
argument_list|,
literal|0x10
argument_list|)
block|,
name|PMCMASK
argument_list|(
name|packed
operator|-
name|arithmetic
argument_list|,
literal|0x20
argument_list|)
block|,
name|NULLMASK
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|struct
name|pmc_masks
name|p6_mask_fmt
index|[]
init|=
block|{
name|PMCMASK
argument_list|(
name|mmxtofp
argument_list|,
literal|0x00
argument_list|)
block|,
name|PMCMASK
argument_list|(
name|fptommx
argument_list|,
literal|0x01
argument_list|)
block|,
name|NULLMASK
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|struct
name|pmc_masks
name|p6_mask_sr
index|[]
init|=
block|{
name|PMCMASK
argument_list|(
name|es
argument_list|,
literal|0x01
argument_list|)
block|,
name|PMCMASK
argument_list|(
name|ds
argument_list|,
literal|0x02
argument_list|)
block|,
name|PMCMASK
argument_list|(
name|fs
argument_list|,
literal|0x04
argument_list|)
block|,
name|PMCMASK
argument_list|(
name|gs
argument_list|,
literal|0x08
argument_list|)
block|,
name|NULLMASK
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|struct
name|pmc_masks
name|p6_mask_eet
index|[]
init|=
block|{
name|PMCMASK
argument_list|(
name|all
argument_list|,
literal|0x00
argument_list|)
block|,
name|PMCMASK
argument_list|(
name|freq
argument_list|,
literal|0x02
argument_list|)
block|,
name|NULLMASK
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|struct
name|pmc_masks
name|p6_mask_efur
index|[]
init|=
block|{
name|PMCMASK
argument_list|(
name|all
argument_list|,
literal|0x00
argument_list|)
block|,
name|PMCMASK
argument_list|(
name|loadop
argument_list|,
literal|0x01
argument_list|)
block|,
name|PMCMASK
argument_list|(
name|stdsta
argument_list|,
literal|0x02
argument_list|)
block|,
name|NULLMASK
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|struct
name|pmc_masks
name|p6_mask_essir
index|[]
init|=
block|{
name|PMCMASK
argument_list|(
name|sse
operator|-
name|packed
operator|-
name|single
argument_list|,
literal|0x00
argument_list|)
block|,
name|PMCMASK
argument_list|(
name|sse
operator|-
name|packed
operator|-
name|single
operator|-
name|scalar
operator|-
name|single
argument_list|,
literal|0x01
argument_list|)
block|,
name|PMCMASK
argument_list|(
name|sse2
operator|-
name|packed
operator|-
name|double
argument_list|,
literal|0x02
argument_list|)
block|,
name|PMCMASK
argument_list|(
name|sse2
operator|-
name|scalar
operator|-
name|double
argument_list|,
literal|0x03
argument_list|)
block|,
name|NULLMASK
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|struct
name|pmc_masks
name|p6_mask_esscir
index|[]
init|=
block|{
name|PMCMASK
argument_list|(
name|sse
operator|-
name|packed
operator|-
name|single
argument_list|,
literal|0x00
argument_list|)
block|,
name|PMCMASK
argument_list|(
name|sse
operator|-
name|scalar
operator|-
name|single
argument_list|,
literal|0x01
argument_list|)
block|,
name|PMCMASK
argument_list|(
name|sse2
operator|-
name|packed
operator|-
name|double
argument_list|,
literal|0x02
argument_list|)
block|,
name|PMCMASK
argument_list|(
name|sse2
operator|-
name|scalar
operator|-
name|double
argument_list|,
literal|0x03
argument_list|)
block|,
name|NULLMASK
block|}
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* P6 event parser */
end_comment

begin_function
specifier|static
name|int
name|p6_allocate_pmc
parameter_list|(
name|enum
name|pmc_event
name|pe
parameter_list|,
name|char
modifier|*
name|ctrspec
parameter_list|,
name|struct
name|pmc_op_pmcallocate
modifier|*
name|pmc_config
parameter_list|)
block|{
name|char
modifier|*
name|e
decl_stmt|,
modifier|*
name|p
decl_stmt|,
modifier|*
name|q
decl_stmt|;
name|uint32_t
name|evmask
decl_stmt|;
name|int
name|count
decl_stmt|,
name|n
decl_stmt|;
specifier|const
name|struct
name|pmc_masks
modifier|*
name|pm
decl_stmt|,
modifier|*
name|pmask
decl_stmt|;
name|pmc_config
operator|->
name|pm_caps
operator||=
name|PMC_CAP_READ
expr_stmt|;
name|pmc_config
operator|->
name|pm_md
operator|.
name|pm_ppro
operator|.
name|pm_ppro_config
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|pe
operator|==
name|PMC_EV_TSC_TSC
condition|)
block|{
if|if
condition|(
name|ctrspec
operator|&&
operator|*
name|ctrspec
operator|!=
literal|'\0'
condition|)
return|return
operator|-
literal|1
return|;
return|return
literal|0
return|;
block|}
name|pmc_config
operator|->
name|pm_caps
operator||=
name|PMC_CAP_WRITE
expr_stmt|;
name|evmask
operator|=
literal|0
expr_stmt|;
define|#
directive|define
name|P6MASKSET
parameter_list|(
name|M
parameter_list|)
value|pmask = p6_mask_ ## M
switch|switch
condition|(
name|pe
condition|)
block|{
case|case
name|PMC_EV_P6_L2_IFETCH
case|:
name|P6MASKSET
argument_list|(
name|mesi
argument_list|)
expr_stmt|;
break|break;
case|case
name|PMC_EV_P6_L2_LD
case|:
name|P6MASKSET
argument_list|(
name|mesi
argument_list|)
expr_stmt|;
break|break;
case|case
name|PMC_EV_P6_L2_ST
case|:
name|P6MASKSET
argument_list|(
name|mesi
argument_list|)
expr_stmt|;
break|break;
case|case
name|PMC_EV_P6_L2_RQSTS
case|:
name|P6MASKSET
argument_list|(
name|mesi
argument_list|)
expr_stmt|;
break|break;
case|case
name|PMC_EV_P6_BUS_DRDY_CLOCKS
case|:
case|case
name|PMC_EV_P6_BUS_LOCK_CLOCKS
case|:
case|case
name|PMC_EV_P6_BUS_TRAN_BRD
case|:
case|case
name|PMC_EV_P6_BUS_TRAN_RFO
case|:
case|case
name|PMC_EV_P6_BUS_TRANS_WB
case|:
case|case
name|PMC_EV_P6_BUS_TRAN_IFETCH
case|:
case|case
name|PMC_EV_P6_BUS_TRAN_INVAL
case|:
case|case
name|PMC_EV_P6_BUS_TRAN_PWR
case|:
case|case
name|PMC_EV_P6_BUS_TRANS_P
case|:
case|case
name|PMC_EV_P6_BUS_TRANS_IO
case|:
case|case
name|PMC_EV_P6_BUS_TRAN_DEF
case|:
case|case
name|PMC_EV_P6_BUS_TRAN_BURST
case|:
case|case
name|PMC_EV_P6_BUS_TRAN_ANY
case|:
case|case
name|PMC_EV_P6_BUS_TRAN_MEM
case|:
name|P6MASKSET
argument_list|(
name|any
argument_list|)
expr_stmt|;
break|break;
case|case
name|PMC_EV_P6_EMON_KNI_PREF_DISPATCHED
case|:
case|case
name|PMC_EV_P6_EMON_KNI_PREF_MISS
case|:
name|P6MASKSET
argument_list|(
name|ekp
argument_list|)
expr_stmt|;
break|break;
case|case
name|PMC_EV_P6_EMON_KNI_INST_RETIRED
case|:
case|case
name|PMC_EV_P6_EMON_KNI_COMP_INST_RET
case|:
name|P6MASKSET
argument_list|(
name|pps
argument_list|)
expr_stmt|;
break|break;
case|case
name|PMC_EV_P6_MMX_INSTR_TYPE_EXEC
case|:
name|P6MASKSET
argument_list|(
name|mite
argument_list|)
expr_stmt|;
break|break;
case|case
name|PMC_EV_P6_FP_MMX_TRANS
case|:
name|P6MASKSET
argument_list|(
name|fmt
argument_list|)
expr_stmt|;
break|break;
case|case
name|PMC_EV_P6_SEG_RENAME_STALLS
case|:
case|case
name|PMC_EV_P6_SEG_REG_RENAMES
case|:
name|P6MASKSET
argument_list|(
name|sr
argument_list|)
expr_stmt|;
break|break;
case|case
name|PMC_EV_P6_EMON_EST_TRANS
case|:
name|P6MASKSET
argument_list|(
name|eet
argument_list|)
expr_stmt|;
break|break;
case|case
name|PMC_EV_P6_EMON_FUSED_UOPS_RET
case|:
name|P6MASKSET
argument_list|(
name|efur
argument_list|)
expr_stmt|;
break|break;
case|case
name|PMC_EV_P6_EMON_SSE_SSE2_INST_RETIRED
case|:
name|P6MASKSET
argument_list|(
name|essir
argument_list|)
expr_stmt|;
break|break;
case|case
name|PMC_EV_P6_EMON_SSE_SSE2_COMP_INST_RETIRED
case|:
name|P6MASKSET
argument_list|(
name|esscir
argument_list|)
expr_stmt|;
break|break;
default|default:
name|pmask
operator|=
name|NULL
expr_stmt|;
break|break;
block|}
comment|/* Pentium M PMCs have a few events with different semantics */
if|if
condition|(
name|cpu_info
operator|.
name|pm_cputype
operator|==
name|PMC_CPU_INTEL_PM
condition|)
block|{
if|if
condition|(
name|pe
operator|==
name|PMC_EV_P6_L2_LD
operator|||
name|pe
operator|==
name|PMC_EV_P6_L2_LINES_IN
operator|||
name|pe
operator|==
name|PMC_EV_P6_L2_LINES_OUT
condition|)
name|P6MASKSET
argument_list|(
name|mesihw
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|pe
operator|==
name|PMC_EV_P6_L2_M_LINES_OUTM
condition|)
name|P6MASKSET
argument_list|(
name|hw
argument_list|)
expr_stmt|;
block|}
comment|/* Parse additional modifiers if present */
while|while
condition|(
operator|(
name|p
operator|=
name|strsep
argument_list|(
operator|&
name|ctrspec
argument_list|,
literal|","
argument_list|)
operator|)
operator|!=
name|NULL
condition|)
block|{
if|if
condition|(
name|KWPREFIXMATCH
argument_list|(
name|p
argument_list|,
name|P6_KW_CMASK
literal|"="
argument_list|)
condition|)
block|{
name|q
operator|=
name|strchr
argument_list|(
name|p
argument_list|,
literal|'='
argument_list|)
expr_stmt|;
if|if
condition|(
operator|*
operator|++
name|q
operator|==
literal|'\0'
condition|)
comment|/* skip '=' */
return|return
operator|-
literal|1
return|;
name|count
operator|=
name|strtol
argument_list|(
name|q
argument_list|,
operator|&
name|e
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|e
operator|==
name|q
operator|||
operator|*
name|e
operator|!=
literal|'\0'
condition|)
return|return
operator|-
literal|1
return|;
name|pmc_config
operator|->
name|pm_caps
operator||=
name|PMC_CAP_THRESHOLD
expr_stmt|;
name|pmc_config
operator|->
name|pm_md
operator|.
name|pm_ppro
operator|.
name|pm_ppro_config
operator||=
name|P6_EVSEL_TO_CMASK
argument_list|(
name|count
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|KWMATCH
argument_list|(
name|p
argument_list|,
name|P6_KW_EDGE
argument_list|)
condition|)
block|{
name|pmc_config
operator|->
name|pm_caps
operator||=
name|PMC_CAP_EDGE
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|KWMATCH
argument_list|(
name|p
argument_list|,
name|P6_KW_INV
argument_list|)
condition|)
block|{
name|pmc_config
operator|->
name|pm_caps
operator||=
name|PMC_CAP_INVERT
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|KWMATCH
argument_list|(
name|p
argument_list|,
name|P6_KW_OS
argument_list|)
condition|)
block|{
name|pmc_config
operator|->
name|pm_caps
operator||=
name|PMC_CAP_SYSTEM
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|KWPREFIXMATCH
argument_list|(
name|p
argument_list|,
name|P6_KW_UMASK
literal|"="
argument_list|)
condition|)
block|{
name|evmask
operator|=
literal|0
expr_stmt|;
if|if
condition|(
operator|(
name|n
operator|=
name|pmc_parse_mask
argument_list|(
name|pmask
argument_list|,
name|p
argument_list|,
operator|&
name|evmask
argument_list|)
operator|)
operator|<
literal|0
condition|)
return|return
operator|-
literal|1
return|;
if|if
condition|(
operator|(
name|pe
operator|==
name|PMC_EV_P6_BUS_DRDY_CLOCKS
operator|||
name|pe
operator|==
name|PMC_EV_P6_BUS_LOCK_CLOCKS
operator|||
name|pe
operator|==
name|PMC_EV_P6_BUS_TRAN_BRD
operator|||
name|pe
operator|==
name|PMC_EV_P6_BUS_TRAN_RFO
operator|||
name|pe
operator|==
name|PMC_EV_P6_BUS_TRAN_IFETCH
operator|||
name|pe
operator|==
name|PMC_EV_P6_BUS_TRAN_INVAL
operator|||
name|pe
operator|==
name|PMC_EV_P6_BUS_TRAN_PWR
operator|||
name|pe
operator|==
name|PMC_EV_P6_BUS_TRAN_DEF
operator|||
name|pe
operator|==
name|PMC_EV_P6_BUS_TRAN_BURST
operator|||
name|pe
operator|==
name|PMC_EV_P6_BUS_TRAN_ANY
operator|||
name|pe
operator|==
name|PMC_EV_P6_BUS_TRAN_MEM
operator|||
name|pe
operator|==
name|PMC_EV_P6_BUS_TRANS_IO
operator|||
name|pe
operator|==
name|PMC_EV_P6_BUS_TRANS_P
operator|||
name|pe
operator|==
name|PMC_EV_P6_BUS_TRANS_WB
operator|||
name|pe
operator|==
name|PMC_EV_P6_EMON_EST_TRANS
operator|||
name|pe
operator|==
name|PMC_EV_P6_EMON_FUSED_UOPS_RET
operator|||
name|pe
operator|==
name|PMC_EV_P6_EMON_KNI_COMP_INST_RET
operator|||
name|pe
operator|==
name|PMC_EV_P6_EMON_KNI_INST_RETIRED
operator|||
name|pe
operator|==
name|PMC_EV_P6_EMON_KNI_PREF_DISPATCHED
operator|||
name|pe
operator|==
name|PMC_EV_P6_EMON_KNI_PREF_MISS
operator|||
name|pe
operator|==
name|PMC_EV_P6_EMON_SSE_SSE2_COMP_INST_RETIRED
operator|||
name|pe
operator|==
name|PMC_EV_P6_EMON_SSE_SSE2_INST_RETIRED
operator|||
name|pe
operator|==
name|PMC_EV_P6_FP_MMX_TRANS
operator|)
operator|&&
operator|(
name|n
operator|>
literal|1
operator|)
condition|)
return|return
operator|-
literal|1
return|;
comment|/* only one mask keyword allowed */
name|pmc_config
operator|->
name|pm_caps
operator||=
name|PMC_CAP_QUALIFIER
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|KWMATCH
argument_list|(
name|p
argument_list|,
name|P6_KW_USR
argument_list|)
condition|)
block|{
name|pmc_config
operator|->
name|pm_caps
operator||=
name|PMC_CAP_USER
expr_stmt|;
block|}
else|else
return|return
operator|-
literal|1
return|;
block|}
comment|/* post processing */
switch|switch
condition|(
name|pe
condition|)
block|{
comment|/* 		 * The following events default to an evmask of 0 		 */
comment|/* default => 'self' */
case|case
name|PMC_EV_P6_BUS_DRDY_CLOCKS
case|:
case|case
name|PMC_EV_P6_BUS_LOCK_CLOCKS
case|:
case|case
name|PMC_EV_P6_BUS_TRAN_BRD
case|:
case|case
name|PMC_EV_P6_BUS_TRAN_RFO
case|:
case|case
name|PMC_EV_P6_BUS_TRANS_WB
case|:
case|case
name|PMC_EV_P6_BUS_TRAN_IFETCH
case|:
case|case
name|PMC_EV_P6_BUS_TRAN_INVAL
case|:
case|case
name|PMC_EV_P6_BUS_TRAN_PWR
case|:
case|case
name|PMC_EV_P6_BUS_TRANS_P
case|:
case|case
name|PMC_EV_P6_BUS_TRANS_IO
case|:
case|case
name|PMC_EV_P6_BUS_TRAN_DEF
case|:
case|case
name|PMC_EV_P6_BUS_TRAN_BURST
case|:
case|case
name|PMC_EV_P6_BUS_TRAN_ANY
case|:
case|case
name|PMC_EV_P6_BUS_TRAN_MEM
case|:
comment|/* default => 'nta' */
case|case
name|PMC_EV_P6_EMON_KNI_PREF_DISPATCHED
case|:
case|case
name|PMC_EV_P6_EMON_KNI_PREF_MISS
case|:
comment|/* default => 'packed and scalar' */
case|case
name|PMC_EV_P6_EMON_KNI_INST_RETIRED
case|:
case|case
name|PMC_EV_P6_EMON_KNI_COMP_INST_RET
case|:
comment|/* default => 'mmx to fp transitions' */
case|case
name|PMC_EV_P6_FP_MMX_TRANS
case|:
comment|/* default => 'SSE Packed Single' */
case|case
name|PMC_EV_P6_EMON_SSE_SSE2_INST_RETIRED
case|:
case|case
name|PMC_EV_P6_EMON_SSE_SSE2_COMP_INST_RETIRED
case|:
comment|/* default => 'all fused micro-ops' */
case|case
name|PMC_EV_P6_EMON_FUSED_UOPS_RET
case|:
comment|/* default => 'all transitions' */
case|case
name|PMC_EV_P6_EMON_EST_TRANS
case|:
break|break;
case|case
name|PMC_EV_P6_MMX_UOPS_EXEC
case|:
name|evmask
operator|=
literal|0x0F
expr_stmt|;
comment|/* only value allowed */
break|break;
default|default:
comment|/* 		 * For all other events, set the default event mask 		 * to a logical OR of all the allowed event mask bits. 		 */
if|if
condition|(
name|evmask
operator|==
literal|0
operator|&&
name|pmask
condition|)
block|{
for|for
control|(
name|pm
operator|=
name|pmask
init|;
name|pm
operator|->
name|pm_name
condition|;
name|pm
operator|++
control|)
name|evmask
operator||=
name|pm
operator|->
name|pm_value
expr_stmt|;
name|pmc_config
operator|->
name|pm_caps
operator||=
name|PMC_CAP_QUALIFIER
expr_stmt|;
block|}
break|break;
block|}
if|if
condition|(
name|pmc_config
operator|->
name|pm_caps
operator|&
name|PMC_CAP_QUALIFIER
condition|)
name|pmc_config
operator|->
name|pm_md
operator|.
name|pm_ppro
operator|.
name|pm_ppro_config
operator||=
name|P6_EVSEL_TO_UMASK
argument_list|(
name|evmask
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/*  * API entry points  */
end_comment

begin_function
name|int
name|pmc_allocate
parameter_list|(
specifier|const
name|char
modifier|*
name|ctrspec
parameter_list|,
name|enum
name|pmc_mode
name|mode
parameter_list|,
name|uint32_t
name|flags
parameter_list|,
name|int
name|cpu
parameter_list|,
name|pmc_id_t
modifier|*
name|pmcid
parameter_list|)
block|{
name|int
name|retval
decl_stmt|;
name|enum
name|pmc_event
name|pe
decl_stmt|;
name|char
modifier|*
name|r
decl_stmt|,
modifier|*
name|spec_copy
decl_stmt|;
specifier|const
name|char
modifier|*
name|ctrname
decl_stmt|;
specifier|const
name|struct
name|pmc_event_alias
modifier|*
name|p
decl_stmt|;
name|struct
name|pmc_op_pmcallocate
name|pmc_config
decl_stmt|;
name|spec_copy
operator|=
name|NULL
expr_stmt|;
name|retval
operator|=
operator|-
literal|1
expr_stmt|;
if|if
condition|(
name|mode
operator|!=
name|PMC_MODE_SS
operator|&&
name|mode
operator|!=
name|PMC_MODE_TS
operator|&&
name|mode
operator|!=
name|PMC_MODE_SC
operator|&&
name|mode
operator|!=
name|PMC_MODE_TC
condition|)
block|{
name|errno
operator|=
name|EINVAL
expr_stmt|;
goto|goto
name|out
goto|;
block|}
comment|/* replace an event alias with the canonical event specifier */
if|if
condition|(
name|pmc_mdep_event_aliases
condition|)
for|for
control|(
name|p
operator|=
name|pmc_mdep_event_aliases
init|;
name|p
operator|->
name|pm_alias
condition|;
name|p
operator|++
control|)
if|if
condition|(
operator|!
name|strcmp
argument_list|(
name|ctrspec
argument_list|,
name|p
operator|->
name|pm_alias
argument_list|)
condition|)
block|{
name|spec_copy
operator|=
name|strdup
argument_list|(
name|p
operator|->
name|pm_spec
argument_list|)
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|spec_copy
operator|==
name|NULL
condition|)
name|spec_copy
operator|=
name|strdup
argument_list|(
name|ctrspec
argument_list|)
expr_stmt|;
name|r
operator|=
name|spec_copy
expr_stmt|;
name|ctrname
operator|=
name|strsep
argument_list|(
operator|&
name|r
argument_list|,
literal|","
argument_list|)
expr_stmt|;
comment|/* look for the given counter name */
for|for
control|(
name|pe
operator|=
name|PMC_EVENT_FIRST
init|;
name|pe
operator|<
operator|(
name|PMC_EVENT_LAST
operator|+
literal|1
operator|)
condition|;
name|pe
operator|++
control|)
if|if
condition|(
operator|!
name|strcmp
argument_list|(
name|ctrname
argument_list|,
name|pmc_event_table
index|[
name|pe
index|]
operator|.
name|pm_ev_name
argument_list|)
condition|)
break|break;
if|if
condition|(
name|pe
operator|>
name|PMC_EVENT_LAST
condition|)
block|{
name|errno
operator|=
name|EINVAL
expr_stmt|;
goto|goto
name|out
goto|;
block|}
name|bzero
argument_list|(
operator|&
name|pmc_config
argument_list|,
sizeof|sizeof
argument_list|(
name|pmc_config
argument_list|)
argument_list|)
expr_stmt|;
name|pmc_config
operator|.
name|pm_ev
operator|=
name|pmc_event_table
index|[
name|pe
index|]
operator|.
name|pm_ev_code
expr_stmt|;
name|pmc_config
operator|.
name|pm_class
operator|=
name|pmc_event_table
index|[
name|pe
index|]
operator|.
name|pm_ev_class
expr_stmt|;
name|pmc_config
operator|.
name|pm_cpu
operator|=
name|cpu
expr_stmt|;
name|pmc_config
operator|.
name|pm_mode
operator|=
name|mode
expr_stmt|;
name|pmc_config
operator|.
name|pm_flags
operator|=
name|flags
expr_stmt|;
if|if
condition|(
name|PMC_IS_SAMPLING_MODE
argument_list|(
name|mode
argument_list|)
condition|)
name|pmc_config
operator|.
name|pm_caps
operator||=
name|PMC_CAP_INTERRUPT
expr_stmt|;
if|if
condition|(
name|pmc_mdep_allocate_pmc
argument_list|(
name|pe
argument_list|,
name|r
argument_list|,
operator|&
name|pmc_config
argument_list|)
operator|<
literal|0
condition|)
block|{
name|errno
operator|=
name|EINVAL
expr_stmt|;
goto|goto
name|out
goto|;
block|}
if|if
condition|(
name|PMC_CALL
argument_list|(
name|PMCALLOCATE
argument_list|,
operator|&
name|pmc_config
argument_list|)
operator|<
literal|0
condition|)
goto|goto
name|out
goto|;
operator|*
name|pmcid
operator|=
name|pmc_config
operator|.
name|pm_pmcid
expr_stmt|;
name|retval
operator|=
literal|0
expr_stmt|;
name|out
label|:
if|if
condition|(
name|spec_copy
condition|)
name|free
argument_list|(
name|spec_copy
argument_list|)
expr_stmt|;
return|return
name|retval
return|;
block|}
end_function

begin_function
name|int
name|pmc_attach
parameter_list|(
name|pmc_id_t
name|pmc
parameter_list|,
name|pid_t
name|pid
parameter_list|)
block|{
name|struct
name|pmc_op_pmcattach
name|pmc_attach_args
decl_stmt|;
name|pmc_attach_args
operator|.
name|pm_pmc
operator|=
name|pmc
expr_stmt|;
name|pmc_attach_args
operator|.
name|pm_pid
operator|=
name|pid
expr_stmt|;
return|return
name|PMC_CALL
argument_list|(
name|PMCATTACH
argument_list|,
operator|&
name|pmc_attach_args
argument_list|)
return|;
block|}
end_function

begin_function
name|int
name|pmc_capabilities
parameter_list|(
name|pmc_id_t
name|pmcid
parameter_list|,
name|uint32_t
modifier|*
name|caps
parameter_list|)
block|{
name|unsigned
name|int
name|i
decl_stmt|;
name|enum
name|pmc_class
name|cl
decl_stmt|;
name|cl
operator|=
name|PMC_ID_TO_CLASS
argument_list|(
name|pmcid
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|cpu_info
operator|.
name|pm_nclass
condition|;
name|i
operator|++
control|)
if|if
condition|(
name|cpu_info
operator|.
name|pm_classes
index|[
name|i
index|]
operator|.
name|pm_class
operator|==
name|cl
condition|)
block|{
operator|*
name|caps
operator|=
name|cpu_info
operator|.
name|pm_classes
index|[
name|i
index|]
operator|.
name|pm_caps
expr_stmt|;
return|return
literal|0
return|;
block|}
return|return
name|EINVAL
return|;
block|}
end_function

begin_function
name|int
name|pmc_configure_logfile
parameter_list|(
name|int
name|fd
parameter_list|)
block|{
name|struct
name|pmc_op_configurelog
name|cla
decl_stmt|;
name|cla
operator|.
name|pm_logfd
operator|=
name|fd
expr_stmt|;
if|if
condition|(
name|PMC_CALL
argument_list|(
name|CONFIGURELOG
argument_list|,
operator|&
name|cla
argument_list|)
operator|<
literal|0
condition|)
return|return
operator|-
literal|1
return|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|int
name|pmc_cpuinfo
parameter_list|(
specifier|const
name|struct
name|pmc_cpuinfo
modifier|*
modifier|*
name|pci
parameter_list|)
block|{
if|if
condition|(
name|pmc_syscall
operator|==
operator|-
literal|1
condition|)
block|{
name|errno
operator|=
name|ENXIO
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
operator|*
name|pci
operator|=
operator|&
name|cpu_info
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|int
name|pmc_detach
parameter_list|(
name|pmc_id_t
name|pmc
parameter_list|,
name|pid_t
name|pid
parameter_list|)
block|{
name|struct
name|pmc_op_pmcattach
name|pmc_detach_args
decl_stmt|;
name|pmc_detach_args
operator|.
name|pm_pmc
operator|=
name|pmc
expr_stmt|;
name|pmc_detach_args
operator|.
name|pm_pid
operator|=
name|pid
expr_stmt|;
return|return
name|PMC_CALL
argument_list|(
name|PMCDETACH
argument_list|,
operator|&
name|pmc_detach_args
argument_list|)
return|;
block|}
end_function

begin_function
name|int
name|pmc_disable
parameter_list|(
name|int
name|cpu
parameter_list|,
name|int
name|pmc
parameter_list|)
block|{
name|struct
name|pmc_op_pmcadmin
name|ssa
decl_stmt|;
name|ssa
operator|.
name|pm_cpu
operator|=
name|cpu
expr_stmt|;
name|ssa
operator|.
name|pm_pmc
operator|=
name|pmc
expr_stmt|;
name|ssa
operator|.
name|pm_state
operator|=
name|PMC_STATE_DISABLED
expr_stmt|;
return|return
name|PMC_CALL
argument_list|(
name|PMCADMIN
argument_list|,
operator|&
name|ssa
argument_list|)
return|;
block|}
end_function

begin_function
name|int
name|pmc_enable
parameter_list|(
name|int
name|cpu
parameter_list|,
name|int
name|pmc
parameter_list|)
block|{
name|struct
name|pmc_op_pmcadmin
name|ssa
decl_stmt|;
name|ssa
operator|.
name|pm_cpu
operator|=
name|cpu
expr_stmt|;
name|ssa
operator|.
name|pm_pmc
operator|=
name|pmc
expr_stmt|;
name|ssa
operator|.
name|pm_state
operator|=
name|PMC_STATE_FREE
expr_stmt|;
return|return
name|PMC_CALL
argument_list|(
name|PMCADMIN
argument_list|,
operator|&
name|ssa
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/*  * Return a list of events known to a given PMC class.  'cl' is the  * PMC class identifier, 'eventnames' is the returned list of 'const  * char *' pointers pointing to the names of the events. 'nevents' is  * the number of event name pointers returned.  *  * The space for 'eventnames' is allocated using malloc(3).  The caller  * is responsible for freeing this space when done.  */
end_comment

begin_function
name|int
name|pmc_event_names_of_class
parameter_list|(
name|enum
name|pmc_class
name|cl
parameter_list|,
specifier|const
name|char
modifier|*
modifier|*
modifier|*
name|eventnames
parameter_list|,
name|int
modifier|*
name|nevents
parameter_list|)
block|{
name|int
name|count
decl_stmt|;
specifier|const
name|char
modifier|*
modifier|*
name|names
decl_stmt|;
specifier|const
name|struct
name|pmc_event_descr
modifier|*
name|ev
decl_stmt|;
switch|switch
condition|(
name|cl
condition|)
block|{
case|case
name|PMC_CLASS_TSC
case|:
name|ev
operator|=
operator|&
name|pmc_event_table
index|[
name|PMC_EV_TSC_TSC
index|]
expr_stmt|;
name|count
operator|=
literal|1
expr_stmt|;
break|break;
case|case
name|PMC_CLASS_K7
case|:
name|ev
operator|=
operator|&
name|pmc_event_table
index|[
name|PMC_EV_K7_FIRST
index|]
expr_stmt|;
name|count
operator|=
name|PMC_EV_K7_LAST
operator|-
name|PMC_EV_K7_FIRST
operator|+
literal|1
expr_stmt|;
break|break;
case|case
name|PMC_CLASS_K8
case|:
name|ev
operator|=
operator|&
name|pmc_event_table
index|[
name|PMC_EV_K8_FIRST
index|]
expr_stmt|;
name|count
operator|=
name|PMC_EV_K8_LAST
operator|-
name|PMC_EV_K8_FIRST
operator|+
literal|1
expr_stmt|;
break|break;
case|case
name|PMC_CLASS_P5
case|:
name|ev
operator|=
operator|&
name|pmc_event_table
index|[
name|PMC_EV_P5_FIRST
index|]
expr_stmt|;
name|count
operator|=
name|PMC_EV_P5_LAST
operator|-
name|PMC_EV_P5_FIRST
operator|+
literal|1
expr_stmt|;
break|break;
case|case
name|PMC_CLASS_P6
case|:
name|ev
operator|=
operator|&
name|pmc_event_table
index|[
name|PMC_EV_P6_FIRST
index|]
expr_stmt|;
name|count
operator|=
name|PMC_EV_P6_LAST
operator|-
name|PMC_EV_P6_FIRST
operator|+
literal|1
expr_stmt|;
break|break;
case|case
name|PMC_CLASS_P4
case|:
name|ev
operator|=
operator|&
name|pmc_event_table
index|[
name|PMC_EV_P4_FIRST
index|]
expr_stmt|;
name|count
operator|=
name|PMC_EV_P4_LAST
operator|-
name|PMC_EV_P4_FIRST
operator|+
literal|1
expr_stmt|;
break|break;
default|default:
name|errno
operator|=
name|EINVAL
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
if|if
condition|(
operator|(
name|names
operator|=
name|malloc
argument_list|(
name|count
operator|*
sizeof|sizeof
argument_list|(
specifier|const
name|char
operator|*
argument_list|)
argument_list|)
operator|)
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
operator|*
name|eventnames
operator|=
name|names
expr_stmt|;
operator|*
name|nevents
operator|=
name|count
expr_stmt|;
for|for
control|(
init|;
name|count
operator|--
condition|;
name|ev
operator|++
operator|,
name|names
operator|++
control|)
operator|*
name|names
operator|=
name|ev
operator|->
name|pm_ev_name
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|int
name|pmc_flush_logfile
parameter_list|(
name|void
parameter_list|)
block|{
return|return
name|PMC_CALL
argument_list|(
name|FLUSHLOG
argument_list|,
literal|0
argument_list|)
return|;
block|}
end_function

begin_function
name|int
name|pmc_get_driver_stats
parameter_list|(
name|struct
name|pmc_driverstats
modifier|*
name|ds
parameter_list|)
block|{
name|struct
name|pmc_op_getdriverstats
name|gms
decl_stmt|;
if|if
condition|(
name|PMC_CALL
argument_list|(
name|GETDRIVERSTATS
argument_list|,
operator|&
name|gms
argument_list|)
operator|<
literal|0
condition|)
return|return
operator|-
literal|1
return|;
comment|/* copy out fields in the current userland<->library interface */
name|ds
operator|->
name|pm_intr_ignored
operator|=
name|gms
operator|.
name|pm_intr_ignored
expr_stmt|;
name|ds
operator|->
name|pm_intr_processed
operator|=
name|gms
operator|.
name|pm_intr_processed
expr_stmt|;
name|ds
operator|->
name|pm_intr_bufferfull
operator|=
name|gms
operator|.
name|pm_intr_bufferfull
expr_stmt|;
name|ds
operator|->
name|pm_syscalls
operator|=
name|gms
operator|.
name|pm_syscalls
expr_stmt|;
name|ds
operator|->
name|pm_syscall_errors
operator|=
name|gms
operator|.
name|pm_syscall_errors
expr_stmt|;
name|ds
operator|->
name|pm_buffer_requests
operator|=
name|gms
operator|.
name|pm_buffer_requests
expr_stmt|;
name|ds
operator|->
name|pm_buffer_requests_failed
operator|=
name|gms
operator|.
name|pm_buffer_requests_failed
expr_stmt|;
name|ds
operator|->
name|pm_log_sweeps
operator|=
name|gms
operator|.
name|pm_log_sweeps
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|int
name|pmc_get_msr
parameter_list|(
name|pmc_id_t
name|pmc
parameter_list|,
name|uint32_t
modifier|*
name|msr
parameter_list|)
block|{
name|struct
name|pmc_op_getmsr
name|gm
decl_stmt|;
name|gm
operator|.
name|pm_pmcid
operator|=
name|pmc
expr_stmt|;
if|if
condition|(
name|PMC_CALL
argument_list|(
name|PMCGETMSR
argument_list|,
operator|&
name|gm
argument_list|)
operator|<
literal|0
condition|)
return|return
operator|-
literal|1
return|;
operator|*
name|msr
operator|=
name|gm
operator|.
name|pm_msr
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|int
name|pmc_init
parameter_list|(
name|void
parameter_list|)
block|{
name|int
name|error
decl_stmt|,
name|pmc_mod_id
decl_stmt|;
name|unsigned
name|int
name|n
decl_stmt|;
name|uint32_t
name|abi_version
decl_stmt|;
name|struct
name|module_stat
name|pmc_modstat
decl_stmt|;
name|struct
name|pmc_op_getcpuinfo
name|op_cpu_info
decl_stmt|;
if|if
condition|(
name|pmc_syscall
operator|!=
operator|-
literal|1
condition|)
comment|/* already inited */
return|return
literal|0
return|;
comment|/* retrieve the system call number from the KLD */
if|if
condition|(
operator|(
name|pmc_mod_id
operator|=
name|modfind
argument_list|(
name|PMC_MODULE_NAME
argument_list|)
operator|)
operator|<
literal|0
condition|)
return|return
operator|-
literal|1
return|;
name|pmc_modstat
operator|.
name|version
operator|=
sizeof|sizeof
argument_list|(
expr|struct
name|module_stat
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|error
operator|=
name|modstat
argument_list|(
name|pmc_mod_id
argument_list|,
operator|&
name|pmc_modstat
argument_list|)
operator|)
operator|<
literal|0
condition|)
return|return
operator|-
literal|1
return|;
name|pmc_syscall
operator|=
name|pmc_modstat
operator|.
name|data
operator|.
name|intval
expr_stmt|;
comment|/* check the kernel module's ABI against our compiled-in version */
name|abi_version
operator|=
name|PMC_VERSION
expr_stmt|;
if|if
condition|(
name|PMC_CALL
argument_list|(
name|GETMODULEVERSION
argument_list|,
operator|&
name|abi_version
argument_list|)
operator|<
literal|0
condition|)
return|return
operator|(
name|pmc_syscall
operator|=
operator|-
literal|1
operator|)
return|;
comment|/* ignore patch& minor numbers for the comparision */
if|if
condition|(
operator|(
name|abi_version
operator|&
literal|0xFF000000
operator|)
operator|!=
operator|(
name|PMC_VERSION
operator|&
literal|0xFF000000
operator|)
condition|)
block|{
name|errno
operator|=
name|EPROGMISMATCH
expr_stmt|;
return|return
operator|(
name|pmc_syscall
operator|=
operator|-
literal|1
operator|)
return|;
block|}
if|if
condition|(
name|PMC_CALL
argument_list|(
name|GETCPUINFO
argument_list|,
operator|&
name|op_cpu_info
argument_list|)
operator|<
literal|0
condition|)
return|return
operator|(
name|pmc_syscall
operator|=
operator|-
literal|1
operator|)
return|;
name|cpu_info
operator|.
name|pm_cputype
operator|=
name|op_cpu_info
operator|.
name|pm_cputype
expr_stmt|;
name|cpu_info
operator|.
name|pm_ncpu
operator|=
name|op_cpu_info
operator|.
name|pm_ncpu
expr_stmt|;
name|cpu_info
operator|.
name|pm_npmc
operator|=
name|op_cpu_info
operator|.
name|pm_npmc
expr_stmt|;
name|cpu_info
operator|.
name|pm_nclass
operator|=
name|op_cpu_info
operator|.
name|pm_nclass
expr_stmt|;
for|for
control|(
name|n
operator|=
literal|0
init|;
name|n
operator|<
name|cpu_info
operator|.
name|pm_nclass
condition|;
name|n
operator|++
control|)
name|cpu_info
operator|.
name|pm_classes
index|[
name|n
index|]
operator|=
name|op_cpu_info
operator|.
name|pm_classes
index|[
name|n
index|]
expr_stmt|;
comment|/* set parser pointer */
switch|switch
condition|(
name|cpu_info
operator|.
name|pm_cputype
condition|)
block|{
if|#
directive|if
name|defined
argument_list|(
name|__i386__
argument_list|)
case|case
name|PMC_CPU_AMD_K7
case|:
name|pmc_mdep_event_aliases
operator|=
name|k7_aliases
expr_stmt|;
name|pmc_mdep_allocate_pmc
operator|=
name|k7_allocate_pmc
expr_stmt|;
break|break;
case|case
name|PMC_CPU_INTEL_P5
case|:
name|pmc_mdep_event_aliases
operator|=
name|p5_aliases
expr_stmt|;
name|pmc_mdep_allocate_pmc
operator|=
name|p5_allocate_pmc
expr_stmt|;
break|break;
case|case
name|PMC_CPU_INTEL_P6
case|:
comment|/* P6 ... Pentium M CPUs have */
case|case
name|PMC_CPU_INTEL_PII
case|:
comment|/* similar PMCs. */
case|case
name|PMC_CPU_INTEL_PIII
case|:
case|case
name|PMC_CPU_INTEL_PM
case|:
name|pmc_mdep_event_aliases
operator|=
name|p6_aliases
expr_stmt|;
name|pmc_mdep_allocate_pmc
operator|=
name|p6_allocate_pmc
expr_stmt|;
break|break;
endif|#
directive|endif
if|#
directive|if
name|defined
argument_list|(
name|__amd64__
argument_list|)
operator|||
name|defined
argument_list|(
name|__i386__
argument_list|)
case|case
name|PMC_CPU_INTEL_PIV
case|:
name|pmc_mdep_event_aliases
operator|=
name|p4_aliases
expr_stmt|;
name|pmc_mdep_allocate_pmc
operator|=
name|p4_allocate_pmc
expr_stmt|;
break|break;
case|case
name|PMC_CPU_AMD_K8
case|:
name|pmc_mdep_event_aliases
operator|=
name|k8_aliases
expr_stmt|;
name|pmc_mdep_allocate_pmc
operator|=
name|k8_allocate_pmc
expr_stmt|;
break|break;
endif|#
directive|endif
default|default:
comment|/* 		 * Some kind of CPU this version of the library knows nothing 		 * about.  This shouldn't happen since the abi version check 		 * should have caught this. 		 */
name|errno
operator|=
name|ENXIO
expr_stmt|;
return|return
operator|(
name|pmc_syscall
operator|=
operator|-
literal|1
operator|)
return|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|const
name|char
modifier|*
name|pmc_name_of_capability
parameter_list|(
name|enum
name|pmc_caps
name|cap
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
comment|/* 	 * 'cap' should have a single bit set and should be in 	 * range. 	 */
if|if
condition|(
operator|(
name|cap
operator|&
operator|(
name|cap
operator|-
literal|1
operator|)
operator|)
operator|||
name|cap
operator|<
name|PMC_CAP_FIRST
operator|||
name|cap
operator|>
name|PMC_CAP_LAST
condition|)
block|{
name|errno
operator|=
name|EINVAL
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|i
operator|=
name|ffs
argument_list|(
name|cap
argument_list|)
expr_stmt|;
return|return
name|pmc_capability_names
index|[
name|i
operator|-
literal|1
index|]
return|;
block|}
end_function

begin_function
specifier|const
name|char
modifier|*
name|pmc_name_of_class
parameter_list|(
name|enum
name|pmc_class
name|pc
parameter_list|)
block|{
if|if
condition|(
operator|(
name|int
operator|)
name|pc
operator|>=
name|PMC_CLASS_FIRST
operator|&&
name|pc
operator|<=
name|PMC_CLASS_LAST
condition|)
return|return
name|pmc_class_names
index|[
name|pc
index|]
return|;
name|errno
operator|=
name|EINVAL
expr_stmt|;
return|return
name|NULL
return|;
block|}
end_function

begin_function
specifier|const
name|char
modifier|*
name|pmc_name_of_cputype
parameter_list|(
name|enum
name|pmc_cputype
name|cp
parameter_list|)
block|{
if|if
condition|(
operator|(
name|int
operator|)
name|cp
operator|>=
name|PMC_CPU_FIRST
operator|&&
name|cp
operator|<=
name|PMC_CPU_LAST
condition|)
return|return
name|pmc_cputype_names
index|[
name|cp
index|]
return|;
name|errno
operator|=
name|EINVAL
expr_stmt|;
return|return
name|NULL
return|;
block|}
end_function

begin_function
specifier|const
name|char
modifier|*
name|pmc_name_of_disposition
parameter_list|(
name|enum
name|pmc_disp
name|pd
parameter_list|)
block|{
if|if
condition|(
operator|(
name|int
operator|)
name|pd
operator|>=
name|PMC_DISP_FIRST
operator|&&
name|pd
operator|<=
name|PMC_DISP_LAST
condition|)
return|return
name|pmc_disposition_names
index|[
name|pd
index|]
return|;
name|errno
operator|=
name|EINVAL
expr_stmt|;
return|return
name|NULL
return|;
block|}
end_function

begin_function
specifier|const
name|char
modifier|*
name|pmc_name_of_event
parameter_list|(
name|enum
name|pmc_event
name|pe
parameter_list|)
block|{
if|if
condition|(
operator|(
name|int
operator|)
name|pe
operator|>=
name|PMC_EVENT_FIRST
operator|&&
name|pe
operator|<=
name|PMC_EVENT_LAST
condition|)
return|return
name|pmc_event_table
index|[
name|pe
index|]
operator|.
name|pm_ev_name
return|;
name|errno
operator|=
name|EINVAL
expr_stmt|;
return|return
name|NULL
return|;
block|}
end_function

begin_function
specifier|const
name|char
modifier|*
name|pmc_name_of_mode
parameter_list|(
name|enum
name|pmc_mode
name|pm
parameter_list|)
block|{
if|if
condition|(
operator|(
name|int
operator|)
name|pm
operator|>=
name|PMC_MODE_FIRST
operator|&&
name|pm
operator|<=
name|PMC_MODE_LAST
condition|)
return|return
name|pmc_mode_names
index|[
name|pm
index|]
return|;
name|errno
operator|=
name|EINVAL
expr_stmt|;
return|return
name|NULL
return|;
block|}
end_function

begin_function
specifier|const
name|char
modifier|*
name|pmc_name_of_state
parameter_list|(
name|enum
name|pmc_state
name|ps
parameter_list|)
block|{
if|if
condition|(
operator|(
name|int
operator|)
name|ps
operator|>=
name|PMC_STATE_FIRST
operator|&&
name|ps
operator|<=
name|PMC_STATE_LAST
condition|)
return|return
name|pmc_state_names
index|[
name|ps
index|]
return|;
name|errno
operator|=
name|EINVAL
expr_stmt|;
return|return
name|NULL
return|;
block|}
end_function

begin_function
name|int
name|pmc_ncpu
parameter_list|(
name|void
parameter_list|)
block|{
if|if
condition|(
name|pmc_syscall
operator|==
operator|-
literal|1
condition|)
block|{
name|errno
operator|=
name|ENXIO
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
return|return
name|cpu_info
operator|.
name|pm_ncpu
return|;
block|}
end_function

begin_function
name|int
name|pmc_npmc
parameter_list|(
name|int
name|cpu
parameter_list|)
block|{
if|if
condition|(
name|pmc_syscall
operator|==
operator|-
literal|1
condition|)
block|{
name|errno
operator|=
name|ENXIO
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
if|if
condition|(
name|cpu
operator|<
literal|0
operator|||
name|cpu
operator|>=
operator|(
name|int
operator|)
name|cpu_info
operator|.
name|pm_ncpu
condition|)
block|{
name|errno
operator|=
name|EINVAL
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
return|return
name|cpu_info
operator|.
name|pm_npmc
return|;
block|}
end_function

begin_function
name|int
name|pmc_pmcinfo
parameter_list|(
name|int
name|cpu
parameter_list|,
name|struct
name|pmc_pmcinfo
modifier|*
modifier|*
name|ppmci
parameter_list|)
block|{
name|int
name|nbytes
decl_stmt|,
name|npmc
decl_stmt|;
name|struct
name|pmc_op_getpmcinfo
modifier|*
name|pmci
decl_stmt|;
if|if
condition|(
operator|(
name|npmc
operator|=
name|pmc_npmc
argument_list|(
name|cpu
argument_list|)
operator|)
operator|<
literal|0
condition|)
return|return
operator|-
literal|1
return|;
name|nbytes
operator|=
sizeof|sizeof
argument_list|(
expr|struct
name|pmc_op_getpmcinfo
argument_list|)
operator|+
name|npmc
operator|*
sizeof|sizeof
argument_list|(
expr|struct
name|pmc_info
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|pmci
operator|=
name|calloc
argument_list|(
literal|1
argument_list|,
name|nbytes
argument_list|)
operator|)
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
name|pmci
operator|->
name|pm_cpu
operator|=
name|cpu
expr_stmt|;
if|if
condition|(
name|PMC_CALL
argument_list|(
name|GETPMCINFO
argument_list|,
name|pmci
argument_list|)
operator|<
literal|0
condition|)
block|{
name|free
argument_list|(
name|pmci
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
comment|/* kernel<->library, library<->userland interfaces are identical */
operator|*
name|ppmci
operator|=
operator|(
expr|struct
name|pmc_pmcinfo
operator|*
operator|)
name|pmci
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|int
name|pmc_read
parameter_list|(
name|pmc_id_t
name|pmc
parameter_list|,
name|pmc_value_t
modifier|*
name|value
parameter_list|)
block|{
name|struct
name|pmc_op_pmcrw
name|pmc_read_op
decl_stmt|;
name|pmc_read_op
operator|.
name|pm_pmcid
operator|=
name|pmc
expr_stmt|;
name|pmc_read_op
operator|.
name|pm_flags
operator|=
name|PMC_F_OLDVALUE
expr_stmt|;
name|pmc_read_op
operator|.
name|pm_value
operator|=
operator|-
literal|1
expr_stmt|;
if|if
condition|(
name|PMC_CALL
argument_list|(
name|PMCRW
argument_list|,
operator|&
name|pmc_read_op
argument_list|)
operator|<
literal|0
condition|)
return|return
operator|-
literal|1
return|;
operator|*
name|value
operator|=
name|pmc_read_op
operator|.
name|pm_value
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|int
name|pmc_release
parameter_list|(
name|pmc_id_t
name|pmc
parameter_list|)
block|{
name|struct
name|pmc_op_simple
name|pmc_release_args
decl_stmt|;
name|pmc_release_args
operator|.
name|pm_pmcid
operator|=
name|pmc
expr_stmt|;
return|return
name|PMC_CALL
argument_list|(
name|PMCRELEASE
argument_list|,
operator|&
name|pmc_release_args
argument_list|)
return|;
block|}
end_function

begin_function
name|int
name|pmc_rw
parameter_list|(
name|pmc_id_t
name|pmc
parameter_list|,
name|pmc_value_t
name|newvalue
parameter_list|,
name|pmc_value_t
modifier|*
name|oldvaluep
parameter_list|)
block|{
name|struct
name|pmc_op_pmcrw
name|pmc_rw_op
decl_stmt|;
name|pmc_rw_op
operator|.
name|pm_pmcid
operator|=
name|pmc
expr_stmt|;
name|pmc_rw_op
operator|.
name|pm_flags
operator|=
name|PMC_F_NEWVALUE
operator||
name|PMC_F_OLDVALUE
expr_stmt|;
name|pmc_rw_op
operator|.
name|pm_value
operator|=
name|newvalue
expr_stmt|;
if|if
condition|(
name|PMC_CALL
argument_list|(
name|PMCRW
argument_list|,
operator|&
name|pmc_rw_op
argument_list|)
operator|<
literal|0
condition|)
return|return
operator|-
literal|1
return|;
operator|*
name|oldvaluep
operator|=
name|pmc_rw_op
operator|.
name|pm_value
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|int
name|pmc_set
parameter_list|(
name|pmc_id_t
name|pmc
parameter_list|,
name|pmc_value_t
name|value
parameter_list|)
block|{
name|struct
name|pmc_op_pmcsetcount
name|sc
decl_stmt|;
name|sc
operator|.
name|pm_pmcid
operator|=
name|pmc
expr_stmt|;
name|sc
operator|.
name|pm_count
operator|=
name|value
expr_stmt|;
if|if
condition|(
name|PMC_CALL
argument_list|(
name|PMCSETCOUNT
argument_list|,
operator|&
name|sc
argument_list|)
operator|<
literal|0
condition|)
return|return
operator|-
literal|1
return|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|int
name|pmc_start
parameter_list|(
name|pmc_id_t
name|pmc
parameter_list|)
block|{
name|struct
name|pmc_op_simple
name|pmc_start_args
decl_stmt|;
name|pmc_start_args
operator|.
name|pm_pmcid
operator|=
name|pmc
expr_stmt|;
return|return
name|PMC_CALL
argument_list|(
name|PMCSTART
argument_list|,
operator|&
name|pmc_start_args
argument_list|)
return|;
block|}
end_function

begin_function
name|int
name|pmc_stop
parameter_list|(
name|pmc_id_t
name|pmc
parameter_list|)
block|{
name|struct
name|pmc_op_simple
name|pmc_stop_args
decl_stmt|;
name|pmc_stop_args
operator|.
name|pm_pmcid
operator|=
name|pmc
expr_stmt|;
return|return
name|PMC_CALL
argument_list|(
name|PMCSTOP
argument_list|,
operator|&
name|pmc_stop_args
argument_list|)
return|;
block|}
end_function

begin_function
name|int
name|pmc_width
parameter_list|(
name|pmc_id_t
name|pmcid
parameter_list|,
name|uint32_t
modifier|*
name|width
parameter_list|)
block|{
name|unsigned
name|int
name|i
decl_stmt|;
name|enum
name|pmc_class
name|cl
decl_stmt|;
name|cl
operator|=
name|PMC_ID_TO_CLASS
argument_list|(
name|pmcid
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|cpu_info
operator|.
name|pm_nclass
condition|;
name|i
operator|++
control|)
if|if
condition|(
name|cpu_info
operator|.
name|pm_classes
index|[
name|i
index|]
operator|.
name|pm_class
operator|==
name|cl
condition|)
block|{
operator|*
name|width
operator|=
name|cpu_info
operator|.
name|pm_classes
index|[
name|i
index|]
operator|.
name|pm_width
expr_stmt|;
return|return
literal|0
return|;
block|}
return|return
name|EINVAL
return|;
block|}
end_function

begin_function
name|int
name|pmc_write
parameter_list|(
name|pmc_id_t
name|pmc
parameter_list|,
name|pmc_value_t
name|value
parameter_list|)
block|{
name|struct
name|pmc_op_pmcrw
name|pmc_write_op
decl_stmt|;
name|pmc_write_op
operator|.
name|pm_pmcid
operator|=
name|pmc
expr_stmt|;
name|pmc_write_op
operator|.
name|pm_flags
operator|=
name|PMC_F_NEWVALUE
expr_stmt|;
name|pmc_write_op
operator|.
name|pm_value
operator|=
name|value
expr_stmt|;
return|return
name|PMC_CALL
argument_list|(
name|PMCRW
argument_list|,
operator|&
name|pmc_write_op
argument_list|)
return|;
block|}
end_function

begin_function
name|int
name|pmc_writelog
parameter_list|(
name|uint32_t
name|userdata
parameter_list|)
block|{
name|struct
name|pmc_op_writelog
name|wl
decl_stmt|;
name|wl
operator|.
name|pm_userdata
operator|=
name|userdata
expr_stmt|;
return|return
name|PMC_CALL
argument_list|(
name|WRITELOG
argument_list|,
operator|&
name|wl
argument_list|)
return|;
block|}
end_function

end_unit


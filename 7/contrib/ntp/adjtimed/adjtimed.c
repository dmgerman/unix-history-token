begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*************************************************************************/
end_comment

begin_comment
comment|/* (c) Copyright Tai Jin, 1988.  All Rights Reserved.                    */
end_comment

begin_comment
comment|/*     Hewlett-Packard Laboratories.                                     */
end_comment

begin_comment
comment|/*                                                                       */
end_comment

begin_comment
comment|/* Permission is hereby granted for unlimited modification, use, and     */
end_comment

begin_comment
comment|/* distribution.  This software is made available with no warranty of    */
end_comment

begin_comment
comment|/* any kind, express or implied.  This copyright notice must remain      */
end_comment

begin_comment
comment|/* intact in all versions of this software.                              */
end_comment

begin_comment
comment|/*                                                                       */
end_comment

begin_comment
comment|/* The author would appreciate it if any bug fixes and enhancements were */
end_comment

begin_comment
comment|/* to be sent back to him for incorporation into future versions of this */
end_comment

begin_comment
comment|/* software.  Please send changes to tai@iag.hp.com or ken@sdd.hp.com.   */
end_comment

begin_comment
comment|/*************************************************************************/
end_comment

begin_ifndef
ifndef|#
directive|ifndef
name|lint
end_ifndef

begin_decl_stmt
specifier|static
name|char
name|RCSid
index|[]
init|=
literal|"adjtimed.c,v 3.1 1993/07/06 01:04:45 jbj Exp"
decl_stmt|;
end_decl_stmt

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/*  * Adjust time daemon.  * This daemon adjusts the rate of the system clock a la BSD's adjtime().  * The adjtime() routine uses SYSV messages to communicate with this daemon.  *  * Caveat: This emulation uses an undocumented kernel variable.  As such, it  * cannot be guaranteed to work in future HP-UX releases.  Fortunately,  * it will no longer be needed in HPUX 10.01 and later.  */
end_comment

begin_include
include|#
directive|include
file|<sys/param.h>
end_include

begin_include
include|#
directive|include
file|<sys/types.h>
end_include

begin_include
include|#
directive|include
file|<sys/ipc.h>
end_include

begin_include
include|#
directive|include
file|<sys/msg.h>
end_include

begin_include
include|#
directive|include
file|<sys/lock.h>
end_include

begin_include
include|#
directive|include
file|<time.h>
end_include

begin_include
include|#
directive|include
file|<signal.h>
end_include

begin_include
include|#
directive|include
file|<nlist.h>
end_include

begin_include
include|#
directive|include
file|<fcntl.h>
end_include

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_include
include|#
directive|include
file|<unistd.h>
end_include

begin_include
include|#
directive|include
file|"ntp_syslog.h"
end_include

begin_include
include|#
directive|include
file|"ntp_stdlib.h"
end_include

begin_include
include|#
directive|include
file|"adjtime.h"
end_include

begin_function_decl
name|double
name|atof
parameter_list|(
specifier|const
name|char
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|int
name|InitClockRate
parameter_list|(
name|void
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|int
name|AdjustClockRate
parameter_list|(
specifier|register
name|struct
name|timeval
modifier|*
name|delta
parameter_list|,
specifier|register
name|struct
name|timeval
modifier|*
name|olddelta
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|long
name|GetClockRate
parameter_list|(
name|void
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|int
name|SetClockRate
parameter_list|(
name|long
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|void
name|ResetClockRate
parameter_list|(
name|void
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|void
name|Cleanup
parameter_list|(
name|void
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|void
name|Exit
parameter_list|(
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_define
define|#
directive|define
name|MILLION
value|1000000L
end_define

begin_comment
comment|/* emacs cc-mode goes nuts if we split the next line... */
end_comment

begin_define
define|#
directive|define
name|tvtod
parameter_list|(
name|tv
parameter_list|)
value|((double)tv.tv_sec + ((double)tv.tv_usec / (double)MILLION))
end_define

begin_decl_stmt
name|char
modifier|*
name|progname
init|=
name|NULL
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|verbose
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|sysdebug
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|mqid
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|double
name|oldrate
init|=
literal|0.0
decl_stmt|;
end_decl_stmt

begin_function
name|int
name|main
parameter_list|(
name|int
name|argc
parameter_list|,
name|char
modifier|*
name|argv
index|[]
parameter_list|)
block|{
name|struct
name|timeval
name|remains
decl_stmt|;
name|struct
name|sigvec
name|vec
decl_stmt|;
name|MsgBuf
name|msg
decl_stmt|;
name|char
name|ch
decl_stmt|;
name|int
name|nofork
init|=
literal|0
decl_stmt|;
name|int
name|fd
decl_stmt|;
name|progname
operator|=
name|argv
index|[
literal|0
index|]
expr_stmt|;
ifdef|#
directive|ifdef
name|LOG_LOCAL6
name|openlog
argument_list|(
literal|"adjtimed"
argument_list|,
name|LOG_PID
argument_list|,
name|LOG_LOCAL6
argument_list|)
expr_stmt|;
else|#
directive|else
name|openlog
argument_list|(
literal|"adjtimed"
argument_list|,
name|LOG_PID
argument_list|)
expr_stmt|;
endif|#
directive|endif
while|while
condition|(
operator|(
name|ch
operator|=
name|ntp_getopt
argument_list|(
name|argc
argument_list|,
name|argv
argument_list|,
literal|"hkrvdfp:"
argument_list|)
operator|)
operator|!=
name|EOF
condition|)
block|{
switch|switch
condition|(
name|ch
condition|)
block|{
case|case
literal|'k'
case|:
case|case
literal|'r'
case|:
if|if
condition|(
operator|(
name|mqid
operator|=
name|msgget
argument_list|(
name|KEY
argument_list|,
literal|0
argument_list|)
operator|)
operator|!=
operator|-
literal|1
condition|)
block|{
if|if
condition|(
name|msgctl
argument_list|(
name|mqid
argument_list|,
name|IPC_RMID
argument_list|,
operator|(
expr|struct
name|msqid_ds
operator|*
operator|)
literal|0
argument_list|)
operator|==
operator|-
literal|1
condition|)
block|{
name|msyslog
argument_list|(
name|LOG_ERR
argument_list|,
literal|"remove old message queue: %m"
argument_list|)
expr_stmt|;
name|perror
argument_list|(
literal|"adjtimed: remove old message queue"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
name|ch
operator|==
literal|'k'
condition|)
name|exit
argument_list|(
literal|0
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'v'
case|:
operator|++
name|verbose
operator|,
name|nofork
operator|=
literal|1
expr_stmt|;
break|break;
case|case
literal|'d'
case|:
operator|++
name|sysdebug
expr_stmt|;
break|break;
case|case
literal|'f'
case|:
name|nofork
operator|=
literal|1
expr_stmt|;
break|break;
case|case
literal|'p'
case|:
name|fputs
argument_list|(
literal|"adjtimed: -p option ignored\n"
argument_list|,
name|stderr
argument_list|)
expr_stmt|;
break|break;
default|default:
name|puts
argument_list|(
literal|"usage: adjtimed -hkrvdf"
argument_list|)
expr_stmt|;
name|puts
argument_list|(
literal|"-h\thelp"
argument_list|)
expr_stmt|;
name|puts
argument_list|(
literal|"-k\tkill existing adjtimed, if any"
argument_list|)
expr_stmt|;
name|puts
argument_list|(
literal|"-r\trestart (kills existing adjtimed, if any)"
argument_list|)
expr_stmt|;
name|puts
argument_list|(
literal|"-v\tdebug output (repeat for more output)"
argument_list|)
expr_stmt|;
name|puts
argument_list|(
literal|"-d\tsyslog output (repeat for more output)"
argument_list|)
expr_stmt|;
name|puts
argument_list|(
literal|"-f\tno fork"
argument_list|)
expr_stmt|;
name|msyslog
argument_list|(
name|LOG_ERR
argument_list|,
literal|"usage error"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
comment|/* switch */
block|}
comment|/* while */
if|if
condition|(
operator|!
name|nofork
condition|)
block|{
switch|switch
condition|(
name|fork
argument_list|()
condition|)
block|{
case|case
literal|0
case|:
name|close
argument_list|(
name|fileno
argument_list|(
name|stdin
argument_list|)
argument_list|)
expr_stmt|;
name|close
argument_list|(
name|fileno
argument_list|(
name|stdout
argument_list|)
argument_list|)
expr_stmt|;
name|close
argument_list|(
name|fileno
argument_list|(
name|stderr
argument_list|)
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|TIOCNOTTY
if|if
condition|(
operator|(
name|fd
operator|=
name|open
argument_list|(
literal|"/dev/tty"
argument_list|)
operator|)
operator|!=
operator|-
literal|1
condition|)
block|{
name|ioctl
argument_list|(
name|fd
argument_list|,
name|TIOCNOTTY
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|close
argument_list|(
name|fd
argument_list|)
expr_stmt|;
block|}
else|#
directive|else
name|setpgrp
argument_list|()
expr_stmt|;
endif|#
directive|endif
break|break;
case|case
operator|-
literal|1
case|:
name|msyslog
argument_list|(
name|LOG_ERR
argument_list|,
literal|"fork: %m"
argument_list|)
expr_stmt|;
name|perror
argument_list|(
literal|"adjtimed: fork"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
default|default:
name|exit
argument_list|(
literal|0
argument_list|)
expr_stmt|;
block|}
comment|/* switch */
block|}
comment|/* if */
if|if
condition|(
name|nofork
condition|)
block|{
name|setvbuf
argument_list|(
name|stdout
argument_list|,
name|NULL
argument_list|,
name|_IONBF
argument_list|,
name|BUFSIZ
argument_list|)
expr_stmt|;
name|setvbuf
argument_list|(
name|stderr
argument_list|,
name|NULL
argument_list|,
name|_IONBF
argument_list|,
name|BUFSIZ
argument_list|)
expr_stmt|;
block|}
name|msyslog
argument_list|(
name|LOG_INFO
argument_list|,
literal|"started"
argument_list|)
expr_stmt|;
if|if
condition|(
name|verbose
condition|)
name|printf
argument_list|(
literal|"adjtimed: started\n"
argument_list|)
expr_stmt|;
if|if
condition|(
name|InitClockRate
argument_list|()
operator|==
operator|-
literal|1
condition|)
name|Exit
argument_list|(
literal|2
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|signal
argument_list|(
name|SIGHUP
argument_list|,
name|SIG_IGN
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|signal
argument_list|(
name|SIGINT
argument_list|,
name|SIG_IGN
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|signal
argument_list|(
name|SIGQUIT
argument_list|,
name|SIG_IGN
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|signal
argument_list|(
name|SIGTERM
argument_list|,
name|Cleanup
argument_list|)
expr_stmt|;
name|vec
operator|.
name|sv_handler
operator|=
name|ResetClockRate
expr_stmt|;
name|vec
operator|.
name|sv_flags
operator|=
literal|0
expr_stmt|;
name|vec
operator|.
name|sv_mask
operator|=
operator|~
literal|0
expr_stmt|;
name|sigvector
argument_list|(
name|SIGALRM
argument_list|,
operator|&
name|vec
argument_list|,
operator|(
expr|struct
name|sigvec
operator|*
operator|)
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|msgget
argument_list|(
name|KEY
argument_list|,
name|IPC_CREAT
operator||
name|IPC_EXCL
argument_list|)
operator|==
operator|-
literal|1
condition|)
block|{
if|if
condition|(
name|errno
operator|==
name|EEXIST
condition|)
block|{
name|msyslog
argument_list|(
name|LOG_ERR
argument_list|,
literal|"message queue already exists, use -r to remove it"
argument_list|)
expr_stmt|;
name|fputs
argument_list|(
literal|"adjtimed: message queue already exists, use -r to remove it\n"
argument_list|,
name|stderr
argument_list|)
expr_stmt|;
name|Exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
name|msyslog
argument_list|(
name|LOG_ERR
argument_list|,
literal|"create message queue: %m"
argument_list|)
expr_stmt|;
name|perror
argument_list|(
literal|"adjtimed: create message queue"
argument_list|)
expr_stmt|;
name|Exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|mqid
operator|=
name|msgget
argument_list|(
name|KEY
argument_list|,
literal|0
argument_list|)
operator|)
operator|==
operator|-
literal|1
condition|)
block|{
name|msyslog
argument_list|(
name|LOG_ERR
argument_list|,
literal|"get message queue id: %m"
argument_list|)
expr_stmt|;
name|perror
argument_list|(
literal|"adjtimed: get message queue id"
argument_list|)
expr_stmt|;
name|Exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
comment|/* Lock process in memory to improve response time */
if|if
condition|(
name|plock
argument_list|(
name|PROCLOCK
argument_list|)
condition|)
block|{
name|msyslog
argument_list|(
name|LOG_ERR
argument_list|,
literal|"plock: %m"
argument_list|)
expr_stmt|;
name|perror
argument_list|(
literal|"adjtimed: plock"
argument_list|)
expr_stmt|;
name|Cleanup
argument_list|()
expr_stmt|;
block|}
comment|/* Also raise process priority. 	 * If we do not get run when we want, this leads to bad timekeeping 	 * and "Previous time adjustment didn't complete" gripes from xntpd. 	 */
if|if
condition|(
name|nice
argument_list|(
operator|-
literal|10
argument_list|)
operator|==
operator|-
literal|1
condition|)
block|{
name|msyslog
argument_list|(
name|LOG_ERR
argument_list|,
literal|"nice: %m"
argument_list|)
expr_stmt|;
name|perror
argument_list|(
literal|"adjtimed: nice"
argument_list|)
expr_stmt|;
name|Cleanup
argument_list|()
expr_stmt|;
block|}
for|for
control|(
init|;
condition|;
control|)
block|{
if|if
condition|(
name|msgrcv
argument_list|(
name|mqid
argument_list|,
operator|&
name|msg
operator|.
name|msgp
argument_list|,
name|MSGSIZE
argument_list|,
name|CLIENT
argument_list|,
literal|0
argument_list|)
operator|==
operator|-
literal|1
condition|)
block|{
if|if
condition|(
name|errno
operator|==
name|EINTR
condition|)
continue|continue;
name|msyslog
argument_list|(
name|LOG_ERR
argument_list|,
literal|"read message: %m"
argument_list|)
expr_stmt|;
name|perror
argument_list|(
literal|"adjtimed: read message"
argument_list|)
expr_stmt|;
name|Cleanup
argument_list|()
expr_stmt|;
block|}
switch|switch
condition|(
name|msg
operator|.
name|msgb
operator|.
name|code
condition|)
block|{
case|case
name|DELTA1
case|:
case|case
name|DELTA2
case|:
name|AdjustClockRate
argument_list|(
operator|&
name|msg
operator|.
name|msgb
operator|.
name|tv
argument_list|,
operator|&
name|remains
argument_list|)
expr_stmt|;
if|if
condition|(
name|msg
operator|.
name|msgb
operator|.
name|code
operator|==
name|DELTA2
condition|)
block|{
name|msg
operator|.
name|msgb
operator|.
name|tv
operator|=
name|remains
expr_stmt|;
name|msg
operator|.
name|msgb
operator|.
name|mtype
operator|=
name|SERVER
expr_stmt|;
while|while
condition|(
name|msgsnd
argument_list|(
name|mqid
argument_list|,
operator|&
name|msg
operator|.
name|msgp
argument_list|,
name|MSGSIZE
argument_list|,
literal|0
argument_list|)
operator|==
operator|-
literal|1
condition|)
block|{
if|if
condition|(
name|errno
operator|==
name|EINTR
condition|)
continue|continue;
name|msyslog
argument_list|(
name|LOG_ERR
argument_list|,
literal|"send message: %m"
argument_list|)
expr_stmt|;
name|perror
argument_list|(
literal|"adjtimed: send message"
argument_list|)
expr_stmt|;
name|Cleanup
argument_list|()
expr_stmt|;
block|}
block|}
if|if
condition|(
name|remains
operator|.
name|tv_sec
operator|+
name|remains
operator|.
name|tv_usec
operator|!=
literal|0L
condition|)
block|{
if|if
condition|(
name|verbose
condition|)
block|{
name|printf
argument_list|(
literal|"adjtimed: previous correction remaining %.6fs\n"
argument_list|,
name|tvtod
argument_list|(
name|remains
argument_list|)
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|sysdebug
condition|)
block|{
name|msyslog
argument_list|(
name|LOG_INFO
argument_list|,
literal|"previous correction remaining %.6fs"
argument_list|,
name|tvtod
argument_list|(
name|remains
argument_list|)
argument_list|)
expr_stmt|;
block|}
block|}
break|break;
default|default:
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"adjtimed: unknown message code %d\n"
argument_list|,
name|msg
operator|.
name|msgb
operator|.
name|code
argument_list|)
expr_stmt|;
name|msyslog
argument_list|(
name|LOG_ERR
argument_list|,
literal|"unknown message code %d"
argument_list|,
name|msg
operator|.
name|msgb
operator|.
name|code
argument_list|)
expr_stmt|;
block|}
comment|/* switch */
block|}
comment|/* loop */
block|}
end_function

begin_comment
comment|/* main */
end_comment

begin_comment
comment|/*  * Default clock rate (old_tick).  */
end_comment

begin_define
define|#
directive|define
name|DEFAULT_RATE
value|(MILLION / HZ)
end_define

begin_define
define|#
directive|define
name|UNKNOWN_RATE
value|0L
end_define

begin_define
define|#
directive|define
name|TICK_ADJ
value|5
end_define

begin_comment
comment|/* standard adjustment rate, microsec/tick */
end_comment

begin_decl_stmt
specifier|static
name|long
name|default_rate
init|=
name|DEFAULT_RATE
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|long
name|tick_rate
init|=
name|HZ
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* ticks per sec */
end_comment

begin_decl_stmt
specifier|static
name|long
name|slew_rate
init|=
name|TICK_ADJ
operator|*
name|HZ
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* in microsec/sec */
end_comment

begin_function
name|int
name|AdjustClockRate
parameter_list|(
specifier|register
name|struct
name|timeval
modifier|*
name|delta
parameter_list|,
specifier|register
name|struct
name|timeval
modifier|*
name|olddelta
parameter_list|)
block|{
specifier|register
name|long
name|rate
decl_stmt|,
name|dt
decl_stmt|,
name|leftover
decl_stmt|;
name|struct
name|itimerval
name|period
decl_stmt|,
name|remains
decl_stmt|;
name|dt
operator|=
operator|(
name|delta
operator|->
name|tv_sec
operator|*
name|MILLION
operator|)
operator|+
name|delta
operator|->
name|tv_usec
expr_stmt|;
if|if
condition|(
name|verbose
condition|)
name|printf
argument_list|(
literal|"adjtimed: new correction %.6fs\n"
argument_list|,
operator|(
name|double
operator|)
name|dt
operator|/
operator|(
name|double
operator|)
name|MILLION
argument_list|)
expr_stmt|;
if|if
condition|(
name|sysdebug
condition|)
name|msyslog
argument_list|(
name|LOG_INFO
argument_list|,
literal|"new correction %.6fs"
argument_list|,
operator|(
name|double
operator|)
name|dt
operator|/
operator|(
name|double
operator|)
name|MILLION
argument_list|)
expr_stmt|;
if|if
condition|(
name|verbose
operator|>
literal|2
condition|)
name|printf
argument_list|(
literal|"adjtimed: leftover %ldus\n"
argument_list|,
name|leftover
argument_list|)
expr_stmt|;
if|if
condition|(
name|sysdebug
operator|>
literal|2
condition|)
name|msyslog
argument_list|(
name|LOG_INFO
argument_list|,
literal|"leftover %ldus"
argument_list|,
name|leftover
argument_list|)
expr_stmt|;
name|rate
operator|=
name|dt
expr_stmt|;
comment|/* 	 * Apply a slew rate of slew_rate over a period of dt/slew_rate seconds. 	 */
if|if
condition|(
name|dt
operator|>
literal|0
condition|)
block|{
name|rate
operator|=
name|slew_rate
expr_stmt|;
block|}
else|else
block|{
name|rate
operator|=
operator|-
name|slew_rate
expr_stmt|;
name|dt
operator|=
operator|-
name|dt
expr_stmt|;
block|}
name|period
operator|.
name|it_value
operator|.
name|tv_sec
operator|=
name|dt
operator|/
name|slew_rate
expr_stmt|;
name|period
operator|.
name|it_value
operator|.
name|tv_usec
operator|=
operator|(
name|dt
operator|%
name|slew_rate
operator|)
operator|*
operator|(
name|MILLION
operator|/
name|slew_rate
operator|)
expr_stmt|;
comment|/* 	 * Note: we assume the kernel will convert the specified period into ticks 	 * using the modified clock rate rather than an assumed nominal clock rate, 	 * and therefore will generate the timer interrupt after the specified 	 * number of true seconds, not skewed seconds. 	 */
if|if
condition|(
name|verbose
operator|>
literal|1
condition|)
name|printf
argument_list|(
literal|"adjtimed: will be complete in %lds %ldus\n"
argument_list|,
name|period
operator|.
name|it_value
operator|.
name|tv_sec
argument_list|,
name|period
operator|.
name|it_value
operator|.
name|tv_usec
argument_list|)
expr_stmt|;
if|if
condition|(
name|sysdebug
operator|>
literal|1
condition|)
name|msyslog
argument_list|(
name|LOG_INFO
argument_list|,
literal|"will be complete in %lds %ldus"
argument_list|,
name|period
operator|.
name|it_value
operator|.
name|tv_sec
argument_list|,
name|period
operator|.
name|it_value
operator|.
name|tv_usec
argument_list|)
expr_stmt|;
comment|/* 	 * adjust the clock rate 	 */
if|if
condition|(
name|dt
condition|)
block|{
if|if
condition|(
name|SetClockRate
argument_list|(
operator|(
name|rate
operator|/
name|tick_rate
operator|)
operator|+
name|default_rate
argument_list|)
operator|==
operator|-
literal|1
condition|)
block|{
name|msyslog
argument_list|(
name|LOG_ERR
argument_list|,
literal|"set clock rate: %m"
argument_list|)
expr_stmt|;
name|perror
argument_list|(
literal|"adjtimed: set clock rate"
argument_list|)
expr_stmt|;
block|}
block|}
comment|/* 	 * start the timer 	 * (do this after changing the rate because the period has been rounded down) 	 */
name|period
operator|.
name|it_interval
operator|.
name|tv_sec
operator|=
name|period
operator|.
name|it_interval
operator|.
name|tv_usec
operator|=
literal|0L
expr_stmt|;
name|setitimer
argument_list|(
name|ITIMER_REAL
argument_list|,
operator|&
name|period
argument_list|,
operator|&
name|remains
argument_list|)
expr_stmt|;
comment|/* 	 * return old delta 	 */
if|if
condition|(
name|olddelta
condition|)
block|{
name|dt
operator|=
operator|(
operator|(
name|remains
operator|.
name|it_value
operator|.
name|tv_sec
operator|*
name|MILLION
operator|)
operator|+
name|remains
operator|.
name|it_value
operator|.
name|tv_usec
operator|)
operator|*
name|oldrate
expr_stmt|;
name|olddelta
operator|->
name|tv_sec
operator|=
name|dt
operator|/
name|MILLION
expr_stmt|;
name|olddelta
operator|->
name|tv_usec
operator|=
name|dt
operator|-
operator|(
name|olddelta
operator|->
name|tv_sec
operator|*
name|MILLION
operator|)
expr_stmt|;
block|}
name|oldrate
operator|=
operator|(
name|double
operator|)
name|rate
operator|/
operator|(
name|double
operator|)
name|MILLION
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_comment
comment|/* AdjustClockRate */
end_comment

begin_decl_stmt
specifier|static
name|struct
name|nlist
name|nl
index|[]
init|=
block|{
ifdef|#
directive|ifdef
name|__hp9000s800
ifdef|#
directive|ifdef
name|PRE7_0
block|{
literal|"tick"
block|}
block|,
else|#
directive|else
block|{
literal|"old_tick"
block|}
block|,
endif|#
directive|endif
else|#
directive|else
block|{
literal|"_old_tick"
block|}
block|,
endif|#
directive|endif
block|{
literal|""
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|kmem
decl_stmt|;
end_decl_stmt

begin_comment
comment|/*  * The return value is the clock rate in old_tick units or -1 if error.  */
end_comment

begin_function
name|long
name|GetClockRate
parameter_list|(
name|void
parameter_list|)
block|{
name|long
name|rate
decl_stmt|,
name|mask
decl_stmt|;
if|if
condition|(
name|lseek
argument_list|(
name|kmem
argument_list|,
operator|(
name|off_t
operator|)
name|nl
index|[
literal|0
index|]
operator|.
name|n_value
argument_list|,
literal|0
argument_list|)
operator|==
operator|-
literal|1L
condition|)
return|return
operator|(
operator|-
literal|1L
operator|)
return|;
name|mask
operator|=
name|sigblock
argument_list|(
name|sigmask
argument_list|(
name|SIGALRM
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|read
argument_list|(
name|kmem
argument_list|,
operator|(
name|caddr_t
operator|)
operator|&
name|rate
argument_list|,
sizeof|sizeof
argument_list|(
name|rate
argument_list|)
argument_list|)
operator|!=
sizeof|sizeof
argument_list|(
name|rate
argument_list|)
condition|)
name|rate
operator|=
name|UNKNOWN_RATE
expr_stmt|;
name|sigsetmask
argument_list|(
name|mask
argument_list|)
expr_stmt|;
return|return
operator|(
name|rate
operator|)
return|;
block|}
end_function

begin_comment
comment|/* GetClockRate */
end_comment

begin_comment
comment|/*  * The argument is the new rate in old_tick units.  */
end_comment

begin_function
name|int
name|SetClockRate
parameter_list|(
name|long
name|rate
parameter_list|)
block|{
name|long
name|mask
decl_stmt|;
if|if
condition|(
name|lseek
argument_list|(
name|kmem
argument_list|,
operator|(
name|off_t
operator|)
name|nl
index|[
literal|0
index|]
operator|.
name|n_value
argument_list|,
literal|0
argument_list|)
operator|==
operator|-
literal|1L
condition|)
return|return
operator|(
operator|-
literal|1
operator|)
return|;
name|mask
operator|=
name|sigblock
argument_list|(
name|sigmask
argument_list|(
name|SIGALRM
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|write
argument_list|(
name|kmem
argument_list|,
operator|(
name|caddr_t
operator|)
operator|&
name|rate
argument_list|,
sizeof|sizeof
argument_list|(
name|rate
argument_list|)
argument_list|)
operator|!=
sizeof|sizeof
argument_list|(
name|rate
argument_list|)
condition|)
block|{
name|sigsetmask
argument_list|(
name|mask
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
name|sigsetmask
argument_list|(
name|mask
argument_list|)
expr_stmt|;
if|if
condition|(
name|rate
operator|!=
name|default_rate
condition|)
block|{
if|if
condition|(
name|verbose
operator|>
literal|3
condition|)
block|{
name|printf
argument_list|(
literal|"adjtimed: clock rate (%lu) %ldus/s\n"
argument_list|,
name|rate
argument_list|,
operator|(
name|rate
operator|-
name|default_rate
operator|)
operator|*
name|tick_rate
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|sysdebug
operator|>
literal|3
condition|)
block|{
name|msyslog
argument_list|(
name|LOG_INFO
argument_list|,
literal|"clock rate (%lu) %ldus/s"
argument_list|,
name|rate
argument_list|,
operator|(
name|rate
operator|-
name|default_rate
operator|)
operator|*
name|tick_rate
argument_list|)
expr_stmt|;
block|}
block|}
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_comment
comment|/* SetClockRate */
end_comment

begin_function
name|int
name|InitClockRate
parameter_list|(
name|void
parameter_list|)
block|{
if|if
condition|(
operator|(
name|kmem
operator|=
name|open
argument_list|(
literal|"/dev/kmem"
argument_list|,
name|O_RDWR
argument_list|)
operator|)
operator|==
operator|-
literal|1
condition|)
block|{
name|msyslog
argument_list|(
name|LOG_ERR
argument_list|,
literal|"open(/dev/kmem): %m"
argument_list|)
expr_stmt|;
name|perror
argument_list|(
literal|"adjtimed: open(/dev/kmem)"
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
name|nlist
argument_list|(
literal|"/hp-ux"
argument_list|,
name|nl
argument_list|)
expr_stmt|;
if|if
condition|(
name|nl
index|[
literal|0
index|]
operator|.
name|n_type
operator|==
literal|0
condition|)
block|{
name|fputs
argument_list|(
literal|"adjtimed: /hp-ux has no symbol table\n"
argument_list|,
name|stderr
argument_list|)
expr_stmt|;
name|msyslog
argument_list|(
name|LOG_ERR
argument_list|,
literal|"/hp-ux has no symbol table"
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
comment|/* 	 * Set the default to the system's original value 	 */
name|default_rate
operator|=
name|GetClockRate
argument_list|()
expr_stmt|;
if|if
condition|(
name|default_rate
operator|==
name|UNKNOWN_RATE
condition|)
name|default_rate
operator|=
name|DEFAULT_RATE
expr_stmt|;
name|tick_rate
operator|=
operator|(
name|MILLION
operator|/
name|default_rate
operator|)
expr_stmt|;
name|slew_rate
operator|=
name|TICK_ADJ
operator|*
name|tick_rate
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"default_rate=%ld, tick_rate=%ld, slew_rate=%ld\n"
argument_list|,
name|default_rate
argument_list|,
name|tick_rate
argument_list|,
name|slew_rate
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_comment
comment|/* InitClockRate */
end_comment

begin_comment
comment|/*  * Reset the clock rate to the default value.  */
end_comment

begin_function
name|void
name|ResetClockRate
parameter_list|(
name|void
parameter_list|)
block|{
name|struct
name|itimerval
name|it
decl_stmt|;
name|it
operator|.
name|it_value
operator|.
name|tv_sec
operator|=
name|it
operator|.
name|it_value
operator|.
name|tv_usec
operator|=
literal|0L
expr_stmt|;
name|setitimer
argument_list|(
name|ITIMER_REAL
argument_list|,
operator|&
name|it
argument_list|,
operator|(
expr|struct
name|itimerval
operator|*
operator|)
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|verbose
operator|>
literal|2
condition|)
name|puts
argument_list|(
literal|"adjtimed: resetting the clock"
argument_list|)
expr_stmt|;
if|if
condition|(
name|sysdebug
operator|>
literal|2
condition|)
name|msyslog
argument_list|(
name|LOG_INFO
argument_list|,
literal|"resetting the clock"
argument_list|)
expr_stmt|;
if|if
condition|(
name|GetClockRate
argument_list|()
operator|!=
name|default_rate
condition|)
block|{
if|if
condition|(
name|SetClockRate
argument_list|(
name|default_rate
argument_list|)
operator|==
operator|-
literal|1
condition|)
block|{
name|msyslog
argument_list|(
name|LOG_ERR
argument_list|,
literal|"set clock rate: %m"
argument_list|)
expr_stmt|;
name|perror
argument_list|(
literal|"adjtimed: set clock rate"
argument_list|)
expr_stmt|;
block|}
block|}
name|oldrate
operator|=
literal|0.0
expr_stmt|;
block|}
end_function

begin_comment
comment|/* ResetClockRate */
end_comment

begin_function
name|void
name|Cleanup
parameter_list|(
name|void
parameter_list|)
block|{
name|ResetClockRate
argument_list|()
expr_stmt|;
if|if
condition|(
name|msgctl
argument_list|(
name|mqid
argument_list|,
name|IPC_RMID
argument_list|,
operator|(
expr|struct
name|msqid_ds
operator|*
operator|)
literal|0
argument_list|)
operator|==
operator|-
literal|1
condition|)
block|{
if|if
condition|(
name|errno
operator|!=
name|EINVAL
condition|)
block|{
name|msyslog
argument_list|(
name|LOG_ERR
argument_list|,
literal|"remove message queue: %m"
argument_list|)
expr_stmt|;
name|perror
argument_list|(
literal|"adjtimed: remove message queue"
argument_list|)
expr_stmt|;
block|}
block|}
name|Exit
argument_list|(
literal|2
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* Cleanup */
end_comment

begin_function
name|void
name|Exit
parameter_list|(
name|status
parameter_list|)
name|int
name|status
decl_stmt|;
block|{
name|msyslog
argument_list|(
name|LOG_ERR
argument_list|,
literal|"terminated"
argument_list|)
expr_stmt|;
name|closelog
argument_list|()
expr_stmt|;
if|if
condition|(
name|kmem
operator|!=
operator|-
literal|1
condition|)
name|close
argument_list|(
name|kmem
argument_list|)
expr_stmt|;
name|exit
argument_list|(
name|status
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* Exit */
end_comment

end_unit


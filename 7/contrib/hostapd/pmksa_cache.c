begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * hostapd - PMKSA cache for IEEE 802.11i RSN  * Copyright (c) 2004-2006, Jouni Malinen<j@w1.fi>  *  * This program is free software; you can redistribute it and/or modify  * it under the terms of the GNU General Public License version 2 as  * published by the Free Software Foundation.  *  * Alternatively, this software may be distributed under the terms of BSD  * license.  *  * See README and COPYING for more details.  */
end_comment

begin_include
include|#
directive|include
file|"includes.h"
end_include

begin_include
include|#
directive|include
file|"hostapd.h"
end_include

begin_include
include|#
directive|include
file|"common.h"
end_include

begin_include
include|#
directive|include
file|"wpa.h"
end_include

begin_include
include|#
directive|include
file|"eloop.h"
end_include

begin_include
include|#
directive|include
file|"sha1.h"
end_include

begin_include
include|#
directive|include
file|"ieee802_1x.h"
end_include

begin_include
include|#
directive|include
file|"eapol_sm.h"
end_include

begin_include
include|#
directive|include
file|"pmksa_cache.h"
end_include

begin_decl_stmt
specifier|static
specifier|const
name|int
name|pmksa_cache_max_entries
init|=
literal|1024
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
specifier|const
name|int
name|dot11RSNAConfigPMKLifetime
init|=
literal|43200
decl_stmt|;
end_decl_stmt

begin_struct
struct|struct
name|rsn_pmksa_cache
block|{
define|#
directive|define
name|PMKID_HASH_SIZE
value|128
define|#
directive|define
name|PMKID_HASH
parameter_list|(
name|pmkid
parameter_list|)
value|(unsigned int) ((pmkid)[0]& 0x7f)
name|struct
name|rsn_pmksa_cache_entry
modifier|*
name|pmkid
index|[
name|PMKID_HASH_SIZE
index|]
decl_stmt|;
name|struct
name|rsn_pmksa_cache_entry
modifier|*
name|pmksa
decl_stmt|;
name|int
name|pmksa_count
decl_stmt|;
name|void
function_decl|(
modifier|*
name|free_cb
function_decl|)
parameter_list|(
name|struct
name|rsn_pmksa_cache_entry
modifier|*
name|entry
parameter_list|,
name|void
modifier|*
name|ctx
parameter_list|)
function_decl|;
name|void
modifier|*
name|ctx
decl_stmt|;
block|}
struct|;
end_struct

begin_comment
comment|/**  * rsn_pmkid - Calculate PMK identifier  * @pmk: Pairwise master key  * @pmk_len: Length of pmk in bytes  * @aa: Authenticator address  * @spa: Supplicant address  *  * IEEE Std 802.11i-2004 - 8.5.1.2 Pairwise key hierarchy  * PMKID = HMAC-SHA1-128(PMK, "PMK Name" || AA || SPA)  */
end_comment

begin_function
name|void
name|rsn_pmkid
parameter_list|(
specifier|const
name|u8
modifier|*
name|pmk
parameter_list|,
name|size_t
name|pmk_len
parameter_list|,
specifier|const
name|u8
modifier|*
name|aa
parameter_list|,
specifier|const
name|u8
modifier|*
name|spa
parameter_list|,
name|u8
modifier|*
name|pmkid
parameter_list|)
block|{
name|char
modifier|*
name|title
init|=
literal|"PMK Name"
decl_stmt|;
specifier|const
name|u8
modifier|*
name|addr
index|[
literal|3
index|]
decl_stmt|;
specifier|const
name|size_t
name|len
index|[
literal|3
index|]
init|=
block|{
literal|8
block|,
name|ETH_ALEN
block|,
name|ETH_ALEN
block|}
decl_stmt|;
name|unsigned
name|char
name|hash
index|[
name|SHA1_MAC_LEN
index|]
decl_stmt|;
name|addr
index|[
literal|0
index|]
operator|=
operator|(
name|u8
operator|*
operator|)
name|title
expr_stmt|;
name|addr
index|[
literal|1
index|]
operator|=
name|aa
expr_stmt|;
name|addr
index|[
literal|2
index|]
operator|=
name|spa
expr_stmt|;
name|hmac_sha1_vector
argument_list|(
name|pmk
argument_list|,
name|pmk_len
argument_list|,
literal|3
argument_list|,
name|addr
argument_list|,
name|len
argument_list|,
name|hash
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
name|pmkid
argument_list|,
name|hash
argument_list|,
name|PMKID_LEN
argument_list|)
expr_stmt|;
block|}
end_function

begin_function_decl
specifier|static
name|void
name|pmksa_cache_set_expiration
parameter_list|(
name|struct
name|rsn_pmksa_cache
modifier|*
name|pmksa
parameter_list|)
function_decl|;
end_function_decl

begin_function
specifier|static
name|void
name|_pmksa_cache_free_entry
parameter_list|(
name|struct
name|rsn_pmksa_cache_entry
modifier|*
name|entry
parameter_list|)
block|{
if|if
condition|(
name|entry
operator|==
name|NULL
condition|)
return|return;
name|free
argument_list|(
name|entry
operator|->
name|identity
argument_list|)
expr_stmt|;
name|ieee802_1x_free_radius_class
argument_list|(
operator|&
name|entry
operator|->
name|radius_class
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|entry
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|pmksa_cache_free_entry
parameter_list|(
name|struct
name|rsn_pmksa_cache
modifier|*
name|pmksa
parameter_list|,
name|struct
name|rsn_pmksa_cache_entry
modifier|*
name|entry
parameter_list|)
block|{
name|struct
name|rsn_pmksa_cache_entry
modifier|*
name|pos
decl_stmt|,
modifier|*
name|prev
decl_stmt|;
name|pmksa
operator|->
name|pmksa_count
operator|--
expr_stmt|;
name|pmksa
operator|->
name|free_cb
argument_list|(
name|entry
argument_list|,
name|pmksa
operator|->
name|ctx
argument_list|)
expr_stmt|;
name|pos
operator|=
name|pmksa
operator|->
name|pmkid
index|[
name|PMKID_HASH
argument_list|(
name|entry
operator|->
name|pmkid
argument_list|)
index|]
expr_stmt|;
name|prev
operator|=
name|NULL
expr_stmt|;
while|while
condition|(
name|pos
condition|)
block|{
if|if
condition|(
name|pos
operator|==
name|entry
condition|)
block|{
if|if
condition|(
name|prev
operator|!=
name|NULL
condition|)
block|{
name|prev
operator|->
name|hnext
operator|=
name|pos
operator|->
name|hnext
expr_stmt|;
block|}
else|else
block|{
name|pmksa
operator|->
name|pmkid
index|[
name|PMKID_HASH
argument_list|(
name|entry
operator|->
name|pmkid
argument_list|)
index|]
operator|=
name|pos
operator|->
name|hnext
expr_stmt|;
block|}
break|break;
block|}
name|prev
operator|=
name|pos
expr_stmt|;
name|pos
operator|=
name|pos
operator|->
name|hnext
expr_stmt|;
block|}
name|pos
operator|=
name|pmksa
operator|->
name|pmksa
expr_stmt|;
name|prev
operator|=
name|NULL
expr_stmt|;
while|while
condition|(
name|pos
condition|)
block|{
if|if
condition|(
name|pos
operator|==
name|entry
condition|)
block|{
if|if
condition|(
name|prev
operator|!=
name|NULL
condition|)
name|prev
operator|->
name|next
operator|=
name|pos
operator|->
name|next
expr_stmt|;
else|else
name|pmksa
operator|->
name|pmksa
operator|=
name|pos
operator|->
name|next
expr_stmt|;
break|break;
block|}
name|prev
operator|=
name|pos
expr_stmt|;
name|pos
operator|=
name|pos
operator|->
name|next
expr_stmt|;
block|}
name|_pmksa_cache_free_entry
argument_list|(
name|entry
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|pmksa_cache_expire
parameter_list|(
name|void
modifier|*
name|eloop_ctx
parameter_list|,
name|void
modifier|*
name|timeout_ctx
parameter_list|)
block|{
name|struct
name|rsn_pmksa_cache
modifier|*
name|pmksa
init|=
name|eloop_ctx
decl_stmt|;
name|struct
name|os_time
name|now
decl_stmt|;
name|os_get_time
argument_list|(
operator|&
name|now
argument_list|)
expr_stmt|;
while|while
condition|(
name|pmksa
operator|->
name|pmksa
operator|&&
name|pmksa
operator|->
name|pmksa
operator|->
name|expiration
operator|<=
name|now
operator|.
name|sec
condition|)
block|{
name|struct
name|rsn_pmksa_cache_entry
modifier|*
name|entry
init|=
name|pmksa
operator|->
name|pmksa
decl_stmt|;
name|pmksa
operator|->
name|pmksa
operator|=
name|entry
operator|->
name|next
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"RSN: expired PMKSA cache entry for "
name|MACSTR
argument_list|,
name|MAC2STR
argument_list|(
name|entry
operator|->
name|spa
argument_list|)
argument_list|)
expr_stmt|;
name|pmksa_cache_free_entry
argument_list|(
name|pmksa
argument_list|,
name|entry
argument_list|)
expr_stmt|;
block|}
name|pmksa_cache_set_expiration
argument_list|(
name|pmksa
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|pmksa_cache_set_expiration
parameter_list|(
name|struct
name|rsn_pmksa_cache
modifier|*
name|pmksa
parameter_list|)
block|{
name|int
name|sec
decl_stmt|;
name|struct
name|os_time
name|now
decl_stmt|;
name|eloop_cancel_timeout
argument_list|(
name|pmksa_cache_expire
argument_list|,
name|pmksa
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|pmksa
operator|->
name|pmksa
operator|==
name|NULL
condition|)
return|return;
name|os_get_time
argument_list|(
operator|&
name|now
argument_list|)
expr_stmt|;
name|sec
operator|=
name|pmksa
operator|->
name|pmksa
operator|->
name|expiration
operator|-
name|now
operator|.
name|sec
expr_stmt|;
if|if
condition|(
name|sec
operator|<
literal|0
condition|)
name|sec
operator|=
literal|0
expr_stmt|;
name|eloop_register_timeout
argument_list|(
name|sec
operator|+
literal|1
argument_list|,
literal|0
argument_list|,
name|pmksa_cache_expire
argument_list|,
name|pmksa
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|pmksa_cache_from_eapol_data
parameter_list|(
name|struct
name|rsn_pmksa_cache_entry
modifier|*
name|entry
parameter_list|,
name|struct
name|eapol_state_machine
modifier|*
name|eapol
parameter_list|)
block|{
if|if
condition|(
name|eapol
operator|==
name|NULL
condition|)
return|return;
if|if
condition|(
name|eapol
operator|->
name|identity
condition|)
block|{
name|entry
operator|->
name|identity
operator|=
name|malloc
argument_list|(
name|eapol
operator|->
name|identity_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|entry
operator|->
name|identity
condition|)
block|{
name|entry
operator|->
name|identity_len
operator|=
name|eapol
operator|->
name|identity_len
expr_stmt|;
name|memcpy
argument_list|(
name|entry
operator|->
name|identity
argument_list|,
name|eapol
operator|->
name|identity
argument_list|,
name|eapol
operator|->
name|identity_len
argument_list|)
expr_stmt|;
block|}
block|}
name|ieee802_1x_copy_radius_class
argument_list|(
operator|&
name|entry
operator|->
name|radius_class
argument_list|,
operator|&
name|eapol
operator|->
name|radius_class
argument_list|)
expr_stmt|;
name|entry
operator|->
name|eap_type_authsrv
operator|=
name|eapol
operator|->
name|eap_type_authsrv
expr_stmt|;
name|entry
operator|->
name|vlan_id
operator|=
name|eapol
operator|->
name|sta
operator|->
name|vlan_id
expr_stmt|;
block|}
end_function

begin_function
name|void
name|pmksa_cache_to_eapol_data
parameter_list|(
name|struct
name|rsn_pmksa_cache_entry
modifier|*
name|entry
parameter_list|,
name|struct
name|eapol_state_machine
modifier|*
name|eapol
parameter_list|)
block|{
if|if
condition|(
name|entry
operator|==
name|NULL
operator|||
name|eapol
operator|==
name|NULL
condition|)
return|return;
if|if
condition|(
name|entry
operator|->
name|identity
condition|)
block|{
name|free
argument_list|(
name|eapol
operator|->
name|identity
argument_list|)
expr_stmt|;
name|eapol
operator|->
name|identity
operator|=
name|malloc
argument_list|(
name|entry
operator|->
name|identity_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|eapol
operator|->
name|identity
condition|)
block|{
name|eapol
operator|->
name|identity_len
operator|=
name|entry
operator|->
name|identity_len
expr_stmt|;
name|memcpy
argument_list|(
name|eapol
operator|->
name|identity
argument_list|,
name|entry
operator|->
name|identity
argument_list|,
name|entry
operator|->
name|identity_len
argument_list|)
expr_stmt|;
block|}
name|wpa_hexdump_ascii
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"STA identity from PMKSA"
argument_list|,
name|eapol
operator|->
name|identity
argument_list|,
name|eapol
operator|->
name|identity_len
argument_list|)
expr_stmt|;
block|}
name|ieee802_1x_free_radius_class
argument_list|(
operator|&
name|eapol
operator|->
name|radius_class
argument_list|)
expr_stmt|;
name|ieee802_1x_copy_radius_class
argument_list|(
operator|&
name|eapol
operator|->
name|radius_class
argument_list|,
operator|&
name|entry
operator|->
name|radius_class
argument_list|)
expr_stmt|;
if|if
condition|(
name|eapol
operator|->
name|radius_class
operator|.
name|attr
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"Copied %lu Class attribute(s) from "
literal|"PMKSA"
argument_list|,
operator|(
name|unsigned
name|long
operator|)
name|eapol
operator|->
name|radius_class
operator|.
name|count
argument_list|)
expr_stmt|;
block|}
name|eapol
operator|->
name|eap_type_authsrv
operator|=
name|entry
operator|->
name|eap_type_authsrv
expr_stmt|;
name|eapol
operator|->
name|sta
operator|->
name|vlan_id
operator|=
name|entry
operator|->
name|vlan_id
expr_stmt|;
block|}
end_function

begin_comment
comment|/**  * pmksa_cache_add - Add a PMKSA cache entry  * @pmksa: Pointer to PMKSA cache data from pmksa_cache_init()  * @pmk: The new pairwise master key  * @pmk_len: PMK length in bytes, usually PMK_LEN (32)  * @aa: Authenticator address  * @spa: Supplicant address  * @session_timeout: Session timeout  * @eapol: Pointer to EAPOL state machine data  * Returns: Pointer to the added PMKSA cache entry or %NULL on error  *  * This function create a PMKSA entry for a new PMK and adds it to the PMKSA  * cache. If an old entry is already in the cache for the same Supplicant,  * this entry will be replaced with the new entry. PMKID will be calculated  * based on the PMK.  */
end_comment

begin_function
name|struct
name|rsn_pmksa_cache_entry
modifier|*
name|pmksa_cache_add
parameter_list|(
name|struct
name|rsn_pmksa_cache
modifier|*
name|pmksa
parameter_list|,
specifier|const
name|u8
modifier|*
name|pmk
parameter_list|,
name|size_t
name|pmk_len
parameter_list|,
specifier|const
name|u8
modifier|*
name|aa
parameter_list|,
specifier|const
name|u8
modifier|*
name|spa
parameter_list|,
name|int
name|session_timeout
parameter_list|,
name|struct
name|eapol_state_machine
modifier|*
name|eapol
parameter_list|)
block|{
name|struct
name|rsn_pmksa_cache_entry
modifier|*
name|entry
decl_stmt|,
modifier|*
name|pos
decl_stmt|,
modifier|*
name|prev
decl_stmt|;
name|struct
name|os_time
name|now
decl_stmt|;
if|if
condition|(
name|pmk_len
operator|>
name|PMK_LEN
condition|)
return|return
name|NULL
return|;
name|entry
operator|=
name|wpa_zalloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|entry
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|entry
operator|==
name|NULL
condition|)
return|return
name|NULL
return|;
name|memcpy
argument_list|(
name|entry
operator|->
name|pmk
argument_list|,
name|pmk
argument_list|,
name|pmk_len
argument_list|)
expr_stmt|;
name|entry
operator|->
name|pmk_len
operator|=
name|pmk_len
expr_stmt|;
name|rsn_pmkid
argument_list|(
name|pmk
argument_list|,
name|pmk_len
argument_list|,
name|aa
argument_list|,
name|spa
argument_list|,
name|entry
operator|->
name|pmkid
argument_list|)
expr_stmt|;
name|os_get_time
argument_list|(
operator|&
name|now
argument_list|)
expr_stmt|;
name|entry
operator|->
name|expiration
operator|=
name|now
operator|.
name|sec
expr_stmt|;
if|if
condition|(
name|session_timeout
operator|>
literal|0
condition|)
name|entry
operator|->
name|expiration
operator|+=
name|session_timeout
expr_stmt|;
else|else
name|entry
operator|->
name|expiration
operator|+=
name|dot11RSNAConfigPMKLifetime
expr_stmt|;
name|entry
operator|->
name|akmp
operator|=
name|WPA_KEY_MGMT_IEEE8021X
expr_stmt|;
name|memcpy
argument_list|(
name|entry
operator|->
name|spa
argument_list|,
name|spa
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
name|pmksa_cache_from_eapol_data
argument_list|(
name|entry
argument_list|,
name|eapol
argument_list|)
expr_stmt|;
comment|/* Replace an old entry for the same STA (if found) with the new entry 	 */
name|pos
operator|=
name|pmksa_cache_get
argument_list|(
name|pmksa
argument_list|,
name|spa
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|pos
condition|)
name|pmksa_cache_free_entry
argument_list|(
name|pmksa
argument_list|,
name|pos
argument_list|)
expr_stmt|;
if|if
condition|(
name|pmksa
operator|->
name|pmksa_count
operator|>=
name|pmksa_cache_max_entries
operator|&&
name|pmksa
operator|->
name|pmksa
condition|)
block|{
comment|/* Remove the oldest entry to make room for the new entry */
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"RSN: removed the oldest PMKSA cache "
literal|"entry (for "
name|MACSTR
literal|") to make room for new one"
argument_list|,
name|MAC2STR
argument_list|(
name|pmksa
operator|->
name|pmksa
operator|->
name|spa
argument_list|)
argument_list|)
expr_stmt|;
name|pmksa_cache_free_entry
argument_list|(
name|pmksa
argument_list|,
name|pmksa
operator|->
name|pmksa
argument_list|)
expr_stmt|;
block|}
comment|/* Add the new entry; order by expiration time */
name|pos
operator|=
name|pmksa
operator|->
name|pmksa
expr_stmt|;
name|prev
operator|=
name|NULL
expr_stmt|;
while|while
condition|(
name|pos
condition|)
block|{
if|if
condition|(
name|pos
operator|->
name|expiration
operator|>
name|entry
operator|->
name|expiration
condition|)
break|break;
name|prev
operator|=
name|pos
expr_stmt|;
name|pos
operator|=
name|pos
operator|->
name|next
expr_stmt|;
block|}
if|if
condition|(
name|prev
operator|==
name|NULL
condition|)
block|{
name|entry
operator|->
name|next
operator|=
name|pmksa
operator|->
name|pmksa
expr_stmt|;
name|pmksa
operator|->
name|pmksa
operator|=
name|entry
expr_stmt|;
block|}
else|else
block|{
name|entry
operator|->
name|next
operator|=
name|prev
operator|->
name|next
expr_stmt|;
name|prev
operator|->
name|next
operator|=
name|entry
expr_stmt|;
block|}
name|entry
operator|->
name|hnext
operator|=
name|pmksa
operator|->
name|pmkid
index|[
name|PMKID_HASH
argument_list|(
name|entry
operator|->
name|pmkid
argument_list|)
index|]
expr_stmt|;
name|pmksa
operator|->
name|pmkid
index|[
name|PMKID_HASH
argument_list|(
name|entry
operator|->
name|pmkid
argument_list|)
index|]
operator|=
name|entry
expr_stmt|;
name|pmksa
operator|->
name|pmksa_count
operator|++
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"RSN: added PMKSA cache entry for "
name|MACSTR
argument_list|,
name|MAC2STR
argument_list|(
name|entry
operator|->
name|spa
argument_list|)
argument_list|)
expr_stmt|;
name|wpa_hexdump
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"RSN: added PMKID"
argument_list|,
name|entry
operator|->
name|pmkid
argument_list|,
name|PMKID_LEN
argument_list|)
expr_stmt|;
return|return
name|entry
return|;
block|}
end_function

begin_comment
comment|/**  * pmksa_cache_deinit - Free all entries in PMKSA cache  * @pmksa: Pointer to PMKSA cache data from pmksa_cache_init()  */
end_comment

begin_function
name|void
name|pmksa_cache_deinit
parameter_list|(
name|struct
name|rsn_pmksa_cache
modifier|*
name|pmksa
parameter_list|)
block|{
name|struct
name|rsn_pmksa_cache_entry
modifier|*
name|entry
decl_stmt|,
modifier|*
name|prev
decl_stmt|;
name|int
name|i
decl_stmt|;
if|if
condition|(
name|pmksa
operator|==
name|NULL
condition|)
return|return;
name|entry
operator|=
name|pmksa
operator|->
name|pmksa
expr_stmt|;
while|while
condition|(
name|entry
condition|)
block|{
name|prev
operator|=
name|entry
expr_stmt|;
name|entry
operator|=
name|entry
operator|->
name|next
expr_stmt|;
name|_pmksa_cache_free_entry
argument_list|(
name|prev
argument_list|)
expr_stmt|;
block|}
name|eloop_cancel_timeout
argument_list|(
name|pmksa_cache_expire
argument_list|,
name|pmksa
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|PMKID_HASH_SIZE
condition|;
name|i
operator|++
control|)
name|pmksa
operator|->
name|pmkid
index|[
name|i
index|]
operator|=
name|NULL
expr_stmt|;
name|free
argument_list|(
name|pmksa
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/**  * pmksa_cache_get - Fetch a PMKSA cache entry  * @pmksa: Pointer to PMKSA cache data from pmksa_cache_init()  * @spa: Supplicant address or %NULL to match any  * @pmkid: PMKID or %NULL to match any  * Returns: Pointer to PMKSA cache entry or %NULL if no match was found  */
end_comment

begin_function
name|struct
name|rsn_pmksa_cache_entry
modifier|*
name|pmksa_cache_get
parameter_list|(
name|struct
name|rsn_pmksa_cache
modifier|*
name|pmksa
parameter_list|,
specifier|const
name|u8
modifier|*
name|spa
parameter_list|,
specifier|const
name|u8
modifier|*
name|pmkid
parameter_list|)
block|{
name|struct
name|rsn_pmksa_cache_entry
modifier|*
name|entry
decl_stmt|;
if|if
condition|(
name|pmkid
condition|)
name|entry
operator|=
name|pmksa
operator|->
name|pmkid
index|[
name|PMKID_HASH
argument_list|(
name|pmkid
argument_list|)
index|]
expr_stmt|;
else|else
name|entry
operator|=
name|pmksa
operator|->
name|pmksa
expr_stmt|;
while|while
condition|(
name|entry
condition|)
block|{
if|if
condition|(
operator|(
name|spa
operator|==
name|NULL
operator|||
name|memcmp
argument_list|(
name|entry
operator|->
name|spa
argument_list|,
name|spa
argument_list|,
name|ETH_ALEN
argument_list|)
operator|==
literal|0
operator|)
operator|&&
operator|(
name|pmkid
operator|==
name|NULL
operator|||
name|memcmp
argument_list|(
name|entry
operator|->
name|pmkid
argument_list|,
name|pmkid
argument_list|,
name|PMKID_LEN
argument_list|)
operator|==
literal|0
operator|)
condition|)
return|return
name|entry
return|;
name|entry
operator|=
name|pmkid
condition|?
name|entry
operator|->
name|hnext
else|:
name|entry
operator|->
name|next
expr_stmt|;
block|}
return|return
name|NULL
return|;
block|}
end_function

begin_comment
comment|/**  * pmksa_cache_init - Initialize PMKSA cache  * @free_cb: Callback function to be called when a PMKSA cache entry is freed  * @ctx: Context pointer for free_cb function  * Returns: Pointer to PMKSA cache data or %NULL on failure  */
end_comment

begin_function
name|struct
name|rsn_pmksa_cache
modifier|*
name|pmksa_cache_init
parameter_list|(
name|void
function_decl|(
modifier|*
name|free_cb
function_decl|)
parameter_list|(
name|struct
name|rsn_pmksa_cache_entry
modifier|*
name|entry
parameter_list|,
name|void
modifier|*
name|ctx
parameter_list|)
parameter_list|,
name|void
modifier|*
name|ctx
parameter_list|)
block|{
name|struct
name|rsn_pmksa_cache
modifier|*
name|pmksa
decl_stmt|;
name|pmksa
operator|=
name|wpa_zalloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|pmksa
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|pmksa
condition|)
block|{
name|pmksa
operator|->
name|free_cb
operator|=
name|free_cb
expr_stmt|;
name|pmksa
operator|->
name|ctx
operator|=
name|ctx
expr_stmt|;
block|}
return|return
name|pmksa
return|;
block|}
end_function

end_unit


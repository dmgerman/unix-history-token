begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * hostapd / EAP-SIM (RFC 4186)  * Copyright (c) 2005-2008, Jouni Malinen<j@w1.fi>  *  * This program is free software; you can redistribute it and/or modify  * it under the terms of the GNU General Public License version 2 as  * published by the Free Software Foundation.  *  * Alternatively, this software may be distributed under the terms of BSD  * license.  *  * See README and COPYING for more details.  */
end_comment

begin_include
include|#
directive|include
file|"includes.h"
end_include

begin_include
include|#
directive|include
file|"hostapd.h"
end_include

begin_include
include|#
directive|include
file|"common.h"
end_include

begin_include
include|#
directive|include
file|"crypto.h"
end_include

begin_include
include|#
directive|include
file|"eap_i.h"
end_include

begin_include
include|#
directive|include
file|"eap_sim_common.h"
end_include

begin_include
include|#
directive|include
file|"eap_sim_db.h"
end_include

begin_struct
struct|struct
name|eap_sim_data
block|{
name|u8
name|mk
index|[
name|EAP_SIM_MK_LEN
index|]
decl_stmt|;
name|u8
name|nonce_mt
index|[
name|EAP_SIM_NONCE_MT_LEN
index|]
decl_stmt|;
name|u8
name|nonce_s
index|[
name|EAP_SIM_NONCE_S_LEN
index|]
decl_stmt|;
name|u8
name|k_aut
index|[
name|EAP_SIM_K_AUT_LEN
index|]
decl_stmt|;
name|u8
name|k_encr
index|[
name|EAP_SIM_K_ENCR_LEN
index|]
decl_stmt|;
name|u8
name|msk
index|[
name|EAP_SIM_KEYING_DATA_LEN
index|]
decl_stmt|;
name|u8
name|emsk
index|[
name|EAP_EMSK_LEN
index|]
decl_stmt|;
name|u8
name|kc
index|[
name|EAP_SIM_MAX_CHAL
index|]
index|[
name|EAP_SIM_KC_LEN
index|]
decl_stmt|;
name|u8
name|sres
index|[
name|EAP_SIM_MAX_CHAL
index|]
index|[
name|EAP_SIM_SRES_LEN
index|]
decl_stmt|;
name|u8
name|rand
index|[
name|EAP_SIM_MAX_CHAL
index|]
index|[
name|GSM_RAND_LEN
index|]
decl_stmt|;
name|int
name|num_chal
decl_stmt|;
enum|enum
block|{
name|START
block|,
name|CHALLENGE
block|,
name|REAUTH
block|,
name|SUCCESS
block|,
name|FAILURE
block|}
name|state
enum|;
name|char
modifier|*
name|next_pseudonym
decl_stmt|;
name|char
modifier|*
name|next_reauth_id
decl_stmt|;
name|u16
name|counter
decl_stmt|;
name|struct
name|eap_sim_reauth
modifier|*
name|reauth
decl_stmt|;
block|}
struct|;
end_struct

begin_function
specifier|static
specifier|const
name|char
modifier|*
name|eap_sim_state_txt
parameter_list|(
name|int
name|state
parameter_list|)
block|{
switch|switch
condition|(
name|state
condition|)
block|{
case|case
name|START
case|:
return|return
literal|"START"
return|;
case|case
name|CHALLENGE
case|:
return|return
literal|"CHALLENGE"
return|;
case|case
name|REAUTH
case|:
return|return
literal|"REAUTH"
return|;
case|case
name|SUCCESS
case|:
return|return
literal|"SUCCESS"
return|;
case|case
name|FAILURE
case|:
return|return
literal|"FAILURE"
return|;
default|default:
return|return
literal|"Unknown?!"
return|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|eap_sim_state
parameter_list|(
name|struct
name|eap_sim_data
modifier|*
name|data
parameter_list|,
name|int
name|state
parameter_list|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"EAP-SIM: %s -> %s"
argument_list|,
name|eap_sim_state_txt
argument_list|(
name|data
operator|->
name|state
argument_list|)
argument_list|,
name|eap_sim_state_txt
argument_list|(
name|state
argument_list|)
argument_list|)
expr_stmt|;
name|data
operator|->
name|state
operator|=
name|state
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
modifier|*
name|eap_sim_init
parameter_list|(
name|struct
name|eap_sm
modifier|*
name|sm
parameter_list|)
block|{
name|struct
name|eap_sim_data
modifier|*
name|data
decl_stmt|;
if|if
condition|(
name|sm
operator|->
name|eap_sim_db_priv
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_WARNING
argument_list|,
literal|"EAP-SIM: eap_sim_db not configured"
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|data
operator|=
name|wpa_zalloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|data
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|data
operator|==
name|NULL
condition|)
return|return
name|NULL
return|;
name|data
operator|->
name|state
operator|=
name|START
expr_stmt|;
return|return
name|data
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|eap_sim_reset
parameter_list|(
name|struct
name|eap_sm
modifier|*
name|sm
parameter_list|,
name|void
modifier|*
name|priv
parameter_list|)
block|{
name|struct
name|eap_sim_data
modifier|*
name|data
init|=
name|priv
decl_stmt|;
name|free
argument_list|(
name|data
operator|->
name|next_pseudonym
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|data
operator|->
name|next_reauth_id
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|data
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|u8
modifier|*
name|eap_sim_build_start
parameter_list|(
name|struct
name|eap_sm
modifier|*
name|sm
parameter_list|,
name|struct
name|eap_sim_data
modifier|*
name|data
parameter_list|,
name|int
name|id
parameter_list|,
name|size_t
modifier|*
name|reqDataLen
parameter_list|)
block|{
name|struct
name|eap_sim_msg
modifier|*
name|msg
decl_stmt|;
name|u8
name|ver
index|[
literal|2
index|]
decl_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"EAP-SIM: Generating Start"
argument_list|)
expr_stmt|;
name|msg
operator|=
name|eap_sim_msg_init
argument_list|(
name|EAP_CODE_REQUEST
argument_list|,
name|id
argument_list|,
name|EAP_TYPE_SIM
argument_list|,
name|EAP_SIM_SUBTYPE_START
argument_list|)
expr_stmt|;
if|if
condition|(
name|eap_sim_db_identity_known
argument_list|(
name|sm
operator|->
name|eap_sim_db_priv
argument_list|,
name|sm
operator|->
name|identity
argument_list|,
name|sm
operator|->
name|identity_len
argument_list|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"   AT_PERMANENT_ID_REQ"
argument_list|)
expr_stmt|;
name|eap_sim_msg_add
argument_list|(
name|msg
argument_list|,
name|EAP_SIM_AT_PERMANENT_ID_REQ
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|/* 		 * RFC 4186, Chap. 4.2.4 recommends that identity from EAP is 		 * ignored and the SIM/Start is used to request the identity. 		 */
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"   AT_ANY_ID_REQ"
argument_list|)
expr_stmt|;
name|eap_sim_msg_add
argument_list|(
name|msg
argument_list|,
name|EAP_SIM_AT_ANY_ID_REQ
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"   AT_VERSION_LIST"
argument_list|)
expr_stmt|;
name|ver
index|[
literal|0
index|]
operator|=
literal|0
expr_stmt|;
name|ver
index|[
literal|1
index|]
operator|=
name|EAP_SIM_VERSION
expr_stmt|;
name|eap_sim_msg_add
argument_list|(
name|msg
argument_list|,
name|EAP_SIM_AT_VERSION_LIST
argument_list|,
sizeof|sizeof
argument_list|(
name|ver
argument_list|)
argument_list|,
name|ver
argument_list|,
sizeof|sizeof
argument_list|(
name|ver
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|eap_sim_msg_finish
argument_list|(
name|msg
argument_list|,
name|reqDataLen
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|eap_sim_build_encr
parameter_list|(
name|struct
name|eap_sm
modifier|*
name|sm
parameter_list|,
name|struct
name|eap_sim_data
modifier|*
name|data
parameter_list|,
name|struct
name|eap_sim_msg
modifier|*
name|msg
parameter_list|,
name|u16
name|counter
parameter_list|,
specifier|const
name|u8
modifier|*
name|nonce_s
parameter_list|)
block|{
name|free
argument_list|(
name|data
operator|->
name|next_pseudonym
argument_list|)
expr_stmt|;
name|data
operator|->
name|next_pseudonym
operator|=
name|eap_sim_db_get_next_pseudonym
argument_list|(
name|sm
operator|->
name|eap_sim_db_priv
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|data
operator|->
name|next_reauth_id
argument_list|)
expr_stmt|;
if|if
condition|(
name|data
operator|->
name|counter
operator|<=
name|EAP_SIM_MAX_FAST_REAUTHS
condition|)
block|{
name|data
operator|->
name|next_reauth_id
operator|=
name|eap_sim_db_get_next_reauth_id
argument_list|(
name|sm
operator|->
name|eap_sim_db_priv
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"EAP-SIM: Max fast re-authentication "
literal|"count exceeded - force full authentication"
argument_list|)
expr_stmt|;
name|data
operator|->
name|next_reauth_id
operator|=
name|NULL
expr_stmt|;
block|}
if|if
condition|(
name|data
operator|->
name|next_pseudonym
operator|==
name|NULL
operator|&&
name|data
operator|->
name|next_reauth_id
operator|==
name|NULL
operator|&&
name|counter
operator|==
literal|0
operator|&&
name|nonce_s
operator|==
name|NULL
condition|)
return|return
literal|0
return|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"   AT_IV"
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"   AT_ENCR_DATA"
argument_list|)
expr_stmt|;
name|eap_sim_msg_add_encr_start
argument_list|(
name|msg
argument_list|,
name|EAP_SIM_AT_IV
argument_list|,
name|EAP_SIM_AT_ENCR_DATA
argument_list|)
expr_stmt|;
if|if
condition|(
name|counter
operator|>
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"   *AT_COUNTER (%u)"
argument_list|,
name|counter
argument_list|)
expr_stmt|;
name|eap_sim_msg_add
argument_list|(
name|msg
argument_list|,
name|EAP_SIM_AT_COUNTER
argument_list|,
name|counter
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|nonce_s
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"   *AT_NONCE_S"
argument_list|)
expr_stmt|;
name|eap_sim_msg_add
argument_list|(
name|msg
argument_list|,
name|EAP_SIM_AT_NONCE_S
argument_list|,
literal|0
argument_list|,
name|nonce_s
argument_list|,
name|EAP_SIM_NONCE_S_LEN
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|data
operator|->
name|next_pseudonym
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"   *AT_NEXT_PSEUDONYM (%s)"
argument_list|,
name|data
operator|->
name|next_pseudonym
argument_list|)
expr_stmt|;
name|eap_sim_msg_add
argument_list|(
name|msg
argument_list|,
name|EAP_SIM_AT_NEXT_PSEUDONYM
argument_list|,
name|strlen
argument_list|(
name|data
operator|->
name|next_pseudonym
argument_list|)
argument_list|,
operator|(
name|u8
operator|*
operator|)
name|data
operator|->
name|next_pseudonym
argument_list|,
name|strlen
argument_list|(
name|data
operator|->
name|next_pseudonym
argument_list|)
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|data
operator|->
name|next_reauth_id
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"   *AT_NEXT_REAUTH_ID (%s)"
argument_list|,
name|data
operator|->
name|next_reauth_id
argument_list|)
expr_stmt|;
name|eap_sim_msg_add
argument_list|(
name|msg
argument_list|,
name|EAP_SIM_AT_NEXT_REAUTH_ID
argument_list|,
name|strlen
argument_list|(
name|data
operator|->
name|next_reauth_id
argument_list|)
argument_list|,
operator|(
name|u8
operator|*
operator|)
name|data
operator|->
name|next_reauth_id
argument_list|,
name|strlen
argument_list|(
name|data
operator|->
name|next_reauth_id
argument_list|)
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|eap_sim_msg_add_encr_end
argument_list|(
name|msg
argument_list|,
name|data
operator|->
name|k_encr
argument_list|,
name|EAP_SIM_AT_PADDING
argument_list|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_WARNING
argument_list|,
literal|"EAP-SIM: Failed to encrypt "
literal|"AT_ENCR_DATA"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|u8
modifier|*
name|eap_sim_build_challenge
parameter_list|(
name|struct
name|eap_sm
modifier|*
name|sm
parameter_list|,
name|struct
name|eap_sim_data
modifier|*
name|data
parameter_list|,
name|int
name|id
parameter_list|,
name|size_t
modifier|*
name|reqDataLen
parameter_list|)
block|{
name|struct
name|eap_sim_msg
modifier|*
name|msg
decl_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"EAP-SIM: Generating Challenge"
argument_list|)
expr_stmt|;
name|msg
operator|=
name|eap_sim_msg_init
argument_list|(
name|EAP_CODE_REQUEST
argument_list|,
name|id
argument_list|,
name|EAP_TYPE_SIM
argument_list|,
name|EAP_SIM_SUBTYPE_CHALLENGE
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"   AT_RAND"
argument_list|)
expr_stmt|;
name|eap_sim_msg_add
argument_list|(
name|msg
argument_list|,
name|EAP_SIM_AT_RAND
argument_list|,
literal|0
argument_list|,
operator|(
name|u8
operator|*
operator|)
name|data
operator|->
name|rand
argument_list|,
name|data
operator|->
name|num_chal
operator|*
name|GSM_RAND_LEN
argument_list|)
expr_stmt|;
if|if
condition|(
name|eap_sim_build_encr
argument_list|(
name|sm
argument_list|,
name|data
argument_list|,
name|msg
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|)
condition|)
block|{
name|eap_sim_msg_free
argument_list|(
name|msg
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"   AT_MAC"
argument_list|)
expr_stmt|;
name|eap_sim_msg_add_mac
argument_list|(
name|msg
argument_list|,
name|EAP_SIM_AT_MAC
argument_list|)
expr_stmt|;
return|return
name|eap_sim_msg_finish
argument_list|(
name|msg
argument_list|,
name|reqDataLen
argument_list|,
name|data
operator|->
name|k_aut
argument_list|,
name|data
operator|->
name|nonce_mt
argument_list|,
name|EAP_SIM_NONCE_MT_LEN
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|u8
modifier|*
name|eap_sim_build_reauth
parameter_list|(
name|struct
name|eap_sm
modifier|*
name|sm
parameter_list|,
name|struct
name|eap_sim_data
modifier|*
name|data
parameter_list|,
name|int
name|id
parameter_list|,
name|size_t
modifier|*
name|reqDataLen
parameter_list|)
block|{
name|struct
name|eap_sim_msg
modifier|*
name|msg
decl_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"EAP-SIM: Generating Re-authentication"
argument_list|)
expr_stmt|;
if|if
condition|(
name|hostapd_get_rand
argument_list|(
name|data
operator|->
name|nonce_s
argument_list|,
name|EAP_SIM_NONCE_S_LEN
argument_list|)
condition|)
return|return
name|NULL
return|;
name|wpa_hexdump_key
argument_list|(
name|MSG_MSGDUMP
argument_list|,
literal|"EAP-SIM: NONCE_S"
argument_list|,
name|data
operator|->
name|nonce_s
argument_list|,
name|EAP_SIM_NONCE_S_LEN
argument_list|)
expr_stmt|;
name|eap_sim_derive_keys
argument_list|(
name|data
operator|->
name|mk
argument_list|,
name|data
operator|->
name|k_encr
argument_list|,
name|data
operator|->
name|k_aut
argument_list|,
name|data
operator|->
name|msk
argument_list|,
name|data
operator|->
name|emsk
argument_list|)
expr_stmt|;
name|eap_sim_derive_keys_reauth
argument_list|(
name|data
operator|->
name|counter
argument_list|,
name|sm
operator|->
name|identity
argument_list|,
name|sm
operator|->
name|identity_len
argument_list|,
name|data
operator|->
name|nonce_s
argument_list|,
name|data
operator|->
name|mk
argument_list|,
name|data
operator|->
name|msk
argument_list|,
name|data
operator|->
name|emsk
argument_list|)
expr_stmt|;
name|msg
operator|=
name|eap_sim_msg_init
argument_list|(
name|EAP_CODE_REQUEST
argument_list|,
name|id
argument_list|,
name|EAP_TYPE_SIM
argument_list|,
name|EAP_SIM_SUBTYPE_REAUTHENTICATION
argument_list|)
expr_stmt|;
if|if
condition|(
name|eap_sim_build_encr
argument_list|(
name|sm
argument_list|,
name|data
argument_list|,
name|msg
argument_list|,
name|data
operator|->
name|counter
argument_list|,
name|data
operator|->
name|nonce_s
argument_list|)
condition|)
block|{
name|eap_sim_msg_free
argument_list|(
name|msg
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"   AT_MAC"
argument_list|)
expr_stmt|;
name|eap_sim_msg_add_mac
argument_list|(
name|msg
argument_list|,
name|EAP_SIM_AT_MAC
argument_list|)
expr_stmt|;
return|return
name|eap_sim_msg_finish
argument_list|(
name|msg
argument_list|,
name|reqDataLen
argument_list|,
name|data
operator|->
name|k_aut
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|u8
modifier|*
name|eap_sim_buildReq
parameter_list|(
name|struct
name|eap_sm
modifier|*
name|sm
parameter_list|,
name|void
modifier|*
name|priv
parameter_list|,
name|int
name|id
parameter_list|,
name|size_t
modifier|*
name|reqDataLen
parameter_list|)
block|{
name|struct
name|eap_sim_data
modifier|*
name|data
init|=
name|priv
decl_stmt|;
switch|switch
condition|(
name|data
operator|->
name|state
condition|)
block|{
case|case
name|START
case|:
return|return
name|eap_sim_build_start
argument_list|(
name|sm
argument_list|,
name|data
argument_list|,
name|id
argument_list|,
name|reqDataLen
argument_list|)
return|;
case|case
name|CHALLENGE
case|:
return|return
name|eap_sim_build_challenge
argument_list|(
name|sm
argument_list|,
name|data
argument_list|,
name|id
argument_list|,
name|reqDataLen
argument_list|)
return|;
case|case
name|REAUTH
case|:
return|return
name|eap_sim_build_reauth
argument_list|(
name|sm
argument_list|,
name|data
argument_list|,
name|id
argument_list|,
name|reqDataLen
argument_list|)
return|;
default|default:
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"EAP-SIM: Unknown state %d in "
literal|"buildReq"
argument_list|,
name|data
operator|->
name|state
argument_list|)
expr_stmt|;
break|break;
block|}
return|return
name|NULL
return|;
block|}
end_function

begin_function
specifier|static
name|Boolean
name|eap_sim_check
parameter_list|(
name|struct
name|eap_sm
modifier|*
name|sm
parameter_list|,
name|void
modifier|*
name|priv
parameter_list|,
name|u8
modifier|*
name|respData
parameter_list|,
name|size_t
name|respDataLen
parameter_list|)
block|{
name|struct
name|eap_sim_data
modifier|*
name|data
init|=
name|priv
decl_stmt|;
name|struct
name|eap_hdr
modifier|*
name|resp
decl_stmt|;
name|u8
modifier|*
name|pos
decl_stmt|,
name|subtype
decl_stmt|;
name|resp
operator|=
operator|(
expr|struct
name|eap_hdr
operator|*
operator|)
name|respData
expr_stmt|;
name|pos
operator|=
operator|(
name|u8
operator|*
operator|)
operator|(
name|resp
operator|+
literal|1
operator|)
expr_stmt|;
if|if
condition|(
name|respDataLen
operator|<
sizeof|sizeof
argument_list|(
operator|*
name|resp
argument_list|)
operator|+
literal|4
operator|||
operator|*
name|pos
operator|!=
name|EAP_TYPE_SIM
operator|||
operator|(
name|ntohs
argument_list|(
name|resp
operator|->
name|length
argument_list|)
operator|)
operator|>
name|respDataLen
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"EAP-SIM: Invalid frame"
argument_list|)
expr_stmt|;
return|return
name|TRUE
return|;
block|}
name|subtype
operator|=
name|pos
index|[
literal|1
index|]
expr_stmt|;
if|if
condition|(
name|subtype
operator|==
name|EAP_SIM_SUBTYPE_CLIENT_ERROR
condition|)
return|return
name|FALSE
return|;
switch|switch
condition|(
name|data
operator|->
name|state
condition|)
block|{
case|case
name|START
case|:
if|if
condition|(
name|subtype
operator|!=
name|EAP_SIM_SUBTYPE_START
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"EAP-SIM: Unexpected response "
literal|"subtype %d"
argument_list|,
name|subtype
argument_list|)
expr_stmt|;
return|return
name|TRUE
return|;
block|}
break|break;
case|case
name|CHALLENGE
case|:
if|if
condition|(
name|subtype
operator|!=
name|EAP_SIM_SUBTYPE_CHALLENGE
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"EAP-SIM: Unexpected response "
literal|"subtype %d"
argument_list|,
name|subtype
argument_list|)
expr_stmt|;
return|return
name|TRUE
return|;
block|}
break|break;
case|case
name|REAUTH
case|:
if|if
condition|(
name|subtype
operator|!=
name|EAP_SIM_SUBTYPE_REAUTHENTICATION
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"EAP-SIM: Unexpected response "
literal|"subtype %d"
argument_list|,
name|subtype
argument_list|)
expr_stmt|;
return|return
name|TRUE
return|;
block|}
break|break;
default|default:
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"EAP-SIM: Unexpected state (%d) for "
literal|"processing a response"
argument_list|,
name|data
operator|->
name|state
argument_list|)
expr_stmt|;
return|return
name|TRUE
return|;
block|}
return|return
name|FALSE
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|eap_sim_supported_ver
parameter_list|(
name|struct
name|eap_sim_data
modifier|*
name|data
parameter_list|,
name|int
name|version
parameter_list|)
block|{
return|return
name|version
operator|==
name|EAP_SIM_VERSION
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|eap_sim_process_start
parameter_list|(
name|struct
name|eap_sm
modifier|*
name|sm
parameter_list|,
name|struct
name|eap_sim_data
modifier|*
name|data
parameter_list|,
name|u8
modifier|*
name|respData
parameter_list|,
name|size_t
name|respDataLen
parameter_list|,
name|struct
name|eap_sim_attrs
modifier|*
name|attr
parameter_list|)
block|{
specifier|const
name|u8
modifier|*
name|identity
decl_stmt|;
name|size_t
name|identity_len
decl_stmt|;
name|u8
name|ver_list
index|[
literal|2
index|]
decl_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"EAP-SIM: Receive start response"
argument_list|)
expr_stmt|;
if|if
condition|(
name|attr
operator|->
name|identity
condition|)
block|{
name|free
argument_list|(
name|sm
operator|->
name|identity
argument_list|)
expr_stmt|;
name|sm
operator|->
name|identity
operator|=
name|malloc
argument_list|(
name|attr
operator|->
name|identity_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|sm
operator|->
name|identity
condition|)
block|{
name|memcpy
argument_list|(
name|sm
operator|->
name|identity
argument_list|,
name|attr
operator|->
name|identity
argument_list|,
name|attr
operator|->
name|identity_len
argument_list|)
expr_stmt|;
name|sm
operator|->
name|identity_len
operator|=
name|attr
operator|->
name|identity_len
expr_stmt|;
block|}
block|}
name|identity
operator|=
name|NULL
expr_stmt|;
name|identity_len
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|sm
operator|->
name|identity
operator|&&
name|sm
operator|->
name|identity_len
operator|>
literal|0
operator|&&
name|sm
operator|->
name|identity
index|[
literal|0
index|]
operator|==
name|EAP_SIM_PERMANENT_PREFIX
condition|)
block|{
name|identity
operator|=
name|sm
operator|->
name|identity
expr_stmt|;
name|identity_len
operator|=
name|sm
operator|->
name|identity_len
expr_stmt|;
block|}
else|else
block|{
name|identity
operator|=
name|eap_sim_db_get_permanent
argument_list|(
name|sm
operator|->
name|eap_sim_db_priv
argument_list|,
name|sm
operator|->
name|identity
argument_list|,
name|sm
operator|->
name|identity_len
argument_list|,
operator|&
name|identity_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|identity
operator|==
name|NULL
condition|)
block|{
name|data
operator|->
name|reauth
operator|=
name|eap_sim_db_get_reauth_entry
argument_list|(
name|sm
operator|->
name|eap_sim_db_priv
argument_list|,
name|sm
operator|->
name|identity
argument_list|,
name|sm
operator|->
name|identity_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|data
operator|->
name|reauth
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"EAP-SIM: Using fast "
literal|"re-authentication"
argument_list|)
expr_stmt|;
name|identity
operator|=
name|data
operator|->
name|reauth
operator|->
name|identity
expr_stmt|;
name|identity_len
operator|=
name|data
operator|->
name|reauth
operator|->
name|identity_len
expr_stmt|;
name|data
operator|->
name|counter
operator|=
name|data
operator|->
name|reauth
operator|->
name|counter
expr_stmt|;
name|memcpy
argument_list|(
name|data
operator|->
name|mk
argument_list|,
name|data
operator|->
name|reauth
operator|->
name|mk
argument_list|,
name|EAP_SIM_MK_LEN
argument_list|)
expr_stmt|;
block|}
block|}
block|}
if|if
condition|(
name|identity
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"EAP-SIM: Could not get proper permanent"
literal|" user name"
argument_list|)
expr_stmt|;
name|eap_sim_state
argument_list|(
name|data
argument_list|,
name|FAILURE
argument_list|)
expr_stmt|;
return|return;
block|}
name|wpa_hexdump_ascii
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"EAP-SIM: Identity"
argument_list|,
name|identity
argument_list|,
name|identity_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|data
operator|->
name|reauth
condition|)
block|{
name|eap_sim_state
argument_list|(
name|data
argument_list|,
name|REAUTH
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|attr
operator|->
name|nonce_mt
operator|==
name|NULL
operator|||
name|attr
operator|->
name|selected_version
operator|<
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"EAP-SIM: Start/Response missing "
literal|"required attributes"
argument_list|)
expr_stmt|;
name|eap_sim_state
argument_list|(
name|data
argument_list|,
name|FAILURE
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
operator|!
name|eap_sim_supported_ver
argument_list|(
name|data
argument_list|,
name|attr
operator|->
name|selected_version
argument_list|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"EAP-SIM: Peer selected unsupported "
literal|"version %d"
argument_list|,
name|attr
operator|->
name|selected_version
argument_list|)
expr_stmt|;
name|eap_sim_state
argument_list|(
name|data
argument_list|,
name|FAILURE
argument_list|)
expr_stmt|;
return|return;
block|}
name|data
operator|->
name|counter
operator|=
literal|0
expr_stmt|;
comment|/* reset re-auth counter since this is full auth */
name|data
operator|->
name|reauth
operator|=
name|NULL
expr_stmt|;
name|data
operator|->
name|num_chal
operator|=
name|eap_sim_db_get_gsm_triplets
argument_list|(
name|sm
operator|->
name|eap_sim_db_priv
argument_list|,
name|identity
argument_list|,
name|identity_len
argument_list|,
name|EAP_SIM_MAX_CHAL
argument_list|,
operator|(
name|u8
operator|*
operator|)
name|data
operator|->
name|rand
argument_list|,
operator|(
name|u8
operator|*
operator|)
name|data
operator|->
name|kc
argument_list|,
operator|(
name|u8
operator|*
operator|)
name|data
operator|->
name|sres
argument_list|,
name|sm
argument_list|)
expr_stmt|;
if|if
condition|(
name|data
operator|->
name|num_chal
operator|==
name|EAP_SIM_DB_PENDING
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"EAP-SIM: GSM authentication triplets "
literal|"not yet available - pending request"
argument_list|)
expr_stmt|;
name|sm
operator|->
name|method_pending
operator|=
name|METHOD_PENDING_WAIT
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|data
operator|->
name|num_chal
operator|<
literal|2
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"EAP-SIM: Failed to get GSM "
literal|"authentication triplets for the peer"
argument_list|)
expr_stmt|;
name|eap_sim_state
argument_list|(
name|data
argument_list|,
name|FAILURE
argument_list|)
expr_stmt|;
return|return;
block|}
name|identity_len
operator|=
name|sm
operator|->
name|identity_len
expr_stmt|;
while|while
condition|(
name|identity_len
operator|>
literal|0
operator|&&
name|sm
operator|->
name|identity
index|[
name|identity_len
operator|-
literal|1
index|]
operator|==
literal|'\0'
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"EAP-SIM: Workaround - drop last null "
literal|"character from identity"
argument_list|)
expr_stmt|;
name|identity_len
operator|--
expr_stmt|;
block|}
name|wpa_hexdump_ascii
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"EAP-SIM: Identity for MK derivation"
argument_list|,
name|sm
operator|->
name|identity
argument_list|,
name|identity_len
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
name|data
operator|->
name|nonce_mt
argument_list|,
name|attr
operator|->
name|nonce_mt
argument_list|,
name|EAP_SIM_NONCE_MT_LEN
argument_list|)
expr_stmt|;
name|WPA_PUT_BE16
argument_list|(
name|ver_list
argument_list|,
name|EAP_SIM_VERSION
argument_list|)
expr_stmt|;
name|eap_sim_derive_mk
argument_list|(
name|sm
operator|->
name|identity
argument_list|,
name|identity_len
argument_list|,
name|attr
operator|->
name|nonce_mt
argument_list|,
name|attr
operator|->
name|selected_version
argument_list|,
name|ver_list
argument_list|,
sizeof|sizeof
argument_list|(
name|ver_list
argument_list|)
argument_list|,
name|data
operator|->
name|num_chal
argument_list|,
operator|(
specifier|const
name|u8
operator|*
operator|)
name|data
operator|->
name|kc
argument_list|,
name|data
operator|->
name|mk
argument_list|)
expr_stmt|;
name|eap_sim_derive_keys
argument_list|(
name|data
operator|->
name|mk
argument_list|,
name|data
operator|->
name|k_encr
argument_list|,
name|data
operator|->
name|k_aut
argument_list|,
name|data
operator|->
name|msk
argument_list|,
name|data
operator|->
name|emsk
argument_list|)
expr_stmt|;
name|eap_sim_state
argument_list|(
name|data
argument_list|,
name|CHALLENGE
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|eap_sim_process_challenge
parameter_list|(
name|struct
name|eap_sm
modifier|*
name|sm
parameter_list|,
name|struct
name|eap_sim_data
modifier|*
name|data
parameter_list|,
name|u8
modifier|*
name|respData
parameter_list|,
name|size_t
name|respDataLen
parameter_list|,
name|struct
name|eap_sim_attrs
modifier|*
name|attr
parameter_list|)
block|{
specifier|const
name|u8
modifier|*
name|identity
decl_stmt|;
name|size_t
name|identity_len
decl_stmt|;
if|if
condition|(
name|attr
operator|->
name|mac
operator|==
name|NULL
operator|||
name|eap_sim_verify_mac
argument_list|(
name|data
operator|->
name|k_aut
argument_list|,
name|respData
argument_list|,
name|respDataLen
argument_list|,
name|attr
operator|->
name|mac
argument_list|,
operator|(
name|u8
operator|*
operator|)
name|data
operator|->
name|sres
argument_list|,
name|data
operator|->
name|num_chal
operator|*
name|EAP_SIM_SRES_LEN
argument_list|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_WARNING
argument_list|,
literal|"EAP-SIM: Challenge message "
literal|"did not include valid AT_MAC"
argument_list|)
expr_stmt|;
name|eap_sim_state
argument_list|(
name|data
argument_list|,
name|FAILURE
argument_list|)
expr_stmt|;
return|return;
block|}
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"EAP-SIM: Challenge response includes the "
literal|"correct AT_MAC"
argument_list|)
expr_stmt|;
name|eap_sim_state
argument_list|(
name|data
argument_list|,
name|SUCCESS
argument_list|)
expr_stmt|;
name|identity
operator|=
name|eap_sim_db_get_permanent
argument_list|(
name|sm
operator|->
name|eap_sim_db_priv
argument_list|,
name|sm
operator|->
name|identity
argument_list|,
name|sm
operator|->
name|identity_len
argument_list|,
operator|&
name|identity_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|identity
operator|==
name|NULL
condition|)
block|{
name|identity
operator|=
name|sm
operator|->
name|identity
expr_stmt|;
name|identity_len
operator|=
name|sm
operator|->
name|identity_len
expr_stmt|;
block|}
if|if
condition|(
name|data
operator|->
name|next_pseudonym
condition|)
block|{
name|eap_sim_db_add_pseudonym
argument_list|(
name|sm
operator|->
name|eap_sim_db_priv
argument_list|,
name|identity
argument_list|,
name|identity_len
argument_list|,
name|data
operator|->
name|next_pseudonym
argument_list|)
expr_stmt|;
name|data
operator|->
name|next_pseudonym
operator|=
name|NULL
expr_stmt|;
block|}
if|if
condition|(
name|data
operator|->
name|next_reauth_id
condition|)
block|{
name|eap_sim_db_add_reauth
argument_list|(
name|sm
operator|->
name|eap_sim_db_priv
argument_list|,
name|identity
argument_list|,
name|identity_len
argument_list|,
name|data
operator|->
name|next_reauth_id
argument_list|,
name|data
operator|->
name|counter
operator|+
literal|1
argument_list|,
name|data
operator|->
name|mk
argument_list|)
expr_stmt|;
name|data
operator|->
name|next_reauth_id
operator|=
name|NULL
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|eap_sim_process_reauth
parameter_list|(
name|struct
name|eap_sm
modifier|*
name|sm
parameter_list|,
name|struct
name|eap_sim_data
modifier|*
name|data
parameter_list|,
name|u8
modifier|*
name|respData
parameter_list|,
name|size_t
name|respDataLen
parameter_list|,
name|struct
name|eap_sim_attrs
modifier|*
name|attr
parameter_list|)
block|{
name|struct
name|eap_sim_attrs
name|eattr
decl_stmt|;
name|u8
modifier|*
name|decrypted
init|=
name|NULL
decl_stmt|;
specifier|const
name|u8
modifier|*
name|identity
decl_stmt|,
modifier|*
name|id2
decl_stmt|;
name|size_t
name|identity_len
decl_stmt|,
name|id2_len
decl_stmt|;
if|if
condition|(
name|attr
operator|->
name|mac
operator|==
name|NULL
operator|||
name|eap_sim_verify_mac
argument_list|(
name|data
operator|->
name|k_aut
argument_list|,
name|respData
argument_list|,
name|respDataLen
argument_list|,
name|attr
operator|->
name|mac
argument_list|,
name|data
operator|->
name|nonce_s
argument_list|,
name|EAP_SIM_NONCE_S_LEN
argument_list|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_WARNING
argument_list|,
literal|"EAP-SIM: Re-authentication message "
literal|"did not include valid AT_MAC"
argument_list|)
expr_stmt|;
goto|goto
name|fail
goto|;
block|}
if|if
condition|(
name|attr
operator|->
name|encr_data
operator|==
name|NULL
operator|||
name|attr
operator|->
name|iv
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_WARNING
argument_list|,
literal|"EAP-SIM: Reauthentication "
literal|"message did not include encrypted data"
argument_list|)
expr_stmt|;
goto|goto
name|fail
goto|;
block|}
name|decrypted
operator|=
name|eap_sim_parse_encr
argument_list|(
name|data
operator|->
name|k_encr
argument_list|,
name|attr
operator|->
name|encr_data
argument_list|,
name|attr
operator|->
name|encr_data_len
argument_list|,
name|attr
operator|->
name|iv
argument_list|,
operator|&
name|eattr
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|decrypted
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_WARNING
argument_list|,
literal|"EAP-SIM: Failed to parse encrypted "
literal|"data from reauthentication message"
argument_list|)
expr_stmt|;
goto|goto
name|fail
goto|;
block|}
if|if
condition|(
name|eattr
operator|.
name|counter
operator|!=
name|data
operator|->
name|counter
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_WARNING
argument_list|,
literal|"EAP-SIM: Re-authentication message "
literal|"used incorrect counter %u, expected %u"
argument_list|,
name|eattr
operator|.
name|counter
argument_list|,
name|data
operator|->
name|counter
argument_list|)
expr_stmt|;
goto|goto
name|fail
goto|;
block|}
name|free
argument_list|(
name|decrypted
argument_list|)
expr_stmt|;
name|decrypted
operator|=
name|NULL
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"EAP-SIM: Re-authentication response includes "
literal|"the correct AT_MAC"
argument_list|)
expr_stmt|;
name|eap_sim_state
argument_list|(
name|data
argument_list|,
name|SUCCESS
argument_list|)
expr_stmt|;
if|if
condition|(
name|data
operator|->
name|reauth
condition|)
block|{
name|identity
operator|=
name|data
operator|->
name|reauth
operator|->
name|identity
expr_stmt|;
name|identity_len
operator|=
name|data
operator|->
name|reauth
operator|->
name|identity_len
expr_stmt|;
block|}
else|else
block|{
name|identity
operator|=
name|sm
operator|->
name|identity
expr_stmt|;
name|identity_len
operator|=
name|sm
operator|->
name|identity_len
expr_stmt|;
block|}
name|id2
operator|=
name|eap_sim_db_get_permanent
argument_list|(
name|sm
operator|->
name|eap_sim_db_priv
argument_list|,
name|identity
argument_list|,
name|identity_len
argument_list|,
operator|&
name|id2_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|id2
condition|)
block|{
name|identity
operator|=
name|id2
expr_stmt|;
name|identity_len
operator|=
name|id2_len
expr_stmt|;
block|}
if|if
condition|(
name|data
operator|->
name|next_pseudonym
condition|)
block|{
name|eap_sim_db_add_pseudonym
argument_list|(
name|sm
operator|->
name|eap_sim_db_priv
argument_list|,
name|identity
argument_list|,
name|identity_len
argument_list|,
name|data
operator|->
name|next_pseudonym
argument_list|)
expr_stmt|;
name|data
operator|->
name|next_pseudonym
operator|=
name|NULL
expr_stmt|;
block|}
if|if
condition|(
name|data
operator|->
name|next_reauth_id
condition|)
block|{
name|eap_sim_db_add_reauth
argument_list|(
name|sm
operator|->
name|eap_sim_db_priv
argument_list|,
name|identity
argument_list|,
name|identity_len
argument_list|,
name|data
operator|->
name|next_reauth_id
argument_list|,
name|data
operator|->
name|counter
operator|+
literal|1
argument_list|,
name|data
operator|->
name|mk
argument_list|)
expr_stmt|;
name|data
operator|->
name|next_reauth_id
operator|=
name|NULL
expr_stmt|;
block|}
else|else
block|{
name|eap_sim_db_remove_reauth
argument_list|(
name|sm
operator|->
name|eap_sim_db_priv
argument_list|,
name|data
operator|->
name|reauth
argument_list|)
expr_stmt|;
name|data
operator|->
name|reauth
operator|=
name|NULL
expr_stmt|;
block|}
return|return;
name|fail
label|:
name|eap_sim_state
argument_list|(
name|data
argument_list|,
name|FAILURE
argument_list|)
expr_stmt|;
name|eap_sim_db_remove_reauth
argument_list|(
name|sm
operator|->
name|eap_sim_db_priv
argument_list|,
name|data
operator|->
name|reauth
argument_list|)
expr_stmt|;
name|data
operator|->
name|reauth
operator|=
name|NULL
expr_stmt|;
name|free
argument_list|(
name|decrypted
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|eap_sim_process_client_error
parameter_list|(
name|struct
name|eap_sm
modifier|*
name|sm
parameter_list|,
name|struct
name|eap_sim_data
modifier|*
name|data
parameter_list|,
name|u8
modifier|*
name|respData
parameter_list|,
name|size_t
name|respDataLen
parameter_list|,
name|struct
name|eap_sim_attrs
modifier|*
name|attr
parameter_list|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"EAP-SIM: Client reported error %d"
argument_list|,
name|attr
operator|->
name|client_error_code
argument_list|)
expr_stmt|;
name|eap_sim_state
argument_list|(
name|data
argument_list|,
name|FAILURE
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|eap_sim_process
parameter_list|(
name|struct
name|eap_sm
modifier|*
name|sm
parameter_list|,
name|void
modifier|*
name|priv
parameter_list|,
name|u8
modifier|*
name|respData
parameter_list|,
name|size_t
name|respDataLen
parameter_list|)
block|{
name|struct
name|eap_sim_data
modifier|*
name|data
init|=
name|priv
decl_stmt|;
name|struct
name|eap_hdr
modifier|*
name|resp
decl_stmt|;
name|u8
modifier|*
name|pos
decl_stmt|,
name|subtype
decl_stmt|;
name|size_t
name|len
decl_stmt|;
name|struct
name|eap_sim_attrs
name|attr
decl_stmt|;
name|resp
operator|=
operator|(
expr|struct
name|eap_hdr
operator|*
operator|)
name|respData
expr_stmt|;
name|pos
operator|=
operator|(
name|u8
operator|*
operator|)
operator|(
name|resp
operator|+
literal|1
operator|)
expr_stmt|;
name|subtype
operator|=
name|pos
index|[
literal|1
index|]
expr_stmt|;
name|len
operator|=
name|ntohs
argument_list|(
name|resp
operator|->
name|length
argument_list|)
expr_stmt|;
name|pos
operator|+=
literal|4
expr_stmt|;
if|if
condition|(
name|eap_sim_parse_attr
argument_list|(
name|pos
argument_list|,
name|respData
operator|+
name|len
argument_list|,
operator|&
name|attr
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"EAP-SIM: Failed to parse attributes"
argument_list|)
expr_stmt|;
name|eap_sim_state
argument_list|(
name|data
argument_list|,
name|FAILURE
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|subtype
operator|==
name|EAP_SIM_SUBTYPE_CLIENT_ERROR
condition|)
block|{
name|eap_sim_process_client_error
argument_list|(
name|sm
argument_list|,
name|data
argument_list|,
name|respData
argument_list|,
name|len
argument_list|,
operator|&
name|attr
argument_list|)
expr_stmt|;
return|return;
block|}
switch|switch
condition|(
name|data
operator|->
name|state
condition|)
block|{
case|case
name|START
case|:
name|eap_sim_process_start
argument_list|(
name|sm
argument_list|,
name|data
argument_list|,
name|respData
argument_list|,
name|len
argument_list|,
operator|&
name|attr
argument_list|)
expr_stmt|;
break|break;
case|case
name|CHALLENGE
case|:
name|eap_sim_process_challenge
argument_list|(
name|sm
argument_list|,
name|data
argument_list|,
name|respData
argument_list|,
name|len
argument_list|,
operator|&
name|attr
argument_list|)
expr_stmt|;
break|break;
case|case
name|REAUTH
case|:
name|eap_sim_process_reauth
argument_list|(
name|sm
argument_list|,
name|data
argument_list|,
name|respData
argument_list|,
name|len
argument_list|,
operator|&
name|attr
argument_list|)
expr_stmt|;
break|break;
default|default:
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"EAP-SIM: Unknown state %d in "
literal|"process"
argument_list|,
name|data
operator|->
name|state
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
end_function

begin_function
specifier|static
name|Boolean
name|eap_sim_isDone
parameter_list|(
name|struct
name|eap_sm
modifier|*
name|sm
parameter_list|,
name|void
modifier|*
name|priv
parameter_list|)
block|{
name|struct
name|eap_sim_data
modifier|*
name|data
init|=
name|priv
decl_stmt|;
return|return
name|data
operator|->
name|state
operator|==
name|SUCCESS
operator|||
name|data
operator|->
name|state
operator|==
name|FAILURE
return|;
block|}
end_function

begin_function
specifier|static
name|u8
modifier|*
name|eap_sim_getKey
parameter_list|(
name|struct
name|eap_sm
modifier|*
name|sm
parameter_list|,
name|void
modifier|*
name|priv
parameter_list|,
name|size_t
modifier|*
name|len
parameter_list|)
block|{
name|struct
name|eap_sim_data
modifier|*
name|data
init|=
name|priv
decl_stmt|;
name|u8
modifier|*
name|key
decl_stmt|;
if|if
condition|(
name|data
operator|->
name|state
operator|!=
name|SUCCESS
condition|)
return|return
name|NULL
return|;
name|key
operator|=
name|malloc
argument_list|(
name|EAP_SIM_KEYING_DATA_LEN
argument_list|)
expr_stmt|;
if|if
condition|(
name|key
operator|==
name|NULL
condition|)
return|return
name|NULL
return|;
name|memcpy
argument_list|(
name|key
argument_list|,
name|data
operator|->
name|msk
argument_list|,
name|EAP_SIM_KEYING_DATA_LEN
argument_list|)
expr_stmt|;
operator|*
name|len
operator|=
name|EAP_SIM_KEYING_DATA_LEN
expr_stmt|;
return|return
name|key
return|;
block|}
end_function

begin_function
specifier|static
name|u8
modifier|*
name|eap_sim_get_emsk
parameter_list|(
name|struct
name|eap_sm
modifier|*
name|sm
parameter_list|,
name|void
modifier|*
name|priv
parameter_list|,
name|size_t
modifier|*
name|len
parameter_list|)
block|{
name|struct
name|eap_sim_data
modifier|*
name|data
init|=
name|priv
decl_stmt|;
name|u8
modifier|*
name|key
decl_stmt|;
if|if
condition|(
name|data
operator|->
name|state
operator|!=
name|SUCCESS
condition|)
return|return
name|NULL
return|;
name|key
operator|=
name|malloc
argument_list|(
name|EAP_EMSK_LEN
argument_list|)
expr_stmt|;
if|if
condition|(
name|key
operator|==
name|NULL
condition|)
return|return
name|NULL
return|;
name|memcpy
argument_list|(
name|key
argument_list|,
name|data
operator|->
name|emsk
argument_list|,
name|EAP_EMSK_LEN
argument_list|)
expr_stmt|;
operator|*
name|len
operator|=
name|EAP_EMSK_LEN
expr_stmt|;
return|return
name|key
return|;
block|}
end_function

begin_function
specifier|static
name|Boolean
name|eap_sim_isSuccess
parameter_list|(
name|struct
name|eap_sm
modifier|*
name|sm
parameter_list|,
name|void
modifier|*
name|priv
parameter_list|)
block|{
name|struct
name|eap_sim_data
modifier|*
name|data
init|=
name|priv
decl_stmt|;
return|return
name|data
operator|->
name|state
operator|==
name|SUCCESS
return|;
block|}
end_function

begin_function
name|int
name|eap_server_sim_register
parameter_list|(
name|void
parameter_list|)
block|{
name|struct
name|eap_method
modifier|*
name|eap
decl_stmt|;
name|int
name|ret
decl_stmt|;
name|eap
operator|=
name|eap_server_method_alloc
argument_list|(
name|EAP_SERVER_METHOD_INTERFACE_VERSION
argument_list|,
name|EAP_VENDOR_IETF
argument_list|,
name|EAP_TYPE_SIM
argument_list|,
literal|"SIM"
argument_list|)
expr_stmt|;
if|if
condition|(
name|eap
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
name|eap
operator|->
name|init
operator|=
name|eap_sim_init
expr_stmt|;
name|eap
operator|->
name|reset
operator|=
name|eap_sim_reset
expr_stmt|;
name|eap
operator|->
name|buildReq
operator|=
name|eap_sim_buildReq
expr_stmt|;
name|eap
operator|->
name|check
operator|=
name|eap_sim_check
expr_stmt|;
name|eap
operator|->
name|process
operator|=
name|eap_sim_process
expr_stmt|;
name|eap
operator|->
name|isDone
operator|=
name|eap_sim_isDone
expr_stmt|;
name|eap
operator|->
name|getKey
operator|=
name|eap_sim_getKey
expr_stmt|;
name|eap
operator|->
name|isSuccess
operator|=
name|eap_sim_isSuccess
expr_stmt|;
name|eap
operator|->
name|get_emsk
operator|=
name|eap_sim_get_emsk
expr_stmt|;
name|ret
operator|=
name|eap_server_method_register
argument_list|(
name|eap
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
name|eap_server_method_free
argument_list|(
name|eap
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

end_unit


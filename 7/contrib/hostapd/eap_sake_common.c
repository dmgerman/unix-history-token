begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * EAP server/peer: EAP-SAKE shared routines  * Copyright (c) 2006, Jouni Malinen<j@w1.fi>  *  * This program is free software; you can redistribute it and/or modify  * it under the terms of the GNU General Public License version 2 as  * published by the Free Software Foundation.  *  * Alternatively, this software may be distributed under the terms of BSD  * license.  *  * See README and COPYING for more details.  */
end_comment

begin_include
include|#
directive|include
file|"includes.h"
end_include

begin_include
include|#
directive|include
file|"common.h"
end_include

begin_include
include|#
directive|include
file|"sha1.h"
end_include

begin_include
include|#
directive|include
file|"eap_defs.h"
end_include

begin_include
include|#
directive|include
file|"eap_sake_common.h"
end_include

begin_function
specifier|static
name|int
name|eap_sake_parse_add_attr
parameter_list|(
name|struct
name|eap_sake_parse_attr
modifier|*
name|attr
parameter_list|,
specifier|const
name|u8
modifier|*
name|pos
parameter_list|)
block|{
name|size_t
name|i
decl_stmt|;
switch|switch
condition|(
name|pos
index|[
literal|0
index|]
condition|)
block|{
case|case
name|EAP_SAKE_AT_RAND_S
case|:
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"EAP-SAKE: Parse: AT_RAND_S"
argument_list|)
expr_stmt|;
if|if
condition|(
name|pos
index|[
literal|1
index|]
operator|!=
literal|2
operator|+
name|EAP_SAKE_RAND_LEN
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"EAP-SAKE: AT_RAND_S with "
literal|"invalid length %d"
argument_list|,
name|pos
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|attr
operator|->
name|rand_s
operator|=
name|pos
operator|+
literal|2
expr_stmt|;
break|break;
case|case
name|EAP_SAKE_AT_RAND_P
case|:
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"EAP-SAKE: Parse: AT_RAND_P"
argument_list|)
expr_stmt|;
if|if
condition|(
name|pos
index|[
literal|1
index|]
operator|!=
literal|2
operator|+
name|EAP_SAKE_RAND_LEN
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"EAP-SAKE: AT_RAND_P with "
literal|"invalid length %d"
argument_list|,
name|pos
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|attr
operator|->
name|rand_p
operator|=
name|pos
operator|+
literal|2
expr_stmt|;
break|break;
case|case
name|EAP_SAKE_AT_MIC_S
case|:
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"EAP-SAKE: Parse: AT_MIC_S"
argument_list|)
expr_stmt|;
if|if
condition|(
name|pos
index|[
literal|1
index|]
operator|!=
literal|2
operator|+
name|EAP_SAKE_MIC_LEN
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"EAP-SAKE: AT_MIC_S with "
literal|"invalid length %d"
argument_list|,
name|pos
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|attr
operator|->
name|mic_s
operator|=
name|pos
operator|+
literal|2
expr_stmt|;
break|break;
case|case
name|EAP_SAKE_AT_MIC_P
case|:
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"EAP-SAKE: Parse: AT_MIC_P"
argument_list|)
expr_stmt|;
if|if
condition|(
name|pos
index|[
literal|1
index|]
operator|!=
literal|2
operator|+
name|EAP_SAKE_MIC_LEN
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"EAP-SAKE: AT_MIC_P with "
literal|"invalid length %d"
argument_list|,
name|pos
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|attr
operator|->
name|mic_p
operator|=
name|pos
operator|+
literal|2
expr_stmt|;
break|break;
case|case
name|EAP_SAKE_AT_SERVERID
case|:
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"EAP-SAKE: Parse: AT_SERVERID"
argument_list|)
expr_stmt|;
name|attr
operator|->
name|serverid
operator|=
name|pos
operator|+
literal|2
expr_stmt|;
name|attr
operator|->
name|serverid_len
operator|=
name|pos
index|[
literal|1
index|]
operator|-
literal|2
expr_stmt|;
break|break;
case|case
name|EAP_SAKE_AT_PEERID
case|:
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"EAP-SAKE: Parse: AT_PEERID"
argument_list|)
expr_stmt|;
name|attr
operator|->
name|peerid
operator|=
name|pos
operator|+
literal|2
expr_stmt|;
name|attr
operator|->
name|peerid_len
operator|=
name|pos
index|[
literal|1
index|]
operator|-
literal|2
expr_stmt|;
break|break;
case|case
name|EAP_SAKE_AT_SPI_S
case|:
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"EAP-SAKE: Parse: AT_SPI_S"
argument_list|)
expr_stmt|;
name|attr
operator|->
name|spi_s
operator|=
name|pos
operator|+
literal|2
expr_stmt|;
name|attr
operator|->
name|spi_s_len
operator|=
name|pos
index|[
literal|1
index|]
operator|-
literal|2
expr_stmt|;
break|break;
case|case
name|EAP_SAKE_AT_SPI_P
case|:
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"EAP-SAKE: Parse: AT_SPI_P"
argument_list|)
expr_stmt|;
name|attr
operator|->
name|spi_p
operator|=
name|pos
operator|+
literal|2
expr_stmt|;
name|attr
operator|->
name|spi_p_len
operator|=
name|pos
index|[
literal|1
index|]
operator|-
literal|2
expr_stmt|;
break|break;
case|case
name|EAP_SAKE_AT_ANY_ID_REQ
case|:
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"EAP-SAKE: Parse: AT_ANY_ID_REQ"
argument_list|)
expr_stmt|;
if|if
condition|(
name|pos
index|[
literal|1
index|]
operator|!=
literal|4
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"EAP-SAKE: Invalid AT_ANY_ID_REQ"
literal|" length %d"
argument_list|,
name|pos
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|attr
operator|->
name|any_id_req
operator|=
name|pos
operator|+
literal|2
expr_stmt|;
break|break;
case|case
name|EAP_SAKE_AT_PERM_ID_REQ
case|:
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"EAP-SAKE: Parse: AT_PERM_ID_REQ"
argument_list|)
expr_stmt|;
if|if
condition|(
name|pos
index|[
literal|1
index|]
operator|!=
literal|4
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"EAP-SAKE: Invalid "
literal|"AT_PERM_ID_REQ length %d"
argument_list|,
name|pos
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|attr
operator|->
name|perm_id_req
operator|=
name|pos
operator|+
literal|2
expr_stmt|;
break|break;
case|case
name|EAP_SAKE_AT_ENCR_DATA
case|:
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"EAP-SAKE: Parse: AT_ENCR_DATA"
argument_list|)
expr_stmt|;
name|attr
operator|->
name|encr_data
operator|=
name|pos
operator|+
literal|2
expr_stmt|;
name|attr
operator|->
name|encr_data_len
operator|=
name|pos
index|[
literal|1
index|]
operator|-
literal|2
expr_stmt|;
break|break;
case|case
name|EAP_SAKE_AT_IV
case|:
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"EAP-SAKE: Parse: AT_IV"
argument_list|)
expr_stmt|;
name|attr
operator|->
name|iv
operator|=
name|pos
operator|+
literal|2
expr_stmt|;
name|attr
operator|->
name|iv_len
operator|=
name|pos
index|[
literal|1
index|]
operator|-
literal|2
expr_stmt|;
break|break;
case|case
name|EAP_SAKE_AT_PADDING
case|:
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"EAP-SAKE: Parse: AT_PADDING"
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|2
init|;
name|i
operator|<
name|pos
index|[
literal|1
index|]
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|pos
index|[
name|i
index|]
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"EAP-SAKE: AT_PADDING "
literal|"with non-zero pad byte"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
block|}
break|break;
case|case
name|EAP_SAKE_AT_NEXT_TMPID
case|:
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"EAP-SAKE: Parse: AT_NEXT_TMPID"
argument_list|)
expr_stmt|;
name|attr
operator|->
name|next_tmpid
operator|=
name|pos
operator|+
literal|2
expr_stmt|;
name|attr
operator|->
name|next_tmpid_len
operator|=
name|pos
index|[
literal|1
index|]
operator|-
literal|2
expr_stmt|;
break|break;
case|case
name|EAP_SAKE_AT_MSK_LIFE
case|:
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"EAP-SAKE: Parse: AT_IV"
argument_list|)
expr_stmt|;
if|if
condition|(
name|pos
index|[
literal|1
index|]
operator|!=
literal|6
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"EAP-SAKE: Invalid "
literal|"AT_MSK_LIFE length %d"
argument_list|,
name|pos
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|attr
operator|->
name|msk_life
operator|=
name|pos
operator|+
literal|2
expr_stmt|;
break|break;
default|default:
if|if
condition|(
name|pos
index|[
literal|0
index|]
operator|<
literal|128
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"EAP-SAKE: Unknown non-skippable"
literal|" attribute %d"
argument_list|,
name|pos
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"EAP-SAKE: Ignoring unknown skippable "
literal|"attribute %d"
argument_list|,
name|pos
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|attr
operator|->
name|iv
operator|&&
operator|!
name|attr
operator|->
name|encr_data
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"EAP-SAKE: AT_IV included without "
literal|"AT_ENCR_DATA"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/**  * eap_sake_parse_attributes - Parse EAP-SAKE attributes  * @buf: Packet payload (starting with the first attribute)  * @len: Payload length  * @attr: Structure to be filled with found attributes  * Returns: 0 on success or -1 on failure  */
end_comment

begin_function
name|int
name|eap_sake_parse_attributes
parameter_list|(
specifier|const
name|u8
modifier|*
name|buf
parameter_list|,
name|size_t
name|len
parameter_list|,
name|struct
name|eap_sake_parse_attr
modifier|*
name|attr
parameter_list|)
block|{
specifier|const
name|u8
modifier|*
name|pos
init|=
name|buf
decl_stmt|,
modifier|*
name|end
init|=
name|buf
operator|+
name|len
decl_stmt|;
name|os_memset
argument_list|(
name|attr
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|attr
argument_list|)
argument_list|)
expr_stmt|;
while|while
condition|(
name|pos
operator|<
name|end
condition|)
block|{
if|if
condition|(
name|end
operator|-
name|pos
operator|<
literal|2
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"EAP-SAKE: Too short attribute"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
if|if
condition|(
name|pos
index|[
literal|1
index|]
operator|<
literal|2
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"EAP-SAKE: Invalid attribute "
literal|"length (%d)"
argument_list|,
name|pos
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
if|if
condition|(
name|pos
operator|+
name|pos
index|[
literal|1
index|]
operator|>
name|end
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"EAP-SAKE: Attribute underflow"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
if|if
condition|(
name|eap_sake_parse_add_attr
argument_list|(
name|attr
argument_list|,
name|pos
argument_list|)
condition|)
return|return
operator|-
literal|1
return|;
name|pos
operator|+=
name|pos
index|[
literal|1
index|]
expr_stmt|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/**  * eap_sake_kdf - EAP-SAKE Key Derivation Function (KDF)  * @key: Key for KDF  * @key_len: Length of the key in bytes  * @label: A unique label for each purpose of the KDF  * @data: Extra data (start) to bind into the key  * @data_len: Length of the data  * @data2: Extra data (end) to bind into the key  * @data2_len: Length of the data2  * @buf: Buffer for the generated pseudo-random key  * @buf_len: Number of bytes of key to generate  *  * This function is used to derive new, cryptographically separate keys from a  * given key (e.g., SMS). This is identical to the PRF used in IEEE 802.11i.  */
end_comment

begin_function
specifier|static
name|void
name|eap_sake_kdf
parameter_list|(
specifier|const
name|u8
modifier|*
name|key
parameter_list|,
name|size_t
name|key_len
parameter_list|,
specifier|const
name|char
modifier|*
name|label
parameter_list|,
specifier|const
name|u8
modifier|*
name|data
parameter_list|,
name|size_t
name|data_len
parameter_list|,
specifier|const
name|u8
modifier|*
name|data2
parameter_list|,
name|size_t
name|data2_len
parameter_list|,
name|u8
modifier|*
name|buf
parameter_list|,
name|size_t
name|buf_len
parameter_list|)
block|{
name|u8
name|counter
init|=
literal|0
decl_stmt|;
name|size_t
name|pos
decl_stmt|,
name|plen
decl_stmt|;
name|u8
name|hash
index|[
name|SHA1_MAC_LEN
index|]
decl_stmt|;
name|size_t
name|label_len
init|=
name|os_strlen
argument_list|(
name|label
argument_list|)
operator|+
literal|1
decl_stmt|;
specifier|const
name|unsigned
name|char
modifier|*
name|addr
index|[
literal|4
index|]
decl_stmt|;
name|size_t
name|len
index|[
literal|4
index|]
decl_stmt|;
name|addr
index|[
literal|0
index|]
operator|=
operator|(
name|u8
operator|*
operator|)
name|label
expr_stmt|;
comment|/* Label | Y */
name|len
index|[
literal|0
index|]
operator|=
name|label_len
expr_stmt|;
name|addr
index|[
literal|1
index|]
operator|=
name|data
expr_stmt|;
comment|/* Msg[start] */
name|len
index|[
literal|1
index|]
operator|=
name|data_len
expr_stmt|;
name|addr
index|[
literal|2
index|]
operator|=
name|data2
expr_stmt|;
comment|/* Msg[end] */
name|len
index|[
literal|2
index|]
operator|=
name|data2_len
expr_stmt|;
name|addr
index|[
literal|3
index|]
operator|=
operator|&
name|counter
expr_stmt|;
comment|/* Length */
name|len
index|[
literal|3
index|]
operator|=
literal|1
expr_stmt|;
name|pos
operator|=
literal|0
expr_stmt|;
while|while
condition|(
name|pos
operator|<
name|buf_len
condition|)
block|{
name|plen
operator|=
name|buf_len
operator|-
name|pos
expr_stmt|;
if|if
condition|(
name|plen
operator|>=
name|SHA1_MAC_LEN
condition|)
block|{
name|hmac_sha1_vector
argument_list|(
name|key
argument_list|,
name|key_len
argument_list|,
literal|4
argument_list|,
name|addr
argument_list|,
name|len
argument_list|,
operator|&
name|buf
index|[
name|pos
index|]
argument_list|)
expr_stmt|;
name|pos
operator|+=
name|SHA1_MAC_LEN
expr_stmt|;
block|}
else|else
block|{
name|hmac_sha1_vector
argument_list|(
name|key
argument_list|,
name|key_len
argument_list|,
literal|4
argument_list|,
name|addr
argument_list|,
name|len
argument_list|,
name|hash
argument_list|)
expr_stmt|;
name|os_memcpy
argument_list|(
operator|&
name|buf
index|[
name|pos
index|]
argument_list|,
name|hash
argument_list|,
name|plen
argument_list|)
expr_stmt|;
break|break;
block|}
name|counter
operator|++
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/**  * eap_sake_derive_keys - Derive EAP-SAKE keys  * @root_secret_a: 16-byte Root-Secret-A  * @root_secret_b: 16-byte Root-Secret-B  * @rand_s: 16-byte RAND_S  * @rand_p: 16-byte RAND_P  * @tek: Buffer for Temporary EAK Keys (TEK-Auth[16] | TEK-Cipher[16])  * @msk: Buffer for 64-byte MSK  * @emsk: Buffer for 64-byte EMSK  *  * This function derives EAP-SAKE keys as defined in RFC 4763, section 3.2.6.  */
end_comment

begin_function
name|void
name|eap_sake_derive_keys
parameter_list|(
specifier|const
name|u8
modifier|*
name|root_secret_a
parameter_list|,
specifier|const
name|u8
modifier|*
name|root_secret_b
parameter_list|,
specifier|const
name|u8
modifier|*
name|rand_s
parameter_list|,
specifier|const
name|u8
modifier|*
name|rand_p
parameter_list|,
name|u8
modifier|*
name|tek
parameter_list|,
name|u8
modifier|*
name|msk
parameter_list|,
name|u8
modifier|*
name|emsk
parameter_list|)
block|{
name|u8
name|sms_a
index|[
name|EAP_SAKE_SMS_LEN
index|]
decl_stmt|;
name|u8
name|sms_b
index|[
name|EAP_SAKE_SMS_LEN
index|]
decl_stmt|;
name|u8
name|key_buf
index|[
name|EAP_MSK_LEN
operator|+
name|EAP_EMSK_LEN
index|]
decl_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"EAP-SAKE: Deriving keys"
argument_list|)
expr_stmt|;
name|wpa_hexdump_key
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"EAP-SAKE: Root-Secret-A"
argument_list|,
name|root_secret_a
argument_list|,
name|EAP_SAKE_ROOT_SECRET_LEN
argument_list|)
expr_stmt|;
name|eap_sake_kdf
argument_list|(
name|root_secret_a
argument_list|,
name|EAP_SAKE_ROOT_SECRET_LEN
argument_list|,
literal|"SAKE Master Secret A"
argument_list|,
name|rand_p
argument_list|,
name|EAP_SAKE_RAND_LEN
argument_list|,
name|rand_s
argument_list|,
name|EAP_SAKE_RAND_LEN
argument_list|,
name|sms_a
argument_list|,
name|EAP_SAKE_SMS_LEN
argument_list|)
expr_stmt|;
name|wpa_hexdump_key
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"EAP-SAKE: SMS-A"
argument_list|,
name|sms_a
argument_list|,
name|EAP_SAKE_SMS_LEN
argument_list|)
expr_stmt|;
name|eap_sake_kdf
argument_list|(
name|sms_a
argument_list|,
name|EAP_SAKE_SMS_LEN
argument_list|,
literal|"Transient EAP Key"
argument_list|,
name|rand_s
argument_list|,
name|EAP_SAKE_RAND_LEN
argument_list|,
name|rand_p
argument_list|,
name|EAP_SAKE_RAND_LEN
argument_list|,
name|tek
argument_list|,
name|EAP_SAKE_TEK_LEN
argument_list|)
expr_stmt|;
name|wpa_hexdump_key
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"EAP-SAKE: TEK-Auth"
argument_list|,
name|tek
argument_list|,
name|EAP_SAKE_TEK_AUTH_LEN
argument_list|)
expr_stmt|;
name|wpa_hexdump_key
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"EAP-SAKE: TEK-Cipher"
argument_list|,
name|tek
operator|+
name|EAP_SAKE_TEK_AUTH_LEN
argument_list|,
name|EAP_SAKE_TEK_CIPHER_LEN
argument_list|)
expr_stmt|;
name|wpa_hexdump_key
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"EAP-SAKE: Root-Secret-B"
argument_list|,
name|root_secret_b
argument_list|,
name|EAP_SAKE_ROOT_SECRET_LEN
argument_list|)
expr_stmt|;
name|eap_sake_kdf
argument_list|(
name|root_secret_b
argument_list|,
name|EAP_SAKE_ROOT_SECRET_LEN
argument_list|,
literal|"SAKE Master Secret B"
argument_list|,
name|rand_p
argument_list|,
name|EAP_SAKE_RAND_LEN
argument_list|,
name|rand_s
argument_list|,
name|EAP_SAKE_RAND_LEN
argument_list|,
name|sms_b
argument_list|,
name|EAP_SAKE_SMS_LEN
argument_list|)
expr_stmt|;
name|wpa_hexdump_key
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"EAP-SAKE: SMS-B"
argument_list|,
name|sms_b
argument_list|,
name|EAP_SAKE_SMS_LEN
argument_list|)
expr_stmt|;
name|eap_sake_kdf
argument_list|(
name|sms_b
argument_list|,
name|EAP_SAKE_SMS_LEN
argument_list|,
literal|"Master Session Key"
argument_list|,
name|rand_s
argument_list|,
name|EAP_SAKE_RAND_LEN
argument_list|,
name|rand_p
argument_list|,
name|EAP_SAKE_RAND_LEN
argument_list|,
name|key_buf
argument_list|,
sizeof|sizeof
argument_list|(
name|key_buf
argument_list|)
argument_list|)
expr_stmt|;
name|os_memcpy
argument_list|(
name|msk
argument_list|,
name|key_buf
argument_list|,
name|EAP_MSK_LEN
argument_list|)
expr_stmt|;
name|os_memcpy
argument_list|(
name|emsk
argument_list|,
name|key_buf
operator|+
name|EAP_MSK_LEN
argument_list|,
name|EAP_EMSK_LEN
argument_list|)
expr_stmt|;
name|wpa_hexdump_key
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"EAP-SAKE: MSK"
argument_list|,
name|msk
argument_list|,
name|EAP_MSK_LEN
argument_list|)
expr_stmt|;
name|wpa_hexdump_key
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"EAP-SAKE: EMSK"
argument_list|,
name|emsk
argument_list|,
name|EAP_EMSK_LEN
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/**  * eap_sake_compute_mic - Compute EAP-SAKE MIC for an EAP packet  * @tek_auth: 16-byte TEK-Auth  * @rand_s: 16-byte RAND_S  * @rand_p: 16-byte RAND_P  * @serverid: SERVERID  * @serverid_len: SERVERID length  * @peerid: PEERID  * @peerid_len: PEERID length  * @peer: MIC calculation for 0 = Server, 1 = Peer message  * @eap: EAP packet  * @eap_len: EAP packet length  * @mic_pos: MIC position in the EAP packet (must be [eap .. eap + eap_len])  * @mic: Buffer for the computed 16-byte MIC  */
end_comment

begin_function
name|int
name|eap_sake_compute_mic
parameter_list|(
specifier|const
name|u8
modifier|*
name|tek_auth
parameter_list|,
specifier|const
name|u8
modifier|*
name|rand_s
parameter_list|,
specifier|const
name|u8
modifier|*
name|rand_p
parameter_list|,
specifier|const
name|u8
modifier|*
name|serverid
parameter_list|,
name|size_t
name|serverid_len
parameter_list|,
specifier|const
name|u8
modifier|*
name|peerid
parameter_list|,
name|size_t
name|peerid_len
parameter_list|,
name|int
name|peer
parameter_list|,
specifier|const
name|u8
modifier|*
name|eap
parameter_list|,
name|size_t
name|eap_len
parameter_list|,
specifier|const
name|u8
modifier|*
name|mic_pos
parameter_list|,
name|u8
modifier|*
name|mic
parameter_list|)
block|{
name|u8
name|_rand
index|[
literal|2
operator|*
name|EAP_SAKE_RAND_LEN
index|]
decl_stmt|;
name|u8
modifier|*
name|tmp
decl_stmt|,
modifier|*
name|pos
decl_stmt|;
name|size_t
name|tmplen
decl_stmt|;
name|tmplen
operator|=
name|serverid_len
operator|+
literal|1
operator|+
name|peerid_len
operator|+
literal|1
operator|+
name|eap_len
expr_stmt|;
name|tmp
operator|=
name|os_malloc
argument_list|(
name|tmplen
argument_list|)
expr_stmt|;
if|if
condition|(
name|tmp
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
name|pos
operator|=
name|tmp
expr_stmt|;
if|if
condition|(
name|peer
condition|)
block|{
if|if
condition|(
name|peerid
condition|)
block|{
name|os_memcpy
argument_list|(
name|pos
argument_list|,
name|peerid
argument_list|,
name|peerid_len
argument_list|)
expr_stmt|;
name|pos
operator|+=
name|peerid_len
expr_stmt|;
block|}
operator|*
name|pos
operator|++
operator|=
literal|0x00
expr_stmt|;
if|if
condition|(
name|serverid
condition|)
block|{
name|os_memcpy
argument_list|(
name|pos
argument_list|,
name|serverid
argument_list|,
name|serverid_len
argument_list|)
expr_stmt|;
name|pos
operator|+=
name|serverid_len
expr_stmt|;
block|}
operator|*
name|pos
operator|++
operator|=
literal|0x00
expr_stmt|;
name|os_memcpy
argument_list|(
name|_rand
argument_list|,
name|rand_s
argument_list|,
name|EAP_SAKE_RAND_LEN
argument_list|)
expr_stmt|;
name|os_memcpy
argument_list|(
name|_rand
operator|+
name|EAP_SAKE_RAND_LEN
argument_list|,
name|rand_p
argument_list|,
name|EAP_SAKE_RAND_LEN
argument_list|)
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|serverid
condition|)
block|{
name|os_memcpy
argument_list|(
name|pos
argument_list|,
name|serverid
argument_list|,
name|serverid_len
argument_list|)
expr_stmt|;
name|pos
operator|+=
name|serverid_len
expr_stmt|;
block|}
operator|*
name|pos
operator|++
operator|=
literal|0x00
expr_stmt|;
if|if
condition|(
name|peerid
condition|)
block|{
name|os_memcpy
argument_list|(
name|pos
argument_list|,
name|peerid
argument_list|,
name|peerid_len
argument_list|)
expr_stmt|;
name|pos
operator|+=
name|peerid_len
expr_stmt|;
block|}
operator|*
name|pos
operator|++
operator|=
literal|0x00
expr_stmt|;
name|os_memcpy
argument_list|(
name|_rand
argument_list|,
name|rand_p
argument_list|,
name|EAP_SAKE_RAND_LEN
argument_list|)
expr_stmt|;
name|os_memcpy
argument_list|(
name|_rand
operator|+
name|EAP_SAKE_RAND_LEN
argument_list|,
name|rand_s
argument_list|,
name|EAP_SAKE_RAND_LEN
argument_list|)
expr_stmt|;
block|}
name|os_memcpy
argument_list|(
name|pos
argument_list|,
name|eap
argument_list|,
name|eap_len
argument_list|)
expr_stmt|;
name|os_memset
argument_list|(
name|pos
operator|+
operator|(
name|mic_pos
operator|-
name|eap
operator|)
argument_list|,
literal|0
argument_list|,
name|EAP_SAKE_MIC_LEN
argument_list|)
expr_stmt|;
name|eap_sake_kdf
argument_list|(
name|tek_auth
argument_list|,
name|EAP_SAKE_TEK_AUTH_LEN
argument_list|,
name|peer
condition|?
literal|"Peer MIC"
else|:
literal|"Server MIC"
argument_list|,
name|_rand
argument_list|,
literal|2
operator|*
name|EAP_SAKE_RAND_LEN
argument_list|,
name|tmp
argument_list|,
name|tmplen
argument_list|,
name|mic
argument_list|,
name|EAP_SAKE_MIC_LEN
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|tmp
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * EAP peer method: EAP-MSCHAPV2 (draft-kamath-pppext-eap-mschapv2-00.txt)  * Copyright (c) 2004-2006, Jouni Malinen<j@w1.fi>  *  * This program is free software; you can redistribute it and/or modify  * it under the terms of the GNU General Public License version 2 as  * published by the Free Software Foundation.  *  * Alternatively, this software may be distributed under the terms of BSD  * license.  *  * See README and COPYING for more details.  *  * This file implements EAP peer part of EAP-MSCHAPV2 method (EAP type 26).  * draft-kamath-pppext-eap-mschapv2-00.txt defines the Microsoft EAP CHAP  * Extensions Protocol, Version 2, for mutual authentication and key  * derivation. This encapsulates MS-CHAP-v2 protocol which is defined in  * RFC 2759. Use of EAP-MSCHAPV2 derived keys with MPPE cipher is described in  * RFC 3079.  */
end_comment

begin_include
include|#
directive|include
file|"includes.h"
end_include

begin_include
include|#
directive|include
file|"common.h"
end_include

begin_include
include|#
directive|include
file|"eap_i.h"
end_include

begin_include
include|#
directive|include
file|"config_ssid.h"
end_include

begin_include
include|#
directive|include
file|"ms_funcs.h"
end_include

begin_include
include|#
directive|include
file|"wpa_ctrl.h"
end_include

begin_define
define|#
directive|define
name|MSCHAPV2_CHAL_LEN
value|16
end_define

begin_define
define|#
directive|define
name|MSCHAPV2_NT_RESPONSE_LEN
value|24
end_define

begin_ifdef
ifdef|#
directive|ifdef
name|_MSC_VER
end_ifdef

begin_pragma
pragma|#
directive|pragma
name|pack
name|(
name|push
name|,
name|1
name|)
end_pragma

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* _MSC_VER */
end_comment

begin_struct
struct|struct
name|eap_mschapv2_hdr
block|{
name|u8
name|op_code
decl_stmt|;
comment|/* MSCHAPV2_OP_* */
name|u8
name|mschapv2_id
decl_stmt|;
comment|/* usually same as EAP identifier; must be changed 			 * for challenges, but not for success/failure */
name|u8
name|ms_length
index|[
literal|2
index|]
decl_stmt|;
comment|/* Note: misaligned; length - 5 */
comment|/* followed by data */
block|}
name|STRUCT_PACKED
struct|;
end_struct

begin_comment
comment|/* Response Data field */
end_comment

begin_struct
struct|struct
name|ms_response
block|{
name|u8
name|peer_challenge
index|[
name|MSCHAPV2_CHAL_LEN
index|]
decl_stmt|;
name|u8
name|reserved
index|[
literal|8
index|]
decl_stmt|;
name|u8
name|nt_response
index|[
name|MSCHAPV2_NT_RESPONSE_LEN
index|]
decl_stmt|;
name|u8
name|flags
decl_stmt|;
block|}
name|STRUCT_PACKED
struct|;
end_struct

begin_comment
comment|/* Change-Password Data field */
end_comment

begin_struct
struct|struct
name|ms_change_password
block|{
name|u8
name|encr_password
index|[
literal|516
index|]
decl_stmt|;
name|u8
name|encr_hash
index|[
literal|16
index|]
decl_stmt|;
name|u8
name|peer_challenge
index|[
name|MSCHAPV2_CHAL_LEN
index|]
decl_stmt|;
name|u8
name|reserved
index|[
literal|8
index|]
decl_stmt|;
name|u8
name|nt_response
index|[
name|MSCHAPV2_NT_RESPONSE_LEN
index|]
decl_stmt|;
name|u8
name|flags
index|[
literal|2
index|]
decl_stmt|;
block|}
name|STRUCT_PACKED
struct|;
end_struct

begin_ifdef
ifdef|#
directive|ifdef
name|_MSC_VER
end_ifdef

begin_pragma
pragma|#
directive|pragma
name|pack
name|(
name|pop
name|)
end_pragma

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* _MSC_VER */
end_comment

begin_define
define|#
directive|define
name|MSCHAPV2_OP_CHALLENGE
value|1
end_define

begin_define
define|#
directive|define
name|MSCHAPV2_OP_RESPONSE
value|2
end_define

begin_define
define|#
directive|define
name|MSCHAPV2_OP_SUCCESS
value|3
end_define

begin_define
define|#
directive|define
name|MSCHAPV2_OP_FAILURE
value|4
end_define

begin_define
define|#
directive|define
name|MSCHAPV2_OP_CHANGE_PASSWORD
value|7
end_define

begin_define
define|#
directive|define
name|ERROR_RESTRICTED_LOGON_HOURS
value|646
end_define

begin_define
define|#
directive|define
name|ERROR_ACCT_DISABLED
value|647
end_define

begin_define
define|#
directive|define
name|ERROR_PASSWD_EXPIRED
value|648
end_define

begin_define
define|#
directive|define
name|ERROR_NO_DIALIN_PERMISSION
value|649
end_define

begin_define
define|#
directive|define
name|ERROR_AUTHENTICATION_FAILURE
value|691
end_define

begin_define
define|#
directive|define
name|ERROR_CHANGING_PASSWORD
value|709
end_define

begin_define
define|#
directive|define
name|PASSWD_CHANGE_CHAL_LEN
value|16
end_define

begin_define
define|#
directive|define
name|MSCHAPV2_KEY_LEN
value|16
end_define

begin_struct
struct|struct
name|eap_mschapv2_data
block|{
name|u8
name|auth_response
index|[
literal|20
index|]
decl_stmt|;
name|int
name|auth_response_valid
decl_stmt|;
name|int
name|prev_error
decl_stmt|;
name|u8
name|passwd_change_challenge
index|[
name|PASSWD_CHANGE_CHAL_LEN
index|]
decl_stmt|;
name|int
name|passwd_change_challenge_valid
decl_stmt|;
name|int
name|passwd_change_version
decl_stmt|;
comment|/* Optional challenge values generated in EAP-FAST Phase 1 negotiation 	 */
name|u8
modifier|*
name|peer_challenge
decl_stmt|;
name|u8
modifier|*
name|auth_challenge
decl_stmt|;
name|int
name|full_key
decl_stmt|;
name|int
name|phase2
decl_stmt|;
name|u8
name|master_key
index|[
literal|16
index|]
decl_stmt|;
name|int
name|master_key_valid
decl_stmt|;
name|int
name|success
decl_stmt|;
name|u8
modifier|*
name|prev_challenge
decl_stmt|;
name|size_t
name|prev_challenge_len
decl_stmt|;
block|}
struct|;
end_struct

begin_function_decl
specifier|static
name|void
name|eap_mschapv2_deinit
parameter_list|(
name|struct
name|eap_sm
modifier|*
name|sm
parameter_list|,
name|void
modifier|*
name|priv
parameter_list|)
function_decl|;
end_function_decl

begin_function
specifier|static
name|void
modifier|*
name|eap_mschapv2_init
parameter_list|(
name|struct
name|eap_sm
modifier|*
name|sm
parameter_list|)
block|{
name|struct
name|eap_mschapv2_data
modifier|*
name|data
decl_stmt|;
name|data
operator|=
name|os_zalloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|data
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|data
operator|==
name|NULL
condition|)
return|return
name|NULL
return|;
name|data
operator|->
name|full_key
operator|=
name|sm
operator|->
name|mschapv2_full_key
expr_stmt|;
if|if
condition|(
name|sm
operator|->
name|peer_challenge
condition|)
block|{
name|data
operator|->
name|full_key
operator|=
literal|1
expr_stmt|;
name|data
operator|->
name|peer_challenge
operator|=
name|os_malloc
argument_list|(
name|MSCHAPV2_CHAL_LEN
argument_list|)
expr_stmt|;
if|if
condition|(
name|data
operator|->
name|peer_challenge
operator|==
name|NULL
condition|)
block|{
name|eap_mschapv2_deinit
argument_list|(
name|sm
argument_list|,
name|data
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|os_memcpy
argument_list|(
name|data
operator|->
name|peer_challenge
argument_list|,
name|sm
operator|->
name|peer_challenge
argument_list|,
name|MSCHAPV2_CHAL_LEN
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|sm
operator|->
name|auth_challenge
condition|)
block|{
name|data
operator|->
name|auth_challenge
operator|=
name|os_malloc
argument_list|(
name|MSCHAPV2_CHAL_LEN
argument_list|)
expr_stmt|;
if|if
condition|(
name|data
operator|->
name|auth_challenge
operator|==
name|NULL
condition|)
block|{
name|eap_mschapv2_deinit
argument_list|(
name|sm
argument_list|,
name|data
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|os_memcpy
argument_list|(
name|data
operator|->
name|auth_challenge
argument_list|,
name|sm
operator|->
name|auth_challenge
argument_list|,
name|MSCHAPV2_CHAL_LEN
argument_list|)
expr_stmt|;
block|}
name|data
operator|->
name|phase2
operator|=
name|sm
operator|->
name|init_phase2
expr_stmt|;
return|return
name|data
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|eap_mschapv2_deinit
parameter_list|(
name|struct
name|eap_sm
modifier|*
name|sm
parameter_list|,
name|void
modifier|*
name|priv
parameter_list|)
block|{
name|struct
name|eap_mschapv2_data
modifier|*
name|data
init|=
name|priv
decl_stmt|;
name|os_free
argument_list|(
name|data
operator|->
name|peer_challenge
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|data
operator|->
name|auth_challenge
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|data
operator|->
name|prev_challenge
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|data
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
specifier|const
name|u8
modifier|*
name|eap_mschapv2_remove_domain
parameter_list|(
specifier|const
name|u8
modifier|*
name|username
parameter_list|,
name|size_t
modifier|*
name|len
parameter_list|)
block|{
name|size_t
name|i
decl_stmt|;
comment|/* 	 * MSCHAPv2 does not include optional domain name in the 	 * challenge-response calculation, so remove domain prefix 	 * (if present). 	 */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
operator|*
name|len
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|username
index|[
name|i
index|]
operator|==
literal|'\\'
condition|)
block|{
operator|*
name|len
operator|-=
name|i
operator|+
literal|1
expr_stmt|;
return|return
name|username
operator|+
name|i
operator|+
literal|1
return|;
block|}
block|}
return|return
name|username
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|eap_mschapv2_derive_response
parameter_list|(
name|struct
name|eap_mschapv2_data
modifier|*
name|data
parameter_list|,
specifier|const
name|u8
modifier|*
name|username
parameter_list|,
name|size_t
name|username_len
parameter_list|,
specifier|const
name|u8
modifier|*
name|password
parameter_list|,
name|size_t
name|password_len
parameter_list|,
specifier|const
name|u8
modifier|*
name|auth_challenge
parameter_list|,
specifier|const
name|u8
modifier|*
name|peer_challenge
parameter_list|,
name|u8
modifier|*
name|nt_response
parameter_list|)
block|{
name|u8
name|password_hash
index|[
literal|16
index|]
decl_stmt|,
name|password_hash_hash
index|[
literal|16
index|]
decl_stmt|;
name|wpa_hexdump
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"EAP-MSCHAPV2: auth_challenge"
argument_list|,
name|auth_challenge
argument_list|,
name|MSCHAPV2_CHAL_LEN
argument_list|)
expr_stmt|;
name|wpa_hexdump
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"EAP-MSCHAPV2: peer_challenge"
argument_list|,
name|peer_challenge
argument_list|,
name|MSCHAPV2_CHAL_LEN
argument_list|)
expr_stmt|;
name|wpa_hexdump_ascii
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"EAP-MSCHAPV2: username"
argument_list|,
name|username
argument_list|,
name|username_len
argument_list|)
expr_stmt|;
name|wpa_hexdump_ascii_key
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"EAP-MSCHAPV2: password"
argument_list|,
name|password
argument_list|,
name|password_len
argument_list|)
expr_stmt|;
name|generate_nt_response
argument_list|(
name|auth_challenge
argument_list|,
name|peer_challenge
argument_list|,
name|username
argument_list|,
name|username_len
argument_list|,
name|password
argument_list|,
name|password_len
argument_list|,
name|nt_response
argument_list|)
expr_stmt|;
name|wpa_hexdump
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"EAP-MSCHAPV2: response"
argument_list|,
name|nt_response
argument_list|,
name|MSCHAPV2_NT_RESPONSE_LEN
argument_list|)
expr_stmt|;
comment|/* Authenticator response is not really needed yet, but calculate it 	 * here so that challenges need not be saved. */
name|generate_authenticator_response
argument_list|(
name|password
argument_list|,
name|password_len
argument_list|,
name|peer_challenge
argument_list|,
name|auth_challenge
argument_list|,
name|username
argument_list|,
name|username_len
argument_list|,
name|nt_response
argument_list|,
name|data
operator|->
name|auth_response
argument_list|)
expr_stmt|;
name|data
operator|->
name|auth_response_valid
operator|=
literal|1
expr_stmt|;
comment|/* Likewise, generate master_key here since we have the needed data 	 * available. */
name|nt_password_hash
argument_list|(
name|password
argument_list|,
name|password_len
argument_list|,
name|password_hash
argument_list|)
expr_stmt|;
name|hash_nt_password_hash
argument_list|(
name|password_hash
argument_list|,
name|password_hash_hash
argument_list|)
expr_stmt|;
name|get_master_key
argument_list|(
name|password_hash_hash
argument_list|,
name|nt_response
argument_list|,
name|data
operator|->
name|master_key
argument_list|)
expr_stmt|;
name|data
operator|->
name|master_key_valid
operator|=
literal|1
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|u8
modifier|*
name|eap_mschapv2_challenge_reply
parameter_list|(
name|struct
name|eap_sm
modifier|*
name|sm
parameter_list|,
name|struct
name|eap_mschapv2_data
modifier|*
name|data
parameter_list|,
name|u8
name|id
parameter_list|,
name|u8
name|mschapv2_id
parameter_list|,
specifier|const
name|u8
modifier|*
name|auth_challenge
parameter_list|,
name|size_t
modifier|*
name|respDataLen
parameter_list|)
block|{
name|struct
name|eap_hdr
modifier|*
name|resp
decl_stmt|;
name|struct
name|eap_mschapv2_hdr
modifier|*
name|ms
decl_stmt|;
name|u8
modifier|*
name|rpos
decl_stmt|,
modifier|*
name|peer_challenge
decl_stmt|;
name|int
name|ms_len
decl_stmt|;
name|struct
name|ms_response
modifier|*
name|r
decl_stmt|;
name|size_t
name|username_len
decl_stmt|,
name|identity_len
decl_stmt|,
name|password_len
decl_stmt|;
specifier|const
name|u8
modifier|*
name|username
decl_stmt|,
modifier|*
name|identity
decl_stmt|,
modifier|*
name|password
decl_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"EAP-MSCHAPV2: Generating Challenge Response"
argument_list|)
expr_stmt|;
name|identity
operator|=
name|eap_get_config_identity
argument_list|(
name|sm
argument_list|,
operator|&
name|identity_len
argument_list|)
expr_stmt|;
name|password
operator|=
name|eap_get_config_password
argument_list|(
name|sm
argument_list|,
operator|&
name|password_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|identity
operator|==
name|NULL
operator|||
name|password
operator|==
name|NULL
condition|)
return|return
name|NULL
return|;
name|username_len
operator|=
name|identity_len
expr_stmt|;
name|username
operator|=
name|eap_mschapv2_remove_domain
argument_list|(
name|identity
argument_list|,
operator|&
name|username_len
argument_list|)
expr_stmt|;
name|ms_len
operator|=
sizeof|sizeof
argument_list|(
operator|*
name|ms
argument_list|)
operator|+
literal|1
operator|+
sizeof|sizeof
argument_list|(
operator|*
name|r
argument_list|)
operator|+
name|identity_len
expr_stmt|;
name|resp
operator|=
name|eap_msg_alloc
argument_list|(
name|EAP_VENDOR_IETF
argument_list|,
name|EAP_TYPE_MSCHAPV2
argument_list|,
name|respDataLen
argument_list|,
name|ms_len
argument_list|,
name|EAP_CODE_RESPONSE
argument_list|,
name|id
argument_list|,
operator|&
name|rpos
argument_list|)
expr_stmt|;
if|if
condition|(
name|resp
operator|==
name|NULL
condition|)
return|return
name|NULL
return|;
name|ms
operator|=
operator|(
expr|struct
name|eap_mschapv2_hdr
operator|*
operator|)
name|rpos
expr_stmt|;
name|ms
operator|->
name|op_code
operator|=
name|MSCHAPV2_OP_RESPONSE
expr_stmt|;
name|ms
operator|->
name|mschapv2_id
operator|=
name|mschapv2_id
expr_stmt|;
if|if
condition|(
name|data
operator|->
name|prev_error
condition|)
block|{
comment|/* 		 * TODO: this does not seem to be enough when processing two 		 * or more failure messages. IAS did not increment mschapv2_id 		 * in its own packets, but it seemed to expect the peer to 		 * increment this for all packets(?). 		 */
name|ms
operator|->
name|mschapv2_id
operator|++
expr_stmt|;
block|}
name|WPA_PUT_BE16
argument_list|(
name|ms
operator|->
name|ms_length
argument_list|,
name|ms_len
argument_list|)
expr_stmt|;
name|rpos
operator|=
operator|(
name|u8
operator|*
operator|)
operator|(
name|ms
operator|+
literal|1
operator|)
expr_stmt|;
operator|*
name|rpos
operator|++
operator|=
sizeof|sizeof
argument_list|(
operator|*
name|r
argument_list|)
expr_stmt|;
comment|/* Value-Size */
comment|/* Response */
name|r
operator|=
operator|(
expr|struct
name|ms_response
operator|*
operator|)
name|rpos
expr_stmt|;
name|peer_challenge
operator|=
name|r
operator|->
name|peer_challenge
expr_stmt|;
if|if
condition|(
name|data
operator|->
name|peer_challenge
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"EAP-MSCHAPV2: peer_challenge generated "
literal|"in Phase 1"
argument_list|)
expr_stmt|;
name|peer_challenge
operator|=
name|data
operator|->
name|peer_challenge
expr_stmt|;
name|os_memset
argument_list|(
name|r
operator|->
name|peer_challenge
argument_list|,
literal|0
argument_list|,
name|MSCHAPV2_CHAL_LEN
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|os_get_random
argument_list|(
name|peer_challenge
argument_list|,
name|MSCHAPV2_CHAL_LEN
argument_list|)
condition|)
block|{
name|os_free
argument_list|(
name|resp
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|os_memset
argument_list|(
name|r
operator|->
name|reserved
argument_list|,
literal|0
argument_list|,
literal|8
argument_list|)
expr_stmt|;
if|if
condition|(
name|data
operator|->
name|auth_challenge
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"EAP-MSCHAPV2: auth_challenge generated "
literal|"in Phase 1"
argument_list|)
expr_stmt|;
name|auth_challenge
operator|=
name|data
operator|->
name|auth_challenge
expr_stmt|;
block|}
name|eap_mschapv2_derive_response
argument_list|(
name|data
argument_list|,
name|username
argument_list|,
name|username_len
argument_list|,
name|password
argument_list|,
name|password_len
argument_list|,
name|auth_challenge
argument_list|,
name|peer_challenge
argument_list|,
name|r
operator|->
name|nt_response
argument_list|)
expr_stmt|;
name|r
operator|->
name|flags
operator|=
literal|0
expr_stmt|;
comment|/* reserved, must be zero */
name|os_memcpy
argument_list|(
operator|(
name|u8
operator|*
operator|)
operator|(
name|r
operator|+
literal|1
operator|)
argument_list|,
name|identity
argument_list|,
name|identity_len
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"EAP-MSCHAPV2: TX identifier %d mschapv2_id %d "
literal|"(response)"
argument_list|,
name|resp
operator|->
name|identifier
argument_list|,
name|ms
operator|->
name|mschapv2_id
argument_list|)
expr_stmt|;
return|return
operator|(
name|u8
operator|*
operator|)
name|resp
return|;
block|}
end_function

begin_comment
comment|/**  * eap_mschapv2_process - Process an EAP-MSCHAPv2 challenge message  * @sm: Pointer to EAP state machine allocated with eap_sm_init()  * @data: Pointer to private EAP method data from eap_mschapv2_init()  * @ret: Return values from EAP request validation and processing  * @req: Pointer to EAP-MSCHAPv2 header from the request  * @req_len: Length of the EAP-MSCHAPv2 data  * @id: EAP identifier used in th erequest  * @respDataLen: Length of the returned EAP response  * Returns: Pointer to allocated EAP response packet (eapRespData) or %NULL if  * no reply available  */
end_comment

begin_function
specifier|static
name|u8
modifier|*
name|eap_mschapv2_challenge
parameter_list|(
name|struct
name|eap_sm
modifier|*
name|sm
parameter_list|,
name|struct
name|eap_mschapv2_data
modifier|*
name|data
parameter_list|,
name|struct
name|eap_method_ret
modifier|*
name|ret
parameter_list|,
specifier|const
name|struct
name|eap_mschapv2_hdr
modifier|*
name|req
parameter_list|,
name|size_t
name|req_len
parameter_list|,
name|u8
name|id
parameter_list|,
name|size_t
modifier|*
name|respDataLen
parameter_list|)
block|{
name|size_t
name|len
decl_stmt|,
name|challenge_len
decl_stmt|;
specifier|const
name|u8
modifier|*
name|pos
decl_stmt|,
modifier|*
name|challenge
decl_stmt|;
if|if
condition|(
name|eap_get_config_identity
argument_list|(
name|sm
argument_list|,
operator|&
name|len
argument_list|)
operator|==
name|NULL
operator|||
name|eap_get_config_password
argument_list|(
name|sm
argument_list|,
operator|&
name|len
argument_list|)
operator|==
name|NULL
condition|)
return|return
name|NULL
return|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"EAP-MSCHAPV2: Received challenge"
argument_list|)
expr_stmt|;
if|if
condition|(
name|req_len
operator|<
sizeof|sizeof
argument_list|(
operator|*
name|req
argument_list|)
operator|+
literal|1
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"EAP-MSCHAPV2: Too short challenge data "
literal|"(len %lu)"
argument_list|,
operator|(
name|unsigned
name|long
operator|)
name|req_len
argument_list|)
expr_stmt|;
name|ret
operator|->
name|ignore
operator|=
name|TRUE
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|pos
operator|=
operator|(
specifier|const
name|u8
operator|*
operator|)
operator|(
name|req
operator|+
literal|1
operator|)
expr_stmt|;
name|challenge_len
operator|=
operator|*
name|pos
operator|++
expr_stmt|;
name|len
operator|=
name|req_len
operator|-
sizeof|sizeof
argument_list|(
operator|*
name|req
argument_list|)
operator|-
literal|1
expr_stmt|;
if|if
condition|(
name|challenge_len
operator|!=
name|MSCHAPV2_CHAL_LEN
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"EAP-MSCHAPV2: Invalid challenge length "
literal|"%lu"
argument_list|,
operator|(
name|unsigned
name|long
operator|)
name|challenge_len
argument_list|)
expr_stmt|;
name|ret
operator|->
name|ignore
operator|=
name|TRUE
expr_stmt|;
return|return
name|NULL
return|;
block|}
if|if
condition|(
name|len
operator|<
name|challenge_len
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"EAP-MSCHAPV2: Too short challenge"
literal|" packet: len=%lu challenge_len=%lu"
argument_list|,
operator|(
name|unsigned
name|long
operator|)
name|len
argument_list|,
operator|(
name|unsigned
name|long
operator|)
name|challenge_len
argument_list|)
expr_stmt|;
name|ret
operator|->
name|ignore
operator|=
name|TRUE
expr_stmt|;
return|return
name|NULL
return|;
block|}
if|if
condition|(
name|data
operator|->
name|passwd_change_challenge_valid
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"EAP-MSCHAPV2: Using challenge from the "
literal|"failure message"
argument_list|)
expr_stmt|;
name|challenge
operator|=
name|data
operator|->
name|passwd_change_challenge
expr_stmt|;
block|}
else|else
name|challenge
operator|=
name|pos
expr_stmt|;
name|pos
operator|+=
name|challenge_len
expr_stmt|;
name|len
operator|-=
name|challenge_len
expr_stmt|;
name|wpa_hexdump_ascii
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"EAP-MSCHAPV2: Authentication Servername"
argument_list|,
name|pos
argument_list|,
name|len
argument_list|)
expr_stmt|;
name|ret
operator|->
name|ignore
operator|=
name|FALSE
expr_stmt|;
name|ret
operator|->
name|methodState
operator|=
name|METHOD_MAY_CONT
expr_stmt|;
name|ret
operator|->
name|decision
operator|=
name|DECISION_FAIL
expr_stmt|;
name|ret
operator|->
name|allowNotifications
operator|=
name|TRUE
expr_stmt|;
return|return
name|eap_mschapv2_challenge_reply
argument_list|(
name|sm
argument_list|,
name|data
argument_list|,
name|id
argument_list|,
name|req
operator|->
name|mschapv2_id
argument_list|,
name|challenge
argument_list|,
name|respDataLen
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|eap_mschapv2_password_changed
parameter_list|(
name|struct
name|eap_sm
modifier|*
name|sm
parameter_list|,
name|struct
name|eap_mschapv2_data
modifier|*
name|data
parameter_list|)
block|{
name|struct
name|wpa_ssid
modifier|*
name|config
init|=
name|eap_get_config
argument_list|(
name|sm
argument_list|)
decl_stmt|;
if|if
condition|(
name|config
operator|&&
name|config
operator|->
name|new_password
condition|)
block|{
name|wpa_msg
argument_list|(
name|sm
operator|->
name|msg_ctx
argument_list|,
name|MSG_INFO
argument_list|,
name|WPA_EVENT_PASSWORD_CHANGED
literal|"EAP-MSCHAPV2: Password changed successfully"
argument_list|)
expr_stmt|;
name|data
operator|->
name|prev_error
operator|=
literal|0
expr_stmt|;
name|os_free
argument_list|(
name|config
operator|->
name|password
argument_list|)
expr_stmt|;
name|config
operator|->
name|password
operator|=
name|config
operator|->
name|new_password
expr_stmt|;
name|config
operator|->
name|new_password
operator|=
name|NULL
expr_stmt|;
name|config
operator|->
name|password_len
operator|=
name|config
operator|->
name|new_password_len
expr_stmt|;
name|config
operator|->
name|new_password_len
operator|=
literal|0
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/**  * eap_mschapv2_process - Process an EAP-MSCHAPv2 success message  * @sm: Pointer to EAP state machine allocated with eap_sm_init()  * @data: Pointer to private EAP method data from eap_mschapv2_init()  * @ret: Return values from EAP request validation and processing  * @req: Pointer to EAP-MSCHAPv2 header from the request  * @req_len: Length of the EAP-MSCHAPv2 data  * @id: EAP identifier used in th erequest  * @respDataLen: Length of the returned EAP response  * Returns: Pointer to allocated EAP response packet (eapRespData) or %NULL if  * no reply available  */
end_comment

begin_function
specifier|static
name|u8
modifier|*
name|eap_mschapv2_success
parameter_list|(
name|struct
name|eap_sm
modifier|*
name|sm
parameter_list|,
name|struct
name|eap_mschapv2_data
modifier|*
name|data
parameter_list|,
name|struct
name|eap_method_ret
modifier|*
name|ret
parameter_list|,
specifier|const
name|struct
name|eap_mschapv2_hdr
modifier|*
name|req
parameter_list|,
name|size_t
name|req_len
parameter_list|,
name|u8
name|id
parameter_list|,
name|size_t
modifier|*
name|respDataLen
parameter_list|)
block|{
name|struct
name|eap_hdr
modifier|*
name|resp
decl_stmt|;
name|struct
name|eap_mschapv2_hdr
modifier|*
name|ms
decl_stmt|;
specifier|const
name|u8
modifier|*
name|pos
decl_stmt|;
name|u8
name|recv_response
index|[
literal|20
index|]
decl_stmt|;
name|size_t
name|len
decl_stmt|;
name|u8
modifier|*
name|rpos
decl_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"EAP-MSCHAPV2: Received success"
argument_list|)
expr_stmt|;
name|len
operator|=
name|req_len
operator|-
sizeof|sizeof
argument_list|(
operator|*
name|req
argument_list|)
expr_stmt|;
name|pos
operator|=
operator|(
specifier|const
name|u8
operator|*
operator|)
operator|(
name|req
operator|+
literal|1
operator|)
expr_stmt|;
if|if
condition|(
operator|!
name|data
operator|->
name|auth_response_valid
operator|||
name|len
operator|<
literal|42
operator|||
name|pos
index|[
literal|0
index|]
operator|!=
literal|'S'
operator|||
name|pos
index|[
literal|1
index|]
operator|!=
literal|'='
operator|||
name|hexstr2bin
argument_list|(
operator|(
name|char
operator|*
operator|)
operator|(
name|pos
operator|+
literal|2
operator|)
argument_list|,
name|recv_response
argument_list|,
literal|20
argument_list|)
operator|||
name|os_memcmp
argument_list|(
name|data
operator|->
name|auth_response
argument_list|,
name|recv_response
argument_list|,
literal|20
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_WARNING
argument_list|,
literal|"EAP-MSCHAPV2: Invalid authenticator "
literal|"response in success request"
argument_list|)
expr_stmt|;
name|ret
operator|->
name|methodState
operator|=
name|METHOD_DONE
expr_stmt|;
name|ret
operator|->
name|decision
operator|=
name|DECISION_FAIL
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|pos
operator|+=
literal|42
expr_stmt|;
name|len
operator|-=
literal|42
expr_stmt|;
while|while
condition|(
name|len
operator|>
literal|0
operator|&&
operator|*
name|pos
operator|==
literal|' '
condition|)
block|{
name|pos
operator|++
expr_stmt|;
name|len
operator|--
expr_stmt|;
block|}
name|wpa_hexdump_ascii
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"EAP-MSCHAPV2: Success message"
argument_list|,
name|pos
argument_list|,
name|len
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"EAP-MSCHAPV2: Authentication succeeded"
argument_list|)
expr_stmt|;
comment|/* Note: Only op_code of the EAP-MSCHAPV2 header is included in success 	 * message. */
name|resp
operator|=
name|eap_msg_alloc
argument_list|(
name|EAP_VENDOR_IETF
argument_list|,
name|EAP_TYPE_MSCHAPV2
argument_list|,
name|respDataLen
argument_list|,
literal|1
argument_list|,
name|EAP_CODE_RESPONSE
argument_list|,
name|id
argument_list|,
operator|&
name|rpos
argument_list|)
expr_stmt|;
if|if
condition|(
name|resp
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"EAP-MSCHAPV2: Failed to allocate "
literal|"buffer for success response"
argument_list|)
expr_stmt|;
name|ret
operator|->
name|ignore
operator|=
name|TRUE
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|ms
operator|=
operator|(
expr|struct
name|eap_mschapv2_hdr
operator|*
operator|)
name|rpos
expr_stmt|;
name|ms
operator|->
name|op_code
operator|=
name|MSCHAPV2_OP_SUCCESS
expr_stmt|;
name|ret
operator|->
name|methodState
operator|=
name|METHOD_DONE
expr_stmt|;
name|ret
operator|->
name|decision
operator|=
name|DECISION_UNCOND_SUCC
expr_stmt|;
name|ret
operator|->
name|allowNotifications
operator|=
name|FALSE
expr_stmt|;
name|data
operator|->
name|success
operator|=
literal|1
expr_stmt|;
if|if
condition|(
name|data
operator|->
name|prev_error
operator|==
name|ERROR_PASSWD_EXPIRED
condition|)
name|eap_mschapv2_password_changed
argument_list|(
name|sm
argument_list|,
name|data
argument_list|)
expr_stmt|;
return|return
operator|(
name|u8
operator|*
operator|)
name|resp
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|eap_mschapv2_failure_txt
parameter_list|(
name|struct
name|eap_sm
modifier|*
name|sm
parameter_list|,
name|struct
name|eap_mschapv2_data
modifier|*
name|data
parameter_list|,
name|char
modifier|*
name|txt
parameter_list|)
block|{
name|char
modifier|*
name|pos
decl_stmt|,
modifier|*
name|msg
init|=
literal|""
decl_stmt|;
name|int
name|retry
init|=
literal|1
decl_stmt|;
name|struct
name|wpa_ssid
modifier|*
name|config
init|=
name|eap_get_config
argument_list|(
name|sm
argument_list|)
decl_stmt|;
comment|/* For example: 	 * E=691 R=1 C=<32 octets hex challenge> V=3 M=Authentication Failure 	 */
name|pos
operator|=
name|txt
expr_stmt|;
if|if
condition|(
name|pos
operator|&&
name|os_strncmp
argument_list|(
name|pos
argument_list|,
literal|"E="
argument_list|,
literal|2
argument_list|)
operator|==
literal|0
condition|)
block|{
name|pos
operator|+=
literal|2
expr_stmt|;
name|data
operator|->
name|prev_error
operator|=
name|atoi
argument_list|(
name|pos
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"EAP-MSCHAPV2: error %d"
argument_list|,
name|data
operator|->
name|prev_error
argument_list|)
expr_stmt|;
name|pos
operator|=
name|os_strchr
argument_list|(
name|pos
argument_list|,
literal|' '
argument_list|)
expr_stmt|;
if|if
condition|(
name|pos
condition|)
name|pos
operator|++
expr_stmt|;
block|}
if|if
condition|(
name|pos
operator|&&
name|os_strncmp
argument_list|(
name|pos
argument_list|,
literal|"R="
argument_list|,
literal|2
argument_list|)
operator|==
literal|0
condition|)
block|{
name|pos
operator|+=
literal|2
expr_stmt|;
name|retry
operator|=
name|atoi
argument_list|(
name|pos
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"EAP-MSCHAPV2: retry is %sallowed"
argument_list|,
name|retry
operator|==
literal|1
condition|?
literal|""
else|:
literal|"not "
argument_list|)
expr_stmt|;
name|pos
operator|=
name|os_strchr
argument_list|(
name|pos
argument_list|,
literal|' '
argument_list|)
expr_stmt|;
if|if
condition|(
name|pos
condition|)
name|pos
operator|++
expr_stmt|;
block|}
if|if
condition|(
name|pos
operator|&&
name|os_strncmp
argument_list|(
name|pos
argument_list|,
literal|"C="
argument_list|,
literal|2
argument_list|)
operator|==
literal|0
condition|)
block|{
name|int
name|hex_len
decl_stmt|;
name|pos
operator|+=
literal|2
expr_stmt|;
name|hex_len
operator|=
name|os_strchr
argument_list|(
name|pos
argument_list|,
literal|' '
argument_list|)
operator|-
operator|(
name|char
operator|*
operator|)
name|pos
expr_stmt|;
if|if
condition|(
name|hex_len
operator|==
name|PASSWD_CHANGE_CHAL_LEN
operator|*
literal|2
condition|)
block|{
if|if
condition|(
name|hexstr2bin
argument_list|(
name|pos
argument_list|,
name|data
operator|->
name|passwd_change_challenge
argument_list|,
name|PASSWD_CHANGE_CHAL_LEN
argument_list|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"EAP-MSCHAPV2: invalid "
literal|"failure challenge"
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|wpa_hexdump
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"EAP-MSCHAPV2: failure "
literal|"challenge"
argument_list|,
name|data
operator|->
name|passwd_change_challenge
argument_list|,
name|PASSWD_CHANGE_CHAL_LEN
argument_list|)
expr_stmt|;
name|data
operator|->
name|passwd_change_challenge_valid
operator|=
literal|1
expr_stmt|;
block|}
block|}
else|else
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"EAP-MSCHAPV2: invalid failure "
literal|"challenge len %d"
argument_list|,
name|hex_len
argument_list|)
expr_stmt|;
block|}
name|pos
operator|=
name|os_strchr
argument_list|(
name|pos
argument_list|,
literal|' '
argument_list|)
expr_stmt|;
if|if
condition|(
name|pos
condition|)
name|pos
operator|++
expr_stmt|;
block|}
else|else
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"EAP-MSCHAPV2: required challenge field "
literal|"was not present in failure message"
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|pos
operator|&&
name|os_strncmp
argument_list|(
name|pos
argument_list|,
literal|"V="
argument_list|,
literal|2
argument_list|)
operator|==
literal|0
condition|)
block|{
name|pos
operator|+=
literal|2
expr_stmt|;
name|data
operator|->
name|passwd_change_version
operator|=
name|atoi
argument_list|(
name|pos
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"EAP-MSCHAPV2: password changing "
literal|"protocol version %d"
argument_list|,
name|data
operator|->
name|passwd_change_version
argument_list|)
expr_stmt|;
name|pos
operator|=
name|os_strchr
argument_list|(
name|pos
argument_list|,
literal|' '
argument_list|)
expr_stmt|;
if|if
condition|(
name|pos
condition|)
name|pos
operator|++
expr_stmt|;
block|}
if|if
condition|(
name|pos
operator|&&
name|os_strncmp
argument_list|(
name|pos
argument_list|,
literal|"M="
argument_list|,
literal|2
argument_list|)
operator|==
literal|0
condition|)
block|{
name|pos
operator|+=
literal|2
expr_stmt|;
name|msg
operator|=
name|pos
expr_stmt|;
block|}
name|wpa_msg
argument_list|(
name|sm
operator|->
name|msg_ctx
argument_list|,
name|MSG_WARNING
argument_list|,
literal|"EAP-MSCHAPV2: failure message: '%s' (retry %sallowed, error "
literal|"%d)"
argument_list|,
name|msg
argument_list|,
name|retry
operator|==
literal|1
condition|?
literal|""
else|:
literal|"not "
argument_list|,
name|data
operator|->
name|prev_error
argument_list|)
expr_stmt|;
if|if
condition|(
name|data
operator|->
name|prev_error
operator|==
name|ERROR_PASSWD_EXPIRED
operator|&&
name|data
operator|->
name|passwd_change_version
operator|==
literal|3
operator|&&
name|config
condition|)
block|{
if|if
condition|(
name|config
operator|->
name|new_password
operator|==
name|NULL
condition|)
block|{
name|wpa_msg
argument_list|(
name|sm
operator|->
name|msg_ctx
argument_list|,
name|MSG_INFO
argument_list|,
literal|"EAP-MSCHAPV2: Password expired - password "
literal|"change required"
argument_list|)
expr_stmt|;
name|eap_sm_request_new_password
argument_list|(
name|sm
argument_list|)
expr_stmt|;
block|}
block|}
elseif|else
if|if
condition|(
name|retry
operator|==
literal|1
operator|&&
name|config
condition|)
block|{
comment|/* TODO: could prevent the current password from being used 		 * again at least for some period of time */
if|if
condition|(
operator|!
name|config
operator|->
name|mschapv2_retry
condition|)
name|eap_sm_request_identity
argument_list|(
name|sm
argument_list|)
expr_stmt|;
name|eap_sm_request_password
argument_list|(
name|sm
argument_list|)
expr_stmt|;
name|config
operator|->
name|mschapv2_retry
operator|=
literal|1
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|config
condition|)
block|{
comment|/* TODO: prevent retries using same username/password */
name|config
operator|->
name|mschapv2_retry
operator|=
literal|0
expr_stmt|;
block|}
return|return
name|retry
operator|==
literal|1
return|;
block|}
end_function

begin_function
specifier|static
name|u8
modifier|*
name|eap_mschapv2_change_password
parameter_list|(
name|struct
name|eap_sm
modifier|*
name|sm
parameter_list|,
name|struct
name|eap_mschapv2_data
modifier|*
name|data
parameter_list|,
name|struct
name|eap_method_ret
modifier|*
name|ret
parameter_list|,
specifier|const
name|struct
name|eap_mschapv2_hdr
modifier|*
name|req
parameter_list|,
name|u8
name|id
parameter_list|,
name|size_t
modifier|*
name|respDataLen
parameter_list|)
block|{
name|struct
name|eap_hdr
modifier|*
name|resp
decl_stmt|;
name|int
name|ms_len
decl_stmt|;
specifier|const
name|u8
modifier|*
name|username
decl_stmt|,
modifier|*
name|password
decl_stmt|,
modifier|*
name|new_password
decl_stmt|;
name|u8
modifier|*
name|pos
decl_stmt|;
name|size_t
name|username_len
decl_stmt|,
name|password_len
decl_stmt|,
name|new_password_len
decl_stmt|;
name|struct
name|eap_mschapv2_hdr
modifier|*
name|ms
decl_stmt|;
name|struct
name|ms_change_password
modifier|*
name|cp
decl_stmt|;
name|username
operator|=
name|eap_get_config_identity
argument_list|(
name|sm
argument_list|,
operator|&
name|username_len
argument_list|)
expr_stmt|;
name|password
operator|=
name|eap_get_config_password
argument_list|(
name|sm
argument_list|,
operator|&
name|password_len
argument_list|)
expr_stmt|;
name|new_password
operator|=
name|eap_get_config_new_password
argument_list|(
name|sm
argument_list|,
operator|&
name|new_password_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|username
operator|==
name|NULL
operator|||
name|password
operator|==
name|NULL
operator|||
name|new_password
operator|==
name|NULL
condition|)
return|return
name|NULL
return|;
name|username
operator|=
name|eap_mschapv2_remove_domain
argument_list|(
name|username
argument_list|,
operator|&
name|username_len
argument_list|)
expr_stmt|;
name|ret
operator|->
name|ignore
operator|=
name|FALSE
expr_stmt|;
name|ret
operator|->
name|methodState
operator|=
name|METHOD_MAY_CONT
expr_stmt|;
name|ret
operator|->
name|decision
operator|=
name|DECISION_COND_SUCC
expr_stmt|;
name|ret
operator|->
name|allowNotifications
operator|=
name|TRUE
expr_stmt|;
name|ms_len
operator|=
sizeof|sizeof
argument_list|(
operator|*
name|ms
argument_list|)
operator|+
sizeof|sizeof
argument_list|(
operator|*
name|cp
argument_list|)
expr_stmt|;
name|resp
operator|=
name|eap_msg_alloc
argument_list|(
name|EAP_VENDOR_IETF
argument_list|,
name|EAP_TYPE_MSCHAPV2
argument_list|,
name|respDataLen
argument_list|,
name|ms_len
argument_list|,
name|EAP_CODE_RESPONSE
argument_list|,
name|id
argument_list|,
operator|&
name|pos
argument_list|)
expr_stmt|;
if|if
condition|(
name|resp
operator|==
name|NULL
condition|)
return|return
name|NULL
return|;
name|ms
operator|=
operator|(
expr|struct
name|eap_mschapv2_hdr
operator|*
operator|)
name|pos
expr_stmt|;
name|ms
operator|->
name|op_code
operator|=
name|MSCHAPV2_OP_CHANGE_PASSWORD
expr_stmt|;
name|ms
operator|->
name|mschapv2_id
operator|=
name|req
operator|->
name|mschapv2_id
operator|+
literal|1
expr_stmt|;
name|WPA_PUT_BE16
argument_list|(
name|ms
operator|->
name|ms_length
argument_list|,
name|ms_len
argument_list|)
expr_stmt|;
name|cp
operator|=
operator|(
expr|struct
name|ms_change_password
operator|*
operator|)
operator|(
name|ms
operator|+
literal|1
operator|)
expr_stmt|;
comment|/* Encrypted-Password */
name|new_password_encrypted_with_old_nt_password_hash
argument_list|(
name|new_password
argument_list|,
name|new_password_len
argument_list|,
name|password
argument_list|,
name|password_len
argument_list|,
name|cp
operator|->
name|encr_password
argument_list|)
expr_stmt|;
comment|/* Encrypted-Hash */
name|old_nt_password_hash_encrypted_with_new_nt_password_hash
argument_list|(
name|new_password
argument_list|,
name|new_password_len
argument_list|,
name|password
argument_list|,
name|password_len
argument_list|,
name|cp
operator|->
name|encr_hash
argument_list|)
expr_stmt|;
comment|/* Peer-Challenge */
if|if
condition|(
name|os_get_random
argument_list|(
name|cp
operator|->
name|peer_challenge
argument_list|,
name|MSCHAPV2_CHAL_LEN
argument_list|)
condition|)
block|{
name|os_free
argument_list|(
name|resp
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
comment|/* Reserved, must be zero */
name|os_memset
argument_list|(
name|cp
operator|->
name|reserved
argument_list|,
literal|0
argument_list|,
literal|8
argument_list|)
expr_stmt|;
comment|/* NT-Response */
name|wpa_hexdump
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"EAP-MSCHAPV2: auth_challenge"
argument_list|,
name|data
operator|->
name|passwd_change_challenge
argument_list|,
name|PASSWD_CHANGE_CHAL_LEN
argument_list|)
expr_stmt|;
name|wpa_hexdump
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"EAP-MSCHAPV2: peer_challenge"
argument_list|,
name|cp
operator|->
name|peer_challenge
argument_list|,
name|MSCHAPV2_CHAL_LEN
argument_list|)
expr_stmt|;
name|wpa_hexdump_ascii
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"EAP-MSCHAPV2: username"
argument_list|,
name|username
argument_list|,
name|username_len
argument_list|)
expr_stmt|;
name|wpa_hexdump_ascii_key
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"EAP-MSCHAPV2: new password"
argument_list|,
name|new_password
argument_list|,
name|new_password_len
argument_list|)
expr_stmt|;
name|generate_nt_response
argument_list|(
name|data
operator|->
name|passwd_change_challenge
argument_list|,
name|cp
operator|->
name|peer_challenge
argument_list|,
name|username
argument_list|,
name|username_len
argument_list|,
name|new_password
argument_list|,
name|new_password_len
argument_list|,
name|cp
operator|->
name|nt_response
argument_list|)
expr_stmt|;
name|wpa_hexdump
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"EAP-MSCHAPV2: NT-Response"
argument_list|,
name|cp
operator|->
name|nt_response
argument_list|,
name|MSCHAPV2_NT_RESPONSE_LEN
argument_list|)
expr_stmt|;
comment|/* Authenticator response is not really needed yet, but calculate it 	 * here so that challenges need not be saved. */
name|generate_authenticator_response
argument_list|(
name|new_password
argument_list|,
name|new_password_len
argument_list|,
name|cp
operator|->
name|peer_challenge
argument_list|,
name|data
operator|->
name|passwd_change_challenge
argument_list|,
name|username
argument_list|,
name|username_len
argument_list|,
name|cp
operator|->
name|nt_response
argument_list|,
name|data
operator|->
name|auth_response
argument_list|)
expr_stmt|;
name|data
operator|->
name|auth_response_valid
operator|=
literal|1
expr_stmt|;
comment|/* Flags */
name|os_memset
argument_list|(
name|cp
operator|->
name|flags
argument_list|,
literal|0
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"EAP-MSCHAPV2: TX identifier %d mschapv2_id %d "
literal|"(change pw)"
argument_list|,
name|resp
operator|->
name|identifier
argument_list|,
name|ms
operator|->
name|mschapv2_id
argument_list|)
expr_stmt|;
return|return
operator|(
name|u8
operator|*
operator|)
name|resp
return|;
block|}
end_function

begin_comment
comment|/**  * eap_mschapv2_process - Process an EAP-MSCHAPv2 failure message  * @sm: Pointer to EAP state machine allocated with eap_sm_init()  * @data: Pointer to private EAP method data from eap_mschapv2_init()  * @ret: Return values from EAP request validation and processing  * @req: Pointer to EAP-MSCHAPv2 header from the request  * @req_len: Length of the EAP-MSCHAPv2 data  * @id: EAP identifier used in th erequest  * @respDataLen: Length of the returned EAP response  * Returns: Pointer to allocated EAP response packet (eapRespData) or %NULL if  * no reply available  */
end_comment

begin_function
specifier|static
name|u8
modifier|*
name|eap_mschapv2_failure
parameter_list|(
name|struct
name|eap_sm
modifier|*
name|sm
parameter_list|,
name|struct
name|eap_mschapv2_data
modifier|*
name|data
parameter_list|,
name|struct
name|eap_method_ret
modifier|*
name|ret
parameter_list|,
specifier|const
name|struct
name|eap_mschapv2_hdr
modifier|*
name|req
parameter_list|,
name|size_t
name|req_len
parameter_list|,
name|u8
name|id
parameter_list|,
name|size_t
modifier|*
name|respDataLen
parameter_list|)
block|{
name|struct
name|eap_hdr
modifier|*
name|resp
decl_stmt|;
specifier|const
name|u8
modifier|*
name|msdata
init|=
operator|(
specifier|const
name|u8
operator|*
operator|)
operator|(
name|req
operator|+
literal|1
operator|)
decl_stmt|;
name|char
modifier|*
name|buf
decl_stmt|;
name|size_t
name|len
init|=
name|req_len
operator|-
sizeof|sizeof
argument_list|(
operator|*
name|req
argument_list|)
decl_stmt|;
name|int
name|retry
init|=
literal|0
decl_stmt|;
name|struct
name|eap_mschapv2_hdr
modifier|*
name|ms
decl_stmt|;
name|u8
modifier|*
name|pos
decl_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"EAP-MSCHAPV2: Received failure"
argument_list|)
expr_stmt|;
name|wpa_hexdump_ascii
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"EAP-MSCHAPV2: Failure data"
argument_list|,
name|msdata
argument_list|,
name|len
argument_list|)
expr_stmt|;
comment|/* 	 * eap_mschapv2_failure_txt() expects a nul terminated string, so we 	 * must allocate a large enough temporary buffer to create that since 	 * the received message does not include nul termination. 	 */
name|buf
operator|=
name|os_malloc
argument_list|(
name|len
operator|+
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|buf
condition|)
block|{
name|os_memcpy
argument_list|(
name|buf
argument_list|,
name|msdata
argument_list|,
name|len
argument_list|)
expr_stmt|;
name|buf
index|[
name|len
index|]
operator|=
literal|'\0'
expr_stmt|;
name|retry
operator|=
name|eap_mschapv2_failure_txt
argument_list|(
name|sm
argument_list|,
name|data
argument_list|,
name|buf
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|buf
argument_list|)
expr_stmt|;
block|}
name|ret
operator|->
name|ignore
operator|=
name|FALSE
expr_stmt|;
name|ret
operator|->
name|methodState
operator|=
name|METHOD_DONE
expr_stmt|;
name|ret
operator|->
name|decision
operator|=
name|DECISION_FAIL
expr_stmt|;
name|ret
operator|->
name|allowNotifications
operator|=
name|FALSE
expr_stmt|;
if|if
condition|(
name|data
operator|->
name|prev_error
operator|==
name|ERROR_PASSWD_EXPIRED
operator|&&
name|data
operator|->
name|passwd_change_version
operator|==
literal|3
condition|)
block|{
name|struct
name|wpa_ssid
modifier|*
name|config
init|=
name|eap_get_config
argument_list|(
name|sm
argument_list|)
decl_stmt|;
if|if
condition|(
name|config
operator|&&
name|config
operator|->
name|new_password
condition|)
return|return
name|eap_mschapv2_change_password
argument_list|(
name|sm
argument_list|,
name|data
argument_list|,
name|ret
argument_list|,
name|req
argument_list|,
name|id
argument_list|,
name|respDataLen
argument_list|)
return|;
if|if
condition|(
name|config
operator|&&
name|config
operator|->
name|pending_req_new_password
condition|)
return|return
name|NULL
return|;
block|}
elseif|else
if|if
condition|(
name|retry
operator|&&
name|data
operator|->
name|prev_error
operator|==
name|ERROR_AUTHENTICATION_FAILURE
condition|)
block|{
comment|/* TODO: could try to retry authentication, e.g, after having 		 * changed the username/password. In this case, EAP MS-CHAP-v2 		 * Failure Response would not be sent here. */
return|return
name|NULL
return|;
block|}
comment|/* Note: Only op_code of the EAP-MSCHAPV2 header is included in failure 	 * message. */
name|resp
operator|=
name|eap_msg_alloc
argument_list|(
name|EAP_VENDOR_IETF
argument_list|,
name|EAP_TYPE_MSCHAPV2
argument_list|,
name|respDataLen
argument_list|,
literal|1
argument_list|,
name|EAP_CODE_RESPONSE
argument_list|,
name|id
argument_list|,
operator|&
name|pos
argument_list|)
expr_stmt|;
if|if
condition|(
name|resp
operator|==
name|NULL
condition|)
return|return
name|NULL
return|;
name|ms
operator|=
operator|(
expr|struct
name|eap_mschapv2_hdr
operator|*
operator|)
name|pos
expr_stmt|;
name|ms
operator|->
name|op_code
operator|=
name|MSCHAPV2_OP_FAILURE
expr_stmt|;
return|return
operator|(
name|u8
operator|*
operator|)
name|resp
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|eap_mschapv2_check_config
parameter_list|(
name|struct
name|eap_sm
modifier|*
name|sm
parameter_list|)
block|{
name|size_t
name|len
decl_stmt|;
if|if
condition|(
name|eap_get_config_identity
argument_list|(
name|sm
argument_list|,
operator|&
name|len
argument_list|)
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"EAP-MSCHAPV2: Identity not configured"
argument_list|)
expr_stmt|;
name|eap_sm_request_identity
argument_list|(
name|sm
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
if|if
condition|(
name|eap_get_config_password
argument_list|(
name|sm
argument_list|,
operator|&
name|len
argument_list|)
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"EAP-MSCHAPV2: Password not configured"
argument_list|)
expr_stmt|;
name|eap_sm_request_password
argument_list|(
name|sm
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|eap_mschapv2_check_mslen
parameter_list|(
name|struct
name|eap_sm
modifier|*
name|sm
parameter_list|,
name|size_t
name|len
parameter_list|,
specifier|const
name|struct
name|eap_mschapv2_hdr
modifier|*
name|ms
parameter_list|)
block|{
name|size_t
name|ms_len
init|=
name|WPA_GET_BE16
argument_list|(
name|ms
operator|->
name|ms_length
argument_list|)
decl_stmt|;
if|if
condition|(
name|ms_len
operator|==
name|len
condition|)
return|return
literal|0
return|;
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"EAP-MSCHAPV2: Invalid header: len=%lu "
literal|"ms_len=%lu"
argument_list|,
operator|(
name|unsigned
name|long
operator|)
name|len
argument_list|,
operator|(
name|unsigned
name|long
operator|)
name|ms_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|sm
operator|->
name|workaround
condition|)
block|{
comment|/* Some authentication servers use invalid ms_len, 		 * ignore it for interoperability. */
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"EAP-MSCHAPV2: workaround, ignore"
literal|" invalid ms_len %lu (len %lu)"
argument_list|,
operator|(
name|unsigned
name|long
operator|)
name|ms_len
argument_list|,
operator|(
name|unsigned
name|long
operator|)
name|len
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
return|return
operator|-
literal|1
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|eap_mschapv2_copy_challenge
parameter_list|(
name|struct
name|eap_mschapv2_data
modifier|*
name|data
parameter_list|,
specifier|const
name|u8
modifier|*
name|reqData
parameter_list|,
name|size_t
name|reqDataLen
parameter_list|)
block|{
comment|/* 	 * Store a copy of the challenge message, so that it can be processed 	 * again in case retry is allowed after a possible failure. 	 */
name|os_free
argument_list|(
name|data
operator|->
name|prev_challenge
argument_list|)
expr_stmt|;
name|data
operator|->
name|prev_challenge
operator|=
name|os_malloc
argument_list|(
name|reqDataLen
argument_list|)
expr_stmt|;
if|if
condition|(
name|data
operator|->
name|prev_challenge
condition|)
block|{
name|data
operator|->
name|prev_challenge_len
operator|=
name|reqDataLen
expr_stmt|;
name|os_memcpy
argument_list|(
name|data
operator|->
name|prev_challenge
argument_list|,
name|reqData
argument_list|,
name|reqDataLen
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/**  * eap_mschapv2_process - Process an EAP-MSCHAPv2 request  * @sm: Pointer to EAP state machine allocated with eap_sm_init()  * @priv: Pointer to private EAP method data from eap_mschapv2_init()  * @ret: Return values from EAP request validation and processing  * @reqData: EAP request to be processed (eapReqData)  * @reqDataLen: Length of the EAP request  * @respDataLen: Length of the returned EAP response  * Returns: Pointer to allocated EAP response packet (eapRespData) or %NULL if  * no reply available  */
end_comment

begin_function
specifier|static
name|u8
modifier|*
name|eap_mschapv2_process
parameter_list|(
name|struct
name|eap_sm
modifier|*
name|sm
parameter_list|,
name|void
modifier|*
name|priv
parameter_list|,
name|struct
name|eap_method_ret
modifier|*
name|ret
parameter_list|,
specifier|const
name|u8
modifier|*
name|reqData
parameter_list|,
name|size_t
name|reqDataLen
parameter_list|,
name|size_t
modifier|*
name|respDataLen
parameter_list|)
block|{
name|struct
name|eap_mschapv2_data
modifier|*
name|data
init|=
name|priv
decl_stmt|;
name|struct
name|wpa_ssid
modifier|*
name|config
init|=
name|eap_get_config
argument_list|(
name|sm
argument_list|)
decl_stmt|;
specifier|const
name|struct
name|eap_hdr
modifier|*
name|req
decl_stmt|;
specifier|const
name|struct
name|eap_mschapv2_hdr
modifier|*
name|ms
decl_stmt|;
name|int
name|using_prev_challenge
init|=
literal|0
decl_stmt|;
specifier|const
name|u8
modifier|*
name|pos
decl_stmt|;
name|size_t
name|len
decl_stmt|;
if|if
condition|(
name|eap_mschapv2_check_config
argument_list|(
name|sm
argument_list|)
condition|)
block|{
name|ret
operator|->
name|ignore
operator|=
name|TRUE
expr_stmt|;
return|return
name|NULL
return|;
block|}
if|if
condition|(
name|config
operator|->
name|mschapv2_retry
operator|&&
name|data
operator|->
name|prev_challenge
operator|&&
name|data
operator|->
name|prev_error
operator|==
name|ERROR_AUTHENTICATION_FAILURE
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"EAP-MSCHAPV2: Replacing pending packet "
literal|"with the previous challenge"
argument_list|)
expr_stmt|;
name|reqData
operator|=
name|data
operator|->
name|prev_challenge
expr_stmt|;
name|reqDataLen
operator|=
name|data
operator|->
name|prev_challenge_len
expr_stmt|;
name|using_prev_challenge
operator|=
literal|1
expr_stmt|;
name|config
operator|->
name|mschapv2_retry
operator|=
literal|0
expr_stmt|;
block|}
name|pos
operator|=
name|eap_hdr_validate
argument_list|(
name|EAP_VENDOR_IETF
argument_list|,
name|EAP_TYPE_MSCHAPV2
argument_list|,
name|reqData
argument_list|,
name|reqDataLen
argument_list|,
operator|&
name|len
argument_list|)
expr_stmt|;
if|if
condition|(
name|pos
operator|==
name|NULL
operator|||
name|len
operator|<
sizeof|sizeof
argument_list|(
operator|*
name|ms
argument_list|)
operator|+
literal|1
condition|)
block|{
name|ret
operator|->
name|ignore
operator|=
name|TRUE
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|ms
operator|=
operator|(
specifier|const
expr|struct
name|eap_mschapv2_hdr
operator|*
operator|)
name|pos
expr_stmt|;
if|if
condition|(
name|eap_mschapv2_check_mslen
argument_list|(
name|sm
argument_list|,
name|len
argument_list|,
name|ms
argument_list|)
condition|)
block|{
name|ret
operator|->
name|ignore
operator|=
name|TRUE
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|req
operator|=
operator|(
specifier|const
expr|struct
name|eap_hdr
operator|*
operator|)
name|reqData
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"EAP-MSCHAPV2: RX identifier %d mschapv2_id %d"
argument_list|,
name|req
operator|->
name|identifier
argument_list|,
name|ms
operator|->
name|mschapv2_id
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|ms
operator|->
name|op_code
condition|)
block|{
case|case
name|MSCHAPV2_OP_CHALLENGE
case|:
if|if
condition|(
operator|!
name|using_prev_challenge
condition|)
name|eap_mschapv2_copy_challenge
argument_list|(
name|data
argument_list|,
name|reqData
argument_list|,
name|reqDataLen
argument_list|)
expr_stmt|;
return|return
name|eap_mschapv2_challenge
argument_list|(
name|sm
argument_list|,
name|data
argument_list|,
name|ret
argument_list|,
name|ms
argument_list|,
name|len
argument_list|,
name|req
operator|->
name|identifier
argument_list|,
name|respDataLen
argument_list|)
return|;
case|case
name|MSCHAPV2_OP_SUCCESS
case|:
return|return
name|eap_mschapv2_success
argument_list|(
name|sm
argument_list|,
name|data
argument_list|,
name|ret
argument_list|,
name|ms
argument_list|,
name|len
argument_list|,
name|req
operator|->
name|identifier
argument_list|,
name|respDataLen
argument_list|)
return|;
case|case
name|MSCHAPV2_OP_FAILURE
case|:
return|return
name|eap_mschapv2_failure
argument_list|(
name|sm
argument_list|,
name|data
argument_list|,
name|ret
argument_list|,
name|ms
argument_list|,
name|len
argument_list|,
name|req
operator|->
name|identifier
argument_list|,
name|respDataLen
argument_list|)
return|;
default|default:
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"EAP-MSCHAPV2: Unknown op %d - ignored"
argument_list|,
name|ms
operator|->
name|op_code
argument_list|)
expr_stmt|;
name|ret
operator|->
name|ignore
operator|=
name|TRUE
expr_stmt|;
return|return
name|NULL
return|;
block|}
block|}
end_function

begin_function
specifier|static
name|Boolean
name|eap_mschapv2_isKeyAvailable
parameter_list|(
name|struct
name|eap_sm
modifier|*
name|sm
parameter_list|,
name|void
modifier|*
name|priv
parameter_list|)
block|{
name|struct
name|eap_mschapv2_data
modifier|*
name|data
init|=
name|priv
decl_stmt|;
return|return
name|data
operator|->
name|success
operator|&&
name|data
operator|->
name|master_key_valid
return|;
block|}
end_function

begin_function
specifier|static
name|u8
modifier|*
name|eap_mschapv2_getKey
parameter_list|(
name|struct
name|eap_sm
modifier|*
name|sm
parameter_list|,
name|void
modifier|*
name|priv
parameter_list|,
name|size_t
modifier|*
name|len
parameter_list|)
block|{
name|struct
name|eap_mschapv2_data
modifier|*
name|data
init|=
name|priv
decl_stmt|;
name|u8
modifier|*
name|key
decl_stmt|;
name|int
name|key_len
decl_stmt|;
if|if
condition|(
operator|!
name|data
operator|->
name|master_key_valid
operator|||
operator|!
name|data
operator|->
name|success
condition|)
return|return
name|NULL
return|;
if|if
condition|(
name|data
operator|->
name|full_key
condition|)
block|{
comment|/* EAP-FAST needs both send and receive keys */
name|key_len
operator|=
literal|2
operator|*
name|MSCHAPV2_KEY_LEN
expr_stmt|;
block|}
else|else
block|{
name|key_len
operator|=
name|MSCHAPV2_KEY_LEN
expr_stmt|;
block|}
name|key
operator|=
name|os_malloc
argument_list|(
name|key_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|key
operator|==
name|NULL
condition|)
return|return
name|NULL
return|;
if|if
condition|(
name|data
operator|->
name|full_key
condition|)
block|{
name|get_asymetric_start_key
argument_list|(
name|data
operator|->
name|master_key
argument_list|,
name|key
argument_list|,
name|MSCHAPV2_KEY_LEN
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|get_asymetric_start_key
argument_list|(
name|data
operator|->
name|master_key
argument_list|,
name|key
operator|+
name|MSCHAPV2_KEY_LEN
argument_list|,
name|MSCHAPV2_KEY_LEN
argument_list|,
literal|1
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|get_asymetric_start_key
argument_list|(
name|data
operator|->
name|master_key
argument_list|,
name|key
argument_list|,
name|MSCHAPV2_KEY_LEN
argument_list|,
literal|1
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
name|wpa_hexdump_key
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"EAP-MSCHAPV2: Derived key"
argument_list|,
name|key
argument_list|,
name|key_len
argument_list|)
expr_stmt|;
operator|*
name|len
operator|=
name|key_len
expr_stmt|;
return|return
name|key
return|;
block|}
end_function

begin_comment
comment|/**  * eap_peer_mschapv2_register - Register EAP-MSCHAPv2 peer method  * Returns: 0 on success, -1 on failure  *  * This function is used to register EAP-MSCHAPv2 peer method into the EAP  * method list.  */
end_comment

begin_function
name|int
name|eap_peer_mschapv2_register
parameter_list|(
name|void
parameter_list|)
block|{
name|struct
name|eap_method
modifier|*
name|eap
decl_stmt|;
name|int
name|ret
decl_stmt|;
name|eap
operator|=
name|eap_peer_method_alloc
argument_list|(
name|EAP_PEER_METHOD_INTERFACE_VERSION
argument_list|,
name|EAP_VENDOR_IETF
argument_list|,
name|EAP_TYPE_MSCHAPV2
argument_list|,
literal|"MSCHAPV2"
argument_list|)
expr_stmt|;
if|if
condition|(
name|eap
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
name|eap
operator|->
name|init
operator|=
name|eap_mschapv2_init
expr_stmt|;
name|eap
operator|->
name|deinit
operator|=
name|eap_mschapv2_deinit
expr_stmt|;
name|eap
operator|->
name|process
operator|=
name|eap_mschapv2_process
expr_stmt|;
name|eap
operator|->
name|isKeyAvailable
operator|=
name|eap_mschapv2_isKeyAvailable
expr_stmt|;
name|eap
operator|->
name|getKey
operator|=
name|eap_mschapv2_getKey
expr_stmt|;
name|ret
operator|=
name|eap_peer_method_register
argument_list|(
name|eap
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
name|eap_peer_method_free
argument_list|(
name|eap
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

end_unit


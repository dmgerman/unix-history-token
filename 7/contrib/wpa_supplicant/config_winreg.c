begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * WPA Supplicant / Configuration backend: Windows registry  * Copyright (c) 2003-2006, Jouni Malinen<j@w1.fi>  *  * This program is free software; you can redistribute it and/or modify  * it under the terms of the GNU General Public License version 2 as  * published by the Free Software Foundation.  *  * Alternatively, this software may be distributed under the terms of BSD  * license.  *  * See README and COPYING for more details.  *  * This file implements a configuration backend for Windows registry.. All the  * configuration information is stored in the registry and the format for  * network configuration fields is same as described in the sample  * configuration file, wpa_supplicant.conf.  *  * Configuration data is in HKEY_LOCAL_MACHINE\SOFTWARE\wpa_supplicant\configs  * key. Each configuration profile has its own key under this. In terms of text  * files, each profile would map to a separate text file with possibly multiple  * networks. Under each profile, there is a networks key that lists all  * networks as a subkey. Each network has set of values in the same way as  * network block in the configuration file. In addition, blobs subkey has  * possible blobs as values.  *  * HKEY_LOCAL_MACHINE\SOFTWARE\wpa_supplicant\configs\test\networks\0000  *    ssid="example"  *    key_mgmt=WPA-PSK  */
end_comment

begin_include
include|#
directive|include
file|"includes.h"
end_include

begin_include
include|#
directive|include
file|"common.h"
end_include

begin_include
include|#
directive|include
file|"config.h"
end_include

begin_ifndef
ifndef|#
directive|ifndef
name|WPA_KEY_ROOT
end_ifndef

begin_define
define|#
directive|define
name|WPA_KEY_ROOT
value|HKEY_LOCAL_MACHINE
end_define

begin_endif
endif|#
directive|endif
end_endif

begin_ifndef
ifndef|#
directive|ifndef
name|WPA_KEY_PREFIX
end_ifndef

begin_define
define|#
directive|define
name|WPA_KEY_PREFIX
value|TEXT("SOFTWARE\\wpa_supplicant")
end_define

begin_endif
endif|#
directive|endif
end_endif

begin_ifdef
ifdef|#
directive|ifdef
name|UNICODE
end_ifdef

begin_define
define|#
directive|define
name|TSTR
value|"%S"
end_define

begin_else
else|#
directive|else
end_else

begin_comment
comment|/* UNICODE */
end_comment

begin_define
define|#
directive|define
name|TSTR
value|"%s"
end_define

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* UNICODE */
end_comment

begin_function
specifier|static
name|int
name|wpa_config_read_blobs
parameter_list|(
name|struct
name|wpa_config
modifier|*
name|config
parameter_list|,
name|HKEY
name|hk
parameter_list|)
block|{
name|struct
name|wpa_config_blob
modifier|*
name|blob
decl_stmt|;
name|int
name|errors
init|=
literal|0
decl_stmt|;
name|HKEY
name|bhk
decl_stmt|;
name|LONG
name|ret
decl_stmt|;
name|DWORD
name|i
decl_stmt|;
name|ret
operator|=
name|RegOpenKeyEx
argument_list|(
name|hk
argument_list|,
name|TEXT
argument_list|(
literal|"blobs"
argument_list|)
argument_list|,
literal|0
argument_list|,
name|KEY_QUERY_VALUE
argument_list|,
operator|&
name|bhk
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|!=
name|ERROR_SUCCESS
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"Could not open wpa_supplicant config "
literal|"blobs key"
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
comment|/* assume no blobs */
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
condition|;
name|i
operator|++
control|)
block|{
define|#
directive|define
name|TNAMELEN
value|255
name|TCHAR
name|name
index|[
name|TNAMELEN
index|]
decl_stmt|;
name|char
name|data
index|[
literal|4096
index|]
decl_stmt|;
name|DWORD
name|namelen
decl_stmt|,
name|datalen
decl_stmt|,
name|type
decl_stmt|;
name|namelen
operator|=
name|TNAMELEN
expr_stmt|;
name|datalen
operator|=
sizeof|sizeof
argument_list|(
name|data
argument_list|)
expr_stmt|;
name|ret
operator|=
name|RegEnumValue
argument_list|(
name|bhk
argument_list|,
name|i
argument_list|,
name|name
argument_list|,
operator|&
name|namelen
argument_list|,
name|NULL
argument_list|,
operator|&
name|type
argument_list|,
operator|(
name|LPBYTE
operator|)
name|data
argument_list|,
operator|&
name|datalen
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|==
name|ERROR_NO_MORE_ITEMS
condition|)
break|break;
if|if
condition|(
name|ret
operator|!=
name|ERROR_SUCCESS
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"RegEnumValue failed: 0x%x"
argument_list|,
operator|(
name|unsigned
name|int
operator|)
name|ret
argument_list|)
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|namelen
operator|>=
name|TNAMELEN
condition|)
name|namelen
operator|=
name|TNAMELEN
operator|-
literal|1
expr_stmt|;
name|name
index|[
name|namelen
index|]
operator|=
name|TEXT
argument_list|(
literal|'\0'
argument_list|)
expr_stmt|;
name|wpa_unicode2ascii_inplace
argument_list|(
name|name
argument_list|)
expr_stmt|;
if|if
condition|(
name|datalen
operator|>=
sizeof|sizeof
argument_list|(
name|data
argument_list|)
condition|)
name|datalen
operator|=
sizeof|sizeof
argument_list|(
name|data
argument_list|)
operator|-
literal|1
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_MSGDUMP
argument_list|,
literal|"blob %d: field='%s' len %d"
argument_list|,
operator|(
name|int
operator|)
name|i
argument_list|,
name|name
argument_list|,
operator|(
name|int
operator|)
name|datalen
argument_list|)
expr_stmt|;
name|blob
operator|=
name|os_zalloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|blob
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|blob
operator|==
name|NULL
condition|)
block|{
name|errors
operator|++
expr_stmt|;
break|break;
block|}
name|blob
operator|->
name|name
operator|=
name|os_strdup
argument_list|(
operator|(
name|char
operator|*
operator|)
name|name
argument_list|)
expr_stmt|;
name|blob
operator|->
name|data
operator|=
name|os_malloc
argument_list|(
name|datalen
argument_list|)
expr_stmt|;
if|if
condition|(
name|blob
operator|->
name|name
operator|==
name|NULL
operator|||
name|blob
operator|->
name|data
operator|==
name|NULL
condition|)
block|{
name|wpa_config_free_blob
argument_list|(
name|blob
argument_list|)
expr_stmt|;
name|errors
operator|++
expr_stmt|;
break|break;
block|}
name|os_memcpy
argument_list|(
name|blob
operator|->
name|data
argument_list|,
name|data
argument_list|,
name|datalen
argument_list|)
expr_stmt|;
name|blob
operator|->
name|len
operator|=
name|datalen
expr_stmt|;
name|wpa_config_set_blob
argument_list|(
name|config
argument_list|,
name|blob
argument_list|)
expr_stmt|;
block|}
name|RegCloseKey
argument_list|(
name|bhk
argument_list|)
expr_stmt|;
return|return
name|errors
condition|?
operator|-
literal|1
else|:
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|wpa_config_read_reg_dword
parameter_list|(
name|HKEY
name|hk
parameter_list|,
specifier|const
name|TCHAR
modifier|*
name|name
parameter_list|,
name|int
modifier|*
name|_val
parameter_list|)
block|{
name|DWORD
name|val
decl_stmt|,
name|buflen
decl_stmt|;
name|LONG
name|ret
decl_stmt|;
name|buflen
operator|=
sizeof|sizeof
argument_list|(
name|val
argument_list|)
expr_stmt|;
name|ret
operator|=
name|RegQueryValueEx
argument_list|(
name|hk
argument_list|,
name|name
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
operator|(
name|LPBYTE
operator|)
operator|&
name|val
argument_list|,
operator|&
name|buflen
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|==
name|ERROR_SUCCESS
operator|&&
name|buflen
operator|==
sizeof|sizeof
argument_list|(
name|val
argument_list|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
name|TSTR
literal|"=%d"
argument_list|,
name|name
argument_list|,
operator|(
name|int
operator|)
name|val
argument_list|)
expr_stmt|;
operator|*
name|_val
operator|=
name|val
expr_stmt|;
return|return
literal|0
return|;
block|}
return|return
operator|-
literal|1
return|;
block|}
end_function

begin_function
specifier|static
name|char
modifier|*
name|wpa_config_read_reg_string
parameter_list|(
name|HKEY
name|hk
parameter_list|,
specifier|const
name|TCHAR
modifier|*
name|name
parameter_list|)
block|{
name|DWORD
name|buflen
decl_stmt|;
name|LONG
name|ret
decl_stmt|;
name|TCHAR
modifier|*
name|val
decl_stmt|;
name|buflen
operator|=
literal|0
expr_stmt|;
name|ret
operator|=
name|RegQueryValueEx
argument_list|(
name|hk
argument_list|,
name|name
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
operator|&
name|buflen
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|!=
name|ERROR_SUCCESS
condition|)
return|return
name|NULL
return|;
name|val
operator|=
name|os_malloc
argument_list|(
name|buflen
argument_list|)
expr_stmt|;
if|if
condition|(
name|val
operator|==
name|NULL
condition|)
return|return
name|NULL
return|;
name|ret
operator|=
name|RegQueryValueEx
argument_list|(
name|hk
argument_list|,
name|name
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
operator|(
name|LPBYTE
operator|)
name|val
argument_list|,
operator|&
name|buflen
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|!=
name|ERROR_SUCCESS
condition|)
block|{
name|os_free
argument_list|(
name|val
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|wpa_unicode2ascii_inplace
argument_list|(
name|val
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
name|TSTR
literal|"=%s"
argument_list|,
name|name
argument_list|,
operator|(
name|char
operator|*
operator|)
name|val
argument_list|)
expr_stmt|;
return|return
operator|(
name|char
operator|*
operator|)
name|val
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|wpa_config_read_global
parameter_list|(
name|struct
name|wpa_config
modifier|*
name|config
parameter_list|,
name|HKEY
name|hk
parameter_list|)
block|{
name|int
name|errors
init|=
literal|0
decl_stmt|;
name|wpa_config_read_reg_dword
argument_list|(
name|hk
argument_list|,
name|TEXT
argument_list|(
literal|"ap_scan"
argument_list|)
argument_list|,
operator|&
name|config
operator|->
name|ap_scan
argument_list|)
expr_stmt|;
name|wpa_config_read_reg_dword
argument_list|(
name|hk
argument_list|,
name|TEXT
argument_list|(
literal|"fast_reauth"
argument_list|)
argument_list|,
operator|&
name|config
operator|->
name|fast_reauth
argument_list|)
expr_stmt|;
name|wpa_config_read_reg_dword
argument_list|(
name|hk
argument_list|,
name|TEXT
argument_list|(
literal|"dot11RSNAConfigPMKLifetime"
argument_list|)
argument_list|,
operator|&
name|config
operator|->
name|dot11RSNAConfigPMKLifetime
argument_list|)
expr_stmt|;
name|wpa_config_read_reg_dword
argument_list|(
name|hk
argument_list|,
name|TEXT
argument_list|(
literal|"dot11RSNAConfigPMKReauthThreshold"
argument_list|)
argument_list|,
operator|&
name|config
operator|->
name|dot11RSNAConfigPMKReauthThreshold
argument_list|)
expr_stmt|;
name|wpa_config_read_reg_dword
argument_list|(
name|hk
argument_list|,
name|TEXT
argument_list|(
literal|"dot11RSNAConfigSATimeout"
argument_list|)
argument_list|,
operator|&
name|config
operator|->
name|dot11RSNAConfigSATimeout
argument_list|)
expr_stmt|;
name|wpa_config_read_reg_dword
argument_list|(
name|hk
argument_list|,
name|TEXT
argument_list|(
literal|"update_config"
argument_list|)
argument_list|,
operator|&
name|config
operator|->
name|update_config
argument_list|)
expr_stmt|;
if|if
condition|(
name|wpa_config_read_reg_dword
argument_list|(
name|hk
argument_list|,
name|TEXT
argument_list|(
literal|"eapol_version"
argument_list|)
argument_list|,
operator|&
name|config
operator|->
name|eapol_version
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|config
operator|->
name|eapol_version
operator|<
literal|1
operator|||
name|config
operator|->
name|eapol_version
operator|>
literal|2
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"Invalid EAPOL version (%d)"
argument_list|,
name|config
operator|->
name|eapol_version
argument_list|)
expr_stmt|;
name|errors
operator|++
expr_stmt|;
block|}
block|}
name|config
operator|->
name|ctrl_interface
operator|=
name|wpa_config_read_reg_string
argument_list|(
name|hk
argument_list|,
name|TEXT
argument_list|(
literal|"ctrl_interface"
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|errors
condition|?
operator|-
literal|1
else|:
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|struct
name|wpa_ssid
modifier|*
name|wpa_config_read_network
parameter_list|(
name|HKEY
name|hk
parameter_list|,
specifier|const
name|TCHAR
modifier|*
name|netw
parameter_list|,
name|int
name|id
parameter_list|)
block|{
name|HKEY
name|nhk
decl_stmt|;
name|LONG
name|ret
decl_stmt|;
name|DWORD
name|i
decl_stmt|;
name|struct
name|wpa_ssid
modifier|*
name|ssid
decl_stmt|;
name|int
name|errors
init|=
literal|0
decl_stmt|;
name|ret
operator|=
name|RegOpenKeyEx
argument_list|(
name|hk
argument_list|,
name|netw
argument_list|,
literal|0
argument_list|,
name|KEY_QUERY_VALUE
argument_list|,
operator|&
name|nhk
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|!=
name|ERROR_SUCCESS
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"Could not open wpa_supplicant config "
literal|"network '"
name|TSTR
literal|"'"
argument_list|,
name|netw
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|wpa_printf
argument_list|(
name|MSG_MSGDUMP
argument_list|,
literal|"Start of a new network '"
name|TSTR
literal|"'"
argument_list|,
name|netw
argument_list|)
expr_stmt|;
name|ssid
operator|=
name|os_zalloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|ssid
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|ssid
operator|==
name|NULL
condition|)
block|{
name|RegCloseKey
argument_list|(
name|nhk
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|ssid
operator|->
name|id
operator|=
name|id
expr_stmt|;
name|wpa_config_set_network_defaults
argument_list|(
name|ssid
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
condition|;
name|i
operator|++
control|)
block|{
name|TCHAR
name|name
index|[
literal|255
index|]
decl_stmt|,
name|data
index|[
literal|1024
index|]
decl_stmt|;
name|DWORD
name|namelen
decl_stmt|,
name|datalen
decl_stmt|,
name|type
decl_stmt|;
name|namelen
operator|=
literal|255
expr_stmt|;
name|datalen
operator|=
sizeof|sizeof
argument_list|(
name|data
argument_list|)
expr_stmt|;
name|ret
operator|=
name|RegEnumValue
argument_list|(
name|nhk
argument_list|,
name|i
argument_list|,
name|name
argument_list|,
operator|&
name|namelen
argument_list|,
name|NULL
argument_list|,
operator|&
name|type
argument_list|,
operator|(
name|LPBYTE
operator|)
name|data
argument_list|,
operator|&
name|datalen
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|==
name|ERROR_NO_MORE_ITEMS
condition|)
break|break;
if|if
condition|(
name|ret
operator|!=
name|ERROR_SUCCESS
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"RegEnumValue failed: 0x%x"
argument_list|,
operator|(
name|unsigned
name|int
operator|)
name|ret
argument_list|)
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|namelen
operator|>=
literal|255
condition|)
name|namelen
operator|=
literal|255
operator|-
literal|1
expr_stmt|;
name|name
index|[
name|namelen
index|]
operator|=
name|TEXT
argument_list|(
literal|'\0'
argument_list|)
expr_stmt|;
if|if
condition|(
name|datalen
operator|>=
literal|1024
condition|)
name|datalen
operator|=
literal|1024
operator|-
literal|1
expr_stmt|;
name|data
index|[
name|datalen
index|]
operator|=
name|TEXT
argument_list|(
literal|'\0'
argument_list|)
expr_stmt|;
name|wpa_unicode2ascii_inplace
argument_list|(
name|name
argument_list|)
expr_stmt|;
name|wpa_unicode2ascii_inplace
argument_list|(
name|data
argument_list|)
expr_stmt|;
if|if
condition|(
name|wpa_config_set
argument_list|(
name|ssid
argument_list|,
operator|(
name|char
operator|*
operator|)
name|name
argument_list|,
operator|(
name|char
operator|*
operator|)
name|data
argument_list|,
literal|0
argument_list|)
operator|<
literal|0
condition|)
name|errors
operator|++
expr_stmt|;
block|}
name|RegCloseKey
argument_list|(
name|nhk
argument_list|)
expr_stmt|;
if|if
condition|(
name|ssid
operator|->
name|passphrase
condition|)
block|{
if|if
condition|(
name|ssid
operator|->
name|psk_set
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"Both PSK and passphrase "
literal|"configured for network '"
name|TSTR
literal|"'."
argument_list|,
name|netw
argument_list|)
expr_stmt|;
name|errors
operator|++
expr_stmt|;
block|}
name|wpa_config_update_psk
argument_list|(
name|ssid
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|ssid
operator|->
name|key_mgmt
operator|&
name|WPA_KEY_MGMT_PSK
operator|)
operator|&&
operator|!
name|ssid
operator|->
name|psk_set
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"WPA-PSK accepted for key management, "
literal|"but no PSK configured for network '"
name|TSTR
literal|"'."
argument_list|,
name|netw
argument_list|)
expr_stmt|;
name|errors
operator|++
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|ssid
operator|->
name|group_cipher
operator|&
name|WPA_CIPHER_CCMP
operator|)
operator|&&
operator|!
operator|(
name|ssid
operator|->
name|pairwise_cipher
operator|&
name|WPA_CIPHER_CCMP
operator|)
operator|&&
operator|!
operator|(
name|ssid
operator|->
name|pairwise_cipher
operator|&
name|WPA_CIPHER_NONE
operator|)
condition|)
block|{
comment|/* Group cipher cannot be stronger than the pairwise cipher. */
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"Removed CCMP from group cipher "
literal|"list since it was not allowed for pairwise "
literal|"cipher for network '"
name|TSTR
literal|"'."
argument_list|,
name|netw
argument_list|)
expr_stmt|;
name|ssid
operator|->
name|group_cipher
operator|&=
operator|~
name|WPA_CIPHER_CCMP
expr_stmt|;
block|}
if|if
condition|(
name|errors
condition|)
block|{
name|wpa_config_free_ssid
argument_list|(
name|ssid
argument_list|)
expr_stmt|;
name|ssid
operator|=
name|NULL
expr_stmt|;
block|}
return|return
name|ssid
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|wpa_config_read_networks
parameter_list|(
name|struct
name|wpa_config
modifier|*
name|config
parameter_list|,
name|HKEY
name|hk
parameter_list|)
block|{
name|HKEY
name|nhk
decl_stmt|;
name|struct
name|wpa_ssid
modifier|*
name|ssid
decl_stmt|,
modifier|*
name|tail
init|=
name|NULL
decl_stmt|,
modifier|*
name|head
init|=
name|NULL
decl_stmt|;
name|int
name|errors
init|=
literal|0
decl_stmt|;
name|LONG
name|ret
decl_stmt|;
name|DWORD
name|i
decl_stmt|;
name|ret
operator|=
name|RegOpenKeyEx
argument_list|(
name|hk
argument_list|,
name|TEXT
argument_list|(
literal|"networks"
argument_list|)
argument_list|,
literal|0
argument_list|,
name|KEY_ENUMERATE_SUB_KEYS
argument_list|,
operator|&
name|nhk
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|!=
name|ERROR_SUCCESS
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"Could not open wpa_supplicant networks "
literal|"registry key"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
condition|;
name|i
operator|++
control|)
block|{
name|TCHAR
name|name
index|[
literal|255
index|]
decl_stmt|;
name|DWORD
name|namelen
decl_stmt|;
name|namelen
operator|=
literal|255
expr_stmt|;
name|ret
operator|=
name|RegEnumKeyEx
argument_list|(
name|nhk
argument_list|,
name|i
argument_list|,
name|name
argument_list|,
operator|&
name|namelen
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|==
name|ERROR_NO_MORE_ITEMS
condition|)
break|break;
if|if
condition|(
name|ret
operator|!=
name|ERROR_SUCCESS
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"RegEnumKeyEx failed: 0x%x"
argument_list|,
operator|(
name|unsigned
name|int
operator|)
name|ret
argument_list|)
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|namelen
operator|>=
literal|255
condition|)
name|namelen
operator|=
literal|255
operator|-
literal|1
expr_stmt|;
name|name
index|[
name|namelen
index|]
operator|=
literal|'\0'
expr_stmt|;
name|ssid
operator|=
name|wpa_config_read_network
argument_list|(
name|nhk
argument_list|,
name|name
argument_list|,
name|i
argument_list|)
expr_stmt|;
if|if
condition|(
name|ssid
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"Failed to parse network "
literal|"profile '%s'."
argument_list|,
name|name
argument_list|)
expr_stmt|;
name|errors
operator|++
expr_stmt|;
continue|continue;
block|}
if|if
condition|(
name|head
operator|==
name|NULL
condition|)
block|{
name|head
operator|=
name|tail
operator|=
name|ssid
expr_stmt|;
block|}
else|else
block|{
name|tail
operator|->
name|next
operator|=
name|ssid
expr_stmt|;
name|tail
operator|=
name|ssid
expr_stmt|;
block|}
if|if
condition|(
name|wpa_config_add_prio_network
argument_list|(
name|config
argument_list|,
name|ssid
argument_list|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"Failed to add network profile "
literal|"'%s' to priority list."
argument_list|,
name|name
argument_list|)
expr_stmt|;
name|errors
operator|++
expr_stmt|;
continue|continue;
block|}
block|}
name|RegCloseKey
argument_list|(
name|nhk
argument_list|)
expr_stmt|;
name|config
operator|->
name|ssid
operator|=
name|head
expr_stmt|;
return|return
name|errors
condition|?
operator|-
literal|1
else|:
literal|0
return|;
block|}
end_function

begin_function
name|struct
name|wpa_config
modifier|*
name|wpa_config_read
parameter_list|(
specifier|const
name|char
modifier|*
name|name
parameter_list|)
block|{
name|TCHAR
name|buf
index|[
literal|256
index|]
decl_stmt|;
name|int
name|errors
init|=
literal|0
decl_stmt|;
name|struct
name|wpa_config
modifier|*
name|config
decl_stmt|;
name|HKEY
name|hk
decl_stmt|;
name|LONG
name|ret
decl_stmt|;
name|config
operator|=
name|wpa_config_alloc_empty
argument_list|(
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|config
operator|==
name|NULL
condition|)
return|return
name|NULL
return|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"Reading configuration profile '%s'"
argument_list|,
name|name
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|UNICODE
name|_snwprintf
argument_list|(
argument|buf
argument_list|,
literal|256
argument_list|,
argument|WPA_KEY_PREFIX TEXT(
literal|"\\configs\\%S"
argument|)
argument_list|,
argument|name
argument_list|)
empty_stmt|;
else|#
directive|else
comment|/* UNICODE */
name|os_snprintf
argument_list|(
argument|buf
argument_list|,
literal|256
argument_list|,
argument|WPA_KEY_PREFIX TEXT(
literal|"\\configs\\%s"
argument|)
argument_list|,
argument|name
argument_list|)
empty_stmt|;
endif|#
directive|endif
comment|/* UNICODE */
name|ret
operator|=
name|RegOpenKeyEx
argument_list|(
name|WPA_KEY_ROOT
argument_list|,
name|buf
argument_list|,
literal|0
argument_list|,
name|KEY_QUERY_VALUE
argument_list|,
operator|&
name|hk
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|!=
name|ERROR_SUCCESS
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"Could not open wpa_supplicant "
literal|"configuration registry HKLM\\"
name|TSTR
argument_list|,
name|buf
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|config
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
if|if
condition|(
name|wpa_config_read_global
argument_list|(
name|config
argument_list|,
name|hk
argument_list|)
condition|)
name|errors
operator|++
expr_stmt|;
if|if
condition|(
name|wpa_config_read_networks
argument_list|(
name|config
argument_list|,
name|hk
argument_list|)
condition|)
name|errors
operator|++
expr_stmt|;
if|if
condition|(
name|wpa_config_read_blobs
argument_list|(
name|config
argument_list|,
name|hk
argument_list|)
condition|)
name|errors
operator|++
expr_stmt|;
name|wpa_config_debug_dump_networks
argument_list|(
name|config
argument_list|)
expr_stmt|;
name|RegCloseKey
argument_list|(
name|hk
argument_list|)
expr_stmt|;
if|if
condition|(
name|errors
condition|)
block|{
name|wpa_config_free
argument_list|(
name|config
argument_list|)
expr_stmt|;
name|config
operator|=
name|NULL
expr_stmt|;
block|}
return|return
name|config
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|wpa_config_write_reg_dword
parameter_list|(
name|HKEY
name|hk
parameter_list|,
specifier|const
name|TCHAR
modifier|*
name|name
parameter_list|,
name|int
name|val
parameter_list|,
name|int
name|def
parameter_list|)
block|{
name|LONG
name|ret
decl_stmt|;
name|DWORD
name|_val
init|=
name|val
decl_stmt|;
if|if
condition|(
name|val
operator|==
name|def
condition|)
block|{
name|RegDeleteValue
argument_list|(
name|hk
argument_list|,
name|name
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
name|ret
operator|=
name|RegSetValueEx
argument_list|(
name|hk
argument_list|,
name|name
argument_list|,
literal|0
argument_list|,
name|REG_DWORD
argument_list|,
operator|(
name|LPBYTE
operator|)
operator|&
name|_val
argument_list|,
sizeof|sizeof
argument_list|(
name|_val
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|!=
name|ERROR_SUCCESS
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"WINREG: Failed to set %s=%d: error %d"
argument_list|,
name|name
argument_list|,
name|val
argument_list|,
operator|(
name|int
operator|)
name|GetLastError
argument_list|()
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|wpa_config_write_reg_string
parameter_list|(
name|HKEY
name|hk
parameter_list|,
specifier|const
name|char
modifier|*
name|name
parameter_list|,
specifier|const
name|char
modifier|*
name|val
parameter_list|)
block|{
name|LONG
name|ret
decl_stmt|;
name|TCHAR
modifier|*
name|_name
decl_stmt|,
modifier|*
name|_val
decl_stmt|;
name|_name
operator|=
name|wpa_strdup_tchar
argument_list|(
name|name
argument_list|)
expr_stmt|;
if|if
condition|(
name|_name
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
if|if
condition|(
name|val
operator|==
name|NULL
condition|)
block|{
name|RegDeleteValue
argument_list|(
name|hk
argument_list|,
name|_name
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|_name
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
name|_val
operator|=
name|wpa_strdup_tchar
argument_list|(
name|val
argument_list|)
expr_stmt|;
if|if
condition|(
name|_val
operator|==
name|NULL
condition|)
block|{
name|os_free
argument_list|(
name|_name
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|ret
operator|=
name|RegSetValueEx
argument_list|(
name|hk
argument_list|,
name|_name
argument_list|,
literal|0
argument_list|,
name|REG_SZ
argument_list|,
operator|(
name|BYTE
operator|*
operator|)
name|_val
argument_list|,
operator|(
name|os_strlen
argument_list|(
name|val
argument_list|)
operator|+
literal|1
operator|)
operator|*
sizeof|sizeof
argument_list|(
name|TCHAR
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|!=
name|ERROR_SUCCESS
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"WINREG: Failed to set %s='%s': "
literal|"error %d"
argument_list|,
name|name
argument_list|,
name|val
argument_list|,
operator|(
name|int
operator|)
name|GetLastError
argument_list|()
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|_name
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|_val
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|os_free
argument_list|(
name|_name
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|_val
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|wpa_config_write_global
parameter_list|(
name|struct
name|wpa_config
modifier|*
name|config
parameter_list|,
name|HKEY
name|hk
parameter_list|)
block|{
ifdef|#
directive|ifdef
name|CONFIG_CTRL_IFACE
name|wpa_config_write_reg_string
argument_list|(
name|hk
argument_list|,
literal|"ctrl_interface"
argument_list|,
name|config
operator|->
name|ctrl_interface
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* CONFIG_CTRL_IFACE */
name|wpa_config_write_reg_dword
argument_list|(
name|hk
argument_list|,
name|TEXT
argument_list|(
literal|"eapol_version"
argument_list|)
argument_list|,
name|config
operator|->
name|eapol_version
argument_list|,
name|DEFAULT_EAPOL_VERSION
argument_list|)
expr_stmt|;
name|wpa_config_write_reg_dword
argument_list|(
name|hk
argument_list|,
name|TEXT
argument_list|(
literal|"ap_scan"
argument_list|)
argument_list|,
name|config
operator|->
name|ap_scan
argument_list|,
name|DEFAULT_AP_SCAN
argument_list|)
expr_stmt|;
name|wpa_config_write_reg_dword
argument_list|(
name|hk
argument_list|,
name|TEXT
argument_list|(
literal|"fast_reauth"
argument_list|)
argument_list|,
name|config
operator|->
name|fast_reauth
argument_list|,
name|DEFAULT_FAST_REAUTH
argument_list|)
expr_stmt|;
name|wpa_config_write_reg_dword
argument_list|(
name|hk
argument_list|,
name|TEXT
argument_list|(
literal|"dot11RSNAConfigPMKLifetime"
argument_list|)
argument_list|,
name|config
operator|->
name|dot11RSNAConfigPMKLifetime
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|wpa_config_write_reg_dword
argument_list|(
name|hk
argument_list|,
name|TEXT
argument_list|(
literal|"dot11RSNAConfigPMKReauthThreshold"
argument_list|)
argument_list|,
name|config
operator|->
name|dot11RSNAConfigPMKReauthThreshold
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|wpa_config_write_reg_dword
argument_list|(
name|hk
argument_list|,
name|TEXT
argument_list|(
literal|"dot11RSNAConfigSATimeout"
argument_list|)
argument_list|,
name|config
operator|->
name|dot11RSNAConfigSATimeout
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|wpa_config_write_reg_dword
argument_list|(
name|hk
argument_list|,
name|TEXT
argument_list|(
literal|"update_config"
argument_list|)
argument_list|,
name|config
operator|->
name|update_config
argument_list|,
literal|0
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|wpa_config_delete_subkeys
parameter_list|(
name|HKEY
name|hk
parameter_list|,
specifier|const
name|TCHAR
modifier|*
name|key
parameter_list|)
block|{
name|HKEY
name|nhk
decl_stmt|;
name|int
name|i
decl_stmt|,
name|errors
init|=
literal|0
decl_stmt|;
name|LONG
name|ret
decl_stmt|;
name|ret
operator|=
name|RegOpenKeyEx
argument_list|(
name|hk
argument_list|,
name|key
argument_list|,
literal|0
argument_list|,
name|KEY_ENUMERATE_SUB_KEYS
operator||
name|DELETE
argument_list|,
operator|&
name|nhk
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|!=
name|ERROR_SUCCESS
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WINREG: Could not open key '"
name|TSTR
literal|"' for subkey deletion: error 0x%x (%d)"
argument_list|,
name|key
argument_list|,
operator|(
name|unsigned
name|int
operator|)
name|ret
argument_list|,
operator|(
name|int
operator|)
name|GetLastError
argument_list|()
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
condition|;
name|i
operator|++
control|)
block|{
name|TCHAR
name|name
index|[
literal|255
index|]
decl_stmt|;
name|DWORD
name|namelen
decl_stmt|;
name|namelen
operator|=
literal|255
expr_stmt|;
name|ret
operator|=
name|RegEnumKeyEx
argument_list|(
name|nhk
argument_list|,
name|i
argument_list|,
name|name
argument_list|,
operator|&
name|namelen
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|==
name|ERROR_NO_MORE_ITEMS
condition|)
break|break;
if|if
condition|(
name|ret
operator|!=
name|ERROR_SUCCESS
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"RegEnumKeyEx failed: 0x%x (%d)"
argument_list|,
operator|(
name|unsigned
name|int
operator|)
name|ret
argument_list|,
operator|(
name|int
operator|)
name|GetLastError
argument_list|()
argument_list|)
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|namelen
operator|>=
literal|255
condition|)
name|namelen
operator|=
literal|255
operator|-
literal|1
expr_stmt|;
name|name
index|[
name|namelen
index|]
operator|=
name|TEXT
argument_list|(
literal|'\0'
argument_list|)
expr_stmt|;
name|ret
operator|=
name|RegDeleteKey
argument_list|(
name|nhk
argument_list|,
name|name
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|!=
name|ERROR_SUCCESS
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"RegDeleteKey failed: 0x%x (%d)"
argument_list|,
operator|(
name|unsigned
name|int
operator|)
name|ret
argument_list|,
operator|(
name|int
operator|)
name|GetLastError
argument_list|()
argument_list|)
expr_stmt|;
name|errors
operator|++
expr_stmt|;
block|}
block|}
name|RegCloseKey
argument_list|(
name|nhk
argument_list|)
expr_stmt|;
return|return
name|errors
condition|?
operator|-
literal|1
else|:
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|write_str
parameter_list|(
name|HKEY
name|hk
parameter_list|,
specifier|const
name|char
modifier|*
name|field
parameter_list|,
name|struct
name|wpa_ssid
modifier|*
name|ssid
parameter_list|)
block|{
name|char
modifier|*
name|value
init|=
name|wpa_config_get
argument_list|(
name|ssid
argument_list|,
name|field
argument_list|)
decl_stmt|;
if|if
condition|(
name|value
operator|==
name|NULL
condition|)
return|return;
name|wpa_config_write_reg_string
argument_list|(
name|hk
argument_list|,
name|field
argument_list|,
name|value
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|value
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|write_int
parameter_list|(
name|HKEY
name|hk
parameter_list|,
specifier|const
name|char
modifier|*
name|field
parameter_list|,
name|int
name|value
parameter_list|,
name|int
name|def
parameter_list|)
block|{
name|char
name|val
index|[
literal|20
index|]
decl_stmt|;
if|if
condition|(
name|value
operator|==
name|def
condition|)
return|return;
name|os_snprintf
argument_list|(
name|val
argument_list|,
sizeof|sizeof
argument_list|(
name|val
argument_list|)
argument_list|,
literal|"%d"
argument_list|,
name|value
argument_list|)
expr_stmt|;
name|wpa_config_write_reg_string
argument_list|(
name|hk
argument_list|,
name|field
argument_list|,
name|val
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|write_bssid
parameter_list|(
name|HKEY
name|hk
parameter_list|,
name|struct
name|wpa_ssid
modifier|*
name|ssid
parameter_list|)
block|{
name|char
modifier|*
name|value
init|=
name|wpa_config_get
argument_list|(
name|ssid
argument_list|,
literal|"bssid"
argument_list|)
decl_stmt|;
if|if
condition|(
name|value
operator|==
name|NULL
condition|)
return|return;
name|wpa_config_write_reg_string
argument_list|(
name|hk
argument_list|,
literal|"bssid"
argument_list|,
name|value
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|value
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|write_psk
parameter_list|(
name|HKEY
name|hk
parameter_list|,
name|struct
name|wpa_ssid
modifier|*
name|ssid
parameter_list|)
block|{
name|char
modifier|*
name|value
init|=
name|wpa_config_get
argument_list|(
name|ssid
argument_list|,
literal|"psk"
argument_list|)
decl_stmt|;
if|if
condition|(
name|value
operator|==
name|NULL
condition|)
return|return;
name|wpa_config_write_reg_string
argument_list|(
name|hk
argument_list|,
literal|"psk"
argument_list|,
name|value
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|value
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|write_proto
parameter_list|(
name|HKEY
name|hk
parameter_list|,
name|struct
name|wpa_ssid
modifier|*
name|ssid
parameter_list|)
block|{
name|char
modifier|*
name|value
decl_stmt|;
if|if
condition|(
name|ssid
operator|->
name|proto
operator|==
name|DEFAULT_PROTO
condition|)
return|return;
name|value
operator|=
name|wpa_config_get
argument_list|(
name|ssid
argument_list|,
literal|"proto"
argument_list|)
expr_stmt|;
if|if
condition|(
name|value
operator|==
name|NULL
condition|)
return|return;
if|if
condition|(
name|value
index|[
literal|0
index|]
condition|)
name|wpa_config_write_reg_string
argument_list|(
name|hk
argument_list|,
literal|"proto"
argument_list|,
name|value
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|value
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|write_key_mgmt
parameter_list|(
name|HKEY
name|hk
parameter_list|,
name|struct
name|wpa_ssid
modifier|*
name|ssid
parameter_list|)
block|{
name|char
modifier|*
name|value
decl_stmt|;
if|if
condition|(
name|ssid
operator|->
name|key_mgmt
operator|==
name|DEFAULT_KEY_MGMT
condition|)
return|return;
name|value
operator|=
name|wpa_config_get
argument_list|(
name|ssid
argument_list|,
literal|"key_mgmt"
argument_list|)
expr_stmt|;
if|if
condition|(
name|value
operator|==
name|NULL
condition|)
return|return;
if|if
condition|(
name|value
index|[
literal|0
index|]
condition|)
name|wpa_config_write_reg_string
argument_list|(
name|hk
argument_list|,
literal|"key_mgmt"
argument_list|,
name|value
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|value
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|write_pairwise
parameter_list|(
name|HKEY
name|hk
parameter_list|,
name|struct
name|wpa_ssid
modifier|*
name|ssid
parameter_list|)
block|{
name|char
modifier|*
name|value
decl_stmt|;
if|if
condition|(
name|ssid
operator|->
name|pairwise_cipher
operator|==
name|DEFAULT_PAIRWISE
condition|)
return|return;
name|value
operator|=
name|wpa_config_get
argument_list|(
name|ssid
argument_list|,
literal|"pairwise"
argument_list|)
expr_stmt|;
if|if
condition|(
name|value
operator|==
name|NULL
condition|)
return|return;
if|if
condition|(
name|value
index|[
literal|0
index|]
condition|)
name|wpa_config_write_reg_string
argument_list|(
name|hk
argument_list|,
literal|"pairwise"
argument_list|,
name|value
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|value
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|write_group
parameter_list|(
name|HKEY
name|hk
parameter_list|,
name|struct
name|wpa_ssid
modifier|*
name|ssid
parameter_list|)
block|{
name|char
modifier|*
name|value
decl_stmt|;
if|if
condition|(
name|ssid
operator|->
name|group_cipher
operator|==
name|DEFAULT_GROUP
condition|)
return|return;
name|value
operator|=
name|wpa_config_get
argument_list|(
name|ssid
argument_list|,
literal|"group"
argument_list|)
expr_stmt|;
if|if
condition|(
name|value
operator|==
name|NULL
condition|)
return|return;
if|if
condition|(
name|value
index|[
literal|0
index|]
condition|)
name|wpa_config_write_reg_string
argument_list|(
name|hk
argument_list|,
literal|"group"
argument_list|,
name|value
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|value
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|write_auth_alg
parameter_list|(
name|HKEY
name|hk
parameter_list|,
name|struct
name|wpa_ssid
modifier|*
name|ssid
parameter_list|)
block|{
name|char
modifier|*
name|value
decl_stmt|;
if|if
condition|(
name|ssid
operator|->
name|auth_alg
operator|==
literal|0
condition|)
return|return;
name|value
operator|=
name|wpa_config_get
argument_list|(
name|ssid
argument_list|,
literal|"auth_alg"
argument_list|)
expr_stmt|;
if|if
condition|(
name|value
operator|==
name|NULL
condition|)
return|return;
if|if
condition|(
name|value
index|[
literal|0
index|]
condition|)
name|wpa_config_write_reg_string
argument_list|(
name|hk
argument_list|,
literal|"auth_alg"
argument_list|,
name|value
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|value
argument_list|)
expr_stmt|;
block|}
end_function

begin_ifdef
ifdef|#
directive|ifdef
name|IEEE8021X_EAPOL
end_ifdef

begin_function
specifier|static
name|void
name|write_eap
parameter_list|(
name|HKEY
name|hk
parameter_list|,
name|struct
name|wpa_ssid
modifier|*
name|ssid
parameter_list|)
block|{
name|char
modifier|*
name|value
decl_stmt|;
name|value
operator|=
name|wpa_config_get
argument_list|(
name|ssid
argument_list|,
literal|"eap"
argument_list|)
expr_stmt|;
if|if
condition|(
name|value
operator|==
name|NULL
condition|)
return|return;
if|if
condition|(
name|value
index|[
literal|0
index|]
condition|)
name|wpa_config_write_reg_string
argument_list|(
name|hk
argument_list|,
literal|"eap"
argument_list|,
name|value
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|value
argument_list|)
expr_stmt|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* IEEE8021X_EAPOL */
end_comment

begin_function
specifier|static
name|void
name|write_wep_key
parameter_list|(
name|HKEY
name|hk
parameter_list|,
name|int
name|idx
parameter_list|,
name|struct
name|wpa_ssid
modifier|*
name|ssid
parameter_list|)
block|{
name|char
name|field
index|[
literal|20
index|]
decl_stmt|,
modifier|*
name|value
decl_stmt|;
name|os_snprintf
argument_list|(
name|field
argument_list|,
sizeof|sizeof
argument_list|(
name|field
argument_list|)
argument_list|,
literal|"wep_key%d"
argument_list|,
name|idx
argument_list|)
expr_stmt|;
name|value
operator|=
name|wpa_config_get
argument_list|(
name|ssid
argument_list|,
name|field
argument_list|)
expr_stmt|;
if|if
condition|(
name|value
condition|)
block|{
name|wpa_config_write_reg_string
argument_list|(
name|hk
argument_list|,
name|field
argument_list|,
name|value
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|value
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|int
name|wpa_config_write_network
parameter_list|(
name|HKEY
name|hk
parameter_list|,
name|struct
name|wpa_ssid
modifier|*
name|ssid
parameter_list|,
name|int
name|id
parameter_list|)
block|{
name|int
name|i
decl_stmt|,
name|errors
init|=
literal|0
decl_stmt|;
name|HKEY
name|nhk
decl_stmt|,
name|netw
decl_stmt|;
name|LONG
name|ret
decl_stmt|;
name|TCHAR
name|name
index|[
literal|5
index|]
decl_stmt|;
name|ret
operator|=
name|RegOpenKeyEx
argument_list|(
name|hk
argument_list|,
name|TEXT
argument_list|(
literal|"networks"
argument_list|)
argument_list|,
literal|0
argument_list|,
name|KEY_CREATE_SUB_KEY
argument_list|,
operator|&
name|nhk
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|!=
name|ERROR_SUCCESS
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WINREG: Could not open networks key "
literal|"for subkey addition: error 0x%x (%d)"
argument_list|,
operator|(
name|unsigned
name|int
operator|)
name|ret
argument_list|,
operator|(
name|int
operator|)
name|GetLastError
argument_list|()
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
ifdef|#
directive|ifdef
name|UNICODE
name|wsprintf
argument_list|(
name|name
argument_list|,
literal|L"%04d"
argument_list|,
name|id
argument_list|)
expr_stmt|;
else|#
directive|else
comment|/* UNICODE */
name|os_snprintf
argument_list|(
name|name
argument_list|,
sizeof|sizeof
argument_list|(
name|name
argument_list|)
argument_list|,
literal|"%04d"
argument_list|,
name|id
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* UNICODE */
name|ret
operator|=
name|RegCreateKeyEx
argument_list|(
name|nhk
argument_list|,
name|name
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|,
name|KEY_WRITE
argument_list|,
name|NULL
argument_list|,
operator|&
name|netw
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|RegCloseKey
argument_list|(
name|nhk
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|!=
name|ERROR_SUCCESS
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WINREG: Could not add network key '%s':"
literal|" error 0x%x (%d)"
argument_list|,
name|name
argument_list|,
operator|(
name|unsigned
name|int
operator|)
name|ret
argument_list|,
operator|(
name|int
operator|)
name|GetLastError
argument_list|()
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
define|#
directive|define
name|STR
parameter_list|(
name|t
parameter_list|)
value|write_str(netw, #t, ssid)
define|#
directive|define
name|INT
parameter_list|(
name|t
parameter_list|)
value|write_int(netw, #t, ssid->t, 0)
define|#
directive|define
name|INT_DEF
parameter_list|(
name|t
parameter_list|,
name|def
parameter_list|)
value|write_int(netw, #t, ssid->t, def)
name|STR
argument_list|(
name|ssid
argument_list|)
expr_stmt|;
name|INT
argument_list|(
name|scan_ssid
argument_list|)
expr_stmt|;
name|write_bssid
argument_list|(
name|netw
argument_list|,
name|ssid
argument_list|)
expr_stmt|;
name|write_psk
argument_list|(
name|netw
argument_list|,
name|ssid
argument_list|)
expr_stmt|;
name|write_proto
argument_list|(
name|netw
argument_list|,
name|ssid
argument_list|)
expr_stmt|;
name|write_key_mgmt
argument_list|(
name|netw
argument_list|,
name|ssid
argument_list|)
expr_stmt|;
name|write_pairwise
argument_list|(
name|netw
argument_list|,
name|ssid
argument_list|)
expr_stmt|;
name|write_group
argument_list|(
name|netw
argument_list|,
name|ssid
argument_list|)
expr_stmt|;
name|write_auth_alg
argument_list|(
name|netw
argument_list|,
name|ssid
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|IEEE8021X_EAPOL
name|write_eap
argument_list|(
name|netw
argument_list|,
name|ssid
argument_list|)
expr_stmt|;
name|STR
argument_list|(
name|identity
argument_list|)
expr_stmt|;
name|STR
argument_list|(
name|anonymous_identity
argument_list|)
expr_stmt|;
name|STR
argument_list|(
name|eappsk
argument_list|)
expr_stmt|;
name|STR
argument_list|(
name|nai
argument_list|)
expr_stmt|;
name|STR
argument_list|(
name|password
argument_list|)
expr_stmt|;
name|STR
argument_list|(
name|ca_cert
argument_list|)
expr_stmt|;
name|STR
argument_list|(
name|ca_path
argument_list|)
expr_stmt|;
name|STR
argument_list|(
name|client_cert
argument_list|)
expr_stmt|;
name|STR
argument_list|(
name|private_key
argument_list|)
expr_stmt|;
name|STR
argument_list|(
name|private_key_passwd
argument_list|)
expr_stmt|;
name|STR
argument_list|(
name|dh_file
argument_list|)
expr_stmt|;
name|STR
argument_list|(
name|subject_match
argument_list|)
expr_stmt|;
name|STR
argument_list|(
name|altsubject_match
argument_list|)
expr_stmt|;
name|STR
argument_list|(
name|ca_cert2
argument_list|)
expr_stmt|;
name|STR
argument_list|(
name|ca_path2
argument_list|)
expr_stmt|;
name|STR
argument_list|(
name|client_cert2
argument_list|)
expr_stmt|;
name|STR
argument_list|(
name|private_key2
argument_list|)
expr_stmt|;
name|STR
argument_list|(
name|private_key2_passwd
argument_list|)
expr_stmt|;
name|STR
argument_list|(
name|dh_file2
argument_list|)
expr_stmt|;
name|STR
argument_list|(
name|subject_match2
argument_list|)
expr_stmt|;
name|STR
argument_list|(
name|altsubject_match2
argument_list|)
expr_stmt|;
name|STR
argument_list|(
name|phase1
argument_list|)
expr_stmt|;
name|STR
argument_list|(
name|phase2
argument_list|)
expr_stmt|;
name|STR
argument_list|(
name|pcsc
argument_list|)
expr_stmt|;
name|STR
argument_list|(
name|pin
argument_list|)
expr_stmt|;
name|STR
argument_list|(
name|engine_id
argument_list|)
expr_stmt|;
name|STR
argument_list|(
name|key_id
argument_list|)
expr_stmt|;
name|INT
argument_list|(
name|engine
argument_list|)
expr_stmt|;
name|INT_DEF
argument_list|(
name|eapol_flags
argument_list|,
name|DEFAULT_EAPOL_FLAGS
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* IEEE8021X_EAPOL */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|4
condition|;
name|i
operator|++
control|)
name|write_wep_key
argument_list|(
name|netw
argument_list|,
name|i
argument_list|,
name|ssid
argument_list|)
expr_stmt|;
name|INT
argument_list|(
name|wep_tx_keyidx
argument_list|)
expr_stmt|;
name|INT
argument_list|(
name|priority
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|IEEE8021X_EAPOL
name|INT_DEF
argument_list|(
name|eap_workaround
argument_list|,
name|DEFAULT_EAP_WORKAROUND
argument_list|)
expr_stmt|;
name|STR
argument_list|(
name|pac_file
argument_list|)
expr_stmt|;
name|INT_DEF
argument_list|(
name|fragment_size
argument_list|,
name|DEFAULT_FRAGMENT_SIZE
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* IEEE8021X_EAPOL */
name|INT
argument_list|(
name|mode
argument_list|)
expr_stmt|;
name|INT
argument_list|(
name|proactive_key_caching
argument_list|)
expr_stmt|;
name|INT
argument_list|(
name|disabled
argument_list|)
expr_stmt|;
name|INT
argument_list|(
name|peerkey
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|CONFIG_IEEE80211W
name|INT
argument_list|(
name|ieee80211w
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* CONFIG_IEEE80211W */
name|STR
argument_list|(
name|id_str
argument_list|)
expr_stmt|;
undef|#
directive|undef
name|STR
undef|#
directive|undef
name|INT
undef|#
directive|undef
name|INT_DEF
name|RegCloseKey
argument_list|(
name|netw
argument_list|)
expr_stmt|;
return|return
name|errors
condition|?
operator|-
literal|1
else|:
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|wpa_config_write_blob
parameter_list|(
name|HKEY
name|hk
parameter_list|,
name|struct
name|wpa_config_blob
modifier|*
name|blob
parameter_list|)
block|{
name|HKEY
name|bhk
decl_stmt|;
name|LONG
name|ret
decl_stmt|;
name|TCHAR
modifier|*
name|name
decl_stmt|;
name|ret
operator|=
name|RegCreateKeyEx
argument_list|(
name|hk
argument_list|,
name|TEXT
argument_list|(
literal|"blobs"
argument_list|)
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|,
name|KEY_WRITE
argument_list|,
name|NULL
argument_list|,
operator|&
name|bhk
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|!=
name|ERROR_SUCCESS
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WINREG: Could not add blobs key: "
literal|"error 0x%x (%d)"
argument_list|,
operator|(
name|unsigned
name|int
operator|)
name|ret
argument_list|,
operator|(
name|int
operator|)
name|GetLastError
argument_list|()
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|name
operator|=
name|wpa_strdup_tchar
argument_list|(
name|blob
operator|->
name|name
argument_list|)
expr_stmt|;
name|ret
operator|=
name|RegSetValueEx
argument_list|(
name|bhk
argument_list|,
name|name
argument_list|,
literal|0
argument_list|,
name|REG_BINARY
argument_list|,
name|blob
operator|->
name|data
argument_list|,
name|blob
operator|->
name|len
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|!=
name|ERROR_SUCCESS
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"WINREG: Failed to set blob %s': "
literal|"error 0x%x (%d)"
argument_list|,
name|blob
operator|->
name|name
argument_list|,
operator|(
name|unsigned
name|int
operator|)
name|ret
argument_list|,
operator|(
name|int
operator|)
name|GetLastError
argument_list|()
argument_list|)
expr_stmt|;
name|RegCloseKey
argument_list|(
name|bhk
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|name
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|os_free
argument_list|(
name|name
argument_list|)
expr_stmt|;
name|RegCloseKey
argument_list|(
name|bhk
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|int
name|wpa_config_write
parameter_list|(
specifier|const
name|char
modifier|*
name|name
parameter_list|,
name|struct
name|wpa_config
modifier|*
name|config
parameter_list|)
block|{
name|TCHAR
name|buf
index|[
literal|256
index|]
decl_stmt|;
name|HKEY
name|hk
decl_stmt|;
name|LONG
name|ret
decl_stmt|;
name|int
name|errors
init|=
literal|0
decl_stmt|;
name|struct
name|wpa_ssid
modifier|*
name|ssid
decl_stmt|;
name|struct
name|wpa_config_blob
modifier|*
name|blob
decl_stmt|;
name|int
name|id
decl_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"Writing configuration file '%s'"
argument_list|,
name|name
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|UNICODE
name|_snwprintf
argument_list|(
argument|buf
argument_list|,
literal|256
argument_list|,
argument|WPA_KEY_PREFIX TEXT(
literal|"\\configs\\%S"
argument|)
argument_list|,
argument|name
argument_list|)
empty_stmt|;
else|#
directive|else
comment|/* UNICODE */
name|os_snprintf
argument_list|(
argument|buf
argument_list|,
literal|256
argument_list|,
argument|WPA_KEY_PREFIX TEXT(
literal|"\\configs\\%s"
argument|)
argument_list|,
argument|name
argument_list|)
empty_stmt|;
endif|#
directive|endif
comment|/* UNICODE */
name|ret
operator|=
name|RegOpenKeyEx
argument_list|(
name|WPA_KEY_ROOT
argument_list|,
name|buf
argument_list|,
literal|0
argument_list|,
name|KEY_SET_VALUE
operator||
name|DELETE
argument_list|,
operator|&
name|hk
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|!=
name|ERROR_SUCCESS
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"Could not open wpa_supplicant "
literal|"configuration registry %s: error %d"
argument_list|,
name|buf
argument_list|,
operator|(
name|int
operator|)
name|GetLastError
argument_list|()
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
if|if
condition|(
name|wpa_config_write_global
argument_list|(
name|config
argument_list|,
name|hk
argument_list|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"Failed to write global configuration "
literal|"data"
argument_list|)
expr_stmt|;
name|errors
operator|++
expr_stmt|;
block|}
name|wpa_config_delete_subkeys
argument_list|(
name|hk
argument_list|,
name|TEXT
argument_list|(
literal|"networks"
argument_list|)
argument_list|)
expr_stmt|;
for|for
control|(
name|ssid
operator|=
name|config
operator|->
name|ssid
operator|,
name|id
operator|=
literal|0
init|;
name|ssid
condition|;
name|ssid
operator|=
name|ssid
operator|->
name|next
operator|,
name|id
operator|++
control|)
block|{
if|if
condition|(
name|wpa_config_write_network
argument_list|(
name|hk
argument_list|,
name|ssid
argument_list|,
name|id
argument_list|)
condition|)
name|errors
operator|++
expr_stmt|;
block|}
name|RegDeleteKey
argument_list|(
name|hk
argument_list|,
name|TEXT
argument_list|(
literal|"blobs"
argument_list|)
argument_list|)
expr_stmt|;
for|for
control|(
name|blob
operator|=
name|config
operator|->
name|blobs
init|;
name|blob
condition|;
name|blob
operator|=
name|blob
operator|->
name|next
control|)
block|{
if|if
condition|(
name|wpa_config_write_blob
argument_list|(
name|hk
argument_list|,
name|blob
argument_list|)
condition|)
name|errors
operator|++
expr_stmt|;
block|}
name|RegCloseKey
argument_list|(
name|hk
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"Configuration '%s' written %ssuccessfully"
argument_list|,
name|name
argument_list|,
name|errors
condition|?
literal|"un"
else|:
literal|""
argument_list|)
expr_stmt|;
return|return
name|errors
condition|?
operator|-
literal|1
else|:
literal|0
return|;
block|}
end_function

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * CDDL HEADER START  *  * The contents of this file are subject to the terms of the  * Common Development and Distribution License, Version 1.0 only  * (the "License").  You may not use this file except in compliance  * with the License.  *  * You can obtain a copy of the license at usr/src/OPENSOLARIS.LICENSE  * or http://www.opensolaris.org/os/licensing.  * See the License for the specific language governing permissions  * and limitations under the License.  *  * When distributing Covered Code, include this CDDL HEADER in each  * file and include the License file at usr/src/OPENSOLARIS.LICENSE.  * If applicable, add the following below this CDDL HEADER, with the  * fields enclosed by brackets "[]" replaced with your own identifying  * information: Portions Copyright [yyyy] [name of copyright owner]  *  * CDDL HEADER END  */
end_comment

begin_comment
comment|/*  * Copyright 2005 Sun Microsystems, Inc.  All rights reserved.  * Use is subject to license terms.  */
end_comment

begin_comment
comment|/*	Copyright (c) 1983, 1984, 1985, 1986, 1987, 1988, 1989 AT&T	*/
end_comment

begin_comment
comment|/*	  All Rights Reserved  	*/
end_comment

begin_comment
comment|/*  * Portions of this source code were derived from Berkeley 4.3 BSD  * under license from the Regents of the University of California.  */
end_comment

begin_pragma
pragma|#
directive|pragma
name|ident
literal|"%Z%%M%	%I%	%E% SMI"
end_pragma

begin_comment
comment|/*  * xdr_mem.c, XDR implementation using memory buffers.  *  * If you have some data to be interpreted as external data representation  * or to be converted to external data representation in a memory buffer,  * then this is the package for you.  */
end_comment

begin_include
include|#
directive|include
file|<sys/param.h>
end_include

begin_include
include|#
directive|include
file|<sys/types.h>
end_include

begin_include
include|#
directive|include
file|<sys/systm.h>
end_include

begin_include
include|#
directive|include
file|<rpc/types.h>
end_include

begin_include
include|#
directive|include
file|<rpc/xdr.h>
end_include

begin_function_decl
specifier|static
name|struct
name|xdr_ops
modifier|*
name|xdrmem_ops
parameter_list|(
name|void
parameter_list|)
function_decl|;
end_function_decl

begin_comment
comment|/*  * The procedure xdrmem_create initializes a stream descriptor for a  * memory buffer.  */
end_comment

begin_function
name|void
name|xdrmem_create
parameter_list|(
name|XDR
modifier|*
name|xdrs
parameter_list|,
name|caddr_t
name|addr
parameter_list|,
name|uint_t
name|size
parameter_list|,
name|enum
name|xdr_op
name|op
parameter_list|)
block|{
name|xdrs
operator|->
name|x_op
operator|=
name|op
expr_stmt|;
name|xdrs
operator|->
name|x_ops
operator|=
name|xdrmem_ops
argument_list|()
expr_stmt|;
name|xdrs
operator|->
name|x_private
operator|=
name|xdrs
operator|->
name|x_base
operator|=
name|addr
expr_stmt|;
name|xdrs
operator|->
name|x_handy
operator|=
name|size
expr_stmt|;
name|xdrs
operator|->
name|x_public
operator|=
name|NULL
expr_stmt|;
block|}
end_function

begin_comment
comment|/* ARGSUSED */
end_comment

begin_function
specifier|static
name|void
name|xdrmem_destroy
parameter_list|(
name|XDR
modifier|*
name|xdrs
parameter_list|)
block|{ }
end_function

begin_function
specifier|static
name|bool_t
name|xdrmem_getint32
parameter_list|(
name|XDR
modifier|*
name|xdrs
parameter_list|,
name|int32_t
modifier|*
name|int32p
parameter_list|)
block|{
if|if
condition|(
operator|(
name|xdrs
operator|->
name|x_handy
operator|-=
operator|(
name|int
operator|)
sizeof|sizeof
argument_list|(
name|int32_t
argument_list|)
operator|)
operator|<
literal|0
condition|)
return|return
operator|(
name|FALSE
operator|)
return|;
comment|/* LINTED pointer alignment */
operator|*
name|int32p
operator|=
operator|(
name|int32_t
operator|)
name|ntohl
argument_list|(
call|(
name|uint32_t
call|)
argument_list|(
operator|*
operator|(
operator|(
name|int32_t
operator|*
operator|)
operator|(
name|xdrs
operator|->
name|x_private
operator|)
operator|)
argument_list|)
argument_list|)
expr_stmt|;
name|xdrs
operator|->
name|x_private
operator|+=
sizeof|sizeof
argument_list|(
name|int32_t
argument_list|)
expr_stmt|;
return|return
operator|(
name|TRUE
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|bool_t
name|xdrmem_putint32
parameter_list|(
name|XDR
modifier|*
name|xdrs
parameter_list|,
name|int32_t
modifier|*
name|int32p
parameter_list|)
block|{
if|if
condition|(
operator|(
name|xdrs
operator|->
name|x_handy
operator|-=
operator|(
name|int
operator|)
sizeof|sizeof
argument_list|(
name|int32_t
argument_list|)
operator|)
operator|<
literal|0
condition|)
return|return
operator|(
name|FALSE
operator|)
return|;
comment|/* LINTED pointer alignment */
operator|*
operator|(
name|int32_t
operator|*
operator|)
name|xdrs
operator|->
name|x_private
operator|=
operator|(
name|int32_t
operator|)
name|htonl
argument_list|(
call|(
name|uint32_t
call|)
argument_list|(
operator|*
name|int32p
argument_list|)
argument_list|)
expr_stmt|;
name|xdrs
operator|->
name|x_private
operator|+=
sizeof|sizeof
argument_list|(
name|int32_t
argument_list|)
expr_stmt|;
return|return
operator|(
name|TRUE
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|bool_t
name|xdrmem_getbytes
parameter_list|(
name|XDR
modifier|*
name|xdrs
parameter_list|,
name|caddr_t
name|addr
parameter_list|,
name|int
name|len
parameter_list|)
block|{
if|if
condition|(
operator|(
name|xdrs
operator|->
name|x_handy
operator|-=
name|len
operator|)
operator|<
literal|0
condition|)
return|return
operator|(
name|FALSE
operator|)
return|;
name|bcopy
argument_list|(
name|xdrs
operator|->
name|x_private
argument_list|,
name|addr
argument_list|,
name|len
argument_list|)
expr_stmt|;
name|xdrs
operator|->
name|x_private
operator|+=
name|len
expr_stmt|;
return|return
operator|(
name|TRUE
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|bool_t
name|xdrmem_putbytes
parameter_list|(
name|XDR
modifier|*
name|xdrs
parameter_list|,
name|caddr_t
name|addr
parameter_list|,
name|int
name|len
parameter_list|)
block|{
if|if
condition|(
operator|(
name|xdrs
operator|->
name|x_handy
operator|-=
name|len
operator|)
operator|<
literal|0
condition|)
return|return
operator|(
name|FALSE
operator|)
return|;
name|bcopy
argument_list|(
name|addr
argument_list|,
name|xdrs
operator|->
name|x_private
argument_list|,
name|len
argument_list|)
expr_stmt|;
name|xdrs
operator|->
name|x_private
operator|+=
name|len
expr_stmt|;
return|return
operator|(
name|TRUE
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|uint_t
name|xdrmem_getpos
parameter_list|(
name|XDR
modifier|*
name|xdrs
parameter_list|)
block|{
return|return
operator|(
call|(
name|uint_t
call|)
argument_list|(
operator|(
name|uintptr_t
operator|)
name|xdrs
operator|->
name|x_private
operator|-
operator|(
name|uintptr_t
operator|)
name|xdrs
operator|->
name|x_base
argument_list|)
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|bool_t
name|xdrmem_setpos
parameter_list|(
name|XDR
modifier|*
name|xdrs
parameter_list|,
name|uint_t
name|pos
parameter_list|)
block|{
name|caddr_t
name|newaddr
init|=
name|xdrs
operator|->
name|x_base
operator|+
name|pos
decl_stmt|;
name|caddr_t
name|lastaddr
init|=
name|xdrs
operator|->
name|x_private
operator|+
name|xdrs
operator|->
name|x_handy
decl_stmt|;
name|ptrdiff_t
name|diff
decl_stmt|;
if|if
condition|(
name|newaddr
operator|>
name|lastaddr
condition|)
return|return
operator|(
name|FALSE
operator|)
return|;
name|xdrs
operator|->
name|x_private
operator|=
name|newaddr
expr_stmt|;
name|diff
operator|=
name|lastaddr
operator|-
name|newaddr
expr_stmt|;
name|xdrs
operator|->
name|x_handy
operator|=
operator|(
name|int
operator|)
name|diff
expr_stmt|;
return|return
operator|(
name|TRUE
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|rpc_inline_t
modifier|*
name|xdrmem_inline
parameter_list|(
name|XDR
modifier|*
name|xdrs
parameter_list|,
name|int
name|len
parameter_list|)
block|{
name|rpc_inline_t
modifier|*
name|buf
init|=
name|NULL
decl_stmt|;
if|if
condition|(
name|xdrs
operator|->
name|x_handy
operator|>=
name|len
condition|)
block|{
name|xdrs
operator|->
name|x_handy
operator|-=
name|len
expr_stmt|;
comment|/* LINTED pointer alignment */
name|buf
operator|=
operator|(
name|rpc_inline_t
operator|*
operator|)
name|xdrs
operator|->
name|x_private
expr_stmt|;
name|xdrs
operator|->
name|x_private
operator|+=
name|len
expr_stmt|;
block|}
return|return
operator|(
name|buf
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|bool_t
name|xdrmem_control
parameter_list|(
name|XDR
modifier|*
name|xdrs
parameter_list|,
name|int
name|request
parameter_list|,
name|void
modifier|*
name|info
parameter_list|)
block|{
name|xdr_bytesrec
modifier|*
name|xptr
decl_stmt|;
name|int32_t
modifier|*
name|int32p
decl_stmt|;
name|int
name|len
decl_stmt|;
switch|switch
condition|(
name|request
condition|)
block|{
case|case
name|XDR_GET_BYTES_AVAIL
case|:
name|xptr
operator|=
operator|(
name|xdr_bytesrec
operator|*
operator|)
name|info
expr_stmt|;
name|xptr
operator|->
name|xc_is_last_record
operator|=
name|TRUE
expr_stmt|;
name|xptr
operator|->
name|xc_num_avail
operator|=
name|xdrs
operator|->
name|x_handy
expr_stmt|;
return|return
operator|(
name|TRUE
operator|)
return|;
case|case
name|XDR_PEEK
case|:
comment|/* 		 * Return the next 4 byte unit in the XDR stream. 		 */
if|if
condition|(
name|xdrs
operator|->
name|x_handy
operator|<
sizeof|sizeof
argument_list|(
name|int32_t
argument_list|)
condition|)
return|return
operator|(
name|FALSE
operator|)
return|;
name|int32p
operator|=
operator|(
name|int32_t
operator|*
operator|)
name|info
expr_stmt|;
operator|*
name|int32p
operator|=
operator|(
name|int32_t
operator|)
name|ntohl
argument_list|(
call|(
name|uint32_t
call|)
argument_list|(
operator|*
operator|(
operator|(
name|int32_t
operator|*
operator|)
operator|(
name|xdrs
operator|->
name|x_private
operator|)
operator|)
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|(
name|TRUE
operator|)
return|;
case|case
name|XDR_SKIPBYTES
case|:
comment|/* 		 * Skip the next N bytes in the XDR stream. 		 */
name|int32p
operator|=
operator|(
name|int32_t
operator|*
operator|)
name|info
expr_stmt|;
name|len
operator|=
name|RNDUP
argument_list|(
call|(
name|int
call|)
argument_list|(
operator|*
name|int32p
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|xdrs
operator|->
name|x_handy
operator|-=
name|len
operator|)
operator|<
literal|0
condition|)
return|return
operator|(
name|FALSE
operator|)
return|;
name|xdrs
operator|->
name|x_private
operator|+=
name|len
expr_stmt|;
return|return
operator|(
name|TRUE
operator|)
return|;
block|}
return|return
operator|(
name|FALSE
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|struct
name|xdr_ops
modifier|*
name|xdrmem_ops
parameter_list|(
name|void
parameter_list|)
block|{
specifier|static
name|struct
name|xdr_ops
name|ops
decl_stmt|;
if|if
condition|(
name|ops
operator|.
name|x_getint32
operator|==
name|NULL
condition|)
block|{
name|ops
operator|.
name|x_getbytes
operator|=
name|xdrmem_getbytes
expr_stmt|;
name|ops
operator|.
name|x_putbytes
operator|=
name|xdrmem_putbytes
expr_stmt|;
name|ops
operator|.
name|x_getpostn
operator|=
name|xdrmem_getpos
expr_stmt|;
name|ops
operator|.
name|x_setpostn
operator|=
name|xdrmem_setpos
expr_stmt|;
name|ops
operator|.
name|x_inline
operator|=
name|xdrmem_inline
expr_stmt|;
name|ops
operator|.
name|x_destroy
operator|=
name|xdrmem_destroy
expr_stmt|;
name|ops
operator|.
name|x_control
operator|=
name|xdrmem_control
expr_stmt|;
name|ops
operator|.
name|x_getint32
operator|=
name|xdrmem_getint32
expr_stmt|;
name|ops
operator|.
name|x_putint32
operator|=
name|xdrmem_putint32
expr_stmt|;
block|}
return|return
operator|(
operator|&
name|ops
operator|)
return|;
block|}
end_function

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*-  * Copyright (c) 2002-2007 Neterion, Inc.  * All rights reserved.  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions  * are met:  * 1. Redistributions of source code must retain the above copyright  *    notice, this list of conditions and the following disclaimer.  * 2. Redistributions in binary form must reproduce the above copyright  *    notice, this list of conditions and the following disclaimer in the  *    documentation and/or other materials provided with the distribution.  *  * THIS SOFTWARE IS PROVIDED BY THE AUTHOR AND CONTRIBUTORS ``AS IS'' AND  * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE  * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE  * ARE DISCLAIMED.  IN NO EVENT SHALL THE AUTHOR OR CONTRIBUTORS BE LIABLE  * FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL  * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS  * OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)  * HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT  * LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY  * OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF  * SUCH DAMAGE.  *  * $FreeBSD$  */
end_comment

begin_ifdef
ifdef|#
directive|ifdef
name|XGE_DEBUG_FP
end_ifdef

begin_include
include|#
directive|include
file|<dev/nxge/include/xgehal-fifo.h>
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_function
name|__HAL_STATIC_FIFO
name|__HAL_INLINE_FIFO
name|xge_hal_fifo_txdl_priv_t
modifier|*
name|__hal_fifo_txdl_priv
parameter_list|(
name|xge_hal_dtr_h
name|dtrh
parameter_list|)
block|{
name|xge_hal_fifo_txd_t
modifier|*
name|txdp
init|=
operator|(
name|xge_hal_fifo_txd_t
operator|*
operator|)
name|dtrh
decl_stmt|;
name|xge_hal_fifo_txdl_priv_t
modifier|*
name|txdl_priv
decl_stmt|;
name|xge_assert
argument_list|(
name|txdp
argument_list|)
expr_stmt|;
name|txdl_priv
operator|=
operator|(
name|xge_hal_fifo_txdl_priv_t
operator|*
operator|)
operator|(
name|ulong_t
operator|)
name|txdp
operator|->
name|host_control
expr_stmt|;
name|xge_assert
argument_list|(
name|txdl_priv
argument_list|)
expr_stmt|;
name|xge_assert
argument_list|(
name|txdl_priv
operator|->
name|dma_object
argument_list|)
expr_stmt|;
name|xge_assert
argument_list|(
name|txdl_priv
operator|->
name|dma_addr
argument_list|)
expr_stmt|;
name|xge_assert
argument_list|(
name|txdl_priv
operator|->
name|dma_object
operator|->
name|handle
operator|==
name|txdl_priv
operator|->
name|dma_handle
argument_list|)
expr_stmt|;
return|return
name|txdl_priv
return|;
block|}
end_function

begin_function
name|__HAL_STATIC_FIFO
name|__HAL_INLINE_FIFO
name|void
name|__hal_fifo_dtr_post_single
parameter_list|(
name|xge_hal_channel_h
name|channelh
parameter_list|,
name|xge_hal_dtr_h
name|dtrh
parameter_list|,
name|u64
name|ctrl_1
parameter_list|)
block|{
name|xge_hal_fifo_t
modifier|*
name|fifo
init|=
operator|(
name|xge_hal_fifo_t
operator|*
operator|)
name|channelh
decl_stmt|;
name|xge_hal_fifo_hw_pair_t
modifier|*
name|hw_pair
init|=
name|fifo
operator|->
name|hw_pair
decl_stmt|;
name|xge_hal_fifo_txd_t
modifier|*
name|txdp
init|=
operator|(
name|xge_hal_fifo_txd_t
operator|*
operator|)
name|dtrh
decl_stmt|;
name|xge_hal_fifo_txdl_priv_t
modifier|*
name|txdl_priv
decl_stmt|;
name|u64
name|ctrl
decl_stmt|;
name|txdp
operator|->
name|control_1
operator||=
name|XGE_HAL_TXD_LIST_OWN_XENA
expr_stmt|;
ifdef|#
directive|ifdef
name|XGE_DEBUG_ASSERT
comment|/* make sure Xena overwrites the (illegal) t_code value on completion */
name|XGE_HAL_SET_TXD_T_CODE
argument_list|(
name|txdp
operator|->
name|control_1
argument_list|,
name|XGE_HAL_TXD_T_CODE_UNUSED_5
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|txdl_priv
operator|=
name|__hal_fifo_txdl_priv
argument_list|(
name|dtrh
argument_list|)
expr_stmt|;
if|#
directive|if
name|defined
argument_list|(
name|XGE_OS_DMA_REQUIRES_SYNC
argument_list|)
operator|&&
name|defined
argument_list|(
name|XGE_HAL_DMA_DTR_STREAMING
argument_list|)
comment|/* sync the TxDL to device */
name|xge_os_dma_sync
argument_list|(
name|fifo
operator|->
name|channel
operator|.
name|pdev
argument_list|,
name|txdl_priv
operator|->
name|dma_handle
argument_list|,
name|txdl_priv
operator|->
name|dma_addr
argument_list|,
name|txdl_priv
operator|->
name|dma_offset
argument_list|,
name|txdl_priv
operator|->
name|frags
operator|<<
literal|5
comment|/* sizeof(xge_hal_fifo_txd_t) */
argument_list|,
name|XGE_OS_DMA_DIR_TODEVICE
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* write the pointer first */
name|xge_os_pio_mem_write64
argument_list|(
name|fifo
operator|->
name|channel
operator|.
name|pdev
argument_list|,
name|fifo
operator|->
name|channel
operator|.
name|regh1
argument_list|,
name|txdl_priv
operator|->
name|dma_addr
argument_list|,
operator|&
name|hw_pair
operator|->
name|txdl_pointer
argument_list|)
expr_stmt|;
comment|/* spec: 0x00 = 1 TxD in the list */
name|ctrl
operator|=
name|XGE_HAL_TX_FIFO_LAST_TXD_NUM
argument_list|(
name|txdl_priv
operator|->
name|frags
operator|-
literal|1
argument_list|)
expr_stmt|;
name|ctrl
operator||=
name|ctrl_1
expr_stmt|;
name|ctrl
operator||=
name|fifo
operator|->
name|no_snoop_bits
expr_stmt|;
if|if
condition|(
name|txdp
operator|->
name|control_1
operator|&
name|XGE_HAL_TXD_LSO_COF_CTRL
argument_list|(
name|XGE_HAL_TXD_TCP_LSO
argument_list|)
condition|)
block|{
name|ctrl
operator||=
name|XGE_HAL_TX_FIFO_SPECIAL_FUNC
expr_stmt|;
block|}
comment|/* 	 * according to the XENA spec: 	 * 	 * It is important to note that pointers and list control words are 	 * always written in pairs: in the first write, the host must write a 	 * pointer, and in the second write, it must write the list control 	 * word. Any other access will result in an error. Also, all 16 bytes 	 * of the pointer/control structure must be written, including any 	 * reserved bytes. 	 */
name|xge_os_wmb
argument_list|()
expr_stmt|;
comment|/* 	 * we want touch work_arr in order with ownership bit set to HW 	 */
name|__hal_channel_dtr_post
argument_list|(
name|channelh
argument_list|,
name|dtrh
argument_list|)
expr_stmt|;
name|xge_os_pio_mem_write64
argument_list|(
name|fifo
operator|->
name|channel
operator|.
name|pdev
argument_list|,
name|fifo
operator|->
name|channel
operator|.
name|regh1
argument_list|,
name|ctrl
argument_list|,
operator|&
name|hw_pair
operator|->
name|list_control
argument_list|)
expr_stmt|;
name|xge_debug_fifo
argument_list|(
name|XGE_TRACE
argument_list|,
literal|"posted txdl 0x"
name|XGE_OS_LLXFMT
literal|" ctrl 0x"
name|XGE_OS_LLXFMT
literal|" "
literal|"into 0x"
name|XGE_OS_LLXFMT
literal|""
argument_list|,
operator|(
name|unsigned
name|long
name|long
operator|)
name|txdl_priv
operator|->
name|dma_addr
argument_list|,
operator|(
name|unsigned
name|long
name|long
operator|)
name|ctrl
argument_list|,
call|(
name|unsigned
name|long
name|long
call|)
argument_list|(
name|ulong_t
argument_list|)
operator|&
name|hw_pair
operator|->
name|txdl_pointer
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|XGE_HAL_FIFO_DUMP_TXD
name|xge_os_printf
argument_list|(
literal|""
name|XGE_OS_LLXFMT
literal|":"
name|XGE_OS_LLXFMT
literal|":"
name|XGE_OS_LLXFMT
literal|":"
name|XGE_OS_LLXFMT
literal|" dma "
name|XGE_OS_LLXFMT
argument_list|,
name|txdp
operator|->
name|control_1
argument_list|,
name|txdp
operator|->
name|control_2
argument_list|,
name|txdp
operator|->
name|buffer_pointer
argument_list|,
name|txdp
operator|->
name|host_control
argument_list|,
name|txdl_priv
operator|->
name|dma_addr
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|fifo
operator|->
name|channel
operator|.
name|stats
operator|.
name|total_posts
operator|++
expr_stmt|;
name|fifo
operator|->
name|channel
operator|.
name|usage_cnt
operator|++
expr_stmt|;
if|if
condition|(
name|fifo
operator|->
name|channel
operator|.
name|stats
operator|.
name|usage_max
operator|<
name|fifo
operator|->
name|channel
operator|.
name|usage_cnt
condition|)
name|fifo
operator|->
name|channel
operator|.
name|stats
operator|.
name|usage_max
operator|=
name|fifo
operator|->
name|channel
operator|.
name|usage_cnt
expr_stmt|;
block|}
end_function

begin_function
name|__HAL_STATIC_FIFO
name|__HAL_INLINE_FIFO
name|void
name|__hal_fifo_txdl_free_many
parameter_list|(
name|xge_hal_channel_h
name|channelh
parameter_list|,
name|xge_hal_fifo_txd_t
modifier|*
name|txdp
parameter_list|,
name|int
name|list_size
parameter_list|,
name|int
name|frags
parameter_list|)
block|{
name|xge_hal_fifo_txdl_priv_t
modifier|*
name|current_txdl_priv
decl_stmt|;
name|xge_hal_fifo_txdl_priv_t
modifier|*
name|next_txdl_priv
decl_stmt|;
name|int
name|invalid_frags
init|=
name|frags
operator|%
name|list_size
decl_stmt|;
if|if
condition|(
name|invalid_frags
condition|)
block|{
name|xge_debug_fifo
argument_list|(
name|XGE_ERR
argument_list|,
literal|"freeing corrupt dtrh %p, fragments %d list size %d"
argument_list|,
name|txdp
argument_list|,
name|frags
argument_list|,
name|list_size
argument_list|)
expr_stmt|;
name|xge_assert
argument_list|(
name|invalid_frags
operator|==
literal|0
argument_list|)
expr_stmt|;
block|}
while|while
condition|(
name|txdp
condition|)
block|{
name|xge_debug_fifo
argument_list|(
name|XGE_TRACE
argument_list|,
literal|"freeing linked dtrh %p, fragments %d list size %d"
argument_list|,
name|txdp
argument_list|,
name|frags
argument_list|,
name|list_size
argument_list|)
expr_stmt|;
name|current_txdl_priv
operator|=
name|__hal_fifo_txdl_priv
argument_list|(
name|txdp
argument_list|)
expr_stmt|;
if|#
directive|if
name|defined
argument_list|(
name|XGE_DEBUG_ASSERT
argument_list|)
operator|&&
name|defined
argument_list|(
name|XGE_OS_MEMORY_CHECK
argument_list|)
name|current_txdl_priv
operator|->
name|allocated
operator|=
literal|0
expr_stmt|;
endif|#
directive|endif
name|__hal_channel_dtr_free
argument_list|(
name|channelh
argument_list|,
name|txdp
argument_list|)
expr_stmt|;
name|next_txdl_priv
operator|=
name|current_txdl_priv
operator|->
name|next_txdl_priv
expr_stmt|;
name|xge_assert
argument_list|(
name|frags
argument_list|)
expr_stmt|;
name|frags
operator|-=
name|list_size
expr_stmt|;
if|if
condition|(
name|next_txdl_priv
condition|)
block|{
name|current_txdl_priv
operator|->
name|next_txdl_priv
operator|=
name|NULL
expr_stmt|;
name|txdp
operator|=
name|next_txdl_priv
operator|->
name|first_txdp
expr_stmt|;
block|}
else|else
block|{
name|xge_debug_fifo
argument_list|(
name|XGE_TRACE
argument_list|,
literal|"freed linked dtrh fragments %d list size %d"
argument_list|,
name|frags
argument_list|,
name|list_size
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
name|xge_assert
argument_list|(
argument|frags ==
literal|0
argument_list|)
block|}
end_function

begin_function
name|__HAL_STATIC_FIFO
name|__HAL_INLINE_FIFO
name|void
name|__hal_fifo_txdl_restore_many
parameter_list|(
name|xge_hal_channel_h
name|channelh
parameter_list|,
name|xge_hal_fifo_txd_t
modifier|*
name|txdp
parameter_list|,
name|int
name|txdl_count
parameter_list|)
block|{
name|xge_hal_fifo_txdl_priv_t
modifier|*
name|current_txdl_priv
decl_stmt|;
name|xge_hal_fifo_txdl_priv_t
modifier|*
name|next_txdl_priv
decl_stmt|;
name|int
name|i
init|=
name|txdl_count
decl_stmt|;
name|xge_assert
argument_list|(
operator|(
operator|(
name|xge_hal_channel_t
operator|*
operator|)
name|channelh
operator|)
operator|->
name|reserve_length
operator|+
name|txdl_count
operator|<=
operator|(
operator|(
name|xge_hal_channel_t
operator|*
operator|)
name|channelh
operator|)
operator|->
name|reserve_initial
argument_list|)
expr_stmt|;
name|current_txdl_priv
operator|=
name|__hal_fifo_txdl_priv
argument_list|(
name|txdp
argument_list|)
expr_stmt|;
do|do
block|{
name|xge_assert
argument_list|(
name|i
argument_list|)
expr_stmt|;
if|#
directive|if
name|defined
argument_list|(
name|XGE_DEBUG_ASSERT
argument_list|)
operator|&&
name|defined
argument_list|(
name|XGE_OS_MEMORY_CHECK
argument_list|)
name|current_txdl_priv
operator|->
name|allocated
operator|=
literal|0
expr_stmt|;
endif|#
directive|endif
name|next_txdl_priv
operator|=
name|current_txdl_priv
operator|->
name|next_txdl_priv
expr_stmt|;
name|txdp
operator|=
name|current_txdl_priv
operator|->
name|first_txdp
expr_stmt|;
name|current_txdl_priv
operator|->
name|next_txdl_priv
operator|=
name|NULL
expr_stmt|;
name|__hal_channel_dtr_restore
argument_list|(
name|channelh
argument_list|,
operator|(
name|xge_hal_dtr_h
operator|)
name|txdp
argument_list|,
operator|--
name|i
argument_list|)
expr_stmt|;
name|xge_debug_fifo
argument_list|(
name|XGE_TRACE
argument_list|,
literal|"dtrh %p restored at offset %d"
argument_list|,
name|txdp
argument_list|,
name|i
argument_list|)
expr_stmt|;
name|current_txdl_priv
operator|=
name|next_txdl_priv
expr_stmt|;
block|}
do|while
condition|(
name|current_txdl_priv
condition|)
do|;
name|__hal_channel_dtr_restore
argument_list|(
name|channelh
argument_list|,
name|NULL
argument_list|,
name|txdl_count
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/**  * xge_hal_fifo_dtr_private - Retrieve per-descriptor private data.  * @channelh: Channel handle.  * @dtrh: Descriptor handle.  *  * Retrieve per-descriptor private data.  * Note that ULD requests per-descriptor space via  * xge_hal_channel_open().  *  * Returns: private ULD data associated with the descriptor.  * Usage: See ex_xmit{} and ex_tx_compl{}.  */
end_comment

begin_function
name|__HAL_STATIC_FIFO
name|__HAL_INLINE_FIFO
name|void
modifier|*
name|xge_hal_fifo_dtr_private
parameter_list|(
name|xge_hal_dtr_h
name|dtrh
parameter_list|)
block|{
name|xge_hal_fifo_txd_t
modifier|*
name|txdp
init|=
operator|(
name|xge_hal_fifo_txd_t
operator|*
operator|)
name|dtrh
decl_stmt|;
return|return
operator|(
operator|(
name|char
operator|*
operator|)
operator|(
name|ulong_t
operator|)
name|txdp
operator|->
name|host_control
operator|)
operator|+
sizeof|sizeof
argument_list|(
name|xge_hal_fifo_txdl_priv_t
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/**  * xge_hal_fifo_dtr_buffer_cnt - Get number of buffers carried by the  * descriptor.  * @dtrh: Descriptor handle.  *  * Returns: Number of buffers stored in the given descriptor. Can be used  * _after_ the descriptor is set up for posting (see  * xge_hal_fifo_dtr_post()) and _before_ it is deallocated (see  * xge_hal_fifo_dtr_free()).  *  */
end_comment

begin_function
name|__HAL_STATIC_FIFO
name|__HAL_INLINE_FIFO
name|int
name|xge_hal_fifo_dtr_buffer_cnt
parameter_list|(
name|xge_hal_dtr_h
name|dtrh
parameter_list|)
block|{
name|xge_hal_fifo_txdl_priv_t
modifier|*
name|txdl_priv
decl_stmt|;
name|txdl_priv
operator|=
name|__hal_fifo_txdl_priv
argument_list|(
name|dtrh
argument_list|)
expr_stmt|;
return|return
name|txdl_priv
operator|->
name|frags
return|;
block|}
end_function

begin_comment
comment|/**  * xge_hal_fifo_dtr_reserve_many- Reserve fifo descriptors which span more  *  than single txdl.  * @channelh: Channel handle.  * @dtrh: Reserved descriptor. On success HAL fills this "out" parameter  *        with a valid handle.  * @frags: minimum number of fragments to be reserved.  *  * Reserve TxDL(s) (that is, fifo descriptor)  * for the subsequent filling-in by upper layerdriver (ULD))  * and posting on the corresponding channel (@channelh)  * via xge_hal_fifo_dtr_post().  *  * Returns: XGE_HAL_OK - success;  * XGE_HAL_INF_OUT_OF_DESCRIPTORS - Currently no descriptors available  *  * See also: xge_hal_fifo_dtr_reserve_sp(), xge_hal_fifo_dtr_free(),  * xge_hal_ring_dtr_reserve(), xge_hal_status_e{}.  * Usage: See ex_xmit{}.  */
end_comment

begin_function
name|__HAL_STATIC_FIFO
name|__HAL_INLINE_FIFO
name|xge_hal_status_e
name|xge_hal_fifo_dtr_reserve_many
parameter_list|(
name|xge_hal_channel_h
name|channelh
parameter_list|,
name|xge_hal_dtr_h
modifier|*
name|dtrh
parameter_list|,
specifier|const
name|int
name|frags
parameter_list|)
block|{
name|xge_hal_status_e
name|status
init|=
name|XGE_HAL_OK
decl_stmt|;
name|int
name|alloc_frags
init|=
literal|0
decl_stmt|,
name|dang_frags
init|=
literal|0
decl_stmt|;
name|xge_hal_fifo_txd_t
modifier|*
name|curr_txdp
init|=
name|NULL
decl_stmt|;
name|xge_hal_fifo_txd_t
modifier|*
name|next_txdp
decl_stmt|;
name|xge_hal_fifo_txdl_priv_t
modifier|*
name|next_txdl_priv
decl_stmt|,
modifier|*
name|curr_txdl_priv
init|=
name|NULL
decl_stmt|;
name|xge_hal_fifo_t
modifier|*
name|fifo
init|=
operator|(
name|xge_hal_fifo_t
operator|*
operator|)
name|channelh
decl_stmt|;
name|int
name|max_frags
init|=
name|fifo
operator|->
name|config
operator|->
name|max_frags
decl_stmt|;
name|xge_hal_dtr_h
name|dang_dtrh
init|=
name|NULL
decl_stmt|;
if|#
directive|if
name|defined
argument_list|(
name|XGE_HAL_TX_MULTI_RESERVE_IRQ
argument_list|)
name|unsigned
name|long
name|flags
init|=
literal|0
decl_stmt|;
endif|#
directive|endif
name|xge_debug_fifo
argument_list|(
name|XGE_TRACE
argument_list|,
literal|"dtr_reserve_many called for frags %d"
argument_list|,
name|frags
argument_list|)
expr_stmt|;
name|xge_assert
argument_list|(
name|frags
operator|<
operator|(
name|fifo
operator|->
name|txdl_per_memblock
operator|*
name|max_frags
operator|)
argument_list|)
expr_stmt|;
if|#
directive|if
name|defined
argument_list|(
name|XGE_HAL_TX_MULTI_RESERVE
argument_list|)
name|xge_os_spin_lock
argument_list|(
operator|&
name|fifo
operator|->
name|channel
operator|.
name|reserve_lock
argument_list|)
expr_stmt|;
elif|#
directive|elif
name|defined
argument_list|(
name|XGE_HAL_TX_MULTI_RESERVE_IRQ
argument_list|)
name|xge_os_spin_lock_irq
argument_list|(
operator|&
name|fifo
operator|->
name|channel
operator|.
name|reserve_lock
argument_list|,
name|flags
argument_list|)
expr_stmt|;
endif|#
directive|endif
while|while
condition|(
name|alloc_frags
operator|<
name|frags
condition|)
block|{
name|status
operator|=
name|__hal_channel_dtr_alloc
argument_list|(
name|channelh
argument_list|,
operator|(
name|xge_hal_dtr_h
operator|*
operator|)
operator|(
name|void
operator|*
operator|)
operator|&
name|next_txdp
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|XGE_HAL_OK
condition|)
block|{
name|xge_debug_fifo
argument_list|(
name|XGE_ERR
argument_list|,
literal|"failed to allocate linked fragments rc %d"
argument_list|,
name|status
argument_list|)
expr_stmt|;
name|xge_assert
argument_list|(
name|status
operator|==
name|XGE_HAL_INF_OUT_OF_DESCRIPTORS
argument_list|)
expr_stmt|;
if|if
condition|(
operator|*
name|dtrh
condition|)
block|{
name|xge_assert
argument_list|(
name|alloc_frags
operator|/
name|max_frags
argument_list|)
expr_stmt|;
name|__hal_fifo_txdl_restore_many
argument_list|(
name|channelh
argument_list|,
operator|(
name|xge_hal_fifo_txd_t
operator|*
operator|)
operator|*
name|dtrh
argument_list|,
name|alloc_frags
operator|/
name|max_frags
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|dang_dtrh
condition|)
block|{
name|xge_assert
argument_list|(
name|dang_frags
operator|/
name|max_frags
argument_list|)
expr_stmt|;
name|__hal_fifo_txdl_restore_many
argument_list|(
name|channelh
argument_list|,
operator|(
name|xge_hal_fifo_txd_t
operator|*
operator|)
name|dang_dtrh
argument_list|,
name|dang_frags
operator|/
name|max_frags
argument_list|)
expr_stmt|;
block|}
break|break;
block|}
name|xge_debug_fifo
argument_list|(
name|XGE_TRACE
argument_list|,
literal|"allocated linked dtrh %p"
literal|" for frags %d"
argument_list|,
name|next_txdp
argument_list|,
name|frags
argument_list|)
expr_stmt|;
name|next_txdl_priv
operator|=
name|__hal_fifo_txdl_priv
argument_list|(
name|next_txdp
argument_list|)
expr_stmt|;
name|xge_assert
argument_list|(
name|next_txdl_priv
argument_list|)
expr_stmt|;
name|xge_assert
argument_list|(
name|next_txdl_priv
operator|->
name|first_txdp
operator|==
name|next_txdp
argument_list|)
expr_stmt|;
name|next_txdl_priv
operator|->
name|dang_txdl
operator|=
name|NULL
expr_stmt|;
name|next_txdl_priv
operator|->
name|dang_frags
operator|=
literal|0
expr_stmt|;
name|next_txdl_priv
operator|->
name|next_txdl_priv
operator|=
name|NULL
expr_stmt|;
if|#
directive|if
name|defined
argument_list|(
name|XGE_OS_MEMORY_CHECK
argument_list|)
name|next_txdl_priv
operator|->
name|allocated
operator|=
literal|1
expr_stmt|;
endif|#
directive|endif
if|if
condition|(
operator|!
name|curr_txdp
operator|||
operator|!
name|curr_txdl_priv
condition|)
block|{
name|curr_txdp
operator|=
name|next_txdp
expr_stmt|;
name|curr_txdl_priv
operator|=
name|next_txdl_priv
expr_stmt|;
operator|*
name|dtrh
operator|=
operator|(
name|xge_hal_dtr_h
operator|)
name|next_txdp
expr_stmt|;
name|alloc_frags
operator|=
name|max_frags
expr_stmt|;
continue|continue;
block|}
if|if
condition|(
name|curr_txdl_priv
operator|->
name|memblock
operator|==
name|next_txdl_priv
operator|->
name|memblock
condition|)
block|{
name|xge_debug_fifo
argument_list|(
name|XGE_TRACE
argument_list|,
literal|"linking dtrh %p, with %p"
argument_list|,
operator|*
name|dtrh
argument_list|,
name|next_txdp
argument_list|)
expr_stmt|;
name|xge_assert
argument_list|(
name|next_txdp
operator|==
name|curr_txdp
operator|+
name|max_frags
argument_list|)
expr_stmt|;
name|alloc_frags
operator|+=
name|max_frags
expr_stmt|;
name|curr_txdl_priv
operator|->
name|next_txdl_priv
operator|=
name|next_txdl_priv
expr_stmt|;
block|}
else|else
block|{
name|xge_assert
argument_list|(
operator|*
name|dtrh
argument_list|)
expr_stmt|;
name|xge_assert
argument_list|(
name|dang_dtrh
operator|==
name|NULL
argument_list|)
expr_stmt|;
name|dang_dtrh
operator|=
operator|*
name|dtrh
expr_stmt|;
name|dang_frags
operator|=
name|alloc_frags
expr_stmt|;
name|xge_debug_fifo
argument_list|(
name|XGE_TRACE
argument_list|,
literal|"dangling dtrh %p, linked with dtrh %p"
argument_list|,
operator|*
name|dtrh
argument_list|,
name|next_txdp
argument_list|)
expr_stmt|;
name|next_txdl_priv
operator|->
name|dang_txdl
operator|=
operator|(
name|xge_hal_fifo_txd_t
operator|*
operator|)
operator|*
name|dtrh
expr_stmt|;
name|next_txdl_priv
operator|->
name|dang_frags
operator|=
name|alloc_frags
expr_stmt|;
name|alloc_frags
operator|=
name|max_frags
expr_stmt|;
operator|*
name|dtrh
operator|=
name|next_txdp
expr_stmt|;
block|}
name|curr_txdp
operator|=
name|next_txdp
expr_stmt|;
name|curr_txdl_priv
operator|=
name|next_txdl_priv
expr_stmt|;
block|}
if|#
directive|if
name|defined
argument_list|(
name|XGE_HAL_TX_MULTI_RESERVE
argument_list|)
name|xge_os_spin_unlock
argument_list|(
operator|&
name|fifo
operator|->
name|channel
operator|.
name|reserve_lock
argument_list|)
expr_stmt|;
elif|#
directive|elif
name|defined
argument_list|(
name|XGE_HAL_TX_MULTI_RESERVE_IRQ
argument_list|)
name|xge_os_spin_unlock_irq
argument_list|(
operator|&
name|fifo
operator|->
name|channel
operator|.
name|reserve_lock
argument_list|,
name|flags
argument_list|)
expr_stmt|;
endif|#
directive|endif
if|if
condition|(
name|status
operator|==
name|XGE_HAL_OK
condition|)
block|{
name|xge_hal_fifo_txdl_priv_t
modifier|*
name|txdl_priv
decl_stmt|;
name|xge_hal_fifo_txd_t
modifier|*
name|txdp
init|=
operator|(
name|xge_hal_fifo_txd_t
operator|*
operator|)
operator|*
name|dtrh
decl_stmt|;
name|xge_hal_stats_channel_info_t
modifier|*
name|statsp
init|=
operator|&
name|fifo
operator|->
name|channel
operator|.
name|stats
decl_stmt|;
name|txdl_priv
operator|=
name|__hal_fifo_txdl_priv
argument_list|(
name|txdp
argument_list|)
expr_stmt|;
comment|/* reset the TxDL's private */
name|txdl_priv
operator|->
name|align_dma_offset
operator|=
literal|0
expr_stmt|;
name|txdl_priv
operator|->
name|align_vaddr_start
operator|=
name|txdl_priv
operator|->
name|align_vaddr
expr_stmt|;
name|txdl_priv
operator|->
name|align_used_frags
operator|=
literal|0
expr_stmt|;
name|txdl_priv
operator|->
name|frags
operator|=
literal|0
expr_stmt|;
name|txdl_priv
operator|->
name|bytes_sent
operator|=
literal|0
expr_stmt|;
name|txdl_priv
operator|->
name|alloc_frags
operator|=
name|alloc_frags
expr_stmt|;
comment|/* reset TxD0 */
name|txdp
operator|->
name|control_1
operator|=
name|txdp
operator|->
name|control_2
operator|=
literal|0
expr_stmt|;
if|#
directive|if
name|defined
argument_list|(
name|XGE_OS_MEMORY_CHECK
argument_list|)
name|txdl_priv
operator|->
name|allocated
operator|=
literal|1
expr_stmt|;
endif|#
directive|endif
comment|/* update statistics */
name|statsp
operator|->
name|total_posts_dtrs_many
operator|++
expr_stmt|;
name|statsp
operator|->
name|total_posts_frags_many
operator|+=
name|txdl_priv
operator|->
name|alloc_frags
expr_stmt|;
if|if
condition|(
name|txdl_priv
operator|->
name|dang_frags
condition|)
block|{
name|statsp
operator|->
name|total_posts_dang_dtrs
operator|++
expr_stmt|;
name|statsp
operator|->
name|total_posts_dang_frags
operator|+=
name|txdl_priv
operator|->
name|dang_frags
expr_stmt|;
block|}
block|}
return|return
name|status
return|;
block|}
end_function

begin_comment
comment|/**  * xge_hal_fifo_dtr_reserve - Reserve fifo descriptor.  * @channelh: Channel handle.  * @dtrh: Reserved descriptor. On success HAL fills this "out" parameter  *        with a valid handle.  *  * Reserve a single TxDL (that is, fifo descriptor)  * for the subsequent filling-in by upper layerdriver (ULD))  * and posting on the corresponding channel (@channelh)  * via xge_hal_fifo_dtr_post().  *  * Note: it is the responsibility of ULD to reserve multiple descriptors  * for lengthy (e.g., LSO) transmit operation. A single fifo descriptor  * carries up to configured number (fifo.max_frags) of contiguous buffers.  *  * Returns: XGE_HAL_OK - success;  * XGE_HAL_INF_OUT_OF_DESCRIPTORS - Currently no descriptors available  *  * See also: xge_hal_fifo_dtr_reserve_sp(), xge_hal_fifo_dtr_free(),  * xge_hal_ring_dtr_reserve(), xge_hal_status_e{}.  * Usage: See ex_xmit{}.  */
end_comment

begin_function
name|__HAL_STATIC_FIFO
name|__HAL_INLINE_FIFO
name|xge_hal_status_e
name|xge_hal_fifo_dtr_reserve
parameter_list|(
name|xge_hal_channel_h
name|channelh
parameter_list|,
name|xge_hal_dtr_h
modifier|*
name|dtrh
parameter_list|)
block|{
name|xge_hal_status_e
name|status
decl_stmt|;
if|#
directive|if
name|defined
argument_list|(
name|XGE_HAL_TX_MULTI_RESERVE_IRQ
argument_list|)
name|unsigned
name|long
name|flags
init|=
literal|0
decl_stmt|;
endif|#
directive|endif
if|#
directive|if
name|defined
argument_list|(
name|XGE_HAL_TX_MULTI_RESERVE
argument_list|)
name|xge_os_spin_lock
argument_list|(
operator|&
operator|(
operator|(
name|xge_hal_channel_t
operator|*
operator|)
name|channelh
operator|)
operator|->
name|reserve_lock
argument_list|)
expr_stmt|;
elif|#
directive|elif
name|defined
argument_list|(
name|XGE_HAL_TX_MULTI_RESERVE_IRQ
argument_list|)
name|xge_os_spin_lock_irq
argument_list|(
operator|&
operator|(
operator|(
name|xge_hal_channel_t
operator|*
operator|)
name|channelh
operator|)
operator|->
name|reserve_lock
argument_list|,
name|flags
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|status
operator|=
name|__hal_channel_dtr_alloc
argument_list|(
name|channelh
argument_list|,
name|dtrh
argument_list|)
expr_stmt|;
if|#
directive|if
name|defined
argument_list|(
name|XGE_HAL_TX_MULTI_RESERVE
argument_list|)
name|xge_os_spin_unlock
argument_list|(
operator|&
operator|(
operator|(
name|xge_hal_channel_t
operator|*
operator|)
name|channelh
operator|)
operator|->
name|reserve_lock
argument_list|)
expr_stmt|;
elif|#
directive|elif
name|defined
argument_list|(
name|XGE_HAL_TX_MULTI_RESERVE_IRQ
argument_list|)
name|xge_os_spin_unlock_irq
argument_list|(
operator|&
operator|(
operator|(
name|xge_hal_channel_t
operator|*
operator|)
name|channelh
operator|)
operator|->
name|reserve_lock
argument_list|,
name|flags
argument_list|)
expr_stmt|;
endif|#
directive|endif
if|if
condition|(
name|status
operator|==
name|XGE_HAL_OK
condition|)
block|{
name|xge_hal_fifo_txd_t
modifier|*
name|txdp
init|=
operator|(
name|xge_hal_fifo_txd_t
operator|*
operator|)
operator|*
name|dtrh
decl_stmt|;
name|xge_hal_fifo_txdl_priv_t
modifier|*
name|txdl_priv
decl_stmt|;
name|txdl_priv
operator|=
name|__hal_fifo_txdl_priv
argument_list|(
name|txdp
argument_list|)
expr_stmt|;
comment|/* reset the TxDL's private */
name|txdl_priv
operator|->
name|align_dma_offset
operator|=
literal|0
expr_stmt|;
name|txdl_priv
operator|->
name|align_vaddr_start
operator|=
name|txdl_priv
operator|->
name|align_vaddr
expr_stmt|;
name|txdl_priv
operator|->
name|align_used_frags
operator|=
literal|0
expr_stmt|;
name|txdl_priv
operator|->
name|frags
operator|=
literal|0
expr_stmt|;
name|txdl_priv
operator|->
name|alloc_frags
operator|=
operator|(
operator|(
name|xge_hal_fifo_t
operator|*
operator|)
name|channelh
operator|)
operator|->
name|config
operator|->
name|max_frags
expr_stmt|;
name|txdl_priv
operator|->
name|dang_txdl
operator|=
name|NULL
expr_stmt|;
name|txdl_priv
operator|->
name|dang_frags
operator|=
literal|0
expr_stmt|;
name|txdl_priv
operator|->
name|next_txdl_priv
operator|=
name|NULL
expr_stmt|;
name|txdl_priv
operator|->
name|bytes_sent
operator|=
literal|0
expr_stmt|;
comment|/* reset TxD0 */
name|txdp
operator|->
name|control_1
operator|=
name|txdp
operator|->
name|control_2
operator|=
literal|0
expr_stmt|;
if|#
directive|if
name|defined
argument_list|(
name|XGE_OS_MEMORY_CHECK
argument_list|)
name|txdl_priv
operator|->
name|allocated
operator|=
literal|1
expr_stmt|;
endif|#
directive|endif
block|}
return|return
name|status
return|;
block|}
end_function

begin_comment
comment|/**  * xge_hal_fifo_dtr_reserve_sp - Reserve fifo descriptor and store it in  * the ULD-provided "scratch" memory.  * @channelh: Channel handle.  * @dtr_sp_size: Size of the %dtr_sp "scratch pad" that HAL can use for TxDL.  * @dtr_sp: "Scratch pad" supplied by upper-layer driver (ULD).  *  * Reserve TxDL and fill-in ULD supplied "scratch pad". The difference  * between this API and xge_hal_fifo_dtr_reserve() is (possibly) -  * performance.  *  * If upper-layer uses ULP-defined commands, and if those commands have enough  * space for HAL/Xframe descriptors - tnan it is better (read: faster) to fit  * all the per-command information into one command, which is typically  * one contiguous block.  *  * Note: Unlike xge_hal_fifo_dtr_reserve(), this function can be used to  * allocate a single descriptor for transmit operation.  *  * See also: xge_hal_fifo_dtr_reserve(), xge_hal_fifo_dtr_free(),  * xge_hal_ring_dtr_reserve(), xge_hal_status_e{}.  */
end_comment

begin_function
name|__HAL_STATIC_FIFO
name|__HAL_INLINE_FIFO
name|xge_hal_status_e
name|xge_hal_fifo_dtr_reserve_sp
parameter_list|(
name|xge_hal_channel_h
name|channelh
parameter_list|,
name|int
name|dtr_sp_size
parameter_list|,
name|xge_hal_dtr_h
name|dtr_sp
parameter_list|)
block|{
comment|/* FIXME: implement */
return|return
name|XGE_HAL_OK
return|;
block|}
end_function

begin_comment
comment|/**  * xge_hal_fifo_dtr_post - Post descriptor on the fifo channel.  * @channelh: Channel handle.  * @dtrh: Descriptor obtained via xge_hal_fifo_dtr_reserve() or  * xge_hal_fifo_dtr_reserve_sp()  * @frags: Number of contiguous buffers that are part of a single  *         transmit operation.  *  * Post descriptor on the 'fifo' type channel for transmission.  * Prior to posting the descriptor should be filled in accordance with  * Host/Xframe interface specification for a given service (LL, etc.).  *  * See also: xge_hal_fifo_dtr_post_many(), xge_hal_ring_dtr_post().  * Usage: See ex_xmit{}.  */
end_comment

begin_function
name|__HAL_STATIC_FIFO
name|__HAL_INLINE_FIFO
name|void
name|xge_hal_fifo_dtr_post
parameter_list|(
name|xge_hal_channel_h
name|channelh
parameter_list|,
name|xge_hal_dtr_h
name|dtrh
parameter_list|)
block|{
name|xge_hal_fifo_t
modifier|*
name|fifo
init|=
operator|(
name|xge_hal_fifo_t
operator|*
operator|)
name|channelh
decl_stmt|;
name|xge_hal_fifo_txdl_priv_t
modifier|*
name|txdl_priv
decl_stmt|;
name|xge_hal_fifo_txd_t
modifier|*
name|txdp_last
decl_stmt|;
name|xge_hal_fifo_txd_t
modifier|*
name|txdp_first
decl_stmt|;
if|#
directive|if
name|defined
argument_list|(
name|XGE_HAL_TX_MULTI_POST_IRQ
argument_list|)
name|unsigned
name|long
name|flags
init|=
literal|0
decl_stmt|;
endif|#
directive|endif
name|txdl_priv
operator|=
name|__hal_fifo_txdl_priv
argument_list|(
name|dtrh
argument_list|)
expr_stmt|;
name|txdp_first
operator|=
operator|(
name|xge_hal_fifo_txd_t
operator|*
operator|)
name|dtrh
expr_stmt|;
name|txdp_first
operator|->
name|control_1
operator||=
name|XGE_HAL_TXD_GATHER_CODE_FIRST
expr_stmt|;
name|txdp_first
operator|->
name|control_2
operator||=
name|fifo
operator|->
name|interrupt_type
expr_stmt|;
name|txdp_last
operator|=
operator|(
name|xge_hal_fifo_txd_t
operator|*
operator|)
name|dtrh
operator|+
operator|(
name|txdl_priv
operator|->
name|frags
operator|-
literal|1
operator|)
expr_stmt|;
name|txdp_last
operator|->
name|control_1
operator||=
name|XGE_HAL_TXD_GATHER_CODE_LAST
expr_stmt|;
if|#
directive|if
name|defined
argument_list|(
name|XGE_HAL_TX_MULTI_POST
argument_list|)
name|xge_os_spin_lock
argument_list|(
name|fifo
operator|->
name|post_lock_ptr
argument_list|)
expr_stmt|;
elif|#
directive|elif
name|defined
argument_list|(
name|XGE_HAL_TX_MULTI_POST_IRQ
argument_list|)
name|xge_os_spin_lock_irq
argument_list|(
name|fifo
operator|->
name|post_lock_ptr
argument_list|,
name|flags
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|__hal_fifo_dtr_post_single
argument_list|(
name|channelh
argument_list|,
name|dtrh
argument_list|,
call|(
name|u64
call|)
argument_list|(
name|XGE_HAL_TX_FIFO_FIRST_LIST
operator||
name|XGE_HAL_TX_FIFO_LAST_LIST
argument_list|)
argument_list|)
expr_stmt|;
if|#
directive|if
name|defined
argument_list|(
name|XGE_HAL_TX_MULTI_POST
argument_list|)
name|xge_os_spin_unlock
argument_list|(
name|fifo
operator|->
name|post_lock_ptr
argument_list|)
expr_stmt|;
elif|#
directive|elif
name|defined
argument_list|(
name|XGE_HAL_TX_MULTI_POST_IRQ
argument_list|)
name|xge_os_spin_unlock_irq
argument_list|(
name|fifo
operator|->
name|post_lock_ptr
argument_list|,
name|flags
argument_list|)
expr_stmt|;
endif|#
directive|endif
block|}
end_function

begin_comment
comment|/**  * xge_hal_fifo_dtr_post_many - Post multiple descriptors on fifo  * channel.  * @channelh: Channel to post descriptor.  * @num: Number of descriptors (i.e., fifo TxDLs) in the %dtrs[].  * @dtrs: Descriptors obtained via xge_hal_fifo_dtr_reserve().  * @frags_arr: Number of fragments carried @dtrs descriptors.  * Note that frag_arr[i] corresponds to descriptor dtrs[i].  *  * Post multi-descriptor on the fifo channel. The operation is atomic:  * all descriptrs are posted on the channel "back-to-back' without  * letting other posts (possibly driven by multiple transmitting threads)  * to interleave.  *  * See also: xge_hal_fifo_dtr_post(), xge_hal_ring_dtr_post().  */
end_comment

begin_function
name|__HAL_STATIC_FIFO
name|__HAL_INLINE_FIFO
name|void
name|xge_hal_fifo_dtr_post_many
parameter_list|(
name|xge_hal_channel_h
name|channelh
parameter_list|,
name|int
name|num
parameter_list|,
name|xge_hal_dtr_h
name|dtrs
index|[]
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
name|xge_hal_fifo_t
modifier|*
name|fifo
init|=
operator|(
name|xge_hal_fifo_t
operator|*
operator|)
name|channelh
decl_stmt|;
name|xge_hal_fifo_txd_t
modifier|*
name|txdp_last
decl_stmt|;
name|xge_hal_fifo_txd_t
modifier|*
name|txdp_first
decl_stmt|;
name|xge_hal_fifo_txdl_priv_t
modifier|*
name|txdl_priv_last
decl_stmt|;
if|#
directive|if
name|defined
argument_list|(
name|XGE_HAL_TX_MULTI_POST_IRQ
argument_list|)
name|unsigned
name|long
name|flags
init|=
literal|0
decl_stmt|;
endif|#
directive|endif
name|xge_assert
argument_list|(
name|num
operator|>
literal|1
argument_list|)
expr_stmt|;
name|txdp_first
operator|=
operator|(
name|xge_hal_fifo_txd_t
operator|*
operator|)
name|dtrs
index|[
literal|0
index|]
expr_stmt|;
name|txdp_first
operator|->
name|control_1
operator||=
name|XGE_HAL_TXD_GATHER_CODE_FIRST
expr_stmt|;
name|txdp_first
operator|->
name|control_2
operator||=
name|fifo
operator|->
name|interrupt_type
expr_stmt|;
name|txdl_priv_last
operator|=
name|__hal_fifo_txdl_priv
argument_list|(
name|dtrs
index|[
name|num
operator|-
literal|1
index|]
argument_list|)
expr_stmt|;
name|txdp_last
operator|=
operator|(
name|xge_hal_fifo_txd_t
operator|*
operator|)
name|dtrs
index|[
name|num
operator|-
literal|1
index|]
operator|+
operator|(
name|txdl_priv_last
operator|->
name|frags
operator|-
literal|1
operator|)
expr_stmt|;
name|txdp_last
operator|->
name|control_1
operator||=
name|XGE_HAL_TXD_GATHER_CODE_LAST
expr_stmt|;
if|#
directive|if
name|defined
argument_list|(
name|XGE_HAL_TX_MULTI_POST
argument_list|)
name|xge_os_spin_lock
argument_list|(
operator|&
operator|(
operator|(
name|xge_hal_channel_t
operator|*
operator|)
name|channelh
operator|)
operator|->
name|post_lock
argument_list|)
expr_stmt|;
elif|#
directive|elif
name|defined
argument_list|(
name|XGE_HAL_TX_MULTI_POST_IRQ
argument_list|)
name|xge_os_spin_lock_irq
argument_list|(
operator|&
operator|(
operator|(
name|xge_hal_channel_t
operator|*
operator|)
name|channelh
operator|)
operator|->
name|post_lock
argument_list|,
name|flags
argument_list|)
expr_stmt|;
endif|#
directive|endif
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|num
condition|;
name|i
operator|++
control|)
block|{
name|xge_hal_fifo_txdl_priv_t
modifier|*
name|txdl_priv
decl_stmt|;
name|u64
name|val64
decl_stmt|;
name|xge_hal_dtr_h
name|dtrh
init|=
name|dtrs
index|[
name|i
index|]
decl_stmt|;
name|txdl_priv
operator|=
name|__hal_fifo_txdl_priv
argument_list|(
name|dtrh
argument_list|)
expr_stmt|;
name|txdl_priv
operator|=
name|txdl_priv
expr_stmt|;
comment|/* Cheat lint */
name|val64
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|i
operator|==
literal|0
condition|)
block|{
name|val64
operator||=
name|XGE_HAL_TX_FIFO_FIRST_LIST
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|i
operator|==
name|num
operator|-
literal|1
condition|)
block|{
name|val64
operator||=
name|XGE_HAL_TX_FIFO_LAST_LIST
expr_stmt|;
block|}
name|val64
operator||=
name|XGE_HAL_TX_FIFO_SPECIAL_FUNC
expr_stmt|;
name|__hal_fifo_dtr_post_single
argument_list|(
name|channelh
argument_list|,
name|dtrh
argument_list|,
name|val64
argument_list|)
expr_stmt|;
block|}
if|#
directive|if
name|defined
argument_list|(
name|XGE_HAL_TX_MULTI_POST
argument_list|)
name|xge_os_spin_unlock
argument_list|(
operator|&
operator|(
operator|(
name|xge_hal_channel_t
operator|*
operator|)
name|channelh
operator|)
operator|->
name|post_lock
argument_list|)
expr_stmt|;
elif|#
directive|elif
name|defined
argument_list|(
name|XGE_HAL_TX_MULTI_POST_IRQ
argument_list|)
name|xge_os_spin_unlock_irq
argument_list|(
operator|&
operator|(
operator|(
name|xge_hal_channel_t
operator|*
operator|)
name|channelh
operator|)
operator|->
name|post_lock
argument_list|,
name|flags
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|fifo
operator|->
name|channel
operator|.
name|stats
operator|.
name|total_posts_many
operator|++
expr_stmt|;
block|}
end_function

begin_comment
comment|/**  * xge_hal_fifo_dtr_next_completed - Retrieve next completed descriptor.  * @channelh: Channel handle.  * @dtrh: Descriptor handle. Returned by HAL.  * @t_code: Transfer code, as per Xframe User Guide,  *          Transmit Descriptor Format.  *          Returned by HAL.  *  * Retrieve the _next_ completed descriptor.  * HAL uses channel callback (*xge_hal_channel_callback_f) to notifiy  * upper-layer driver (ULD) of new completed descriptors. After that  * the ULD can use xge_hal_fifo_dtr_next_completed to retrieve the rest  * completions (the very first completion is passed by HAL via  * xge_hal_channel_callback_f).  *  * Implementation-wise, the upper-layer driver is free to call  * xge_hal_fifo_dtr_next_completed either immediately from inside the  * channel callback, or in a deferred fashion and separate (from HAL)  * context.  *  * Non-zero @t_code means failure to process the descriptor.  * The failure could happen, for instance, when the link is  * down, in which case Xframe completes the descriptor because it  * is not able to send the data out.  *  * For details please refer to Xframe User Guide.  *  * Returns: XGE_HAL_OK - success.  * XGE_HAL_INF_NO_MORE_COMPLETED_DESCRIPTORS - No completed descriptors  * are currently available for processing.  *  * See also: xge_hal_channel_callback_f{},  * xge_hal_ring_dtr_next_completed().  * Usage: See ex_tx_compl{}.  */
end_comment

begin_function
name|__HAL_STATIC_FIFO
name|__HAL_INLINE_FIFO
name|xge_hal_status_e
name|xge_hal_fifo_dtr_next_completed
parameter_list|(
name|xge_hal_channel_h
name|channelh
parameter_list|,
name|xge_hal_dtr_h
modifier|*
name|dtrh
parameter_list|,
name|u8
modifier|*
name|t_code
parameter_list|)
block|{
name|xge_hal_fifo_txd_t
modifier|*
name|txdp
decl_stmt|;
name|xge_hal_fifo_t
modifier|*
name|fifo
init|=
operator|(
name|xge_hal_fifo_t
operator|*
operator|)
name|channelh
decl_stmt|;
if|#
directive|if
name|defined
argument_list|(
name|XGE_OS_DMA_REQUIRES_SYNC
argument_list|)
operator|&&
name|defined
argument_list|(
name|XGE_HAL_DMA_DTR_STREAMING
argument_list|)
name|xge_hal_fifo_txdl_priv_t
modifier|*
name|txdl_priv
decl_stmt|;
endif|#
directive|endif
name|__hal_channel_dtr_try_complete
argument_list|(
name|channelh
argument_list|,
name|dtrh
argument_list|)
expr_stmt|;
name|txdp
operator|=
operator|(
name|xge_hal_fifo_txd_t
operator|*
operator|)
operator|*
name|dtrh
expr_stmt|;
if|if
condition|(
name|txdp
operator|==
name|NULL
condition|)
block|{
return|return
name|XGE_HAL_INF_NO_MORE_COMPLETED_DESCRIPTORS
return|;
block|}
if|#
directive|if
name|defined
argument_list|(
name|XGE_OS_DMA_REQUIRES_SYNC
argument_list|)
operator|&&
name|defined
argument_list|(
name|XGE_HAL_DMA_DTR_STREAMING
argument_list|)
name|txdl_priv
operator|=
name|__hal_fifo_txdl_priv
argument_list|(
name|txdp
argument_list|)
expr_stmt|;
comment|/* sync TxDL to read the ownership 	 * 	 * Note: 16bytes means Control_1& Control_2 */
name|xge_os_dma_sync
argument_list|(
name|fifo
operator|->
name|channel
operator|.
name|pdev
argument_list|,
name|txdl_priv
operator|->
name|dma_handle
argument_list|,
name|txdl_priv
operator|->
name|dma_addr
argument_list|,
name|txdl_priv
operator|->
name|dma_offset
argument_list|,
literal|16
argument_list|,
name|XGE_OS_DMA_DIR_FROMDEVICE
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* check whether host owns it */
if|if
condition|(
operator|!
operator|(
name|txdp
operator|->
name|control_1
operator|&
name|XGE_HAL_TXD_LIST_OWN_XENA
operator|)
condition|)
block|{
name|xge_assert
argument_list|(
name|txdp
operator|->
name|host_control
operator|!=
literal|0
argument_list|)
expr_stmt|;
name|__hal_channel_dtr_complete
argument_list|(
name|channelh
argument_list|)
expr_stmt|;
operator|*
name|t_code
operator|=
operator|(
name|u8
operator|)
name|XGE_HAL_GET_TXD_T_CODE
argument_list|(
name|txdp
operator|->
name|control_1
argument_list|)
expr_stmt|;
comment|/* see XGE_HAL_SET_TXD_T_CODE() above.. */
name|xge_assert
argument_list|(
operator|*
name|t_code
operator|!=
name|XGE_HAL_TXD_T_CODE_UNUSED_5
argument_list|)
expr_stmt|;
if|if
condition|(
name|fifo
operator|->
name|channel
operator|.
name|usage_cnt
operator|>
literal|0
condition|)
name|fifo
operator|->
name|channel
operator|.
name|usage_cnt
operator|--
expr_stmt|;
return|return
name|XGE_HAL_OK
return|;
block|}
comment|/* no more completions */
operator|*
name|dtrh
operator|=
literal|0
expr_stmt|;
return|return
name|XGE_HAL_INF_NO_MORE_COMPLETED_DESCRIPTORS
return|;
block|}
end_function

begin_comment
comment|/**  * xge_hal_fifo_dtr_free - Free descriptor.  * @channelh: Channel handle.  * @dtr: Descriptor handle.  *  * Free the reserved descriptor. This operation is "symmetrical" to  * xge_hal_fifo_dtr_reserve or xge_hal_fifo_dtr_reserve_sp.  * The "free-ing" completes the descriptor's lifecycle.  *  * After free-ing (see xge_hal_fifo_dtr_free()) the descriptor again can  * be:  *  * - reserved (xge_hal_fifo_dtr_reserve);  *  * - posted (xge_hal_fifo_dtr_post);  *  * - completed (xge_hal_fifo_dtr_next_completed);  *  * - and recycled again (xge_hal_fifo_dtr_free).  *  * For alternative state transitions and more details please refer to  * the design doc.  *  * See also: xge_hal_ring_dtr_free(), xge_hal_fifo_dtr_reserve().  * Usage: See ex_tx_compl{}.  */
end_comment

begin_function
name|__HAL_STATIC_FIFO
name|__HAL_INLINE_FIFO
name|void
name|xge_hal_fifo_dtr_free
parameter_list|(
name|xge_hal_channel_h
name|channelh
parameter_list|,
name|xge_hal_dtr_h
name|dtr
parameter_list|)
block|{
if|#
directive|if
name|defined
argument_list|(
name|XGE_HAL_TX_MULTI_FREE_IRQ
argument_list|)
name|unsigned
name|long
name|flags
init|=
literal|0
decl_stmt|;
endif|#
directive|endif
name|xge_hal_fifo_txdl_priv_t
modifier|*
name|txdl_priv
init|=
name|__hal_fifo_txdl_priv
argument_list|(
operator|(
name|xge_hal_fifo_txd_t
operator|*
operator|)
name|dtr
argument_list|)
decl_stmt|;
name|int
name|max_frags
init|=
operator|(
operator|(
name|xge_hal_fifo_t
operator|*
operator|)
name|channelh
operator|)
operator|->
name|config
operator|->
name|max_frags
decl_stmt|;
if|#
directive|if
name|defined
argument_list|(
name|XGE_HAL_TX_MULTI_FREE
argument_list|)
name|xge_os_spin_lock
argument_list|(
operator|&
operator|(
operator|(
name|xge_hal_channel_t
operator|*
operator|)
name|channelh
operator|)
operator|->
name|free_lock
argument_list|)
expr_stmt|;
elif|#
directive|elif
name|defined
argument_list|(
name|XGE_HAL_TX_MULTI_FREE_IRQ
argument_list|)
name|xge_os_spin_lock_irq
argument_list|(
operator|&
operator|(
operator|(
name|xge_hal_channel_t
operator|*
operator|)
name|channelh
operator|)
operator|->
name|free_lock
argument_list|,
name|flags
argument_list|)
expr_stmt|;
endif|#
directive|endif
if|if
condition|(
name|txdl_priv
operator|->
name|alloc_frags
operator|>
name|max_frags
condition|)
block|{
name|xge_hal_fifo_txd_t
modifier|*
name|dang_txdp
init|=
operator|(
name|xge_hal_fifo_txd_t
operator|*
operator|)
name|txdl_priv
operator|->
name|dang_txdl
decl_stmt|;
name|int
name|dang_frags
init|=
name|txdl_priv
operator|->
name|dang_frags
decl_stmt|;
name|int
name|alloc_frags
init|=
name|txdl_priv
operator|->
name|alloc_frags
decl_stmt|;
name|txdl_priv
operator|->
name|dang_txdl
operator|=
name|NULL
expr_stmt|;
name|txdl_priv
operator|->
name|dang_frags
operator|=
literal|0
expr_stmt|;
name|txdl_priv
operator|->
name|alloc_frags
operator|=
literal|0
expr_stmt|;
comment|/* dtrh must have a linked list of dtrh */
name|xge_assert
argument_list|(
name|txdl_priv
operator|->
name|next_txdl_priv
argument_list|)
expr_stmt|;
comment|/* free any dangling dtrh first */
if|if
condition|(
name|dang_txdp
condition|)
block|{
name|xge_debug_fifo
argument_list|(
name|XGE_TRACE
argument_list|,
literal|"freeing dangled dtrh %p for %d fragments"
argument_list|,
name|dang_txdp
argument_list|,
name|dang_frags
argument_list|)
expr_stmt|;
name|__hal_fifo_txdl_free_many
argument_list|(
name|channelh
argument_list|,
name|dang_txdp
argument_list|,
name|max_frags
argument_list|,
name|dang_frags
argument_list|)
expr_stmt|;
block|}
comment|/* now free the reserved dtrh list */
name|xge_debug_fifo
argument_list|(
name|XGE_TRACE
argument_list|,
literal|"freeing dtrh %p list of %d fragments"
argument_list|,
name|dtr
argument_list|,
name|alloc_frags
argument_list|)
expr_stmt|;
name|__hal_fifo_txdl_free_many
argument_list|(
name|channelh
argument_list|,
operator|(
name|xge_hal_fifo_txd_t
operator|*
operator|)
name|dtr
argument_list|,
name|max_frags
argument_list|,
name|alloc_frags
argument_list|)
expr_stmt|;
block|}
else|else
name|__hal_channel_dtr_free
argument_list|(
name|channelh
argument_list|,
name|dtr
argument_list|)
expr_stmt|;
operator|(
operator|(
name|xge_hal_channel_t
operator|*
operator|)
name|channelh
operator|)
operator|->
name|poll_bytes
operator|+=
name|txdl_priv
operator|->
name|bytes_sent
expr_stmt|;
if|#
directive|if
name|defined
argument_list|(
name|XGE_DEBUG_ASSERT
argument_list|)
operator|&&
name|defined
argument_list|(
name|XGE_OS_MEMORY_CHECK
argument_list|)
name|__hal_fifo_txdl_priv
argument_list|(
name|dtr
argument_list|)
operator|->
name|allocated
operator|=
literal|0
expr_stmt|;
endif|#
directive|endif
if|#
directive|if
name|defined
argument_list|(
name|XGE_HAL_TX_MULTI_FREE
argument_list|)
name|xge_os_spin_unlock
argument_list|(
operator|&
operator|(
operator|(
name|xge_hal_channel_t
operator|*
operator|)
name|channelh
operator|)
operator|->
name|free_lock
argument_list|)
expr_stmt|;
elif|#
directive|elif
name|defined
argument_list|(
name|XGE_HAL_TX_MULTI_FREE_IRQ
argument_list|)
name|xge_os_spin_unlock_irq
argument_list|(
operator|&
operator|(
operator|(
name|xge_hal_channel_t
operator|*
operator|)
name|channelh
operator|)
operator|->
name|free_lock
argument_list|,
name|flags
argument_list|)
expr_stmt|;
endif|#
directive|endif
block|}
end_function

begin_comment
comment|/**  * xge_hal_fifo_dtr_buffer_set_aligned - Align transmit buffer and fill  * in fifo descriptor.  * @channelh: Channel handle.  * @dtrh: Descriptor handle.  * @frag_idx: Index of the data buffer in the caller's scatter-gather list√°  *            (of buffers).  * @vaddr: Virtual address of the data buffer.  * @dma_pointer: DMA address of the data buffer referenced by @frag_idx.  * @size: Size of the data buffer (in bytes).  * @misaligned_size: Size (in bytes) of the misaligned portion of the  * data buffer. Calculated by the caller, based on the platform/OS/other  * specific criteria, which is outside of HAL's domain. See notes below.  *  * This API is part of the transmit descriptor preparation for posting  * (via xge_hal_fifo_dtr_post()). The related "preparation" APIs include  * xge_hal_fifo_dtr_mss_set() and xge_hal_fifo_dtr_cksum_set_bits().  * All three APIs fill in the fields of the fifo descriptor,  * in accordance with the Xframe specification.  * On the PCI-X based systems aligning transmit data typically provides better  * transmit performance. The typical alignment granularity: L2 cacheline size.  * However, HAL does not make assumptions in terms of the alignment granularity;  * this is specified via additional @misaligned_size parameter described above.  * Prior to calling xge_hal_fifo_dtr_buffer_set_aligned(),  * ULD is supposed to check alignment of a given fragment/buffer. For this HAL  * provides a separate xge_hal_check_alignment() API sufficient to cover  * most (but not all) possible alignment criteria.  * If the buffer appears to be aligned, the ULD calls  * xge_hal_fifo_dtr_buffer_set().  * Otherwise, ULD calls xge_hal_fifo_dtr_buffer_set_aligned().  *  * Note; This API is a "superset" of xge_hal_fifo_dtr_buffer_set(). In  * addition to filling in the specified descriptor it aligns transmit data on  * the specified boundary.  * Note: Decision on whether to align or not to align a given contiguous  * transmit buffer is outside of HAL's domain. To this end ULD can use any  * programmable criteria, which can help to 1) boost transmit performance,  * and/or 2) provide a workaround for PCI bridge bugs, if any.  *  * See also: xge_hal_fifo_dtr_buffer_set(),  * xge_hal_check_alignment().  *  * See also: xge_hal_fifo_dtr_reserve(), xge_hal_fifo_dtr_post(),  * xge_hal_fifo_dtr_mss_set(), xge_hal_fifo_dtr_cksum_set_bits()  */
end_comment

begin_function
name|__HAL_STATIC_FIFO
name|__HAL_INLINE_FIFO
name|xge_hal_status_e
name|xge_hal_fifo_dtr_buffer_set_aligned
parameter_list|(
name|xge_hal_channel_h
name|channelh
parameter_list|,
name|xge_hal_dtr_h
name|dtrh
parameter_list|,
name|int
name|frag_idx
parameter_list|,
name|void
modifier|*
name|vaddr
parameter_list|,
name|dma_addr_t
name|dma_pointer
parameter_list|,
name|int
name|size
parameter_list|,
name|int
name|misaligned_size
parameter_list|)
block|{
name|xge_hal_fifo_t
modifier|*
name|fifo
init|=
operator|(
name|xge_hal_fifo_t
operator|*
operator|)
name|channelh
decl_stmt|;
name|xge_hal_fifo_txdl_priv_t
modifier|*
name|txdl_priv
decl_stmt|;
name|xge_hal_fifo_txd_t
modifier|*
name|txdp
decl_stmt|;
name|int
name|remaining_size
decl_stmt|;
name|ptrdiff_t
name|prev_boff
decl_stmt|;
name|txdl_priv
operator|=
name|__hal_fifo_txdl_priv
argument_list|(
name|dtrh
argument_list|)
expr_stmt|;
name|txdp
operator|=
operator|(
name|xge_hal_fifo_txd_t
operator|*
operator|)
name|dtrh
operator|+
name|txdl_priv
operator|->
name|frags
expr_stmt|;
if|if
condition|(
name|frag_idx
operator|!=
literal|0
condition|)
block|{
name|txdp
operator|->
name|control_1
operator|=
name|txdp
operator|->
name|control_2
operator|=
literal|0
expr_stmt|;
block|}
comment|/* On some systems buffer size could be zero. 	 * It is the responsibility of ULD and *not HAL* to 	 * detect it and skip it. */
name|xge_assert
argument_list|(
name|size
operator|>
literal|0
argument_list|)
expr_stmt|;
name|xge_assert
argument_list|(
name|frag_idx
operator|<
name|txdl_priv
operator|->
name|alloc_frags
argument_list|)
expr_stmt|;
name|xge_assert
argument_list|(
name|misaligned_size
operator|!=
literal|0
operator|&&
name|misaligned_size
operator|<=
name|fifo
operator|->
name|config
operator|->
name|alignment_size
argument_list|)
expr_stmt|;
name|remaining_size
operator|=
name|size
operator|-
name|misaligned_size
expr_stmt|;
name|xge_assert
argument_list|(
name|remaining_size
operator|>=
literal|0
argument_list|)
expr_stmt|;
name|xge_os_memcpy
argument_list|(
operator|(
name|char
operator|*
operator|)
name|txdl_priv
operator|->
name|align_vaddr_start
argument_list|,
name|vaddr
argument_list|,
name|misaligned_size
argument_list|)
expr_stmt|;
if|if
condition|(
name|txdl_priv
operator|->
name|align_used_frags
operator|>=
name|fifo
operator|->
name|config
operator|->
name|max_aligned_frags
condition|)
block|{
return|return
name|XGE_HAL_ERR_OUT_ALIGNED_FRAGS
return|;
block|}
comment|/* setup new buffer */
name|prev_boff
operator|=
name|txdl_priv
operator|->
name|align_vaddr_start
operator|-
name|txdl_priv
operator|->
name|align_vaddr
expr_stmt|;
name|txdp
operator|->
name|buffer_pointer
operator|=
operator|(
name|u64
operator|)
name|txdl_priv
operator|->
name|align_dma_addr
operator|+
name|prev_boff
expr_stmt|;
name|txdp
operator|->
name|control_1
operator||=
name|XGE_HAL_TXD_BUFFER0_SIZE
argument_list|(
name|misaligned_size
argument_list|)
expr_stmt|;
name|txdl_priv
operator|->
name|bytes_sent
operator|+=
name|misaligned_size
expr_stmt|;
name|fifo
operator|->
name|channel
operator|.
name|stats
operator|.
name|total_buffers
operator|++
expr_stmt|;
name|txdl_priv
operator|->
name|frags
operator|++
expr_stmt|;
name|txdl_priv
operator|->
name|align_used_frags
operator|++
expr_stmt|;
name|txdl_priv
operator|->
name|align_vaddr_start
operator|+=
name|fifo
operator|->
name|config
operator|->
name|alignment_size
expr_stmt|;
name|txdl_priv
operator|->
name|align_dma_offset
operator|=
literal|0
expr_stmt|;
if|#
directive|if
name|defined
argument_list|(
name|XGE_OS_DMA_REQUIRES_SYNC
argument_list|)
comment|/* sync new buffer */
name|xge_os_dma_sync
argument_list|(
name|fifo
operator|->
name|channel
operator|.
name|pdev
argument_list|,
name|txdl_priv
operator|->
name|align_dma_handle
argument_list|,
name|txdp
operator|->
name|buffer_pointer
argument_list|,
literal|0
argument_list|,
name|misaligned_size
argument_list|,
name|XGE_OS_DMA_DIR_TODEVICE
argument_list|)
expr_stmt|;
endif|#
directive|endif
if|if
condition|(
name|remaining_size
condition|)
block|{
name|xge_assert
argument_list|(
name|frag_idx
operator|<
name|txdl_priv
operator|->
name|alloc_frags
argument_list|)
expr_stmt|;
name|txdp
operator|++
expr_stmt|;
name|txdp
operator|->
name|buffer_pointer
operator|=
operator|(
name|u64
operator|)
name|dma_pointer
operator|+
name|misaligned_size
expr_stmt|;
name|txdp
operator|->
name|control_1
operator|=
name|XGE_HAL_TXD_BUFFER0_SIZE
argument_list|(
name|remaining_size
argument_list|)
expr_stmt|;
name|txdl_priv
operator|->
name|bytes_sent
operator|+=
name|remaining_size
expr_stmt|;
name|txdp
operator|->
name|control_2
operator|=
literal|0
expr_stmt|;
name|fifo
operator|->
name|channel
operator|.
name|stats
operator|.
name|total_buffers
operator|++
expr_stmt|;
name|txdl_priv
operator|->
name|frags
operator|++
expr_stmt|;
block|}
return|return
name|XGE_HAL_OK
return|;
block|}
end_function

begin_comment
comment|/**  * xge_hal_fifo_dtr_buffer_append - Append the contents of virtually  * contiguous data buffer to a single physically contiguous buffer.  * @channelh: Channel handle.  * @dtrh: Descriptor handle.  * @vaddr: Virtual address of the data buffer.  * @size: Size of the data buffer (in bytes).  *  * This API is part of the transmit descriptor preparation for posting  * (via xge_hal_fifo_dtr_post()).  * The main difference of this API wrt to the APIs  * xge_hal_fifo_dtr_buffer_set_aligned() is that this API appends the  * contents of virtually contiguous data buffers received from  * upper layer into a single physically contiguous data buffer and the  * device will do a DMA from this buffer.  *  * See Also: xge_hal_fifo_dtr_buffer_finalize(), xge_hal_fifo_dtr_buffer_set(),  * xge_hal_fifo_dtr_buffer_set_aligned().  */
end_comment

begin_function
name|__HAL_STATIC_FIFO
name|__HAL_INLINE_FIFO
name|xge_hal_status_e
name|xge_hal_fifo_dtr_buffer_append
parameter_list|(
name|xge_hal_channel_h
name|channelh
parameter_list|,
name|xge_hal_dtr_h
name|dtrh
parameter_list|,
name|void
modifier|*
name|vaddr
parameter_list|,
name|int
name|size
parameter_list|)
block|{
name|xge_hal_fifo_t
modifier|*
name|fifo
init|=
operator|(
name|xge_hal_fifo_t
operator|*
operator|)
name|channelh
decl_stmt|;
name|xge_hal_fifo_txdl_priv_t
modifier|*
name|txdl_priv
decl_stmt|;
name|ptrdiff_t
name|used
decl_stmt|;
name|xge_assert
argument_list|(
name|size
operator|>
literal|0
argument_list|)
expr_stmt|;
name|txdl_priv
operator|=
name|__hal_fifo_txdl_priv
argument_list|(
name|dtrh
argument_list|)
expr_stmt|;
name|used
operator|=
name|txdl_priv
operator|->
name|align_vaddr_start
operator|-
name|txdl_priv
operator|->
name|align_vaddr
expr_stmt|;
name|used
operator|+=
name|txdl_priv
operator|->
name|align_dma_offset
expr_stmt|;
if|if
condition|(
name|used
operator|+
operator|(
name|unsigned
name|int
operator|)
name|size
operator|>
operator|(
name|unsigned
name|int
operator|)
name|fifo
operator|->
name|align_size
condition|)
return|return
name|XGE_HAL_ERR_OUT_ALIGNED_FRAGS
return|;
name|xge_os_memcpy
argument_list|(
operator|(
name|char
operator|*
operator|)
name|txdl_priv
operator|->
name|align_vaddr_start
operator|+
name|txdl_priv
operator|->
name|align_dma_offset
argument_list|,
name|vaddr
argument_list|,
name|size
argument_list|)
expr_stmt|;
name|fifo
operator|->
name|channel
operator|.
name|stats
operator|.
name|copied_frags
operator|++
expr_stmt|;
name|txdl_priv
operator|->
name|align_dma_offset
operator|+=
name|size
expr_stmt|;
return|return
name|XGE_HAL_OK
return|;
block|}
end_function

begin_comment
comment|/**  * xge_hal_fifo_dtr_buffer_finalize - Prepares a descriptor that contains the  * single physically contiguous buffer.  *  * @channelh: Channel handle.  * @dtrh: Descriptor handle.  * @frag_idx: Index of the data buffer in the Txdl list.  *  * This API in conjuction with xge_hal_fifo_dtr_buffer_append() prepares  * a descriptor that consists of a single physically contiguous buffer  * which inturn contains the contents of one or more virtually contiguous  * buffers received from the upper layer.  *  * See Also: xge_hal_fifo_dtr_buffer_append(). */
end_comment

begin_function
name|__HAL_STATIC_FIFO
name|__HAL_INLINE_FIFO
name|void
name|xge_hal_fifo_dtr_buffer_finalize
parameter_list|(
name|xge_hal_channel_h
name|channelh
parameter_list|,
name|xge_hal_dtr_h
name|dtrh
parameter_list|,
name|int
name|frag_idx
parameter_list|)
block|{
name|xge_hal_fifo_t
modifier|*
name|fifo
init|=
operator|(
name|xge_hal_fifo_t
operator|*
operator|)
name|channelh
decl_stmt|;
name|xge_hal_fifo_txdl_priv_t
modifier|*
name|txdl_priv
decl_stmt|;
name|xge_hal_fifo_txd_t
modifier|*
name|txdp
decl_stmt|;
name|ptrdiff_t
name|prev_boff
decl_stmt|;
name|xge_assert
argument_list|(
name|frag_idx
operator|<
name|fifo
operator|->
name|config
operator|->
name|max_frags
argument_list|)
expr_stmt|;
name|txdl_priv
operator|=
name|__hal_fifo_txdl_priv
argument_list|(
name|dtrh
argument_list|)
expr_stmt|;
name|txdp
operator|=
operator|(
name|xge_hal_fifo_txd_t
operator|*
operator|)
name|dtrh
operator|+
name|txdl_priv
operator|->
name|frags
expr_stmt|;
if|if
condition|(
name|frag_idx
operator|!=
literal|0
condition|)
block|{
name|txdp
operator|->
name|control_1
operator|=
name|txdp
operator|->
name|control_2
operator|=
literal|0
expr_stmt|;
block|}
name|prev_boff
operator|=
name|txdl_priv
operator|->
name|align_vaddr_start
operator|-
name|txdl_priv
operator|->
name|align_vaddr
expr_stmt|;
name|txdp
operator|->
name|buffer_pointer
operator|=
operator|(
name|u64
operator|)
name|txdl_priv
operator|->
name|align_dma_addr
operator|+
name|prev_boff
expr_stmt|;
name|txdp
operator|->
name|control_1
operator||=
name|XGE_HAL_TXD_BUFFER0_SIZE
argument_list|(
name|txdl_priv
operator|->
name|align_dma_offset
argument_list|)
expr_stmt|;
name|txdl_priv
operator|->
name|bytes_sent
operator|+=
operator|(
name|unsigned
name|int
operator|)
name|txdl_priv
operator|->
name|align_dma_offset
expr_stmt|;
name|fifo
operator|->
name|channel
operator|.
name|stats
operator|.
name|total_buffers
operator|++
expr_stmt|;
name|fifo
operator|->
name|channel
operator|.
name|stats
operator|.
name|copied_buffers
operator|++
expr_stmt|;
name|txdl_priv
operator|->
name|frags
operator|++
expr_stmt|;
name|txdl_priv
operator|->
name|align_used_frags
operator|++
expr_stmt|;
if|#
directive|if
name|defined
argument_list|(
name|XGE_OS_DMA_REQUIRES_SYNC
argument_list|)
comment|/* sync pre-mapped buffer */
name|xge_os_dma_sync
argument_list|(
name|fifo
operator|->
name|channel
operator|.
name|pdev
argument_list|,
name|txdl_priv
operator|->
name|align_dma_handle
argument_list|,
name|txdp
operator|->
name|buffer_pointer
argument_list|,
literal|0
argument_list|,
name|txdl_priv
operator|->
name|align_dma_offset
argument_list|,
name|XGE_OS_DMA_DIR_TODEVICE
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* increment vaddr_start for the next buffer_append() iteration */
name|txdl_priv
operator|->
name|align_vaddr_start
operator|+=
name|txdl_priv
operator|->
name|align_dma_offset
expr_stmt|;
name|txdl_priv
operator|->
name|align_dma_offset
operator|=
literal|0
expr_stmt|;
block|}
end_function

begin_comment
comment|/**  * xge_hal_fifo_dtr_buffer_set - Set transmit buffer pointer in the  * descriptor.  * @channelh: Channel handle.  * @dtrh: Descriptor handle.  * @frag_idx: Index of the data buffer in the caller's scatter-gather list√°  *            (of buffers).  * @dma_pointer: DMA address of the data buffer referenced by @frag_idx.  * @size: Size of the data buffer (in bytes).  *  * This API is part of the preparation of the transmit descriptor for posting  * (via xge_hal_fifo_dtr_post()). The related "preparation" APIs include  * xge_hal_fifo_dtr_mss_set() and xge_hal_fifo_dtr_cksum_set_bits().  * All three APIs fill in the fields of the fifo descriptor,  * in accordance with the Xframe specification.  *  * See also: xge_hal_fifo_dtr_buffer_set_aligned(),  * xge_hal_check_alignment().  *  * See also: xge_hal_fifo_dtr_reserve(), xge_hal_fifo_dtr_post(),  * xge_hal_fifo_dtr_mss_set(), xge_hal_fifo_dtr_cksum_set_bits()  * Prepare transmit descriptor for transmission (via  * xge_hal_fifo_dtr_post()).  * See also: xge_hal_fifo_dtr_vlan_set().  * Note: Compare with xge_hal_fifo_dtr_buffer_set_aligned().  *  * Usage: See ex_xmit{}.  */
end_comment

begin_function
name|__HAL_STATIC_FIFO
name|__HAL_INLINE_FIFO
name|void
name|xge_hal_fifo_dtr_buffer_set
parameter_list|(
name|xge_hal_channel_h
name|channelh
parameter_list|,
name|xge_hal_dtr_h
name|dtrh
parameter_list|,
name|int
name|frag_idx
parameter_list|,
name|dma_addr_t
name|dma_pointer
parameter_list|,
name|int
name|size
parameter_list|)
block|{
name|xge_hal_fifo_t
modifier|*
name|fifo
init|=
operator|(
name|xge_hal_fifo_t
operator|*
operator|)
name|channelh
decl_stmt|;
name|xge_hal_fifo_txdl_priv_t
modifier|*
name|txdl_priv
decl_stmt|;
name|xge_hal_fifo_txd_t
modifier|*
name|txdp
decl_stmt|;
name|txdl_priv
operator|=
name|__hal_fifo_txdl_priv
argument_list|(
name|dtrh
argument_list|)
expr_stmt|;
name|txdp
operator|=
operator|(
name|xge_hal_fifo_txd_t
operator|*
operator|)
name|dtrh
operator|+
name|txdl_priv
operator|->
name|frags
expr_stmt|;
if|if
condition|(
name|frag_idx
operator|!=
literal|0
condition|)
block|{
name|txdp
operator|->
name|control_1
operator|=
name|txdp
operator|->
name|control_2
operator|=
literal|0
expr_stmt|;
block|}
comment|/* Note: 	 * it is the responsibility of upper layers and not HAL 	 * detect it and skip zero-size fragment 	 */
name|xge_assert
argument_list|(
name|size
operator|>
literal|0
argument_list|)
expr_stmt|;
name|xge_assert
argument_list|(
name|frag_idx
operator|<
name|txdl_priv
operator|->
name|alloc_frags
argument_list|)
expr_stmt|;
name|txdp
operator|->
name|buffer_pointer
operator|=
operator|(
name|u64
operator|)
name|dma_pointer
expr_stmt|;
name|txdp
operator|->
name|control_1
operator||=
name|XGE_HAL_TXD_BUFFER0_SIZE
argument_list|(
name|size
argument_list|)
expr_stmt|;
name|txdl_priv
operator|->
name|bytes_sent
operator|+=
name|size
expr_stmt|;
name|fifo
operator|->
name|channel
operator|.
name|stats
operator|.
name|total_buffers
operator|++
expr_stmt|;
name|txdl_priv
operator|->
name|frags
operator|++
expr_stmt|;
block|}
end_function

begin_comment
comment|/**  * xge_hal_fifo_dtr_mss_set - Set MSS.  * @dtrh: Descriptor handle.  * @mss: MSS size for _this_ TCP connection. Passed by TCP stack down to the  *       ULD, which in turn inserts the MSS into the @dtrh.  *  * This API is part of the preparation of the transmit descriptor for posting  * (via xge_hal_fifo_dtr_post()). The related "preparation" APIs include  * xge_hal_fifo_dtr_buffer_set(), xge_hal_fifo_dtr_buffer_set_aligned(),  * and xge_hal_fifo_dtr_cksum_set_bits().  * All these APIs fill in the fields of the fifo descriptor,  * in accordance with the Xframe specification.  *  * See also: xge_hal_fifo_dtr_reserve(),  * xge_hal_fifo_dtr_post(), xge_hal_fifo_dtr_vlan_set().  * Usage: See ex_xmit{}.  */
end_comment

begin_function
name|__HAL_STATIC_FIFO
name|__HAL_INLINE_FIFO
name|void
name|xge_hal_fifo_dtr_mss_set
parameter_list|(
name|xge_hal_dtr_h
name|dtrh
parameter_list|,
name|int
name|mss
parameter_list|)
block|{
name|xge_hal_fifo_txd_t
modifier|*
name|txdp
init|=
operator|(
name|xge_hal_fifo_txd_t
operator|*
operator|)
name|dtrh
decl_stmt|;
name|txdp
operator|->
name|control_1
operator||=
name|XGE_HAL_TXD_LSO_COF_CTRL
argument_list|(
name|XGE_HAL_TXD_TCP_LSO
argument_list|)
expr_stmt|;
name|txdp
operator|->
name|control_1
operator||=
name|XGE_HAL_TXD_TCP_LSO_MSS
argument_list|(
name|mss
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/**  * xge_hal_fifo_dtr_cksum_set_bits - Offload checksum.  * @dtrh: Descriptor handle.  * @cksum_bits: Specifies which checksums are to be offloaded: IPv4,  *              and/or TCP and/or UDP.  *  * Ask Xframe to calculate IPv4& transport checksums for _this_ transmit  * descriptor.  * This API is part of the preparation of the transmit descriptor for posting  * (via xge_hal_fifo_dtr_post()). The related "preparation" APIs include  * xge_hal_fifo_dtr_mss_set(), xge_hal_fifo_dtr_buffer_set_aligned(),  * and xge_hal_fifo_dtr_buffer_set().  * All these APIs fill in the fields of the fifo descriptor,  * in accordance with the Xframe specification.  *  * See also: xge_hal_fifo_dtr_reserve(),  * xge_hal_fifo_dtr_post(), XGE_HAL_TXD_TX_CKO_IPV4_EN,  * XGE_HAL_TXD_TX_CKO_TCP_EN.  * Usage: See ex_xmit{}.  */
end_comment

begin_function
name|__HAL_STATIC_FIFO
name|__HAL_INLINE_FIFO
name|void
name|xge_hal_fifo_dtr_cksum_set_bits
parameter_list|(
name|xge_hal_dtr_h
name|dtrh
parameter_list|,
name|u64
name|cksum_bits
parameter_list|)
block|{
name|xge_hal_fifo_txd_t
modifier|*
name|txdp
init|=
operator|(
name|xge_hal_fifo_txd_t
operator|*
operator|)
name|dtrh
decl_stmt|;
name|txdp
operator|->
name|control_2
operator||=
name|cksum_bits
expr_stmt|;
block|}
end_function

begin_comment
comment|/**  * xge_hal_fifo_dtr_vlan_set - Set VLAN tag.  * @dtrh: Descriptor handle.  * @vlan_tag: 16bit VLAN tag.  *  * Insert VLAN tag into specified transmit descriptor.  * The actual insertion of the tag into outgoing frame is done by the hardware.  * See also: xge_hal_fifo_dtr_buffer_set(), xge_hal_fifo_dtr_mss_set().  */
end_comment

begin_function
name|__HAL_STATIC_FIFO
name|__HAL_INLINE_FIFO
name|void
name|xge_hal_fifo_dtr_vlan_set
parameter_list|(
name|xge_hal_dtr_h
name|dtrh
parameter_list|,
name|u16
name|vlan_tag
parameter_list|)
block|{
name|xge_hal_fifo_txd_t
modifier|*
name|txdp
init|=
operator|(
name|xge_hal_fifo_txd_t
operator|*
operator|)
name|dtrh
decl_stmt|;
name|txdp
operator|->
name|control_2
operator||=
name|XGE_HAL_TXD_VLAN_ENABLE
expr_stmt|;
name|txdp
operator|->
name|control_2
operator||=
name|XGE_HAL_TXD_VLAN_TAG
argument_list|(
name|vlan_tag
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/**  * xge_hal_fifo_is_next_dtr_completed - Checks if the next dtr is completed  * @channelh: Channel handle.  */
end_comment

begin_function
name|__HAL_STATIC_FIFO
name|__HAL_INLINE_FIFO
name|xge_hal_status_e
name|xge_hal_fifo_is_next_dtr_completed
parameter_list|(
name|xge_hal_channel_h
name|channelh
parameter_list|)
block|{
name|xge_hal_fifo_txd_t
modifier|*
name|txdp
decl_stmt|;
name|xge_hal_dtr_h
name|dtrh
decl_stmt|;
name|__hal_channel_dtr_try_complete
argument_list|(
name|channelh
argument_list|,
operator|&
name|dtrh
argument_list|)
expr_stmt|;
name|txdp
operator|=
operator|(
name|xge_hal_fifo_txd_t
operator|*
operator|)
name|dtrh
expr_stmt|;
if|if
condition|(
name|txdp
operator|==
name|NULL
condition|)
block|{
return|return
name|XGE_HAL_INF_NO_MORE_COMPLETED_DESCRIPTORS
return|;
block|}
comment|/* check whether host owns it */
if|if
condition|(
operator|!
operator|(
name|txdp
operator|->
name|control_1
operator|&
name|XGE_HAL_TXD_LIST_OWN_XENA
operator|)
condition|)
block|{
name|xge_assert
argument_list|(
name|txdp
operator|->
name|host_control
operator|!=
literal|0
argument_list|)
expr_stmt|;
return|return
name|XGE_HAL_OK
return|;
block|}
comment|/* no more completions */
return|return
name|XGE_HAL_INF_NO_MORE_COMPLETED_DESCRIPTORS
return|;
block|}
end_function

end_unit


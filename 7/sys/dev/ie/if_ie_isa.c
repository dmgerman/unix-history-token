begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*-  * Copyright (c) 2003 Matthew N. Dodd  * All rights reserved.  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions  * are met:  * 1. Redistributions of source code must retain the above copyright  *    notice, this list of conditions and the following disclaimer.  * 2. Redistributions in binary form must reproduce the above copyright  *    notice, this list of conditions and the following disclaimer in the  *    documentation and/or other materials provided with the distribution.  *  * THIS SOFTWARE IS PROVIDED BY THE AUTHOR AND CONTRIBUTORS ``AS IS'' AND  * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE  * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE  * ARE DISCLAIMED.  IN NO EVENT SHALL THE AUTHOR OR CONTRIBUTORS BE LIABLE  * FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL  * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS  * OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)  * HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT  * LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY  * OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF  * SUCH DAMAGE.  *  * Portions:   * Copyright (c) 1992, 1993, University of Vermont and State  *  Agricultural College.  * Copyright (c) 1992, 1993, Garrett A. Wollman.  * Copyright (c) 1990, 1991, William F. Jolitz  * Copyright (c) 1990, The Regents of the University of California  * Copyright (c) 1993, 1994, Charles M. Hannum  * Copyright (c) 1993, 1994, 1995, Rodney W. Grimes  * Copyright (c) 1997, Aaron C. Smith  *  * See if_ie.c for applicable license.  */
end_comment

begin_include
include|#
directive|include
file|<sys/cdefs.h>
end_include

begin_expr_stmt
name|__FBSDID
argument_list|(
literal|"$FreeBSD$"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_include
include|#
directive|include
file|<sys/param.h>
end_include

begin_include
include|#
directive|include
file|<sys/systm.h>
end_include

begin_include
include|#
directive|include
file|<sys/kernel.h>
end_include

begin_include
include|#
directive|include
file|<sys/socket.h>
end_include

begin_include
include|#
directive|include
file|<sys/module.h>
end_include

begin_include
include|#
directive|include
file|<sys/bus.h>
end_include

begin_include
include|#
directive|include
file|<machine/bus.h>
end_include

begin_include
include|#
directive|include
file|<machine/resource.h>
end_include

begin_include
include|#
directive|include
file|<sys/rman.h>
end_include

begin_include
include|#
directive|include
file|<machine/md_var.h>
end_include

begin_include
include|#
directive|include
file|<net/if.h>
end_include

begin_include
include|#
directive|include
file|<net/if_arp.h>
end_include

begin_include
include|#
directive|include
file|<net/if_media.h>
end_include

begin_include
include|#
directive|include
file|<isa/isavar.h>
end_include

begin_include
include|#
directive|include
file|<isa/pnpvar.h>
end_include

begin_include
include|#
directive|include
file|<i386/isa/elink.h>
end_include

begin_include
include|#
directive|include
file|<dev/ic/i82586.h>
end_include

begin_include
include|#
directive|include
file|<dev/ie/if_ie507.h>
end_include

begin_include
include|#
directive|include
file|<dev/ie/if_iee16.h>
end_include

begin_include
include|#
directive|include
file|<dev/ie/if_iereg.h>
end_include

begin_include
include|#
directive|include
file|<dev/ie/if_ievar.h>
end_include

begin_function_decl
specifier|static
name|int
name|ie_modevent
parameter_list|(
name|module_t
parameter_list|,
name|int
parameter_list|,
name|void
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|ie_isa_3C507_identify
parameter_list|(
name|driver_t
modifier|*
parameter_list|,
name|device_t
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|ie_isa_3C507_probe
parameter_list|(
name|device_t
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|ie_isa_3C507_attach
parameter_list|(
name|device_t
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|ie_3C507_port_check
parameter_list|(
name|u_int32_t
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|ie_isa_ee16_identify
parameter_list|(
name|driver_t
modifier|*
parameter_list|,
name|device_t
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|ie_isa_ee16_probe
parameter_list|(
name|device_t
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|ie_isa_ee16_attach
parameter_list|(
name|device_t
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|ie_ee16_port_check
parameter_list|(
name|u_int32_t
name|port
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|u_int16_t
name|ie_ee16_hw_read_eeprom
parameter_list|(
name|u_int32_t
name|port
parameter_list|,
name|int
name|loc
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|ie_isa_sl_probe
parameter_list|(
name|device_t
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|ie_isa_sl_attach
parameter_list|(
name|device_t
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|enum
name|ie_hardware
name|ie_isa_sl_get_hard_type
parameter_list|(
name|u_int32_t
parameter_list|)
function_decl|;
end_function_decl

begin_comment
comment|/*  * 3Com 3C507 Etherlink 16  */
end_comment

begin_define
define|#
directive|define
name|IE_3C507_IOBASE_LOW
value|0x200
end_define

begin_define
define|#
directive|define
name|IE_3C507_IOBASE_HIGH
value|0x3e0
end_define

begin_define
define|#
directive|define
name|IE_3C507_IOSIZE
value|16
end_define

begin_define
define|#
directive|define
name|IE_3C507_IRQ_MASK
value|0x0f
end_define

begin_define
define|#
directive|define
name|IE_3C507_MADDR_HIGH
value|0x20
end_define

begin_define
define|#
directive|define
name|IE_3C507_MADDR_MASK
value|0x1c
end_define

begin_define
define|#
directive|define
name|IE_3C507_MADDR_BASE
value|0xc0000
end_define

begin_define
define|#
directive|define
name|IE_3C507_MADDR_SHIFT
value|12
end_define

begin_define
define|#
directive|define
name|IE_3C507_MSIZE_MASK
value|3
end_define

begin_define
define|#
directive|define
name|IE_3C507_MSIZE_SHIFT
value|14
end_define

begin_function
specifier|static
name|void
name|ie_isa_3C507_identify
parameter_list|(
name|driver_t
modifier|*
name|driver
parameter_list|,
name|device_t
name|parent
parameter_list|)
block|{
name|char
modifier|*
name|desc
init|=
literal|"3Com 3C507 Etherlink 16"
decl_stmt|;
name|device_t
name|child
decl_stmt|;
name|u_int32_t
name|port
decl_stmt|,
name|maddr
decl_stmt|,
name|msize
decl_stmt|;
name|u_int8_t
name|irq
decl_stmt|,
name|data
decl_stmt|;
name|int
name|error
decl_stmt|;
comment|/* Reset and put card in CONFIG state without changing address. */
name|elink_reset
argument_list|()
expr_stmt|;
name|elink_idseq
argument_list|(
name|ELINK_507_POLY
argument_list|)
expr_stmt|;
name|elink_idseq
argument_list|(
name|ELINK_507_POLY
argument_list|)
expr_stmt|;
name|outb
argument_list|(
name|ELINK_ID_PORT
argument_list|,
literal|0xff
argument_list|)
expr_stmt|;
for|for
control|(
name|port
operator|=
name|IE_3C507_IOBASE_LOW
init|;
name|port
operator|<=
name|IE_3C507_IOBASE_HIGH
condition|;
name|port
operator|+=
name|IE_3C507_IOSIZE
control|)
block|{
if|if
condition|(
name|ie_3C507_port_check
argument_list|(
name|port
argument_list|)
condition|)
block|{
ifdef|#
directive|ifdef
name|DEBUG
if|if
condition|(
name|bootverbose
condition|)
block|{
name|device_printf
argument_list|(
name|parent
argument_list|,
literal|"(if_ie) (3C507) not found at port %#x\n"
argument_list|,
name|port
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
continue|continue;
block|}
name|outb
argument_list|(
name|port
operator|+
name|IE507_CTRL
argument_list|,
name|EL_CTRL_NRST
argument_list|)
expr_stmt|;
name|data
operator|=
name|inb
argument_list|(
name|port
operator|+
name|IE507_IRQ
argument_list|)
expr_stmt|;
name|irq
operator|=
name|data
operator|&
name|IE_3C507_IRQ_MASK
expr_stmt|;
name|data
operator|=
name|inb
argument_list|(
name|port
operator|+
name|IE507_MADDR
argument_list|)
expr_stmt|;
if|if
condition|(
name|data
operator|&
name|IE_3C507_MADDR_HIGH
condition|)
block|{
if|if
condition|(
name|bootverbose
condition|)
block|{
name|device_printf
argument_list|(
name|parent
argument_list|,
literal|"(if_ie) can't map 3C507 RAM in high memory\n"
argument_list|)
expr_stmt|;
block|}
continue|continue;
block|}
name|maddr
operator|=
name|IE_3C507_MADDR_BASE
operator|+
operator|(
operator|(
name|data
operator|&
name|IE_3C507_MADDR_MASK
operator|)
operator|<<
name|IE_3C507_MADDR_SHIFT
operator|)
expr_stmt|;
name|msize
operator|=
operator|(
operator|(
name|data
operator|&
name|IE_3C507_MSIZE_MASK
operator|)
operator|+
literal|1
operator|)
operator|<<
name|IE_3C507_MSIZE_SHIFT
expr_stmt|;
name|child
operator|=
name|BUS_ADD_CHILD
argument_list|(
name|parent
argument_list|,
name|ISA_ORDER_SPECULATIVE
argument_list|,
literal|"ie"
argument_list|,
operator|-
literal|1
argument_list|)
expr_stmt|;
name|device_set_desc_copy
argument_list|(
name|child
argument_list|,
name|desc
argument_list|)
expr_stmt|;
name|device_set_driver
argument_list|(
name|child
argument_list|,
name|driver
argument_list|)
expr_stmt|;
name|error
operator|=
name|bus_set_resource
argument_list|(
name|child
argument_list|,
name|SYS_RES_IRQ
argument_list|,
literal|0
argument_list|,
name|irq
argument_list|,
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
block|{
name|device_printf
argument_list|(
name|parent
argument_list|,
literal|"(if_ie) Unable to set IRQ resource %d.\n"
argument_list|,
name|irq
argument_list|)
expr_stmt|;
name|error
operator|=
name|device_delete_child
argument_list|(
name|parent
argument_list|,
name|child
argument_list|)
expr_stmt|;
continue|continue;
block|}
name|error
operator|=
name|bus_set_resource
argument_list|(
name|child
argument_list|,
name|SYS_RES_IOPORT
argument_list|,
literal|0
argument_list|,
name|port
argument_list|,
name|IE_3C507_IOSIZE
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
block|{
name|device_printf
argument_list|(
name|parent
argument_list|,
literal|"(if_ie) Unable to set IOPORT resource %#x-%#x.\n"
argument_list|,
name|port
argument_list|,
name|port
operator|+
name|IE_3C507_IOSIZE
argument_list|)
expr_stmt|;
name|error
operator|=
name|device_delete_child
argument_list|(
name|parent
argument_list|,
name|child
argument_list|)
expr_stmt|;
continue|continue;
block|}
name|error
operator|=
name|bus_set_resource
argument_list|(
name|child
argument_list|,
name|SYS_RES_MEMORY
argument_list|,
literal|0
argument_list|,
name|maddr
argument_list|,
name|msize
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
block|{
name|device_printf
argument_list|(
name|parent
argument_list|,
literal|"(if_ie) Unable to set MEMORY resource %#x-%#x.\n"
argument_list|,
name|maddr
argument_list|,
name|maddr
operator|+
name|msize
argument_list|)
expr_stmt|;
name|error
operator|=
name|device_delete_child
argument_list|(
name|parent
argument_list|,
name|child
argument_list|)
expr_stmt|;
continue|continue;
block|}
if|if
condition|(
name|bootverbose
condition|)
block|{
name|device_printf
argument_list|(
name|parent
argument_list|,
literal|"(if_ie)<%s> at port %#x-%#x irq %d iomem %#lx-%#lx (%dKB)\n"
argument_list|,
name|desc
argument_list|,
name|port
argument_list|,
operator|(
name|port
operator|+
name|IE_3C507_IOSIZE
operator|)
operator|-
literal|1
argument_list|,
name|irq
argument_list|,
operator|(
name|u_long
operator|)
name|maddr
argument_list|,
call|(
name|u_long
call|)
argument_list|(
name|maddr
operator|+
name|msize
argument_list|)
operator|-
literal|1
argument_list|,
operator|(
name|msize
operator|/
literal|1024
operator|)
argument_list|)
expr_stmt|;
block|}
block|}
comment|/* go to RUN state */
name|outb
argument_list|(
name|ELINK_ID_PORT
argument_list|,
literal|0x00
argument_list|)
expr_stmt|;
name|elink_idseq
argument_list|(
name|ELINK_507_POLY
argument_list|)
expr_stmt|;
name|outb
argument_list|(
name|ELINK_ID_PORT
argument_list|,
literal|0x00
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_function
specifier|static
name|int
name|ie_isa_3C507_probe
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
name|u_int32_t
name|iobase
decl_stmt|;
comment|/* No ISA-PnP support */
if|if
condition|(
name|isa_get_vendorid
argument_list|(
name|dev
argument_list|)
condition|)
block|{
return|return
operator|(
name|ENXIO
operator|)
return|;
block|}
comment|/* No ISA-HINT support */
if|if
condition|(
operator|!
name|device_get_desc
argument_list|(
name|dev
argument_list|)
condition|)
block|{
return|return
operator|(
name|EBUSY
operator|)
return|;
block|}
comment|/* Have we at least an ioport? */
if|if
condition|(
operator|(
name|iobase
operator|=
name|bus_get_resource_start
argument_list|(
name|dev
argument_list|,
name|SYS_RES_IOPORT
argument_list|,
literal|0
argument_list|)
operator|)
operator|==
literal|0
condition|)
block|{
return|return
operator|(
name|ENXIO
operator|)
return|;
block|}
comment|/* Is this thing really a 3c507? */
if|if
condition|(
name|ie_3C507_port_check
argument_list|(
name|iobase
argument_list|)
condition|)
block|{
return|return
operator|(
name|ENXIO
operator|)
return|;
block|}
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|ie_isa_3C507_attach
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
name|struct
name|ie_softc
modifier|*
name|sc
decl_stmt|;
name|int
name|error
decl_stmt|;
name|sc
operator|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
expr_stmt|;
name|sc
operator|->
name|io_rid
operator|=
literal|0
expr_stmt|;
name|sc
operator|->
name|irq_rid
operator|=
literal|0
expr_stmt|;
name|sc
operator|->
name|mem_rid
operator|=
literal|0
expr_stmt|;
name|error
operator|=
name|ie_alloc_resources
argument_list|(
name|dev
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
block|{
goto|goto
name|bad
goto|;
block|}
name|sc
operator|->
name|bus_use
operator|=
literal|0
expr_stmt|;
name|sc
operator|->
name|ie_reset_586
operator|=
name|el_reset_586
expr_stmt|;
name|sc
operator|->
name|ie_chan_attn
operator|=
name|el_chan_attn
expr_stmt|;
name|sc
operator|->
name|hard_type
operator|=
name|IE_3C507
expr_stmt|;
name|sc
operator|->
name|hard_vers
operator|=
literal|0
expr_stmt|;
name|outb
argument_list|(
name|PORT
argument_list|(
name|sc
argument_list|)
operator|+
name|IE507_CTRL
argument_list|,
name|EL_CTRL_NORMAL
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|check_ie_present
argument_list|(
name|sc
argument_list|)
condition|)
block|{
name|error
operator|=
name|ENXIO
expr_stmt|;
goto|goto
name|bad
goto|;
block|}
name|sl_read_ether
argument_list|(
name|sc
argument_list|,
name|sc
operator|->
name|enaddr
argument_list|)
expr_stmt|;
comment|/* Clear the interrupt latch just in case. */
name|outb
argument_list|(
name|PORT
argument_list|(
name|sc
argument_list|)
operator|+
name|IE507_ICTRL
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|error
operator|=
name|ie_attach
argument_list|(
name|dev
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"ie_attach() failed.\n"
argument_list|)
expr_stmt|;
goto|goto
name|bad
goto|;
block|}
name|error
operator|=
name|bus_setup_intr
argument_list|(
name|dev
argument_list|,
name|sc
operator|->
name|irq_res
argument_list|,
name|INTR_TYPE_NET
argument_list|,
name|NULL
argument_list|,
name|ie_intr
argument_list|,
name|sc
argument_list|,
operator|&
name|sc
operator|->
name|irq_ih
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"Unable to register interrupt handler\n"
argument_list|)
expr_stmt|;
goto|goto
name|bad
goto|;
block|}
return|return
operator|(
literal|0
operator|)
return|;
name|bad
label|:
name|ie_release_resources
argument_list|(
name|dev
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * If a 3c507 is present, return 0  * else, return 1.  */
end_comment

begin_function
specifier|static
name|int
name|ie_3C507_port_check
parameter_list|(
name|u_int32_t
name|port
parameter_list|)
block|{
name|u_char
modifier|*
name|signature
init|=
literal|"*3COM*"
decl_stmt|;
name|int
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|6
condition|;
name|i
operator|++
control|)
if|if
condition|(
name|inb
argument_list|(
name|port
operator|+
name|i
argument_list|)
operator|!=
name|signature
index|[
name|i
index|]
condition|)
return|return
operator|(
name|ENXIO
operator|)
return|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Intel EtherExpress 16  */
end_comment

begin_define
define|#
directive|define
name|IE_EE16_ID_PORT
value|0x0f
end_define

begin_define
define|#
directive|define
name|IE_EE16_ID
value|0xbaba
end_define

begin_define
define|#
directive|define
name|IE_EE16_EEPROM_CONFIG1
value|0x00
end_define

begin_define
define|#
directive|define
name|IE_EE16_EEPROM_IRQ_MASK
value|0xe000
end_define

begin_define
define|#
directive|define
name|IE_EE16_EEPROM_IRQ_SHIFT
value|13
end_define

begin_define
define|#
directive|define
name|IE_EE16_EEPROM_MEMCFG
value|0x06
end_define

begin_define
define|#
directive|define
name|IE_EE16_IOSIZE
value|16
end_define

begin_comment
comment|/*  * TODO:  *		Test for 8/16 bit mode.  *		Test for invalid mem sizes.  */
end_comment

begin_function
specifier|static
name|void
name|ie_isa_ee16_identify
parameter_list|(
name|driver_t
modifier|*
name|driver
parameter_list|,
name|device_t
name|parent
parameter_list|)
block|{
name|char
modifier|*
name|desc
init|=
literal|"Intel EtherExpress 16"
decl_stmt|;
name|device_t
name|child
decl_stmt|;
name|u_int16_t
name|ports
index|[]
init|=
block|{
literal|0x300
block|,
literal|0x310
block|,
literal|0x320
block|,
literal|0x330
block|,
literal|0x340
block|,
literal|0x350
block|,
literal|0x360
block|,
literal|0x370
block|,
literal|0x200
block|,
literal|0x210
block|,
literal|0x220
block|,
literal|0x230
block|,
literal|0x240
block|,
literal|0x250
block|,
literal|0x260
block|,
literal|0x270
block|,
literal|0
block|}
decl_stmt|;
name|u_int16_t
name|irqs
index|[]
init|=
block|{
literal|0
block|,
literal|0x09
block|,
literal|0x03
block|,
literal|0x04
block|,
literal|0x05
block|,
literal|0x0a
block|,
literal|0x0b
block|,
literal|0
block|}
decl_stmt|;
name|u_int32_t
name|port
decl_stmt|,
name|maddr
decl_stmt|,
name|msize
decl_stmt|;
name|u_int8_t
name|irq
decl_stmt|;
name|u_int16_t
name|data
decl_stmt|;
name|int
name|i
decl_stmt|,
name|error
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|ports
index|[
name|i
index|]
condition|;
name|i
operator|++
control|)
block|{
name|port
operator|=
name|ports
index|[
name|i
index|]
expr_stmt|;
if|if
condition|(
name|ie_ee16_port_check
argument_list|(
name|port
argument_list|)
condition|)
block|{
ifdef|#
directive|ifdef
name|DEBUG
if|if
condition|(
name|bootverbose
condition|)
block|{
name|device_printf
argument_list|(
name|parent
argument_list|,
literal|"if_ie: (EE16) not found at port %#x\n"
argument_list|,
name|port
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
continue|continue;
block|}
comment|/* reset any ee16 at the current iobase */
name|outb
argument_list|(
name|port
operator|+
name|IEE16_ECTRL
argument_list|,
name|IEE16_RESET_ASIC
argument_list|)
expr_stmt|;
name|outb
argument_list|(
name|port
operator|+
name|IEE16_ECTRL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|DELAY
argument_list|(
literal|240
argument_list|)
expr_stmt|;
name|data
operator|=
name|ie_ee16_hw_read_eeprom
argument_list|(
name|port
argument_list|,
name|IE_EE16_EEPROM_CONFIG1
argument_list|)
expr_stmt|;
name|irq
operator|=
name|irqs
index|[
operator|(
operator|(
name|data
operator|&
name|IE_EE16_EEPROM_IRQ_MASK
operator|)
operator|>>
name|IE_EE16_EEPROM_IRQ_SHIFT
operator|)
index|]
expr_stmt|;
name|data
operator|=
name|ie_ee16_hw_read_eeprom
argument_list|(
name|port
argument_list|,
name|IE_EE16_EEPROM_MEMCFG
argument_list|)
expr_stmt|;
name|maddr
operator|=
literal|0xc0000
operator|+
operator|(
operator|(
name|ffs
argument_list|(
name|data
operator|&
literal|0x00ff
argument_list|)
operator|-
literal|1
operator|)
operator|*
literal|0x4000
operator|)
expr_stmt|;
name|msize
operator|=
operator|(
name|fls
argument_list|(
operator|(
name|data
operator|&
literal|0x00ff
operator|)
operator|>>
operator|(
name|ffs
argument_list|(
name|data
operator|&
literal|0x00ff
argument_list|)
operator|-
literal|1
operator|)
argument_list|)
operator|)
operator|*
literal|0x4000
expr_stmt|;
name|child
operator|=
name|BUS_ADD_CHILD
argument_list|(
name|parent
argument_list|,
name|ISA_ORDER_SPECULATIVE
argument_list|,
literal|"ie"
argument_list|,
operator|-
literal|1
argument_list|)
expr_stmt|;
name|device_set_desc_copy
argument_list|(
name|child
argument_list|,
name|desc
argument_list|)
expr_stmt|;
name|device_set_driver
argument_list|(
name|child
argument_list|,
name|driver
argument_list|)
expr_stmt|;
name|error
operator|=
name|bus_set_resource
argument_list|(
name|child
argument_list|,
name|SYS_RES_IRQ
argument_list|,
literal|0
argument_list|,
name|irq
argument_list|,
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
block|{
name|device_printf
argument_list|(
name|parent
argument_list|,
literal|"(if_ie) Unable to set IRQ resource %d.\n"
argument_list|,
name|irq
argument_list|)
expr_stmt|;
name|error
operator|=
name|device_delete_child
argument_list|(
name|parent
argument_list|,
name|child
argument_list|)
expr_stmt|;
continue|continue;
block|}
name|error
operator|=
name|bus_set_resource
argument_list|(
name|child
argument_list|,
name|SYS_RES_IOPORT
argument_list|,
literal|0
argument_list|,
name|port
argument_list|,
name|IE_EE16_IOSIZE
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
block|{
name|device_printf
argument_list|(
name|parent
argument_list|,
literal|"(if_ie) Unable to set IOPORT resource %#x-%#x.\n"
argument_list|,
name|port
argument_list|,
name|port
operator|+
name|IE_EE16_IOSIZE
argument_list|)
expr_stmt|;
name|error
operator|=
name|device_delete_child
argument_list|(
name|parent
argument_list|,
name|child
argument_list|)
expr_stmt|;
continue|continue;
block|}
name|error
operator|=
name|bus_set_resource
argument_list|(
name|child
argument_list|,
name|SYS_RES_MEMORY
argument_list|,
literal|0
argument_list|,
name|maddr
argument_list|,
name|msize
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
block|{
name|device_printf
argument_list|(
name|parent
argument_list|,
literal|"(if_ie) Unable to set MEMORY resource %#x-%#x.\n"
argument_list|,
name|maddr
argument_list|,
name|maddr
operator|+
name|msize
argument_list|)
expr_stmt|;
name|error
operator|=
name|device_delete_child
argument_list|(
name|parent
argument_list|,
name|child
argument_list|)
expr_stmt|;
continue|continue;
block|}
if|if
condition|(
name|bootverbose
condition|)
block|{
name|device_printf
argument_list|(
name|parent
argument_list|,
literal|"if_ie:<%s> at port %#x-%#x irq %d iomem %#lx-%#lx (%dKB)\n"
argument_list|,
name|desc
argument_list|,
name|port
argument_list|,
operator|(
name|port
operator|+
name|IE_EE16_IOSIZE
operator|)
operator|-
literal|1
argument_list|,
name|irq
argument_list|,
operator|(
name|u_long
operator|)
name|maddr
argument_list|,
call|(
name|u_long
call|)
argument_list|(
name|maddr
operator|+
name|msize
argument_list|)
operator|-
literal|1
argument_list|,
operator|(
name|msize
operator|/
literal|1024
operator|)
argument_list|)
expr_stmt|;
block|}
block|}
return|return;
block|}
end_function

begin_function
specifier|static
name|int
name|ie_isa_ee16_probe
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
name|u_int32_t
name|iobase
decl_stmt|;
comment|/* No ISA-PnP support */
if|if
condition|(
name|isa_get_vendorid
argument_list|(
name|dev
argument_list|)
condition|)
return|return
operator|(
name|ENXIO
operator|)
return|;
comment|/* No ISA-HINT support */
if|if
condition|(
operator|!
name|device_get_desc
argument_list|(
name|dev
argument_list|)
condition|)
return|return
operator|(
name|EBUSY
operator|)
return|;
comment|/* Have we at least an ioport? */
if|if
condition|(
operator|(
name|iobase
operator|=
name|bus_get_resource_start
argument_list|(
name|dev
argument_list|,
name|SYS_RES_IOPORT
argument_list|,
literal|0
argument_list|)
operator|)
operator|==
literal|0
condition|)
return|return
operator|(
name|ENXIO
operator|)
return|;
comment|/* Is this really an EE16? */
if|if
condition|(
name|ie_ee16_port_check
argument_list|(
name|iobase
argument_list|)
condition|)
return|return
operator|(
name|ENXIO
operator|)
return|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|ie_isa_ee16_attach
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
name|struct
name|ie_softc
modifier|*
name|sc
decl_stmt|;
name|int
name|i
decl_stmt|,
name|error
decl_stmt|;
name|u_int16_t
name|checksum
decl_stmt|;
name|u_short
name|eaddrtemp
decl_stmt|,
name|pg
decl_stmt|,
name|adjust
decl_stmt|,
name|decode
decl_stmt|,
name|edecode
decl_stmt|;
name|u_char
name|bart_config
decl_stmt|;
name|sc
operator|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
expr_stmt|;
name|sc
operator|->
name|io_rid
operator|=
literal|0
expr_stmt|;
name|sc
operator|->
name|irq_rid
operator|=
literal|0
expr_stmt|;
name|sc
operator|->
name|mem_rid
operator|=
literal|0
expr_stmt|;
name|error
operator|=
name|ie_alloc_resources
argument_list|(
name|dev
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
block|{
goto|goto
name|bad
goto|;
block|}
name|sc
operator|->
name|bus_use
operator|=
literal|0
expr_stmt|;
name|sc
operator|->
name|ie_reset_586
operator|=
name|ee16_reset_586
expr_stmt|;
name|sc
operator|->
name|ie_chan_attn
operator|=
name|ee16_chan_attn
expr_stmt|;
name|sc
operator|->
name|hard_type
operator|=
name|IE_EE16
expr_stmt|;
name|sc
operator|->
name|hard_vers
operator|=
literal|0
expr_stmt|;
name|sc
operator|->
name|iomem
operator|=
literal|0
expr_stmt|;
comment|/* reset any ee16 at the current iobase */
name|outb
argument_list|(
name|PORT
argument_list|(
name|sc
argument_list|)
operator|+
name|IEE16_ECTRL
argument_list|,
name|IEE16_RESET_ASIC
argument_list|)
expr_stmt|;
name|outb
argument_list|(
name|PORT
argument_list|(
name|sc
argument_list|)
operator|+
name|IEE16_ECTRL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|DELAY
argument_list|(
literal|240
argument_list|)
expr_stmt|;
comment|/* Is this really an EE16? */
if|if
condition|(
name|ie_ee16_port_check
argument_list|(
name|PORT
argument_list|(
name|sc
argument_list|)
argument_list|)
condition|)
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"ie_ee16_port_check() failed\n"
argument_list|)
expr_stmt|;
name|error
operator|=
name|ENXIO
expr_stmt|;
goto|goto
name|bad
goto|;
block|}
comment|/* need to put the 586 in RESET while we access the eeprom. */
name|outb
argument_list|(
name|PORT
argument_list|(
name|sc
argument_list|)
operator|+
name|IEE16_ECTRL
argument_list|,
name|IEE16_RESET_586
argument_list|)
expr_stmt|;
comment|/* read the eeprom and checksum it, should == IE_E16_ID */
name|checksum
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|0x40
condition|;
name|i
operator|++
control|)
name|checksum
operator|+=
name|ie_ee16_hw_read_eeprom
argument_list|(
name|PORT
argument_list|(
name|sc
argument_list|)
argument_list|,
name|i
argument_list|)
expr_stmt|;
if|if
condition|(
name|checksum
operator|!=
name|IE_EE16_ID
condition|)
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"invalid eeprom checksum: %x\n"
argument_list|,
name|checksum
argument_list|)
expr_stmt|;
name|error
operator|=
name|ENXIO
expr_stmt|;
goto|goto
name|bad
goto|;
block|}
if|if
condition|(
operator|(
name|kvtop
argument_list|(
name|sc
operator|->
name|iomembot
argument_list|)
operator|<
literal|0xC0000
operator|)
operator|||
operator|(
name|kvtop
argument_list|(
name|sc
operator|->
name|iomembot
argument_list|)
operator|+
name|sc
operator|->
name|iosize
operator|>
literal|0xF0000
operator|)
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
literal|"mapped memory location %p out of range\n"
argument_list|,
operator|(
name|void
operator|*
operator|)
name|sc
operator|->
name|iomembot
argument_list|)
expr_stmt|;
name|error
operator|=
name|ENXIO
expr_stmt|;
goto|goto
name|bad
goto|;
block|}
name|pg
operator|=
operator|(
operator|(
name|kvtop
argument_list|(
name|sc
operator|->
name|iomembot
argument_list|)
operator|)
operator|&
literal|0x3C000
operator|)
operator|>>
literal|14
expr_stmt|;
name|adjust
operator|=
name|IEE16_MCTRL_FMCS16
operator||
operator|(
name|pg
operator|&
literal|0x3
operator|)
operator|<<
literal|2
expr_stmt|;
name|decode
operator|=
operator|(
operator|(
literal|1
operator|<<
operator|(
name|sc
operator|->
name|iosize
operator|/
literal|16384
operator|)
operator|)
operator|-
literal|1
operator|)
operator|<<
name|pg
expr_stmt|;
name|edecode
operator|=
operator|(
operator|(
operator|~
name|decode
operator|>>
literal|4
operator|)
operator|&
literal|0xF0
operator|)
operator||
operator|(
name|decode
operator|>>
literal|8
operator|)
expr_stmt|;
comment|/* ZZZ This should be checked against eeprom location 6, low byte */
name|outb
argument_list|(
name|PORT
argument_list|(
name|sc
argument_list|)
operator|+
name|IEE16_MEMDEC
argument_list|,
name|decode
operator|&
literal|0xFF
argument_list|)
expr_stmt|;
comment|/* ZZZ This should be checked against eeprom location 1, low byte */
name|outb
argument_list|(
name|PORT
argument_list|(
name|sc
argument_list|)
operator|+
name|IEE16_MCTRL
argument_list|,
name|adjust
argument_list|)
expr_stmt|;
comment|/* ZZZ Now if I could find this one I would have it made */
name|outb
argument_list|(
name|PORT
argument_list|(
name|sc
argument_list|)
operator|+
name|IEE16_MPCTRL
argument_list|,
operator|(
operator|~
name|decode
operator|&
literal|0xFF
operator|)
argument_list|)
expr_stmt|;
comment|/* ZZZ I think this is location 6, high byte */
name|outb
argument_list|(
name|PORT
argument_list|(
name|sc
argument_list|)
operator|+
name|IEE16_MECTRL
argument_list|,
name|edecode
argument_list|)
expr_stmt|;
comment|/* XXX disable Exxx */
if|#
directive|if
literal|0
block|(void) kvtop(sc->iomembot);
endif|#
directive|endif
comment|/* 	 * first prime the stupid bart DRAM controller so that it works, 	 * then zero out all of memory. 	 */
name|bzero
argument_list|(
name|sc
operator|->
name|iomembot
argument_list|,
literal|32
argument_list|)
expr_stmt|;
name|bzero
argument_list|(
name|sc
operator|->
name|iomembot
argument_list|,
name|sc
operator|->
name|iosize
argument_list|)
expr_stmt|;
comment|/* Get the encoded interrupt number from the EEPROM */
name|sc
operator|->
name|irq_encoded
operator|=
name|ie_ee16_hw_read_eeprom
argument_list|(
name|PORT
argument_list|(
name|sc
argument_list|)
argument_list|,
name|IE_EE16_EEPROM_CONFIG1
argument_list|)
expr_stmt|;
name|sc
operator|->
name|irq_encoded
operator|=
operator|(
name|sc
operator|->
name|irq_encoded
operator|&
name|IE_EE16_EEPROM_IRQ_MASK
operator|)
operator|>>
name|IE_EE16_EEPROM_IRQ_SHIFT
expr_stmt|;
comment|/* 	 * Get the hardware ethernet address from the EEPROM and save it in 	 * the softc for use by the 586 setup code. 	 */
name|eaddrtemp
operator|=
name|ie_ee16_hw_read_eeprom
argument_list|(
name|PORT
argument_list|(
name|sc
argument_list|)
argument_list|,
name|IEE16_EEPROM_ENET_HIGH
argument_list|)
expr_stmt|;
name|sc
operator|->
name|enaddr
index|[
literal|1
index|]
operator|=
name|eaddrtemp
operator|&
literal|0xFF
expr_stmt|;
name|sc
operator|->
name|enaddr
index|[
literal|0
index|]
operator|=
name|eaddrtemp
operator|>>
literal|8
expr_stmt|;
name|eaddrtemp
operator|=
name|ie_ee16_hw_read_eeprom
argument_list|(
name|PORT
argument_list|(
name|sc
argument_list|)
argument_list|,
name|IEE16_EEPROM_ENET_MID
argument_list|)
expr_stmt|;
name|sc
operator|->
name|enaddr
index|[
literal|3
index|]
operator|=
name|eaddrtemp
operator|&
literal|0xFF
expr_stmt|;
name|sc
operator|->
name|enaddr
index|[
literal|2
index|]
operator|=
name|eaddrtemp
operator|>>
literal|8
expr_stmt|;
name|eaddrtemp
operator|=
name|ie_ee16_hw_read_eeprom
argument_list|(
name|PORT
argument_list|(
name|sc
argument_list|)
argument_list|,
name|IEE16_EEPROM_ENET_LOW
argument_list|)
expr_stmt|;
name|sc
operator|->
name|enaddr
index|[
literal|5
index|]
operator|=
name|eaddrtemp
operator|&
literal|0xFF
expr_stmt|;
name|sc
operator|->
name|enaddr
index|[
literal|4
index|]
operator|=
name|eaddrtemp
operator|>>
literal|8
expr_stmt|;
comment|/* disable the board interrupts */
name|outb
argument_list|(
name|PORT
argument_list|(
name|sc
argument_list|)
operator|+
name|IEE16_IRQ
argument_list|,
name|sc
operator|->
name|irq_encoded
argument_list|)
expr_stmt|;
comment|/* enable loopback to keep bad packets off the wire */
name|bart_config
operator|=
name|inb
argument_list|(
name|PORT
argument_list|(
name|sc
argument_list|)
operator|+
name|IEE16_CONFIG
argument_list|)
expr_stmt|;
name|bart_config
operator||=
name|IEE16_BART_LOOPBACK
expr_stmt|;
name|bart_config
operator||=
name|IEE16_BART_MCS16_TEST
expr_stmt|;
comment|/* inb doesn't get bit! */
name|outb
argument_list|(
name|PORT
argument_list|(
name|sc
argument_list|)
operator|+
name|IEE16_CONFIG
argument_list|,
name|bart_config
argument_list|)
expr_stmt|;
name|bart_config
operator|=
name|inb
argument_list|(
name|PORT
argument_list|(
name|sc
argument_list|)
operator|+
name|IEE16_CONFIG
argument_list|)
expr_stmt|;
comment|/* take the board out of reset state */
name|outb
argument_list|(
name|PORT
argument_list|(
name|sc
argument_list|)
operator|+
name|IEE16_ECTRL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|DELAY
argument_list|(
literal|100
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|check_ie_present
argument_list|(
name|sc
argument_list|)
condition|)
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"check_ie_present() returned false.\n"
argument_list|)
expr_stmt|;
name|error
operator|=
name|ENXIO
expr_stmt|;
goto|goto
name|bad
goto|;
block|}
name|error
operator|=
name|ie_attach
argument_list|(
name|dev
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"ie_attach() failed.\n"
argument_list|)
expr_stmt|;
goto|goto
name|bad
goto|;
block|}
name|error
operator|=
name|bus_setup_intr
argument_list|(
name|dev
argument_list|,
name|sc
operator|->
name|irq_res
argument_list|,
name|INTR_TYPE_NET
argument_list|,
name|NULL
argument_list|,
name|ie_intr
argument_list|,
name|sc
argument_list|,
operator|&
name|sc
operator|->
name|irq_ih
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"Unable to register interrupt handler\n"
argument_list|)
expr_stmt|;
goto|goto
name|bad
goto|;
block|}
return|return
operator|(
literal|0
operator|)
return|;
name|bad
label|:
name|ie_release_resources
argument_list|(
name|dev
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * If an EE16 is present, return 0  * else, return 1.  */
end_comment

begin_function
specifier|static
name|int
name|ie_ee16_port_check
parameter_list|(
name|u_int32_t
name|port
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
name|u_int16_t
name|board_id
decl_stmt|;
name|u_int8_t
name|data
decl_stmt|;
name|board_id
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|4
condition|;
name|i
operator|++
control|)
block|{
name|data
operator|=
name|inb
argument_list|(
name|port
operator|+
name|IE_EE16_ID_PORT
argument_list|)
expr_stmt|;
name|board_id
operator||=
operator|(
operator|(
name|data
operator|>>
literal|4
operator|)
operator|<<
operator|(
operator|(
name|data
operator|&
literal|0x03
operator|)
operator|<<
literal|2
operator|)
operator|)
expr_stmt|;
block|}
if|if
condition|(
name|board_id
operator|!=
name|IE_EE16_ID
condition|)
return|return
operator|(
literal|1
operator|)
return|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|ie_ee16_hw_eeprom_clock
parameter_list|(
name|u_int32_t
name|port
parameter_list|,
name|int
name|state
parameter_list|)
block|{
name|u_int8_t
name|ectrl
decl_stmt|;
name|ectrl
operator|=
name|inb
argument_list|(
name|port
operator|+
name|IEE16_ECTRL
argument_list|)
expr_stmt|;
name|ectrl
operator|&=
operator|~
operator|(
name|IEE16_RESET_ASIC
operator||
name|IEE16_ECTRL_EESK
operator|)
expr_stmt|;
if|if
condition|(
name|state
condition|)
block|{
name|ectrl
operator||=
name|IEE16_ECTRL_EESK
expr_stmt|;
block|}
name|outb
argument_list|(
name|port
operator|+
name|IEE16_ECTRL
argument_list|,
name|ectrl
argument_list|)
expr_stmt|;
name|DELAY
argument_list|(
literal|9
argument_list|)
expr_stmt|;
comment|/* EESK must be stable for 8.38 uSec */
block|}
end_function

begin_function
specifier|static
name|void
name|ie_ee16_hw_eeprom_out
parameter_list|(
name|u_int32_t
name|port
parameter_list|,
name|u_int16_t
name|edata
parameter_list|,
name|int
name|count
parameter_list|)
block|{
name|u_int8_t
name|ectrl
decl_stmt|;
name|int
name|i
decl_stmt|;
name|ectrl
operator|=
name|inb
argument_list|(
name|port
operator|+
name|IEE16_ECTRL
argument_list|)
expr_stmt|;
name|ectrl
operator|&=
operator|~
name|IEE16_RESET_ASIC
expr_stmt|;
for|for
control|(
name|i
operator|=
name|count
operator|-
literal|1
init|;
name|i
operator|>=
literal|0
condition|;
name|i
operator|--
control|)
block|{
name|ectrl
operator|&=
operator|~
name|IEE16_ECTRL_EEDI
expr_stmt|;
if|if
condition|(
name|edata
operator|&
operator|(
literal|1
operator|<<
name|i
operator|)
condition|)
block|{
name|ectrl
operator||=
name|IEE16_ECTRL_EEDI
expr_stmt|;
block|}
name|outb
argument_list|(
name|port
operator|+
name|IEE16_ECTRL
argument_list|,
name|ectrl
argument_list|)
expr_stmt|;
name|DELAY
argument_list|(
literal|1
argument_list|)
expr_stmt|;
comment|/* eeprom data must be setup for 0.4 uSec */
name|ie_ee16_hw_eeprom_clock
argument_list|(
name|port
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|ie_ee16_hw_eeprom_clock
argument_list|(
name|port
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
name|ectrl
operator|&=
operator|~
name|IEE16_ECTRL_EEDI
expr_stmt|;
name|outb
argument_list|(
name|port
operator|+
name|IEE16_ECTRL
argument_list|,
name|ectrl
argument_list|)
expr_stmt|;
name|DELAY
argument_list|(
literal|1
argument_list|)
expr_stmt|;
comment|/* eeprom data must be held for 0.4 uSec */
return|return;
block|}
end_function

begin_function
specifier|static
name|u_int16_t
name|ie_ee16_hw_eeprom_in
parameter_list|(
name|u_int32_t
name|port
parameter_list|)
block|{
name|u_int8_t
name|ectrl
decl_stmt|;
name|u_int16_t
name|edata
decl_stmt|;
name|int
name|i
decl_stmt|;
name|ectrl
operator|=
name|inb
argument_list|(
name|port
operator|+
name|IEE16_ECTRL
argument_list|)
expr_stmt|;
name|ectrl
operator|&=
operator|~
name|IEE16_RESET_ASIC
expr_stmt|;
for|for
control|(
name|edata
operator|=
literal|0
operator|,
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|16
condition|;
name|i
operator|++
control|)
block|{
name|edata
operator|=
name|edata
operator|<<
literal|1
expr_stmt|;
name|ie_ee16_hw_eeprom_clock
argument_list|(
name|port
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|ectrl
operator|=
name|inb
argument_list|(
name|port
operator|+
name|IEE16_ECTRL
argument_list|)
expr_stmt|;
if|if
condition|(
name|ectrl
operator|&
name|IEE16_ECTRL_EEDO
condition|)
block|{
name|edata
operator||=
literal|1
expr_stmt|;
block|}
name|ie_ee16_hw_eeprom_clock
argument_list|(
name|port
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
return|return
operator|(
name|edata
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|u_int16_t
name|ie_ee16_hw_read_eeprom
parameter_list|(
name|u_int32_t
name|port
parameter_list|,
name|int
name|loc
parameter_list|)
block|{
name|u_int8_t
name|ectrl
decl_stmt|;
name|u_int16_t
name|edata
decl_stmt|;
name|ectrl
operator|=
name|inb
argument_list|(
name|port
operator|+
name|IEE16_ECTRL
argument_list|)
expr_stmt|;
name|ectrl
operator|&=
name|IEE16_ECTRL_MASK
expr_stmt|;
name|ectrl
operator||=
name|IEE16_ECTRL_EECS
expr_stmt|;
name|outb
argument_list|(
name|port
operator|+
name|IEE16_ECTRL
argument_list|,
name|ectrl
argument_list|)
expr_stmt|;
name|ie_ee16_hw_eeprom_out
argument_list|(
name|port
argument_list|,
name|IEE16_EEPROM_READ
argument_list|,
name|IEE16_EEPROM_OPSIZE1
argument_list|)
expr_stmt|;
name|ie_ee16_hw_eeprom_out
argument_list|(
name|port
argument_list|,
name|loc
argument_list|,
name|IEE16_EEPROM_ADDR_SIZE
argument_list|)
expr_stmt|;
name|edata
operator|=
name|ie_ee16_hw_eeprom_in
argument_list|(
name|port
argument_list|)
expr_stmt|;
name|ectrl
operator|=
name|inb
argument_list|(
name|port
operator|+
name|IEE16_ECTRL
argument_list|)
expr_stmt|;
name|ectrl
operator|&=
operator|~
operator|(
name|IEE16_RESET_ASIC
operator||
name|IEE16_ECTRL_EEDI
operator||
name|IEE16_ECTRL_EECS
operator|)
expr_stmt|;
name|outb
argument_list|(
name|port
operator|+
name|IEE16_ECTRL
argument_list|,
name|ectrl
argument_list|)
expr_stmt|;
name|ie_ee16_hw_eeprom_clock
argument_list|(
name|port
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|ie_ee16_hw_eeprom_clock
argument_list|(
name|port
argument_list|,
literal|0
argument_list|)
expr_stmt|;
return|return
operator|(
name|edata
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * AT&T StarLan/  */
end_comment

begin_function
specifier|static
name|int
name|ie_isa_sl_probe
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
name|u_int32_t
name|iobase
decl_stmt|;
comment|/* No ISA-PnP support */
if|if
condition|(
name|isa_get_vendorid
argument_list|(
name|dev
argument_list|)
condition|)
return|return
operator|(
name|ENXIO
operator|)
return|;
comment|/* ISA-HINT support only! */
if|if
condition|(
name|device_get_desc
argument_list|(
name|dev
argument_list|)
condition|)
return|return
operator|(
name|EBUSY
operator|)
return|;
comment|/* Have we at least an ioport? */
if|if
condition|(
operator|(
name|iobase
operator|=
name|bus_get_resource_start
argument_list|(
name|dev
argument_list|,
name|SYS_RES_IOPORT
argument_list|,
literal|0
argument_list|)
operator|)
operator|==
literal|0
condition|)
return|return
operator|(
name|ENXIO
operator|)
return|;
comment|/* Is this really an SL board? */
if|if
condition|(
name|ie_isa_sl_get_hard_type
argument_list|(
name|iobase
argument_list|)
operator|==
name|IE_NONE
condition|)
return|return
operator|(
name|ENXIO
operator|)
return|;
return|return
operator|(
name|ENXIO
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|ie_isa_sl_attach
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
name|struct
name|ie_softc
modifier|*
name|sc
decl_stmt|;
name|int
name|error
decl_stmt|;
name|sc
operator|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
expr_stmt|;
name|sc
operator|->
name|io_rid
operator|=
literal|0
expr_stmt|;
name|sc
operator|->
name|irq_rid
operator|=
literal|0
expr_stmt|;
name|sc
operator|->
name|mem_rid
operator|=
literal|0
expr_stmt|;
name|error
operator|=
name|ie_alloc_resources
argument_list|(
name|dev
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
block|{
goto|goto
name|bad
goto|;
block|}
comment|/* Is this really an SL board? */
if|if
condition|(
operator|(
name|sc
operator|->
name|hard_type
operator|=
name|ie_isa_sl_get_hard_type
argument_list|(
name|PORT
argument_list|(
name|sc
argument_list|)
argument_list|)
operator|)
operator|==
name|IE_NONE
condition|)
block|{
name|error
operator|=
name|ENXIO
expr_stmt|;
goto|goto
name|bad
goto|;
block|}
name|sc
operator|->
name|hard_vers
operator|=
name|SL_REV
argument_list|(
name|inb
argument_list|(
name|PORT
argument_list|(
name|sc
argument_list|)
operator|+
name|IEATT_REVISION
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|hard_type
operator|==
name|IE_NI5210
condition|)
block|{
name|sc
operator|->
name|bus_use
operator|=
literal|1
expr_stmt|;
block|}
else|else
block|{
name|sc
operator|->
name|bus_use
operator|=
literal|0
expr_stmt|;
block|}
name|sc
operator|->
name|ie_reset_586
operator|=
name|sl_reset_586
expr_stmt|;
name|sc
operator|->
name|ie_chan_attn
operator|=
name|sl_chan_attn
expr_stmt|;
if|if
condition|(
operator|!
name|check_ie_present
argument_list|(
name|sc
argument_list|)
condition|)
block|{
name|error
operator|=
name|ENXIO
expr_stmt|;
goto|goto
name|bad
goto|;
block|}
switch|switch
condition|(
name|sc
operator|->
name|hard_type
condition|)
block|{
case|case
name|IE_EN100
case|:
case|case
name|IE_STARLAN10
case|:
case|case
name|IE_SLFIBER
case|:
case|case
name|IE_NI5210
case|:
name|sl_read_ether
argument_list|(
name|sc
argument_list|,
name|sc
operator|->
name|enaddr
argument_list|)
expr_stmt|;
break|break;
default|default:
if|if
condition|(
name|bootverbose
condition|)
name|device_printf
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
literal|"unknown AT&T board type code %d\n"
argument_list|,
name|sc
operator|->
name|hard_type
argument_list|)
expr_stmt|;
name|error
operator|=
name|ENXIO
expr_stmt|;
goto|goto
name|bad
goto|;
break|break;
block|}
name|error
operator|=
name|ie_attach
argument_list|(
name|dev
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"ie_attach() failed.\n"
argument_list|)
expr_stmt|;
goto|goto
name|bad
goto|;
block|}
name|error
operator|=
name|bus_setup_intr
argument_list|(
name|dev
argument_list|,
name|sc
operator|->
name|irq_res
argument_list|,
name|INTR_TYPE_NET
argument_list|,
name|NULL
argument_list|,
name|ie_intr
argument_list|,
name|sc
argument_list|,
operator|&
name|sc
operator|->
name|irq_ih
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"Unable to register interrupt handler\n"
argument_list|)
expr_stmt|;
goto|goto
name|bad
goto|;
block|}
return|return
operator|(
literal|0
operator|)
return|;
name|bad
label|:
name|ie_release_resources
argument_list|(
name|dev
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|enum
name|ie_hardware
name|ie_isa_sl_get_hard_type
parameter_list|(
name|u_int32_t
name|port
parameter_list|)
block|{
name|u_char
name|c
decl_stmt|;
name|enum
name|ie_hardware
name|retval
decl_stmt|;
name|c
operator|=
name|inb
argument_list|(
name|port
operator|+
name|IEATT_REVISION
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|SL_BOARD
argument_list|(
name|c
argument_list|)
condition|)
block|{
case|case
name|SL1_BOARD
case|:
if|if
condition|(
name|inb
argument_list|(
name|port
operator|+
name|IEATT_ATTRIB
argument_list|)
operator|!=
name|NI5210_BOARD
condition|)
name|retval
operator|=
name|IE_NONE
expr_stmt|;
name|retval
operator|=
name|IE_NI5210
expr_stmt|;
break|break;
case|case
name|SL10_BOARD
case|:
name|retval
operator|=
name|IE_STARLAN10
expr_stmt|;
break|break;
case|case
name|EN100_BOARD
case|:
name|retval
operator|=
name|IE_EN100
expr_stmt|;
break|break;
case|case
name|SLFIBER_BOARD
case|:
name|retval
operator|=
name|IE_SLFIBER
expr_stmt|;
break|break;
default|default:
name|retval
operator|=
name|IE_NONE
expr_stmt|;
block|}
return|return
operator|(
name|retval
operator|)
return|;
block|}
end_function

begin_decl_stmt
specifier|static
name|devclass_t
name|ie_devclass
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|device_method_t
name|ie_isa_3C507_methods
index|[]
init|=
block|{
name|DEVMETHOD
argument_list|(
name|device_identify
argument_list|,
name|ie_isa_3C507_identify
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|device_probe
argument_list|,
name|ie_isa_3C507_probe
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|device_attach
argument_list|,
name|ie_isa_3C507_attach
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|device_detach
argument_list|,
name|ie_detach
argument_list|)
block|,
block|{
literal|0
block|,
literal|0
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|driver_t
name|ie_isa_3C507_driver
init|=
block|{
literal|"ie"
block|,
name|ie_isa_3C507_methods
block|,
sizeof|sizeof
argument_list|(
expr|struct
name|ie_softc
argument_list|)
block|,  }
decl_stmt|;
end_decl_stmt

begin_expr_stmt
name|DRIVER_MODULE
argument_list|(
name|ie_3C507
argument_list|,
name|isa
argument_list|,
name|ie_isa_3C507_driver
argument_list|,
name|ie_devclass
argument_list|,
name|ie_modevent
argument_list|,
literal|0
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|MODULE_DEPEND
argument_list|(
name|ie_3C507
argument_list|,
name|elink
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|)
expr_stmt|;
end_expr_stmt

begin_decl_stmt
specifier|static
name|device_method_t
name|ie_isa_ee16_methods
index|[]
init|=
block|{
name|DEVMETHOD
argument_list|(
name|device_identify
argument_list|,
name|ie_isa_ee16_identify
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|device_probe
argument_list|,
name|ie_isa_ee16_probe
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|device_attach
argument_list|,
name|ie_isa_ee16_attach
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|device_detach
argument_list|,
name|ie_detach
argument_list|)
block|,
block|{
literal|0
block|,
literal|0
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|driver_t
name|ie_isa_ee16_driver
init|=
block|{
literal|"ie"
block|,
name|ie_isa_ee16_methods
block|,
sizeof|sizeof
argument_list|(
expr|struct
name|ie_softc
argument_list|)
block|,  }
decl_stmt|;
end_decl_stmt

begin_expr_stmt
name|DRIVER_MODULE
argument_list|(
name|ie_EE16
argument_list|,
name|isa
argument_list|,
name|ie_isa_ee16_driver
argument_list|,
name|ie_devclass
argument_list|,
name|ie_modevent
argument_list|,
literal|0
argument_list|)
expr_stmt|;
end_expr_stmt

begin_decl_stmt
specifier|static
name|device_method_t
name|ie_isa_sl_methods
index|[]
init|=
block|{
name|DEVMETHOD
argument_list|(
name|device_probe
argument_list|,
name|ie_isa_sl_probe
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|device_attach
argument_list|,
name|ie_isa_sl_attach
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|device_detach
argument_list|,
name|ie_detach
argument_list|)
block|,
block|{
literal|0
block|,
literal|0
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|driver_t
name|ie_isa_sl_driver
init|=
block|{
literal|"ie"
block|,
name|ie_isa_sl_methods
block|,
sizeof|sizeof
argument_list|(
expr|struct
name|ie_softc
argument_list|)
block|,  }
decl_stmt|;
end_decl_stmt

begin_expr_stmt
name|DRIVER_MODULE
argument_list|(
name|ie_SL
argument_list|,
name|isa
argument_list|,
name|ie_isa_sl_driver
argument_list|,
name|ie_devclass
argument_list|,
name|ie_modevent
argument_list|,
literal|0
argument_list|)
expr_stmt|;
end_expr_stmt

begin_function
specifier|static
name|int
name|ie_modevent
parameter_list|(
name|mod
parameter_list|,
name|what
parameter_list|,
name|arg
parameter_list|)
name|module_t
name|mod
decl_stmt|;
name|int
name|what
decl_stmt|;
name|void
modifier|*
name|arg
decl_stmt|;
block|{
name|device_t
modifier|*
name|devs
decl_stmt|;
name|int
name|count
decl_stmt|;
name|int
name|i
decl_stmt|;
switch|switch
condition|(
name|what
condition|)
block|{
case|case
name|MOD_LOAD
case|:
break|break;
case|case
name|MOD_UNLOAD
case|:
name|devclass_get_devices
argument_list|(
name|ie_devclass
argument_list|,
operator|&
name|devs
argument_list|,
operator|&
name|count
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|count
condition|;
name|i
operator|++
control|)
name|device_delete_child
argument_list|(
name|device_get_parent
argument_list|(
name|devs
index|[
name|i
index|]
argument_list|)
argument_list|,
name|devs
index|[
name|i
index|]
argument_list|)
expr_stmt|;
break|break;
default|default:
break|break;
block|}
empty_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

end_unit


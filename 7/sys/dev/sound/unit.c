begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*-  * Copyright (c) 2007 Ariff Abdullah<ariff@FreeBSD.org>  * All rights reserved.  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions  * are met:  * 1. Redistributions of source code must retain the above copyright  *    notice, this list of conditions and the following disclaimer.  * 2. Redistributions in binary form must reproduce the above copyright  *    notice, this list of conditions and the following disclaimer in the  *    documentation and/or other materials provided with the distribution.  *  * THIS SOFTWARE IS PROVIDED BY THE AUTHOR AND CONTRIBUTORS ``AS IS'' AND  * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE  * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE  * ARE DISCLAIMED.  IN NO EVENT SHALL THE AUTHOR OR CONTRIBUTORS BE LIABLE  * FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL  * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS  * OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)  * HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT  * LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY  * OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF  * SUCH DAMAGE.  *  * $FreeBSD$  */
end_comment

begin_include
include|#
directive|include
file|<sys/param.h>
end_include

begin_include
include|#
directive|include
file|<sys/systm.h>
end_include

begin_include
include|#
directive|include
file|<dev/sound/unit.h>
end_include

begin_comment
comment|/*  * Unit magic allocator for sound driver.  *  * 'u' = Unit of attached soundcards  * 'd' = Device type  * 'c' = Channel number  *  * eg: dsp0.p1  - u=0, d=p, c=1  *     dsp1.vp0 - u=1, d=vp, c=0  *     dsp0.10  - u=0, d=clone, c=allocated clone (see further explanation)  *  * Maximum unit of soundcards can be tuned through "hw.snd.maxunit", which  * is between SND_UNIT_UMIN (16) and SND_UNIT_UMAX (2048). By design,  * maximum allowable allocated channel is 256, with exception for clone  * devices which doesn't have any notion of channel numbering. The use of  * channel numbering in a clone device is simply to provide uniqueness among  * allocated clones. This also means that the maximum allowable clonable  * device is largely dependant and dynamically tuned depending on  * hw.snd.maxunit.  */
end_comment

begin_comment
comment|/* Default width */
end_comment

begin_decl_stmt
specifier|static
name|int
name|snd_u_shift
init|=
literal|9
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* 0 - 0x1ff :  512 distinct soundcards   */
end_comment

begin_decl_stmt
specifier|static
name|int
name|snd_d_shift
init|=
literal|5
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* 0 - 0x1f  :   32 distinct device types */
end_comment

begin_decl_stmt
specifier|static
name|int
name|snd_c_shift
init|=
literal|10
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* 0 - 0x3ff : 1024 distinct channels 					       (256 limit "by design", 					       except for clone devices)  */
end_comment

begin_decl_stmt
specifier|static
name|int
name|snd_unit_initialized
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_ifdef
ifdef|#
directive|ifdef
name|SND_DIAGNOSTIC
end_ifdef

begin_define
define|#
directive|define
name|SND_UNIT_ASSERT
parameter_list|()
value|do {					\ 	if (snd_unit_initialized == 0)					\ 		panic("%s(): Uninitialized sound unit!", __func__);	\ } while(0)
end_define

begin_else
else|#
directive|else
end_else

begin_define
define|#
directive|define
name|SND_UNIT_ASSERT
parameter_list|()
value|KASSERT(snd_unit_initialized != 0,	\ 				("%s(): Uninitialized sound unit!",	\ 				__func__))
end_define

begin_endif
endif|#
directive|endif
end_endif

begin_define
define|#
directive|define
name|MKMASK
parameter_list|(
name|x
parameter_list|)
value|((1<< snd_##x##_shift) - 1)
end_define

begin_function
name|int
name|snd_max_u
parameter_list|(
name|void
parameter_list|)
block|{
name|SND_UNIT_ASSERT
argument_list|()
expr_stmt|;
return|return
operator|(
name|MKMASK
argument_list|(
name|u
argument_list|)
operator|)
return|;
block|}
end_function

begin_function
name|int
name|snd_max_d
parameter_list|(
name|void
parameter_list|)
block|{
name|SND_UNIT_ASSERT
argument_list|()
expr_stmt|;
return|return
operator|(
name|MKMASK
argument_list|(
name|d
argument_list|)
operator|)
return|;
block|}
end_function

begin_function
name|int
name|snd_max_c
parameter_list|(
name|void
parameter_list|)
block|{
name|SND_UNIT_ASSERT
argument_list|()
expr_stmt|;
return|return
operator|(
name|MKMASK
argument_list|(
name|c
argument_list|)
operator|)
return|;
block|}
end_function

begin_function
name|int
name|snd_unit2u
parameter_list|(
name|int
name|unit
parameter_list|)
block|{
name|SND_UNIT_ASSERT
argument_list|()
expr_stmt|;
return|return
operator|(
operator|(
name|unit
operator|>>
operator|(
name|snd_c_shift
operator|+
name|snd_d_shift
operator|)
operator|)
operator|&
name|MKMASK
argument_list|(
name|u
argument_list|)
operator|)
return|;
block|}
end_function

begin_function
name|int
name|snd_unit2d
parameter_list|(
name|int
name|unit
parameter_list|)
block|{
name|SND_UNIT_ASSERT
argument_list|()
expr_stmt|;
return|return
operator|(
operator|(
name|unit
operator|>>
name|snd_c_shift
operator|)
operator|&
name|MKMASK
argument_list|(
name|d
argument_list|)
operator|)
return|;
block|}
end_function

begin_function
name|int
name|snd_unit2c
parameter_list|(
name|int
name|unit
parameter_list|)
block|{
name|SND_UNIT_ASSERT
argument_list|()
expr_stmt|;
return|return
operator|(
name|unit
operator|&
name|MKMASK
argument_list|(
name|c
argument_list|)
operator|)
return|;
block|}
end_function

begin_function
name|int
name|snd_u2unit
parameter_list|(
name|int
name|u
parameter_list|)
block|{
name|SND_UNIT_ASSERT
argument_list|()
expr_stmt|;
return|return
operator|(
operator|(
name|u
operator|&
name|MKMASK
argument_list|(
name|u
argument_list|)
operator|)
operator|<<
operator|(
name|snd_c_shift
operator|+
name|snd_d_shift
operator|)
operator|)
return|;
block|}
end_function

begin_function
name|int
name|snd_d2unit
parameter_list|(
name|int
name|d
parameter_list|)
block|{
name|SND_UNIT_ASSERT
argument_list|()
expr_stmt|;
return|return
operator|(
operator|(
name|d
operator|&
name|MKMASK
argument_list|(
name|d
argument_list|)
operator|)
operator|<<
name|snd_c_shift
operator|)
return|;
block|}
end_function

begin_function
name|int
name|snd_c2unit
parameter_list|(
name|int
name|c
parameter_list|)
block|{
name|SND_UNIT_ASSERT
argument_list|()
expr_stmt|;
return|return
operator|(
name|c
operator|&
name|MKMASK
argument_list|(
name|c
argument_list|)
operator|)
return|;
block|}
end_function

begin_function
name|int
name|snd_mkunit
parameter_list|(
name|int
name|u
parameter_list|,
name|int
name|d
parameter_list|,
name|int
name|c
parameter_list|)
block|{
name|SND_UNIT_ASSERT
argument_list|()
expr_stmt|;
return|return
operator|(
operator|(
name|c
operator|&
name|MKMASK
argument_list|(
name|c
argument_list|)
operator|)
operator||
operator|(
operator|(
name|d
operator|&
name|MKMASK
argument_list|(
name|d
argument_list|)
operator|)
operator|<<
name|snd_c_shift
operator|)
operator||
operator|(
operator|(
name|u
operator|&
name|MKMASK
argument_list|(
name|u
argument_list|)
operator|)
operator|<<
operator|(
name|snd_c_shift
operator|+
name|snd_d_shift
operator|)
operator|)
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * This *must* be called first before any of the functions above!!!  */
end_comment

begin_function
name|void
name|snd_unit_init
parameter_list|(
name|void
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
if|if
condition|(
name|snd_unit_initialized
operator|!=
literal|0
condition|)
return|return;
name|snd_unit_initialized
operator|=
literal|1
expr_stmt|;
if|if
condition|(
name|getenv_int
argument_list|(
literal|"hw.snd.maxunit"
argument_list|,
operator|&
name|i
argument_list|)
operator|!=
literal|0
condition|)
block|{
if|if
condition|(
name|i
operator|<
name|SND_UNIT_UMIN
condition|)
name|i
operator|=
name|SND_UNIT_UMIN
expr_stmt|;
elseif|else
if|if
condition|(
name|i
operator|>
name|SND_UNIT_UMAX
condition|)
name|i
operator|=
name|SND_UNIT_UMAX
expr_stmt|;
else|else
name|i
operator|=
name|roundup2
argument_list|(
name|i
argument_list|,
literal|2
argument_list|)
expr_stmt|;
for|for
control|(
name|snd_u_shift
operator|=
literal|0
init|;
operator|(
name|i
operator|>>
operator|(
name|snd_u_shift
operator|+
literal|1
operator|)
operator|)
operator|!=
literal|0
condition|;
name|snd_u_shift
operator|++
control|)
empty_stmt|;
comment|/* 		 * Make room for channels/clones allocation unit 		 * to fit within 24bit MAXMINOR limit. 		 */
name|snd_c_shift
operator|=
literal|24
operator|-
name|snd_u_shift
operator|-
name|snd_d_shift
expr_stmt|;
block|}
if|if
condition|(
name|bootverbose
operator|!=
literal|0
condition|)
name|printf
argument_list|(
literal|"%s() u=0x%08x [%d] d=0x%08x [%d] c=0x%08x [%d]\n"
argument_list|,
name|__func__
argument_list|,
name|SND_U_MASK
argument_list|,
name|snd_max_u
argument_list|()
operator|+
literal|1
argument_list|,
name|SND_D_MASK
argument_list|,
name|snd_max_d
argument_list|()
operator|+
literal|1
argument_list|,
name|SND_C_MASK
argument_list|,
name|snd_max_c
argument_list|()
operator|+
literal|1
argument_list|)
expr_stmt|;
block|}
end_function

end_unit


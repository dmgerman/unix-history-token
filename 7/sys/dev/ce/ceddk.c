begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Middle-level code for Cronyx Tau32-PCI adapters.  *  * Copyright (C) 2004 Cronyx Engineering  * Copyright (C) 2004 Roman Kurakin<rik@FreeBSD.org>  *  * This software is distributed with NO WARRANTIES, not even the implied  * warranties for MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  *  * Authors grant any other persons or organisations a permission to use,  * modify and redistribute this software in source and binary forms,  * as long as this message is kept with the software, all derivative  * works or modified versions.  *  * $Cronyx: ceddk.c,v 1.2.6.2 2005/11/17 16:04:13 rik Exp $  */
end_comment

begin_include
include|#
directive|include
file|<sys/cdefs.h>
end_include

begin_expr_stmt
name|__FBSDID
argument_list|(
literal|"$FreeBSD$"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_include
include|#
directive|include
file|<dev/cx/machdep.h>
end_include

begin_include
include|#
directive|include
file|<dev/ce/ceddk.h>
end_include

begin_undef
undef|#
directive|undef
name|CE_DDK_DEBUG_ENABLED
end_undef

begin_ifdef
ifdef|#
directive|ifdef
name|CE_DDK_DEBUG_ENABLED
end_ifdef

begin_ifdef
ifdef|#
directive|ifdef
name|__FreeBSD__
end_ifdef

begin_define
define|#
directive|define
name|CE_DDK_DEBUG
parameter_list|(
name|b
parameter_list|,
name|c
parameter_list|,
name|s
parameter_list|)
define|\
value|do { \ 		if (c) { \ 			printf("ce%d-%d: ",(b)->num,(c)->num); \ 		} else { \ 			printf("ce%d-*: ",(b)->num); \ 		} \ 		printf s; \ 	} while (0)
end_define

begin_else
else|#
directive|else
end_else

begin_define
define|#
directive|define
name|CE_DDK_DEBUG
parameter_list|(
name|b
parameter_list|,
name|c
parameter_list|,
name|s
parameter_list|)
value|do {} while (0)
end_define

begin_endif
endif|#
directive|endif
end_endif

begin_else
else|#
directive|else
end_else

begin_define
define|#
directive|define
name|CE_DDK_DEBUG
parameter_list|(
name|b
parameter_list|,
name|c
parameter_list|,
name|s
parameter_list|)
value|do {} while (0)
end_define

begin_endif
endif|#
directive|endif
end_endif

begin_if
if|#
directive|if
literal|0
end_if

begin_define
define|#
directive|define
name|ENTER
parameter_list|()
define|\
value|static int enter=0; \ 	do { \ 	enter++; \ 	printf ("%s:>> enter (%16llx) %d\n", __FUNCTION__, rdtsc (), enter); \ 	} while (0)
end_define

begin_define
define|#
directive|define
name|EXIT
parameter_list|(
name|val
modifier|...
parameter_list|)
define|\
value|do { \ 	enter--; \ 	printf ("%s:<< exit  (%16llx) %d line %d\n", __FUNCTION__, rdtsc (), enter, __LINE__); \ 	return val; \ 	} while (0)
end_define

begin_else
else|#
directive|else
end_else

begin_define
define|#
directive|define
name|ENTER
parameter_list|()
define|\
value|do {} while (0)
end_define

begin_define
define|#
directive|define
name|EXIT
parameter_list|(
name|val
modifier|...
parameter_list|)
define|\
value|do {return val;} while (0)
end_define

begin_endif
endif|#
directive|endif
end_endif

begin_define
define|#
directive|define
name|CE_ENQUEUE
parameter_list|(
name|list
parameter_list|,
name|item
parameter_list|)
define|\
value|do { \ 		TAU32_UserRequest **last; \ 		last =&(list); \ 		while (*last) { \ 			last =&(*last)->next; \ 		} \ 		(*last) = (item); \ 		(item)->next = NULL; \ 	} while (0)
end_define

begin_define
define|#
directive|define
name|CE_ENQUEUE_HEAD
parameter_list|(
name|list
parameter_list|,
name|item
parameter_list|)
define|\
value|do { \ 		(item)->next = list; \ 		list = item; \ 	} while (0)
end_define

begin_define
define|#
directive|define
name|CE_DEQUEUE
parameter_list|(
name|list
parameter_list|,
name|item
parameter_list|)
define|\
value|do { \ 		item = list; \ 		if (list) { \ 			list = (item)->next; \ 		} \ 	} while (0)
end_define

begin_define
define|#
directive|define
name|CE_PREREQUEST
parameter_list|(
name|b
parameter_list|,
name|c
parameter_list|,
name|list
parameter_list|,
name|item
parameter_list|)
define|\
value|do { \ 		item = list; \ 		if (!item) { \ 			CE_DDK_DEBUG (b, c, ("Fatal error, no free structs " \ 					     "for UserRequest (%s:%d)\n", \ 					     __FUNCTION__, __LINE__)); \ 		} \ 	} while (0)
end_define

begin_define
define|#
directive|define
name|CE_DUMP_QUEUE
parameter_list|(
name|list
parameter_list|)
define|\
value|do { \ 		TAU32_UserRequest *item; \ 		int i = 0; \ 		item = list; \ 		while (item) { \ 			printf ("item%d: %p\n", i, item); \ 			item = item->next; \ 			i++; \ 		} \ 	} while (0)
end_define

begin_define
define|#
directive|define
name|CE_FIND_ITEM
parameter_list|(
name|list
parameter_list|,
name|item
parameter_list|,
name|flag
parameter_list|)
define|\
value|do { \ 		TAU32_UserRequest *citem; \ 		flag = 0; \ 		for (citem = list; citem; citem = citem->next) { \ 			if (citem == item) { \ 				flag = 1; \ 				break; \ 			} \ 		} \ 	} while (0)
end_define

begin_define
define|#
directive|define
name|CE_LAST_ITEM
parameter_list|(
name|list
parameter_list|,
name|item
parameter_list|)
define|\
value|do { \ 		TAU32_UserRequest **last; \ 		last =&(list); \ 		while ((*last)&& (*last)->next) { \ 			last =&(*last)->next; \ 		} \ 		(item) = (*last); \ 	} while (0)
end_define

begin_define
define|#
directive|define
name|CE_ASSERT
parameter_list|(
name|a
parameter_list|)
define|\
value|do { \ 		if (!(a)) { \ 			printf ("ASSERT: %d %s\n", __LINE__, #a); \ 			__asm __volatile ("int $3"); \ 		} \ 	} while (0)
end_define

begin_function_decl
specifier|static
name|void
name|_ce_set_ts
parameter_list|(
name|ce_chan_t
modifier|*
name|c
parameter_list|,
name|unsigned
name|long
name|ts
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|_ce_submit_configure_e1
parameter_list|(
name|ce_chan_t
modifier|*
name|c
parameter_list|,
name|char
modifier|*
name|rname
parameter_list|)
function_decl|;
end_function_decl

begin_ifdef
ifdef|#
directive|ifdef
name|CE_DDK_DEBUG_ENABLED
end_ifdef

begin_function
specifier|static
name|char
modifier|*
name|ce_err2str
parameter_list|(
name|unsigned
name|long
name|err
parameter_list|)
block|{
switch|switch
condition|(
name|err
condition|)
block|{
case|case
name|TAU32_SUCCESSFUL
case|:
return|return
literal|"Successful"
return|;
case|case
name|TAU32_ERROR_ALLOCATION
case|:
return|return
literal|"Allocation error, not enough tx/rx descriptors"
return|;
case|case
name|TAU32_ERROR_BUS
case|:
return|return
literal|"PEB could not access to host memory by PCI bus for load/store information"
return|;
case|case
name|TAU32_ERROR_FAIL
case|:
return|return
literal|"PEB action request failed"
return|;
case|case
name|TAU32_ERROR_TIMEOUT
case|:
return|return
literal|"PEB action request timeout"
return|;
case|case
name|TAU32_ERROR_CANCELLED
case|:
return|return
literal|"request has been canceled"
return|;
case|case
name|TAU32_ERROR_TX_UNDERFLOW
case|:
return|return
literal|"transmission underflow"
return|;
case|case
name|TAU32_ERROR_TX_PROTOCOL
case|:
return|return
literal|"TX_PROTOCOL"
return|;
case|case
name|TAU32_ERROR_RX_OVERFLOW
case|:
return|return
literal|"RX_OVERFLOW"
return|;
case|case
name|TAU32_ERROR_RX_ABORT
case|:
return|return
literal|"RX_ABORT"
return|;
case|case
name|TAU32_ERROR_RX_CRC
case|:
return|return
literal|"RX_CRC"
return|;
case|case
name|TAU32_ERROR_RX_SHORT
case|:
return|return
literal|"RX_SHORT"
return|;
case|case
name|TAU32_ERROR_RX_SYNC
case|:
return|return
literal|"RX_SYNC"
return|;
case|case
name|TAU32_ERROR_RX_FRAME
case|:
return|return
literal|"RX_FRAME"
return|;
case|case
name|TAU32_ERROR_RX_LONG
case|:
return|return
literal|"RX_LONG"
return|;
case|case
name|TAU32_ERROR_RX_SPLIT
case|:
return|return
literal|"frame has splitted between two requests due rx-gap allocation"
return|;
case|case
name|TAU32_ERROR_RX_UNFIT
case|:
return|return
literal|"frame can't be fit into request buffer"
return|;
case|case
name|TAU32_ERROR_TSP
case|:
return|return
literal|"ERROR_TSP"
return|;
case|case
name|TAU32_ERROR_RSP
case|:
return|return
literal|"ERROR_RSP"
return|;
case|case
name|TAU32_ERROR_INT_OVER_TX
case|:
return|return
literal|"ERROR INT OVER TX"
return|;
case|case
name|TAU32_ERROR_INT_OVER_RX
case|:
return|return
literal|"ERROR INT OVER RX"
return|;
case|case
name|TAU32_ERROR_INT_STORM
case|:
return|return
literal|"irq storm"
return|;
case|case
name|TAU32_ERROR_INT_E1LOST
case|:
return|return
literal|"ERROR_E1LOST"
return|;
default|default:
return|return
operator|(
literal|"Unknown error"
operator|)
return|;
block|}
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_function
name|void
name|ce_set_dtr
parameter_list|(
name|ce_chan_t
modifier|*
name|c
parameter_list|,
name|int
name|on
parameter_list|)
block|{
name|c
operator|->
name|dtr
operator|=
name|on
condition|?
literal|1
else|:
literal|0
expr_stmt|;
block|}
end_function

begin_function
name|void
name|ce_set_rts
parameter_list|(
name|ce_chan_t
modifier|*
name|c
parameter_list|,
name|int
name|on
parameter_list|)
block|{
name|c
operator|->
name|rts
operator|=
name|on
condition|?
literal|1
else|:
literal|0
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|TAU32_CALLBACK_TYPE
name|ce_on_receive
parameter_list|(
name|TAU32_UserContext
modifier|*
name|pContext
parameter_list|,
name|TAU32_UserRequest
modifier|*
name|req
parameter_list|)
block|{
name|ce_buf_item_t
modifier|*
name|item
init|=
operator|(
name|ce_buf_item_t
operator|*
operator|)
name|req
decl_stmt|;
name|ce_chan_t
modifier|*
name|c
decl_stmt|;
name|ce_board_t
modifier|*
name|b
decl_stmt|;
name|unsigned
name|int
name|error
decl_stmt|;
name|int
name|len
decl_stmt|;
name|ENTER
argument_list|()
expr_stmt|;
if|if
condition|(
operator|!
name|req
operator|||
operator|!
name|req
operator|->
name|sys
condition|)
block|{
name|EXIT
argument_list|()
expr_stmt|;
block|}
name|c
operator|=
operator|(
name|ce_chan_t
operator|*
operator|)
name|req
operator|->
name|sys
expr_stmt|;
name|b
operator|=
name|c
operator|->
name|board
expr_stmt|;
name|len
operator|=
name|req
operator|->
name|Io
operator|.
name|Rx
operator|.
name|Received
expr_stmt|;
name|error
operator|=
name|req
operator|->
name|ErrorCode
expr_stmt|;
name|c
operator|->
name|rintr
operator|++
expr_stmt|;
if|if
condition|(
name|error
operator|==
name|TAU32_SUCCESSFUL
condition|)
block|{
if|if
condition|(
name|req
operator|->
name|Io
operator|.
name|Rx
operator|.
name|FrameEnd
condition|)
block|{
name|c
operator|->
name|ipkts
operator|++
expr_stmt|;
block|}
else|else
block|{
name|CE_DDK_DEBUG
argument_list|(
name|b
argument_list|,
name|c
argument_list|,
operator|(
literal|"No FrameEnd\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* probably do something in some cases*/
block|}
name|c
operator|->
name|ibytes
operator|+=
name|len
expr_stmt|;
if|if
condition|(
name|c
operator|->
name|receive
condition|)
name|c
operator|->
name|receive
argument_list|(
name|c
argument_list|,
name|item
operator|->
name|buf
argument_list|,
name|len
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|error
operator|&
name|TAU32_ERROR_BUS
condition|)
block|{
name|c
operator|->
name|overrun
operator|++
expr_stmt|;
if|if
condition|(
name|c
operator|->
name|error
condition|)
name|c
operator|->
name|error
argument_list|(
name|c
argument_list|,
name|CE_OVERRUN
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|CE_DDK_DEBUG
argument_list|(
name|b
argument_list|,
name|c
argument_list|,
operator|(
literal|"Another receive error: %x\n"
operator|,
name|error
operator|)
argument_list|)
expr_stmt|;
comment|/* Do some procesing */
block|}
name|CE_ASSERT
argument_list|(
operator|!
name|req
operator|->
name|pInternal
argument_list|)
expr_stmt|;
name|CE_ENQUEUE
argument_list|(
name|c
operator|->
name|rx_queue
argument_list|,
name|req
argument_list|)
expr_stmt|;
while|while
condition|(
name|c
operator|->
name|rx_queue
condition|)
block|{
name|CE_DEQUEUE
argument_list|(
name|c
operator|->
name|rx_queue
argument_list|,
name|req
argument_list|)
expr_stmt|;
name|CE_ASSERT
argument_list|(
name|req
argument_list|)
expr_stmt|;
name|item
operator|=
operator|(
name|ce_buf_item_t
operator|*
operator|)
name|req
expr_stmt|;
name|req
operator|->
name|Command
operator|=
name|TAU32_Rx_Data
expr_stmt|;
name|req
operator|->
name|Io
operator|.
name|Rx
operator|.
name|Channel
operator|=
name|c
operator|->
name|num
expr_stmt|;
name|req
operator|->
name|pCallback
operator|=
name|ce_on_receive
expr_stmt|;
name|req
operator|->
name|Io
operator|.
name|Rx
operator|.
name|BufferLength
operator|=
name|BUFSZ
operator|+
literal|4
expr_stmt|;
name|req
operator|->
name|Io
operator|.
name|Rx
operator|.
name|PhysicalDataAddress
operator|=
name|item
operator|->
name|phys
expr_stmt|;
if|if
condition|(
operator|!
name|TAU32_SubmitRequest
argument_list|(
name|b
operator|->
name|ddk
operator|.
name|pControllerObject
argument_list|,
name|req
argument_list|)
condition|)
block|{
name|CE_DDK_DEBUG
argument_list|(
name|b
argument_list|,
name|c
argument_list|,
operator|(
literal|"RX submition failure\n"
operator|)
argument_list|)
expr_stmt|;
name|c
operator|->
name|rx_pending
operator|--
expr_stmt|;
name|CE_ENQUEUE_HEAD
argument_list|(
name|c
operator|->
name|rx_queue
argument_list|,
name|req
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
name|EXIT
argument_list|()
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|TAU32_CALLBACK_TYPE
name|ce_on_transmit
parameter_list|(
name|TAU32_UserContext
modifier|*
name|pContext
parameter_list|,
name|TAU32_UserRequest
modifier|*
name|req
parameter_list|)
block|{
name|int
name|len
decl_stmt|;
name|unsigned
name|int
name|error
decl_stmt|;
name|ce_chan_t
modifier|*
name|c
decl_stmt|;
name|ENTER
argument_list|()
expr_stmt|;
if|if
condition|(
operator|!
name|req
operator|||
operator|!
name|req
operator|->
name|sys
condition|)
block|{
name|EXIT
argument_list|()
expr_stmt|;
block|}
name|c
operator|=
operator|(
name|ce_chan_t
operator|*
operator|)
name|req
operator|->
name|sys
expr_stmt|;
name|len
operator|=
name|req
operator|->
name|Io
operator|.
name|Tx
operator|.
name|Transmitted
expr_stmt|;
name|error
operator|=
name|req
operator|->
name|ErrorCode
expr_stmt|;
name|c
operator|->
name|tintr
operator|++
expr_stmt|;
if|if
condition|(
name|error
operator|==
name|TAU32_SUCCESSFUL
condition|)
block|{
name|c
operator|->
name|obytes
operator|+=
name|len
expr_stmt|;
name|c
operator|->
name|opkts
operator|++
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|error
operator|&
name|TAU32_ERROR_BUS
condition|)
block|{
name|c
operator|->
name|underrun
operator|++
expr_stmt|;
if|if
condition|(
name|c
operator|->
name|error
condition|)
name|c
operator|->
name|error
argument_list|(
name|c
argument_list|,
name|CE_UNDERRUN
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|CE_DDK_DEBUG
argument_list|(
name|c
operator|->
name|board
argument_list|,
name|c
argument_list|,
operator|(
literal|"Another transmit error: %x\n"
operator|,
name|error
operator|)
argument_list|)
expr_stmt|;
comment|/* Do some procesing */
block|}
name|CE_ENQUEUE
argument_list|(
name|c
operator|->
name|tx_queue
argument_list|,
name|req
argument_list|)
expr_stmt|;
name|c
operator|->
name|tx_pending
operator|--
expr_stmt|;
if|if
condition|(
name|c
operator|->
name|transmit
condition|)
name|c
operator|->
name|transmit
argument_list|(
name|c
argument_list|,
literal|0
argument_list|,
name|len
argument_list|)
expr_stmt|;
name|EXIT
argument_list|()
expr_stmt|;
block|}
end_function

begin_function
name|int
name|ce_transmit_space
parameter_list|(
name|ce_chan_t
modifier|*
name|c
parameter_list|)
block|{
return|return
name|c
operator|->
name|tx_pending
operator|<
operator|(
name|TAU32_IO_QUEUE
operator|)
return|;
block|}
end_function

begin_function
name|int
name|ce_send_packet
parameter_list|(
name|ce_chan_t
modifier|*
name|c
parameter_list|,
name|unsigned
name|char
modifier|*
name|buf
parameter_list|,
name|int
name|len
parameter_list|,
name|void
modifier|*
name|tag
parameter_list|)
block|{
name|TAU32_UserRequest
modifier|*
name|req
decl_stmt|;
name|ce_buf_item_t
modifier|*
name|item
decl_stmt|;
name|ENTER
argument_list|()
expr_stmt|;
if|if
condition|(
operator|!
name|ce_transmit_space
argument_list|(
name|c
argument_list|)
condition|)
block|{
name|EXIT
argument_list|(
operator|-
literal|1
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|len
operator|<=
literal|0
operator|||
name|len
operator|>
name|BUFSZ
condition|)
block|{
name|EXIT
argument_list|(
operator|-
literal|2
argument_list|)
expr_stmt|;
block|}
name|CE_DEQUEUE
argument_list|(
name|c
operator|->
name|tx_queue
argument_list|,
name|req
argument_list|)
expr_stmt|;
name|CE_ASSERT
argument_list|(
name|req
argument_list|)
expr_stmt|;
name|item
operator|=
operator|(
name|ce_buf_item_t
operator|*
operator|)
name|req
expr_stmt|;
if|if
condition|(
name|buf
operator|!=
name|item
operator|->
name|buf
condition|)
name|memcpy
argument_list|(
name|item
operator|->
name|buf
argument_list|,
name|buf
argument_list|,
name|len
argument_list|)
expr_stmt|;
name|CE_ASSERT
argument_list|(
operator|!
name|req
operator|->
name|pInternal
argument_list|)
expr_stmt|;
name|req
operator|->
name|Command
operator|=
name|TAU32_Tx_Data
operator||
name|TAU32_Tx_FrameEnd
expr_stmt|;
name|req
operator|->
name|Io
operator|.
name|Tx
operator|.
name|Channel
operator|=
name|c
operator|->
name|num
expr_stmt|;
name|req
operator|->
name|pCallback
operator|=
name|ce_on_transmit
expr_stmt|;
name|req
operator|->
name|Io
operator|.
name|Tx
operator|.
name|DataLength
operator|=
name|len
expr_stmt|;
name|req
operator|->
name|Io
operator|.
name|Tx
operator|.
name|PhysicalDataAddress
operator|=
name|item
operator|->
name|phys
expr_stmt|;
name|c
operator|->
name|tx_pending
operator|++
expr_stmt|;
if|if
condition|(
operator|!
name|TAU32_SubmitRequest
argument_list|(
name|c
operator|->
name|board
operator|->
name|ddk
operator|.
name|pControllerObject
argument_list|,
name|req
argument_list|)
condition|)
block|{
name|CE_DDK_DEBUG
argument_list|(
name|c
operator|->
name|board
argument_list|,
name|c
argument_list|,
operator|(
literal|"Can't submit packet for "
literal|"transmission\n"
operator|)
argument_list|)
expr_stmt|;
name|CE_ENQUEUE_HEAD
argument_list|(
name|c
operator|->
name|tx_queue
argument_list|,
name|req
argument_list|)
expr_stmt|;
name|c
operator|->
name|tx_pending
operator|--
expr_stmt|;
name|EXIT
argument_list|(
operator|-
literal|3
argument_list|)
expr_stmt|;
block|}
name|EXIT
argument_list|(
literal|0
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|TAU32_CALLBACK_TYPE
name|ce_on_config
parameter_list|(
name|TAU32_UserContext
modifier|*
name|pContext
parameter_list|,
name|TAU32_UserRequest
modifier|*
name|req
parameter_list|)
block|{
name|ce_board_t
modifier|*
name|b
init|=
operator|(
name|ce_board_t
operator|*
operator|)
name|pContext
decl_stmt|;
name|ENTER
argument_list|()
expr_stmt|;
name|b
operator|->
name|cr
operator|.
name|pending
operator|--
expr_stmt|;
if|if
condition|(
name|req
operator|->
name|ErrorCode
condition|)
name|CE_DDK_DEBUG
argument_list|(
name|b
argument_list|,
operator|(
name|ce_chan_t
operator|*
operator|)
literal|0
argument_list|,
operator|(
literal|"Config request failure: %lx\n"
operator|,
name|req
operator|->
name|ErrorCode
operator|)
argument_list|)
expr_stmt|;
name|EXIT
argument_list|()
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|TAU32_CALLBACK_TYPE
name|ce_on_config_stop
parameter_list|(
name|TAU32_UserContext
modifier|*
name|pContext
parameter_list|,
name|TAU32_UserRequest
modifier|*
name|req
parameter_list|)
block|{
name|int
name|i
decl_stmt|,
name|first
decl_stmt|;
name|TAU32_UserRequest
modifier|*
name|rreq
decl_stmt|;
name|ce_board_t
modifier|*
name|b
init|=
operator|(
name|ce_board_t
operator|*
operator|)
name|pContext
decl_stmt|;
name|ce_chan_t
modifier|*
name|c
init|=
name|b
operator|->
name|chan
operator|+
name|req
operator|->
name|Io
operator|.
name|ChannelNumber
decl_stmt|;
name|ENTER
argument_list|()
expr_stmt|;
comment|/* Stop all requests */
name|CE_ASSERT
argument_list|(
literal|0
argument_list|)
expr_stmt|;
comment|/* Buggy */
name|CE_LAST_ITEM
argument_list|(
name|c
operator|->
name|rx_queue
argument_list|,
name|rreq
argument_list|)
expr_stmt|;
comment|/* A little hacky, try to guess which is a first */
name|first
operator|=
name|rreq
condition|?
operator|(
name|c
operator|->
name|rx_item
operator|-
operator|(
name|ce_buf_item_t
operator|*
operator|)
name|rreq
operator|)
operator|+
literal|1
else|:
literal|0
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|TAU32_IO_QUEUE
condition|;
name|i
operator|++
control|)
block|{
name|int
name|is_pending
decl_stmt|;
name|rreq
operator|=
operator|&
name|c
operator|->
name|rx_item
index|[
operator|(
name|i
operator|+
name|first
operator|)
operator|%
name|TAU32_IO_QUEUE
index|]
operator|.
name|req
expr_stmt|;
name|CE_FIND_ITEM
argument_list|(
name|c
operator|->
name|rx_queue
argument_list|,
name|rreq
argument_list|,
name|is_pending
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|is_pending
condition|)
continue|continue;
name|TAU32_CancelRequest
argument_list|(
name|b
operator|->
name|ddk
operator|.
name|pControllerObject
argument_list|,
name|rreq
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|rreq
operator|->
name|Command
operator|=
name|TAU32_Rx_Data
expr_stmt|;
name|rreq
operator|->
name|Io
operator|.
name|Rx
operator|.
name|Channel
operator|=
name|c
operator|->
name|num
expr_stmt|;
name|rreq
operator|->
name|Io
operator|.
name|Rx
operator|.
name|BufferLength
operator|=
name|BUFSZ
operator|+
literal|4
expr_stmt|;
name|rreq
operator|->
name|Io
operator|.
name|Rx
operator|.
name|PhysicalDataAddress
operator|=
operator|(
operator|(
name|ce_buf_item_t
operator|*
operator|)
name|rreq
operator|)
operator|->
name|phys
expr_stmt|;
name|c
operator|->
name|rx_pending
operator|++
expr_stmt|;
if|if
condition|(
operator|!
name|TAU32_SubmitRequest
argument_list|(
name|b
operator|->
name|ddk
operator|.
name|pControllerObject
argument_list|,
name|rreq
argument_list|)
condition|)
block|{
name|CE_ASSERT
argument_list|(
literal|0
argument_list|)
expr_stmt|;
comment|/* Buggy */
name|c
operator|->
name|rx_pending
operator|--
expr_stmt|;
break|break;
block|}
block|}
name|c
operator|->
name|tx_pending
operator|=
literal|0
expr_stmt|;
comment|/*	c->rx_pending = 0;*/
name|EXIT
argument_list|()
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|ce_cfg_submit
parameter_list|(
name|ce_board_t
modifier|*
name|b
parameter_list|)
block|{
name|TAU32_UserRequest
modifier|*
name|req
decl_stmt|;
name|ENTER
argument_list|()
expr_stmt|;
name|CE_DEQUEUE
argument_list|(
name|b
operator|->
name|cr
operator|.
name|queue
argument_list|,
name|req
argument_list|)
expr_stmt|;
name|CE_ASSERT
argument_list|(
name|req
argument_list|)
expr_stmt|;
name|CE_ASSERT
argument_list|(
operator|!
name|req
operator|->
name|pInternal
argument_list|)
expr_stmt|;
name|req
operator|->
name|pCallback
operator|=
name|ce_on_config
expr_stmt|;
name|b
operator|->
name|cr
operator|.
name|pending
operator|++
expr_stmt|;
name|CE_DDK_DEBUG
argument_list|(
name|b
argument_list|,
operator|(
name|ce_chan_t
operator|*
operator|)
literal|0
argument_list|,
operator|(
literal|"config request pending: %d\n"
operator|,
name|b
operator|->
name|cr
operator|.
name|pending
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|TAU32_SubmitRequest
argument_list|(
name|b
operator|->
name|ddk
operator|.
name|pControllerObject
argument_list|,
name|req
argument_list|)
condition|)
block|{
name|CE_ENQUEUE_HEAD
argument_list|(
name|b
operator|->
name|cr
operator|.
name|queue
argument_list|,
name|req
argument_list|)
expr_stmt|;
name|CE_DDK_DEBUG
argument_list|(
name|b
argument_list|,
operator|(
name|ce_chan_t
operator|*
operator|)
literal|0
argument_list|,
operator|(
literal|"Fail to submit config request\n"
operator|)
argument_list|)
expr_stmt|;
name|b
operator|->
name|cr
operator|.
name|pending
operator|--
expr_stmt|;
name|EXIT
argument_list|(
literal|0
argument_list|)
expr_stmt|;
block|}
name|EXIT
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|ce_init_board
parameter_list|(
name|ce_board_t
modifier|*
name|b
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
name|b
operator|->
name|cr
operator|.
name|queue
operator|=
name|NULL
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|CONFREQSZ
condition|;
name|i
operator|++
control|)
block|{
name|CE_ENQUEUE
argument_list|(
name|b
operator|->
name|cr
operator|.
name|queue
argument_list|,
name|b
operator|->
name|cr
operator|.
name|req
operator|+
name|i
argument_list|)
expr_stmt|;
block|}
name|b
operator|->
name|chan
index|[
literal|0
index|]
operator|.
name|config
operator|=
name|TAU32_ais_on_loss
expr_stmt|;
comment|/* lloop = off, rloop = off */
name|b
operator|->
name|chan
index|[
literal|0
index|]
operator|.
name|config
operator||=
name|TAU32_LineNormal
expr_stmt|;
name|b
operator|->
name|chan
index|[
literal|0
index|]
operator|.
name|lloop
operator|=
literal|0
expr_stmt|;
name|b
operator|->
name|chan
index|[
literal|0
index|]
operator|.
name|rloop
operator|=
literal|0
expr_stmt|;
comment|/* unfram=off, scrambler=off, use16=off, crc4=off, 	   higain=off, monitor=off*/
name|b
operator|->
name|chan
index|[
literal|0
index|]
operator|.
name|config
operator||=
operator|(
name|b
operator|->
name|ddk
operator|.
name|Interfaces
operator|==
literal|2
condition|?
name|TAU32_framed_cas_cross
else|:
name|TAU32_framed_cas_set
operator|)
expr_stmt|;
name|b
operator|->
name|chan
index|[
literal|0
index|]
operator|.
name|unfram
operator|=
literal|0
expr_stmt|;
name|b
operator|->
name|chan
index|[
literal|0
index|]
operator|.
name|scrambler
operator|=
literal|0
expr_stmt|;
name|b
operator|->
name|chan
index|[
literal|0
index|]
operator|.
name|use16
operator|=
literal|0
expr_stmt|;
name|b
operator|->
name|chan
index|[
literal|0
index|]
operator|.
name|crc4
operator|=
literal|0
expr_stmt|;
name|b
operator|->
name|chan
index|[
literal|0
index|]
operator|.
name|higain
operator|=
literal|0
expr_stmt|;
name|b
operator|->
name|chan
index|[
literal|0
index|]
operator|.
name|monitor
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|b
operator|->
name|ddk
operator|.
name|Interfaces
operator|==
literal|2
condition|)
block|{
name|b
operator|->
name|chan
index|[
literal|1
index|]
operator|.
name|config
operator|=
name|TAU32_ais_on_loss
expr_stmt|;
comment|/* lloop = off, rloop = off */
name|b
operator|->
name|chan
index|[
literal|1
index|]
operator|.
name|config
operator||=
name|TAU32_LineNormal
expr_stmt|;
comment|/* unfram=off, scrambler=off, use16=off, crc4=off, 		   higain=off, monitor=off*/
name|b
operator|->
name|chan
index|[
literal|1
index|]
operator|.
name|config
operator||=
name|TAU32_framed_cas_cross
expr_stmt|;
name|b
operator|->
name|chan
index|[
literal|1
index|]
operator|.
name|unfram
operator|=
literal|0
expr_stmt|;
name|b
operator|->
name|chan
index|[
literal|1
index|]
operator|.
name|scrambler
operator|=
literal|0
expr_stmt|;
name|b
operator|->
name|chan
index|[
literal|1
index|]
operator|.
name|use16
operator|=
literal|0
expr_stmt|;
name|b
operator|->
name|chan
index|[
literal|1
index|]
operator|.
name|crc4
operator|=
literal|0
expr_stmt|;
name|b
operator|->
name|chan
index|[
literal|1
index|]
operator|.
name|higain
operator|=
literal|0
expr_stmt|;
name|b
operator|->
name|chan
index|[
literal|1
index|]
operator|.
name|monitor
operator|=
literal|0
expr_stmt|;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|NCHAN
condition|;
name|i
operator|++
control|)
block|{
comment|/* Chan0 ts=1-15,17-31, Chan1 ts=1-2 */
name|b
operator|->
name|chan
index|[
name|i
index|]
operator|.
name|type
operator|=
name|i
operator|<
name|b
operator|->
name|ddk
operator|.
name|Interfaces
condition|?
name|T_E1
else|:
name|T_DATA
expr_stmt|;
name|b
operator|->
name|chan
index|[
name|i
index|]
operator|.
name|ts
operator|=
operator|(
name|i
operator|==
literal|0
condition|?
literal|0xfffefffe
else|:
operator|(
name|i
operator|!=
literal|1
condition|?
literal|0
else|:
operator|(
name|b
operator|->
name|ddk
operator|.
name|Interfaces
operator|==
literal|2
condition|?
literal|0x6
else|:
literal|0
operator|)
operator|)
operator|)
expr_stmt|;
name|b
operator|->
name|chan
index|[
name|i
index|]
operator|.
name|dir
operator|=
operator|(
name|b
operator|->
name|ddk
operator|.
name|Interfaces
operator|==
literal|2
operator|)
condition|?
operator|(
name|i
operator|%
literal|2
operator|)
else|:
literal|0
expr_stmt|;
name|b
operator|->
name|chan
index|[
name|i
index|]
operator|.
name|mtu
operator|=
literal|1504
expr_stmt|;
block|}
if|#
directive|if
literal|0
comment|/* c->num == 0 */
block|req = b->cr.queue;
comment|/* We must have some here */
block|CE_ASSERT (req); 	req->Command = TAU32_Configure_E1; 	req->Io.InterfaceConfig.Interface = TAU32_E1_A; 	req->Io.InterfaceConfig.Config = b->chan[0].config; 	req->Io.InterfaceConfig.UnframedTsMask = 0; 	if (!ce_cfg_submit (b)) { 		CE_DDK_DEBUG (b, b->chan + 0, 			      ("Submit request failure, line %d\n", 			      __LINE__)); 	}
comment|/* c->num == 1 */
block|if (b->ddk.Interfaces == 2) { 		req = b->cr.queue;
comment|/* We must have some here */
block|CE_ASSERT (req); 		req->Command = TAU32_Configure_E1; 		req->Io.InterfaceConfig.Interface = TAU32_E1_B; 		req->Io.InterfaceConfig.Config = b->chan[1].config; 		req->Io.InterfaceConfig.UnframedTsMask = 0; 		if (!ce_cfg_submit (b)) { 			CE_DDK_DEBUG (b, b->chan + 1, 				      ("Submit request failure, line %d\n", 				      __LINE__)); 		} 	}
endif|#
directive|endif
comment|/* Set default cross matrix */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|32
condition|;
name|i
operator|++
control|)
block|{
comment|/* -X-> Peb */
name|b
operator|->
name|dxc
index|[
name|i
index|]
operator|=
name|TAU32_CROSS_OFF
expr_stmt|;
comment|/* Link2 -> Link1 */
name|b
operator|->
name|dxc
index|[
name|i
operator|+
literal|32
index|]
operator|=
name|i
operator|+
literal|64
expr_stmt|;
comment|/* Link1 -> Link2 */
name|b
operator|->
name|dxc
index|[
name|i
operator|+
literal|64
index|]
operator|=
name|i
operator|+
literal|32
expr_stmt|;
block|}
comment|/* We have only mux mode for now. Later we will also have cross mode */
name|b
operator|->
name|mux
operator|=
literal|1
expr_stmt|;
block|}
end_function

begin_function
name|void
name|ce_start_chan
parameter_list|(
name|ce_chan_t
modifier|*
name|c
parameter_list|,
name|int
name|tx
parameter_list|,
name|int
name|rx
parameter_list|,
name|ce_buf_t
modifier|*
name|cb
parameter_list|,
name|unsigned
name|long
name|phys
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
name|ce_board_t
modifier|*
name|b
init|=
name|c
operator|->
name|board
decl_stmt|;
comment|/*	c->config = TAU32_ais_on_loss | TAU32_framed_cas_cross;*/
if|if
condition|(
name|cb
condition|)
block|{
name|CE_DDK_DEBUG
argument_list|(
name|b
argument_list|,
name|c
argument_list|,
operator|(
literal|"ce_buf_t virt:%p phys:%p\n"
operator|,
name|cb
operator|,
operator|(
name|void
operator|*
operator|)
name|phys
operator|)
argument_list|)
expr_stmt|;
name|c
operator|->
name|tx_item
operator|=
name|cb
operator|->
name|tx_item
expr_stmt|;
name|c
operator|->
name|rx_item
operator|=
name|cb
operator|->
name|rx_item
expr_stmt|;
name|c
operator|->
name|tx_queue
operator|=
name|NULL
expr_stmt|;
name|c
operator|->
name|rx_queue
operator|=
name|NULL
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|TAU32_IO_QUEUE
condition|;
name|i
operator|++
control|)
block|{
name|c
operator|->
name|tx_item
index|[
name|i
index|]
operator|.
name|phys
operator|=
name|phys
operator|+
operator|(
operator|(
name|char
operator|*
operator|)
operator|(
name|c
operator|->
name|tx_item
index|[
name|i
index|]
operator|.
name|buf
operator|)
operator|-
operator|(
name|char
operator|*
operator|)
name|cb
operator|)
expr_stmt|;
name|c
operator|->
name|rx_item
index|[
name|i
index|]
operator|.
name|phys
operator|=
name|phys
operator|+
operator|(
operator|(
name|char
operator|*
operator|)
operator|(
name|c
operator|->
name|rx_item
index|[
name|i
index|]
operator|.
name|buf
operator|)
operator|-
operator|(
name|char
operator|*
operator|)
name|cb
operator|)
expr_stmt|;
name|cb
operator|->
name|tx_item
index|[
name|i
index|]
operator|.
name|req
operator|.
name|sys
operator|=
name|c
expr_stmt|;
name|cb
operator|->
name|rx_item
index|[
name|i
index|]
operator|.
name|req
operator|.
name|sys
operator|=
name|c
expr_stmt|;
name|CE_DDK_DEBUG
argument_list|(
name|b
argument_list|,
name|c
argument_list|,
operator|(
literal|"tx_item[%d].buf virt:%p phys:%p\n"
operator|,
name|i
operator|,
name|c
operator|->
name|tx_item
index|[
name|i
index|]
operator|.
name|buf
operator|,
operator|(
name|void
operator|*
operator|)
name|c
operator|->
name|tx_item
index|[
name|i
index|]
operator|.
name|phys
operator|)
argument_list|)
expr_stmt|;
name|CE_DDK_DEBUG
argument_list|(
name|b
argument_list|,
name|c
argument_list|,
operator|(
literal|"rx_item[%d].buf virt:%p phys:%p\n"
operator|,
name|i
operator|,
name|c
operator|->
name|rx_item
index|[
name|i
index|]
operator|.
name|buf
operator|,
operator|(
name|void
operator|*
operator|)
name|c
operator|->
name|rx_item
index|[
name|i
index|]
operator|.
name|phys
operator|)
argument_list|)
expr_stmt|;
name|CE_ENQUEUE
argument_list|(
name|c
operator|->
name|rx_queue
argument_list|,
operator|&
name|c
operator|->
name|rx_item
index|[
name|i
index|]
operator|.
name|req
argument_list|)
expr_stmt|;
name|CE_ENQUEUE
argument_list|(
name|c
operator|->
name|tx_queue
argument_list|,
operator|&
name|c
operator|->
name|tx_item
index|[
name|i
index|]
operator|.
name|req
argument_list|)
expr_stmt|;
block|}
name|c
operator|->
name|tx_pending
operator|=
literal|0
expr_stmt|;
name|c
operator|->
name|rx_pending
operator|=
literal|0
expr_stmt|;
block|}
comment|/* submit rx */
while|while
condition|(
literal|1
condition|)
block|{
name|ce_buf_item_t
modifier|*
name|item
decl_stmt|;
name|TAU32_UserRequest
modifier|*
name|req
decl_stmt|;
name|CE_DEQUEUE
argument_list|(
name|c
operator|->
name|rx_queue
argument_list|,
name|req
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|req
condition|)
break|break;
name|item
operator|=
operator|(
name|ce_buf_item_t
operator|*
operator|)
name|req
expr_stmt|;
name|CE_ASSERT
argument_list|(
name|c
operator|->
name|rx_pending
operator|<
name|TAU32_IO_QUEUE
argument_list|)
expr_stmt|;
name|req
operator|->
name|Command
operator|=
name|TAU32_Rx_Data
expr_stmt|;
name|req
operator|->
name|Io
operator|.
name|Rx
operator|.
name|Channel
operator|=
name|c
operator|->
name|num
expr_stmt|;
name|req
operator|->
name|pCallback
operator|=
name|ce_on_receive
expr_stmt|;
name|req
operator|->
name|Io
operator|.
name|Rx
operator|.
name|BufferLength
operator|=
name|c
operator|->
name|mtu
operator|+
operator|(
name|c
operator|->
name|phony
condition|?
literal|0
else|:
literal|4
operator|)
expr_stmt|;
name|req
operator|->
name|Io
operator|.
name|Rx
operator|.
name|PhysicalDataAddress
operator|=
name|item
operator|->
name|phys
expr_stmt|;
name|c
operator|->
name|rx_pending
operator|++
expr_stmt|;
if|if
condition|(
operator|!
name|TAU32_SubmitRequest
argument_list|(
name|b
operator|->
name|ddk
operator|.
name|pControllerObject
argument_list|,
name|req
argument_list|)
condition|)
block|{
name|CE_DDK_DEBUG
argument_list|(
name|b
argument_list|,
name|c
argument_list|,
operator|(
literal|"Faild to submit rx request\n"
operator|)
argument_list|)
expr_stmt|;
comment|/*XXXRIK: shouldn't happen, but ... */
name|CE_ASSERT
argument_list|(
literal|0
argument_list|)
expr_stmt|;
name|c
operator|->
name|rx_pending
operator|--
expr_stmt|;
break|break;
block|}
block|}
if|if
condition|(
name|tx
operator||
name|rx
condition|)
block|{
name|TAU32_UserRequest
modifier|*
name|req
decl_stmt|;
name|CE_PREREQUEST
argument_list|(
name|b
argument_list|,
name|c
argument_list|,
name|b
operator|->
name|cr
operator|.
name|queue
argument_list|,
name|req
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|req
condition|)
return|return;
name|req
operator|->
name|Command
operator|=
name|TAU32_Configure_Commit
operator||
operator|(
name|tx
condition|?
name|TAU32_Tx_Start
else|:
literal|0
operator|)
operator||
operator|(
name|rx
condition|?
name|TAU32_Rx_Start
else|:
literal|0
operator|)
expr_stmt|;
name|req
operator|->
name|Io
operator|.
name|ChannelNumber
operator|=
name|c
operator|->
name|num
expr_stmt|;
if|if
condition|(
operator|!
name|ce_cfg_submit
argument_list|(
name|b
argument_list|)
condition|)
block|{
name|CE_DDK_DEBUG
argument_list|(
name|b
argument_list|,
name|c
argument_list|,
operator|(
literal|"Can't start chan\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* Do some error processing */
return|return;
block|}
block|}
comment|/* If we run just after ce_board_init we have prope values. 	 * Else I hope you didn't set ts to incorrect value. 	 */
name|_ce_set_ts
argument_list|(
name|c
argument_list|,
name|c
operator|->
name|ts
argument_list|)
expr_stmt|;
if|if
condition|(
name|c
operator|->
name|num
operator|<
name|b
operator|->
name|ddk
operator|.
name|Interfaces
condition|)
block|{
comment|/* The same for other modes. We don't check them. 		 * We hope that config is correctly set. Just as we have 		 * after ce_board_init. If channel was stoped we hope that 		 * it's config was not broken just after it and we didn't 		 * brake it before start. 		 */
name|_ce_submit_configure_e1
argument_list|(
name|c
argument_list|,
literal|"start_init"
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
name|void
name|ce_stop_chan
parameter_list|(
name|ce_chan_t
modifier|*
name|c
parameter_list|)
block|{
name|ce_board_t
modifier|*
name|b
init|=
name|c
operator|->
name|board
decl_stmt|;
name|TAU32_UserRequest
modifier|*
name|req
decl_stmt|;
name|CE_DEQUEUE
argument_list|(
name|b
operator|->
name|cr
operator|.
name|queue
argument_list|,
name|req
argument_list|)
expr_stmt|;
comment|/* XXXRIK: This function should be for comleteness, but for now I 	 * don't use it. So I just start to write and didn't finished it yet. 	 * It and it is VERY BUGGY!!! Do not use it. If you realy 	 * need it ask me to fix it or rewrite it by your self. 	 * Note: most buggy part of it in ce_on_config_stop! 	 */
if|if
condition|(
operator|!
name|req
condition|)
block|{
name|CE_DDK_DEBUG
argument_list|(
name|b
argument_list|,
name|c
argument_list|,
operator|(
literal|"Fatal error, no free structs for "
literal|"UserRequest (%s:%d)\n"
operator|,
name|__FUNCTION__
operator|,
name|__LINE__
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
name|req
operator|->
name|Command
operator|=
name|TAU32_Configure_Commit
operator||
name|TAU32_Tx_Stop
operator||
name|TAU32_Rx_Stop
expr_stmt|;
name|req
operator|->
name|Command
operator|=
literal|0
expr_stmt|;
name|req
operator|->
name|Io
operator|.
name|ChannelNumber
operator|=
name|c
operator|->
name|num
expr_stmt|;
name|req
operator|->
name|pCallback
operator|=
name|ce_on_config_stop
expr_stmt|;
name|b
operator|->
name|cr
operator|.
name|pending
operator|++
expr_stmt|;
if|if
condition|(
operator|!
name|TAU32_SubmitRequest
argument_list|(
name|b
operator|->
name|ddk
operator|.
name|pControllerObject
argument_list|,
name|req
argument_list|)
condition|)
block|{
name|CE_ENQUEUE_HEAD
argument_list|(
name|b
operator|->
name|cr
operator|.
name|queue
argument_list|,
name|req
argument_list|)
expr_stmt|;
name|CE_DDK_DEBUG
argument_list|(
name|b
argument_list|,
name|c
argument_list|,
operator|(
literal|"Can't stop chan\n"
operator|)
argument_list|)
expr_stmt|;
name|b
operator|->
name|cr
operator|.
name|pending
operator|--
expr_stmt|;
block|}
block|}
end_function

begin_function
name|void
name|ce_register_transmit
parameter_list|(
name|ce_chan_t
modifier|*
name|c
parameter_list|,
name|void
function_decl|(
modifier|*
name|func
function_decl|)
parameter_list|(
name|ce_chan_t
modifier|*
parameter_list|,
name|void
modifier|*
parameter_list|,
name|int
parameter_list|)
parameter_list|)
block|{
name|c
operator|->
name|transmit
operator|=
name|func
expr_stmt|;
block|}
end_function

begin_function
name|void
name|ce_register_receive
parameter_list|(
name|ce_chan_t
modifier|*
name|c
parameter_list|,
name|void
function_decl|(
modifier|*
name|func
function_decl|)
parameter_list|(
name|ce_chan_t
modifier|*
parameter_list|,
name|unsigned
name|char
modifier|*
parameter_list|,
name|int
parameter_list|)
parameter_list|)
block|{
name|c
operator|->
name|receive
operator|=
name|func
expr_stmt|;
block|}
end_function

begin_function
name|void
name|ce_register_error
parameter_list|(
name|ce_chan_t
modifier|*
name|c
parameter_list|,
name|void
function_decl|(
modifier|*
name|func
function_decl|)
parameter_list|(
name|ce_chan_t
modifier|*
parameter_list|,
name|int
parameter_list|)
parameter_list|)
block|{
name|c
operator|->
name|error
operator|=
name|func
expr_stmt|;
block|}
end_function

begin_function
name|void
name|TAU32_CALLBACK_TYPE
name|ce_error_callback
parameter_list|(
name|TAU32_UserContext
modifier|*
name|pContext
parameter_list|,
name|int
name|Item
parameter_list|,
name|unsigned
name|NotifyBits
parameter_list|)
block|{
name|ce_board_t
modifier|*
name|b
init|=
operator|(
name|ce_board_t
operator|*
operator|)
name|pContext
decl_stmt|;
name|ENTER
argument_list|()
expr_stmt|;
if|if
condition|(
name|NotifyBits
operator|&
operator|(
name|TAU32_ERROR_FAIL
operator||
name|TAU32_ERROR_TIMEOUT
operator||
name|TAU32_ERROR_INT_OVER_TX
operator||
name|TAU32_ERROR_INT_OVER_RX
operator||
name|TAU32_ERROR_INT_STORM
operator|)
condition|)
block|{
comment|/* Fatal: adapter failure, need reset& restart */
comment|/* RIKXXX: probably I should add CE_FAILURE for ce_error */
name|CE_DDK_DEBUG
argument_list|(
name|b
argument_list|,
operator|(
name|ce_chan_t
operator|*
operator|)
literal|0
argument_list|,
operator|(
literal|"Err, disable interrupts: %s\n"
operator|,
name|ce_err2str
argument_list|(
name|NotifyBits
argument_list|)
operator|)
argument_list|)
expr_stmt|;
comment|/*		TAU32_DisableInterrupts (b->ddk.pControllerObject);*/
name|EXIT
argument_list|()
expr_stmt|;
block|}
if|if
condition|(
name|Item
operator|>=
literal|0
condition|)
block|{
comment|/* channel error */
name|ce_chan_t
modifier|*
name|c
init|=
name|b
operator|->
name|chan
operator|+
name|Item
decl_stmt|;
if|if
condition|(
name|NotifyBits
operator|&
name|TAU32_ERROR_TX_UNDERFLOW
condition|)
block|{
name|c
operator|->
name|underrun
operator|++
expr_stmt|;
if|if
condition|(
name|c
operator|->
name|error
condition|)
name|c
operator|->
name|error
argument_list|(
name|c
argument_list|,
name|CE_UNDERRUN
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|NotifyBits
operator|&
name|TAU32_ERROR_RX_OVERFLOW
condition|)
block|{
name|c
operator|->
name|overrun
operator|++
expr_stmt|;
if|if
condition|(
name|c
operator|->
name|error
condition|)
name|c
operator|->
name|error
argument_list|(
name|c
argument_list|,
name|CE_OVERFLOW
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|NotifyBits
operator|&
operator|(
name|TAU32_ERROR_RX_FRAME
operator||
name|TAU32_ERROR_RX_ABORT
operator||
name|TAU32_ERROR_RX_SHORT
operator||
name|TAU32_ERROR_RX_LONG
operator||
name|TAU32_ERROR_RX_SYNC
operator||
name|TAU32_ERROR_RX_SPLIT
operator||
name|TAU32_ERROR_RX_UNFIT
operator|)
condition|)
block|{
name|c
operator|->
name|frame
operator|++
expr_stmt|;
name|CE_DDK_DEBUG
argument_list|(
name|b
argument_list|,
name|c
argument_list|,
operator|(
literal|"Frame error: %x\n"
operator|,
name|NotifyBits
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|c
operator|->
name|error
condition|)
name|c
operator|->
name|error
argument_list|(
name|c
argument_list|,
name|CE_FRAME
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|NotifyBits
operator|&
name|TAU32_ERROR_RX_CRC
condition|)
block|{
name|c
operator|->
name|crc
operator|++
expr_stmt|;
if|if
condition|(
name|c
operator|->
name|error
condition|)
name|c
operator|->
name|error
argument_list|(
name|c
argument_list|,
name|CE_CRC
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
name|CE_DDK_DEBUG
argument_list|(
name|b
argument_list|,
operator|(
name|ce_chan_t
operator|*
operator|)
literal|0
argument_list|,
operator|(
literal|"Another error: %x\n"
operator|,
name|NotifyBits
operator|)
argument_list|)
expr_stmt|;
comment|/* Adapter error, do smth */
block|}
name|EXIT
argument_list|()
expr_stmt|;
block|}
end_function

begin_function
name|void
name|TAU32_CALLBACK_TYPE
name|ce_status_callback
parameter_list|(
name|TAU32_UserContext
modifier|*
name|pContext
parameter_list|,
name|int
name|Item
parameter_list|,
name|unsigned
name|NotifyBits
parameter_list|)
block|{
name|ce_board_t
modifier|*
name|b
init|=
operator|(
name|ce_board_t
operator|*
operator|)
name|pContext
decl_stmt|;
name|ENTER
argument_list|()
expr_stmt|;
if|if
condition|(
name|Item
operator|>=
literal|0
condition|)
block|{
comment|/* e1 status */
name|ce_chan_t
modifier|*
name|c
init|=
name|b
operator|->
name|chan
operator|+
name|Item
decl_stmt|;
name|c
operator|->
name|acc_status
operator||=
name|b
operator|->
name|ddk
operator|.
name|InterfacesInfo
index|[
name|Item
index|]
operator|.
name|Status
expr_stmt|;
comment|/*		CE_DDK_DEBUG (b, c, ("Current status: %x\n", c->acc_status));*/
block|}
else|else
block|{
name|CE_DDK_DEBUG
argument_list|(
name|b
argument_list|,
operator|(
name|ce_chan_t
operator|*
operator|)
literal|0
argument_list|,
operator|(
literal|"Another status: %x\n"
operator|,
name|NotifyBits
operator|)
argument_list|)
expr_stmt|;
comment|/* Adapter status, do smth. */
block|}
name|EXIT
argument_list|()
expr_stmt|;
block|}
end_function

begin_function
name|int
name|ce_get_cd
parameter_list|(
name|ce_chan_t
modifier|*
name|c
parameter_list|)
block|{
name|unsigned
name|int
name|e1status
init|=
name|c
operator|->
name|board
operator|->
name|ddk
operator|.
name|InterfacesInfo
index|[
name|c
operator|->
name|dir
index|]
operator|.
name|Status
decl_stmt|;
return|return
operator|(
name|c
operator|->
name|ts
operator|&&
operator|!
operator|(
name|e1status
operator|&
operator|(
name|TAU32_RCL
operator||
name|TAU32_E1OFF
operator|)
operator|)
operator|)
return|;
block|}
end_function

begin_function
name|int
name|ce_get_cts
parameter_list|(
name|ce_chan_t
modifier|*
name|c
parameter_list|)
block|{
return|return
literal|0
return|;
block|}
end_function

begin_function
name|int
name|ce_get_dsr
parameter_list|(
name|ce_chan_t
modifier|*
name|c
parameter_list|)
block|{
return|return
literal|0
return|;
block|}
end_function

begin_function
name|void
name|ce_e1_timer
parameter_list|(
name|ce_chan_t
modifier|*
name|c
parameter_list|)
block|{
name|unsigned
name|bpv
decl_stmt|,
name|fas
decl_stmt|,
name|crc4
decl_stmt|,
name|ebit
decl_stmt|,
name|pcv
decl_stmt|,
name|oof
decl_stmt|,
name|css
decl_stmt|;
name|unsigned
name|int
name|acc_status
decl_stmt|;
name|ce_board_t
modifier|*
name|b
init|=
name|c
operator|->
name|board
decl_stmt|;
name|TAU32_E1_State
modifier|*
name|state
decl_stmt|;
if|if
condition|(
name|c
operator|->
name|num
operator|>=
name|b
operator|->
name|ddk
operator|.
name|Interfaces
condition|)
return|return;
name|state
operator|=
operator|&
name|b
operator|->
name|ddk
operator|.
name|InterfacesInfo
index|[
name|c
operator|->
name|num
index|]
expr_stmt|;
name|acc_status
operator|=
name|c
operator|->
name|acc_status
expr_stmt|;
comment|/* Clear acc_status */
name|c
operator|->
name|acc_status
operator|=
name|b
operator|->
name|ddk
operator|.
name|InterfacesInfo
index|[
name|c
operator|->
name|num
index|]
operator|.
name|Status
expr_stmt|;
comment|/* Count seconds. 	 * During the first second after the channel startup 	 * the status registers are not stable yet, 	 * we will so skip the first second. */
operator|++
name|c
operator|->
name|cursec
expr_stmt|;
if|if
condition|(
operator|!
name|c
operator|->
name|totsec
operator|&&
name|c
operator|->
name|cursec
operator|<=
literal|1
condition|)
return|return;
name|c
operator|->
name|status
operator|=
literal|0
expr_stmt|;
comment|/* Compute the SNMP-compatible channel status. */
name|oof
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|acc_status
operator|&
name|TAU32_RCL
condition|)
name|c
operator|->
name|status
operator||=
name|ESTS_LOS
expr_stmt|;
comment|/* loss of signal */
if|if
condition|(
name|acc_status
operator|&
name|TAU32_RUA1
condition|)
name|c
operator|->
name|status
operator||=
name|ESTS_AIS
expr_stmt|;
comment|/* receiving all ones */
comment|/* Get error counters. */
name|bpv
operator|=
name|state
operator|->
name|RxViolations
expr_stmt|;
name|fas
operator|=
literal|0
expr_stmt|;
name|crc4
operator|=
literal|0
expr_stmt|;
name|ebit
operator|=
literal|0
expr_stmt|;
name|css
operator|=
literal|0
expr_stmt|;
if|if
condition|(
operator|!
name|c
operator|->
name|unfram
condition|)
block|{
if|if
condition|(
operator|!
name|c
operator|->
name|use16
operator|&&
operator|(
name|acc_status
operator|&
name|TAU32_RSA1
operator|)
condition|)
name|c
operator|->
name|status
operator||=
name|ESTS_AIS16
expr_stmt|;
comment|/* signaling all ones */
if|if
condition|(
operator|!
name|c
operator|->
name|use16
operator|&&
operator|(
name|acc_status
operator|&
name|TAU32_RDMA
operator|)
condition|)
name|c
operator|->
name|status
operator||=
name|ESTS_FARLOMF
expr_stmt|;
comment|/* alarm in timeslot 16 */
if|if
condition|(
name|acc_status
operator|&
name|TAU32_RRA
condition|)
name|c
operator|->
name|status
operator||=
name|ESTS_FARLOF
expr_stmt|;
comment|/* far loss of framing */
if|if
condition|(
name|acc_status
operator|&
name|TAU32_RFAS
condition|)
block|{
name|c
operator|->
name|status
operator||=
name|ESTS_LOF
expr_stmt|;
comment|/* loss of framing */
operator|++
name|oof
expr_stmt|;
comment|/* out of framing */
block|}
if|if
condition|(
operator|(
operator|!
name|c
operator|->
name|use16
operator|&&
operator|(
name|acc_status
operator|&
name|TAU32_RCAS
operator|)
operator|)
operator|||
operator|(
name|c
operator|->
name|crc4
operator|&&
operator|(
name|acc_status
operator|&
name|TAU32_RCRC4
operator|)
operator|)
condition|)
block|{
name|c
operator|->
name|status
operator||=
name|ESTS_LOMF
expr_stmt|;
comment|/* loss of multiframing */
operator|++
name|oof
expr_stmt|;
comment|/* out of framing */
block|}
name|fas
operator|=
name|state
operator|->
name|FasErrors
expr_stmt|;
name|crc4
operator|=
name|state
operator|->
name|Crc4Errors
expr_stmt|;
name|ebit
operator|=
name|state
operator|->
name|FarEndBlockErrors
expr_stmt|;
comment|/* Controlled slip second -- any slip event. */
name|css
operator|=
name|state
operator|->
name|TransmitSlips
operator|+
name|state
operator|->
name|ReceiveSlips
expr_stmt|;
block|}
comment|/* Clear state */
name|state
operator|->
name|RxViolations
operator|=
literal|0
expr_stmt|;
name|state
operator|->
name|FasErrors
operator|=
literal|0
expr_stmt|;
name|state
operator|->
name|Crc4Errors
operator|=
literal|0
expr_stmt|;
name|state
operator|->
name|FarEndBlockErrors
operator|=
literal|0
expr_stmt|;
name|state
operator|->
name|TransmitSlips
operator|=
literal|0
expr_stmt|;
name|state
operator|->
name|ReceiveSlips
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|c
operator|->
name|status
operator|&
name|ESTS_LOS
condition|)
name|c
operator|->
name|status
operator|=
name|ESTS_LOS
expr_stmt|;
elseif|else
if|if
condition|(
name|c
operator|->
name|status
operator|&
name|ESTS_AIS
condition|)
name|c
operator|->
name|status
operator|=
name|ESTS_AIS
expr_stmt|;
elseif|else
if|if
condition|(
name|c
operator|->
name|status
operator|&
name|ESTS_LOF
condition|)
name|c
operator|->
name|status
operator|=
name|ESTS_LOF
expr_stmt|;
elseif|else
if|if
condition|(
name|c
operator|->
name|status
operator|&
name|ESTS_LOMF
condition|)
name|c
operator|->
name|status
operator|&=
operator|~
operator|(
name|ESTS_FARLOMF
operator||
name|ESTS_AIS16
operator|)
expr_stmt|;
if|if
condition|(
operator|!
name|c
operator|->
name|status
condition|)
name|c
operator|->
name|status
operator|=
name|ESTS_NOALARM
expr_stmt|;
name|c
operator|->
name|currnt
operator|.
name|bpv
operator|+=
name|bpv
expr_stmt|;
name|c
operator|->
name|currnt
operator|.
name|fse
operator|+=
name|fas
expr_stmt|;
if|if
condition|(
name|c
operator|->
name|crc4
condition|)
block|{
name|c
operator|->
name|currnt
operator|.
name|crce
operator|+=
name|crc4
expr_stmt|;
name|c
operator|->
name|currnt
operator|.
name|rcrce
operator|+=
name|ebit
expr_stmt|;
block|}
comment|/* Path code violation is frame sync error if CRC4 disabled, 	 * or CRC error if CRC4 enabled. */
name|pcv
operator|=
name|fas
expr_stmt|;
if|if
condition|(
name|c
operator|->
name|crc4
condition|)
name|pcv
operator|+=
name|crc4
expr_stmt|;
comment|/* Unavaiable second -- receiving all ones, or 	 * loss of carrier, or loss of signal. */
if|if
condition|(
name|acc_status
operator|&
operator|(
name|TAU32_RUA1
operator||
name|TAU32_RCL
operator|)
condition|)
comment|/* Unavailable second -- no other counters. */
operator|++
name|c
operator|->
name|currnt
operator|.
name|uas
expr_stmt|;
else|else
block|{
comment|/* Line errored second -- any BPV. */
if|if
condition|(
name|bpv
condition|)
operator|++
name|c
operator|->
name|currnt
operator|.
name|les
expr_stmt|;
comment|/* Errored second -- any PCV, or out of frame sync, 		 * or any slip events. */
if|if
condition|(
name|pcv
operator|||
name|oof
operator|||
name|css
condition|)
operator|++
name|c
operator|->
name|currnt
operator|.
name|es
expr_stmt|;
comment|/* Severely errored framing second -- out of frame sync. */
if|if
condition|(
name|oof
condition|)
operator|++
name|c
operator|->
name|currnt
operator|.
name|oofs
expr_stmt|;
comment|/* Severely errored seconds -- 		 * 832 or more PCVs, or 2048 or more BPVs. */
if|if
condition|(
name|bpv
operator|>=
literal|2048
operator|||
name|pcv
operator|>=
literal|832
condition|)
operator|++
name|c
operator|->
name|currnt
operator|.
name|ses
expr_stmt|;
else|else
block|{
comment|/* Bursty errored seconds -- 			 * no SES and more than 1 PCV. */
if|if
condition|(
name|pcv
operator|>
literal|1
condition|)
operator|++
name|c
operator|->
name|currnt
operator|.
name|bes
expr_stmt|;
comment|/* Collect data for computing 			 * degraded minutes. */
operator|++
name|c
operator|->
name|degsec
expr_stmt|;
name|c
operator|->
name|degerr
operator|+=
name|bpv
operator|+
name|pcv
expr_stmt|;
block|}
block|}
comment|/* Degraded minutes -- having error rate more than 10e-6, 	 * not counting unavailable and severely errored seconds. */
if|if
condition|(
name|c
operator|->
name|cursec
operator|%
literal|60
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|c
operator|->
name|degerr
operator|>
name|c
operator|->
name|degsec
operator|*
literal|2048
operator|/
literal|1000
condition|)
operator|++
name|c
operator|->
name|currnt
operator|.
name|dm
expr_stmt|;
name|c
operator|->
name|degsec
operator|=
literal|0
expr_stmt|;
name|c
operator|->
name|degerr
operator|=
literal|0
expr_stmt|;
block|}
comment|/* Rotate statistics every 15 minutes. */
if|if
condition|(
name|c
operator|->
name|cursec
operator|>
literal|15
operator|*
literal|60
condition|)
block|{
name|int
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|47
init|;
name|i
operator|>
literal|0
condition|;
operator|--
name|i
control|)
name|c
operator|->
name|interval
index|[
name|i
index|]
operator|=
name|c
operator|->
name|interval
index|[
name|i
operator|-
literal|1
index|]
expr_stmt|;
name|c
operator|->
name|interval
index|[
literal|0
index|]
operator|=
name|c
operator|->
name|currnt
expr_stmt|;
comment|/* Accumulate total statistics. */
name|c
operator|->
name|total
operator|.
name|bpv
operator|+=
name|c
operator|->
name|currnt
operator|.
name|bpv
expr_stmt|;
name|c
operator|->
name|total
operator|.
name|fse
operator|+=
name|c
operator|->
name|currnt
operator|.
name|fse
expr_stmt|;
name|c
operator|->
name|total
operator|.
name|crce
operator|+=
name|c
operator|->
name|currnt
operator|.
name|crce
expr_stmt|;
name|c
operator|->
name|total
operator|.
name|rcrce
operator|+=
name|c
operator|->
name|currnt
operator|.
name|rcrce
expr_stmt|;
name|c
operator|->
name|total
operator|.
name|uas
operator|+=
name|c
operator|->
name|currnt
operator|.
name|uas
expr_stmt|;
name|c
operator|->
name|total
operator|.
name|les
operator|+=
name|c
operator|->
name|currnt
operator|.
name|les
expr_stmt|;
name|c
operator|->
name|total
operator|.
name|es
operator|+=
name|c
operator|->
name|currnt
operator|.
name|es
expr_stmt|;
name|c
operator|->
name|total
operator|.
name|bes
operator|+=
name|c
operator|->
name|currnt
operator|.
name|bes
expr_stmt|;
name|c
operator|->
name|total
operator|.
name|ses
operator|+=
name|c
operator|->
name|currnt
operator|.
name|ses
expr_stmt|;
name|c
operator|->
name|total
operator|.
name|oofs
operator|+=
name|c
operator|->
name|currnt
operator|.
name|oofs
expr_stmt|;
name|c
operator|->
name|total
operator|.
name|css
operator|+=
name|c
operator|->
name|currnt
operator|.
name|css
expr_stmt|;
name|c
operator|->
name|total
operator|.
name|dm
operator|+=
name|c
operator|->
name|currnt
operator|.
name|dm
expr_stmt|;
name|c
operator|->
name|currnt
operator|.
name|bpv
operator|=
literal|0
expr_stmt|;
name|c
operator|->
name|currnt
operator|.
name|fse
operator|=
literal|0
expr_stmt|;
name|c
operator|->
name|currnt
operator|.
name|crce
operator|=
literal|0
expr_stmt|;
name|c
operator|->
name|currnt
operator|.
name|rcrce
operator|=
literal|0
expr_stmt|;
name|c
operator|->
name|currnt
operator|.
name|uas
operator|=
literal|0
expr_stmt|;
name|c
operator|->
name|currnt
operator|.
name|les
operator|=
literal|0
expr_stmt|;
name|c
operator|->
name|currnt
operator|.
name|es
operator|=
literal|0
expr_stmt|;
name|c
operator|->
name|currnt
operator|.
name|bes
operator|=
literal|0
expr_stmt|;
name|c
operator|->
name|currnt
operator|.
name|ses
operator|=
literal|0
expr_stmt|;
name|c
operator|->
name|currnt
operator|.
name|oofs
operator|=
literal|0
expr_stmt|;
name|c
operator|->
name|currnt
operator|.
name|css
operator|=
literal|0
expr_stmt|;
name|c
operator|->
name|currnt
operator|.
name|dm
operator|=
literal|0
expr_stmt|;
name|c
operator|->
name|totsec
operator|+=
name|c
operator|->
name|cursec
expr_stmt|;
name|c
operator|->
name|cursec
operator|=
literal|0
expr_stmt|;
block|}
block|}
end_function

begin_function
name|void
name|ce_set_baud
parameter_list|(
name|ce_chan_t
modifier|*
name|c
parameter_list|,
name|unsigned
name|long
name|baud
parameter_list|)
block|{
name|TAU32_UserRequest
modifier|*
name|req
decl_stmt|;
name|ce_board_t
modifier|*
name|b
init|=
name|c
operator|->
name|board
decl_stmt|;
name|unsigned
name|long
name|cfg
init|=
name|c
operator|->
name|config
operator|&
operator|~
name|TAU32_framing_mode_mask
decl_stmt|;
name|unsigned
name|long
name|ts
decl_stmt|;
name|unsigned
name|long
name|kbps
init|=
operator|(
name|baud
operator|+
literal|32000
operator|)
operator|/
literal|64000
operator|*
literal|64
decl_stmt|;
if|if
condition|(
operator|!
name|c
operator|->
name|unfram
operator|||
name|c
operator|->
name|num
operator|!=
literal|0
operator|||
name|baud
operator|==
name|c
operator|->
name|baud
operator|||
name|b
operator|->
name|cr
operator|.
name|pending
operator|>=
name|CONFREQSZ
condition|)
return|return;
if|if
condition|(
operator|!
name|kbps
operator|||
name|kbps
operator|>
literal|1024
condition|)
block|{
name|ts
operator|=
literal|0xffffffffUL
expr_stmt|;
name|cfg
operator||=
name|TAU32_unframed_2048
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|kbps
operator|>
literal|512
condition|)
block|{
name|ts
operator|=
literal|0x0000ffffUL
expr_stmt|;
name|cfg
operator||=
name|TAU32_unframed_1024
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|kbps
operator|>
literal|256
condition|)
block|{
name|ts
operator|=
literal|0x000000ffUL
expr_stmt|;
name|cfg
operator||=
name|TAU32_unframed_512
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|kbps
operator|>
literal|128
condition|)
block|{
name|ts
operator|=
literal|0x0000000fUL
expr_stmt|;
name|cfg
operator||=
name|TAU32_unframed_256
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|kbps
operator|>
literal|64
condition|)
block|{
name|ts
operator|=
literal|0x00000003UL
expr_stmt|;
name|cfg
operator||=
name|TAU32_unframed_128
expr_stmt|;
block|}
else|else
block|{
name|ts
operator|=
literal|0x00000001UL
expr_stmt|;
name|cfg
operator||=
name|TAU32_unframed_64
expr_stmt|;
block|}
comment|/* _ce_set_ts () will set proper baud */
name|_ce_set_ts
argument_list|(
name|c
argument_list|,
name|ts
argument_list|)
expr_stmt|;
name|CE_PREREQUEST
argument_list|(
name|b
argument_list|,
name|c
argument_list|,
name|b
operator|->
name|cr
operator|.
name|queue
argument_list|,
name|req
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|req
condition|)
return|return;
name|req
operator|->
name|Command
operator|=
name|TAU32_Configure_E1
expr_stmt|;
name|req
operator|->
name|Io
operator|.
name|InterfaceConfig
operator|.
name|Interface
operator|=
name|TAU32_E1_A
expr_stmt|;
name|req
operator|->
name|Io
operator|.
name|InterfaceConfig
operator|.
name|Config
operator|=
name|cfg
expr_stmt|;
name|req
operator|->
name|Io
operator|.
name|InterfaceConfig
operator|.
name|UnframedTsMask
operator|=
name|ts
expr_stmt|;
if|if
condition|(
name|ce_cfg_submit
argument_list|(
name|b
argument_list|)
condition|)
block|{
name|c
operator|->
name|baud
operator|=
name|baud
expr_stmt|;
name|c
operator|->
name|ts
operator|=
name|ts
expr_stmt|;
name|c
operator|->
name|config
operator|=
name|cfg
expr_stmt|;
block|}
block|}
end_function

begin_function
name|void
name|ce_set_lloop
parameter_list|(
name|ce_chan_t
modifier|*
name|c
parameter_list|,
name|unsigned
name|char
name|on
parameter_list|)
block|{
name|TAU32_UserRequest
modifier|*
name|req
decl_stmt|;
name|unsigned
name|long
name|cfg
init|=
name|c
operator|->
name|config
operator|&
operator|~
operator|(
name|TAU32_line_mode_mask
operator||
name|TAU32_ais_on_loss
operator|)
decl_stmt|;
name|ce_board_t
modifier|*
name|b
init|=
name|c
operator|->
name|board
decl_stmt|;
if|if
condition|(
name|c
operator|->
name|num
operator|>=
name|b
operator|->
name|ddk
operator|.
name|Interfaces
operator|||
name|b
operator|->
name|cr
operator|.
name|pending
operator|>=
name|CONFREQSZ
condition|)
return|return;
name|on
operator|=
name|on
condition|?
literal|1
else|:
literal|0
expr_stmt|;
if|if
condition|(
name|on
operator|==
name|c
operator|->
name|lloop
condition|)
return|return;
name|cfg
operator||=
name|on
condition|?
name|TAU32_LineLoopInt
else|:
operator|(
name|TAU32_LineNormal
operator||
name|TAU32_ais_on_loss
operator|)
expr_stmt|;
name|CE_PREREQUEST
argument_list|(
name|b
argument_list|,
name|c
argument_list|,
name|b
operator|->
name|cr
operator|.
name|queue
argument_list|,
name|req
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|req
condition|)
return|return;
name|req
operator|->
name|Command
operator|=
name|TAU32_Configure_E1
expr_stmt|;
name|req
operator|->
name|Io
operator|.
name|InterfaceConfig
operator|.
name|Interface
operator|=
name|c
operator|->
name|num
condition|?
name|TAU32_E1_B
else|:
name|TAU32_E1_A
expr_stmt|;
name|req
operator|->
name|Io
operator|.
name|InterfaceConfig
operator|.
name|Config
operator|=
name|cfg
expr_stmt|;
name|req
operator|->
name|Io
operator|.
name|InterfaceConfig
operator|.
name|UnframedTsMask
operator|=
name|c
operator|->
name|ts
expr_stmt|;
name|CE_DDK_DEBUG
argument_list|(
name|b
argument_list|,
name|c
argument_list|,
operator|(
literal|"Submit lloop\n"
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|ce_cfg_submit
argument_list|(
name|b
argument_list|)
condition|)
block|{
name|c
operator|->
name|lloop
operator|=
name|on
condition|?
literal|1
else|:
literal|0
expr_stmt|;
name|c
operator|->
name|config
operator|=
name|cfg
expr_stmt|;
block|}
block|}
end_function

begin_function
name|void
name|ce_set_rloop
parameter_list|(
name|ce_chan_t
modifier|*
name|c
parameter_list|,
name|unsigned
name|char
name|on
parameter_list|)
block|{
name|TAU32_UserRequest
modifier|*
name|req
decl_stmt|;
name|unsigned
name|long
name|cfg
init|=
name|c
operator|->
name|config
operator|&
operator|~
name|TAU32_line_mode_mask
decl_stmt|;
name|ce_board_t
modifier|*
name|b
init|=
name|c
operator|->
name|board
decl_stmt|;
if|if
condition|(
name|c
operator|->
name|num
operator|>=
name|b
operator|->
name|ddk
operator|.
name|Interfaces
operator|||
name|b
operator|->
name|cr
operator|.
name|pending
operator|>=
name|CONFREQSZ
condition|)
return|return;
name|on
operator|=
name|on
condition|?
literal|1
else|:
literal|0
expr_stmt|;
if|if
condition|(
name|on
operator|==
name|c
operator|->
name|rloop
condition|)
return|return;
name|cfg
operator||=
name|on
condition|?
name|TAU32_LineLoopExt
else|:
name|TAU32_LineNormal
expr_stmt|;
name|CE_PREREQUEST
argument_list|(
name|b
argument_list|,
name|c
argument_list|,
name|b
operator|->
name|cr
operator|.
name|queue
argument_list|,
name|req
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|req
condition|)
return|return;
name|req
operator|->
name|Command
operator|=
name|TAU32_Configure_E1
expr_stmt|;
name|req
operator|->
name|Io
operator|.
name|InterfaceConfig
operator|.
name|Interface
operator|=
name|c
operator|->
name|num
condition|?
name|TAU32_E1_B
else|:
name|TAU32_E1_A
expr_stmt|;
name|req
operator|->
name|Io
operator|.
name|InterfaceConfig
operator|.
name|Config
operator|=
name|cfg
expr_stmt|;
name|req
operator|->
name|Io
operator|.
name|InterfaceConfig
operator|.
name|UnframedTsMask
operator|=
name|c
operator|->
name|ts
expr_stmt|;
name|CE_DDK_DEBUG
argument_list|(
name|b
argument_list|,
name|c
argument_list|,
operator|(
literal|"Submit rloop\n"
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|ce_cfg_submit
argument_list|(
name|b
argument_list|)
condition|)
block|{
name|c
operator|->
name|rloop
operator|=
name|on
condition|?
literal|1
else|:
literal|0
expr_stmt|;
name|c
operator|->
name|config
operator|=
name|cfg
expr_stmt|;
block|}
block|}
end_function

begin_function
name|void
name|ce_set_higain
parameter_list|(
name|ce_chan_t
modifier|*
name|c
parameter_list|,
name|unsigned
name|char
name|on
parameter_list|)
block|{
name|TAU32_UserRequest
modifier|*
name|req
decl_stmt|;
name|unsigned
name|long
name|cfg
init|=
name|c
operator|->
name|config
operator|&
operator|~
name|TAU32_higain
decl_stmt|;
name|ce_board_t
modifier|*
name|b
init|=
name|c
operator|->
name|board
decl_stmt|;
if|if
condition|(
name|c
operator|->
name|num
operator|>=
name|b
operator|->
name|ddk
operator|.
name|Interfaces
operator|||
name|b
operator|->
name|cr
operator|.
name|pending
operator|>=
name|CONFREQSZ
condition|)
return|return;
name|on
operator|=
name|on
condition|?
literal|1
else|:
literal|0
expr_stmt|;
if|if
condition|(
name|on
operator|==
name|c
operator|->
name|higain
condition|)
return|return;
name|cfg
operator||=
name|on
condition|?
name|TAU32_higain
else|:
literal|0
expr_stmt|;
name|CE_PREREQUEST
argument_list|(
name|b
argument_list|,
name|c
argument_list|,
name|b
operator|->
name|cr
operator|.
name|queue
argument_list|,
name|req
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|req
condition|)
return|return;
name|req
operator|->
name|Command
operator|=
name|TAU32_Configure_E1
expr_stmt|;
name|req
operator|->
name|Io
operator|.
name|InterfaceConfig
operator|.
name|Interface
operator|=
name|c
operator|->
name|num
condition|?
name|TAU32_E1_B
else|:
name|TAU32_E1_A
expr_stmt|;
name|req
operator|->
name|Io
operator|.
name|InterfaceConfig
operator|.
name|Config
operator|=
name|cfg
expr_stmt|;
name|req
operator|->
name|Io
operator|.
name|InterfaceConfig
operator|.
name|UnframedTsMask
operator|=
name|c
operator|->
name|ts
expr_stmt|;
name|CE_DDK_DEBUG
argument_list|(
name|b
argument_list|,
name|c
argument_list|,
operator|(
literal|"Submit higain\n"
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|ce_cfg_submit
argument_list|(
name|b
argument_list|)
condition|)
block|{
name|c
operator|->
name|higain
operator|=
name|on
condition|?
literal|1
else|:
literal|0
expr_stmt|;
name|c
operator|->
name|config
operator|=
name|cfg
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|_ce_set_ts
parameter_list|(
name|ce_chan_t
modifier|*
name|c
parameter_list|,
name|unsigned
name|long
name|ts
parameter_list|)
block|{
name|TAU32_UserRequest
modifier|*
name|req
decl_stmt|;
name|ce_board_t
modifier|*
name|b
init|=
name|c
operator|->
name|board
decl_stmt|;
name|unsigned
name|long
name|mask
init|=
literal|0
decl_stmt|,
name|omask
init|=
literal|0
decl_stmt|;
name|int
name|nts
init|=
literal|0
decl_stmt|,
name|ots
init|=
literal|0
decl_stmt|,
name|pts
init|=
literal|0
decl_stmt|;
name|int
name|i
decl_stmt|,
name|k
decl_stmt|;
if|if
condition|(
name|b
operator|->
name|cr
operator|.
name|pending
operator|>=
name|CONFREQSZ
condition|)
return|return;
comment|/* 	 * pts - number of busy "peb" ts 	 * ots - current (old) busy ts 	 * nts - new busy ts 	 */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|32
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|c
operator|->
name|ts
operator|&
operator|(
literal|1ul
operator|<<
name|i
operator|)
condition|)
name|ots
operator|++
expr_stmt|;
if|if
condition|(
name|ts
operator|&
operator|(
literal|1ul
operator|<<
name|i
operator|)
condition|)
name|nts
operator|++
expr_stmt|;
if|if
condition|(
name|b
operator|->
name|dxc
index|[
name|i
index|]
operator|!=
name|TAU32_CROSS_OFF
condition|)
name|pts
operator|++
expr_stmt|;
block|}
name|CE_DDK_DEBUG
argument_list|(
name|b
argument_list|,
name|c
argument_list|,
operator|(
literal|"pts: %d ots: %d nts: %d ts: %lx\n"
operator|,
name|pts
operator|,
name|ots
operator|,
name|nts
operator|,
name|ts
operator|)
argument_list|)
expr_stmt|;
comment|/* 32 - all busy + my old busy == free */
if|if
condition|(
literal|32
operator|-
name|pts
operator|+
name|ots
operator|-
name|nts
operator|<
literal|0
condition|)
return|return;
comment|/* Ok. We have enougth "peb" ts. Clean old. */
comment|/* We start from zero, cause this is peb cells */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|32
condition|;
name|i
operator|++
control|)
block|{
name|int
name|tin
init|=
name|b
operator|->
name|dxc
index|[
name|i
index|]
decl_stmt|;
name|int
name|t
init|=
name|tin
operator|%
literal|32
decl_stmt|;
if|if
condition|(
name|tin
operator|<
operator|(
name|c
operator|->
name|dir
condition|?
literal|64
else|:
literal|32
operator|)
operator|||
name|tin
operator|>
operator|(
name|c
operator|->
name|dir
condition|?
literal|95
else|:
literal|63
operator|)
condition|)
continue|continue;
if|if
condition|(
name|c
operator|->
name|ts
operator|&
operator|(
literal|1ul
operator|<<
name|t
operator|)
condition|)
block|{
name|b
operator|->
name|dxc
index|[
name|tin
index|]
operator|=
name|TAU32_CROSS_OFF
expr_stmt|;
name|b
operator|->
name|dxc
index|[
name|i
index|]
operator|=
name|TAU32_CROSS_OFF
expr_stmt|;
if|if
condition|(
name|b
operator|->
name|dxc
index|[
name|t
operator|+
literal|32
index|]
operator|==
name|TAU32_CROSS_OFF
operator|&&
name|b
operator|->
name|dxc
index|[
name|t
operator|+
literal|64
index|]
operator|==
name|TAU32_CROSS_OFF
condition|)
block|{
name|b
operator|->
name|dxc
index|[
name|t
operator|+
literal|32
index|]
operator|=
name|t
operator|+
literal|64
expr_stmt|;
name|b
operator|->
name|dxc
index|[
name|t
operator|+
literal|64
index|]
operator|=
name|t
operator|+
literal|32
expr_stmt|;
block|}
name|omask
operator||=
operator|(
literal|1ul
operator|<<
name|t
operator|)
expr_stmt|;
block|}
block|}
name|k
operator|=
literal|0
expr_stmt|;
comment|/* Set */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|32
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
operator|(
name|ts
operator|&
operator|(
literal|1ul
operator|<<
name|i
operator|)
operator|)
operator|==
literal|0
condition|)
continue|continue;
while|while
condition|(
name|b
operator|->
name|dxc
index|[
name|k
index|]
operator|!=
name|TAU32_CROSS_OFF
condition|)
block|{
name|k
operator|++
expr_stmt|;
comment|/* Paranoic */
if|if
condition|(
name|k
operator|>=
literal|32
condition|)
block|{
name|CE_DDK_DEBUG
argument_list|(
name|b
argument_list|,
name|c
argument_list|,
operator|(
literal|"TS count overflow\n"
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
block|}
name|b
operator|->
name|dxc
index|[
name|k
index|]
operator|=
operator|(
name|c
operator|->
name|dir
condition|?
literal|64
else|:
literal|32
operator|)
operator|+
name|i
expr_stmt|;
name|b
operator|->
name|dxc
index|[
operator|(
name|c
operator|->
name|dir
condition|?
literal|64
else|:
literal|32
operator|)
operator|+
name|i
index|]
operator|=
name|k
expr_stmt|;
if|if
condition|(
name|b
operator|->
name|dxc
index|[
operator|(
name|c
operator|->
name|dir
condition|?
literal|32
else|:
literal|64
operator|)
operator|+
name|i
index|]
operator|==
operator|(
name|c
operator|->
name|dir
condition|?
literal|64
else|:
literal|32
operator|)
operator|+
name|i
condition|)
name|b
operator|->
name|dxc
index|[
operator|(
name|c
operator|->
name|dir
condition|?
literal|32
else|:
literal|64
operator|)
operator|+
name|i
index|]
operator|=
name|TAU32_CROSS_OFF
expr_stmt|;
name|mask
operator||=
operator|(
literal|1ul
operator|<<
name|k
operator|)
expr_stmt|;
block|}
name|c
operator|->
name|ts
operator|=
name|ts
expr_stmt|;
name|c
operator|->
name|baud
operator|=
name|nts
operator|*
literal|64000
expr_stmt|;
name|CE_PREREQUEST
argument_list|(
name|b
argument_list|,
name|c
argument_list|,
name|b
operator|->
name|cr
operator|.
name|queue
argument_list|,
name|req
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|req
condition|)
return|return;
name|req
operator|->
name|Command
operator|=
name|TAU32_Timeslots_Channel
operator||
name|TAU32_Configure_Commit
expr_stmt|;
name|req
operator|->
name|Io
operator|.
name|ChannelNumber
operator|=
name|c
operator|->
name|num
expr_stmt|;
name|req
operator|->
name|Io
operator|.
name|ChannelConfig
operator|.
name|AssignedTsMask
operator|=
name|mask
expr_stmt|;
if|if
condition|(
name|c
operator|->
name|phony
condition|)
block|{
name|b
operator|->
name|pmask
operator|&=
operator|~
name|omask
expr_stmt|;
name|b
operator|->
name|pmask
operator||=
name|mask
expr_stmt|;
block|}
name|CE_DDK_DEBUG
argument_list|(
name|b
argument_list|,
name|c
argument_list|,
operator|(
literal|"ts=%lx mask=%lx omask=%lx pmask=%lx\n"
operator|,
name|c
operator|->
name|ts
operator|,
name|mask
operator|,
name|omask
operator|,
name|b
operator|->
name|pmask
operator|)
argument_list|)
expr_stmt|;
name|CE_DDK_DEBUG
argument_list|(
name|b
argument_list|,
name|c
argument_list|,
operator|(
literal|"Crossmatrix table:\n"
operator|)
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|CE_DDK_DEBUG_ENABLED
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|32
operator|*
literal|3
condition|;
name|i
operator|++
control|)
block|{
name|printf
argument_list|(
literal|"%3d\t%s"
argument_list|,
name|b
operator|->
name|dxc
index|[
name|i
index|]
argument_list|,
operator|(
name|i
operator|%
literal|8
operator|==
literal|7
operator|)
condition|?
literal|"\n"
else|:
literal|""
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"%s"
argument_list|,
operator|(
name|i
operator|%
literal|32
operator|==
literal|31
operator|)
condition|?
literal|"\n"
else|:
literal|""
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
name|CE_DDK_DEBUG
argument_list|(
name|b
argument_list|,
name|c
argument_list|,
operator|(
literal|"Submit tsmask\n"
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|ce_cfg_submit
argument_list|(
name|b
argument_list|)
condition|)
block|{
name|CE_DDK_DEBUG
argument_list|(
name|b
argument_list|,
name|c
argument_list|,
operator|(
literal|"Fail to submit tsmask\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* Do some error processing */
return|return;
block|}
name|CE_DDK_DEBUG
argument_list|(
name|b
argument_list|,
name|c
argument_list|,
operator|(
literal|"SetCrossMatrix\n"
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|TAU32_SetCrossMatrix
argument_list|(
name|b
operator|->
name|ddk
operator|.
name|pControllerObject
argument_list|,
name|b
operator|->
name|dxc
argument_list|,
name|b
operator|->
name|pmask
argument_list|)
condition|)
block|{
name|CE_DDK_DEBUG
argument_list|(
name|b
argument_list|,
name|c
argument_list|,
operator|(
literal|"Faild to SetCrossMatrix\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* Do some error processing */
return|return;
block|}
block|}
end_function

begin_function
name|void
name|ce_set_ts
parameter_list|(
name|ce_chan_t
modifier|*
name|c
parameter_list|,
name|unsigned
name|long
name|ts
parameter_list|)
block|{
name|ce_board_t
modifier|*
name|b
init|=
name|c
operator|->
name|board
decl_stmt|;
name|ce_chan_t
modifier|*
name|x
decl_stmt|;
if|if
condition|(
name|c
operator|->
name|ts
operator|==
name|ts
operator|||
name|b
operator|->
name|chan
operator|->
name|unfram
condition|)
return|return;
name|ts
operator|&=
operator|~
operator|(
literal|1ul
operator|)
expr_stmt|;
if|if
condition|(
operator|!
name|b
operator|->
name|chan
index|[
name|c
operator|->
name|dir
index|]
operator|.
name|use16
condition|)
name|ts
operator|&=
operator|~
operator|(
literal|1ul
operator|<<
literal|16
operator|)
expr_stmt|;
for|for
control|(
name|x
operator|=
name|b
operator|->
name|chan
init|;
name|x
operator|<
name|b
operator|->
name|chan
operator|+
name|NCHAN
condition|;
name|x
operator|++
control|)
block|{
if|if
condition|(
name|x
operator|==
name|c
operator|||
name|x
operator|->
name|dir
operator|!=
name|c
operator|->
name|dir
condition|)
continue|continue;
name|ts
operator|&=
operator|~
name|x
operator|->
name|ts
expr_stmt|;
block|}
name|_ce_set_ts
argument_list|(
name|c
argument_list|,
name|ts
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|ce_set_unfram
parameter_list|(
name|ce_chan_t
modifier|*
name|c
parameter_list|,
name|unsigned
name|char
name|on
parameter_list|)
block|{
name|TAU32_UserRequest
modifier|*
name|req
decl_stmt|;
name|ce_board_t
modifier|*
name|b
init|=
name|c
operator|->
name|board
decl_stmt|;
name|unsigned
name|long
name|cfg
init|=
name|c
operator|->
name|config
operator|&
operator|~
name|TAU32_framing_mode_mask
decl_stmt|;
name|unsigned
name|long
name|i
decl_stmt|;
if|if
condition|(
name|c
operator|->
name|num
operator|!=
literal|0
operator|||
name|b
operator|->
name|cr
operator|.
name|pending
operator|+
literal|2
operator|*
literal|32
operator|+
literal|3
operator|>=
name|CONFREQSZ
condition|)
return|return;
name|on
operator|=
name|on
condition|?
literal|1
else|:
literal|0
expr_stmt|;
if|if
condition|(
name|on
operator|==
name|c
operator|->
name|unfram
condition|)
return|return;
if|if
condition|(
name|on
condition|)
block|{
name|ce_set_dir
argument_list|(
name|c
argument_list|,
literal|0
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|1
init|;
name|i
operator|<
name|TAU32_CHANNELS
condition|;
name|i
operator|++
control|)
block|{
name|ce_set_ts
argument_list|(
name|b
operator|->
name|chan
operator|+
name|i
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|ce_set_phony
argument_list|(
name|b
operator|->
name|chan
operator|+
name|i
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
name|ce_set_use16
argument_list|(
name|b
operator|->
name|chan
operator|+
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|ce_set_use16
argument_list|(
name|b
operator|->
name|chan
operator|+
literal|1
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* Get current value, previous ce_set request may change it */
name|cfg
operator|=
name|c
operator|->
name|config
operator|&
operator|~
name|TAU32_framing_mode_mask
expr_stmt|;
name|cfg
operator||=
name|TAU32_unframed_2048
expr_stmt|;
name|c
operator|->
name|unfram
operator|=
name|on
expr_stmt|;
name|_ce_set_ts
argument_list|(
name|b
operator|->
name|chan
argument_list|,
operator|~
literal|0ul
argument_list|)
expr_stmt|;
name|c
operator|->
name|config
operator|=
name|cfg
expr_stmt|;
comment|/* XXXRIK: Do extra checks on config queue size*/
if|if
condition|(
name|b
operator|->
name|ddk
operator|.
name|Interfaces
condition|)
block|{
name|CE_PREREQUEST
argument_list|(
name|b
argument_list|,
name|c
argument_list|,
name|b
operator|->
name|cr
operator|.
name|queue
argument_list|,
name|req
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|req
condition|)
return|return;
name|req
operator|->
name|Command
operator|=
name|TAU32_Configure_E1
expr_stmt|;
name|req
operator|->
name|Io
operator|.
name|InterfaceConfig
operator|.
name|Interface
operator|=
name|TAU32_E1_B
expr_stmt|;
name|req
operator|->
name|Io
operator|.
name|InterfaceConfig
operator|.
name|Config
operator|=
name|TAU32_LineOff
expr_stmt|;
name|req
operator|->
name|Io
operator|.
name|InterfaceConfig
operator|.
name|UnframedTsMask
operator|=
literal|0
expr_stmt|;
name|CE_DDK_DEBUG
argument_list|(
name|b
argument_list|,
name|c
argument_list|,
operator|(
literal|"unfram: B line off\n"
operator|)
argument_list|)
expr_stmt|;
name|ce_cfg_submit
argument_list|(
name|b
argument_list|)
expr_stmt|;
block|}
name|CE_PREREQUEST
argument_list|(
name|b
argument_list|,
name|c
argument_list|,
name|b
operator|->
name|cr
operator|.
name|queue
argument_list|,
name|req
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|req
condition|)
return|return;
name|req
operator|->
name|Command
operator|=
name|TAU32_Configure_E1
expr_stmt|;
name|req
operator|->
name|Io
operator|.
name|InterfaceConfig
operator|.
name|Interface
operator|=
name|TAU32_E1_A
expr_stmt|;
name|req
operator|->
name|Io
operator|.
name|InterfaceConfig
operator|.
name|Config
operator|=
name|cfg
expr_stmt|;
name|req
operator|->
name|Io
operator|.
name|InterfaceConfig
operator|.
name|UnframedTsMask
operator|=
name|c
operator|->
name|ts
expr_stmt|;
name|CE_DDK_DEBUG
argument_list|(
name|b
argument_list|,
name|c
argument_list|,
operator|(
literal|"Submit unfram\n"
operator|)
argument_list|)
expr_stmt|;
name|ce_cfg_submit
argument_list|(
name|b
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|cfg
operator||=
name|TAU32_framed_cas_cross
expr_stmt|;
name|CE_PREREQUEST
argument_list|(
name|b
argument_list|,
name|c
argument_list|,
name|b
operator|->
name|cr
operator|.
name|queue
argument_list|,
name|req
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|req
condition|)
return|return;
name|req
operator|->
name|Command
operator|=
name|TAU32_Configure_E1
expr_stmt|;
name|req
operator|->
name|Io
operator|.
name|InterfaceConfig
operator|.
name|Interface
operator|=
name|TAU32_E1_ALL
expr_stmt|;
name|req
operator|->
name|Io
operator|.
name|InterfaceConfig
operator|.
name|Config
operator|=
name|cfg
expr_stmt|;
name|req
operator|->
name|Io
operator|.
name|InterfaceConfig
operator|.
name|UnframedTsMask
operator|=
literal|0
expr_stmt|;
name|CE_DDK_DEBUG
argument_list|(
name|b
argument_list|,
name|c
argument_list|,
operator|(
literal|"Submit framed\n"
operator|)
argument_list|)
expr_stmt|;
name|ce_cfg_submit
argument_list|(
name|b
argument_list|)
expr_stmt|;
name|ce_set_ts
argument_list|(
name|c
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
name|c
operator|->
name|unfram
operator|=
name|on
expr_stmt|;
block|}
end_function

begin_function
name|void
name|ce_set_phony
parameter_list|(
name|ce_chan_t
modifier|*
name|c
parameter_list|,
name|unsigned
name|char
name|on
parameter_list|)
block|{
name|TAU32_UserRequest
modifier|*
name|req
decl_stmt|;
name|ce_board_t
modifier|*
name|b
init|=
name|c
operator|->
name|board
decl_stmt|;
name|unsigned
name|long
name|mask
init|=
literal|0
decl_stmt|;
name|int
name|i
decl_stmt|;
if|if
condition|(
operator|(
name|c
operator|->
name|phony
operator|&&
name|on
operator|)
operator|||
operator|(
name|c
operator|->
name|phony
operator|==
literal|0
operator|&&
name|on
operator|==
literal|0
operator|)
operator|||
name|b
operator|->
name|cr
operator|.
name|pending
operator|>=
name|CONFREQSZ
condition|)
return|return;
name|CE_PREREQUEST
argument_list|(
name|b
argument_list|,
name|c
argument_list|,
name|b
operator|->
name|cr
operator|.
name|queue
argument_list|,
name|req
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|req
condition|)
return|return;
name|req
operator|->
name|Command
operator|=
name|TAU32_Configure_Channel
expr_stmt|;
name|req
operator|->
name|Io
operator|.
name|InterfaceConfig
operator|.
name|Config
operator|=
name|on
condition|?
name|TAU32_TMA
else|:
operator|(
name|TAU32_HDLC
operator||
name|TAU32_fr_rx_splitcheck
operator||
name|TAU32_fr_rx_fitcheck
operator|)
expr_stmt|;
name|req
operator|->
name|Io
operator|.
name|ChannelNumber
operator|=
name|c
operator|->
name|num
expr_stmt|;
name|CE_DDK_DEBUG
argument_list|(
name|b
argument_list|,
name|c
argument_list|,
operator|(
literal|"Submit phony\n"
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|ce_cfg_submit
argument_list|(
name|b
argument_list|)
condition|)
block|{
comment|/* Do some error processing */
return|return;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|32
condition|;
name|i
operator|++
control|)
block|{
name|int
name|t
init|=
name|b
operator|->
name|dxc
index|[
name|i
index|]
operator|%
literal|32
decl_stmt|;
if|if
condition|(
name|b
operator|->
name|dxc
index|[
name|i
index|]
operator|<
operator|(
name|c
operator|->
name|dir
condition|?
literal|64
else|:
literal|32
operator|)
operator|||
name|b
operator|->
name|dxc
index|[
name|i
index|]
operator|>
operator|(
name|c
operator|->
name|dir
condition|?
literal|95
else|:
literal|63
operator|)
condition|)
continue|continue;
if|if
condition|(
name|c
operator|->
name|ts
operator|&
operator|(
literal|1ul
operator|<<
name|t
operator|)
condition|)
name|mask
operator||=
operator|(
literal|1ul
operator|<<
name|t
operator|)
expr_stmt|;
block|}
name|CE_DDK_DEBUG
argument_list|(
name|b
argument_list|,
name|c
argument_list|,
operator|(
literal|"phony mask:%lx\n"
operator|,
name|mask
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|on
condition|)
block|{
name|b
operator|->
name|pmask
operator||=
name|mask
expr_stmt|;
block|}
else|else
block|{
name|b
operator|->
name|pmask
operator|&=
operator|~
name|mask
expr_stmt|;
block|}
name|c
operator|->
name|phony
operator|=
name|on
condition|?
literal|1
else|:
literal|0
expr_stmt|;
name|CE_DDK_DEBUG
argument_list|(
name|b
argument_list|,
name|c
argument_list|,
operator|(
literal|"Submit (setcrosmatrix) phony\n"
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|TAU32_SetCrossMatrix
argument_list|(
name|b
operator|->
name|ddk
operator|.
name|pControllerObject
argument_list|,
name|b
operator|->
name|dxc
argument_list|,
name|b
operator|->
name|pmask
argument_list|)
condition|)
block|{
comment|/* Do some error processing */
return|return;
block|}
block|}
end_function

begin_function
name|void
name|ce_set_scrambler
parameter_list|(
name|ce_chan_t
modifier|*
name|c
parameter_list|,
name|unsigned
name|char
name|on
parameter_list|)
block|{
name|TAU32_UserRequest
modifier|*
name|req
decl_stmt|;
name|unsigned
name|long
name|cfg
init|=
name|c
operator|->
name|config
operator|&
operator|~
name|TAU32_scrambler
decl_stmt|;
name|ce_board_t
modifier|*
name|b
init|=
name|c
operator|->
name|board
decl_stmt|;
if|if
condition|(
name|c
operator|->
name|num
operator|!=
literal|0
operator|||
name|c
operator|->
name|unfram
operator|==
literal|0
operator|||
name|b
operator|->
name|cr
operator|.
name|pending
operator|>=
name|CONFREQSZ
condition|)
return|return;
name|on
operator|=
name|on
condition|?
literal|1
else|:
literal|0
expr_stmt|;
if|if
condition|(
name|on
operator|==
name|c
operator|->
name|scrambler
condition|)
return|return;
name|cfg
operator||=
name|on
condition|?
name|TAU32_scrambler
else|:
literal|0
expr_stmt|;
name|CE_PREREQUEST
argument_list|(
name|b
argument_list|,
name|c
argument_list|,
name|b
operator|->
name|cr
operator|.
name|queue
argument_list|,
name|req
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|req
condition|)
return|return;
name|req
operator|->
name|Command
operator|=
name|TAU32_Configure_E1
expr_stmt|;
name|req
operator|->
name|Io
operator|.
name|InterfaceConfig
operator|.
name|Interface
operator|=
name|c
operator|->
name|num
condition|?
name|TAU32_E1_B
else|:
name|TAU32_E1_A
expr_stmt|;
name|req
operator|->
name|Io
operator|.
name|InterfaceConfig
operator|.
name|Config
operator|=
name|cfg
expr_stmt|;
name|req
operator|->
name|Io
operator|.
name|InterfaceConfig
operator|.
name|UnframedTsMask
operator|=
name|c
operator|->
name|ts
expr_stmt|;
name|CE_DDK_DEBUG
argument_list|(
name|b
argument_list|,
name|c
argument_list|,
operator|(
literal|"Submit scrambler\n"
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|ce_cfg_submit
argument_list|(
name|b
argument_list|)
condition|)
block|{
name|c
operator|->
name|scrambler
operator|=
name|on
condition|?
literal|1
else|:
literal|0
expr_stmt|;
name|c
operator|->
name|config
operator|=
name|cfg
expr_stmt|;
block|}
block|}
end_function

begin_function
name|void
name|ce_set_monitor
parameter_list|(
name|ce_chan_t
modifier|*
name|c
parameter_list|,
name|unsigned
name|char
name|on
parameter_list|)
block|{
name|TAU32_UserRequest
modifier|*
name|req
decl_stmt|;
name|unsigned
name|long
name|cfg
init|=
name|c
operator|->
name|config
operator|&
operator|~
name|TAU32_monitor
decl_stmt|;
name|ce_board_t
modifier|*
name|b
init|=
name|c
operator|->
name|board
decl_stmt|;
if|if
condition|(
name|c
operator|->
name|num
operator|>=
name|b
operator|->
name|ddk
operator|.
name|Interfaces
operator|||
name|b
operator|->
name|cr
operator|.
name|pending
operator|>=
name|CONFREQSZ
condition|)
return|return;
name|on
operator|=
name|on
condition|?
literal|1
else|:
literal|0
expr_stmt|;
if|if
condition|(
name|on
operator|==
name|c
operator|->
name|monitor
condition|)
return|return;
name|cfg
operator||=
name|on
condition|?
name|TAU32_monitor
else|:
literal|0
expr_stmt|;
name|CE_PREREQUEST
argument_list|(
name|b
argument_list|,
name|c
argument_list|,
name|b
operator|->
name|cr
operator|.
name|queue
argument_list|,
name|req
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|req
condition|)
return|return;
name|req
operator|->
name|Command
operator|=
name|TAU32_Configure_E1
expr_stmt|;
name|req
operator|->
name|Io
operator|.
name|InterfaceConfig
operator|.
name|Interface
operator|=
name|c
operator|->
name|num
condition|?
name|TAU32_E1_B
else|:
name|TAU32_E1_A
expr_stmt|;
name|req
operator|->
name|Io
operator|.
name|InterfaceConfig
operator|.
name|Config
operator|=
name|cfg
expr_stmt|;
name|req
operator|->
name|Io
operator|.
name|InterfaceConfig
operator|.
name|UnframedTsMask
operator|=
name|c
operator|->
name|ts
expr_stmt|;
name|CE_DDK_DEBUG
argument_list|(
name|b
argument_list|,
name|c
argument_list|,
operator|(
literal|"Submit monitor\n"
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|ce_cfg_submit
argument_list|(
name|b
argument_list|)
condition|)
block|{
name|c
operator|->
name|monitor
operator|=
name|on
condition|?
literal|1
else|:
literal|0
expr_stmt|;
name|c
operator|->
name|config
operator|=
name|cfg
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|_ce_submit_configure_e1
parameter_list|(
name|ce_chan_t
modifier|*
name|c
parameter_list|,
name|char
modifier|*
name|rname
parameter_list|)
block|{
name|TAU32_UserRequest
modifier|*
name|req
decl_stmt|;
name|ce_board_t
modifier|*
name|b
init|=
name|c
operator|->
name|board
decl_stmt|;
name|CE_PREREQUEST
argument_list|(
name|b
argument_list|,
name|c
argument_list|,
name|b
operator|->
name|cr
operator|.
name|queue
argument_list|,
name|req
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|req
condition|)
return|return;
name|req
operator|->
name|Command
operator|=
name|TAU32_Configure_E1
expr_stmt|;
name|req
operator|->
name|Io
operator|.
name|InterfaceConfig
operator|.
name|Interface
operator|=
name|c
operator|->
name|num
operator|==
literal|0
condition|?
name|TAU32_E1_A
else|:
name|TAU32_E1_B
expr_stmt|;
name|req
operator|->
name|Io
operator|.
name|InterfaceConfig
operator|.
name|Config
operator|=
name|c
operator|->
name|config
expr_stmt|;
name|req
operator|->
name|Io
operator|.
name|InterfaceConfig
operator|.
name|UnframedTsMask
operator|=
name|c
operator|->
name|ts
expr_stmt|;
name|CE_DDK_DEBUG
argument_list|(
name|b
argument_list|,
name|c
argument_list|,
operator|(
literal|"Submit %s\n"
operator|,
name|rname
condition|?
name|rname
else|:
literal|""
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|ce_cfg_submit
argument_list|(
name|b
argument_list|)
condition|)
block|{
name|CE_DDK_DEBUG
argument_list|(
name|b
argument_list|,
name|c
argument_list|,
operator|(
literal|"Fail to submit %s\n"
operator|,
name|rname
condition|?
name|rname
else|:
literal|""
operator|)
argument_list|)
expr_stmt|;
comment|/* Do some error processing */
return|return;
block|}
block|}
end_function

begin_function
name|void
name|ce_set_use16
parameter_list|(
name|ce_chan_t
modifier|*
name|c
parameter_list|,
name|unsigned
name|char
name|on
parameter_list|)
block|{
name|ce_board_t
modifier|*
name|b
init|=
name|c
operator|->
name|board
decl_stmt|;
name|ce_chan_t
modifier|*
name|x
decl_stmt|;
name|unsigned
name|long
name|cfg
index|[
literal|2
index|]
decl_stmt|;
name|int
name|use
index|[
literal|2
index|]
decl_stmt|;
if|if
condition|(
name|c
operator|->
name|num
operator|>=
name|b
operator|->
name|ddk
operator|.
name|Interfaces
operator|||
name|b
operator|->
name|cr
operator|.
name|pending
operator|+
literal|2
operator|>=
name|CONFREQSZ
condition|)
return|return;
name|cfg
index|[
literal|0
index|]
operator|=
name|b
operator|->
name|chan
index|[
literal|0
index|]
operator|.
name|config
operator|&
operator|~
name|TAU32_framing_mode_mask
expr_stmt|;
name|cfg
index|[
literal|1
index|]
operator|=
name|b
operator|->
name|chan
index|[
literal|1
index|]
operator|.
name|config
operator|&
operator|~
name|TAU32_framing_mode_mask
expr_stmt|;
name|on
operator|=
name|on
condition|?
literal|1
else|:
literal|0
expr_stmt|;
if|if
condition|(
name|c
operator|->
name|use16
operator|==
name|on
operator|||
name|b
operator|->
name|chan
operator|->
name|unfram
condition|)
return|return;
name|use
index|[
literal|0
index|]
operator|=
name|b
operator|->
name|chan
index|[
literal|0
index|]
operator|.
name|use16
expr_stmt|;
name|use
index|[
literal|1
index|]
operator|=
name|b
operator|->
name|chan
index|[
literal|1
index|]
operator|.
name|use16
expr_stmt|;
comment|/* Correct value */
name|use
index|[
name|c
operator|->
name|num
index|]
operator|=
name|on
expr_stmt|;
if|if
condition|(
name|b
operator|->
name|ddk
operator|.
name|Interfaces
operator|==
literal|1
condition|)
block|{
name|cfg
index|[
literal|0
index|]
operator||=
name|on
condition|?
name|TAU32_framed_cas_set
else|:
name|TAU32_framed_no_cas
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|use
index|[
literal|0
index|]
operator|==
literal|0
operator|&&
name|use
index|[
literal|1
index|]
operator|==
literal|0
condition|)
block|{
name|cfg
index|[
literal|0
index|]
operator||=
name|TAU32_framed_cas_cross
expr_stmt|;
name|cfg
index|[
literal|1
index|]
operator||=
name|TAU32_framed_cas_cross
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|use
index|[
literal|0
index|]
operator|==
literal|0
condition|)
block|{
name|cfg
index|[
literal|0
index|]
operator||=
name|TAU32_framed_cas_set
expr_stmt|;
name|cfg
index|[
literal|1
index|]
operator||=
name|TAU32_framed_no_cas
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|use
index|[
literal|1
index|]
operator|==
literal|0
condition|)
block|{
name|cfg
index|[
literal|0
index|]
operator||=
name|TAU32_framed_no_cas
expr_stmt|;
name|cfg
index|[
literal|1
index|]
operator||=
name|TAU32_framed_cas_set
expr_stmt|;
block|}
else|else
block|{
name|cfg
index|[
literal|0
index|]
operator||=
name|TAU32_framed_no_cas
expr_stmt|;
name|cfg
index|[
literal|1
index|]
operator||=
name|TAU32_framed_no_cas
expr_stmt|;
block|}
block|}
name|c
operator|->
name|use16
operator|=
name|on
expr_stmt|;
for|for
control|(
name|x
operator|=
name|b
operator|->
name|chan
init|;
operator|!
name|on
operator|&&
name|x
operator|<
name|b
operator|->
name|chan
operator|+
name|NCHAN
condition|;
name|x
operator|++
control|)
block|{
if|if
condition|(
name|x
operator|->
name|dir
operator|==
name|c
operator|->
name|num
operator|&&
name|x
operator|->
name|ts
operator|&
operator|(
literal|1ul
operator|<<
literal|16
operator|)
condition|)
block|{
name|ce_set_ts
argument_list|(
name|x
argument_list|,
name|x
operator|->
name|ts
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
if|if
condition|(
name|cfg
index|[
literal|0
index|]
operator|!=
name|b
operator|->
name|chan
index|[
literal|0
index|]
operator|.
name|config
condition|)
block|{
name|b
operator|->
name|chan
index|[
literal|0
index|]
operator|.
name|config
operator|=
name|cfg
index|[
literal|0
index|]
expr_stmt|;
name|_ce_submit_configure_e1
argument_list|(
name|b
operator|->
name|chan
operator|+
literal|0
argument_list|,
literal|"use16"
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|cfg
index|[
literal|1
index|]
operator|!=
name|b
operator|->
name|chan
index|[
literal|1
index|]
operator|.
name|config
condition|)
block|{
name|b
operator|->
name|chan
index|[
literal|1
index|]
operator|.
name|config
operator|=
name|cfg
index|[
literal|1
index|]
expr_stmt|;
name|_ce_submit_configure_e1
argument_list|(
name|b
operator|->
name|chan
operator|+
literal|1
argument_list|,
literal|"use16"
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
name|void
name|ce_set_crc4
parameter_list|(
name|ce_chan_t
modifier|*
name|c
parameter_list|,
name|unsigned
name|char
name|on
parameter_list|)
block|{
name|TAU32_UserRequest
modifier|*
name|req
decl_stmt|;
name|unsigned
name|long
name|cfg
init|=
name|c
operator|->
name|config
operator|&
operator|~
name|TAU32_crc4_mf
decl_stmt|;
name|ce_board_t
modifier|*
name|b
init|=
name|c
operator|->
name|board
decl_stmt|;
if|if
condition|(
name|c
operator|->
name|num
operator|>=
name|b
operator|->
name|ddk
operator|.
name|Interfaces
operator|||
name|b
operator|->
name|cr
operator|.
name|pending
operator|>=
name|CONFREQSZ
condition|)
return|return;
name|on
operator|=
name|on
condition|?
literal|1
else|:
literal|0
expr_stmt|;
if|if
condition|(
name|on
operator|==
name|c
operator|->
name|crc4
operator|||
name|b
operator|->
name|chan
operator|->
name|unfram
condition|)
return|return;
name|cfg
operator||=
name|on
condition|?
name|TAU32_crc4_mf
else|:
literal|0
expr_stmt|;
name|CE_PREREQUEST
argument_list|(
name|b
argument_list|,
name|c
argument_list|,
name|b
operator|->
name|cr
operator|.
name|queue
argument_list|,
name|req
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|req
condition|)
return|return;
name|req
operator|->
name|Command
operator|=
name|TAU32_Configure_E1
expr_stmt|;
name|req
operator|->
name|Io
operator|.
name|InterfaceConfig
operator|.
name|Interface
operator|=
name|c
operator|->
name|num
condition|?
name|TAU32_E1_B
else|:
name|TAU32_E1_A
expr_stmt|;
name|req
operator|->
name|Io
operator|.
name|InterfaceConfig
operator|.
name|Config
operator|=
name|cfg
expr_stmt|;
name|req
operator|->
name|Io
operator|.
name|InterfaceConfig
operator|.
name|UnframedTsMask
operator|=
name|c
operator|->
name|ts
expr_stmt|;
name|CE_DDK_DEBUG
argument_list|(
name|b
argument_list|,
name|c
argument_list|,
operator|(
literal|"Submit crc4\n"
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|ce_cfg_submit
argument_list|(
name|b
argument_list|)
condition|)
block|{
name|c
operator|->
name|crc4
operator|=
name|on
condition|?
literal|1
else|:
literal|0
expr_stmt|;
name|c
operator|->
name|config
operator|=
name|cfg
expr_stmt|;
block|}
block|}
end_function

begin_function
name|void
name|ce_set_gsyn
parameter_list|(
name|ce_chan_t
modifier|*
name|c
parameter_list|,
name|int
name|syn
parameter_list|)
block|{
name|ce_board_t
modifier|*
name|b
init|=
name|c
operator|->
name|board
decl_stmt|;
name|unsigned
name|int
name|mode
decl_stmt|;
if|if
condition|(
name|c
operator|->
name|num
operator|>=
name|b
operator|->
name|ddk
operator|.
name|Interfaces
condition|)
return|return;
if|if
condition|(
name|syn
operator|==
name|GSYN_RCV
condition|)
name|syn
operator|=
name|c
operator|->
name|num
condition|?
name|GSYN_RCV1
else|:
name|GSYN_RCV0
expr_stmt|;
switch|switch
condition|(
name|syn
condition|)
block|{
default|default:
name|mode
operator|=
name|TAU32_SYNC_INTERNAL
expr_stmt|;
break|break;
case|case
name|GSYN_RCV0
case|:
name|mode
operator|=
name|TAU32_SYNC_RCV_A
expr_stmt|;
break|break;
case|case
name|GSYN_RCV1
case|:
name|mode
operator|=
name|TAU32_SYNC_RCV_B
expr_stmt|;
break|break;
block|}
name|CE_DDK_DEBUG
argument_list|(
name|b
argument_list|,
name|c
argument_list|,
operator|(
literal|"Set Sync Mode\n"
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|TAU32_SetSyncMode
argument_list|(
name|b
operator|->
name|ddk
operator|.
name|pControllerObject
argument_list|,
name|mode
argument_list|)
condition|)
block|{
name|b
operator|->
name|chan
operator|->
name|gsyn
operator|=
name|syn
expr_stmt|;
if|if
condition|(
name|b
operator|->
name|ddk
operator|.
name|Interfaces
operator|>
literal|1
condition|)
operator|(
name|b
operator|->
name|chan
operator|+
literal|1
operator|)
operator|->
name|gsyn
operator|=
name|syn
expr_stmt|;
block|}
block|}
end_function

begin_function
name|int
name|ce_get_cable
parameter_list|(
name|ce_chan_t
modifier|*
name|c
parameter_list|)
block|{
name|ce_board_t
modifier|*
name|b
init|=
name|c
operator|->
name|board
decl_stmt|;
if|if
condition|(
name|c
operator|->
name|num
operator|>=
name|b
operator|->
name|ddk
operator|.
name|Interfaces
condition|)
return|return
literal|0
return|;
return|return
name|CABLE_TP
return|;
block|}
end_function

begin_function
name|void
name|ce_set_dir
parameter_list|(
name|ce_chan_t
modifier|*
name|c
parameter_list|,
name|int
name|dir
parameter_list|)
block|{
name|ce_board_t
modifier|*
name|b
init|=
name|c
operator|->
name|board
decl_stmt|;
name|unsigned
name|long
name|ts
decl_stmt|;
if|if
condition|(
name|b
operator|->
name|cr
operator|.
name|pending
operator|+
literal|1
operator|>=
name|CONFREQSZ
operator|||
name|c
operator|->
name|dir
operator|==
name|dir
condition|)
return|return;
name|ts
operator|=
name|c
operator|->
name|ts
expr_stmt|;
name|ce_set_ts
argument_list|(
name|c
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|c
operator|->
name|dir
operator|=
name|dir
expr_stmt|;
name|ce_set_ts
argument_list|(
name|c
argument_list|,
name|ts
argument_list|)
expr_stmt|;
block|}
end_function

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*-  * ichsmb.c  *  * Author: Archie Cobbs<archie@freebsd.org>  * Copyright (c) 2000 Whistle Communications, Inc.  * All rights reserved.  *   * Subject to the following obligations and disclaimer of warranty, use and  * redistribution of this software, in source or object code forms, with or  * without modifications are expressly permitted by Whistle Communications;  * provided, however, that:  * 1. Any and all reproductions of the source or object code must include the  *    copyright notice above and the following disclaimer of warranties; and  * 2. No rights are granted, in any manner or form, to use Whistle  *    Communications, Inc. trademarks, including the mark "WHISTLE  *    COMMUNICATIONS" on advertising, endorsements, or otherwise except as  *    such appears in the above copyright notice or in the software.  *   * THIS SOFTWARE IS BEING PROVIDED BY WHISTLE COMMUNICATIONS "AS IS", AND  * TO THE MAXIMUM EXTENT PERMITTED BY LAW, WHISTLE COMMUNICATIONS MAKES NO  * REPRESENTATIONS OR WARRANTIES, EXPRESS OR IMPLIED, REGARDING THIS SOFTWARE,  * INCLUDING WITHOUT LIMITATION, ANY AND ALL IMPLIED WARRANTIES OF  * MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE, OR NON-INFRINGEMENT.  * WHISTLE COMMUNICATIONS DOES NOT WARRANT, GUARANTEE, OR MAKE ANY  * REPRESENTATIONS REGARDING THE USE OF, OR THE RESULTS OF THE USE OF THIS  * SOFTWARE IN TERMS OF ITS CORRECTNESS, ACCURACY, RELIABILITY OR OTHERWISE.  * IN NO EVENT SHALL WHISTLE COMMUNICATIONS BE LIABLE FOR ANY DAMAGES  * RESULTING FROM OR ARISING OUT OF ANY USE OF THIS SOFTWARE, INCLUDING  * WITHOUT LIMITATION, ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY,  * PUNITIVE, OR CONSEQUENTIAL DAMAGES, PROCUREMENT OF SUBSTITUTE GOODS OR  * SERVICES, LOSS OF USE, DATA OR PROFITS, HOWEVER CAUSED AND UNDER ANY  * THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT  * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF  * THIS SOFTWARE, EVEN IF WHISTLE COMMUNICATIONS IS ADVISED OF THE POSSIBILITY  * OF SUCH DAMAGE.  */
end_comment

begin_include
include|#
directive|include
file|<sys/cdefs.h>
end_include

begin_expr_stmt
name|__FBSDID
argument_list|(
literal|"$FreeBSD$"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_comment
comment|/*  * Support for the SMBus controller logical device which is part of the  * Intel 81801AA (ICH) and 81801AB (ICH0) I/O controller hub chips.  *  * This driver assumes that the generic SMBus code will ensure that  * at most one process at a time calls into the SMBus methods below.  */
end_comment

begin_include
include|#
directive|include
file|<sys/param.h>
end_include

begin_include
include|#
directive|include
file|<sys/systm.h>
end_include

begin_include
include|#
directive|include
file|<sys/kernel.h>
end_include

begin_include
include|#
directive|include
file|<sys/errno.h>
end_include

begin_include
include|#
directive|include
file|<sys/lock.h>
end_include

begin_include
include|#
directive|include
file|<sys/module.h>
end_include

begin_include
include|#
directive|include
file|<sys/mutex.h>
end_include

begin_include
include|#
directive|include
file|<sys/syslog.h>
end_include

begin_include
include|#
directive|include
file|<sys/bus.h>
end_include

begin_include
include|#
directive|include
file|<machine/bus.h>
end_include

begin_include
include|#
directive|include
file|<sys/rman.h>
end_include

begin_include
include|#
directive|include
file|<machine/resource.h>
end_include

begin_include
include|#
directive|include
file|<dev/smbus/smbconf.h>
end_include

begin_include
include|#
directive|include
file|<dev/ichsmb/ichsmb_var.h>
end_include

begin_include
include|#
directive|include
file|<dev/ichsmb/ichsmb_reg.h>
end_include

begin_comment
comment|/*  * Enable debugging by defining ICHSMB_DEBUG to a non-zero value.  */
end_comment

begin_define
define|#
directive|define
name|ICHSMB_DEBUG
value|0
end_define

begin_if
if|#
directive|if
name|ICHSMB_DEBUG
operator|!=
literal|0
operator|&&
name|defined
argument_list|(
name|__CC_SUPPORTS___FUNC__
argument_list|)
end_if

begin_define
define|#
directive|define
name|DBG
parameter_list|(
name|fmt
parameter_list|,
name|args
modifier|...
parameter_list|)
define|\
value|do { printf("%s: " fmt, __func__ , ## args); } while (0)
end_define

begin_else
else|#
directive|else
end_else

begin_define
define|#
directive|define
name|DBG
parameter_list|(
name|fmt
parameter_list|,
name|args
modifier|...
parameter_list|)
value|do { } while (0)
end_define

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/*  * Our child device driver name  */
end_comment

begin_define
define|#
directive|define
name|DRIVER_SMBUS
value|"smbus"
end_define

begin_comment
comment|/*  * Internal functions  */
end_comment

begin_function_decl
specifier|static
name|int
name|ichsmb_wait
parameter_list|(
name|sc_p
name|sc
parameter_list|)
function_decl|;
end_function_decl

begin_comment
comment|/******************************************************************** 		BUS-INDEPENDENT BUS METHODS ********************************************************************/
end_comment

begin_comment
comment|/*  * Handle probe-time duties that are independent of the bus  * our device lives on.  */
end_comment

begin_function
name|int
name|ichsmb_probe
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
return|return
operator|(
name|BUS_PROBE_DEFAULT
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Handle attach-time duties that are independent of the bus  * our device lives on.  */
end_comment

begin_function
name|int
name|ichsmb_attach
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
specifier|const
name|sc_p
name|sc
init|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
decl_stmt|;
name|int
name|error
decl_stmt|;
comment|/* Create mutex */
name|mtx_init
argument_list|(
operator|&
name|sc
operator|->
name|mutex
argument_list|,
name|device_get_nameunit
argument_list|(
name|dev
argument_list|)
argument_list|,
literal|"ichsmb"
argument_list|,
name|MTX_DEF
argument_list|)
expr_stmt|;
comment|/* Add child: an instance of the "smbus" device */
if|if
condition|(
operator|(
name|sc
operator|->
name|smb
operator|=
name|device_add_child
argument_list|(
name|dev
argument_list|,
name|DRIVER_SMBUS
argument_list|,
operator|-
literal|1
argument_list|)
operator|)
operator|==
name|NULL
condition|)
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"no \"%s\" child found\n"
argument_list|,
name|DRIVER_SMBUS
argument_list|)
expr_stmt|;
name|error
operator|=
name|ENXIO
expr_stmt|;
goto|goto
name|fail
goto|;
block|}
comment|/* Clear interrupt conditions */
name|bus_space_write_1
argument_list|(
name|sc
operator|->
name|io_bst
argument_list|,
name|sc
operator|->
name|io_bsh
argument_list|,
name|ICH_HST_STA
argument_list|,
literal|0xff
argument_list|)
expr_stmt|;
comment|/* Set up interrupt handler */
name|error
operator|=
name|bus_setup_intr
argument_list|(
name|dev
argument_list|,
name|sc
operator|->
name|irq_res
argument_list|,
name|INTR_TYPE_MISC
argument_list|,
name|NULL
argument_list|,
name|ichsmb_device_intr
argument_list|,
name|sc
argument_list|,
operator|&
name|sc
operator|->
name|irq_handle
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|!=
literal|0
condition|)
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"can't setup irq\n"
argument_list|)
expr_stmt|;
goto|goto
name|fail
goto|;
block|}
comment|/* Attach "smbus" child */
if|if
condition|(
operator|(
name|error
operator|=
name|bus_generic_attach
argument_list|(
name|dev
argument_list|)
operator|)
operator|!=
literal|0
condition|)
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"failed to attach child: %d\n"
argument_list|,
name|error
argument_list|)
expr_stmt|;
goto|goto
name|fail
goto|;
block|}
return|return
operator|(
literal|0
operator|)
return|;
name|fail
label|:
name|mtx_destroy
argument_list|(
operator|&
name|sc
operator|->
name|mutex
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
end_function

begin_comment
comment|/******************************************************************** 			SMBUS METHODS ********************************************************************/
end_comment

begin_function
name|int
name|ichsmb_callback
parameter_list|(
name|device_t
name|dev
parameter_list|,
name|int
name|index
parameter_list|,
name|void
modifier|*
name|data
parameter_list|)
block|{
name|int
name|smb_error
init|=
literal|0
decl_stmt|;
name|DBG
argument_list|(
literal|"index=%d how=%d\n"
argument_list|,
name|index
argument_list|,
name|data
condition|?
operator|*
operator|(
name|int
operator|*
operator|)
name|data
else|:
operator|-
literal|1
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|index
condition|)
block|{
case|case
name|SMB_REQUEST_BUS
case|:
break|break;
case|case
name|SMB_RELEASE_BUS
case|:
break|break;
default|default:
name|smb_error
operator|=
name|SMB_EABORT
expr_stmt|;
comment|/* XXX */
break|break;
block|}
name|DBG
argument_list|(
literal|"smb_error=%d\n"
argument_list|,
name|smb_error
argument_list|)
expr_stmt|;
return|return
operator|(
name|smb_error
operator|)
return|;
block|}
end_function

begin_function
name|int
name|ichsmb_quick
parameter_list|(
name|device_t
name|dev
parameter_list|,
name|u_char
name|slave
parameter_list|,
name|int
name|how
parameter_list|)
block|{
specifier|const
name|sc_p
name|sc
init|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
decl_stmt|;
name|int
name|smb_error
decl_stmt|;
name|DBG
argument_list|(
literal|"slave=0x%02x how=%d\n"
argument_list|,
name|slave
argument_list|,
name|how
argument_list|)
expr_stmt|;
name|KASSERT
argument_list|(
name|sc
operator|->
name|ich_cmd
operator|==
operator|-
literal|1
argument_list|,
operator|(
literal|"%s: ich_cmd=%d\n"
operator|,
name|__func__
operator|,
name|sc
operator|->
name|ich_cmd
operator|)
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|how
condition|)
block|{
case|case
name|SMB_QREAD
case|:
case|case
name|SMB_QWRITE
case|:
name|mtx_lock
argument_list|(
operator|&
name|sc
operator|->
name|mutex
argument_list|)
expr_stmt|;
name|sc
operator|->
name|ich_cmd
operator|=
name|ICH_HST_CNT_SMB_CMD_QUICK
expr_stmt|;
name|bus_space_write_1
argument_list|(
name|sc
operator|->
name|io_bst
argument_list|,
name|sc
operator|->
name|io_bsh
argument_list|,
name|ICH_XMIT_SLVA
argument_list|,
operator|(
name|slave
operator|<<
literal|1
operator|)
operator||
operator|(
name|how
operator|==
name|SMB_QREAD
condition|?
name|ICH_XMIT_SLVA_READ
else|:
name|ICH_XMIT_SLVA_WRITE
operator|)
argument_list|)
expr_stmt|;
name|bus_space_write_1
argument_list|(
name|sc
operator|->
name|io_bst
argument_list|,
name|sc
operator|->
name|io_bsh
argument_list|,
name|ICH_HST_CNT
argument_list|,
name|ICH_HST_CNT_START
operator||
name|ICH_HST_CNT_INTREN
operator||
name|sc
operator|->
name|ich_cmd
argument_list|)
expr_stmt|;
name|smb_error
operator|=
name|ichsmb_wait
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|mtx_unlock
argument_list|(
operator|&
name|sc
operator|->
name|mutex
argument_list|)
expr_stmt|;
break|break;
default|default:
name|smb_error
operator|=
name|SMB_ENOTSUPP
expr_stmt|;
block|}
name|DBG
argument_list|(
literal|"smb_error=%d\n"
argument_list|,
name|smb_error
argument_list|)
expr_stmt|;
return|return
operator|(
name|smb_error
operator|)
return|;
block|}
end_function

begin_function
name|int
name|ichsmb_sendb
parameter_list|(
name|device_t
name|dev
parameter_list|,
name|u_char
name|slave
parameter_list|,
name|char
name|byte
parameter_list|)
block|{
specifier|const
name|sc_p
name|sc
init|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
decl_stmt|;
name|int
name|smb_error
decl_stmt|;
name|DBG
argument_list|(
literal|"slave=0x%02x byte=0x%02x\n"
argument_list|,
name|slave
argument_list|,
operator|(
name|u_char
operator|)
name|byte
argument_list|)
expr_stmt|;
name|KASSERT
argument_list|(
name|sc
operator|->
name|ich_cmd
operator|==
operator|-
literal|1
argument_list|,
operator|(
literal|"%s: ich_cmd=%d\n"
operator|,
name|__func__
operator|,
name|sc
operator|->
name|ich_cmd
operator|)
argument_list|)
expr_stmt|;
name|mtx_lock
argument_list|(
operator|&
name|sc
operator|->
name|mutex
argument_list|)
expr_stmt|;
name|sc
operator|->
name|ich_cmd
operator|=
name|ICH_HST_CNT_SMB_CMD_BYTE
expr_stmt|;
name|bus_space_write_1
argument_list|(
name|sc
operator|->
name|io_bst
argument_list|,
name|sc
operator|->
name|io_bsh
argument_list|,
name|ICH_XMIT_SLVA
argument_list|,
operator|(
name|slave
operator|<<
literal|1
operator|)
operator||
name|ICH_XMIT_SLVA_WRITE
argument_list|)
expr_stmt|;
name|bus_space_write_1
argument_list|(
name|sc
operator|->
name|io_bst
argument_list|,
name|sc
operator|->
name|io_bsh
argument_list|,
name|ICH_HST_CMD
argument_list|,
name|byte
argument_list|)
expr_stmt|;
name|bus_space_write_1
argument_list|(
name|sc
operator|->
name|io_bst
argument_list|,
name|sc
operator|->
name|io_bsh
argument_list|,
name|ICH_HST_CNT
argument_list|,
name|ICH_HST_CNT_START
operator||
name|ICH_HST_CNT_INTREN
operator||
name|sc
operator|->
name|ich_cmd
argument_list|)
expr_stmt|;
name|smb_error
operator|=
name|ichsmb_wait
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|mtx_unlock
argument_list|(
operator|&
name|sc
operator|->
name|mutex
argument_list|)
expr_stmt|;
name|DBG
argument_list|(
literal|"smb_error=%d\n"
argument_list|,
name|smb_error
argument_list|)
expr_stmt|;
return|return
operator|(
name|smb_error
operator|)
return|;
block|}
end_function

begin_function
name|int
name|ichsmb_recvb
parameter_list|(
name|device_t
name|dev
parameter_list|,
name|u_char
name|slave
parameter_list|,
name|char
modifier|*
name|byte
parameter_list|)
block|{
specifier|const
name|sc_p
name|sc
init|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
decl_stmt|;
name|int
name|smb_error
decl_stmt|;
name|DBG
argument_list|(
literal|"slave=0x%02x\n"
argument_list|,
name|slave
argument_list|)
expr_stmt|;
name|KASSERT
argument_list|(
name|sc
operator|->
name|ich_cmd
operator|==
operator|-
literal|1
argument_list|,
operator|(
literal|"%s: ich_cmd=%d\n"
operator|,
name|__func__
operator|,
name|sc
operator|->
name|ich_cmd
operator|)
argument_list|)
expr_stmt|;
name|mtx_lock
argument_list|(
operator|&
name|sc
operator|->
name|mutex
argument_list|)
expr_stmt|;
name|sc
operator|->
name|ich_cmd
operator|=
name|ICH_HST_CNT_SMB_CMD_BYTE
expr_stmt|;
name|bus_space_write_1
argument_list|(
name|sc
operator|->
name|io_bst
argument_list|,
name|sc
operator|->
name|io_bsh
argument_list|,
name|ICH_XMIT_SLVA
argument_list|,
operator|(
name|slave
operator|<<
literal|1
operator|)
operator||
name|ICH_XMIT_SLVA_READ
argument_list|)
expr_stmt|;
name|bus_space_write_1
argument_list|(
name|sc
operator|->
name|io_bst
argument_list|,
name|sc
operator|->
name|io_bsh
argument_list|,
name|ICH_HST_CNT
argument_list|,
name|ICH_HST_CNT_START
operator||
name|ICH_HST_CNT_INTREN
operator||
name|sc
operator|->
name|ich_cmd
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|smb_error
operator|=
name|ichsmb_wait
argument_list|(
name|sc
argument_list|)
operator|)
operator|==
name|SMB_ENOERR
condition|)
operator|*
name|byte
operator|=
name|bus_space_read_1
argument_list|(
name|sc
operator|->
name|io_bst
argument_list|,
name|sc
operator|->
name|io_bsh
argument_list|,
name|ICH_D0
argument_list|)
expr_stmt|;
name|mtx_unlock
argument_list|(
operator|&
name|sc
operator|->
name|mutex
argument_list|)
expr_stmt|;
name|DBG
argument_list|(
literal|"smb_error=%d byte=0x%02x\n"
argument_list|,
name|smb_error
argument_list|,
operator|(
name|u_char
operator|)
operator|*
name|byte
argument_list|)
expr_stmt|;
return|return
operator|(
name|smb_error
operator|)
return|;
block|}
end_function

begin_function
name|int
name|ichsmb_writeb
parameter_list|(
name|device_t
name|dev
parameter_list|,
name|u_char
name|slave
parameter_list|,
name|char
name|cmd
parameter_list|,
name|char
name|byte
parameter_list|)
block|{
specifier|const
name|sc_p
name|sc
init|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
decl_stmt|;
name|int
name|smb_error
decl_stmt|;
name|DBG
argument_list|(
literal|"slave=0x%02x cmd=0x%02x byte=0x%02x\n"
argument_list|,
name|slave
argument_list|,
operator|(
name|u_char
operator|)
name|cmd
argument_list|,
operator|(
name|u_char
operator|)
name|byte
argument_list|)
expr_stmt|;
name|KASSERT
argument_list|(
name|sc
operator|->
name|ich_cmd
operator|==
operator|-
literal|1
argument_list|,
operator|(
literal|"%s: ich_cmd=%d\n"
operator|,
name|__func__
operator|,
name|sc
operator|->
name|ich_cmd
operator|)
argument_list|)
expr_stmt|;
name|mtx_lock
argument_list|(
operator|&
name|sc
operator|->
name|mutex
argument_list|)
expr_stmt|;
name|sc
operator|->
name|ich_cmd
operator|=
name|ICH_HST_CNT_SMB_CMD_BYTE_DATA
expr_stmt|;
name|bus_space_write_1
argument_list|(
name|sc
operator|->
name|io_bst
argument_list|,
name|sc
operator|->
name|io_bsh
argument_list|,
name|ICH_XMIT_SLVA
argument_list|,
operator|(
name|slave
operator|<<
literal|1
operator|)
operator||
name|ICH_XMIT_SLVA_WRITE
argument_list|)
expr_stmt|;
name|bus_space_write_1
argument_list|(
name|sc
operator|->
name|io_bst
argument_list|,
name|sc
operator|->
name|io_bsh
argument_list|,
name|ICH_HST_CMD
argument_list|,
name|cmd
argument_list|)
expr_stmt|;
name|bus_space_write_1
argument_list|(
name|sc
operator|->
name|io_bst
argument_list|,
name|sc
operator|->
name|io_bsh
argument_list|,
name|ICH_D0
argument_list|,
name|byte
argument_list|)
expr_stmt|;
name|bus_space_write_1
argument_list|(
name|sc
operator|->
name|io_bst
argument_list|,
name|sc
operator|->
name|io_bsh
argument_list|,
name|ICH_HST_CNT
argument_list|,
name|ICH_HST_CNT_START
operator||
name|ICH_HST_CNT_INTREN
operator||
name|sc
operator|->
name|ich_cmd
argument_list|)
expr_stmt|;
name|smb_error
operator|=
name|ichsmb_wait
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|mtx_unlock
argument_list|(
operator|&
name|sc
operator|->
name|mutex
argument_list|)
expr_stmt|;
name|DBG
argument_list|(
literal|"smb_error=%d\n"
argument_list|,
name|smb_error
argument_list|)
expr_stmt|;
return|return
operator|(
name|smb_error
operator|)
return|;
block|}
end_function

begin_function
name|int
name|ichsmb_writew
parameter_list|(
name|device_t
name|dev
parameter_list|,
name|u_char
name|slave
parameter_list|,
name|char
name|cmd
parameter_list|,
name|short
name|word
parameter_list|)
block|{
specifier|const
name|sc_p
name|sc
init|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
decl_stmt|;
name|int
name|smb_error
decl_stmt|;
name|DBG
argument_list|(
literal|"slave=0x%02x cmd=0x%02x word=0x%04x\n"
argument_list|,
name|slave
argument_list|,
operator|(
name|u_char
operator|)
name|cmd
argument_list|,
operator|(
name|u_int16_t
operator|)
name|word
argument_list|)
expr_stmt|;
name|KASSERT
argument_list|(
name|sc
operator|->
name|ich_cmd
operator|==
operator|-
literal|1
argument_list|,
operator|(
literal|"%s: ich_cmd=%d\n"
operator|,
name|__func__
operator|,
name|sc
operator|->
name|ich_cmd
operator|)
argument_list|)
expr_stmt|;
name|mtx_lock
argument_list|(
operator|&
name|sc
operator|->
name|mutex
argument_list|)
expr_stmt|;
name|sc
operator|->
name|ich_cmd
operator|=
name|ICH_HST_CNT_SMB_CMD_WORD_DATA
expr_stmt|;
name|bus_space_write_1
argument_list|(
name|sc
operator|->
name|io_bst
argument_list|,
name|sc
operator|->
name|io_bsh
argument_list|,
name|ICH_XMIT_SLVA
argument_list|,
operator|(
name|slave
operator|<<
literal|1
operator|)
operator||
name|ICH_XMIT_SLVA_WRITE
argument_list|)
expr_stmt|;
name|bus_space_write_1
argument_list|(
name|sc
operator|->
name|io_bst
argument_list|,
name|sc
operator|->
name|io_bsh
argument_list|,
name|ICH_HST_CMD
argument_list|,
name|cmd
argument_list|)
expr_stmt|;
name|bus_space_write_1
argument_list|(
name|sc
operator|->
name|io_bst
argument_list|,
name|sc
operator|->
name|io_bsh
argument_list|,
name|ICH_D0
argument_list|,
name|word
operator|&
literal|0xff
argument_list|)
expr_stmt|;
name|bus_space_write_1
argument_list|(
name|sc
operator|->
name|io_bst
argument_list|,
name|sc
operator|->
name|io_bsh
argument_list|,
name|ICH_D1
argument_list|,
name|word
operator|>>
literal|8
argument_list|)
expr_stmt|;
name|bus_space_write_1
argument_list|(
name|sc
operator|->
name|io_bst
argument_list|,
name|sc
operator|->
name|io_bsh
argument_list|,
name|ICH_HST_CNT
argument_list|,
name|ICH_HST_CNT_START
operator||
name|ICH_HST_CNT_INTREN
operator||
name|sc
operator|->
name|ich_cmd
argument_list|)
expr_stmt|;
name|smb_error
operator|=
name|ichsmb_wait
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|mtx_unlock
argument_list|(
operator|&
name|sc
operator|->
name|mutex
argument_list|)
expr_stmt|;
name|DBG
argument_list|(
literal|"smb_error=%d\n"
argument_list|,
name|smb_error
argument_list|)
expr_stmt|;
return|return
operator|(
name|smb_error
operator|)
return|;
block|}
end_function

begin_function
name|int
name|ichsmb_readb
parameter_list|(
name|device_t
name|dev
parameter_list|,
name|u_char
name|slave
parameter_list|,
name|char
name|cmd
parameter_list|,
name|char
modifier|*
name|byte
parameter_list|)
block|{
specifier|const
name|sc_p
name|sc
init|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
decl_stmt|;
name|int
name|smb_error
decl_stmt|;
name|DBG
argument_list|(
literal|"slave=0x%02x cmd=0x%02x\n"
argument_list|,
name|slave
argument_list|,
operator|(
name|u_char
operator|)
name|cmd
argument_list|)
expr_stmt|;
name|KASSERT
argument_list|(
name|sc
operator|->
name|ich_cmd
operator|==
operator|-
literal|1
argument_list|,
operator|(
literal|"%s: ich_cmd=%d\n"
operator|,
name|__func__
operator|,
name|sc
operator|->
name|ich_cmd
operator|)
argument_list|)
expr_stmt|;
name|mtx_lock
argument_list|(
operator|&
name|sc
operator|->
name|mutex
argument_list|)
expr_stmt|;
name|sc
operator|->
name|ich_cmd
operator|=
name|ICH_HST_CNT_SMB_CMD_BYTE_DATA
expr_stmt|;
name|bus_space_write_1
argument_list|(
name|sc
operator|->
name|io_bst
argument_list|,
name|sc
operator|->
name|io_bsh
argument_list|,
name|ICH_XMIT_SLVA
argument_list|,
operator|(
name|slave
operator|<<
literal|1
operator|)
operator||
name|ICH_XMIT_SLVA_READ
argument_list|)
expr_stmt|;
name|bus_space_write_1
argument_list|(
name|sc
operator|->
name|io_bst
argument_list|,
name|sc
operator|->
name|io_bsh
argument_list|,
name|ICH_HST_CMD
argument_list|,
name|cmd
argument_list|)
expr_stmt|;
name|bus_space_write_1
argument_list|(
name|sc
operator|->
name|io_bst
argument_list|,
name|sc
operator|->
name|io_bsh
argument_list|,
name|ICH_HST_CNT
argument_list|,
name|ICH_HST_CNT_START
operator||
name|ICH_HST_CNT_INTREN
operator||
name|sc
operator|->
name|ich_cmd
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|smb_error
operator|=
name|ichsmb_wait
argument_list|(
name|sc
argument_list|)
operator|)
operator|==
name|SMB_ENOERR
condition|)
operator|*
name|byte
operator|=
name|bus_space_read_1
argument_list|(
name|sc
operator|->
name|io_bst
argument_list|,
name|sc
operator|->
name|io_bsh
argument_list|,
name|ICH_D0
argument_list|)
expr_stmt|;
name|mtx_unlock
argument_list|(
operator|&
name|sc
operator|->
name|mutex
argument_list|)
expr_stmt|;
name|DBG
argument_list|(
literal|"smb_error=%d byte=0x%02x\n"
argument_list|,
name|smb_error
argument_list|,
operator|(
name|u_char
operator|)
operator|*
name|byte
argument_list|)
expr_stmt|;
return|return
operator|(
name|smb_error
operator|)
return|;
block|}
end_function

begin_function
name|int
name|ichsmb_readw
parameter_list|(
name|device_t
name|dev
parameter_list|,
name|u_char
name|slave
parameter_list|,
name|char
name|cmd
parameter_list|,
name|short
modifier|*
name|word
parameter_list|)
block|{
specifier|const
name|sc_p
name|sc
init|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
decl_stmt|;
name|int
name|smb_error
decl_stmt|;
name|DBG
argument_list|(
literal|"slave=0x%02x cmd=0x%02x\n"
argument_list|,
name|slave
argument_list|,
operator|(
name|u_char
operator|)
name|cmd
argument_list|)
expr_stmt|;
name|KASSERT
argument_list|(
name|sc
operator|->
name|ich_cmd
operator|==
operator|-
literal|1
argument_list|,
operator|(
literal|"%s: ich_cmd=%d\n"
operator|,
name|__func__
operator|,
name|sc
operator|->
name|ich_cmd
operator|)
argument_list|)
expr_stmt|;
name|mtx_lock
argument_list|(
operator|&
name|sc
operator|->
name|mutex
argument_list|)
expr_stmt|;
name|sc
operator|->
name|ich_cmd
operator|=
name|ICH_HST_CNT_SMB_CMD_WORD_DATA
expr_stmt|;
name|bus_space_write_1
argument_list|(
name|sc
operator|->
name|io_bst
argument_list|,
name|sc
operator|->
name|io_bsh
argument_list|,
name|ICH_XMIT_SLVA
argument_list|,
operator|(
name|slave
operator|<<
literal|1
operator|)
operator||
name|ICH_XMIT_SLVA_READ
argument_list|)
expr_stmt|;
name|bus_space_write_1
argument_list|(
name|sc
operator|->
name|io_bst
argument_list|,
name|sc
operator|->
name|io_bsh
argument_list|,
name|ICH_HST_CMD
argument_list|,
name|cmd
argument_list|)
expr_stmt|;
name|bus_space_write_1
argument_list|(
name|sc
operator|->
name|io_bst
argument_list|,
name|sc
operator|->
name|io_bsh
argument_list|,
name|ICH_HST_CNT
argument_list|,
name|ICH_HST_CNT_START
operator||
name|ICH_HST_CNT_INTREN
operator||
name|sc
operator|->
name|ich_cmd
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|smb_error
operator|=
name|ichsmb_wait
argument_list|(
name|sc
argument_list|)
operator|)
operator|==
name|SMB_ENOERR
condition|)
block|{
operator|*
name|word
operator|=
operator|(
name|bus_space_read_1
argument_list|(
name|sc
operator|->
name|io_bst
argument_list|,
name|sc
operator|->
name|io_bsh
argument_list|,
name|ICH_D0
argument_list|)
operator|&
literal|0xff
operator|)
operator||
operator|(
name|bus_space_read_1
argument_list|(
name|sc
operator|->
name|io_bst
argument_list|,
name|sc
operator|->
name|io_bsh
argument_list|,
name|ICH_D1
argument_list|)
operator|<<
literal|8
operator|)
expr_stmt|;
block|}
name|mtx_unlock
argument_list|(
operator|&
name|sc
operator|->
name|mutex
argument_list|)
expr_stmt|;
name|DBG
argument_list|(
literal|"smb_error=%d word=0x%04x\n"
argument_list|,
name|smb_error
argument_list|,
operator|(
name|u_int16_t
operator|)
operator|*
name|word
argument_list|)
expr_stmt|;
return|return
operator|(
name|smb_error
operator|)
return|;
block|}
end_function

begin_function
name|int
name|ichsmb_pcall
parameter_list|(
name|device_t
name|dev
parameter_list|,
name|u_char
name|slave
parameter_list|,
name|char
name|cmd
parameter_list|,
name|short
name|sdata
parameter_list|,
name|short
modifier|*
name|rdata
parameter_list|)
block|{
specifier|const
name|sc_p
name|sc
init|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
decl_stmt|;
name|int
name|smb_error
decl_stmt|;
name|DBG
argument_list|(
literal|"slave=0x%02x cmd=0x%02x sdata=0x%04x\n"
argument_list|,
name|slave
argument_list|,
operator|(
name|u_char
operator|)
name|cmd
argument_list|,
operator|(
name|u_int16_t
operator|)
name|sdata
argument_list|)
expr_stmt|;
name|KASSERT
argument_list|(
name|sc
operator|->
name|ich_cmd
operator|==
operator|-
literal|1
argument_list|,
operator|(
literal|"%s: ich_cmd=%d\n"
operator|,
name|__func__
operator|,
name|sc
operator|->
name|ich_cmd
operator|)
argument_list|)
expr_stmt|;
name|mtx_lock
argument_list|(
operator|&
name|sc
operator|->
name|mutex
argument_list|)
expr_stmt|;
name|sc
operator|->
name|ich_cmd
operator|=
name|ICH_HST_CNT_SMB_CMD_PROC_CALL
expr_stmt|;
name|bus_space_write_1
argument_list|(
name|sc
operator|->
name|io_bst
argument_list|,
name|sc
operator|->
name|io_bsh
argument_list|,
name|ICH_XMIT_SLVA
argument_list|,
operator|(
name|slave
operator|<<
literal|1
operator|)
operator||
name|ICH_XMIT_SLVA_WRITE
argument_list|)
expr_stmt|;
name|bus_space_write_1
argument_list|(
name|sc
operator|->
name|io_bst
argument_list|,
name|sc
operator|->
name|io_bsh
argument_list|,
name|ICH_HST_CMD
argument_list|,
name|cmd
argument_list|)
expr_stmt|;
name|bus_space_write_1
argument_list|(
name|sc
operator|->
name|io_bst
argument_list|,
name|sc
operator|->
name|io_bsh
argument_list|,
name|ICH_D0
argument_list|,
name|sdata
operator|&
literal|0xff
argument_list|)
expr_stmt|;
name|bus_space_write_1
argument_list|(
name|sc
operator|->
name|io_bst
argument_list|,
name|sc
operator|->
name|io_bsh
argument_list|,
name|ICH_D1
argument_list|,
name|sdata
operator|>>
literal|8
argument_list|)
expr_stmt|;
name|bus_space_write_1
argument_list|(
name|sc
operator|->
name|io_bst
argument_list|,
name|sc
operator|->
name|io_bsh
argument_list|,
name|ICH_HST_CNT
argument_list|,
name|ICH_HST_CNT_START
operator||
name|ICH_HST_CNT_INTREN
operator||
name|sc
operator|->
name|ich_cmd
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|smb_error
operator|=
name|ichsmb_wait
argument_list|(
name|sc
argument_list|)
operator|)
operator|==
name|SMB_ENOERR
condition|)
block|{
operator|*
name|rdata
operator|=
operator|(
name|bus_space_read_1
argument_list|(
name|sc
operator|->
name|io_bst
argument_list|,
name|sc
operator|->
name|io_bsh
argument_list|,
name|ICH_D0
argument_list|)
operator|&
literal|0xff
operator|)
operator||
operator|(
name|bus_space_read_1
argument_list|(
name|sc
operator|->
name|io_bst
argument_list|,
name|sc
operator|->
name|io_bsh
argument_list|,
name|ICH_D1
argument_list|)
operator|<<
literal|8
operator|)
expr_stmt|;
block|}
name|mtx_unlock
argument_list|(
operator|&
name|sc
operator|->
name|mutex
argument_list|)
expr_stmt|;
name|DBG
argument_list|(
literal|"smb_error=%d rdata=0x%04x\n"
argument_list|,
name|smb_error
argument_list|,
operator|(
name|u_int16_t
operator|)
operator|*
name|rdata
argument_list|)
expr_stmt|;
return|return
operator|(
name|smb_error
operator|)
return|;
block|}
end_function

begin_function
name|int
name|ichsmb_bwrite
parameter_list|(
name|device_t
name|dev
parameter_list|,
name|u_char
name|slave
parameter_list|,
name|char
name|cmd
parameter_list|,
name|u_char
name|count
parameter_list|,
name|char
modifier|*
name|buf
parameter_list|)
block|{
specifier|const
name|sc_p
name|sc
init|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
decl_stmt|;
name|int
name|smb_error
decl_stmt|;
name|DBG
argument_list|(
literal|"slave=0x%02x cmd=0x%02x count=%d\n"
argument_list|,
name|slave
argument_list|,
operator|(
name|u_char
operator|)
name|cmd
argument_list|,
name|count
argument_list|)
expr_stmt|;
if|#
directive|if
name|ICHSMB_DEBUG
define|#
directive|define
name|DISP
parameter_list|(
name|ch
parameter_list|)
value|(((ch)< 0x20 || (ch)>= 0x7e) ? '.' : (ch))
block|{
name|u_char
modifier|*
name|p
decl_stmt|;
for|for
control|(
name|p
operator|=
operator|(
name|u_char
operator|*
operator|)
name|buf
init|;
name|p
operator|-
operator|(
name|u_char
operator|*
operator|)
name|buf
operator|<
literal|32
condition|;
name|p
operator|+=
literal|8
control|)
block|{
name|DBG
argument_list|(
literal|"%02x: %02x %02x %02x %02x %02x %02x %02x %02x"
literal|"  %c%c%c%c%c%c%c%c"
argument_list|,
operator|(
name|p
operator|-
operator|(
name|u_char
operator|*
operator|)
name|buf
operator|)
argument_list|,
name|p
index|[
literal|0
index|]
argument_list|,
name|p
index|[
literal|1
index|]
argument_list|,
name|p
index|[
literal|2
index|]
argument_list|,
name|p
index|[
literal|3
index|]
argument_list|,
name|p
index|[
literal|4
index|]
argument_list|,
name|p
index|[
literal|5
index|]
argument_list|,
name|p
index|[
literal|6
index|]
argument_list|,
name|p
index|[
literal|7
index|]
argument_list|,
name|DISP
argument_list|(
name|p
index|[
literal|0
index|]
argument_list|)
argument_list|,
name|DISP
argument_list|(
name|p
index|[
literal|1
index|]
argument_list|)
argument_list|,
name|DISP
argument_list|(
name|p
index|[
literal|2
index|]
argument_list|)
argument_list|,
name|DISP
argument_list|(
name|p
index|[
literal|3
index|]
argument_list|)
argument_list|,
name|DISP
argument_list|(
name|p
index|[
literal|4
index|]
argument_list|)
argument_list|,
name|DISP
argument_list|(
name|p
index|[
literal|5
index|]
argument_list|)
argument_list|,
name|DISP
argument_list|(
name|p
index|[
literal|6
index|]
argument_list|)
argument_list|,
name|DISP
argument_list|(
name|p
index|[
literal|7
index|]
argument_list|)
argument_list|)
expr_stmt|;
block|}
block|}
undef|#
directive|undef
name|DISP
endif|#
directive|endif
name|KASSERT
argument_list|(
name|sc
operator|->
name|ich_cmd
operator|==
operator|-
literal|1
argument_list|,
operator|(
literal|"%s: ich_cmd=%d\n"
operator|,
name|__func__
operator|,
name|sc
operator|->
name|ich_cmd
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|count
operator|<
literal|1
operator|||
name|count
operator|>
literal|32
condition|)
return|return
operator|(
name|SMB_EINVAL
operator|)
return|;
name|bcopy
argument_list|(
name|buf
argument_list|,
name|sc
operator|->
name|block_data
argument_list|,
name|count
argument_list|)
expr_stmt|;
name|sc
operator|->
name|block_count
operator|=
name|count
expr_stmt|;
name|sc
operator|->
name|block_index
operator|=
literal|1
expr_stmt|;
name|sc
operator|->
name|block_write
operator|=
literal|1
expr_stmt|;
name|mtx_lock
argument_list|(
operator|&
name|sc
operator|->
name|mutex
argument_list|)
expr_stmt|;
name|sc
operator|->
name|ich_cmd
operator|=
name|ICH_HST_CNT_SMB_CMD_BLOCK
expr_stmt|;
name|bus_space_write_1
argument_list|(
name|sc
operator|->
name|io_bst
argument_list|,
name|sc
operator|->
name|io_bsh
argument_list|,
name|ICH_XMIT_SLVA
argument_list|,
operator|(
name|slave
operator|<<
literal|1
operator|)
operator||
name|ICH_XMIT_SLVA_WRITE
argument_list|)
expr_stmt|;
name|bus_space_write_1
argument_list|(
name|sc
operator|->
name|io_bst
argument_list|,
name|sc
operator|->
name|io_bsh
argument_list|,
name|ICH_HST_CMD
argument_list|,
name|cmd
argument_list|)
expr_stmt|;
name|bus_space_write_1
argument_list|(
name|sc
operator|->
name|io_bst
argument_list|,
name|sc
operator|->
name|io_bsh
argument_list|,
name|ICH_D0
argument_list|,
name|count
argument_list|)
expr_stmt|;
name|bus_space_write_1
argument_list|(
name|sc
operator|->
name|io_bst
argument_list|,
name|sc
operator|->
name|io_bsh
argument_list|,
name|ICH_BLOCK_DB
argument_list|,
name|buf
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
name|bus_space_write_1
argument_list|(
name|sc
operator|->
name|io_bst
argument_list|,
name|sc
operator|->
name|io_bsh
argument_list|,
name|ICH_HST_CNT
argument_list|,
name|ICH_HST_CNT_START
operator||
name|ICH_HST_CNT_INTREN
operator||
name|sc
operator|->
name|ich_cmd
argument_list|)
expr_stmt|;
name|smb_error
operator|=
name|ichsmb_wait
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|mtx_unlock
argument_list|(
operator|&
name|sc
operator|->
name|mutex
argument_list|)
expr_stmt|;
name|DBG
argument_list|(
literal|"smb_error=%d\n"
argument_list|,
name|smb_error
argument_list|)
expr_stmt|;
return|return
operator|(
name|smb_error
operator|)
return|;
block|}
end_function

begin_function
name|int
name|ichsmb_bread
parameter_list|(
name|device_t
name|dev
parameter_list|,
name|u_char
name|slave
parameter_list|,
name|char
name|cmd
parameter_list|,
name|u_char
modifier|*
name|count
parameter_list|,
name|char
modifier|*
name|buf
parameter_list|)
block|{
specifier|const
name|sc_p
name|sc
init|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
decl_stmt|;
name|int
name|smb_error
decl_stmt|;
name|DBG
argument_list|(
literal|"slave=0x%02x cmd=0x%02x count=%d\n"
argument_list|,
name|slave
argument_list|,
operator|(
name|u_char
operator|)
name|cmd
argument_list|,
name|count
argument_list|)
expr_stmt|;
name|KASSERT
argument_list|(
name|sc
operator|->
name|ich_cmd
operator|==
operator|-
literal|1
argument_list|,
operator|(
literal|"%s: ich_cmd=%d\n"
operator|,
name|__func__
operator|,
name|sc
operator|->
name|ich_cmd
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|*
name|count
operator|<
literal|1
operator|||
operator|*
name|count
operator|>
literal|32
condition|)
return|return
operator|(
name|SMB_EINVAL
operator|)
return|;
name|bzero
argument_list|(
name|sc
operator|->
name|block_data
argument_list|,
sizeof|sizeof
argument_list|(
name|sc
operator|->
name|block_data
argument_list|)
argument_list|)
expr_stmt|;
name|sc
operator|->
name|block_count
operator|=
literal|0
expr_stmt|;
name|sc
operator|->
name|block_index
operator|=
literal|0
expr_stmt|;
name|sc
operator|->
name|block_write
operator|=
literal|0
expr_stmt|;
name|mtx_lock
argument_list|(
operator|&
name|sc
operator|->
name|mutex
argument_list|)
expr_stmt|;
name|sc
operator|->
name|ich_cmd
operator|=
name|ICH_HST_CNT_SMB_CMD_BLOCK
expr_stmt|;
name|bus_space_write_1
argument_list|(
name|sc
operator|->
name|io_bst
argument_list|,
name|sc
operator|->
name|io_bsh
argument_list|,
name|ICH_XMIT_SLVA
argument_list|,
operator|(
name|slave
operator|<<
literal|1
operator|)
operator||
name|ICH_XMIT_SLVA_READ
argument_list|)
expr_stmt|;
name|bus_space_write_1
argument_list|(
name|sc
operator|->
name|io_bst
argument_list|,
name|sc
operator|->
name|io_bsh
argument_list|,
name|ICH_HST_CMD
argument_list|,
name|cmd
argument_list|)
expr_stmt|;
name|bus_space_write_1
argument_list|(
name|sc
operator|->
name|io_bst
argument_list|,
name|sc
operator|->
name|io_bsh
argument_list|,
name|ICH_D0
argument_list|,
operator|*
name|count
argument_list|)
expr_stmt|;
comment|/* XXX? */
name|bus_space_write_1
argument_list|(
name|sc
operator|->
name|io_bst
argument_list|,
name|sc
operator|->
name|io_bsh
argument_list|,
name|ICH_HST_CNT
argument_list|,
name|ICH_HST_CNT_START
operator||
name|ICH_HST_CNT_INTREN
operator||
name|sc
operator|->
name|ich_cmd
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|smb_error
operator|=
name|ichsmb_wait
argument_list|(
name|sc
argument_list|)
operator|)
operator|==
name|SMB_ENOERR
condition|)
block|{
name|bcopy
argument_list|(
name|sc
operator|->
name|block_data
argument_list|,
name|buf
argument_list|,
name|min
argument_list|(
name|sc
operator|->
name|block_count
argument_list|,
operator|*
name|count
argument_list|)
argument_list|)
expr_stmt|;
operator|*
name|count
operator|=
name|sc
operator|->
name|block_count
expr_stmt|;
block|}
name|mtx_unlock
argument_list|(
operator|&
name|sc
operator|->
name|mutex
argument_list|)
expr_stmt|;
name|DBG
argument_list|(
literal|"smb_error=%d\n"
argument_list|,
name|smb_error
argument_list|)
expr_stmt|;
if|#
directive|if
name|ICHSMB_DEBUG
define|#
directive|define
name|DISP
parameter_list|(
name|ch
parameter_list|)
value|(((ch)< 0x20 || (ch)>= 0x7e) ? '.' : (ch))
block|{
name|u_char
modifier|*
name|p
decl_stmt|;
for|for
control|(
name|p
operator|=
operator|(
name|u_char
operator|*
operator|)
name|buf
init|;
name|p
operator|-
operator|(
name|u_char
operator|*
operator|)
name|buf
operator|<
literal|32
condition|;
name|p
operator|+=
literal|8
control|)
block|{
name|DBG
argument_list|(
literal|"%02x: %02x %02x %02x %02x %02x %02x %02x %02x"
literal|"  %c%c%c%c%c%c%c%c"
argument_list|,
operator|(
name|p
operator|-
operator|(
name|u_char
operator|*
operator|)
name|buf
operator|)
argument_list|,
name|p
index|[
literal|0
index|]
argument_list|,
name|p
index|[
literal|1
index|]
argument_list|,
name|p
index|[
literal|2
index|]
argument_list|,
name|p
index|[
literal|3
index|]
argument_list|,
name|p
index|[
literal|4
index|]
argument_list|,
name|p
index|[
literal|5
index|]
argument_list|,
name|p
index|[
literal|6
index|]
argument_list|,
name|p
index|[
literal|7
index|]
argument_list|,
name|DISP
argument_list|(
name|p
index|[
literal|0
index|]
argument_list|)
argument_list|,
name|DISP
argument_list|(
name|p
index|[
literal|1
index|]
argument_list|)
argument_list|,
name|DISP
argument_list|(
name|p
index|[
literal|2
index|]
argument_list|)
argument_list|,
name|DISP
argument_list|(
name|p
index|[
literal|3
index|]
argument_list|)
argument_list|,
name|DISP
argument_list|(
name|p
index|[
literal|4
index|]
argument_list|)
argument_list|,
name|DISP
argument_list|(
name|p
index|[
literal|5
index|]
argument_list|)
argument_list|,
name|DISP
argument_list|(
name|p
index|[
literal|6
index|]
argument_list|)
argument_list|,
name|DISP
argument_list|(
name|p
index|[
literal|7
index|]
argument_list|)
argument_list|)
expr_stmt|;
block|}
block|}
undef|#
directive|undef
name|DISP
endif|#
directive|endif
return|return
operator|(
name|smb_error
operator|)
return|;
block|}
end_function

begin_comment
comment|/******************************************************************** 			OTHER FUNCTIONS ********************************************************************/
end_comment

begin_comment
comment|/*  * This table describes what interrupts we should ever expect to  * see after each ICH command, not including the SMBALERT interrupt.  */
end_comment

begin_decl_stmt
specifier|static
specifier|const
name|u_int8_t
name|ichsmb_state_irqs
index|[]
init|=
block|{
comment|/* quick */
operator|(
name|ICH_HST_STA_BUS_ERR
operator||
name|ICH_HST_STA_DEV_ERR
operator||
name|ICH_HST_STA_INTR
operator|)
block|,
comment|/* byte */
operator|(
name|ICH_HST_STA_BUS_ERR
operator||
name|ICH_HST_STA_DEV_ERR
operator||
name|ICH_HST_STA_INTR
operator|)
block|,
comment|/* byte data */
operator|(
name|ICH_HST_STA_BUS_ERR
operator||
name|ICH_HST_STA_DEV_ERR
operator||
name|ICH_HST_STA_INTR
operator|)
block|,
comment|/* word data */
operator|(
name|ICH_HST_STA_BUS_ERR
operator||
name|ICH_HST_STA_DEV_ERR
operator||
name|ICH_HST_STA_INTR
operator|)
block|,
comment|/* process call */
operator|(
name|ICH_HST_STA_BUS_ERR
operator||
name|ICH_HST_STA_DEV_ERR
operator||
name|ICH_HST_STA_INTR
operator|)
block|,
comment|/* block */
operator|(
name|ICH_HST_STA_BUS_ERR
operator||
name|ICH_HST_STA_DEV_ERR
operator||
name|ICH_HST_STA_INTR
operator||
name|ICH_HST_STA_BYTE_DONE_STS
operator|)
block|,
comment|/* i2c read (not used) */
operator|(
name|ICH_HST_STA_BUS_ERR
operator||
name|ICH_HST_STA_DEV_ERR
operator||
name|ICH_HST_STA_INTR
operator||
name|ICH_HST_STA_BYTE_DONE_STS
operator|)
block|}
decl_stmt|;
end_decl_stmt

begin_comment
comment|/*  * Interrupt handler. This handler is bus-independent. Note that our  * interrupt may be shared, so we must handle "false" interrupts.  */
end_comment

begin_function
name|void
name|ichsmb_device_intr
parameter_list|(
name|void
modifier|*
name|cookie
parameter_list|)
block|{
specifier|const
name|sc_p
name|sc
init|=
name|cookie
decl_stmt|;
specifier|const
name|device_t
name|dev
init|=
name|sc
operator|->
name|dev
decl_stmt|;
specifier|const
name|int
name|maxloops
init|=
literal|16
decl_stmt|;
name|u_int8_t
name|status
decl_stmt|;
name|u_int8_t
name|ok_bits
decl_stmt|;
name|int
name|cmd_index
decl_stmt|;
name|int
name|count
decl_stmt|;
name|mtx_lock
argument_list|(
operator|&
name|sc
operator|->
name|mutex
argument_list|)
expr_stmt|;
for|for
control|(
name|count
operator|=
literal|0
init|;
name|count
operator|<
name|maxloops
condition|;
name|count
operator|++
control|)
block|{
comment|/* Get and reset status bits */
name|status
operator|=
name|bus_space_read_1
argument_list|(
name|sc
operator|->
name|io_bst
argument_list|,
name|sc
operator|->
name|io_bsh
argument_list|,
name|ICH_HST_STA
argument_list|)
expr_stmt|;
if|#
directive|if
name|ICHSMB_DEBUG
if|if
condition|(
operator|(
name|status
operator|&
operator|~
operator|(
name|ICH_HST_STA_INUSE_STS
operator||
name|ICH_HST_STA_HOST_BUSY
operator|)
operator|)
operator|||
name|count
operator|>
literal|0
condition|)
block|{
name|DBG
argument_list|(
literal|"%d stat=0x%02x\n"
argument_list|,
name|count
argument_list|,
name|status
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
name|status
operator|&=
operator|~
operator|(
name|ICH_HST_STA_INUSE_STS
operator||
name|ICH_HST_STA_HOST_BUSY
operator|)
expr_stmt|;
if|if
condition|(
name|status
operator|==
literal|0
condition|)
break|break;
comment|/* Check for unexpected interrupt */
name|ok_bits
operator|=
name|ICH_HST_STA_SMBALERT_STS
expr_stmt|;
name|cmd_index
operator|=
name|sc
operator|->
name|ich_cmd
operator|>>
literal|2
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|ich_cmd
operator|!=
operator|-
literal|1
condition|)
block|{
name|KASSERT
argument_list|(
name|cmd_index
operator|<
sizeof|sizeof
argument_list|(
name|ichsmb_state_irqs
argument_list|)
argument_list|,
operator|(
literal|"%s: ich_cmd=%d"
operator|,
name|device_get_nameunit
argument_list|(
name|dev
argument_list|)
operator|,
name|sc
operator|->
name|ich_cmd
operator|)
argument_list|)
expr_stmt|;
name|ok_bits
operator||=
name|ichsmb_state_irqs
index|[
name|cmd_index
index|]
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|status
operator|&
operator|~
name|ok_bits
operator|)
operator|!=
literal|0
condition|)
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"irq 0x%02x during %d\n"
argument_list|,
name|status
argument_list|,
name|cmd_index
argument_list|)
expr_stmt|;
name|bus_space_write_1
argument_list|(
name|sc
operator|->
name|io_bst
argument_list|,
name|sc
operator|->
name|io_bsh
argument_list|,
name|ICH_HST_STA
argument_list|,
operator|(
name|status
operator|&
operator|~
name|ok_bits
operator|)
argument_list|)
expr_stmt|;
continue|continue;
block|}
comment|/* Handle SMBALERT interrupt */
if|if
condition|(
name|status
operator|&
name|ICH_HST_STA_SMBALERT_STS
condition|)
block|{
specifier|static
name|int
name|smbalert_count
init|=
literal|16
decl_stmt|;
if|if
condition|(
name|smbalert_count
operator|>
literal|0
condition|)
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"SMBALERT# rec'd\n"
argument_list|)
expr_stmt|;
if|if
condition|(
operator|--
name|smbalert_count
operator|==
literal|0
condition|)
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"not logging anymore\n"
argument_list|)
expr_stmt|;
block|}
block|}
block|}
comment|/* Check for bus error */
if|if
condition|(
name|status
operator|&
name|ICH_HST_STA_BUS_ERR
condition|)
block|{
name|sc
operator|->
name|smb_error
operator|=
name|SMB_ECOLLI
expr_stmt|;
comment|/* XXX SMB_EBUSERR? */
goto|goto
name|finished
goto|;
block|}
comment|/* Check for device error */
if|if
condition|(
name|status
operator|&
name|ICH_HST_STA_DEV_ERR
condition|)
block|{
name|sc
operator|->
name|smb_error
operator|=
name|SMB_ENOACK
expr_stmt|;
comment|/* or SMB_ETIMEOUT? */
goto|goto
name|finished
goto|;
block|}
comment|/* Check for byte completion in block transfer */
if|if
condition|(
name|status
operator|&
name|ICH_HST_STA_BYTE_DONE_STS
condition|)
block|{
if|if
condition|(
name|sc
operator|->
name|block_write
condition|)
block|{
if|if
condition|(
name|sc
operator|->
name|block_index
operator|<
name|sc
operator|->
name|block_count
condition|)
block|{
comment|/* Write next byte */
name|bus_space_write_1
argument_list|(
name|sc
operator|->
name|io_bst
argument_list|,
name|sc
operator|->
name|io_bsh
argument_list|,
name|ICH_BLOCK_DB
argument_list|,
name|sc
operator|->
name|block_data
index|[
name|sc
operator|->
name|block_index
operator|++
index|]
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
comment|/* First interrupt, get the count also */
if|if
condition|(
name|sc
operator|->
name|block_index
operator|==
literal|0
condition|)
block|{
name|sc
operator|->
name|block_count
operator|=
name|bus_space_read_1
argument_list|(
name|sc
operator|->
name|io_bst
argument_list|,
name|sc
operator|->
name|io_bsh
argument_list|,
name|ICH_D0
argument_list|)
expr_stmt|;
block|}
comment|/* Get next byte, if any */
if|if
condition|(
name|sc
operator|->
name|block_index
operator|<
name|sc
operator|->
name|block_count
condition|)
block|{
comment|/* Read next byte */
name|sc
operator|->
name|block_data
index|[
name|sc
operator|->
name|block_index
operator|++
index|]
operator|=
name|bus_space_read_1
argument_list|(
name|sc
operator|->
name|io_bst
argument_list|,
name|sc
operator|->
name|io_bsh
argument_list|,
name|ICH_BLOCK_DB
argument_list|)
expr_stmt|;
comment|/* Set "LAST_BYTE" bit before reading 					   the last byte of block data */
if|if
condition|(
name|sc
operator|->
name|block_index
operator|>=
name|sc
operator|->
name|block_count
operator|-
literal|1
condition|)
block|{
name|bus_space_write_1
argument_list|(
name|sc
operator|->
name|io_bst
argument_list|,
name|sc
operator|->
name|io_bsh
argument_list|,
name|ICH_HST_CNT
argument_list|,
name|ICH_HST_CNT_LAST_BYTE
operator||
name|ICH_HST_CNT_INTREN
operator||
name|sc
operator|->
name|ich_cmd
argument_list|)
expr_stmt|;
block|}
block|}
block|}
block|}
comment|/* Check command completion */
if|if
condition|(
name|status
operator|&
name|ICH_HST_STA_INTR
condition|)
block|{
name|sc
operator|->
name|smb_error
operator|=
name|SMB_ENOERR
expr_stmt|;
name|finished
label|:
name|sc
operator|->
name|ich_cmd
operator|=
operator|-
literal|1
expr_stmt|;
name|bus_space_write_1
argument_list|(
name|sc
operator|->
name|io_bst
argument_list|,
name|sc
operator|->
name|io_bsh
argument_list|,
name|ICH_HST_STA
argument_list|,
name|status
argument_list|)
expr_stmt|;
name|wakeup
argument_list|(
name|sc
argument_list|)
expr_stmt|;
break|break;
block|}
comment|/* Clear status bits and try again */
name|bus_space_write_1
argument_list|(
name|sc
operator|->
name|io_bst
argument_list|,
name|sc
operator|->
name|io_bsh
argument_list|,
name|ICH_HST_STA
argument_list|,
name|status
argument_list|)
expr_stmt|;
block|}
name|mtx_unlock
argument_list|(
operator|&
name|sc
operator|->
name|mutex
argument_list|)
expr_stmt|;
comment|/* Too many loops? */
if|if
condition|(
name|count
operator|==
name|maxloops
condition|)
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"interrupt loop, status=0x%02x\n"
argument_list|,
name|bus_space_read_1
argument_list|(
name|sc
operator|->
name|io_bst
argument_list|,
name|sc
operator|->
name|io_bsh
argument_list|,
name|ICH_HST_STA
argument_list|)
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/*  * Wait for command completion. Assumes mutex is held.  * Returns an SMB_* error code.  */
end_comment

begin_function
specifier|static
name|int
name|ichsmb_wait
parameter_list|(
name|sc_p
name|sc
parameter_list|)
block|{
specifier|const
name|device_t
name|dev
init|=
name|sc
operator|->
name|dev
decl_stmt|;
name|int
name|error
decl_stmt|,
name|smb_error
decl_stmt|;
name|KASSERT
argument_list|(
name|sc
operator|->
name|ich_cmd
operator|!=
operator|-
literal|1
argument_list|,
operator|(
literal|"%s: ich_cmd=%d\n"
operator|,
name|__func__
operator|,
name|sc
operator|->
name|ich_cmd
operator|)
argument_list|)
expr_stmt|;
name|mtx_assert
argument_list|(
operator|&
name|sc
operator|->
name|mutex
argument_list|,
name|MA_OWNED
argument_list|)
expr_stmt|;
name|error
operator|=
name|msleep
argument_list|(
name|sc
argument_list|,
operator|&
name|sc
operator|->
name|mutex
argument_list|,
name|PZERO
argument_list|,
literal|"ichsmb"
argument_list|,
name|hz
operator|/
literal|4
argument_list|)
expr_stmt|;
name|DBG
argument_list|(
literal|"msleep -> %d\n"
argument_list|,
name|error
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|error
condition|)
block|{
case|case
literal|0
case|:
name|smb_error
operator|=
name|sc
operator|->
name|smb_error
expr_stmt|;
break|break;
case|case
name|EWOULDBLOCK
case|:
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"device timeout, status=0x%02x\n"
argument_list|,
name|bus_space_read_1
argument_list|(
name|sc
operator|->
name|io_bst
argument_list|,
name|sc
operator|->
name|io_bsh
argument_list|,
name|ICH_HST_STA
argument_list|)
argument_list|)
expr_stmt|;
name|sc
operator|->
name|ich_cmd
operator|=
operator|-
literal|1
expr_stmt|;
name|smb_error
operator|=
name|SMB_ETIMEOUT
expr_stmt|;
break|break;
default|default:
name|smb_error
operator|=
name|SMB_EABORT
expr_stmt|;
break|break;
block|}
return|return
operator|(
name|smb_error
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Release resources associated with device.  */
end_comment

begin_function
name|void
name|ichsmb_release_resources
parameter_list|(
name|sc_p
name|sc
parameter_list|)
block|{
specifier|const
name|device_t
name|dev
init|=
name|sc
operator|->
name|dev
decl_stmt|;
if|if
condition|(
name|sc
operator|->
name|irq_handle
operator|!=
name|NULL
condition|)
block|{
name|bus_teardown_intr
argument_list|(
name|dev
argument_list|,
name|sc
operator|->
name|irq_res
argument_list|,
name|sc
operator|->
name|irq_handle
argument_list|)
expr_stmt|;
name|sc
operator|->
name|irq_handle
operator|=
name|NULL
expr_stmt|;
block|}
if|if
condition|(
name|sc
operator|->
name|irq_res
operator|!=
name|NULL
condition|)
block|{
name|bus_release_resource
argument_list|(
name|dev
argument_list|,
name|SYS_RES_IRQ
argument_list|,
name|sc
operator|->
name|irq_rid
argument_list|,
name|sc
operator|->
name|irq_res
argument_list|)
expr_stmt|;
name|sc
operator|->
name|irq_res
operator|=
name|NULL
expr_stmt|;
block|}
if|if
condition|(
name|sc
operator|->
name|io_res
operator|!=
name|NULL
condition|)
block|{
name|bus_release_resource
argument_list|(
name|dev
argument_list|,
name|SYS_RES_IOPORT
argument_list|,
name|sc
operator|->
name|io_rid
argument_list|,
name|sc
operator|->
name|io_res
argument_list|)
expr_stmt|;
name|sc
operator|->
name|io_res
operator|=
name|NULL
expr_stmt|;
block|}
block|}
end_function

begin_function
name|int
name|ichsmb_detach
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
specifier|const
name|sc_p
name|sc
init|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
decl_stmt|;
name|int
name|error
decl_stmt|;
name|error
operator|=
name|bus_generic_detach
argument_list|(
name|dev
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
return|return
operator|(
name|error
operator|)
return|;
name|device_delete_child
argument_list|(
name|dev
argument_list|,
name|sc
operator|->
name|smb
argument_list|)
expr_stmt|;
name|ichsmb_release_resources
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|mtx_destroy
argument_list|(
operator|&
name|sc
operator|->
name|mutex
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_expr_stmt
name|DRIVER_MODULE
argument_list|(
name|smbus
argument_list|,
name|ichsmb
argument_list|,
name|smbus_driver
argument_list|,
name|smbus_devclass
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
end_expr_stmt

end_unit


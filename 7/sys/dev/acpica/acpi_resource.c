begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*-  * Copyright (c) 2000 Michael Smith  * Copyright (c) 2000 BSDi  * All rights reserved.  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions  * are met:  * 1. Redistributions of source code must retain the above copyright  *    notice, this list of conditions and the following disclaimer.  * 2. Redistributions in binary form must reproduce the above copyright  *    notice, this list of conditions and the following disclaimer in the  *    documentation and/or other materials provided with the distribution.  *  * THIS SOFTWARE IS PROVIDED BY THE AUTHOR AND CONTRIBUTORS ``AS IS'' AND  * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE  * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE  * ARE DISCLAIMED.  IN NO EVENT SHALL THE AUTHOR OR CONTRIBUTORS BE LIABLE  * FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL  * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS  * OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)  * HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT  * LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY  * OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF  * SUCH DAMAGE.  */
end_comment

begin_include
include|#
directive|include
file|<sys/cdefs.h>
end_include

begin_expr_stmt
name|__FBSDID
argument_list|(
literal|"$FreeBSD$"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_include
include|#
directive|include
file|"opt_acpi.h"
end_include

begin_include
include|#
directive|include
file|<sys/param.h>
end_include

begin_include
include|#
directive|include
file|<sys/kernel.h>
end_include

begin_include
include|#
directive|include
file|<sys/bus.h>
end_include

begin_include
include|#
directive|include
file|<sys/malloc.h>
end_include

begin_include
include|#
directive|include
file|<sys/module.h>
end_include

begin_include
include|#
directive|include
file|<machine/bus.h>
end_include

begin_include
include|#
directive|include
file|<machine/resource.h>
end_include

begin_include
include|#
directive|include
file|<sys/rman.h>
end_include

begin_include
include|#
directive|include
file|<contrib/dev/acpica/acpi.h>
end_include

begin_include
include|#
directive|include
file|<dev/acpica/acpivar.h>
end_include

begin_comment
comment|/* Hooks for the ACPI CA debugging infrastructure */
end_comment

begin_define
define|#
directive|define
name|_COMPONENT
value|ACPI_BUS
end_define

begin_macro
name|ACPI_MODULE_NAME
argument_list|(
literal|"RESOURCE"
argument_list|)
end_macro

begin_struct
struct|struct
name|lookup_irq_request
block|{
name|ACPI_RESOURCE
modifier|*
name|acpi_res
decl_stmt|;
name|struct
name|resource
modifier|*
name|res
decl_stmt|;
name|int
name|counter
decl_stmt|;
name|int
name|rid
decl_stmt|;
name|int
name|found
decl_stmt|;
block|}
struct|;
end_struct

begin_function
specifier|static
name|ACPI_STATUS
name|acpi_lookup_irq_handler
parameter_list|(
name|ACPI_RESOURCE
modifier|*
name|res
parameter_list|,
name|void
modifier|*
name|context
parameter_list|)
block|{
name|struct
name|lookup_irq_request
modifier|*
name|req
decl_stmt|;
name|u_int
name|irqnum
decl_stmt|,
name|irq
decl_stmt|;
switch|switch
condition|(
name|res
operator|->
name|Type
condition|)
block|{
case|case
name|ACPI_RESOURCE_TYPE_IRQ
case|:
case|case
name|ACPI_RESOURCE_TYPE_EXTENDED_IRQ
case|:
if|if
condition|(
name|res
operator|->
name|Type
operator|==
name|ACPI_RESOURCE_TYPE_IRQ
condition|)
block|{
name|irqnum
operator|=
name|res
operator|->
name|Data
operator|.
name|Irq
operator|.
name|InterruptCount
expr_stmt|;
name|irq
operator|=
name|res
operator|->
name|Data
operator|.
name|Irq
operator|.
name|Interrupts
index|[
literal|0
index|]
expr_stmt|;
block|}
else|else
block|{
name|irqnum
operator|=
name|res
operator|->
name|Data
operator|.
name|ExtendedIrq
operator|.
name|InterruptCount
expr_stmt|;
name|irq
operator|=
name|res
operator|->
name|Data
operator|.
name|ExtendedIrq
operator|.
name|Interrupts
index|[
literal|0
index|]
expr_stmt|;
block|}
if|if
condition|(
name|irqnum
operator|!=
literal|1
condition|)
break|break;
name|req
operator|=
operator|(
expr|struct
name|lookup_irq_request
operator|*
operator|)
name|context
expr_stmt|;
if|if
condition|(
name|req
operator|->
name|counter
operator|!=
name|req
operator|->
name|rid
condition|)
block|{
name|req
operator|->
name|counter
operator|++
expr_stmt|;
break|break;
block|}
name|req
operator|->
name|found
operator|=
literal|1
expr_stmt|;
name|KASSERT
argument_list|(
name|irq
operator|==
name|rman_get_start
argument_list|(
name|req
operator|->
name|res
argument_list|)
argument_list|,
operator|(
literal|"IRQ resources do not match"
operator|)
argument_list|)
expr_stmt|;
name|bcopy
argument_list|(
name|res
argument_list|,
name|req
operator|->
name|acpi_res
argument_list|,
sizeof|sizeof
argument_list|(
name|ACPI_RESOURCE
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|(
name|AE_CTRL_TERMINATE
operator|)
return|;
block|}
return|return
operator|(
name|AE_OK
operator|)
return|;
block|}
end_function

begin_function
name|ACPI_STATUS
name|acpi_lookup_irq_resource
parameter_list|(
name|device_t
name|dev
parameter_list|,
name|int
name|rid
parameter_list|,
name|struct
name|resource
modifier|*
name|res
parameter_list|,
name|ACPI_RESOURCE
modifier|*
name|acpi_res
parameter_list|)
block|{
name|struct
name|lookup_irq_request
name|req
decl_stmt|;
name|ACPI_STATUS
name|status
decl_stmt|;
name|req
operator|.
name|acpi_res
operator|=
name|acpi_res
expr_stmt|;
name|req
operator|.
name|res
operator|=
name|res
expr_stmt|;
name|req
operator|.
name|counter
operator|=
literal|0
expr_stmt|;
name|req
operator|.
name|rid
operator|=
name|rid
expr_stmt|;
name|req
operator|.
name|found
operator|=
literal|0
expr_stmt|;
name|status
operator|=
name|AcpiWalkResources
argument_list|(
name|acpi_get_handle
argument_list|(
name|dev
argument_list|)
argument_list|,
literal|"_CRS"
argument_list|,
name|acpi_lookup_irq_handler
argument_list|,
operator|&
name|req
argument_list|)
expr_stmt|;
if|if
condition|(
name|ACPI_SUCCESS
argument_list|(
name|status
argument_list|)
operator|&&
name|req
operator|.
name|found
operator|==
literal|0
condition|)
name|status
operator|=
name|AE_NOT_FOUND
expr_stmt|;
return|return
operator|(
name|status
operator|)
return|;
block|}
end_function

begin_function
name|void
name|acpi_config_intr
parameter_list|(
name|device_t
name|dev
parameter_list|,
name|ACPI_RESOURCE
modifier|*
name|res
parameter_list|)
block|{
name|u_int
name|irq
decl_stmt|;
name|int
name|pol
decl_stmt|,
name|trig
decl_stmt|;
switch|switch
condition|(
name|res
operator|->
name|Type
condition|)
block|{
case|case
name|ACPI_RESOURCE_TYPE_IRQ
case|:
name|KASSERT
argument_list|(
name|res
operator|->
name|Data
operator|.
name|Irq
operator|.
name|InterruptCount
operator|==
literal|1
argument_list|,
operator|(
literal|"%s: multiple interrupts"
operator|,
name|__func__
operator|)
argument_list|)
expr_stmt|;
name|irq
operator|=
name|res
operator|->
name|Data
operator|.
name|Irq
operator|.
name|Interrupts
index|[
literal|0
index|]
expr_stmt|;
name|trig
operator|=
name|res
operator|->
name|Data
operator|.
name|Irq
operator|.
name|Triggering
expr_stmt|;
name|pol
operator|=
name|res
operator|->
name|Data
operator|.
name|Irq
operator|.
name|Polarity
expr_stmt|;
break|break;
case|case
name|ACPI_RESOURCE_TYPE_EXTENDED_IRQ
case|:
name|KASSERT
argument_list|(
name|res
operator|->
name|Data
operator|.
name|ExtendedIrq
operator|.
name|InterruptCount
operator|==
literal|1
argument_list|,
operator|(
literal|"%s: multiple interrupts"
operator|,
name|__func__
operator|)
argument_list|)
expr_stmt|;
name|irq
operator|=
name|res
operator|->
name|Data
operator|.
name|ExtendedIrq
operator|.
name|Interrupts
index|[
literal|0
index|]
expr_stmt|;
name|trig
operator|=
name|res
operator|->
name|Data
operator|.
name|ExtendedIrq
operator|.
name|Triggering
expr_stmt|;
name|pol
operator|=
name|res
operator|->
name|Data
operator|.
name|ExtendedIrq
operator|.
name|Polarity
expr_stmt|;
break|break;
default|default:
name|panic
argument_list|(
literal|"%s: bad resource type %u"
argument_list|,
name|__func__
argument_list|,
name|res
operator|->
name|Type
argument_list|)
expr_stmt|;
block|}
name|BUS_CONFIG_INTR
argument_list|(
name|dev
argument_list|,
name|irq
argument_list|,
operator|(
name|trig
operator|==
name|ACPI_EDGE_SENSITIVE
operator|)
condition|?
name|INTR_TRIGGER_EDGE
else|:
name|INTR_TRIGGER_LEVEL
argument_list|,
operator|(
name|pol
operator|==
name|ACPI_ACTIVE_HIGH
operator|)
condition|?
name|INTR_POLARITY_HIGH
else|:
name|INTR_POLARITY_LOW
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * Fetch a device's resources and associate them with the device.  *  * Note that it might be nice to also locate ACPI-specific resource items, such  * as GPE bits.  *  * We really need to split the resource-fetching code out from the  * resource-parsing code, since we may want to use the parsing  * code for _PRS someday.  */
end_comment

begin_function
name|ACPI_STATUS
name|acpi_parse_resources
parameter_list|(
name|device_t
name|dev
parameter_list|,
name|ACPI_HANDLE
name|handle
parameter_list|,
name|struct
name|acpi_parse_resource_set
modifier|*
name|set
parameter_list|,
name|void
modifier|*
name|arg
parameter_list|)
block|{
name|ACPI_BUFFER
name|buf
decl_stmt|;
name|ACPI_RESOURCE
modifier|*
name|res
decl_stmt|;
name|char
modifier|*
name|curr
decl_stmt|,
modifier|*
name|last
decl_stmt|;
name|ACPI_STATUS
name|status
decl_stmt|;
name|void
modifier|*
name|context
decl_stmt|;
name|ACPI_FUNCTION_TRACE
argument_list|(
operator|(
name|char
operator|*
operator|)
operator|(
name|uintptr_t
operator|)
name|__func__
argument_list|)
expr_stmt|;
comment|/*      * Special-case some devices that abuse _PRS/_CRS to mean      * something other than "I consume this resource".      *      * XXX do we really need this?  It's only relevant once      *     we start always-allocating these resources, and even      *     then, the only special-cased device is likely to be      *     the PCI interrupt link.      */
comment|/* Fetch the device's current resources. */
name|buf
operator|.
name|Length
operator|=
name|ACPI_ALLOCATE_BUFFER
expr_stmt|;
if|if
condition|(
name|ACPI_FAILURE
argument_list|(
operator|(
name|status
operator|=
name|AcpiGetCurrentResources
argument_list|(
name|handle
argument_list|,
operator|&
name|buf
argument_list|)
operator|)
argument_list|)
condition|)
block|{
if|if
condition|(
name|status
operator|!=
name|AE_NOT_FOUND
operator|&&
name|status
operator|!=
name|AE_TYPE
condition|)
name|printf
argument_list|(
literal|"can't fetch resources for %s - %s\n"
argument_list|,
name|acpi_name
argument_list|(
name|handle
argument_list|)
argument_list|,
name|AcpiFormatException
argument_list|(
name|status
argument_list|)
argument_list|)
expr_stmt|;
name|return_ACPI_STATUS
argument_list|(
name|status
argument_list|)
expr_stmt|;
block|}
name|ACPI_DEBUG_PRINT
argument_list|(
operator|(
name|ACPI_DB_RESOURCES
operator|,
literal|"%s - got %ld bytes of resources\n"
operator|,
name|acpi_name
argument_list|(
name|handle
argument_list|)
operator|,
operator|(
name|long
operator|)
name|buf
operator|.
name|Length
operator|)
argument_list|)
expr_stmt|;
name|set
operator|->
name|set_init
argument_list|(
name|dev
argument_list|,
name|arg
argument_list|,
operator|&
name|context
argument_list|)
expr_stmt|;
comment|/* Iterate through the resources */
name|curr
operator|=
name|buf
operator|.
name|Pointer
expr_stmt|;
name|last
operator|=
operator|(
name|char
operator|*
operator|)
name|buf
operator|.
name|Pointer
operator|+
name|buf
operator|.
name|Length
expr_stmt|;
while|while
condition|(
name|curr
operator|<
name|last
condition|)
block|{
name|res
operator|=
operator|(
name|ACPI_RESOURCE
operator|*
operator|)
name|curr
expr_stmt|;
name|curr
operator|+=
name|res
operator|->
name|Length
expr_stmt|;
comment|/* Handle the individual resource types */
switch|switch
condition|(
name|res
operator|->
name|Type
condition|)
block|{
case|case
name|ACPI_RESOURCE_TYPE_END_TAG
case|:
name|ACPI_DEBUG_PRINT
argument_list|(
operator|(
name|ACPI_DB_RESOURCES
operator|,
literal|"EndTag\n"
operator|)
argument_list|)
expr_stmt|;
name|curr
operator|=
name|last
expr_stmt|;
break|break;
case|case
name|ACPI_RESOURCE_TYPE_FIXED_IO
case|:
if|if
condition|(
name|res
operator|->
name|Data
operator|.
name|FixedIo
operator|.
name|AddressLength
operator|<=
literal|0
condition|)
break|break;
name|ACPI_DEBUG_PRINT
argument_list|(
operator|(
name|ACPI_DB_RESOURCES
operator|,
literal|"FixedIo 0x%x/%d\n"
operator|,
name|res
operator|->
name|Data
operator|.
name|FixedIo
operator|.
name|Address
operator|,
name|res
operator|->
name|Data
operator|.
name|FixedIo
operator|.
name|AddressLength
operator|)
argument_list|)
expr_stmt|;
name|set
operator|->
name|set_ioport
argument_list|(
name|dev
argument_list|,
name|context
argument_list|,
name|res
operator|->
name|Data
operator|.
name|FixedIo
operator|.
name|Address
argument_list|,
name|res
operator|->
name|Data
operator|.
name|FixedIo
operator|.
name|AddressLength
argument_list|)
expr_stmt|;
break|break;
case|case
name|ACPI_RESOURCE_TYPE_IO
case|:
if|if
condition|(
name|res
operator|->
name|Data
operator|.
name|Io
operator|.
name|AddressLength
operator|<=
literal|0
condition|)
break|break;
if|if
condition|(
name|res
operator|->
name|Data
operator|.
name|Io
operator|.
name|Minimum
operator|==
name|res
operator|->
name|Data
operator|.
name|Io
operator|.
name|Maximum
condition|)
block|{
name|ACPI_DEBUG_PRINT
argument_list|(
operator|(
name|ACPI_DB_RESOURCES
operator|,
literal|"Io 0x%x/%d\n"
operator|,
name|res
operator|->
name|Data
operator|.
name|Io
operator|.
name|Minimum
operator|,
name|res
operator|->
name|Data
operator|.
name|Io
operator|.
name|AddressLength
operator|)
argument_list|)
expr_stmt|;
name|set
operator|->
name|set_ioport
argument_list|(
name|dev
argument_list|,
name|context
argument_list|,
name|res
operator|->
name|Data
operator|.
name|Io
operator|.
name|Minimum
argument_list|,
name|res
operator|->
name|Data
operator|.
name|Io
operator|.
name|AddressLength
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|ACPI_DEBUG_PRINT
argument_list|(
operator|(
name|ACPI_DB_RESOURCES
operator|,
literal|"Io 0x%x-0x%x/%d\n"
operator|,
name|res
operator|->
name|Data
operator|.
name|Io
operator|.
name|Minimum
operator|,
name|res
operator|->
name|Data
operator|.
name|Io
operator|.
name|Maximum
operator|,
name|res
operator|->
name|Data
operator|.
name|Io
operator|.
name|AddressLength
operator|)
argument_list|)
expr_stmt|;
name|set
operator|->
name|set_iorange
argument_list|(
name|dev
argument_list|,
name|context
argument_list|,
name|res
operator|->
name|Data
operator|.
name|Io
operator|.
name|Minimum
argument_list|,
name|res
operator|->
name|Data
operator|.
name|Io
operator|.
name|Maximum
argument_list|,
name|res
operator|->
name|Data
operator|.
name|Io
operator|.
name|AddressLength
argument_list|,
name|res
operator|->
name|Data
operator|.
name|Io
operator|.
name|Alignment
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
name|ACPI_RESOURCE_TYPE_FIXED_MEMORY32
case|:
if|if
condition|(
name|res
operator|->
name|Data
operator|.
name|FixedMemory32
operator|.
name|AddressLength
operator|<=
literal|0
condition|)
break|break;
name|ACPI_DEBUG_PRINT
argument_list|(
operator|(
name|ACPI_DB_RESOURCES
operator|,
literal|"FixedMemory32 0x%x/%d\n"
operator|,
name|res
operator|->
name|Data
operator|.
name|FixedMemory32
operator|.
name|Address
operator|,
name|res
operator|->
name|Data
operator|.
name|FixedMemory32
operator|.
name|AddressLength
operator|)
argument_list|)
expr_stmt|;
name|set
operator|->
name|set_memory
argument_list|(
name|dev
argument_list|,
name|context
argument_list|,
name|res
operator|->
name|Data
operator|.
name|FixedMemory32
operator|.
name|Address
argument_list|,
name|res
operator|->
name|Data
operator|.
name|FixedMemory32
operator|.
name|AddressLength
argument_list|)
expr_stmt|;
break|break;
case|case
name|ACPI_RESOURCE_TYPE_MEMORY32
case|:
if|if
condition|(
name|res
operator|->
name|Data
operator|.
name|Memory32
operator|.
name|AddressLength
operator|<=
literal|0
condition|)
break|break;
if|if
condition|(
name|res
operator|->
name|Data
operator|.
name|Memory32
operator|.
name|Minimum
operator|==
name|res
operator|->
name|Data
operator|.
name|Memory32
operator|.
name|Maximum
condition|)
block|{
name|ACPI_DEBUG_PRINT
argument_list|(
operator|(
name|ACPI_DB_RESOURCES
operator|,
literal|"Memory32 0x%x/%d\n"
operator|,
name|res
operator|->
name|Data
operator|.
name|Memory32
operator|.
name|Minimum
operator|,
name|res
operator|->
name|Data
operator|.
name|Memory32
operator|.
name|AddressLength
operator|)
argument_list|)
expr_stmt|;
name|set
operator|->
name|set_memory
argument_list|(
name|dev
argument_list|,
name|context
argument_list|,
name|res
operator|->
name|Data
operator|.
name|Memory32
operator|.
name|Minimum
argument_list|,
name|res
operator|->
name|Data
operator|.
name|Memory32
operator|.
name|AddressLength
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|ACPI_DEBUG_PRINT
argument_list|(
operator|(
name|ACPI_DB_RESOURCES
operator|,
literal|"Memory32 0x%x-0x%x/%d\n"
operator|,
name|res
operator|->
name|Data
operator|.
name|Memory32
operator|.
name|Minimum
operator|,
name|res
operator|->
name|Data
operator|.
name|Memory32
operator|.
name|Maximum
operator|,
name|res
operator|->
name|Data
operator|.
name|Memory32
operator|.
name|AddressLength
operator|)
argument_list|)
expr_stmt|;
name|set
operator|->
name|set_memoryrange
argument_list|(
name|dev
argument_list|,
name|context
argument_list|,
name|res
operator|->
name|Data
operator|.
name|Memory32
operator|.
name|Minimum
argument_list|,
name|res
operator|->
name|Data
operator|.
name|Memory32
operator|.
name|Maximum
argument_list|,
name|res
operator|->
name|Data
operator|.
name|Memory32
operator|.
name|AddressLength
argument_list|,
name|res
operator|->
name|Data
operator|.
name|Memory32
operator|.
name|Alignment
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
name|ACPI_RESOURCE_TYPE_MEMORY24
case|:
if|if
condition|(
name|res
operator|->
name|Data
operator|.
name|Memory24
operator|.
name|AddressLength
operator|<=
literal|0
condition|)
break|break;
if|if
condition|(
name|res
operator|->
name|Data
operator|.
name|Memory24
operator|.
name|Minimum
operator|==
name|res
operator|->
name|Data
operator|.
name|Memory24
operator|.
name|Maximum
condition|)
block|{
name|ACPI_DEBUG_PRINT
argument_list|(
operator|(
name|ACPI_DB_RESOURCES
operator|,
literal|"Memory24 0x%x/%d\n"
operator|,
name|res
operator|->
name|Data
operator|.
name|Memory24
operator|.
name|Minimum
operator|,
name|res
operator|->
name|Data
operator|.
name|Memory24
operator|.
name|AddressLength
operator|)
argument_list|)
expr_stmt|;
name|set
operator|->
name|set_memory
argument_list|(
name|dev
argument_list|,
name|context
argument_list|,
name|res
operator|->
name|Data
operator|.
name|Memory24
operator|.
name|Minimum
argument_list|,
name|res
operator|->
name|Data
operator|.
name|Memory24
operator|.
name|AddressLength
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|ACPI_DEBUG_PRINT
argument_list|(
operator|(
name|ACPI_DB_RESOURCES
operator|,
literal|"Memory24 0x%x-0x%x/%d\n"
operator|,
name|res
operator|->
name|Data
operator|.
name|Memory24
operator|.
name|Minimum
operator|,
name|res
operator|->
name|Data
operator|.
name|Memory24
operator|.
name|Maximum
operator|,
name|res
operator|->
name|Data
operator|.
name|Memory24
operator|.
name|AddressLength
operator|)
argument_list|)
expr_stmt|;
name|set
operator|->
name|set_memoryrange
argument_list|(
name|dev
argument_list|,
name|context
argument_list|,
name|res
operator|->
name|Data
operator|.
name|Memory24
operator|.
name|Minimum
argument_list|,
name|res
operator|->
name|Data
operator|.
name|Memory24
operator|.
name|Maximum
argument_list|,
name|res
operator|->
name|Data
operator|.
name|Memory24
operator|.
name|AddressLength
argument_list|,
name|res
operator|->
name|Data
operator|.
name|Memory24
operator|.
name|Alignment
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
name|ACPI_RESOURCE_TYPE_IRQ
case|:
comment|/* 	     * from 1.0b 6.4.2  	     * "This structure is repeated for each separate interrupt 	     * required" 	     */
name|set
operator|->
name|set_irq
argument_list|(
name|dev
argument_list|,
name|context
argument_list|,
name|res
operator|->
name|Data
operator|.
name|Irq
operator|.
name|Interrupts
argument_list|,
name|res
operator|->
name|Data
operator|.
name|Irq
operator|.
name|InterruptCount
argument_list|,
name|res
operator|->
name|Data
operator|.
name|Irq
operator|.
name|Triggering
argument_list|,
name|res
operator|->
name|Data
operator|.
name|Irq
operator|.
name|Polarity
argument_list|)
expr_stmt|;
break|break;
case|case
name|ACPI_RESOURCE_TYPE_DMA
case|:
comment|/* 	     * from 1.0b 6.4.3  	     * "This structure is repeated for each separate dma channel 	     * required" 	     */
name|set
operator|->
name|set_drq
argument_list|(
name|dev
argument_list|,
name|context
argument_list|,
name|res
operator|->
name|Data
operator|.
name|Dma
operator|.
name|Channels
argument_list|,
name|res
operator|->
name|Data
operator|.
name|Dma
operator|.
name|ChannelCount
argument_list|)
expr_stmt|;
break|break;
case|case
name|ACPI_RESOURCE_TYPE_START_DEPENDENT
case|:
name|ACPI_DEBUG_PRINT
argument_list|(
operator|(
name|ACPI_DB_RESOURCES
operator|,
literal|"start dependent functions\n"
operator|)
argument_list|)
expr_stmt|;
name|set
operator|->
name|set_start_dependent
argument_list|(
name|dev
argument_list|,
name|context
argument_list|,
name|res
operator|->
name|Data
operator|.
name|StartDpf
operator|.
name|CompatibilityPriority
argument_list|)
expr_stmt|;
break|break;
case|case
name|ACPI_RESOURCE_TYPE_END_DEPENDENT
case|:
name|ACPI_DEBUG_PRINT
argument_list|(
operator|(
name|ACPI_DB_RESOURCES
operator|,
literal|"end dependent functions\n"
operator|)
argument_list|)
expr_stmt|;
name|set
operator|->
name|set_end_dependent
argument_list|(
name|dev
argument_list|,
name|context
argument_list|)
expr_stmt|;
break|break;
case|case
name|ACPI_RESOURCE_TYPE_ADDRESS32
case|:
if|if
condition|(
name|res
operator|->
name|Data
operator|.
name|Address32
operator|.
name|AddressLength
operator|<=
literal|0
condition|)
break|break;
if|if
condition|(
name|res
operator|->
name|Data
operator|.
name|Address32
operator|.
name|ProducerConsumer
operator|!=
name|ACPI_CONSUMER
condition|)
block|{
name|ACPI_DEBUG_PRINT
argument_list|(
operator|(
name|ACPI_DB_RESOURCES
operator|,
literal|"ignored Address32 %s producer\n"
operator|,
name|res
operator|->
name|Data
operator|.
name|Address32
operator|.
name|ResourceType
operator|==
name|ACPI_IO_RANGE
condition|?
literal|"IO"
else|:
literal|"Memory"
operator|)
argument_list|)
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|res
operator|->
name|Data
operator|.
name|Address32
operator|.
name|ResourceType
operator|!=
name|ACPI_MEMORY_RANGE
operator|&&
name|res
operator|->
name|Data
operator|.
name|Address32
operator|.
name|ResourceType
operator|!=
name|ACPI_IO_RANGE
condition|)
block|{
name|ACPI_DEBUG_PRINT
argument_list|(
operator|(
name|ACPI_DB_RESOURCES
operator|,
literal|"ignored Address32 for non-memory, non-I/O\n"
operator|)
argument_list|)
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|res
operator|->
name|Data
operator|.
name|Address32
operator|.
name|MinAddressFixed
operator|==
name|ACPI_ADDRESS_FIXED
operator|&&
name|res
operator|->
name|Data
operator|.
name|Address32
operator|.
name|MaxAddressFixed
operator|==
name|ACPI_ADDRESS_FIXED
condition|)
block|{
if|if
condition|(
name|res
operator|->
name|Data
operator|.
name|Address32
operator|.
name|ResourceType
operator|==
name|ACPI_MEMORY_RANGE
condition|)
block|{
name|ACPI_DEBUG_PRINT
argument_list|(
operator|(
name|ACPI_DB_RESOURCES
operator|,
literal|"Address32/Memory 0x%x/%d\n"
operator|,
name|res
operator|->
name|Data
operator|.
name|Address32
operator|.
name|Minimum
operator|,
name|res
operator|->
name|Data
operator|.
name|Address32
operator|.
name|AddressLength
operator|)
argument_list|)
expr_stmt|;
name|set
operator|->
name|set_memory
argument_list|(
name|dev
argument_list|,
name|context
argument_list|,
name|res
operator|->
name|Data
operator|.
name|Address32
operator|.
name|Minimum
argument_list|,
name|res
operator|->
name|Data
operator|.
name|Address32
operator|.
name|AddressLength
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|ACPI_DEBUG_PRINT
argument_list|(
operator|(
name|ACPI_DB_RESOURCES
operator|,
literal|"Address32/IO 0x%x/%d\n"
operator|,
name|res
operator|->
name|Data
operator|.
name|Address32
operator|.
name|Minimum
operator|,
name|res
operator|->
name|Data
operator|.
name|Address32
operator|.
name|AddressLength
operator|)
argument_list|)
expr_stmt|;
name|set
operator|->
name|set_ioport
argument_list|(
name|dev
argument_list|,
name|context
argument_list|,
name|res
operator|->
name|Data
operator|.
name|Address32
operator|.
name|Minimum
argument_list|,
name|res
operator|->
name|Data
operator|.
name|Address32
operator|.
name|AddressLength
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
if|if
condition|(
name|res
operator|->
name|Data
operator|.
name|Address32
operator|.
name|ResourceType
operator|==
name|ACPI_MEMORY_RANGE
condition|)
block|{
name|ACPI_DEBUG_PRINT
argument_list|(
operator|(
name|ACPI_DB_RESOURCES
operator|,
literal|"Address32/Memory 0x%x-0x%x/%d\n"
operator|,
name|res
operator|->
name|Data
operator|.
name|Address32
operator|.
name|Minimum
operator|,
name|res
operator|->
name|Data
operator|.
name|Address32
operator|.
name|Maximum
operator|,
name|res
operator|->
name|Data
operator|.
name|Address32
operator|.
name|AddressLength
operator|)
argument_list|)
expr_stmt|;
name|set
operator|->
name|set_memoryrange
argument_list|(
name|dev
argument_list|,
name|context
argument_list|,
name|res
operator|->
name|Data
operator|.
name|Address32
operator|.
name|Minimum
argument_list|,
name|res
operator|->
name|Data
operator|.
name|Address32
operator|.
name|Maximum
argument_list|,
name|res
operator|->
name|Data
operator|.
name|Address32
operator|.
name|AddressLength
argument_list|,
name|res
operator|->
name|Data
operator|.
name|Address32
operator|.
name|Granularity
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|ACPI_DEBUG_PRINT
argument_list|(
operator|(
name|ACPI_DB_RESOURCES
operator|,
literal|"Address32/IO 0x%x-0x%x/%d\n"
operator|,
name|res
operator|->
name|Data
operator|.
name|Address32
operator|.
name|Minimum
operator|,
name|res
operator|->
name|Data
operator|.
name|Address32
operator|.
name|Maximum
operator|,
name|res
operator|->
name|Data
operator|.
name|Address32
operator|.
name|AddressLength
operator|)
argument_list|)
expr_stmt|;
name|set
operator|->
name|set_iorange
argument_list|(
name|dev
argument_list|,
name|context
argument_list|,
name|res
operator|->
name|Data
operator|.
name|Address32
operator|.
name|Minimum
argument_list|,
name|res
operator|->
name|Data
operator|.
name|Address32
operator|.
name|Maximum
argument_list|,
name|res
operator|->
name|Data
operator|.
name|Address32
operator|.
name|AddressLength
argument_list|,
name|res
operator|->
name|Data
operator|.
name|Address32
operator|.
name|Granularity
argument_list|)
expr_stmt|;
block|}
block|}
break|break;
case|case
name|ACPI_RESOURCE_TYPE_ADDRESS16
case|:
if|if
condition|(
name|res
operator|->
name|Data
operator|.
name|Address16
operator|.
name|AddressLength
operator|<=
literal|0
condition|)
break|break;
if|if
condition|(
name|res
operator|->
name|Data
operator|.
name|Address16
operator|.
name|ProducerConsumer
operator|!=
name|ACPI_CONSUMER
condition|)
block|{
name|ACPI_DEBUG_PRINT
argument_list|(
operator|(
name|ACPI_DB_RESOURCES
operator|,
literal|"ignored Address16 %s producer\n"
operator|,
name|res
operator|->
name|Data
operator|.
name|Address16
operator|.
name|ResourceType
operator|==
name|ACPI_IO_RANGE
condition|?
literal|"IO"
else|:
literal|"Memory"
operator|)
argument_list|)
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|res
operator|->
name|Data
operator|.
name|Address16
operator|.
name|ResourceType
operator|!=
name|ACPI_MEMORY_RANGE
operator|&&
name|res
operator|->
name|Data
operator|.
name|Address16
operator|.
name|ResourceType
operator|!=
name|ACPI_IO_RANGE
condition|)
block|{
name|ACPI_DEBUG_PRINT
argument_list|(
operator|(
name|ACPI_DB_RESOURCES
operator|,
literal|"ignored Address16 for non-memory, non-I/O\n"
operator|)
argument_list|)
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|res
operator|->
name|Data
operator|.
name|Address16
operator|.
name|MinAddressFixed
operator|==
name|ACPI_ADDRESS_FIXED
operator|&&
name|res
operator|->
name|Data
operator|.
name|Address16
operator|.
name|MaxAddressFixed
operator|==
name|ACPI_ADDRESS_FIXED
condition|)
block|{
if|if
condition|(
name|res
operator|->
name|Data
operator|.
name|Address16
operator|.
name|ResourceType
operator|==
name|ACPI_MEMORY_RANGE
condition|)
block|{
name|ACPI_DEBUG_PRINT
argument_list|(
operator|(
name|ACPI_DB_RESOURCES
operator|,
literal|"Address16/Memory 0x%x/%d\n"
operator|,
name|res
operator|->
name|Data
operator|.
name|Address16
operator|.
name|Minimum
operator|,
name|res
operator|->
name|Data
operator|.
name|Address16
operator|.
name|AddressLength
operator|)
argument_list|)
expr_stmt|;
name|set
operator|->
name|set_memory
argument_list|(
name|dev
argument_list|,
name|context
argument_list|,
name|res
operator|->
name|Data
operator|.
name|Address16
operator|.
name|Minimum
argument_list|,
name|res
operator|->
name|Data
operator|.
name|Address16
operator|.
name|AddressLength
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|ACPI_DEBUG_PRINT
argument_list|(
operator|(
name|ACPI_DB_RESOURCES
operator|,
literal|"Address16/IO 0x%x/%d\n"
operator|,
name|res
operator|->
name|Data
operator|.
name|Address16
operator|.
name|Minimum
operator|,
name|res
operator|->
name|Data
operator|.
name|Address16
operator|.
name|AddressLength
operator|)
argument_list|)
expr_stmt|;
name|set
operator|->
name|set_ioport
argument_list|(
name|dev
argument_list|,
name|context
argument_list|,
name|res
operator|->
name|Data
operator|.
name|Address16
operator|.
name|Minimum
argument_list|,
name|res
operator|->
name|Data
operator|.
name|Address16
operator|.
name|AddressLength
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
if|if
condition|(
name|res
operator|->
name|Data
operator|.
name|Address16
operator|.
name|ResourceType
operator|==
name|ACPI_MEMORY_RANGE
condition|)
block|{
name|ACPI_DEBUG_PRINT
argument_list|(
operator|(
name|ACPI_DB_RESOURCES
operator|,
literal|"Address16/Memory 0x%x-0x%x/%d\n"
operator|,
name|res
operator|->
name|Data
operator|.
name|Address16
operator|.
name|Minimum
operator|,
name|res
operator|->
name|Data
operator|.
name|Address16
operator|.
name|Maximum
operator|,
name|res
operator|->
name|Data
operator|.
name|Address16
operator|.
name|AddressLength
operator|)
argument_list|)
expr_stmt|;
name|set
operator|->
name|set_memoryrange
argument_list|(
name|dev
argument_list|,
name|context
argument_list|,
name|res
operator|->
name|Data
operator|.
name|Address16
operator|.
name|Minimum
argument_list|,
name|res
operator|->
name|Data
operator|.
name|Address16
operator|.
name|Maximum
argument_list|,
name|res
operator|->
name|Data
operator|.
name|Address16
operator|.
name|AddressLength
argument_list|,
name|res
operator|->
name|Data
operator|.
name|Address16
operator|.
name|Granularity
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|ACPI_DEBUG_PRINT
argument_list|(
operator|(
name|ACPI_DB_RESOURCES
operator|,
literal|"Address16/IO 0x%x-0x%x/%d\n"
operator|,
name|res
operator|->
name|Data
operator|.
name|Address16
operator|.
name|Minimum
operator|,
name|res
operator|->
name|Data
operator|.
name|Address16
operator|.
name|Maximum
operator|,
name|res
operator|->
name|Data
operator|.
name|Address16
operator|.
name|AddressLength
operator|)
argument_list|)
expr_stmt|;
name|set
operator|->
name|set_iorange
argument_list|(
name|dev
argument_list|,
name|context
argument_list|,
name|res
operator|->
name|Data
operator|.
name|Address16
operator|.
name|Minimum
argument_list|,
name|res
operator|->
name|Data
operator|.
name|Address16
operator|.
name|Maximum
argument_list|,
name|res
operator|->
name|Data
operator|.
name|Address16
operator|.
name|AddressLength
argument_list|,
name|res
operator|->
name|Data
operator|.
name|Address16
operator|.
name|Granularity
argument_list|)
expr_stmt|;
block|}
block|}
break|break;
case|case
name|ACPI_RESOURCE_TYPE_ADDRESS64
case|:
name|ACPI_DEBUG_PRINT
argument_list|(
operator|(
name|ACPI_DB_RESOURCES
operator|,
literal|"unimplemented Address64 resource\n"
operator|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|ACPI_RESOURCE_TYPE_EXTENDED_IRQ
case|:
if|if
condition|(
name|res
operator|->
name|Data
operator|.
name|ExtendedIrq
operator|.
name|ProducerConsumer
operator|!=
name|ACPI_CONSUMER
condition|)
block|{
name|ACPI_DEBUG_PRINT
argument_list|(
operator|(
name|ACPI_DB_RESOURCES
operator|,
literal|"ignored ExtIRQ producer\n"
operator|)
argument_list|)
expr_stmt|;
break|break;
block|}
name|set
operator|->
name|set_ext_irq
argument_list|(
name|dev
argument_list|,
name|context
argument_list|,
name|res
operator|->
name|Data
operator|.
name|ExtendedIrq
operator|.
name|Interrupts
argument_list|,
name|res
operator|->
name|Data
operator|.
name|ExtendedIrq
operator|.
name|InterruptCount
argument_list|,
name|res
operator|->
name|Data
operator|.
name|ExtendedIrq
operator|.
name|Triggering
argument_list|,
name|res
operator|->
name|Data
operator|.
name|ExtendedIrq
operator|.
name|Polarity
argument_list|)
expr_stmt|;
break|break;
case|case
name|ACPI_RESOURCE_TYPE_VENDOR
case|:
name|ACPI_DEBUG_PRINT
argument_list|(
operator|(
name|ACPI_DB_RESOURCES
operator|,
literal|"unimplemented VendorSpecific resource\n"
operator|)
argument_list|)
expr_stmt|;
break|break;
default|default:
break|break;
block|}
block|}
name|AcpiOsFree
argument_list|(
name|buf
operator|.
name|Pointer
argument_list|)
expr_stmt|;
name|set
operator|->
name|set_done
argument_list|(
name|dev
argument_list|,
name|context
argument_list|)
expr_stmt|;
name|return_ACPI_STATUS
argument_list|(
name|AE_OK
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * Resource-set vectors used to attach _CRS-derived resources   * to an ACPI device.  */
end_comment

begin_function_decl
specifier|static
name|void
name|acpi_res_set_init
parameter_list|(
name|device_t
name|dev
parameter_list|,
name|void
modifier|*
name|arg
parameter_list|,
name|void
modifier|*
modifier|*
name|context
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|acpi_res_set_done
parameter_list|(
name|device_t
name|dev
parameter_list|,
name|void
modifier|*
name|context
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|acpi_res_set_ioport
parameter_list|(
name|device_t
name|dev
parameter_list|,
name|void
modifier|*
name|context
parameter_list|,
name|u_int32_t
name|base
parameter_list|,
name|u_int32_t
name|length
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|acpi_res_set_iorange
parameter_list|(
name|device_t
name|dev
parameter_list|,
name|void
modifier|*
name|context
parameter_list|,
name|u_int32_t
name|low
parameter_list|,
name|u_int32_t
name|high
parameter_list|,
name|u_int32_t
name|length
parameter_list|,
name|u_int32_t
name|align
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|acpi_res_set_memory
parameter_list|(
name|device_t
name|dev
parameter_list|,
name|void
modifier|*
name|context
parameter_list|,
name|u_int32_t
name|base
parameter_list|,
name|u_int32_t
name|length
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|acpi_res_set_memoryrange
parameter_list|(
name|device_t
name|dev
parameter_list|,
name|void
modifier|*
name|context
parameter_list|,
name|u_int32_t
name|low
parameter_list|,
name|u_int32_t
name|high
parameter_list|,
name|u_int32_t
name|length
parameter_list|,
name|u_int32_t
name|align
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|acpi_res_set_irq
parameter_list|(
name|device_t
name|dev
parameter_list|,
name|void
modifier|*
name|context
parameter_list|,
name|u_int8_t
modifier|*
name|irq
parameter_list|,
name|int
name|count
parameter_list|,
name|int
name|trig
parameter_list|,
name|int
name|pol
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|acpi_res_set_ext_irq
parameter_list|(
name|device_t
name|dev
parameter_list|,
name|void
modifier|*
name|context
parameter_list|,
name|u_int32_t
modifier|*
name|irq
parameter_list|,
name|int
name|count
parameter_list|,
name|int
name|trig
parameter_list|,
name|int
name|pol
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|acpi_res_set_drq
parameter_list|(
name|device_t
name|dev
parameter_list|,
name|void
modifier|*
name|context
parameter_list|,
name|u_int8_t
modifier|*
name|drq
parameter_list|,
name|int
name|count
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|acpi_res_set_start_dependent
parameter_list|(
name|device_t
name|dev
parameter_list|,
name|void
modifier|*
name|context
parameter_list|,
name|int
name|preference
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|acpi_res_set_end_dependent
parameter_list|(
name|device_t
name|dev
parameter_list|,
name|void
modifier|*
name|context
parameter_list|)
function_decl|;
end_function_decl

begin_decl_stmt
name|struct
name|acpi_parse_resource_set
name|acpi_res_parse_set
init|=
block|{
name|acpi_res_set_init
block|,
name|acpi_res_set_done
block|,
name|acpi_res_set_ioport
block|,
name|acpi_res_set_iorange
block|,
name|acpi_res_set_memory
block|,
name|acpi_res_set_memoryrange
block|,
name|acpi_res_set_irq
block|,
name|acpi_res_set_ext_irq
block|,
name|acpi_res_set_drq
block|,
name|acpi_res_set_start_dependent
block|,
name|acpi_res_set_end_dependent
block|}
decl_stmt|;
end_decl_stmt

begin_struct
struct|struct
name|acpi_res_context
block|{
name|int
name|ar_nio
decl_stmt|;
name|int
name|ar_nmem
decl_stmt|;
name|int
name|ar_nirq
decl_stmt|;
name|int
name|ar_ndrq
decl_stmt|;
name|void
modifier|*
name|ar_parent
decl_stmt|;
block|}
struct|;
end_struct

begin_function
specifier|static
name|void
name|acpi_res_set_init
parameter_list|(
name|device_t
name|dev
parameter_list|,
name|void
modifier|*
name|arg
parameter_list|,
name|void
modifier|*
modifier|*
name|context
parameter_list|)
block|{
name|struct
name|acpi_res_context
modifier|*
name|cp
decl_stmt|;
if|if
condition|(
operator|(
name|cp
operator|=
name|AcpiOsAllocate
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|cp
argument_list|)
argument_list|)
operator|)
operator|!=
name|NULL
condition|)
block|{
name|bzero
argument_list|(
name|cp
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|cp
argument_list|)
argument_list|)
expr_stmt|;
name|cp
operator|->
name|ar_parent
operator|=
name|arg
expr_stmt|;
operator|*
name|context
operator|=
name|cp
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|acpi_res_set_done
parameter_list|(
name|device_t
name|dev
parameter_list|,
name|void
modifier|*
name|context
parameter_list|)
block|{
name|struct
name|acpi_res_context
modifier|*
name|cp
init|=
operator|(
expr|struct
name|acpi_res_context
operator|*
operator|)
name|context
decl_stmt|;
if|if
condition|(
name|cp
operator|==
name|NULL
condition|)
return|return;
name|AcpiOsFree
argument_list|(
name|cp
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|acpi_res_set_ioport
parameter_list|(
name|device_t
name|dev
parameter_list|,
name|void
modifier|*
name|context
parameter_list|,
name|u_int32_t
name|base
parameter_list|,
name|u_int32_t
name|length
parameter_list|)
block|{
name|struct
name|acpi_res_context
modifier|*
name|cp
init|=
operator|(
expr|struct
name|acpi_res_context
operator|*
operator|)
name|context
decl_stmt|;
if|if
condition|(
name|cp
operator|==
name|NULL
condition|)
return|return;
name|bus_set_resource
argument_list|(
name|dev
argument_list|,
name|SYS_RES_IOPORT
argument_list|,
name|cp
operator|->
name|ar_nio
operator|++
argument_list|,
name|base
argument_list|,
name|length
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|acpi_res_set_iorange
parameter_list|(
name|device_t
name|dev
parameter_list|,
name|void
modifier|*
name|context
parameter_list|,
name|u_int32_t
name|low
parameter_list|,
name|u_int32_t
name|high
parameter_list|,
name|u_int32_t
name|length
parameter_list|,
name|u_int32_t
name|align
parameter_list|)
block|{
name|struct
name|acpi_res_context
modifier|*
name|cp
init|=
operator|(
expr|struct
name|acpi_res_context
operator|*
operator|)
name|context
decl_stmt|;
if|if
condition|(
name|cp
operator|==
name|NULL
condition|)
return|return;
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"I/O range not supported\n"
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|acpi_res_set_memory
parameter_list|(
name|device_t
name|dev
parameter_list|,
name|void
modifier|*
name|context
parameter_list|,
name|u_int32_t
name|base
parameter_list|,
name|u_int32_t
name|length
parameter_list|)
block|{
name|struct
name|acpi_res_context
modifier|*
name|cp
init|=
operator|(
expr|struct
name|acpi_res_context
operator|*
operator|)
name|context
decl_stmt|;
if|if
condition|(
name|cp
operator|==
name|NULL
condition|)
return|return;
name|bus_set_resource
argument_list|(
name|dev
argument_list|,
name|SYS_RES_MEMORY
argument_list|,
name|cp
operator|->
name|ar_nmem
operator|++
argument_list|,
name|base
argument_list|,
name|length
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|acpi_res_set_memoryrange
parameter_list|(
name|device_t
name|dev
parameter_list|,
name|void
modifier|*
name|context
parameter_list|,
name|u_int32_t
name|low
parameter_list|,
name|u_int32_t
name|high
parameter_list|,
name|u_int32_t
name|length
parameter_list|,
name|u_int32_t
name|align
parameter_list|)
block|{
name|struct
name|acpi_res_context
modifier|*
name|cp
init|=
operator|(
expr|struct
name|acpi_res_context
operator|*
operator|)
name|context
decl_stmt|;
if|if
condition|(
name|cp
operator|==
name|NULL
condition|)
return|return;
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"memory range not supported\n"
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|acpi_res_set_irq
parameter_list|(
name|device_t
name|dev
parameter_list|,
name|void
modifier|*
name|context
parameter_list|,
name|u_int8_t
modifier|*
name|irq
parameter_list|,
name|int
name|count
parameter_list|,
name|int
name|trig
parameter_list|,
name|int
name|pol
parameter_list|)
block|{
name|struct
name|acpi_res_context
modifier|*
name|cp
init|=
operator|(
expr|struct
name|acpi_res_context
operator|*
operator|)
name|context
decl_stmt|;
if|if
condition|(
name|cp
operator|==
name|NULL
operator|||
name|irq
operator|==
name|NULL
condition|)
return|return;
comment|/* This implements no resource relocation. */
if|if
condition|(
name|count
operator|!=
literal|1
condition|)
return|return;
name|bus_set_resource
argument_list|(
name|dev
argument_list|,
name|SYS_RES_IRQ
argument_list|,
name|cp
operator|->
name|ar_nirq
operator|++
argument_list|,
operator|*
name|irq
argument_list|,
literal|1
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|acpi_res_set_ext_irq
parameter_list|(
name|device_t
name|dev
parameter_list|,
name|void
modifier|*
name|context
parameter_list|,
name|u_int32_t
modifier|*
name|irq
parameter_list|,
name|int
name|count
parameter_list|,
name|int
name|trig
parameter_list|,
name|int
name|pol
parameter_list|)
block|{
name|struct
name|acpi_res_context
modifier|*
name|cp
init|=
operator|(
expr|struct
name|acpi_res_context
operator|*
operator|)
name|context
decl_stmt|;
if|if
condition|(
name|cp
operator|==
name|NULL
operator|||
name|irq
operator|==
name|NULL
condition|)
return|return;
comment|/* This implements no resource relocation. */
if|if
condition|(
name|count
operator|!=
literal|1
condition|)
return|return;
name|bus_set_resource
argument_list|(
name|dev
argument_list|,
name|SYS_RES_IRQ
argument_list|,
name|cp
operator|->
name|ar_nirq
operator|++
argument_list|,
operator|*
name|irq
argument_list|,
literal|1
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|acpi_res_set_drq
parameter_list|(
name|device_t
name|dev
parameter_list|,
name|void
modifier|*
name|context
parameter_list|,
name|u_int8_t
modifier|*
name|drq
parameter_list|,
name|int
name|count
parameter_list|)
block|{
name|struct
name|acpi_res_context
modifier|*
name|cp
init|=
operator|(
expr|struct
name|acpi_res_context
operator|*
operator|)
name|context
decl_stmt|;
if|if
condition|(
name|cp
operator|==
name|NULL
operator|||
name|drq
operator|==
name|NULL
condition|)
return|return;
comment|/* This implements no resource relocation. */
if|if
condition|(
name|count
operator|!=
literal|1
condition|)
return|return;
name|bus_set_resource
argument_list|(
name|dev
argument_list|,
name|SYS_RES_DRQ
argument_list|,
name|cp
operator|->
name|ar_ndrq
operator|++
argument_list|,
operator|*
name|drq
argument_list|,
literal|1
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|acpi_res_set_start_dependent
parameter_list|(
name|device_t
name|dev
parameter_list|,
name|void
modifier|*
name|context
parameter_list|,
name|int
name|preference
parameter_list|)
block|{
name|struct
name|acpi_res_context
modifier|*
name|cp
init|=
operator|(
expr|struct
name|acpi_res_context
operator|*
operator|)
name|context
decl_stmt|;
if|if
condition|(
name|cp
operator|==
name|NULL
condition|)
return|return;
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"dependent functions not supported\n"
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|acpi_res_set_end_dependent
parameter_list|(
name|device_t
name|dev
parameter_list|,
name|void
modifier|*
name|context
parameter_list|)
block|{
name|struct
name|acpi_res_context
modifier|*
name|cp
init|=
operator|(
expr|struct
name|acpi_res_context
operator|*
operator|)
name|context
decl_stmt|;
if|if
condition|(
name|cp
operator|==
name|NULL
condition|)
return|return;
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"dependent functions not supported\n"
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * Resource-owning placeholders for IO and memory pseudo-devices.  *  * This code allocates system resources that will be used by ACPI  * child devices.  The acpi parent manages these resources through a  * private rman.  */
end_comment

begin_decl_stmt
specifier|static
name|int
name|acpi_sysres_rid
init|=
literal|100
decl_stmt|;
end_decl_stmt

begin_function_decl
specifier|static
name|int
name|acpi_sysres_probe
parameter_list|(
name|device_t
name|dev
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|acpi_sysres_attach
parameter_list|(
name|device_t
name|dev
parameter_list|)
function_decl|;
end_function_decl

begin_decl_stmt
specifier|static
name|device_method_t
name|acpi_sysres_methods
index|[]
init|=
block|{
comment|/* Device interface */
name|DEVMETHOD
argument_list|(
name|device_probe
argument_list|,
name|acpi_sysres_probe
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|device_attach
argument_list|,
name|acpi_sysres_attach
argument_list|)
block|,
block|{
literal|0
block|,
literal|0
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|driver_t
name|acpi_sysres_driver
init|=
block|{
literal|"acpi_sysresource"
block|,
name|acpi_sysres_methods
block|,
literal|0
block|, }
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|devclass_t
name|acpi_sysres_devclass
decl_stmt|;
end_decl_stmt

begin_expr_stmt
name|DRIVER_MODULE
argument_list|(
name|acpi_sysresource
argument_list|,
name|acpi
argument_list|,
name|acpi_sysres_driver
argument_list|,
name|acpi_sysres_devclass
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|MODULE_DEPEND
argument_list|(
name|acpi_sysresource
argument_list|,
name|acpi
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|)
expr_stmt|;
end_expr_stmt

begin_function
specifier|static
name|int
name|acpi_sysres_probe
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
specifier|static
name|char
modifier|*
name|sysres_ids
index|[]
init|=
block|{
literal|"PNP0C01"
block|,
literal|"PNP0C02"
block|,
name|NULL
block|}
decl_stmt|;
if|if
condition|(
name|acpi_disabled
argument_list|(
literal|"sysresource"
argument_list|)
operator|||
name|ACPI_ID_PROBE
argument_list|(
name|device_get_parent
argument_list|(
name|dev
argument_list|)
argument_list|,
name|dev
argument_list|,
name|sysres_ids
argument_list|)
operator|==
name|NULL
condition|)
return|return
operator|(
name|ENXIO
operator|)
return|;
name|device_set_desc
argument_list|(
name|dev
argument_list|,
literal|"System Resource"
argument_list|)
expr_stmt|;
name|device_quiet
argument_list|(
name|dev
argument_list|)
expr_stmt|;
return|return
operator|(
name|BUS_PROBE_DEFAULT
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|acpi_sysres_attach
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
name|device_t
name|bus
decl_stmt|;
name|struct
name|resource_list_entry
modifier|*
name|bus_rle
decl_stmt|,
modifier|*
name|dev_rle
decl_stmt|;
name|struct
name|resource_list
modifier|*
name|bus_rl
decl_stmt|,
modifier|*
name|dev_rl
decl_stmt|;
name|int
name|done
decl_stmt|,
name|type
decl_stmt|;
name|u_long
name|start
decl_stmt|,
name|end
decl_stmt|,
name|count
decl_stmt|;
comment|/*      * Loop through all current resources to see if the new one overlaps      * any existing ones.  If so, grow the old one up and/or down      * accordingly.  Discard any that are wholly contained in the old.  If      * the resource is unique, add it to the parent.  It will later go into      * the rman pool.      */
name|bus
operator|=
name|device_get_parent
argument_list|(
name|dev
argument_list|)
expr_stmt|;
name|dev_rl
operator|=
name|BUS_GET_RESOURCE_LIST
argument_list|(
name|bus
argument_list|,
name|dev
argument_list|)
expr_stmt|;
name|bus_rl
operator|=
name|BUS_GET_RESOURCE_LIST
argument_list|(
name|device_get_parent
argument_list|(
name|bus
argument_list|)
argument_list|,
name|bus
argument_list|)
expr_stmt|;
name|STAILQ_FOREACH
argument_list|(
argument|dev_rle
argument_list|,
argument|dev_rl
argument_list|,
argument|link
argument_list|)
block|{
if|if
condition|(
name|dev_rle
operator|->
name|type
operator|!=
name|SYS_RES_IOPORT
operator|&&
name|dev_rle
operator|->
name|type
operator|!=
name|SYS_RES_MEMORY
condition|)
continue|continue;
name|start
operator|=
name|dev_rle
operator|->
name|start
expr_stmt|;
name|end
operator|=
name|dev_rle
operator|->
name|end
expr_stmt|;
name|count
operator|=
name|dev_rle
operator|->
name|count
expr_stmt|;
name|type
operator|=
name|dev_rle
operator|->
name|type
expr_stmt|;
name|done
operator|=
name|FALSE
expr_stmt|;
name|STAILQ_FOREACH
argument_list|(
argument|bus_rle
argument_list|,
argument|bus_rl
argument_list|,
argument|link
argument_list|)
block|{
if|if
condition|(
name|bus_rle
operator|->
name|type
operator|!=
name|type
condition|)
continue|continue;
comment|/* New resource wholly contained in old, discard. */
if|if
condition|(
name|start
operator|>=
name|bus_rle
operator|->
name|start
operator|&&
name|end
operator|<=
name|bus_rle
operator|->
name|end
condition|)
break|break;
comment|/* New tail overlaps old head, grow existing resource downward. */
if|if
condition|(
name|start
operator|<
name|bus_rle
operator|->
name|start
operator|&&
name|end
operator|>=
name|bus_rle
operator|->
name|start
condition|)
block|{
name|bus_rle
operator|->
name|count
operator|+=
name|bus_rle
operator|->
name|start
operator|-
name|start
expr_stmt|;
name|bus_rle
operator|->
name|start
operator|=
name|start
expr_stmt|;
name|done
operator|=
name|TRUE
expr_stmt|;
block|}
comment|/* New head overlaps old tail, grow existing resource upward. */
if|if
condition|(
name|start
operator|<=
name|bus_rle
operator|->
name|end
operator|&&
name|end
operator|>
name|bus_rle
operator|->
name|end
condition|)
block|{
name|bus_rle
operator|->
name|count
operator|+=
name|end
operator|-
name|bus_rle
operator|->
name|end
expr_stmt|;
name|bus_rle
operator|->
name|end
operator|=
name|end
expr_stmt|;
name|done
operator|=
name|TRUE
expr_stmt|;
block|}
comment|/* If we adjusted the old resource, we're finished. */
if|if
condition|(
name|done
condition|)
break|break;
block|}
comment|/* If we didn't merge with anything, add this resource. */
if|if
condition|(
name|bus_rle
operator|==
name|NULL
condition|)
name|bus_set_resource
argument_list|(
name|bus
argument_list|,
name|type
argument_list|,
name|acpi_sysres_rid
operator|++
argument_list|,
name|start
argument_list|,
name|count
argument_list|)
expr_stmt|;
block|}
comment|/* After merging/moving resources to the parent, free the list. */
name|resource_list_free
argument_list|(
name|dev_rl
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Copyright (c) 2002 Silicon Graphics, Inc.  All Rights Reserved.  *  * This program is free software; you can redistribute it and/or modify it  * under the terms of version 2 of the GNU General Public License as  * published by the Free Software Foundation.  *  * This program is distributed in the hope that it would be useful, but  * WITHOUT ANY WARRANTY; without even the implied warranty of  * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  *  * Further, this software is distributed without any warranty that it is  * free of the rightful claim of any third person regarding infringement  * or the like.  Any license provided herein, whether implied or  * otherwise, applies only to this software file.  Patent licenses, if  * any, provided herein do not apply to combinations of this program with  * other software, or any other product whatsoever.  *  * You should have received a copy of the GNU General Public License along  * with this program; if not, write the Free Software Foundation, Inc., 59  * Temple Place - Suite 330, Boston MA 02111-1307, USA.  *  * Contact information: Silicon Graphics, Inc., 1600 Amphitheatre Pkwy,  * Mountain View, CA  94043, or:  *  * http://www.sgi.com  *  * For further information regarding this notice, see:  *  * http://oss.sgi.com/projects/GenInfo/SGIGPLNoticeExplan/  */
end_comment

begin_include
include|#
directive|include
file|"xfs.h"
end_include

begin_function_decl
name|STATIC
name|int
name|xfs_cap_allow_set
parameter_list|(
name|xfs_vnode_t
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_comment
comment|/*  * Test for existence of capability attribute as efficiently as possible.  */
end_comment

begin_function
name|int
name|xfs_cap_vhascap
parameter_list|(
name|xfs_vnode_t
modifier|*
name|vp
parameter_list|)
block|{
name|int
name|error
decl_stmt|;
name|int
name|len
init|=
sizeof|sizeof
argument_list|(
name|xfs_cap_set_t
argument_list|)
decl_stmt|;
name|int
name|flags
init|=
name|ATTR_KERNOVAL
operator||
name|ATTR_ROOT
decl_stmt|;
name|XVOP_ATTR_GET
argument_list|(
name|vp
argument_list|,
name|SGI_CAP_LINUX
argument_list|,
name|NULL
argument_list|,
operator|&
name|len
argument_list|,
name|flags
argument_list|,
name|sys_cred
argument_list|,
name|error
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|==
literal|0
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Convert from extended attribute representation to in-memory for XFS.  */
end_comment

begin_function
name|STATIC
name|int
name|posix_cap_xattr_to_xfs
parameter_list|(
name|posix_cap_xattr
modifier|*
name|src
parameter_list|,
name|size_t
name|size
parameter_list|,
name|xfs_cap_set_t
modifier|*
name|dest
parameter_list|)
block|{
if|if
condition|(
operator|!
name|src
operator|||
operator|!
name|dest
condition|)
return|return
name|EINVAL
return|;
if|if
condition|(
name|src
operator|->
name|c_version
operator|!=
name|cpu_to_le32
argument_list|(
name|POSIX_CAP_XATTR_VERSION
argument_list|)
condition|)
return|return
name|EINVAL
return|;
if|if
condition|(
name|src
operator|->
name|c_abiversion
operator|!=
name|cpu_to_le32
argument_list|(
name|_LINUX_CAPABILITY_VERSION
argument_list|)
condition|)
return|return
name|EINVAL
return|;
if|if
condition|(
name|size
operator|<
sizeof|sizeof
argument_list|(
name|posix_cap_xattr
argument_list|)
condition|)
return|return
name|EINVAL
return|;
name|ASSERT
argument_list|(
sizeof|sizeof
argument_list|(
name|dest
operator|->
name|cap_effective
argument_list|)
operator|==
sizeof|sizeof
argument_list|(
name|src
operator|->
name|c_effective
argument_list|)
argument_list|)
expr_stmt|;
name|dest
operator|->
name|cap_effective
operator|=
name|src
operator|->
name|c_effective
expr_stmt|;
name|dest
operator|->
name|cap_permitted
operator|=
name|src
operator|->
name|c_permitted
expr_stmt|;
name|dest
operator|->
name|cap_inheritable
operator|=
name|src
operator|->
name|c_inheritable
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/*  * Convert from in-memory XFS to extended attribute representation.  */
end_comment

begin_function
name|STATIC
name|int
name|posix_cap_xfs_to_xattr
parameter_list|(
name|xfs_cap_set_t
modifier|*
name|src
parameter_list|,
name|posix_cap_xattr
modifier|*
name|xattr_cap
parameter_list|,
name|size_t
name|size
parameter_list|)
block|{
name|size_t
name|new_size
init|=
name|posix_cap_xattr_size
argument_list|()
decl_stmt|;
if|if
condition|(
name|size
operator|<
name|new_size
condition|)
return|return
operator|-
name|ERANGE
return|;
name|ASSERT
argument_list|(
sizeof|sizeof
argument_list|(
name|xattr_cap
operator|->
name|c_effective
argument_list|)
operator|==
sizeof|sizeof
argument_list|(
name|src
operator|->
name|cap_effective
argument_list|)
argument_list|)
expr_stmt|;
name|xattr_cap
operator|->
name|c_version
operator|=
name|cpu_to_le32
argument_list|(
name|POSIX_CAP_XATTR_VERSION
argument_list|)
expr_stmt|;
name|xattr_cap
operator|->
name|c_abiversion
operator|=
name|cpu_to_le32
argument_list|(
name|_LINUX_CAPABILITY_VERSION
argument_list|)
expr_stmt|;
name|xattr_cap
operator|->
name|c_effective
operator|=
name|src
operator|->
name|cap_effective
expr_stmt|;
name|xattr_cap
operator|->
name|c_permitted
operator|=
name|src
operator|->
name|cap_permitted
expr_stmt|;
name|xattr_cap
operator|->
name|c_inheritable
operator|=
name|src
operator|->
name|cap_inheritable
expr_stmt|;
return|return
name|new_size
return|;
block|}
end_function

begin_function
name|int
name|xfs_cap_vget
parameter_list|(
name|xfs_vnode_t
modifier|*
name|vp
parameter_list|,
name|void
modifier|*
name|cap
parameter_list|,
name|size_t
name|size
parameter_list|)
block|{
name|int
name|error
decl_stmt|;
name|int
name|len
init|=
sizeof|sizeof
argument_list|(
name|xfs_cap_set_t
argument_list|)
decl_stmt|;
name|int
name|flags
init|=
name|ATTR_ROOT
decl_stmt|;
name|xfs_cap_set_t
name|xfs_cap
init|=
block|{
literal|0
block|}
decl_stmt|;
name|posix_cap_xattr
modifier|*
name|xattr_cap
init|=
name|cap
decl_stmt|;
name|char
modifier|*
name|data
init|=
operator|(
name|char
operator|*
operator|)
operator|&
name|xfs_cap
decl_stmt|;
name|VN_HOLD
argument_list|(
name|vp
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|error
operator|=
name|_MAC_VACCESS
argument_list|(
name|vp
argument_list|,
name|NULL
argument_list|,
name|VREAD
argument_list|)
operator|)
condition|)
goto|goto
name|out
goto|;
if|if
condition|(
operator|!
name|size
condition|)
block|{
name|flags
operator||=
name|ATTR_KERNOVAL
expr_stmt|;
name|data
operator|=
name|NULL
expr_stmt|;
block|}
name|XVOP_ATTR_GET
argument_list|(
name|vp
argument_list|,
name|SGI_CAP_LINUX
argument_list|,
name|data
argument_list|,
operator|&
name|len
argument_list|,
name|flags
argument_list|,
name|sys_cred
argument_list|,
name|error
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
goto|goto
name|out
goto|;
name|ASSERT
argument_list|(
name|len
operator|==
sizeof|sizeof
argument_list|(
name|xfs_cap_set_t
argument_list|)
argument_list|)
expr_stmt|;
name|error
operator|=
operator|(
name|size
operator|)
condition|?
operator|-
name|posix_cap_xattr_size
argument_list|()
else|:
operator|-
name|posix_cap_xfs_to_xattr
argument_list|(
operator|&
name|xfs_cap
argument_list|,
name|xattr_cap
argument_list|,
name|size
argument_list|)
expr_stmt|;
name|out
label|:
name|VN_RELE
argument_list|(
name|vp
argument_list|)
expr_stmt|;
return|return
operator|-
name|error
return|;
block|}
end_function

begin_function
name|int
name|xfs_cap_vremove
parameter_list|(
name|xfs_vnode_t
modifier|*
name|vp
parameter_list|)
block|{
name|int
name|error
decl_stmt|;
name|VN_HOLD
argument_list|(
name|vp
argument_list|)
expr_stmt|;
name|error
operator|=
name|xfs_cap_allow_set
argument_list|(
name|vp
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|error
condition|)
block|{
name|XVOP_ATTR_REMOVE
argument_list|(
name|vp
argument_list|,
name|SGI_CAP_LINUX
argument_list|,
name|ATTR_ROOT
argument_list|,
name|sys_cred
argument_list|,
name|error
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|==
name|ENOATTR
condition|)
name|error
operator|=
literal|0
expr_stmt|;
comment|/* 'scool */
block|}
name|VN_RELE
argument_list|(
name|vp
argument_list|)
expr_stmt|;
return|return
operator|-
name|error
return|;
block|}
end_function

begin_function
name|int
name|xfs_cap_vset
parameter_list|(
name|xfs_vnode_t
modifier|*
name|vp
parameter_list|,
name|void
modifier|*
name|cap
parameter_list|,
name|size_t
name|size
parameter_list|)
block|{
name|posix_cap_xattr
modifier|*
name|xattr_cap
init|=
name|cap
decl_stmt|;
name|xfs_cap_set_t
name|xfs_cap
decl_stmt|;
name|int
name|error
decl_stmt|;
if|if
condition|(
operator|!
name|cap
condition|)
return|return
operator|-
name|EINVAL
return|;
name|error
operator|=
name|posix_cap_xattr_to_xfs
argument_list|(
name|xattr_cap
argument_list|,
name|size
argument_list|,
operator|&
name|xfs_cap
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
return|return
operator|-
name|error
return|;
name|VN_HOLD
argument_list|(
name|vp
argument_list|)
expr_stmt|;
name|error
operator|=
name|xfs_cap_allow_set
argument_list|(
name|vp
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
goto|goto
name|out
goto|;
name|XVOP_ATTR_SET
argument_list|(
name|vp
argument_list|,
name|SGI_CAP_LINUX
argument_list|,
operator|(
name|char
operator|*
operator|)
operator|&
name|xfs_cap
argument_list|,
sizeof|sizeof
argument_list|(
name|xfs_cap_set_t
argument_list|)
argument_list|,
name|ATTR_ROOT
argument_list|,
name|sys_cred
argument_list|,
name|error
argument_list|)
expr_stmt|;
name|out
label|:
name|VN_RELE
argument_list|(
name|vp
argument_list|)
expr_stmt|;
return|return
operator|-
name|error
return|;
block|}
end_function

begin_function
name|STATIC
name|int
name|xfs_cap_allow_set
parameter_list|(
name|xfs_vnode_t
modifier|*
name|vp
parameter_list|)
block|{
name|vattr_t
name|va
decl_stmt|;
name|int
name|error
decl_stmt|;
if|if
condition|(
name|vp
operator|->
name|v_vfsp
operator|->
name|vfs_flag
operator|&
name|VFS_RDONLY
condition|)
return|return
name|EROFS
return|;
if|if
condition|(
name|vp
operator|->
name|v_inode
operator|.
name|i_flags
operator|&
operator|(
name|S_IMMUTABLE
operator||
name|S_APPEND
operator|)
condition|)
return|return
name|EPERM
return|;
if|if
condition|(
operator|(
name|error
operator|=
name|_MAC_VACCESS
argument_list|(
name|vp
argument_list|,
name|NULL
argument_list|,
name|VWRITE
argument_list|)
operator|)
condition|)
return|return
name|error
return|;
name|va
operator|.
name|va_mask
operator|=
name|XFS_AT_UID
expr_stmt|;
name|XVOP_GETATTR
argument_list|(
name|vp
argument_list|,
operator|&
name|va
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|,
name|error
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
return|return
name|error
return|;
if|if
condition|(
name|va
operator|.
name|va_uid
operator|!=
name|current
operator|->
name|fsuid
operator|&&
operator|!
name|capable
argument_list|(
name|CAP_FOWNER
argument_list|)
condition|)
return|return
name|EPERM
return|;
return|return
name|error
return|;
block|}
end_function

end_unit


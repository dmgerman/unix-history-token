begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * CDDL HEADER START  *  * The contents of this file are subject to the terms of the  * Common Development and Distribution License (the "License").  * You may not use this file except in compliance with the License.  *  * You can obtain a copy of the license at usr/src/OPENSOLARIS.LICENSE  * or http://www.opensolaris.org/os/licensing.  * See the License for the specific language governing permissions  * and limitations under the License.  *  * When distributing Covered Code, include this CDDL HEADER in each  * file and include the License file at usr/src/OPENSOLARIS.LICENSE.  * If applicable, add the following below this CDDL HEADER, with the  * fields enclosed by brackets "[]" replaced with your own identifying  * information: Portions Copyright [yyyy] [name of copyright owner]  *  * CDDL HEADER END  */
end_comment

begin_comment
comment|/*  * Copyright 2006 Sun Microsystems, Inc.  All rights reserved.  * Use is subject to license terms.  */
end_comment

begin_pragma
pragma|#
directive|pragma
name|ident
literal|"%Z%%M%	%I%	%E% SMI"
end_pragma

begin_comment
comment|/*  * Print intent log header and statistics.  */
end_comment

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_include
include|#
directive|include
file|<stdlib.h>
end_include

begin_include
include|#
directive|include
file|<ctype.h>
end_include

begin_include
include|#
directive|include
file|<sys/zfs_context.h>
end_include

begin_include
include|#
directive|include
file|<sys/spa.h>
end_include

begin_include
include|#
directive|include
file|<sys/dmu.h>
end_include

begin_include
include|#
directive|include
file|<sys/stat.h>
end_include

begin_include
include|#
directive|include
file|<sys/resource.h>
end_include

begin_include
include|#
directive|include
file|<sys/zil.h>
end_include

begin_include
include|#
directive|include
file|<sys/zil_impl.h>
end_include

begin_decl_stmt
specifier|extern
name|uint8_t
name|dump_opt
index|[
literal|256
index|]
decl_stmt|;
end_decl_stmt

begin_function
specifier|static
name|void
name|print_log_bp
parameter_list|(
specifier|const
name|blkptr_t
modifier|*
name|bp
parameter_list|,
specifier|const
name|char
modifier|*
name|prefix
parameter_list|)
block|{
name|char
name|blkbuf
index|[
name|BP_SPRINTF_LEN
index|]
decl_stmt|;
name|sprintf_blkptr
argument_list|(
name|blkbuf
argument_list|,
name|BP_SPRINTF_LEN
argument_list|,
name|bp
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"%s%s\n"
argument_list|,
name|prefix
argument_list|,
name|blkbuf
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* ARGSUSED */
end_comment

begin_function
specifier|static
name|void
name|zil_prt_rec_create
parameter_list|(
name|zilog_t
modifier|*
name|zilog
parameter_list|,
name|int
name|txtype
parameter_list|,
name|lr_create_t
modifier|*
name|lr
parameter_list|)
block|{
name|time_t
name|crtime
init|=
name|lr
operator|->
name|lr_crtime
index|[
literal|0
index|]
decl_stmt|;
name|char
modifier|*
name|name
init|=
operator|(
name|char
operator|*
operator|)
operator|(
name|lr
operator|+
literal|1
operator|)
decl_stmt|;
name|char
modifier|*
name|link
init|=
name|name
operator|+
name|strlen
argument_list|(
name|name
argument_list|)
operator|+
literal|1
decl_stmt|;
if|if
condition|(
name|txtype
operator|==
name|TX_SYMLINK
condition|)
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"\t\t\t%s -> %s\n"
argument_list|,
name|name
argument_list|,
name|link
argument_list|)
expr_stmt|;
else|else
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"\t\t\t%s\n"
argument_list|,
name|name
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"\t\t\t%s"
argument_list|,
name|ctime
argument_list|(
operator|&
name|crtime
argument_list|)
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"\t\t\tdoid %llu, foid %llu, mode %llo\n"
argument_list|,
operator|(
name|u_longlong_t
operator|)
name|lr
operator|->
name|lr_doid
argument_list|,
operator|(
name|u_longlong_t
operator|)
name|lr
operator|->
name|lr_foid
argument_list|,
operator|(
name|longlong_t
operator|)
name|lr
operator|->
name|lr_mode
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"\t\t\tuid %llu, gid %llu, gen %llu, rdev 0x%llx\n"
argument_list|,
operator|(
name|u_longlong_t
operator|)
name|lr
operator|->
name|lr_uid
argument_list|,
operator|(
name|u_longlong_t
operator|)
name|lr
operator|->
name|lr_gid
argument_list|,
operator|(
name|u_longlong_t
operator|)
name|lr
operator|->
name|lr_gen
argument_list|,
operator|(
name|u_longlong_t
operator|)
name|lr
operator|->
name|lr_rdev
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* ARGSUSED */
end_comment

begin_function
specifier|static
name|void
name|zil_prt_rec_remove
parameter_list|(
name|zilog_t
modifier|*
name|zilog
parameter_list|,
name|int
name|txtype
parameter_list|,
name|lr_remove_t
modifier|*
name|lr
parameter_list|)
block|{
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"\t\t\tdoid %llu, name %s\n"
argument_list|,
operator|(
name|u_longlong_t
operator|)
name|lr
operator|->
name|lr_doid
argument_list|,
operator|(
name|char
operator|*
operator|)
operator|(
name|lr
operator|+
literal|1
operator|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* ARGSUSED */
end_comment

begin_function
specifier|static
name|void
name|zil_prt_rec_link
parameter_list|(
name|zilog_t
modifier|*
name|zilog
parameter_list|,
name|int
name|txtype
parameter_list|,
name|lr_link_t
modifier|*
name|lr
parameter_list|)
block|{
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"\t\t\tdoid %llu, link_obj %llu, name %s\n"
argument_list|,
operator|(
name|u_longlong_t
operator|)
name|lr
operator|->
name|lr_doid
argument_list|,
operator|(
name|u_longlong_t
operator|)
name|lr
operator|->
name|lr_link_obj
argument_list|,
operator|(
name|char
operator|*
operator|)
operator|(
name|lr
operator|+
literal|1
operator|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* ARGSUSED */
end_comment

begin_function
specifier|static
name|void
name|zil_prt_rec_rename
parameter_list|(
name|zilog_t
modifier|*
name|zilog
parameter_list|,
name|int
name|txtype
parameter_list|,
name|lr_rename_t
modifier|*
name|lr
parameter_list|)
block|{
name|char
modifier|*
name|snm
init|=
operator|(
name|char
operator|*
operator|)
operator|(
name|lr
operator|+
literal|1
operator|)
decl_stmt|;
name|char
modifier|*
name|tnm
init|=
name|snm
operator|+
name|strlen
argument_list|(
name|snm
argument_list|)
operator|+
literal|1
decl_stmt|;
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"\t\t\tsdoid %llu, tdoid %llu\n"
argument_list|,
operator|(
name|u_longlong_t
operator|)
name|lr
operator|->
name|lr_sdoid
argument_list|,
operator|(
name|u_longlong_t
operator|)
name|lr
operator|->
name|lr_tdoid
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"\t\t\tsrc %s tgt %s\n"
argument_list|,
name|snm
argument_list|,
name|tnm
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* ARGSUSED */
end_comment

begin_function
specifier|static
name|void
name|zil_prt_rec_write
parameter_list|(
name|zilog_t
modifier|*
name|zilog
parameter_list|,
name|int
name|txtype
parameter_list|,
name|lr_write_t
modifier|*
name|lr
parameter_list|)
block|{
name|char
modifier|*
name|data
decl_stmt|,
modifier|*
name|dlimit
decl_stmt|;
name|blkptr_t
modifier|*
name|bp
init|=
operator|&
name|lr
operator|->
name|lr_blkptr
decl_stmt|;
name|char
name|buf
index|[
name|SPA_MAXBLOCKSIZE
index|]
decl_stmt|;
name|int
name|verbose
init|=
name|MAX
argument_list|(
name|dump_opt
index|[
literal|'d'
index|]
argument_list|,
name|dump_opt
index|[
literal|'i'
index|]
argument_list|)
decl_stmt|;
name|int
name|error
decl_stmt|;
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"\t\t\tfoid %llu, offset 0x%llx,"
literal|" length 0x%llx, blkoff 0x%llx\n"
argument_list|,
operator|(
name|u_longlong_t
operator|)
name|lr
operator|->
name|lr_foid
argument_list|,
operator|(
name|longlong_t
operator|)
name|lr
operator|->
name|lr_offset
argument_list|,
operator|(
name|u_longlong_t
operator|)
name|lr
operator|->
name|lr_length
argument_list|,
operator|(
name|u_longlong_t
operator|)
name|lr
operator|->
name|lr_blkoff
argument_list|)
expr_stmt|;
if|if
condition|(
name|verbose
operator|<
literal|5
condition|)
return|return;
if|if
condition|(
name|lr
operator|->
name|lr_common
operator|.
name|lrc_reclen
operator|==
sizeof|sizeof
argument_list|(
name|lr_write_t
argument_list|)
condition|)
block|{
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"\t\t\thas blkptr, %s\n"
argument_list|,
name|bp
operator|->
name|blk_birth
operator|>=
name|spa_first_txg
argument_list|(
name|zilog
operator|->
name|zl_spa
argument_list|)
condition|?
literal|"will claim"
else|:
literal|"won't claim"
argument_list|)
expr_stmt|;
name|print_log_bp
argument_list|(
name|bp
argument_list|,
literal|"\t\t\t"
argument_list|)
expr_stmt|;
if|if
condition|(
name|bp
operator|->
name|blk_birth
operator|==
literal|0
condition|)
block|{
name|bzero
argument_list|(
name|buf
argument_list|,
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|zbookmark_t
name|zb
decl_stmt|;
name|ASSERT3U
argument_list|(
name|bp
operator|->
name|blk_cksum
operator|.
name|zc_word
index|[
name|ZIL_ZC_OBJSET
index|]
argument_list|,
operator|==
argument_list|,
name|dmu_objset_id
argument_list|(
name|zilog
operator|->
name|zl_os
argument_list|)
argument_list|)
expr_stmt|;
name|zb
operator|.
name|zb_objset
operator|=
name|bp
operator|->
name|blk_cksum
operator|.
name|zc_word
index|[
name|ZIL_ZC_OBJSET
index|]
expr_stmt|;
name|zb
operator|.
name|zb_object
operator|=
literal|0
expr_stmt|;
name|zb
operator|.
name|zb_level
operator|=
operator|-
literal|1
expr_stmt|;
name|zb
operator|.
name|zb_blkid
operator|=
name|bp
operator|->
name|blk_cksum
operator|.
name|zc_word
index|[
name|ZIL_ZC_SEQ
index|]
expr_stmt|;
name|error
operator|=
name|zio_wait
argument_list|(
name|zio_read
argument_list|(
name|NULL
argument_list|,
name|zilog
operator|->
name|zl_spa
argument_list|,
name|bp
argument_list|,
name|buf
argument_list|,
name|BP_GET_LSIZE
argument_list|(
name|bp
argument_list|)
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|ZIO_PRIORITY_SYNC_READ
argument_list|,
name|ZIO_FLAG_CANFAIL
argument_list|,
operator|&
name|zb
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
return|return;
block|}
name|data
operator|=
name|buf
operator|+
name|lr
operator|->
name|lr_blkoff
expr_stmt|;
block|}
else|else
block|{
name|data
operator|=
operator|(
name|char
operator|*
operator|)
operator|(
name|lr
operator|+
literal|1
operator|)
expr_stmt|;
block|}
name|dlimit
operator|=
name|data
operator|+
name|MIN
argument_list|(
name|lr
operator|->
name|lr_length
argument_list|,
operator|(
name|verbose
operator|<
literal|6
condition|?
literal|20
else|:
name|SPA_MAXBLOCKSIZE
operator|)
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"\t\t\t"
argument_list|)
expr_stmt|;
while|while
condition|(
name|data
operator|<
name|dlimit
condition|)
block|{
if|if
condition|(
name|isprint
argument_list|(
operator|*
name|data
argument_list|)
condition|)
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"%c "
argument_list|,
operator|*
name|data
argument_list|)
expr_stmt|;
else|else
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"%2X"
argument_list|,
operator|*
name|data
argument_list|)
expr_stmt|;
name|data
operator|++
expr_stmt|;
block|}
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* ARGSUSED */
end_comment

begin_function
specifier|static
name|void
name|zil_prt_rec_truncate
parameter_list|(
name|zilog_t
modifier|*
name|zilog
parameter_list|,
name|int
name|txtype
parameter_list|,
name|lr_truncate_t
modifier|*
name|lr
parameter_list|)
block|{
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"\t\t\tfoid %llu, offset 0x%llx, length 0x%llx\n"
argument_list|,
operator|(
name|u_longlong_t
operator|)
name|lr
operator|->
name|lr_foid
argument_list|,
operator|(
name|longlong_t
operator|)
name|lr
operator|->
name|lr_offset
argument_list|,
operator|(
name|u_longlong_t
operator|)
name|lr
operator|->
name|lr_length
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* ARGSUSED */
end_comment

begin_function
specifier|static
name|void
name|zil_prt_rec_setattr
parameter_list|(
name|zilog_t
modifier|*
name|zilog
parameter_list|,
name|int
name|txtype
parameter_list|,
name|lr_setattr_t
modifier|*
name|lr
parameter_list|)
block|{
name|time_t
name|atime
init|=
operator|(
name|time_t
operator|)
name|lr
operator|->
name|lr_atime
index|[
literal|0
index|]
decl_stmt|;
name|time_t
name|mtime
init|=
operator|(
name|time_t
operator|)
name|lr
operator|->
name|lr_mtime
index|[
literal|0
index|]
decl_stmt|;
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"\t\t\tfoid %llu, mask 0x%llx\n"
argument_list|,
operator|(
name|u_longlong_t
operator|)
name|lr
operator|->
name|lr_foid
argument_list|,
operator|(
name|u_longlong_t
operator|)
name|lr
operator|->
name|lr_mask
argument_list|)
expr_stmt|;
if|if
condition|(
name|lr
operator|->
name|lr_mask
operator|&
name|AT_MODE
condition|)
block|{
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"\t\t\tAT_MODE  %llo\n"
argument_list|,
operator|(
name|longlong_t
operator|)
name|lr
operator|->
name|lr_mode
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|lr
operator|->
name|lr_mask
operator|&
name|AT_UID
condition|)
block|{
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"\t\t\tAT_UID   %llu\n"
argument_list|,
operator|(
name|u_longlong_t
operator|)
name|lr
operator|->
name|lr_uid
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|lr
operator|->
name|lr_mask
operator|&
name|AT_GID
condition|)
block|{
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"\t\t\tAT_GID   %llu\n"
argument_list|,
operator|(
name|u_longlong_t
operator|)
name|lr
operator|->
name|lr_gid
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|lr
operator|->
name|lr_mask
operator|&
name|AT_SIZE
condition|)
block|{
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"\t\t\tAT_SIZE  %llu\n"
argument_list|,
operator|(
name|u_longlong_t
operator|)
name|lr
operator|->
name|lr_size
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|lr
operator|->
name|lr_mask
operator|&
name|AT_ATIME
condition|)
block|{
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"\t\t\tAT_ATIME %llu.%09llu %s"
argument_list|,
operator|(
name|u_longlong_t
operator|)
name|lr
operator|->
name|lr_atime
index|[
literal|0
index|]
argument_list|,
operator|(
name|u_longlong_t
operator|)
name|lr
operator|->
name|lr_atime
index|[
literal|1
index|]
argument_list|,
name|ctime
argument_list|(
operator|&
name|atime
argument_list|)
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|lr
operator|->
name|lr_mask
operator|&
name|AT_MTIME
condition|)
block|{
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"\t\t\tAT_MTIME %llu.%09llu %s"
argument_list|,
operator|(
name|u_longlong_t
operator|)
name|lr
operator|->
name|lr_mtime
index|[
literal|0
index|]
argument_list|,
operator|(
name|u_longlong_t
operator|)
name|lr
operator|->
name|lr_mtime
index|[
literal|1
index|]
argument_list|,
name|ctime
argument_list|(
operator|&
name|mtime
argument_list|)
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/* ARGSUSED */
end_comment

begin_function
specifier|static
name|void
name|zil_prt_rec_acl
parameter_list|(
name|zilog_t
modifier|*
name|zilog
parameter_list|,
name|int
name|txtype
parameter_list|,
name|lr_acl_t
modifier|*
name|lr
parameter_list|)
block|{
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"\t\t\tfoid %llu, aclcnt %llu\n"
argument_list|,
operator|(
name|u_longlong_t
operator|)
name|lr
operator|->
name|lr_foid
argument_list|,
operator|(
name|u_longlong_t
operator|)
name|lr
operator|->
name|lr_aclcnt
argument_list|)
expr_stmt|;
block|}
end_function

begin_typedef
typedef|typedef
name|void
function_decl|(
modifier|*
name|zil_prt_rec_func_t
function_decl|)
parameter_list|()
function_decl|;
end_typedef

begin_typedef
typedef|typedef
struct|struct
name|zil_rec_info
block|{
name|zil_prt_rec_func_t
name|zri_print
decl_stmt|;
name|char
modifier|*
name|zri_name
decl_stmt|;
name|uint64_t
name|zri_count
decl_stmt|;
block|}
name|zil_rec_info_t
typedef|;
end_typedef

begin_decl_stmt
specifier|static
name|zil_rec_info_t
name|zil_rec_info
index|[
name|TX_MAX_TYPE
index|]
init|=
block|{
block|{
name|NULL
block|,
literal|"Total      "
block|}
block|,
block|{
name|zil_prt_rec_create
block|,
literal|"TX_CREATE  "
block|}
block|,
block|{
name|zil_prt_rec_create
block|,
literal|"TX_MKDIR   "
block|}
block|,
block|{
name|zil_prt_rec_create
block|,
literal|"TX_MKXATTR "
block|}
block|,
block|{
name|zil_prt_rec_create
block|,
literal|"TX_SYMLINK "
block|}
block|,
block|{
name|zil_prt_rec_remove
block|,
literal|"TX_REMOVE  "
block|}
block|,
block|{
name|zil_prt_rec_remove
block|,
literal|"TX_RMDIR   "
block|}
block|,
block|{
name|zil_prt_rec_link
block|,
literal|"TX_LINK    "
block|}
block|,
block|{
name|zil_prt_rec_rename
block|,
literal|"TX_RENAME  "
block|}
block|,
block|{
name|zil_prt_rec_write
block|,
literal|"TX_WRITE   "
block|}
block|,
block|{
name|zil_prt_rec_truncate
block|,
literal|"TX_TRUNCATE"
block|}
block|,
block|{
name|zil_prt_rec_setattr
block|,
literal|"TX_SETATTR "
block|}
block|,
block|{
name|zil_prt_rec_acl
block|,
literal|"TX_ACL     "
block|}
block|, }
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* ARGSUSED */
end_comment

begin_function
specifier|static
name|void
name|print_log_record
parameter_list|(
name|zilog_t
modifier|*
name|zilog
parameter_list|,
name|lr_t
modifier|*
name|lr
parameter_list|,
name|void
modifier|*
name|arg
parameter_list|,
name|uint64_t
name|claim_txg
parameter_list|)
block|{
name|int
name|txtype
decl_stmt|;
name|int
name|verbose
init|=
name|MAX
argument_list|(
name|dump_opt
index|[
literal|'d'
index|]
argument_list|,
name|dump_opt
index|[
literal|'i'
index|]
argument_list|)
decl_stmt|;
name|txtype
operator|=
name|lr
operator|->
name|lrc_txtype
expr_stmt|;
name|ASSERT
argument_list|(
name|txtype
operator|!=
literal|0
operator|&&
operator|(
name|uint_t
operator|)
name|txtype
operator|<
name|TX_MAX_TYPE
argument_list|)
expr_stmt|;
name|ASSERT
argument_list|(
name|lr
operator|->
name|lrc_txg
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"\t\t%s len %6llu, txg %llu, seq %llu\n"
argument_list|,
name|zil_rec_info
index|[
name|txtype
index|]
operator|.
name|zri_name
argument_list|,
operator|(
name|u_longlong_t
operator|)
name|lr
operator|->
name|lrc_reclen
argument_list|,
operator|(
name|u_longlong_t
operator|)
name|lr
operator|->
name|lrc_txg
argument_list|,
operator|(
name|u_longlong_t
operator|)
name|lr
operator|->
name|lrc_seq
argument_list|)
expr_stmt|;
if|if
condition|(
name|txtype
operator|&&
name|verbose
operator|>=
literal|3
condition|)
name|zil_rec_info
index|[
name|txtype
index|]
operator|.
name|zri_print
argument_list|(
name|zilog
argument_list|,
name|txtype
argument_list|,
name|lr
argument_list|)
expr_stmt|;
name|zil_rec_info
index|[
name|txtype
index|]
operator|.
name|zri_count
operator|++
expr_stmt|;
name|zil_rec_info
index|[
literal|0
index|]
operator|.
name|zri_count
operator|++
expr_stmt|;
block|}
end_function

begin_comment
comment|/* ARGSUSED */
end_comment

begin_function
specifier|static
name|void
name|print_log_block
parameter_list|(
name|zilog_t
modifier|*
name|zilog
parameter_list|,
name|blkptr_t
modifier|*
name|bp
parameter_list|,
name|void
modifier|*
name|arg
parameter_list|,
name|uint64_t
name|claim_txg
parameter_list|)
block|{
name|char
name|blkbuf
index|[
name|BP_SPRINTF_LEN
index|]
decl_stmt|;
name|int
name|verbose
init|=
name|MAX
argument_list|(
name|dump_opt
index|[
literal|'d'
index|]
argument_list|,
name|dump_opt
index|[
literal|'i'
index|]
argument_list|)
decl_stmt|;
name|char
modifier|*
name|claim
decl_stmt|;
if|if
condition|(
name|verbose
operator|<=
literal|3
condition|)
return|return;
if|if
condition|(
name|verbose
operator|>=
literal|5
condition|)
block|{
operator|(
name|void
operator|)
name|strcpy
argument_list|(
name|blkbuf
argument_list|,
literal|", "
argument_list|)
expr_stmt|;
name|sprintf_blkptr
argument_list|(
name|blkbuf
operator|+
name|strlen
argument_list|(
name|blkbuf
argument_list|)
argument_list|,
name|BP_SPRINTF_LEN
operator|-
name|strlen
argument_list|(
name|blkbuf
argument_list|)
argument_list|,
name|bp
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|blkbuf
index|[
literal|0
index|]
operator|=
literal|'\0'
expr_stmt|;
block|}
if|if
condition|(
name|claim_txg
operator|!=
literal|0
condition|)
name|claim
operator|=
literal|"already claimed"
expr_stmt|;
elseif|else
if|if
condition|(
name|bp
operator|->
name|blk_birth
operator|>=
name|spa_first_txg
argument_list|(
name|zilog
operator|->
name|zl_spa
argument_list|)
condition|)
name|claim
operator|=
literal|"will claim"
expr_stmt|;
else|else
name|claim
operator|=
literal|"won't claim"
expr_stmt|;
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"\tBlock seqno %llu, %s%s\n"
argument_list|,
operator|(
name|u_longlong_t
operator|)
name|bp
operator|->
name|blk_cksum
operator|.
name|zc_word
index|[
name|ZIL_ZC_SEQ
index|]
argument_list|,
name|claim
argument_list|,
name|blkbuf
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|print_log_stats
parameter_list|(
name|int
name|verbose
parameter_list|)
block|{
name|int
name|i
decl_stmt|,
name|w
decl_stmt|,
name|p10
decl_stmt|;
if|if
condition|(
name|verbose
operator|>
literal|3
condition|)
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
if|if
condition|(
name|zil_rec_info
index|[
literal|0
index|]
operator|.
name|zri_count
operator|==
literal|0
condition|)
return|return;
for|for
control|(
name|w
operator|=
literal|1
operator|,
name|p10
operator|=
literal|10
init|;
name|zil_rec_info
index|[
literal|0
index|]
operator|.
name|zri_count
operator|>=
name|p10
condition|;
name|p10
operator|*=
literal|10
control|)
name|w
operator|++
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|TX_MAX_TYPE
condition|;
name|i
operator|++
control|)
if|if
condition|(
name|zil_rec_info
index|[
name|i
index|]
operator|.
name|zri_count
operator|||
name|verbose
operator|>=
literal|3
condition|)
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"\t\t%s %*llu\n"
argument_list|,
name|zil_rec_info
index|[
name|i
index|]
operator|.
name|zri_name
argument_list|,
name|w
argument_list|,
operator|(
name|u_longlong_t
operator|)
name|zil_rec_info
index|[
name|i
index|]
operator|.
name|zri_count
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* ARGSUSED */
end_comment

begin_function
name|void
name|dump_intent_log
parameter_list|(
name|zilog_t
modifier|*
name|zilog
parameter_list|)
block|{
specifier|const
name|zil_header_t
modifier|*
name|zh
init|=
name|zilog
operator|->
name|zl_header
decl_stmt|;
name|int
name|verbose
init|=
name|MAX
argument_list|(
name|dump_opt
index|[
literal|'d'
index|]
argument_list|,
name|dump_opt
index|[
literal|'i'
index|]
argument_list|)
decl_stmt|;
name|int
name|i
decl_stmt|;
if|if
condition|(
name|zh
operator|->
name|zh_log
operator|.
name|blk_birth
operator|==
literal|0
operator|||
name|verbose
operator|<
literal|2
condition|)
return|return;
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"\n    ZIL header: claim_txg %llu, seq %llu\n"
argument_list|,
operator|(
name|u_longlong_t
operator|)
name|zh
operator|->
name|zh_claim_txg
argument_list|,
operator|(
name|u_longlong_t
operator|)
name|zh
operator|->
name|zh_replay_seq
argument_list|)
expr_stmt|;
if|if
condition|(
name|verbose
operator|>=
literal|4
condition|)
name|print_log_bp
argument_list|(
operator|&
name|zh
operator|->
name|zh_log
argument_list|,
literal|"\n\tfirst block: "
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|TX_MAX_TYPE
condition|;
name|i
operator|++
control|)
name|zil_rec_info
index|[
name|i
index|]
operator|.
name|zri_count
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|verbose
operator|>=
literal|2
condition|)
block|{
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|zil_parse
argument_list|(
name|zilog
argument_list|,
name|print_log_block
argument_list|,
name|print_log_record
argument_list|,
name|NULL
argument_list|,
name|zh
operator|->
name|zh_claim_txg
argument_list|)
expr_stmt|;
name|print_log_stats
argument_list|(
name|verbose
argument_list|)
expr_stmt|;
block|}
block|}
end_function

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/* ocsp.c */
end_comment

begin_comment
comment|/* Written by Dr Stephen N Henson (shenson@bigfoot.com) for the OpenSSL  * project 2000.  */
end_comment

begin_comment
comment|/* ====================================================================  * Copyright (c) 1999 The OpenSSL Project.  All rights reserved.  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions  * are met:  *  * 1. Redistributions of source code must retain the above copyright  *    notice, this list of conditions and the following disclaimer.   *  * 2. Redistributions in binary form must reproduce the above copyright  *    notice, this list of conditions and the following disclaimer in  *    the documentation and/or other materials provided with the  *    distribution.  *  * 3. All advertising materials mentioning features or use of this  *    software must display the following acknowledgment:  *    "This product includes software developed by the OpenSSL Project  *    for use in the OpenSSL Toolkit. (http://www.OpenSSL.org/)"  *  * 4. The names "OpenSSL Toolkit" and "OpenSSL Project" must not be used to  *    endorse or promote products derived from this software without  *    prior written permission. For written permission, please contact  *    licensing@OpenSSL.org.  *  * 5. Products derived from this software may not be called "OpenSSL"  *    nor may "OpenSSL" appear in their names without prior written  *    permission of the OpenSSL Project.  *  * 6. Redistributions of any form whatsoever must retain the following  *    acknowledgment:  *    "This product includes software developed by the OpenSSL Project  *    for use in the OpenSSL Toolkit (http://www.OpenSSL.org/)"  *  * THIS SOFTWARE IS PROVIDED BY THE OpenSSL PROJECT ``AS IS'' AND ANY  * EXPRESSED OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE  * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR  * PURPOSE ARE DISCLAIMED.  IN NO EVENT SHALL THE OpenSSL PROJECT OR  * ITS CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,  * SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT  * NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES;  * LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)  * HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT,  * STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE)  * ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED  * OF THE POSSIBILITY OF SUCH DAMAGE.  * ====================================================================  *  * This product includes cryptographic software written by Eric Young  * (eay@cryptsoft.com).  This product includes software written by Tim  * Hudson (tjh@cryptsoft.com).  *  */
end_comment

begin_ifndef
ifndef|#
directive|ifndef
name|OPENSSL_NO_OCSP
end_ifndef

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_include
include|#
directive|include
file|<string.h>
end_include

begin_include
include|#
directive|include
file|"apps.h"
end_include

begin_include
include|#
directive|include
file|<openssl/pem.h>
end_include

begin_include
include|#
directive|include
file|<openssl/ocsp.h>
end_include

begin_include
include|#
directive|include
file|<openssl/err.h>
end_include

begin_include
include|#
directive|include
file|<openssl/ssl.h>
end_include

begin_include
include|#
directive|include
file|<openssl/bn.h>
end_include

begin_comment
comment|/* Maximum leeway in validity period: default 5 minutes */
end_comment

begin_define
define|#
directive|define
name|MAX_VALIDITY_PERIOD
value|(5 * 60)
end_define

begin_decl_stmt
specifier|static
name|int
name|add_ocsp_cert
argument_list|(
name|OCSP_REQUEST
operator|*
operator|*
name|req
argument_list|,
name|X509
operator|*
name|cert
argument_list|,
name|X509
operator|*
name|issuer
argument_list|,
name|STACK_OF
argument_list|(
name|OCSP_CERTID
argument_list|)
operator|*
name|ids
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|add_ocsp_serial
argument_list|(
name|OCSP_REQUEST
operator|*
operator|*
name|req
argument_list|,
name|char
operator|*
name|serial
argument_list|,
name|X509
operator|*
name|issuer
argument_list|,
name|STACK_OF
argument_list|(
name|OCSP_CERTID
argument_list|)
operator|*
name|ids
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|print_ocsp_summary
argument_list|(
name|BIO
operator|*
name|out
argument_list|,
name|OCSP_BASICRESP
operator|*
name|bs
argument_list|,
name|OCSP_REQUEST
operator|*
name|req
argument_list|,
name|STACK
operator|*
name|names
argument_list|,
name|STACK_OF
argument_list|(
name|OCSP_CERTID
argument_list|)
operator|*
name|ids
argument_list|,
name|long
name|nsec
argument_list|,
name|long
name|maxage
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|make_ocsp_response
argument_list|(
name|OCSP_RESPONSE
operator|*
operator|*
name|resp
argument_list|,
name|OCSP_REQUEST
operator|*
name|req
argument_list|,
name|CA_DB
operator|*
name|db
argument_list|,
name|X509
operator|*
name|ca
argument_list|,
name|X509
operator|*
name|rcert
argument_list|,
name|EVP_PKEY
operator|*
name|rkey
argument_list|,
name|STACK_OF
argument_list|(
name|X509
argument_list|)
operator|*
name|rother
argument_list|,
name|unsigned
name|long
name|flags
argument_list|,
name|int
name|nmin
argument_list|,
name|int
name|ndays
argument_list|)
decl_stmt|;
end_decl_stmt

begin_function_decl
specifier|static
name|char
modifier|*
modifier|*
name|lookup_serial
parameter_list|(
name|CA_DB
modifier|*
name|db
parameter_list|,
name|ASN1_INTEGER
modifier|*
name|ser
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|BIO
modifier|*
name|init_responder
parameter_list|(
name|char
modifier|*
name|port
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|do_responder
parameter_list|(
name|OCSP_REQUEST
modifier|*
modifier|*
name|preq
parameter_list|,
name|BIO
modifier|*
modifier|*
name|pcbio
parameter_list|,
name|BIO
modifier|*
name|acbio
parameter_list|,
name|char
modifier|*
name|port
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|send_ocsp_response
parameter_list|(
name|BIO
modifier|*
name|cbio
parameter_list|,
name|OCSP_RESPONSE
modifier|*
name|resp
parameter_list|)
function_decl|;
end_function_decl

begin_undef
undef|#
directive|undef
name|PROG
end_undef

begin_define
define|#
directive|define
name|PROG
value|ocsp_main
end_define

begin_function_decl
name|int
name|MAIN
parameter_list|(
name|int
parameter_list|,
name|char
modifier|*
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function
name|int
name|MAIN
parameter_list|(
name|int
name|argc
parameter_list|,
name|char
modifier|*
modifier|*
name|argv
parameter_list|)
block|{
name|ENGINE
modifier|*
name|e
init|=
name|NULL
decl_stmt|;
name|char
modifier|*
modifier|*
name|args
decl_stmt|;
name|char
modifier|*
name|host
init|=
name|NULL
decl_stmt|,
modifier|*
name|port
init|=
name|NULL
decl_stmt|,
modifier|*
name|path
init|=
literal|"/"
decl_stmt|;
name|char
modifier|*
name|reqin
init|=
name|NULL
decl_stmt|,
modifier|*
name|respin
init|=
name|NULL
decl_stmt|;
name|char
modifier|*
name|reqout
init|=
name|NULL
decl_stmt|,
modifier|*
name|respout
init|=
name|NULL
decl_stmt|;
name|char
modifier|*
name|signfile
init|=
name|NULL
decl_stmt|,
modifier|*
name|keyfile
init|=
name|NULL
decl_stmt|;
name|char
modifier|*
name|rsignfile
init|=
name|NULL
decl_stmt|,
modifier|*
name|rkeyfile
init|=
name|NULL
decl_stmt|;
name|char
modifier|*
name|outfile
init|=
name|NULL
decl_stmt|;
name|int
name|add_nonce
init|=
literal|1
decl_stmt|,
name|noverify
init|=
literal|0
decl_stmt|,
name|use_ssl
init|=
operator|-
literal|1
decl_stmt|;
name|OCSP_REQUEST
modifier|*
name|req
init|=
name|NULL
decl_stmt|;
name|OCSP_RESPONSE
modifier|*
name|resp
init|=
name|NULL
decl_stmt|;
name|OCSP_BASICRESP
modifier|*
name|bs
init|=
name|NULL
decl_stmt|;
name|X509
modifier|*
name|issuer
init|=
name|NULL
decl_stmt|,
modifier|*
name|cert
init|=
name|NULL
decl_stmt|;
name|X509
modifier|*
name|signer
init|=
name|NULL
decl_stmt|,
modifier|*
name|rsigner
init|=
name|NULL
decl_stmt|;
name|EVP_PKEY
modifier|*
name|key
init|=
name|NULL
decl_stmt|,
modifier|*
name|rkey
init|=
name|NULL
decl_stmt|;
name|BIO
modifier|*
name|acbio
init|=
name|NULL
decl_stmt|,
modifier|*
name|cbio
init|=
name|NULL
decl_stmt|;
name|BIO
modifier|*
name|derbio
init|=
name|NULL
decl_stmt|;
name|BIO
modifier|*
name|out
init|=
name|NULL
decl_stmt|;
name|int
name|req_text
init|=
literal|0
decl_stmt|,
name|resp_text
init|=
literal|0
decl_stmt|;
name|long
name|nsec
init|=
name|MAX_VALIDITY_PERIOD
decl_stmt|,
name|maxage
init|=
operator|-
literal|1
decl_stmt|;
name|char
modifier|*
name|CAfile
init|=
name|NULL
decl_stmt|,
modifier|*
name|CApath
init|=
name|NULL
decl_stmt|;
name|X509_STORE
modifier|*
name|store
init|=
name|NULL
decl_stmt|;
name|SSL_CTX
modifier|*
name|ctx
init|=
name|NULL
decl_stmt|;
name|STACK_OF
argument_list|(
name|X509
argument_list|)
operator|*
name|sign_other
operator|=
name|NULL
operator|,
operator|*
name|verify_other
operator|=
name|NULL
operator|,
operator|*
name|rother
operator|=
name|NULL
expr_stmt|;
name|char
modifier|*
name|sign_certfile
init|=
name|NULL
decl_stmt|,
modifier|*
name|verify_certfile
init|=
name|NULL
decl_stmt|,
modifier|*
name|rcertfile
init|=
name|NULL
decl_stmt|;
name|unsigned
name|long
name|sign_flags
init|=
literal|0
decl_stmt|,
name|verify_flags
init|=
literal|0
decl_stmt|,
name|rflags
init|=
literal|0
decl_stmt|;
name|int
name|ret
init|=
literal|1
decl_stmt|;
name|int
name|accept_count
init|=
operator|-
literal|1
decl_stmt|;
name|int
name|badarg
init|=
literal|0
decl_stmt|;
name|int
name|i
decl_stmt|;
name|int
name|ignore_err
init|=
literal|0
decl_stmt|;
name|STACK
modifier|*
name|reqnames
init|=
name|NULL
decl_stmt|;
name|STACK_OF
argument_list|(
name|OCSP_CERTID
argument_list|)
operator|*
name|ids
operator|=
name|NULL
expr_stmt|;
name|X509
modifier|*
name|rca_cert
init|=
name|NULL
decl_stmt|;
name|char
modifier|*
name|ridx_filename
init|=
name|NULL
decl_stmt|;
name|char
modifier|*
name|rca_filename
init|=
name|NULL
decl_stmt|;
name|CA_DB
modifier|*
name|rdb
init|=
name|NULL
decl_stmt|;
name|int
name|nmin
init|=
literal|0
decl_stmt|,
name|ndays
init|=
operator|-
literal|1
decl_stmt|;
if|if
condition|(
name|bio_err
operator|==
name|NULL
condition|)
name|bio_err
operator|=
name|BIO_new_fp
argument_list|(
name|stderr
argument_list|,
name|BIO_NOCLOSE
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|load_config
argument_list|(
name|bio_err
argument_list|,
name|NULL
argument_list|)
condition|)
goto|goto
name|end
goto|;
name|SSL_load_error_strings
argument_list|()
expr_stmt|;
name|OpenSSL_add_ssl_algorithms
argument_list|()
expr_stmt|;
name|args
operator|=
name|argv
operator|+
literal|1
expr_stmt|;
name|reqnames
operator|=
name|sk_new_null
argument_list|()
expr_stmt|;
name|ids
operator|=
name|sk_OCSP_CERTID_new_null
argument_list|()
expr_stmt|;
while|while
condition|(
operator|!
name|badarg
operator|&&
operator|*
name|args
operator|&&
operator|*
name|args
index|[
literal|0
index|]
operator|==
literal|'-'
condition|)
block|{
if|if
condition|(
operator|!
name|strcmp
argument_list|(
operator|*
name|args
argument_list|,
literal|"-out"
argument_list|)
condition|)
block|{
if|if
condition|(
name|args
index|[
literal|1
index|]
condition|)
block|{
name|args
operator|++
expr_stmt|;
name|outfile
operator|=
operator|*
name|args
expr_stmt|;
block|}
else|else
name|badarg
operator|=
literal|1
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|!
name|strcmp
argument_list|(
operator|*
name|args
argument_list|,
literal|"-url"
argument_list|)
condition|)
block|{
if|if
condition|(
name|args
index|[
literal|1
index|]
condition|)
block|{
name|args
operator|++
expr_stmt|;
if|if
condition|(
operator|!
name|OCSP_parse_url
argument_list|(
operator|*
name|args
argument_list|,
operator|&
name|host
argument_list|,
operator|&
name|port
argument_list|,
operator|&
name|path
argument_list|,
operator|&
name|use_ssl
argument_list|)
condition|)
block|{
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"Error parsing URL\n"
argument_list|)
expr_stmt|;
name|badarg
operator|=
literal|1
expr_stmt|;
block|}
block|}
else|else
name|badarg
operator|=
literal|1
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|!
name|strcmp
argument_list|(
operator|*
name|args
argument_list|,
literal|"-host"
argument_list|)
condition|)
block|{
if|if
condition|(
name|args
index|[
literal|1
index|]
condition|)
block|{
name|args
operator|++
expr_stmt|;
name|host
operator|=
operator|*
name|args
expr_stmt|;
block|}
else|else
name|badarg
operator|=
literal|1
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|!
name|strcmp
argument_list|(
operator|*
name|args
argument_list|,
literal|"-port"
argument_list|)
condition|)
block|{
if|if
condition|(
name|args
index|[
literal|1
index|]
condition|)
block|{
name|args
operator|++
expr_stmt|;
name|port
operator|=
operator|*
name|args
expr_stmt|;
block|}
else|else
name|badarg
operator|=
literal|1
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|!
name|strcmp
argument_list|(
operator|*
name|args
argument_list|,
literal|"-ignore_err"
argument_list|)
condition|)
name|ignore_err
operator|=
literal|1
expr_stmt|;
elseif|else
if|if
condition|(
operator|!
name|strcmp
argument_list|(
operator|*
name|args
argument_list|,
literal|"-noverify"
argument_list|)
condition|)
name|noverify
operator|=
literal|1
expr_stmt|;
elseif|else
if|if
condition|(
operator|!
name|strcmp
argument_list|(
operator|*
name|args
argument_list|,
literal|"-nonce"
argument_list|)
condition|)
name|add_nonce
operator|=
literal|2
expr_stmt|;
elseif|else
if|if
condition|(
operator|!
name|strcmp
argument_list|(
operator|*
name|args
argument_list|,
literal|"-no_nonce"
argument_list|)
condition|)
name|add_nonce
operator|=
literal|0
expr_stmt|;
elseif|else
if|if
condition|(
operator|!
name|strcmp
argument_list|(
operator|*
name|args
argument_list|,
literal|"-resp_no_certs"
argument_list|)
condition|)
name|rflags
operator||=
name|OCSP_NOCERTS
expr_stmt|;
elseif|else
if|if
condition|(
operator|!
name|strcmp
argument_list|(
operator|*
name|args
argument_list|,
literal|"-resp_key_id"
argument_list|)
condition|)
name|rflags
operator||=
name|OCSP_RESPID_KEY
expr_stmt|;
elseif|else
if|if
condition|(
operator|!
name|strcmp
argument_list|(
operator|*
name|args
argument_list|,
literal|"-no_certs"
argument_list|)
condition|)
name|sign_flags
operator||=
name|OCSP_NOCERTS
expr_stmt|;
elseif|else
if|if
condition|(
operator|!
name|strcmp
argument_list|(
operator|*
name|args
argument_list|,
literal|"-no_signature_verify"
argument_list|)
condition|)
name|verify_flags
operator||=
name|OCSP_NOSIGS
expr_stmt|;
elseif|else
if|if
condition|(
operator|!
name|strcmp
argument_list|(
operator|*
name|args
argument_list|,
literal|"-no_cert_verify"
argument_list|)
condition|)
name|verify_flags
operator||=
name|OCSP_NOVERIFY
expr_stmt|;
elseif|else
if|if
condition|(
operator|!
name|strcmp
argument_list|(
operator|*
name|args
argument_list|,
literal|"-no_chain"
argument_list|)
condition|)
name|verify_flags
operator||=
name|OCSP_NOCHAIN
expr_stmt|;
elseif|else
if|if
condition|(
operator|!
name|strcmp
argument_list|(
operator|*
name|args
argument_list|,
literal|"-no_cert_checks"
argument_list|)
condition|)
name|verify_flags
operator||=
name|OCSP_NOCHECKS
expr_stmt|;
elseif|else
if|if
condition|(
operator|!
name|strcmp
argument_list|(
operator|*
name|args
argument_list|,
literal|"-no_explicit"
argument_list|)
condition|)
name|verify_flags
operator||=
name|OCSP_NOEXPLICIT
expr_stmt|;
elseif|else
if|if
condition|(
operator|!
name|strcmp
argument_list|(
operator|*
name|args
argument_list|,
literal|"-trust_other"
argument_list|)
condition|)
name|verify_flags
operator||=
name|OCSP_TRUSTOTHER
expr_stmt|;
elseif|else
if|if
condition|(
operator|!
name|strcmp
argument_list|(
operator|*
name|args
argument_list|,
literal|"-no_intern"
argument_list|)
condition|)
name|verify_flags
operator||=
name|OCSP_NOINTERN
expr_stmt|;
elseif|else
if|if
condition|(
operator|!
name|strcmp
argument_list|(
operator|*
name|args
argument_list|,
literal|"-text"
argument_list|)
condition|)
block|{
name|req_text
operator|=
literal|1
expr_stmt|;
name|resp_text
operator|=
literal|1
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|!
name|strcmp
argument_list|(
operator|*
name|args
argument_list|,
literal|"-req_text"
argument_list|)
condition|)
name|req_text
operator|=
literal|1
expr_stmt|;
elseif|else
if|if
condition|(
operator|!
name|strcmp
argument_list|(
operator|*
name|args
argument_list|,
literal|"-resp_text"
argument_list|)
condition|)
name|resp_text
operator|=
literal|1
expr_stmt|;
elseif|else
if|if
condition|(
operator|!
name|strcmp
argument_list|(
operator|*
name|args
argument_list|,
literal|"-reqin"
argument_list|)
condition|)
block|{
if|if
condition|(
name|args
index|[
literal|1
index|]
condition|)
block|{
name|args
operator|++
expr_stmt|;
name|reqin
operator|=
operator|*
name|args
expr_stmt|;
block|}
else|else
name|badarg
operator|=
literal|1
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|!
name|strcmp
argument_list|(
operator|*
name|args
argument_list|,
literal|"-respin"
argument_list|)
condition|)
block|{
if|if
condition|(
name|args
index|[
literal|1
index|]
condition|)
block|{
name|args
operator|++
expr_stmt|;
name|respin
operator|=
operator|*
name|args
expr_stmt|;
block|}
else|else
name|badarg
operator|=
literal|1
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|!
name|strcmp
argument_list|(
operator|*
name|args
argument_list|,
literal|"-signer"
argument_list|)
condition|)
block|{
if|if
condition|(
name|args
index|[
literal|1
index|]
condition|)
block|{
name|args
operator|++
expr_stmt|;
name|signfile
operator|=
operator|*
name|args
expr_stmt|;
block|}
else|else
name|badarg
operator|=
literal|1
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|!
name|strcmp
argument_list|(
operator|*
name|args
argument_list|,
literal|"-VAfile"
argument_list|)
condition|)
block|{
if|if
condition|(
name|args
index|[
literal|1
index|]
condition|)
block|{
name|args
operator|++
expr_stmt|;
name|verify_certfile
operator|=
operator|*
name|args
expr_stmt|;
name|verify_flags
operator||=
name|OCSP_TRUSTOTHER
expr_stmt|;
block|}
else|else
name|badarg
operator|=
literal|1
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|!
name|strcmp
argument_list|(
operator|*
name|args
argument_list|,
literal|"-sign_other"
argument_list|)
condition|)
block|{
if|if
condition|(
name|args
index|[
literal|1
index|]
condition|)
block|{
name|args
operator|++
expr_stmt|;
name|sign_certfile
operator|=
operator|*
name|args
expr_stmt|;
block|}
else|else
name|badarg
operator|=
literal|1
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|!
name|strcmp
argument_list|(
operator|*
name|args
argument_list|,
literal|"-verify_other"
argument_list|)
condition|)
block|{
if|if
condition|(
name|args
index|[
literal|1
index|]
condition|)
block|{
name|args
operator|++
expr_stmt|;
name|verify_certfile
operator|=
operator|*
name|args
expr_stmt|;
block|}
else|else
name|badarg
operator|=
literal|1
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|!
name|strcmp
argument_list|(
operator|*
name|args
argument_list|,
literal|"-CAfile"
argument_list|)
condition|)
block|{
if|if
condition|(
name|args
index|[
literal|1
index|]
condition|)
block|{
name|args
operator|++
expr_stmt|;
name|CAfile
operator|=
operator|*
name|args
expr_stmt|;
block|}
else|else
name|badarg
operator|=
literal|1
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|!
name|strcmp
argument_list|(
operator|*
name|args
argument_list|,
literal|"-CApath"
argument_list|)
condition|)
block|{
if|if
condition|(
name|args
index|[
literal|1
index|]
condition|)
block|{
name|args
operator|++
expr_stmt|;
name|CApath
operator|=
operator|*
name|args
expr_stmt|;
block|}
else|else
name|badarg
operator|=
literal|1
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|!
name|strcmp
argument_list|(
operator|*
name|args
argument_list|,
literal|"-validity_period"
argument_list|)
condition|)
block|{
if|if
condition|(
name|args
index|[
literal|1
index|]
condition|)
block|{
name|args
operator|++
expr_stmt|;
name|nsec
operator|=
name|atol
argument_list|(
operator|*
name|args
argument_list|)
expr_stmt|;
if|if
condition|(
name|nsec
operator|<
literal|0
condition|)
block|{
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"Illegal validity period %s\n"
argument_list|,
operator|*
name|args
argument_list|)
expr_stmt|;
name|badarg
operator|=
literal|1
expr_stmt|;
block|}
block|}
else|else
name|badarg
operator|=
literal|1
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|!
name|strcmp
argument_list|(
operator|*
name|args
argument_list|,
literal|"-status_age"
argument_list|)
condition|)
block|{
if|if
condition|(
name|args
index|[
literal|1
index|]
condition|)
block|{
name|args
operator|++
expr_stmt|;
name|maxage
operator|=
name|atol
argument_list|(
operator|*
name|args
argument_list|)
expr_stmt|;
if|if
condition|(
name|maxage
operator|<
literal|0
condition|)
block|{
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"Illegal validity age %s\n"
argument_list|,
operator|*
name|args
argument_list|)
expr_stmt|;
name|badarg
operator|=
literal|1
expr_stmt|;
block|}
block|}
else|else
name|badarg
operator|=
literal|1
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|!
name|strcmp
argument_list|(
operator|*
name|args
argument_list|,
literal|"-signkey"
argument_list|)
condition|)
block|{
if|if
condition|(
name|args
index|[
literal|1
index|]
condition|)
block|{
name|args
operator|++
expr_stmt|;
name|keyfile
operator|=
operator|*
name|args
expr_stmt|;
block|}
else|else
name|badarg
operator|=
literal|1
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|!
name|strcmp
argument_list|(
operator|*
name|args
argument_list|,
literal|"-reqout"
argument_list|)
condition|)
block|{
if|if
condition|(
name|args
index|[
literal|1
index|]
condition|)
block|{
name|args
operator|++
expr_stmt|;
name|reqout
operator|=
operator|*
name|args
expr_stmt|;
block|}
else|else
name|badarg
operator|=
literal|1
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|!
name|strcmp
argument_list|(
operator|*
name|args
argument_list|,
literal|"-respout"
argument_list|)
condition|)
block|{
if|if
condition|(
name|args
index|[
literal|1
index|]
condition|)
block|{
name|args
operator|++
expr_stmt|;
name|respout
operator|=
operator|*
name|args
expr_stmt|;
block|}
else|else
name|badarg
operator|=
literal|1
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|!
name|strcmp
argument_list|(
operator|*
name|args
argument_list|,
literal|"-path"
argument_list|)
condition|)
block|{
if|if
condition|(
name|args
index|[
literal|1
index|]
condition|)
block|{
name|args
operator|++
expr_stmt|;
name|path
operator|=
operator|*
name|args
expr_stmt|;
block|}
else|else
name|badarg
operator|=
literal|1
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|!
name|strcmp
argument_list|(
operator|*
name|args
argument_list|,
literal|"-issuer"
argument_list|)
condition|)
block|{
if|if
condition|(
name|args
index|[
literal|1
index|]
condition|)
block|{
name|args
operator|++
expr_stmt|;
name|X509_free
argument_list|(
name|issuer
argument_list|)
expr_stmt|;
name|issuer
operator|=
name|load_cert
argument_list|(
name|bio_err
argument_list|,
operator|*
name|args
argument_list|,
name|FORMAT_PEM
argument_list|,
name|NULL
argument_list|,
name|e
argument_list|,
literal|"issuer certificate"
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|issuer
condition|)
goto|goto
name|end
goto|;
block|}
else|else
name|badarg
operator|=
literal|1
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|!
name|strcmp
argument_list|(
operator|*
name|args
argument_list|,
literal|"-cert"
argument_list|)
condition|)
block|{
if|if
condition|(
name|args
index|[
literal|1
index|]
condition|)
block|{
name|args
operator|++
expr_stmt|;
name|X509_free
argument_list|(
name|cert
argument_list|)
expr_stmt|;
name|cert
operator|=
name|load_cert
argument_list|(
name|bio_err
argument_list|,
operator|*
name|args
argument_list|,
name|FORMAT_PEM
argument_list|,
name|NULL
argument_list|,
name|e
argument_list|,
literal|"certificate"
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|cert
condition|)
goto|goto
name|end
goto|;
if|if
condition|(
operator|!
name|add_ocsp_cert
argument_list|(
operator|&
name|req
argument_list|,
name|cert
argument_list|,
name|issuer
argument_list|,
name|ids
argument_list|)
condition|)
goto|goto
name|end
goto|;
if|if
condition|(
operator|!
name|sk_push
argument_list|(
name|reqnames
argument_list|,
operator|*
name|args
argument_list|)
condition|)
goto|goto
name|end
goto|;
block|}
else|else
name|badarg
operator|=
literal|1
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|!
name|strcmp
argument_list|(
operator|*
name|args
argument_list|,
literal|"-serial"
argument_list|)
condition|)
block|{
if|if
condition|(
name|args
index|[
literal|1
index|]
condition|)
block|{
name|args
operator|++
expr_stmt|;
if|if
condition|(
operator|!
name|add_ocsp_serial
argument_list|(
operator|&
name|req
argument_list|,
operator|*
name|args
argument_list|,
name|issuer
argument_list|,
name|ids
argument_list|)
condition|)
goto|goto
name|end
goto|;
if|if
condition|(
operator|!
name|sk_push
argument_list|(
name|reqnames
argument_list|,
operator|*
name|args
argument_list|)
condition|)
goto|goto
name|end
goto|;
block|}
else|else
name|badarg
operator|=
literal|1
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|!
name|strcmp
argument_list|(
operator|*
name|args
argument_list|,
literal|"-index"
argument_list|)
condition|)
block|{
if|if
condition|(
name|args
index|[
literal|1
index|]
condition|)
block|{
name|args
operator|++
expr_stmt|;
name|ridx_filename
operator|=
operator|*
name|args
expr_stmt|;
block|}
else|else
name|badarg
operator|=
literal|1
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|!
name|strcmp
argument_list|(
operator|*
name|args
argument_list|,
literal|"-CA"
argument_list|)
condition|)
block|{
if|if
condition|(
name|args
index|[
literal|1
index|]
condition|)
block|{
name|args
operator|++
expr_stmt|;
name|rca_filename
operator|=
operator|*
name|args
expr_stmt|;
block|}
else|else
name|badarg
operator|=
literal|1
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|!
name|strcmp
argument_list|(
operator|*
name|args
argument_list|,
literal|"-nmin"
argument_list|)
condition|)
block|{
if|if
condition|(
name|args
index|[
literal|1
index|]
condition|)
block|{
name|args
operator|++
expr_stmt|;
name|nmin
operator|=
name|atol
argument_list|(
operator|*
name|args
argument_list|)
expr_stmt|;
if|if
condition|(
name|nmin
operator|<
literal|0
condition|)
block|{
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"Illegal update period %s\n"
argument_list|,
operator|*
name|args
argument_list|)
expr_stmt|;
name|badarg
operator|=
literal|1
expr_stmt|;
block|}
block|}
if|if
condition|(
name|ndays
operator|==
operator|-
literal|1
condition|)
name|ndays
operator|=
literal|0
expr_stmt|;
else|else
name|badarg
operator|=
literal|1
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|!
name|strcmp
argument_list|(
operator|*
name|args
argument_list|,
literal|"-nrequest"
argument_list|)
condition|)
block|{
if|if
condition|(
name|args
index|[
literal|1
index|]
condition|)
block|{
name|args
operator|++
expr_stmt|;
name|accept_count
operator|=
name|atol
argument_list|(
operator|*
name|args
argument_list|)
expr_stmt|;
if|if
condition|(
name|accept_count
operator|<
literal|0
condition|)
block|{
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"Illegal accept count %s\n"
argument_list|,
operator|*
name|args
argument_list|)
expr_stmt|;
name|badarg
operator|=
literal|1
expr_stmt|;
block|}
block|}
else|else
name|badarg
operator|=
literal|1
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|!
name|strcmp
argument_list|(
operator|*
name|args
argument_list|,
literal|"-ndays"
argument_list|)
condition|)
block|{
if|if
condition|(
name|args
index|[
literal|1
index|]
condition|)
block|{
name|args
operator|++
expr_stmt|;
name|ndays
operator|=
name|atol
argument_list|(
operator|*
name|args
argument_list|)
expr_stmt|;
if|if
condition|(
name|ndays
operator|<
literal|0
condition|)
block|{
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"Illegal update period %s\n"
argument_list|,
operator|*
name|args
argument_list|)
expr_stmt|;
name|badarg
operator|=
literal|1
expr_stmt|;
block|}
block|}
else|else
name|badarg
operator|=
literal|1
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|!
name|strcmp
argument_list|(
operator|*
name|args
argument_list|,
literal|"-rsigner"
argument_list|)
condition|)
block|{
if|if
condition|(
name|args
index|[
literal|1
index|]
condition|)
block|{
name|args
operator|++
expr_stmt|;
name|rsignfile
operator|=
operator|*
name|args
expr_stmt|;
block|}
else|else
name|badarg
operator|=
literal|1
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|!
name|strcmp
argument_list|(
operator|*
name|args
argument_list|,
literal|"-rkey"
argument_list|)
condition|)
block|{
if|if
condition|(
name|args
index|[
literal|1
index|]
condition|)
block|{
name|args
operator|++
expr_stmt|;
name|rkeyfile
operator|=
operator|*
name|args
expr_stmt|;
block|}
else|else
name|badarg
operator|=
literal|1
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|!
name|strcmp
argument_list|(
operator|*
name|args
argument_list|,
literal|"-rother"
argument_list|)
condition|)
block|{
if|if
condition|(
name|args
index|[
literal|1
index|]
condition|)
block|{
name|args
operator|++
expr_stmt|;
name|rcertfile
operator|=
operator|*
name|args
expr_stmt|;
block|}
else|else
name|badarg
operator|=
literal|1
expr_stmt|;
block|}
else|else
name|badarg
operator|=
literal|1
expr_stmt|;
name|args
operator|++
expr_stmt|;
block|}
comment|/* Have we anything to do? */
if|if
condition|(
operator|!
name|req
operator|&&
operator|!
name|reqin
operator|&&
operator|!
name|respin
operator|&&
operator|!
operator|(
name|port
operator|&&
name|ridx_filename
operator|)
condition|)
name|badarg
operator|=
literal|1
expr_stmt|;
if|if
condition|(
name|badarg
condition|)
block|{
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"OCSP utility\n"
argument_list|)
expr_stmt|;
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"Usage ocsp [options]\n"
argument_list|)
expr_stmt|;
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"where options are\n"
argument_list|)
expr_stmt|;
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"-out file          output filename\n"
argument_list|)
expr_stmt|;
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"-issuer file       issuer certificate\n"
argument_list|)
expr_stmt|;
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"-cert file         certificate to check\n"
argument_list|)
expr_stmt|;
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"-serial n          serial number to check\n"
argument_list|)
expr_stmt|;
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"-signer file       certificate to sign OCSP request with\n"
argument_list|)
expr_stmt|;
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"-signkey file      private key to sign OCSP request with\n"
argument_list|)
expr_stmt|;
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"-sign_other file   additional certificates to include in signed request\n"
argument_list|)
expr_stmt|;
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"-no_certs          don't include any certificates in signed request\n"
argument_list|)
expr_stmt|;
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"-req_text          print text form of request\n"
argument_list|)
expr_stmt|;
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"-resp_text         print text form of response\n"
argument_list|)
expr_stmt|;
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"-text              print text form of request and response\n"
argument_list|)
expr_stmt|;
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"-reqout file       write DER encoded OCSP request to \"file\"\n"
argument_list|)
expr_stmt|;
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"-respout file      write DER encoded OCSP reponse to \"file\"\n"
argument_list|)
expr_stmt|;
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"-reqin file        read DER encoded OCSP request from \"file\"\n"
argument_list|)
expr_stmt|;
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"-respin file       read DER encoded OCSP reponse from \"file\"\n"
argument_list|)
expr_stmt|;
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"-nonce             add OCSP nonce to request\n"
argument_list|)
expr_stmt|;
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"-no_nonce          don't add OCSP nonce to request\n"
argument_list|)
expr_stmt|;
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"-url URL           OCSP responder URL\n"
argument_list|)
expr_stmt|;
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"-host host:n       send OCSP request to host on port n\n"
argument_list|)
expr_stmt|;
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"-path              path to use in OCSP request\n"
argument_list|)
expr_stmt|;
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"-CApath dir        trusted certificates directory\n"
argument_list|)
expr_stmt|;
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"-CAfile file       trusted certificates file\n"
argument_list|)
expr_stmt|;
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"-VAfile file       validator certificates file\n"
argument_list|)
expr_stmt|;
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"-validity_period n maximum validity discrepancy in seconds\n"
argument_list|)
expr_stmt|;
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"-status_age n      maximum status age in seconds\n"
argument_list|)
expr_stmt|;
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"-noverify          don't verify response at all\n"
argument_list|)
expr_stmt|;
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"-verify_other file additional certificates to search for signer\n"
argument_list|)
expr_stmt|;
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"-trust_other       don't verify additional certificates\n"
argument_list|)
expr_stmt|;
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"-no_intern         don't search certificates contained in response for signer\n"
argument_list|)
expr_stmt|;
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"-no_signature_verify don't check signature on response\n"
argument_list|)
expr_stmt|;
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"-no_cert_verify    don't check signing certificate\n"
argument_list|)
expr_stmt|;
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"-no_chain          don't chain verify response\n"
argument_list|)
expr_stmt|;
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"-no_cert_checks    don't do additional checks on signing certificate\n"
argument_list|)
expr_stmt|;
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"-port num		 port to run responder on\n"
argument_list|)
expr_stmt|;
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"-index file	 certificate status index file\n"
argument_list|)
expr_stmt|;
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"-CA file		 CA certificate\n"
argument_list|)
expr_stmt|;
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"-rsigner file	 responder certificate to sign responses with\n"
argument_list|)
expr_stmt|;
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"-rkey file	 responder key to sign responses with\n"
argument_list|)
expr_stmt|;
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"-rother file	 other certificates to include in response\n"
argument_list|)
expr_stmt|;
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"-resp_no_certs     don't include any certificates in response\n"
argument_list|)
expr_stmt|;
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"-nmin n	 	 number of minutes before next update\n"
argument_list|)
expr_stmt|;
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"-ndays n	 	 number of days before next update\n"
argument_list|)
expr_stmt|;
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"-resp_key_id       identify reponse by signing certificate key ID\n"
argument_list|)
expr_stmt|;
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"-nrequest n        number of requests to accept (default unlimited)\n"
argument_list|)
expr_stmt|;
goto|goto
name|end
goto|;
block|}
if|if
condition|(
name|outfile
condition|)
name|out
operator|=
name|BIO_new_file
argument_list|(
name|outfile
argument_list|,
literal|"w"
argument_list|)
expr_stmt|;
else|else
name|out
operator|=
name|BIO_new_fp
argument_list|(
name|stdout
argument_list|,
name|BIO_NOCLOSE
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|out
condition|)
block|{
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"Error opening output file\n"
argument_list|)
expr_stmt|;
goto|goto
name|end
goto|;
block|}
if|if
condition|(
operator|!
name|req
operator|&&
operator|(
name|add_nonce
operator|!=
literal|2
operator|)
condition|)
name|add_nonce
operator|=
literal|0
expr_stmt|;
if|if
condition|(
operator|!
name|req
operator|&&
name|reqin
condition|)
block|{
name|derbio
operator|=
name|BIO_new_file
argument_list|(
name|reqin
argument_list|,
literal|"rb"
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|derbio
condition|)
block|{
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"Error Opening OCSP request file\n"
argument_list|)
expr_stmt|;
goto|goto
name|end
goto|;
block|}
name|req
operator|=
name|d2i_OCSP_REQUEST_bio
argument_list|(
name|derbio
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|BIO_free
argument_list|(
name|derbio
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|req
condition|)
block|{
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"Error reading OCSP request\n"
argument_list|)
expr_stmt|;
goto|goto
name|end
goto|;
block|}
block|}
if|if
condition|(
operator|!
name|req
operator|&&
name|port
condition|)
block|{
name|acbio
operator|=
name|init_responder
argument_list|(
name|port
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|acbio
condition|)
goto|goto
name|end
goto|;
block|}
if|if
condition|(
name|rsignfile
operator|&&
operator|!
name|rdb
condition|)
block|{
if|if
condition|(
operator|!
name|rkeyfile
condition|)
name|rkeyfile
operator|=
name|rsignfile
expr_stmt|;
name|rsigner
operator|=
name|load_cert
argument_list|(
name|bio_err
argument_list|,
name|rsignfile
argument_list|,
name|FORMAT_PEM
argument_list|,
name|NULL
argument_list|,
name|e
argument_list|,
literal|"responder certificate"
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|rsigner
condition|)
block|{
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"Error loading responder certificate\n"
argument_list|)
expr_stmt|;
goto|goto
name|end
goto|;
block|}
name|rca_cert
operator|=
name|load_cert
argument_list|(
name|bio_err
argument_list|,
name|rca_filename
argument_list|,
name|FORMAT_PEM
argument_list|,
name|NULL
argument_list|,
name|e
argument_list|,
literal|"CA certificate"
argument_list|)
expr_stmt|;
if|if
condition|(
name|rcertfile
condition|)
block|{
name|rother
operator|=
name|load_certs
argument_list|(
name|bio_err
argument_list|,
name|rcertfile
argument_list|,
name|FORMAT_PEM
argument_list|,
name|NULL
argument_list|,
name|e
argument_list|,
literal|"responder other certificates"
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|rother
condition|)
goto|goto
name|end
goto|;
block|}
name|rkey
operator|=
name|load_key
argument_list|(
name|bio_err
argument_list|,
name|rkeyfile
argument_list|,
name|FORMAT_PEM
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
literal|"responder private key"
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|rkey
condition|)
goto|goto
name|end
goto|;
block|}
if|if
condition|(
name|acbio
condition|)
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"Waiting for OCSP client connections...\n"
argument_list|)
expr_stmt|;
name|redo_accept
label|:
if|if
condition|(
name|acbio
condition|)
block|{
if|if
condition|(
operator|!
name|do_responder
argument_list|(
operator|&
name|req
argument_list|,
operator|&
name|cbio
argument_list|,
name|acbio
argument_list|,
name|port
argument_list|)
condition|)
goto|goto
name|end
goto|;
if|if
condition|(
operator|!
name|req
condition|)
block|{
name|resp
operator|=
name|OCSP_response_create
argument_list|(
name|OCSP_RESPONSE_STATUS_MALFORMEDREQUEST
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|send_ocsp_response
argument_list|(
name|cbio
argument_list|,
name|resp
argument_list|)
expr_stmt|;
goto|goto
name|done_resp
goto|;
block|}
block|}
if|if
condition|(
operator|!
name|req
operator|&&
operator|(
name|signfile
operator|||
name|reqout
operator|||
name|host
operator|||
name|add_nonce
operator|||
name|ridx_filename
operator|)
condition|)
block|{
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"Need an OCSP request for this operation!\n"
argument_list|)
expr_stmt|;
goto|goto
name|end
goto|;
block|}
if|if
condition|(
name|req
operator|&&
name|add_nonce
condition|)
name|OCSP_request_add1_nonce
argument_list|(
name|req
argument_list|,
name|NULL
argument_list|,
operator|-
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|signfile
condition|)
block|{
if|if
condition|(
operator|!
name|keyfile
condition|)
name|keyfile
operator|=
name|signfile
expr_stmt|;
name|signer
operator|=
name|load_cert
argument_list|(
name|bio_err
argument_list|,
name|signfile
argument_list|,
name|FORMAT_PEM
argument_list|,
name|NULL
argument_list|,
name|e
argument_list|,
literal|"signer certificate"
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|signer
condition|)
block|{
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"Error loading signer certificate\n"
argument_list|)
expr_stmt|;
goto|goto
name|end
goto|;
block|}
if|if
condition|(
name|sign_certfile
condition|)
block|{
name|sign_other
operator|=
name|load_certs
argument_list|(
name|bio_err
argument_list|,
name|sign_certfile
argument_list|,
name|FORMAT_PEM
argument_list|,
name|NULL
argument_list|,
name|e
argument_list|,
literal|"signer certificates"
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|sign_other
condition|)
goto|goto
name|end
goto|;
block|}
name|key
operator|=
name|load_key
argument_list|(
name|bio_err
argument_list|,
name|keyfile
argument_list|,
name|FORMAT_PEM
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
literal|"signer private key"
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|key
condition|)
goto|goto
name|end
goto|;
if|if
condition|(
operator|!
name|OCSP_request_sign
argument_list|(
name|req
argument_list|,
name|signer
argument_list|,
name|key
argument_list|,
name|EVP_sha1
argument_list|()
argument_list|,
name|sign_other
argument_list|,
name|sign_flags
argument_list|)
condition|)
block|{
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"Error signing OCSP request\n"
argument_list|)
expr_stmt|;
goto|goto
name|end
goto|;
block|}
block|}
if|if
condition|(
name|req_text
operator|&&
name|req
condition|)
name|OCSP_REQUEST_print
argument_list|(
name|out
argument_list|,
name|req
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|reqout
condition|)
block|{
name|derbio
operator|=
name|BIO_new_file
argument_list|(
name|reqout
argument_list|,
literal|"wb"
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|derbio
condition|)
block|{
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"Error opening file %s\n"
argument_list|,
name|reqout
argument_list|)
expr_stmt|;
goto|goto
name|end
goto|;
block|}
name|i2d_OCSP_REQUEST_bio
argument_list|(
name|derbio
argument_list|,
name|req
argument_list|)
expr_stmt|;
name|BIO_free
argument_list|(
name|derbio
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|ridx_filename
operator|&&
operator|(
operator|!
name|rkey
operator|||
operator|!
name|rsigner
operator|||
operator|!
name|rca_cert
operator|)
condition|)
block|{
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"Need a responder certificate, key and CA for this operation!\n"
argument_list|)
expr_stmt|;
goto|goto
name|end
goto|;
block|}
if|if
condition|(
name|ridx_filename
operator|&&
operator|!
name|rdb
condition|)
block|{
name|rdb
operator|=
name|load_index
argument_list|(
name|ridx_filename
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|rdb
condition|)
goto|goto
name|end
goto|;
if|if
condition|(
operator|!
name|index_index
argument_list|(
name|rdb
argument_list|)
condition|)
goto|goto
name|end
goto|;
block|}
if|if
condition|(
name|rdb
condition|)
block|{
name|i
operator|=
name|make_ocsp_response
argument_list|(
operator|&
name|resp
argument_list|,
name|req
argument_list|,
name|rdb
argument_list|,
name|rca_cert
argument_list|,
name|rsigner
argument_list|,
name|rkey
argument_list|,
name|rother
argument_list|,
name|rflags
argument_list|,
name|nmin
argument_list|,
name|ndays
argument_list|)
expr_stmt|;
if|if
condition|(
name|cbio
condition|)
name|send_ocsp_response
argument_list|(
name|cbio
argument_list|,
name|resp
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|host
condition|)
block|{
ifndef|#
directive|ifndef
name|OPENSSL_NO_SOCK
name|cbio
operator|=
name|BIO_new_connect
argument_list|(
name|host
argument_list|)
expr_stmt|;
else|#
directive|else
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"Error creating connect BIO - sockets not supported.\n"
argument_list|)
expr_stmt|;
goto|goto
name|end
goto|;
endif|#
directive|endif
if|if
condition|(
operator|!
name|cbio
condition|)
block|{
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"Error creating connect BIO\n"
argument_list|)
expr_stmt|;
goto|goto
name|end
goto|;
block|}
if|if
condition|(
name|port
condition|)
name|BIO_set_conn_port
argument_list|(
name|cbio
argument_list|,
name|port
argument_list|)
expr_stmt|;
if|if
condition|(
name|use_ssl
operator|==
literal|1
condition|)
block|{
name|BIO
modifier|*
name|sbio
decl_stmt|;
if|#
directive|if
operator|!
name|defined
argument_list|(
name|OPENSSL_NO_SSL2
argument_list|)
operator|&&
operator|!
name|defined
argument_list|(
name|OPENSSL_NO_SSL3
argument_list|)
name|ctx
operator|=
name|SSL_CTX_new
argument_list|(
name|SSLv23_client_method
argument_list|()
argument_list|)
expr_stmt|;
elif|#
directive|elif
operator|!
name|defined
argument_list|(
name|OPENSSL_NO_SSL3
argument_list|)
name|ctx
operator|=
name|SSL_CTX_new
argument_list|(
name|SSLv3_client_method
argument_list|()
argument_list|)
expr_stmt|;
elif|#
directive|elif
operator|!
name|defined
argument_list|(
name|OPENSSL_NO_SSL2
argument_list|)
name|ctx
operator|=
name|SSL_CTX_new
argument_list|(
name|SSLv2_client_method
argument_list|()
argument_list|)
expr_stmt|;
else|#
directive|else
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"SSL is disabled\n"
argument_list|)
expr_stmt|;
goto|goto
name|end
goto|;
endif|#
directive|endif
if|if
condition|(
name|ctx
operator|==
name|NULL
condition|)
block|{
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"Error creating SSL context.\n"
argument_list|)
expr_stmt|;
goto|goto
name|end
goto|;
block|}
name|SSL_CTX_set_mode
argument_list|(
name|ctx
argument_list|,
name|SSL_MODE_AUTO_RETRY
argument_list|)
expr_stmt|;
name|sbio
operator|=
name|BIO_new_ssl
argument_list|(
name|ctx
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|cbio
operator|=
name|BIO_push
argument_list|(
name|sbio
argument_list|,
name|cbio
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|BIO_do_connect
argument_list|(
name|cbio
argument_list|)
operator|<=
literal|0
condition|)
block|{
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"Error connecting BIO\n"
argument_list|)
expr_stmt|;
goto|goto
name|end
goto|;
block|}
name|resp
operator|=
name|OCSP_sendreq_bio
argument_list|(
name|cbio
argument_list|,
name|path
argument_list|,
name|req
argument_list|)
expr_stmt|;
name|BIO_free_all
argument_list|(
name|cbio
argument_list|)
expr_stmt|;
name|cbio
operator|=
name|NULL
expr_stmt|;
if|if
condition|(
operator|!
name|resp
condition|)
block|{
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"Error querying OCSP responsder\n"
argument_list|)
expr_stmt|;
goto|goto
name|end
goto|;
block|}
block|}
elseif|else
if|if
condition|(
name|respin
condition|)
block|{
name|derbio
operator|=
name|BIO_new_file
argument_list|(
name|respin
argument_list|,
literal|"rb"
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|derbio
condition|)
block|{
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"Error Opening OCSP response file\n"
argument_list|)
expr_stmt|;
goto|goto
name|end
goto|;
block|}
name|resp
operator|=
name|d2i_OCSP_RESPONSE_bio
argument_list|(
name|derbio
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|BIO_free
argument_list|(
name|derbio
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|resp
condition|)
block|{
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"Error reading OCSP response\n"
argument_list|)
expr_stmt|;
goto|goto
name|end
goto|;
block|}
block|}
else|else
block|{
name|ret
operator|=
literal|0
expr_stmt|;
goto|goto
name|end
goto|;
block|}
name|done_resp
label|:
if|if
condition|(
name|respout
condition|)
block|{
name|derbio
operator|=
name|BIO_new_file
argument_list|(
name|respout
argument_list|,
literal|"wb"
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|derbio
condition|)
block|{
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"Error opening file %s\n"
argument_list|,
name|respout
argument_list|)
expr_stmt|;
goto|goto
name|end
goto|;
block|}
name|i2d_OCSP_RESPONSE_bio
argument_list|(
name|derbio
argument_list|,
name|resp
argument_list|)
expr_stmt|;
name|BIO_free
argument_list|(
name|derbio
argument_list|)
expr_stmt|;
block|}
name|i
operator|=
name|OCSP_response_status
argument_list|(
name|resp
argument_list|)
expr_stmt|;
if|if
condition|(
name|i
operator|!=
name|OCSP_RESPONSE_STATUS_SUCCESSFUL
condition|)
block|{
name|BIO_printf
argument_list|(
name|out
argument_list|,
literal|"Responder Error: %s (%d)\n"
argument_list|,
name|OCSP_response_status_str
argument_list|(
name|i
argument_list|)
argument_list|,
name|i
argument_list|)
expr_stmt|;
if|if
condition|(
name|ignore_err
condition|)
goto|goto
name|redo_accept
goto|;
name|ret
operator|=
literal|0
expr_stmt|;
goto|goto
name|end
goto|;
block|}
if|if
condition|(
name|resp_text
condition|)
name|OCSP_RESPONSE_print
argument_list|(
name|out
argument_list|,
name|resp
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* If running as responder don't verify our own response */
if|if
condition|(
name|cbio
condition|)
block|{
if|if
condition|(
name|accept_count
operator|>
literal|0
condition|)
name|accept_count
operator|--
expr_stmt|;
comment|/* Redo if more connections needed */
if|if
condition|(
name|accept_count
condition|)
block|{
name|BIO_free_all
argument_list|(
name|cbio
argument_list|)
expr_stmt|;
name|cbio
operator|=
name|NULL
expr_stmt|;
name|OCSP_REQUEST_free
argument_list|(
name|req
argument_list|)
expr_stmt|;
name|req
operator|=
name|NULL
expr_stmt|;
name|OCSP_RESPONSE_free
argument_list|(
name|resp
argument_list|)
expr_stmt|;
name|resp
operator|=
name|NULL
expr_stmt|;
goto|goto
name|redo_accept
goto|;
block|}
goto|goto
name|end
goto|;
block|}
if|if
condition|(
operator|!
name|store
condition|)
name|store
operator|=
name|setup_verify
argument_list|(
name|bio_err
argument_list|,
name|CAfile
argument_list|,
name|CApath
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|store
condition|)
goto|goto
name|end
goto|;
if|if
condition|(
name|verify_certfile
condition|)
block|{
name|verify_other
operator|=
name|load_certs
argument_list|(
name|bio_err
argument_list|,
name|verify_certfile
argument_list|,
name|FORMAT_PEM
argument_list|,
name|NULL
argument_list|,
name|e
argument_list|,
literal|"validator certificate"
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|verify_other
condition|)
goto|goto
name|end
goto|;
block|}
name|bs
operator|=
name|OCSP_response_get1_basic
argument_list|(
name|resp
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|bs
condition|)
block|{
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"Error parsing response\n"
argument_list|)
expr_stmt|;
goto|goto
name|end
goto|;
block|}
if|if
condition|(
operator|!
name|noverify
condition|)
block|{
if|if
condition|(
name|req
operator|&&
operator|(
operator|(
name|i
operator|=
name|OCSP_check_nonce
argument_list|(
name|req
argument_list|,
name|bs
argument_list|)
operator|)
operator|<=
literal|0
operator|)
condition|)
block|{
if|if
condition|(
name|i
operator|==
operator|-
literal|1
condition|)
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"WARNING: no nonce in response\n"
argument_list|)
expr_stmt|;
else|else
block|{
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"Nonce Verify error\n"
argument_list|)
expr_stmt|;
goto|goto
name|end
goto|;
block|}
block|}
name|i
operator|=
name|OCSP_basic_verify
argument_list|(
name|bs
argument_list|,
name|verify_other
argument_list|,
name|store
argument_list|,
name|verify_flags
argument_list|)
expr_stmt|;
if|if
condition|(
name|i
operator|<
literal|0
condition|)
name|i
operator|=
name|OCSP_basic_verify
argument_list|(
name|bs
argument_list|,
name|NULL
argument_list|,
name|store
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|i
operator|<=
literal|0
condition|)
block|{
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"Response Verify Failure\n"
argument_list|)
expr_stmt|;
name|ERR_print_errors
argument_list|(
name|bio_err
argument_list|)
expr_stmt|;
block|}
else|else
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"Response verify OK\n"
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|print_ocsp_summary
argument_list|(
name|out
argument_list|,
name|bs
argument_list|,
name|req
argument_list|,
name|reqnames
argument_list|,
name|ids
argument_list|,
name|nsec
argument_list|,
name|maxage
argument_list|)
condition|)
goto|goto
name|end
goto|;
name|ret
operator|=
literal|0
expr_stmt|;
name|end
label|:
name|ERR_print_errors
argument_list|(
name|bio_err
argument_list|)
expr_stmt|;
name|X509_free
argument_list|(
name|signer
argument_list|)
expr_stmt|;
name|X509_STORE_free
argument_list|(
name|store
argument_list|)
expr_stmt|;
name|EVP_PKEY_free
argument_list|(
name|key
argument_list|)
expr_stmt|;
name|EVP_PKEY_free
argument_list|(
name|rkey
argument_list|)
expr_stmt|;
name|X509_free
argument_list|(
name|issuer
argument_list|)
expr_stmt|;
name|X509_free
argument_list|(
name|cert
argument_list|)
expr_stmt|;
name|X509_free
argument_list|(
name|rsigner
argument_list|)
expr_stmt|;
name|X509_free
argument_list|(
name|rca_cert
argument_list|)
expr_stmt|;
name|free_index
argument_list|(
name|rdb
argument_list|)
expr_stmt|;
name|BIO_free_all
argument_list|(
name|cbio
argument_list|)
expr_stmt|;
name|BIO_free_all
argument_list|(
name|acbio
argument_list|)
expr_stmt|;
name|BIO_free
argument_list|(
name|out
argument_list|)
expr_stmt|;
name|OCSP_REQUEST_free
argument_list|(
name|req
argument_list|)
expr_stmt|;
name|OCSP_RESPONSE_free
argument_list|(
name|resp
argument_list|)
expr_stmt|;
name|OCSP_BASICRESP_free
argument_list|(
name|bs
argument_list|)
expr_stmt|;
name|sk_free
argument_list|(
name|reqnames
argument_list|)
expr_stmt|;
name|sk_OCSP_CERTID_free
argument_list|(
name|ids
argument_list|)
expr_stmt|;
name|sk_X509_pop_free
argument_list|(
name|sign_other
argument_list|,
name|X509_free
argument_list|)
expr_stmt|;
name|sk_X509_pop_free
argument_list|(
name|verify_other
argument_list|,
name|X509_free
argument_list|)
expr_stmt|;
if|if
condition|(
name|use_ssl
operator|!=
operator|-
literal|1
condition|)
block|{
name|OPENSSL_free
argument_list|(
name|host
argument_list|)
expr_stmt|;
name|OPENSSL_free
argument_list|(
name|port
argument_list|)
expr_stmt|;
name|OPENSSL_free
argument_list|(
name|path
argument_list|)
expr_stmt|;
name|SSL_CTX_free
argument_list|(
name|ctx
argument_list|)
expr_stmt|;
block|}
name|OPENSSL_EXIT
argument_list|(
name|ret
argument_list|)
expr_stmt|;
block|}
end_function

begin_decl_stmt
specifier|static
name|int
name|add_ocsp_cert
argument_list|(
name|OCSP_REQUEST
operator|*
operator|*
name|req
argument_list|,
name|X509
operator|*
name|cert
argument_list|,
name|X509
operator|*
name|issuer
argument_list|,
name|STACK_OF
argument_list|(
name|OCSP_CERTID
argument_list|)
operator|*
name|ids
argument_list|)
block|{
name|OCSP_CERTID
modifier|*
name|id
decl_stmt|;
if|if
condition|(
operator|!
name|issuer
condition|)
block|{
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"No issuer certificate specified\n"
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
if|if
condition|(
operator|!
operator|*
name|req
condition|)
operator|*
name|req
operator|=
name|OCSP_REQUEST_new
argument_list|()
expr_stmt|;
if|if
condition|(
operator|!
operator|*
name|req
condition|)
goto|goto
name|err
goto|;
name|id
operator|=
name|OCSP_cert_to_id
argument_list|(
name|NULL
argument_list|,
name|cert
argument_list|,
name|issuer
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|id
operator|||
operator|!
name|sk_OCSP_CERTID_push
argument_list|(
name|ids
argument_list|,
name|id
argument_list|)
condition|)
goto|goto
name|err
goto|;
if|if
condition|(
operator|!
name|OCSP_request_add0_id
argument_list|(
operator|*
name|req
argument_list|,
name|id
argument_list|)
condition|)
goto|goto
name|err
goto|;
return|return
literal|1
return|;
name|err
label|:
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"Error Creating OCSP request\n"
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|add_ocsp_serial
argument_list|(
name|OCSP_REQUEST
operator|*
operator|*
name|req
argument_list|,
name|char
operator|*
name|serial
argument_list|,
name|X509
operator|*
name|issuer
argument_list|,
name|STACK_OF
argument_list|(
name|OCSP_CERTID
argument_list|)
operator|*
name|ids
argument_list|)
block|{
name|OCSP_CERTID
modifier|*
name|id
decl_stmt|;
name|X509_NAME
modifier|*
name|iname
decl_stmt|;
name|ASN1_BIT_STRING
modifier|*
name|ikey
decl_stmt|;
name|ASN1_INTEGER
modifier|*
name|sno
decl_stmt|;
if|if
condition|(
operator|!
name|issuer
condition|)
block|{
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"No issuer certificate specified\n"
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
if|if
condition|(
operator|!
operator|*
name|req
condition|)
operator|*
name|req
operator|=
name|OCSP_REQUEST_new
argument_list|()
expr_stmt|;
if|if
condition|(
operator|!
operator|*
name|req
condition|)
goto|goto
name|err
goto|;
name|iname
operator|=
name|X509_get_subject_name
argument_list|(
name|issuer
argument_list|)
expr_stmt|;
name|ikey
operator|=
name|X509_get0_pubkey_bitstr
argument_list|(
name|issuer
argument_list|)
expr_stmt|;
name|sno
operator|=
name|s2i_ASN1_INTEGER
argument_list|(
name|NULL
argument_list|,
name|serial
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|sno
condition|)
block|{
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"Error converting serial number %s\n"
argument_list|,
name|serial
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
name|id
operator|=
name|OCSP_cert_id_new
argument_list|(
name|EVP_sha1
argument_list|()
argument_list|,
name|iname
argument_list|,
name|ikey
argument_list|,
name|sno
argument_list|)
expr_stmt|;
name|ASN1_INTEGER_free
argument_list|(
name|sno
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|id
operator|||
operator|!
name|sk_OCSP_CERTID_push
argument_list|(
name|ids
argument_list|,
name|id
argument_list|)
condition|)
goto|goto
name|err
goto|;
if|if
condition|(
operator|!
name|OCSP_request_add0_id
argument_list|(
operator|*
name|req
argument_list|,
name|id
argument_list|)
condition|)
goto|goto
name|err
goto|;
return|return
literal|1
return|;
name|err
label|:
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"Error Creating OCSP request\n"
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|print_ocsp_summary
argument_list|(
name|BIO
operator|*
name|out
argument_list|,
name|OCSP_BASICRESP
operator|*
name|bs
argument_list|,
name|OCSP_REQUEST
operator|*
name|req
argument_list|,
name|STACK
operator|*
name|names
argument_list|,
name|STACK_OF
argument_list|(
name|OCSP_CERTID
argument_list|)
operator|*
name|ids
argument_list|,
name|long
name|nsec
argument_list|,
name|long
name|maxage
argument_list|)
block|{
name|OCSP_CERTID
modifier|*
name|id
decl_stmt|;
name|char
modifier|*
name|name
decl_stmt|;
name|int
name|i
decl_stmt|;
name|int
name|status
decl_stmt|,
name|reason
decl_stmt|;
name|ASN1_GENERALIZEDTIME
modifier|*
name|rev
decl_stmt|,
modifier|*
name|thisupd
decl_stmt|,
modifier|*
name|nextupd
decl_stmt|;
if|if
condition|(
operator|!
name|bs
operator|||
operator|!
name|req
operator|||
operator|!
name|sk_num
argument_list|(
name|names
argument_list|)
operator|||
operator|!
name|sk_OCSP_CERTID_num
argument_list|(
name|ids
argument_list|)
condition|)
return|return
literal|1
return|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|sk_OCSP_CERTID_num
argument_list|(
name|ids
argument_list|)
condition|;
name|i
operator|++
control|)
block|{
name|id
operator|=
name|sk_OCSP_CERTID_value
argument_list|(
name|ids
argument_list|,
name|i
argument_list|)
expr_stmt|;
name|name
operator|=
name|sk_value
argument_list|(
name|names
argument_list|,
name|i
argument_list|)
expr_stmt|;
name|BIO_printf
argument_list|(
name|out
argument_list|,
literal|"%s: "
argument_list|,
name|name
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|OCSP_resp_find_status
argument_list|(
name|bs
argument_list|,
name|id
argument_list|,
operator|&
name|status
argument_list|,
operator|&
name|reason
argument_list|,
operator|&
name|rev
argument_list|,
operator|&
name|thisupd
argument_list|,
operator|&
name|nextupd
argument_list|)
condition|)
block|{
name|BIO_puts
argument_list|(
name|out
argument_list|,
literal|"ERROR: No Status found.\n"
argument_list|)
expr_stmt|;
continue|continue;
block|}
comment|/* Check validity: if invalid write to output BIO so we 		 * know which response this refers to. 		 */
if|if
condition|(
operator|!
name|OCSP_check_validity
argument_list|(
name|thisupd
argument_list|,
name|nextupd
argument_list|,
name|nsec
argument_list|,
name|maxage
argument_list|)
condition|)
block|{
name|BIO_puts
argument_list|(
name|out
argument_list|,
literal|"WARNING: Status times invalid.\n"
argument_list|)
expr_stmt|;
name|ERR_print_errors
argument_list|(
name|out
argument_list|)
expr_stmt|;
block|}
name|BIO_printf
argument_list|(
name|out
argument_list|,
literal|"%s\n"
argument_list|,
name|OCSP_cert_status_str
argument_list|(
name|status
argument_list|)
argument_list|)
expr_stmt|;
name|BIO_puts
argument_list|(
name|out
argument_list|,
literal|"\tThis Update: "
argument_list|)
expr_stmt|;
name|ASN1_GENERALIZEDTIME_print
argument_list|(
name|out
argument_list|,
name|thisupd
argument_list|)
expr_stmt|;
name|BIO_puts
argument_list|(
name|out
argument_list|,
literal|"\n"
argument_list|)
expr_stmt|;
if|if
condition|(
name|nextupd
condition|)
block|{
name|BIO_puts
argument_list|(
name|out
argument_list|,
literal|"\tNext Update: "
argument_list|)
expr_stmt|;
name|ASN1_GENERALIZEDTIME_print
argument_list|(
name|out
argument_list|,
name|nextupd
argument_list|)
expr_stmt|;
name|BIO_puts
argument_list|(
name|out
argument_list|,
literal|"\n"
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|status
operator|!=
name|V_OCSP_CERTSTATUS_REVOKED
condition|)
continue|continue;
if|if
condition|(
name|reason
operator|!=
operator|-
literal|1
condition|)
name|BIO_printf
argument_list|(
name|out
argument_list|,
literal|"\tReason: %s\n"
argument_list|,
name|OCSP_crl_reason_str
argument_list|(
name|reason
argument_list|)
argument_list|)
expr_stmt|;
name|BIO_puts
argument_list|(
name|out
argument_list|,
literal|"\tRevocation Time: "
argument_list|)
expr_stmt|;
name|ASN1_GENERALIZEDTIME_print
argument_list|(
name|out
argument_list|,
name|rev
argument_list|)
expr_stmt|;
name|BIO_puts
argument_list|(
name|out
argument_list|,
literal|"\n"
argument_list|)
expr_stmt|;
block|}
return|return
literal|1
return|;
block|}
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|make_ocsp_response
argument_list|(
name|OCSP_RESPONSE
operator|*
operator|*
name|resp
argument_list|,
name|OCSP_REQUEST
operator|*
name|req
argument_list|,
name|CA_DB
operator|*
name|db
argument_list|,
name|X509
operator|*
name|ca
argument_list|,
name|X509
operator|*
name|rcert
argument_list|,
name|EVP_PKEY
operator|*
name|rkey
argument_list|,
name|STACK_OF
argument_list|(
name|X509
argument_list|)
operator|*
name|rother
argument_list|,
name|unsigned
name|long
name|flags
argument_list|,
name|int
name|nmin
argument_list|,
name|int
name|ndays
argument_list|)
block|{
name|ASN1_TIME
modifier|*
name|thisupd
init|=
name|NULL
decl_stmt|,
modifier|*
name|nextupd
init|=
name|NULL
decl_stmt|;
name|OCSP_CERTID
modifier|*
name|cid
decl_stmt|,
modifier|*
name|ca_id
init|=
name|NULL
decl_stmt|;
name|OCSP_BASICRESP
modifier|*
name|bs
init|=
name|NULL
decl_stmt|;
name|int
name|i
decl_stmt|,
name|id_count
decl_stmt|,
name|ret
init|=
literal|1
decl_stmt|;
name|id_count
operator|=
name|OCSP_request_onereq_count
argument_list|(
name|req
argument_list|)
expr_stmt|;
if|if
condition|(
name|id_count
operator|<=
literal|0
condition|)
block|{
operator|*
name|resp
operator|=
name|OCSP_response_create
argument_list|(
name|OCSP_RESPONSE_STATUS_MALFORMEDREQUEST
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
goto|goto
name|end
goto|;
block|}
name|ca_id
operator|=
name|OCSP_cert_to_id
argument_list|(
name|EVP_sha1
argument_list|()
argument_list|,
name|NULL
argument_list|,
name|ca
argument_list|)
expr_stmt|;
name|bs
operator|=
name|OCSP_BASICRESP_new
argument_list|()
expr_stmt|;
name|thisupd
operator|=
name|X509_gmtime_adj
argument_list|(
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|ndays
operator|!=
operator|-
literal|1
condition|)
name|nextupd
operator|=
name|X509_gmtime_adj
argument_list|(
name|NULL
argument_list|,
name|nmin
operator|*
literal|60
operator|+
name|ndays
operator|*
literal|3600
operator|*
literal|24
argument_list|)
expr_stmt|;
comment|/* Examine each certificate id in the request */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|id_count
condition|;
name|i
operator|++
control|)
block|{
name|OCSP_ONEREQ
modifier|*
name|one
decl_stmt|;
name|ASN1_INTEGER
modifier|*
name|serial
decl_stmt|;
name|char
modifier|*
modifier|*
name|inf
decl_stmt|;
name|one
operator|=
name|OCSP_request_onereq_get0
argument_list|(
name|req
argument_list|,
name|i
argument_list|)
expr_stmt|;
name|cid
operator|=
name|OCSP_onereq_get0_id
argument_list|(
name|one
argument_list|)
expr_stmt|;
comment|/* Is this request about our CA? */
if|if
condition|(
name|OCSP_id_issuer_cmp
argument_list|(
name|ca_id
argument_list|,
name|cid
argument_list|)
condition|)
block|{
name|OCSP_basic_add1_status
argument_list|(
name|bs
argument_list|,
name|cid
argument_list|,
name|V_OCSP_CERTSTATUS_UNKNOWN
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|,
name|thisupd
argument_list|,
name|nextupd
argument_list|)
expr_stmt|;
continue|continue;
block|}
name|OCSP_id_get0_info
argument_list|(
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
operator|&
name|serial
argument_list|,
name|cid
argument_list|)
expr_stmt|;
name|inf
operator|=
name|lookup_serial
argument_list|(
name|db
argument_list|,
name|serial
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|inf
condition|)
name|OCSP_basic_add1_status
argument_list|(
name|bs
argument_list|,
name|cid
argument_list|,
name|V_OCSP_CERTSTATUS_UNKNOWN
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|,
name|thisupd
argument_list|,
name|nextupd
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|inf
index|[
name|DB_type
index|]
index|[
literal|0
index|]
operator|==
name|DB_TYPE_VAL
condition|)
name|OCSP_basic_add1_status
argument_list|(
name|bs
argument_list|,
name|cid
argument_list|,
name|V_OCSP_CERTSTATUS_GOOD
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|,
name|thisupd
argument_list|,
name|nextupd
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|inf
index|[
name|DB_type
index|]
index|[
literal|0
index|]
operator|==
name|DB_TYPE_REV
condition|)
block|{
name|ASN1_OBJECT
modifier|*
name|inst
init|=
name|NULL
decl_stmt|;
name|ASN1_TIME
modifier|*
name|revtm
init|=
name|NULL
decl_stmt|;
name|ASN1_GENERALIZEDTIME
modifier|*
name|invtm
init|=
name|NULL
decl_stmt|;
name|OCSP_SINGLERESP
modifier|*
name|single
decl_stmt|;
name|int
name|reason
init|=
operator|-
literal|1
decl_stmt|;
name|unpack_revinfo
argument_list|(
operator|&
name|revtm
argument_list|,
operator|&
name|reason
argument_list|,
operator|&
name|inst
argument_list|,
operator|&
name|invtm
argument_list|,
name|inf
index|[
name|DB_rev_date
index|]
argument_list|)
expr_stmt|;
name|single
operator|=
name|OCSP_basic_add1_status
argument_list|(
name|bs
argument_list|,
name|cid
argument_list|,
name|V_OCSP_CERTSTATUS_REVOKED
argument_list|,
name|reason
argument_list|,
name|revtm
argument_list|,
name|thisupd
argument_list|,
name|nextupd
argument_list|)
expr_stmt|;
if|if
condition|(
name|invtm
condition|)
name|OCSP_SINGLERESP_add1_ext_i2d
argument_list|(
name|single
argument_list|,
name|NID_invalidity_date
argument_list|,
name|invtm
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|inst
condition|)
name|OCSP_SINGLERESP_add1_ext_i2d
argument_list|(
name|single
argument_list|,
name|NID_hold_instruction_code
argument_list|,
name|inst
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|ASN1_OBJECT_free
argument_list|(
name|inst
argument_list|)
expr_stmt|;
name|ASN1_TIME_free
argument_list|(
name|revtm
argument_list|)
expr_stmt|;
name|ASN1_GENERALIZEDTIME_free
argument_list|(
name|invtm
argument_list|)
expr_stmt|;
block|}
block|}
name|OCSP_copy_nonce
argument_list|(
name|bs
argument_list|,
name|req
argument_list|)
expr_stmt|;
name|OCSP_basic_sign
argument_list|(
name|bs
argument_list|,
name|rcert
argument_list|,
name|rkey
argument_list|,
name|EVP_sha1
argument_list|()
argument_list|,
name|rother
argument_list|,
name|flags
argument_list|)
expr_stmt|;
operator|*
name|resp
operator|=
name|OCSP_response_create
argument_list|(
name|OCSP_RESPONSE_STATUS_SUCCESSFUL
argument_list|,
name|bs
argument_list|)
expr_stmt|;
name|end
label|:
name|ASN1_TIME_free
argument_list|(
name|thisupd
argument_list|)
expr_stmt|;
name|ASN1_TIME_free
argument_list|(
name|nextupd
argument_list|)
expr_stmt|;
name|OCSP_CERTID_free
argument_list|(
name|ca_id
argument_list|)
expr_stmt|;
name|OCSP_BASICRESP_free
argument_list|(
name|bs
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_decl_stmt

begin_function
specifier|static
name|char
modifier|*
modifier|*
name|lookup_serial
parameter_list|(
name|CA_DB
modifier|*
name|db
parameter_list|,
name|ASN1_INTEGER
modifier|*
name|ser
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
name|BIGNUM
modifier|*
name|bn
init|=
name|NULL
decl_stmt|;
name|char
modifier|*
name|itmp
decl_stmt|,
modifier|*
name|row
index|[
name|DB_NUMBER
index|]
decl_stmt|,
modifier|*
modifier|*
name|rrow
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|DB_NUMBER
condition|;
name|i
operator|++
control|)
name|row
index|[
name|i
index|]
operator|=
name|NULL
expr_stmt|;
name|bn
operator|=
name|ASN1_INTEGER_to_BN
argument_list|(
name|ser
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|BN_is_zero
argument_list|(
name|bn
argument_list|)
condition|)
name|itmp
operator|=
name|BUF_strdup
argument_list|(
literal|"00"
argument_list|)
expr_stmt|;
else|else
name|itmp
operator|=
name|BN_bn2hex
argument_list|(
name|bn
argument_list|)
expr_stmt|;
name|row
index|[
name|DB_serial
index|]
operator|=
name|itmp
expr_stmt|;
name|BN_free
argument_list|(
name|bn
argument_list|)
expr_stmt|;
name|rrow
operator|=
name|TXT_DB_get_by_index
argument_list|(
name|db
operator|->
name|db
argument_list|,
name|DB_serial
argument_list|,
name|row
argument_list|)
expr_stmt|;
name|OPENSSL_free
argument_list|(
name|itmp
argument_list|)
expr_stmt|;
return|return
name|rrow
return|;
block|}
end_function

begin_comment
comment|/* Quick and dirty OCSP server: read in and parse input request */
end_comment

begin_function
specifier|static
name|BIO
modifier|*
name|init_responder
parameter_list|(
name|char
modifier|*
name|port
parameter_list|)
block|{
name|BIO
modifier|*
name|acbio
init|=
name|NULL
decl_stmt|,
modifier|*
name|bufbio
init|=
name|NULL
decl_stmt|;
name|bufbio
operator|=
name|BIO_new
argument_list|(
name|BIO_f_buffer
argument_list|()
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|bufbio
condition|)
goto|goto
name|err
goto|;
ifndef|#
directive|ifndef
name|OPENSSL_NO_SOCK
name|acbio
operator|=
name|BIO_new_accept
argument_list|(
name|port
argument_list|)
expr_stmt|;
else|#
directive|else
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"Error setting up accept BIO - sockets not supported.\n"
argument_list|)
expr_stmt|;
endif|#
directive|endif
if|if
condition|(
operator|!
name|acbio
condition|)
goto|goto
name|err
goto|;
name|BIO_set_accept_bios
argument_list|(
name|acbio
argument_list|,
name|bufbio
argument_list|)
expr_stmt|;
name|bufbio
operator|=
name|NULL
expr_stmt|;
if|if
condition|(
name|BIO_do_accept
argument_list|(
name|acbio
argument_list|)
operator|<=
literal|0
condition|)
block|{
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"Error setting up accept BIO\n"
argument_list|)
expr_stmt|;
name|ERR_print_errors
argument_list|(
name|bio_err
argument_list|)
expr_stmt|;
goto|goto
name|err
goto|;
block|}
return|return
name|acbio
return|;
name|err
label|:
name|BIO_free_all
argument_list|(
name|acbio
argument_list|)
expr_stmt|;
name|BIO_free
argument_list|(
name|bufbio
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|do_responder
parameter_list|(
name|OCSP_REQUEST
modifier|*
modifier|*
name|preq
parameter_list|,
name|BIO
modifier|*
modifier|*
name|pcbio
parameter_list|,
name|BIO
modifier|*
name|acbio
parameter_list|,
name|char
modifier|*
name|port
parameter_list|)
block|{
name|int
name|have_post
init|=
literal|0
decl_stmt|,
name|len
decl_stmt|;
name|OCSP_REQUEST
modifier|*
name|req
init|=
name|NULL
decl_stmt|;
name|char
name|inbuf
index|[
literal|1024
index|]
decl_stmt|;
name|BIO
modifier|*
name|cbio
init|=
name|NULL
decl_stmt|;
if|if
condition|(
name|BIO_do_accept
argument_list|(
name|acbio
argument_list|)
operator|<=
literal|0
condition|)
block|{
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"Error accepting connection\n"
argument_list|)
expr_stmt|;
name|ERR_print_errors
argument_list|(
name|bio_err
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
name|cbio
operator|=
name|BIO_pop
argument_list|(
name|acbio
argument_list|)
expr_stmt|;
operator|*
name|pcbio
operator|=
name|cbio
expr_stmt|;
for|for
control|(
init|;
condition|;
control|)
block|{
name|len
operator|=
name|BIO_gets
argument_list|(
name|cbio
argument_list|,
name|inbuf
argument_list|,
sizeof|sizeof
name|inbuf
argument_list|)
expr_stmt|;
if|if
condition|(
name|len
operator|<=
literal|0
condition|)
return|return
literal|1
return|;
comment|/* Look for "POST" signalling start of query */
if|if
condition|(
operator|!
name|have_post
condition|)
block|{
if|if
condition|(
name|strncmp
argument_list|(
name|inbuf
argument_list|,
literal|"POST"
argument_list|,
literal|4
argument_list|)
condition|)
block|{
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"Invalid request\n"
argument_list|)
expr_stmt|;
return|return
literal|1
return|;
block|}
name|have_post
operator|=
literal|1
expr_stmt|;
block|}
comment|/* Look for end of headers */
if|if
condition|(
operator|(
name|inbuf
index|[
literal|0
index|]
operator|==
literal|'\r'
operator|)
operator|||
operator|(
name|inbuf
index|[
literal|0
index|]
operator|==
literal|'\n'
operator|)
condition|)
break|break;
block|}
comment|/* Try to read OCSP request */
name|req
operator|=
name|d2i_OCSP_REQUEST_bio
argument_list|(
name|cbio
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|req
condition|)
block|{
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"Error parsing OCSP request\n"
argument_list|)
expr_stmt|;
name|ERR_print_errors
argument_list|(
name|bio_err
argument_list|)
expr_stmt|;
block|}
operator|*
name|preq
operator|=
name|req
expr_stmt|;
return|return
literal|1
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|send_ocsp_response
parameter_list|(
name|BIO
modifier|*
name|cbio
parameter_list|,
name|OCSP_RESPONSE
modifier|*
name|resp
parameter_list|)
block|{
name|char
name|http_resp
index|[]
init|=
literal|"HTTP/1.0 200 OK\r\nContent-type: application/ocsp-response\r\n"
literal|"Content-Length: %d\r\n\r\n"
decl_stmt|;
if|if
condition|(
operator|!
name|cbio
condition|)
return|return
literal|0
return|;
name|BIO_printf
argument_list|(
name|cbio
argument_list|,
name|http_resp
argument_list|,
name|i2d_OCSP_RESPONSE
argument_list|(
name|resp
argument_list|,
name|NULL
argument_list|)
argument_list|)
expr_stmt|;
name|i2d_OCSP_RESPONSE_bio
argument_list|(
name|cbio
argument_list|,
name|resp
argument_list|)
expr_stmt|;
name|BIO_flush
argument_list|(
name|cbio
argument_list|)
expr_stmt|;
return|return
literal|1
return|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

end_unit


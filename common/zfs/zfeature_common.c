begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * CDDL HEADER START  *  * The contents of this file are subject to the terms of the  * Common Development and Distribution License (the "License").  * You may not use this file except in compliance with the License.  *  * You can obtain a copy of the license at usr/src/OPENSOLARIS.LICENSE  * or http://www.opensolaris.org/os/licensing.  * See the License for the specific language governing permissions  * and limitations under the License.  *  * When distributing Covered Code, include this CDDL HEADER in each  * file and include the License file at usr/src/OPENSOLARIS.LICENSE.  * If applicable, add the following below this CDDL HEADER, with the  * fields enclosed by brackets "[]" replaced with your own identifying  * information: Portions Copyright [yyyy] [name of copyright owner]  *  * CDDL HEADER END  */
end_comment

begin_comment
comment|/*  * Copyright (c) 2013 by Delphix. All rights reserved.  * Copyright (c) 2013 by Saso Kiselkov. All rights reserved.  * Copyright (c) 2013, Joyent, Inc. All rights reserved.  */
end_comment

begin_ifdef
ifdef|#
directive|ifdef
name|_KERNEL
end_ifdef

begin_include
include|#
directive|include
file|<sys/systm.h>
end_include

begin_else
else|#
directive|else
end_else

begin_include
include|#
directive|include
file|<errno.h>
end_include

begin_include
include|#
directive|include
file|<string.h>
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_include
include|#
directive|include
file|<sys/debug.h>
end_include

begin_include
include|#
directive|include
file|<sys/fs/zfs.h>
end_include

begin_include
include|#
directive|include
file|<sys/inttypes.h>
end_include

begin_include
include|#
directive|include
file|<sys/types.h>
end_include

begin_include
include|#
directive|include
file|"zfeature_common.h"
end_include

begin_comment
comment|/*  * Set to disable all feature checks while opening pools, allowing pools with  * unsupported features to be opened. Set for testing only.  */
end_comment

begin_decl_stmt
name|boolean_t
name|zfeature_checks_disable
init|=
name|B_FALSE
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|zfeature_info_t
name|spa_feature_table
index|[
name|SPA_FEATURES
index|]
decl_stmt|;
end_decl_stmt

begin_comment
comment|/*  * Valid characters for feature guids. This list is mainly for aesthetic  * purposes and could be expanded in the future. There are different allowed  * characters in the guids reverse dns portion (before the colon) and its  * short name (after the colon).  */
end_comment

begin_function
specifier|static
name|int
name|valid_char
parameter_list|(
name|char
name|c
parameter_list|,
name|boolean_t
name|after_colon
parameter_list|)
block|{
return|return
operator|(
operator|(
name|c
operator|>=
literal|'a'
operator|&&
name|c
operator|<=
literal|'z'
operator|)
operator|||
operator|(
name|c
operator|>=
literal|'0'
operator|&&
name|c
operator|<=
literal|'9'
operator|)
operator|||
name|c
operator|==
operator|(
name|after_colon
condition|?
literal|'_'
else|:
literal|'.'
operator|)
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Every feature guid must contain exactly one colon which separates a reverse  * dns organization name from the feature's "short" name (e.g.  * "com.company:feature_name").  */
end_comment

begin_function
name|boolean_t
name|zfeature_is_valid_guid
parameter_list|(
specifier|const
name|char
modifier|*
name|name
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
name|boolean_t
name|has_colon
init|=
name|B_FALSE
decl_stmt|;
name|i
operator|=
literal|0
expr_stmt|;
while|while
condition|(
name|name
index|[
name|i
index|]
operator|!=
literal|'\0'
condition|)
block|{
name|char
name|c
init|=
name|name
index|[
name|i
operator|++
index|]
decl_stmt|;
if|if
condition|(
name|c
operator|==
literal|':'
condition|)
block|{
if|if
condition|(
name|has_colon
condition|)
return|return
operator|(
name|B_FALSE
operator|)
return|;
name|has_colon
operator|=
name|B_TRUE
expr_stmt|;
continue|continue;
block|}
if|if
condition|(
operator|!
name|valid_char
argument_list|(
name|c
argument_list|,
name|has_colon
argument_list|)
condition|)
return|return
operator|(
name|B_FALSE
operator|)
return|;
block|}
return|return
operator|(
name|has_colon
operator|)
return|;
block|}
end_function

begin_function
name|boolean_t
name|zfeature_is_supported
parameter_list|(
specifier|const
name|char
modifier|*
name|guid
parameter_list|)
block|{
if|if
condition|(
name|zfeature_checks_disable
condition|)
return|return
operator|(
name|B_TRUE
operator|)
return|;
for|for
control|(
name|spa_feature_t
name|i
init|=
literal|0
init|;
name|i
operator|<
name|SPA_FEATURES
condition|;
name|i
operator|++
control|)
block|{
name|zfeature_info_t
modifier|*
name|feature
init|=
operator|&
name|spa_feature_table
index|[
name|i
index|]
decl_stmt|;
if|if
condition|(
name|strcmp
argument_list|(
name|guid
argument_list|,
name|feature
operator|->
name|fi_guid
argument_list|)
operator|==
literal|0
condition|)
return|return
operator|(
name|B_TRUE
operator|)
return|;
block|}
return|return
operator|(
name|B_FALSE
operator|)
return|;
block|}
end_function

begin_function
name|int
name|zfeature_lookup_name
parameter_list|(
specifier|const
name|char
modifier|*
name|name
parameter_list|,
name|spa_feature_t
modifier|*
name|res
parameter_list|)
block|{
for|for
control|(
name|spa_feature_t
name|i
init|=
literal|0
init|;
name|i
operator|<
name|SPA_FEATURES
condition|;
name|i
operator|++
control|)
block|{
name|zfeature_info_t
modifier|*
name|feature
init|=
operator|&
name|spa_feature_table
index|[
name|i
index|]
decl_stmt|;
if|if
condition|(
name|strcmp
argument_list|(
name|name
argument_list|,
name|feature
operator|->
name|fi_uname
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|res
operator|!=
name|NULL
condition|)
operator|*
name|res
operator|=
name|i
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
block|}
return|return
operator|(
name|ENOENT
operator|)
return|;
block|}
end_function

begin_function
name|boolean_t
name|zfeature_depends_on
parameter_list|(
name|spa_feature_t
name|fid
parameter_list|,
name|spa_feature_t
name|check
parameter_list|)
block|{
name|zfeature_info_t
modifier|*
name|feature
init|=
operator|&
name|spa_feature_table
index|[
name|fid
index|]
decl_stmt|;
for|for
control|(
name|int
name|i
init|=
literal|0
init|;
name|feature
operator|->
name|fi_depends
index|[
name|i
index|]
operator|!=
name|SPA_FEATURE_NONE
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|feature
operator|->
name|fi_depends
index|[
name|i
index|]
operator|==
name|check
condition|)
return|return
operator|(
name|B_TRUE
operator|)
return|;
block|}
return|return
operator|(
name|B_FALSE
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|zfeature_register
parameter_list|(
name|spa_feature_t
name|fid
parameter_list|,
specifier|const
name|char
modifier|*
name|guid
parameter_list|,
specifier|const
name|char
modifier|*
name|name
parameter_list|,
specifier|const
name|char
modifier|*
name|desc
parameter_list|,
name|boolean_t
name|readonly
parameter_list|,
name|boolean_t
name|mos
parameter_list|,
name|boolean_t
name|activate_on_enable
parameter_list|,
specifier|const
name|spa_feature_t
modifier|*
name|deps
parameter_list|)
block|{
name|zfeature_info_t
modifier|*
name|feature
init|=
operator|&
name|spa_feature_table
index|[
name|fid
index|]
decl_stmt|;
specifier|static
name|spa_feature_t
name|nodeps
index|[]
init|=
block|{
name|SPA_FEATURE_NONE
block|}
decl_stmt|;
name|ASSERT
argument_list|(
name|name
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|ASSERT
argument_list|(
name|desc
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|ASSERT
argument_list|(
operator|!
name|readonly
operator|||
operator|!
name|mos
argument_list|)
expr_stmt|;
name|ASSERT3U
argument_list|(
name|fid
argument_list|,
operator|<
argument_list|,
name|SPA_FEATURES
argument_list|)
expr_stmt|;
name|ASSERT
argument_list|(
name|zfeature_is_valid_guid
argument_list|(
name|guid
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|deps
operator|==
name|NULL
condition|)
name|deps
operator|=
name|nodeps
expr_stmt|;
name|feature
operator|->
name|fi_feature
operator|=
name|fid
expr_stmt|;
name|feature
operator|->
name|fi_guid
operator|=
name|guid
expr_stmt|;
name|feature
operator|->
name|fi_uname
operator|=
name|name
expr_stmt|;
name|feature
operator|->
name|fi_desc
operator|=
name|desc
expr_stmt|;
name|feature
operator|->
name|fi_can_readonly
operator|=
name|readonly
expr_stmt|;
name|feature
operator|->
name|fi_mos
operator|=
name|mos
expr_stmt|;
name|feature
operator|->
name|fi_activate_on_enable
operator|=
name|activate_on_enable
expr_stmt|;
name|feature
operator|->
name|fi_depends
operator|=
name|deps
expr_stmt|;
block|}
end_function

begin_function
name|void
name|zpool_feature_init
parameter_list|(
name|void
parameter_list|)
block|{
name|zfeature_register
argument_list|(
name|SPA_FEATURE_ASYNC_DESTROY
argument_list|,
literal|"com.delphix:async_destroy"
argument_list|,
literal|"async_destroy"
argument_list|,
literal|"Destroy filesystems asynchronously."
argument_list|,
name|B_TRUE
argument_list|,
name|B_FALSE
argument_list|,
name|B_FALSE
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|zfeature_register
argument_list|(
name|SPA_FEATURE_EMPTY_BPOBJ
argument_list|,
literal|"com.delphix:empty_bpobj"
argument_list|,
literal|"empty_bpobj"
argument_list|,
literal|"Snapshots use less space."
argument_list|,
name|B_TRUE
argument_list|,
name|B_FALSE
argument_list|,
name|B_FALSE
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|zfeature_register
argument_list|(
name|SPA_FEATURE_LZ4_COMPRESS
argument_list|,
literal|"org.illumos:lz4_compress"
argument_list|,
literal|"lz4_compress"
argument_list|,
literal|"LZ4 compression algorithm support."
argument_list|,
name|B_FALSE
argument_list|,
name|B_FALSE
argument_list|,
name|B_FALSE
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|zfeature_register
argument_list|(
name|SPA_FEATURE_MULTI_VDEV_CRASH_DUMP
argument_list|,
literal|"com.joyent:multi_vdev_crash_dump"
argument_list|,
literal|"multi_vdev_crash_dump"
argument_list|,
literal|"Crash dumps to multiple vdev pools."
argument_list|,
name|B_FALSE
argument_list|,
name|B_FALSE
argument_list|,
name|B_FALSE
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|zfeature_register
argument_list|(
name|SPA_FEATURE_SPACEMAP_HISTOGRAM
argument_list|,
literal|"com.delphix:spacemap_histogram"
argument_list|,
literal|"spacemap_histogram"
argument_list|,
literal|"Spacemaps maintain space histograms."
argument_list|,
name|B_TRUE
argument_list|,
name|B_FALSE
argument_list|,
name|B_FALSE
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|zfeature_register
argument_list|(
name|SPA_FEATURE_ENABLED_TXG
argument_list|,
literal|"com.delphix:enabled_txg"
argument_list|,
literal|"enabled_txg"
argument_list|,
literal|"Record txg at which a feature is enabled"
argument_list|,
name|B_TRUE
argument_list|,
name|B_FALSE
argument_list|,
name|B_FALSE
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
specifier|static
name|spa_feature_t
name|hole_birth_deps
index|[]
init|=
block|{
name|SPA_FEATURE_ENABLED_TXG
block|,
name|SPA_FEATURE_NONE
block|}
decl_stmt|;
name|zfeature_register
argument_list|(
name|SPA_FEATURE_HOLE_BIRTH
argument_list|,
literal|"com.delphix:hole_birth"
argument_list|,
literal|"hole_birth"
argument_list|,
literal|"Retain hole birth txg for more precise zfs send"
argument_list|,
name|B_FALSE
argument_list|,
name|B_TRUE
argument_list|,
name|B_TRUE
argument_list|,
name|hole_birth_deps
argument_list|)
expr_stmt|;
name|zfeature_register
argument_list|(
name|SPA_FEATURE_EXTENSIBLE_DATASET
argument_list|,
literal|"com.delphix:extensible_dataset"
argument_list|,
literal|"extensible_dataset"
argument_list|,
literal|"Enhanced dataset functionality, used by other features."
argument_list|,
name|B_FALSE
argument_list|,
name|B_FALSE
argument_list|,
name|B_FALSE
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
specifier|static
specifier|const
name|spa_feature_t
name|bookmarks_deps
index|[]
init|=
block|{
name|SPA_FEATURE_EXTENSIBLE_DATASET
block|,
name|SPA_FEATURE_NONE
block|}
decl_stmt|;
name|zfeature_register
argument_list|(
name|SPA_FEATURE_BOOKMARKS
argument_list|,
literal|"com.delphix:bookmarks"
argument_list|,
literal|"bookmarks"
argument_list|,
literal|"\"zfs bookmark\" command"
argument_list|,
name|B_TRUE
argument_list|,
name|B_FALSE
argument_list|,
name|B_FALSE
argument_list|,
name|bookmarks_deps
argument_list|)
expr_stmt|;
specifier|static
specifier|const
name|spa_feature_t
name|filesystem_limits_deps
index|[]
init|=
block|{
name|SPA_FEATURE_EXTENSIBLE_DATASET
block|,
name|SPA_FEATURE_NONE
block|}
decl_stmt|;
name|zfeature_register
argument_list|(
name|SPA_FEATURE_FS_SS_LIMIT
argument_list|,
literal|"com.joyent:filesystem_limits"
argument_list|,
literal|"filesystem_limits"
argument_list|,
literal|"Filesystem and snapshot limits."
argument_list|,
name|B_TRUE
argument_list|,
name|B_FALSE
argument_list|,
name|B_FALSE
argument_list|,
name|filesystem_limits_deps
argument_list|)
expr_stmt|;
block|}
end_function

end_unit


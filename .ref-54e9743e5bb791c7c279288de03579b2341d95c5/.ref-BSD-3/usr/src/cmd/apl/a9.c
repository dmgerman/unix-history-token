begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_include
include|#
directive|include
file|"apl.h"
end_include

begin_macro
name|ex_dibm
argument_list|()
end_macro

begin_block
block|{
name|int
name|inde
decl_stmt|,
name|fsize
decl_stmt|;
name|char
name|fname
index|[
literal|128
index|]
decl_stmt|;
specifier|register
name|i
expr_stmt|;
specifier|register
name|char
modifier|*
name|a
decl_stmt|,
modifier|*
name|b
decl_stmt|;
name|inde
operator|=
name|topfix
argument_list|()
expr_stmt|;
name|a
operator|=
name|fetch1
argument_list|()
expr_stmt|;
if|if
condition|(
name|a
operator|->
name|type
operator|!=
name|CH
condition|)
block|{
if|if
condition|(
name|a
operator|->
name|size
operator|==
literal|0
operator|||
name|a
operator|->
name|size
operator|==
literal|1
operator|&&
name|fuzz
argument_list|(
operator|*
name|a
operator|->
name|datap
argument_list|,
literal|0.0
argument_list|)
operator|==
literal|0
condition|)
block|{
name|push
argument_list|(
name|newdat
argument_list|(
name|DA
argument_list|,
literal|1
argument_list|,
literal|0
argument_list|)
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|inde
condition|)
block|{
case|case
literal|1
case|:
if|if
condition|(
name|i
operator|=
name|ifile
condition|)
name|close
argument_list|(
name|i
argument_list|)
expr_stmt|;
name|ifile
operator|=
literal|0
expr_stmt|;
return|return;
case|case
literal|2
case|:
case|case
literal|3
case|:
if|if
condition|(
operator|(
name|i
operator|=
name|ofile
operator|)
operator|&&
name|i
operator|!=
literal|1
condition|)
name|close
argument_list|(
name|i
argument_list|)
expr_stmt|;
name|ofile
operator|=
literal|1
expr_stmt|;
return|return;
default|default:
name|error
argument_list|(
literal|"mibm D"
argument_list|)
expr_stmt|;
block|}
block|}
name|error
argument_list|(
literal|"mibm T"
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|a
operator|->
name|rank
operator|!=
literal|1
condition|)
name|error
argument_list|(
literal|"dibm R"
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
operator|(
literal|1
operator|<=
name|a
operator|->
name|size
operator|&&
name|a
operator|->
name|size
operator|<
literal|128
operator|)
condition|)
name|error
argument_list|(
literal|"fnam L"
argument_list|)
expr_stmt|;
name|fsize
operator|=
name|a
operator|->
name|size
expr_stmt|;
name|b
operator|=
name|a
operator|->
name|datap
expr_stmt|;
name|a
operator|=
name|fname
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|fsize
condition|;
operator|++
name|i
control|)
operator|*
name|a
operator|++
operator|=
operator|*
name|b
operator|++
expr_stmt|;
operator|*
name|a
operator|=
literal|'\0'
expr_stmt|;
name|push
argument_list|(
name|newdat
argument_list|(
name|DA
argument_list|,
literal|1
argument_list|,
literal|0
argument_list|)
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|inde
condition|)
block|{
case|case
literal|1
case|:
comment|/* Open for reading */
if|if
condition|(
name|i
operator|=
name|ifile
condition|)
name|close
argument_list|(
name|i
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|i
operator|=
name|open
argument_list|(
name|fname
argument_list|,
literal|0
argument_list|)
operator|)
operator|<
literal|0
condition|)
goto|goto
name|badfile
goto|;
name|ifile
operator|=
name|i
expr_stmt|;
return|return;
case|case
literal|2
case|:
comment|/* Open for writing */
if|if
condition|(
operator|(
name|i
operator|=
name|ofile
operator|)
operator|&&
name|i
operator|!=
literal|1
condition|)
name|close
argument_list|(
name|i
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|i
operator|=
name|creat
argument_list|(
name|fname
argument_list|,
literal|0666
argument_list|)
operator|)
operator|<
literal|0
condition|)
goto|goto
name|badfile
goto|;
name|ofile
operator|=
name|i
expr_stmt|;
return|return;
case|case
literal|3
case|:
comment|/* Open and append  */
if|if
condition|(
operator|(
name|i
operator|=
name|ofile
operator|)
operator|&&
name|i
operator|!=
literal|1
condition|)
name|close
argument_list|(
name|i
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|i
operator|=
name|open
argument_list|(
name|fname
argument_list|,
literal|1
argument_list|)
operator|)
operator|<
literal|0
condition|)
if|if
condition|(
operator|(
name|i
operator|=
name|creat
argument_list|(
name|fname
argument_list|,
literal|0666
argument_list|)
operator|)
operator|<
literal|0
condition|)
goto|goto
name|badfile
goto|;
name|lseek
argument_list|(
name|i
argument_list|,
literal|0
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|ofile
operator|=
name|i
expr_stmt|;
return|return;
case|case
literal|10
case|:
block|{
name|int
name|shellpid
decl_stmt|,
name|oldsignal
decl_stmt|,
name|termproc
decl_stmt|;
name|oldsignal
operator|=
name|signal
argument_list|(
literal|2
argument_list|,
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|shellpid
operator|=
name|vfork
argument_list|()
operator|)
condition|)
name|execl
argument_list|(
name|getenv
argument_list|(
literal|"SHELL"
argument_list|)
condition|?
name|getenv
argument_list|(
literal|"SHELL"
argument_list|)
else|:
literal|"/bin/sh"
argument_list|,
literal|"sh"
argument_list|,
literal|"-c"
argument_list|,
name|fname
argument_list|,
literal|0
argument_list|)
expr_stmt|;
else|else
while|while
condition|(
operator|(
name|termproc
operator|=
name|wait
argument_list|(
operator|&
name|termproc
argument_list|)
operator|)
operator|!=
operator|-
literal|1
condition|)
if|if
condition|(
name|termproc
operator|==
name|shellpid
condition|)
break|break;
name|signal
argument_list|(
literal|2
argument_list|,
name|oldsignal
argument_list|)
expr_stmt|;
return|return;
block|}
default|default:
name|error
argument_list|(
literal|"dibm unk"
argument_list|)
expr_stmt|;
block|}
name|badfile
label|:
name|error
argument_list|(
literal|"bad file"
argument_list|)
expr_stmt|;
block|}
end_block

begin_macro
name|ex_mibm
argument_list|()
end_macro

begin_block
block|{
specifier|register
operator|*
name|p
expr_stmt|;
name|int
name|t
index|[
literal|6
index|]
decl_stmt|;
switch|switch
condition|(
name|topfix
argument_list|()
condition|)
block|{
default|default:
name|error
argument_list|(
literal|"ib unk"
argument_list|)
expr_stmt|;
case|case
literal|1
case|:
name|sclr
argument_list|()
expr_stmt|;
name|datum
operator|=
literal|0
expr_stmt|;
break|break;
case|case
literal|20
case|:
comment|/* time of day */
name|time
argument_list|(
name|t
argument_list|)
expr_stmt|;
name|p
operator|=
name|t
expr_stmt|;
goto|goto
name|tod
goto|;
case|case
literal|21
case|:
comment|/* CPU time */
name|times
argument_list|(
name|t
argument_list|)
expr_stmt|;
name|t
index|[
literal|3
index|]
operator|=
name|t
index|[
literal|0
index|]
expr_stmt|;
name|t
index|[
literal|0
index|]
operator|=
literal|0
expr_stmt|;
name|t
index|[
literal|2
index|]
operator|=
literal|0
expr_stmt|;
name|datum
operator|=
name|ltod
argument_list|(
name|t
argument_list|)
operator|+
name|ltod
argument_list|(
name|t
operator|+
literal|2
argument_list|)
expr_stmt|;
break|break;
case|case
literal|22
case|:
comment|/* Ws free */
comment|/* RH 24-Apr-78 UCSF */
block|{
struct|struct
name|freeblk
block|{
name|unsigned
name|size
decl_stmt|;
name|struct
name|freeblk
modifier|*
name|nxtblk
decl_stmt|;
block|}
struct|;
specifier|extern
name|int
name|freelist
index|[]
decl_stmt|,
name|sbrk
argument_list|()
decl_stmt|;
specifier|register
name|struct
name|freeblk
modifier|*
name|runthru
init|=
name|freelist
decl_stmt|;
specifier|register
name|unsigned
name|int
name|freesum
init|=
literal|0160000
decl_stmt|;
name|freesum
operator|-=
name|sbrk
argument_list|(
literal|0
argument_list|)
expr_stmt|;
while|while
condition|(
name|runthru
operator|->
name|nxtblk
operator|!=
operator|-
literal|1
condition|)
block|{
name|freesum
operator|+=
name|runthru
operator|->
name|size
expr_stmt|;
name|runthru
operator|=
name|runthru
operator|->
name|nxtblk
expr_stmt|;
block|}
name|datum
operator|=
name|freesum
operator|+
name|runthru
operator|->
name|size
expr_stmt|;
block|}
break|break;
case|case
literal|24
case|:
comment|/* starting time */
name|p
operator|=
name|stime
expr_stmt|;
name|tod
label|:
name|p
operator|=
name|localtime
argument_list|(
name|p
argument_list|)
expr_stmt|;
name|datum
operator|=
literal|60.
operator|*
operator|(
name|p
index|[
literal|0
index|]
operator|+
literal|60.
operator|*
operator|(
name|p
index|[
literal|1
index|]
operator|+
literal|60.
operator|*
name|p
index|[
literal|2
index|]
operator|)
operator|)
expr_stmt|;
break|break;
case|case
literal|25
case|:
comment|/* date */
name|time
argument_list|(
name|t
argument_list|)
expr_stmt|;
name|p
operator|=
name|t
expr_stmt|;
goto|goto
name|dt
goto|;
comment|/* 	 * non standard I functions 	 */
case|case
literal|28
case|:
comment|/* starting date */
name|p
operator|=
name|stime
expr_stmt|;
name|dt
label|:
name|p
operator|=
name|localtime
argument_list|(
name|p
argument_list|)
expr_stmt|;
name|datum
operator|=
name|p
index|[
literal|5
index|]
operator|+
literal|100.
operator|*
operator|(
name|p
index|[
literal|3
index|]
operator|+
literal|100.
operator|*
operator|(
name|p
index|[
literal|4
index|]
operator|+
literal|1
operator|)
operator|)
expr_stmt|;
break|break;
case|case
literal|29
case|:
comment|/* iorg */
name|datum
operator|=
name|thread
operator|.
name|iorg
expr_stmt|;
break|break;
case|case
literal|30
case|:
comment|/* width */
name|datum
operator|=
name|thread
operator|.
name|width
expr_stmt|;
break|break;
case|case
literal|31
case|:
comment|/* digits */
name|datum
operator|=
name|thread
operator|.
name|digits
expr_stmt|;
break|break;
case|case
literal|32
case|:
block|{
name|int
name|shellpid
decl_stmt|,
name|oldsignal
decl_stmt|,
name|termproc
decl_stmt|;
name|oldsignal
operator|=
name|signal
argument_list|(
literal|2
argument_list|,
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|shellpid
operator|=
name|fork
argument_list|()
operator|)
condition|)
name|execl
argument_list|(
literal|"/bin/csh"
argument_list|,
literal|"-"
argument_list|,
literal|0
argument_list|)
expr_stmt|;
else|else
while|while
condition|(
operator|(
name|termproc
operator|=
name|wait
argument_list|(
operator|&
name|termproc
argument_list|)
operator|)
operator|!=
operator|-
literal|1
condition|)
if|if
condition|(
name|termproc
operator|==
name|shellpid
condition|)
break|break;
name|signal
argument_list|(
literal|2
argument_list|,
name|oldsignal
argument_list|)
expr_stmt|;
name|push
argument_list|(
name|newdat
argument_list|(
name|DA
argument_list|,
literal|1
argument_list|,
literal|0
argument_list|)
argument_list|)
expr_stmt|;
return|return;
block|}
block|}
name|p
operator|=
name|newdat
argument_list|(
name|DA
argument_list|,
literal|0
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|p
operator|->
name|datap
index|[
literal|0
index|]
operator|=
name|datum
expr_stmt|;
name|push
argument_list|(
name|p
argument_list|)
expr_stmt|;
block|}
end_block

end_unit


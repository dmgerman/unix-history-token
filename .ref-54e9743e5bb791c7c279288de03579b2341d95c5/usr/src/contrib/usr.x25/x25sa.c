begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Print the kernel X.25 accounting file, in the following format:  *  month  *  day  *  hour:min	- call start time  *  duration	- call duration in seconds  *  user	- name of user who placed the call  *  in/out	- incoming or outgoing call flag  *  address	- X.121 address  *  host	- host name associated with address, if known  *  rev/---	- reverse charge flag  *  packet size	- packet size in bytes  *  user data	- 4 bytes of user data (protocol),  * 		  ITI calls appear as x29d, EAN 1&2 as ean1/ean2,  * 		  others as 4 hex digits.  *  packets sent  *  packets received - number of packets sent and received.  *  * Not the nicest format for people, but it is assumed that the  * output will be further processed before people see it.  * The idea here is to convert the raw data to a form  * convenient for shell or awk scripts.  */
end_comment

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_include
include|#
directive|include
file|<sys/file.h>
end_include

begin_include
include|#
directive|include
file|<sys/types.h>
end_include

begin_include
include|#
directive|include
file|<sys/time.h>
end_include

begin_include
include|#
directive|include
file|<pwd.h>
end_include

begin_include
include|#
directive|include
file|<netccitt/x25.h>
end_include

begin_include
include|#
directive|include
file|<netccitt/x25acct.h>
end_include

begin_include
include|#
directive|include
file|<netdb.h>
end_include

begin_function
name|main
parameter_list|(
name|argc
parameter_list|,
name|argv
parameter_list|)
name|char
modifier|*
modifier|*
name|argv
decl_stmt|;
block|{
name|struct
name|passwd
modifier|*
name|pw
decl_stmt|;
name|char
modifier|*
name|user
decl_stmt|,
name|ubuf
index|[
literal|20
index|]
decl_stmt|,
modifier|*
name|dayt
decl_stmt|,
modifier|*
name|filename
decl_stmt|;
name|FILE
modifier|*
name|fp
decl_stmt|;
name|struct
name|x25acct
name|ac
decl_stmt|;
name|char
name|addr
index|[
literal|16
operator|+
literal|1
index|]
decl_stmt|;
name|char
modifier|*
name|format_udata
parameter_list|()
function_decl|;
name|struct
name|hostent
modifier|*
name|hp
decl_stmt|,
modifier|*
name|getx25hostbyaddr
argument_list|()
decl_stmt|;
if|if
condition|(
name|argc
operator|>
literal|2
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"usage: %s [file]\n"
argument_list|,
name|argv
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
name|filename
operator|=
name|argc
operator|==
literal|2
condition|?
name|argv
index|[
literal|1
index|]
else|:
name|X25ACCTF
expr_stmt|;
if|if
condition|(
operator|(
name|fp
operator|=
name|fopen
argument_list|(
name|filename
argument_list|,
literal|"r"
argument_list|)
operator|)
operator|==
name|NULL
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"%s: "
argument_list|,
name|argv
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
name|perror
argument_list|(
name|filename
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
name|setx25hostent
argument_list|(
literal|1
argument_list|)
expr_stmt|;
comment|/* don't close after each call */
while|while
condition|(
name|fread
argument_list|(
operator|(
name|char
operator|*
operator|)
operator|&
name|ac
argument_list|,
sizeof|sizeof
name|ac
argument_list|,
literal|1
argument_list|,
name|fp
argument_list|)
operator|==
literal|1
condition|)
block|{
if|if
condition|(
name|ac
operator|.
name|x25acct_txcnt
operator|==
literal|0
operator|&&
name|ac
operator|.
name|x25acct_rxcnt
operator|==
literal|0
condition|)
continue|continue;
if|if
condition|(
operator|(
name|pw
operator|=
name|getpwuid
argument_list|(
name|ac
operator|.
name|x25acct_uid
argument_list|)
operator|)
operator|==
name|NULL
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"%s: unknown uid: %d\n"
argument_list|,
name|argv
index|[
literal|0
index|]
argument_list|,
name|ac
operator|.
name|x25acct_uid
argument_list|)
expr_stmt|;
name|sprintf
argument_list|(
name|ubuf
argument_list|,
literal|"#%d"
argument_list|,
name|ac
operator|.
name|x25acct_uid
argument_list|)
expr_stmt|;
name|user
operator|=
name|ubuf
expr_stmt|;
block|}
else|else
name|user
operator|=
name|pw
operator|->
name|pw_name
expr_stmt|;
name|dayt
operator|=
name|ctime
argument_list|(
operator|&
name|ac
operator|.
name|x25acct_stime
argument_list|)
expr_stmt|;
name|dayt
index|[
literal|16
index|]
operator|=
literal|'\0'
expr_stmt|;
comment|/* we probably know what year it is */
name|dayt
operator|+=
literal|4
expr_stmt|;
comment|/* skip the day */
if|if
condition|(
name|ac
operator|.
name|x25acct_addrlen
operator|>
literal|16
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"%s: Invalid addrlen %d\n"
argument_list|,
name|argv
index|[
literal|0
index|]
argument_list|,
name|ac
operator|.
name|x25acct_addrlen
argument_list|)
expr_stmt|;
continue|continue;
block|}
comment|/* 		 * Convert bcd address to ascii. 		 */
name|bzero
argument_list|(
name|addr
argument_list|,
sizeof|sizeof
name|addr
argument_list|)
expr_stmt|;
name|from_bcd
argument_list|(
name|addr
argument_list|,
operator|(
name|u_char
operator|*
operator|)
name|ac
operator|.
name|x25acct_addr
argument_list|,
operator|(
name|int
operator|)
name|ac
operator|.
name|x25acct_addrlen
argument_list|)
expr_stmt|;
name|hp
operator|=
name|getx25hostbyaddr
argument_list|(
name|addr
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"%s %4d %-8s %s %-14s %-9s %s %3d %-4s %3ld %3ld\n"
argument_list|,
name|dayt
argument_list|,
name|ac
operator|.
name|x25acct_etime
argument_list|,
name|user
argument_list|,
name|ac
operator|.
name|x25acct_callin
condition|?
literal|"in "
else|:
literal|"out"
argument_list|,
name|addr
argument_list|,
name|hp
condition|?
name|hp
operator|->
name|h_name
else|:
name|addr
argument_list|,
comment|/* REVERSE means collect (by default caller pays) */
name|ac
operator|.
name|x25acct_revcharge
condition|?
literal|"rev"
else|:
literal|"---"
argument_list|,
literal|1
operator|<<
name|ac
operator|.
name|x25acct_psize
argument_list|,
name|format_udata
argument_list|(
name|ac
operator|.
name|x25acct_udata
argument_list|)
argument_list|,
name|ac
operator|.
name|x25acct_txcnt
argument_list|,
name|ac
operator|.
name|x25acct_rxcnt
argument_list|)
expr_stmt|;
block|}
name|exit
argument_list|(
literal|0
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|char
modifier|*
name|format_udata
parameter_list|(
name|udata
parameter_list|)
name|char
modifier|*
name|udata
decl_stmt|;
block|{
specifier|static
name|char
name|buf
index|[
literal|15
index|]
decl_stmt|;
if|if
condition|(
name|bcmp
argument_list|(
name|udata
argument_list|,
literal|"\1\0\0\0"
argument_list|,
literal|4
argument_list|)
operator|==
literal|0
condition|)
return|return
literal|"x29d"
return|;
if|if
condition|(
name|bcmp
argument_list|(
name|udata
argument_list|,
literal|"ean"
argument_list|,
literal|3
argument_list|)
operator|==
literal|0
condition|)
return|return
name|udata
return|;
name|sprintf
argument_list|(
name|buf
argument_list|,
literal|"%x.%x.%x.%x"
argument_list|,
name|udata
index|[
literal|0
index|]
argument_list|,
name|udata
index|[
literal|1
index|]
argument_list|,
name|udata
index|[
literal|2
index|]
argument_list|,
name|udata
index|[
literal|3
index|]
argument_list|)
expr_stmt|;
return|return
name|buf
return|;
block|}
end_function

begin_expr_stmt
name|from_bcd
argument_list|(
name|a
argument_list|,
name|x
argument_list|,
name|len
argument_list|)
specifier|register
name|char
operator|*
name|a
expr_stmt|;
end_expr_stmt

begin_decl_stmt
specifier|register
name|u_char
modifier|*
name|x
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|register
name|int
name|len
decl_stmt|;
end_decl_stmt

begin_block
block|{
specifier|register
name|int
name|posn
init|=
literal|0
decl_stmt|;
while|while
condition|(
operator|--
name|len
operator|>=
literal|0
condition|)
block|{
if|if
condition|(
name|posn
operator|++
operator|&
literal|0x01
condition|)
operator|*
name|a
operator|=
operator|*
name|x
operator|++
operator|&
literal|0x0f
expr_stmt|;
else|else
operator|*
name|a
operator|=
operator|(
operator|*
name|x
operator|>>
literal|4
operator|)
operator|&
literal|0x0f
expr_stmt|;
operator|*
name|a
operator|++
operator||=
literal|0x30
expr_stmt|;
block|}
block|}
end_block

end_unit


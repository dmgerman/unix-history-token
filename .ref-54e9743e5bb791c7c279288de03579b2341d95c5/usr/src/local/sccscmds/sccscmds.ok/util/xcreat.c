begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_include
include|#
directive|include
file|"../hdr/macros.h"
end_include

begin_expr_stmt
name|SCCSID
argument_list|(
argument|@
operator|(
operator|#
operator|)
name|xcreat
literal|2.1
argument_list|)
expr_stmt|;
end_expr_stmt

begin_comment
comment|/* 	"Sensible" creat: write permission in directory is required in 	all cases, and created file is guaranteed to have specified mode 	and be owned by effective user. 	(It does this by first unlinking the file to be created.) 	Returns file descriptor on success, 	fatal() on failure. */
end_comment

begin_macro
name|xcreat
argument_list|(
argument|name
argument_list|,
argument|mode
argument_list|)
end_macro

begin_decl_stmt
name|char
modifier|*
name|name
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|mode
decl_stmt|;
end_decl_stmt

begin_block
block|{
specifier|register
name|int
name|fd
decl_stmt|;
specifier|register
name|char
modifier|*
name|d
decl_stmt|;
name|d
operator|=
name|alloc
argument_list|(
name|size
argument_list|(
name|name
argument_list|)
argument_list|)
expr_stmt|;
name|copy
argument_list|(
name|name
argument_list|,
name|d
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|exists
argument_list|(
name|dname
argument_list|(
name|d
argument_list|)
argument_list|)
condition|)
block|{
name|free
argument_list|(
name|d
argument_list|)
expr_stmt|;
name|sprintf
argument_list|(
name|Error
argument_list|,
literal|"directory `%s' nonexistent (ut1)"
argument_list|,
name|d
argument_list|)
expr_stmt|;
name|fatal
argument_list|(
name|Error
argument_list|)
expr_stmt|;
block|}
name|free
argument_list|(
name|d
argument_list|)
expr_stmt|;
name|unlink
argument_list|(
name|name
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|fd
operator|=
name|creat
argument_list|(
name|name
argument_list|,
name|mode
argument_list|)
operator|)
operator|>=
literal|0
condition|)
return|return
operator|(
name|fd
operator|)
return|;
return|return
operator|(
name|xmsg
argument_list|(
name|name
argument_list|,
literal|"xcreat"
argument_list|)
operator|)
return|;
block|}
end_block

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * 4.2BSD TCP/IP server for uucico - VMS version  * uucico's TCP channel causes this server to be run at the remote end.  *  *	Lou Salkind  *	New York University  */
end_comment

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_include
include|#
directive|include
file|<signal.h>
end_include

begin_include
include|#
directive|include
file|<sys/param.h>
end_include

begin_include
include|#
directive|include
file|<sys/socket.h>
end_include

begin_include
include|#
directive|include
file|<sys/ioctl.h>
end_include

begin_include
include|#
directive|include
file|<netinet/in.h>
end_include

begin_include
include|#
directive|include
file|<netdb.h>
end_include

begin_include
include|#
directive|include
file|<sys/wait.h>
end_include

begin_include
include|#
directive|include
file|<pwd.h>
end_include

begin_include
include|#
directive|include
file|<eunice/eunice.h>
end_include

begin_include
include|#
directive|include
file|<vms/uafdef.h>
end_include

begin_include
include|#
directive|include
file|<vms/pcbdef.h>
end_include

begin_include
include|#
directive|include
file|<vms/phddef.h>
end_include

begin_include
include|#
directive|include
file|<vms/jibdef.h>
end_include

begin_include
include|#
directive|include
file|<vms/arbdef.h>
end_include

begin_include
include|#
directive|include
file|<vms/prvdef.h>
end_include

begin_decl_stmt
name|struct
name|uaf
name|uaf
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* VMS UAF record for local user */
end_comment

begin_function_decl
name|struct
name|passwd
modifier|*
name|getpwnam
parameter_list|()
function_decl|;
end_function_decl

begin_decl_stmt
name|char
modifier|*
name|getenv
argument_list|()
decl_stmt|,
modifier|*
name|sprintf
argument_list|()
decl_stmt|;
end_decl_stmt

begin_function
name|main
parameter_list|(
name|argc
parameter_list|,
name|argv
parameter_list|)
name|int
name|argc
decl_stmt|;
name|char
modifier|*
modifier|*
name|argv
decl_stmt|;
block|{
name|struct
name|servent
modifier|*
name|sp
decl_stmt|;
name|char
name|user
index|[
literal|64
index|]
decl_stmt|;
name|char
name|passwd
index|[
literal|64
index|]
decl_stmt|;
name|char
modifier|*
name|p
decl_stmt|;
name|char
name|ebuf
index|[
literal|30
index|]
decl_stmt|;
name|struct
name|passwd
modifier|*
name|pwd
decl_stmt|;
name|struct
name|hostent
modifier|*
name|hp
decl_stmt|;
name|struct
name|sockaddr_in
name|from
decl_stmt|;
name|struct
name|sockaddr_in
modifier|*
name|fromp
decl_stmt|;
name|unsigned
name|int
modifier|*
name|q
decl_stmt|;
extern|extern Set_VMS_UAF_Info(
block|)
function|;
end_function

begin_decl_stmt
name|int
name|s
decl_stmt|;
end_decl_stmt

begin_block
block|{
comment|/* 		 *	Make stdin/stdout/stderr read/write 		 */
if|if
condition|(
name|FD_FAB_Pointer
index|[
literal|0
index|]
operator|->
name|status
operator|==
name|AUTO_OPENR
condition|)
name|FD_FAB_Pointer
index|[
literal|0
index|]
operator|->
name|status
operator|=
name|AUTO_OPENRW
expr_stmt|;
name|close
argument_list|(
literal|1
argument_list|)
expr_stmt|;
name|close
argument_list|(
literal|2
argument_list|)
expr_stmt|;
name|dup
argument_list|(
literal|0
argument_list|)
expr_stmt|;
name|dup
argument_list|(
literal|0
argument_list|)
expr_stmt|;
block|}
end_block

begin_expr_stmt
operator|(
name|void
operator|)
name|signal
argument_list|(
name|SIGINT
argument_list|,
name|SIG_DFL
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
operator|(
name|void
operator|)
name|signal
argument_list|(
name|SIGQUIT
argument_list|,
name|SIG_DFL
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
operator|(
name|void
operator|)
name|signal
argument_list|(
name|SIGTERM
argument_list|,
name|SIG_DFL
argument_list|)
expr_stmt|;
end_expr_stmt

begin_comment
comment|/* 	 * Get stuff out of the environment 	 */
end_comment

begin_expr_stmt
name|fromp
operator|=
operator|&
name|from
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|q
operator|=
operator|(
name|unsigned
name|int
operator|*
operator|)
name|fromp
expr_stmt|;
end_expr_stmt

begin_if
if|if
condition|(
operator|(
name|p
operator|=
name|getenv
argument_list|(
literal|"SYS$ERROR"
argument_list|)
operator|)
operator|==
name|NULL
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Can not translate SYS$ERROR\n"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
end_if

begin_expr_stmt
name|sscanf
argument_list|(
name|p
argument_list|,
literal|"%x,%x,%x,%x"
argument_list|,
operator|&
name|q
index|[
literal|0
index|]
argument_list|,
operator|&
name|q
index|[
literal|1
index|]
argument_list|,
operator|&
name|q
index|[
literal|2
index|]
argument_list|,
operator|&
name|q
index|[
literal|3
index|]
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|fromp
operator|->
name|sin_port
operator|=
name|ntohs
argument_list|(
operator|(
name|u_short
operator|)
name|fromp
operator|->
name|sin_port
argument_list|)
expr_stmt|;
end_expr_stmt

begin_if
if|if
condition|(
name|fromp
operator|->
name|sin_family
operator|!=
name|AF_INET
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"uucpd: malformed from address\n"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
end_if

begin_expr_stmt
name|hp
operator|=
name|gethostbyaddr
argument_list|(
operator|&
name|fromp
operator|->
name|sin_addr
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|in_addr
argument_list|)
argument_list|,
name|fromp
operator|->
name|sin_family
argument_list|)
expr_stmt|;
end_expr_stmt

begin_if
if|if
condition|(
name|hp
operator|==
literal|0
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Host name for your address unknown\n"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
end_if

begin_expr_stmt
name|alarm
argument_list|(
literal|60
argument_list|)
expr_stmt|;
end_expr_stmt

begin_if
if|if
condition|(
name|readline
argument_list|(
name|user
argument_list|,
sizeof|sizeof
name|user
argument_list|)
operator|<
literal|0
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"user read\n"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|0
argument_list|)
expr_stmt|;
block|}
end_if

begin_if
if|if
condition|(
name|readline
argument_list|(
name|passwd
argument_list|,
sizeof|sizeof
name|passwd
argument_list|)
operator|<
literal|0
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"passwd read\n"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|0
argument_list|)
expr_stmt|;
block|}
end_if

begin_expr_stmt
name|alarm
argument_list|(
literal|0
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|setpwent
argument_list|()
expr_stmt|;
end_expr_stmt

begin_if
if|if
condition|(
operator|!
operator|(
name|validate_vms_user
argument_list|(
name|user
argument_list|,
name|passwd
argument_list|,
operator|&
name|uaf
argument_list|)
operator|&
literal|1
operator|)
operator|||
operator|(
name|uaf
operator|.
name|uaf$b_flags
operator|&
name|UAF$M_DISACNT
operator|)
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Login incorrect.\n"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
end_if

begin_expr_stmt
name|pwd
operator|=
name|getpwnam
argument_list|(
name|user
argument_list|)
expr_stmt|;
end_expr_stmt

begin_if
if|if
condition|(
name|pwd
operator|==
name|NULL
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Login incorrect.\n"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
end_if

begin_expr_stmt
name|endpwent
argument_list|()
expr_stmt|;
end_expr_stmt

begin_if
if|if
condition|(
name|chdir
argument_list|(
name|pwd
operator|->
name|pw_dir
argument_list|)
operator|<
literal|0
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"No remote directory.\n"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
end_if

begin_expr_stmt
name|sys$cmkrnl
argument_list|(
name|Set_VMS_UAF_Info
argument_list|,
literal|0
argument_list|)
expr_stmt|;
end_expr_stmt

begin_comment
comment|/* Set the VMS environment info */
end_comment

begin_expr_stmt
name|sprintf
argument_list|(
name|ebuf
argument_list|,
literal|"-h%s"
argument_list|,
name|inet_ntoa
argument_list|(
name|from
operator|.
name|sin_addr
argument_list|)
argument_list|)
expr_stmt|;
end_expr_stmt

begin_if
if|if
condition|(
name|vfork
argument_list|()
operator|==
literal|0
condition|)
block|{
name|execl
argument_list|(
literal|"/usr/lib/uucp/uucico"
argument_list|,
literal|"uucico"
argument_list|,
name|ebuf
argument_list|,
operator|(
name|char
operator|*
operator|)
literal|0
argument_list|)
expr_stmt|;
name|perror
argument_list|(
literal|"uucico server: execl"
argument_list|)
expr_stmt|;
name|_exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
end_if

begin_expr_stmt
name|wait
argument_list|(
operator|&
name|s
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|exit
argument_list|(
literal|0
argument_list|)
expr_stmt|;
end_expr_stmt

begin_comment
unit|}
comment|/*  *  *	KERNEL Mode routine to stuff the PCB/JIB for this process with  *	the correct quotas/information from the VMS UAF record.  *  */
end_comment

begin_expr_stmt
unit|Set_VMS_UAF_Info
operator|(
operator|)
block|{
specifier|extern
expr|struct
name|PCB
operator|*
name|ctl$gl_pcb
block|;
specifier|extern
expr|struct
name|PHD
operator|*
name|ctl$gl_phd
block|;
specifier|extern
name|char
name|ctl$t_username
index|[]
block|,
name|ctl$t_account
index|[]
block|;
specifier|extern
name|unsigned
name|int
name|ctl$gq_procpriv
index|[
literal|2
index|]
block|;
specifier|register
expr|struct
name|PCB
operator|*
name|pcb
block|;
specifier|register
expr|struct
name|JIB
operator|*
name|jib
block|;
specifier|register
expr|struct
name|ARB
operator|*
name|arb
block|;
specifier|register
expr|struct
name|PHD
operator|*
name|phd
block|;
specifier|register
name|int
name|i
block|;
comment|/* 	 *	Get PCB and JIB pointers 	 */
name|pcb
operator|=
name|ctl$gl_pcb
block|;
name|phd
operator|=
name|ctl$gl_phd
block|;
name|jib
operator|=
name|pcb
operator|->
name|pcb$l_jib
block|;
name|arb
operator|=
name|pcb
operator|->
name|pcb$l_arb
block|;
comment|/* 	 *	Set our execution priority 	 */
name|sys$setpri
argument_list|(
literal|0
argument_list|,
literal|0
argument_list|,
name|uaf
operator|.
name|uaf$b_pri
argument_list|,
literal|0
argument_list|)
block|;
comment|/* DEFAULT DIRECTORY/DISK ALREADY SET */
comment|/* 	 *	Set username (space padded) 	 */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
sizeof|sizeof
argument_list|(
name|uaf
operator|.
name|uaf$t_username
argument_list|)
condition|;
name|i
operator|++
control|)
block|{
name|jib
operator|->
name|jib$t_username
index|[
name|i
index|]
operator|=
name|uaf
operator|.
name|uaf$t_username
index|[
name|i
index|]
expr_stmt|;
name|ctl$t_username
index|[
name|i
index|]
operator|=
name|uaf
operator|.
name|uaf$t_username
index|[
name|i
index|]
expr_stmt|;
block|}
end_expr_stmt

begin_for
for|for
control|(
name|i
operator|=
sizeof|sizeof
argument_list|(
name|uaf
operator|.
name|uaf$t_username
argument_list|)
init|;
name|i
operator|<
sizeof|sizeof
argument_list|(
name|jib
operator|->
name|jib$t_username
argument_list|)
condition|;
name|i
operator|++
control|)
block|{
name|jib
operator|->
name|jib$t_username
index|[
name|i
index|]
operator|=
literal|' '
expr_stmt|;
block|}
end_for

begin_comment
comment|/* 	 *	Set account (blank padded) [to ctl region as well???] 	 */
end_comment

begin_for
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
sizeof|sizeof
argument_list|(
name|uaf
operator|.
name|uaf$t_account
argument_list|)
condition|;
name|i
operator|++
control|)
block|{
name|jib
operator|->
name|jib$t_account
index|[
name|i
index|]
operator|=
name|uaf
operator|.
name|uaf$t_account
index|[
name|i
index|]
expr_stmt|;
name|ctl$t_account
index|[
name|i
index|]
operator|=
name|uaf
operator|.
name|uaf$t_account
index|[
name|i
index|]
expr_stmt|;
block|}
end_for

begin_for
for|for
control|(
name|i
operator|=
sizeof|sizeof
argument_list|(
name|uaf
operator|.
name|uaf$t_account
argument_list|)
init|;
name|i
operator|<
sizeof|sizeof
argument_list|(
name|jib
operator|->
name|jib$t_account
argument_list|)
condition|;
name|i
operator|++
control|)
block|{
name|jib
operator|->
name|jib$t_account
index|[
name|i
index|]
operator|=
literal|' '
expr_stmt|;
block|}
end_for

begin_comment
comment|/* 	 *	Set UIC 	 */
end_comment

begin_expr_stmt
name|arb
operator|->
name|arb$w_grp
operator|=
name|pcb
operator|->
name|pcb$w_grp
operator|=
name|uaf
operator|.
name|uaf$w_grp
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|arb
operator|->
name|arb$w_mem
operator|=
name|pcb
operator|->
name|pcb$w_mem
operator|=
name|uaf
operator|.
name|uaf$w_mem
expr_stmt|;
end_expr_stmt

begin_comment
comment|/* SET PROCESS NAME TO USERNAME?? */
end_comment

begin_comment
comment|/* 	 *	Set quotas 	 */
end_comment

begin_expr_stmt
name|i
operator|=
operator|(
name|uaf
operator|.
name|uaf$w_biolm
operator|-
name|pcb
operator|->
name|pcb$w_biolm
operator|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|pcb
operator|->
name|pcb$w_biolm
operator|+=
name|i
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|pcb
operator|->
name|pcb$w_biocnt
operator|+=
name|i
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|i
operator|=
operator|(
name|uaf
operator|.
name|uaf$w_diolm
operator|-
name|pcb
operator|->
name|pcb$w_diolm
operator|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|pcb
operator|->
name|pcb$w_diolm
operator|+=
name|i
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|pcb
operator|->
name|pcb$w_diocnt
operator|+=
name|i
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|i
operator|=
name|uaf
operator|.
name|uaf$l_bytlm
condition|?
name|uaf
operator|.
name|uaf$l_bytlm
else|:
name|uaf
operator|.
name|uaf$w_bytlm
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|i
operator|=
name|i
operator|-
name|jib
operator|->
name|jib$l_bytlm
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|jib
operator|->
name|jib$l_bytlm
operator|+=
name|i
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|jib
operator|->
name|jib$l_bytcnt
operator|+=
name|i
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|jib
operator|->
name|jib$w_prclim
operator|=
name|uaf
operator|.
name|uaf$w_prccnt
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|i
operator|=
operator|(
name|uaf
operator|.
name|uaf$w_fillm
operator|-
name|jib
operator|->
name|jib$w_fillm
operator|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|jib
operator|->
name|jib$w_fillm
operator|+=
name|i
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|jib
operator|->
name|jib$w_filcnt
operator|+=
name|i
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|i
operator|=
operator|*
operator|(
operator|(
name|int
operator|*
operator|)
operator|&
name|uaf
operator|.
name|uaf$w_pgflquota
index|[
literal|0
index|]
operator|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|i
operator|=
operator|(
name|i
operator|-
name|jib
operator|->
name|jib$l_pgflquota
operator|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|jib
operator|->
name|jib$l_pgflquota
operator|+=
name|i
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|jib
operator|->
name|jib$l_pgflcnt
operator|+=
name|i
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|i
operator|=
operator|(
name|uaf
operator|.
name|uaf$w_tqcnt
operator|-
name|jib
operator|->
name|jib$w_tqlm
operator|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|jib
operator|->
name|jib$w_tqlm
operator|+=
name|i
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|jib
operator|->
name|jib$w_tqcnt
operator|+=
name|i
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|i
operator|=
operator|(
name|uaf
operator|.
name|uaf$w_enqlm
operator|-
name|jib
operator|->
name|jib$w_enqlim
operator|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|jib
operator|->
name|jib$w_enqlim
operator|+=
name|i
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|jib
operator|->
name|jib$w_enqcnt
operator|+=
name|i
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|i
operator|=
operator|(
name|uaf
operator|.
name|uaf$w_shrfillm
operator|-
name|jib
operator|->
name|jib$w_shrflim
operator|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|jib
operator|->
name|jib$w_shrflim
operator|+=
name|i
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|jib
operator|->
name|jib$w_shrfcnt
operator|+=
name|i
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|i
operator|=
operator|(
name|uaf
operator|.
name|uaf$l_pbytlm
operator|-
name|jib
operator|->
name|jib$l_pbytlim
operator|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|jib
operator|->
name|jib$l_pbytlim
operator|+=
name|i
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|jib
operator|->
name|jib$l_pbytcnt
operator|+=
name|i
expr_stmt|;
end_expr_stmt

begin_comment
comment|/* 	 *	Fill in privileges 	 */
end_comment

begin_expr_stmt
name|i
operator|=
operator|*
operator|(
operator|(
name|int
operator|*
operator|)
operator|&
name|uaf
operator|.
name|uaf$l_priv
index|[
literal|0
index|]
operator|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|i
operator|&=
operator|~
operator|(
literal|1
operator|<<
name|PRV$V_BYPASS
operator|)
expr_stmt|;
end_expr_stmt

begin_comment
comment|/* TOO DANGEROUS TO GIVE TO USER */
end_comment

begin_expr_stmt
name|pcb
operator|->
name|pcb$q_priv
index|[
literal|0
index|]
operator|=
name|i
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|arb
operator|->
name|arb$q_priv
index|[
literal|0
index|]
operator|=
name|i
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|jib
operator|->
name|jib$q_priv
index|[
literal|0
index|]
operator|=
name|i
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|phd
operator|->
name|phd$q_authpriv
index|[
literal|0
index|]
operator|=
name|i
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|ctl$gq_procpriv
index|[
literal|0
index|]
operator|=
name|i
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|i
operator|=
operator|*
operator|(
operator|(
name|int
operator|*
operator|)
operator|&
name|uaf
operator|.
name|uaf$l_priv
index|[
literal|2
index|]
operator|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|pcb
operator|->
name|pcb$q_priv
index|[
literal|1
index|]
operator|=
name|i
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|arb
operator|->
name|arb$q_priv
index|[
literal|1
index|]
operator|=
name|i
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|jib
operator|->
name|jib$q_priv
index|[
literal|1
index|]
operator|=
name|i
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|phd
operator|->
name|phd$q_authpriv
index|[
literal|1
index|]
operator|=
name|i
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|ctl$gq_procpriv
index|[
literal|1
index|]
operator|=
name|i
expr_stmt|;
end_expr_stmt

begin_escape
unit|}
end_escape

begin_comment
comment|/*  *	Read a line from standard input (NETWORK)  */
end_comment

begin_expr_stmt
unit|readline
operator|(
name|p
operator|,
name|n
operator|)
specifier|register
name|char
operator|*
name|p
expr_stmt|;
end_expr_stmt

begin_decl_stmt
specifier|register
name|int
name|n
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|char
name|c
decl_stmt|;
while|while
condition|(
name|n
operator|--
operator|>
literal|0
condition|)
block|{
if|if
condition|(
name|read
argument_list|(
literal|0
argument_list|,
operator|&
name|c
argument_list|,
literal|1
argument_list|)
operator|<=
literal|0
condition|)
return|return
operator|(
operator|-
literal|1
operator|)
return|;
name|c
operator|&=
literal|0177
expr_stmt|;
if|if
condition|(
name|c
operator|==
literal|'\n'
operator|||
name|c
operator|==
literal|'\r'
condition|)
block|{
operator|*
name|p
operator|=
literal|'\0'
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
operator|*
name|p
operator|++
operator|=
name|c
expr_stmt|;
block|}
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
end_block

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Portions Copyright (C) 2004-2010  Internet Systems Consortium, Inc. ("ISC")  * Portions Copyright (C) 1999-2003  Internet Software Consortium.  *  * Permission to use, copy, modify, and/or distribute this software for any  * purpose with or without fee is hereby granted, provided that the above  * copyright notice and this permission notice appear in all copies.  *  * THE SOFTWARE IS PROVIDED "AS IS" AND ISC AND NETWORK ASSOCIATES DISCLAIMS  * ALL WARRANTIES WITH REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED  * WARRANTIES OF MERCHANTABILITY AND FITNESS.  IN NO EVENT SHALL ISC BE LIABLE  * FOR ANY SPECIAL, DIRECT, INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES  * WHATSOEVER RESULTING FROM LOSS OF USE, DATA OR PROFITS, WHETHER IN AN  * ACTION OF CONTRACT, NEGLIGENCE OR OTHER TORTIOUS ACTION, ARISING OUT OF OR  * IN CONNECTION WITH THE USE OR PERFORMANCE OF THIS SOFTWARE.  *  * Portions Copyright (C) 1995-2000 by Network Associates, Inc.  *  * Permission to use, copy, modify, and/or distribute this software for any  * purpose with or without fee is hereby granted, provided that the above  * copyright notice and this permission notice appear in all copies.  *  * THE SOFTWARE IS PROVIDED "AS IS" AND ISC AND NETWORK ASSOCIATES DISCLAIMS  * ALL WARRANTIES WITH REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED  * WARRANTIES OF MERCHANTABILITY AND FITNESS.  IN NO EVENT SHALL ISC BE LIABLE  * FOR ANY SPECIAL, DIRECT, INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES  * WHATSOEVER RESULTING FROM LOSS OF USE, DATA OR PROFITS, WHETHER IN AN  * ACTION OF CONTRACT, NEGLIGENCE OR OTHER TORTIOUS ACTION, ARISING OUT OF OR  * IN CONNECTION WITH THE USE OR PERFORMANCE OF THIS SOFTWARE.  */
end_comment

begin_comment
comment|/* $Id: dnssec-signzone.c,v 1.262 2010-06-03 23:51:04 tbox Exp $ */
end_comment

begin_comment
comment|/*! \file */
end_comment

begin_include
include|#
directive|include
file|<config.h>
end_include

begin_include
include|#
directive|include
file|<stdlib.h>
end_include

begin_include
include|#
directive|include
file|<time.h>
end_include

begin_include
include|#
directive|include
file|<isc/app.h>
end_include

begin_include
include|#
directive|include
file|<isc/base32.h>
end_include

begin_include
include|#
directive|include
file|<isc/commandline.h>
end_include

begin_include
include|#
directive|include
file|<isc/entropy.h>
end_include

begin_include
include|#
directive|include
file|<isc/event.h>
end_include

begin_include
include|#
directive|include
file|<isc/file.h>
end_include

begin_include
include|#
directive|include
file|<isc/hash.h>
end_include

begin_include
include|#
directive|include
file|<isc/hex.h>
end_include

begin_include
include|#
directive|include
file|<isc/mem.h>
end_include

begin_include
include|#
directive|include
file|<isc/mutex.h>
end_include

begin_include
include|#
directive|include
file|<isc/os.h>
end_include

begin_include
include|#
directive|include
file|<isc/print.h>
end_include

begin_include
include|#
directive|include
file|<isc/random.h>
end_include

begin_include
include|#
directive|include
file|<isc/rwlock.h>
end_include

begin_include
include|#
directive|include
file|<isc/serial.h>
end_include

begin_include
include|#
directive|include
file|<isc/stdio.h>
end_include

begin_include
include|#
directive|include
file|<isc/stdlib.h>
end_include

begin_include
include|#
directive|include
file|<isc/string.h>
end_include

begin_include
include|#
directive|include
file|<isc/task.h>
end_include

begin_include
include|#
directive|include
file|<isc/time.h>
end_include

begin_include
include|#
directive|include
file|<isc/util.h>
end_include

begin_include
include|#
directive|include
file|<dns/db.h>
end_include

begin_include
include|#
directive|include
file|<dns/dbiterator.h>
end_include

begin_include
include|#
directive|include
file|<dns/diff.h>
end_include

begin_include
include|#
directive|include
file|<dns/dnssec.h>
end_include

begin_include
include|#
directive|include
file|<dns/ds.h>
end_include

begin_include
include|#
directive|include
file|<dns/fixedname.h>
end_include

begin_include
include|#
directive|include
file|<dns/keyvalues.h>
end_include

begin_include
include|#
directive|include
file|<dns/log.h>
end_include

begin_include
include|#
directive|include
file|<dns/master.h>
end_include

begin_include
include|#
directive|include
file|<dns/masterdump.h>
end_include

begin_include
include|#
directive|include
file|<dns/nsec.h>
end_include

begin_include
include|#
directive|include
file|<dns/nsec3.h>
end_include

begin_include
include|#
directive|include
file|<dns/rdata.h>
end_include

begin_include
include|#
directive|include
file|<dns/rdatalist.h>
end_include

begin_include
include|#
directive|include
file|<dns/rdataset.h>
end_include

begin_include
include|#
directive|include
file|<dns/rdataclass.h>
end_include

begin_include
include|#
directive|include
file|<dns/rdatasetiter.h>
end_include

begin_include
include|#
directive|include
file|<dns/rdatastruct.h>
end_include

begin_include
include|#
directive|include
file|<dns/rdatatype.h>
end_include

begin_include
include|#
directive|include
file|<dns/result.h>
end_include

begin_include
include|#
directive|include
file|<dns/soa.h>
end_include

begin_include
include|#
directive|include
file|<dns/time.h>
end_include

begin_include
include|#
directive|include
file|<dst/dst.h>
end_include

begin_include
include|#
directive|include
file|"dnssectool.h"
end_include

begin_ifndef
ifndef|#
directive|ifndef
name|PATH_MAX
end_ifndef

begin_define
define|#
directive|define
name|PATH_MAX
value|1024
end_define

begin_comment
comment|/* AIX, WIN32, and others don't define this. */
end_comment

begin_endif
endif|#
directive|endif
end_endif

begin_decl_stmt
specifier|const
name|char
modifier|*
name|program
init|=
literal|"dnssec-signzone"
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|verbose
decl_stmt|;
end_decl_stmt

begin_typedef
typedef|typedef
name|struct
name|hashlist
name|hashlist_t
typedef|;
end_typedef

begin_decl_stmt
specifier|static
name|int
name|nsec_datatype
init|=
name|dns_rdatatype_nsec
decl_stmt|;
end_decl_stmt

begin_define
define|#
directive|define
name|IS_NSEC3
value|(nsec_datatype == dns_rdatatype_nsec3)
end_define

begin_define
define|#
directive|define
name|OPTOUT
parameter_list|(
name|x
parameter_list|)
value|(((x)& DNS_NSEC3FLAG_OPTOUT) != 0)
end_define

begin_define
define|#
directive|define
name|REVOKE
parameter_list|(
name|x
parameter_list|)
value|((dst_key_flags(x)& DNS_KEYFLAG_REVOKE) != 0)
end_define

begin_define
define|#
directive|define
name|BUFSIZE
value|2048
end_define

begin_define
define|#
directive|define
name|MAXDSKEYS
value|8
end_define

begin_define
define|#
directive|define
name|SIGNER_EVENTCLASS
value|ISC_EVENTCLASS(0x4453)
end_define

begin_define
define|#
directive|define
name|SIGNER_EVENT_WRITE
value|(SIGNER_EVENTCLASS + 0)
end_define

begin_define
define|#
directive|define
name|SIGNER_EVENT_WORK
value|(SIGNER_EVENTCLASS + 1)
end_define

begin_define
define|#
directive|define
name|SOA_SERIAL_KEEP
value|0
end_define

begin_define
define|#
directive|define
name|SOA_SERIAL_INCREMENT
value|1
end_define

begin_define
define|#
directive|define
name|SOA_SERIAL_UNIXTIME
value|2
end_define

begin_typedef
typedef|typedef
name|struct
name|signer_event
name|sevent_t
typedef|;
end_typedef

begin_struct
struct|struct
name|signer_event
block|{
name|ISC_EVENT_COMMON
argument_list|(
name|sevent_t
argument_list|)
expr_stmt|;
name|dns_fixedname_t
modifier|*
name|fname
decl_stmt|;
name|dns_dbnode_t
modifier|*
name|node
decl_stmt|;
block|}
struct|;
end_struct

begin_decl_stmt
specifier|static
name|dns_dnsseckeylist_t
name|keylist
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|unsigned
name|int
name|keycount
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|isc_rwlock_t
name|keylist_lock
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|isc_stdtime_t
name|starttime
init|=
literal|0
decl_stmt|,
name|endtime
init|=
literal|0
decl_stmt|,
name|now
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|cycle
init|=
operator|-
literal|1
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|jitter
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|isc_boolean_t
name|tryverify
init|=
name|ISC_FALSE
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|isc_boolean_t
name|printstats
init|=
name|ISC_FALSE
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|isc_mem_t
modifier|*
name|mctx
init|=
name|NULL
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|isc_entropy_t
modifier|*
name|ectx
init|=
name|NULL
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|dns_ttl_t
name|zone_soa_min_ttl
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|dns_ttl_t
name|soa_ttl
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|FILE
modifier|*
name|fp
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|char
modifier|*
name|tempfile
init|=
name|NULL
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
specifier|const
name|dns_master_style_t
modifier|*
name|masterstyle
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|dns_masterformat_t
name|inputformat
init|=
name|dns_masterformat_text
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|dns_masterformat_t
name|outputformat
init|=
name|dns_masterformat_text
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|unsigned
name|int
name|nsigned
init|=
literal|0
decl_stmt|,
name|nretained
init|=
literal|0
decl_stmt|,
name|ndropped
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|unsigned
name|int
name|nverified
init|=
literal|0
decl_stmt|,
name|nverifyfailed
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
specifier|const
name|char
modifier|*
name|directory
init|=
name|NULL
decl_stmt|,
modifier|*
name|dsdir
init|=
name|NULL
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|isc_mutex_t
name|namelock
decl_stmt|,
name|statslock
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|isc_taskmgr_t
modifier|*
name|taskmgr
init|=
name|NULL
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|dns_db_t
modifier|*
name|gdb
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* The database */
end_comment

begin_decl_stmt
specifier|static
name|dns_dbversion_t
modifier|*
name|gversion
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* The database version */
end_comment

begin_decl_stmt
specifier|static
name|dns_dbiterator_t
modifier|*
name|gdbiter
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* The database iterator */
end_comment

begin_decl_stmt
specifier|static
name|dns_rdataclass_t
name|gclass
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* The class */
end_comment

begin_decl_stmt
specifier|static
name|dns_name_t
modifier|*
name|gorigin
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* The database origin */
end_comment

begin_decl_stmt
specifier|static
name|int
name|nsec3flags
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|dns_iterations_t
name|nsec3iter
init|=
literal|10U
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|unsigned
name|char
name|saltbuf
index|[
literal|255
index|]
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|unsigned
name|char
modifier|*
name|salt
init|=
name|saltbuf
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|size_t
name|salt_length
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|isc_task_t
modifier|*
name|master
init|=
name|NULL
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|unsigned
name|int
name|ntasks
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|isc_boolean_t
name|shuttingdown
init|=
name|ISC_FALSE
decl_stmt|,
name|finished
init|=
name|ISC_FALSE
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|isc_boolean_t
name|nokeys
init|=
name|ISC_FALSE
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|isc_boolean_t
name|removefile
init|=
name|ISC_FALSE
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|isc_boolean_t
name|generateds
init|=
name|ISC_FALSE
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|isc_boolean_t
name|ignore_kskflag
init|=
name|ISC_FALSE
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|isc_boolean_t
name|keyset_kskonly
init|=
name|ISC_FALSE
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|dns_name_t
modifier|*
name|dlv
init|=
name|NULL
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|dns_fixedname_t
name|dlv_fixed
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|dns_master_style_t
modifier|*
name|dsstyle
init|=
name|NULL
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|unsigned
name|int
name|serialformat
init|=
name|SOA_SERIAL_KEEP
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|unsigned
name|int
name|hash_length
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|isc_boolean_t
name|unknownalg
init|=
name|ISC_FALSE
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|isc_boolean_t
name|disable_zone_check
init|=
name|ISC_FALSE
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|isc_boolean_t
name|update_chain
init|=
name|ISC_FALSE
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|isc_boolean_t
name|set_keyttl
init|=
name|ISC_FALSE
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|dns_ttl_t
name|keyttl
decl_stmt|;
end_decl_stmt

begin_define
define|#
directive|define
name|INCSTAT
parameter_list|(
name|counter
parameter_list|)
define|\
value|if (printstats) {		\ 		LOCK(&statslock);	\ 		counter++;		\ 		UNLOCK(&statslock);	\ 	}
end_define

begin_function_decl
specifier|static
name|void
name|sign
parameter_list|(
name|isc_task_t
modifier|*
name|task
parameter_list|,
name|isc_event_t
modifier|*
name|event
parameter_list|)
function_decl|;
end_function_decl

begin_define
define|#
directive|define
name|check_dns_dbiterator_current
parameter_list|(
name|result
parameter_list|)
define|\
value|check_result((result == DNS_R_NEWORIGIN) ? ISC_R_SUCCESS : result, \ 		     "dns_dbiterator_current()")
end_define

begin_function
specifier|static
name|void
name|dumpnode
parameter_list|(
name|dns_name_t
modifier|*
name|name
parameter_list|,
name|dns_dbnode_t
modifier|*
name|node
parameter_list|)
block|{
name|isc_result_t
name|result
decl_stmt|;
if|if
condition|(
name|outputformat
operator|!=
name|dns_masterformat_text
condition|)
return|return;
name|result
operator|=
name|dns_master_dumpnodetostream
argument_list|(
name|mctx
argument_list|,
name|gdb
argument_list|,
name|gversion
argument_list|,
name|node
argument_list|,
name|name
argument_list|,
name|masterstyle
argument_list|,
name|fp
argument_list|)
expr_stmt|;
name|check_result
argument_list|(
name|result
argument_list|,
literal|"dns_master_dumpnodetostream"
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*%  * Sign the given RRset with given key, and add the signature record to the  * given tuple.  */
end_comment

begin_function
specifier|static
name|void
name|signwithkey
parameter_list|(
name|dns_name_t
modifier|*
name|name
parameter_list|,
name|dns_rdataset_t
modifier|*
name|rdataset
parameter_list|,
name|dst_key_t
modifier|*
name|key
parameter_list|,
name|dns_ttl_t
name|ttl
parameter_list|,
name|dns_diff_t
modifier|*
name|add
parameter_list|,
specifier|const
name|char
modifier|*
name|logmsg
parameter_list|)
block|{
name|isc_result_t
name|result
decl_stmt|;
name|isc_stdtime_t
name|jendtime
decl_stmt|;
name|char
name|keystr
index|[
name|DST_KEY_FORMATSIZE
index|]
decl_stmt|;
name|dns_rdata_t
name|trdata
init|=
name|DNS_RDATA_INIT
decl_stmt|;
name|unsigned
name|char
name|array
index|[
name|BUFSIZE
index|]
decl_stmt|;
name|isc_buffer_t
name|b
decl_stmt|;
name|dns_difftuple_t
modifier|*
name|tuple
decl_stmt|;
name|dst_key_format
argument_list|(
name|key
argument_list|,
name|keystr
argument_list|,
sizeof|sizeof
argument_list|(
name|keystr
argument_list|)
argument_list|)
expr_stmt|;
name|vbprintf
argument_list|(
literal|1
argument_list|,
literal|"\t%s %s\n"
argument_list|,
name|logmsg
argument_list|,
name|keystr
argument_list|)
expr_stmt|;
name|jendtime
operator|=
operator|(
name|jitter
operator|!=
literal|0
operator|)
condition|?
name|isc_random_jitter
argument_list|(
name|endtime
argument_list|,
name|jitter
argument_list|)
else|:
name|endtime
expr_stmt|;
name|isc_buffer_init
argument_list|(
operator|&
name|b
argument_list|,
name|array
argument_list|,
sizeof|sizeof
argument_list|(
name|array
argument_list|)
argument_list|)
expr_stmt|;
name|result
operator|=
name|dns_dnssec_sign
argument_list|(
name|name
argument_list|,
name|rdataset
argument_list|,
name|key
argument_list|,
operator|&
name|starttime
argument_list|,
operator|&
name|jendtime
argument_list|,
name|mctx
argument_list|,
operator|&
name|b
argument_list|,
operator|&
name|trdata
argument_list|)
expr_stmt|;
name|isc_entropy_stopcallbacksources
argument_list|(
name|ectx
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
block|{
name|char
name|keystr
index|[
name|DST_KEY_FORMATSIZE
index|]
decl_stmt|;
name|dst_key_format
argument_list|(
name|key
argument_list|,
name|keystr
argument_list|,
sizeof|sizeof
argument_list|(
name|keystr
argument_list|)
argument_list|)
expr_stmt|;
name|fatal
argument_list|(
literal|"dnskey '%s' failed to sign data: %s"
argument_list|,
name|keystr
argument_list|,
name|isc_result_totext
argument_list|(
name|result
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|INCSTAT
argument_list|(
name|nsigned
argument_list|)
expr_stmt|;
if|if
condition|(
name|tryverify
condition|)
block|{
name|result
operator|=
name|dns_dnssec_verify
argument_list|(
name|name
argument_list|,
name|rdataset
argument_list|,
name|key
argument_list|,
name|ISC_TRUE
argument_list|,
name|mctx
argument_list|,
operator|&
name|trdata
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|==
name|ISC_R_SUCCESS
condition|)
block|{
name|vbprintf
argument_list|(
literal|3
argument_list|,
literal|"\tsignature verified\n"
argument_list|)
expr_stmt|;
name|INCSTAT
argument_list|(
name|nverified
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|vbprintf
argument_list|(
literal|3
argument_list|,
literal|"\tsignature failed to verify\n"
argument_list|)
expr_stmt|;
name|INCSTAT
argument_list|(
name|nverifyfailed
argument_list|)
expr_stmt|;
block|}
block|}
name|tuple
operator|=
name|NULL
expr_stmt|;
name|result
operator|=
name|dns_difftuple_create
argument_list|(
name|mctx
argument_list|,
name|DNS_DIFFOP_ADD
argument_list|,
name|name
argument_list|,
name|ttl
argument_list|,
operator|&
name|trdata
argument_list|,
operator|&
name|tuple
argument_list|)
expr_stmt|;
name|check_result
argument_list|(
name|result
argument_list|,
literal|"dns_difftuple_create"
argument_list|)
expr_stmt|;
name|dns_diff_append
argument_list|(
name|add
argument_list|,
operator|&
name|tuple
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
specifier|inline
name|isc_boolean_t
name|issigningkey
parameter_list|(
name|dns_dnsseckey_t
modifier|*
name|key
parameter_list|)
block|{
return|return
operator|(
name|key
operator|->
name|force_sign
operator|||
name|key
operator|->
name|hint_sign
operator|)
return|;
block|}
end_function

begin_function
specifier|static
specifier|inline
name|isc_boolean_t
name|iszonekey
parameter_list|(
name|dns_dnsseckey_t
modifier|*
name|key
parameter_list|)
block|{
return|return
operator|(
name|ISC_TF
argument_list|(
name|dns_name_equal
argument_list|(
name|dst_key_name
argument_list|(
name|key
operator|->
name|key
argument_list|)
argument_list|,
name|gorigin
argument_list|)
operator|&&
name|dst_key_iszonekey
argument_list|(
name|key
operator|->
name|key
argument_list|)
argument_list|)
operator|)
return|;
block|}
end_function

begin_function
specifier|static
specifier|inline
name|isc_boolean_t
name|isksk
parameter_list|(
name|dns_dnsseckey_t
modifier|*
name|key
parameter_list|)
block|{
return|return
operator|(
name|key
operator|->
name|ksk
operator|)
return|;
block|}
end_function

begin_function
specifier|static
specifier|inline
name|isc_boolean_t
name|iszsk
parameter_list|(
name|dns_dnsseckey_t
modifier|*
name|key
parameter_list|)
block|{
return|return
operator|(
name|ignore_kskflag
operator|||
operator|!
name|key
operator|->
name|ksk
operator|)
return|;
block|}
end_function

begin_comment
comment|/*%  * Find the key that generated an RRSIG, if it is in the key list.  If  * so, return a pointer to it, otherwise return NULL.  *  * No locking is performed here, this must be done by the caller.  */
end_comment

begin_function
specifier|static
name|dns_dnsseckey_t
modifier|*
name|keythatsigned_unlocked
parameter_list|(
name|dns_rdata_rrsig_t
modifier|*
name|rrsig
parameter_list|)
block|{
name|dns_dnsseckey_t
modifier|*
name|key
decl_stmt|;
for|for
control|(
name|key
operator|=
name|ISC_LIST_HEAD
argument_list|(
name|keylist
argument_list|)
init|;
name|key
operator|!=
name|NULL
condition|;
name|key
operator|=
name|ISC_LIST_NEXT
argument_list|(
name|key
argument_list|,
name|link
argument_list|)
control|)
block|{
if|if
condition|(
name|rrsig
operator|->
name|keyid
operator|==
name|dst_key_id
argument_list|(
name|key
operator|->
name|key
argument_list|)
operator|&&
name|rrsig
operator|->
name|algorithm
operator|==
name|dst_key_alg
argument_list|(
name|key
operator|->
name|key
argument_list|)
operator|&&
name|dns_name_equal
argument_list|(
operator|&
name|rrsig
operator|->
name|signer
argument_list|,
name|dst_key_name
argument_list|(
name|key
operator|->
name|key
argument_list|)
argument_list|)
condition|)
return|return
operator|(
name|key
operator|)
return|;
block|}
return|return
operator|(
name|NULL
operator|)
return|;
block|}
end_function

begin_comment
comment|/*%  * Finds the key that generated a RRSIG, if possible.  First look at the keys  * that we've loaded already, and then see if there's a key on disk.  */
end_comment

begin_function
specifier|static
name|dns_dnsseckey_t
modifier|*
name|keythatsigned
parameter_list|(
name|dns_rdata_rrsig_t
modifier|*
name|rrsig
parameter_list|)
block|{
name|isc_result_t
name|result
decl_stmt|;
name|dst_key_t
modifier|*
name|pubkey
init|=
name|NULL
decl_stmt|,
modifier|*
name|privkey
init|=
name|NULL
decl_stmt|;
name|dns_dnsseckey_t
modifier|*
name|key
init|=
name|NULL
decl_stmt|;
name|isc_rwlock_lock
argument_list|(
operator|&
name|keylist_lock
argument_list|,
name|isc_rwlocktype_read
argument_list|)
expr_stmt|;
name|key
operator|=
name|keythatsigned_unlocked
argument_list|(
name|rrsig
argument_list|)
expr_stmt|;
name|isc_rwlock_unlock
argument_list|(
operator|&
name|keylist_lock
argument_list|,
name|isc_rwlocktype_read
argument_list|)
expr_stmt|;
if|if
condition|(
name|key
operator|!=
name|NULL
condition|)
return|return
operator|(
name|key
operator|)
return|;
comment|/* 	 * We did not find the key in our list.  Get a write lock now, since 	 * we may be modifying the bits.  We could do the tryupgrade() dance, 	 * but instead just get a write lock and check once again to see if 	 * it is on our list.  It's possible someone else may have added it 	 * after all. 	 */
name|isc_rwlock_lock
argument_list|(
operator|&
name|keylist_lock
argument_list|,
name|isc_rwlocktype_write
argument_list|)
expr_stmt|;
name|key
operator|=
name|keythatsigned_unlocked
argument_list|(
name|rrsig
argument_list|)
expr_stmt|;
if|if
condition|(
name|key
operator|!=
name|NULL
condition|)
block|{
name|isc_rwlock_unlock
argument_list|(
operator|&
name|keylist_lock
argument_list|,
name|isc_rwlocktype_write
argument_list|)
expr_stmt|;
return|return
operator|(
name|key
operator|)
return|;
block|}
name|result
operator|=
name|dst_key_fromfile
argument_list|(
operator|&
name|rrsig
operator|->
name|signer
argument_list|,
name|rrsig
operator|->
name|keyid
argument_list|,
name|rrsig
operator|->
name|algorithm
argument_list|,
name|DST_TYPE_PUBLIC
argument_list|,
name|directory
argument_list|,
name|mctx
argument_list|,
operator|&
name|pubkey
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
block|{
name|isc_rwlock_unlock
argument_list|(
operator|&
name|keylist_lock
argument_list|,
name|isc_rwlocktype_write
argument_list|)
expr_stmt|;
return|return
operator|(
name|NULL
operator|)
return|;
block|}
name|result
operator|=
name|dst_key_fromfile
argument_list|(
operator|&
name|rrsig
operator|->
name|signer
argument_list|,
name|rrsig
operator|->
name|keyid
argument_list|,
name|rrsig
operator|->
name|algorithm
argument_list|,
name|DST_TYPE_PUBLIC
operator||
name|DST_TYPE_PRIVATE
argument_list|,
name|directory
argument_list|,
name|mctx
argument_list|,
operator|&
name|privkey
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|==
name|ISC_R_SUCCESS
condition|)
block|{
name|dst_key_free
argument_list|(
operator|&
name|pubkey
argument_list|)
expr_stmt|;
name|dns_dnsseckey_create
argument_list|(
name|mctx
argument_list|,
operator|&
name|privkey
argument_list|,
operator|&
name|key
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|dns_dnsseckey_create
argument_list|(
name|mctx
argument_list|,
operator|&
name|pubkey
argument_list|,
operator|&
name|key
argument_list|)
expr_stmt|;
block|}
name|key
operator|->
name|force_publish
operator|=
name|ISC_TRUE
expr_stmt|;
name|key
operator|->
name|force_sign
operator|=
name|ISC_FALSE
expr_stmt|;
name|ISC_LIST_APPEND
argument_list|(
name|keylist
argument_list|,
name|key
argument_list|,
name|link
argument_list|)
expr_stmt|;
name|isc_rwlock_unlock
argument_list|(
operator|&
name|keylist_lock
argument_list|,
name|isc_rwlocktype_write
argument_list|)
expr_stmt|;
return|return
operator|(
name|key
operator|)
return|;
block|}
end_function

begin_comment
comment|/*%  * Check to see if we expect to find a key at this name.  If we see a RRSIG  * and can't find the signing key that we expect to find, we drop the rrsig.  * I'm not sure if this is completely correct, but it seems to work.  */
end_comment

begin_function
specifier|static
name|isc_boolean_t
name|expecttofindkey
parameter_list|(
name|dns_name_t
modifier|*
name|name
parameter_list|)
block|{
name|unsigned
name|int
name|options
init|=
name|DNS_DBFIND_NOWILD
decl_stmt|;
name|dns_fixedname_t
name|fname
decl_stmt|;
name|isc_result_t
name|result
decl_stmt|;
name|char
name|namestr
index|[
name|DNS_NAME_FORMATSIZE
index|]
decl_stmt|;
name|dns_fixedname_init
argument_list|(
operator|&
name|fname
argument_list|)
expr_stmt|;
name|result
operator|=
name|dns_db_find
argument_list|(
name|gdb
argument_list|,
name|name
argument_list|,
name|gversion
argument_list|,
name|dns_rdatatype_dnskey
argument_list|,
name|options
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|,
name|dns_fixedname_name
argument_list|(
operator|&
name|fname
argument_list|)
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|result
condition|)
block|{
case|case
name|ISC_R_SUCCESS
case|:
case|case
name|DNS_R_NXDOMAIN
case|:
case|case
name|DNS_R_NXRRSET
case|:
return|return
operator|(
name|ISC_TRUE
operator|)
return|;
case|case
name|DNS_R_DELEGATION
case|:
case|case
name|DNS_R_CNAME
case|:
case|case
name|DNS_R_DNAME
case|:
return|return
operator|(
name|ISC_FALSE
operator|)
return|;
block|}
name|dns_name_format
argument_list|(
name|name
argument_list|,
name|namestr
argument_list|,
sizeof|sizeof
argument_list|(
name|namestr
argument_list|)
argument_list|)
expr_stmt|;
name|fatal
argument_list|(
literal|"failure looking for '%s DNSKEY' in database: %s"
argument_list|,
name|namestr
argument_list|,
name|isc_result_totext
argument_list|(
name|result
argument_list|)
argument_list|)
expr_stmt|;
comment|/* NOTREACHED */
return|return
operator|(
name|ISC_FALSE
operator|)
return|;
comment|/* removes a warning */
block|}
end_function

begin_function
specifier|static
specifier|inline
name|isc_boolean_t
name|setverifies
parameter_list|(
name|dns_name_t
modifier|*
name|name
parameter_list|,
name|dns_rdataset_t
modifier|*
name|set
parameter_list|,
name|dst_key_t
modifier|*
name|key
parameter_list|,
name|dns_rdata_t
modifier|*
name|rrsig
parameter_list|)
block|{
name|isc_result_t
name|result
decl_stmt|;
name|result
operator|=
name|dns_dnssec_verify
argument_list|(
name|name
argument_list|,
name|set
argument_list|,
name|key
argument_list|,
name|ISC_FALSE
argument_list|,
name|mctx
argument_list|,
name|rrsig
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|==
name|ISC_R_SUCCESS
condition|)
block|{
name|INCSTAT
argument_list|(
name|nverified
argument_list|)
expr_stmt|;
return|return
operator|(
name|ISC_TRUE
operator|)
return|;
block|}
else|else
block|{
name|INCSTAT
argument_list|(
name|nverifyfailed
argument_list|)
expr_stmt|;
return|return
operator|(
name|ISC_FALSE
operator|)
return|;
block|}
block|}
end_function

begin_comment
comment|/*%  * Signs a set.  Goes through contortions to decide if each RRSIG should  * be dropped or retained, and then determines if any new SIGs need to  * be generated.  */
end_comment

begin_function
specifier|static
name|void
name|signset
parameter_list|(
name|dns_diff_t
modifier|*
name|del
parameter_list|,
name|dns_diff_t
modifier|*
name|add
parameter_list|,
name|dns_dbnode_t
modifier|*
name|node
parameter_list|,
name|dns_name_t
modifier|*
name|name
parameter_list|,
name|dns_rdataset_t
modifier|*
name|set
parameter_list|)
block|{
name|dns_rdataset_t
name|sigset
decl_stmt|;
name|dns_rdata_t
name|sigrdata
init|=
name|DNS_RDATA_INIT
decl_stmt|;
name|dns_rdata_rrsig_t
name|rrsig
decl_stmt|;
name|dns_dnsseckey_t
modifier|*
name|key
decl_stmt|;
name|isc_result_t
name|result
decl_stmt|;
name|isc_boolean_t
name|nosigs
init|=
name|ISC_FALSE
decl_stmt|;
name|isc_boolean_t
modifier|*
name|wassignedby
decl_stmt|,
modifier|*
name|nowsignedby
decl_stmt|;
name|int
name|arraysize
decl_stmt|;
name|dns_difftuple_t
modifier|*
name|tuple
decl_stmt|;
name|dns_ttl_t
name|ttl
decl_stmt|;
name|int
name|i
decl_stmt|;
name|char
name|namestr
index|[
name|DNS_NAME_FORMATSIZE
index|]
decl_stmt|;
name|char
name|typestr
index|[
name|TYPE_FORMATSIZE
index|]
decl_stmt|;
name|char
name|sigstr
index|[
name|SIG_FORMATSIZE
index|]
decl_stmt|;
name|dns_name_format
argument_list|(
name|name
argument_list|,
name|namestr
argument_list|,
sizeof|sizeof
argument_list|(
name|namestr
argument_list|)
argument_list|)
expr_stmt|;
name|type_format
argument_list|(
name|set
operator|->
name|type
argument_list|,
name|typestr
argument_list|,
sizeof|sizeof
argument_list|(
name|typestr
argument_list|)
argument_list|)
expr_stmt|;
name|ttl
operator|=
name|ISC_MIN
argument_list|(
name|set
operator|->
name|ttl
argument_list|,
name|endtime
operator|-
name|starttime
argument_list|)
expr_stmt|;
name|dns_rdataset_init
argument_list|(
operator|&
name|sigset
argument_list|)
expr_stmt|;
name|result
operator|=
name|dns_db_findrdataset
argument_list|(
name|gdb
argument_list|,
name|node
argument_list|,
name|gversion
argument_list|,
name|dns_rdatatype_rrsig
argument_list|,
name|set
operator|->
name|type
argument_list|,
literal|0
argument_list|,
operator|&
name|sigset
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|==
name|ISC_R_NOTFOUND
condition|)
block|{
name|result
operator|=
name|ISC_R_SUCCESS
expr_stmt|;
name|nosigs
operator|=
name|ISC_TRUE
expr_stmt|;
block|}
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
name|fatal
argument_list|(
literal|"failed while looking for '%s RRSIG %s': %s"
argument_list|,
name|namestr
argument_list|,
name|typestr
argument_list|,
name|isc_result_totext
argument_list|(
name|result
argument_list|)
argument_list|)
expr_stmt|;
name|vbprintf
argument_list|(
literal|1
argument_list|,
literal|"%s/%s:\n"
argument_list|,
name|namestr
argument_list|,
name|typestr
argument_list|)
expr_stmt|;
name|arraysize
operator|=
name|keycount
expr_stmt|;
if|if
condition|(
operator|!
name|nosigs
condition|)
name|arraysize
operator|+=
name|dns_rdataset_count
argument_list|(
operator|&
name|sigset
argument_list|)
expr_stmt|;
name|wassignedby
operator|=
name|isc_mem_get
argument_list|(
name|mctx
argument_list|,
name|arraysize
operator|*
sizeof|sizeof
argument_list|(
name|isc_boolean_t
argument_list|)
argument_list|)
expr_stmt|;
name|nowsignedby
operator|=
name|isc_mem_get
argument_list|(
name|mctx
argument_list|,
name|arraysize
operator|*
sizeof|sizeof
argument_list|(
name|isc_boolean_t
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|wassignedby
operator|==
name|NULL
operator|||
name|nowsignedby
operator|==
name|NULL
condition|)
name|fatal
argument_list|(
literal|"out of memory"
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|arraysize
condition|;
name|i
operator|++
control|)
name|wassignedby
index|[
name|i
index|]
operator|=
name|nowsignedby
index|[
name|i
index|]
operator|=
name|ISC_FALSE
expr_stmt|;
if|if
condition|(
name|nosigs
condition|)
name|result
operator|=
name|ISC_R_NOMORE
expr_stmt|;
else|else
name|result
operator|=
name|dns_rdataset_first
argument_list|(
operator|&
name|sigset
argument_list|)
expr_stmt|;
while|while
condition|(
name|result
operator|==
name|ISC_R_SUCCESS
condition|)
block|{
name|isc_boolean_t
name|expired
decl_stmt|,
name|future
decl_stmt|;
name|isc_boolean_t
name|keep
init|=
name|ISC_FALSE
decl_stmt|,
name|resign
init|=
name|ISC_FALSE
decl_stmt|;
name|dns_rdataset_current
argument_list|(
operator|&
name|sigset
argument_list|,
operator|&
name|sigrdata
argument_list|)
expr_stmt|;
name|result
operator|=
name|dns_rdata_tostruct
argument_list|(
operator|&
name|sigrdata
argument_list|,
operator|&
name|rrsig
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|check_result
argument_list|(
name|result
argument_list|,
literal|"dns_rdata_tostruct"
argument_list|)
expr_stmt|;
name|future
operator|=
name|isc_serial_lt
argument_list|(
name|now
argument_list|,
name|rrsig
operator|.
name|timesigned
argument_list|)
expr_stmt|;
name|key
operator|=
name|keythatsigned
argument_list|(
operator|&
name|rrsig
argument_list|)
expr_stmt|;
name|sig_format
argument_list|(
operator|&
name|rrsig
argument_list|,
name|sigstr
argument_list|,
sizeof|sizeof
argument_list|(
name|sigstr
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|key
operator|!=
name|NULL
operator|&&
name|issigningkey
argument_list|(
name|key
argument_list|)
condition|)
name|expired
operator|=
name|isc_serial_gt
argument_list|(
name|now
operator|+
name|cycle
argument_list|,
name|rrsig
operator|.
name|timeexpire
argument_list|)
expr_stmt|;
else|else
name|expired
operator|=
name|isc_serial_gt
argument_list|(
name|now
argument_list|,
name|rrsig
operator|.
name|timeexpire
argument_list|)
expr_stmt|;
if|if
condition|(
name|isc_serial_gt
argument_list|(
name|rrsig
operator|.
name|timesigned
argument_list|,
name|rrsig
operator|.
name|timeexpire
argument_list|)
condition|)
block|{
comment|/* rrsig is dropped and not replaced */
name|vbprintf
argument_list|(
literal|2
argument_list|,
literal|"\trrsig by %s dropped - "
literal|"invalid validity period\n"
argument_list|,
name|sigstr
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|key
operator|==
name|NULL
operator|&&
operator|!
name|future
operator|&&
name|expecttofindkey
argument_list|(
operator|&
name|rrsig
operator|.
name|signer
argument_list|)
condition|)
block|{
comment|/* rrsig is dropped and not replaced */
name|vbprintf
argument_list|(
literal|2
argument_list|,
literal|"\trrsig by %s dropped - "
literal|"private dnskey not found\n"
argument_list|,
name|sigstr
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|key
operator|==
name|NULL
operator|||
name|future
condition|)
block|{
name|vbprintf
argument_list|(
literal|2
argument_list|,
literal|"\trrsig by %s %s - dnskey not found\n"
argument_list|,
name|expired
condition|?
literal|"retained"
else|:
literal|"dropped"
argument_list|,
name|sigstr
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|expired
condition|)
name|keep
operator|=
name|ISC_TRUE
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|issigningkey
argument_list|(
name|key
argument_list|)
condition|)
block|{
if|if
condition|(
operator|!
name|expired
operator|&&
name|setverifies
argument_list|(
name|name
argument_list|,
name|set
argument_list|,
name|key
operator|->
name|key
argument_list|,
operator|&
name|sigrdata
argument_list|)
condition|)
block|{
name|vbprintf
argument_list|(
literal|2
argument_list|,
literal|"\trrsig by %s retained\n"
argument_list|,
name|sigstr
argument_list|)
expr_stmt|;
name|keep
operator|=
name|ISC_TRUE
expr_stmt|;
name|wassignedby
index|[
name|key
operator|->
name|index
index|]
operator|=
name|ISC_TRUE
expr_stmt|;
name|nowsignedby
index|[
name|key
operator|->
name|index
index|]
operator|=
name|ISC_TRUE
expr_stmt|;
block|}
else|else
block|{
name|vbprintf
argument_list|(
literal|2
argument_list|,
literal|"\trrsig by %s dropped - %s\n"
argument_list|,
name|sigstr
argument_list|,
name|expired
condition|?
literal|"expired"
else|:
literal|"failed to verify"
argument_list|)
expr_stmt|;
name|wassignedby
index|[
name|key
operator|->
name|index
index|]
operator|=
name|ISC_TRUE
expr_stmt|;
name|resign
operator|=
name|ISC_TRUE
expr_stmt|;
block|}
block|}
elseif|else
if|if
condition|(
name|iszonekey
argument_list|(
name|key
argument_list|)
condition|)
block|{
if|if
condition|(
operator|!
name|expired
operator|&&
name|setverifies
argument_list|(
name|name
argument_list|,
name|set
argument_list|,
name|key
operator|->
name|key
argument_list|,
operator|&
name|sigrdata
argument_list|)
condition|)
block|{
name|vbprintf
argument_list|(
literal|2
argument_list|,
literal|"\trrsig by %s retained\n"
argument_list|,
name|sigstr
argument_list|)
expr_stmt|;
name|keep
operator|=
name|ISC_TRUE
expr_stmt|;
name|wassignedby
index|[
name|key
operator|->
name|index
index|]
operator|=
name|ISC_TRUE
expr_stmt|;
name|nowsignedby
index|[
name|key
operator|->
name|index
index|]
operator|=
name|ISC_TRUE
expr_stmt|;
block|}
else|else
block|{
name|vbprintf
argument_list|(
literal|2
argument_list|,
literal|"\trrsig by %s dropped - %s\n"
argument_list|,
name|sigstr
argument_list|,
name|expired
condition|?
literal|"expired"
else|:
literal|"failed to verify"
argument_list|)
expr_stmt|;
name|wassignedby
index|[
name|key
operator|->
name|index
index|]
operator|=
name|ISC_TRUE
expr_stmt|;
block|}
block|}
elseif|else
if|if
condition|(
operator|!
name|expired
condition|)
block|{
name|vbprintf
argument_list|(
literal|2
argument_list|,
literal|"\trrsig by %s retained\n"
argument_list|,
name|sigstr
argument_list|)
expr_stmt|;
name|keep
operator|=
name|ISC_TRUE
expr_stmt|;
block|}
else|else
block|{
name|vbprintf
argument_list|(
literal|2
argument_list|,
literal|"\trrsig by %s expired\n"
argument_list|,
name|sigstr
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|keep
condition|)
block|{
name|nowsignedby
index|[
name|key
operator|->
name|index
index|]
operator|=
name|ISC_TRUE
expr_stmt|;
name|INCSTAT
argument_list|(
name|nretained
argument_list|)
expr_stmt|;
if|if
condition|(
name|sigset
operator|.
name|ttl
operator|!=
name|ttl
condition|)
block|{
name|vbprintf
argument_list|(
literal|2
argument_list|,
literal|"\tfixing ttl %s\n"
argument_list|,
name|sigstr
argument_list|)
expr_stmt|;
name|tuple
operator|=
name|NULL
expr_stmt|;
name|result
operator|=
name|dns_difftuple_create
argument_list|(
name|mctx
argument_list|,
name|DNS_DIFFOP_DEL
argument_list|,
name|name
argument_list|,
name|sigset
operator|.
name|ttl
argument_list|,
operator|&
name|sigrdata
argument_list|,
operator|&
name|tuple
argument_list|)
expr_stmt|;
name|check_result
argument_list|(
name|result
argument_list|,
literal|"dns_difftuple_create"
argument_list|)
expr_stmt|;
name|dns_diff_append
argument_list|(
name|del
argument_list|,
operator|&
name|tuple
argument_list|)
expr_stmt|;
name|result
operator|=
name|dns_difftuple_create
argument_list|(
name|mctx
argument_list|,
name|DNS_DIFFOP_ADD
argument_list|,
name|name
argument_list|,
name|ttl
argument_list|,
operator|&
name|sigrdata
argument_list|,
operator|&
name|tuple
argument_list|)
expr_stmt|;
name|check_result
argument_list|(
name|result
argument_list|,
literal|"dns_difftuple_create"
argument_list|)
expr_stmt|;
name|dns_diff_append
argument_list|(
name|add
argument_list|,
operator|&
name|tuple
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
name|tuple
operator|=
name|NULL
expr_stmt|;
name|result
operator|=
name|dns_difftuple_create
argument_list|(
name|mctx
argument_list|,
name|DNS_DIFFOP_DEL
argument_list|,
name|name
argument_list|,
name|sigset
operator|.
name|ttl
argument_list|,
operator|&
name|sigrdata
argument_list|,
operator|&
name|tuple
argument_list|)
expr_stmt|;
name|check_result
argument_list|(
name|result
argument_list|,
literal|"dns_difftuple_create"
argument_list|)
expr_stmt|;
name|dns_diff_append
argument_list|(
name|del
argument_list|,
operator|&
name|tuple
argument_list|)
expr_stmt|;
name|INCSTAT
argument_list|(
name|ndropped
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|resign
condition|)
block|{
name|INSIST
argument_list|(
operator|!
name|keep
argument_list|)
expr_stmt|;
name|signwithkey
argument_list|(
name|name
argument_list|,
name|set
argument_list|,
name|key
operator|->
name|key
argument_list|,
name|ttl
argument_list|,
name|add
argument_list|,
literal|"resigning with dnskey"
argument_list|)
expr_stmt|;
name|nowsignedby
index|[
name|key
operator|->
name|index
index|]
operator|=
name|ISC_TRUE
expr_stmt|;
block|}
name|dns_rdata_reset
argument_list|(
operator|&
name|sigrdata
argument_list|)
expr_stmt|;
name|dns_rdata_freestruct
argument_list|(
operator|&
name|rrsig
argument_list|)
expr_stmt|;
name|result
operator|=
name|dns_rdataset_next
argument_list|(
operator|&
name|sigset
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|result
operator|==
name|ISC_R_NOMORE
condition|)
name|result
operator|=
name|ISC_R_SUCCESS
expr_stmt|;
name|check_result
argument_list|(
name|result
argument_list|,
literal|"dns_rdataset_first/next"
argument_list|)
expr_stmt|;
if|if
condition|(
name|dns_rdataset_isassociated
argument_list|(
operator|&
name|sigset
argument_list|)
condition|)
name|dns_rdataset_disassociate
argument_list|(
operator|&
name|sigset
argument_list|)
expr_stmt|;
for|for
control|(
name|key
operator|=
name|ISC_LIST_HEAD
argument_list|(
name|keylist
argument_list|)
init|;
name|key
operator|!=
name|NULL
condition|;
name|key
operator|=
name|ISC_LIST_NEXT
argument_list|(
name|key
argument_list|,
name|link
argument_list|)
control|)
block|{
if|if
condition|(
name|nowsignedby
index|[
name|key
operator|->
name|index
index|]
condition|)
continue|continue;
if|if
condition|(
operator|!
name|issigningkey
argument_list|(
name|key
argument_list|)
condition|)
continue|continue;
if|if
condition|(
name|set
operator|->
name|type
operator|==
name|dns_rdatatype_dnskey
operator|&&
name|dns_name_equal
argument_list|(
name|name
argument_list|,
name|gorigin
argument_list|)
condition|)
block|{
name|isc_boolean_t
name|have_ksk
decl_stmt|;
name|dns_dnsseckey_t
modifier|*
name|tmpkey
decl_stmt|;
name|have_ksk
operator|=
name|isksk
argument_list|(
name|key
argument_list|)
expr_stmt|;
for|for
control|(
name|tmpkey
operator|=
name|ISC_LIST_HEAD
argument_list|(
name|keylist
argument_list|)
init|;
name|tmpkey
operator|!=
name|NULL
condition|;
name|tmpkey
operator|=
name|ISC_LIST_NEXT
argument_list|(
name|tmpkey
argument_list|,
name|link
argument_list|)
control|)
block|{
if|if
condition|(
name|dst_key_alg
argument_list|(
name|key
operator|->
name|key
argument_list|)
operator|!=
name|dst_key_alg
argument_list|(
name|tmpkey
operator|->
name|key
argument_list|)
condition|)
continue|continue;
if|if
condition|(
name|REVOKE
argument_list|(
name|tmpkey
operator|->
name|key
argument_list|)
condition|)
continue|continue;
if|if
condition|(
name|isksk
argument_list|(
name|tmpkey
argument_list|)
condition|)
name|have_ksk
operator|=
name|ISC_TRUE
expr_stmt|;
block|}
if|if
condition|(
name|isksk
argument_list|(
name|key
argument_list|)
operator|||
operator|!
name|have_ksk
operator|||
operator|(
name|iszsk
argument_list|(
name|key
argument_list|)
operator|&&
operator|!
name|keyset_kskonly
operator|)
condition|)
name|signwithkey
argument_list|(
name|name
argument_list|,
name|set
argument_list|,
name|key
operator|->
name|key
argument_list|,
name|ttl
argument_list|,
name|add
argument_list|,
literal|"signing with dnskey"
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|iszsk
argument_list|(
name|key
argument_list|)
condition|)
block|{
name|signwithkey
argument_list|(
name|name
argument_list|,
name|set
argument_list|,
name|key
operator|->
name|key
argument_list|,
name|ttl
argument_list|,
name|add
argument_list|,
literal|"signing with dnskey"
argument_list|)
expr_stmt|;
block|}
block|}
name|isc_mem_put
argument_list|(
name|mctx
argument_list|,
name|wassignedby
argument_list|,
name|arraysize
operator|*
sizeof|sizeof
argument_list|(
name|isc_boolean_t
argument_list|)
argument_list|)
expr_stmt|;
name|isc_mem_put
argument_list|(
name|mctx
argument_list|,
name|nowsignedby
argument_list|,
name|arraysize
operator|*
sizeof|sizeof
argument_list|(
name|isc_boolean_t
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_struct
struct|struct
name|hashlist
block|{
name|unsigned
name|char
modifier|*
name|hashbuf
decl_stmt|;
name|size_t
name|entries
decl_stmt|;
name|size_t
name|size
decl_stmt|;
name|size_t
name|length
decl_stmt|;
block|}
struct|;
end_struct

begin_function
specifier|static
name|void
name|hashlist_init
parameter_list|(
name|hashlist_t
modifier|*
name|l
parameter_list|,
name|unsigned
name|int
name|nodes
parameter_list|,
name|unsigned
name|int
name|length
parameter_list|)
block|{
name|l
operator|->
name|entries
operator|=
literal|0
expr_stmt|;
name|l
operator|->
name|length
operator|=
name|length
operator|+
literal|1
expr_stmt|;
if|if
condition|(
name|nodes
operator|!=
literal|0
condition|)
block|{
name|l
operator|->
name|size
operator|=
name|nodes
expr_stmt|;
name|l
operator|->
name|hashbuf
operator|=
name|malloc
argument_list|(
name|l
operator|->
name|size
operator|*
name|l
operator|->
name|length
argument_list|)
expr_stmt|;
if|if
condition|(
name|l
operator|->
name|hashbuf
operator|==
name|NULL
condition|)
name|l
operator|->
name|size
operator|=
literal|0
expr_stmt|;
block|}
else|else
block|{
name|l
operator|->
name|size
operator|=
literal|0
expr_stmt|;
name|l
operator|->
name|hashbuf
operator|=
name|NULL
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|hashlist_add
parameter_list|(
name|hashlist_t
modifier|*
name|l
parameter_list|,
specifier|const
name|unsigned
name|char
modifier|*
name|hash
parameter_list|,
name|size_t
name|len
parameter_list|)
block|{
name|REQUIRE
argument_list|(
name|len
operator|<=
name|l
operator|->
name|length
argument_list|)
expr_stmt|;
if|if
condition|(
name|l
operator|->
name|entries
operator|==
name|l
operator|->
name|size
condition|)
block|{
name|l
operator|->
name|size
operator|=
name|l
operator|->
name|size
operator|*
literal|2
operator|+
literal|100
expr_stmt|;
name|l
operator|->
name|hashbuf
operator|=
name|realloc
argument_list|(
name|l
operator|->
name|hashbuf
argument_list|,
name|l
operator|->
name|size
operator|*
name|l
operator|->
name|length
argument_list|)
expr_stmt|;
block|}
name|memset
argument_list|(
name|l
operator|->
name|hashbuf
operator|+
name|l
operator|->
name|entries
operator|*
name|l
operator|->
name|length
argument_list|,
literal|0
argument_list|,
name|l
operator|->
name|length
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
name|l
operator|->
name|hashbuf
operator|+
name|l
operator|->
name|entries
operator|*
name|l
operator|->
name|length
argument_list|,
name|hash
argument_list|,
name|len
argument_list|)
expr_stmt|;
name|l
operator|->
name|entries
operator|++
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|hashlist_add_dns_name
parameter_list|(
name|hashlist_t
modifier|*
name|l
parameter_list|,
comment|/*const*/
name|dns_name_t
modifier|*
name|name
parameter_list|,
name|unsigned
name|int
name|hashalg
parameter_list|,
name|unsigned
name|int
name|iterations
parameter_list|,
specifier|const
name|unsigned
name|char
modifier|*
name|salt
parameter_list|,
name|size_t
name|salt_length
parameter_list|,
name|isc_boolean_t
name|speculative
parameter_list|)
block|{
name|char
name|nametext
index|[
name|DNS_NAME_FORMATSIZE
index|]
decl_stmt|;
name|unsigned
name|char
name|hash
index|[
name|NSEC3_MAX_HASH_LENGTH
operator|+
literal|1
index|]
decl_stmt|;
name|unsigned
name|int
name|len
decl_stmt|;
name|size_t
name|i
decl_stmt|;
name|len
operator|=
name|isc_iterated_hash
argument_list|(
name|hash
argument_list|,
name|hashalg
argument_list|,
name|iterations
argument_list|,
name|salt
argument_list|,
name|salt_length
argument_list|,
name|name
operator|->
name|ndata
argument_list|,
name|name
operator|->
name|length
argument_list|)
expr_stmt|;
if|if
condition|(
name|verbose
condition|)
block|{
name|dns_name_format
argument_list|(
name|name
argument_list|,
name|nametext
argument_list|,
sizeof|sizeof
name|nametext
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|len
condition|;
name|i
operator|++
control|)
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"%02x"
argument_list|,
name|hash
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|" %s\n"
argument_list|,
name|nametext
argument_list|)
expr_stmt|;
block|}
name|hash
index|[
name|len
operator|++
index|]
operator|=
name|speculative
condition|?
literal|1
else|:
literal|0
expr_stmt|;
name|hashlist_add
argument_list|(
name|l
argument_list|,
name|hash
argument_list|,
name|len
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|hashlist_comp
parameter_list|(
specifier|const
name|void
modifier|*
name|a
parameter_list|,
specifier|const
name|void
modifier|*
name|b
parameter_list|)
block|{
return|return
operator|(
name|memcmp
argument_list|(
name|a
argument_list|,
name|b
argument_list|,
name|hash_length
operator|+
literal|1
argument_list|)
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|hashlist_sort
parameter_list|(
name|hashlist_t
modifier|*
name|l
parameter_list|)
block|{
name|qsort
argument_list|(
name|l
operator|->
name|hashbuf
argument_list|,
name|l
operator|->
name|entries
argument_list|,
name|l
operator|->
name|length
argument_list|,
name|hashlist_comp
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|isc_boolean_t
name|hashlist_hasdup
parameter_list|(
name|hashlist_t
modifier|*
name|l
parameter_list|)
block|{
name|unsigned
name|char
modifier|*
name|current
decl_stmt|;
name|unsigned
name|char
modifier|*
name|next
init|=
name|l
operator|->
name|hashbuf
decl_stmt|;
name|size_t
name|entries
init|=
name|l
operator|->
name|entries
decl_stmt|;
comment|/* 	 * Skip initial speculative wild card hashs. 	 */
while|while
condition|(
name|entries
operator|>
literal|0U
operator|&&
name|next
index|[
name|l
operator|->
name|length
operator|-
literal|1
index|]
operator|!=
literal|0U
condition|)
block|{
name|next
operator|+=
name|l
operator|->
name|length
expr_stmt|;
name|entries
operator|--
expr_stmt|;
block|}
name|current
operator|=
name|next
expr_stmt|;
while|while
condition|(
name|entries
operator|--
operator|>
literal|1U
condition|)
block|{
name|next
operator|+=
name|l
operator|->
name|length
expr_stmt|;
if|if
condition|(
name|next
index|[
name|l
operator|->
name|length
operator|-
literal|1
index|]
operator|!=
literal|0
condition|)
continue|continue;
if|if
condition|(
name|memcmp
argument_list|(
name|current
argument_list|,
name|next
argument_list|,
name|l
operator|->
name|length
operator|-
literal|1
argument_list|)
operator|==
literal|0
condition|)
return|return
operator|(
name|ISC_TRUE
operator|)
return|;
name|current
operator|=
name|next
expr_stmt|;
block|}
return|return
operator|(
name|ISC_FALSE
operator|)
return|;
block|}
end_function

begin_function
specifier|static
specifier|const
name|unsigned
name|char
modifier|*
name|hashlist_findnext
parameter_list|(
specifier|const
name|hashlist_t
modifier|*
name|l
parameter_list|,
specifier|const
name|unsigned
name|char
name|hash
index|[
name|NSEC3_MAX_HASH_LENGTH
index|]
parameter_list|)
block|{
name|unsigned
name|int
name|entries
init|=
name|l
operator|->
name|entries
decl_stmt|;
specifier|const
name|unsigned
name|char
modifier|*
name|next
init|=
name|bsearch
argument_list|(
name|hash
argument_list|,
name|l
operator|->
name|hashbuf
argument_list|,
name|l
operator|->
name|entries
argument_list|,
name|l
operator|->
name|length
argument_list|,
name|hashlist_comp
argument_list|)
decl_stmt|;
name|INSIST
argument_list|(
name|next
operator|!=
name|NULL
argument_list|)
expr_stmt|;
do|do
block|{
if|if
condition|(
name|next
operator|<
name|l
operator|->
name|hashbuf
operator|+
operator|(
name|l
operator|->
name|entries
operator|-
literal|1
operator|)
operator|*
name|l
operator|->
name|length
condition|)
name|next
operator|+=
name|l
operator|->
name|length
expr_stmt|;
else|else
name|next
operator|=
name|l
operator|->
name|hashbuf
expr_stmt|;
if|if
condition|(
name|next
index|[
name|l
operator|->
name|length
operator|-
literal|1
index|]
operator|==
literal|0
condition|)
break|break;
block|}
do|while
condition|(
name|entries
operator|--
operator|>
literal|1
condition|)
do|;
name|INSIST
argument_list|(
name|entries
operator|!=
literal|0
argument_list|)
expr_stmt|;
return|return
operator|(
name|next
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|isc_boolean_t
name|hashlist_exists
parameter_list|(
specifier|const
name|hashlist_t
modifier|*
name|l
parameter_list|,
specifier|const
name|unsigned
name|char
name|hash
index|[
name|NSEC3_MAX_HASH_LENGTH
index|]
parameter_list|)
block|{
if|if
condition|(
name|bsearch
argument_list|(
name|hash
argument_list|,
name|l
operator|->
name|hashbuf
argument_list|,
name|l
operator|->
name|entries
argument_list|,
name|l
operator|->
name|length
argument_list|,
name|hashlist_comp
argument_list|)
condition|)
return|return
operator|(
name|ISC_TRUE
operator|)
return|;
else|else
return|return
operator|(
name|ISC_FALSE
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|addnowildcardhash
parameter_list|(
name|hashlist_t
modifier|*
name|l
parameter_list|,
comment|/*const*/
name|dns_name_t
modifier|*
name|name
parameter_list|,
name|unsigned
name|int
name|hashalg
parameter_list|,
name|unsigned
name|int
name|iterations
parameter_list|,
specifier|const
name|unsigned
name|char
modifier|*
name|salt
parameter_list|,
name|size_t
name|salt_length
parameter_list|)
block|{
name|dns_fixedname_t
name|fixed
decl_stmt|;
name|dns_name_t
modifier|*
name|wild
decl_stmt|;
name|dns_dbnode_t
modifier|*
name|node
init|=
name|NULL
decl_stmt|;
name|isc_result_t
name|result
decl_stmt|;
name|char
name|namestr
index|[
name|DNS_NAME_FORMATSIZE
index|]
decl_stmt|;
name|dns_fixedname_init
argument_list|(
operator|&
name|fixed
argument_list|)
expr_stmt|;
name|wild
operator|=
name|dns_fixedname_name
argument_list|(
operator|&
name|fixed
argument_list|)
expr_stmt|;
name|result
operator|=
name|dns_name_concatenate
argument_list|(
name|dns_wildcardname
argument_list|,
name|name
argument_list|,
name|wild
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|==
name|ISC_R_NOSPACE
condition|)
return|return;
name|check_result
argument_list|(
name|result
argument_list|,
literal|"addnowildcardhash: dns_name_concatenate()"
argument_list|)
expr_stmt|;
name|result
operator|=
name|dns_db_findnode
argument_list|(
name|gdb
argument_list|,
name|wild
argument_list|,
name|ISC_FALSE
argument_list|,
operator|&
name|node
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|==
name|ISC_R_SUCCESS
condition|)
block|{
name|dns_db_detachnode
argument_list|(
name|gdb
argument_list|,
operator|&
name|node
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|verbose
condition|)
block|{
name|dns_name_format
argument_list|(
name|wild
argument_list|,
name|namestr
argument_list|,
sizeof|sizeof
argument_list|(
name|namestr
argument_list|)
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"adding no-wildcardhash for %s\n"
argument_list|,
name|namestr
argument_list|)
expr_stmt|;
block|}
name|hashlist_add_dns_name
argument_list|(
name|l
argument_list|,
name|wild
argument_list|,
name|hashalg
argument_list|,
name|iterations
argument_list|,
name|salt
argument_list|,
name|salt_length
argument_list|,
name|ISC_TRUE
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|opendb
parameter_list|(
specifier|const
name|char
modifier|*
name|prefix
parameter_list|,
name|dns_name_t
modifier|*
name|name
parameter_list|,
name|dns_rdataclass_t
name|rdclass
parameter_list|,
name|dns_db_t
modifier|*
modifier|*
name|dbp
parameter_list|)
block|{
name|char
name|filename
index|[
name|PATH_MAX
index|]
decl_stmt|;
name|isc_buffer_t
name|b
decl_stmt|;
name|isc_result_t
name|result
decl_stmt|;
name|isc_buffer_init
argument_list|(
operator|&
name|b
argument_list|,
name|filename
argument_list|,
sizeof|sizeof
argument_list|(
name|filename
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|dsdir
operator|!=
name|NULL
condition|)
block|{
comment|/* allow room for a trailing slash */
if|if
condition|(
name|strlen
argument_list|(
name|dsdir
argument_list|)
operator|>=
name|isc_buffer_availablelength
argument_list|(
operator|&
name|b
argument_list|)
condition|)
name|fatal
argument_list|(
literal|"path '%s' is too long"
argument_list|,
name|dsdir
argument_list|)
expr_stmt|;
name|isc_buffer_putstr
argument_list|(
operator|&
name|b
argument_list|,
name|dsdir
argument_list|)
expr_stmt|;
if|if
condition|(
name|dsdir
index|[
name|strlen
argument_list|(
name|dsdir
argument_list|)
operator|-
literal|1
index|]
operator|!=
literal|'/'
condition|)
name|isc_buffer_putstr
argument_list|(
operator|&
name|b
argument_list|,
literal|"/"
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|strlen
argument_list|(
name|prefix
argument_list|)
operator|>
name|isc_buffer_availablelength
argument_list|(
operator|&
name|b
argument_list|)
condition|)
name|fatal
argument_list|(
literal|"path '%s' is too long"
argument_list|,
name|dsdir
argument_list|)
expr_stmt|;
name|isc_buffer_putstr
argument_list|(
operator|&
name|b
argument_list|,
name|prefix
argument_list|)
expr_stmt|;
name|result
operator|=
name|dns_name_tofilenametext
argument_list|(
name|name
argument_list|,
name|ISC_FALSE
argument_list|,
operator|&
name|b
argument_list|)
expr_stmt|;
name|check_result
argument_list|(
name|result
argument_list|,
literal|"dns_name_tofilenametext()"
argument_list|)
expr_stmt|;
if|if
condition|(
name|isc_buffer_availablelength
argument_list|(
operator|&
name|b
argument_list|)
operator|==
literal|0
condition|)
block|{
name|char
name|namestr
index|[
name|DNS_NAME_FORMATSIZE
index|]
decl_stmt|;
name|dns_name_format
argument_list|(
name|name
argument_list|,
name|namestr
argument_list|,
sizeof|sizeof
argument_list|(
name|namestr
argument_list|)
argument_list|)
expr_stmt|;
name|fatal
argument_list|(
literal|"name '%s' is too long"
argument_list|,
name|namestr
argument_list|)
expr_stmt|;
block|}
name|isc_buffer_putuint8
argument_list|(
operator|&
name|b
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|result
operator|=
name|dns_db_create
argument_list|(
name|mctx
argument_list|,
literal|"rbt"
argument_list|,
name|dns_rootname
argument_list|,
name|dns_dbtype_zone
argument_list|,
name|rdclass
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|,
name|dbp
argument_list|)
expr_stmt|;
name|check_result
argument_list|(
name|result
argument_list|,
literal|"dns_db_create()"
argument_list|)
expr_stmt|;
name|result
operator|=
name|dns_db_load3
argument_list|(
operator|*
name|dbp
argument_list|,
name|filename
argument_list|,
name|inputformat
argument_list|,
name|DNS_MASTER_HINT
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
operator|&&
name|result
operator|!=
name|DNS_R_SEENINCLUDE
condition|)
name|dns_db_detach
argument_list|(
name|dbp
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*%  * Load the DS set for a child zone, if a dsset-* file can be found.  * If not, try to find a keyset-* file from an earlier version of  * dnssec-signzone, and build DS records from that.  */
end_comment

begin_function
specifier|static
name|isc_result_t
name|loadds
parameter_list|(
name|dns_name_t
modifier|*
name|name
parameter_list|,
name|isc_uint32_t
name|ttl
parameter_list|,
name|dns_rdataset_t
modifier|*
name|dsset
parameter_list|)
block|{
name|dns_db_t
modifier|*
name|db
init|=
name|NULL
decl_stmt|;
name|dns_dbversion_t
modifier|*
name|ver
init|=
name|NULL
decl_stmt|;
name|dns_dbnode_t
modifier|*
name|node
init|=
name|NULL
decl_stmt|;
name|isc_result_t
name|result
decl_stmt|;
name|dns_rdataset_t
name|keyset
decl_stmt|;
name|dns_rdata_t
name|key
decl_stmt|,
name|ds
decl_stmt|;
name|unsigned
name|char
name|dsbuf
index|[
name|DNS_DS_BUFFERSIZE
index|]
decl_stmt|;
name|dns_diff_t
name|diff
decl_stmt|;
name|dns_difftuple_t
modifier|*
name|tuple
init|=
name|NULL
decl_stmt|;
name|opendb
argument_list|(
literal|"dsset-"
argument_list|,
name|name
argument_list|,
name|gclass
argument_list|,
operator|&
name|db
argument_list|)
expr_stmt|;
if|if
condition|(
name|db
operator|!=
name|NULL
condition|)
block|{
name|result
operator|=
name|dns_db_findnode
argument_list|(
name|db
argument_list|,
name|name
argument_list|,
name|ISC_FALSE
argument_list|,
operator|&
name|node
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|==
name|ISC_R_SUCCESS
condition|)
block|{
name|dns_rdataset_init
argument_list|(
name|dsset
argument_list|)
expr_stmt|;
name|result
operator|=
name|dns_db_findrdataset
argument_list|(
name|db
argument_list|,
name|node
argument_list|,
name|NULL
argument_list|,
name|dns_rdatatype_ds
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
name|dsset
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|dns_db_detachnode
argument_list|(
name|db
argument_list|,
operator|&
name|node
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|==
name|ISC_R_SUCCESS
condition|)
block|{
name|vbprintf
argument_list|(
literal|2
argument_list|,
literal|"found DS records\n"
argument_list|)
expr_stmt|;
name|dsset
operator|->
name|ttl
operator|=
name|ttl
expr_stmt|;
name|dns_db_detach
argument_list|(
operator|&
name|db
argument_list|)
expr_stmt|;
return|return
operator|(
name|result
operator|)
return|;
block|}
block|}
name|dns_db_detach
argument_list|(
operator|&
name|db
argument_list|)
expr_stmt|;
block|}
comment|/* No DS records found; try again, looking for DNSKEY records */
name|opendb
argument_list|(
literal|"keyset-"
argument_list|,
name|name
argument_list|,
name|gclass
argument_list|,
operator|&
name|db
argument_list|)
expr_stmt|;
if|if
condition|(
name|db
operator|==
name|NULL
condition|)
block|{
return|return
operator|(
name|ISC_R_NOTFOUND
operator|)
return|;
block|}
name|result
operator|=
name|dns_db_findnode
argument_list|(
name|db
argument_list|,
name|name
argument_list|,
name|ISC_FALSE
argument_list|,
operator|&
name|node
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
block|{
name|dns_db_detach
argument_list|(
operator|&
name|db
argument_list|)
expr_stmt|;
return|return
operator|(
name|result
operator|)
return|;
block|}
name|dns_rdataset_init
argument_list|(
operator|&
name|keyset
argument_list|)
expr_stmt|;
name|result
operator|=
name|dns_db_findrdataset
argument_list|(
name|db
argument_list|,
name|node
argument_list|,
name|NULL
argument_list|,
name|dns_rdatatype_dnskey
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
operator|&
name|keyset
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
block|{
name|dns_db_detachnode
argument_list|(
name|db
argument_list|,
operator|&
name|node
argument_list|)
expr_stmt|;
name|dns_db_detach
argument_list|(
operator|&
name|db
argument_list|)
expr_stmt|;
return|return
operator|(
name|result
operator|)
return|;
block|}
name|vbprintf
argument_list|(
literal|2
argument_list|,
literal|"found DNSKEY records\n"
argument_list|)
expr_stmt|;
name|result
operator|=
name|dns_db_newversion
argument_list|(
name|db
argument_list|,
operator|&
name|ver
argument_list|)
expr_stmt|;
name|check_result
argument_list|(
name|result
argument_list|,
literal|"dns_db_newversion"
argument_list|)
expr_stmt|;
name|dns_diff_init
argument_list|(
name|mctx
argument_list|,
operator|&
name|diff
argument_list|)
expr_stmt|;
for|for
control|(
name|result
operator|=
name|dns_rdataset_first
argument_list|(
operator|&
name|keyset
argument_list|)
init|;
name|result
operator|==
name|ISC_R_SUCCESS
condition|;
name|result
operator|=
name|dns_rdataset_next
argument_list|(
operator|&
name|keyset
argument_list|)
control|)
block|{
name|dns_rdata_init
argument_list|(
operator|&
name|key
argument_list|)
expr_stmt|;
name|dns_rdata_init
argument_list|(
operator|&
name|ds
argument_list|)
expr_stmt|;
name|dns_rdataset_current
argument_list|(
operator|&
name|keyset
argument_list|,
operator|&
name|key
argument_list|)
expr_stmt|;
name|result
operator|=
name|dns_ds_buildrdata
argument_list|(
name|name
argument_list|,
operator|&
name|key
argument_list|,
name|DNS_DSDIGEST_SHA1
argument_list|,
name|dsbuf
argument_list|,
operator|&
name|ds
argument_list|)
expr_stmt|;
name|check_result
argument_list|(
name|result
argument_list|,
literal|"dns_ds_buildrdata"
argument_list|)
expr_stmt|;
name|result
operator|=
name|dns_difftuple_create
argument_list|(
name|mctx
argument_list|,
name|DNS_DIFFOP_ADD
argument_list|,
name|name
argument_list|,
name|ttl
argument_list|,
operator|&
name|ds
argument_list|,
operator|&
name|tuple
argument_list|)
expr_stmt|;
name|check_result
argument_list|(
name|result
argument_list|,
literal|"dns_difftuple_create"
argument_list|)
expr_stmt|;
name|dns_diff_append
argument_list|(
operator|&
name|diff
argument_list|,
operator|&
name|tuple
argument_list|)
expr_stmt|;
name|dns_rdata_reset
argument_list|(
operator|&
name|ds
argument_list|)
expr_stmt|;
name|result
operator|=
name|dns_ds_buildrdata
argument_list|(
name|name
argument_list|,
operator|&
name|key
argument_list|,
name|DNS_DSDIGEST_SHA256
argument_list|,
name|dsbuf
argument_list|,
operator|&
name|ds
argument_list|)
expr_stmt|;
name|check_result
argument_list|(
name|result
argument_list|,
literal|"dns_ds_buildrdata"
argument_list|)
expr_stmt|;
name|result
operator|=
name|dns_difftuple_create
argument_list|(
name|mctx
argument_list|,
name|DNS_DIFFOP_ADD
argument_list|,
name|name
argument_list|,
name|ttl
argument_list|,
operator|&
name|ds
argument_list|,
operator|&
name|tuple
argument_list|)
expr_stmt|;
name|check_result
argument_list|(
name|result
argument_list|,
literal|"dns_difftuple_create"
argument_list|)
expr_stmt|;
name|dns_diff_append
argument_list|(
operator|&
name|diff
argument_list|,
operator|&
name|tuple
argument_list|)
expr_stmt|;
block|}
name|result
operator|=
name|dns_diff_apply
argument_list|(
operator|&
name|diff
argument_list|,
name|db
argument_list|,
name|ver
argument_list|)
expr_stmt|;
name|check_result
argument_list|(
name|result
argument_list|,
literal|"dns_diff_apply"
argument_list|)
expr_stmt|;
name|dns_diff_clear
argument_list|(
operator|&
name|diff
argument_list|)
expr_stmt|;
name|dns_db_closeversion
argument_list|(
name|db
argument_list|,
operator|&
name|ver
argument_list|,
name|ISC_TRUE
argument_list|)
expr_stmt|;
name|result
operator|=
name|dns_db_findrdataset
argument_list|(
name|db
argument_list|,
name|node
argument_list|,
name|NULL
argument_list|,
name|dns_rdatatype_ds
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
name|dsset
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|check_result
argument_list|(
name|result
argument_list|,
literal|"dns_db_findrdataset"
argument_list|)
expr_stmt|;
name|dns_rdataset_disassociate
argument_list|(
operator|&
name|keyset
argument_list|)
expr_stmt|;
name|dns_db_detachnode
argument_list|(
name|db
argument_list|,
operator|&
name|node
argument_list|)
expr_stmt|;
name|dns_db_detach
argument_list|(
operator|&
name|db
argument_list|)
expr_stmt|;
return|return
operator|(
name|result
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|isc_boolean_t
name|delegation
parameter_list|(
name|dns_name_t
modifier|*
name|name
parameter_list|,
name|dns_dbnode_t
modifier|*
name|node
parameter_list|,
name|isc_uint32_t
modifier|*
name|ttlp
parameter_list|)
block|{
name|dns_rdataset_t
name|nsset
decl_stmt|;
name|isc_result_t
name|result
decl_stmt|;
if|if
condition|(
name|dns_name_equal
argument_list|(
name|name
argument_list|,
name|gorigin
argument_list|)
condition|)
return|return
operator|(
name|ISC_FALSE
operator|)
return|;
name|dns_rdataset_init
argument_list|(
operator|&
name|nsset
argument_list|)
expr_stmt|;
name|result
operator|=
name|dns_db_findrdataset
argument_list|(
name|gdb
argument_list|,
name|node
argument_list|,
name|gversion
argument_list|,
name|dns_rdatatype_ns
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
operator|&
name|nsset
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|dns_rdataset_isassociated
argument_list|(
operator|&
name|nsset
argument_list|)
condition|)
block|{
if|if
condition|(
name|ttlp
operator|!=
name|NULL
condition|)
operator|*
name|ttlp
operator|=
name|nsset
operator|.
name|ttl
expr_stmt|;
name|dns_rdataset_disassociate
argument_list|(
operator|&
name|nsset
argument_list|)
expr_stmt|;
block|}
return|return
operator|(
name|ISC_TF
argument_list|(
name|result
operator|==
name|ISC_R_SUCCESS
argument_list|)
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|isc_boolean_t
name|secure
parameter_list|(
name|dns_name_t
modifier|*
name|name
parameter_list|,
name|dns_dbnode_t
modifier|*
name|node
parameter_list|)
block|{
name|dns_rdataset_t
name|dsset
decl_stmt|;
name|isc_result_t
name|result
decl_stmt|;
if|if
condition|(
name|dns_name_equal
argument_list|(
name|name
argument_list|,
name|gorigin
argument_list|)
condition|)
return|return
operator|(
name|ISC_FALSE
operator|)
return|;
name|dns_rdataset_init
argument_list|(
operator|&
name|dsset
argument_list|)
expr_stmt|;
name|result
operator|=
name|dns_db_findrdataset
argument_list|(
name|gdb
argument_list|,
name|node
argument_list|,
name|gversion
argument_list|,
name|dns_rdatatype_ds
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
operator|&
name|dsset
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|dns_rdataset_isassociated
argument_list|(
operator|&
name|dsset
argument_list|)
condition|)
name|dns_rdataset_disassociate
argument_list|(
operator|&
name|dsset
argument_list|)
expr_stmt|;
return|return
operator|(
name|ISC_TF
argument_list|(
name|result
operator|==
name|ISC_R_SUCCESS
argument_list|)
operator|)
return|;
block|}
end_function

begin_comment
comment|/*%  * Signs all records at a name.  */
end_comment

begin_function
specifier|static
name|void
name|signname
parameter_list|(
name|dns_dbnode_t
modifier|*
name|node
parameter_list|,
name|dns_name_t
modifier|*
name|name
parameter_list|)
block|{
name|isc_result_t
name|result
decl_stmt|;
name|dns_rdataset_t
name|rdataset
decl_stmt|;
name|dns_rdatasetiter_t
modifier|*
name|rdsiter
decl_stmt|;
name|isc_boolean_t
name|isdelegation
init|=
name|ISC_FALSE
decl_stmt|;
name|dns_diff_t
name|del
decl_stmt|,
name|add
decl_stmt|;
name|char
name|namestr
index|[
name|DNS_NAME_FORMATSIZE
index|]
decl_stmt|;
name|dns_rdataset_init
argument_list|(
operator|&
name|rdataset
argument_list|)
expr_stmt|;
name|dns_name_format
argument_list|(
name|name
argument_list|,
name|namestr
argument_list|,
sizeof|sizeof
argument_list|(
name|namestr
argument_list|)
argument_list|)
expr_stmt|;
comment|/* 	 * Determine if this is a delegation point. 	 */
if|if
condition|(
name|delegation
argument_list|(
name|name
argument_list|,
name|node
argument_list|,
name|NULL
argument_list|)
condition|)
name|isdelegation
operator|=
name|ISC_TRUE
expr_stmt|;
comment|/* 	 * Now iterate through the rdatasets. 	 */
name|dns_diff_init
argument_list|(
name|mctx
argument_list|,
operator|&
name|del
argument_list|)
expr_stmt|;
name|dns_diff_init
argument_list|(
name|mctx
argument_list|,
operator|&
name|add
argument_list|)
expr_stmt|;
name|rdsiter
operator|=
name|NULL
expr_stmt|;
name|result
operator|=
name|dns_db_allrdatasets
argument_list|(
name|gdb
argument_list|,
name|node
argument_list|,
name|gversion
argument_list|,
literal|0
argument_list|,
operator|&
name|rdsiter
argument_list|)
expr_stmt|;
name|check_result
argument_list|(
name|result
argument_list|,
literal|"dns_db_allrdatasets()"
argument_list|)
expr_stmt|;
name|result
operator|=
name|dns_rdatasetiter_first
argument_list|(
name|rdsiter
argument_list|)
expr_stmt|;
while|while
condition|(
name|result
operator|==
name|ISC_R_SUCCESS
condition|)
block|{
name|dns_rdatasetiter_current
argument_list|(
name|rdsiter
argument_list|,
operator|&
name|rdataset
argument_list|)
expr_stmt|;
comment|/* If this is a RRSIG set, skip it. */
if|if
condition|(
name|rdataset
operator|.
name|type
operator|==
name|dns_rdatatype_rrsig
condition|)
goto|goto
name|skip
goto|;
comment|/* 		 * If this name is a delegation point, skip all records 		 * except NSEC and DS sets.  Otherwise check that there 		 * isn't a DS record. 		 */
if|if
condition|(
name|isdelegation
condition|)
block|{
if|if
condition|(
name|rdataset
operator|.
name|type
operator|!=
name|nsec_datatype
operator|&&
name|rdataset
operator|.
name|type
operator|!=
name|dns_rdatatype_ds
condition|)
goto|goto
name|skip
goto|;
block|}
elseif|else
if|if
condition|(
name|rdataset
operator|.
name|type
operator|==
name|dns_rdatatype_ds
condition|)
block|{
name|char
name|namebuf
index|[
name|DNS_NAME_FORMATSIZE
index|]
decl_stmt|;
name|dns_name_format
argument_list|(
name|name
argument_list|,
name|namebuf
argument_list|,
sizeof|sizeof
argument_list|(
name|namebuf
argument_list|)
argument_list|)
expr_stmt|;
name|fatal
argument_list|(
literal|"'%s': found DS RRset without NS RRset\n"
argument_list|,
name|namebuf
argument_list|)
expr_stmt|;
block|}
name|signset
argument_list|(
operator|&
name|del
argument_list|,
operator|&
name|add
argument_list|,
name|node
argument_list|,
name|name
argument_list|,
operator|&
name|rdataset
argument_list|)
expr_stmt|;
name|skip
label|:
name|dns_rdataset_disassociate
argument_list|(
operator|&
name|rdataset
argument_list|)
expr_stmt|;
name|result
operator|=
name|dns_rdatasetiter_next
argument_list|(
name|rdsiter
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|result
operator|!=
name|ISC_R_NOMORE
condition|)
name|fatal
argument_list|(
literal|"rdataset iteration for name '%s' failed: %s"
argument_list|,
name|namestr
argument_list|,
name|isc_result_totext
argument_list|(
name|result
argument_list|)
argument_list|)
expr_stmt|;
name|dns_rdatasetiter_destroy
argument_list|(
operator|&
name|rdsiter
argument_list|)
expr_stmt|;
name|result
operator|=
name|dns_diff_applysilently
argument_list|(
operator|&
name|del
argument_list|,
name|gdb
argument_list|,
name|gversion
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
name|fatal
argument_list|(
literal|"failed to delete SIGs at node '%s': %s"
argument_list|,
name|namestr
argument_list|,
name|isc_result_totext
argument_list|(
name|result
argument_list|)
argument_list|)
expr_stmt|;
name|result
operator|=
name|dns_diff_applysilently
argument_list|(
operator|&
name|add
argument_list|,
name|gdb
argument_list|,
name|gversion
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
name|fatal
argument_list|(
literal|"failed to add SIGs at node '%s': %s"
argument_list|,
name|namestr
argument_list|,
name|isc_result_totext
argument_list|(
name|result
argument_list|)
argument_list|)
expr_stmt|;
name|dns_diff_clear
argument_list|(
operator|&
name|del
argument_list|)
expr_stmt|;
name|dns_diff_clear
argument_list|(
operator|&
name|add
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
specifier|inline
name|isc_boolean_t
name|active_node
parameter_list|(
name|dns_dbnode_t
modifier|*
name|node
parameter_list|)
block|{
name|dns_rdatasetiter_t
modifier|*
name|rdsiter
init|=
name|NULL
decl_stmt|;
name|dns_rdatasetiter_t
modifier|*
name|rdsiter2
init|=
name|NULL
decl_stmt|;
name|isc_boolean_t
name|active
init|=
name|ISC_FALSE
decl_stmt|;
name|isc_result_t
name|result
decl_stmt|;
name|dns_rdataset_t
name|rdataset
decl_stmt|;
name|dns_rdatatype_t
name|type
decl_stmt|;
name|dns_rdatatype_t
name|covers
decl_stmt|;
name|isc_boolean_t
name|found
decl_stmt|;
name|dns_rdataset_init
argument_list|(
operator|&
name|rdataset
argument_list|)
expr_stmt|;
name|result
operator|=
name|dns_db_allrdatasets
argument_list|(
name|gdb
argument_list|,
name|node
argument_list|,
name|gversion
argument_list|,
literal|0
argument_list|,
operator|&
name|rdsiter
argument_list|)
expr_stmt|;
name|check_result
argument_list|(
name|result
argument_list|,
literal|"dns_db_allrdatasets()"
argument_list|)
expr_stmt|;
name|result
operator|=
name|dns_rdatasetiter_first
argument_list|(
name|rdsiter
argument_list|)
expr_stmt|;
while|while
condition|(
name|result
operator|==
name|ISC_R_SUCCESS
condition|)
block|{
name|dns_rdatasetiter_current
argument_list|(
name|rdsiter
argument_list|,
operator|&
name|rdataset
argument_list|)
expr_stmt|;
if|if
condition|(
name|rdataset
operator|.
name|type
operator|!=
name|dns_rdatatype_nsec
operator|&&
name|rdataset
operator|.
name|type
operator|!=
name|dns_rdatatype_nsec3
operator|&&
name|rdataset
operator|.
name|type
operator|!=
name|dns_rdatatype_rrsig
condition|)
name|active
operator|=
name|ISC_TRUE
expr_stmt|;
name|dns_rdataset_disassociate
argument_list|(
operator|&
name|rdataset
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|active
condition|)
name|result
operator|=
name|dns_rdatasetiter_next
argument_list|(
name|rdsiter
argument_list|)
expr_stmt|;
else|else
name|result
operator|=
name|ISC_R_NOMORE
expr_stmt|;
block|}
if|if
condition|(
name|result
operator|!=
name|ISC_R_NOMORE
condition|)
name|fatal
argument_list|(
literal|"rdataset iteration failed: %s"
argument_list|,
name|isc_result_totext
argument_list|(
name|result
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|active
operator|&&
name|nsec_datatype
operator|==
name|dns_rdatatype_nsec
condition|)
block|{
comment|/*% 		 * The node is empty of everything but NSEC / RRSIG records. 		 */
for|for
control|(
name|result
operator|=
name|dns_rdatasetiter_first
argument_list|(
name|rdsiter
argument_list|)
init|;
name|result
operator|==
name|ISC_R_SUCCESS
condition|;
name|result
operator|=
name|dns_rdatasetiter_next
argument_list|(
name|rdsiter
argument_list|)
control|)
block|{
name|dns_rdatasetiter_current
argument_list|(
name|rdsiter
argument_list|,
operator|&
name|rdataset
argument_list|)
expr_stmt|;
name|result
operator|=
name|dns_db_deleterdataset
argument_list|(
name|gdb
argument_list|,
name|node
argument_list|,
name|gversion
argument_list|,
name|rdataset
operator|.
name|type
argument_list|,
name|rdataset
operator|.
name|covers
argument_list|)
expr_stmt|;
name|check_result
argument_list|(
name|result
argument_list|,
literal|"dns_db_deleterdataset()"
argument_list|)
expr_stmt|;
name|dns_rdataset_disassociate
argument_list|(
operator|&
name|rdataset
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|result
operator|!=
name|ISC_R_NOMORE
condition|)
name|fatal
argument_list|(
literal|"rdataset iteration failed: %s"
argument_list|,
name|isc_result_totext
argument_list|(
name|result
argument_list|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|/* 		 * Delete RRSIGs for types that no longer exist. 		 */
name|result
operator|=
name|dns_db_allrdatasets
argument_list|(
name|gdb
argument_list|,
name|node
argument_list|,
name|gversion
argument_list|,
literal|0
argument_list|,
operator|&
name|rdsiter2
argument_list|)
expr_stmt|;
name|check_result
argument_list|(
name|result
argument_list|,
literal|"dns_db_allrdatasets()"
argument_list|)
expr_stmt|;
for|for
control|(
name|result
operator|=
name|dns_rdatasetiter_first
argument_list|(
name|rdsiter
argument_list|)
init|;
name|result
operator|==
name|ISC_R_SUCCESS
condition|;
name|result
operator|=
name|dns_rdatasetiter_next
argument_list|(
name|rdsiter
argument_list|)
control|)
block|{
name|dns_rdatasetiter_current
argument_list|(
name|rdsiter
argument_list|,
operator|&
name|rdataset
argument_list|)
expr_stmt|;
name|type
operator|=
name|rdataset
operator|.
name|type
expr_stmt|;
name|covers
operator|=
name|rdataset
operator|.
name|covers
expr_stmt|;
name|dns_rdataset_disassociate
argument_list|(
operator|&
name|rdataset
argument_list|)
expr_stmt|;
comment|/* 			 * Delete the NSEC chain if we are signing with 			 * NSEC3. 			 */
if|if
condition|(
name|nsec_datatype
operator|==
name|dns_rdatatype_nsec3
operator|&&
operator|(
name|type
operator|==
name|dns_rdatatype_nsec
operator|||
name|covers
operator|==
name|dns_rdatatype_nsec
operator|)
condition|)
block|{
name|result
operator|=
name|dns_db_deleterdataset
argument_list|(
name|gdb
argument_list|,
name|node
argument_list|,
name|gversion
argument_list|,
name|type
argument_list|,
name|covers
argument_list|)
expr_stmt|;
name|check_result
argument_list|(
name|result
argument_list|,
literal|"dns_db_deleterdataset(nsec/rrsig)"
argument_list|)
expr_stmt|;
continue|continue;
block|}
if|if
condition|(
name|type
operator|!=
name|dns_rdatatype_rrsig
condition|)
continue|continue;
name|found
operator|=
name|ISC_FALSE
expr_stmt|;
for|for
control|(
name|result
operator|=
name|dns_rdatasetiter_first
argument_list|(
name|rdsiter2
argument_list|)
init|;
operator|!
name|found
operator|&&
name|result
operator|==
name|ISC_R_SUCCESS
condition|;
name|result
operator|=
name|dns_rdatasetiter_next
argument_list|(
name|rdsiter2
argument_list|)
control|)
block|{
name|dns_rdatasetiter_current
argument_list|(
name|rdsiter2
argument_list|,
operator|&
name|rdataset
argument_list|)
expr_stmt|;
if|if
condition|(
name|rdataset
operator|.
name|type
operator|==
name|covers
condition|)
name|found
operator|=
name|ISC_TRUE
expr_stmt|;
name|dns_rdataset_disassociate
argument_list|(
operator|&
name|rdataset
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|found
condition|)
block|{
if|if
condition|(
name|result
operator|!=
name|ISC_R_NOMORE
condition|)
name|fatal
argument_list|(
literal|"rdataset iteration failed: %s"
argument_list|,
name|isc_result_totext
argument_list|(
name|result
argument_list|)
argument_list|)
expr_stmt|;
name|result
operator|=
name|dns_db_deleterdataset
argument_list|(
name|gdb
argument_list|,
name|node
argument_list|,
name|gversion
argument_list|,
name|type
argument_list|,
name|covers
argument_list|)
expr_stmt|;
name|check_result
argument_list|(
name|result
argument_list|,
literal|"dns_db_deleterdataset(rrsig)"
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|result
operator|!=
name|ISC_R_NOMORE
operator|&&
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
name|fatal
argument_list|(
literal|"rdataset iteration failed: %s"
argument_list|,
name|isc_result_totext
argument_list|(
name|result
argument_list|)
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|result
operator|!=
name|ISC_R_NOMORE
condition|)
name|fatal
argument_list|(
literal|"rdataset iteration failed: %s"
argument_list|,
name|isc_result_totext
argument_list|(
name|result
argument_list|)
argument_list|)
expr_stmt|;
name|dns_rdatasetiter_destroy
argument_list|(
operator|&
name|rdsiter2
argument_list|)
expr_stmt|;
block|}
name|dns_rdatasetiter_destroy
argument_list|(
operator|&
name|rdsiter
argument_list|)
expr_stmt|;
return|return
operator|(
name|active
operator|)
return|;
block|}
end_function

begin_comment
comment|/*%  * Extracts the minimum TTL from the SOA record, and the SOA record's TTL.  */
end_comment

begin_function
specifier|static
name|void
name|get_soa_ttls
parameter_list|(
name|void
parameter_list|)
block|{
name|dns_rdataset_t
name|soaset
decl_stmt|;
name|dns_fixedname_t
name|fname
decl_stmt|;
name|dns_name_t
modifier|*
name|name
decl_stmt|;
name|isc_result_t
name|result
decl_stmt|;
name|dns_rdata_t
name|rdata
init|=
name|DNS_RDATA_INIT
decl_stmt|;
name|dns_fixedname_init
argument_list|(
operator|&
name|fname
argument_list|)
expr_stmt|;
name|name
operator|=
name|dns_fixedname_name
argument_list|(
operator|&
name|fname
argument_list|)
expr_stmt|;
name|dns_rdataset_init
argument_list|(
operator|&
name|soaset
argument_list|)
expr_stmt|;
name|result
operator|=
name|dns_db_find
argument_list|(
name|gdb
argument_list|,
name|gorigin
argument_list|,
name|gversion
argument_list|,
name|dns_rdatatype_soa
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|,
name|name
argument_list|,
operator|&
name|soaset
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
name|fatal
argument_list|(
literal|"failed to find an SOA at the zone apex: %s"
argument_list|,
name|isc_result_totext
argument_list|(
name|result
argument_list|)
argument_list|)
expr_stmt|;
name|result
operator|=
name|dns_rdataset_first
argument_list|(
operator|&
name|soaset
argument_list|)
expr_stmt|;
name|check_result
argument_list|(
name|result
argument_list|,
literal|"dns_rdataset_first"
argument_list|)
expr_stmt|;
name|dns_rdataset_current
argument_list|(
operator|&
name|soaset
argument_list|,
operator|&
name|rdata
argument_list|)
expr_stmt|;
name|zone_soa_min_ttl
operator|=
name|dns_soa_getminimum
argument_list|(
operator|&
name|rdata
argument_list|)
expr_stmt|;
name|soa_ttl
operator|=
name|soaset
operator|.
name|ttl
expr_stmt|;
name|dns_rdataset_disassociate
argument_list|(
operator|&
name|soaset
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*%  * Increment (or set if nonzero) the SOA serial  */
end_comment

begin_function
specifier|static
name|isc_result_t
name|setsoaserial
parameter_list|(
name|isc_uint32_t
name|serial
parameter_list|)
block|{
name|isc_result_t
name|result
decl_stmt|;
name|dns_dbnode_t
modifier|*
name|node
init|=
name|NULL
decl_stmt|;
name|dns_rdataset_t
name|rdataset
decl_stmt|;
name|dns_rdata_t
name|rdata
init|=
name|DNS_RDATA_INIT
decl_stmt|;
name|isc_uint32_t
name|old_serial
decl_stmt|,
name|new_serial
decl_stmt|;
name|result
operator|=
name|dns_db_getoriginnode
argument_list|(
name|gdb
argument_list|,
operator|&
name|node
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
return|return
name|result
return|;
name|dns_rdataset_init
argument_list|(
operator|&
name|rdataset
argument_list|)
expr_stmt|;
name|result
operator|=
name|dns_db_findrdataset
argument_list|(
name|gdb
argument_list|,
name|node
argument_list|,
name|gversion
argument_list|,
name|dns_rdatatype_soa
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
operator|&
name|rdataset
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
goto|goto
name|cleanup
goto|;
name|result
operator|=
name|dns_rdataset_first
argument_list|(
operator|&
name|rdataset
argument_list|)
expr_stmt|;
name|RUNTIME_CHECK
argument_list|(
name|result
operator|==
name|ISC_R_SUCCESS
argument_list|)
expr_stmt|;
name|dns_rdataset_current
argument_list|(
operator|&
name|rdataset
argument_list|,
operator|&
name|rdata
argument_list|)
expr_stmt|;
name|old_serial
operator|=
name|dns_soa_getserial
argument_list|(
operator|&
name|rdata
argument_list|)
expr_stmt|;
if|if
condition|(
name|serial
condition|)
block|{
comment|/* Set SOA serial to the value provided. */
name|new_serial
operator|=
name|serial
expr_stmt|;
block|}
else|else
block|{
comment|/* Increment SOA serial using RFC 1982 arithmetics */
name|new_serial
operator|=
operator|(
name|old_serial
operator|+
literal|1
operator|)
operator|&
literal|0xFFFFFFFF
expr_stmt|;
if|if
condition|(
name|new_serial
operator|==
literal|0
condition|)
name|new_serial
operator|=
literal|1
expr_stmt|;
block|}
comment|/* If the new serial is not likely to cause a zone transfer 	 * (a/ixfr) from servers having the old serial, warn the user. 	 * 	 * RFC1982 section 7 defines the maximum increment to be 	 * (2^(32-1))-1.  Using u_int32_t arithmetic, we can do a single 	 * comparison.  (5 - 6 == (2^32)-1, not negative-one) 	 */
if|if
condition|(
name|new_serial
operator|==
name|old_serial
operator|||
operator|(
name|new_serial
operator|-
name|old_serial
operator|)
operator|>
literal|0x7fffffffU
condition|)
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"%s: warning: Serial number not advanced, "
literal|"zone may not transfer\n"
argument_list|,
name|program
argument_list|)
expr_stmt|;
name|dns_soa_setserial
argument_list|(
name|new_serial
argument_list|,
operator|&
name|rdata
argument_list|)
expr_stmt|;
name|result
operator|=
name|dns_db_deleterdataset
argument_list|(
name|gdb
argument_list|,
name|node
argument_list|,
name|gversion
argument_list|,
name|dns_rdatatype_soa
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|check_result
argument_list|(
name|result
argument_list|,
literal|"dns_db_deleterdataset"
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
goto|goto
name|cleanup
goto|;
name|result
operator|=
name|dns_db_addrdataset
argument_list|(
name|gdb
argument_list|,
name|node
argument_list|,
name|gversion
argument_list|,
literal|0
argument_list|,
operator|&
name|rdataset
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|check_result
argument_list|(
name|result
argument_list|,
literal|"dns_db_addrdataset"
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
goto|goto
name|cleanup
goto|;
name|cleanup
label|:
name|dns_rdataset_disassociate
argument_list|(
operator|&
name|rdataset
argument_list|)
expr_stmt|;
if|if
condition|(
name|node
operator|!=
name|NULL
condition|)
name|dns_db_detachnode
argument_list|(
name|gdb
argument_list|,
operator|&
name|node
argument_list|)
expr_stmt|;
name|dns_rdata_reset
argument_list|(
operator|&
name|rdata
argument_list|)
expr_stmt|;
return|return
operator|(
name|result
operator|)
return|;
block|}
end_function

begin_comment
comment|/*%  * Delete any RRSIG records at a node.  */
end_comment

begin_function
specifier|static
name|void
name|cleannode
parameter_list|(
name|dns_db_t
modifier|*
name|db
parameter_list|,
name|dns_dbversion_t
modifier|*
name|version
parameter_list|,
name|dns_dbnode_t
modifier|*
name|node
parameter_list|)
block|{
name|dns_rdatasetiter_t
modifier|*
name|rdsiter
init|=
name|NULL
decl_stmt|;
name|dns_rdataset_t
name|set
decl_stmt|;
name|isc_result_t
name|result
decl_stmt|,
name|dresult
decl_stmt|;
if|if
condition|(
name|outputformat
operator|!=
name|dns_masterformat_text
operator|||
operator|!
name|disable_zone_check
condition|)
return|return;
name|dns_rdataset_init
argument_list|(
operator|&
name|set
argument_list|)
expr_stmt|;
name|result
operator|=
name|dns_db_allrdatasets
argument_list|(
name|db
argument_list|,
name|node
argument_list|,
name|version
argument_list|,
literal|0
argument_list|,
operator|&
name|rdsiter
argument_list|)
expr_stmt|;
name|check_result
argument_list|(
name|result
argument_list|,
literal|"dns_db_allrdatasets"
argument_list|)
expr_stmt|;
name|result
operator|=
name|dns_rdatasetiter_first
argument_list|(
name|rdsiter
argument_list|)
expr_stmt|;
while|while
condition|(
name|result
operator|==
name|ISC_R_SUCCESS
condition|)
block|{
name|isc_boolean_t
name|destroy
init|=
name|ISC_FALSE
decl_stmt|;
name|dns_rdatatype_t
name|covers
init|=
literal|0
decl_stmt|;
name|dns_rdatasetiter_current
argument_list|(
name|rdsiter
argument_list|,
operator|&
name|set
argument_list|)
expr_stmt|;
if|if
condition|(
name|set
operator|.
name|type
operator|==
name|dns_rdatatype_rrsig
condition|)
block|{
name|covers
operator|=
name|set
operator|.
name|covers
expr_stmt|;
name|destroy
operator|=
name|ISC_TRUE
expr_stmt|;
block|}
name|dns_rdataset_disassociate
argument_list|(
operator|&
name|set
argument_list|)
expr_stmt|;
name|result
operator|=
name|dns_rdatasetiter_next
argument_list|(
name|rdsiter
argument_list|)
expr_stmt|;
if|if
condition|(
name|destroy
condition|)
block|{
name|dresult
operator|=
name|dns_db_deleterdataset
argument_list|(
name|db
argument_list|,
name|node
argument_list|,
name|version
argument_list|,
name|dns_rdatatype_rrsig
argument_list|,
name|covers
argument_list|)
expr_stmt|;
name|check_result
argument_list|(
name|dresult
argument_list|,
literal|"dns_db_deleterdataset"
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
name|result
operator|!=
name|ISC_R_NOMORE
condition|)
name|fatal
argument_list|(
literal|"rdataset iteration failed: %s"
argument_list|,
name|isc_result_totext
argument_list|(
name|result
argument_list|)
argument_list|)
expr_stmt|;
name|dns_rdatasetiter_destroy
argument_list|(
operator|&
name|rdsiter
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*%  * Set up the iterator and global state before starting the tasks.  */
end_comment

begin_function
specifier|static
name|void
name|presign
parameter_list|(
name|void
parameter_list|)
block|{
name|isc_result_t
name|result
decl_stmt|;
name|gdbiter
operator|=
name|NULL
expr_stmt|;
name|result
operator|=
name|dns_db_createiterator
argument_list|(
name|gdb
argument_list|,
literal|0
argument_list|,
operator|&
name|gdbiter
argument_list|)
expr_stmt|;
name|check_result
argument_list|(
name|result
argument_list|,
literal|"dns_db_createiterator()"
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*%  * Clean up the iterator and global state after the tasks complete.  */
end_comment

begin_function
specifier|static
name|void
name|postsign
parameter_list|(
name|void
parameter_list|)
block|{
name|dns_dbiterator_destroy
argument_list|(
operator|&
name|gdbiter
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|isc_boolean_t
name|goodsig
parameter_list|(
name|dns_rdata_t
modifier|*
name|sigrdata
parameter_list|,
name|dns_name_t
modifier|*
name|name
parameter_list|,
name|dns_rdataset_t
modifier|*
name|keyrdataset
parameter_list|,
name|dns_rdataset_t
modifier|*
name|rdataset
parameter_list|)
block|{
name|dns_rdata_dnskey_t
name|key
decl_stmt|;
name|dns_rdata_rrsig_t
name|sig
decl_stmt|;
name|dst_key_t
modifier|*
name|dstkey
init|=
name|NULL
decl_stmt|;
name|isc_result_t
name|result
decl_stmt|;
name|dns_rdata_tostruct
argument_list|(
name|sigrdata
argument_list|,
operator|&
name|sig
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
for|for
control|(
name|result
operator|=
name|dns_rdataset_first
argument_list|(
name|keyrdataset
argument_list|)
init|;
name|result
operator|==
name|ISC_R_SUCCESS
condition|;
name|result
operator|=
name|dns_rdataset_next
argument_list|(
name|keyrdataset
argument_list|)
control|)
block|{
name|dns_rdata_t
name|rdata
init|=
name|DNS_RDATA_INIT
decl_stmt|;
name|dns_rdataset_current
argument_list|(
name|keyrdataset
argument_list|,
operator|&
name|rdata
argument_list|)
expr_stmt|;
name|dns_rdata_tostruct
argument_list|(
operator|&
name|rdata
argument_list|,
operator|&
name|key
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|result
operator|=
name|dns_dnssec_keyfromrdata
argument_list|(
name|gorigin
argument_list|,
operator|&
name|rdata
argument_list|,
name|mctx
argument_list|,
operator|&
name|dstkey
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
return|return
operator|(
name|ISC_FALSE
operator|)
return|;
if|if
condition|(
name|sig
operator|.
name|algorithm
operator|!=
name|key
operator|.
name|algorithm
operator|||
name|sig
operator|.
name|keyid
operator|!=
name|dst_key_id
argument_list|(
name|dstkey
argument_list|)
operator|||
operator|!
name|dns_name_equal
argument_list|(
operator|&
name|sig
operator|.
name|signer
argument_list|,
name|gorigin
argument_list|)
condition|)
block|{
name|dst_key_free
argument_list|(
operator|&
name|dstkey
argument_list|)
expr_stmt|;
continue|continue;
block|}
name|result
operator|=
name|dns_dnssec_verify
argument_list|(
name|name
argument_list|,
name|rdataset
argument_list|,
name|dstkey
argument_list|,
name|ISC_FALSE
argument_list|,
name|mctx
argument_list|,
name|sigrdata
argument_list|)
expr_stmt|;
name|dst_key_free
argument_list|(
operator|&
name|dstkey
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|==
name|ISC_R_SUCCESS
condition|)
return|return
operator|(
name|ISC_TRUE
operator|)
return|;
block|}
return|return
operator|(
name|ISC_FALSE
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|verifyset
parameter_list|(
name|dns_rdataset_t
modifier|*
name|rdataset
parameter_list|,
name|dns_name_t
modifier|*
name|name
parameter_list|,
name|dns_dbnode_t
modifier|*
name|node
parameter_list|,
name|dns_rdataset_t
modifier|*
name|keyrdataset
parameter_list|,
name|unsigned
name|char
modifier|*
name|ksk_algorithms
parameter_list|,
name|unsigned
name|char
modifier|*
name|bad_algorithms
parameter_list|)
block|{
name|unsigned
name|char
name|set_algorithms
index|[
literal|256
index|]
decl_stmt|;
name|char
name|namebuf
index|[
name|DNS_NAME_FORMATSIZE
index|]
decl_stmt|;
name|char
name|algbuf
index|[
literal|80
index|]
decl_stmt|;
name|char
name|typebuf
index|[
literal|80
index|]
decl_stmt|;
name|dns_rdataset_t
name|sigrdataset
decl_stmt|;
name|dns_rdatasetiter_t
modifier|*
name|rdsiter
init|=
name|NULL
decl_stmt|;
name|isc_result_t
name|result
decl_stmt|;
name|int
name|i
decl_stmt|;
name|dns_rdataset_init
argument_list|(
operator|&
name|sigrdataset
argument_list|)
expr_stmt|;
name|result
operator|=
name|dns_db_allrdatasets
argument_list|(
name|gdb
argument_list|,
name|node
argument_list|,
name|gversion
argument_list|,
literal|0
argument_list|,
operator|&
name|rdsiter
argument_list|)
expr_stmt|;
name|check_result
argument_list|(
name|result
argument_list|,
literal|"dns_db_allrdatasets()"
argument_list|)
expr_stmt|;
for|for
control|(
name|result
operator|=
name|dns_rdatasetiter_first
argument_list|(
name|rdsiter
argument_list|)
init|;
name|result
operator|==
name|ISC_R_SUCCESS
condition|;
name|result
operator|=
name|dns_rdatasetiter_next
argument_list|(
name|rdsiter
argument_list|)
control|)
block|{
name|dns_rdatasetiter_current
argument_list|(
name|rdsiter
argument_list|,
operator|&
name|sigrdataset
argument_list|)
expr_stmt|;
if|if
condition|(
name|sigrdataset
operator|.
name|type
operator|==
name|dns_rdatatype_rrsig
operator|&&
name|sigrdataset
operator|.
name|covers
operator|==
name|rdataset
operator|->
name|type
condition|)
break|break;
name|dns_rdataset_disassociate
argument_list|(
operator|&
name|sigrdataset
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
block|{
name|dns_name_format
argument_list|(
name|name
argument_list|,
name|namebuf
argument_list|,
sizeof|sizeof
argument_list|(
name|namebuf
argument_list|)
argument_list|)
expr_stmt|;
name|type_format
argument_list|(
name|rdataset
operator|->
name|type
argument_list|,
name|typebuf
argument_list|,
sizeof|sizeof
argument_list|(
name|typebuf
argument_list|)
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"no signatures for %s/%s\n"
argument_list|,
name|namebuf
argument_list|,
name|typebuf
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|256
condition|;
name|i
operator|++
control|)
if|if
condition|(
name|ksk_algorithms
index|[
name|i
index|]
operator|!=
literal|0
condition|)
name|bad_algorithms
index|[
name|i
index|]
operator|=
literal|1
expr_stmt|;
return|return;
block|}
name|memset
argument_list|(
name|set_algorithms
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|set_algorithms
argument_list|)
argument_list|)
expr_stmt|;
for|for
control|(
name|result
operator|=
name|dns_rdataset_first
argument_list|(
operator|&
name|sigrdataset
argument_list|)
init|;
name|result
operator|==
name|ISC_R_SUCCESS
condition|;
name|result
operator|=
name|dns_rdataset_next
argument_list|(
operator|&
name|sigrdataset
argument_list|)
control|)
block|{
name|dns_rdata_t
name|rdata
init|=
name|DNS_RDATA_INIT
decl_stmt|;
name|dns_rdata_rrsig_t
name|sig
decl_stmt|;
name|dns_rdataset_current
argument_list|(
operator|&
name|sigrdataset
argument_list|,
operator|&
name|rdata
argument_list|)
expr_stmt|;
name|dns_rdata_tostruct
argument_list|(
operator|&
name|rdata
argument_list|,
operator|&
name|sig
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|set_algorithms
index|[
name|sig
operator|.
name|algorithm
index|]
operator|!=
literal|0
operator|)
operator|||
operator|(
name|ksk_algorithms
index|[
name|sig
operator|.
name|algorithm
index|]
operator|==
literal|0
operator|)
condition|)
continue|continue;
if|if
condition|(
name|goodsig
argument_list|(
operator|&
name|rdata
argument_list|,
name|name
argument_list|,
name|keyrdataset
argument_list|,
name|rdataset
argument_list|)
condition|)
name|set_algorithms
index|[
name|sig
operator|.
name|algorithm
index|]
operator|=
literal|1
expr_stmt|;
block|}
name|dns_rdatasetiter_destroy
argument_list|(
operator|&
name|rdsiter
argument_list|)
expr_stmt|;
if|if
condition|(
name|memcmp
argument_list|(
name|set_algorithms
argument_list|,
name|ksk_algorithms
argument_list|,
sizeof|sizeof
argument_list|(
name|set_algorithms
argument_list|)
argument_list|)
condition|)
block|{
name|dns_name_format
argument_list|(
name|name
argument_list|,
name|namebuf
argument_list|,
sizeof|sizeof
argument_list|(
name|namebuf
argument_list|)
argument_list|)
expr_stmt|;
name|type_format
argument_list|(
name|rdataset
operator|->
name|type
argument_list|,
name|typebuf
argument_list|,
sizeof|sizeof
argument_list|(
name|typebuf
argument_list|)
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|256
condition|;
name|i
operator|++
control|)
if|if
condition|(
operator|(
name|ksk_algorithms
index|[
name|i
index|]
operator|!=
literal|0
operator|)
operator|&&
operator|(
name|set_algorithms
index|[
name|i
index|]
operator|==
literal|0
operator|)
condition|)
block|{
name|dns_secalg_format
argument_list|(
name|i
argument_list|,
name|algbuf
argument_list|,
sizeof|sizeof
argument_list|(
name|algbuf
argument_list|)
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Missing %s signature for "
literal|"%s %s\n"
argument_list|,
name|algbuf
argument_list|,
name|namebuf
argument_list|,
name|typebuf
argument_list|)
expr_stmt|;
name|bad_algorithms
index|[
name|i
index|]
operator|=
literal|1
expr_stmt|;
block|}
block|}
name|dns_rdataset_disassociate
argument_list|(
operator|&
name|sigrdataset
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|verifynode
parameter_list|(
name|dns_name_t
modifier|*
name|name
parameter_list|,
name|dns_dbnode_t
modifier|*
name|node
parameter_list|,
name|isc_boolean_t
name|delegation
parameter_list|,
name|dns_rdataset_t
modifier|*
name|keyrdataset
parameter_list|,
name|unsigned
name|char
modifier|*
name|ksk_algorithms
parameter_list|,
name|unsigned
name|char
modifier|*
name|bad_algorithms
parameter_list|)
block|{
name|dns_rdataset_t
name|rdataset
decl_stmt|;
name|dns_rdatasetiter_t
modifier|*
name|rdsiter
init|=
name|NULL
decl_stmt|;
name|isc_result_t
name|result
decl_stmt|;
name|result
operator|=
name|dns_db_allrdatasets
argument_list|(
name|gdb
argument_list|,
name|node
argument_list|,
name|gversion
argument_list|,
literal|0
argument_list|,
operator|&
name|rdsiter
argument_list|)
expr_stmt|;
name|check_result
argument_list|(
name|result
argument_list|,
literal|"dns_db_allrdatasets()"
argument_list|)
expr_stmt|;
name|result
operator|=
name|dns_rdatasetiter_first
argument_list|(
name|rdsiter
argument_list|)
expr_stmt|;
name|dns_rdataset_init
argument_list|(
operator|&
name|rdataset
argument_list|)
expr_stmt|;
while|while
condition|(
name|result
operator|==
name|ISC_R_SUCCESS
condition|)
block|{
name|dns_rdatasetiter_current
argument_list|(
name|rdsiter
argument_list|,
operator|&
name|rdataset
argument_list|)
expr_stmt|;
if|if
condition|(
name|rdataset
operator|.
name|type
operator|!=
name|dns_rdatatype_rrsig
operator|&&
name|rdataset
operator|.
name|type
operator|!=
name|dns_rdatatype_dnskey
operator|&&
operator|(
operator|!
name|delegation
operator|||
name|rdataset
operator|.
name|type
operator|==
name|dns_rdatatype_ds
operator|||
name|rdataset
operator|.
name|type
operator|==
name|dns_rdatatype_nsec
operator|)
condition|)
block|{
name|verifyset
argument_list|(
operator|&
name|rdataset
argument_list|,
name|name
argument_list|,
name|node
argument_list|,
name|keyrdataset
argument_list|,
name|ksk_algorithms
argument_list|,
name|bad_algorithms
argument_list|)
expr_stmt|;
block|}
name|dns_rdataset_disassociate
argument_list|(
operator|&
name|rdataset
argument_list|)
expr_stmt|;
name|result
operator|=
name|dns_rdatasetiter_next
argument_list|(
name|rdsiter
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|result
operator|!=
name|ISC_R_NOMORE
condition|)
name|fatal
argument_list|(
literal|"rdataset iteration failed: %s"
argument_list|,
name|isc_result_totext
argument_list|(
name|result
argument_list|)
argument_list|)
expr_stmt|;
name|dns_rdatasetiter_destroy
argument_list|(
operator|&
name|rdsiter
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*%  * Verify that certain things are sane:  *  *   The apex has a DNSKEY record with at least one KSK, and at least  *   one ZSK if the -x flag was not used.  *  *   The DNSKEY record was signed with at least one of the KSKs in this  *   set.  *  *   The rest of the zone was signed with at least one of the ZSKs  *   present in the DNSKEY RRSET.  */
end_comment

begin_function
specifier|static
name|void
name|verifyzone
parameter_list|(
name|void
parameter_list|)
block|{
name|char
name|algbuf
index|[
literal|80
index|]
decl_stmt|;
name|dns_dbiterator_t
modifier|*
name|dbiter
init|=
name|NULL
decl_stmt|;
name|dns_dbnode_t
modifier|*
name|node
init|=
name|NULL
decl_stmt|,
modifier|*
name|nextnode
init|=
name|NULL
decl_stmt|;
name|dns_fixedname_t
name|fname
decl_stmt|,
name|fnextname
decl_stmt|,
name|fzonecut
decl_stmt|;
name|dns_name_t
modifier|*
name|name
decl_stmt|,
modifier|*
name|nextname
decl_stmt|,
modifier|*
name|zonecut
decl_stmt|;
name|dns_rdata_dnskey_t
name|dnskey
decl_stmt|;
name|dns_rdata_t
name|rdata
init|=
name|DNS_RDATA_INIT
decl_stmt|;
name|dns_rdataset_t
name|rdataset
decl_stmt|;
name|dns_rdataset_t
name|sigrdataset
decl_stmt|;
name|int
name|i
decl_stmt|;
name|isc_boolean_t
name|done
init|=
name|ISC_FALSE
decl_stmt|;
name|isc_boolean_t
name|first
init|=
name|ISC_TRUE
decl_stmt|;
name|isc_boolean_t
name|goodksk
init|=
name|ISC_FALSE
decl_stmt|;
name|isc_boolean_t
name|goodzsk
init|=
name|ISC_FALSE
decl_stmt|;
name|isc_result_t
name|result
decl_stmt|;
name|unsigned
name|char
name|revoked_ksk
index|[
literal|256
index|]
decl_stmt|;
name|unsigned
name|char
name|revoked_zsk
index|[
literal|256
index|]
decl_stmt|;
name|unsigned
name|char
name|standby_ksk
index|[
literal|256
index|]
decl_stmt|;
name|unsigned
name|char
name|standby_zsk
index|[
literal|256
index|]
decl_stmt|;
name|unsigned
name|char
name|ksk_algorithms
index|[
literal|256
index|]
decl_stmt|;
name|unsigned
name|char
name|zsk_algorithms
index|[
literal|256
index|]
decl_stmt|;
name|unsigned
name|char
name|bad_algorithms
index|[
literal|256
index|]
decl_stmt|;
ifdef|#
directive|ifdef
name|ALLOW_KSKLESS_ZONES
name|isc_boolean_t
name|allzsksigned
init|=
name|ISC_TRUE
decl_stmt|;
name|unsigned
name|char
name|self_algorithms
index|[
literal|256
index|]
decl_stmt|;
endif|#
directive|endif
if|if
condition|(
name|disable_zone_check
condition|)
return|return;
name|result
operator|=
name|dns_db_findnode
argument_list|(
name|gdb
argument_list|,
name|gorigin
argument_list|,
name|ISC_FALSE
argument_list|,
operator|&
name|node
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
name|fatal
argument_list|(
literal|"failed to find the zone's origin: %s"
argument_list|,
name|isc_result_totext
argument_list|(
name|result
argument_list|)
argument_list|)
expr_stmt|;
name|dns_rdataset_init
argument_list|(
operator|&
name|rdataset
argument_list|)
expr_stmt|;
name|dns_rdataset_init
argument_list|(
operator|&
name|sigrdataset
argument_list|)
expr_stmt|;
name|result
operator|=
name|dns_db_findrdataset
argument_list|(
name|gdb
argument_list|,
name|node
argument_list|,
name|gversion
argument_list|,
name|dns_rdatatype_dnskey
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
operator|&
name|rdataset
argument_list|,
operator|&
name|sigrdataset
argument_list|)
expr_stmt|;
name|dns_db_detachnode
argument_list|(
name|gdb
argument_list|,
operator|&
name|node
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
name|fatal
argument_list|(
literal|"cannot find DNSKEY rrset\n"
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|dns_rdataset_isassociated
argument_list|(
operator|&
name|sigrdataset
argument_list|)
condition|)
name|fatal
argument_list|(
literal|"cannot find DNSKEY RRSIGs\n"
argument_list|)
expr_stmt|;
name|memset
argument_list|(
name|revoked_ksk
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|revoked_ksk
argument_list|)
argument_list|)
expr_stmt|;
name|memset
argument_list|(
name|revoked_zsk
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|revoked_zsk
argument_list|)
argument_list|)
expr_stmt|;
name|memset
argument_list|(
name|standby_ksk
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|standby_ksk
argument_list|)
argument_list|)
expr_stmt|;
name|memset
argument_list|(
name|standby_zsk
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|standby_zsk
argument_list|)
argument_list|)
expr_stmt|;
name|memset
argument_list|(
name|ksk_algorithms
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|ksk_algorithms
argument_list|)
argument_list|)
expr_stmt|;
name|memset
argument_list|(
name|zsk_algorithms
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|zsk_algorithms
argument_list|)
argument_list|)
expr_stmt|;
name|memset
argument_list|(
name|bad_algorithms
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|bad_algorithms
argument_list|)
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|ALLOW_KSKLESS_ZONES
name|memset
argument_list|(
name|self_algorithms
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|self_algorithms
argument_list|)
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* 	 * Check that the DNSKEY RR has at least one self signing KSK 	 * and one ZSK per algorithm in it (or, if -x was used, one 	 * self-signing KSK). 	 */
for|for
control|(
name|result
operator|=
name|dns_rdataset_first
argument_list|(
operator|&
name|rdataset
argument_list|)
init|;
name|result
operator|==
name|ISC_R_SUCCESS
condition|;
name|result
operator|=
name|dns_rdataset_next
argument_list|(
operator|&
name|rdataset
argument_list|)
control|)
block|{
name|dns_rdataset_current
argument_list|(
operator|&
name|rdataset
argument_list|,
operator|&
name|rdata
argument_list|)
expr_stmt|;
name|result
operator|=
name|dns_rdata_tostruct
argument_list|(
operator|&
name|rdata
argument_list|,
operator|&
name|dnskey
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|check_result
argument_list|(
name|result
argument_list|,
literal|"dns_rdata_tostruct"
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|dnskey
operator|.
name|flags
operator|&
name|DNS_KEYOWNER_ZONE
operator|)
operator|==
literal|0
condition|)
empty_stmt|;
elseif|else
if|if
condition|(
operator|(
name|dnskey
operator|.
name|flags
operator|&
name|DNS_KEYFLAG_REVOKE
operator|)
operator|!=
literal|0
condition|)
block|{
if|if
condition|(
operator|(
name|dnskey
operator|.
name|flags
operator|&
name|DNS_KEYFLAG_KSK
operator|)
operator|!=
literal|0
operator|&&
operator|!
name|dns_dnssec_selfsigns
argument_list|(
operator|&
name|rdata
argument_list|,
name|gorigin
argument_list|,
operator|&
name|rdataset
argument_list|,
operator|&
name|sigrdataset
argument_list|,
name|ISC_FALSE
argument_list|,
name|mctx
argument_list|)
condition|)
block|{
name|char
name|namebuf
index|[
name|DNS_NAME_FORMATSIZE
index|]
decl_stmt|;
name|char
name|buffer
index|[
literal|1024
index|]
decl_stmt|;
name|isc_buffer_t
name|buf
decl_stmt|;
name|dns_name_format
argument_list|(
name|gorigin
argument_list|,
name|namebuf
argument_list|,
sizeof|sizeof
argument_list|(
name|namebuf
argument_list|)
argument_list|)
expr_stmt|;
name|isc_buffer_init
argument_list|(
operator|&
name|buf
argument_list|,
name|buffer
argument_list|,
sizeof|sizeof
argument_list|(
name|buffer
argument_list|)
argument_list|)
expr_stmt|;
name|result
operator|=
name|dns_rdata_totext
argument_list|(
operator|&
name|rdata
argument_list|,
name|NULL
argument_list|,
operator|&
name|buf
argument_list|)
expr_stmt|;
name|check_result
argument_list|(
name|result
argument_list|,
literal|"dns_rdata_totext"
argument_list|)
expr_stmt|;
name|fatal
argument_list|(
literal|"revoked KSK is not self signed:\n"
literal|"%s DNSKEY %.*s"
argument_list|,
name|namebuf
argument_list|,
operator|(
name|int
operator|)
name|isc_buffer_usedlength
argument_list|(
operator|&
name|buf
argument_list|)
argument_list|,
name|buffer
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|dnskey
operator|.
name|flags
operator|&
name|DNS_KEYFLAG_KSK
operator|)
operator|!=
literal|0
operator|&&
name|revoked_ksk
index|[
name|dnskey
operator|.
name|algorithm
index|]
operator|!=
literal|255
condition|)
name|revoked_ksk
index|[
name|dnskey
operator|.
name|algorithm
index|]
operator|++
expr_stmt|;
elseif|else
if|if
condition|(
operator|(
name|dnskey
operator|.
name|flags
operator|&
name|DNS_KEYFLAG_KSK
operator|)
operator|==
literal|0
operator|&&
name|revoked_zsk
index|[
name|dnskey
operator|.
name|algorithm
index|]
operator|!=
literal|255
condition|)
name|revoked_zsk
index|[
name|dnskey
operator|.
name|algorithm
index|]
operator|++
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|(
name|dnskey
operator|.
name|flags
operator|&
name|DNS_KEYFLAG_KSK
operator|)
operator|!=
literal|0
condition|)
block|{
if|if
condition|(
name|dns_dnssec_selfsigns
argument_list|(
operator|&
name|rdata
argument_list|,
name|gorigin
argument_list|,
operator|&
name|rdataset
argument_list|,
operator|&
name|sigrdataset
argument_list|,
name|ISC_FALSE
argument_list|,
name|mctx
argument_list|)
condition|)
block|{
if|if
condition|(
name|ksk_algorithms
index|[
name|dnskey
operator|.
name|algorithm
index|]
operator|!=
literal|255
condition|)
name|ksk_algorithms
index|[
name|dnskey
operator|.
name|algorithm
index|]
operator|++
expr_stmt|;
name|goodksk
operator|=
name|ISC_TRUE
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|standby_ksk
index|[
name|dnskey
operator|.
name|algorithm
index|]
operator|!=
literal|255
condition|)
name|standby_ksk
index|[
name|dnskey
operator|.
name|algorithm
index|]
operator|++
expr_stmt|;
block|}
block|}
elseif|else
if|if
condition|(
name|dns_dnssec_selfsigns
argument_list|(
operator|&
name|rdata
argument_list|,
name|gorigin
argument_list|,
operator|&
name|rdataset
argument_list|,
operator|&
name|sigrdataset
argument_list|,
name|ISC_FALSE
argument_list|,
name|mctx
argument_list|)
condition|)
block|{
ifdef|#
directive|ifdef
name|ALLOW_KSKLESS_ZONES
if|if
condition|(
name|self_algorithms
index|[
name|dnskey
operator|.
name|algorithm
index|]
operator|!=
literal|255
condition|)
name|self_algorithms
index|[
name|dnskey
operator|.
name|algorithm
index|]
operator|++
expr_stmt|;
endif|#
directive|endif
if|if
condition|(
name|zsk_algorithms
index|[
name|dnskey
operator|.
name|algorithm
index|]
operator|!=
literal|255
condition|)
name|zsk_algorithms
index|[
name|dnskey
operator|.
name|algorithm
index|]
operator|++
expr_stmt|;
name|goodzsk
operator|=
name|ISC_TRUE
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|standby_zsk
index|[
name|dnskey
operator|.
name|algorithm
index|]
operator|!=
literal|255
condition|)
name|standby_zsk
index|[
name|dnskey
operator|.
name|algorithm
index|]
operator|++
expr_stmt|;
ifdef|#
directive|ifdef
name|ALLOW_KSKLESS_ZONES
name|allzsksigned
operator|=
name|ISC_FALSE
expr_stmt|;
endif|#
directive|endif
block|}
name|dns_rdata_freestruct
argument_list|(
operator|&
name|dnskey
argument_list|)
expr_stmt|;
name|dns_rdata_reset
argument_list|(
operator|&
name|rdata
argument_list|)
expr_stmt|;
block|}
name|dns_rdataset_disassociate
argument_list|(
operator|&
name|sigrdataset
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|ALLOW_KSKLESS_ZONES
if|if
condition|(
operator|!
name|goodksk
condition|)
block|{
if|if
condition|(
operator|!
name|ignore_kskflag
condition|)
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"No self signing KSK found. Using "
literal|"self signed ZSK's for active "
literal|"algorithm list.\n"
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
name|ksk_algorithms
argument_list|,
name|self_algorithms
argument_list|,
sizeof|sizeof
argument_list|(
name|ksk_algorithms
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|allzsksigned
condition|)
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"warning: not all ZSK's are self "
literal|"signed.\n"
argument_list|)
expr_stmt|;
block|}
else|#
directive|else
if|if
condition|(
operator|!
name|goodksk
condition|)
block|{
name|fatal
argument_list|(
literal|"no self signed KSK's found"
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Verifying the zone using the following algorithms:"
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|256
condition|;
name|i
operator|++
control|)
block|{
ifdef|#
directive|ifdef
name|ALLOW_KSKLESS_ZONES
if|if
condition|(
name|ksk_algorithms
index|[
name|i
index|]
operator|!=
literal|0
operator|||
name|zsk_algorithms
index|[
name|i
index|]
operator|!=
literal|0
condition|)
else|#
directive|else
if|if
condition|(
name|ksk_algorithms
index|[
name|i
index|]
operator|!=
literal|0
condition|)
endif|#
directive|endif
block|{
name|dns_secalg_format
argument_list|(
name|i
argument_list|,
name|algbuf
argument_list|,
sizeof|sizeof
argument_list|(
name|algbuf
argument_list|)
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|" %s"
argument_list|,
name|algbuf
argument_list|)
expr_stmt|;
block|}
block|}
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|".\n"
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|ignore_kskflag
operator|&&
operator|!
name|keyset_kskonly
condition|)
block|{
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|256
condition|;
name|i
operator|++
control|)
block|{
comment|/* 			 * The counts should both be zero or both be non-zero. 			 * Mark the algorithm as bad if this is not met. 			 */
if|if
condition|(
operator|(
name|ksk_algorithms
index|[
name|i
index|]
operator|!=
literal|0
operator|)
operator|==
operator|(
name|zsk_algorithms
index|[
name|i
index|]
operator|!=
literal|0
operator|)
condition|)
continue|continue;
name|dns_secalg_format
argument_list|(
name|i
argument_list|,
name|algbuf
argument_list|,
sizeof|sizeof
argument_list|(
name|algbuf
argument_list|)
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Missing %s for algorithm %s\n"
argument_list|,
operator|(
name|ksk_algorithms
index|[
name|i
index|]
operator|!=
literal|0
operator|)
condition|?
literal|"ZSK"
else|:
literal|"self signing KSK"
argument_list|,
name|algbuf
argument_list|)
expr_stmt|;
name|bad_algorithms
index|[
name|i
index|]
operator|=
literal|1
expr_stmt|;
block|}
block|}
comment|/* 	 * Check that all the other records were signed by keys that are 	 * present in the DNSKEY RRSET. 	 */
name|dns_fixedname_init
argument_list|(
operator|&
name|fname
argument_list|)
expr_stmt|;
name|name
operator|=
name|dns_fixedname_name
argument_list|(
operator|&
name|fname
argument_list|)
expr_stmt|;
name|dns_fixedname_init
argument_list|(
operator|&
name|fnextname
argument_list|)
expr_stmt|;
name|nextname
operator|=
name|dns_fixedname_name
argument_list|(
operator|&
name|fnextname
argument_list|)
expr_stmt|;
name|dns_fixedname_init
argument_list|(
operator|&
name|fzonecut
argument_list|)
expr_stmt|;
name|zonecut
operator|=
name|NULL
expr_stmt|;
name|result
operator|=
name|dns_db_createiterator
argument_list|(
name|gdb
argument_list|,
name|DNS_DB_NONSEC3
argument_list|,
operator|&
name|dbiter
argument_list|)
expr_stmt|;
name|check_result
argument_list|(
name|result
argument_list|,
literal|"dns_db_createiterator()"
argument_list|)
expr_stmt|;
name|result
operator|=
name|dns_dbiterator_first
argument_list|(
name|dbiter
argument_list|)
expr_stmt|;
name|check_result
argument_list|(
name|result
argument_list|,
literal|"dns_dbiterator_first()"
argument_list|)
expr_stmt|;
while|while
condition|(
operator|!
name|done
condition|)
block|{
name|isc_boolean_t
name|isdelegation
init|=
name|ISC_FALSE
decl_stmt|;
name|result
operator|=
name|dns_dbiterator_current
argument_list|(
name|dbiter
argument_list|,
operator|&
name|node
argument_list|,
name|name
argument_list|)
expr_stmt|;
name|check_dns_dbiterator_current
argument_list|(
name|result
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|dns_name_issubdomain
argument_list|(
name|name
argument_list|,
name|gorigin
argument_list|)
condition|)
block|{
name|dns_db_detachnode
argument_list|(
name|gdb
argument_list|,
operator|&
name|node
argument_list|)
expr_stmt|;
name|result
operator|=
name|dns_dbiterator_next
argument_list|(
name|dbiter
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|==
name|ISC_R_NOMORE
condition|)
name|done
operator|=
name|ISC_TRUE
expr_stmt|;
else|else
name|check_result
argument_list|(
name|result
argument_list|,
literal|"dns_dbiterator_next()"
argument_list|)
expr_stmt|;
continue|continue;
block|}
if|if
condition|(
name|delegation
argument_list|(
name|name
argument_list|,
name|node
argument_list|,
name|NULL
argument_list|)
condition|)
block|{
name|zonecut
operator|=
name|dns_fixedname_name
argument_list|(
operator|&
name|fzonecut
argument_list|)
expr_stmt|;
name|dns_name_copy
argument_list|(
name|name
argument_list|,
name|zonecut
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|isdelegation
operator|=
name|ISC_TRUE
expr_stmt|;
block|}
name|verifynode
argument_list|(
name|name
argument_list|,
name|node
argument_list|,
name|isdelegation
argument_list|,
operator|&
name|rdataset
argument_list|,
name|ksk_algorithms
argument_list|,
name|bad_algorithms
argument_list|)
expr_stmt|;
name|result
operator|=
name|dns_dbiterator_next
argument_list|(
name|dbiter
argument_list|)
expr_stmt|;
name|nextnode
operator|=
name|NULL
expr_stmt|;
while|while
condition|(
name|result
operator|==
name|ISC_R_SUCCESS
condition|)
block|{
name|result
operator|=
name|dns_dbiterator_current
argument_list|(
name|dbiter
argument_list|,
operator|&
name|nextnode
argument_list|,
name|nextname
argument_list|)
expr_stmt|;
name|check_dns_dbiterator_current
argument_list|(
name|result
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|dns_name_issubdomain
argument_list|(
name|nextname
argument_list|,
name|gorigin
argument_list|)
operator|||
operator|(
name|zonecut
operator|!=
name|NULL
operator|&&
name|dns_name_issubdomain
argument_list|(
name|nextname
argument_list|,
name|zonecut
argument_list|)
operator|)
condition|)
block|{
name|dns_db_detachnode
argument_list|(
name|gdb
argument_list|,
operator|&
name|nextnode
argument_list|)
expr_stmt|;
name|result
operator|=
name|dns_dbiterator_next
argument_list|(
name|dbiter
argument_list|)
expr_stmt|;
continue|continue;
block|}
name|dns_db_detachnode
argument_list|(
name|gdb
argument_list|,
operator|&
name|nextnode
argument_list|)
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|result
operator|==
name|ISC_R_NOMORE
condition|)
block|{
name|done
operator|=
name|ISC_TRUE
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
name|fatal
argument_list|(
literal|"iterating through the database failed: %s"
argument_list|,
name|isc_result_totext
argument_list|(
name|result
argument_list|)
argument_list|)
expr_stmt|;
name|dns_db_detachnode
argument_list|(
name|gdb
argument_list|,
operator|&
name|node
argument_list|)
expr_stmt|;
block|}
name|dns_dbiterator_destroy
argument_list|(
operator|&
name|dbiter
argument_list|)
expr_stmt|;
name|result
operator|=
name|dns_db_createiterator
argument_list|(
name|gdb
argument_list|,
name|DNS_DB_NSEC3ONLY
argument_list|,
operator|&
name|dbiter
argument_list|)
expr_stmt|;
name|check_result
argument_list|(
name|result
argument_list|,
literal|"dns_db_createiterator()"
argument_list|)
expr_stmt|;
for|for
control|(
name|result
operator|=
name|dns_dbiterator_first
argument_list|(
name|dbiter
argument_list|)
init|;
name|result
operator|==
name|ISC_R_SUCCESS
condition|;
name|result
operator|=
name|dns_dbiterator_next
argument_list|(
name|dbiter
argument_list|)
control|)
block|{
name|result
operator|=
name|dns_dbiterator_current
argument_list|(
name|dbiter
argument_list|,
operator|&
name|node
argument_list|,
name|name
argument_list|)
expr_stmt|;
name|check_dns_dbiterator_current
argument_list|(
name|result
argument_list|)
expr_stmt|;
name|verifynode
argument_list|(
name|name
argument_list|,
name|node
argument_list|,
name|ISC_FALSE
argument_list|,
operator|&
name|rdataset
argument_list|,
name|ksk_algorithms
argument_list|,
name|bad_algorithms
argument_list|)
expr_stmt|;
name|dns_db_detachnode
argument_list|(
name|gdb
argument_list|,
operator|&
name|node
argument_list|)
expr_stmt|;
block|}
name|dns_dbiterator_destroy
argument_list|(
operator|&
name|dbiter
argument_list|)
expr_stmt|;
name|dns_rdataset_disassociate
argument_list|(
operator|&
name|rdataset
argument_list|)
expr_stmt|;
comment|/* 	 * If we made it this far, we have what we consider a properly signed 	 * zone.  Set the good flag. 	 */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|256
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|bad_algorithms
index|[
name|i
index|]
operator|!=
literal|0
condition|)
block|{
if|if
condition|(
name|first
condition|)
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"The zone is not fully signed "
literal|"for the following algorithms:"
argument_list|)
expr_stmt|;
name|dns_secalg_format
argument_list|(
name|i
argument_list|,
name|algbuf
argument_list|,
sizeof|sizeof
argument_list|(
name|algbuf
argument_list|)
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|" %s"
argument_list|,
name|algbuf
argument_list|)
expr_stmt|;
name|first
operator|=
name|ISC_FALSE
expr_stmt|;
block|}
block|}
if|if
condition|(
operator|!
name|first
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|".\n"
argument_list|)
expr_stmt|;
name|fatal
argument_list|(
literal|"DNSSEC completeness test failed."
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|goodksk
operator|||
name|ignore_kskflag
condition|)
block|{
comment|/* 		 * Print the success summary. 		 */
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Zone signing complete:\n"
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|256
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
operator|(
name|ksk_algorithms
index|[
name|i
index|]
operator|!=
literal|0
operator|)
operator|||
operator|(
name|standby_ksk
index|[
name|i
index|]
operator|!=
literal|0
operator|)
operator|||
operator|(
name|revoked_zsk
index|[
name|i
index|]
operator|!=
literal|0
operator|)
operator|||
operator|(
name|zsk_algorithms
index|[
name|i
index|]
operator|!=
literal|0
operator|)
operator|||
operator|(
name|standby_zsk
index|[
name|i
index|]
operator|!=
literal|0
operator|)
operator|||
operator|(
name|revoked_zsk
index|[
name|i
index|]
operator|!=
literal|0
operator|)
condition|)
block|{
name|dns_secalg_format
argument_list|(
name|i
argument_list|,
name|algbuf
argument_list|,
sizeof|sizeof
argument_list|(
name|algbuf
argument_list|)
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Algorithm: %s: KSKs: "
literal|"%u active, %u stand-by, %u revoked\n"
argument_list|,
name|algbuf
argument_list|,
name|ksk_algorithms
index|[
name|i
index|]
argument_list|,
name|standby_ksk
index|[
name|i
index|]
argument_list|,
name|revoked_ksk
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"%*sZSKs: "
literal|"%u active, %u %s, %u revoked\n"
argument_list|,
operator|(
name|int
operator|)
name|strlen
argument_list|(
name|algbuf
argument_list|)
operator|+
literal|13
argument_list|,
literal|""
argument_list|,
name|zsk_algorithms
index|[
name|i
index|]
argument_list|,
name|standby_zsk
index|[
name|i
index|]
argument_list|,
name|keyset_kskonly
condition|?
literal|"present"
else|:
literal|"stand-by"
argument_list|,
name|revoked_zsk
index|[
name|i
index|]
argument_list|)
expr_stmt|;
block|}
block|}
block|}
block|}
end_function

begin_comment
comment|/*%  * Sign the apex of the zone.  * Note the origin may not be the first node if there are out of zone  * records.  */
end_comment

begin_function
specifier|static
name|void
name|signapex
parameter_list|(
name|void
parameter_list|)
block|{
name|dns_dbnode_t
modifier|*
name|node
init|=
name|NULL
decl_stmt|;
name|dns_fixedname_t
name|fixed
decl_stmt|;
name|dns_name_t
modifier|*
name|name
decl_stmt|;
name|isc_result_t
name|result
decl_stmt|;
name|dns_fixedname_init
argument_list|(
operator|&
name|fixed
argument_list|)
expr_stmt|;
name|name
operator|=
name|dns_fixedname_name
argument_list|(
operator|&
name|fixed
argument_list|)
expr_stmt|;
name|result
operator|=
name|dns_dbiterator_seek
argument_list|(
name|gdbiter
argument_list|,
name|gorigin
argument_list|)
expr_stmt|;
name|check_result
argument_list|(
name|result
argument_list|,
literal|"dns_dbiterator_seek()"
argument_list|)
expr_stmt|;
name|result
operator|=
name|dns_dbiterator_current
argument_list|(
name|gdbiter
argument_list|,
operator|&
name|node
argument_list|,
name|name
argument_list|)
expr_stmt|;
name|check_dns_dbiterator_current
argument_list|(
name|result
argument_list|)
expr_stmt|;
name|signname
argument_list|(
name|node
argument_list|,
name|name
argument_list|)
expr_stmt|;
name|dumpnode
argument_list|(
name|name
argument_list|,
name|node
argument_list|)
expr_stmt|;
name|cleannode
argument_list|(
name|gdb
argument_list|,
name|gversion
argument_list|,
name|node
argument_list|)
expr_stmt|;
name|dns_db_detachnode
argument_list|(
name|gdb
argument_list|,
operator|&
name|node
argument_list|)
expr_stmt|;
name|result
operator|=
name|dns_dbiterator_first
argument_list|(
name|gdbiter
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|==
name|ISC_R_NOMORE
condition|)
name|finished
operator|=
name|ISC_TRUE
expr_stmt|;
elseif|else
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
name|fatal
argument_list|(
literal|"failure iterating database: %s"
argument_list|,
name|isc_result_totext
argument_list|(
name|result
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*%  * Assigns a node to a worker thread.  This is protected by the master task's  * lock.  */
end_comment

begin_function
specifier|static
name|void
name|assignwork
parameter_list|(
name|isc_task_t
modifier|*
name|task
parameter_list|,
name|isc_task_t
modifier|*
name|worker
parameter_list|)
block|{
name|dns_fixedname_t
modifier|*
name|fname
decl_stmt|;
name|dns_name_t
modifier|*
name|name
decl_stmt|;
name|dns_dbnode_t
modifier|*
name|node
decl_stmt|;
name|sevent_t
modifier|*
name|sevent
decl_stmt|;
name|dns_rdataset_t
name|nsec
decl_stmt|;
name|isc_boolean_t
name|found
decl_stmt|;
name|isc_result_t
name|result
decl_stmt|;
specifier|static
name|dns_name_t
modifier|*
name|zonecut
init|=
name|NULL
decl_stmt|;
comment|/* Protected by namelock. */
specifier|static
name|dns_fixedname_t
name|fzonecut
decl_stmt|;
comment|/* Protected by namelock. */
specifier|static
name|unsigned
name|int
name|ended
init|=
literal|0
decl_stmt|;
comment|/* Protected by namelock. */
if|if
condition|(
name|shuttingdown
condition|)
return|return;
name|LOCK
argument_list|(
operator|&
name|namelock
argument_list|)
expr_stmt|;
if|if
condition|(
name|finished
condition|)
block|{
name|ended
operator|++
expr_stmt|;
if|if
condition|(
name|ended
operator|==
name|ntasks
condition|)
block|{
name|isc_task_detach
argument_list|(
operator|&
name|task
argument_list|)
expr_stmt|;
name|isc_app_shutdown
argument_list|()
expr_stmt|;
block|}
goto|goto
name|unlock
goto|;
block|}
name|fname
operator|=
name|isc_mem_get
argument_list|(
name|mctx
argument_list|,
sizeof|sizeof
argument_list|(
name|dns_fixedname_t
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|fname
operator|==
name|NULL
condition|)
name|fatal
argument_list|(
literal|"out of memory"
argument_list|)
expr_stmt|;
name|dns_fixedname_init
argument_list|(
name|fname
argument_list|)
expr_stmt|;
name|name
operator|=
name|dns_fixedname_name
argument_list|(
name|fname
argument_list|)
expr_stmt|;
name|node
operator|=
name|NULL
expr_stmt|;
name|found
operator|=
name|ISC_FALSE
expr_stmt|;
while|while
condition|(
operator|!
name|found
condition|)
block|{
name|result
operator|=
name|dns_dbiterator_current
argument_list|(
name|gdbiter
argument_list|,
operator|&
name|node
argument_list|,
name|name
argument_list|)
expr_stmt|;
name|check_dns_dbiterator_current
argument_list|(
name|result
argument_list|)
expr_stmt|;
comment|/* 		 * The origin was handled by signapex(). 		 */
if|if
condition|(
name|dns_name_equal
argument_list|(
name|name
argument_list|,
name|gorigin
argument_list|)
condition|)
block|{
name|dns_db_detachnode
argument_list|(
name|gdb
argument_list|,
operator|&
name|node
argument_list|)
expr_stmt|;
goto|goto
name|next
goto|;
block|}
comment|/* 		 * Sort the zone data from the glue and out-of-zone data. 		 * For NSEC zones nodes with zone data have NSEC records. 		 * For NSEC3 zones the NSEC3 nodes are zone data but 		 * outside of the zone name space.  For the rest we need 		 * to track the bottom of zone cuts. 		 * Nodes which don't need to be signed are dumped here. 		 */
name|dns_rdataset_init
argument_list|(
operator|&
name|nsec
argument_list|)
expr_stmt|;
name|result
operator|=
name|dns_db_findrdataset
argument_list|(
name|gdb
argument_list|,
name|node
argument_list|,
name|gversion
argument_list|,
name|nsec_datatype
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
operator|&
name|nsec
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|dns_rdataset_isassociated
argument_list|(
operator|&
name|nsec
argument_list|)
condition|)
name|dns_rdataset_disassociate
argument_list|(
operator|&
name|nsec
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|==
name|ISC_R_SUCCESS
condition|)
block|{
name|found
operator|=
name|ISC_TRUE
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|nsec_datatype
operator|==
name|dns_rdatatype_nsec3
condition|)
block|{
if|if
condition|(
name|dns_name_issubdomain
argument_list|(
name|name
argument_list|,
name|gorigin
argument_list|)
operator|&&
operator|(
name|zonecut
operator|==
name|NULL
operator|||
operator|!
name|dns_name_issubdomain
argument_list|(
name|name
argument_list|,
name|zonecut
argument_list|)
operator|)
condition|)
block|{
if|if
condition|(
name|delegation
argument_list|(
name|name
argument_list|,
name|node
argument_list|,
name|NULL
argument_list|)
condition|)
block|{
name|dns_fixedname_init
argument_list|(
operator|&
name|fzonecut
argument_list|)
expr_stmt|;
name|zonecut
operator|=
name|dns_fixedname_name
argument_list|(
operator|&
name|fzonecut
argument_list|)
expr_stmt|;
name|dns_name_copy
argument_list|(
name|name
argument_list|,
name|zonecut
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|OPTOUT
argument_list|(
name|nsec3flags
argument_list|)
operator|||
name|secure
argument_list|(
name|name
argument_list|,
name|node
argument_list|)
condition|)
name|found
operator|=
name|ISC_TRUE
expr_stmt|;
block|}
else|else
name|found
operator|=
name|ISC_TRUE
expr_stmt|;
block|}
block|}
if|if
condition|(
operator|!
name|found
condition|)
block|{
name|dumpnode
argument_list|(
name|name
argument_list|,
name|node
argument_list|)
expr_stmt|;
name|dns_db_detachnode
argument_list|(
name|gdb
argument_list|,
operator|&
name|node
argument_list|)
expr_stmt|;
block|}
name|next
label|:
name|result
operator|=
name|dns_dbiterator_next
argument_list|(
name|gdbiter
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|==
name|ISC_R_NOMORE
condition|)
block|{
name|finished
operator|=
name|ISC_TRUE
expr_stmt|;
break|break;
block|}
elseif|else
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
name|fatal
argument_list|(
literal|"failure iterating database: %s"
argument_list|,
name|isc_result_totext
argument_list|(
name|result
argument_list|)
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|found
condition|)
block|{
name|ended
operator|++
expr_stmt|;
if|if
condition|(
name|ended
operator|==
name|ntasks
condition|)
block|{
name|isc_task_detach
argument_list|(
operator|&
name|task
argument_list|)
expr_stmt|;
name|isc_app_shutdown
argument_list|()
expr_stmt|;
block|}
name|isc_mem_put
argument_list|(
name|mctx
argument_list|,
name|fname
argument_list|,
sizeof|sizeof
argument_list|(
name|dns_fixedname_t
argument_list|)
argument_list|)
expr_stmt|;
goto|goto
name|unlock
goto|;
block|}
name|sevent
operator|=
operator|(
name|sevent_t
operator|*
operator|)
name|isc_event_allocate
argument_list|(
name|mctx
argument_list|,
name|task
argument_list|,
name|SIGNER_EVENT_WORK
argument_list|,
name|sign
argument_list|,
name|NULL
argument_list|,
sizeof|sizeof
argument_list|(
name|sevent_t
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|sevent
operator|==
name|NULL
condition|)
name|fatal
argument_list|(
literal|"failed to allocate event\n"
argument_list|)
expr_stmt|;
name|sevent
operator|->
name|node
operator|=
name|node
expr_stmt|;
name|sevent
operator|->
name|fname
operator|=
name|fname
expr_stmt|;
name|isc_task_send
argument_list|(
name|worker
argument_list|,
name|ISC_EVENT_PTR
argument_list|(
operator|&
name|sevent
argument_list|)
argument_list|)
expr_stmt|;
name|unlock
label|:
name|UNLOCK
argument_list|(
operator|&
name|namelock
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*%  * Start a worker task  */
end_comment

begin_function
specifier|static
name|void
name|startworker
parameter_list|(
name|isc_task_t
modifier|*
name|task
parameter_list|,
name|isc_event_t
modifier|*
name|event
parameter_list|)
block|{
name|isc_task_t
modifier|*
name|worker
decl_stmt|;
name|worker
operator|=
operator|(
name|isc_task_t
operator|*
operator|)
name|event
operator|->
name|ev_arg
expr_stmt|;
name|assignwork
argument_list|(
name|task
argument_list|,
name|worker
argument_list|)
expr_stmt|;
name|isc_event_free
argument_list|(
operator|&
name|event
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*%  * Write a node to the output file, and restart the worker task.  */
end_comment

begin_function
specifier|static
name|void
name|writenode
parameter_list|(
name|isc_task_t
modifier|*
name|task
parameter_list|,
name|isc_event_t
modifier|*
name|event
parameter_list|)
block|{
name|isc_task_t
modifier|*
name|worker
decl_stmt|;
name|sevent_t
modifier|*
name|sevent
init|=
operator|(
name|sevent_t
operator|*
operator|)
name|event
decl_stmt|;
name|worker
operator|=
operator|(
name|isc_task_t
operator|*
operator|)
name|event
operator|->
name|ev_sender
expr_stmt|;
name|dumpnode
argument_list|(
name|dns_fixedname_name
argument_list|(
name|sevent
operator|->
name|fname
argument_list|)
argument_list|,
name|sevent
operator|->
name|node
argument_list|)
expr_stmt|;
name|cleannode
argument_list|(
name|gdb
argument_list|,
name|gversion
argument_list|,
name|sevent
operator|->
name|node
argument_list|)
expr_stmt|;
name|dns_db_detachnode
argument_list|(
name|gdb
argument_list|,
operator|&
name|sevent
operator|->
name|node
argument_list|)
expr_stmt|;
name|isc_mem_put
argument_list|(
name|mctx
argument_list|,
name|sevent
operator|->
name|fname
argument_list|,
sizeof|sizeof
argument_list|(
name|dns_fixedname_t
argument_list|)
argument_list|)
expr_stmt|;
name|assignwork
argument_list|(
name|task
argument_list|,
name|worker
argument_list|)
expr_stmt|;
name|isc_event_free
argument_list|(
operator|&
name|event
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*%  *  Sign a database node.  */
end_comment

begin_function
specifier|static
name|void
name|sign
parameter_list|(
name|isc_task_t
modifier|*
name|task
parameter_list|,
name|isc_event_t
modifier|*
name|event
parameter_list|)
block|{
name|dns_fixedname_t
modifier|*
name|fname
decl_stmt|;
name|dns_dbnode_t
modifier|*
name|node
decl_stmt|;
name|sevent_t
modifier|*
name|sevent
decl_stmt|,
modifier|*
name|wevent
decl_stmt|;
name|sevent
operator|=
operator|(
name|sevent_t
operator|*
operator|)
name|event
expr_stmt|;
name|node
operator|=
name|sevent
operator|->
name|node
expr_stmt|;
name|fname
operator|=
name|sevent
operator|->
name|fname
expr_stmt|;
name|isc_event_free
argument_list|(
operator|&
name|event
argument_list|)
expr_stmt|;
name|signname
argument_list|(
name|node
argument_list|,
name|dns_fixedname_name
argument_list|(
name|fname
argument_list|)
argument_list|)
expr_stmt|;
name|wevent
operator|=
operator|(
name|sevent_t
operator|*
operator|)
name|isc_event_allocate
argument_list|(
name|mctx
argument_list|,
name|task
argument_list|,
name|SIGNER_EVENT_WRITE
argument_list|,
name|writenode
argument_list|,
name|NULL
argument_list|,
sizeof|sizeof
argument_list|(
name|sevent_t
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|wevent
operator|==
name|NULL
condition|)
name|fatal
argument_list|(
literal|"failed to allocate event\n"
argument_list|)
expr_stmt|;
name|wevent
operator|->
name|node
operator|=
name|node
expr_stmt|;
name|wevent
operator|->
name|fname
operator|=
name|fname
expr_stmt|;
name|isc_task_send
argument_list|(
name|master
argument_list|,
name|ISC_EVENT_PTR
argument_list|(
operator|&
name|wevent
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*%  * Update / remove the DS RRset.  Preserve RRSIG(DS) if possible.  */
end_comment

begin_function
specifier|static
name|void
name|add_ds
parameter_list|(
name|dns_name_t
modifier|*
name|name
parameter_list|,
name|dns_dbnode_t
modifier|*
name|node
parameter_list|,
name|isc_uint32_t
name|nsttl
parameter_list|)
block|{
name|dns_rdataset_t
name|dsset
decl_stmt|;
name|dns_rdataset_t
name|sigdsset
decl_stmt|;
name|isc_result_t
name|result
decl_stmt|;
name|dns_rdataset_init
argument_list|(
operator|&
name|dsset
argument_list|)
expr_stmt|;
name|dns_rdataset_init
argument_list|(
operator|&
name|sigdsset
argument_list|)
expr_stmt|;
name|result
operator|=
name|dns_db_findrdataset
argument_list|(
name|gdb
argument_list|,
name|node
argument_list|,
name|gversion
argument_list|,
name|dns_rdatatype_ds
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
operator|&
name|dsset
argument_list|,
operator|&
name|sigdsset
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|==
name|ISC_R_SUCCESS
condition|)
block|{
name|dns_rdataset_disassociate
argument_list|(
operator|&
name|dsset
argument_list|)
expr_stmt|;
name|result
operator|=
name|dns_db_deleterdataset
argument_list|(
name|gdb
argument_list|,
name|node
argument_list|,
name|gversion
argument_list|,
name|dns_rdatatype_ds
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|check_result
argument_list|(
name|result
argument_list|,
literal|"dns_db_deleterdataset"
argument_list|)
expr_stmt|;
block|}
name|result
operator|=
name|loadds
argument_list|(
name|name
argument_list|,
name|nsttl
argument_list|,
operator|&
name|dsset
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|==
name|ISC_R_SUCCESS
condition|)
block|{
name|result
operator|=
name|dns_db_addrdataset
argument_list|(
name|gdb
argument_list|,
name|node
argument_list|,
name|gversion
argument_list|,
literal|0
argument_list|,
operator|&
name|dsset
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|check_result
argument_list|(
name|result
argument_list|,
literal|"dns_db_addrdataset"
argument_list|)
expr_stmt|;
name|dns_rdataset_disassociate
argument_list|(
operator|&
name|dsset
argument_list|)
expr_stmt|;
if|if
condition|(
name|dns_rdataset_isassociated
argument_list|(
operator|&
name|sigdsset
argument_list|)
condition|)
name|dns_rdataset_disassociate
argument_list|(
operator|&
name|sigdsset
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|dns_rdataset_isassociated
argument_list|(
operator|&
name|sigdsset
argument_list|)
condition|)
block|{
name|result
operator|=
name|dns_db_deleterdataset
argument_list|(
name|gdb
argument_list|,
name|node
argument_list|,
name|gversion
argument_list|,
name|dns_rdatatype_rrsig
argument_list|,
name|dns_rdatatype_ds
argument_list|)
expr_stmt|;
name|check_result
argument_list|(
name|result
argument_list|,
literal|"dns_db_deleterdataset"
argument_list|)
expr_stmt|;
name|dns_rdataset_disassociate
argument_list|(
operator|&
name|sigdsset
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/*  * Remove records of the given type and their signatures.  */
end_comment

begin_function
specifier|static
name|void
name|remove_records
parameter_list|(
name|dns_dbnode_t
modifier|*
name|node
parameter_list|,
name|dns_rdatatype_t
name|which
parameter_list|)
block|{
name|isc_result_t
name|result
decl_stmt|;
name|dns_rdatatype_t
name|type
decl_stmt|,
name|covers
decl_stmt|;
name|dns_rdatasetiter_t
modifier|*
name|rdsiter
init|=
name|NULL
decl_stmt|;
name|dns_rdataset_t
name|rdataset
decl_stmt|;
name|dns_rdataset_init
argument_list|(
operator|&
name|rdataset
argument_list|)
expr_stmt|;
comment|/* 	 * Delete any records of the given type at the apex. 	 */
name|result
operator|=
name|dns_db_allrdatasets
argument_list|(
name|gdb
argument_list|,
name|node
argument_list|,
name|gversion
argument_list|,
literal|0
argument_list|,
operator|&
name|rdsiter
argument_list|)
expr_stmt|;
name|check_result
argument_list|(
name|result
argument_list|,
literal|"dns_db_allrdatasets()"
argument_list|)
expr_stmt|;
for|for
control|(
name|result
operator|=
name|dns_rdatasetiter_first
argument_list|(
name|rdsiter
argument_list|)
init|;
name|result
operator|==
name|ISC_R_SUCCESS
condition|;
name|result
operator|=
name|dns_rdatasetiter_next
argument_list|(
name|rdsiter
argument_list|)
control|)
block|{
name|dns_rdatasetiter_current
argument_list|(
name|rdsiter
argument_list|,
operator|&
name|rdataset
argument_list|)
expr_stmt|;
name|type
operator|=
name|rdataset
operator|.
name|type
expr_stmt|;
name|covers
operator|=
name|rdataset
operator|.
name|covers
expr_stmt|;
name|dns_rdataset_disassociate
argument_list|(
operator|&
name|rdataset
argument_list|)
expr_stmt|;
if|if
condition|(
name|type
operator|==
name|which
operator|||
name|covers
operator|==
name|which
condition|)
block|{
if|if
condition|(
name|which
operator|==
name|dns_rdatatype_nsec
operator|&&
operator|!
name|update_chain
condition|)
name|fatal
argument_list|(
literal|"Zone contains NSEC records.  Use -u "
literal|"to update to NSEC3."
argument_list|)
expr_stmt|;
if|if
condition|(
name|which
operator|==
name|dns_rdatatype_nsec3param
operator|&&
operator|!
name|update_chain
condition|)
name|fatal
argument_list|(
literal|"Zone contains NSEC3 chains.  Use -u "
literal|"to update to NSEC."
argument_list|)
expr_stmt|;
name|result
operator|=
name|dns_db_deleterdataset
argument_list|(
name|gdb
argument_list|,
name|node
argument_list|,
name|gversion
argument_list|,
name|type
argument_list|,
name|covers
argument_list|)
expr_stmt|;
name|check_result
argument_list|(
name|result
argument_list|,
literal|"dns_db_deleterdataset()"
argument_list|)
expr_stmt|;
continue|continue;
block|}
block|}
name|dns_rdatasetiter_destroy
argument_list|(
operator|&
name|rdsiter
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*%  * Generate NSEC records for the zone and remove NSEC3/NSEC3PARAM records.  */
end_comment

begin_function
specifier|static
name|void
name|nsecify
parameter_list|(
name|void
parameter_list|)
block|{
name|dns_dbiterator_t
modifier|*
name|dbiter
init|=
name|NULL
decl_stmt|;
name|dns_dbnode_t
modifier|*
name|node
init|=
name|NULL
decl_stmt|,
modifier|*
name|nextnode
init|=
name|NULL
decl_stmt|;
name|dns_fixedname_t
name|fname
decl_stmt|,
name|fnextname
decl_stmt|,
name|fzonecut
decl_stmt|;
name|dns_name_t
modifier|*
name|name
decl_stmt|,
modifier|*
name|nextname
decl_stmt|,
modifier|*
name|zonecut
decl_stmt|;
name|dns_rdataset_t
name|rdataset
decl_stmt|;
name|dns_rdatasetiter_t
modifier|*
name|rdsiter
init|=
name|NULL
decl_stmt|;
name|dns_rdatatype_t
name|type
decl_stmt|,
name|covers
decl_stmt|;
name|isc_boolean_t
name|done
init|=
name|ISC_FALSE
decl_stmt|;
name|isc_result_t
name|result
decl_stmt|;
name|isc_uint32_t
name|nsttl
init|=
literal|0
decl_stmt|;
name|dns_rdataset_init
argument_list|(
operator|&
name|rdataset
argument_list|)
expr_stmt|;
name|dns_fixedname_init
argument_list|(
operator|&
name|fname
argument_list|)
expr_stmt|;
name|name
operator|=
name|dns_fixedname_name
argument_list|(
operator|&
name|fname
argument_list|)
expr_stmt|;
name|dns_fixedname_init
argument_list|(
operator|&
name|fnextname
argument_list|)
expr_stmt|;
name|nextname
operator|=
name|dns_fixedname_name
argument_list|(
operator|&
name|fnextname
argument_list|)
expr_stmt|;
name|dns_fixedname_init
argument_list|(
operator|&
name|fzonecut
argument_list|)
expr_stmt|;
name|zonecut
operator|=
name|NULL
expr_stmt|;
comment|/* 	 * Remove any NSEC3 chains. 	 */
name|result
operator|=
name|dns_db_createiterator
argument_list|(
name|gdb
argument_list|,
name|DNS_DB_NSEC3ONLY
argument_list|,
operator|&
name|dbiter
argument_list|)
expr_stmt|;
name|check_result
argument_list|(
name|result
argument_list|,
literal|"dns_db_createiterator()"
argument_list|)
expr_stmt|;
for|for
control|(
name|result
operator|=
name|dns_dbiterator_first
argument_list|(
name|dbiter
argument_list|)
init|;
name|result
operator|==
name|ISC_R_SUCCESS
condition|;
name|result
operator|=
name|dns_dbiterator_next
argument_list|(
name|dbiter
argument_list|)
control|)
block|{
name|result
operator|=
name|dns_dbiterator_current
argument_list|(
name|dbiter
argument_list|,
operator|&
name|node
argument_list|,
name|name
argument_list|)
expr_stmt|;
name|check_dns_dbiterator_current
argument_list|(
name|result
argument_list|)
expr_stmt|;
name|result
operator|=
name|dns_db_allrdatasets
argument_list|(
name|gdb
argument_list|,
name|node
argument_list|,
name|gversion
argument_list|,
literal|0
argument_list|,
operator|&
name|rdsiter
argument_list|)
expr_stmt|;
name|check_result
argument_list|(
name|result
argument_list|,
literal|"dns_db_allrdatasets()"
argument_list|)
expr_stmt|;
for|for
control|(
name|result
operator|=
name|dns_rdatasetiter_first
argument_list|(
name|rdsiter
argument_list|)
init|;
name|result
operator|==
name|ISC_R_SUCCESS
condition|;
name|result
operator|=
name|dns_rdatasetiter_next
argument_list|(
name|rdsiter
argument_list|)
control|)
block|{
name|dns_rdatasetiter_current
argument_list|(
name|rdsiter
argument_list|,
operator|&
name|rdataset
argument_list|)
expr_stmt|;
name|type
operator|=
name|rdataset
operator|.
name|type
expr_stmt|;
name|covers
operator|=
name|rdataset
operator|.
name|covers
expr_stmt|;
name|dns_rdataset_disassociate
argument_list|(
operator|&
name|rdataset
argument_list|)
expr_stmt|;
name|result
operator|=
name|dns_db_deleterdataset
argument_list|(
name|gdb
argument_list|,
name|node
argument_list|,
name|gversion
argument_list|,
name|type
argument_list|,
name|covers
argument_list|)
expr_stmt|;
name|check_result
argument_list|(
name|result
argument_list|,
literal|"dns_db_deleterdataset(nsec3param/rrsig)"
argument_list|)
expr_stmt|;
block|}
name|dns_rdatasetiter_destroy
argument_list|(
operator|&
name|rdsiter
argument_list|)
expr_stmt|;
name|dns_db_detachnode
argument_list|(
name|gdb
argument_list|,
operator|&
name|node
argument_list|)
expr_stmt|;
block|}
name|dns_dbiterator_destroy
argument_list|(
operator|&
name|dbiter
argument_list|)
expr_stmt|;
name|result
operator|=
name|dns_db_createiterator
argument_list|(
name|gdb
argument_list|,
name|DNS_DB_NONSEC3
argument_list|,
operator|&
name|dbiter
argument_list|)
expr_stmt|;
name|check_result
argument_list|(
name|result
argument_list|,
literal|"dns_db_createiterator()"
argument_list|)
expr_stmt|;
name|result
operator|=
name|dns_dbiterator_first
argument_list|(
name|dbiter
argument_list|)
expr_stmt|;
name|check_result
argument_list|(
name|result
argument_list|,
literal|"dns_dbiterator_first()"
argument_list|)
expr_stmt|;
while|while
condition|(
operator|!
name|done
condition|)
block|{
name|result
operator|=
name|dns_dbiterator_current
argument_list|(
name|dbiter
argument_list|,
operator|&
name|node
argument_list|,
name|name
argument_list|)
expr_stmt|;
name|check_dns_dbiterator_current
argument_list|(
name|result
argument_list|)
expr_stmt|;
comment|/* 		 * Skip out-of-zone records. 		 */
if|if
condition|(
operator|!
name|dns_name_issubdomain
argument_list|(
name|name
argument_list|,
name|gorigin
argument_list|)
condition|)
block|{
name|result
operator|=
name|dns_dbiterator_next
argument_list|(
name|dbiter
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|==
name|ISC_R_NOMORE
condition|)
name|done
operator|=
name|ISC_TRUE
expr_stmt|;
else|else
name|check_result
argument_list|(
name|result
argument_list|,
literal|"dns_dbiterator_next()"
argument_list|)
expr_stmt|;
name|dns_db_detachnode
argument_list|(
name|gdb
argument_list|,
operator|&
name|node
argument_list|)
expr_stmt|;
continue|continue;
block|}
if|if
condition|(
name|dns_name_equal
argument_list|(
name|name
argument_list|,
name|gorigin
argument_list|)
condition|)
name|remove_records
argument_list|(
name|node
argument_list|,
name|dns_rdatatype_nsec3param
argument_list|)
expr_stmt|;
if|if
condition|(
name|delegation
argument_list|(
name|name
argument_list|,
name|node
argument_list|,
operator|&
name|nsttl
argument_list|)
condition|)
block|{
name|zonecut
operator|=
name|dns_fixedname_name
argument_list|(
operator|&
name|fzonecut
argument_list|)
expr_stmt|;
name|dns_name_copy
argument_list|(
name|name
argument_list|,
name|zonecut
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|generateds
condition|)
name|add_ds
argument_list|(
name|name
argument_list|,
name|node
argument_list|,
name|nsttl
argument_list|)
expr_stmt|;
block|}
name|result
operator|=
name|dns_dbiterator_next
argument_list|(
name|dbiter
argument_list|)
expr_stmt|;
name|nextnode
operator|=
name|NULL
expr_stmt|;
while|while
condition|(
name|result
operator|==
name|ISC_R_SUCCESS
condition|)
block|{
name|isc_boolean_t
name|active
init|=
name|ISC_FALSE
decl_stmt|;
name|result
operator|=
name|dns_dbiterator_current
argument_list|(
name|dbiter
argument_list|,
operator|&
name|nextnode
argument_list|,
name|nextname
argument_list|)
expr_stmt|;
name|check_dns_dbiterator_current
argument_list|(
name|result
argument_list|)
expr_stmt|;
name|active
operator|=
name|active_node
argument_list|(
name|nextnode
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|active
condition|)
block|{
name|dns_db_detachnode
argument_list|(
name|gdb
argument_list|,
operator|&
name|nextnode
argument_list|)
expr_stmt|;
name|result
operator|=
name|dns_dbiterator_next
argument_list|(
name|dbiter
argument_list|)
expr_stmt|;
continue|continue;
block|}
if|if
condition|(
operator|!
name|dns_name_issubdomain
argument_list|(
name|nextname
argument_list|,
name|gorigin
argument_list|)
operator|||
operator|(
name|zonecut
operator|!=
name|NULL
operator|&&
name|dns_name_issubdomain
argument_list|(
name|nextname
argument_list|,
name|zonecut
argument_list|)
operator|)
condition|)
block|{
name|dns_db_detachnode
argument_list|(
name|gdb
argument_list|,
operator|&
name|nextnode
argument_list|)
expr_stmt|;
name|result
operator|=
name|dns_dbiterator_next
argument_list|(
name|dbiter
argument_list|)
expr_stmt|;
continue|continue;
block|}
name|dns_db_detachnode
argument_list|(
name|gdb
argument_list|,
operator|&
name|nextnode
argument_list|)
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|result
operator|==
name|ISC_R_NOMORE
condition|)
block|{
name|dns_name_clone
argument_list|(
name|gorigin
argument_list|,
name|nextname
argument_list|)
expr_stmt|;
name|done
operator|=
name|ISC_TRUE
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
name|fatal
argument_list|(
literal|"iterating through the database failed: %s"
argument_list|,
name|isc_result_totext
argument_list|(
name|result
argument_list|)
argument_list|)
expr_stmt|;
name|dns_dbiterator_pause
argument_list|(
name|dbiter
argument_list|)
expr_stmt|;
name|result
operator|=
name|dns_nsec_build
argument_list|(
name|gdb
argument_list|,
name|gversion
argument_list|,
name|node
argument_list|,
name|nextname
argument_list|,
name|zone_soa_min_ttl
argument_list|)
expr_stmt|;
name|check_result
argument_list|(
name|result
argument_list|,
literal|"dns_nsec_build()"
argument_list|)
expr_stmt|;
name|dns_db_detachnode
argument_list|(
name|gdb
argument_list|,
operator|&
name|node
argument_list|)
expr_stmt|;
block|}
name|dns_dbiterator_destroy
argument_list|(
operator|&
name|dbiter
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|addnsec3param
parameter_list|(
specifier|const
name|unsigned
name|char
modifier|*
name|salt
parameter_list|,
name|size_t
name|salt_length
parameter_list|,
name|unsigned
name|int
name|iterations
parameter_list|)
block|{
name|dns_dbnode_t
modifier|*
name|node
init|=
name|NULL
decl_stmt|;
name|dns_rdata_nsec3param_t
name|nsec3param
decl_stmt|;
name|unsigned
name|char
name|nsec3parambuf
index|[
literal|5
operator|+
literal|255
index|]
decl_stmt|;
name|dns_rdatalist_t
name|rdatalist
decl_stmt|;
name|dns_rdataset_t
name|rdataset
decl_stmt|;
name|dns_rdata_t
name|rdata
init|=
name|DNS_RDATA_INIT
decl_stmt|;
name|isc_buffer_t
name|b
decl_stmt|;
name|isc_result_t
name|result
decl_stmt|;
name|dns_rdataset_init
argument_list|(
operator|&
name|rdataset
argument_list|)
expr_stmt|;
name|nsec3param
operator|.
name|common
operator|.
name|rdclass
operator|=
name|gclass
expr_stmt|;
name|nsec3param
operator|.
name|common
operator|.
name|rdtype
operator|=
name|dns_rdatatype_nsec3param
expr_stmt|;
name|ISC_LINK_INIT
argument_list|(
operator|&
name|nsec3param
operator|.
name|common
argument_list|,
name|link
argument_list|)
expr_stmt|;
name|nsec3param
operator|.
name|mctx
operator|=
name|NULL
expr_stmt|;
name|nsec3param
operator|.
name|flags
operator|=
literal|0
expr_stmt|;
name|nsec3param
operator|.
name|hash
operator|=
name|unknownalg
condition|?
name|DNS_NSEC3_UNKNOWNALG
else|:
name|dns_hash_sha1
expr_stmt|;
name|nsec3param
operator|.
name|iterations
operator|=
name|iterations
expr_stmt|;
name|nsec3param
operator|.
name|salt_length
operator|=
name|salt_length
expr_stmt|;
name|DE_CONST
argument_list|(
name|salt
argument_list|,
name|nsec3param
operator|.
name|salt
argument_list|)
expr_stmt|;
name|isc_buffer_init
argument_list|(
operator|&
name|b
argument_list|,
name|nsec3parambuf
argument_list|,
sizeof|sizeof
argument_list|(
name|nsec3parambuf
argument_list|)
argument_list|)
expr_stmt|;
name|result
operator|=
name|dns_rdata_fromstruct
argument_list|(
operator|&
name|rdata
argument_list|,
name|gclass
argument_list|,
name|dns_rdatatype_nsec3param
argument_list|,
operator|&
name|nsec3param
argument_list|,
operator|&
name|b
argument_list|)
expr_stmt|;
name|rdatalist
operator|.
name|rdclass
operator|=
name|rdata
operator|.
name|rdclass
expr_stmt|;
name|rdatalist
operator|.
name|type
operator|=
name|rdata
operator|.
name|type
expr_stmt|;
name|rdatalist
operator|.
name|covers
operator|=
literal|0
expr_stmt|;
name|rdatalist
operator|.
name|ttl
operator|=
literal|0
expr_stmt|;
name|ISC_LIST_INIT
argument_list|(
name|rdatalist
operator|.
name|rdata
argument_list|)
expr_stmt|;
name|ISC_LIST_APPEND
argument_list|(
name|rdatalist
operator|.
name|rdata
argument_list|,
operator|&
name|rdata
argument_list|,
name|link
argument_list|)
expr_stmt|;
name|result
operator|=
name|dns_rdatalist_tordataset
argument_list|(
operator|&
name|rdatalist
argument_list|,
operator|&
name|rdataset
argument_list|)
expr_stmt|;
name|check_result
argument_list|(
name|result
argument_list|,
literal|"dns_rdatalist_tordataset()"
argument_list|)
expr_stmt|;
name|result
operator|=
name|dns_db_findnode
argument_list|(
name|gdb
argument_list|,
name|gorigin
argument_list|,
name|ISC_TRUE
argument_list|,
operator|&
name|node
argument_list|)
expr_stmt|;
name|check_result
argument_list|(
name|result
argument_list|,
literal|"dns_db_find(gorigin)"
argument_list|)
expr_stmt|;
comment|/* 	 * Delete any current NSEC3PARAM records. 	 */
name|result
operator|=
name|dns_db_deleterdataset
argument_list|(
name|gdb
argument_list|,
name|node
argument_list|,
name|gversion
argument_list|,
name|dns_rdatatype_nsec3param
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|==
name|DNS_R_UNCHANGED
condition|)
name|result
operator|=
name|ISC_R_SUCCESS
expr_stmt|;
name|check_result
argument_list|(
name|result
argument_list|,
literal|"dddnsec3param: dns_db_deleterdataset()"
argument_list|)
expr_stmt|;
name|result
operator|=
name|dns_db_addrdataset
argument_list|(
name|gdb
argument_list|,
name|node
argument_list|,
name|gversion
argument_list|,
literal|0
argument_list|,
operator|&
name|rdataset
argument_list|,
name|DNS_DBADD_MERGE
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|==
name|DNS_R_UNCHANGED
condition|)
name|result
operator|=
name|ISC_R_SUCCESS
expr_stmt|;
name|check_result
argument_list|(
name|result
argument_list|,
literal|"addnsec3param: dns_db_addrdataset()"
argument_list|)
expr_stmt|;
name|dns_db_detachnode
argument_list|(
name|gdb
argument_list|,
operator|&
name|node
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|addnsec3
parameter_list|(
name|dns_name_t
modifier|*
name|name
parameter_list|,
name|dns_dbnode_t
modifier|*
name|node
parameter_list|,
specifier|const
name|unsigned
name|char
modifier|*
name|salt
parameter_list|,
name|size_t
name|salt_length
parameter_list|,
name|unsigned
name|int
name|iterations
parameter_list|,
name|hashlist_t
modifier|*
name|hashlist
parameter_list|,
name|dns_ttl_t
name|ttl
parameter_list|)
block|{
name|unsigned
name|char
name|hash
index|[
name|NSEC3_MAX_HASH_LENGTH
index|]
decl_stmt|;
specifier|const
name|unsigned
name|char
modifier|*
name|nexthash
decl_stmt|;
name|unsigned
name|char
name|nsec3buffer
index|[
name|DNS_NSEC3_BUFFERSIZE
index|]
decl_stmt|;
name|dns_fixedname_t
name|hashname
decl_stmt|;
name|dns_rdatalist_t
name|rdatalist
decl_stmt|;
name|dns_rdataset_t
name|rdataset
decl_stmt|;
name|dns_rdata_t
name|rdata
init|=
name|DNS_RDATA_INIT
decl_stmt|;
name|isc_result_t
name|result
decl_stmt|;
name|dns_dbnode_t
modifier|*
name|nsec3node
init|=
name|NULL
decl_stmt|;
name|char
name|namebuf
index|[
name|DNS_NAME_FORMATSIZE
index|]
decl_stmt|;
name|size_t
name|hash_length
decl_stmt|;
name|dns_name_format
argument_list|(
name|name
argument_list|,
name|namebuf
argument_list|,
sizeof|sizeof
argument_list|(
name|namebuf
argument_list|)
argument_list|)
expr_stmt|;
name|dns_fixedname_init
argument_list|(
operator|&
name|hashname
argument_list|)
expr_stmt|;
name|dns_rdataset_init
argument_list|(
operator|&
name|rdataset
argument_list|)
expr_stmt|;
name|dns_name_downcase
argument_list|(
name|name
argument_list|,
name|name
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|result
operator|=
name|dns_nsec3_hashname
argument_list|(
operator|&
name|hashname
argument_list|,
name|hash
argument_list|,
operator|&
name|hash_length
argument_list|,
name|name
argument_list|,
name|gorigin
argument_list|,
name|dns_hash_sha1
argument_list|,
name|iterations
argument_list|,
name|salt
argument_list|,
name|salt_length
argument_list|)
expr_stmt|;
name|check_result
argument_list|(
name|result
argument_list|,
literal|"addnsec3: dns_nsec3_hashname()"
argument_list|)
expr_stmt|;
name|nexthash
operator|=
name|hashlist_findnext
argument_list|(
name|hashlist
argument_list|,
name|hash
argument_list|)
expr_stmt|;
name|result
operator|=
name|dns_nsec3_buildrdata
argument_list|(
name|gdb
argument_list|,
name|gversion
argument_list|,
name|node
argument_list|,
name|unknownalg
condition|?
name|DNS_NSEC3_UNKNOWNALG
else|:
name|dns_hash_sha1
argument_list|,
name|nsec3flags
argument_list|,
name|iterations
argument_list|,
name|salt
argument_list|,
name|salt_length
argument_list|,
name|nexthash
argument_list|,
name|ISC_SHA1_DIGESTLENGTH
argument_list|,
name|nsec3buffer
argument_list|,
operator|&
name|rdata
argument_list|)
expr_stmt|;
name|check_result
argument_list|(
name|result
argument_list|,
literal|"addnsec3: dns_nsec3_buildrdata()"
argument_list|)
expr_stmt|;
name|rdatalist
operator|.
name|rdclass
operator|=
name|rdata
operator|.
name|rdclass
expr_stmt|;
name|rdatalist
operator|.
name|type
operator|=
name|rdata
operator|.
name|type
expr_stmt|;
name|rdatalist
operator|.
name|covers
operator|=
literal|0
expr_stmt|;
name|rdatalist
operator|.
name|ttl
operator|=
name|ttl
expr_stmt|;
name|ISC_LIST_INIT
argument_list|(
name|rdatalist
operator|.
name|rdata
argument_list|)
expr_stmt|;
name|ISC_LIST_APPEND
argument_list|(
name|rdatalist
operator|.
name|rdata
argument_list|,
operator|&
name|rdata
argument_list|,
name|link
argument_list|)
expr_stmt|;
name|result
operator|=
name|dns_rdatalist_tordataset
argument_list|(
operator|&
name|rdatalist
argument_list|,
operator|&
name|rdataset
argument_list|)
expr_stmt|;
name|check_result
argument_list|(
name|result
argument_list|,
literal|"dns_rdatalist_tordataset()"
argument_list|)
expr_stmt|;
name|result
operator|=
name|dns_db_findnsec3node
argument_list|(
name|gdb
argument_list|,
name|dns_fixedname_name
argument_list|(
operator|&
name|hashname
argument_list|)
argument_list|,
name|ISC_TRUE
argument_list|,
operator|&
name|nsec3node
argument_list|)
expr_stmt|;
name|check_result
argument_list|(
name|result
argument_list|,
literal|"addnsec3: dns_db_findnode()"
argument_list|)
expr_stmt|;
name|result
operator|=
name|dns_db_addrdataset
argument_list|(
name|gdb
argument_list|,
name|nsec3node
argument_list|,
name|gversion
argument_list|,
literal|0
argument_list|,
operator|&
name|rdataset
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|==
name|DNS_R_UNCHANGED
condition|)
name|result
operator|=
name|ISC_R_SUCCESS
expr_stmt|;
name|check_result
argument_list|(
name|result
argument_list|,
literal|"addnsec3: dns_db_addrdataset()"
argument_list|)
expr_stmt|;
name|dns_db_detachnode
argument_list|(
name|gdb
argument_list|,
operator|&
name|nsec3node
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*%  * Clean out NSEC3 record and RRSIG(NSEC3) that are not in the hash list.  *  * Extract the hash from the first label of 'name' then see if it  * is in hashlist.  If 'name' is not in the hashlist then delete the  * any NSEC3 records which have the same parameters as the chain we  * are building.  *  * XXXMPA Should we also check that it of the form<hash>.<origin>?  */
end_comment

begin_function
specifier|static
name|void
name|nsec3clean
parameter_list|(
name|dns_name_t
modifier|*
name|name
parameter_list|,
name|dns_dbnode_t
modifier|*
name|node
parameter_list|,
name|unsigned
name|int
name|hashalg
parameter_list|,
name|unsigned
name|int
name|iterations
parameter_list|,
specifier|const
name|unsigned
name|char
modifier|*
name|salt
parameter_list|,
name|size_t
name|salt_length
parameter_list|,
name|hashlist_t
modifier|*
name|hashlist
parameter_list|)
block|{
name|dns_label_t
name|label
decl_stmt|;
name|dns_rdata_nsec3_t
name|nsec3
decl_stmt|;
name|dns_rdata_t
name|rdata
decl_stmt|,
name|delrdata
decl_stmt|;
name|dns_rdatalist_t
name|rdatalist
decl_stmt|;
name|dns_rdataset_t
name|rdataset
decl_stmt|,
name|delrdataset
decl_stmt|;
name|isc_boolean_t
name|delete_rrsigs
init|=
name|ISC_FALSE
decl_stmt|;
name|isc_buffer_t
name|target
decl_stmt|;
name|isc_result_t
name|result
decl_stmt|;
name|unsigned
name|char
name|hash
index|[
name|NSEC3_MAX_HASH_LENGTH
operator|+
literal|1
index|]
decl_stmt|;
name|isc_boolean_t
name|exists
decl_stmt|;
comment|/* 	 * Get the first label. 	 */
name|dns_name_getlabel
argument_list|(
name|name
argument_list|,
literal|0
argument_list|,
operator|&
name|label
argument_list|)
expr_stmt|;
comment|/* 	 * We want just the label contents. 	 */
name|isc_region_consume
argument_list|(
operator|&
name|label
argument_list|,
literal|1
argument_list|)
expr_stmt|;
comment|/* 	 * Decode base32hex string. 	 */
name|isc_buffer_init
argument_list|(
operator|&
name|target
argument_list|,
name|hash
argument_list|,
sizeof|sizeof
argument_list|(
name|hash
argument_list|)
operator|-
literal|1
argument_list|)
expr_stmt|;
name|result
operator|=
name|isc_base32hex_decoderegion
argument_list|(
operator|&
name|label
argument_list|,
operator|&
name|target
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
return|return;
name|hash
index|[
name|isc_buffer_usedlength
argument_list|(
operator|&
name|target
argument_list|)
index|]
operator|=
literal|0
expr_stmt|;
name|exists
operator|=
name|hashlist_exists
argument_list|(
name|hashlist
argument_list|,
name|hash
argument_list|)
expr_stmt|;
comment|/* 	 * Verify that the NSEC3 parameters match the current ones 	 * otherwise we are dealing with a different NSEC3 chain. 	 */
name|dns_rdataset_init
argument_list|(
operator|&
name|rdataset
argument_list|)
expr_stmt|;
name|dns_rdataset_init
argument_list|(
operator|&
name|delrdataset
argument_list|)
expr_stmt|;
name|result
operator|=
name|dns_db_findrdataset
argument_list|(
name|gdb
argument_list|,
name|node
argument_list|,
name|gversion
argument_list|,
name|dns_rdatatype_nsec3
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
operator|&
name|rdataset
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
return|return;
comment|/* 	 * Delete any NSEC3 records which are not part of the current 	 * NSEC3 chain. 	 */
for|for
control|(
name|result
operator|=
name|dns_rdataset_first
argument_list|(
operator|&
name|rdataset
argument_list|)
init|;
name|result
operator|==
name|ISC_R_SUCCESS
condition|;
name|result
operator|=
name|dns_rdataset_next
argument_list|(
operator|&
name|rdataset
argument_list|)
control|)
block|{
name|dns_rdata_init
argument_list|(
operator|&
name|rdata
argument_list|)
expr_stmt|;
name|dns_rdataset_current
argument_list|(
operator|&
name|rdataset
argument_list|,
operator|&
name|rdata
argument_list|)
expr_stmt|;
name|result
operator|=
name|dns_rdata_tostruct
argument_list|(
operator|&
name|rdata
argument_list|,
operator|&
name|nsec3
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|check_result
argument_list|(
name|result
argument_list|,
literal|"dns_rdata_tostruct"
argument_list|)
expr_stmt|;
if|if
condition|(
name|exists
operator|&&
name|nsec3
operator|.
name|hash
operator|==
name|hashalg
operator|&&
name|nsec3
operator|.
name|iterations
operator|==
name|iterations
operator|&&
name|nsec3
operator|.
name|salt_length
operator|==
name|salt_length
operator|&&
operator|!
name|memcmp
argument_list|(
name|nsec3
operator|.
name|salt
argument_list|,
name|salt
argument_list|,
name|salt_length
argument_list|)
condition|)
continue|continue;
name|rdatalist
operator|.
name|rdclass
operator|=
name|rdata
operator|.
name|rdclass
expr_stmt|;
name|rdatalist
operator|.
name|type
operator|=
name|rdata
operator|.
name|type
expr_stmt|;
name|rdatalist
operator|.
name|covers
operator|=
literal|0
expr_stmt|;
name|rdatalist
operator|.
name|ttl
operator|=
name|rdataset
operator|.
name|ttl
expr_stmt|;
name|ISC_LIST_INIT
argument_list|(
name|rdatalist
operator|.
name|rdata
argument_list|)
expr_stmt|;
name|dns_rdata_init
argument_list|(
operator|&
name|delrdata
argument_list|)
expr_stmt|;
name|dns_rdata_clone
argument_list|(
operator|&
name|rdata
argument_list|,
operator|&
name|delrdata
argument_list|)
expr_stmt|;
name|ISC_LIST_APPEND
argument_list|(
name|rdatalist
operator|.
name|rdata
argument_list|,
operator|&
name|delrdata
argument_list|,
name|link
argument_list|)
expr_stmt|;
name|result
operator|=
name|dns_rdatalist_tordataset
argument_list|(
operator|&
name|rdatalist
argument_list|,
operator|&
name|delrdataset
argument_list|)
expr_stmt|;
name|check_result
argument_list|(
name|result
argument_list|,
literal|"dns_rdatalist_tordataset()"
argument_list|)
expr_stmt|;
name|result
operator|=
name|dns_db_subtractrdataset
argument_list|(
name|gdb
argument_list|,
name|node
argument_list|,
name|gversion
argument_list|,
operator|&
name|delrdataset
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|dns_rdataset_disassociate
argument_list|(
operator|&
name|delrdataset
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
operator|&&
name|result
operator|!=
name|DNS_R_NXRRSET
condition|)
name|check_result
argument_list|(
name|result
argument_list|,
literal|"dns_db_subtractrdataset(NSEC3)"
argument_list|)
expr_stmt|;
name|delete_rrsigs
operator|=
name|ISC_TRUE
expr_stmt|;
block|}
name|dns_rdataset_disassociate
argument_list|(
operator|&
name|rdataset
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_NOMORE
condition|)
name|check_result
argument_list|(
name|result
argument_list|,
literal|"dns_rdataset_first/next"
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|delete_rrsigs
condition|)
return|return;
comment|/* 	 * Delete the NSEC3 RRSIGs 	 */
name|result
operator|=
name|dns_db_deleterdataset
argument_list|(
name|gdb
argument_list|,
name|node
argument_list|,
name|gversion
argument_list|,
name|dns_rdatatype_rrsig
argument_list|,
name|dns_rdatatype_nsec3
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
operator|&&
name|result
operator|!=
name|DNS_R_UNCHANGED
condition|)
name|check_result
argument_list|(
name|result
argument_list|,
literal|"dns_db_deleterdataset(RRSIG(NSEC3))"
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|rrset_remove_duplicates
parameter_list|(
name|dns_name_t
modifier|*
name|name
parameter_list|,
name|dns_rdataset_t
modifier|*
name|rdataset
parameter_list|,
name|dns_diff_t
modifier|*
name|diff
parameter_list|)
block|{
name|dns_difftuple_t
modifier|*
name|tuple
init|=
name|NULL
decl_stmt|;
name|isc_result_t
name|result
decl_stmt|;
name|unsigned
name|int
name|count1
init|=
literal|0
decl_stmt|;
name|dns_rdataset_t
name|tmprdataset
decl_stmt|;
name|dns_rdataset_init
argument_list|(
operator|&
name|tmprdataset
argument_list|)
expr_stmt|;
for|for
control|(
name|result
operator|=
name|dns_rdataset_first
argument_list|(
name|rdataset
argument_list|)
init|;
name|result
operator|==
name|ISC_R_SUCCESS
condition|;
name|result
operator|=
name|dns_rdataset_next
argument_list|(
name|rdataset
argument_list|)
control|)
block|{
name|dns_rdata_t
name|rdata1
init|=
name|DNS_RDATA_INIT
decl_stmt|;
name|unsigned
name|int
name|count2
init|=
literal|0
decl_stmt|;
name|count1
operator|++
expr_stmt|;
name|dns_rdataset_current
argument_list|(
name|rdataset
argument_list|,
operator|&
name|rdata1
argument_list|)
expr_stmt|;
name|dns_rdataset_clone
argument_list|(
name|rdataset
argument_list|,
operator|&
name|tmprdataset
argument_list|)
expr_stmt|;
for|for
control|(
name|result
operator|=
name|dns_rdataset_first
argument_list|(
operator|&
name|tmprdataset
argument_list|)
init|;
name|result
operator|==
name|ISC_R_SUCCESS
condition|;
name|result
operator|=
name|dns_rdataset_next
argument_list|(
operator|&
name|tmprdataset
argument_list|)
control|)
block|{
name|dns_rdata_t
name|rdata2
init|=
name|DNS_RDATA_INIT
decl_stmt|;
name|count2
operator|++
expr_stmt|;
if|if
condition|(
name|count1
operator|>=
name|count2
condition|)
continue|continue;
name|dns_rdataset_current
argument_list|(
operator|&
name|tmprdataset
argument_list|,
operator|&
name|rdata2
argument_list|)
expr_stmt|;
if|if
condition|(
name|dns_rdata_casecompare
argument_list|(
operator|&
name|rdata1
argument_list|,
operator|&
name|rdata2
argument_list|)
operator|==
literal|0
condition|)
block|{
name|result
operator|=
name|dns_difftuple_create
argument_list|(
name|mctx
argument_list|,
name|DNS_DIFFOP_DEL
argument_list|,
name|name
argument_list|,
name|rdataset
operator|->
name|ttl
argument_list|,
operator|&
name|rdata2
argument_list|,
operator|&
name|tuple
argument_list|)
expr_stmt|;
name|check_result
argument_list|(
name|result
argument_list|,
literal|"dns_difftuple_create"
argument_list|)
expr_stmt|;
name|dns_diff_append
argument_list|(
name|diff
argument_list|,
operator|&
name|tuple
argument_list|)
expr_stmt|;
block|}
block|}
name|dns_rdataset_disassociate
argument_list|(
operator|&
name|tmprdataset
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|remove_duplicates
parameter_list|(
name|void
parameter_list|)
block|{
name|isc_result_t
name|result
decl_stmt|;
name|dns_dbiterator_t
modifier|*
name|dbiter
init|=
name|NULL
decl_stmt|;
name|dns_rdatasetiter_t
modifier|*
name|rdsiter
init|=
name|NULL
decl_stmt|;
name|dns_diff_t
name|diff
decl_stmt|;
name|dns_dbnode_t
modifier|*
name|node
init|=
name|NULL
decl_stmt|;
name|dns_rdataset_t
name|rdataset
decl_stmt|;
name|dns_fixedname_t
name|fname
decl_stmt|;
name|dns_name_t
modifier|*
name|name
decl_stmt|;
name|dns_diff_init
argument_list|(
name|mctx
argument_list|,
operator|&
name|diff
argument_list|)
expr_stmt|;
name|dns_fixedname_init
argument_list|(
operator|&
name|fname
argument_list|)
expr_stmt|;
name|name
operator|=
name|dns_fixedname_name
argument_list|(
operator|&
name|fname
argument_list|)
expr_stmt|;
name|dns_rdataset_init
argument_list|(
operator|&
name|rdataset
argument_list|)
expr_stmt|;
name|result
operator|=
name|dns_db_createiterator
argument_list|(
name|gdb
argument_list|,
literal|0
argument_list|,
operator|&
name|dbiter
argument_list|)
expr_stmt|;
name|check_result
argument_list|(
name|result
argument_list|,
literal|"dns_db_createiterator()"
argument_list|)
expr_stmt|;
for|for
control|(
name|result
operator|=
name|dns_dbiterator_first
argument_list|(
name|dbiter
argument_list|)
init|;
name|result
operator|==
name|ISC_R_SUCCESS
condition|;
name|result
operator|=
name|dns_dbiterator_next
argument_list|(
name|dbiter
argument_list|)
control|)
block|{
name|result
operator|=
name|dns_dbiterator_current
argument_list|(
name|dbiter
argument_list|,
operator|&
name|node
argument_list|,
name|name
argument_list|)
expr_stmt|;
name|check_dns_dbiterator_current
argument_list|(
name|result
argument_list|)
expr_stmt|;
name|result
operator|=
name|dns_db_allrdatasets
argument_list|(
name|gdb
argument_list|,
name|node
argument_list|,
name|gversion
argument_list|,
literal|0
argument_list|,
operator|&
name|rdsiter
argument_list|)
expr_stmt|;
name|check_result
argument_list|(
name|result
argument_list|,
literal|"dns_db_allrdatasets()"
argument_list|)
expr_stmt|;
for|for
control|(
name|result
operator|=
name|dns_rdatasetiter_first
argument_list|(
name|rdsiter
argument_list|)
init|;
name|result
operator|==
name|ISC_R_SUCCESS
condition|;
name|result
operator|=
name|dns_rdatasetiter_next
argument_list|(
name|rdsiter
argument_list|)
control|)
block|{
name|dns_rdatasetiter_current
argument_list|(
name|rdsiter
argument_list|,
operator|&
name|rdataset
argument_list|)
expr_stmt|;
name|rrset_remove_duplicates
argument_list|(
name|name
argument_list|,
operator|&
name|rdataset
argument_list|,
operator|&
name|diff
argument_list|)
expr_stmt|;
name|dns_rdataset_disassociate
argument_list|(
operator|&
name|rdataset
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|result
operator|!=
name|ISC_R_NOMORE
condition|)
name|fatal
argument_list|(
literal|"rdatasets iteration failed."
argument_list|)
expr_stmt|;
name|dns_rdatasetiter_destroy
argument_list|(
operator|&
name|rdsiter
argument_list|)
expr_stmt|;
name|dns_db_detachnode
argument_list|(
name|gdb
argument_list|,
operator|&
name|node
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|result
operator|!=
name|ISC_R_NOMORE
condition|)
name|fatal
argument_list|(
literal|"zone iteration failed."
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|ISC_LIST_EMPTY
argument_list|(
name|diff
operator|.
name|tuples
argument_list|)
condition|)
block|{
name|result
operator|=
name|dns_diff_applysilently
argument_list|(
operator|&
name|diff
argument_list|,
name|gdb
argument_list|,
name|gversion
argument_list|)
expr_stmt|;
name|check_result
argument_list|(
name|result
argument_list|,
literal|"dns_diff_applysilently"
argument_list|)
expr_stmt|;
block|}
name|dns_diff_clear
argument_list|(
operator|&
name|diff
argument_list|)
expr_stmt|;
name|dns_dbiterator_destroy
argument_list|(
operator|&
name|dbiter
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * Generate NSEC3 records for the zone.  */
end_comment

begin_function
specifier|static
name|void
name|nsec3ify
parameter_list|(
name|unsigned
name|int
name|hashalg
parameter_list|,
name|unsigned
name|int
name|iterations
parameter_list|,
specifier|const
name|unsigned
name|char
modifier|*
name|salt
parameter_list|,
name|size_t
name|salt_length
parameter_list|,
name|hashlist_t
modifier|*
name|hashlist
parameter_list|)
block|{
name|dns_dbiterator_t
modifier|*
name|dbiter
init|=
name|NULL
decl_stmt|;
name|dns_dbnode_t
modifier|*
name|node
init|=
name|NULL
decl_stmt|,
modifier|*
name|nextnode
init|=
name|NULL
decl_stmt|;
name|dns_fixedname_t
name|fname
decl_stmt|,
name|fnextname
decl_stmt|,
name|fzonecut
decl_stmt|;
name|dns_name_t
modifier|*
name|name
decl_stmt|,
modifier|*
name|nextname
decl_stmt|,
modifier|*
name|zonecut
decl_stmt|;
name|dns_rdataset_t
name|rdataset
decl_stmt|;
name|int
name|order
decl_stmt|;
name|isc_boolean_t
name|active
decl_stmt|;
name|isc_boolean_t
name|done
init|=
name|ISC_FALSE
decl_stmt|;
name|isc_result_t
name|result
decl_stmt|;
name|isc_uint32_t
name|nsttl
init|=
literal|0
decl_stmt|;
name|unsigned
name|int
name|count
decl_stmt|,
name|nlabels
decl_stmt|;
name|dns_rdataset_init
argument_list|(
operator|&
name|rdataset
argument_list|)
expr_stmt|;
name|dns_fixedname_init
argument_list|(
operator|&
name|fname
argument_list|)
expr_stmt|;
name|name
operator|=
name|dns_fixedname_name
argument_list|(
operator|&
name|fname
argument_list|)
expr_stmt|;
name|dns_fixedname_init
argument_list|(
operator|&
name|fnextname
argument_list|)
expr_stmt|;
name|nextname
operator|=
name|dns_fixedname_name
argument_list|(
operator|&
name|fnextname
argument_list|)
expr_stmt|;
name|dns_fixedname_init
argument_list|(
operator|&
name|fzonecut
argument_list|)
expr_stmt|;
name|zonecut
operator|=
name|NULL
expr_stmt|;
comment|/* 	 * Walk the zone generating the hash names. 	 */
name|result
operator|=
name|dns_db_createiterator
argument_list|(
name|gdb
argument_list|,
name|DNS_DB_NONSEC3
argument_list|,
operator|&
name|dbiter
argument_list|)
expr_stmt|;
name|check_result
argument_list|(
name|result
argument_list|,
literal|"dns_db_createiterator()"
argument_list|)
expr_stmt|;
name|result
operator|=
name|dns_dbiterator_first
argument_list|(
name|dbiter
argument_list|)
expr_stmt|;
name|check_result
argument_list|(
name|result
argument_list|,
literal|"dns_dbiterator_first()"
argument_list|)
expr_stmt|;
while|while
condition|(
operator|!
name|done
condition|)
block|{
name|result
operator|=
name|dns_dbiterator_current
argument_list|(
name|dbiter
argument_list|,
operator|&
name|node
argument_list|,
name|name
argument_list|)
expr_stmt|;
name|check_dns_dbiterator_current
argument_list|(
name|result
argument_list|)
expr_stmt|;
comment|/* 		 * Skip out-of-zone records. 		 */
if|if
condition|(
operator|!
name|dns_name_issubdomain
argument_list|(
name|name
argument_list|,
name|gorigin
argument_list|)
condition|)
block|{
name|result
operator|=
name|dns_dbiterator_next
argument_list|(
name|dbiter
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|==
name|ISC_R_NOMORE
condition|)
name|done
operator|=
name|ISC_TRUE
expr_stmt|;
else|else
name|check_result
argument_list|(
name|result
argument_list|,
literal|"dns_dbiterator_next()"
argument_list|)
expr_stmt|;
name|dns_db_detachnode
argument_list|(
name|gdb
argument_list|,
operator|&
name|node
argument_list|)
expr_stmt|;
continue|continue;
block|}
if|if
condition|(
name|dns_name_equal
argument_list|(
name|name
argument_list|,
name|gorigin
argument_list|)
condition|)
name|remove_records
argument_list|(
name|node
argument_list|,
name|dns_rdatatype_nsec
argument_list|)
expr_stmt|;
name|result
operator|=
name|dns_dbiterator_next
argument_list|(
name|dbiter
argument_list|)
expr_stmt|;
name|nextnode
operator|=
name|NULL
expr_stmt|;
while|while
condition|(
name|result
operator|==
name|ISC_R_SUCCESS
condition|)
block|{
name|result
operator|=
name|dns_dbiterator_current
argument_list|(
name|dbiter
argument_list|,
operator|&
name|nextnode
argument_list|,
name|nextname
argument_list|)
expr_stmt|;
name|check_dns_dbiterator_current
argument_list|(
name|result
argument_list|)
expr_stmt|;
name|active
operator|=
name|active_node
argument_list|(
name|nextnode
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|active
condition|)
block|{
name|dns_db_detachnode
argument_list|(
name|gdb
argument_list|,
operator|&
name|nextnode
argument_list|)
expr_stmt|;
name|result
operator|=
name|dns_dbiterator_next
argument_list|(
name|dbiter
argument_list|)
expr_stmt|;
continue|continue;
block|}
if|if
condition|(
operator|!
name|dns_name_issubdomain
argument_list|(
name|nextname
argument_list|,
name|gorigin
argument_list|)
operator|||
operator|(
name|zonecut
operator|!=
name|NULL
operator|&&
name|dns_name_issubdomain
argument_list|(
name|nextname
argument_list|,
name|zonecut
argument_list|)
operator|)
condition|)
block|{
name|dns_db_detachnode
argument_list|(
name|gdb
argument_list|,
operator|&
name|nextnode
argument_list|)
expr_stmt|;
name|result
operator|=
name|dns_dbiterator_next
argument_list|(
name|dbiter
argument_list|)
expr_stmt|;
continue|continue;
block|}
if|if
condition|(
name|delegation
argument_list|(
name|nextname
argument_list|,
name|nextnode
argument_list|,
operator|&
name|nsttl
argument_list|)
condition|)
block|{
name|zonecut
operator|=
name|dns_fixedname_name
argument_list|(
operator|&
name|fzonecut
argument_list|)
expr_stmt|;
name|dns_name_copy
argument_list|(
name|nextname
argument_list|,
name|zonecut
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|generateds
condition|)
name|add_ds
argument_list|(
name|nextname
argument_list|,
name|nextnode
argument_list|,
name|nsttl
argument_list|)
expr_stmt|;
if|if
condition|(
name|OPTOUT
argument_list|(
name|nsec3flags
argument_list|)
operator|&&
operator|!
name|secure
argument_list|(
name|nextname
argument_list|,
name|nextnode
argument_list|)
condition|)
block|{
name|dns_db_detachnode
argument_list|(
name|gdb
argument_list|,
operator|&
name|nextnode
argument_list|)
expr_stmt|;
name|result
operator|=
name|dns_dbiterator_next
argument_list|(
name|dbiter
argument_list|)
expr_stmt|;
continue|continue;
block|}
block|}
name|dns_db_detachnode
argument_list|(
name|gdb
argument_list|,
operator|&
name|nextnode
argument_list|)
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|result
operator|==
name|ISC_R_NOMORE
condition|)
block|{
name|dns_name_copy
argument_list|(
name|gorigin
argument_list|,
name|nextname
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|done
operator|=
name|ISC_TRUE
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
name|fatal
argument_list|(
literal|"iterating through the database failed: %s"
argument_list|,
name|isc_result_totext
argument_list|(
name|result
argument_list|)
argument_list|)
expr_stmt|;
name|dns_name_downcase
argument_list|(
name|name
argument_list|,
name|name
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|hashlist_add_dns_name
argument_list|(
name|hashlist
argument_list|,
name|name
argument_list|,
name|hashalg
argument_list|,
name|iterations
argument_list|,
name|salt
argument_list|,
name|salt_length
argument_list|,
name|ISC_FALSE
argument_list|)
expr_stmt|;
name|dns_db_detachnode
argument_list|(
name|gdb
argument_list|,
operator|&
name|node
argument_list|)
expr_stmt|;
comment|/* 		 * Add hashs for empty nodes.  Use closest encloser logic. 		 * The closest encloser either has data or is a empty 		 * node for another<name,nextname> span so we don't add 		 * it here.  Empty labels on nextname are within the span. 		 */
name|dns_name_downcase
argument_list|(
name|nextname
argument_list|,
name|nextname
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|dns_name_fullcompare
argument_list|(
name|name
argument_list|,
name|nextname
argument_list|,
operator|&
name|order
argument_list|,
operator|&
name|nlabels
argument_list|)
expr_stmt|;
name|addnowildcardhash
argument_list|(
name|hashlist
argument_list|,
name|name
argument_list|,
name|hashalg
argument_list|,
name|iterations
argument_list|,
name|salt
argument_list|,
name|salt_length
argument_list|)
expr_stmt|;
name|count
operator|=
name|dns_name_countlabels
argument_list|(
name|nextname
argument_list|)
expr_stmt|;
while|while
condition|(
name|count
operator|>
name|nlabels
operator|+
literal|1
condition|)
block|{
name|count
operator|--
expr_stmt|;
name|dns_name_split
argument_list|(
name|nextname
argument_list|,
name|count
argument_list|,
name|NULL
argument_list|,
name|nextname
argument_list|)
expr_stmt|;
name|hashlist_add_dns_name
argument_list|(
name|hashlist
argument_list|,
name|nextname
argument_list|,
name|hashalg
argument_list|,
name|iterations
argument_list|,
name|salt
argument_list|,
name|salt_length
argument_list|,
name|ISC_FALSE
argument_list|)
expr_stmt|;
name|addnowildcardhash
argument_list|(
name|hashlist
argument_list|,
name|nextname
argument_list|,
name|hashalg
argument_list|,
name|iterations
argument_list|,
name|salt
argument_list|,
name|salt_length
argument_list|)
expr_stmt|;
block|}
block|}
name|dns_dbiterator_destroy
argument_list|(
operator|&
name|dbiter
argument_list|)
expr_stmt|;
comment|/* 	 * We have all the hashes now so we can sort them. 	 */
name|hashlist_sort
argument_list|(
name|hashlist
argument_list|)
expr_stmt|;
comment|/* 	 * Check for duplicate hashes.  If found the salt needs to 	 * be changed. 	 */
if|if
condition|(
name|hashlist_hasdup
argument_list|(
name|hashlist
argument_list|)
condition|)
name|fatal
argument_list|(
literal|"Duplicate hash detected. Pick a different salt."
argument_list|)
expr_stmt|;
comment|/* 	 * Generate the nsec3 records. 	 */
name|zonecut
operator|=
name|NULL
expr_stmt|;
name|done
operator|=
name|ISC_FALSE
expr_stmt|;
name|addnsec3param
argument_list|(
name|salt
argument_list|,
name|salt_length
argument_list|,
name|iterations
argument_list|)
expr_stmt|;
comment|/* 	 * Clean out NSEC3 records which don't match this chain. 	 */
name|result
operator|=
name|dns_db_createiterator
argument_list|(
name|gdb
argument_list|,
name|DNS_DB_NSEC3ONLY
argument_list|,
operator|&
name|dbiter
argument_list|)
expr_stmt|;
name|check_result
argument_list|(
name|result
argument_list|,
literal|"dns_db_createiterator()"
argument_list|)
expr_stmt|;
for|for
control|(
name|result
operator|=
name|dns_dbiterator_first
argument_list|(
name|dbiter
argument_list|)
init|;
name|result
operator|==
name|ISC_R_SUCCESS
condition|;
name|result
operator|=
name|dns_dbiterator_next
argument_list|(
name|dbiter
argument_list|)
control|)
block|{
name|result
operator|=
name|dns_dbiterator_current
argument_list|(
name|dbiter
argument_list|,
operator|&
name|node
argument_list|,
name|name
argument_list|)
expr_stmt|;
name|check_dns_dbiterator_current
argument_list|(
name|result
argument_list|)
expr_stmt|;
name|nsec3clean
argument_list|(
name|name
argument_list|,
name|node
argument_list|,
name|hashalg
argument_list|,
name|iterations
argument_list|,
name|salt
argument_list|,
name|salt_length
argument_list|,
name|hashlist
argument_list|)
expr_stmt|;
name|dns_db_detachnode
argument_list|(
name|gdb
argument_list|,
operator|&
name|node
argument_list|)
expr_stmt|;
block|}
name|dns_dbiterator_destroy
argument_list|(
operator|&
name|dbiter
argument_list|)
expr_stmt|;
comment|/* 	 * Generate / complete the new chain. 	 */
name|result
operator|=
name|dns_db_createiterator
argument_list|(
name|gdb
argument_list|,
name|DNS_DB_NONSEC3
argument_list|,
operator|&
name|dbiter
argument_list|)
expr_stmt|;
name|check_result
argument_list|(
name|result
argument_list|,
literal|"dns_db_createiterator()"
argument_list|)
expr_stmt|;
name|result
operator|=
name|dns_dbiterator_first
argument_list|(
name|dbiter
argument_list|)
expr_stmt|;
name|check_result
argument_list|(
name|result
argument_list|,
literal|"dns_dbiterator_first()"
argument_list|)
expr_stmt|;
while|while
condition|(
operator|!
name|done
condition|)
block|{
name|result
operator|=
name|dns_dbiterator_current
argument_list|(
name|dbiter
argument_list|,
operator|&
name|node
argument_list|,
name|name
argument_list|)
expr_stmt|;
name|check_dns_dbiterator_current
argument_list|(
name|result
argument_list|)
expr_stmt|;
comment|/* 		 * Skip out-of-zone records. 		 */
if|if
condition|(
operator|!
name|dns_name_issubdomain
argument_list|(
name|name
argument_list|,
name|gorigin
argument_list|)
condition|)
block|{
name|result
operator|=
name|dns_dbiterator_next
argument_list|(
name|dbiter
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|==
name|ISC_R_NOMORE
condition|)
name|done
operator|=
name|ISC_TRUE
expr_stmt|;
else|else
name|check_result
argument_list|(
name|result
argument_list|,
literal|"dns_dbiterator_next()"
argument_list|)
expr_stmt|;
name|dns_db_detachnode
argument_list|(
name|gdb
argument_list|,
operator|&
name|node
argument_list|)
expr_stmt|;
continue|continue;
block|}
name|result
operator|=
name|dns_dbiterator_next
argument_list|(
name|dbiter
argument_list|)
expr_stmt|;
name|nextnode
operator|=
name|NULL
expr_stmt|;
while|while
condition|(
name|result
operator|==
name|ISC_R_SUCCESS
condition|)
block|{
name|result
operator|=
name|dns_dbiterator_current
argument_list|(
name|dbiter
argument_list|,
operator|&
name|nextnode
argument_list|,
name|nextname
argument_list|)
expr_stmt|;
name|check_dns_dbiterator_current
argument_list|(
name|result
argument_list|)
expr_stmt|;
name|active
operator|=
name|active_node
argument_list|(
name|nextnode
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|active
condition|)
block|{
name|dns_db_detachnode
argument_list|(
name|gdb
argument_list|,
operator|&
name|nextnode
argument_list|)
expr_stmt|;
name|result
operator|=
name|dns_dbiterator_next
argument_list|(
name|dbiter
argument_list|)
expr_stmt|;
continue|continue;
block|}
if|if
condition|(
operator|!
name|dns_name_issubdomain
argument_list|(
name|nextname
argument_list|,
name|gorigin
argument_list|)
operator|||
operator|(
name|zonecut
operator|!=
name|NULL
operator|&&
name|dns_name_issubdomain
argument_list|(
name|nextname
argument_list|,
name|zonecut
argument_list|)
operator|)
condition|)
block|{
name|dns_db_detachnode
argument_list|(
name|gdb
argument_list|,
operator|&
name|nextnode
argument_list|)
expr_stmt|;
name|result
operator|=
name|dns_dbiterator_next
argument_list|(
name|dbiter
argument_list|)
expr_stmt|;
continue|continue;
block|}
if|if
condition|(
name|delegation
argument_list|(
name|nextname
argument_list|,
name|nextnode
argument_list|,
name|NULL
argument_list|)
condition|)
block|{
name|zonecut
operator|=
name|dns_fixedname_name
argument_list|(
operator|&
name|fzonecut
argument_list|)
expr_stmt|;
name|dns_name_copy
argument_list|(
name|nextname
argument_list|,
name|zonecut
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|OPTOUT
argument_list|(
name|nsec3flags
argument_list|)
operator|&&
operator|!
name|secure
argument_list|(
name|nextname
argument_list|,
name|nextnode
argument_list|)
condition|)
block|{
name|dns_db_detachnode
argument_list|(
name|gdb
argument_list|,
operator|&
name|nextnode
argument_list|)
expr_stmt|;
name|result
operator|=
name|dns_dbiterator_next
argument_list|(
name|dbiter
argument_list|)
expr_stmt|;
continue|continue;
block|}
block|}
name|dns_db_detachnode
argument_list|(
name|gdb
argument_list|,
operator|&
name|nextnode
argument_list|)
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|result
operator|==
name|ISC_R_NOMORE
condition|)
block|{
name|dns_name_copy
argument_list|(
name|gorigin
argument_list|,
name|nextname
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|done
operator|=
name|ISC_TRUE
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
name|fatal
argument_list|(
literal|"iterating through the database failed: %s"
argument_list|,
name|isc_result_totext
argument_list|(
name|result
argument_list|)
argument_list|)
expr_stmt|;
comment|/* 		 * We need to pause here to release the lock on the database. 		 */
name|dns_dbiterator_pause
argument_list|(
name|dbiter
argument_list|)
expr_stmt|;
name|addnsec3
argument_list|(
name|name
argument_list|,
name|node
argument_list|,
name|salt
argument_list|,
name|salt_length
argument_list|,
name|iterations
argument_list|,
name|hashlist
argument_list|,
name|zone_soa_min_ttl
argument_list|)
expr_stmt|;
name|dns_db_detachnode
argument_list|(
name|gdb
argument_list|,
operator|&
name|node
argument_list|)
expr_stmt|;
comment|/* 		 * Add NSEC3's for empty nodes.  Use closest encloser logic. 		 */
name|dns_name_fullcompare
argument_list|(
name|name
argument_list|,
name|nextname
argument_list|,
operator|&
name|order
argument_list|,
operator|&
name|nlabels
argument_list|)
expr_stmt|;
name|count
operator|=
name|dns_name_countlabels
argument_list|(
name|nextname
argument_list|)
expr_stmt|;
while|while
condition|(
name|count
operator|>
name|nlabels
operator|+
literal|1
condition|)
block|{
name|count
operator|--
expr_stmt|;
name|dns_name_split
argument_list|(
name|nextname
argument_list|,
name|count
argument_list|,
name|NULL
argument_list|,
name|nextname
argument_list|)
expr_stmt|;
name|addnsec3
argument_list|(
name|nextname
argument_list|,
name|NULL
argument_list|,
name|salt
argument_list|,
name|salt_length
argument_list|,
name|iterations
argument_list|,
name|hashlist
argument_list|,
name|zone_soa_min_ttl
argument_list|)
expr_stmt|;
block|}
block|}
name|dns_dbiterator_destroy
argument_list|(
operator|&
name|dbiter
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*%  * Load the zone file from disk  */
end_comment

begin_function
specifier|static
name|void
name|loadzone
parameter_list|(
name|char
modifier|*
name|file
parameter_list|,
name|char
modifier|*
name|origin
parameter_list|,
name|dns_rdataclass_t
name|rdclass
parameter_list|,
name|dns_db_t
modifier|*
modifier|*
name|db
parameter_list|)
block|{
name|isc_buffer_t
name|b
decl_stmt|;
name|int
name|len
decl_stmt|;
name|dns_fixedname_t
name|fname
decl_stmt|;
name|dns_name_t
modifier|*
name|name
decl_stmt|;
name|isc_result_t
name|result
decl_stmt|;
name|len
operator|=
name|strlen
argument_list|(
name|origin
argument_list|)
expr_stmt|;
name|isc_buffer_init
argument_list|(
operator|&
name|b
argument_list|,
name|origin
argument_list|,
name|len
argument_list|)
expr_stmt|;
name|isc_buffer_add
argument_list|(
operator|&
name|b
argument_list|,
name|len
argument_list|)
expr_stmt|;
name|dns_fixedname_init
argument_list|(
operator|&
name|fname
argument_list|)
expr_stmt|;
name|name
operator|=
name|dns_fixedname_name
argument_list|(
operator|&
name|fname
argument_list|)
expr_stmt|;
name|result
operator|=
name|dns_name_fromtext
argument_list|(
name|name
argument_list|,
operator|&
name|b
argument_list|,
name|dns_rootname
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
name|fatal
argument_list|(
literal|"failed converting name '%s' to dns format: %s"
argument_list|,
name|origin
argument_list|,
name|isc_result_totext
argument_list|(
name|result
argument_list|)
argument_list|)
expr_stmt|;
name|result
operator|=
name|dns_db_create
argument_list|(
name|mctx
argument_list|,
literal|"rbt"
argument_list|,
name|name
argument_list|,
name|dns_dbtype_zone
argument_list|,
name|rdclass
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|,
name|db
argument_list|)
expr_stmt|;
name|check_result
argument_list|(
name|result
argument_list|,
literal|"dns_db_create()"
argument_list|)
expr_stmt|;
name|result
operator|=
name|dns_db_load2
argument_list|(
operator|*
name|db
argument_list|,
name|file
argument_list|,
name|inputformat
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
operator|&&
name|result
operator|!=
name|DNS_R_SEENINCLUDE
condition|)
name|fatal
argument_list|(
literal|"failed loading zone from '%s': %s"
argument_list|,
name|file
argument_list|,
name|isc_result_totext
argument_list|(
name|result
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*%  * Finds all public zone keys in the zone, and attempts to load the  * private keys from disk.  */
end_comment

begin_function
specifier|static
name|void
name|loadzonekeys
parameter_list|(
name|isc_boolean_t
name|preserve_keys
parameter_list|,
name|isc_boolean_t
name|load_public
parameter_list|)
block|{
name|dns_dbnode_t
modifier|*
name|node
decl_stmt|;
name|dns_dbversion_t
modifier|*
name|currentversion
init|=
name|NULL
decl_stmt|;
name|isc_result_t
name|result
decl_stmt|;
name|dns_rdataset_t
name|rdataset
decl_stmt|,
name|keysigs
decl_stmt|,
name|soasigs
decl_stmt|;
name|node
operator|=
name|NULL
expr_stmt|;
name|result
operator|=
name|dns_db_findnode
argument_list|(
name|gdb
argument_list|,
name|gorigin
argument_list|,
name|ISC_FALSE
argument_list|,
operator|&
name|node
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
name|fatal
argument_list|(
literal|"failed to find the zone's origin: %s"
argument_list|,
name|isc_result_totext
argument_list|(
name|result
argument_list|)
argument_list|)
expr_stmt|;
name|dns_db_currentversion
argument_list|(
name|gdb
argument_list|,
operator|&
name|currentversion
argument_list|)
expr_stmt|;
name|dns_rdataset_init
argument_list|(
operator|&
name|rdataset
argument_list|)
expr_stmt|;
name|dns_rdataset_init
argument_list|(
operator|&
name|soasigs
argument_list|)
expr_stmt|;
name|dns_rdataset_init
argument_list|(
operator|&
name|keysigs
argument_list|)
expr_stmt|;
comment|/* Make note of the keys which signed the SOA, if any */
name|result
operator|=
name|dns_db_findrdataset
argument_list|(
name|gdb
argument_list|,
name|node
argument_list|,
name|currentversion
argument_list|,
name|dns_rdatatype_soa
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
operator|&
name|rdataset
argument_list|,
operator|&
name|soasigs
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
goto|goto
name|cleanup
goto|;
comment|/* Preserve the TTL of the DNSKEY RRset, if any */
name|dns_rdataset_disassociate
argument_list|(
operator|&
name|rdataset
argument_list|)
expr_stmt|;
name|result
operator|=
name|dns_db_findrdataset
argument_list|(
name|gdb
argument_list|,
name|node
argument_list|,
name|currentversion
argument_list|,
name|dns_rdatatype_dnskey
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
operator|&
name|rdataset
argument_list|,
operator|&
name|keysigs
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
goto|goto
name|cleanup
goto|;
if|if
condition|(
name|set_keyttl
operator|&&
name|keyttl
operator|!=
name|rdataset
operator|.
name|ttl
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"User-specified TTL (%d) conflicts "
literal|"with existing DNSKEY RRset TTL.\n"
argument_list|,
name|keyttl
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Imported keys will use the RRSet "
literal|"TTL (%d) instead.\n"
argument_list|,
name|rdataset
operator|.
name|ttl
argument_list|)
expr_stmt|;
block|}
name|keyttl
operator|=
name|rdataset
operator|.
name|ttl
expr_stmt|;
comment|/* Load keys corresponding to the existing DNSKEY RRset */
name|result
operator|=
name|dns_dnssec_keylistfromrdataset
argument_list|(
name|gorigin
argument_list|,
name|directory
argument_list|,
name|mctx
argument_list|,
operator|&
name|rdataset
argument_list|,
operator|&
name|keysigs
argument_list|,
operator|&
name|soasigs
argument_list|,
name|preserve_keys
argument_list|,
name|load_public
argument_list|,
operator|&
name|keylist
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
name|fatal
argument_list|(
literal|"failed to load the zone keys: %s"
argument_list|,
name|isc_result_totext
argument_list|(
name|result
argument_list|)
argument_list|)
expr_stmt|;
name|cleanup
label|:
if|if
condition|(
name|dns_rdataset_isassociated
argument_list|(
operator|&
name|rdataset
argument_list|)
condition|)
name|dns_rdataset_disassociate
argument_list|(
operator|&
name|rdataset
argument_list|)
expr_stmt|;
if|if
condition|(
name|dns_rdataset_isassociated
argument_list|(
operator|&
name|keysigs
argument_list|)
condition|)
name|dns_rdataset_disassociate
argument_list|(
operator|&
name|keysigs
argument_list|)
expr_stmt|;
if|if
condition|(
name|dns_rdataset_isassociated
argument_list|(
operator|&
name|soasigs
argument_list|)
condition|)
name|dns_rdataset_disassociate
argument_list|(
operator|&
name|soasigs
argument_list|)
expr_stmt|;
name|dns_db_detachnode
argument_list|(
name|gdb
argument_list|,
operator|&
name|node
argument_list|)
expr_stmt|;
name|dns_db_closeversion
argument_list|(
name|gdb
argument_list|,
operator|&
name|currentversion
argument_list|,
name|ISC_FALSE
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|loadexplicitkeys
parameter_list|(
name|char
modifier|*
name|keyfiles
index|[]
parameter_list|,
name|int
name|n
parameter_list|,
name|isc_boolean_t
name|setksk
parameter_list|)
block|{
name|isc_result_t
name|result
decl_stmt|;
name|int
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|n
condition|;
name|i
operator|++
control|)
block|{
name|dns_dnsseckey_t
modifier|*
name|key
init|=
name|NULL
decl_stmt|;
name|dst_key_t
modifier|*
name|newkey
init|=
name|NULL
decl_stmt|;
name|result
operator|=
name|dst_key_fromnamedfile
argument_list|(
name|keyfiles
index|[
name|i
index|]
argument_list|,
name|directory
argument_list|,
name|DST_TYPE_PUBLIC
operator||
name|DST_TYPE_PRIVATE
argument_list|,
name|mctx
argument_list|,
operator|&
name|newkey
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
name|fatal
argument_list|(
literal|"cannot load dnskey %s: %s"
argument_list|,
name|keyfiles
index|[
name|i
index|]
argument_list|,
name|isc_result_totext
argument_list|(
name|result
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|dns_name_equal
argument_list|(
name|gorigin
argument_list|,
name|dst_key_name
argument_list|(
name|newkey
argument_list|)
argument_list|)
condition|)
name|fatal
argument_list|(
literal|"key %s not at origin\n"
argument_list|,
name|keyfiles
index|[
name|i
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|dst_key_isprivate
argument_list|(
name|newkey
argument_list|)
condition|)
name|fatal
argument_list|(
literal|"cannot sign zone with non-private dnskey %s"
argument_list|,
name|keyfiles
index|[
name|i
index|]
argument_list|)
expr_stmt|;
comment|/* Skip any duplicates */
for|for
control|(
name|key
operator|=
name|ISC_LIST_HEAD
argument_list|(
name|keylist
argument_list|)
init|;
name|key
operator|!=
name|NULL
condition|;
name|key
operator|=
name|ISC_LIST_NEXT
argument_list|(
name|key
argument_list|,
name|link
argument_list|)
control|)
block|{
if|if
condition|(
name|dst_key_id
argument_list|(
name|key
operator|->
name|key
argument_list|)
operator|==
name|dst_key_id
argument_list|(
name|newkey
argument_list|)
operator|&&
name|dst_key_alg
argument_list|(
name|key
operator|->
name|key
argument_list|)
operator|==
name|dst_key_alg
argument_list|(
name|newkey
argument_list|)
condition|)
break|break;
block|}
if|if
condition|(
name|key
operator|==
name|NULL
condition|)
block|{
comment|/* We haven't seen this key before */
name|dns_dnsseckey_create
argument_list|(
name|mctx
argument_list|,
operator|&
name|newkey
argument_list|,
operator|&
name|key
argument_list|)
expr_stmt|;
name|ISC_LIST_APPEND
argument_list|(
name|keylist
argument_list|,
name|key
argument_list|,
name|link
argument_list|)
expr_stmt|;
name|key
operator|->
name|source
operator|=
name|dns_keysource_user
expr_stmt|;
block|}
else|else
block|{
name|dst_key_free
argument_list|(
operator|&
name|key
operator|->
name|key
argument_list|)
expr_stmt|;
name|key
operator|->
name|key
operator|=
name|newkey
expr_stmt|;
block|}
name|key
operator|->
name|force_publish
operator|=
name|ISC_TRUE
expr_stmt|;
name|key
operator|->
name|force_sign
operator|=
name|ISC_TRUE
expr_stmt|;
if|if
condition|(
name|setksk
condition|)
name|key
operator|->
name|ksk
operator|=
name|ISC_TRUE
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|report
parameter_list|(
specifier|const
name|char
modifier|*
name|format
parameter_list|,
modifier|...
parameter_list|)
block|{
name|va_list
name|args
decl_stmt|;
name|va_start
argument_list|(
name|args
argument_list|,
name|format
argument_list|)
expr_stmt|;
name|vfprintf
argument_list|(
name|stderr
argument_list|,
name|format
argument_list|,
name|args
argument_list|)
expr_stmt|;
name|va_end
argument_list|(
name|args
argument_list|)
expr_stmt|;
name|putc
argument_list|(
literal|'\n'
argument_list|,
name|stderr
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|build_final_keylist
parameter_list|()
block|{
name|isc_result_t
name|result
decl_stmt|;
name|dns_dbversion_t
modifier|*
name|ver
init|=
name|NULL
decl_stmt|;
name|dns_diff_t
name|diff
decl_stmt|;
name|dns_dnsseckeylist_t
name|matchkeys
decl_stmt|;
name|char
name|name
index|[
name|DNS_NAME_FORMATSIZE
index|]
decl_stmt|;
comment|/* 	 * Find keys that match this zone in the key repository. 	 */
name|ISC_LIST_INIT
argument_list|(
name|matchkeys
argument_list|)
expr_stmt|;
name|result
operator|=
name|dns_dnssec_findmatchingkeys
argument_list|(
name|gorigin
argument_list|,
name|directory
argument_list|,
name|mctx
argument_list|,
operator|&
name|matchkeys
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|==
name|ISC_R_NOTFOUND
condition|)
name|result
operator|=
name|ISC_R_SUCCESS
expr_stmt|;
name|check_result
argument_list|(
name|result
argument_list|,
literal|"dns_dnssec_findmatchingkeys"
argument_list|)
expr_stmt|;
name|result
operator|=
name|dns_db_newversion
argument_list|(
name|gdb
argument_list|,
operator|&
name|ver
argument_list|)
expr_stmt|;
name|check_result
argument_list|(
name|result
argument_list|,
literal|"dns_db_newversion"
argument_list|)
expr_stmt|;
name|dns_diff_init
argument_list|(
name|mctx
argument_list|,
operator|&
name|diff
argument_list|)
expr_stmt|;
comment|/* 	 * Update keylist with information from from the key repository. 	 */
name|dns_dnssec_updatekeys
argument_list|(
operator|&
name|keylist
argument_list|,
operator|&
name|matchkeys
argument_list|,
name|NULL
argument_list|,
name|gorigin
argument_list|,
name|keyttl
argument_list|,
operator|&
name|diff
argument_list|,
name|ignore_kskflag
argument_list|,
name|mctx
argument_list|,
name|report
argument_list|)
expr_stmt|;
name|dns_name_format
argument_list|(
name|gorigin
argument_list|,
name|name
argument_list|,
sizeof|sizeof
argument_list|(
name|name
argument_list|)
argument_list|)
expr_stmt|;
name|result
operator|=
name|dns_diff_applysilently
argument_list|(
operator|&
name|diff
argument_list|,
name|gdb
argument_list|,
name|ver
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
name|fatal
argument_list|(
literal|"failed to update DNSKEY RRset at node '%s': %s"
argument_list|,
name|name
argument_list|,
name|isc_result_totext
argument_list|(
name|result
argument_list|)
argument_list|)
expr_stmt|;
name|dns_db_closeversion
argument_list|(
name|gdb
argument_list|,
operator|&
name|ver
argument_list|,
name|ISC_TRUE
argument_list|)
expr_stmt|;
name|dns_diff_clear
argument_list|(
operator|&
name|diff
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|warnifallksk
parameter_list|(
name|dns_db_t
modifier|*
name|db
parameter_list|)
block|{
name|dns_dbversion_t
modifier|*
name|currentversion
init|=
name|NULL
decl_stmt|;
name|dns_dbnode_t
modifier|*
name|node
init|=
name|NULL
decl_stmt|;
name|dns_rdataset_t
name|rdataset
decl_stmt|;
name|dns_rdata_t
name|rdata
init|=
name|DNS_RDATA_INIT
decl_stmt|;
name|isc_result_t
name|result
decl_stmt|;
name|dns_rdata_dnskey_t
name|dnskey
decl_stmt|;
name|isc_boolean_t
name|have_non_ksk
init|=
name|ISC_FALSE
decl_stmt|;
name|dns_db_currentversion
argument_list|(
name|db
argument_list|,
operator|&
name|currentversion
argument_list|)
expr_stmt|;
name|result
operator|=
name|dns_db_findnode
argument_list|(
name|db
argument_list|,
name|gorigin
argument_list|,
name|ISC_FALSE
argument_list|,
operator|&
name|node
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
name|fatal
argument_list|(
literal|"failed to find the zone's origin: %s"
argument_list|,
name|isc_result_totext
argument_list|(
name|result
argument_list|)
argument_list|)
expr_stmt|;
name|dns_rdataset_init
argument_list|(
operator|&
name|rdataset
argument_list|)
expr_stmt|;
name|result
operator|=
name|dns_db_findrdataset
argument_list|(
name|db
argument_list|,
name|node
argument_list|,
name|currentversion
argument_list|,
name|dns_rdatatype_dnskey
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
operator|&
name|rdataset
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
name|fatal
argument_list|(
literal|"failed to find keys at the zone apex: %s"
argument_list|,
name|isc_result_totext
argument_list|(
name|result
argument_list|)
argument_list|)
expr_stmt|;
name|result
operator|=
name|dns_rdataset_first
argument_list|(
operator|&
name|rdataset
argument_list|)
expr_stmt|;
name|check_result
argument_list|(
name|result
argument_list|,
literal|"dns_rdataset_first"
argument_list|)
expr_stmt|;
while|while
condition|(
name|result
operator|==
name|ISC_R_SUCCESS
condition|)
block|{
name|dns_rdata_reset
argument_list|(
operator|&
name|rdata
argument_list|)
expr_stmt|;
name|dns_rdataset_current
argument_list|(
operator|&
name|rdataset
argument_list|,
operator|&
name|rdata
argument_list|)
expr_stmt|;
name|result
operator|=
name|dns_rdata_tostruct
argument_list|(
operator|&
name|rdata
argument_list|,
operator|&
name|dnskey
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|check_result
argument_list|(
name|result
argument_list|,
literal|"dns_rdata_tostruct"
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|dnskey
operator|.
name|flags
operator|&
name|DNS_KEYFLAG_KSK
operator|)
operator|==
literal|0
condition|)
block|{
name|have_non_ksk
operator|=
name|ISC_TRUE
expr_stmt|;
name|result
operator|=
name|ISC_R_NOMORE
expr_stmt|;
block|}
else|else
name|result
operator|=
name|dns_rdataset_next
argument_list|(
operator|&
name|rdataset
argument_list|)
expr_stmt|;
name|dns_rdata_freestruct
argument_list|(
operator|&
name|dnskey
argument_list|)
expr_stmt|;
block|}
name|dns_rdataset_disassociate
argument_list|(
operator|&
name|rdataset
argument_list|)
expr_stmt|;
name|dns_db_detachnode
argument_list|(
name|db
argument_list|,
operator|&
name|node
argument_list|)
expr_stmt|;
name|dns_db_closeversion
argument_list|(
name|db
argument_list|,
operator|&
name|currentversion
argument_list|,
name|ISC_FALSE
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|have_non_ksk
operator|&&
operator|!
name|ignore_kskflag
condition|)
block|{
if|if
condition|(
name|disable_zone_check
condition|)
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"%s: warning: No non-KSK DNSKEY found; "
literal|"supply a ZSK or use '-z'.\n"
argument_list|,
name|program
argument_list|)
expr_stmt|;
else|else
name|fatal
argument_list|(
literal|"No non-KSK DNSKEY found; "
literal|"supply a ZSK or use '-z'."
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|set_nsec3params
parameter_list|(
name|isc_boolean_t
name|update_chain
parameter_list|,
name|isc_boolean_t
name|set_salt
parameter_list|,
name|isc_boolean_t
name|set_optout
parameter_list|,
name|isc_boolean_t
name|set_iter
parameter_list|)
block|{
name|isc_result_t
name|result
decl_stmt|;
name|dns_dbversion_t
modifier|*
name|ver
init|=
name|NULL
decl_stmt|;
name|dns_dbnode_t
modifier|*
name|node
init|=
name|NULL
decl_stmt|;
name|dns_rdataset_t
name|rdataset
decl_stmt|;
name|dns_rdata_t
name|rdata
init|=
name|DNS_RDATA_INIT
decl_stmt|;
name|dns_rdata_nsec3_t
name|nsec3
decl_stmt|;
name|dns_fixedname_t
name|fname
decl_stmt|;
name|dns_name_t
modifier|*
name|hashname
decl_stmt|;
name|unsigned
name|char
name|orig_salt
index|[
literal|256
index|]
decl_stmt|;
name|size_t
name|orig_saltlen
decl_stmt|;
name|dns_hash_t
name|orig_hash
decl_stmt|;
name|isc_uint16_t
name|orig_iter
decl_stmt|;
name|dns_db_currentversion
argument_list|(
name|gdb
argument_list|,
operator|&
name|ver
argument_list|)
expr_stmt|;
name|dns_rdataset_init
argument_list|(
operator|&
name|rdataset
argument_list|)
expr_stmt|;
name|orig_saltlen
operator|=
sizeof|sizeof
argument_list|(
name|orig_salt
argument_list|)
expr_stmt|;
name|result
operator|=
name|dns_db_getnsec3parameters
argument_list|(
name|gdb
argument_list|,
name|ver
argument_list|,
operator|&
name|orig_hash
argument_list|,
name|NULL
argument_list|,
operator|&
name|orig_iter
argument_list|,
name|orig_salt
argument_list|,
operator|&
name|orig_saltlen
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
goto|goto
name|cleanup
goto|;
name|nsec_datatype
operator|=
name|dns_rdatatype_nsec3
expr_stmt|;
if|if
condition|(
operator|!
name|update_chain
operator|&&
name|set_salt
condition|)
block|{
if|if
condition|(
name|salt_length
operator|!=
name|orig_saltlen
operator|||
name|memcmp
argument_list|(
name|saltbuf
argument_list|,
name|orig_salt
argument_list|,
name|salt_length
argument_list|)
operator|!=
literal|0
condition|)
name|fatal
argument_list|(
literal|"An NSEC3 chain exists with a different salt. "
literal|"Use -u to update it."
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|!
name|set_salt
condition|)
block|{
name|salt_length
operator|=
name|orig_saltlen
expr_stmt|;
name|memcpy
argument_list|(
name|saltbuf
argument_list|,
name|orig_salt
argument_list|,
name|orig_saltlen
argument_list|)
expr_stmt|;
name|salt
operator|=
name|saltbuf
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|update_chain
operator|&&
name|set_iter
condition|)
block|{
if|if
condition|(
name|nsec3iter
operator|!=
name|orig_iter
condition|)
name|fatal
argument_list|(
literal|"An NSEC3 chain exists with different "
literal|"iterations. Use -u to update it."
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|!
name|set_iter
condition|)
name|nsec3iter
operator|=
name|orig_iter
expr_stmt|;
comment|/* 	 * Find an NSEC3 record to get the current OPTOUT value. 	 * (This assumes all NSEC3 records agree.) 	 */
name|dns_fixedname_init
argument_list|(
operator|&
name|fname
argument_list|)
expr_stmt|;
name|hashname
operator|=
name|dns_fixedname_name
argument_list|(
operator|&
name|fname
argument_list|)
expr_stmt|;
name|result
operator|=
name|dns_nsec3_hashname
argument_list|(
operator|&
name|fname
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|gorigin
argument_list|,
name|gorigin
argument_list|,
name|dns_hash_sha1
argument_list|,
name|orig_iter
argument_list|,
name|orig_salt
argument_list|,
name|orig_saltlen
argument_list|)
expr_stmt|;
name|check_result
argument_list|(
name|result
argument_list|,
literal|"dns_nsec3_hashname"
argument_list|)
expr_stmt|;
name|result
operator|=
name|dns_db_findnsec3node
argument_list|(
name|gdb
argument_list|,
name|hashname
argument_list|,
name|ISC_FALSE
argument_list|,
operator|&
name|node
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
goto|goto
name|cleanup
goto|;
name|result
operator|=
name|dns_db_findrdataset
argument_list|(
name|gdb
argument_list|,
name|node
argument_list|,
name|ver
argument_list|,
name|dns_rdatatype_nsec3
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
operator|&
name|rdataset
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
goto|goto
name|cleanup
goto|;
name|result
operator|=
name|dns_rdataset_first
argument_list|(
operator|&
name|rdataset
argument_list|)
expr_stmt|;
name|check_result
argument_list|(
name|result
argument_list|,
literal|"dns_rdataset_first"
argument_list|)
expr_stmt|;
name|dns_rdataset_current
argument_list|(
operator|&
name|rdataset
argument_list|,
operator|&
name|rdata
argument_list|)
expr_stmt|;
name|result
operator|=
name|dns_rdata_tostruct
argument_list|(
operator|&
name|rdata
argument_list|,
operator|&
name|nsec3
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|check_result
argument_list|(
name|result
argument_list|,
literal|"dns_rdata_tostruct"
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|update_chain
operator|&&
name|set_optout
condition|)
block|{
if|if
condition|(
name|nsec3flags
operator|!=
name|nsec3
operator|.
name|flags
condition|)
name|fatal
argument_list|(
literal|"An NSEC3 chain exists with%s OPTOUT. "
literal|"Use -u -%s to %s it."
argument_list|,
name|OPTOUT
argument_list|(
name|nsec3
operator|.
name|flags
argument_list|)
condition|?
literal|""
else|:
literal|"out"
argument_list|,
name|OPTOUT
argument_list|(
name|nsec3
operator|.
name|flags
argument_list|)
condition|?
literal|"AA"
else|:
literal|"A"
argument_list|,
name|OPTOUT
argument_list|(
name|nsec3
operator|.
name|flags
argument_list|)
condition|?
literal|"clear"
else|:
literal|"set"
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|!
name|set_optout
condition|)
name|nsec3flags
operator|=
name|nsec3
operator|.
name|flags
expr_stmt|;
name|dns_rdata_freestruct
argument_list|(
operator|&
name|nsec3
argument_list|)
expr_stmt|;
name|cleanup
label|:
if|if
condition|(
name|dns_rdataset_isassociated
argument_list|(
operator|&
name|rdataset
argument_list|)
condition|)
name|dns_rdataset_disassociate
argument_list|(
operator|&
name|rdataset
argument_list|)
expr_stmt|;
if|if
condition|(
name|node
operator|!=
name|NULL
condition|)
name|dns_db_detachnode
argument_list|(
name|gdb
argument_list|,
operator|&
name|node
argument_list|)
expr_stmt|;
name|dns_db_closeversion
argument_list|(
name|gdb
argument_list|,
operator|&
name|ver
argument_list|,
name|ISC_FALSE
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|writeset
parameter_list|(
specifier|const
name|char
modifier|*
name|prefix
parameter_list|,
name|dns_rdatatype_t
name|type
parameter_list|)
block|{
name|char
modifier|*
name|filename
decl_stmt|;
name|char
name|namestr
index|[
name|DNS_NAME_FORMATSIZE
index|]
decl_stmt|;
name|dns_db_t
modifier|*
name|db
init|=
name|NULL
decl_stmt|;
name|dns_dbversion_t
modifier|*
name|version
init|=
name|NULL
decl_stmt|;
name|dns_diff_t
name|diff
decl_stmt|;
name|dns_difftuple_t
modifier|*
name|tuple
init|=
name|NULL
decl_stmt|;
name|dns_fixedname_t
name|fixed
decl_stmt|;
name|dns_name_t
modifier|*
name|name
decl_stmt|;
name|dns_rdata_t
name|rdata
decl_stmt|,
name|ds
decl_stmt|;
name|isc_boolean_t
name|have_ksk
init|=
name|ISC_FALSE
decl_stmt|;
name|isc_boolean_t
name|have_non_ksk
init|=
name|ISC_FALSE
decl_stmt|;
name|isc_buffer_t
name|b
decl_stmt|;
name|isc_buffer_t
name|namebuf
decl_stmt|;
name|isc_region_t
name|r
decl_stmt|;
name|isc_result_t
name|result
decl_stmt|;
name|dns_dnsseckey_t
modifier|*
name|key
decl_stmt|,
modifier|*
name|tmpkey
decl_stmt|;
name|unsigned
name|char
name|dsbuf
index|[
name|DNS_DS_BUFFERSIZE
index|]
decl_stmt|;
name|unsigned
name|char
name|keybuf
index|[
name|DST_KEY_MAXSIZE
index|]
decl_stmt|;
name|unsigned
name|int
name|filenamelen
decl_stmt|;
specifier|const
name|dns_master_style_t
modifier|*
name|style
init|=
operator|(
name|type
operator|==
name|dns_rdatatype_dnskey
operator|)
condition|?
name|masterstyle
else|:
name|dsstyle
decl_stmt|;
name|isc_buffer_init
argument_list|(
operator|&
name|namebuf
argument_list|,
name|namestr
argument_list|,
sizeof|sizeof
argument_list|(
name|namestr
argument_list|)
argument_list|)
expr_stmt|;
name|result
operator|=
name|dns_name_tofilenametext
argument_list|(
name|gorigin
argument_list|,
name|ISC_FALSE
argument_list|,
operator|&
name|namebuf
argument_list|)
expr_stmt|;
name|check_result
argument_list|(
name|result
argument_list|,
literal|"dns_name_tofilenametext"
argument_list|)
expr_stmt|;
name|isc_buffer_putuint8
argument_list|(
operator|&
name|namebuf
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|filenamelen
operator|=
name|strlen
argument_list|(
name|prefix
argument_list|)
operator|+
name|strlen
argument_list|(
name|namestr
argument_list|)
expr_stmt|;
if|if
condition|(
name|dsdir
operator|!=
name|NULL
condition|)
name|filenamelen
operator|+=
name|strlen
argument_list|(
name|dsdir
argument_list|)
operator|+
literal|1
expr_stmt|;
name|filename
operator|=
name|isc_mem_get
argument_list|(
name|mctx
argument_list|,
name|filenamelen
operator|+
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|filename
operator|==
name|NULL
condition|)
name|fatal
argument_list|(
literal|"out of memory"
argument_list|)
expr_stmt|;
if|if
condition|(
name|dsdir
operator|!=
name|NULL
condition|)
name|sprintf
argument_list|(
name|filename
argument_list|,
literal|"%s/"
argument_list|,
name|dsdir
argument_list|)
expr_stmt|;
else|else
name|filename
index|[
literal|0
index|]
operator|=
literal|0
expr_stmt|;
name|strcat
argument_list|(
name|filename
argument_list|,
name|prefix
argument_list|)
expr_stmt|;
name|strcat
argument_list|(
name|filename
argument_list|,
name|namestr
argument_list|)
expr_stmt|;
name|dns_diff_init
argument_list|(
name|mctx
argument_list|,
operator|&
name|diff
argument_list|)
expr_stmt|;
if|if
condition|(
name|type
operator|==
name|dns_rdatatype_dlv
condition|)
block|{
name|dns_name_t
name|tname
decl_stmt|;
name|unsigned
name|int
name|labels
decl_stmt|;
name|dns_name_init
argument_list|(
operator|&
name|tname
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|dns_fixedname_init
argument_list|(
operator|&
name|fixed
argument_list|)
expr_stmt|;
name|name
operator|=
name|dns_fixedname_name
argument_list|(
operator|&
name|fixed
argument_list|)
expr_stmt|;
name|labels
operator|=
name|dns_name_countlabels
argument_list|(
name|gorigin
argument_list|)
expr_stmt|;
name|dns_name_getlabelsequence
argument_list|(
name|gorigin
argument_list|,
literal|0
argument_list|,
name|labels
operator|-
literal|1
argument_list|,
operator|&
name|tname
argument_list|)
expr_stmt|;
name|result
operator|=
name|dns_name_concatenate
argument_list|(
operator|&
name|tname
argument_list|,
name|dlv
argument_list|,
name|name
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|check_result
argument_list|(
name|result
argument_list|,
literal|"dns_name_concatenate"
argument_list|)
expr_stmt|;
block|}
else|else
name|name
operator|=
name|gorigin
expr_stmt|;
for|for
control|(
name|key
operator|=
name|ISC_LIST_HEAD
argument_list|(
name|keylist
argument_list|)
init|;
name|key
operator|!=
name|NULL
condition|;
name|key
operator|=
name|ISC_LIST_NEXT
argument_list|(
name|key
argument_list|,
name|link
argument_list|)
control|)
block|{
if|if
condition|(
name|REVOKE
argument_list|(
name|key
operator|->
name|key
argument_list|)
condition|)
continue|continue;
if|if
condition|(
name|isksk
argument_list|(
name|key
argument_list|)
condition|)
block|{
name|have_ksk
operator|=
name|ISC_TRUE
expr_stmt|;
name|have_non_ksk
operator|=
name|ISC_FALSE
expr_stmt|;
block|}
else|else
block|{
name|have_ksk
operator|=
name|ISC_FALSE
expr_stmt|;
name|have_non_ksk
operator|=
name|ISC_TRUE
expr_stmt|;
block|}
for|for
control|(
name|tmpkey
operator|=
name|ISC_LIST_HEAD
argument_list|(
name|keylist
argument_list|)
init|;
name|tmpkey
operator|!=
name|NULL
condition|;
name|tmpkey
operator|=
name|ISC_LIST_NEXT
argument_list|(
name|tmpkey
argument_list|,
name|link
argument_list|)
control|)
block|{
if|if
condition|(
name|dst_key_alg
argument_list|(
name|key
operator|->
name|key
argument_list|)
operator|!=
name|dst_key_alg
argument_list|(
name|tmpkey
operator|->
name|key
argument_list|)
condition|)
continue|continue;
if|if
condition|(
name|REVOKE
argument_list|(
name|tmpkey
operator|->
name|key
argument_list|)
condition|)
continue|continue;
if|if
condition|(
name|isksk
argument_list|(
name|tmpkey
argument_list|)
condition|)
name|have_ksk
operator|=
name|ISC_TRUE
expr_stmt|;
else|else
name|have_non_ksk
operator|=
name|ISC_TRUE
expr_stmt|;
block|}
if|if
condition|(
name|have_ksk
operator|&&
name|have_non_ksk
operator|&&
operator|!
name|isksk
argument_list|(
name|key
argument_list|)
condition|)
continue|continue;
name|dns_rdata_init
argument_list|(
operator|&
name|rdata
argument_list|)
expr_stmt|;
name|dns_rdata_init
argument_list|(
operator|&
name|ds
argument_list|)
expr_stmt|;
name|isc_buffer_init
argument_list|(
operator|&
name|b
argument_list|,
name|keybuf
argument_list|,
sizeof|sizeof
argument_list|(
name|keybuf
argument_list|)
argument_list|)
expr_stmt|;
name|result
operator|=
name|dst_key_todns
argument_list|(
name|key
operator|->
name|key
argument_list|,
operator|&
name|b
argument_list|)
expr_stmt|;
name|check_result
argument_list|(
name|result
argument_list|,
literal|"dst_key_todns"
argument_list|)
expr_stmt|;
name|isc_buffer_usedregion
argument_list|(
operator|&
name|b
argument_list|,
operator|&
name|r
argument_list|)
expr_stmt|;
name|dns_rdata_fromregion
argument_list|(
operator|&
name|rdata
argument_list|,
name|gclass
argument_list|,
name|dns_rdatatype_dnskey
argument_list|,
operator|&
name|r
argument_list|)
expr_stmt|;
if|if
condition|(
name|type
operator|!=
name|dns_rdatatype_dnskey
condition|)
block|{
name|result
operator|=
name|dns_ds_buildrdata
argument_list|(
name|gorigin
argument_list|,
operator|&
name|rdata
argument_list|,
name|DNS_DSDIGEST_SHA1
argument_list|,
name|dsbuf
argument_list|,
operator|&
name|ds
argument_list|)
expr_stmt|;
name|check_result
argument_list|(
name|result
argument_list|,
literal|"dns_ds_buildrdata"
argument_list|)
expr_stmt|;
if|if
condition|(
name|type
operator|==
name|dns_rdatatype_dlv
condition|)
name|ds
operator|.
name|type
operator|=
name|dns_rdatatype_dlv
expr_stmt|;
name|result
operator|=
name|dns_difftuple_create
argument_list|(
name|mctx
argument_list|,
name|DNS_DIFFOP_ADD
argument_list|,
name|name
argument_list|,
literal|0
argument_list|,
operator|&
name|ds
argument_list|,
operator|&
name|tuple
argument_list|)
expr_stmt|;
name|check_result
argument_list|(
name|result
argument_list|,
literal|"dns_difftuple_create"
argument_list|)
expr_stmt|;
name|dns_diff_append
argument_list|(
operator|&
name|diff
argument_list|,
operator|&
name|tuple
argument_list|)
expr_stmt|;
name|dns_rdata_reset
argument_list|(
operator|&
name|ds
argument_list|)
expr_stmt|;
name|result
operator|=
name|dns_ds_buildrdata
argument_list|(
name|gorigin
argument_list|,
operator|&
name|rdata
argument_list|,
name|DNS_DSDIGEST_SHA256
argument_list|,
name|dsbuf
argument_list|,
operator|&
name|ds
argument_list|)
expr_stmt|;
name|check_result
argument_list|(
name|result
argument_list|,
literal|"dns_ds_buildrdata"
argument_list|)
expr_stmt|;
if|if
condition|(
name|type
operator|==
name|dns_rdatatype_dlv
condition|)
name|ds
operator|.
name|type
operator|=
name|dns_rdatatype_dlv
expr_stmt|;
name|result
operator|=
name|dns_difftuple_create
argument_list|(
name|mctx
argument_list|,
name|DNS_DIFFOP_ADD
argument_list|,
name|name
argument_list|,
literal|0
argument_list|,
operator|&
name|ds
argument_list|,
operator|&
name|tuple
argument_list|)
expr_stmt|;
block|}
else|else
name|result
operator|=
name|dns_difftuple_create
argument_list|(
name|mctx
argument_list|,
name|DNS_DIFFOP_ADD
argument_list|,
name|gorigin
argument_list|,
name|zone_soa_min_ttl
argument_list|,
operator|&
name|rdata
argument_list|,
operator|&
name|tuple
argument_list|)
expr_stmt|;
name|check_result
argument_list|(
name|result
argument_list|,
literal|"dns_difftuple_create"
argument_list|)
expr_stmt|;
name|dns_diff_append
argument_list|(
operator|&
name|diff
argument_list|,
operator|&
name|tuple
argument_list|)
expr_stmt|;
block|}
name|result
operator|=
name|dns_db_create
argument_list|(
name|mctx
argument_list|,
literal|"rbt"
argument_list|,
name|dns_rootname
argument_list|,
name|dns_dbtype_zone
argument_list|,
name|gclass
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|,
operator|&
name|db
argument_list|)
expr_stmt|;
name|check_result
argument_list|(
name|result
argument_list|,
literal|"dns_db_create"
argument_list|)
expr_stmt|;
name|result
operator|=
name|dns_db_newversion
argument_list|(
name|db
argument_list|,
operator|&
name|version
argument_list|)
expr_stmt|;
name|check_result
argument_list|(
name|result
argument_list|,
literal|"dns_db_newversion"
argument_list|)
expr_stmt|;
name|result
operator|=
name|dns_diff_apply
argument_list|(
operator|&
name|diff
argument_list|,
name|db
argument_list|,
name|version
argument_list|)
expr_stmt|;
name|check_result
argument_list|(
name|result
argument_list|,
literal|"dns_diff_apply"
argument_list|)
expr_stmt|;
name|dns_diff_clear
argument_list|(
operator|&
name|diff
argument_list|)
expr_stmt|;
name|result
operator|=
name|dns_master_dump
argument_list|(
name|mctx
argument_list|,
name|db
argument_list|,
name|version
argument_list|,
name|style
argument_list|,
name|filename
argument_list|)
expr_stmt|;
name|check_result
argument_list|(
name|result
argument_list|,
literal|"dns_master_dump"
argument_list|)
expr_stmt|;
name|isc_mem_put
argument_list|(
name|mctx
argument_list|,
name|filename
argument_list|,
name|filenamelen
operator|+
literal|1
argument_list|)
expr_stmt|;
name|dns_db_closeversion
argument_list|(
name|db
argument_list|,
operator|&
name|version
argument_list|,
name|ISC_FALSE
argument_list|)
expr_stmt|;
name|dns_db_detach
argument_list|(
operator|&
name|db
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|print_time
parameter_list|(
name|FILE
modifier|*
name|fp
parameter_list|)
block|{
name|time_t
name|currenttime
decl_stmt|;
if|if
condition|(
name|outputformat
operator|!=
name|dns_masterformat_text
condition|)
return|return;
name|currenttime
operator|=
name|time
argument_list|(
name|NULL
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"; File written on %s"
argument_list|,
name|ctime
argument_list|(
operator|&
name|currenttime
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|print_version
parameter_list|(
name|FILE
modifier|*
name|fp
parameter_list|)
block|{
if|if
condition|(
name|outputformat
operator|!=
name|dns_masterformat_text
condition|)
return|return;
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"; dnssec_signzone version "
name|VERSION
literal|"\n"
argument_list|)
expr_stmt|;
block|}
end_function

begin_decl_stmt
name|ISC_PLATFORM_NORETURN_PRE
specifier|static
name|void
name|usage
argument_list|(
name|void
argument_list|)
name|ISC_PLATFORM_NORETURN_POST
decl_stmt|;
end_decl_stmt

begin_function
specifier|static
name|void
name|usage
parameter_list|(
name|void
parameter_list|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Usage:\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"\t%s [options] zonefile [keys]\n"
argument_list|,
name|program
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Version: %s\n"
argument_list|,
name|VERSION
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Options: (default value in parenthesis) \n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"\t-S:\tsmart signing: automatically finds key files\n"
literal|"\t\tfor the zone and determines how they are to "
literal|"be used\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"\t-K directory:\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"\t\tdirectory to find key files (.)\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"\t-d directory:\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"\t\tdirectory to find dsset-* files (.)\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"\t-g:\t"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"update DS records based on child zones' "
literal|"dsset-* files\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"\t-s [YYYYMMDDHHMMSS|+offset]:\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"\t\tRRSIG start time - absolute|offset (now - 1 hour)\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"\t-e [YYYYMMDDHHMMSS|+offset|\"now\"+offset]:\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"\t\tRRSIG end time  - absolute|from start|from now "
literal|"(now + 30 days)\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"\t-i interval:\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"\t\tcycle interval - resign "
literal|"if< interval from end ( (end-start)/4 )\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"\t-j jitter:\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"\t\trandomize signature end time up to jitter seconds\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"\t-v debuglevel (0)\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"\t-o origin:\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"\t\tzone origin (name of zonefile)\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"\t-f outfile:\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"\t\tfile the signed zone is written in "
literal|"(zonefile + .signed)\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"\t-I format:\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"\t\tfile format of input zonefile (text)\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"\t-O format:\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"\t\tfile format of signed zone file (text)\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"\t-N format:\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"\t\tsoa serial format of signed zone file (keep)\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"\t-r randomdev:\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"\t\ta file containing random data\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"\t-a:\t"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"verify generated signatures\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"\t-c class (IN)\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"\t-E engine:\n"
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|USE_PKCS11
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"\t\tname of an OpenSSL engine to use "
literal|"(default is \"pkcs11\")\n"
argument_list|)
expr_stmt|;
else|#
directive|else
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"\t\tname of an OpenSSL engine to use\n"
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"\t-p:\t"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"use pseudorandom data (faster but less secure)\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"\t-P:\t"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"disable post-sign verification\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"\t-T TTL:\tTTL for newly added DNSKEYs\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"\t-t:\t"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"print statistics\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"\t-u:\t"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"update or replace an existing NSEC/NSEC3 chain\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"\t-x:\tsign DNSKEY record with KSKs only, not ZSKs\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"\t-z:\tsign all records with KSKs\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"\t-C:\tgenerate a keyset file, for compatibility\n"
literal|"\t\twith older versions of dnssec-signzone -g\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"\t-n ncpus (number of cpus present)\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"\t-k key_signing_key\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"\t-l lookasidezone\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"\t-3 NSEC3 salt\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"\t-H NSEC3 iterations (10)\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"\t-A NSEC3 optout\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Signing Keys: "
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"(default: all zone keys that have private keys)\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"\tkeyfile (Kname+alg+tag)\n"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|0
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|removetempfile
parameter_list|(
name|void
parameter_list|)
block|{
if|if
condition|(
name|removefile
condition|)
name|isc_file_remove
argument_list|(
name|tempfile
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|print_stats
parameter_list|(
name|isc_time_t
modifier|*
name|timer_start
parameter_list|,
name|isc_time_t
modifier|*
name|timer_finish
parameter_list|)
block|{
name|isc_uint64_t
name|runtime_us
decl_stmt|;
comment|/* Runtime in microseconds */
name|isc_uint64_t
name|runtime_ms
decl_stmt|;
comment|/* Runtime in milliseconds */
name|isc_uint64_t
name|sig_ms
decl_stmt|;
comment|/* Signatures per millisecond */
name|runtime_us
operator|=
name|isc_time_microdiff
argument_list|(
name|timer_finish
argument_list|,
name|timer_start
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Signatures generated:               %10d\n"
argument_list|,
name|nsigned
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Signatures retained:                %10d\n"
argument_list|,
name|nretained
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Signatures dropped:                 %10d\n"
argument_list|,
name|ndropped
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Signatures successfully verified:   %10d\n"
argument_list|,
name|nverified
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Signatures unsuccessfully verified: %10d\n"
argument_list|,
name|nverifyfailed
argument_list|)
expr_stmt|;
name|runtime_ms
operator|=
name|runtime_us
operator|/
literal|1000
expr_stmt|;
name|printf
argument_list|(
literal|"Runtime in seconds:                %7u.%03u\n"
argument_list|,
call|(
name|unsigned
name|int
call|)
argument_list|(
name|runtime_ms
operator|/
literal|1000
argument_list|)
argument_list|,
call|(
name|unsigned
name|int
call|)
argument_list|(
name|runtime_ms
operator|%
literal|1000
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|runtime_us
operator|>
literal|0
condition|)
block|{
name|sig_ms
operator|=
operator|(
operator|(
name|isc_uint64_t
operator|)
name|nsigned
operator|*
literal|1000000000
operator|)
operator|/
name|runtime_us
expr_stmt|;
name|printf
argument_list|(
literal|"Signatures per second:             %7u.%03u\n"
argument_list|,
operator|(
name|unsigned
name|int
operator|)
name|sig_ms
operator|/
literal|1000
argument_list|,
operator|(
name|unsigned
name|int
operator|)
name|sig_ms
operator|%
literal|1000
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
name|int
name|main
parameter_list|(
name|int
name|argc
parameter_list|,
name|char
modifier|*
name|argv
index|[]
parameter_list|)
block|{
name|int
name|i
decl_stmt|,
name|ch
decl_stmt|;
name|char
modifier|*
name|startstr
init|=
name|NULL
decl_stmt|,
modifier|*
name|endstr
init|=
name|NULL
decl_stmt|,
modifier|*
name|classname
init|=
name|NULL
decl_stmt|;
name|char
modifier|*
name|origin
init|=
name|NULL
decl_stmt|,
modifier|*
name|file
init|=
name|NULL
decl_stmt|,
modifier|*
name|output
init|=
name|NULL
decl_stmt|;
name|char
modifier|*
name|inputformatstr
init|=
name|NULL
decl_stmt|,
modifier|*
name|outputformatstr
init|=
name|NULL
decl_stmt|;
name|char
modifier|*
name|serialformatstr
init|=
name|NULL
decl_stmt|;
name|char
modifier|*
name|dskeyfile
index|[
name|MAXDSKEYS
index|]
decl_stmt|;
name|int
name|ndskeys
init|=
literal|0
decl_stmt|;
name|char
modifier|*
name|endp
decl_stmt|;
name|isc_time_t
name|timer_start
decl_stmt|,
name|timer_finish
decl_stmt|;
name|dns_dnsseckey_t
modifier|*
name|key
decl_stmt|;
name|isc_result_t
name|result
decl_stmt|;
name|isc_log_t
modifier|*
name|log
init|=
name|NULL
decl_stmt|;
name|isc_boolean_t
name|pseudorandom
init|=
name|ISC_FALSE
decl_stmt|;
ifdef|#
directive|ifdef
name|USE_PKCS11
specifier|const
name|char
modifier|*
name|engine
init|=
literal|"pkcs11"
decl_stmt|;
else|#
directive|else
specifier|const
name|char
modifier|*
name|engine
init|=
name|NULL
decl_stmt|;
endif|#
directive|endif
name|unsigned
name|int
name|eflags
decl_stmt|;
name|isc_boolean_t
name|free_output
init|=
name|ISC_FALSE
decl_stmt|;
name|int
name|tempfilelen
decl_stmt|;
name|dns_rdataclass_t
name|rdclass
decl_stmt|;
name|isc_task_t
modifier|*
modifier|*
name|tasks
init|=
name|NULL
decl_stmt|;
name|isc_buffer_t
name|b
decl_stmt|;
name|int
name|len
decl_stmt|;
name|hashlist_t
name|hashlist
decl_stmt|;
name|isc_boolean_t
name|smartsign
init|=
name|ISC_FALSE
decl_stmt|;
name|isc_boolean_t
name|make_keyset
init|=
name|ISC_FALSE
decl_stmt|;
name|isc_boolean_t
name|set_salt
init|=
name|ISC_FALSE
decl_stmt|;
name|isc_boolean_t
name|set_optout
init|=
name|ISC_FALSE
decl_stmt|;
name|isc_boolean_t
name|set_iter
init|=
name|ISC_FALSE
decl_stmt|;
define|#
directive|define
name|CMDLINE_FLAGS
define|\
value|"3:AaCc:Dd:E:e:f:FghH:i:I:j:K:k:l:m:n:N:o:O:pPr:s:ST:tuUv:xz"
comment|/* 	 * Process memory debugging argument first. 	 */
while|while
condition|(
operator|(
name|ch
operator|=
name|isc_commandline_parse
argument_list|(
name|argc
argument_list|,
name|argv
argument_list|,
name|CMDLINE_FLAGS
argument_list|)
operator|)
operator|!=
operator|-
literal|1
condition|)
block|{
switch|switch
condition|(
name|ch
condition|)
block|{
case|case
literal|'m'
case|:
if|if
condition|(
name|strcasecmp
argument_list|(
name|isc_commandline_argument
argument_list|,
literal|"record"
argument_list|)
operator|==
literal|0
condition|)
name|isc_mem_debugging
operator||=
name|ISC_MEM_DEBUGRECORD
expr_stmt|;
if|if
condition|(
name|strcasecmp
argument_list|(
name|isc_commandline_argument
argument_list|,
literal|"trace"
argument_list|)
operator|==
literal|0
condition|)
name|isc_mem_debugging
operator||=
name|ISC_MEM_DEBUGTRACE
expr_stmt|;
if|if
condition|(
name|strcasecmp
argument_list|(
name|isc_commandline_argument
argument_list|,
literal|"usage"
argument_list|)
operator|==
literal|0
condition|)
name|isc_mem_debugging
operator||=
name|ISC_MEM_DEBUGUSAGE
expr_stmt|;
if|if
condition|(
name|strcasecmp
argument_list|(
name|isc_commandline_argument
argument_list|,
literal|"size"
argument_list|)
operator|==
literal|0
condition|)
name|isc_mem_debugging
operator||=
name|ISC_MEM_DEBUGSIZE
expr_stmt|;
if|if
condition|(
name|strcasecmp
argument_list|(
name|isc_commandline_argument
argument_list|,
literal|"mctx"
argument_list|)
operator|==
literal|0
condition|)
name|isc_mem_debugging
operator||=
name|ISC_MEM_DEBUGCTX
expr_stmt|;
break|break;
default|default:
break|break;
block|}
block|}
name|isc_commandline_reset
operator|=
name|ISC_TRUE
expr_stmt|;
name|masterstyle
operator|=
operator|&
name|dns_master_style_explicitttl
expr_stmt|;
name|check_result
argument_list|(
name|isc_app_start
argument_list|()
argument_list|,
literal|"isc_app_start"
argument_list|)
expr_stmt|;
name|result
operator|=
name|isc_mem_create
argument_list|(
literal|0
argument_list|,
literal|0
argument_list|,
operator|&
name|mctx
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
name|fatal
argument_list|(
literal|"out of memory"
argument_list|)
expr_stmt|;
name|dns_result_register
argument_list|()
expr_stmt|;
name|isc_commandline_errprint
operator|=
name|ISC_FALSE
expr_stmt|;
while|while
condition|(
operator|(
name|ch
operator|=
name|isc_commandline_parse
argument_list|(
name|argc
argument_list|,
name|argv
argument_list|,
name|CMDLINE_FLAGS
argument_list|)
operator|)
operator|!=
operator|-
literal|1
condition|)
block|{
switch|switch
condition|(
name|ch
condition|)
block|{
case|case
literal|'3'
case|:
name|set_salt
operator|=
name|ISC_TRUE
expr_stmt|;
name|nsec_datatype
operator|=
name|dns_rdatatype_nsec3
expr_stmt|;
if|if
condition|(
name|strcmp
argument_list|(
name|isc_commandline_argument
argument_list|,
literal|"-"
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|isc_buffer_t
name|target
decl_stmt|;
name|char
modifier|*
name|sarg
decl_stmt|;
name|sarg
operator|=
name|isc_commandline_argument
expr_stmt|;
name|isc_buffer_init
argument_list|(
operator|&
name|target
argument_list|,
name|saltbuf
argument_list|,
sizeof|sizeof
argument_list|(
name|saltbuf
argument_list|)
argument_list|)
expr_stmt|;
name|result
operator|=
name|isc_hex_decodestring
argument_list|(
name|sarg
argument_list|,
operator|&
name|target
argument_list|)
expr_stmt|;
name|check_result
argument_list|(
name|result
argument_list|,
literal|"isc_hex_decodestring(salt)"
argument_list|)
expr_stmt|;
name|salt_length
operator|=
name|isc_buffer_usedlength
argument_list|(
operator|&
name|target
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
literal|'A'
case|:
name|set_optout
operator|=
name|ISC_TRUE
expr_stmt|;
if|if
condition|(
name|OPTOUT
argument_list|(
name|nsec3flags
argument_list|)
condition|)
name|nsec3flags
operator|&=
operator|~
name|DNS_NSEC3FLAG_OPTOUT
expr_stmt|;
else|else
name|nsec3flags
operator||=
name|DNS_NSEC3FLAG_OPTOUT
expr_stmt|;
break|break;
case|case
literal|'a'
case|:
name|tryverify
operator|=
name|ISC_TRUE
expr_stmt|;
break|break;
case|case
literal|'C'
case|:
name|make_keyset
operator|=
name|ISC_TRUE
expr_stmt|;
break|break;
case|case
literal|'c'
case|:
name|classname
operator|=
name|isc_commandline_argument
expr_stmt|;
break|break;
case|case
literal|'d'
case|:
name|dsdir
operator|=
name|isc_commandline_argument
expr_stmt|;
if|if
condition|(
name|strlen
argument_list|(
name|dsdir
argument_list|)
operator|==
literal|0U
condition|)
name|fatal
argument_list|(
literal|"DS directory must be non-empty string"
argument_list|)
expr_stmt|;
name|result
operator|=
name|try_dir
argument_list|(
name|dsdir
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
name|fatal
argument_list|(
literal|"cannot open directory %s: %s"
argument_list|,
name|dsdir
argument_list|,
name|isc_result_totext
argument_list|(
name|result
argument_list|)
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'E'
case|:
name|engine
operator|=
name|isc_commandline_argument
expr_stmt|;
break|break;
case|case
literal|'e'
case|:
name|endstr
operator|=
name|isc_commandline_argument
expr_stmt|;
break|break;
case|case
literal|'f'
case|:
name|output
operator|=
name|isc_commandline_argument
expr_stmt|;
break|break;
case|case
literal|'g'
case|:
name|generateds
operator|=
name|ISC_TRUE
expr_stmt|;
break|break;
case|case
literal|'H'
case|:
name|set_iter
operator|=
name|ISC_TRUE
expr_stmt|;
name|nsec3iter
operator|=
name|strtoul
argument_list|(
name|isc_commandline_argument
argument_list|,
operator|&
name|endp
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
operator|*
name|endp
operator|!=
literal|'\0'
condition|)
name|fatal
argument_list|(
literal|"iterations must be numeric"
argument_list|)
expr_stmt|;
if|if
condition|(
name|nsec3iter
operator|>
literal|0xffffU
condition|)
name|fatal
argument_list|(
literal|"iterations too big"
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'h'
case|:
name|usage
argument_list|()
expr_stmt|;
break|break;
case|case
literal|'I'
case|:
name|inputformatstr
operator|=
name|isc_commandline_argument
expr_stmt|;
break|break;
case|case
literal|'i'
case|:
name|endp
operator|=
name|NULL
expr_stmt|;
name|cycle
operator|=
name|strtol
argument_list|(
name|isc_commandline_argument
argument_list|,
operator|&
name|endp
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
operator|*
name|endp
operator|!=
literal|'\0'
operator|||
name|cycle
operator|<
literal|0
condition|)
name|fatal
argument_list|(
literal|"cycle period must be numeric and "
literal|"positive"
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'j'
case|:
name|endp
operator|=
name|NULL
expr_stmt|;
name|jitter
operator|=
name|strtol
argument_list|(
name|isc_commandline_argument
argument_list|,
operator|&
name|endp
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
operator|*
name|endp
operator|!=
literal|'\0'
operator|||
name|jitter
operator|<
literal|0
condition|)
name|fatal
argument_list|(
literal|"jitter must be numeric and positive"
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'K'
case|:
name|directory
operator|=
name|isc_commandline_argument
expr_stmt|;
break|break;
case|case
literal|'k'
case|:
if|if
condition|(
name|ndskeys
operator|==
name|MAXDSKEYS
condition|)
name|fatal
argument_list|(
literal|"too many key-signing keys specified"
argument_list|)
expr_stmt|;
name|dskeyfile
index|[
name|ndskeys
operator|++
index|]
operator|=
name|isc_commandline_argument
expr_stmt|;
break|break;
case|case
literal|'l'
case|:
name|len
operator|=
name|strlen
argument_list|(
name|isc_commandline_argument
argument_list|)
expr_stmt|;
name|isc_buffer_init
argument_list|(
operator|&
name|b
argument_list|,
name|isc_commandline_argument
argument_list|,
name|len
argument_list|)
expr_stmt|;
name|isc_buffer_add
argument_list|(
operator|&
name|b
argument_list|,
name|len
argument_list|)
expr_stmt|;
name|dns_fixedname_init
argument_list|(
operator|&
name|dlv_fixed
argument_list|)
expr_stmt|;
name|dlv
operator|=
name|dns_fixedname_name
argument_list|(
operator|&
name|dlv_fixed
argument_list|)
expr_stmt|;
name|result
operator|=
name|dns_name_fromtext
argument_list|(
name|dlv
argument_list|,
operator|&
name|b
argument_list|,
name|dns_rootname
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|check_result
argument_list|(
name|result
argument_list|,
literal|"dns_name_fromtext(dlv)"
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'m'
case|:
break|break;
case|case
literal|'N'
case|:
name|serialformatstr
operator|=
name|isc_commandline_argument
expr_stmt|;
break|break;
case|case
literal|'n'
case|:
name|endp
operator|=
name|NULL
expr_stmt|;
name|ntasks
operator|=
name|strtol
argument_list|(
name|isc_commandline_argument
argument_list|,
operator|&
name|endp
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
operator|*
name|endp
operator|!=
literal|'\0'
operator|||
name|ntasks
operator|>
name|ISC_INT32_MAX
condition|)
name|fatal
argument_list|(
literal|"number of cpus must be numeric"
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'O'
case|:
name|outputformatstr
operator|=
name|isc_commandline_argument
expr_stmt|;
break|break;
case|case
literal|'o'
case|:
name|origin
operator|=
name|isc_commandline_argument
expr_stmt|;
break|break;
case|case
literal|'P'
case|:
name|disable_zone_check
operator|=
name|ISC_TRUE
expr_stmt|;
break|break;
case|case
literal|'p'
case|:
name|pseudorandom
operator|=
name|ISC_TRUE
expr_stmt|;
break|break;
case|case
literal|'r'
case|:
name|setup_entropy
argument_list|(
name|mctx
argument_list|,
name|isc_commandline_argument
argument_list|,
operator|&
name|ectx
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'S'
case|:
name|smartsign
operator|=
name|ISC_TRUE
expr_stmt|;
break|break;
case|case
literal|'s'
case|:
name|startstr
operator|=
name|isc_commandline_argument
expr_stmt|;
break|break;
case|case
literal|'T'
case|:
name|endp
operator|=
name|NULL
expr_stmt|;
name|set_keyttl
operator|=
name|ISC_TRUE
expr_stmt|;
name|keyttl
operator|=
name|strtottl
argument_list|(
name|isc_commandline_argument
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'t'
case|:
name|printstats
operator|=
name|ISC_TRUE
expr_stmt|;
break|break;
case|case
literal|'U'
case|:
comment|/* Undocumented for testing only. */
name|unknownalg
operator|=
name|ISC_TRUE
expr_stmt|;
break|break;
case|case
literal|'u'
case|:
name|update_chain
operator|=
name|ISC_TRUE
expr_stmt|;
break|break;
case|case
literal|'v'
case|:
name|endp
operator|=
name|NULL
expr_stmt|;
name|verbose
operator|=
name|strtol
argument_list|(
name|isc_commandline_argument
argument_list|,
operator|&
name|endp
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
operator|*
name|endp
operator|!=
literal|'\0'
condition|)
name|fatal
argument_list|(
literal|"verbose level must be numeric"
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'x'
case|:
name|keyset_kskonly
operator|=
name|ISC_TRUE
expr_stmt|;
break|break;
case|case
literal|'z'
case|:
name|ignore_kskflag
operator|=
name|ISC_TRUE
expr_stmt|;
break|break;
case|case
literal|'F'
case|:
comment|/* Reserved for FIPS mode */
comment|/* FALLTHROUGH */
case|case
literal|'?'
case|:
if|if
condition|(
name|isc_commandline_option
operator|!=
literal|'?'
condition|)
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"%s: invalid argument -%c\n"
argument_list|,
name|program
argument_list|,
name|isc_commandline_option
argument_list|)
expr_stmt|;
name|usage
argument_list|()
expr_stmt|;
break|break;
default|default:
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"%s: unhandled option -%c\n"
argument_list|,
name|program
argument_list|,
name|isc_commandline_option
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
name|ectx
operator|==
name|NULL
condition|)
name|setup_entropy
argument_list|(
name|mctx
argument_list|,
name|NULL
argument_list|,
operator|&
name|ectx
argument_list|)
expr_stmt|;
name|eflags
operator|=
name|ISC_ENTROPY_BLOCKING
expr_stmt|;
if|if
condition|(
operator|!
name|pseudorandom
condition|)
name|eflags
operator||=
name|ISC_ENTROPY_GOODONLY
expr_stmt|;
name|result
operator|=
name|isc_hash_create
argument_list|(
name|mctx
argument_list|,
name|ectx
argument_list|,
name|DNS_NAME_MAXWIRE
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
name|fatal
argument_list|(
literal|"could not create hash context"
argument_list|)
expr_stmt|;
name|result
operator|=
name|dst_lib_init2
argument_list|(
name|mctx
argument_list|,
name|ectx
argument_list|,
name|engine
argument_list|,
name|eflags
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
name|fatal
argument_list|(
literal|"could not initialize dst: %s"
argument_list|,
name|isc_result_totext
argument_list|(
name|result
argument_list|)
argument_list|)
expr_stmt|;
name|isc_stdtime_get
argument_list|(
operator|&
name|now
argument_list|)
expr_stmt|;
if|if
condition|(
name|startstr
operator|!=
name|NULL
condition|)
block|{
name|starttime
operator|=
name|strtotime
argument_list|(
name|startstr
argument_list|,
name|now
argument_list|,
name|now
argument_list|)
expr_stmt|;
block|}
else|else
name|starttime
operator|=
name|now
operator|-
literal|3600
expr_stmt|;
comment|/* Allow for some clock skew. */
if|if
condition|(
name|endstr
operator|!=
name|NULL
condition|)
block|{
name|endtime
operator|=
name|strtotime
argument_list|(
name|endstr
argument_list|,
name|now
argument_list|,
name|starttime
argument_list|)
expr_stmt|;
block|}
else|else
name|endtime
operator|=
name|starttime
operator|+
operator|(
literal|30
operator|*
literal|24
operator|*
literal|60
operator|*
literal|60
operator|)
expr_stmt|;
if|if
condition|(
name|cycle
operator|==
operator|-
literal|1
condition|)
name|cycle
operator|=
operator|(
name|endtime
operator|-
name|starttime
operator|)
operator|/
literal|4
expr_stmt|;
if|if
condition|(
name|ntasks
operator|==
literal|0
condition|)
name|ntasks
operator|=
name|isc_os_ncpus
argument_list|()
operator|*
literal|2
expr_stmt|;
name|vbprintf
argument_list|(
literal|4
argument_list|,
literal|"using %d cpus\n"
argument_list|,
name|ntasks
argument_list|)
expr_stmt|;
name|rdclass
operator|=
name|strtoclass
argument_list|(
name|classname
argument_list|)
expr_stmt|;
if|if
condition|(
name|directory
operator|==
name|NULL
condition|)
name|directory
operator|=
literal|"."
expr_stmt|;
name|setup_logging
argument_list|(
name|verbose
argument_list|,
name|mctx
argument_list|,
operator|&
name|log
argument_list|)
expr_stmt|;
name|argc
operator|-=
name|isc_commandline_index
expr_stmt|;
name|argv
operator|+=
name|isc_commandline_index
expr_stmt|;
if|if
condition|(
name|argc
operator|<
literal|1
condition|)
name|usage
argument_list|()
expr_stmt|;
name|file
operator|=
name|argv
index|[
literal|0
index|]
expr_stmt|;
name|argc
operator|-=
literal|1
expr_stmt|;
name|argv
operator|+=
literal|1
expr_stmt|;
if|if
condition|(
name|origin
operator|==
name|NULL
condition|)
name|origin
operator|=
name|file
expr_stmt|;
if|if
condition|(
name|output
operator|==
name|NULL
condition|)
block|{
name|free_output
operator|=
name|ISC_TRUE
expr_stmt|;
name|output
operator|=
name|isc_mem_allocate
argument_list|(
name|mctx
argument_list|,
name|strlen
argument_list|(
name|file
argument_list|)
operator|+
name|strlen
argument_list|(
literal|".signed"
argument_list|)
operator|+
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|output
operator|==
name|NULL
condition|)
name|fatal
argument_list|(
literal|"out of memory"
argument_list|)
expr_stmt|;
name|sprintf
argument_list|(
name|output
argument_list|,
literal|"%s.signed"
argument_list|,
name|file
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|inputformatstr
operator|!=
name|NULL
condition|)
block|{
if|if
condition|(
name|strcasecmp
argument_list|(
name|inputformatstr
argument_list|,
literal|"text"
argument_list|)
operator|==
literal|0
condition|)
name|inputformat
operator|=
name|dns_masterformat_text
expr_stmt|;
elseif|else
if|if
condition|(
name|strcasecmp
argument_list|(
name|inputformatstr
argument_list|,
literal|"raw"
argument_list|)
operator|==
literal|0
condition|)
name|inputformat
operator|=
name|dns_masterformat_raw
expr_stmt|;
else|else
name|fatal
argument_list|(
literal|"unknown file format: %s\n"
argument_list|,
name|inputformatstr
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|outputformatstr
operator|!=
name|NULL
condition|)
block|{
if|if
condition|(
name|strcasecmp
argument_list|(
name|outputformatstr
argument_list|,
literal|"text"
argument_list|)
operator|==
literal|0
condition|)
name|outputformat
operator|=
name|dns_masterformat_text
expr_stmt|;
elseif|else
if|if
condition|(
name|strcasecmp
argument_list|(
name|outputformatstr
argument_list|,
literal|"raw"
argument_list|)
operator|==
literal|0
condition|)
name|outputformat
operator|=
name|dns_masterformat_raw
expr_stmt|;
else|else
name|fatal
argument_list|(
literal|"unknown file format: %s\n"
argument_list|,
name|outputformatstr
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|serialformatstr
operator|!=
name|NULL
condition|)
block|{
if|if
condition|(
name|strcasecmp
argument_list|(
name|serialformatstr
argument_list|,
literal|"keep"
argument_list|)
operator|==
literal|0
condition|)
name|serialformat
operator|=
name|SOA_SERIAL_KEEP
expr_stmt|;
elseif|else
if|if
condition|(
name|strcasecmp
argument_list|(
name|serialformatstr
argument_list|,
literal|"increment"
argument_list|)
operator|==
literal|0
operator|||
name|strcasecmp
argument_list|(
name|serialformatstr
argument_list|,
literal|"incr"
argument_list|)
operator|==
literal|0
condition|)
name|serialformat
operator|=
name|SOA_SERIAL_INCREMENT
expr_stmt|;
elseif|else
if|if
condition|(
name|strcasecmp
argument_list|(
name|serialformatstr
argument_list|,
literal|"unixtime"
argument_list|)
operator|==
literal|0
condition|)
name|serialformat
operator|=
name|SOA_SERIAL_UNIXTIME
expr_stmt|;
else|else
name|fatal
argument_list|(
literal|"unknown soa serial format: %s\n"
argument_list|,
name|serialformatstr
argument_list|)
expr_stmt|;
block|}
name|result
operator|=
name|dns_master_stylecreate
argument_list|(
operator|&
name|dsstyle
argument_list|,
name|DNS_STYLEFLAG_NO_TTL
argument_list|,
literal|0
argument_list|,
literal|24
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|8
argument_list|,
name|mctx
argument_list|)
expr_stmt|;
name|check_result
argument_list|(
name|result
argument_list|,
literal|"dns_master_stylecreate"
argument_list|)
expr_stmt|;
name|gdb
operator|=
name|NULL
expr_stmt|;
name|TIME_NOW
argument_list|(
operator|&
name|timer_start
argument_list|)
expr_stmt|;
name|loadzone
argument_list|(
name|file
argument_list|,
name|origin
argument_list|,
name|rdclass
argument_list|,
operator|&
name|gdb
argument_list|)
expr_stmt|;
name|gorigin
operator|=
name|dns_db_origin
argument_list|(
name|gdb
argument_list|)
expr_stmt|;
name|gclass
operator|=
name|dns_db_class
argument_list|(
name|gdb
argument_list|)
expr_stmt|;
name|get_soa_ttls
argument_list|()
expr_stmt|;
if|if
condition|(
operator|!
name|set_keyttl
condition|)
name|keyttl
operator|=
name|soa_ttl
expr_stmt|;
comment|/* 	 * Check for any existing NSEC3 parameters in the zone, 	 * and use them as defaults if -u was not specified. 	 */
if|if
condition|(
name|update_chain
operator|&&
operator|!
name|set_optout
operator|&&
operator|!
name|set_iter
operator|&&
operator|!
name|set_salt
condition|)
name|nsec_datatype
operator|=
name|dns_rdatatype_nsec
expr_stmt|;
else|else
name|set_nsec3params
argument_list|(
name|update_chain
argument_list|,
name|set_salt
argument_list|,
name|set_optout
argument_list|,
name|set_iter
argument_list|)
expr_stmt|;
if|if
condition|(
name|IS_NSEC3
condition|)
block|{
name|isc_boolean_t
name|answer
decl_stmt|;
name|hash_length
operator|=
name|dns_nsec3_hashlength
argument_list|(
name|dns_hash_sha1
argument_list|)
expr_stmt|;
name|hashlist_init
argument_list|(
operator|&
name|hashlist
argument_list|,
name|dns_db_nodecount
argument_list|(
name|gdb
argument_list|)
operator|*
literal|2
argument_list|,
name|hash_length
argument_list|)
expr_stmt|;
name|result
operator|=
name|dns_nsec_nseconly
argument_list|(
name|gdb
argument_list|,
name|gversion
argument_list|,
operator|&
name|answer
argument_list|)
expr_stmt|;
name|check_result
argument_list|(
name|result
argument_list|,
literal|"dns_nsec_nseconly"
argument_list|)
expr_stmt|;
if|if
condition|(
name|answer
condition|)
name|fatal
argument_list|(
literal|"NSEC3 generation requested with "
literal|"NSEC only DNSKEY"
argument_list|)
expr_stmt|;
block|}
comment|/* 	 * We need to do this early on, as we start messing with the list 	 * of keys rather early. 	 */
name|ISC_LIST_INIT
argument_list|(
name|keylist
argument_list|)
expr_stmt|;
name|isc_rwlock_init
argument_list|(
operator|&
name|keylist_lock
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* 	 * Fill keylist with: 	 * 1) Keys listed in the DNSKEY set that have 	 *    private keys associated, *if* no keys were 	 *    set on the command line. 	 * 2) ZSKs set on the command line 	 * 3) KSKs set on the command line 	 * 4) Any keys remaining in the DNSKEY set which 	 *    do not have private keys associated and were 	 *    not specified on the command line. 	 */
if|if
condition|(
name|argc
operator|==
literal|0
operator|||
name|smartsign
condition|)
name|loadzonekeys
argument_list|(
operator|!
name|smartsign
argument_list|,
name|ISC_FALSE
argument_list|)
expr_stmt|;
name|loadexplicitkeys
argument_list|(
name|argv
argument_list|,
name|argc
argument_list|,
name|ISC_FALSE
argument_list|)
expr_stmt|;
name|loadexplicitkeys
argument_list|(
name|dskeyfile
argument_list|,
name|ndskeys
argument_list|,
name|ISC_TRUE
argument_list|)
expr_stmt|;
name|loadzonekeys
argument_list|(
operator|!
name|smartsign
argument_list|,
name|ISC_TRUE
argument_list|)
expr_stmt|;
comment|/* 	 * If we're doing smart signing, look in the key repository for 	 * key files with metadata, and merge them with the keylist 	 * we have now. 	 */
if|if
condition|(
name|smartsign
condition|)
name|build_final_keylist
argument_list|()
expr_stmt|;
comment|/* Now enumerate the key list */
for|for
control|(
name|key
operator|=
name|ISC_LIST_HEAD
argument_list|(
name|keylist
argument_list|)
init|;
name|key
operator|!=
name|NULL
condition|;
name|key
operator|=
name|ISC_LIST_NEXT
argument_list|(
name|key
argument_list|,
name|link
argument_list|)
control|)
block|{
name|key
operator|->
name|index
operator|=
name|keycount
operator|++
expr_stmt|;
block|}
if|if
condition|(
name|keycount
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|disable_zone_check
condition|)
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"%s: warning: No keys specified "
literal|"or found\n"
argument_list|,
name|program
argument_list|)
expr_stmt|;
else|else
name|fatal
argument_list|(
literal|"No signing keys specified or found."
argument_list|)
expr_stmt|;
name|nokeys
operator|=
name|ISC_TRUE
expr_stmt|;
block|}
if|if
condition|(
name|IS_NSEC3
condition|)
block|{
name|unsigned
name|int
name|max
decl_stmt|;
name|result
operator|=
name|dns_nsec3_maxiterations
argument_list|(
name|gdb
argument_list|,
name|NULL
argument_list|,
name|mctx
argument_list|,
operator|&
name|max
argument_list|)
expr_stmt|;
name|check_result
argument_list|(
name|result
argument_list|,
literal|"dns_nsec3_maxiterations()"
argument_list|)
expr_stmt|;
if|if
condition|(
name|nsec3iter
operator|>
name|max
condition|)
name|fatal
argument_list|(
literal|"NSEC3 iterations too big for weakest DNSKEY "
literal|"strength. Maximum iterations allowed %u."
argument_list|,
name|max
argument_list|)
expr_stmt|;
block|}
name|warnifallksk
argument_list|(
name|gdb
argument_list|)
expr_stmt|;
name|gversion
operator|=
name|NULL
expr_stmt|;
name|result
operator|=
name|dns_db_newversion
argument_list|(
name|gdb
argument_list|,
operator|&
name|gversion
argument_list|)
expr_stmt|;
name|check_result
argument_list|(
name|result
argument_list|,
literal|"dns_db_newversion()"
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|serialformat
condition|)
block|{
case|case
name|SOA_SERIAL_INCREMENT
case|:
name|setsoaserial
argument_list|(
literal|0
argument_list|)
expr_stmt|;
break|break;
case|case
name|SOA_SERIAL_UNIXTIME
case|:
name|setsoaserial
argument_list|(
name|now
argument_list|)
expr_stmt|;
break|break;
case|case
name|SOA_SERIAL_KEEP
case|:
default|default:
comment|/* do nothing */
break|break;
block|}
name|remove_duplicates
argument_list|()
expr_stmt|;
if|if
condition|(
name|IS_NSEC3
condition|)
name|nsec3ify
argument_list|(
name|dns_hash_sha1
argument_list|,
name|nsec3iter
argument_list|,
name|salt
argument_list|,
name|salt_length
argument_list|,
operator|&
name|hashlist
argument_list|)
expr_stmt|;
else|else
name|nsecify
argument_list|()
expr_stmt|;
if|if
condition|(
operator|!
name|nokeys
condition|)
block|{
name|writeset
argument_list|(
literal|"dsset-"
argument_list|,
name|dns_rdatatype_ds
argument_list|)
expr_stmt|;
if|if
condition|(
name|make_keyset
condition|)
name|writeset
argument_list|(
literal|"keyset-"
argument_list|,
name|dns_rdatatype_dnskey
argument_list|)
expr_stmt|;
if|if
condition|(
name|dlv
operator|!=
name|NULL
condition|)
block|{
name|writeset
argument_list|(
literal|"dlvset-"
argument_list|,
name|dns_rdatatype_dlv
argument_list|)
expr_stmt|;
block|}
block|}
name|tempfilelen
operator|=
name|strlen
argument_list|(
name|output
argument_list|)
operator|+
literal|20
expr_stmt|;
name|tempfile
operator|=
name|isc_mem_get
argument_list|(
name|mctx
argument_list|,
name|tempfilelen
argument_list|)
expr_stmt|;
if|if
condition|(
name|tempfile
operator|==
name|NULL
condition|)
name|fatal
argument_list|(
literal|"out of memory"
argument_list|)
expr_stmt|;
name|result
operator|=
name|isc_file_mktemplate
argument_list|(
name|output
argument_list|,
name|tempfile
argument_list|,
name|tempfilelen
argument_list|)
expr_stmt|;
name|check_result
argument_list|(
name|result
argument_list|,
literal|"isc_file_mktemplate"
argument_list|)
expr_stmt|;
name|fp
operator|=
name|NULL
expr_stmt|;
name|result
operator|=
name|isc_file_openunique
argument_list|(
name|tempfile
argument_list|,
operator|&
name|fp
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
name|fatal
argument_list|(
literal|"failed to open temporary output file: %s"
argument_list|,
name|isc_result_totext
argument_list|(
name|result
argument_list|)
argument_list|)
expr_stmt|;
name|removefile
operator|=
name|ISC_TRUE
expr_stmt|;
name|setfatalcallback
argument_list|(
operator|&
name|removetempfile
argument_list|)
expr_stmt|;
name|print_time
argument_list|(
name|fp
argument_list|)
expr_stmt|;
name|print_version
argument_list|(
name|fp
argument_list|)
expr_stmt|;
name|result
operator|=
name|isc_taskmgr_create
argument_list|(
name|mctx
argument_list|,
name|ntasks
argument_list|,
literal|0
argument_list|,
operator|&
name|taskmgr
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
name|fatal
argument_list|(
literal|"failed to create task manager: %s"
argument_list|,
name|isc_result_totext
argument_list|(
name|result
argument_list|)
argument_list|)
expr_stmt|;
name|master
operator|=
name|NULL
expr_stmt|;
name|result
operator|=
name|isc_task_create
argument_list|(
name|taskmgr
argument_list|,
literal|0
argument_list|,
operator|&
name|master
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
name|fatal
argument_list|(
literal|"failed to create task: %s"
argument_list|,
name|isc_result_totext
argument_list|(
name|result
argument_list|)
argument_list|)
expr_stmt|;
name|tasks
operator|=
name|isc_mem_get
argument_list|(
name|mctx
argument_list|,
name|ntasks
operator|*
sizeof|sizeof
argument_list|(
name|isc_task_t
operator|*
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|tasks
operator|==
name|NULL
condition|)
name|fatal
argument_list|(
literal|"out of memory"
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
operator|(
name|int
operator|)
name|ntasks
condition|;
name|i
operator|++
control|)
block|{
name|tasks
index|[
name|i
index|]
operator|=
name|NULL
expr_stmt|;
name|result
operator|=
name|isc_task_create
argument_list|(
name|taskmgr
argument_list|,
literal|0
argument_list|,
operator|&
name|tasks
index|[
name|i
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
name|fatal
argument_list|(
literal|"failed to create task: %s"
argument_list|,
name|isc_result_totext
argument_list|(
name|result
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|RUNTIME_CHECK
argument_list|(
name|isc_mutex_init
argument_list|(
operator|&
name|namelock
argument_list|)
operator|==
name|ISC_R_SUCCESS
argument_list|)
expr_stmt|;
if|if
condition|(
name|printstats
condition|)
name|RUNTIME_CHECK
argument_list|(
name|isc_mutex_init
argument_list|(
operator|&
name|statslock
argument_list|)
operator|==
name|ISC_R_SUCCESS
argument_list|)
expr_stmt|;
name|presign
argument_list|()
expr_stmt|;
name|signapex
argument_list|()
expr_stmt|;
if|if
condition|(
operator|!
name|finished
condition|)
block|{
comment|/* 		 * There is more work to do.  Spread it out over multiple 		 * processors if possible. 		 */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
operator|(
name|int
operator|)
name|ntasks
condition|;
name|i
operator|++
control|)
block|{
name|result
operator|=
name|isc_app_onrun
argument_list|(
name|mctx
argument_list|,
name|master
argument_list|,
name|startworker
argument_list|,
name|tasks
index|[
name|i
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
name|fatal
argument_list|(
literal|"failed to start task: %s"
argument_list|,
name|isc_result_totext
argument_list|(
name|result
argument_list|)
argument_list|)
expr_stmt|;
block|}
operator|(
name|void
operator|)
name|isc_app_run
argument_list|()
expr_stmt|;
if|if
condition|(
operator|!
name|finished
condition|)
name|fatal
argument_list|(
literal|"process aborted by user"
argument_list|)
expr_stmt|;
block|}
else|else
name|isc_task_detach
argument_list|(
operator|&
name|master
argument_list|)
expr_stmt|;
name|shuttingdown
operator|=
name|ISC_TRUE
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
operator|(
name|int
operator|)
name|ntasks
condition|;
name|i
operator|++
control|)
name|isc_task_detach
argument_list|(
operator|&
name|tasks
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|isc_taskmgr_destroy
argument_list|(
operator|&
name|taskmgr
argument_list|)
expr_stmt|;
name|isc_mem_put
argument_list|(
name|mctx
argument_list|,
name|tasks
argument_list|,
name|ntasks
operator|*
sizeof|sizeof
argument_list|(
name|isc_task_t
operator|*
argument_list|)
argument_list|)
expr_stmt|;
name|postsign
argument_list|()
expr_stmt|;
name|verifyzone
argument_list|()
expr_stmt|;
if|if
condition|(
name|outputformat
operator|!=
name|dns_masterformat_text
condition|)
block|{
name|result
operator|=
name|dns_master_dumptostream2
argument_list|(
name|mctx
argument_list|,
name|gdb
argument_list|,
name|gversion
argument_list|,
name|masterstyle
argument_list|,
name|outputformat
argument_list|,
name|fp
argument_list|)
expr_stmt|;
name|check_result
argument_list|(
name|result
argument_list|,
literal|"dns_master_dumptostream2"
argument_list|)
expr_stmt|;
block|}
name|result
operator|=
name|isc_stdio_close
argument_list|(
name|fp
argument_list|)
expr_stmt|;
name|check_result
argument_list|(
name|result
argument_list|,
literal|"isc_stdio_close"
argument_list|)
expr_stmt|;
name|removefile
operator|=
name|ISC_FALSE
expr_stmt|;
name|result
operator|=
name|isc_file_rename
argument_list|(
name|tempfile
argument_list|,
name|output
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
name|fatal
argument_list|(
literal|"failed to rename temp file to %s: %s\n"
argument_list|,
name|output
argument_list|,
name|isc_result_totext
argument_list|(
name|result
argument_list|)
argument_list|)
expr_stmt|;
name|DESTROYLOCK
argument_list|(
operator|&
name|namelock
argument_list|)
expr_stmt|;
if|if
condition|(
name|printstats
condition|)
name|DESTROYLOCK
argument_list|(
operator|&
name|statslock
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"%s\n"
argument_list|,
name|output
argument_list|)
expr_stmt|;
name|dns_db_closeversion
argument_list|(
name|gdb
argument_list|,
operator|&
name|gversion
argument_list|,
name|ISC_FALSE
argument_list|)
expr_stmt|;
name|dns_db_detach
argument_list|(
operator|&
name|gdb
argument_list|)
expr_stmt|;
while|while
condition|(
operator|!
name|ISC_LIST_EMPTY
argument_list|(
name|keylist
argument_list|)
condition|)
block|{
name|key
operator|=
name|ISC_LIST_HEAD
argument_list|(
name|keylist
argument_list|)
expr_stmt|;
name|ISC_LIST_UNLINK
argument_list|(
name|keylist
argument_list|,
name|key
argument_list|,
name|link
argument_list|)
expr_stmt|;
name|dns_dnsseckey_destroy
argument_list|(
name|mctx
argument_list|,
operator|&
name|key
argument_list|)
expr_stmt|;
block|}
name|isc_mem_put
argument_list|(
name|mctx
argument_list|,
name|tempfile
argument_list|,
name|tempfilelen
argument_list|)
expr_stmt|;
if|if
condition|(
name|free_output
condition|)
name|isc_mem_free
argument_list|(
name|mctx
argument_list|,
name|output
argument_list|)
expr_stmt|;
name|dns_master_styledestroy
argument_list|(
operator|&
name|dsstyle
argument_list|,
name|mctx
argument_list|)
expr_stmt|;
name|cleanup_logging
argument_list|(
operator|&
name|log
argument_list|)
expr_stmt|;
name|dst_lib_destroy
argument_list|()
expr_stmt|;
name|isc_hash_destroy
argument_list|()
expr_stmt|;
name|cleanup_entropy
argument_list|(
operator|&
name|ectx
argument_list|)
expr_stmt|;
name|dns_name_destroy
argument_list|()
expr_stmt|;
if|if
condition|(
name|verbose
operator|>
literal|10
condition|)
name|isc_mem_stats
argument_list|(
name|mctx
argument_list|,
name|stdout
argument_list|)
expr_stmt|;
name|isc_mem_destroy
argument_list|(
operator|&
name|mctx
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|isc_app_finish
argument_list|()
expr_stmt|;
if|if
condition|(
name|printstats
condition|)
block|{
name|TIME_NOW
argument_list|(
operator|&
name|timer_finish
argument_list|)
expr_stmt|;
name|print_stats
argument_list|(
operator|&
name|timer_start
argument_list|,
operator|&
name|timer_finish
argument_list|)
expr_stmt|;
block|}
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

end_unit


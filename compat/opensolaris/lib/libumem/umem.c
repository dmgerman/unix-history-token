begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * CDDL HEADER START  *  * The contents of this file are subject to the terms of the  * Common Development and Distribution License (the "License").  * You may not use this file except in compliance with the License.  *  * You can obtain a copy of the license at usr/src/OPENSOLARIS.LICENSE  * or http://www.opensolaris.org/os/licensing.  * See the License for the specific language governing permissions  * and limitations under the License.  *  * When distributing Covered Code, include this CDDL HEADER in each  * file and include the License file at usr/src/OPENSOLARIS.LICENSE.  * If applicable, add the following below this CDDL HEADER, with the  * fields enclosed by brackets "[]" replaced with your own identifying  * information: Portions Copyright [yyyy] [name of copyright owner]  *  * CDDL HEADER END  */
end_comment

begin_comment
comment|/*  * Copyright 2006 Ricardo Correia.  All rights reserved.  * Use is subject to license terms.  */
end_comment

begin_include
include|#
directive|include
file|<umem.h>
end_include

begin_include
include|#
directive|include
file|<stdlib.h>
end_include

begin_include
include|#
directive|include
file|<assert.h>
end_include

begin_decl_stmt
specifier|static
name|umem_nofail_callback_t
modifier|*
name|nofail_cb
init|=
name|NULL
decl_stmt|;
end_decl_stmt

begin_struct
struct|struct
name|umem_cache
block|{
name|umem_constructor_t
modifier|*
name|constructor
decl_stmt|;
name|umem_destructor_t
modifier|*
name|destructor
decl_stmt|;
name|void
modifier|*
name|callback_data
decl_stmt|;
name|size_t
name|bufsize
decl_stmt|;
block|}
struct|;
end_struct

begin_comment
comment|/*  * Simple stub for umem_alloc(). The callback isn't expected to return.  */
end_comment

begin_function
name|void
modifier|*
name|umem_alloc
parameter_list|(
name|size_t
name|size
parameter_list|,
name|int
name|flags
parameter_list|)
block|{
name|assert
argument_list|(
name|flags
operator|==
name|UMEM_DEFAULT
operator|||
name|flags
operator|==
name|UMEM_NOFAIL
argument_list|)
expr_stmt|;
if|if
condition|(
name|size
operator|==
literal|0
condition|)
return|return
name|NULL
return|;
name|void
modifier|*
name|ret
init|=
name|malloc
argument_list|(
name|size
argument_list|)
decl_stmt|;
if|if
condition|(
name|ret
operator|==
name|NULL
condition|)
block|{
if|if
condition|(
operator|!
operator|(
name|flags
operator|&
name|UMEM_NOFAIL
operator|)
condition|)
return|return
name|NULL
return|;
if|if
condition|(
name|nofail_cb
operator|!=
name|NULL
condition|)
name|nofail_cb
argument_list|()
expr_stmt|;
name|abort
argument_list|()
expr_stmt|;
block|}
return|return
name|ret
return|;
block|}
end_function

begin_comment
comment|/*  * Simple stub for umem_zalloc().  */
end_comment

begin_function
name|void
modifier|*
name|umem_zalloc
parameter_list|(
name|size_t
name|size
parameter_list|,
name|int
name|flags
parameter_list|)
block|{
name|assert
argument_list|(
name|flags
operator|==
name|UMEM_DEFAULT
operator|||
name|flags
operator|==
name|UMEM_NOFAIL
argument_list|)
expr_stmt|;
if|if
condition|(
name|size
operator|==
literal|0
condition|)
return|return
name|NULL
return|;
name|void
modifier|*
name|ret
init|=
name|calloc
argument_list|(
literal|1
argument_list|,
name|size
argument_list|)
decl_stmt|;
if|if
condition|(
name|ret
operator|==
name|NULL
condition|)
block|{
if|if
condition|(
operator|!
operator|(
name|flags
operator|&
name|UMEM_NOFAIL
operator|)
condition|)
return|return
name|NULL
return|;
if|if
condition|(
name|nofail_cb
operator|!=
name|NULL
condition|)
name|nofail_cb
argument_list|()
expr_stmt|;
name|abort
argument_list|()
expr_stmt|;
block|}
return|return
name|ret
return|;
block|}
end_function

begin_comment
comment|/*  * Simple stub for umem_free().  */
end_comment

begin_function
name|void
name|umem_free
parameter_list|(
name|void
modifier|*
name|buf
parameter_list|,
name|size_t
name|size
parameter_list|)
block|{
name|free
argument_list|(
name|buf
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * Simple stub for umem_nofail_callback().  */
end_comment

begin_function
name|void
name|umem_nofail_callback
parameter_list|(
name|umem_nofail_callback_t
modifier|*
name|callback
parameter_list|)
block|{
name|nofail_cb
operator|=
name|callback
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * Simple stub for umem_cache_create().  */
end_comment

begin_function
name|umem_cache_t
modifier|*
name|umem_cache_create
parameter_list|(
name|char
modifier|*
name|debug_name
parameter_list|,
name|size_t
name|bufsize
parameter_list|,
name|size_t
name|align
parameter_list|,
name|umem_constructor_t
modifier|*
name|constructor
parameter_list|,
name|umem_destructor_t
modifier|*
name|destructor
parameter_list|,
name|umem_reclaim_t
modifier|*
name|reclaim
parameter_list|,
name|void
modifier|*
name|callback_data
parameter_list|,
name|void
modifier|*
name|source
parameter_list|,
name|int
name|cflags
parameter_list|)
block|{
name|assert
argument_list|(
name|source
operator|==
name|NULL
argument_list|)
expr_stmt|;
name|umem_cache_t
modifier|*
name|cache
init|=
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
name|umem_cache_t
argument_list|)
argument_list|)
decl_stmt|;
if|if
condition|(
name|cache
operator|==
name|NULL
condition|)
return|return
name|NULL
return|;
name|cache
operator|->
name|constructor
operator|=
name|constructor
expr_stmt|;
name|cache
operator|->
name|destructor
operator|=
name|destructor
expr_stmt|;
name|cache
operator|->
name|callback_data
operator|=
name|callback_data
expr_stmt|;
name|cache
operator|->
name|bufsize
operator|=
name|bufsize
expr_stmt|;
return|return
name|cache
return|;
block|}
end_function

begin_comment
comment|/*  * Simple stub for umem_cache_alloc(). The nofail callback isn't expected to return.  */
end_comment

begin_function
name|void
modifier|*
name|umem_cache_alloc
parameter_list|(
name|umem_cache_t
modifier|*
name|cache
parameter_list|,
name|int
name|flags
parameter_list|)
block|{
name|void
modifier|*
name|buf
init|=
name|malloc
argument_list|(
name|cache
operator|->
name|bufsize
argument_list|)
decl_stmt|;
if|if
condition|(
name|buf
operator|==
name|NULL
condition|)
block|{
if|if
condition|(
operator|!
operator|(
name|flags
operator|&
name|UMEM_NOFAIL
operator|)
condition|)
return|return
name|NULL
return|;
if|if
condition|(
name|nofail_cb
operator|!=
name|NULL
condition|)
name|nofail_cb
argument_list|()
expr_stmt|;
name|abort
argument_list|()
expr_stmt|;
block|}
if|if
condition|(
name|cache
operator|->
name|constructor
operator|!=
name|NULL
condition|)
block|{
if|if
condition|(
name|cache
operator|->
name|constructor
argument_list|(
name|buf
argument_list|,
name|cache
operator|->
name|callback_data
argument_list|,
name|flags
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|free
argument_list|(
name|buf
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|flags
operator|&
name|UMEM_NOFAIL
operator|)
condition|)
return|return
name|NULL
return|;
if|if
condition|(
name|nofail_cb
operator|!=
name|NULL
condition|)
name|nofail_cb
argument_list|()
expr_stmt|;
name|abort
argument_list|()
expr_stmt|;
block|}
block|}
return|return
name|buf
return|;
block|}
end_function

begin_comment
comment|/*  * Simple stub for umem_cache_free().  */
end_comment

begin_function
name|void
name|umem_cache_free
parameter_list|(
name|umem_cache_t
modifier|*
name|cache
parameter_list|,
name|void
modifier|*
name|buffer
parameter_list|)
block|{
if|if
condition|(
name|cache
operator|->
name|destructor
operator|!=
name|NULL
condition|)
name|cache
operator|->
name|destructor
argument_list|(
name|buffer
argument_list|,
name|cache
operator|->
name|callback_data
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|buffer
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * Simple stub for umem_cache_destroy().  */
end_comment

begin_function
name|void
name|umem_cache_destroy
parameter_list|(
name|umem_cache_t
modifier|*
name|cache
parameter_list|)
block|{
name|free
argument_list|(
name|cache
argument_list|)
expr_stmt|;
block|}
end_function

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_ifndef
ifndef|#
directive|ifndef
name|lint
end_ifndef

begin_decl_stmt
specifier|static
name|char
name|sccsid
index|[]
init|=
literal|"@(#)tc.c	1.2	(CWI)	1.2	85/03/26"
decl_stmt|;
end_decl_stmt

begin_endif
endif|#
directive|endif
endif|lint
end_endif

begin_comment
comment|/*  *	drive 4014 scope  */
end_comment

begin_comment
comment|/* output language from troff: all numbers are character strings  sn	size in points fn	font as number from 1-n cx	ascii character x Cxyz	funny char xyz. terminated by white space Hn	go to absolute horizontal position n Vn	go to absolute vertical position n (down is positive) hn	go n units horizontally (relative) vn	ditto vertically nnc	move right nn, then print c (exactly 2 digits!) 		(this wart is an optimization that shrinks output file size 		 about 35% and run-time about 15% while preserving ascii-ness) Dt ...\n	draw operation 't': 	Dl x y		line from here by x,y 	Dc d		circle of diameter d with left side here 	De x y		ellipse of axes x,y with left side here 	Da x y r	arc counter-clockwise by x,y of radius r 	D~ x y x y ...	wiggly line by x,y then x,y ... nb a	end of line (information only -- no action needed) 	b = space before line, a = after p	new page begins -- set v to 0 #...\n	comment x ...\n	device control functions: 	x i	init 	x T s	name of device is s 	x r n h v	resolution is n/inch 		h = min horizontal motion, v = min vert 	x p	pause (can restart) 	x s	stop -- done for ever 	x t	generate trailer 	x f n s	font position n contains font s 	x H n	set character height to n 	x S n	set slant to N  	Subcommands like "i" are often spelled out like "init". */
end_comment

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_include
include|#
directive|include
file|<signal.h>
end_include

begin_include
include|#
directive|include
file|<ctype.h>
end_include

begin_include
include|#
directive|include
file|"../dev.h"
end_include

begin_define
define|#
directive|define
name|NFONT
value|10
end_define

begin_decl_stmt
name|int
name|output
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* do we do output at all? */
end_comment

begin_decl_stmt
name|int
name|nolist
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* output page list if> 0 */
end_comment

begin_decl_stmt
name|int
name|olist
index|[
literal|20
index|]
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* pairs of page numbers */
end_comment

begin_decl_stmt
name|int
name|erase
init|=
literal|1
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|float
name|aspect
init|=
literal|1.5
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* default aspect ratio */
end_comment

begin_function_decl
name|int
function_decl|(
modifier|*
name|sigint
function_decl|)
parameter_list|()
function_decl|;
end_function_decl

begin_function_decl
name|int
function_decl|(
modifier|*
name|sigquit
function_decl|)
parameter_list|()
function_decl|;
end_function_decl

begin_decl_stmt
name|struct
name|dev
name|dev
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|struct
name|font
modifier|*
name|fontbase
index|[
name|NFONT
index|]
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|short
name|psizes
index|[]
init|=
block|{
literal|11
block|,
literal|16
block|,
literal|22
block|,
literal|36
block|,
literal|0
block|}
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* approx sizes available */
end_comment

begin_decl_stmt
name|short
modifier|*
name|pstab
init|=
name|psizes
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|nsizes
init|=
literal|4
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|pscode
index|[]
init|=
block|{
literal|';'
block|,
literal|':'
block|,
literal|'9'
block|,
literal|'8'
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|nfonts
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|smnt
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* index of first special font */
end_comment

begin_decl_stmt
name|int
name|nchtab
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|char
modifier|*
name|chname
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|short
modifier|*
name|chtab
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|char
modifier|*
name|fitab
index|[
name|NFONT
index|]
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|char
modifier|*
name|widthtab
index|[
name|NFONT
index|]
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* widtab would be a better name */
end_comment

begin_decl_stmt
name|char
modifier|*
name|codetab
index|[
name|NFONT
index|]
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* device codes */
end_comment

begin_define
define|#
directive|define
name|FATAL
value|1
end_define

begin_define
define|#
directive|define
name|BMASK
value|0377
end_define

begin_decl_stmt
name|int
name|keepon
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|dbg
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|long
name|lineno
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|res
init|=
literal|972
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* input assumed computed according to this resolution */
end_comment

begin_comment
comment|/* initial value to avoid 0 divide */
end_comment

begin_decl_stmt
name|FILE
modifier|*
name|tf
init|=
name|stdout
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* output file */
end_comment

begin_decl_stmt
name|char
modifier|*
name|fontdir
init|=
literal|"/usr/lib/font"
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|extern
name|char
name|devname
index|[]
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|FILE
modifier|*
name|fp
init|=
name|stdin
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* input file pointer */
end_comment

begin_function
name|main
parameter_list|(
name|argc
parameter_list|,
name|argv
parameter_list|)
name|char
modifier|*
name|argv
index|[]
decl_stmt|;
block|{
name|char
name|buf
index|[
name|BUFSIZ
index|]
decl_stmt|;
name|float
name|atof
parameter_list|()
function_decl|;
name|int
name|done
parameter_list|()
function_decl|;
name|setbuf
argument_list|(
name|stdout
argument_list|,
name|buf
argument_list|)
expr_stmt|;
while|while
condition|(
name|argc
operator|>
literal|1
operator|&&
name|argv
index|[
literal|1
index|]
index|[
literal|0
index|]
operator|==
literal|'-'
condition|)
block|{
switch|switch
condition|(
name|argv
index|[
literal|1
index|]
index|[
literal|1
index|]
condition|)
block|{
case|case
literal|'T'
case|:
if|if
condition|(
name|strcmp
argument_list|(
operator|&
name|argv
index|[
literal|1
index|]
index|[
literal|2
index|]
argument_list|,
literal|"cat"
argument_list|)
operator|==
literal|0
condition|)
block|{
comment|/* use the old one */
if|if
condition|(
name|fork
argument_list|()
operator|==
literal|0
condition|)
block|{
name|execv
argument_list|(
literal|"/usr/bin/oldtc"
argument_list|,
name|argv
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"tc: can't find oldtc\n"
argument_list|)
expr_stmt|;
block|}
name|wait
argument_list|()
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
literal|'a'
case|:
name|aspect
operator|=
name|atof
argument_list|(
operator|&
name|argv
index|[
literal|1
index|]
index|[
literal|2
index|]
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'e'
case|:
name|erase
operator|=
literal|0
expr_stmt|;
break|break;
case|case
literal|'o'
case|:
name|outlist
argument_list|(
operator|&
name|argv
index|[
literal|1
index|]
index|[
literal|2
index|]
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'d'
case|:
name|dbg
operator|=
name|atoi
argument_list|(
operator|&
name|argv
index|[
literal|1
index|]
index|[
literal|2
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|dbg
operator|==
literal|0
condition|)
name|dbg
operator|=
literal|1
expr_stmt|;
break|break;
case|case
literal|'c'
case|:
name|keepon
operator|=
literal|1
expr_stmt|;
break|break;
block|}
name|argc
operator|--
expr_stmt|;
name|argv
operator|++
expr_stmt|;
block|}
name|sigint
operator|=
name|signal
argument_list|(
name|SIGINT
argument_list|,
name|done
argument_list|)
expr_stmt|;
name|sigquit
operator|=
name|signal
argument_list|(
name|SIGQUIT
argument_list|,
name|SIG_IGN
argument_list|)
expr_stmt|;
if|if
condition|(
name|argc
operator|<=
literal|1
condition|)
name|conv
argument_list|(
name|stdin
argument_list|)
expr_stmt|;
else|else
while|while
condition|(
operator|--
name|argc
operator|>
literal|0
condition|)
block|{
if|if
condition|(
name|strcmp
argument_list|(
operator|*
operator|++
name|argv
argument_list|,
literal|"-"
argument_list|)
operator|==
literal|0
condition|)
name|fp
operator|=
name|stdin
expr_stmt|;
elseif|else
if|if
condition|(
operator|(
name|fp
operator|=
name|fopen
argument_list|(
operator|*
name|argv
argument_list|,
literal|"r"
argument_list|)
operator|)
operator|==
name|NULL
condition|)
name|error
argument_list|(
name|FATAL
argument_list|,
literal|"can't open %s"
argument_list|,
operator|*
name|argv
argument_list|)
expr_stmt|;
name|conv
argument_list|(
name|fp
argument_list|)
expr_stmt|;
name|fclose
argument_list|(
name|fp
argument_list|)
expr_stmt|;
block|}
name|done
argument_list|()
expr_stmt|;
block|}
end_function

begin_macro
name|outlist
argument_list|(
argument|s
argument_list|)
end_macro

begin_comment
comment|/* process list of page numbers to be printed */
end_comment

begin_decl_stmt
name|char
modifier|*
name|s
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|int
name|n1
decl_stmt|,
name|n2
decl_stmt|,
name|i
decl_stmt|;
name|nolist
operator|=
literal|0
expr_stmt|;
while|while
condition|(
operator|*
name|s
condition|)
block|{
name|n1
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|isdigit
argument_list|(
operator|*
name|s
argument_list|)
condition|)
do|do
name|n1
operator|=
literal|10
operator|*
name|n1
operator|+
operator|*
name|s
operator|++
operator|-
literal|'0'
expr_stmt|;
do|while
condition|(
name|isdigit
argument_list|(
operator|*
name|s
argument_list|)
condition|)
do|;
else|else
name|n1
operator|=
operator|-
literal|9999
expr_stmt|;
name|n2
operator|=
name|n1
expr_stmt|;
if|if
condition|(
operator|*
name|s
operator|==
literal|'-'
condition|)
block|{
name|s
operator|++
expr_stmt|;
name|n2
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|isdigit
argument_list|(
operator|*
name|s
argument_list|)
condition|)
do|do
name|n2
operator|=
literal|10
operator|*
name|n2
operator|+
operator|*
name|s
operator|++
operator|-
literal|'0'
expr_stmt|;
do|while
condition|(
name|isdigit
argument_list|(
operator|*
name|s
argument_list|)
condition|)
do|;
else|else
name|n2
operator|=
literal|9999
expr_stmt|;
block|}
name|olist
index|[
name|nolist
operator|++
index|]
operator|=
name|n1
expr_stmt|;
name|olist
index|[
name|nolist
operator|++
index|]
operator|=
name|n2
expr_stmt|;
if|if
condition|(
operator|*
name|s
operator|!=
literal|'\0'
condition|)
name|s
operator|++
expr_stmt|;
block|}
name|olist
index|[
name|nolist
index|]
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|dbg
condition|)
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|nolist
condition|;
name|i
operator|+=
literal|2
control|)
name|printf
argument_list|(
literal|"%3d %3d\n"
argument_list|,
name|olist
index|[
name|i
index|]
argument_list|,
name|olist
index|[
name|i
operator|+
literal|1
index|]
argument_list|)
expr_stmt|;
block|}
end_block

begin_macro
name|in_olist
argument_list|(
argument|n
argument_list|)
end_macro

begin_comment
comment|/* is n in olist? */
end_comment

begin_decl_stmt
name|int
name|n
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|int
name|i
decl_stmt|;
if|if
condition|(
name|nolist
operator|==
literal|0
condition|)
return|return
operator|(
literal|1
operator|)
return|;
comment|/* everything is included */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|nolist
condition|;
name|i
operator|+=
literal|2
control|)
if|if
condition|(
name|n
operator|>=
name|olist
index|[
name|i
index|]
operator|&&
name|n
operator|<=
name|olist
index|[
name|i
operator|+
literal|1
index|]
condition|)
return|return
operator|(
literal|1
operator|)
return|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_block

begin_expr_stmt
name|conv
argument_list|(
name|fp
argument_list|)
specifier|register
name|FILE
operator|*
name|fp
expr_stmt|;
end_expr_stmt

begin_block
block|{
specifier|register
name|int
name|c
decl_stmt|,
name|k
decl_stmt|;
name|int
name|m
decl_stmt|,
name|n
decl_stmt|,
name|i
decl_stmt|,
name|n1
decl_stmt|,
name|m1
decl_stmt|;
name|char
name|str
index|[
literal|100
index|]
decl_stmt|,
name|buf
index|[
literal|300
index|]
decl_stmt|;
while|while
condition|(
operator|(
name|c
operator|=
name|getc
argument_list|(
name|fp
argument_list|)
operator|)
operator|!=
name|EOF
condition|)
block|{
switch|switch
condition|(
name|c
condition|)
block|{
case|case
literal|'\n'
case|:
comment|/* when input is text */
name|lineno
operator|++
expr_stmt|;
case|case
literal|' '
case|:
case|case
literal|0
case|:
comment|/* occasional noise creeps in */
break|break;
case|case
literal|'{'
case|:
comment|/* push down current environment */
name|t_push
argument_list|()
expr_stmt|;
break|break;
case|case
literal|'}'
case|:
name|t_pop
argument_list|()
expr_stmt|;
break|break;
case|case
literal|'0'
case|:
case|case
literal|'1'
case|:
case|case
literal|'2'
case|:
case|case
literal|'3'
case|:
case|case
literal|'4'
case|:
case|case
literal|'5'
case|:
case|case
literal|'6'
case|:
case|case
literal|'7'
case|:
case|case
literal|'8'
case|:
case|case
literal|'9'
case|:
comment|/* two motion digits plus a character */
name|hmot
argument_list|(
operator|(
name|c
operator|-
literal|'0'
operator|)
operator|*
literal|10
operator|+
name|getc
argument_list|(
name|fp
argument_list|)
operator|-
literal|'0'
argument_list|)
expr_stmt|;
name|put1
argument_list|(
name|getc
argument_list|(
name|fp
argument_list|)
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'c'
case|:
comment|/* single ascii character */
name|put1
argument_list|(
name|getc
argument_list|(
name|fp
argument_list|)
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'C'
case|:
name|fscanf
argument_list|(
name|fp
argument_list|,
literal|"%s"
argument_list|,
name|str
argument_list|)
expr_stmt|;
name|put1s
argument_list|(
name|str
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'t'
case|:
comment|/* straight text */
name|fgets
argument_list|(
name|buf
argument_list|,
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
argument_list|,
name|fp
argument_list|)
expr_stmt|;
name|lineno
operator|++
expr_stmt|;
name|t_text
argument_list|(
name|buf
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'D'
case|:
comment|/* draw function */
name|fgets
argument_list|(
name|buf
argument_list|,
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
argument_list|,
name|fp
argument_list|)
expr_stmt|;
name|lineno
operator|++
expr_stmt|;
switch|switch
condition|(
name|buf
index|[
literal|0
index|]
condition|)
block|{
case|case
literal|'l'
case|:
comment|/* draw a line */
name|sscanf
argument_list|(
name|buf
operator|+
literal|1
argument_list|,
literal|"%d %d"
argument_list|,
operator|&
name|n
argument_list|,
operator|&
name|m
argument_list|)
expr_stmt|;
name|drawline
argument_list|(
name|n
argument_list|,
name|m
argument_list|,
literal|"."
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'c'
case|:
comment|/* circle */
name|sscanf
argument_list|(
name|buf
operator|+
literal|1
argument_list|,
literal|"%d"
argument_list|,
operator|&
name|n
argument_list|)
expr_stmt|;
name|drawcirc
argument_list|(
name|n
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'e'
case|:
comment|/* ellipse */
name|sscanf
argument_list|(
name|buf
operator|+
literal|1
argument_list|,
literal|"%d %d"
argument_list|,
operator|&
name|m
argument_list|,
operator|&
name|n
argument_list|)
expr_stmt|;
name|drawellip
argument_list|(
name|m
argument_list|,
name|n
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'a'
case|:
comment|/* arc */
name|sscanf
argument_list|(
name|buf
operator|+
literal|1
argument_list|,
literal|"%d %d %d %d"
argument_list|,
operator|&
name|n
argument_list|,
operator|&
name|m
argument_list|,
operator|&
name|n1
argument_list|,
operator|&
name|m1
argument_list|)
expr_stmt|;
name|drawarc
argument_list|(
name|n
argument_list|,
name|m
argument_list|,
name|n1
argument_list|,
name|m1
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'~'
case|:
comment|/* wiggly line */
name|drawwig
argument_list|(
name|buf
operator|+
literal|1
argument_list|)
expr_stmt|;
break|break;
default|default:
name|error
argument_list|(
name|FATAL
argument_list|,
literal|"unknown drawing function %s\n"
argument_list|,
name|buf
argument_list|)
expr_stmt|;
break|break;
block|}
break|break;
case|case
literal|'s'
case|:
name|fscanf
argument_list|(
name|fp
argument_list|,
literal|"%d"
argument_list|,
operator|&
name|n
argument_list|)
expr_stmt|;
comment|/* ignore fractional sizes */
name|setsize
argument_list|(
name|t_size
argument_list|(
name|n
argument_list|)
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'f'
case|:
name|fscanf
argument_list|(
name|fp
argument_list|,
literal|"%s"
argument_list|,
name|str
argument_list|)
expr_stmt|;
name|setfont
argument_list|(
name|t_font
argument_list|(
name|str
argument_list|)
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'H'
case|:
comment|/* absolute horizontal motion */
comment|/* fscanf(fp, "%d",&n); */
while|while
condition|(
operator|(
name|c
operator|=
name|getc
argument_list|(
name|fp
argument_list|)
operator|)
operator|==
literal|' '
condition|)
empty_stmt|;
name|k
operator|=
literal|0
expr_stmt|;
do|do
block|{
name|k
operator|=
literal|10
operator|*
name|k
operator|+
name|c
operator|-
literal|'0'
expr_stmt|;
block|}
do|while
condition|(
name|isdigit
argument_list|(
name|c
operator|=
name|getc
argument_list|(
name|fp
argument_list|)
argument_list|)
condition|)
do|;
name|ungetc
argument_list|(
name|c
argument_list|,
name|fp
argument_list|)
expr_stmt|;
name|hgoto
argument_list|(
name|k
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'h'
case|:
comment|/* relative horizontal motion */
comment|/* fscanf(fp, "%d",&n); */
while|while
condition|(
operator|(
name|c
operator|=
name|getc
argument_list|(
name|fp
argument_list|)
operator|)
operator|==
literal|' '
condition|)
empty_stmt|;
name|k
operator|=
literal|0
expr_stmt|;
do|do
block|{
name|k
operator|=
literal|10
operator|*
name|k
operator|+
name|c
operator|-
literal|'0'
expr_stmt|;
block|}
do|while
condition|(
name|isdigit
argument_list|(
name|c
operator|=
name|getc
argument_list|(
name|fp
argument_list|)
argument_list|)
condition|)
do|;
name|ungetc
argument_list|(
name|c
argument_list|,
name|fp
argument_list|)
expr_stmt|;
name|hmot
argument_list|(
name|k
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'w'
case|:
comment|/* word space */
break|break;
case|case
literal|'V'
case|:
name|fscanf
argument_list|(
name|fp
argument_list|,
literal|"%d"
argument_list|,
operator|&
name|n
argument_list|)
expr_stmt|;
name|vgoto
argument_list|(
name|n
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'v'
case|:
name|fscanf
argument_list|(
name|fp
argument_list|,
literal|"%d"
argument_list|,
operator|&
name|n
argument_list|)
expr_stmt|;
name|vmot
argument_list|(
name|n
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'p'
case|:
comment|/* new page */
name|fscanf
argument_list|(
name|fp
argument_list|,
literal|"%d"
argument_list|,
operator|&
name|n
argument_list|)
expr_stmt|;
name|t_page
argument_list|(
name|n
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'n'
case|:
comment|/* end of line */
while|while
condition|(
name|getc
argument_list|(
name|fp
argument_list|)
operator|!=
literal|'\n'
condition|)
empty_stmt|;
name|t_newline
argument_list|()
expr_stmt|;
break|break;
case|case
literal|'#'
case|:
comment|/* comment */
while|while
condition|(
name|getc
argument_list|(
name|fp
argument_list|)
operator|!=
literal|'\n'
condition|)
empty_stmt|;
name|lineno
operator|++
expr_stmt|;
break|break;
case|case
literal|'x'
case|:
comment|/* device control */
name|devcntrl
argument_list|(
name|fp
argument_list|)
expr_stmt|;
name|lineno
operator|++
expr_stmt|;
break|break;
default|default:
name|error
argument_list|(
operator|!
name|FATAL
argument_list|,
literal|"unknown input character %o %c\n"
argument_list|,
name|c
argument_list|,
name|c
argument_list|)
expr_stmt|;
while|while
condition|(
name|getc
argument_list|(
name|fp
argument_list|)
operator|!=
literal|'\n'
condition|)
empty_stmt|;
block|}
block|}
block|}
end_block

begin_macro
name|devcntrl
argument_list|(
argument|fp
argument_list|)
end_macro

begin_comment
comment|/* interpret device control functions */
end_comment

begin_decl_stmt
name|FILE
modifier|*
name|fp
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|char
name|str
index|[
literal|20
index|]
decl_stmt|;
name|int
name|c
decl_stmt|,
name|n
decl_stmt|;
name|fscanf
argument_list|(
name|fp
argument_list|,
literal|"%s"
argument_list|,
name|str
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|str
index|[
literal|0
index|]
condition|)
block|{
comment|/* crude for now */
case|case
literal|'i'
case|:
comment|/* initialize */
name|fileinit
argument_list|()
expr_stmt|;
name|t_init
argument_list|(
literal|0
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'T'
case|:
comment|/* device name */
name|fscanf
argument_list|(
name|fp
argument_list|,
literal|"%s"
argument_list|,
name|devname
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'t'
case|:
comment|/* trailer */
name|t_trailer
argument_list|()
expr_stmt|;
break|break;
case|case
literal|'p'
case|:
comment|/* pause -- can restart */
name|t_reset
argument_list|(
literal|'p'
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'s'
case|:
comment|/* stop */
name|t_reset
argument_list|(
literal|'s'
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'r'
case|:
comment|/* resolution assumed when prepared */
name|fscanf
argument_list|(
name|fp
argument_list|,
literal|"%d"
argument_list|,
operator|&
name|res
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'f'
case|:
comment|/* font used */
name|fscanf
argument_list|(
name|fp
argument_list|,
literal|"%d %s"
argument_list|,
operator|&
name|n
argument_list|,
name|str
argument_list|)
expr_stmt|;
name|loadfont
argument_list|(
name|n
argument_list|,
name|str
argument_list|)
expr_stmt|;
break|break;
block|}
while|while
condition|(
name|getc
argument_list|(
name|fp
argument_list|)
operator|!=
literal|'\n'
condition|)
comment|/* skip rest of input line */
empty_stmt|;
block|}
end_block

begin_macro
name|fileinit
argument_list|()
end_macro

begin_comment
comment|/* read in font and code files, etc. */
end_comment

begin_block
block|{ }
end_block

begin_macro
name|fontprint
argument_list|(
argument|i
argument_list|)
end_macro

begin_comment
comment|/* debugging print of font i (0,...) */
end_comment

begin_block
block|{ }
end_block

begin_macro
name|loadcode
argument_list|(
argument|n
argument_list|,
argument|nw
argument_list|)
end_macro

begin_comment
comment|/* load codetab on position n (0...); #chars is nw */
end_comment

begin_decl_stmt
name|int
name|n
decl_stmt|,
name|nw
decl_stmt|;
end_decl_stmt

begin_block
block|{ }
end_block

begin_macro
name|loadfont
argument_list|(
argument|n
argument_list|,
argument|s
argument_list|)
end_macro

begin_comment
comment|/* load font info for font s on position n (1...) */
end_comment

begin_decl_stmt
name|int
name|n
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|char
modifier|*
name|s
decl_stmt|;
end_decl_stmt

begin_block
block|{ }
end_block

begin_define
define|#
directive|define
name|ESC
value|033
end_define

begin_define
define|#
directive|define
name|MAXY
value|(3071-100)
end_define

begin_define
define|#
directive|define
name|US
value|037
end_define

begin_comment
comment|/* text mode */
end_comment

begin_define
define|#
directive|define
name|GS
value|035
end_define

begin_comment
comment|/* graphics mode */
end_comment

begin_define
define|#
directive|define
name|FF
value|014
end_define

begin_macro
name|error
argument_list|(
argument|f
argument_list|,
argument|s
argument_list|,
argument|a1
argument_list|,
argument|a2
argument_list|,
argument|a3
argument_list|,
argument|a4
argument_list|,
argument|a5
argument_list|,
argument|a6
argument_list|,
argument|a7
argument_list|)
end_macro

begin_block
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"%c%c%c"
argument_list|,
name|US
argument_list|,
name|ESC
argument_list|,
literal|';'
argument_list|)
expr_stmt|;
comment|/* reset terminal sensibly */
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"tc: "
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
name|s
argument_list|,
name|a1
argument_list|,
name|a2
argument_list|,
name|a3
argument_list|,
name|a4
argument_list|,
name|a5
argument_list|,
name|a6
argument_list|,
name|a7
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|" near line %ld\n"
argument_list|,
name|lineno
argument_list|)
expr_stmt|;
if|if
condition|(
name|f
condition|)
name|done
argument_list|(
literal|2
argument_list|)
expr_stmt|;
block|}
end_block

begin_comment
comment|/* 	Here beginneth all the stuff that really depends 	on the 202 (we hope). */
end_comment

begin_decl_stmt
name|char
name|devname
index|[
literal|20
index|]
init|=
literal|"4014"
decl_stmt|;
end_decl_stmt

begin_define
define|#
directive|define
name|oput
parameter_list|(
name|c
parameter_list|)
value|if (output) putchar(c); else;
end_define

begin_decl_stmt
name|int
name|stopped
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|ohx
init|=
operator|-
literal|1
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|ohy
init|=
operator|-
literal|1
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|oxb
init|=
operator|-
literal|1
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|oly
init|=
operator|-
literal|1
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|olx
init|=
operator|-
literal|1
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|skip
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|size
init|=
literal|1
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|font
init|=
literal|1
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* current font */
end_comment

begin_decl_stmt
name|int
name|hpos
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* horizontal position where we are supposed to be next (left = 0) */
end_comment

begin_decl_stmt
name|int
name|vpos
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* current vertical position (down positive) */
end_comment

begin_decl_stmt
name|int
name|horig
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* h origin of current block; hpos rel to this */
end_comment

begin_decl_stmt
name|int
name|vorig
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* v origin of current block; vpos rel to this */
end_comment

begin_decl_stmt
name|int
name|DX
init|=
literal|10
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* step size in x for drawing */
end_comment

begin_decl_stmt
name|int
name|DY
init|=
literal|10
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* step size in y for drawing */
end_comment

begin_decl_stmt
name|int
name|drawdot
init|=
literal|'.'
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* draw with this character */
end_comment

begin_decl_stmt
name|int
name|drawsize
init|=
literal|1
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* shrink by this factor when drawing */
end_comment

begin_macro
name|t_init
argument_list|(
argument|reinit
argument_list|)
end_macro

begin_comment
comment|/* initialize device */
end_comment

begin_decl_stmt
name|int
name|reinit
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|fflush
argument_list|(
name|stdout
argument_list|)
expr_stmt|;
name|stopped
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|erase
condition|)
block|{
name|oput
argument_list|(
name|ESC
argument_list|)
expr_stmt|;
name|oput
argument_list|(
name|FF
argument_list|)
expr_stmt|;
name|oput
argument_list|(
name|US
argument_list|)
expr_stmt|;
block|}
name|hpos
operator|=
name|vpos
operator|=
literal|0
expr_stmt|;
name|setsize
argument_list|(
name|t_size
argument_list|(
literal|10
argument_list|)
argument_list|)
expr_stmt|;
comment|/* start somewhere */
name|sendpt
argument_list|()
expr_stmt|;
block|}
end_block

begin_define
define|#
directive|define
name|MAXSTATE
value|5
end_define

begin_struct
struct|struct
name|state
block|{
name|int
name|ssize
decl_stmt|;
name|int
name|sfont
decl_stmt|;
name|int
name|shpos
decl_stmt|;
name|int
name|svpos
decl_stmt|;
name|int
name|shorig
decl_stmt|;
name|int
name|svorig
decl_stmt|;
block|}
struct|;
end_struct

begin_decl_stmt
name|struct
name|state
name|state
index|[
name|MAXSTATE
index|]
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|struct
name|state
modifier|*
name|statep
init|=
name|state
decl_stmt|;
end_decl_stmt

begin_macro
name|t_push
argument_list|()
end_macro

begin_comment
comment|/* begin a new block */
end_comment

begin_block
block|{
name|hflush
argument_list|()
expr_stmt|;
name|statep
operator|->
name|ssize
operator|=
name|size
expr_stmt|;
name|statep
operator|->
name|sfont
operator|=
name|font
expr_stmt|;
name|statep
operator|->
name|shorig
operator|=
name|horig
expr_stmt|;
name|statep
operator|->
name|svorig
operator|=
name|vorig
expr_stmt|;
name|statep
operator|->
name|shpos
operator|=
name|hpos
expr_stmt|;
name|statep
operator|->
name|svpos
operator|=
name|vpos
expr_stmt|;
name|horig
operator|=
name|hpos
expr_stmt|;
name|vorig
operator|=
name|vpos
expr_stmt|;
name|hpos
operator|=
name|vpos
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|statep
operator|++
operator|>=
name|state
operator|+
name|MAXSTATE
condition|)
name|error
argument_list|(
name|FATAL
argument_list|,
literal|"{ nested too deep"
argument_list|)
expr_stmt|;
name|hpos
operator|=
name|vpos
operator|=
literal|0
expr_stmt|;
block|}
end_block

begin_macro
name|t_pop
argument_list|()
end_macro

begin_comment
comment|/* pop to previous state */
end_comment

begin_block
block|{
if|if
condition|(
operator|--
name|statep
operator|<
name|state
condition|)
name|error
argument_list|(
name|FATAL
argument_list|,
literal|"extra }"
argument_list|)
expr_stmt|;
name|size
operator|=
name|statep
operator|->
name|ssize
expr_stmt|;
name|font
operator|=
name|statep
operator|->
name|sfont
expr_stmt|;
name|hpos
operator|=
name|statep
operator|->
name|shpos
expr_stmt|;
name|vpos
operator|=
name|statep
operator|->
name|svpos
expr_stmt|;
name|horig
operator|=
name|statep
operator|->
name|shorig
expr_stmt|;
name|vorig
operator|=
name|statep
operator|->
name|svorig
expr_stmt|;
block|}
end_block

begin_decl_stmt
name|int
name|np
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* number of pages seen */
end_comment

begin_decl_stmt
name|int
name|npmax
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* high-water mark of np */
end_comment

begin_decl_stmt
name|int
name|pgnum
index|[
literal|100
index|]
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* their actual numbers */
end_comment

begin_decl_stmt
name|long
name|pgadr
index|[
literal|100
index|]
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* their seek addresses */
end_comment

begin_macro
name|t_page
argument_list|(
argument|n
argument_list|)
end_macro

begin_comment
comment|/* do whatever new page functions */
end_comment

begin_block
block|{
name|long
name|ftell
parameter_list|()
function_decl|;
name|int
name|c
decl_stmt|,
name|m
decl_stmt|,
name|i
decl_stmt|;
name|char
name|buf
index|[
literal|100
index|]
decl_stmt|,
modifier|*
name|bp
decl_stmt|;
name|pgnum
index|[
name|np
operator|++
index|]
operator|=
name|n
expr_stmt|;
name|pgadr
index|[
name|np
index|]
operator|=
name|ftell
argument_list|(
name|fp
argument_list|)
expr_stmt|;
if|if
condition|(
name|np
operator|>
name|npmax
condition|)
name|npmax
operator|=
name|np
expr_stmt|;
if|if
condition|(
name|output
operator|==
literal|0
condition|)
block|{
name|output
operator|=
name|in_olist
argument_list|(
name|n
argument_list|)
expr_stmt|;
name|t_init
argument_list|(
literal|1
argument_list|)
expr_stmt|;
return|return;
block|}
comment|/* have just printed something, and seen p<n> for next one */
name|vgoto
argument_list|(
literal|11
operator|*
name|res
operator|-
literal|100
argument_list|)
expr_stmt|;
name|sendpt
argument_list|()
expr_stmt|;
name|oput
argument_list|(
name|US
argument_list|)
expr_stmt|;
name|fflush
argument_list|(
name|stdout
argument_list|)
expr_stmt|;
if|if
condition|(
name|keepon
condition|)
block|{
name|t_init
argument_list|(
literal|1
argument_list|)
expr_stmt|;
return|return;
block|}
name|next
label|:
for|for
control|(
name|bp
operator|=
name|buf
init|;
operator|(
operator|*
name|bp
operator|=
name|readch
argument_list|()
operator|)
condition|;
control|)
if|if
condition|(
operator|*
name|bp
operator|++
operator|==
literal|'\n'
condition|)
break|break;
operator|*
name|bp
operator|=
literal|0
expr_stmt|;
switch|switch
condition|(
name|buf
index|[
literal|0
index|]
condition|)
block|{
case|case
literal|0
case|:
case|case
literal|'q'
case|:
name|done
argument_list|()
expr_stmt|;
break|break;
case|case
literal|'\n'
case|:
if|if
condition|(
name|stopped
condition|)
name|done
argument_list|()
expr_stmt|;
name|output
operator|=
name|in_olist
argument_list|(
name|n
argument_list|)
expr_stmt|;
name|t_init
argument_list|(
literal|1
argument_list|)
expr_stmt|;
return|return;
case|case
literal|'!'
case|:
name|callunix
argument_list|(
operator|&
name|buf
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
name|fputs
argument_list|(
literal|"!\n"
argument_list|,
name|stderr
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'e'
case|:
name|erase
operator|=
literal|1
operator|-
name|erase
expr_stmt|;
break|break;
case|case
literal|'a'
case|:
name|aspect
operator|=
name|atof
argument_list|(
operator|&
name|buf
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'-'
case|:
case|case
literal|'p'
case|:
name|m
operator|=
name|atoi
argument_list|(
operator|&
name|buf
index|[
literal|1
index|]
argument_list|)
operator|+
literal|1
expr_stmt|;
if|if
condition|(
name|fp
operator|==
name|stdin
condition|)
block|{
name|fputs
argument_list|(
literal|"you can't; it's not a file\n"
argument_list|,
name|stderr
argument_list|)
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|np
operator|-
name|m
operator|<=
literal|0
condition|)
block|{
name|fputs
argument_list|(
literal|"too far back\n"
argument_list|,
name|stderr
argument_list|)
expr_stmt|;
break|break;
block|}
name|np
operator|-=
name|m
expr_stmt|;
name|fseek
argument_list|(
name|fp
argument_list|,
name|pgadr
index|[
name|np
index|]
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|output
operator|=
literal|1
expr_stmt|;
name|t_init
argument_list|(
literal|1
argument_list|)
expr_stmt|;
return|return;
case|case
literal|'0'
case|:
case|case
literal|'1'
case|:
case|case
literal|'2'
case|:
case|case
literal|'3'
case|:
case|case
literal|'4'
case|:
case|case
literal|'5'
case|:
case|case
literal|'6'
case|:
case|case
literal|'7'
case|:
case|case
literal|'8'
case|:
case|case
literal|'9'
case|:
name|m
operator|=
name|atoi
argument_list|(
operator|&
name|buf
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|npmax
condition|;
name|i
operator|++
control|)
if|if
condition|(
name|m
operator|==
name|pgnum
index|[
name|i
index|]
condition|)
break|break;
if|if
condition|(
name|i
operator|>=
name|npmax
operator|||
name|fp
operator|==
name|stdin
condition|)
block|{
name|fputs
argument_list|(
literal|"you can't\n"
argument_list|,
name|stderr
argument_list|)
expr_stmt|;
break|break;
block|}
name|np
operator|=
name|i
operator|+
literal|1
expr_stmt|;
name|fseek
argument_list|(
name|fp
argument_list|,
name|pgadr
index|[
name|np
index|]
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|output
operator|=
literal|1
expr_stmt|;
name|t_init
argument_list|(
literal|1
argument_list|)
expr_stmt|;
return|return;
case|case
literal|'o'
case|:
name|outlist
argument_list|(
operator|&
name|buf
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
name|output
operator|=
literal|0
expr_stmt|;
name|t_init
argument_list|(
literal|1
argument_list|)
expr_stmt|;
return|return;
case|case
literal|'?'
case|:
name|fputs
argument_list|(
literal|"!cmd	unix cmd\n"
argument_list|,
name|stderr
argument_list|)
expr_stmt|;
name|fputs
argument_list|(
literal|"p	print this page again\n"
argument_list|,
name|stderr
argument_list|)
expr_stmt|;
name|fputs
argument_list|(
literal|"-n	go back n pages\n"
argument_list|,
name|stderr
argument_list|)
expr_stmt|;
name|fputs
argument_list|(
literal|"n	print page n (previously printed)\n"
argument_list|,
name|stderr
argument_list|)
expr_stmt|;
name|fputs
argument_list|(
literal|"o...	set the -o output list to ...\n"
argument_list|,
name|stderr
argument_list|)
expr_stmt|;
name|fputs
argument_list|(
literal|"q	quit\n"
argument_list|,
name|stderr
argument_list|)
expr_stmt|;
name|fputs
argument_list|(
literal|"en	n=0 -> don't erase; n=1 -> erase\n"
argument_list|,
name|stderr
argument_list|)
expr_stmt|;
name|fputs
argument_list|(
literal|"an	sets aspect ratio to n\n"
argument_list|,
name|stderr
argument_list|)
expr_stmt|;
break|break;
default|default:
name|fputs
argument_list|(
literal|"?\n"
argument_list|,
name|stderr
argument_list|)
expr_stmt|;
break|break;
block|}
goto|goto
name|next
goto|;
block|}
end_block

begin_macro
name|t_newline
argument_list|()
end_macro

begin_comment
comment|/* do whatever for the end of a line */
end_comment

begin_block
block|{
name|hpos
operator|=
literal|0
expr_stmt|;
block|}
end_block

begin_macro
name|t_size
argument_list|(
argument|n
argument_list|)
end_macro

begin_comment
comment|/* convert integer to internal size number*/
end_comment

begin_decl_stmt
name|int
name|n
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|int
name|i
decl_stmt|;
if|if
condition|(
name|n
operator|<=
name|pstab
index|[
literal|0
index|]
condition|)
return|return
operator|(
literal|1
operator|)
return|;
elseif|else
if|if
condition|(
name|n
operator|>=
name|pstab
index|[
name|nsizes
operator|-
literal|1
index|]
condition|)
return|return
operator|(
name|nsizes
operator|)
return|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|n
operator|>
name|pstab
index|[
name|i
index|]
condition|;
name|i
operator|++
control|)
empty_stmt|;
return|return
operator|(
name|i
operator|+
literal|1
operator|)
return|;
block|}
end_block

begin_macro
name|t_font
argument_list|(
argument|s
argument_list|)
end_macro

begin_comment
comment|/* convert string to internal font number */
end_comment

begin_decl_stmt
name|char
modifier|*
name|s
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|int
name|n
decl_stmt|;
name|n
operator|=
name|atoi
argument_list|(
name|s
argument_list|)
expr_stmt|;
if|if
condition|(
name|n
operator|<
literal|1
operator|||
name|n
operator|>
name|nfonts
condition|)
name|n
operator|=
literal|1
expr_stmt|;
return|return
operator|(
name|n
operator|)
return|;
block|}
end_block

begin_macro
name|t_text
argument_list|(
argument|s
argument_list|)
end_macro

begin_comment
comment|/* print string s as text */
end_comment

begin_decl_stmt
name|char
modifier|*
name|s
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|int
name|c
decl_stmt|,
name|w
decl_stmt|;
name|char
name|str
index|[
literal|100
index|]
decl_stmt|;
if|if
condition|(
operator|!
name|output
condition|)
return|return;
name|w
operator|=
name|res
operator|/
literal|2
operator|*
name|pstab
index|[
name|size
operator|-
literal|1
index|]
operator|/
literal|72
expr_stmt|;
while|while
condition|(
operator|(
name|c
operator|=
operator|*
name|s
operator|++
operator|)
operator|!=
literal|'\n'
condition|)
block|{
if|if
condition|(
name|c
operator|==
literal|'\\'
condition|)
block|{
switch|switch
condition|(
name|c
operator|=
operator|*
name|s
operator|++
condition|)
block|{
case|case
literal|'\\'
case|:
case|case
literal|'e'
case|:
name|put1
argument_list|(
literal|'\\'
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'('
case|:
name|str
index|[
literal|0
index|]
operator|=
operator|*
name|s
operator|++
expr_stmt|;
name|str
index|[
literal|1
index|]
operator|=
operator|*
name|s
operator|++
expr_stmt|;
name|str
index|[
literal|2
index|]
operator|=
literal|'\0'
expr_stmt|;
name|put1s
argument_list|(
name|str
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
else|else
block|{
name|put1
argument_list|(
name|c
argument_list|)
expr_stmt|;
block|}
name|hmot
argument_list|(
name|w
argument_list|)
expr_stmt|;
block|}
block|}
end_block

begin_macro
name|t_reset
argument_list|(
argument|c
argument_list|)
end_macro

begin_block
block|{
name|int
name|n
decl_stmt|;
name|output
operator|=
literal|1
expr_stmt|;
name|fflush
argument_list|(
name|stdout
argument_list|)
expr_stmt|;
if|if
condition|(
name|c
operator|==
literal|'s'
condition|)
block|{
name|stopped
operator|=
literal|1
expr_stmt|;
name|t_page
argument_list|(
literal|9999
argument_list|)
expr_stmt|;
block|}
block|}
end_block

begin_macro
name|t_trailer
argument_list|()
end_macro

begin_block
block|{ }
end_block

begin_macro
name|hgoto
argument_list|(
argument|n
argument_list|)
end_macro

begin_block
block|{
name|hpos
operator|=
name|n
expr_stmt|;
comment|/* this is where we want to be */
comment|/* before printing a character, */
comment|/* have to make sure it's true */
block|}
end_block

begin_macro
name|hmot
argument_list|(
argument|n
argument_list|)
end_macro

begin_comment
comment|/* generate n units of horizontal motion */
end_comment

begin_decl_stmt
name|int
name|n
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|hgoto
argument_list|(
name|hpos
operator|+
name|n
argument_list|)
expr_stmt|;
block|}
end_block

begin_macro
name|hflush
argument_list|()
end_macro

begin_comment
comment|/* actual horizontal output occurs here */
end_comment

begin_block
block|{
if|if
condition|(
name|output
condition|)
name|sendpt
argument_list|()
expr_stmt|;
block|}
end_block

begin_macro
name|vgoto
argument_list|(
argument|n
argument_list|)
end_macro

begin_block
block|{
name|vpos
operator|=
name|n
expr_stmt|;
block|}
end_block

begin_macro
name|vmot
argument_list|(
argument|n
argument_list|)
end_macro

begin_comment
comment|/* generate n units of vertical motion */
end_comment

begin_decl_stmt
name|int
name|n
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|vgoto
argument_list|(
name|vpos
operator|+
name|n
argument_list|)
expr_stmt|;
comment|/* ignores rounding */
block|}
end_block

begin_macro
name|put1s
argument_list|(
argument|s
argument_list|)
end_macro

begin_comment
comment|/* s is a funny char name */
end_comment

begin_decl_stmt
name|char
modifier|*
name|s
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|int
name|i
decl_stmt|;
name|char
modifier|*
name|p
decl_stmt|;
specifier|extern
name|char
modifier|*
name|spectab
index|[]
decl_stmt|;
specifier|static
name|char
name|prev
index|[
literal|10
index|]
init|=
literal|""
decl_stmt|;
specifier|static
name|int
name|previ
decl_stmt|;
if|if
condition|(
operator|!
name|output
condition|)
return|return;
if|if
condition|(
name|strcmp
argument_list|(
name|s
argument_list|,
name|prev
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|previ
operator|=
operator|-
literal|1
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|spectab
index|[
name|i
index|]
operator|!=
literal|0
condition|;
name|i
operator|+=
literal|2
control|)
if|if
condition|(
name|strcmp
argument_list|(
name|spectab
index|[
name|i
index|]
argument_list|,
name|s
argument_list|)
operator|==
literal|0
condition|)
block|{
name|strcpy
argument_list|(
name|prev
argument_list|,
name|s
argument_list|)
expr_stmt|;
name|previ
operator|=
name|i
expr_stmt|;
break|break;
block|}
block|}
if|if
condition|(
name|previ
operator|>=
literal|0
condition|)
block|{
name|hflush
argument_list|()
expr_stmt|;
name|oput
argument_list|(
name|US
argument_list|)
expr_stmt|;
for|for
control|(
name|p
operator|=
name|spectab
index|[
name|previ
operator|+
literal|1
index|]
init|;
operator|*
name|p
condition|;
name|p
operator|++
control|)
name|oput
argument_list|(
operator|*
name|p
argument_list|)
expr_stmt|;
block|}
else|else
name|prev
index|[
literal|0
index|]
operator|=
literal|0
expr_stmt|;
block|}
end_block

begin_macro
name|put1
argument_list|(
argument|c
argument_list|)
end_macro

begin_comment
comment|/* output char c */
end_comment

begin_decl_stmt
name|int
name|c
decl_stmt|;
end_decl_stmt

begin_block
block|{
if|if
condition|(
operator|!
name|output
condition|)
return|return;
name|hflush
argument_list|()
expr_stmt|;
name|oput
argument_list|(
name|US
argument_list|)
expr_stmt|;
name|oput
argument_list|(
name|c
argument_list|)
expr_stmt|;
block|}
end_block

begin_macro
name|setsize
argument_list|(
argument|n
argument_list|)
end_macro

begin_comment
comment|/* set point size to n (internal) */
end_comment

begin_decl_stmt
name|int
name|n
decl_stmt|;
end_decl_stmt

begin_block
block|{
if|if
condition|(
operator|!
name|output
condition|)
return|return;
if|if
condition|(
name|n
operator|==
name|size
condition|)
return|return;
comment|/* already there */
name|oput
argument_list|(
name|ESC
argument_list|)
expr_stmt|;
name|oput
argument_list|(
name|pscode
index|[
name|n
operator|-
literal|1
index|]
argument_list|)
expr_stmt|;
name|size
operator|=
name|n
expr_stmt|;
block|}
end_block

begin_macro
name|t_fp
argument_list|(
argument|n
argument_list|,
argument|s
argument_list|)
end_macro

begin_comment
comment|/* font position n now contains font s */
end_comment

begin_decl_stmt
name|int
name|n
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|char
modifier|*
name|s
decl_stmt|;
end_decl_stmt

begin_block
block|{ }
end_block

begin_macro
name|setfont
argument_list|(
argument|n
argument_list|)
end_macro

begin_comment
comment|/* set font to n */
end_comment

begin_decl_stmt
name|int
name|n
decl_stmt|;
end_decl_stmt

begin_block
block|{ }
end_block

begin_macro
name|done
argument_list|()
end_macro

begin_block
block|{
name|output
operator|=
literal|1
expr_stmt|;
name|hgoto
argument_list|(
literal|0
argument_list|)
expr_stmt|;
name|vgoto
argument_list|(
literal|11
operator|*
name|res
operator|-
literal|100
argument_list|)
expr_stmt|;
comment|/* bottom of page */
name|sendpt
argument_list|()
expr_stmt|;
name|oput
argument_list|(
name|US
argument_list|)
expr_stmt|;
name|oput
argument_list|(
name|ESC
argument_list|)
expr_stmt|;
name|oput
argument_list|(
literal|';'
argument_list|)
expr_stmt|;
name|oput
argument_list|(
name|US
argument_list|)
expr_stmt|;
name|fflush
argument_list|(
name|stdout
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|0
argument_list|)
expr_stmt|;
block|}
end_block

begin_macro
name|callunix
argument_list|(
argument|line
argument_list|)
end_macro

begin_decl_stmt
name|char
name|line
index|[]
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|int
name|rc
decl_stmt|,
name|status
decl_stmt|,
name|unixpid
decl_stmt|;
if|if
condition|(
operator|(
name|unixpid
operator|=
name|fork
argument_list|()
operator|)
operator|==
literal|0
condition|)
block|{
name|signal
argument_list|(
name|SIGINT
argument_list|,
name|sigint
argument_list|)
expr_stmt|;
name|signal
argument_list|(
name|SIGQUIT
argument_list|,
name|sigquit
argument_list|)
expr_stmt|;
name|close
argument_list|(
literal|0
argument_list|)
expr_stmt|;
name|dup
argument_list|(
literal|2
argument_list|)
expr_stmt|;
name|execl
argument_list|(
literal|"/bin/sh"
argument_list|,
literal|"-sh"
argument_list|,
literal|"-c"
argument_list|,
name|line
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|255
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|unixpid
operator|==
operator|-
literal|1
condition|)
return|return;
else|else
block|{
name|signal
argument_list|(
name|SIGINT
argument_list|,
name|SIG_IGN
argument_list|)
expr_stmt|;
name|signal
argument_list|(
name|SIGQUIT
argument_list|,
name|SIG_IGN
argument_list|)
expr_stmt|;
while|while
condition|(
operator|(
name|rc
operator|=
name|wait
argument_list|(
operator|&
name|status
argument_list|)
operator|)
operator|!=
name|unixpid
operator|&&
name|rc
operator|!=
operator|-
literal|1
condition|)
empty_stmt|;
name|signal
argument_list|(
name|SIGINT
argument_list|,
name|done
argument_list|)
expr_stmt|;
name|signal
argument_list|(
name|SIGQUIT
argument_list|,
name|sigquit
argument_list|)
expr_stmt|;
block|}
block|}
end_block

begin_macro
name|readch
argument_list|()
end_macro

begin_block
block|{
name|char
name|c
decl_stmt|;
if|if
condition|(
name|read
argument_list|(
literal|2
argument_list|,
operator|&
name|c
argument_list|,
literal|1
argument_list|)
operator|<
literal|1
condition|)
name|c
operator|=
literal|0
expr_stmt|;
return|return
operator|(
name|c
operator|)
return|;
block|}
end_block

begin_macro
name|sendpt
argument_list|()
end_macro

begin_block
block|{
name|int
name|hy
decl_stmt|,
name|xb
decl_stmt|,
name|ly
decl_stmt|,
name|hx
decl_stmt|,
name|lx
decl_stmt|;
name|int
name|xx
decl_stmt|,
name|yy
decl_stmt|;
name|float
name|fx
decl_stmt|,
name|fy
decl_stmt|;
name|fx
operator|=
name|hpos
operator|+
name|horig
expr_stmt|;
name|fy
operator|=
name|vpos
operator|+
name|vorig
expr_stmt|;
name|xx
operator|=
operator|(
name|fx
operator|*
name|MAXY
operator|/
literal|11
operator|)
operator|/
name|res
operator|*
name|aspect
operator|+
literal|0.5
expr_stmt|;
name|yy
operator|=
name|MAXY
operator|-
operator|(
name|fy
operator|*
name|MAXY
operator|/
literal|11
operator|)
operator|/
name|res
operator|+
literal|0.5
expr_stmt|;
name|oput
argument_list|(
name|GS
argument_list|)
expr_stmt|;
name|hy
operator|=
operator|(
operator|(
name|yy
operator|>>
literal|7
operator|)
operator|&
literal|037
operator|)
expr_stmt|;
name|xb
operator|=
operator|(
operator|(
name|xx
operator|&
literal|03
operator|)
operator|+
operator|(
operator|(
name|yy
operator|<<
literal|2
operator|)
operator|&
literal|014
operator|)
operator|&
literal|017
operator|)
expr_stmt|;
name|ly
operator|=
operator|(
operator|(
name|yy
operator|>>
literal|2
operator|)
operator|&
literal|037
operator|)
expr_stmt|;
name|hx
operator|=
operator|(
operator|(
name|xx
operator|>>
literal|7
operator|)
operator|&
literal|037
operator|)
expr_stmt|;
name|lx
operator|=
operator|(
operator|(
name|xx
operator|>>
literal|2
operator|)
operator|&
literal|037
operator|)
expr_stmt|;
if|if
condition|(
name|hy
operator|!=
name|ohy
condition|)
name|oput
argument_list|(
name|hy
operator||
literal|040
argument_list|)
expr_stmt|;
if|if
condition|(
name|xb
operator|!=
name|oxb
condition|)
name|oput
argument_list|(
name|xb
operator||
literal|0140
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|ly
operator|!=
name|oly
operator|)
operator|||
operator|(
name|hx
operator|!=
name|ohx
operator|)
operator|||
operator|(
name|xb
operator|!=
name|oxb
operator|)
condition|)
name|oput
argument_list|(
name|ly
operator||
literal|0140
argument_list|)
expr_stmt|;
if|if
condition|(
name|hx
operator|!=
name|ohx
condition|)
name|oput
argument_list|(
name|hx
operator||
literal|040
argument_list|)
expr_stmt|;
name|oput
argument_list|(
name|lx
operator||
literal|0100
argument_list|)
expr_stmt|;
name|ohy
operator|=
name|hy
expr_stmt|;
name|oxb
operator|=
name|xb
expr_stmt|;
name|oly
operator|=
name|ly
expr_stmt|;
name|ohx
operator|=
name|hx
expr_stmt|;
name|olx
operator|=
name|lx
expr_stmt|;
block|}
end_block

begin_decl_stmt
name|char
modifier|*
name|spectab
index|[]
init|=
block|{
literal|"em"
block|,
literal|"--"
block|,
literal|"en"
block|,
literal|"-"
block|,
literal|"hy"
block|,
literal|"-"
block|,
literal|"ff"
block|,
literal|"ff"
block|,
literal|"fi"
block|,
literal|"fi"
block|,
literal|"fl"
block|,
literal|"fl"
block|,
literal|"Fi"
block|,
literal|"ffi"
block|,
literal|"Fl"
block|,
literal|"ffl"
block|,
literal|"ct"
block|,
literal|"\033\016Z\bM\033\017"
block|,
comment|/*cent sign*/
literal|"de"
block|,
literal|"\033\016J\033\017"
block|,
comment|/*degree*/
literal|"dg"
block|,
literal|"\033\016M\b_\033\017"
block|,
comment|/*dagger*/
literal|"rg"
block|,
literal|"\033\016O\b&\033\017"
block|,
comment|/*registered*/
literal|"bu"
block|,
literal|"\033\016O\b~\033\017"
block|,
comment|/*bullet*/
literal|"fm"
block|,
literal|"'"
block|,
literal|"co"
block|,
literal|"\033\016O\b#\033\017"
block|,
comment|/*copyright*/
literal|"sq"
block|,
literal|"\033\016L\033\017"
block|,
comment|/*square*/
literal|"*q"
block|,
literal|"\033\016(\bM\033\017"
block|,
comment|/*psi*/
literal|"*h"
block|,
literal|"\033\016o\b_\033\017"
block|,
comment|/*theta*/
literal|"*n"
block|,
literal|"v\b)"
block|,
comment|/*nu*/
literal|"*m"
block|,
literal|"\033\016V\b,\033\017"
block|,
comment|/*mu*/
literal|"*l"
block|,
literal|"\033\016)\b?\033\017"
block|,
comment|/*lambda*/
literal|"*i"
block|,
literal|"\033\016I\033\017"
block|,
comment|/*iota*/
literal|"*z"
block|,
literal|"S\b\033\016Z\033\017"
block|,
comment|/*zeta*/
literal|"*s"
block|,
literal|"o\b\'"
block|,
comment|/*sigma*/
literal|"*d"
block|,
literal|"o\b\033\0165\033\017"
block|,
comment|/*delta*/
literal|"*b"
block|,
literal|"\033\016b\033\017"
block|,
comment|/*beta*/
literal|"*c"
block|,
literal|"\033\016e\bc\033\017"
block|,
comment|/*xi*/
literal|"*y"
block|,
literal|"j\b\033\016C\033\017"
block|,
comment|/*eta*/
literal|"*f"
block|,
literal|"\033\016O\bM\033\017"
block|,
comment|/*phi*/
literal|"*u"
block|,
literal|"\033\016(\033\017"
block|,
comment|/*upsilon*/
literal|"*k"
block|,
literal|"\033\016k\033\017"
block|,
comment|/*kappa*/
literal|"*p"
block|,
literal|"T\b\033\016S\033\017"
block|,
comment|/*pi*/
literal|"da"
block|,
literal|"\033\016U\033\017"
block|,
comment|/*down arrow*/
literal|"*a"
block|,
literal|"\033\016A\033\017"
block|,
comment|/*alpha*/
literal|"or"
block|,
literal|"|"
block|,
literal|"*x"
block|,
literal|"l\b/"
block|,
comment|/*chi*/
literal|"*e"
block|,
literal|"\033\016E\033\017"
block|,
comment|/*epsilon*/
literal|"*o"
block|,
literal|"\033\016O\033\017"
block|,
comment|/*omicron*/
literal|"<-"
block|,
literal|"\033\016[\033\017"
block|,
comment|/*left arrow*/
literal|"*r"
block|,
literal|"\033\016R\033\017"
block|,
comment|/*rho*/
literal|"ua"
block|,
literal|"\033\016Y\033\017"
block|,
comment|/*up arrow*/
literal|"*t"
block|,
literal|"\033\016N\033\017"
block|,
comment|/*tau*/
literal|"ul"
block|,
literal|"_"
block|,
literal|"ru"
block|,
literal|"_"
block|,
literal|"\\_"
block|,
literal|"_"
block|,
literal|"*Q"
block|,
literal|"I\b\033\016(\033\017"
block|,
comment|/*Psi*/
literal|"bs"
block|,
literal|"\033\016O\bJ\033\017"
block|,
comment|/*bell system sign*/
literal|"if"
block|,
literal|"\033\016W\bX\033\017"
block|,
comment|/*infinity*/
literal|"*g"
block|,
literal|"`\b/"
block|,
comment|/*gamma*/
literal|"ip"
block|,
literal|"\033\016X\bF\033\017"
block|,
comment|/*improper superset*/
literal|"pt"
block|,
literal|"\033\016A\033\017"
block|,
comment|/*proportional to*/
literal|"rh"
block|,
literal|"\033\016\\\b]\033\017"
block|,
comment|/*right hand*/
literal|"*w"
block|,
literal|"\033\016W\033\017"
block|,
comment|/*omega*/
literal|"gr"
block|,
literal|"\033\016G\033\017"
block|,
comment|/*gradient*/
literal|"*F"
block|,
literal|"I\033\016\bO\033\017"
block|,
comment|/*Phi*/
literal|"*H"
block|,
literal|"O\b="
block|,
comment|/*Theta*/
literal|"*W"
block|,
literal|"O\b_"
block|,
comment|/*Omega*/
literal|"cu"
block|,
literal|"\033\016V\033\017"
block|,
comment|/*cup (union)*/
literal|"rn"
block|,
literal|"\033\016@\033\017"
block|,
comment|/*root en*/
literal|"ts"
block|,
literal|"s"
block|,
comment|/*terminal sigma*/
literal|"*L"
block|,
literal|"\033\016)\bK\033\017"
block|,
comment|/*Lambda*/
literal|"\\-"
block|,
literal|"-"
block|,
literal|"*G"
block|,
literal|"\033\016S\bK\033\017"
block|,
comment|/*Gamma*/
literal|"is"
block|,
literal|"\033\016i\033\017"
block|,
comment|/*integral sign*/
literal|"Sl"
block|,
literal|"l"
block|,
literal|"*P"
block|,
literal|"\033\016t\b'\033\017"
block|,
comment|/*Pi*/
literal|"sb"
block|,
literal|"\033\016Z\033\017"
block|,
comment|/*subset of*/
literal|"sp"
block|,
literal|"\033\016X\033\017"
block|,
comment|/*superset of*/
literal|"ap"
block|,
literal|"\033\016T\033\017"
block|,
comment|/*approximates*/
literal|"pd"
block|,
literal|"o\b`"
block|,
comment|/*partial derivative*/
literal|"*D"
block|,
literal|"\033\016H\033\017"
block|,
comment|/*Delta*/
literal|"sr"
block|,
literal|"\033\016I\b'\033\017"
block|,
comment|/*square root*/
literal|"*S"
block|,
literal|">\b\033\016F\b@\033\017"
block|,
comment|/*Sigma*/
literal|"~~"
block|,
literal|"\033\016T\bF\033\017"
block|,
comment|/*approx =*/
literal|"*C"
block|,
literal|"\033\016_\bF\b@\033\017"
block|,
comment|/*Xi*/
literal|"sl"
block|,
literal|"/"
block|,
literal|"ca"
block|,
literal|"\033\016C\033\017"
block|,
comment|/*cap (intersection)*/
literal|"U"
block|,
literal|"\033\016y\033\017"
block|,
comment|/*Upsilon*/
literal|"no"
block|,
literal|"\033\016|\033\017"
block|,
comment|/*not*/
literal|"rc"
block|,
literal|"|"
block|,
comment|/*right ceiling (rt of ")*/
literal|"lt"
block|,
literal|"|"
block|,
comment|/*left top (of big curly)*/
literal|"bv"
block|,
literal|"|"
block|,
comment|/*bold vertical*/
literal|"lk"
block|,
literal|"|"
block|,
comment|/*left center of big curly bracket*/
literal|"lb"
block|,
literal|"|"
block|,
comment|/*left bottom*/
literal|"rt"
block|,
literal|"|"
block|,
comment|/*right top*/
literal|"rk"
block|,
literal|"|"
block|,
comment|/*right center of big curly bracket*/
literal|"rb"
block|,
literal|"|"
block|,
comment|/*right bot*/
literal|"rf"
block|,
literal|"|"
block|,
comment|/*right floor (rb of ")*/
literal|"lf"
block|,
literal|"|"
block|,
comment|/*left floor (left bot of big sq bract)*/
literal|"lc"
block|,
literal|"|"
block|,
comment|/*left ceiling (lt of ")*/
literal|"mu"
block|,
literal|"\033\016=\033\017"
block|,
comment|/*multiply*/
literal|"di"
block|,
literal|"\033\016+\033\017"
block|,
comment|/*divide*/
literal|"+-"
block|,
literal|"+\b_"
block|,
comment|/*plus-minus*/
literal|"<="
block|,
literal|"\033\016$\033\017"
block|,
comment|/*<=*/
literal|">="
block|,
literal|"\033\016^\033\017"
block|,
comment|/*>=*/
literal|"=="
block|,
literal|"=\b_"
block|,
comment|/*identically equal*/
literal|"!="
block|,
literal|"\033\016*\033\017"
block|,
comment|/*not equal*/
literal|"aa"
block|,
literal|"'"
block|,
literal|"ga"
block|,
literal|"`"
block|,
literal|"lh"
block|,
literal|"\033\016|\b[\033\017"
block|,
comment|/*left hand*/
literal|"mo"
block|,
literal|"\033\016c\b_\033\017"
block|,
comment|/*member of*/
literal|"es"
block|,
literal|"\033\016O\b/\033\017"
block|,
comment|/*empty set*/
literal|"dd"
block|,
literal|"\033\016%\bM\033\017"
block|,
comment|/*dbl dagger*/
literal|"br"
block|,
literal|"|"
block|,
comment|/*box rule*/
literal|"vr"
block|,
literal|"|"
block|,
comment|/* vertical rule */
literal|"ib"
block|,
literal|"\033\016Z\bF\033\017"
block|,
comment|/*improper subset*/
literal|"ci"
block|,
literal|"\033\016O\033\017"
block|,
comment|/*circle*/
literal|"eq"
block|,
literal|"="
block|,
literal|"pl"
block|,
literal|"+"
block|,
literal|"mi"
block|,
literal|"-"
block|,
literal|"12"
block|,
literal|"1/2"
block|,
literal|"14"
block|,
literal|"1/4"
block|,
literal|"34"
block|,
literal|"3/4"
block|,
literal|"->"
block|,
literal|"\033\016]\033\017"
block|,
comment|/*right arrow*/
literal|"sc"
block|,
literal|"g\b\033\016C\033\017"
block|,
comment|/*section mark*/
literal|"**"
block|,
literal|"*"
block|,
literal|"l."
block|,
literal|"."
block|,
literal|"L."
block|,
literal|"."
block|,
literal|"bx"
block|,
literal|"[\b]"
block|,
literal|"ob"
block|,
literal|"o"
block|,
comment|/* open bullet */
literal|"cd"
block|,
literal|","
block|,
comment|/* cedilla */
literal|".."
block|,
literal|"\033\016!\033\017"
block|,
comment|/* umlaut */
literal|0
block|,
literal|0
block|, }
decl_stmt|;
end_decl_stmt

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * yppasswdd  * Copyright 1994 Olaf Kirch,<okir@monad.swb.de>  *  * This program is covered by the GNU General Public License, version 2.  * It is provided in the hope that it is useful. However, the author  * disclaims ALL WARRANTIES, expressed or implied. See the GPL for details.  */
end_comment

begin_include
include|#
directive|include
file|<sys/types.h>
end_include

begin_include
include|#
directive|include
file|<sys/errno.h>
end_include

begin_include
include|#
directive|include
file|<sys/stat.h>
end_include

begin_include
include|#
directive|include
file|<sys/param.h>
end_include

begin_include
include|#
directive|include
file|<netinet/in.h>
end_include

begin_include
include|#
directive|include
file|<arpa/inet.h>
end_include

begin_include
include|#
directive|include
file|<fcntl.h>
end_include

begin_include
include|#
directive|include
file|<unistd.h>
end_include

begin_include
include|#
directive|include
file|<ctype.h>
end_include

begin_include
include|#
directive|include
file|<time.h>
end_include

begin_include
include|#
directive|include
file|<pwd.h>
end_include

begin_include
include|#
directive|include
file|<syslog.h>
end_include

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_include
include|#
directive|include
file|<string.h>
end_include

begin_include
include|#
directive|include
file|<rpc/rpc.h>
end_include

begin_include
include|#
directive|include
file|<rpc/pmap_clnt.h>
end_include

begin_include
include|#
directive|include
file|"yppasswd.h"
end_include

begin_decl_stmt
name|char
modifier|*
name|tempname
decl_stmt|,
modifier|*
name|passfile
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|extern
name|int
modifier|*
name|allow_chfn
decl_stmt|,
modifier|*
name|allow_chsh
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|extern
name|int
name|pid
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|extern
name|int
name|pw_copy
name|__P
argument_list|(
operator|(
name|int
operator|,
name|int
operator|,
expr|struct
name|passwd
operator|*
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|extern
name|int
name|pw_lock
name|__P
argument_list|(
operator|(
name|void
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|extern
name|int
name|pw_mkdb
name|__P
argument_list|(
operator|(
name|void
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|extern
name|int
name|pw_tmp
name|__P
argument_list|(
operator|(
name|void
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_define
define|#
directive|define
name|xprt_addr
parameter_list|(
name|xprt
parameter_list|)
value|(svc_getcaller(xprt)->sin_addr)
end_define

begin_define
define|#
directive|define
name|xprt_port
parameter_list|(
name|xprt
parameter_list|)
value|ntohs(svc_getcaller(xprt)->sin_port)
end_define

begin_function_decl
name|void
name|reaper
parameter_list|(
name|int
name|sig
parameter_list|)
function_decl|;
end_function_decl

begin_comment
comment|/*===============================================================*  * Argument validation. Avoid \n... (ouch).  * We can't use isprint, because people may use 8bit chars which  * aren't recognized as printable in the default locale.  *===============================================================*/
end_comment

begin_function
specifier|static
name|int
name|validate_string
parameter_list|(
name|char
modifier|*
name|str
parameter_list|)
block|{
while|while
condition|(
operator|*
name|str
operator|&&
operator|!
name|iscntrl
argument_list|(
operator|*
name|str
argument_list|)
condition|)
name|str
operator|++
expr_stmt|;
return|return
operator|(
operator|*
name|str
operator|==
literal|'\0'
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|validate_args
parameter_list|(
name|struct
name|xpasswd
modifier|*
name|pw
parameter_list|)
block|{
if|if
condition|(
name|pw
operator|->
name|pw_name
index|[
literal|0
index|]
operator|==
literal|'-'
operator|||
name|pw
operator|->
name|pw_name
index|[
literal|0
index|]
operator|==
literal|'+'
condition|)
block|{
name|syslog
argument_list|(
name|LOG_ALERT
argument_list|,
literal|"attempt to modify NIS passwd entry \"%s\""
argument_list|,
name|pw
operator|->
name|pw_name
argument_list|)
expr_stmt|;
block|}
return|return
name|validate_string
argument_list|(
name|pw
operator|->
name|pw_passwd
argument_list|)
operator|&&
name|validate_string
argument_list|(
name|pw
operator|->
name|pw_shell
argument_list|)
operator|&&
name|validate_string
argument_list|(
name|pw
operator|->
name|pw_gecos
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/*===============================================================*  * The passwd update handler  *===============================================================*/
end_comment

begin_function
name|int
modifier|*
name|yppasswdproc_pwupdate_1
parameter_list|(
name|yppasswd
modifier|*
name|yppw
parameter_list|,
name|struct
name|svc_req
modifier|*
name|rqstp
parameter_list|)
block|{
name|struct
name|xpasswd
modifier|*
name|newpw
decl_stmt|;
comment|/* passwd struct passed by the client */
name|struct
name|passwd
modifier|*
name|pw
decl_stmt|;
comment|/* passwd struct obtained from getpwent() */
name|int
name|chsh
init|=
literal|0
decl_stmt|,
name|chfn
init|=
literal|0
decl_stmt|;
specifier|static
name|int
name|res
decl_stmt|;
name|char
name|logbuf
index|[
literal|255
index|]
decl_stmt|;
name|int
name|pfd
decl_stmt|,
name|tfd
decl_stmt|;
name|char
modifier|*
name|passfile_hold
decl_stmt|;
name|char
name|template
index|[]
init|=
literal|"/tmp/yppwtmp.XXXXX"
decl_stmt|;
name|newpw
operator|=
operator|&
name|yppw
operator|->
name|newpw
expr_stmt|;
name|res
operator|=
literal|1
expr_stmt|;
name|sprintf
argument_list|(
name|logbuf
argument_list|,
literal|"update %.12s (uid=%d) from host %s"
argument_list|,
name|yppw
operator|->
name|newpw
operator|.
name|pw_name
argument_list|,
name|yppw
operator|->
name|newpw
operator|.
name|pw_uid
argument_list|,
name|inet_ntoa
argument_list|(
name|xprt_addr
argument_list|(
name|rqstp
operator|->
name|rq_xprt
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|validate_args
argument_list|(
name|newpw
argument_list|)
condition|)
block|{
name|syslog
argument_list|(
name|LOG_ALERT
argument_list|,
literal|"%s failed"
argument_list|,
name|logbuf
argument_list|)
expr_stmt|;
name|syslog
argument_list|(
name|LOG_ALERT
argument_list|,
literal|"Invalid characters in argument. "
literal|"Possible spoof attempt?"
argument_list|)
expr_stmt|;
return|return
operator|&
name|res
return|;
block|}
comment|/* Check if the user exists      */
if|if
condition|(
operator|!
operator|(
name|pw
operator|=
name|getpwnam
argument_list|(
name|yppw
operator|->
name|newpw
operator|.
name|pw_name
argument_list|)
operator|)
condition|)
block|{
name|syslog
argument_list|(
name|LOG_WARNING
argument_list|,
literal|"%s failed"
argument_list|,
name|logbuf
argument_list|)
expr_stmt|;
name|syslog
argument_list|(
name|LOG_WARNING
argument_list|,
literal|"User not in password file."
argument_list|)
expr_stmt|;
return|return
operator|(
operator|&
name|res
operator|)
return|;
block|}
comment|/* Check the password.     */
if|if
condition|(
name|strcmp
argument_list|(
name|crypt
argument_list|(
name|yppw
operator|->
name|oldpass
argument_list|,
name|pw
operator|->
name|pw_passwd
argument_list|)
argument_list|,
name|pw
operator|->
name|pw_passwd
argument_list|)
condition|)
block|{
name|syslog
argument_list|(
name|LOG_WARNING
argument_list|,
literal|"%s rejected"
argument_list|,
name|logbuf
argument_list|)
expr_stmt|;
name|syslog
argument_list|(
name|LOG_WARNING
argument_list|,
literal|"Invalid password."
argument_list|)
expr_stmt|;
name|sleep
argument_list|(
literal|1
argument_list|)
expr_stmt|;
return|return
operator|(
operator|&
name|res
operator|)
return|;
block|}
comment|/* set the new passwd, shell, and full name     */
name|pw
operator|->
name|pw_change
operator|=
literal|0
expr_stmt|;
name|pw
operator|->
name|pw_passwd
operator|=
name|newpw
operator|->
name|pw_passwd
expr_stmt|;
if|if
condition|(
name|allow_chsh
condition|)
block|{
name|chsh
operator|=
operator|(
name|strcmp
argument_list|(
name|pw
operator|->
name|pw_shell
argument_list|,
name|newpw
operator|->
name|pw_shell
argument_list|)
operator|!=
literal|0
operator|)
expr_stmt|;
name|pw
operator|->
name|pw_shell
operator|=
name|newpw
operator|->
name|pw_shell
expr_stmt|;
block|}
if|if
condition|(
name|allow_chfn
condition|)
block|{
name|chfn
operator|=
operator|(
name|strcmp
argument_list|(
name|pw
operator|->
name|pw_gecos
argument_list|,
name|newpw
operator|->
name|pw_gecos
argument_list|)
operator|!=
literal|0
operator|)
expr_stmt|;
name|pw
operator|->
name|pw_gecos
operator|=
name|newpw
operator|->
name|pw_gecos
expr_stmt|;
block|}
comment|/*      * Bail if locking the password file or temp file creation fails.      * (These operations should log their own failure messages if need be,      * so we don't have to log their failures here.)      */
if|if
condition|(
operator|(
name|pfd
operator|=
name|pw_lock
argument_list|()
operator|)
operator|<
literal|0
condition|)
return|return
operator|&
name|res
return|;
if|if
condition|(
operator|(
name|tfd
operator|=
name|pw_tmp
argument_list|()
operator|)
operator|<
literal|0
condition|)
return|return
operator|&
name|res
return|;
comment|/* Placeholder in case we need to put the old password file back. */
name|passfile_hold
operator|=
name|mktemp
argument_list|(
operator|(
name|char
operator|*
operator|)
operator|&
name|template
argument_list|)
expr_stmt|;
comment|/*      * Copy the password file to the temp file,      * inserting new passwd entry along the way.      */
if|if
condition|(
name|pw_copy
argument_list|(
name|pfd
argument_list|,
name|tfd
argument_list|,
name|pw
argument_list|)
operator|<
literal|0
condition|)
block|{
name|syslog
argument_list|(
name|LOG_ERR
argument_list|,
literal|"%s> %s: copy failed. Cleaning up."
argument_list|,
name|tempname
argument_list|,
name|passfile
argument_list|)
expr_stmt|;
name|unlink
argument_list|(
name|tempname
argument_list|)
expr_stmt|;
return|return
operator|(
operator|&
name|res
operator|)
return|;
block|}
name|rename
argument_list|(
name|passfile
argument_list|,
name|passfile_hold
argument_list|)
expr_stmt|;
if|if
condition|(
name|strcmp
argument_list|(
name|passfile
argument_list|,
name|_PATH_MASTERPASSWD
argument_list|)
condition|)
block|{
name|rename
argument_list|(
name|tempname
argument_list|,
name|passfile
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|pw_mkdb
argument_list|()
operator|<
literal|0
condition|)
block|{
name|syslog
argument_list|(
name|LOG_WARNING
argument_list|,
literal|"%s failed to rebuild password database"
argument_list|,
name|logbuf
argument_list|)
expr_stmt|;
return|return
operator|(
operator|&
name|res
operator|)
return|;
block|}
comment|/* Fork off process to rebuild NIS passwd.* maps. If the fork      * fails, restore old passwd file and return an error.      */
if|if
condition|(
operator|(
name|pid
operator|=
name|fork
argument_list|()
operator|)
operator|<
literal|0
condition|)
block|{
name|syslog
argument_list|(
name|LOG_ERR
argument_list|,
literal|"%s failed"
argument_list|,
name|logbuf
argument_list|)
expr_stmt|;
name|syslog
argument_list|(
name|LOG_ERR
argument_list|,
literal|"Couldn't fork map update process: %m"
argument_list|)
expr_stmt|;
name|unlink
argument_list|(
name|passfile
argument_list|)
expr_stmt|;
name|rename
argument_list|(
name|passfile_hold
argument_list|,
name|passfile
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|strcmp
argument_list|(
name|passfile
argument_list|,
name|_PATH_MASTERPASSWD
argument_list|)
condition|)
if|if
condition|(
name|pw_mkdb
argument_list|()
condition|)
block|{
name|syslog
argument_list|(
name|LOG_WARNING
argument_list|,
literal|"%s failed to rebuild password database"
argument_list|,
name|logbuf
argument_list|)
expr_stmt|;
return|return
operator|(
operator|&
name|res
operator|)
return|;
block|}
return|return
operator|(
operator|&
name|res
operator|)
return|;
block|}
if|if
condition|(
name|pid
operator|==
literal|0
condition|)
block|{
name|unlink
argument_list|(
name|passfile_hold
argument_list|)
expr_stmt|;
name|execlp
argument_list|(
name|MAP_UPDATE_PATH
argument_list|,
name|MAP_UPDATE
argument_list|,
name|passfile
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|syslog
argument_list|(
name|LOG_ERR
argument_list|,
literal|"Error: couldn't exec map update process: %m"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
name|syslog
argument_list|(
name|LOG_INFO
argument_list|,
literal|"%s successful. Password changed."
argument_list|,
name|logbuf
argument_list|)
expr_stmt|;
if|if
condition|(
name|chsh
operator|||
name|chfn
condition|)
block|{
name|syslog
argument_list|(
name|LOG_INFO
argument_list|,
literal|"Shell %schanged (%s), GECOS %schanged (%s)."
argument_list|,
name|chsh
condition|?
literal|""
else|:
literal|"un"
argument_list|,
name|newpw
operator|->
name|pw_shell
argument_list|,
name|chfn
condition|?
literal|""
else|:
literal|"un"
argument_list|,
name|newpw
operator|->
name|pw_gecos
argument_list|)
expr_stmt|;
block|}
name|res
operator|=
literal|0
expr_stmt|;
return|return
operator|(
operator|&
name|res
operator|)
return|;
block|}
end_function

end_unit


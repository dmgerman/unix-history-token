begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*     YPS-0.2, NIS-Server for Linux     Copyright (C) 1994  Tobias Reber      This program is free software; you can redistribute it and/or modify     it under the terms of the GNU General Public License as published by     the Free Software Foundation; either version 2 of the License, or     (at your option) any later version.      This program is distributed in the hope that it will be useful,     but WITHOUT ANY WARRANTY; without even the implied warranty of     MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the     GNU General Public License for more details.      You should have received a copy of the GNU General Public License     along with this program; if not, write to the Free Software     Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.      Modified for use with FreeBSD 2.x by Bill Paul (wpaul@ctr.columbia.edu) */
end_comment

begin_comment
comment|/*  * $FreeBSD$  */
end_comment

begin_define
define|#
directive|define
name|BUFFERSIZE
value|4096
end_define

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_include
include|#
directive|include
file|<stdlib.h>
end_include

begin_include
include|#
directive|include
file|<unistd.h>
end_include

begin_include
include|#
directive|include
file|<string.h>
end_include

begin_include
include|#
directive|include
file|<fcntl.h>
end_include

begin_include
include|#
directive|include
file|<sys/time.h>
end_include

begin_include
include|#
directive|include
file|<sys/param.h>
end_include

begin_include
include|#
directive|include
file|<sys/stat.h>
end_include

begin_include
include|#
directive|include
file|<netdb.h>
end_include

begin_include
include|#
directive|include
file|<sys/types.h>
end_include

begin_include
include|#
directive|include
file|<db.h>
end_include

begin_include
include|#
directive|include
file|<limits.h>
end_include

begin_define
define|#
directive|define
name|PERM_SECURE
value|(S_IRUSR|S_IWUSR)
end_define

begin_decl_stmt
name|HASHINFO
name|openinfo
init|=
block|{
literal|4096
block|,
comment|/* bsize */
literal|32
block|,
comment|/* ffactor */
literal|256
block|,
comment|/* nelem */
literal|2048
operator|*
literal|1024
block|,
comment|/* cachesize */
name|NULL
block|,
comment|/* hash */
literal|0
comment|/* lorder */
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|extern
name|int
name|optind
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|extern
name|char
modifier|*
name|optarg
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|char
modifier|*
name|DomainName
init|=
name|NULL
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|char
modifier|*
name|InputFileName
init|=
name|NULL
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|char
modifier|*
name|OutputFileName
init|=
name|NULL
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|char
modifier|*
name|MasterName
init|=
name|NULL
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|char
name|thisHost
index|[
name|MAXHOSTNAMELEN
operator|+
literal|1
index|]
decl_stmt|;
end_decl_stmt

begin_function
specifier|static
name|void
name|unLoad
parameter_list|(
name|char
modifier|*
name|DbName
parameter_list|)
block|{
name|DB
modifier|*
name|dp
decl_stmt|;
name|DBT
name|key
decl_stmt|,
name|data
decl_stmt|;
name|int
name|flag
init|=
name|R_FIRST
decl_stmt|;
if|if
condition|(
operator|(
name|dp
operator|=
name|dbopen
argument_list|(
name|DbName
argument_list|,
name|O_RDONLY
operator||
name|O_EXCL
argument_list|,
name|PERM_SECURE
argument_list|,
name|DB_HASH
argument_list|,
operator|&
name|openinfo
argument_list|)
operator|)
operator|==
name|NULL
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"%s: Cannot open\n"
argument_list|,
name|DbName
argument_list|)
expr_stmt|;
name|perror
argument_list|(
name|DbName
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
while|while
condition|(
operator|!
call|(
name|dp
operator|->
name|seq
call|)
argument_list|(
name|dp
argument_list|,
operator|&
name|key
argument_list|,
operator|&
name|data
argument_list|,
name|flag
argument_list|)
condition|)
block|{
if|if
condition|(
operator|!
name|data
operator|.
name|data
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Error\n"
argument_list|)
expr_stmt|;
name|perror
argument_list|(
name|DbName
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
name|flag
operator|=
name|R_NEXT
expr_stmt|;
name|fwrite
argument_list|(
name|key
operator|.
name|data
argument_list|,
name|key
operator|.
name|size
argument_list|,
literal|1
argument_list|,
name|stdout
argument_list|)
expr_stmt|;
name|putc
argument_list|(
literal|' '
argument_list|,
name|stdout
argument_list|)
expr_stmt|;
name|fwrite
argument_list|(
name|data
operator|.
name|data
argument_list|,
name|data
operator|.
name|size
argument_list|,
literal|1
argument_list|,
name|stdout
argument_list|)
expr_stmt|;
name|putc
argument_list|(
literal|'\n'
argument_list|,
name|stdout
argument_list|)
expr_stmt|;
block|}
call|(
name|void
call|)
argument_list|(
name|dp
operator|->
name|close
argument_list|)
argument_list|(
name|dp
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|load
parameter_list|(
name|char
modifier|*
name|FileName
parameter_list|,
name|char
modifier|*
name|DbName
parameter_list|)
block|{
specifier|static
name|char
name|Buffer
index|[
name|BUFFERSIZE
index|]
decl_stmt|;
specifier|static
name|char
name|filename
index|[
literal|1024
index|]
decl_stmt|,
name|filename2
index|[
literal|1024
index|]
decl_stmt|;
name|FILE
modifier|*
name|infile
decl_stmt|;
name|DB
modifier|*
name|dp
decl_stmt|;
name|DBT
name|key
decl_stmt|,
name|data
decl_stmt|;
name|infile
operator|=
name|strcmp
argument_list|(
name|FileName
argument_list|,
literal|"-"
argument_list|)
condition|?
name|fopen
argument_list|(
name|FileName
argument_list|,
literal|"r"
argument_list|)
else|:
name|stdin
expr_stmt|;
if|if
condition|(
name|infile
operator|==
name|NULL
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"%s: Cannot open\n"
argument_list|,
name|FileName
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
name|sprintf
argument_list|(
name|filename
argument_list|,
literal|"%s~.db"
argument_list|,
name|DbName
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|dp
operator|=
name|dbopen
argument_list|(
name|DbName
argument_list|,
name|O_RDWR
operator||
name|O_EXCL
operator||
name|O_CREAT
argument_list|,
name|PERM_SECURE
argument_list|,
name|DB_HASH
argument_list|,
operator|&
name|openinfo
argument_list|)
operator|)
operator|==
name|NULL
condition|)
block|{
name|perror
argument_list|(
literal|"dbopen"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"%s: Cannot open\n"
argument_list|,
name|filename
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|MasterName
operator|&&
operator|*
name|MasterName
condition|)
block|{
name|key
operator|.
name|data
operator|=
literal|"YP_MASTER_NAME"
expr_stmt|;
name|key
operator|.
name|size
operator|=
name|strlen
argument_list|(
name|key
operator|.
name|data
argument_list|)
expr_stmt|;
name|data
operator|.
name|data
operator|=
name|MasterName
expr_stmt|;
name|data
operator|.
name|size
operator|=
name|strlen
argument_list|(
name|MasterName
argument_list|)
expr_stmt|;
call|(
name|dp
operator|->
name|put
call|)
argument_list|(
name|dp
argument_list|,
operator|&
name|key
argument_list|,
operator|&
name|data
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|DomainName
operator|&&
operator|*
name|DomainName
condition|)
block|{
name|key
operator|.
name|data
operator|=
literal|"YP_DOMAIN_NAME"
expr_stmt|;
name|key
operator|.
name|size
operator|=
name|strlen
argument_list|(
name|key
operator|.
name|data
argument_list|)
expr_stmt|;
name|data
operator|.
name|data
operator|=
name|DomainName
expr_stmt|;
name|data
operator|.
name|size
operator|=
name|strlen
argument_list|(
name|DomainName
argument_list|)
expr_stmt|;
call|(
name|dp
operator|->
name|put
call|)
argument_list|(
name|dp
argument_list|,
operator|&
name|key
argument_list|,
operator|&
name|data
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|InputFileName
operator|&&
operator|*
name|InputFileName
condition|)
block|{
name|key
operator|.
name|data
operator|=
literal|"YP_INPUT_NAME"
expr_stmt|;
name|key
operator|.
name|size
operator|=
name|strlen
argument_list|(
name|key
operator|.
name|data
argument_list|)
expr_stmt|;
name|data
operator|.
name|data
operator|=
name|InputFileName
expr_stmt|;
name|data
operator|.
name|size
operator|=
name|strlen
argument_list|(
name|InputFileName
argument_list|)
expr_stmt|;
call|(
name|dp
operator|->
name|put
call|)
argument_list|(
name|dp
argument_list|,
operator|&
name|key
argument_list|,
operator|&
name|data
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|OutputFileName
operator|&&
operator|*
name|OutputFileName
condition|)
block|{
name|key
operator|.
name|data
operator|=
literal|"YP_OUTPUT_NAME"
expr_stmt|;
name|key
operator|.
name|size
operator|=
name|strlen
argument_list|(
name|key
operator|.
name|data
argument_list|)
expr_stmt|;
name|data
operator|.
name|data
operator|=
name|OutputFileName
expr_stmt|;
name|data
operator|.
name|size
operator|=
name|strlen
argument_list|(
name|OutputFileName
argument_list|)
expr_stmt|;
call|(
name|dp
operator|->
name|put
call|)
argument_list|(
name|dp
argument_list|,
operator|&
name|key
argument_list|,
operator|&
name|data
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
block|{
name|char
name|OrderNum
index|[
literal|12
index|]
decl_stmt|;
name|struct
name|timeval
name|tv
decl_stmt|;
name|struct
name|timezone
name|tz
decl_stmt|;
name|gettimeofday
argument_list|(
operator|&
name|tv
argument_list|,
operator|&
name|tz
argument_list|)
expr_stmt|;
name|sprintf
argument_list|(
name|OrderNum
argument_list|,
literal|"%ld"
argument_list|,
name|tv
operator|.
name|tv_sec
argument_list|)
expr_stmt|;
name|key
operator|.
name|data
operator|=
literal|"YP_LAST_MODIFIED"
expr_stmt|;
name|key
operator|.
name|size
operator|=
name|strlen
argument_list|(
name|key
operator|.
name|data
argument_list|)
expr_stmt|;
name|data
operator|.
name|data
operator|=
name|OrderNum
expr_stmt|;
name|data
operator|.
name|size
operator|=
name|strlen
argument_list|(
name|OrderNum
argument_list|)
expr_stmt|;
call|(
name|dp
operator|->
name|put
call|)
argument_list|(
name|dp
argument_list|,
operator|&
name|key
argument_list|,
operator|&
name|data
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
for|for
control|(
init|;
condition|;
control|)
block|{
specifier|register
name|int
name|r
decl_stmt|;
name|fgets
argument_list|(
name|Buffer
argument_list|,
name|BUFFERSIZE
argument_list|,
name|infile
argument_list|)
expr_stmt|;
if|if
condition|(
name|feof
argument_list|(
name|infile
argument_list|)
condition|)
break|break;
if|if
condition|(
name|Buffer
index|[
literal|0
index|]
operator|==
literal|'+'
operator|||
name|Buffer
index|[
literal|0
index|]
operator|==
literal|'-'
condition|)
break|break;
name|r
operator|=
name|strlen
argument_list|(
name|Buffer
argument_list|)
operator|-
literal|1
expr_stmt|;
if|if
condition|(
name|Buffer
index|[
name|r
index|]
operator|!=
literal|'\n'
operator|&&
name|r
operator|>=
name|BUFFERSIZE
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"%s: Buffer overflow\n"
argument_list|,
name|FileName
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
else|else
name|Buffer
index|[
name|r
index|]
operator|=
literal|'\0'
expr_stmt|;
for|for
control|(
name|r
operator|=
literal|0
init|;
name|Buffer
index|[
name|r
index|]
condition|;
name|r
operator|++
control|)
block|{
if|if
condition|(
name|Buffer
index|[
name|r
index|]
operator|==
literal|' '
operator|||
name|Buffer
index|[
name|r
index|]
operator|==
literal|'\t'
condition|)
block|{
name|Buffer
index|[
name|r
index|]
operator|=
literal|'\0'
expr_stmt|;
name|r
operator|++
expr_stmt|;
break|break;
block|}
block|}
for|for
control|(
init|;
name|Buffer
index|[
name|r
index|]
condition|;
name|r
operator|++
control|)
if|if
condition|(
name|Buffer
index|[
name|r
index|]
operator|!=
literal|' '
operator|&&
name|Buffer
index|[
name|r
index|]
operator|!=
literal|'\t'
condition|)
break|break;
name|key
operator|.
name|data
operator|=
name|Buffer
expr_stmt|;
name|key
operator|.
name|size
operator|=
name|strlen
argument_list|(
name|Buffer
argument_list|)
expr_stmt|;
name|data
operator|.
name|data
operator|=
name|Buffer
operator|+
name|r
expr_stmt|;
name|data
operator|.
name|size
operator|=
name|strlen
argument_list|(
name|Buffer
operator|+
name|r
argument_list|)
expr_stmt|;
call|(
name|dp
operator|->
name|put
call|)
argument_list|(
name|dp
argument_list|,
operator|&
name|key
argument_list|,
operator|&
name|data
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
call|(
name|void
call|)
argument_list|(
name|dp
operator|->
name|close
argument_list|)
argument_list|(
name|dp
argument_list|)
expr_stmt|;
name|sprintf
argument_list|(
name|filename
argument_list|,
literal|"%s.db"
argument_list|,
name|DbName
argument_list|)
expr_stmt|;
name|sprintf
argument_list|(
name|filename2
argument_list|,
literal|"%s~.db"
argument_list|,
name|DbName
argument_list|)
expr_stmt|;
name|unlink
argument_list|(
name|filename
argument_list|)
expr_stmt|;
name|rename
argument_list|(
name|filename2
argument_list|,
name|filename
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|Usage
parameter_list|(
name|void
parameter_list|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"usage: yp_mkdb -u dbname\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"       yp_mkdb [-i inputfile] [-o outputfile]\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"               [-m mastername] inputfile dbname\n"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|main
parameter_list|(
name|int
name|argc
parameter_list|,
name|char
modifier|*
modifier|*
name|argv
parameter_list|)
block|{
name|int
name|UFlag
init|=
literal|0
decl_stmt|;
while|while
condition|(
literal|1
condition|)
block|{
name|int
name|c
init|=
name|getopt
argument_list|(
name|argc
argument_list|,
name|argv
argument_list|,
literal|"ui:o:m:d:"
argument_list|)
decl_stmt|;
if|if
condition|(
name|c
operator|==
name|EOF
condition|)
break|break;
switch|switch
condition|(
name|c
condition|)
block|{
case|case
literal|'u'
case|:
name|UFlag
operator|++
expr_stmt|;
break|break;
case|case
literal|'d'
case|:
name|DomainName
operator|=
name|optarg
expr_stmt|;
break|break;
case|case
literal|'i'
case|:
name|InputFileName
operator|=
name|optarg
expr_stmt|;
break|break;
case|case
literal|'o'
case|:
name|OutputFileName
operator|=
name|optarg
expr_stmt|;
break|break;
case|case
literal|'m'
case|:
name|MasterName
operator|=
name|optarg
expr_stmt|;
break|break;
case|case
literal|'?'
case|:
name|Usage
argument_list|()
expr_stmt|;
break|break;
block|}
block|}
name|argc
operator|-=
name|optind
expr_stmt|;
name|argv
operator|+=
name|optind
expr_stmt|;
if|if
condition|(
operator|!
name|MasterName
condition|)
block|{
if|if
condition|(
name|gethostname
argument_list|(
name|thisHost
argument_list|,
sizeof|sizeof
name|thisHost
argument_list|)
operator|<
literal|0
condition|)
block|{
name|perror
argument_list|(
literal|"gethostname"
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|struct
name|hostent
modifier|*
name|h
decl_stmt|;
name|h
operator|=
name|gethostbyname
argument_list|(
name|thisHost
argument_list|)
expr_stmt|;
if|if
condition|(
name|h
condition|)
name|strncpy
argument_list|(
name|thisHost
argument_list|,
name|h
operator|->
name|h_name
argument_list|,
sizeof|sizeof
name|thisHost
argument_list|)
expr_stmt|;
name|MasterName
operator|=
name|thisHost
expr_stmt|;
block|}
block|}
if|if
condition|(
name|UFlag
condition|)
block|{
if|if
condition|(
name|argc
operator|<
literal|1
condition|)
name|Usage
argument_list|()
expr_stmt|;
name|unLoad
argument_list|(
name|argv
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|argc
operator|<
literal|2
condition|)
name|Usage
argument_list|()
expr_stmt|;
name|load
argument_list|(
name|argv
index|[
literal|0
index|]
argument_list|,
name|argv
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
block|}
name|exit
argument_list|(
literal|0
argument_list|)
expr_stmt|;
block|}
end_function

end_unit


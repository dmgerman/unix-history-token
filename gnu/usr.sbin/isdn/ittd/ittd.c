begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_decl_stmt
specifier|static
name|char
name|rcsid
index|[]
init|=
literal|"@(#)$Id: ittd.c,v 1.2 1995/01/25 14:01:28 jkr Exp jkr $"
decl_stmt|;
end_decl_stmt

begin_comment
comment|/*******************************************************************************  *  II Version 0.1  -  $Revision: 1.2 $   $State: Exp $  *  * Copyright 1994 Dietmar Friede  *******************************************************************************  * Bug reports, patches, comments, suggestions should be sent to:  *  *	jkr@saarlink.de or jkrause@guug.de  *  *******************************************************************************  * $Log: ittd.c,v $  *  ******************************************************************************/
end_comment

begin_comment
comment|/* This is a ISDN-Daemon for tty dialin */
end_comment

begin_include
include|#
directive|include
file|<sys/types.h>
end_include

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_include
include|#
directive|include
file|<signal.h>
end_include

begin_include
include|#
directive|include
file|<errno.h>
end_include

begin_include
include|#
directive|include
file|<setjmp.h>
end_include

begin_include
include|#
directive|include
file|<string.h>
end_include

begin_include
include|#
directive|include
file|<stdlib.h>
end_include

begin_include
include|#
directive|include
file|<ctype.h>
end_include

begin_include
include|#
directive|include
file|<unistd.h>
end_include

begin_include
include|#
directive|include
file|<sys/ioctl.h>
end_include

begin_include
include|#
directive|include
file|<sys/file.h>
end_include

begin_include
include|#
directive|include
file|"../../../../sys/gnu/isdn/isdn_ioctl.h"
end_include

begin_define
define|#
directive|define
name|min
parameter_list|(
name|a
parameter_list|,
name|b
parameter_list|)
value|((a)<(b)?(a):(b))
end_define

begin_define
define|#
directive|define
name|NITTY
value|2
end_define

begin_define
define|#
directive|define
name|NOTTY
value|2
end_define

begin_define
define|#
directive|define
name|NTTY
value|(NITTY + NOTTY)
end_define

begin_decl_stmt
name|listen_t
name|listen
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|isdn_param
name|ip
index|[
name|NTTY
index|]
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|dial_t
name|dial
index|[
name|NOTTY
index|]
decl_stmt|;
end_decl_stmt

begin_struct
struct|struct
name|iline
block|{
name|char
name|occupied
decl_stmt|;
name|u_char
name|an
decl_stmt|,
name|cn
decl_stmt|;
name|char
name|no
index|[
literal|15
index|]
decl_stmt|;
block|}
name|iline
index|[
name|NTTY
index|]
struct|;
end_struct

begin_decl_stmt
name|int
name|dofork
init|=
literal|1
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|quit
init|=
literal|0
decl_stmt|,
name|rescan
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|jmp_buf
name|context
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|char
modifier|*
name|logfile
init|=
literal|"/var/log/isdn.itt"
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|char
modifier|*
name|configfile
init|=
literal|"/etc/isdn.itt"
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|subadr
decl_stmt|,
name|prot
decl_stmt|,
name|bsize
decl_stmt|,
name|timeout
decl_stmt|,
name|spv
decl_stmt|,
name|ui
decl_stmt|,
name|serv
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|def_subadr
init|=
literal|3
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|ind
decl_stmt|,
name|rind
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|char
name|rbuf
index|[
literal|2048
index|]
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|unsigned
name|short
name|si_mask
decl_stmt|;
end_decl_stmt

begin_function
name|void
name|catchsig
parameter_list|()
block|{
name|quit
operator|++
expr_stmt|;
name|longjmp
argument_list|(
name|context
argument_list|,
literal|1
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|catchsighup
parameter_list|()
block|{
name|rescan
operator|++
expr_stmt|;
operator|(
name|void
operator|)
name|signal
argument_list|(
name|SIGHUP
argument_list|,
name|catchsighup
argument_list|)
expr_stmt|;
name|longjmp
argument_list|(
name|context
argument_list|,
literal|1
argument_list|)
expr_stmt|;
block|}
end_function

begin_macro
name|setdefault
argument_list|()
end_macro

begin_block
block|{
name|subadr
operator|=
operator|-
literal|1
expr_stmt|;
name|prot
operator|=
literal|2
expr_stmt|;
name|ui
operator|=
literal|1
expr_stmt|;
name|serv
operator|=
literal|7
expr_stmt|;
name|timeout
operator|=
literal|0
expr_stmt|;
name|bsize
operator|=
literal|2048
expr_stmt|;
name|spv
operator|=
literal|0
expr_stmt|;
block|}
end_block

begin_function
name|char
modifier|*
name|gettoc
parameter_list|()
block|{
if|if
condition|(
name|rind
operator|==
operator|-
literal|1
condition|)
block|{
name|rind
operator|=
literal|0
expr_stmt|;
return|return
operator|(
name|rbuf
operator|)
return|;
block|}
while|while
condition|(
name|rbuf
index|[
operator|++
name|rind
index|]
condition|)
empty_stmt|;
name|rind
operator|++
expr_stmt|;
if|if
condition|(
name|rind
operator|>=
name|ind
condition|)
return|return
operator|(
name|NULL
operator|)
return|;
return|return
operator|(
operator|&
name|rbuf
index|[
name|rind
index|]
operator|)
return|;
block|}
end_function

begin_macro
name|filline
argument_list|(
argument|FILE * f
argument_list|)
end_macro

begin_block
block|{
name|int
name|c
decl_stmt|;
name|ind
operator|=
literal|1
expr_stmt|;
name|rbuf
index|[
literal|0
index|]
operator|=
literal|'H'
expr_stmt|;
while|while
condition|(
operator|(
name|c
operator|=
name|fgetc
argument_list|(
name|f
argument_list|)
operator|)
operator|!=
name|EOF
condition|)
block|{
if|if
condition|(
name|isalnum
argument_list|(
name|c
argument_list|)
condition|)
block|{
name|rbuf
index|[
name|ind
operator|++
index|]
operator|=
name|c
expr_stmt|;
block|}
else|else
switch|switch
condition|(
name|c
condition|)
block|{
case|case
literal|'#'
case|:
name|fgets
argument_list|(
name|rbuf
operator|+
name|ind
argument_list|,
literal|2048
operator|-
name|ind
argument_list|,
name|f
argument_list|)
expr_stmt|;
if|if
condition|(
name|ind
operator|==
literal|1
condition|)
break|break;
comment|/* Fall through */
case|case
literal|'\n'
case|:
name|rbuf
index|[
name|ind
index|]
operator|=
literal|0
expr_stmt|;
name|rind
operator|=
operator|-
literal|1
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
case|case
literal|':'
case|:
name|rbuf
index|[
name|ind
operator|++
index|]
operator|=
literal|0
expr_stmt|;
break|break;
block|}
block|}
if|if
condition|(
name|ind
operator|>
literal|1
condition|)
return|return
operator|(
literal|0
operator|)
return|;
return|return
operator|(
name|EOF
operator|)
return|;
block|}
end_block

begin_macro
name|process
argument_list|(
argument|FILE * f
argument_list|,
argument|int n
argument_list|)
end_macro

begin_block
block|{
name|char
modifier|*
name|p
decl_stmt|;
name|int
name|ap
init|=
literal|0
decl_stmt|;
name|setdefault
argument_list|()
expr_stmt|;
if|if
condition|(
name|filline
argument_list|(
name|f
argument_list|)
operator|!=
name|EOF
condition|)
block|{
while|while
condition|(
operator|(
name|p
operator|=
name|gettoc
argument_list|()
operator|)
operator|!=
name|NULL
condition|)
switch|switch
condition|(
name|p
index|[
literal|0
index|]
condition|)
block|{
case|case
literal|'A'
case|:
name|def_subadr
operator|=
name|p
index|[
literal|1
index|]
operator|-
literal|'0'
expr_stmt|;
name|listen
operator|.
name|subadr_mask
operator||=
literal|1
operator|<<
name|def_subadr
expr_stmt|;
break|break;
case|case
literal|'p'
case|:
switch|switch
condition|(
name|p
index|[
literal|1
index|]
condition|)
block|{
case|case
literal|'r'
case|:
name|serv
operator|=
literal|7
expr_stmt|;
name|prot
operator|=
literal|2
expr_stmt|;
name|ui
operator|=
literal|0
expr_stmt|;
break|break;
case|case
literal|'u'
case|:
name|serv
operator|=
literal|7
expr_stmt|;
name|prot
operator|=
literal|2
expr_stmt|;
name|ui
operator|=
literal|1
expr_stmt|;
break|break;
case|case
literal|'X'
case|:
name|serv
operator|=
literal|7
expr_stmt|;
name|prot
operator|=
literal|1
expr_stmt|;
name|ui
operator|=
literal|0
expr_stmt|;
break|break;
case|case
literal|'C'
case|:
name|serv
operator|=
literal|15
expr_stmt|;
name|prot
operator|=
literal|5
expr_stmt|;
name|ui
operator|=
literal|0
expr_stmt|;
break|break;
default|default:
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Protocoll not supported\n"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
literal|'w'
case|:
name|timeout
operator|=
name|atoi
argument_list|(
name|p
operator|+
literal|1
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'s'
case|:
name|bsize
operator|=
name|atoi
argument_list|(
name|p
operator|+
literal|1
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'S'
case|:
name|spv
operator|++
expr_stmt|;
break|break;
default|default:
block|}
block|}
for|for
control|(
name|ap
operator|=
literal|0
init|;
name|ap
operator|<
name|NTTY
condition|;
name|ap
operator|++
control|)
block|{
name|fillparam
argument_list|(
name|ap
argument_list|,
operator|&
name|ip
index|[
name|ap
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|ioctl
argument_list|(
name|n
argument_list|,
name|ISDN_SET_PARAM
argument_list|,
operator|&
name|ip
index|[
name|ap
index|]
argument_list|)
operator|<
literal|0
condition|)
block|{
name|perror
argument_list|(
literal|"ioctl: Set Param"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|3
argument_list|)
expr_stmt|;
block|}
block|}
name|listen
operator|.
name|si_mask
operator|=
name|si_mask
expr_stmt|;
if|if
condition|(
name|listen
operator|.
name|subadr_mask
operator|==
literal|0
condition|)
name|listen
operator|.
name|subadr_mask
operator||=
literal|1
operator|<<
name|def_subadr
expr_stmt|;
name|listen
operator|.
name|inf_mask
operator|=
literal|3
expr_stmt|;
name|listen
operator|.
name|ctrl
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|ioctl
argument_list|(
name|n
argument_list|,
name|ISDN_LISTEN
argument_list|,
operator|&
name|listen
argument_list|)
operator|<
literal|0
condition|)
block|{
name|perror
argument_list|(
literal|"ioctl: Listen"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|4
argument_list|)
expr_stmt|;
block|}
block|}
end_block

begin_macro
name|fillparam
argument_list|(
argument|int ap
argument_list|,
argument|isdn_param * ip
argument_list|)
end_macro

begin_block
block|{
if|if
condition|(
name|subadr
operator|==
operator|-
literal|1
condition|)
name|subadr
operator|=
name|def_subadr
expr_stmt|;
name|si_mask
operator||=
call|(
name|u_short
call|)
argument_list|(
literal|1
operator|<<
name|serv
argument_list|)
expr_stmt|;
comment|/* 	 * spv = 0; 	 */
name|bzero
argument_list|(
name|ip
argument_list|,
sizeof|sizeof
argument_list|(
name|isdn_param
argument_list|)
argument_list|)
expr_stmt|;
name|ip
operator|->
name|appl
operator|=
name|ap
expr_stmt|;
name|ip
operator|->
name|dlpd
operator|.
name|protokoll
operator|=
name|prot
expr_stmt|;
name|ip
operator|->
name|dlpd
operator|.
name|length
operator|=
literal|7
expr_stmt|;
name|ip
operator|->
name|dlpd
operator|.
name|data_length
operator|=
name|bsize
expr_stmt|;
name|ip
operator|->
name|timeout
operator|=
name|timeout
expr_stmt|;
name|ip
operator|->
name|prot
operator|=
name|ui
expr_stmt|;
name|ip
operator|->
name|ncpd
operator|.
name|protokoll
operator|=
literal|4
expr_stmt|;
block|}
end_block

begin_macro
name|realine
argument_list|(
argument|char *b
argument_list|)
end_macro

begin_block
block|{
name|int
name|c
decl_stmt|;
name|ind
operator|=
literal|0
expr_stmt|;
while|while
condition|(
name|c
operator|=
operator|*
name|b
operator|&
literal|0x7f
condition|)
block|{
name|b
operator|++
expr_stmt|;
if|if
condition|(
name|isalnum
argument_list|(
name|c
argument_list|)
condition|)
block|{
name|rbuf
index|[
name|ind
operator|++
index|]
operator|=
name|c
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|c
operator|==
literal|'.'
condition|)
name|rbuf
index|[
name|ind
operator|++
index|]
operator|=
literal|0
expr_stmt|;
block|}
if|if
condition|(
name|ind
operator|>
literal|1
condition|)
return|return
operator|(
literal|0
operator|)
return|;
return|return
operator|(
name|EOF
operator|)
return|;
block|}
end_block

begin_macro
name|process_dial
argument_list|(
argument|int n
argument_list|,
argument|int ap
argument_list|,
argument|char *b
argument_list|)
end_macro

begin_block
block|{
name|char
modifier|*
name|p
decl_stmt|;
name|telno_t
modifier|*
name|t
decl_stmt|;
name|setdefault
argument_list|()
expr_stmt|;
if|if
condition|(
name|realine
argument_list|(
name|b
argument_list|)
operator|==
name|EOF
condition|)
return|return;
name|rind
operator|=
operator|-
literal|1
expr_stmt|;
while|while
condition|(
operator|(
name|p
operator|=
name|gettoc
argument_list|()
operator|)
operator|!=
name|NULL
condition|)
block|{
switch|switch
condition|(
name|p
index|[
literal|0
index|]
condition|)
block|{
case|case
literal|'a'
case|:
name|subadr
operator|=
name|p
index|[
literal|1
index|]
operator|-
literal|'0'
expr_stmt|;
break|break;
case|case
literal|'d'
case|:
name|t
operator|=
operator|&
name|dial
index|[
name|ap
operator|-
name|NITTY
index|]
operator|.
name|telno
expr_stmt|;
name|t
operator|->
name|length
operator|=
name|strlen
argument_list|(
name|p
operator|+
literal|1
argument_list|)
operator|+
literal|1
expr_stmt|;
if|if
condition|(
name|t
operator|->
name|length
operator|>
literal|123
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"ISDN number too long\n"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
name|t
operator|->
name|no
index|[
literal|0
index|]
operator|=
literal|0x81
expr_stmt|;
name|strncpy
argument_list|(
operator|&
name|t
operator|->
name|no
index|[
literal|1
index|]
argument_list|,
name|p
operator|+
literal|1
argument_list|,
name|t
operator|->
name|length
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'p'
case|:
switch|switch
condition|(
name|p
index|[
literal|1
index|]
condition|)
block|{
case|case
literal|'r'
case|:
name|serv
operator|=
literal|7
expr_stmt|;
name|prot
operator|=
literal|2
expr_stmt|;
name|ui
operator|=
literal|0
expr_stmt|;
break|break;
case|case
literal|'u'
case|:
name|serv
operator|=
literal|7
expr_stmt|;
name|prot
operator|=
literal|2
expr_stmt|;
name|ui
operator|=
literal|1
expr_stmt|;
break|break;
case|case
literal|'X'
case|:
name|serv
operator|=
literal|7
expr_stmt|;
name|prot
operator|=
literal|1
expr_stmt|;
name|ui
operator|=
literal|0
expr_stmt|;
break|break;
case|case
literal|'C'
case|:
name|serv
operator|=
literal|15
expr_stmt|;
name|prot
operator|=
literal|5
expr_stmt|;
name|ui
operator|=
literal|0
expr_stmt|;
break|break;
default|default:
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Protocoll not supported\n"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
literal|'w'
case|:
name|timeout
operator|=
name|atoi
argument_list|(
name|p
operator|+
literal|1
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'s'
case|:
name|bsize
operator|=
name|atoi
argument_list|(
name|p
operator|+
literal|1
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'S'
case|:
name|spv
operator|++
expr_stmt|;
break|break;
default|default:
block|}
block|}
name|filldial
argument_list|(
name|ap
argument_list|,
operator|&
name|ip
index|[
name|ap
index|]
argument_list|,
operator|&
name|dial
index|[
name|ap
operator|-
name|NITTY
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|ioctl
argument_list|(
name|n
argument_list|,
name|ISDN_SET_PARAM
argument_list|,
operator|&
name|ip
index|[
name|ap
index|]
argument_list|)
operator|<
literal|0
condition|)
block|{
name|perror
argument_list|(
literal|"ioctl: Set Param"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|3
argument_list|)
expr_stmt|;
block|}
block|}
end_block

begin_macro
name|filldial
argument_list|(
argument|int ap
argument_list|,
argument|isdn_param * ip
argument_list|,
argument|dial_t * d
argument_list|)
end_macro

begin_block
block|{
if|if
condition|(
name|subadr
operator|==
operator|-
literal|1
condition|)
name|subadr
operator|=
name|def_subadr
expr_stmt|;
comment|/* 	 * spv = 0; 	 */
name|bzero
argument_list|(
name|ip
argument_list|,
sizeof|sizeof
argument_list|(
name|isdn_param
argument_list|)
argument_list|)
expr_stmt|;
name|d
operator|->
name|appl
operator|=
name|ip
operator|->
name|appl
operator|=
name|ap
expr_stmt|;
name|d
operator|->
name|b_channel
operator|=
literal|0x83
expr_stmt|;
name|d
operator|->
name|inf_mask
operator|=
literal|3
expr_stmt|;
name|d
operator|->
name|out_serv
operator|=
name|serv
expr_stmt|;
name|d
operator|->
name|src_subadr
operator|=
literal|'0'
operator|+
name|subadr
expr_stmt|;
name|ip
operator|->
name|dlpd
operator|.
name|protokoll
operator|=
name|prot
expr_stmt|;
name|ip
operator|->
name|dlpd
operator|.
name|length
operator|=
literal|7
expr_stmt|;
name|ip
operator|->
name|dlpd
operator|.
name|data_length
operator|=
name|bsize
expr_stmt|;
name|ip
operator|->
name|timeout
operator|=
name|timeout
expr_stmt|;
name|ip
operator|->
name|prot
operator|=
name|ui
expr_stmt|;
name|ip
operator|->
name|ncpd
operator|.
name|protokoll
operator|=
literal|4
expr_stmt|;
block|}
end_block

begin_function
name|void
name|main
parameter_list|(
name|int
name|argc
parameter_list|,
name|char
modifier|*
modifier|*
name|argv
parameter_list|)
block|{
name|FILE
modifier|*
name|f
decl_stmt|;
name|int
name|a
decl_stmt|,
name|n
decl_stmt|,
name|i
decl_stmt|;
name|u_char
name|buf
index|[
literal|4
index|]
decl_stmt|;
name|dofork
operator|=
literal|1
expr_stmt|;
while|while
condition|(
operator|(
name|i
operator|=
name|getopt
argument_list|(
name|argc
argument_list|,
name|argv
argument_list|,
literal|"c:l:F"
argument_list|)
operator|)
operator|!=
name|EOF
condition|)
switch|switch
condition|(
name|i
condition|)
block|{
default|default:
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Usage: ittd [ -F ] [ -c configfile ] [ -l logfile ]\n"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
case|case
literal|'c'
case|:
name|configfile
operator|=
name|optarg
expr_stmt|;
break|break;
case|case
literal|'l'
case|:
name|logfile
operator|=
name|optarg
expr_stmt|;
break|break;
case|case
literal|'F'
case|:
name|dofork
operator|=
literal|0
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|dofork
condition|)
block|{
if|if
condition|(
operator|(
name|i
operator|=
name|fork
argument_list|()
operator|)
operator|<
literal|0
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Can't fork, %m"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|i
operator|>
literal|0
condition|)
name|exit
argument_list|(
literal|0
argument_list|)
expr_stmt|;
block|}
comment|/* running as daemon now */
if|if
condition|(
name|freopen
argument_list|(
name|logfile
argument_list|,
literal|"a"
argument_list|,
name|stderr
argument_list|)
operator|==
name|NULL
condition|)
block|{
name|perror
argument_list|(
name|logfile
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|n
operator|=
name|open
argument_list|(
literal|"/dev/isdn1"
argument_list|,
name|O_RDWR
argument_list|)
operator|)
operator|<
literal|0
condition|)
block|{
name|perror
argument_list|(
literal|"open: /dev/isdn1"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|f
operator|=
name|fopen
argument_list|(
name|configfile
argument_list|,
literal|"r"
argument_list|)
operator|)
operator|==
name|NULL
condition|)
block|{
name|perror
argument_list|(
name|configfile
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
name|process
argument_list|(
name|f
argument_list|,
name|n
argument_list|)
expr_stmt|;
name|fclose
argument_list|(
name|f
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|signal
argument_list|(
name|SIGHUP
argument_list|,
name|catchsighup
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|signal
argument_list|(
name|SIGTERM
argument_list|,
name|catchsig
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|signal
argument_list|(
name|SIGKILL
argument_list|,
name|catchsig
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|signal
argument_list|(
name|SIGINT
argument_list|,
name|catchsig
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|signal
argument_list|(
name|SIGQUIT
argument_list|,
name|catchsig
argument_list|)
expr_stmt|;
name|rescan
operator|=
name|quit
operator|=
literal|0
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"s:ittd started\n"
argument_list|)
expr_stmt|;
name|fflush
argument_list|(
name|stderr
argument_list|)
expr_stmt|;
while|while
condition|(
literal|1
condition|)
block|{
name|int
name|l
decl_stmt|;
name|int
name|an
decl_stmt|,
name|cn
decl_stmt|,
name|serv
decl_stmt|,
name|serv_add
decl_stmt|,
name|subadr
decl_stmt|;
name|int
name|typ
decl_stmt|,
name|nl
decl_stmt|,
name|dl
decl_stmt|;
name|char
modifier|*
name|tn
decl_stmt|;
operator|(
name|void
operator|)
name|setjmp
argument_list|(
name|context
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|l
operator|=
name|read
argument_list|(
name|n
argument_list|,
name|rbuf
argument_list|,
literal|1024
argument_list|)
operator|)
operator|>
literal|0
condition|)
block|{
switch|switch
condition|(
name|rbuf
index|[
literal|0
index|]
condition|)
block|{
case|case
literal|'a'
case|:
name|sscanf
argument_list|(
name|rbuf
operator|+
literal|2
argument_list|,
literal|"%d %d %d %d %d %d %d %n"
argument_list|,
operator|&
name|an
argument_list|,
operator|&
name|cn
argument_list|,
operator|&
name|serv
argument_list|,
operator|&
name|serv_add
argument_list|,
operator|&
name|subadr
argument_list|,
operator|&
name|typ
argument_list|,
operator|&
name|nl
argument_list|,
operator|&
name|l
argument_list|)
expr_stmt|;
name|l
operator|+=
literal|2
expr_stmt|;
name|buf
index|[
literal|0
index|]
operator|=
name|cn
expr_stmt|;
name|buf
index|[
literal|1
index|]
operator|=
name|find_appl
argument_list|()
expr_stmt|;
name|buf
index|[
literal|2
index|]
operator|=
name|buf
index|[
literal|3
index|]
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|buf
index|[
literal|1
index|]
operator|==
literal|0xff
condition|)
block|{
name|buf
index|[
literal|2
index|]
operator|=
literal|0x3e
expr_stmt|;
comment|/* call reject */
block|}
if|if
condition|(
name|ioctl
argument_list|(
name|n
argument_list|,
name|ISDN_ACCEPT
argument_list|,
operator|&
name|buf
argument_list|)
operator|<
literal|0
condition|)
block|{
name|perror
argument_list|(
literal|"ioctl: Accept"
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|buf
index|[
literal|1
index|]
operator|==
literal|0xff
condition|)
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"r:%d:%s\n"
argument_list|,
name|an
argument_list|,
name|rbuf
operator|+
name|l
argument_list|)
expr_stmt|;
else|else
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"a:%d:%s\n"
argument_list|,
name|an
argument_list|,
name|rbuf
operator|+
name|l
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'i'
case|:
name|sscanf
argument_list|(
name|rbuf
operator|+
literal|2
argument_list|,
literal|"%d %d %d %n"
argument_list|,
operator|&
name|an
argument_list|,
operator|&
name|typ
argument_list|,
operator|&
name|nl
argument_list|,
operator|&
name|l
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"i:%d:%x:%s\n"
argument_list|,
name|an
argument_list|,
name|typ
argument_list|,
name|rbuf
operator|+
name|l
operator|+
literal|2
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|typ
condition|)
block|{
case|case
literal|2
case|:
break|break;
block|}
break|break;
case|case
literal|'C'
case|:
name|sscanf
argument_list|(
name|rbuf
operator|+
literal|2
argument_list|,
literal|"%d %d %d"
argument_list|,
operator|&
name|an
argument_list|,
operator|&
name|cn
argument_list|,
operator|&
name|dl
argument_list|)
expr_stmt|;
if|if
condition|(
name|dl
condition|)
block|{
name|buf
index|[
literal|0
index|]
operator|=
name|cn
expr_stmt|;
name|buf
index|[
literal|1
index|]
operator|=
name|an
expr_stmt|;
name|buf
index|[
literal|2
index|]
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|ioctl
argument_list|(
name|n
argument_list|,
name|ISDN_ACCEPT
argument_list|,
name|buf
argument_list|)
operator|<
literal|0
condition|)
block|{
name|perror
argument_list|(
literal|"ioctl: Accept"
argument_list|)
expr_stmt|;
block|}
block|}
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"C:%d:%d\n"
argument_list|,
name|an
argument_list|,
name|cn
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'D'
case|:
name|sscanf
argument_list|(
name|rbuf
operator|+
literal|2
argument_list|,
literal|"%d %d"
argument_list|,
operator|&
name|an
argument_list|,
operator|&
name|cn
argument_list|)
expr_stmt|;
name|iline
index|[
name|an
index|]
operator|.
name|occupied
operator|=
literal|0
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"D:%d:%d\n"
argument_list|,
name|an
argument_list|,
name|cn
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'M'
case|:
name|sscanf
argument_list|(
name|rbuf
operator|+
literal|2
argument_list|,
literal|"%d %n"
argument_list|,
operator|&
name|an
argument_list|,
operator|&
name|l
argument_list|)
expr_stmt|;
name|process_dial
argument_list|(
name|n
argument_list|,
name|an
argument_list|,
name|rbuf
operator|+
name|l
operator|+
literal|2
argument_list|)
expr_stmt|;
if|if
condition|(
name|ioctl
argument_list|(
name|n
argument_list|,
name|ISDN_DIAL
argument_list|,
operator|&
name|dial
index|[
name|an
operator|-
name|NITTY
index|]
argument_list|)
operator|<
literal|0
condition|)
block|{
name|perror
argument_list|(
literal|"ioctl: Dial"
argument_list|)
expr_stmt|;
block|}
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"d:%d:%s\n"
argument_list|,
name|an
argument_list|,
operator|&
name|dial
index|[
name|an
operator|-
name|NITTY
index|]
operator|.
name|telno
operator|.
name|no
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
break|break;
default|default:
break|break;
block|}
block|}
if|if
condition|(
name|quit
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"s:Quit\n"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|0
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|rescan
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"s:rescan\n"
argument_list|)
expr_stmt|;
name|rescan
operator|=
literal|0
expr_stmt|;
if|if
condition|(
operator|(
name|f
operator|=
name|fopen
argument_list|(
name|configfile
argument_list|,
literal|"r"
argument_list|)
operator|)
operator|==
name|NULL
condition|)
name|perror
argument_list|(
name|configfile
argument_list|)
expr_stmt|;
else|else
block|{
name|process
argument_list|(
name|f
argument_list|,
name|n
argument_list|)
expr_stmt|;
name|fclose
argument_list|(
name|f
argument_list|)
expr_stmt|;
block|}
block|}
name|fflush
argument_list|(
name|stderr
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
name|int
name|find_appl
parameter_list|()
block|{
name|int
name|i
decl_stmt|;
name|struct
name|iline
modifier|*
name|a
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|NITTY
condition|;
name|i
operator|++
control|)
block|{
name|a
operator|=
operator|&
name|iline
index|[
name|i
index|]
expr_stmt|;
if|if
condition|(
name|a
operator|->
name|occupied
operator|==
literal|0
condition|)
block|{
name|a
operator|->
name|occupied
operator|=
literal|1
expr_stmt|;
return|return
operator|(
name|i
operator|)
return|;
block|}
block|}
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
end_function

end_unit


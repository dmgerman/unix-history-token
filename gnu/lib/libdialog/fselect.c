begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * program:	fselect.c  * author:	Marc van Kempen (wmbfmk@urc.tue.nl)  * Desc:	File selection routine  *  * Copyright (c) 1995, Marc van Kempen  *  * All rights reserved.  *  * This software may be used, modified, copied, distributed, and  * sold, in both source and binary form provided that the above  * copyright and these terms are retained, verbatim, as the first  * lines of this file.  Under no circumstances is the author  * responsible for the proper functioning of this software, nor does  * the author assume any responsibility for damages incurred with  * its use.  *  */
end_comment

begin_include
include|#
directive|include
file|<stdlib.h>
end_include

begin_include
include|#
directive|include
file|<unistd.h>
end_include

begin_include
include|#
directive|include
file|<sys/param.h>
end_include

begin_include
include|#
directive|include
file|<dialog.h>
end_include

begin_include
include|#
directive|include
file|"ui_objects.h"
end_include

begin_include
include|#
directive|include
file|"dir.h"
end_include

begin_include
include|#
directive|include
file|"dialog.priv.h"
end_include

begin_comment
comment|/*  * Local prototypes  */
end_comment

begin_function_decl
name|char
modifier|*
name|dialog_dfselect
parameter_list|(
name|char
modifier|*
name|dir
parameter_list|,
name|char
modifier|*
name|fmask
parameter_list|,
name|int
name|is_fselect
parameter_list|)
function_decl|;
end_function_decl

begin_comment
comment|/*  * Functions  */
end_comment

begin_function
name|void
name|get_directories
parameter_list|(
name|DirList
modifier|*
name|d
parameter_list|,
name|int
name|n
parameter_list|,
name|char
modifier|*
modifier|*
modifier|*
name|names
parameter_list|,
name|int
modifier|*
name|nd
parameter_list|)
comment|/*  * Desc: return the directorienames in<dir> as an array in  *<names>, the # of entries in<nd>, memory allocated  *       to *names should be freed when done with it.  */
block|{
name|int
name|i
decl_stmt|;
comment|/* count the directories, which are in front */
operator|*
name|nd
operator|=
literal|0
expr_stmt|;
while|while
condition|(
operator|(
operator|*
name|nd
operator|<
name|n
operator|)
operator|&&
operator|(
name|S_ISDIR
argument_list|(
name|d
index|[
operator|*
name|nd
index|]
operator|.
name|filestatus
operator|.
name|st_mode
argument_list|)
operator|)
condition|)
operator|(
operator|*
name|nd
operator|)
operator|++
expr_stmt|;
operator|*
name|names
operator|=
operator|(
name|char
operator|*
operator|*
operator|)
name|malloc
argument_list|(
operator|*
name|nd
operator|*
sizeof|sizeof
argument_list|(
name|char
operator|*
argument_list|)
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
operator|*
name|nd
condition|;
name|i
operator|++
control|)
block|{
operator|(
operator|*
name|names
operator|)
index|[
name|i
index|]
operator|=
operator|(
name|char
operator|*
operator|)
name|malloc
argument_list|(
name|strlen
argument_list|(
name|d
index|[
name|i
index|]
operator|.
name|filename
argument_list|)
operator|+
literal|1
argument_list|)
expr_stmt|;
name|strcpy
argument_list|(
operator|(
operator|*
name|names
operator|)
index|[
name|i
index|]
argument_list|,
name|d
index|[
name|i
index|]
operator|.
name|filename
argument_list|)
expr_stmt|;
block|}
return|return;
block|}
end_function

begin_comment
comment|/* get_directories() */
end_comment

begin_function
name|void
name|get_filenames
parameter_list|(
name|DirList
modifier|*
name|d
parameter_list|,
name|int
name|n
parameter_list|,
name|char
modifier|*
modifier|*
modifier|*
name|names
parameter_list|,
name|int
modifier|*
name|nf
parameter_list|)
comment|/*  * Desc: return the filenames in<dir> as an arry in  *<names>, the # of entries in<nf>, memory allocated  *	 to *names should be freed when done.  */
block|{
name|int
name|nd
decl_stmt|,
name|i
decl_stmt|;
comment|/* the # of regular files is the total # of files - # of directories */
comment|/* count the # of directories */
name|nd
operator|=
literal|0
expr_stmt|;
while|while
condition|(
operator|(
name|nd
operator|<
name|n
operator|)
operator|&&
operator|(
name|S_ISDIR
argument_list|(
name|d
index|[
name|nd
index|]
operator|.
name|filestatus
operator|.
name|st_mode
argument_list|)
operator|)
condition|)
name|nd
operator|++
expr_stmt|;
operator|*
name|names
operator|=
operator|(
name|char
operator|*
operator|*
operator|)
name|malloc
argument_list|(
operator|(
name|n
operator|-
name|nd
operator|)
operator|*
sizeof|sizeof
argument_list|(
name|char
operator|*
argument_list|)
argument_list|)
expr_stmt|;
operator|*
name|nf
operator|=
name|n
operator|-
name|nd
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
operator|*
name|nf
condition|;
name|i
operator|++
control|)
block|{
operator|(
operator|*
name|names
operator|)
index|[
name|i
index|]
operator|=
operator|(
name|char
operator|*
operator|)
name|malloc
argument_list|(
name|strlen
argument_list|(
name|d
index|[
name|i
operator|+
name|nd
index|]
operator|.
name|filename
argument_list|)
operator|+
literal|1
argument_list|)
expr_stmt|;
name|strcpy
argument_list|(
operator|(
operator|*
name|names
operator|)
index|[
name|i
index|]
argument_list|,
name|d
index|[
name|i
operator|+
name|nd
index|]
operator|.
name|filename
argument_list|)
expr_stmt|;
block|}
return|return;
block|}
end_function

begin_comment
comment|/* get_filenames() */
end_comment

begin_function
name|void
name|FreeNames
parameter_list|(
name|char
modifier|*
modifier|*
name|names
parameter_list|,
name|int
name|n
parameter_list|)
comment|/*  * Desc: free the space occupied by names  */
block|{
name|int
name|i
decl_stmt|;
comment|/* free the space occupied by names */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|n
condition|;
name|i
operator|++
control|)
block|{
name|free
argument_list|(
name|names
index|[
name|i
index|]
argument_list|)
expr_stmt|;
block|}
name|free
argument_list|(
name|names
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_comment
comment|/* FreeNames() */
end_comment

begin_function
name|int
name|dialog_dselect_old
parameter_list|(
name|void
parameter_list|)
comment|/*  * Desc: starting from the current directory,  *	 choose a new current directory  */
block|{
name|DirList
modifier|*
name|d
init|=
name|NULL
decl_stmt|;
name|char
modifier|*
modifier|*
name|names
decl_stmt|,
name|old_dir
index|[
name|MAXPATHLEN
index|]
decl_stmt|;
name|WINDOW
modifier|*
name|ds_win
decl_stmt|;
name|ButtonObj
modifier|*
name|okbut
decl_stmt|,
modifier|*
name|cancelbut
decl_stmt|;
name|ListObj
modifier|*
name|dirs_obj
decl_stmt|;
name|StringObj
modifier|*
name|dir_obj
decl_stmt|;
name|char
name|o_dir
index|[
name|MAXPATHLEN
index|]
decl_stmt|;
name|struct
name|ComposeObj
modifier|*
name|obj
init|=
name|NULL
decl_stmt|;
name|int
name|n
decl_stmt|,
name|nd
decl_stmt|,
name|okbutton
decl_stmt|,
name|cancelbutton
decl_stmt|,
name|quit
decl_stmt|,
name|cancel
decl_stmt|,
name|ret
decl_stmt|;
name|ds_win
operator|=
name|newwin
argument_list|(
name|LINES
operator|-
literal|8
argument_list|,
name|COLS
operator|-
literal|30
argument_list|,
literal|4
argument_list|,
literal|15
argument_list|)
expr_stmt|;
if|if
condition|(
name|ds_win
operator|==
name|NULL
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"\nnewwin(%d,%d,%d,%d) failed, maybe wrong dims\n"
argument_list|,
name|LINES
operator|-
literal|8
argument_list|,
name|COLS
operator|-
literal|30
argument_list|,
literal|4
argument_list|,
literal|15
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
name|draw_box
argument_list|(
name|ds_win
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
name|LINES
operator|-
literal|8
argument_list|,
name|COLS
operator|-
literal|30
argument_list|,
name|dialog_attr
argument_list|,
name|border_attr
argument_list|)
expr_stmt|;
name|wattrset
argument_list|(
name|ds_win
argument_list|,
name|dialog_attr
argument_list|)
expr_stmt|;
name|mvwaddstr
argument_list|(
name|ds_win
argument_list|,
literal|0
argument_list|,
operator|(
name|COLS
operator|-
literal|30
operator|)
operator|/
literal|2
operator|-
literal|9
argument_list|,
literal|" Directory Select "
argument_list|)
expr_stmt|;
name|draw_shadow
argument_list|(
name|stdscr
argument_list|,
literal|4
argument_list|,
literal|15
argument_list|,
name|LINES
operator|-
literal|8
argument_list|,
name|COLS
operator|-
literal|30
argument_list|)
expr_stmt|;
name|display_helpline
argument_list|(
name|ds_win
argument_list|,
name|LINES
operator|-
literal|9
argument_list|,
name|COLS
operator|-
literal|30
argument_list|)
expr_stmt|;
comment|/* the Directory string input field */
name|getcwd
argument_list|(
name|o_dir
argument_list|,
name|MAXPATHLEN
argument_list|)
expr_stmt|;
name|dir_obj
operator|=
name|NewStringObj
argument_list|(
name|ds_win
argument_list|,
literal|"Directory:"
argument_list|,
name|o_dir
argument_list|,
literal|1
argument_list|,
literal|2
argument_list|,
name|COLS
operator|-
literal|34
argument_list|,
name|MAXPATHLEN
operator|-
literal|1
argument_list|)
expr_stmt|;
name|AddObj
argument_list|(
operator|&
name|obj
argument_list|,
name|STRINGOBJ
argument_list|,
operator|(
name|void
operator|*
operator|)
name|dir_obj
argument_list|)
expr_stmt|;
comment|/* the list of directories */
name|get_dir
argument_list|(
literal|"."
argument_list|,
literal|"*"
argument_list|,
operator|&
name|d
argument_list|,
operator|&
name|n
argument_list|)
expr_stmt|;
name|get_directories
argument_list|(
name|d
argument_list|,
name|n
argument_list|,
operator|&
name|names
argument_list|,
operator|&
name|nd
argument_list|)
expr_stmt|;
name|dirs_obj
operator|=
name|NewListObj
argument_list|(
name|ds_win
argument_list|,
literal|"Directories:"
argument_list|,
name|names
argument_list|,
name|o_dir
argument_list|,
literal|5
argument_list|,
literal|2
argument_list|,
name|LINES
operator|-
literal|15
argument_list|,
name|COLS
operator|-
literal|48
argument_list|,
name|nd
argument_list|)
expr_stmt|;
name|AddObj
argument_list|(
operator|&
name|obj
argument_list|,
name|LISTOBJ
argument_list|,
operator|(
name|void
operator|*
operator|)
name|dirs_obj
argument_list|)
expr_stmt|;
comment|/* the Ok-button */
name|okbutton
operator|=
name|FALSE
expr_stmt|;
name|okbut
operator|=
name|NewButtonObj
argument_list|(
name|ds_win
argument_list|,
literal|"Continue"
argument_list|,
operator|&
name|okbutton
argument_list|,
literal|7
argument_list|,
name|COLS
operator|-
literal|45
argument_list|)
expr_stmt|;
name|AddObj
argument_list|(
operator|&
name|obj
argument_list|,
name|BUTTONOBJ
argument_list|,
operator|(
name|void
operator|*
operator|)
name|okbut
argument_list|)
expr_stmt|;
comment|/* the Cancel-button */
name|cancelbutton
operator|=
name|FALSE
expr_stmt|;
name|cancelbut
operator|=
name|NewButtonObj
argument_list|(
name|ds_win
argument_list|,
literal|"Return"
argument_list|,
operator|&
name|cancelbutton
argument_list|,
literal|11
argument_list|,
name|COLS
operator|-
literal|44
argument_list|)
expr_stmt|;
name|AddObj
argument_list|(
operator|&
name|obj
argument_list|,
name|BUTTONOBJ
argument_list|,
operator|(
name|void
operator|*
operator|)
name|cancelbut
argument_list|)
expr_stmt|;
name|quit
operator|=
name|FALSE
expr_stmt|;
name|cancel
operator|=
name|FALSE
expr_stmt|;
name|strcpy
argument_list|(
name|old_dir
argument_list|,
name|o_dir
argument_list|)
expr_stmt|;
while|while
condition|(
operator|!
name|quit
condition|)
block|{
name|ret
operator|=
name|PollObj
argument_list|(
operator|&
name|obj
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|ret
condition|)
block|{
case|case
name|SEL_BUTTON
case|:
if|if
condition|(
name|okbutton
condition|)
block|{
name|quit
operator|=
name|TRUE
expr_stmt|;
block|}
if|if
condition|(
name|cancelbutton
condition|)
block|{
name|quit
operator|=
name|TRUE
expr_stmt|;
name|cancel
operator|=
name|TRUE
expr_stmt|;
block|}
break|break;
case|case
name|SEL_CR
case|:
if|if
condition|(
name|strcmp
argument_list|(
name|old_dir
argument_list|,
name|o_dir
argument_list|)
condition|)
block|{
comment|/* the directory was changed, cd into it */
if|if
condition|(
name|chdir
argument_list|(
name|o_dir
argument_list|)
condition|)
block|{
name|dialog_notify
argument_list|(
literal|"Could not change into directory"
argument_list|)
expr_stmt|;
name|strcpy
argument_list|(
name|o_dir
argument_list|,
name|old_dir
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|getcwd
argument_list|(
name|o_dir
argument_list|,
name|MAXPATHLEN
argument_list|)
expr_stmt|;
name|strcpy
argument_list|(
name|old_dir
argument_list|,
name|o_dir
argument_list|)
expr_stmt|;
block|}
name|RefreshStringObj
argument_list|(
name|dir_obj
argument_list|)
expr_stmt|;
block|}
name|get_dir
argument_list|(
literal|"."
argument_list|,
literal|"*"
argument_list|,
operator|&
name|d
argument_list|,
operator|&
name|n
argument_list|)
expr_stmt|;
name|FreeNames
argument_list|(
name|names
argument_list|,
name|nd
argument_list|)
expr_stmt|;
name|get_directories
argument_list|(
name|d
argument_list|,
name|n
argument_list|,
operator|&
name|names
argument_list|,
operator|&
name|nd
argument_list|)
expr_stmt|;
name|UpdateListObj
argument_list|(
name|dirs_obj
argument_list|,
name|names
argument_list|,
name|nd
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
operator|(
name|obj
operator|->
name|prev
operator|)
operator|->
name|obj
operator|==
operator|(
name|void
operator|*
operator|)
name|dirs_obj
operator|)
condition|)
block|{
name|obj
operator|=
name|obj
operator|->
name|prev
expr_stmt|;
block|}
break|break;
case|case
name|SEL_ESC
case|:
name|quit
operator|=
name|TRUE
expr_stmt|;
name|cancel
operator|=
name|TRUE
expr_stmt|;
break|break;
case|case
name|KEY_F
argument_list|(
literal|1
argument_list|)
case|:
name|display_helpfile
argument_list|()
expr_stmt|;
break|break;
block|}
block|}
name|FreeNames
argument_list|(
name|names
argument_list|,
name|nd
argument_list|)
expr_stmt|;
name|DelObj
argument_list|(
name|obj
argument_list|)
expr_stmt|;
name|delwin
argument_list|(
name|ds_win
argument_list|)
expr_stmt|;
return|return
operator|(
name|cancel
operator|)
return|;
block|}
end_function

begin_comment
comment|/* dialog_dselect() */
end_comment

begin_function
name|int
name|dialog_dselect
parameter_list|(
name|char
modifier|*
name|dir
parameter_list|,
name|char
modifier|*
name|fmask
parameter_list|)
comment|/*  * Desc: Choose a directory  */
block|{
if|if
condition|(
name|dialog_dfselect
argument_list|(
name|dir
argument_list|,
name|fmask
argument_list|,
name|FALSE
argument_list|)
condition|)
block|{
return|return
operator|(
name|FALSE
operator|)
return|;
comment|/* esc or cancel was pressed */
block|}
else|else
block|{
return|return
operator|(
name|TRUE
operator|)
return|;
comment|/* directory was selected */
block|}
block|}
end_function

begin_comment
comment|/* dialog_dselect() */
end_comment

begin_function
name|char
modifier|*
name|dialog_fselect
parameter_list|(
name|char
modifier|*
name|dir
parameter_list|,
name|char
modifier|*
name|fmask
parameter_list|)
comment|/*  * Desc: Choose a file from a directory  */
block|{
return|return
operator|(
name|dialog_dfselect
argument_list|(
name|dir
argument_list|,
name|fmask
argument_list|,
name|TRUE
argument_list|)
operator|)
return|;
block|}
end_function

begin_comment
comment|/* dialog_fselect() */
end_comment

begin_function
name|char
modifier|*
name|dialog_dfselect
parameter_list|(
name|char
modifier|*
name|dir
parameter_list|,
name|char
modifier|*
name|fmask
parameter_list|,
name|int
name|is_fselect
parameter_list|)
comment|/*  * Desc: choose a file from the directory<dir>, which  *	 initially display files with the mask<filemask>  * pre:<dir> is the initial directory  *	 only files corresponding to the mask<fmask> are displayed  * post: returns NULL if no file was selected  *       else returns pointer to filename, space is allocated, should  *       be freed after use.  */
block|{
name|DirList
modifier|*
name|d
init|=
name|NULL
decl_stmt|;
name|char
name|msg
index|[
literal|512
index|]
decl_stmt|;
name|char
modifier|*
modifier|*
name|fnames
decl_stmt|,
modifier|*
modifier|*
name|dnames
decl_stmt|,
modifier|*
name|ret_name
decl_stmt|;
name|WINDOW
modifier|*
name|fs_win
decl_stmt|;
name|int
name|n
decl_stmt|,
name|nd
decl_stmt|,
name|nf
decl_stmt|,
name|ret
decl_stmt|;
name|StringObj
modifier|*
name|fm_obj
decl_stmt|,
modifier|*
name|dir_obj
decl_stmt|,
modifier|*
name|sel_obj
decl_stmt|;
name|char
name|o_fm
index|[
literal|255
index|]
decl_stmt|,
name|o_dir
index|[
name|MAXPATHLEN
index|]
decl_stmt|,
name|o_sel
index|[
name|MAXPATHLEN
index|]
decl_stmt|;
name|char
name|old_fmask
index|[
literal|255
index|]
decl_stmt|,
name|old_dir
index|[
name|MAXPATHLEN
index|]
decl_stmt|;
name|ListObj
modifier|*
name|dirs_obj
decl_stmt|,
modifier|*
name|files_obj
decl_stmt|;
name|struct
name|ComposeObj
modifier|*
name|obj
init|=
name|NULL
decl_stmt|,
modifier|*
name|o
decl_stmt|;
name|int
name|quit
decl_stmt|,
name|cancel
decl_stmt|;
name|ButtonObj
modifier|*
name|okbut_obj
decl_stmt|,
modifier|*
name|canbut_obj
decl_stmt|;
name|int
name|ok_button
decl_stmt|,
name|cancel_button
decl_stmt|;
if|if
condition|(
name|chdir
argument_list|(
name|dir
argument_list|)
condition|)
block|{
name|sprintf
argument_list|(
name|msg
argument_list|,
literal|"Could not move into specified directory: %s"
argument_list|,
name|dir
argument_list|)
expr_stmt|;
name|dialog_notify
argument_list|(
name|msg
argument_list|)
expr_stmt|;
return|return
operator|(
name|NULL
operator|)
return|;
block|}
name|getcwd
argument_list|(
name|o_dir
argument_list|,
name|MAXPATHLEN
argument_list|)
expr_stmt|;
comment|/* setup the fileselect-window and initialize its components */
name|fs_win
operator|=
name|newwin
argument_list|(
name|LINES
operator|-
literal|2
argument_list|,
name|COLS
operator|-
literal|20
argument_list|,
literal|1
argument_list|,
literal|10
argument_list|)
expr_stmt|;
if|if
condition|(
name|fs_win
operator|==
name|NULL
condition|)
block|{
name|endwin
argument_list|()
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"\nnewwin(%d,%d,%d,%d) failed, maybe wrong dims\n"
argument_list|,
name|LINES
operator|-
literal|2
argument_list|,
name|COLS
operator|-
literal|20
argument_list|,
literal|2
argument_list|,
literal|10
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
name|draw_box
argument_list|(
name|fs_win
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
name|LINES
operator|-
literal|2
argument_list|,
name|COLS
operator|-
literal|20
argument_list|,
name|dialog_attr
argument_list|,
name|border_attr
argument_list|)
expr_stmt|;
name|wattrset
argument_list|(
name|fs_win
argument_list|,
name|dialog_attr
argument_list|)
expr_stmt|;
if|if
condition|(
name|is_fselect
condition|)
block|{
name|mvwaddstr
argument_list|(
name|fs_win
argument_list|,
literal|0
argument_list|,
operator|(
name|COLS
operator|-
literal|20
operator|)
operator|/
literal|2
operator|-
literal|7
argument_list|,
literal|" File Select "
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|mvwaddstr
argument_list|(
name|fs_win
argument_list|,
literal|0
argument_list|,
operator|(
name|COLS
operator|-
literal|20
operator|)
operator|/
literal|2
operator|-
literal|9
argument_list|,
literal|" Directory Select "
argument_list|)
expr_stmt|;
block|}
name|draw_shadow
argument_list|(
name|stdscr
argument_list|,
literal|1
argument_list|,
literal|10
argument_list|,
name|LINES
operator|-
literal|2
argument_list|,
name|COLS
operator|-
literal|20
argument_list|)
expr_stmt|;
name|display_helpline
argument_list|(
name|fs_win
argument_list|,
name|LINES
operator|-
literal|3
argument_list|,
name|COLS
operator|-
literal|20
argument_list|)
expr_stmt|;
comment|/* Filemask entry */
name|strcpy
argument_list|(
name|o_fm
argument_list|,
name|fmask
argument_list|)
expr_stmt|;
name|fm_obj
operator|=
name|NewStringObj
argument_list|(
name|fs_win
argument_list|,
literal|"Filemask:"
argument_list|,
name|o_fm
argument_list|,
literal|1
argument_list|,
literal|2
argument_list|,
literal|19
argument_list|,
literal|255
argument_list|)
expr_stmt|;
name|AddObj
argument_list|(
operator|&
name|obj
argument_list|,
name|STRINGOBJ
argument_list|,
operator|(
name|void
operator|*
operator|)
name|fm_obj
argument_list|)
expr_stmt|;
comment|/* Directory entry */
name|dir_obj
operator|=
name|NewStringObj
argument_list|(
name|fs_win
argument_list|,
literal|"Directory:"
argument_list|,
name|o_dir
argument_list|,
literal|1
argument_list|,
literal|22
argument_list|,
name|COLS
operator|-
literal|44
argument_list|,
literal|255
argument_list|)
expr_stmt|;
name|AddObj
argument_list|(
operator|&
name|obj
argument_list|,
name|STRINGOBJ
argument_list|,
operator|(
name|void
operator|*
operator|)
name|dir_obj
argument_list|)
expr_stmt|;
comment|/* Directory list */
name|get_dir
argument_list|(
literal|"."
argument_list|,
name|fmask
argument_list|,
operator|&
name|d
argument_list|,
operator|&
name|n
argument_list|)
expr_stmt|;
comment|/* read the entire directory */
name|get_directories
argument_list|(
name|d
argument_list|,
name|n
argument_list|,
operator|&
name|dnames
argument_list|,
operator|&
name|nd
argument_list|)
expr_stmt|;
comment|/* extract the dir-entries */
if|if
condition|(
name|is_fselect
condition|)
block|{
name|dirs_obj
operator|=
name|NewListObj
argument_list|(
name|fs_win
argument_list|,
literal|"Directories:"
argument_list|,
name|dnames
argument_list|,
name|o_dir
argument_list|,
literal|5
argument_list|,
literal|2
argument_list|,
name|LINES
operator|-
literal|16
argument_list|,
operator|(
name|COLS
operator|-
literal|20
operator|)
operator|/
literal|2
operator|-
literal|2
argument_list|,
name|nd
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|dirs_obj
operator|=
name|NewListObj
argument_list|(
name|fs_win
argument_list|,
literal|"Directories:"
argument_list|,
name|dnames
argument_list|,
name|o_dir
argument_list|,
literal|5
argument_list|,
literal|2
argument_list|,
name|LINES
operator|-
literal|12
argument_list|,
operator|(
name|COLS
operator|-
literal|20
operator|)
operator|/
literal|2
operator|-
literal|2
argument_list|,
name|nd
argument_list|)
expr_stmt|;
block|}
name|AddObj
argument_list|(
operator|&
name|obj
argument_list|,
name|LISTOBJ
argument_list|,
operator|(
name|void
operator|*
operator|)
name|dirs_obj
argument_list|)
expr_stmt|;
comment|/* Filenames list */
name|get_filenames
argument_list|(
name|d
argument_list|,
name|n
argument_list|,
operator|&
name|fnames
argument_list|,
operator|&
name|nf
argument_list|)
expr_stmt|;
comment|/* extract the filenames */
if|if
condition|(
name|is_fselect
condition|)
block|{
name|files_obj
operator|=
name|NewListObj
argument_list|(
name|fs_win
argument_list|,
literal|"Files:"
argument_list|,
name|fnames
argument_list|,
name|o_sel
argument_list|,
literal|5
argument_list|,
operator|(
name|COLS
operator|-
literal|20
operator|)
operator|/
literal|2
operator|+
literal|1
argument_list|,
name|LINES
operator|-
literal|16
argument_list|,
operator|(
name|COLS
operator|-
literal|20
operator|)
operator|/
literal|2
operator|-
literal|3
argument_list|,
name|nf
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|files_obj
operator|=
name|NewListObj
argument_list|(
name|fs_win
argument_list|,
literal|"Files:"
argument_list|,
name|fnames
argument_list|,
name|o_sel
argument_list|,
literal|5
argument_list|,
operator|(
name|COLS
operator|-
literal|20
operator|)
operator|/
literal|2
operator|+
literal|1
argument_list|,
name|LINES
operator|-
literal|12
argument_list|,
operator|(
name|COLS
operator|-
literal|20
operator|)
operator|/
literal|2
operator|-
literal|3
argument_list|,
name|nf
argument_list|)
expr_stmt|;
block|}
name|AddObj
argument_list|(
operator|&
name|obj
argument_list|,
name|LISTOBJ
argument_list|,
operator|(
name|void
operator|*
operator|)
name|files_obj
argument_list|)
expr_stmt|;
if|if
condition|(
name|is_fselect
condition|)
block|{
comment|/* Selection entry */
name|o_sel
index|[
literal|0
index|]
operator|=
literal|'\0'
expr_stmt|;
name|sel_obj
operator|=
name|NewStringObj
argument_list|(
name|fs_win
argument_list|,
literal|"Selection:"
argument_list|,
name|o_sel
argument_list|,
name|LINES
operator|-
literal|10
argument_list|,
literal|2
argument_list|,
name|COLS
operator|-
literal|24
argument_list|,
literal|255
argument_list|)
expr_stmt|;
name|AddObj
argument_list|(
operator|&
name|obj
argument_list|,
name|STRINGOBJ
argument_list|,
operator|(
name|void
operator|*
operator|)
name|sel_obj
argument_list|)
expr_stmt|;
block|}
comment|/* Ok button */
name|ok_button
operator|=
name|FALSE
expr_stmt|;
name|okbut_obj
operator|=
name|NewButtonObj
argument_list|(
name|fs_win
argument_list|,
literal|"Ok"
argument_list|,
operator|&
name|ok_button
argument_list|,
name|LINES
operator|-
literal|6
argument_list|,
literal|20
argument_list|)
expr_stmt|;
name|AddObj
argument_list|(
operator|&
name|obj
argument_list|,
name|BUTTONOBJ
argument_list|,
operator|(
name|void
operator|*
operator|)
name|okbut_obj
argument_list|)
expr_stmt|;
comment|/* Cancel button */
name|cancel_button
operator|=
name|FALSE
expr_stmt|;
name|canbut_obj
operator|=
name|NewButtonObj
argument_list|(
name|fs_win
argument_list|,
literal|"Cancel"
argument_list|,
operator|&
name|cancel_button
argument_list|,
name|LINES
operator|-
literal|6
argument_list|,
literal|30
argument_list|)
expr_stmt|;
name|AddObj
argument_list|(
operator|&
name|obj
argument_list|,
name|BUTTONOBJ
argument_list|,
operator|(
name|void
operator|*
operator|)
name|canbut_obj
argument_list|)
expr_stmt|;
comment|/* Make sure all objects on the window are drawn */
name|wrefresh
argument_list|(
name|fs_win
argument_list|)
expr_stmt|;
name|keypad
argument_list|(
name|fs_win
argument_list|,
name|TRUE
argument_list|)
expr_stmt|;
comment|/* Start the reading */
name|o
operator|=
name|obj
expr_stmt|;
name|strcpy
argument_list|(
name|old_fmask
argument_list|,
name|o_fm
argument_list|)
expr_stmt|;
name|strcpy
argument_list|(
name|old_dir
argument_list|,
name|o_dir
argument_list|)
expr_stmt|;
name|quit
operator|=
name|FALSE
expr_stmt|;
name|cancel
operator|=
name|FALSE
expr_stmt|;
while|while
condition|(
operator|!
name|quit
condition|)
block|{
name|ret
operator|=
name|PollObj
argument_list|(
operator|&
name|o
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|ret
condition|)
block|{
case|case
name|SEL_CR
case|:
if|if
condition|(
name|strcmp
argument_list|(
name|old_fmask
argument_list|,
name|o_fm
argument_list|)
operator|||
name|strcmp
argument_list|(
name|old_dir
argument_list|,
name|o_dir
argument_list|)
condition|)
block|{
comment|/* reread directory and update the listobjects */
if|if
condition|(
name|strcmp
argument_list|(
name|old_dir
argument_list|,
name|o_dir
argument_list|)
condition|)
block|{
comment|/* dir entry was changed */
if|if
condition|(
name|chdir
argument_list|(
name|o_dir
argument_list|)
condition|)
block|{
name|dialog_notify
argument_list|(
literal|"Could not change into directory"
argument_list|)
expr_stmt|;
name|strcpy
argument_list|(
name|o_dir
argument_list|,
name|old_dir
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|getcwd
argument_list|(
name|o_dir
argument_list|,
name|MAXPATHLEN
argument_list|)
expr_stmt|;
name|strcpy
argument_list|(
name|old_dir
argument_list|,
name|o_dir
argument_list|)
expr_stmt|;
block|}
name|RefreshStringObj
argument_list|(
name|dir_obj
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|/* fmask entry was changed */
name|strcpy
argument_list|(
name|old_fmask
argument_list|,
name|o_fm
argument_list|)
expr_stmt|;
block|}
name|get_dir
argument_list|(
literal|"."
argument_list|,
name|o_fm
argument_list|,
operator|&
name|d
argument_list|,
operator|&
name|n
argument_list|)
expr_stmt|;
name|FreeNames
argument_list|(
name|dnames
argument_list|,
name|nd
argument_list|)
expr_stmt|;
name|get_directories
argument_list|(
name|d
argument_list|,
name|n
argument_list|,
operator|&
name|dnames
argument_list|,
operator|&
name|nd
argument_list|)
expr_stmt|;
name|UpdateListObj
argument_list|(
name|dirs_obj
argument_list|,
name|dnames
argument_list|,
name|nd
argument_list|)
expr_stmt|;
name|FreeNames
argument_list|(
name|fnames
argument_list|,
name|nf
argument_list|)
expr_stmt|;
name|get_filenames
argument_list|(
name|d
argument_list|,
name|n
argument_list|,
operator|&
name|fnames
argument_list|,
operator|&
name|nf
argument_list|)
expr_stmt|;
name|UpdateListObj
argument_list|(
name|files_obj
argument_list|,
name|fnames
argument_list|,
name|nf
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
operator|(
name|o
operator|->
name|prev
operator|)
operator|->
name|obj
operator|==
operator|(
name|void
operator|*
operator|)
name|dirs_obj
operator|)
condition|)
block|{
name|o
operator|=
name|o
operator|->
name|prev
expr_stmt|;
block|}
block|}
break|break;
case|case
name|SEL_BUTTON
case|:
comment|/* check which button was pressed */
if|if
condition|(
name|ok_button
condition|)
block|{
name|quit
operator|=
name|TRUE
expr_stmt|;
block|}
if|if
condition|(
name|cancel_button
condition|)
block|{
name|quit
operator|=
name|TRUE
expr_stmt|;
name|cancel
operator|=
name|TRUE
expr_stmt|;
block|}
break|break;
case|case
name|SEL_ESC
case|:
name|quit
operator|=
name|TRUE
expr_stmt|;
name|cancel
operator|=
name|TRUE
expr_stmt|;
break|break;
case|case
name|KEY_F
argument_list|(
literal|1
argument_list|)
case|:
case|case
literal|'?'
case|:
name|display_helpfile
argument_list|()
expr_stmt|;
break|break;
block|}
block|}
name|DelObj
argument_list|(
name|obj
argument_list|)
expr_stmt|;
name|FreeNames
argument_list|(
name|dnames
argument_list|,
name|nd
argument_list|)
expr_stmt|;
name|FreeNames
argument_list|(
name|fnames
argument_list|,
name|nf
argument_list|)
expr_stmt|;
name|delwin
argument_list|(
name|fs_win
argument_list|)
expr_stmt|;
if|if
condition|(
name|cancel
operator|||
operator|(
name|strlen
argument_list|(
name|o_sel
argument_list|)
operator|==
literal|0
operator|)
condition|)
block|{
return|return
operator|(
name|NULL
operator|)
return|;
block|}
else|else
block|{
name|ret_name
operator|=
operator|(
name|char
operator|*
operator|)
name|malloc
argument_list|(
name|strlen
argument_list|(
name|o_sel
argument_list|)
operator|+
literal|1
argument_list|)
expr_stmt|;
name|strcpy
argument_list|(
name|ret_name
argument_list|,
name|o_sel
argument_list|)
expr_stmt|;
return|return
operator|(
name|ret_name
operator|)
return|;
block|}
block|}
end_function

begin_comment
comment|/* dialog_fselect() */
end_comment

end_unit


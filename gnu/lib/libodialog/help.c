begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/***************************************************************  *  * Program:	help.c  * Author:	Marc van Kempen  * Desc:	get help  *  *  * Copyright (c) 1995, Marc van Kempen  *  * All rights reserved.  *  * This software may be used, modified, copied, distributed, and  * sold, in both source and binary form provided that the above  * copyright and these terms are retained, verbatim, as the first  * lines of this file.  Under no circumstances is the author  * responsible for the proper functioning of this software, nor does  * the author assume any responsibility for damages incurred with  * its use.  *  ***************************************************************/
end_comment

begin_include
include|#
directive|include
file|<stdlib.h>
end_include

begin_include
include|#
directive|include
file|<sys/param.h>
end_include

begin_include
include|#
directive|include
file|<sys/types.h>
end_include

begin_include
include|#
directive|include
file|<sys/stat.h>
end_include

begin_include
include|#
directive|include
file|<string.h>
end_include

begin_include
include|#
directive|include
file|<dialog.h>
end_include

begin_decl_stmt
specifier|static
name|char
name|_helpfilebuf
index|[
name|MAXPATHLEN
index|]
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|char
name|_helplinebuf
index|[
literal|77
index|]
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* limit the helpline to 76 characters */
end_comment

begin_decl_stmt
specifier|static
name|char
modifier|*
name|_helpfile
init|=
name|NULL
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|char
modifier|*
name|_helpline
init|=
name|NULL
decl_stmt|;
end_decl_stmt

begin_comment
comment|/******************************************************************  *  * 	helpfile routines  *  ******************************************************************/
end_comment

begin_function
name|void
name|use_helpfile
parameter_list|(
name|char
modifier|*
name|hfile
parameter_list|)
comment|/*  * desc: set the helpfile to be opened on pressing F1 to<helpfile>  */
block|{
if|if
condition|(
name|hfile
operator|!=
name|NULL
condition|)
block|{
name|_helpfile
operator|=
name|_helpfilebuf
expr_stmt|;
name|strcpy
argument_list|(
name|_helpfile
argument_list|,
name|hfile
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|_helpfile
operator|=
name|NULL
expr_stmt|;
block|}
return|return;
block|}
end_function

begin_comment
comment|/* use_helpfile() */
end_comment

begin_function
name|void
name|display_helpfile
parameter_list|(
name|void
parameter_list|)
comment|/*  * desc: display the current helpfile in a window  */
block|{
name|WINDOW
modifier|*
name|w
decl_stmt|;
name|FILE
modifier|*
name|f
decl_stmt|;
name|struct
name|stat
name|sb
decl_stmt|;
name|char
name|msg
index|[
literal|80
index|]
decl_stmt|,
modifier|*
name|buf
decl_stmt|;
specifier|static
name|int
name|in_help
init|=
name|FALSE
decl_stmt|;
name|char
modifier|*
name|savehline
init|=
name|NULL
decl_stmt|;
if|if
condition|(
name|in_help
condition|)
return|return;
comment|/* dont call help when you're in help */
if|if
condition|(
name|_helpfile
operator|!=
name|NULL
condition|)
block|{
if|if
condition|(
operator|(
name|w
operator|=
name|dupwin
argument_list|(
name|newscr
argument_list|)
operator|)
operator|==
name|NULL
condition|)
block|{
name|dialog_notify
argument_list|(
literal|"No memory to dup previous screen\n"
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
operator|(
name|f
operator|=
name|fopen
argument_list|(
name|_helpfile
argument_list|,
literal|"r"
argument_list|)
operator|)
operator|==
name|NULL
condition|)
block|{
name|sprintf
argument_list|(
name|msg
argument_list|,
literal|"Can't open helpfile : %s\n"
argument_list|,
name|_helpfile
argument_list|)
expr_stmt|;
name|dialog_notify
argument_list|(
name|msg
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|fstat
argument_list|(
name|fileno
argument_list|(
name|f
argument_list|)
argument_list|,
operator|&
name|sb
argument_list|)
condition|)
block|{
name|sprintf
argument_list|(
name|msg
argument_list|,
literal|"Can't stat helpfile : %s\n"
argument_list|,
name|_helpfile
argument_list|)
expr_stmt|;
name|dialog_notify
argument_list|(
name|msg
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
operator|(
name|buf
operator|=
operator|(
name|char
operator|*
operator|)
name|malloc
argument_list|(
name|sb
operator|.
name|st_size
argument_list|)
operator|)
operator|==
name|NULL
condition|)
block|{
name|sprintf
argument_list|(
name|msg
argument_list|,
literal|"Could not malloc space for helpfile : %s\n"
argument_list|,
name|_helpfile
argument_list|)
expr_stmt|;
name|dialog_notify
argument_list|(
name|msg
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|fread
argument_list|(
name|buf
argument_list|,
literal|1
argument_list|,
name|sb
operator|.
name|st_size
argument_list|,
name|f
argument_list|)
operator|!=
name|sb
operator|.
name|st_size
condition|)
block|{
name|sprintf
argument_list|(
name|msg
argument_list|,
literal|"Could not read entire help file : %s"
argument_list|,
name|_helpfile
argument_list|)
expr_stmt|;
name|dialog_notify
argument_list|(
name|msg
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|buf
argument_list|)
expr_stmt|;
return|return;
block|}
name|buf
index|[
name|sb
operator|.
name|st_size
index|]
operator|=
literal|0
expr_stmt|;
name|in_help
operator|=
name|TRUE
expr_stmt|;
name|savehline
operator|=
name|get_helpline
argument_list|()
expr_stmt|;
name|use_helpline
argument_list|(
literal|"Use arrowkeys, PgUp, PgDn, Home and End to move through text"
argument_list|)
expr_stmt|;
name|dialog_mesgbox
argument_list|(
literal|"Online help"
argument_list|,
name|buf
argument_list|,
name|LINES
operator|-
literal|4
argument_list|,
name|COLS
operator|-
literal|4
argument_list|)
expr_stmt|;
name|restore_helpline
argument_list|(
name|savehline
argument_list|)
expr_stmt|;
name|in_help
operator|=
name|FALSE
expr_stmt|;
name|touchwin
argument_list|(
name|w
argument_list|)
expr_stmt|;
name|wrefresh
argument_list|(
name|w
argument_list|)
expr_stmt|;
name|delwin
argument_list|(
name|w
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|buf
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|/* do nothing */
block|}
return|return;
block|}
end_function

begin_comment
comment|/* display_helpfile() */
end_comment

begin_comment
comment|/******************************************************************  *  * 	helpline routines  *  ******************************************************************/
end_comment

begin_function
name|void
name|use_helpline
parameter_list|(
name|char
modifier|*
name|hline
parameter_list|)
comment|/*  * desc: set the helpline to printed in dialogs  */
block|{
if|if
condition|(
name|hline
condition|)
block|{
name|_helpline
operator|=
name|_helplinebuf
expr_stmt|;
if|if
condition|(
name|strlen
argument_list|(
name|hline
argument_list|)
operator|>
literal|76
condition|)
block|{
comment|/* only display the first 76 characters in the helpline */
name|strncpy
argument_list|(
name|_helpline
argument_list|,
name|hline
argument_list|,
literal|76
argument_list|)
expr_stmt|;
name|_helpline
index|[
literal|76
index|]
operator|=
literal|0
expr_stmt|;
block|}
else|else
block|{
name|strcpy
argument_list|(
name|_helpline
argument_list|,
name|hline
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
name|_helpline
operator|=
name|NULL
expr_stmt|;
block|}
return|return;
block|}
end_function

begin_comment
comment|/* use_helpline() */
end_comment

begin_function
name|void
name|display_helpline
parameter_list|(
name|WINDOW
modifier|*
name|w
parameter_list|,
name|int
name|y
parameter_list|,
name|int
name|width
parameter_list|)
comment|/*  * desc: display the helpline at the given coordinates<y, x> in the window<w>  */
block|{
if|if
condition|(
name|_helpline
operator|!=
name|NULL
condition|)
block|{
if|if
condition|(
name|strlen
argument_list|(
name|_helpline
argument_list|)
operator|>
name|width
operator|-
literal|6
condition|)
block|{
name|_helpline
index|[
name|width
operator|-
literal|6
index|]
operator|=
literal|0
expr_stmt|;
block|}
name|wmove
argument_list|(
name|w
argument_list|,
name|y
argument_list|,
call|(
name|int
call|)
argument_list|(
name|width
operator|-
name|strlen
argument_list|(
name|_helpline
argument_list|)
operator|-
literal|4
argument_list|)
operator|/
literal|2
argument_list|)
expr_stmt|;
name|wattrset
argument_list|(
name|w
argument_list|,
name|title_attr
argument_list|)
expr_stmt|;
name|waddstr
argument_list|(
name|w
argument_list|,
literal|"[ "
argument_list|)
expr_stmt|;
name|waddstr
argument_list|(
name|w
argument_list|,
name|_helpline
argument_list|)
expr_stmt|;
name|waddstr
argument_list|(
name|w
argument_list|,
literal|" ]"
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|/* do nothing */
block|}
return|return;
block|}
end_function

begin_function
name|char
modifier|*
name|get_helpline
parameter_list|(
name|void
parameter_list|)
comment|/*  * desc: allocate new space, copy the helpline to it and return a pointer to it  */
block|{
name|char
modifier|*
name|hlp
decl_stmt|;
if|if
condition|(
name|_helpline
condition|)
block|{
name|hlp
operator|=
operator|(
name|char
operator|*
operator|)
name|malloc
argument_list|(
name|strlen
argument_list|(
name|_helpline
argument_list|)
operator|+
literal|1
argument_list|)
expr_stmt|;
name|strcpy
argument_list|(
name|hlp
argument_list|,
name|_helpline
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|hlp
operator|=
name|NULL
expr_stmt|;
block|}
return|return
operator|(
name|hlp
operator|)
return|;
block|}
end_function

begin_comment
comment|/* get_helpline() */
end_comment

begin_function
name|void
name|restore_helpline
parameter_list|(
name|char
modifier|*
name|helpline
parameter_list|)
comment|/*  * Desc: set the helpline to<helpline> and free the space allocated to it  */
block|{
name|use_helpline
argument_list|(
name|helpline
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|helpline
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_comment
comment|/* restore_helpline() */
end_comment

end_unit


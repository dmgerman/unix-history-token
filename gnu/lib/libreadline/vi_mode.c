begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/* vi_mode.c -- A vi emulation mode for Bash.     Derived from code written by Jeff Sparkes (jeff1@????).  */
end_comment

begin_escape
end_escape

begin_comment
comment|/* **************************************************************** */
end_comment

begin_comment
comment|/*								    */
end_comment

begin_comment
comment|/*			VI Emulation Mode			    */
end_comment

begin_comment
comment|/*								    */
end_comment

begin_comment
comment|/* **************************************************************** */
end_comment

begin_comment
comment|/* Last string searched for from `/' or `?'. */
end_comment

begin_decl_stmt
specifier|static
name|char
modifier|*
name|vi_last_search
init|=
operator|(
name|char
operator|*
operator|)
name|NULL
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|vi_histpos
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* Non-zero means enter insertion mode. */
end_comment

begin_decl_stmt
name|int
name|vi_doing_insert
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* *** UNCLEAN *** */
end_comment

begin_comment
comment|/* Command keys which do movement for xxx_to commands. */
end_comment

begin_decl_stmt
specifier|static
name|char
modifier|*
name|vi_motion
init|=
literal|" hl^$0ftFt;,%wbeWBE|"
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* Keymap used for vi replace characters.  Created dynamically since    rarely used. */
end_comment

begin_decl_stmt
specifier|static
name|Keymap
name|vi_replace_map
init|=
operator|(
name|Keymap
operator|)
name|NULL
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* The number of characters inserted in the last replace operation. */
end_comment

begin_expr_stmt
specifier|static
name|vi_replace_count
operator|=
literal|0
expr_stmt|;
end_expr_stmt

begin_comment
comment|/* Yank the nth arg from the previous line into this line at point. */
end_comment

begin_macro
name|rl_vi_yank_arg
argument_list|(
argument|count
argument_list|)
end_macro

begin_decl_stmt
name|int
name|count
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|rl_yank_nth_arg
argument_list|(
name|count
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
end_block

begin_comment
comment|/* Search again for the last thing searched for. */
end_comment

begin_macro
name|rl_vi_search_again
argument_list|(
argument|ignore
argument_list|,
argument|key
argument_list|)
end_macro

begin_decl_stmt
name|int
name|ignore
decl_stmt|,
name|key
decl_stmt|;
end_decl_stmt

begin_block
block|{
switch|switch
condition|(
name|key
condition|)
block|{
case|case
literal|'n'
case|:
name|rl_vi_dosearch
argument_list|(
name|vi_last_search
argument_list|,
operator|-
literal|1
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'N'
case|:
name|rl_vi_dosearch
argument_list|(
name|vi_last_search
argument_list|,
literal|1
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
end_block

begin_comment
comment|/* Do a vi style search. */
end_comment

begin_macro
name|rl_vi_search
argument_list|(
argument|count
argument_list|,
argument|key
argument_list|)
end_macro

begin_decl_stmt
name|int
name|count
decl_stmt|,
name|key
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|int
name|dir
decl_stmt|,
name|c
decl_stmt|,
name|save_pos
decl_stmt|;
name|char
modifier|*
name|p
decl_stmt|;
switch|switch
condition|(
name|key
condition|)
block|{
case|case
literal|'?'
case|:
name|dir
operator|=
literal|1
expr_stmt|;
break|break;
case|case
literal|'/'
case|:
name|dir
operator|=
operator|-
literal|1
expr_stmt|;
break|break;
default|default:
name|ding
argument_list|()
expr_stmt|;
return|return;
block|}
name|vi_histpos
operator|=
name|where_history
argument_list|()
expr_stmt|;
name|maybe_save_line
argument_list|()
expr_stmt|;
name|save_pos
operator|=
name|rl_point
expr_stmt|;
comment|/* Reuse the line input buffer to read the search string. */
name|the_line
index|[
literal|0
index|]
operator|=
literal|0
expr_stmt|;
name|rl_end
operator|=
name|rl_point
operator|=
literal|0
expr_stmt|;
name|p
operator|=
operator|(
name|char
operator|*
operator|)
name|alloca
argument_list|(
literal|2
operator|+
operator|(
name|rl_prompt
condition|?
name|strlen
argument_list|(
name|rl_prompt
argument_list|)
else|:
literal|0
operator|)
argument_list|)
expr_stmt|;
name|sprintf
argument_list|(
name|p
argument_list|,
literal|"%s%c"
argument_list|,
name|rl_prompt
condition|?
name|rl_prompt
else|:
literal|""
argument_list|,
name|key
argument_list|)
expr_stmt|;
name|rl_message
argument_list|(
name|p
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
while|while
condition|(
name|c
operator|=
name|rl_read_key
argument_list|()
condition|)
block|{
switch|switch
condition|(
name|c
condition|)
block|{
case|case
name|CTRL
argument_list|(
literal|'H'
argument_list|)
case|:
case|case
name|RUBOUT
case|:
if|if
condition|(
name|rl_point
operator|==
literal|0
condition|)
block|{
name|maybe_unsave_line
argument_list|()
expr_stmt|;
name|rl_clear_message
argument_list|()
expr_stmt|;
name|rl_point
operator|=
name|save_pos
expr_stmt|;
return|return;
block|}
case|case
name|CTRL
argument_list|(
literal|'W'
argument_list|)
case|:
case|case
name|CTRL
argument_list|(
literal|'U'
argument_list|)
case|:
name|rl_dispatch
argument_list|(
name|c
argument_list|,
name|keymap
argument_list|)
expr_stmt|;
break|break;
case|case
name|ESC
case|:
case|case
name|RETURN
case|:
case|case
name|NEWLINE
case|:
goto|goto
name|dosearch
goto|;
break|break;
case|case
name|CTRL
argument_list|(
literal|'C'
argument_list|)
case|:
name|maybe_unsave_line
argument_list|()
expr_stmt|;
name|rl_clear_message
argument_list|()
expr_stmt|;
name|rl_point
operator|=
literal|0
expr_stmt|;
name|ding
argument_list|()
expr_stmt|;
return|return;
default|default:
name|rl_insert
argument_list|(
literal|1
argument_list|,
name|c
argument_list|)
expr_stmt|;
break|break;
block|}
name|rl_redisplay
argument_list|()
expr_stmt|;
block|}
name|dosearch
label|:
if|if
condition|(
name|vi_last_search
condition|)
name|free
argument_list|(
name|vi_last_search
argument_list|)
expr_stmt|;
name|vi_last_search
operator|=
name|savestring
argument_list|(
name|the_line
argument_list|)
expr_stmt|;
name|rl_vi_dosearch
argument_list|(
name|the_line
argument_list|,
name|dir
argument_list|)
expr_stmt|;
block|}
end_block

begin_macro
name|rl_vi_dosearch
argument_list|(
argument|string
argument_list|,
argument|dir
argument_list|)
end_macro

begin_decl_stmt
name|char
modifier|*
name|string
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|dir
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|int
name|old
decl_stmt|,
name|save
init|=
name|vi_histpos
decl_stmt|;
name|HIST_ENTRY
modifier|*
name|h
decl_stmt|;
if|if
condition|(
name|string
operator|==
literal|0
operator|||
operator|*
name|string
operator|==
literal|0
operator|||
name|vi_histpos
operator|<
literal|0
condition|)
block|{
name|ding
argument_list|()
expr_stmt|;
return|return;
block|}
if|if
condition|(
operator|(
name|save
operator|=
name|history_search_pos
argument_list|(
name|string
argument_list|,
name|dir
argument_list|,
name|vi_histpos
operator|+
name|dir
argument_list|)
operator|)
operator|==
operator|-
literal|1
condition|)
block|{
name|maybe_unsave_line
argument_list|()
expr_stmt|;
name|rl_clear_message
argument_list|()
expr_stmt|;
name|rl_point
operator|=
literal|0
expr_stmt|;
name|ding
argument_list|()
expr_stmt|;
return|return;
block|}
name|vi_histpos
operator|=
name|save
expr_stmt|;
name|old
operator|=
name|where_history
argument_list|()
expr_stmt|;
name|history_set_pos
argument_list|(
name|vi_histpos
argument_list|)
expr_stmt|;
name|h
operator|=
name|current_history
argument_list|()
expr_stmt|;
name|history_set_pos
argument_list|(
name|old
argument_list|)
expr_stmt|;
name|strcpy
argument_list|(
name|the_line
argument_list|,
name|h
operator|->
name|line
argument_list|)
expr_stmt|;
name|rl_undo_list
operator|=
operator|(
name|UNDO_LIST
operator|*
operator|)
name|h
operator|->
name|data
expr_stmt|;
name|rl_end
operator|=
name|strlen
argument_list|(
name|the_line
argument_list|)
expr_stmt|;
name|rl_point
operator|=
literal|0
expr_stmt|;
name|rl_clear_message
argument_list|()
expr_stmt|;
block|}
end_block

begin_comment
comment|/* Completion, from vi's point of view. */
end_comment

begin_macro
name|rl_vi_complete
argument_list|(
argument|ignore
argument_list|,
argument|key
argument_list|)
end_macro

begin_decl_stmt
name|int
name|ignore
decl_stmt|,
name|key
decl_stmt|;
end_decl_stmt

begin_block
block|{
if|if
condition|(
operator|(
name|rl_point
operator|<
name|rl_end
operator|)
operator|&&
operator|(
operator|!
name|whitespace
argument_list|(
name|the_line
index|[
name|rl_point
index|]
argument_list|)
operator|)
condition|)
block|{
if|if
condition|(
operator|!
name|whitespace
argument_list|(
name|the_line
index|[
name|rl_point
operator|+
literal|1
index|]
argument_list|)
condition|)
name|rl_vi_end_word
argument_list|(
literal|1
argument_list|,
literal|'E'
argument_list|)
expr_stmt|;
name|rl_point
operator|++
expr_stmt|;
block|}
if|if
condition|(
name|key
operator|==
literal|'*'
condition|)
name|rl_complete_internal
argument_list|(
literal|'*'
argument_list|)
expr_stmt|;
else|else
name|rl_complete
argument_list|(
literal|0
argument_list|,
name|key
argument_list|)
expr_stmt|;
name|rl_vi_insertion_mode
argument_list|()
expr_stmt|;
block|}
end_block

begin_comment
comment|/* Previous word in vi mode. */
end_comment

begin_macro
name|rl_vi_prev_word
argument_list|(
argument|count
argument_list|,
argument|key
argument_list|)
end_macro

begin_decl_stmt
name|int
name|count
decl_stmt|,
name|key
decl_stmt|;
end_decl_stmt

begin_block
block|{
if|if
condition|(
name|count
operator|<
literal|0
condition|)
block|{
name|rl_vi_next_word
argument_list|(
operator|-
name|count
argument_list|,
name|key
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|uppercase_p
argument_list|(
name|key
argument_list|)
condition|)
name|rl_vi_bWord
argument_list|(
name|count
argument_list|)
expr_stmt|;
else|else
name|rl_vi_bword
argument_list|(
name|count
argument_list|)
expr_stmt|;
block|}
end_block

begin_comment
comment|/* Next word in vi mode. */
end_comment

begin_macro
name|rl_vi_next_word
argument_list|(
argument|count
argument_list|,
argument|key
argument_list|)
end_macro

begin_decl_stmt
name|int
name|count
decl_stmt|;
end_decl_stmt

begin_block
block|{
if|if
condition|(
name|count
operator|<
literal|0
condition|)
block|{
name|rl_vi_prev_word
argument_list|(
operator|-
name|count
argument_list|,
name|key
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|uppercase_p
argument_list|(
name|key
argument_list|)
condition|)
name|rl_vi_fWord
argument_list|(
name|count
argument_list|)
expr_stmt|;
else|else
name|rl_vi_fword
argument_list|(
name|count
argument_list|)
expr_stmt|;
block|}
end_block

begin_comment
comment|/* Move to the end of the ?next? word. */
end_comment

begin_macro
name|rl_vi_end_word
argument_list|(
argument|count
argument_list|,
argument|key
argument_list|)
end_macro

begin_decl_stmt
name|int
name|count
decl_stmt|,
name|key
decl_stmt|;
end_decl_stmt

begin_block
block|{
if|if
condition|(
name|count
operator|<
literal|0
condition|)
block|{
name|ding
argument_list|()
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|uppercase_p
argument_list|(
name|key
argument_list|)
condition|)
name|rl_vi_eWord
argument_list|(
name|count
argument_list|)
expr_stmt|;
else|else
name|rl_vi_eword
argument_list|(
name|count
argument_list|)
expr_stmt|;
block|}
end_block

begin_comment
comment|/* Move forward a word the way that 'W' does. */
end_comment

begin_comment
comment|/* Move forward a word the way that 'W' does. */
end_comment

begin_macro
name|rl_vi_fWord
argument_list|(
argument|count
argument_list|)
end_macro

begin_decl_stmt
name|int
name|count
decl_stmt|;
end_decl_stmt

begin_block
block|{
while|while
condition|(
name|count
operator|--
operator|&&
name|rl_point
operator|<
operator|(
name|rl_end
operator|-
literal|1
operator|)
condition|)
block|{
comment|/* Skip until whitespace. */
while|while
condition|(
operator|!
name|whitespace
argument_list|(
name|the_line
index|[
name|rl_point
index|]
argument_list|)
operator|&&
name|rl_point
operator|<
name|rl_end
condition|)
name|rl_point
operator|++
expr_stmt|;
comment|/* Now skip whitespace. */
while|while
condition|(
name|whitespace
argument_list|(
name|the_line
index|[
name|rl_point
index|]
argument_list|)
operator|&&
name|rl_point
operator|<
name|rl_end
condition|)
name|rl_point
operator|++
expr_stmt|;
block|}
block|}
end_block

begin_macro
name|rl_vi_bWord
argument_list|(
argument|count
argument_list|)
end_macro

begin_decl_stmt
name|int
name|count
decl_stmt|;
end_decl_stmt

begin_block
block|{
while|while
condition|(
name|count
operator|--
operator|&&
name|rl_point
operator|>
literal|0
condition|)
block|{
comment|/* If we are at the start of a word, move back to whitespace so          we will go back to the start of the previous word. */
if|if
condition|(
operator|!
name|whitespace
argument_list|(
name|the_line
index|[
name|rl_point
index|]
argument_list|)
operator|&&
name|whitespace
argument_list|(
name|the_line
index|[
name|rl_point
operator|-
literal|1
index|]
argument_list|)
condition|)
name|rl_point
operator|--
expr_stmt|;
while|while
condition|(
name|rl_point
operator|>
literal|0
operator|&&
name|whitespace
argument_list|(
name|the_line
index|[
name|rl_point
index|]
argument_list|)
condition|)
name|rl_point
operator|--
expr_stmt|;
if|if
condition|(
name|rl_point
operator|>
literal|0
condition|)
block|{
while|while
condition|(
operator|--
name|rl_point
operator|>=
literal|0
operator|&&
operator|!
name|whitespace
argument_list|(
name|the_line
index|[
name|rl_point
index|]
argument_list|)
condition|)
empty_stmt|;
name|rl_point
operator|++
expr_stmt|;
block|}
block|}
block|}
end_block

begin_macro
name|rl_vi_eWord
argument_list|(
argument|count
argument_list|)
end_macro

begin_decl_stmt
name|int
name|count
decl_stmt|;
end_decl_stmt

begin_block
block|{
while|while
condition|(
name|count
operator|--
operator|&&
name|rl_point
operator|<
operator|(
name|rl_end
operator|-
literal|1
operator|)
condition|)
block|{
comment|/* Move to white space. */
while|while
condition|(
operator|++
name|rl_point
operator|<
name|rl_end
operator|&&
name|whitespace
argument_list|(
name|the_line
index|[
name|rl_point
index|]
argument_list|)
condition|)
empty_stmt|;
if|if
condition|(
name|rl_point
operator|&&
name|rl_point
operator|<
name|rl_end
condition|)
block|{
comment|/* Skip whitespace. */
while|while
condition|(
name|rl_point
operator|<
name|rl_end
operator|&&
name|whitespace
argument_list|(
name|the_line
index|[
name|rl_point
index|]
argument_list|)
condition|)
name|rl_point
operator|++
expr_stmt|;
comment|/* Skip until whitespace. */
while|while
condition|(
name|rl_point
operator|<
name|rl_end
operator|&&
operator|!
name|whitespace
argument_list|(
name|the_line
index|[
name|rl_point
index|]
argument_list|)
condition|)
name|rl_point
operator|++
expr_stmt|;
comment|/* Move back to the last character of the word. */
name|rl_point
operator|--
expr_stmt|;
block|}
block|}
block|}
end_block

begin_macro
name|rl_vi_fword
argument_list|(
argument|count
argument_list|)
end_macro

begin_decl_stmt
name|int
name|count
decl_stmt|;
end_decl_stmt

begin_block
block|{
while|while
condition|(
name|count
operator|--
operator|&&
name|rl_point
operator|<
operator|(
name|rl_end
operator|-
literal|1
operator|)
condition|)
block|{
comment|/* Move to white space (really non-identifer). */
if|if
condition|(
name|isident
argument_list|(
name|the_line
index|[
name|rl_point
index|]
argument_list|)
condition|)
block|{
while|while
condition|(
name|isident
argument_list|(
name|the_line
index|[
name|rl_point
index|]
argument_list|)
operator|&&
name|rl_point
operator|<
name|rl_end
condition|)
name|rl_point
operator|++
expr_stmt|;
block|}
else|else
comment|/* if (!whitespace (the_line[rl_point])) */
block|{
while|while
condition|(
operator|!
name|isident
argument_list|(
name|the_line
index|[
name|rl_point
index|]
argument_list|)
operator|&&
operator|!
name|whitespace
argument_list|(
name|the_line
index|[
name|rl_point
index|]
argument_list|)
operator|&&
name|rl_point
operator|<
name|rl_end
condition|)
name|rl_point
operator|++
expr_stmt|;
block|}
comment|/* Move past whitespace. */
while|while
condition|(
name|whitespace
argument_list|(
name|the_line
index|[
name|rl_point
index|]
argument_list|)
operator|&&
name|rl_point
operator|<
name|rl_end
condition|)
name|rl_point
operator|++
expr_stmt|;
block|}
block|}
end_block

begin_macro
name|rl_vi_bword
argument_list|(
argument|count
argument_list|)
end_macro

begin_decl_stmt
name|int
name|count
decl_stmt|;
end_decl_stmt

begin_block
block|{
while|while
condition|(
name|count
operator|--
operator|&&
name|rl_point
operator|>
literal|0
condition|)
block|{
name|int
name|last_is_ident
decl_stmt|;
comment|/* If we are at the start of a word, move back to a non-identifier          so we will go back to the start of the previous word. */
if|if
condition|(
name|isident
argument_list|(
name|the_line
index|[
name|rl_point
index|]
argument_list|)
operator|&&
operator|!
name|isident
argument_list|(
name|the_line
index|[
name|rl_point
operator|-
literal|1
index|]
argument_list|)
condition|)
name|rl_point
operator|--
expr_stmt|;
comment|/* If this character and the previous character are `opposite', move          back so we don't get messed up by the rl_point++ down there in          the while loop.  Without this code, words like `l;' screw up the          function. */
name|last_is_ident
operator|=
name|isident
argument_list|(
name|the_line
index|[
name|rl_point
operator|-
literal|1
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|isident
argument_list|(
name|the_line
index|[
name|rl_point
index|]
argument_list|)
operator|&&
operator|!
name|last_is_ident
operator|)
operator|||
operator|(
operator|!
name|isident
argument_list|(
name|the_line
index|[
name|rl_point
index|]
argument_list|)
operator|&&
name|last_is_ident
operator|)
condition|)
name|rl_point
operator|--
expr_stmt|;
while|while
condition|(
name|rl_point
operator|>
literal|0
operator|&&
name|whitespace
argument_list|(
name|the_line
index|[
name|rl_point
index|]
argument_list|)
condition|)
name|rl_point
operator|--
expr_stmt|;
if|if
condition|(
name|rl_point
operator|>
literal|0
condition|)
block|{
if|if
condition|(
name|isident
argument_list|(
name|the_line
index|[
name|rl_point
index|]
argument_list|)
condition|)
while|while
condition|(
operator|--
name|rl_point
operator|>=
literal|0
operator|&&
name|isident
argument_list|(
name|the_line
index|[
name|rl_point
index|]
argument_list|)
condition|)
empty_stmt|;
else|else
while|while
condition|(
operator|--
name|rl_point
operator|>=
literal|0
operator|&&
operator|!
name|isident
argument_list|(
name|the_line
index|[
name|rl_point
index|]
argument_list|)
operator|&&
operator|!
name|whitespace
argument_list|(
name|the_line
index|[
name|rl_point
index|]
argument_list|)
condition|)
empty_stmt|;
name|rl_point
operator|++
expr_stmt|;
block|}
block|}
block|}
end_block

begin_macro
name|rl_vi_eword
argument_list|(
argument|count
argument_list|)
end_macro

begin_decl_stmt
name|int
name|count
decl_stmt|;
end_decl_stmt

begin_block
block|{
while|while
condition|(
name|count
operator|--
operator|&&
name|rl_point
operator|<
name|rl_end
operator|-
literal|1
condition|)
block|{
while|while
condition|(
operator|++
name|rl_point
operator|<
name|rl_end
operator|&&
name|whitespace
argument_list|(
name|the_line
index|[
name|rl_point
index|]
argument_list|)
condition|)
empty_stmt|;
if|if
condition|(
name|rl_point
operator|<
name|rl_end
condition|)
block|{
if|if
condition|(
name|isident
argument_list|(
name|the_line
index|[
name|rl_point
index|]
argument_list|)
condition|)
while|while
condition|(
operator|++
name|rl_point
operator|<
name|rl_end
operator|&&
name|isident
argument_list|(
name|the_line
index|[
name|rl_point
index|]
argument_list|)
condition|)
empty_stmt|;
else|else
while|while
condition|(
operator|++
name|rl_point
operator|<
name|rl_end
operator|&&
operator|!
name|isident
argument_list|(
name|the_line
index|[
name|rl_point
index|]
argument_list|)
operator|&&
operator|!
name|whitespace
argument_list|(
name|the_line
index|[
name|rl_point
index|]
argument_list|)
condition|)
empty_stmt|;
name|rl_point
operator|--
expr_stmt|;
block|}
block|}
block|}
end_block

begin_macro
name|rl_vi_insert_beg
argument_list|()
end_macro

begin_block
block|{
name|rl_beg_of_line
argument_list|()
expr_stmt|;
name|rl_vi_insertion_mode
argument_list|()
expr_stmt|;
return|return
literal|0
return|;
block|}
end_block

begin_macro
name|rl_vi_append_mode
argument_list|()
end_macro

begin_block
block|{
if|if
condition|(
name|rl_point
operator|<
name|rl_end
condition|)
name|rl_point
operator|+=
literal|1
expr_stmt|;
name|rl_vi_insertion_mode
argument_list|()
expr_stmt|;
return|return
literal|0
return|;
block|}
end_block

begin_macro
name|rl_vi_append_eol
argument_list|()
end_macro

begin_block
block|{
name|rl_end_of_line
argument_list|()
expr_stmt|;
name|rl_vi_append_mode
argument_list|()
expr_stmt|;
return|return
literal|0
return|;
block|}
end_block

begin_comment
comment|/* What to do in the case of C-d. */
end_comment

begin_macro
name|rl_vi_eof_maybe
argument_list|(
argument|count
argument_list|,
argument|c
argument_list|)
end_macro

begin_decl_stmt
name|int
name|count
decl_stmt|,
name|c
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|rl_newline
argument_list|(
literal|1
argument_list|,
literal|'\n'
argument_list|)
expr_stmt|;
block|}
end_block

begin_comment
comment|/* Insertion mode stuff. */
end_comment

begin_comment
comment|/* Switching from one mode to the other really just involves    switching keymaps. */
end_comment

begin_macro
name|rl_vi_insertion_mode
argument_list|()
end_macro

begin_block
block|{
name|keymap
operator|=
name|vi_insertion_keymap
expr_stmt|;
block|}
end_block

begin_macro
name|rl_vi_movement_mode
argument_list|()
end_macro

begin_block
block|{
if|if
condition|(
name|rl_point
operator|>
literal|0
condition|)
name|rl_backward
argument_list|(
literal|1
argument_list|)
expr_stmt|;
name|keymap
operator|=
name|vi_movement_keymap
expr_stmt|;
name|vi_done_inserting
argument_list|()
expr_stmt|;
block|}
end_block

begin_macro
name|vi_done_inserting
argument_list|()
end_macro

begin_block
block|{
if|if
condition|(
name|vi_doing_insert
condition|)
block|{
name|rl_end_undo_group
argument_list|()
expr_stmt|;
name|vi_doing_insert
operator|=
literal|0
expr_stmt|;
block|}
block|}
end_block

begin_macro
name|rl_vi_arg_digit
argument_list|(
argument|count
argument_list|,
argument|c
argument_list|)
end_macro

begin_decl_stmt
name|int
name|count
decl_stmt|,
name|c
decl_stmt|;
end_decl_stmt

begin_block
block|{
if|if
condition|(
name|c
operator|==
literal|'0'
operator|&&
name|rl_numeric_arg
operator|==
literal|1
operator|&&
operator|!
name|rl_explicit_arg
condition|)
name|rl_beg_of_line
argument_list|()
expr_stmt|;
else|else
name|rl_digit_argument
argument_list|(
name|count
argument_list|,
name|c
argument_list|)
expr_stmt|;
block|}
end_block

begin_comment
comment|/* Doesn't take an arg count in vi */
end_comment

begin_macro
name|rl_vi_change_case
argument_list|(
argument|ignore1
argument_list|,
argument|ignore2
argument_list|)
end_macro

begin_decl_stmt
name|int
name|ignore1
decl_stmt|,
name|ignore2
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|char
name|c
init|=
literal|0
decl_stmt|;
comment|/* Don't try this on an empty line. */
if|if
condition|(
name|rl_point
operator|>=
name|rl_end
operator|-
literal|1
condition|)
return|return;
if|if
condition|(
name|uppercase_p
argument_list|(
name|the_line
index|[
name|rl_point
index|]
argument_list|)
condition|)
name|c
operator|=
name|to_lower
argument_list|(
name|the_line
index|[
name|rl_point
index|]
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|lowercase_p
argument_list|(
name|the_line
index|[
name|rl_point
index|]
argument_list|)
condition|)
name|c
operator|=
name|to_upper
argument_list|(
name|the_line
index|[
name|rl_point
index|]
argument_list|)
expr_stmt|;
comment|/* Vi is kind of strange here. */
if|if
condition|(
name|c
condition|)
block|{
name|rl_begin_undo_group
argument_list|()
expr_stmt|;
name|rl_delete
argument_list|(
literal|1
argument_list|,
name|c
argument_list|)
expr_stmt|;
name|rl_insert
argument_list|(
literal|1
argument_list|,
name|c
argument_list|)
expr_stmt|;
name|rl_end_undo_group
argument_list|()
expr_stmt|;
name|rl_vi_check
argument_list|()
expr_stmt|;
block|}
else|else
name|rl_forward
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
end_block

begin_macro
name|rl_vi_put
argument_list|(
argument|count
argument_list|,
argument|key
argument_list|)
end_macro

begin_decl_stmt
name|int
name|count
decl_stmt|,
name|key
decl_stmt|;
end_decl_stmt

begin_block
block|{
if|if
condition|(
operator|!
name|uppercase_p
argument_list|(
name|key
argument_list|)
operator|&&
operator|(
name|rl_point
operator|+
literal|1
operator|<=
name|rl_end
operator|)
condition|)
name|rl_forward
argument_list|(
literal|1
argument_list|)
expr_stmt|;
name|rl_yank
argument_list|()
expr_stmt|;
name|rl_backward
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
end_block

begin_macro
name|rl_vi_check
argument_list|()
end_macro

begin_block
block|{
if|if
condition|(
name|rl_point
operator|&&
name|rl_point
operator|==
name|rl_end
condition|)
name|rl_point
operator|--
expr_stmt|;
block|}
end_block

begin_macro
name|rl_vi_column
argument_list|(
argument|count
argument_list|)
end_macro

begin_block
block|{
if|if
condition|(
name|count
operator|>
name|rl_end
condition|)
name|rl_end_of_line
argument_list|()
expr_stmt|;
else|else
name|rl_point
operator|=
name|count
operator|-
literal|1
expr_stmt|;
block|}
end_block

begin_function
name|int
name|rl_vi_domove
parameter_list|(
name|key
parameter_list|,
name|nextkey
parameter_list|)
name|int
name|key
decl_stmt|,
decl|*
name|nextkey
decl_stmt|;
end_function

begin_block
block|{
name|int
name|c
decl_stmt|,
name|save
decl_stmt|;
name|rl_mark
operator|=
name|rl_point
expr_stmt|;
name|c
operator|=
name|rl_read_key
argument_list|()
expr_stmt|;
operator|*
name|nextkey
operator|=
name|c
expr_stmt|;
if|if
condition|(
operator|!
name|member
argument_list|(
name|c
argument_list|,
name|vi_motion
argument_list|)
condition|)
block|{
if|if
condition|(
name|digit
argument_list|(
name|c
argument_list|)
condition|)
block|{
name|save
operator|=
name|rl_numeric_arg
expr_stmt|;
name|rl_digit_loop1
argument_list|()
expr_stmt|;
name|rl_numeric_arg
operator|*=
name|save
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|(
name|key
operator|==
literal|'d'
operator|&&
name|c
operator|==
literal|'d'
operator|)
operator|||
operator|(
name|key
operator|==
literal|'c'
operator|&&
name|c
operator|==
literal|'c'
operator|)
condition|)
block|{
name|rl_mark
operator|=
name|rl_end
expr_stmt|;
name|rl_beg_of_line
argument_list|()
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
else|else
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
name|rl_dispatch
argument_list|(
name|c
argument_list|,
name|keymap
argument_list|)
expr_stmt|;
comment|/* No change in position means the command failed. */
if|if
condition|(
name|rl_mark
operator|==
name|rl_point
condition|)
return|return
operator|(
operator|-
literal|1
operator|)
return|;
if|if
condition|(
operator|(
name|c
operator|==
literal|'w'
operator|||
name|c
operator|==
literal|'W'
operator|)
operator|&&
name|rl_point
operator|<
name|rl_end
condition|)
name|rl_point
operator|--
expr_stmt|;
if|if
condition|(
name|rl_mark
operator|<
name|rl_point
condition|)
name|exchange
argument_list|(
name|rl_point
argument_list|,
name|rl_mark
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_block

begin_comment
comment|/* A simplified loop for vi. Don't dispatch key at end.    Don't recognize minus sign? */
end_comment

begin_macro
name|rl_digit_loop1
argument_list|()
end_macro

begin_block
block|{
name|int
name|key
decl_stmt|,
name|c
decl_stmt|;
while|while
condition|(
literal|1
condition|)
block|{
name|rl_message
argument_list|(
literal|"(arg: %d) "
argument_list|,
name|arg_sign
operator|*
name|rl_numeric_arg
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|key
operator|=
name|c
operator|=
name|rl_read_key
argument_list|()
expr_stmt|;
if|if
condition|(
name|keymap
index|[
name|c
index|]
operator|.
name|type
operator|==
name|ISFUNC
operator|&&
name|keymap
index|[
name|c
index|]
operator|.
name|function
operator|==
name|rl_universal_argument
condition|)
block|{
name|rl_numeric_arg
operator|*=
literal|4
expr_stmt|;
continue|continue;
block|}
name|c
operator|=
name|UNMETA
argument_list|(
name|c
argument_list|)
expr_stmt|;
if|if
condition|(
name|numeric
argument_list|(
name|c
argument_list|)
condition|)
block|{
if|if
condition|(
name|rl_explicit_arg
condition|)
name|rl_numeric_arg
operator|=
operator|(
name|rl_numeric_arg
operator|*
literal|10
operator|)
operator|+
operator|(
name|c
operator|-
literal|'0'
operator|)
expr_stmt|;
else|else
name|rl_numeric_arg
operator|=
operator|(
name|c
operator|-
literal|'0'
operator|)
expr_stmt|;
name|rl_explicit_arg
operator|=
literal|1
expr_stmt|;
block|}
else|else
block|{
name|rl_clear_message
argument_list|()
expr_stmt|;
name|rl_stuff_char
argument_list|(
name|key
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
block|}
end_block

begin_macro
name|rl_vi_delete_to
argument_list|(
argument|count
argument_list|,
argument|key
argument_list|)
end_macro

begin_decl_stmt
name|int
name|count
decl_stmt|,
name|key
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|int
name|c
decl_stmt|;
if|if
condition|(
name|uppercase_p
argument_list|(
name|key
argument_list|)
condition|)
name|rl_stuff_char
argument_list|(
literal|'$'
argument_list|)
expr_stmt|;
if|if
condition|(
name|rl_vi_domove
argument_list|(
name|key
argument_list|,
operator|&
name|c
argument_list|)
condition|)
block|{
name|ding
argument_list|()
expr_stmt|;
return|return;
block|}
if|if
condition|(
operator|(
name|c
operator|!=
literal|'|'
operator|)
operator|&&
operator|(
name|c
operator|!=
literal|'h'
operator|)
operator|&&
name|rl_mark
operator|<
name|rl_end
condition|)
name|rl_mark
operator|++
expr_stmt|;
name|rl_kill_text
argument_list|(
name|rl_point
argument_list|,
name|rl_mark
argument_list|)
expr_stmt|;
block|}
end_block

begin_macro
name|rl_vi_change_to
argument_list|(
argument|count
argument_list|,
argument|key
argument_list|)
end_macro

begin_decl_stmt
name|int
name|count
decl_stmt|,
name|key
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|int
name|c
decl_stmt|;
if|if
condition|(
name|uppercase_p
argument_list|(
name|key
argument_list|)
condition|)
name|rl_stuff_char
argument_list|(
literal|'$'
argument_list|)
expr_stmt|;
if|if
condition|(
name|rl_vi_domove
argument_list|(
name|key
argument_list|,
operator|&
name|c
argument_list|)
condition|)
block|{
name|ding
argument_list|()
expr_stmt|;
return|return;
block|}
if|if
condition|(
operator|(
name|c
operator|!=
literal|'|'
operator|)
operator|&&
operator|(
name|c
operator|!=
literal|'h'
operator|)
operator|&&
name|rl_mark
operator|<
name|rl_end
condition|)
name|rl_mark
operator|++
expr_stmt|;
name|rl_begin_undo_group
argument_list|()
expr_stmt|;
name|vi_doing_insert
operator|=
literal|1
expr_stmt|;
name|rl_kill_text
argument_list|(
name|rl_point
argument_list|,
name|rl_mark
argument_list|)
expr_stmt|;
name|rl_vi_insertion_mode
argument_list|()
expr_stmt|;
block|}
end_block

begin_macro
name|rl_vi_yank_to
argument_list|(
argument|count
argument_list|,
argument|key
argument_list|)
end_macro

begin_decl_stmt
name|int
name|count
decl_stmt|,
name|key
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|int
name|c
decl_stmt|,
name|save
init|=
name|rl_point
decl_stmt|;
if|if
condition|(
name|uppercase_p
argument_list|(
name|key
argument_list|)
condition|)
name|rl_stuff_char
argument_list|(
literal|'$'
argument_list|)
expr_stmt|;
if|if
condition|(
name|rl_vi_domove
argument_list|(
name|key
argument_list|,
operator|&
name|c
argument_list|)
condition|)
block|{
name|ding
argument_list|()
expr_stmt|;
return|return;
block|}
name|rl_begin_undo_group
argument_list|()
expr_stmt|;
name|rl_kill_text
argument_list|(
name|rl_point
argument_list|,
name|rl_mark
argument_list|)
expr_stmt|;
name|rl_end_undo_group
argument_list|()
expr_stmt|;
name|rl_do_undo
argument_list|()
expr_stmt|;
name|rl_point
operator|=
name|save
expr_stmt|;
block|}
end_block

begin_macro
name|rl_vi_delete
argument_list|(
argument|count
argument_list|)
end_macro

begin_block
block|{
name|int
name|end
decl_stmt|;
if|if
condition|(
name|rl_end
operator|==
literal|0
condition|)
block|{
name|ding
argument_list|()
expr_stmt|;
return|return;
block|}
name|end
operator|=
name|rl_point
operator|+
name|count
expr_stmt|;
if|if
condition|(
name|end
operator|>=
name|rl_end
condition|)
name|end
operator|=
name|rl_end
expr_stmt|;
name|rl_kill_text
argument_list|(
name|rl_point
argument_list|,
name|end
argument_list|)
expr_stmt|;
if|if
condition|(
name|rl_point
operator|>
literal|0
operator|&&
name|rl_point
operator|==
name|rl_end
condition|)
name|rl_backward
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
end_block

begin_comment
comment|/* Turn the current line into a comment in shell history.    A K*rn shell style function. */
end_comment

begin_macro
name|rl_vi_comment
argument_list|()
end_macro

begin_block
block|{
name|rl_beg_of_line
argument_list|()
expr_stmt|;
name|rl_insert_text
argument_list|(
literal|": "
argument_list|)
expr_stmt|;
comment|/* `#' doesn't work in interactive mode */
name|rl_redisplay
argument_list|()
expr_stmt|;
name|rl_newline
argument_list|(
literal|1
argument_list|,
literal|'\010'
argument_list|)
expr_stmt|;
block|}
end_block

begin_macro
name|rl_vi_first_print
argument_list|()
end_macro

begin_block
block|{
name|rl_back_to_indent
argument_list|()
expr_stmt|;
block|}
end_block

begin_macro
name|rl_back_to_indent
argument_list|(
argument|ignore1
argument_list|,
argument|ignore2
argument_list|)
end_macro

begin_decl_stmt
name|int
name|ignore1
decl_stmt|,
name|ignore2
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|rl_beg_of_line
argument_list|()
expr_stmt|;
while|while
condition|(
name|rl_point
operator|<
name|rl_end
operator|&&
name|whitespace
argument_list|(
name|the_line
index|[
name|rl_point
index|]
argument_list|)
condition|)
name|rl_point
operator|++
expr_stmt|;
block|}
end_block

begin_comment
comment|/* NOTE: it is necessary that opposite directions are inverses */
end_comment

begin_define
define|#
directive|define
name|FTO
value|1
end_define

begin_comment
comment|/* forward to */
end_comment

begin_define
define|#
directive|define
name|BTO
value|-1
end_define

begin_comment
comment|/* backward to */
end_comment

begin_define
define|#
directive|define
name|FFIND
value|2
end_define

begin_comment
comment|/* forward find */
end_comment

begin_define
define|#
directive|define
name|BFIND
value|-2
end_define

begin_comment
comment|/* backward find */
end_comment

begin_macro
name|rl_vi_char_search
argument_list|(
argument|count
argument_list|,
argument|key
argument_list|)
end_macro

begin_decl_stmt
name|int
name|count
decl_stmt|,
name|key
decl_stmt|;
end_decl_stmt

begin_block
block|{
specifier|static
name|char
name|target
decl_stmt|;
specifier|static
name|int
name|orig_dir
decl_stmt|,
name|dir
decl_stmt|;
name|int
name|pos
decl_stmt|;
if|if
condition|(
name|key
operator|==
literal|';'
operator|||
name|key
operator|==
literal|','
condition|)
name|dir
operator|=
operator|(
name|key
operator|==
literal|';'
condition|?
name|orig_dir
else|:
operator|-
name|orig_dir
operator|)
expr_stmt|;
else|else
block|{
name|target
operator|=
name|rl_getc
argument_list|(
name|in_stream
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|key
condition|)
block|{
case|case
literal|'t'
case|:
name|orig_dir
operator|=
name|dir
operator|=
name|FTO
expr_stmt|;
break|break;
case|case
literal|'T'
case|:
name|orig_dir
operator|=
name|dir
operator|=
name|BTO
expr_stmt|;
break|break;
case|case
literal|'f'
case|:
name|orig_dir
operator|=
name|dir
operator|=
name|FFIND
expr_stmt|;
break|break;
case|case
literal|'F'
case|:
name|orig_dir
operator|=
name|dir
operator|=
name|BFIND
expr_stmt|;
break|break;
block|}
block|}
name|pos
operator|=
name|rl_point
expr_stmt|;
if|if
condition|(
name|dir
operator|<
literal|0
condition|)
block|{
name|pos
operator|--
expr_stmt|;
do|do
block|{
if|if
condition|(
name|the_line
index|[
name|pos
index|]
operator|==
name|target
condition|)
block|{
if|if
condition|(
name|dir
operator|==
name|BTO
condition|)
name|rl_point
operator|=
name|pos
operator|+
literal|1
expr_stmt|;
else|else
name|rl_point
operator|=
name|pos
expr_stmt|;
return|return;
block|}
block|}
do|while
condition|(
name|pos
operator|--
condition|)
do|;
if|if
condition|(
name|pos
operator|<
literal|0
condition|)
block|{
name|ding
argument_list|()
expr_stmt|;
return|return;
block|}
block|}
else|else
block|{
comment|/* dir> 0 */
name|pos
operator|++
expr_stmt|;
do|do
block|{
if|if
condition|(
name|the_line
index|[
name|pos
index|]
operator|==
name|target
condition|)
block|{
if|if
condition|(
name|dir
operator|==
name|FTO
condition|)
name|rl_point
operator|=
name|pos
operator|-
literal|1
expr_stmt|;
else|else
name|rl_point
operator|=
name|pos
expr_stmt|;
return|return;
block|}
block|}
do|while
condition|(
operator|++
name|pos
operator|<
name|rl_end
condition|)
do|;
if|if
condition|(
name|pos
operator|>=
operator|(
name|rl_end
operator|-
literal|1
operator|)
condition|)
name|ding
argument_list|()
expr_stmt|;
block|}
block|}
end_block

begin_comment
comment|/* Match brackets */
end_comment

begin_macro
name|rl_vi_match
argument_list|()
end_macro

begin_block
block|{
name|int
name|count
init|=
literal|1
decl_stmt|,
name|brack
decl_stmt|,
name|pos
decl_stmt|;
name|pos
operator|=
name|rl_point
expr_stmt|;
if|if
condition|(
operator|(
name|brack
operator|=
name|rl_vi_bracktype
argument_list|(
name|the_line
index|[
name|rl_point
index|]
argument_list|)
operator|)
operator|==
literal|0
condition|)
block|{
while|while
condition|(
operator|(
name|brack
operator|=
name|rl_vi_bracktype
argument_list|(
name|the_line
index|[
name|rl_point
index|]
argument_list|)
operator|)
operator|==
literal|0
operator|&&
name|rl_point
operator|<
name|rl_end
operator|-
literal|1
condition|)
name|rl_forward
argument_list|(
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|brack
operator|<=
literal|0
condition|)
block|{
name|rl_point
operator|=
name|pos
expr_stmt|;
name|ding
argument_list|()
expr_stmt|;
return|return;
block|}
block|}
name|pos
operator|=
name|rl_point
expr_stmt|;
if|if
condition|(
name|brack
operator|<
literal|0
condition|)
block|{
while|while
condition|(
name|count
condition|)
block|{
if|if
condition|(
operator|--
name|pos
operator|>=
literal|0
condition|)
block|{
name|int
name|b
init|=
name|rl_vi_bracktype
argument_list|(
name|the_line
index|[
name|pos
index|]
argument_list|)
decl_stmt|;
if|if
condition|(
name|b
operator|==
operator|-
name|brack
condition|)
name|count
operator|--
expr_stmt|;
elseif|else
if|if
condition|(
name|b
operator|==
name|brack
condition|)
name|count
operator|++
expr_stmt|;
block|}
else|else
block|{
name|ding
argument_list|()
expr_stmt|;
return|return;
block|}
block|}
block|}
else|else
block|{
comment|/* brack> 0 */
while|while
condition|(
name|count
condition|)
block|{
if|if
condition|(
operator|++
name|pos
operator|<
name|rl_end
condition|)
block|{
name|int
name|b
init|=
name|rl_vi_bracktype
argument_list|(
name|the_line
index|[
name|pos
index|]
argument_list|)
decl_stmt|;
if|if
condition|(
name|b
operator|==
operator|-
name|brack
condition|)
name|count
operator|--
expr_stmt|;
elseif|else
if|if
condition|(
name|b
operator|==
name|brack
condition|)
name|count
operator|++
expr_stmt|;
block|}
else|else
block|{
name|ding
argument_list|()
expr_stmt|;
return|return;
block|}
block|}
block|}
name|rl_point
operator|=
name|pos
expr_stmt|;
block|}
end_block

begin_function
name|int
name|rl_vi_bracktype
parameter_list|(
name|c
parameter_list|)
name|int
name|c
decl_stmt|;
block|{
switch|switch
condition|(
name|c
condition|)
block|{
case|case
literal|'('
case|:
return|return
literal|1
return|;
case|case
literal|')'
case|:
return|return
operator|-
literal|1
return|;
case|case
literal|'['
case|:
return|return
literal|2
return|;
case|case
literal|']'
case|:
return|return
operator|-
literal|2
return|;
case|case
literal|'{'
case|:
return|return
literal|3
return|;
case|case
literal|'}'
case|:
return|return
operator|-
literal|3
return|;
default|default:
return|return
literal|0
return|;
block|}
block|}
end_function

begin_macro
name|rl_vi_change_char
argument_list|()
end_macro

begin_block
block|{
name|int
name|c
decl_stmt|;
name|c
operator|=
name|rl_getc
argument_list|(
name|in_stream
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|c
condition|)
block|{
case|case
literal|'\033'
case|:
case|case
name|CTRL
argument_list|(
literal|'C'
argument_list|)
case|:
return|return;
default|default:
name|rl_begin_undo_group
argument_list|()
expr_stmt|;
name|rl_delete
argument_list|(
literal|1
argument_list|,
name|c
argument_list|)
expr_stmt|;
name|rl_insert
argument_list|(
literal|1
argument_list|,
name|c
argument_list|)
expr_stmt|;
name|rl_end_undo_group
argument_list|()
expr_stmt|;
break|break;
block|}
block|}
end_block

begin_macro
name|rl_vi_subst
argument_list|(
argument|count
argument_list|,
argument|key
argument_list|)
end_macro

begin_decl_stmt
name|int
name|count
decl_stmt|,
name|key
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|rl_begin_undo_group
argument_list|()
expr_stmt|;
name|vi_doing_insert
operator|=
literal|1
expr_stmt|;
if|if
condition|(
name|uppercase_p
argument_list|(
name|key
argument_list|)
condition|)
block|{
name|rl_beg_of_line
argument_list|()
expr_stmt|;
name|rl_kill_line
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
else|else
name|rl_delete
argument_list|(
name|count
argument_list|,
name|key
argument_list|)
expr_stmt|;
name|rl_vi_insertion_mode
argument_list|()
expr_stmt|;
block|}
end_block

begin_macro
name|rl_vi_overstrike
argument_list|(
argument|count
argument_list|,
argument|key
argument_list|)
end_macro

begin_decl_stmt
name|int
name|count
decl_stmt|,
name|key
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|int
name|i
decl_stmt|;
if|if
condition|(
name|vi_doing_insert
operator|==
literal|0
condition|)
block|{
name|vi_doing_insert
operator|=
literal|1
expr_stmt|;
name|rl_begin_undo_group
argument_list|()
expr_stmt|;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|count
condition|;
name|i
operator|++
control|)
block|{
name|vi_replace_count
operator|++
expr_stmt|;
name|rl_begin_undo_group
argument_list|()
expr_stmt|;
if|if
condition|(
name|rl_point
operator|<
name|rl_end
condition|)
block|{
name|rl_delete
argument_list|(
literal|1
argument_list|,
name|key
argument_list|)
expr_stmt|;
name|rl_insert
argument_list|(
literal|1
argument_list|,
name|key
argument_list|)
expr_stmt|;
block|}
else|else
name|rl_insert
argument_list|(
literal|1
argument_list|,
name|key
argument_list|)
expr_stmt|;
name|rl_end_undo_group
argument_list|()
expr_stmt|;
block|}
block|}
end_block

begin_macro
name|rl_vi_overstrike_delete
argument_list|(
argument|count
argument_list|)
end_macro

begin_decl_stmt
name|int
name|count
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|int
name|i
decl_stmt|,
name|s
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|count
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|vi_replace_count
operator|==
literal|0
condition|)
block|{
name|ding
argument_list|()
expr_stmt|;
break|break;
block|}
name|s
operator|=
name|rl_point
expr_stmt|;
if|if
condition|(
name|rl_do_undo
argument_list|()
condition|)
name|vi_replace_count
operator|--
expr_stmt|;
if|if
condition|(
name|rl_point
operator|==
name|s
condition|)
name|rl_backward
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|vi_replace_count
operator|==
literal|0
operator|&&
name|vi_doing_insert
condition|)
block|{
name|rl_end_undo_group
argument_list|()
expr_stmt|;
name|rl_do_undo
argument_list|()
expr_stmt|;
name|vi_doing_insert
operator|=
literal|0
expr_stmt|;
block|}
block|}
end_block

begin_macro
name|rl_vi_replace
argument_list|()
end_macro

begin_block
block|{
name|int
name|i
decl_stmt|;
name|vi_replace_count
operator|=
literal|0
expr_stmt|;
name|vi_replace_map
operator|=
name|rl_make_bare_keymap
argument_list|()
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|' '
init|;
name|i
operator|<
literal|127
condition|;
name|i
operator|++
control|)
name|vi_replace_map
index|[
name|i
index|]
operator|.
name|function
operator|=
name|rl_vi_overstrike
expr_stmt|;
name|vi_replace_map
index|[
name|RUBOUT
index|]
operator|.
name|function
operator|=
name|rl_vi_overstrike_delete
expr_stmt|;
name|vi_replace_map
index|[
name|ESC
index|]
operator|.
name|function
operator|=
name|rl_vi_movement_mode
expr_stmt|;
name|vi_replace_map
index|[
name|RETURN
index|]
operator|.
name|function
operator|=
name|rl_newline
expr_stmt|;
name|vi_replace_map
index|[
name|NEWLINE
index|]
operator|.
name|function
operator|=
name|rl_newline
expr_stmt|;
name|keymap
operator|=
name|vi_replace_map
expr_stmt|;
block|}
end_block

begin_comment
comment|/*  * Try to complete the word we are standing on or the word that ends with  * the previous character. A space matches everything.  * Word delimiters are space and ;.  */
end_comment

begin_macro
name|rl_vi_possible_completions
argument_list|()
end_macro

begin_block
block|{
name|int
name|save_pos
init|=
name|rl_point
decl_stmt|;
if|if
condition|(
operator|!
name|index
argument_list|(
literal|" ;"
argument_list|,
name|the_line
index|[
name|rl_point
index|]
argument_list|)
condition|)
block|{
while|while
condition|(
operator|!
name|index
argument_list|(
literal|" ;"
argument_list|,
name|the_line
index|[
operator|++
name|rl_point
index|]
argument_list|)
condition|)
empty_stmt|;
block|}
elseif|else
if|if
condition|(
name|the_line
index|[
name|rl_point
operator|-
literal|1
index|]
operator|==
literal|';'
condition|)
block|{
name|ding
argument_list|()
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
name|rl_possible_completions
argument_list|()
expr_stmt|;
name|rl_point
operator|=
name|save_pos
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_block

end_unit


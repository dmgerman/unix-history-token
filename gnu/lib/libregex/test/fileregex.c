begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_include
include|#
directive|include
file|<sys/types.h>
end_include

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_include
include|#
directive|include
file|"regex.h"
end_include

begin_define
define|#
directive|define
name|BYTEWIDTH
value|8
end_define

begin_comment
comment|/* Sorry, but this is just a test program.  */
end_comment

begin_define
define|#
directive|define
name|LINE_MAX
value|500
end_define

begin_function
name|int
name|main
parameter_list|(
name|argc
parameter_list|,
name|argv
parameter_list|)
name|int
name|argc
decl_stmt|;
name|char
modifier|*
name|argv
index|[]
decl_stmt|;
block|{
name|FILE
modifier|*
name|f
decl_stmt|;
name|char
modifier|*
name|filename
decl_stmt|;
name|char
name|pat
index|[
literal|500
index|]
decl_stmt|;
comment|/* Sorry for that maximum size, too.  */
name|char
name|line
index|[
name|LINE_MAX
index|]
decl_stmt|;
name|struct
name|re_pattern_buffer
name|buf
decl_stmt|;
name|char
name|fastmap
index|[
operator|(
literal|1
operator|<<
name|BYTEWIDTH
operator|)
index|]
decl_stmt|;
specifier|const
name|char
modifier|*
name|compile_ret
decl_stmt|;
name|unsigned
name|lineno
init|=
literal|1
decl_stmt|;
name|unsigned
name|nfound
init|=
literal|0
decl_stmt|;
comment|/* Actually, it might be useful to allow the data file to be standard      input, and to specify the pattern on the command line.  */
if|if
condition|(
name|argc
operator|!=
literal|2
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Usage: %s<filename>.\n"
argument_list|,
name|argv
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
name|filename
operator|=
name|argv
index|[
literal|1
index|]
expr_stmt|;
name|f
operator|=
name|fopen
argument_list|(
name|filename
argument_list|,
literal|"r"
argument_list|)
expr_stmt|;
if|if
condition|(
name|f
operator|==
name|NULL
condition|)
name|perror
argument_list|(
name|filename
argument_list|)
expr_stmt|;
name|buf
operator|.
name|allocated
operator|=
literal|0
expr_stmt|;
name|buf
operator|.
name|buffer
operator|=
name|NULL
expr_stmt|;
name|buf
operator|.
name|fastmap
operator|=
name|fastmap
expr_stmt|;
name|printf
argument_list|(
literal|"Pattern = "
argument_list|,
name|pat
argument_list|)
expr_stmt|;
name|gets
argument_list|(
name|pat
argument_list|)
expr_stmt|;
if|if
condition|(
name|feof
argument_list|(
name|stdin
argument_list|)
condition|)
block|{
name|putchar
argument_list|(
literal|'\n'
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|0
argument_list|)
expr_stmt|;
block|}
name|compile_ret
operator|=
name|re_compile_pattern
argument_list|(
name|pat
argument_list|,
name|strlen
argument_list|(
name|pat
argument_list|)
argument_list|,
operator|&
name|buf
argument_list|)
expr_stmt|;
if|if
condition|(
name|compile_ret
operator|!=
name|NULL
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"%s: %s\n"
argument_list|,
name|pat
argument_list|,
name|compile_ret
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
while|while
condition|(
name|fgets
argument_list|(
name|line
argument_list|,
name|LINE_MAX
argument_list|,
name|f
argument_list|)
operator|!=
name|NULL
condition|)
block|{
name|size_t
name|len
init|=
name|strlen
argument_list|(
name|line
argument_list|)
decl_stmt|;
name|struct
name|re_registers
name|regs
decl_stmt|;
name|int
name|search_ret
init|=
name|re_search_2
argument_list|(
operator|&
name|buf
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|,
name|line
argument_list|,
name|len
argument_list|,
literal|0
argument_list|,
name|len
argument_list|,
operator|&
name|regs
argument_list|,
name|len
argument_list|)
decl_stmt|;
if|if
condition|(
name|search_ret
operator|==
operator|-
literal|2
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"%s:%d: re_search failed.\n"
argument_list|,
name|filename
argument_list|,
name|lineno
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
name|nfound
operator|+=
name|search_ret
operator|!=
operator|-
literal|1
expr_stmt|;
name|lineno
operator|++
expr_stmt|;
block|}
name|printf
argument_list|(
literal|"Matches found: %u (out of %u lines).\n"
argument_list|,
name|nfound
argument_list|,
name|lineno
operator|-
literal|1
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

end_unit


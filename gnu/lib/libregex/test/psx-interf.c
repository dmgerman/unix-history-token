begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/* psx-interf.c: test POSIX interface.  */
end_comment

begin_include
include|#
directive|include
file|<string.h>
end_include

begin_include
include|#
directive|include
file|<assert.h>
end_include

begin_include
include|#
directive|include
file|"test.h"
end_include

begin_define
define|#
directive|define
name|ERROR_CODE_LENGTH
value|20
end_define

begin_define
define|#
directive|define
name|TEST_ERRBUF_SIZE
value|15
end_define

begin_function_decl
name|void
name|test_compile
parameter_list|()
function_decl|;
end_function_decl

begin_comment
comment|/* ANSWER should be at least ERROR_CODE_LENGTH long.  */
end_comment

begin_function
specifier|static
name|char
modifier|*
name|get_error_string
parameter_list|(
name|error_code
parameter_list|,
name|answer
parameter_list|)
name|int
name|error_code
decl_stmt|;
name|char
name|answer
index|[]
decl_stmt|;
block|{
switch|switch
condition|(
name|error_code
condition|)
block|{
case|case
literal|0
case|:
name|strcpy
argument_list|(
name|answer
argument_list|,
literal|"No error"
argument_list|)
expr_stmt|;
break|break;
case|case
name|REG_NOMATCH
case|:
name|strcpy
argument_list|(
name|answer
argument_list|,
literal|"REG_NOMATCH"
argument_list|)
expr_stmt|;
break|break;
case|case
name|REG_BADPAT
case|:
name|strcpy
argument_list|(
name|answer
argument_list|,
literal|"REG_BADPAT"
argument_list|)
expr_stmt|;
break|break;
case|case
name|REG_EPAREN
case|:
name|strcpy
argument_list|(
name|answer
argument_list|,
literal|"REG_EPAREN"
argument_list|)
expr_stmt|;
break|break;
case|case
name|REG_ESPACE
case|:
name|strcpy
argument_list|(
name|answer
argument_list|,
literal|"REG_ESPACE"
argument_list|)
expr_stmt|;
break|break;
case|case
name|REG_ECOLLATE
case|:
name|strcpy
argument_list|(
name|answer
argument_list|,
literal|"REG_ECOLLATE"
argument_list|)
expr_stmt|;
break|break;
case|case
name|REG_ECTYPE
case|:
name|strcpy
argument_list|(
name|answer
argument_list|,
literal|"REG_ECTYPE"
argument_list|)
expr_stmt|;
break|break;
case|case
name|REG_EESCAPE
case|:
name|strcpy
argument_list|(
name|answer
argument_list|,
literal|"REG_EESCAPE"
argument_list|)
expr_stmt|;
break|break;
case|case
name|REG_ESUBREG
case|:
name|strcpy
argument_list|(
name|answer
argument_list|,
literal|"REG_ESUBREG"
argument_list|)
expr_stmt|;
break|break;
case|case
name|REG_EBRACK
case|:
name|strcpy
argument_list|(
name|answer
argument_list|,
literal|"REG_EBRACK"
argument_list|)
expr_stmt|;
break|break;
case|case
name|REG_EBRACE
case|:
name|strcpy
argument_list|(
name|answer
argument_list|,
literal|"REG_EBRACE"
argument_list|)
expr_stmt|;
break|break;
case|case
name|REG_BADBR
case|:
name|strcpy
argument_list|(
name|answer
argument_list|,
literal|"REG_BADBR"
argument_list|)
expr_stmt|;
break|break;
case|case
name|REG_ERANGE
case|:
name|strcpy
argument_list|(
name|answer
argument_list|,
literal|"REG_ERANGE"
argument_list|)
expr_stmt|;
break|break;
case|case
name|REG_BADRPT
case|:
name|strcpy
argument_list|(
name|answer
argument_list|,
literal|"REG_BADRPT"
argument_list|)
expr_stmt|;
break|break;
case|case
name|REG_EEND
case|:
name|strcpy
argument_list|(
name|answer
argument_list|,
literal|"REG_EEND"
argument_list|)
expr_stmt|;
break|break;
default|default:
name|strcpy
argument_list|(
name|answer
argument_list|,
literal|"Bad error code"
argument_list|)
expr_stmt|;
block|}
return|return
name|answer
return|;
block|}
end_function

begin_comment
comment|/* I don't think we actually need to initialize all these things.    --karl  */
end_comment

begin_function
name|void
name|init_pattern_buffer
parameter_list|(
name|pattern_buffer_ptr
parameter_list|)
name|regex_t
modifier|*
name|pattern_buffer_ptr
decl_stmt|;
block|{
name|pattern_buffer_ptr
operator|->
name|buffer
operator|=
name|NULL
expr_stmt|;
name|pattern_buffer_ptr
operator|->
name|allocated
operator|=
literal|0
expr_stmt|;
name|pattern_buffer_ptr
operator|->
name|used
operator|=
literal|0
expr_stmt|;
name|pattern_buffer_ptr
operator|->
name|fastmap
operator|=
name|NULL
expr_stmt|;
name|pattern_buffer_ptr
operator|->
name|fastmap_accurate
operator|=
literal|0
expr_stmt|;
name|pattern_buffer_ptr
operator|->
name|translate
operator|=
name|NULL
expr_stmt|;
name|pattern_buffer_ptr
operator|->
name|can_be_null
operator|=
literal|0
expr_stmt|;
name|pattern_buffer_ptr
operator|->
name|re_nsub
operator|=
literal|0
expr_stmt|;
name|pattern_buffer_ptr
operator|->
name|no_sub
operator|=
literal|0
expr_stmt|;
name|pattern_buffer_ptr
operator|->
name|not_bol
operator|=
literal|0
expr_stmt|;
name|pattern_buffer_ptr
operator|->
name|not_eol
operator|=
literal|0
expr_stmt|;
block|}
end_function

begin_function
name|void
name|test_compile
parameter_list|(
name|valid_pattern
parameter_list|,
name|error_code_expected
parameter_list|,
name|pattern
parameter_list|,
name|pattern_buffer_ptr
parameter_list|,
name|cflags
parameter_list|)
name|unsigned
name|valid_pattern
decl_stmt|;
name|int
name|error_code_expected
decl_stmt|;
specifier|const
name|char
modifier|*
name|pattern
decl_stmt|;
name|regex_t
modifier|*
name|pattern_buffer_ptr
decl_stmt|;
name|int
name|cflags
decl_stmt|;
block|{
name|int
name|error_code_returned
decl_stmt|;
name|boolean
name|error
init|=
name|false
decl_stmt|;
name|char
name|errbuf
index|[
name|TEST_ERRBUF_SIZE
index|]
decl_stmt|;
name|init_pattern_buffer
argument_list|(
name|pattern_buffer_ptr
argument_list|)
expr_stmt|;
name|error_code_returned
operator|=
name|regcomp
argument_list|(
name|pattern_buffer_ptr
argument_list|,
name|pattern
argument_list|,
name|cflags
argument_list|)
expr_stmt|;
if|if
condition|(
name|valid_pattern
operator|&&
name|error_code_returned
condition|)
block|{
name|printf
argument_list|(
literal|"\nShould have been a valid pattern but wasn't.\n"
argument_list|)
expr_stmt|;
name|regerror
argument_list|(
name|error_code_returned
argument_list|,
name|pattern_buffer_ptr
argument_list|,
name|errbuf
argument_list|,
name|TEST_ERRBUF_SIZE
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"%s"
argument_list|,
name|errbuf
argument_list|)
expr_stmt|;
name|error
operator|=
name|true
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|valid_pattern
operator|&&
operator|!
name|error_code_returned
condition|)
block|{
name|printf
argument_list|(
literal|"\n\nInvalid pattern compiled as valid:\n"
argument_list|)
expr_stmt|;
name|error
operator|=
name|true
expr_stmt|;
block|}
if|if
condition|(
name|error_code_returned
operator|!=
name|error_code_expected
condition|)
block|{
name|char
name|expected_error_string
index|[
name|ERROR_CODE_LENGTH
index|]
decl_stmt|;
name|char
name|returned_error_string
index|[
name|ERROR_CODE_LENGTH
index|]
decl_stmt|;
name|get_error_string
argument_list|(
name|error_code_expected
argument_list|,
name|expected_error_string
argument_list|)
operator|,
name|get_error_string
argument_list|(
name|error_code_returned
argument_list|,
name|returned_error_string
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"  Expected error code %s but got `%s'.\n"
argument_list|,
name|expected_error_string
argument_list|,
name|returned_error_string
argument_list|)
expr_stmt|;
name|error
operator|=
name|true
expr_stmt|;
block|}
if|if
condition|(
name|error
condition|)
name|print_pattern_info
argument_list|(
name|pattern
argument_list|,
name|pattern_buffer_ptr
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|test_nsub
parameter_list|(
name|sub_count
parameter_list|,
name|pattern
parameter_list|,
name|cflags
parameter_list|)
name|unsigned
name|sub_count
decl_stmt|;
name|char
modifier|*
name|pattern
decl_stmt|;
name|int
name|cflags
decl_stmt|;
block|{
name|regex_t
name|pattern_buffer
decl_stmt|;
name|test_compile
argument_list|(
literal|1
argument_list|,
literal|0
argument_list|,
name|pattern
argument_list|,
operator|&
name|pattern_buffer
argument_list|,
name|cflags
argument_list|)
expr_stmt|;
if|if
condition|(
name|pattern_buffer
operator|.
name|re_nsub
operator|!=
name|sub_count
condition|)
block|{
name|printf
argument_list|(
literal|"\nShould have counted %d subexpressions but counted %d \ instead.\n"
argument_list|,
name|sub_count
argument_list|,
name|pattern_buffer
operator|.
name|re_nsub
argument_list|)
expr_stmt|;
block|}
name|regfree
argument_list|(
operator|&
name|pattern_buffer
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|test_regcomp
parameter_list|()
block|{
name|regex_t
name|pattern_buffer
decl_stmt|;
name|int
name|cflags
init|=
literal|0
decl_stmt|;
name|printf
argument_list|(
literal|"\nStarting regcomp tests.\n"
argument_list|)
expr_stmt|;
name|cflags
operator|=
literal|0
expr_stmt|;
name|test_compile
argument_list|(
literal|0
argument_list|,
name|REG_ESUBREG
argument_list|,
literal|"\\(a\\)\\2"
argument_list|,
operator|&
name|pattern_buffer
argument_list|,
name|cflags
argument_list|)
expr_stmt|;
name|test_compile
argument_list|(
literal|0
argument_list|,
name|REG_EBRACE
argument_list|,
literal|"a\\{"
argument_list|,
operator|&
name|pattern_buffer
argument_list|,
name|cflags
argument_list|)
expr_stmt|;
name|test_compile
argument_list|(
literal|0
argument_list|,
name|REG_BADBR
argument_list|,
literal|"a\\{-1\\}"
argument_list|,
operator|&
name|pattern_buffer
argument_list|,
name|cflags
argument_list|)
expr_stmt|;
name|test_compile
argument_list|(
literal|0
argument_list|,
name|REG_EBRACE
argument_list|,
literal|"a\\{"
argument_list|,
operator|&
name|pattern_buffer
argument_list|,
name|cflags
argument_list|)
expr_stmt|;
name|test_compile
argument_list|(
literal|0
argument_list|,
name|REG_EBRACE
argument_list|,
literal|"a\\{1"
argument_list|,
operator|&
name|pattern_buffer
argument_list|,
name|cflags
argument_list|)
expr_stmt|;
name|cflags
operator|=
name|REG_EXTENDED
expr_stmt|;
name|test_compile
argument_list|(
literal|0
argument_list|,
name|REG_ECTYPE
argument_list|,
literal|"[[:alpo:]]"
argument_list|,
operator|&
name|pattern_buffer
argument_list|,
name|cflags
argument_list|)
expr_stmt|;
name|test_compile
argument_list|(
literal|0
argument_list|,
name|REG_EESCAPE
argument_list|,
literal|"\\"
argument_list|,
operator|&
name|pattern_buffer
argument_list|,
name|cflags
argument_list|)
expr_stmt|;
name|test_compile
argument_list|(
literal|0
argument_list|,
name|REG_EBRACK
argument_list|,
literal|"[a"
argument_list|,
operator|&
name|pattern_buffer
argument_list|,
name|cflags
argument_list|)
expr_stmt|;
name|test_compile
argument_list|(
literal|0
argument_list|,
name|REG_EPAREN
argument_list|,
literal|"("
argument_list|,
operator|&
name|pattern_buffer
argument_list|,
name|cflags
argument_list|)
expr_stmt|;
name|test_compile
argument_list|(
literal|0
argument_list|,
name|REG_ERANGE
argument_list|,
literal|"[z-a]"
argument_list|,
operator|&
name|pattern_buffer
argument_list|,
name|cflags
argument_list|)
expr_stmt|;
name|test_nsub
argument_list|(
literal|1
argument_list|,
literal|"(a)"
argument_list|,
name|cflags
argument_list|)
expr_stmt|;
name|test_nsub
argument_list|(
literal|2
argument_list|,
literal|"((a))"
argument_list|,
name|cflags
argument_list|)
expr_stmt|;
name|test_nsub
argument_list|(
literal|2
argument_list|,
literal|"(a)(b)"
argument_list|,
name|cflags
argument_list|)
expr_stmt|;
name|cflags
operator|=
name|REG_EXTENDED
operator||
name|REG_NOSUB
expr_stmt|;
name|test_nsub
argument_list|(
literal|1
argument_list|,
literal|"(a)"
argument_list|,
name|cflags
argument_list|)
expr_stmt|;
name|regfree
argument_list|(
operator|&
name|pattern_buffer
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\nFinished regcomp tests.\n"
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|fill_pmatch
parameter_list|(
name|pmatch
parameter_list|,
name|start0
parameter_list|,
name|end0
parameter_list|,
name|start1
parameter_list|,
name|end1
parameter_list|,
name|start2
parameter_list|,
name|end2
parameter_list|)
name|regmatch_t
name|pmatch
index|[]
decl_stmt|;
name|regoff_t
name|start0
decl_stmt|,
name|end0
decl_stmt|,
name|start1
decl_stmt|,
name|end1
decl_stmt|,
name|start2
decl_stmt|,
name|end2
decl_stmt|;
block|{
name|pmatch
index|[
literal|0
index|]
operator|.
name|rm_so
operator|=
name|start0
expr_stmt|;
name|pmatch
index|[
literal|0
index|]
operator|.
name|rm_eo
operator|=
name|end0
expr_stmt|;
name|pmatch
index|[
literal|1
index|]
operator|.
name|rm_so
operator|=
name|start1
expr_stmt|;
name|pmatch
index|[
literal|1
index|]
operator|.
name|rm_eo
operator|=
name|end1
expr_stmt|;
name|pmatch
index|[
literal|2
index|]
operator|.
name|rm_so
operator|=
name|start2
expr_stmt|;
name|pmatch
index|[
literal|2
index|]
operator|.
name|rm_eo
operator|=
name|end2
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|test_pmatch
parameter_list|(
name|pattern
parameter_list|,
name|string
parameter_list|,
name|nmatch
parameter_list|,
name|pmatch
parameter_list|,
name|correct_pmatch
parameter_list|,
name|cflags
parameter_list|)
name|char
modifier|*
name|pattern
decl_stmt|;
name|char
modifier|*
name|string
decl_stmt|;
name|unsigned
name|nmatch
decl_stmt|;
name|regmatch_t
name|pmatch
index|[]
decl_stmt|;
name|regmatch_t
name|correct_pmatch
index|[]
decl_stmt|;
name|int
name|cflags
decl_stmt|;
block|{
name|regex_t
name|pattern_buffer
decl_stmt|;
name|unsigned
name|this_match
decl_stmt|;
name|int
name|error_code_returned
decl_stmt|;
name|boolean
name|found_nonmatch
init|=
name|false
decl_stmt|;
name|test_compile
argument_list|(
literal|1
argument_list|,
literal|0
argument_list|,
name|pattern
argument_list|,
operator|&
name|pattern_buffer
argument_list|,
name|cflags
argument_list|)
expr_stmt|;
name|error_code_returned
operator|=
name|regexec
argument_list|(
operator|&
name|pattern_buffer
argument_list|,
name|string
argument_list|,
name|nmatch
argument_list|,
name|pmatch
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|error_code_returned
operator|==
name|REG_NOMATCH
condition|)
name|printf
argument_list|(
literal|"Matching failed in test_pmatch.\n"
argument_list|)
expr_stmt|;
else|else
block|{
for|for
control|(
name|this_match
operator|=
literal|0
init|;
name|this_match
operator|<
name|nmatch
condition|;
name|this_match
operator|++
control|)
block|{
if|if
condition|(
name|pmatch
index|[
name|this_match
index|]
operator|.
name|rm_so
operator|!=
name|correct_pmatch
index|[
name|this_match
index|]
operator|.
name|rm_so
condition|)
block|{
if|if
condition|(
name|found_nonmatch
operator|==
name|false
condition|)
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Pmatch start %d wrong: was %d when should have \ been %d.\n"
argument_list|,
name|this_match
argument_list|,
name|pmatch
index|[
name|this_match
index|]
operator|.
name|rm_so
argument_list|,
name|correct_pmatch
index|[
name|this_match
index|]
operator|.
name|rm_so
argument_list|)
expr_stmt|;
name|found_nonmatch
operator|=
name|true
expr_stmt|;
block|}
if|if
condition|(
name|pmatch
index|[
name|this_match
index|]
operator|.
name|rm_eo
operator|!=
name|correct_pmatch
index|[
name|this_match
index|]
operator|.
name|rm_eo
condition|)
block|{
if|if
condition|(
name|found_nonmatch
operator|==
name|false
condition|)
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Pmatch end   %d wrong: was %d when should have been \ %d.\n"
argument_list|,
name|this_match
argument_list|,
name|pmatch
index|[
name|this_match
index|]
operator|.
name|rm_eo
argument_list|,
name|correct_pmatch
index|[
name|this_match
index|]
operator|.
name|rm_eo
argument_list|)
expr_stmt|;
name|found_nonmatch
operator|=
name|true
expr_stmt|;
block|}
block|}
if|if
condition|(
name|found_nonmatch
condition|)
block|{
name|printf
argument_list|(
literal|"  The number of pmatches requested was: %d.\n"
argument_list|,
name|nmatch
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"  The string to match was:  `%s'.\n"
argument_list|,
name|string
argument_list|)
expr_stmt|;
name|print_pattern_info
argument_list|(
name|pattern
argument_list|,
operator|&
name|pattern_buffer
argument_list|)
expr_stmt|;
block|}
block|}
comment|/* error_code_returned == REG_NOMATCH  */
name|regfree
argument_list|(
operator|&
name|pattern_buffer
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|test_eflags
parameter_list|(
name|must_match_bol
parameter_list|,
name|must_match_eol
parameter_list|,
name|pattern
parameter_list|,
name|string
parameter_list|,
name|cflags
parameter_list|,
name|eflags
parameter_list|)
name|boolean
name|must_match_bol
decl_stmt|;
name|boolean
name|must_match_eol
decl_stmt|;
name|char
modifier|*
name|pattern
decl_stmt|;
name|char
modifier|*
name|string
decl_stmt|;
name|int
name|cflags
decl_stmt|;
name|int
name|eflags
decl_stmt|;
block|{
name|regex_t
name|pattern_buffer
decl_stmt|;
name|int
name|error_code_returned
decl_stmt|;
name|boolean
name|was_error
init|=
name|false
decl_stmt|;
name|test_compile
argument_list|(
literal|1
argument_list|,
literal|0
argument_list|,
name|pattern
argument_list|,
operator|&
name|pattern_buffer
argument_list|,
name|cflags
argument_list|)
expr_stmt|;
name|error_code_returned
operator|=
name|regexec
argument_list|(
operator|&
name|pattern_buffer
argument_list|,
name|string
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
name|eflags
argument_list|)
expr_stmt|;
if|if
condition|(
name|error_code_returned
operator|==
name|REG_NOMATCH
condition|)
block|{
comment|/* If wasn't true that both 1) the anchored part of the pattern          had to match this string and 2) this string was a proper 	 substring...  */
if|if
condition|(
operator|!
operator|(
operator|(
name|must_match_bol
operator|&&
operator|(
name|eflags
operator|&
name|REG_NOTBOL
operator|)
operator|)
operator|||
operator|(
name|must_match_eol
operator|&&
operator|(
name|eflags
operator|&
name|REG_NOTEOL
operator|)
operator|)
operator|)
condition|)
block|{
name|printf
argument_list|(
literal|"\nEflags test failed:  didn't match when should have.\n"
argument_list|)
expr_stmt|;
name|was_error
operator|=
name|true
expr_stmt|;
block|}
block|}
else|else
comment|/* We got a match.  */
block|{
comment|/* If wasn't true that either 1) the anchored part of the pattern          didn't have to match this string or 2) this string wasn't a          proper substring...  */
if|if
condition|(
operator|(
name|must_match_bol
operator|==
operator|(
name|eflags
operator|&
name|REG_NOTBOL
operator|)
operator|)
operator|||
operator|(
name|must_match_eol
operator|==
operator|(
name|eflags
operator|&
name|REG_NOTEOL
operator|)
operator|)
condition|)
block|{
name|printf
argument_list|(
literal|"\nEflags test failed:  matched when shouldn't have.\n"
argument_list|)
expr_stmt|;
name|was_error
operator|=
name|true
expr_stmt|;
block|}
block|}
if|if
condition|(
name|was_error
condition|)
block|{
name|printf
argument_list|(
literal|"  The string to match was:  `%s'.\n"
argument_list|,
name|string
argument_list|)
expr_stmt|;
name|print_pattern_info
argument_list|(
name|pattern
argument_list|,
operator|&
name|pattern_buffer
argument_list|)
expr_stmt|;
if|if
condition|(
name|eflags
operator|&
name|REG_NOTBOL
condition|)
name|printf
argument_list|(
literal|"  The eflag REG_BOL was set.\n"
argument_list|)
expr_stmt|;
if|if
condition|(
name|eflags
operator|&
name|REG_NOTEOL
condition|)
name|printf
argument_list|(
literal|"  The eflag REG_EOL was set.\n"
argument_list|)
expr_stmt|;
block|}
name|regfree
argument_list|(
operator|&
name|pattern_buffer
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|test_ignore_case
parameter_list|(
name|should_match
parameter_list|,
name|pattern
parameter_list|,
name|string
parameter_list|,
name|cflags
parameter_list|)
name|boolean
name|should_match
decl_stmt|;
name|char
modifier|*
name|pattern
decl_stmt|;
name|char
modifier|*
name|string
decl_stmt|;
name|int
name|cflags
decl_stmt|;
block|{
name|regex_t
name|pattern_buffer
decl_stmt|;
name|int
name|error_code_returned
decl_stmt|;
name|test_compile
argument_list|(
literal|1
argument_list|,
literal|0
argument_list|,
name|pattern
argument_list|,
operator|&
name|pattern_buffer
argument_list|,
name|cflags
argument_list|)
expr_stmt|;
name|error_code_returned
operator|=
name|regexec
argument_list|(
operator|&
name|pattern_buffer
argument_list|,
name|string
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|should_match
operator|&&
name|error_code_returned
operator|==
name|REG_NOMATCH
condition|)
block|{
name|printf
argument_list|(
literal|"\nIgnore-case test failed:\n"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"  The string to match was:  `%s'.\n"
argument_list|,
name|string
argument_list|)
expr_stmt|;
name|print_pattern_info
argument_list|(
name|pattern
argument_list|,
operator|&
name|pattern_buffer
argument_list|)
expr_stmt|;
if|if
condition|(
name|cflags
operator|&
name|REG_ICASE
condition|)
name|printf
argument_list|(
literal|"  The cflag REG_ICASE was set.\n"
argument_list|)
expr_stmt|;
block|}
name|regfree
argument_list|(
operator|&
name|pattern_buffer
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|test_newline
parameter_list|(
name|should_match
parameter_list|,
name|pattern
parameter_list|,
name|string
parameter_list|,
name|cflags
parameter_list|)
name|boolean
name|should_match
decl_stmt|;
name|char
modifier|*
name|pattern
decl_stmt|;
name|char
modifier|*
name|string
decl_stmt|;
name|int
name|cflags
decl_stmt|;
block|{
name|regex_t
name|pattern_buffer
decl_stmt|;
name|int
name|error_code_returned
decl_stmt|;
name|test_compile
argument_list|(
literal|1
argument_list|,
literal|0
argument_list|,
name|pattern
argument_list|,
operator|&
name|pattern_buffer
argument_list|,
name|cflags
argument_list|)
expr_stmt|;
name|error_code_returned
operator|=
name|regexec
argument_list|(
operator|&
name|pattern_buffer
argument_list|,
name|string
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|should_match
operator|&&
name|error_code_returned
operator|==
name|REG_NOMATCH
condition|)
block|{
name|printf
argument_list|(
literal|"\nNewline test failed:\n"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"  The string to match was:  `%s'.\n"
argument_list|,
name|string
argument_list|)
expr_stmt|;
name|print_pattern_info
argument_list|(
name|pattern
argument_list|,
operator|&
name|pattern_buffer
argument_list|)
expr_stmt|;
if|if
condition|(
name|cflags
operator|&
name|REG_NEWLINE
condition|)
name|printf
argument_list|(
literal|"  The cflag REG_NEWLINE was set.\n"
argument_list|)
expr_stmt|;
else|else
name|printf
argument_list|(
literal|"  The cflag REG_NEWLINE wasn't set.\n"
argument_list|)
expr_stmt|;
block|}
name|regfree
argument_list|(
operator|&
name|pattern_buffer
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|test_posix_match
parameter_list|(
name|should_match
parameter_list|,
name|pattern
parameter_list|,
name|string
parameter_list|,
name|cflags
parameter_list|)
name|boolean
name|should_match
decl_stmt|;
name|char
modifier|*
name|pattern
decl_stmt|;
name|char
modifier|*
name|string
decl_stmt|;
name|int
name|cflags
decl_stmt|;
block|{
name|regex_t
name|pattern_buffer
decl_stmt|;
name|int
name|error_code_returned
decl_stmt|;
name|boolean
name|was_error
init|=
name|false
decl_stmt|;
name|test_compile
argument_list|(
literal|1
argument_list|,
literal|0
argument_list|,
name|pattern
argument_list|,
operator|&
name|pattern_buffer
argument_list|,
name|cflags
argument_list|)
expr_stmt|;
name|error_code_returned
operator|=
name|regexec
argument_list|(
operator|&
name|pattern_buffer
argument_list|,
name|string
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|should_match
operator|&&
name|error_code_returned
operator|==
name|REG_NOMATCH
condition|)
block|{
name|printf
argument_list|(
literal|"\nShould have matched but didn't:\n"
argument_list|)
expr_stmt|;
name|was_error
operator|=
name|true
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|!
name|should_match
operator|&&
name|error_code_returned
operator|!=
name|REG_NOMATCH
condition|)
block|{
name|printf
argument_list|(
literal|"\nShould not have matched but did:\n"
argument_list|)
expr_stmt|;
name|was_error
operator|=
name|true
expr_stmt|;
block|}
if|if
condition|(
name|was_error
condition|)
block|{
name|printf
argument_list|(
literal|"  The string to match was:  `%s'.\n"
argument_list|,
name|string
argument_list|)
expr_stmt|;
name|print_pattern_info
argument_list|(
name|pattern
argument_list|,
operator|&
name|pattern_buffer
argument_list|)
expr_stmt|;
block|}
name|regfree
argument_list|(
operator|&
name|pattern_buffer
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|test_regexec
parameter_list|()
block|{
name|regmatch_t
name|pmatch
index|[
literal|3
index|]
decl_stmt|;
name|regmatch_t
name|correct_pmatch
index|[
literal|3
index|]
decl_stmt|;
name|int
name|cflags
init|=
literal|0
decl_stmt|;
name|int
name|eflags
init|=
literal|0
decl_stmt|;
name|printf
argument_list|(
literal|"\nStarting regexec tests.\n"
argument_list|)
expr_stmt|;
name|cflags
operator|=
name|REG_NOSUB
expr_stmt|;
comment|/* shouldn't look at any of pmatch.  */
name|test_pmatch
argument_list|(
literal|"a"
argument_list|,
literal|"a"
argument_list|,
literal|0
argument_list|,
name|pmatch
argument_list|,
name|correct_pmatch
argument_list|,
name|cflags
argument_list|)
expr_stmt|;
comment|/* Ask for less `pmatch'es than there are pattern subexpressions.      (Shouldn't look at pmatch[2].  */
name|cflags
operator|=
name|REG_EXTENDED
expr_stmt|;
name|fill_pmatch
argument_list|(
name|correct_pmatch
argument_list|,
literal|0
argument_list|,
literal|1
argument_list|,
literal|0
argument_list|,
literal|1
argument_list|,
literal|100
argument_list|,
literal|101
argument_list|)
expr_stmt|;
name|test_pmatch
argument_list|(
literal|"((a))"
argument_list|,
literal|"a"
argument_list|,
literal|2
argument_list|,
name|pmatch
argument_list|,
name|correct_pmatch
argument_list|,
name|cflags
argument_list|)
expr_stmt|;
comment|/* Ask for same number of `pmatch'es as there are pattern subexpressions.  */
name|cflags
operator|=
name|REG_EXTENDED
expr_stmt|;
name|fill_pmatch
argument_list|(
name|correct_pmatch
argument_list|,
literal|0
argument_list|,
literal|1
argument_list|,
literal|0
argument_list|,
literal|1
argument_list|,
operator|-
literal|1
argument_list|,
operator|-
literal|1
argument_list|)
expr_stmt|;
name|test_pmatch
argument_list|(
literal|"(a)"
argument_list|,
literal|"a"
argument_list|,
literal|2
argument_list|,
name|pmatch
argument_list|,
name|correct_pmatch
argument_list|,
name|cflags
argument_list|)
expr_stmt|;
comment|/* Ask for more `pmatch'es than there are pattern subexpressions.  */
name|cflags
operator|=
name|REG_EXTENDED
expr_stmt|;
name|fill_pmatch
argument_list|(
name|correct_pmatch
argument_list|,
literal|0
argument_list|,
literal|1
argument_list|,
operator|-
literal|1
argument_list|,
operator|-
literal|1
argument_list|,
operator|-
literal|1
argument_list|,
operator|-
literal|1
argument_list|)
expr_stmt|;
name|test_pmatch
argument_list|(
literal|"a"
argument_list|,
literal|"a"
argument_list|,
literal|2
argument_list|,
name|pmatch
argument_list|,
name|correct_pmatch
argument_list|,
name|cflags
argument_list|)
expr_stmt|;
name|eflags
operator|=
name|REG_NOTBOL
expr_stmt|;
name|test_eflags
argument_list|(
name|true
argument_list|,
name|false
argument_list|,
literal|"^a"
argument_list|,
literal|"a"
argument_list|,
name|cflags
argument_list|,
name|eflags
argument_list|)
expr_stmt|;
name|test_eflags
argument_list|(
name|true
argument_list|,
name|false
argument_list|,
literal|"(^a)"
argument_list|,
literal|"a"
argument_list|,
name|cflags
argument_list|,
name|eflags
argument_list|)
expr_stmt|;
name|test_eflags
argument_list|(
name|true
argument_list|,
name|false
argument_list|,
literal|"a|^b"
argument_list|,
literal|"b"
argument_list|,
name|cflags
argument_list|,
name|eflags
argument_list|)
expr_stmt|;
name|test_eflags
argument_list|(
name|true
argument_list|,
name|false
argument_list|,
literal|"^b|a"
argument_list|,
literal|"b"
argument_list|,
name|cflags
argument_list|,
name|eflags
argument_list|)
expr_stmt|;
name|eflags
operator|=
name|REG_NOTEOL
expr_stmt|;
name|test_eflags
argument_list|(
name|false
argument_list|,
name|true
argument_list|,
literal|"a$"
argument_list|,
literal|"a"
argument_list|,
name|cflags
argument_list|,
name|eflags
argument_list|)
expr_stmt|;
name|test_eflags
argument_list|(
name|false
argument_list|,
name|true
argument_list|,
literal|"(a$)"
argument_list|,
literal|"a"
argument_list|,
name|cflags
argument_list|,
name|eflags
argument_list|)
expr_stmt|;
name|test_eflags
argument_list|(
name|false
argument_list|,
name|true
argument_list|,
literal|"a|b$"
argument_list|,
literal|"b"
argument_list|,
name|cflags
argument_list|,
name|eflags
argument_list|)
expr_stmt|;
name|test_eflags
argument_list|(
name|false
argument_list|,
name|true
argument_list|,
literal|"b$|a"
argument_list|,
literal|"b"
argument_list|,
name|cflags
argument_list|,
name|eflags
argument_list|)
expr_stmt|;
name|eflags
operator|=
name|REG_NOTBOL
operator||
name|REG_NOTEOL
expr_stmt|;
name|test_eflags
argument_list|(
name|true
argument_list|,
name|true
argument_list|,
literal|"^a$"
argument_list|,
literal|"a"
argument_list|,
name|cflags
argument_list|,
name|eflags
argument_list|)
expr_stmt|;
name|test_eflags
argument_list|(
name|true
argument_list|,
name|true
argument_list|,
literal|"(^a$)"
argument_list|,
literal|"a"
argument_list|,
name|cflags
argument_list|,
name|eflags
argument_list|)
expr_stmt|;
name|test_eflags
argument_list|(
name|true
argument_list|,
name|true
argument_list|,
literal|"a|(^b$)"
argument_list|,
literal|"b"
argument_list|,
name|cflags
argument_list|,
name|eflags
argument_list|)
expr_stmt|;
name|test_eflags
argument_list|(
name|true
argument_list|,
name|true
argument_list|,
literal|"(^b$)|a"
argument_list|,
literal|"b"
argument_list|,
name|cflags
argument_list|,
name|eflags
argument_list|)
expr_stmt|;
name|cflags
operator|=
name|REG_ICASE
expr_stmt|;
name|test_ignore_case
argument_list|(
name|true
argument_list|,
literal|"a"
argument_list|,
literal|"a"
argument_list|,
name|cflags
argument_list|)
expr_stmt|;
name|test_ignore_case
argument_list|(
name|true
argument_list|,
literal|"A"
argument_list|,
literal|"A"
argument_list|,
name|cflags
argument_list|)
expr_stmt|;
name|test_ignore_case
argument_list|(
name|true
argument_list|,
literal|"A"
argument_list|,
literal|"a"
argument_list|,
name|cflags
argument_list|)
expr_stmt|;
name|test_ignore_case
argument_list|(
name|true
argument_list|,
literal|"a"
argument_list|,
literal|"A"
argument_list|,
name|cflags
argument_list|)
expr_stmt|;
name|test_ignore_case
argument_list|(
name|true
argument_list|,
literal|"@"
argument_list|,
literal|"@"
argument_list|,
name|cflags
argument_list|)
expr_stmt|;
name|test_ignore_case
argument_list|(
name|true
argument_list|,
literal|"\\["
argument_list|,
literal|"["
argument_list|,
name|cflags
argument_list|)
expr_stmt|;
name|test_ignore_case
argument_list|(
name|true
argument_list|,
literal|"`"
argument_list|,
literal|"`"
argument_list|,
name|cflags
argument_list|)
expr_stmt|;
name|test_ignore_case
argument_list|(
name|true
argument_list|,
literal|"{"
argument_list|,
literal|"{"
argument_list|,
name|cflags
argument_list|)
expr_stmt|;
name|test_ignore_case
argument_list|(
name|true
argument_list|,
literal|"[!-`]"
argument_list|,
literal|"A"
argument_list|,
name|cflags
argument_list|)
expr_stmt|;
name|test_ignore_case
argument_list|(
name|true
argument_list|,
literal|"[!-`]"
argument_list|,
literal|"a"
argument_list|,
name|cflags
argument_list|)
expr_stmt|;
name|cflags
operator|=
literal|0
expr_stmt|;
name|test_ignore_case
argument_list|(
name|false
argument_list|,
literal|"a"
argument_list|,
literal|"a"
argument_list|,
name|cflags
argument_list|)
expr_stmt|;
name|test_ignore_case
argument_list|(
name|false
argument_list|,
literal|"A"
argument_list|,
literal|"A"
argument_list|,
name|cflags
argument_list|)
expr_stmt|;
name|test_ignore_case
argument_list|(
name|false
argument_list|,
literal|"A"
argument_list|,
literal|"a"
argument_list|,
name|cflags
argument_list|)
expr_stmt|;
name|test_ignore_case
argument_list|(
name|false
argument_list|,
literal|"a"
argument_list|,
literal|"A"
argument_list|,
name|cflags
argument_list|)
expr_stmt|;
name|test_ignore_case
argument_list|(
name|true
argument_list|,
literal|"@"
argument_list|,
literal|"@"
argument_list|,
name|cflags
argument_list|)
expr_stmt|;
name|test_ignore_case
argument_list|(
name|true
argument_list|,
literal|"\\["
argument_list|,
literal|"["
argument_list|,
name|cflags
argument_list|)
expr_stmt|;
name|test_ignore_case
argument_list|(
name|true
argument_list|,
literal|"`"
argument_list|,
literal|"`"
argument_list|,
name|cflags
argument_list|)
expr_stmt|;
name|test_ignore_case
argument_list|(
name|true
argument_list|,
literal|"{"
argument_list|,
literal|"{"
argument_list|,
name|cflags
argument_list|)
expr_stmt|;
name|test_ignore_case
argument_list|(
name|true
argument_list|,
literal|"[!-`]"
argument_list|,
literal|"A"
argument_list|,
name|cflags
argument_list|)
expr_stmt|;
name|test_ignore_case
argument_list|(
name|false
argument_list|,
literal|"[!-`]"
argument_list|,
literal|"a"
argument_list|,
name|cflags
argument_list|)
expr_stmt|;
comment|/* Test newline stuff.  */
name|cflags
operator|=
name|REG_EXTENDED
operator||
name|REG_NEWLINE
expr_stmt|;
name|test_newline
argument_list|(
name|true
argument_list|,
literal|"\n"
argument_list|,
literal|"\n"
argument_list|,
name|cflags
argument_list|)
expr_stmt|;
name|test_newline
argument_list|(
name|true
argument_list|,
literal|"a\n"
argument_list|,
literal|"a\n"
argument_list|,
name|cflags
argument_list|)
expr_stmt|;
name|test_newline
argument_list|(
name|true
argument_list|,
literal|"\nb"
argument_list|,
literal|"\nb"
argument_list|,
name|cflags
argument_list|)
expr_stmt|;
name|test_newline
argument_list|(
name|true
argument_list|,
literal|"a\nb"
argument_list|,
literal|"a\nb"
argument_list|,
name|cflags
argument_list|)
expr_stmt|;
name|test_newline
argument_list|(
name|false
argument_list|,
literal|"."
argument_list|,
literal|"\n"
argument_list|,
name|cflags
argument_list|)
expr_stmt|;
name|test_newline
argument_list|(
name|false
argument_list|,
literal|"[^a]"
argument_list|,
literal|"\n"
argument_list|,
name|cflags
argument_list|)
expr_stmt|;
name|test_newline
argument_list|(
name|true
argument_list|,
literal|"\n^a"
argument_list|,
literal|"\na"
argument_list|,
name|cflags
argument_list|)
expr_stmt|;
name|test_newline
argument_list|(
name|true
argument_list|,
literal|"\n(^a|b)"
argument_list|,
literal|"\na"
argument_list|,
name|cflags
argument_list|)
expr_stmt|;
name|test_newline
argument_list|(
name|true
argument_list|,
literal|"a$\n"
argument_list|,
literal|"a\n"
argument_list|,
name|cflags
argument_list|)
expr_stmt|;
name|test_newline
argument_list|(
name|true
argument_list|,
literal|"(a$|b)\n"
argument_list|,
literal|"a\n"
argument_list|,
name|cflags
argument_list|)
expr_stmt|;
name|test_newline
argument_list|(
name|true
argument_list|,
literal|"(a$|b|c)\n"
argument_list|,
literal|"a\n"
argument_list|,
name|cflags
argument_list|)
expr_stmt|;
name|test_newline
argument_list|(
name|true
argument_list|,
literal|"((a$|b|c)$)\n"
argument_list|,
literal|"a\n"
argument_list|,
name|cflags
argument_list|)
expr_stmt|;
name|test_newline
argument_list|(
name|true
argument_list|,
literal|"((a$|b|c)$)\n"
argument_list|,
literal|"b\n"
argument_list|,
name|cflags
argument_list|)
expr_stmt|;
name|test_newline
argument_list|(
name|true
argument_list|,
literal|"(a$|b)\n|a\n"
argument_list|,
literal|"a\n"
argument_list|,
name|cflags
argument_list|)
expr_stmt|;
name|test_newline
argument_list|(
name|true
argument_list|,
literal|"^a"
argument_list|,
literal|"\na"
argument_list|,
name|cflags
argument_list|)
expr_stmt|;
name|test_newline
argument_list|(
name|true
argument_list|,
literal|"a$"
argument_list|,
literal|"a\n"
argument_list|,
name|cflags
argument_list|)
expr_stmt|;
comment|/* Now test normal behavior.  */
name|cflags
operator|=
name|REG_EXTENDED
expr_stmt|;
name|test_newline
argument_list|(
name|true
argument_list|,
literal|"\n"
argument_list|,
literal|"\n"
argument_list|,
name|cflags
argument_list|)
expr_stmt|;
name|test_newline
argument_list|(
name|true
argument_list|,
literal|"a\n"
argument_list|,
literal|"a\n"
argument_list|,
name|cflags
argument_list|)
expr_stmt|;
name|test_newline
argument_list|(
name|true
argument_list|,
literal|"\nb"
argument_list|,
literal|"\nb"
argument_list|,
name|cflags
argument_list|)
expr_stmt|;
name|test_newline
argument_list|(
name|true
argument_list|,
literal|"a\nb"
argument_list|,
literal|"a\nb"
argument_list|,
name|cflags
argument_list|)
expr_stmt|;
name|test_newline
argument_list|(
name|true
argument_list|,
literal|"."
argument_list|,
literal|"\n"
argument_list|,
name|cflags
argument_list|)
expr_stmt|;
name|test_newline
argument_list|(
name|true
argument_list|,
literal|"[^a]"
argument_list|,
literal|"\n"
argument_list|,
name|cflags
argument_list|)
expr_stmt|;
name|test_newline
argument_list|(
name|false
argument_list|,
literal|"\n^a"
argument_list|,
literal|"\na"
argument_list|,
name|cflags
argument_list|)
expr_stmt|;
name|test_newline
argument_list|(
name|false
argument_list|,
literal|"a$\n"
argument_list|,
literal|"a\n"
argument_list|,
name|cflags
argument_list|)
expr_stmt|;
name|test_newline
argument_list|(
name|false
argument_list|,
literal|"^a"
argument_list|,
literal|"\na"
argument_list|,
name|cflags
argument_list|)
expr_stmt|;
name|test_newline
argument_list|(
name|false
argument_list|,
literal|"a$"
argument_list|,
literal|"a\n"
argument_list|,
name|cflags
argument_list|)
expr_stmt|;
comment|/* Test that matches whole string only.  */
name|cflags
operator|=
literal|0
expr_stmt|;
name|test_posix_match
argument_list|(
name|true
argument_list|,
literal|"a"
argument_list|,
literal|"a"
argument_list|,
name|cflags
argument_list|)
expr_stmt|;
comment|/* Tests that match substrings.  */
name|test_posix_match
argument_list|(
name|true
argument_list|,
literal|"a"
argument_list|,
literal|"ab"
argument_list|,
name|cflags
argument_list|)
expr_stmt|;
name|test_posix_match
argument_list|(
name|true
argument_list|,
literal|"b"
argument_list|,
literal|"ab"
argument_list|,
name|cflags
argument_list|)
expr_stmt|;
comment|/* Test that doesn't match.  */
name|test_posix_match
argument_list|(
name|false
argument_list|,
literal|"a"
argument_list|,
literal|"b"
argument_list|,
name|cflags
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\nFinished regexec tests.\n"
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|test_error_code_message
parameter_list|(
name|error_code
parameter_list|,
name|expected_error_message
parameter_list|)
name|int
name|error_code
decl_stmt|;
name|char
modifier|*
name|expected_error_message
decl_stmt|;
block|{
name|char
name|returned_error_message
index|[
name|TEST_ERRBUF_SIZE
index|]
decl_stmt|;
name|char
name|error_code_string
index|[
name|ERROR_CODE_LENGTH
index|]
decl_stmt|;
name|size_t
name|expected_error_message_length
init|=
name|strlen
argument_list|(
name|expected_error_message
argument_list|)
operator|+
literal|1
decl_stmt|;
name|size_t
name|returned_error_message_length
init|=
name|regerror
argument_list|(
name|error_code
argument_list|,
literal|0
argument_list|,
name|returned_error_message
argument_list|,
name|TEST_ERRBUF_SIZE
argument_list|)
decl_stmt|;
if|if
condition|(
name|returned_error_message_length
operator|!=
name|expected_error_message_length
condition|)
block|{
name|printf
argument_list|(
literal|"\n\n  Testing returned error codes, with expected error \ message  `%s':\n"
argument_list|,
name|expected_error_message
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\n\n  and returned error message `%s':\n"
argument_list|,
name|returned_error_message
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"  should have returned a length of %d but returned %d.\n"
argument_list|,
name|expected_error_message_length
argument_list|,
name|returned_error_message_length
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|strncmp
argument_list|(
name|expected_error_message
argument_list|,
name|returned_error_message
argument_list|,
name|TEST_ERRBUF_SIZE
operator|-
literal|1
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|get_error_string
argument_list|(
name|error_code
argument_list|,
name|error_code_string
argument_list|)
operator|,
name|printf
argument_list|(
literal|"\n\n  With error code %s (%d), expected error message:\n"
argument_list|,
name|error_code_string
argument_list|,
name|error_code
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"    `%s'\n"
argument_list|,
name|expected_error_message
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"  but got:\n"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"    `%s'\n"
argument_list|,
name|returned_error_message
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|test_error_code_allocation
parameter_list|(
name|error_code
parameter_list|,
name|expected_error_message
parameter_list|)
name|int
name|error_code
decl_stmt|;
name|char
modifier|*
name|expected_error_message
decl_stmt|;
block|{
name|char
modifier|*
name|returned_error_message
init|=
name|NULL
decl_stmt|;
name|char
name|error_code_string
index|[
name|ERROR_CODE_LENGTH
index|]
decl_stmt|;
name|size_t
name|returned_error_message_length
init|=
name|regerror
argument_list|(
name|error_code
argument_list|,
literal|0
argument_list|,
name|returned_error_message
argument_list|,
operator|(
name|size_t
operator|)
literal|0
argument_list|)
decl_stmt|;
name|returned_error_message
operator|=
name|xmalloc
argument_list|(
name|returned_error_message_length
operator|+
literal|1
argument_list|)
expr_stmt|;
name|regerror
argument_list|(
name|error_code
argument_list|,
literal|0
argument_list|,
name|returned_error_message
argument_list|,
name|returned_error_message_length
argument_list|)
expr_stmt|;
if|if
condition|(
name|strcmp
argument_list|(
name|expected_error_message
argument_list|,
name|returned_error_message
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|get_error_string
argument_list|(
name|error_code
argument_list|,
name|error_code_string
argument_list|)
operator|,
name|printf
argument_list|(
literal|"\n\n  Testing error code allocation,\n"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"with error code %s (%d), expected error message:\n"
argument_list|,
name|error_code_string
argument_list|,
name|error_code
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"    `%s'\n"
argument_list|,
name|expected_error_message
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"  but got:\n"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"    `%s'\n"
argument_list|,
name|returned_error_message
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|test_regerror
parameter_list|()
block|{
name|test_error_code_message
argument_list|(
name|REG_NOMATCH
argument_list|,
literal|"No match"
argument_list|)
expr_stmt|;
name|test_error_code_message
argument_list|(
name|REG_BADPAT
argument_list|,
literal|"Invalid regular expression"
argument_list|)
expr_stmt|;
name|test_error_code_message
argument_list|(
name|REG_ECOLLATE
argument_list|,
literal|"Invalid collation character"
argument_list|)
expr_stmt|;
name|test_error_code_message
argument_list|(
name|REG_ECTYPE
argument_list|,
literal|"Invalid character class name"
argument_list|)
expr_stmt|;
name|test_error_code_message
argument_list|(
name|REG_EESCAPE
argument_list|,
literal|"Trailing backslash"
argument_list|)
expr_stmt|;
name|test_error_code_message
argument_list|(
name|REG_ESUBREG
argument_list|,
literal|"Invalid back reference"
argument_list|)
expr_stmt|;
name|test_error_code_message
argument_list|(
name|REG_EBRACK
argument_list|,
literal|"Unmatched [ or [^"
argument_list|)
expr_stmt|;
name|test_error_code_message
argument_list|(
name|REG_EPAREN
argument_list|,
literal|"Unmatched ( or \\("
argument_list|)
expr_stmt|;
name|test_error_code_message
argument_list|(
name|REG_EBRACE
argument_list|,
literal|"Unmatched \\{"
argument_list|)
expr_stmt|;
name|test_error_code_message
argument_list|(
name|REG_BADBR
argument_list|,
literal|"Invalid content of \\{\\}"
argument_list|)
expr_stmt|;
name|test_error_code_message
argument_list|(
name|REG_ERANGE
argument_list|,
literal|"Invalid range end"
argument_list|)
expr_stmt|;
name|test_error_code_message
argument_list|(
name|REG_ESPACE
argument_list|,
literal|"Memory exhausted"
argument_list|)
expr_stmt|;
name|test_error_code_message
argument_list|(
name|REG_BADRPT
argument_list|,
literal|"Invalid preceding regular expression"
argument_list|)
expr_stmt|;
name|test_error_code_message
argument_list|(
name|REG_EEND
argument_list|,
literal|"Premature end of regular expression"
argument_list|)
expr_stmt|;
name|test_error_code_message
argument_list|(
name|REG_ESIZE
argument_list|,
literal|"Regular expression too big"
argument_list|)
expr_stmt|;
name|test_error_code_allocation
argument_list|(
name|REG_ERPAREN
argument_list|,
literal|"Unmatched ) or \\)"
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|test_posix_interface
parameter_list|()
block|{
name|printf
argument_list|(
literal|"\nStarting POSIX interface tests.\n"
argument_list|)
expr_stmt|;
name|t
operator|=
name|posix_interface_test
expr_stmt|;
name|test_regcomp
argument_list|()
expr_stmt|;
name|test_regexec
argument_list|()
expr_stmt|;
name|test_regerror
argument_list|()
expr_stmt|;
name|printf
argument_list|(
literal|"\nFinished POSIX interface tests.\n"
argument_list|)
expr_stmt|;
block|}
end_function

end_unit


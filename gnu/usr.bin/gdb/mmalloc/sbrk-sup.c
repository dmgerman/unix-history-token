begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/* Support for sbrk() regions.    Copyright 1992 Free Software Foundation, Inc.    Contributed by Fred Fish at Cygnus Support.   fnf@cygnus.com  This file is part of the GNU C Library.  The GNU C Library is free software; you can redistribute it and/or modify it under the terms of the GNU Library General Public License as published by the Free Software Foundation; either version 2 of the License, or (at your option) any later version.  The GNU C Library is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU Library General Public License for more details.  You should have received a copy of the GNU Library General Public License along with the GNU C Library; see the file COPYING.LIB.  If not, write to the Free Software Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.  */
end_comment

begin_include
include|#
directive|include
file|<string.h>
end_include

begin_comment
comment|/* Prototypes for memcpy, memmove, memset, etc */
end_comment

begin_include
include|#
directive|include
file|"mmalloc.h"
end_include

begin_function_decl
specifier|extern
name|PTR
name|sbrk
parameter_list|()
function_decl|;
end_function_decl

begin_comment
comment|/* The mmalloc() package can use a single implicit malloc descriptor    for mmalloc/mrealloc/mfree operations which do not supply an explicit    descriptor.  For these operations, sbrk() is used to obtain more core    from the system, or return core.  This allows mmalloc() to provide    backwards compatibility with the non-mmap'd version. */
end_comment

begin_decl_stmt
name|struct
name|mdesc
modifier|*
name|__mmalloc_default_mdp
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* Use sbrk() to get more core. */
end_comment

begin_function
specifier|static
name|PTR
name|sbrk_morecore
parameter_list|(
name|mdp
parameter_list|,
name|size
parameter_list|)
name|struct
name|mdesc
modifier|*
name|mdp
decl_stmt|;
name|int
name|size
decl_stmt|;
block|{
name|PTR
name|result
decl_stmt|;
if|if
condition|(
operator|(
name|result
operator|=
name|sbrk
argument_list|(
name|size
argument_list|)
operator|)
operator|==
operator|(
name|PTR
operator|)
operator|-
literal|1
condition|)
block|{
name|result
operator|=
name|NULL
expr_stmt|;
block|}
else|else
block|{
name|mdp
operator|->
name|breakval
operator|+=
name|size
expr_stmt|;
name|mdp
operator|->
name|top
operator|+=
name|size
expr_stmt|;
block|}
return|return
operator|(
name|result
operator|)
return|;
block|}
end_function

begin_comment
comment|/* Initialize the default malloc descriptor if this is the first time    a request has been made to use the default sbrk'd region.     Since no alignment guarantees are made about the initial value returned    by sbrk, test the initial value and (if necessary) sbrk enough additional    memory to start off with alignment to BLOCKSIZE.  We actually only need    it aligned to an alignment suitable for any object, so this is overkill.    But at most it wastes just part of one BLOCKSIZE chunk of memory and    minimizes portability problems by avoiding us having to figure out    what the actual minimal alignment is.  The rest of the malloc code    avoids this as well, by always aligning to the minimum of the requested    size rounded up to a power of two, or to BLOCKSIZE.     Note that we are going to use some memory starting at this initial sbrk    address for the sbrk region malloc descriptor, which is a struct, so the    base address must be suitably aligned. */
end_comment

begin_function
name|struct
name|mdesc
modifier|*
name|__mmalloc_sbrk_init
parameter_list|()
block|{
name|PTR
name|base
decl_stmt|;
name|unsigned
name|int
name|adj
decl_stmt|;
name|base
operator|=
name|sbrk
argument_list|(
literal|0
argument_list|)
expr_stmt|;
name|adj
operator|=
name|RESIDUAL
argument_list|(
name|base
argument_list|,
name|BLOCKSIZE
argument_list|)
expr_stmt|;
if|if
condition|(
name|adj
operator|!=
literal|0
condition|)
block|{
name|sbrk
argument_list|(
name|BLOCKSIZE
operator|-
name|adj
argument_list|)
expr_stmt|;
name|base
operator|=
name|sbrk
argument_list|(
literal|0
argument_list|)
expr_stmt|;
block|}
name|__mmalloc_default_mdp
operator|=
operator|(
expr|struct
name|mdesc
operator|*
operator|)
name|sbrk
argument_list|(
sizeof|sizeof
argument_list|(
expr|struct
name|mdesc
argument_list|)
argument_list|)
expr_stmt|;
name|memset
argument_list|(
operator|(
name|char
operator|*
operator|)
name|__mmalloc_default_mdp
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|mdesc
argument_list|)
argument_list|)
expr_stmt|;
name|__mmalloc_default_mdp
operator|->
name|morecore
operator|=
name|sbrk_morecore
expr_stmt|;
name|__mmalloc_default_mdp
operator|->
name|base
operator|=
name|base
expr_stmt|;
name|__mmalloc_default_mdp
operator|->
name|breakval
operator|=
name|__mmalloc_default_mdp
operator|->
name|top
operator|=
name|sbrk
argument_list|(
literal|0
argument_list|)
expr_stmt|;
name|__mmalloc_default_mdp
operator|->
name|fd
operator|=
operator|-
literal|1
expr_stmt|;
return|return
operator|(
name|__mmalloc_default_mdp
operator|)
return|;
block|}
end_function

end_unit


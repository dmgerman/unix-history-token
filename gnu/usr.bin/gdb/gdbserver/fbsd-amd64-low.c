begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/* GNU/FreeBSD/amd64 specific low level interface, for the remote server for GDB.    Copyright 1995, 1996, 1998, 1999, 2000, 2001, 2002    Free Software Foundation, Inc.     This file is part of GDB.     This program is free software; you can redistribute it and/or modify    it under the terms of the GNU General Public License as published by    the Free Software Foundation; either version 2 of the License, or    (at your option) any later version.     This program is distributed in the hope that it will be useful,    but WITHOUT ANY WARRANTY; without even the implied warranty of    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the    GNU General Public License for more details.     You should have received a copy of the GNU General Public License    along with this program; if not, write to the Free Software    Foundation, Inc., 59 Temple Place - Suite 330,    Boston, MA 02111-1307, USA.  */
end_comment

begin_include
include|#
directive|include
file|<sys/cdefs.h>
end_include

begin_expr_stmt
name|__FBSDID
argument_list|(
literal|"$FreeBSD$"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_include
include|#
directive|include
file|"server.h"
end_include

begin_include
include|#
directive|include
file|"fbsd-low.h"
end_include

begin_include
include|#
directive|include
file|"i387-fp.h"
end_include

begin_include
include|#
directive|include
file|<sys/stddef.h>
end_include

begin_include
include|#
directive|include
file|<sys/types.h>
end_include

begin_include
include|#
directive|include
file|<sys/ptrace.h>
end_include

begin_include
include|#
directive|include
file|<machine/reg.h>
end_include

begin_comment
comment|/* Mapping between the general-purpose registers in `struct user'    format and GDB's register array layout.  */
end_comment

begin_decl_stmt
specifier|static
name|int
name|amd64_regmap
index|[]
init|=
block|{
name|offsetof
argument_list|(
expr|struct
name|reg
argument_list|,
name|r_rax
argument_list|)
block|,
name|offsetof
argument_list|(
expr|struct
name|reg
argument_list|,
name|r_rbx
argument_list|)
block|,
name|offsetof
argument_list|(
expr|struct
name|reg
argument_list|,
name|r_rcx
argument_list|)
block|,
name|offsetof
argument_list|(
expr|struct
name|reg
argument_list|,
name|r_rdx
argument_list|)
block|,
name|offsetof
argument_list|(
expr|struct
name|reg
argument_list|,
name|r_rsi
argument_list|)
block|,
name|offsetof
argument_list|(
expr|struct
name|reg
argument_list|,
name|r_rdi
argument_list|)
block|,
name|offsetof
argument_list|(
expr|struct
name|reg
argument_list|,
name|r_rbp
argument_list|)
block|,
name|offsetof
argument_list|(
expr|struct
name|reg
argument_list|,
name|r_rsp
argument_list|)
block|,
name|offsetof
argument_list|(
expr|struct
name|reg
argument_list|,
name|r_r8
argument_list|)
block|,
name|offsetof
argument_list|(
expr|struct
name|reg
argument_list|,
name|r_r9
argument_list|)
block|,
name|offsetof
argument_list|(
expr|struct
name|reg
argument_list|,
name|r_r10
argument_list|)
block|,
name|offsetof
argument_list|(
expr|struct
name|reg
argument_list|,
name|r_r11
argument_list|)
block|,
name|offsetof
argument_list|(
expr|struct
name|reg
argument_list|,
name|r_r12
argument_list|)
block|,
name|offsetof
argument_list|(
expr|struct
name|reg
argument_list|,
name|r_r13
argument_list|)
block|,
name|offsetof
argument_list|(
expr|struct
name|reg
argument_list|,
name|r_r14
argument_list|)
block|,
name|offsetof
argument_list|(
expr|struct
name|reg
argument_list|,
name|r_r15
argument_list|)
block|,
name|offsetof
argument_list|(
expr|struct
name|reg
argument_list|,
name|r_rip
argument_list|)
block|,
name|offsetof
argument_list|(
expr|struct
name|reg
argument_list|,
name|r_rflags
argument_list|)
block|,
comment|/* XXX 64-bit */
name|offsetof
argument_list|(
expr|struct
name|reg
argument_list|,
name|r_cs
argument_list|)
block|,
name|offsetof
argument_list|(
expr|struct
name|reg
argument_list|,
name|r_ss
argument_list|)
block|,
name|offsetof
argument_list|(
expr|struct
name|reg
argument_list|,
name|r_ds
argument_list|)
block|,
name|offsetof
argument_list|(
expr|struct
name|reg
argument_list|,
name|r_es
argument_list|)
block|,
name|offsetof
argument_list|(
expr|struct
name|reg
argument_list|,
name|r_fs
argument_list|)
block|,
name|offsetof
argument_list|(
expr|struct
name|reg
argument_list|,
name|r_gs
argument_list|)
block|, }
decl_stmt|;
end_decl_stmt

begin_define
define|#
directive|define
name|AMD64_NUM_REGS
value|(sizeof(amd64_regmap) / sizeof(amd64_regmap[0]))
end_define

begin_decl_stmt
specifier|static
specifier|const
name|char
name|amd64_breakpoint
index|[]
init|=
block|{
literal|0xCC
block|}
decl_stmt|;
end_decl_stmt

begin_define
define|#
directive|define
name|AMD64_BP_LEN
value|1
end_define

begin_decl_stmt
specifier|extern
name|int
name|debug_threads
decl_stmt|;
end_decl_stmt

begin_function
specifier|static
name|int
name|amd64_cannot_store_register
parameter_list|(
name|int
name|regno
parameter_list|)
block|{
return|return
operator|(
name|regno
operator|>=
name|AMD64_NUM_REGS
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|amd64_cannot_fetch_register
parameter_list|(
name|int
name|regno
parameter_list|)
block|{
return|return
operator|(
name|regno
operator|>=
name|AMD64_NUM_REGS
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|amd64_fill_gregset
parameter_list|(
name|void
modifier|*
name|buf
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|AMD64_NUM_REGS
condition|;
name|i
operator|++
control|)
name|collect_register
argument_list|(
name|i
argument_list|,
operator|(
operator|(
name|char
operator|*
operator|)
name|buf
operator|)
operator|+
name|amd64_regmap
index|[
name|i
index|]
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|amd64_store_gregset
parameter_list|(
specifier|const
name|void
modifier|*
name|buf
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|AMD64_NUM_REGS
condition|;
name|i
operator|++
control|)
name|supply_register
argument_list|(
name|i
argument_list|,
operator|(
operator|(
name|char
operator|*
operator|)
name|buf
operator|)
operator|+
name|amd64_regmap
index|[
name|i
index|]
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|amd64_fill_fpregset
parameter_list|(
name|void
modifier|*
name|buf
parameter_list|)
block|{
name|i387_cache_to_fsave
argument_list|(
name|buf
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|amd64_store_fpregset
parameter_list|(
specifier|const
name|void
modifier|*
name|buf
parameter_list|)
block|{
name|i387_fsave_to_cache
argument_list|(
name|buf
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|amd64_fill_fpxregset
parameter_list|(
name|void
modifier|*
name|buf
parameter_list|)
block|{
name|i387_cache_to_fxsave
argument_list|(
name|buf
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|amd64_store_fpxregset
parameter_list|(
specifier|const
name|void
modifier|*
name|buf
parameter_list|)
block|{
name|i387_fxsave_to_cache
argument_list|(
name|buf
argument_list|)
expr_stmt|;
block|}
end_function

begin_decl_stmt
name|struct
name|regset_info
name|target_regsets
index|[]
init|=
block|{
block|{
name|PT_GETREGS
block|,
name|PT_SETREGS
block|,
sizeof|sizeof
argument_list|(
expr|struct
name|reg
argument_list|)
block|,
name|GENERAL_REGS
block|,
name|amd64_fill_gregset
block|,
name|amd64_store_gregset
block|, 	}
block|,
ifdef|#
directive|ifdef
name|HAVE_PTRACE_GETFPXREGS
block|{
name|PTRACE_GETFPXREGS
block|,
name|PTRACE_SETFPXREGS
block|,
sizeof|sizeof
argument_list|(
name|elf_fpxregset_t
argument_list|)
block|,
name|EXTENDED_REGS
block|,
name|amd64_fill_fpxregset
block|,
name|amd64_store_fpxregset
block|, 	}
block|,
endif|#
directive|endif
block|{
name|PT_GETFPREGS
block|,
name|PT_SETFPREGS
block|,
sizeof|sizeof
argument_list|(
expr|struct
name|fpreg
argument_list|)
block|,
name|FP_REGS
block|,
name|amd64_fill_fpregset
block|,
name|amd64_store_fpregset
block|, 	}
block|,
block|{
literal|0
block|,
literal|0
block|,
operator|-
literal|1
block|,
operator|-
literal|1
block|,
name|NULL
block|,
name|NULL
block|, 	}
block|}
decl_stmt|;
end_decl_stmt

begin_function
specifier|static
name|CORE_ADDR
name|amd64_get_pc
parameter_list|(
name|void
parameter_list|)
block|{
name|unsigned
name|long
name|pc
decl_stmt|;
name|collect_register_by_name
argument_list|(
literal|"rip"
argument_list|,
operator|&
name|pc
argument_list|)
expr_stmt|;
if|if
condition|(
name|debug_threads
condition|)
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"stop pc (before any decrement) is %016lx\n"
argument_list|,
name|pc
argument_list|)
expr_stmt|;
return|return
operator|(
name|pc
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|amd64_set_pc
parameter_list|(
name|CORE_ADDR
name|newpc
parameter_list|)
block|{
if|if
condition|(
name|debug_threads
condition|)
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"set pc to %016lx\n"
argument_list|,
operator|(
name|long
operator|)
name|newpc
argument_list|)
expr_stmt|;
name|supply_register_by_name
argument_list|(
literal|"rip"
argument_list|,
operator|&
name|newpc
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|amd64_breakpoint_at
parameter_list|(
name|CORE_ADDR
name|pc
parameter_list|)
block|{
name|unsigned
name|char
name|c
decl_stmt|;
name|read_inferior_memory
argument_list|(
name|pc
argument_list|,
operator|&
name|c
argument_list|,
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|c
operator|==
literal|0xCC
condition|)
return|return
operator|(
literal|1
operator|)
return|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_decl_stmt
name|struct
name|fbsd_target_ops
name|the_low_target
init|=
block|{
name|AMD64_NUM_REGS
block|,
name|amd64_regmap
block|,
name|amd64_cannot_fetch_register
block|,
name|amd64_cannot_store_register
block|,
name|amd64_get_pc
block|,
name|amd64_set_pc
block|,
name|amd64_breakpoint
block|,
name|AMD64_BP_LEN
block|,
name|NULL
block|,
literal|1
block|,
name|amd64_breakpoint_at
block|, }
decl_stmt|;
end_decl_stmt

end_unit


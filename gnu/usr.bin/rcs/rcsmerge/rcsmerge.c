begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/* Merge RCS revisions.  */
end_comment

begin_comment
comment|/* Copyright 1982, 1988, 1989 Walter Tichy    Copyright 1990, 1991, 1992, 1993, 1994, 1995 Paul Eggert    Distributed under license by the Free Software Foundation, Inc.  This file is part of RCS.  RCS is free software; you can redistribute it and/or modify it under the terms of the GNU General Public License as published by the Free Software Foundation; either version 2, or (at your option) any later version.  RCS is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License for more details.  You should have received a copy of the GNU General Public License along with RCS; see the file COPYING. If not, write to the Free Software Foundation, 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.  Report problems and direct all questions to:      rcs-bugs@cs.purdue.edu  */
end_comment

begin_comment
comment|/*  * Revision 5.15  1995/06/16 06:19:24  eggert  * Update FSF address.  *  * Revision 5.14  1995/06/01 16:23:43  eggert  * (main): Report an error if -kb, so don't worry about binary stdout.  * Punctuate messages properly.  Rewrite to avoid `goto end'.  *  * Revision 5.13  1994/03/17 14:05:48  eggert  * Specify subprocess input via file descriptor, not file name.  Remove lint.  *  * Revision 5.12  1993/11/09 17:40:15  eggert  * -V now prints version on stdout and exits.  Don't print usage twice.  *  * Revision 5.11  1993/11/03 17:42:27  eggert  * Add -A, -E, -e, -z.  Ignore -T.  Allow up to three file labels.  * Pass -Vn to `co'.  Pass unexpanded revision name to `co', so that Name works.  *  * Revision 5.10  1992/07/28  16:12:44  eggert  * Add -V.  *  * Revision 5.9  1992/01/24  18:44:19  eggert  * lint -> RCS_lint  *  * Revision 5.8  1992/01/06  02:42:34  eggert  * Update usage string.  *  * Revision 5.7  1991/11/20  17:58:09  eggert  * Don't Iopen(f, "r+"); it's not portable.  *  * Revision 5.6  1991/08/19  03:13:55  eggert  * Add -r$.  Tune.  *  * Revision 5.5  1991/04/21  11:58:27  eggert  * Add -x, RCSINIT, MS-DOS support.  *  * Revision 5.4  1991/02/25  07:12:43  eggert  * Merging a revision to itself is no longer an error.  *  * Revision 5.3  1990/11/01  05:03:50  eggert  * Remove unneeded setid check.  *  * Revision 5.2  1990/09/04  08:02:28  eggert  * Check for I/O error when reading working file.  *  * Revision 5.1  1990/08/29  07:14:04  eggert  * Add -q.  Pass -L options to merge.  *  * Revision 5.0  1990/08/22  08:13:41  eggert  * Propagate merge's exit status.  * Remove compile-time limits; use malloc instead.  * Make lock and temp files faster and safer.  Ansify and Posixate.  Add -V.  * Don't use access().  Tune.  *  * Revision 4.5  89/05/01  15:13:16  narten  * changed copyright header to reflect current distribution rules  *  * Revision 4.4  88/08/09  19:13:13  eggert  * Beware merging into a readonly file.  * Beware merging a revision to itself (no change).  * Use execv(), not system(); yield exit status like diff(1)'s.  *  * Revision 4.3  87/10/18  10:38:02  narten  * Updating version numbers. Changes relative to version 1.1  * actually relative to 4.1  *  * Revision 1.3  87/09/24  14:00:31  narten  * Sources now pass through lint (if you ignore printf/sprintf/fprintf  * warnings)  *  * Revision 1.2  87/03/27  14:22:36  jenkins  * Port to suns  *  * Revision 4.1  83/03/28  11:14:57  wft  * Added handling of default branch.  *  * Revision 3.3  82/12/24  15:29:00  wft  * Added call to catchsig().  *  * Revision 3.2  82/12/10  21:32:02  wft  * Replaced getdelta() with gettree(); improved error messages.  *  * Revision 3.1  82/11/28  19:27:44  wft  * Initial revision.  *  */
end_comment

begin_include
include|#
directive|include
file|"rcsbase.h"
end_include

begin_decl_stmt
specifier|static
name|char
specifier|const
name|co
index|[]
init|=
name|CO
decl_stmt|;
end_decl_stmt

begin_macro
name|mainProg
argument_list|(
argument|rcsmergeId
argument_list|,
literal|"rcsmerge"
argument_list|,
literal|"$FreeBSD$"
argument_list|)
end_macro

begin_block
block|{
specifier|static
name|char
specifier|const
name|cmdusage
index|[]
init|=
literal|"\nrcsmerge usage: rcsmerge -rrev1 [-rrev2] -ksubst -{pq}[rev] -Vn -xsuff -zzone file"
decl_stmt|;
specifier|static
name|char
specifier|const
name|quietarg
index|[]
init|=
literal|"-q"
decl_stmt|;
specifier|register
name|int
name|i
decl_stmt|;
name|char
modifier|*
name|a
decl_stmt|,
modifier|*
modifier|*
name|newargv
decl_stmt|;
name|char
specifier|const
modifier|*
name|arg
index|[
literal|3
index|]
decl_stmt|;
name|char
specifier|const
modifier|*
name|rev
index|[
literal|3
index|]
decl_stmt|,
modifier|*
name|xrev
index|[
literal|3
index|]
decl_stmt|;
comment|/*revision numbers*/
name|char
specifier|const
modifier|*
name|edarg
decl_stmt|,
modifier|*
name|expandarg
decl_stmt|,
modifier|*
name|suffixarg
decl_stmt|,
modifier|*
name|versionarg
decl_stmt|,
modifier|*
name|zonearg
decl_stmt|;
name|int
name|tostdout
decl_stmt|;
name|int
name|status
decl_stmt|;
name|RILE
modifier|*
name|workptr
decl_stmt|;
name|struct
name|buf
name|commarg
decl_stmt|;
name|struct
name|buf
name|numericrev
decl_stmt|;
comment|/* holds expanded revision number */
name|struct
name|hshentries
modifier|*
name|gendeltas
decl_stmt|;
comment|/* deltas to be generated */
name|struct
name|hshentry
modifier|*
name|target
decl_stmt|;
name|bufautobegin
argument_list|(
operator|&
name|commarg
argument_list|)
expr_stmt|;
name|bufautobegin
argument_list|(
operator|&
name|numericrev
argument_list|)
expr_stmt|;
name|edarg
operator|=
name|rev
index|[
literal|1
index|]
operator|=
name|rev
index|[
literal|2
index|]
operator|=
literal|0
expr_stmt|;
name|status
operator|=
literal|0
expr_stmt|;
comment|/* Keep lint happy.  */
name|tostdout
operator|=
name|false
expr_stmt|;
name|expandarg
operator|=
name|suffixarg
operator|=
name|versionarg
operator|=
name|zonearg
operator|=
name|quietarg
expr_stmt|;
comment|/* no-op */
name|suffixes
operator|=
name|X_DEFAULT
expr_stmt|;
name|argc
operator|=
name|getRCSINIT
argument_list|(
name|argc
argument_list|,
name|argv
argument_list|,
operator|&
name|newargv
argument_list|)
expr_stmt|;
name|argv
operator|=
name|newargv
expr_stmt|;
while|while
condition|(
name|a
operator|=
operator|*
operator|++
name|argv
operator|,
literal|0
operator|<
operator|--
name|argc
operator|&&
operator|*
name|a
operator|++
operator|==
literal|'-'
condition|)
block|{
switch|switch
condition|(
operator|*
name|a
operator|++
condition|)
block|{
case|case
literal|'p'
case|:
name|tostdout
operator|=
name|true
expr_stmt|;
goto|goto
name|revno
goto|;
case|case
literal|'q'
case|:
name|quietflag
operator|=
name|true
expr_stmt|;
name|revno
label|:
if|if
condition|(
operator|!
operator|*
name|a
condition|)
break|break;
comment|/* falls into -r */
case|case
literal|'r'
case|:
if|if
condition|(
operator|!
name|rev
index|[
literal|1
index|]
condition|)
name|rev
index|[
literal|1
index|]
operator|=
name|a
expr_stmt|;
elseif|else
if|if
condition|(
operator|!
name|rev
index|[
literal|2
index|]
condition|)
name|rev
index|[
literal|2
index|]
operator|=
name|a
expr_stmt|;
else|else
name|error
argument_list|(
literal|"too many revision numbers"
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'A'
case|:
case|case
literal|'E'
case|:
case|case
literal|'e'
case|:
if|if
condition|(
operator|*
name|a
condition|)
goto|goto
name|unknown
goto|;
name|edarg
operator|=
operator|*
name|argv
expr_stmt|;
break|break;
case|case
literal|'x'
case|:
name|suffixarg
operator|=
operator|*
name|argv
expr_stmt|;
name|suffixes
operator|=
name|a
expr_stmt|;
break|break;
case|case
literal|'z'
case|:
name|zonearg
operator|=
operator|*
name|argv
expr_stmt|;
name|zone_set
argument_list|(
name|a
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'T'
case|:
comment|/* Ignore -T, so that RCSINIT can contain -T.  */
if|if
condition|(
operator|*
name|a
condition|)
goto|goto
name|unknown
goto|;
break|break;
case|case
literal|'V'
case|:
name|versionarg
operator|=
operator|*
name|argv
expr_stmt|;
name|setRCSversion
argument_list|(
name|versionarg
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'k'
case|:
name|expandarg
operator|=
operator|*
name|argv
expr_stmt|;
if|if
condition|(
literal|0
operator|<=
name|str2expmode
argument_list|(
name|expandarg
operator|+
literal|2
argument_list|)
condition|)
break|break;
comment|/* fall into */
default|default:
name|unknown
label|:
name|error
argument_list|(
literal|"unknown option: %s%s"
argument_list|,
operator|*
name|argv
argument_list|,
name|cmdusage
argument_list|)
expr_stmt|;
block|}
empty_stmt|;
block|}
comment|/* end of option processing */
if|if
condition|(
operator|!
name|rev
index|[
literal|1
index|]
condition|)
name|faterror
argument_list|(
literal|"no base revision number given"
argument_list|)
expr_stmt|;
comment|/* Now handle all pathnames.  */
if|if
condition|(
operator|!
name|nerror
condition|)
block|{
if|if
condition|(
name|argc
operator|<
literal|1
condition|)
name|faterror
argument_list|(
literal|"no input file%s"
argument_list|,
name|cmdusage
argument_list|)
expr_stmt|;
if|if
condition|(
literal|0
operator|<
name|pairnames
argument_list|(
name|argc
argument_list|,
name|argv
argument_list|,
name|rcsreadopen
argument_list|,
name|true
argument_list|,
name|false
argument_list|)
condition|)
block|{
if|if
condition|(
name|argc
operator|>
literal|2
operator|||
operator|(
name|argc
operator|==
literal|2
operator|&&
name|argv
index|[
literal|1
index|]
operator|)
condition|)
name|warn
argument_list|(
literal|"excess arguments ignored"
argument_list|)
expr_stmt|;
if|if
condition|(
name|Expand
operator|==
name|BINARY_EXPAND
condition|)
name|workerror
argument_list|(
literal|"merging binary files"
argument_list|)
expr_stmt|;
name|diagnose
argument_list|(
literal|"RCS file: %s\n"
argument_list|,
name|RCSname
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|workptr
operator|=
name|Iopen
argument_list|(
name|workname
argument_list|,
name|FOPEN_R_WORK
argument_list|,
operator|(
expr|struct
name|stat
operator|*
operator|)
literal|0
argument_list|)
operator|)
condition|)
name|efaterror
argument_list|(
name|workname
argument_list|)
expr_stmt|;
name|gettree
argument_list|()
expr_stmt|;
comment|/* reads in the delta tree */
if|if
condition|(
operator|!
name|Head
condition|)
name|rcsfaterror
argument_list|(
literal|"no revisions present"
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
operator|*
name|rev
index|[
literal|1
index|]
condition|)
name|rev
index|[
literal|1
index|]
operator|=
name|Dbranch
condition|?
name|Dbranch
else|:
name|Head
operator|->
name|num
expr_stmt|;
if|if
condition|(
name|fexpandsym
argument_list|(
name|rev
index|[
literal|1
index|]
argument_list|,
operator|&
name|numericrev
argument_list|,
name|workptr
argument_list|)
operator|&&
operator|(
name|target
operator|=
name|genrevs
argument_list|(
name|numericrev
operator|.
name|string
argument_list|,
operator|(
name|char
operator|*
operator|)
literal|0
argument_list|,
operator|(
name|char
operator|*
operator|)
literal|0
argument_list|,
operator|(
name|char
operator|*
operator|)
literal|0
argument_list|,
operator|&
name|gendeltas
argument_list|)
operator|)
condition|)
block|{
name|xrev
index|[
literal|1
index|]
operator|=
name|target
operator|->
name|num
expr_stmt|;
if|if
condition|(
operator|!
name|rev
index|[
literal|2
index|]
operator|||
operator|!
operator|*
name|rev
index|[
literal|2
index|]
condition|)
name|rev
index|[
literal|2
index|]
operator|=
name|Dbranch
condition|?
name|Dbranch
else|:
name|Head
operator|->
name|num
expr_stmt|;
if|if
condition|(
name|fexpandsym
argument_list|(
name|rev
index|[
literal|2
index|]
argument_list|,
operator|&
name|numericrev
argument_list|,
name|workptr
argument_list|)
operator|&&
operator|(
name|target
operator|=
name|genrevs
argument_list|(
name|numericrev
operator|.
name|string
argument_list|,
operator|(
name|char
operator|*
operator|)
literal|0
argument_list|,
operator|(
name|char
operator|*
operator|)
literal|0
argument_list|,
operator|(
name|char
operator|*
operator|)
literal|0
argument_list|,
operator|&
name|gendeltas
argument_list|)
operator|)
condition|)
block|{
name|xrev
index|[
literal|2
index|]
operator|=
name|target
operator|->
name|num
expr_stmt|;
if|if
condition|(
name|strcmp
argument_list|(
name|xrev
index|[
literal|1
index|]
argument_list|,
name|xrev
index|[
literal|2
index|]
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|tostdout
condition|)
block|{
name|fastcopy
argument_list|(
name|workptr
argument_list|,
name|stdout
argument_list|)
expr_stmt|;
name|Ofclose
argument_list|(
name|stdout
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
name|Izclose
argument_list|(
operator|&
name|workptr
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|1
init|;
name|i
operator|<=
literal|2
condition|;
name|i
operator|++
control|)
block|{
name|diagnose
argument_list|(
literal|"retrieving revision %s\n"
argument_list|,
name|xrev
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|bufscpy
argument_list|(
operator|&
name|commarg
argument_list|,
literal|"-p"
argument_list|)
expr_stmt|;
name|bufscat
argument_list|(
operator|&
name|commarg
argument_list|,
name|rev
index|[
name|i
index|]
argument_list|)
expr_stmt|;
comment|/* not xrev[i], for $Name's sake */
if|if
condition|(
name|run
argument_list|(
operator|-
literal|1
argument_list|,
comment|/* Do not collide with merger.c maketemp().  */
name|arg
index|[
name|i
index|]
operator|=
name|maketemp
argument_list|(
name|i
operator|+
literal|2
argument_list|)
argument_list|,
name|co
argument_list|,
name|quietarg
argument_list|,
name|commarg
operator|.
name|string
argument_list|,
name|expandarg
argument_list|,
name|suffixarg
argument_list|,
name|versionarg
argument_list|,
name|zonearg
argument_list|,
name|RCSname
argument_list|,
operator|(
name|char
operator|*
operator|)
literal|0
argument_list|)
condition|)
name|rcsfaterror
argument_list|(
literal|"co failed"
argument_list|)
expr_stmt|;
block|}
name|diagnose
argument_list|(
literal|"Merging differences between %s and %s into %s%s\n"
argument_list|,
name|xrev
index|[
literal|1
index|]
argument_list|,
name|xrev
index|[
literal|2
index|]
argument_list|,
name|workname
argument_list|,
name|tostdout
condition|?
literal|"; result to stdout"
else|:
literal|""
argument_list|)
expr_stmt|;
name|arg
index|[
literal|0
index|]
operator|=
name|xrev
index|[
literal|0
index|]
operator|=
name|workname
expr_stmt|;
name|status
operator|=
name|merge
argument_list|(
name|tostdout
argument_list|,
name|edarg
argument_list|,
name|xrev
argument_list|,
name|arg
argument_list|)
expr_stmt|;
block|}
block|}
block|}
name|Izclose
argument_list|(
operator|&
name|workptr
argument_list|)
expr_stmt|;
block|}
block|}
name|tempunlink
argument_list|()
expr_stmt|;
name|exitmain
argument_list|(
name|nerror
condition|?
name|DIFF_TROUBLE
else|:
name|status
argument_list|)
expr_stmt|;
block|}
end_block

begin_if
if|#
directive|if
name|RCS_lint
end_if

begin_define
define|#
directive|define
name|exiterr
value|rmergeExit
end_define

begin_endif
endif|#
directive|endif
end_endif

begin_function
name|void
name|exiterr
parameter_list|()
block|{
name|tempunlink
argument_list|()
expr_stmt|;
name|_exit
argument_list|(
name|DIFF_TROUBLE
argument_list|)
expr_stmt|;
block|}
end_function

end_unit


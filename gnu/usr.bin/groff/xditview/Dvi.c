begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_ifndef
ifndef|#
directive|ifndef
name|SABER
end_ifndef

begin_ifndef
ifndef|#
directive|ifndef
name|lint
end_ifndef

begin_decl_stmt
specifier|static
name|char
name|Xrcsid
index|[]
init|=
literal|"$XConsortium: Dvi.c,v 1.9 89/12/10 16:12:25 rws Exp $"
decl_stmt|;
end_decl_stmt

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* lint */
end_comment

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* SABER */
end_comment

begin_comment
comment|/*  * Dvi.c - Dvi display widget  *  */
end_comment

begin_define
define|#
directive|define
name|XtStrlen
parameter_list|(
name|s
parameter_list|)
value|((s) ? strlen(s) : 0)
end_define

begin_comment
comment|/* The following are defined for the reader's convenience.  Any      Xt..Field macro in this code just refers to some field in      one of the substructures of the WidgetRec.  */
end_comment

begin_include
include|#
directive|include
file|<X11/IntrinsicP.h>
end_include

begin_include
include|#
directive|include
file|<X11/StringDefs.h>
end_include

begin_include
include|#
directive|include
file|<X11/Xmu/Converters.h>
end_include

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_include
include|#
directive|include
file|<ctype.h>
end_include

begin_include
include|#
directive|include
file|"DviP.h"
end_include

begin_comment
comment|/****************************************************************  *  * Full class record constant  *  ****************************************************************/
end_comment

begin_comment
comment|/* Private Data */
end_comment

begin_decl_stmt
specifier|static
name|char
name|default_font_map
index|[]
init|=
literal|"\ TR	-adobe-times-medium-r-normal--*-100-*-*-*-*-iso8859-1\n\ TI	-adobe-times-medium-i-normal--*-100-*-*-*-*-iso8859-1\n\ TB	-adobe-times-bold-r-normal--*-100-*-*-*-*-iso8859-1\n\ TBI	-adobe-times-bold-i-normal--*-100-*-*-*-*-iso8859-1\n\ CR	-adobe-courier-medium-r-normal--*-100-*-*-*-*-iso8859-1\n\ CI	-adobe-courier-medium-o-normal--*-100-*-*-*-*-iso8859-1\n\ CB	-adobe-courier-bold-r-normal--*-100-*-*-*-*-iso8859-1\n\ CBI	-adobe-courier-bold-o-normal--*-100-*-*-*-*-iso8859-1\n\ HR	-adobe-helvetica-medium-r-normal--*-100-*-*-*-*-iso8859-1\n\ HI	-adobe-helvetica-medium-o-normal--*-100-*-*-*-*-iso8859-1\n\ HB	-adobe-helvetica-bold-r-normal--*-100-*-*-*-*-iso8859-1\n\ HBI	-adobe-helvetica-bold-o-normal--*-100-*-*-*-*-iso8859-1\n\ NR	-adobe-new century schoolbook-medium-r-normal--*-100-*-*-*-*-iso8859-1\n\ NI	-adobe-new century schoolbook-medium-i-normal--*-100-*-*-*-*-iso8859-1\n\ NB	-adobe-new century schoolbook-bold-r-normal--*-100-*-*-*-*-iso8859-1\n\ NBI	-adobe-new century schoolbook-bold-i-normal--*-100-*-*-*-*-iso8859-1\n\ S	-adobe-symbol-medium-r-normal--*-100-*-*-*-*-adobe-fontspecific\n\ SS	-adobe-symbol-medium-r-normal--*-100-*-*-*-*-adobe-fontspecific\n\ "
decl_stmt|;
end_decl_stmt

begin_define
define|#
directive|define
name|offset
parameter_list|(
name|field
parameter_list|)
value|XtOffset(DviWidget, field)
end_define

begin_define
define|#
directive|define
name|MY_WIDTH
parameter_list|(
name|dw
parameter_list|)
value|((int)(dw->dvi.paperwidth * dw->dvi.scale_factor + .5))
end_define

begin_define
define|#
directive|define
name|MY_HEIGHT
parameter_list|(
name|dw
parameter_list|)
value|((int)(dw->dvi.paperlength * dw->dvi.scale_factor + .5))
end_define

begin_decl_stmt
specifier|static
name|XtResource
name|resources
index|[]
init|=
block|{
block|{
name|XtNfontMap
block|,
name|XtCFontMap
block|,
name|XtRString
block|,
sizeof|sizeof
argument_list|(
name|char
operator|*
argument_list|)
block|,
name|offset
argument_list|(
name|dvi
operator|.
name|font_map_string
argument_list|)
block|,
name|XtRString
block|,
name|default_font_map
block|}
block|,
block|{
name|XtNforeground
block|,
name|XtCForeground
block|,
name|XtRPixel
block|,
expr|sizeof
operator|(
name|unsigned
name|long
operator|)
block|,
name|offset
argument_list|(
name|dvi
operator|.
name|foreground
argument_list|)
block|,
name|XtRString
block|,
literal|"black"
block|}
block|,
block|{
name|XtNbackground
block|,
name|XtCBackground
block|,
name|XtRPixel
block|,
expr|sizeof
operator|(
name|unsigned
name|long
operator|)
block|,
name|offset
argument_list|(
name|dvi
operator|.
name|background
argument_list|)
block|,
name|XtRString
block|,
literal|"white"
block|}
block|,
block|{
name|XtNpageNumber
block|,
name|XtCPageNumber
block|,
name|XtRInt
block|,
sizeof|sizeof
argument_list|(
name|int
argument_list|)
block|,
name|offset
argument_list|(
name|dvi
operator|.
name|requested_page
argument_list|)
block|,
name|XtRString
block|,
literal|"1"
block|}
block|,
block|{
name|XtNlastPageNumber
block|,
name|XtCLastPageNumber
block|,
name|XtRInt
block|,
sizeof|sizeof
argument_list|(
name|int
argument_list|)
block|,
name|offset
argument_list|(
name|dvi
operator|.
name|last_page
argument_list|)
block|,
name|XtRString
block|,
literal|"0"
block|}
block|,
block|{
name|XtNfile
block|,
name|XtCFile
block|,
name|XtRFile
block|,
sizeof|sizeof
argument_list|(
name|FILE
operator|*
argument_list|)
block|,
name|offset
argument_list|(
name|dvi
operator|.
name|file
argument_list|)
block|,
name|XtRFile
block|,
operator|(
name|char
operator|*
operator|)
literal|0
block|}
block|,
block|{
name|XtNseek
block|,
name|XtCSeek
block|,
name|XtRBoolean
block|,
sizeof|sizeof
argument_list|(
name|Boolean
argument_list|)
block|,
name|offset
argument_list|(
name|dvi
operator|.
name|seek
argument_list|)
block|,
name|XtRString
block|,
literal|"false"
block|}
block|,
block|{
name|XtNfont
block|,
name|XtCFont
block|,
name|XtRFontStruct
block|,
sizeof|sizeof
argument_list|(
name|XFontStruct
operator|*
argument_list|)
block|,
name|offset
argument_list|(
name|dvi
operator|.
name|default_font
argument_list|)
block|,
name|XtRString
block|,
literal|"xtdefaultfont"
block|}
block|,
block|{
name|XtNbackingStore
block|,
name|XtCBackingStore
block|,
name|XtRBackingStore
block|,
sizeof|sizeof
argument_list|(
name|int
argument_list|)
block|,
name|offset
argument_list|(
name|dvi
operator|.
name|backing_store
argument_list|)
block|,
name|XtRString
block|,
literal|"default"
block|}
block|,
block|{
name|XtNnoPolyText
block|,
name|XtCNoPolyText
block|,
name|XtRBoolean
block|,
sizeof|sizeof
argument_list|(
name|Boolean
argument_list|)
block|,
name|offset
argument_list|(
name|dvi
operator|.
name|noPolyText
argument_list|)
block|,
name|XtRString
block|,
literal|"false"
block|}
block|,
block|{
name|XtNresolution
block|,
name|XtCResolution
block|,
name|XtRInt
block|,
sizeof|sizeof
argument_list|(
name|int
argument_list|)
block|,
name|offset
argument_list|(
name|dvi
operator|.
name|default_resolution
argument_list|)
block|,
name|XtRString
block|,
literal|"75"
block|}
block|, }
decl_stmt|;
end_decl_stmt

begin_undef
undef|#
directive|undef
name|offset
end_undef

begin_function_decl
specifier|static
name|void
name|ClassInitialize
parameter_list|()
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|ClassPartInitialize
parameter_list|()
function_decl|;
end_function_decl

begin_decl_stmt
specifier|static
name|void
name|Initialize
argument_list|()
decl_stmt|,
name|Realize
argument_list|()
decl_stmt|,
name|Destroy
argument_list|()
decl_stmt|,
name|Redisplay
argument_list|()
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|Boolean
name|SetValues
argument_list|()
decl_stmt|,
name|SetValuesHook
argument_list|()
decl_stmt|;
end_decl_stmt

begin_function_decl
specifier|static
name|XtGeometryResult
name|QueryGeometry
parameter_list|()
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|ShowDvi
parameter_list|()
function_decl|;
end_function_decl

begin_decl_stmt
specifier|static
name|void
name|CloseFile
argument_list|()
decl_stmt|,
name|OpenFile
argument_list|()
decl_stmt|;
end_decl_stmt

begin_function_decl
specifier|static
name|void
name|FindPage
parameter_list|()
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|SaveToFile
parameter_list|()
function_decl|;
end_function_decl

begin_decl_stmt
name|DviClassRec
name|dviClassRec
init|=
block|{
block|{
operator|&
name|widgetClassRec
block|,
comment|/* superclass		  */
literal|"Dvi"
block|,
comment|/* class_name		  */
sizeof|sizeof
argument_list|(
name|DviRec
argument_list|)
block|,
comment|/* size			  */
name|ClassInitialize
block|,
comment|/* class_initialize	  */
name|ClassPartInitialize
block|,
comment|/* class_part_initialize  */
name|FALSE
block|,
comment|/* class_inited		  */
name|Initialize
block|,
comment|/* initialize		  */
name|NULL
block|,
comment|/* initialize_hook	  */
name|Realize
block|,
comment|/* realize		  */
name|NULL
block|,
comment|/* actions		  */
literal|0
block|,
comment|/* num_actions		  */
name|resources
block|,
comment|/* resources		  */
name|XtNumber
argument_list|(
name|resources
argument_list|)
block|,
comment|/* resource_count	  */
name|NULLQUARK
block|,
comment|/* xrm_class		  */
name|FALSE
block|,
comment|/* compress_motion	  */
name|TRUE
block|,
comment|/* compress_exposure	  */
name|TRUE
block|,
comment|/* compress_enterleave    */
name|FALSE
block|,
comment|/* visible_interest	  */
name|Destroy
block|,
comment|/* destroy		  */
name|NULL
block|,
comment|/* resize		  */
name|Redisplay
block|,
comment|/* expose		  */
name|SetValues
block|,
comment|/* set_values		  */
name|SetValuesHook
block|,
comment|/* set_values_hook	  */
name|NULL
block|,
comment|/* set_values_almost	  */
name|NULL
block|,
comment|/* get_values_hook	  */
name|NULL
block|,
comment|/* accept_focus		  */
name|XtVersion
block|,
comment|/* version		  */
name|NULL
block|,
comment|/* callback_private	  */
literal|0
block|,
comment|/* tm_table		  */
name|QueryGeometry
block|,
comment|/* query_geometry	  */
name|NULL
block|,
comment|/* display_accelerator	  */
name|NULL
comment|/* extension		  */
block|}
block|,
block|{
name|SaveToFile
block|,
comment|/* save    */
block|}
block|, }
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|WidgetClass
name|dviWidgetClass
init|=
operator|(
name|WidgetClass
operator|)
operator|&
name|dviClassRec
decl_stmt|;
end_decl_stmt

begin_function
specifier|static
name|void
name|ClassInitialize
parameter_list|()
block|{
name|XtAddConverter
argument_list|(
name|XtRString
argument_list|,
name|XtRBackingStore
argument_list|,
name|XmuCvtStringToBackingStore
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/****************************************************************  *  * Private Procedures  *  ****************************************************************/
end_comment

begin_comment
comment|/* ARGSUSED */
end_comment

begin_function
specifier|static
name|void
name|Initialize
parameter_list|(
name|request
parameter_list|,
name|new
parameter_list|)
name|Widget
name|request
decl_stmt|,
name|new
decl_stmt|;
block|{
name|DviWidget
name|dw
init|=
operator|(
name|DviWidget
operator|)
name|new
decl_stmt|;
name|dw
operator|->
name|dvi
operator|.
name|current_page
operator|=
literal|0
expr_stmt|;
name|dw
operator|->
name|dvi
operator|.
name|font_map
operator|=
literal|0
expr_stmt|;
name|dw
operator|->
name|dvi
operator|.
name|cache
operator|.
name|index
operator|=
literal|0
expr_stmt|;
name|dw
operator|->
name|dvi
operator|.
name|text_x_width
operator|=
literal|0
expr_stmt|;
name|dw
operator|->
name|dvi
operator|.
name|text_device_width
operator|=
literal|0
expr_stmt|;
name|dw
operator|->
name|dvi
operator|.
name|word_flag
operator|=
literal|0
expr_stmt|;
name|dw
operator|->
name|dvi
operator|.
name|file
operator|=
literal|0
expr_stmt|;
name|dw
operator|->
name|dvi
operator|.
name|tmpFile
operator|=
literal|0
expr_stmt|;
name|dw
operator|->
name|dvi
operator|.
name|state
operator|=
literal|0
expr_stmt|;
name|dw
operator|->
name|dvi
operator|.
name|readingTmp
operator|=
literal|0
expr_stmt|;
name|dw
operator|->
name|dvi
operator|.
name|cache
operator|.
name|char_index
operator|=
literal|0
expr_stmt|;
name|dw
operator|->
name|dvi
operator|.
name|cache
operator|.
name|font_size
operator|=
operator|-
literal|1
expr_stmt|;
name|dw
operator|->
name|dvi
operator|.
name|cache
operator|.
name|font_number
operator|=
operator|-
literal|1
expr_stmt|;
name|dw
operator|->
name|dvi
operator|.
name|cache
operator|.
name|adjustable
index|[
literal|0
index|]
operator|=
literal|0
expr_stmt|;
name|dw
operator|->
name|dvi
operator|.
name|file_map
operator|=
literal|0
expr_stmt|;
name|dw
operator|->
name|dvi
operator|.
name|fonts
operator|=
literal|0
expr_stmt|;
name|dw
operator|->
name|dvi
operator|.
name|seek
operator|=
name|False
expr_stmt|;
name|dw
operator|->
name|dvi
operator|.
name|device_resolution
operator|=
name|dw
operator|->
name|dvi
operator|.
name|default_resolution
expr_stmt|;
name|dw
operator|->
name|dvi
operator|.
name|display_resolution
operator|=
name|dw
operator|->
name|dvi
operator|.
name|default_resolution
expr_stmt|;
name|dw
operator|->
name|dvi
operator|.
name|paperlength
operator|=
name|dw
operator|->
name|dvi
operator|.
name|default_resolution
operator|*
literal|11
expr_stmt|;
name|dw
operator|->
name|dvi
operator|.
name|paperwidth
operator|=
operator|(
name|dw
operator|->
name|dvi
operator|.
name|default_resolution
operator|*
literal|8
operator|+
name|dw
operator|->
name|dvi
operator|.
name|default_resolution
operator|/
literal|2
operator|)
expr_stmt|;
name|dw
operator|->
name|dvi
operator|.
name|scale_factor
operator|=
literal|1.0
expr_stmt|;
name|dw
operator|->
name|dvi
operator|.
name|sizescale
operator|=
literal|1
expr_stmt|;
name|dw
operator|->
name|dvi
operator|.
name|line_thickness
operator|=
operator|-
literal|1
expr_stmt|;
name|dw
operator|->
name|dvi
operator|.
name|line_width
operator|=
literal|1
expr_stmt|;
name|dw
operator|->
name|dvi
operator|.
name|fill
operator|=
name|DVI_FILL_MAX
expr_stmt|;
name|dw
operator|->
name|dvi
operator|.
name|device_font
operator|=
literal|0
expr_stmt|;
name|dw
operator|->
name|dvi
operator|.
name|device_font_number
operator|=
operator|-
literal|1
expr_stmt|;
name|dw
operator|->
name|dvi
operator|.
name|device
operator|=
literal|0
expr_stmt|;
name|dw
operator|->
name|dvi
operator|.
name|native
operator|=
literal|0
expr_stmt|;
block|}
end_function

begin_include
include|#
directive|include
file|<X11/bitmaps/gray>
end_include

begin_function
specifier|static
name|void
name|Realize
parameter_list|(
name|w
parameter_list|,
name|valueMask
parameter_list|,
name|attrs
parameter_list|)
name|Widget
name|w
decl_stmt|;
name|XtValueMask
modifier|*
name|valueMask
decl_stmt|;
name|XSetWindowAttributes
modifier|*
name|attrs
decl_stmt|;
block|{
name|DviWidget
name|dw
init|=
operator|(
name|DviWidget
operator|)
name|w
decl_stmt|;
name|XGCValues
name|values
decl_stmt|;
if|if
condition|(
name|dw
operator|->
name|dvi
operator|.
name|backing_store
operator|!=
name|Always
operator|+
name|WhenMapped
operator|+
name|NotUseful
condition|)
block|{
name|attrs
operator|->
name|backing_store
operator|=
name|dw
operator|->
name|dvi
operator|.
name|backing_store
expr_stmt|;
operator|*
name|valueMask
operator||=
name|CWBackingStore
expr_stmt|;
block|}
name|XtCreateWindow
argument_list|(
name|w
argument_list|,
operator|(
name|unsigned
operator|)
name|InputOutput
argument_list|,
operator|(
name|Visual
operator|*
operator|)
name|CopyFromParent
argument_list|,
operator|*
name|valueMask
argument_list|,
name|attrs
argument_list|)
expr_stmt|;
name|values
operator|.
name|foreground
operator|=
name|dw
operator|->
name|dvi
operator|.
name|foreground
expr_stmt|;
name|values
operator|.
name|cap_style
operator|=
name|CapRound
expr_stmt|;
name|values
operator|.
name|join_style
operator|=
name|JoinRound
expr_stmt|;
name|values
operator|.
name|line_width
operator|=
name|dw
operator|->
name|dvi
operator|.
name|line_width
expr_stmt|;
name|dw
operator|->
name|dvi
operator|.
name|normal_GC
operator|=
name|XCreateGC
argument_list|(
name|XtDisplay
argument_list|(
name|w
argument_list|)
argument_list|,
name|XtWindow
argument_list|(
name|w
argument_list|)
argument_list|,
name|GCForeground
operator||
name|GCCapStyle
operator||
name|GCJoinStyle
operator||
name|GCLineWidth
argument_list|,
operator|&
name|values
argument_list|)
expr_stmt|;
name|dw
operator|->
name|dvi
operator|.
name|gray
operator|=
name|XCreateBitmapFromData
argument_list|(
name|XtDisplay
argument_list|(
name|w
argument_list|)
argument_list|,
name|XtWindow
argument_list|(
name|w
argument_list|)
argument_list|,
name|gray_bits
argument_list|,
name|gray_width
argument_list|,
name|gray_height
argument_list|)
expr_stmt|;
name|values
operator|.
name|background
operator|=
name|dw
operator|->
name|dvi
operator|.
name|background
expr_stmt|;
name|values
operator|.
name|stipple
operator|=
name|dw
operator|->
name|dvi
operator|.
name|gray
expr_stmt|;
name|dw
operator|->
name|dvi
operator|.
name|fill_GC
operator|=
name|XCreateGC
argument_list|(
name|XtDisplay
argument_list|(
name|w
argument_list|)
argument_list|,
name|XtWindow
argument_list|(
name|w
argument_list|)
argument_list|,
name|GCForeground
operator||
name|GCBackground
operator||
name|GCStipple
argument_list|,
operator|&
name|values
argument_list|)
expr_stmt|;
name|dw
operator|->
name|dvi
operator|.
name|fill_type
operator|=
name|DVI_FILL_BLACK
expr_stmt|;
if|if
condition|(
name|dw
operator|->
name|dvi
operator|.
name|file
condition|)
name|OpenFile
argument_list|(
name|dw
argument_list|)
expr_stmt|;
name|ParseFontMap
argument_list|(
name|dw
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|Destroy
parameter_list|(
name|w
parameter_list|)
name|Widget
name|w
decl_stmt|;
block|{
name|DviWidget
name|dw
init|=
operator|(
name|DviWidget
operator|)
name|w
decl_stmt|;
name|XFreeGC
argument_list|(
name|XtDisplay
argument_list|(
name|w
argument_list|)
argument_list|,
name|dw
operator|->
name|dvi
operator|.
name|normal_GC
argument_list|)
expr_stmt|;
name|XFreeGC
argument_list|(
name|XtDisplay
argument_list|(
name|w
argument_list|)
argument_list|,
name|dw
operator|->
name|dvi
operator|.
name|fill_GC
argument_list|)
expr_stmt|;
name|XFreePixmap
argument_list|(
name|XtDisplay
argument_list|(
name|w
argument_list|)
argument_list|,
name|dw
operator|->
name|dvi
operator|.
name|gray
argument_list|)
expr_stmt|;
name|DestroyFontMap
argument_list|(
name|dw
operator|->
name|dvi
operator|.
name|font_map
argument_list|)
expr_stmt|;
name|DestroyFileMap
argument_list|(
name|dw
operator|->
name|dvi
operator|.
name|file_map
argument_list|)
expr_stmt|;
name|device_destroy
argument_list|(
name|dw
operator|->
name|dvi
operator|.
name|device
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * Repaint the widget window  */
end_comment

begin_comment
comment|/* ARGSUSED */
end_comment

begin_function
specifier|static
name|void
name|Redisplay
parameter_list|(
name|w
parameter_list|,
name|event
parameter_list|,
name|region
parameter_list|)
name|Widget
name|w
decl_stmt|;
name|XEvent
modifier|*
name|event
decl_stmt|;
name|Region
name|region
decl_stmt|;
block|{
name|DviWidget
name|dw
init|=
operator|(
name|DviWidget
operator|)
name|w
decl_stmt|;
name|XRectangle
name|extents
decl_stmt|;
name|XClipBox
argument_list|(
name|region
argument_list|,
operator|&
name|extents
argument_list|)
expr_stmt|;
name|dw
operator|->
name|dvi
operator|.
name|extents
operator|.
name|x1
operator|=
name|extents
operator|.
name|x
expr_stmt|;
name|dw
operator|->
name|dvi
operator|.
name|extents
operator|.
name|y1
operator|=
name|extents
operator|.
name|y
expr_stmt|;
name|dw
operator|->
name|dvi
operator|.
name|extents
operator|.
name|x2
operator|=
name|extents
operator|.
name|x
operator|+
name|extents
operator|.
name|width
expr_stmt|;
name|dw
operator|->
name|dvi
operator|.
name|extents
operator|.
name|y2
operator|=
name|extents
operator|.
name|y
operator|+
name|extents
operator|.
name|height
expr_stmt|;
name|ShowDvi
argument_list|(
name|dw
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * Set specified arguments into widget  */
end_comment

begin_comment
comment|/* ARGSUSED */
end_comment

begin_function
specifier|static
name|Boolean
name|SetValues
parameter_list|(
name|current
parameter_list|,
name|request
parameter_list|,
name|new
parameter_list|)
name|DviWidget
name|current
decl_stmt|,
name|request
decl_stmt|,
name|new
decl_stmt|;
block|{
name|Boolean
name|redisplay
init|=
name|FALSE
decl_stmt|;
name|char
modifier|*
name|new_map
decl_stmt|;
name|int
name|cur
decl_stmt|,
name|req
decl_stmt|;
if|if
condition|(
name|current
operator|->
name|dvi
operator|.
name|font_map_string
operator|!=
name|request
operator|->
name|dvi
operator|.
name|font_map_string
condition|)
block|{
name|new_map
operator|=
name|XtMalloc
argument_list|(
name|strlen
argument_list|(
name|request
operator|->
name|dvi
operator|.
name|font_map_string
argument_list|)
operator|+
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|new_map
condition|)
block|{
name|redisplay
operator|=
name|TRUE
expr_stmt|;
name|strcpy
argument_list|(
name|new_map
argument_list|,
name|request
operator|->
name|dvi
operator|.
name|font_map_string
argument_list|)
expr_stmt|;
name|new
operator|->
name|dvi
operator|.
name|font_map_string
operator|=
name|new_map
expr_stmt|;
if|if
condition|(
name|current
operator|->
name|dvi
operator|.
name|font_map_string
condition|)
name|XtFree
argument_list|(
name|current
operator|->
name|dvi
operator|.
name|font_map_string
argument_list|)
expr_stmt|;
name|current
operator|->
name|dvi
operator|.
name|font_map_string
operator|=
literal|0
expr_stmt|;
name|ParseFontMap
argument_list|(
name|new
argument_list|)
expr_stmt|;
block|}
block|}
name|req
operator|=
name|request
operator|->
name|dvi
operator|.
name|requested_page
expr_stmt|;
name|cur
operator|=
name|current
operator|->
name|dvi
operator|.
name|requested_page
expr_stmt|;
if|if
condition|(
name|cur
operator|!=
name|req
condition|)
block|{
if|if
condition|(
operator|!
name|request
operator|->
name|dvi
operator|.
name|file
condition|)
name|req
operator|=
literal|0
expr_stmt|;
else|else
block|{
if|if
condition|(
name|req
operator|<
literal|1
condition|)
name|req
operator|=
literal|1
expr_stmt|;
if|if
condition|(
name|current
operator|->
name|dvi
operator|.
name|last_page
operator|!=
literal|0
operator|&&
name|req
operator|>
name|current
operator|->
name|dvi
operator|.
name|last_page
condition|)
name|req
operator|=
name|current
operator|->
name|dvi
operator|.
name|last_page
expr_stmt|;
block|}
if|if
condition|(
name|cur
operator|!=
name|req
condition|)
name|redisplay
operator|=
name|TRUE
expr_stmt|;
name|new
operator|->
name|dvi
operator|.
name|requested_page
operator|=
name|req
expr_stmt|;
if|if
condition|(
name|current
operator|->
name|dvi
operator|.
name|last_page
operator|==
literal|0
operator|&&
name|req
operator|>
name|cur
condition|)
name|FindPage
argument_list|(
name|new
argument_list|)
expr_stmt|;
block|}
return|return
name|redisplay
return|;
block|}
end_function

begin_comment
comment|/*  * use the set_values_hook entry to check when  * the file is set  */
end_comment

begin_function
specifier|static
name|Boolean
name|SetValuesHook
parameter_list|(
name|dw
parameter_list|,
name|args
parameter_list|,
name|num_argsp
parameter_list|)
name|DviWidget
name|dw
decl_stmt|;
name|ArgList
name|args
decl_stmt|;
name|Cardinal
modifier|*
name|num_argsp
decl_stmt|;
block|{
name|Cardinal
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
operator|*
name|num_argsp
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
operator|!
name|strcmp
argument_list|(
name|args
index|[
name|i
index|]
operator|.
name|name
argument_list|,
name|XtNfile
argument_list|)
condition|)
block|{
name|CloseFile
argument_list|(
name|dw
argument_list|)
expr_stmt|;
name|OpenFile
argument_list|(
name|dw
argument_list|)
expr_stmt|;
return|return
name|TRUE
return|;
block|}
block|}
return|return
name|FALSE
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|CloseFile
parameter_list|(
name|dw
parameter_list|)
name|DviWidget
name|dw
decl_stmt|;
block|{
if|if
condition|(
name|dw
operator|->
name|dvi
operator|.
name|tmpFile
condition|)
name|fclose
argument_list|(
name|dw
operator|->
name|dvi
operator|.
name|tmpFile
argument_list|)
expr_stmt|;
name|ForgetPagePositions
argument_list|(
name|dw
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|OpenFile
parameter_list|(
name|dw
parameter_list|)
name|DviWidget
name|dw
decl_stmt|;
block|{
name|char
name|tmpName
index|[
sizeof|sizeof
argument_list|(
literal|"/tmp/dviXXXXXX"
argument_list|)
index|]
decl_stmt|;
name|dw
operator|->
name|dvi
operator|.
name|tmpFile
operator|=
literal|0
expr_stmt|;
if|if
condition|(
operator|!
name|dw
operator|->
name|dvi
operator|.
name|seek
condition|)
block|{
name|strcpy
argument_list|(
name|tmpName
argument_list|,
literal|"/tmp/dviXXXXXX"
argument_list|)
expr_stmt|;
name|mktemp
argument_list|(
name|tmpName
argument_list|)
expr_stmt|;
name|dw
operator|->
name|dvi
operator|.
name|tmpFile
operator|=
name|fopen
argument_list|(
name|tmpName
argument_list|,
literal|"w+"
argument_list|)
expr_stmt|;
name|unlink
argument_list|(
name|tmpName
argument_list|)
expr_stmt|;
block|}
name|dw
operator|->
name|dvi
operator|.
name|requested_page
operator|=
literal|1
expr_stmt|;
name|dw
operator|->
name|dvi
operator|.
name|last_page
operator|=
literal|0
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|XtGeometryResult
name|QueryGeometry
parameter_list|(
name|w
parameter_list|,
name|request
parameter_list|,
name|geometry_return
parameter_list|)
name|Widget
name|w
decl_stmt|;
name|XtWidgetGeometry
modifier|*
name|request
decl_stmt|,
decl|*
name|geometry_return
decl_stmt|;
end_function

begin_block
block|{
name|XtGeometryResult
name|ret
decl_stmt|;
name|DviWidget
name|dw
init|=
operator|(
name|DviWidget
operator|)
name|w
decl_stmt|;
name|ret
operator|=
name|XtGeometryYes
expr_stmt|;
if|if
condition|(
operator|(
operator|(
name|request
operator|->
name|request_mode
operator|&
name|CWWidth
operator|)
operator|&&
name|request
operator|->
name|width
operator|<
name|MY_WIDTH
argument_list|(
name|dw
argument_list|)
operator|)
operator|||
operator|(
operator|(
name|request
operator|->
name|request_mode
operator|&
name|CWHeight
operator|)
operator|&&
name|request
operator|->
name|height
operator|<
name|MY_HEIGHT
argument_list|(
name|dw
argument_list|)
operator|)
condition|)
name|ret
operator|=
name|XtGeometryAlmost
expr_stmt|;
name|geometry_return
operator|->
name|width
operator|=
name|MY_WIDTH
argument_list|(
name|dw
argument_list|)
expr_stmt|;
name|geometry_return
operator|->
name|height
operator|=
name|MY_HEIGHT
argument_list|(
name|dw
argument_list|)
expr_stmt|;
name|geometry_return
operator|->
name|request_mode
operator|=
name|CWWidth
operator||
name|CWHeight
expr_stmt|;
return|return
name|ret
return|;
block|}
end_block

begin_macro
name|SetDevice
argument_list|(
argument|dw
argument_list|,
argument|name
argument_list|)
end_macro

begin_decl_stmt
name|DviWidget
name|dw
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|char
modifier|*
name|name
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|XtWidgetGeometry
name|request
decl_stmt|,
name|reply
decl_stmt|;
name|XtGeometryResult
name|ret
decl_stmt|;
name|ForgetFonts
argument_list|(
name|dw
argument_list|)
expr_stmt|;
name|dw
operator|->
name|dvi
operator|.
name|device
operator|=
name|device_load
argument_list|(
name|name
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|dw
operator|->
name|dvi
operator|.
name|device
condition|)
return|return;
name|dw
operator|->
name|dvi
operator|.
name|sizescale
operator|=
name|dw
operator|->
name|dvi
operator|.
name|device
operator|->
name|sizescale
expr_stmt|;
name|dw
operator|->
name|dvi
operator|.
name|device_resolution
operator|=
name|dw
operator|->
name|dvi
operator|.
name|device
operator|->
name|res
expr_stmt|;
name|dw
operator|->
name|dvi
operator|.
name|native
operator|=
name|dw
operator|->
name|dvi
operator|.
name|device
operator|->
name|X11
expr_stmt|;
name|dw
operator|->
name|dvi
operator|.
name|paperlength
operator|=
name|dw
operator|->
name|dvi
operator|.
name|device
operator|->
name|paperlength
expr_stmt|;
name|dw
operator|->
name|dvi
operator|.
name|paperwidth
operator|=
name|dw
operator|->
name|dvi
operator|.
name|device
operator|->
name|paperwidth
expr_stmt|;
if|if
condition|(
name|dw
operator|->
name|dvi
operator|.
name|native
condition|)
block|{
name|dw
operator|->
name|dvi
operator|.
name|display_resolution
operator|=
name|dw
operator|->
name|dvi
operator|.
name|device_resolution
expr_stmt|;
name|dw
operator|->
name|dvi
operator|.
name|scale_factor
operator|=
literal|1.0
expr_stmt|;
block|}
else|else
block|{
name|dw
operator|->
name|dvi
operator|.
name|display_resolution
operator|=
name|dw
operator|->
name|dvi
operator|.
name|default_resolution
expr_stmt|;
name|dw
operator|->
name|dvi
operator|.
name|scale_factor
operator|=
operator|(
operator|(
name|double
operator|)
name|dw
operator|->
name|dvi
operator|.
name|display_resolution
operator|/
name|dw
operator|->
name|dvi
operator|.
name|device_resolution
operator|)
expr_stmt|;
block|}
name|request
operator|.
name|request_mode
operator|=
name|CWWidth
operator||
name|CWHeight
expr_stmt|;
name|request
operator|.
name|width
operator|=
name|MY_WIDTH
argument_list|(
name|dw
argument_list|)
expr_stmt|;
name|request
operator|.
name|height
operator|=
name|MY_HEIGHT
argument_list|(
name|dw
argument_list|)
expr_stmt|;
name|ret
operator|=
name|XtMakeGeometryRequest
argument_list|(
operator|(
name|Widget
operator|)
name|dw
argument_list|,
operator|&
name|request
argument_list|,
operator|&
name|reply
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|==
name|XtGeometryAlmost
operator|&&
name|reply
operator|.
name|height
operator|>=
name|request
operator|.
name|height
operator|&&
name|reply
operator|.
name|width
operator|>=
name|request
operator|.
name|width
condition|)
block|{
name|request
operator|.
name|width
operator|=
name|reply
operator|.
name|width
expr_stmt|;
name|request
operator|.
name|height
operator|=
name|reply
operator|.
name|height
expr_stmt|;
name|XtMakeGeometryRequest
argument_list|(
operator|(
name|Widget
operator|)
name|dw
argument_list|,
operator|&
name|request
argument_list|,
operator|&
name|reply
argument_list|)
expr_stmt|;
block|}
block|}
end_block

begin_function
specifier|static
name|void
name|ShowDvi
parameter_list|(
name|dw
parameter_list|)
name|DviWidget
name|dw
decl_stmt|;
block|{
if|if
condition|(
operator|!
name|dw
operator|->
name|dvi
operator|.
name|file
condition|)
block|{
specifier|static
name|char
name|Error
index|[]
init|=
literal|"No file selected"
decl_stmt|;
name|XSetFont
argument_list|(
name|XtDisplay
argument_list|(
name|dw
argument_list|)
argument_list|,
name|dw
operator|->
name|dvi
operator|.
name|normal_GC
argument_list|,
name|dw
operator|->
name|dvi
operator|.
name|default_font
operator|->
name|fid
argument_list|)
expr_stmt|;
name|XDrawString
argument_list|(
name|XtDisplay
argument_list|(
name|dw
argument_list|)
argument_list|,
name|XtWindow
argument_list|(
name|dw
argument_list|)
argument_list|,
name|dw
operator|->
name|dvi
operator|.
name|normal_GC
argument_list|,
literal|20
argument_list|,
literal|20
argument_list|,
name|Error
argument_list|,
name|strlen
argument_list|(
name|Error
argument_list|)
argument_list|)
expr_stmt|;
return|return;
block|}
name|FindPage
argument_list|(
name|dw
argument_list|)
expr_stmt|;
name|dw
operator|->
name|dvi
operator|.
name|display_enable
operator|=
literal|1
expr_stmt|;
name|ParseInput
argument_list|(
name|dw
argument_list|)
expr_stmt|;
if|if
condition|(
name|dw
operator|->
name|dvi
operator|.
name|last_page
operator|&&
name|dw
operator|->
name|dvi
operator|.
name|requested_page
operator|>
name|dw
operator|->
name|dvi
operator|.
name|last_page
condition|)
name|dw
operator|->
name|dvi
operator|.
name|requested_page
operator|=
name|dw
operator|->
name|dvi
operator|.
name|last_page
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|FindPage
parameter_list|(
name|dw
parameter_list|)
name|DviWidget
name|dw
decl_stmt|;
block|{
name|int
name|i
decl_stmt|;
name|long
name|file_position
decl_stmt|;
if|if
condition|(
name|dw
operator|->
name|dvi
operator|.
name|requested_page
operator|<
literal|1
condition|)
name|dw
operator|->
name|dvi
operator|.
name|requested_page
operator|=
literal|1
expr_stmt|;
if|if
condition|(
name|dw
operator|->
name|dvi
operator|.
name|last_page
operator|!=
literal|0
operator|&&
name|dw
operator|->
name|dvi
operator|.
name|requested_page
operator|>
name|dw
operator|->
name|dvi
operator|.
name|last_page
condition|)
name|dw
operator|->
name|dvi
operator|.
name|requested_page
operator|=
name|dw
operator|->
name|dvi
operator|.
name|last_page
expr_stmt|;
name|file_position
operator|=
name|SearchPagePosition
argument_list|(
name|dw
argument_list|,
name|dw
operator|->
name|dvi
operator|.
name|requested_page
argument_list|)
expr_stmt|;
if|if
condition|(
name|file_position
operator|!=
operator|-
literal|1
condition|)
block|{
name|FileSeek
argument_list|(
name|dw
argument_list|,
name|file_position
argument_list|)
expr_stmt|;
name|dw
operator|->
name|dvi
operator|.
name|current_page
operator|=
name|dw
operator|->
name|dvi
operator|.
name|requested_page
expr_stmt|;
block|}
else|else
block|{
for|for
control|(
name|i
operator|=
name|dw
operator|->
name|dvi
operator|.
name|requested_page
init|;
name|i
operator|>
literal|0
condition|;
name|i
operator|--
control|)
block|{
name|file_position
operator|=
name|SearchPagePosition
argument_list|(
name|dw
argument_list|,
name|i
argument_list|)
expr_stmt|;
if|if
condition|(
name|file_position
operator|!=
operator|-
literal|1
condition|)
break|break;
block|}
if|if
condition|(
name|file_position
operator|==
operator|-
literal|1
condition|)
name|file_position
operator|=
literal|0
expr_stmt|;
name|FileSeek
argument_list|(
name|dw
argument_list|,
name|file_position
argument_list|)
expr_stmt|;
name|dw
operator|->
name|dvi
operator|.
name|current_page
operator|=
name|i
expr_stmt|;
name|dw
operator|->
name|dvi
operator|.
name|display_enable
operator|=
literal|0
expr_stmt|;
while|while
condition|(
name|dw
operator|->
name|dvi
operator|.
name|current_page
operator|!=
name|dw
operator|->
name|dvi
operator|.
name|requested_page
condition|)
block|{
name|dw
operator|->
name|dvi
operator|.
name|current_page
operator|=
name|ParseInput
argument_list|(
name|dw
argument_list|)
expr_stmt|;
comment|/* 			 * at EOF, seek back to the beginning of this page. 			 */
if|if
condition|(
operator|!
name|dw
operator|->
name|dvi
operator|.
name|readingTmp
operator|&&
name|feof
argument_list|(
name|dw
operator|->
name|dvi
operator|.
name|file
argument_list|)
condition|)
block|{
name|file_position
operator|=
name|SearchPagePosition
argument_list|(
name|dw
argument_list|,
name|dw
operator|->
name|dvi
operator|.
name|current_page
argument_list|)
expr_stmt|;
if|if
condition|(
name|file_position
operator|!=
operator|-
literal|1
condition|)
name|FileSeek
argument_list|(
name|dw
argument_list|,
name|file_position
argument_list|)
expr_stmt|;
name|dw
operator|->
name|dvi
operator|.
name|requested_page
operator|=
name|dw
operator|->
name|dvi
operator|.
name|current_page
expr_stmt|;
break|break;
block|}
block|}
block|}
block|}
end_function

begin_function
name|void
name|DviSaveToFile
parameter_list|(
name|w
parameter_list|,
name|fp
parameter_list|)
name|Widget
name|w
decl_stmt|;
name|FILE
modifier|*
name|fp
decl_stmt|;
block|{
name|XtCheckSubclass
argument_list|(
name|w
argument_list|,
name|dviWidgetClass
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
operator|(
operator|*
operator|(
operator|(
name|DviWidgetClass
operator|)
name|XtClass
argument_list|(
name|w
argument_list|)
operator|)
operator|->
name|command_class
operator|.
name|save
operator|)
operator|(
name|w
operator|,
name|fp
operator|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|SaveToFile
parameter_list|(
name|w
parameter_list|,
name|fp
parameter_list|)
name|Widget
name|w
decl_stmt|;
name|FILE
modifier|*
name|fp
decl_stmt|;
block|{
name|DviWidget
name|dw
init|=
operator|(
name|DviWidget
operator|)
name|w
decl_stmt|;
name|long
name|pos
decl_stmt|;
name|int
name|c
decl_stmt|;
if|if
condition|(
name|dw
operator|->
name|dvi
operator|.
name|tmpFile
condition|)
block|{
name|pos
operator|=
name|ftell
argument_list|(
name|dw
operator|->
name|dvi
operator|.
name|tmpFile
argument_list|)
expr_stmt|;
if|if
condition|(
name|dw
operator|->
name|dvi
operator|.
name|ungot
condition|)
block|{
name|pos
operator|--
expr_stmt|;
name|dw
operator|->
name|dvi
operator|.
name|ungot
operator|=
literal|0
expr_stmt|;
comment|/* The ungot character is in the tmpFile, so we don't 			   want to read it from file. */
operator|(
name|void
operator|)
name|getc
argument_list|(
name|dw
operator|->
name|dvi
operator|.
name|file
argument_list|)
expr_stmt|;
block|}
block|}
else|else
name|pos
operator|=
name|ftell
argument_list|(
name|dw
operator|->
name|dvi
operator|.
name|file
argument_list|)
expr_stmt|;
name|FileSeek
argument_list|(
name|dw
argument_list|,
literal|0L
argument_list|)
expr_stmt|;
while|while
condition|(
name|DviGetC
argument_list|(
name|dw
argument_list|,
operator|&
name|c
argument_list|)
operator|!=
name|EOF
condition|)
if|if
condition|(
name|putc
argument_list|(
name|c
argument_list|,
name|fp
argument_list|)
operator|==
name|EOF
condition|)
block|{
comment|/* XXX print error message */
break|break;
block|}
name|FileSeek
argument_list|(
name|dw
argument_list|,
name|pos
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|ClassPartInitialize
parameter_list|(
name|widget_class
parameter_list|)
name|WidgetClass
name|widget_class
decl_stmt|;
block|{
name|DviWidgetClass
name|wc
init|=
operator|(
name|DviWidgetClass
operator|)
name|widget_class
decl_stmt|;
name|DviWidgetClass
name|super
init|=
operator|(
name|DviWidgetClass
operator|)
name|wc
operator|->
name|core_class
operator|.
name|superclass
decl_stmt|;
if|if
condition|(
name|wc
operator|->
name|command_class
operator|.
name|save
operator|==
name|InheritSaveToFile
condition|)
name|wc
operator|->
name|command_class
operator|.
name|save
operator|=
name|super
operator|->
name|command_class
operator|.
name|save
expr_stmt|;
block|}
end_function

begin_comment
comment|/* Local Variables: c-indent-level: 8 c-continued-statement-offset: 8 c-brace-offset: -8 c-argdecl-indent: 8 c-label-offset: -8 c-tab-always-indent: nil End: */
end_comment

end_unit


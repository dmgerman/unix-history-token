begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/* device.c */
end_comment

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_include
include|#
directive|include
file|<ctype.h>
end_include

begin_include
include|#
directive|include
file|<X11/Xos.h>
end_include

begin_include
include|#
directive|include
file|<X11/Intrinsic.h>
end_include

begin_include
include|#
directive|include
file|"device.h"
end_include

begin_ifndef
ifndef|#
directive|ifndef
name|FONTPATH
end_ifndef

begin_define
define|#
directive|define
name|FONTPATH
value|"/usr/local/lib/groff/font:/usr/local/lib/font:/usr/lib/font"
end_define

begin_endif
endif|#
directive|endif
end_endif

begin_ifndef
ifndef|#
directive|ifndef
name|isascii
end_ifndef

begin_define
define|#
directive|define
name|isascii
parameter_list|(
name|c
parameter_list|)
value|(1)
end_define

begin_endif
endif|#
directive|endif
end_endif

begin_function_decl
specifier|extern
name|void
name|exit
parameter_list|()
function_decl|;
end_function_decl

begin_decl_stmt
specifier|extern
name|char
modifier|*
name|strtok
argument_list|()
decl_stmt|,
modifier|*
name|strchr
argument_list|()
decl_stmt|;
end_decl_stmt

begin_function_decl
specifier|extern
name|char
modifier|*
name|getenv
parameter_list|()
function_decl|;
end_function_decl

begin_comment
comment|/* Name of environment variable containing path to be used for searching for device and font description files. */
end_comment

begin_define
define|#
directive|define
name|FONTPATH_ENV_VAR
value|"GROFF_FONT_PATH"
end_define

begin_define
define|#
directive|define
name|WS
value|" \t\r\n"
end_define

begin_comment
comment|/* Minimum and maximum values a `signed int' can hold.  */
end_comment

begin_define
define|#
directive|define
name|INT_MIN
value|(-INT_MAX-1)
end_define

begin_define
define|#
directive|define
name|INT_MAX
value|2147483647
end_define

begin_define
define|#
directive|define
name|CHAR_TABLE_SIZE
value|307
end_define

begin_struct
struct|struct
name|_DeviceFont
block|{
name|char
modifier|*
name|name
decl_stmt|;
name|int
name|special
decl_stmt|;
name|DeviceFont
modifier|*
name|next
decl_stmt|;
name|Device
modifier|*
name|dev
decl_stmt|;
name|struct
name|charinfo
modifier|*
name|char_table
index|[
name|CHAR_TABLE_SIZE
index|]
decl_stmt|;
name|struct
name|charinfo
modifier|*
name|code_table
index|[
literal|256
index|]
decl_stmt|;
block|}
struct|;
end_struct

begin_struct
struct|struct
name|charinfo
block|{
name|int
name|width
decl_stmt|;
name|int
name|code
decl_stmt|;
name|struct
name|charinfo
modifier|*
name|next
decl_stmt|;
name|struct
name|charinfo
modifier|*
name|code_next
decl_stmt|;
name|char
name|name
index|[
literal|1
index|]
decl_stmt|;
block|}
struct|;
end_struct

begin_decl_stmt
specifier|static
name|char
modifier|*
name|current_filename
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|current_lineno
init|=
operator|-
literal|1
decl_stmt|;
end_decl_stmt

begin_function_decl
specifier|static
name|void
name|error
parameter_list|()
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|FILE
modifier|*
name|open_device_file
parameter_list|()
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|DeviceFont
modifier|*
name|load_font
parameter_list|()
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|Device
modifier|*
name|new_device
parameter_list|()
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|DeviceFont
modifier|*
name|new_font
parameter_list|()
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|delete_font
parameter_list|()
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|unsigned
name|hash_name
parameter_list|()
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|struct
name|charinfo
modifier|*
name|add_char
parameter_list|()
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|read_charset_section
parameter_list|()
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|char
modifier|*
name|canonicalize_name
parameter_list|()
function_decl|;
end_function_decl

begin_function
specifier|static
name|Device
modifier|*
name|new_device
parameter_list|(
name|name
parameter_list|)
name|char
modifier|*
name|name
decl_stmt|;
block|{
name|Device
modifier|*
name|dev
decl_stmt|;
name|dev
operator|=
name|XtNew
argument_list|(
name|Device
argument_list|)
expr_stmt|;
name|dev
operator|->
name|sizescale
operator|=
literal|1
expr_stmt|;
name|dev
operator|->
name|res
operator|=
literal|0
expr_stmt|;
name|dev
operator|->
name|unitwidth
operator|=
literal|0
expr_stmt|;
name|dev
operator|->
name|fonts
operator|=
literal|0
expr_stmt|;
name|dev
operator|->
name|X11
operator|=
literal|0
expr_stmt|;
name|dev
operator|->
name|paperlength
operator|=
literal|0
expr_stmt|;
name|dev
operator|->
name|paperwidth
operator|=
literal|0
expr_stmt|;
name|dev
operator|->
name|name
operator|=
name|XtNewString
argument_list|(
name|name
argument_list|)
expr_stmt|;
return|return
name|dev
return|;
block|}
end_function

begin_function
name|void
name|device_destroy
parameter_list|(
name|dev
parameter_list|)
name|Device
modifier|*
name|dev
decl_stmt|;
block|{
name|DeviceFont
modifier|*
name|f
decl_stmt|;
if|if
condition|(
operator|!
name|dev
condition|)
return|return;
name|f
operator|=
name|dev
operator|->
name|fonts
expr_stmt|;
while|while
condition|(
name|f
condition|)
block|{
name|DeviceFont
modifier|*
name|tem
init|=
name|f
decl_stmt|;
name|f
operator|=
name|f
operator|->
name|next
expr_stmt|;
name|delete_font
argument_list|(
name|tem
argument_list|)
expr_stmt|;
block|}
name|XtFree
argument_list|(
name|dev
operator|->
name|name
argument_list|)
expr_stmt|;
name|XtFree
argument_list|(
operator|(
name|char
operator|*
operator|)
name|dev
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|Device
modifier|*
name|device_load
parameter_list|(
name|name
parameter_list|)
name|char
modifier|*
name|name
decl_stmt|;
block|{
name|Device
modifier|*
name|dev
decl_stmt|;
name|FILE
modifier|*
name|fp
decl_stmt|;
name|int
name|err
init|=
literal|0
decl_stmt|;
name|char
name|buf
index|[
literal|256
index|]
decl_stmt|;
name|fp
operator|=
name|open_device_file
argument_list|(
name|name
argument_list|,
literal|"DESC"
argument_list|,
operator|&
name|current_filename
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|fp
condition|)
return|return
literal|0
return|;
name|dev
operator|=
name|new_device
argument_list|(
name|name
argument_list|)
expr_stmt|;
name|current_lineno
operator|=
literal|0
expr_stmt|;
while|while
condition|(
name|fgets
argument_list|(
name|buf
argument_list|,
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
argument_list|,
name|fp
argument_list|)
condition|)
block|{
name|char
modifier|*
name|p
decl_stmt|;
name|current_lineno
operator|++
expr_stmt|;
name|p
operator|=
name|strtok
argument_list|(
name|buf
argument_list|,
name|WS
argument_list|)
expr_stmt|;
if|if
condition|(
name|p
condition|)
block|{
name|int
modifier|*
name|np
init|=
literal|0
decl_stmt|;
name|char
modifier|*
name|q
decl_stmt|;
if|if
condition|(
name|strcmp
argument_list|(
name|p
argument_list|,
literal|"charset"
argument_list|)
operator|==
literal|0
condition|)
break|break;
if|if
condition|(
name|strcmp
argument_list|(
name|p
argument_list|,
literal|"X11"
argument_list|)
operator|==
literal|0
condition|)
name|dev
operator|->
name|X11
operator|=
literal|1
expr_stmt|;
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|p
argument_list|,
literal|"sizescale"
argument_list|)
operator|==
literal|0
condition|)
name|np
operator|=
operator|&
name|dev
operator|->
name|sizescale
expr_stmt|;
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|p
argument_list|,
literal|"res"
argument_list|)
operator|==
literal|0
condition|)
name|np
operator|=
operator|&
name|dev
operator|->
name|res
expr_stmt|;
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|p
argument_list|,
literal|"unitwidth"
argument_list|)
operator|==
literal|0
condition|)
name|np
operator|=
operator|&
name|dev
operator|->
name|unitwidth
expr_stmt|;
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|p
argument_list|,
literal|"paperwidth"
argument_list|)
operator|==
literal|0
condition|)
name|np
operator|=
operator|&
name|dev
operator|->
name|paperwidth
expr_stmt|;
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|p
argument_list|,
literal|"paperlength"
argument_list|)
operator|==
literal|0
condition|)
name|np
operator|=
operator|&
name|dev
operator|->
name|paperlength
expr_stmt|;
if|if
condition|(
name|np
condition|)
block|{
name|q
operator|=
name|strtok
argument_list|(
operator|(
name|char
operator|*
operator|)
literal|0
argument_list|,
name|WS
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|q
operator|||
name|sscanf
argument_list|(
name|q
argument_list|,
literal|"%d"
argument_list|,
name|np
argument_list|)
operator|!=
literal|1
operator|||
operator|*
name|np
operator|<=
literal|0
condition|)
block|{
name|error
argument_list|(
literal|"bad argument"
argument_list|)
expr_stmt|;
name|err
operator|=
literal|1
expr_stmt|;
break|break;
block|}
block|}
block|}
block|}
name|fclose
argument_list|(
name|fp
argument_list|)
expr_stmt|;
name|current_lineno
operator|=
operator|-
literal|1
expr_stmt|;
if|if
condition|(
operator|!
name|err
condition|)
block|{
if|if
condition|(
name|dev
operator|->
name|res
operator|==
literal|0
condition|)
block|{
name|error
argument_list|(
literal|"missing res line"
argument_list|)
expr_stmt|;
name|err
operator|=
literal|1
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|dev
operator|->
name|unitwidth
operator|==
literal|0
condition|)
block|{
name|error
argument_list|(
literal|"missing unitwidth line"
argument_list|)
expr_stmt|;
name|err
operator|=
literal|1
expr_stmt|;
block|}
block|}
if|if
condition|(
name|dev
operator|->
name|paperlength
operator|==
literal|0
condition|)
name|dev
operator|->
name|paperlength
operator|=
name|dev
operator|->
name|res
operator|*
literal|11
expr_stmt|;
if|if
condition|(
name|dev
operator|->
name|paperwidth
operator|==
literal|0
condition|)
name|dev
operator|->
name|paperwidth
operator|=
name|dev
operator|->
name|res
operator|*
literal|8
operator|+
name|dev
operator|->
name|res
operator|/
literal|2
expr_stmt|;
if|if
condition|(
name|err
condition|)
block|{
name|device_destroy
argument_list|(
name|dev
argument_list|)
expr_stmt|;
name|dev
operator|=
literal|0
expr_stmt|;
block|}
name|XtFree
argument_list|(
name|current_filename
argument_list|)
expr_stmt|;
name|current_filename
operator|=
literal|0
expr_stmt|;
return|return
name|dev
return|;
block|}
end_function

begin_function
name|DeviceFont
modifier|*
name|device_find_font
parameter_list|(
name|dev
parameter_list|,
name|name
parameter_list|)
name|Device
modifier|*
name|dev
decl_stmt|;
name|char
modifier|*
name|name
decl_stmt|;
block|{
name|DeviceFont
modifier|*
name|f
decl_stmt|;
if|if
condition|(
operator|!
name|dev
condition|)
return|return
literal|0
return|;
for|for
control|(
name|f
operator|=
name|dev
operator|->
name|fonts
init|;
name|f
condition|;
name|f
operator|=
name|f
operator|->
name|next
control|)
if|if
condition|(
name|strcmp
argument_list|(
name|f
operator|->
name|name
argument_list|,
name|name
argument_list|)
operator|==
literal|0
condition|)
return|return
name|f
return|;
return|return
name|load_font
argument_list|(
name|dev
argument_list|,
name|name
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|DeviceFont
modifier|*
name|load_font
parameter_list|(
name|dev
parameter_list|,
name|name
parameter_list|)
name|Device
modifier|*
name|dev
decl_stmt|;
name|char
modifier|*
name|name
decl_stmt|;
block|{
name|FILE
modifier|*
name|fp
decl_stmt|;
name|char
name|buf
index|[
literal|256
index|]
decl_stmt|;
name|DeviceFont
modifier|*
name|f
decl_stmt|;
name|int
name|special
init|=
literal|0
decl_stmt|;
name|fp
operator|=
name|open_device_file
argument_list|(
name|dev
operator|->
name|name
argument_list|,
name|name
argument_list|,
operator|&
name|current_filename
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|fp
condition|)
return|return
literal|0
return|;
name|current_lineno
operator|=
literal|0
expr_stmt|;
for|for
control|(
init|;
condition|;
control|)
block|{
name|char
modifier|*
name|p
decl_stmt|;
if|if
condition|(
operator|!
name|fgets
argument_list|(
name|buf
argument_list|,
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
argument_list|,
name|fp
argument_list|)
condition|)
block|{
name|error
argument_list|(
literal|"no charset line"
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
name|current_lineno
operator|++
expr_stmt|;
name|p
operator|=
name|strtok
argument_list|(
name|buf
argument_list|,
name|WS
argument_list|)
expr_stmt|;
comment|/* charset must be on a line by itself */
if|if
condition|(
name|p
operator|&&
name|strcmp
argument_list|(
name|p
argument_list|,
literal|"charset"
argument_list|)
operator|==
literal|0
operator|&&
name|strtok
argument_list|(
operator|(
name|char
operator|*
operator|)
literal|0
argument_list|,
name|WS
argument_list|)
operator|==
literal|0
condition|)
break|break;
if|if
condition|(
name|p
operator|&&
name|strcmp
argument_list|(
name|p
argument_list|,
literal|"special"
argument_list|)
operator|==
literal|0
condition|)
name|special
operator|=
literal|1
expr_stmt|;
block|}
name|f
operator|=
name|new_font
argument_list|(
name|name
argument_list|,
name|dev
argument_list|)
expr_stmt|;
name|f
operator|->
name|special
operator|=
name|special
expr_stmt|;
if|if
condition|(
operator|!
name|read_charset_section
argument_list|(
name|f
argument_list|,
name|fp
argument_list|)
condition|)
block|{
name|delete_font
argument_list|(
name|f
argument_list|)
expr_stmt|;
name|f
operator|=
literal|0
expr_stmt|;
block|}
else|else
block|{
name|f
operator|->
name|next
operator|=
name|dev
operator|->
name|fonts
expr_stmt|;
name|dev
operator|->
name|fonts
operator|=
name|f
expr_stmt|;
block|}
name|fclose
argument_list|(
name|fp
argument_list|)
expr_stmt|;
name|XtFree
argument_list|(
name|current_filename
argument_list|)
expr_stmt|;
name|current_filename
operator|=
literal|0
expr_stmt|;
return|return
name|f
return|;
block|}
end_function

begin_function
specifier|static
name|DeviceFont
modifier|*
name|new_font
parameter_list|(
name|name
parameter_list|,
name|dev
parameter_list|)
name|char
modifier|*
name|name
decl_stmt|;
name|Device
modifier|*
name|dev
decl_stmt|;
block|{
name|int
name|i
decl_stmt|;
name|DeviceFont
modifier|*
name|f
decl_stmt|;
name|f
operator|=
name|XtNew
argument_list|(
name|DeviceFont
argument_list|)
expr_stmt|;
name|f
operator|->
name|name
operator|=
name|XtNewString
argument_list|(
name|name
argument_list|)
expr_stmt|;
name|f
operator|->
name|dev
operator|=
name|dev
expr_stmt|;
name|f
operator|->
name|special
operator|=
literal|0
expr_stmt|;
name|f
operator|->
name|next
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|CHAR_TABLE_SIZE
condition|;
name|i
operator|++
control|)
name|f
operator|->
name|char_table
index|[
name|i
index|]
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|256
condition|;
name|i
operator|++
control|)
name|f
operator|->
name|code_table
index|[
name|i
index|]
operator|=
literal|0
expr_stmt|;
return|return
name|f
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|delete_font
parameter_list|(
name|f
parameter_list|)
name|DeviceFont
modifier|*
name|f
decl_stmt|;
block|{
name|int
name|i
decl_stmt|;
if|if
condition|(
operator|!
name|f
condition|)
return|return;
name|XtFree
argument_list|(
name|f
operator|->
name|name
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|CHAR_TABLE_SIZE
condition|;
name|i
operator|++
control|)
block|{
name|struct
name|charinfo
modifier|*
name|ptr
init|=
name|f
operator|->
name|char_table
index|[
name|i
index|]
decl_stmt|;
while|while
condition|(
name|ptr
condition|)
block|{
name|struct
name|charinfo
modifier|*
name|tem
init|=
name|ptr
decl_stmt|;
name|ptr
operator|=
name|ptr
operator|->
name|next
expr_stmt|;
name|XtFree
argument_list|(
operator|(
name|char
operator|*
operator|)
name|tem
argument_list|)
expr_stmt|;
block|}
block|}
name|XtFree
argument_list|(
operator|(
name|char
operator|*
operator|)
name|f
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|unsigned
name|hash_name
parameter_list|(
name|name
parameter_list|)
name|char
modifier|*
name|name
decl_stmt|;
block|{
name|unsigned
name|n
init|=
literal|0
decl_stmt|;
comment|/* XXX do better than this */
while|while
condition|(
operator|*
name|name
condition|)
name|n
operator|=
operator|(
name|n
operator|<<
literal|1
operator|)
operator|^
operator|*
name|name
operator|++
expr_stmt|;
return|return
name|n
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|scale_round
parameter_list|(
name|n
parameter_list|,
name|x
parameter_list|,
name|y
parameter_list|)
name|int
name|n
decl_stmt|,
name|x
decl_stmt|,
name|y
decl_stmt|;
block|{
name|int
name|y2
decl_stmt|;
if|if
condition|(
name|x
operator|==
literal|0
condition|)
return|return
literal|0
return|;
name|y2
operator|=
name|y
operator|/
literal|2
expr_stmt|;
if|if
condition|(
name|n
operator|>=
literal|0
condition|)
block|{
if|if
condition|(
name|n
operator|<=
operator|(
name|INT_MAX
operator|-
name|y2
operator|)
operator|/
name|x
condition|)
return|return
operator|(
name|n
operator|*
name|x
operator|+
name|y2
operator|)
operator|/
name|y
return|;
block|}
elseif|else
if|if
condition|(
operator|-
operator|(
name|unsigned
operator|)
name|n
operator|<=
operator|(
operator|-
operator|(
name|unsigned
operator|)
name|INT_MIN
operator|-
name|y2
operator|)
operator|/
name|x
condition|)
return|return
operator|(
name|n
operator|*
name|x
operator|-
name|y2
operator|)
operator|/
name|y
return|;
return|return
call|(
name|int
call|)
argument_list|(
name|n
operator|*
operator|(
name|double
operator|)
name|x
operator|/
operator|(
name|double
operator|)
name|y
operator|+
literal|.5
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|char
modifier|*
name|canonicalize_name
parameter_list|(
name|s
parameter_list|)
name|char
modifier|*
name|s
decl_stmt|;
block|{
specifier|static
name|char
name|ch
index|[
literal|2
index|]
decl_stmt|;
if|if
condition|(
name|s
index|[
literal|0
index|]
operator|==
literal|'c'
operator|&&
name|s
index|[
literal|1
index|]
operator|==
literal|'h'
operator|&&
name|s
index|[
literal|2
index|]
operator|==
literal|'a'
operator|&&
name|s
index|[
literal|3
index|]
operator|==
literal|'r'
condition|)
block|{
name|char
modifier|*
name|p
decl_stmt|;
name|int
name|n
decl_stmt|;
for|for
control|(
name|p
operator|=
name|s
operator|+
literal|4
init|;
operator|*
name|p
condition|;
name|p
operator|++
control|)
if|if
condition|(
operator|!
name|isascii
argument_list|(
operator|*
name|p
argument_list|)
operator|||
operator|!
name|isdigit
argument_list|(
operator|(
name|unsigned
name|char
operator|)
operator|*
name|p
argument_list|)
condition|)
return|return
name|s
return|;
name|n
operator|=
name|atoi
argument_list|(
name|s
operator|+
literal|4
argument_list|)
expr_stmt|;
if|if
condition|(
name|n
operator|>=
literal|0
operator|&&
name|n
operator|<=
literal|0xff
condition|)
block|{
name|ch
index|[
literal|0
index|]
operator|=
operator|(
name|char
operator|)
name|n
expr_stmt|;
return|return
name|ch
return|;
block|}
block|}
return|return
name|s
return|;
block|}
end_function

begin_comment
comment|/* Return 1 if the character is present in the font; widthp gets the width if non-null. */
end_comment

begin_function
name|int
name|device_char_width
parameter_list|(
name|f
parameter_list|,
name|ps
parameter_list|,
name|name
parameter_list|,
name|widthp
parameter_list|)
name|DeviceFont
modifier|*
name|f
decl_stmt|;
name|int
name|ps
decl_stmt|;
name|char
modifier|*
name|name
decl_stmt|;
name|int
modifier|*
name|widthp
decl_stmt|;
block|{
name|struct
name|charinfo
modifier|*
name|p
decl_stmt|;
name|name
operator|=
name|canonicalize_name
argument_list|(
name|name
argument_list|)
expr_stmt|;
for|for
control|(
name|p
operator|=
name|f
operator|->
name|char_table
index|[
name|hash_name
argument_list|(
name|name
argument_list|)
operator|%
name|CHAR_TABLE_SIZE
index|]
init|;
condition|;
name|p
operator|=
name|p
operator|->
name|next
control|)
block|{
if|if
condition|(
operator|!
name|p
condition|)
return|return
literal|0
return|;
if|if
condition|(
name|strcmp
argument_list|(
name|p
operator|->
name|name
argument_list|,
name|name
argument_list|)
operator|==
literal|0
condition|)
break|break;
block|}
operator|*
name|widthp
operator|=
name|scale_round
argument_list|(
name|p
operator|->
name|width
argument_list|,
name|ps
argument_list|,
name|f
operator|->
name|dev
operator|->
name|unitwidth
argument_list|)
expr_stmt|;
return|return
literal|1
return|;
block|}
end_function

begin_function
name|int
name|device_code_width
parameter_list|(
name|f
parameter_list|,
name|ps
parameter_list|,
name|code
parameter_list|,
name|widthp
parameter_list|)
name|DeviceFont
modifier|*
name|f
decl_stmt|;
name|int
name|ps
decl_stmt|;
name|int
name|code
decl_stmt|;
name|int
modifier|*
name|widthp
decl_stmt|;
block|{
name|struct
name|charinfo
modifier|*
name|p
decl_stmt|;
for|for
control|(
name|p
operator|=
name|f
operator|->
name|code_table
index|[
name|code
operator|&
literal|0xff
index|]
init|;
condition|;
name|p
operator|=
name|p
operator|->
name|code_next
control|)
block|{
if|if
condition|(
operator|!
name|p
condition|)
return|return
literal|0
return|;
if|if
condition|(
name|p
operator|->
name|code
operator|==
name|code
condition|)
break|break;
block|}
operator|*
name|widthp
operator|=
name|scale_round
argument_list|(
name|p
operator|->
name|width
argument_list|,
name|ps
argument_list|,
name|f
operator|->
name|dev
operator|->
name|unitwidth
argument_list|)
expr_stmt|;
return|return
literal|1
return|;
block|}
end_function

begin_function
name|char
modifier|*
name|device_name_for_code
parameter_list|(
name|f
parameter_list|,
name|code
parameter_list|)
name|DeviceFont
modifier|*
name|f
decl_stmt|;
name|int
name|code
decl_stmt|;
block|{
specifier|static
name|struct
name|charinfo
modifier|*
name|state
init|=
literal|0
decl_stmt|;
if|if
condition|(
name|f
condition|)
name|state
operator|=
name|f
operator|->
name|code_table
index|[
name|code
operator|&
literal|0xff
index|]
expr_stmt|;
for|for
control|(
init|;
name|state
condition|;
name|state
operator|=
name|state
operator|->
name|code_next
control|)
if|if
condition|(
name|state
operator|->
name|code
operator|==
name|code
operator|&&
name|state
operator|->
name|name
index|[
literal|0
index|]
operator|!=
literal|'\0'
condition|)
block|{
name|char
modifier|*
name|name
init|=
name|state
operator|->
name|name
decl_stmt|;
name|state
operator|=
name|state
operator|->
name|code_next
expr_stmt|;
return|return
name|name
return|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
name|int
name|device_font_special
parameter_list|(
name|f
parameter_list|)
name|DeviceFont
modifier|*
name|f
decl_stmt|;
block|{
return|return
name|f
operator|->
name|special
return|;
block|}
end_function

begin_function
specifier|static
name|struct
name|charinfo
modifier|*
name|add_char
parameter_list|(
name|f
parameter_list|,
name|name
parameter_list|,
name|width
parameter_list|,
name|code
parameter_list|)
name|DeviceFont
modifier|*
name|f
decl_stmt|;
name|char
modifier|*
name|name
decl_stmt|;
name|int
name|width
decl_stmt|,
name|code
decl_stmt|;
block|{
name|struct
name|charinfo
modifier|*
modifier|*
name|pp
decl_stmt|;
name|struct
name|charinfo
modifier|*
name|ci
decl_stmt|;
name|name
operator|=
name|canonicalize_name
argument_list|(
name|name
argument_list|)
expr_stmt|;
if|if
condition|(
name|strcmp
argument_list|(
name|name
argument_list|,
literal|"---"
argument_list|)
operator|==
literal|0
condition|)
name|name
operator|=
literal|""
expr_stmt|;
name|ci
operator|=
operator|(
expr|struct
name|charinfo
operator|*
operator|)
name|XtMalloc
argument_list|(
name|XtOffsetOf
argument_list|(
expr|struct
name|charinfo
argument_list|,
name|name
index|[
literal|0
index|]
argument_list|)
operator|+
name|strlen
argument_list|(
name|name
argument_list|)
operator|+
literal|1
argument_list|)
expr_stmt|;
name|strcpy
argument_list|(
name|ci
operator|->
name|name
argument_list|,
name|name
argument_list|)
expr_stmt|;
name|ci
operator|->
name|width
operator|=
name|width
expr_stmt|;
name|ci
operator|->
name|code
operator|=
name|code
expr_stmt|;
if|if
condition|(
operator|*
name|name
operator|!=
literal|'\0'
condition|)
block|{
name|pp
operator|=
operator|&
name|f
operator|->
name|char_table
index|[
name|hash_name
argument_list|(
name|name
argument_list|)
operator|%
name|CHAR_TABLE_SIZE
index|]
expr_stmt|;
name|ci
operator|->
name|next
operator|=
operator|*
name|pp
expr_stmt|;
operator|*
name|pp
operator|=
name|ci
expr_stmt|;
block|}
name|pp
operator|=
operator|&
name|f
operator|->
name|code_table
index|[
name|code
operator|&
literal|0xff
index|]
expr_stmt|;
name|ci
operator|->
name|code_next
operator|=
operator|*
name|pp
expr_stmt|;
operator|*
name|pp
operator|=
name|ci
expr_stmt|;
return|return
name|ci
return|;
block|}
end_function

begin_comment
comment|/* Return non-zero for success. */
end_comment

begin_function
specifier|static
name|int
name|read_charset_section
parameter_list|(
name|f
parameter_list|,
name|fp
parameter_list|)
name|DeviceFont
modifier|*
name|f
decl_stmt|;
name|FILE
modifier|*
name|fp
decl_stmt|;
block|{
name|struct
name|charinfo
modifier|*
name|last_charinfo
init|=
literal|0
decl_stmt|;
name|char
name|buf
index|[
literal|256
index|]
decl_stmt|;
while|while
condition|(
name|fgets
argument_list|(
name|buf
argument_list|,
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
argument_list|,
name|fp
argument_list|)
condition|)
block|{
name|char
modifier|*
name|name
decl_stmt|;
name|int
name|width
decl_stmt|;
name|int
name|code
decl_stmt|;
name|char
modifier|*
name|p
decl_stmt|;
name|current_lineno
operator|++
expr_stmt|;
name|name
operator|=
name|strtok
argument_list|(
name|buf
argument_list|,
name|WS
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|name
condition|)
continue|continue;
comment|/* ignore blank lines */
name|p
operator|=
name|strtok
argument_list|(
operator|(
name|char
operator|*
operator|)
literal|0
argument_list|,
name|WS
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|p
condition|)
comment|/* end of charset section */
break|break;
if|if
condition|(
name|strcmp
argument_list|(
name|p
argument_list|,
literal|"\""
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
operator|!
name|last_charinfo
condition|)
block|{
name|error
argument_list|(
literal|"first line of charset section cannot use `\"'"
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
else|else
operator|(
name|void
operator|)
name|add_char
argument_list|(
name|f
argument_list|,
name|name
argument_list|,
name|last_charinfo
operator|->
name|width
argument_list|,
name|last_charinfo
operator|->
name|code
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|char
modifier|*
name|q
decl_stmt|;
if|if
condition|(
name|sscanf
argument_list|(
name|p
argument_list|,
literal|"%d"
argument_list|,
operator|&
name|width
argument_list|)
operator|!=
literal|1
condition|)
block|{
name|error
argument_list|(
literal|"bad width field"
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
name|p
operator|=
name|strtok
argument_list|(
operator|(
name|char
operator|*
operator|)
literal|0
argument_list|,
name|WS
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|p
condition|)
block|{
name|error
argument_list|(
literal|"missing type field"
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
name|p
operator|=
name|strtok
argument_list|(
operator|(
name|char
operator|*
operator|)
literal|0
argument_list|,
name|WS
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|p
condition|)
block|{
name|error
argument_list|(
literal|"missing code field"
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
name|code
operator|=
operator|(
name|int
operator|)
name|strtol
argument_list|(
name|p
argument_list|,
operator|&
name|q
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|q
operator|==
name|p
condition|)
block|{
name|error
argument_list|(
literal|"bad code field"
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
name|last_charinfo
operator|=
name|add_char
argument_list|(
name|f
argument_list|,
name|name
argument_list|,
name|width
argument_list|,
name|code
argument_list|)
expr_stmt|;
block|}
block|}
return|return
literal|1
return|;
block|}
end_function

begin_function
specifier|static
name|FILE
modifier|*
name|find_file
parameter_list|(
name|file
parameter_list|,
name|path
parameter_list|,
name|result
parameter_list|)
name|char
modifier|*
name|file
decl_stmt|,
decl|*
name|path
decl_stmt|,
modifier|*
modifier|*
name|result
decl_stmt|;
end_function

begin_block
block|{
name|char
modifier|*
name|buf
init|=
name|NULL
decl_stmt|;
name|int
name|bufsiz
init|=
literal|0
decl_stmt|;
name|int
name|flen
decl_stmt|;
name|FILE
modifier|*
name|fp
decl_stmt|;
operator|*
name|result
operator|=
name|NULL
expr_stmt|;
if|if
condition|(
name|file
operator|==
name|NULL
condition|)
return|return
name|NULL
return|;
if|if
condition|(
operator|*
name|file
operator|==
literal|'\0'
condition|)
return|return
name|NULL
return|;
if|if
condition|(
operator|*
name|file
operator|==
literal|'/'
condition|)
block|{
name|fp
operator|=
name|fopen
argument_list|(
name|file
argument_list|,
literal|"r"
argument_list|)
expr_stmt|;
if|if
condition|(
name|fp
condition|)
operator|*
name|result
operator|=
name|XtNewString
argument_list|(
name|file
argument_list|)
expr_stmt|;
return|return
name|fp
return|;
block|}
name|flen
operator|=
name|strlen
argument_list|(
name|file
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|path
condition|)
return|return
name|NULL
return|;
while|while
condition|(
operator|*
name|path
condition|)
block|{
name|int
name|len
decl_stmt|;
name|char
modifier|*
name|start
decl_stmt|,
modifier|*
name|end
decl_stmt|;
name|start
operator|=
name|path
expr_stmt|;
name|end
operator|=
name|strchr
argument_list|(
name|path
argument_list|,
literal|':'
argument_list|)
expr_stmt|;
if|if
condition|(
name|end
condition|)
name|path
operator|=
name|end
operator|+
literal|1
expr_stmt|;
else|else
name|path
operator|=
name|end
operator|=
name|strchr
argument_list|(
name|path
argument_list|,
literal|'\0'
argument_list|)
expr_stmt|;
if|if
condition|(
name|start
operator|>=
name|end
condition|)
continue|continue;
if|if
condition|(
name|end
index|[
operator|-
literal|1
index|]
operator|==
literal|'/'
condition|)
operator|--
name|end
expr_stmt|;
name|len
operator|=
operator|(
name|end
operator|-
name|start
operator|)
operator|+
literal|1
operator|+
name|flen
operator|+
literal|1
expr_stmt|;
if|if
condition|(
name|len
operator|>
name|bufsiz
condition|)
block|{
if|if
condition|(
name|buf
condition|)
name|buf
operator|=
name|XtRealloc
argument_list|(
name|buf
argument_list|,
name|len
argument_list|)
expr_stmt|;
else|else
name|buf
operator|=
name|XtMalloc
argument_list|(
name|len
argument_list|)
expr_stmt|;
name|bufsiz
operator|=
name|len
expr_stmt|;
block|}
name|memcpy
argument_list|(
name|buf
argument_list|,
name|start
argument_list|,
name|end
operator|-
name|start
argument_list|)
expr_stmt|;
name|buf
index|[
name|end
operator|-
name|start
index|]
operator|=
literal|'/'
expr_stmt|;
name|strcpy
argument_list|(
name|buf
operator|+
operator|(
name|end
operator|-
name|start
operator|)
operator|+
literal|1
argument_list|,
name|file
argument_list|)
expr_stmt|;
name|fp
operator|=
name|fopen
argument_list|(
name|buf
argument_list|,
literal|"r"
argument_list|)
expr_stmt|;
if|if
condition|(
name|fp
condition|)
block|{
operator|*
name|result
operator|=
name|buf
expr_stmt|;
return|return
name|fp
return|;
block|}
block|}
name|XtFree
argument_list|(
name|buf
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
end_block

begin_function
specifier|static
name|FILE
modifier|*
name|open_device_file
parameter_list|(
name|device_name
parameter_list|,
name|file_name
parameter_list|,
name|result
parameter_list|)
name|char
modifier|*
name|device_name
decl_stmt|,
decl|*
name|file_name
decl_stmt|,
modifier|*
modifier|*
name|result
decl_stmt|;
end_function

begin_block
block|{
name|char
modifier|*
name|buf
decl_stmt|,
modifier|*
name|path
decl_stmt|;
name|FILE
modifier|*
name|fp
decl_stmt|;
name|buf
operator|=
name|XtMalloc
argument_list|(
literal|3
operator|+
name|strlen
argument_list|(
name|device_name
argument_list|)
operator|+
literal|1
operator|+
name|strlen
argument_list|(
name|file_name
argument_list|)
operator|+
literal|1
argument_list|)
expr_stmt|;
name|sprintf
argument_list|(
name|buf
argument_list|,
literal|"dev%s/%s"
argument_list|,
name|device_name
argument_list|,
name|file_name
argument_list|)
expr_stmt|;
name|path
operator|=
name|getenv
argument_list|(
name|FONTPATH_ENV_VAR
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|path
condition|)
name|path
operator|=
name|FONTPATH
expr_stmt|;
name|fp
operator|=
name|find_file
argument_list|(
name|buf
argument_list|,
name|path
argument_list|,
name|result
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|fp
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"can't find device file `%s'\n"
argument_list|,
name|file_name
argument_list|)
expr_stmt|;
name|fflush
argument_list|(
name|stderr
argument_list|)
expr_stmt|;
block|}
name|XtFree
argument_list|(
name|buf
argument_list|)
expr_stmt|;
return|return
name|fp
return|;
block|}
end_block

begin_function
specifier|static
name|void
name|error
parameter_list|(
name|s
parameter_list|)
name|char
modifier|*
name|s
decl_stmt|;
block|{
if|if
condition|(
name|current_filename
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"%s:"
argument_list|,
name|current_filename
argument_list|)
expr_stmt|;
if|if
condition|(
name|current_lineno
operator|>
literal|0
condition|)
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"%d:"
argument_list|,
name|current_lineno
argument_list|)
expr_stmt|;
name|putc
argument_list|(
literal|' '
argument_list|,
name|stderr
argument_list|)
expr_stmt|;
block|}
name|fputs
argument_list|(
name|s
argument_list|,
name|stderr
argument_list|)
expr_stmt|;
name|putc
argument_list|(
literal|'\n'
argument_list|,
name|stderr
argument_list|)
expr_stmt|;
name|fflush
argument_list|(
name|stderr
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* Local Variables: c-indent-level: 4 c-continued-statement-offset: 4 c-brace-offset: -4 c-argdecl-indent: 4 c-label-offset: -4 c-tab-always-indent: nil End: */
end_comment

end_unit


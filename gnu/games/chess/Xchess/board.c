begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/* This file contains code for X-CHESS.    Copyright (C) 1986 Free Software Foundation, Inc.  This file is part of X-CHESS.  X-CHESS is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY.  No author or distributor accepts responsibility to anyone for the consequences of using it or for whether it serves any particular purpose or works at all, unless he says so in writing.  Refer to the X-CHESS General Public License for full details.  Everyone is granted permission to copy, modify and redistribute X-CHESS, but only under the conditions described in the X-CHESS General Public License.   A copy of this license is supposed to have been given to you along with X-CHESS so you can know your rights and responsibilities.  It should be in a file named COPYING.  Among other things, the copyright notice and this notice must be preserved on all copies.  */
end_comment

begin_comment
comment|/* RCS Info: $Revision: 1.4 $ on $Date: 86/11/23 17:17:15 $  *           $Source: /users/faustus/xchess/RCS/board.c,v $  * Copyright (c) 1986 Wayne A. Christopher, U. C. Berkeley CAD Group  *	Permission is granted to do anything with this code except sell it  *	or remove this message.  *  * Stuff to deal with the board.  */
end_comment

begin_include
include|#
directive|include
file|"xchess.h"
end_include

begin_decl_stmt
name|board
modifier|*
name|chessboard
decl_stmt|;
end_decl_stmt

begin_function
name|void
name|board_setup
parameter_list|()
block|{
name|chessboard
operator|=
name|alloc
argument_list|(
name|board
argument_list|)
expr_stmt|;
name|board_init
argument_list|(
name|chessboard
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_function
name|void
name|board_init
parameter_list|(
name|b
parameter_list|)
name|board
modifier|*
name|b
decl_stmt|;
block|{
name|int
name|i
decl_stmt|,
name|j
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|2
condition|;
name|i
operator|++
control|)
for|for
control|(
name|j
operator|=
literal|0
init|;
name|j
operator|<
name|SIZE
condition|;
name|j
operator|++
control|)
name|b
operator|->
name|square
index|[
name|i
index|]
index|[
name|j
index|]
operator|.
name|color
operator|=
name|BLACK
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|2
init|;
name|i
operator|<
literal|6
condition|;
name|i
operator|++
control|)
for|for
control|(
name|j
operator|=
literal|0
init|;
name|j
operator|<
name|SIZE
condition|;
name|j
operator|++
control|)
name|b
operator|->
name|square
index|[
name|i
index|]
index|[
name|j
index|]
operator|.
name|color
operator|=
name|NONE
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|6
init|;
name|i
operator|<
literal|8
condition|;
name|i
operator|++
control|)
for|for
control|(
name|j
operator|=
literal|0
init|;
name|j
operator|<
name|SIZE
condition|;
name|j
operator|++
control|)
name|b
operator|->
name|square
index|[
name|i
index|]
index|[
name|j
index|]
operator|.
name|color
operator|=
name|WHITE
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|SIZE
condition|;
name|i
operator|++
control|)
name|b
operator|->
name|square
index|[
literal|1
index|]
index|[
name|i
index|]
operator|.
name|type
operator|=
name|b
operator|->
name|square
index|[
literal|6
index|]
index|[
name|i
index|]
operator|.
name|type
operator|=
name|PAWN
expr_stmt|;
name|b
operator|->
name|square
index|[
literal|0
index|]
index|[
literal|0
index|]
operator|.
name|type
operator|=
name|b
operator|->
name|square
index|[
literal|7
index|]
index|[
literal|0
index|]
operator|.
name|type
operator|=
name|ROOK
expr_stmt|;
name|b
operator|->
name|square
index|[
literal|0
index|]
index|[
literal|1
index|]
operator|.
name|type
operator|=
name|b
operator|->
name|square
index|[
literal|7
index|]
index|[
literal|1
index|]
operator|.
name|type
operator|=
name|KNIGHT
expr_stmt|;
name|b
operator|->
name|square
index|[
literal|0
index|]
index|[
literal|2
index|]
operator|.
name|type
operator|=
name|b
operator|->
name|square
index|[
literal|7
index|]
index|[
literal|2
index|]
operator|.
name|type
operator|=
name|BISHOP
expr_stmt|;
name|b
operator|->
name|square
index|[
literal|0
index|]
index|[
literal|3
index|]
operator|.
name|type
operator|=
name|b
operator|->
name|square
index|[
literal|7
index|]
index|[
literal|3
index|]
operator|.
name|type
operator|=
name|QUEEN
expr_stmt|;
name|b
operator|->
name|square
index|[
literal|0
index|]
index|[
literal|4
index|]
operator|.
name|type
operator|=
name|b
operator|->
name|square
index|[
literal|7
index|]
index|[
literal|4
index|]
operator|.
name|type
operator|=
name|KING
expr_stmt|;
name|b
operator|->
name|square
index|[
literal|0
index|]
index|[
literal|5
index|]
operator|.
name|type
operator|=
name|b
operator|->
name|square
index|[
literal|7
index|]
index|[
literal|5
index|]
operator|.
name|type
operator|=
name|BISHOP
expr_stmt|;
name|b
operator|->
name|square
index|[
literal|0
index|]
index|[
literal|6
index|]
operator|.
name|type
operator|=
name|b
operator|->
name|square
index|[
literal|7
index|]
index|[
literal|6
index|]
operator|.
name|type
operator|=
name|KNIGHT
expr_stmt|;
name|b
operator|->
name|square
index|[
literal|0
index|]
index|[
literal|7
index|]
operator|.
name|type
operator|=
name|b
operator|->
name|square
index|[
literal|7
index|]
index|[
literal|7
index|]
operator|.
name|type
operator|=
name|ROOK
expr_stmt|;
name|b
operator|->
name|black_cant_castle_k
operator|=
name|false
expr_stmt|;
name|b
operator|->
name|black_cant_castle_q
operator|=
name|false
expr_stmt|;
name|b
operator|->
name|white_cant_castle_k
operator|=
name|false
expr_stmt|;
name|b
operator|->
name|white_cant_castle_q
operator|=
name|false
expr_stmt|;
return|return;
block|}
end_function

begin_function
name|void
name|board_drawall
parameter_list|()
block|{
name|int
name|i
decl_stmt|,
name|j
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|SIZE
condition|;
name|i
operator|++
control|)
for|for
control|(
name|j
operator|=
literal|0
init|;
name|j
operator|<
name|SIZE
condition|;
name|j
operator|++
control|)
if|if
condition|(
name|chessboard
operator|->
name|square
index|[
name|i
index|]
index|[
name|j
index|]
operator|.
name|color
operator|!=
name|NONE
condition|)
block|{
name|win_drawpiece
argument_list|(
operator|&
name|chessboard
operator|->
name|square
index|[
name|i
index|]
index|[
name|j
index|]
argument_list|,
name|i
argument_list|,
name|j
argument_list|,
name|WHITE
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|oneboard
condition|)
name|win_drawpiece
argument_list|(
operator|&
name|chessboard
operator|->
name|square
index|[
name|i
index|]
index|[
name|j
index|]
argument_list|,
name|i
argument_list|,
name|j
argument_list|,
name|BLACK
argument_list|)
expr_stmt|;
block|}
return|return;
block|}
end_function

begin_function
name|void
name|board_move
parameter_list|(
name|b
parameter_list|,
name|m
parameter_list|)
name|board
modifier|*
name|b
decl_stmt|;
name|move
modifier|*
name|m
decl_stmt|;
block|{
switch|switch
condition|(
name|m
operator|->
name|type
condition|)
block|{
case|case
name|MOVE
case|:
case|case
name|CAPTURE
case|:
name|b
operator|->
name|square
index|[
name|m
operator|->
name|fromy
index|]
index|[
name|m
operator|->
name|fromx
index|]
operator|.
name|color
operator|=
name|NONE
expr_stmt|;
name|b
operator|->
name|square
index|[
name|m
operator|->
name|toy
index|]
index|[
name|m
operator|->
name|tox
index|]
operator|.
name|color
operator|=
name|m
operator|->
name|piece
operator|.
name|color
expr_stmt|;
name|b
operator|->
name|square
index|[
name|m
operator|->
name|toy
index|]
index|[
name|m
operator|->
name|tox
index|]
operator|.
name|type
operator|=
name|m
operator|->
name|piece
operator|.
name|type
expr_stmt|;
if|if
condition|(
operator|(
name|m
operator|->
name|piece
operator|.
name|type
operator|==
name|PAWN
operator|)
operator|&&
operator|(
operator|(
operator|(
name|m
operator|->
name|piece
operator|.
name|color
operator|==
name|BLACK
operator|)
operator|&&
operator|(
name|m
operator|->
name|toy
operator|==
literal|7
operator|)
operator|)
operator|||
operator|(
operator|(
name|m
operator|->
name|piece
operator|.
name|color
operator|==
name|WHITE
operator|)
operator|&&
operator|(
name|m
operator|->
name|toy
operator|==
literal|0
operator|)
operator|)
operator|)
condition|)
name|b
operator|->
name|square
index|[
name|m
operator|->
name|toy
index|]
index|[
name|m
operator|->
name|tox
index|]
operator|.
name|type
operator|=
name|QUEEN
expr_stmt|;
if|if
condition|(
name|m
operator|->
name|enpassant
condition|)
name|b
operator|->
name|square
index|[
name|m
operator|->
name|toy
operator|+
operator|(
operator|(
name|m
operator|->
name|piece
operator|.
name|color
operator|==
name|WHITE
operator|)
condition|?
literal|1
else|:
operator|-
literal|1
operator|)
index|]
index|[
name|m
operator|->
name|tox
index|]
operator|.
name|color
operator|=
name|NONE
expr_stmt|;
break|break;
case|case
name|KCASTLE
case|:
if|if
condition|(
name|m
operator|->
name|piece
operator|.
name|color
operator|==
name|WHITE
condition|)
block|{
name|b
operator|->
name|square
index|[
literal|7
index|]
index|[
literal|5
index|]
operator|.
name|color
operator|=
name|m
operator|->
name|piece
operator|.
name|color
expr_stmt|;
name|b
operator|->
name|square
index|[
literal|7
index|]
index|[
literal|5
index|]
operator|.
name|type
operator|=
name|ROOK
expr_stmt|;
name|b
operator|->
name|square
index|[
literal|7
index|]
index|[
literal|6
index|]
operator|.
name|color
operator|=
name|m
operator|->
name|piece
operator|.
name|color
expr_stmt|;
name|b
operator|->
name|square
index|[
literal|7
index|]
index|[
literal|6
index|]
operator|.
name|type
operator|=
name|KING
expr_stmt|;
name|b
operator|->
name|square
index|[
literal|7
index|]
index|[
literal|4
index|]
operator|.
name|color
operator|=
name|NONE
expr_stmt|;
name|b
operator|->
name|square
index|[
literal|7
index|]
index|[
literal|7
index|]
operator|.
name|color
operator|=
name|NONE
expr_stmt|;
block|}
else|else
block|{
name|b
operator|->
name|square
index|[
literal|0
index|]
index|[
literal|5
index|]
operator|.
name|color
operator|=
name|m
operator|->
name|piece
operator|.
name|color
expr_stmt|;
name|b
operator|->
name|square
index|[
literal|0
index|]
index|[
literal|5
index|]
operator|.
name|type
operator|=
name|ROOK
expr_stmt|;
name|b
operator|->
name|square
index|[
literal|0
index|]
index|[
literal|6
index|]
operator|.
name|color
operator|=
name|m
operator|->
name|piece
operator|.
name|color
expr_stmt|;
name|b
operator|->
name|square
index|[
literal|0
index|]
index|[
literal|6
index|]
operator|.
name|type
operator|=
name|KING
expr_stmt|;
name|b
operator|->
name|square
index|[
literal|0
index|]
index|[
literal|4
index|]
operator|.
name|color
operator|=
name|NONE
expr_stmt|;
name|b
operator|->
name|square
index|[
literal|0
index|]
index|[
literal|7
index|]
operator|.
name|color
operator|=
name|NONE
expr_stmt|;
block|}
break|break;
case|case
name|QCASTLE
case|:
if|if
condition|(
name|m
operator|->
name|piece
operator|.
name|color
operator|==
name|WHITE
condition|)
block|{
name|b
operator|->
name|square
index|[
literal|7
index|]
index|[
literal|3
index|]
operator|.
name|color
operator|=
name|m
operator|->
name|piece
operator|.
name|color
expr_stmt|;
name|b
operator|->
name|square
index|[
literal|7
index|]
index|[
literal|3
index|]
operator|.
name|type
operator|=
name|ROOK
expr_stmt|;
name|b
operator|->
name|square
index|[
literal|7
index|]
index|[
literal|2
index|]
operator|.
name|color
operator|=
name|m
operator|->
name|piece
operator|.
name|color
expr_stmt|;
name|b
operator|->
name|square
index|[
literal|7
index|]
index|[
literal|2
index|]
operator|.
name|type
operator|=
name|KING
expr_stmt|;
name|b
operator|->
name|square
index|[
literal|7
index|]
index|[
literal|4
index|]
operator|.
name|color
operator|=
name|NONE
expr_stmt|;
name|b
operator|->
name|square
index|[
literal|7
index|]
index|[
literal|0
index|]
operator|.
name|color
operator|=
name|NONE
expr_stmt|;
block|}
else|else
block|{
name|b
operator|->
name|square
index|[
literal|0
index|]
index|[
literal|3
index|]
operator|.
name|color
operator|=
name|m
operator|->
name|piece
operator|.
name|color
expr_stmt|;
name|b
operator|->
name|square
index|[
literal|0
index|]
index|[
literal|3
index|]
operator|.
name|type
operator|=
name|ROOK
expr_stmt|;
name|b
operator|->
name|square
index|[
literal|0
index|]
index|[
literal|2
index|]
operator|.
name|color
operator|=
name|m
operator|->
name|piece
operator|.
name|color
expr_stmt|;
name|b
operator|->
name|square
index|[
literal|0
index|]
index|[
literal|2
index|]
operator|.
name|type
operator|=
name|KING
expr_stmt|;
name|b
operator|->
name|square
index|[
literal|0
index|]
index|[
literal|4
index|]
operator|.
name|color
operator|=
name|NONE
expr_stmt|;
name|b
operator|->
name|square
index|[
literal|0
index|]
index|[
literal|0
index|]
operator|.
name|color
operator|=
name|NONE
expr_stmt|;
block|}
break|break;
default|default:
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Bad move type %d\n"
argument_list|,
name|m
operator|->
name|type
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|m
operator|->
name|piece
operator|.
name|type
operator|==
name|KING
condition|)
block|{
if|if
condition|(
name|m
operator|->
name|piece
operator|.
name|color
operator|==
name|WHITE
condition|)
name|b
operator|->
name|white_cant_castle_q
operator|=
name|b
operator|->
name|white_cant_castle_k
operator|=
name|true
expr_stmt|;
else|else
name|b
operator|->
name|black_cant_castle_q
operator|=
name|b
operator|->
name|black_cant_castle_k
operator|=
name|true
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|m
operator|->
name|piece
operator|.
name|type
operator|==
name|ROOK
condition|)
block|{
if|if
condition|(
name|m
operator|->
name|piece
operator|.
name|color
operator|==
name|WHITE
condition|)
block|{
if|if
condition|(
name|m
operator|->
name|fromx
operator|==
literal|0
condition|)
name|b
operator|->
name|white_cant_castle_q
operator|=
name|true
expr_stmt|;
elseif|else
if|if
condition|(
name|m
operator|->
name|fromx
operator|==
literal|7
condition|)
name|b
operator|->
name|white_cant_castle_k
operator|=
name|true
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|m
operator|->
name|fromx
operator|==
literal|0
condition|)
name|b
operator|->
name|black_cant_castle_q
operator|=
name|true
expr_stmt|;
elseif|else
if|if
condition|(
name|m
operator|->
name|fromx
operator|==
literal|7
condition|)
name|b
operator|->
name|black_cant_castle_k
operator|=
name|true
expr_stmt|;
block|}
block|}
return|return;
block|}
end_function

end_unit


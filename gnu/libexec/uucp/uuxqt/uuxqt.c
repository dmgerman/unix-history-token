begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/* uuxqt.c    Run uux commands.     Copyright (C) 1991, 1992, 1993, 1994, 1995 Ian Lance Taylor     This file is part of the Taylor UUCP package.     This program is free software; you can redistribute it and/or    modify it under the terms of the GNU General Public License as    published by the Free Software Foundation; either version 2 of the    License, or (at your option) any later version.     This program is distributed in the hope that it will be useful, but    WITHOUT ANY WARRANTY; without even the implied warranty of    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU    General Public License for more details.     You should have received a copy of the GNU General Public License    along with this program; if not, write to the Free Software    Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.     The author of the program may be contacted at ian@airs.com or    c/o Cygnus Support, 48 Grove Street, Somerville, MA 02144.    */
end_comment

begin_include
include|#
directive|include
file|"uucp.h"
end_include

begin_if
if|#
directive|if
name|USE_RCS_ID
end_if

begin_decl_stmt
specifier|const
name|char
name|uuxqt_rcsid
index|[]
init|=
literal|"$FreeBSD$"
decl_stmt|;
end_decl_stmt

begin_endif
endif|#
directive|endif
end_endif

begin_include
include|#
directive|include
file|<errno.h>
end_include

begin_include
include|#
directive|include
file|<ctype.h>
end_include

begin_include
include|#
directive|include
file|"getopt.h"
end_include

begin_include
include|#
directive|include
file|"uudefs.h"
end_include

begin_include
include|#
directive|include
file|"uuconf.h"
end_include

begin_include
include|#
directive|include
file|"system.h"
end_include

begin_escape
end_escape

begin_comment
comment|/* Static variables used to unlock things if we get a fatal error.  */
end_comment

begin_decl_stmt
specifier|static
name|int
name|iQlock_seq
init|=
operator|-
literal|1
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
specifier|const
name|char
modifier|*
name|zQunlock_cmd
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
specifier|const
name|char
modifier|*
name|zQunlock_file
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|boolean
name|fQunlock_directory
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|cQmaxuuxqts
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* Static variables to free in uqcleanup.  */
end_comment

begin_decl_stmt
specifier|static
name|char
modifier|*
name|zQoutput
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|char
modifier|*
name|zQmail
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* Local functions.  */
end_comment

begin_decl_stmt
specifier|static
name|void
name|uqusage
name|P
argument_list|(
operator|(
name|void
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|void
name|uqhelp
name|P
argument_list|(
operator|(
name|void
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|void
name|uqabort
name|P
argument_list|(
operator|(
name|void
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|void
name|uqdo_xqt_file
name|P
argument_list|(
operator|(
name|pointer
name|puuconf
operator|,
specifier|const
name|char
operator|*
name|zfile
operator|,
specifier|const
name|char
operator|*
name|zbase
operator|,
specifier|const
expr|struct
name|uuconf_system
operator|*
name|qsys
operator|,
specifier|const
name|char
operator|*
name|zlocalname
operator|,
specifier|const
name|char
operator|*
name|zcmd
operator|,
name|boolean
operator|*
name|pfprocessed
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|void
name|uqcleanup
name|P
argument_list|(
operator|(
specifier|const
name|char
operator|*
name|zfile
operator|,
name|int
name|iflags
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|isave_files
name|P
argument_list|(
operator|(
specifier|const
expr|struct
name|uuconf_system
operator|*
operator|,
specifier|const
name|char
operator|*
name|zmail
operator|,
specifier|const
name|char
operator|*
name|zfile
operator|,
name|int
name|iclean
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|boolean
name|fqforward
name|P
argument_list|(
operator|(
specifier|const
name|char
operator|*
name|zfile
operator|,
name|char
operator|*
operator|*
name|pzallowed
operator|,
specifier|const
name|char
operator|*
name|zlog
operator|,
specifier|const
name|char
operator|*
name|zmail
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_escape
end_escape

begin_comment
comment|/* Long getopt options.  */
end_comment

begin_decl_stmt
specifier|static
specifier|const
name|struct
name|option
name|asQlongopts
index|[]
init|=
block|{
block|{
literal|"command"
block|,
name|required_argument
block|,
literal|0
block|,
literal|'c'
block|}
block|,
block|{
literal|"system"
block|,
name|required_argument
block|,
literal|0
block|,
literal|'s'
block|}
block|,
block|{
literal|"config"
block|,
name|required_argument
block|,
name|NULL
block|,
literal|'I'
block|}
block|,
block|{
literal|"debug"
block|,
name|required_argument
block|,
name|NULL
block|,
literal|'x'
block|}
block|,
block|{
literal|"version"
block|,
name|no_argument
block|,
name|NULL
block|,
literal|'v'
block|}
block|,
block|{
literal|"help"
block|,
name|no_argument
block|,
name|NULL
block|,
literal|1
block|}
block|,
block|{
name|NULL
block|,
literal|0
block|,
name|NULL
block|,
literal|0
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_function
name|int
name|main
parameter_list|(
name|argc
parameter_list|,
name|argv
parameter_list|)
name|int
name|argc
decl_stmt|;
name|char
modifier|*
modifier|*
name|argv
decl_stmt|;
block|{
comment|/* The type of command to execute (NULL for any type).  */
specifier|const
name|char
modifier|*
name|zcmd
init|=
name|NULL
decl_stmt|;
comment|/* The configuration file name.  */
specifier|const
name|char
modifier|*
name|zconfig
init|=
name|NULL
decl_stmt|;
comment|/* The system to execute commands for.  */
specifier|const
name|char
modifier|*
name|zdosys
init|=
name|NULL
decl_stmt|;
name|int
name|iopt
decl_stmt|;
name|pointer
name|puuconf
decl_stmt|;
name|int
name|iuuconf
decl_stmt|;
specifier|const
name|char
modifier|*
name|zlocalname
decl_stmt|;
name|boolean
name|fany
decl_stmt|;
name|char
modifier|*
name|z
decl_stmt|,
modifier|*
name|zgetsys
decl_stmt|;
name|boolean
name|ferr
decl_stmt|;
name|boolean
name|fsys
decl_stmt|;
name|struct
name|uuconf_system
name|ssys
decl_stmt|;
name|zProgram
operator|=
name|argv
index|[
literal|0
index|]
expr_stmt|;
while|while
condition|(
operator|(
name|iopt
operator|=
name|getopt_long
argument_list|(
name|argc
argument_list|,
name|argv
argument_list|,
literal|"c:I:s:vx:"
argument_list|,
name|asQlongopts
argument_list|,
operator|(
name|int
operator|*
operator|)
name|NULL
argument_list|)
operator|)
operator|!=
name|EOF
condition|)
block|{
switch|switch
condition|(
name|iopt
condition|)
block|{
case|case
literal|'c'
case|:
comment|/* Set the type of command to execute.  */
name|zcmd
operator|=
name|optarg
expr_stmt|;
break|break;
case|case
literal|'I'
case|:
comment|/* Set the configuration file name.  */
if|if
condition|(
name|fsysdep_other_config
argument_list|(
name|optarg
argument_list|)
condition|)
name|zconfig
operator|=
name|optarg
expr_stmt|;
break|break;
case|case
literal|'s'
case|:
name|zdosys
operator|=
name|optarg
expr_stmt|;
break|break;
case|case
literal|'x'
case|:
if|#
directive|if
name|DEBUG
operator|>
literal|1
comment|/* Set the debugging level.  */
name|iDebug
operator||=
name|idebug_parse
argument_list|(
name|optarg
argument_list|)
expr_stmt|;
endif|#
directive|endif
break|break;
case|case
literal|'v'
case|:
comment|/* Print version and exit.  */
name|printf
argument_list|(
literal|"%s: Taylor UUCP %s, copyright (C) 1991, 92, 93, 94, 1995 Ian Lance Taylor\n"
argument_list|,
name|zProgram
argument_list|,
name|VERSION
argument_list|)
expr_stmt|;
name|exit
argument_list|(
name|EXIT_SUCCESS
argument_list|)
expr_stmt|;
comment|/*NOTREACHED*/
case|case
literal|1
case|:
comment|/* --help.  */
name|uqhelp
argument_list|()
expr_stmt|;
name|exit
argument_list|(
name|EXIT_SUCCESS
argument_list|)
expr_stmt|;
comment|/*NOTREACHED*/
case|case
literal|0
case|:
comment|/* Long option found and flag set.  */
break|break;
default|default:
name|uqusage
argument_list|()
expr_stmt|;
break|break;
block|}
block|}
if|if
condition|(
name|optind
operator|!=
name|argc
condition|)
name|uqusage
argument_list|()
expr_stmt|;
name|iuuconf
operator|=
name|uuconf_init
argument_list|(
operator|&
name|puuconf
argument_list|,
operator|(
specifier|const
name|char
operator|*
operator|)
name|NULL
argument_list|,
name|zconfig
argument_list|)
expr_stmt|;
if|if
condition|(
name|iuuconf
operator|!=
name|UUCONF_SUCCESS
condition|)
name|ulog_uuconf
argument_list|(
name|LOG_FATAL
argument_list|,
name|puuconf
argument_list|,
name|iuuconf
argument_list|)
expr_stmt|;
if|#
directive|if
name|DEBUG
operator|>
literal|1
block|{
specifier|const
name|char
modifier|*
name|zdebug
decl_stmt|;
name|iuuconf
operator|=
name|uuconf_debuglevel
argument_list|(
name|puuconf
argument_list|,
operator|&
name|zdebug
argument_list|)
expr_stmt|;
if|if
condition|(
name|iuuconf
operator|!=
name|UUCONF_SUCCESS
condition|)
name|ulog_uuconf
argument_list|(
name|LOG_FATAL
argument_list|,
name|puuconf
argument_list|,
name|iuuconf
argument_list|)
expr_stmt|;
if|if
condition|(
name|zdebug
operator|!=
name|NULL
condition|)
name|iDebug
operator||=
name|idebug_parse
argument_list|(
name|zdebug
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
name|iuuconf
operator|=
name|uuconf_maxuuxqts
argument_list|(
name|puuconf
argument_list|,
operator|&
name|cQmaxuuxqts
argument_list|)
expr_stmt|;
if|if
condition|(
name|iuuconf
operator|!=
name|UUCONF_SUCCESS
condition|)
name|ulog_uuconf
argument_list|(
name|LOG_FATAL
argument_list|,
name|puuconf
argument_list|,
name|iuuconf
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|SIGINT
name|usysdep_signal
argument_list|(
name|SIGINT
argument_list|)
expr_stmt|;
endif|#
directive|endif
ifdef|#
directive|ifdef
name|SIGHUP
name|usysdep_signal
argument_list|(
name|SIGHUP
argument_list|)
expr_stmt|;
endif|#
directive|endif
ifdef|#
directive|ifdef
name|SIGQUIT
name|usysdep_signal
argument_list|(
name|SIGQUIT
argument_list|)
expr_stmt|;
endif|#
directive|endif
ifdef|#
directive|ifdef
name|SIGTERM
name|usysdep_signal
argument_list|(
name|SIGTERM
argument_list|)
expr_stmt|;
endif|#
directive|endif
ifdef|#
directive|ifdef
name|SIGPIPE
name|usysdep_signal
argument_list|(
name|SIGPIPE
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|usysdep_initialize
argument_list|(
name|puuconf
argument_list|,
name|INIT_SUID
argument_list|)
expr_stmt|;
name|ulog_to_file
argument_list|(
name|puuconf
argument_list|,
name|TRUE
argument_list|)
expr_stmt|;
name|ulog_fatal_fn
argument_list|(
name|uqabort
argument_list|)
expr_stmt|;
name|iuuconf
operator|=
name|uuconf_localname
argument_list|(
name|puuconf
argument_list|,
operator|&
name|zlocalname
argument_list|)
expr_stmt|;
if|if
condition|(
name|iuuconf
operator|==
name|UUCONF_NOT_FOUND
condition|)
block|{
name|zlocalname
operator|=
name|zsysdep_localname
argument_list|()
expr_stmt|;
if|if
condition|(
name|zlocalname
operator|==
name|NULL
condition|)
name|exit
argument_list|(
name|EXIT_FAILURE
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|iuuconf
operator|!=
name|UUCONF_SUCCESS
condition|)
name|ulog_uuconf
argument_list|(
name|LOG_FATAL
argument_list|,
name|puuconf
argument_list|,
name|iuuconf
argument_list|)
expr_stmt|;
name|fsys
operator|=
name|FALSE
expr_stmt|;
comment|/* If we were given a system name, canonicalize it.  */
if|if
condition|(
name|zdosys
operator|!=
name|NULL
condition|)
block|{
name|iuuconf
operator|=
name|uuconf_system_info
argument_list|(
name|puuconf
argument_list|,
name|zdosys
argument_list|,
operator|&
name|ssys
argument_list|)
expr_stmt|;
if|if
condition|(
name|iuuconf
operator|!=
name|UUCONF_SUCCESS
condition|)
block|{
if|if
condition|(
name|iuuconf
operator|!=
name|UUCONF_NOT_FOUND
condition|)
name|ulog_uuconf
argument_list|(
name|LOG_FATAL
argument_list|,
name|puuconf
argument_list|,
name|iuuconf
argument_list|)
expr_stmt|;
if|if
condition|(
name|strcmp
argument_list|(
name|zdosys
argument_list|,
name|zlocalname
argument_list|)
operator|==
literal|0
condition|)
block|{
name|iuuconf
operator|=
name|uuconf_system_local
argument_list|(
name|puuconf
argument_list|,
operator|&
name|ssys
argument_list|)
expr_stmt|;
if|if
condition|(
name|iuuconf
operator|!=
name|UUCONF_SUCCESS
condition|)
name|ulog_uuconf
argument_list|(
name|LOG_FATAL
argument_list|,
name|puuconf
argument_list|,
name|iuuconf
argument_list|)
expr_stmt|;
name|ssys
operator|.
name|uuconf_zname
operator|=
operator|(
name|char
operator|*
operator|)
name|zlocalname
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
operator|!
name|funknown_system
argument_list|(
name|puuconf
argument_list|,
name|zdosys
argument_list|,
operator|&
name|ssys
argument_list|)
condition|)
name|ulog
argument_list|(
name|LOG_FATAL
argument_list|,
literal|"%s: system not found"
argument_list|,
name|zdosys
argument_list|)
expr_stmt|;
block|}
block|}
name|zdosys
operator|=
name|zbufcpy
argument_list|(
name|ssys
operator|.
name|uuconf_zname
argument_list|)
expr_stmt|;
name|fsys
operator|=
name|TRUE
expr_stmt|;
block|}
comment|/* Limit the number of uuxqt processes, and make sure we're the only      uuxqt daemon running for this command.  */
name|iQlock_seq
operator|=
name|ixsysdep_lock_uuxqt
argument_list|(
name|zcmd
argument_list|,
name|cQmaxuuxqts
argument_list|)
expr_stmt|;
if|if
condition|(
name|iQlock_seq
operator|<
literal|0
condition|)
block|{
name|ulog_close
argument_list|()
expr_stmt|;
name|usysdep_exit
argument_list|(
name|TRUE
argument_list|)
expr_stmt|;
block|}
name|zQunlock_cmd
operator|=
name|zcmd
expr_stmt|;
comment|/* Keep scanning the execute files until we don't process any of      them.  */
do|do
block|{
name|fany
operator|=
name|FALSE
expr_stmt|;
comment|/* Look for each execute file, and run it.  */
if|if
condition|(
operator|!
name|fsysdep_get_xqt_init
argument_list|(
name|zdosys
argument_list|)
condition|)
block|{
name|ulog_close
argument_list|()
expr_stmt|;
name|usysdep_exit
argument_list|(
name|FALSE
argument_list|)
expr_stmt|;
block|}
while|while
condition|(
operator|(
name|z
operator|=
name|zsysdep_get_xqt
argument_list|(
name|zdosys
argument_list|,
operator|&
name|zgetsys
argument_list|,
operator|&
name|ferr
argument_list|)
operator|)
operator|!=
name|NULL
condition|)
block|{
specifier|const
name|char
modifier|*
name|zloc
decl_stmt|;
name|boolean
name|fprocessed
decl_stmt|;
name|char
modifier|*
name|zbase
decl_stmt|;
comment|/* Get the system information for the system returned by 	     zsysdep_get_xqt.  */
if|if
condition|(
operator|!
name|fsys
operator|||
name|strcmp
argument_list|(
name|ssys
operator|.
name|uuconf_zname
argument_list|,
name|zgetsys
argument_list|)
operator|!=
literal|0
condition|)
block|{
if|if
condition|(
name|fsys
condition|)
operator|(
name|void
operator|)
name|uuconf_system_free
argument_list|(
name|puuconf
argument_list|,
operator|&
name|ssys
argument_list|)
expr_stmt|;
name|iuuconf
operator|=
name|uuconf_system_info
argument_list|(
name|puuconf
argument_list|,
name|zgetsys
argument_list|,
operator|&
name|ssys
argument_list|)
expr_stmt|;
if|if
condition|(
name|iuuconf
operator|!=
name|UUCONF_SUCCESS
condition|)
block|{
if|if
condition|(
name|iuuconf
operator|!=
name|UUCONF_NOT_FOUND
condition|)
block|{
name|ulog_uuconf
argument_list|(
name|LOG_ERROR
argument_list|,
name|puuconf
argument_list|,
name|iuuconf
argument_list|)
expr_stmt|;
name|ubuffree
argument_list|(
name|z
argument_list|)
expr_stmt|;
name|ubuffree
argument_list|(
name|zgetsys
argument_list|)
expr_stmt|;
continue|continue;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|zgetsys
argument_list|,
name|zlocalname
argument_list|)
operator|==
literal|0
condition|)
block|{
name|iuuconf
operator|=
name|uuconf_system_local
argument_list|(
name|puuconf
argument_list|,
operator|&
name|ssys
argument_list|)
expr_stmt|;
if|if
condition|(
name|iuuconf
operator|!=
name|UUCONF_SUCCESS
condition|)
block|{
name|ulog_uuconf
argument_list|(
name|LOG_ERROR
argument_list|,
name|puuconf
argument_list|,
name|iuuconf
argument_list|)
expr_stmt|;
name|ubuffree
argument_list|(
name|z
argument_list|)
expr_stmt|;
name|ubuffree
argument_list|(
name|zgetsys
argument_list|)
expr_stmt|;
continue|continue;
block|}
name|ssys
operator|.
name|uuconf_zname
operator|=
operator|(
name|char
operator|*
operator|)
name|zlocalname
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
operator|!
name|funknown_system
argument_list|(
name|puuconf
argument_list|,
name|zgetsys
argument_list|,
operator|&
name|ssys
argument_list|)
condition|)
block|{
name|ulog
argument_list|(
name|LOG_ERROR
argument_list|,
literal|"%s: Execute file for unknown system %s"
argument_list|,
name|z
argument_list|,
name|zgetsys
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|remove
argument_list|(
name|z
argument_list|)
expr_stmt|;
name|ubuffree
argument_list|(
name|z
argument_list|)
expr_stmt|;
name|ubuffree
argument_list|(
name|zgetsys
argument_list|)
expr_stmt|;
continue|continue;
block|}
block|}
block|}
name|fsys
operator|=
name|TRUE
expr_stmt|;
block|}
comment|/* If we've received a signal, get out of the loop.  */
if|if
condition|(
name|FGOT_SIGNAL
argument_list|()
condition|)
block|{
name|ubuffree
argument_list|(
name|z
argument_list|)
expr_stmt|;
name|ubuffree
argument_list|(
name|zgetsys
argument_list|)
expr_stmt|;
break|break;
block|}
comment|/* Make sure we are supposed to be executing jobs for this 	     system.  */
if|if
condition|(
name|zdosys
operator|!=
name|NULL
operator|&&
name|strcmp
argument_list|(
name|zdosys
argument_list|,
name|ssys
operator|.
name|uuconf_zname
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|ubuffree
argument_list|(
name|z
argument_list|)
expr_stmt|;
name|ubuffree
argument_list|(
name|zgetsys
argument_list|)
expr_stmt|;
continue|continue;
block|}
name|zloc
operator|=
name|ssys
operator|.
name|uuconf_zlocalname
expr_stmt|;
if|if
condition|(
name|zloc
operator|==
name|NULL
condition|)
name|zloc
operator|=
name|zlocalname
expr_stmt|;
name|ulog_system
argument_list|(
name|ssys
operator|.
name|uuconf_zname
argument_list|)
expr_stmt|;
name|zbase
operator|=
name|zsysdep_base_name
argument_list|(
name|z
argument_list|)
expr_stmt|;
name|uqdo_xqt_file
argument_list|(
name|puuconf
argument_list|,
name|z
argument_list|,
name|zbase
argument_list|,
operator|&
name|ssys
argument_list|,
name|zloc
argument_list|,
name|zcmd
argument_list|,
operator|&
name|fprocessed
argument_list|)
expr_stmt|;
name|ubuffree
argument_list|(
name|zbase
argument_list|)
expr_stmt|;
name|ulog_system
argument_list|(
operator|(
specifier|const
name|char
operator|*
operator|)
name|NULL
argument_list|)
expr_stmt|;
name|ulog_user
argument_list|(
operator|(
specifier|const
name|char
operator|*
operator|)
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|fprocessed
condition|)
name|fany
operator|=
name|TRUE
expr_stmt|;
name|ubuffree
argument_list|(
name|z
argument_list|)
expr_stmt|;
name|ubuffree
argument_list|(
name|zgetsys
argument_list|)
expr_stmt|;
block|}
name|usysdep_get_xqt_free
argument_list|(
name|zdosys
argument_list|)
expr_stmt|;
block|}
do|while
condition|(
name|fany
operator|&&
operator|!
name|FGOT_SIGNAL
argument_list|()
condition|)
do|;
operator|(
name|void
operator|)
name|fsysdep_unlock_uuxqt
argument_list|(
name|iQlock_seq
argument_list|,
name|zcmd
argument_list|,
name|cQmaxuuxqts
argument_list|)
expr_stmt|;
name|iQlock_seq
operator|=
operator|-
literal|1
expr_stmt|;
name|ulog_close
argument_list|()
expr_stmt|;
if|if
condition|(
name|FGOT_SIGNAL
argument_list|()
condition|)
name|ferr
operator|=
name|TRUE
expr_stmt|;
name|usysdep_exit
argument_list|(
operator|!
name|ferr
argument_list|)
expr_stmt|;
comment|/* Avoid errors about not returning a value.  */
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|uqhelp
parameter_list|()
block|{
name|printf
argument_list|(
literal|"Taylor UUCP %s, copyright (C) 1991, 92, 93, 94, 1995 Ian Lance Taylor\n"
argument_list|,
name|VERSION
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Usage: %s [-c,--command cmd] [-s,--system system]\n"
argument_list|,
name|zProgram
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|" -c,--command cmd: Set type of command to execute\n"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|" -s,--system system: Execute commands only for named system\n"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|" -x,--debug debug: Set debugging level\n"
argument_list|)
expr_stmt|;
if|#
directive|if
name|HAVE_TAYLOR_CONFIG
name|printf
argument_list|(
literal|" -I,--config file: Set configuration file to use\n"
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* HAVE_TAYLOR_CONFIG */
name|printf
argument_list|(
literal|" -v,--version: Print version and exit\n"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|" --help: Print help and exit\n"
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|uqusage
parameter_list|()
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Usage: %s [-c,--command cmd] [-s,--system system]\n"
argument_list|,
name|zProgram
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Use %s --help for help\n"
argument_list|,
name|zProgram
argument_list|)
expr_stmt|;
name|exit
argument_list|(
name|EXIT_FAILURE
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* This is the abort function called when we get a fatal error.  */
end_comment

begin_function
specifier|static
name|void
name|uqabort
parameter_list|()
block|{
if|#
directive|if
operator|!
name|HAVE_HDB_LOGGING
comment|/* When using HDB logging, it's a pain to have no system name.  */
name|ulog_system
argument_list|(
operator|(
specifier|const
name|char
operator|*
operator|)
name|NULL
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|ulog_user
argument_list|(
operator|(
specifier|const
name|char
operator|*
operator|)
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|fQunlock_directory
condition|)
operator|(
name|void
operator|)
name|fsysdep_unlock_uuxqt_dir
argument_list|(
name|iQlock_seq
argument_list|)
expr_stmt|;
if|if
condition|(
name|zQunlock_file
operator|!=
name|NULL
condition|)
operator|(
name|void
operator|)
name|fsysdep_unlock_uuxqt_file
argument_list|(
name|zQunlock_file
argument_list|)
expr_stmt|;
if|if
condition|(
name|iQlock_seq
operator|>=
literal|0
condition|)
operator|(
name|void
operator|)
name|fsysdep_unlock_uuxqt
argument_list|(
name|iQlock_seq
argument_list|,
name|zQunlock_cmd
argument_list|,
name|cQmaxuuxqts
argument_list|)
expr_stmt|;
name|ulog_close
argument_list|()
expr_stmt|;
name|usysdep_exit
argument_list|(
name|FALSE
argument_list|)
expr_stmt|;
block|}
end_function

begin_escape
end_escape

begin_comment
comment|/* An execute file is a series of lines.  The first character of each    line is a command.  The following commands are defined:     C command-line    I standard-input    O standard-output [ system ]    F required-file filename-to-use    R requestor-address    U user system    Z (acknowledge if command failed; default)    N (no acknowledgement on failure)    n (acknowledge if command succeeded)    B (return command input on error)    e (process with sh)    E (process with exec)    M status-file    # comment     Unrecognized commands are ignored.  We actually do not recognize    the Z command, since it requests default behaviour.  We always send    mail on failure, unless the N command appears.  We never send mail    on success, unless the n command appears.     This code does not currently support the B or M commands.  */
end_comment

begin_comment
comment|/* Command arguments.  */
end_comment

begin_decl_stmt
specifier|static
name|char
modifier|*
modifier|*
name|azQargs
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* Command as a complete string.  */
end_comment

begin_decl_stmt
specifier|static
name|char
modifier|*
name|zQcmd
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* Standard input file name.  */
end_comment

begin_decl_stmt
specifier|static
name|char
modifier|*
name|zQinput
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* Standard output file name.  */
end_comment

begin_decl_stmt
specifier|static
name|char
modifier|*
name|zQoutfile
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* Standard output system.  */
end_comment

begin_decl_stmt
specifier|static
name|char
modifier|*
name|zQoutsys
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* Number of required files.  */
end_comment

begin_decl_stmt
specifier|static
name|int
name|cQfiles
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* Names of required files.  */
end_comment

begin_decl_stmt
specifier|static
name|char
modifier|*
modifier|*
name|azQfiles
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* Names required files should be renamed to (NULL if original is OK).  */
end_comment

begin_decl_stmt
specifier|static
name|char
modifier|*
modifier|*
name|azQfiles_to
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* Requestor address (this is where mail should be sent).  */
end_comment

begin_decl_stmt
specifier|static
name|char
modifier|*
name|zQrequestor
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* User name.  */
end_comment

begin_decl_stmt
specifier|static
specifier|const
name|char
modifier|*
name|zQuser
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* System name.  */
end_comment

begin_decl_stmt
specifier|static
specifier|const
name|char
modifier|*
name|zQsystem
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* This is set by the N flag, meaning that no acknowledgement should    be mailed on failure.  */
end_comment

begin_decl_stmt
specifier|static
name|boolean
name|fQno_ack
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* This is set by the n flag, meaning that acknowledgement should be    mailed if the command succeeded.  */
end_comment

begin_decl_stmt
specifier|static
name|boolean
name|fQsuccess_ack
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* This is set by the B flag, meaning that command input should be    mailed to the requestor if an error occurred.  */
end_comment

begin_decl_stmt
specifier|static
name|boolean
name|fQsend_input
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* This is set by the E flag, meaning that exec should be used to    execute the command.  */
end_comment

begin_decl_stmt
specifier|static
name|boolean
name|fQuse_exec
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* The status should be copied to this file on the requesting host.  */
end_comment

begin_decl_stmt
specifier|static
specifier|const
name|char
modifier|*
name|zQstatus_file
decl_stmt|;
end_decl_stmt

begin_if
if|#
directive|if
name|ALLOW_SH_EXECUTION
end_if

begin_comment
comment|/* This is set by the e flag, meaning that sh should be used to    execute the command.  */
end_comment

begin_decl_stmt
specifier|static
name|boolean
name|fQuse_sh
decl_stmt|;
end_decl_stmt

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* ALLOW_SH_EXECUTION */
end_comment

begin_decl_stmt
specifier|static
name|int
name|iqcmd
name|P
argument_list|(
operator|(
name|pointer
name|puuconf
operator|,
name|int
name|argc
operator|,
name|char
operator|*
operator|*
name|argv
operator|,
name|pointer
name|pvar
operator|,
name|pointer
name|pinfo
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|iqout
name|P
argument_list|(
operator|(
name|pointer
name|puuconf
operator|,
name|int
name|argc
operator|,
name|char
operator|*
operator|*
name|argv
operator|,
name|pointer
name|pvar
operator|,
name|pointer
name|pinfo
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|iqfile
name|P
argument_list|(
operator|(
name|pointer
name|puuconf
operator|,
name|int
name|argc
operator|,
name|char
operator|*
operator|*
name|argv
operator|,
name|pointer
name|pvar
operator|,
name|pointer
name|pinfo
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|iqrequestor
name|P
argument_list|(
operator|(
name|pointer
name|puuconf
operator|,
name|int
name|argc
operator|,
name|char
operator|*
operator|*
name|argv
operator|,
name|pointer
name|pvar
operator|,
name|pointer
name|pinfo
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|iquser
name|P
argument_list|(
operator|(
name|pointer
name|puuconf
operator|,
name|int
name|argc
operator|,
name|char
operator|*
operator|*
name|argv
operator|,
name|pointer
name|pvar
operator|,
name|pointer
name|pinfo
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|iqset
name|P
argument_list|(
operator|(
name|pointer
name|puuconf
operator|,
name|int
name|argc
operator|,
name|char
operator|*
operator|*
name|argv
operator|,
name|pointer
name|pvar
operator|,
name|pointer
name|pinfo
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* We are lax about the number of arguments the functions accept,    because there is a lot of variation in what other (buggy) UUCP    packages generate.  Unused arguments are ignored.  */
end_comment

begin_decl_stmt
specifier|static
specifier|const
name|struct
name|uuconf_cmdtab
name|asQcmds
index|[]
init|=
block|{
block|{
literal|"C"
block|,
name|UUCONF_CMDTABTYPE_FN
operator||
literal|0
block|,
name|NULL
block|,
name|iqcmd
block|}
block|,
block|{
literal|"I"
block|,
name|UUCONF_CMDTABTYPE_STRING
block|,
operator|(
name|pointer
operator|)
operator|&
name|zQinput
block|,
name|NULL
block|}
block|,
block|{
literal|"O"
block|,
name|UUCONF_CMDTABTYPE_FN
operator||
literal|0
block|,
name|NULL
block|,
name|iqout
block|}
block|,
block|{
literal|"F"
block|,
name|UUCONF_CMDTABTYPE_FN
operator||
literal|0
block|,
name|NULL
block|,
name|iqfile
block|}
block|,
block|{
literal|"R"
block|,
name|UUCONF_CMDTABTYPE_FN
operator||
literal|0
block|,
name|NULL
block|,
name|iqrequestor
block|}
block|,
block|{
literal|"U"
block|,
name|UUCONF_CMDTABTYPE_FN
operator||
literal|0
block|,
name|NULL
block|,
name|iquser
block|}
block|,
block|{
literal|"N"
block|,
name|UUCONF_CMDTABTYPE_FN
operator||
literal|0
block|,
operator|(
name|pointer
operator|)
operator|&
name|fQno_ack
block|,
name|iqset
block|}
block|,
block|{
literal|"n"
block|,
name|UUCONF_CMDTABTYPE_FN
operator||
literal|0
block|,
operator|(
name|pointer
operator|)
operator|&
name|fQsuccess_ack
block|,
name|iqset
block|}
block|,
block|{
literal|"B"
block|,
name|UUCONF_CMDTABTYPE_FN
operator||
literal|0
block|,
operator|(
name|pointer
operator|)
operator|&
name|fQsend_input
block|,
name|iqset
block|}
block|,
if|#
directive|if
name|ALLOW_SH_EXECUTION
block|{
literal|"e"
block|,
name|UUCONF_CMDTABTYPE_FN
operator||
literal|0
block|,
operator|(
name|pointer
operator|)
operator|&
name|fQuse_sh
block|,
name|iqset
block|}
block|,
endif|#
directive|endif
block|{
literal|"E"
block|,
name|UUCONF_CMDTABTYPE_FN
operator||
literal|0
block|,
operator|(
name|pointer
operator|)
operator|&
name|fQuse_exec
block|,
name|iqset
block|}
block|,
block|{
literal|"M"
block|,
name|UUCONF_CMDTABTYPE_STRING
block|,
operator|(
name|pointer
operator|)
operator|&
name|zQstatus_file
block|,
name|NULL
block|}
block|,
block|{
name|NULL
block|,
literal|0
block|,
name|NULL
block|,
name|NULL
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* Handle the C command: store off the arguments.  */
end_comment

begin_comment
comment|/*ARGSUSED*/
end_comment

begin_function
specifier|static
name|int
name|iqcmd
parameter_list|(
name|puuconf
parameter_list|,
name|argc
parameter_list|,
name|argv
parameter_list|,
name|pvar
parameter_list|,
name|pinfo
parameter_list|)
name|pointer
name|puuconf
decl_stmt|;
name|int
name|argc
decl_stmt|;
name|char
modifier|*
modifier|*
name|argv
decl_stmt|;
name|pointer
name|pvar
decl_stmt|;
name|pointer
name|pinfo
decl_stmt|;
block|{
name|int
name|i
decl_stmt|;
name|size_t
name|clen
decl_stmt|;
if|if
condition|(
name|argc
operator|<=
literal|1
condition|)
return|return
name|UUCONF_CMDTABRET_CONTINUE
return|;
name|azQargs
operator|=
operator|(
name|char
operator|*
operator|*
operator|)
name|xmalloc
argument_list|(
name|argc
operator|*
sizeof|sizeof
argument_list|(
name|char
operator|*
argument_list|)
argument_list|)
expr_stmt|;
name|clen
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|1
init|;
name|i
operator|<
name|argc
condition|;
name|i
operator|++
control|)
block|{
name|azQargs
index|[
name|i
operator|-
literal|1
index|]
operator|=
name|zbufcpy
argument_list|(
name|argv
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|clen
operator|+=
name|strlen
argument_list|(
name|argv
index|[
name|i
index|]
argument_list|)
operator|+
literal|1
expr_stmt|;
block|}
name|azQargs
index|[
name|i
operator|-
literal|1
index|]
operator|=
name|NULL
expr_stmt|;
name|zQcmd
operator|=
operator|(
name|char
operator|*
operator|)
name|xmalloc
argument_list|(
name|clen
argument_list|)
expr_stmt|;
name|zQcmd
index|[
literal|0
index|]
operator|=
literal|'\0'
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|1
init|;
name|i
operator|<
name|argc
operator|-
literal|1
condition|;
name|i
operator|++
control|)
block|{
name|strcat
argument_list|(
name|zQcmd
argument_list|,
name|argv
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|strcat
argument_list|(
name|zQcmd
argument_list|,
literal|" "
argument_list|)
expr_stmt|;
block|}
name|strcat
argument_list|(
name|zQcmd
argument_list|,
name|argv
index|[
name|i
index|]
argument_list|)
expr_stmt|;
return|return
name|UUCONF_CMDTABRET_CONTINUE
return|;
block|}
end_function

begin_comment
comment|/* Handle the O command, which may have one or two arguments.  */
end_comment

begin_comment
comment|/*ARGSUSED*/
end_comment

begin_function
specifier|static
name|int
name|iqout
parameter_list|(
name|puuconf
parameter_list|,
name|argc
parameter_list|,
name|argv
parameter_list|,
name|pvar
parameter_list|,
name|pinfo
parameter_list|)
name|pointer
name|puuconf
decl_stmt|;
name|int
name|argc
decl_stmt|;
name|char
modifier|*
modifier|*
name|argv
decl_stmt|;
name|pointer
name|pvar
decl_stmt|;
name|pointer
name|pinfo
decl_stmt|;
block|{
if|if
condition|(
name|argc
operator|>
literal|1
condition|)
name|zQoutfile
operator|=
name|zbufcpy
argument_list|(
name|argv
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|argc
operator|>
literal|2
condition|)
name|zQoutsys
operator|=
name|zbufcpy
argument_list|(
name|argv
index|[
literal|2
index|]
argument_list|)
expr_stmt|;
return|return
name|UUCONF_CMDTABRET_CONTINUE
return|;
block|}
end_function

begin_comment
comment|/* Handle the F command, which may have one or two arguments.  */
end_comment

begin_comment
comment|/*ARGSUSED*/
end_comment

begin_function
specifier|static
name|int
name|iqfile
parameter_list|(
name|puuconf
parameter_list|,
name|argc
parameter_list|,
name|argv
parameter_list|,
name|pvar
parameter_list|,
name|pinfo
parameter_list|)
name|pointer
name|puuconf
decl_stmt|;
name|int
name|argc
decl_stmt|;
name|char
modifier|*
modifier|*
name|argv
decl_stmt|;
name|pointer
name|pvar
decl_stmt|;
name|pointer
name|pinfo
decl_stmt|;
block|{
if|if
condition|(
name|argc
operator|<
literal|2
condition|)
return|return
name|UUCONF_CMDTABRET_CONTINUE
return|;
comment|/* If this file is not in the spool directory, just ignore it.  */
if|if
condition|(
operator|!
name|fspool_file
argument_list|(
name|argv
index|[
literal|1
index|]
argument_list|)
condition|)
return|return
name|UUCONF_CMDTABRET_CONTINUE
return|;
operator|++
name|cQfiles
expr_stmt|;
name|azQfiles
operator|=
operator|(
name|char
operator|*
operator|*
operator|)
name|xrealloc
argument_list|(
operator|(
name|pointer
operator|)
name|azQfiles
argument_list|,
name|cQfiles
operator|*
sizeof|sizeof
argument_list|(
name|char
operator|*
argument_list|)
argument_list|)
expr_stmt|;
name|azQfiles_to
operator|=
operator|(
name|char
operator|*
operator|*
operator|)
name|xrealloc
argument_list|(
operator|(
name|pointer
operator|)
name|azQfiles_to
argument_list|,
name|cQfiles
operator|*
sizeof|sizeof
argument_list|(
name|char
operator|*
argument_list|)
argument_list|)
expr_stmt|;
name|azQfiles
index|[
name|cQfiles
operator|-
literal|1
index|]
operator|=
name|zbufcpy
argument_list|(
name|argv
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|argc
operator|>
literal|2
condition|)
name|azQfiles_to
index|[
name|cQfiles
operator|-
literal|1
index|]
operator|=
name|zbufcpy
argument_list|(
name|argv
index|[
literal|2
index|]
argument_list|)
expr_stmt|;
else|else
name|azQfiles_to
index|[
name|cQfiles
operator|-
literal|1
index|]
operator|=
name|NULL
expr_stmt|;
return|return
name|UUCONF_CMDTABRET_CONTINUE
return|;
block|}
end_function

begin_comment
comment|/* Handle the R command, which may have one or two arguments.  */
end_comment

begin_comment
comment|/*ARGSUSED*/
end_comment

begin_function
specifier|static
name|int
name|iqrequestor
parameter_list|(
name|puuconf
parameter_list|,
name|argc
parameter_list|,
name|argv
parameter_list|,
name|pvar
parameter_list|,
name|pinfo
parameter_list|)
name|pointer
name|puuconf
decl_stmt|;
name|int
name|argc
decl_stmt|;
name|char
modifier|*
modifier|*
name|argv
decl_stmt|;
name|pointer
name|pvar
decl_stmt|;
name|pointer
name|pinfo
decl_stmt|;
block|{
comment|/* We normally have a single argument, which is the ``requestor''      address, to which we should send any success or error messages.      Apparently the DOS program UUPC sends two arguments, which are      the username and the host.  */
if|if
condition|(
name|argc
operator|==
literal|2
condition|)
name|zQrequestor
operator|=
name|zbufcpy
argument_list|(
name|argv
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|argc
operator|>
literal|2
condition|)
block|{
name|zQrequestor
operator|=
name|zbufalc
argument_list|(
name|strlen
argument_list|(
name|argv
index|[
literal|1
index|]
argument_list|)
operator|+
name|strlen
argument_list|(
name|argv
index|[
literal|2
index|]
argument_list|)
operator|+
sizeof|sizeof
expr|"!"
argument_list|)
expr_stmt|;
name|sprintf
argument_list|(
name|zQrequestor
argument_list|,
literal|"%s!%s"
argument_list|,
name|argv
index|[
literal|2
index|]
argument_list|,
name|argv
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
block|}
return|return
name|UUCONF_CMDTABRET_CONTINUE
return|;
block|}
end_function

begin_comment
comment|/* Handle the U command, which takes two arguments.  */
end_comment

begin_comment
comment|/*ARGSUSED*/
end_comment

begin_function
specifier|static
name|int
name|iquser
parameter_list|(
name|puuconf
parameter_list|,
name|argc
parameter_list|,
name|argv
parameter_list|,
name|pvar
parameter_list|,
name|pinfo
parameter_list|)
name|pointer
name|puuconf
decl_stmt|;
name|int
name|argc
decl_stmt|;
name|char
modifier|*
modifier|*
name|argv
decl_stmt|;
name|pointer
name|pvar
decl_stmt|;
name|pointer
name|pinfo
decl_stmt|;
block|{
if|if
condition|(
name|argc
operator|>
literal|1
condition|)
name|zQuser
operator|=
name|argv
index|[
literal|1
index|]
expr_stmt|;
if|if
condition|(
name|argc
operator|>
literal|2
condition|)
name|zQsystem
operator|=
name|argv
index|[
literal|2
index|]
expr_stmt|;
return|return
name|UUCONF_CMDTABRET_KEEP
return|;
block|}
end_function

begin_comment
comment|/* Handle various commands which just set boolean variables.  */
end_comment

begin_comment
comment|/*ARGSUSED*/
end_comment

begin_function
specifier|static
name|int
name|iqset
parameter_list|(
name|puuconf
parameter_list|,
name|argc
parameter_list|,
name|argv
parameter_list|,
name|pvar
parameter_list|,
name|pinfo
parameter_list|)
name|pointer
name|puuconf
decl_stmt|;
name|int
name|argc
decl_stmt|;
name|char
modifier|*
modifier|*
name|argv
decl_stmt|;
name|pointer
name|pvar
decl_stmt|;
name|pointer
name|pinfo
decl_stmt|;
block|{
name|boolean
modifier|*
name|pf
init|=
operator|(
name|boolean
operator|*
operator|)
name|pvar
decl_stmt|;
operator|*
name|pf
operator|=
name|TRUE
expr_stmt|;
return|return
name|UUCONF_CMDTABRET_CONTINUE
return|;
block|}
end_function

begin_escape
end_escape

begin_comment
comment|/* The execution processing does a lot of things that have to be    cleaned up.  Rather than try to add the appropriate statements    to each return point, we keep a set of flags indicating what    has to be cleaned up.  The actual clean up is done by the    function uqcleanup.  */
end_comment

begin_define
define|#
directive|define
name|REMOVE_FILE
value|(01)
end_define

begin_define
define|#
directive|define
name|REMOVE_NEEDED
value|(02)
end_define

begin_define
define|#
directive|define
name|FREE_QINPUT
value|(04)
end_define

begin_define
define|#
directive|define
name|REMOVE_QINPUT
value|(010)
end_define

begin_define
define|#
directive|define
name|FREE_OUTPUT
value|(020)
end_define

begin_define
define|#
directive|define
name|FREE_MAIL
value|(040)
end_define

begin_comment
comment|/* Process an execute file.  The zfile argument is the name of the    execute file.  The zbase argument is the base name of zfile.  The    qsys argument describes the system it came from.  The zcmd argument    is the name of the command we are executing (from the -c option) or    NULL if any command is OK.  This sets *pfprocessed to TRUE if the    file is ready to be executed.  */
end_comment

begin_function
specifier|static
name|void
name|uqdo_xqt_file
parameter_list|(
name|puuconf
parameter_list|,
name|zfile
parameter_list|,
name|zbase
parameter_list|,
name|qsys
parameter_list|,
name|zlocalname
parameter_list|,
name|zcmd
parameter_list|,
name|pfprocessed
parameter_list|)
name|pointer
name|puuconf
decl_stmt|;
specifier|const
name|char
modifier|*
name|zfile
decl_stmt|;
specifier|const
name|char
modifier|*
name|zbase
decl_stmt|;
specifier|const
name|struct
name|uuconf_system
modifier|*
name|qsys
decl_stmt|;
specifier|const
name|char
modifier|*
name|zlocalname
decl_stmt|;
specifier|const
name|char
modifier|*
name|zcmd
decl_stmt|;
name|boolean
modifier|*
name|pfprocessed
decl_stmt|;
block|{
name|char
modifier|*
name|zabsolute
decl_stmt|;
name|boolean
name|ferr
decl_stmt|;
name|FILE
modifier|*
name|e
decl_stmt|;
name|int
name|iuuconf
decl_stmt|;
name|int
name|i
decl_stmt|;
name|int
name|iclean
decl_stmt|;
specifier|const
name|char
modifier|*
name|zmail
decl_stmt|;
name|char
modifier|*
name|zoutput
decl_stmt|;
name|char
modifier|*
name|zinput
decl_stmt|;
name|boolean
name|fbadname
decl_stmt|;
name|char
name|abtemp
index|[
name|CFILE_NAME_LEN
index|]
decl_stmt|;
name|char
name|abdata
index|[
name|CFILE_NAME_LEN
index|]
decl_stmt|;
name|char
modifier|*
name|zerror
decl_stmt|;
name|struct
name|uuconf_system
name|soutsys
decl_stmt|;
specifier|const
name|struct
name|uuconf_system
modifier|*
name|qoutsys
decl_stmt|;
name|boolean
name|fshell
decl_stmt|;
name|size_t
name|clen
decl_stmt|;
name|char
modifier|*
name|zfullcmd
decl_stmt|;
name|boolean
name|ftemp
decl_stmt|;
operator|*
name|pfprocessed
operator|=
name|FALSE
expr_stmt|;
name|e
operator|=
name|fopen
argument_list|(
name|zfile
argument_list|,
literal|"r"
argument_list|)
expr_stmt|;
if|if
condition|(
name|e
operator|==
name|NULL
condition|)
return|return;
name|azQargs
operator|=
name|NULL
expr_stmt|;
name|zQcmd
operator|=
name|NULL
expr_stmt|;
name|zQinput
operator|=
name|NULL
expr_stmt|;
name|zQoutfile
operator|=
name|NULL
expr_stmt|;
name|zQoutsys
operator|=
name|NULL
expr_stmt|;
name|cQfiles
operator|=
literal|0
expr_stmt|;
name|azQfiles
operator|=
name|NULL
expr_stmt|;
name|azQfiles_to
operator|=
name|NULL
expr_stmt|;
name|zQrequestor
operator|=
name|NULL
expr_stmt|;
name|zQuser
operator|=
name|NULL
expr_stmt|;
name|zQsystem
operator|=
name|NULL
expr_stmt|;
name|fQno_ack
operator|=
name|FALSE
expr_stmt|;
name|fQsuccess_ack
operator|=
name|FALSE
expr_stmt|;
name|fQsend_input
operator|=
name|FALSE
expr_stmt|;
name|fQuse_exec
operator|=
name|FALSE
expr_stmt|;
name|zQstatus_file
operator|=
name|NULL
expr_stmt|;
if|#
directive|if
name|ALLOW_SH_EXECUTION
name|fQuse_sh
operator|=
name|FALSE
expr_stmt|;
endif|#
directive|endif
name|iuuconf
operator|=
name|uuconf_cmd_file
argument_list|(
name|puuconf
argument_list|,
name|e
argument_list|,
name|asQcmds
argument_list|,
operator|(
name|pointer
operator|)
name|zbase
argument_list|,
operator|(
name|uuconf_cmdtabfn
operator|)
name|NULL
argument_list|,
operator|(
name|UUCONF_CMDTABFLAG_CASE
operator||
name|UUCONF_CMDTABFLAG_NOCOMMENTS
operator|)
argument_list|,
operator|(
name|pointer
operator|)
name|NULL
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|fclose
argument_list|(
name|e
argument_list|)
expr_stmt|;
if|if
condition|(
name|iuuconf
operator|!=
name|UUCONF_SUCCESS
condition|)
block|{
name|ulog_uuconf
argument_list|(
name|LOG_ERROR
argument_list|,
name|puuconf
argument_list|,
name|iuuconf
argument_list|)
expr_stmt|;
comment|/* If we got a non-transient error, we notify the administrator. 	 We can't bounce it back to the original requestor, because we 	 don't know how to read the file to figure out who it is (it 	 would probably be possible to read the file and work it out, 	 but it doesn't seem worth it for such an unlikely error).  */
if|if
condition|(
name|UUCONF_ERROR_VALUE
argument_list|(
name|iuuconf
argument_list|)
operator|==
name|UUCONF_SYNTAX_ERROR
operator|||
name|UUCONF_ERROR_VALUE
argument_list|(
name|iuuconf
argument_list|)
operator|==
name|UUCONF_UNKNOWN_COMMAND
condition|)
block|{
specifier|const
name|char
modifier|*
name|az
index|[
literal|20
index|]
decl_stmt|;
name|char
modifier|*
name|znew
decl_stmt|;
name|i
operator|=
literal|0
expr_stmt|;
name|az
index|[
name|i
operator|++
index|]
operator|=
literal|"The execution file\n\t"
expr_stmt|;
name|az
index|[
name|i
operator|++
index|]
operator|=
name|zfile
expr_stmt|;
name|az
index|[
name|i
operator|++
index|]
operator|=
literal|"\nfor system\n\t"
expr_stmt|;
name|az
index|[
name|i
operator|++
index|]
operator|=
name|qsys
operator|->
name|uuconf_zname
expr_stmt|;
name|az
index|[
name|i
operator|++
index|]
operator|=
literal|"\nwas corrupt.  "
expr_stmt|;
name|znew
operator|=
name|zsysdep_save_corrupt_file
argument_list|(
name|zfile
argument_list|)
expr_stmt|;
if|if
condition|(
name|znew
operator|==
name|NULL
condition|)
block|{
name|az
index|[
name|i
operator|++
index|]
operator|=
literal|"The file could not be preserved.\n"
expr_stmt|;
operator|(
name|void
operator|)
name|remove
argument_list|(
name|zfile
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|az
index|[
name|i
operator|++
index|]
operator|=
literal|"It has been moved to\n\t"
expr_stmt|;
name|az
index|[
name|i
operator|++
index|]
operator|=
name|znew
expr_stmt|;
name|az
index|[
name|i
operator|++
index|]
operator|=
literal|"\n"
expr_stmt|;
block|}
operator|(
name|void
operator|)
name|fsysdep_mail
argument_list|(
name|OWNER
argument_list|,
literal|"Corrupt execution file"
argument_list|,
name|i
argument_list|,
name|az
argument_list|)
expr_stmt|;
name|ubuffree
argument_list|(
name|znew
argument_list|)
expr_stmt|;
block|}
return|return;
block|}
name|iclean
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|azQargs
operator|==
name|NULL
condition|)
block|{
name|ulog
argument_list|(
name|LOG_ERROR
argument_list|,
literal|"%s: No command given"
argument_list|,
name|zbase
argument_list|)
expr_stmt|;
name|uqcleanup
argument_list|(
name|zfile
argument_list|,
name|iclean
operator||
name|REMOVE_FILE
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|zcmd
operator|!=
name|NULL
condition|)
block|{
if|if
condition|(
name|strcmp
argument_list|(
name|zcmd
argument_list|,
name|azQargs
index|[
literal|0
index|]
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|uqcleanup
argument_list|(
name|zfile
argument_list|,
name|iclean
argument_list|)
expr_stmt|;
return|return;
block|}
block|}
else|else
block|{
comment|/* If there is a lock file for this particular command already, 	 it means that some other uuxqt is supposed to handle it.  */
if|if
condition|(
name|fsysdep_uuxqt_locked
argument_list|(
name|azQargs
index|[
literal|0
index|]
argument_list|)
condition|)
block|{
name|uqcleanup
argument_list|(
name|zfile
argument_list|,
name|iclean
argument_list|)
expr_stmt|;
return|return;
block|}
block|}
comment|/* Lock this particular file.  */
if|if
condition|(
operator|!
name|fsysdep_lock_uuxqt_file
argument_list|(
name|zfile
argument_list|)
condition|)
block|{
name|uqcleanup
argument_list|(
name|zfile
argument_list|,
name|iclean
argument_list|)
expr_stmt|;
return|return;
block|}
name|zQunlock_file
operator|=
name|zfile
expr_stmt|;
comment|/* Now that we have the file locked, make sure it still exists.      Otherwise another uuxqt could have just finished processing it      and removed the lock file.  */
if|if
condition|(
operator|!
name|fsysdep_file_exists
argument_list|(
name|zfile
argument_list|)
condition|)
block|{
name|uqcleanup
argument_list|(
name|zfile
argument_list|,
name|iclean
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|zQuser
operator|!=
name|NULL
condition|)
name|ulog_user
argument_list|(
name|zQuser
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|zQrequestor
operator|!=
name|NULL
condition|)
name|ulog_user
argument_list|(
name|zQrequestor
argument_list|)
expr_stmt|;
else|else
name|ulog_user
argument_list|(
literal|"unknown"
argument_list|)
expr_stmt|;
comment|/* zQsystem, if it is set, comes from the execution file, which      means that we do not trust it.  We only retain it if      qsys->uuconf_zname is a prefix of it, since that can happen with      a job from an anonymous system on certain spool directory types,      and is unlikely to cause any trouble anyhow.  */
if|if
condition|(
name|zQsystem
operator|==
name|NULL
operator|||
name|strncmp
argument_list|(
name|zQsystem
argument_list|,
name|qsys
operator|->
name|uuconf_zname
argument_list|,
name|strlen
argument_list|(
name|qsys
operator|->
name|uuconf_zname
argument_list|)
argument_list|)
operator|!=
literal|0
condition|)
name|zQsystem
operator|=
name|qsys
operator|->
name|uuconf_zname
expr_stmt|;
comment|/* Make sure that all the required files exist, and get their      full names in the spool directory.  */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|cQfiles
condition|;
name|i
operator|++
control|)
block|{
name|char
modifier|*
name|zreal
decl_stmt|;
name|zreal
operator|=
name|zsysdep_spool_file_name
argument_list|(
name|qsys
argument_list|,
name|azQfiles
index|[
name|i
index|]
argument_list|,
operator|(
name|pointer
operator|)
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|zreal
operator|==
name|NULL
condition|)
block|{
name|uqcleanup
argument_list|(
name|zfile
argument_list|,
name|iclean
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
operator|!
name|fsysdep_file_exists
argument_list|(
name|zreal
argument_list|)
condition|)
block|{
name|uqcleanup
argument_list|(
name|zfile
argument_list|,
name|iclean
argument_list|)
expr_stmt|;
return|return;
block|}
name|ubuffree
argument_list|(
name|azQfiles
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|azQfiles
index|[
name|i
index|]
operator|=
name|zbufcpy
argument_list|(
name|zreal
argument_list|)
expr_stmt|;
name|ubuffree
argument_list|(
name|zreal
argument_list|)
expr_stmt|;
block|}
comment|/* Lock the execution directory.  */
if|if
condition|(
operator|!
name|fsysdep_lock_uuxqt_dir
argument_list|(
name|iQlock_seq
argument_list|)
condition|)
block|{
name|ulog
argument_list|(
name|LOG_ERROR
argument_list|,
literal|"Could not lock execute directory"
argument_list|)
expr_stmt|;
name|uqcleanup
argument_list|(
name|zfile
argument_list|,
name|iclean
argument_list|)
expr_stmt|;
return|return;
block|}
name|fQunlock_directory
operator|=
name|TRUE
expr_stmt|;
name|iclean
operator||=
name|REMOVE_FILE
operator||
name|REMOVE_NEEDED
expr_stmt|;
operator|*
name|pfprocessed
operator|=
name|TRUE
expr_stmt|;
comment|/* Get the address to mail results to.  Prepend the system from      which the execute file originated, since mail addresses are      relative to it.  */
name|zmail
operator|=
name|NULL
expr_stmt|;
if|if
condition|(
name|zQrequestor
operator|!=
name|NULL
condition|)
name|zmail
operator|=
name|zQrequestor
expr_stmt|;
elseif|else
if|if
condition|(
name|zQuser
operator|!=
name|NULL
condition|)
name|zmail
operator|=
name|zQuser
expr_stmt|;
if|if
condition|(
name|zmail
operator|!=
name|NULL
if|#
directive|if
name|HAVE_INTERNET_MAIL
operator|&&
name|strchr
argument_list|(
name|zmail
argument_list|,
literal|'@'
argument_list|)
operator|==
name|NULL
endif|#
directive|endif
operator|&&
name|strcmp
argument_list|(
name|zQsystem
argument_list|,
name|zlocalname
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|char
modifier|*
name|zset
decl_stmt|;
name|zset
operator|=
name|zbufalc
argument_list|(
name|strlen
argument_list|(
name|zQsystem
argument_list|)
operator|+
name|strlen
argument_list|(
name|zmail
argument_list|)
operator|+
literal|2
argument_list|)
expr_stmt|;
name|sprintf
argument_list|(
name|zset
argument_list|,
literal|"%s!%s"
argument_list|,
name|zQsystem
argument_list|,
name|zmail
argument_list|)
expr_stmt|;
name|zmail
operator|=
name|zset
expr_stmt|;
name|zQmail
operator|=
name|zset
expr_stmt|;
name|iclean
operator||=
name|FREE_MAIL
expr_stmt|;
block|}
comment|/* The command "uucp" is handled specially.  We make sure that the      appropriate forwarding is permitted, and we add a -u argument to      specify the user.  */
if|if
condition|(
name|strcmp
argument_list|(
name|azQargs
index|[
literal|0
index|]
argument_list|,
literal|"uucp"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|char
modifier|*
name|zfrom
decl_stmt|,
modifier|*
name|zto
decl_stmt|;
name|boolean
name|fmany
decl_stmt|;
name|char
modifier|*
modifier|*
name|azargs
decl_stmt|;
specifier|const
name|char
modifier|*
name|zuser
decl_stmt|;
name|zfrom
operator|=
name|NULL
expr_stmt|;
name|zto
operator|=
name|NULL
expr_stmt|;
name|fmany
operator|=
name|FALSE
expr_stmt|;
comment|/* Skip all the options, and get the from and to specs.  We 	 don't permit multiple arguments.  */
for|for
control|(
name|i
operator|=
literal|1
init|;
name|azQargs
index|[
name|i
index|]
operator|!=
name|NULL
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|azQargs
index|[
name|i
index|]
index|[
literal|0
index|]
operator|==
literal|'-'
condition|)
block|{
name|char
modifier|*
name|zopts
decl_stmt|;
for|for
control|(
name|zopts
operator|=
name|azQargs
index|[
name|i
index|]
operator|+
literal|1
init|;
operator|*
name|zopts
operator|!=
literal|'\0'
condition|;
name|zopts
operator|++
control|)
block|{
comment|/* The -g, -n, and -s options take an argument.  */
if|if
condition|(
operator|*
name|zopts
operator|==
literal|'g'
operator|||
operator|*
name|zopts
operator|==
literal|'n'
operator|||
operator|*
name|zopts
operator|==
literal|'s'
condition|)
block|{
if|if
condition|(
name|zopts
index|[
literal|1
index|]
operator|==
literal|'\0'
condition|)
operator|++
name|i
expr_stmt|;
break|break;
block|}
comment|/* The -I, -u and -x options are not permitted.  */
if|if
condition|(
operator|*
name|zopts
operator|==
literal|'I'
operator|||
operator|*
name|zopts
operator|==
literal|'u'
operator|||
operator|*
name|zopts
operator|==
literal|'x'
condition|)
block|{
operator|*
name|zopts
operator|=
literal|'r'
expr_stmt|;
if|if
condition|(
name|zopts
index|[
literal|1
index|]
operator|!=
literal|'\0'
condition|)
name|zopts
index|[
literal|1
index|]
operator|=
literal|'\0'
expr_stmt|;
else|else
block|{
operator|++
name|i
expr_stmt|;
name|azQargs
index|[
name|i
index|]
operator|=
name|zbufcpy
argument_list|(
literal|"-r"
argument_list|)
expr_stmt|;
block|}
break|break;
block|}
block|}
block|}
elseif|else
if|if
condition|(
name|zfrom
operator|==
name|NULL
condition|)
name|zfrom
operator|=
name|azQargs
index|[
name|i
index|]
expr_stmt|;
elseif|else
if|if
condition|(
name|zto
operator|==
name|NULL
condition|)
name|zto
operator|=
name|azQargs
index|[
name|i
index|]
expr_stmt|;
else|else
block|{
name|fmany
operator|=
name|TRUE
expr_stmt|;
break|break;
block|}
block|}
comment|/* Add the -u argument.  This is required to let uucp do the 	 correct permissions checking on the file transfer.  */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|azQargs
index|[
name|i
index|]
operator|!=
name|NULL
condition|;
name|i
operator|++
control|)
empty_stmt|;
name|azargs
operator|=
operator|(
name|char
operator|*
operator|*
operator|)
name|xmalloc
argument_list|(
operator|(
name|i
operator|+
literal|2
operator|)
operator|*
sizeof|sizeof
argument_list|(
name|char
operator|*
argument_list|)
argument_list|)
expr_stmt|;
name|azargs
index|[
literal|0
index|]
operator|=
name|azQargs
index|[
literal|0
index|]
expr_stmt|;
name|zuser
operator|=
name|zQuser
expr_stmt|;
if|if
condition|(
name|zuser
operator|==
name|NULL
condition|)
name|zuser
operator|=
literal|"uucp"
expr_stmt|;
name|azargs
index|[
literal|1
index|]
operator|=
name|zbufalc
argument_list|(
name|strlen
argument_list|(
name|zQsystem
argument_list|)
operator|+
name|strlen
argument_list|(
name|zuser
argument_list|)
operator|+
sizeof|sizeof
expr|"-u!"
argument_list|)
expr_stmt|;
name|sprintf
argument_list|(
name|azargs
index|[
literal|1
index|]
argument_list|,
literal|"-u%s!%s"
argument_list|,
name|zQsystem
argument_list|,
name|zuser
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
name|azargs
operator|+
literal|2
argument_list|,
name|azQargs
operator|+
literal|1
argument_list|,
name|i
operator|*
sizeof|sizeof
argument_list|(
name|char
operator|*
argument_list|)
argument_list|)
expr_stmt|;
name|xfree
argument_list|(
operator|(
name|pointer
operator|)
name|azQargs
argument_list|)
expr_stmt|;
name|azQargs
operator|=
name|azargs
expr_stmt|;
comment|/* Find the uucp binary.  */
name|zabsolute
operator|=
name|zsysdep_find_command
argument_list|(
literal|"uucp"
argument_list|,
name|qsys
operator|->
name|uuconf_pzcmds
argument_list|,
name|qsys
operator|->
name|uuconf_pzpath
argument_list|,
operator|&
name|ferr
argument_list|)
expr_stmt|;
if|if
condition|(
name|zabsolute
operator|==
name|NULL
operator|&&
operator|!
name|ferr
condition|)
block|{
specifier|const
name|char
modifier|*
name|azcmds
index|[
literal|2
index|]
decl_stmt|;
comment|/* If "uucp" is not a permitted command, then the forwarding 	     entries must be set.  */
if|if
condition|(
operator|!
name|fqforward
argument_list|(
name|zfrom
argument_list|,
name|qsys
operator|->
name|uuconf_pzforward_from
argument_list|,
literal|"from"
argument_list|,
name|zmail
argument_list|)
operator|||
operator|!
name|fqforward
argument_list|(
name|zto
argument_list|,
name|qsys
operator|->
name|uuconf_pzforward_to
argument_list|,
literal|"to"
argument_list|,
name|zmail
argument_list|)
condition|)
block|{
name|uqcleanup
argument_list|(
name|zfile
argument_list|,
name|iclean
argument_list|)
expr_stmt|;
return|return;
block|}
comment|/* If "uucp" is not a permitted command, then only uucp 	     requests with a single source are permitted, since that 	     is all that will be generated by uucp or uux.  */
if|if
condition|(
name|fmany
condition|)
block|{
name|ulog
argument_list|(
name|LOG_ERROR
argument_list|,
literal|"Bad uucp request %s"
argument_list|,
name|zQcmd
argument_list|)
expr_stmt|;
if|if
condition|(
name|zmail
operator|!=
name|NULL
operator|&&
operator|!
name|fQno_ack
condition|)
block|{
specifier|const
name|char
modifier|*
name|az
index|[
literal|20
index|]
decl_stmt|;
name|i
operator|=
literal|0
expr_stmt|;
name|az
index|[
name|i
operator|++
index|]
operator|=
literal|"Your execution request failed because it was an"
expr_stmt|;
name|az
index|[
name|i
operator|++
index|]
operator|=
literal|" unsupported uucp request.\n"
expr_stmt|;
name|az
index|[
name|i
operator|++
index|]
operator|=
literal|"Execution requested was:\n\t"
expr_stmt|;
name|az
index|[
name|i
operator|++
index|]
operator|=
name|zQcmd
expr_stmt|;
name|az
index|[
name|i
operator|++
index|]
operator|=
literal|"\n"
expr_stmt|;
operator|(
name|void
operator|)
name|fsysdep_mail
argument_list|(
name|zmail
argument_list|,
literal|"Execution failed"
argument_list|,
name|i
argument_list|,
name|az
argument_list|)
expr_stmt|;
block|}
name|uqcleanup
argument_list|(
name|zfile
argument_list|,
name|iclean
argument_list|)
expr_stmt|;
return|return;
block|}
name|azcmds
index|[
literal|0
index|]
operator|=
literal|"uucp"
expr_stmt|;
name|azcmds
index|[
literal|1
index|]
operator|=
name|NULL
expr_stmt|;
name|zabsolute
operator|=
name|zsysdep_find_command
argument_list|(
literal|"uucp"
argument_list|,
operator|(
name|char
operator|*
operator|*
operator|)
name|azcmds
argument_list|,
name|qsys
operator|->
name|uuconf_pzpath
argument_list|,
operator|&
name|ferr
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|zabsolute
operator|==
name|NULL
condition|)
block|{
if|if
condition|(
operator|!
name|ferr
condition|)
name|ulog
argument_list|(
name|LOG_ERROR
argument_list|,
literal|"Can't find uucp executable"
argument_list|)
expr_stmt|;
name|uqcleanup
argument_list|(
name|zfile
argument_list|,
name|iclean
operator|&
operator|~
operator|(
name|REMOVE_FILE
operator||
name|REMOVE_NEEDED
operator|)
argument_list|)
expr_stmt|;
operator|*
name|pfprocessed
operator|=
name|FALSE
expr_stmt|;
return|return;
block|}
block|}
else|else
block|{
comment|/* Get the pathname to execute.  */
name|zabsolute
operator|=
name|zsysdep_find_command
argument_list|(
name|azQargs
index|[
literal|0
index|]
argument_list|,
name|qsys
operator|->
name|uuconf_pzcmds
argument_list|,
name|qsys
operator|->
name|uuconf_pzpath
argument_list|,
operator|&
name|ferr
argument_list|)
expr_stmt|;
if|if
condition|(
name|zabsolute
operator|==
name|NULL
condition|)
block|{
if|if
condition|(
name|ferr
condition|)
block|{
comment|/* If we get an error, try again later.  */
name|uqcleanup
argument_list|(
name|zfile
argument_list|,
name|iclean
operator|&
operator|~
operator|(
name|REMOVE_FILE
operator||
name|REMOVE_NEEDED
operator|)
argument_list|)
expr_stmt|;
operator|*
name|pfprocessed
operator|=
name|FALSE
expr_stmt|;
return|return;
block|}
comment|/* Not permitted.  Send mail to requestor.  */
name|ulog
argument_list|(
name|LOG_ERROR
argument_list|,
literal|"Not permitted to execute %s"
argument_list|,
name|azQargs
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|zmail
operator|!=
name|NULL
operator|&&
operator|!
name|fQno_ack
condition|)
block|{
specifier|const
name|char
modifier|*
name|az
index|[
literal|20
index|]
decl_stmt|;
name|i
operator|=
literal|0
expr_stmt|;
name|az
index|[
name|i
operator|++
index|]
operator|=
literal|"Your execution request failed because you are not"
expr_stmt|;
name|az
index|[
name|i
operator|++
index|]
operator|=
literal|" permitted to execute\n\t"
expr_stmt|;
name|az
index|[
name|i
operator|++
index|]
operator|=
name|azQargs
index|[
literal|0
index|]
expr_stmt|;
name|az
index|[
name|i
operator|++
index|]
operator|=
literal|"\non this system.\n"
expr_stmt|;
name|az
index|[
name|i
operator|++
index|]
operator|=
literal|"Execution requested was:\n\t"
expr_stmt|;
name|az
index|[
name|i
operator|++
index|]
operator|=
name|zQcmd
expr_stmt|;
name|az
index|[
name|i
operator|++
index|]
operator|=
literal|"\n"
expr_stmt|;
operator|(
name|void
operator|)
name|fsysdep_mail
argument_list|(
name|zmail
argument_list|,
literal|"Execution failed"
argument_list|,
name|i
argument_list|,
name|az
argument_list|)
expr_stmt|;
block|}
name|iclean
operator|=
name|isave_files
argument_list|(
name|qsys
argument_list|,
name|zmail
argument_list|,
name|zfile
argument_list|,
name|iclean
argument_list|)
expr_stmt|;
name|uqcleanup
argument_list|(
name|zfile
argument_list|,
name|iclean
argument_list|)
expr_stmt|;
return|return;
block|}
block|}
name|ubuffree
argument_list|(
name|azQargs
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
name|azQargs
index|[
literal|0
index|]
operator|=
name|zabsolute
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|1
init|;
name|azQargs
index|[
name|i
index|]
operator|!=
name|NULL
condition|;
name|i
operator|++
control|)
block|{
name|char
modifier|*
name|zlocal
decl_stmt|;
name|zlocal
operator|=
name|zsysdep_xqt_local_file
argument_list|(
name|qsys
argument_list|,
name|azQargs
index|[
name|i
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|zlocal
operator|!=
name|NULL
condition|)
block|{
name|ubuffree
argument_list|(
name|azQargs
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|azQargs
index|[
name|i
index|]
operator|=
name|zlocal
expr_stmt|;
block|}
block|}
if|#
directive|if
operator|!
name|ALLOW_FILENAME_ARGUMENTS
comment|/* Check all the arguments to make sure they don't try to specify      files they are not permitted to access.  */
for|for
control|(
name|i
operator|=
literal|1
init|;
name|azQargs
index|[
name|i
index|]
operator|!=
name|NULL
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
operator|!
name|fsysdep_xqt_check_file
argument_list|(
name|qsys
argument_list|,
name|azQargs
index|[
name|i
index|]
argument_list|)
condition|)
block|{
if|if
condition|(
name|zmail
operator|!=
name|NULL
operator|&&
operator|!
name|fQno_ack
condition|)
block|{
specifier|const
name|char
modifier|*
name|az
index|[
literal|20
index|]
decl_stmt|;
specifier|const
name|char
modifier|*
name|zfailed
decl_stmt|;
name|zfailed
operator|=
name|azQargs
index|[
name|i
index|]
expr_stmt|;
name|i
operator|=
literal|0
expr_stmt|;
name|az
index|[
name|i
operator|++
index|]
operator|=
literal|"Your execution request failed because you are not"
expr_stmt|;
name|az
index|[
name|i
operator|++
index|]
operator|=
literal|" permitted to refer to file\n\t"
expr_stmt|;
name|az
index|[
name|i
operator|++
index|]
operator|=
name|zfailed
expr_stmt|;
name|az
index|[
name|i
operator|++
index|]
operator|=
literal|"\non this system.\n"
expr_stmt|;
name|az
index|[
name|i
operator|++
index|]
operator|=
literal|"Execution requested was:\n\t"
expr_stmt|;
name|az
index|[
name|i
operator|++
index|]
operator|=
name|zQcmd
expr_stmt|;
name|az
index|[
name|i
operator|++
index|]
operator|=
literal|"\n"
expr_stmt|;
operator|(
name|void
operator|)
name|fsysdep_mail
argument_list|(
name|zmail
argument_list|,
literal|"Execution failed"
argument_list|,
name|i
argument_list|,
name|az
argument_list|)
expr_stmt|;
block|}
name|iclean
operator|=
name|isave_files
argument_list|(
name|qsys
argument_list|,
name|zmail
argument_list|,
name|zfile
argument_list|,
name|iclean
argument_list|)
expr_stmt|;
name|uqcleanup
argument_list|(
name|zfile
argument_list|,
name|iclean
argument_list|)
expr_stmt|;
return|return;
block|}
block|}
endif|#
directive|endif
comment|/* ! ALLOW_FILENAME_ARGUMENTS */
name|ulog
argument_list|(
name|LOG_NORMAL
argument_list|,
literal|"Executing %s (%s)"
argument_list|,
name|zbase
argument_list|,
name|zQcmd
argument_list|)
expr_stmt|;
if|if
condition|(
name|zQinput
operator|!=
name|NULL
condition|)
block|{
name|boolean
name|fspool
decl_stmt|;
name|char
modifier|*
name|zreal
decl_stmt|;
name|fspool
operator|=
name|fspool_file
argument_list|(
name|zQinput
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|fspool
condition|)
name|zreal
operator|=
name|zsysdep_local_file
argument_list|(
name|zQinput
argument_list|,
name|qsys
operator|->
name|uuconf_zpubdir
argument_list|,
operator|&
name|fbadname
argument_list|)
expr_stmt|;
else|else
block|{
name|zreal
operator|=
name|zsysdep_spool_file_name
argument_list|(
name|qsys
argument_list|,
name|zQinput
argument_list|,
operator|(
name|pointer
operator|)
name|NULL
argument_list|)
expr_stmt|;
name|fbadname
operator|=
name|FALSE
expr_stmt|;
block|}
if|if
condition|(
name|zreal
operator|==
name|NULL
operator|&&
operator|!
name|fbadname
condition|)
block|{
comment|/* If we get an error, try again later.  */
name|uqcleanup
argument_list|(
name|zfile
argument_list|,
name|iclean
operator|&
operator|~
operator|(
name|REMOVE_FILE
operator||
name|REMOVE_NEEDED
operator|)
argument_list|)
expr_stmt|;
operator|*
name|pfprocessed
operator|=
name|FALSE
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|zreal
operator|!=
name|NULL
condition|)
block|{
name|zQinput
operator|=
name|zreal
expr_stmt|;
name|iclean
operator||=
name|FREE_QINPUT
expr_stmt|;
if|if
condition|(
name|fspool
condition|)
name|iclean
operator||=
name|REMOVE_QINPUT
expr_stmt|;
block|}
if|if
condition|(
name|zreal
operator|==
name|NULL
operator|||
operator|(
operator|!
name|fspool
operator|&&
operator|!
name|fin_directory_list
argument_list|(
name|zQinput
argument_list|,
name|qsys
operator|->
name|uuconf_pzremote_send
argument_list|,
name|qsys
operator|->
name|uuconf_zpubdir
argument_list|,
name|TRUE
argument_list|,
name|TRUE
argument_list|,
operator|(
specifier|const
name|char
operator|*
operator|)
name|NULL
argument_list|)
operator|)
condition|)
block|{
name|ulog
argument_list|(
name|LOG_ERROR
argument_list|,
literal|"Not permitted to read %s"
argument_list|,
name|zQinput
argument_list|)
expr_stmt|;
if|if
condition|(
name|zmail
operator|!=
name|NULL
operator|&&
operator|!
name|fQno_ack
condition|)
block|{
specifier|const
name|char
modifier|*
name|az
index|[
literal|20
index|]
decl_stmt|;
name|i
operator|=
literal|0
expr_stmt|;
name|az
index|[
name|i
operator|++
index|]
operator|=
literal|"Your execution request failed because you are"
expr_stmt|;
name|az
index|[
name|i
operator|++
index|]
operator|=
literal|" not permitted to read\n\t"
expr_stmt|;
name|az
index|[
name|i
operator|++
index|]
operator|=
name|zQinput
expr_stmt|;
name|az
index|[
name|i
operator|++
index|]
operator|=
literal|"\non this system.\n"
expr_stmt|;
name|az
index|[
name|i
operator|++
index|]
operator|=
literal|"Execution requested was:\n\t"
expr_stmt|;
name|az
index|[
name|i
operator|++
index|]
operator|=
name|zQcmd
expr_stmt|;
name|az
index|[
name|i
operator|++
index|]
operator|=
literal|"\n"
expr_stmt|;
operator|(
name|void
operator|)
name|fsysdep_mail
argument_list|(
name|zmail
argument_list|,
literal|"Execution failed"
argument_list|,
name|i
argument_list|,
name|az
argument_list|)
expr_stmt|;
block|}
name|uqcleanup
argument_list|(
name|zfile
argument_list|,
name|iclean
argument_list|)
expr_stmt|;
return|return;
block|}
block|}
name|zoutput
operator|=
name|NULL
expr_stmt|;
if|if
condition|(
name|zQoutfile
operator|==
name|NULL
condition|)
name|qoutsys
operator|=
name|NULL
expr_stmt|;
elseif|else
if|if
condition|(
name|zQoutsys
operator|!=
name|NULL
operator|&&
name|strcmp
argument_list|(
name|zQoutsys
argument_list|,
name|zlocalname
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|char
modifier|*
name|zdata
decl_stmt|;
comment|/* The output file is destined for some other system, so we must 	 use a temporary file to catch standard output.  */
if|if
condition|(
name|strcmp
argument_list|(
name|zQoutsys
argument_list|,
name|qsys
operator|->
name|uuconf_zname
argument_list|)
operator|==
literal|0
condition|)
name|qoutsys
operator|=
name|qsys
expr_stmt|;
else|else
block|{
name|iuuconf
operator|=
name|uuconf_system_info
argument_list|(
name|puuconf
argument_list|,
name|zQoutsys
argument_list|,
operator|&
name|soutsys
argument_list|)
expr_stmt|;
if|if
condition|(
name|iuuconf
operator|!=
name|UUCONF_SUCCESS
condition|)
block|{
if|if
condition|(
name|iuuconf
operator|!=
name|UUCONF_NOT_FOUND
condition|)
block|{
name|ulog_uuconf
argument_list|(
name|LOG_ERROR
argument_list|,
name|puuconf
argument_list|,
name|iuuconf
argument_list|)
expr_stmt|;
name|uqcleanup
argument_list|(
name|zfile
argument_list|,
name|iclean
operator|&
operator|~
operator|(
name|REMOVE_FILE
operator||
name|REMOVE_NEEDED
operator|)
argument_list|)
expr_stmt|;
operator|*
name|pfprocessed
operator|=
name|FALSE
expr_stmt|;
return|return;
block|}
if|if
condition|(
operator|!
name|funknown_system
argument_list|(
name|puuconf
argument_list|,
name|zQoutsys
argument_list|,
operator|&
name|soutsys
argument_list|)
condition|)
block|{
name|ulog
argument_list|(
name|LOG_ERROR
argument_list|,
literal|"Can't send standard output to unknown system %s"
argument_list|,
name|zQoutsys
argument_list|)
expr_stmt|;
comment|/* We don't send mail to unknown systems, either. 		     Maybe we should.  */
name|uqcleanup
argument_list|(
name|zfile
argument_list|,
name|iclean
argument_list|)
expr_stmt|;
return|return;
block|}
block|}
name|qoutsys
operator|=
operator|&
name|soutsys
expr_stmt|;
block|}
name|zdata
operator|=
name|zsysdep_data_file_name
argument_list|(
name|qoutsys
argument_list|,
name|zlocalname
argument_list|,
name|BDEFAULT_UUX_GRADE
argument_list|,
name|FALSE
argument_list|,
name|abtemp
argument_list|,
name|abdata
argument_list|,
operator|(
name|char
operator|*
operator|)
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|zdata
operator|==
name|NULL
condition|)
block|{
comment|/* If we get an error, try again later.  */
name|uqcleanup
argument_list|(
name|zfile
argument_list|,
name|iclean
operator|&
operator|~
operator|(
name|REMOVE_FILE
operator||
name|REMOVE_NEEDED
operator|)
argument_list|)
expr_stmt|;
operator|*
name|pfprocessed
operator|=
name|FALSE
expr_stmt|;
return|return;
block|}
name|zoutput
operator|=
name|zdata
expr_stmt|;
name|zQoutput
operator|=
name|zoutput
expr_stmt|;
name|iclean
operator||=
name|FREE_OUTPUT
expr_stmt|;
block|}
else|else
block|{
name|boolean
name|fok
decl_stmt|;
name|qoutsys
operator|=
name|NULL
expr_stmt|;
comment|/* If we permitted the standard output to be redirected into 	 the spool directory, people could set up phony commands.  */
if|if
condition|(
name|fspool_file
argument_list|(
name|zQoutfile
argument_list|)
condition|)
name|fok
operator|=
name|FALSE
expr_stmt|;
else|else
block|{
name|zoutput
operator|=
name|zsysdep_local_file
argument_list|(
name|zQoutfile
argument_list|,
name|qsys
operator|->
name|uuconf_zpubdir
argument_list|,
operator|&
name|fbadname
argument_list|)
expr_stmt|;
if|if
condition|(
name|zoutput
operator|==
name|NULL
condition|)
block|{
if|if
condition|(
operator|!
name|fbadname
condition|)
block|{
comment|/* If we get an error, try again later.  */
name|uqcleanup
argument_list|(
name|zfile
argument_list|,
name|iclean
operator|&
operator|~
operator|(
name|REMOVE_FILE
operator||
name|REMOVE_NEEDED
operator|)
argument_list|)
expr_stmt|;
operator|*
name|pfprocessed
operator|=
name|FALSE
expr_stmt|;
return|return;
block|}
name|fok
operator|=
name|FALSE
expr_stmt|;
block|}
else|else
block|{
name|ubuffree
argument_list|(
name|zQoutfile
argument_list|)
expr_stmt|;
name|zQoutfile
operator|=
name|zoutput
expr_stmt|;
comment|/* Make sure it's OK to receive this file.  */
name|fok
operator|=
name|fin_directory_list
argument_list|(
name|zQoutfile
argument_list|,
name|qsys
operator|->
name|uuconf_pzremote_receive
argument_list|,
name|qsys
operator|->
name|uuconf_zpubdir
argument_list|,
name|TRUE
argument_list|,
name|FALSE
argument_list|,
operator|(
specifier|const
name|char
operator|*
operator|)
name|NULL
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
operator|!
name|fok
condition|)
block|{
name|ulog
argument_list|(
name|LOG_ERROR
argument_list|,
literal|"Not permitted to write to %s"
argument_list|,
name|zQoutfile
argument_list|)
expr_stmt|;
if|if
condition|(
name|zmail
operator|!=
name|NULL
operator|&&
operator|!
name|fQno_ack
condition|)
block|{
specifier|const
name|char
modifier|*
name|az
index|[
literal|20
index|]
decl_stmt|;
name|i
operator|=
literal|0
expr_stmt|;
name|az
index|[
name|i
operator|++
index|]
operator|=
literal|"Your execution request failed because you are"
expr_stmt|;
name|az
index|[
name|i
operator|++
index|]
operator|=
literal|" not permitted to write to\n\t"
expr_stmt|;
name|az
index|[
name|i
operator|++
index|]
operator|=
name|zQoutfile
expr_stmt|;
name|az
index|[
name|i
operator|++
index|]
operator|=
literal|"\non this system.\n"
expr_stmt|;
name|az
index|[
name|i
operator|++
index|]
operator|=
literal|"Execution requested was:\n\t"
expr_stmt|;
name|az
index|[
name|i
operator|++
index|]
operator|=
name|zQcmd
expr_stmt|;
name|az
index|[
name|i
operator|++
index|]
operator|=
literal|"\n"
expr_stmt|;
operator|(
name|void
operator|)
name|fsysdep_mail
argument_list|(
name|zmail
argument_list|,
literal|"Execution failed"
argument_list|,
name|i
argument_list|,
name|az
argument_list|)
expr_stmt|;
block|}
name|uqcleanup
argument_list|(
name|zfile
argument_list|,
name|iclean
argument_list|)
expr_stmt|;
return|return;
block|}
block|}
comment|/* Move the required files to the execution directory if necessary.  */
name|zinput
operator|=
name|zQinput
expr_stmt|;
if|if
condition|(
operator|!
name|fsysdep_move_uuxqt_files
argument_list|(
name|cQfiles
argument_list|,
operator|(
specifier|const
name|char
operator|*
operator|*
operator|)
name|azQfiles
argument_list|,
operator|(
specifier|const
name|char
operator|*
operator|*
operator|)
name|azQfiles_to
argument_list|,
name|TRUE
argument_list|,
name|iQlock_seq
argument_list|,
operator|&
name|zinput
argument_list|)
condition|)
block|{
comment|/* If we get an error, try again later.  */
name|uqcleanup
argument_list|(
name|zfile
argument_list|,
name|iclean
operator|&
operator|~
operator|(
name|REMOVE_FILE
operator||
name|REMOVE_NEEDED
operator|)
argument_list|)
expr_stmt|;
operator|*
name|pfprocessed
operator|=
name|FALSE
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|zQinput
operator|!=
name|NULL
operator|&&
name|strcmp
argument_list|(
name|zQinput
argument_list|,
name|zinput
argument_list|)
operator|!=
literal|0
condition|)
block|{
if|if
condition|(
operator|(
name|iclean
operator|&
name|FREE_QINPUT
operator|)
operator|!=
literal|0
condition|)
name|ubuffree
argument_list|(
name|zQinput
argument_list|)
expr_stmt|;
name|zQinput
operator|=
name|zinput
expr_stmt|;
name|iclean
operator||=
name|FREE_QINPUT
expr_stmt|;
block|}
if|#
directive|if
name|ALLOW_SH_EXECUTION
name|fshell
operator|=
name|fQuse_sh
expr_stmt|;
else|#
directive|else
name|fshell
operator|=
name|FALSE
expr_stmt|;
endif|#
directive|endif
comment|/* Get a shell command which uses the full path of the command to      execute.  */
name|clen
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|azQargs
index|[
name|i
index|]
operator|!=
name|NULL
condition|;
name|i
operator|++
control|)
name|clen
operator|+=
name|strlen
argument_list|(
name|azQargs
index|[
name|i
index|]
argument_list|)
operator|+
literal|1
expr_stmt|;
name|zfullcmd
operator|=
name|zbufalc
argument_list|(
name|clen
argument_list|)
expr_stmt|;
name|strcpy
argument_list|(
name|zfullcmd
argument_list|,
name|azQargs
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|1
init|;
name|azQargs
index|[
name|i
index|]
operator|!=
name|NULL
condition|;
name|i
operator|++
control|)
block|{
name|strcat
argument_list|(
name|zfullcmd
argument_list|,
literal|" "
argument_list|)
expr_stmt|;
name|strcat
argument_list|(
name|zfullcmd
argument_list|,
name|azQargs
index|[
name|i
index|]
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|fsysdep_execute
argument_list|(
name|qsys
argument_list|,
name|zQuser
operator|==
name|NULL
condition|?
operator|(
specifier|const
name|char
operator|*
operator|)
literal|"uucp"
else|:
name|zQuser
argument_list|,
operator|(
specifier|const
name|char
operator|*
operator|*
operator|)
name|azQargs
argument_list|,
name|zfullcmd
argument_list|,
name|zQinput
argument_list|,
name|zoutput
argument_list|,
name|fshell
argument_list|,
name|iQlock_seq
argument_list|,
operator|&
name|zerror
argument_list|,
operator|&
name|ftemp
argument_list|)
condition|)
block|{
name|ubuffree
argument_list|(
name|zfullcmd
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|fsysdep_move_uuxqt_files
argument_list|(
name|cQfiles
argument_list|,
operator|(
specifier|const
name|char
operator|*
operator|*
operator|)
name|azQfiles
argument_list|,
operator|(
specifier|const
name|char
operator|*
operator|*
operator|)
name|azQfiles_to
argument_list|,
name|FALSE
argument_list|,
name|iQlock_seq
argument_list|,
operator|(
name|char
operator|*
operator|*
operator|)
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|ftemp
condition|)
block|{
name|ulog
argument_list|(
name|LOG_NORMAL
argument_list|,
literal|"Will retry later (%s)"
argument_list|,
name|zbase
argument_list|)
expr_stmt|;
if|if
condition|(
name|zoutput
operator|!=
name|NULL
condition|)
operator|(
name|void
operator|)
name|remove
argument_list|(
name|zoutput
argument_list|)
expr_stmt|;
if|if
condition|(
name|zerror
operator|!=
name|NULL
condition|)
block|{
operator|(
name|void
operator|)
name|remove
argument_list|(
name|zerror
argument_list|)
expr_stmt|;
name|ubuffree
argument_list|(
name|zerror
argument_list|)
expr_stmt|;
block|}
name|uqcleanup
argument_list|(
name|zfile
argument_list|,
name|iclean
operator|&
operator|~
operator|(
name|REMOVE_FILE
operator||
name|REMOVE_NEEDED
operator|)
argument_list|)
expr_stmt|;
operator|*
name|pfprocessed
operator|=
name|FALSE
expr_stmt|;
return|return;
block|}
name|ulog
argument_list|(
name|LOG_NORMAL
argument_list|,
literal|"Execution failed (%s)"
argument_list|,
name|zbase
argument_list|)
expr_stmt|;
if|if
condition|(
name|zmail
operator|!=
name|NULL
operator|&&
operator|!
name|fQno_ack
condition|)
block|{
specifier|const
name|char
modifier|*
modifier|*
name|pz
decl_stmt|;
name|int
name|cgot
decl_stmt|;
name|FILE
modifier|*
name|eerr
decl_stmt|;
name|int
name|istart
decl_stmt|;
name|cgot
operator|=
literal|20
expr_stmt|;
name|pz
operator|=
operator|(
specifier|const
name|char
operator|*
operator|*
operator|)
name|xmalloc
argument_list|(
name|cgot
operator|*
sizeof|sizeof
argument_list|(
specifier|const
name|char
operator|*
argument_list|)
argument_list|)
expr_stmt|;
name|i
operator|=
literal|0
expr_stmt|;
name|pz
index|[
name|i
operator|++
index|]
operator|=
literal|"Execution request failed:\n\t"
expr_stmt|;
name|pz
index|[
name|i
operator|++
index|]
operator|=
name|zQcmd
expr_stmt|;
name|pz
index|[
name|i
operator|++
index|]
operator|=
literal|"\n"
expr_stmt|;
if|if
condition|(
name|zerror
operator|==
name|NULL
condition|)
name|eerr
operator|=
name|NULL
expr_stmt|;
else|else
name|eerr
operator|=
name|fopen
argument_list|(
name|zerror
argument_list|,
literal|"r"
argument_list|)
expr_stmt|;
if|if
condition|(
name|eerr
operator|==
name|NULL
condition|)
block|{
name|pz
index|[
name|i
operator|++
index|]
operator|=
literal|"There was no output on standard error\n"
expr_stmt|;
name|istart
operator|=
name|i
expr_stmt|;
block|}
else|else
block|{
name|char
modifier|*
name|zline
decl_stmt|;
name|size_t
name|cline
decl_stmt|;
name|pz
index|[
name|i
operator|++
index|]
operator|=
literal|"Standard error output was:\n"
expr_stmt|;
name|istart
operator|=
name|i
expr_stmt|;
name|zline
operator|=
name|NULL
expr_stmt|;
name|cline
operator|=
literal|0
expr_stmt|;
while|while
condition|(
name|getline
argument_list|(
operator|&
name|zline
argument_list|,
operator|&
name|cline
argument_list|,
name|eerr
argument_list|)
operator|>
literal|0
condition|)
block|{
if|if
condition|(
name|i
operator|>=
name|cgot
condition|)
block|{
name|cgot
operator|+=
literal|20
expr_stmt|;
name|pz
operator|=
operator|(
operator|(
specifier|const
name|char
operator|*
operator|*
operator|)
name|xrealloc
argument_list|(
operator|(
name|pointer
operator|)
name|pz
argument_list|,
name|cgot
operator|*
sizeof|sizeof
argument_list|(
specifier|const
name|char
operator|*
argument_list|)
argument_list|)
operator|)
expr_stmt|;
block|}
name|pz
index|[
name|i
operator|++
index|]
operator|=
name|zbufcpy
argument_list|(
name|zline
argument_list|)
expr_stmt|;
block|}
operator|(
name|void
operator|)
name|fclose
argument_list|(
name|eerr
argument_list|)
expr_stmt|;
name|xfree
argument_list|(
operator|(
name|pointer
operator|)
name|zline
argument_list|)
expr_stmt|;
block|}
operator|(
name|void
operator|)
name|fsysdep_mail
argument_list|(
name|zmail
argument_list|,
literal|"Execution failed"
argument_list|,
name|i
argument_list|,
name|pz
argument_list|)
expr_stmt|;
for|for
control|(
init|;
name|istart
operator|<
name|i
condition|;
name|istart
operator|++
control|)
name|ubuffree
argument_list|(
operator|(
name|char
operator|*
operator|)
name|pz
index|[
name|istart
index|]
argument_list|)
expr_stmt|;
name|xfree
argument_list|(
operator|(
name|pointer
operator|)
name|pz
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|qoutsys
operator|!=
name|NULL
condition|)
operator|(
name|void
operator|)
name|remove
argument_list|(
name|zoutput
argument_list|)
expr_stmt|;
name|iclean
operator|=
name|isave_files
argument_list|(
name|qsys
argument_list|,
name|zmail
argument_list|,
name|zfile
argument_list|,
name|iclean
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|ubuffree
argument_list|(
name|zfullcmd
argument_list|)
expr_stmt|;
if|if
condition|(
name|zmail
operator|!=
name|NULL
operator|&&
name|fQsuccess_ack
condition|)
block|{
specifier|const
name|char
modifier|*
name|az
index|[
literal|20
index|]
decl_stmt|;
name|i
operator|=
literal|0
expr_stmt|;
name|az
index|[
name|i
operator|++
index|]
operator|=
literal|"\nExecution request succeeded:\n\t"
expr_stmt|;
name|az
index|[
name|i
operator|++
index|]
operator|=
name|zQcmd
expr_stmt|;
name|az
index|[
name|i
operator|++
index|]
operator|=
literal|"\n"
expr_stmt|;
operator|(
name|void
operator|)
name|fsysdep_mail
argument_list|(
name|zmail
argument_list|,
literal|"Execution succeded"
argument_list|,
name|i
argument_list|,
name|az
argument_list|)
expr_stmt|;
block|}
comment|/* Now we may have to uucp the output to some other machine.  */
if|if
condition|(
name|qoutsys
operator|!=
name|NULL
condition|)
block|{
name|struct
name|scmd
name|s
decl_stmt|;
comment|/* Fill in the command structure.  */
name|s
operator|.
name|bcmd
operator|=
literal|'S'
expr_stmt|;
name|s
operator|.
name|bgrade
operator|=
name|BDEFAULT_UUX_GRADE
expr_stmt|;
name|s
operator|.
name|pseq
operator|=
name|NULL
expr_stmt|;
name|s
operator|.
name|zfrom
operator|=
name|abtemp
expr_stmt|;
name|s
operator|.
name|zto
operator|=
name|zQoutfile
expr_stmt|;
if|if
condition|(
name|zQuser
operator|!=
name|NULL
condition|)
name|s
operator|.
name|zuser
operator|=
name|zQuser
expr_stmt|;
else|else
name|s
operator|.
name|zuser
operator|=
literal|"uucp"
expr_stmt|;
if|if
condition|(
name|zmail
operator|!=
name|NULL
operator|&&
name|fQsuccess_ack
condition|)
name|s
operator|.
name|zoptions
operator|=
literal|"Cn"
expr_stmt|;
else|else
name|s
operator|.
name|zoptions
operator|=
literal|"C"
expr_stmt|;
name|s
operator|.
name|ztemp
operator|=
name|abtemp
expr_stmt|;
name|s
operator|.
name|imode
operator|=
literal|0666
expr_stmt|;
if|if
condition|(
name|zmail
operator|!=
name|NULL
operator|&&
name|fQsuccess_ack
condition|)
name|s
operator|.
name|znotify
operator|=
name|zmail
expr_stmt|;
else|else
name|s
operator|.
name|znotify
operator|=
literal|""
expr_stmt|;
name|s
operator|.
name|cbytes
operator|=
operator|-
literal|1
expr_stmt|;
name|s
operator|.
name|zcmd
operator|=
name|NULL
expr_stmt|;
name|s
operator|.
name|ipos
operator|=
literal|0
expr_stmt|;
name|ubuffree
argument_list|(
name|zsysdep_spool_commands
argument_list|(
name|qoutsys
argument_list|,
name|BDEFAULT_UUX_GRADE
argument_list|,
literal|1
argument_list|,
operator|&
name|s
argument_list|)
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
name|zerror
operator|!=
name|NULL
condition|)
block|{
operator|(
name|void
operator|)
name|remove
argument_list|(
name|zerror
argument_list|)
expr_stmt|;
name|ubuffree
argument_list|(
name|zerror
argument_list|)
expr_stmt|;
block|}
name|uqcleanup
argument_list|(
name|zfile
argument_list|,
name|iclean
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* If we have enough disk space, save the data files so that the UUCP    administrator can examine them.  Send a mail message listing the    saved files.  */
end_comment

begin_function
specifier|static
name|int
name|isave_files
parameter_list|(
name|qsys
parameter_list|,
name|zmail
parameter_list|,
name|zfile
parameter_list|,
name|iclean
parameter_list|)
specifier|const
name|struct
name|uuconf_system
modifier|*
name|qsys
decl_stmt|;
specifier|const
name|char
modifier|*
name|zmail
decl_stmt|;
specifier|const
name|char
modifier|*
name|zfile
decl_stmt|;
name|int
name|iclean
decl_stmt|;
block|{
name|long
name|cspace
decl_stmt|;
name|char
modifier|*
name|zsavecmd
decl_stmt|;
name|char
modifier|*
modifier|*
name|pzsave
decl_stmt|;
name|int
name|c
decl_stmt|;
name|int
name|ifile
decl_stmt|;
name|char
modifier|*
name|zsaveinput
decl_stmt|;
specifier|const
name|char
modifier|*
modifier|*
name|pz
decl_stmt|;
name|int
name|i
decl_stmt|;
comment|/* Save the files if there is 1.5 times the amount of required free      space.  */
name|cspace
operator|=
name|csysdep_bytes_free
argument_list|(
name|zfile
argument_list|)
expr_stmt|;
if|if
condition|(
name|cspace
operator|==
operator|-
literal|1
condition|)
name|cspace
operator|=
name|FREE_SPACE_DELTA
expr_stmt|;
name|cspace
operator|-=
name|qsys
operator|->
name|uuconf_cfree_space
operator|+
name|qsys
operator|->
name|uuconf_cfree_space
operator|/
literal|2
expr_stmt|;
if|if
condition|(
name|cspace
operator|<
literal|0
condition|)
return|return
name|iclean
return|;
name|zsavecmd
operator|=
name|zsysdep_save_failed_file
argument_list|(
name|zfile
argument_list|)
expr_stmt|;
if|if
condition|(
name|zsavecmd
operator|==
name|NULL
condition|)
return|return
name|iclean
return|;
name|c
operator|=
literal|1
expr_stmt|;
name|pzsave
operator|=
operator|(
name|char
operator|*
operator|*
operator|)
name|xmalloc
argument_list|(
name|cQfiles
operator|*
sizeof|sizeof
argument_list|(
name|char
operator|*
argument_list|)
argument_list|)
expr_stmt|;
for|for
control|(
name|ifile
operator|=
literal|0
init|;
name|ifile
operator|<
name|cQfiles
condition|;
name|ifile
operator|++
control|)
block|{
if|if
condition|(
name|azQfiles
index|[
name|ifile
index|]
operator|!=
name|NULL
condition|)
block|{
operator|++
name|c
expr_stmt|;
name|pzsave
index|[
name|ifile
index|]
operator|=
name|zsysdep_save_failed_file
argument_list|(
name|azQfiles
index|[
name|ifile
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|pzsave
index|[
name|ifile
index|]
operator|==
name|NULL
condition|)
block|{
name|ubuffree
argument_list|(
name|zsavecmd
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|ifile
condition|;
name|i
operator|++
control|)
if|if
condition|(
name|azQfiles
index|[
name|i
index|]
operator|!=
name|NULL
condition|)
name|ubuffree
argument_list|(
name|pzsave
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|xfree
argument_list|(
operator|(
name|pointer
operator|)
name|pzsave
argument_list|)
expr_stmt|;
return|return
name|iclean
return|;
block|}
block|}
block|}
name|zsaveinput
operator|=
name|NULL
expr_stmt|;
if|if
condition|(
operator|(
name|iclean
operator|&
name|REMOVE_QINPUT
operator|)
operator|!=
literal|0
operator|&&
name|fsysdep_file_exists
argument_list|(
name|zQinput
argument_list|)
condition|)
block|{
name|zsaveinput
operator|=
name|zsysdep_save_failed_file
argument_list|(
name|zQinput
argument_list|)
expr_stmt|;
if|if
condition|(
name|zsaveinput
operator|==
name|NULL
condition|)
block|{
name|ubuffree
argument_list|(
name|zsavecmd
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|cQfiles
condition|;
name|i
operator|++
control|)
if|if
condition|(
name|azQfiles
index|[
name|i
index|]
operator|!=
name|NULL
condition|)
name|ubuffree
argument_list|(
name|pzsave
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|xfree
argument_list|(
operator|(
name|pointer
operator|)
name|pzsave
argument_list|)
expr_stmt|;
return|return
name|iclean
return|;
block|}
block|}
name|pz
operator|=
operator|(
specifier|const
name|char
operator|*
operator|*
operator|)
name|xmalloc
argument_list|(
operator|(
literal|20
operator|+
literal|2
operator|*
name|cQfiles
operator|)
operator|*
sizeof|sizeof
argument_list|(
name|char
operator|*
argument_list|)
argument_list|)
expr_stmt|;
name|i
operator|=
literal|0
expr_stmt|;
name|pz
index|[
name|i
operator|++
index|]
operator|=
literal|"A UUCP execution request failed:\n\t"
expr_stmt|;
name|pz
index|[
name|i
operator|++
index|]
operator|=
name|zQcmd
expr_stmt|;
if|if
condition|(
name|zmail
operator|!=
name|NULL
condition|)
block|{
name|pz
index|[
name|i
operator|++
index|]
operator|=
literal|"\nThe request was made by\n\t"
expr_stmt|;
name|pz
index|[
name|i
operator|++
index|]
operator|=
name|zmail
expr_stmt|;
block|}
else|else
block|{
name|pz
index|[
name|i
operator|++
index|]
operator|=
literal|"\nThe request came from system\n\t"
expr_stmt|;
name|pz
index|[
name|i
operator|++
index|]
operator|=
name|qsys
operator|->
name|uuconf_zname
expr_stmt|;
block|}
if|if
condition|(
name|c
operator|==
literal|1
operator|&&
name|zsaveinput
operator|==
name|NULL
condition|)
name|pz
index|[
name|i
operator|++
index|]
operator|=
literal|"\nThe following file has been saved:\n\t"
expr_stmt|;
else|else
name|pz
index|[
name|i
operator|++
index|]
operator|=
literal|"\nThe following files have been saved:\n\t"
expr_stmt|;
name|pz
index|[
name|i
operator|++
index|]
operator|=
name|zsavecmd
expr_stmt|;
for|for
control|(
name|ifile
operator|=
literal|0
init|;
name|ifile
operator|<
name|cQfiles
condition|;
name|ifile
operator|++
control|)
block|{
if|if
condition|(
name|azQfiles
index|[
name|ifile
index|]
operator|!=
name|NULL
condition|)
block|{
name|pz
index|[
name|i
operator|++
index|]
operator|=
literal|"\n\t"
expr_stmt|;
name|pz
index|[
name|i
operator|++
index|]
operator|=
name|pzsave
index|[
name|ifile
index|]
expr_stmt|;
block|}
block|}
if|if
condition|(
name|zsaveinput
operator|!=
name|NULL
condition|)
block|{
name|pz
index|[
name|i
operator|++
index|]
operator|=
literal|"\n\t"
expr_stmt|;
name|pz
index|[
name|i
operator|++
index|]
operator|=
name|zsaveinput
expr_stmt|;
block|}
name|pz
index|[
name|i
operator|++
index|]
operator|=
literal|"\n"
expr_stmt|;
operator|(
name|void
operator|)
name|fsysdep_mail
argument_list|(
name|OWNER
argument_list|,
literal|"UUCP execution files saved after failure"
argument_list|,
name|i
argument_list|,
name|pz
argument_list|)
expr_stmt|;
name|xfree
argument_list|(
operator|(
name|pointer
operator|)
name|pz
argument_list|)
expr_stmt|;
name|ubuffree
argument_list|(
name|zsavecmd
argument_list|)
expr_stmt|;
for|for
control|(
name|ifile
operator|=
literal|0
init|;
name|ifile
operator|<
name|cQfiles
condition|;
name|ifile
operator|++
control|)
if|if
condition|(
name|azQfiles
index|[
name|ifile
index|]
operator|!=
name|NULL
condition|)
name|ubuffree
argument_list|(
name|pzsave
index|[
name|ifile
index|]
argument_list|)
expr_stmt|;
name|xfree
argument_list|(
operator|(
name|pointer
operator|)
name|pzsave
argument_list|)
expr_stmt|;
name|ubuffree
argument_list|(
name|zsaveinput
argument_list|)
expr_stmt|;
return|return
name|iclean
operator|&
operator|~
operator|(
name|REMOVE_FILE
operator||
name|REMOVE_NEEDED
operator|)
return|;
block|}
end_function

begin_comment
comment|/* Clean up the results of uqdo_xqt_file.  */
end_comment

begin_function
specifier|static
name|void
name|uqcleanup
parameter_list|(
name|zfile
parameter_list|,
name|iflags
parameter_list|)
specifier|const
name|char
modifier|*
name|zfile
decl_stmt|;
name|int
name|iflags
decl_stmt|;
block|{
name|int
name|i
decl_stmt|;
name|DEBUG_MESSAGE2
argument_list|(
name|DEBUG_SPOOLDIR
argument_list|,
literal|"uqcleanup: %s, %d"
argument_list|,
name|zfile
argument_list|,
name|iflags
argument_list|)
expr_stmt|;
if|if
condition|(
name|zQunlock_file
operator|!=
name|NULL
condition|)
block|{
operator|(
name|void
operator|)
name|fsysdep_unlock_uuxqt_file
argument_list|(
name|zQunlock_file
argument_list|)
expr_stmt|;
name|zQunlock_file
operator|=
name|NULL
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|iflags
operator|&
name|REMOVE_FILE
operator|)
operator|!=
literal|0
condition|)
operator|(
name|void
operator|)
name|remove
argument_list|(
name|zfile
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|iflags
operator|&
name|REMOVE_NEEDED
operator|)
operator|!=
literal|0
condition|)
block|{
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|cQfiles
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|azQfiles
index|[
name|i
index|]
operator|!=
name|NULL
condition|)
operator|(
name|void
operator|)
name|remove
argument_list|(
name|azQfiles
index|[
name|i
index|]
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|iflags
operator|&
name|REMOVE_QINPUT
operator|)
operator|!=
literal|0
condition|)
operator|(
name|void
operator|)
name|remove
argument_list|(
name|zQinput
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|iflags
operator|&
name|FREE_QINPUT
operator|)
operator|!=
literal|0
condition|)
name|ubuffree
argument_list|(
name|zQinput
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|iflags
operator|&
name|FREE_OUTPUT
operator|)
operator|!=
literal|0
condition|)
name|ubuffree
argument_list|(
name|zQoutput
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|iflags
operator|&
name|FREE_MAIL
operator|)
operator|!=
literal|0
condition|)
name|ubuffree
argument_list|(
name|zQmail
argument_list|)
expr_stmt|;
if|if
condition|(
name|fQunlock_directory
condition|)
block|{
operator|(
name|void
operator|)
name|fsysdep_unlock_uuxqt_dir
argument_list|(
name|iQlock_seq
argument_list|)
expr_stmt|;
name|fQunlock_directory
operator|=
name|FALSE
expr_stmt|;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|cQfiles
condition|;
name|i
operator|++
control|)
block|{
name|ubuffree
argument_list|(
name|azQfiles
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|ubuffree
argument_list|(
name|azQfiles_to
index|[
name|i
index|]
argument_list|)
expr_stmt|;
block|}
name|ubuffree
argument_list|(
name|zQoutfile
argument_list|)
expr_stmt|;
name|ubuffree
argument_list|(
name|zQoutsys
argument_list|)
expr_stmt|;
name|ubuffree
argument_list|(
name|zQrequestor
argument_list|)
expr_stmt|;
if|if
condition|(
name|azQargs
operator|!=
name|NULL
condition|)
block|{
for|for
control|(
name|i
operator|=
literal|0
init|;
name|azQargs
index|[
name|i
index|]
operator|!=
name|NULL
condition|;
name|i
operator|++
control|)
name|ubuffree
argument_list|(
name|azQargs
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|xfree
argument_list|(
operator|(
name|pointer
operator|)
name|azQargs
argument_list|)
expr_stmt|;
name|azQargs
operator|=
name|NULL
expr_stmt|;
block|}
name|xfree
argument_list|(
operator|(
name|pointer
operator|)
name|zQcmd
argument_list|)
expr_stmt|;
name|zQcmd
operator|=
name|NULL
expr_stmt|;
name|xfree
argument_list|(
operator|(
name|pointer
operator|)
name|azQfiles
argument_list|)
expr_stmt|;
name|azQfiles
operator|=
name|NULL
expr_stmt|;
name|xfree
argument_list|(
operator|(
name|pointer
operator|)
name|azQfiles_to
argument_list|)
expr_stmt|;
name|azQfiles_to
operator|=
name|NULL
expr_stmt|;
block|}
end_function

begin_comment
comment|/* Check whether forwarding is permitted.  */
end_comment

begin_function
specifier|static
name|boolean
name|fqforward
parameter_list|(
name|zfile
parameter_list|,
name|pzallowed
parameter_list|,
name|zlog
parameter_list|,
name|zmail
parameter_list|)
specifier|const
name|char
modifier|*
name|zfile
decl_stmt|;
name|char
modifier|*
modifier|*
name|pzallowed
decl_stmt|;
specifier|const
name|char
modifier|*
name|zlog
decl_stmt|;
specifier|const
name|char
modifier|*
name|zmail
decl_stmt|;
block|{
specifier|const
name|char
modifier|*
name|zexclam
decl_stmt|;
name|zexclam
operator|=
name|strchr
argument_list|(
name|zfile
argument_list|,
literal|'!'
argument_list|)
expr_stmt|;
if|if
condition|(
name|zexclam
operator|!=
name|NULL
condition|)
block|{
name|size_t
name|clen
decl_stmt|;
name|char
modifier|*
name|zsys
decl_stmt|;
name|boolean
name|fret
decl_stmt|;
name|clen
operator|=
name|zexclam
operator|-
name|zfile
expr_stmt|;
name|zsys
operator|=
name|zbufalc
argument_list|(
name|clen
operator|+
literal|1
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
name|zsys
argument_list|,
name|zfile
argument_list|,
name|clen
argument_list|)
expr_stmt|;
name|zsys
index|[
name|clen
index|]
operator|=
literal|'\0'
expr_stmt|;
name|fret
operator|=
name|FALSE
expr_stmt|;
if|if
condition|(
name|pzallowed
operator|!=
name|NULL
condition|)
block|{
name|char
modifier|*
modifier|*
name|pz
decl_stmt|;
for|for
control|(
name|pz
operator|=
name|pzallowed
init|;
operator|*
name|pz
operator|!=
name|NULL
condition|;
name|pz
operator|++
control|)
block|{
if|if
condition|(
name|strcmp
argument_list|(
operator|*
name|pz
argument_list|,
literal|"ANY"
argument_list|)
operator|==
literal|0
operator|||
name|strcmp
argument_list|(
operator|*
name|pz
argument_list|,
name|zsys
argument_list|)
operator|==
literal|0
condition|)
block|{
name|fret
operator|=
name|TRUE
expr_stmt|;
break|break;
block|}
block|}
block|}
if|if
condition|(
operator|!
name|fret
condition|)
block|{
name|ulog
argument_list|(
name|LOG_ERROR
argument_list|,
literal|"Not permitted to forward %s %s (%s)"
argument_list|,
name|zlog
argument_list|,
name|zsys
argument_list|,
name|zQcmd
argument_list|)
expr_stmt|;
if|if
condition|(
name|zmail
operator|!=
name|NULL
operator|&&
operator|!
name|fQno_ack
condition|)
block|{
name|int
name|i
decl_stmt|;
specifier|const
name|char
modifier|*
name|az
index|[
literal|20
index|]
decl_stmt|;
name|i
operator|=
literal|0
expr_stmt|;
name|az
index|[
name|i
operator|++
index|]
operator|=
literal|"Your execution request failed because you are"
expr_stmt|;
name|az
index|[
name|i
operator|++
index|]
operator|=
literal|" not permitted to forward files\n"
expr_stmt|;
name|az
index|[
name|i
operator|++
index|]
operator|=
name|zlog
expr_stmt|;
name|az
index|[
name|i
operator|++
index|]
operator|=
literal|" the system\n\t"
expr_stmt|;
name|az
index|[
name|i
operator|++
index|]
operator|=
name|zsys
expr_stmt|;
name|az
index|[
name|i
operator|++
index|]
operator|=
literal|"\n"
expr_stmt|;
name|az
index|[
name|i
operator|++
index|]
operator|=
literal|"Execution requested was:\n\t"
expr_stmt|;
name|az
index|[
name|i
operator|++
index|]
operator|=
name|zQcmd
expr_stmt|;
name|az
index|[
name|i
operator|++
index|]
operator|=
literal|"\n"
expr_stmt|;
operator|(
name|void
operator|)
name|fsysdep_mail
argument_list|(
name|zmail
argument_list|,
literal|"Execution failed"
argument_list|,
name|i
argument_list|,
name|az
argument_list|)
expr_stmt|;
block|}
block|}
name|ubuffree
argument_list|(
name|zsys
argument_list|)
expr_stmt|;
return|return
name|fret
return|;
block|}
return|return
name|TRUE
return|;
block|}
end_function

end_unit


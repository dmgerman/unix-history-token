begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/* conn.c    Connection routines for the Taylor UUCP package.     Copyright (C) 1991, 1992, 1993, 1994 Ian Lance Taylor     This file is part of the Taylor UUCP package.     This program is free software; you can redistribute it and/or    modify it under the terms of the GNU General Public License as    published by the Free Software Foundation; either version 2 of the    License, or (at your option) any later version.     This program is distributed in the hope that it will be useful, but    WITHOUT ANY WARRANTY; without even the implied warranty of    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU    General Public License for more details.     You should have received a copy of the GNU General Public License    along with this program; if not, write to the Free Software    Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.     The author of the program may be contacted at ian@airs.com or    c/o Cygnus Support, Building 200, 1 Kendall Square, Cambridge, MA 02139.    */
end_comment

begin_include
include|#
directive|include
file|"uucp.h"
end_include

begin_if
if|#
directive|if
name|USE_RCS_ID
end_if

begin_decl_stmt
specifier|const
name|char
name|conn_rcsid
index|[]
init|=
literal|"$Id: conn.c,v 1.13 1994/03/24 01:41:02 ian Rel $"
decl_stmt|;
end_decl_stmt

begin_endif
endif|#
directive|endif
end_endif

begin_include
include|#
directive|include
file|<ctype.h>
end_include

begin_include
include|#
directive|include
file|"uudefs.h"
end_include

begin_include
include|#
directive|include
file|"uuconf.h"
end_include

begin_include
include|#
directive|include
file|"conn.h"
end_include

begin_escape
end_escape

begin_comment
comment|/* Create a new connection.  This relies on system dependent functions    to set the qcmds and psysdep fields.  If qport is NULL, it opens a    standard input port, in which case ttype is the type of port to    use.  */
end_comment

begin_function
name|boolean
name|fconn_init
parameter_list|(
name|qport
parameter_list|,
name|qconn
parameter_list|,
name|ttype
parameter_list|)
name|struct
name|uuconf_port
modifier|*
name|qport
decl_stmt|;
name|struct
name|sconnection
modifier|*
name|qconn
decl_stmt|;
name|enum
name|uuconf_porttype
name|ttype
decl_stmt|;
block|{
name|qconn
operator|->
name|qport
operator|=
name|qport
expr_stmt|;
switch|switch
condition|(
name|qport
operator|==
name|NULL
condition|?
name|ttype
else|:
name|qport
operator|->
name|uuconf_ttype
condition|)
block|{
case|case
name|UUCONF_PORTTYPE_STDIN
case|:
return|return
name|fsysdep_stdin_init
argument_list|(
name|qconn
argument_list|)
return|;
case|case
name|UUCONF_PORTTYPE_MODEM
case|:
return|return
name|fsysdep_modem_init
argument_list|(
name|qconn
argument_list|)
return|;
case|case
name|UUCONF_PORTTYPE_DIRECT
case|:
return|return
name|fsysdep_direct_init
argument_list|(
name|qconn
argument_list|)
return|;
if|#
directive|if
name|HAVE_TCP
case|case
name|UUCONF_PORTTYPE_TCP
case|:
return|return
name|fsysdep_tcp_init
argument_list|(
name|qconn
argument_list|)
return|;
endif|#
directive|endif
if|#
directive|if
name|HAVE_TLI
case|case
name|UUCONF_PORTTYPE_TLI
case|:
return|return
name|fsysdep_tli_init
argument_list|(
name|qconn
argument_list|)
return|;
endif|#
directive|endif
case|case
name|UUCONF_PORTTYPE_PIPE
case|:
return|return
name|fsysdep_pipe_init
argument_list|(
name|qconn
argument_list|)
return|;
default|default:
name|ulog
argument_list|(
name|LOG_ERROR
argument_list|,
literal|"Unknown or unsupported port type"
argument_list|)
expr_stmt|;
return|return
name|FALSE
return|;
block|}
block|}
end_function

begin_escape
end_escape

begin_comment
comment|/* Connection dispatch routines.  */
end_comment

begin_comment
comment|/* Free a connection.  */
end_comment

begin_function
name|void
name|uconn_free
parameter_list|(
name|qconn
parameter_list|)
name|struct
name|sconnection
modifier|*
name|qconn
decl_stmt|;
block|{
call|(
modifier|*
name|qconn
operator|->
name|qcmds
operator|->
name|pufree
call|)
argument_list|(
name|qconn
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* Lock a connection.   */
end_comment

begin_function
name|boolean
name|fconn_lock
parameter_list|(
name|qconn
parameter_list|,
name|fin
parameter_list|)
name|struct
name|sconnection
modifier|*
name|qconn
decl_stmt|;
name|boolean
name|fin
decl_stmt|;
block|{
name|boolean
argument_list|(
argument|*pflock
argument_list|)
name|P
argument_list|(
operator|(
expr|struct
name|sconnection
operator|*
operator|,
name|boolean
operator|)
argument_list|)
expr_stmt|;
name|pflock
operator|=
name|qconn
operator|->
name|qcmds
operator|->
name|pflock
expr_stmt|;
if|if
condition|(
name|pflock
operator|==
name|NULL
condition|)
return|return
name|TRUE
return|;
return|return
call|(
modifier|*
name|pflock
call|)
argument_list|(
name|qconn
argument_list|,
name|fin
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/* Unlock a connection.  */
end_comment

begin_function
name|boolean
name|fconn_unlock
parameter_list|(
name|qconn
parameter_list|)
name|struct
name|sconnection
modifier|*
name|qconn
decl_stmt|;
block|{
name|boolean
argument_list|(
argument|*pfunlock
argument_list|)
name|P
argument_list|(
operator|(
expr|struct
name|sconnection
operator|*
operator|)
argument_list|)
expr_stmt|;
name|pfunlock
operator|=
name|qconn
operator|->
name|qcmds
operator|->
name|pfunlock
expr_stmt|;
if|if
condition|(
name|pfunlock
operator|==
name|NULL
condition|)
return|return
name|TRUE
return|;
return|return
call|(
modifier|*
name|pfunlock
call|)
argument_list|(
name|qconn
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/* Open a connection.  */
end_comment

begin_function
name|boolean
name|fconn_open
parameter_list|(
name|qconn
parameter_list|,
name|ibaud
parameter_list|,
name|ihighbaud
parameter_list|,
name|fwait
parameter_list|)
name|struct
name|sconnection
modifier|*
name|qconn
decl_stmt|;
name|long
name|ibaud
decl_stmt|;
name|long
name|ihighbaud
decl_stmt|;
name|boolean
name|fwait
decl_stmt|;
block|{
name|boolean
name|fret
decl_stmt|;
if|#
directive|if
name|DEBUG
operator|>
literal|1
if|if
condition|(
name|FDEBUGGING
argument_list|(
name|DEBUG_PORT
argument_list|)
condition|)
block|{
name|char
name|abspeed
index|[
literal|20
index|]
decl_stmt|;
if|if
condition|(
name|ibaud
operator|==
operator|(
name|long
operator|)
literal|0
condition|)
name|strcpy
argument_list|(
name|abspeed
argument_list|,
literal|"default speed"
argument_list|)
expr_stmt|;
else|else
name|sprintf
argument_list|(
name|abspeed
argument_list|,
literal|"speed %ld"
argument_list|,
name|ibaud
argument_list|)
expr_stmt|;
if|if
condition|(
name|qconn
operator|->
name|qport
operator|==
name|NULL
condition|)
name|ulog
argument_list|(
name|LOG_DEBUG
argument_list|,
literal|"fconn_open: Opening stdin port (%s)"
argument_list|,
name|abspeed
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|qconn
operator|->
name|qport
operator|->
name|uuconf_zname
operator|==
name|NULL
condition|)
name|ulog
argument_list|(
name|LOG_DEBUG
argument_list|,
literal|"fconn_open: Opening unnamed port (%s)"
argument_list|,
name|abspeed
argument_list|)
expr_stmt|;
else|else
name|ulog
argument_list|(
name|LOG_DEBUG
argument_list|,
literal|"fconn_open: Opening port %s (%s)"
argument_list|,
name|qconn
operator|->
name|qport
operator|->
name|uuconf_zname
argument_list|,
name|abspeed
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
comment|/* If the system provides a range of baud rates, we select the      highest baud rate supported by the port.  */
if|if
condition|(
name|ihighbaud
operator|!=
literal|0
operator|&&
name|qconn
operator|->
name|qport
operator|!=
name|NULL
condition|)
block|{
name|struct
name|uuconf_port
modifier|*
name|qport
decl_stmt|;
name|qport
operator|=
name|qconn
operator|->
name|qport
expr_stmt|;
name|ibaud
operator|=
name|ihighbaud
expr_stmt|;
if|if
condition|(
name|qport
operator|->
name|uuconf_ttype
operator|==
name|UUCONF_PORTTYPE_MODEM
condition|)
block|{
if|if
condition|(
name|qport
operator|->
name|uuconf_u
operator|.
name|uuconf_smodem
operator|.
name|uuconf_ilowbaud
operator|!=
literal|0
condition|)
block|{
if|if
condition|(
name|qport
operator|->
name|uuconf_u
operator|.
name|uuconf_smodem
operator|.
name|uuconf_ihighbaud
operator|<
name|ibaud
condition|)
name|ibaud
operator|=
name|qport
operator|->
name|uuconf_u
operator|.
name|uuconf_smodem
operator|.
name|uuconf_ihighbaud
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|qport
operator|->
name|uuconf_u
operator|.
name|uuconf_smodem
operator|.
name|uuconf_ibaud
operator|!=
literal|0
condition|)
name|ibaud
operator|=
name|qport
operator|->
name|uuconf_u
operator|.
name|uuconf_smodem
operator|.
name|uuconf_ibaud
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|qport
operator|->
name|uuconf_ttype
operator|==
name|UUCONF_PORTTYPE_DIRECT
condition|)
block|{
if|if
condition|(
name|qport
operator|->
name|uuconf_u
operator|.
name|uuconf_sdirect
operator|.
name|uuconf_ibaud
operator|!=
literal|0
condition|)
name|ibaud
operator|=
name|qport
operator|->
name|uuconf_u
operator|.
name|uuconf_sdirect
operator|.
name|uuconf_ibaud
expr_stmt|;
block|}
block|}
comment|/* This will normally be overridden by the port specific open      routine.  */
if|if
condition|(
name|qconn
operator|->
name|qport
operator|==
name|NULL
condition|)
name|ulog_device
argument_list|(
literal|"stdin"
argument_list|)
expr_stmt|;
else|else
name|ulog_device
argument_list|(
name|qconn
operator|->
name|qport
operator|->
name|uuconf_zname
argument_list|)
expr_stmt|;
name|fret
operator|=
call|(
modifier|*
name|qconn
operator|->
name|qcmds
operator|->
name|pfopen
call|)
argument_list|(
name|qconn
argument_list|,
name|ibaud
argument_list|,
name|fwait
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|fret
condition|)
name|ulog_device
argument_list|(
operator|(
specifier|const
name|char
operator|*
operator|)
name|NULL
argument_list|)
expr_stmt|;
return|return
name|fret
return|;
block|}
end_function

begin_comment
comment|/* Close a connection.  */
end_comment

begin_function
name|boolean
name|fconn_close
parameter_list|(
name|qconn
parameter_list|,
name|puuconf
parameter_list|,
name|qdialer
parameter_list|,
name|fsuccess
parameter_list|)
name|struct
name|sconnection
modifier|*
name|qconn
decl_stmt|;
name|pointer
name|puuconf
decl_stmt|;
name|struct
name|uuconf_dialer
modifier|*
name|qdialer
decl_stmt|;
name|boolean
name|fsuccess
decl_stmt|;
block|{
name|boolean
name|fret
decl_stmt|;
name|DEBUG_MESSAGE0
argument_list|(
name|DEBUG_PORT
argument_list|,
literal|"fconn_close: Closing connection"
argument_list|)
expr_stmt|;
comment|/* Don't report hangup signals while we're closing.  */
name|fLog_sighup
operator|=
name|FALSE
expr_stmt|;
name|fret
operator|=
call|(
modifier|*
name|qconn
operator|->
name|qcmds
operator|->
name|pfclose
call|)
argument_list|(
name|qconn
argument_list|,
name|puuconf
argument_list|,
name|qdialer
argument_list|,
name|fsuccess
argument_list|)
expr_stmt|;
comment|/* Ignore any SIGHUP we may have gotten, and make sure any signal      reporting has been done before we reset fLog_sighup.  */
name|afSignal
index|[
name|INDEXSIG_SIGHUP
index|]
operator|=
name|FALSE
expr_stmt|;
name|ulog
argument_list|(
name|LOG_ERROR
argument_list|,
operator|(
specifier|const
name|char
operator|*
operator|)
name|NULL
argument_list|)
expr_stmt|;
name|fLog_sighup
operator|=
name|TRUE
expr_stmt|;
name|ulog_device
argument_list|(
operator|(
specifier|const
name|char
operator|*
operator|)
name|NULL
argument_list|)
expr_stmt|;
return|return
name|fret
return|;
block|}
end_function

begin_escape
end_escape

begin_comment
comment|/* Dial out on the connection.  */
end_comment

begin_function
name|boolean
name|fconn_dial
parameter_list|(
name|qconn
parameter_list|,
name|puuconf
parameter_list|,
name|qsys
parameter_list|,
name|zphone
parameter_list|,
name|qdialer
parameter_list|,
name|ptdialerfound
parameter_list|)
name|struct
name|sconnection
modifier|*
name|qconn
decl_stmt|;
name|pointer
name|puuconf
decl_stmt|;
specifier|const
name|struct
name|uuconf_system
modifier|*
name|qsys
decl_stmt|;
specifier|const
name|char
modifier|*
name|zphone
decl_stmt|;
name|struct
name|uuconf_dialer
modifier|*
name|qdialer
decl_stmt|;
name|enum
name|tdialerfound
modifier|*
name|ptdialerfound
decl_stmt|;
block|{
name|struct
name|uuconf_dialer
name|sdialer
decl_stmt|;
name|enum
name|tdialerfound
name|tfound
decl_stmt|;
name|boolean
argument_list|(
argument|*pfdial
argument_list|)
name|P
argument_list|(
operator|(
expr|struct
name|sconnection
operator|*
operator|,
name|pointer
operator|,
specifier|const
expr|struct
name|uuconf_system
operator|*
operator|,
specifier|const
name|char
operator|*
operator|,
expr|struct
name|uuconf_dialer
operator|*
operator|,
expr|enum
name|tdialerfound
operator|*
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|qdialer
operator|==
name|NULL
condition|)
name|qdialer
operator|=
operator|&
name|sdialer
expr_stmt|;
if|if
condition|(
name|ptdialerfound
operator|==
name|NULL
condition|)
name|ptdialerfound
operator|=
operator|&
name|tfound
expr_stmt|;
name|qdialer
operator|->
name|uuconf_zname
operator|=
name|NULL
expr_stmt|;
operator|*
name|ptdialerfound
operator|=
name|DIALERFOUND_FALSE
expr_stmt|;
name|pfdial
operator|=
name|qconn
operator|->
name|qcmds
operator|->
name|pfdial
expr_stmt|;
if|if
condition|(
name|pfdial
operator|==
name|NULL
condition|)
return|return
name|TRUE
return|;
return|return
call|(
modifier|*
name|pfdial
call|)
argument_list|(
name|qconn
argument_list|,
name|puuconf
argument_list|,
name|qsys
argument_list|,
name|zphone
argument_list|,
name|qdialer
argument_list|,
name|ptdialerfound
argument_list|)
return|;
block|}
end_function

begin_escape
end_escape

begin_comment
comment|/* Read data from the connection.  */
end_comment

begin_function
name|boolean
name|fconn_read
parameter_list|(
name|qconn
parameter_list|,
name|zbuf
parameter_list|,
name|pclen
parameter_list|,
name|cmin
parameter_list|,
name|ctimeout
parameter_list|,
name|freport
parameter_list|)
name|struct
name|sconnection
modifier|*
name|qconn
decl_stmt|;
name|char
modifier|*
name|zbuf
decl_stmt|;
name|size_t
modifier|*
name|pclen
decl_stmt|;
name|size_t
name|cmin
decl_stmt|;
name|int
name|ctimeout
decl_stmt|;
name|boolean
name|freport
decl_stmt|;
block|{
name|boolean
name|fret
decl_stmt|;
name|fret
operator|=
call|(
modifier|*
name|qconn
operator|->
name|qcmds
operator|->
name|pfread
call|)
argument_list|(
name|qconn
argument_list|,
name|zbuf
argument_list|,
name|pclen
argument_list|,
name|cmin
argument_list|,
name|ctimeout
argument_list|,
name|freport
argument_list|)
expr_stmt|;
if|#
directive|if
name|DEBUG
operator|>
literal|1
if|if
condition|(
name|FDEBUGGING
argument_list|(
name|DEBUG_INCOMING
argument_list|)
condition|)
name|udebug_buffer
argument_list|(
literal|"fconn_read: Read"
argument_list|,
name|zbuf
argument_list|,
operator|*
name|pclen
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|FDEBUGGING
argument_list|(
name|DEBUG_PORT
argument_list|)
condition|)
name|ulog
argument_list|(
name|LOG_DEBUG
argument_list|,
literal|"fconn_read: Read %lu"
argument_list|,
operator|(
name|unsigned
name|long
operator|)
operator|*
name|pclen
argument_list|)
expr_stmt|;
endif|#
directive|endif
return|return
name|fret
return|;
block|}
end_function

begin_comment
comment|/* Write data to the connection.  */
end_comment

begin_function
name|boolean
name|fconn_write
parameter_list|(
name|qconn
parameter_list|,
name|zbuf
parameter_list|,
name|clen
parameter_list|)
name|struct
name|sconnection
modifier|*
name|qconn
decl_stmt|;
specifier|const
name|char
modifier|*
name|zbuf
decl_stmt|;
name|size_t
name|clen
decl_stmt|;
block|{
if|#
directive|if
name|DEBUG
operator|>
literal|1
if|if
condition|(
name|FDEBUGGING
argument_list|(
name|DEBUG_OUTGOING
argument_list|)
condition|)
name|udebug_buffer
argument_list|(
literal|"fconn_write: Writing"
argument_list|,
name|zbuf
argument_list|,
name|clen
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|FDEBUGGING
argument_list|(
name|DEBUG_PORT
argument_list|)
condition|)
name|ulog
argument_list|(
name|LOG_DEBUG
argument_list|,
literal|"fconn_write: Writing %lu"
argument_list|,
operator|(
name|unsigned
name|long
operator|)
name|clen
argument_list|)
expr_stmt|;
endif|#
directive|endif
return|return
call|(
modifier|*
name|qconn
operator|->
name|qcmds
operator|->
name|pfwrite
call|)
argument_list|(
name|qconn
argument_list|,
name|zbuf
argument_list|,
name|clen
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/* Read and write data.  */
end_comment

begin_function
name|boolean
name|fconn_io
parameter_list|(
name|qconn
parameter_list|,
name|zwrite
parameter_list|,
name|pcwrite
parameter_list|,
name|zread
parameter_list|,
name|pcread
parameter_list|)
name|struct
name|sconnection
modifier|*
name|qconn
decl_stmt|;
specifier|const
name|char
modifier|*
name|zwrite
decl_stmt|;
name|size_t
modifier|*
name|pcwrite
decl_stmt|;
name|char
modifier|*
name|zread
decl_stmt|;
name|size_t
modifier|*
name|pcread
decl_stmt|;
block|{
name|boolean
name|fret
decl_stmt|;
if|#
directive|if
name|DEBUG
operator|>
literal|1
name|size_t
name|cwrite
init|=
operator|*
name|pcwrite
decl_stmt|;
name|size_t
name|cread
init|=
operator|*
name|pcread
decl_stmt|;
if|if
condition|(
name|cread
operator|==
literal|0
operator|||
name|cwrite
operator|==
literal|0
condition|)
name|ulog
argument_list|(
name|LOG_FATAL
argument_list|,
literal|"fconn_io: cread %lu; cwrite %lu"
argument_list|,
operator|(
name|unsigned
name|long
operator|)
name|cread
argument_list|,
operator|(
name|unsigned
name|long
operator|)
name|cwrite
argument_list|)
expr_stmt|;
endif|#
directive|endif
if|#
directive|if
name|DEBUG
operator|>
literal|1
if|if
condition|(
name|FDEBUGGING
argument_list|(
name|DEBUG_OUTGOING
argument_list|)
condition|)
name|udebug_buffer
argument_list|(
literal|"fconn_io: Writing"
argument_list|,
name|zwrite
argument_list|,
name|cwrite
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|fret
operator|=
call|(
modifier|*
name|qconn
operator|->
name|qcmds
operator|->
name|pfio
call|)
argument_list|(
name|qconn
argument_list|,
name|zwrite
argument_list|,
name|pcwrite
argument_list|,
name|zread
argument_list|,
name|pcread
argument_list|)
expr_stmt|;
name|DEBUG_MESSAGE4
argument_list|(
name|DEBUG_PORT
argument_list|,
literal|"fconn_io: Wrote %lu of %lu, read %lu of %lu"
argument_list|,
operator|(
name|unsigned
name|long
operator|)
operator|*
name|pcwrite
argument_list|,
operator|(
name|unsigned
name|long
operator|)
name|cwrite
argument_list|,
operator|(
name|unsigned
name|long
operator|)
operator|*
name|pcread
argument_list|,
operator|(
name|unsigned
name|long
operator|)
name|cread
argument_list|)
expr_stmt|;
if|#
directive|if
name|DEBUG
operator|>
literal|1
if|if
condition|(
operator|*
name|pcread
operator|>
literal|0
operator|&&
name|FDEBUGGING
argument_list|(
name|DEBUG_INCOMING
argument_list|)
condition|)
name|udebug_buffer
argument_list|(
literal|"fconn_io: Read"
argument_list|,
name|zread
argument_list|,
operator|*
name|pcread
argument_list|)
expr_stmt|;
endif|#
directive|endif
return|return
name|fret
return|;
block|}
end_function

begin_comment
comment|/* Send a break character to a connection.  Some port types may not    support break characters, in which case we just return TRUE.  */
end_comment

begin_function
name|boolean
name|fconn_break
parameter_list|(
name|qconn
parameter_list|)
name|struct
name|sconnection
modifier|*
name|qconn
decl_stmt|;
block|{
name|boolean
argument_list|(
argument|*pfbreak
argument_list|)
name|P
argument_list|(
operator|(
expr|struct
name|sconnection
operator|*
operator|)
argument_list|)
expr_stmt|;
name|pfbreak
operator|=
name|qconn
operator|->
name|qcmds
operator|->
name|pfbreak
expr_stmt|;
if|if
condition|(
name|pfbreak
operator|==
name|NULL
condition|)
return|return
name|TRUE
return|;
name|DEBUG_MESSAGE0
argument_list|(
name|DEBUG_PORT
argument_list|,
literal|"fconn_break: Sending break character"
argument_list|)
expr_stmt|;
return|return
call|(
modifier|*
name|pfbreak
call|)
argument_list|(
name|qconn
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/* Change the setting of a connection.  Some port types may not    support this, in which case we just return TRUE.  */
end_comment

begin_function
name|boolean
name|fconn_set
parameter_list|(
name|qconn
parameter_list|,
name|tparity
parameter_list|,
name|tstrip
parameter_list|,
name|txonxoff
parameter_list|)
name|struct
name|sconnection
modifier|*
name|qconn
decl_stmt|;
name|enum
name|tparitysetting
name|tparity
decl_stmt|;
name|enum
name|tstripsetting
name|tstrip
decl_stmt|;
name|enum
name|txonxoffsetting
name|txonxoff
decl_stmt|;
block|{
name|boolean
argument_list|(
argument|*pfset
argument_list|)
name|P
argument_list|(
operator|(
expr|struct
name|sconnection
operator|*
operator|,
expr|enum
name|tparitysetting
operator|,
expr|enum
name|tstripsetting
operator|,
expr|enum
name|txonxoffsetting
operator|)
argument_list|)
expr_stmt|;
name|pfset
operator|=
name|qconn
operator|->
name|qcmds
operator|->
name|pfset
expr_stmt|;
if|if
condition|(
name|pfset
operator|==
name|NULL
condition|)
return|return
name|TRUE
return|;
name|DEBUG_MESSAGE3
argument_list|(
name|DEBUG_PORT
argument_list|,
literal|"fconn_set: Changing setting to %d, %d, %d"
argument_list|,
operator|(
name|int
operator|)
name|tparity
argument_list|,
operator|(
name|int
operator|)
name|tstrip
argument_list|,
operator|(
name|int
operator|)
name|txonxoff
argument_list|)
expr_stmt|;
return|return
call|(
modifier|*
name|pfset
call|)
argument_list|(
name|qconn
argument_list|,
name|tparity
argument_list|,
name|tstrip
argument_list|,
name|txonxoff
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/* Require or ignore carrier on a connection.  */
end_comment

begin_function
name|boolean
name|fconn_carrier
parameter_list|(
name|qconn
parameter_list|,
name|fcarrier
parameter_list|)
name|struct
name|sconnection
modifier|*
name|qconn
decl_stmt|;
name|boolean
name|fcarrier
decl_stmt|;
block|{
name|boolean
argument_list|(
argument|*pfcarrier
argument_list|)
name|P
argument_list|(
operator|(
expr|struct
name|sconnection
operator|*
operator|,
name|boolean
operator|)
argument_list|)
expr_stmt|;
name|pfcarrier
operator|=
name|qconn
operator|->
name|qcmds
operator|->
name|pfcarrier
expr_stmt|;
if|if
condition|(
name|pfcarrier
operator|==
name|NULL
condition|)
return|return
name|TRUE
return|;
return|return
call|(
modifier|*
name|pfcarrier
call|)
argument_list|(
name|qconn
argument_list|,
name|fcarrier
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/* Run a chat program on a connection.  */
end_comment

begin_function
name|boolean
name|fconn_run_chat
parameter_list|(
name|qconn
parameter_list|,
name|pzprog
parameter_list|)
name|struct
name|sconnection
modifier|*
name|qconn
decl_stmt|;
name|char
modifier|*
modifier|*
name|pzprog
decl_stmt|;
block|{
return|return
call|(
modifier|*
name|qconn
operator|->
name|qcmds
operator|->
name|pfchat
call|)
argument_list|(
name|qconn
argument_list|,
name|pzprog
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/* Get the baud rate of a connection.  */
end_comment

begin_function
name|long
name|iconn_baud
parameter_list|(
name|qconn
parameter_list|)
name|struct
name|sconnection
modifier|*
name|qconn
decl_stmt|;
block|{
name|long
argument_list|(
argument|*pibaud
argument_list|)
name|P
argument_list|(
operator|(
expr|struct
name|sconnection
operator|*
operator|)
argument_list|)
expr_stmt|;
name|pibaud
operator|=
name|qconn
operator|->
name|qcmds
operator|->
name|pibaud
expr_stmt|;
if|if
condition|(
name|pibaud
operator|==
name|NULL
condition|)
return|return
literal|0
return|;
return|return
call|(
modifier|*
name|pibaud
call|)
argument_list|(
name|qconn
argument_list|)
return|;
block|}
end_function

begin_escape
end_escape

begin_comment
comment|/* Run through a dialer sequence.  The pzdialer argument is a list of    strings, which are considered in dialer/token pairs.  The dialer    string names a dialer to use.  The token string is what \D and \T    in the chat script expand to.  If there is no token for the last    dialer, the zphone argument is used.  The qdialer argument is    filled in with information for the first dialer, and *ptdialerfound    is set to whether the information should be freed or not.  However,    if *ptdialerfound is not DIALERFOUND_FALSE when this function is    called, then the information for the first dialer is already in    qdialer.  */
end_comment

begin_function
name|boolean
name|fconn_dial_sequence
parameter_list|(
name|qconn
parameter_list|,
name|puuconf
parameter_list|,
name|pzdialer
parameter_list|,
name|qsys
parameter_list|,
name|zphone
parameter_list|,
name|qdialer
parameter_list|,
name|ptdialerfound
parameter_list|)
name|struct
name|sconnection
modifier|*
name|qconn
decl_stmt|;
name|pointer
name|puuconf
decl_stmt|;
name|char
modifier|*
modifier|*
name|pzdialer
decl_stmt|;
specifier|const
name|struct
name|uuconf_system
modifier|*
name|qsys
decl_stmt|;
specifier|const
name|char
modifier|*
name|zphone
decl_stmt|;
name|struct
name|uuconf_dialer
modifier|*
name|qdialer
decl_stmt|;
name|enum
name|tdialerfound
modifier|*
name|ptdialerfound
decl_stmt|;
block|{
specifier|const
name|char
modifier|*
name|zname
decl_stmt|;
name|boolean
name|ffirst
decl_stmt|,
name|ffreefirst
decl_stmt|;
if|if
condition|(
name|qconn
operator|->
name|qport
operator|==
name|NULL
condition|)
name|zname
operator|=
name|NULL
expr_stmt|;
else|else
name|zname
operator|=
name|qconn
operator|->
name|qport
operator|->
name|uuconf_zname
expr_stmt|;
name|ffirst
operator|=
name|TRUE
expr_stmt|;
name|ffreefirst
operator|=
name|FALSE
expr_stmt|;
while|while
condition|(
operator|*
name|pzdialer
operator|!=
name|NULL
condition|)
block|{
name|struct
name|uuconf_dialer
modifier|*
name|q
decl_stmt|;
name|struct
name|uuconf_dialer
name|s
decl_stmt|;
specifier|const
name|char
modifier|*
name|ztoken
decl_stmt|;
name|boolean
name|ftranslate
decl_stmt|;
if|if
condition|(
operator|!
name|ffirst
condition|)
name|q
operator|=
operator|&
name|s
expr_stmt|;
else|else
name|q
operator|=
name|qdialer
expr_stmt|;
if|if
condition|(
operator|!
name|ffirst
operator|||
operator|*
name|ptdialerfound
operator|==
name|DIALERFOUND_FALSE
condition|)
block|{
name|int
name|iuuconf
decl_stmt|;
name|iuuconf
operator|=
name|uuconf_dialer_info
argument_list|(
name|puuconf
argument_list|,
operator|*
name|pzdialer
argument_list|,
name|q
argument_list|)
expr_stmt|;
if|if
condition|(
name|iuuconf
operator|==
name|UUCONF_NOT_FOUND
condition|)
block|{
name|ulog
argument_list|(
name|LOG_ERROR
argument_list|,
literal|"%s: Dialer not found"
argument_list|,
operator|*
name|pzdialer
argument_list|)
expr_stmt|;
if|if
condition|(
name|ffreefirst
condition|)
operator|(
name|void
operator|)
name|uuconf_dialer_free
argument_list|(
name|puuconf
argument_list|,
name|qdialer
argument_list|)
expr_stmt|;
return|return
name|FALSE
return|;
block|}
elseif|else
if|if
condition|(
name|iuuconf
operator|!=
name|UUCONF_SUCCESS
condition|)
block|{
name|ulog_uuconf
argument_list|(
name|LOG_ERROR
argument_list|,
name|puuconf
argument_list|,
name|iuuconf
argument_list|)
expr_stmt|;
if|if
condition|(
name|ffreefirst
condition|)
operator|(
name|void
operator|)
name|uuconf_dialer_free
argument_list|(
name|puuconf
argument_list|,
name|qdialer
argument_list|)
expr_stmt|;
return|return
name|FALSE
return|;
block|}
if|if
condition|(
name|ffirst
condition|)
block|{
operator|*
name|ptdialerfound
operator|=
name|DIALERFOUND_FREE
expr_stmt|;
name|ffreefirst
operator|=
name|TRUE
expr_stmt|;
block|}
block|}
operator|++
name|pzdialer
expr_stmt|;
name|ztoken
operator|=
operator|*
name|pzdialer
expr_stmt|;
name|ftranslate
operator|=
name|FALSE
expr_stmt|;
if|if
condition|(
name|ztoken
operator|==
name|NULL
operator|||
name|strcmp
argument_list|(
name|ztoken
argument_list|,
literal|"\\D"
argument_list|)
operator|==
literal|0
condition|)
name|ztoken
operator|=
name|zphone
expr_stmt|;
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|ztoken
argument_list|,
literal|"\\T"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|ztoken
operator|=
name|zphone
expr_stmt|;
name|ftranslate
operator|=
name|TRUE
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|fchat
argument_list|(
name|qconn
argument_list|,
name|puuconf
argument_list|,
operator|&
name|q
operator|->
name|uuconf_schat
argument_list|,
name|qsys
argument_list|,
name|q
argument_list|,
name|ztoken
argument_list|,
name|ftranslate
argument_list|,
name|zname
argument_list|,
name|iconn_baud
argument_list|(
name|qconn
argument_list|)
argument_list|)
condition|)
block|{
if|if
condition|(
name|q
operator|==
operator|&
name|s
condition|)
operator|(
name|void
operator|)
name|uuconf_dialer_free
argument_list|(
name|puuconf
argument_list|,
name|q
argument_list|)
expr_stmt|;
if|if
condition|(
name|ffreefirst
condition|)
operator|(
name|void
operator|)
name|uuconf_dialer_free
argument_list|(
name|puuconf
argument_list|,
name|qdialer
argument_list|)
expr_stmt|;
return|return
name|FALSE
return|;
block|}
if|if
condition|(
name|ffirst
condition|)
name|ffirst
operator|=
name|FALSE
expr_stmt|;
else|else
operator|(
name|void
operator|)
name|uuconf_dialer_free
argument_list|(
name|puuconf
argument_list|,
name|q
argument_list|)
expr_stmt|;
if|if
condition|(
operator|*
name|pzdialer
operator|!=
name|NULL
condition|)
operator|++
name|pzdialer
expr_stmt|;
block|}
return|return
name|TRUE
return|;
block|}
end_function

begin_escape
end_escape

begin_comment
comment|/* Modem dialing routine.  */
end_comment

begin_comment
comment|/*ARGSUSED*/
end_comment

begin_function
name|boolean
name|fmodem_dial
parameter_list|(
name|qconn
parameter_list|,
name|puuconf
parameter_list|,
name|qsys
parameter_list|,
name|zphone
parameter_list|,
name|qdialer
parameter_list|,
name|ptdialerfound
parameter_list|)
name|struct
name|sconnection
modifier|*
name|qconn
decl_stmt|;
name|pointer
name|puuconf
decl_stmt|;
specifier|const
name|struct
name|uuconf_system
modifier|*
name|qsys
decl_stmt|;
specifier|const
name|char
modifier|*
name|zphone
decl_stmt|;
name|struct
name|uuconf_dialer
modifier|*
name|qdialer
decl_stmt|;
name|enum
name|tdialerfound
modifier|*
name|ptdialerfound
decl_stmt|;
block|{
name|char
modifier|*
modifier|*
name|pzdialer
decl_stmt|;
operator|*
name|ptdialerfound
operator|=
name|DIALERFOUND_FALSE
expr_stmt|;
name|pzdialer
operator|=
name|qconn
operator|->
name|qport
operator|->
name|uuconf_u
operator|.
name|uuconf_smodem
operator|.
name|uuconf_pzdialer
expr_stmt|;
if|if
condition|(
name|pzdialer
operator|!=
name|NULL
operator|&&
operator|*
name|pzdialer
operator|!=
name|NULL
condition|)
block|{
name|int
name|iuuconf
decl_stmt|;
name|boolean
name|fret
decl_stmt|;
name|iuuconf
operator|=
name|uuconf_dialer_info
argument_list|(
name|puuconf
argument_list|,
operator|*
name|pzdialer
argument_list|,
name|qdialer
argument_list|)
expr_stmt|;
if|if
condition|(
name|iuuconf
operator|==
name|UUCONF_NOT_FOUND
condition|)
block|{
name|ulog
argument_list|(
name|LOG_ERROR
argument_list|,
literal|"%s: Dialer not found"
argument_list|,
operator|*
name|pzdialer
argument_list|)
expr_stmt|;
return|return
name|FALSE
return|;
block|}
elseif|else
if|if
condition|(
name|iuuconf
operator|!=
name|UUCONF_SUCCESS
condition|)
block|{
name|ulog_uuconf
argument_list|(
name|LOG_ERROR
argument_list|,
name|puuconf
argument_list|,
name|iuuconf
argument_list|)
expr_stmt|;
return|return
name|FALSE
return|;
block|}
operator|*
name|ptdialerfound
operator|=
name|DIALERFOUND_FREE
expr_stmt|;
name|fret
operator|=
operator|(
name|fsysdep_modem_begin_dial
argument_list|(
name|qconn
argument_list|,
name|qdialer
argument_list|)
operator|&&
name|fconn_dial_sequence
argument_list|(
name|qconn
argument_list|,
name|puuconf
argument_list|,
name|pzdialer
argument_list|,
name|qsys
argument_list|,
name|zphone
argument_list|,
name|qdialer
argument_list|,
name|ptdialerfound
argument_list|)
operator|&&
name|fsysdep_modem_end_dial
argument_list|(
name|qconn
argument_list|,
name|qdialer
argument_list|)
operator|)
expr_stmt|;
if|if
condition|(
operator|!
name|fret
condition|)
operator|(
name|void
operator|)
name|uuconf_dialer_free
argument_list|(
name|puuconf
argument_list|,
name|qdialer
argument_list|)
expr_stmt|;
return|return
name|fret
return|;
block|}
elseif|else
if|if
condition|(
name|qconn
operator|->
name|qport
operator|->
name|uuconf_u
operator|.
name|uuconf_smodem
operator|.
name|uuconf_qdialer
operator|!=
name|NULL
condition|)
block|{
name|struct
name|uuconf_dialer
modifier|*
name|q
decl_stmt|;
specifier|const
name|char
modifier|*
name|zname
decl_stmt|;
name|q
operator|=
name|qconn
operator|->
name|qport
operator|->
name|uuconf_u
operator|.
name|uuconf_smodem
operator|.
name|uuconf_qdialer
expr_stmt|;
operator|*
name|qdialer
operator|=
operator|*
name|q
expr_stmt|;
operator|*
name|ptdialerfound
operator|=
name|DIALERFOUND_TRUE
expr_stmt|;
if|if
condition|(
name|qconn
operator|->
name|qport
operator|==
name|NULL
condition|)
name|zname
operator|=
name|NULL
expr_stmt|;
else|else
name|zname
operator|=
name|qconn
operator|->
name|qport
operator|->
name|uuconf_zname
expr_stmt|;
return|return
operator|(
name|fsysdep_modem_begin_dial
argument_list|(
name|qconn
argument_list|,
name|q
argument_list|)
operator|&&
name|fchat
argument_list|(
name|qconn
argument_list|,
name|puuconf
argument_list|,
operator|&
name|q
operator|->
name|uuconf_schat
argument_list|,
name|qsys
argument_list|,
name|q
argument_list|,
name|zphone
argument_list|,
name|FALSE
argument_list|,
name|zname
argument_list|,
name|iconn_baud
argument_list|(
name|qconn
argument_list|)
argument_list|)
operator|&&
name|fsysdep_modem_end_dial
argument_list|(
name|qconn
argument_list|,
name|q
argument_list|)
operator|)
return|;
block|}
else|else
block|{
name|ulog
argument_list|(
name|LOG_ERROR
argument_list|,
literal|"No dialer information"
argument_list|)
expr_stmt|;
return|return
name|FALSE
return|;
block|}
block|}
end_function

end_unit


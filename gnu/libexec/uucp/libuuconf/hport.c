begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/* hport.c    Find a port in the HDB configuration files.     Copyright (C) 1992, 1993 Ian Lance Taylor     This file is part of the Taylor UUCP uuconf library.     This library is free software; you can redistribute it and/or    modify it under the terms of the GNU Library General Public License    as published by the Free Software Foundation; either version 2 of    the License, or (at your option) any later version.     This library is distributed in the hope that it will be useful, but    WITHOUT ANY WARRANTY; without even the implied warranty of    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU    Library General Public License for more details.     You should have received a copy of the GNU Library General Public    License along with this library; if not, write to the Free Software    Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.     The author of the program may be contacted at ian@airs.com or    c/o Cygnus Support, 48 Grove Street, Somerville, MA 02144.    */
end_comment

begin_include
include|#
directive|include
file|"uucnfi.h"
end_include

begin_if
if|#
directive|if
name|USE_RCS_ID
end_if

begin_decl_stmt
specifier|const
name|char
name|_uuconf_hport_rcsid
index|[]
init|=
literal|"$FreeBSD$"
decl_stmt|;
end_decl_stmt

begin_endif
endif|#
directive|endif
end_endif

begin_include
include|#
directive|include
file|<sys/socket.h>
end_include

begin_include
include|#
directive|include
file|<errno.h>
end_include

begin_include
include|#
directive|include
file|<ctype.h>
end_include

begin_escape
end_escape

begin_comment
comment|/* Find a port in the HDB configuration files by name, baud rate, and    special purpose function.  */
end_comment

begin_function_decl
name|int
name|uuconf_hdb_find_port
parameter_list|(
name|pglobal
parameter_list|,
name|zname
parameter_list|,
name|ibaud
parameter_list|,
name|ihighbaud
parameter_list|,
name|pifn
parameter_list|,
name|pinfo
parameter_list|,
name|qport
parameter_list|)
name|pointer
name|pglobal
decl_stmt|;
specifier|const
name|char
modifier|*
name|zname
decl_stmt|;
name|long
name|ibaud
decl_stmt|;
name|long
name|ihighbaud
decl_stmt|;
function_decl|int
parameter_list|(
function_decl|*pifn
end_function_decl

begin_expr_stmt
unit|)
name|P
argument_list|(
operator|(
expr|struct
name|uuconf_port
operator|*
operator|,
name|pointer
operator|)
argument_list|)
expr_stmt|;
end_expr_stmt

begin_decl_stmt
name|pointer
name|pinfo
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|struct
name|uuconf_port
modifier|*
name|qport
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|struct
name|sglobal
modifier|*
name|qglobal
init|=
operator|(
expr|struct
name|sglobal
operator|*
operator|)
name|pglobal
decl_stmt|;
name|char
modifier|*
name|zline
decl_stmt|;
name|size_t
name|cline
decl_stmt|;
name|char
modifier|*
modifier|*
name|pzsplit
decl_stmt|;
name|size_t
name|csplit
decl_stmt|;
name|int
name|iret
decl_stmt|;
name|char
modifier|*
modifier|*
name|pz
decl_stmt|;
name|zline
operator|=
name|NULL
expr_stmt|;
name|cline
operator|=
literal|0
expr_stmt|;
name|pzsplit
operator|=
name|NULL
expr_stmt|;
name|csplit
operator|=
literal|0
expr_stmt|;
name|iret
operator|=
name|UUCONF_NOT_FOUND
expr_stmt|;
for|for
control|(
name|pz
operator|=
name|qglobal
operator|->
name|qprocess
operator|->
name|pzhdb_devices
init|;
operator|*
name|pz
operator|!=
name|NULL
condition|;
name|pz
operator|++
control|)
block|{
name|FILE
modifier|*
name|e
decl_stmt|;
name|int
name|cchars
decl_stmt|;
name|qglobal
operator|->
name|ilineno
operator|=
literal|0
expr_stmt|;
name|e
operator|=
name|fopen
argument_list|(
operator|*
name|pz
argument_list|,
literal|"r"
argument_list|)
expr_stmt|;
if|if
condition|(
name|e
operator|==
name|NULL
condition|)
block|{
if|if
condition|(
name|FNO_SUCH_FILE
argument_list|()
condition|)
continue|continue;
name|qglobal
operator|->
name|ierrno
operator|=
name|errno
expr_stmt|;
name|iret
operator|=
name|UUCONF_FOPEN_FAILED
operator||
name|UUCONF_ERROR_ERRNO
expr_stmt|;
break|break;
block|}
name|iret
operator|=
name|UUCONF_NOT_FOUND
expr_stmt|;
while|while
condition|(
operator|(
name|cchars
operator|=
name|_uuconf_getline
argument_list|(
name|qglobal
argument_list|,
operator|&
name|zline
argument_list|,
operator|&
name|cline
argument_list|,
name|e
argument_list|)
operator|)
operator|>
literal|0
condition|)
block|{
name|int
name|ctoks
decl_stmt|;
name|char
modifier|*
name|z
decl_stmt|,
modifier|*
name|zprotos
decl_stmt|,
modifier|*
name|zport
decl_stmt|;
name|long
name|ilow
decl_stmt|,
name|ihigh
decl_stmt|;
name|pointer
name|pblock
decl_stmt|;
name|char
modifier|*
modifier|*
modifier|*
name|ppzdialer
decl_stmt|;
operator|++
name|qglobal
operator|->
name|ilineno
expr_stmt|;
name|iret
operator|=
name|UUCONF_NOT_FOUND
expr_stmt|;
operator|--
name|cchars
expr_stmt|;
if|if
condition|(
name|zline
index|[
name|cchars
index|]
operator|==
literal|'\n'
condition|)
name|zline
index|[
name|cchars
index|]
operator|=
literal|'\0'
expr_stmt|;
if|if
condition|(
name|isspace
argument_list|(
name|BUCHAR
argument_list|(
name|zline
index|[
literal|0
index|]
argument_list|)
argument_list|)
operator|||
name|zline
index|[
literal|0
index|]
operator|==
literal|'#'
condition|)
continue|continue;
name|ctoks
operator|=
name|_uuconf_istrsplit
argument_list|(
name|zline
argument_list|,
literal|'\0'
argument_list|,
operator|&
name|pzsplit
argument_list|,
operator|&
name|csplit
argument_list|)
expr_stmt|;
if|if
condition|(
name|ctoks
operator|<
literal|0
condition|)
block|{
name|qglobal
operator|->
name|ierrno
operator|=
name|errno
expr_stmt|;
name|iret
operator|=
name|UUCONF_MALLOC_FAILED
operator||
name|UUCONF_ERROR_ERRNO
expr_stmt|;
break|break;
block|}
comment|/* An entry in Devices is  	     type device dial-device baud dialer-token pairs  	     The type (normally "ACU") is treated as the name.  */
comment|/* If there aren't enough entries, ignore the line; this 	     should probably do something more useful.  */
if|if
condition|(
name|ctoks
operator|<
literal|4
condition|)
continue|continue;
comment|/* There may be a comma separated list of protocols after 	     the name.  */
name|zprotos
operator|=
name|strchr
argument_list|(
name|pzsplit
index|[
literal|0
index|]
argument_list|,
literal|','
argument_list|)
expr_stmt|;
if|if
condition|(
name|zprotos
operator|!=
name|NULL
condition|)
block|{
operator|*
name|zprotos
operator|=
literal|'\0'
expr_stmt|;
operator|++
name|zprotos
expr_stmt|;
block|}
name|zport
operator|=
name|pzsplit
index|[
literal|0
index|]
expr_stmt|;
comment|/* Get any modem class, and pick up the baud rate while 	     we're at it.  The modem class will be appended to the 	     name, so we need to get it before we see if we've found 	     the port with the right name.  */
name|z
operator|=
name|pzsplit
index|[
literal|3
index|]
expr_stmt|;
if|if
condition|(
name|strcasecmp
argument_list|(
name|z
argument_list|,
literal|"Any"
argument_list|)
operator|==
literal|0
operator|||
name|strcmp
argument_list|(
name|z
argument_list|,
literal|"-"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|ilow
operator|=
literal|0L
expr_stmt|;
name|ihigh
operator|=
literal|0L
expr_stmt|;
block|}
else|else
block|{
name|char
modifier|*
name|zend
decl_stmt|;
while|while
condition|(
operator|*
name|z
operator|!=
literal|'\0'
operator|&&
operator|!
name|isdigit
argument_list|(
name|BUCHAR
argument_list|(
operator|*
name|z
argument_list|)
argument_list|)
condition|)
operator|++
name|z
expr_stmt|;
name|ilow
operator|=
name|strtol
argument_list|(
name|z
argument_list|,
operator|&
name|zend
argument_list|,
literal|10
argument_list|)
expr_stmt|;
if|if
condition|(
operator|*
name|zend
operator|==
literal|'-'
condition|)
name|ihigh
operator|=
name|strtol
argument_list|(
name|zend
operator|+
literal|1
argument_list|,
operator|(
name|char
operator|*
operator|*
operator|)
name|NULL
argument_list|,
literal|10
argument_list|)
expr_stmt|;
else|else
name|ihigh
operator|=
name|ilow
expr_stmt|;
if|if
condition|(
name|z
operator|!=
name|pzsplit
index|[
literal|3
index|]
condition|)
block|{
name|size_t
name|cclass
decl_stmt|,
name|cport
decl_stmt|;
name|cclass
operator|=
name|z
operator|-
name|pzsplit
index|[
literal|3
index|]
expr_stmt|;
name|cport
operator|=
name|strlen
argument_list|(
name|pzsplit
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
name|zport
operator|=
name|malloc
argument_list|(
name|cport
operator|+
name|cclass
operator|+
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|zport
operator|==
name|NULL
condition|)
block|{
name|qglobal
operator|->
name|ierrno
operator|=
name|errno
expr_stmt|;
name|iret
operator|=
name|UUCONF_MALLOC_FAILED
operator||
name|UUCONF_ERROR_ERRNO
expr_stmt|;
break|break;
block|}
name|memcpy
argument_list|(
operator|(
name|pointer
operator|)
name|zport
argument_list|,
operator|(
name|pointer
operator|)
name|pzsplit
index|[
literal|0
index|]
argument_list|,
name|cport
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
call|(
name|pointer
call|)
argument_list|(
name|zport
operator|+
name|cport
argument_list|)
argument_list|,
operator|(
name|pointer
operator|)
name|pzsplit
index|[
literal|3
index|]
argument_list|,
name|cclass
argument_list|)
expr_stmt|;
name|zport
index|[
name|cport
operator|+
name|cclass
index|]
operator|=
literal|'\0'
expr_stmt|;
block|}
block|}
comment|/* Make sure the name and baud rate match any argument.  */
if|if
condition|(
operator|(
name|zname
operator|!=
name|NULL
operator|&&
name|strcmp
argument_list|(
name|zport
argument_list|,
name|zname
argument_list|)
operator|!=
literal|0
operator|)
operator|||
operator|(
name|ibaud
operator|!=
literal|0
operator|&&
name|ilow
operator|!=
literal|0
operator|&&
operator|(
name|ilow
operator|>
name|ibaud
operator|||
name|ihigh
operator|<
name|ibaud
operator|)
operator|)
condition|)
block|{
if|if
condition|(
name|zport
operator|!=
name|pzsplit
index|[
literal|0
index|]
condition|)
name|free
argument_list|(
operator|(
name|pointer
operator|)
name|zport
argument_list|)
expr_stmt|;
continue|continue;
block|}
comment|/* Some systems permit ,M after the device name.  This means 	     to open the port with O_NDELAY and then change it.  We 	     just ignore this flag, although perhaps we should record 	     it somewhere.  */
name|pzsplit
index|[
literal|1
index|]
index|[
name|strcspn
argument_list|(
name|pzsplit
index|[
literal|1
index|]
argument_list|,
literal|","
argument_list|)
index|]
operator|=
literal|'\0'
expr_stmt|;
comment|/* Now we must construct the port information, so that we 	     can pass it to pifn.  The port type is determined by its 	     name, unfortunately.  The name "Direct" is used for a 	     direct port, "TCP" for a TCP port, and anything else for 	     a modem port.  */
name|pblock
operator|=
name|NULL
expr_stmt|;
name|_uuconf_uclear_port
argument_list|(
name|qport
argument_list|)
expr_stmt|;
name|qport
operator|->
name|uuconf_zname
operator|=
name|zport
expr_stmt|;
name|qport
operator|->
name|uuconf_zprotocols
operator|=
name|zprotos
expr_stmt|;
if|if
condition|(
name|strcmp
argument_list|(
name|pzsplit
index|[
literal|0
index|]
argument_list|,
literal|"Direct"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|qport
operator|->
name|uuconf_ttype
operator|=
name|UUCONF_PORTTYPE_DIRECT
expr_stmt|;
name|qport
operator|->
name|uuconf_u
operator|.
name|uuconf_sdirect
operator|.
name|uuconf_zdevice
operator|=
name|pzsplit
index|[
literal|1
index|]
expr_stmt|;
name|qport
operator|->
name|uuconf_u
operator|.
name|uuconf_sdirect
operator|.
name|uuconf_ibaud
operator|=
name|ilow
expr_stmt|;
name|qport
operator|->
name|uuconf_u
operator|.
name|uuconf_sdirect
operator|.
name|uuconf_fcarrier
operator|=
name|FALSE
expr_stmt|;
name|qport
operator|->
name|uuconf_u
operator|.
name|uuconf_sdirect
operator|.
name|uuconf_fhardflow
operator|=
name|TRUE
expr_stmt|;
name|ppzdialer
operator|=
name|NULL
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|pzsplit
index|[
literal|0
index|]
argument_list|,
literal|"TCP"
argument_list|)
operator|==
literal|0
condition|)
block|{
comment|/* For a TCP port, the device name is taken as the TCP 		 port to use.  */
name|qport
operator|->
name|uuconf_ttype
operator|=
name|UUCONF_PORTTYPE_TCP
expr_stmt|;
name|qport
operator|->
name|uuconf_ireliable
operator|=
operator|(
name|UUCONF_RELIABLE_ENDTOEND
operator||
name|UUCONF_RELIABLE_RELIABLE
operator||
name|UUCONF_RELIABLE_EIGHT
operator||
name|UUCONF_RELIABLE_FULLDUPLEX
operator||
name|UUCONF_RELIABLE_SPECIFIED
operator|)
expr_stmt|;
name|qport
operator|->
name|uuconf_u
operator|.
name|uuconf_stcp
operator|.
name|uuconf_zport
operator|=
name|pzsplit
index|[
literal|1
index|]
expr_stmt|;
comment|/* I leave with IPv4 only for compatibility reason.  If                  you wish to use IPv6, please try Taylor UUCP                  configuration instead.  If you still wish to use IPv6                  with HDB configuration, re-make with INET6 defined.                  In this case, you cannot specify the protocol family                  in HDB configuration file.  */
ifdef|#
directive|ifdef
name|INET6
name|qport
operator|->
name|uuconf_u
operator|.
name|uuconf_stcp
operator|.
name|uuconf_zfamily
operator|=
name|PF_UNSPEC
expr_stmt|;
else|#
directive|else
name|qport
operator|->
name|uuconf_u
operator|.
name|uuconf_stcp
operator|.
name|uuconf_zfamily
operator|=
name|PF_INET
expr_stmt|;
endif|#
directive|endif
name|ppzdialer
operator|=
operator|&
name|qport
operator|->
name|uuconf_u
operator|.
name|uuconf_stcp
operator|.
name|uuconf_pzdialer
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|ctoks
operator|>=
literal|5
operator|&&
operator|(
name|strcmp
argument_list|(
name|pzsplit
index|[
literal|4
index|]
argument_list|,
literal|"TLI"
argument_list|)
operator|==
literal|0
operator|||
name|strcmp
argument_list|(
name|pzsplit
index|[
literal|4
index|]
argument_list|,
literal|"TLIS"
argument_list|)
operator|==
literal|0
operator|)
condition|)
block|{
name|qport
operator|->
name|uuconf_ttype
operator|=
name|UUCONF_PORTTYPE_TLI
expr_stmt|;
name|qport
operator|->
name|uuconf_u
operator|.
name|uuconf_stli
operator|.
name|uuconf_zdevice
operator|=
name|pzsplit
index|[
literal|1
index|]
expr_stmt|;
name|qport
operator|->
name|uuconf_u
operator|.
name|uuconf_stli
operator|.
name|uuconf_fstream
operator|=
name|strcmp
argument_list|(
name|pzsplit
index|[
literal|4
index|]
argument_list|,
literal|"TLIS"
argument_list|)
operator|==
literal|0
expr_stmt|;
name|qport
operator|->
name|uuconf_u
operator|.
name|uuconf_stli
operator|.
name|uuconf_pzpush
operator|=
name|NULL
expr_stmt|;
name|qport
operator|->
name|uuconf_u
operator|.
name|uuconf_stli
operator|.
name|uuconf_zservaddr
operator|=
name|NULL
expr_stmt|;
name|qport
operator|->
name|uuconf_ireliable
operator|=
operator|(
name|UUCONF_RELIABLE_ENDTOEND
operator||
name|UUCONF_RELIABLE_RELIABLE
operator||
name|UUCONF_RELIABLE_EIGHT
operator||
name|UUCONF_RELIABLE_FULLDUPLEX
operator||
name|UUCONF_RELIABLE_SPECIFIED
operator|)
expr_stmt|;
name|ppzdialer
operator|=
operator|&
name|qport
operator|->
name|uuconf_u
operator|.
name|uuconf_stli
operator|.
name|uuconf_pzdialer
expr_stmt|;
block|}
else|else
block|{
name|qport
operator|->
name|uuconf_ttype
operator|=
name|UUCONF_PORTTYPE_MODEM
expr_stmt|;
name|qport
operator|->
name|uuconf_u
operator|.
name|uuconf_smodem
operator|.
name|uuconf_zdevice
operator|=
name|pzsplit
index|[
literal|1
index|]
expr_stmt|;
if|if
condition|(
name|strcmp
argument_list|(
name|pzsplit
index|[
literal|2
index|]
argument_list|,
literal|"-"
argument_list|)
operator|!=
literal|0
condition|)
name|qport
operator|->
name|uuconf_u
operator|.
name|uuconf_smodem
operator|.
name|uuconf_zdial_device
operator|=
name|pzsplit
index|[
literal|2
index|]
expr_stmt|;
else|else
name|qport
operator|->
name|uuconf_u
operator|.
name|uuconf_smodem
operator|.
name|uuconf_zdial_device
operator|=
name|NULL
expr_stmt|;
if|if
condition|(
name|ilow
operator|==
name|ihigh
condition|)
block|{
name|qport
operator|->
name|uuconf_u
operator|.
name|uuconf_smodem
operator|.
name|uuconf_ibaud
operator|=
name|ilow
expr_stmt|;
name|qport
operator|->
name|uuconf_u
operator|.
name|uuconf_smodem
operator|.
name|uuconf_ilowbaud
operator|=
literal|0L
expr_stmt|;
name|qport
operator|->
name|uuconf_u
operator|.
name|uuconf_smodem
operator|.
name|uuconf_ihighbaud
operator|=
literal|0L
expr_stmt|;
block|}
else|else
block|{
name|qport
operator|->
name|uuconf_u
operator|.
name|uuconf_smodem
operator|.
name|uuconf_ibaud
operator|=
literal|0L
expr_stmt|;
name|qport
operator|->
name|uuconf_u
operator|.
name|uuconf_smodem
operator|.
name|uuconf_ilowbaud
operator|=
name|ilow
expr_stmt|;
name|qport
operator|->
name|uuconf_u
operator|.
name|uuconf_smodem
operator|.
name|uuconf_ihighbaud
operator|=
name|ihigh
expr_stmt|;
block|}
name|qport
operator|->
name|uuconf_u
operator|.
name|uuconf_smodem
operator|.
name|uuconf_fcarrier
operator|=
name|TRUE
expr_stmt|;
name|qport
operator|->
name|uuconf_u
operator|.
name|uuconf_smodem
operator|.
name|uuconf_fhardflow
operator|=
name|TRUE
expr_stmt|;
name|qport
operator|->
name|uuconf_u
operator|.
name|uuconf_smodem
operator|.
name|uuconf_qdialer
operator|=
name|NULL
expr_stmt|;
name|ppzdialer
operator|=
operator|&
name|qport
operator|->
name|uuconf_u
operator|.
name|uuconf_smodem
operator|.
name|uuconf_pzdialer
expr_stmt|;
block|}
if|if
condition|(
name|ppzdialer
operator|!=
name|NULL
condition|)
block|{
if|if
condition|(
name|ctoks
operator|<
literal|5
condition|)
operator|*
name|ppzdialer
operator|=
name|NULL
expr_stmt|;
else|else
block|{
name|size_t
name|c
decl_stmt|;
name|char
modifier|*
modifier|*
name|pzd
decl_stmt|;
name|pblock
operator|=
name|uuconf_malloc_block
argument_list|()
expr_stmt|;
if|if
condition|(
name|pblock
operator|==
name|NULL
condition|)
block|{
name|qglobal
operator|->
name|ierrno
operator|=
name|errno
expr_stmt|;
name|iret
operator|=
name|UUCONF_MALLOC_FAILED
operator||
name|UUCONF_ERROR_ERRNO
expr_stmt|;
break|break;
block|}
name|c
operator|=
operator|(
name|ctoks
operator|-
literal|4
operator|)
operator|*
sizeof|sizeof
argument_list|(
name|char
operator|*
argument_list|)
expr_stmt|;
name|pzd
operator|=
operator|(
name|char
operator|*
operator|*
operator|)
name|uuconf_malloc
argument_list|(
name|pblock
argument_list|,
name|c
operator|+
sizeof|sizeof
argument_list|(
name|char
operator|*
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|pzd
operator|==
name|NULL
condition|)
block|{
name|qglobal
operator|->
name|ierrno
operator|=
name|errno
expr_stmt|;
name|uuconf_free_block
argument_list|(
name|pblock
argument_list|)
expr_stmt|;
name|iret
operator|=
name|UUCONF_MALLOC_FAILED
operator||
name|UUCONF_ERROR_ERRNO
expr_stmt|;
break|break;
block|}
name|memcpy
argument_list|(
operator|(
name|pointer
operator|)
name|pzd
argument_list|,
call|(
name|pointer
call|)
argument_list|(
name|pzsplit
operator|+
literal|4
argument_list|)
argument_list|,
name|c
argument_list|)
expr_stmt|;
name|pzd
index|[
name|ctoks
operator|-
literal|4
index|]
operator|=
name|NULL
expr_stmt|;
operator|*
name|ppzdialer
operator|=
name|pzd
expr_stmt|;
block|}
block|}
if|if
condition|(
name|pifn
operator|!=
name|NULL
condition|)
block|{
name|iret
operator|=
call|(
modifier|*
name|pifn
call|)
argument_list|(
name|qport
argument_list|,
name|pinfo
argument_list|)
expr_stmt|;
if|if
condition|(
name|iret
operator|!=
name|UUCONF_SUCCESS
condition|)
block|{
if|if
condition|(
name|zport
operator|!=
name|pzsplit
index|[
literal|0
index|]
condition|)
name|free
argument_list|(
operator|(
name|pointer
operator|)
name|zport
argument_list|)
expr_stmt|;
if|if
condition|(
name|pblock
operator|!=
name|NULL
condition|)
name|uuconf_free_block
argument_list|(
name|pblock
argument_list|)
expr_stmt|;
if|if
condition|(
name|iret
operator|!=
name|UUCONF_NOT_FOUND
condition|)
break|break;
continue|continue;
block|}
block|}
comment|/* This is the port we want.  */
if|if
condition|(
name|pblock
operator|==
name|NULL
condition|)
block|{
name|pblock
operator|=
name|uuconf_malloc_block
argument_list|()
expr_stmt|;
if|if
condition|(
name|pblock
operator|==
name|NULL
condition|)
block|{
name|qglobal
operator|->
name|ierrno
operator|=
name|errno
expr_stmt|;
name|iret
operator|=
name|UUCONF_MALLOC_FAILED
operator||
name|UUCONF_ERROR_ERRNO
expr_stmt|;
break|break;
block|}
block|}
if|if
condition|(
name|uuconf_add_block
argument_list|(
name|pblock
argument_list|,
name|zline
argument_list|)
operator|!=
literal|0
operator|||
operator|(
name|zport
operator|!=
name|pzsplit
index|[
literal|0
index|]
operator|&&
name|uuconf_add_block
argument_list|(
name|pblock
argument_list|,
name|zport
argument_list|)
operator|!=
literal|0
operator|)
condition|)
block|{
name|qglobal
operator|->
name|ierrno
operator|=
name|errno
expr_stmt|;
name|uuconf_free_block
argument_list|(
name|pblock
argument_list|)
expr_stmt|;
name|iret
operator|=
name|UUCONF_MALLOC_FAILED
operator||
name|UUCONF_ERROR_ERRNO
expr_stmt|;
break|break;
block|}
name|zline
operator|=
name|NULL
expr_stmt|;
name|qport
operator|->
name|uuconf_palloc
operator|=
name|pblock
expr_stmt|;
name|iret
operator|=
name|UUCONF_SUCCESS
expr_stmt|;
break|break;
block|}
operator|(
name|void
operator|)
name|fclose
argument_list|(
name|e
argument_list|)
expr_stmt|;
if|if
condition|(
name|iret
operator|!=
name|UUCONF_NOT_FOUND
condition|)
break|break;
block|}
if|if
condition|(
name|zline
operator|!=
name|NULL
condition|)
name|free
argument_list|(
operator|(
name|pointer
operator|)
name|zline
argument_list|)
expr_stmt|;
if|if
condition|(
name|pzsplit
operator|!=
name|NULL
condition|)
name|free
argument_list|(
operator|(
name|pointer
operator|)
name|pzsplit
argument_list|)
expr_stmt|;
if|if
condition|(
name|iret
operator|!=
name|UUCONF_SUCCESS
operator|&&
name|iret
operator|!=
name|UUCONF_NOT_FOUND
condition|)
block|{
name|qglobal
operator|->
name|zfilename
operator|=
operator|*
name|pz
expr_stmt|;
name|iret
operator||=
name|UUCONF_ERROR_FILENAME
operator||
name|UUCONF_ERROR_LINENO
expr_stmt|;
block|}
return|return
name|iret
return|;
block|}
end_block

end_unit


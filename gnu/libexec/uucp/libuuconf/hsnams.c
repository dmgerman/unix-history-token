begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/* hsnams.c    Get all known system names from the HDB configuration files.     Copyright (C) 1992 Ian Lance Taylor     This file is part of the Taylor UUCP uuconf library.     This library is free software; you can redistribute it and/or    modify it under the terms of the GNU Library General Public License    as published by the Free Software Foundation; either version 2 of    the License, or (at your option) any later version.     This library is distributed in the hope that it will be useful, but    WITHOUT ANY WARRANTY; without even the implied warranty of    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU    Library General Public License for more details.     You should have received a copy of the GNU Library General Public    License along with this library; if not, write to the Free Software    Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.     The author of the program may be contacted at ian@airs.com or    c/o Cygnus Support, Building 200, 1 Kendall Square, Cambridge, MA 02139.    */
end_comment

begin_include
include|#
directive|include
file|"uucnfi.h"
end_include

begin_if
if|#
directive|if
name|USE_RCS_ID
end_if

begin_decl_stmt
specifier|const
name|char
name|_uuconf_hsnams_rcsid
index|[]
init|=
literal|"$Id: hsnams.c,v 1.2 1994/05/07 18:12:28 ache Exp $"
decl_stmt|;
end_decl_stmt

begin_endif
endif|#
directive|endif
end_endif

begin_include
include|#
directive|include
file|<errno.h>
end_include

begin_include
include|#
directive|include
file|<ctype.h>
end_include

begin_escape
end_escape

begin_comment
comment|/* Get all the system names from the HDB Systems file.  We have to    read the Permissions file in order to support aliases.  */
end_comment

begin_function
name|int
name|uuconf_hdb_system_names
parameter_list|(
name|pglobal
parameter_list|,
name|ppzsystems
parameter_list|,
name|falias
parameter_list|)
name|pointer
name|pglobal
decl_stmt|;
name|char
modifier|*
modifier|*
modifier|*
name|ppzsystems
decl_stmt|;
name|int
name|falias
decl_stmt|;
block|{
name|struct
name|sglobal
modifier|*
name|qglobal
init|=
operator|(
expr|struct
name|sglobal
operator|*
operator|)
name|pglobal
decl_stmt|;
name|int
name|iret
decl_stmt|;
name|char
modifier|*
name|zline
decl_stmt|;
name|size_t
name|cline
decl_stmt|;
name|char
modifier|*
modifier|*
name|pz
decl_stmt|;
operator|*
name|ppzsystems
operator|=
name|NULL
expr_stmt|;
name|iret
operator|=
name|UUCONF_SUCCESS
expr_stmt|;
name|zline
operator|=
name|NULL
expr_stmt|;
name|cline
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|pz
operator|=
name|qglobal
operator|->
name|qprocess
operator|->
name|pzhdb_systems
init|;
operator|*
name|pz
operator|!=
name|NULL
condition|;
name|pz
operator|++
control|)
block|{
name|FILE
modifier|*
name|e
decl_stmt|;
name|e
operator|=
name|fopen
argument_list|(
operator|*
name|pz
argument_list|,
literal|"r"
argument_list|)
expr_stmt|;
if|if
condition|(
name|e
operator|==
name|NULL
condition|)
block|{
if|if
condition|(
name|FNO_SUCH_FILE
argument_list|()
condition|)
continue|continue;
name|qglobal
operator|->
name|ierrno
operator|=
name|errno
expr_stmt|;
name|iret
operator|=
name|UUCONF_FOPEN_FAILED
operator||
name|UUCONF_ERROR_ERRNO
expr_stmt|;
break|break;
block|}
name|qglobal
operator|->
name|ilineno
operator|=
literal|0
expr_stmt|;
while|while
condition|(
name|_uuconf_getline
argument_list|(
name|qglobal
argument_list|,
operator|&
name|zline
argument_list|,
operator|&
name|cline
argument_list|,
name|e
argument_list|)
operator|>
literal|0
condition|)
block|{
operator|++
name|qglobal
operator|->
name|ilineno
expr_stmt|;
comment|/* Lines beginning with whitespace are treated as comments. 	     No system name can contain a '#', which is another 	     comment character, so eliminating the first '#' does no 	     harm and catches comments.  */
name|zline
index|[
name|strcspn
argument_list|(
name|zline
argument_list|,
literal|" \t#\n"
argument_list|)
index|]
operator|=
literal|'\0'
expr_stmt|;
if|if
condition|(
operator|*
name|zline
operator|==
literal|'\0'
condition|)
continue|continue;
name|iret
operator|=
name|_uuconf_iadd_string
argument_list|(
name|qglobal
argument_list|,
name|zline
argument_list|,
name|TRUE
argument_list|,
name|TRUE
argument_list|,
name|ppzsystems
argument_list|,
operator|(
name|pointer
operator|)
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|iret
operator|!=
name|UUCONF_SUCCESS
condition|)
block|{
name|iret
operator||=
name|UUCONF_ERROR_LINENO
expr_stmt|;
break|break;
block|}
block|}
operator|(
name|void
operator|)
name|fclose
argument_list|(
name|e
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|zline
operator|!=
name|NULL
condition|)
name|free
argument_list|(
operator|(
name|pointer
operator|)
name|zline
argument_list|)
expr_stmt|;
if|if
condition|(
name|iret
operator|!=
name|UUCONF_SUCCESS
condition|)
block|{
name|qglobal
operator|->
name|zfilename
operator|=
operator|*
name|pz
expr_stmt|;
return|return
name|iret
operator||
name|UUCONF_ERROR_FILENAME
return|;
block|}
comment|/* If we are supposed to return aliases, we must read the      Permissions file.  */
if|if
condition|(
name|falias
condition|)
block|{
name|struct
name|shpermissions
modifier|*
name|q
decl_stmt|;
if|if
condition|(
operator|!
name|qglobal
operator|->
name|qprocess
operator|->
name|fhdb_read_permissions
condition|)
block|{
name|iret
operator|=
name|_uuconf_ihread_permissions
argument_list|(
name|qglobal
argument_list|)
expr_stmt|;
if|if
condition|(
name|iret
operator|!=
name|UUCONF_SUCCESS
condition|)
return|return
name|iret
return|;
block|}
for|for
control|(
name|q
operator|=
name|qglobal
operator|->
name|qprocess
operator|->
name|qhdb_permissions
init|;
name|q
operator|!=
name|NULL
condition|;
name|q
operator|=
name|q
operator|->
name|qnext
control|)
block|{
name|pz
operator|=
name|q
operator|->
name|pzalias
expr_stmt|;
if|if
condition|(
name|pz
operator|==
name|NULL
operator|||
name|pz
operator|==
operator|(
name|char
operator|*
operator|*
operator|)
operator|&
name|_uuconf_unset
condition|)
continue|continue;
for|for
control|(
init|;
operator|*
name|pz
operator|!=
name|NULL
condition|;
name|pz
operator|++
control|)
block|{
name|iret
operator|=
name|_uuconf_iadd_string
argument_list|(
name|qglobal
argument_list|,
operator|*
name|pz
argument_list|,
name|TRUE
argument_list|,
name|TRUE
argument_list|,
name|ppzsystems
argument_list|,
operator|(
name|pointer
operator|)
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|iret
operator|!=
name|UUCONF_SUCCESS
condition|)
return|return
name|iret
return|;
block|}
block|}
block|}
if|if
condition|(
operator|*
name|ppzsystems
operator|==
name|NULL
condition|)
name|iret
operator|=
name|_uuconf_iadd_string
argument_list|(
name|qglobal
argument_list|,
operator|(
name|char
operator|*
operator|)
name|NULL
argument_list|,
name|FALSE
argument_list|,
name|FALSE
argument_list|,
name|ppzsystems
argument_list|,
operator|(
name|pointer
operator|)
name|NULL
argument_list|)
expr_stmt|;
return|return
name|iret
return|;
block|}
end_function

end_unit


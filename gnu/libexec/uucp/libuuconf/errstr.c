begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/* errstr.c    Return a string for a uuconf error.     Copyright (C) 1992 Ian Lance Taylor     This file is part of the Taylor UUCP uuconf library.     This library is free software; you can redistribute it and/or    modify it under the terms of the GNU Library General Public License    as published by the Free Software Foundation; either version 2 of    the License, or (at your option) any later version.     This library is distributed in the hope that it will be useful, but    WITHOUT ANY WARRANTY; without even the implied warranty of    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU    Library General Public License for more details.     You should have received a copy of the GNU Library General Public    License along with this library; if not, write to the Free Software    Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.     The author of the program may be contacted at ian@airs.com or    c/o Cygnus Support, 48 Grove Street, Somerville, MA 02144.    */
end_comment

begin_include
include|#
directive|include
file|"uucnfi.h"
end_include

begin_if
if|#
directive|if
name|USE_RCS_ID
end_if

begin_decl_stmt
specifier|const
name|char
name|_uuconf_errstr_rcsid
index|[]
init|=
literal|"$FreeBSD$"
decl_stmt|;
end_decl_stmt

begin_endif
endif|#
directive|endif
end_endif

begin_escape
end_escape

begin_decl_stmt
specifier|static
name|char
modifier|*
name|zeprint_num
name|P
argument_list|(
operator|(
name|char
operator|*
name|zbuf
operator|,
name|size_t
name|cbuf
operator|,
name|int
name|ival
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_escape
end_escape

begin_comment
comment|/* Return an error string for a uuconf error.  This does not return a    uuconf error code, but instead returns the total buffer length.  */
end_comment

begin_function
name|int
name|uuconf_error_string
parameter_list|(
name|pglobal
parameter_list|,
name|ierr
parameter_list|,
name|zbuf
parameter_list|,
name|cbuf
parameter_list|)
name|pointer
name|pglobal
decl_stmt|;
name|int
name|ierr
decl_stmt|;
name|char
modifier|*
name|zbuf
decl_stmt|;
name|size_t
name|cbuf
decl_stmt|;
block|{
name|struct
name|sglobal
modifier|*
name|qglobal
init|=
operator|(
expr|struct
name|sglobal
operator|*
operator|)
name|pglobal
decl_stmt|;
specifier|const
name|char
modifier|*
name|zfile
decl_stmt|;
name|size_t
name|cfile
decl_stmt|;
specifier|const
name|char
modifier|*
name|zlineno
decl_stmt|;
name|char
name|ablineno
index|[
literal|100
index|]
decl_stmt|;
name|size_t
name|clineno
decl_stmt|;
specifier|const
name|char
modifier|*
name|zmsg
decl_stmt|;
name|char
name|abmsg
index|[
literal|100
index|]
decl_stmt|;
name|size_t
name|cmsg
decl_stmt|;
specifier|const
name|char
modifier|*
name|zerrno
decl_stmt|;
name|size_t
name|cerrno
decl_stmt|;
name|size_t
name|cret
decl_stmt|;
name|size_t
name|ccopy
decl_stmt|;
comment|/* The format of the message is       filename:lineno: message: errno       If there is no filename, the trailing colon is not output.  If      there is no linenumber, the trailing colon is not output.  If      there is no filename, the linenumber is not output, and neither      is the space before message.  If there is no errno, the      preceeding colon and space are not output.  */
comment|/* Get the filename to put in the error message, if any.  */
if|if
condition|(
operator|(
name|ierr
operator|&
name|UUCONF_ERROR_FILENAME
operator|)
operator|==
literal|0
operator|||
name|qglobal
operator|==
name|NULL
operator|||
name|qglobal
operator|->
name|zfilename
operator|==
name|NULL
condition|)
block|{
name|zfile
operator|=
literal|""
expr_stmt|;
name|cfile
operator|=
literal|0
expr_stmt|;
block|}
else|else
block|{
name|zfile
operator|=
name|qglobal
operator|->
name|zfilename
expr_stmt|;
name|cfile
operator|=
name|strlen
argument_list|(
name|zfile
argument_list|)
operator|+
literal|1
expr_stmt|;
block|}
comment|/* Get the line number to put in the error message, if any.  */
if|if
condition|(
name|cfile
operator|==
literal|0
operator|||
operator|(
name|ierr
operator|&
name|UUCONF_ERROR_LINENO
operator|)
operator|==
literal|0
operator|||
name|qglobal
operator|==
name|NULL
operator|||
name|qglobal
operator|->
name|ilineno
operator|<=
literal|0
condition|)
block|{
name|zlineno
operator|=
literal|""
expr_stmt|;
name|clineno
operator|=
literal|0
expr_stmt|;
block|}
else|else
block|{
name|zlineno
operator|=
name|zeprint_num
argument_list|(
name|ablineno
argument_list|,
sizeof|sizeof
name|ablineno
argument_list|,
name|qglobal
operator|->
name|ilineno
argument_list|)
expr_stmt|;
name|clineno
operator|=
name|strlen
argument_list|(
name|zlineno
argument_list|)
operator|+
literal|1
expr_stmt|;
block|}
comment|/* Get the main message.  */
switch|switch
condition|(
name|UUCONF_ERROR_VALUE
argument_list|(
name|ierr
argument_list|)
condition|)
block|{
case|case
name|UUCONF_SUCCESS
case|:
name|zmsg
operator|=
literal|"no error"
expr_stmt|;
break|break;
case|case
name|UUCONF_NOT_FOUND
case|:
name|zmsg
operator|=
literal|"not found"
expr_stmt|;
break|break;
case|case
name|UUCONF_FOPEN_FAILED
case|:
name|zmsg
operator|=
literal|"fopen"
expr_stmt|;
break|break;
case|case
name|UUCONF_FSEEK_FAILED
case|:
name|zmsg
operator|=
literal|"fseek"
expr_stmt|;
break|break;
case|case
name|UUCONF_MALLOC_FAILED
case|:
name|zmsg
operator|=
literal|"malloc"
expr_stmt|;
break|break;
case|case
name|UUCONF_SYNTAX_ERROR
case|:
name|zmsg
operator|=
literal|"syntax error"
expr_stmt|;
break|break;
default|default:
name|zmsg
operator|=
name|zeprint_num
argument_list|(
name|abmsg
argument_list|,
sizeof|sizeof
name|abmsg
argument_list|,
name|UUCONF_ERROR_VALUE
argument_list|(
name|ierr
argument_list|)
argument_list|)
expr_stmt|;
name|zmsg
operator|-=
sizeof|sizeof
expr|"error "
operator|-
literal|1
expr_stmt|;
name|memcpy
argument_list|(
operator|(
name|pointer
operator|)
name|zmsg
argument_list|,
operator|(
name|pointer
operator|)
literal|"error "
argument_list|,
sizeof|sizeof
expr|"error "
operator|-
literal|1
argument_list|)
expr_stmt|;
break|break;
block|}
name|cmsg
operator|=
name|strlen
argument_list|(
name|zmsg
argument_list|)
expr_stmt|;
if|if
condition|(
name|cfile
operator|>
literal|0
condition|)
operator|++
name|cmsg
expr_stmt|;
comment|/* Get the errno string.  Note that strerror is not necessarily      reentrant.  */
if|if
condition|(
operator|(
name|ierr
operator|&
name|UUCONF_ERROR_ERRNO
operator|)
operator|==
literal|0
operator|||
name|qglobal
operator|==
name|NULL
condition|)
block|{
name|zerrno
operator|=
literal|""
expr_stmt|;
name|cerrno
operator|=
literal|0
expr_stmt|;
block|}
else|else
block|{
name|zerrno
operator|=
name|strerror
argument_list|(
name|qglobal
operator|->
name|ierrno
argument_list|)
expr_stmt|;
name|cerrno
operator|=
name|strlen
argument_list|(
name|zerrno
argument_list|)
operator|+
literal|2
expr_stmt|;
block|}
name|cret
operator|=
name|cfile
operator|+
name|clineno
operator|+
name|cmsg
operator|+
name|cerrno
operator|+
literal|1
expr_stmt|;
if|if
condition|(
name|cbuf
operator|==
literal|0
condition|)
return|return
name|cret
return|;
comment|/* Leave room for the null byte.  */
operator|--
name|cbuf
expr_stmt|;
if|if
condition|(
name|cfile
operator|>
literal|0
condition|)
block|{
name|ccopy
operator|=
name|cfile
operator|-
literal|1
expr_stmt|;
if|if
condition|(
name|ccopy
operator|>
name|cbuf
condition|)
name|ccopy
operator|=
name|cbuf
expr_stmt|;
name|memcpy
argument_list|(
operator|(
name|pointer
operator|)
name|zbuf
argument_list|,
operator|(
name|pointer
operator|)
name|zfile
argument_list|,
name|ccopy
argument_list|)
expr_stmt|;
name|zbuf
operator|+=
name|ccopy
expr_stmt|;
name|cbuf
operator|-=
name|ccopy
expr_stmt|;
if|if
condition|(
name|cbuf
operator|>
literal|0
condition|)
block|{
operator|*
name|zbuf
operator|++
operator|=
literal|':'
expr_stmt|;
operator|--
name|cbuf
expr_stmt|;
block|}
block|}
if|if
condition|(
name|clineno
operator|>
literal|0
condition|)
block|{
name|ccopy
operator|=
name|clineno
operator|-
literal|1
expr_stmt|;
if|if
condition|(
name|ccopy
operator|>
name|cbuf
condition|)
name|ccopy
operator|=
name|cbuf
expr_stmt|;
name|memcpy
argument_list|(
operator|(
name|pointer
operator|)
name|zbuf
argument_list|,
operator|(
name|pointer
operator|)
name|zlineno
argument_list|,
name|ccopy
argument_list|)
expr_stmt|;
name|zbuf
operator|+=
name|ccopy
expr_stmt|;
name|cbuf
operator|-=
name|ccopy
expr_stmt|;
if|if
condition|(
name|cbuf
operator|>
literal|0
condition|)
block|{
operator|*
name|zbuf
operator|++
operator|=
literal|':'
expr_stmt|;
operator|--
name|cbuf
expr_stmt|;
block|}
block|}
if|if
condition|(
name|cbuf
operator|>
literal|0
operator|&&
name|cfile
operator|>
literal|0
condition|)
block|{
operator|*
name|zbuf
operator|++
operator|=
literal|' '
expr_stmt|;
operator|--
name|cbuf
expr_stmt|;
operator|--
name|cmsg
expr_stmt|;
block|}
name|ccopy
operator|=
name|cmsg
expr_stmt|;
if|if
condition|(
name|ccopy
operator|>
name|cbuf
condition|)
name|ccopy
operator|=
name|cbuf
expr_stmt|;
name|memcpy
argument_list|(
operator|(
name|pointer
operator|)
name|zbuf
argument_list|,
operator|(
name|pointer
operator|)
name|zmsg
argument_list|,
name|ccopy
argument_list|)
expr_stmt|;
name|zbuf
operator|+=
name|ccopy
expr_stmt|;
name|cbuf
operator|-=
name|ccopy
expr_stmt|;
if|if
condition|(
name|cerrno
operator|>
literal|0
condition|)
block|{
if|if
condition|(
name|cbuf
operator|>
literal|0
condition|)
block|{
operator|*
name|zbuf
operator|++
operator|=
literal|':'
expr_stmt|;
operator|--
name|cbuf
expr_stmt|;
block|}
if|if
condition|(
name|cbuf
operator|>
literal|0
condition|)
block|{
operator|*
name|zbuf
operator|++
operator|=
literal|' '
expr_stmt|;
operator|--
name|cbuf
expr_stmt|;
block|}
name|ccopy
operator|=
name|cerrno
operator|-
literal|2
expr_stmt|;
if|if
condition|(
name|ccopy
operator|>
name|cbuf
condition|)
name|ccopy
operator|=
name|cbuf
expr_stmt|;
name|memcpy
argument_list|(
operator|(
name|pointer
operator|)
name|zbuf
argument_list|,
operator|(
name|pointer
operator|)
name|zerrno
argument_list|,
name|ccopy
argument_list|)
expr_stmt|;
name|zbuf
operator|+=
name|ccopy
expr_stmt|;
name|cbuf
operator|-=
name|ccopy
expr_stmt|;
block|}
operator|*
name|zbuf
operator|=
literal|'\0'
expr_stmt|;
return|return
name|cret
return|;
block|}
end_function

begin_comment
comment|/* Turn a number into a string.  This should really call sprintf, but    since nothing else in the uuconf library calls any print routine,    it's more interesting to not call it here either.  */
end_comment

begin_function
specifier|static
name|char
modifier|*
name|zeprint_num
parameter_list|(
name|ab
parameter_list|,
name|c
parameter_list|,
name|i
parameter_list|)
name|char
modifier|*
name|ab
decl_stmt|;
name|size_t
name|c
decl_stmt|;
specifier|register
name|int
name|i
decl_stmt|;
block|{
specifier|register
name|char
modifier|*
name|z
decl_stmt|;
name|z
operator|=
name|ab
operator|+
name|c
expr_stmt|;
operator|*
operator|--
name|z
operator|=
literal|'\0'
expr_stmt|;
do|do
block|{
operator|*
operator|--
name|z
operator|=
name|i
operator|%
literal|10
operator|+
literal|'0'
expr_stmt|;
name|i
operator|/=
literal|10
expr_stmt|;
block|}
do|while
condition|(
name|i
operator|!=
literal|0
condition|)
do|;
return|return
name|z
return|;
block|}
end_function

end_unit


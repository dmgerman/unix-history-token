begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/* rdlocs.c    Get the locations of systems in the Taylor UUCP configuration files.     Copyright (C) 1992 Ian Lance Taylor     This file is part of the Taylor UUCP uuconf library.     This library is free software; you can redistribute it and/or    modify it under the terms of the GNU Library General Public License    as published by the Free Software Foundation; either version 2 of    the License, or (at your option) any later version.     This library is distributed in the hope that it will be useful, but    WITHOUT ANY WARRANTY; without even the implied warranty of    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU    Library General Public License for more details.     You should have received a copy of the GNU Library General Public    License along with this library; if not, write to the Free Software    Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.     The author of the program may be contacted at ian@airs.com or    c/o Cygnus Support, 48 Grove Street, Somerville, MA 02144.    */
end_comment

begin_include
include|#
directive|include
file|"uucnfi.h"
end_include

begin_if
if|#
directive|if
name|USE_RCS_ID
end_if

begin_decl_stmt
specifier|const
name|char
name|_uuconf_rdlocs_rcsid
index|[]
init|=
literal|"$FreeBSD$"
decl_stmt|;
end_decl_stmt

begin_endif
endif|#
directive|endif
end_endif

begin_include
include|#
directive|include
file|<errno.h>
end_include

begin_escape
end_escape

begin_decl_stmt
specifier|static
name|int
name|itsystem
name|P
argument_list|(
operator|(
name|pointer
name|pglobal
operator|,
name|int
name|argc
operator|,
name|char
operator|*
operator|*
name|argv
operator|,
name|pointer
name|pvar
operator|,
name|pointer
name|pinfo
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|itcalled_login
name|P
argument_list|(
operator|(
name|pointer
name|pglobal
operator|,
name|int
name|argc
operator|,
name|char
operator|*
operator|*
name|argv
operator|,
name|pointer
name|pvar
operator|,
name|pointer
name|pinfo
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|itmyname
name|P
argument_list|(
operator|(
name|pointer
name|pglobal
operator|,
name|int
name|argc
operator|,
name|char
operator|*
operator|*
name|argv
operator|,
name|pointer
name|pvar
operator|,
name|pointer
name|pinfo
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_escape
end_escape

begin_comment
comment|/* This code scans through the Taylor UUCP system files in order to    locate each system and to gather the login restrictions (since this    information is held in additional arguments to the "called-login"    command, it can appear anywhere in the systems files).  It also    records whether any "myname" appears, as an optimization for    uuconf_taylor_localname.     This table is used to dispatch the appropriate commands.  Most    commands are simply ignored.  Note that this is a uuconf_cmdtab,    not a cmdtab_offset.  */
end_comment

begin_decl_stmt
specifier|static
specifier|const
name|struct
name|uuconf_cmdtab
name|asTcmds
index|[]
init|=
block|{
block|{
literal|"system"
block|,
name|UUCONF_CMDTABTYPE_FN
operator||
literal|2
block|,
name|NULL
block|,
name|itsystem
block|}
block|,
block|{
literal|"alias"
block|,
name|UUCONF_CMDTABTYPE_FN
operator||
literal|2
block|,
operator|(
name|pointer
operator|)
name|asTcmds
block|,
name|itsystem
block|}
block|,
block|{
literal|"called-login"
block|,
name|UUCONF_CMDTABTYPE_FN
operator||
literal|0
block|,
name|NULL
block|,
name|itcalled_login
block|}
block|,
block|{
literal|"myname"
block|,
name|UUCONF_CMDTABTYPE_FN
operator||
literal|2
block|,
name|NULL
block|,
name|itmyname
block|}
block|,
block|{
name|NULL
block|,
literal|0
block|,
name|NULL
block|,
name|NULL
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* This structure is used to pass information into the command table    functions.  */
end_comment

begin_struct
struct|struct
name|sinfo
block|{
comment|/* The sys file name.  */
specifier|const
name|char
modifier|*
name|zname
decl_stmt|;
comment|/* The open sys file.  */
name|FILE
modifier|*
name|e
decl_stmt|;
comment|/* The list of locations we are building.  */
name|struct
name|stsysloc
modifier|*
name|qlocs
decl_stmt|;
comment|/* The list of validation restrictions we are building.  */
name|struct
name|svalidate
modifier|*
name|qvals
decl_stmt|;
block|}
struct|;
end_struct

begin_escape
end_escape

begin_comment
comment|/* Look through the sys files to find the location and names of all    the systems.  Since we're scanning the sys files, we also record    the validation information specified by the additional arguments to    the called-login command.  We don't use uuconf_cmd_file to avoid    the overhead of breaking the line up into arguments if not    necessary.  */
end_comment

begin_function
name|int
name|_uuconf_iread_locations
parameter_list|(
name|qglobal
parameter_list|)
name|struct
name|sglobal
modifier|*
name|qglobal
decl_stmt|;
block|{
name|char
modifier|*
name|zline
decl_stmt|;
name|size_t
name|cline
decl_stmt|;
name|struct
name|sinfo
name|si
decl_stmt|;
name|int
name|iret
decl_stmt|;
name|char
modifier|*
modifier|*
name|pz
decl_stmt|;
if|if
condition|(
name|qglobal
operator|->
name|qprocess
operator|->
name|fread_syslocs
condition|)
return|return
name|UUCONF_SUCCESS
return|;
name|zline
operator|=
name|NULL
expr_stmt|;
name|cline
operator|=
literal|0
expr_stmt|;
name|si
operator|.
name|qlocs
operator|=
name|NULL
expr_stmt|;
name|si
operator|.
name|qvals
operator|=
name|NULL
expr_stmt|;
name|iret
operator|=
name|UUCONF_SUCCESS
expr_stmt|;
for|for
control|(
name|pz
operator|=
name|qglobal
operator|->
name|qprocess
operator|->
name|pzsysfiles
init|;
operator|*
name|pz
operator|!=
name|NULL
condition|;
name|pz
operator|++
control|)
block|{
name|FILE
modifier|*
name|e
decl_stmt|;
name|int
name|cchars
decl_stmt|;
name|qglobal
operator|->
name|ilineno
operator|=
literal|0
expr_stmt|;
name|e
operator|=
name|fopen
argument_list|(
operator|*
name|pz
argument_list|,
literal|"r"
argument_list|)
expr_stmt|;
if|if
condition|(
name|e
operator|==
name|NULL
condition|)
block|{
if|if
condition|(
name|FNO_SUCH_FILE
argument_list|()
condition|)
continue|continue;
name|qglobal
operator|->
name|ierrno
operator|=
name|errno
expr_stmt|;
name|iret
operator|=
name|UUCONF_FOPEN_FAILED
operator||
name|UUCONF_ERROR_ERRNO
expr_stmt|;
break|break;
block|}
ifdef|#
directive|ifdef
name|CLOSE_ON_EXEC
name|CLOSE_ON_EXEC
argument_list|(
name|e
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|si
operator|.
name|zname
operator|=
operator|*
name|pz
expr_stmt|;
name|si
operator|.
name|e
operator|=
name|e
expr_stmt|;
while|while
condition|(
operator|(
name|cchars
operator|=
name|_uuconf_getline
argument_list|(
name|qglobal
argument_list|,
operator|&
name|zline
argument_list|,
operator|&
name|cline
argument_list|,
name|e
argument_list|)
operator|)
operator|>
literal|0
condition|)
block|{
name|char
modifier|*
name|zcmd
decl_stmt|;
operator|++
name|qglobal
operator|->
name|ilineno
expr_stmt|;
name|zcmd
operator|=
name|zline
operator|+
name|strspn
argument_list|(
name|zline
argument_list|,
literal|" \t"
argument_list|)
expr_stmt|;
if|if
condition|(
name|strncasecmp
argument_list|(
name|zcmd
argument_list|,
literal|"system"
argument_list|,
sizeof|sizeof
expr|"system"
operator|-
literal|1
argument_list|)
operator|==
literal|0
operator|||
name|strncasecmp
argument_list|(
name|zcmd
argument_list|,
literal|"alias"
argument_list|,
sizeof|sizeof
expr|"alias"
operator|-
literal|1
argument_list|)
operator|==
literal|0
operator|||
name|strncasecmp
argument_list|(
name|zcmd
argument_list|,
literal|"called-login"
argument_list|,
sizeof|sizeof
expr|"called-login"
operator|-
literal|1
argument_list|)
operator|==
literal|0
operator|||
name|strncasecmp
argument_list|(
name|zcmd
argument_list|,
literal|"myname"
argument_list|,
sizeof|sizeof
expr|"myname"
operator|-
literal|1
argument_list|)
operator|==
literal|0
condition|)
block|{
name|iret
operator|=
name|uuconf_cmd_line
argument_list|(
operator|(
name|pointer
operator|)
name|qglobal
argument_list|,
name|zline
argument_list|,
name|asTcmds
argument_list|,
operator|(
name|pointer
operator|)
operator|&
name|si
argument_list|,
operator|(
name|uuconf_cmdtabfn
operator|)
name|NULL
argument_list|,
literal|0
argument_list|,
name|qglobal
operator|->
name|pblock
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|iret
operator|&
name|UUCONF_CMDTABRET_KEEP
operator|)
operator|!=
literal|0
condition|)
block|{
name|iret
operator|&=
operator|~
name|UUCONF_CMDTABRET_KEEP
expr_stmt|;
name|zline
operator|=
name|NULL
expr_stmt|;
name|cline
operator|=
literal|0
expr_stmt|;
block|}
if|if
condition|(
name|iret
operator|!=
name|UUCONF_SUCCESS
condition|)
block|{
name|iret
operator|&=
operator|~
name|UUCONF_CMDTABRET_EXIT
expr_stmt|;
break|break;
block|}
block|}
block|}
if|if
condition|(
name|iret
operator|!=
name|UUCONF_SUCCESS
condition|)
break|break;
block|}
if|if
condition|(
name|zline
operator|!=
name|NULL
condition|)
name|free
argument_list|(
operator|(
name|pointer
operator|)
name|zline
argument_list|)
expr_stmt|;
if|if
condition|(
name|iret
operator|!=
name|UUCONF_SUCCESS
condition|)
block|{
name|qglobal
operator|->
name|zfilename
operator|=
operator|*
name|pz
expr_stmt|;
name|iret
operator||=
name|UUCONF_ERROR_FILENAME
operator||
name|UUCONF_ERROR_LINENO
expr_stmt|;
if|if
condition|(
name|UUCONF_ERROR_VALUE
argument_list|(
name|iret
argument_list|)
operator|!=
name|UUCONF_MALLOC_FAILED
condition|)
name|qglobal
operator|->
name|qprocess
operator|->
name|fread_syslocs
operator|=
name|TRUE
expr_stmt|;
block|}
else|else
block|{
name|qglobal
operator|->
name|qprocess
operator|->
name|qsyslocs
operator|=
name|si
operator|.
name|qlocs
expr_stmt|;
name|qglobal
operator|->
name|qprocess
operator|->
name|qvalidate
operator|=
name|si
operator|.
name|qvals
expr_stmt|;
name|qglobal
operator|->
name|qprocess
operator|->
name|fread_syslocs
operator|=
name|TRUE
expr_stmt|;
block|}
return|return
name|iret
return|;
block|}
end_function

begin_escape
end_escape

begin_comment
comment|/* Handle a "system" or "alias" command by recording the file and    location.  If pvar is not NULL, this is an "alias" command.  */
end_comment

begin_comment
comment|/*ARGSUSED*/
end_comment

begin_function
specifier|static
name|int
name|itsystem
parameter_list|(
name|pglobal
parameter_list|,
name|argc
parameter_list|,
name|argv
parameter_list|,
name|pvar
parameter_list|,
name|pinfo
parameter_list|)
name|pointer
name|pglobal
decl_stmt|;
name|int
name|argc
decl_stmt|;
name|char
modifier|*
modifier|*
name|argv
decl_stmt|;
name|pointer
name|pvar
decl_stmt|;
name|pointer
name|pinfo
decl_stmt|;
block|{
name|struct
name|sglobal
modifier|*
name|qglobal
init|=
operator|(
expr|struct
name|sglobal
operator|*
operator|)
name|pglobal
decl_stmt|;
name|struct
name|sinfo
modifier|*
name|qinfo
init|=
operator|(
expr|struct
name|sinfo
operator|*
operator|)
name|pinfo
decl_stmt|;
name|struct
name|stsysloc
modifier|*
name|q
decl_stmt|;
name|size_t
name|csize
decl_stmt|;
name|q
operator|=
operator|(
expr|struct
name|stsysloc
operator|*
operator|)
name|uuconf_malloc
argument_list|(
name|qglobal
operator|->
name|pblock
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|stsysloc
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|q
operator|==
name|NULL
condition|)
block|{
name|qglobal
operator|->
name|ierrno
operator|=
name|errno
expr_stmt|;
return|return
operator|(
name|UUCONF_MALLOC_FAILED
operator||
name|UUCONF_ERROR_ERRNO
operator||
name|UUCONF_CMDTABRET_EXIT
operator|)
return|;
block|}
name|csize
operator|=
name|strlen
argument_list|(
name|argv
index|[
literal|1
index|]
argument_list|)
operator|+
literal|1
expr_stmt|;
name|q
operator|->
name|zname
operator|=
name|uuconf_malloc
argument_list|(
name|qglobal
operator|->
name|pblock
argument_list|,
name|csize
argument_list|)
expr_stmt|;
if|if
condition|(
name|q
operator|->
name|zname
operator|==
name|NULL
condition|)
block|{
name|qglobal
operator|->
name|ierrno
operator|=
name|errno
expr_stmt|;
return|return
operator|(
name|UUCONF_MALLOC_FAILED
operator||
name|UUCONF_ERROR_ERRNO
operator||
name|UUCONF_CMDTABRET_EXIT
operator|)
return|;
block|}
name|q
operator|->
name|qnext
operator|=
name|qinfo
operator|->
name|qlocs
expr_stmt|;
name|memcpy
argument_list|(
operator|(
name|pointer
operator|)
name|q
operator|->
name|zname
argument_list|,
operator|(
name|pointer
operator|)
name|argv
index|[
literal|1
index|]
argument_list|,
name|csize
argument_list|)
expr_stmt|;
name|q
operator|->
name|falias
operator|=
name|pvar
operator|!=
name|NULL
expr_stmt|;
name|q
operator|->
name|zfile
operator|=
name|qinfo
operator|->
name|zname
expr_stmt|;
name|q
operator|->
name|e
operator|=
name|qinfo
operator|->
name|e
expr_stmt|;
name|q
operator|->
name|iloc
operator|=
name|ftell
argument_list|(
name|qinfo
operator|->
name|e
argument_list|)
expr_stmt|;
name|q
operator|->
name|ilineno
operator|=
name|qglobal
operator|->
name|ilineno
expr_stmt|;
name|qinfo
operator|->
name|qlocs
operator|=
name|q
expr_stmt|;
return|return
name|UUCONF_CMDTABRET_CONTINUE
return|;
block|}
end_function

begin_comment
comment|/* Handle the "called-login" command.  This just records any extra    arguments, so that uuconf_validate can check them later if    necessary.  */
end_comment

begin_comment
comment|/*ARGSUSED*/
end_comment

begin_function
specifier|static
name|int
name|itcalled_login
parameter_list|(
name|pglobal
parameter_list|,
name|argc
parameter_list|,
name|argv
parameter_list|,
name|pvar
parameter_list|,
name|pinfo
parameter_list|)
name|pointer
name|pglobal
decl_stmt|;
name|int
name|argc
decl_stmt|;
name|char
modifier|*
modifier|*
name|argv
decl_stmt|;
name|pointer
name|pvar
decl_stmt|;
name|pointer
name|pinfo
decl_stmt|;
block|{
name|struct
name|sglobal
modifier|*
name|qglobal
init|=
operator|(
expr|struct
name|sglobal
operator|*
operator|)
name|pglobal
decl_stmt|;
name|struct
name|sinfo
modifier|*
name|qinfo
init|=
operator|(
expr|struct
name|sinfo
operator|*
operator|)
name|pinfo
decl_stmt|;
specifier|register
name|struct
name|svalidate
modifier|*
name|qval
decl_stmt|;
name|int
name|i
decl_stmt|;
if|if
condition|(
name|argc
operator|<=
literal|2
condition|)
return|return
name|UUCONF_CMDTABRET_CONTINUE
return|;
for|for
control|(
name|qval
operator|=
name|qinfo
operator|->
name|qvals
init|;
name|qval
operator|!=
name|NULL
condition|;
name|qval
operator|=
name|qval
operator|->
name|qnext
control|)
if|if
condition|(
name|strcmp
argument_list|(
name|argv
index|[
literal|1
index|]
argument_list|,
name|qval
operator|->
name|zlogname
argument_list|)
operator|==
literal|0
condition|)
break|break;
if|if
condition|(
name|qval
operator|==
name|NULL
condition|)
block|{
name|qval
operator|=
operator|(
expr|struct
name|svalidate
operator|*
operator|)
name|uuconf_malloc
argument_list|(
name|qglobal
operator|->
name|pblock
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|svalidate
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|qval
operator|==
name|NULL
condition|)
block|{
name|qglobal
operator|->
name|ierrno
operator|=
name|errno
expr_stmt|;
return|return
operator|(
name|UUCONF_MALLOC_FAILED
operator||
name|UUCONF_ERROR_ERRNO
operator||
name|UUCONF_CMDTABRET_EXIT
operator|)
return|;
block|}
name|qval
operator|->
name|qnext
operator|=
name|qinfo
operator|->
name|qvals
expr_stmt|;
name|qval
operator|->
name|zlogname
operator|=
name|argv
index|[
literal|1
index|]
expr_stmt|;
name|qval
operator|->
name|pzmachines
operator|=
name|NULL
expr_stmt|;
name|qinfo
operator|->
name|qvals
operator|=
name|qval
expr_stmt|;
block|}
for|for
control|(
name|i
operator|=
literal|2
init|;
name|i
operator|<
name|argc
condition|;
name|i
operator|++
control|)
block|{
name|int
name|iret
decl_stmt|;
name|iret
operator|=
name|_uuconf_iadd_string
argument_list|(
name|qglobal
argument_list|,
name|argv
index|[
name|i
index|]
argument_list|,
name|FALSE
argument_list|,
name|TRUE
argument_list|,
operator|&
name|qval
operator|->
name|pzmachines
argument_list|,
name|qglobal
operator|->
name|pblock
argument_list|)
expr_stmt|;
if|if
condition|(
name|iret
operator|!=
name|UUCONF_SUCCESS
condition|)
return|return
name|iret
operator||
name|UUCONF_CMDTABRET_EXIT
return|;
block|}
return|return
name|UUCONF_CMDTABRET_KEEP
return|;
block|}
end_function

begin_comment
comment|/* Handle the "myname" command by simply recording that it appears.    This information is used by uuconf_taylor_localname.  */
end_comment

begin_comment
comment|/*ARGSUSED*/
end_comment

begin_function
specifier|static
name|int
name|itmyname
parameter_list|(
name|pglobal
parameter_list|,
name|argc
parameter_list|,
name|argv
parameter_list|,
name|pvar
parameter_list|,
name|pinfo
parameter_list|)
name|pointer
name|pglobal
decl_stmt|;
name|int
name|argc
decl_stmt|;
name|char
modifier|*
modifier|*
name|argv
decl_stmt|;
name|pointer
name|pvar
decl_stmt|;
name|pointer
name|pinfo
decl_stmt|;
block|{
name|struct
name|sglobal
modifier|*
name|qglobal
init|=
operator|(
expr|struct
name|sglobal
operator|*
operator|)
name|pglobal
decl_stmt|;
name|qglobal
operator|->
name|qprocess
operator|->
name|fuses_myname
operator|=
name|TRUE
expr_stmt|;
return|return
name|UUCONF_CMDTABRET_CONTINUE
return|;
block|}
end_function

end_unit


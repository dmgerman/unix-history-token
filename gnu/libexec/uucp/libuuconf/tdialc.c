begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/* tdialc.c    Handle a Taylor UUCP dialer command.     Copyright (C) 1992 Ian Lance Taylor     This file is part of the Taylor UUCP uuconf library.     This library is free software; you can redistribute it and/or    modify it under the terms of the GNU Library General Public License    as published by the Free Software Foundation; either version 2 of    the License, or (at your option) any later version.     This library is distributed in the hope that it will be useful, but    WITHOUT ANY WARRANTY; without even the implied warranty of    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU    Library General Public License for more details.     You should have received a copy of the GNU Library General Public    License along with this library; if not, write to the Free Software    Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.     The author of the program may be contacted at ian@airs.com or    c/o Cygnus Support, 48 Grove Street, Somerville, MA 02144.    */
end_comment

begin_include
include|#
directive|include
file|"uucnfi.h"
end_include

begin_if
if|#
directive|if
name|USE_RCS_ID
end_if

begin_decl_stmt
specifier|const
name|char
name|_uuconf_tdialc_rcsid
index|[]
init|=
literal|"$FreeBSD$"
decl_stmt|;
end_decl_stmt

begin_endif
endif|#
directive|endif
end_endif

begin_escape
end_escape

begin_decl_stmt
specifier|static
name|int
name|idchat
name|P
argument_list|(
operator|(
name|pointer
name|pglobal
operator|,
name|int
name|argc
operator|,
name|char
operator|*
operator|*
name|argv
operator|,
name|pointer
name|pvar
operator|,
name|pointer
name|pinfo
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|iddtr_toggle
name|P
argument_list|(
operator|(
name|pointer
name|pglobal
operator|,
name|int
name|argc
operator|,
name|char
operator|*
operator|*
name|argv
operator|,
name|pointer
name|pvar
operator|,
name|pointer
name|pinfo
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|idcomplete
name|P
argument_list|(
operator|(
name|pointer
name|pglobal
operator|,
name|int
name|argc
operator|,
name|char
operator|*
operator|*
name|argv
operator|,
name|pointer
name|pvar
operator|,
name|pointer
name|pinfo
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|idproto_param
name|P
argument_list|(
operator|(
name|pointer
name|pglobal
operator|,
name|int
name|argc
operator|,
name|char
operator|*
operator|*
name|argv
operator|,
name|pointer
name|pvar
operator|,
name|pointer
name|pinfo
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|idcunknown
name|P
argument_list|(
operator|(
name|pointer
name|pglobal
operator|,
name|int
name|argc
operator|,
name|char
operator|*
operator|*
name|argv
operator|,
name|pointer
name|pvar
operator|,
name|pointer
name|pinfo
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_escape
end_escape

begin_comment
comment|/* The command table for dialer commands.  The "dialer" command is    handled specially.  */
end_comment

begin_decl_stmt
specifier|static
specifier|const
name|struct
name|cmdtab_offset
name|asDialer_cmds
index|[]
init|=
block|{
block|{
literal|"chat"
block|,
name|UUCONF_CMDTABTYPE_PREFIX
operator||
literal|0
block|,
name|offsetof
argument_list|(
expr|struct
name|uuconf_dialer
argument_list|,
name|uuconf_schat
argument_list|)
block|,
name|idchat
block|}
block|,
block|{
literal|"dialtone"
block|,
name|UUCONF_CMDTABTYPE_STRING
block|,
name|offsetof
argument_list|(
expr|struct
name|uuconf_dialer
argument_list|,
name|uuconf_zdialtone
argument_list|)
block|,
name|NULL
block|}
block|,
block|{
literal|"pause"
block|,
name|UUCONF_CMDTABTYPE_STRING
block|,
name|offsetof
argument_list|(
expr|struct
name|uuconf_dialer
argument_list|,
name|uuconf_zpause
argument_list|)
block|,
name|NULL
block|}
block|,
block|{
literal|"carrier"
block|,
name|UUCONF_CMDTABTYPE_BOOLEAN
block|,
name|offsetof
argument_list|(
expr|struct
name|uuconf_dialer
argument_list|,
name|uuconf_fcarrier
argument_list|)
block|,
name|NULL
block|}
block|,
block|{
literal|"carrier-wait"
block|,
name|UUCONF_CMDTABTYPE_INT
block|,
name|offsetof
argument_list|(
expr|struct
name|uuconf_dialer
argument_list|,
name|uuconf_ccarrier_wait
argument_list|)
block|,
name|NULL
block|}
block|,
block|{
literal|"dtr-toggle"
block|,
name|UUCONF_CMDTABTYPE_FN
operator||
literal|0
block|,
operator|(
name|size_t
operator|)
operator|-
literal|1
block|,
name|iddtr_toggle
block|}
block|,
block|{
literal|"complete"
block|,
name|UUCONF_CMDTABTYPE_FN
operator||
literal|2
block|,
name|offsetof
argument_list|(
expr|struct
name|uuconf_dialer
argument_list|,
name|uuconf_scomplete
argument_list|)
block|,
name|idcomplete
block|}
block|,
block|{
literal|"complete-chat"
block|,
name|UUCONF_CMDTABTYPE_PREFIX
block|,
name|offsetof
argument_list|(
expr|struct
name|uuconf_dialer
argument_list|,
name|uuconf_scomplete
argument_list|)
block|,
name|idchat
block|}
block|,
block|{
literal|"abort"
block|,
name|UUCONF_CMDTABTYPE_FN
operator||
literal|2
block|,
name|offsetof
argument_list|(
expr|struct
name|uuconf_dialer
argument_list|,
name|uuconf_sabort
argument_list|)
block|,
name|idcomplete
block|}
block|,
block|{
literal|"abort-chat"
block|,
name|UUCONF_CMDTABTYPE_PREFIX
block|,
name|offsetof
argument_list|(
expr|struct
name|uuconf_dialer
argument_list|,
name|uuconf_sabort
argument_list|)
block|,
name|idchat
block|}
block|,
block|{
literal|"protocol-parameter"
block|,
name|UUCONF_CMDTABTYPE_FN
operator||
literal|0
block|,
name|offsetof
argument_list|(
expr|struct
name|uuconf_dialer
argument_list|,
name|uuconf_qproto_params
argument_list|)
block|,
name|idproto_param
block|}
block|,
block|{
literal|"seven-bit"
block|,
name|UUCONF_CMDTABTYPE_FN
operator||
literal|2
block|,
name|offsetof
argument_list|(
expr|struct
name|uuconf_dialer
argument_list|,
name|uuconf_ireliable
argument_list|)
block|,
name|_uuconf_iseven_bit
block|}
block|,
block|{
literal|"reliable"
block|,
name|UUCONF_CMDTABTYPE_FN
operator||
literal|2
block|,
name|offsetof
argument_list|(
expr|struct
name|uuconf_dialer
argument_list|,
name|uuconf_ireliable
argument_list|)
block|,
name|_uuconf_ireliable
block|}
block|,
block|{
literal|"half-duplex"
block|,
name|UUCONF_CMDTABTYPE_FN
operator||
literal|2
block|,
name|offsetof
argument_list|(
expr|struct
name|uuconf_dialer
argument_list|,
name|uuconf_ireliable
argument_list|)
block|,
name|_uuconf_ihalf_duplex
block|}
block|,
block|{
name|NULL
block|,
literal|0
block|,
literal|0
block|,
name|NULL
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_define
define|#
directive|define
name|CDIALER_CMDS
value|(sizeof asDialer_cmds / sizeof asDialer_cmds[0])
end_define

begin_escape
end_escape

begin_comment
comment|/* Handle a command passed to a dialer from a Taylor UUCP    configuration file.  This can be called when reading the dialer    file, the port file, or the sys file.  The return value may have    UUCONF_CMDTABRET_KEEP set, but not UUCONF_CMDTABRET_EXIT.  It    assigns values to the elements of qdialer.  The first time this is    called, qdialer->uuconf_palloc should be set.  This will not set    qdialer->uuconf_zname.  */
end_comment

begin_function
name|int
name|_uuconf_idialer_cmd
parameter_list|(
name|qglobal
parameter_list|,
name|argc
parameter_list|,
name|argv
parameter_list|,
name|qdialer
parameter_list|)
name|struct
name|sglobal
modifier|*
name|qglobal
decl_stmt|;
name|int
name|argc
decl_stmt|;
name|char
modifier|*
modifier|*
name|argv
decl_stmt|;
name|struct
name|uuconf_dialer
modifier|*
name|qdialer
decl_stmt|;
block|{
name|struct
name|uuconf_cmdtab
name|as
index|[
name|CDIALER_CMDS
index|]
decl_stmt|;
name|int
name|iret
decl_stmt|;
name|_uuconf_ucmdtab_base
argument_list|(
name|asDialer_cmds
argument_list|,
name|CDIALER_CMDS
argument_list|,
operator|(
name|char
operator|*
operator|)
name|qdialer
argument_list|,
name|as
argument_list|)
expr_stmt|;
name|iret
operator|=
name|uuconf_cmd_args
argument_list|(
operator|(
name|pointer
operator|)
name|qglobal
argument_list|,
name|argc
argument_list|,
name|argv
argument_list|,
name|as
argument_list|,
operator|(
name|pointer
operator|)
name|qdialer
argument_list|,
name|idcunknown
argument_list|,
literal|0
argument_list|,
name|qdialer
operator|->
name|uuconf_palloc
argument_list|)
expr_stmt|;
return|return
name|iret
operator|&
operator|~
name|UUCONF_CMDTABRET_EXIT
return|;
block|}
end_function

begin_escape
end_escape

begin_comment
comment|/* Reroute a chat script command.  */
end_comment

begin_function
specifier|static
name|int
name|idchat
parameter_list|(
name|pglobal
parameter_list|,
name|argc
parameter_list|,
name|argv
parameter_list|,
name|pvar
parameter_list|,
name|pinfo
parameter_list|)
name|pointer
name|pglobal
decl_stmt|;
name|int
name|argc
decl_stmt|;
name|char
modifier|*
modifier|*
name|argv
decl_stmt|;
name|pointer
name|pvar
decl_stmt|;
name|pointer
name|pinfo
decl_stmt|;
block|{
name|struct
name|sglobal
modifier|*
name|qglobal
init|=
operator|(
expr|struct
name|sglobal
operator|*
operator|)
name|pglobal
decl_stmt|;
name|struct
name|uuconf_chat
modifier|*
name|qchat
init|=
operator|(
expr|struct
name|uuconf_chat
operator|*
operator|)
name|pvar
decl_stmt|;
name|struct
name|uuconf_dialer
modifier|*
name|qdialer
init|=
operator|(
expr|struct
name|uuconf_dialer
operator|*
operator|)
name|pinfo
decl_stmt|;
return|return
name|_uuconf_ichat_cmd
argument_list|(
name|qglobal
argument_list|,
name|argc
argument_list|,
name|argv
argument_list|,
name|qchat
argument_list|,
name|qdialer
operator|->
name|uuconf_palloc
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/* Handle the "dtr-toggle" command, which may take two arguments.  */
end_comment

begin_comment
comment|/*ARGSUSED*/
end_comment

begin_function
specifier|static
name|int
name|iddtr_toggle
parameter_list|(
name|pglobal
parameter_list|,
name|argc
parameter_list|,
name|argv
parameter_list|,
name|pvar
parameter_list|,
name|pinfo
parameter_list|)
name|pointer
name|pglobal
decl_stmt|;
name|int
name|argc
decl_stmt|;
name|char
modifier|*
modifier|*
name|argv
decl_stmt|;
name|pointer
name|pvar
decl_stmt|;
name|pointer
name|pinfo
decl_stmt|;
block|{
name|struct
name|sglobal
modifier|*
name|qglobal
init|=
operator|(
expr|struct
name|sglobal
operator|*
operator|)
name|pglobal
decl_stmt|;
name|struct
name|uuconf_dialer
modifier|*
name|qdialer
init|=
operator|(
expr|struct
name|uuconf_dialer
operator|*
operator|)
name|pinfo
decl_stmt|;
name|int
name|iret
decl_stmt|;
if|if
condition|(
name|argc
operator|<
literal|2
operator|||
name|argc
operator|>
literal|3
condition|)
return|return
name|UUCONF_SYNTAX_ERROR
operator||
name|UUCONF_CMDTABRET_EXIT
return|;
name|iret
operator|=
name|_uuconf_iboolean
argument_list|(
name|qglobal
argument_list|,
name|argv
index|[
literal|1
index|]
argument_list|,
operator|&
name|qdialer
operator|->
name|uuconf_fdtr_toggle
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|iret
operator|&
operator|~
name|UUCONF_CMDTABRET_KEEP
operator|)
operator|!=
name|UUCONF_SUCCESS
condition|)
return|return
name|iret
return|;
if|if
condition|(
name|argc
operator|<
literal|3
condition|)
return|return
name|iret
return|;
name|iret
operator||=
name|_uuconf_iboolean
argument_list|(
name|qglobal
argument_list|,
name|argv
index|[
literal|2
index|]
argument_list|,
operator|&
name|qdialer
operator|->
name|uuconf_fdtr_toggle_wait
argument_list|)
expr_stmt|;
return|return
name|iret
return|;
block|}
end_function

begin_comment
comment|/* Handle the "complete" and "abort" commands.  These just turn a    string into a trivial chat script.  */
end_comment

begin_comment
comment|/*ARGSUSED*/
end_comment

begin_function
specifier|static
name|int
name|idcomplete
parameter_list|(
name|pglobal
parameter_list|,
name|argc
parameter_list|,
name|argv
parameter_list|,
name|pvar
parameter_list|,
name|pinfo
parameter_list|)
name|pointer
name|pglobal
decl_stmt|;
name|int
name|argc
decl_stmt|;
name|char
modifier|*
modifier|*
name|argv
decl_stmt|;
name|pointer
name|pvar
decl_stmt|;
name|pointer
name|pinfo
decl_stmt|;
block|{
name|struct
name|sglobal
modifier|*
name|qglobal
init|=
operator|(
expr|struct
name|sglobal
operator|*
operator|)
name|pglobal
decl_stmt|;
name|struct
name|uuconf_chat
modifier|*
name|qchat
init|=
operator|(
expr|struct
name|uuconf_chat
operator|*
operator|)
name|pvar
decl_stmt|;
name|struct
name|uuconf_dialer
modifier|*
name|qdialer
init|=
operator|(
expr|struct
name|uuconf_dialer
operator|*
operator|)
name|pinfo
decl_stmt|;
name|char
modifier|*
name|azargs
index|[
literal|3
index|]
decl_stmt|;
name|azargs
index|[
literal|0
index|]
operator|=
operator|(
name|char
operator|*
operator|)
literal|"complete-chat"
expr_stmt|;
name|azargs
index|[
literal|1
index|]
operator|=
operator|(
name|char
operator|*
operator|)
literal|"\"\""
expr_stmt|;
name|azargs
index|[
literal|2
index|]
operator|=
operator|(
name|char
operator|*
operator|)
name|argv
index|[
literal|1
index|]
expr_stmt|;
return|return
name|_uuconf_ichat_cmd
argument_list|(
name|qglobal
argument_list|,
literal|3
argument_list|,
name|azargs
argument_list|,
name|qchat
argument_list|,
name|qdialer
operator|->
name|uuconf_palloc
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/* Handle the "protocol-parameter" command.  */
end_comment

begin_function
specifier|static
name|int
name|idproto_param
parameter_list|(
name|pglobal
parameter_list|,
name|argc
parameter_list|,
name|argv
parameter_list|,
name|pvar
parameter_list|,
name|pinfo
parameter_list|)
name|pointer
name|pglobal
decl_stmt|;
name|int
name|argc
decl_stmt|;
name|char
modifier|*
modifier|*
name|argv
decl_stmt|;
name|pointer
name|pvar
decl_stmt|;
name|pointer
name|pinfo
decl_stmt|;
block|{
name|struct
name|sglobal
modifier|*
name|qglobal
init|=
operator|(
expr|struct
name|sglobal
operator|*
operator|)
name|pglobal
decl_stmt|;
name|struct
name|uuconf_proto_param
modifier|*
modifier|*
name|pqparam
init|=
operator|(
expr|struct
name|uuconf_proto_param
operator|*
operator|*
operator|)
name|pvar
decl_stmt|;
name|struct
name|uuconf_dialer
modifier|*
name|qdialer
init|=
operator|(
expr|struct
name|uuconf_dialer
operator|*
operator|)
name|pinfo
decl_stmt|;
return|return
name|_uuconf_iadd_proto_param
argument_list|(
name|qglobal
argument_list|,
name|argc
operator|-
literal|1
argument_list|,
name|argv
operator|+
literal|1
argument_list|,
name|pqparam
argument_list|,
name|qdialer
operator|->
name|uuconf_palloc
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/* Give an error for an unknown dialer command.  */
end_comment

begin_comment
comment|/*ARGSUSED*/
end_comment

begin_function
specifier|static
name|int
name|idcunknown
parameter_list|(
name|pglobal
parameter_list|,
name|argc
parameter_list|,
name|argv
parameter_list|,
name|pvar
parameter_list|,
name|pinfo
parameter_list|)
name|pointer
name|pglobal
decl_stmt|;
name|int
name|argc
decl_stmt|;
name|char
modifier|*
modifier|*
name|argv
decl_stmt|;
name|pointer
name|pvar
decl_stmt|;
name|pointer
name|pinfo
decl_stmt|;
block|{
return|return
name|UUCONF_SYNTAX_ERROR
operator||
name|UUCONF_CMDTABRET_EXIT
return|;
block|}
end_function

end_unit


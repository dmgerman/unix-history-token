begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/* tinit.c    Initialize for reading Taylor UUCP configuration files.     Copyright (C) 1992, 1993, 1994, 1995 Ian Lance Taylor     This file is part of the Taylor UUCP uuconf library.     This library is free software; you can redistribute it and/or    modify it under the terms of the GNU Library General Public License    as published by the Free Software Foundation; either version 2 of    the License, or (at your option) any later version.     This library is distributed in the hope that it will be useful, but    WITHOUT ANY WARRANTY; without even the implied warranty of    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU    Library General Public License for more details.     You should have received a copy of the GNU Library General Public    License along with this library; if not, write to the Free Software    Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.     The author of the program may be contacted at ian@airs.com or    c/o Cygnus Support, 48 Grove Street, Somerville, MA 02144.    */
end_comment

begin_include
include|#
directive|include
file|"uucnfi.h"
end_include

begin_if
if|#
directive|if
name|USE_RCS_ID
end_if

begin_decl_stmt
specifier|const
name|char
name|_uuconf_tinit_rcsid
index|[]
init|=
literal|"$FreeBSD$"
decl_stmt|;
end_decl_stmt

begin_endif
endif|#
directive|endif
end_endif

begin_include
include|#
directive|include
file|<errno.h>
end_include

begin_escape
end_escape

begin_comment
comment|/* Local functions.  */
end_comment

begin_decl_stmt
specifier|static
name|int
name|itset_default
name|P
argument_list|(
operator|(
expr|struct
name|sglobal
operator|*
name|qglobal
operator|,
name|char
operator|*
operator|*
operator|*
name|ppzvar
operator|,
specifier|const
name|char
operator|*
name|zfile
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|itdebug
name|P
argument_list|(
operator|(
name|pointer
name|pglobal
operator|,
name|int
name|argc
operator|,
name|char
operator|*
operator|*
name|argv
operator|,
name|pointer
name|pvar
operator|,
name|pointer
name|pinfo
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|itaddfile
name|P
argument_list|(
operator|(
name|pointer
name|pglobal
operator|,
name|int
name|argc
operator|,
name|char
operator|*
operator|*
name|argv
operator|,
name|pointer
name|pvar
operator|,
name|pointer
name|pinfo
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|itunknown
name|P
argument_list|(
operator|(
name|pointer
name|pglobal
operator|,
name|int
name|argc
operator|,
name|char
operator|*
operator|*
name|argv
operator|,
name|pointer
name|pvar
operator|,
name|pointer
name|pinfo
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|itprogram
name|P
argument_list|(
operator|(
name|pointer
name|pglobal
operator|,
name|int
name|argc
operator|,
name|char
operator|*
operator|*
name|argv
operator|,
name|pointer
name|pvar
operator|,
name|pointer
name|pinfo
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_escape
end_escape

begin_decl_stmt
specifier|static
specifier|const
name|struct
name|cmdtab_offset
name|asCmds
index|[]
init|=
block|{
block|{
literal|"nodename"
block|,
name|UUCONF_CMDTABTYPE_STRING
block|,
name|offsetof
argument_list|(
expr|struct
name|sprocess
argument_list|,
name|zlocalname
argument_list|)
block|,
name|NULL
block|}
block|,
block|{
literal|"hostname"
block|,
name|UUCONF_CMDTABTYPE_STRING
block|,
name|offsetof
argument_list|(
expr|struct
name|sprocess
argument_list|,
name|zlocalname
argument_list|)
block|,
name|NULL
block|}
block|,
block|{
literal|"uuname"
block|,
name|UUCONF_CMDTABTYPE_STRING
block|,
name|offsetof
argument_list|(
expr|struct
name|sprocess
argument_list|,
name|zlocalname
argument_list|)
block|,
name|NULL
block|}
block|,
block|{
literal|"spool"
block|,
name|UUCONF_CMDTABTYPE_STRING
block|,
name|offsetof
argument_list|(
expr|struct
name|sprocess
argument_list|,
name|zspooldir
argument_list|)
block|,
name|NULL
block|}
block|,
block|{
literal|"pubdir"
block|,
name|UUCONF_CMDTABTYPE_STRING
block|,
name|offsetof
argument_list|(
expr|struct
name|sprocess
argument_list|,
name|zpubdir
argument_list|)
block|,
name|NULL
block|}
block|,
block|{
literal|"lockdir"
block|,
name|UUCONF_CMDTABTYPE_STRING
block|,
name|offsetof
argument_list|(
expr|struct
name|sprocess
argument_list|,
name|zlockdir
argument_list|)
block|,
name|NULL
block|}
block|,
block|{
literal|"logfile"
block|,
name|UUCONF_CMDTABTYPE_STRING
block|,
name|offsetof
argument_list|(
expr|struct
name|sprocess
argument_list|,
name|zlogfile
argument_list|)
block|,
name|NULL
block|}
block|,
block|{
literal|"statfile"
block|,
name|UUCONF_CMDTABTYPE_STRING
block|,
name|offsetof
argument_list|(
expr|struct
name|sprocess
argument_list|,
name|zstatsfile
argument_list|)
block|,
name|NULL
block|}
block|,
block|{
literal|"debugfile"
block|,
name|UUCONF_CMDTABTYPE_STRING
block|,
name|offsetof
argument_list|(
expr|struct
name|sprocess
argument_list|,
name|zdebugfile
argument_list|)
block|,
name|NULL
block|}
block|,
block|{
literal|"debug"
block|,
name|UUCONF_CMDTABTYPE_FN
operator||
literal|0
block|,
name|offsetof
argument_list|(
expr|struct
name|sprocess
argument_list|,
name|zdebug
argument_list|)
block|,
name|itdebug
block|}
block|,
block|{
literal|"strip-login"
block|,
name|UUCONF_CMDTABTYPE_BOOLEAN
block|,
name|offsetof
argument_list|(
expr|struct
name|sprocess
argument_list|,
name|fstrip_login
argument_list|)
block|,
name|NULL
block|}
block|,
block|{
literal|"strip-proto"
block|,
name|UUCONF_CMDTABTYPE_BOOLEAN
block|,
name|offsetof
argument_list|(
expr|struct
name|sprocess
argument_list|,
name|fstrip_proto
argument_list|)
block|,
name|NULL
block|}
block|,
block|{
literal|"max-uuxqts"
block|,
name|UUCONF_CMDTABTYPE_INT
block|,
name|offsetof
argument_list|(
expr|struct
name|sprocess
argument_list|,
name|cmaxuuxqts
argument_list|)
block|,
name|NULL
block|}
block|,
block|{
literal|"run-uuxqt"
block|,
name|UUCONF_CMDTABTYPE_STRING
block|,
name|offsetof
argument_list|(
expr|struct
name|sprocess
argument_list|,
name|zrunuuxqt
argument_list|)
block|,
name|NULL
block|}
block|,
block|{
literal|"sysfile"
block|,
name|UUCONF_CMDTABTYPE_FN
operator||
literal|0
block|,
name|offsetof
argument_list|(
expr|struct
name|sprocess
argument_list|,
name|pzsysfiles
argument_list|)
block|,
name|itaddfile
block|}
block|,
block|{
literal|"portfile"
block|,
name|UUCONF_CMDTABTYPE_FN
operator||
literal|0
block|,
name|offsetof
argument_list|(
expr|struct
name|sprocess
argument_list|,
name|pzportfiles
argument_list|)
block|,
name|itaddfile
block|}
block|,
block|{
literal|"dialfile"
block|,
name|UUCONF_CMDTABTYPE_FN
operator||
literal|0
block|,
name|offsetof
argument_list|(
expr|struct
name|sprocess
argument_list|,
name|pzdialfiles
argument_list|)
block|,
name|itaddfile
block|}
block|,
block|{
literal|"dialcodefile"
block|,
name|UUCONF_CMDTABTYPE_FN
operator||
literal|0
block|,
name|offsetof
argument_list|(
expr|struct
name|sprocess
argument_list|,
name|pzdialcodefiles
argument_list|)
block|,
name|itaddfile
block|}
block|,
block|{
literal|"callfile"
block|,
name|UUCONF_CMDTABTYPE_FN
operator||
literal|0
block|,
name|offsetof
argument_list|(
expr|struct
name|sprocess
argument_list|,
name|pzcallfiles
argument_list|)
block|,
name|itaddfile
block|}
block|,
block|{
literal|"passwdfile"
block|,
name|UUCONF_CMDTABTYPE_FN
operator||
literal|0
block|,
name|offsetof
argument_list|(
expr|struct
name|sprocess
argument_list|,
name|pzpwdfiles
argument_list|)
block|,
name|itaddfile
block|}
block|,
block|{
literal|"unknown"
block|,
name|UUCONF_CMDTABTYPE_FN
block|,
name|offsetof
argument_list|(
expr|struct
name|sprocess
argument_list|,
name|qunknown
argument_list|)
block|,
name|itunknown
block|}
block|,
block|{
literal|"v2-files"
block|,
name|UUCONF_CMDTABTYPE_BOOLEAN
block|,
name|offsetof
argument_list|(
expr|struct
name|sprocess
argument_list|,
name|fv2
argument_list|)
block|,
name|NULL
block|}
block|,
block|{
literal|"hdb-files"
block|,
name|UUCONF_CMDTABTYPE_BOOLEAN
block|,
name|offsetof
argument_list|(
expr|struct
name|sprocess
argument_list|,
name|fhdb
argument_list|)
block|,
name|NULL
block|}
block|,
block|{
literal|"bnu-files"
block|,
name|UUCONF_CMDTABTYPE_BOOLEAN
block|,
name|offsetof
argument_list|(
expr|struct
name|sprocess
argument_list|,
name|fhdb
argument_list|)
block|,
name|NULL
block|}
block|,
block|{
literal|"timetable"
block|,
name|UUCONF_CMDTABTYPE_FN
operator||
literal|3
block|,
name|offsetof
argument_list|(
expr|struct
name|sprocess
argument_list|,
name|pztimetables
argument_list|)
block|,
name|_uuconf_itimetable
block|}
block|,
block|{
name|NULL
block|,
literal|0
block|,
literal|0
block|,
name|NULL
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_define
define|#
directive|define
name|CCMDS
value|(sizeof asCmds / sizeof asCmds[0])
end_define

begin_escape
end_escape

begin_comment
comment|/* This structure is used to pass information into the command table    functions.  */
end_comment

begin_struct
struct|struct
name|sinfo
block|{
comment|/* The program name.  */
specifier|const
name|char
modifier|*
name|zname
decl_stmt|;
comment|/* A pointer to the command table being used, passed to isystem so      it can call uuconf_cmd_args.  */
name|struct
name|uuconf_cmdtab
modifier|*
name|qcmds
decl_stmt|;
block|}
struct|;
end_struct

begin_escape
end_escape

begin_comment
comment|/* Initialize the routines which read the Taylor UUCP configuration    files.  */
end_comment

begin_function
name|int
name|uuconf_taylor_init
parameter_list|(
name|ppglobal
parameter_list|,
name|zprogram
parameter_list|,
name|zname
parameter_list|)
name|pointer
modifier|*
name|ppglobal
decl_stmt|;
specifier|const
name|char
modifier|*
name|zprogram
decl_stmt|;
specifier|const
name|char
modifier|*
name|zname
decl_stmt|;
block|{
name|struct
name|sglobal
modifier|*
modifier|*
name|pqglobal
init|=
operator|(
expr|struct
name|sglobal
operator|*
operator|*
operator|)
name|ppglobal
decl_stmt|;
name|int
name|iret
decl_stmt|;
name|char
modifier|*
name|zcopy
decl_stmt|;
name|struct
name|sglobal
modifier|*
name|qglobal
decl_stmt|;
name|boolean
name|fdefault
decl_stmt|;
name|FILE
modifier|*
name|e
decl_stmt|;
name|struct
name|sinfo
name|si
decl_stmt|;
if|if
condition|(
operator|*
name|pqglobal
operator|==
name|NULL
condition|)
block|{
name|iret
operator|=
name|_uuconf_iinit_global
argument_list|(
name|pqglobal
argument_list|)
expr_stmt|;
if|if
condition|(
name|iret
operator|!=
name|UUCONF_SUCCESS
condition|)
return|return
name|iret
return|;
block|}
name|qglobal
operator|=
operator|*
name|pqglobal
expr_stmt|;
if|if
condition|(
name|zname
operator|!=
name|NULL
condition|)
block|{
name|size_t
name|csize
decl_stmt|;
name|csize
operator|=
name|strlen
argument_list|(
name|zname
argument_list|)
operator|+
literal|1
expr_stmt|;
name|zcopy
operator|=
name|uuconf_malloc
argument_list|(
name|qglobal
operator|->
name|pblock
argument_list|,
name|csize
argument_list|)
expr_stmt|;
if|if
condition|(
name|zcopy
operator|==
name|NULL
condition|)
block|{
name|qglobal
operator|->
name|ierrno
operator|=
name|errno
expr_stmt|;
return|return
name|UUCONF_MALLOC_FAILED
operator||
name|UUCONF_ERROR_ERRNO
return|;
block|}
name|memcpy
argument_list|(
operator|(
name|pointer
operator|)
name|zcopy
argument_list|,
operator|(
name|pointer
operator|)
name|zname
argument_list|,
name|csize
argument_list|)
expr_stmt|;
name|fdefault
operator|=
name|FALSE
expr_stmt|;
block|}
else|else
block|{
name|zcopy
operator|=
name|uuconf_malloc
argument_list|(
name|qglobal
operator|->
name|pblock
argument_list|,
sizeof|sizeof
name|NEWCONFIGLIB
operator|+
sizeof|sizeof
name|CONFIGFILE
operator|-
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|zcopy
operator|==
name|NULL
condition|)
block|{
name|qglobal
operator|->
name|ierrno
operator|=
name|errno
expr_stmt|;
return|return
name|UUCONF_MALLOC_FAILED
operator||
name|UUCONF_ERROR_ERRNO
return|;
block|}
name|memcpy
argument_list|(
operator|(
name|pointer
operator|)
name|zcopy
argument_list|,
operator|(
name|pointer
operator|)
name|NEWCONFIGLIB
argument_list|,
sizeof|sizeof
name|NEWCONFIGLIB
operator|-
literal|1
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
call|(
name|pointer
call|)
argument_list|(
name|zcopy
operator|+
sizeof|sizeof
name|NEWCONFIGLIB
operator|-
literal|1
argument_list|)
argument_list|,
operator|(
name|pointer
operator|)
name|CONFIGFILE
argument_list|,
sizeof|sizeof
name|CONFIGFILE
argument_list|)
expr_stmt|;
name|fdefault
operator|=
name|TRUE
expr_stmt|;
block|}
name|qglobal
operator|->
name|qprocess
operator|->
name|zconfigfile
operator|=
name|zcopy
expr_stmt|;
name|e
operator|=
name|fopen
argument_list|(
name|zcopy
argument_list|,
literal|"r"
argument_list|)
expr_stmt|;
if|if
condition|(
name|e
operator|==
name|NULL
condition|)
block|{
if|if
condition|(
operator|!
name|fdefault
condition|)
block|{
name|qglobal
operator|->
name|ierrno
operator|=
name|errno
expr_stmt|;
name|qglobal
operator|->
name|zfilename
operator|=
name|zcopy
expr_stmt|;
return|return
operator|(
name|UUCONF_FOPEN_FAILED
operator||
name|UUCONF_ERROR_ERRNO
operator||
name|UUCONF_ERROR_FILENAME
operator|)
return|;
block|}
comment|/* There is no config file, so just use the default values.  */
block|}
else|else
block|{
name|struct
name|uuconf_cmdtab
name|as
index|[
name|CCMDS
index|]
decl_stmt|;
name|_uuconf_ucmdtab_base
argument_list|(
name|asCmds
argument_list|,
name|CCMDS
argument_list|,
operator|(
name|char
operator|*
operator|)
name|qglobal
operator|->
name|qprocess
argument_list|,
name|as
argument_list|)
expr_stmt|;
if|if
condition|(
name|zprogram
operator|==
name|NULL
condition|)
name|zprogram
operator|=
literal|"uucp"
expr_stmt|;
name|si
operator|.
name|zname
operator|=
name|zprogram
expr_stmt|;
name|si
operator|.
name|qcmds
operator|=
name|as
expr_stmt|;
name|iret
operator|=
name|uuconf_cmd_file
argument_list|(
name|qglobal
argument_list|,
name|e
argument_list|,
name|as
argument_list|,
operator|(
name|pointer
operator|)
operator|&
name|si
argument_list|,
name|itprogram
argument_list|,
name|UUCONF_CMDTABFLAG_BACKSLASH
argument_list|,
name|qglobal
operator|->
name|pblock
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|fclose
argument_list|(
name|e
argument_list|)
expr_stmt|;
if|if
condition|(
name|iret
operator|!=
name|UUCONF_SUCCESS
condition|)
block|{
name|qglobal
operator|->
name|zfilename
operator|=
name|zcopy
expr_stmt|;
return|return
name|iret
operator||
name|UUCONF_ERROR_FILENAME
return|;
block|}
block|}
comment|/* Get the defaults for the file names.  */
name|iret
operator|=
name|itset_default
argument_list|(
name|qglobal
argument_list|,
operator|&
name|qglobal
operator|->
name|qprocess
operator|->
name|pzsysfiles
argument_list|,
name|SYSFILE
argument_list|)
expr_stmt|;
if|if
condition|(
name|iret
operator|!=
name|UUCONF_SUCCESS
condition|)
return|return
name|iret
return|;
name|iret
operator|=
name|itset_default
argument_list|(
name|qglobal
argument_list|,
operator|&
name|qglobal
operator|->
name|qprocess
operator|->
name|pzportfiles
argument_list|,
name|PORTFILE
argument_list|)
expr_stmt|;
if|if
condition|(
name|iret
operator|!=
name|UUCONF_SUCCESS
condition|)
return|return
name|iret
return|;
name|iret
operator|=
name|itset_default
argument_list|(
name|qglobal
argument_list|,
operator|&
name|qglobal
operator|->
name|qprocess
operator|->
name|pzdialfiles
argument_list|,
name|DIALFILE
argument_list|)
expr_stmt|;
if|if
condition|(
name|iret
operator|!=
name|UUCONF_SUCCESS
condition|)
return|return
name|iret
return|;
name|iret
operator|=
name|itset_default
argument_list|(
name|qglobal
argument_list|,
operator|&
name|qglobal
operator|->
name|qprocess
operator|->
name|pzdialcodefiles
argument_list|,
name|DIALCODEFILE
argument_list|)
expr_stmt|;
if|if
condition|(
name|iret
operator|!=
name|UUCONF_SUCCESS
condition|)
return|return
name|iret
return|;
name|iret
operator|=
name|itset_default
argument_list|(
name|qglobal
argument_list|,
operator|&
name|qglobal
operator|->
name|qprocess
operator|->
name|pzpwdfiles
argument_list|,
name|PASSWDFILE
argument_list|)
expr_stmt|;
if|if
condition|(
name|iret
operator|!=
name|UUCONF_SUCCESS
condition|)
return|return
name|iret
return|;
name|iret
operator|=
name|itset_default
argument_list|(
name|qglobal
argument_list|,
operator|&
name|qglobal
operator|->
name|qprocess
operator|->
name|pzcallfiles
argument_list|,
name|CALLFILE
argument_list|)
expr_stmt|;
if|if
condition|(
name|iret
operator|!=
name|UUCONF_SUCCESS
condition|)
return|return
name|iret
return|;
return|return
name|UUCONF_SUCCESS
return|;
block|}
end_function

begin_escape
end_escape

begin_comment
comment|/* Local interface to the _uuconf_idebug_cmd function, which handles    the "debug" command.  */
end_comment

begin_function
specifier|static
name|int
name|itdebug
parameter_list|(
name|pglobal
parameter_list|,
name|argc
parameter_list|,
name|argv
parameter_list|,
name|pvar
parameter_list|,
name|pinfo
parameter_list|)
name|pointer
name|pglobal
decl_stmt|;
name|int
name|argc
decl_stmt|;
name|char
modifier|*
modifier|*
name|argv
decl_stmt|;
name|pointer
name|pvar
decl_stmt|;
name|pointer
name|pinfo
decl_stmt|;
block|{
name|struct
name|sglobal
modifier|*
name|qglobal
init|=
operator|(
expr|struct
name|sglobal
operator|*
operator|)
name|pglobal
decl_stmt|;
name|char
modifier|*
modifier|*
name|pzdebug
init|=
operator|(
name|char
operator|*
operator|*
operator|)
name|pvar
decl_stmt|;
return|return
name|_uuconf_idebug_cmd
argument_list|(
name|qglobal
argument_list|,
name|pzdebug
argument_list|,
name|argc
argument_list|,
name|argv
argument_list|,
name|qglobal
operator|->
name|pblock
argument_list|)
return|;
block|}
end_function

begin_escape
end_escape

begin_comment
comment|/* Add new filenames to a list of files.  */
end_comment

begin_comment
comment|/*ARGSUSED*/
end_comment

begin_function
specifier|static
name|int
name|itaddfile
parameter_list|(
name|pglobal
parameter_list|,
name|argc
parameter_list|,
name|argv
parameter_list|,
name|pvar
parameter_list|,
name|pinfo
parameter_list|)
name|pointer
name|pglobal
decl_stmt|;
name|int
name|argc
decl_stmt|;
name|char
modifier|*
modifier|*
name|argv
decl_stmt|;
name|pointer
name|pvar
decl_stmt|;
name|pointer
name|pinfo
decl_stmt|;
block|{
name|struct
name|sglobal
modifier|*
name|qglobal
init|=
operator|(
expr|struct
name|sglobal
operator|*
operator|)
name|pglobal
decl_stmt|;
name|char
modifier|*
modifier|*
modifier|*
name|ppz
init|=
operator|(
name|char
operator|*
operator|*
operator|*
operator|)
name|pvar
decl_stmt|;
name|int
name|i
decl_stmt|;
name|int
name|iret
decl_stmt|;
if|if
condition|(
name|argc
operator|==
literal|1
condition|)
block|{
name|iret
operator|=
name|_uuconf_iadd_string
argument_list|(
name|qglobal
argument_list|,
name|NULL
argument_list|,
name|FALSE
argument_list|,
name|FALSE
argument_list|,
name|ppz
argument_list|,
name|qglobal
operator|->
name|pblock
argument_list|)
expr_stmt|;
if|if
condition|(
name|iret
operator|!=
name|UUCONF_SUCCESS
condition|)
return|return
name|iret
return|;
block|}
else|else
block|{
for|for
control|(
name|i
operator|=
literal|1
init|;
name|i
operator|<
name|argc
condition|;
name|i
operator|++
control|)
block|{
name|char
modifier|*
name|z
decl_stmt|;
name|boolean
name|fallocated
decl_stmt|;
name|MAKE_ABSOLUTE
argument_list|(
name|z
argument_list|,
name|fallocated
argument_list|,
name|argv
index|[
name|i
index|]
argument_list|,
name|NEWCONFIGLIB
argument_list|,
name|qglobal
operator|->
name|pblock
argument_list|)
expr_stmt|;
if|if
condition|(
name|z
operator|==
name|NULL
condition|)
block|{
name|qglobal
operator|->
name|ierrno
operator|=
name|errno
expr_stmt|;
return|return
operator|(
name|UUCONF_MALLOC_FAILED
operator||
name|UUCONF_ERROR_ERRNO
operator||
name|UUCONF_CMDTABRET_EXIT
operator|)
return|;
block|}
name|iret
operator|=
name|_uuconf_iadd_string
argument_list|(
name|qglobal
argument_list|,
name|z
argument_list|,
operator|!
name|fallocated
argument_list|,
name|FALSE
argument_list|,
name|ppz
argument_list|,
name|qglobal
operator|->
name|pblock
argument_list|)
expr_stmt|;
if|if
condition|(
name|iret
operator|!=
name|UUCONF_SUCCESS
condition|)
return|return
name|iret
return|;
block|}
block|}
return|return
name|UUCONF_CMDTABRET_CONTINUE
return|;
block|}
end_function

begin_escape
end_escape

begin_comment
comment|/* Handle an "unknown" command.  We accumulate this into a linked    list, and only parse them later in uuconf_unknown_system_info.  */
end_comment

begin_comment
comment|/*ARGSUSED*/
end_comment

begin_function
specifier|static
name|int
name|itunknown
parameter_list|(
name|pglobal
parameter_list|,
name|argc
parameter_list|,
name|argv
parameter_list|,
name|pvar
parameter_list|,
name|pinfo
parameter_list|)
name|pointer
name|pglobal
decl_stmt|;
name|int
name|argc
decl_stmt|;
name|char
modifier|*
modifier|*
name|argv
decl_stmt|;
name|pointer
name|pvar
decl_stmt|;
name|pointer
name|pinfo
decl_stmt|;
block|{
name|struct
name|sglobal
modifier|*
name|qglobal
init|=
operator|(
expr|struct
name|sglobal
operator|*
operator|)
name|pglobal
decl_stmt|;
name|struct
name|sunknown
modifier|*
modifier|*
name|pq
init|=
operator|(
expr|struct
name|sunknown
operator|*
operator|*
operator|)
name|pvar
decl_stmt|;
name|struct
name|sunknown
modifier|*
name|q
decl_stmt|;
name|q
operator|=
operator|(
expr|struct
name|sunknown
operator|*
operator|)
name|uuconf_malloc
argument_list|(
name|qglobal
operator|->
name|pblock
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|sunknown
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|q
operator|==
name|NULL
condition|)
block|{
name|qglobal
operator|->
name|ierrno
operator|=
name|errno
expr_stmt|;
return|return
operator|(
name|UUCONF_MALLOC_FAILED
operator||
name|UUCONF_ERROR_ERRNO
operator||
name|UUCONF_CMDTABRET_EXIT
operator|)
return|;
block|}
name|q
operator|->
name|qnext
operator|=
name|NULL
expr_stmt|;
name|q
operator|->
name|ilineno
operator|=
name|qglobal
operator|->
name|ilineno
expr_stmt|;
name|q
operator|->
name|cargs
operator|=
name|argc
operator|-
literal|1
expr_stmt|;
name|q
operator|->
name|pzargs
operator|=
operator|(
name|char
operator|*
operator|*
operator|)
name|uuconf_malloc
argument_list|(
name|qglobal
operator|->
name|pblock
argument_list|,
operator|(
name|argc
operator|-
literal|1
operator|)
operator|*
sizeof|sizeof
argument_list|(
name|char
operator|*
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|q
operator|->
name|pzargs
operator|==
name|NULL
condition|)
block|{
name|qglobal
operator|->
name|ierrno
operator|=
name|errno
expr_stmt|;
return|return
operator|(
name|UUCONF_MALLOC_FAILED
operator||
name|UUCONF_ERROR_ERRNO
operator||
name|UUCONF_CMDTABRET_EXIT
operator|)
return|;
block|}
name|memcpy
argument_list|(
operator|(
name|pointer
operator|)
name|q
operator|->
name|pzargs
argument_list|,
call|(
name|pointer
call|)
argument_list|(
name|argv
operator|+
literal|1
argument_list|)
argument_list|,
operator|(
name|argc
operator|-
literal|1
operator|)
operator|*
sizeof|sizeof
argument_list|(
name|char
operator|*
argument_list|)
argument_list|)
expr_stmt|;
while|while
condition|(
operator|*
name|pq
operator|!=
name|NULL
condition|)
name|pq
operator|=
operator|&
operator|(
operator|*
name|pq
operator|)
operator|->
name|qnext
expr_stmt|;
operator|*
name|pq
operator|=
name|q
expr_stmt|;
return|return
name|UUCONF_CMDTABRET_KEEP
return|;
block|}
end_function

begin_escape
end_escape

begin_comment
comment|/* If we encounter an unknown command, see if it is the program with    which we were invoked.  If it was, pass the remaining arguments    back through the table.  */
end_comment

begin_comment
comment|/*ARGSUSED*/
end_comment

begin_function
specifier|static
name|int
name|itprogram
parameter_list|(
name|pglobal
parameter_list|,
name|argc
parameter_list|,
name|argv
parameter_list|,
name|pvar
parameter_list|,
name|pinfo
parameter_list|)
name|pointer
name|pglobal
decl_stmt|;
name|int
name|argc
decl_stmt|;
name|char
modifier|*
modifier|*
name|argv
decl_stmt|;
name|pointer
name|pvar
decl_stmt|;
name|pointer
name|pinfo
decl_stmt|;
block|{
name|struct
name|sglobal
modifier|*
name|qglobal
init|=
operator|(
expr|struct
name|sglobal
operator|*
operator|)
name|pglobal
decl_stmt|;
name|struct
name|sinfo
modifier|*
name|qinfo
init|=
operator|(
expr|struct
name|sinfo
operator|*
operator|)
name|pinfo
decl_stmt|;
if|if
condition|(
name|argc
operator|<=
literal|1
operator|||
name|strcasecmp
argument_list|(
name|qinfo
operator|->
name|zname
argument_list|,
name|argv
index|[
literal|0
index|]
argument_list|)
operator|!=
literal|0
condition|)
return|return
name|UUCONF_CMDTABRET_CONTINUE
return|;
return|return
name|uuconf_cmd_args
argument_list|(
name|pglobal
argument_list|,
name|argc
operator|-
literal|1
argument_list|,
name|argv
operator|+
literal|1
argument_list|,
name|qinfo
operator|->
name|qcmds
argument_list|,
operator|(
name|pointer
operator|)
name|NULL
argument_list|,
operator|(
name|uuconf_cmdtabfn
operator|)
name|NULL
argument_list|,
literal|0
argument_list|,
name|qglobal
operator|->
name|pblock
argument_list|)
return|;
block|}
end_function

begin_escape
end_escape

begin_comment
comment|/* If a filename was not set by the configuration file, add in the    default value.  */
end_comment

begin_function
specifier|static
name|int
name|itset_default
parameter_list|(
name|qglobal
parameter_list|,
name|ppzvar
parameter_list|,
name|zfile
parameter_list|)
name|struct
name|sglobal
modifier|*
name|qglobal
decl_stmt|;
name|char
modifier|*
modifier|*
modifier|*
name|ppzvar
decl_stmt|;
specifier|const
name|char
modifier|*
name|zfile
decl_stmt|;
block|{
name|size_t
name|clen
decl_stmt|;
name|char
modifier|*
name|zadd
decl_stmt|;
if|if
condition|(
operator|*
name|ppzvar
operator|!=
name|NULL
condition|)
return|return
name|UUCONF_SUCCESS
return|;
name|clen
operator|=
name|strlen
argument_list|(
name|zfile
argument_list|)
expr_stmt|;
name|zadd
operator|=
operator|(
name|char
operator|*
operator|)
name|uuconf_malloc
argument_list|(
name|qglobal
operator|->
name|pblock
argument_list|,
sizeof|sizeof
name|NEWCONFIGLIB
operator|+
name|clen
argument_list|)
expr_stmt|;
if|if
condition|(
name|zadd
operator|==
name|NULL
condition|)
block|{
name|qglobal
operator|->
name|ierrno
operator|=
name|errno
expr_stmt|;
return|return
name|UUCONF_MALLOC_FAILED
operator||
name|UUCONF_ERROR_ERRNO
return|;
block|}
name|memcpy
argument_list|(
operator|(
name|pointer
operator|)
name|zadd
argument_list|,
operator|(
name|pointer
operator|)
name|NEWCONFIGLIB
argument_list|,
sizeof|sizeof
name|NEWCONFIGLIB
operator|-
literal|1
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
call|(
name|pointer
call|)
argument_list|(
name|zadd
operator|+
sizeof|sizeof
name|NEWCONFIGLIB
operator|-
literal|1
argument_list|)
argument_list|,
operator|(
name|pointer
operator|)
name|zfile
argument_list|,
name|clen
operator|+
literal|1
argument_list|)
expr_stmt|;
return|return
name|_uuconf_iadd_string
argument_list|(
name|qglobal
argument_list|,
name|zadd
argument_list|,
name|FALSE
argument_list|,
name|FALSE
argument_list|,
name|ppzvar
argument_list|,
name|qglobal
operator|->
name|pblock
argument_list|)
return|;
block|}
end_function

begin_escape
end_escape

begin_comment
comment|/* Handle the "debug" command which is documented to take multiple    arguments.  This is also called by the ``debug'' command in a sys    file.  It returns a CMDTABRET code.  This should probably be in its    own file, but the only other place it is called is from tsinfo.c,    and any user of tsinfo.c it sure to link in this file as well.  */
end_comment

begin_function
name|int
name|_uuconf_idebug_cmd
parameter_list|(
name|qglobal
parameter_list|,
name|pzdebug
parameter_list|,
name|argc
parameter_list|,
name|argv
parameter_list|,
name|pblock
parameter_list|)
name|struct
name|sglobal
modifier|*
name|qglobal
decl_stmt|;
name|char
modifier|*
modifier|*
name|pzdebug
decl_stmt|;
name|int
name|argc
decl_stmt|;
name|char
modifier|*
modifier|*
name|argv
decl_stmt|;
name|pointer
name|pblock
decl_stmt|;
block|{
if|if
condition|(
name|argc
operator|==
literal|1
condition|)
block|{
operator|*
name|pzdebug
operator|=
name|NULL
expr_stmt|;
return|return
name|UUCONF_CMDTABRET_CONTINUE
return|;
block|}
elseif|else
if|if
condition|(
name|argc
operator|==
literal|2
condition|)
block|{
operator|*
name|pzdebug
operator|=
name|argv
index|[
literal|1
index|]
expr_stmt|;
return|return
name|UUCONF_CMDTABRET_KEEP
return|;
block|}
else|else
block|{
name|size_t
name|cdebug
decl_stmt|;
name|int
name|i
decl_stmt|;
name|char
modifier|*
name|zdebug
decl_stmt|;
name|cdebug
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|1
init|;
name|i
operator|<
name|argc
condition|;
name|i
operator|++
control|)
name|cdebug
operator|+=
name|strlen
argument_list|(
name|argv
index|[
name|i
index|]
argument_list|)
operator|+
literal|1
expr_stmt|;
name|zdebug
operator|=
operator|(
name|char
operator|*
operator|)
name|uuconf_malloc
argument_list|(
name|pblock
argument_list|,
name|cdebug
argument_list|)
expr_stmt|;
if|if
condition|(
name|zdebug
operator|==
name|NULL
condition|)
block|{
name|qglobal
operator|->
name|ierrno
operator|=
name|errno
expr_stmt|;
return|return
operator|(
name|UUCONF_MALLOC_FAILED
operator||
name|UUCONF_ERROR_ERRNO
operator||
name|UUCONF_CMDTABRET_EXIT
operator|)
return|;
block|}
name|cdebug
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|1
init|;
name|i
operator|<
name|argc
condition|;
name|i
operator|++
control|)
block|{
name|size_t
name|clen
decl_stmt|;
name|clen
operator|=
name|strlen
argument_list|(
name|argv
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
name|zdebug
operator|+
name|cdebug
argument_list|,
name|argv
index|[
name|i
index|]
argument_list|,
name|clen
argument_list|)
expr_stmt|;
name|zdebug
index|[
name|cdebug
operator|+
name|clen
index|]
operator|=
literal|' '
expr_stmt|;
name|cdebug
operator|+=
name|clen
operator|+
literal|1
expr_stmt|;
block|}
name|zdebug
index|[
name|cdebug
operator|-
literal|1
index|]
operator|=
literal|'\0'
expr_stmt|;
operator|*
name|pzdebug
operator|=
name|zdebug
expr_stmt|;
return|return
name|UUCONF_CMDTABRET_CONTINUE
return|;
block|}
block|}
end_function

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/* tcalou.c    Find callout login name and password from Taylor UUCP configuration files.     Copyright (C) 1992, 1993 Ian Lance Taylor     This file is part of the Taylor UUCP uuconf library.     This library is free software; you can redistribute it and/or    modify it under the terms of the GNU Library General Public License    as published by the Free Software Foundation; either version 2 of    the License, or (at your option) any later version.     This library is distributed in the hope that it will be useful, but    WITHOUT ANY WARRANTY; without even the implied warranty of    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU    Library General Public License for more details.     You should have received a copy of the GNU Library General Public    License along with this library; if not, write to the Free Software    Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.     The author of the program may be contacted at ian@airs.com or    c/o Cygnus Support, 48 Grove Street, Somerville, MA 02144.    */
end_comment

begin_include
include|#
directive|include
file|"uucnfi.h"
end_include

begin_if
if|#
directive|if
name|USE_RCS_ID
end_if

begin_decl_stmt
specifier|const
name|char
name|_uuconf_tcalou_rcsid
index|[]
init|=
literal|"$FreeBSD$"
decl_stmt|;
end_decl_stmt

begin_endif
endif|#
directive|endif
end_endif

begin_include
include|#
directive|include
file|<errno.h>
end_include

begin_escape
end_escape

begin_decl_stmt
specifier|static
name|int
name|icsys
name|P
argument_list|(
operator|(
name|pointer
name|pglobal
operator|,
name|int
name|argc
operator|,
name|char
operator|*
operator|*
name|argv
operator|,
name|pointer
name|pvar
operator|,
name|pointer
name|pinfo
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_escape
end_escape

begin_comment
comment|/* Find the callout login name and password for a system from the    Taylor UUCP configuration files.  */
end_comment

begin_function
name|int
name|uuconf_taylor_callout
parameter_list|(
name|pglobal
parameter_list|,
name|qsys
parameter_list|,
name|pzlog
parameter_list|,
name|pzpass
parameter_list|)
name|pointer
name|pglobal
decl_stmt|;
specifier|const
name|struct
name|uuconf_system
modifier|*
name|qsys
decl_stmt|;
name|char
modifier|*
modifier|*
name|pzlog
decl_stmt|;
name|char
modifier|*
modifier|*
name|pzpass
decl_stmt|;
block|{
name|struct
name|sglobal
modifier|*
name|qglobal
init|=
operator|(
expr|struct
name|sglobal
operator|*
operator|)
name|pglobal
decl_stmt|;
name|boolean
name|flookup
decl_stmt|;
name|struct
name|uuconf_cmdtab
name|as
index|[
literal|2
index|]
decl_stmt|;
name|char
modifier|*
modifier|*
name|pz
decl_stmt|;
name|int
name|iret
decl_stmt|;
name|pointer
name|pinfo
decl_stmt|;
operator|*
name|pzlog
operator|=
name|NULL
expr_stmt|;
operator|*
name|pzpass
operator|=
name|NULL
expr_stmt|;
name|flookup
operator|=
name|FALSE
expr_stmt|;
if|if
condition|(
name|qsys
operator|->
name|uuconf_zcall_login
operator|!=
name|NULL
condition|)
block|{
if|if
condition|(
name|strcmp
argument_list|(
name|qsys
operator|->
name|uuconf_zcall_login
argument_list|,
literal|"*"
argument_list|)
operator|==
literal|0
condition|)
name|flookup
operator|=
name|TRUE
expr_stmt|;
else|else
block|{
operator|*
name|pzlog
operator|=
name|strdup
argument_list|(
name|qsys
operator|->
name|uuconf_zcall_login
argument_list|)
expr_stmt|;
if|if
condition|(
operator|*
name|pzlog
operator|==
name|NULL
condition|)
block|{
name|qglobal
operator|->
name|ierrno
operator|=
name|errno
expr_stmt|;
return|return
name|UUCONF_MALLOC_FAILED
operator||
name|UUCONF_ERROR_ERRNO
return|;
block|}
block|}
block|}
if|if
condition|(
name|qsys
operator|->
name|uuconf_zcall_password
operator|!=
name|NULL
condition|)
block|{
if|if
condition|(
name|strcmp
argument_list|(
name|qsys
operator|->
name|uuconf_zcall_password
argument_list|,
literal|"*"
argument_list|)
operator|==
literal|0
condition|)
name|flookup
operator|=
name|TRUE
expr_stmt|;
else|else
block|{
operator|*
name|pzpass
operator|=
name|strdup
argument_list|(
name|qsys
operator|->
name|uuconf_zcall_password
argument_list|)
expr_stmt|;
if|if
condition|(
operator|*
name|pzpass
operator|==
name|NULL
condition|)
block|{
name|qglobal
operator|->
name|ierrno
operator|=
name|errno
expr_stmt|;
if|if
condition|(
operator|*
name|pzlog
operator|!=
name|NULL
condition|)
block|{
name|free
argument_list|(
operator|(
name|pointer
operator|)
operator|*
name|pzlog
argument_list|)
expr_stmt|;
operator|*
name|pzlog
operator|=
name|NULL
expr_stmt|;
block|}
return|return
name|UUCONF_MALLOC_FAILED
operator||
name|UUCONF_ERROR_ERRNO
return|;
block|}
block|}
block|}
if|if
condition|(
operator|!
name|flookup
condition|)
block|{
if|if
condition|(
operator|*
name|pzlog
operator|==
name|NULL
operator|&&
operator|*
name|pzpass
operator|==
name|NULL
condition|)
return|return
name|UUCONF_NOT_FOUND
return|;
return|return
name|UUCONF_SUCCESS
return|;
block|}
name|as
index|[
literal|0
index|]
operator|.
name|uuconf_zcmd
operator|=
name|qsys
operator|->
name|uuconf_zname
expr_stmt|;
name|as
index|[
literal|0
index|]
operator|.
name|uuconf_itype
operator|=
name|UUCONF_CMDTABTYPE_FN
operator||
literal|0
expr_stmt|;
if|if
condition|(
operator|*
name|pzlog
operator|==
name|NULL
condition|)
name|as
index|[
literal|0
index|]
operator|.
name|uuconf_pvar
operator|=
operator|(
name|pointer
operator|)
name|pzlog
expr_stmt|;
else|else
name|as
index|[
literal|0
index|]
operator|.
name|uuconf_pvar
operator|=
name|NULL
expr_stmt|;
name|as
index|[
literal|0
index|]
operator|.
name|uuconf_pifn
operator|=
name|icsys
expr_stmt|;
name|as
index|[
literal|1
index|]
operator|.
name|uuconf_zcmd
operator|=
name|NULL
expr_stmt|;
if|if
condition|(
operator|*
name|pzpass
operator|==
name|NULL
condition|)
name|pinfo
operator|=
operator|(
name|pointer
operator|)
name|pzpass
expr_stmt|;
else|else
name|pinfo
operator|=
name|NULL
expr_stmt|;
name|iret
operator|=
name|UUCONF_SUCCESS
expr_stmt|;
for|for
control|(
name|pz
operator|=
name|qglobal
operator|->
name|qprocess
operator|->
name|pzcallfiles
init|;
operator|*
name|pz
operator|!=
name|NULL
condition|;
name|pz
operator|++
control|)
block|{
name|FILE
modifier|*
name|e
decl_stmt|;
name|e
operator|=
name|fopen
argument_list|(
operator|*
name|pz
argument_list|,
literal|"r"
argument_list|)
expr_stmt|;
if|if
condition|(
name|e
operator|==
name|NULL
condition|)
block|{
if|if
condition|(
name|FNO_SUCH_FILE
argument_list|()
condition|)
continue|continue;
name|qglobal
operator|->
name|ierrno
operator|=
name|errno
expr_stmt|;
name|iret
operator|=
name|UUCONF_FOPEN_FAILED
operator||
name|UUCONF_ERROR_ERRNO
expr_stmt|;
break|break;
block|}
name|iret
operator|=
name|uuconf_cmd_file
argument_list|(
name|pglobal
argument_list|,
name|e
argument_list|,
name|as
argument_list|,
name|pinfo
argument_list|,
operator|(
name|uuconf_cmdtabfn
operator|)
name|NULL
argument_list|,
literal|0
argument_list|,
name|qsys
operator|->
name|uuconf_palloc
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|fclose
argument_list|(
name|e
argument_list|)
expr_stmt|;
if|if
condition|(
name|iret
operator|!=
name|UUCONF_SUCCESS
condition|)
break|break;
if|if
condition|(
operator|*
name|pzlog
operator|!=
name|NULL
condition|)
break|break;
block|}
if|if
condition|(
name|iret
operator|!=
name|UUCONF_SUCCESS
condition|)
block|{
name|qglobal
operator|->
name|zfilename
operator|=
operator|*
name|pz
expr_stmt|;
return|return
name|iret
operator||
name|UUCONF_ERROR_FILENAME
return|;
block|}
if|if
condition|(
operator|*
name|pzlog
operator|==
name|NULL
operator|&&
operator|*
name|pzpass
operator|==
name|NULL
condition|)
return|return
name|UUCONF_NOT_FOUND
return|;
return|return
name|UUCONF_SUCCESS
return|;
block|}
end_function

begin_comment
comment|/* Copy the login name and password onto the heap and set the    pointers.  The pzlog argument is passed in pvar, and the pzpass    argument is passed in pinfo.  */
end_comment

begin_function
specifier|static
name|int
name|icsys
parameter_list|(
name|pglobal
parameter_list|,
name|argc
parameter_list|,
name|argv
parameter_list|,
name|pvar
parameter_list|,
name|pinfo
parameter_list|)
name|pointer
name|pglobal
decl_stmt|;
name|int
name|argc
decl_stmt|;
name|char
modifier|*
modifier|*
name|argv
decl_stmt|;
name|pointer
name|pvar
decl_stmt|;
name|pointer
name|pinfo
decl_stmt|;
block|{
name|struct
name|sglobal
modifier|*
name|qglobal
init|=
operator|(
expr|struct
name|sglobal
operator|*
operator|)
name|pglobal
decl_stmt|;
name|char
modifier|*
modifier|*
name|pzlog
init|=
operator|(
name|char
operator|*
operator|*
operator|)
name|pvar
decl_stmt|;
name|char
modifier|*
modifier|*
name|pzpass
init|=
operator|(
name|char
operator|*
operator|*
operator|)
name|pinfo
decl_stmt|;
if|if
condition|(
name|argc
operator|<
literal|2
operator|||
name|argc
operator|>
literal|3
condition|)
return|return
name|UUCONF_SYNTAX_ERROR
operator||
name|UUCONF_CMDTABRET_EXIT
return|;
if|if
condition|(
name|pzlog
operator|!=
name|NULL
condition|)
block|{
operator|*
name|pzlog
operator|=
name|strdup
argument_list|(
name|argv
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
operator|*
name|pzlog
operator|==
name|NULL
condition|)
block|{
name|qglobal
operator|->
name|ierrno
operator|=
name|errno
expr_stmt|;
return|return
operator|(
name|UUCONF_MALLOC_FAILED
operator||
name|UUCONF_ERROR_ERRNO
operator||
name|UUCONF_CMDTABRET_EXIT
operator|)
return|;
block|}
block|}
if|if
condition|(
name|pzpass
operator|!=
name|NULL
condition|)
block|{
if|if
condition|(
name|argc
operator|<
literal|3
condition|)
operator|*
name|pzpass
operator|=
name|strdup
argument_list|(
literal|""
argument_list|)
expr_stmt|;
else|else
operator|*
name|pzpass
operator|=
name|strdup
argument_list|(
name|argv
index|[
literal|2
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
operator|*
name|pzpass
operator|==
name|NULL
condition|)
block|{
name|qglobal
operator|->
name|ierrno
operator|=
name|errno
expr_stmt|;
if|if
condition|(
name|pzlog
operator|!=
name|NULL
condition|)
block|{
name|free
argument_list|(
operator|(
name|pointer
operator|)
operator|*
name|pzlog
argument_list|)
expr_stmt|;
operator|*
name|pzlog
operator|=
name|NULL
expr_stmt|;
block|}
return|return
operator|(
name|UUCONF_MALLOC_FAILED
operator||
name|UUCONF_ERROR_ERRNO
operator||
name|UUCONF_CMDTABRET_EXIT
operator|)
return|;
block|}
block|}
return|return
name|UUCONF_CMDTABRET_EXIT
return|;
block|}
end_function

end_unit


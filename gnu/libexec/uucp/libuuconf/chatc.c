begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/* chatc.c    Subroutines to handle chat script commands.     Copyright (C) 1992 Ian Lance Taylor     This file is part of the Taylor UUCP uuconf library.     This library is free software; you can redistribute it and/or    modify it under the terms of the GNU Library General Public License    as published by the Free Software Foundation; either version 2 of    the License, or (at your option) any later version.     This library is distributed in the hope that it will be useful, but    WITHOUT ANY WARRANTY; without even the implied warranty of    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU    Library General Public License for more details.     You should have received a copy of the GNU Library General Public    License along with this library; if not, write to the Free Software    Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.     The author of the program may be contacted at ian@airs.com or    c/o Cygnus Support, 48 Grove Street, Somerville, MA 02144.    */
end_comment

begin_include
include|#
directive|include
file|"uucnfi.h"
end_include

begin_if
if|#
directive|if
name|USE_RCS_ID
end_if

begin_decl_stmt
specifier|const
name|char
name|_uuconf_chatc_rcsid
index|[]
init|=
literal|"$FreeBSD$"
decl_stmt|;
end_decl_stmt

begin_endif
endif|#
directive|endif
end_endif

begin_include
include|#
directive|include
file|<ctype.h>
end_include

begin_include
include|#
directive|include
file|<errno.h>
end_include

begin_escape
end_escape

begin_decl_stmt
specifier|static
name|int
name|icchat
name|P
argument_list|(
operator|(
name|pointer
name|pglobal
operator|,
name|int
name|argc
operator|,
name|char
operator|*
operator|*
name|argv
operator|,
name|pointer
name|pvar
operator|,
name|pointer
name|pinfo
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|icchat_fail
name|P
argument_list|(
operator|(
name|pointer
name|pglobal
operator|,
name|int
name|argc
operator|,
name|char
operator|*
operator|*
name|argv
operator|,
name|pointer
name|pvar
operator|,
name|pointer
name|pinfo
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|icunknown
name|P
argument_list|(
operator|(
name|pointer
name|pglobal
operator|,
name|int
name|argc
operator|,
name|char
operator|*
operator|*
name|argv
operator|,
name|pointer
name|pvar
operator|,
name|pointer
name|pinfo
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_escape
end_escape

begin_comment
comment|/* The chat script commands.  */
end_comment

begin_decl_stmt
specifier|static
specifier|const
name|struct
name|cmdtab_offset
name|asChat_cmds
index|[]
init|=
block|{
block|{
literal|"chat"
block|,
name|UUCONF_CMDTABTYPE_FN
block|,
name|offsetof
argument_list|(
expr|struct
name|uuconf_chat
argument_list|,
name|uuconf_pzchat
argument_list|)
block|,
name|icchat
block|}
block|,
block|{
literal|"chat-program"
block|,
name|UUCONF_CMDTABTYPE_FULLSTRING
block|,
name|offsetof
argument_list|(
expr|struct
name|uuconf_chat
argument_list|,
name|uuconf_pzprogram
argument_list|)
block|,
name|NULL
block|}
block|,
block|{
literal|"chat-timeout"
block|,
name|UUCONF_CMDTABTYPE_INT
block|,
name|offsetof
argument_list|(
expr|struct
name|uuconf_chat
argument_list|,
name|uuconf_ctimeout
argument_list|)
block|,
name|NULL
block|}
block|,
block|{
literal|"chat-fail"
block|,
name|UUCONF_CMDTABTYPE_FN
operator||
literal|2
block|,
name|offsetof
argument_list|(
expr|struct
name|uuconf_chat
argument_list|,
name|uuconf_pzfail
argument_list|)
block|,
name|icchat_fail
block|}
block|,
block|{
literal|"chat-seven-bit"
block|,
name|UUCONF_CMDTABTYPE_BOOLEAN
block|,
name|offsetof
argument_list|(
expr|struct
name|uuconf_chat
argument_list|,
name|uuconf_fstrip
argument_list|)
block|,
name|NULL
block|}
block|,
block|{
name|NULL
block|,
literal|0
block|,
literal|0
block|,
name|NULL
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_define
define|#
directive|define
name|CCHAT_CMDS
value|(sizeof asChat_cmds / sizeof asChat_cmds[0])
end_define

begin_escape
end_escape

begin_comment
comment|/* Handle a chat script command.  The chat script commands are entered    as UUCONF_CMDTABTYPE_PREFIX, and the commands are routed to this    function.  We copy the command table onto the stack and repoint it    at qchat in order to make the function reentrant.  The return value    can include UUCONF_CMDTABRET_KEEP, but should not include    UUCONF_CMDTABRET_EXIT.  */
end_comment

begin_function
name|int
name|_uuconf_ichat_cmd
parameter_list|(
name|qglobal
parameter_list|,
name|argc
parameter_list|,
name|argv
parameter_list|,
name|qchat
parameter_list|,
name|pblock
parameter_list|)
name|struct
name|sglobal
modifier|*
name|qglobal
decl_stmt|;
name|int
name|argc
decl_stmt|;
name|char
modifier|*
modifier|*
name|argv
decl_stmt|;
name|struct
name|uuconf_chat
modifier|*
name|qchat
decl_stmt|;
name|pointer
name|pblock
decl_stmt|;
block|{
name|char
modifier|*
name|zchat
decl_stmt|;
name|struct
name|uuconf_cmdtab
name|as
index|[
name|CCHAT_CMDS
index|]
decl_stmt|;
name|int
name|iret
decl_stmt|;
comment|/* This is only invoked when argv[0] will contain the string "chat";      the specific chat script command comes after that point.  */
for|for
control|(
name|zchat
operator|=
name|argv
index|[
literal|0
index|]
init|;
operator|*
name|zchat
operator|!=
literal|'\0'
condition|;
name|zchat
operator|++
control|)
if|if
condition|(
operator|(
operator|*
name|zchat
operator|==
literal|'c'
operator|||
operator|*
name|zchat
operator|==
literal|'C'
operator|)
operator|&&
name|strncasecmp
argument_list|(
name|zchat
argument_list|,
literal|"chat"
argument_list|,
sizeof|sizeof
expr|"chat"
operator|-
literal|1
argument_list|)
operator|==
literal|0
condition|)
break|break;
if|if
condition|(
operator|*
name|zchat
operator|==
literal|'\0'
condition|)
return|return
name|UUCONF_SYNTAX_ERROR
return|;
name|argv
index|[
literal|0
index|]
operator|=
name|zchat
expr_stmt|;
name|_uuconf_ucmdtab_base
argument_list|(
name|asChat_cmds
argument_list|,
name|CCHAT_CMDS
argument_list|,
operator|(
name|char
operator|*
operator|)
name|qchat
argument_list|,
name|as
argument_list|)
expr_stmt|;
name|iret
operator|=
name|uuconf_cmd_args
argument_list|(
operator|(
name|pointer
operator|)
name|qglobal
argument_list|,
name|argc
argument_list|,
name|argv
argument_list|,
name|as
argument_list|,
name|pblock
argument_list|,
name|icunknown
argument_list|,
literal|0
argument_list|,
name|pblock
argument_list|)
expr_stmt|;
return|return
name|iret
operator|&
operator|~
name|UUCONF_CMDTABRET_EXIT
return|;
block|}
end_function

begin_comment
comment|/* Handle the "chat" command.  This breaks up substrings in expect    strings, and sticks the arguments into a NULL terminated array.  */
end_comment

begin_function
specifier|static
name|int
name|icchat
parameter_list|(
name|pglobal
parameter_list|,
name|argc
parameter_list|,
name|argv
parameter_list|,
name|pvar
parameter_list|,
name|pinfo
parameter_list|)
name|pointer
name|pglobal
decl_stmt|;
name|int
name|argc
decl_stmt|;
name|char
modifier|*
modifier|*
name|argv
decl_stmt|;
name|pointer
name|pvar
decl_stmt|;
name|pointer
name|pinfo
decl_stmt|;
block|{
name|struct
name|sglobal
modifier|*
name|qglobal
init|=
operator|(
expr|struct
name|sglobal
operator|*
operator|)
name|pglobal
decl_stmt|;
name|char
modifier|*
modifier|*
modifier|*
name|ppz
init|=
operator|(
name|char
operator|*
operator|*
operator|*
operator|)
name|pvar
decl_stmt|;
name|pointer
name|pblock
init|=
name|pinfo
decl_stmt|;
name|int
name|i
decl_stmt|;
operator|*
name|ppz
operator|=
name|NULL
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|1
init|;
name|i
operator|<
name|argc
condition|;
name|i
operator|+=
literal|2
control|)
block|{
name|char
modifier|*
name|z
decl_stmt|,
modifier|*
name|zdash
decl_stmt|;
name|int
name|iret
decl_stmt|;
comment|/* Break the expect string into substrings.  */
name|z
operator|=
name|argv
index|[
name|i
index|]
expr_stmt|;
name|zdash
operator|=
name|strchr
argument_list|(
name|z
argument_list|,
literal|'-'
argument_list|)
expr_stmt|;
while|while
condition|(
name|zdash
operator|!=
name|NULL
condition|)
block|{
operator|*
name|zdash
operator|=
literal|'\0'
expr_stmt|;
name|iret
operator|=
name|_uuconf_iadd_string
argument_list|(
name|qglobal
argument_list|,
name|z
argument_list|,
name|TRUE
argument_list|,
name|FALSE
argument_list|,
name|ppz
argument_list|,
name|pblock
argument_list|)
expr_stmt|;
if|if
condition|(
name|iret
operator|!=
name|UUCONF_SUCCESS
condition|)
return|return
name|iret
return|;
operator|*
name|zdash
operator|=
literal|'-'
expr_stmt|;
name|z
operator|=
name|zdash
expr_stmt|;
name|zdash
operator|=
name|strchr
argument_list|(
name|z
operator|+
literal|1
argument_list|,
literal|'-'
argument_list|)
expr_stmt|;
block|}
name|iret
operator|=
name|_uuconf_iadd_string
argument_list|(
name|qglobal
argument_list|,
name|z
argument_list|,
name|FALSE
argument_list|,
name|FALSE
argument_list|,
name|ppz
argument_list|,
name|pblock
argument_list|)
expr_stmt|;
if|if
condition|(
name|iret
operator|!=
name|UUCONF_SUCCESS
condition|)
return|return
name|iret
return|;
comment|/* Add the send string without breaking it up.  If it starts 	 with a dash we must replace it with an escape sequence, to 	 prevent it from being interpreted as a subsend.  */
if|if
condition|(
name|i
operator|+
literal|1
operator|<
name|argc
condition|)
block|{
if|if
condition|(
name|argv
index|[
name|i
operator|+
literal|1
index|]
index|[
literal|0
index|]
operator|!=
literal|'-'
condition|)
name|iret
operator|=
name|_uuconf_iadd_string
argument_list|(
name|qglobal
argument_list|,
name|argv
index|[
name|i
operator|+
literal|1
index|]
argument_list|,
name|FALSE
argument_list|,
name|FALSE
argument_list|,
name|ppz
argument_list|,
name|pblock
argument_list|)
expr_stmt|;
else|else
block|{
name|size_t
name|clen
decl_stmt|;
name|clen
operator|=
name|strlen
argument_list|(
name|argv
index|[
name|i
operator|+
literal|1
index|]
argument_list|)
expr_stmt|;
name|z
operator|=
name|uuconf_malloc
argument_list|(
name|pblock
argument_list|,
name|clen
operator|+
literal|2
argument_list|)
expr_stmt|;
if|if
condition|(
name|z
operator|==
name|NULL
condition|)
block|{
name|qglobal
operator|->
name|ierrno
operator|=
name|errno
expr_stmt|;
return|return
name|UUCONF_MALLOC_FAILED
operator||
name|UUCONF_ERROR_ERRNO
return|;
block|}
name|z
index|[
literal|0
index|]
operator|=
literal|'\\'
expr_stmt|;
name|memcpy
argument_list|(
call|(
name|pointer
call|)
argument_list|(
name|z
operator|+
literal|1
argument_list|)
argument_list|,
operator|(
name|pointer
operator|)
name|argv
index|[
name|i
operator|+
literal|1
index|]
argument_list|,
name|clen
operator|+
literal|1
argument_list|)
expr_stmt|;
name|iret
operator|=
name|_uuconf_iadd_string
argument_list|(
name|qglobal
argument_list|,
name|z
argument_list|,
name|FALSE
argument_list|,
name|FALSE
argument_list|,
name|ppz
argument_list|,
name|pblock
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|iret
operator|!=
name|UUCONF_SUCCESS
condition|)
return|return
name|iret
return|;
block|}
block|}
return|return
name|UUCONF_CMDTABRET_KEEP
return|;
block|}
end_function

begin_comment
comment|/* Add a new chat failure string.  */
end_comment

begin_comment
comment|/*ARGSUSED*/
end_comment

begin_function
specifier|static
name|int
name|icchat_fail
parameter_list|(
name|pglobal
parameter_list|,
name|argc
parameter_list|,
name|argv
parameter_list|,
name|pvar
parameter_list|,
name|pinfo
parameter_list|)
name|pointer
name|pglobal
decl_stmt|;
name|int
name|argc
decl_stmt|;
name|char
modifier|*
modifier|*
name|argv
decl_stmt|;
name|pointer
name|pvar
decl_stmt|;
name|pointer
name|pinfo
decl_stmt|;
block|{
name|struct
name|sglobal
modifier|*
name|qglobal
init|=
operator|(
expr|struct
name|sglobal
operator|*
operator|)
name|pglobal
decl_stmt|;
name|char
modifier|*
modifier|*
modifier|*
name|ppz
init|=
operator|(
name|char
operator|*
operator|*
operator|*
operator|)
name|pvar
decl_stmt|;
name|pointer
name|pblock
init|=
name|pinfo
decl_stmt|;
return|return
name|_uuconf_iadd_string
argument_list|(
name|qglobal
argument_list|,
name|argv
index|[
literal|1
index|]
argument_list|,
name|TRUE
argument_list|,
name|FALSE
argument_list|,
name|ppz
argument_list|,
name|pblock
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/* Return a syntax error for an unknown command.  */
end_comment

begin_comment
comment|/*ARGSUSED*/
end_comment

begin_function
specifier|static
name|int
name|icunknown
parameter_list|(
name|pglobal
parameter_list|,
name|argc
parameter_list|,
name|argv
parameter_list|,
name|pvar
parameter_list|,
name|pinfo
parameter_list|)
name|pointer
name|pglobal
decl_stmt|;
name|int
name|argc
decl_stmt|;
name|char
modifier|*
modifier|*
name|argv
decl_stmt|;
name|pointer
name|pvar
decl_stmt|;
name|pointer
name|pinfo
decl_stmt|;
block|{
return|return
name|UUCONF_SYNTAX_ERROR
return|;
block|}
end_function

end_unit


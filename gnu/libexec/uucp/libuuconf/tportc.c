begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/* tportc.c    Handle a Taylor UUCP port command.     Copyright (C) 1992, 1993 Ian Lance Taylor     This file is part of the Taylor UUCP uuconf library.     This library is free software; you can redistribute it and/or    modify it under the terms of the GNU Library General Public License    as published by the Free Software Foundation; either version 2 of    the License, or (at your option) any later version.     This library is distributed in the hope that it will be useful, but    WITHOUT ANY WARRANTY; without even the implied warranty of    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU    Library General Public License for more details.     You should have received a copy of the GNU Library General Public    License along with this library; if not, write to the Free Software    Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.     The author of the program may be contacted at ian@airs.com or    c/o Cygnus Support, 48 Grove Street, Somerville, MA 02144.    */
end_comment

begin_include
include|#
directive|include
file|"uucnfi.h"
end_include

begin_if
if|#
directive|if
name|USE_RCS_ID
end_if

begin_decl_stmt
specifier|const
name|char
name|_uuconf_tportc_rcsid
index|[]
init|=
literal|"$FreeBSD$"
decl_stmt|;
end_decl_stmt

begin_endif
endif|#
directive|endif
end_endif

begin_include
include|#
directive|include
file|<sys/socket.h>
end_include

begin_include
include|#
directive|include
file|<errno.h>
end_include

begin_escape
end_escape

begin_decl_stmt
specifier|static
name|int
name|ipproto_param
name|P
argument_list|(
operator|(
name|pointer
name|pglobal
operator|,
name|int
name|argc
operator|,
name|char
operator|*
operator|*
name|argv
operator|,
name|pointer
name|pvar
operator|,
name|pointer
name|pinfo
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|ipbaud_range
name|P
argument_list|(
operator|(
name|pointer
name|pglobal
operator|,
name|int
name|argc
operator|,
name|char
operator|*
operator|*
name|argv
operator|,
name|pointer
name|pvar
operator|,
name|pointer
name|pinfo
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|ipdialer
name|P
argument_list|(
operator|(
name|pointer
name|pglobal
operator|,
name|int
name|argc
operator|,
name|char
operator|*
operator|*
name|argv
operator|,
name|pointer
name|pvar
operator|,
name|pointer
name|pinfo
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|ipfamily
name|P
argument_list|(
operator|(
name|pointer
name|pglobal
operator|,
name|int
name|argc
operator|,
name|char
operator|*
operator|*
name|argv
operator|,
name|pointer
name|pvar
operator|,
name|pointer
name|pinfo
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|ipcunknown
name|P
argument_list|(
operator|(
name|pointer
name|pglobal
operator|,
name|int
name|argc
operator|,
name|char
operator|*
operator|*
name|argv
operator|,
name|pointer
name|pvar
operator|,
name|pointer
name|pinfo
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_escape
end_escape

begin_comment
comment|/* The string names of the port types.  This array corresponds to the    uuconf_porttype enumeration.  */
end_comment

begin_decl_stmt
specifier|static
specifier|const
name|char
modifier|*
specifier|const
name|azPtype_names
index|[]
init|=
block|{
name|NULL
block|,
literal|"stdin"
block|,
literal|"modem"
block|,
literal|"direct"
block|,
literal|"tcp"
block|,
literal|"tli"
block|,
literal|"pipe"
block|}
decl_stmt|;
end_decl_stmt

begin_define
define|#
directive|define
name|CPORT_TYPES
value|(sizeof azPtype_names / sizeof azPtype_names[0])
end_define

begin_escape
end_escape

begin_comment
comment|/* The command table for generic port commands.  The "port" and "type"    commands are handled specially.  */
end_comment

begin_decl_stmt
specifier|static
specifier|const
name|struct
name|cmdtab_offset
name|asPort_cmds
index|[]
init|=
block|{
block|{
literal|"protocol"
block|,
name|UUCONF_CMDTABTYPE_STRING
block|,
name|offsetof
argument_list|(
expr|struct
name|uuconf_port
argument_list|,
name|uuconf_zprotocols
argument_list|)
block|,
name|NULL
block|}
block|,
block|{
literal|"protocol-parameter"
block|,
name|UUCONF_CMDTABTYPE_FN
operator||
literal|0
block|,
name|offsetof
argument_list|(
expr|struct
name|uuconf_port
argument_list|,
name|uuconf_qproto_params
argument_list|)
block|,
name|ipproto_param
block|}
block|,
block|{
literal|"seven-bit"
block|,
name|UUCONF_CMDTABTYPE_FN
operator||
literal|2
block|,
name|offsetof
argument_list|(
expr|struct
name|uuconf_port
argument_list|,
name|uuconf_ireliable
argument_list|)
block|,
name|_uuconf_iseven_bit
block|}
block|,
block|{
literal|"reliable"
block|,
name|UUCONF_CMDTABTYPE_FN
operator||
literal|2
block|,
name|offsetof
argument_list|(
expr|struct
name|uuconf_port
argument_list|,
name|uuconf_ireliable
argument_list|)
block|,
name|_uuconf_ireliable
block|}
block|,
block|{
literal|"half-duplex"
block|,
name|UUCONF_CMDTABTYPE_FN
operator||
literal|2
block|,
name|offsetof
argument_list|(
expr|struct
name|uuconf_port
argument_list|,
name|uuconf_ireliable
argument_list|)
block|,
name|_uuconf_ihalf_duplex
block|}
block|,
block|{
literal|"lockname"
block|,
name|UUCONF_CMDTABTYPE_STRING
block|,
name|offsetof
argument_list|(
expr|struct
name|uuconf_port
argument_list|,
name|uuconf_zlockname
argument_list|)
block|,
name|NULL
block|}
block|,
block|{
name|NULL
block|,
literal|0
block|,
literal|0
block|,
name|NULL
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_define
define|#
directive|define
name|CPORT_CMDS
value|(sizeof asPort_cmds / sizeof asPort_cmds[0])
end_define

begin_comment
comment|/* The stdin port command table.  */
end_comment

begin_decl_stmt
specifier|static
specifier|const
name|struct
name|cmdtab_offset
name|asPstdin_cmds
index|[]
init|=
block|{
block|{
name|NULL
block|,
literal|0
block|,
literal|0
block|,
name|NULL
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_define
define|#
directive|define
name|CSTDIN_CMDS
value|(sizeof asPstdin_cmds / sizeof asPstdin_cmds[0])
end_define

begin_comment
comment|/* The modem port command table.  */
end_comment

begin_decl_stmt
specifier|static
specifier|const
name|struct
name|cmdtab_offset
name|asPmodem_cmds
index|[]
init|=
block|{
block|{
literal|"device"
block|,
name|UUCONF_CMDTABTYPE_STRING
block|,
name|offsetof
argument_list|(
expr|struct
name|uuconf_port
argument_list|,
name|uuconf_u
operator|.
name|uuconf_smodem
operator|.
name|uuconf_zdevice
argument_list|)
block|,
name|NULL
block|}
block|,
block|{
literal|"baud"
block|,
name|UUCONF_CMDTABTYPE_LONG
block|,
name|offsetof
argument_list|(
expr|struct
name|uuconf_port
argument_list|,
name|uuconf_u
operator|.
name|uuconf_smodem
operator|.
name|uuconf_ibaud
argument_list|)
block|,
name|NULL
block|}
block|,
block|{
literal|"speed"
block|,
name|UUCONF_CMDTABTYPE_LONG
block|,
name|offsetof
argument_list|(
expr|struct
name|uuconf_port
argument_list|,
name|uuconf_u
operator|.
name|uuconf_smodem
operator|.
name|uuconf_ibaud
argument_list|)
block|,
name|NULL
block|}
block|,
block|{
literal|"baud-range"
block|,
name|UUCONF_CMDTABTYPE_FN
operator||
literal|3
block|,
name|offsetof
argument_list|(
expr|struct
name|uuconf_port
argument_list|,
name|uuconf_u
operator|.
name|uuconf_smodem
argument_list|)
block|,
name|ipbaud_range
block|}
block|,
block|{
literal|"speed-range"
block|,
name|UUCONF_CMDTABTYPE_FN
operator||
literal|3
block|,
name|offsetof
argument_list|(
expr|struct
name|uuconf_port
argument_list|,
name|uuconf_u
operator|.
name|uuconf_smodem
argument_list|)
block|,
name|ipbaud_range
block|}
block|,
block|{
literal|"carrier"
block|,
name|UUCONF_CMDTABTYPE_BOOLEAN
block|,
name|offsetof
argument_list|(
expr|struct
name|uuconf_port
argument_list|,
name|uuconf_u
operator|.
name|uuconf_smodem
operator|.
name|uuconf_fcarrier
argument_list|)
block|,
name|NULL
block|}
block|,
block|{
literal|"hardflow"
block|,
name|UUCONF_CMDTABTYPE_BOOLEAN
block|,
name|offsetof
argument_list|(
expr|struct
name|uuconf_port
argument_list|,
name|uuconf_u
operator|.
name|uuconf_smodem
operator|.
name|uuconf_fhardflow
argument_list|)
block|,
name|NULL
block|}
block|,
block|{
literal|"dial-device"
block|,
name|UUCONF_CMDTABTYPE_STRING
block|,
name|offsetof
argument_list|(
expr|struct
name|uuconf_port
argument_list|,
name|uuconf_u
operator|.
name|uuconf_smodem
operator|.
name|uuconf_zdial_device
argument_list|)
block|,
name|NULL
block|}
block|,
block|{
literal|"dialer"
block|,
name|UUCONF_CMDTABTYPE_FN
operator||
literal|0
block|,
name|offsetof
argument_list|(
expr|struct
name|uuconf_port
argument_list|,
name|uuconf_u
operator|.
name|uuconf_smodem
argument_list|)
block|,
name|ipdialer
block|}
block|,
block|{
literal|"dialer-sequence"
block|,
name|UUCONF_CMDTABTYPE_FULLSTRING
block|,
name|offsetof
argument_list|(
expr|struct
name|uuconf_port
argument_list|,
name|uuconf_u
operator|.
name|uuconf_smodem
operator|.
name|uuconf_pzdialer
argument_list|)
block|,
name|NULL
block|}
block|,
block|{
name|NULL
block|,
literal|0
block|,
literal|0
block|,
name|NULL
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_define
define|#
directive|define
name|CMODEM_CMDS
value|(sizeof asPmodem_cmds / sizeof asPmodem_cmds[0])
end_define

begin_comment
comment|/* The direct port command table.  */
end_comment

begin_decl_stmt
specifier|static
specifier|const
name|struct
name|cmdtab_offset
name|asPdirect_cmds
index|[]
init|=
block|{
block|{
literal|"device"
block|,
name|UUCONF_CMDTABTYPE_STRING
block|,
name|offsetof
argument_list|(
expr|struct
name|uuconf_port
argument_list|,
name|uuconf_u
operator|.
name|uuconf_sdirect
operator|.
name|uuconf_zdevice
argument_list|)
block|,
name|NULL
block|}
block|,
block|{
literal|"baud"
block|,
name|UUCONF_CMDTABTYPE_LONG
block|,
name|offsetof
argument_list|(
expr|struct
name|uuconf_port
argument_list|,
name|uuconf_u
operator|.
name|uuconf_sdirect
operator|.
name|uuconf_ibaud
argument_list|)
block|,
name|NULL
block|}
block|,
block|{
literal|"speed"
block|,
name|UUCONF_CMDTABTYPE_LONG
block|,
name|offsetof
argument_list|(
expr|struct
name|uuconf_port
argument_list|,
name|uuconf_u
operator|.
name|uuconf_sdirect
operator|.
name|uuconf_ibaud
argument_list|)
block|,
name|NULL
block|}
block|,
block|{
literal|"carrier"
block|,
name|UUCONF_CMDTABTYPE_BOOLEAN
block|,
name|offsetof
argument_list|(
expr|struct
name|uuconf_port
argument_list|,
name|uuconf_u
operator|.
name|uuconf_sdirect
operator|.
name|uuconf_fcarrier
argument_list|)
block|,
name|NULL
block|}
block|,
block|{
literal|"hardflow"
block|,
name|UUCONF_CMDTABTYPE_BOOLEAN
block|,
name|offsetof
argument_list|(
expr|struct
name|uuconf_port
argument_list|,
name|uuconf_u
operator|.
name|uuconf_sdirect
operator|.
name|uuconf_fhardflow
argument_list|)
block|,
name|NULL
block|}
block|,
block|{
name|NULL
block|,
literal|0
block|,
literal|0
block|,
name|NULL
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_define
define|#
directive|define
name|CDIRECT_CMDS
value|(sizeof asPdirect_cmds / sizeof asPdirect_cmds[0])
end_define

begin_comment
comment|/* The TCP port command table.  */
end_comment

begin_decl_stmt
specifier|static
specifier|const
name|struct
name|cmdtab_offset
name|asPtcp_cmds
index|[]
init|=
block|{
block|{
literal|"service"
block|,
name|UUCONF_CMDTABTYPE_STRING
block|,
name|offsetof
argument_list|(
expr|struct
name|uuconf_port
argument_list|,
name|uuconf_u
operator|.
name|uuconf_stcp
operator|.
name|uuconf_zport
argument_list|)
block|,
name|NULL
block|}
block|,
block|{
literal|"family"
block|,
name|UUCONF_CMDTABTYPE_FN
operator||
literal|0
block|,
name|offsetof
argument_list|(
expr|struct
name|uuconf_port
argument_list|,
name|uuconf_u
operator|.
name|uuconf_stcp
operator|.
name|uuconf_zfamily
argument_list|)
block|,
name|ipfamily
block|}
block|,
block|{
literal|"dialer-sequence"
block|,
name|UUCONF_CMDTABTYPE_FULLSTRING
block|,
name|offsetof
argument_list|(
expr|struct
name|uuconf_port
argument_list|,
name|uuconf_u
operator|.
name|uuconf_stcp
operator|.
name|uuconf_pzdialer
argument_list|)
block|,
name|NULL
block|}
block|,
block|{
name|NULL
block|,
literal|0
block|,
literal|0
block|,
name|NULL
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_define
define|#
directive|define
name|CTCP_CMDS
value|(sizeof asPtcp_cmds / sizeof asPtcp_cmds[0])
end_define

begin_comment
comment|/* The TLI port command table.  */
end_comment

begin_decl_stmt
specifier|static
specifier|const
name|struct
name|cmdtab_offset
name|asPtli_cmds
index|[]
init|=
block|{
block|{
literal|"device"
block|,
name|UUCONF_CMDTABTYPE_STRING
block|,
name|offsetof
argument_list|(
expr|struct
name|uuconf_port
argument_list|,
name|uuconf_u
operator|.
name|uuconf_stli
operator|.
name|uuconf_zdevice
argument_list|)
block|,
name|NULL
block|}
block|,
block|{
literal|"stream"
block|,
name|UUCONF_CMDTABTYPE_BOOLEAN
block|,
name|offsetof
argument_list|(
expr|struct
name|uuconf_port
argument_list|,
name|uuconf_u
operator|.
name|uuconf_stli
operator|.
name|uuconf_fstream
argument_list|)
block|,
name|NULL
block|}
block|,
block|{
literal|"push"
block|,
name|UUCONF_CMDTABTYPE_FULLSTRING
block|,
name|offsetof
argument_list|(
expr|struct
name|uuconf_port
argument_list|,
name|uuconf_u
operator|.
name|uuconf_stli
operator|.
name|uuconf_pzpush
argument_list|)
block|,
name|NULL
block|}
block|,
block|{
literal|"dialer-sequence"
block|,
name|UUCONF_CMDTABTYPE_FULLSTRING
block|,
name|offsetof
argument_list|(
expr|struct
name|uuconf_port
argument_list|,
name|uuconf_u
operator|.
name|uuconf_stli
operator|.
name|uuconf_pzdialer
argument_list|)
block|,
name|NULL
block|}
block|,
block|{
literal|"server-address"
block|,
name|UUCONF_CMDTABTYPE_STRING
block|,
name|offsetof
argument_list|(
expr|struct
name|uuconf_port
argument_list|,
name|uuconf_u
operator|.
name|uuconf_stli
operator|.
name|uuconf_zservaddr
argument_list|)
block|,
name|NULL
block|}
block|,
block|{
name|NULL
block|,
literal|0
block|,
literal|0
block|,
name|NULL
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_define
define|#
directive|define
name|CTLI_CMDS
value|(sizeof asPtli_cmds / sizeof asPtli_cmds[0])
end_define

begin_comment
comment|/* The pipe port command table.  */
end_comment

begin_decl_stmt
specifier|static
specifier|const
name|struct
name|cmdtab_offset
name|asPpipe_cmds
index|[]
init|=
block|{
block|{
literal|"command"
block|,
name|UUCONF_CMDTABTYPE_FULLSTRING
block|,
name|offsetof
argument_list|(
expr|struct
name|uuconf_port
argument_list|,
name|uuconf_u
operator|.
name|uuconf_spipe
operator|.
name|uuconf_pzcmd
argument_list|)
block|,
name|NULL
block|}
block|,
block|{
name|NULL
block|,
literal|0
block|,
literal|0
block|,
name|NULL
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_define
define|#
directive|define
name|CPIPE_CMDS
value|(sizeof asPpipe_cmds / sizeof asPpipe_cmds[0])
end_define

begin_undef
undef|#
directive|undef
name|max
end_undef

begin_define
define|#
directive|define
name|max
parameter_list|(
name|i1
parameter_list|,
name|i2
parameter_list|)
value|((i1)> (i2) ? (i1) : (i2))
end_define

begin_define
define|#
directive|define
name|CCMDS
define|\
value|max (max (max (CPORT_CMDS, CSTDIN_CMDS), CMODEM_CMDS), \        max (max (CDIRECT_CMDS, CTCP_CMDS), max (CTLI_CMDS, CPIPE_CMDS)))
end_define

begin_escape
end_escape

begin_comment
comment|/* Handle a command passed to a port from a Taylor UUCP configuration    file.  This can be called when reading either the port file or the    sys file.  The return value may have UUCONF_CMDTABRET_KEEP set, but    not UUCONF_CMDTABRET_EXIT.  It assigns values to the elements of    qport.  The first time this is called, qport->uuconf_zname and    qport->uuconf_palloc should be set and qport->uuconf_ttype should    be UUCONF_PORTTYPE_UNKNOWN.  */
end_comment

begin_function
name|int
name|_uuconf_iport_cmd
parameter_list|(
name|qglobal
parameter_list|,
name|argc
parameter_list|,
name|argv
parameter_list|,
name|qport
parameter_list|)
name|struct
name|sglobal
modifier|*
name|qglobal
decl_stmt|;
name|int
name|argc
decl_stmt|;
name|char
modifier|*
modifier|*
name|argv
decl_stmt|;
name|struct
name|uuconf_port
modifier|*
name|qport
decl_stmt|;
block|{
name|boolean
name|fgottype
decl_stmt|;
specifier|const
name|struct
name|cmdtab_offset
modifier|*
name|qcmds
decl_stmt|;
name|size_t
name|ccmds
decl_stmt|;
name|struct
name|uuconf_cmdtab
name|as
index|[
name|CCMDS
index|]
decl_stmt|;
name|int
name|i
decl_stmt|;
name|int
name|iret
decl_stmt|;
name|fgottype
operator|=
name|strcasecmp
argument_list|(
name|argv
index|[
literal|0
index|]
argument_list|,
literal|"type"
argument_list|)
operator|==
literal|0
expr_stmt|;
if|if
condition|(
name|fgottype
operator|||
name|qport
operator|->
name|uuconf_ttype
operator|==
name|UUCONF_PORTTYPE_UNKNOWN
condition|)
block|{
name|enum
name|uuconf_porttype
name|ttype
decl_stmt|;
comment|/* We either just got a "type" command, or this is an 	 uninitialized port.  If the first command to a port is not 	 "type", it is assumed to be a modem port.  This 	 implementation will actually permit "type" at any point, but 	 will effectively discard any type specific information that 	 appears before the "type" command.  This supports defaults, 	 in that the default may be of a specific type while future 	 ports in the same file may be of other types.  */
if|if
condition|(
operator|!
name|fgottype
condition|)
name|ttype
operator|=
name|UUCONF_PORTTYPE_MODEM
expr_stmt|;
else|else
block|{
if|if
condition|(
name|argc
operator|!=
literal|2
condition|)
return|return
name|UUCONF_SYNTAX_ERROR
return|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|CPORT_TYPES
condition|;
name|i
operator|++
control|)
if|if
condition|(
name|azPtype_names
index|[
name|i
index|]
operator|!=
name|NULL
operator|&&
name|strcasecmp
argument_list|(
name|argv
index|[
literal|1
index|]
argument_list|,
name|azPtype_names
index|[
name|i
index|]
argument_list|)
operator|==
literal|0
condition|)
break|break;
if|if
condition|(
name|i
operator|>=
name|CPORT_TYPES
condition|)
return|return
name|UUCONF_SYNTAX_ERROR
return|;
name|ttype
operator|=
operator|(
expr|enum
name|uuconf_porttype
operator|)
name|i
expr_stmt|;
block|}
name|qport
operator|->
name|uuconf_ttype
operator|=
name|ttype
expr_stmt|;
switch|switch
condition|(
name|ttype
condition|)
block|{
default|default:
case|case
name|UUCONF_PORTTYPE_STDIN
case|:
break|break;
case|case
name|UUCONF_PORTTYPE_MODEM
case|:
name|qport
operator|->
name|uuconf_u
operator|.
name|uuconf_smodem
operator|.
name|uuconf_zdevice
operator|=
name|NULL
expr_stmt|;
name|qport
operator|->
name|uuconf_u
operator|.
name|uuconf_smodem
operator|.
name|uuconf_zdial_device
operator|=
name|NULL
expr_stmt|;
name|qport
operator|->
name|uuconf_u
operator|.
name|uuconf_smodem
operator|.
name|uuconf_ibaud
operator|=
literal|0L
expr_stmt|;
name|qport
operator|->
name|uuconf_u
operator|.
name|uuconf_smodem
operator|.
name|uuconf_ilowbaud
operator|=
literal|0L
expr_stmt|;
name|qport
operator|->
name|uuconf_u
operator|.
name|uuconf_smodem
operator|.
name|uuconf_ihighbaud
operator|=
literal|0L
expr_stmt|;
name|qport
operator|->
name|uuconf_u
operator|.
name|uuconf_smodem
operator|.
name|uuconf_fcarrier
operator|=
name|TRUE
expr_stmt|;
name|qport
operator|->
name|uuconf_u
operator|.
name|uuconf_smodem
operator|.
name|uuconf_fhardflow
operator|=
name|TRUE
expr_stmt|;
name|qport
operator|->
name|uuconf_u
operator|.
name|uuconf_smodem
operator|.
name|uuconf_pzdialer
operator|=
name|NULL
expr_stmt|;
name|qport
operator|->
name|uuconf_u
operator|.
name|uuconf_smodem
operator|.
name|uuconf_qdialer
operator|=
name|NULL
expr_stmt|;
break|break;
case|case
name|UUCONF_PORTTYPE_DIRECT
case|:
name|qport
operator|->
name|uuconf_u
operator|.
name|uuconf_sdirect
operator|.
name|uuconf_zdevice
operator|=
name|NULL
expr_stmt|;
name|qport
operator|->
name|uuconf_u
operator|.
name|uuconf_sdirect
operator|.
name|uuconf_ibaud
operator|=
operator|-
literal|1
expr_stmt|;
name|qport
operator|->
name|uuconf_u
operator|.
name|uuconf_sdirect
operator|.
name|uuconf_fcarrier
operator|=
name|FALSE
expr_stmt|;
name|qport
operator|->
name|uuconf_u
operator|.
name|uuconf_sdirect
operator|.
name|uuconf_fhardflow
operator|=
name|TRUE
expr_stmt|;
break|break;
case|case
name|UUCONF_PORTTYPE_TCP
case|:
name|qport
operator|->
name|uuconf_u
operator|.
name|uuconf_stcp
operator|.
name|uuconf_zport
operator|=
operator|(
name|char
operator|*
operator|)
literal|"uucp"
expr_stmt|;
name|qport
operator|->
name|uuconf_u
operator|.
name|uuconf_stcp
operator|.
name|uuconf_zfamily
operator|=
name|PF_UNSPEC
expr_stmt|;
name|qport
operator|->
name|uuconf_u
operator|.
name|uuconf_stcp
operator|.
name|uuconf_pzdialer
operator|=
name|NULL
expr_stmt|;
name|qport
operator|->
name|uuconf_ireliable
operator|=
operator|(
name|UUCONF_RELIABLE_SPECIFIED
operator||
name|UUCONF_RELIABLE_ENDTOEND
operator||
name|UUCONF_RELIABLE_RELIABLE
operator||
name|UUCONF_RELIABLE_EIGHT
operator||
name|UUCONF_RELIABLE_FULLDUPLEX
operator|)
expr_stmt|;
break|break;
case|case
name|UUCONF_PORTTYPE_TLI
case|:
name|qport
operator|->
name|uuconf_u
operator|.
name|uuconf_stli
operator|.
name|uuconf_zdevice
operator|=
name|NULL
expr_stmt|;
name|qport
operator|->
name|uuconf_u
operator|.
name|uuconf_stli
operator|.
name|uuconf_fstream
operator|=
name|FALSE
expr_stmt|;
name|qport
operator|->
name|uuconf_u
operator|.
name|uuconf_stli
operator|.
name|uuconf_pzpush
operator|=
name|NULL
expr_stmt|;
name|qport
operator|->
name|uuconf_u
operator|.
name|uuconf_stli
operator|.
name|uuconf_pzdialer
operator|=
name|NULL
expr_stmt|;
name|qport
operator|->
name|uuconf_u
operator|.
name|uuconf_stli
operator|.
name|uuconf_zservaddr
operator|=
name|NULL
expr_stmt|;
name|qport
operator|->
name|uuconf_ireliable
operator|=
operator|(
name|UUCONF_RELIABLE_SPECIFIED
operator||
name|UUCONF_RELIABLE_ENDTOEND
operator||
name|UUCONF_RELIABLE_RELIABLE
operator||
name|UUCONF_RELIABLE_EIGHT
operator||
name|UUCONF_RELIABLE_FULLDUPLEX
operator|)
expr_stmt|;
break|break;
case|case
name|UUCONF_PORTTYPE_PIPE
case|:
name|qport
operator|->
name|uuconf_u
operator|.
name|uuconf_spipe
operator|.
name|uuconf_pzcmd
operator|=
name|NULL
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|fgottype
condition|)
return|return
name|UUCONF_CMDTABRET_CONTINUE
return|;
block|}
comment|/* See if this command is one of the generic ones.  */
name|qcmds
operator|=
name|asPort_cmds
expr_stmt|;
name|ccmds
operator|=
name|CPORT_CMDS
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|CPORT_CMDS
operator|-
literal|1
condition|;
name|i
operator|++
control|)
if|if
condition|(
name|strcasecmp
argument_list|(
name|argv
index|[
literal|0
index|]
argument_list|,
name|asPort_cmds
index|[
name|i
index|]
operator|.
name|zcmd
argument_list|)
operator|==
literal|0
condition|)
break|break;
if|if
condition|(
name|i
operator|>=
name|CPORT_CMDS
operator|-
literal|1
condition|)
block|{
comment|/* It's not a generic command, so we must check the type 	 specific commands.  */
switch|switch
condition|(
name|qport
operator|->
name|uuconf_ttype
condition|)
block|{
case|case
name|UUCONF_PORTTYPE_STDIN
case|:
name|qcmds
operator|=
name|asPstdin_cmds
expr_stmt|;
name|ccmds
operator|=
name|CSTDIN_CMDS
expr_stmt|;
break|break;
case|case
name|UUCONF_PORTTYPE_MODEM
case|:
name|qcmds
operator|=
name|asPmodem_cmds
expr_stmt|;
name|ccmds
operator|=
name|CMODEM_CMDS
expr_stmt|;
break|break;
case|case
name|UUCONF_PORTTYPE_DIRECT
case|:
name|qcmds
operator|=
name|asPdirect_cmds
expr_stmt|;
name|ccmds
operator|=
name|CDIRECT_CMDS
expr_stmt|;
break|break;
case|case
name|UUCONF_PORTTYPE_TCP
case|:
name|qcmds
operator|=
name|asPtcp_cmds
expr_stmt|;
name|ccmds
operator|=
name|CTCP_CMDS
expr_stmt|;
break|break;
case|case
name|UUCONF_PORTTYPE_TLI
case|:
name|qcmds
operator|=
name|asPtli_cmds
expr_stmt|;
name|ccmds
operator|=
name|CTLI_CMDS
expr_stmt|;
break|break;
case|case
name|UUCONF_PORTTYPE_PIPE
case|:
name|qcmds
operator|=
name|asPpipe_cmds
expr_stmt|;
name|ccmds
operator|=
name|CPIPE_CMDS
expr_stmt|;
break|break;
default|default:
return|return
name|UUCONF_SYNTAX_ERROR
return|;
block|}
block|}
comment|/* Copy the command table onto the stack and modify it to point to      qport.  */
name|_uuconf_ucmdtab_base
argument_list|(
name|qcmds
argument_list|,
name|ccmds
argument_list|,
operator|(
name|char
operator|*
operator|)
name|qport
argument_list|,
name|as
argument_list|)
expr_stmt|;
name|iret
operator|=
name|uuconf_cmd_args
argument_list|(
operator|(
name|pointer
operator|)
name|qglobal
argument_list|,
name|argc
argument_list|,
name|argv
argument_list|,
name|as
argument_list|,
operator|(
name|pointer
operator|)
name|qport
argument_list|,
name|ipcunknown
argument_list|,
literal|0
argument_list|,
name|qport
operator|->
name|uuconf_palloc
argument_list|)
expr_stmt|;
return|return
name|iret
operator|&
operator|~
name|UUCONF_CMDTABRET_EXIT
return|;
block|}
end_function

begin_escape
end_escape

begin_comment
comment|/* Handle the "protocol-parameter" command.  */
end_comment

begin_function
specifier|static
name|int
name|ipproto_param
parameter_list|(
name|pglobal
parameter_list|,
name|argc
parameter_list|,
name|argv
parameter_list|,
name|pvar
parameter_list|,
name|pinfo
parameter_list|)
name|pointer
name|pglobal
decl_stmt|;
name|int
name|argc
decl_stmt|;
name|char
modifier|*
modifier|*
name|argv
decl_stmt|;
name|pointer
name|pvar
decl_stmt|;
name|pointer
name|pinfo
decl_stmt|;
block|{
name|struct
name|sglobal
modifier|*
name|qglobal
init|=
operator|(
expr|struct
name|sglobal
operator|*
operator|)
name|pglobal
decl_stmt|;
name|struct
name|uuconf_proto_param
modifier|*
modifier|*
name|pqparam
init|=
operator|(
expr|struct
name|uuconf_proto_param
operator|*
operator|*
operator|)
name|pvar
decl_stmt|;
name|struct
name|uuconf_port
modifier|*
name|qport
init|=
operator|(
expr|struct
name|uuconf_port
operator|*
operator|)
name|pinfo
decl_stmt|;
return|return
name|_uuconf_iadd_proto_param
argument_list|(
name|qglobal
argument_list|,
name|argc
operator|-
literal|1
argument_list|,
name|argv
operator|+
literal|1
argument_list|,
name|pqparam
argument_list|,
name|qport
operator|->
name|uuconf_palloc
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/* Handle the "baud-range" command.  */
end_comment

begin_comment
comment|/*ARGSUSED*/
end_comment

begin_function
specifier|static
name|int
name|ipbaud_range
parameter_list|(
name|pglobal
parameter_list|,
name|argc
parameter_list|,
name|argv
parameter_list|,
name|pvar
parameter_list|,
name|pinfo
parameter_list|)
name|pointer
name|pglobal
decl_stmt|;
name|int
name|argc
decl_stmt|;
name|char
modifier|*
modifier|*
name|argv
decl_stmt|;
name|pointer
name|pvar
decl_stmt|;
name|pointer
name|pinfo
decl_stmt|;
block|{
name|struct
name|sglobal
modifier|*
name|qglobal
init|=
operator|(
expr|struct
name|sglobal
operator|*
operator|)
name|pglobal
decl_stmt|;
name|struct
name|uuconf_modem_port
modifier|*
name|qmodem
init|=
operator|(
expr|struct
name|uuconf_modem_port
operator|*
operator|)
name|pvar
decl_stmt|;
name|int
name|iret
decl_stmt|;
name|iret
operator|=
name|_uuconf_iint
argument_list|(
name|qglobal
argument_list|,
name|argv
index|[
literal|1
index|]
argument_list|,
operator|(
name|pointer
operator|)
operator|&
name|qmodem
operator|->
name|uuconf_ilowbaud
argument_list|,
name|FALSE
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|iret
operator|&
operator|~
name|UUCONF_CMDTABRET_KEEP
operator|)
operator|!=
name|UUCONF_SUCCESS
condition|)
return|return
name|iret
return|;
name|iret
operator||=
name|_uuconf_iint
argument_list|(
name|qglobal
argument_list|,
name|argv
index|[
literal|2
index|]
argument_list|,
operator|(
name|pointer
operator|)
operator|&
name|qmodem
operator|->
name|uuconf_ihighbaud
argument_list|,
name|FALSE
argument_list|)
expr_stmt|;
return|return
name|iret
return|;
block|}
end_function

begin_escape
end_escape

begin_comment
comment|/* Handle the "dialer" command.  If there is one argument, this names    a dialer.  Otherwise, the remaining arguments form a command    describing the dialer.  */
end_comment

begin_function
specifier|static
name|int
name|ipdialer
parameter_list|(
name|pglobal
parameter_list|,
name|argc
parameter_list|,
name|argv
parameter_list|,
name|pvar
parameter_list|,
name|pinfo
parameter_list|)
name|pointer
name|pglobal
decl_stmt|;
name|int
name|argc
decl_stmt|;
name|char
modifier|*
modifier|*
name|argv
decl_stmt|;
name|pointer
name|pvar
decl_stmt|;
name|pointer
name|pinfo
decl_stmt|;
block|{
name|struct
name|sglobal
modifier|*
name|qglobal
init|=
operator|(
expr|struct
name|sglobal
operator|*
operator|)
name|pglobal
decl_stmt|;
name|struct
name|uuconf_modem_port
modifier|*
name|qmodem
init|=
operator|(
expr|struct
name|uuconf_modem_port
operator|*
operator|)
name|pvar
decl_stmt|;
name|struct
name|uuconf_port
modifier|*
name|qport
init|=
operator|(
expr|struct
name|uuconf_port
operator|*
operator|)
name|pinfo
decl_stmt|;
name|int
name|iret
decl_stmt|;
if|if
condition|(
name|argc
operator|<
literal|2
condition|)
return|return
name|UUCONF_SYNTAX_ERROR
operator||
name|UUCONF_CMDTABRET_EXIT
return|;
if|if
condition|(
name|argc
operator|>
literal|2
condition|)
block|{
if|if
condition|(
name|qmodem
operator|->
name|uuconf_qdialer
operator|==
name|NULL
condition|)
block|{
name|struct
name|uuconf_dialer
modifier|*
name|qnew
decl_stmt|;
name|size_t
name|clen
decl_stmt|;
name|qnew
operator|=
operator|(
operator|(
expr|struct
name|uuconf_dialer
operator|*
operator|)
name|uuconf_malloc
argument_list|(
name|qport
operator|->
name|uuconf_palloc
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|uuconf_dialer
argument_list|)
argument_list|)
operator|)
expr_stmt|;
if|if
condition|(
name|qnew
operator|==
name|NULL
condition|)
block|{
name|qglobal
operator|->
name|ierrno
operator|=
name|errno
expr_stmt|;
return|return
operator|(
name|UUCONF_MALLOC_FAILED
operator||
name|UUCONF_ERROR_ERRNO
operator||
name|UUCONF_CMDTABRET_EXIT
operator|)
return|;
block|}
name|_uuconf_uclear_dialer
argument_list|(
name|qnew
argument_list|)
expr_stmt|;
if|if
condition|(
name|qport
operator|->
name|uuconf_zname
operator|==
name|NULL
condition|)
name|qnew
operator|->
name|uuconf_zname
operator|=
operator|(
name|char
operator|*
operator|)
literal|"default port file dialer"
expr_stmt|;
else|else
block|{
name|clen
operator|=
name|strlen
argument_list|(
name|qport
operator|->
name|uuconf_zname
argument_list|)
expr_stmt|;
name|qnew
operator|->
name|uuconf_zname
operator|=
operator|(
name|char
operator|*
operator|)
name|uuconf_malloc
argument_list|(
name|qport
operator|->
name|uuconf_palloc
argument_list|,
name|clen
operator|+
sizeof|sizeof
expr|" dialer"
argument_list|)
expr_stmt|;
if|if
condition|(
name|qnew
operator|->
name|uuconf_zname
operator|==
name|NULL
condition|)
block|{
name|qglobal
operator|->
name|ierrno
operator|=
name|errno
expr_stmt|;
return|return
operator|(
name|UUCONF_MALLOC_FAILED
operator||
name|UUCONF_ERROR_ERRNO
operator||
name|UUCONF_CMDTABRET_EXIT
operator|)
return|;
block|}
name|memcpy
argument_list|(
operator|(
name|pointer
operator|)
name|qnew
operator|->
name|uuconf_zname
argument_list|,
operator|(
name|pointer
operator|)
name|qport
operator|->
name|uuconf_zname
argument_list|,
name|clen
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
call|(
name|pointer
call|)
argument_list|(
name|qnew
operator|->
name|uuconf_zname
operator|+
name|clen
argument_list|)
argument_list|,
operator|(
name|pointer
operator|)
literal|" dialer"
argument_list|,
sizeof|sizeof
expr|" dialer"
argument_list|)
expr_stmt|;
block|}
name|qnew
operator|->
name|uuconf_palloc
operator|=
name|qport
operator|->
name|uuconf_palloc
expr_stmt|;
name|qmodem
operator|->
name|uuconf_qdialer
operator|=
name|qnew
expr_stmt|;
block|}
name|iret
operator|=
name|_uuconf_idialer_cmd
argument_list|(
name|qglobal
argument_list|,
name|argc
operator|-
literal|1
argument_list|,
name|argv
operator|+
literal|1
argument_list|,
name|qmodem
operator|->
name|uuconf_qdialer
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|iret
operator|&
operator|~
name|UUCONF_CMDTABRET_KEEP
operator|)
operator|!=
name|UUCONF_SUCCESS
condition|)
name|iret
operator||=
name|UUCONF_CMDTABRET_EXIT
expr_stmt|;
return|return
name|iret
return|;
block|}
else|else
block|{
name|qmodem
operator|->
name|uuconf_pzdialer
operator|=
name|NULL
expr_stmt|;
name|iret
operator|=
name|_uuconf_iadd_string
argument_list|(
name|qglobal
argument_list|,
name|argv
index|[
literal|1
index|]
argument_list|,
name|TRUE
argument_list|,
name|FALSE
argument_list|,
operator|&
name|qmodem
operator|->
name|uuconf_pzdialer
argument_list|,
name|qport
operator|->
name|uuconf_palloc
argument_list|)
expr_stmt|;
if|if
condition|(
name|iret
operator|!=
name|UUCONF_SUCCESS
condition|)
name|iret
operator||=
name|UUCONF_CMDTABRET_EXIT
expr_stmt|;
return|return
name|iret
return|;
block|}
block|}
end_function

begin_escape
end_escape

begin_comment
comment|/* Handle a "family" commands.  The first argument is "inet" for    PF_INET or "inet6" for PF_INET6 */
end_comment

begin_comment
comment|/*ARGSUSED*/
end_comment

begin_function
specifier|static
name|int
name|ipfamily
parameter_list|(
name|pglobal
parameter_list|,
name|argc
parameter_list|,
name|argv
parameter_list|,
name|pvar
parameter_list|,
name|pinfo
parameter_list|)
name|pointer
name|pglobal
decl_stmt|;
name|int
name|argc
decl_stmt|;
name|char
modifier|*
modifier|*
name|argv
decl_stmt|;
name|pointer
name|pvar
decl_stmt|;
name|pointer
name|pinfo
decl_stmt|;
block|{
name|int
modifier|*
name|pzfamily
init|=
operator|(
name|int
operator|*
operator|)
name|pvar
decl_stmt|;
if|if
condition|(
name|argc
operator|<
literal|2
condition|)
return|return
name|UUCONF_SYNTAX_ERROR
operator||
name|UUCONF_CMDTABRET_EXIT
return|;
if|if
condition|(
operator|!
name|strcmp
argument_list|(
name|argv
index|[
literal|1
index|]
argument_list|,
literal|"inet"
argument_list|)
condition|)
operator|*
name|pzfamily
operator|=
name|PF_INET
expr_stmt|;
if|#
directive|if
name|HAVE_GETADDRINFO
elseif|else
if|if
condition|(
operator|!
name|strcmp
argument_list|(
name|argv
index|[
literal|1
index|]
argument_list|,
literal|"inet6"
argument_list|)
condition|)
operator|*
name|pzfamily
operator|=
name|PF_INET6
expr_stmt|;
endif|#
directive|endif
elseif|else
if|if
condition|(
operator|!
name|strcmp
argument_list|(
name|argv
index|[
literal|1
index|]
argument_list|,
literal|"inet46"
argument_list|)
condition|)
operator|*
name|pzfamily
operator|=
name|PF_UNSPEC
expr_stmt|;
else|else
return|return
name|UUCONF_SYNTAX_ERROR
operator||
name|UUCONF_CMDTABRET_EXIT
return|;
return|return
name|UUCONF_CMDTABRET_KEEP
return|;
block|}
end_function

begin_comment
comment|/* Give an error for an unknown port command.  */
end_comment

begin_comment
comment|/*ARGSUSED*/
end_comment

begin_function
specifier|static
name|int
name|ipcunknown
parameter_list|(
name|pglobal
parameter_list|,
name|argc
parameter_list|,
name|argv
parameter_list|,
name|pvar
parameter_list|,
name|pinfo
parameter_list|)
name|pointer
name|pglobal
decl_stmt|;
name|int
name|argc
decl_stmt|;
name|char
modifier|*
modifier|*
name|argv
decl_stmt|;
name|pointer
name|pvar
decl_stmt|;
name|pointer
name|pinfo
decl_stmt|;
block|{
return|return
name|UUCONF_SYNTAX_ERROR
operator||
name|UUCONF_CMDTABRET_EXIT
return|;
block|}
end_function

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/* uustat.c    UUCP status program     Copyright (C) 1991, 1992, 1993, 1994, 1995 Ian Lance Taylor     This file is part of the Taylor UUCP package.     This program is free software; you can redistribute it and/or    modify it under the terms of the GNU General Public License as    published by the Free Software Foundation; either version 2 of the    License, or (at your option) any later version.     This program is distributed in the hope that it will be useful, but    WITHOUT ANY WARRANTY; without even the implied warranty of    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU    General Public License for more details.     You should have received a copy of the GNU General Public License    along with this program; if not, write to the Free Software    Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.     The author of the program may be contacted at ian@airs.com or    c/o Cygnus Support, 48 Grove Street, Somerville, MA 02144.    */
end_comment

begin_include
include|#
directive|include
file|"uucp.h"
end_include

begin_if
if|#
directive|if
name|USE_RCS_ID
end_if

begin_decl_stmt
specifier|const
name|char
name|uustat_rcsid
index|[]
init|=
literal|"$FreeBSD$"
decl_stmt|;
end_decl_stmt

begin_endif
endif|#
directive|endif
end_endif

begin_include
include|#
directive|include
file|<ctype.h>
end_include

begin_include
include|#
directive|include
file|<errno.h>
end_include

begin_if
if|#
directive|if
name|TM_IN_SYS_TIME
end_if

begin_include
include|#
directive|include
file|<sys/time.h>
end_include

begin_else
else|#
directive|else
end_else

begin_include
include|#
directive|include
file|<time.h>
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_include
include|#
directive|include
file|"getopt.h"
end_include

begin_include
include|#
directive|include
file|"uudefs.h"
end_include

begin_include
include|#
directive|include
file|"uuconf.h"
end_include

begin_include
include|#
directive|include
file|"system.h"
end_include

begin_escape
end_escape

begin_comment
comment|/* The uustat program permits various listings and manipulations of    files in the spool directory.  This implementation supports the    following switches:     -a list all jobs    -Blines number of lines of standard input to mail    -ccommand list only executions of specified command    -Ccommand list only jobs other than executions of specified command    -e list execute jobs rather than command requests    -i ask user whether to kill each listed job    -Ifile set configuration file name    -kjobid kill job with specified ID    -K kill each listed job    -m report status for all remote machines    -M mail uucp about each job killed with -K    -N mail requestor about each job killed with -K    -ohour report jobs older than specified number of hours    -p do "ps -flp" on all processes holding lock files (Unix specific)    -q list number of jobs for all systems    -Q don't list jobs, just do -K processing    -rjobid rejuvenate job with specified ID    -ssystem report on all jobs for specified system    -Ssystem report on all jobs other than for specified system    -uuser report on all jobs for specified user    -Uuser report on all jobs other than for specified user    -Wcomment comment to include in mail messages    -xdebug set debugging level    -yhour report jobs younger than specified number of hours  */
end_comment

begin_escape
end_escape

begin_comment
comment|/* What to do with a job that matches the selection criteria; these    values may be or'red together.  */
end_comment

begin_define
define|#
directive|define
name|JOB_SHOW
value|(01)
end_define

begin_define
define|#
directive|define
name|JOB_INQUIRE
value|(02)
end_define

begin_define
define|#
directive|define
name|JOB_KILL
value|(04)
end_define

begin_define
define|#
directive|define
name|JOB_REJUVENATE
value|(010)
end_define

begin_define
define|#
directive|define
name|JOB_MAIL
value|(020)
end_define

begin_define
define|#
directive|define
name|JOB_NOTIFY
value|(040)
end_define

begin_comment
comment|/* This structure is used to accumulate all the lines in a single    command file, so that they can all be displayed at once and so that    executions can be displayed reasonably.  */
end_comment

begin_struct
struct|struct
name|scmdlist
block|{
name|struct
name|scmdlist
modifier|*
name|qnext
decl_stmt|;
name|struct
name|scmd
name|s
decl_stmt|;
name|long
name|itime
decl_stmt|;
block|}
struct|;
end_struct

begin_comment
comment|/* Local functions.  */
end_comment

begin_decl_stmt
specifier|static
name|void
name|ususage
name|P
argument_list|(
operator|(
name|void
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|void
name|ushelp
name|P
argument_list|(
operator|(
name|void
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|boolean
name|fsxqt_file_read
name|P
argument_list|(
operator|(
name|pointer
name|puuconf
operator|,
name|FILE
operator|*
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|void
name|usxqt_file_free
name|P
argument_list|(
operator|(
name|void
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|isxqt_cmd
name|P
argument_list|(
operator|(
name|pointer
name|puuconf
operator|,
name|int
name|argc
operator|,
name|char
operator|*
operator|*
name|argv
operator|,
name|pointer
name|pvar
operator|,
name|pointer
name|pinfo
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|isxqt_file
name|P
argument_list|(
operator|(
name|pointer
name|puuconf
operator|,
name|int
name|argc
operator|,
name|char
operator|*
operator|*
name|argv
operator|,
name|pointer
name|pvar
operator|,
name|pointer
name|pinfo
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|isxqt_user
name|P
argument_list|(
operator|(
name|pointer
name|puuconf
operator|,
name|int
name|argc
operator|,
name|char
operator|*
operator|*
name|argv
operator|,
name|pointer
name|pvar
operator|,
name|pointer
name|pinfo
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|boolean
name|fsworkfiles
name|P
argument_list|(
operator|(
name|pointer
name|puuconf
operator|,
name|int
name|icmd
operator|,
name|int
name|csystems
operator|,
name|char
operator|*
operator|*
name|pazsystems
operator|,
name|boolean
name|fnotsystems
operator|,
name|int
name|cusers
operator|,
name|char
operator|*
operator|*
name|pazusers
operator|,
name|boolean
name|fnotusers
operator|,
name|long
name|iold
operator|,
name|long
name|iyoung
operator|,
name|int
name|ccommands
operator|,
name|char
operator|*
operator|*
name|pazcommands
operator|,
name|boolean
name|fnotcommands
operator|,
specifier|const
name|char
operator|*
name|zcomment
operator|,
name|int
name|cstdin
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|boolean
name|fsworkfiles_system
name|P
argument_list|(
operator|(
name|pointer
name|puuconf
operator|,
name|int
name|icmd
operator|,
specifier|const
expr|struct
name|uuconf_system
operator|*
name|qsys
operator|,
name|int
name|cusers
operator|,
name|char
operator|*
operator|*
name|pazusers
operator|,
name|boolean
name|fnotusers
operator|,
name|long
name|iold
operator|,
name|long
name|iyoung
operator|,
name|int
name|ccommands
operator|,
name|char
operator|*
operator|*
name|pazcommands
operator|,
name|boolean
name|fnotcommands
operator|,
specifier|const
name|char
operator|*
name|zcomment
operator|,
name|int
name|cstdin
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|boolean
name|fsworkfile_show
name|P
argument_list|(
operator|(
name|pointer
name|puuconf
operator|,
name|int
name|icmd
operator|,
specifier|const
expr|struct
name|uuconf_system
operator|*
name|qsys
operator|,
specifier|const
expr|struct
name|scmd
operator|*
name|qcmd
operator|,
name|long
name|itime
operator|,
name|int
name|ccommands
operator|,
name|char
operator|*
operator|*
name|pazcommands
operator|,
name|boolean
name|fnotcommands
operator|,
specifier|const
name|char
operator|*
name|zcomment
operator|,
name|int
name|cstdin
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|void
name|usworkfile_header
name|P
argument_list|(
operator|(
specifier|const
expr|struct
name|uuconf_system
operator|*
name|qsys
operator|,
specifier|const
expr|struct
name|scmd
operator|*
name|qcmd
operator|,
specifier|const
name|char
operator|*
name|zjobid
operator|,
name|long
name|itime
operator|,
name|boolean
name|ffirst
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|boolean
name|fsexecutions
name|P
argument_list|(
operator|(
name|pointer
name|puuconf
operator|,
name|int
name|icmd
operator|,
name|int
name|csystems
operator|,
name|char
operator|*
operator|*
name|pazsystems
operator|,
name|boolean
name|fnotsystems
operator|,
name|int
name|cusers
operator|,
name|char
operator|*
operator|*
name|pazusers
operator|,
name|boolean
name|fnotusers
operator|,
name|long
name|iold
operator|,
name|long
name|iyoung
operator|,
name|int
name|ccommands
operator|,
name|char
operator|*
operator|*
name|pazcommands
operator|,
name|boolean
name|fnotcommands
operator|,
specifier|const
name|char
operator|*
name|zcomment
operator|,
name|int
name|cstdin
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|boolean
name|fsnotify
name|P
argument_list|(
operator|(
name|pointer
name|puuconf
operator|,
name|int
name|icmd
operator|,
specifier|const
name|char
operator|*
name|zcomment
operator|,
name|int
name|cstdin
operator|,
name|boolean
name|fkilled
operator|,
specifier|const
name|char
operator|*
name|zcmd
operator|,
expr|struct
name|scmdlist
operator|*
name|qcmd
operator|,
specifier|const
name|char
operator|*
name|zid
operator|,
name|long
name|itime
operator|,
specifier|const
name|char
operator|*
name|zuser
operator|,
specifier|const
expr|struct
name|uuconf_system
operator|*
name|qsys
operator|,
specifier|const
name|char
operator|*
name|zstdin
operator|,
name|pointer
name|pstdinseq
operator|,
specifier|const
name|char
operator|*
name|zrequestor
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|boolean
name|fsquery
name|P
argument_list|(
operator|(
name|pointer
name|puuconf
operator|,
name|int
name|csystems
operator|,
name|char
operator|*
operator|*
name|pazsystems
operator|,
name|boolean
name|fnotsystems
operator|,
name|long
name|iold
operator|,
name|long
name|iyoung
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|csunits_show
name|P
argument_list|(
operator|(
name|long
name|idiff
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|boolean
name|fsmachines
name|P
argument_list|(
operator|(
name|void
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* Long getopt options.  */
end_comment

begin_decl_stmt
specifier|static
specifier|const
name|struct
name|option
name|asSlongopts
index|[]
init|=
block|{
block|{
literal|"all"
block|,
name|no_argument
block|,
name|NULL
block|,
literal|'a'
block|}
block|,
block|{
literal|"mail-lines"
block|,
name|required_argument
block|,
name|NULL
block|,
literal|'B'
block|}
block|,
block|{
literal|"command"
block|,
name|required_argument
block|,
name|NULL
block|,
literal|'c'
block|}
block|,
block|{
literal|"not-command"
block|,
name|required_argument
block|,
name|NULL
block|,
literal|'C'
block|}
block|,
block|{
literal|"executions"
block|,
name|no_argument
block|,
name|NULL
block|,
literal|'e'
block|}
block|,
block|{
literal|"prompt"
block|,
name|no_argument
block|,
name|NULL
block|,
literal|'i'
block|}
block|,
block|{
literal|"kill"
block|,
name|required_argument
block|,
name|NULL
block|,
literal|'k'
block|}
block|,
block|{
literal|"kill-all"
block|,
name|no_argument
block|,
name|NULL
block|,
literal|'K'
block|}
block|,
block|{
literal|"status"
block|,
name|no_argument
block|,
name|NULL
block|,
literal|'m'
block|}
block|,
block|{
literal|"mail"
block|,
name|no_argument
block|,
name|NULL
block|,
literal|'M'
block|}
block|,
block|{
literal|"notify"
block|,
name|no_argument
block|,
name|NULL
block|,
literal|'N'
block|}
block|,
block|{
literal|"older-than"
block|,
name|required_argument
block|,
name|NULL
block|,
literal|'o'
block|}
block|,
block|{
literal|"ps"
block|,
name|no_argument
block|,
name|NULL
block|,
literal|'p'
block|}
block|,
block|{
literal|"list"
block|,
name|no_argument
block|,
name|NULL
block|,
literal|'q'
block|}
block|,
block|{
literal|"no-list"
block|,
name|no_argument
block|,
name|NULL
block|,
literal|'Q'
block|}
block|,
block|{
literal|"rejuvenate"
block|,
name|required_argument
block|,
name|NULL
block|,
literal|'r'
block|}
block|,
block|{
literal|"rejuvenate-all"
block|,
name|no_argument
block|,
name|NULL
block|,
literal|'R'
block|}
block|,
block|{
literal|"system"
block|,
name|required_argument
block|,
name|NULL
block|,
literal|'s'
block|}
block|,
block|{
literal|"not-system"
block|,
name|required_argument
block|,
name|NULL
block|,
literal|'S'
block|}
block|,
block|{
literal|"user"
block|,
name|required_argument
block|,
name|NULL
block|,
literal|'u'
block|}
block|,
block|{
literal|"not-user"
block|,
name|required_argument
block|,
name|NULL
block|,
literal|'U'
block|}
block|,
block|{
literal|"comment"
block|,
name|required_argument
block|,
name|NULL
block|,
literal|'W'
block|}
block|,
block|{
literal|"younger-than"
block|,
name|required_argument
block|,
name|NULL
block|,
literal|'y'
block|}
block|,
block|{
literal|"config"
block|,
name|required_argument
block|,
name|NULL
block|,
literal|'I'
block|}
block|,
block|{
literal|"debug"
block|,
name|required_argument
block|,
name|NULL
block|,
literal|'x'
block|}
block|,
block|{
literal|"version"
block|,
name|no_argument
block|,
name|NULL
block|,
literal|'v'
block|}
block|,
block|{
literal|"help"
block|,
name|no_argument
block|,
name|NULL
block|,
literal|1
block|}
block|,
block|{
name|NULL
block|,
literal|0
block|,
name|NULL
block|,
literal|0
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_function
name|int
name|main
parameter_list|(
name|argc
parameter_list|,
name|argv
parameter_list|)
name|int
name|argc
decl_stmt|;
name|char
modifier|*
modifier|*
name|argv
decl_stmt|;
block|{
comment|/* -a: list all jobs.  */
name|boolean
name|fall
init|=
name|FALSE
decl_stmt|;
comment|/* -B lines: number of lines of standard input to mail.  */
name|int
name|cstdin
init|=
literal|100
decl_stmt|;
comment|/* -c,-C command: list only specified command.  */
name|int
name|ccommands
init|=
literal|0
decl_stmt|;
name|char
modifier|*
modifier|*
name|pazcommands
init|=
name|NULL
decl_stmt|;
name|boolean
name|fnotcommands
init|=
name|FALSE
decl_stmt|;
comment|/* -e: list execute jobs.  */
name|boolean
name|fexecute
init|=
name|FALSE
decl_stmt|;
comment|/* -k jobid: kill specified job.  */
name|int
name|ckills
init|=
literal|0
decl_stmt|;
name|char
modifier|*
modifier|*
name|pazkills
init|=
name|NULL
decl_stmt|;
comment|/* -m: report machine status.  */
name|boolean
name|fmachine
init|=
name|FALSE
decl_stmt|;
comment|/* -o hour: report jobs older than given number of hours.  */
name|int
name|ioldhours
init|=
operator|-
literal|1
decl_stmt|;
comment|/* -p: report status of jobs holding lock files.  */
name|boolean
name|fps
init|=
name|FALSE
decl_stmt|;
comment|/* -q: list number of jobs for each system.  */
name|boolean
name|fquery
init|=
name|FALSE
decl_stmt|;
comment|/* -r jobid: rejuvenate specified job.  */
name|int
name|crejuvs
init|=
literal|0
decl_stmt|;
name|char
modifier|*
modifier|*
name|pazrejuvs
init|=
name|NULL
decl_stmt|;
comment|/* -s,-S system: list all jobs for specified system.  */
name|int
name|csystems
init|=
literal|0
decl_stmt|;
name|char
modifier|*
modifier|*
name|pazsystems
init|=
name|NULL
decl_stmt|;
name|boolean
name|fnotsystems
init|=
name|FALSE
decl_stmt|;
comment|/* -u,-U user: list all jobs for specified user.  */
name|int
name|cusers
init|=
literal|0
decl_stmt|;
name|char
modifier|*
modifier|*
name|pazusers
init|=
name|NULL
decl_stmt|;
name|boolean
name|fnotusers
init|=
name|FALSE
decl_stmt|;
comment|/* -W comment: comment to include in mail messages.  */
specifier|const
name|char
modifier|*
name|zcomment
init|=
name|NULL
decl_stmt|;
comment|/* -y hour: report jobs younger than given number of hours.  */
name|int
name|iyounghours
init|=
operator|-
literal|1
decl_stmt|;
comment|/* -I file: set configuration file.  */
specifier|const
name|char
modifier|*
name|zconfig
init|=
name|NULL
decl_stmt|;
comment|/* -Q, -i, -K, -M, -N: what to do with each job.  */
name|int
name|icmd
init|=
name|JOB_SHOW
decl_stmt|;
name|int
name|ccmds
decl_stmt|;
name|int
name|iopt
decl_stmt|;
name|pointer
name|puuconf
decl_stmt|;
name|int
name|iuuconf
decl_stmt|;
name|long
name|iold
decl_stmt|;
name|long
name|iyoung
decl_stmt|;
specifier|const
name|char
modifier|*
name|azoneuser
index|[
literal|1
index|]
decl_stmt|;
name|boolean
name|fret
decl_stmt|;
name|zProgram
operator|=
name|argv
index|[
literal|0
index|]
expr_stmt|;
while|while
condition|(
operator|(
name|iopt
operator|=
name|getopt_long
argument_list|(
name|argc
argument_list|,
name|argv
argument_list|,
literal|"aB:c:C:eiI:k:KmMNo:pqQr:Rs:S:u:U:vW:x:y:"
argument_list|,
name|asSlongopts
argument_list|,
operator|(
name|int
operator|*
operator|)
name|NULL
argument_list|)
operator|)
operator|!=
name|EOF
condition|)
block|{
switch|switch
condition|(
name|iopt
condition|)
block|{
case|case
literal|'a'
case|:
comment|/* List all jobs.  */
name|fall
operator|=
name|TRUE
expr_stmt|;
break|break;
case|case
literal|'B'
case|:
comment|/* Number of lines of standard input to mail.  */
name|cstdin
operator|=
operator|(
name|int
operator|)
name|strtol
argument_list|(
name|optarg
argument_list|,
operator|(
name|char
operator|*
operator|*
operator|)
name|NULL
argument_list|,
literal|10
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'C'
case|:
comment|/* List jobs for other than specified command.  */
name|fnotcommands
operator|=
name|TRUE
expr_stmt|;
comment|/* Fall through.  */
case|case
literal|'c'
case|:
comment|/* List specified command.  */
operator|++
name|ccommands
expr_stmt|;
name|pazcommands
operator|=
operator|(
name|char
operator|*
operator|*
operator|)
name|xrealloc
argument_list|(
operator|(
name|pointer
operator|)
name|pazcommands
argument_list|,
name|ccommands
operator|*
sizeof|sizeof
argument_list|(
name|char
operator|*
argument_list|)
argument_list|)
expr_stmt|;
name|pazcommands
index|[
name|ccommands
operator|-
literal|1
index|]
operator|=
name|optarg
expr_stmt|;
break|break;
case|case
literal|'e'
case|:
comment|/* List execute jobs.  */
name|fexecute
operator|=
name|TRUE
expr_stmt|;
break|break;
case|case
literal|'i'
case|:
comment|/* Prompt the user whether to kill each job.  */
name|icmd
operator||=
name|JOB_INQUIRE
expr_stmt|;
break|break;
case|case
literal|'I'
case|:
comment|/* Set configuration file name.  */
if|if
condition|(
name|fsysdep_other_config
argument_list|(
name|optarg
argument_list|)
condition|)
name|zconfig
operator|=
name|optarg
expr_stmt|;
break|break;
case|case
literal|'k'
case|:
comment|/* Kill specified job.  */
operator|++
name|ckills
expr_stmt|;
name|pazkills
operator|=
operator|(
name|char
operator|*
operator|*
operator|)
name|xrealloc
argument_list|(
operator|(
name|pointer
operator|)
name|pazkills
argument_list|,
name|ckills
operator|*
sizeof|sizeof
argument_list|(
name|char
operator|*
argument_list|)
argument_list|)
expr_stmt|;
name|pazkills
index|[
name|ckills
operator|-
literal|1
index|]
operator|=
name|optarg
expr_stmt|;
break|break;
case|case
literal|'K'
case|:
comment|/* Kill each listed job.  */
name|icmd
operator||=
name|JOB_KILL
expr_stmt|;
break|break;
case|case
literal|'m'
case|:
comment|/* Report machine status.  */
name|fmachine
operator|=
name|TRUE
expr_stmt|;
break|break;
case|case
literal|'M'
case|:
comment|/* Mail to uucp action taken on each job.  */
name|icmd
operator||=
name|JOB_MAIL
expr_stmt|;
break|break;
case|case
literal|'N'
case|:
comment|/*  Mail to requestor action taken on each job.  */
name|icmd
operator||=
name|JOB_NOTIFY
expr_stmt|;
break|break;
case|case
literal|'o'
case|:
comment|/* Report old jobs.  */
name|ioldhours
operator|=
operator|(
name|int
operator|)
name|strtol
argument_list|(
name|optarg
argument_list|,
operator|(
name|char
operator|*
operator|*
operator|)
name|NULL
argument_list|,
literal|10
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'p'
case|:
comment|/* Get status of processes holding locks.  */
name|fps
operator|=
name|TRUE
expr_stmt|;
break|break;
case|case
literal|'q'
case|:
comment|/* List number of jobs for each system.  */
name|fquery
operator|=
name|TRUE
expr_stmt|;
break|break;
case|case
literal|'Q'
case|:
comment|/* Don't list jobs, just do -K processing.  */
name|icmd
operator|&=
operator|~
name|JOB_SHOW
expr_stmt|;
break|break;
case|case
literal|'r'
case|:
comment|/* Rejuvenate specified job.  */
operator|++
name|crejuvs
expr_stmt|;
name|pazrejuvs
operator|=
operator|(
name|char
operator|*
operator|*
operator|)
name|xrealloc
argument_list|(
operator|(
name|pointer
operator|)
name|pazrejuvs
argument_list|,
name|crejuvs
operator|*
sizeof|sizeof
argument_list|(
name|char
operator|*
argument_list|)
argument_list|)
expr_stmt|;
name|pazrejuvs
index|[
name|crejuvs
operator|-
literal|1
index|]
operator|=
name|optarg
expr_stmt|;
break|break;
case|case
literal|'R'
case|:
comment|/* Rejuvenate each listed job.  */
name|icmd
operator||=
name|JOB_REJUVENATE
expr_stmt|;
break|break;
case|case
literal|'S'
case|:
comment|/* List jobs for other than specified system.  */
name|fnotsystems
operator|=
name|TRUE
expr_stmt|;
comment|/* Fall through.  */
case|case
literal|'s'
case|:
comment|/* List jobs for specified system.  */
operator|++
name|csystems
expr_stmt|;
name|pazsystems
operator|=
operator|(
name|char
operator|*
operator|*
operator|)
name|xrealloc
argument_list|(
operator|(
name|pointer
operator|)
name|pazsystems
argument_list|,
name|csystems
operator|*
sizeof|sizeof
argument_list|(
name|char
operator|*
argument_list|)
argument_list|)
expr_stmt|;
name|pazsystems
index|[
name|csystems
operator|-
literal|1
index|]
operator|=
name|optarg
expr_stmt|;
break|break;
case|case
literal|'U'
case|:
comment|/* List jobs for other than specified user.  */
name|fnotusers
operator|=
name|TRUE
expr_stmt|;
comment|/* Fall through.  */
case|case
literal|'u'
case|:
comment|/* List jobs for specified user.  */
operator|++
name|cusers
expr_stmt|;
name|pazusers
operator|=
operator|(
name|char
operator|*
operator|*
operator|)
name|xrealloc
argument_list|(
operator|(
name|pointer
operator|)
name|pazusers
argument_list|,
name|cusers
operator|*
sizeof|sizeof
argument_list|(
name|char
operator|*
argument_list|)
argument_list|)
expr_stmt|;
name|pazusers
index|[
name|cusers
operator|-
literal|1
index|]
operator|=
name|optarg
expr_stmt|;
break|break;
case|case
literal|'W'
case|:
comment|/* Comment to include in mail messages.  */
name|zcomment
operator|=
name|optarg
expr_stmt|;
break|break;
case|case
literal|'x'
case|:
if|#
directive|if
name|DEBUG
operator|>
literal|1
comment|/* Set debugging level.  */
name|iDebug
operator||=
name|idebug_parse
argument_list|(
name|optarg
argument_list|)
expr_stmt|;
endif|#
directive|endif
break|break;
case|case
literal|'y'
case|:
comment|/* List jobs younger than given number of hours.  */
name|iyounghours
operator|=
operator|(
name|int
operator|)
name|strtol
argument_list|(
name|optarg
argument_list|,
operator|(
name|char
operator|*
operator|*
operator|)
name|NULL
argument_list|,
literal|10
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'v'
case|:
comment|/* Print version and exit.  */
name|printf
argument_list|(
literal|"%s: Taylor UUCP %s, copyright (C) 1991, 92, 93, 94, 1995 Ian Lance Taylor\n"
argument_list|,
name|zProgram
argument_list|,
name|VERSION
argument_list|)
expr_stmt|;
name|exit
argument_list|(
name|EXIT_SUCCESS
argument_list|)
expr_stmt|;
comment|/*NOTREACHED*/
case|case
literal|1
case|:
comment|/* --help.  */
name|ushelp
argument_list|()
expr_stmt|;
name|exit
argument_list|(
name|EXIT_SUCCESS
argument_list|)
expr_stmt|;
comment|/*NOTREACHED*/
case|case
literal|0
case|:
comment|/* Long option found and flag set.  */
break|break;
default|default:
name|ususage
argument_list|()
expr_stmt|;
comment|/*NOTREACHED*/
block|}
block|}
if|if
condition|(
name|optind
operator|!=
name|argc
condition|)
name|ususage
argument_list|()
expr_stmt|;
comment|/* To avoid confusion, most options are only permitted by      themselves.  This restriction might be removed later, but it is      imposed by most implementations.  We do permit any combination of      -c, -s, -u, -o and -y, and any combination of -k and -r.  */
name|ccmds
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|fall
condition|)
operator|++
name|ccmds
expr_stmt|;
if|if
condition|(
name|ckills
operator|>
literal|0
operator|||
name|crejuvs
operator|>
literal|0
condition|)
operator|++
name|ccmds
expr_stmt|;
if|if
condition|(
name|fmachine
condition|)
operator|++
name|ccmds
expr_stmt|;
if|if
condition|(
name|fps
condition|)
operator|++
name|ccmds
expr_stmt|;
if|if
condition|(
name|fexecute
operator|||
name|fquery
operator|||
name|csystems
operator|>
literal|0
operator|||
name|cusers
operator|>
literal|0
operator|||
name|ioldhours
operator|!=
operator|-
literal|1
operator|||
name|iyounghours
operator|!=
operator|-
literal|1
operator|||
name|ccommands
operator|>
literal|0
condition|)
operator|++
name|ccmds
expr_stmt|;
if|if
condition|(
name|fexecute
operator|&&
name|fquery
condition|)
operator|++
name|ccmds
expr_stmt|;
if|if
condition|(
name|ccmds
operator|>
literal|1
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"%s: too many options\n"
argument_list|,
name|zProgram
argument_list|)
expr_stmt|;
name|ususage
argument_list|()
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|icmd
operator|&
name|JOB_KILL
operator|)
operator|!=
literal|0
operator|&&
operator|(
name|icmd
operator|&
name|JOB_REJUVENATE
operator|)
operator|!=
literal|0
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"%s: can not both rejuvenate and kill jobs\n"
argument_list|,
name|zProgram
argument_list|)
expr_stmt|;
name|ususage
argument_list|()
expr_stmt|;
block|}
name|iuuconf
operator|=
name|uuconf_init
argument_list|(
operator|&
name|puuconf
argument_list|,
operator|(
specifier|const
name|char
operator|*
operator|)
name|NULL
argument_list|,
name|zconfig
argument_list|)
expr_stmt|;
if|if
condition|(
name|iuuconf
operator|!=
name|UUCONF_SUCCESS
condition|)
name|ulog_uuconf
argument_list|(
name|LOG_FATAL
argument_list|,
name|puuconf
argument_list|,
name|iuuconf
argument_list|)
expr_stmt|;
if|#
directive|if
name|DEBUG
operator|>
literal|1
block|{
specifier|const
name|char
modifier|*
name|zdebug
decl_stmt|;
name|iuuconf
operator|=
name|uuconf_debuglevel
argument_list|(
name|puuconf
argument_list|,
operator|&
name|zdebug
argument_list|)
expr_stmt|;
if|if
condition|(
name|iuuconf
operator|!=
name|UUCONF_SUCCESS
condition|)
name|ulog_uuconf
argument_list|(
name|LOG_FATAL
argument_list|,
name|puuconf
argument_list|,
name|iuuconf
argument_list|)
expr_stmt|;
if|if
condition|(
name|zdebug
operator|!=
name|NULL
condition|)
name|iDebug
operator||=
name|idebug_parse
argument_list|(
name|zdebug
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
name|usysdep_initialize
argument_list|(
name|puuconf
argument_list|,
name|INIT_SUID
argument_list|)
expr_stmt|;
comment|/* If no commands were specified, we list all commands for the given      user.  */
if|if
condition|(
name|ccmds
operator|==
literal|0
condition|)
block|{
name|cusers
operator|=
literal|1
expr_stmt|;
name|azoneuser
index|[
literal|0
index|]
operator|=
name|zsysdep_login_name
argument_list|()
expr_stmt|;
name|pazusers
operator|=
operator|(
name|char
operator|*
operator|*
operator|)
name|azoneuser
expr_stmt|;
block|}
comment|/* Canonicalize the system names.  */
if|if
condition|(
name|csystems
operator|>
literal|0
condition|)
block|{
name|int
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|csystems
condition|;
name|i
operator|++
control|)
block|{
name|struct
name|uuconf_system
name|ssys
decl_stmt|;
name|iuuconf
operator|=
name|uuconf_system_info
argument_list|(
name|puuconf
argument_list|,
name|pazsystems
index|[
name|i
index|]
argument_list|,
operator|&
name|ssys
argument_list|)
expr_stmt|;
if|if
condition|(
name|iuuconf
operator|!=
name|UUCONF_SUCCESS
condition|)
block|{
if|if
condition|(
name|iuuconf
operator|==
name|UUCONF_NOT_FOUND
condition|)
name|ulog
argument_list|(
name|LOG_FATAL
argument_list|,
literal|"%s: System not found"
argument_list|,
name|pazsystems
index|[
name|i
index|]
argument_list|)
expr_stmt|;
else|else
name|ulog_uuconf
argument_list|(
name|LOG_FATAL
argument_list|,
name|puuconf
argument_list|,
name|iuuconf
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|strcmp
argument_list|(
name|pazsystems
index|[
name|i
index|]
argument_list|,
name|ssys
operator|.
name|uuconf_zname
argument_list|)
operator|!=
literal|0
condition|)
name|pazsystems
index|[
name|i
index|]
operator|=
name|zbufcpy
argument_list|(
name|ssys
operator|.
name|uuconf_zname
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|uuconf_system_free
argument_list|(
name|puuconf
argument_list|,
operator|&
name|ssys
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
name|ioldhours
operator|==
operator|-
literal|1
condition|)
name|iold
operator|=
operator|(
name|long
operator|)
operator|-
literal|1
expr_stmt|;
else|else
block|{
name|iold
operator|=
operator|(
name|ixsysdep_time
argument_list|(
operator|(
name|long
operator|*
operator|)
name|NULL
argument_list|)
operator|-
operator|(
name|long
operator|)
name|ioldhours
operator|*
operator|(
name|long
operator|)
literal|60
operator|*
operator|(
name|long
operator|)
literal|60
operator|)
expr_stmt|;
if|if
condition|(
name|iold
operator|<
literal|0L
condition|)
name|iold
operator|=
literal|0L
expr_stmt|;
block|}
if|if
condition|(
name|iyounghours
operator|==
operator|-
literal|1
condition|)
name|iyoung
operator|=
operator|(
name|long
operator|)
operator|-
literal|1
expr_stmt|;
else|else
block|{
name|iyoung
operator|=
operator|(
name|ixsysdep_time
argument_list|(
operator|(
name|long
operator|*
operator|)
name|NULL
argument_list|)
operator|-
operator|(
name|long
operator|)
name|iyounghours
operator|*
operator|(
name|long
operator|)
literal|60
operator|*
operator|(
name|long
operator|)
literal|60
operator|)
expr_stmt|;
if|if
condition|(
name|iyoung
operator|<
literal|0L
condition|)
name|iyoung
operator|=
literal|0L
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|fexecute
operator|&&
operator|!
name|fquery
operator|&&
operator|(
name|fall
operator|||
name|csystems
operator|>
literal|0
operator|||
name|cusers
operator|>
literal|0
operator|||
name|ioldhours
operator|!=
operator|-
literal|1
operator|||
name|iyounghours
operator|!=
operator|-
literal|1
operator|||
name|ccommands
operator|>
literal|0
operator|)
condition|)
name|fret
operator|=
name|fsworkfiles
argument_list|(
name|puuconf
argument_list|,
name|icmd
argument_list|,
name|csystems
argument_list|,
name|pazsystems
argument_list|,
name|fnotsystems
argument_list|,
name|cusers
argument_list|,
name|pazusers
argument_list|,
name|fnotusers
argument_list|,
name|iold
argument_list|,
name|iyoung
argument_list|,
name|ccommands
argument_list|,
name|pazcommands
argument_list|,
name|fnotcommands
argument_list|,
name|zcomment
argument_list|,
name|cstdin
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|fexecute
condition|)
name|fret
operator|=
name|fsexecutions
argument_list|(
name|puuconf
argument_list|,
name|icmd
argument_list|,
name|csystems
argument_list|,
name|pazsystems
argument_list|,
name|fnotsystems
argument_list|,
name|cusers
argument_list|,
name|pazusers
argument_list|,
name|fnotusers
argument_list|,
name|iold
argument_list|,
name|iyoung
argument_list|,
name|ccommands
argument_list|,
name|pazcommands
argument_list|,
name|fnotcommands
argument_list|,
name|zcomment
argument_list|,
name|cstdin
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|icmd
operator|!=
name|JOB_SHOW
condition|)
block|{
name|ulog
argument_list|(
name|LOG_ERROR
argument_list|,
literal|"-i, -K, -M, -N, -Q, -R not supported with -k, -m, -p, -q, -r"
argument_list|)
expr_stmt|;
name|ususage
argument_list|()
expr_stmt|;
name|fret
operator|=
name|FALSE
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|fquery
condition|)
block|{
if|if
condition|(
name|cusers
operator|>
literal|0
operator|||
name|ccommands
operator|>
literal|0
condition|)
block|{
name|ulog
argument_list|(
name|LOG_ERROR
argument_list|,
literal|"-u, -c not supported with -q"
argument_list|)
expr_stmt|;
name|ususage
argument_list|()
expr_stmt|;
name|fret
operator|=
name|FALSE
expr_stmt|;
block|}
else|else
name|fret
operator|=
name|fsquery
argument_list|(
name|puuconf
argument_list|,
name|csystems
argument_list|,
name|pazsystems
argument_list|,
name|fnotsystems
argument_list|,
name|iold
argument_list|,
name|iyoung
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|fmachine
condition|)
name|fret
operator|=
name|fsmachines
argument_list|()
expr_stmt|;
elseif|else
if|if
condition|(
name|ckills
operator|>
literal|0
operator|||
name|crejuvs
operator|>
literal|0
condition|)
block|{
name|int
name|i
decl_stmt|;
name|fret
operator|=
name|TRUE
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|ckills
condition|;
name|i
operator|++
control|)
if|if
condition|(
operator|!
name|fsysdep_kill_job
argument_list|(
name|puuconf
argument_list|,
name|pazkills
index|[
name|i
index|]
argument_list|)
condition|)
name|fret
operator|=
name|FALSE
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|crejuvs
condition|;
name|i
operator|++
control|)
if|if
condition|(
operator|!
name|fsysdep_rejuvenate_job
argument_list|(
name|puuconf
argument_list|,
name|pazrejuvs
index|[
name|i
index|]
argument_list|)
condition|)
name|fret
operator|=
name|FALSE
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|fps
condition|)
name|fret
operator|=
name|fsysdep_lock_status
argument_list|()
expr_stmt|;
else|else
block|{
if|#
directive|if
name|DEBUG
operator|>
literal|0
name|ulog
argument_list|(
name|LOG_FATAL
argument_list|,
literal|"Can't happen"
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|fret
operator|=
name|FALSE
expr_stmt|;
block|}
name|ulog_close
argument_list|()
expr_stmt|;
name|usysdep_exit
argument_list|(
name|fret
argument_list|)
expr_stmt|;
comment|/* Avoid errors about not returning a value.  */
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/* Print a usage message and die.  */
end_comment

begin_function
specifier|static
name|void
name|ususage
parameter_list|()
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Usage: %s [options]\n"
argument_list|,
name|zProgram
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Use %s --help for help\n"
argument_list|,
name|zProgram
argument_list|)
expr_stmt|;
name|exit
argument_list|(
name|EXIT_FAILURE
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* Print a help message.  */
end_comment

begin_function
specifier|static
name|void
name|ushelp
parameter_list|()
block|{
name|printf
argument_list|(
literal|"Taylor UUCP %s, copyright (C) 1991, 92, 93, 94, 1995 Ian Lance Taylor\n"
argument_list|,
name|VERSION
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Usage: %s [options]\n"
argument_list|,
name|zProgram
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|" -a,--all: list all UUCP jobs\n"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|" -B,--mail-lines num: number of lines to return in -M or -N mail message\n"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|" -c,--command command: list requests for named command\n"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|" -C,--not-command command: list requests for other than named command\n"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|" -e,--executions: list queued executions rather than job requests\n"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|" -i,--prompt: prompt for whether to kill each listed job\n"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|" -k,--kill job: kill specified UUCP job\n"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|" -K,--kill-all: kill each listed job\n"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|" -m,--status: report status for all remote machines\n"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|" -M,--mail: mail report on each listed job to UUCP administrator\n"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|" -N,--notify: mail report on each listed job to requestor\n"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|" -o,--older-than hours: list all jobs older than given number of hours\n"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|" -p,--ps: show status of all processes holding UUCP locks\n"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|" -q,--list: list number of jobs for each system\n"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|" -Q,--no-list: don't list jobs, just take actions (-i, -K, -M, -N)\n"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|" -r,--rejuvenate job: rejuvenate specified UUCP job\n"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|" -R,--rejuvenate-all: rejuvenate each listed job\n"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|" -s,--system system: list all jobs for specified system\n"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|" -S,--not-system system: list all jobs for other than specified system\n"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|" -u,--user user: list all jobs for specified user\n"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|" -U,--not-user user: list all jobs for other than specified user\n"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|" -W,--comment comment: comment to include in mail messages\n"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|" -y,--younger-than hours: list all jobs younger than given number of hours\n"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|" -x,--debug debug: Set debugging level\n"
argument_list|)
expr_stmt|;
if|#
directive|if
name|HAVE_TAYLOR_CONFIG
name|printf
argument_list|(
literal|" -I,--config file: Set configuration file to use\n"
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* HAVE_TAYLOR_CONFIG */
name|printf
argument_list|(
literal|" -v,--version: Print version and exit\n"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|" --help: Print help and exit\n"
argument_list|)
expr_stmt|;
block|}
end_function

begin_escape
end_escape

begin_comment
comment|/* We need to be able to read information from an execution file.  */
end_comment

begin_comment
comment|/* The user name extracted from an execution file.  */
end_comment

begin_decl_stmt
specifier|static
name|char
modifier|*
name|zSxqt_user
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* The system name from an execution file.  */
end_comment

begin_decl_stmt
specifier|static
name|char
modifier|*
name|zSxqt_system
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* Address of requesting user (who to send mail to).  */
end_comment

begin_decl_stmt
specifier|static
specifier|const
name|char
modifier|*
name|zSxqt_requestor
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* The command (no arguments) from an execution file.  */
end_comment

begin_decl_stmt
specifier|static
name|char
modifier|*
name|zSxqt_prog
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* The full command line from an execution file.  */
end_comment

begin_decl_stmt
specifier|static
name|char
modifier|*
name|zSxqt_cmd
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* Number of files associated with an execution file.  */
end_comment

begin_decl_stmt
specifier|static
name|int
name|cSxqt_files
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* Names of files associated with execution file.  */
end_comment

begin_decl_stmt
specifier|static
name|char
modifier|*
modifier|*
name|pazSxqt_files
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* Standard input file name.  */
end_comment

begin_decl_stmt
specifier|static
specifier|const
name|char
modifier|*
name|zSxqt_stdin
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* A command table used to dispatch an execution file.  */
end_comment

begin_decl_stmt
specifier|static
specifier|const
name|struct
name|uuconf_cmdtab
name|asSxqt_cmds
index|[]
init|=
block|{
block|{
literal|"C"
block|,
name|UUCONF_CMDTABTYPE_FN
operator||
literal|0
block|,
name|NULL
block|,
name|isxqt_cmd
block|}
block|,
block|{
literal|"I"
block|,
name|UUCONF_CMDTABTYPE_STRING
block|,
operator|(
name|pointer
operator|)
operator|&
name|zSxqt_stdin
block|,
name|NULL
block|}
block|,
block|{
literal|"F"
block|,
name|UUCONF_CMDTABTYPE_FN
operator||
literal|0
block|,
name|NULL
block|,
name|isxqt_file
block|}
block|,
block|{
literal|"R"
block|,
name|UUCONF_CMDTABTYPE_STRING
block|,
operator|(
name|pointer
operator|)
operator|&
name|zSxqt_requestor
block|,
name|NULL
block|}
block|,
block|{
literal|"U"
block|,
name|UUCONF_CMDTABTYPE_FN
operator||
literal|3
block|,
name|NULL
block|,
name|isxqt_user
block|}
block|,
block|{
name|NULL
block|,
literal|0
block|,
name|NULL
block|,
name|NULL
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* Read an execution file, setting the above variables.  */
end_comment

begin_function
specifier|static
name|boolean
name|fsxqt_file_read
parameter_list|(
name|puuconf
parameter_list|,
name|e
parameter_list|)
name|pointer
name|puuconf
decl_stmt|;
name|FILE
modifier|*
name|e
decl_stmt|;
block|{
name|int
name|iuuconf
decl_stmt|;
name|boolean
name|fret
decl_stmt|;
name|zSxqt_user
operator|=
name|NULL
expr_stmt|;
name|zSxqt_system
operator|=
name|NULL
expr_stmt|;
name|zSxqt_stdin
operator|=
name|NULL
expr_stmt|;
name|zSxqt_requestor
operator|=
name|NULL
expr_stmt|;
name|zSxqt_prog
operator|=
name|NULL
expr_stmt|;
name|zSxqt_cmd
operator|=
name|NULL
expr_stmt|;
name|cSxqt_files
operator|=
literal|0
expr_stmt|;
name|pazSxqt_files
operator|=
name|NULL
expr_stmt|;
name|iuuconf
operator|=
name|uuconf_cmd_file
argument_list|(
name|puuconf
argument_list|,
name|e
argument_list|,
name|asSxqt_cmds
argument_list|,
operator|(
name|pointer
operator|)
name|NULL
argument_list|,
operator|(
name|uuconf_cmdtabfn
operator|)
name|NULL
argument_list|,
name|UUCONF_CMDTABFLAG_CASE
argument_list|,
operator|(
name|pointer
operator|)
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|iuuconf
operator|==
name|UUCONF_SUCCESS
condition|)
name|fret
operator|=
name|TRUE
expr_stmt|;
else|else
block|{
name|ulog_uuconf
argument_list|(
name|LOG_ERROR
argument_list|,
name|puuconf
argument_list|,
name|iuuconf
argument_list|)
expr_stmt|;
name|fret
operator|=
name|FALSE
expr_stmt|;
block|}
if|if
condition|(
name|zSxqt_user
operator|==
name|NULL
condition|)
name|zSxqt_user
operator|=
name|zbufcpy
argument_list|(
literal|"*unknown*"
argument_list|)
expr_stmt|;
if|if
condition|(
name|zSxqt_system
operator|==
name|NULL
condition|)
name|zSxqt_system
operator|=
name|zbufcpy
argument_list|(
literal|"*unknown*"
argument_list|)
expr_stmt|;
if|if
condition|(
name|zSxqt_prog
operator|==
name|NULL
condition|)
block|{
name|zSxqt_prog
operator|=
name|zbufcpy
argument_list|(
literal|"*none*"
argument_list|)
expr_stmt|;
name|zSxqt_cmd
operator|=
name|zbufcpy
argument_list|(
literal|"*none*"
argument_list|)
expr_stmt|;
block|}
return|return
name|fret
return|;
block|}
end_function

begin_comment
comment|/* Free up the information read from an execution file.  */
end_comment

begin_function
specifier|static
name|void
name|usxqt_file_free
parameter_list|()
block|{
name|int
name|i
decl_stmt|;
name|ubuffree
argument_list|(
name|zSxqt_user
argument_list|)
expr_stmt|;
name|zSxqt_user
operator|=
name|NULL
expr_stmt|;
name|ubuffree
argument_list|(
name|zSxqt_system
argument_list|)
expr_stmt|;
name|zSxqt_system
operator|=
name|NULL
expr_stmt|;
name|ubuffree
argument_list|(
name|zSxqt_prog
argument_list|)
expr_stmt|;
name|zSxqt_prog
operator|=
name|NULL
expr_stmt|;
name|ubuffree
argument_list|(
name|zSxqt_cmd
argument_list|)
expr_stmt|;
name|zSxqt_cmd
operator|=
name|NULL
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|cSxqt_files
condition|;
name|i
operator|++
control|)
name|ubuffree
argument_list|(
name|pazSxqt_files
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|cSxqt_files
operator|=
literal|0
expr_stmt|;
name|xfree
argument_list|(
operator|(
name|pointer
operator|)
name|pazSxqt_files
argument_list|)
expr_stmt|;
name|pazSxqt_files
operator|=
name|NULL
expr_stmt|;
name|zSxqt_stdin
operator|=
name|NULL
expr_stmt|;
name|zSxqt_requestor
operator|=
name|NULL
expr_stmt|;
block|}
end_function

begin_comment
comment|/* Get the command from an execution file.  */
end_comment

begin_comment
comment|/*ARGSUSED*/
end_comment

begin_function
specifier|static
name|int
name|isxqt_cmd
parameter_list|(
name|puuconf
parameter_list|,
name|argc
parameter_list|,
name|argv
parameter_list|,
name|pvar
parameter_list|,
name|pinfo
parameter_list|)
name|pointer
name|puuconf
decl_stmt|;
name|int
name|argc
decl_stmt|;
name|char
modifier|*
modifier|*
name|argv
decl_stmt|;
name|pointer
name|pvar
decl_stmt|;
name|pointer
name|pinfo
decl_stmt|;
block|{
name|size_t
name|clen
decl_stmt|;
name|int
name|i
decl_stmt|;
if|if
condition|(
name|argc
operator|<=
literal|1
condition|)
return|return
name|UUCONF_CMDTABRET_CONTINUE
return|;
name|zSxqt_prog
operator|=
name|zbufcpy
argument_list|(
name|argv
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
name|clen
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|1
init|;
name|i
operator|<
name|argc
condition|;
name|i
operator|++
control|)
name|clen
operator|+=
name|strlen
argument_list|(
name|argv
index|[
name|i
index|]
argument_list|)
operator|+
literal|1
expr_stmt|;
name|zSxqt_cmd
operator|=
name|zbufalc
argument_list|(
name|clen
argument_list|)
expr_stmt|;
name|zSxqt_cmd
index|[
literal|0
index|]
operator|=
literal|'\0'
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|1
init|;
name|i
operator|<
name|argc
operator|-
literal|1
condition|;
name|i
operator|++
control|)
block|{
name|strcat
argument_list|(
name|zSxqt_cmd
argument_list|,
name|argv
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|strcat
argument_list|(
name|zSxqt_cmd
argument_list|,
literal|" "
argument_list|)
expr_stmt|;
block|}
name|strcat
argument_list|(
name|zSxqt_cmd
argument_list|,
name|argv
index|[
name|i
index|]
argument_list|)
expr_stmt|;
return|return
name|UUCONF_CMDTABRET_CONTINUE
return|;
block|}
end_function

begin_comment
comment|/* Get the associated files from an execution file.  */
end_comment

begin_comment
comment|/*ARGSUSED*/
end_comment

begin_function
specifier|static
name|int
name|isxqt_file
parameter_list|(
name|puuconf
parameter_list|,
name|argc
parameter_list|,
name|argv
parameter_list|,
name|pvar
parameter_list|,
name|pinfo
parameter_list|)
name|pointer
name|puuconf
decl_stmt|;
name|int
name|argc
decl_stmt|;
name|char
modifier|*
modifier|*
name|argv
decl_stmt|;
name|pointer
name|pvar
decl_stmt|;
name|pointer
name|pinfo
decl_stmt|;
block|{
if|if
condition|(
name|argc
operator|!=
literal|2
operator|&&
name|argc
operator|!=
literal|3
condition|)
return|return
name|UUCONF_CMDTABRET_CONTINUE
return|;
comment|/* If this file is not in the spool directory, just ignore it.  */
if|if
condition|(
operator|!
name|fspool_file
argument_list|(
name|argv
index|[
literal|1
index|]
argument_list|)
condition|)
return|return
name|UUCONF_CMDTABRET_CONTINUE
return|;
operator|++
name|cSxqt_files
expr_stmt|;
name|pazSxqt_files
operator|=
operator|(
name|char
operator|*
operator|*
operator|)
name|xrealloc
argument_list|(
operator|(
name|pointer
operator|)
name|pazSxqt_files
argument_list|,
name|cSxqt_files
operator|*
sizeof|sizeof
argument_list|(
name|char
operator|*
argument_list|)
argument_list|)
expr_stmt|;
name|pazSxqt_files
index|[
name|cSxqt_files
operator|-
literal|1
index|]
operator|=
name|zbufcpy
argument_list|(
name|argv
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
return|return
name|UUCONF_CMDTABRET_CONTINUE
return|;
block|}
end_function

begin_comment
comment|/* Get the requesting user and system from an execution file.  */
end_comment

begin_comment
comment|/*ARGSUSED*/
end_comment

begin_function
specifier|static
name|int
name|isxqt_user
parameter_list|(
name|puuconf
parameter_list|,
name|argc
parameter_list|,
name|argv
parameter_list|,
name|pvar
parameter_list|,
name|pinfo
parameter_list|)
name|pointer
name|puuconf
decl_stmt|;
name|int
name|argc
decl_stmt|;
name|char
modifier|*
modifier|*
name|argv
decl_stmt|;
name|pointer
name|pvar
decl_stmt|;
name|pointer
name|pinfo
decl_stmt|;
block|{
name|zSxqt_user
operator|=
name|zbufcpy
argument_list|(
name|argv
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
name|zSxqt_system
operator|=
name|zbufcpy
argument_list|(
name|argv
index|[
literal|2
index|]
argument_list|)
expr_stmt|;
return|return
name|UUCONF_CMDTABRET_CONTINUE
return|;
block|}
end_function

begin_escape
end_escape

begin_comment
comment|/* Handle various possible requests to look at work files.  */
end_comment

begin_function
specifier|static
name|boolean
name|fsworkfiles
parameter_list|(
name|puuconf
parameter_list|,
name|icmd
parameter_list|,
name|csystems
parameter_list|,
name|pazsystems
parameter_list|,
name|fnotsystems
parameter_list|,
name|cusers
parameter_list|,
name|pazusers
parameter_list|,
name|fnotusers
parameter_list|,
name|iold
parameter_list|,
name|iyoung
parameter_list|,
name|ccommands
parameter_list|,
name|pazcommands
parameter_list|,
name|fnotcommands
parameter_list|,
name|zcomment
parameter_list|,
name|cstdin
parameter_list|)
name|pointer
name|puuconf
decl_stmt|;
name|int
name|icmd
decl_stmt|;
name|int
name|csystems
decl_stmt|;
name|char
modifier|*
modifier|*
name|pazsystems
decl_stmt|;
name|boolean
name|fnotsystems
decl_stmt|;
name|int
name|cusers
decl_stmt|;
name|char
modifier|*
modifier|*
name|pazusers
decl_stmt|;
name|boolean
name|fnotusers
decl_stmt|;
name|long
name|iold
decl_stmt|;
name|long
name|iyoung
decl_stmt|;
name|int
name|ccommands
decl_stmt|;
name|char
modifier|*
modifier|*
name|pazcommands
decl_stmt|;
name|boolean
name|fnotcommands
decl_stmt|;
specifier|const
name|char
modifier|*
name|zcomment
decl_stmt|;
name|int
name|cstdin
decl_stmt|;
block|{
name|boolean
name|fret
decl_stmt|;
name|int
name|i
decl_stmt|;
name|int
name|iuuconf
decl_stmt|;
name|struct
name|uuconf_system
name|ssys
decl_stmt|;
name|fret
operator|=
name|TRUE
expr_stmt|;
if|if
condition|(
name|csystems
operator|>
literal|0
operator|&&
operator|!
name|fnotsystems
condition|)
block|{
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|csystems
condition|;
name|i
operator|++
control|)
block|{
name|iuuconf
operator|=
name|uuconf_system_info
argument_list|(
name|puuconf
argument_list|,
name|pazsystems
index|[
name|i
index|]
argument_list|,
operator|&
name|ssys
argument_list|)
expr_stmt|;
if|if
condition|(
name|iuuconf
operator|!=
name|UUCONF_SUCCESS
condition|)
block|{
if|if
condition|(
name|iuuconf
operator|==
name|UUCONF_NOT_FOUND
condition|)
name|ulog
argument_list|(
name|LOG_ERROR
argument_list|,
literal|"%s: System not found"
argument_list|,
name|pazsystems
index|[
name|i
index|]
argument_list|)
expr_stmt|;
else|else
name|ulog_uuconf
argument_list|(
name|LOG_ERROR
argument_list|,
name|puuconf
argument_list|,
name|iuuconf
argument_list|)
expr_stmt|;
name|fret
operator|=
name|FALSE
expr_stmt|;
continue|continue;
block|}
if|if
condition|(
operator|!
name|fsworkfiles_system
argument_list|(
name|puuconf
argument_list|,
name|icmd
argument_list|,
operator|&
name|ssys
argument_list|,
name|cusers
argument_list|,
name|pazusers
argument_list|,
name|fnotusers
argument_list|,
name|iold
argument_list|,
name|iyoung
argument_list|,
name|ccommands
argument_list|,
name|pazcommands
argument_list|,
name|fnotcommands
argument_list|,
name|zcomment
argument_list|,
name|cstdin
argument_list|)
condition|)
name|fret
operator|=
name|FALSE
expr_stmt|;
operator|(
name|void
operator|)
name|uuconf_system_free
argument_list|(
name|puuconf
argument_list|,
operator|&
name|ssys
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
name|char
modifier|*
modifier|*
name|pznames
decl_stmt|,
modifier|*
modifier|*
name|pz
decl_stmt|;
name|iuuconf
operator|=
name|uuconf_system_names
argument_list|(
name|puuconf
argument_list|,
operator|&
name|pznames
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|iuuconf
operator|!=
name|UUCONF_SUCCESS
condition|)
block|{
name|ulog_uuconf
argument_list|(
name|LOG_ERROR
argument_list|,
name|puuconf
argument_list|,
name|iuuconf
argument_list|)
expr_stmt|;
return|return
name|FALSE
return|;
block|}
for|for
control|(
name|pz
operator|=
name|pznames
init|;
operator|*
name|pz
operator|!=
name|NULL
condition|;
name|pz
operator|++
control|)
block|{
if|if
condition|(
name|csystems
operator|>
literal|0
condition|)
block|{
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|csystems
condition|;
name|i
operator|++
control|)
if|if
condition|(
name|strcmp
argument_list|(
operator|*
name|pz
argument_list|,
name|pazsystems
index|[
name|i
index|]
argument_list|)
operator|==
literal|0
condition|)
break|break;
if|if
condition|(
name|i
operator|<
name|csystems
condition|)
continue|continue;
block|}
name|iuuconf
operator|=
name|uuconf_system_info
argument_list|(
name|puuconf
argument_list|,
operator|*
name|pz
argument_list|,
operator|&
name|ssys
argument_list|)
expr_stmt|;
if|if
condition|(
name|iuuconf
operator|!=
name|UUCONF_SUCCESS
condition|)
block|{
name|ulog_uuconf
argument_list|(
name|LOG_ERROR
argument_list|,
name|puuconf
argument_list|,
name|iuuconf
argument_list|)
expr_stmt|;
name|fret
operator|=
name|FALSE
expr_stmt|;
continue|continue;
block|}
if|if
condition|(
operator|!
name|fsworkfiles_system
argument_list|(
name|puuconf
argument_list|,
name|icmd
argument_list|,
operator|&
name|ssys
argument_list|,
name|cusers
argument_list|,
name|pazusers
argument_list|,
name|fnotusers
argument_list|,
name|iold
argument_list|,
name|iyoung
argument_list|,
name|ccommands
argument_list|,
name|pazcommands
argument_list|,
name|fnotcommands
argument_list|,
name|zcomment
argument_list|,
name|cstdin
argument_list|)
condition|)
name|fret
operator|=
name|FALSE
expr_stmt|;
operator|(
name|void
operator|)
name|uuconf_system_free
argument_list|(
name|puuconf
argument_list|,
operator|&
name|ssys
argument_list|)
expr_stmt|;
name|xfree
argument_list|(
operator|(
name|pointer
operator|)
operator|*
name|pz
argument_list|)
expr_stmt|;
block|}
name|xfree
argument_list|(
operator|(
name|pointer
operator|)
name|pznames
argument_list|)
expr_stmt|;
block|}
return|return
name|fret
return|;
block|}
end_function

begin_comment
comment|/* Look at the work files for a particular system.  */
end_comment

begin_function
specifier|static
name|boolean
name|fsworkfiles_system
parameter_list|(
name|puuconf
parameter_list|,
name|icmd
parameter_list|,
name|qsys
parameter_list|,
name|cusers
parameter_list|,
name|pazusers
parameter_list|,
name|fnotusers
parameter_list|,
name|iold
parameter_list|,
name|iyoung
parameter_list|,
name|ccommands
parameter_list|,
name|pazcommands
parameter_list|,
name|fnotcommands
parameter_list|,
name|zcomment
parameter_list|,
name|cstdin
parameter_list|)
name|pointer
name|puuconf
decl_stmt|;
name|int
name|icmd
decl_stmt|;
specifier|const
name|struct
name|uuconf_system
modifier|*
name|qsys
decl_stmt|;
name|int
name|cusers
decl_stmt|;
name|char
modifier|*
modifier|*
name|pazusers
decl_stmt|;
name|boolean
name|fnotusers
decl_stmt|;
name|long
name|iold
decl_stmt|;
name|long
name|iyoung
decl_stmt|;
name|int
name|ccommands
decl_stmt|;
name|char
modifier|*
modifier|*
name|pazcommands
decl_stmt|;
name|boolean
name|fnotcommands
decl_stmt|;
specifier|const
name|char
modifier|*
name|zcomment
decl_stmt|;
name|int
name|cstdin
decl_stmt|;
block|{
name|boolean
name|fret
decl_stmt|;
if|if
condition|(
operator|!
name|fsysdep_get_work_init
argument_list|(
name|qsys
argument_list|,
name|UUCONF_GRADE_LOW
argument_list|)
condition|)
return|return
name|FALSE
return|;
while|while
condition|(
name|TRUE
condition|)
block|{
name|struct
name|scmd
name|s
decl_stmt|;
name|long
name|itime
decl_stmt|;
if|if
condition|(
operator|!
name|fsysdep_get_work
argument_list|(
name|qsys
argument_list|,
name|UUCONF_GRADE_LOW
argument_list|,
operator|&
name|s
argument_list|)
condition|)
block|{
name|usysdep_get_work_free
argument_list|(
name|qsys
argument_list|)
expr_stmt|;
return|return
name|FALSE
return|;
block|}
if|if
condition|(
name|s
operator|.
name|bcmd
operator|==
literal|'H'
condition|)
break|break;
if|if
condition|(
name|cusers
operator|>
literal|0
condition|)
block|{
name|boolean
name|fmatch
decl_stmt|;
name|int
name|i
decl_stmt|;
name|fmatch
operator|=
name|fnotusers
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|cusers
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|s
operator|.
name|zuser
operator|!=
name|NULL
operator|&&
name|strcmp
argument_list|(
name|pazusers
index|[
name|i
index|]
argument_list|,
name|s
operator|.
name|zuser
argument_list|)
operator|==
literal|0
condition|)
block|{
name|fmatch
operator|=
operator|!
name|fmatch
expr_stmt|;
break|break;
block|}
block|}
if|if
condition|(
operator|!
name|fmatch
condition|)
continue|continue;
block|}
name|itime
operator|=
name|ixsysdep_work_time
argument_list|(
name|qsys
argument_list|,
name|s
operator|.
name|pseq
argument_list|)
expr_stmt|;
if|if
condition|(
name|iold
operator|!=
operator|(
name|long
operator|)
operator|-
literal|1
operator|&&
name|itime
operator|>
name|iold
condition|)
continue|continue;
if|if
condition|(
name|iyoung
operator|!=
operator|(
name|long
operator|)
operator|-
literal|1
operator|&&
name|itime
operator|<
name|iyoung
condition|)
continue|continue;
if|if
condition|(
operator|!
name|fsworkfile_show
argument_list|(
name|puuconf
argument_list|,
name|icmd
argument_list|,
name|qsys
argument_list|,
operator|&
name|s
argument_list|,
name|itime
argument_list|,
name|ccommands
argument_list|,
name|pazcommands
argument_list|,
name|fnotcommands
argument_list|,
name|zcomment
argument_list|,
name|cstdin
argument_list|)
condition|)
block|{
name|usysdep_get_work_free
argument_list|(
name|qsys
argument_list|)
expr_stmt|;
return|return
name|FALSE
return|;
block|}
block|}
name|fret
operator|=
name|fsworkfile_show
argument_list|(
name|puuconf
argument_list|,
name|icmd
argument_list|,
name|qsys
argument_list|,
operator|(
specifier|const
expr|struct
name|scmd
operator|*
operator|)
name|NULL
argument_list|,
literal|0L
argument_list|,
name|ccommands
argument_list|,
name|pazcommands
argument_list|,
name|fnotcommands
argument_list|,
name|zcomment
argument_list|,
name|cstdin
argument_list|)
expr_stmt|;
name|usysdep_get_work_free
argument_list|(
name|qsys
argument_list|)
expr_stmt|;
return|return
name|fret
return|;
block|}
end_function

begin_comment
comment|/* Show a single workfile.  This is actually called once for each line    in the workfile, so we accumulate the lines and show them all at    once.  This lets us show an execution in a useful fashion.  */
end_comment

begin_function
specifier|static
name|boolean
name|fsworkfile_show
parameter_list|(
name|puuconf
parameter_list|,
name|icmd
parameter_list|,
name|qsys
parameter_list|,
name|qcmd
parameter_list|,
name|itime
parameter_list|,
name|ccommands
parameter_list|,
name|pazcommands
parameter_list|,
name|fnotcommands
parameter_list|,
name|zcomment
parameter_list|,
name|cstdin
parameter_list|)
name|pointer
name|puuconf
decl_stmt|;
name|int
name|icmd
decl_stmt|;
specifier|const
name|struct
name|uuconf_system
modifier|*
name|qsys
decl_stmt|;
specifier|const
name|struct
name|scmd
modifier|*
name|qcmd
decl_stmt|;
name|long
name|itime
decl_stmt|;
name|int
name|ccommands
decl_stmt|;
name|char
modifier|*
modifier|*
name|pazcommands
decl_stmt|;
name|boolean
name|fnotcommands
decl_stmt|;
specifier|const
name|char
modifier|*
name|zcomment
decl_stmt|;
name|int
name|cstdin
decl_stmt|;
block|{
specifier|static
name|struct
name|scmdlist
modifier|*
name|qlist
decl_stmt|;
specifier|static
name|char
modifier|*
name|zlistid
decl_stmt|;
name|char
modifier|*
name|zid
decl_stmt|;
if|if
condition|(
name|qcmd
operator|==
name|NULL
condition|)
name|zid
operator|=
name|NULL
expr_stmt|;
else|else
block|{
name|zid
operator|=
name|zsysdep_jobid
argument_list|(
name|qsys
argument_list|,
name|qcmd
operator|->
name|pseq
argument_list|)
expr_stmt|;
if|if
condition|(
name|zid
operator|==
name|NULL
condition|)
return|return
name|FALSE
return|;
block|}
comment|/* If this is the same jobid as the list, put it on the end.  */
if|if
condition|(
name|qcmd
operator|!=
name|NULL
operator|&&
name|qlist
operator|!=
name|NULL
operator|&&
name|strcmp
argument_list|(
name|zlistid
argument_list|,
name|zid
argument_list|)
operator|==
literal|0
condition|)
block|{
name|struct
name|scmdlist
modifier|*
name|qnew
decl_stmt|,
modifier|*
modifier|*
name|pq
decl_stmt|;
name|ubuffree
argument_list|(
name|zid
argument_list|)
expr_stmt|;
name|qnew
operator|=
operator|(
expr|struct
name|scmdlist
operator|*
operator|)
name|xmalloc
argument_list|(
sizeof|sizeof
argument_list|(
expr|struct
name|scmdlist
argument_list|)
argument_list|)
expr_stmt|;
name|qnew
operator|->
name|qnext
operator|=
name|NULL
expr_stmt|;
name|qnew
operator|->
name|s
operator|=
operator|*
name|qcmd
expr_stmt|;
name|qnew
operator|->
name|itime
operator|=
name|itime
expr_stmt|;
for|for
control|(
name|pq
operator|=
operator|&
name|qlist
init|;
operator|*
name|pq
operator|!=
name|NULL
condition|;
name|pq
operator|=
operator|&
operator|(
operator|*
name|pq
operator|)
operator|->
name|qnext
control|)
empty_stmt|;
operator|*
name|pq
operator|=
name|qnew
expr_stmt|;
return|return
name|TRUE
return|;
block|}
comment|/* Here we have found a different job ID, so we print the scmd      structures that we have accumulated.  We look for the special      case of an execution (an E command, or one of the destination      files begins with X.).  We could be more clever about other      situations as well.  */
if|if
condition|(
name|qlist
operator|!=
name|NULL
condition|)
block|{
name|boolean
name|fmatch
decl_stmt|;
specifier|const
name|char
modifier|*
name|zprog
decl_stmt|,
modifier|*
name|zcmd
decl_stmt|,
modifier|*
name|zrequestor
decl_stmt|,
modifier|*
name|zstdin
decl_stmt|;
name|char
modifier|*
name|zfree
decl_stmt|;
name|struct
name|scmdlist
modifier|*
name|qxqt
decl_stmt|;
name|FILE
modifier|*
name|exqt
init|=
name|NULL
decl_stmt|;
name|struct
name|scmdlist
modifier|*
name|qfree
decl_stmt|;
name|fmatch
operator|=
name|FALSE
expr_stmt|;
name|zprog
operator|=
name|zcmd
operator|=
name|zrequestor
operator|=
name|zstdin
operator|=
name|NULL
expr_stmt|;
name|zfree
operator|=
name|NULL
expr_stmt|;
for|for
control|(
name|qxqt
operator|=
name|qlist
init|;
name|qxqt
operator|!=
name|NULL
condition|;
name|qxqt
operator|=
name|qxqt
operator|->
name|qnext
control|)
block|{
if|if
condition|(
name|qxqt
operator|->
name|s
operator|.
name|bcmd
operator|==
literal|'E'
condition|)
break|break;
if|if
condition|(
name|qxqt
operator|->
name|s
operator|.
name|bcmd
operator|==
literal|'S'
operator|&&
name|qxqt
operator|->
name|s
operator|.
name|zto
index|[
literal|0
index|]
operator|==
literal|'X'
operator|&&
name|qxqt
operator|->
name|s
operator|.
name|zto
index|[
literal|1
index|]
operator|==
literal|'.'
operator|&&
name|fspool_file
argument_list|(
name|qxqt
operator|->
name|s
operator|.
name|zfrom
argument_list|)
condition|)
block|{
name|char
modifier|*
name|zxqt
decl_stmt|;
comment|/* Open the file now, so that, if it does not exist, we                  can still report sensibly (the qxqt == NULL case) on                  any other files that may exist.  */
name|zxqt
operator|=
name|zsysdep_spool_file_name
argument_list|(
name|qsys
argument_list|,
name|qxqt
operator|->
name|s
operator|.
name|zfrom
argument_list|,
name|qxqt
operator|->
name|s
operator|.
name|pseq
argument_list|)
expr_stmt|;
if|if
condition|(
name|zxqt
operator|==
name|NULL
condition|)
return|return
name|FALSE
return|;
name|exqt
operator|=
name|fopen
argument_list|(
name|zxqt
argument_list|,
literal|"r"
argument_list|)
expr_stmt|;
name|ubuffree
argument_list|(
name|zxqt
argument_list|)
expr_stmt|;
if|if
condition|(
name|exqt
operator|!=
name|NULL
condition|)
break|break;
block|}
block|}
if|if
condition|(
name|qxqt
operator|==
name|NULL
condition|)
block|{
if|if
condition|(
name|ccommands
operator|==
literal|0
operator|||
operator|(
name|fnotcommands
operator|&&
name|strcmp
argument_list|(
name|pazcommands
index|[
literal|0
index|]
argument_list|,
literal|"ALL"
argument_list|)
operator|==
literal|0
operator|)
condition|)
block|{
comment|/* Show all the lines in a regular work file.  */
name|fmatch
operator|=
name|TRUE
expr_stmt|;
if|if
condition|(
operator|(
name|icmd
operator|&
name|JOB_SHOW
operator|)
operator|!=
literal|0
condition|)
block|{
name|struct
name|scmdlist
modifier|*
name|qshow
decl_stmt|;
for|for
control|(
name|qshow
operator|=
name|qlist
init|;
name|qshow
operator|!=
name|NULL
condition|;
name|qshow
operator|=
name|qshow
operator|->
name|qnext
control|)
block|{
name|char
modifier|*
name|zfile
decl_stmt|;
name|long
name|cbytes
decl_stmt|;
name|usworkfile_header
argument_list|(
name|qsys
argument_list|,
operator|&
name|qshow
operator|->
name|s
argument_list|,
name|zlistid
argument_list|,
name|qshow
operator|->
name|itime
argument_list|,
name|qshow
operator|==
name|qlist
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|qshow
operator|->
name|s
operator|.
name|bcmd
condition|)
block|{
case|case
literal|'S'
case|:
if|if
condition|(
name|strchr
argument_list|(
name|qshow
operator|->
name|s
operator|.
name|zoptions
argument_list|,
literal|'C'
argument_list|)
operator|!=
name|NULL
operator|||
name|fspool_file
argument_list|(
name|qshow
operator|->
name|s
operator|.
name|zfrom
argument_list|)
condition|)
name|zfile
operator|=
name|zsysdep_spool_file_name
argument_list|(
name|qsys
argument_list|,
name|qshow
operator|->
name|s
operator|.
name|ztemp
argument_list|,
name|qshow
operator|->
name|s
operator|.
name|pseq
argument_list|)
expr_stmt|;
else|else
name|zfile
operator|=
name|zbufcpy
argument_list|(
name|qshow
operator|->
name|s
operator|.
name|zfrom
argument_list|)
expr_stmt|;
if|if
condition|(
name|zfile
operator|==
name|NULL
condition|)
name|cbytes
operator|=
operator|-
literal|1
expr_stmt|;
else|else
name|cbytes
operator|=
name|csysdep_size
argument_list|(
name|zfile
argument_list|)
expr_stmt|;
if|if
condition|(
name|cbytes
operator|>=
literal|0
condition|)
name|printf
argument_list|(
literal|"Sending %s (%ld bytes) to %s"
argument_list|,
name|qshow
operator|->
name|s
operator|.
name|zfrom
argument_list|,
name|cbytes
argument_list|,
name|qshow
operator|->
name|s
operator|.
name|zto
argument_list|)
expr_stmt|;
name|ubuffree
argument_list|(
name|zfile
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'R'
case|:
name|printf
argument_list|(
literal|"Requesting %s to %s"
argument_list|,
name|qshow
operator|->
name|s
operator|.
name|zfrom
argument_list|,
name|qshow
operator|->
name|s
operator|.
name|zto
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'X'
case|:
name|printf
argument_list|(
literal|"Requesting %s to %s"
argument_list|,
name|qshow
operator|->
name|s
operator|.
name|zfrom
argument_list|,
name|qshow
operator|->
name|s
operator|.
name|zto
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'P'
case|:
name|printf
argument_list|(
literal|"(poll file)"
argument_list|)
expr_stmt|;
break|break;
if|#
directive|if
name|DEBUG
operator|>
literal|0
default|default:
name|printf
argument_list|(
literal|"Bad line %d"
argument_list|,
name|qshow
operator|->
name|s
operator|.
name|bcmd
argument_list|)
expr_stmt|;
break|break;
endif|#
directive|endif
block|}
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
block|}
block|}
block|}
block|}
else|else
block|{
name|long
name|csize
decl_stmt|;
name|struct
name|scmdlist
modifier|*
name|qsize
decl_stmt|;
comment|/* Show the command for an execution file.  */
if|if
condition|(
name|qxqt
operator|->
name|s
operator|.
name|bcmd
operator|==
literal|'E'
condition|)
block|{
name|zfree
operator|=
name|zbufcpy
argument_list|(
name|qxqt
operator|->
name|s
operator|.
name|zcmd
argument_list|)
expr_stmt|;
name|zfree
index|[
name|strcspn
argument_list|(
name|zfree
argument_list|,
literal|" \t"
argument_list|)
index|]
operator|=
literal|'\0'
expr_stmt|;
name|zprog
operator|=
name|zfree
expr_stmt|;
name|zcmd
operator|=
name|qxqt
operator|->
name|s
operator|.
name|zcmd
expr_stmt|;
if|if
condition|(
name|strchr
argument_list|(
name|qxqt
operator|->
name|s
operator|.
name|zoptions
argument_list|,
literal|'R'
argument_list|)
operator|!=
name|NULL
condition|)
name|zrequestor
operator|=
name|qxqt
operator|->
name|s
operator|.
name|znotify
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
operator|!
name|fsxqt_file_read
argument_list|(
name|puuconf
argument_list|,
name|exqt
argument_list|)
condition|)
block|{
operator|(
name|void
operator|)
name|fclose
argument_list|(
name|exqt
argument_list|)
expr_stmt|;
return|return
name|FALSE
return|;
block|}
operator|(
name|void
operator|)
name|fclose
argument_list|(
name|exqt
argument_list|)
expr_stmt|;
name|zprog
operator|=
name|zSxqt_prog
expr_stmt|;
name|zcmd
operator|=
name|zSxqt_cmd
expr_stmt|;
name|zrequestor
operator|=
name|zSxqt_requestor
expr_stmt|;
block|}
name|csize
operator|=
literal|0L
expr_stmt|;
for|for
control|(
name|qsize
operator|=
name|qlist
init|;
name|qsize
operator|!=
name|NULL
condition|;
name|qsize
operator|=
name|qsize
operator|->
name|qnext
control|)
block|{
if|if
condition|(
name|qsize
operator|->
name|s
operator|.
name|bcmd
operator|==
literal|'S'
operator|||
name|qsize
operator|->
name|s
operator|.
name|bcmd
operator|==
literal|'E'
condition|)
block|{
name|char
modifier|*
name|zfile
decl_stmt|;
if|if
condition|(
name|strchr
argument_list|(
name|qsize
operator|->
name|s
operator|.
name|zoptions
argument_list|,
literal|'C'
argument_list|)
operator|!=
name|NULL
operator|||
name|fspool_file
argument_list|(
name|qsize
operator|->
name|s
operator|.
name|zfrom
argument_list|)
condition|)
name|zfile
operator|=
name|zsysdep_spool_file_name
argument_list|(
name|qsys
argument_list|,
name|qsize
operator|->
name|s
operator|.
name|ztemp
argument_list|,
name|qsize
operator|->
name|s
operator|.
name|pseq
argument_list|)
expr_stmt|;
else|else
name|zfile
operator|=
name|zbufcpy
argument_list|(
name|qsize
operator|->
name|s
operator|.
name|zfrom
argument_list|)
expr_stmt|;
if|if
condition|(
name|zfile
operator|!=
name|NULL
condition|)
block|{
name|long
name|cbytes
decl_stmt|;
name|cbytes
operator|=
name|csysdep_size
argument_list|(
name|zfile
argument_list|)
expr_stmt|;
if|if
condition|(
name|cbytes
operator|>
literal|0
condition|)
name|csize
operator|+=
name|cbytes
expr_stmt|;
name|ubuffree
argument_list|(
name|zfile
argument_list|)
expr_stmt|;
block|}
block|}
block|}
if|if
condition|(
name|ccommands
operator|==
literal|0
condition|)
name|fmatch
operator|=
name|TRUE
expr_stmt|;
else|else
block|{
name|int
name|i
decl_stmt|;
name|fmatch
operator|=
name|fnotcommands
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|ccommands
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|strcmp
argument_list|(
name|pazcommands
index|[
name|i
index|]
argument_list|,
literal|"ALL"
argument_list|)
operator|==
literal|0
operator|||
name|strcmp
argument_list|(
name|pazcommands
index|[
name|i
index|]
argument_list|,
name|zprog
argument_list|)
operator|==
literal|0
condition|)
block|{
name|fmatch
operator|=
operator|!
name|fmatch
expr_stmt|;
break|break;
block|}
block|}
block|}
comment|/* To get the name of the standard input file on this system 	     we have to look through the list of file transfers to 	     find the right one on the remote system.  */
if|if
condition|(
name|fmatch
condition|)
block|{
name|struct
name|scmdlist
modifier|*
name|qstdin
decl_stmt|;
if|if
condition|(
name|qxqt
operator|->
name|s
operator|.
name|bcmd
operator|==
literal|'E'
condition|)
name|qstdin
operator|=
name|qxqt
expr_stmt|;
elseif|else
if|if
condition|(
name|zSxqt_stdin
operator|!=
name|NULL
condition|)
block|{
for|for
control|(
name|qstdin
operator|=
name|qlist
init|;
name|qstdin
operator|!=
name|NULL
condition|;
name|qstdin
operator|=
name|qstdin
operator|->
name|qnext
control|)
if|if
condition|(
name|qstdin
operator|->
name|s
operator|.
name|bcmd
operator|==
literal|'S'
operator|&&
name|strcmp
argument_list|(
name|qstdin
operator|->
name|s
operator|.
name|zto
argument_list|,
name|zSxqt_stdin
argument_list|)
operator|==
literal|0
condition|)
break|break;
block|}
else|else
name|qstdin
operator|=
name|NULL
expr_stmt|;
if|if
condition|(
name|qstdin
operator|!=
name|NULL
condition|)
block|{
if|if
condition|(
name|strchr
argument_list|(
name|qstdin
operator|->
name|s
operator|.
name|zoptions
argument_list|,
literal|'C'
argument_list|)
operator|!=
name|NULL
operator|||
name|fspool_file
argument_list|(
name|qstdin
operator|->
name|s
operator|.
name|zfrom
argument_list|)
condition|)
name|zstdin
operator|=
name|qstdin
operator|->
name|s
operator|.
name|ztemp
expr_stmt|;
else|else
name|zstdin
operator|=
name|qstdin
operator|->
name|s
operator|.
name|zfrom
expr_stmt|;
block|}
block|}
if|if
condition|(
name|fmatch
operator|&&
operator|(
name|icmd
operator|&
name|JOB_SHOW
operator|)
operator|!=
literal|0
condition|)
block|{
name|usworkfile_header
argument_list|(
name|qsys
argument_list|,
operator|&
name|qxqt
operator|->
name|s
argument_list|,
name|zlistid
argument_list|,
name|qxqt
operator|->
name|itime
argument_list|,
name|TRUE
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Executing %s (sending %ld bytes)\n"
argument_list|,
name|zcmd
argument_list|,
name|csize
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
name|fmatch
condition|)
block|{
name|boolean
name|fkill_or_rejuv
decl_stmt|;
name|fkill_or_rejuv
operator|=
name|FALSE
expr_stmt|;
if|if
condition|(
operator|(
name|icmd
operator|&
name|JOB_INQUIRE
operator|)
operator|!=
literal|0
condition|)
block|{
name|int
name|b
decl_stmt|;
comment|/* Ask stdin whether this job should be killed.  */
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"%s: %s %s? "
argument_list|,
name|zProgram
argument_list|,
operator|(
name|icmd
operator|&
name|JOB_REJUVENATE
operator|)
operator|!=
literal|0
condition|?
literal|"Rejuvenate"
else|:
literal|"Kill"
argument_list|,
name|zlistid
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|fflush
argument_list|(
name|stderr
argument_list|)
expr_stmt|;
name|b
operator|=
name|getchar
argument_list|()
expr_stmt|;
name|fkill_or_rejuv
operator|=
name|b
operator|==
literal|'y'
operator|||
name|b
operator|==
literal|'Y'
expr_stmt|;
while|while
condition|(
name|b
operator|!=
name|EOF
operator|&&
name|b
operator|!=
literal|'\n'
condition|)
name|b
operator|=
name|getchar
argument_list|()
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|(
name|icmd
operator|&
name|JOB_KILL
operator|)
operator|!=
literal|0
operator|||
operator|(
name|icmd
operator|&
name|JOB_REJUVENATE
operator|)
operator|!=
literal|0
condition|)
name|fkill_or_rejuv
operator|=
name|TRUE
expr_stmt|;
if|if
condition|(
name|fkill_or_rejuv
operator|&&
operator|(
name|qlist
operator|->
name|s
operator|.
name|zuser
operator|==
name|NULL
operator|||
name|strcmp
argument_list|(
name|zsysdep_login_name
argument_list|()
argument_list|,
name|qlist
operator|->
name|s
operator|.
name|zuser
argument_list|)
operator|!=
literal|0
operator|)
operator|&&
operator|!
name|fsysdep_privileged
argument_list|()
condition|)
name|ulog
argument_list|(
name|LOG_ERROR
argument_list|,
literal|"%s: Not submitted by you"
argument_list|,
name|zlistid
argument_list|)
expr_stmt|;
else|else
block|{
if|if
condition|(
operator|(
name|icmd
operator|&
operator|(
name|JOB_MAIL
operator||
name|JOB_NOTIFY
operator|)
operator|)
operator|!=
literal|0
condition|)
block|{
if|if
condition|(
operator|!
name|fsnotify
argument_list|(
name|puuconf
argument_list|,
name|icmd
argument_list|,
name|zcomment
argument_list|,
name|cstdin
argument_list|,
operator|(
name|fkill_or_rejuv
operator|&&
operator|(
name|icmd
operator|&
name|JOB_REJUVENATE
operator|)
operator|==
literal|0
operator|)
argument_list|,
name|zcmd
argument_list|,
name|qlist
argument_list|,
name|zlistid
argument_list|,
name|qlist
operator|->
name|itime
argument_list|,
name|qlist
operator|->
name|s
operator|.
name|zuser
argument_list|,
name|qsys
argument_list|,
name|zstdin
argument_list|,
name|qlist
operator|->
name|s
operator|.
name|pseq
argument_list|,
name|zrequestor
argument_list|)
condition|)
return|return
name|FALSE
return|;
block|}
if|if
condition|(
name|fkill_or_rejuv
condition|)
block|{
if|if
condition|(
operator|(
name|icmd
operator|&
name|JOB_REJUVENATE
operator|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
operator|!
name|fsysdep_kill_job
argument_list|(
name|puuconf
argument_list|,
name|zlistid
argument_list|)
condition|)
return|return
name|FALSE
return|;
block|}
else|else
block|{
if|if
condition|(
operator|!
name|fsysdep_rejuvenate_job
argument_list|(
name|puuconf
argument_list|,
name|zlistid
argument_list|)
condition|)
return|return
name|FALSE
return|;
block|}
block|}
block|}
block|}
if|if
condition|(
name|qxqt
operator|!=
name|NULL
condition|)
block|{
if|if
condition|(
name|qxqt
operator|->
name|s
operator|.
name|bcmd
operator|==
literal|'E'
condition|)
name|ubuffree
argument_list|(
name|zfree
argument_list|)
expr_stmt|;
else|else
name|usxqt_file_free
argument_list|()
expr_stmt|;
block|}
comment|/* Free up the list of entries.  */
name|qfree
operator|=
name|qlist
expr_stmt|;
while|while
condition|(
name|qfree
operator|!=
name|NULL
condition|)
block|{
name|struct
name|scmdlist
modifier|*
name|qnext
decl_stmt|;
name|qnext
operator|=
name|qfree
operator|->
name|qnext
expr_stmt|;
name|xfree
argument_list|(
operator|(
name|pointer
operator|)
name|qfree
argument_list|)
expr_stmt|;
name|qfree
operator|=
name|qnext
expr_stmt|;
block|}
name|ubuffree
argument_list|(
name|zlistid
argument_list|)
expr_stmt|;
name|qlist
operator|=
name|NULL
expr_stmt|;
name|zlistid
operator|=
name|NULL
expr_stmt|;
block|}
comment|/* Start a new list with the entry we just got.  */
if|if
condition|(
name|qcmd
operator|!=
name|NULL
condition|)
block|{
name|qlist
operator|=
operator|(
expr|struct
name|scmdlist
operator|*
operator|)
name|xmalloc
argument_list|(
sizeof|sizeof
argument_list|(
expr|struct
name|scmdlist
argument_list|)
argument_list|)
expr_stmt|;
name|qlist
operator|->
name|qnext
operator|=
name|NULL
expr_stmt|;
name|qlist
operator|->
name|s
operator|=
operator|*
name|qcmd
expr_stmt|;
name|qlist
operator|->
name|itime
operator|=
name|itime
expr_stmt|;
name|zlistid
operator|=
name|zid
expr_stmt|;
block|}
return|return
name|TRUE
return|;
block|}
end_function

begin_comment
comment|/* Show the header of the line describing a workfile.  */
end_comment

begin_function
specifier|static
name|void
name|usworkfile_header
parameter_list|(
name|qsys
parameter_list|,
name|qcmd
parameter_list|,
name|zjobid
parameter_list|,
name|itime
parameter_list|,
name|ffirst
parameter_list|)
specifier|const
name|struct
name|uuconf_system
modifier|*
name|qsys
decl_stmt|;
specifier|const
name|struct
name|scmd
modifier|*
name|qcmd
decl_stmt|;
specifier|const
name|char
modifier|*
name|zjobid
decl_stmt|;
name|long
name|itime
decl_stmt|;
name|boolean
name|ffirst
decl_stmt|;
block|{
specifier|const
name|char
modifier|*
name|zshowid
decl_stmt|;
name|struct
name|tm
name|stime
decl_stmt|;
if|if
condition|(
name|ffirst
condition|)
name|zshowid
operator|=
name|zjobid
expr_stmt|;
else|else
name|zshowid
operator|=
literal|"-"
expr_stmt|;
name|printf
argument_list|(
literal|"%s %s %s "
argument_list|,
name|zshowid
argument_list|,
name|qsys
operator|->
name|uuconf_zname
argument_list|,
name|qcmd
operator|->
name|zuser
operator|!=
name|NULL
condition|?
name|qcmd
operator|->
name|zuser
else|:
name|OWNER
argument_list|)
expr_stmt|;
name|usysdep_localtime
argument_list|(
name|itime
argument_list|,
operator|&
name|stime
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"%02d-%02d %02d:%02d "
argument_list|,
name|stime
operator|.
name|tm_mon
operator|+
literal|1
argument_list|,
name|stime
operator|.
name|tm_mday
argument_list|,
name|stime
operator|.
name|tm_hour
argument_list|,
name|stime
operator|.
name|tm_min
argument_list|)
expr_stmt|;
block|}
end_function

begin_escape
end_escape

begin_comment
comment|/* List queued executions that have not been processed by uuxqt for    one reason or another.  */
end_comment

begin_function
specifier|static
name|boolean
name|fsexecutions
parameter_list|(
name|puuconf
parameter_list|,
name|icmd
parameter_list|,
name|csystems
parameter_list|,
name|pazsystems
parameter_list|,
name|fnotsystems
parameter_list|,
name|cusers
parameter_list|,
name|pazusers
parameter_list|,
name|fnotusers
parameter_list|,
name|iold
parameter_list|,
name|iyoung
parameter_list|,
name|ccommands
parameter_list|,
name|pazcommands
parameter_list|,
name|fnotcommands
parameter_list|,
name|zcomment
parameter_list|,
name|cstdin
parameter_list|)
name|pointer
name|puuconf
decl_stmt|;
name|int
name|icmd
decl_stmt|;
name|int
name|csystems
decl_stmt|;
name|char
modifier|*
modifier|*
name|pazsystems
decl_stmt|;
name|boolean
name|fnotsystems
decl_stmt|;
name|int
name|cusers
decl_stmt|;
name|char
modifier|*
modifier|*
name|pazusers
decl_stmt|;
name|boolean
name|fnotusers
decl_stmt|;
name|long
name|iold
decl_stmt|;
name|long
name|iyoung
decl_stmt|;
name|int
name|ccommands
decl_stmt|;
name|char
modifier|*
modifier|*
name|pazcommands
decl_stmt|;
name|boolean
name|fnotcommands
decl_stmt|;
specifier|const
name|char
modifier|*
name|zcomment
decl_stmt|;
name|int
name|cstdin
decl_stmt|;
block|{
specifier|const
name|char
modifier|*
name|zlocalname
decl_stmt|;
name|int
name|iuuconf
decl_stmt|;
name|char
modifier|*
name|zfile
decl_stmt|;
name|char
modifier|*
name|zsystem
decl_stmt|;
name|boolean
name|ferr
decl_stmt|;
name|iuuconf
operator|=
name|uuconf_localname
argument_list|(
name|puuconf
argument_list|,
operator|&
name|zlocalname
argument_list|)
expr_stmt|;
if|if
condition|(
name|iuuconf
operator|==
name|UUCONF_NOT_FOUND
condition|)
block|{
name|zlocalname
operator|=
name|zsysdep_localname
argument_list|()
expr_stmt|;
if|if
condition|(
name|zlocalname
operator|==
name|NULL
condition|)
return|return
name|FALSE
return|;
block|}
elseif|else
if|if
condition|(
name|iuuconf
operator|!=
name|UUCONF_SUCCESS
condition|)
block|{
name|ulog_uuconf
argument_list|(
name|LOG_ERROR
argument_list|,
name|puuconf
argument_list|,
name|iuuconf
argument_list|)
expr_stmt|;
return|return
name|FALSE
return|;
block|}
if|if
condition|(
operator|!
name|fsysdep_get_xqt_init
argument_list|(
operator|(
specifier|const
name|char
operator|*
operator|)
name|NULL
argument_list|)
condition|)
return|return
name|FALSE
return|;
while|while
condition|(
operator|(
name|zfile
operator|=
name|zsysdep_get_xqt
argument_list|(
operator|(
specifier|const
name|char
operator|*
operator|)
name|NULL
argument_list|,
operator|&
name|zsystem
argument_list|,
operator|&
name|ferr
argument_list|)
operator|)
operator|!=
name|NULL
condition|)
block|{
name|boolean
name|fmatch
decl_stmt|;
name|int
name|i
decl_stmt|;
name|long
name|itime
decl_stmt|;
name|FILE
modifier|*
name|e
decl_stmt|;
if|if
condition|(
name|csystems
operator|>
literal|0
condition|)
block|{
name|fmatch
operator|=
name|fnotsystems
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|csystems
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|strcmp
argument_list|(
name|pazsystems
index|[
name|i
index|]
argument_list|,
name|zsystem
argument_list|)
operator|==
literal|0
condition|)
block|{
name|fmatch
operator|=
operator|!
name|fmatch
expr_stmt|;
break|break;
block|}
block|}
if|if
condition|(
operator|!
name|fmatch
condition|)
block|{
name|ubuffree
argument_list|(
name|zfile
argument_list|)
expr_stmt|;
name|ubuffree
argument_list|(
name|zsystem
argument_list|)
expr_stmt|;
continue|continue;
block|}
block|}
name|itime
operator|=
name|ixsysdep_file_time
argument_list|(
name|zfile
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|iold
operator|!=
operator|(
name|long
operator|)
operator|-
literal|1
operator|&&
name|itime
operator|>
name|iold
operator|)
operator|||
operator|(
name|iyoung
operator|!=
operator|(
name|long
operator|)
operator|-
literal|1
operator|&&
name|itime
operator|<
name|iyoung
operator|)
condition|)
block|{
name|ubuffree
argument_list|(
name|zfile
argument_list|)
expr_stmt|;
name|ubuffree
argument_list|(
name|zsystem
argument_list|)
expr_stmt|;
continue|continue;
block|}
comment|/* We need to read the execution file before we can check the 	 user name.  */
name|e
operator|=
name|fopen
argument_list|(
name|zfile
argument_list|,
literal|"r"
argument_list|)
expr_stmt|;
if|if
condition|(
name|e
operator|==
name|NULL
condition|)
block|{
comment|/* Probably uucico just deleted the file.  */
continue|continue;
block|}
if|if
condition|(
operator|!
name|fsxqt_file_read
argument_list|(
name|puuconf
argument_list|,
name|e
argument_list|)
condition|)
block|{
operator|(
name|void
operator|)
name|fclose
argument_list|(
name|e
argument_list|)
expr_stmt|;
name|ubuffree
argument_list|(
name|zfile
argument_list|)
expr_stmt|;
name|ubuffree
argument_list|(
name|zsystem
argument_list|)
expr_stmt|;
continue|continue;
block|}
operator|(
name|void
operator|)
name|fclose
argument_list|(
name|e
argument_list|)
expr_stmt|;
if|if
condition|(
name|cusers
operator|==
literal|0
condition|)
name|fmatch
operator|=
name|TRUE
expr_stmt|;
else|else
block|{
name|fmatch
operator|=
name|fnotusers
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|cusers
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|strcmp
argument_list|(
name|zSxqt_user
argument_list|,
name|pazusers
index|[
name|i
index|]
argument_list|)
operator|==
literal|0
operator|||
operator|(
name|zSxqt_requestor
operator|!=
name|NULL
operator|&&
name|strcmp
argument_list|(
name|zSxqt_requestor
argument_list|,
name|pazusers
index|[
name|i
index|]
argument_list|)
operator|==
literal|0
operator|)
condition|)
block|{
name|fmatch
operator|=
operator|!
name|fmatch
expr_stmt|;
break|break;
block|}
block|}
block|}
if|if
condition|(
name|fmatch
operator|&&
name|ccommands
operator|>
literal|0
condition|)
block|{
name|fmatch
operator|=
name|fnotcommands
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|ccommands
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|strcmp
argument_list|(
name|pazcommands
index|[
name|i
index|]
argument_list|,
literal|"ALL"
argument_list|)
operator|==
literal|0
operator|||
name|strcmp
argument_list|(
name|pazcommands
index|[
name|i
index|]
argument_list|,
name|zSxqt_prog
argument_list|)
operator|==
literal|0
condition|)
block|{
name|fmatch
operator|=
operator|!
name|fmatch
expr_stmt|;
break|break;
block|}
block|}
block|}
if|if
condition|(
name|fmatch
condition|)
block|{
name|boolean
name|fbad
decl_stmt|,
name|fkill_or_rejuv
decl_stmt|;
name|struct
name|uuconf_system
name|ssys
decl_stmt|;
name|fbad
operator|=
name|FALSE
expr_stmt|;
if|if
condition|(
operator|(
name|icmd
operator|&
name|JOB_SHOW
operator|)
operator|!=
literal|0
condition|)
block|{
name|struct
name|tm
name|stime
decl_stmt|;
name|printf
argument_list|(
literal|"%s %s!"
argument_list|,
name|zsystem
argument_list|,
name|zSxqt_system
argument_list|)
expr_stmt|;
if|if
condition|(
name|zSxqt_requestor
operator|!=
name|NULL
condition|)
name|printf
argument_list|(
literal|"%s"
argument_list|,
name|zSxqt_requestor
argument_list|)
expr_stmt|;
else|else
name|printf
argument_list|(
literal|"%s"
argument_list|,
name|zSxqt_user
argument_list|)
expr_stmt|;
name|usysdep_localtime
argument_list|(
name|itime
argument_list|,
operator|&
name|stime
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|" %02d-%02d %02d:%02d "
argument_list|,
name|stime
operator|.
name|tm_mon
operator|+
literal|1
argument_list|,
name|stime
operator|.
name|tm_mday
argument_list|,
name|stime
operator|.
name|tm_hour
argument_list|,
name|stime
operator|.
name|tm_min
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"%s\n"
argument_list|,
name|zSxqt_cmd
argument_list|)
expr_stmt|;
block|}
name|fkill_or_rejuv
operator|=
name|FALSE
expr_stmt|;
if|if
condition|(
operator|(
name|icmd
operator|&
name|JOB_INQUIRE
operator|)
operator|!=
literal|0
condition|)
block|{
name|int
name|b
decl_stmt|;
comment|/* Ask stdin whether this job should be killed.  */
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"%s: %s %s? "
argument_list|,
name|zProgram
argument_list|,
operator|(
name|icmd
operator|&
name|JOB_REJUVENATE
operator|)
operator|!=
literal|0
condition|?
literal|"Rejuvenate"
else|:
literal|"Kill"
argument_list|,
name|zSxqt_cmd
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|fflush
argument_list|(
name|stderr
argument_list|)
expr_stmt|;
name|b
operator|=
name|getchar
argument_list|()
expr_stmt|;
name|fkill_or_rejuv
operator|=
name|b
operator|==
literal|'y'
operator|||
name|b
operator|==
literal|'Y'
expr_stmt|;
while|while
condition|(
name|b
operator|!=
name|EOF
operator|&&
name|b
operator|!=
literal|'\n'
condition|)
name|b
operator|=
name|getchar
argument_list|()
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|(
name|icmd
operator|&
name|JOB_KILL
operator|)
operator|!=
literal|0
operator|||
operator|(
name|icmd
operator|&
name|JOB_REJUVENATE
operator|)
operator|!=
literal|0
condition|)
name|fkill_or_rejuv
operator|=
name|TRUE
expr_stmt|;
if|if
condition|(
name|fkill_or_rejuv
condition|)
block|{
if|if
condition|(
operator|(
name|strcmp
argument_list|(
name|zSxqt_user
argument_list|,
name|zsysdep_login_name
argument_list|()
argument_list|)
operator|!=
literal|0
operator|||
name|strcmp
argument_list|(
name|zsystem
argument_list|,
name|zlocalname
argument_list|)
operator|!=
literal|0
operator|)
operator|&&
operator|!
name|fsysdep_privileged
argument_list|()
condition|)
block|{
name|ulog
argument_list|(
name|LOG_ERROR
argument_list|,
literal|"Job not submitted by you\n"
argument_list|)
expr_stmt|;
name|fbad
operator|=
name|TRUE
expr_stmt|;
block|}
block|}
if|if
condition|(
operator|!
name|fbad
condition|)
block|{
name|iuuconf
operator|=
name|uuconf_system_info
argument_list|(
name|puuconf
argument_list|,
name|zsystem
argument_list|,
operator|&
name|ssys
argument_list|)
expr_stmt|;
if|if
condition|(
name|iuuconf
operator|!=
name|UUCONF_SUCCESS
condition|)
block|{
if|if
condition|(
name|iuuconf
operator|!=
name|UUCONF_NOT_FOUND
condition|)
block|{
name|ulog_uuconf
argument_list|(
name|LOG_ERROR
argument_list|,
name|puuconf
argument_list|,
name|iuuconf
argument_list|)
expr_stmt|;
name|fbad
operator|=
name|TRUE
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|zsystem
argument_list|,
name|zlocalname
argument_list|)
operator|==
literal|0
condition|)
block|{
name|iuuconf
operator|=
name|uuconf_system_local
argument_list|(
name|puuconf
argument_list|,
operator|&
name|ssys
argument_list|)
expr_stmt|;
if|if
condition|(
name|iuuconf
operator|!=
name|UUCONF_SUCCESS
condition|)
block|{
name|ulog_uuconf
argument_list|(
name|LOG_ERROR
argument_list|,
name|puuconf
argument_list|,
name|iuuconf
argument_list|)
expr_stmt|;
name|fbad
operator|=
name|TRUE
expr_stmt|;
block|}
name|ssys
operator|.
name|uuconf_zname
operator|=
operator|(
name|char
operator|*
operator|)
name|zlocalname
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|!
name|funknown_system
argument_list|(
name|puuconf
argument_list|,
name|zsystem
argument_list|,
operator|&
name|ssys
argument_list|)
condition|)
block|{
name|ulog
argument_list|(
name|LOG_ERROR
argument_list|,
literal|"Job for unknown system %s"
argument_list|,
name|zsystem
argument_list|)
expr_stmt|;
name|fbad
operator|=
name|TRUE
expr_stmt|;
block|}
block|}
block|}
if|if
condition|(
operator|!
name|fbad
operator|&&
operator|(
name|icmd
operator|&
operator|(
name|JOB_MAIL
operator||
name|JOB_NOTIFY
operator|)
operator|)
operator|!=
literal|0
condition|)
block|{
if|if
condition|(
operator|!
name|fsnotify
argument_list|(
name|puuconf
argument_list|,
name|icmd
argument_list|,
name|zcomment
argument_list|,
name|cstdin
argument_list|,
name|fkill_or_rejuv
operator|&&
operator|(
name|icmd
operator|&
name|JOB_REJUVENATE
operator|)
operator|==
literal|0
argument_list|,
name|zSxqt_cmd
argument_list|,
operator|(
expr|struct
name|scmdlist
operator|*
operator|)
name|NULL
argument_list|,
operator|(
specifier|const
name|char
operator|*
operator|)
name|NULL
argument_list|,
name|itime
argument_list|,
name|zSxqt_user
argument_list|,
operator|&
name|ssys
argument_list|,
name|zSxqt_stdin
argument_list|,
operator|(
name|pointer
operator|)
name|NULL
argument_list|,
name|zSxqt_requestor
argument_list|)
condition|)
block|{
name|ferr
operator|=
name|TRUE
expr_stmt|;
name|usxqt_file_free
argument_list|()
expr_stmt|;
name|ubuffree
argument_list|(
name|zfile
argument_list|)
expr_stmt|;
name|ubuffree
argument_list|(
name|zsystem
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
if|if
condition|(
operator|!
name|fbad
operator|&&
name|fkill_or_rejuv
condition|)
block|{
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|cSxqt_files
condition|;
name|i
operator|++
control|)
block|{
name|char
modifier|*
name|z
decl_stmt|;
name|z
operator|=
name|zsysdep_spool_file_name
argument_list|(
operator|&
name|ssys
argument_list|,
name|pazSxqt_files
index|[
name|i
index|]
argument_list|,
operator|(
name|pointer
operator|)
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|z
operator|!=
name|NULL
condition|)
block|{
if|if
condition|(
operator|(
name|icmd
operator|&
name|JOB_REJUVENATE
operator|)
operator|!=
literal|0
condition|)
operator|(
name|void
operator|)
name|fsysdep_touch_file
argument_list|(
name|z
argument_list|)
expr_stmt|;
else|else
operator|(
name|void
operator|)
name|remove
argument_list|(
name|z
argument_list|)
expr_stmt|;
name|ubuffree
argument_list|(
name|z
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
operator|(
name|icmd
operator|&
name|JOB_REJUVENATE
operator|)
operator|!=
literal|0
condition|)
operator|(
name|void
operator|)
name|fsysdep_touch_file
argument_list|(
name|zfile
argument_list|)
expr_stmt|;
else|else
block|{
if|if
condition|(
name|remove
argument_list|(
name|zfile
argument_list|)
operator|!=
literal|0
condition|)
name|ulog
argument_list|(
name|LOG_ERROR
argument_list|,
literal|"remove (%s): %s"
argument_list|,
name|zfile
argument_list|,
name|strerror
argument_list|(
name|errno
argument_list|)
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
operator|!
name|fbad
condition|)
operator|(
name|void
operator|)
name|uuconf_system_free
argument_list|(
name|puuconf
argument_list|,
operator|&
name|ssys
argument_list|)
expr_stmt|;
block|}
name|usxqt_file_free
argument_list|()
expr_stmt|;
name|ubuffree
argument_list|(
name|zfile
argument_list|)
expr_stmt|;
name|ubuffree
argument_list|(
name|zsystem
argument_list|)
expr_stmt|;
block|}
name|usysdep_get_xqt_free
argument_list|(
operator|(
specifier|const
name|char
operator|*
operator|)
name|NULL
argument_list|)
expr_stmt|;
return|return
name|ferr
return|;
block|}
end_function

begin_escape
end_escape

begin_comment
comment|/* When a job is killed, send mail to the appropriate people.  */
end_comment

begin_function
specifier|static
name|boolean
name|fsnotify
parameter_list|(
name|puuconf
parameter_list|,
name|icmd
parameter_list|,
name|zcomment
parameter_list|,
name|cstdin
parameter_list|,
name|fkilled
parameter_list|,
name|zcmd
parameter_list|,
name|qcmd
parameter_list|,
name|zid
parameter_list|,
name|itime
parameter_list|,
name|zuser
parameter_list|,
name|qsys
parameter_list|,
name|zstdin
parameter_list|,
name|pstdinseq
parameter_list|,
name|zrequestor
parameter_list|)
name|pointer
name|puuconf
decl_stmt|;
name|int
name|icmd
decl_stmt|;
specifier|const
name|char
modifier|*
name|zcomment
decl_stmt|;
name|int
name|cstdin
decl_stmt|;
name|boolean
name|fkilled
decl_stmt|;
specifier|const
name|char
modifier|*
name|zcmd
decl_stmt|;
name|struct
name|scmdlist
modifier|*
name|qcmd
decl_stmt|;
specifier|const
name|char
modifier|*
name|zid
decl_stmt|;
name|long
name|itime
decl_stmt|;
specifier|const
name|char
modifier|*
name|zuser
decl_stmt|;
specifier|const
name|struct
name|uuconf_system
modifier|*
name|qsys
decl_stmt|;
specifier|const
name|char
modifier|*
name|zstdin
decl_stmt|;
name|pointer
name|pstdinseq
decl_stmt|;
specifier|const
name|char
modifier|*
name|zrequestor
decl_stmt|;
block|{
specifier|const
name|char
modifier|*
modifier|*
name|pz
decl_stmt|;
name|int
name|cgot
decl_stmt|;
name|int
name|i
decl_stmt|,
name|istdin
decl_stmt|;
name|struct
name|tm
name|stime
decl_stmt|;
name|char
name|ab
index|[
sizeof|sizeof
expr|"1991-12-31 12:00:00"]
expr_stmt|;
specifier|const
name|char
modifier|*
name|zsubject
decl_stmt|;
name|boolean
name|fret
decl_stmt|;
name|pz
operator|=
operator|(
specifier|const
name|char
operator|*
operator|*
operator|)
name|xmalloc
argument_list|(
literal|20
operator|*
sizeof|sizeof
argument_list|(
specifier|const
name|char
operator|*
argument_list|)
argument_list|)
expr_stmt|;
name|cgot
operator|=
literal|20
expr_stmt|;
name|i
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|zid
operator|==
name|NULL
condition|)
name|pz
index|[
name|i
operator|++
index|]
operator|=
literal|"A UUCP execution request"
expr_stmt|;
else|else
block|{
name|pz
index|[
name|i
operator|++
index|]
operator|=
literal|"UUCP job\n\t"
expr_stmt|;
name|pz
index|[
name|i
operator|++
index|]
operator|=
name|zid
expr_stmt|;
name|pz
index|[
name|i
operator|++
index|]
operator|=
literal|"\nfor system\n\t"
expr_stmt|;
name|pz
index|[
name|i
operator|++
index|]
operator|=
name|qsys
operator|->
name|uuconf_zname
expr_stmt|;
block|}
name|pz
index|[
name|i
operator|++
index|]
operator|=
literal|"\nrequested by\n\t"
expr_stmt|;
name|pz
index|[
name|i
operator|++
index|]
operator|=
name|zuser
operator|!=
name|NULL
condition|?
name|zuser
else|:
name|OWNER
expr_stmt|;
if|if
condition|(
name|zid
operator|==
name|NULL
condition|)
block|{
name|pz
index|[
name|i
operator|++
index|]
operator|=
literal|"\non system\n\t"
expr_stmt|;
name|pz
index|[
name|i
operator|++
index|]
operator|=
name|qsys
operator|->
name|uuconf_zname
expr_stmt|;
block|}
name|pz
index|[
name|i
operator|++
index|]
operator|=
literal|"\n"
expr_stmt|;
if|if
condition|(
name|fkilled
condition|)
name|pz
index|[
name|i
operator|++
index|]
operator|=
literal|"has been killed.\n"
expr_stmt|;
if|if
condition|(
name|zcomment
operator|!=
name|NULL
condition|)
block|{
name|pz
index|[
name|i
operator|++
index|]
operator|=
name|zcomment
expr_stmt|;
name|pz
index|[
name|i
operator|++
index|]
operator|=
literal|"\n"
expr_stmt|;
block|}
name|pz
index|[
name|i
operator|++
index|]
operator|=
literal|"The job was queued at "
expr_stmt|;
name|usysdep_localtime
argument_list|(
name|itime
argument_list|,
operator|&
name|stime
argument_list|)
expr_stmt|;
name|sprintf
argument_list|(
name|ab
argument_list|,
literal|"%04d-%02d-%02d %02d:%02d:%02d"
argument_list|,
name|stime
operator|.
name|tm_year
operator|+
literal|1900
argument_list|,
name|stime
operator|.
name|tm_mon
operator|+
literal|1
argument_list|,
name|stime
operator|.
name|tm_mday
argument_list|,
name|stime
operator|.
name|tm_hour
argument_list|,
name|stime
operator|.
name|tm_min
argument_list|,
name|stime
operator|.
name|tm_sec
argument_list|)
expr_stmt|;
name|pz
index|[
name|i
operator|++
index|]
operator|=
name|ab
expr_stmt|;
name|pz
index|[
name|i
operator|++
index|]
operator|=
literal|".\nIt "
expr_stmt|;
if|if
condition|(
name|fkilled
condition|)
name|pz
index|[
name|i
operator|++
index|]
operator|=
literal|"was\n"
expr_stmt|;
else|else
name|pz
index|[
name|i
operator|++
index|]
operator|=
literal|"is\n"
expr_stmt|;
if|if
condition|(
name|zcmd
operator|!=
name|NULL
condition|)
block|{
name|pz
index|[
name|i
operator|++
index|]
operator|=
literal|"\t"
expr_stmt|;
name|pz
index|[
name|i
operator|++
index|]
operator|=
name|zcmd
expr_stmt|;
block|}
else|else
block|{
name|struct
name|scmdlist
modifier|*
name|qshow
decl_stmt|;
for|for
control|(
name|qshow
operator|=
name|qcmd
init|;
name|qshow
operator|!=
name|NULL
condition|;
name|qshow
operator|=
name|qshow
operator|->
name|qnext
control|)
block|{
if|if
condition|(
name|i
operator|+
literal|10
operator|>
name|cgot
condition|)
block|{
name|cgot
operator|+=
literal|20
expr_stmt|;
name|pz
operator|=
operator|(
specifier|const
name|char
operator|*
operator|*
operator|)
name|xrealloc
argument_list|(
operator|(
name|pointer
operator|)
name|pz
argument_list|,
name|cgot
operator|*
sizeof|sizeof
argument_list|(
specifier|const
name|char
operator|*
argument_list|)
argument_list|)
expr_stmt|;
block|}
switch|switch
condition|(
name|qshow
operator|->
name|s
operator|.
name|bcmd
condition|)
block|{
case|case
literal|'S'
case|:
name|pz
index|[
name|i
operator|++
index|]
operator|=
literal|"\tsend "
expr_stmt|;
break|break;
default|default:
case|case
literal|'R'
case|:
case|case
literal|'X'
case|:
name|pz
index|[
name|i
operator|++
index|]
operator|=
literal|"\trequest "
expr_stmt|;
break|break;
case|case
literal|'P'
case|:
name|pz
index|[
name|i
operator|++
index|]
operator|=
literal|"\tpoll "
expr_stmt|;
break|break;
if|#
directive|if
name|DEBUG
operator|>
literal|0
case|case
literal|'E'
case|:
name|ulog
argument_list|(
name|LOG_FATAL
argument_list|,
literal|"fsnotify: Can't happen"
argument_list|)
expr_stmt|;
break|break;
endif|#
directive|endif
block|}
if|if
condition|(
name|qshow
operator|->
name|s
operator|.
name|zfrom
operator|!=
name|NULL
operator|&&
name|qshow
operator|->
name|s
operator|.
name|zto
operator|!=
name|NULL
condition|)
block|{
name|pz
index|[
name|i
operator|++
index|]
operator|=
name|qshow
operator|->
name|s
operator|.
name|zfrom
expr_stmt|;
name|pz
index|[
name|i
operator|++
index|]
operator|=
literal|" to "
expr_stmt|;
name|pz
index|[
name|i
operator|++
index|]
operator|=
name|qshow
operator|->
name|s
operator|.
name|zto
expr_stmt|;
block|}
block|}
block|}
name|istdin
operator|=
name|i
expr_stmt|;
if|if
condition|(
name|cstdin
operator|>
literal|0
operator|&&
name|zstdin
operator|!=
name|NULL
condition|)
block|{
name|boolean
name|fspool
decl_stmt|;
name|char
modifier|*
name|zfile
decl_stmt|;
name|FILE
modifier|*
name|e
decl_stmt|;
name|fspool
operator|=
name|fspool_file
argument_list|(
name|zstdin
argument_list|)
expr_stmt|;
if|if
condition|(
name|fspool
condition|)
name|zfile
operator|=
name|zsysdep_spool_file_name
argument_list|(
name|qsys
argument_list|,
name|zstdin
argument_list|,
name|pstdinseq
argument_list|)
expr_stmt|;
else|else
name|zfile
operator|=
name|zsysdep_local_file
argument_list|(
name|zstdin
argument_list|,
name|qsys
operator|->
name|uuconf_zpubdir
argument_list|,
operator|(
name|boolean
operator|*
operator|)
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|zfile
operator|!=
name|NULL
operator|&&
operator|(
name|fspool
operator|||
name|fin_directory_list
argument_list|(
name|zfile
argument_list|,
name|qsys
operator|->
name|uuconf_pzremote_send
argument_list|,
name|qsys
operator|->
name|uuconf_zpubdir
argument_list|,
name|TRUE
argument_list|,
name|TRUE
argument_list|,
operator|(
specifier|const
name|char
operator|*
operator|)
name|NULL
argument_list|)
operator|)
condition|)
block|{
name|e
operator|=
name|fopen
argument_list|(
name|zfile
argument_list|,
literal|"r"
argument_list|)
expr_stmt|;
if|if
condition|(
name|e
operator|!=
name|NULL
condition|)
block|{
name|int
name|clines
decl_stmt|,
name|clen
decl_stmt|;
name|char
modifier|*
name|zline
decl_stmt|;
name|size_t
name|cline
decl_stmt|;
name|pz
index|[
name|i
operator|++
index|]
operator|=
literal|"\n"
expr_stmt|;
name|istdin
operator|=
name|i
expr_stmt|;
name|clines
operator|=
literal|0
expr_stmt|;
name|zline
operator|=
name|NULL
expr_stmt|;
name|cline
operator|=
literal|0
expr_stmt|;
while|while
condition|(
operator|(
name|clen
operator|=
name|getline
argument_list|(
operator|&
name|zline
argument_list|,
operator|&
name|cline
argument_list|,
name|e
argument_list|)
operator|)
operator|>
literal|0
condition|)
block|{
if|if
condition|(
name|memchr
argument_list|(
name|zline
argument_list|,
literal|'\0'
argument_list|,
operator|(
name|size_t
operator|)
name|clen
argument_list|)
operator|!=
name|NULL
condition|)
block|{
name|int
name|ifree
decl_stmt|;
comment|/* A null character means this is probably a 			 binary file.  */
for|for
control|(
name|ifree
operator|=
name|istdin
init|;
name|ifree
operator|<
name|i
condition|;
name|ifree
operator|++
control|)
name|ubuffree
argument_list|(
operator|(
name|char
operator|*
operator|)
name|pz
index|[
name|ifree
index|]
argument_list|)
expr_stmt|;
name|i
operator|=
name|istdin
operator|-
literal|1
expr_stmt|;
break|break;
block|}
operator|++
name|clines
expr_stmt|;
if|if
condition|(
name|clines
operator|>
name|cstdin
condition|)
break|break;
if|if
condition|(
name|i
operator|>=
name|cgot
condition|)
block|{
name|cgot
operator|+=
literal|20
expr_stmt|;
name|pz
operator|=
operator|(
specifier|const
name|char
operator|*
operator|*
operator|)
name|xrealloc
argument_list|(
operator|(
name|pointer
operator|)
name|pz
argument_list|,
operator|(
name|cgot
operator|*
sizeof|sizeof
argument_list|(
name|char
operator|*
argument_list|)
operator|)
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|strncmp
argument_list|(
name|zline
argument_list|,
literal|"From "
argument_list|,
sizeof|sizeof
expr|"From "
operator|-
literal|1
argument_list|)
operator|!=
literal|0
condition|)
name|pz
index|[
name|i
operator|++
index|]
operator|=
name|zbufcpy
argument_list|(
name|zline
argument_list|)
expr_stmt|;
else|else
block|{
name|char
modifier|*
name|zalc
decl_stmt|;
comment|/* Escape "From " at the start of a line.  This 			 should really be the responsibility of the 			 mail transfer agent.  On some systems, 			 though, the mail transfer agent does not do 			 it, but user mail programs expect it.  We 			 help them out here, since it doesn't matter 			 much--we're already truncating the message 			 anyhow.  */
name|zalc
operator|=
name|zbufalc
argument_list|(
name|strlen
argument_list|(
name|zline
argument_list|)
operator|+
literal|2
argument_list|)
expr_stmt|;
name|zalc
index|[
literal|0
index|]
operator|=
literal|'>'
expr_stmt|;
name|strcpy
argument_list|(
name|zalc
operator|+
literal|1
argument_list|,
name|zline
argument_list|)
expr_stmt|;
name|pz
index|[
name|i
operator|++
index|]
operator|=
name|zalc
expr_stmt|;
block|}
block|}
name|xfree
argument_list|(
operator|(
name|pointer
operator|)
name|zline
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|fclose
argument_list|(
name|e
argument_list|)
expr_stmt|;
block|}
block|}
name|ubuffree
argument_list|(
name|zfile
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|fkilled
condition|)
name|zsubject
operator|=
literal|"UUCP job killed"
expr_stmt|;
else|else
name|zsubject
operator|=
literal|"UUCP notification"
expr_stmt|;
name|fret
operator|=
name|TRUE
expr_stmt|;
if|if
condition|(
operator|(
name|icmd
operator|&
name|JOB_MAIL
operator|)
operator|!=
literal|0
condition|)
block|{
if|if
condition|(
operator|!
name|fsysdep_mail
argument_list|(
name|OWNER
argument_list|,
name|zsubject
argument_list|,
name|i
argument_list|,
name|pz
argument_list|)
condition|)
name|fret
operator|=
name|FALSE
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|icmd
operator|&
name|JOB_NOTIFY
operator|)
operator|!=
literal|0
operator|&&
operator|(
name|zrequestor
operator|!=
name|NULL
operator|||
name|zuser
operator|!=
name|NULL
operator|)
condition|)
block|{
specifier|const
name|char
modifier|*
name|zmail
decl_stmt|;
name|char
modifier|*
name|zfree
decl_stmt|;
if|if
condition|(
name|zrequestor
operator|!=
name|NULL
condition|)
name|zmail
operator|=
name|zrequestor
expr_stmt|;
else|else
name|zmail
operator|=
name|zuser
expr_stmt|;
name|zfree
operator|=
name|NULL
expr_stmt|;
if|if
condition|(
name|zid
operator|==
name|NULL
condition|)
block|{
name|int
name|iuuconf
decl_stmt|;
specifier|const
name|char
modifier|*
name|zloc
decl_stmt|;
comment|/* This is an execution request, which may be from another 	     system.  If it is, we must prepend that system name to 	     the user name extracted from the X. file.  */
name|iuuconf
operator|=
name|uuconf_localname
argument_list|(
name|puuconf
argument_list|,
operator|&
name|zloc
argument_list|)
expr_stmt|;
if|if
condition|(
name|iuuconf
operator|==
name|UUCONF_NOT_FOUND
condition|)
block|{
name|zloc
operator|=
name|zsysdep_localname
argument_list|()
expr_stmt|;
if|if
condition|(
name|zloc
operator|==
name|NULL
condition|)
return|return
name|FALSE
return|;
block|}
elseif|else
if|if
condition|(
name|iuuconf
operator|!=
name|UUCONF_SUCCESS
condition|)
name|ulog_uuconf
argument_list|(
name|LOG_FATAL
argument_list|,
name|puuconf
argument_list|,
name|iuuconf
argument_list|)
expr_stmt|;
if|if
condition|(
name|strcmp
argument_list|(
name|qsys
operator|->
name|uuconf_zname
argument_list|,
name|zloc
argument_list|)
operator|!=
literal|0
if|#
directive|if
name|HAVE_INTERNET_MAIL
operator|&&
name|strchr
argument_list|(
name|zmail
argument_list|,
literal|'@'
argument_list|)
operator|==
name|NULL
endif|#
directive|endif
condition|)
block|{
name|zfree
operator|=
name|zbufalc
argument_list|(
name|strlen
argument_list|(
name|qsys
operator|->
name|uuconf_zname
argument_list|)
operator|+
name|strlen
argument_list|(
name|zmail
argument_list|)
operator|+
sizeof|sizeof
expr|"!"
argument_list|)
expr_stmt|;
name|sprintf
argument_list|(
name|zfree
argument_list|,
literal|"%s!%s"
argument_list|,
name|qsys
operator|->
name|uuconf_zname
argument_list|,
name|zmail
argument_list|)
expr_stmt|;
name|zmail
operator|=
name|zfree
expr_stmt|;
block|}
block|}
if|if
condition|(
operator|!
name|fsysdep_mail
argument_list|(
name|zmail
argument_list|,
name|zsubject
argument_list|,
name|i
argument_list|,
name|pz
argument_list|)
condition|)
name|fret
operator|=
name|FALSE
expr_stmt|;
name|ubuffree
argument_list|(
name|zfree
argument_list|)
expr_stmt|;
block|}
while|while
condition|(
name|istdin
operator|<
name|i
condition|)
block|{
name|ubuffree
argument_list|(
operator|(
name|char
operator|*
operator|)
name|pz
index|[
name|istdin
index|]
argument_list|)
expr_stmt|;
name|istdin
operator|++
expr_stmt|;
block|}
name|xfree
argument_list|(
operator|(
name|pointer
operator|)
name|pz
argument_list|)
expr_stmt|;
return|return
name|fret
return|;
block|}
end_function

begin_escape
end_escape

begin_comment
comment|/* Handle the -q option.  For each remote system this lists the number    of jobs queued, the number of executions queued, and the current    call status.  We get the executions all at once, because they are    not accessed by system.  They could be, but it is possible to have    executions pending for an unknown system, so special handling would    still be required.  */
end_comment

begin_struct
struct|struct
name|sxqtlist
block|{
name|struct
name|sxqtlist
modifier|*
name|qnext
decl_stmt|;
name|char
modifier|*
name|zsystem
decl_stmt|;
name|int
name|cxqts
decl_stmt|;
name|long
name|ifirst
decl_stmt|;
block|}
struct|;
end_struct

begin_comment
comment|/* These local functions need the definition of sxqtlist for the    prototype.  */
end_comment

begin_decl_stmt
specifier|static
name|boolean
name|fsquery_system
name|P
argument_list|(
operator|(
specifier|const
expr|struct
name|uuconf_system
operator|*
name|qsys
operator|,
expr|struct
name|sxqtlist
operator|*
operator|*
name|pq
operator|,
name|long
name|inow
operator|,
specifier|const
name|char
operator|*
name|zlocalname
operator|,
name|int
name|csystems
operator|,
name|char
operator|*
operator|*
name|pazsystems
operator|,
name|boolean
name|fnotsystems
operator|,
name|long
name|iold
operator|,
name|long
name|iyoung
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|boolean
name|fsquery_show
name|P
argument_list|(
operator|(
specifier|const
expr|struct
name|uuconf_system
operator|*
name|qsys
operator|,
name|int
name|cwork
operator|,
name|long
name|ifirstwork
operator|,
expr|struct
name|sxqtlist
operator|*
name|qxqt
operator|,
name|long
name|inow
operator|,
specifier|const
name|char
operator|*
name|zlocalname
operator|,
name|int
name|csystems
operator|,
name|char
operator|*
operator|*
name|pazsystems
operator|,
name|boolean
name|fnotsystems
operator|,
name|long
name|iold
operator|,
name|long
name|iyoung
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_function
specifier|static
name|boolean
name|fsquery
parameter_list|(
name|puuconf
parameter_list|,
name|csystems
parameter_list|,
name|pazsystems
parameter_list|,
name|fnotsystems
parameter_list|,
name|iold
parameter_list|,
name|iyoung
parameter_list|)
name|pointer
name|puuconf
decl_stmt|;
name|int
name|csystems
decl_stmt|;
name|char
modifier|*
modifier|*
name|pazsystems
decl_stmt|;
name|boolean
name|fnotsystems
decl_stmt|;
name|long
name|iold
decl_stmt|;
name|long
name|iyoung
decl_stmt|;
block|{
name|int
name|iuuconf
decl_stmt|;
specifier|const
name|char
modifier|*
name|zlocalname
decl_stmt|;
name|struct
name|sxqtlist
modifier|*
name|qlist
decl_stmt|;
name|char
modifier|*
name|zfile
decl_stmt|,
modifier|*
name|zsystem
decl_stmt|;
name|boolean
name|ferr
decl_stmt|;
name|long
name|inow
decl_stmt|;
name|char
modifier|*
modifier|*
name|pznames
decl_stmt|,
modifier|*
modifier|*
name|pz
decl_stmt|;
name|boolean
name|fret
decl_stmt|;
name|iuuconf
operator|=
name|uuconf_localname
argument_list|(
name|puuconf
argument_list|,
operator|&
name|zlocalname
argument_list|)
expr_stmt|;
if|if
condition|(
name|iuuconf
operator|==
name|UUCONF_NOT_FOUND
condition|)
block|{
name|zlocalname
operator|=
name|zsysdep_localname
argument_list|()
expr_stmt|;
if|if
condition|(
name|zlocalname
operator|==
name|NULL
condition|)
return|return
name|FALSE
return|;
block|}
elseif|else
if|if
condition|(
name|iuuconf
operator|!=
name|UUCONF_SUCCESS
condition|)
block|{
name|ulog_uuconf
argument_list|(
name|LOG_ERROR
argument_list|,
name|puuconf
argument_list|,
name|iuuconf
argument_list|)
expr_stmt|;
return|return
name|FALSE
return|;
block|}
comment|/* Get a count of all the execution files.  */
if|if
condition|(
operator|!
name|fsysdep_get_xqt_init
argument_list|(
operator|(
specifier|const
name|char
operator|*
operator|)
name|NULL
argument_list|)
condition|)
return|return
name|FALSE
return|;
name|qlist
operator|=
name|NULL
expr_stmt|;
while|while
condition|(
operator|(
name|zfile
operator|=
name|zsysdep_get_xqt
argument_list|(
operator|(
specifier|const
name|char
operator|*
operator|)
name|NULL
argument_list|,
operator|&
name|zsystem
argument_list|,
operator|&
name|ferr
argument_list|)
operator|)
operator|!=
name|NULL
condition|)
block|{
name|struct
name|sxqtlist
modifier|*
name|qlook
decl_stmt|;
for|for
control|(
name|qlook
operator|=
name|qlist
init|;
name|qlook
operator|!=
name|NULL
condition|;
name|qlook
operator|=
name|qlook
operator|->
name|qnext
control|)
if|if
condition|(
name|strcmp
argument_list|(
name|zsystem
argument_list|,
name|qlook
operator|->
name|zsystem
argument_list|)
operator|==
literal|0
condition|)
break|break;
if|if
condition|(
name|qlook
operator|!=
name|NULL
condition|)
block|{
name|long
name|itime
decl_stmt|;
name|ubuffree
argument_list|(
name|zsystem
argument_list|)
expr_stmt|;
operator|++
name|qlook
operator|->
name|cxqts
expr_stmt|;
name|itime
operator|=
name|ixsysdep_file_time
argument_list|(
name|zfile
argument_list|)
expr_stmt|;
if|if
condition|(
name|itime
operator|<
name|qlook
operator|->
name|ifirst
condition|)
name|qlook
operator|->
name|ifirst
operator|=
name|itime
expr_stmt|;
block|}
else|else
block|{
name|struct
name|sxqtlist
modifier|*
name|qnew
decl_stmt|;
name|qnew
operator|=
operator|(
expr|struct
name|sxqtlist
operator|*
operator|)
name|xmalloc
argument_list|(
sizeof|sizeof
argument_list|(
expr|struct
name|sxqtlist
argument_list|)
argument_list|)
expr_stmt|;
name|qnew
operator|->
name|qnext
operator|=
name|qlist
expr_stmt|;
name|qnew
operator|->
name|zsystem
operator|=
name|zsystem
expr_stmt|;
name|qnew
operator|->
name|cxqts
operator|=
literal|1
expr_stmt|;
name|qnew
operator|->
name|ifirst
operator|=
name|ixsysdep_file_time
argument_list|(
name|zfile
argument_list|)
expr_stmt|;
name|qlist
operator|=
name|qnew
expr_stmt|;
block|}
name|ubuffree
argument_list|(
name|zfile
argument_list|)
expr_stmt|;
block|}
name|usysdep_get_xqt_free
argument_list|(
operator|(
specifier|const
name|char
operator|*
operator|)
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|ferr
condition|)
return|return
name|FALSE
return|;
name|inow
operator|=
name|ixsysdep_time
argument_list|(
operator|(
name|long
operator|*
operator|)
name|NULL
argument_list|)
expr_stmt|;
comment|/* Show the information for each system.  */
name|iuuconf
operator|=
name|uuconf_system_names
argument_list|(
name|puuconf
argument_list|,
operator|&
name|pznames
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|iuuconf
operator|!=
name|UUCONF_SUCCESS
condition|)
block|{
name|ulog_uuconf
argument_list|(
name|LOG_ERROR
argument_list|,
name|puuconf
argument_list|,
name|iuuconf
argument_list|)
expr_stmt|;
return|return
name|FALSE
return|;
block|}
name|fret
operator|=
name|TRUE
expr_stmt|;
for|for
control|(
name|pz
operator|=
name|pznames
init|;
operator|*
name|pz
operator|!=
name|NULL
condition|;
name|pz
operator|++
control|)
block|{
name|struct
name|uuconf_system
name|ssys
decl_stmt|;
name|iuuconf
operator|=
name|uuconf_system_info
argument_list|(
name|puuconf
argument_list|,
operator|*
name|pz
argument_list|,
operator|&
name|ssys
argument_list|)
expr_stmt|;
if|if
condition|(
name|iuuconf
operator|!=
name|UUCONF_SUCCESS
condition|)
block|{
name|ulog_uuconf
argument_list|(
name|LOG_ERROR
argument_list|,
name|puuconf
argument_list|,
name|iuuconf
argument_list|)
expr_stmt|;
name|fret
operator|=
name|FALSE
expr_stmt|;
continue|continue;
block|}
if|if
condition|(
operator|!
name|fsquery_system
argument_list|(
operator|&
name|ssys
argument_list|,
operator|&
name|qlist
argument_list|,
name|inow
argument_list|,
name|zlocalname
argument_list|,
name|csystems
argument_list|,
name|pazsystems
argument_list|,
name|fnotsystems
argument_list|,
name|iold
argument_list|,
name|iyoung
argument_list|)
condition|)
name|fret
operator|=
name|FALSE
expr_stmt|;
operator|(
name|void
operator|)
name|uuconf_system_free
argument_list|(
name|puuconf
argument_list|,
operator|&
name|ssys
argument_list|)
expr_stmt|;
name|xfree
argument_list|(
operator|(
name|pointer
operator|)
operator|*
name|pz
argument_list|)
expr_stmt|;
block|}
comment|/* Check for the local system in the list of execution files.  */
if|if
condition|(
name|qlist
operator|!=
name|NULL
condition|)
block|{
name|struct
name|sxqtlist
modifier|*
modifier|*
name|pq
decl_stmt|;
for|for
control|(
name|pq
operator|=
operator|&
name|qlist
init|;
operator|*
name|pq
operator|!=
name|NULL
condition|;
name|pq
operator|=
operator|&
operator|(
operator|*
name|pq
operator|)
operator|->
name|qnext
control|)
block|{
if|if
condition|(
name|strcmp
argument_list|(
operator|(
operator|*
name|pq
operator|)
operator|->
name|zsystem
argument_list|,
name|zlocalname
argument_list|)
operator|==
literal|0
condition|)
block|{
name|struct
name|uuconf_system
name|ssys
decl_stmt|;
name|struct
name|sxqtlist
modifier|*
name|qfree
decl_stmt|;
name|iuuconf
operator|=
name|uuconf_system_info
argument_list|(
name|puuconf
argument_list|,
name|zlocalname
argument_list|,
operator|&
name|ssys
argument_list|)
expr_stmt|;
if|if
condition|(
name|iuuconf
operator|!=
name|UUCONF_SUCCESS
condition|)
block|{
if|if
condition|(
name|iuuconf
operator|!=
name|UUCONF_NOT_FOUND
condition|)
block|{
name|ulog_uuconf
argument_list|(
name|LOG_ERROR
argument_list|,
name|puuconf
argument_list|,
name|iuuconf
argument_list|)
expr_stmt|;
name|fret
operator|=
name|FALSE
expr_stmt|;
break|break;
block|}
name|iuuconf
operator|=
name|uuconf_system_local
argument_list|(
name|puuconf
argument_list|,
operator|&
name|ssys
argument_list|)
expr_stmt|;
if|if
condition|(
name|iuuconf
operator|!=
name|UUCONF_SUCCESS
condition|)
block|{
name|ulog_uuconf
argument_list|(
name|LOG_ERROR
argument_list|,
name|puuconf
argument_list|,
name|iuuconf
argument_list|)
expr_stmt|;
name|fret
operator|=
name|FALSE
expr_stmt|;
break|break;
block|}
name|ssys
operator|.
name|uuconf_zname
operator|=
operator|(
name|char
operator|*
operator|)
name|zlocalname
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|fsquery_show
argument_list|(
operator|&
name|ssys
argument_list|,
literal|0
argument_list|,
literal|0L
argument_list|,
operator|*
name|pq
argument_list|,
name|inow
argument_list|,
name|zlocalname
argument_list|,
name|csystems
argument_list|,
name|pazsystems
argument_list|,
name|fnotsystems
argument_list|,
name|iold
argument_list|,
name|iyoung
argument_list|)
condition|)
name|fret
operator|=
name|FALSE
expr_stmt|;
operator|(
name|void
operator|)
name|uuconf_system_free
argument_list|(
name|puuconf
argument_list|,
operator|&
name|ssys
argument_list|)
expr_stmt|;
name|qfree
operator|=
operator|*
name|pq
expr_stmt|;
operator|*
name|pq
operator|=
name|qfree
operator|->
name|qnext
expr_stmt|;
name|ubuffree
argument_list|(
name|qfree
operator|->
name|zsystem
argument_list|)
expr_stmt|;
name|xfree
argument_list|(
operator|(
name|pointer
operator|)
name|qfree
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
block|}
comment|/* Print out information for any unknown systems for which we have      execution files.  */
while|while
condition|(
name|qlist
operator|!=
name|NULL
condition|)
block|{
name|struct
name|uuconf_system
name|ssys
decl_stmt|;
name|struct
name|sxqtlist
modifier|*
name|qnext
decl_stmt|;
if|if
condition|(
operator|!
name|funknown_system
argument_list|(
name|puuconf
argument_list|,
name|qlist
operator|->
name|zsystem
argument_list|,
operator|&
name|ssys
argument_list|)
condition|)
block|{
name|ulog
argument_list|(
name|LOG_ERROR
argument_list|,
literal|"Executions queued up for unknown systems"
argument_list|)
expr_stmt|;
name|fret
operator|=
name|FALSE
expr_stmt|;
break|break;
block|}
if|if
condition|(
operator|!
name|fsquery_show
argument_list|(
operator|&
name|ssys
argument_list|,
literal|0
argument_list|,
literal|0L
argument_list|,
name|qlist
argument_list|,
name|inow
argument_list|,
name|zlocalname
argument_list|,
name|csystems
argument_list|,
name|pazsystems
argument_list|,
name|fnotsystems
argument_list|,
name|iold
argument_list|,
name|iyoung
argument_list|)
condition|)
name|fret
operator|=
name|FALSE
expr_stmt|;
operator|(
name|void
operator|)
name|uuconf_system_free
argument_list|(
name|puuconf
argument_list|,
operator|&
name|ssys
argument_list|)
expr_stmt|;
name|qnext
operator|=
name|qlist
operator|->
name|qnext
expr_stmt|;
name|ubuffree
argument_list|(
name|qlist
operator|->
name|zsystem
argument_list|)
expr_stmt|;
name|xfree
argument_list|(
operator|(
name|pointer
operator|)
name|qlist
argument_list|)
expr_stmt|;
name|qlist
operator|=
name|qnext
expr_stmt|;
block|}
return|return
name|fret
return|;
block|}
end_function

begin_comment
comment|/* Query a single known system.  */
end_comment

begin_function
specifier|static
name|boolean
name|fsquery_system
parameter_list|(
name|qsys
parameter_list|,
name|pq
parameter_list|,
name|inow
parameter_list|,
name|zlocalname
parameter_list|,
name|csystems
parameter_list|,
name|pazsystems
parameter_list|,
name|fnotsystems
parameter_list|,
name|iold
parameter_list|,
name|iyoung
parameter_list|)
specifier|const
name|struct
name|uuconf_system
modifier|*
name|qsys
decl_stmt|;
name|struct
name|sxqtlist
modifier|*
modifier|*
name|pq
decl_stmt|;
name|long
name|inow
decl_stmt|;
specifier|const
name|char
modifier|*
name|zlocalname
decl_stmt|;
name|int
name|csystems
decl_stmt|;
name|char
modifier|*
modifier|*
name|pazsystems
decl_stmt|;
name|boolean
name|fnotsystems
decl_stmt|;
name|long
name|iold
decl_stmt|;
name|long
name|iyoung
decl_stmt|;
block|{
name|int
name|cwork
decl_stmt|;
name|long
name|ifirstwork
decl_stmt|;
name|char
modifier|*
name|zid
decl_stmt|;
name|boolean
name|fret
decl_stmt|;
if|if
condition|(
operator|!
name|fsysdep_get_work_init
argument_list|(
name|qsys
argument_list|,
name|UUCONF_GRADE_LOW
argument_list|)
condition|)
return|return
name|FALSE
return|;
name|cwork
operator|=
literal|0
expr_stmt|;
name|ifirstwork
operator|=
literal|0L
expr_stmt|;
name|zid
operator|=
name|NULL
expr_stmt|;
while|while
condition|(
name|TRUE
condition|)
block|{
name|struct
name|scmd
name|s
decl_stmt|;
name|long
name|itime
decl_stmt|;
name|char
modifier|*
name|zthisid
decl_stmt|;
if|if
condition|(
operator|!
name|fsysdep_get_work
argument_list|(
name|qsys
argument_list|,
name|UUCONF_GRADE_LOW
argument_list|,
operator|&
name|s
argument_list|)
condition|)
return|return
name|FALSE
return|;
if|if
condition|(
name|s
operator|.
name|bcmd
operator|==
literal|'H'
condition|)
break|break;
name|zthisid
operator|=
name|zsysdep_jobid
argument_list|(
name|qsys
argument_list|,
name|s
operator|.
name|pseq
argument_list|)
expr_stmt|;
if|if
condition|(
name|zid
operator|!=
name|NULL
operator|&&
name|strcmp
argument_list|(
name|zid
argument_list|,
name|zthisid
argument_list|)
operator|==
literal|0
condition|)
name|ubuffree
argument_list|(
name|zthisid
argument_list|)
expr_stmt|;
else|else
block|{
operator|++
name|cwork
expr_stmt|;
name|ubuffree
argument_list|(
name|zid
argument_list|)
expr_stmt|;
name|zid
operator|=
name|zthisid
expr_stmt|;
block|}
name|itime
operator|=
name|ixsysdep_work_time
argument_list|(
name|qsys
argument_list|,
name|s
operator|.
name|pseq
argument_list|)
expr_stmt|;
if|if
condition|(
name|ifirstwork
operator|==
literal|0L
operator|||
name|ifirstwork
operator|>
name|itime
condition|)
name|ifirstwork
operator|=
name|itime
expr_stmt|;
block|}
name|usysdep_get_work_free
argument_list|(
name|qsys
argument_list|)
expr_stmt|;
name|ubuffree
argument_list|(
name|zid
argument_list|)
expr_stmt|;
comment|/* Find the execution information, if any.  */
while|while
condition|(
operator|*
name|pq
operator|!=
name|NULL
condition|)
block|{
if|if
condition|(
name|strcmp
argument_list|(
operator|(
operator|*
name|pq
operator|)
operator|->
name|zsystem
argument_list|,
name|qsys
operator|->
name|uuconf_zname
argument_list|)
operator|==
literal|0
condition|)
break|break;
name|pq
operator|=
operator|&
operator|(
operator|*
name|pq
operator|)
operator|->
name|qnext
expr_stmt|;
block|}
comment|/* If there are no commands and no executions, don't print any      information for this system.  */
if|if
condition|(
name|cwork
operator|==
literal|0
operator|&&
operator|*
name|pq
operator|==
name|NULL
condition|)
return|return
name|TRUE
return|;
name|fret
operator|=
name|fsquery_show
argument_list|(
name|qsys
argument_list|,
name|cwork
argument_list|,
name|ifirstwork
argument_list|,
operator|*
name|pq
argument_list|,
name|inow
argument_list|,
name|zlocalname
argument_list|,
name|csystems
argument_list|,
name|pazsystems
argument_list|,
name|fnotsystems
argument_list|,
name|iold
argument_list|,
name|iyoung
argument_list|)
expr_stmt|;
if|if
condition|(
operator|*
name|pq
operator|!=
name|NULL
condition|)
block|{
name|struct
name|sxqtlist
modifier|*
name|qfree
decl_stmt|;
name|qfree
operator|=
operator|*
name|pq
expr_stmt|;
operator|*
name|pq
operator|=
name|qfree
operator|->
name|qnext
expr_stmt|;
name|ubuffree
argument_list|(
name|qfree
operator|->
name|zsystem
argument_list|)
expr_stmt|;
name|xfree
argument_list|(
operator|(
name|pointer
operator|)
name|qfree
argument_list|)
expr_stmt|;
block|}
return|return
name|fret
return|;
block|}
end_function

begin_comment
comment|/* Print out the query information for a single system.  We handle the    local system specially.  */
end_comment

begin_function
specifier|static
name|boolean
name|fsquery_show
parameter_list|(
name|qsys
parameter_list|,
name|cwork
parameter_list|,
name|ifirstwork
parameter_list|,
name|qxqt
parameter_list|,
name|inow
parameter_list|,
name|zlocalname
parameter_list|,
name|csystems
parameter_list|,
name|pazsystems
parameter_list|,
name|fnotsystems
parameter_list|,
name|iold
parameter_list|,
name|iyoung
parameter_list|)
specifier|const
name|struct
name|uuconf_system
modifier|*
name|qsys
decl_stmt|;
name|int
name|cwork
decl_stmt|;
name|long
name|ifirstwork
decl_stmt|;
name|struct
name|sxqtlist
modifier|*
name|qxqt
decl_stmt|;
name|long
name|inow
decl_stmt|;
specifier|const
name|char
modifier|*
name|zlocalname
decl_stmt|;
name|int
name|csystems
decl_stmt|;
name|char
modifier|*
modifier|*
name|pazsystems
decl_stmt|;
name|boolean
name|fnotsystems
decl_stmt|;
name|long
name|iold
decl_stmt|;
name|long
name|iyoung
decl_stmt|;
block|{
name|boolean
name|flocal
decl_stmt|;
name|struct
name|sstatus
name|sstat
decl_stmt|;
name|boolean
name|fnostatus
decl_stmt|;
name|struct
name|tm
name|stime
decl_stmt|;
name|int
name|cpad
decl_stmt|;
comment|/* Make sure this is one of the systems we are printing.  */
if|if
condition|(
name|csystems
operator|>
literal|0
condition|)
block|{
name|boolean
name|fmatch
decl_stmt|;
name|int
name|i
decl_stmt|;
name|fmatch
operator|=
name|fnotsystems
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|csystems
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|strcmp
argument_list|(
name|pazsystems
index|[
name|i
index|]
argument_list|,
name|qsys
operator|->
name|uuconf_zname
argument_list|)
operator|==
literal|0
condition|)
block|{
name|fmatch
operator|=
operator|!
name|fmatch
expr_stmt|;
break|break;
block|}
block|}
if|if
condition|(
operator|!
name|fmatch
condition|)
return|return
name|TRUE
return|;
block|}
comment|/* Make sure the commands are within the time bounds.  */
if|if
condition|(
operator|(
name|iold
operator|!=
operator|(
name|long
operator|)
operator|-
literal|1
operator|&&
operator|(
name|cwork
operator|==
literal|0
operator|||
name|ifirstwork
operator|>
name|iold
operator|)
operator|&&
operator|(
name|qxqt
operator|==
name|NULL
operator|||
name|qxqt
operator|->
name|ifirst
operator|>
name|iold
operator|)
operator|)
operator|||
operator|(
name|iyoung
operator|!=
operator|(
name|long
operator|)
operator|-
literal|1
operator|&&
operator|(
name|cwork
operator|==
literal|0
operator|||
name|ifirstwork
operator|<
name|iyoung
operator|)
operator|&&
operator|(
name|qxqt
operator|==
name|NULL
operator|||
name|qxqt
operator|->
name|ifirst
operator|<
name|iyoung
operator|)
operator|)
condition|)
return|return
name|TRUE
return|;
name|flocal
operator|=
name|strcmp
argument_list|(
name|qsys
operator|->
name|uuconf_zname
argument_list|,
name|zlocalname
argument_list|)
operator|==
literal|0
expr_stmt|;
if|if
condition|(
operator|!
name|flocal
condition|)
block|{
if|if
condition|(
operator|!
name|fsysdep_get_status
argument_list|(
name|qsys
argument_list|,
operator|&
name|sstat
argument_list|,
operator|&
name|fnostatus
argument_list|)
condition|)
return|return
name|FALSE
return|;
block|}
name|printf
argument_list|(
literal|"%-10s %3dC ("
argument_list|,
name|qsys
operator|->
name|uuconf_zname
argument_list|,
name|cwork
argument_list|)
expr_stmt|;
if|if
condition|(
name|cwork
operator|==
literal|0
condition|)
block|{
name|printf
argument_list|(
literal|"0 secs"
argument_list|)
expr_stmt|;
name|cpad
operator|=
literal|3
expr_stmt|;
block|}
else|else
name|cpad
operator|=
name|csunits_show
argument_list|(
name|inow
operator|-
name|ifirstwork
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|") "
argument_list|)
expr_stmt|;
while|while
condition|(
name|cpad
operator|--
operator|!=
literal|0
condition|)
name|printf
argument_list|(
literal|" "
argument_list|)
expr_stmt|;
if|if
condition|(
name|qxqt
operator|==
name|NULL
condition|)
name|printf
argument_list|(
literal|"  0X (0 secs)  "
argument_list|)
expr_stmt|;
else|else
block|{
name|printf
argument_list|(
literal|"%3dX ("
argument_list|,
name|qxqt
operator|->
name|cxqts
argument_list|)
expr_stmt|;
name|cpad
operator|=
name|csunits_show
argument_list|(
name|inow
operator|-
name|qxqt
operator|->
name|ifirst
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|")"
argument_list|)
expr_stmt|;
while|while
condition|(
name|cpad
operator|--
operator|!=
literal|0
condition|)
name|printf
argument_list|(
literal|" "
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|flocal
operator|||
name|fnostatus
condition|)
block|{
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|flocal
condition|)
name|ubuffree
argument_list|(
name|sstat
operator|.
name|zstring
argument_list|)
expr_stmt|;
return|return
name|TRUE
return|;
block|}
name|usysdep_localtime
argument_list|(
name|sstat
operator|.
name|ilast
argument_list|,
operator|&
name|stime
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|" %02d-%02d %02d:%02d "
argument_list|,
name|stime
operator|.
name|tm_mon
operator|+
literal|1
argument_list|,
name|stime
operator|.
name|tm_mday
argument_list|,
name|stime
operator|.
name|tm_hour
argument_list|,
name|stime
operator|.
name|tm_min
argument_list|)
expr_stmt|;
if|if
condition|(
name|sstat
operator|.
name|zstring
operator|==
name|NULL
condition|)
name|printf
argument_list|(
literal|"%s\n"
argument_list|,
name|azStatus
index|[
operator|(
name|int
operator|)
name|sstat
operator|.
name|ttype
index|]
argument_list|)
expr_stmt|;
else|else
block|{
name|printf
argument_list|(
literal|"%s\n"
argument_list|,
name|sstat
operator|.
name|zstring
argument_list|)
expr_stmt|;
name|ubuffree
argument_list|(
name|sstat
operator|.
name|zstring
argument_list|)
expr_stmt|;
block|}
return|return
name|TRUE
return|;
block|}
end_function

begin_comment
comment|/* Print a time difference in the largest applicable units.  */
end_comment

begin_function
specifier|static
name|int
name|csunits_show
parameter_list|(
name|idiff
parameter_list|)
name|long
name|idiff
decl_stmt|;
block|{
specifier|const
name|char
modifier|*
name|zunit
decl_stmt|;
name|long
name|iunits
decl_stmt|;
name|int
name|cpad
decl_stmt|;
if|if
condition|(
name|idiff
operator|>
operator|(
name|long
operator|)
literal|24
operator|*
operator|(
name|long
operator|)
literal|60
operator|*
operator|(
name|long
operator|)
literal|60
condition|)
block|{
name|iunits
operator|=
name|idiff
operator|/
operator|(
operator|(
name|long
operator|)
literal|24
operator|*
operator|(
name|long
operator|)
literal|60
operator|*
operator|(
name|long
operator|)
literal|60
operator|)
expr_stmt|;
name|zunit
operator|=
literal|"day"
expr_stmt|;
name|cpad
operator|=
literal|4
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|idiff
operator|>
operator|(
name|long
operator|)
literal|60
operator|*
literal|60
condition|)
block|{
name|iunits
operator|=
name|idiff
operator|/
call|(
name|long
call|)
argument_list|(
literal|60
operator|*
literal|60
argument_list|)
expr_stmt|;
name|zunit
operator|=
literal|"hour"
expr_stmt|;
name|cpad
operator|=
literal|3
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|idiff
operator|>
operator|(
name|long
operator|)
literal|60
condition|)
block|{
name|iunits
operator|=
name|idiff
operator|/
operator|(
name|long
operator|)
literal|60
expr_stmt|;
name|zunit
operator|=
literal|"min"
expr_stmt|;
name|cpad
operator|=
literal|4
expr_stmt|;
block|}
else|else
block|{
name|iunits
operator|=
name|idiff
expr_stmt|;
name|zunit
operator|=
literal|"sec"
expr_stmt|;
name|cpad
operator|=
literal|4
expr_stmt|;
block|}
name|printf
argument_list|(
literal|"%ld %s%s"
argument_list|,
name|iunits
argument_list|,
name|zunit
argument_list|,
name|iunits
operator|==
literal|1
condition|?
literal|""
else|:
literal|"s"
argument_list|)
expr_stmt|;
if|if
condition|(
name|iunits
operator|!=
literal|1
condition|)
operator|--
name|cpad
expr_stmt|;
if|if
condition|(
name|iunits
operator|>
literal|99
condition|)
operator|--
name|cpad
expr_stmt|;
if|if
condition|(
name|iunits
operator|>
literal|9
condition|)
operator|--
name|cpad
expr_stmt|;
return|return
name|cpad
return|;
block|}
end_function

begin_escape
end_escape

begin_comment
comment|/* Give a list of all status entries for all machines that we have    status entries for.  We need to get a list of status entries in a    system dependent fashion, since we may have status for unknown    systems.  */
end_comment

begin_function
specifier|static
name|boolean
name|fsmachines
parameter_list|()
block|{
name|pointer
name|phold
decl_stmt|;
name|char
modifier|*
name|zsystem
decl_stmt|;
name|boolean
name|ferr
decl_stmt|;
name|struct
name|sstatus
name|sstat
decl_stmt|;
if|if
condition|(
operator|!
name|fsysdep_all_status_init
argument_list|(
operator|&
name|phold
argument_list|)
condition|)
return|return
name|FALSE
return|;
while|while
condition|(
operator|(
name|zsystem
operator|=
name|zsysdep_all_status
argument_list|(
name|phold
argument_list|,
operator|&
name|ferr
argument_list|,
operator|&
name|sstat
argument_list|)
operator|)
operator|!=
name|NULL
condition|)
block|{
name|struct
name|tm
name|stime
decl_stmt|;
name|usysdep_localtime
argument_list|(
name|sstat
operator|.
name|ilast
argument_list|,
operator|&
name|stime
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"%-14s %02d-%02d %02d:%02d "
argument_list|,
name|zsystem
argument_list|,
name|stime
operator|.
name|tm_mon
operator|+
literal|1
argument_list|,
name|stime
operator|.
name|tm_mday
argument_list|,
name|stime
operator|.
name|tm_hour
argument_list|,
name|stime
operator|.
name|tm_min
argument_list|)
expr_stmt|;
if|if
condition|(
name|sstat
operator|.
name|zstring
operator|==
name|NULL
condition|)
name|printf
argument_list|(
literal|"%s"
argument_list|,
name|azStatus
index|[
operator|(
name|int
operator|)
name|sstat
operator|.
name|ttype
index|]
argument_list|)
expr_stmt|;
else|else
block|{
name|printf
argument_list|(
literal|"%s"
argument_list|,
name|sstat
operator|.
name|zstring
argument_list|)
expr_stmt|;
name|ubuffree
argument_list|(
name|sstat
operator|.
name|zstring
argument_list|)
expr_stmt|;
block|}
name|ubuffree
argument_list|(
name|zsystem
argument_list|)
expr_stmt|;
if|if
condition|(
name|sstat
operator|.
name|ttype
operator|!=
name|STATUS_TALKING
operator|&&
name|sstat
operator|.
name|cwait
operator|>
literal|0
condition|)
block|{
name|printf
argument_list|(
literal|" (%d %s"
argument_list|,
name|sstat
operator|.
name|cretries
argument_list|,
name|sstat
operator|.
name|cretries
operator|==
literal|1
condition|?
literal|"try"
else|:
literal|"tries"
argument_list|)
expr_stmt|;
if|if
condition|(
name|sstat
operator|.
name|ilast
operator|+
name|sstat
operator|.
name|cwait
operator|>
name|ixsysdep_time
argument_list|(
operator|(
name|long
operator|*
operator|)
name|NULL
argument_list|)
condition|)
block|{
name|usysdep_localtime
argument_list|(
name|sstat
operator|.
name|ilast
operator|+
name|sstat
operator|.
name|cwait
argument_list|,
operator|&
name|stime
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|", next after %02d-%02d %02d:%02d"
argument_list|,
name|stime
operator|.
name|tm_mon
operator|+
literal|1
argument_list|,
name|stime
operator|.
name|tm_mday
argument_list|,
name|stime
operator|.
name|tm_hour
argument_list|,
name|stime
operator|.
name|tm_min
argument_list|)
expr_stmt|;
block|}
name|printf
argument_list|(
literal|")"
argument_list|)
expr_stmt|;
block|}
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
block|}
name|usysdep_all_status_free
argument_list|(
name|phold
argument_list|)
expr_stmt|;
return|return
operator|!
name|ferr
return|;
block|}
end_function

end_unit


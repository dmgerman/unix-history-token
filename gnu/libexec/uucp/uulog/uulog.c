begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/* uulog.c    Display the UUCP log file.     Copyright (C) 1991, 1992, 1993, 1994, 1995 Ian Lance Taylor     This file is part of the Taylor UUCP package.     This program is free software; you can redistribute it and/or    modify it under the terms of the GNU General Public License as    published by the Free Software Foundation; either version 2 of the    License, or (at your option) any later version.     This program is distributed in the hope that it will be useful, but    WITHOUT ANY WARRANTY; without even the implied warranty of    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU    General Public License for more details.     You should have received a copy of the GNU General Public License    along with this program; if not, write to the Free Software    Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.     The author of the program may be contacted at ian@airs.com or    c/o Cygnus Support, 48 Grove Street, Somerville, MA 02144.    */
end_comment

begin_include
include|#
directive|include
file|"uucp.h"
end_include

begin_if
if|#
directive|if
name|USE_RCS_ID
end_if

begin_decl_stmt
specifier|const
name|char
name|uulog_rcsid
index|[]
init|=
literal|"$FreeBSD$"
decl_stmt|;
end_decl_stmt

begin_endif
endif|#
directive|endif
end_endif

begin_include
include|#
directive|include
file|<ctype.h>
end_include

begin_include
include|#
directive|include
file|<errno.h>
end_include

begin_include
include|#
directive|include
file|"getopt.h"
end_include

begin_include
include|#
directive|include
file|"uudefs.h"
end_include

begin_include
include|#
directive|include
file|"uuconf.h"
end_include

begin_include
include|#
directive|include
file|"system.h"
end_include

begin_escape
end_escape

begin_comment
comment|/* This is a pretty bad implementation of uulog, which I don't think    is a very useful program anyhow.  It only takes a single -s and/or    -u switch.  When using HAVE_HDB_LOGGING it requires a system.  */
end_comment

begin_escape
end_escape

begin_comment
comment|/* Local functions.  */
end_comment

begin_decl_stmt
specifier|static
name|void
name|ulusage
name|P
argument_list|(
operator|(
name|void
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|void
name|ulhelp
name|P
argument_list|(
operator|(
name|void
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* Long getopt options.  */
end_comment

begin_decl_stmt
specifier|static
specifier|const
name|struct
name|option
name|asLlongopts
index|[]
init|=
block|{
block|{
literal|"debuglog"
block|,
name|no_argument
block|,
name|NULL
block|,
literal|'D'
block|}
block|,
block|{
literal|"follow"
block|,
name|optional_argument
block|,
name|NULL
block|,
literal|2
block|}
block|,
block|{
literal|"lines"
block|,
name|required_argument
block|,
name|NULL
block|,
literal|'n'
block|}
block|,
block|{
literal|"system"
block|,
name|required_argument
block|,
name|NULL
block|,
literal|'s'
block|}
block|,
block|{
literal|"statslog"
block|,
name|no_argument
block|,
name|NULL
block|,
literal|'S'
block|}
block|,
block|{
literal|"user"
block|,
name|required_argument
block|,
name|NULL
block|,
literal|'u'
block|}
block|,
block|{
literal|"uuxqtlog"
block|,
name|no_argument
block|,
name|NULL
block|,
literal|'x'
block|}
block|,
block|{
literal|"config"
block|,
name|required_argument
block|,
name|NULL
block|,
literal|'I'
block|}
block|,
block|{
literal|"debug"
block|,
name|required_argument
block|,
name|NULL
block|,
literal|'X'
block|}
block|,
block|{
literal|"version"
block|,
name|no_argument
block|,
name|NULL
block|,
literal|'v'
block|}
block|,
block|{
literal|"help"
block|,
name|no_argument
block|,
name|NULL
block|,
literal|1
block|}
block|,
block|{
name|NULL
block|,
literal|0
block|,
name|NULL
block|,
literal|0
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_function
name|int
name|main
parameter_list|(
name|argc
parameter_list|,
name|argv
parameter_list|)
name|int
name|argc
decl_stmt|;
name|char
modifier|*
modifier|*
name|argv
decl_stmt|;
block|{
comment|/* -D: display Debug file */
name|boolean
name|fdebug
init|=
name|FALSE
decl_stmt|;
comment|/* -f: keep displaying lines forever.  */
name|boolean
name|fforever
init|=
name|FALSE
decl_stmt|;
comment|/* -n lines: number of lines to display.  */
name|int
name|cshow
init|=
literal|0
decl_stmt|;
comment|/* -s: system name.  */
specifier|const
name|char
modifier|*
name|zsystem
init|=
name|NULL
decl_stmt|;
comment|/* -S: display Stats file */
name|boolean
name|fstats
init|=
name|FALSE
decl_stmt|;
comment|/* -u: user name.  */
specifier|const
name|char
modifier|*
name|zuser
init|=
name|NULL
decl_stmt|;
comment|/* -I: configuration file name.  */
specifier|const
name|char
modifier|*
name|zconfig
init|=
name|NULL
decl_stmt|;
comment|/* -x: display uuxqt log file.  */
name|boolean
name|fuuxqt
init|=
name|FALSE
decl_stmt|;
name|int
name|i
decl_stmt|;
name|int
name|iopt
decl_stmt|;
name|pointer
name|puuconf
decl_stmt|;
name|int
name|iuuconf
decl_stmt|;
specifier|const
name|char
modifier|*
name|zlogfile
decl_stmt|;
specifier|const
name|char
modifier|*
name|zstatsfile
decl_stmt|;
specifier|const
name|char
modifier|*
name|zdebugfile
decl_stmt|;
specifier|const
name|char
modifier|*
name|zfile
decl_stmt|;
name|FILE
modifier|*
name|e
decl_stmt|;
name|char
modifier|*
modifier|*
name|pzshow
init|=
name|NULL
decl_stmt|;
name|int
name|ishow
init|=
literal|0
decl_stmt|;
name|size_t
name|csystem
init|=
literal|0
decl_stmt|;
name|size_t
name|cuser
init|=
literal|0
decl_stmt|;
name|char
modifier|*
name|zline
decl_stmt|;
name|size_t
name|cline
decl_stmt|;
name|zProgram
operator|=
name|argv
index|[
literal|0
index|]
expr_stmt|;
comment|/* Look for a straight number argument, and convert it to -n before      passing the arguments to getopt.  */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|argc
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|argv
index|[
name|i
index|]
index|[
literal|0
index|]
operator|==
literal|'-'
operator|&&
name|isdigit
argument_list|(
name|argv
index|[
name|i
index|]
index|[
literal|1
index|]
argument_list|)
condition|)
block|{
name|size_t
name|clen
decl_stmt|;
name|char
modifier|*
name|znew
decl_stmt|;
name|clen
operator|=
name|strlen
argument_list|(
name|argv
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|znew
operator|=
name|zbufalc
argument_list|(
name|clen
operator|+
literal|2
argument_list|)
expr_stmt|;
name|znew
index|[
literal|0
index|]
operator|=
literal|'-'
expr_stmt|;
name|znew
index|[
literal|1
index|]
operator|=
literal|'n'
expr_stmt|;
name|memcpy
argument_list|(
name|znew
operator|+
literal|2
argument_list|,
name|argv
index|[
name|i
index|]
operator|+
literal|1
argument_list|,
name|clen
argument_list|)
expr_stmt|;
name|argv
index|[
name|i
index|]
operator|=
name|znew
expr_stmt|;
block|}
block|}
while|while
condition|(
operator|(
name|iopt
operator|=
name|getopt_long
argument_list|(
name|argc
argument_list|,
name|argv
argument_list|,
literal|"Df:FI:n:s:Su:vxX:"
argument_list|,
name|asLlongopts
argument_list|,
operator|(
name|int
operator|*
operator|)
name|NULL
argument_list|)
operator|)
operator|!=
name|EOF
condition|)
block|{
switch|switch
condition|(
name|iopt
condition|)
block|{
case|case
literal|'D'
case|:
comment|/* Show debugging file.  */
name|fdebug
operator|=
name|TRUE
expr_stmt|;
break|break;
case|case
literal|'f'
case|:
comment|/* Keep displaying lines forever for a particular system.  */
name|fforever
operator|=
name|TRUE
expr_stmt|;
name|zsystem
operator|=
name|optarg
expr_stmt|;
if|if
condition|(
name|cshow
operator|==
literal|0
condition|)
name|cshow
operator|=
literal|10
expr_stmt|;
break|break;
case|case
literal|'F'
case|:
comment|/* Keep displaying lines forever.  */
name|fforever
operator|=
name|TRUE
expr_stmt|;
if|if
condition|(
name|cshow
operator|==
literal|0
condition|)
name|cshow
operator|=
literal|10
expr_stmt|;
break|break;
case|case
literal|'I'
case|:
comment|/* Configuration file name.  */
if|if
condition|(
name|fsysdep_other_config
argument_list|(
name|optarg
argument_list|)
condition|)
name|zconfig
operator|=
name|optarg
expr_stmt|;
break|break;
case|case
literal|'n'
case|:
comment|/* Number of lines to display.  */
name|cshow
operator|=
operator|(
name|int
operator|)
name|strtol
argument_list|(
name|optarg
argument_list|,
operator|(
name|char
operator|*
operator|*
operator|)
name|NULL
argument_list|,
literal|10
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'s'
case|:
comment|/* System name.  */
name|zsystem
operator|=
name|optarg
expr_stmt|;
break|break;
case|case
literal|'S'
case|:
comment|/* Show statistics file.  */
name|fstats
operator|=
name|TRUE
expr_stmt|;
break|break;
case|case
literal|'u'
case|:
comment|/* User name.  */
name|zuser
operator|=
name|optarg
expr_stmt|;
break|break;
case|case
literal|'x'
case|:
comment|/* Display uuxqt log file.  */
name|fuuxqt
operator|=
name|TRUE
expr_stmt|;
break|break;
case|case
literal|'X'
case|:
if|#
directive|if
name|DEBUG
operator|>
literal|1
comment|/* Set debugging level.  */
name|iDebug
operator||=
name|idebug_parse
argument_list|(
name|optarg
argument_list|)
expr_stmt|;
endif|#
directive|endif
break|break;
case|case
literal|'v'
case|:
comment|/* Print version and exit.  */
name|printf
argument_list|(
literal|"%s: Taylor UUCP %s, copyright (C) 1991, 92, 93, 94, 1995 Ian Lance Taylor\n"
argument_list|,
name|zProgram
argument_list|,
name|VERSION
argument_list|)
expr_stmt|;
name|exit
argument_list|(
name|EXIT_SUCCESS
argument_list|)
expr_stmt|;
comment|/*NOTREACHED*/
case|case
literal|2
case|:
comment|/* --follow.  */
name|fforever
operator|=
name|TRUE
expr_stmt|;
if|if
condition|(
name|cshow
operator|==
literal|0
condition|)
name|cshow
operator|=
literal|10
expr_stmt|;
if|if
condition|(
name|optarg
operator|!=
name|NULL
condition|)
name|zsystem
operator|=
name|optarg
expr_stmt|;
break|break;
case|case
literal|1
case|:
comment|/* --help.  */
name|ulhelp
argument_list|()
expr_stmt|;
name|exit
argument_list|(
name|EXIT_SUCCESS
argument_list|)
expr_stmt|;
comment|/*NOTREACHED*/
case|case
literal|0
case|:
comment|/* Long option found and flag set.  */
break|break;
default|default:
name|ulusage
argument_list|()
expr_stmt|;
comment|/*NOTREACHED*/
block|}
block|}
if|if
condition|(
name|optind
operator|!=
name|argc
operator|||
operator|(
name|fstats
operator|&&
name|fdebug
operator|)
condition|)
name|ulusage
argument_list|()
expr_stmt|;
name|iuuconf
operator|=
name|uuconf_init
argument_list|(
operator|&
name|puuconf
argument_list|,
operator|(
specifier|const
name|char
operator|*
operator|)
name|NULL
argument_list|,
name|zconfig
argument_list|)
expr_stmt|;
if|if
condition|(
name|iuuconf
operator|!=
name|UUCONF_SUCCESS
condition|)
name|ulog_uuconf
argument_list|(
name|LOG_FATAL
argument_list|,
name|puuconf
argument_list|,
name|iuuconf
argument_list|)
expr_stmt|;
if|#
directive|if
name|DEBUG
operator|>
literal|1
block|{
specifier|const
name|char
modifier|*
name|zdebug
decl_stmt|;
name|iuuconf
operator|=
name|uuconf_debuglevel
argument_list|(
name|puuconf
argument_list|,
operator|&
name|zdebug
argument_list|)
expr_stmt|;
if|if
condition|(
name|iuuconf
operator|!=
name|UUCONF_SUCCESS
condition|)
name|ulog_uuconf
argument_list|(
name|LOG_FATAL
argument_list|,
name|puuconf
argument_list|,
name|iuuconf
argument_list|)
expr_stmt|;
if|if
condition|(
name|zdebug
operator|!=
name|NULL
condition|)
name|iDebug
operator||=
name|idebug_parse
argument_list|(
name|zdebug
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
name|iuuconf
operator|=
name|uuconf_logfile
argument_list|(
name|puuconf
argument_list|,
operator|&
name|zlogfile
argument_list|)
expr_stmt|;
if|if
condition|(
name|iuuconf
operator|!=
name|UUCONF_SUCCESS
condition|)
name|ulog_uuconf
argument_list|(
name|LOG_FATAL
argument_list|,
name|puuconf
argument_list|,
name|iuuconf
argument_list|)
expr_stmt|;
name|iuuconf
operator|=
name|uuconf_statsfile
argument_list|(
name|puuconf
argument_list|,
operator|&
name|zstatsfile
argument_list|)
expr_stmt|;
if|if
condition|(
name|iuuconf
operator|!=
name|UUCONF_SUCCESS
condition|)
name|ulog_uuconf
argument_list|(
name|LOG_FATAL
argument_list|,
name|puuconf
argument_list|,
name|iuuconf
argument_list|)
expr_stmt|;
name|iuuconf
operator|=
name|uuconf_debugfile
argument_list|(
name|puuconf
argument_list|,
operator|&
name|zdebugfile
argument_list|)
expr_stmt|;
if|if
condition|(
name|iuuconf
operator|!=
name|UUCONF_SUCCESS
condition|)
name|ulog_uuconf
argument_list|(
name|LOG_FATAL
argument_list|,
name|puuconf
argument_list|,
name|iuuconf
argument_list|)
expr_stmt|;
name|usysdep_initialize
argument_list|(
name|puuconf
argument_list|,
name|INIT_NOCHDIR
argument_list|)
expr_stmt|;
if|if
condition|(
name|zsystem
operator|!=
name|NULL
condition|)
block|{
if|#
directive|if
name|HAVE_HDB_LOGGING
if|if
condition|(
name|strcmp
argument_list|(
name|zsystem
argument_list|,
literal|"ANY"
argument_list|)
operator|!=
literal|0
condition|)
endif|#
directive|endif
block|{
name|struct
name|uuconf_system
name|ssys
decl_stmt|;
comment|/* Canonicalize the system name.  If we can't find the 	     system information, just use whatever we were given so 	     that people can check on systems that logged in 	     anonymously.  */
name|iuuconf
operator|=
name|uuconf_system_info
argument_list|(
name|puuconf
argument_list|,
name|zsystem
argument_list|,
operator|&
name|ssys
argument_list|)
expr_stmt|;
if|if
condition|(
name|iuuconf
operator|==
name|UUCONF_SUCCESS
condition|)
block|{
name|zsystem
operator|=
name|zbufcpy
argument_list|(
name|ssys
operator|.
name|uuconf_zname
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|uuconf_system_free
argument_list|(
name|puuconf
argument_list|,
operator|&
name|ssys
argument_list|)
expr_stmt|;
block|}
block|}
block|}
if|if
condition|(
name|fstats
condition|)
name|zfile
operator|=
name|zstatsfile
expr_stmt|;
elseif|else
if|if
condition|(
name|fdebug
condition|)
name|zfile
operator|=
name|zdebugfile
expr_stmt|;
else|else
block|{
if|#
directive|if
operator|!
name|HAVE_HDB_LOGGING
name|zfile
operator|=
name|zlogfile
expr_stmt|;
else|#
directive|else
specifier|const
name|char
modifier|*
name|zprogram
decl_stmt|;
name|char
modifier|*
name|zalc
decl_stmt|;
comment|/* We need a system to find a HDB log file.  */
if|if
condition|(
name|zsystem
operator|==
name|NULL
condition|)
name|ulog
argument_list|(
name|LOG_FATAL
argument_list|,
literal|"system name (-s argument) required for HDB format log files"
argument_list|)
expr_stmt|;
if|if
condition|(
name|fuuxqt
condition|)
name|zprogram
operator|=
literal|"uuxqt"
expr_stmt|;
else|else
name|zprogram
operator|=
literal|"uucico"
expr_stmt|;
name|zalc
operator|=
name|zbufalc
argument_list|(
name|strlen
argument_list|(
name|zlogfile
argument_list|)
operator|+
name|strlen
argument_list|(
name|zprogram
argument_list|)
operator|+
name|strlen
argument_list|(
name|zsystem
argument_list|)
operator|+
literal|1
argument_list|)
expr_stmt|;
name|sprintf
argument_list|(
name|zalc
argument_list|,
name|zlogfile
argument_list|,
name|zprogram
argument_list|,
name|zsystem
argument_list|)
expr_stmt|;
name|zfile
operator|=
name|zalc
expr_stmt|;
if|if
condition|(
operator|!
name|fsysdep_file_exists
argument_list|(
name|zfile
argument_list|)
condition|)
name|ulog
argument_list|(
name|LOG_FATAL
argument_list|,
literal|"no log file available for system %s"
argument_list|,
name|zsystem
argument_list|)
expr_stmt|;
if|if
condition|(
name|strcmp
argument_list|(
name|zsystem
argument_list|,
literal|"ANY"
argument_list|)
operator|==
literal|0
condition|)
name|zsystem
operator|=
name|NULL
expr_stmt|;
endif|#
directive|endif
block|}
name|e
operator|=
name|fopen
argument_list|(
name|zfile
argument_list|,
literal|"r"
argument_list|)
expr_stmt|;
if|if
condition|(
name|e
operator|==
name|NULL
condition|)
block|{
name|ulog
argument_list|(
name|LOG_ERROR
argument_list|,
literal|"fopen (%s): %s"
argument_list|,
name|zfile
argument_list|,
name|strerror
argument_list|(
name|errno
argument_list|)
argument_list|)
expr_stmt|;
name|usysdep_exit
argument_list|(
name|FALSE
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|cshow
operator|>
literal|0
condition|)
block|{
name|pzshow
operator|=
operator|(
name|char
operator|*
operator|*
operator|)
name|xmalloc
argument_list|(
name|cshow
operator|*
sizeof|sizeof
argument_list|(
name|char
operator|*
argument_list|)
argument_list|)
expr_stmt|;
for|for
control|(
name|ishow
operator|=
literal|0
init|;
name|ishow
operator|<
name|cshow
condition|;
name|ishow
operator|++
control|)
name|pzshow
index|[
name|ishow
index|]
operator|=
name|NULL
expr_stmt|;
name|ishow
operator|=
literal|0
expr_stmt|;
block|}
comment|/* Read the log file and output the appropriate lines.  */
if|if
condition|(
name|zsystem
operator|!=
name|NULL
condition|)
name|csystem
operator|=
name|strlen
argument_list|(
name|zsystem
argument_list|)
expr_stmt|;
if|if
condition|(
name|zuser
operator|!=
name|NULL
condition|)
name|cuser
operator|=
name|strlen
argument_list|(
name|zuser
argument_list|)
expr_stmt|;
name|zline
operator|=
name|NULL
expr_stmt|;
name|cline
operator|=
literal|0
expr_stmt|;
while|while
condition|(
name|TRUE
condition|)
block|{
while|while
condition|(
name|getline
argument_list|(
operator|&
name|zline
argument_list|,
operator|&
name|cline
argument_list|,
name|e
argument_list|)
operator|>
literal|0
condition|)
block|{
name|char
modifier|*
name|zluser
decl_stmt|,
modifier|*
name|zlsys
decl_stmt|,
modifier|*
name|znext
decl_stmt|;
name|size_t
name|cluser
decl_stmt|,
name|clsys
decl_stmt|;
comment|/* Skip any leading whitespace (not that there should be 	     any).  */
name|znext
operator|=
name|zline
operator|+
name|strspn
argument_list|(
name|zline
argument_list|,
literal|" \t"
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|fstats
condition|)
block|{
if|#
directive|if
operator|!
name|HAVE_TAYLOR_LOGGING
comment|/* The user name is the first field on the line.  */
name|zluser
operator|=
name|znext
expr_stmt|;
name|cluser
operator|=
name|strcspn
argument_list|(
name|znext
argument_list|,
literal|" \t"
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* Skip the first field.  */
name|znext
operator|+=
name|strcspn
argument_list|(
name|znext
argument_list|,
literal|" \t"
argument_list|)
expr_stmt|;
name|znext
operator|+=
name|strspn
argument_list|(
name|znext
argument_list|,
literal|" \t"
argument_list|)
expr_stmt|;
comment|/* The system is the second field on the line.  */
name|zlsys
operator|=
name|znext
expr_stmt|;
name|clsys
operator|=
name|strcspn
argument_list|(
name|znext
argument_list|,
literal|" \t"
argument_list|)
expr_stmt|;
comment|/* Skip the second field.  */
name|znext
operator|+=
name|clsys
expr_stmt|;
name|znext
operator|+=
name|strspn
argument_list|(
name|znext
argument_list|,
literal|" \t"
argument_list|)
expr_stmt|;
if|#
directive|if
name|HAVE_TAYLOR_LOGGING
comment|/* The user is the third field on the line.  */
name|zluser
operator|=
name|znext
expr_stmt|;
name|cluser
operator|=
name|strcspn
argument_list|(
name|znext
argument_list|,
literal|" \t"
argument_list|)
expr_stmt|;
endif|#
directive|endif
block|}
else|else
block|{
if|#
directive|if
operator|!
name|HAVE_HDB_LOGGING
comment|/* The user name is the first field on the line, and the 		 system name is the second.  */
name|zluser
operator|=
name|znext
expr_stmt|;
name|cluser
operator|=
name|strcspn
argument_list|(
name|znext
argument_list|,
literal|" \t"
argument_list|)
expr_stmt|;
name|znext
operator|+=
name|cluser
expr_stmt|;
name|znext
operator|+=
name|strspn
argument_list|(
name|znext
argument_list|,
literal|" \t"
argument_list|)
expr_stmt|;
name|zlsys
operator|=
name|znext
expr_stmt|;
name|clsys
operator|=
name|strcspn
argument_list|(
name|znext
argument_list|,
literal|" \t"
argument_list|)
expr_stmt|;
else|#
directive|else
comment|/* The first field is system!user.  */
name|zlsys
operator|=
name|znext
expr_stmt|;
name|clsys
operator|=
name|strcspn
argument_list|(
name|znext
argument_list|,
literal|"!"
argument_list|)
expr_stmt|;
name|znext
operator|+=
name|clsys
operator|+
literal|1
expr_stmt|;
name|zluser
operator|=
name|znext
expr_stmt|;
name|cluser
operator|=
name|strcspn
argument_list|(
name|znext
argument_list|,
literal|" \t"
argument_list|)
expr_stmt|;
endif|#
directive|endif
block|}
comment|/* See if we should print this line.  */
if|if
condition|(
name|zsystem
operator|!=
name|NULL
operator|&&
operator|(
name|csystem
operator|!=
name|clsys
operator|||
name|strncmp
argument_list|(
name|zsystem
argument_list|,
name|zlsys
argument_list|,
name|clsys
argument_list|)
operator|!=
literal|0
operator|)
condition|)
continue|continue;
if|if
condition|(
name|zuser
operator|!=
name|NULL
operator|&&
operator|(
name|cuser
operator|!=
name|cluser
operator|||
name|strncmp
argument_list|(
name|zuser
argument_list|,
name|zluser
argument_list|,
name|cluser
argument_list|)
operator|!=
literal|0
operator|)
condition|)
continue|continue;
comment|/* Output the line, or save it if we are outputting only a 	     particular number of lines.  */
if|if
condition|(
name|cshow
operator|<=
literal|0
condition|)
name|printf
argument_list|(
literal|"%s"
argument_list|,
name|zline
argument_list|)
expr_stmt|;
else|else
block|{
name|ubuffree
argument_list|(
operator|(
name|pointer
operator|)
name|pzshow
index|[
name|ishow
index|]
argument_list|)
expr_stmt|;
name|pzshow
index|[
name|ishow
index|]
operator|=
name|zbufcpy
argument_list|(
name|zline
argument_list|)
expr_stmt|;
name|ishow
operator|=
operator|(
name|ishow
operator|+
literal|1
operator|)
operator|%
name|cshow
expr_stmt|;
block|}
block|}
comment|/* Output the number of lines requested by the -n option.  */
if|if
condition|(
name|cshow
operator|>
literal|0
condition|)
block|{
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|cshow
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|pzshow
index|[
name|ishow
index|]
operator|!=
name|NULL
condition|)
name|printf
argument_list|(
literal|"%s"
argument_list|,
name|pzshow
index|[
name|ishow
index|]
argument_list|)
expr_stmt|;
name|ishow
operator|=
operator|(
name|ishow
operator|+
literal|1
operator|)
operator|%
name|cshow
expr_stmt|;
block|}
block|}
comment|/* If -f was not specified, or an error occurred while reading 	 the file, get out.  */
if|if
condition|(
operator|!
name|fforever
operator|||
name|ferror
argument_list|(
name|e
argument_list|)
condition|)
break|break;
name|clearerr
argument_list|(
name|e
argument_list|)
expr_stmt|;
name|cshow
operator|=
literal|0
expr_stmt|;
comment|/* Sleep 1 second before going around the loop again.  */
name|usysdep_sleep
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
operator|(
name|void
operator|)
name|fclose
argument_list|(
name|e
argument_list|)
expr_stmt|;
name|ulog_close
argument_list|()
expr_stmt|;
name|usysdep_exit
argument_list|(
name|TRUE
argument_list|)
expr_stmt|;
comment|/* Avoid errors about not returning a value.  */
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/* Print a usage message and die.  */
end_comment

begin_function
specifier|static
name|void
name|ulusage
parameter_list|()
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Usage: %s [-n #] [-sf system] [-u user] [-xDSF] [-I file] [-X debug]\n"
argument_list|,
name|zProgram
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Use %s --help for help\n"
argument_list|,
name|zProgram
argument_list|)
expr_stmt|;
name|exit
argument_list|(
name|EXIT_FAILURE
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* Print a help message.  */
end_comment

begin_function
specifier|static
name|void
name|ulhelp
parameter_list|()
block|{
name|printf
argument_list|(
literal|"Taylor UUCP %s, copyright (C) 1991, 92, 93, 94, 1995 Ian Lance Taylor\n"
argument_list|,
name|VERSION
argument_list|)
expr_stmt|;
if|#
directive|if
name|HAVE_HDB_LOGGING
name|printf
argument_list|(
literal|"Usage: %s [-n #] [-sf system] [-u user] [-xDS] [-I file] [-X debug]\n"
argument_list|,
name|zProgram
argument_list|)
expr_stmt|;
else|#
directive|else
name|printf
argument_list|(
literal|"Usage: %s [-n #] [-sf system] [-u user] [-DSF] [-I file] [-X debug]\n"
argument_list|,
name|zProgram
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|printf
argument_list|(
literal|" -n,--lines: show given number of lines from end of log\n"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|" -s,--system: print entries for named system\n"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|" -f system,--follow=system: follow entries for named system\n"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|" -u,--user user: print entries for named user\n"
argument_list|)
expr_stmt|;
if|#
directive|if
name|HAVE_HDB_LOGGING
name|printf
argument_list|(
literal|" -x,--uuxqt: print uuxqt log rather than uucico log\n"
argument_list|)
expr_stmt|;
else|#
directive|else
name|printf
argument_list|(
literal|" -F,--follow: follow entries for any system\n"
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|printf
argument_list|(
literal|" -S,--statslog: show statistics file\n"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|" -D,--debuglog: show debugging file\n"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|" -X,--debug debug: Set debugging level\n"
argument_list|)
expr_stmt|;
if|#
directive|if
name|HAVE_TAYLOR_CONFIG
name|printf
argument_list|(
literal|" -I,--config file: Set configuration file to use\n"
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* HAVE_TAYLOR_CONFIG */
name|printf
argument_list|(
literal|" -v,--version: Print version and exit\n"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|" --help: Print help and exit\n"
argument_list|)
expr_stmt|;
block|}
end_function

end_unit


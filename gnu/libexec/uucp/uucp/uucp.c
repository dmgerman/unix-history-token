begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/* uucp.c    Prepare to copy a file to or from a remote system.     Copyright (C) 1991, 1992, 1993, 1994, 1995 Ian Lance Taylor     This file is part of the Taylor UUCP package.     This program is free software; you can redistribute it and/or    modify it under the terms of the GNU General Public License as    published by the Free Software Foundation; either version 2 of the    License, or (at your option) any later version.     This program is distributed in the hope that it will be useful, but    WITHOUT ANY WARRANTY; without even the implied warranty of    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU    General Public License for more details.     You should have received a copy of the GNU General Public License    along with this program; if not, write to the Free Software    Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.     The author of the program may be contacted at ian@airs.com or    c/o Cygnus Support, 48 Grove Street, Somerville, MA 02144.    */
end_comment

begin_include
include|#
directive|include
file|"uucp.h"
end_include

begin_if
if|#
directive|if
name|USE_RCS_ID
end_if

begin_decl_stmt
specifier|const
name|char
name|uucp_rcsid
index|[]
init|=
literal|"$FreeBSD$"
decl_stmt|;
end_decl_stmt

begin_endif
endif|#
directive|endif
end_endif

begin_include
include|#
directive|include
file|<ctype.h>
end_include

begin_include
include|#
directive|include
file|<errno.h>
end_include

begin_include
include|#
directive|include
file|"getopt.h"
end_include

begin_include
include|#
directive|include
file|"uudefs.h"
end_include

begin_include
include|#
directive|include
file|"uuconf.h"
end_include

begin_include
include|#
directive|include
file|"system.h"
end_include

begin_escape
end_escape

begin_comment
comment|/* Local functions.  */
end_comment

begin_decl_stmt
specifier|static
name|void
name|ucusage
name|P
argument_list|(
operator|(
name|void
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|void
name|uchelp
name|P
argument_list|(
operator|(
name|void
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|void
name|ucdirfile
name|P
argument_list|(
operator|(
specifier|const
name|char
operator|*
name|zdir
operator|,
specifier|const
name|char
operator|*
name|zfile
operator|,
name|pointer
name|pinfo
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|void
name|uccopy
name|P
argument_list|(
operator|(
specifier|const
name|char
operator|*
name|zfile
operator|,
specifier|const
name|char
operator|*
name|zdest
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|void
name|ucadd_cmd
name|P
argument_list|(
operator|(
specifier|const
expr|struct
name|uuconf_system
operator|*
name|qsys
operator|,
specifier|const
expr|struct
name|scmd
operator|*
name|qcmd
operator|,
specifier|const
name|char
operator|*
name|zlog
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|void
name|ucspool_cmds
name|P
argument_list|(
operator|(
name|boolean
name|fjobid
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
specifier|const
name|char
modifier|*
name|zcone_system
name|P
argument_list|(
operator|(
name|boolean
operator|*
name|pfany
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|void
name|ucrecord_file
name|P
argument_list|(
operator|(
specifier|const
name|char
operator|*
name|zfile
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|void
name|ucabort
name|P
argument_list|(
operator|(
name|void
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_escape
end_escape

begin_comment
comment|/* Long getopt options.  */
end_comment

begin_decl_stmt
specifier|static
specifier|const
name|struct
name|option
name|asClongopts
index|[]
init|=
block|{
block|{
literal|"copy"
block|,
name|no_argument
block|,
name|NULL
block|,
literal|'C'
block|}
block|,
block|{
literal|"nocopy"
block|,
name|no_argument
block|,
name|NULL
block|,
literal|'c'
block|}
block|,
block|{
literal|"directories"
block|,
name|no_argument
block|,
name|NULL
block|,
literal|'d'
block|}
block|,
block|{
literal|"nodirectories"
block|,
name|no_argument
block|,
name|NULL
block|,
literal|'f'
block|}
block|,
block|{
literal|"grade"
block|,
name|required_argument
block|,
name|NULL
block|,
literal|'g'
block|}
block|,
block|{
literal|"jobid"
block|,
name|no_argument
block|,
name|NULL
block|,
literal|'j'
block|}
block|,
block|{
literal|"mail"
block|,
name|no_argument
block|,
name|NULL
block|,
literal|'m'
block|}
block|,
block|{
literal|"notify"
block|,
name|required_argument
block|,
name|NULL
block|,
literal|'n'
block|}
block|,
block|{
literal|"nouucico"
block|,
name|no_argument
block|,
name|NULL
block|,
literal|'r'
block|}
block|,
block|{
literal|"recursive"
block|,
name|no_argument
block|,
name|NULL
block|,
literal|'R'
block|}
block|,
block|{
literal|"status"
block|,
name|required_argument
block|,
name|NULL
block|,
literal|'s'
block|}
block|,
block|{
literal|"uuto"
block|,
name|no_argument
block|,
name|NULL
block|,
literal|'t'
block|}
block|,
block|{
literal|"user"
block|,
name|required_argument
block|,
name|NULL
block|,
literal|'u'
block|}
block|,
block|{
literal|"noexpand"
block|,
name|no_argument
block|,
name|NULL
block|,
literal|'w'
block|}
block|,
block|{
literal|"config"
block|,
name|required_argument
block|,
name|NULL
block|,
literal|'I'
block|}
block|,
block|{
literal|"debug"
block|,
name|required_argument
block|,
name|NULL
block|,
literal|'x'
block|}
block|,
block|{
literal|"version"
block|,
name|no_argument
block|,
name|NULL
block|,
literal|'v'
block|}
block|,
block|{
literal|"help"
block|,
name|no_argument
block|,
name|NULL
block|,
literal|1
block|}
block|,
block|{
name|NULL
block|,
literal|0
block|,
name|NULL
block|,
literal|0
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* Local variables.  There are a bunch of these, mostly set by the    options and the last (the destination) argument.  These have file    scope so that they may be easily passed into uccopy; they could for    the most part also be wrapped up in a structure and passed in.  */
end_comment

begin_comment
comment|/* The uuconf global pointer.  */
end_comment

begin_decl_stmt
specifier|static
name|pointer
name|pCuuconf
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* TRUE if source files should be copied to the spool directory.  */
end_comment

begin_decl_stmt
specifier|static
name|boolean
name|fCcopy
init|=
name|TRUE
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* Grade to use.  */
end_comment

begin_decl_stmt
specifier|static
name|char
name|bCgrade
init|=
name|BDEFAULT_UUCP_GRADE
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* Whether to send mail to the requesting user when the copy is    complete.  */
end_comment

begin_decl_stmt
specifier|static
name|boolean
name|fCmail
init|=
name|FALSE
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* User to notify on remote system.  */
end_comment

begin_decl_stmt
specifier|static
specifier|const
name|char
modifier|*
name|zCnotify
init|=
literal|""
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* TRUE if remote files should be prefixed with the current working    directory.  */
end_comment

begin_decl_stmt
specifier|static
name|boolean
name|fCexpand
init|=
name|TRUE
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* TRUE if necessary directories should be created on the destination    system.  */
end_comment

begin_decl_stmt
specifier|static
name|boolean
name|fCmkdirs
init|=
name|TRUE
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* Local name.  */
end_comment

begin_decl_stmt
specifier|static
specifier|const
name|char
modifier|*
name|zClocalname
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* User name.  */
end_comment

begin_decl_stmt
specifier|static
specifier|const
name|char
modifier|*
name|zCuser
init|=
name|NULL
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* TRUE if this is a remote request.  */
end_comment

begin_decl_stmt
specifier|static
name|boolean
name|fCremote
init|=
name|FALSE
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* TRUE if the destination is this system.  */
end_comment

begin_decl_stmt
specifier|static
name|boolean
name|fClocaldest
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* Destination system.  */
end_comment

begin_decl_stmt
specifier|static
name|struct
name|uuconf_system
name|sCdestsys
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* Systems to forward to, if not NULL.  */
end_comment

begin_decl_stmt
specifier|static
name|char
modifier|*
name|zCforward
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* Options to use when sending a file.  */
end_comment

begin_decl_stmt
specifier|static
name|char
name|abCsend_options
index|[
literal|20
index|]
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* Options to use when receiving a file.  */
end_comment

begin_decl_stmt
specifier|static
name|char
name|abCrec_options
index|[
literal|20
index|]
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* TRUE if the current file being copied from is in the cwd.  */
end_comment

begin_decl_stmt
specifier|static
name|boolean
name|fCneeds_cwd
decl_stmt|;
end_decl_stmt

begin_escape
end_escape

begin_comment
comment|/* The main program.  */
end_comment

begin_function
name|int
name|main
parameter_list|(
name|argc
parameter_list|,
name|argv
parameter_list|)
name|int
name|argc
decl_stmt|;
name|char
modifier|*
modifier|*
name|argv
decl_stmt|;
block|{
comment|/* -I: configuration file name.  */
specifier|const
name|char
modifier|*
name|zconfig
init|=
name|NULL
decl_stmt|;
comment|/* -j: output job id.  */
name|boolean
name|fjobid
init|=
name|FALSE
decl_stmt|;
comment|/* -r: don't start uucico when finished.  */
name|boolean
name|fuucico
init|=
name|TRUE
decl_stmt|;
comment|/* -R: copy directories recursively.  */
name|boolean
name|frecursive
init|=
name|FALSE
decl_stmt|;
comment|/* -s: report status to named file.  */
specifier|const
name|char
modifier|*
name|zstatus_file
init|=
name|NULL
decl_stmt|;
comment|/* -t: emulate uuto.  */
name|boolean
name|fuuto
init|=
name|FALSE
decl_stmt|;
name|int
name|iopt
decl_stmt|;
name|pointer
name|puuconf
decl_stmt|;
name|int
name|iuuconf
decl_stmt|;
name|int
name|i
decl_stmt|;
name|boolean
name|fgetcwd
decl_stmt|;
name|struct
name|uuconf_system
name|slocalsys
decl_stmt|;
name|char
modifier|*
name|zexclam
decl_stmt|;
name|char
modifier|*
name|zdestfile
decl_stmt|;
specifier|const
name|char
modifier|*
name|zdestsys
decl_stmt|;
name|char
modifier|*
name|zoptions
decl_stmt|;
name|boolean
name|fexit
decl_stmt|;
name|zProgram
operator|=
name|argv
index|[
literal|0
index|]
expr_stmt|;
while|while
condition|(
operator|(
name|iopt
operator|=
name|getopt_long
argument_list|(
name|argc
argument_list|,
name|argv
argument_list|,
literal|"cCdfg:I:jmn:prRs:tu:Wvx:"
argument_list|,
name|asClongopts
argument_list|,
operator|(
name|int
operator|*
operator|)
name|NULL
argument_list|)
operator|)
operator|!=
name|EOF
condition|)
block|{
switch|switch
condition|(
name|iopt
condition|)
block|{
case|case
literal|'c'
case|:
comment|/* Do not copy local files to spool directory.  */
name|fCcopy
operator|=
name|FALSE
expr_stmt|;
break|break;
case|case
literal|'p'
case|:
case|case
literal|'C'
case|:
comment|/* Copy local files to spool directory.  */
name|fCcopy
operator|=
name|TRUE
expr_stmt|;
break|break;
case|case
literal|'d'
case|:
comment|/* Create directories if necessary.  */
name|fCmkdirs
operator|=
name|TRUE
expr_stmt|;
break|break;
case|case
literal|'f'
case|:
comment|/* Do not create directories if they don't exist.  */
name|fCmkdirs
operator|=
name|FALSE
expr_stmt|;
break|break;
case|case
literal|'g'
case|:
comment|/* Set job grade.  */
name|bCgrade
operator|=
name|optarg
index|[
literal|0
index|]
expr_stmt|;
break|break;
case|case
literal|'I'
case|:
comment|/* Name configuration file.  */
if|if
condition|(
name|fsysdep_other_config
argument_list|(
name|optarg
argument_list|)
condition|)
name|zconfig
operator|=
name|optarg
expr_stmt|;
break|break;
case|case
literal|'j'
case|:
comment|/* Output job id.  */
name|fjobid
operator|=
name|TRUE
expr_stmt|;
break|break;
case|case
literal|'m'
case|:
comment|/* Mail to requesting user.  */
name|fCmail
operator|=
name|TRUE
expr_stmt|;
break|break;
case|case
literal|'n'
case|:
comment|/* Notify remote user.  */
name|zCnotify
operator|=
name|optarg
expr_stmt|;
break|break;
case|case
literal|'r'
case|:
comment|/* Don't start uucico when finished.  */
name|fuucico
operator|=
name|FALSE
expr_stmt|;
break|break;
case|case
literal|'R'
case|:
comment|/* Copy directories recursively.  */
name|frecursive
operator|=
name|TRUE
expr_stmt|;
break|break;
case|case
literal|'s'
case|:
comment|/* Report status to named file.  */
name|zstatus_file
operator|=
name|optarg
expr_stmt|;
break|break;
case|case
literal|'t'
case|:
comment|/* Emulate uuto.  */
name|fuuto
operator|=
name|TRUE
expr_stmt|;
break|break;
case|case
literal|'u'
case|:
comment|/* Set user name.  */
name|zCuser
operator|=
name|optarg
expr_stmt|;
break|break;
case|case
literal|'W'
case|:
comment|/* Expand only local file names.  */
name|fCexpand
operator|=
name|FALSE
expr_stmt|;
break|break;
case|case
literal|'x'
case|:
if|#
directive|if
name|DEBUG
operator|>
literal|1
comment|/* Set debugging level.  */
name|iDebug
operator||=
name|idebug_parse
argument_list|(
name|optarg
argument_list|)
expr_stmt|;
endif|#
directive|endif
break|break;
case|case
literal|'v'
case|:
comment|/* Print version and exit.  */
name|printf
argument_list|(
literal|"%s: Taylor UUCP %s, copyright (C) 1991, 92, 93, 94, 1995 Ian Lance Taylor\n"
argument_list|,
name|zProgram
argument_list|,
name|VERSION
argument_list|)
expr_stmt|;
name|exit
argument_list|(
name|EXIT_SUCCESS
argument_list|)
expr_stmt|;
comment|/*NOTREACHED*/
case|case
literal|1
case|:
comment|/* --help.  */
name|uchelp
argument_list|()
expr_stmt|;
name|exit
argument_list|(
name|EXIT_SUCCESS
argument_list|)
expr_stmt|;
comment|/*NOTREACHED*/
case|case
literal|0
case|:
comment|/* Long option found and flag set.  */
break|break;
default|default:
name|ucusage
argument_list|()
expr_stmt|;
comment|/*NOTREACHED*/
block|}
block|}
if|if
condition|(
operator|!
name|UUCONF_GRADE_LEGAL
argument_list|(
name|bCgrade
argument_list|)
operator|||
operator|(
operator|(
name|bCgrade
operator|<
literal|'0'
operator|||
name|bCgrade
operator|>
literal|'9'
operator|)
operator|&&
operator|(
name|bCgrade
operator|<
literal|'a'
operator|||
name|bCgrade
operator|>
literal|'z'
operator|)
operator|&&
operator|(
name|bCgrade
operator|<
literal|'A'
operator|||
name|bCgrade
operator|>
literal|'Z'
operator|)
operator|)
condition|)
block|{
name|ulog
argument_list|(
name|LOG_ERROR
argument_list|,
literal|"Ignoring illegal grade"
argument_list|)
expr_stmt|;
name|bCgrade
operator|=
name|BDEFAULT_UUCP_GRADE
expr_stmt|;
block|}
comment|/* The user name must contain a '!', which is treated as a remote      name, to avoid spoofing of other users (there is no advantage to      spoofing remote users, except to send them random bits of mail,      which you can do anyhow).  */
if|if
condition|(
name|zCuser
operator|!=
name|NULL
condition|)
block|{
if|if
condition|(
name|strchr
argument_list|(
name|zCuser
argument_list|,
literal|'!'
argument_list|)
operator|!=
name|NULL
condition|)
name|fCremote
operator|=
name|TRUE
expr_stmt|;
else|else
block|{
name|ulog
argument_list|(
name|LOG_ERROR
argument_list|,
literal|"Ignoring local user name"
argument_list|)
expr_stmt|;
name|zCuser
operator|=
name|NULL
expr_stmt|;
block|}
block|}
if|if
condition|(
name|argc
operator|-
name|optind
operator|<
literal|2
condition|)
name|ucusage
argument_list|()
expr_stmt|;
name|iuuconf
operator|=
name|uuconf_init
argument_list|(
operator|&
name|puuconf
argument_list|,
operator|(
specifier|const
name|char
operator|*
operator|)
name|NULL
argument_list|,
name|zconfig
argument_list|)
expr_stmt|;
if|if
condition|(
name|iuuconf
operator|!=
name|UUCONF_SUCCESS
condition|)
name|ulog_uuconf
argument_list|(
name|LOG_FATAL
argument_list|,
name|puuconf
argument_list|,
name|iuuconf
argument_list|)
expr_stmt|;
name|pCuuconf
operator|=
name|puuconf
expr_stmt|;
if|#
directive|if
name|DEBUG
operator|>
literal|1
block|{
specifier|const
name|char
modifier|*
name|zdebug
decl_stmt|;
name|iuuconf
operator|=
name|uuconf_debuglevel
argument_list|(
name|puuconf
argument_list|,
operator|&
name|zdebug
argument_list|)
expr_stmt|;
if|if
condition|(
name|iuuconf
operator|!=
name|UUCONF_SUCCESS
condition|)
name|ulog_uuconf
argument_list|(
name|LOG_FATAL
argument_list|,
name|puuconf
argument_list|,
name|iuuconf
argument_list|)
expr_stmt|;
if|if
condition|(
name|zdebug
operator|!=
name|NULL
condition|)
name|iDebug
operator||=
name|idebug_parse
argument_list|(
name|zdebug
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
comment|/* See if we are going to need to know the current directory.  We      just check each argument to see whether it's an absolute      pathname.  We actually aren't going to need the cwd if fCexpand      is FALSE and the file is remote, but so what.  */
name|fgetcwd
operator|=
name|FALSE
expr_stmt|;
for|for
control|(
name|i
operator|=
name|optind
init|;
name|i
operator|<
name|argc
condition|;
name|i
operator|++
control|)
block|{
name|zexclam
operator|=
name|strrchr
argument_list|(
name|argv
index|[
name|i
index|]
argument_list|,
literal|'!'
argument_list|)
expr_stmt|;
if|if
condition|(
name|zexclam
operator|==
name|NULL
condition|)
name|zexclam
operator|=
name|argv
index|[
name|i
index|]
expr_stmt|;
else|else
operator|++
name|zexclam
expr_stmt|;
if|if
condition|(
name|fsysdep_needs_cwd
argument_list|(
name|zexclam
argument_list|)
condition|)
block|{
name|fgetcwd
operator|=
name|TRUE
expr_stmt|;
break|break;
block|}
block|}
ifdef|#
directive|ifdef
name|SIGINT
name|usysdep_signal
argument_list|(
name|SIGINT
argument_list|)
expr_stmt|;
endif|#
directive|endif
ifdef|#
directive|ifdef
name|SIGHUP
name|usysdep_signal
argument_list|(
name|SIGHUP
argument_list|)
expr_stmt|;
endif|#
directive|endif
ifdef|#
directive|ifdef
name|SIGQUIT
name|usysdep_signal
argument_list|(
name|SIGQUIT
argument_list|)
expr_stmt|;
endif|#
directive|endif
ifdef|#
directive|ifdef
name|SIGTERM
name|usysdep_signal
argument_list|(
name|SIGTERM
argument_list|)
expr_stmt|;
endif|#
directive|endif
ifdef|#
directive|ifdef
name|SIGPIPE
name|usysdep_signal
argument_list|(
name|SIGPIPE
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|usysdep_initialize
argument_list|(
name|puuconf
argument_list|,
name|INIT_SUID
operator||
operator|(
name|fgetcwd
condition|?
name|INIT_GETCWD
else|:
literal|0
operator|)
argument_list|)
expr_stmt|;
name|ulog_fatal_fn
argument_list|(
name|ucabort
argument_list|)
expr_stmt|;
if|if
condition|(
name|zCuser
operator|==
name|NULL
condition|)
name|zCuser
operator|=
name|zsysdep_login_name
argument_list|()
expr_stmt|;
name|iuuconf
operator|=
name|uuconf_localname
argument_list|(
name|puuconf
argument_list|,
operator|&
name|zClocalname
argument_list|)
expr_stmt|;
if|if
condition|(
name|iuuconf
operator|==
name|UUCONF_NOT_FOUND
condition|)
block|{
name|zClocalname
operator|=
name|zsysdep_localname
argument_list|()
expr_stmt|;
if|if
condition|(
name|zClocalname
operator|==
name|NULL
condition|)
name|exit
argument_list|(
name|EXIT_FAILURE
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|iuuconf
operator|!=
name|UUCONF_SUCCESS
condition|)
name|ulog_uuconf
argument_list|(
name|LOG_FATAL
argument_list|,
name|puuconf
argument_list|,
name|iuuconf
argument_list|)
expr_stmt|;
comment|/* Get the local system information.  */
name|iuuconf
operator|=
name|uuconf_system_info
argument_list|(
name|puuconf
argument_list|,
name|zClocalname
argument_list|,
operator|&
name|slocalsys
argument_list|)
expr_stmt|;
if|if
condition|(
name|iuuconf
operator|!=
name|UUCONF_SUCCESS
condition|)
block|{
if|if
condition|(
name|iuuconf
operator|!=
name|UUCONF_NOT_FOUND
condition|)
name|ulog_uuconf
argument_list|(
name|LOG_FATAL
argument_list|,
name|puuconf
argument_list|,
name|iuuconf
argument_list|)
expr_stmt|;
name|iuuconf
operator|=
name|uuconf_system_local
argument_list|(
name|puuconf
argument_list|,
operator|&
name|slocalsys
argument_list|)
expr_stmt|;
if|if
condition|(
name|iuuconf
operator|!=
name|UUCONF_SUCCESS
condition|)
name|ulog_uuconf
argument_list|(
name|LOG_FATAL
argument_list|,
name|puuconf
argument_list|,
name|iuuconf
argument_list|)
expr_stmt|;
name|slocalsys
operator|.
name|uuconf_zname
operator|=
operator|(
name|char
operator|*
operator|)
name|zClocalname
expr_stmt|;
block|}
comment|/* If we are emulating uuto, translate the destination argument, and      notify the destination user.  This had better not turn into      something that requires the current directory, or we may have      passed INIT_GETCWD incorrectly.  */
if|if
condition|(
name|fuuto
condition|)
block|{
if|if
condition|(
operator|*
name|zCnotify
operator|==
literal|'\0'
condition|)
block|{
name|zexclam
operator|=
name|strrchr
argument_list|(
name|argv
index|[
name|argc
operator|-
literal|1
index|]
argument_list|,
literal|'!'
argument_list|)
expr_stmt|;
if|if
condition|(
name|zexclam
operator|==
name|NULL
condition|)
name|ucusage
argument_list|()
expr_stmt|;
name|zCnotify
operator|=
name|zexclam
operator|+
literal|1
expr_stmt|;
block|}
name|argv
index|[
name|argc
operator|-
literal|1
index|]
operator|=
name|zsysdep_uuto
argument_list|(
name|argv
index|[
name|argc
operator|-
literal|1
index|]
argument_list|,
name|zClocalname
argument_list|)
expr_stmt|;
if|if
condition|(
name|argv
index|[
name|argc
operator|-
literal|1
index|]
operator|==
name|NULL
condition|)
name|ucusage
argument_list|()
expr_stmt|;
block|}
comment|/* Set up the file transfer options.  */
name|zoptions
operator|=
name|abCsend_options
expr_stmt|;
if|if
condition|(
name|fCcopy
condition|)
operator|*
name|zoptions
operator|++
operator|=
literal|'C'
expr_stmt|;
else|else
operator|*
name|zoptions
operator|++
operator|=
literal|'c'
expr_stmt|;
if|if
condition|(
name|fCmkdirs
condition|)
operator|*
name|zoptions
operator|++
operator|=
literal|'d'
expr_stmt|;
else|else
operator|*
name|zoptions
operator|++
operator|=
literal|'f'
expr_stmt|;
if|if
condition|(
name|fCmail
condition|)
operator|*
name|zoptions
operator|++
operator|=
literal|'m'
expr_stmt|;
if|if
condition|(
operator|*
name|zCnotify
operator|!=
literal|'\0'
condition|)
operator|*
name|zoptions
operator|++
operator|=
literal|'n'
expr_stmt|;
operator|*
name|zoptions
operator|=
literal|'\0'
expr_stmt|;
name|zoptions
operator|=
name|abCrec_options
expr_stmt|;
if|if
condition|(
name|fCmkdirs
condition|)
operator|*
name|zoptions
operator|++
operator|=
literal|'d'
expr_stmt|;
else|else
operator|*
name|zoptions
operator|++
operator|=
literal|'f'
expr_stmt|;
if|if
condition|(
name|fCmail
condition|)
operator|*
name|zoptions
operator|++
operator|=
literal|'m'
expr_stmt|;
operator|*
name|zoptions
operator|=
literal|'\0'
expr_stmt|;
name|argv
index|[
name|argc
operator|-
literal|1
index|]
operator|=
name|zremove_local_sys
argument_list|(
operator|&
name|slocalsys
argument_list|,
name|argv
index|[
name|argc
operator|-
literal|1
index|]
argument_list|)
expr_stmt|;
name|zexclam
operator|=
name|strchr
argument_list|(
name|argv
index|[
name|argc
operator|-
literal|1
index|]
argument_list|,
literal|'!'
argument_list|)
expr_stmt|;
if|if
condition|(
name|zexclam
operator|==
name|NULL
condition|)
block|{
name|zdestsys
operator|=
name|zClocalname
expr_stmt|;
name|zdestfile
operator|=
name|argv
index|[
name|argc
operator|-
literal|1
index|]
expr_stmt|;
name|fClocaldest
operator|=
name|TRUE
expr_stmt|;
block|}
else|else
block|{
name|size_t
name|clen
decl_stmt|;
name|char
modifier|*
name|zcopy
decl_stmt|;
name|clen
operator|=
name|zexclam
operator|-
name|argv
index|[
name|argc
operator|-
literal|1
index|]
expr_stmt|;
name|zcopy
operator|=
name|zbufalc
argument_list|(
name|clen
operator|+
literal|1
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
name|zcopy
argument_list|,
name|argv
index|[
name|argc
operator|-
literal|1
index|]
argument_list|,
name|clen
argument_list|)
expr_stmt|;
name|zcopy
index|[
name|clen
index|]
operator|=
literal|'\0'
expr_stmt|;
name|zdestsys
operator|=
name|zcopy
expr_stmt|;
name|zdestfile
operator|=
name|zexclam
operator|+
literal|1
expr_stmt|;
name|fClocaldest
operator|=
name|FALSE
expr_stmt|;
block|}
name|iuuconf
operator|=
name|uuconf_system_info
argument_list|(
name|puuconf
argument_list|,
name|zdestsys
argument_list|,
operator|&
name|sCdestsys
argument_list|)
expr_stmt|;
if|if
condition|(
name|iuuconf
operator|!=
name|UUCONF_SUCCESS
condition|)
block|{
if|if
condition|(
name|iuuconf
operator|!=
name|UUCONF_NOT_FOUND
condition|)
name|ulog_uuconf
argument_list|(
name|LOG_FATAL
argument_list|,
name|puuconf
argument_list|,
name|iuuconf
argument_list|)
expr_stmt|;
if|if
condition|(
name|fClocaldest
condition|)
block|{
name|iuuconf
operator|=
name|uuconf_system_local
argument_list|(
name|puuconf
argument_list|,
operator|&
name|sCdestsys
argument_list|)
expr_stmt|;
if|if
condition|(
name|iuuconf
operator|!=
name|UUCONF_SUCCESS
condition|)
name|ulog_uuconf
argument_list|(
name|LOG_FATAL
argument_list|,
name|puuconf
argument_list|,
name|iuuconf
argument_list|)
expr_stmt|;
name|sCdestsys
operator|.
name|uuconf_zname
operator|=
operator|(
name|char
operator|*
operator|)
name|zClocalname
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
operator|!
name|funknown_system
argument_list|(
name|puuconf
argument_list|,
name|zdestsys
argument_list|,
operator|&
name|sCdestsys
argument_list|)
condition|)
name|ulog
argument_list|(
name|LOG_FATAL
argument_list|,
literal|"%s: System not found"
argument_list|,
name|zdestsys
argument_list|)
expr_stmt|;
block|}
block|}
comment|/* Here zdestfile is the destination file name following the      destination system name (if any); it may contain other systems to      forward the files through.  Isolate the file from the list of      systems.  */
name|zexclam
operator|=
name|strrchr
argument_list|(
name|zdestfile
argument_list|,
literal|'!'
argument_list|)
expr_stmt|;
if|if
condition|(
name|zexclam
operator|==
name|NULL
condition|)
name|zCforward
operator|=
name|NULL
expr_stmt|;
else|else
block|{
name|size_t
name|clen
decl_stmt|;
if|#
directive|if
name|DEBUG
operator|>
literal|0
if|if
condition|(
name|fClocaldest
condition|)
name|ulog
argument_list|(
name|LOG_FATAL
argument_list|,
literal|"Can't happen"
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|clen
operator|=
name|zexclam
operator|-
name|zdestfile
expr_stmt|;
name|zCforward
operator|=
name|zbufalc
argument_list|(
name|clen
operator|+
literal|1
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
name|zCforward
argument_list|,
name|zdestfile
argument_list|,
name|clen
argument_list|)
expr_stmt|;
name|zCforward
index|[
name|clen
index|]
operator|=
literal|'\0'
expr_stmt|;
name|zdestfile
operator|=
name|zexclam
operator|+
literal|1
expr_stmt|;
block|}
comment|/* Turn the destination into an absolute path, unless it is on a      remote system and -W was used.  */
if|if
condition|(
name|fClocaldest
condition|)
name|zdestfile
operator|=
name|zsysdep_local_file_cwd
argument_list|(
name|zdestfile
argument_list|,
name|sCdestsys
operator|.
name|uuconf_zpubdir
argument_list|,
operator|(
name|boolean
operator|*
operator|)
name|NULL
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|fCexpand
condition|)
name|zdestfile
operator|=
name|zsysdep_add_cwd
argument_list|(
name|zdestfile
argument_list|)
expr_stmt|;
if|if
condition|(
name|zdestfile
operator|==
name|NULL
condition|)
block|{
name|ulog_close
argument_list|()
expr_stmt|;
name|usysdep_exit
argument_list|(
name|FALSE
argument_list|)
expr_stmt|;
block|}
comment|/* Process each source argument.  */
for|for
control|(
name|i
operator|=
name|optind
init|;
name|i
operator|<
name|argc
operator|-
literal|1
operator|&&
operator|!
name|FGOT_SIGNAL
argument_list|()
condition|;
name|i
operator|++
control|)
block|{
name|boolean
name|flocal
decl_stmt|;
name|char
modifier|*
name|zfrom
decl_stmt|;
name|fCneeds_cwd
operator|=
name|FALSE
expr_stmt|;
name|argv
index|[
name|i
index|]
operator|=
name|zremove_local_sys
argument_list|(
operator|&
name|slocalsys
argument_list|,
name|argv
index|[
name|i
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|strchr
argument_list|(
name|argv
index|[
name|i
index|]
argument_list|,
literal|'!'
argument_list|)
operator|!=
name|NULL
condition|)
block|{
name|flocal
operator|=
name|FALSE
expr_stmt|;
name|zfrom
operator|=
name|zbufcpy
argument_list|(
name|argv
index|[
name|i
index|]
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|/* This is a local file.  Make sure we get it out of the 	     original directory.  We don't support local wildcards, 	     leaving that to the shell.  */
name|flocal
operator|=
name|TRUE
expr_stmt|;
if|if
condition|(
name|fsysdep_needs_cwd
argument_list|(
name|argv
index|[
name|i
index|]
argument_list|)
condition|)
name|fCneeds_cwd
operator|=
name|TRUE
expr_stmt|;
name|zfrom
operator|=
name|zsysdep_local_file_cwd
argument_list|(
name|argv
index|[
name|i
index|]
argument_list|,
name|sCdestsys
operator|.
name|uuconf_zpubdir
argument_list|,
operator|(
name|boolean
operator|*
operator|)
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|zfrom
operator|==
name|NULL
condition|)
name|ucabort
argument_list|()
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|flocal
operator|||
operator|!
name|fsysdep_directory
argument_list|(
name|zfrom
argument_list|)
condition|)
name|uccopy
argument_list|(
name|zfrom
argument_list|,
name|zdestfile
argument_list|)
expr_stmt|;
else|else
block|{
name|char
modifier|*
name|zbase
decl_stmt|,
modifier|*
name|zindir
decl_stmt|;
if|if
condition|(
operator|!
name|frecursive
condition|)
name|ulog
argument_list|(
name|LOG_FATAL
argument_list|,
literal|"%s: directory without -R"
argument_list|,
name|zfrom
argument_list|)
expr_stmt|;
name|zbase
operator|=
name|zsysdep_base_name
argument_list|(
name|zfrom
argument_list|)
expr_stmt|;
if|if
condition|(
name|zbase
operator|==
name|NULL
condition|)
name|ucabort
argument_list|()
expr_stmt|;
name|zindir
operator|=
name|zsysdep_in_dir
argument_list|(
name|zdestfile
argument_list|,
name|zbase
argument_list|)
expr_stmt|;
name|ubuffree
argument_list|(
name|zbase
argument_list|)
expr_stmt|;
if|if
condition|(
name|zindir
operator|==
name|NULL
condition|)
name|ucabort
argument_list|()
expr_stmt|;
name|usysdep_walk_tree
argument_list|(
name|zfrom
argument_list|,
name|ucdirfile
argument_list|,
name|zindir
argument_list|)
expr_stmt|;
name|ubuffree
argument_list|(
name|zindir
argument_list|)
expr_stmt|;
block|}
name|ubuffree
argument_list|(
name|zfrom
argument_list|)
expr_stmt|;
block|}
comment|/* See if we got an interrupt, presumably from the user.  */
if|if
condition|(
name|FGOT_SIGNAL
argument_list|()
condition|)
name|ucabort
argument_list|()
expr_stmt|;
comment|/* Now push out the actual commands, making log entries for them.  */
name|ulog_to_file
argument_list|(
name|puuconf
argument_list|,
name|TRUE
argument_list|)
expr_stmt|;
name|ulog_user
argument_list|(
name|zCuser
argument_list|)
expr_stmt|;
name|ucspool_cmds
argument_list|(
name|fjobid
argument_list|)
expr_stmt|;
name|ulog_close
argument_list|()
expr_stmt|;
if|if
condition|(
operator|!
name|fuucico
condition|)
name|fexit
operator|=
name|TRUE
expr_stmt|;
else|else
block|{
specifier|const
name|char
modifier|*
name|zsys
decl_stmt|;
name|boolean
name|fany
decl_stmt|;
name|zsys
operator|=
name|zcone_system
argument_list|(
operator|&
name|fany
argument_list|)
expr_stmt|;
if|if
condition|(
name|zsys
operator|==
name|NULL
operator|&&
operator|!
name|fany
condition|)
name|fexit
operator|=
name|TRUE
expr_stmt|;
else|else
block|{
specifier|const
name|char
modifier|*
name|zarg
decl_stmt|;
name|char
modifier|*
name|zconfigarg
decl_stmt|;
if|if
condition|(
name|zsys
operator|==
name|NULL
condition|)
name|zarg
operator|=
literal|"-r1"
expr_stmt|;
else|else
block|{
name|char
modifier|*
name|z
decl_stmt|;
name|z
operator|=
name|zbufalc
argument_list|(
sizeof|sizeof
expr|"-Cs"
operator|+
name|strlen
argument_list|(
name|zsys
argument_list|)
argument_list|)
expr_stmt|;
name|sprintf
argument_list|(
name|z
argument_list|,
literal|"-Cs%s"
argument_list|,
name|zsys
argument_list|)
expr_stmt|;
name|zarg
operator|=
name|z
expr_stmt|;
block|}
if|if
condition|(
name|zconfig
operator|==
name|NULL
condition|)
name|zconfigarg
operator|=
name|NULL
expr_stmt|;
else|else
block|{
name|zconfigarg
operator|=
name|zbufalc
argument_list|(
sizeof|sizeof
expr|"-I"
operator|+
name|strlen
argument_list|(
name|zconfig
argument_list|)
argument_list|)
expr_stmt|;
name|sprintf
argument_list|(
name|zconfigarg
argument_list|,
literal|"-I%s"
argument_list|,
name|zconfig
argument_list|)
expr_stmt|;
block|}
name|fexit
operator|=
name|fsysdep_run
argument_list|(
name|FALSE
argument_list|,
literal|"uucico"
argument_list|,
name|zarg
argument_list|,
name|zconfigarg
argument_list|)
expr_stmt|;
block|}
block|}
name|usysdep_exit
argument_list|(
name|fexit
argument_list|)
expr_stmt|;
comment|/* Avoid error about not returning.  */
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/* Print usage message and die.  */
end_comment

begin_function
specifier|static
name|void
name|ucusage
parameter_list|()
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Usage: %s [options] file1 [file2 ...] dest\n"
argument_list|,
name|zProgram
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Use %s --help for help\n"
argument_list|,
name|zProgram
argument_list|)
expr_stmt|;
name|exit
argument_list|(
name|EXIT_FAILURE
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* Print help message.  */
end_comment

begin_function
specifier|static
name|void
name|uchelp
parameter_list|()
block|{
name|printf
argument_list|(
literal|"Taylor UUCP %s, copyright (C) 1991, 92, 93, 94, 1995 Ian Lance Taylor\n"
argument_list|,
name|VERSION
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Usage: %s [options] file1 [file2 ...] dest\n"
argument_list|,
name|zProgram
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|" -c,--nocopy: Do not copy local files to spool directory\n"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|" -C,-p,--copy: Copy local files to spool directory (default)\n"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|" -d,--directories: Create necessary directories (default)\n"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|" -f,--nodirectories: Do not create directories (fail if they do not exist)\n"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|" -g,--grade grade: Set job grade (must be alphabetic)\n"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|" -m,--mail: Report status of copy by mail\n"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|" -n,--notify user: Report status of copy by mail to remote user\n"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|" -R,--recursive: Copy directories recursively\n"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|" -r,--nouucico: Do not start uucico daemon\n"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|" -s,--status file: Report completion status to file\n"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|" -j,--jobid: Report job id\n"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|" -W,--noexpand: Do not add current directory to remote filenames\n"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|" -t,--uuto: Emulate uuto\n"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|" -u,--usage name: Set user name\n"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|" -x,--debug debug: Set debugging level\n"
argument_list|)
expr_stmt|;
if|#
directive|if
name|HAVE_TAYLOR_CONFIG
name|printf
argument_list|(
literal|" -I,--config file: Set configuration file to use\n"
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* HAVE_TAYLOR_CONFIG */
name|printf
argument_list|(
literal|" -v,--version: Print version and exit\n"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|" --help: Print help and exit\n"
argument_list|)
expr_stmt|;
block|}
end_function

begin_escape
end_escape

begin_comment
comment|/* This is called for each file in a directory heirarchy.  */
end_comment

begin_function
specifier|static
name|void
name|ucdirfile
parameter_list|(
name|zfull
parameter_list|,
name|zrelative
parameter_list|,
name|pinfo
parameter_list|)
specifier|const
name|char
modifier|*
name|zfull
decl_stmt|;
specifier|const
name|char
modifier|*
name|zrelative
decl_stmt|;
name|pointer
name|pinfo
decl_stmt|;
block|{
specifier|const
name|char
modifier|*
name|zdestfile
init|=
operator|(
specifier|const
name|char
operator|*
operator|)
name|pinfo
decl_stmt|;
name|char
modifier|*
name|zto
decl_stmt|;
name|zto
operator|=
name|zsysdep_in_dir
argument_list|(
name|zdestfile
argument_list|,
name|zrelative
argument_list|)
expr_stmt|;
if|if
condition|(
name|zto
operator|==
name|NULL
condition|)
name|ucabort
argument_list|()
expr_stmt|;
name|uccopy
argument_list|(
name|zfull
argument_list|,
name|zto
argument_list|)
expr_stmt|;
name|ubuffree
argument_list|(
name|zto
argument_list|)
expr_stmt|;
block|}
end_function

begin_escape
end_escape

begin_comment
comment|/* Handle the copying of one regular file.  The zdest argument is the    destination file; if we are recursively copying a directory, it    will be extended by any subdirectory names.  Note that zdest is an    absolute path.  */
end_comment

begin_function
specifier|static
name|void
name|uccopy
parameter_list|(
name|zfile
parameter_list|,
name|zdest
parameter_list|)
specifier|const
name|char
modifier|*
name|zfile
decl_stmt|;
specifier|const
name|char
modifier|*
name|zdest
decl_stmt|;
block|{
name|struct
name|scmd
name|s
decl_stmt|;
name|char
modifier|*
name|zexclam
decl_stmt|;
name|char
modifier|*
name|zto
decl_stmt|;
name|zexclam
operator|=
name|strchr
argument_list|(
name|zfile
argument_list|,
literal|'!'
argument_list|)
expr_stmt|;
if|if
condition|(
name|zexclam
operator|==
name|NULL
condition|)
block|{
name|openfile_t
name|efrom
decl_stmt|;
comment|/* Copy from a local file.  Make sure the user has access to 	 this file, since we are running setuid.  */
if|if
condition|(
operator|!
name|fsysdep_access
argument_list|(
name|zfile
argument_list|)
condition|)
name|ucabort
argument_list|()
expr_stmt|;
comment|/* If this copy is being requested by a remote system, we may 	 transfer the file if it needs the current working directory 	 (meaning, I hope, that it is in the execution directory) or 	 it is on the permitted transfer list.  Note that unlike most 	 of the other checks, this one is not double-checked by 	 uucico.  */
if|if
condition|(
name|fCremote
operator|&&
operator|!
name|fCneeds_cwd
operator|&&
operator|!
name|fin_directory_list
argument_list|(
name|zfile
argument_list|,
name|sCdestsys
operator|.
name|uuconf_pzremote_send
argument_list|,
name|sCdestsys
operator|.
name|uuconf_zpubdir
argument_list|,
name|TRUE
argument_list|,
name|TRUE
argument_list|,
operator|(
specifier|const
name|char
operator|*
operator|)
name|NULL
argument_list|)
condition|)
name|ulog
argument_list|(
name|LOG_FATAL
argument_list|,
literal|"Not permitted to send %s"
argument_list|,
name|zfile
argument_list|)
expr_stmt|;
if|if
condition|(
name|fClocaldest
condition|)
block|{
name|boolean
name|fok
decl_stmt|;
comment|/* Copy one local file to another.  */
comment|/* Check that we have permission to receive into the desired 	     directory.  */
if|if
condition|(
name|fCremote
condition|)
name|fok
operator|=
name|fin_directory_list
argument_list|(
name|zdest
argument_list|,
name|sCdestsys
operator|.
name|uuconf_pzremote_receive
argument_list|,
name|sCdestsys
operator|.
name|uuconf_zpubdir
argument_list|,
name|TRUE
argument_list|,
name|FALSE
argument_list|,
operator|(
specifier|const
name|char
operator|*
operator|)
name|NULL
argument_list|)
expr_stmt|;
else|else
name|fok
operator|=
name|fin_directory_list
argument_list|(
name|zdest
argument_list|,
name|sCdestsys
operator|.
name|uuconf_pzlocal_receive
argument_list|,
name|sCdestsys
operator|.
name|uuconf_zpubdir
argument_list|,
name|TRUE
argument_list|,
name|FALSE
argument_list|,
name|zCuser
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|fok
condition|)
name|ulog
argument_list|(
name|LOG_FATAL
argument_list|,
literal|"Not permitted to receive to %s"
argument_list|,
name|zdest
argument_list|)
expr_stmt|;
name|zto
operator|=
name|zsysdep_add_base
argument_list|(
name|zdest
argument_list|,
name|zfile
argument_list|)
expr_stmt|;
if|if
condition|(
name|zto
operator|==
name|NULL
condition|)
name|ucabort
argument_list|()
expr_stmt|;
name|efrom
operator|=
name|esysdep_user_fopen
argument_list|(
name|zfile
argument_list|,
name|TRUE
argument_list|,
name|TRUE
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|ffileisopen
argument_list|(
name|efrom
argument_list|)
condition|)
name|ucabort
argument_list|()
expr_stmt|;
if|if
condition|(
operator|!
name|fcopy_open_file
argument_list|(
name|efrom
argument_list|,
name|zto
argument_list|,
name|FALSE
argument_list|,
name|fCmkdirs
argument_list|,
name|TRUE
argument_list|)
condition|)
name|ucabort
argument_list|()
expr_stmt|;
operator|(
name|void
operator|)
name|ffileclose
argument_list|(
name|efrom
argument_list|)
expr_stmt|;
name|ubuffree
argument_list|(
name|zto
argument_list|)
expr_stmt|;
block|}
else|else
block|{
specifier|const
name|char
modifier|*
name|zloc
decl_stmt|;
name|char
name|abtname
index|[
name|CFILE_NAME_LEN
index|]
decl_stmt|;
name|unsigned
name|int
name|imode
decl_stmt|;
name|char
modifier|*
name|ztemp
decl_stmt|;
comment|/* Copy a local file to a remote file.  We may have to 	     copy the local file to the spool directory.  */
name|imode
operator|=
name|ixsysdep_file_mode
argument_list|(
name|zfile
argument_list|)
expr_stmt|;
if|if
condition|(
name|imode
operator|==
literal|0
condition|)
name|ucabort
argument_list|()
expr_stmt|;
name|zloc
operator|=
name|sCdestsys
operator|.
name|uuconf_zlocalname
expr_stmt|;
if|if
condition|(
name|zloc
operator|==
name|NULL
condition|)
name|zloc
operator|=
name|zClocalname
expr_stmt|;
name|ztemp
operator|=
name|zsysdep_data_file_name
argument_list|(
operator|&
name|sCdestsys
argument_list|,
name|zloc
argument_list|,
name|bCgrade
argument_list|,
name|FALSE
argument_list|,
name|abtname
argument_list|,
operator|(
name|char
operator|*
operator|)
name|NULL
argument_list|,
operator|(
name|char
operator|*
operator|)
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|ztemp
operator|==
name|NULL
condition|)
name|ucabort
argument_list|()
expr_stmt|;
if|if
condition|(
operator|!
name|fCcopy
condition|)
block|{
comment|/* If we are copying the file, we don't actually use the 		 temporary file; we still want to get a name for the 		 other system to use as a key for file restart.  */
name|ubuffree
argument_list|(
name|ztemp
argument_list|)
expr_stmt|;
comment|/* Make sure the daemon will be permitted to send 		 this file.  */
if|if
condition|(
operator|!
name|fsysdep_daemon_access
argument_list|(
name|zfile
argument_list|)
condition|)
name|ucabort
argument_list|()
expr_stmt|;
if|if
condition|(
operator|!
name|fin_directory_list
argument_list|(
name|zfile
argument_list|,
name|sCdestsys
operator|.
name|uuconf_pzlocal_send
argument_list|,
name|sCdestsys
operator|.
name|uuconf_zpubdir
argument_list|,
name|TRUE
argument_list|,
name|TRUE
argument_list|,
operator|(
name|fCremote
condition|?
operator|(
specifier|const
name|char
operator|*
operator|)
name|NULL
else|:
name|zCuser
operator|)
argument_list|)
condition|)
name|ulog
argument_list|(
name|LOG_FATAL
argument_list|,
literal|"Daemon not permitted to send %s (suggest --copy)"
argument_list|,
name|zfile
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|efrom
operator|=
name|esysdep_user_fopen
argument_list|(
name|zfile
argument_list|,
name|TRUE
argument_list|,
name|TRUE
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|ffileisopen
argument_list|(
name|efrom
argument_list|)
condition|)
name|ucabort
argument_list|()
expr_stmt|;
name|ucrecord_file
argument_list|(
name|ztemp
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|fcopy_open_file
argument_list|(
name|efrom
argument_list|,
name|ztemp
argument_list|,
name|FALSE
argument_list|,
name|TRUE
argument_list|,
name|TRUE
argument_list|)
condition|)
name|ucabort
argument_list|()
expr_stmt|;
operator|(
name|void
operator|)
name|ffileclose
argument_list|(
name|efrom
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|zCforward
operator|==
name|NULL
condition|)
block|{
comment|/* We're not forwarding.  Just send the file.  */
name|s
operator|.
name|bcmd
operator|=
literal|'S'
expr_stmt|;
name|s
operator|.
name|bgrade
operator|=
name|bCgrade
expr_stmt|;
name|s
operator|.
name|pseq
operator|=
name|NULL
expr_stmt|;
name|s
operator|.
name|zfrom
operator|=
name|zbufcpy
argument_list|(
name|zfile
argument_list|)
expr_stmt|;
name|s
operator|.
name|zto
operator|=
name|zbufcpy
argument_list|(
name|zdest
argument_list|)
expr_stmt|;
name|s
operator|.
name|zuser
operator|=
name|zCuser
expr_stmt|;
name|s
operator|.
name|zoptions
operator|=
name|abCsend_options
expr_stmt|;
name|s
operator|.
name|ztemp
operator|=
name|zbufcpy
argument_list|(
name|abtname
argument_list|)
expr_stmt|;
name|s
operator|.
name|imode
operator|=
name|imode
expr_stmt|;
name|s
operator|.
name|znotify
operator|=
name|zCnotify
expr_stmt|;
name|s
operator|.
name|cbytes
operator|=
operator|-
literal|1
expr_stmt|;
name|s
operator|.
name|zcmd
operator|=
name|NULL
expr_stmt|;
name|s
operator|.
name|ipos
operator|=
literal|0
expr_stmt|;
name|ucadd_cmd
argument_list|(
operator|&
name|sCdestsys
argument_list|,
operator|&
name|s
argument_list|,
operator|(
specifier|const
name|char
operator|*
operator|)
name|NULL
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|char
modifier|*
name|zbase
decl_stmt|;
name|char
modifier|*
name|zxqt
decl_stmt|;
name|char
name|abxtname
index|[
name|CFILE_NAME_LEN
index|]
decl_stmt|;
name|char
name|abdname
index|[
name|CFILE_NAME_LEN
index|]
decl_stmt|;
name|char
name|abxname
index|[
name|CFILE_NAME_LEN
index|]
decl_stmt|;
name|FILE
modifier|*
name|e
decl_stmt|;
name|char
modifier|*
name|zlog
decl_stmt|;
comment|/* We want to forward this file through sCdestsys to 		 some other system(s).  We set up a remote execution 		 of uucp on sCdestsys to forward the file along.  */
name|zbase
operator|=
name|zsysdep_base_name
argument_list|(
name|zfile
argument_list|)
expr_stmt|;
if|if
condition|(
name|zbase
operator|==
name|NULL
condition|)
name|ucabort
argument_list|()
expr_stmt|;
name|zxqt
operator|=
name|zsysdep_data_file_name
argument_list|(
operator|&
name|sCdestsys
argument_list|,
name|zloc
argument_list|,
name|bCgrade
argument_list|,
name|TRUE
argument_list|,
name|abxtname
argument_list|,
name|abdname
argument_list|,
name|abxname
argument_list|)
expr_stmt|;
if|if
condition|(
name|zxqt
operator|==
name|NULL
condition|)
name|ucabort
argument_list|()
expr_stmt|;
name|e
operator|=
name|esysdep_fopen
argument_list|(
name|zxqt
argument_list|,
name|FALSE
argument_list|,
name|FALSE
argument_list|,
name|TRUE
argument_list|)
expr_stmt|;
if|if
condition|(
name|e
operator|==
name|NULL
condition|)
name|ucabort
argument_list|()
expr_stmt|;
name|ucrecord_file
argument_list|(
name|zxqt
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|e
argument_list|,
literal|"U %s %s\n"
argument_list|,
name|zCuser
argument_list|,
name|zloc
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|e
argument_list|,
literal|"F %s %s\n"
argument_list|,
name|abdname
argument_list|,
name|zbase
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|e
argument_list|,
literal|"C uucp -C"
argument_list|)
expr_stmt|;
if|if
condition|(
name|fCmkdirs
condition|)
name|fprintf
argument_list|(
name|e
argument_list|,
literal|" -d"
argument_list|)
expr_stmt|;
else|else
name|fprintf
argument_list|(
name|e
argument_list|,
literal|" -f"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|e
argument_list|,
literal|" -g %c"
argument_list|,
name|bCgrade
argument_list|)
expr_stmt|;
if|if
condition|(
name|fCmail
condition|)
name|fprintf
argument_list|(
name|e
argument_list|,
literal|" -m"
argument_list|)
expr_stmt|;
if|if
condition|(
operator|*
name|zCnotify
operator|!=
literal|'\0'
condition|)
name|fprintf
argument_list|(
name|e
argument_list|,
literal|" -n %s"
argument_list|,
name|zCnotify
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|fCexpand
condition|)
name|fprintf
argument_list|(
name|e
argument_list|,
literal|" -W"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|e
argument_list|,
literal|" %s %s!%s\n"
argument_list|,
name|zbase
argument_list|,
name|zCforward
argument_list|,
name|zdest
argument_list|)
expr_stmt|;
name|ubuffree
argument_list|(
name|zbase
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|fstdiosync
argument_list|(
name|e
argument_list|,
name|zxqt
argument_list|)
condition|)
name|ulog
argument_list|(
name|LOG_FATAL
argument_list|,
literal|"fsync failed"
argument_list|)
expr_stmt|;
if|if
condition|(
name|fclose
argument_list|(
name|e
argument_list|)
operator|!=
literal|0
condition|)
name|ulog
argument_list|(
name|LOG_FATAL
argument_list|,
literal|"fclose: %s"
argument_list|,
name|strerror
argument_list|(
name|errno
argument_list|)
argument_list|)
expr_stmt|;
comment|/* Send the execution file.  */
name|s
operator|.
name|bcmd
operator|=
literal|'S'
expr_stmt|;
name|s
operator|.
name|bgrade
operator|=
name|bCgrade
expr_stmt|;
name|s
operator|.
name|pseq
operator|=
name|NULL
expr_stmt|;
name|s
operator|.
name|zfrom
operator|=
name|zbufcpy
argument_list|(
name|abxtname
argument_list|)
expr_stmt|;
name|s
operator|.
name|zto
operator|=
name|zbufcpy
argument_list|(
name|abxname
argument_list|)
expr_stmt|;
name|s
operator|.
name|zuser
operator|=
name|zCuser
expr_stmt|;
name|s
operator|.
name|zoptions
operator|=
literal|"C"
expr_stmt|;
name|s
operator|.
name|ztemp
operator|=
name|s
operator|.
name|zfrom
expr_stmt|;
name|s
operator|.
name|imode
operator|=
literal|0666
expr_stmt|;
name|s
operator|.
name|znotify
operator|=
name|NULL
expr_stmt|;
name|s
operator|.
name|cbytes
operator|=
operator|-
literal|1
expr_stmt|;
name|s
operator|.
name|zcmd
operator|=
name|NULL
expr_stmt|;
name|s
operator|.
name|ipos
operator|=
literal|0
expr_stmt|;
name|zlog
operator|=
name|zbufalc
argument_list|(
sizeof|sizeof
expr|"Queuing uucp  !"
operator|+
name|strlen
argument_list|(
name|zfile
argument_list|)
operator|+
name|strlen
argument_list|(
name|zCforward
argument_list|)
operator|+
name|strlen
argument_list|(
name|zdest
argument_list|)
argument_list|)
expr_stmt|;
name|sprintf
argument_list|(
name|zlog
argument_list|,
literal|"Queuing uucp %s %s!%s"
argument_list|,
name|zfile
argument_list|,
name|zCforward
argument_list|,
name|zdest
argument_list|)
expr_stmt|;
name|ucadd_cmd
argument_list|(
operator|&
name|sCdestsys
argument_list|,
operator|&
name|s
argument_list|,
name|zlog
argument_list|)
expr_stmt|;
comment|/* Send the data file.  */
name|s
operator|.
name|bcmd
operator|=
literal|'S'
expr_stmt|;
name|s
operator|.
name|bgrade
operator|=
name|bCgrade
expr_stmt|;
name|s
operator|.
name|pseq
operator|=
name|NULL
expr_stmt|;
name|s
operator|.
name|zfrom
operator|=
name|zbufcpy
argument_list|(
name|zfile
argument_list|)
expr_stmt|;
name|s
operator|.
name|zto
operator|=
name|zbufcpy
argument_list|(
name|abdname
argument_list|)
expr_stmt|;
name|s
operator|.
name|zuser
operator|=
name|zCuser
expr_stmt|;
name|s
operator|.
name|zoptions
operator|=
name|fCcopy
condition|?
literal|"C"
else|:
literal|"c"
expr_stmt|;
name|s
operator|.
name|ztemp
operator|=
name|zbufcpy
argument_list|(
name|abtname
argument_list|)
expr_stmt|;
name|s
operator|.
name|imode
operator|=
literal|0666
expr_stmt|;
name|s
operator|.
name|znotify
operator|=
name|NULL
expr_stmt|;
name|s
operator|.
name|cbytes
operator|=
operator|-
literal|1
expr_stmt|;
name|s
operator|.
name|zcmd
operator|=
name|NULL
expr_stmt|;
name|s
operator|.
name|ipos
operator|=
literal|0
expr_stmt|;
name|ucadd_cmd
argument_list|(
operator|&
name|sCdestsys
argument_list|,
operator|&
name|s
argument_list|,
literal|""
argument_list|)
expr_stmt|;
block|}
block|}
block|}
else|else
block|{
name|char
modifier|*
name|zfrom
decl_stmt|;
name|char
modifier|*
name|zforward
decl_stmt|;
name|size_t
name|clen
decl_stmt|;
name|char
modifier|*
name|zcopy
decl_stmt|;
name|struct
name|uuconf_system
modifier|*
name|qfromsys
decl_stmt|;
name|int
name|iuuconf
decl_stmt|;
specifier|const
name|char
modifier|*
name|zloc
decl_stmt|;
comment|/* Copy from a remote file.  Get the file name after any systems 	 we may need to forward the file from.  */
name|zfrom
operator|=
name|strrchr
argument_list|(
name|zfile
argument_list|,
literal|'!'
argument_list|)
expr_stmt|;
if|if
condition|(
name|zfrom
operator|==
name|zexclam
condition|)
name|zforward
operator|=
name|NULL
expr_stmt|;
else|else
block|{
name|clen
operator|=
name|zfrom
operator|-
name|zexclam
operator|-
literal|1
expr_stmt|;
name|zforward
operator|=
name|zbufalc
argument_list|(
name|clen
operator|+
literal|1
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
name|zforward
argument_list|,
name|zexclam
operator|+
literal|1
argument_list|,
name|clen
argument_list|)
expr_stmt|;
name|zforward
index|[
name|clen
index|]
operator|=
literal|'\0'
expr_stmt|;
block|}
operator|++
name|zfrom
expr_stmt|;
if|if
condition|(
name|fCexpand
condition|)
block|{
comment|/* Add the current directory to the filename if it's not 	     already there.  */
name|zfrom
operator|=
name|zsysdep_add_cwd
argument_list|(
name|zfrom
argument_list|)
expr_stmt|;
if|if
condition|(
name|zfrom
operator|==
name|NULL
condition|)
name|ucabort
argument_list|()
expr_stmt|;
block|}
comment|/* Read the system information.  */
name|clen
operator|=
name|zexclam
operator|-
name|zfile
expr_stmt|;
name|zcopy
operator|=
name|zbufalc
argument_list|(
name|clen
operator|+
literal|1
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
name|zcopy
argument_list|,
name|zfile
argument_list|,
name|clen
argument_list|)
expr_stmt|;
name|zcopy
index|[
name|clen
index|]
operator|=
literal|'\0'
expr_stmt|;
name|qfromsys
operator|=
operator|(
operator|(
expr|struct
name|uuconf_system
operator|*
operator|)
name|xmalloc
argument_list|(
sizeof|sizeof
argument_list|(
expr|struct
name|uuconf_system
argument_list|)
argument_list|)
operator|)
expr_stmt|;
name|iuuconf
operator|=
name|uuconf_system_info
argument_list|(
name|pCuuconf
argument_list|,
name|zcopy
argument_list|,
name|qfromsys
argument_list|)
expr_stmt|;
if|if
condition|(
name|iuuconf
operator|==
name|UUCONF_NOT_FOUND
condition|)
block|{
if|if
condition|(
operator|!
name|funknown_system
argument_list|(
name|pCuuconf
argument_list|,
name|zcopy
argument_list|,
name|qfromsys
argument_list|)
condition|)
name|ulog
argument_list|(
name|LOG_FATAL
argument_list|,
literal|"%s: System not found"
argument_list|,
name|zcopy
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|iuuconf
operator|!=
name|UUCONF_SUCCESS
condition|)
name|ulog_uuconf
argument_list|(
name|LOG_FATAL
argument_list|,
name|pCuuconf
argument_list|,
name|iuuconf
argument_list|)
expr_stmt|;
name|ubuffree
argument_list|(
name|zcopy
argument_list|)
expr_stmt|;
name|zloc
operator|=
name|qfromsys
operator|->
name|uuconf_zlocalname
expr_stmt|;
if|if
condition|(
name|zloc
operator|==
name|NULL
condition|)
name|zloc
operator|=
name|zClocalname
expr_stmt|;
if|if
condition|(
name|zforward
operator|==
name|NULL
operator|&&
name|fClocaldest
condition|)
block|{
name|boolean
name|fok
decl_stmt|;
comment|/* The file is to come directly from qfromsys to the local 	     system.  */
comment|/* Check that we have permission to receive into the desired 	     directory.  If we don't have permission, uucico will 	     fail.  */
if|if
condition|(
name|fCremote
condition|)
name|fok
operator|=
name|fin_directory_list
argument_list|(
name|zdest
argument_list|,
name|qfromsys
operator|->
name|uuconf_pzremote_receive
argument_list|,
name|qfromsys
operator|->
name|uuconf_zpubdir
argument_list|,
name|TRUE
argument_list|,
name|FALSE
argument_list|,
operator|(
specifier|const
name|char
operator|*
operator|)
name|NULL
argument_list|)
expr_stmt|;
else|else
name|fok
operator|=
name|fin_directory_list
argument_list|(
name|zdest
argument_list|,
name|qfromsys
operator|->
name|uuconf_pzlocal_receive
argument_list|,
name|qfromsys
operator|->
name|uuconf_zpubdir
argument_list|,
name|TRUE
argument_list|,
name|FALSE
argument_list|,
name|zCuser
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|fok
condition|)
name|ulog
argument_list|(
name|LOG_FATAL
argument_list|,
literal|"Not permitted to receive to %s"
argument_list|,
name|zdest
argument_list|)
expr_stmt|;
comment|/* If the remote filespec is wildcarded, we must generate an 	     'X' request.  We currently check for Unix shell 	     wildcards.  Note that it should do no harm to mistake a 	     non-wildcard for a wildcard.  */
if|if
condition|(
name|zfrom
index|[
name|strcspn
argument_list|(
name|zfrom
argument_list|,
literal|"*?["
argument_list|)
index|]
operator|!=
literal|'\0'
condition|)
block|{
name|s
operator|.
name|bcmd
operator|=
literal|'X'
expr_stmt|;
name|zto
operator|=
name|zbufalc
argument_list|(
name|strlen
argument_list|(
name|zloc
argument_list|)
operator|+
name|strlen
argument_list|(
name|zdest
argument_list|)
operator|+
sizeof|sizeof
expr|"!"
argument_list|)
expr_stmt|;
name|sprintf
argument_list|(
name|zto
argument_list|,
literal|"%s!%s"
argument_list|,
name|zloc
argument_list|,
name|zdest
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|s
operator|.
name|bcmd
operator|=
literal|'R'
expr_stmt|;
name|zto
operator|=
name|zbufcpy
argument_list|(
name|zdest
argument_list|)
expr_stmt|;
block|}
name|s
operator|.
name|bgrade
operator|=
name|bCgrade
expr_stmt|;
name|s
operator|.
name|pseq
operator|=
name|NULL
expr_stmt|;
name|s
operator|.
name|zfrom
operator|=
name|zfrom
expr_stmt|;
name|s
operator|.
name|zto
operator|=
name|zto
expr_stmt|;
name|s
operator|.
name|zuser
operator|=
name|zCuser
expr_stmt|;
name|s
operator|.
name|zoptions
operator|=
name|abCrec_options
expr_stmt|;
name|s
operator|.
name|ztemp
operator|=
literal|""
expr_stmt|;
name|s
operator|.
name|imode
operator|=
literal|0
expr_stmt|;
name|s
operator|.
name|znotify
operator|=
literal|""
expr_stmt|;
name|s
operator|.
name|cbytes
operator|=
operator|-
literal|1
expr_stmt|;
name|s
operator|.
name|zcmd
operator|=
name|NULL
expr_stmt|;
name|s
operator|.
name|ipos
operator|=
literal|0
expr_stmt|;
name|ucadd_cmd
argument_list|(
name|qfromsys
argument_list|,
operator|&
name|s
argument_list|,
operator|(
specifier|const
name|char
operator|*
operator|)
name|NULL
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|char
modifier|*
name|zxqt
decl_stmt|;
name|char
name|abtname
index|[
name|CFILE_NAME_LEN
index|]
decl_stmt|;
name|char
name|abxname
index|[
name|CFILE_NAME_LEN
index|]
decl_stmt|;
name|FILE
modifier|*
name|e
decl_stmt|;
name|char
modifier|*
name|zcmd
decl_stmt|;
name|char
modifier|*
name|zlog
decl_stmt|;
comment|/* The file either comes from some other system through 	     qfromsys or is intended for some other system.  Send an 	     execution request to qfromsys to handle everything.  */
name|zxqt
operator|=
name|zsysdep_data_file_name
argument_list|(
name|qfromsys
argument_list|,
name|zloc
argument_list|,
name|bCgrade
argument_list|,
name|TRUE
argument_list|,
name|abtname
argument_list|,
operator|(
name|char
operator|*
operator|)
name|NULL
argument_list|,
name|abxname
argument_list|)
expr_stmt|;
if|if
condition|(
name|zxqt
operator|==
name|NULL
condition|)
name|ucabort
argument_list|()
expr_stmt|;
name|e
operator|=
name|esysdep_fopen
argument_list|(
name|zxqt
argument_list|,
name|FALSE
argument_list|,
name|FALSE
argument_list|,
name|TRUE
argument_list|)
expr_stmt|;
if|if
condition|(
name|e
operator|==
name|NULL
condition|)
name|ucabort
argument_list|()
expr_stmt|;
name|ucrecord_file
argument_list|(
name|zxqt
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|e
argument_list|,
literal|"U %s %s\n"
argument_list|,
name|zCuser
argument_list|,
name|zloc
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|e
argument_list|,
literal|"C uucp -C"
argument_list|)
expr_stmt|;
if|if
condition|(
name|fCmkdirs
condition|)
name|fprintf
argument_list|(
name|e
argument_list|,
literal|" -d"
argument_list|)
expr_stmt|;
else|else
name|fprintf
argument_list|(
name|e
argument_list|,
literal|" -f"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|e
argument_list|,
literal|" -g %c"
argument_list|,
name|bCgrade
argument_list|)
expr_stmt|;
if|if
condition|(
name|fCmail
condition|)
name|fprintf
argument_list|(
name|e
argument_list|,
literal|" -m"
argument_list|)
expr_stmt|;
if|if
condition|(
operator|*
name|zCnotify
operator|!=
literal|'\0'
condition|)
name|fprintf
argument_list|(
name|e
argument_list|,
literal|" -n %s"
argument_list|,
name|zCnotify
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|fCexpand
condition|)
name|fprintf
argument_list|(
name|e
argument_list|,
literal|" -W"
argument_list|)
expr_stmt|;
name|clen
operator|=
operator|(
name|strlen
argument_list|(
name|zfrom
argument_list|)
operator|+
name|strlen
argument_list|(
name|zloc
argument_list|)
operator|+
name|strlen
argument_list|(
name|sCdestsys
operator|.
name|uuconf_zname
argument_list|)
operator|+
name|strlen
argument_list|(
name|zdest
argument_list|)
operator|)
expr_stmt|;
if|if
condition|(
name|zforward
operator|!=
name|NULL
condition|)
name|clen
operator|+=
name|strlen
argument_list|(
name|zforward
argument_list|)
expr_stmt|;
if|if
condition|(
name|zCforward
operator|!=
name|NULL
condition|)
name|clen
operator|+=
name|strlen
argument_list|(
name|zCforward
argument_list|)
expr_stmt|;
name|zcmd
operator|=
name|zbufalc
argument_list|(
sizeof|sizeof
expr|"! !!!"
operator|+
name|clen
argument_list|)
expr_stmt|;
operator|*
name|zcmd
operator|=
literal|'\0'
expr_stmt|;
if|if
condition|(
name|zforward
operator|!=
name|NULL
condition|)
name|sprintf
argument_list|(
name|zcmd
operator|+
name|strlen
argument_list|(
name|zcmd
argument_list|)
argument_list|,
literal|"%s!"
argument_list|,
name|zforward
argument_list|)
expr_stmt|;
name|sprintf
argument_list|(
name|zcmd
operator|+
name|strlen
argument_list|(
name|zcmd
argument_list|)
argument_list|,
literal|"%s %s!"
argument_list|,
name|zfrom
argument_list|,
name|zloc
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|fClocaldest
condition|)
name|sprintf
argument_list|(
name|zcmd
operator|+
name|strlen
argument_list|(
name|zcmd
argument_list|)
argument_list|,
literal|"%s!"
argument_list|,
name|sCdestsys
operator|.
name|uuconf_zname
argument_list|)
expr_stmt|;
if|if
condition|(
name|zCforward
operator|!=
name|NULL
condition|)
name|sprintf
argument_list|(
name|zcmd
operator|+
name|strlen
argument_list|(
name|zcmd
argument_list|)
argument_list|,
literal|"%s!"
argument_list|,
name|zCforward
argument_list|)
expr_stmt|;
name|sprintf
argument_list|(
name|zcmd
operator|+
name|strlen
argument_list|(
name|zcmd
argument_list|)
argument_list|,
literal|"%s"
argument_list|,
name|zdest
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|e
argument_list|,
literal|" %s\n"
argument_list|,
name|zcmd
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|fstdiosync
argument_list|(
name|e
argument_list|,
name|zxqt
argument_list|)
condition|)
name|ulog
argument_list|(
name|LOG_FATAL
argument_list|,
literal|"fsync failed"
argument_list|)
expr_stmt|;
if|if
condition|(
name|fclose
argument_list|(
name|e
argument_list|)
operator|!=
literal|0
condition|)
name|ulog
argument_list|(
name|LOG_FATAL
argument_list|,
literal|"fclose: %s"
argument_list|,
name|strerror
argument_list|(
name|errno
argument_list|)
argument_list|)
expr_stmt|;
comment|/* Send the execution file.  */
name|s
operator|.
name|bcmd
operator|=
literal|'S'
expr_stmt|;
name|s
operator|.
name|bgrade
operator|=
name|bCgrade
expr_stmt|;
name|s
operator|.
name|pseq
operator|=
name|NULL
expr_stmt|;
name|s
operator|.
name|zfrom
operator|=
name|zbufcpy
argument_list|(
name|abtname
argument_list|)
expr_stmt|;
name|s
operator|.
name|zto
operator|=
name|zbufcpy
argument_list|(
name|abxname
argument_list|)
expr_stmt|;
name|s
operator|.
name|zuser
operator|=
name|zCuser
expr_stmt|;
name|s
operator|.
name|zoptions
operator|=
literal|"C"
expr_stmt|;
name|s
operator|.
name|ztemp
operator|=
name|s
operator|.
name|zfrom
expr_stmt|;
name|s
operator|.
name|imode
operator|=
literal|0666
expr_stmt|;
name|s
operator|.
name|znotify
operator|=
name|NULL
expr_stmt|;
name|s
operator|.
name|cbytes
operator|=
operator|-
literal|1
expr_stmt|;
name|s
operator|.
name|zcmd
operator|=
name|NULL
expr_stmt|;
name|s
operator|.
name|ipos
operator|=
literal|0
expr_stmt|;
name|zlog
operator|=
name|zbufalc
argument_list|(
sizeof|sizeof
expr|"Queueing uucp "
operator|+
name|strlen
argument_list|(
name|zcmd
argument_list|)
argument_list|)
expr_stmt|;
name|sprintf
argument_list|(
name|zlog
argument_list|,
literal|"Queueing uucp %s"
argument_list|,
name|zcmd
argument_list|)
expr_stmt|;
name|ucadd_cmd
argument_list|(
name|qfromsys
argument_list|,
operator|&
name|s
argument_list|,
name|zlog
argument_list|)
expr_stmt|;
name|ubuffree
argument_list|(
name|zcmd
argument_list|)
expr_stmt|;
name|ubuffree
argument_list|(
name|zforward
argument_list|)
expr_stmt|;
block|}
block|}
block|}
end_function

begin_escape
end_escape

begin_comment
comment|/* We keep a list of jobs for each system.  */
end_comment

begin_struct
struct|struct
name|sjob
block|{
name|struct
name|sjob
modifier|*
name|qnext
decl_stmt|;
specifier|const
name|struct
name|uuconf_system
modifier|*
name|qsys
decl_stmt|;
name|int
name|ccmds
decl_stmt|;
name|struct
name|scmd
modifier|*
name|pascmds
decl_stmt|;
specifier|const
name|char
modifier|*
modifier|*
name|pazlogs
decl_stmt|;
block|}
struct|;
end_struct

begin_decl_stmt
specifier|static
name|struct
name|sjob
modifier|*
name|qCjobs
decl_stmt|;
end_decl_stmt

begin_function
specifier|static
name|void
name|ucadd_cmd
parameter_list|(
name|qsys
parameter_list|,
name|qcmd
parameter_list|,
name|zlog
parameter_list|)
specifier|const
name|struct
name|uuconf_system
modifier|*
name|qsys
decl_stmt|;
specifier|const
name|struct
name|scmd
modifier|*
name|qcmd
decl_stmt|;
specifier|const
name|char
modifier|*
name|zlog
decl_stmt|;
block|{
name|struct
name|sjob
modifier|*
name|qjob
decl_stmt|;
if|if
condition|(
operator|!
name|qsys
operator|->
name|uuconf_fcall_transfer
operator|&&
operator|!
name|qsys
operator|->
name|uuconf_fcalled_transfer
condition|)
name|ulog
argument_list|(
name|LOG_FATAL
argument_list|,
literal|"Not permitted to transfer files to or from %s"
argument_list|,
name|qsys
operator|->
name|uuconf_zname
argument_list|)
expr_stmt|;
for|for
control|(
name|qjob
operator|=
name|qCjobs
init|;
name|qjob
operator|!=
name|NULL
condition|;
name|qjob
operator|=
name|qjob
operator|->
name|qnext
control|)
if|if
condition|(
name|strcmp
argument_list|(
name|qjob
operator|->
name|qsys
operator|->
name|uuconf_zname
argument_list|,
name|qsys
operator|->
name|uuconf_zname
argument_list|)
operator|==
literal|0
condition|)
break|break;
if|if
condition|(
name|qjob
operator|==
name|NULL
condition|)
block|{
name|qjob
operator|=
operator|(
expr|struct
name|sjob
operator|*
operator|)
name|xmalloc
argument_list|(
sizeof|sizeof
argument_list|(
expr|struct
name|sjob
argument_list|)
argument_list|)
expr_stmt|;
name|qjob
operator|->
name|qnext
operator|=
name|qCjobs
expr_stmt|;
name|qjob
operator|->
name|qsys
operator|=
name|qsys
expr_stmt|;
name|qjob
operator|->
name|ccmds
operator|=
literal|0
expr_stmt|;
name|qjob
operator|->
name|pascmds
operator|=
name|NULL
expr_stmt|;
name|qjob
operator|->
name|pazlogs
operator|=
name|NULL
expr_stmt|;
name|qCjobs
operator|=
name|qjob
expr_stmt|;
block|}
name|qjob
operator|->
name|pascmds
operator|=
operator|(
operator|(
expr|struct
name|scmd
operator|*
operator|)
name|xrealloc
argument_list|(
operator|(
name|pointer
operator|)
name|qjob
operator|->
name|pascmds
argument_list|,
operator|(
name|qjob
operator|->
name|ccmds
operator|+
literal|1
operator|)
operator|*
sizeof|sizeof
argument_list|(
expr|struct
name|scmd
argument_list|)
argument_list|)
operator|)
expr_stmt|;
name|qjob
operator|->
name|pascmds
index|[
name|qjob
operator|->
name|ccmds
index|]
operator|=
operator|*
name|qcmd
expr_stmt|;
name|qjob
operator|->
name|pazlogs
operator|=
operator|(
operator|(
specifier|const
name|char
operator|*
operator|*
operator|)
name|xrealloc
argument_list|(
operator|(
name|pointer
operator|)
name|qjob
operator|->
name|pazlogs
argument_list|,
operator|(
name|qjob
operator|->
name|ccmds
operator|+
literal|1
operator|)
operator|*
sizeof|sizeof
argument_list|(
specifier|const
name|char
operator|*
argument_list|)
argument_list|)
operator|)
expr_stmt|;
name|qjob
operator|->
name|pazlogs
index|[
name|qjob
operator|->
name|ccmds
index|]
operator|=
name|zlog
expr_stmt|;
operator|++
name|qjob
operator|->
name|ccmds
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|ucspool_cmds
parameter_list|(
name|fjobid
parameter_list|)
name|boolean
name|fjobid
decl_stmt|;
block|{
name|struct
name|sjob
modifier|*
name|qjob
decl_stmt|;
name|char
modifier|*
name|zjobid
decl_stmt|;
for|for
control|(
name|qjob
operator|=
name|qCjobs
init|;
name|qjob
operator|!=
name|NULL
condition|;
name|qjob
operator|=
name|qjob
operator|->
name|qnext
control|)
block|{
name|ulog_system
argument_list|(
name|qjob
operator|->
name|qsys
operator|->
name|uuconf_zname
argument_list|)
expr_stmt|;
name|zjobid
operator|=
name|zsysdep_spool_commands
argument_list|(
name|qjob
operator|->
name|qsys
argument_list|,
name|bCgrade
argument_list|,
name|qjob
operator|->
name|ccmds
argument_list|,
name|qjob
operator|->
name|pascmds
argument_list|)
expr_stmt|;
if|if
condition|(
name|zjobid
operator|!=
name|NULL
condition|)
block|{
name|int
name|i
decl_stmt|;
name|struct
name|scmd
modifier|*
name|qcmd
decl_stmt|;
specifier|const
name|char
modifier|*
modifier|*
name|pz
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
operator|,
name|qcmd
operator|=
name|qjob
operator|->
name|pascmds
operator|,
name|pz
operator|=
name|qjob
operator|->
name|pazlogs
init|;
name|i
operator|<
name|qjob
operator|->
name|ccmds
condition|;
name|i
operator|++
operator|,
name|qcmd
operator|++
operator|,
name|pz
operator|++
control|)
block|{
if|if
condition|(
operator|*
name|pz
operator|!=
name|NULL
condition|)
block|{
if|if
condition|(
operator|*
operator|*
name|pz
operator|!=
literal|'\0'
condition|)
name|ulog
argument_list|(
name|LOG_NORMAL
argument_list|,
literal|"%s"
argument_list|,
operator|*
name|pz
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|qcmd
operator|->
name|bcmd
operator|==
literal|'S'
condition|)
name|ulog
argument_list|(
name|LOG_NORMAL
argument_list|,
literal|"Queuing send of %s to %s"
argument_list|,
name|qcmd
operator|->
name|zfrom
argument_list|,
name|qcmd
operator|->
name|zto
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|qcmd
operator|->
name|bcmd
operator|==
literal|'R'
condition|)
name|ulog
argument_list|(
name|LOG_NORMAL
argument_list|,
literal|"Queuing request of %s to %s"
argument_list|,
name|qcmd
operator|->
name|zfrom
argument_list|,
name|qcmd
operator|->
name|zto
argument_list|)
expr_stmt|;
else|else
block|{
specifier|const
name|char
modifier|*
name|zto
decl_stmt|;
name|zto
operator|=
name|strrchr
argument_list|(
name|qcmd
operator|->
name|zto
argument_list|,
literal|'!'
argument_list|)
expr_stmt|;
if|if
condition|(
name|zto
operator|!=
name|NULL
condition|)
operator|++
name|zto
expr_stmt|;
else|else
name|zto
operator|=
name|qcmd
operator|->
name|zto
expr_stmt|;
name|ulog
argument_list|(
name|LOG_NORMAL
argument_list|,
literal|"Queuing request of %s to %s"
argument_list|,
name|qcmd
operator|->
name|zfrom
argument_list|,
name|zto
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
name|fjobid
condition|)
name|printf
argument_list|(
literal|"%s\n"
argument_list|,
name|zjobid
argument_list|)
expr_stmt|;
name|ubuffree
argument_list|(
name|zjobid
argument_list|)
expr_stmt|;
block|}
block|}
block|}
end_function

begin_comment
comment|/* Return the system name for which we have created commands, or NULL    if we've created commands for more than one system.  Set *pfany to    FALSE if we didn't create work for any system.  */
end_comment

begin_function
specifier|static
specifier|const
name|char
modifier|*
name|zcone_system
parameter_list|(
name|pfany
parameter_list|)
name|boolean
modifier|*
name|pfany
decl_stmt|;
block|{
if|if
condition|(
name|qCjobs
operator|==
name|NULL
condition|)
block|{
operator|*
name|pfany
operator|=
name|FALSE
expr_stmt|;
return|return
name|NULL
return|;
block|}
operator|*
name|pfany
operator|=
name|TRUE
expr_stmt|;
if|if
condition|(
name|qCjobs
operator|->
name|qnext
operator|==
name|NULL
condition|)
return|return
name|qCjobs
operator|->
name|qsys
operator|->
name|uuconf_zname
return|;
else|else
return|return
name|NULL
return|;
block|}
end_function

begin_escape
end_escape

begin_comment
comment|/* Keep track of all files we have created so that we can delete them    if we get a signal.  The argument will be on the heap.  */
end_comment

begin_decl_stmt
specifier|static
name|int
name|cCfiles
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
specifier|const
name|char
modifier|*
modifier|*
name|pCaz
decl_stmt|;
end_decl_stmt

begin_function
specifier|static
name|void
name|ucrecord_file
parameter_list|(
name|zfile
parameter_list|)
specifier|const
name|char
modifier|*
name|zfile
decl_stmt|;
block|{
name|pCaz
operator|=
operator|(
specifier|const
name|char
operator|*
operator|*
operator|)
name|xrealloc
argument_list|(
operator|(
name|pointer
operator|)
name|pCaz
argument_list|,
operator|(
name|cCfiles
operator|+
literal|1
operator|)
operator|*
sizeof|sizeof
argument_list|(
specifier|const
name|char
operator|*
argument_list|)
argument_list|)
expr_stmt|;
name|pCaz
index|[
name|cCfiles
index|]
operator|=
name|zfile
expr_stmt|;
operator|++
name|cCfiles
expr_stmt|;
block|}
end_function

begin_comment
comment|/* Delete all the files we have recorded and exit.  */
end_comment

begin_function
specifier|static
name|void
name|ucabort
parameter_list|()
block|{
name|int
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|cCfiles
condition|;
name|i
operator|++
control|)
operator|(
name|void
operator|)
name|remove
argument_list|(
name|pCaz
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|ulog_close
argument_list|()
expr_stmt|;
name|usysdep_exit
argument_list|(
name|FALSE
argument_list|)
expr_stmt|;
block|}
end_function

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Copyright (c) 1983 Regents of the University of California.  * All rights reserved.  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions  * are met:  * 1. Redistributions of source code must retain the above copyright  *    notice, this list of conditions and the following disclaimer.  * 2. Redistributions in binary form must reproduce the above copyright  *    notice, this list of conditions and the following disclaimer in the  *    documentation and/or other materials provided with the distribution.  * 3. All advertising materials mentioning features or use of this software  *    must display the following acknowledgement:  *	This product includes software developed by the University of  *	California, Berkeley and its contributors.  * 4. Neither the name of the University nor the names of its contributors  *    may be used to endorse or promote products derived from this software  *    without specific prior written permission.  *  * THIS SOFTWARE IS PROVIDED BY THE REGENTS AND CONTRIBUTORS ``AS IS'' AND  * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE  * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE  * ARE DISCLAIMED.  IN NO EVENT SHALL THE REGENTS OR CONTRIBUTORS BE LIABLE  * FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL  * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS  * OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)  * HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT  * LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY  * OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF  * SUCH DAMAGE.  */
end_comment

begin_ifndef
ifndef|#
directive|ifndef
name|lint
end_ifndef

begin_decl_stmt
name|char
name|copyright
index|[]
init|=
literal|"@(#) Copyright (c) 1983 Regents of the University of California.\n\  All rights reserved.\n"
decl_stmt|;
end_decl_stmt

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* not lint */
end_comment

begin_ifndef
ifndef|#
directive|ifndef
name|lint
end_ifndef

begin_decl_stmt
specifier|static
name|char
name|sccsid
index|[]
init|=
literal|"@(#)vplotf.c	5.5 (Berkeley) 6/1/90"
decl_stmt|;
end_decl_stmt

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* not lint */
end_comment

begin_comment
comment|/*  *  Lpd filter to read standard graphics input and produce a plot on the  *  Varian or Versatec  */
end_comment

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_include
include|#
directive|include
file|<vfont.h>
end_include

begin_include
include|#
directive|include
file|<sys/vcmd.h>
end_include

begin_define
define|#
directive|define
name|mapx
parameter_list|(
name|x
parameter_list|)
value|((DevRange*((x)-botx)/del)+centx)
end_define

begin_define
define|#
directive|define
name|mapy
parameter_list|(
name|y
parameter_list|)
value|((DevRange*(del-(y)+boty)/del)-centy)
end_define

begin_define
define|#
directive|define
name|SOLID
value|-1
end_define

begin_define
define|#
directive|define
name|DOTTED
value|014
end_define

begin_define
define|#
directive|define
name|SHORTDASHED
value|034
end_define

begin_define
define|#
directive|define
name|DOTDASHED
value|054
end_define

begin_define
define|#
directive|define
name|LONGDASHED
value|074
end_define

begin_decl_stmt
specifier|static
name|char
modifier|*
name|Sid
init|=
literal|"@(#)\t5/16/83"
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|linmod
init|=
name|SOLID
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|done1
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|char
name|chrtab
index|[]
index|[
literal|16
index|]
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|char
modifier|*
name|obuf
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|bufsize
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|lastx
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|lasty
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|radius
decl_stmt|,
name|startx
decl_stmt|,
name|starty
decl_stmt|,
name|endx
decl_stmt|,
name|endy
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|double
name|topx
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|double
name|topy
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|double
name|botx
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|double
name|boty
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|centx
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|centy
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|double
name|delx
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|double
name|dely
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|double
name|del
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|warned
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* Indicates whether the warning message about 			 * unimplemented routines has been printed */
end_comment

begin_decl_stmt
name|int
name|plotmd
index|[]
init|=
block|{
name|VPLOT
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|prtmd
index|[]
init|=
block|{
name|VPRINT
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|varian
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* 0 for versatec, 1 for varian. */
end_comment

begin_decl_stmt
name|int
name|BYTES_PER_LINE
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* number of bytes per raster line. */
end_comment

begin_decl_stmt
name|int
name|PAGE_LINES
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* number of raster lines per page. */
end_comment

begin_decl_stmt
name|int
name|DevRange
init|=
literal|1536
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* output array size (square) in pixels */
end_comment

begin_decl_stmt
name|int
name|DevRange8
init|=
literal|1536
operator|/
literal|8
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* output array size in bytes */
end_comment

begin_decl_stmt
name|int
name|lines
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* number of raster lines printed */
end_comment

begin_decl_stmt
name|char
name|zeros
index|[
literal|880
index|]
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* one raster line */
end_comment

begin_decl_stmt
name|char
modifier|*
name|name
decl_stmt|,
modifier|*
name|host
decl_stmt|,
modifier|*
name|acctfile
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* variables used to print from font file */
end_comment

begin_decl_stmt
name|int
name|fontSet
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* Has the font file been read */
end_comment

begin_decl_stmt
name|struct
name|header
name|header
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|struct
name|dispatch
name|dispatch
index|[
literal|256
index|]
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|char
modifier|*
name|bits
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|char
modifier|*
name|fontFile
init|=
literal|"/usr/lib/vfont/R.8"
decl_stmt|;
end_decl_stmt

begin_function
name|main
parameter_list|(
name|argc
parameter_list|,
name|argv
parameter_list|)
name|int
name|argc
decl_stmt|;
name|char
modifier|*
name|argv
index|[]
decl_stmt|;
block|{
specifier|register
name|char
modifier|*
name|cp
decl_stmt|,
modifier|*
name|arg
decl_stmt|;
specifier|register
name|n
operator|,
name|again
expr_stmt|;
while|while
condition|(
operator|--
name|argc
condition|)
block|{
if|if
condition|(
operator|*
operator|*
operator|++
name|argv
operator|==
literal|'-'
condition|)
block|{
switch|switch
condition|(
name|argv
index|[
literal|0
index|]
index|[
literal|1
index|]
condition|)
block|{
case|case
literal|'x'
case|:
name|BYTES_PER_LINE
operator|=
name|atoi
argument_list|(
operator|&
name|argv
index|[
literal|0
index|]
index|[
literal|2
index|]
argument_list|)
operator|/
literal|8
expr_stmt|;
if|if
condition|(
name|varian
operator|=
name|BYTES_PER_LINE
operator|==
literal|264
condition|)
block|{
name|DevRange
operator|=
literal|1536
expr_stmt|;
name|DevRange8
operator|=
literal|1536
operator|/
literal|8
expr_stmt|;
block|}
else|else
block|{
name|DevRange
operator|=
literal|2048
expr_stmt|;
name|DevRange8
operator|=
literal|2048
operator|/
literal|8
expr_stmt|;
block|}
break|break;
case|case
literal|'y'
case|:
name|PAGE_LINES
operator|=
name|atoi
argument_list|(
operator|&
name|argv
index|[
literal|0
index|]
index|[
literal|2
index|]
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'n'
case|:
name|argc
operator|--
expr_stmt|;
name|name
operator|=
operator|*
operator|++
name|argv
expr_stmt|;
break|break;
case|case
literal|'h'
case|:
name|argc
operator|--
expr_stmt|;
name|host
operator|=
operator|*
operator|++
name|argv
expr_stmt|;
block|}
block|}
else|else
name|acctfile
operator|=
operator|*
name|argv
expr_stmt|;
block|}
comment|/* init constants for scaling */
name|topx
operator|=
name|topy
operator|=
name|DevRange
expr_stmt|;
name|botx
operator|=
name|boty
operator|=
literal|0
expr_stmt|;
name|delx
operator|=
name|dely
operator|=
name|del
operator|=
name|DevRange
expr_stmt|;
name|centx
operator|=
operator|(
name|DevRange
operator|-
name|mapx
argument_list|(
name|topx
argument_list|)
operator|)
operator|/
literal|2
expr_stmt|;
name|centy
operator|=
name|mapy
argument_list|(
name|topy
argument_list|)
operator|/
literal|2
expr_stmt|;
if|if
condition|(
operator|(
name|obuf
operator|=
operator|(
name|char
operator|*
operator|)
name|malloc
argument_list|(
name|bufsize
operator|=
name|DevRange
operator|*
name|DevRange8
argument_list|)
operator|)
operator|==
name|NULL
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"vplotf: ran out of memory\n"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|2
argument_list|)
expr_stmt|;
block|}
do|do
block|{
name|arg
operator|=
operator|&
name|obuf
index|[
name|bufsize
index|]
expr_stmt|;
for|for
control|(
name|cp
operator|=
name|obuf
init|;
name|cp
operator|<
name|arg
condition|;
control|)
operator|*
name|cp
operator|++
operator|=
literal|0
expr_stmt|;
name|again
operator|=
name|getpict
argument_list|()
expr_stmt|;
name|ioctl
argument_list|(
literal|1
argument_list|,
name|VSETSTATE
argument_list|,
name|plotmd
argument_list|)
expr_stmt|;
name|n
operator|=
name|BYTES_PER_LINE
operator|-
name|DevRange8
expr_stmt|;
for|for
control|(
name|cp
operator|=
name|obuf
init|;
name|cp
operator|<
name|arg
condition|;
name|cp
operator|+=
name|DevRange8
control|)
block|{
if|if
condition|(
name|write
argument_list|(
literal|1
argument_list|,
name|cp
argument_list|,
name|DevRange8
argument_list|)
operator|!=
name|DevRange8
condition|)
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|n
operator|&&
name|write
argument_list|(
literal|1
argument_list|,
name|zeros
argument_list|,
name|n
argument_list|)
operator|!=
name|n
condition|)
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
name|lines
operator|++
expr_stmt|;
block|}
name|ioctl
argument_list|(
literal|1
argument_list|,
name|VSETSTATE
argument_list|,
name|prtmd
argument_list|)
expr_stmt|;
if|if
condition|(
name|varian
condition|)
name|write
argument_list|(
literal|1
argument_list|,
literal|"\f"
argument_list|,
literal|2
argument_list|)
expr_stmt|;
else|else
name|write
argument_list|(
literal|1
argument_list|,
literal|"\n\n\n\n\n"
argument_list|,
literal|6
argument_list|)
expr_stmt|;
block|}
do|while
condition|(
name|again
condition|)
do|;
name|account
argument_list|(
name|name
argument_list|,
name|host
argument_list|,
operator|*
name|argv
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|0
argument_list|)
expr_stmt|;
block|}
end_function

begin_macro
name|account
argument_list|(
argument|who
argument_list|,
argument|from
argument_list|,
argument|acctfile
argument_list|)
end_macro

begin_decl_stmt
name|char
modifier|*
name|who
decl_stmt|,
modifier|*
name|from
decl_stmt|,
modifier|*
name|acctfile
decl_stmt|;
end_decl_stmt

begin_block
block|{
specifier|register
name|FILE
modifier|*
name|a
decl_stmt|;
if|if
condition|(
name|who
operator|==
name|NULL
operator|||
name|acctfile
operator|==
name|NULL
condition|)
return|return;
if|if
condition|(
name|access
argument_list|(
name|acctfile
argument_list|,
literal|02
argument_list|)
operator|||
operator|(
name|a
operator|=
name|fopen
argument_list|(
name|acctfile
argument_list|,
literal|"a"
argument_list|)
operator|)
operator|==
name|NULL
condition|)
return|return;
comment|/* 	 * Varian accounting is done by 8.5 inch pages; 	 * Versatec accounting is by the (12 inch) foot. 	 */
name|fprintf
argument_list|(
name|a
argument_list|,
literal|"t%6.2f\t"
argument_list|,
operator|(
name|double
operator|)
name|lines
operator|/
operator|(
name|double
operator|)
name|PAGE_LINES
argument_list|)
expr_stmt|;
if|if
condition|(
name|from
operator|!=
name|NULL
condition|)
name|fprintf
argument_list|(
name|a
argument_list|,
literal|"%s:"
argument_list|,
name|from
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|a
argument_list|,
literal|"%s\n"
argument_list|,
name|who
argument_list|)
expr_stmt|;
name|fclose
argument_list|(
name|a
argument_list|)
expr_stmt|;
block|}
end_block

begin_macro
name|getpict
argument_list|()
end_macro

begin_block
block|{
specifier|register
name|x1
operator|,
name|y1
expr_stmt|;
for|for
control|(
init|;
condition|;
control|)
switch|switch
condition|(
name|x1
operator|=
name|getc
argument_list|(
name|stdin
argument_list|)
condition|)
block|{
case|case
literal|'\n'
case|:
continue|continue;
case|case
literal|'s'
case|:
name|botx
operator|=
name|getinteger
argument_list|(
name|stdin
argument_list|)
expr_stmt|;
name|boty
operator|=
name|getinteger
argument_list|(
name|stdin
argument_list|)
expr_stmt|;
name|topx
operator|=
name|getinteger
argument_list|(
name|stdin
argument_list|)
expr_stmt|;
name|topy
operator|=
name|getinteger
argument_list|(
name|stdin
argument_list|)
expr_stmt|;
name|delx
operator|=
name|topx
operator|-
name|botx
expr_stmt|;
name|dely
operator|=
name|topy
operator|-
name|boty
expr_stmt|;
if|if
condition|(
name|dely
operator|/
name|delx
operator|>
literal|1536.
operator|/
literal|2048.
condition|)
name|del
operator|=
name|dely
expr_stmt|;
else|else
name|del
operator|=
name|delx
expr_stmt|;
name|centx
operator|=
literal|0
expr_stmt|;
name|centx
operator|=
operator|(
name|DevRange
operator|-
name|mapx
argument_list|(
name|topx
argument_list|)
operator|)
operator|/
literal|2
expr_stmt|;
name|centy
operator|=
literal|0
expr_stmt|;
name|centy
operator|=
name|mapy
argument_list|(
name|topy
argument_list|)
operator|/
literal|2
expr_stmt|;
continue|continue;
case|case
literal|'b'
case|:
name|x1
operator|=
name|getc
argument_list|(
name|stdin
argument_list|)
expr_stmt|;
continue|continue;
case|case
literal|'l'
case|:
name|done1
operator||=
literal|01
expr_stmt|;
name|x1
operator|=
name|mapx
argument_list|(
name|getinteger
argument_list|(
name|stdin
argument_list|)
argument_list|)
expr_stmt|;
name|y1
operator|=
name|mapy
argument_list|(
name|getinteger
argument_list|(
name|stdin
argument_list|)
argument_list|)
expr_stmt|;
name|lastx
operator|=
name|mapx
argument_list|(
name|getinteger
argument_list|(
name|stdin
argument_list|)
argument_list|)
expr_stmt|;
name|lasty
operator|=
name|mapy
argument_list|(
name|getinteger
argument_list|(
name|stdin
argument_list|)
argument_list|)
expr_stmt|;
name|line
argument_list|(
name|x1
argument_list|,
name|y1
argument_list|,
name|lastx
argument_list|,
name|lasty
argument_list|)
expr_stmt|;
continue|continue;
case|case
literal|'c'
case|:
name|x1
operator|=
name|mapx
argument_list|(
name|getinteger
argument_list|(
name|stdin
argument_list|)
argument_list|)
expr_stmt|;
name|y1
operator|=
name|mapy
argument_list|(
name|getinteger
argument_list|(
name|stdin
argument_list|)
argument_list|)
expr_stmt|;
name|radius
operator|=
name|mapx
argument_list|(
name|getinteger
argument_list|(
name|stdin
argument_list|)
argument_list|)
expr_stmt|;
name|circle
argument_list|(
name|x1
argument_list|,
name|y1
argument_list|,
name|radius
argument_list|)
expr_stmt|;
continue|continue;
case|case
literal|'a'
case|:
name|x1
operator|=
name|mapx
argument_list|(
name|getinteger
argument_list|(
name|stdin
argument_list|)
argument_list|)
expr_stmt|;
name|y1
operator|=
name|mapy
argument_list|(
name|getinteger
argument_list|(
name|stdin
argument_list|)
argument_list|)
expr_stmt|;
name|startx
operator|=
name|mapx
argument_list|(
name|getinteger
argument_list|(
name|stdin
argument_list|)
argument_list|)
expr_stmt|;
name|starty
operator|=
name|mapy
argument_list|(
name|getinteger
argument_list|(
name|stdin
argument_list|)
argument_list|)
expr_stmt|;
name|endx
operator|=
name|mapx
argument_list|(
name|getinteger
argument_list|(
name|stdin
argument_list|)
argument_list|)
expr_stmt|;
name|endy
operator|=
name|mapy
argument_list|(
name|getinteger
argument_list|(
name|stdin
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|warned
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Arcs are unimplemented\n"
argument_list|)
expr_stmt|;
name|warned
operator|++
expr_stmt|;
block|}
continue|continue;
case|case
literal|'m'
case|:
name|lastx
operator|=
name|mapx
argument_list|(
name|getinteger
argument_list|(
name|stdin
argument_list|)
argument_list|)
expr_stmt|;
name|lasty
operator|=
name|mapy
argument_list|(
name|getinteger
argument_list|(
name|stdin
argument_list|)
argument_list|)
expr_stmt|;
continue|continue;
case|case
literal|'t'
case|:
name|lastx
operator|=
name|lastx
operator|-
literal|6
expr_stmt|;
name|lasty
operator|=
name|lasty
operator|+
literal|6
expr_stmt|;
name|done1
operator||=
literal|01
expr_stmt|;
while|while
condition|(
operator|(
name|x1
operator|=
name|getc
argument_list|(
name|stdin
argument_list|)
operator|)
operator|!=
literal|'\n'
condition|)
name|plotch
argument_list|(
name|x1
argument_list|)
expr_stmt|;
continue|continue;
case|case
literal|'e'
case|:
if|if
condition|(
name|done1
condition|)
return|return
operator|(
literal|1
operator|)
return|;
continue|continue;
case|case
literal|'p'
case|:
name|done1
operator||=
literal|01
expr_stmt|;
name|lastx
operator|=
name|mapx
argument_list|(
name|getinteger
argument_list|(
name|stdin
argument_list|)
argument_list|)
expr_stmt|;
name|lasty
operator|=
name|mapy
argument_list|(
name|getinteger
argument_list|(
name|stdin
argument_list|)
argument_list|)
expr_stmt|;
name|point
argument_list|(
name|lastx
argument_list|,
name|lasty
argument_list|)
expr_stmt|;
name|point
argument_list|(
name|lastx
operator|+
literal|1
argument_list|,
name|lasty
argument_list|)
expr_stmt|;
name|point
argument_list|(
name|lastx
argument_list|,
name|lasty
operator|+
literal|1
argument_list|)
expr_stmt|;
name|point
argument_list|(
name|lastx
operator|+
literal|1
argument_list|,
name|lasty
operator|+
literal|1
argument_list|)
expr_stmt|;
continue|continue;
case|case
literal|'n'
case|:
name|done1
operator||=
literal|01
expr_stmt|;
name|x1
operator|=
name|mapx
argument_list|(
name|getinteger
argument_list|(
name|stdin
argument_list|)
argument_list|)
expr_stmt|;
name|y1
operator|=
name|mapy
argument_list|(
name|getinteger
argument_list|(
name|stdin
argument_list|)
argument_list|)
expr_stmt|;
name|line
argument_list|(
name|lastx
argument_list|,
name|lasty
argument_list|,
name|x1
argument_list|,
name|y1
argument_list|)
expr_stmt|;
name|lastx
operator|=
name|x1
expr_stmt|;
name|lasty
operator|=
name|y1
expr_stmt|;
continue|continue;
case|case
literal|'f'
case|:
name|getinteger
argument_list|(
name|stdin
argument_list|)
expr_stmt|;
name|getc
argument_list|(
name|stdin
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|getc
argument_list|(
name|stdin
argument_list|)
condition|)
block|{
case|case
literal|'t'
case|:
name|linmod
operator|=
name|DOTTED
expr_stmt|;
break|break;
default|default:
case|case
literal|'i'
case|:
name|linmod
operator|=
name|SOLID
expr_stmt|;
break|break;
case|case
literal|'g'
case|:
name|linmod
operator|=
name|LONGDASHED
expr_stmt|;
break|break;
case|case
literal|'r'
case|:
name|linmod
operator|=
name|SHORTDASHED
expr_stmt|;
break|break;
case|case
literal|'d'
case|:
name|linmod
operator|=
name|DOTDASHED
expr_stmt|;
break|break;
block|}
while|while
condition|(
operator|(
name|x1
operator|=
name|getc
argument_list|(
name|stdin
argument_list|)
operator|)
operator|!=
literal|'\n'
condition|)
if|if
condition|(
name|x1
operator|==
name|EOF
condition|)
return|return
operator|(
literal|0
operator|)
return|;
continue|continue;
case|case
literal|'d'
case|:
name|getinteger
argument_list|(
name|stdin
argument_list|)
expr_stmt|;
name|getinteger
argument_list|(
name|stdin
argument_list|)
expr_stmt|;
name|getinteger
argument_list|(
name|stdin
argument_list|)
expr_stmt|;
name|x1
operator|=
name|getinteger
argument_list|(
name|stdin
argument_list|)
expr_stmt|;
while|while
condition|(
operator|--
name|x1
operator|>=
literal|0
condition|)
name|getinteger
argument_list|(
name|stdin
argument_list|)
expr_stmt|;
continue|continue;
case|case
literal|0
case|:
comment|/* ignore null characters */
continue|continue;
case|case
literal|255
case|:
case|case
name|EOF
case|:
return|return
operator|(
literal|0
operator|)
return|;
default|default:
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Input format error %c(%o)\n"
argument_list|,
name|x1
argument_list|,
name|x1
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|2
argument_list|)
expr_stmt|;
block|}
block|}
end_block

begin_macro
name|plotch
argument_list|(
argument|ch
argument_list|)
end_macro

begin_decl_stmt
name|char
name|ch
decl_stmt|;
end_decl_stmt

begin_block
block|{
specifier|register
name|int
name|i
decl_stmt|,
name|j
decl_stmt|,
name|k
decl_stmt|;
specifier|register
name|char
modifier|*
name|ptr
decl_stmt|,
name|c
decl_stmt|;
name|int
name|nbytes
decl_stmt|;
if|if
condition|(
operator|!
name|fontSet
condition|)
name|InitFont
argument_list|()
expr_stmt|;
comment|/* Read font if not already read */
name|ptr
operator|=
name|bits
operator|+
name|dispatch
index|[
name|ch
index|]
operator|.
name|addr
expr_stmt|;
for|for
control|(
name|i
operator|=
name|dispatch
index|[
name|ch
index|]
operator|.
name|up
init|;
name|i
operator|>
operator|-
name|dispatch
index|[
name|ch
index|]
operator|.
name|down
condition|;
operator|--
name|i
control|)
block|{
name|nbytes
operator|=
operator|(
name|dispatch
index|[
name|ch
index|]
operator|.
name|right
operator|+
name|dispatch
index|[
name|ch
index|]
operator|.
name|left
operator|+
literal|7
operator|)
operator|/
literal|8
expr_stmt|;
for|for
control|(
name|j
operator|=
literal|0
init|;
name|j
operator|<
name|nbytes
condition|;
name|j
operator|++
control|)
block|{
name|c
operator|=
operator|*
name|ptr
operator|++
expr_stmt|;
for|for
control|(
name|k
operator|=
literal|7
init|;
name|k
operator|>=
literal|0
condition|;
name|k
operator|--
control|)
if|if
condition|(
operator|(
name|c
operator|>>
name|k
operator|)
operator|&
literal|1
condition|)
name|point
argument_list|(
name|lastx
operator|+
literal|7
operator|-
name|k
operator|+
name|j
operator|*
literal|8
operator|-
name|dispatch
index|[
name|ch
index|]
operator|.
name|left
argument_list|,
name|lasty
operator|-
name|i
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
name|ch
operator|!=
literal|' '
condition|)
name|lastx
operator|+=
name|dispatch
index|[
name|ch
index|]
operator|.
name|width
expr_stmt|;
else|else
name|lastx
operator|+=
name|dispatch
index|[
literal|'a'
index|]
operator|.
name|width
expr_stmt|;
block|}
end_block

begin_macro
name|InitFont
argument_list|()
end_macro

begin_block
block|{
name|char
modifier|*
name|s
decl_stmt|;
name|int
name|fonts
decl_stmt|;
name|int
name|i
decl_stmt|;
name|fontSet
operator|=
literal|1
expr_stmt|;
comment|/* Get the font file */
name|s
operator|=
name|fontFile
expr_stmt|;
if|if
condition|(
operator|(
name|fonts
operator|=
name|open
argument_list|(
name|s
argument_list|,
literal|0
argument_list|)
operator|)
operator|==
operator|-
literal|1
condition|)
block|{
name|perror
argument_list|(
name|s
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Can't get font file"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|2
argument_list|)
expr_stmt|;
block|}
comment|/* Get the header and check magic number */
if|if
condition|(
name|read
argument_list|(
name|fonts
argument_list|,
operator|&
name|header
argument_list|,
sizeof|sizeof
argument_list|(
name|header
argument_list|)
argument_list|)
operator|!=
sizeof|sizeof
argument_list|(
name|header
argument_list|)
condition|)
block|{
name|perror
argument_list|(
name|s
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Bad read in font file"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|2
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|header
operator|.
name|magic
operator|!=
literal|0436
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Bad magic numer in font file"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|2
argument_list|)
expr_stmt|;
block|}
comment|/* Get dispatches */
if|if
condition|(
name|read
argument_list|(
name|fonts
argument_list|,
name|dispatch
argument_list|,
sizeof|sizeof
argument_list|(
name|dispatch
argument_list|)
argument_list|)
operator|!=
sizeof|sizeof
argument_list|(
name|dispatch
argument_list|)
condition|)
block|{
name|perror
argument_list|(
name|s
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Bad read in font file"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|2
argument_list|)
expr_stmt|;
block|}
comment|/* Allocate space for bit map and read in bits */
name|bits
operator|=
operator|(
name|char
operator|*
operator|)
name|malloc
argument_list|(
name|header
operator|.
name|size
argument_list|)
expr_stmt|;
if|if
condition|(
name|read
argument_list|(
name|fonts
argument_list|,
name|bits
argument_list|,
name|header
operator|.
name|size
argument_list|)
operator|!=
name|header
operator|.
name|size
condition|)
block|{
name|perror
argument_list|(
name|s
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Can't read bit map in font file"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|2
argument_list|)
expr_stmt|;
block|}
comment|/* Close font file */
if|if
condition|(
name|close
argument_list|(
name|fonts
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|perror
argument_list|(
name|s
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Can't close font file"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|2
argument_list|)
expr_stmt|;
block|}
block|}
end_block

begin_expr_stmt
name|line
argument_list|(
name|x0
argument_list|,
name|y0
argument_list|,
name|x1
argument_list|,
name|y1
argument_list|)
specifier|register
name|x0
operator|,
name|y0
expr_stmt|;
end_expr_stmt

begin_block
block|{
name|int
name|dx
decl_stmt|,
name|dy
decl_stmt|;
name|int
name|xinc
decl_stmt|,
name|yinc
decl_stmt|;
specifier|register
name|res1
expr_stmt|;
name|int
name|res2
decl_stmt|;
name|int
name|slope
decl_stmt|;
name|xinc
operator|=
literal|1
expr_stmt|;
name|yinc
operator|=
literal|1
expr_stmt|;
if|if
condition|(
operator|(
name|dx
operator|=
name|x1
operator|-
name|x0
operator|)
operator|<
literal|0
condition|)
block|{
name|xinc
operator|=
operator|-
literal|1
expr_stmt|;
name|dx
operator|=
operator|-
name|dx
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|dy
operator|=
name|y1
operator|-
name|y0
operator|)
operator|<
literal|0
condition|)
block|{
name|yinc
operator|=
operator|-
literal|1
expr_stmt|;
name|dy
operator|=
operator|-
name|dy
expr_stmt|;
block|}
name|slope
operator|=
name|xinc
operator|*
name|yinc
expr_stmt|;
name|res1
operator|=
literal|0
expr_stmt|;
name|res2
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|dx
operator|>=
name|dy
condition|)
while|while
condition|(
name|x0
operator|!=
name|x1
condition|)
block|{
if|if
condition|(
operator|(
name|x0
operator|+
name|slope
operator|*
name|y0
operator|)
operator|&
name|linmod
condition|)
name|point
argument_list|(
name|x0
argument_list|,
name|y0
argument_list|)
expr_stmt|;
if|if
condition|(
name|res1
operator|>
name|res2
condition|)
block|{
name|res2
operator|+=
name|dx
operator|-
name|res1
expr_stmt|;
name|res1
operator|=
literal|0
expr_stmt|;
name|y0
operator|+=
name|yinc
expr_stmt|;
block|}
name|res1
operator|+=
name|dy
expr_stmt|;
name|x0
operator|+=
name|xinc
expr_stmt|;
block|}
else|else
while|while
condition|(
name|y0
operator|!=
name|y1
condition|)
block|{
if|if
condition|(
operator|(
name|x0
operator|+
name|slope
operator|*
name|y0
operator|)
operator|&
name|linmod
condition|)
name|point
argument_list|(
name|x0
argument_list|,
name|y0
argument_list|)
expr_stmt|;
if|if
condition|(
name|res1
operator|>
name|res2
condition|)
block|{
name|res2
operator|+=
name|dy
operator|-
name|res1
expr_stmt|;
name|res1
operator|=
literal|0
expr_stmt|;
name|x0
operator|+=
name|xinc
expr_stmt|;
block|}
name|res1
operator|+=
name|dx
expr_stmt|;
name|y0
operator|+=
name|yinc
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|x1
operator|+
name|slope
operator|*
name|y1
operator|)
operator|&
name|linmod
condition|)
name|point
argument_list|(
name|x1
argument_list|,
name|y1
argument_list|)
expr_stmt|;
block|}
end_block

begin_define
define|#
directive|define
name|labs
parameter_list|(
name|a
parameter_list|)
value|((a)>= 0 ? (a) : -(a))
end_define

begin_macro
name|circle
argument_list|(
argument|x
argument_list|,
argument|y
argument_list|,
argument|c
argument_list|)
end_macro

begin_block
block|{
specifier|register
name|dx
operator|,
name|dy
expr_stmt|;
name|long
name|ep
decl_stmt|;
name|int
name|de
decl_stmt|;
name|dx
operator|=
literal|0
expr_stmt|;
name|ep
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|dy
operator|=
name|c
init|;
name|dy
operator|>=
name|dx
condition|;
name|dy
operator|--
control|)
block|{
for|for
control|(
init|;
condition|;
control|)
block|{
name|point
argument_list|(
name|x
operator|+
name|dx
argument_list|,
name|y
operator|+
name|dy
argument_list|)
expr_stmt|;
name|point
argument_list|(
name|x
operator|-
name|dx
argument_list|,
name|y
operator|+
name|dy
argument_list|)
expr_stmt|;
name|point
argument_list|(
name|x
operator|+
name|dx
argument_list|,
name|y
operator|-
name|dy
argument_list|)
expr_stmt|;
name|point
argument_list|(
name|x
operator|-
name|dx
argument_list|,
name|y
operator|-
name|dy
argument_list|)
expr_stmt|;
name|point
argument_list|(
name|x
operator|+
name|dy
argument_list|,
name|y
operator|+
name|dx
argument_list|)
expr_stmt|;
name|point
argument_list|(
name|x
operator|-
name|dy
argument_list|,
name|y
operator|+
name|dx
argument_list|)
expr_stmt|;
name|point
argument_list|(
name|x
operator|+
name|dy
argument_list|,
name|y
operator|-
name|dx
argument_list|)
expr_stmt|;
name|point
argument_list|(
name|x
operator|-
name|dy
argument_list|,
name|y
operator|-
name|dx
argument_list|)
expr_stmt|;
name|ep
operator|+=
literal|2
operator|*
name|dx
operator|+
literal|1
expr_stmt|;
name|de
operator|=
operator|-
literal|2
operator|*
name|dy
operator|+
literal|1
expr_stmt|;
name|dx
operator|++
expr_stmt|;
if|if
condition|(
name|labs
argument_list|(
name|ep
argument_list|)
operator|>=
name|labs
argument_list|(
name|ep
operator|+
name|de
argument_list|)
condition|)
block|{
name|ep
operator|+=
name|de
expr_stmt|;
break|break;
block|}
block|}
block|}
block|}
end_block

begin_comment
comment|/*  * Points should be in the range 0<= x (or y)<= DevRange.  * The origin is the top left-hand corner with increasing x towards the  * right and increasing y going down.  */
end_comment

begin_expr_stmt
name|point
argument_list|(
name|x
argument_list|,
name|y
argument_list|)
specifier|register
name|unsigned
name|x
operator|,
name|y
expr_stmt|;
end_expr_stmt

begin_block
block|{
specifier|register
name|unsigned
name|byte
decl_stmt|;
if|if
condition|(
name|x
operator|<
name|DevRange
operator|&&
name|y
operator|<
name|DevRange
condition|)
block|{
name|byte
operator|=
name|y
operator|*
name|DevRange8
operator|+
operator|(
name|x
operator|>>
literal|3
operator|)
expr_stmt|;
name|obuf
index|[
name|byte
index|]
operator||=
literal|1
operator|<<
operator|(
literal|7
operator|-
operator|(
name|x
operator|&
literal|07
operator|)
operator|)
expr_stmt|;
block|}
block|}
end_block

begin_macro
name|getinteger
argument_list|(
argument|f
argument_list|)
end_macro

begin_decl_stmt
name|FILE
modifier|*
name|f
decl_stmt|;
end_decl_stmt

begin_block
block|{
specifier|register
name|int
name|low
decl_stmt|,
name|high
decl_stmt|,
name|result
decl_stmt|;
name|low
operator|=
name|getc
argument_list|(
name|f
argument_list|)
expr_stmt|;
name|high
operator|=
name|getc
argument_list|(
name|f
argument_list|)
expr_stmt|;
name|result
operator|=
operator|(
operator|(
name|high
operator|<<
literal|8
operator|)
operator||
name|low
operator|)
expr_stmt|;
if|if
condition|(
name|high
operator|>
literal|127
condition|)
name|result
operator||=
operator|~
literal|0xffff
expr_stmt|;
return|return
operator|(
name|result
operator|)
return|;
block|}
end_block

end_unit


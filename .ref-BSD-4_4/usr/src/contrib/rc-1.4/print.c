begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/* print.c -- formatted printing routines (Paul Haahr, 12/91) */
end_comment

begin_include
include|#
directive|include
file|"rc.h"
end_include

begin_include
include|#
directive|include
file|<setjmp.h>
end_include

begin_define
define|#
directive|define
name|PRINT_ALLOCSIZE
value|((size_t)64)
end_define

begin_define
define|#
directive|define
name|SPRINT_BUFSIZ
value|((size_t)1024)
end_define

begin_define
define|#
directive|define
name|MAXCONV
value|256
end_define

begin_comment
comment|/*  * conversion functions  *	true return -> flag changes only, not a conversion  */
end_comment

begin_define
define|#
directive|define
name|Flag
parameter_list|(
name|name
parameter_list|,
name|flag
parameter_list|)
define|\
value|static bool name(Format *format, int c) { \ 	format->flags |= flag; \ 	return TRUE; \ }
end_define

begin_macro
name|Flag
argument_list|(
argument|uconv
argument_list|,
argument|FMT_unsigned
argument_list|)
end_macro

begin_macro
name|Flag
argument_list|(
argument|hconv
argument_list|,
argument|FMT_short
argument_list|)
end_macro

begin_macro
name|Flag
argument_list|(
argument|lconv
argument_list|,
argument|FMT_long
argument_list|)
end_macro

begin_macro
name|Flag
argument_list|(
argument|altconv
argument_list|,
argument|FMT_altform
argument_list|)
end_macro

begin_macro
name|Flag
argument_list|(
argument|leftconv
argument_list|,
argument|FMT_leftside
argument_list|)
end_macro

begin_macro
name|Flag
argument_list|(
argument|dotconv
argument_list|,
argument|FMT_f2set
argument_list|)
end_macro

begin_function
specifier|static
name|bool
name|digitconv
parameter_list|(
name|Format
modifier|*
name|format
parameter_list|,
name|int
name|c
parameter_list|)
block|{
if|if
condition|(
name|format
operator|->
name|flags
operator|&
name|FMT_f2set
condition|)
name|format
operator|->
name|f2
operator|=
literal|10
operator|*
name|format
operator|->
name|f2
operator|+
name|c
operator|-
literal|'0'
expr_stmt|;
else|else
block|{
name|format
operator|->
name|flags
operator||=
name|FMT_f1set
expr_stmt|;
name|format
operator|->
name|f1
operator|=
literal|10
operator|*
name|format
operator|->
name|f1
operator|+
name|c
operator|-
literal|'0'
expr_stmt|;
block|}
return|return
name|TRUE
return|;
block|}
end_function

begin_function
specifier|static
name|bool
name|zeroconv
parameter_list|(
name|Format
modifier|*
name|format
parameter_list|,
name|int
name|c
parameter_list|)
block|{
if|if
condition|(
name|format
operator|->
name|flags
operator|&
operator|(
name|FMT_f1set
operator||
name|FMT_f2set
operator|)
condition|)
return|return
name|digitconv
argument_list|(
name|format
argument_list|,
literal|'0'
argument_list|)
return|;
name|format
operator|->
name|flags
operator||=
name|FMT_zeropad
expr_stmt|;
return|return
name|TRUE
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|pad
parameter_list|(
name|Format
modifier|*
name|format
parameter_list|,
name|size_t
name|len
parameter_list|,
name|int
name|c
parameter_list|)
block|{
while|while
condition|(
name|len
operator|--
operator|!=
literal|0
condition|)
name|fmtputc
argument_list|(
name|format
argument_list|,
name|c
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|bool
name|sconv
parameter_list|(
name|Format
modifier|*
name|format
parameter_list|,
name|int
name|c
parameter_list|)
block|{
name|char
modifier|*
name|s
init|=
name|va_arg
argument_list|(
name|format
operator|->
name|args
argument_list|,
name|char
operator|*
argument_list|)
decl_stmt|;
if|if
condition|(
operator|(
name|format
operator|->
name|flags
operator|&
name|FMT_f1set
operator|)
operator|==
literal|0
condition|)
name|fmtcat
argument_list|(
name|format
argument_list|,
name|s
argument_list|)
expr_stmt|;
else|else
block|{
name|size_t
name|len
init|=
name|strlen
argument_list|(
name|s
argument_list|)
decl_stmt|,
name|width
init|=
name|format
operator|->
name|f1
operator|-
name|len
decl_stmt|;
if|if
condition|(
name|format
operator|->
name|flags
operator|&
name|FMT_leftside
condition|)
block|{
name|fmtappend
argument_list|(
name|format
argument_list|,
name|s
argument_list|,
name|len
argument_list|)
expr_stmt|;
name|pad
argument_list|(
name|format
argument_list|,
name|width
argument_list|,
literal|' '
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|pad
argument_list|(
name|format
argument_list|,
name|width
argument_list|,
literal|' '
argument_list|)
expr_stmt|;
name|fmtappend
argument_list|(
name|format
argument_list|,
name|s
argument_list|,
name|len
argument_list|)
expr_stmt|;
block|}
block|}
return|return
name|FALSE
return|;
block|}
end_function

begin_function
specifier|static
name|char
modifier|*
name|utoa
parameter_list|(
name|unsigned
name|long
name|u
parameter_list|,
name|char
modifier|*
name|t
parameter_list|,
name|unsigned
name|int
name|radix
parameter_list|,
specifier|const
name|char
modifier|*
name|digit
parameter_list|)
block|{
if|if
condition|(
name|u
operator|>=
name|radix
condition|)
block|{
name|t
operator|=
name|utoa
argument_list|(
name|u
operator|/
name|radix
argument_list|,
name|t
argument_list|,
name|radix
argument_list|,
name|digit
argument_list|)
expr_stmt|;
name|u
operator|%=
name|radix
expr_stmt|;
block|}
operator|*
name|t
operator|++
operator|=
name|digit
index|[
name|u
index|]
expr_stmt|;
return|return
name|t
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|intconv
parameter_list|(
name|Format
modifier|*
name|format
parameter_list|,
name|unsigned
name|int
name|radix
parameter_list|,
name|int
name|upper
parameter_list|,
specifier|const
name|char
modifier|*
name|altform
parameter_list|)
block|{
specifier|static
specifier|const
name|char
modifier|*
specifier|const
name|table
index|[]
init|=
block|{
literal|"0123456789abcdefghijklmnopqrstuvwxyz"
block|,
literal|"0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ"
block|, 	}
decl_stmt|;
name|char
name|padchar
decl_stmt|;
name|size_t
name|len
decl_stmt|,
name|pre
decl_stmt|,
name|zeroes
decl_stmt|,
name|padding
decl_stmt|,
name|width
decl_stmt|;
name|long
name|n
decl_stmt|,
name|flags
decl_stmt|;
name|unsigned
name|long
name|u
decl_stmt|;
name|char
name|number
index|[
literal|64
index|]
decl_stmt|,
name|prefix
index|[
literal|20
index|]
decl_stmt|;
if|if
condition|(
name|radix
operator|>
literal|36
condition|)
return|return;
name|flags
operator|=
name|format
operator|->
name|flags
expr_stmt|;
if|if
condition|(
name|flags
operator|&
name|FMT_long
condition|)
name|n
operator|=
name|va_arg
argument_list|(
name|format
operator|->
name|args
argument_list|,
name|long
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|flags
operator|&
name|FMT_short
condition|)
name|n
operator|=
name|va_arg
argument_list|(
name|format
operator|->
name|args
argument_list|,
name|short
argument_list|)
expr_stmt|;
else|else
name|n
operator|=
name|va_arg
argument_list|(
name|format
operator|->
name|args
argument_list|,
name|int
argument_list|)
expr_stmt|;
name|pre
operator|=
literal|0
expr_stmt|;
if|if
condition|(
operator|(
name|flags
operator|&
name|FMT_unsigned
operator|)
operator|||
name|n
operator|>=
literal|0
condition|)
name|u
operator|=
name|n
expr_stmt|;
else|else
block|{
name|prefix
index|[
name|pre
operator|++
index|]
operator|=
literal|'-'
expr_stmt|;
name|u
operator|=
operator|-
name|n
expr_stmt|;
block|}
if|if
condition|(
name|flags
operator|&
name|FMT_altform
condition|)
while|while
condition|(
operator|*
name|altform
operator|!=
literal|'\0'
condition|)
name|prefix
index|[
name|pre
operator|++
index|]
operator|=
operator|*
name|altform
operator|++
expr_stmt|;
name|len
operator|=
name|utoa
argument_list|(
name|u
argument_list|,
name|number
argument_list|,
name|radix
argument_list|,
name|table
index|[
name|upper
index|]
argument_list|)
operator|-
name|number
expr_stmt|;
if|if
condition|(
operator|(
name|flags
operator|&
name|FMT_f2set
operator|)
operator|&&
operator|(
name|size_t
operator|)
name|format
operator|->
name|f2
operator|>
name|len
condition|)
name|zeroes
operator|=
name|format
operator|->
name|f2
operator|-
name|len
expr_stmt|;
else|else
name|zeroes
operator|=
literal|0
expr_stmt|;
name|width
operator|=
name|pre
operator|+
name|zeroes
operator|+
name|len
expr_stmt|;
if|if
condition|(
operator|(
name|flags
operator|&
name|FMT_f1set
operator|)
operator|&&
operator|(
name|size_t
operator|)
name|format
operator|->
name|f1
operator|>
name|width
condition|)
block|{
name|padding
operator|=
name|format
operator|->
name|f1
operator|-
name|width
expr_stmt|;
block|}
else|else
name|padding
operator|=
literal|0
expr_stmt|;
name|padchar
operator|=
literal|' '
expr_stmt|;
if|if
condition|(
name|padding
operator|>
literal|0
operator|&&
name|flags
operator|&
name|FMT_zeropad
condition|)
block|{
name|padchar
operator|=
literal|'0'
expr_stmt|;
if|if
condition|(
operator|(
name|flags
operator|&
name|FMT_leftside
operator|)
operator|==
literal|0
condition|)
block|{
name|zeroes
operator|+=
name|padding
expr_stmt|;
name|padding
operator|=
literal|0
expr_stmt|;
block|}
block|}
if|if
condition|(
operator|(
name|flags
operator|&
name|FMT_leftside
operator|)
operator|==
literal|0
condition|)
name|pad
argument_list|(
name|format
argument_list|,
name|padding
argument_list|,
name|padchar
argument_list|)
expr_stmt|;
name|fmtappend
argument_list|(
name|format
argument_list|,
name|prefix
argument_list|,
name|pre
argument_list|)
expr_stmt|;
name|pad
argument_list|(
name|format
argument_list|,
name|zeroes
argument_list|,
literal|'0'
argument_list|)
expr_stmt|;
name|fmtappend
argument_list|(
name|format
argument_list|,
name|number
argument_list|,
name|len
argument_list|)
expr_stmt|;
if|if
condition|(
name|flags
operator|&
name|FMT_leftside
condition|)
name|pad
argument_list|(
name|format
argument_list|,
name|padding
argument_list|,
name|padchar
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|bool
name|cconv
parameter_list|(
name|Format
modifier|*
name|format
parameter_list|,
name|int
name|c
parameter_list|)
block|{
name|fmtputc
argument_list|(
name|format
argument_list|,
name|va_arg
argument_list|(
name|format
operator|->
name|args
argument_list|,
name|int
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|FALSE
return|;
block|}
end_function

begin_function
specifier|static
name|bool
name|dconv
parameter_list|(
name|Format
modifier|*
name|format
parameter_list|,
name|int
name|c
parameter_list|)
block|{
name|intconv
argument_list|(
name|format
argument_list|,
literal|10
argument_list|,
literal|0
argument_list|,
literal|""
argument_list|)
expr_stmt|;
return|return
name|FALSE
return|;
block|}
end_function

begin_function
specifier|static
name|bool
name|oconv
parameter_list|(
name|Format
modifier|*
name|format
parameter_list|,
name|int
name|c
parameter_list|)
block|{
name|intconv
argument_list|(
name|format
argument_list|,
literal|8
argument_list|,
literal|0
argument_list|,
literal|"0"
argument_list|)
expr_stmt|;
return|return
name|FALSE
return|;
block|}
end_function

begin_function
specifier|static
name|bool
name|xconv
parameter_list|(
name|Format
modifier|*
name|format
parameter_list|,
name|int
name|c
parameter_list|)
block|{
name|intconv
argument_list|(
name|format
argument_list|,
literal|16
argument_list|,
literal|0
argument_list|,
literal|"0x"
argument_list|)
expr_stmt|;
return|return
name|FALSE
return|;
block|}
end_function

begin_function
specifier|static
name|bool
name|pctconv
parameter_list|(
name|Format
modifier|*
name|format
parameter_list|,
name|int
name|c
parameter_list|)
block|{
name|fmtputc
argument_list|(
name|format
argument_list|,
literal|'%'
argument_list|)
expr_stmt|;
return|return
name|FALSE
return|;
block|}
end_function

begin_function
specifier|static
name|bool
name|badconv
parameter_list|(
name|Format
modifier|*
name|format
parameter_list|,
name|int
name|c
parameter_list|)
block|{
name|panic
argument_list|(
literal|"bad conversion character in printfmt"
argument_list|)
expr_stmt|;
comment|/* NOTREACHED */
return|return
name|FALSE
return|;
comment|/* hush up gcc -Wall */
block|}
end_function

begin_comment
comment|/*  * conversion table management  */
end_comment

begin_decl_stmt
specifier|static
name|Conv
name|fmttab
index|[
name|MAXCONV
index|]
decl_stmt|;
end_decl_stmt

begin_function
specifier|static
name|void
name|inittab
parameter_list|(
name|void
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|MAXCONV
condition|;
name|i
operator|++
control|)
name|fmttab
index|[
name|i
index|]
operator|=
name|badconv
expr_stmt|;
name|fmttab
index|[
literal|'s'
index|]
operator|=
name|sconv
expr_stmt|;
name|fmttab
index|[
literal|'c'
index|]
operator|=
name|cconv
expr_stmt|;
name|fmttab
index|[
literal|'d'
index|]
operator|=
name|dconv
expr_stmt|;
name|fmttab
index|[
literal|'o'
index|]
operator|=
name|oconv
expr_stmt|;
name|fmttab
index|[
literal|'x'
index|]
operator|=
name|xconv
expr_stmt|;
name|fmttab
index|[
literal|'%'
index|]
operator|=
name|pctconv
expr_stmt|;
name|fmttab
index|[
literal|'u'
index|]
operator|=
name|uconv
expr_stmt|;
name|fmttab
index|[
literal|'h'
index|]
operator|=
name|hconv
expr_stmt|;
name|fmttab
index|[
literal|'l'
index|]
operator|=
name|lconv
expr_stmt|;
name|fmttab
index|[
literal|'#'
index|]
operator|=
name|altconv
expr_stmt|;
name|fmttab
index|[
literal|'-'
index|]
operator|=
name|leftconv
expr_stmt|;
name|fmttab
index|[
literal|'.'
index|]
operator|=
name|dotconv
expr_stmt|;
name|fmttab
index|[
literal|'0'
index|]
operator|=
name|zeroconv
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|'1'
init|;
name|i
operator|<=
literal|'9'
condition|;
name|i
operator|++
control|)
name|fmttab
index|[
name|i
index|]
operator|=
name|digitconv
expr_stmt|;
block|}
end_function

begin_extern
extern|extern bool (*fmtinstall(int c
operator|,
extern|bool (*f
end_extern

begin_expr_stmt
unit|)
operator|(
name|Format
operator|*
operator|,
name|int
operator|)
end_expr_stmt

begin_expr_stmt
unit|))
operator|(
name|Format
operator|*
operator|,
name|int
operator|)
block|{
comment|/*Conv fmtinstall(int c, Conv f) {*/
name|Conv
name|oldf
block|;
if|if
condition|(
name|fmttab
index|[
literal|0
index|]
operator|==
name|NULL
condition|)
name|inittab
argument_list|()
expr_stmt|;
name|c
operator|&=
name|MAXCONV
operator|-
literal|1
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|oldf
operator|=
name|fmttab
index|[
name|c
index|]
expr_stmt|;
end_expr_stmt

begin_if
if|if
condition|(
name|f
operator|!=
name|NULL
condition|)
name|fmttab
index|[
name|c
index|]
operator|=
name|f
expr_stmt|;
end_if

begin_return
return|return
name|oldf
return|;
end_return

begin_comment
unit|}
comment|/*  * functions for inserting strings in the format buffer  */
end_comment

begin_function
unit|extern
name|void
name|fmtappend
parameter_list|(
name|Format
modifier|*
name|format
parameter_list|,
specifier|const
name|char
modifier|*
name|s
parameter_list|,
name|size_t
name|len
parameter_list|)
block|{
while|while
condition|(
name|format
operator|->
name|buf
operator|+
name|len
operator|>
name|format
operator|->
name|bufend
condition|)
block|{
name|size_t
name|split
init|=
name|format
operator|->
name|bufend
operator|-
name|format
operator|->
name|buf
decl_stmt|;
name|memcpy
argument_list|(
name|format
operator|->
name|buf
argument_list|,
name|s
argument_list|,
name|split
argument_list|)
expr_stmt|;
name|format
operator|->
name|buf
operator|+=
name|split
expr_stmt|;
name|s
operator|+=
name|split
expr_stmt|;
name|len
operator|-=
name|split
expr_stmt|;
call|(
modifier|*
name|format
operator|->
name|grow
call|)
argument_list|(
name|format
argument_list|,
name|len
argument_list|)
expr_stmt|;
block|}
name|memcpy
argument_list|(
name|format
operator|->
name|buf
argument_list|,
name|s
argument_list|,
name|len
argument_list|)
expr_stmt|;
name|format
operator|->
name|buf
operator|+=
name|len
expr_stmt|;
block|}
end_function

begin_function
specifier|extern
name|void
name|fmtcat
parameter_list|(
name|Format
modifier|*
name|format
parameter_list|,
specifier|const
name|char
modifier|*
name|s
parameter_list|)
block|{
name|fmtappend
argument_list|(
name|format
argument_list|,
name|s
argument_list|,
name|strlen
argument_list|(
name|s
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * printfmt -- the driver routine  */
end_comment

begin_function
specifier|extern
name|int
name|printfmt
parameter_list|(
name|Format
modifier|*
name|format
parameter_list|,
specifier|const
name|char
modifier|*
name|fmt
parameter_list|)
block|{
name|unsigned
specifier|const
name|char
modifier|*
name|s
init|=
operator|(
name|unsigned
specifier|const
name|char
operator|*
operator|)
name|fmt
decl_stmt|;
if|if
condition|(
name|fmttab
index|[
literal|0
index|]
operator|==
name|NULL
condition|)
name|inittab
argument_list|()
expr_stmt|;
for|for
control|(
init|;
condition|;
control|)
block|{
name|int
name|c
init|=
operator|*
name|s
operator|++
decl_stmt|;
switch|switch
condition|(
name|c
condition|)
block|{
case|case
literal|'%'
case|:
name|format
operator|->
name|flags
operator|=
name|format
operator|->
name|f1
operator|=
name|format
operator|->
name|f2
operator|=
literal|0
expr_stmt|;
do|do
name|c
operator|=
operator|*
name|s
operator|++
expr_stmt|;
do|while
condition|(
call|(
modifier|*
name|fmttab
index|[
name|c
index|]
call|)
argument_list|(
name|format
argument_list|,
name|c
argument_list|)
condition|)
do|;
break|break;
case|case
literal|'\0'
case|:
return|return
name|format
operator|->
name|buf
operator|-
name|format
operator|->
name|bufbegin
operator|+
name|format
operator|->
name|flushed
return|;
default|default:
name|fmtputc
argument_list|(
name|format
argument_list|,
name|c
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
block|}
end_function

begin_comment
comment|/*  * the public entry points  */
end_comment

begin_function
specifier|extern
name|int
name|fmtprint
parameter_list|(
name|Format
modifier|*
name|format
parameter_list|,
specifier|const
name|char
modifier|*
name|fmt
parameter_list|,
modifier|...
parameter_list|)
block|{
name|int
name|n
init|=
operator|-
name|format
operator|->
name|flushed
decl_stmt|;
name|va_list
name|saveargs
init|=
name|format
operator|->
name|args
decl_stmt|;
name|va_start
argument_list|(
name|format
operator|->
name|args
argument_list|,
name|fmt
argument_list|)
expr_stmt|;
name|n
operator|+=
name|printfmt
argument_list|(
name|format
argument_list|,
name|fmt
argument_list|)
expr_stmt|;
name|va_end
argument_list|(
name|format
operator|->
name|args
argument_list|)
expr_stmt|;
name|format
operator|->
name|args
operator|=
name|saveargs
expr_stmt|;
return|return
name|n
operator|+
name|format
operator|->
name|flushed
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|fprint_flush
parameter_list|(
name|Format
modifier|*
name|format
parameter_list|,
name|size_t
name|more
parameter_list|)
block|{
name|size_t
name|n
init|=
name|format
operator|->
name|buf
operator|-
name|format
operator|->
name|bufbegin
decl_stmt|;
name|char
modifier|*
name|buf
init|=
name|format
operator|->
name|bufbegin
decl_stmt|;
name|format
operator|->
name|flushed
operator|+=
name|n
expr_stmt|;
name|format
operator|->
name|buf
operator|=
name|format
operator|->
name|bufbegin
expr_stmt|;
name|writeall
argument_list|(
name|format
operator|->
name|u
operator|.
name|n
argument_list|,
name|buf
argument_list|,
name|n
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|extern
name|int
name|fprint
parameter_list|(
name|int
name|fd
parameter_list|,
specifier|const
name|char
modifier|*
name|fmt
parameter_list|,
modifier|...
parameter_list|)
block|{
name|char
name|buf
index|[
literal|1024
index|]
decl_stmt|;
name|Format
name|format
decl_stmt|;
name|format
operator|.
name|buf
operator|=
name|buf
expr_stmt|;
name|format
operator|.
name|bufbegin
operator|=
name|buf
expr_stmt|;
name|format
operator|.
name|bufend
operator|=
name|buf
operator|+
sizeof|sizeof
name|buf
expr_stmt|;
name|format
operator|.
name|grow
operator|=
name|fprint_flush
expr_stmt|;
name|format
operator|.
name|flushed
operator|=
literal|0
expr_stmt|;
name|format
operator|.
name|u
operator|.
name|n
operator|=
name|fd
expr_stmt|;
name|va_start
argument_list|(
name|format
operator|.
name|args
argument_list|,
name|fmt
argument_list|)
expr_stmt|;
name|printfmt
argument_list|(
operator|&
name|format
argument_list|,
name|fmt
argument_list|)
expr_stmt|;
name|va_end
argument_list|(
name|format
operator|.
name|args
argument_list|)
expr_stmt|;
name|fprint_flush
argument_list|(
operator|&
name|format
argument_list|,
operator|(
name|size_t
operator|)
literal|0
argument_list|)
expr_stmt|;
return|return
name|format
operator|.
name|flushed
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|memprint_grow
parameter_list|(
name|Format
modifier|*
name|format
parameter_list|,
name|size_t
name|more
parameter_list|)
block|{
name|char
modifier|*
name|buf
decl_stmt|;
name|size_t
name|len
init|=
name|format
operator|->
name|bufend
operator|-
name|format
operator|->
name|bufbegin
operator|+
literal|1
decl_stmt|;
name|len
operator|=
operator|(
name|len
operator|>=
name|more
operator|)
condition|?
name|len
operator|*
literal|2
else|:
operator|(
operator|(
name|len
operator|+
name|more
operator|)
operator|+
name|PRINT_ALLOCSIZE
operator|)
operator|&
operator|~
operator|(
name|PRINT_ALLOCSIZE
operator|-
literal|1
operator|)
expr_stmt|;
if|if
condition|(
name|format
operator|->
name|u
operator|.
name|n
condition|)
name|buf
operator|=
name|erealloc
argument_list|(
name|format
operator|->
name|bufbegin
argument_list|,
name|len
argument_list|)
expr_stmt|;
else|else
block|{
name|size_t
name|used
init|=
name|format
operator|->
name|buf
operator|-
name|format
operator|->
name|bufbegin
decl_stmt|;
name|buf
operator|=
name|nalloc
argument_list|(
name|len
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
name|buf
argument_list|,
name|format
operator|->
name|bufbegin
argument_list|,
name|used
argument_list|)
expr_stmt|;
block|}
name|format
operator|->
name|buf
operator|=
name|buf
operator|+
operator|(
name|format
operator|->
name|buf
operator|-
name|format
operator|->
name|bufbegin
operator|)
expr_stmt|;
name|format
operator|->
name|bufbegin
operator|=
name|buf
expr_stmt|;
name|format
operator|->
name|bufend
operator|=
name|buf
operator|+
name|len
operator|-
literal|1
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|char
modifier|*
name|memprint
parameter_list|(
name|Format
modifier|*
name|format
parameter_list|,
specifier|const
name|char
modifier|*
name|fmt
parameter_list|,
name|char
modifier|*
name|buf
parameter_list|,
name|size_t
name|len
parameter_list|)
block|{
name|format
operator|->
name|buf
operator|=
name|buf
expr_stmt|;
name|format
operator|->
name|bufbegin
operator|=
name|buf
expr_stmt|;
name|format
operator|->
name|bufend
operator|=
name|buf
operator|+
name|len
operator|-
literal|1
expr_stmt|;
name|format
operator|->
name|grow
operator|=
name|memprint_grow
expr_stmt|;
name|format
operator|->
name|flushed
operator|=
literal|0
expr_stmt|;
name|printfmt
argument_list|(
name|format
argument_list|,
name|fmt
argument_list|)
expr_stmt|;
operator|*
name|format
operator|->
name|buf
operator|=
literal|'\0'
expr_stmt|;
return|return
name|format
operator|->
name|bufbegin
return|;
block|}
end_function

begin_function
specifier|extern
name|char
modifier|*
name|mprint
parameter_list|(
specifier|const
name|char
modifier|*
name|fmt
parameter_list|,
modifier|...
parameter_list|)
block|{
name|Format
name|format
decl_stmt|;
name|char
modifier|*
name|result
decl_stmt|;
name|format
operator|.
name|u
operator|.
name|n
operator|=
literal|1
expr_stmt|;
name|va_start
argument_list|(
name|format
operator|.
name|args
argument_list|,
name|fmt
argument_list|)
expr_stmt|;
name|result
operator|=
name|memprint
argument_list|(
operator|&
name|format
argument_list|,
name|fmt
argument_list|,
name|ealloc
argument_list|(
name|PRINT_ALLOCSIZE
argument_list|)
argument_list|,
name|PRINT_ALLOCSIZE
argument_list|)
expr_stmt|;
name|va_end
argument_list|(
name|format
operator|.
name|args
argument_list|)
expr_stmt|;
return|return
name|result
return|;
block|}
end_function

begin_function
specifier|extern
name|char
modifier|*
name|nprint
parameter_list|(
specifier|const
name|char
modifier|*
name|fmt
parameter_list|,
modifier|...
parameter_list|)
block|{
name|Format
name|format
decl_stmt|;
name|char
modifier|*
name|result
decl_stmt|;
name|format
operator|.
name|u
operator|.
name|n
operator|=
literal|0
expr_stmt|;
name|va_start
argument_list|(
name|format
operator|.
name|args
argument_list|,
name|fmt
argument_list|)
expr_stmt|;
name|result
operator|=
name|memprint
argument_list|(
operator|&
name|format
argument_list|,
name|fmt
argument_list|,
name|nalloc
argument_list|(
name|PRINT_ALLOCSIZE
argument_list|)
argument_list|,
name|PRINT_ALLOCSIZE
argument_list|)
expr_stmt|;
name|va_end
argument_list|(
name|format
operator|.
name|args
argument_list|)
expr_stmt|;
return|return
name|result
return|;
block|}
end_function

end_unit


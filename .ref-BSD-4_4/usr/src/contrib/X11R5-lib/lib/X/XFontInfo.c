begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/* $XConsortium: XFontInfo.c,v 11.21 91/01/29 08:40:25 rws Exp $ */
end_comment

begin_comment
comment|/* Copyright    Massachusetts Institute of Technology    1986	*/
end_comment

begin_comment
comment|/* Permission to use, copy, modify, distribute, and sell this software and its documentation for any purpose is hereby granted without fee, provided that the above copyright notice appear in all copies and that both that copyright notice and this permission notice appear in supporting documentation, and that the name of M.I.T. not be used in advertising or publicity pertaining to distribution of the software without specific, written prior permission.  M.I.T. makes no representations about the suitability of this software for any purpose.  It is provided "as is" without express or implied warranty. */
end_comment

begin_define
define|#
directive|define
name|NEED_REPLIES
end_define

begin_include
include|#
directive|include
file|"Xlibint.h"
end_include

begin_if
if|#
directive|if
name|NeedFunctionPrototypes
end_if

begin_decl_stmt
name|char
modifier|*
modifier|*
name|XListFontsWithInfo
argument_list|(
specifier|register
name|Display
operator|*
name|dpy
argument_list|,
name|_Xconst
name|char
operator|*
name|pattern
argument_list|,
comment|/* null-terminated */
name|int
name|maxNames
argument_list|,
name|int
operator|*
name|actualCount
argument_list|,
comment|/* RETURN */
name|XFontStruct
operator|*
operator|*
name|info
argument_list|)
comment|/* RETURN */
else|#
directive|else
name|char
modifier|*
modifier|*
name|XListFontsWithInfo
argument_list|(
name|dpy
argument_list|,
name|pattern
argument_list|,
name|maxNames
argument_list|,
name|actualCount
argument_list|,
name|info
argument_list|)
decl|register
name|Display
modifier|*
name|dpy
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|char
modifier|*
name|pattern
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* null-terminated */
end_comment

begin_decl_stmt
name|int
name|maxNames
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
modifier|*
name|actualCount
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* RETURN */
end_comment

begin_decl_stmt
name|XFontStruct
modifier|*
modifier|*
name|info
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* RETURN */
end_comment

begin_endif
endif|#
directive|endif
end_endif

begin_block
block|{
specifier|register
name|long
name|nbytes
decl_stmt|;
specifier|register
name|int
name|i
decl_stmt|;
specifier|register
name|XFontStruct
modifier|*
name|fs
decl_stmt|;
specifier|register
name|int
name|size
init|=
literal|0
decl_stmt|;
name|XFontStruct
modifier|*
name|finfo
init|=
name|NULL
decl_stmt|;
name|char
modifier|*
modifier|*
name|flist
init|=
name|NULL
decl_stmt|;
name|xListFontsWithInfoReply
name|reply
decl_stmt|;
specifier|register
name|xListFontsReq
modifier|*
name|req
decl_stmt|;
name|int
name|j
decl_stmt|;
name|LockDisplay
argument_list|(
name|dpy
argument_list|)
expr_stmt|;
name|GetReq
argument_list|(
name|ListFontsWithInfo
argument_list|,
name|req
argument_list|)
expr_stmt|;
name|req
operator|->
name|maxNames
operator|=
name|maxNames
expr_stmt|;
name|nbytes
operator|=
name|req
operator|->
name|nbytes
operator|=
name|pattern
condition|?
name|strlen
argument_list|(
name|pattern
argument_list|)
else|:
literal|0
expr_stmt|;
name|req
operator|->
name|length
operator|+=
operator|(
name|nbytes
operator|+
literal|3
operator|)
operator|>>
literal|2
expr_stmt|;
name|_XSend
argument_list|(
name|dpy
argument_list|,
name|pattern
argument_list|,
name|nbytes
argument_list|)
expr_stmt|;
comment|/* use _XSend instead of Data, since subsequent _XReply will flush buffer */
for|for
control|(
name|i
operator|=
literal|0
init|;
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
operator|!
name|_XReply
argument_list|(
name|dpy
argument_list|,
operator|(
name|xReply
operator|*
operator|)
operator|&
name|reply
argument_list|,
operator|(
operator|(
name|SIZEOF
argument_list|(
name|xListFontsWithInfoReply
argument_list|)
operator|-
name|SIZEOF
argument_list|(
name|xGenericReply
argument_list|)
operator|)
operator|>>
literal|2
operator|)
argument_list|,
name|xFalse
argument_list|)
condition|)
block|{
for|for
control|(
name|j
operator|=
operator|(
name|i
operator|-
literal|1
operator|)
init|;
operator|(
name|j
operator|>=
literal|0
operator|)
condition|;
name|j
operator|--
control|)
block|{
name|Xfree
argument_list|(
name|flist
index|[
name|j
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|finfo
index|[
name|j
index|]
operator|.
name|properties
condition|)
name|Xfree
argument_list|(
operator|(
name|char
operator|*
operator|)
name|finfo
index|[
name|j
index|]
operator|.
name|properties
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|flist
condition|)
name|Xfree
argument_list|(
operator|(
name|char
operator|*
operator|)
name|flist
argument_list|)
expr_stmt|;
if|if
condition|(
name|finfo
condition|)
name|Xfree
argument_list|(
operator|(
name|char
operator|*
operator|)
name|finfo
argument_list|)
expr_stmt|;
name|UnlockDisplay
argument_list|(
name|dpy
argument_list|)
expr_stmt|;
name|SyncHandle
argument_list|()
expr_stmt|;
return|return
operator|(
operator|(
name|char
operator|*
operator|*
operator|)
name|NULL
operator|)
return|;
block|}
if|if
condition|(
name|reply
operator|.
name|nameLength
operator|==
literal|0
condition|)
break|break;
if|if
condition|(
operator|(
name|i
operator|+
name|reply
operator|.
name|nReplies
operator|)
operator|>=
name|size
condition|)
block|{
name|size
operator|=
name|i
operator|+
name|reply
operator|.
name|nReplies
operator|+
literal|1
expr_stmt|;
if|if
condition|(
name|finfo
condition|)
block|{
name|XFontStruct
modifier|*
name|tmp_finfo
init|=
operator|(
name|XFontStruct
operator|*
operator|)
name|Xrealloc
argument_list|(
operator|(
name|char
operator|*
operator|)
name|finfo
argument_list|,
call|(
name|unsigned
call|)
argument_list|(
sizeof|sizeof
argument_list|(
name|XFontStruct
argument_list|)
operator|*
name|size
argument_list|)
argument_list|)
decl_stmt|;
name|char
modifier|*
modifier|*
name|tmp_flist
init|=
operator|(
name|char
operator|*
operator|*
operator|)
name|Xrealloc
argument_list|(
operator|(
name|char
operator|*
operator|)
name|flist
argument_list|,
call|(
name|unsigned
call|)
argument_list|(
sizeof|sizeof
argument_list|(
name|char
operator|*
argument_list|)
operator|*
operator|(
name|size
operator|+
literal|1
operator|)
argument_list|)
argument_list|)
decl_stmt|;
if|if
condition|(
operator|(
operator|!
name|tmp_finfo
operator|)
operator|||
operator|(
operator|!
name|tmp_flist
operator|)
condition|)
block|{
comment|/* free all the memory that we allocated */
for|for
control|(
name|j
operator|=
operator|(
name|i
operator|-
literal|1
operator|)
init|;
operator|(
name|j
operator|>=
literal|0
operator|)
condition|;
name|j
operator|--
control|)
block|{
name|Xfree
argument_list|(
name|flist
index|[
name|j
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|finfo
index|[
name|j
index|]
operator|.
name|properties
condition|)
name|Xfree
argument_list|(
operator|(
name|char
operator|*
operator|)
name|finfo
index|[
name|j
index|]
operator|.
name|properties
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|tmp_flist
condition|)
name|Xfree
argument_list|(
operator|(
name|char
operator|*
operator|)
name|tmp_flist
argument_list|)
expr_stmt|;
else|else
name|Xfree
argument_list|(
operator|(
name|char
operator|*
operator|)
name|flist
argument_list|)
expr_stmt|;
if|if
condition|(
name|tmp_finfo
condition|)
name|Xfree
argument_list|(
operator|(
name|char
operator|*
operator|)
name|tmp_finfo
argument_list|)
expr_stmt|;
else|else
name|Xfree
argument_list|(
operator|(
name|char
operator|*
operator|)
name|finfo
argument_list|)
expr_stmt|;
goto|goto
name|clearwire
goto|;
block|}
name|finfo
operator|=
name|tmp_finfo
expr_stmt|;
name|flist
operator|=
name|tmp_flist
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
operator|!
operator|(
name|finfo
operator|=
operator|(
name|XFontStruct
operator|*
operator|)
name|Xmalloc
argument_list|(
call|(
name|unsigned
call|)
argument_list|(
sizeof|sizeof
argument_list|(
name|XFontStruct
argument_list|)
operator|*
name|size
argument_list|)
argument_list|)
operator|)
condition|)
goto|goto
name|clearwire
goto|;
if|if
condition|(
operator|!
operator|(
name|flist
operator|=
operator|(
name|char
operator|*
operator|*
operator|)
name|Xmalloc
argument_list|(
call|(
name|unsigned
call|)
argument_list|(
sizeof|sizeof
argument_list|(
name|char
operator|*
argument_list|)
operator|*
operator|(
name|size
operator|+
literal|1
operator|)
argument_list|)
argument_list|)
operator|)
condition|)
block|{
name|Xfree
argument_list|(
operator|(
name|char
operator|*
operator|)
name|finfo
argument_list|)
expr_stmt|;
goto|goto
name|clearwire
goto|;
block|}
block|}
block|}
name|fs
operator|=
operator|&
name|finfo
index|[
name|i
index|]
expr_stmt|;
name|fs
operator|->
name|ext_data
operator|=
name|NULL
expr_stmt|;
name|fs
operator|->
name|per_char
operator|=
name|NULL
expr_stmt|;
name|fs
operator|->
name|fid
operator|=
name|None
expr_stmt|;
name|fs
operator|->
name|direction
operator|=
name|reply
operator|.
name|drawDirection
expr_stmt|;
name|fs
operator|->
name|min_char_or_byte2
operator|=
name|reply
operator|.
name|minCharOrByte2
expr_stmt|;
name|fs
operator|->
name|max_char_or_byte2
operator|=
name|reply
operator|.
name|maxCharOrByte2
expr_stmt|;
name|fs
operator|->
name|min_byte1
operator|=
name|reply
operator|.
name|minByte1
expr_stmt|;
name|fs
operator|->
name|max_byte1
operator|=
name|reply
operator|.
name|maxByte1
expr_stmt|;
name|fs
operator|->
name|default_char
operator|=
name|reply
operator|.
name|defaultChar
expr_stmt|;
name|fs
operator|->
name|all_chars_exist
operator|=
name|reply
operator|.
name|allCharsExist
expr_stmt|;
name|fs
operator|->
name|ascent
operator|=
name|cvtINT16toInt
argument_list|(
name|reply
operator|.
name|fontAscent
argument_list|)
expr_stmt|;
name|fs
operator|->
name|descent
operator|=
name|cvtINT16toInt
argument_list|(
name|reply
operator|.
name|fontDescent
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|MUSTCOPY
block|{
name|xCharInfo
modifier|*
name|xcip
decl_stmt|;
name|xcip
operator|=
operator|(
name|xCharInfo
operator|*
operator|)
operator|&
name|reply
operator|.
name|minBounds
expr_stmt|;
name|fs
operator|->
name|min_bounds
operator|.
name|lbearing
operator|=
name|xcip
operator|->
name|leftSideBearing
expr_stmt|;
name|fs
operator|->
name|min_bounds
operator|.
name|rbearing
operator|=
name|xcip
operator|->
name|rightSideBearing
expr_stmt|;
name|fs
operator|->
name|min_bounds
operator|.
name|width
operator|=
name|xcip
operator|->
name|characterWidth
expr_stmt|;
name|fs
operator|->
name|min_bounds
operator|.
name|ascent
operator|=
name|xcip
operator|->
name|ascent
expr_stmt|;
name|fs
operator|->
name|min_bounds
operator|.
name|descent
operator|=
name|xcip
operator|->
name|descent
expr_stmt|;
name|fs
operator|->
name|min_bounds
operator|.
name|attributes
operator|=
name|xcip
operator|->
name|attributes
expr_stmt|;
name|xcip
operator|=
operator|(
name|xCharInfo
operator|*
operator|)
operator|&
name|reply
operator|.
name|maxBounds
expr_stmt|;
name|fs
operator|->
name|max_bounds
operator|.
name|lbearing
operator|=
name|xcip
operator|->
name|leftSideBearing
expr_stmt|;
name|fs
operator|->
name|max_bounds
operator|.
name|rbearing
operator|=
name|xcip
operator|->
name|rightSideBearing
expr_stmt|;
name|fs
operator|->
name|max_bounds
operator|.
name|width
operator|=
name|xcip
operator|->
name|characterWidth
expr_stmt|;
name|fs
operator|->
name|max_bounds
operator|.
name|ascent
operator|=
name|xcip
operator|->
name|ascent
expr_stmt|;
name|fs
operator|->
name|max_bounds
operator|.
name|descent
operator|=
name|xcip
operator|->
name|descent
expr_stmt|;
name|fs
operator|->
name|max_bounds
operator|.
name|attributes
operator|=
name|xcip
operator|->
name|attributes
expr_stmt|;
block|}
else|#
directive|else
comment|/* XXX the next two statements won't work if short isn't 16 bits */
name|fs
operator|->
name|min_bounds
operator|=
operator|*
operator|(
name|XCharStruct
operator|*
operator|)
operator|&
name|reply
operator|.
name|minBounds
expr_stmt|;
name|fs
operator|->
name|max_bounds
operator|=
operator|*
operator|(
name|XCharStruct
operator|*
operator|)
operator|&
name|reply
operator|.
name|maxBounds
expr_stmt|;
endif|#
directive|endif
comment|/* MUSTCOPY */
name|fs
operator|->
name|n_properties
operator|=
name|reply
operator|.
name|nFontProps
expr_stmt|;
if|if
condition|(
name|fs
operator|->
name|n_properties
operator|>
literal|0
condition|)
block|{
name|nbytes
operator|=
name|reply
operator|.
name|nFontProps
operator|*
sizeof|sizeof
argument_list|(
name|XFontProp
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|fs
operator|->
name|properties
operator|=
operator|(
name|XFontProp
operator|*
operator|)
name|Xmalloc
argument_list|(
operator|(
name|unsigned
operator|)
name|nbytes
argument_list|)
operator|)
condition|)
goto|goto
name|badmem
goto|;
name|nbytes
operator|=
name|reply
operator|.
name|nFontProps
operator|*
name|SIZEOF
argument_list|(
name|xFontProp
argument_list|)
expr_stmt|;
name|_XRead32
argument_list|(
name|dpy
argument_list|,
operator|(
name|char
operator|*
operator|)
name|fs
operator|->
name|properties
argument_list|,
name|nbytes
argument_list|)
expr_stmt|;
block|}
else|else
name|fs
operator|->
name|properties
operator|=
name|NULL
expr_stmt|;
name|j
operator|=
name|reply
operator|.
name|nameLength
operator|+
literal|1
expr_stmt|;
if|if
condition|(
operator|!
name|i
condition|)
name|j
operator|++
expr_stmt|;
comment|/* make first string 1 byte longer, to match XListFonts */
name|flist
index|[
name|i
index|]
operator|=
operator|(
name|char
operator|*
operator|)
name|Xmalloc
argument_list|(
operator|(
name|unsigned
name|int
operator|)
name|j
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|flist
index|[
name|i
index|]
condition|)
block|{
if|if
condition|(
name|finfo
index|[
name|i
index|]
operator|.
name|properties
condition|)
name|Xfree
argument_list|(
operator|(
name|char
operator|*
operator|)
name|finfo
index|[
name|i
index|]
operator|.
name|properties
argument_list|)
expr_stmt|;
name|nbytes
operator|=
name|reply
operator|.
name|nameLength
operator|+
literal|3
operator|&
operator|~
literal|3
expr_stmt|;
name|_XEatData
argument_list|(
name|dpy
argument_list|,
operator|(
name|unsigned
name|long
operator|)
name|nbytes
argument_list|)
expr_stmt|;
goto|goto
name|badmem
goto|;
block|}
if|if
condition|(
operator|!
name|i
condition|)
block|{
operator|*
name|flist
index|[
literal|0
index|]
operator|=
literal|0
expr_stmt|;
comment|/* zero to distinguish from XListFonts */
name|flist
index|[
literal|0
index|]
operator|++
expr_stmt|;
block|}
name|flist
index|[
name|i
index|]
index|[
name|reply
operator|.
name|nameLength
index|]
operator|=
literal|'\0'
expr_stmt|;
name|_XReadPad
argument_list|(
name|dpy
argument_list|,
name|flist
index|[
name|i
index|]
argument_list|,
operator|(
name|long
operator|)
name|reply
operator|.
name|nameLength
argument_list|)
expr_stmt|;
block|}
operator|*
name|info
operator|=
name|finfo
expr_stmt|;
operator|*
name|actualCount
operator|=
name|i
expr_stmt|;
if|if
condition|(
name|flist
condition|)
name|flist
index|[
name|i
index|]
operator|=
name|NULL
expr_stmt|;
comment|/* required in case XFreeFontNames is called */
name|UnlockDisplay
argument_list|(
name|dpy
argument_list|)
expr_stmt|;
name|SyncHandle
argument_list|()
expr_stmt|;
return|return
operator|(
name|flist
operator|)
return|;
name|badmem
label|:
comment|/* Free all memory allocated by this function. */
for|for
control|(
name|j
operator|=
operator|(
name|i
operator|-
literal|1
operator|)
init|;
operator|(
name|j
operator|>=
literal|0
operator|)
condition|;
name|j
operator|--
control|)
block|{
name|Xfree
argument_list|(
name|flist
index|[
name|j
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|finfo
index|[
name|j
index|]
operator|.
name|properties
condition|)
name|Xfree
argument_list|(
operator|(
name|char
operator|*
operator|)
name|finfo
index|[
name|j
index|]
operator|.
name|properties
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|flist
condition|)
name|Xfree
argument_list|(
operator|(
name|char
operator|*
operator|)
name|flist
argument_list|)
expr_stmt|;
if|if
condition|(
name|finfo
condition|)
name|Xfree
argument_list|(
operator|(
name|char
operator|*
operator|)
name|finfo
argument_list|)
expr_stmt|;
name|clearwire
label|:
comment|/* Clear the wire. */
do|do
block|{
if|if
condition|(
name|reply
operator|.
name|nFontProps
condition|)
name|_XEatData
argument_list|(
name|dpy
argument_list|,
call|(
name|unsigned
name|long
call|)
argument_list|(
name|reply
operator|.
name|nFontProps
operator|*
name|SIZEOF
argument_list|(
name|xFontProp
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
name|nbytes
operator|=
operator|(
name|reply
operator|.
name|nameLength
operator|+
literal|3
operator|)
operator|&
operator|~
literal|3
expr_stmt|;
name|_XEatData
argument_list|(
name|dpy
argument_list|,
operator|(
name|unsigned
name|long
operator|)
name|nbytes
argument_list|)
expr_stmt|;
block|}
do|while
condition|(
name|_XReply
argument_list|(
name|dpy
argument_list|,
operator|(
name|xReply
operator|*
operator|)
operator|&
name|reply
argument_list|,
operator|(
operator|(
name|SIZEOF
argument_list|(
name|xListFontsWithInfoReply
argument_list|)
operator|-
name|SIZEOF
argument_list|(
name|xGenericReply
argument_list|)
operator|)
operator|>>
literal|2
operator|)
argument_list|,
name|xFalse
argument_list|)
operator|&&
operator|(
name|reply
operator|.
name|nameLength
operator|!=
literal|0
operator|)
condition|)
do|;
name|UnlockDisplay
argument_list|(
name|dpy
argument_list|)
expr_stmt|;
name|SyncHandle
argument_list|()
expr_stmt|;
return|return
operator|(
name|char
operator|*
operator|*
operator|)
name|NULL
return|;
block|}
end_block

begin_macro
name|XFreeFontInfo
argument_list|(
argument|names
argument_list|,
argument|info
argument_list|,
argument|actualCount
argument_list|)
end_macro

begin_decl_stmt
name|char
modifier|*
modifier|*
name|names
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|XFontStruct
modifier|*
name|info
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|actualCount
decl_stmt|;
end_decl_stmt

begin_block
block|{
specifier|register
name|int
name|i
decl_stmt|;
if|if
condition|(
name|names
condition|)
block|{
name|Xfree
argument_list|(
name|names
index|[
literal|0
index|]
operator|-
literal|1
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|1
init|;
name|i
operator|<
name|actualCount
condition|;
name|i
operator|++
control|)
block|{
name|Xfree
argument_list|(
name|names
index|[
name|i
index|]
argument_list|)
expr_stmt|;
block|}
name|Xfree
argument_list|(
operator|(
name|char
operator|*
operator|)
name|names
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|info
condition|)
block|{
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|actualCount
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|info
index|[
name|i
index|]
operator|.
name|per_char
condition|)
name|Xfree
argument_list|(
operator|(
name|char
operator|*
operator|)
name|info
index|[
name|i
index|]
operator|.
name|per_char
argument_list|)
expr_stmt|;
if|if
condition|(
name|info
index|[
name|i
index|]
operator|.
name|properties
condition|)
name|Xfree
argument_list|(
operator|(
name|char
operator|*
operator|)
name|info
index|[
name|i
index|]
operator|.
name|properties
argument_list|)
expr_stmt|;
block|}
name|Xfree
argument_list|(
operator|(
name|char
operator|*
operator|)
name|info
argument_list|)
expr_stmt|;
block|}
block|}
end_block

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/* $XConsortium: XWrBitF.c,v 1.9 91/02/01 16:34:58 gildea Exp $ */
end_comment

begin_comment
comment|/* Copyright, 1987, Massachusetts Institute of Technology */
end_comment

begin_comment
comment|/* Permission to use, copy, modify, distribute, and sell this software and its documentation for any purpose is hereby granted without fee, provided that the above copyright notice appear in all copies and that both that copyright notice and this permission notice appear in supporting documentation, and that the name of M.I.T. not be used in advertising or publicity pertaining to distribution of the software without specific, written prior permission.  M.I.T. makes no representations about the suitability of this software for any purpose.  It is provided "as is" without express or implied warranty. */
end_comment

begin_include
include|#
directive|include
file|"Xlibint.h"
end_include

begin_include
include|#
directive|include
file|<X11/Xos.h>
end_include

begin_include
include|#
directive|include
file|"Xutil.h"
end_include

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_define
define|#
directive|define
name|ERR_RETURN
value|0
end_define

begin_function
specifier|static
name|char
modifier|*
name|Format_Image
parameter_list|(
name|image
parameter_list|,
name|resultsize
parameter_list|)
name|XImage
modifier|*
name|image
decl_stmt|;
name|int
modifier|*
name|resultsize
decl_stmt|;
block|{
specifier|register
name|int
name|x
decl_stmt|,
name|c
decl_stmt|,
name|b
decl_stmt|;
specifier|register
name|char
modifier|*
name|ptr
decl_stmt|;
name|int
name|y
decl_stmt|;
name|char
modifier|*
name|data
decl_stmt|;
name|int
name|width
decl_stmt|,
name|height
decl_stmt|;
name|int
name|bytes_per_line
decl_stmt|;
name|width
operator|=
name|image
operator|->
name|width
expr_stmt|;
name|height
operator|=
name|image
operator|->
name|height
expr_stmt|;
name|bytes_per_line
operator|=
operator|(
name|width
operator|+
literal|7
operator|)
operator|/
literal|8
expr_stmt|;
operator|*
name|resultsize
operator|=
name|bytes_per_line
operator|*
name|height
expr_stmt|;
comment|/* Calculate size of data */
name|data
operator|=
operator|(
name|char
operator|*
operator|)
name|Xmalloc
argument_list|(
operator|*
name|resultsize
argument_list|)
expr_stmt|;
comment|/* Get space for data */
if|if
condition|(
operator|!
name|data
condition|)
return|return
operator|(
name|ERR_RETURN
operator|)
return|;
comment|/*    * The slow but robust brute force method of converting the image:    */
name|ptr
operator|=
name|data
expr_stmt|;
name|c
operator|=
literal|0
expr_stmt|;
name|b
operator|=
literal|1
expr_stmt|;
for|for
control|(
name|y
operator|=
literal|0
init|;
name|y
operator|<
name|height
condition|;
name|y
operator|++
control|)
block|{
for|for
control|(
name|x
operator|=
literal|0
init|;
name|x
operator|<
name|width
condition|;
control|)
block|{
if|if
condition|(
name|XGetPixel
argument_list|(
name|image
argument_list|,
name|x
argument_list|,
name|y
argument_list|)
condition|)
name|c
operator||=
name|b
expr_stmt|;
name|b
operator|<<=
literal|1
expr_stmt|;
if|if
condition|(
operator|!
operator|(
operator|++
name|x
operator|&
literal|7
operator|)
condition|)
block|{
operator|*
operator|(
name|ptr
operator|++
operator|)
operator|=
name|c
expr_stmt|;
name|c
operator|=
literal|0
expr_stmt|;
name|b
operator|=
literal|1
expr_stmt|;
block|}
block|}
if|if
condition|(
name|x
operator|&
literal|7
condition|)
block|{
operator|*
operator|(
name|ptr
operator|++
operator|)
operator|=
name|c
expr_stmt|;
name|c
operator|=
literal|0
expr_stmt|;
name|b
operator|=
literal|1
expr_stmt|;
block|}
block|}
return|return
operator|(
name|data
operator|)
return|;
block|}
end_function

begin_define
define|#
directive|define
name|BYTES_PER_OUTPUT_LINE
value|12
end_define

begin_if
if|#
directive|if
name|NeedFunctionPrototypes
end_if

begin_function
name|int
name|XWriteBitmapFile
parameter_list|(
name|Display
modifier|*
name|display
parameter_list|,
name|_Xconst
name|char
modifier|*
name|filename
parameter_list|,
name|Pixmap
name|bitmap
parameter_list|,
name|unsigned
name|int
name|width
parameter_list|,
name|unsigned
name|int
name|height
parameter_list|,
name|int
name|x_hot
parameter_list|,
name|int
name|y_hot
parameter_list|)
else|#
directive|else
function|int XWriteBitmapFile
parameter_list|(
name|display
parameter_list|,
name|filename
parameter_list|,
name|bitmap
parameter_list|,
name|width
parameter_list|,
name|height
parameter_list|,
name|x_hot
parameter_list|,
name|y_hot
parameter_list|)
name|Display
modifier|*
name|display
decl_stmt|;
name|char
modifier|*
name|filename
decl_stmt|;
name|Pixmap
name|bitmap
decl_stmt|;
name|unsigned
name|int
name|width
decl_stmt|,
name|height
decl_stmt|;
name|int
name|x_hot
decl_stmt|,
name|y_hot
decl_stmt|;
endif|#
directive|endif
block|{
name|char
modifier|*
name|data
decl_stmt|,
modifier|*
name|ptr
decl_stmt|;
name|int
name|size
decl_stmt|,
name|byte
decl_stmt|;
name|int
name|c
decl_stmt|;
name|XImage
modifier|*
name|image
decl_stmt|;
name|FILE
modifier|*
name|stream
decl_stmt|;
name|char
modifier|*
name|name
decl_stmt|;
if|if
condition|(
operator|!
operator|(
name|name
operator|=
name|rindex
argument_list|(
name|filename
argument_list|,
literal|'/'
argument_list|)
operator|)
condition|)
name|name
operator|=
operator|(
name|char
operator|*
operator|)
name|filename
expr_stmt|;
else|else
name|name
operator|++
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|stream
operator|=
name|fopen
argument_list|(
name|filename
argument_list|,
literal|"w"
argument_list|)
operator|)
condition|)
return|return
operator|(
name|BitmapOpenFailed
operator|)
return|;
comment|/* Convert bitmap to an image */
name|image
operator|=
name|XGetImage
argument_list|(
name|display
argument_list|,
name|bitmap
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
name|width
argument_list|,
name|height
argument_list|,
literal|1L
argument_list|,
name|XYPixmap
argument_list|)
expr_stmt|;
comment|/* Get standard format for data */
name|data
operator|=
name|Format_Image
argument_list|(
name|image
argument_list|,
operator|&
name|size
argument_list|)
expr_stmt|;
name|XDestroyImage
argument_list|(
name|image
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|data
condition|)
block|{
name|fclose
argument_list|(
name|stream
argument_list|)
expr_stmt|;
return|return
operator|(
name|BitmapNoMemory
operator|)
return|;
block|}
comment|/* Write out standard header */
name|fprintf
argument_list|(
name|stream
argument_list|,
literal|"#define %s_width %d\n"
argument_list|,
name|name
argument_list|,
name|width
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stream
argument_list|,
literal|"#define %s_height %d\n"
argument_list|,
name|name
argument_list|,
name|height
argument_list|)
expr_stmt|;
if|if
condition|(
name|x_hot
operator|!=
operator|-
literal|1
condition|)
block|{
name|fprintf
argument_list|(
name|stream
argument_list|,
literal|"#define %s_x_hot %d\n"
argument_list|,
name|name
argument_list|,
name|x_hot
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stream
argument_list|,
literal|"#define %s_y_hot %d\n"
argument_list|,
name|name
argument_list|,
name|y_hot
argument_list|)
expr_stmt|;
block|}
comment|/* Print out the data itself */
name|fprintf
argument_list|(
name|stream
argument_list|,
literal|"static char %s_bits[] = {"
argument_list|,
name|name
argument_list|)
expr_stmt|;
for|for
control|(
name|byte
operator|=
literal|0
operator|,
name|ptr
operator|=
name|data
init|;
name|byte
operator|<
name|size
condition|;
name|byte
operator|++
operator|,
name|ptr
operator|++
control|)
block|{
if|if
condition|(
operator|!
name|byte
condition|)
name|fprintf
argument_list|(
name|stream
argument_list|,
literal|"\n   "
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
operator|!
operator|(
name|byte
operator|%
name|BYTES_PER_OUTPUT_LINE
operator|)
condition|)
name|fprintf
argument_list|(
name|stream
argument_list|,
literal|",\n   "
argument_list|)
expr_stmt|;
else|else
name|fprintf
argument_list|(
name|stream
argument_list|,
literal|", "
argument_list|)
expr_stmt|;
name|c
operator|=
operator|*
name|ptr
expr_stmt|;
if|if
condition|(
name|c
operator|<
literal|0
condition|)
name|c
operator|+=
literal|256
expr_stmt|;
name|fprintf
argument_list|(
name|stream
argument_list|,
literal|"0x%02x"
argument_list|,
name|c
argument_list|)
expr_stmt|;
block|}
name|fprintf
argument_list|(
name|stream
argument_list|,
literal|"};\n"
argument_list|)
expr_stmt|;
name|Xfree
argument_list|(
name|data
argument_list|)
expr_stmt|;
name|fclose
argument_list|(
name|stream
argument_list|)
expr_stmt|;
return|return
operator|(
name|BitmapSuccess
operator|)
return|;
block|}
end_function

end_unit


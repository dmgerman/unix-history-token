begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * $XConsortium: XOpenIM.c,v 1.19 92/07/28 17:52:13 rws Exp $  */
end_comment

begin_comment
comment|/*  * Copyright 1990, 1991 by OMRON Corporation  * Copyright 1991 by the Massachusetts Institute of Technology  *  * Permission to use, copy, modify, distribute, and sell this software and its  * documentation for any purpose is hereby granted without fee, provided that  * the above copyright notice appear in all copies and that both that  * copyright notice and this permission notice appear in supporting  * documentation, and that the names of OMRON and MIT not be used in  * advertising or publicity pertaining to distribution of the software without  * specific, written prior permission.  OMRON and MIT make no representations  * about the suitability of this software for any purpose.  It is provided  * "as is" without express or implied warranty.  *  * OMRON AND MIT DISCLAIM ALL WARRANTIES WITH REGARD TO THIS SOFTWARE,  * INCLUDING ALL IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS, IN NO  * EVENT SHALL OMRON OR MIT BE LIABLE FOR ANY SPECIAL, INDIRECT OR  * CONSEQUENTIAL DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM LOSS OF USE,  * DATA OR PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE OR OTHER  * TORTUOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR  * PERFORMANCE OF THIS SOFTWARE.   *  *	Author:	Seiji Kuwari	OMRON Corporation  *				kuwa@omron.co.jp  *				kuwa%omron.co.jp@uunet.uu.net  */
end_comment

begin_include
include|#
directive|include
file|"Xlibint.h"
end_include

begin_include
include|#
directive|include
file|"Xi18nint.h"
end_include

begin_include
include|#
directive|include
file|"XIMlibint.h"
end_include

begin_include
include|#
directive|include
file|<X11/Xos.h>
end_include

begin_include
include|#
directive|include
file|<pwd.h>
end_include

begin_ifdef
ifdef|#
directive|ifdef
name|X_NOT_STDC_ENV
end_ifdef

begin_function_decl
specifier|extern
name|char
modifier|*
name|getenv
parameter_list|()
function_decl|;
end_function_decl

begin_endif
endif|#
directive|endif
end_endif

begin_ifdef
ifdef|#
directive|ifdef
name|X_NOT_POSIX
end_ifdef

begin_function_decl
specifier|extern
name|int
name|getuid
parameter_list|()
function_decl|;
end_function_decl

begin_endif
endif|#
directive|endif
end_endif

begin_if
if|#
directive|if
name|__STDC__
operator|&&
operator|!
name|defined
argument_list|(
name|NORCONST
argument_list|)
end_if

begin_define
define|#
directive|define
name|RConst
value|const
end_define

begin_else
else|#
directive|else
end_else

begin_define
define|#
directive|define
name|RConst
end_define

begin_comment
comment|/**/
end_comment

begin_endif
endif|#
directive|endif
end_endif

begin_define
define|#
directive|define
name|offset
parameter_list|(
name|field
parameter_list|)
value|XOffsetOf(XipIMRec, field)
end_define

begin_decl_stmt
specifier|static
name|int
name|compiled_resources
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|XIMResource
name|im_resources
index|[]
init|=
block|{
block|{
name|XNQueryInputStyle
block|,
sizeof|sizeof
argument_list|(
name|XIMStyles
operator|*
argument_list|)
block|,
name|offset
argument_list|(
name|values
operator|.
name|input_styles
argument_list|)
block|,
operator|(
name|unsigned
name|short
operator|)
name|IMResourceRead
block|,
operator|(
name|int
operator|)
name|IMQueryInputStyle
block|}
block|,
ifdef|#
directive|ifdef
name|XML
block|{
name|XNQueryLanguage
block|,
sizeof|sizeof
argument_list|(
name|char
operator|*
argument_list|)
block|,
name|offset
argument_list|(
name|values
operator|.
name|supported_language
argument_list|)
block|,
operator|(
name|unsigned
name|short
operator|)
name|IMResourceRead
block|,
operator|(
name|int
operator|)
name|IMQueryLanguage
block|}
endif|#
directive|endif
comment|/* XML */
block|}
decl_stmt|;
end_decl_stmt

begin_undef
undef|#
directive|undef
name|offset
end_undef

begin_define
define|#
directive|define
name|offset
parameter_list|(
name|field
parameter_list|)
value|XOffsetOf(XipICRec, field)
end_define

begin_decl_stmt
specifier|static
name|XIMResource
name|ic_resources
index|[]
init|=
block|{
block|{
name|XNInputStyle
block|,
sizeof|sizeof
argument_list|(
name|XIMStyle
argument_list|)
block|,
name|offset
argument_list|(
name|core
operator|.
name|input_style
argument_list|)
block|,
operator|(
name|unsigned
name|short
operator|)
name|IMResourceReadWrite
block|,
name|ICInputStyle
block|}
block|,
block|{
name|XNClientWindow
block|,
sizeof|sizeof
argument_list|(
name|Window
argument_list|)
block|,
name|offset
argument_list|(
name|core
operator|.
name|client_window
argument_list|)
block|,
operator|(
name|unsigned
name|short
operator|)
name|IMResourceReadWrite
block|,
name|ICClientWindow
block|}
block|,
block|{
name|XNFocusWindow
block|,
sizeof|sizeof
argument_list|(
name|Window
argument_list|)
block|,
name|offset
argument_list|(
name|core
operator|.
name|focus_window
argument_list|)
block|,
operator|(
name|unsigned
name|short
operator|)
name|IMResourceReadWrite
block|,
name|ICFocusWindow
block|}
block|,
block|{
name|XNResourceName
block|,
sizeof|sizeof
argument_list|(
name|char
operator|*
argument_list|)
block|,
name|offset
argument_list|(
name|values
operator|.
name|res_name
argument_list|)
block|,
operator|(
name|unsigned
name|short
operator|)
name|IMResourceReadWrite
block|,
name|ICResourceName
block|}
block|,
block|{
name|XNResourceClass
block|,
sizeof|sizeof
argument_list|(
name|char
operator|*
argument_list|)
block|,
name|offset
argument_list|(
name|values
operator|.
name|res_class
argument_list|)
block|,
operator|(
name|unsigned
name|short
operator|)
name|IMResourceReadWrite
block|,
name|ICResourceClass
block|}
block|,
block|{
name|XNFilterEvents
block|,
sizeof|sizeof
argument_list|(
name|long
argument_list|)
block|,
name|offset
argument_list|(
name|core
operator|.
name|filter_events
argument_list|)
block|,
operator|(
name|unsigned
name|short
operator|)
name|IMResourceRead
block|,
name|ICFilterEvents
block|}
block|,
block|{
name|XNPreeditAttributes
block|,
sizeof|sizeof
argument_list|(
name|ICAttributes
operator|*
argument_list|)
block|,
name|offset
argument_list|(
name|core
operator|.
name|preedit_attr
argument_list|)
block|,
operator|(
name|unsigned
name|short
operator|)
name|IMResourceReadWrite
block|,
operator|-
literal|1
block|}
block|,
block|{
name|XNStatusAttributes
block|,
sizeof|sizeof
argument_list|(
name|ICAttributes
operator|*
argument_list|)
block|,
name|offset
argument_list|(
name|core
operator|.
name|status_attr
argument_list|)
block|,
operator|(
name|unsigned
name|short
operator|)
name|IMResourceReadWrite
block|,
operator|-
literal|1
block|}
ifdef|#
directive|ifdef
name|XML
block|,
block|{
name|XNUsingLanguage
block|,
sizeof|sizeof
argument_list|(
name|char
operator|*
argument_list|)
block|,
name|offset
argument_list|(
name|values
operator|.
name|using_language
argument_list|)
block|,
operator|(
name|unsigned
name|short
operator|)
name|IMResourceReadWrite
block|,
name|ICUsingLanguage
block|}
block|,
block|{
name|XNCurrentLanguage
block|,
sizeof|sizeof
argument_list|(
name|char
operator|*
argument_list|)
block|,
name|offset
argument_list|(
name|values
operator|.
name|current_language
argument_list|)
block|,
operator|(
name|unsigned
name|short
operator|)
name|IMResourceReadWrite
block|,
name|ICCurrentLanguage
block|}
block|,
block|{
name|XNChangeLocaleCB
block|,
sizeof|sizeof
argument_list|(
name|char
operator|*
operator|*
argument_list|)
block|,
name|offset
argument_list|(
name|values
operator|.
name|ch_locale_cb
argument_list|)
block|,
operator|(
name|unsigned
name|short
operator|)
name|IMResourceReadWrite
block|,
name|ICChangeLocaleCB
block|}
block|,
endif|#
directive|endif
comment|/* XML */
block|}
decl_stmt|;
end_decl_stmt

begin_undef
undef|#
directive|undef
name|offset
end_undef

begin_define
define|#
directive|define
name|attroffset
parameter_list|(
name|field
parameter_list|)
value|XOffsetOf(ICAttributes, field)
end_define

begin_decl_stmt
specifier|static
name|XIMResource
name|attr_resources
index|[]
init|=
block|{
block|{
name|XNArea
block|,
sizeof|sizeof
argument_list|(
name|XRectangle
argument_list|)
block|,
name|attroffset
argument_list|(
name|area
argument_list|)
block|,
operator|(
name|unsigned
name|short
operator|)
name|IMResourceReadWrite
block|,
name|ICArea
block|}
block|,
block|{
name|XNAreaNeeded
block|,
sizeof|sizeof
argument_list|(
name|XRectangle
argument_list|)
block|,
name|attroffset
argument_list|(
name|area_needed
argument_list|)
block|,
operator|(
name|unsigned
name|short
operator|)
name|IMResourceReadWrite
block|,
name|ICAreaNeeded
block|}
block|,
block|{
name|XNSpotLocation
block|,
sizeof|sizeof
argument_list|(
name|XPoint
argument_list|)
block|,
name|attroffset
argument_list|(
name|spot_location
argument_list|)
block|,
operator|(
name|unsigned
name|short
operator|)
name|IMResourceReadWrite
block|,
name|ICSpotLocation
block|}
block|,
block|{
name|XNColormap
block|,
sizeof|sizeof
argument_list|(
name|Colormap
argument_list|)
block|,
name|attroffset
argument_list|(
name|colormap
argument_list|)
block|,
operator|(
name|unsigned
name|short
operator|)
name|IMResourceReadWrite
block|,
name|ICColormap
block|}
block|,
block|{
name|XNStdColormap
block|,
sizeof|sizeof
argument_list|(
name|Atom
argument_list|)
block|,
name|attroffset
argument_list|(
name|std_colormap
argument_list|)
block|,
operator|(
name|unsigned
name|short
operator|)
name|IMResourceReadWrite
block|,
name|ICStdColormap
block|}
block|,
block|{
name|XNForeground
block|,
sizeof|sizeof
argument_list|(
name|long
argument_list|)
block|,
name|attroffset
argument_list|(
name|foreground
argument_list|)
block|,
operator|(
name|unsigned
name|short
operator|)
name|IMResourceReadWrite
block|,
name|ICForeground
block|}
block|,
block|{
name|XNBackground
block|,
sizeof|sizeof
argument_list|(
name|long
argument_list|)
block|,
name|attroffset
argument_list|(
name|background
argument_list|)
block|,
operator|(
name|unsigned
name|short
operator|)
name|IMResourceReadWrite
block|,
name|ICBackground
block|}
block|,
block|{
name|XNBackgroundPixmap
block|,
sizeof|sizeof
argument_list|(
name|Pixmap
argument_list|)
block|,
name|attroffset
argument_list|(
name|background_pixmap
argument_list|)
block|,
operator|(
name|unsigned
name|short
operator|)
name|IMResourceReadWrite
block|,
name|ICBackgroundPixmap
block|}
block|,
block|{
name|XNFontSet
block|,
sizeof|sizeof
argument_list|(
name|XFontSet
operator|*
argument_list|)
block|,
name|attroffset
argument_list|(
name|fontset
argument_list|)
block|,
operator|(
name|unsigned
name|short
operator|)
name|IMResourceReadWrite
block|,
name|ICFontSet
block|}
block|,
block|{
name|XNLineSpace
block|,
sizeof|sizeof
argument_list|(
name|int
argument_list|)
block|,
name|attroffset
argument_list|(
name|line_space
argument_list|)
block|,
operator|(
name|unsigned
name|short
operator|)
name|IMResourceReadWrite
block|,
name|ICLineSpace
block|}
block|,
block|{
name|XNCursor
block|,
sizeof|sizeof
argument_list|(
name|Cursor
argument_list|)
block|,
name|attroffset
argument_list|(
name|cursor
argument_list|)
block|,
operator|(
name|unsigned
name|short
operator|)
name|IMResourceReadWrite
block|,
name|ICCursor
block|}
block|,
block|{
name|XNPreeditStartCallback
block|,
sizeof|sizeof
argument_list|(
name|XIMCallback
argument_list|)
block|,
name|attroffset
argument_list|(
name|callbacks
operator|.
name|start
argument_list|)
block|,
operator|(
name|unsigned
name|short
operator|)
name|IMResourceReadWrite
block|,
operator|-
literal|1
block|}
block|,
block|{
name|XNPreeditDoneCallback
block|,
sizeof|sizeof
argument_list|(
name|XIMCallback
argument_list|)
block|,
name|attroffset
argument_list|(
name|callbacks
operator|.
name|done
argument_list|)
block|,
operator|(
name|unsigned
name|short
operator|)
name|IMResourceReadWrite
block|,
operator|-
literal|1
block|}
block|,
block|{
name|XNPreeditDrawCallback
block|,
sizeof|sizeof
argument_list|(
name|XIMCallback
argument_list|)
block|,
name|attroffset
argument_list|(
name|callbacks
operator|.
name|draw
argument_list|)
block|,
operator|(
name|unsigned
name|short
operator|)
name|IMResourceReadWrite
block|,
operator|-
literal|1
block|}
block|,
block|{
name|XNPreeditCaretCallback
block|,
sizeof|sizeof
argument_list|(
name|XIMCallback
argument_list|)
block|,
name|attroffset
argument_list|(
name|callbacks
operator|.
name|caret
argument_list|)
block|,
operator|(
name|unsigned
name|short
operator|)
name|IMResourceReadWrite
block|,
operator|-
literal|1
block|}
block|,
block|{
name|XNStatusStartCallback
block|,
sizeof|sizeof
argument_list|(
name|XIMCallback
argument_list|)
block|,
name|attroffset
argument_list|(
name|callbacks
operator|.
name|start
argument_list|)
block|,
operator|(
name|unsigned
name|short
operator|)
name|IMResourceReadWrite
block|,
operator|-
literal|1
block|}
block|,
block|{
name|XNStatusDoneCallback
block|,
sizeof|sizeof
argument_list|(
name|XIMCallback
argument_list|)
block|,
name|attroffset
argument_list|(
name|callbacks
operator|.
name|done
argument_list|)
block|,
operator|(
name|unsigned
name|short
operator|)
name|IMResourceReadWrite
block|,
operator|-
literal|1
block|}
block|,
block|{
name|XNStatusDrawCallback
block|,
sizeof|sizeof
argument_list|(
name|XIMCallback
argument_list|)
block|,
name|attroffset
argument_list|(
name|callbacks
operator|.
name|draw
argument_list|)
block|,
operator|(
name|unsigned
name|short
operator|)
name|IMResourceReadWrite
block|,
operator|-
literal|1
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_undef
undef|#
directive|undef
name|attroffset
end_undef

begin_comment
comment|/*  * Close the connection to the input manager, and free the private data  */
end_comment

begin_function
specifier|static
name|Status
name|_XipCloseIM
parameter_list|(
name|supim
parameter_list|)
name|XIM
name|supim
decl_stmt|;
block|{
name|XipIM
name|im
init|=
operator|(
name|XipIM
operator|)
name|supim
decl_stmt|;
if|if
condition|(
name|im
operator|->
name|fd
operator|>=
literal|0
condition|)
name|_XipDisconnectIM
argument_list|(
name|im
operator|->
name|fd
argument_list|)
expr_stmt|;
name|_XlcFreeLocale
argument_list|(
name|im
operator|->
name|xlc
argument_list|)
expr_stmt|;
name|Xfree
argument_list|(
name|im
operator|->
name|client_data
argument_list|)
expr_stmt|;
if|if
condition|(
name|im
operator|->
name|default_ic
condition|)
name|Xfree
argument_list|(
operator|(
name|char
operator|*
operator|)
name|im
operator|->
name|default_ic
argument_list|)
expr_stmt|;
return|return
operator|(
name|Success
operator|)
return|;
block|}
end_function

begin_decl_stmt
specifier|static
name|RConst
name|XIMMethodsRec
name|im_methods
init|=
block|{
name|_XipCloseIM
block|,
name|_XipGetIMValues
block|,
name|_XipCreateIC
block|}
decl_stmt|;
end_decl_stmt

begin_comment
comment|/*  * Connects to an input method matching current locale specification, creates  * a XIM object and return a pointer the newly created XIM back to the caller.  */
end_comment

begin_function
name|XIM
name|_XipOpenIM
parameter_list|(
name|lcd
parameter_list|,
name|display
parameter_list|,
name|rdb
parameter_list|,
name|res_name
parameter_list|,
name|res_class
parameter_list|)
name|XLCd
name|lcd
decl_stmt|;
name|Display
modifier|*
name|display
decl_stmt|;
name|XrmDatabase
name|rdb
decl_stmt|;
name|char
modifier|*
name|res_name
decl_stmt|;
name|char
modifier|*
name|res_class
decl_stmt|;
block|{
name|Atom
name|atom_im
decl_stmt|;
name|XipIM
name|xim
decl_stmt|;
name|char
name|strbuf
index|[
literal|128
index|]
decl_stmt|;
name|char
modifier|*
name|str
decl_stmt|,
modifier|*
name|prop_im
decl_stmt|,
modifier|*
name|p
decl_stmt|;
name|XLocale
name|xlc
init|=
operator|(
operator|(
name|XsiLCd
operator|)
name|lcd
operator|)
operator|->
name|xlc
decl_stmt|;
ifdef|#
directive|ifdef
name|uniosu
specifier|extern
name|struct
name|passwd
modifier|*
name|getpwuid
parameter_list|()
function_decl|;
endif|#
directive|endif
name|str
operator|=
name|lcd
operator|->
name|core
operator|.
name|modifiers
expr_stmt|;
while|while
condition|(
name|str
operator|&&
name|strncmp
argument_list|(
name|str
operator|+
literal|1
argument_list|,
literal|"im="
argument_list|,
literal|3
argument_list|)
condition|)
name|str
operator|=
name|index
argument_list|(
name|str
operator|+
literal|1
argument_list|,
literal|'@'
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|str
condition|)
name|strbuf
index|[
literal|0
index|]
operator|=
literal|'\0'
expr_stmt|;
else|else
block|{
name|str
operator|+=
literal|4
expr_stmt|;
name|p
operator|=
name|index
argument_list|(
name|str
argument_list|,
literal|'@'
argument_list|)
expr_stmt|;
if|if
condition|(
name|p
condition|)
block|{
name|strncpy
argument_list|(
name|strbuf
argument_list|,
name|str
argument_list|,
name|p
operator|-
name|str
argument_list|)
expr_stmt|;
name|strbuf
index|[
name|p
operator|-
name|str
index|]
operator|=
literal|'\0'
expr_stmt|;
block|}
else|else
block|{
name|strcpy
argument_list|(
name|strbuf
argument_list|,
name|str
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
name|strbuf
index|[
literal|0
index|]
operator|==
literal|'\0'
condition|)
name|prop_im
operator|=
name|XIM_INPUTMETHOD
expr_stmt|;
elseif|else
if|if
condition|(
operator|!
name|strcmp
argument_list|(
name|strbuf
argument_list|,
literal|"None"
argument_list|)
operator|||
operator|!
name|strcmp
argument_list|(
name|strbuf
argument_list|,
literal|"NONE"
argument_list|)
condition|)
return|return
operator|(
name|NULL
operator|)
return|;
ifndef|#
directive|ifndef
name|NO_LOCAL_IM
elseif|else
if|if
condition|(
operator|!
name|strcmp
argument_list|(
name|strbuf
argument_list|,
literal|"Local"
argument_list|)
condition|)
return|return
operator|(
name|_XipLocalOpenIM
argument_list|(
name|lcd
argument_list|,
name|display
argument_list|,
name|rdb
argument_list|,
name|res_name
argument_list|,
name|res_class
argument_list|)
operator|)
return|;
endif|#
directive|endif
else|else
name|prop_im
operator|=
name|strbuf
expr_stmt|;
comment|/*      * Check whether an input manager is running or not. If the input manager      * isn't running, return NULL.      */
if|if
condition|(
operator|(
name|atom_im
operator|=
name|XInternAtom
argument_list|(
name|display
argument_list|,
name|prop_im
argument_list|,
name|True
argument_list|)
operator|)
operator|==
name|None
condition|)
block|{
return|return
operator|(
name|NULL
operator|)
return|;
block|}
if|if
condition|(
name|XGetSelectionOwner
argument_list|(
name|display
argument_list|,
name|atom_im
argument_list|)
operator|==
name|None
condition|)
block|{
return|return
operator|(
name|NULL
operator|)
return|;
block|}
comment|/*      * Gets display name from the display structure. If the display name is      * NULL, gets from the DISPLAY variable.      */
if|if
condition|(
name|DisplayString
argument_list|(
name|display
argument_list|)
condition|)
block|{
name|strcpy
argument_list|(
name|strbuf
argument_list|,
name|DisplayString
argument_list|(
name|display
argument_list|)
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|str
operator|=
name|getenv
argument_list|(
literal|"DISPLAY"
argument_list|)
condition|)
block|{
comment|/* If the display string is NULL, read the DISPLAY variable. */
name|strcpy
argument_list|(
name|strbuf
argument_list|,
name|str
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|/* No display name - error. */
return|return
operator|(
name|NULL
operator|)
return|;
block|}
comment|/*      * Attempt to allocate a XIM structure. Return NULL if allocation      * failed.      */
if|if
condition|(
operator|(
name|xim
operator|=
operator|(
name|XipIM
operator|)
name|Xmalloc
argument_list|(
sizeof|sizeof
argument_list|(
name|XipIMRec
argument_list|)
argument_list|)
operator|)
operator|==
name|NULL
condition|)
block|{
return|return
operator|(
name|NULL
operator|)
return|;
block|}
name|xim
operator|->
name|methods
operator|=
operator|(
name|XIMMethods
operator|)
operator|&
name|im_methods
expr_stmt|;
name|xim
operator|->
name|sp
operator|=
literal|0
expr_stmt|;
name|xim
operator|->
name|rp
operator|=
literal|0
expr_stmt|;
name|xim
operator|->
name|rc
operator|=
literal|0
expr_stmt|;
name|xim
operator|->
name|core
operator|.
name|lcd
operator|=
name|lcd
expr_stmt|;
name|xim
operator|->
name|core
operator|.
name|ic_chain
operator|=
name|NULL
expr_stmt|;
name|xim
operator|->
name|core
operator|.
name|display
operator|=
name|display
expr_stmt|;
name|xim
operator|->
name|core
operator|.
name|rdb
operator|=
name|rdb
expr_stmt|;
name|xim
operator|->
name|core
operator|.
name|res_name
operator|=
name|res_name
expr_stmt|;
name|xim
operator|->
name|core
operator|.
name|res_class
operator|=
name|res_class
expr_stmt|;
name|xim
operator|->
name|values
operator|.
name|input_styles
operator|.
name|supported_styles
operator|=
name|NULL
expr_stmt|;
name|xim
operator|->
name|values
operator|.
name|input_styles
operator|.
name|count_styles
operator|=
literal|0
expr_stmt|;
ifdef|#
directive|ifdef
name|XML
name|xim
operator|->
name|values
operator|.
name|supported_language
operator|=
name|NULL
expr_stmt|;
endif|#
directive|endif
comment|/* XML */
comment|/*      * Get user name.      */
if|if
condition|(
operator|(
name|str
operator|=
name|getenv
argument_list|(
literal|"USER"
argument_list|)
operator|)
operator|==
name|NULL
condition|)
name|str
operator|=
name|getpwuid
argument_list|(
name|getuid
argument_list|()
argument_list|)
operator|->
name|pw_name
expr_stmt|;
name|xim
operator|->
name|client_data
operator|=
name|Xmalloc
argument_list|(
name|strlen
argument_list|(
name|str
argument_list|)
operator|+
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|xim
operator|->
name|client_data
condition|)
block|{
name|Xfree
argument_list|(
operator|(
name|char
operator|*
operator|)
name|xim
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
operator|(
name|void
operator|)
name|strcpy
argument_list|(
name|xim
operator|->
name|client_data
argument_list|,
name|str
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|compiled_resources
condition|)
block|{
name|_XIMCompileResourceList
argument_list|(
name|im_resources
argument_list|,
name|XIMNumber
argument_list|(
name|im_resources
argument_list|)
argument_list|)
expr_stmt|;
name|_XIMCompileResourceList
argument_list|(
name|ic_resources
argument_list|,
name|XIMNumber
argument_list|(
name|ic_resources
argument_list|)
argument_list|)
expr_stmt|;
name|_XIMCompileResourceList
argument_list|(
name|attr_resources
argument_list|,
name|XIMNumber
argument_list|(
name|attr_resources
argument_list|)
argument_list|)
expr_stmt|;
name|compiled_resources
operator|=
literal|1
expr_stmt|;
block|}
name|xim
operator|->
name|resources
operator|=
operator|(
name|XIMrmResourceList
operator|)
name|im_resources
expr_stmt|;
name|xim
operator|->
name|num_resources
operator|=
name|XIMNumber
argument_list|(
name|im_resources
argument_list|)
expr_stmt|;
name|xim
operator|->
name|core
operator|.
name|ic_resources
operator|=
operator|(
name|XIMrmResourceList
operator|)
name|ic_resources
expr_stmt|;
name|xim
operator|->
name|core
operator|.
name|ic_num_resources
operator|=
name|XIMNumber
argument_list|(
name|ic_resources
argument_list|)
expr_stmt|;
name|xim
operator|->
name|core
operator|.
name|ic_attr_resources
operator|=
operator|(
name|XIMrmResourceList
operator|)
name|attr_resources
expr_stmt|;
name|xim
operator|->
name|core
operator|.
name|ic_num_attr_resources
operator|=
name|XIMNumber
argument_list|(
name|attr_resources
argument_list|)
expr_stmt|;
comment|/*      * Call the Connect routine to get the network socket. If a value less      * than 0 is returned, the connection failed.       */
if|if
condition|(
operator|(
name|_XipConnectIM
argument_list|(
name|xim
argument_list|,
name|atom_im
argument_list|,
name|strbuf
argument_list|)
operator|)
operator|!=
name|True
condition|)
block|{
name|Xfree
argument_list|(
name|xim
operator|->
name|client_data
argument_list|)
expr_stmt|;
name|Xfree
argument_list|(
operator|(
name|char
operator|*
operator|)
name|xim
argument_list|)
expr_stmt|;
return|return
operator|(
name|NULL
operator|)
return|;
block|}
name|xim
operator|->
name|xlc
operator|=
name|_XlcDupLocale
argument_list|(
name|xlc
argument_list|)
expr_stmt|;
comment|/*      * Create a default IC.      */
if|if
condition|(
operator|!
name|_XipCreateDefIC
argument_list|(
name|xim
argument_list|)
condition|)
block|{
name|XCloseIM
argument_list|(
operator|(
name|XIM
operator|)
name|xim
argument_list|)
expr_stmt|;
return|return
operator|(
name|NULL
operator|)
return|;
block|}
return|return
operator|(
operator|(
name|XIM
operator|)
name|xim
operator|)
return|;
block|}
end_function

begin_ifdef
ifdef|#
directive|ifdef
name|XML
end_ifdef

begin_function
name|XIM
name|XmlOpenIM
parameter_list|(
name|display
parameter_list|,
name|rdb
parameter_list|,
name|res_name
parameter_list|,
name|res_class
parameter_list|)
name|Display
modifier|*
name|display
decl_stmt|;
name|XrmDatabase
name|rdb
decl_stmt|;
name|char
modifier|*
name|res_name
decl_stmt|;
name|char
modifier|*
name|res_class
decl_stmt|;
block|{
name|XIM
name|supim
decl_stmt|;
name|XipIM
name|im
decl_stmt|;
if|if
condition|(
operator|(
name|supim
operator|=
name|XOpenIM
argument_list|(
name|display
argument_list|,
name|rdb
argument_list|,
name|res_name
argument_list|,
name|res_class
argument_list|)
operator|)
operator|==
name|NULL
condition|)
block|{
return|return
operator|(
name|NULL
operator|)
return|;
block|}
name|im
operator|=
operator|(
name|XipIM
operator|)
name|supim
expr_stmt|;
if|if
condition|(
name|im
operator|->
name|xlc
condition|)
block|{
name|_XlcFreeLocale
argument_list|(
name|im
operator|->
name|xlc
argument_list|)
expr_stmt|;
name|im
operator|->
name|xlc
operator|=
name|NULL
expr_stmt|;
block|}
return|return
operator|(
name|supim
operator|)
return|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* XML */
end_comment

end_unit


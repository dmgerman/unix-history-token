begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * $XConsortium: XLocalIM.c,v 1.11 92/10/22 14:26:20 rws Exp $  */
end_comment

begin_comment
comment|/*  * Copyright 1990, 1991 by OMRON Corporation  * Copyright 1991 by the Massachusetts Institute of Technology  *  * Permission to use, copy, modify, distribute, and sell this software and its  * documentation for any purpose is hereby granted without fee, provided that  * the above copyright notice appear in all copies and that both that  * copyright notice and this permission notice appear in supporting  * documentation, and that the names of OMRON and MIT not be used in  * advertising or publicity pertaining to distribution of the software without  * specific, written prior permission.  OMRON and MIT make no representations  * about the suitability of this software for any purpose.  It is provided  * "as is" without express or implied warranty.  *  * OMRON AND MIT DISCLAIM ALL WARRANTIES WITH REGARD TO THIS SOFTWARE,  * INCLUDING ALL IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS, IN NO  * EVENT SHALL OMRON OR MIT BE LIABLE FOR ANY SPECIAL, INDIRECT OR  * CONSEQUENTIAL DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM LOSS OF USE,  * DATA OR PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE OR OTHER  * TORTUOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR  * PERFORMANCE OF THIS SOFTWARE.   *  *	Author:	Seiji Kuwari	OMRON Corporation  *				kuwa@omron.co.jp  *				kuwa%omron.co.jp@uunet.uu.net  */
end_comment

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_define
define|#
directive|define
name|NEED_EVENTS
end_define

begin_include
include|#
directive|include
file|"Xlibint.h"
end_include

begin_include
include|#
directive|include
file|"Xi18nint.h"
end_include

begin_include
include|#
directive|include
file|"XIMlibint.h"
end_include

begin_include
include|#
directive|include
file|<X11/Xos.h>
end_include

begin_include
include|#
directive|include
file|<X11/keysymdef.h>
end_include

begin_if
if|#
directive|if
name|NeedVarargsPrototypes
end_if

begin_include
include|#
directive|include
file|<stdarg.h>
end_include

begin_define
define|#
directive|define
name|Va_start
parameter_list|(
name|a
parameter_list|,
name|b
parameter_list|)
value|va_start(a,b)
end_define

begin_else
else|#
directive|else
end_else

begin_include
include|#
directive|include
file|<varargs.h>
end_include

begin_define
define|#
directive|define
name|Va_start
parameter_list|(
name|a
parameter_list|,
name|b
parameter_list|)
value|va_start(a)
end_define

begin_endif
endif|#
directive|endif
end_endif

begin_ifndef
ifndef|#
directive|ifndef
name|X_NOT_POSIX
end_ifndef

begin_ifdef
ifdef|#
directive|ifdef
name|_POSIX_SOURCE
end_ifdef

begin_include
include|#
directive|include
file|<limits.h>
end_include

begin_else
else|#
directive|else
end_else

begin_define
define|#
directive|define
name|_POSIX_SOURCE
end_define

begin_include
include|#
directive|include
file|<limits.h>
end_include

begin_undef
undef|#
directive|undef
name|_POSIX_SOURCE
end_undef

begin_endif
endif|#
directive|endif
end_endif

begin_endif
endif|#
directive|endif
end_endif

begin_ifndef
ifndef|#
directive|ifndef
name|PATH_MAX
end_ifndef

begin_include
include|#
directive|include
file|<sys/param.h>
end_include

begin_ifndef
ifndef|#
directive|ifndef
name|PATH_MAX
end_ifndef

begin_ifdef
ifdef|#
directive|ifdef
name|MAXPATHLEN
end_ifdef

begin_define
define|#
directive|define
name|PATH_MAX
value|MAXPATHLEN
end_define

begin_else
else|#
directive|else
end_else

begin_define
define|#
directive|define
name|PATH_MAX
value|1024
end_define

begin_endif
endif|#
directive|endif
end_endif

begin_endif
endif|#
directive|endif
end_endif

begin_endif
endif|#
directive|endif
end_endif

begin_ifdef
ifdef|#
directive|ifdef
name|X_NOT_STDC_ENV
end_ifdef

begin_function_decl
specifier|extern
name|char
modifier|*
name|getenv
parameter_list|()
function_decl|;
end_function_decl

begin_endif
endif|#
directive|endif
end_endif

begin_if
if|#
directive|if
name|__STDC__
operator|&&
operator|!
name|defined
argument_list|(
name|NORCONST
argument_list|)
end_if

begin_define
define|#
directive|define
name|RConst
value|const
end_define

begin_else
else|#
directive|else
end_else

begin_define
define|#
directive|define
name|RConst
end_define

begin_comment
comment|/**/
end_comment

begin_endif
endif|#
directive|endif
end_endif

begin_define
define|#
directive|define
name|offset
parameter_list|(
name|field
parameter_list|)
value|XOffsetOf(XipLocalIMRec, field)
end_define

begin_decl_stmt
specifier|static
name|int
name|compiled_resources
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|XIMResource
name|im_resources
index|[]
init|=
block|{
block|{
name|XNQueryInputStyle
block|,
sizeof|sizeof
argument_list|(
name|XIMStyles
argument_list|)
block|,
name|offset
argument_list|(
name|values
operator|.
name|input_styles
argument_list|)
block|,
operator|(
name|unsigned
name|short
operator|)
name|IMResourceRead
block|,
operator|(
name|int
operator|)
name|IMQueryInputStyle
block|}
block|,
ifdef|#
directive|ifdef
name|XML
block|{
name|XNQueryLanguage
block|,
sizeof|sizeof
argument_list|(
name|char
operator|*
argument_list|)
block|,
name|offset
argument_list|(
name|values
operator|.
name|supported_language
argument_list|)
block|,
operator|(
name|unsigned
name|short
operator|)
name|IMResourceRead
block|,
operator|(
name|int
operator|)
name|IMQueryLanguage
block|}
endif|#
directive|endif
comment|/* XML */
block|}
decl_stmt|;
end_decl_stmt

begin_undef
undef|#
directive|undef
name|offset
end_undef

begin_define
define|#
directive|define
name|offset
parameter_list|(
name|field
parameter_list|)
value|XOffsetOf(XipLocalICRec, field)
end_define

begin_decl_stmt
specifier|static
name|XIMResource
name|ic_resources
index|[]
init|=
block|{
block|{
name|XNInputStyle
block|,
sizeof|sizeof
argument_list|(
name|XIMStyle
argument_list|)
block|,
name|offset
argument_list|(
name|core
operator|.
name|input_style
argument_list|)
block|,
operator|(
name|unsigned
name|short
operator|)
name|IMResourceReadWrite
block|,
name|ICInputStyle
block|}
block|,
block|{
name|XNClientWindow
block|,
sizeof|sizeof
argument_list|(
name|Window
argument_list|)
block|,
name|offset
argument_list|(
name|core
operator|.
name|client_window
argument_list|)
block|,
operator|(
name|unsigned
name|short
operator|)
name|IMResourceReadWrite
block|,
operator|-
literal|1
block|}
block|,
block|{
name|XNFocusWindow
block|,
sizeof|sizeof
argument_list|(
name|Window
argument_list|)
block|,
name|offset
argument_list|(
name|core
operator|.
name|focus_window
argument_list|)
block|,
operator|(
name|unsigned
name|short
operator|)
name|IMResourceReadWrite
block|,
name|ICFocusWindow
block|}
block|,
block|{
name|XNResourceName
block|,
sizeof|sizeof
argument_list|(
name|char
operator|*
argument_list|)
block|,
name|offset
argument_list|(
name|values
operator|.
name|res_name
argument_list|)
block|,
operator|(
name|unsigned
name|short
operator|)
name|IMResourceReadWrite
block|,
operator|-
literal|1
block|}
block|,
block|{
name|XNResourceClass
block|,
sizeof|sizeof
argument_list|(
name|char
operator|*
argument_list|)
block|,
name|offset
argument_list|(
name|values
operator|.
name|res_class
argument_list|)
block|,
operator|(
name|unsigned
name|short
operator|)
name|IMResourceReadWrite
block|,
operator|-
literal|1
block|}
block|,
block|{
name|XNFilterEvents
block|,
sizeof|sizeof
argument_list|(
name|long
argument_list|)
block|,
name|offset
argument_list|(
name|core
operator|.
name|filter_events
argument_list|)
block|,
operator|(
name|unsigned
name|short
operator|)
name|IMResourceRead
block|,
name|ICFilterEvents
block|}
block|,
block|{
name|XNPreeditAttributes
block|,
sizeof|sizeof
argument_list|(
name|ICAttributes
operator|*
argument_list|)
block|,
name|offset
argument_list|(
name|core
operator|.
name|preedit_attr
argument_list|)
block|,
operator|(
name|unsigned
name|short
operator|)
name|IMResourceReadWrite
block|,
operator|-
literal|1
block|}
block|,
block|{
name|XNStatusAttributes
block|,
sizeof|sizeof
argument_list|(
name|ICAttributes
operator|*
argument_list|)
block|,
name|offset
argument_list|(
name|core
operator|.
name|status_attr
argument_list|)
block|,
operator|(
name|unsigned
name|short
operator|)
name|IMResourceReadWrite
block|,
operator|-
literal|1
block|}
ifdef|#
directive|ifdef
name|XML
block|,
block|{
name|XNUsingLanguage
block|,
sizeof|sizeof
argument_list|(
name|char
operator|*
argument_list|)
block|,
name|offset
argument_list|(
name|values
operator|.
name|using_language
argument_list|)
block|,
operator|(
name|unsigned
name|short
operator|)
name|IMResourceReadWrite
block|,
name|ICUsingLanguage
block|}
block|,
block|{
name|XNCurrentLanguage
block|,
sizeof|sizeof
argument_list|(
name|char
operator|*
argument_list|)
block|,
name|offset
argument_list|(
name|values
operator|.
name|current_language
argument_list|)
block|,
operator|(
name|unsigned
name|short
operator|)
name|IMResourceReadWrite
block|,
name|ICCurrentLanguage
block|}
block|,
block|{
name|XNChangeLocaleCB
block|,
sizeof|sizeof
argument_list|(
name|char
operator|*
operator|*
argument_list|)
block|,
name|offset
argument_list|(
name|values
operator|.
name|ch_locale_cb
argument_list|)
block|,
operator|(
name|unsigned
name|short
operator|)
name|IMResourceReadWrite
block|,
name|ICChangeLocaleCB
block|}
block|,
endif|#
directive|endif
comment|/* XML */
block|}
decl_stmt|;
end_decl_stmt

begin_undef
undef|#
directive|undef
name|offset
end_undef

begin_define
define|#
directive|define
name|attroffset
parameter_list|(
name|field
parameter_list|)
value|XOffsetOf(ICAttributes, field)
end_define

begin_decl_stmt
specifier|static
name|XIMResource
name|attr_resources
index|[]
init|=
block|{
block|{
name|XNArea
block|,
sizeof|sizeof
argument_list|(
name|XRectangle
argument_list|)
block|,
name|attroffset
argument_list|(
name|area
argument_list|)
block|,
operator|(
name|unsigned
name|short
operator|)
name|IMResourceReadWrite
block|,
name|ICArea
block|}
block|,
block|{
name|XNAreaNeeded
block|,
sizeof|sizeof
argument_list|(
name|XRectangle
argument_list|)
block|,
name|attroffset
argument_list|(
name|area_needed
argument_list|)
block|,
operator|(
name|unsigned
name|short
operator|)
name|IMResourceReadWrite
block|,
name|ICAreaNeeded
block|}
block|,
block|{
name|XNSpotLocation
block|,
operator|(
sizeof|sizeof
argument_list|(
name|XPoint
argument_list|)
operator|+
literal|4
operator|)
block|,
name|attroffset
argument_list|(
name|spot_location
argument_list|)
block|,
operator|(
name|unsigned
name|short
operator|)
name|IMResourceReadWrite
block|,
name|ICSpotLocation
block|}
block|,
block|{
name|XNColormap
block|,
sizeof|sizeof
argument_list|(
name|Colormap
argument_list|)
block|,
name|attroffset
argument_list|(
name|colormap
argument_list|)
block|,
operator|(
name|unsigned
name|short
operator|)
name|IMResourceReadWrite
block|,
name|ICColormap
block|}
block|,
block|{
name|XNStdColormap
block|,
sizeof|sizeof
argument_list|(
name|Atom
argument_list|)
block|,
name|attroffset
argument_list|(
name|std_colormap
argument_list|)
block|,
operator|(
name|unsigned
name|short
operator|)
name|IMResourceReadWrite
block|,
name|ICStdColormap
block|}
block|,
block|{
name|XNForeground
block|,
sizeof|sizeof
argument_list|(
name|long
argument_list|)
block|,
name|attroffset
argument_list|(
name|foreground
argument_list|)
block|,
operator|(
name|unsigned
name|short
operator|)
name|IMResourceReadWrite
block|,
name|ICForeground
block|}
block|,
block|{
name|XNBackground
block|,
sizeof|sizeof
argument_list|(
name|long
argument_list|)
block|,
name|attroffset
argument_list|(
name|background
argument_list|)
block|,
operator|(
name|unsigned
name|short
operator|)
name|IMResourceReadWrite
block|,
name|ICBackground
block|}
block|,
block|{
name|XNBackgroundPixmap
block|,
sizeof|sizeof
argument_list|(
name|Pixmap
argument_list|)
block|,
name|attroffset
argument_list|(
name|background_pixmap
argument_list|)
block|,
operator|(
name|unsigned
name|short
operator|)
name|IMResourceReadWrite
block|,
name|ICBackgroundPixmap
block|}
block|,
block|{
name|XNFontSet
block|,
sizeof|sizeof
argument_list|(
name|XFontSet
operator|*
argument_list|)
block|,
name|attroffset
argument_list|(
name|fontset
argument_list|)
block|,
operator|(
name|unsigned
name|short
operator|)
name|IMResourceReadWrite
block|,
name|ICFontSet
block|}
block|,
block|{
name|XNLineSpace
block|,
sizeof|sizeof
argument_list|(
name|int
argument_list|)
block|,
name|attroffset
argument_list|(
name|line_space
argument_list|)
block|,
operator|(
name|unsigned
name|short
operator|)
name|IMResourceReadWrite
block|,
name|ICLineSpace
block|}
block|,
block|{
name|XNCursor
block|,
sizeof|sizeof
argument_list|(
name|Cursor
argument_list|)
block|,
name|attroffset
argument_list|(
name|cursor
argument_list|)
block|,
operator|(
name|unsigned
name|short
operator|)
name|IMResourceReadWrite
block|,
name|ICCursor
block|}
block|,
block|{
name|XNPreeditStartCallback
block|,
sizeof|sizeof
argument_list|(
name|XIMCallback
argument_list|)
block|,
name|attroffset
argument_list|(
name|callbacks
operator|.
name|start
argument_list|)
block|,
operator|(
name|unsigned
name|short
operator|)
name|IMResourceReadWrite
block|,
operator|-
literal|1
block|}
block|,
block|{
name|XNPreeditDoneCallback
block|,
sizeof|sizeof
argument_list|(
name|XIMCallback
argument_list|)
block|,
name|attroffset
argument_list|(
name|callbacks
operator|.
name|done
argument_list|)
block|,
operator|(
name|unsigned
name|short
operator|)
name|IMResourceReadWrite
block|,
operator|-
literal|1
block|}
block|,
block|{
name|XNPreeditDrawCallback
block|,
sizeof|sizeof
argument_list|(
name|XIMCallback
argument_list|)
block|,
name|attroffset
argument_list|(
name|callbacks
operator|.
name|draw
argument_list|)
block|,
operator|(
name|unsigned
name|short
operator|)
name|IMResourceReadWrite
block|,
operator|-
literal|1
block|}
block|,
block|{
name|XNPreeditCaretCallback
block|,
sizeof|sizeof
argument_list|(
name|XIMCallback
argument_list|)
block|,
name|attroffset
argument_list|(
name|callbacks
operator|.
name|caret
argument_list|)
block|,
operator|(
name|unsigned
name|short
operator|)
name|IMResourceReadWrite
block|,
operator|-
literal|1
block|}
block|,
block|{
name|XNStatusStartCallback
block|,
sizeof|sizeof
argument_list|(
name|XIMCallback
argument_list|)
block|,
name|attroffset
argument_list|(
name|callbacks
operator|.
name|start
argument_list|)
block|,
operator|(
name|unsigned
name|short
operator|)
name|IMResourceReadWrite
block|,
operator|-
literal|1
block|}
block|,
block|{
name|XNStatusDoneCallback
block|,
sizeof|sizeof
argument_list|(
name|XIMCallback
argument_list|)
block|,
name|attroffset
argument_list|(
name|callbacks
operator|.
name|done
argument_list|)
block|,
operator|(
name|unsigned
name|short
operator|)
name|IMResourceReadWrite
block|,
operator|-
literal|1
block|}
block|,
block|{
name|XNStatusDrawCallback
block|,
sizeof|sizeof
argument_list|(
name|XIMCallback
argument_list|)
block|,
name|attroffset
argument_list|(
name|callbacks
operator|.
name|draw
argument_list|)
block|,
operator|(
name|unsigned
name|short
operator|)
name|IMResourceReadWrite
block|,
operator|-
literal|1
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_undef
undef|#
directive|undef
name|attroffset
end_undef

begin_define
define|#
directive|define
name|ENTRY_CNT
value|256
end_define

begin_define
define|#
directive|define
name|BITONP
parameter_list|(
name|h
parameter_list|,
name|i
parameter_list|)
value|(h[i / BITSIZ]&  (1<< (i % BITSIZ)))
end_define

begin_define
define|#
directive|define
name|BITOFP
parameter_list|(
name|h
parameter_list|,
name|i
parameter_list|)
value|(!BITONP(h, i))
end_define

begin_define
define|#
directive|define
name|BIT_UP
parameter_list|(
name|h
parameter_list|,
name|i
parameter_list|)
value|(h[i / BITSIZ] |= (1<< (i % BITSIZ)))
end_define

begin_define
define|#
directive|define
name|BITDWN
parameter_list|(
name|h
parameter_list|,
name|i
parameter_list|)
value|(h[i / BITSIZ]&= ~(1<< (i % BITSIZ)))
end_define

begin_define
define|#
directive|define
name|div_up
parameter_list|(
name|a
parameter_list|,
name|b
parameter_list|)
value|((a + b - 1) / b)
end_define

begin_ifndef
ifndef|#
directive|ifndef
name|XNLSPATHDEFAULT
end_ifndef

begin_define
define|#
directive|define
name|XNLSPATHDEFAULT
value|"/usr/lib/X11/nls"
end_define

begin_endif
endif|#
directive|endif
end_endif

begin_ifndef
ifndef|#
directive|ifndef
name|LOCAL_CVT_TBL_DIR
end_ifndef

begin_define
define|#
directive|define
name|LOCAL_CVT_TBL_DIR
value|"/local_im_tbl/"
end_define

begin_endif
endif|#
directive|endif
end_endif

begin_typedef
typedef|typedef
struct|struct
block|{
name|char
modifier|*
name|name
decl_stmt|;
name|unsigned
name|int
name|mask
decl_stmt|;
block|}
name|StateTbl
typedef|;
end_typedef

begin_decl_stmt
specifier|static
name|StateTbl
name|state_tbl
index|[]
init|=
block|{
block|{
literal|"Lock"
block|,
name|LockMask
block|}
block|,
block|{
literal|"Control"
block|,
name|ControlMask
block|}
block|,
block|{
literal|"Mod1"
block|,
name|Mod1Mask
block|}
block|,
block|{
literal|"Mod2"
block|,
name|Mod2Mask
block|}
block|,
block|{
literal|"Mod3"
block|,
name|Mod3Mask
block|}
block|,
block|{
literal|"Mod4"
block|,
name|Mod4Mask
block|}
block|,
block|{
literal|"Mod5"
block|,
name|Mod5Mask
block|}
block|,
block|{
name|NULL
block|,
literal|0
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_typedef
typedef|typedef
struct|struct
block|{
name|char
modifier|*
name|name
decl_stmt|;
name|Bool
function_decl|(
modifier|*
name|func
function_decl|)
parameter_list|()
function_decl|;
name|int
function_decl|(
modifier|*
name|init_func
function_decl|)
parameter_list|()
function_decl|;
block|}
name|FuncTbl
typedef|;
end_typedef

begin_function_decl
specifier|static
name|int
name|convert_on
parameter_list|()
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|convert_off
parameter_list|()
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|convert_on_init
parameter_list|()
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|no_filter
parameter_list|()
function_decl|;
end_function_decl

begin_decl_stmt
specifier|static
name|FuncTbl
name|func_tbl
index|[]
init|=
block|{
block|{
literal|"ConvertOn"
block|,
name|convert_on
block|,
name|convert_on_init
block|}
block|,
block|{
literal|"ConvertOff"
block|,
name|convert_off
block|,
name|NULL
block|}
block|,
block|{
literal|"NoFilter"
block|,
name|NULL
block|,
name|no_filter
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_function
specifier|static
name|unsigned
name|int
name|is_state
parameter_list|(
name|name
parameter_list|)
specifier|register
name|char
modifier|*
name|name
decl_stmt|;
block|{
specifier|register
name|StateTbl
modifier|*
name|p
decl_stmt|;
for|for
control|(
name|p
operator|=
name|state_tbl
init|;
name|p
operator|->
name|name
condition|;
name|p
operator|++
control|)
block|{
if|if
condition|(
operator|!
name|strcmp
argument_list|(
name|p
operator|->
name|name
argument_list|,
name|name
argument_list|)
condition|)
return|return
operator|(
name|p
operator|->
name|mask
operator|)
return|;
block|}
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|parse_bslash
parameter_list|(
name|buf
parameter_list|,
name|work
parameter_list|)
specifier|register
name|char
modifier|*
name|buf
decl_stmt|;
specifier|register
name|unsigned
name|char
modifier|*
name|work
decl_stmt|;
block|{
specifier|register
name|int
name|i
decl_stmt|;
switch|switch
condition|(
operator|*
name|buf
condition|)
block|{
case|case
literal|'x'
case|:
comment|/* 16 */
for|for
control|(
name|buf
operator|++
operator|,
operator|*
name|work
operator|=
literal|'\0'
operator|,
name|i
operator|=
literal|1
init|;
name|i
operator|>=
literal|0
condition|;
name|i
operator|--
operator|,
name|buf
operator|++
control|)
block|{
if|if
condition|(
operator|*
name|buf
operator|>=
literal|'0'
operator|&&
operator|*
name|buf
operator|<=
literal|'9'
condition|)
block|{
operator|*
name|work
operator||=
operator|(
operator|(
literal|1
operator|<<
operator|(
name|i
operator|*
literal|4
operator|)
operator|)
operator|*
operator|(
operator|*
name|buf
operator|-
literal|'0'
operator|)
operator|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|*
name|buf
operator|>=
literal|'A'
operator|&&
operator|*
name|buf
operator|<=
literal|'F'
condition|)
block|{
operator|*
name|work
operator||=
operator|(
operator|(
literal|1
operator|<<
operator|(
name|i
operator|*
literal|4
operator|)
operator|)
operator|*
operator|(
operator|*
name|buf
operator|-
literal|'A'
operator|+
literal|10
operator|)
operator|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|*
name|buf
operator|>=
literal|'a'
operator|&&
operator|*
name|buf
operator|<=
literal|'f'
condition|)
block|{
operator|*
name|work
operator||=
operator|(
operator|(
literal|1
operator|<<
operator|(
name|i
operator|*
literal|4
operator|)
operator|)
operator|*
operator|(
operator|*
name|buf
operator|-
literal|'a'
operator|+
literal|10
operator|)
operator|)
expr_stmt|;
block|}
else|else
block|{
return|return
operator|(
literal|0
operator|)
return|;
block|}
block|}
return|return
operator|(
literal|3
operator|)
return|;
case|case
literal|'o'
case|:
comment|/* 8 */
for|for
control|(
name|buf
operator|++
operator|,
operator|*
name|work
operator|=
literal|'\0'
operator|,
name|i
operator|=
literal|2
init|;
name|i
operator|>=
literal|0
condition|;
name|i
operator|--
operator|,
name|buf
operator|++
control|)
block|{
if|if
condition|(
operator|*
name|buf
operator|>=
literal|'0'
operator|&&
operator|*
name|buf
operator|<=
literal|'7'
condition|)
block|{
operator|*
name|work
operator||=
operator|(
operator|(
literal|1
operator|<<
operator|(
name|i
operator|*
literal|3
operator|)
operator|)
operator|*
operator|(
operator|*
name|buf
operator|-
literal|'0'
operator|)
operator|)
expr_stmt|;
block|}
else|else
block|{
return|return
operator|(
literal|0
operator|)
return|;
block|}
block|}
return|return
operator|(
literal|4
operator|)
return|;
case|case
literal|'n'
case|:
comment|/*  */
operator|*
name|work
operator|=
literal|'\n'
expr_stmt|;
return|return
operator|(
literal|1
operator|)
return|;
case|case
literal|'t'
case|:
comment|/* */
operator|*
name|work
operator|=
literal|'\t'
expr_stmt|;
return|return
operator|(
literal|1
operator|)
return|;
case|case
literal|'b'
case|:
comment|/* */
operator|*
name|work
operator|=
literal|'\b'
expr_stmt|;
return|return
operator|(
literal|1
operator|)
return|;
case|case
literal|'r'
case|:
comment|/* */
operator|*
name|work
operator|=
literal|'\r'
expr_stmt|;
return|return
operator|(
literal|1
operator|)
return|;
case|case
literal|'f'
case|:
comment|/* */
operator|*
name|work
operator|=
literal|'\f'
expr_stmt|;
return|return
operator|(
literal|1
operator|)
return|;
case|case
literal|'e'
case|:
comment|/* */
case|case
literal|'E'
case|:
comment|/* */
operator|*
name|work
operator|=
literal|'\033'
expr_stmt|;
return|return
operator|(
literal|1
operator|)
return|;
case|case
literal|'\\'
case|:
comment|/* */
operator|*
name|work
operator|=
literal|'\\'
expr_stmt|;
return|return
operator|(
literal|1
operator|)
return|;
default|default:
for|for
control|(
operator|*
name|work
operator|=
literal|'\0'
operator|,
name|i
operator|=
literal|2
init|;
name|i
operator|>=
literal|0
condition|;
name|i
operator|--
operator|,
name|buf
operator|++
control|)
block|{
if|if
condition|(
operator|*
name|buf
operator|>=
literal|'0'
operator|&&
operator|*
name|buf
operator|<=
literal|'7'
condition|)
block|{
operator|*
name|work
operator||=
operator|(
operator|(
literal|1
operator|<<
operator|(
name|i
operator|*
literal|3
operator|)
operator|)
operator|*
operator|(
operator|*
name|buf
operator|-
literal|'0'
operator|)
operator|)
expr_stmt|;
block|}
else|else
block|{
return|return
operator|(
operator|*
name|buf
operator|)
return|;
block|}
block|}
return|return
operator|(
literal|3
operator|)
return|;
block|}
block|}
end_function

begin_function
specifier|static
name|XipLocalKeySymTbl
modifier|*
name|get_string
parameter_list|(
name|buf
parameter_list|,
name|tbl
parameter_list|)
specifier|register
name|char
modifier|*
name|buf
decl_stmt|;
name|XipLocalKeySymTbl
modifier|*
name|tbl
decl_stmt|;
block|{
name|XipLocalKeySymTbl
name|work_tbl
index|[
literal|8
index|]
decl_stmt|,
modifier|*
name|p
decl_stmt|,
modifier|*
name|t
decl_stmt|;
name|unsigned
name|char
name|work
index|[
literal|32
index|]
decl_stmt|,
modifier|*
name|str
decl_stmt|;
specifier|register
name|int
name|i
init|=
literal|0
decl_stmt|,
name|total
init|=
literal|0
decl_stmt|,
name|ret
decl_stmt|;
for|for
control|(
name|p
operator|=
name|work_tbl
operator|,
name|total
operator|=
literal|0
init|;
operator|*
name|buf
condition|;
name|p
operator|++
operator|,
name|total
operator|++
operator|,
name|buf
operator|++
control|)
block|{
if|if
condition|(
operator|(
name|buf
operator|=
name|index
argument_list|(
name|buf
argument_list|,
literal|'{'
argument_list|)
operator|)
operator|==
name|NULL
condition|)
block|{
break|break;
block|}
name|buf
operator|++
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
operator|*
name|buf
operator|!=
literal|'}'
condition|;
control|)
block|{
if|if
condition|(
operator|*
name|buf
operator|==
operator|(
name|char
operator|)
literal|0x5c
condition|)
block|{
name|buf
operator|++
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|ret
operator|=
name|parse_bslash
argument_list|(
name|buf
argument_list|,
operator|&
name|work
index|[
name|i
index|]
argument_list|)
operator|)
condition|)
block|{
return|return
operator|(
name|NULL
operator|)
return|;
block|}
name|buf
operator|+=
name|ret
expr_stmt|;
name|i
operator|++
expr_stmt|;
block|}
else|else
block|{
name|work
index|[
name|i
operator|++
index|]
operator|=
operator|*
name|buf
expr_stmt|;
name|buf
operator|++
expr_stmt|;
block|}
if|if
condition|(
operator|!
operator|*
name|buf
condition|)
return|return
operator|(
name|NULL
operator|)
return|;
block|}
if|if
condition|(
name|i
operator|==
literal|0
condition|)
return|return
operator|(
name|NULL
operator|)
return|;
name|work
index|[
name|i
index|]
operator|=
literal|'\0'
expr_stmt|;
name|str
operator|=
operator|(
name|unsigned
name|char
operator|*
operator|)
name|Xmalloc
argument_list|(
name|i
operator|+
literal|1
argument_list|)
expr_stmt|;
name|strcpy
argument_list|(
operator|(
name|char
operator|*
operator|)
name|str
argument_list|,
operator|(
name|char
operator|*
operator|)
name|work
argument_list|)
expr_stmt|;
name|p
operator|->
name|str
operator|=
name|str
expr_stmt|;
name|p
operator|->
name|keysym
operator|=
name|NoSymbol
expr_stmt|;
name|p
operator|->
name|state
operator|=
literal|0
expr_stmt|;
name|total
operator|++
expr_stmt|;
block|}
if|if
condition|(
name|total
operator|<
literal|1
condition|)
return|return
operator|(
name|NULL
operator|)
return|;
name|p
operator|->
name|str
operator|=
name|NULL
expr_stmt|;
name|p
operator|->
name|keysym
operator|=
name|XK_VoidSymbol
expr_stmt|;
name|p
operator|->
name|state
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|tbl
condition|)
block|{
for|for
control|(
name|i
operator|=
literal|0
operator|,
name|t
operator|=
name|tbl
operator|,
name|p
operator|=
name|work_tbl
init|;
name|t
operator|->
name|keysym
operator|!=
name|XK_VoidSymbol
operator|&&
name|i
operator|<
name|total
condition|;
name|i
operator|++
operator|,
name|t
operator|++
operator|,
name|p
operator|++
control|)
block|{
name|t
operator|->
name|str
operator|=
name|p
operator|->
name|str
expr_stmt|;
block|}
block|}
else|else
block|{
name|tbl
operator|=
operator|(
name|XipLocalKeySymTbl
operator|*
operator|)
name|Xmalloc
argument_list|(
operator|(
sizeof|sizeof
argument_list|(
name|XipLocalKeySymTbl
argument_list|)
operator|*
operator|(
name|total
operator|+
literal|1
operator|)
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|tbl
condition|)
return|return
operator|(
name|NULL
operator|)
return|;
name|bcopy
argument_list|(
operator|(
name|char
operator|*
operator|)
name|work_tbl
argument_list|,
operator|(
name|char
operator|*
operator|)
name|tbl
argument_list|,
sizeof|sizeof
argument_list|(
name|XipLocalKeySymTbl
argument_list|)
operator|*
operator|(
name|total
operator|+
literal|1
operator|)
argument_list|)
expr_stmt|;
block|}
return|return
operator|(
name|tbl
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|XipLocalKeySymTbl
modifier|*
name|get_keysym
parameter_list|(
name|buf
parameter_list|,
name|len
parameter_list|)
name|char
modifier|*
name|buf
decl_stmt|;
name|int
modifier|*
name|len
decl_stmt|;
block|{
name|int
name|cnt
decl_stmt|,
name|total
init|=
literal|0
decl_stmt|;
name|int
name|i
decl_stmt|;
name|XipLocalKeySymTbl
name|work_tbl
index|[
literal|8
index|]
decl_stmt|,
modifier|*
name|keysym_tbl
decl_stmt|,
modifier|*
name|p
decl_stmt|;
name|char
modifier|*
name|k
index|[
literal|8
index|]
decl_stmt|;
operator|*
name|len
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|cnt
operator|=
literal|0
init|;
condition|;
name|cnt
operator|++
control|)
block|{
if|if
condition|(
operator|(
name|buf
operator|=
name|index
argument_list|(
name|buf
argument_list|,
literal|'<'
argument_list|)
operator|)
operator|==
name|NULL
condition|)
block|{
break|break;
block|}
name|k
index|[
name|cnt
index|]
operator|=
operator|++
name|buf
expr_stmt|;
if|if
condition|(
name|buf
operator|=
name|index
argument_list|(
name|buf
argument_list|,
literal|'>'
argument_list|)
condition|)
block|{
operator|*
name|buf
operator|=
literal|'\0'
expr_stmt|;
name|buf
operator|++
expr_stmt|;
block|}
block|}
if|if
condition|(
name|cnt
operator|<
literal|1
condition|)
return|return
operator|(
name|NULL
operator|)
return|;
for|for
control|(
name|i
operator|=
literal|0
operator|,
name|p
operator|=
name|work_tbl
operator|,
name|total
operator|=
literal|0
init|;
name|i
operator|<
name|cnt
condition|;
name|i
operator|++
operator|,
name|p
operator|++
control|)
block|{
if|if
condition|(
name|p
operator|->
name|state
operator|=
name|is_state
argument_list|(
name|k
index|[
name|i
index|]
argument_list|)
condition|)
block|{
name|i
operator|++
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|p
operator|->
name|keysym
operator|=
name|XStringToKeysym
argument_list|(
name|k
index|[
name|i
index|]
argument_list|)
operator|)
operator|==
literal|0
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Can't convert to KeySym \"%s\"."
argument_list|,
name|k
index|[
name|i
index|]
argument_list|)
expr_stmt|;
return|return
operator|(
name|NULL
operator|)
return|;
block|}
name|p
operator|->
name|str
operator|=
name|NULL
expr_stmt|;
name|total
operator|++
expr_stmt|;
block|}
name|p
operator|->
name|keysym
operator|=
name|XK_VoidSymbol
expr_stmt|;
name|p
operator|->
name|str
operator|=
name|NULL
expr_stmt|;
name|total
operator|++
expr_stmt|;
name|keysym_tbl
operator|=
operator|(
name|XipLocalKeySymTbl
operator|*
operator|)
name|Xmalloc
argument_list|(
operator|(
sizeof|sizeof
argument_list|(
name|XipLocalKeySymTbl
argument_list|)
operator|*
name|total
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|keysym_tbl
condition|)
return|return
operator|(
name|NULL
operator|)
return|;
name|bcopy
argument_list|(
operator|(
name|char
operator|*
operator|)
name|work_tbl
argument_list|,
operator|(
name|char
operator|*
operator|)
name|keysym_tbl
argument_list|,
sizeof|sizeof
argument_list|(
name|XipLocalKeySymTbl
argument_list|)
operator|*
name|total
argument_list|)
expr_stmt|;
operator|*
name|len
operator|=
operator|(
name|total
operator|-
literal|1
operator|)
expr_stmt|;
return|return
operator|(
name|keysym_tbl
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|is_comment
parameter_list|(
name|c
parameter_list|)
name|char
name|c
decl_stmt|;
block|{
if|if
condition|(
name|c
operator|==
literal|'#'
condition|)
return|return
operator|(
literal|1
operator|)
return|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|is_command
parameter_list|(
name|c
parameter_list|)
name|char
name|c
decl_stmt|;
block|{
if|if
condition|(
name|c
operator|!=
literal|'<'
operator|&&
name|c
operator|!=
literal|'{'
condition|)
return|return
operator|(
literal|1
operator|)
return|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|is_keysym
parameter_list|(
name|c
parameter_list|)
name|char
name|c
decl_stmt|;
block|{
if|if
condition|(
name|c
operator|==
literal|'<'
condition|)
return|return
operator|(
literal|1
operator|)
return|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|is_state_command
parameter_list|(
name|xcvt
parameter_list|,
name|f
parameter_list|,
name|t
parameter_list|)
name|XipLocalCvt
modifier|*
name|xcvt
decl_stmt|;
name|char
modifier|*
name|f
decl_stmt|,
decl|*
name|t
decl_stmt|;
end_function

begin_block
block|{
if|if
condition|(
operator|!
operator|*
name|f
operator|||
operator|!
operator|*
name|t
condition|)
return|return
operator|(
literal|0
operator|)
return|;
if|if
condition|(
operator|!
name|strcmp
argument_list|(
name|f
argument_list|,
literal|"InitialState"
argument_list|)
condition|)
if|if
condition|(
operator|!
name|strcmp
argument_list|(
name|t
argument_list|,
literal|"OnState"
argument_list|)
condition|)
name|xcvt
operator|->
name|off
operator|=
name|False
expr_stmt|;
elseif|else
if|if
condition|(
operator|!
name|strcmp
argument_list|(
name|t
argument_list|,
literal|"OffState"
argument_list|)
condition|)
name|xcvt
operator|->
name|off
operator|=
name|True
expr_stmt|;
else|else
return|return
operator|(
literal|0
operator|)
return|;
return|return
operator|(
literal|1
operator|)
return|;
block|}
end_block

begin_function
specifier|static
name|FuncTbl
modifier|*
name|get_command
parameter_list|(
name|name
parameter_list|)
name|char
modifier|*
name|name
decl_stmt|;
block|{
specifier|register
name|FuncTbl
modifier|*
name|p
decl_stmt|;
for|for
control|(
name|p
operator|=
name|func_tbl
init|;
name|p
operator|->
name|name
condition|;
name|p
operator|++
control|)
block|{
if|if
condition|(
operator|!
name|strcmp
argument_list|(
name|p
operator|->
name|name
argument_list|,
name|name
argument_list|)
condition|)
block|{
return|return
operator|(
name|p
operator|)
return|;
block|}
block|}
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Sorry, \"%s\" is not a supported command.\n"
argument_list|,
name|name
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"XIM supported commands are \n"
argument_list|)
expr_stmt|;
for|for
control|(
name|p
operator|=
name|func_tbl
init|;
name|p
operator|->
name|name
condition|;
name|p
operator|++
control|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|" %s \n"
argument_list|,
name|p
operator|->
name|name
argument_list|)
expr_stmt|;
block|}
return|return
operator|(
name|NULL
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|Bool
name|convert_on
parameter_list|(
name|xcvt
parameter_list|)
name|XipLocalCvt
modifier|*
name|xcvt
decl_stmt|;
block|{
name|xcvt
operator|->
name|off
operator|=
name|False
expr_stmt|;
return|return
operator|(
literal|1
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|Bool
name|convert_off
parameter_list|(
name|xcvt
parameter_list|)
name|XipLocalCvt
modifier|*
name|xcvt
decl_stmt|;
block|{
name|xcvt
operator|->
name|off
operator|=
name|True
expr_stmt|;
return|return
operator|(
name|True
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|convert_on_init
parameter_list|(
name|xcvt
parameter_list|,
name|tbl
parameter_list|,
name|len
parameter_list|)
name|XipLocalCvt
modifier|*
name|xcvt
decl_stmt|;
name|XipLocalCvtTbl
modifier|*
name|tbl
decl_stmt|;
name|int
name|len
decl_stmt|;
block|{
specifier|register
name|XipLocalKeySymTbl
modifier|*
name|to
decl_stmt|,
modifier|*
name|from
decl_stmt|,
modifier|*
name|p
decl_stmt|;
name|p
operator|=
operator|(
name|XipLocalKeySymTbl
operator|*
operator|)
name|Xmalloc
argument_list|(
sizeof|sizeof
argument_list|(
name|XipLocalKeySymTbl
argument_list|)
operator|*
operator|(
name|len
operator|+
literal|1
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|p
condition|)
return|return
operator|(
operator|-
literal|1
operator|)
return|;
for|for
control|(
name|to
operator|=
name|p
operator|,
name|from
operator|=
name|tbl
operator|->
name|fromkey
init|;
name|len
operator|>
literal|0
condition|;
name|to
operator|++
operator|,
name|from
operator|++
operator|,
name|len
operator|--
control|)
block|{
name|to
operator|->
name|keysym
operator|=
name|from
operator|->
name|keysym
expr_stmt|;
name|to
operator|->
name|state
operator|=
name|from
operator|->
name|state
expr_stmt|;
block|}
name|to
operator|->
name|keysym
operator|=
name|XK_VoidSymbol
expr_stmt|;
name|to
operator|->
name|state
operator|=
literal|0
expr_stmt|;
name|xcvt
operator|->
name|off_tbl
operator|.
name|to
operator|.
name|func
operator|=
name|tbl
operator|->
name|to
operator|.
name|func
expr_stmt|;
name|xcvt
operator|->
name|off_tbl
operator|.
name|com
operator|=
name|True
expr_stmt|;
name|xcvt
operator|->
name|off_tbl
operator|.
name|fromkey
operator|=
name|p
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|no_filter
parameter_list|(
name|xcvt
parameter_list|,
name|tbl
parameter_list|,
name|len
parameter_list|)
name|XipLocalCvt
modifier|*
name|xcvt
decl_stmt|;
name|XipLocalCvtTbl
modifier|*
name|tbl
decl_stmt|;
name|int
name|len
decl_stmt|;
block|{
name|XipLocalNestedKeySym
modifier|*
name|nested_keysym
decl_stmt|;
name|nested_keysym
operator|=
operator|(
name|XipLocalNestedKeySym
operator|*
operator|)
name|Xmalloc
argument_list|(
sizeof|sizeof
argument_list|(
name|XipLocalNestedKeySym
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|nested_keysym
condition|)
return|return
operator|(
operator|-
literal|1
operator|)
return|;
name|nested_keysym
operator|->
name|keysym
operator|=
name|tbl
operator|->
name|fromkey
operator|->
name|keysym
expr_stmt|;
name|nested_keysym
operator|->
name|next
operator|=
name|xcvt
operator|->
name|no_filter
expr_stmt|;
name|xcvt
operator|->
name|no_filter
operator|=
name|nested_keysym
expr_stmt|;
return|return
operator|(
literal|1
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|Bool
name|is_nofilter
parameter_list|(
name|xcvt
parameter_list|,
name|keysym
parameter_list|)
name|XipLocalCvt
modifier|*
name|xcvt
decl_stmt|;
name|KeySym
name|keysym
decl_stmt|;
block|{
name|XipLocalNestedKeySym
modifier|*
name|p
decl_stmt|;
for|for
control|(
name|p
operator|=
name|xcvt
operator|->
name|no_filter
init|;
name|p
condition|;
name|p
operator|=
name|p
operator|->
name|next
control|)
block|{
if|if
condition|(
name|p
operator|->
name|keysym
operator|==
name|keysym
condition|)
return|return
operator|(
name|True
operator|)
return|;
block|}
return|return
operator|(
name|False
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|FILE
modifier|*
name|open_convert_file
parameter_list|(
name|lang
parameter_list|,
name|filename
parameter_list|)
name|char
modifier|*
name|lang
decl_stmt|;
name|char
modifier|*
name|filename
decl_stmt|;
block|{
name|FILE
modifier|*
name|fp
decl_stmt|;
name|char
name|nlspath
index|[
name|PATH_MAX
index|]
decl_stmt|;
name|char
modifier|*
name|path
decl_stmt|;
name|char
modifier|*
name|dir
decl_stmt|;
name|char
modifier|*
name|env
decl_stmt|;
if|if
condition|(
operator|(
name|env
operator|=
name|getenv
argument_list|(
literal|"XNLSPATH"
argument_list|)
operator|)
operator|==
name|NULL
condition|)
block|{
name|env
operator|=
name|XNLSPATHDEFAULT
expr_stmt|;
block|}
name|path
operator|=
name|nlspath
expr_stmt|;
name|strcpy
argument_list|(
name|path
argument_list|,
name|env
argument_list|)
expr_stmt|;
while|while
condition|(
literal|1
condition|)
block|{
if|if
condition|(
name|path
operator|==
name|NULL
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"%s \"%s\".\n%s%s%s.\n"
argument_list|,
literal|"XIM: Couldn't find any convert table for lang"
argument_list|,
name|lang
argument_list|,
literal|"Please, create xnls_dir"
argument_list|,
name|LOCAL_CVT_TBL_DIR
argument_list|,
name|lang
argument_list|)
expr_stmt|;
return|return
operator|(
name|NULL
operator|)
return|;
block|}
name|dir
operator|=
name|path
expr_stmt|;
if|if
condition|(
operator|(
name|dir
operator|=
name|index
argument_list|(
name|dir
argument_list|,
literal|':'
argument_list|)
operator|)
operator|!=
name|NULL
condition|)
block|{
operator|*
name|dir
operator|++
operator|=
literal|'\0'
expr_stmt|;
block|}
name|strcpy
argument_list|(
name|filename
argument_list|,
name|path
argument_list|)
expr_stmt|;
name|strcat
argument_list|(
name|filename
argument_list|,
name|LOCAL_CVT_TBL_DIR
argument_list|)
expr_stmt|;
name|strcat
argument_list|(
name|filename
argument_list|,
name|lang
argument_list|)
expr_stmt|;
if|if
condition|(
name|fp
operator|=
name|fopen
argument_list|(
name|filename
argument_list|,
literal|"r"
argument_list|)
condition|)
block|{
return|return
operator|(
name|fp
operator|)
return|;
block|}
name|path
operator|=
name|dir
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|XipLocalCvt
modifier|*
name|_XipLocalCvtSetUp
parameter_list|(
name|xlc
parameter_list|)
name|XLocale
name|xlc
decl_stmt|;
block|{
name|char
name|filename
index|[
name|PATH_MAX
index|]
decl_stmt|;
name|char
name|tmp_buf
index|[
literal|32
index|]
decl_stmt|,
modifier|*
name|p
decl_stmt|;
name|FILE
modifier|*
name|fp
decl_stmt|;
name|char
name|buf
index|[
literal|256
index|]
decl_stmt|,
name|tobuf
index|[
literal|256
index|]
decl_stmt|,
name|frombuf
index|[
literal|256
index|]
decl_stmt|,
name|tostr
index|[
literal|256
index|]
decl_stmt|;
name|int
name|cnt
init|=
literal|0
decl_stmt|;
name|int
name|len
decl_stmt|;
name|int
name|k
decl_stmt|;
name|XipLocalCvt
modifier|*
name|cvt
decl_stmt|;
name|KeySym
name|bs
decl_stmt|;
name|FuncTbl
modifier|*
name|func_tbl
decl_stmt|;
name|int
name|line
init|=
literal|0
decl_stmt|;
name|int
name|ret
decl_stmt|;
name|strcpy
argument_list|(
name|tmp_buf
argument_list|,
name|xlc
operator|->
name|xlc_db
operator|->
name|lc_name
argument_list|)
expr_stmt|;
for|for
control|(
name|p
operator|=
name|tmp_buf
init|;
operator|*
name|p
operator|&&
operator|*
name|p
operator|!=
literal|'@'
condition|;
name|p
operator|++
control|)
empty_stmt|;
if|if
condition|(
operator|*
name|p
condition|)
operator|*
name|p
operator|=
literal|'\0'
expr_stmt|;
if|if
condition|(
name|CHANGE_MAX
operator|<
name|div_up
argument_list|(
name|ENTRY_CNT
argument_list|,
name|BITSIZ
argument_list|)
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"XIM: %s%s%d%s"
argument_list|,
literal|"Sorry, please set CHANGE_MAX(in file "
argument_list|,
literal|"Xi18nint.h) larger than "
argument_list|,
name|div_up
argument_list|(
name|ENTRY_CNT
argument_list|,
name|BITSIZ
argument_list|)
operator|-
literal|1
argument_list|,
literal|",\r\nand recompile.\r\n"
argument_list|)
expr_stmt|;
return|return
operator|(
name|NULL
operator|)
return|;
block|}
if|if
condition|(
operator|!
operator|(
name|fp
operator|=
name|open_convert_file
argument_list|(
name|tmp_buf
argument_list|,
name|filename
argument_list|)
operator|)
condition|)
return|return
operator|(
name|NULL
operator|)
return|;
if|if
condition|(
operator|!
operator|(
name|cvt
operator|=
operator|(
name|XipLocalCvt
operator|*
operator|)
name|Xmalloc
argument_list|(
sizeof|sizeof
argument_list|(
name|XipLocalCvt
argument_list|)
argument_list|)
operator|)
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"XIM: Malloc failed\n"
argument_list|)
expr_stmt|;
goto|goto
name|_err_ret2
goto|;
block|}
if|if
condition|(
operator|!
operator|(
name|cvt
operator|->
name|tbl
operator|=
operator|(
name|XipLocalCvtTbl
operator|*
operator|)
name|Xmalloc
argument_list|(
sizeof|sizeof
argument_list|(
name|XipLocalCvtTbl
argument_list|)
operator|*
name|ENTRY_CNT
argument_list|)
operator|)
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"XIM: Malloc failed\n"
argument_list|)
expr_stmt|;
goto|goto
name|_err_ret1
goto|;
block|}
name|cnt
operator|=
literal|0
expr_stmt|;
name|cvt
operator|->
name|nmax
operator|=
literal|0
expr_stmt|;
name|cvt
operator|->
name|no_filter
operator|=
name|NULL
expr_stmt|;
name|cvt
operator|->
name|off
operator|=
name|False
expr_stmt|;
while|while
condition|(
name|fgets
argument_list|(
name|buf
argument_list|,
name|BUFSIZ
argument_list|,
name|fp
argument_list|)
condition|)
block|{
name|line
operator|++
expr_stmt|;
if|if
condition|(
name|is_comment
argument_list|(
operator|*
name|buf
argument_list|)
operator|||
operator|(
name|k
operator|=
name|sscanf
argument_list|(
name|buf
argument_list|,
literal|"%s %s %s"
argument_list|,
name|frombuf
argument_list|,
name|tobuf
argument_list|,
name|tostr
argument_list|)
operator|)
operator|<=
literal|0
condition|)
continue|continue;
if|if
condition|(
name|k
operator|<
literal|2
condition|)
block|{
goto|goto
name|_err_ret
goto|;
block|}
if|if
condition|(
operator|!
operator|(
name|cvt
operator|->
name|tbl
index|[
name|cnt
index|]
operator|.
name|fromkey
operator|=
name|get_keysym
argument_list|(
name|frombuf
argument_list|,
operator|&
name|len
argument_list|)
operator|)
condition|)
block|{
if|if
condition|(
operator|!
name|is_state_command
argument_list|(
name|cvt
argument_list|,
name|frombuf
argument_list|,
name|tobuf
argument_list|)
condition|)
goto|goto
name|_err_ret
goto|;
continue|continue;
block|}
if|if
condition|(
name|len
operator|>
name|cvt
operator|->
name|nmax
condition|)
name|cvt
operator|->
name|nmax
operator|=
name|len
expr_stmt|;
if|if
condition|(
name|is_command
argument_list|(
operator|*
name|tobuf
argument_list|)
condition|)
block|{
if|if
condition|(
operator|!
operator|(
name|func_tbl
operator|=
name|get_command
argument_list|(
name|tobuf
argument_list|)
operator|)
condition|)
block|{
goto|goto
name|_err_ret
goto|;
block|}
name|cvt
operator|->
name|tbl
index|[
name|cnt
index|]
operator|.
name|to
operator|.
name|func
operator|=
name|func_tbl
operator|->
name|func
expr_stmt|;
name|cvt
operator|->
name|tbl
index|[
name|cnt
index|]
operator|.
name|com
operator|=
name|True
expr_stmt|;
if|if
condition|(
name|func_tbl
operator|->
name|init_func
condition|)
block|{
if|if
condition|(
operator|(
name|ret
operator|=
call|(
modifier|*
name|func_tbl
operator|->
name|init_func
call|)
argument_list|(
name|cvt
argument_list|,
operator|&
name|cvt
operator|->
name|tbl
index|[
name|cnt
index|]
argument_list|,
name|len
argument_list|)
operator|)
operator|==
operator|-
literal|1
condition|)
goto|goto
name|_err_ret
goto|;
elseif|else
if|if
condition|(
name|ret
operator|==
literal|0
condition|)
continue|continue;
block|}
block|}
else|else
block|{
if|if
condition|(
name|is_keysym
argument_list|(
operator|*
name|tobuf
argument_list|)
condition|)
block|{
if|if
condition|(
operator|!
operator|(
name|cvt
operator|->
name|tbl
index|[
name|cnt
index|]
operator|.
name|to
operator|.
name|tokey
operator|=
name|get_keysym
argument_list|(
name|tobuf
argument_list|,
operator|&
name|len
argument_list|)
operator|)
condition|)
block|{
goto|goto
name|_err_ret
goto|;
block|}
if|if
condition|(
name|k
operator|>
literal|2
condition|)
block|{
if|if
condition|(
operator|!
operator|(
name|get_string
argument_list|(
name|tostr
argument_list|,
name|cvt
operator|->
name|tbl
index|[
name|cnt
index|]
operator|.
name|to
operator|.
name|tokey
argument_list|)
operator|)
condition|)
block|{
goto|goto
name|_err_ret
goto|;
block|}
block|}
block|}
else|else
block|{
if|if
condition|(
operator|!
operator|(
name|cvt
operator|->
name|tbl
index|[
name|cnt
index|]
operator|.
name|to
operator|.
name|tokey
operator|=
name|get_string
argument_list|(
name|tobuf
argument_list|,
name|NULL
argument_list|)
operator|)
condition|)
block|{
goto|goto
name|_err_ret
goto|;
block|}
block|}
name|cvt
operator|->
name|tbl
index|[
name|cnt
index|]
operator|.
name|com
operator|=
name|False
expr_stmt|;
block|}
name|cnt
operator|++
expr_stmt|;
block|}
name|cvt
operator|->
name|cnt
operator|=
name|cnt
expr_stmt|;
name|cvt
operator|->
name|buf
operator|=
operator|(
name|XipLocalKeySymTbl
operator|*
operator|)
name|Xmalloc
argument_list|(
sizeof|sizeof
argument_list|(
name|XipLocalKeySymTbl
argument_list|)
operator|*
operator|(
name|cvt
operator|->
name|nmax
operator|+
literal|1
operator|)
argument_list|)
expr_stmt|;
name|cvt
operator|->
name|buf_cnt
operator|=
literal|0
expr_stmt|;
name|cvt
operator|->
name|bs
operator|=
operator|(
operator|(
name|bs
operator|=
name|XStringToKeysym
argument_list|(
literal|"BackSpace"
argument_list|)
operator|)
condition|?
name|bs
else|:
literal|0x8
operator|)
expr_stmt|;
name|fclose
argument_list|(
name|fp
argument_list|)
expr_stmt|;
return|return
operator|(
name|cvt
operator|)
return|;
name|_err_ret
label|:
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"XIM: Error occurred at line %d in file \"%s\".\n"
argument_list|,
name|line
argument_list|,
name|filename
argument_list|)
expr_stmt|;
name|Xfree
argument_list|(
name|cvt
operator|->
name|tbl
argument_list|)
expr_stmt|;
name|_err_ret1
label|:
name|Xfree
argument_list|(
name|cvt
argument_list|)
expr_stmt|;
name|_err_ret2
label|:
name|fclose
argument_list|(
name|fp
argument_list|)
expr_stmt|;
return|return
operator|(
name|NULL
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|XipLocalCvt
modifier|*
name|_XipLocalDupCvt
parameter_list|(
name|cvt
parameter_list|)
name|XipLocalCvt
modifier|*
name|cvt
decl_stmt|;
block|{
name|XipLocalCvt
modifier|*
name|new
decl_stmt|;
if|if
condition|(
operator|!
operator|(
name|new
operator|=
operator|(
name|XipLocalCvt
operator|*
operator|)
name|Xmalloc
argument_list|(
sizeof|sizeof
argument_list|(
name|XipLocalCvt
argument_list|)
argument_list|)
operator|)
condition|)
block|{
return|return
operator|(
name|NULL
operator|)
return|;
block|}
name|new
operator|->
name|tbl
operator|=
name|cvt
operator|->
name|tbl
expr_stmt|;
name|new
operator|->
name|off_tbl
operator|=
name|cvt
operator|->
name|off_tbl
expr_stmt|;
name|new
operator|->
name|no_filter
operator|=
name|cvt
operator|->
name|no_filter
expr_stmt|;
name|new
operator|->
name|bs
operator|=
name|cvt
operator|->
name|bs
expr_stmt|;
name|new
operator|->
name|cnt
operator|=
name|cvt
operator|->
name|cnt
expr_stmt|;
name|new
operator|->
name|nmax
operator|=
name|cvt
operator|->
name|nmax
expr_stmt|;
name|new
operator|->
name|buf
operator|=
operator|(
name|XipLocalKeySymTbl
operator|*
operator|)
name|Xmalloc
argument_list|(
sizeof|sizeof
argument_list|(
name|XipLocalKeySymTbl
argument_list|)
operator|*
operator|(
name|new
operator|->
name|nmax
operator|+
literal|1
operator|)
argument_list|)
expr_stmt|;
name|new
operator|->
name|buf_cnt
operator|=
literal|0
expr_stmt|;
name|new
operator|->
name|off
operator|=
name|cvt
operator|->
name|off
expr_stmt|;
return|return
operator|(
name|new
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|_XipLocalFreeCvt
parameter_list|(
name|cvt
parameter_list|)
name|XipLocalCvt
modifier|*
name|cvt
decl_stmt|;
block|{
specifier|register
name|int
name|i
decl_stmt|,
name|j
decl_stmt|;
name|XipLocalCvtTbl
modifier|*
name|tbl
decl_stmt|;
name|tbl
operator|=
name|cvt
operator|->
name|tbl
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|cvt
operator|->
name|cnt
condition|;
name|i
operator|++
operator|,
name|tbl
operator|++
control|)
block|{
name|Xfree
argument_list|(
operator|(
operator|*
name|tbl
operator|)
operator|.
name|fromkey
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
operator|*
name|tbl
operator|)
operator|.
name|com
operator|!=
name|True
condition|)
block|{
for|for
control|(
name|j
operator|=
literal|0
init|;
operator|(
operator|*
name|tbl
operator|)
operator|.
name|to
operator|.
name|tokey
index|[
name|j
index|]
operator|.
name|str
condition|;
name|j
operator|++
control|)
name|Xfree
argument_list|(
operator|(
operator|*
name|tbl
operator|)
operator|.
name|to
operator|.
name|tokey
index|[
name|j
index|]
operator|.
name|str
argument_list|)
expr_stmt|;
name|Xfree
argument_list|(
operator|(
operator|*
name|tbl
operator|)
operator|.
name|to
operator|.
name|tokey
argument_list|)
expr_stmt|;
block|}
block|}
name|Xfree
argument_list|(
name|cvt
operator|->
name|tbl
argument_list|)
expr_stmt|;
name|Xfree
argument_list|(
name|cvt
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * Close the connection to the input manager, and free the private data  */
end_comment

begin_function
specifier|static
name|Status
name|_XipLocalCloseIM
parameter_list|(
name|supim
parameter_list|)
name|XIM
name|supim
decl_stmt|;
block|{
name|XipLocalIM
name|im
init|=
operator|(
name|XipLocalIM
operator|)
name|supim
decl_stmt|;
name|_XlcFreeLocale
argument_list|(
name|im
operator|->
name|xlc
argument_list|)
expr_stmt|;
if|if
condition|(
name|im
operator|->
name|xcvt
condition|)
name|_XipLocalFreeCvt
argument_list|(
name|im
operator|->
name|xcvt
argument_list|)
expr_stmt|;
return|return
operator|(
name|Success
operator|)
return|;
block|}
end_function

begin_decl_stmt
specifier|static
name|RConst
name|XIMMethodsRec
name|im_methods
init|=
block|{
name|_XipLocalCloseIM
block|,
name|_XipLocalGetIMValues
block|,
name|_XipLocalCreateIC
block|}
decl_stmt|;
end_decl_stmt

begin_function
name|XIM
name|_XipLocalOpenIM
parameter_list|(
name|lcd
parameter_list|,
name|display
parameter_list|,
name|rdb
parameter_list|,
name|res_name
parameter_list|,
name|res_class
parameter_list|)
name|XLCd
name|lcd
decl_stmt|;
name|Display
modifier|*
name|display
decl_stmt|;
name|XrmDatabase
name|rdb
decl_stmt|;
name|char
modifier|*
name|res_name
decl_stmt|;
name|char
modifier|*
name|res_class
decl_stmt|;
block|{
name|XipLocalIM
name|xim
decl_stmt|;
name|XLocale
name|xlc
init|=
operator|(
operator|(
name|XsiLCd
operator|)
name|lcd
operator|)
operator|->
name|xlc
decl_stmt|;
name|XipLocalCvt
modifier|*
name|xcvt
decl_stmt|;
name|XIMStyle
modifier|*
name|supported_styles
decl_stmt|;
if|if
condition|(
operator|(
name|xcvt
operator|=
name|_XipLocalCvtSetUp
argument_list|(
name|xlc
argument_list|)
operator|)
operator|==
name|NULL
condition|)
return|return
operator|(
name|NULL
operator|)
return|;
comment|/*      * Attempt to allocate a XIM structure. Return NULL if allocation      * failed.      */
if|if
condition|(
operator|(
name|xim
operator|=
operator|(
name|XipLocalIM
operator|)
name|Xmalloc
argument_list|(
sizeof|sizeof
argument_list|(
name|XipLocalIMRec
argument_list|)
argument_list|)
operator|)
operator|==
name|NULL
condition|)
block|{
return|return
operator|(
name|NULL
operator|)
return|;
block|}
name|xim
operator|->
name|methods
operator|=
operator|(
name|XIMMethods
operator|)
operator|&
name|im_methods
expr_stmt|;
name|xim
operator|->
name|core
operator|.
name|lcd
operator|=
name|lcd
expr_stmt|;
name|xim
operator|->
name|core
operator|.
name|ic_chain
operator|=
name|NULL
expr_stmt|;
name|xim
operator|->
name|core
operator|.
name|display
operator|=
name|display
expr_stmt|;
name|xim
operator|->
name|core
operator|.
name|rdb
operator|=
name|rdb
expr_stmt|;
name|xim
operator|->
name|core
operator|.
name|res_name
operator|=
name|res_name
expr_stmt|;
name|xim
operator|->
name|core
operator|.
name|res_class
operator|=
name|res_class
expr_stmt|;
if|if
condition|(
operator|!
name|compiled_resources
condition|)
block|{
name|_XIMCompileResourceList
argument_list|(
name|im_resources
argument_list|,
name|XIMNumber
argument_list|(
name|im_resources
argument_list|)
argument_list|)
expr_stmt|;
name|_XIMCompileResourceList
argument_list|(
name|ic_resources
argument_list|,
name|XIMNumber
argument_list|(
name|ic_resources
argument_list|)
argument_list|)
expr_stmt|;
name|_XIMCompileResourceList
argument_list|(
name|attr_resources
argument_list|,
name|XIMNumber
argument_list|(
name|attr_resources
argument_list|)
argument_list|)
expr_stmt|;
name|compiled_resources
operator|=
literal|1
expr_stmt|;
block|}
name|xim
operator|->
name|resources
operator|=
operator|(
name|XIMrmResourceList
operator|)
name|im_resources
expr_stmt|;
name|xim
operator|->
name|num_resources
operator|=
name|XIMNumber
argument_list|(
name|im_resources
argument_list|)
expr_stmt|;
name|xim
operator|->
name|core
operator|.
name|ic_resources
operator|=
operator|(
name|XIMrmResourceList
operator|)
name|ic_resources
expr_stmt|;
name|xim
operator|->
name|core
operator|.
name|ic_num_resources
operator|=
name|XIMNumber
argument_list|(
name|ic_resources
argument_list|)
expr_stmt|;
name|xim
operator|->
name|core
operator|.
name|ic_attr_resources
operator|=
operator|(
name|XIMrmResourceList
operator|)
name|attr_resources
expr_stmt|;
name|xim
operator|->
name|core
operator|.
name|ic_num_attr_resources
operator|=
name|XIMNumber
argument_list|(
name|attr_resources
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|supported_styles
operator|=
operator|(
name|XIMStyle
operator|*
operator|)
name|Xmalloc
argument_list|(
call|(
name|unsigned
call|)
argument_list|(
sizeof|sizeof
argument_list|(
name|XIMStyle
argument_list|)
argument_list|)
argument_list|)
operator|)
operator|==
name|NULL
condition|)
block|{
return|return
operator|(
name|NULL
operator|)
return|;
block|}
name|supported_styles
index|[
literal|0
index|]
operator|=
operator|(
name|XIMPreeditNothing
operator||
name|XIMStatusNothing
operator|)
expr_stmt|;
name|xim
operator|->
name|values
operator|.
name|input_styles
operator|.
name|supported_styles
operator|=
name|supported_styles
expr_stmt|;
name|xim
operator|->
name|values
operator|.
name|input_styles
operator|.
name|count_styles
operator|=
literal|1
expr_stmt|;
name|xim
operator|->
name|xlc
operator|=
name|_XlcDupLocale
argument_list|(
name|xlc
argument_list|)
expr_stmt|;
name|xim
operator|->
name|xcvt
operator|=
name|xcvt
expr_stmt|;
return|return
operator|(
operator|(
name|XIM
operator|)
name|xim
operator|)
return|;
block|}
end_function

begin_function
name|int
name|_XipLocalCallCallbacks
parameter_list|(
name|ic
parameter_list|)
name|XipIC
name|ic
decl_stmt|;
block|{
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|key_check
parameter_list|(
name|cvt
parameter_list|)
name|XipLocalCvt
modifier|*
name|cvt
decl_stmt|;
block|{
name|int
name|dist
decl_stmt|,
name|base
decl_stmt|;
name|XipLocalKeySymTbl
modifier|*
name|code_p
decl_stmt|;
name|int
name|i
decl_stmt|;
for|for
control|(
name|base
operator|=
literal|0
init|;
name|cvt
operator|->
name|buf
index|[
name|base
index|]
operator|.
name|keysym
operator|!=
name|XK_VoidSymbol
condition|;
name|base
operator|++
control|)
block|{
for|for
control|(
name|dist
operator|=
literal|0
init|;
name|dist
operator|<
name|cvt
operator|->
name|cnt
condition|;
name|dist
operator|++
control|)
block|{
if|if
condition|(
name|BITONP
argument_list|(
name|cvt
operator|->
name|check_flg
argument_list|,
name|dist
argument_list|)
operator|&&
name|cvt
operator|->
name|tbl
index|[
name|dist
index|]
operator|.
name|fromkey
operator|->
name|keysym
operator|!=
name|XK_VoidSymbol
condition|)
block|{
name|code_p
operator|=
name|cvt
operator|->
name|tbl
index|[
name|dist
index|]
operator|.
name|fromkey
operator|+
name|base
expr_stmt|;
if|if
condition|(
operator|(
name|code_p
operator|->
name|keysym
operator|==
name|cvt
operator|->
name|buf
index|[
name|base
index|]
operator|.
name|keysym
operator|)
operator|&&
operator|(
operator|(
operator|!
operator|(
name|code_p
operator|->
name|state
operator||
operator|(
name|cvt
operator|->
name|buf
index|[
name|base
index|]
operator|.
name|state
operator|&
operator|~
name|ShiftMask
operator|)
operator|)
operator|)
operator|||
operator|(
name|code_p
operator|->
name|state
operator|==
operator|(
name|cvt
operator|->
name|buf
index|[
name|base
index|]
operator|.
name|state
operator|&
operator|~
name|ShiftMask
operator|)
operator|)
operator|)
condition|)
block|{
if|if
condition|(
operator|(
name|code_p
operator|+
literal|1
operator|)
operator|->
name|keysym
operator|==
operator|(
name|KeySym
operator|)
name|XK_VoidSymbol
condition|)
block|{
comment|/* matched */
for|for
control|(
name|i
operator|=
literal|0
operator|,
name|base
operator|++
init|;
operator|(
name|cvt
operator|->
name|buf
index|[
name|i
index|]
operator|.
name|keysym
operator|=
name|cvt
operator|->
name|buf
index|[
name|base
index|]
operator|.
name|keysym
operator|)
operator|!=
name|XK_VoidSymbol
condition|;
name|i
operator|++
operator|,
name|base
operator|++
control|)
empty_stmt|;
return|return
operator|(
name|dist
operator|)
return|;
block|}
comment|/* Not yet matched */
block|}
else|else
block|{
name|BITDWN
argument_list|(
name|cvt
operator|->
name|check_flg
argument_list|,
name|dist
argument_list|)
expr_stmt|;
comment|/* off bit vecter */
block|}
block|}
block|}
block|}
comment|/* Check bit vercters */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|cvt
operator|->
name|cnt
operator|/
name|BITSIZ
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|cvt
operator|->
name|check_flg
index|[
name|i
index|]
condition|)
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
if|if
condition|(
operator|(
name|cvt
operator|->
name|cnt
operator|%
name|BITSIZ
operator|)
operator|&&
operator|(
name|cvt
operator|->
name|check_flg
index|[
name|i
index|]
operator|&
operator|~
operator|(
operator|~
literal|0
operator|<<
operator|(
name|cvt
operator|->
name|cnt
operator|%
name|BITSIZ
operator|)
operator|)
operator|)
condition|)
return|return
operator|(
operator|-
literal|1
operator|)
return|;
comment|/* posiblity */
return|return
operator|(
operator|-
literal|2
operator|)
return|;
comment|/* Not matched */
block|}
end_function

begin_function
specifier|static
name|int
name|off_key_check
parameter_list|(
name|cvt
parameter_list|)
name|XipLocalCvt
modifier|*
name|cvt
decl_stmt|;
block|{
name|int
name|base
decl_stmt|;
name|XipLocalKeySymTbl
modifier|*
name|code_p
init|=
name|cvt
operator|->
name|off_tbl
operator|.
name|fromkey
decl_stmt|;
name|int
name|i
decl_stmt|;
for|for
control|(
name|base
operator|=
literal|0
init|;
name|cvt
operator|->
name|buf
index|[
name|base
index|]
operator|.
name|keysym
operator|!=
name|XK_VoidSymbol
condition|;
name|base
operator|++
control|)
block|{
if|if
condition|(
operator|(
name|code_p
operator|->
name|keysym
operator|==
name|cvt
operator|->
name|buf
index|[
name|base
index|]
operator|.
name|keysym
operator|)
operator|&&
operator|(
operator|(
operator|!
operator|(
name|code_p
operator|->
name|state
operator||
operator|(
name|cvt
operator|->
name|buf
index|[
name|base
index|]
operator|.
name|state
operator|&
operator|~
name|ShiftMask
operator|)
operator|)
operator|)
operator|||
operator|(
name|code_p
operator|->
name|state
operator|==
operator|(
name|cvt
operator|->
name|buf
index|[
name|base
index|]
operator|.
name|state
operator|&
operator|~
name|ShiftMask
operator|)
operator|)
operator|)
condition|)
block|{
if|if
condition|(
operator|(
name|code_p
operator|+
literal|1
operator|)
operator|->
name|keysym
operator|==
operator|(
name|KeySym
operator|)
name|XK_VoidSymbol
condition|)
block|{
comment|/* matched */
for|for
control|(
name|i
operator|=
literal|0
operator|,
name|base
operator|++
init|;
operator|(
name|cvt
operator|->
name|buf
index|[
name|i
index|]
operator|.
name|keysym
operator|=
name|cvt
operator|->
name|buf
index|[
name|base
index|]
operator|.
name|keysym
operator|)
operator|!=
name|XK_VoidSymbol
condition|;
name|i
operator|++
operator|,
name|base
operator|++
control|)
empty_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
block|}
else|else
block|{
return|return
operator|(
operator|-
literal|2
operator|)
return|;
block|}
block|}
return|return
operator|(
operator|-
literal|1
operator|)
return|;
comment|/* posiblity */
block|}
end_function

begin_function
specifier|static
name|void
name|_XipLocalClearCvt
parameter_list|(
name|cvt
parameter_list|)
name|XipLocalCvt
modifier|*
name|cvt
decl_stmt|;
block|{
specifier|register
name|int
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|div_up
argument_list|(
name|cvt
operator|->
name|cnt
argument_list|,
name|BITSIZ
argument_list|)
condition|;
name|cvt
operator|->
name|check_flg
index|[
name|i
operator|++
index|]
operator|=
operator|~
literal|0
control|)
empty_stmt|;
block|}
end_function

begin_function
name|Bool
name|_XipLocalBackEndFilter
parameter_list|(
name|display
parameter_list|,
name|window
parameter_list|,
name|ev
parameter_list|,
name|client_data
parameter_list|)
name|Display
modifier|*
name|display
decl_stmt|;
name|Window
name|window
decl_stmt|;
name|XEvent
modifier|*
name|ev
decl_stmt|;
name|XPointer
name|client_data
decl_stmt|;
block|{
specifier|register
name|XipLocalIC
name|ic
init|=
operator|(
name|XipLocalIC
operator|)
name|client_data
decl_stmt|;
name|XipLocalCvt
modifier|*
name|xcvt
init|=
name|ic
operator|->
name|xcvt
decl_stmt|;
name|KeySym
name|keysym
decl_stmt|;
name|int
name|keycode
decl_stmt|;
name|int
name|i
decl_stmt|,
name|c
decl_stmt|;
comment|/* work */
name|char
name|str
index|[
literal|256
index|]
decl_stmt|;
name|XEvent
name|dummy_ev
decl_stmt|;
if|if
condition|(
name|xcvt
operator|->
name|cnt
operator|==
literal|0
condition|)
return|return
operator|(
name|False
operator|)
return|;
if|if
condition|(
name|ev
operator|->
name|xkey
operator|.
name|keycode
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|_XipTypeOfNextICQueue
argument_list|(
operator|(
name|XipIC
operator|)
name|ic
argument_list|)
operator|==
name|XIM_KEYSYM
condition|)
block|{
if|if
condition|(
operator|(
name|keycode
operator|=
name|XKeysymToKeycode
argument_list|(
name|display
argument_list|,
name|_XipKeySymOfNextICQueue
argument_list|(
operator|(
name|XipIC
operator|)
name|ic
argument_list|)
argument_list|)
operator|)
operator|!=
literal|0
operator|&&
name|_XipStringOfNextICQueue
argument_list|(
operator|(
name|XipIC
operator|)
name|ic
argument_list|)
operator|==
name|NULL
condition|)
block|{
name|ev
operator|->
name|xkey
operator|.
name|state
operator|=
name|_XipStateOfNextICQueue
argument_list|(
operator|(
name|XipIC
operator|)
name|ic
argument_list|)
expr_stmt|;
name|ev
operator|->
name|xkey
operator|.
name|keycode
operator|=
name|keycode
expr_stmt|;
name|_XipFreeNextICQueue
argument_list|(
operator|(
name|XipIC
operator|)
name|ic
argument_list|)
expr_stmt|;
block|}
block|}
return|return
operator|(
name|False
operator|)
return|;
block|}
if|if
condition|(
name|ic
operator|->
name|out
condition|)
name|ic
operator|->
name|out
operator|=
name|NULL
expr_stmt|;
operator|(
name|void
operator|)
name|XLookupString
argument_list|(
name|ev
argument_list|,
name|str
argument_list|,
literal|256
argument_list|,
operator|&
name|keysym
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|keysym
operator|==
name|NoSymbol
comment|/* || nbytes< 1 */
condition|)
block|{
return|return
operator|(
name|True
operator|)
return|;
block|}
if|if
condition|(
name|is_nofilter
argument_list|(
name|xcvt
argument_list|,
name|keysym
argument_list|)
condition|)
return|return
operator|(
name|False
operator|)
return|;
if|if
condition|(
name|keysym
operator|==
name|xcvt
operator|->
name|bs
condition|)
block|{
if|if
condition|(
name|xcvt
operator|->
name|buf_cnt
operator|==
literal|0
condition|)
block|{
return|return
operator|(
name|False
operator|)
return|;
block|}
name|xcvt
operator|->
name|buf
index|[
name|xcvt
operator|->
name|buf_cnt
operator|-
literal|1
index|]
operator|.
name|keysym
operator|=
name|xcvt
operator|->
name|buf
index|[
name|xcvt
operator|->
name|buf_cnt
index|]
operator|.
name|keysym
expr_stmt|;
name|xcvt
operator|->
name|buf
index|[
name|xcvt
operator|->
name|buf_cnt
operator|-
literal|1
index|]
operator|.
name|state
operator|=
name|xcvt
operator|->
name|buf
index|[
name|xcvt
operator|->
name|buf_cnt
index|]
operator|.
name|state
expr_stmt|;
name|_XipLocalClearCvt
argument_list|(
name|xcvt
argument_list|)
expr_stmt|;
if|if
condition|(
operator|--
name|xcvt
operator|->
name|buf_cnt
operator|>
literal|0
condition|)
block|{
name|key_check
argument_list|(
name|xcvt
argument_list|)
expr_stmt|;
block|}
return|return
operator|(
name|True
operator|)
return|;
block|}
if|if
condition|(
name|xcvt
operator|->
name|buf_cnt
operator|==
literal|0
condition|)
block|{
name|_XipLocalClearCvt
argument_list|(
name|xcvt
argument_list|)
expr_stmt|;
block|}
name|xcvt
operator|->
name|buf
index|[
name|xcvt
operator|->
name|buf_cnt
index|]
operator|.
name|keysym
operator|=
name|keysym
expr_stmt|;
name|xcvt
operator|->
name|buf
index|[
name|xcvt
operator|->
name|buf_cnt
index|]
operator|.
name|state
operator|=
name|ev
operator|->
name|xkey
operator|.
name|state
expr_stmt|;
name|xcvt
operator|->
name|buf
index|[
operator|++
name|xcvt
operator|->
name|buf_cnt
index|]
operator|.
name|keysym
operator|=
name|XK_VoidSymbol
expr_stmt|;
name|bcopy
argument_list|(
operator|(
name|char
operator|*
operator|)
name|ev
argument_list|,
operator|(
name|char
operator|*
operator|)
operator|&
name|dummy_ev
argument_list|,
sizeof|sizeof
argument_list|(
name|XEvent
argument_list|)
argument_list|)
expr_stmt|;
name|dummy_ev
operator|.
name|type
operator|=
name|KeyPress
expr_stmt|;
name|dummy_ev
operator|.
name|xkey
operator|.
name|state
operator|=
literal|0
expr_stmt|;
name|dummy_ev
operator|.
name|xkey
operator|.
name|keycode
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|xcvt
operator|->
name|off
operator|==
name|True
condition|)
block|{
if|if
condition|(
operator|(
name|c
operator|=
name|off_key_check
argument_list|(
name|xcvt
argument_list|)
operator|)
operator|==
literal|0
condition|)
block|{
name|xcvt
operator|->
name|buf_cnt
operator|=
literal|0
expr_stmt|;
call|(
modifier|*
name|xcvt
operator|->
name|off_tbl
operator|.
name|to
operator|.
name|func
call|)
argument_list|(
name|xcvt
argument_list|)
expr_stmt|;
name|_XipLocalClearCvt
argument_list|(
name|xcvt
argument_list|)
expr_stmt|;
return|return
operator|(
name|True
operator|)
return|;
block|}
block|}
else|else
block|{
name|c
operator|=
name|key_check
argument_list|(
name|xcvt
argument_list|)
expr_stmt|;
block|}
switch|switch
condition|(
name|c
condition|)
block|{
case|case
operator|-
literal|1
case|:
comment|/* Event was filtered */
return|return
operator|(
name|True
operator|)
return|;
case|case
operator|-
literal|2
case|:
comment|/* No match */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|xcvt
operator|->
name|buf_cnt
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|_XipPutICQueue
argument_list|(
name|ic
argument_list|,
name|XIM_KEYSYM
argument_list|,
literal|0
argument_list|,
name|xcvt
operator|->
name|buf
index|[
name|i
index|]
operator|.
name|keysym
argument_list|,
name|xcvt
operator|->
name|buf
index|[
name|i
index|]
operator|.
name|state
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|)
operator|<
literal|0
condition|)
return|return
operator|(
name|False
operator|)
return|;
block|}
name|ev
operator|->
name|xkey
operator|.
name|state
operator|=
literal|0
expr_stmt|;
name|ev
operator|->
name|xkey
operator|.
name|keycode
operator|=
literal|0
expr_stmt|;
if|if
condition|(
operator|(
name|keycode
operator|=
name|XKeysymToKeycode
argument_list|(
name|display
argument_list|,
name|_XipKeySymOfNextICQueue
argument_list|(
operator|(
name|XipIC
operator|)
name|ic
argument_list|)
argument_list|)
operator|)
operator|!=
literal|0
operator|&&
name|_XipStringOfNextICQueue
argument_list|(
operator|(
name|XipIC
operator|)
name|ic
argument_list|)
operator|==
name|NULL
condition|)
block|{
name|ev
operator|->
name|xkey
operator|.
name|state
operator|=
name|_XipStateOfNextICQueue
argument_list|(
operator|(
name|XipIC
operator|)
name|ic
argument_list|)
expr_stmt|;
name|ev
operator|->
name|xkey
operator|.
name|keycode
operator|=
name|keycode
expr_stmt|;
name|_XipFreeNextICQueue
argument_list|(
operator|(
name|XipIC
operator|)
name|ic
argument_list|)
expr_stmt|;
block|}
for|for
control|(
name|i
operator|=
literal|1
init|;
name|i
operator|<
name|xcvt
operator|->
name|buf_cnt
condition|;
name|i
operator|++
control|)
block|{
name|XPutBackEvent
argument_list|(
name|display
argument_list|,
operator|&
name|dummy_ev
argument_list|)
expr_stmt|;
block|}
name|xcvt
operator|->
name|buf_cnt
operator|=
literal|0
expr_stmt|;
name|_XipLocalClearCvt
argument_list|(
name|xcvt
argument_list|)
expr_stmt|;
return|return
operator|(
name|False
operator|)
return|;
default|default:
comment|/* matched */
name|xcvt
operator|->
name|buf_cnt
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|xcvt
operator|->
name|tbl
index|[
name|c
index|]
operator|.
name|com
operator|==
name|True
condition|)
block|{
if|if
condition|(
operator|(
operator|*
name|xcvt
operator|->
name|tbl
index|[
name|c
index|]
operator|.
name|to
operator|.
name|func
operator|)
operator|(
name|xcvt
operator|)
operator|==
name|True
condition|)
block|{
name|_XipLocalClearCvt
argument_list|(
name|xcvt
argument_list|)
expr_stmt|;
return|return
operator|(
name|True
operator|)
return|;
block|}
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|xcvt
operator|->
name|tbl
index|[
name|c
index|]
operator|.
name|to
operator|.
name|tokey
index|[
name|i
index|]
operator|.
name|keysym
operator|!=
name|XK_VoidSymbol
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|_XipPutICQueue
argument_list|(
name|ic
argument_list|,
name|XIM_KEYSYM
argument_list|,
literal|0
argument_list|,
name|xcvt
operator|->
name|tbl
index|[
name|c
index|]
operator|.
name|to
operator|.
name|tokey
index|[
name|i
index|]
operator|.
name|keysym
argument_list|,
name|xcvt
operator|->
name|tbl
index|[
name|c
index|]
operator|.
name|to
operator|.
name|tokey
index|[
name|i
index|]
operator|.
name|state
argument_list|,
literal|1
argument_list|,
name|xcvt
operator|->
name|tbl
index|[
name|c
index|]
operator|.
name|to
operator|.
name|tokey
index|[
name|i
index|]
operator|.
name|str
argument_list|)
operator|<
literal|0
condition|)
return|return
operator|(
name|False
operator|)
return|;
block|}
name|ev
operator|->
name|xkey
operator|.
name|state
operator|=
literal|0
expr_stmt|;
name|ev
operator|->
name|xkey
operator|.
name|keycode
operator|=
literal|0
expr_stmt|;
if|if
condition|(
operator|(
name|keycode
operator|=
name|XKeysymToKeycode
argument_list|(
name|display
argument_list|,
name|_XipKeySymOfNextICQueue
argument_list|(
operator|(
name|XipIC
operator|)
name|ic
argument_list|)
argument_list|)
operator|)
operator|!=
literal|0
operator|&&
name|_XipStringOfNextICQueue
argument_list|(
operator|(
name|XipIC
operator|)
name|ic
argument_list|)
operator|==
name|NULL
condition|)
block|{
name|ev
operator|->
name|xkey
operator|.
name|state
operator|=
name|_XipStateOfNextICQueue
argument_list|(
operator|(
name|XipIC
operator|)
name|ic
argument_list|)
expr_stmt|;
name|ev
operator|->
name|xkey
operator|.
name|keycode
operator|=
name|keycode
expr_stmt|;
name|_XipFreeNextICQueue
argument_list|(
operator|(
name|XipIC
operator|)
name|ic
argument_list|)
expr_stmt|;
block|}
for|for
control|(
name|i
operator|=
literal|1
init|;
name|xcvt
operator|->
name|tbl
index|[
name|c
index|]
operator|.
name|to
operator|.
name|tokey
index|[
name|i
index|]
operator|.
name|keysym
operator|!=
name|XK_VoidSymbol
condition|;
name|i
operator|++
control|)
block|{
name|XPutBackEvent
argument_list|(
name|display
argument_list|,
operator|&
name|dummy_ev
argument_list|)
expr_stmt|;
block|}
name|xcvt
operator|->
name|buf_cnt
operator|=
literal|0
expr_stmt|;
name|_XipLocalClearCvt
argument_list|(
name|xcvt
argument_list|)
expr_stmt|;
return|return
operator|(
name|False
operator|)
return|;
block|}
block|}
end_function

begin_comment
comment|/*  * Free the input context.  */
end_comment

begin_function
name|void
name|_XipLocalDestroyIC
parameter_list|(
name|supic
parameter_list|)
name|XIC
name|supic
decl_stmt|;
block|{
name|XipLocalIC
name|ic
init|=
operator|(
name|XipLocalIC
operator|)
name|supic
decl_stmt|;
name|XipLocalIM
name|im
init|=
operator|(
name|XipLocalIM
operator|)
name|ic
operator|->
name|core
operator|.
name|im
decl_stmt|;
name|_XUnregisterFilter
argument_list|(
name|im
operator|->
name|core
operator|.
name|display
argument_list|,
name|ic
operator|->
name|core
operator|.
name|focus_window
argument_list|,
name|ic
operator|->
name|prototype_filter
argument_list|,
operator|(
name|XPointer
operator|)
name|ic
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|XML
if|if
condition|(
name|ic
operator|->
name|xlc_num
operator|>
literal|0
condition|)
block|{
name|int
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|ic
operator|->
name|xlc_num
condition|;
name|i
operator|++
control|)
block|{
name|_XlcFreeLocale
argument_list|(
name|ic
operator|->
name|mb_temp
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|_XlcFreeLocale
argument_list|(
name|ic
operator|->
name|wc_temp
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|_XipLocalFreeCvt
argument_list|(
name|ic
operator|->
name|xcvt
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
name|ic
operator|->
name|values
operator|.
name|using_language
condition|)
name|Xfree
argument_list|(
name|ic
operator|->
name|values
operator|.
name|using_language
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* XML */
block|}
end_function

begin_decl_stmt
specifier|static
name|RConst
name|XICMethodsRec
name|ic_methods
init|=
block|{
name|_XipLocalDestroyIC
block|,
name|_XipLocalSetICFocus
block|,
name|_XipLocalUnsetICFocus
block|,
name|_XipLocalSetICValues
block|,
name|_XipLocalGetICValues
block|,
name|_XipLocalmbResetIC
block|,
name|_XipLocalwcResetIC
block|,
name|_XipmbLookupString
block|,
name|_XipwcLookupString
block|}
decl_stmt|;
end_decl_stmt

begin_comment
comment|/*  * Create an input context within the input method,   * and return a pointer the input context ti the caller.  */
end_comment

begin_function
name|XIC
name|_XipLocalCreateIC
parameter_list|(
name|supim
parameter_list|,
name|args
parameter_list|)
name|XIM
name|supim
decl_stmt|;
name|XIMArg
modifier|*
name|args
decl_stmt|;
block|{
name|XipLocalIM
name|im
init|=
operator|(
name|XipLocalIM
operator|)
name|supim
decl_stmt|;
name|XipLocalIC
name|ic
decl_stmt|;
name|unsigned
name|long
name|mask
init|=
literal|0L
decl_stmt|;
ifdef|#
directive|ifdef
name|XML
name|char
modifier|*
modifier|*
name|nls_list
decl_stmt|,
modifier|*
modifier|*
name|l
decl_stmt|;
name|XLocale
name|xlc
decl_stmt|;
endif|#
directive|endif
comment|/* XML */
if|if
condition|(
operator|(
name|ic
operator|=
operator|(
name|XipLocalIC
operator|)
name|Xcalloc
argument_list|(
literal|1
argument_list|,
sizeof|sizeof
argument_list|(
name|XipLocalICRec
argument_list|)
argument_list|)
operator|)
operator|==
name|NULL
condition|)
block|{
return|return
operator|(
name|NULL
operator|)
return|;
block|}
name|ic
operator|->
name|methods
operator|=
operator|(
name|XICMethods
operator|)
operator|&
name|ic_methods
expr_stmt|;
name|ic
operator|->
name|prototype_filter
operator|=
name|_XipLocalBackEndFilter
expr_stmt|;
name|ic
operator|->
name|core
operator|.
name|im
operator|=
name|supim
expr_stmt|;
operator|(
name|void
operator|)
name|_XipICSetValues
argument_list|(
name|ic
argument_list|,
name|args
argument_list|,
operator|&
name|mask
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|XML
if|if
condition|(
name|im
operator|->
name|xlc
operator|!=
name|NULL
condition|)
block|{
endif|#
directive|endif
comment|/* XML */
name|ic
operator|->
name|mb
operator|=
name|_XlcDupLocale
argument_list|(
name|im
operator|->
name|xlc
argument_list|)
expr_stmt|;
name|ic
operator|->
name|wc
operator|=
name|_XlcDupLocale
argument_list|(
name|im
operator|->
name|xlc
argument_list|)
expr_stmt|;
name|ic
operator|->
name|xcvt
operator|=
name|_XipLocalDupCvt
argument_list|(
name|im
operator|->
name|xcvt
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|XML
name|ic
operator|->
name|xlc_num
operator|=
literal|0
expr_stmt|;
name|ic
operator|->
name|mb_temp
operator|=
name|NULL
expr_stmt|;
name|ic
operator|->
name|wc_temp
operator|=
name|NULL
expr_stmt|;
name|ic
operator|->
name|xcvt_temp
operator|=
name|NULL
expr_stmt|;
block|}
else|else
block|{
name|ic
operator|->
name|mb
operator|=
name|NULL
expr_stmt|;
name|ic
operator|->
name|wc
operator|=
name|NULL
expr_stmt|;
name|ic
operator|->
name|xcvt_temp
operator|=
name|NULL
expr_stmt|;
name|ic
operator|->
name|xlc_num
operator|=
literal|0
expr_stmt|;
if|if
condition|(
operator|(
name|ic
operator|->
name|mb_temp
operator|=
operator|(
name|XLocale
operator|*
operator|)
name|Xmalloc
argument_list|(
sizeof|sizeof
argument_list|(
name|XLocale
argument_list|)
operator|*
literal|32
argument_list|)
operator|)
operator|==
name|NULL
condition|)
block|{
return|return
operator|(
name|NULL
operator|)
return|;
block|}
if|if
condition|(
operator|(
name|ic
operator|->
name|wc_temp
operator|=
operator|(
name|XLocale
operator|*
operator|)
name|Xmalloc
argument_list|(
sizeof|sizeof
argument_list|(
name|XLocale
argument_list|)
operator|*
literal|32
argument_list|)
operator|)
operator|==
name|NULL
condition|)
block|{
return|return
operator|(
name|NULL
operator|)
return|;
block|}
if|if
condition|(
operator|(
name|ic
operator|->
name|xcvt_temp
operator|=
operator|(
name|XipLocalCvt
operator|*
operator|*
operator|)
name|Xmalloc
argument_list|(
sizeof|sizeof
argument_list|(
name|XipLocalCvt
operator|*
argument_list|)
operator|*
literal|32
argument_list|)
operator|)
operator|==
name|NULL
condition|)
block|{
return|return
operator|(
name|NULL
operator|)
return|;
block|}
name|_XlcListLocale
argument_list|(
operator|&
name|nls_list
argument_list|)
expr_stmt|;
for|for
control|(
name|l
operator|=
name|nls_list
init|;
operator|*
name|l
condition|;
name|l
operator|++
control|)
block|{
name|xlc
operator|=
name|_XlcMakeLocale
argument_list|(
operator|*
name|l
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|xlc
condition|)
continue|continue;
if|if
condition|(
operator|(
name|ic
operator|->
name|xcvt_temp
index|[
name|ic
operator|->
name|xlc_num
index|]
operator|=
name|_XipLocalCvtSetUp
argument_list|(
name|xlc
argument_list|)
operator|)
operator|==
name|NULL
condition|)
block|{
name|_XlcFreeLocale
argument_list|(
name|xlc
argument_list|)
expr_stmt|;
continue|continue;
block|}
name|ic
operator|->
name|mb_temp
index|[
name|ic
operator|->
name|xlc_num
index|]
operator|=
name|xlc
expr_stmt|;
name|ic
operator|->
name|wc_temp
index|[
name|ic
operator|->
name|xlc_num
index|]
operator|=
name|_XlcDupLocale
argument_list|(
name|xlc
argument_list|)
expr_stmt|;
name|ic
operator|->
name|xlc_num
operator|++
expr_stmt|;
block|}
name|Xfree
argument_list|(
operator|(
name|char
operator|*
operator|)
name|nls_list
argument_list|)
expr_stmt|;
name|ic
operator|->
name|mb
operator|=
name|ic
operator|->
name|mb_temp
index|[
literal|0
index|]
expr_stmt|;
name|ic
operator|->
name|wc
operator|=
name|ic
operator|->
name|wc_temp
index|[
literal|0
index|]
expr_stmt|;
name|ic
operator|->
name|xcvt
operator|=
name|ic
operator|->
name|xcvt_temp
index|[
literal|0
index|]
expr_stmt|;
block|}
endif|#
directive|endif
comment|/* XML */
return|return
operator|(
operator|(
name|XIC
operator|)
name|ic
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Reset the input context.   */
end_comment

begin_function
name|wchar_t
modifier|*
name|_XipLocalwcResetIC
parameter_list|(
name|supic
parameter_list|)
name|XIC
name|supic
decl_stmt|;
comment|/* specified the input context to reset*/
block|{
specifier|register
name|XipLocalIC
name|ic
init|=
operator|(
name|XipLocalIC
operator|)
name|supic
decl_stmt|;
name|ic
operator|->
name|xcvt
operator|->
name|buf_cnt
operator|=
literal|0
expr_stmt|;
name|_XipLocalClearCvt
argument_list|(
name|ic
operator|->
name|xcvt
argument_list|)
expr_stmt|;
return|return
operator|(
operator|(
name|wchar_t
operator|*
operator|)
name|NULL
operator|)
return|;
block|}
end_function

begin_function
name|char
modifier|*
name|_XipLocalmbResetIC
parameter_list|(
name|supic
parameter_list|)
name|XIC
name|supic
decl_stmt|;
comment|/* specified the input context to reset*/
block|{
specifier|register
name|XipLocalIC
name|ic
init|=
operator|(
name|XipLocalIC
operator|)
name|supic
decl_stmt|;
name|ic
operator|->
name|xcvt
operator|->
name|buf_cnt
operator|=
literal|0
expr_stmt|;
name|_XipLocalClearCvt
argument_list|(
name|ic
operator|->
name|xcvt
argument_list|)
expr_stmt|;
return|return
operator|(
name|NULL
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Query Input Method.  */
end_comment

begin_function
specifier|static
name|char
modifier|*
name|_IMGetValues
parameter_list|(
name|im
parameter_list|,
name|args
parameter_list|)
specifier|register
name|XipLocalIM
name|im
decl_stmt|;
specifier|register
name|XIMArg
modifier|*
name|args
decl_stmt|;
block|{
specifier|register
name|XIMArg
modifier|*
name|arg
decl_stmt|;
specifier|register
name|int
name|i
decl_stmt|;
specifier|register
name|XrmName
name|Name
decl_stmt|;
specifier|register
name|XIMrmResourceList
name|xrmres
decl_stmt|;
name|unsigned
name|int
name|num_resources
init|=
name|im
operator|->
name|num_resources
decl_stmt|;
name|XrmQuark
name|query_input
init|=
name|XrmPermStringToQuark
argument_list|(
name|XNQueryInputStyle
argument_list|)
decl_stmt|;
for|for
control|(
name|arg
operator|=
name|args
init|;
name|arg
operator|->
name|name
operator|&&
operator|*
operator|(
name|arg
operator|->
name|name
operator|)
condition|;
name|arg
operator|++
control|)
block|{
name|Name
operator|=
name|XrmStringToName
argument_list|(
name|arg
operator|->
name|name
argument_list|)
expr_stmt|;
for|for
control|(
name|xrmres
operator|=
name|im
operator|->
name|resources
operator|,
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|num_resources
condition|;
name|i
operator|++
operator|,
name|xrmres
operator|++
control|)
block|{
if|if
condition|(
name|Name
operator|==
name|xrmres
operator|->
name|xrm_name
condition|)
block|{
if|if
condition|(
name|Name
operator|==
name|query_input
condition|)
block|{
name|char
modifier|*
name|p
decl_stmt|;
name|XIMStyles
modifier|*
name|styles
decl_stmt|;
name|int
name|size
init|=
sizeof|sizeof
argument_list|(
name|XIMStyle
argument_list|)
operator|*
name|im
operator|->
name|values
operator|.
name|input_styles
operator|.
name|count_styles
decl_stmt|;
name|int
name|all_size
init|=
sizeof|sizeof
argument_list|(
name|XIMStyles
argument_list|)
operator|+
name|size
decl_stmt|;
if|if
condition|(
operator|(
name|p
operator|=
name|Xmalloc
argument_list|(
operator|(
name|unsigned
operator|)
name|all_size
argument_list|)
operator|)
operator|==
name|NULL
condition|)
block|{
continue|continue;
block|}
name|styles
operator|=
operator|(
name|XIMStyles
operator|*
operator|)
name|p
expr_stmt|;
name|styles
operator|->
name|count_styles
operator|=
name|im
operator|->
name|values
operator|.
name|input_styles
operator|.
name|count_styles
expr_stmt|;
name|styles
operator|->
name|supported_styles
operator|=
operator|(
name|XIMStyle
operator|*
operator|)
operator|(
name|p
operator|+
sizeof|sizeof
argument_list|(
name|XIMStyles
argument_list|)
operator|)
expr_stmt|;
name|bcopy
argument_list|(
operator|(
name|char
operator|*
operator|)
name|im
operator|->
name|values
operator|.
name|input_styles
operator|.
name|supported_styles
argument_list|,
operator|(
name|char
operator|*
operator|)
name|styles
operator|->
name|supported_styles
argument_list|,
name|size
argument_list|)
expr_stmt|;
name|bcopy
argument_list|(
operator|(
name|char
operator|*
operator|)
operator|&
name|styles
argument_list|,
operator|(
name|char
operator|*
operator|)
name|arg
operator|->
name|value
argument_list|,
sizeof|sizeof
argument_list|(
name|XIMStyles
operator|*
argument_list|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
operator|(
name|void
operator|)
name|_XCopyToArg
argument_list|(
operator|(
name|char
operator|*
operator|)
name|im
operator|-
name|xrmres
operator|->
name|xrm_offset
operator|-
literal|1
argument_list|,
operator|&
name|arg
operator|->
name|value
argument_list|,
operator|(
name|unsigned
name|int
operator|)
name|xrmres
operator|->
name|xrm_size
argument_list|)
expr_stmt|;
block|}
break|break;
block|}
block|}
if|if
condition|(
name|i
operator|>=
name|num_resources
condition|)
return|return
operator|(
name|arg
operator|->
name|name
operator|)
return|;
block|}
return|return
name|NULL
return|;
block|}
end_function

begin_function
name|char
modifier|*
name|_XipLocalGetIMValues
parameter_list|(
name|supim
parameter_list|,
name|args
parameter_list|)
name|XIM
name|supim
decl_stmt|;
name|XIMArg
modifier|*
name|args
decl_stmt|;
block|{
name|XipLocalIM
name|im
init|=
operator|(
name|XipLocalIM
operator|)
name|supim
decl_stmt|;
return|return
operator|(
name|_IMGetValues
argument_list|(
name|im
argument_list|,
name|args
argument_list|)
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Require the input manager to focus the focus window attached to the ic  * argument.  */
end_comment

begin_function
name|void
name|_XipLocalSetICFocus
parameter_list|(
name|supic
parameter_list|)
name|XIC
name|supic
decl_stmt|;
block|{
name|XipLocalIC
name|ic
init|=
operator|(
name|XipLocalIC
operator|)
name|supic
decl_stmt|;
name|XipLocalIM
name|im
init|=
name|ipLocalIMofIC
argument_list|(
name|ic
argument_list|)
decl_stmt|;
name|_XRegisterFilterByMask
argument_list|(
name|im
operator|->
name|core
operator|.
name|display
argument_list|,
name|ic
operator|->
name|core
operator|.
name|focus_window
argument_list|,
name|KeyPressMask
argument_list|,
name|ic
operator|->
name|prototype_filter
argument_list|,
operator|(
name|XPointer
operator|)
name|ic
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * Require the input manager to unfocus the focus window attached to the ic  * argument.  */
end_comment

begin_function
name|void
name|_XipLocalUnsetICFocus
parameter_list|(
name|supic
parameter_list|)
name|XIC
name|supic
decl_stmt|;
block|{
name|XipLocalIC
name|ic
init|=
operator|(
name|XipLocalIC
operator|)
name|supic
decl_stmt|;
name|XipLocalIM
name|im
init|=
name|ipLocalIMofIC
argument_list|(
name|ic
argument_list|)
decl_stmt|;
name|_XUnregisterFilter
argument_list|(
name|im
operator|->
name|core
operator|.
name|display
argument_list|,
name|ic
operator|->
name|core
operator|.
name|focus_window
argument_list|,
name|ic
operator|->
name|prototype_filter
argument_list|,
operator|(
name|XPointer
operator|)
name|ic
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|char
modifier|*
name|_XipLocalGetICValues
parameter_list|(
name|supic
parameter_list|,
name|args
parameter_list|)
name|XIC
name|supic
decl_stmt|;
name|XIMArg
modifier|*
name|args
decl_stmt|;
block|{
name|XipLocalIC
name|ic
init|=
operator|(
name|XipLocalIC
operator|)
name|supic
decl_stmt|;
name|unsigned
name|long
name|mask
init|=
literal|0L
decl_stmt|;
return|return
operator|(
name|_XipICGetValues
argument_list|(
operator|(
name|XipIC
operator|)
name|ic
argument_list|,
name|args
argument_list|,
operator|&
name|mask
argument_list|,
literal|0
argument_list|)
operator|)
return|;
block|}
end_function

begin_ifdef
ifdef|#
directive|ifdef
name|XML
end_ifdef

begin_function
name|void
name|_XipLocalChangeLocale
parameter_list|(
name|ic
parameter_list|,
name|lc_name
parameter_list|)
name|XipLocalIC
name|ic
decl_stmt|;
name|char
modifier|*
name|lc_name
decl_stmt|;
block|{
name|XLocale
name|xlc
decl_stmt|;
name|int
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|ic
operator|->
name|xlc_num
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
operator|(
operator|!
name|strcmp
argument_list|(
name|lc_name
argument_list|,
name|ic
operator|->
name|mb_temp
index|[
name|i
index|]
operator|->
name|lc_lang
argument_list|)
operator|)
operator|||
operator|(
operator|!
name|strcmp
argument_list|(
name|lc_name
argument_list|,
name|ic
operator|->
name|mb_temp
index|[
name|i
index|]
operator|->
name|xlc_db
operator|->
name|lc_name
argument_list|)
operator|)
condition|)
block|{
name|ic
operator|->
name|mb
operator|=
name|ic
operator|->
name|mb_temp
index|[
name|i
index|]
expr_stmt|;
name|ic
operator|->
name|wc
operator|=
name|ic
operator|->
name|wc_temp
index|[
name|i
index|]
expr_stmt|;
name|ic
operator|->
name|xcvt
operator|=
name|ic
operator|->
name|xcvt_temp
index|[
name|i
index|]
expr_stmt|;
return|return;
block|}
block|}
name|xlc
operator|=
name|_XlcMakeLocale
argument_list|(
name|lc_name
argument_list|)
expr_stmt|;
if|if
condition|(
name|xlc
condition|)
block|{
if|if
condition|(
operator|(
name|ic
operator|->
name|xcvt
operator|=
name|ic
operator|->
name|xcvt_temp
index|[
name|ic
operator|->
name|xlc_num
index|]
operator|=
name|_XipLocalCvtSetUp
argument_list|(
name|xlc
argument_list|)
operator|)
operator|==
name|NULL
condition|)
block|{
name|_XlcFreeLocale
argument_list|(
name|xlc
argument_list|)
expr_stmt|;
return|return;
block|}
name|ic
operator|->
name|mb
operator|=
name|ic
operator|->
name|mb_temp
index|[
name|ic
operator|->
name|xlc_num
index|]
operator|=
name|xlc
expr_stmt|;
name|ic
operator|->
name|wc
operator|=
name|ic
operator|->
name|wc_temp
index|[
name|ic
operator|->
name|xlc_num
index|]
operator|=
name|_XlcDupLocale
argument_list|(
name|xlc
argument_list|)
expr_stmt|;
name|ic
operator|->
name|xlc_num
operator|++
expr_stmt|;
block|}
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* XML */
end_comment

begin_function
name|char
modifier|*
name|_XipLocalSetICValues
parameter_list|(
name|supic
parameter_list|,
name|args
parameter_list|)
name|XIC
name|supic
decl_stmt|;
name|XIMArg
modifier|*
name|args
decl_stmt|;
block|{
name|XipLocalIC
name|ic
init|=
operator|(
name|XipLocalIC
operator|)
name|supic
decl_stmt|;
name|XipLocalIM
name|im
init|=
name|ipLocalIMofIC
argument_list|(
name|ic
argument_list|)
decl_stmt|;
name|unsigned
name|long
name|mask
init|=
literal|0L
decl_stmt|;
name|Window
name|old_focus_window
decl_stmt|;
name|char
modifier|*
name|err
init|=
name|NULL
decl_stmt|;
name|old_focus_window
operator|=
name|ic
operator|->
name|core
operator|.
name|focus_window
expr_stmt|;
name|err
operator|=
name|_XipICSetValues
argument_list|(
operator|(
name|XipIC
operator|)
name|ic
argument_list|,
name|args
argument_list|,
operator|&
name|mask
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
return|return
operator|(
name|err
operator|)
return|;
if|if
condition|(
name|mask
operator|&
operator|(
literal|1L
operator|<<
name|ICFocusWindow
operator|)
condition|)
block|{
name|_XUnregisterFilter
argument_list|(
name|im
operator|->
name|core
operator|.
name|display
argument_list|,
name|old_focus_window
argument_list|,
name|ic
operator|->
name|prototype_filter
argument_list|,
operator|(
name|XPointer
operator|)
name|ic
argument_list|)
expr_stmt|;
name|_XRegisterFilterByMask
argument_list|(
name|im
operator|->
name|core
operator|.
name|display
argument_list|,
name|ic
operator|->
name|core
operator|.
name|focus_window
argument_list|,
name|KeyPressMask
argument_list|,
name|ic
operator|->
name|prototype_filter
argument_list|,
operator|(
name|XPointer
operator|)
name|ic
argument_list|)
expr_stmt|;
block|}
ifdef|#
directive|ifdef
name|XML
if|if
condition|(
name|mask
operator|&
operator|(
literal|1L
operator|<<
name|ICCurrentLanguage
operator|)
condition|)
block|{
name|_XipLocalChangeLocale
argument_list|(
name|ic
argument_list|,
name|ic
operator|->
name|values
operator|.
name|current_language
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
comment|/* XML */
return|return
operator|(
name|NULL
operator|)
return|;
block|}
end_function

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/* Standard debugging hooks for `mmalloc'.    Copyright 1990, 1991, 1992 Free Software Foundation     Written May 1989 by Mike Haertel.    Heavily modified Mar 1992 by Fred Fish (fnf@cygnus.com)  The GNU C Library is free software; you can redistribute it and/or modify it under the terms of the GNU Library General Public License as published by the Free Software Foundation; either version 2 of the License, or (at your option) any later version.  The GNU C Library is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU Library General Public License for more details.  You should have received a copy of the GNU Library General Public License along with the GNU C Library; see the file COPYING.LIB.  If not, write to the Free Software Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.   The author may be reached (Email) at the address mike@ai.mit.edu,  or (US mail) as Mike Haertel c/o Free Software Foundation. */
end_comment

begin_include
include|#
directive|include
file|"mmalloc.h"
end_include

begin_comment
comment|/* Default function to call when something awful happens.  The application    can specify an alternate function to be called instead (and probably will    want to). */
end_comment

begin_decl_stmt
specifier|extern
name|void
name|abort
name|PARAMS
argument_list|(
operator|(
name|void
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* Arbitrary magical numbers.  */
end_comment

begin_define
define|#
directive|define
name|MAGICWORD
value|(unsigned int) 0xfedabeeb
end_define

begin_comment
comment|/* Active chunk */
end_comment

begin_define
define|#
directive|define
name|MAGICWORDFREE
value|(unsigned int) 0xdeadbeef
end_define

begin_comment
comment|/* Inactive chunk */
end_comment

begin_define
define|#
directive|define
name|MAGICBYTE
value|((char) 0xd7)
end_define

begin_comment
comment|/* Each memory allocation is bounded by a header structure and a trailer    byte.  I.E.<size><magicword><user's allocation><magicbyte>     The pointer returned to the user points to the first byte in the    user's allocation area.  The magic word can be tested to detect    buffer underruns and the magic byte can be tested to detect overruns. */
end_comment

begin_struct
struct|struct
name|hdr
block|{
name|size_t
name|size
decl_stmt|;
comment|/* Exact size requested by user.  */
name|unsigned
name|long
name|int
name|magic
decl_stmt|;
comment|/* Magic number to check header integrity.  */
block|}
struct|;
end_struct

begin_comment
comment|/* Check the magicword and magicbyte, and if either is corrupted then    call the emergency abort function specified for the heap in use. */
end_comment

begin_function
specifier|static
name|void
name|checkhdr
parameter_list|(
name|mdp
parameter_list|,
name|hdr
parameter_list|)
name|struct
name|mdesc
modifier|*
name|mdp
decl_stmt|;
name|CONST
name|struct
name|hdr
modifier|*
name|hdr
decl_stmt|;
block|{
if|if
condition|(
name|hdr
operator|->
name|magic
operator|!=
name|MAGICWORD
operator|||
operator|(
operator|(
name|char
operator|*
operator|)
operator|&
name|hdr
index|[
literal|1
index|]
operator|)
index|[
name|hdr
operator|->
name|size
index|]
operator|!=
name|MAGICBYTE
condition|)
block|{
call|(
modifier|*
name|mdp
operator|->
name|abortfunc
call|)
argument_list|()
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|mfree_check
parameter_list|(
name|md
parameter_list|,
name|ptr
parameter_list|)
name|PTR
name|md
decl_stmt|;
name|PTR
name|ptr
decl_stmt|;
block|{
name|struct
name|hdr
modifier|*
name|hdr
init|=
operator|(
operator|(
expr|struct
name|hdr
operator|*
operator|)
name|ptr
operator|)
operator|-
literal|1
decl_stmt|;
name|struct
name|mdesc
modifier|*
name|mdp
decl_stmt|;
name|mdp
operator|=
name|MD_TO_MDP
argument_list|(
name|md
argument_list|)
expr_stmt|;
name|checkhdr
argument_list|(
name|mdp
argument_list|,
name|hdr
argument_list|)
expr_stmt|;
name|hdr
operator|->
name|magic
operator|=
name|MAGICWORDFREE
expr_stmt|;
name|mdp
operator|->
name|mfree_hook
operator|=
name|NULL
expr_stmt|;
name|mfree
argument_list|(
name|md
argument_list|,
operator|(
name|PTR
operator|)
name|hdr
argument_list|)
expr_stmt|;
name|mdp
operator|->
name|mfree_hook
operator|=
name|mfree_check
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|PTR
name|mmalloc_check
parameter_list|(
name|md
parameter_list|,
name|size
parameter_list|)
name|PTR
name|md
decl_stmt|;
name|size_t
name|size
decl_stmt|;
block|{
name|struct
name|hdr
modifier|*
name|hdr
decl_stmt|;
name|struct
name|mdesc
modifier|*
name|mdp
decl_stmt|;
name|size_t
name|nbytes
decl_stmt|;
name|mdp
operator|=
name|MD_TO_MDP
argument_list|(
name|md
argument_list|)
expr_stmt|;
name|mdp
operator|->
name|mmalloc_hook
operator|=
name|NULL
expr_stmt|;
name|nbytes
operator|=
sizeof|sizeof
argument_list|(
expr|struct
name|hdr
argument_list|)
operator|+
name|size
operator|+
literal|1
expr_stmt|;
name|hdr
operator|=
operator|(
expr|struct
name|hdr
operator|*
operator|)
name|mmalloc
argument_list|(
name|md
argument_list|,
name|nbytes
argument_list|)
expr_stmt|;
name|mdp
operator|->
name|mmalloc_hook
operator|=
name|mmalloc_check
expr_stmt|;
if|if
condition|(
name|hdr
operator|!=
name|NULL
condition|)
block|{
name|hdr
operator|->
name|size
operator|=
name|size
expr_stmt|;
name|hdr
operator|->
name|magic
operator|=
name|MAGICWORD
expr_stmt|;
name|hdr
operator|++
expr_stmt|;
operator|*
operator|(
operator|(
name|char
operator|*
operator|)
name|hdr
operator|+
name|size
operator|)
operator|=
name|MAGICBYTE
expr_stmt|;
block|}
return|return
operator|(
operator|(
name|PTR
operator|)
name|hdr
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|PTR
name|mrealloc_check
parameter_list|(
name|md
parameter_list|,
name|ptr
parameter_list|,
name|size
parameter_list|)
name|PTR
name|md
decl_stmt|;
name|PTR
name|ptr
decl_stmt|;
name|size_t
name|size
decl_stmt|;
block|{
name|struct
name|hdr
modifier|*
name|hdr
init|=
operator|(
operator|(
expr|struct
name|hdr
operator|*
operator|)
name|ptr
operator|)
operator|-
literal|1
decl_stmt|;
name|struct
name|mdesc
modifier|*
name|mdp
decl_stmt|;
name|size_t
name|nbytes
decl_stmt|;
name|mdp
operator|=
name|MD_TO_MDP
argument_list|(
name|md
argument_list|)
expr_stmt|;
name|checkhdr
argument_list|(
name|mdp
argument_list|,
name|hdr
argument_list|)
expr_stmt|;
name|mdp
operator|->
name|mfree_hook
operator|=
name|NULL
expr_stmt|;
name|mdp
operator|->
name|mmalloc_hook
operator|=
name|NULL
expr_stmt|;
name|mdp
operator|->
name|mrealloc_hook
operator|=
name|NULL
expr_stmt|;
name|nbytes
operator|=
sizeof|sizeof
argument_list|(
expr|struct
name|hdr
argument_list|)
operator|+
name|size
operator|+
literal|1
expr_stmt|;
name|hdr
operator|=
operator|(
expr|struct
name|hdr
operator|*
operator|)
name|mrealloc
argument_list|(
name|md
argument_list|,
operator|(
name|PTR
operator|)
name|hdr
argument_list|,
name|nbytes
argument_list|)
expr_stmt|;
name|mdp
operator|->
name|mfree_hook
operator|=
name|mfree_check
expr_stmt|;
name|mdp
operator|->
name|mmalloc_hook
operator|=
name|mmalloc_check
expr_stmt|;
name|mdp
operator|->
name|mrealloc_hook
operator|=
name|mrealloc_check
expr_stmt|;
if|if
condition|(
name|hdr
operator|!=
name|NULL
condition|)
block|{
name|hdr
operator|->
name|size
operator|=
name|size
expr_stmt|;
name|hdr
operator|++
expr_stmt|;
operator|*
operator|(
operator|(
name|char
operator|*
operator|)
name|hdr
operator|+
name|size
operator|)
operator|=
name|MAGICBYTE
expr_stmt|;
block|}
return|return
operator|(
operator|(
name|PTR
operator|)
name|hdr
operator|)
return|;
block|}
end_function

begin_comment
comment|/* Turn on default checking for mmalloc/mrealloc/mfree, for the heap specified    by MD.  If FUNC is non-NULL, it is a pointer to the function to call    to abort whenever memory corruption is detected.  By default, this is the    standard library function abort().     Note that we disallow installation of initial checking hooks if mmalloc    has been called at any time for this particular heap, since if any region    that is allocated prior to installation of the hooks is subsequently    reallocated or freed after installation of the hooks, it is guaranteed    to trigger a memory corruption error.  We do this by checking the state    of the MMALLOC_INITIALIZED flag.     However, we can call this function at any time after the initial call,    to update the function pointers to the checking routines and to the    user defined corruption handler routine, as long as these function pointers    have been previously extablished by the initial call.  Note that we    do this automatically when remapping an previously used heap, to ensure    that the hooks get updated to the correct values, although the corruption    handler pointer gets set back to the default.  The application can then    call mmcheck to use a different corruption handler if desired.     Returns non-zero if checking is successfully enabled, zero otherwise. */
end_comment

begin_function_decl
name|int
name|mmcheck
parameter_list|(
name|md
parameter_list|,
name|func
parameter_list|)
name|PTR
name|md
decl_stmt|;
function_decl|void
parameter_list|(
function_decl|*func
end_function_decl

begin_expr_stmt
unit|)
name|PARAMS
argument_list|(
operator|(
name|void
operator|)
argument_list|)
expr_stmt|;
end_expr_stmt

begin_block
block|{
name|struct
name|mdesc
modifier|*
name|mdp
decl_stmt|;
name|int
name|rtnval
decl_stmt|;
name|mdp
operator|=
name|MD_TO_MDP
argument_list|(
name|md
argument_list|)
expr_stmt|;
comment|/* We can safely set or update the abort function at any time, regardless      of whether or not we successfully do anything else. */
name|mdp
operator|->
name|abortfunc
operator|=
operator|(
name|func
operator|!=
name|NULL
condition|?
name|func
else|:
name|abort
operator|)
expr_stmt|;
comment|/* If we haven't yet called mmalloc the first time for this heap, or if we      have hooks that were previously installed, then allow the hooks to be      initialized or updated. */
if|if
condition|(
literal|1
comment|/* FIXME: Always allow installation for now. */
operator|||
operator|!
operator|(
name|mdp
operator|->
name|flags
operator|&
name|MMALLOC_INITIALIZED
operator|)
operator|||
operator|(
name|mdp
operator|->
name|mfree_hook
operator|!=
name|NULL
operator|)
condition|)
block|{
name|mdp
operator|->
name|mfree_hook
operator|=
name|mfree_check
expr_stmt|;
name|mdp
operator|->
name|mmalloc_hook
operator|=
name|mmalloc_check
expr_stmt|;
name|mdp
operator|->
name|mrealloc_hook
operator|=
name|mrealloc_check
expr_stmt|;
name|mdp
operator|->
name|flags
operator||=
name|MMALLOC_MMCHECK_USED
expr_stmt|;
name|rtnval
operator|=
literal|1
expr_stmt|;
block|}
else|else
block|{
name|rtnval
operator|=
literal|0
expr_stmt|;
block|}
return|return
operator|(
name|rtnval
operator|)
return|;
block|}
end_block

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  $Revision: 1.34 $ ** **  Routines to implement site-feeding.  Mainly working with channels to **  do buffering and determine what to send. */
end_comment

begin_include
include|#
directive|include
file|"innd.h"
end_include

begin_define
define|#
directive|define
name|SITEmovetohead
parameter_list|(
name|sp_
parameter_list|)
define|\
value|if (SITEhead != sp_) { \ 	if (SITEtail == sp_) { \ 	    SITEtail = sp_->Prev; \ 	    SITEtail->Next = NULL; \ 	} \ 	else { \ 	    if (sp_->Prev) \ 		sp_->Prev->Next = sp_->Next; \ 	    if (sp_->Next) \ 		sp_->Next->Prev = sp_->Prev; \ 	} \ 	sp_->Prev = NULL; \ 	sp_->Next = SITEhead->Next; \ 	SITEhead->Prev = sp_; \ 	SITEhead = sp_; \     } \     else
end_define

begin_decl_stmt
name|STATIC
name|int
name|SITEcount
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|STATIC
name|SITE
modifier|*
name|SITEhead
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|STATIC
name|SITE
modifier|*
name|SITEtail
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|STATIC
name|char
name|SITEshell
index|[]
init|=
name|_PATH_SH
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* **  Called when input is ready to read.  Shouldn't happen. */
end_comment

begin_comment
comment|/* ARGSUSED0 */
end_comment

begin_function
name|STATIC
name|FUNCTYPE
name|SITEreader
parameter_list|(
name|cp
parameter_list|)
name|CHANNEL
modifier|*
name|cp
decl_stmt|;
block|{
name|syslog
argument_list|(
name|L_ERROR
argument_list|,
literal|"%s internal SITEreader"
argument_list|,
name|LogName
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* **  Called when write is done.  No-op. */
end_comment

begin_comment
comment|/* ARGSUSED0 */
end_comment

begin_function
name|STATIC
name|FUNCTYPE
name|SITEwritedone
parameter_list|(
name|cp
parameter_list|)
name|CHANNEL
modifier|*
name|cp
decl_stmt|;
block|{ }
end_function

begin_comment
comment|/* **  Make a site start spooling. */
end_comment

begin_function
name|STATIC
name|BOOL
name|SITEspool
parameter_list|(
name|sp
parameter_list|,
name|cp
parameter_list|)
specifier|register
name|SITE
modifier|*
name|sp
decl_stmt|;
name|CHANNEL
modifier|*
name|cp
decl_stmt|;
block|{
name|int
name|i
decl_stmt|;
name|char
name|buff
index|[
name|SPOOLNAMEBUFF
index|]
decl_stmt|;
name|char
modifier|*
name|name
decl_stmt|;
name|name
operator|=
name|sp
operator|->
name|SpoolName
expr_stmt|;
name|i
operator|=
name|open
argument_list|(
name|name
argument_list|,
name|O_APPEND
operator||
name|O_CREAT
operator||
name|O_WRONLY
argument_list|,
name|BATCHFILE_MODE
argument_list|)
expr_stmt|;
if|if
condition|(
name|i
operator|<
literal|0
operator|&&
name|errno
operator|==
name|EISDIR
condition|)
block|{
name|FileGlue
argument_list|(
name|buff
argument_list|,
name|sp
operator|->
name|SpoolName
argument_list|,
literal|'/'
argument_list|,
literal|"togo"
argument_list|)
expr_stmt|;
name|name
operator|=
name|buff
expr_stmt|;
name|i
operator|=
name|open
argument_list|(
name|buff
argument_list|,
name|O_APPEND
operator||
name|O_CREAT
operator||
name|O_WRONLY
argument_list|,
name|BATCHFILE_MODE
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|i
operator|<
literal|0
condition|)
block|{
name|IOError
argument_list|(
literal|"site batch file"
argument_list|)
expr_stmt|;
name|syslog
argument_list|(
name|L_ERROR
argument_list|,
literal|"%s cant open %s %m"
argument_list|,
name|sp
operator|->
name|Name
argument_list|,
name|name
argument_list|)
expr_stmt|;
name|sp
operator|->
name|Channel
operator|=
name|NULL
expr_stmt|;
return|return
name|FALSE
return|;
block|}
if|if
condition|(
name|AmRoot
condition|)
name|xchown
argument_list|(
name|name
argument_list|)
expr_stmt|;
if|if
condition|(
name|cp
condition|)
block|{
name|cp
operator|->
name|fd
operator|=
name|i
expr_stmt|;
return|return
name|TRUE
return|;
block|}
name|sp
operator|->
name|Channel
operator|=
name|CHANcreate
argument_list|(
name|i
argument_list|,
name|CTfile
argument_list|,
name|CSwriting
argument_list|,
name|SITEreader
argument_list|,
name|SITEwritedone
argument_list|)
expr_stmt|;
if|if
condition|(
name|sp
operator|->
name|Channel
operator|==
name|NULL
condition|)
block|{
name|syslog
argument_list|(
name|L_ERROR
argument_list|,
literal|"%s cant channel %m"
argument_list|,
name|sp
operator|->
name|Name
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|close
argument_list|(
name|i
argument_list|)
expr_stmt|;
return|return
name|FALSE
return|;
block|}
name|WCHANset
argument_list|(
name|sp
operator|->
name|Channel
argument_list|,
literal|""
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|sp
operator|->
name|Spooling
operator|=
name|TRUE
expr_stmt|;
name|sp
operator|->
name|Process
operator|=
operator|-
literal|1
expr_stmt|;
return|return
name|TRUE
return|;
block|}
end_function

begin_comment
comment|/* **  Find the oldest "file feed" site and buffer it. */
end_comment

begin_function
name|STATIC
name|void
name|SITEbufferoldest
parameter_list|()
block|{
specifier|register
name|SITE
modifier|*
name|sp
decl_stmt|;
specifier|register
name|BUFFER
modifier|*
name|bp
decl_stmt|;
specifier|register
name|BUFFER
modifier|*
name|out
decl_stmt|;
comment|/* Go backwards and find the oldest file. */
for|for
control|(
name|sp
operator|=
name|SITEtail
init|;
name|sp
condition|;
name|sp
operator|=
name|sp
operator|->
name|Prev
control|)
if|if
condition|(
name|sp
operator|->
name|Type
operator|==
name|FTfile
condition|)
break|break;
if|if
condition|(
name|sp
operator|==
name|NULL
condition|)
block|{
name|syslog
argument_list|(
name|L_ERROR
argument_list|,
literal|"%s internal no oldest site found"
argument_list|,
name|LogName
argument_list|)
expr_stmt|;
return|return;
block|}
comment|/* Write out what we can. */
operator|(
name|void
operator|)
name|WCHANflush
argument_list|(
name|sp
operator|->
name|Channel
argument_list|)
expr_stmt|;
comment|/* Get a buffer for the site. */
name|sp
operator|->
name|Buffered
operator|=
name|TRUE
expr_stmt|;
name|bp
operator|=
operator|&
name|sp
operator|->
name|Buffer
expr_stmt|;
name|bp
operator|->
name|Used
operator|=
literal|0
expr_stmt|;
name|bp
operator|->
name|Left
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|bp
operator|->
name|Size
operator|==
literal|0
condition|)
block|{
name|bp
operator|->
name|Size
operator|=
name|sp
operator|->
name|Flushpoint
expr_stmt|;
name|bp
operator|->
name|Data
operator|=
name|NEW
argument_list|(
name|char
argument_list|,
name|bp
operator|->
name|Size
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|bp
operator|->
name|Size
operator|=
name|sp
operator|->
name|Flushpoint
expr_stmt|;
name|RENEW
argument_list|(
name|bp
operator|->
name|Data
argument_list|,
name|char
argument_list|,
name|bp
operator|->
name|Size
argument_list|)
expr_stmt|;
block|}
comment|/* If there's any unwritten data, copy it. */
name|out
operator|=
operator|&
name|sp
operator|->
name|Channel
operator|->
name|Out
expr_stmt|;
if|if
condition|(
name|out
operator|->
name|Left
condition|)
name|BUFFset
argument_list|(
name|bp
argument_list|,
operator|&
name|out
operator|->
name|Data
index|[
name|out
operator|->
name|Used
index|]
argument_list|,
name|out
operator|->
name|Left
argument_list|)
expr_stmt|;
comment|/* Now close the original channel. */
name|CHANclose
argument_list|(
name|sp
operator|->
name|Channel
argument_list|,
name|sp
operator|->
name|Name
argument_list|)
expr_stmt|;
name|SITEcount
operator|--
expr_stmt|;
block|}
end_function

begin_comment
comment|/* **  Check if we need to write out the site's buffer.  If we're buffered **  or the feed is backed up, this gets a bit complicated. */
end_comment

begin_function
name|STATIC
name|void
name|SITEflushcheck
parameter_list|(
name|sp
parameter_list|,
name|bp
parameter_list|)
specifier|register
name|SITE
modifier|*
name|sp
decl_stmt|;
specifier|register
name|BUFFER
modifier|*
name|bp
decl_stmt|;
block|{
specifier|register
name|int
name|i
decl_stmt|;
specifier|register
name|CHANNEL
modifier|*
name|cp
decl_stmt|;
comment|/* If we're buffered, and we hit the flushpoint, do an LRU. */
if|if
condition|(
name|sp
operator|->
name|Buffered
condition|)
block|{
if|if
condition|(
name|bp
operator|->
name|Used
operator|<
name|sp
operator|->
name|Flushpoint
condition|)
return|return;
if|if
condition|(
name|SITEcount
operator|>
name|MaxOutgoing
condition|)
name|SITEbufferoldest
argument_list|()
expr_stmt|;
if|if
condition|(
operator|!
name|SITEsetup
argument_list|(
name|sp
argument_list|)
operator|||
name|sp
operator|->
name|Buffered
condition|)
block|{
name|syslog
argument_list|(
name|L_ERROR
argument_list|,
literal|"%s cant unbuffer %m"
argument_list|,
name|sp
operator|->
name|Name
argument_list|)
expr_stmt|;
return|return;
block|}
name|WCHANsetfrombuffer
argument_list|(
name|sp
operator|->
name|Channel
argument_list|,
name|bp
argument_list|)
expr_stmt|;
name|WCHANadd
argument_list|(
name|sp
operator|->
name|Channel
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|PROCneedscan
condition|)
name|PROCscan
argument_list|()
expr_stmt|;
comment|/* Handle buffering. */
name|cp
operator|=
name|sp
operator|->
name|Channel
expr_stmt|;
name|i
operator|=
name|cp
operator|->
name|Out
operator|.
name|Left
expr_stmt|;
if|if
condition|(
name|i
operator|<
name|sp
operator|->
name|StopWriting
condition|)
name|WCHANremove
argument_list|(
name|cp
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|sp
operator|->
name|StartWriting
operator|==
literal|0
operator|||
name|i
operator|>
name|sp
operator|->
name|StartWriting
operator|)
operator|&&
operator|!
name|CHANsleeping
argument_list|(
name|cp
argument_list|)
condition|)
name|WCHANadd
argument_list|(
name|cp
argument_list|)
expr_stmt|;
comment|/* If we're a channel that's getting big, see if we need to spool. */
if|if
condition|(
name|sp
operator|->
name|Type
operator|==
name|FTfile
operator|||
name|sp
operator|->
name|StartSpooling
operator|==
literal|0
operator|||
name|i
operator|<
name|sp
operator|->
name|StartSpooling
condition|)
return|return;
if|if
condition|(
operator|!
name|SITEspool
argument_list|(
name|sp
argument_list|,
operator|(
name|CHANNEL
operator|*
operator|)
name|NULL
argument_list|)
condition|)
block|{
name|syslog
argument_list|(
name|L_ERROR
argument_list|,
literal|"%s overflow %d bytes"
argument_list|,
name|sp
operator|->
name|Name
argument_list|,
name|i
argument_list|)
expr_stmt|;
return|return;
block|}
name|syslog
argument_list|(
name|L_ERROR
argument_list|,
literal|"%s spooling %d bytes"
argument_list|,
name|sp
operator|->
name|Name
argument_list|,
name|i
argument_list|)
expr_stmt|;
name|WCHANsetfrombuffer
argument_list|(
name|sp
operator|->
name|Channel
argument_list|,
operator|&
name|cp
operator|->
name|Out
argument_list|)
expr_stmt|;
name|WCHANadd
argument_list|(
name|sp
operator|->
name|Channel
argument_list|)
expr_stmt|;
name|CHANclose
argument_list|(
name|cp
argument_list|,
name|CHANname
argument_list|(
name|cp
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* **  Send a control line to an exploder. */
end_comment

begin_function
name|void
name|SITEwrite
parameter_list|(
name|sp
parameter_list|,
name|text
parameter_list|)
specifier|register
name|SITE
modifier|*
name|sp
decl_stmt|;
name|STRING
name|text
decl_stmt|;
block|{
specifier|static
name|char
name|PREFIX
index|[]
init|=
block|{
name|EXP_CONTROL
block|,
literal|'\0'
block|}
decl_stmt|;
specifier|register
name|BUFFER
modifier|*
name|bp
decl_stmt|;
if|if
condition|(
name|sp
operator|->
name|Buffered
condition|)
name|bp
operator|=
operator|&
name|sp
operator|->
name|Buffer
expr_stmt|;
else|else
block|{
if|if
condition|(
name|sp
operator|->
name|Channel
operator|==
name|NULL
condition|)
return|return;
name|bp
operator|=
operator|&
name|sp
operator|->
name|Channel
operator|->
name|Out
expr_stmt|;
block|}
name|BUFFappend
argument_list|(
name|bp
argument_list|,
name|PREFIX
argument_list|,
name|STRLEN
argument_list|(
name|PREFIX
argument_list|)
argument_list|)
expr_stmt|;
name|BUFFappend
argument_list|(
name|bp
argument_list|,
name|text
argument_list|,
operator|(
name|int
operator|)
name|strlen
argument_list|(
name|text
argument_list|)
argument_list|)
expr_stmt|;
name|BUFFappend
argument_list|(
name|bp
argument_list|,
literal|"\n"
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|WCHANadd
argument_list|(
name|sp
operator|->
name|Channel
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* **  Send the desired data about an article down a channel. */
end_comment

begin_function
name|STATIC
name|void
name|SITEwritefromflags
parameter_list|(
name|sp
parameter_list|,
name|Data
parameter_list|)
specifier|register
name|SITE
modifier|*
name|sp
decl_stmt|;
name|ARTDATA
modifier|*
name|Data
decl_stmt|;
block|{
specifier|static
name|char
name|ITEMSEP
index|[]
init|=
literal|" "
decl_stmt|;
specifier|static
name|char
name|NL
index|[]
init|=
literal|"\n"
decl_stmt|;
specifier|register
name|char
modifier|*
name|p
decl_stmt|;
specifier|register
name|BOOL
name|Dirty
decl_stmt|;
specifier|register
name|BUFFER
modifier|*
name|bp
decl_stmt|;
specifier|register
name|SITE
modifier|*
name|spx
decl_stmt|;
specifier|register
name|int
name|i
decl_stmt|;
if|if
condition|(
name|sp
operator|->
name|Buffered
condition|)
name|bp
operator|=
operator|&
name|sp
operator|->
name|Buffer
expr_stmt|;
else|else
block|{
comment|/* This should not happen, but if we tried to spool and failed, 	 * e.g., because of a bad F param for this site, we can get 	 * into this state.  We already logged a message so give up. */
if|if
condition|(
name|sp
operator|->
name|Channel
operator|==
name|NULL
condition|)
return|return;
name|bp
operator|=
operator|&
name|sp
operator|->
name|Channel
operator|->
name|Out
expr_stmt|;
block|}
for|for
control|(
name|Dirty
operator|=
name|FALSE
operator|,
name|p
operator|=
name|sp
operator|->
name|FileFlags
init|;
operator|*
name|p
condition|;
name|p
operator|++
control|)
block|{
switch|switch
condition|(
operator|*
name|p
condition|)
block|{
default|default:
name|syslog
argument_list|(
name|L_ERROR
argument_list|,
literal|"%s internal SITEwritefromflags %c"
argument_list|,
name|sp
operator|->
name|Name
argument_list|,
name|p
argument_list|)
expr_stmt|;
continue|continue;
case|case
name|FEED_BYTESIZE
case|:
if|if
condition|(
name|Dirty
condition|)
name|BUFFappend
argument_list|(
name|bp
argument_list|,
name|ITEMSEP
argument_list|,
name|STRLEN
argument_list|(
name|ITEMSEP
argument_list|)
argument_list|)
expr_stmt|;
name|BUFFappend
argument_list|(
name|bp
argument_list|,
name|Data
operator|->
name|Size
argument_list|,
name|Data
operator|->
name|SizeLength
argument_list|)
expr_stmt|;
break|break;
case|case
name|FEED_FULLNAME
case|:
if|if
condition|(
name|Dirty
condition|)
name|BUFFappend
argument_list|(
name|bp
argument_list|,
name|ITEMSEP
argument_list|,
name|STRLEN
argument_list|(
name|ITEMSEP
argument_list|)
argument_list|)
expr_stmt|;
name|BUFFappend
argument_list|(
name|bp
argument_list|,
name|SPOOL
argument_list|,
name|SPOOLlen
argument_list|)
expr_stmt|;
name|BUFFappend
argument_list|(
name|bp
argument_list|,
literal|"/"
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|BUFFappend
argument_list|(
name|bp
argument_list|,
name|Data
operator|->
name|Name
argument_list|,
name|Data
operator|->
name|NameLength
argument_list|)
expr_stmt|;
break|break;
case|case
name|FEED_HDR_DISTRIB
case|:
if|if
condition|(
name|Dirty
condition|)
name|BUFFappend
argument_list|(
name|bp
argument_list|,
name|ITEMSEP
argument_list|,
name|STRLEN
argument_list|(
name|ITEMSEP
argument_list|)
argument_list|)
expr_stmt|;
name|BUFFappend
argument_list|(
name|bp
argument_list|,
name|Data
operator|->
name|Distribution
argument_list|,
name|Data
operator|->
name|DistributionLength
argument_list|)
expr_stmt|;
break|break;
case|case
name|FEED_HDR_NEWSGROUP
case|:
if|if
condition|(
name|Dirty
condition|)
name|BUFFappend
argument_list|(
name|bp
argument_list|,
name|ITEMSEP
argument_list|,
name|STRLEN
argument_list|(
name|ITEMSEP
argument_list|)
argument_list|)
expr_stmt|;
name|BUFFappend
argument_list|(
name|bp
argument_list|,
name|Data
operator|->
name|Newsgroups
argument_list|,
name|Data
operator|->
name|NewsgroupsLength
argument_list|)
expr_stmt|;
break|break;
case|case
name|FEED_HEADERS
case|:
if|if
condition|(
name|Dirty
condition|)
name|BUFFappend
argument_list|(
name|bp
argument_list|,
name|NL
argument_list|,
name|STRLEN
argument_list|(
name|NL
argument_list|)
argument_list|)
expr_stmt|;
name|BUFFappend
argument_list|(
name|bp
argument_list|,
name|Data
operator|->
name|Headers
operator|->
name|Data
argument_list|,
name|Data
operator|->
name|Headers
operator|->
name|Left
argument_list|)
expr_stmt|;
break|break;
case|case
name|FEED_OVERVIEW
case|:
if|if
condition|(
name|Dirty
condition|)
name|BUFFappend
argument_list|(
name|bp
argument_list|,
name|ITEMSEP
argument_list|,
name|STRLEN
argument_list|(
name|ITEMSEP
argument_list|)
argument_list|)
expr_stmt|;
name|BUFFappend
argument_list|(
name|bp
argument_list|,
name|Data
operator|->
name|Overview
operator|->
name|Data
argument_list|,
name|Data
operator|->
name|Overview
operator|->
name|Left
argument_list|)
expr_stmt|;
break|break;
case|case
name|FEED_REPLIC
case|:
if|if
condition|(
name|Dirty
condition|)
name|BUFFappend
argument_list|(
name|bp
argument_list|,
name|ITEMSEP
argument_list|,
name|STRLEN
argument_list|(
name|ITEMSEP
argument_list|)
argument_list|)
expr_stmt|;
name|BUFFappend
argument_list|(
name|bp
argument_list|,
name|Data
operator|->
name|Replic
argument_list|,
name|Data
operator|->
name|ReplicLength
argument_list|)
expr_stmt|;
break|break;
case|case
name|FEED_TIMERECEIVED
case|:
if|if
condition|(
name|Dirty
condition|)
name|BUFFappend
argument_list|(
name|bp
argument_list|,
name|ITEMSEP
argument_list|,
name|STRLEN
argument_list|(
name|ITEMSEP
argument_list|)
argument_list|)
expr_stmt|;
name|BUFFappend
argument_list|(
name|bp
argument_list|,
name|Data
operator|->
name|TimeReceived
argument_list|,
name|Data
operator|->
name|TimeReceivedLength
argument_list|)
expr_stmt|;
break|break;
case|case
name|FEED_MESSAGEID
case|:
if|if
condition|(
name|Dirty
condition|)
name|BUFFappend
argument_list|(
name|bp
argument_list|,
name|ITEMSEP
argument_list|,
name|STRLEN
argument_list|(
name|ITEMSEP
argument_list|)
argument_list|)
expr_stmt|;
name|BUFFappend
argument_list|(
name|bp
argument_list|,
name|Data
operator|->
name|MessageID
argument_list|,
name|Data
operator|->
name|MessageIDLength
argument_list|)
expr_stmt|;
break|break;
case|case
name|FEED_FNLNAMES
case|:
if|if
condition|(
name|sp
operator|->
name|FNLnames
operator|.
name|Data
condition|)
block|{
comment|/* Funnel; write names of our sites that got it. */
if|if
condition|(
name|Dirty
condition|)
name|BUFFappend
argument_list|(
name|bp
argument_list|,
name|ITEMSEP
argument_list|,
name|STRLEN
argument_list|(
name|ITEMSEP
argument_list|)
argument_list|)
expr_stmt|;
name|BUFFappend
argument_list|(
name|bp
argument_list|,
name|sp
operator|->
name|FNLnames
operator|.
name|Data
argument_list|,
name|sp
operator|->
name|FNLnames
operator|.
name|Used
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|/* Not funnel; write names of all sites that got it. */
for|for
control|(
name|spx
operator|=
name|Sites
operator|,
name|i
operator|=
name|nSites
init|;
operator|--
name|i
operator|>=
literal|0
condition|;
name|spx
operator|++
control|)
if|if
condition|(
name|spx
operator|->
name|Sendit
condition|)
block|{
if|if
condition|(
name|Dirty
condition|)
name|BUFFappend
argument_list|(
name|bp
argument_list|,
name|ITEMSEP
argument_list|,
name|STRLEN
argument_list|(
name|ITEMSEP
argument_list|)
argument_list|)
expr_stmt|;
name|BUFFappend
argument_list|(
name|bp
argument_list|,
name|spx
operator|->
name|Name
argument_list|,
name|spx
operator|->
name|NameLength
argument_list|)
expr_stmt|;
name|Dirty
operator|=
name|TRUE
expr_stmt|;
block|}
block|}
break|break;
case|case
name|FEED_NAME
case|:
if|if
condition|(
name|Dirty
condition|)
name|BUFFappend
argument_list|(
name|bp
argument_list|,
name|ITEMSEP
argument_list|,
name|STRLEN
argument_list|(
name|ITEMSEP
argument_list|)
argument_list|)
expr_stmt|;
name|BUFFappend
argument_list|(
name|bp
argument_list|,
name|Data
operator|->
name|Name
argument_list|,
name|Data
operator|->
name|NameLength
argument_list|)
expr_stmt|;
break|break;
case|case
name|FEED_NEWSGROUP
case|:
if|if
condition|(
name|Dirty
condition|)
name|BUFFappend
argument_list|(
name|bp
argument_list|,
name|ITEMSEP
argument_list|,
name|STRLEN
argument_list|(
name|ITEMSEP
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|sp
operator|->
name|ng
condition|)
name|BUFFappend
argument_list|(
name|bp
argument_list|,
name|sp
operator|->
name|ng
operator|->
name|Name
argument_list|,
name|sp
operator|->
name|ng
operator|->
name|NameLength
argument_list|)
expr_stmt|;
else|else
name|BUFFappend
argument_list|(
name|bp
argument_list|,
literal|"?"
argument_list|,
literal|1
argument_list|)
expr_stmt|;
break|break;
case|case
name|FEED_SITE
case|:
if|if
condition|(
name|Dirty
condition|)
name|BUFFappend
argument_list|(
name|bp
argument_list|,
name|ITEMSEP
argument_list|,
name|STRLEN
argument_list|(
name|ITEMSEP
argument_list|)
argument_list|)
expr_stmt|;
name|BUFFappend
argument_list|(
name|bp
argument_list|,
name|Data
operator|->
name|Feedsite
argument_list|,
name|Data
operator|->
name|FeedsiteLength
argument_list|)
expr_stmt|;
break|break;
block|}
name|Dirty
operator|=
name|TRUE
expr_stmt|;
block|}
if|if
condition|(
name|Dirty
condition|)
block|{
name|BUFFappend
argument_list|(
name|bp
argument_list|,
literal|"\n"
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|SITEflushcheck
argument_list|(
name|sp
argument_list|,
name|bp
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/* **  Send one article to a site. */
end_comment

begin_function
name|void
name|SITEsend
parameter_list|(
name|sp
parameter_list|,
name|Data
parameter_list|)
specifier|register
name|SITE
modifier|*
name|sp
decl_stmt|;
name|ARTDATA
modifier|*
name|Data
decl_stmt|;
block|{
specifier|register
name|int
name|i
decl_stmt|;
specifier|register
name|char
modifier|*
name|p
decl_stmt|;
name|char
modifier|*
name|temp
decl_stmt|;
name|char
name|buff
index|[
name|BUFSIZ
index|]
decl_stmt|;
name|STRING
name|argv
index|[
name|MAX_BUILTIN_ARGV
index|]
decl_stmt|;
name|int
name|fd
decl_stmt|;
switch|switch
condition|(
name|sp
operator|->
name|Type
condition|)
block|{
default|default:
name|syslog
argument_list|(
name|L_ERROR
argument_list|,
literal|"%s internal SITEsend type %d"
argument_list|,
name|sp
operator|->
name|Name
argument_list|,
name|sp
operator|->
name|Type
argument_list|)
expr_stmt|;
break|break;
case|case
name|FTlogonly
case|:
break|break;
case|case
name|FTfunnel
case|:
name|syslog
argument_list|(
name|L_ERROR
argument_list|,
literal|"%s funnel_send"
argument_list|,
name|sp
operator|->
name|Name
argument_list|)
expr_stmt|;
break|break;
case|case
name|FTfile
case|:
if|if
condition|(
name|SITEcount
operator|>
name|MaxOutgoing
condition|)
name|SITEmovetohead
argument_list|(
name|sp
argument_list|)
expr_stmt|;
comment|/* FALLTHROUGH */
case|case
name|FTchannel
case|:
case|case
name|FTexploder
case|:
name|SITEwritefromflags
argument_list|(
name|sp
argument_list|,
name|Data
argument_list|)
expr_stmt|;
break|break;
case|case
name|FTprogram
case|:
comment|/* Set up the argument vector. */
if|if
condition|(
name|sp
operator|->
name|FNLwantsnames
condition|)
block|{
name|i
operator|=
name|strlen
argument_list|(
name|sp
operator|->
name|Param
argument_list|)
operator|+
name|sp
operator|->
name|FNLnames
operator|.
name|Used
expr_stmt|;
if|if
condition|(
name|i
operator|+
name|strlen
argument_list|(
name|Data
operator|->
name|Name
argument_list|)
operator|>=
sizeof|sizeof
name|buff
condition|)
block|{
name|syslog
argument_list|(
name|L_ERROR
argument_list|,
literal|"%s toolong need %d for %s"
argument_list|,
name|sp
operator|->
name|Name
argument_list|,
name|i
operator|+
name|strlen
argument_list|(
name|Data
operator|->
name|Name
argument_list|)
argument_list|,
name|Data
operator|->
name|Name
argument_list|)
expr_stmt|;
break|break;
block|}
name|temp
operator|=
name|NEW
argument_list|(
name|char
argument_list|,
name|i
operator|+
literal|1
argument_list|)
expr_stmt|;
name|p
operator|=
name|strchr
argument_list|(
name|sp
operator|->
name|Param
argument_list|,
literal|'*'
argument_list|)
expr_stmt|;
operator|*
name|p
operator|=
literal|'\0'
expr_stmt|;
operator|(
name|void
operator|)
name|strcpy
argument_list|(
name|temp
argument_list|,
name|sp
operator|->
name|Param
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|strcat
argument_list|(
name|temp
argument_list|,
name|sp
operator|->
name|FNLnames
operator|.
name|Data
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|strcat
argument_list|(
name|temp
argument_list|,
operator|&
name|p
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
operator|*
name|p
operator|=
literal|'*'
expr_stmt|;
operator|(
name|void
operator|)
name|sprintf
argument_list|(
name|buff
argument_list|,
name|temp
argument_list|,
name|Data
operator|->
name|Name
argument_list|)
expr_stmt|;
name|DISPOSE
argument_list|(
name|temp
argument_list|)
expr_stmt|;
block|}
else|else
operator|(
name|void
operator|)
name|sprintf
argument_list|(
name|buff
argument_list|,
name|sp
operator|->
name|Param
argument_list|,
name|Data
operator|->
name|Name
argument_list|)
expr_stmt|;
if|if
condition|(
name|NeedShell
argument_list|(
name|buff
argument_list|,
name|argv
argument_list|,
name|ENDOF
argument_list|(
name|argv
argument_list|)
argument_list|)
condition|)
block|{
name|argv
index|[
literal|0
index|]
operator|=
name|SITEshell
expr_stmt|;
name|argv
index|[
literal|1
index|]
operator|=
literal|"-c"
expr_stmt|;
name|argv
index|[
literal|2
index|]
operator|=
name|buff
expr_stmt|;
name|argv
index|[
literal|3
index|]
operator|=
name|NULL
expr_stmt|;
block|}
comment|/* Feed the article on standard input. */
name|fd
operator|=
name|open
argument_list|(
name|Data
operator|->
name|Name
argument_list|,
name|O_RDONLY
argument_list|)
expr_stmt|;
if|if
condition|(
name|fd
operator|<
literal|0
condition|)
block|{
comment|/* Unlikely, but we could check if the article is cross-posted 	     * and try it under other names... */
name|syslog
argument_list|(
name|L_ERROR
argument_list|,
literal|"%s cant open %s %m"
argument_list|,
name|sp
operator|->
name|Name
argument_list|,
name|Data
operator|->
name|Name
argument_list|)
expr_stmt|;
name|fd
operator|=
literal|0
expr_stmt|;
block|}
comment|/* Start the process. */
name|i
operator|=
name|Spawn
argument_list|(
name|fd
argument_list|,
operator|(
name|int
operator|)
name|fileno
argument_list|(
name|Errlog
argument_list|)
argument_list|,
operator|(
name|int
operator|)
name|fileno
argument_list|(
name|Errlog
argument_list|)
argument_list|,
name|argv
argument_list|)
expr_stmt|;
if|if
condition|(
name|i
operator|>=
literal|0
condition|)
operator|(
name|void
operator|)
name|PROCwatch
argument_list|(
name|i
argument_list|,
operator|-
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|fd
operator|!=
literal|0
condition|)
operator|(
name|void
operator|)
name|close
argument_list|(
name|fd
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
end_function

begin_comment
comment|/* **  The channel was sleeping because we had to spool our output to **  a file.  Flush and restart. */
end_comment

begin_function
name|STATIC
name|FUNCTYPE
name|SITEspoolwake
parameter_list|(
name|cp
parameter_list|)
name|CHANNEL
modifier|*
name|cp
decl_stmt|;
block|{
name|SITE
modifier|*
name|sp
decl_stmt|;
name|int
modifier|*
name|ip
decl_stmt|;
name|ip
operator|=
name|CAST
argument_list|(
name|int
operator|*
argument_list|,
name|cp
operator|->
name|Argument
argument_list|)
expr_stmt|;
name|sp
operator|=
operator|&
name|Sites
index|[
operator|*
name|ip
index|]
expr_stmt|;
name|DISPOSE
argument_list|(
name|cp
operator|->
name|Argument
argument_list|)
expr_stmt|;
name|cp
operator|->
name|Argument
operator|=
name|NULL
expr_stmt|;
if|if
condition|(
name|sp
operator|->
name|Channel
operator|!=
name|cp
condition|)
block|{
name|syslog
argument_list|(
name|L_ERROR
argument_list|,
literal|"%s internal SITEspoolwake %s got %d, not %d"
argument_list|,
name|LogName
argument_list|,
name|sp
operator|->
name|Name
argument_list|,
name|cp
operator|->
name|fd
argument_list|,
name|sp
operator|->
name|Channel
operator|->
name|fd
argument_list|)
expr_stmt|;
return|return;
block|}
name|syslog
argument_list|(
name|L_NOTICE
argument_list|,
literal|"%s spoolwake"
argument_list|,
name|sp
operator|->
name|Name
argument_list|)
expr_stmt|;
name|SITEflush
argument_list|(
name|sp
argument_list|,
name|TRUE
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* **  Start up a process for a channel, or a spool to a file if we can't. **  Create a channel for the site to talk to. */
end_comment

begin_function
name|STATIC
name|BOOL
name|SITEstartprocess
parameter_list|(
name|sp
parameter_list|)
name|SITE
modifier|*
name|sp
decl_stmt|;
block|{
specifier|register
name|int
name|i
decl_stmt|;
name|STRING
name|argv
index|[
name|MAX_BUILTIN_ARGV
index|]
decl_stmt|;
name|char
modifier|*
name|process
decl_stmt|;
name|int
modifier|*
name|ip
decl_stmt|;
name|int
name|pan
index|[
literal|2
index|]
decl_stmt|;
comment|/* Create a pipe. */
if|if
condition|(
name|pipe
argument_list|(
name|pan
argument_list|)
operator|<
literal|0
condition|)
block|{
name|syslog
argument_list|(
name|L_ERROR
argument_list|,
literal|"%s cant pipe %m"
argument_list|,
name|sp
operator|->
name|Name
argument_list|)
expr_stmt|;
return|return
name|FALSE
return|;
block|}
name|CloseOnExec
argument_list|(
name|pan
index|[
name|PIPE_WRITE
index|]
argument_list|,
name|TRUE
argument_list|)
expr_stmt|;
comment|/* Set up the argument vector. */
name|process
operator|=
name|COPY
argument_list|(
name|sp
operator|->
name|Param
argument_list|)
expr_stmt|;
if|if
condition|(
name|NeedShell
argument_list|(
name|process
argument_list|,
name|argv
argument_list|,
name|ENDOF
argument_list|(
name|argv
argument_list|)
argument_list|)
condition|)
block|{
name|argv
index|[
literal|0
index|]
operator|=
name|SITEshell
expr_stmt|;
name|argv
index|[
literal|1
index|]
operator|=
literal|"-c"
expr_stmt|;
name|argv
index|[
literal|2
index|]
operator|=
name|process
expr_stmt|;
name|argv
index|[
literal|3
index|]
operator|=
name|NULL
expr_stmt|;
block|}
comment|/* Fork a child. */
name|i
operator|=
name|Spawn
argument_list|(
name|pan
index|[
name|PIPE_READ
index|]
argument_list|,
operator|(
name|int
operator|)
name|fileno
argument_list|(
name|Errlog
argument_list|)
argument_list|,
operator|(
name|int
operator|)
name|fileno
argument_list|(
name|Errlog
argument_list|)
argument_list|,
name|argv
argument_list|)
expr_stmt|;
if|if
condition|(
name|i
operator|>
literal|0
condition|)
block|{
name|sp
operator|->
name|pid
operator|=
name|i
expr_stmt|;
name|sp
operator|->
name|Spooling
operator|=
name|FALSE
expr_stmt|;
name|sp
operator|->
name|Process
operator|=
name|PROCwatch
argument_list|(
name|i
argument_list|,
name|sp
operator|-
name|Sites
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|close
argument_list|(
name|pan
index|[
name|PIPE_READ
index|]
argument_list|)
expr_stmt|;
name|sp
operator|->
name|Channel
operator|=
name|CHANcreate
argument_list|(
name|pan
index|[
name|PIPE_WRITE
index|]
argument_list|,
name|sp
operator|->
name|Type
operator|==
name|FTchannel
condition|?
name|CTprocess
else|:
name|CTexploder
argument_list|,
name|CSwriting
argument_list|,
name|SITEreader
argument_list|,
name|SITEwritedone
argument_list|)
expr_stmt|;
name|DISPOSE
argument_list|(
name|process
argument_list|)
expr_stmt|;
return|return
name|TRUE
return|;
block|}
name|DISPOSE
argument_list|(
name|process
argument_list|)
expr_stmt|;
comment|/* Error.  Switch to spooling. */
name|syslog
argument_list|(
name|L_ERROR
argument_list|,
literal|"%s spooling"
argument_list|,
name|sp
operator|->
name|Name
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|close
argument_list|(
name|pan
index|[
name|PIPE_WRITE
index|]
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|close
argument_list|(
name|pan
index|[
name|PIPE_READ
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|SITEspool
argument_list|(
name|sp
argument_list|,
operator|(
name|CHANNEL
operator|*
operator|)
name|NULL
argument_list|)
condition|)
return|return
name|FALSE
return|;
comment|/* We'll try to restart the channel later. */
name|syslog
argument_list|(
name|L_ERROR
argument_list|,
literal|"%s cant spawn spooling %m"
argument_list|,
name|sp
operator|->
name|Name
argument_list|)
expr_stmt|;
name|ip
operator|=
name|NEW
argument_list|(
name|int
argument_list|,
literal|1
argument_list|)
expr_stmt|;
operator|*
name|ip
operator|=
name|sp
operator|-
name|Sites
expr_stmt|;
name|SCHANadd
argument_list|(
name|sp
operator|->
name|Channel
argument_list|,
call|(
name|time_t
call|)
argument_list|(
name|Now
operator|.
name|time
operator|+
name|CHANNEL_RETRY_TIME
argument_list|)
argument_list|,
operator|(
name|POINTER
operator|)
name|NULL
argument_list|,
name|SITEspoolwake
argument_list|,
operator|(
name|POINTER
operator|)
name|ip
argument_list|)
expr_stmt|;
return|return
name|TRUE
return|;
block|}
end_function

begin_comment
comment|/* **  Set up a site for internal buffering. */
end_comment

begin_function
name|STATIC
name|void
name|SITEbuffer
parameter_list|(
name|sp
parameter_list|)
specifier|register
name|SITE
modifier|*
name|sp
decl_stmt|;
block|{
specifier|register
name|BUFFER
modifier|*
name|bp
decl_stmt|;
name|sp
operator|->
name|Buffered
operator|=
name|TRUE
expr_stmt|;
name|sp
operator|->
name|Channel
operator|=
name|NULL
expr_stmt|;
name|bp
operator|=
operator|&
name|sp
operator|->
name|Buffer
expr_stmt|;
if|if
condition|(
name|bp
operator|->
name|Size
operator|==
literal|0
condition|)
block|{
name|bp
operator|->
name|Size
operator|=
name|sp
operator|->
name|Flushpoint
expr_stmt|;
name|bp
operator|->
name|Data
operator|=
name|NEW
argument_list|(
name|char
argument_list|,
name|bp
operator|->
name|Size
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|bp
operator|->
name|Size
operator|=
name|sp
operator|->
name|Flushpoint
expr_stmt|;
name|RENEW
argument_list|(
name|bp
operator|->
name|Data
argument_list|,
name|char
argument_list|,
name|bp
operator|->
name|Size
argument_list|)
expr_stmt|;
block|}
name|BUFFset
argument_list|(
name|bp
argument_list|,
literal|""
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|syslog
argument_list|(
name|L_NOTICE
argument_list|,
literal|"%s buffered"
argument_list|,
name|sp
operator|->
name|Name
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* **  Set up a site's feed.  This means opening a file or channel if needed. */
end_comment

begin_function
name|BOOL
name|SITEsetup
parameter_list|(
name|sp
parameter_list|)
specifier|register
name|SITE
modifier|*
name|sp
decl_stmt|;
block|{
name|int
name|fd
decl_stmt|;
switch|switch
condition|(
name|sp
operator|->
name|Type
condition|)
block|{
default|default:
name|syslog
argument_list|(
name|L_ERROR
argument_list|,
literal|"%s internal SITEsetup %d"
argument_list|,
name|sp
operator|->
name|Name
argument_list|,
name|sp
operator|->
name|Type
argument_list|)
expr_stmt|;
return|return
name|FALSE
return|;
case|case
name|FTfunnel
case|:
case|case
name|FTlogonly
case|:
case|case
name|FTprogram
case|:
comment|/* Nothing to do here. */
break|break;
case|case
name|FTfile
case|:
name|SITEcount
operator|++
expr_stmt|;
if|if
condition|(
name|SITEcount
operator|>
name|MaxOutgoing
condition|)
name|SITEbuffer
argument_list|(
name|sp
argument_list|)
expr_stmt|;
else|else
block|{
name|sp
operator|->
name|Buffered
operator|=
name|FALSE
expr_stmt|;
name|fd
operator|=
name|open
argument_list|(
name|sp
operator|->
name|Param
argument_list|,
name|O_APPEND
operator||
name|O_CREAT
operator||
name|O_WRONLY
argument_list|,
name|BATCHFILE_MODE
argument_list|)
expr_stmt|;
if|if
condition|(
name|fd
operator|<
literal|0
condition|)
block|{
if|if
condition|(
name|errno
operator|==
name|EMFILE
condition|)
block|{
name|SITEbuffer
argument_list|(
name|sp
argument_list|)
expr_stmt|;
break|break;
block|}
name|IOError
argument_list|(
literal|"site file"
argument_list|)
expr_stmt|;
name|syslog
argument_list|(
name|L_NOTICE
argument_list|,
literal|"%s cant open %s %m"
argument_list|,
name|sp
operator|->
name|Name
argument_list|,
name|sp
operator|->
name|Param
argument_list|)
expr_stmt|;
return|return
name|FALSE
return|;
block|}
if|if
condition|(
name|AmRoot
condition|)
name|xchown
argument_list|(
name|sp
operator|->
name|Param
argument_list|)
expr_stmt|;
name|sp
operator|->
name|Channel
operator|=
name|CHANcreate
argument_list|(
name|fd
argument_list|,
name|CTfile
argument_list|,
name|CSwriting
argument_list|,
name|SITEreader
argument_list|,
name|SITEwritedone
argument_list|)
expr_stmt|;
name|syslog
argument_list|(
name|L_NOTICE
argument_list|,
literal|"%s opened %s"
argument_list|,
name|sp
operator|->
name|Name
argument_list|,
name|CHANname
argument_list|(
name|sp
operator|->
name|Channel
argument_list|)
argument_list|)
expr_stmt|;
name|WCHANset
argument_list|(
name|sp
operator|->
name|Channel
argument_list|,
literal|""
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
name|FTchannel
case|:
case|case
name|FTexploder
case|:
if|if
condition|(
operator|!
name|SITEstartprocess
argument_list|(
name|sp
argument_list|)
condition|)
return|return
name|FALSE
return|;
name|syslog
argument_list|(
name|L_NOTICE
argument_list|,
literal|"%s spawned %s"
argument_list|,
name|sp
operator|->
name|Name
argument_list|,
name|CHANname
argument_list|(
name|sp
operator|->
name|Channel
argument_list|)
argument_list|)
expr_stmt|;
name|WCHANset
argument_list|(
name|sp
operator|->
name|Channel
argument_list|,
literal|""
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|WCHANadd
argument_list|(
name|sp
operator|->
name|Channel
argument_list|)
expr_stmt|;
break|break;
block|}
return|return
name|TRUE
return|;
block|}
end_function

begin_comment
comment|/* **  A site's channel process died; restart it. */
end_comment

begin_function
name|void
name|SITEprocdied
parameter_list|(
name|sp
parameter_list|,
name|process
parameter_list|,
name|pp
parameter_list|)
name|SITE
modifier|*
name|sp
decl_stmt|;
name|int
name|process
decl_stmt|;
name|PROCESS
modifier|*
name|pp
decl_stmt|;
block|{
name|syslog
argument_list|(
name|pp
operator|->
name|Status
condition|?
name|L_ERROR
else|:
name|L_NOTICE
argument_list|,
literal|"%s exit %d elapsed %ld pid %ld"
argument_list|,
name|sp
operator|->
name|Name
condition|?
name|sp
operator|->
name|Name
else|:
literal|"?"
argument_list|,
name|pp
operator|->
name|Status
argument_list|,
operator|(
name|pp
operator|->
name|Collected
operator|-
name|pp
operator|->
name|Started
operator|)
operator|/
literal|60L
argument_list|,
operator|(
name|long
operator|)
name|pp
operator|->
name|Pid
argument_list|)
expr_stmt|;
if|if
condition|(
name|sp
operator|->
name|Process
operator|!=
name|process
operator|||
name|sp
operator|->
name|Name
operator|==
name|NULL
condition|)
comment|/* We already started a new process for this channel 	 * or this site has been dropped. */
return|return;
if|if
condition|(
name|sp
operator|->
name|Channel
operator|!=
name|NULL
condition|)
name|CHANclose
argument_list|(
name|sp
operator|->
name|Channel
argument_list|,
name|CHANname
argument_list|(
name|sp
operator|->
name|Channel
argument_list|)
argument_list|)
expr_stmt|;
name|sp
operator|->
name|Working
operator|=
name|SITEsetup
argument_list|(
name|sp
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|sp
operator|->
name|Working
condition|)
block|{
name|syslog
argument_list|(
name|L_ERROR
argument_list|,
literal|"%s cant restart %m"
argument_list|,
name|sp
operator|->
name|Name
argument_list|)
expr_stmt|;
return|return;
block|}
name|syslog
argument_list|(
name|L_NOTICE
argument_list|,
literal|"%s restarted"
argument_list|,
name|sp
operator|->
name|Name
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* **  A channel is about to be closed; see if any site cares. */
end_comment

begin_function
name|void
name|SITEchanclose
parameter_list|(
name|cp
parameter_list|)
specifier|register
name|CHANNEL
modifier|*
name|cp
decl_stmt|;
block|{
specifier|register
name|int
name|i
decl_stmt|;
specifier|register
name|SITE
modifier|*
name|sp
decl_stmt|;
name|int
modifier|*
name|ip
decl_stmt|;
for|for
control|(
name|i
operator|=
name|nSites
operator|,
name|sp
operator|=
name|Sites
init|;
operator|--
name|i
operator|>=
literal|0
condition|;
name|sp
operator|++
control|)
if|if
condition|(
name|sp
operator|->
name|Channel
operator|==
name|cp
condition|)
block|{
comment|/* Found the site that has this channel.  Start that 	     * site spooling, copy any data that might be pending, 	     * and arrange to retry later. */
if|if
condition|(
operator|!
name|SITEspool
argument_list|(
name|sp
argument_list|,
operator|(
name|CHANNEL
operator|*
operator|)
name|NULL
argument_list|)
condition|)
block|{
name|syslog
argument_list|(
name|L_ERROR
argument_list|,
literal|"%s loss %d bytes"
argument_list|,
name|sp
operator|->
name|Name
argument_list|,
name|i
argument_list|)
expr_stmt|;
return|return;
block|}
name|WCHANsetfrombuffer
argument_list|(
name|sp
operator|->
name|Channel
argument_list|,
operator|&
name|cp
operator|->
name|Out
argument_list|)
expr_stmt|;
name|WCHANadd
argument_list|(
name|sp
operator|->
name|Channel
argument_list|)
expr_stmt|;
name|ip
operator|=
name|NEW
argument_list|(
name|int
argument_list|,
literal|1
argument_list|)
expr_stmt|;
operator|*
name|ip
operator|=
name|sp
operator|-
name|Sites
expr_stmt|;
name|SCHANadd
argument_list|(
name|sp
operator|->
name|Channel
argument_list|,
call|(
name|time_t
call|)
argument_list|(
name|Now
operator|.
name|time
operator|+
name|CHANNEL_RETRY_TIME
argument_list|)
argument_list|,
operator|(
name|POINTER
operator|)
name|NULL
argument_list|,
name|SITEspoolwake
argument_list|,
operator|(
name|POINTER
operator|)
name|ip
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
end_function

begin_comment
comment|/* **  Flush any pending data waiting to be sent. */
end_comment

begin_function
name|void
name|SITEflush
parameter_list|(
name|sp
parameter_list|,
name|Restart
parameter_list|)
specifier|register
name|SITE
modifier|*
name|sp
decl_stmt|;
name|BOOL
name|Restart
decl_stmt|;
block|{
specifier|register
name|CHANNEL
modifier|*
name|cp
decl_stmt|;
specifier|register
name|BUFFER
modifier|*
name|out
decl_stmt|;
if|if
condition|(
name|sp
operator|->
name|Name
operator|==
name|NULL
condition|)
return|return;
name|SITEforward
argument_list|(
name|sp
argument_list|,
literal|"flush"
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|sp
operator|->
name|Type
condition|)
block|{
default|default:
name|syslog
argument_list|(
name|L_ERROR
argument_list|,
literal|"%s internal SITEflush %d"
argument_list|,
name|sp
operator|->
name|Name
argument_list|,
name|sp
operator|->
name|Type
argument_list|)
expr_stmt|;
return|return;
case|case
name|FTlogonly
case|:
case|case
name|FTprogram
case|:
case|case
name|FTfunnel
case|:
comment|/* Nothing to do here. */
return|return;
case|case
name|FTchannel
case|:
case|case
name|FTexploder
case|:
comment|/* If spooling, close the file right now. */
if|if
condition|(
name|sp
operator|->
name|Spooling
operator|&&
operator|(
name|cp
operator|=
name|sp
operator|->
name|Channel
operator|)
operator|!=
name|NULL
condition|)
block|{
operator|(
name|void
operator|)
name|WCHANflush
argument_list|(
name|cp
argument_list|)
expr_stmt|;
name|CHANclose
argument_list|(
name|cp
argument_list|,
name|CHANname
argument_list|(
name|cp
argument_list|)
argument_list|)
expr_stmt|;
name|sp
operator|->
name|Channel
operator|=
name|NULL
expr_stmt|;
block|}
break|break;
case|case
name|FTfile
case|:
break|break;
block|}
comment|/* We're only dealing with files and channels now. */
if|if
condition|(
operator|(
name|cp
operator|=
name|sp
operator|->
name|Channel
operator|)
operator|!=
name|NULL
condition|)
operator|(
name|void
operator|)
name|WCHANflush
argument_list|(
name|cp
argument_list|)
expr_stmt|;
comment|/* Restart the site, copy any pending data. */
if|if
condition|(
name|Restart
condition|)
block|{
if|if
condition|(
operator|!
name|SITEsetup
argument_list|(
name|sp
argument_list|)
condition|)
name|syslog
argument_list|(
name|L_ERROR
argument_list|,
literal|"%s cant restart %m"
argument_list|,
name|sp
operator|->
name|Name
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|cp
operator|!=
name|NULL
condition|)
block|{
if|if
condition|(
name|sp
operator|->
name|Buffered
condition|)
block|{
comment|/* SITEsetup had to buffer us; save any residue. */
name|out
operator|=
operator|&
name|sp
operator|->
name|Channel
operator|->
name|Out
expr_stmt|;
if|if
condition|(
name|out
operator|->
name|Left
condition|)
name|BUFFset
argument_list|(
operator|&
name|sp
operator|->
name|Buffer
argument_list|,
operator|&
name|out
operator|->
name|Data
index|[
name|out
operator|->
name|Used
index|]
argument_list|,
name|out
operator|->
name|Left
argument_list|)
expr_stmt|;
block|}
else|else
name|WCHANsetfrombuffer
argument_list|(
name|sp
operator|->
name|Channel
argument_list|,
operator|&
name|cp
operator|->
name|Out
argument_list|)
expr_stmt|;
block|}
block|}
elseif|else
if|if
condition|(
name|cp
operator|!=
name|NULL
operator|&&
name|cp
operator|->
name|Out
operator|.
name|Left
condition|)
block|{
if|if
condition|(
name|sp
operator|->
name|Type
operator|==
name|FTfile
operator|||
name|sp
operator|->
name|Spooling
condition|)
block|{
comment|/* Can't flush a file?  Hopeless. */
name|syslog
argument_list|(
name|L_ERROR
argument_list|,
literal|"%s dataloss %d"
argument_list|,
name|sp
operator|->
name|Name
argument_list|,
name|cp
operator|->
name|Out
operator|.
name|Left
argument_list|)
expr_stmt|;
return|return;
block|}
comment|/* Must be a working channel; spool and retry. */
name|syslog
argument_list|(
name|L_ERROR
argument_list|,
literal|"%s spooling %d bytes"
argument_list|,
name|sp
operator|->
name|Name
argument_list|,
name|cp
operator|->
name|Out
operator|.
name|Left
argument_list|)
expr_stmt|;
if|if
condition|(
name|SITEspool
argument_list|(
name|sp
argument_list|,
name|cp
argument_list|)
condition|)
name|SITEflush
argument_list|(
name|sp
argument_list|,
name|FALSE
argument_list|)
expr_stmt|;
return|return;
block|}
comment|/* Close the old channel if it was open. */
if|if
condition|(
name|cp
operator|!=
name|NULL
condition|)
block|{
comment|/* Make sure we have no dangling pointers to it. */
if|if
condition|(
operator|!
name|Restart
condition|)
name|sp
operator|->
name|Channel
operator|=
name|NULL
expr_stmt|;
name|CHANclose
argument_list|(
name|cp
argument_list|,
name|sp
operator|->
name|Name
argument_list|)
expr_stmt|;
if|if
condition|(
name|sp
operator|->
name|Type
operator|==
name|FTfile
condition|)
name|SITEcount
operator|--
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/* **  Flush all sites. */
end_comment

begin_function
name|void
name|SITEflushall
parameter_list|(
name|Restart
parameter_list|)
name|BOOL
name|Restart
decl_stmt|;
block|{
specifier|register
name|int
name|i
decl_stmt|;
specifier|register
name|SITE
modifier|*
name|sp
decl_stmt|;
for|for
control|(
name|i
operator|=
name|nSites
operator|,
name|sp
operator|=
name|Sites
init|;
operator|--
name|i
operator|>=
literal|0
condition|;
name|sp
operator|++
control|)
if|if
condition|(
name|sp
operator|->
name|Name
condition|)
name|SITEflush
argument_list|(
name|sp
argument_list|,
name|Restart
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* **  Run down the site's pattern list and see if it wants the specified **  newsgroup. */
end_comment

begin_function
name|BOOL
name|SITEwantsgroup
parameter_list|(
name|sp
parameter_list|,
name|name
parameter_list|)
specifier|register
name|SITE
modifier|*
name|sp
decl_stmt|;
specifier|register
name|char
modifier|*
name|name
decl_stmt|;
block|{
specifier|register
name|BOOL
name|match
decl_stmt|;
specifier|register
name|BOOL
name|subvalue
decl_stmt|;
specifier|register
name|char
modifier|*
name|pat
decl_stmt|;
specifier|register
name|char
modifier|*
modifier|*
name|argv
decl_stmt|;
name|match
operator|=
name|SUB_DEFAULT
expr_stmt|;
if|if
condition|(
name|ME
operator|.
name|Patterns
condition|)
block|{
for|for
control|(
name|argv
operator|=
name|ME
operator|.
name|Patterns
init|;
operator|(
name|pat
operator|=
operator|*
name|argv
operator|++
operator|)
operator|!=
name|NULL
condition|;
control|)
block|{
name|subvalue
operator|=
operator|*
name|pat
operator|!=
name|SUB_NEGATE
expr_stmt|;
if|if
condition|(
operator|!
name|subvalue
condition|)
name|pat
operator|++
expr_stmt|;
if|if
condition|(
name|wildmat
argument_list|(
name|name
argument_list|,
name|pat
argument_list|)
condition|)
name|match
operator|=
name|subvalue
expr_stmt|;
block|}
block|}
for|for
control|(
name|argv
operator|=
name|sp
operator|->
name|Patterns
init|;
operator|(
name|pat
operator|=
operator|*
name|argv
operator|++
operator|)
operator|!=
name|NULL
condition|;
control|)
block|{
name|subvalue
operator|=
operator|*
name|pat
operator|!=
name|SUB_NEGATE
expr_stmt|;
if|if
condition|(
operator|!
name|subvalue
condition|)
name|pat
operator|++
expr_stmt|;
if|if
condition|(
name|wildmat
argument_list|(
name|name
argument_list|,
name|pat
argument_list|)
condition|)
name|match
operator|=
name|subvalue
expr_stmt|;
block|}
return|return
name|match
return|;
block|}
end_function

begin_comment
comment|/* **  Find a site. */
end_comment

begin_function
name|SITE
modifier|*
name|SITEfind
parameter_list|(
name|p
parameter_list|)
name|char
modifier|*
name|p
decl_stmt|;
block|{
specifier|register
name|int
name|i
decl_stmt|;
specifier|register
name|SITE
modifier|*
name|sp
decl_stmt|;
for|for
control|(
name|i
operator|=
name|nSites
operator|,
name|sp
operator|=
name|Sites
init|;
operator|--
name|i
operator|>=
literal|0
condition|;
name|sp
operator|++
control|)
if|if
condition|(
name|sp
operator|->
name|Name
operator|&&
name|caseEQ
argument_list|(
name|p
argument_list|,
name|sp
operator|->
name|Name
argument_list|)
condition|)
return|return
name|sp
return|;
return|return
name|NULL
return|;
block|}
end_function

begin_comment
comment|/* **  Find the next site that matches this site. */
end_comment

begin_function
name|SITE
modifier|*
name|SITEfindnext
parameter_list|(
name|p
parameter_list|,
name|sp
parameter_list|)
name|char
modifier|*
name|p
decl_stmt|;
specifier|register
name|SITE
modifier|*
name|sp
decl_stmt|;
block|{
specifier|register
name|SITE
modifier|*
name|end
decl_stmt|;
for|for
control|(
name|sp
operator|++
operator|,
name|end
operator|=
operator|&
name|Sites
index|[
name|nSites
index|]
init|;
name|sp
operator|<
name|end
condition|;
name|sp
operator|++
control|)
if|if
condition|(
name|sp
operator|->
name|Name
operator|&&
name|caseEQ
argument_list|(
name|p
argument_list|,
name|sp
operator|->
name|Name
argument_list|)
condition|)
return|return
name|sp
return|;
return|return
name|NULL
return|;
block|}
end_function

begin_comment
comment|/* **  Close a site down. */
end_comment

begin_function
name|void
name|SITEfree
parameter_list|(
name|sp
parameter_list|)
specifier|register
name|SITE
modifier|*
name|sp
decl_stmt|;
block|{
specifier|register
name|SITE
modifier|*
name|s
decl_stmt|;
specifier|register
name|int
name|new
decl_stmt|;
specifier|register
name|int
name|i
decl_stmt|;
if|if
condition|(
name|sp
operator|->
name|Channel
condition|)
block|{
name|CHANclose
argument_list|(
name|sp
operator|->
name|Channel
argument_list|,
name|CHANname
argument_list|(
name|sp
operator|->
name|Channel
argument_list|)
argument_list|)
expr_stmt|;
name|sp
operator|->
name|Channel
operator|=
name|NULL
expr_stmt|;
block|}
name|sp
operator|->
name|Name
operator|=
name|NULL
expr_stmt|;
if|if
condition|(
name|sp
operator|->
name|Process
operator|>
literal|0
condition|)
block|{
comment|/* Kill the backpointer so PROCdied won't call us. */
name|PROCunwatch
argument_list|(
name|sp
operator|->
name|Process
argument_list|)
expr_stmt|;
name|sp
operator|->
name|Process
operator|=
operator|-
literal|1
expr_stmt|;
block|}
if|if
condition|(
name|sp
operator|->
name|Entry
condition|)
block|{
name|DISPOSE
argument_list|(
name|sp
operator|->
name|Entry
argument_list|)
expr_stmt|;
name|sp
operator|->
name|Entry
operator|=
name|NULL
expr_stmt|;
block|}
if|if
condition|(
name|sp
operator|->
name|Param
condition|)
block|{
name|DISPOSE
argument_list|(
name|sp
operator|->
name|Param
argument_list|)
expr_stmt|;
name|sp
operator|->
name|Param
operator|=
name|NULL
expr_stmt|;
block|}
if|if
condition|(
name|sp
operator|->
name|SpoolName
condition|)
block|{
name|DISPOSE
argument_list|(
name|sp
operator|->
name|SpoolName
argument_list|)
expr_stmt|;
name|sp
operator|->
name|SpoolName
operator|=
name|NULL
expr_stmt|;
block|}
if|if
condition|(
name|sp
operator|->
name|Patterns
condition|)
block|{
name|DISPOSE
argument_list|(
name|sp
operator|->
name|Patterns
argument_list|)
expr_stmt|;
name|sp
operator|->
name|Patterns
operator|=
name|NULL
expr_stmt|;
block|}
if|if
condition|(
name|sp
operator|->
name|Exclusions
condition|)
block|{
name|DISPOSE
argument_list|(
name|sp
operator|->
name|Exclusions
argument_list|)
expr_stmt|;
name|sp
operator|->
name|Exclusions
operator|=
name|NULL
expr_stmt|;
block|}
if|if
condition|(
name|sp
operator|->
name|Distributions
condition|)
block|{
name|DISPOSE
argument_list|(
name|sp
operator|->
name|Distributions
argument_list|)
expr_stmt|;
name|sp
operator|->
name|Distributions
operator|=
name|NULL
expr_stmt|;
block|}
if|if
condition|(
name|sp
operator|->
name|Buffer
operator|.
name|Data
condition|)
block|{
name|DISPOSE
argument_list|(
name|sp
operator|->
name|Buffer
operator|.
name|Data
argument_list|)
expr_stmt|;
name|sp
operator|->
name|Buffer
operator|.
name|Data
operator|=
name|NULL
expr_stmt|;
name|sp
operator|->
name|Buffer
operator|.
name|Size
operator|=
literal|0
expr_stmt|;
block|}
if|if
condition|(
name|sp
operator|->
name|FNLnames
operator|.
name|Data
condition|)
block|{
name|DISPOSE
argument_list|(
name|sp
operator|->
name|FNLnames
operator|.
name|Data
argument_list|)
expr_stmt|;
name|sp
operator|->
name|FNLnames
operator|.
name|Data
operator|=
name|NULL
expr_stmt|;
name|sp
operator|->
name|FNLnames
operator|.
name|Size
operator|=
literal|0
expr_stmt|;
block|}
comment|/* If this site was a master, find a new one. */
if|if
condition|(
name|sp
operator|->
name|IsMaster
condition|)
block|{
for|for
control|(
name|new
operator|=
name|NOSITE
operator|,
name|s
operator|=
name|Sites
operator|,
name|i
operator|=
name|nSites
init|;
operator|--
name|i
operator|>=
literal|0
condition|;
name|s
operator|++
control|)
if|if
condition|(
operator|&
name|Sites
index|[
name|s
operator|->
name|Master
index|]
operator|==
name|sp
condition|)
if|if
condition|(
name|new
operator|==
name|NOSITE
condition|)
block|{
name|s
operator|->
name|Master
operator|=
name|NOSITE
expr_stmt|;
name|s
operator|->
name|IsMaster
operator|=
name|TRUE
expr_stmt|;
name|new
operator|=
name|s
operator|-
name|Sites
expr_stmt|;
block|}
else|else
name|s
operator|->
name|Master
operator|=
name|new
expr_stmt|;
name|sp
operator|->
name|IsMaster
operator|=
name|FALSE
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/* **  If a site is an exploder or funnels into one, forward a command **  to it. */
end_comment

begin_function
name|void
name|SITEforward
parameter_list|(
name|sp
parameter_list|,
name|text
parameter_list|)
specifier|register
name|SITE
modifier|*
name|sp
decl_stmt|;
name|char
modifier|*
name|text
decl_stmt|;
block|{
specifier|register
name|SITE
modifier|*
name|fsp
decl_stmt|;
specifier|register
name|char
modifier|*
name|p
decl_stmt|;
name|char
name|buff
index|[
name|SMBUF
index|]
decl_stmt|;
name|fsp
operator|=
name|sp
expr_stmt|;
if|if
condition|(
name|sp
operator|->
name|Name
operator|==
name|NULL
operator|||
name|fsp
operator|->
name|Name
operator|==
name|NULL
condition|)
return|return;
if|if
condition|(
name|fsp
operator|->
name|Funnel
operator|!=
name|NOSITE
condition|)
name|fsp
operator|=
operator|&
name|Sites
index|[
name|fsp
operator|->
name|Funnel
index|]
expr_stmt|;
if|if
condition|(
name|fsp
operator|->
name|Type
operator|==
name|FTexploder
condition|)
block|{
operator|(
name|void
operator|)
name|strcpy
argument_list|(
name|buff
argument_list|,
name|text
argument_list|)
expr_stmt|;
if|if
condition|(
name|fsp
operator|!=
name|sp
operator|&&
name|fsp
operator|->
name|FNLwantsnames
condition|)
block|{
name|p
operator|=
name|buff
operator|+
name|strlen
argument_list|(
name|buff
argument_list|)
expr_stmt|;
operator|*
name|p
operator|++
operator|=
literal|' '
expr_stmt|;
operator|(
name|void
operator|)
name|strcpy
argument_list|(
name|p
argument_list|,
name|sp
operator|->
name|Name
argument_list|)
expr_stmt|;
block|}
name|SITEwrite
argument_list|(
name|fsp
argument_list|,
name|buff
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/* **  Drop a site. */
end_comment

begin_function
name|void
name|SITEdrop
parameter_list|(
name|sp
parameter_list|)
name|SITE
modifier|*
name|sp
decl_stmt|;
block|{
name|SITEforward
argument_list|(
name|sp
argument_list|,
literal|"drop"
argument_list|)
expr_stmt|;
name|SITEflush
argument_list|(
name|sp
argument_list|,
name|FALSE
argument_list|)
expr_stmt|;
name|SITEfree
argument_list|(
name|sp
argument_list|)
expr_stmt|;
name|sp
operator|->
name|Name
operator|=
name|NULL
expr_stmt|;
name|SITElinkall
argument_list|()
expr_stmt|;
block|}
end_function

begin_comment
comment|/* **  Put all the feeds into a doubly-linked list. */
end_comment

begin_function
name|void
name|SITElinkall
parameter_list|()
block|{
specifier|register
name|SITE
modifier|*
name|sp
decl_stmt|;
if|if
condition|(
name|nSites
operator|<
literal|2
condition|)
return|return;
name|SITEhead
operator|=
operator|&
name|Sites
index|[
literal|0
index|]
expr_stmt|;
name|SITEtail
operator|=
operator|&
name|Sites
index|[
name|nSites
operator|-
literal|1
index|]
expr_stmt|;
for|for
control|(
name|sp
operator|=
name|SITEhead
init|;
operator|++
name|sp
operator|<
name|SITEtail
condition|;
control|)
name|sp
index|[
operator|-
literal|1
index|]
operator|.
name|Next
operator|=
name|sp
index|[
literal|1
index|]
operator|.
name|Prev
operator|=
name|sp
expr_stmt|;
name|SITEhead
operator|->
name|Prev
operator|=
name|NULL
expr_stmt|;
if|if
condition|(
name|SITEhead
operator|->
name|Next
condition|)
name|SITEhead
operator|->
name|Next
operator|->
name|Prev
operator|=
name|SITEhead
expr_stmt|;
name|SITEtail
operator|->
name|Next
operator|=
name|NULL
expr_stmt|;
if|if
condition|(
name|SITEtail
operator|->
name|Prev
condition|)
name|SITEtail
operator|->
name|Prev
operator|->
name|Next
operator|=
name|SITEtail
expr_stmt|;
block|}
end_function

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Copyright (c) 1983, 1993  *	The Regents of the University of California.  All rights reserved.  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions  * are met:  * 1. Redistributions of source code must retain the above copyright  *    notice, this list of conditions and the following disclaimer.  * 2. Redistributions in binary form must reproduce the above copyright  *    notice, this list of conditions and the following disclaimer in the  *    documentation and/or other materials provided with the distribution.  * 3. All advertising materials mentioning features or use of this software  *    must display the following acknowledgement:  *	This product includes software developed by the University of  *	California, Berkeley and its contributors.  * 4. Neither the name of the University nor the names of its contributors  *    may be used to endorse or promote products derived from this software  *    without specific prior written permission.  *  * THIS SOFTWARE IS PROVIDED BY THE REGENTS AND CONTRIBUTORS ``AS IS'' AND  * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE  * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE  * ARE DISCLAIMED.  IN NO EVENT SHALL THE REGENTS OR CONTRIBUTORS BE LIABLE  * FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL  * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS  * OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)  * HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT  * LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY  * OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF  * SUCH DAMAGE.  */
end_comment

begin_ifndef
ifndef|#
directive|ifndef
name|lint
end_ifndef

begin_decl_stmt
specifier|static
name|char
name|sccsid
index|[]
init|=
literal|"@(#)com7.c	8.1 (Berkeley) 5/31/93"
decl_stmt|;
end_decl_stmt

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* not lint */
end_comment

begin_include
include|#
directive|include
file|"externs.h"
end_include

begin_macro
name|fight
argument_list|(
argument|enemy
argument_list|,
argument|strength
argument_list|)
end_macro

begin_decl_stmt
name|int
name|enemy
decl_stmt|,
name|strength
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|int
name|lifeline
init|=
literal|0
decl_stmt|;
name|int
name|hurt
decl_stmt|;
name|char
name|auxbuf
index|[
name|LINELENGTH
index|]
decl_stmt|;
name|char
modifier|*
name|next
decl_stmt|;
name|int
name|i
decl_stmt|;
name|int
name|exhaustion
decl_stmt|;
name|fighton
label|:
name|time
operator|++
expr_stmt|;
name|snooze
operator|-=
literal|5
expr_stmt|;
if|if
condition|(
name|snooze
operator|>
name|time
condition|)
name|exhaustion
operator|=
name|CYCLE
operator|/
operator|(
name|snooze
operator|-
name|time
operator|)
expr_stmt|;
else|else
block|{
name|puts
argument_list|(
literal|"You collapse exhausted, and he pulverizes your skull."
argument_list|)
expr_stmt|;
name|die
argument_list|()
expr_stmt|;
block|}
if|if
condition|(
name|snooze
operator|-
name|time
operator|<
literal|20
condition|)
name|puts
argument_list|(
literal|"You look tired! I hope you're able to fight."
argument_list|)
expr_stmt|;
name|next
operator|=
name|getcom
argument_list|(
name|auxbuf
argument_list|,
name|LINELENGTH
argument_list|,
literal|"<fight!>-: "
argument_list|,
literal|0
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|next
operator|&&
name|i
operator|<
literal|10
condition|;
name|i
operator|++
control|)
name|next
operator|=
name|getword
argument_list|(
name|next
argument_list|,
name|words
index|[
name|i
index|]
argument_list|,
operator|-
literal|1
argument_list|)
expr_stmt|;
name|parse
argument_list|()
expr_stmt|;
switch|switch
condition|(
name|wordvalue
index|[
name|wordnumber
index|]
condition|)
block|{
case|case
name|KILL
case|:
case|case
name|SMITE
case|:
if|if
condition|(
name|testbit
argument_list|(
name|inven
argument_list|,
name|TWO_HANDED
argument_list|)
condition|)
name|hurt
operator|=
name|rnd
argument_list|(
literal|70
argument_list|)
operator|-
literal|2
operator|*
name|card
argument_list|(
name|injuries
argument_list|,
name|NUMOFINJURIES
argument_list|)
operator|-
name|ucard
argument_list|(
name|wear
argument_list|)
operator|-
name|exhaustion
expr_stmt|;
elseif|else
if|if
condition|(
name|testbit
argument_list|(
name|inven
argument_list|,
name|SWORD
argument_list|)
operator|||
name|testbit
argument_list|(
name|inven
argument_list|,
name|BROAD
argument_list|)
condition|)
name|hurt
operator|=
name|rnd
argument_list|(
literal|50
argument_list|)
operator|%
operator|(
name|WEIGHT
operator|-
name|carrying
operator|)
operator|-
name|card
argument_list|(
name|injuries
argument_list|,
name|NUMOFINJURIES
argument_list|)
operator|-
name|encumber
operator|-
name|exhaustion
expr_stmt|;
elseif|else
if|if
condition|(
name|testbit
argument_list|(
name|inven
argument_list|,
name|KNIFE
argument_list|)
operator|||
name|testbit
argument_list|(
name|inven
argument_list|,
name|MALLET
argument_list|)
operator|||
name|testbit
argument_list|(
name|inven
argument_list|,
name|CHAIN
argument_list|)
operator|||
name|testbit
argument_list|(
name|inven
argument_list|,
name|MACE
argument_list|)
operator|||
name|testbit
argument_list|(
name|inven
argument_list|,
name|HALBERD
argument_list|)
condition|)
name|hurt
operator|=
name|rnd
argument_list|(
literal|15
argument_list|)
operator|-
name|card
argument_list|(
name|injuries
argument_list|,
name|NUMOFINJURIES
argument_list|)
operator|-
name|exhaustion
expr_stmt|;
else|else
name|hurt
operator|=
name|rnd
argument_list|(
literal|7
argument_list|)
operator|-
name|encumber
expr_stmt|;
if|if
condition|(
name|hurt
operator|<
literal|5
condition|)
switch|switch
condition|(
name|rnd
argument_list|(
literal|3
argument_list|)
condition|)
block|{
case|case
literal|0
case|:
name|puts
argument_list|(
literal|"You swung wide and missed."
argument_list|)
expr_stmt|;
break|break;
case|case
literal|1
case|:
name|puts
argument_list|(
literal|"He checked your blow. CLASH! CLANG!"
argument_list|)
expr_stmt|;
break|break;
case|case
literal|2
case|:
name|puts
argument_list|(
literal|"His filthy tunic hangs by one less thread."
argument_list|)
expr_stmt|;
break|break;
block|}
elseif|else
if|if
condition|(
name|hurt
operator|<
literal|10
condition|)
block|{
switch|switch
condition|(
name|rnd
argument_list|(
literal|3
argument_list|)
condition|)
block|{
case|case
literal|0
case|:
name|puts
argument_list|(
literal|"He's bleeding."
argument_list|)
expr_stmt|;
break|break;
case|case
literal|1
case|:
name|puts
argument_list|(
literal|"A trickle of blood runs down his face."
argument_list|)
expr_stmt|;
break|break;
case|case
literal|2
case|:
name|puts
argument_list|(
literal|"A huge purple bruise is forming on the side of his face."
argument_list|)
expr_stmt|;
break|break;
block|}
name|lifeline
operator|++
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|hurt
operator|<
literal|20
condition|)
block|{
switch|switch
condition|(
name|rnd
argument_list|(
literal|3
argument_list|)
condition|)
block|{
case|case
literal|0
case|:
name|puts
argument_list|(
literal|"He staggers back quavering."
argument_list|)
expr_stmt|;
break|break;
case|case
literal|1
case|:
name|puts
argument_list|(
literal|"He jumps back with his hand over the wound."
argument_list|)
expr_stmt|;
break|break;
case|case
literal|2
case|:
name|puts
argument_list|(
literal|"His shirt falls open with a swath across the chest."
argument_list|)
expr_stmt|;
break|break;
block|}
name|lifeline
operator|+=
literal|5
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|hurt
operator|<
literal|30
condition|)
block|{
switch|switch
condition|(
name|rnd
argument_list|(
literal|3
argument_list|)
condition|)
block|{
case|case
literal|0
case|:
name|printf
argument_list|(
literal|"A bloody gash opens up on his %s side.\n"
argument_list|,
operator|(
name|rnd
argument_list|(
literal|2
argument_list|)
condition|?
literal|"left"
else|:
literal|"right"
operator|)
argument_list|)
expr_stmt|;
break|break;
case|case
literal|1
case|:
name|puts
argument_list|(
literal|"The steel bites home and scrapes along his ribs."
argument_list|)
expr_stmt|;
break|break;
case|case
literal|2
case|:
name|puts
argument_list|(
literal|"You pierce him, and his breath hisses through clenched teeth."
argument_list|)
expr_stmt|;
break|break;
block|}
name|lifeline
operator|+=
literal|10
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|hurt
operator|<
literal|40
condition|)
block|{
switch|switch
condition|(
name|rnd
argument_list|(
literal|3
argument_list|)
condition|)
block|{
case|case
literal|0
case|:
name|puts
argument_list|(
literal|"You smite him to the ground."
argument_list|)
expr_stmt|;
if|if
condition|(
name|strength
operator|-
name|lifeline
operator|>
literal|20
condition|)
name|puts
argument_list|(
literal|"But in a flurry of steel he regains his feet!"
argument_list|)
expr_stmt|;
break|break;
case|case
literal|1
case|:
name|puts
argument_list|(
literal|"The force of your blow sends him to his knees."
argument_list|)
expr_stmt|;
name|puts
argument_list|(
literal|"His arm swings lifeless at his side."
argument_list|)
expr_stmt|;
break|break;
case|case
literal|2
case|:
name|puts
argument_list|(
literal|"Clutching his blood drenched shirt, he collapses stunned."
argument_list|)
expr_stmt|;
break|break;
block|}
name|lifeline
operator|+=
literal|20
expr_stmt|;
block|}
else|else
block|{
switch|switch
condition|(
name|rnd
argument_list|(
literal|3
argument_list|)
condition|)
block|{
case|case
literal|0
case|:
name|puts
argument_list|(
literal|"His ribs crack under your powerful swing, flooding his lungs with blood."
argument_list|)
expr_stmt|;
break|break;
case|case
literal|1
case|:
name|puts
argument_list|(
literal|"You shatter his upheld arm in a spray of blood.  The blade continues deep"
argument_list|)
expr_stmt|;
name|puts
argument_list|(
literal|"into his back, severing the spinal cord."
argument_list|)
expr_stmt|;
name|lifeline
operator|+=
literal|25
expr_stmt|;
break|break;
case|case
literal|2
case|:
name|puts
argument_list|(
literal|"With a mighty lunge the steel slides in, and gasping, he falls to the ground."
argument_list|)
expr_stmt|;
name|lifeline
operator|+=
literal|25
expr_stmt|;
break|break;
block|}
name|lifeline
operator|+=
literal|30
expr_stmt|;
block|}
break|break;
case|case
name|BACK
case|:
if|if
condition|(
name|enemy
operator|==
name|DARK
operator|&&
name|lifeline
operator|>
name|strength
operator|*
literal|0.33
condition|)
block|{
name|puts
argument_list|(
literal|"He throws you back against the rock and pummels your face."
argument_list|)
expr_stmt|;
if|if
condition|(
name|testbit
argument_list|(
name|inven
argument_list|,
name|AMULET
argument_list|)
operator|||
name|testbit
argument_list|(
name|wear
argument_list|,
name|AMULET
argument_list|)
condition|)
block|{
name|printf
argument_list|(
literal|"Lifting the amulet from you, "
argument_list|)
expr_stmt|;
if|if
condition|(
name|testbit
argument_list|(
name|inven
argument_list|,
name|MEDALION
argument_list|)
operator|||
name|testbit
argument_list|(
name|wear
argument_list|,
name|MEDALION
argument_list|)
condition|)
block|{
name|puts
argument_list|(
literal|"his power grows and the walls of\nthe earth tremble."
argument_list|)
expr_stmt|;
name|puts
argument_list|(
literal|"When he touches the medallion, your chest explodes and the foundations of the\nearth collapse."
argument_list|)
expr_stmt|;
name|puts
argument_list|(
literal|"The planet is consumed by darkness."
argument_list|)
expr_stmt|;
name|die
argument_list|()
expr_stmt|;
block|}
if|if
condition|(
name|testbit
argument_list|(
name|inven
argument_list|,
name|AMULET
argument_list|)
condition|)
block|{
name|clearbit
argument_list|(
name|inven
argument_list|,
name|AMULET
argument_list|)
expr_stmt|;
name|carrying
operator|-=
name|objwt
index|[
name|AMULET
index|]
expr_stmt|;
name|encumber
operator|-=
name|objcumber
index|[
name|AMULET
index|]
expr_stmt|;
block|}
else|else
name|clearbit
argument_list|(
name|wear
argument_list|,
name|AMULET
argument_list|)
expr_stmt|;
name|puts
argument_list|(
literal|"he flees down the dark caverns."
argument_list|)
expr_stmt|;
name|clearbit
argument_list|(
name|location
index|[
name|position
index|]
operator|.
name|objects
argument_list|,
name|DARK
argument_list|)
expr_stmt|;
name|injuries
index|[
name|SKULL
index|]
operator|=
literal|1
expr_stmt|;
name|followfight
operator|=
name|time
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
else|else
block|{
name|puts
argument_list|(
literal|"I'm afraid you have been killed."
argument_list|)
expr_stmt|;
name|die
argument_list|()
expr_stmt|;
block|}
block|}
else|else
block|{
name|puts
argument_list|(
literal|"You escape stunned and disoriented from the fight."
argument_list|)
expr_stmt|;
name|puts
argument_list|(
literal|"A victorious bellow echoes from the battlescene."
argument_list|)
expr_stmt|;
if|if
condition|(
name|back
operator|&&
name|position
operator|!=
name|back
condition|)
name|move
argument_list|(
name|back
argument_list|,
name|BACK
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|ahead
operator|&&
name|position
operator|!=
name|ahead
condition|)
name|move
argument_list|(
name|ahead
argument_list|,
name|AHEAD
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|left
operator|&&
name|position
operator|!=
name|left
condition|)
name|move
argument_list|(
name|left
argument_list|,
name|LEFT
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|right
operator|&&
name|position
operator|!=
name|right
condition|)
name|move
argument_list|(
name|right
argument_list|,
name|RIGHT
argument_list|)
expr_stmt|;
else|else
name|move
argument_list|(
name|location
index|[
name|position
index|]
operator|.
name|down
argument_list|,
name|AHEAD
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
case|case
name|SHOOT
case|:
if|if
condition|(
name|testbit
argument_list|(
name|inven
argument_list|,
name|LASER
argument_list|)
condition|)
block|{
if|if
condition|(
name|strength
operator|-
name|lifeline
operator|<=
literal|50
condition|)
block|{
name|printf
argument_list|(
literal|"The %s took a direct hit!\n"
argument_list|,
name|objsht
index|[
name|enemy
index|]
argument_list|)
expr_stmt|;
name|lifeline
operator|+=
literal|50
expr_stmt|;
block|}
else|else
block|{
name|puts
argument_list|(
literal|"With his bare hand he deflects the laser blast and whips the pistol from you!"
argument_list|)
expr_stmt|;
name|clearbit
argument_list|(
name|inven
argument_list|,
name|LASER
argument_list|)
expr_stmt|;
name|setbit
argument_list|(
name|location
index|[
name|position
index|]
operator|.
name|objects
argument_list|,
name|LASER
argument_list|)
expr_stmt|;
name|carrying
operator|-=
name|objwt
index|[
name|LASER
index|]
expr_stmt|;
name|encumber
operator|-=
name|objcumber
index|[
name|LASER
index|]
expr_stmt|;
block|}
block|}
else|else
name|puts
argument_list|(
literal|"Unfortunately, you don't have a blaster handy."
argument_list|)
expr_stmt|;
break|break;
case|case
name|DROP
case|:
case|case
name|DRAW
case|:
name|cypher
argument_list|()
expr_stmt|;
name|time
operator|--
expr_stmt|;
break|break;
default|default:
name|puts
argument_list|(
literal|"You don't have a chance, he is too quick."
argument_list|)
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|lifeline
operator|>=
name|strength
condition|)
block|{
name|printf
argument_list|(
literal|"You have killed the %s.\n"
argument_list|,
name|objsht
index|[
name|enemy
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|enemy
operator|==
name|ELF
operator|||
name|enemy
operator|==
name|DARK
condition|)
name|puts
argument_list|(
literal|"A watery black smoke consumes his body and then vanishes with a peal of thunder!"
argument_list|)
expr_stmt|;
name|clearbit
argument_list|(
name|location
index|[
name|position
index|]
operator|.
name|objects
argument_list|,
name|enemy
argument_list|)
expr_stmt|;
name|power
operator|+=
literal|2
expr_stmt|;
name|notes
index|[
name|JINXED
index|]
operator|++
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
name|puts
argument_list|(
literal|"He attacks..."
argument_list|)
expr_stmt|;
comment|/* some embellisments */
name|hurt
operator|=
name|rnd
argument_list|(
name|NUMOFINJURIES
argument_list|)
operator|-
operator|(
name|testbit
argument_list|(
name|inven
argument_list|,
name|SHIELD
argument_list|)
operator|!=
literal|0
operator|)
operator|-
operator|(
name|testbit
argument_list|(
name|wear
argument_list|,
name|MAIL
argument_list|)
operator|!=
literal|0
operator|)
operator|-
operator|(
name|testbit
argument_list|(
name|wear
argument_list|,
name|HELM
argument_list|)
operator|!=
literal|0
operator|)
expr_stmt|;
name|hurt
operator|+=
operator|(
name|testbit
argument_list|(
name|wear
argument_list|,
name|AMULET
argument_list|)
operator|!=
literal|0
operator|)
operator|+
operator|(
name|testbit
argument_list|(
name|wear
argument_list|,
name|MEDALION
argument_list|)
operator|!=
literal|0
operator|)
operator|+
operator|(
name|testbit
argument_list|(
name|wear
argument_list|,
name|TALISMAN
argument_list|)
operator|!=
literal|0
operator|)
expr_stmt|;
name|hurt
operator|=
name|hurt
operator|<
literal|0
condition|?
literal|0
else|:
name|hurt
expr_stmt|;
name|hurt
operator|=
name|hurt
operator|>=
name|NUMOFINJURIES
condition|?
name|NUMOFINJURIES
operator|-
literal|1
else|:
name|hurt
expr_stmt|;
if|if
condition|(
operator|!
name|injuries
index|[
name|hurt
index|]
condition|)
block|{
name|injuries
index|[
name|hurt
index|]
operator|=
literal|1
expr_stmt|;
name|printf
argument_list|(
literal|"I'm afraid you have suffered %s.\n"
argument_list|,
name|ouch
index|[
name|hurt
index|]
argument_list|)
expr_stmt|;
block|}
else|else
name|puts
argument_list|(
literal|"You emerge unscathed."
argument_list|)
expr_stmt|;
if|if
condition|(
name|injuries
index|[
name|SKULL
index|]
operator|&&
name|injuries
index|[
name|INCISE
index|]
operator|&&
name|injuries
index|[
name|NECK
index|]
condition|)
block|{
name|puts
argument_list|(
literal|"I'm afraid you have suffered fatal injuries."
argument_list|)
expr_stmt|;
name|die
argument_list|()
expr_stmt|;
block|}
goto|goto
name|fighton
goto|;
block|}
end_block

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * kmc.c from 5.0 (on ihwld) hacked for 4.2  * Bob Van Valzah  2/7/84  */
end_comment

begin_comment
comment|/* @(#)kmc.c	1.3 */
end_comment

begin_comment
comment|/*  * KMC11 microprocessor driver  */
end_comment

begin_include
include|#
directive|include
file|"kmc.h"
end_include

begin_if
if|#
directive|if
name|NKMC
operator|>
literal|0
end_if

begin_include
include|#
directive|include
file|"syslog.h"
end_include

begin_include
include|#
directive|include
file|"param.h"
end_include

begin_include
include|#
directive|include
file|"ioctl.h"
end_include

begin_include
include|#
directive|include
file|"tty.h"
end_include

begin_include
include|#
directive|include
file|"kmcreg.h"
end_include

begin_include
include|#
directive|include
file|"buf.h"
end_include

begin_include
include|#
directive|include
file|"dir.h"
end_include

begin_include
include|#
directive|include
file|"user.h"
end_include

begin_include
include|#
directive|include
file|"../vaxuba/ubavar.h"
end_include

begin_include
include|#
directive|include
file|"uio.h"
end_include

begin_ifdef
ifdef|#
directive|ifdef
name|DATAKIT
end_ifdef

begin_include
include|#
directive|include
file|"dkitkmc.h"
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_ifdef
ifdef|#
directive|ifdef
name|RJE
end_ifdef

begin_include
include|#
directive|include
file|"vpm.h"
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_define
define|#
directive|define
name|ushort
value|u_short
end_define

begin_decl_stmt
name|int
name|kmc_cnt
init|=
name|NKMC
decl_stmt|;
end_decl_stmt

begin_struct
struct|struct
name|kmc
block|{
name|struct
name|clist
name|k_inq
decl_stmt|;
name|short
name|k_stat
decl_stmt|;
name|char
name|k_type
decl_stmt|;
name|short
name|k_arg
index|[
literal|3
index|]
decl_stmt|;
name|int
function_decl|(
modifier|*
name|k_rint
function_decl|)
parameter_list|()
function_decl|;
name|int
function_decl|(
modifier|*
name|k_init
function_decl|)
parameter_list|()
function_decl|;
name|int
function_decl|(
modifier|*
name|k_reset
function_decl|)
parameter_list|()
function_decl|;
block|}
name|kmc
index|[
name|NKMC
index|]
struct|;
end_struct

begin_define
define|#
directive|define
name|KMC11A
value|1
end_define

begin_define
define|#
directive|define
name|KMC11B
value|2
end_define

begin_define
define|#
directive|define
name|KASIZE
value|1024
end_define

begin_define
define|#
directive|define
name|KBSIZE
value|4096
end_define

begin_define
define|#
directive|define
name|RUN
value|(1<<7)
end_define

begin_define
define|#
directive|define
name|MCLR
value|(1<<6)
end_define

begin_define
define|#
directive|define
name|CWRT
value|(1<<5)
end_define

begin_define
define|#
directive|define
name|LUB
value|(1<<4)
end_define

begin_define
define|#
directive|define
name|LUA
value|(1<<3)
end_define

begin_define
define|#
directive|define
name|ROMO
value|(1<<2)
end_define

begin_define
define|#
directive|define
name|ROMI
value|(1<<1)
end_define

begin_define
define|#
directive|define
name|STEP
value|(1<<0)
end_define

begin_define
define|#
directive|define
name|RDYO
value|0200
end_define

begin_define
define|#
directive|define
name|RDYI
value|020
end_define

begin_define
define|#
directive|define
name|RQI
value|0200
end_define

begin_define
define|#
directive|define
name|IEI
value|01
end_define

begin_define
define|#
directive|define
name|IEO
value|020
end_define

begin_define
define|#
directive|define
name|STYPE
value|017
end_define

begin_define
define|#
directive|define
name|SRUN
value|020
end_define

begin_define
define|#
directive|define
name|SRINT
value|040
end_define

begin_define
define|#
directive|define
name|SOPEN
value|0100
end_define

begin_define
define|#
directive|define
name|SLOAD
value|0200
end_define

begin_define
define|#
directive|define
name|SINIT
value|0400
end_define

begin_define
define|#
directive|define
name|SRESET
value|01000
end_define

begin_struct
struct|struct
name|kmcdevice
block|{
union|union
block|{
name|char
name|b
index|[
literal|8
index|]
decl_stmt|;
name|unsigned
name|short
name|w
index|[
literal|4
index|]
decl_stmt|;
block|}
name|un
union|;
block|}
struct|;
end_struct

begin_define
define|#
directive|define
name|bsel0
value|un.b[0]
end_define

begin_define
define|#
directive|define
name|bsel1
value|un.b[1]
end_define

begin_define
define|#
directive|define
name|bsel2
value|un.b[2]
end_define

begin_define
define|#
directive|define
name|bsel3
value|un.b[3]
end_define

begin_define
define|#
directive|define
name|bsel4
value|un.b[4]
end_define

begin_define
define|#
directive|define
name|bsel5
value|un.b[5]
end_define

begin_define
define|#
directive|define
name|bsel6
value|un.b[6]
end_define

begin_define
define|#
directive|define
name|bsel7
value|un.b[7]
end_define

begin_define
define|#
directive|define
name|sel0
value|un.w[0]
end_define

begin_define
define|#
directive|define
name|sel2
value|un.w[1]
end_define

begin_define
define|#
directive|define
name|sel4
value|un.w[2]
end_define

begin_define
define|#
directive|define
name|sel6
value|un.w[3]
end_define

begin_decl_stmt
name|int
name|rkmcdebug
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|kmcprobe
argument_list|()
decl_stmt|,
name|kmcattach
argument_list|()
decl_stmt|,
name|kmcxint
argument_list|()
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|struct
name|uba_device
modifier|*
name|kmcdinfo
index|[
name|NKMC
index|]
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|u_short
name|kmcstd
index|[]
init|=
block|{
literal|0
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|struct
name|uba_driver
name|kmcdriver
init|=
block|{
name|kmcprobe
block|,
literal|0
block|,
name|kmcattach
block|,
literal|0
block|,
name|kmcstd
block|,
literal|"kmc"
block|,
name|kmcdinfo
block|}
decl_stmt|;
end_decl_stmt

begin_macro
name|kmcprobe
argument_list|(
argument|reg
argument_list|)
end_macro

begin_decl_stmt
name|caddr_t
name|reg
decl_stmt|;
end_decl_stmt

begin_block
block|{
specifier|register
name|int
name|br
decl_stmt|,
name|cvec
decl_stmt|;
comment|/* don't touch */
specifier|register
name|struct
name|kmcdevice
modifier|*
name|kp
init|=
operator|(
expr|struct
name|kmcdevice
operator|*
operator|)
name|reg
decl_stmt|;
specifier|register
name|s
expr_stmt|;
ifdef|#
directive|ifdef
name|lint
name|br
operator|=
literal|0
expr_stmt|;
name|cvec
operator|=
name|br
expr_stmt|;
name|br
operator|=
name|cvec
expr_stmt|;
endif|#
directive|endif
name|s
operator|=
name|spl7
argument_list|()
expr_stmt|;
name|kp
operator|->
name|bsel1
operator|=
name|MCLR
expr_stmt|;
name|splx
argument_list|(
name|s
argument_list|)
expr_stmt|;
name|kp
operator|->
name|bsel1
operator|=
name|ROMI
expr_stmt|;
name|kp
operator|->
name|sel4
operator|=
literal|0200
expr_stmt|;
comment|/* bus request */
name|kp
operator|->
name|sel6
operator|=
literal|0121111
expr_stmt|;
comment|/* mov csr4,obr */
name|kp
operator|->
name|bsel1
operator|=
name|ROMI
operator||
name|STEP
expr_stmt|;
name|DELAY
argument_list|(
literal|50
argument_list|)
expr_stmt|;
name|kp
operator|->
name|bsel1
operator|=
literal|0
expr_stmt|;
return|return
operator|(
literal|1
operator|)
return|;
block|}
end_block

begin_expr_stmt
name|kmcattach
argument_list|(
name|ui
argument_list|)
specifier|register
expr|struct
name|uba_device
operator|*
name|ui
expr_stmt|;
end_expr_stmt

begin_block
block|{
switch|switch
condition|(
name|ui
operator|->
name|ui_flags
operator|&
literal|03
condition|)
block|{
if|#
directive|if
name|NVPM
operator|>
literal|0
case|case
literal|0
case|:
name|vpminit
argument_list|(
name|ui
argument_list|)
expr_stmt|;
break|break;
endif|#
directive|endif
if|#
directive|if
name|NDKITKMC
operator|>
literal|0
case|case
literal|1
case|:
name|dkkmc_attach
argument_list|(
name|ui
argument_list|)
expr_stmt|;
break|break;
endif|#
directive|endif
default|default:
name|log
argument_list|(
name|LOG_ERR
argument_list|,
literal|"kmc%d: no protocol %d\n"
argument_list|,
name|ui
operator|->
name|ui_unit
argument_list|,
name|ui
operator|->
name|ui_flags
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
end_block

begin_comment
comment|/*ARGSUSED*/
end_comment

begin_macro
name|kmcopen
argument_list|(
argument|dev
argument_list|,
argument|flag
argument_list|)
end_macro

begin_block
block|{
specifier|register
name|struct
name|kmcdevice
modifier|*
name|kp
decl_stmt|;
specifier|register
name|struct
name|kmc
modifier|*
name|tp
decl_stmt|;
specifier|register
name|sav
expr_stmt|;
name|dev
operator|=
name|minor
argument_list|(
name|dev
argument_list|)
expr_stmt|;
if|if
condition|(
name|dev
operator|>=
name|kmc_cnt
operator|||
operator|(
name|tp
operator|=
operator|&
name|kmc
index|[
name|dev
index|]
operator|)
operator|->
name|k_stat
operator|&
name|SOPEN
condition|)
block|{
return|return
operator|(
name|ENXIO
operator|)
return|;
block|}
name|tp
operator|->
name|k_stat
operator||=
name|SOPEN
expr_stmt|;
if|if
condition|(
name|tp
operator|->
name|k_type
operator|==
literal|0
condition|)
block|{
name|kp
operator|=
operator|(
operator|(
expr|struct
name|kmcdevice
operator|*
operator|)
name|kmcdinfo
index|[
name|dev
index|]
operator|->
name|ui_addr
operator|)
expr_stmt|;
name|kp
operator|->
name|bsel1
operator|=
name|ROMO
expr_stmt|;
name|kp
operator|->
name|sel4
operator|=
literal|0
expr_stmt|;
name|sav
operator|=
name|kp
operator|->
name|sel6
expr_stmt|;
name|kp
operator|->
name|sel6
operator|=
operator|~
name|sav
expr_stmt|;
if|if
condition|(
name|kp
operator|->
name|sel6
operator|!=
name|sav
condition|)
block|{
name|tp
operator|->
name|k_type
operator|=
name|KMC11B
expr_stmt|;
name|kp
operator|->
name|sel6
operator|=
name|sav
expr_stmt|;
block|}
else|else
name|tp
operator|->
name|k_type
operator|=
name|KMC11A
expr_stmt|;
name|kp
operator|->
name|bsel1
operator|=
literal|0
expr_stmt|;
block|}
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_block

begin_macro
name|kmcclose
argument_list|(
argument|dev
argument_list|)
end_macro

begin_block
block|{
name|dev
operator|=
name|minor
argument_list|(
name|dev
argument_list|)
expr_stmt|;
name|kmc
index|[
name|dev
index|]
operator|.
name|k_stat
operator|&=
operator|~
name|SOPEN
expr_stmt|;
block|}
end_block

begin_macro
name|kmcread
argument_list|(
argument|dev
argument_list|,
argument|uio
argument_list|)
end_macro

begin_decl_stmt
name|dev_t
name|dev
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|struct
name|uio
modifier|*
name|uio
decl_stmt|;
end_decl_stmt

begin_block
block|{
specifier|register
name|struct
name|kmcdevice
modifier|*
name|kp
decl_stmt|;
specifier|register
name|ad
expr_stmt|;
specifier|register
name|int
name|error
init|=
literal|0
decl_stmt|;
name|int
name|dsize
decl_stmt|;
name|ushort
name|sav
decl_stmt|;
name|dev
operator|=
name|minor
argument_list|(
name|dev
argument_list|)
expr_stmt|;
if|if
condition|(
name|kmc
index|[
name|dev
index|]
operator|.
name|k_stat
operator|&
name|SRUN
condition|)
return|return
operator|(
literal|0
operator|)
return|;
name|dsize
operator|=
operator|(
name|kmc
index|[
name|dev
index|]
operator|.
name|k_type
operator|==
name|KMC11A
operator|)
condition|?
name|KASIZE
else|:
name|KBSIZE
expr_stmt|;
name|kp
operator|=
operator|(
operator|(
expr|struct
name|kmcdevice
operator|*
operator|)
name|kmcdinfo
index|[
name|dev
index|]
operator|->
name|ui_addr
operator|)
expr_stmt|;
name|kp
operator|->
name|bsel1
operator|=
literal|0
expr_stmt|;
do|do
block|{
name|ad
operator|=
name|uio
operator|->
name|uio_offset
expr_stmt|;
if|if
condition|(
name|ad
operator|<
name|dsize
operator|*
literal|2
condition|)
block|{
if|if
condition|(
name|ad
operator|&
literal|1
condition|)
block|{
return|return
operator|(
name|ENXIO
operator|)
return|;
block|}
name|ad
operator|>>=
literal|1
expr_stmt|;
name|kp
operator|->
name|bsel1
operator|=
name|ROMO
expr_stmt|;
name|kp
operator|->
name|sel4
operator|=
name|ad
expr_stmt|;
if|if
condition|(
operator|(
name|error
operator|=
name|ureadc
argument_list|(
name|kp
operator|->
name|bsel6
argument_list|,
name|uio
argument_list|)
operator|)
operator|<
literal|0
condition|)
break|break;
if|if
condition|(
operator|(
name|error
operator|=
name|ureadc
argument_list|(
name|kp
operator|->
name|bsel7
argument_list|,
name|uio
argument_list|)
operator|)
operator|<
literal|0
condition|)
break|break;
name|kp
operator|->
name|bsel1
operator|=
literal|0
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|ad
operator|-=
name|dsize
operator|*
literal|2
operator|,
name|ad
operator|<
name|dsize
condition|)
block|{
name|kp
operator|->
name|bsel1
operator|=
name|ROMO
expr_stmt|;
name|kp
operator|->
name|sel4
operator|=
literal|0
expr_stmt|;
name|sav
operator|=
name|kp
operator|->
name|sel6
expr_stmt|;
name|kp
operator|->
name|bsel1
operator|=
name|ROMI
expr_stmt|;
name|kp
operator|->
name|sel6
operator|=
literal|010000
operator||
operator|(
name|ad
operator|&
literal|0377
operator|)
expr_stmt|;
comment|/* mov ad,mar */
name|kp
operator|->
name|bsel1
operator|=
name|ROMI
operator||
name|STEP
expr_stmt|;
name|kp
operator|->
name|bsel1
operator|=
name|ROMI
expr_stmt|;
name|kp
operator|->
name|sel6
operator|=
literal|04000
operator||
operator|(
operator|(
name|ad
operator|>>
literal|8
operator|)
operator|&
literal|0377
operator|)
expr_stmt|;
comment|/* mov %ad,%mar */
name|kp
operator|->
name|bsel1
operator|=
name|ROMI
operator||
name|STEP
expr_stmt|;
name|kp
operator|->
name|bsel1
operator|=
name|ROMI
expr_stmt|;
name|kp
operator|->
name|sel6
operator|=
literal|055222
expr_stmt|;
comment|/* mov mem,csr2|mar++ */
name|kp
operator|->
name|bsel1
operator|=
name|ROMI
operator||
name|STEP
expr_stmt|;
if|if
condition|(
operator|(
name|error
operator|=
name|ureadc
argument_list|(
name|kp
operator|->
name|bsel2
argument_list|,
name|uio
argument_list|)
operator|)
operator|<
literal|0
condition|)
break|break;
name|kp
operator|->
name|bsel1
operator|=
name|ROMI
expr_stmt|;
name|kp
operator|->
name|sel6
operator|=
name|sav
expr_stmt|;
name|kp
operator|->
name|bsel1
operator|=
literal|0
expr_stmt|;
block|}
else|else
break|break;
block|}
do|while
condition|(
operator|!
name|error
operator|&&
name|uio
operator|->
name|uio_resid
condition|)
do|;
return|return
operator|(
name|error
operator|)
return|;
block|}
end_block

begin_macro
name|kmcwrite
argument_list|(
argument|dev
argument_list|,
argument|uio
argument_list|)
end_macro

begin_decl_stmt
name|dev_t
name|dev
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|struct
name|uio
modifier|*
name|uio
decl_stmt|;
end_decl_stmt

begin_block
block|{
specifier|register
name|struct
name|kmcdevice
modifier|*
name|kp
decl_stmt|;
specifier|register
name|ad
expr_stmt|;
name|int
name|dsize
decl_stmt|;
name|short
name|ins
decl_stmt|;
name|ushort
name|sav
decl_stmt|;
name|dev
operator|=
name|minor
argument_list|(
name|dev
argument_list|)
expr_stmt|;
if|if
condition|(
name|kmc
index|[
name|dev
index|]
operator|.
name|k_stat
operator|&
name|SRUN
condition|)
return|return
operator|(
literal|0
operator|)
return|;
name|dsize
operator|=
operator|(
name|kmc
index|[
name|dev
index|]
operator|.
name|k_type
operator|==
name|KMC11A
operator|)
condition|?
name|KASIZE
else|:
name|KBSIZE
expr_stmt|;
name|kp
operator|=
operator|(
operator|(
expr|struct
name|kmcdevice
operator|*
operator|)
name|kmcdinfo
index|[
name|dev
index|]
operator|->
name|ui_addr
operator|)
expr_stmt|;
name|kp
operator|->
name|bsel1
operator|=
literal|0
expr_stmt|;
while|while
condition|(
name|uio
operator|->
name|uio_resid
condition|)
block|{
name|ad
operator|=
name|uio
operator|->
name|uio_offset
expr_stmt|;
if|if
condition|(
name|ad
operator|<
name|dsize
operator|*
literal|2
condition|)
block|{
if|if
condition|(
name|ad
operator|&
literal|1
condition|)
block|{
return|return
operator|(
name|ENXIO
operator|)
return|;
block|}
name|kp
operator|->
name|bsel1
operator|=
name|ROMO
expr_stmt|;
name|kp
operator|->
name|sel4
operator|=
name|ad
operator|>>
literal|1
expr_stmt|;
name|lobyte
argument_list|(
name|ins
argument_list|)
operator|=
name|uwritec
argument_list|(
name|uio
argument_list|)
expr_stmt|;
name|hibyte
argument_list|(
name|ins
argument_list|)
operator|=
name|uwritec
argument_list|(
name|uio
argument_list|)
expr_stmt|;
name|kp
operator|->
name|sel6
operator|=
name|ins
expr_stmt|;
name|kp
operator|->
name|bsel1
operator||=
name|CWRT
expr_stmt|;
name|kp
operator|->
name|bsel1
operator|=
literal|0
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|ad
operator|-=
name|dsize
operator|*
literal|2
operator|,
name|ad
operator|<
name|dsize
condition|)
block|{
name|kp
operator|->
name|bsel1
operator|=
name|ROMO
expr_stmt|;
name|kp
operator|->
name|sel4
operator|=
literal|0
expr_stmt|;
name|sav
operator|=
name|kp
operator|->
name|sel6
expr_stmt|;
name|kp
operator|->
name|bsel1
operator|=
name|ROMI
expr_stmt|;
name|kp
operator|->
name|sel6
operator|=
literal|010000
operator||
operator|(
name|ad
operator|&
literal|0377
operator|)
expr_stmt|;
comment|/* mov ad,mar */
name|kp
operator|->
name|bsel1
operator|=
name|ROMI
operator||
name|STEP
expr_stmt|;
name|kp
operator|->
name|bsel1
operator|=
name|ROMI
expr_stmt|;
name|kp
operator|->
name|sel6
operator|=
literal|04000
operator||
operator|(
operator|(
name|ad
operator|>>
literal|8
operator|)
operator|&
literal|0377
operator|)
expr_stmt|;
comment|/* mov %ad,%mar */
name|kp
operator|->
name|bsel1
operator|=
name|ROMI
operator||
name|STEP
expr_stmt|;
name|kp
operator|->
name|bsel1
operator|=
name|ROMI
expr_stmt|;
name|kp
operator|->
name|bsel2
operator|=
name|uwritec
argument_list|(
name|uio
argument_list|)
expr_stmt|;
name|kp
operator|->
name|sel6
operator|=
literal|0136440
expr_stmt|;
comment|/* mov csr2,mem|mar++ */
name|kp
operator|->
name|bsel1
operator|=
name|ROMI
operator||
name|STEP
expr_stmt|;
name|kp
operator|->
name|bsel1
operator|=
name|ROMI
expr_stmt|;
name|kp
operator|->
name|sel6
operator|=
name|sav
expr_stmt|;
name|kp
operator|->
name|bsel1
operator|=
literal|0
expr_stmt|;
block|}
else|else
break|break;
block|}
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_block

begin_comment
comment|/*ARGSUSED*/
end_comment

begin_macro
name|kmcioctl
argument_list|(
argument|dev
argument_list|,
argument|cmd
argument_list|,
argument|kk
argument_list|,
argument|mode
argument_list|)
end_macro

begin_decl_stmt
name|dev_t
name|dev
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|struct
name|kmcntl
modifier|*
name|kk
decl_stmt|;
end_decl_stmt

begin_block
block|{
specifier|register
name|struct
name|kmcdevice
modifier|*
name|kp
decl_stmt|;
specifier|register
name|struct
name|kmc
modifier|*
name|tp
decl_stmt|;
name|short
name|csr
index|[
literal|4
index|]
decl_stmt|;
name|ushort
name|sav
decl_stmt|;
if|if
condition|(
name|rkmcdebug
condition|)
name|log
argument_list|(
name|LOG_ERR
argument_list|,
literal|"kmcioctl: cmd=%d, kk->kmd=%d, kk->kcsr=0x%x, kk->kval=%d\n"
argument_list|,
name|cmd
argument_list|,
name|kk
operator|->
name|kmd
argument_list|,
name|kk
operator|->
name|kcsr
argument_list|,
name|kk
operator|->
name|kval
argument_list|)
expr_stmt|;
name|dev
operator|=
name|minor
argument_list|(
name|dev
argument_list|)
expr_stmt|;
if|if
condition|(
name|cmd
operator|!=
name|KCSETA
condition|)
block|{
return|return
operator|(
name|EINVAL
operator|)
return|;
block|}
name|kp
operator|=
operator|(
operator|(
expr|struct
name|kmcdevice
operator|*
operator|)
name|kmcdinfo
index|[
name|dev
index|]
operator|->
name|ui_addr
operator|)
expr_stmt|;
name|tp
operator|=
operator|&
name|kmc
index|[
name|dev
index|]
expr_stmt|;
switch|switch
condition|(
name|kk
operator|->
name|kmd
condition|)
block|{
case|case
name|KMCLR
case|:
case|case
name|KRESET
case|:
name|spl7
argument_list|()
expr_stmt|;
name|kp
operator|->
name|bsel1
operator|=
name|MCLR
expr_stmt|;
name|spl0
argument_list|()
expr_stmt|;
case|case
name|KSTOP
case|:
name|tp
operator|->
name|k_stat
operator|&=
operator|~
name|SRUN
expr_stmt|;
name|kp
operator|->
name|bsel1
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|kk
operator|->
name|kmd
operator|==
name|KRESET
condition|)
block|{
name|tp
operator|->
name|k_stat
operator|=
literal|0
expr_stmt|;
while|while
condition|(
name|getc
argument_list|(
operator|&
name|tp
operator|->
name|k_inq
argument_list|)
operator|>=
literal|0
condition|)
empty_stmt|;
if|if
condition|(
name|tp
operator|->
name|k_stat
operator|&
name|SINIT
condition|)
call|(
modifier|*
name|tp
operator|->
name|k_init
call|)
argument_list|(
name|dev
argument_list|)
expr_stmt|;
block|}
return|return
operator|(
literal|0
operator|)
return|;
case|case
name|KMS
case|:
if|if
condition|(
name|tp
operator|->
name|k_stat
operator|&
name|SRUN
condition|)
break|break;
name|kp
operator|->
name|bsel1
operator|=
name|ROMI
operator||
name|ROMO
expr_stmt|;
name|sav
operator|=
name|kp
operator|->
name|sel6
expr_stmt|;
name|kp
operator|->
name|bsel1
operator|=
name|ROMI
expr_stmt|;
name|kp
operator|->
name|sel6
operator|=
name|kk
operator|->
name|kval
expr_stmt|;
name|kp
operator|->
name|bsel1
operator|=
name|ROMI
operator||
name|STEP
expr_stmt|;
name|kp
operator|->
name|bsel1
operator|=
name|ROMI
expr_stmt|;
name|kp
operator|->
name|sel6
operator|=
name|sav
expr_stmt|;
name|kp
operator|->
name|bsel1
operator|=
literal|0
expr_stmt|;
goto|goto
name|lcsr
goto|;
case|case
name|KSTEP
case|:
if|if
condition|(
name|tp
operator|->
name|k_stat
operator|&
name|SRUN
condition|)
break|break;
name|kp
operator|->
name|bsel1
operator||=
name|STEP
expr_stmt|;
name|kp
operator|->
name|bsel1
operator|=
literal|0
expr_stmt|;
case|case
name|KCSR
case|:
name|lcsr
label|:
name|csr
index|[
literal|0
index|]
operator|=
name|kp
operator|->
name|sel0
expr_stmt|;
name|csr
index|[
literal|1
index|]
operator|=
name|kp
operator|->
name|sel2
expr_stmt|;
name|csr
index|[
literal|2
index|]
operator|=
name|kp
operator|->
name|sel4
expr_stmt|;
name|csr
index|[
literal|3
index|]
operator|=
name|kp
operator|->
name|sel6
expr_stmt|;
if|if
condition|(
name|copyout
argument_list|(
operator|(
name|caddr_t
operator|)
name|csr
argument_list|,
operator|(
name|caddr_t
operator|)
name|kk
operator|->
name|kcsr
argument_list|,
sizeof|sizeof
name|csr
argument_list|)
condition|)
return|return
operator|(
name|EFAULT
operator|)
return|;
return|return
operator|(
literal|0
operator|)
return|;
case|case
name|KWRCR
case|:
if|if
condition|(
name|tp
operator|->
name|k_stat
operator|&
name|SRINT
condition|)
break|break;
name|kp
operator|->
name|sel6
operator|=
name|kk
operator|->
name|kval
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
case|case
name|KRUN
case|:
if|if
condition|(
name|tp
operator|->
name|k_stat
operator|&
name|SRUN
condition|)
break|break;
name|tp
operator|->
name|k_stat
operator|&=
operator|~
name|STYPE
expr_stmt|;
name|tp
operator|->
name|k_stat
operator||=
operator|(
name|kk
operator|->
name|kval
operator|&
name|STYPE
operator|)
operator||
name|SRUN
expr_stmt|;
name|kp
operator|->
name|bsel1
operator||=
name|RUN
expr_stmt|;
if|if
condition|(
name|tp
operator|->
name|k_stat
operator|&
name|SRINT
condition|)
block|{
name|spl5
argument_list|()
expr_stmt|;
name|kmcrint
argument_list|(
name|dev
argument_list|)
expr_stmt|;
name|spl0
argument_list|()
expr_stmt|;
block|}
if|if
condition|(
name|tp
operator|->
name|k_stat
operator|&
name|SRESET
condition|)
call|(
modifier|*
name|tp
operator|->
name|k_reset
call|)
argument_list|(
name|dev
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
case|case
name|KLU
case|:
name|kp
operator|->
name|bsel1
operator|=
name|kk
operator|->
name|kval
operator|&
operator|(
name|LUA
operator||
name|LUB
operator|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
if|if
condition|(
name|rkmcdebug
condition|)
name|log
argument_list|(
name|LOG_ERR
argument_list|,
literal|"kmcioctl: EIO exit, tp->k_stat=0x%x\n"
argument_list|,
name|tp
operator|->
name|k_stat
argument_list|)
expr_stmt|;
return|return
operator|(
name|EIO
operator|)
return|;
block|}
end_block

begin_macro
name|kmcrint
argument_list|(
argument|dev
argument_list|)
end_macro

begin_block
block|{
specifier|register
name|struct
name|kmcdevice
modifier|*
name|kp
decl_stmt|;
specifier|register
name|struct
name|kmc
modifier|*
name|tp
decl_stmt|;
name|dev
operator|=
name|minor
argument_list|(
name|dev
argument_list|)
expr_stmt|;
name|kp
operator|=
operator|(
operator|(
expr|struct
name|kmcdevice
operator|*
operator|)
name|kmcdinfo
index|[
name|dev
index|]
operator|->
name|ui_addr
operator|)
expr_stmt|;
name|tp
operator|=
operator|&
name|kmc
index|[
name|dev
index|]
expr_stmt|;
name|kp
operator|->
name|sel0
operator|&=
operator|~
name|IEI
expr_stmt|;
while|while
condition|(
name|kp
operator|->
name|sel2
operator|&
name|RDYI
condition|)
block|{
if|if
condition|(
operator|(
name|tp
operator|->
name|k_stat
operator|&
name|SLOAD
operator|)
operator|||
name|q_to_b
argument_list|(
operator|&
name|tp
operator|->
name|k_inq
argument_list|,
operator|(
name|char
operator|*
operator|)
name|tp
operator|->
name|k_arg
argument_list|,
sizeof|sizeof
argument_list|(
name|tp
operator|->
name|k_arg
argument_list|)
argument_list|)
operator|==
sizeof|sizeof
argument_list|(
name|tp
operator|->
name|k_arg
argument_list|)
condition|)
block|{
name|kp
operator|->
name|sel2
operator|=
name|tp
operator|->
name|k_arg
index|[
literal|0
index|]
operator||
name|RDYI
expr_stmt|;
name|kp
operator|->
name|sel4
operator|=
name|tp
operator|->
name|k_arg
index|[
literal|1
index|]
expr_stmt|;
name|kp
operator|->
name|sel6
operator|=
name|tp
operator|->
name|k_arg
index|[
literal|2
index|]
expr_stmt|;
name|tp
operator|->
name|k_stat
operator|&=
operator|~
name|SLOAD
expr_stmt|;
block|}
else|else
block|{
name|log
argument_list|(
name|LOG_ERR
argument_list|,
literal|"Bad kmc %d load\n"
argument_list|,
name|dev
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|tp
operator|->
name|k_inq
operator|.
name|c_cc
operator|==
literal|0
condition|)
block|{
name|kp
operator|->
name|sel0
operator|&=
operator|~
name|RQI
expr_stmt|;
name|kp
operator|->
name|sel2
operator|&=
operator|~
name|RDYI
expr_stmt|;
return|return;
block|}
name|kp
operator|->
name|sel2
operator|&=
operator|~
name|RDYI
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|tp
operator|->
name|k_stat
operator|&
name|SLOAD
operator|)
operator|||
name|tp
operator|->
name|k_inq
operator|.
name|c_cc
condition|)
name|kp
operator|->
name|sel0
operator||=
name|IEI
operator||
name|RQI
expr_stmt|;
block|}
end_block

begin_macro
name|kmcxint
argument_list|(
argument|dev
argument_list|)
end_macro

begin_block
block|{
specifier|register
name|struct
name|kmcdevice
modifier|*
name|kp
decl_stmt|;
specifier|register
name|struct
name|kmc
modifier|*
name|tp
decl_stmt|;
name|int
name|p1
decl_stmt|,
name|p2
decl_stmt|,
name|p3
decl_stmt|,
name|p4
decl_stmt|;
name|dev
operator|=
name|minor
argument_list|(
name|dev
argument_list|)
expr_stmt|;
name|kp
operator|=
operator|(
operator|(
expr|struct
name|kmcdevice
operator|*
operator|)
name|kmcdinfo
index|[
name|dev
index|]
operator|->
name|ui_addr
operator|)
expr_stmt|;
name|tp
operator|=
operator|&
name|kmc
index|[
name|dev
index|]
expr_stmt|;
name|kp
operator|->
name|sel0
operator|&=
operator|~
name|IEO
expr_stmt|;
while|while
condition|(
name|kp
operator|->
name|sel2
operator|&
name|RDYO
condition|)
block|{
name|p1
operator|=
operator|(
name|dev
operator|<<
literal|6
operator|)
operator||
operator|(
name|kp
operator|->
name|bsel3
operator|&
literal|077
operator|)
expr_stmt|;
name|p2
operator|=
name|kp
operator|->
name|bsel2
operator|&
literal|017
expr_stmt|;
name|p3
operator|=
name|kp
operator|->
name|sel4
expr_stmt|;
name|p4
operator|=
name|kp
operator|->
name|sel6
expr_stmt|;
name|kp
operator|->
name|sel2
operator|&=
operator|~
name|RDYO
expr_stmt|;
if|if
condition|(
name|tp
operator|->
name|k_stat
operator|&
name|SRINT
condition|)
call|(
modifier|*
name|tp
operator|->
name|k_rint
call|)
argument_list|(
name|p1
argument_list|,
name|p2
argument_list|,
name|p3
argument_list|,
name|p4
argument_list|)
expr_stmt|;
block|}
name|kp
operator|->
name|sel0
operator||=
name|IEO
expr_stmt|;
block|}
end_block

begin_macro
name|kmcload
argument_list|(
argument|dev
argument_list|,
argument|p1
argument_list|,
argument|p2
argument_list|,
argument|p3
argument_list|)
end_macro

begin_block
block|{
specifier|register
name|struct
name|kmcdevice
modifier|*
name|kp
decl_stmt|;
specifier|register
name|struct
name|kmc
modifier|*
name|tp
decl_stmt|;
specifier|register
name|unit
expr_stmt|;
specifier|register
name|sps
expr_stmt|;
name|dev
operator|=
name|minor
argument_list|(
name|dev
argument_list|)
expr_stmt|;
name|unit
operator|=
operator|(
name|dev
operator|>>
literal|6
operator|)
operator|&
literal|03
expr_stmt|;
name|tp
operator|=
operator|&
name|kmc
index|[
name|unit
index|]
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|tp
operator|->
name|k_stat
operator|&
name|SRUN
operator|)
condition|)
return|return
operator|(
operator|-
literal|1
operator|)
return|;
name|kp
operator|=
operator|(
operator|(
expr|struct
name|kmcdevice
operator|*
operator|)
name|kmcdinfo
index|[
name|unit
index|]
operator|->
name|ui_addr
operator|)
expr_stmt|;
comment|/* RAV unit is suspect */
name|sps
operator|=
name|spl5
argument_list|()
expr_stmt|;
if|if
condition|(
name|tp
operator|->
name|k_stat
operator|&
name|SLOAD
condition|)
block|{
name|b_to_q
argument_list|(
operator|(
name|char
operator|*
operator|)
name|tp
operator|->
name|k_arg
argument_list|,
sizeof|sizeof
argument_list|(
name|tp
operator|->
name|k_arg
argument_list|)
argument_list|,
operator|&
name|tp
operator|->
name|k_inq
argument_list|)
expr_stmt|;
name|tp
operator|->
name|k_stat
operator|&=
operator|~
name|SLOAD
expr_stmt|;
block|}
name|kp
operator|->
name|sel0
operator||=
name|RQI
expr_stmt|;
name|tp
operator|->
name|k_arg
index|[
literal|0
index|]
operator|=
operator|(
name|p1
operator|&
literal|017
operator|)
operator||
operator|(
operator|(
name|dev
operator|&
literal|077
operator|)
operator|<<
literal|8
operator|)
expr_stmt|;
name|tp
operator|->
name|k_arg
index|[
literal|1
index|]
operator|=
name|p2
expr_stmt|;
name|tp
operator|->
name|k_arg
index|[
literal|2
index|]
operator|=
name|p3
expr_stmt|;
if|if
condition|(
name|tp
operator|->
name|k_inq
operator|.
name|c_cc
condition|)
name|b_to_q
argument_list|(
operator|(
name|char
operator|*
operator|)
name|tp
operator|->
name|k_arg
argument_list|,
sizeof|sizeof
argument_list|(
name|tp
operator|->
name|k_arg
argument_list|)
argument_list|,
operator|&
name|tp
operator|->
name|k_inq
argument_list|)
expr_stmt|;
else|else
name|tp
operator|->
name|k_stat
operator||=
name|SLOAD
expr_stmt|;
name|kmcrint
argument_list|(
name|unit
argument_list|)
expr_stmt|;
name|splx
argument_list|(
name|sps
argument_list|)
expr_stmt|;
return|return
operator|(
name|tp
operator|->
name|k_inq
operator|.
name|c_cc
operator|)
return|;
block|}
end_block

begin_macro
name|kmcset
argument_list|(
argument|dev
argument_list|,
argument|type
argument_list|,
argument|rint
argument_list|)
end_macro

begin_function_decl
name|int
function_decl|(
modifier|*
name|rint
function_decl|)
parameter_list|()
function_decl|;
end_function_decl

begin_block
block|{
specifier|register
name|struct
name|kmcdevice
modifier|*
name|kp
decl_stmt|;
specifier|register
name|struct
name|kmc
modifier|*
name|tp
decl_stmt|;
specifier|register
name|unit
expr_stmt|;
name|dev
operator|=
name|minor
argument_list|(
name|dev
argument_list|)
expr_stmt|;
name|unit
operator|=
operator|(
name|dev
operator|>>
literal|6
operator|)
operator|&
literal|03
expr_stmt|;
name|kp
operator|=
operator|(
operator|(
expr|struct
name|kmcdevice
operator|*
operator|)
name|kmcdinfo
index|[
name|unit
index|]
operator|->
name|ui_addr
operator|)
expr_stmt|;
comment|/* RAV unit is suspect */
name|tp
operator|=
operator|&
name|kmc
index|[
name|unit
index|]
expr_stmt|;
if|if
condition|(
operator|(
name|tp
operator|->
name|k_stat
operator|&
operator|(
name|STYPE
operator||
name|SRUN
operator||
name|SOPEN
operator|)
operator|)
operator|!=
operator|(
operator|(
name|type
operator|&
name|STYPE
operator|)
operator||
name|SRUN
operator|)
condition|)
return|return
operator|(
literal|1
operator|)
return|;
name|tp
operator|->
name|k_stat
operator||=
name|SRINT
expr_stmt|;
name|tp
operator|->
name|k_rint
operator|=
name|rint
expr_stmt|;
name|kp
operator|->
name|sel0
operator||=
name|IEO
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_block

begin_expr_stmt
name|kmcdclr
argument_list|(
name|dev
argument_list|)
specifier|register
name|dev
expr_stmt|;
end_expr_stmt

begin_block
block|{
specifier|register
name|struct
name|kmc
modifier|*
name|tp
decl_stmt|;
specifier|register
name|struct
name|kmcdevice
modifier|*
name|kp
decl_stmt|;
name|dev
operator|=
name|minor
argument_list|(
name|dev
argument_list|)
expr_stmt|;
if|if
condition|(
name|dev
operator|<
literal|0
operator|||
name|dev
operator|>=
name|kmc_cnt
condition|)
return|return;
name|tp
operator|=
operator|&
name|kmc
index|[
name|dev
index|]
expr_stmt|;
while|while
condition|(
name|getc
argument_list|(
operator|&
name|tp
operator|->
name|k_inq
argument_list|)
operator|>=
literal|0
condition|)
empty_stmt|;
name|kp
operator|=
operator|(
operator|(
expr|struct
name|kmcdevice
operator|*
operator|)
name|kmcdinfo
index|[
name|dev
index|]
operator|->
name|ui_addr
operator|)
expr_stmt|;
name|kp
operator|->
name|sel0
operator|=
literal|0
expr_stmt|;
name|kp
operator|->
name|sel2
operator|=
literal|0
expr_stmt|;
block|}
end_block

begin_macro
name|kmcreset
argument_list|(
argument|dev
argument_list|)
end_macro

begin_block
block|{
specifier|register
name|struct
name|kmc
modifier|*
name|tp
decl_stmt|;
specifier|register
name|struct
name|kmcdevice
modifier|*
name|kp
decl_stmt|;
specifier|register
name|s
expr_stmt|;
name|dev
operator|=
name|minor
argument_list|(
name|dev
argument_list|)
expr_stmt|;
name|tp
operator|=
operator|&
name|kmc
index|[
name|dev
index|]
expr_stmt|;
name|kp
operator|=
operator|(
operator|(
expr|struct
name|kmcdevice
operator|*
operator|)
name|kmcdinfo
index|[
name|dev
index|]
operator|->
name|ui_addr
operator|)
expr_stmt|;
name|s
operator|=
name|spl7
argument_list|()
expr_stmt|;
name|kp
operator|->
name|bsel1
operator|=
name|MCLR
expr_stmt|;
name|splx
argument_list|(
name|s
argument_list|)
expr_stmt|;
name|kp
operator|->
name|bsel1
operator|=
literal|0
expr_stmt|;
name|tp
operator|->
name|k_stat
operator|=
literal|0
expr_stmt|;
while|while
condition|(
name|getc
argument_list|(
operator|&
name|tp
operator|->
name|k_inq
argument_list|)
operator|>=
literal|0
condition|)
empty_stmt|;
block|}
end_block

begin_macro
name|kmcifset
argument_list|(
argument|dev
argument_list|,
argument|init
argument_list|)
end_macro

begin_function_decl
name|int
function_decl|(
modifier|*
name|init
function_decl|)
parameter_list|()
function_decl|;
end_function_decl

begin_block
block|{
specifier|register
name|struct
name|kmc
modifier|*
name|tp
decl_stmt|;
specifier|register
name|unit
expr_stmt|;
name|dev
operator|=
name|minor
argument_list|(
name|dev
argument_list|)
expr_stmt|;
name|unit
operator|=
operator|(
name|dev
operator|>>
literal|6
operator|)
operator|&
literal|03
expr_stmt|;
if|if
condition|(
name|unit
operator|<
literal|0
operator|||
name|unit
operator|>=
name|kmc_cnt
condition|)
return|return;
name|tp
operator|=
operator|&
name|kmc
index|[
name|unit
index|]
expr_stmt|;
if|if
condition|(
name|init
operator|==
name|NULL
condition|)
block|{
name|tp
operator|->
name|k_init
operator|=
name|NULL
expr_stmt|;
name|tp
operator|->
name|k_stat
operator|&=
operator|~
name|SINIT
expr_stmt|;
block|}
else|else
block|{
name|tp
operator|->
name|k_init
operator|=
name|init
expr_stmt|;
name|tp
operator|->
name|k_stat
operator||=
name|SINIT
expr_stmt|;
block|}
block|}
end_block

begin_macro
name|kmcrfset
argument_list|(
argument|dev
argument_list|,
argument|reset
argument_list|)
end_macro

begin_function_decl
name|int
function_decl|(
modifier|*
name|reset
function_decl|)
parameter_list|()
function_decl|;
end_function_decl

begin_block
block|{
specifier|register
name|struct
name|kmc
modifier|*
name|tp
decl_stmt|;
specifier|register
name|unit
expr_stmt|;
name|dev
operator|=
name|minor
argument_list|(
name|dev
argument_list|)
expr_stmt|;
name|unit
operator|=
operator|(
name|dev
operator|>>
literal|6
operator|)
operator|&
literal|03
expr_stmt|;
if|if
condition|(
name|unit
operator|<
literal|0
operator|||
name|unit
operator|>=
name|kmc_cnt
condition|)
return|return;
name|tp
operator|=
operator|&
name|kmc
index|[
name|unit
index|]
expr_stmt|;
if|if
condition|(
name|reset
operator|==
name|NULL
condition|)
block|{
name|tp
operator|->
name|k_reset
operator|=
name|NULL
expr_stmt|;
name|tp
operator|->
name|k_stat
operator|&=
operator|~
name|SRESET
expr_stmt|;
block|}
else|else
block|{
name|tp
operator|->
name|k_reset
operator|=
name|reset
expr_stmt|;
name|tp
operator|->
name|k_stat
operator||=
name|SRESET
expr_stmt|;
block|}
block|}
end_block

begin_endif
endif|#
directive|endif
end_endif

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_ifndef
ifndef|#
directive|ifndef
name|lint
end_ifndef

begin_decl_stmt
specifier|static
name|char
name|sccsid
index|[]
init|=
literal|"@(#)io.c	1.7 (Berkeley/CCI) 6/7/88"
decl_stmt|;
end_decl_stmt

begin_endif
endif|#
directive|endif
end_endif

begin_include
include|#
directive|include
file|"vdfmt.h"
end_include

begin_include
include|#
directive|include
file|"cmd.h"
end_include

begin_comment
comment|/* ** */
end_comment

begin_decl_stmt
specifier|static
name|cmd_text_element
name|nul_table
index|[]
init|=
block|{
block|{
literal|0
block|,
literal|""
block|,
literal|""
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|wait_for_char
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|vdtimeout
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|char
modifier|*
name|clean_up
init|=
literal|"Cleaning up...  Please wait.\n"
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* ** */
end_comment

begin_macro
name|poll
argument_list|(
argument|wait
argument_list|)
end_macro

begin_decl_stmt
name|int
name|wait
decl_stmt|;
end_decl_stmt

begin_block
block|{
specifier|register
name|struct
name|vddevice
modifier|*
name|addr
init|=
name|C_INFO
operator|->
name|addr
decl_stmt|;
name|int
name|tokens
index|[
literal|10
index|]
decl_stmt|;
if|if
condition|(
name|kill_processes
operator|==
name|false
condition|)
name|wait_for_char
operator|=
literal|0
expr_stmt|;
name|vdtimeout
operator|=
name|wait
operator|*
literal|1000
expr_stmt|;
for|for
control|(
init|;
condition|;
control|)
block|{
name|uncache
argument_list|(
operator|&
operator|(
name|dcb
operator|.
name|operrsta
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|dcb
operator|.
name|operrsta
operator|&
operator|(
name|DCBS_DONE
operator||
name|DCBS_ABORT
operator|)
condition|)
break|break;
if|if
condition|(
name|kill_processes
operator|==
name|false
operator|&&
name|input
argument_list|()
condition|)
block|{
name|get_text_cmd
argument_list|(
name|nul_table
argument_list|,
name|tokens
argument_list|)
expr_stmt|;
if|if
condition|(
name|kill_processes
operator|==
name|true
condition|)
block|{
name|indent
argument_list|()
expr_stmt|;
name|print
argument_list|(
name|clean_up
argument_list|)
expr_stmt|;
name|exdent
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
name|vdtimeout
operator|--
operator|<=
literal|0
condition|)
block|{
if|if
condition|(
name|C_INFO
operator|->
name|type
operator|==
name|VDTYPE_VDDC
condition|)
name|printf
argument_list|(
literal|"\nVDDC"
argument_list|)
expr_stmt|;
else|else
name|printf
argument_list|(
literal|"\nSMD-E"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|": Controller timeout"
argument_list|)
expr_stmt|;
name|abort
label|:
name|VDABORT
argument_list|(
name|addr
argument_list|,
name|C_INFO
operator|->
name|type
argument_list|)
expr_stmt|;
name|DELAY
argument_list|(
literal|30000
argument_list|)
expr_stmt|;
break|break;
block|}
name|DELAY
argument_list|(
literal|1000
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|vdtimeout
operator|>
literal|0
operator|)
condition|)
block|{
if|if
condition|(
name|C_INFO
operator|->
name|type
operator|==
name|VDTYPE_SMDE
condition|)
block|{
for|for
control|(
init|;
condition|;
control|)
block|{
name|uncache
argument_list|(
operator|&
operator|(
name|addr
operator|->
name|vdcsr
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|addr
operator|->
name|vdcsr
operator|&
name|CS_GO
operator|)
operator|==
literal|0
condition|)
break|break;
name|DELAY
argument_list|(
literal|1000
argument_list|)
expr_stmt|;
if|if
condition|(
name|vdtimeout
operator|--
operator|<=
literal|0
condition|)
block|{
name|printf
argument_list|(
literal|"\nSMD-E timed out clearing GO"
argument_list|)
expr_stmt|;
goto|goto
name|abort
goto|;
block|}
block|}
name|DELAY
argument_list|(
literal|300
argument_list|)
expr_stmt|;
block|}
name|DELAY
argument_list|(
literal|500
argument_list|)
expr_stmt|;
block|}
name|DELAY
argument_list|(
literal|200
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|dcb
operator|.
name|opcode
operator|==
name|VDOP_RD
operator|)
operator|||
operator|(
name|dcb
operator|.
name|opcode
operator|==
name|VDOP_RDRAW
operator|)
condition|)
name|mtpr
argument_list|(
name|PADC
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|uncache
argument_list|(
operator|&
operator|(
name|dcb
operator|.
name|operrsta
operator|)
argument_list|)
expr_stmt|;
name|uncache
argument_list|(
operator|&
operator|(
name|dcb
operator|.
name|err_code
operator|)
argument_list|)
expr_stmt|;
name|wait_for_char
operator|=
literal|1
expr_stmt|;
block|}
end_block

begin_comment
comment|/* **	Access_with_no_trailer is used to perform controller functions which ** require no data movement. */
end_comment

begin_macro
name|access_with_no_trailer
argument_list|(
argument|function
argument_list|,
argument|wait_time
argument_list|)
end_macro

begin_decl_stmt
name|int
name|function
decl_stmt|,
name|wait_time
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|dcb
operator|.
name|opcode
operator|=
name|function
expr_stmt|;
comment|/* command */
name|dcb
operator|.
name|intflg
operator|=
name|DCBINT_NONE
expr_stmt|;
name|dcb
operator|.
name|nxtdcb
operator|=
operator|(
expr|struct
name|dcb
operator|*
operator|)
literal|0
expr_stmt|;
comment|/* end of chain */
name|dcb
operator|.
name|operrsta
operator|=
literal|0
expr_stmt|;
name|dcb
operator|.
name|devselect
operator|=
operator|(
name|function
operator|==
name|VDOP_START
operator|)
condition|?
literal|0
else|:
operator|(
operator|(
name|char
operator|)
name|cur
operator|.
name|drive
operator||
name|lab
operator|->
name|d_devflags
operator|)
expr_stmt|;
name|dcb
operator|.
name|trailcnt
operator|=
operator|(
name|char
operator|)
literal|0
expr_stmt|;
name|mdcb
operator|.
name|mdcb_head
operator|=
operator|&
name|dcb
expr_stmt|;
name|mdcb
operator|.
name|mdcb_status
operator|=
literal|0
expr_stmt|;
name|VDGO
argument_list|(
name|C_INFO
operator|->
name|addr
argument_list|,
operator|(
name|u_long
operator|)
operator|&
name|mdcb
argument_list|,
name|C_INFO
operator|->
name|type
argument_list|)
expr_stmt|;
name|poll
argument_list|(
name|wait_time
argument_list|)
expr_stmt|;
if|if
condition|(
name|vdtimeout
operator|<=
literal|0
condition|)
block|{
name|printf
argument_list|(
literal|" during startup operation.\n"
argument_list|)
expr_stmt|;
name|_longjmp
argument_list|(
name|abort_environ
argument_list|,
literal|1
argument_list|)
expr_stmt|;
block|}
return|return
name|dcb
operator|.
name|operrsta
return|;
block|}
end_block

begin_macro
name|vread
argument_list|(
argument|sn
argument_list|,
argument|buf
argument_list|,
argument|seccnt
argument_list|)
end_macro

begin_decl_stmt
name|int
name|sn
decl_stmt|,
name|seccnt
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|char
modifier|*
name|buf
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|int
name|ret
decl_stmt|;
name|ret
operator|=
name|vrdwr
argument_list|(
name|sn
argument_list|,
name|buf
argument_list|,
name|seccnt
argument_list|,
name|VDOP_RD
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|==
literal|0
condition|)
name|vd_error
argument_list|(
literal|"read"
argument_list|)
expr_stmt|;
return|return
operator|(
name|ret
operator|)
return|;
block|}
end_block

begin_macro
name|vwrite
argument_list|(
argument|sn
argument_list|,
argument|buf
argument_list|,
argument|seccnt
argument_list|)
end_macro

begin_decl_stmt
name|int
name|sn
decl_stmt|,
name|seccnt
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|char
modifier|*
name|buf
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|int
name|ret
decl_stmt|;
name|ret
operator|=
name|vrdwr
argument_list|(
name|sn
argument_list|,
name|buf
argument_list|,
name|seccnt
argument_list|,
name|VDOP_WD
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|==
literal|0
condition|)
name|vd_error
argument_list|(
literal|"write"
argument_list|)
expr_stmt|;
return|return
operator|(
name|ret
operator|)
return|;
block|}
end_block

begin_empty_stmt
empty_stmt|;
end_empty_stmt

begin_macro
name|vrdwr
argument_list|(
argument|sn
argument_list|,
argument|buf
argument_list|,
argument|seccnt
argument_list|,
argument|op
argument_list|)
end_macro

begin_decl_stmt
name|int
name|sn
decl_stmt|,
name|seccnt
decl_stmt|,
name|op
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|char
modifier|*
name|buf
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|dskadr
name|dskaddr
decl_stmt|;
name|dskaddr
operator|.
name|cylinder
operator|=
name|sn
operator|/
name|lab
operator|->
name|d_secpercyl
expr_stmt|;
name|sn
operator|%=
name|lab
operator|->
name|d_secpercyl
expr_stmt|;
name|dskaddr
operator|.
name|track
operator|=
name|sn
operator|/
name|lab
operator|->
name|d_nsectors
expr_stmt|;
name|dskaddr
operator|.
name|sector
operator|=
name|sn
operator|%
name|lab
operator|->
name|d_nsectors
expr_stmt|;
if|if
condition|(
name|access_dsk
argument_list|(
name|buf
argument_list|,
operator|&
name|dskaddr
argument_list|,
name|op
argument_list|,
name|seccnt
argument_list|,
literal|1
argument_list|)
operator|&
name|DCBS_HARD
condition|)
return|return
operator|(
literal|0
operator|)
return|;
return|return
operator|(
name|seccnt
operator|)
return|;
block|}
end_block

begin_comment
comment|/* **	access_dsk is used by other routines to do reads and writes to the disk. ** The status of the read / write is returned to the caller for processing. */
end_comment

begin_macro
name|access_dsk
argument_list|(
argument|buf
argument_list|,
argument|dskaddr
argument_list|,
argument|func
argument_list|,
argument|count
argument_list|,
argument|wait
argument_list|)
end_macro

begin_decl_stmt
name|char
modifier|*
name|buf
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|dskadr
modifier|*
name|dskaddr
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|func
decl_stmt|,
name|count
decl_stmt|,
name|wait
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|cur
operator|.
name|daddr
operator|.
name|cylinder
operator|=
name|dskaddr
operator|->
name|cylinder
expr_stmt|;
name|cur
operator|.
name|daddr
operator|.
name|track
operator|=
name|dskaddr
operator|->
name|track
expr_stmt|;
name|wait_for_char
operator|=
literal|0
expr_stmt|;
name|dcb
operator|.
name|opcode
operator|=
name|func
expr_stmt|;
comment|/* format sector command */
name|dcb
operator|.
name|intflg
operator|=
name|DCBINT_NONE
expr_stmt|;
name|dcb
operator|.
name|nxtdcb
operator|=
operator|(
expr|struct
name|dcb
operator|*
operator|)
literal|0
expr_stmt|;
comment|/* end of chain */
name|dcb
operator|.
name|operrsta
operator|=
literal|0
expr_stmt|;
name|dcb
operator|.
name|devselect
operator|=
operator|(
name|char
operator|)
name|cur
operator|.
name|drive
operator||
name|lab
operator|->
name|d_devflags
expr_stmt|;
if|if
condition|(
name|func
operator|==
name|VDOP_SEEK
condition|)
block|{
name|dcb
operator|.
name|trailcnt
operator|=
call|(
name|char
call|)
argument_list|(
sizeof|sizeof
argument_list|(
expr|struct
name|trseek
argument_list|)
operator|/
sizeof|sizeof
argument_list|(
name|long
argument_list|)
argument_list|)
expr_stmt|;
name|dcb
operator|.
name|trail
operator|.
name|sktrail
operator|.
name|skaddr
operator|.
name|cylinder
operator|=
name|dskaddr
operator|->
name|cylinder
expr_stmt|;
name|dcb
operator|.
name|trail
operator|.
name|sktrail
operator|.
name|skaddr
operator|.
name|track
operator|=
name|dskaddr
operator|->
name|track
expr_stmt|;
name|dcb
operator|.
name|trail
operator|.
name|sktrail
operator|.
name|skaddr
operator|.
name|sector
operator|=
name|dskaddr
operator|->
name|sector
expr_stmt|;
block|}
else|else
block|{
name|dcb
operator|.
name|trailcnt
operator|=
call|(
name|char
call|)
argument_list|(
sizeof|sizeof
argument_list|(
expr|struct
name|trrw
argument_list|)
operator|/
sizeof|sizeof
argument_list|(
name|long
argument_list|)
argument_list|)
expr_stmt|;
name|dcb
operator|.
name|trail
operator|.
name|rwtrail
operator|.
name|memadr
operator|=
operator|(
name|u_long
operator|)
name|buf
expr_stmt|;
name|dcb
operator|.
name|trail
operator|.
name|rwtrail
operator|.
name|wcount
operator|=
name|count
operator|*
operator|(
name|lab
operator|->
name|d_secsize
operator|/
sizeof|sizeof
argument_list|(
name|short
argument_list|)
operator|)
expr_stmt|;
name|dcb
operator|.
name|trail
operator|.
name|rwtrail
operator|.
name|disk
operator|.
name|cylinder
operator|=
name|dskaddr
operator|->
name|cylinder
expr_stmt|;
name|dcb
operator|.
name|trail
operator|.
name|rwtrail
operator|.
name|disk
operator|.
name|track
operator|=
name|dskaddr
operator|->
name|track
expr_stmt|;
name|dcb
operator|.
name|trail
operator|.
name|rwtrail
operator|.
name|disk
operator|.
name|sector
operator|=
name|dskaddr
operator|->
name|sector
expr_stmt|;
block|}
name|mdcb
operator|.
name|mdcb_head
operator|=
operator|&
name|dcb
expr_stmt|;
name|mdcb
operator|.
name|mdcb_status
operator|=
literal|0
expr_stmt|;
name|VDGO
argument_list|(
name|C_INFO
operator|->
name|addr
argument_list|,
operator|(
name|u_long
operator|)
operator|&
name|mdcb
argument_list|,
name|C_INFO
operator|->
name|type
argument_list|)
expr_stmt|;
if|if
condition|(
name|wait
condition|)
block|{
name|poll
argument_list|(
literal|10
argument_list|)
expr_stmt|;
if|if
condition|(
name|vdtimeout
operator|<=
literal|0
condition|)
block|{
name|printf
argument_list|(
literal|" in access_dsk.\n"
argument_list|)
expr_stmt|;
name|_longjmp
argument_list|(
name|abort_environ
argument_list|,
literal|1
argument_list|)
expr_stmt|;
block|}
block|}
name|wait_for_char
operator|=
literal|1
expr_stmt|;
return|return
name|dcb
operator|.
name|operrsta
return|;
block|}
end_block

begin_comment
comment|/* **	Spin_up_drive starts the drives on a controller and waits around for ** the drive to spin up if it is not already spinning. */
end_comment

begin_macro
name|spin_up_drive
argument_list|()
end_macro

begin_block
block|{
specifier|register
name|struct
name|vddevice
modifier|*
name|addr
init|=
name|C_INFO
operator|->
name|addr
decl_stmt|;
name|VDRESET
argument_list|(
name|addr
argument_list|,
name|C_INFO
operator|->
name|type
argument_list|)
expr_stmt|;
if|if
condition|(
name|C_INFO
operator|->
name|type
operator|==
name|VDTYPE_SMDE
condition|)
block|{
name|addr
operator|->
name|vdcsr
operator|=
literal|0
expr_stmt|;
name|addr
operator|->
name|vdtcf_mdcb
operator|=
name|AM_ENPDA
expr_stmt|;
name|addr
operator|->
name|vdtcf_dcb
operator|=
name|AM_ENPDA
expr_stmt|;
name|addr
operator|->
name|vdtcf_trail
operator|=
name|AM_ENPDA
expr_stmt|;
name|addr
operator|->
name|vdtcf_data
operator|=
name|AM_ENPDA
expr_stmt|;
name|addr
operator|->
name|vdccf
operator|=
name|CCF_SEN
operator||
literal|0x8
operator||
name|CCF_STS
operator||
name|XMD_32BIT
operator||
name|BSZ_16WRD
operator||
name|CCF_ERR
operator||
name|CCF_ENP
operator||
name|CCF_EPE
operator||
name|CCF_EDE
operator||
name|CCF_ECE
expr_stmt|;
block|}
name|access_with_no_trailer
argument_list|(
name|VDOP_INIT
argument_list|,
literal|10
argument_list|)
expr_stmt|;
name|access_with_no_trailer
argument_list|(
name|VDOP_DIAG
argument_list|,
literal|20
argument_list|)
expr_stmt|;
name|configure_drive
argument_list|(
literal|0
argument_list|)
expr_stmt|;
block|}
end_block

begin_comment
comment|/* **	Configure_drive tells the controller what kind of drive is attached ** on a particular line. */
end_comment

begin_macro
name|configure_drive
argument_list|(
argument|pass
argument_list|)
end_macro

begin_decl_stmt
name|int
name|pass
decl_stmt|;
end_decl_stmt

begin_block
block|{
specifier|register
name|struct
name|vddevice
modifier|*
name|addr
init|=
name|C_INFO
operator|->
name|addr
decl_stmt|;
specifier|register
name|i
expr_stmt|;
name|top
label|:
name|dcb
operator|.
name|opcode
operator|=
name|VDOP_CONFIG
expr_stmt|;
comment|/* command */
name|dcb
operator|.
name|intflg
operator|=
name|DCBINT_NONE
expr_stmt|;
name|dcb
operator|.
name|nxtdcb
operator|=
operator|(
expr|struct
name|dcb
operator|*
operator|)
literal|0
expr_stmt|;
comment|/* end of chain */
name|dcb
operator|.
name|operrsta
operator|=
literal|0
expr_stmt|;
name|dcb
operator|.
name|devselect
operator|=
name|cur
operator|.
name|drive
operator||
name|lab
operator|->
name|d_devflags
expr_stmt|;
name|dcb
operator|.
name|trail
operator|.
name|rstrail
operator|.
name|ncyl
operator|=
name|lab
operator|->
name|d_ncylinders
expr_stmt|;
name|dcb
operator|.
name|trail
operator|.
name|rstrail
operator|.
name|nsurfaces
operator|=
name|lab
operator|->
name|d_ntracks
expr_stmt|;
if|if
condition|(
name|C_INFO
operator|->
name|type
operator|==
name|VDTYPE_VDDC
condition|)
name|dcb
operator|.
name|trailcnt
operator|=
operator|(
name|char
operator|)
literal|2
expr_stmt|;
else|else
block|{
name|dcb
operator|.
name|trailcnt
operator|=
sizeof|sizeof
argument_list|(
expr|struct
name|treset
argument_list|)
operator|/
sizeof|sizeof
argument_list|(
name|long
argument_list|)
expr_stmt|;
name|dcb
operator|.
name|trail
operator|.
name|rstrail
operator|.
name|nsectors
operator|=
name|lab
operator|->
name|d_nsectors
expr_stmt|;
name|dcb
operator|.
name|trail
operator|.
name|rstrail
operator|.
name|slip_sec
operator|=
name|lab
operator|->
name|d_sparespertrack
expr_stmt|;
name|dcb
operator|.
name|trail
operator|.
name|rstrail
operator|.
name|recovery
operator|=
name|VDRF_NONE
expr_stmt|;
name|addr
operator|->
name|vdcylskew
operator|=
name|lab
operator|->
name|d_cylskew
expr_stmt|;
name|addr
operator|->
name|vdtrackskew
operator|=
name|lab
operator|->
name|d_trackskew
expr_stmt|;
name|addr
operator|->
name|vdsecsize
operator|=
name|lab
operator|->
name|d_secsize
operator|/
sizeof|sizeof
argument_list|(
name|short
argument_list|)
expr_stmt|;
block|}
name|mdcb
operator|.
name|mdcb_head
operator|=
operator|&
name|dcb
expr_stmt|;
name|mdcb
operator|.
name|mdcb_status
operator|=
literal|0
expr_stmt|;
name|VDGO
argument_list|(
name|addr
argument_list|,
operator|(
name|u_long
operator|)
operator|&
name|mdcb
argument_list|,
name|C_INFO
operator|->
name|type
argument_list|)
expr_stmt|;
name|poll
argument_list|(
literal|5
argument_list|)
expr_stmt|;
if|if
condition|(
name|vdtimeout
operator|<=
literal|0
condition|)
block|{
name|printf
argument_list|(
literal|" during drive configuration.\n"
argument_list|)
expr_stmt|;
goto|goto
name|bad
goto|;
block|}
if|if
condition|(
name|dcb
operator|.
name|operrsta
operator|&
name|VDERR_HARD
condition|)
block|{
if|if
condition|(
name|C_INFO
operator|->
name|type
operator|==
name|VDTYPE_SMDE
condition|)
block|{
if|if
condition|(
name|lab
operator|->
name|d_devflags
operator|==
literal|0
condition|)
block|{
name|lab
operator|->
name|d_devflags
operator|=
name|VD_ESDI
expr_stmt|;
goto|goto
name|top
goto|;
block|}
ifdef|#
directive|ifdef
name|notdef
name|printf
argument_list|(
literal|"vdstatus %x\n"
argument_list|,
name|addr
operator|->
name|vdstatus
index|[
name|cur
operator|.
name|drive
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|addr
operator|->
name|vdstatus
index|[
name|cur
operator|.
name|drive
index|]
operator|&
name|STA_US
operator|)
operator|==
literal|0
condition|)
block|{
name|printf
argument_list|(
literal|"Drive not present\n\n"
argument_list|)
expr_stmt|;
goto|goto
name|bad
goto|;
block|}
endif|#
directive|endif
block|}
if|if
condition|(
operator|(
name|dcb
operator|.
name|operrsta
operator|&
operator|(
name|DCBS_OCYL
operator||
name|DCBS_NRDY
operator|)
operator|)
operator|==
literal|0
condition|)
block|{
name|printf
argument_list|(
literal|"drive config error\n"
argument_list|)
expr_stmt|;
goto|goto
name|bad
goto|;
block|}
if|if
condition|(
name|pass
condition|)
block|{
name|printf
argument_list|(
literal|"\nDrive failed to start!\n\n"
argument_list|)
expr_stmt|;
goto|goto
name|bad
goto|;
block|}
name|printf
argument_list|(
literal|"\ndrive not ready, attempting to spin up..."
argument_list|)
expr_stmt|;
name|access_with_no_trailer
argument_list|(
name|VDOP_START
argument_list|,
literal|62
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|620
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|C_INFO
operator|->
name|type
operator|==
name|VDTYPE_SMDE
operator|&&
name|addr
operator|->
name|vdstatus
index|[
name|cur
operator|.
name|drive
index|]
operator|&
name|STA_UR
condition|)
break|break;
name|DELAY
argument_list|(
literal|100000
argument_list|)
expr_stmt|;
block|}
name|printf
argument_list|(
literal|" retrying drive configuration\n"
argument_list|)
expr_stmt|;
name|pass
operator|++
expr_stmt|;
name|lab
operator|->
name|d_devflags
operator|=
literal|0
expr_stmt|;
goto|goto
name|top
goto|;
block|}
name|D_INFO
operator|->
name|alive
operator|=
name|u_true
expr_stmt|;
return|return;
name|bad
label|:
name|D_INFO
operator|->
name|alive
operator|=
name|u_false
expr_stmt|;
name|_longjmp
argument_list|(
name|abort_environ
argument_list|,
operator|-
literal|1
argument_list|)
expr_stmt|;
block|}
end_block

begin_comment
comment|/* ** 	data_ok checks an error status word for bit patterns **  associated with error conditions from the VDDC controller.  If a hardware **  error is present then the problem is reported on the console. **  If a data error is present the a zero is returned. **  If everything is OK then a 1 is returned. */
end_comment

begin_macro
name|data_ok
argument_list|()
end_macro

begin_block
block|{
specifier|register
name|int
name|status
init|=
name|dcb
operator|.
name|operrsta
decl_stmt|;
if|if
condition|(
name|status
operator|&
name|HARD_ERROR
condition|)
block|{
name|vd_error
argument_list|(
literal|"data transfer"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"  op = 0x%x\n"
argument_list|,
name|dcb
operator|.
name|opcode
argument_list|)
expr_stmt|;
name|reset_controller
argument_list|()
expr_stmt|;
name|dcb
operator|.
name|operrsta
operator|&=
name|HEADER_ERROR
expr_stmt|;
block|}
return|return
call|(
name|int
call|)
argument_list|(
operator|!
operator|(
name|status
operator|&
operator|(
name|DATA_ERROR
operator||
name|HEADER_ERROR
operator|)
operator|)
argument_list|)
return|;
block|}
end_block

begin_macro
name|vd_error
argument_list|(
argument|s
argument_list|)
end_macro

begin_decl_stmt
name|char
modifier|*
name|s
decl_stmt|;
end_decl_stmt

begin_block
block|{
specifier|register
name|int
name|status
init|=
name|dcb
operator|.
name|operrsta
decl_stmt|;
name|print
argument_list|(
literal|"%s error at sector %d (cyl %d trk %d sect %d),\n"
argument_list|,
name|s
argument_list|,
name|to_sector
argument_list|(
name|cur
operator|.
name|daddr
argument_list|)
argument_list|,
name|dcb
operator|.
name|err_cyl
operator|&
literal|0xfff
argument_list|,
name|dcb
operator|.
name|err_trk
argument_list|,
name|dcb
operator|.
name|err_sec
argument_list|)
expr_stmt|;
name|print
argument_list|(
literal|"  status=%b"
argument_list|,
name|dcb
operator|.
name|operrsta
argument_list|,
name|VDERRBITS
argument_list|)
expr_stmt|;
if|if
condition|(
name|C_INFO
operator|->
name|type
operator|==
name|VDTYPE_SMDE
condition|)
name|printf
argument_list|(
literal|", ecode=0x%x"
argument_list|,
name|dcb
operator|.
name|err_code
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|".\n"
argument_list|)
expr_stmt|;
block|}
end_block

begin_comment
comment|/* ** */
end_comment

begin_macro
name|reset_controller
argument_list|()
end_macro

begin_block
block|{
name|printf
argument_list|(
literal|"Resetting controller.  Please wait...\n"
argument_list|)
expr_stmt|;
name|spin_up_drive
argument_list|()
expr_stmt|;
name|printf
argument_list|(
literal|"Controller was reset successfully.\n"
argument_list|)
expr_stmt|;
block|}
end_block

begin_comment
comment|/* ** */
end_comment

begin_decl_stmt
specifier|static
name|int
name|indent_count
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* ** */
end_comment

begin_macro
name|indent
argument_list|()
end_macro

begin_block
block|{
name|indent_count
operator|+=
literal|2
expr_stmt|;
block|}
end_block

begin_comment
comment|/* ** */
end_comment

begin_macro
name|exdent
argument_list|(
argument|count
argument_list|)
end_macro

begin_decl_stmt
name|int
name|count
decl_stmt|;
end_decl_stmt

begin_block
block|{
if|if
condition|(
name|count
operator|==
operator|-
literal|1
condition|)
name|indent_count
operator|=
literal|0
expr_stmt|;
else|else
name|indent_count
operator|-=
name|count
operator|*
literal|2
expr_stmt|;
if|if
condition|(
name|indent_count
operator|<
literal|0
condition|)
name|indent_count
operator|=
literal|0
expr_stmt|;
block|}
end_block

begin_comment
comment|/* ** */
end_comment

begin_comment
comment|/*VARARGS1*/
end_comment

begin_macro
name|print
argument_list|(
argument|par0
argument_list|,
argument|par1
argument_list|,
argument|par2
argument_list|,
argument|par3
argument_list|,
argument|par4
argument_list|,
argument|par5
argument_list|,
argument|par6
argument_list|)
end_macro

begin_decl_stmt
name|char
modifier|*
name|par0
decl_stmt|,
modifier|*
name|par1
decl_stmt|,
modifier|*
name|par2
decl_stmt|,
modifier|*
name|par3
decl_stmt|,
modifier|*
name|par4
decl_stmt|,
modifier|*
name|par5
decl_stmt|,
modifier|*
name|par6
decl_stmt|;
end_decl_stmt

begin_block
block|{
specifier|register
name|int
name|count
init|=
name|indent_count
decl_stmt|;
while|while
condition|(
name|count
operator|--
condition|)
name|printf
argument_list|(
literal|" "
argument_list|)
expr_stmt|;
name|printf
argument_list|(
name|par0
argument_list|,
name|par1
argument_list|,
name|par2
argument_list|,
name|par3
argument_list|,
name|par4
argument_list|,
name|par5
argument_list|,
name|par6
argument_list|)
expr_stmt|;
name|DELAY
argument_list|(
operator|(
name|strlen
argument_list|(
name|par0
argument_list|)
operator|+
literal|20
operator|)
operator|*
literal|9000
argument_list|)
expr_stmt|;
block|}
end_block

end_unit


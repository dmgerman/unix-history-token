begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_ifndef
ifndef|#
directive|ifndef
name|lint
end_ifndef

begin_decl_stmt
specifier|static
name|char
name|sccsid
index|[]
init|=
literal|"%W% (Berkeley/CCI) %G%"
decl_stmt|;
end_decl_stmt

begin_endif
endif|#
directive|endif
end_endif

begin_include
include|#
directive|include
file|"vdfmt.h"
end_include

begin_include
include|#
directive|include
file|"cmd.h"
end_include

begin_comment
comment|/* ** */
end_comment

begin_decl_stmt
specifier|static
name|cmd_text_element
name|nul_table
index|[]
init|=
block|{
block|{
literal|0
block|,
literal|""
block|,
literal|""
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|wait_for_char
init|=
literal|1
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* synchronous by default */
end_comment

begin_decl_stmt
name|int
name|vdtimeout
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|char
modifier|*
name|clean_up
init|=
literal|"Cleaning up...  Please wait.\n"
decl_stmt|;
end_decl_stmt

begin_macro
name|vread
argument_list|(
argument|sn
argument_list|,
argument|buf
argument_list|,
argument|seccnt
argument_list|)
end_macro

begin_decl_stmt
name|int
name|sn
decl_stmt|,
name|seccnt
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|char
modifier|*
name|buf
decl_stmt|;
end_decl_stmt

begin_block
block|{
return|return
operator|(
name|vrdwr
argument_list|(
name|sn
argument_list|,
name|buf
argument_list|,
name|seccnt
argument_list|,
name|VDOP_RD
argument_list|)
operator|)
return|;
block|}
end_block

begin_macro
name|vwrite
argument_list|(
argument|sn
argument_list|,
argument|buf
argument_list|,
argument|seccnt
argument_list|)
end_macro

begin_decl_stmt
name|int
name|sn
decl_stmt|,
name|seccnt
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|char
modifier|*
name|buf
decl_stmt|;
end_decl_stmt

begin_block
block|{
return|return
operator|(
name|vrdwr
argument_list|(
name|sn
argument_list|,
name|buf
argument_list|,
name|seccnt
argument_list|,
name|VDOP_WD
argument_list|)
operator|)
return|;
block|}
end_block

begin_macro
name|vrdwr
argument_list|(
argument|sn
argument_list|,
argument|buf
argument_list|,
argument|seccnt
argument_list|,
argument|op
argument_list|)
end_macro

begin_decl_stmt
name|int
name|sn
decl_stmt|,
name|seccnt
decl_stmt|,
name|op
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|char
modifier|*
name|buf
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|dskadr
name|dskaddr
decl_stmt|;
name|dskaddr
operator|.
name|cylinder
operator|=
name|sn
operator|/
name|lab
operator|->
name|d_secpercyl
expr_stmt|;
name|sn
operator|%=
name|lab
operator|->
name|d_secpercyl
expr_stmt|;
name|dskaddr
operator|.
name|track
operator|=
name|sn
operator|/
name|lab
operator|->
name|d_nsectors
expr_stmt|;
name|dskaddr
operator|.
name|sector
operator|=
name|sn
operator|%
name|lab
operator|->
name|d_nsectors
expr_stmt|;
if|if
condition|(
name|access_dsk
argument_list|(
name|buf
argument_list|,
operator|&
name|dskaddr
argument_list|,
name|op
argument_list|,
name|seccnt
argument_list|,
literal|1
argument_list|)
operator|&
name|DCBS_HARD
condition|)
return|return
operator|(
literal|0
operator|)
return|;
return|return
operator|(
name|seccnt
operator|)
return|;
block|}
end_block

begin_comment
comment|/* **	access_dsk is used by other routines to do reads and writes to the disk. ** The status of the read / write is returned to the caller for processing. */
end_comment

begin_macro
name|access_dsk
argument_list|(
argument|buf
argument_list|,
argument|dskaddr
argument_list|,
argument|func
argument_list|,
argument|count
argument_list|,
argument|wait
argument_list|)
end_macro

begin_decl_stmt
name|char
modifier|*
name|buf
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|dskadr
modifier|*
name|dskaddr
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|func
decl_stmt|,
name|count
decl_stmt|,
name|wait
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|struct
name|format_op
name|fop
decl_stmt|;
name|cur
operator|.
name|daddr
operator|.
name|cylinder
operator|=
name|dskaddr
operator|->
name|cylinder
expr_stmt|;
name|cur
operator|.
name|daddr
operator|.
name|track
operator|=
name|dskaddr
operator|->
name|track
expr_stmt|;
name|wait_for_char
operator|=
literal|0
expr_stmt|;
name|bzero
argument_list|(
operator|(
name|char
operator|*
operator|)
operator|&
name|fop
argument_list|,
sizeof|sizeof
argument_list|(
name|fop
argument_list|)
argument_list|)
expr_stmt|;
name|fop
operator|.
name|df_buf
operator|=
name|buf
expr_stmt|;
name|fop
operator|.
name|df_count
operator|=
name|count
operator|*
name|lab
operator|->
name|d_secsize
expr_stmt|;
name|fop
operator|.
name|df_startblk
operator|=
operator|(
operator|(
name|dskaddr
operator|->
name|cylinder
operator|&
literal|0xfff
operator|)
operator|*
name|lab
operator|->
name|d_ntracks
operator|+
name|dskaddr
operator|->
name|track
operator|)
operator|*
name|lab
operator|->
name|d_nsectors
operator|+
name|dskaddr
operator|->
name|sector
expr_stmt|;
name|fop
operator|.
name|df_reg
index|[
literal|0
index|]
operator|=
name|func
expr_stmt|;
operator|(
name|void
operator|)
name|ioctl
argument_list|(
name|diskfd
argument_list|,
name|DIOCWFORMAT
argument_list|,
operator|&
name|fop
argument_list|)
expr_stmt|;
name|wait_for_char
operator|=
literal|1
expr_stmt|;
name|dcb
operator|.
name|operrsta
operator|=
name|fop
operator|.
name|df_reg
index|[
literal|0
index|]
expr_stmt|;
comment|/* XXX */
name|dcb
operator|.
name|err_code
operator|=
name|fop
operator|.
name|df_reg
index|[
literal|1
index|]
expr_stmt|;
comment|/* XXX */
return|return
operator|(
name|fop
operator|.
name|df_reg
index|[
literal|0
index|]
operator|)
return|;
block|}
end_block

begin_comment
comment|/* ** 	data_ok checks an error status word for bit patterns **  associated with error conditions from the VDDC controller.  If a hardware **  error is present then the problem is reported on the console. **  If a data error is present the a zero is returned. **  If everything is OK then a 1 is returned. */
end_comment

begin_macro
name|data_ok
argument_list|()
end_macro

begin_block
block|{
specifier|register
name|int
name|status
init|=
name|dcb
operator|.
name|operrsta
decl_stmt|;
if|if
condition|(
name|status
operator|&
name|HARD_ERROR
condition|)
block|{
name|vd_error
argument_list|(
literal|"data transfer"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"  op = 0x%x\n"
argument_list|,
name|dcb
operator|.
name|opcode
argument_list|)
expr_stmt|;
name|dcb
operator|.
name|operrsta
operator|&=
name|HEADER_ERROR
expr_stmt|;
block|}
return|return
call|(
name|int
call|)
argument_list|(
operator|!
operator|(
name|status
operator|&
operator|(
name|DATA_ERROR
operator||
name|HEADER_ERROR
operator|)
operator|)
argument_list|)
return|;
block|}
end_block

begin_macro
name|vd_error
argument_list|(
argument|s
argument_list|)
end_macro

begin_decl_stmt
name|char
modifier|*
name|s
decl_stmt|;
end_decl_stmt

begin_block
block|{
specifier|register
name|int
name|status
init|=
name|dcb
operator|.
name|operrsta
decl_stmt|;
name|print
argument_list|(
literal|"%s error at sector %d (cyl %d trk %d sect %d),\n"
argument_list|,
name|to_sector
argument_list|(
name|cur
operator|.
name|daddr
argument_list|)
argument_list|,
name|dcb
operator|.
name|err_cyl
argument_list|,
name|dcb
operator|.
name|err_trk
argument_list|,
name|dcb
operator|.
name|err_sec
argument_list|)
expr_stmt|;
name|print
argument_list|(
literal|"  status=%b"
argument_list|,
name|dcb
operator|.
name|operrsta
argument_list|,
name|VDERRBITS
argument_list|)
expr_stmt|;
if|if
condition|(
name|C_INFO
operator|->
name|type
operator|==
name|VDTYPE_SMDE
condition|)
name|printf
argument_list|(
literal|", ecode=0x%x"
argument_list|,
name|dcb
operator|.
name|err_code
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
block|}
end_block

begin_comment
comment|/* ** */
end_comment

begin_decl_stmt
specifier|static
name|int
name|indent_count
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* ** */
end_comment

begin_macro
name|indent
argument_list|()
end_macro

begin_block
block|{
name|indent_count
operator|+=
literal|2
expr_stmt|;
block|}
end_block

begin_comment
comment|/* ** */
end_comment

begin_macro
name|exdent
argument_list|(
argument|count
argument_list|)
end_macro

begin_decl_stmt
name|int
name|count
decl_stmt|;
end_decl_stmt

begin_block
block|{
if|if
condition|(
name|count
operator|==
operator|-
literal|1
condition|)
name|indent_count
operator|=
literal|0
expr_stmt|;
else|else
name|indent_count
operator|-=
name|count
operator|*
literal|2
expr_stmt|;
if|if
condition|(
name|indent_count
operator|<
literal|0
condition|)
name|indent_count
operator|=
literal|0
expr_stmt|;
block|}
end_block

begin_comment
comment|/* ** */
end_comment

begin_comment
comment|/*VARARGS1*/
end_comment

begin_macro
name|print
argument_list|(
argument|par0
argument_list|,
argument|par1
argument_list|,
argument|par2
argument_list|,
argument|par3
argument_list|,
argument|par4
argument_list|,
argument|par5
argument_list|,
argument|par6
argument_list|)
end_macro

begin_decl_stmt
name|char
modifier|*
name|par0
decl_stmt|,
modifier|*
name|par1
decl_stmt|,
modifier|*
name|par2
decl_stmt|,
modifier|*
name|par3
decl_stmt|,
modifier|*
name|par4
decl_stmt|,
modifier|*
name|par5
decl_stmt|,
modifier|*
name|par6
decl_stmt|;
end_decl_stmt

begin_block
block|{
specifier|register
name|int
name|count
init|=
name|indent_count
decl_stmt|;
while|while
condition|(
name|count
operator|--
condition|)
name|printf
argument_list|(
literal|" "
argument_list|)
expr_stmt|;
name|printf
argument_list|(
name|par0
argument_list|,
name|par1
argument_list|,
name|par2
argument_list|,
name|par3
argument_list|,
name|par4
argument_list|,
name|par5
argument_list|,
name|par6
argument_list|)
expr_stmt|;
comment|/*	DELAY((strlen(par0) + 20) * 9000); */
block|}
end_block

end_unit


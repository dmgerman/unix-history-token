begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * RSN pre-authentication (supplicant)  * Copyright (c) 2003-2015, Jouni Malinen<j@w1.fi>  *  * This software may be distributed under the terms of the BSD license.  * See README for more details.  */
end_comment

begin_include
include|#
directive|include
file|"includes.h"
end_include

begin_include
include|#
directive|include
file|"common.h"
end_include

begin_include
include|#
directive|include
file|"wpa.h"
end_include

begin_include
include|#
directive|include
file|"eloop.h"
end_include

begin_include
include|#
directive|include
file|"l2_packet/l2_packet.h"
end_include

begin_include
include|#
directive|include
file|"eapol_supp/eapol_supp_sm.h"
end_include

begin_include
include|#
directive|include
file|"preauth.h"
end_include

begin_include
include|#
directive|include
file|"pmksa_cache.h"
end_include

begin_include
include|#
directive|include
file|"wpa_i.h"
end_include

begin_ifdef
ifdef|#
directive|ifdef
name|IEEE8021X_EAPOL
end_ifdef

begin_define
define|#
directive|define
name|PMKID_CANDIDATE_PRIO_SCAN
value|1000
end_define

begin_struct
struct|struct
name|rsn_pmksa_candidate
block|{
name|struct
name|dl_list
name|list
decl_stmt|;
name|u8
name|bssid
index|[
name|ETH_ALEN
index|]
decl_stmt|;
name|int
name|priority
decl_stmt|;
block|}
struct|;
end_struct

begin_comment
comment|/**  * pmksa_candidate_free - Free all entries in PMKSA candidate list  * @sm: Pointer to WPA state machine data from wpa_sm_init()  */
end_comment

begin_function
name|void
name|pmksa_candidate_free
parameter_list|(
name|struct
name|wpa_sm
modifier|*
name|sm
parameter_list|)
block|{
name|struct
name|rsn_pmksa_candidate
modifier|*
name|entry
decl_stmt|,
modifier|*
name|n
decl_stmt|;
if|if
condition|(
name|sm
operator|==
name|NULL
condition|)
return|return;
name|dl_list_for_each_safe
argument_list|(
argument|entry
argument_list|,
argument|n
argument_list|,
argument|&sm->pmksa_candidates
argument_list|,
argument|struct rsn_pmksa_candidate
argument_list|,
argument|list
argument_list|)
block|{
name|dl_list_del
argument_list|(
operator|&
name|entry
operator|->
name|list
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|entry
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|rsn_preauth_receive
parameter_list|(
name|void
modifier|*
name|ctx
parameter_list|,
specifier|const
name|u8
modifier|*
name|src_addr
parameter_list|,
specifier|const
name|u8
modifier|*
name|buf
parameter_list|,
name|size_t
name|len
parameter_list|)
block|{
name|struct
name|wpa_sm
modifier|*
name|sm
init|=
name|ctx
decl_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"RX pre-auth from "
name|MACSTR
argument_list|,
name|MAC2STR
argument_list|(
name|src_addr
argument_list|)
argument_list|)
expr_stmt|;
name|wpa_hexdump
argument_list|(
name|MSG_MSGDUMP
argument_list|,
literal|"RX pre-auth"
argument_list|,
name|buf
argument_list|,
name|len
argument_list|)
expr_stmt|;
if|if
condition|(
name|sm
operator|->
name|preauth_eapol
operator|==
name|NULL
operator|||
name|is_zero_ether_addr
argument_list|(
name|sm
operator|->
name|preauth_bssid
argument_list|)
operator|||
name|os_memcmp
argument_list|(
name|sm
operator|->
name|preauth_bssid
argument_list|,
name|src_addr
argument_list|,
name|ETH_ALEN
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_WARNING
argument_list|,
literal|"RSN pre-auth frame received from "
literal|"unexpected source "
name|MACSTR
literal|" - dropped"
argument_list|,
name|MAC2STR
argument_list|(
name|src_addr
argument_list|)
argument_list|)
expr_stmt|;
return|return;
block|}
name|eapol_sm_rx_eapol
argument_list|(
name|sm
operator|->
name|preauth_eapol
argument_list|,
name|src_addr
argument_list|,
name|buf
argument_list|,
name|len
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|rsn_preauth_eapol_cb
parameter_list|(
name|struct
name|eapol_sm
modifier|*
name|eapol
parameter_list|,
name|enum
name|eapol_supp_result
name|result
parameter_list|,
name|void
modifier|*
name|ctx
parameter_list|)
block|{
name|struct
name|wpa_sm
modifier|*
name|sm
init|=
name|ctx
decl_stmt|;
name|u8
name|pmk
index|[
name|PMK_LEN
index|]
decl_stmt|;
if|if
condition|(
name|result
operator|==
name|EAPOL_SUPP_RESULT_SUCCESS
condition|)
block|{
name|int
name|res
decl_stmt|,
name|pmk_len
decl_stmt|;
name|pmk_len
operator|=
name|PMK_LEN
expr_stmt|;
name|res
operator|=
name|eapol_sm_get_key
argument_list|(
name|eapol
argument_list|,
name|pmk
argument_list|,
name|PMK_LEN
argument_list|)
expr_stmt|;
if|if
condition|(
name|res
condition|)
block|{
comment|/* 			 * EAP-LEAP is an exception from other EAP methods: it 			 * uses only 16-byte PMK. 			 */
name|res
operator|=
name|eapol_sm_get_key
argument_list|(
name|eapol
argument_list|,
name|pmk
argument_list|,
literal|16
argument_list|)
expr_stmt|;
name|pmk_len
operator|=
literal|16
expr_stmt|;
block|}
if|if
condition|(
name|res
operator|==
literal|0
condition|)
block|{
name|wpa_hexdump_key
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"RSN: PMK from pre-auth"
argument_list|,
name|pmk
argument_list|,
name|pmk_len
argument_list|)
expr_stmt|;
name|sm
operator|->
name|pmk_len
operator|=
name|pmk_len
expr_stmt|;
name|pmksa_cache_add
argument_list|(
name|sm
operator|->
name|pmksa
argument_list|,
name|pmk
argument_list|,
name|pmk_len
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|,
name|sm
operator|->
name|preauth_bssid
argument_list|,
name|sm
operator|->
name|own_addr
argument_list|,
name|sm
operator|->
name|network_ctx
argument_list|,
name|WPA_KEY_MGMT_IEEE8021X
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|wpa_msg
argument_list|(
name|sm
operator|->
name|ctx
operator|->
name|msg_ctx
argument_list|,
name|MSG_INFO
argument_list|,
literal|"RSN: failed to get master session key from "
literal|"pre-auth EAPOL state machines"
argument_list|)
expr_stmt|;
name|result
operator|=
name|EAPOL_SUPP_RESULT_FAILURE
expr_stmt|;
block|}
block|}
name|wpa_msg
argument_list|(
name|sm
operator|->
name|ctx
operator|->
name|msg_ctx
argument_list|,
name|MSG_INFO
argument_list|,
literal|"RSN: pre-authentication with "
name|MACSTR
literal|" %s"
argument_list|,
name|MAC2STR
argument_list|(
name|sm
operator|->
name|preauth_bssid
argument_list|)
argument_list|,
name|result
operator|==
name|EAPOL_SUPP_RESULT_SUCCESS
condition|?
literal|"completed successfully"
else|:
literal|"failed"
argument_list|)
expr_stmt|;
name|rsn_preauth_deinit
argument_list|(
name|sm
argument_list|)
expr_stmt|;
name|rsn_preauth_candidate_process
argument_list|(
name|sm
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|rsn_preauth_timeout
parameter_list|(
name|void
modifier|*
name|eloop_ctx
parameter_list|,
name|void
modifier|*
name|timeout_ctx
parameter_list|)
block|{
name|struct
name|wpa_sm
modifier|*
name|sm
init|=
name|eloop_ctx
decl_stmt|;
name|wpa_msg
argument_list|(
name|sm
operator|->
name|ctx
operator|->
name|msg_ctx
argument_list|,
name|MSG_INFO
argument_list|,
literal|"RSN: pre-authentication with "
name|MACSTR
literal|" timed out"
argument_list|,
name|MAC2STR
argument_list|(
name|sm
operator|->
name|preauth_bssid
argument_list|)
argument_list|)
expr_stmt|;
name|rsn_preauth_deinit
argument_list|(
name|sm
argument_list|)
expr_stmt|;
name|rsn_preauth_candidate_process
argument_list|(
name|sm
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|rsn_preauth_eapol_send
parameter_list|(
name|void
modifier|*
name|ctx
parameter_list|,
name|int
name|type
parameter_list|,
specifier|const
name|u8
modifier|*
name|buf
parameter_list|,
name|size_t
name|len
parameter_list|)
block|{
name|struct
name|wpa_sm
modifier|*
name|sm
init|=
name|ctx
decl_stmt|;
name|u8
modifier|*
name|msg
decl_stmt|;
name|size_t
name|msglen
decl_stmt|;
name|int
name|res
decl_stmt|;
comment|/* TODO: could add l2_packet_sendmsg that allows fragments to avoid 	 * extra copy here */
if|if
condition|(
name|sm
operator|->
name|l2_preauth
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
name|msg
operator|=
name|wpa_sm_alloc_eapol
argument_list|(
name|sm
argument_list|,
name|type
argument_list|,
name|buf
argument_list|,
name|len
argument_list|,
operator|&
name|msglen
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|msg
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
name|wpa_hexdump
argument_list|(
name|MSG_MSGDUMP
argument_list|,
literal|"TX EAPOL (preauth)"
argument_list|,
name|msg
argument_list|,
name|msglen
argument_list|)
expr_stmt|;
name|res
operator|=
name|l2_packet_send
argument_list|(
name|sm
operator|->
name|l2_preauth
argument_list|,
name|sm
operator|->
name|preauth_bssid
argument_list|,
name|ETH_P_RSN_PREAUTH
argument_list|,
name|msg
argument_list|,
name|msglen
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|msg
argument_list|)
expr_stmt|;
return|return
name|res
return|;
block|}
end_function

begin_comment
comment|/**  * rsn_preauth_init - Start new RSN pre-authentication  * @sm: Pointer to WPA state machine data from wpa_sm_init()  * @dst: Authenticator address (BSSID) with which to preauthenticate  * @eap_conf: Current EAP configuration  * Returns: 0 on success, -1 on another pre-authentication is in progress,  * -2 on layer 2 packet initialization failure, -3 on EAPOL state machine  * initialization failure, -4 on memory allocation failure  *  * This function request an RSN pre-authentication with a given destination  * address. This is usually called for PMKSA candidates found from scan results  * or from driver reports. In addition, ctrl_iface PREAUTH command can trigger  * pre-authentication.  */
end_comment

begin_function
name|int
name|rsn_preauth_init
parameter_list|(
name|struct
name|wpa_sm
modifier|*
name|sm
parameter_list|,
specifier|const
name|u8
modifier|*
name|dst
parameter_list|,
name|struct
name|eap_peer_config
modifier|*
name|eap_conf
parameter_list|)
block|{
name|struct
name|eapol_config
name|eapol_conf
decl_stmt|;
name|struct
name|eapol_ctx
modifier|*
name|ctx
decl_stmt|;
name|int
name|ret
decl_stmt|;
if|if
condition|(
name|sm
operator|->
name|preauth_eapol
condition|)
return|return
operator|-
literal|1
return|;
name|wpa_msg
argument_list|(
name|sm
operator|->
name|ctx
operator|->
name|msg_ctx
argument_list|,
name|MSG_DEBUG
argument_list|,
literal|"RSN: starting pre-authentication with "
name|MACSTR
argument_list|,
name|MAC2STR
argument_list|(
name|dst
argument_list|)
argument_list|)
expr_stmt|;
name|sm
operator|->
name|l2_preauth
operator|=
name|l2_packet_init
argument_list|(
name|sm
operator|->
name|ifname
argument_list|,
name|sm
operator|->
name|own_addr
argument_list|,
name|ETH_P_RSN_PREAUTH
argument_list|,
name|rsn_preauth_receive
argument_list|,
name|sm
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|sm
operator|->
name|l2_preauth
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_WARNING
argument_list|,
literal|"RSN: Failed to initialize L2 packet "
literal|"processing for pre-authentication"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|2
return|;
block|}
if|if
condition|(
name|sm
operator|->
name|bridge_ifname
condition|)
block|{
name|sm
operator|->
name|l2_preauth_br
operator|=
name|l2_packet_init
argument_list|(
name|sm
operator|->
name|bridge_ifname
argument_list|,
name|sm
operator|->
name|own_addr
argument_list|,
name|ETH_P_RSN_PREAUTH
argument_list|,
name|rsn_preauth_receive
argument_list|,
name|sm
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|sm
operator|->
name|l2_preauth_br
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_WARNING
argument_list|,
literal|"RSN: Failed to initialize L2 "
literal|"packet processing (bridge) for "
literal|"pre-authentication"
argument_list|)
expr_stmt|;
name|ret
operator|=
operator|-
literal|2
expr_stmt|;
goto|goto
name|fail
goto|;
block|}
block|}
name|ctx
operator|=
name|os_zalloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|ctx
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|ctx
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_WARNING
argument_list|,
literal|"Failed to allocate EAPOL context."
argument_list|)
expr_stmt|;
name|ret
operator|=
operator|-
literal|4
expr_stmt|;
goto|goto
name|fail
goto|;
block|}
name|ctx
operator|->
name|ctx
operator|=
name|sm
operator|->
name|ctx
operator|->
name|ctx
expr_stmt|;
name|ctx
operator|->
name|msg_ctx
operator|=
name|sm
operator|->
name|ctx
operator|->
name|ctx
expr_stmt|;
name|ctx
operator|->
name|preauth
operator|=
literal|1
expr_stmt|;
name|ctx
operator|->
name|cb
operator|=
name|rsn_preauth_eapol_cb
expr_stmt|;
name|ctx
operator|->
name|cb_ctx
operator|=
name|sm
expr_stmt|;
name|ctx
operator|->
name|scard_ctx
operator|=
name|sm
operator|->
name|scard_ctx
expr_stmt|;
name|ctx
operator|->
name|eapol_send
operator|=
name|rsn_preauth_eapol_send
expr_stmt|;
name|ctx
operator|->
name|eapol_send_ctx
operator|=
name|sm
expr_stmt|;
name|ctx
operator|->
name|set_config_blob
operator|=
name|sm
operator|->
name|ctx
operator|->
name|set_config_blob
expr_stmt|;
name|ctx
operator|->
name|get_config_blob
operator|=
name|sm
operator|->
name|ctx
operator|->
name|get_config_blob
expr_stmt|;
name|sm
operator|->
name|preauth_eapol
operator|=
name|eapol_sm_init
argument_list|(
name|ctx
argument_list|)
expr_stmt|;
if|if
condition|(
name|sm
operator|->
name|preauth_eapol
operator|==
name|NULL
condition|)
block|{
name|os_free
argument_list|(
name|ctx
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_WARNING
argument_list|,
literal|"RSN: Failed to initialize EAPOL "
literal|"state machines for pre-authentication"
argument_list|)
expr_stmt|;
name|ret
operator|=
operator|-
literal|3
expr_stmt|;
goto|goto
name|fail
goto|;
block|}
name|os_memset
argument_list|(
operator|&
name|eapol_conf
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|eapol_conf
argument_list|)
argument_list|)
expr_stmt|;
name|eapol_conf
operator|.
name|accept_802_1x_keys
operator|=
literal|0
expr_stmt|;
name|eapol_conf
operator|.
name|required_keys
operator|=
literal|0
expr_stmt|;
name|eapol_conf
operator|.
name|fast_reauth
operator|=
name|sm
operator|->
name|fast_reauth
expr_stmt|;
name|eapol_conf
operator|.
name|workaround
operator|=
name|sm
operator|->
name|eap_workaround
expr_stmt|;
name|eapol_sm_notify_config
argument_list|(
name|sm
operator|->
name|preauth_eapol
argument_list|,
name|eap_conf
argument_list|,
operator|&
name|eapol_conf
argument_list|)
expr_stmt|;
comment|/* 	 * Use a shorter startPeriod with preauthentication since the first 	 * preauth EAPOL-Start frame may end up being dropped due to race 	 * condition in the AP between the data receive and key configuration 	 * after the 4-Way Handshake. 	 */
name|eapol_sm_configure
argument_list|(
name|sm
operator|->
name|preauth_eapol
argument_list|,
operator|-
literal|1
argument_list|,
operator|-
literal|1
argument_list|,
literal|5
argument_list|,
literal|6
argument_list|)
expr_stmt|;
name|os_memcpy
argument_list|(
name|sm
operator|->
name|preauth_bssid
argument_list|,
name|dst
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
name|eapol_sm_notify_portValid
argument_list|(
name|sm
operator|->
name|preauth_eapol
argument_list|,
name|TRUE
argument_list|)
expr_stmt|;
comment|/* 802.1X::portControl = Auto */
name|eapol_sm_notify_portEnabled
argument_list|(
name|sm
operator|->
name|preauth_eapol
argument_list|,
name|TRUE
argument_list|)
expr_stmt|;
name|eloop_register_timeout
argument_list|(
name|sm
operator|->
name|dot11RSNAConfigSATimeout
argument_list|,
literal|0
argument_list|,
name|rsn_preauth_timeout
argument_list|,
name|sm
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
name|fail
label|:
if|if
condition|(
name|sm
operator|->
name|l2_preauth_br
condition|)
block|{
name|l2_packet_deinit
argument_list|(
name|sm
operator|->
name|l2_preauth_br
argument_list|)
expr_stmt|;
name|sm
operator|->
name|l2_preauth_br
operator|=
name|NULL
expr_stmt|;
block|}
name|l2_packet_deinit
argument_list|(
name|sm
operator|->
name|l2_preauth
argument_list|)
expr_stmt|;
name|sm
operator|->
name|l2_preauth
operator|=
name|NULL
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_comment
comment|/**  * rsn_preauth_deinit - Abort RSN pre-authentication  * @sm: Pointer to WPA state machine data from wpa_sm_init()  *  * This function aborts the current RSN pre-authentication (if one is started)  * and frees resources allocated for it.  */
end_comment

begin_function
name|void
name|rsn_preauth_deinit
parameter_list|(
name|struct
name|wpa_sm
modifier|*
name|sm
parameter_list|)
block|{
if|if
condition|(
name|sm
operator|==
name|NULL
operator|||
operator|!
name|sm
operator|->
name|preauth_eapol
condition|)
return|return;
name|eloop_cancel_timeout
argument_list|(
name|rsn_preauth_timeout
argument_list|,
name|sm
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|eapol_sm_deinit
argument_list|(
name|sm
operator|->
name|preauth_eapol
argument_list|)
expr_stmt|;
name|sm
operator|->
name|preauth_eapol
operator|=
name|NULL
expr_stmt|;
name|os_memset
argument_list|(
name|sm
operator|->
name|preauth_bssid
argument_list|,
literal|0
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
name|l2_packet_deinit
argument_list|(
name|sm
operator|->
name|l2_preauth
argument_list|)
expr_stmt|;
name|sm
operator|->
name|l2_preauth
operator|=
name|NULL
expr_stmt|;
if|if
condition|(
name|sm
operator|->
name|l2_preauth_br
condition|)
block|{
name|l2_packet_deinit
argument_list|(
name|sm
operator|->
name|l2_preauth_br
argument_list|)
expr_stmt|;
name|sm
operator|->
name|l2_preauth_br
operator|=
name|NULL
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/**  * rsn_preauth_candidate_process - Process PMKSA candidates  * @sm: Pointer to WPA state machine data from wpa_sm_init()  *  * Go through the PMKSA candidates and start pre-authentication if a candidate  * without an existing PMKSA cache entry is found. Processed candidates will be  * removed from the list.  */
end_comment

begin_function
name|void
name|rsn_preauth_candidate_process
parameter_list|(
name|struct
name|wpa_sm
modifier|*
name|sm
parameter_list|)
block|{
name|struct
name|rsn_pmksa_candidate
modifier|*
name|candidate
decl_stmt|,
modifier|*
name|n
decl_stmt|;
if|if
condition|(
name|dl_list_empty
argument_list|(
operator|&
name|sm
operator|->
name|pmksa_candidates
argument_list|)
condition|)
return|return;
comment|/* TODO: drop priority for old candidate entries */
name|wpa_msg
argument_list|(
name|sm
operator|->
name|ctx
operator|->
name|msg_ctx
argument_list|,
name|MSG_DEBUG
argument_list|,
literal|"RSN: processing PMKSA candidate "
literal|"list"
argument_list|)
expr_stmt|;
if|if
condition|(
name|sm
operator|->
name|preauth_eapol
operator|||
name|sm
operator|->
name|proto
operator|!=
name|WPA_PROTO_RSN
operator|||
name|wpa_sm_get_state
argument_list|(
name|sm
argument_list|)
operator|!=
name|WPA_COMPLETED
operator|||
operator|(
name|sm
operator|->
name|key_mgmt
operator|!=
name|WPA_KEY_MGMT_IEEE8021X
operator|&&
name|sm
operator|->
name|key_mgmt
operator|!=
name|WPA_KEY_MGMT_IEEE8021X_SHA256
operator|&&
name|sm
operator|->
name|key_mgmt
operator|!=
name|WPA_KEY_MGMT_IEEE8021X_SUITE_B
operator|&&
name|sm
operator|->
name|key_mgmt
operator|!=
name|WPA_KEY_MGMT_IEEE8021X_SUITE_B_192
operator|)
condition|)
block|{
name|wpa_msg
argument_list|(
name|sm
operator|->
name|ctx
operator|->
name|msg_ctx
argument_list|,
name|MSG_DEBUG
argument_list|,
literal|"RSN: not in suitable "
literal|"state for new pre-authentication"
argument_list|)
expr_stmt|;
return|return;
comment|/* invalid state for new pre-auth */
block|}
name|dl_list_for_each_safe
argument_list|(
argument|candidate
argument_list|,
argument|n
argument_list|,
argument|&sm->pmksa_candidates
argument_list|,
argument|struct rsn_pmksa_candidate
argument_list|,
argument|list
argument_list|)
block|{
name|struct
name|rsn_pmksa_cache_entry
modifier|*
name|p
init|=
name|NULL
decl_stmt|;
name|p
operator|=
name|pmksa_cache_get
argument_list|(
name|sm
operator|->
name|pmksa
argument_list|,
name|candidate
operator|->
name|bssid
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|os_memcmp
argument_list|(
name|sm
operator|->
name|bssid
argument_list|,
name|candidate
operator|->
name|bssid
argument_list|,
name|ETH_ALEN
argument_list|)
operator|!=
literal|0
operator|&&
operator|(
name|p
operator|==
name|NULL
operator|||
name|p
operator|->
name|opportunistic
operator|)
condition|)
block|{
name|wpa_msg
argument_list|(
name|sm
operator|->
name|ctx
operator|->
name|msg_ctx
argument_list|,
name|MSG_DEBUG
argument_list|,
literal|"RSN: PMKSA "
literal|"candidate "
name|MACSTR
literal|" selected for pre-authentication"
argument_list|,
name|MAC2STR
argument_list|(
name|candidate
operator|->
name|bssid
argument_list|)
argument_list|)
expr_stmt|;
name|dl_list_del
argument_list|(
operator|&
name|candidate
operator|->
name|list
argument_list|)
expr_stmt|;
name|rsn_preauth_init
argument_list|(
name|sm
argument_list|,
name|candidate
operator|->
name|bssid
argument_list|,
name|sm
operator|->
name|eap_conf_ctx
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|candidate
argument_list|)
expr_stmt|;
return|return;
block|}
name|wpa_msg
argument_list|(
name|sm
operator|->
name|ctx
operator|->
name|msg_ctx
argument_list|,
name|MSG_DEBUG
argument_list|,
literal|"RSN: PMKSA candidate "
name|MACSTR
literal|" does not need pre-authentication anymore"
argument_list|,
name|MAC2STR
argument_list|(
name|candidate
operator|->
name|bssid
argument_list|)
argument_list|)
expr_stmt|;
comment|/* Some drivers (e.g., NDIS) expect to get notified about the 		 * PMKIDs again, so report the existing data now. */
if|if
condition|(
name|p
condition|)
block|{
name|wpa_sm_add_pmkid
argument_list|(
name|sm
argument_list|,
name|candidate
operator|->
name|bssid
argument_list|,
name|p
operator|->
name|pmkid
argument_list|)
expr_stmt|;
block|}
name|dl_list_del
argument_list|(
operator|&
name|candidate
operator|->
name|list
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|candidate
argument_list|)
expr_stmt|;
block|}
name|wpa_msg
argument_list|(
name|sm
operator|->
name|ctx
operator|->
name|msg_ctx
argument_list|,
name|MSG_DEBUG
argument_list|,
literal|"RSN: no more pending PMKSA "
literal|"candidates"
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/**  * pmksa_candidate_add - Add a new PMKSA candidate  * @sm: Pointer to WPA state machine data from wpa_sm_init()  * @bssid: BSSID (authenticator address) of the candidate  * @prio: Priority (the smaller number, the higher priority)  * @preauth: Whether the candidate AP advertises support for pre-authentication  *  * This function is used to add PMKSA candidates for RSN pre-authentication. It  * is called from scan result processing and from driver events for PMKSA  * candidates, i.e., EVENT_PMKID_CANDIDATE events to wpa_supplicant_event().  */
end_comment

begin_function
name|void
name|pmksa_candidate_add
parameter_list|(
name|struct
name|wpa_sm
modifier|*
name|sm
parameter_list|,
specifier|const
name|u8
modifier|*
name|bssid
parameter_list|,
name|int
name|prio
parameter_list|,
name|int
name|preauth
parameter_list|)
block|{
name|struct
name|rsn_pmksa_candidate
modifier|*
name|cand
decl_stmt|,
modifier|*
name|pos
decl_stmt|;
if|if
condition|(
name|sm
operator|->
name|network_ctx
operator|&&
name|sm
operator|->
name|proactive_key_caching
condition|)
name|pmksa_cache_get_opportunistic
argument_list|(
name|sm
operator|->
name|pmksa
argument_list|,
name|sm
operator|->
name|network_ctx
argument_list|,
name|bssid
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|preauth
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"RSN: Ignored PMKID candidate without "
literal|"preauth flag"
argument_list|)
expr_stmt|;
return|return;
block|}
comment|/* If BSSID already on candidate list, update the priority of the old 	 * entry. Do not override priority based on normal scan results. */
name|cand
operator|=
name|NULL
expr_stmt|;
name|dl_list_for_each
argument_list|(
argument|pos
argument_list|,
argument|&sm->pmksa_candidates
argument_list|,
argument|struct rsn_pmksa_candidate
argument_list|,
argument|list
argument_list|)
block|{
if|if
condition|(
name|os_memcmp
argument_list|(
name|pos
operator|->
name|bssid
argument_list|,
name|bssid
argument_list|,
name|ETH_ALEN
argument_list|)
operator|==
literal|0
condition|)
block|{
name|cand
operator|=
name|pos
expr_stmt|;
break|break;
block|}
block|}
if|if
condition|(
name|cand
condition|)
block|{
name|dl_list_del
argument_list|(
operator|&
name|cand
operator|->
name|list
argument_list|)
expr_stmt|;
if|if
condition|(
name|prio
operator|<
name|PMKID_CANDIDATE_PRIO_SCAN
condition|)
name|cand
operator|->
name|priority
operator|=
name|prio
expr_stmt|;
block|}
else|else
block|{
name|cand
operator|=
name|os_zalloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|cand
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|cand
operator|==
name|NULL
condition|)
return|return;
name|os_memcpy
argument_list|(
name|cand
operator|->
name|bssid
argument_list|,
name|bssid
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
name|cand
operator|->
name|priority
operator|=
name|prio
expr_stmt|;
block|}
comment|/* Add candidate to the list; order by increasing priority value. i.e., 	 * highest priority (smallest value) first. */
name|dl_list_for_each
argument_list|(
argument|pos
argument_list|,
argument|&sm->pmksa_candidates
argument_list|,
argument|struct rsn_pmksa_candidate
argument_list|,
argument|list
argument_list|)
block|{
if|if
condition|(
name|cand
operator|->
name|priority
operator|<=
name|pos
operator|->
name|priority
condition|)
block|{
if|if
condition|(
operator|!
name|pos
operator|->
name|list
operator|.
name|prev
condition|)
block|{
comment|/* 				 * This cannot really happen in pracrice since 				 * pos was fetched from the list and the prev 				 * pointer must be set. It looks like clang 				 * static analyzer gets confused with the 				 * dl_list_del(&cand->list) call above and ends 				 * up assuming pos->list.prev could be NULL. 				 */
name|os_free
argument_list|(
name|cand
argument_list|)
expr_stmt|;
return|return;
block|}
name|dl_list_add
argument_list|(
name|pos
operator|->
name|list
operator|.
name|prev
argument_list|,
operator|&
name|cand
operator|->
name|list
argument_list|)
expr_stmt|;
name|cand
operator|=
name|NULL
expr_stmt|;
break|break;
block|}
block|}
if|if
condition|(
name|cand
condition|)
name|dl_list_add_tail
argument_list|(
operator|&
name|sm
operator|->
name|pmksa_candidates
argument_list|,
operator|&
name|cand
operator|->
name|list
argument_list|)
expr_stmt|;
name|wpa_msg
argument_list|(
name|sm
operator|->
name|ctx
operator|->
name|msg_ctx
argument_list|,
name|MSG_DEBUG
argument_list|,
literal|"RSN: added PMKSA cache "
literal|"candidate "
name|MACSTR
literal|" prio %d"
argument_list|,
name|MAC2STR
argument_list|(
name|bssid
argument_list|)
argument_list|,
name|prio
argument_list|)
expr_stmt|;
name|rsn_preauth_candidate_process
argument_list|(
name|sm
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* TODO: schedule periodic scans if current AP supports preauth */
end_comment

begin_comment
comment|/**  * rsn_preauth_scan_results - Start processing scan results for canditates  * @sm: Pointer to WPA state machine data from wpa_sm_init()  * Returns: 0 if ready to process results or -1 to skip processing  *  * This functions is used to notify RSN code about start of new scan results  * processing. The actual scan results will be provided by calling  * rsn_preauth_scan_result() for each BSS if this function returned 0.  */
end_comment

begin_function
name|int
name|rsn_preauth_scan_results
parameter_list|(
name|struct
name|wpa_sm
modifier|*
name|sm
parameter_list|)
block|{
if|if
condition|(
name|sm
operator|->
name|ssid_len
operator|==
literal|0
condition|)
return|return
operator|-
literal|1
return|;
comment|/* 	 * TODO: is it ok to free all candidates? What about the entries 	 * received from EVENT_PMKID_CANDIDATE? 	 */
name|pmksa_candidate_free
argument_list|(
name|sm
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/**  * rsn_preauth_scan_result - Processing scan result for PMKSA canditates  * @sm: Pointer to WPA state machine data from wpa_sm_init()  *  * Add all suitable APs (Authenticators) from scan results into PMKSA  * candidate list.  */
end_comment

begin_function
name|void
name|rsn_preauth_scan_result
parameter_list|(
name|struct
name|wpa_sm
modifier|*
name|sm
parameter_list|,
specifier|const
name|u8
modifier|*
name|bssid
parameter_list|,
specifier|const
name|u8
modifier|*
name|ssid
parameter_list|,
specifier|const
name|u8
modifier|*
name|rsn
parameter_list|)
block|{
name|struct
name|wpa_ie_data
name|ie
decl_stmt|;
name|struct
name|rsn_pmksa_cache_entry
modifier|*
name|pmksa
decl_stmt|;
if|if
condition|(
name|ssid
index|[
literal|1
index|]
operator|!=
name|sm
operator|->
name|ssid_len
operator|||
name|os_memcmp
argument_list|(
name|ssid
operator|+
literal|2
argument_list|,
name|sm
operator|->
name|ssid
argument_list|,
name|sm
operator|->
name|ssid_len
argument_list|)
operator|!=
literal|0
condition|)
return|return;
comment|/* Not for the current SSID */
if|if
condition|(
name|os_memcmp
argument_list|(
name|bssid
argument_list|,
name|sm
operator|->
name|bssid
argument_list|,
name|ETH_ALEN
argument_list|)
operator|==
literal|0
condition|)
return|return;
comment|/* Ignore current AP */
if|if
condition|(
name|wpa_parse_wpa_ie
argument_list|(
name|rsn
argument_list|,
literal|2
operator|+
name|rsn
index|[
literal|1
index|]
argument_list|,
operator|&
name|ie
argument_list|)
condition|)
return|return;
name|pmksa
operator|=
name|pmksa_cache_get
argument_list|(
name|sm
operator|->
name|pmksa
argument_list|,
name|bssid
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|pmksa
operator|&&
operator|(
operator|!
name|pmksa
operator|->
name|opportunistic
operator|||
operator|!
operator|(
name|ie
operator|.
name|capabilities
operator|&
name|WPA_CAPABILITY_PREAUTH
operator|)
operator|)
condition|)
return|return;
comment|/* Give less priority to candidates found from normal scan results. */
name|pmksa_candidate_add
argument_list|(
name|sm
argument_list|,
name|bssid
argument_list|,
name|PMKID_CANDIDATE_PRIO_SCAN
argument_list|,
name|ie
operator|.
name|capabilities
operator|&
name|WPA_CAPABILITY_PREAUTH
argument_list|)
expr_stmt|;
block|}
end_function

begin_ifdef
ifdef|#
directive|ifdef
name|CONFIG_CTRL_IFACE
end_ifdef

begin_comment
comment|/**  * rsn_preauth_get_status - Get pre-authentication status  * @sm: Pointer to WPA state machine data from wpa_sm_init()  * @buf: Buffer for status information  * @buflen: Maximum buffer length  * @verbose: Whether to include verbose status information  * Returns: Number of bytes written to buf.  *  * Query WPA2 pre-authentication for status information. This function fills in  * a text area with current status information. If the buffer (buf) is not  * large enough, status information will be truncated to fit the buffer.  */
end_comment

begin_function
name|int
name|rsn_preauth_get_status
parameter_list|(
name|struct
name|wpa_sm
modifier|*
name|sm
parameter_list|,
name|char
modifier|*
name|buf
parameter_list|,
name|size_t
name|buflen
parameter_list|,
name|int
name|verbose
parameter_list|)
block|{
name|char
modifier|*
name|pos
init|=
name|buf
decl_stmt|,
modifier|*
name|end
init|=
name|buf
operator|+
name|buflen
decl_stmt|;
name|int
name|res
decl_stmt|,
name|ret
decl_stmt|;
if|if
condition|(
name|sm
operator|->
name|preauth_eapol
condition|)
block|{
name|ret
operator|=
name|os_snprintf
argument_list|(
name|pos
argument_list|,
name|end
operator|-
name|pos
argument_list|,
literal|"Pre-authentication "
literal|"EAPOL state machines:\n"
argument_list|)
expr_stmt|;
if|if
condition|(
name|os_snprintf_error
argument_list|(
name|end
operator|-
name|pos
argument_list|,
name|ret
argument_list|)
condition|)
return|return
name|pos
operator|-
name|buf
return|;
name|pos
operator|+=
name|ret
expr_stmt|;
name|res
operator|=
name|eapol_sm_get_status
argument_list|(
name|sm
operator|->
name|preauth_eapol
argument_list|,
name|pos
argument_list|,
name|end
operator|-
name|pos
argument_list|,
name|verbose
argument_list|)
expr_stmt|;
if|if
condition|(
name|res
operator|>=
literal|0
condition|)
name|pos
operator|+=
name|res
expr_stmt|;
block|}
return|return
name|pos
operator|-
name|buf
return|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* CONFIG_CTRL_IFACE */
end_comment

begin_comment
comment|/**  * rsn_preauth_in_progress - Verify whether pre-authentication is in progress  * @sm: Pointer to WPA state machine data from wpa_sm_init()  */
end_comment

begin_function
name|int
name|rsn_preauth_in_progress
parameter_list|(
name|struct
name|wpa_sm
modifier|*
name|sm
parameter_list|)
block|{
return|return
name|sm
operator|->
name|preauth_eapol
operator|!=
name|NULL
return|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* IEEE8021X_EAPOL */
end_comment

end_unit


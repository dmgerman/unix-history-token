begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * WPA Supplicant - PeerKey for Direct Link Setup (DLS)  * Copyright (c) 2006-2008, Jouni Malinen<j@w1.fi>  *  * This program is free software; you can redistribute it and/or modify  * it under the terms of the GNU General Public License version 2 as  * published by the Free Software Foundation.  *  * Alternatively, this software may be distributed under the terms of BSD  * license.  *  * See README and COPYING for more details.  */
end_comment

begin_include
include|#
directive|include
file|"includes.h"
end_include

begin_ifdef
ifdef|#
directive|ifdef
name|CONFIG_PEERKEY
end_ifdef

begin_include
include|#
directive|include
file|"common.h"
end_include

begin_include
include|#
directive|include
file|"sha1.h"
end_include

begin_include
include|#
directive|include
file|"sha256.h"
end_include

begin_include
include|#
directive|include
file|"eloop.h"
end_include

begin_include
include|#
directive|include
file|"wpa.h"
end_include

begin_include
include|#
directive|include
file|"wpa_i.h"
end_include

begin_include
include|#
directive|include
file|"wpa_ie.h"
end_include

begin_include
include|#
directive|include
file|"ieee802_11_defs.h"
end_include

begin_include
include|#
directive|include
file|"peerkey.h"
end_include

begin_function
specifier|static
name|u8
modifier|*
name|wpa_add_ie
parameter_list|(
name|u8
modifier|*
name|pos
parameter_list|,
specifier|const
name|u8
modifier|*
name|ie
parameter_list|,
name|size_t
name|ie_len
parameter_list|)
block|{
name|os_memcpy
argument_list|(
name|pos
argument_list|,
name|ie
argument_list|,
name|ie_len
argument_list|)
expr_stmt|;
return|return
name|pos
operator|+
name|ie_len
return|;
block|}
end_function

begin_function
specifier|static
name|u8
modifier|*
name|wpa_add_kde
parameter_list|(
name|u8
modifier|*
name|pos
parameter_list|,
name|u32
name|kde
parameter_list|,
specifier|const
name|u8
modifier|*
name|data
parameter_list|,
name|size_t
name|data_len
parameter_list|)
block|{
operator|*
name|pos
operator|++
operator|=
name|WLAN_EID_VENDOR_SPECIFIC
expr_stmt|;
operator|*
name|pos
operator|++
operator|=
name|RSN_SELECTOR_LEN
operator|+
name|data_len
expr_stmt|;
name|RSN_SELECTOR_PUT
argument_list|(
name|pos
argument_list|,
name|kde
argument_list|)
expr_stmt|;
name|pos
operator|+=
name|RSN_SELECTOR_LEN
expr_stmt|;
name|os_memcpy
argument_list|(
name|pos
argument_list|,
name|data
argument_list|,
name|data_len
argument_list|)
expr_stmt|;
name|pos
operator|+=
name|data_len
expr_stmt|;
return|return
name|pos
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|wpa_supplicant_smk_timeout
parameter_list|(
name|void
modifier|*
name|eloop_ctx
parameter_list|,
name|void
modifier|*
name|timeout_ctx
parameter_list|)
block|{
if|#
directive|if
literal|0
block|struct wpa_sm *sm = eloop_ctx; 	struct wpa_peerkey *peerkey = timeout_ctx;
endif|#
directive|endif
comment|/* TODO: time out SMK and any STK that was generated using this SMK */
block|}
end_function

begin_function
specifier|static
name|void
name|wpa_supplicant_peerkey_free
parameter_list|(
name|struct
name|wpa_sm
modifier|*
name|sm
parameter_list|,
name|struct
name|wpa_peerkey
modifier|*
name|peerkey
parameter_list|)
block|{
name|eloop_cancel_timeout
argument_list|(
name|wpa_supplicant_smk_timeout
argument_list|,
name|sm
argument_list|,
name|peerkey
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|peerkey
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|wpa_supplicant_send_smk_error
parameter_list|(
name|struct
name|wpa_sm
modifier|*
name|sm
parameter_list|,
specifier|const
name|u8
modifier|*
name|dst
parameter_list|,
specifier|const
name|u8
modifier|*
name|peer
parameter_list|,
name|u16
name|mui
parameter_list|,
name|u16
name|error_type
parameter_list|,
name|int
name|ver
parameter_list|)
block|{
name|size_t
name|rlen
decl_stmt|;
name|struct
name|wpa_eapol_key
modifier|*
name|err
decl_stmt|;
name|struct
name|rsn_error_kde
name|error
decl_stmt|;
name|u8
modifier|*
name|rbuf
decl_stmt|,
modifier|*
name|pos
decl_stmt|;
name|size_t
name|kde_len
decl_stmt|;
name|u16
name|key_info
decl_stmt|;
name|kde_len
operator|=
literal|2
operator|+
name|RSN_SELECTOR_LEN
operator|+
sizeof|sizeof
argument_list|(
name|error
argument_list|)
expr_stmt|;
if|if
condition|(
name|peer
condition|)
name|kde_len
operator|+=
literal|2
operator|+
name|RSN_SELECTOR_LEN
operator|+
name|ETH_ALEN
expr_stmt|;
name|rbuf
operator|=
name|wpa_sm_alloc_eapol
argument_list|(
name|sm
argument_list|,
name|IEEE802_1X_TYPE_EAPOL_KEY
argument_list|,
name|NULL
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|err
argument_list|)
operator|+
name|kde_len
argument_list|,
operator|&
name|rlen
argument_list|,
operator|(
name|void
operator|*
operator|)
operator|&
name|err
argument_list|)
expr_stmt|;
if|if
condition|(
name|rbuf
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
name|err
operator|->
name|type
operator|=
name|EAPOL_KEY_TYPE_RSN
expr_stmt|;
name|key_info
operator|=
name|ver
operator||
name|WPA_KEY_INFO_SMK_MESSAGE
operator||
name|WPA_KEY_INFO_MIC
operator||
name|WPA_KEY_INFO_SECURE
operator||
name|WPA_KEY_INFO_ERROR
operator||
name|WPA_KEY_INFO_REQUEST
expr_stmt|;
name|WPA_PUT_BE16
argument_list|(
name|err
operator|->
name|key_info
argument_list|,
name|key_info
argument_list|)
expr_stmt|;
name|WPA_PUT_BE16
argument_list|(
name|err
operator|->
name|key_length
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|os_memcpy
argument_list|(
name|err
operator|->
name|replay_counter
argument_list|,
name|sm
operator|->
name|request_counter
argument_list|,
name|WPA_REPLAY_COUNTER_LEN
argument_list|)
expr_stmt|;
name|inc_byte_array
argument_list|(
name|sm
operator|->
name|request_counter
argument_list|,
name|WPA_REPLAY_COUNTER_LEN
argument_list|)
expr_stmt|;
name|WPA_PUT_BE16
argument_list|(
name|err
operator|->
name|key_data_length
argument_list|,
operator|(
name|u16
operator|)
name|kde_len
argument_list|)
expr_stmt|;
name|pos
operator|=
operator|(
name|u8
operator|*
operator|)
operator|(
name|err
operator|+
literal|1
operator|)
expr_stmt|;
if|if
condition|(
name|peer
condition|)
block|{
comment|/* Peer MAC Address KDE */
name|pos
operator|=
name|wpa_add_kde
argument_list|(
name|pos
argument_list|,
name|RSN_KEY_DATA_MAC_ADDR
argument_list|,
name|peer
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
block|}
comment|/* Error KDE */
name|error
operator|.
name|mui
operator|=
name|host_to_be16
argument_list|(
name|mui
argument_list|)
expr_stmt|;
name|error
operator|.
name|error_type
operator|=
name|host_to_be16
argument_list|(
name|error_type
argument_list|)
expr_stmt|;
name|wpa_add_kde
argument_list|(
name|pos
argument_list|,
name|RSN_KEY_DATA_ERROR
argument_list|,
operator|(
name|u8
operator|*
operator|)
operator|&
name|error
argument_list|,
sizeof|sizeof
argument_list|(
name|error
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|peer
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"RSN: Sending EAPOL-Key SMK Error (peer "
name|MACSTR
literal|" mui %d error_type %d)"
argument_list|,
name|MAC2STR
argument_list|(
name|peer
argument_list|)
argument_list|,
name|mui
argument_list|,
name|error_type
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"RSN: Sending EAPOL-Key SMK Error "
literal|"(mui %d error_type %d)"
argument_list|,
name|mui
argument_list|,
name|error_type
argument_list|)
expr_stmt|;
block|}
name|wpa_eapol_key_send
argument_list|(
name|sm
argument_list|,
name|sm
operator|->
name|ptk
operator|.
name|kck
argument_list|,
name|ver
argument_list|,
name|dst
argument_list|,
name|ETH_P_EAPOL
argument_list|,
name|rbuf
argument_list|,
name|rlen
argument_list|,
name|err
operator|->
name|key_mic
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|wpa_supplicant_send_smk_m3
parameter_list|(
name|struct
name|wpa_sm
modifier|*
name|sm
parameter_list|,
specifier|const
name|unsigned
name|char
modifier|*
name|src_addr
parameter_list|,
specifier|const
name|struct
name|wpa_eapol_key
modifier|*
name|key
parameter_list|,
name|int
name|ver
parameter_list|,
name|struct
name|wpa_peerkey
modifier|*
name|peerkey
parameter_list|)
block|{
name|size_t
name|rlen
decl_stmt|;
name|struct
name|wpa_eapol_key
modifier|*
name|reply
decl_stmt|;
name|u8
modifier|*
name|rbuf
decl_stmt|,
modifier|*
name|pos
decl_stmt|;
name|size_t
name|kde_len
decl_stmt|;
name|u16
name|key_info
decl_stmt|;
comment|/* KDEs: Peer RSN IE, Initiator MAC Address, Initiator Nonce */
name|kde_len
operator|=
name|peerkey
operator|->
name|rsnie_p_len
operator|+
literal|2
operator|+
name|RSN_SELECTOR_LEN
operator|+
name|ETH_ALEN
operator|+
literal|2
operator|+
name|RSN_SELECTOR_LEN
operator|+
name|WPA_NONCE_LEN
expr_stmt|;
name|rbuf
operator|=
name|wpa_sm_alloc_eapol
argument_list|(
name|sm
argument_list|,
name|IEEE802_1X_TYPE_EAPOL_KEY
argument_list|,
name|NULL
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|reply
argument_list|)
operator|+
name|kde_len
argument_list|,
operator|&
name|rlen
argument_list|,
operator|(
name|void
operator|*
operator|)
operator|&
name|reply
argument_list|)
expr_stmt|;
if|if
condition|(
name|rbuf
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
name|reply
operator|->
name|type
operator|=
name|EAPOL_KEY_TYPE_RSN
expr_stmt|;
name|key_info
operator|=
name|ver
operator||
name|WPA_KEY_INFO_SMK_MESSAGE
operator||
name|WPA_KEY_INFO_MIC
operator||
name|WPA_KEY_INFO_SECURE
expr_stmt|;
name|WPA_PUT_BE16
argument_list|(
name|reply
operator|->
name|key_info
argument_list|,
name|key_info
argument_list|)
expr_stmt|;
name|WPA_PUT_BE16
argument_list|(
name|reply
operator|->
name|key_length
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|os_memcpy
argument_list|(
name|reply
operator|->
name|replay_counter
argument_list|,
name|key
operator|->
name|replay_counter
argument_list|,
name|WPA_REPLAY_COUNTER_LEN
argument_list|)
expr_stmt|;
name|os_memcpy
argument_list|(
name|reply
operator|->
name|key_nonce
argument_list|,
name|peerkey
operator|->
name|pnonce
argument_list|,
name|WPA_NONCE_LEN
argument_list|)
expr_stmt|;
name|WPA_PUT_BE16
argument_list|(
name|reply
operator|->
name|key_data_length
argument_list|,
operator|(
name|u16
operator|)
name|kde_len
argument_list|)
expr_stmt|;
name|pos
operator|=
operator|(
name|u8
operator|*
operator|)
operator|(
name|reply
operator|+
literal|1
operator|)
expr_stmt|;
comment|/* Peer RSN IE */
name|pos
operator|=
name|wpa_add_ie
argument_list|(
name|pos
argument_list|,
name|peerkey
operator|->
name|rsnie_p
argument_list|,
name|peerkey
operator|->
name|rsnie_p_len
argument_list|)
expr_stmt|;
comment|/* Initiator MAC Address KDE */
name|pos
operator|=
name|wpa_add_kde
argument_list|(
name|pos
argument_list|,
name|RSN_KEY_DATA_MAC_ADDR
argument_list|,
name|peerkey
operator|->
name|addr
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
comment|/* Initiator Nonce */
name|wpa_add_kde
argument_list|(
name|pos
argument_list|,
name|RSN_KEY_DATA_NONCE
argument_list|,
name|peerkey
operator|->
name|inonce
argument_list|,
name|WPA_NONCE_LEN
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"RSN: Sending EAPOL-Key SMK M3"
argument_list|)
expr_stmt|;
name|wpa_eapol_key_send
argument_list|(
name|sm
argument_list|,
name|sm
operator|->
name|ptk
operator|.
name|kck
argument_list|,
name|ver
argument_list|,
name|src_addr
argument_list|,
name|ETH_P_EAPOL
argument_list|,
name|rbuf
argument_list|,
name|rlen
argument_list|,
name|reply
operator|->
name|key_mic
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|wpa_supplicant_process_smk_m2
parameter_list|(
name|struct
name|wpa_sm
modifier|*
name|sm
parameter_list|,
specifier|const
name|unsigned
name|char
modifier|*
name|src_addr
parameter_list|,
specifier|const
name|struct
name|wpa_eapol_key
modifier|*
name|key
parameter_list|,
name|size_t
name|extra_len
parameter_list|,
name|int
name|ver
parameter_list|)
block|{
name|struct
name|wpa_peerkey
modifier|*
name|peerkey
decl_stmt|;
name|struct
name|wpa_eapol_ie_parse
name|kde
decl_stmt|;
name|struct
name|wpa_ie_data
name|ie
decl_stmt|;
name|int
name|cipher
decl_stmt|;
name|struct
name|rsn_ie_hdr
modifier|*
name|hdr
decl_stmt|;
name|u8
modifier|*
name|pos
decl_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"RSN: Received SMK M2"
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|sm
operator|->
name|peerkey_enabled
operator|||
name|sm
operator|->
name|proto
operator|!=
name|WPA_PROTO_RSN
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"RSN: SMK handshake not allowed for "
literal|"the current network"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
if|if
condition|(
name|wpa_supplicant_parse_ies
argument_list|(
operator|(
specifier|const
name|u8
operator|*
operator|)
operator|(
name|key
operator|+
literal|1
operator|)
argument_list|,
name|extra_len
argument_list|,
operator|&
name|kde
argument_list|)
operator|<
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"RSN: Failed to parse KDEs in SMK M2"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
if|if
condition|(
name|kde
operator|.
name|rsn_ie
operator|==
name|NULL
operator|||
name|kde
operator|.
name|mac_addr
operator|==
name|NULL
operator|||
name|kde
operator|.
name|mac_addr_len
operator|<
name|ETH_ALEN
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"RSN: No RSN IE or MAC address KDE in "
literal|"SMK M2"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"RSN: SMK M2 - SMK initiator "
name|MACSTR
argument_list|,
name|MAC2STR
argument_list|(
name|kde
operator|.
name|mac_addr
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|kde
operator|.
name|rsn_ie_len
operator|>
name|PEERKEY_MAX_IE_LEN
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"RSN: Too long Initiator RSN IE in SMK "
literal|"M2"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
if|if
condition|(
name|wpa_parse_wpa_ie_rsn
argument_list|(
name|kde
operator|.
name|rsn_ie
argument_list|,
name|kde
operator|.
name|rsn_ie_len
argument_list|,
operator|&
name|ie
argument_list|)
operator|<
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"RSN: Failed to parse RSN IE in SMK M2"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|cipher
operator|=
name|ie
operator|.
name|pairwise_cipher
operator|&
name|sm
operator|->
name|allowed_pairwise_cipher
expr_stmt|;
if|if
condition|(
name|cipher
operator|&
name|WPA_CIPHER_CCMP
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"RSN: Using CCMP for PeerKey"
argument_list|)
expr_stmt|;
name|cipher
operator|=
name|WPA_CIPHER_CCMP
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|cipher
operator|&
name|WPA_CIPHER_TKIP
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"RSN: Using TKIP for PeerKey"
argument_list|)
expr_stmt|;
name|cipher
operator|=
name|WPA_CIPHER_TKIP
expr_stmt|;
block|}
else|else
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"RSN: No acceptable cipher in SMK M2"
argument_list|)
expr_stmt|;
name|wpa_supplicant_send_smk_error
argument_list|(
name|sm
argument_list|,
name|src_addr
argument_list|,
name|kde
operator|.
name|mac_addr
argument_list|,
name|STK_MUI_SMK
argument_list|,
name|STK_ERR_CPHR_NS
argument_list|,
name|ver
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
comment|/* TODO: find existing entry and if found, use that instead of adding 	 * a new one; how to handle the case where both ends initiate at the 	 * same time? */
name|peerkey
operator|=
name|os_zalloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|peerkey
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|peerkey
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
name|os_memcpy
argument_list|(
name|peerkey
operator|->
name|addr
argument_list|,
name|kde
operator|.
name|mac_addr
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
name|os_memcpy
argument_list|(
name|peerkey
operator|->
name|inonce
argument_list|,
name|key
operator|->
name|key_nonce
argument_list|,
name|WPA_NONCE_LEN
argument_list|)
expr_stmt|;
name|os_memcpy
argument_list|(
name|peerkey
operator|->
name|rsnie_i
argument_list|,
name|kde
operator|.
name|rsn_ie
argument_list|,
name|kde
operator|.
name|rsn_ie_len
argument_list|)
expr_stmt|;
name|peerkey
operator|->
name|rsnie_i_len
operator|=
name|kde
operator|.
name|rsn_ie_len
expr_stmt|;
name|peerkey
operator|->
name|cipher
operator|=
name|cipher
expr_stmt|;
ifdef|#
directive|ifdef
name|CONFIG_IEEE80211W
if|if
condition|(
name|ie
operator|.
name|key_mgmt
operator|&
operator|(
name|WPA_KEY_MGMT_IEEE8021X_SHA256
operator||
name|WPA_KEY_MGMT_PSK_SHA256
operator|)
condition|)
name|peerkey
operator|->
name|use_sha256
operator|=
literal|1
expr_stmt|;
endif|#
directive|endif
comment|/* CONFIG_IEEE80211W */
if|if
condition|(
name|os_get_random
argument_list|(
name|peerkey
operator|->
name|pnonce
argument_list|,
name|WPA_NONCE_LEN
argument_list|)
condition|)
block|{
name|wpa_msg
argument_list|(
name|sm
operator|->
name|ctx
operator|->
name|ctx
argument_list|,
name|MSG_WARNING
argument_list|,
literal|"WPA: Failed to get random data for PNonce"
argument_list|)
expr_stmt|;
name|wpa_supplicant_peerkey_free
argument_list|(
name|sm
argument_list|,
name|peerkey
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|hdr
operator|=
operator|(
expr|struct
name|rsn_ie_hdr
operator|*
operator|)
name|peerkey
operator|->
name|rsnie_p
expr_stmt|;
name|hdr
operator|->
name|elem_id
operator|=
name|WLAN_EID_RSN
expr_stmt|;
name|WPA_PUT_LE16
argument_list|(
name|hdr
operator|->
name|version
argument_list|,
name|RSN_VERSION
argument_list|)
expr_stmt|;
name|pos
operator|=
operator|(
name|u8
operator|*
operator|)
operator|(
name|hdr
operator|+
literal|1
operator|)
expr_stmt|;
comment|/* Group Suite can be anything for SMK RSN IE; receiver will just 	 * ignore it. */
name|RSN_SELECTOR_PUT
argument_list|(
name|pos
argument_list|,
name|RSN_CIPHER_SUITE_CCMP
argument_list|)
expr_stmt|;
name|pos
operator|+=
name|RSN_SELECTOR_LEN
expr_stmt|;
comment|/* Include only the selected cipher in pairwise cipher suite */
name|WPA_PUT_LE16
argument_list|(
name|pos
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|pos
operator|+=
literal|2
expr_stmt|;
if|if
condition|(
name|cipher
operator|==
name|WPA_CIPHER_CCMP
condition|)
name|RSN_SELECTOR_PUT
argument_list|(
name|pos
argument_list|,
name|RSN_CIPHER_SUITE_CCMP
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|cipher
operator|==
name|WPA_CIPHER_TKIP
condition|)
name|RSN_SELECTOR_PUT
argument_list|(
name|pos
argument_list|,
name|RSN_CIPHER_SUITE_TKIP
argument_list|)
expr_stmt|;
name|pos
operator|+=
name|RSN_SELECTOR_LEN
expr_stmt|;
name|hdr
operator|->
name|len
operator|=
operator|(
name|pos
operator|-
name|peerkey
operator|->
name|rsnie_p
operator|)
operator|-
literal|2
expr_stmt|;
name|peerkey
operator|->
name|rsnie_p_len
operator|=
name|pos
operator|-
name|peerkey
operator|->
name|rsnie_p
expr_stmt|;
name|wpa_hexdump
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPA: RSN IE for SMK handshake"
argument_list|,
name|peerkey
operator|->
name|rsnie_p
argument_list|,
name|peerkey
operator|->
name|rsnie_p_len
argument_list|)
expr_stmt|;
name|wpa_supplicant_send_smk_m3
argument_list|(
name|sm
argument_list|,
name|src_addr
argument_list|,
name|key
argument_list|,
name|ver
argument_list|,
name|peerkey
argument_list|)
expr_stmt|;
name|peerkey
operator|->
name|next
operator|=
name|sm
operator|->
name|peerkey
expr_stmt|;
name|sm
operator|->
name|peerkey
operator|=
name|peerkey
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/**  * rsn_smkid - Derive SMK identifier  * @smk: Station master key (32 bytes)  * @pnonce: Peer Nonce  * @mac_p: Peer MAC address  * @inonce: Initiator Nonce  * @mac_i: Initiator MAC address  * @use_sha256: Whether to use SHA256-based KDF  *  * 8.5.1.4 Station to station (STK) key hierarchy  * SMKID = HMAC-SHA1-128(SMK, "SMK Name" || PNonce || MAC_P || INonce || MAC_I)  */
end_comment

begin_function
specifier|static
name|void
name|rsn_smkid
parameter_list|(
specifier|const
name|u8
modifier|*
name|smk
parameter_list|,
specifier|const
name|u8
modifier|*
name|pnonce
parameter_list|,
specifier|const
name|u8
modifier|*
name|mac_p
parameter_list|,
specifier|const
name|u8
modifier|*
name|inonce
parameter_list|,
specifier|const
name|u8
modifier|*
name|mac_i
parameter_list|,
name|u8
modifier|*
name|smkid
parameter_list|,
name|int
name|use_sha256
parameter_list|)
block|{
name|char
modifier|*
name|title
init|=
literal|"SMK Name"
decl_stmt|;
specifier|const
name|u8
modifier|*
name|addr
index|[
literal|5
index|]
decl_stmt|;
specifier|const
name|size_t
name|len
index|[
literal|5
index|]
init|=
block|{
literal|8
block|,
name|WPA_NONCE_LEN
block|,
name|ETH_ALEN
block|,
name|WPA_NONCE_LEN
block|,
name|ETH_ALEN
block|}
decl_stmt|;
name|unsigned
name|char
name|hash
index|[
name|SHA256_MAC_LEN
index|]
decl_stmt|;
name|addr
index|[
literal|0
index|]
operator|=
operator|(
name|u8
operator|*
operator|)
name|title
expr_stmt|;
name|addr
index|[
literal|1
index|]
operator|=
name|pnonce
expr_stmt|;
name|addr
index|[
literal|2
index|]
operator|=
name|mac_p
expr_stmt|;
name|addr
index|[
literal|3
index|]
operator|=
name|inonce
expr_stmt|;
name|addr
index|[
literal|4
index|]
operator|=
name|mac_i
expr_stmt|;
ifdef|#
directive|ifdef
name|CONFIG_IEEE80211W
if|if
condition|(
name|use_sha256
condition|)
name|hmac_sha256_vector
argument_list|(
name|smk
argument_list|,
name|PMK_LEN
argument_list|,
literal|5
argument_list|,
name|addr
argument_list|,
name|len
argument_list|,
name|hash
argument_list|)
expr_stmt|;
else|else
endif|#
directive|endif
comment|/* CONFIG_IEEE80211W */
name|hmac_sha1_vector
argument_list|(
name|smk
argument_list|,
name|PMK_LEN
argument_list|,
literal|5
argument_list|,
name|addr
argument_list|,
name|len
argument_list|,
name|hash
argument_list|)
expr_stmt|;
name|os_memcpy
argument_list|(
name|smkid
argument_list|,
name|hash
argument_list|,
name|PMKID_LEN
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|wpa_supplicant_send_stk_1_of_4
parameter_list|(
name|struct
name|wpa_sm
modifier|*
name|sm
parameter_list|,
name|struct
name|wpa_peerkey
modifier|*
name|peerkey
parameter_list|)
block|{
name|size_t
name|mlen
decl_stmt|;
name|struct
name|wpa_eapol_key
modifier|*
name|msg
decl_stmt|;
name|u8
modifier|*
name|mbuf
decl_stmt|;
name|size_t
name|kde_len
decl_stmt|;
name|u16
name|key_info
decl_stmt|,
name|ver
decl_stmt|;
name|kde_len
operator|=
literal|2
operator|+
name|RSN_SELECTOR_LEN
operator|+
name|PMKID_LEN
expr_stmt|;
name|mbuf
operator|=
name|wpa_sm_alloc_eapol
argument_list|(
name|sm
argument_list|,
name|IEEE802_1X_TYPE_EAPOL_KEY
argument_list|,
name|NULL
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|msg
argument_list|)
operator|+
name|kde_len
argument_list|,
operator|&
name|mlen
argument_list|,
operator|(
name|void
operator|*
operator|)
operator|&
name|msg
argument_list|)
expr_stmt|;
if|if
condition|(
name|mbuf
operator|==
name|NULL
condition|)
return|return;
name|msg
operator|->
name|type
operator|=
name|EAPOL_KEY_TYPE_RSN
expr_stmt|;
if|if
condition|(
name|peerkey
operator|->
name|cipher
operator|==
name|WPA_CIPHER_CCMP
condition|)
name|ver
operator|=
name|WPA_KEY_INFO_TYPE_HMAC_SHA1_AES
expr_stmt|;
else|else
name|ver
operator|=
name|WPA_KEY_INFO_TYPE_HMAC_MD5_RC4
expr_stmt|;
name|key_info
operator|=
name|ver
operator||
name|WPA_KEY_INFO_KEY_TYPE
operator||
name|WPA_KEY_INFO_ACK
expr_stmt|;
name|WPA_PUT_BE16
argument_list|(
name|msg
operator|->
name|key_info
argument_list|,
name|key_info
argument_list|)
expr_stmt|;
if|if
condition|(
name|peerkey
operator|->
name|cipher
operator|==
name|WPA_CIPHER_CCMP
condition|)
name|WPA_PUT_BE16
argument_list|(
name|msg
operator|->
name|key_length
argument_list|,
literal|16
argument_list|)
expr_stmt|;
else|else
name|WPA_PUT_BE16
argument_list|(
name|msg
operator|->
name|key_length
argument_list|,
literal|32
argument_list|)
expr_stmt|;
name|os_memcpy
argument_list|(
name|msg
operator|->
name|replay_counter
argument_list|,
name|peerkey
operator|->
name|replay_counter
argument_list|,
name|WPA_REPLAY_COUNTER_LEN
argument_list|)
expr_stmt|;
name|inc_byte_array
argument_list|(
name|peerkey
operator|->
name|replay_counter
argument_list|,
name|WPA_REPLAY_COUNTER_LEN
argument_list|)
expr_stmt|;
name|WPA_PUT_BE16
argument_list|(
name|msg
operator|->
name|key_data_length
argument_list|,
name|kde_len
argument_list|)
expr_stmt|;
name|wpa_add_kde
argument_list|(
operator|(
name|u8
operator|*
operator|)
operator|(
name|msg
operator|+
literal|1
operator|)
argument_list|,
name|RSN_KEY_DATA_PMKID
argument_list|,
name|peerkey
operator|->
name|smkid
argument_list|,
name|PMKID_LEN
argument_list|)
expr_stmt|;
if|if
condition|(
name|os_get_random
argument_list|(
name|peerkey
operator|->
name|inonce
argument_list|,
name|WPA_NONCE_LEN
argument_list|)
condition|)
block|{
name|wpa_msg
argument_list|(
name|sm
operator|->
name|ctx
operator|->
name|ctx
argument_list|,
name|MSG_WARNING
argument_list|,
literal|"RSN: Failed to get random data for INonce (STK)"
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|mbuf
argument_list|)
expr_stmt|;
return|return;
block|}
name|wpa_hexdump
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"RSN: INonce for STK 4-Way Handshake"
argument_list|,
name|peerkey
operator|->
name|inonce
argument_list|,
name|WPA_NONCE_LEN
argument_list|)
expr_stmt|;
name|os_memcpy
argument_list|(
name|msg
operator|->
name|key_nonce
argument_list|,
name|peerkey
operator|->
name|inonce
argument_list|,
name|WPA_NONCE_LEN
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"RSN: Sending EAPOL-Key STK 1/4 to "
name|MACSTR
argument_list|,
name|MAC2STR
argument_list|(
name|peerkey
operator|->
name|addr
argument_list|)
argument_list|)
expr_stmt|;
name|wpa_eapol_key_send
argument_list|(
name|sm
argument_list|,
name|NULL
argument_list|,
name|ver
argument_list|,
name|peerkey
operator|->
name|addr
argument_list|,
name|ETH_P_EAPOL
argument_list|,
name|mbuf
argument_list|,
name|mlen
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|wpa_supplicant_send_stk_3_of_4
parameter_list|(
name|struct
name|wpa_sm
modifier|*
name|sm
parameter_list|,
name|struct
name|wpa_peerkey
modifier|*
name|peerkey
parameter_list|)
block|{
name|size_t
name|mlen
decl_stmt|;
name|struct
name|wpa_eapol_key
modifier|*
name|msg
decl_stmt|;
name|u8
modifier|*
name|mbuf
decl_stmt|,
modifier|*
name|pos
decl_stmt|;
name|size_t
name|kde_len
decl_stmt|;
name|u16
name|key_info
decl_stmt|,
name|ver
decl_stmt|;
name|be32
name|lifetime
decl_stmt|;
name|kde_len
operator|=
name|peerkey
operator|->
name|rsnie_i_len
operator|+
literal|2
operator|+
name|RSN_SELECTOR_LEN
operator|+
sizeof|sizeof
argument_list|(
name|lifetime
argument_list|)
expr_stmt|;
name|mbuf
operator|=
name|wpa_sm_alloc_eapol
argument_list|(
name|sm
argument_list|,
name|IEEE802_1X_TYPE_EAPOL_KEY
argument_list|,
name|NULL
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|msg
argument_list|)
operator|+
name|kde_len
argument_list|,
operator|&
name|mlen
argument_list|,
operator|(
name|void
operator|*
operator|)
operator|&
name|msg
argument_list|)
expr_stmt|;
if|if
condition|(
name|mbuf
operator|==
name|NULL
condition|)
return|return;
name|msg
operator|->
name|type
operator|=
name|EAPOL_KEY_TYPE_RSN
expr_stmt|;
if|if
condition|(
name|peerkey
operator|->
name|cipher
operator|==
name|WPA_CIPHER_CCMP
condition|)
name|ver
operator|=
name|WPA_KEY_INFO_TYPE_HMAC_SHA1_AES
expr_stmt|;
else|else
name|ver
operator|=
name|WPA_KEY_INFO_TYPE_HMAC_MD5_RC4
expr_stmt|;
name|key_info
operator|=
name|ver
operator||
name|WPA_KEY_INFO_KEY_TYPE
operator||
name|WPA_KEY_INFO_ACK
operator||
name|WPA_KEY_INFO_MIC
operator||
name|WPA_KEY_INFO_SECURE
expr_stmt|;
name|WPA_PUT_BE16
argument_list|(
name|msg
operator|->
name|key_info
argument_list|,
name|key_info
argument_list|)
expr_stmt|;
if|if
condition|(
name|peerkey
operator|->
name|cipher
operator|==
name|WPA_CIPHER_CCMP
condition|)
name|WPA_PUT_BE16
argument_list|(
name|msg
operator|->
name|key_length
argument_list|,
literal|16
argument_list|)
expr_stmt|;
else|else
name|WPA_PUT_BE16
argument_list|(
name|msg
operator|->
name|key_length
argument_list|,
literal|32
argument_list|)
expr_stmt|;
name|os_memcpy
argument_list|(
name|msg
operator|->
name|replay_counter
argument_list|,
name|peerkey
operator|->
name|replay_counter
argument_list|,
name|WPA_REPLAY_COUNTER_LEN
argument_list|)
expr_stmt|;
name|inc_byte_array
argument_list|(
name|peerkey
operator|->
name|replay_counter
argument_list|,
name|WPA_REPLAY_COUNTER_LEN
argument_list|)
expr_stmt|;
name|WPA_PUT_BE16
argument_list|(
name|msg
operator|->
name|key_data_length
argument_list|,
name|kde_len
argument_list|)
expr_stmt|;
name|pos
operator|=
operator|(
name|u8
operator|*
operator|)
operator|(
name|msg
operator|+
literal|1
operator|)
expr_stmt|;
name|pos
operator|=
name|wpa_add_ie
argument_list|(
name|pos
argument_list|,
name|peerkey
operator|->
name|rsnie_i
argument_list|,
name|peerkey
operator|->
name|rsnie_i_len
argument_list|)
expr_stmt|;
name|lifetime
operator|=
name|host_to_be32
argument_list|(
name|peerkey
operator|->
name|lifetime
argument_list|)
expr_stmt|;
name|wpa_add_kde
argument_list|(
name|pos
argument_list|,
name|RSN_KEY_DATA_LIFETIME
argument_list|,
operator|(
name|u8
operator|*
operator|)
operator|&
name|lifetime
argument_list|,
sizeof|sizeof
argument_list|(
name|lifetime
argument_list|)
argument_list|)
expr_stmt|;
name|os_memcpy
argument_list|(
name|msg
operator|->
name|key_nonce
argument_list|,
name|peerkey
operator|->
name|inonce
argument_list|,
name|WPA_NONCE_LEN
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"RSN: Sending EAPOL-Key STK 3/4 to "
name|MACSTR
argument_list|,
name|MAC2STR
argument_list|(
name|peerkey
operator|->
name|addr
argument_list|)
argument_list|)
expr_stmt|;
name|wpa_eapol_key_send
argument_list|(
name|sm
argument_list|,
name|peerkey
operator|->
name|stk
operator|.
name|kck
argument_list|,
name|ver
argument_list|,
name|peerkey
operator|->
name|addr
argument_list|,
name|ETH_P_EAPOL
argument_list|,
name|mbuf
argument_list|,
name|mlen
argument_list|,
name|msg
operator|->
name|key_mic
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|wpa_supplicant_process_smk_m4
parameter_list|(
name|struct
name|wpa_peerkey
modifier|*
name|peerkey
parameter_list|,
name|struct
name|wpa_eapol_ie_parse
modifier|*
name|kde
parameter_list|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"RSN: Received SMK M4 (Initiator "
name|MACSTR
literal|")"
argument_list|,
name|MAC2STR
argument_list|(
name|kde
operator|->
name|mac_addr
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|os_memcmp
argument_list|(
name|kde
operator|->
name|smk
operator|+
name|PMK_LEN
argument_list|,
name|peerkey
operator|->
name|pnonce
argument_list|,
name|WPA_NONCE_LEN
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"RSN: PNonce in SMK KDE does not "
literal|"match with the one used in SMK M3"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
if|if
condition|(
name|os_memcmp
argument_list|(
name|kde
operator|->
name|nonce
argument_list|,
name|peerkey
operator|->
name|inonce
argument_list|,
name|WPA_NONCE_LEN
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"RSN: INonce in SMK M4 did not "
literal|"match with the one received in SMK M2"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|wpa_supplicant_process_smk_m5
parameter_list|(
name|struct
name|wpa_sm
modifier|*
name|sm
parameter_list|,
specifier|const
name|unsigned
name|char
modifier|*
name|src_addr
parameter_list|,
specifier|const
name|struct
name|wpa_eapol_key
modifier|*
name|key
parameter_list|,
name|int
name|ver
parameter_list|,
name|struct
name|wpa_peerkey
modifier|*
name|peerkey
parameter_list|,
name|struct
name|wpa_eapol_ie_parse
modifier|*
name|kde
parameter_list|)
block|{
name|int
name|cipher
decl_stmt|;
name|struct
name|wpa_ie_data
name|ie
decl_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"RSN: Received SMK M5 (Peer "
name|MACSTR
literal|")"
argument_list|,
name|MAC2STR
argument_list|(
name|kde
operator|->
name|mac_addr
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|kde
operator|->
name|rsn_ie
operator|==
name|NULL
operator|||
name|kde
operator|->
name|rsn_ie_len
operator|>
name|PEERKEY_MAX_IE_LEN
operator|||
name|wpa_parse_wpa_ie_rsn
argument_list|(
name|kde
operator|->
name|rsn_ie
argument_list|,
name|kde
operator|->
name|rsn_ie_len
argument_list|,
operator|&
name|ie
argument_list|)
operator|<
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"RSN: No RSN IE in SMK M5"
argument_list|)
expr_stmt|;
comment|/* TODO: abort negotiation */
return|return
operator|-
literal|1
return|;
block|}
if|if
condition|(
name|os_memcmp
argument_list|(
name|key
operator|->
name|key_nonce
argument_list|,
name|peerkey
operator|->
name|inonce
argument_list|,
name|WPA_NONCE_LEN
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"RSN: Key Nonce in SMK M5 does "
literal|"not match with INonce used in SMK M1"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
if|if
condition|(
name|os_memcmp
argument_list|(
name|kde
operator|->
name|smk
operator|+
name|PMK_LEN
argument_list|,
name|peerkey
operator|->
name|inonce
argument_list|,
name|WPA_NONCE_LEN
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"RSN: INonce in SMK KDE does not "
literal|"match with the one used in SMK M1"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|os_memcpy
argument_list|(
name|peerkey
operator|->
name|rsnie_p
argument_list|,
name|kde
operator|->
name|rsn_ie
argument_list|,
name|kde
operator|->
name|rsn_ie_len
argument_list|)
expr_stmt|;
name|peerkey
operator|->
name|rsnie_p_len
operator|=
name|kde
operator|->
name|rsn_ie_len
expr_stmt|;
name|os_memcpy
argument_list|(
name|peerkey
operator|->
name|pnonce
argument_list|,
name|kde
operator|->
name|nonce
argument_list|,
name|WPA_NONCE_LEN
argument_list|)
expr_stmt|;
name|cipher
operator|=
name|ie
operator|.
name|pairwise_cipher
operator|&
name|sm
operator|->
name|allowed_pairwise_cipher
expr_stmt|;
if|if
condition|(
name|cipher
operator|&
name|WPA_CIPHER_CCMP
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"RSN: Using CCMP for PeerKey"
argument_list|)
expr_stmt|;
name|peerkey
operator|->
name|cipher
operator|=
name|WPA_CIPHER_CCMP
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|cipher
operator|&
name|WPA_CIPHER_TKIP
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"RSN: Using TKIP for PeerKey"
argument_list|)
expr_stmt|;
name|peerkey
operator|->
name|cipher
operator|=
name|WPA_CIPHER_TKIP
expr_stmt|;
block|}
else|else
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"RSN: SMK Peer STA "
name|MACSTR
literal|" selected "
literal|"unacceptable cipher"
argument_list|,
name|MAC2STR
argument_list|(
name|kde
operator|->
name|mac_addr
argument_list|)
argument_list|)
expr_stmt|;
name|wpa_supplicant_send_smk_error
argument_list|(
name|sm
argument_list|,
name|src_addr
argument_list|,
name|kde
operator|->
name|mac_addr
argument_list|,
name|STK_MUI_SMK
argument_list|,
name|STK_ERR_CPHR_NS
argument_list|,
name|ver
argument_list|)
expr_stmt|;
comment|/* TODO: abort negotiation */
return|return
operator|-
literal|1
return|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|wpa_supplicant_process_smk_m45
parameter_list|(
name|struct
name|wpa_sm
modifier|*
name|sm
parameter_list|,
specifier|const
name|unsigned
name|char
modifier|*
name|src_addr
parameter_list|,
specifier|const
name|struct
name|wpa_eapol_key
modifier|*
name|key
parameter_list|,
name|size_t
name|extra_len
parameter_list|,
name|int
name|ver
parameter_list|)
block|{
name|struct
name|wpa_peerkey
modifier|*
name|peerkey
decl_stmt|;
name|struct
name|wpa_eapol_ie_parse
name|kde
decl_stmt|;
name|u32
name|lifetime
decl_stmt|;
name|struct
name|os_time
name|now
decl_stmt|;
if|if
condition|(
operator|!
name|sm
operator|->
name|peerkey_enabled
operator|||
name|sm
operator|->
name|proto
operator|!=
name|WPA_PROTO_RSN
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"RSN: SMK handshake not allowed for "
literal|"the current network"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
if|if
condition|(
name|wpa_supplicant_parse_ies
argument_list|(
operator|(
specifier|const
name|u8
operator|*
operator|)
operator|(
name|key
operator|+
literal|1
operator|)
argument_list|,
name|extra_len
argument_list|,
operator|&
name|kde
argument_list|)
operator|<
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"RSN: Failed to parse KDEs in SMK M4/M5"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
if|if
condition|(
name|kde
operator|.
name|mac_addr
operator|==
name|NULL
operator|||
name|kde
operator|.
name|mac_addr_len
operator|<
name|ETH_ALEN
operator|||
name|kde
operator|.
name|nonce
operator|==
name|NULL
operator|||
name|kde
operator|.
name|nonce_len
operator|<
name|WPA_NONCE_LEN
operator|||
name|kde
operator|.
name|smk
operator|==
name|NULL
operator|||
name|kde
operator|.
name|smk_len
operator|<
name|PMK_LEN
operator|+
name|WPA_NONCE_LEN
operator|||
name|kde
operator|.
name|lifetime
operator|==
name|NULL
operator|||
name|kde
operator|.
name|lifetime_len
operator|<
literal|4
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"RSN: No MAC Address, Nonce, SMK, or "
literal|"Lifetime KDE in SMK M4/M5"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
for|for
control|(
name|peerkey
operator|=
name|sm
operator|->
name|peerkey
init|;
name|peerkey
condition|;
name|peerkey
operator|=
name|peerkey
operator|->
name|next
control|)
block|{
if|if
condition|(
name|os_memcmp
argument_list|(
name|peerkey
operator|->
name|addr
argument_list|,
name|kde
operator|.
name|mac_addr
argument_list|,
name|ETH_ALEN
argument_list|)
operator|==
literal|0
operator|&&
name|os_memcmp
argument_list|(
name|peerkey
operator|->
name|initiator
condition|?
name|peerkey
operator|->
name|inonce
else|:
name|peerkey
operator|->
name|pnonce
argument_list|,
name|key
operator|->
name|key_nonce
argument_list|,
name|WPA_NONCE_LEN
argument_list|)
operator|==
literal|0
condition|)
break|break;
block|}
if|if
condition|(
name|peerkey
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"RSN: No matching SMK handshake found "
literal|"for SMK M4/M5: peer "
name|MACSTR
argument_list|,
name|MAC2STR
argument_list|(
name|kde
operator|.
name|mac_addr
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
if|if
condition|(
name|peerkey
operator|->
name|initiator
condition|)
block|{
if|if
condition|(
name|wpa_supplicant_process_smk_m5
argument_list|(
name|sm
argument_list|,
name|src_addr
argument_list|,
name|key
argument_list|,
name|ver
argument_list|,
name|peerkey
argument_list|,
operator|&
name|kde
argument_list|)
operator|<
literal|0
condition|)
return|return
operator|-
literal|1
return|;
block|}
else|else
block|{
if|if
condition|(
name|wpa_supplicant_process_smk_m4
argument_list|(
name|peerkey
argument_list|,
operator|&
name|kde
argument_list|)
operator|<
literal|0
condition|)
return|return
operator|-
literal|1
return|;
block|}
name|os_memcpy
argument_list|(
name|peerkey
operator|->
name|smk
argument_list|,
name|kde
operator|.
name|smk
argument_list|,
name|PMK_LEN
argument_list|)
expr_stmt|;
name|peerkey
operator|->
name|smk_complete
operator|=
literal|1
expr_stmt|;
name|wpa_hexdump_key
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"RSN: SMK"
argument_list|,
name|peerkey
operator|->
name|smk
argument_list|,
name|PMK_LEN
argument_list|)
expr_stmt|;
name|lifetime
operator|=
name|WPA_GET_BE32
argument_list|(
name|kde
operator|.
name|lifetime
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"RSN: SMK lifetime %u seconds"
argument_list|,
name|lifetime
argument_list|)
expr_stmt|;
if|if
condition|(
name|lifetime
operator|>
literal|1000000000
condition|)
name|lifetime
operator|=
literal|1000000000
expr_stmt|;
comment|/* avoid overflowing expiration time */
name|peerkey
operator|->
name|lifetime
operator|=
name|lifetime
expr_stmt|;
name|os_get_time
argument_list|(
operator|&
name|now
argument_list|)
expr_stmt|;
name|peerkey
operator|->
name|expiration
operator|=
name|now
operator|.
name|sec
operator|+
name|lifetime
expr_stmt|;
name|eloop_register_timeout
argument_list|(
name|lifetime
argument_list|,
literal|0
argument_list|,
name|wpa_supplicant_smk_timeout
argument_list|,
name|sm
argument_list|,
name|peerkey
argument_list|)
expr_stmt|;
if|if
condition|(
name|peerkey
operator|->
name|initiator
condition|)
block|{
name|rsn_smkid
argument_list|(
name|peerkey
operator|->
name|smk
argument_list|,
name|peerkey
operator|->
name|pnonce
argument_list|,
name|peerkey
operator|->
name|addr
argument_list|,
name|peerkey
operator|->
name|inonce
argument_list|,
name|sm
operator|->
name|own_addr
argument_list|,
name|peerkey
operator|->
name|smkid
argument_list|,
name|peerkey
operator|->
name|use_sha256
argument_list|)
expr_stmt|;
name|wpa_supplicant_send_stk_1_of_4
argument_list|(
name|sm
argument_list|,
name|peerkey
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|rsn_smkid
argument_list|(
name|peerkey
operator|->
name|smk
argument_list|,
name|peerkey
operator|->
name|pnonce
argument_list|,
name|sm
operator|->
name|own_addr
argument_list|,
name|peerkey
operator|->
name|inonce
argument_list|,
name|peerkey
operator|->
name|addr
argument_list|,
name|peerkey
operator|->
name|smkid
argument_list|,
name|peerkey
operator|->
name|use_sha256
argument_list|)
expr_stmt|;
block|}
name|wpa_hexdump
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"RSN: SMKID"
argument_list|,
name|peerkey
operator|->
name|smkid
argument_list|,
name|PMKID_LEN
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|wpa_supplicant_process_smk_error
parameter_list|(
name|struct
name|wpa_sm
modifier|*
name|sm
parameter_list|,
specifier|const
name|unsigned
name|char
modifier|*
name|src_addr
parameter_list|,
specifier|const
name|struct
name|wpa_eapol_key
modifier|*
name|key
parameter_list|,
name|size_t
name|extra_len
parameter_list|)
block|{
name|struct
name|wpa_eapol_ie_parse
name|kde
decl_stmt|;
name|struct
name|rsn_error_kde
name|error
decl_stmt|;
name|u8
name|peer
index|[
name|ETH_ALEN
index|]
decl_stmt|;
name|u16
name|error_type
decl_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"RSN: Received SMK Error"
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|sm
operator|->
name|peerkey_enabled
operator|||
name|sm
operator|->
name|proto
operator|!=
name|WPA_PROTO_RSN
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"RSN: SMK handshake not allowed for "
literal|"the current network"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
if|if
condition|(
name|wpa_supplicant_parse_ies
argument_list|(
operator|(
specifier|const
name|u8
operator|*
operator|)
operator|(
name|key
operator|+
literal|1
operator|)
argument_list|,
name|extra_len
argument_list|,
operator|&
name|kde
argument_list|)
operator|<
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"RSN: Failed to parse KDEs in SMK Error"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
if|if
condition|(
name|kde
operator|.
name|error
operator|==
name|NULL
operator|||
name|kde
operator|.
name|error_len
operator|<
sizeof|sizeof
argument_list|(
name|error
argument_list|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"RSN: No Error KDE in SMK Error"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
if|if
condition|(
name|kde
operator|.
name|mac_addr
operator|&&
name|kde
operator|.
name|mac_addr_len
operator|>=
name|ETH_ALEN
condition|)
name|os_memcpy
argument_list|(
name|peer
argument_list|,
name|kde
operator|.
name|mac_addr
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
name|os_memcpy
argument_list|(
operator|&
name|error
argument_list|,
name|kde
operator|.
name|error
argument_list|,
sizeof|sizeof
argument_list|(
name|error
argument_list|)
argument_list|)
expr_stmt|;
name|error_type
operator|=
name|be_to_host16
argument_list|(
name|error
operator|.
name|error_type
argument_list|)
expr_stmt|;
name|wpa_msg
argument_list|(
name|sm
operator|->
name|ctx
operator|->
name|ctx
argument_list|,
name|MSG_INFO
argument_list|,
literal|"RSN: SMK Error KDE received: MUI %d error_type %d peer "
name|MACSTR
argument_list|,
name|be_to_host16
argument_list|(
name|error
operator|.
name|mui
argument_list|)
argument_list|,
name|error_type
argument_list|,
name|MAC2STR
argument_list|(
name|peer
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|kde
operator|.
name|mac_addr
operator|&&
operator|(
name|error_type
operator|==
name|STK_ERR_STA_NR
operator|||
name|error_type
operator|==
name|STK_ERR_STA_NRSN
operator|||
name|error_type
operator|==
name|STK_ERR_CPHR_NS
operator|)
condition|)
block|{
name|struct
name|wpa_peerkey
modifier|*
name|peerkey
decl_stmt|;
for|for
control|(
name|peerkey
operator|=
name|sm
operator|->
name|peerkey
init|;
name|peerkey
condition|;
name|peerkey
operator|=
name|peerkey
operator|->
name|next
control|)
block|{
if|if
condition|(
name|os_memcmp
argument_list|(
name|peerkey
operator|->
name|addr
argument_list|,
name|kde
operator|.
name|mac_addr
argument_list|,
name|ETH_ALEN
argument_list|)
operator|==
literal|0
condition|)
break|break;
block|}
if|if
condition|(
name|peerkey
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"RSN: No matching SMK handshake "
literal|"found for SMK Error"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
comment|/* TODO: abort SMK/STK handshake and remove all related keys */
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|wpa_supplicant_process_stk_1_of_4
parameter_list|(
name|struct
name|wpa_sm
modifier|*
name|sm
parameter_list|,
name|struct
name|wpa_peerkey
modifier|*
name|peerkey
parameter_list|,
specifier|const
name|struct
name|wpa_eapol_key
modifier|*
name|key
parameter_list|,
name|u16
name|ver
parameter_list|)
block|{
name|struct
name|wpa_eapol_ie_parse
name|ie
decl_stmt|;
specifier|const
name|u8
modifier|*
name|kde
decl_stmt|;
name|size_t
name|len
decl_stmt|,
name|kde_buf_len
decl_stmt|;
name|struct
name|wpa_ptk
modifier|*
name|stk
decl_stmt|;
name|u8
name|buf
index|[
literal|8
index|]
decl_stmt|,
modifier|*
name|kde_buf
decl_stmt|,
modifier|*
name|pos
decl_stmt|;
name|be32
name|lifetime
decl_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"RSN: RX message 1 of STK 4-Way Handshake from "
name|MACSTR
literal|" (ver=%d)"
argument_list|,
name|MAC2STR
argument_list|(
name|peerkey
operator|->
name|addr
argument_list|)
argument_list|,
name|ver
argument_list|)
expr_stmt|;
name|os_memset
argument_list|(
operator|&
name|ie
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|ie
argument_list|)
argument_list|)
expr_stmt|;
comment|/* RSN: msg 1/4 should contain SMKID for the selected SMK */
name|kde
operator|=
operator|(
specifier|const
name|u8
operator|*
operator|)
operator|(
name|key
operator|+
literal|1
operator|)
expr_stmt|;
name|len
operator|=
name|WPA_GET_BE16
argument_list|(
name|key
operator|->
name|key_data_length
argument_list|)
expr_stmt|;
name|wpa_hexdump
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"RSN: msg 1/4 key data"
argument_list|,
name|kde
argument_list|,
name|len
argument_list|)
expr_stmt|;
if|if
condition|(
name|wpa_supplicant_parse_ies
argument_list|(
name|kde
argument_list|,
name|len
argument_list|,
operator|&
name|ie
argument_list|)
operator|<
literal|0
operator|||
name|ie
operator|.
name|pmkid
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"RSN: No SMKID in STK 1/4"
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|os_memcmp
argument_list|(
name|ie
operator|.
name|pmkid
argument_list|,
name|peerkey
operator|->
name|smkid
argument_list|,
name|PMKID_LEN
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|wpa_hexdump
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"RSN: Unknown SMKID in STK 1/4"
argument_list|,
name|ie
operator|.
name|pmkid
argument_list|,
name|PMKID_LEN
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|os_get_random
argument_list|(
name|peerkey
operator|->
name|pnonce
argument_list|,
name|WPA_NONCE_LEN
argument_list|)
condition|)
block|{
name|wpa_msg
argument_list|(
name|sm
operator|->
name|ctx
operator|->
name|ctx
argument_list|,
name|MSG_WARNING
argument_list|,
literal|"RSN: Failed to get random data for PNonce"
argument_list|)
expr_stmt|;
return|return;
block|}
name|wpa_hexdump
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPA: Renewed PNonce"
argument_list|,
name|peerkey
operator|->
name|pnonce
argument_list|,
name|WPA_NONCE_LEN
argument_list|)
expr_stmt|;
comment|/* Calculate STK which will be stored as a temporary STK until it has 	 * been verified when processing message 3/4. */
name|stk
operator|=
operator|&
name|peerkey
operator|->
name|tstk
expr_stmt|;
name|wpa_pmk_to_ptk
argument_list|(
name|peerkey
operator|->
name|smk
argument_list|,
name|PMK_LEN
argument_list|,
literal|"Peer key expansion"
argument_list|,
name|sm
operator|->
name|own_addr
argument_list|,
name|peerkey
operator|->
name|addr
argument_list|,
name|peerkey
operator|->
name|pnonce
argument_list|,
name|key
operator|->
name|key_nonce
argument_list|,
operator|(
name|u8
operator|*
operator|)
name|stk
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|stk
argument_list|)
argument_list|,
name|peerkey
operator|->
name|use_sha256
argument_list|)
expr_stmt|;
comment|/* Supplicant: swap tx/rx Mic keys */
name|os_memcpy
argument_list|(
name|buf
argument_list|,
name|stk
operator|->
name|u
operator|.
name|auth
operator|.
name|tx_mic_key
argument_list|,
literal|8
argument_list|)
expr_stmt|;
name|os_memcpy
argument_list|(
name|stk
operator|->
name|u
operator|.
name|auth
operator|.
name|tx_mic_key
argument_list|,
name|stk
operator|->
name|u
operator|.
name|auth
operator|.
name|rx_mic_key
argument_list|,
literal|8
argument_list|)
expr_stmt|;
name|os_memcpy
argument_list|(
name|stk
operator|->
name|u
operator|.
name|auth
operator|.
name|rx_mic_key
argument_list|,
name|buf
argument_list|,
literal|8
argument_list|)
expr_stmt|;
name|peerkey
operator|->
name|tstk_set
operator|=
literal|1
expr_stmt|;
name|kde_buf_len
operator|=
name|peerkey
operator|->
name|rsnie_p_len
operator|+
literal|2
operator|+
name|RSN_SELECTOR_LEN
operator|+
sizeof|sizeof
argument_list|(
name|lifetime
argument_list|)
operator|+
literal|2
operator|+
name|RSN_SELECTOR_LEN
operator|+
name|PMKID_LEN
expr_stmt|;
name|kde_buf
operator|=
name|os_malloc
argument_list|(
name|kde_buf_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|kde_buf
operator|==
name|NULL
condition|)
return|return;
name|pos
operator|=
name|kde_buf
expr_stmt|;
name|pos
operator|=
name|wpa_add_ie
argument_list|(
name|pos
argument_list|,
name|peerkey
operator|->
name|rsnie_p
argument_list|,
name|peerkey
operator|->
name|rsnie_p_len
argument_list|)
expr_stmt|;
name|lifetime
operator|=
name|host_to_be32
argument_list|(
name|peerkey
operator|->
name|lifetime
argument_list|)
expr_stmt|;
name|pos
operator|=
name|wpa_add_kde
argument_list|(
name|pos
argument_list|,
name|RSN_KEY_DATA_LIFETIME
argument_list|,
operator|(
name|u8
operator|*
operator|)
operator|&
name|lifetime
argument_list|,
sizeof|sizeof
argument_list|(
name|lifetime
argument_list|)
argument_list|)
expr_stmt|;
name|wpa_add_kde
argument_list|(
name|pos
argument_list|,
name|RSN_KEY_DATA_PMKID
argument_list|,
name|peerkey
operator|->
name|smkid
argument_list|,
name|PMKID_LEN
argument_list|)
expr_stmt|;
if|if
condition|(
name|wpa_supplicant_send_2_of_4
argument_list|(
name|sm
argument_list|,
name|peerkey
operator|->
name|addr
argument_list|,
name|key
argument_list|,
name|ver
argument_list|,
name|peerkey
operator|->
name|pnonce
argument_list|,
name|kde_buf
argument_list|,
name|kde_buf_len
argument_list|,
name|stk
argument_list|)
condition|)
block|{
name|os_free
argument_list|(
name|kde_buf
argument_list|)
expr_stmt|;
return|return;
block|}
name|os_free
argument_list|(
name|kde_buf
argument_list|)
expr_stmt|;
name|os_memcpy
argument_list|(
name|peerkey
operator|->
name|inonce
argument_list|,
name|key
operator|->
name|key_nonce
argument_list|,
name|WPA_NONCE_LEN
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|wpa_supplicant_update_smk_lifetime
parameter_list|(
name|struct
name|wpa_sm
modifier|*
name|sm
parameter_list|,
name|struct
name|wpa_peerkey
modifier|*
name|peerkey
parameter_list|,
name|struct
name|wpa_eapol_ie_parse
modifier|*
name|kde
parameter_list|)
block|{
name|u32
name|lifetime
decl_stmt|;
name|struct
name|os_time
name|now
decl_stmt|;
if|if
condition|(
name|kde
operator|->
name|lifetime
operator|==
name|NULL
operator|||
name|kde
operator|->
name|lifetime_len
operator|<
sizeof|sizeof
argument_list|(
name|lifetime
argument_list|)
condition|)
return|return;
name|lifetime
operator|=
name|WPA_GET_BE32
argument_list|(
name|kde
operator|->
name|lifetime
argument_list|)
expr_stmt|;
if|if
condition|(
name|lifetime
operator|>=
name|peerkey
operator|->
name|lifetime
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"RSN: Peer used SMK lifetime %u seconds "
literal|"which is larger than or equal to own value %u "
literal|"seconds - ignored"
argument_list|,
name|lifetime
argument_list|,
name|peerkey
operator|->
name|lifetime
argument_list|)
expr_stmt|;
return|return;
block|}
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"RSN: Peer used shorter SMK lifetime %u seconds "
literal|"(own was %u seconds) - updated"
argument_list|,
name|lifetime
argument_list|,
name|peerkey
operator|->
name|lifetime
argument_list|)
expr_stmt|;
name|peerkey
operator|->
name|lifetime
operator|=
name|lifetime
expr_stmt|;
name|os_get_time
argument_list|(
operator|&
name|now
argument_list|)
expr_stmt|;
name|peerkey
operator|->
name|expiration
operator|=
name|now
operator|.
name|sec
operator|+
name|lifetime
expr_stmt|;
name|eloop_cancel_timeout
argument_list|(
name|wpa_supplicant_smk_timeout
argument_list|,
name|sm
argument_list|,
name|peerkey
argument_list|)
expr_stmt|;
name|eloop_register_timeout
argument_list|(
name|lifetime
argument_list|,
literal|0
argument_list|,
name|wpa_supplicant_smk_timeout
argument_list|,
name|sm
argument_list|,
name|peerkey
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|wpa_supplicant_process_stk_2_of_4
parameter_list|(
name|struct
name|wpa_sm
modifier|*
name|sm
parameter_list|,
name|struct
name|wpa_peerkey
modifier|*
name|peerkey
parameter_list|,
specifier|const
name|struct
name|wpa_eapol_key
modifier|*
name|key
parameter_list|,
name|u16
name|ver
parameter_list|)
block|{
name|struct
name|wpa_eapol_ie_parse
name|kde
decl_stmt|;
specifier|const
name|u8
modifier|*
name|keydata
decl_stmt|;
name|size_t
name|len
decl_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"RSN: RX message 2 of STK 4-Way Handshake from "
name|MACSTR
literal|" (ver=%d)"
argument_list|,
name|MAC2STR
argument_list|(
name|peerkey
operator|->
name|addr
argument_list|)
argument_list|,
name|ver
argument_list|)
expr_stmt|;
name|os_memset
argument_list|(
operator|&
name|kde
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|kde
argument_list|)
argument_list|)
expr_stmt|;
comment|/* RSN: msg 2/4 should contain SMKID for the selected SMK and RSN IE 	 * from the peer. It may also include Lifetime KDE. */
name|keydata
operator|=
operator|(
specifier|const
name|u8
operator|*
operator|)
operator|(
name|key
operator|+
literal|1
operator|)
expr_stmt|;
name|len
operator|=
name|WPA_GET_BE16
argument_list|(
name|key
operator|->
name|key_data_length
argument_list|)
expr_stmt|;
name|wpa_hexdump
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"RSN: msg 2/4 key data"
argument_list|,
name|keydata
argument_list|,
name|len
argument_list|)
expr_stmt|;
if|if
condition|(
name|wpa_supplicant_parse_ies
argument_list|(
name|keydata
argument_list|,
name|len
argument_list|,
operator|&
name|kde
argument_list|)
operator|<
literal|0
operator|||
name|kde
operator|.
name|pmkid
operator|==
name|NULL
operator|||
name|kde
operator|.
name|rsn_ie
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"RSN: No SMKID or RSN IE in STK 2/4"
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|os_memcmp
argument_list|(
name|kde
operator|.
name|pmkid
argument_list|,
name|peerkey
operator|->
name|smkid
argument_list|,
name|PMKID_LEN
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|wpa_hexdump
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"RSN: Unknown SMKID in STK 2/4"
argument_list|,
name|kde
operator|.
name|pmkid
argument_list|,
name|PMKID_LEN
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|kde
operator|.
name|rsn_ie_len
operator|!=
name|peerkey
operator|->
name|rsnie_p_len
operator|||
name|os_memcmp
argument_list|(
name|kde
operator|.
name|rsn_ie
argument_list|,
name|peerkey
operator|->
name|rsnie_p
argument_list|,
name|kde
operator|.
name|rsn_ie_len
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"RSN: Peer RSN IE in SMK and STK "
literal|"handshakes did not match"
argument_list|)
expr_stmt|;
name|wpa_hexdump
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"RSN: Peer RSN IE in SMK handshake"
argument_list|,
name|peerkey
operator|->
name|rsnie_p
argument_list|,
name|peerkey
operator|->
name|rsnie_p_len
argument_list|)
expr_stmt|;
name|wpa_hexdump
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"RSN: Peer RSN IE in STK handshake"
argument_list|,
name|kde
operator|.
name|rsn_ie
argument_list|,
name|kde
operator|.
name|rsn_ie_len
argument_list|)
expr_stmt|;
return|return;
block|}
name|wpa_supplicant_update_smk_lifetime
argument_list|(
name|sm
argument_list|,
name|peerkey
argument_list|,
operator|&
name|kde
argument_list|)
expr_stmt|;
name|wpa_supplicant_send_stk_3_of_4
argument_list|(
name|sm
argument_list|,
name|peerkey
argument_list|)
expr_stmt|;
name|os_memcpy
argument_list|(
name|peerkey
operator|->
name|pnonce
argument_list|,
name|key
operator|->
name|key_nonce
argument_list|,
name|WPA_NONCE_LEN
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|wpa_supplicant_process_stk_3_of_4
parameter_list|(
name|struct
name|wpa_sm
modifier|*
name|sm
parameter_list|,
name|struct
name|wpa_peerkey
modifier|*
name|peerkey
parameter_list|,
specifier|const
name|struct
name|wpa_eapol_key
modifier|*
name|key
parameter_list|,
name|u16
name|ver
parameter_list|)
block|{
name|struct
name|wpa_eapol_ie_parse
name|kde
decl_stmt|;
specifier|const
name|u8
modifier|*
name|keydata
decl_stmt|;
name|size_t
name|len
decl_stmt|,
name|key_len
decl_stmt|;
specifier|const
name|u8
modifier|*
name|_key
decl_stmt|;
name|u8
name|key_buf
index|[
literal|32
index|]
decl_stmt|,
name|rsc
index|[
literal|6
index|]
decl_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"RSN: RX message 3 of STK 4-Way Handshake from "
name|MACSTR
literal|" (ver=%d)"
argument_list|,
name|MAC2STR
argument_list|(
name|peerkey
operator|->
name|addr
argument_list|)
argument_list|,
name|ver
argument_list|)
expr_stmt|;
name|os_memset
argument_list|(
operator|&
name|kde
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|kde
argument_list|)
argument_list|)
expr_stmt|;
comment|/* RSN: msg 3/4 should contain Initiator RSN IE. It may also include 	 * Lifetime KDE. */
name|keydata
operator|=
operator|(
specifier|const
name|u8
operator|*
operator|)
operator|(
name|key
operator|+
literal|1
operator|)
expr_stmt|;
name|len
operator|=
name|WPA_GET_BE16
argument_list|(
name|key
operator|->
name|key_data_length
argument_list|)
expr_stmt|;
name|wpa_hexdump
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"RSN: msg 3/4 key data"
argument_list|,
name|keydata
argument_list|,
name|len
argument_list|)
expr_stmt|;
if|if
condition|(
name|wpa_supplicant_parse_ies
argument_list|(
name|keydata
argument_list|,
name|len
argument_list|,
operator|&
name|kde
argument_list|)
operator|<
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"RSN: Failed to parse key data in "
literal|"STK 3/4"
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|kde
operator|.
name|rsn_ie_len
operator|!=
name|peerkey
operator|->
name|rsnie_i_len
operator|||
name|os_memcmp
argument_list|(
name|kde
operator|.
name|rsn_ie
argument_list|,
name|peerkey
operator|->
name|rsnie_i
argument_list|,
name|kde
operator|.
name|rsn_ie_len
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"RSN: Initiator RSN IE in SMK and STK "
literal|"handshakes did not match"
argument_list|)
expr_stmt|;
name|wpa_hexdump
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"RSN: Initiator RSN IE in SMK "
literal|"handshake"
argument_list|,
name|peerkey
operator|->
name|rsnie_i
argument_list|,
name|peerkey
operator|->
name|rsnie_i_len
argument_list|)
expr_stmt|;
name|wpa_hexdump
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"RSN: Initiator RSN IE in STK "
literal|"handshake"
argument_list|,
name|kde
operator|.
name|rsn_ie
argument_list|,
name|kde
operator|.
name|rsn_ie_len
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|os_memcmp
argument_list|(
name|peerkey
operator|->
name|inonce
argument_list|,
name|key
operator|->
name|key_nonce
argument_list|,
name|WPA_NONCE_LEN
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_WARNING
argument_list|,
literal|"RSN: INonce from message 1 of STK "
literal|"4-Way Handshake differs from 3 of STK 4-Way "
literal|"Handshake - drop packet (src="
name|MACSTR
literal|")"
argument_list|,
name|MAC2STR
argument_list|(
name|peerkey
operator|->
name|addr
argument_list|)
argument_list|)
expr_stmt|;
return|return;
block|}
name|wpa_supplicant_update_smk_lifetime
argument_list|(
name|sm
argument_list|,
name|peerkey
argument_list|,
operator|&
name|kde
argument_list|)
expr_stmt|;
if|if
condition|(
name|wpa_supplicant_send_4_of_4
argument_list|(
name|sm
argument_list|,
name|peerkey
operator|->
name|addr
argument_list|,
name|key
argument_list|,
name|ver
argument_list|,
name|WPA_GET_BE16
argument_list|(
name|key
operator|->
name|key_info
argument_list|)
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|,
operator|&
name|peerkey
operator|->
name|stk
argument_list|)
condition|)
return|return;
name|_key
operator|=
operator|(
name|u8
operator|*
operator|)
name|peerkey
operator|->
name|stk
operator|.
name|tk1
expr_stmt|;
if|if
condition|(
name|peerkey
operator|->
name|cipher
operator|==
name|WPA_CIPHER_TKIP
condition|)
block|{
comment|/* Swap Tx/Rx keys for Michael MIC */
name|os_memcpy
argument_list|(
name|key_buf
argument_list|,
name|_key
argument_list|,
literal|16
argument_list|)
expr_stmt|;
name|os_memcpy
argument_list|(
name|key_buf
operator|+
literal|16
argument_list|,
name|peerkey
operator|->
name|stk
operator|.
name|u
operator|.
name|auth
operator|.
name|rx_mic_key
argument_list|,
literal|8
argument_list|)
expr_stmt|;
name|os_memcpy
argument_list|(
name|key_buf
operator|+
literal|24
argument_list|,
name|peerkey
operator|->
name|stk
operator|.
name|u
operator|.
name|auth
operator|.
name|tx_mic_key
argument_list|,
literal|8
argument_list|)
expr_stmt|;
name|_key
operator|=
name|key_buf
expr_stmt|;
name|key_len
operator|=
literal|32
expr_stmt|;
block|}
else|else
name|key_len
operator|=
literal|16
expr_stmt|;
name|os_memset
argument_list|(
name|rsc
argument_list|,
literal|0
argument_list|,
literal|6
argument_list|)
expr_stmt|;
if|if
condition|(
name|wpa_sm_set_key
argument_list|(
name|sm
argument_list|,
name|peerkey
operator|->
name|cipher
argument_list|,
name|peerkey
operator|->
name|addr
argument_list|,
literal|0
argument_list|,
literal|1
argument_list|,
name|rsc
argument_list|,
sizeof|sizeof
argument_list|(
name|rsc
argument_list|)
argument_list|,
name|_key
argument_list|,
name|key_len
argument_list|)
operator|<
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_WARNING
argument_list|,
literal|"RSN: Failed to set STK to the "
literal|"driver."
argument_list|)
expr_stmt|;
return|return;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|wpa_supplicant_process_stk_4_of_4
parameter_list|(
name|struct
name|wpa_sm
modifier|*
name|sm
parameter_list|,
name|struct
name|wpa_peerkey
modifier|*
name|peerkey
parameter_list|,
specifier|const
name|struct
name|wpa_eapol_key
modifier|*
name|key
parameter_list|,
name|u16
name|ver
parameter_list|)
block|{
name|u8
name|rsc
index|[
literal|6
index|]
decl_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"RSN: RX message 4 of STK 4-Way Handshake from "
name|MACSTR
literal|" (ver=%d)"
argument_list|,
name|MAC2STR
argument_list|(
name|peerkey
operator|->
name|addr
argument_list|)
argument_list|,
name|ver
argument_list|)
expr_stmt|;
name|os_memset
argument_list|(
name|rsc
argument_list|,
literal|0
argument_list|,
literal|6
argument_list|)
expr_stmt|;
if|if
condition|(
name|wpa_sm_set_key
argument_list|(
name|sm
argument_list|,
name|peerkey
operator|->
name|cipher
argument_list|,
name|peerkey
operator|->
name|addr
argument_list|,
literal|0
argument_list|,
literal|1
argument_list|,
name|rsc
argument_list|,
sizeof|sizeof
argument_list|(
name|rsc
argument_list|)
argument_list|,
operator|(
name|u8
operator|*
operator|)
name|peerkey
operator|->
name|stk
operator|.
name|tk1
argument_list|,
name|peerkey
operator|->
name|cipher
operator|==
name|WPA_CIPHER_TKIP
condition|?
literal|32
else|:
literal|16
argument_list|)
operator|<
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_WARNING
argument_list|,
literal|"RSN: Failed to set STK to the "
literal|"driver."
argument_list|)
expr_stmt|;
return|return;
block|}
block|}
end_function

begin_comment
comment|/**  * peerkey_verify_eapol_key_mic - Verify PeerKey MIC  * @sm: Pointer to WPA state machine data from wpa_sm_init()  * @peerkey: Pointer to the PeerKey data for the peer  * @key: Pointer to the EAPOL-Key frame header  * @ver: Version bits from EAPOL-Key Key Info  * @buf: Pointer to the beginning of EAPOL-Key frame  * @len: Length of the EAPOL-Key frame  * Returns: 0 on success, -1 on failure  */
end_comment

begin_function
name|int
name|peerkey_verify_eapol_key_mic
parameter_list|(
name|struct
name|wpa_sm
modifier|*
name|sm
parameter_list|,
name|struct
name|wpa_peerkey
modifier|*
name|peerkey
parameter_list|,
name|struct
name|wpa_eapol_key
modifier|*
name|key
parameter_list|,
name|u16
name|ver
parameter_list|,
specifier|const
name|u8
modifier|*
name|buf
parameter_list|,
name|size_t
name|len
parameter_list|)
block|{
name|u8
name|mic
index|[
literal|16
index|]
decl_stmt|;
name|int
name|ok
init|=
literal|0
decl_stmt|;
if|if
condition|(
name|peerkey
operator|->
name|initiator
operator|&&
operator|!
name|peerkey
operator|->
name|stk_set
condition|)
block|{
name|wpa_pmk_to_ptk
argument_list|(
name|peerkey
operator|->
name|smk
argument_list|,
name|PMK_LEN
argument_list|,
literal|"Peer key expansion"
argument_list|,
name|sm
operator|->
name|own_addr
argument_list|,
name|peerkey
operator|->
name|addr
argument_list|,
name|peerkey
operator|->
name|inonce
argument_list|,
name|key
operator|->
name|key_nonce
argument_list|,
operator|(
name|u8
operator|*
operator|)
operator|&
name|peerkey
operator|->
name|stk
argument_list|,
sizeof|sizeof
argument_list|(
name|peerkey
operator|->
name|stk
argument_list|)
argument_list|,
name|peerkey
operator|->
name|use_sha256
argument_list|)
expr_stmt|;
name|peerkey
operator|->
name|stk_set
operator|=
literal|1
expr_stmt|;
block|}
name|os_memcpy
argument_list|(
name|mic
argument_list|,
name|key
operator|->
name|key_mic
argument_list|,
literal|16
argument_list|)
expr_stmt|;
if|if
condition|(
name|peerkey
operator|->
name|tstk_set
condition|)
block|{
name|os_memset
argument_list|(
name|key
operator|->
name|key_mic
argument_list|,
literal|0
argument_list|,
literal|16
argument_list|)
expr_stmt|;
name|wpa_eapol_key_mic
argument_list|(
name|peerkey
operator|->
name|tstk
operator|.
name|kck
argument_list|,
name|ver
argument_list|,
name|buf
argument_list|,
name|len
argument_list|,
name|key
operator|->
name|key_mic
argument_list|)
expr_stmt|;
if|if
condition|(
name|os_memcmp
argument_list|(
name|mic
argument_list|,
name|key
operator|->
name|key_mic
argument_list|,
literal|16
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_WARNING
argument_list|,
literal|"RSN: Invalid EAPOL-Key MIC "
literal|"when using TSTK - ignoring TSTK"
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|ok
operator|=
literal|1
expr_stmt|;
name|peerkey
operator|->
name|tstk_set
operator|=
literal|0
expr_stmt|;
name|peerkey
operator|->
name|stk_set
operator|=
literal|1
expr_stmt|;
name|os_memcpy
argument_list|(
operator|&
name|peerkey
operator|->
name|stk
argument_list|,
operator|&
name|peerkey
operator|->
name|tstk
argument_list|,
sizeof|sizeof
argument_list|(
name|peerkey
operator|->
name|stk
argument_list|)
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
operator|!
name|ok
operator|&&
name|peerkey
operator|->
name|stk_set
condition|)
block|{
name|os_memset
argument_list|(
name|key
operator|->
name|key_mic
argument_list|,
literal|0
argument_list|,
literal|16
argument_list|)
expr_stmt|;
name|wpa_eapol_key_mic
argument_list|(
name|peerkey
operator|->
name|stk
operator|.
name|kck
argument_list|,
name|ver
argument_list|,
name|buf
argument_list|,
name|len
argument_list|,
name|key
operator|->
name|key_mic
argument_list|)
expr_stmt|;
if|if
condition|(
name|os_memcmp
argument_list|(
name|mic
argument_list|,
name|key
operator|->
name|key_mic
argument_list|,
literal|16
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_WARNING
argument_list|,
literal|"RSN: Invalid EAPOL-Key MIC "
literal|"- dropping packet"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|ok
operator|=
literal|1
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|ok
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_WARNING
argument_list|,
literal|"RSN: Could not verify EAPOL-Key MIC "
literal|"- dropping packet"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|os_memcpy
argument_list|(
name|peerkey
operator|->
name|replay_counter
argument_list|,
name|key
operator|->
name|replay_counter
argument_list|,
name|WPA_REPLAY_COUNTER_LEN
argument_list|)
expr_stmt|;
name|peerkey
operator|->
name|replay_counter_set
operator|=
literal|1
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/**  * wpa_sm_stkstart - Send EAPOL-Key Request for STK handshake (STK M1)  * @sm: Pointer to WPA state machine data from wpa_sm_init()  * @peer: MAC address of the peer STA  * Returns: 0 on success, or -1 on failure  *  * Send an EAPOL-Key Request to the current authenticator to start STK  * handshake with the peer.  */
end_comment

begin_function
name|int
name|wpa_sm_stkstart
parameter_list|(
name|struct
name|wpa_sm
modifier|*
name|sm
parameter_list|,
specifier|const
name|u8
modifier|*
name|peer
parameter_list|)
block|{
name|size_t
name|rlen
decl_stmt|,
name|kde_len
decl_stmt|;
name|struct
name|wpa_eapol_key
modifier|*
name|req
decl_stmt|;
name|int
name|key_info
decl_stmt|,
name|ver
decl_stmt|;
name|u8
name|bssid
index|[
name|ETH_ALEN
index|]
decl_stmt|,
modifier|*
name|rbuf
decl_stmt|,
modifier|*
name|pos
decl_stmt|,
modifier|*
name|count_pos
decl_stmt|;
name|u16
name|count
decl_stmt|;
name|struct
name|rsn_ie_hdr
modifier|*
name|hdr
decl_stmt|;
name|struct
name|wpa_peerkey
modifier|*
name|peerkey
decl_stmt|;
name|struct
name|wpa_ie_data
name|ie
decl_stmt|;
if|if
condition|(
name|sm
operator|->
name|proto
operator|!=
name|WPA_PROTO_RSN
operator|||
operator|!
name|sm
operator|->
name|ptk_set
operator|||
operator|!
name|sm
operator|->
name|peerkey_enabled
condition|)
return|return
operator|-
literal|1
return|;
if|if
condition|(
name|sm
operator|->
name|ap_rsn_ie
operator|&&
name|wpa_parse_wpa_ie_rsn
argument_list|(
name|sm
operator|->
name|ap_rsn_ie
argument_list|,
name|sm
operator|->
name|ap_rsn_ie_len
argument_list|,
operator|&
name|ie
argument_list|)
operator|==
literal|0
operator|&&
operator|!
operator|(
name|ie
operator|.
name|capabilities
operator|&
name|WPA_CAPABILITY_PEERKEY_ENABLED
operator|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"RSN: Current AP does not support STK"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
if|if
condition|(
name|sm
operator|->
name|pairwise_cipher
operator|==
name|WPA_CIPHER_CCMP
condition|)
name|ver
operator|=
name|WPA_KEY_INFO_TYPE_HMAC_SHA1_AES
expr_stmt|;
else|else
name|ver
operator|=
name|WPA_KEY_INFO_TYPE_HMAC_MD5_RC4
expr_stmt|;
if|if
condition|(
name|wpa_sm_get_bssid
argument_list|(
name|sm
argument_list|,
name|bssid
argument_list|)
operator|<
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_WARNING
argument_list|,
literal|"Failed to read BSSID for EAPOL-Key "
literal|"SMK M1"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
comment|/* TODO: find existing entry and if found, use that instead of adding 	 * a new one */
name|peerkey
operator|=
name|os_zalloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|peerkey
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|peerkey
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
name|peerkey
operator|->
name|initiator
operator|=
literal|1
expr_stmt|;
name|os_memcpy
argument_list|(
name|peerkey
operator|->
name|addr
argument_list|,
name|peer
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|CONFIG_IEEE80211W
if|if
condition|(
name|wpa_key_mgmt_sha256
argument_list|(
name|sm
operator|->
name|key_mgmt
argument_list|)
condition|)
name|peerkey
operator|->
name|use_sha256
operator|=
literal|1
expr_stmt|;
endif|#
directive|endif
comment|/* CONFIG_IEEE80211W */
comment|/* SMK M1: 	 * EAPOL-Key(S=1, M=1, A=0, I=0, K=0, SM=1, KeyRSC=0, Nonce=INonce, 	 *           MIC=MIC, DataKDs=(RSNIE_I, MAC_P KDE)) 	 */
name|hdr
operator|=
operator|(
expr|struct
name|rsn_ie_hdr
operator|*
operator|)
name|peerkey
operator|->
name|rsnie_i
expr_stmt|;
name|hdr
operator|->
name|elem_id
operator|=
name|WLAN_EID_RSN
expr_stmt|;
name|WPA_PUT_LE16
argument_list|(
name|hdr
operator|->
name|version
argument_list|,
name|RSN_VERSION
argument_list|)
expr_stmt|;
name|pos
operator|=
operator|(
name|u8
operator|*
operator|)
operator|(
name|hdr
operator|+
literal|1
operator|)
expr_stmt|;
comment|/* Group Suite can be anything for SMK RSN IE; receiver will just 	 * ignore it. */
name|RSN_SELECTOR_PUT
argument_list|(
name|pos
argument_list|,
name|RSN_CIPHER_SUITE_CCMP
argument_list|)
expr_stmt|;
name|pos
operator|+=
name|RSN_SELECTOR_LEN
expr_stmt|;
name|count_pos
operator|=
name|pos
expr_stmt|;
name|pos
operator|+=
literal|2
expr_stmt|;
name|count
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|sm
operator|->
name|allowed_pairwise_cipher
operator|&
name|WPA_CIPHER_CCMP
condition|)
block|{
name|RSN_SELECTOR_PUT
argument_list|(
name|pos
argument_list|,
name|RSN_CIPHER_SUITE_CCMP
argument_list|)
expr_stmt|;
name|pos
operator|+=
name|RSN_SELECTOR_LEN
expr_stmt|;
name|count
operator|++
expr_stmt|;
block|}
if|if
condition|(
name|sm
operator|->
name|allowed_pairwise_cipher
operator|&
name|WPA_CIPHER_TKIP
condition|)
block|{
name|RSN_SELECTOR_PUT
argument_list|(
name|pos
argument_list|,
name|RSN_CIPHER_SUITE_TKIP
argument_list|)
expr_stmt|;
name|pos
operator|+=
name|RSN_SELECTOR_LEN
expr_stmt|;
name|count
operator|++
expr_stmt|;
block|}
name|WPA_PUT_LE16
argument_list|(
name|count_pos
argument_list|,
name|count
argument_list|)
expr_stmt|;
name|hdr
operator|->
name|len
operator|=
operator|(
name|pos
operator|-
name|peerkey
operator|->
name|rsnie_i
operator|)
operator|-
literal|2
expr_stmt|;
name|peerkey
operator|->
name|rsnie_i_len
operator|=
name|pos
operator|-
name|peerkey
operator|->
name|rsnie_i
expr_stmt|;
name|wpa_hexdump
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPA: RSN IE for SMK handshake"
argument_list|,
name|peerkey
operator|->
name|rsnie_i
argument_list|,
name|peerkey
operator|->
name|rsnie_i_len
argument_list|)
expr_stmt|;
name|kde_len
operator|=
name|peerkey
operator|->
name|rsnie_i_len
operator|+
literal|2
operator|+
name|RSN_SELECTOR_LEN
operator|+
name|ETH_ALEN
expr_stmt|;
name|rbuf
operator|=
name|wpa_sm_alloc_eapol
argument_list|(
name|sm
argument_list|,
name|IEEE802_1X_TYPE_EAPOL_KEY
argument_list|,
name|NULL
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|req
argument_list|)
operator|+
name|kde_len
argument_list|,
operator|&
name|rlen
argument_list|,
operator|(
name|void
operator|*
operator|)
operator|&
name|req
argument_list|)
expr_stmt|;
if|if
condition|(
name|rbuf
operator|==
name|NULL
condition|)
block|{
name|wpa_supplicant_peerkey_free
argument_list|(
name|sm
argument_list|,
name|peerkey
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|req
operator|->
name|type
operator|=
name|EAPOL_KEY_TYPE_RSN
expr_stmt|;
name|key_info
operator|=
name|WPA_KEY_INFO_SMK_MESSAGE
operator||
name|WPA_KEY_INFO_MIC
operator||
name|WPA_KEY_INFO_SECURE
operator||
name|WPA_KEY_INFO_REQUEST
operator||
name|ver
expr_stmt|;
name|WPA_PUT_BE16
argument_list|(
name|req
operator|->
name|key_info
argument_list|,
name|key_info
argument_list|)
expr_stmt|;
name|WPA_PUT_BE16
argument_list|(
name|req
operator|->
name|key_length
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|os_memcpy
argument_list|(
name|req
operator|->
name|replay_counter
argument_list|,
name|sm
operator|->
name|request_counter
argument_list|,
name|WPA_REPLAY_COUNTER_LEN
argument_list|)
expr_stmt|;
name|inc_byte_array
argument_list|(
name|sm
operator|->
name|request_counter
argument_list|,
name|WPA_REPLAY_COUNTER_LEN
argument_list|)
expr_stmt|;
if|if
condition|(
name|os_get_random
argument_list|(
name|peerkey
operator|->
name|inonce
argument_list|,
name|WPA_NONCE_LEN
argument_list|)
condition|)
block|{
name|wpa_msg
argument_list|(
name|sm
operator|->
name|ctx
operator|->
name|ctx
argument_list|,
name|MSG_WARNING
argument_list|,
literal|"WPA: Failed to get random data for INonce"
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|rbuf
argument_list|)
expr_stmt|;
name|wpa_supplicant_peerkey_free
argument_list|(
name|sm
argument_list|,
name|peerkey
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|os_memcpy
argument_list|(
name|req
operator|->
name|key_nonce
argument_list|,
name|peerkey
operator|->
name|inonce
argument_list|,
name|WPA_NONCE_LEN
argument_list|)
expr_stmt|;
name|wpa_hexdump
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPA: INonce for SMK handshake"
argument_list|,
name|req
operator|->
name|key_nonce
argument_list|,
name|WPA_NONCE_LEN
argument_list|)
expr_stmt|;
name|WPA_PUT_BE16
argument_list|(
name|req
operator|->
name|key_data_length
argument_list|,
operator|(
name|u16
operator|)
name|kde_len
argument_list|)
expr_stmt|;
name|pos
operator|=
operator|(
name|u8
operator|*
operator|)
operator|(
name|req
operator|+
literal|1
operator|)
expr_stmt|;
comment|/* Initiator RSN IE */
name|pos
operator|=
name|wpa_add_ie
argument_list|(
name|pos
argument_list|,
name|peerkey
operator|->
name|rsnie_i
argument_list|,
name|peerkey
operator|->
name|rsnie_i_len
argument_list|)
expr_stmt|;
comment|/* Peer MAC address KDE */
name|wpa_add_kde
argument_list|(
name|pos
argument_list|,
name|RSN_KEY_DATA_MAC_ADDR
argument_list|,
name|peer
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"RSN: Sending EAPOL-Key SMK M1 Request (peer "
name|MACSTR
literal|")"
argument_list|,
name|MAC2STR
argument_list|(
name|peer
argument_list|)
argument_list|)
expr_stmt|;
name|wpa_eapol_key_send
argument_list|(
name|sm
argument_list|,
name|sm
operator|->
name|ptk
operator|.
name|kck
argument_list|,
name|ver
argument_list|,
name|bssid
argument_list|,
name|ETH_P_EAPOL
argument_list|,
name|rbuf
argument_list|,
name|rlen
argument_list|,
name|req
operator|->
name|key_mic
argument_list|)
expr_stmt|;
name|peerkey
operator|->
name|next
operator|=
name|sm
operator|->
name|peerkey
expr_stmt|;
name|sm
operator|->
name|peerkey
operator|=
name|peerkey
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/**  * peerkey_deinit - Free PeerKey values  * @sm: Pointer to WPA state machine data from wpa_sm_init()  */
end_comment

begin_function
name|void
name|peerkey_deinit
parameter_list|(
name|struct
name|wpa_sm
modifier|*
name|sm
parameter_list|)
block|{
name|struct
name|wpa_peerkey
modifier|*
name|prev
decl_stmt|,
modifier|*
name|peerkey
init|=
name|sm
operator|->
name|peerkey
decl_stmt|;
while|while
condition|(
name|peerkey
condition|)
block|{
name|prev
operator|=
name|peerkey
expr_stmt|;
name|peerkey
operator|=
name|peerkey
operator|->
name|next
expr_stmt|;
name|os_free
argument_list|(
name|prev
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
name|void
name|peerkey_rx_eapol_4way
parameter_list|(
name|struct
name|wpa_sm
modifier|*
name|sm
parameter_list|,
name|struct
name|wpa_peerkey
modifier|*
name|peerkey
parameter_list|,
name|struct
name|wpa_eapol_key
modifier|*
name|key
parameter_list|,
name|u16
name|key_info
parameter_list|,
name|u16
name|ver
parameter_list|)
block|{
if|if
condition|(
operator|(
name|key_info
operator|&
operator|(
name|WPA_KEY_INFO_MIC
operator||
name|WPA_KEY_INFO_ACK
operator|)
operator|)
operator|==
operator|(
name|WPA_KEY_INFO_MIC
operator||
name|WPA_KEY_INFO_ACK
operator|)
condition|)
block|{
comment|/* 3/4 STK 4-Way Handshake */
name|wpa_supplicant_process_stk_3_of_4
argument_list|(
name|sm
argument_list|,
name|peerkey
argument_list|,
name|key
argument_list|,
name|ver
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|key_info
operator|&
name|WPA_KEY_INFO_ACK
condition|)
block|{
comment|/* 1/4 STK 4-Way Handshake */
name|wpa_supplicant_process_stk_1_of_4
argument_list|(
name|sm
argument_list|,
name|peerkey
argument_list|,
name|key
argument_list|,
name|ver
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|key_info
operator|&
name|WPA_KEY_INFO_SECURE
condition|)
block|{
comment|/* 4/4 STK 4-Way Handshake */
name|wpa_supplicant_process_stk_4_of_4
argument_list|(
name|sm
argument_list|,
name|peerkey
argument_list|,
name|key
argument_list|,
name|ver
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|/* 2/4 STK 4-Way Handshake */
name|wpa_supplicant_process_stk_2_of_4
argument_list|(
name|sm
argument_list|,
name|peerkey
argument_list|,
name|key
argument_list|,
name|ver
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
name|void
name|peerkey_rx_eapol_smk
parameter_list|(
name|struct
name|wpa_sm
modifier|*
name|sm
parameter_list|,
specifier|const
name|u8
modifier|*
name|src_addr
parameter_list|,
name|struct
name|wpa_eapol_key
modifier|*
name|key
parameter_list|,
name|size_t
name|extra_len
parameter_list|,
name|u16
name|key_info
parameter_list|,
name|u16
name|ver
parameter_list|)
block|{
if|if
condition|(
name|key_info
operator|&
name|WPA_KEY_INFO_ERROR
condition|)
block|{
comment|/* SMK Error */
name|wpa_supplicant_process_smk_error
argument_list|(
name|sm
argument_list|,
name|src_addr
argument_list|,
name|key
argument_list|,
name|extra_len
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|key_info
operator|&
name|WPA_KEY_INFO_ACK
condition|)
block|{
comment|/* SMK M2 */
name|wpa_supplicant_process_smk_m2
argument_list|(
name|sm
argument_list|,
name|src_addr
argument_list|,
name|key
argument_list|,
name|extra_len
argument_list|,
name|ver
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|/* SMK M4 or M5 */
name|wpa_supplicant_process_smk_m45
argument_list|(
name|sm
argument_list|,
name|src_addr
argument_list|,
name|key
argument_list|,
name|extra_len
argument_list|,
name|ver
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* CONFIG_PEERKEY */
end_comment

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Wi-Fi Protected Setup - common functionality  * Copyright (c) 2008, Jouni Malinen<j@w1.fi>  *  * This program is free software; you can redistribute it and/or modify  * it under the terms of the GNU General Public License version 2 as  * published by the Free Software Foundation.  *  * Alternatively, this software may be distributed under the terms of BSD  * license.  *  * See README and COPYING for more details.  */
end_comment

begin_include
include|#
directive|include
file|"includes.h"
end_include

begin_include
include|#
directive|include
file|"common.h"
end_include

begin_include
include|#
directive|include
file|"dh_groups.h"
end_include

begin_include
include|#
directive|include
file|"sha256.h"
end_include

begin_include
include|#
directive|include
file|"aes_wrap.h"
end_include

begin_include
include|#
directive|include
file|"crypto.h"
end_include

begin_include
include|#
directive|include
file|"wps_i.h"
end_include

begin_include
include|#
directive|include
file|"wps_dev_attr.h"
end_include

begin_function
name|void
name|wps_kdf
parameter_list|(
specifier|const
name|u8
modifier|*
name|key
parameter_list|,
specifier|const
name|u8
modifier|*
name|label_prefix
parameter_list|,
name|size_t
name|label_prefix_len
parameter_list|,
specifier|const
name|char
modifier|*
name|label
parameter_list|,
name|u8
modifier|*
name|res
parameter_list|,
name|size_t
name|res_len
parameter_list|)
block|{
name|u8
name|i_buf
index|[
literal|4
index|]
decl_stmt|,
name|key_bits
index|[
literal|4
index|]
decl_stmt|;
specifier|const
name|u8
modifier|*
name|addr
index|[
literal|4
index|]
decl_stmt|;
name|size_t
name|len
index|[
literal|4
index|]
decl_stmt|;
name|int
name|i
decl_stmt|,
name|iter
decl_stmt|;
name|u8
name|hash
index|[
name|SHA256_MAC_LEN
index|]
decl_stmt|,
modifier|*
name|opos
decl_stmt|;
name|size_t
name|left
decl_stmt|;
name|WPA_PUT_BE32
argument_list|(
name|key_bits
argument_list|,
name|res_len
operator|*
literal|8
argument_list|)
expr_stmt|;
name|addr
index|[
literal|0
index|]
operator|=
name|i_buf
expr_stmt|;
name|len
index|[
literal|0
index|]
operator|=
sizeof|sizeof
argument_list|(
name|i_buf
argument_list|)
expr_stmt|;
name|addr
index|[
literal|1
index|]
operator|=
name|label_prefix
expr_stmt|;
name|len
index|[
literal|1
index|]
operator|=
name|label_prefix_len
expr_stmt|;
name|addr
index|[
literal|2
index|]
operator|=
operator|(
specifier|const
name|u8
operator|*
operator|)
name|label
expr_stmt|;
name|len
index|[
literal|2
index|]
operator|=
name|os_strlen
argument_list|(
name|label
argument_list|)
expr_stmt|;
name|addr
index|[
literal|3
index|]
operator|=
name|key_bits
expr_stmt|;
name|len
index|[
literal|3
index|]
operator|=
sizeof|sizeof
argument_list|(
name|key_bits
argument_list|)
expr_stmt|;
name|iter
operator|=
operator|(
name|res_len
operator|+
name|SHA256_MAC_LEN
operator|-
literal|1
operator|)
operator|/
name|SHA256_MAC_LEN
expr_stmt|;
name|opos
operator|=
name|res
expr_stmt|;
name|left
operator|=
name|res_len
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|1
init|;
name|i
operator|<=
name|iter
condition|;
name|i
operator|++
control|)
block|{
name|WPA_PUT_BE32
argument_list|(
name|i_buf
argument_list|,
name|i
argument_list|)
expr_stmt|;
name|hmac_sha256_vector
argument_list|(
name|key
argument_list|,
name|SHA256_MAC_LEN
argument_list|,
literal|4
argument_list|,
name|addr
argument_list|,
name|len
argument_list|,
name|hash
argument_list|)
expr_stmt|;
if|if
condition|(
name|i
operator|<
name|iter
condition|)
block|{
name|os_memcpy
argument_list|(
name|opos
argument_list|,
name|hash
argument_list|,
name|SHA256_MAC_LEN
argument_list|)
expr_stmt|;
name|opos
operator|+=
name|SHA256_MAC_LEN
expr_stmt|;
name|left
operator|-=
name|SHA256_MAC_LEN
expr_stmt|;
block|}
else|else
name|os_memcpy
argument_list|(
name|opos
argument_list|,
name|hash
argument_list|,
name|left
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
name|int
name|wps_derive_keys
parameter_list|(
name|struct
name|wps_data
modifier|*
name|wps
parameter_list|)
block|{
name|struct
name|wpabuf
modifier|*
name|pubkey
decl_stmt|,
modifier|*
name|dh_shared
decl_stmt|;
name|u8
name|dhkey
index|[
name|SHA256_MAC_LEN
index|]
decl_stmt|,
name|kdk
index|[
name|SHA256_MAC_LEN
index|]
decl_stmt|;
specifier|const
name|u8
modifier|*
name|addr
index|[
literal|3
index|]
decl_stmt|;
name|size_t
name|len
index|[
literal|3
index|]
decl_stmt|;
name|u8
name|keys
index|[
name|WPS_AUTHKEY_LEN
operator|+
name|WPS_KEYWRAPKEY_LEN
operator|+
name|WPS_EMSK_LEN
index|]
decl_stmt|;
if|if
condition|(
name|wps
operator|->
name|dh_privkey
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Own DH private key not available"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|pubkey
operator|=
name|wps
operator|->
name|registrar
condition|?
name|wps
operator|->
name|dh_pubkey_e
else|:
name|wps
operator|->
name|dh_pubkey_r
expr_stmt|;
if|if
condition|(
name|pubkey
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Peer DH public key not available"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|dh_shared
operator|=
name|dh_derive_shared
argument_list|(
name|pubkey
argument_list|,
name|wps
operator|->
name|dh_privkey
argument_list|,
name|dh_groups_get
argument_list|(
name|WPS_DH_GROUP
argument_list|)
argument_list|)
expr_stmt|;
name|dh_shared
operator|=
name|wpabuf_zeropad
argument_list|(
name|dh_shared
argument_list|,
literal|192
argument_list|)
expr_stmt|;
if|if
condition|(
name|dh_shared
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Failed to derive DH shared key"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
comment|/* Own DH private key is not needed anymore */
name|wpabuf_free
argument_list|(
name|wps
operator|->
name|dh_privkey
argument_list|)
expr_stmt|;
name|wps
operator|->
name|dh_privkey
operator|=
name|NULL
expr_stmt|;
name|wpa_hexdump_buf_key
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: DH shared key"
argument_list|,
name|dh_shared
argument_list|)
expr_stmt|;
comment|/* DHKey = SHA-256(g^AB mod p) */
name|addr
index|[
literal|0
index|]
operator|=
name|wpabuf_head
argument_list|(
name|dh_shared
argument_list|)
expr_stmt|;
name|len
index|[
literal|0
index|]
operator|=
name|wpabuf_len
argument_list|(
name|dh_shared
argument_list|)
expr_stmt|;
name|sha256_vector
argument_list|(
literal|1
argument_list|,
name|addr
argument_list|,
name|len
argument_list|,
name|dhkey
argument_list|)
expr_stmt|;
name|wpa_hexdump_key
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: DHKey"
argument_list|,
name|dhkey
argument_list|,
sizeof|sizeof
argument_list|(
name|dhkey
argument_list|)
argument_list|)
expr_stmt|;
name|wpabuf_free
argument_list|(
name|dh_shared
argument_list|)
expr_stmt|;
comment|/* KDK = HMAC-SHA-256_DHKey(N1 || EnrolleeMAC || N2) */
name|addr
index|[
literal|0
index|]
operator|=
name|wps
operator|->
name|nonce_e
expr_stmt|;
name|len
index|[
literal|0
index|]
operator|=
name|WPS_NONCE_LEN
expr_stmt|;
name|addr
index|[
literal|1
index|]
operator|=
name|wps
operator|->
name|mac_addr_e
expr_stmt|;
name|len
index|[
literal|1
index|]
operator|=
name|ETH_ALEN
expr_stmt|;
name|addr
index|[
literal|2
index|]
operator|=
name|wps
operator|->
name|nonce_r
expr_stmt|;
name|len
index|[
literal|2
index|]
operator|=
name|WPS_NONCE_LEN
expr_stmt|;
name|hmac_sha256_vector
argument_list|(
name|dhkey
argument_list|,
sizeof|sizeof
argument_list|(
name|dhkey
argument_list|)
argument_list|,
literal|3
argument_list|,
name|addr
argument_list|,
name|len
argument_list|,
name|kdk
argument_list|)
expr_stmt|;
name|wpa_hexdump_key
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: KDK"
argument_list|,
name|kdk
argument_list|,
sizeof|sizeof
argument_list|(
name|kdk
argument_list|)
argument_list|)
expr_stmt|;
name|wps_kdf
argument_list|(
name|kdk
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|,
literal|"Wi-Fi Easy and Secure Key Derivation"
argument_list|,
name|keys
argument_list|,
sizeof|sizeof
argument_list|(
name|keys
argument_list|)
argument_list|)
expr_stmt|;
name|os_memcpy
argument_list|(
name|wps
operator|->
name|authkey
argument_list|,
name|keys
argument_list|,
name|WPS_AUTHKEY_LEN
argument_list|)
expr_stmt|;
name|os_memcpy
argument_list|(
name|wps
operator|->
name|keywrapkey
argument_list|,
name|keys
operator|+
name|WPS_AUTHKEY_LEN
argument_list|,
name|WPS_KEYWRAPKEY_LEN
argument_list|)
expr_stmt|;
name|os_memcpy
argument_list|(
name|wps
operator|->
name|emsk
argument_list|,
name|keys
operator|+
name|WPS_AUTHKEY_LEN
operator|+
name|WPS_KEYWRAPKEY_LEN
argument_list|,
name|WPS_EMSK_LEN
argument_list|)
expr_stmt|;
name|wpa_hexdump_key
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: AuthKey"
argument_list|,
name|wps
operator|->
name|authkey
argument_list|,
name|WPS_AUTHKEY_LEN
argument_list|)
expr_stmt|;
name|wpa_hexdump_key
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: KeyWrapKey"
argument_list|,
name|wps
operator|->
name|keywrapkey
argument_list|,
name|WPS_KEYWRAPKEY_LEN
argument_list|)
expr_stmt|;
name|wpa_hexdump_key
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: EMSK"
argument_list|,
name|wps
operator|->
name|emsk
argument_list|,
name|WPS_EMSK_LEN
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|int
name|wps_derive_mgmt_keys
parameter_list|(
name|struct
name|wps_data
modifier|*
name|wps
parameter_list|)
block|{
name|u8
name|nonces
index|[
literal|2
operator|*
name|WPS_NONCE_LEN
index|]
decl_stmt|;
name|u8
name|keys
index|[
name|WPS_MGMTAUTHKEY_LEN
operator|+
name|WPS_MGMTENCKEY_LEN
index|]
decl_stmt|;
name|u8
name|hash
index|[
name|SHA256_MAC_LEN
index|]
decl_stmt|;
specifier|const
name|u8
modifier|*
name|addr
index|[
literal|2
index|]
decl_stmt|;
name|size_t
name|len
index|[
literal|2
index|]
decl_stmt|;
specifier|const
name|char
modifier|*
name|auth_label
init|=
literal|"WFA-WLAN-Management-MgmtAuthKey"
decl_stmt|;
specifier|const
name|char
modifier|*
name|enc_label
init|=
literal|"WFA-WLAN-Management-MgmtEncKey"
decl_stmt|;
comment|/* MgmtAuthKey || MgmtEncKey = 	 * kdf(EMSK, N1 || N2 || "WFA-WLAN-Management-Keys", 384) */
name|os_memcpy
argument_list|(
name|nonces
argument_list|,
name|wps
operator|->
name|nonce_e
argument_list|,
name|WPS_NONCE_LEN
argument_list|)
expr_stmt|;
name|os_memcpy
argument_list|(
name|nonces
operator|+
name|WPS_NONCE_LEN
argument_list|,
name|wps
operator|->
name|nonce_r
argument_list|,
name|WPS_NONCE_LEN
argument_list|)
expr_stmt|;
name|wps_kdf
argument_list|(
name|wps
operator|->
name|emsk
argument_list|,
name|nonces
argument_list|,
sizeof|sizeof
argument_list|(
name|nonces
argument_list|)
argument_list|,
literal|"WFA-WLAN-Management-Keys"
argument_list|,
name|keys
argument_list|,
sizeof|sizeof
argument_list|(
name|keys
argument_list|)
argument_list|)
expr_stmt|;
name|os_memcpy
argument_list|(
name|wps
operator|->
name|mgmt_auth_key
argument_list|,
name|keys
argument_list|,
name|WPS_MGMTAUTHKEY_LEN
argument_list|)
expr_stmt|;
name|os_memcpy
argument_list|(
name|wps
operator|->
name|mgmt_enc_key
argument_list|,
name|keys
operator|+
name|WPS_MGMTAUTHKEY_LEN
argument_list|,
name|WPS_MGMTENCKEY_LEN
argument_list|)
expr_stmt|;
name|addr
index|[
literal|0
index|]
operator|=
name|nonces
expr_stmt|;
name|len
index|[
literal|0
index|]
operator|=
sizeof|sizeof
argument_list|(
name|nonces
argument_list|)
expr_stmt|;
comment|/* MgmtEncKeyID = first 128 bits of 	 * SHA-256(N1 || N2 || "WFA-WLAN-Management-MgmtAuthKey") */
name|addr
index|[
literal|1
index|]
operator|=
operator|(
specifier|const
name|u8
operator|*
operator|)
name|auth_label
expr_stmt|;
name|len
index|[
literal|1
index|]
operator|=
name|os_strlen
argument_list|(
name|auth_label
argument_list|)
expr_stmt|;
name|sha256_vector
argument_list|(
literal|2
argument_list|,
name|addr
argument_list|,
name|len
argument_list|,
name|hash
argument_list|)
expr_stmt|;
name|os_memcpy
argument_list|(
name|wps
operator|->
name|mgmt_auth_key_id
argument_list|,
name|hash
argument_list|,
name|WPS_MGMT_KEY_ID_LEN
argument_list|)
expr_stmt|;
comment|/* MgmtEncKeyID = first 128 bits of 	 * SHA-256(N1 || N2 || "WFA-WLAN-Management-MgmtEncKey") */
name|addr
index|[
literal|1
index|]
operator|=
operator|(
specifier|const
name|u8
operator|*
operator|)
name|enc_label
expr_stmt|;
name|len
index|[
literal|1
index|]
operator|=
name|os_strlen
argument_list|(
name|enc_label
argument_list|)
expr_stmt|;
name|sha256_vector
argument_list|(
literal|2
argument_list|,
name|addr
argument_list|,
name|len
argument_list|,
name|hash
argument_list|)
expr_stmt|;
name|os_memcpy
argument_list|(
name|wps
operator|->
name|mgmt_enc_key_id
argument_list|,
name|hash
argument_list|,
name|WPS_MGMT_KEY_ID_LEN
argument_list|)
expr_stmt|;
name|wpa_hexdump_key
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: MgmtAuthKey"
argument_list|,
name|wps
operator|->
name|mgmt_auth_key
argument_list|,
name|WPS_MGMTAUTHKEY_LEN
argument_list|)
expr_stmt|;
name|wpa_hexdump
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: MgmtAuthKeyID"
argument_list|,
name|wps
operator|->
name|mgmt_auth_key_id
argument_list|,
name|WPS_MGMT_KEY_ID_LEN
argument_list|)
expr_stmt|;
name|wpa_hexdump_key
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: MgmtEncKey"
argument_list|,
name|wps
operator|->
name|mgmt_enc_key
argument_list|,
name|WPS_MGMTENCKEY_LEN
argument_list|)
expr_stmt|;
name|wpa_hexdump
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: MgmtEncKeyID"
argument_list|,
name|wps
operator|->
name|mgmt_enc_key_id
argument_list|,
name|WPS_MGMT_KEY_ID_LEN
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|void
name|wps_derive_psk
parameter_list|(
name|struct
name|wps_data
modifier|*
name|wps
parameter_list|,
specifier|const
name|u8
modifier|*
name|dev_passwd
parameter_list|,
name|size_t
name|dev_passwd_len
parameter_list|)
block|{
name|u8
name|hash
index|[
name|SHA256_MAC_LEN
index|]
decl_stmt|;
name|hmac_sha256
argument_list|(
name|wps
operator|->
name|authkey
argument_list|,
name|WPS_AUTHKEY_LEN
argument_list|,
name|dev_passwd
argument_list|,
operator|(
name|dev_passwd_len
operator|+
literal|1
operator|)
operator|/
literal|2
argument_list|,
name|hash
argument_list|)
expr_stmt|;
name|os_memcpy
argument_list|(
name|wps
operator|->
name|psk1
argument_list|,
name|hash
argument_list|,
name|WPS_PSK_LEN
argument_list|)
expr_stmt|;
name|hmac_sha256
argument_list|(
name|wps
operator|->
name|authkey
argument_list|,
name|WPS_AUTHKEY_LEN
argument_list|,
name|dev_passwd
operator|+
operator|(
name|dev_passwd_len
operator|+
literal|1
operator|)
operator|/
literal|2
argument_list|,
name|dev_passwd_len
operator|/
literal|2
argument_list|,
name|hash
argument_list|)
expr_stmt|;
name|os_memcpy
argument_list|(
name|wps
operator|->
name|psk2
argument_list|,
name|hash
argument_list|,
name|WPS_PSK_LEN
argument_list|)
expr_stmt|;
name|wpa_hexdump_ascii_key
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Device Password"
argument_list|,
name|dev_passwd
argument_list|,
name|dev_passwd_len
argument_list|)
expr_stmt|;
name|wpa_hexdump_key
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: PSK1"
argument_list|,
name|wps
operator|->
name|psk1
argument_list|,
name|WPS_PSK_LEN
argument_list|)
expr_stmt|;
name|wpa_hexdump_key
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: PSK2"
argument_list|,
name|wps
operator|->
name|psk2
argument_list|,
name|WPS_PSK_LEN
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|struct
name|wpabuf
modifier|*
name|wps_decrypt_encr_settings
parameter_list|(
name|struct
name|wps_data
modifier|*
name|wps
parameter_list|,
specifier|const
name|u8
modifier|*
name|encr
parameter_list|,
name|size_t
name|encr_len
parameter_list|)
block|{
name|struct
name|wpabuf
modifier|*
name|decrypted
decl_stmt|;
specifier|const
name|size_t
name|block_size
init|=
literal|16
decl_stmt|;
name|size_t
name|i
decl_stmt|;
name|u8
name|pad
decl_stmt|;
specifier|const
name|u8
modifier|*
name|pos
decl_stmt|;
comment|/* AES-128-CBC */
if|if
condition|(
name|encr
operator|==
name|NULL
operator|||
name|encr_len
operator|<
literal|2
operator|*
name|block_size
operator|||
name|encr_len
operator|%
name|block_size
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: No Encrypted Settings received"
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|decrypted
operator|=
name|wpabuf_alloc
argument_list|(
name|encr_len
operator|-
name|block_size
argument_list|)
expr_stmt|;
if|if
condition|(
name|decrypted
operator|==
name|NULL
condition|)
return|return
name|NULL
return|;
name|wpa_hexdump
argument_list|(
name|MSG_MSGDUMP
argument_list|,
literal|"WPS: Encrypted Settings"
argument_list|,
name|encr
argument_list|,
name|encr_len
argument_list|)
expr_stmt|;
name|wpabuf_put_data
argument_list|(
name|decrypted
argument_list|,
name|encr
operator|+
name|block_size
argument_list|,
name|encr_len
operator|-
name|block_size
argument_list|)
expr_stmt|;
if|if
condition|(
name|aes_128_cbc_decrypt
argument_list|(
name|wps
operator|->
name|keywrapkey
argument_list|,
name|encr
argument_list|,
name|wpabuf_mhead
argument_list|(
name|decrypted
argument_list|)
argument_list|,
name|wpabuf_len
argument_list|(
name|decrypted
argument_list|)
argument_list|)
condition|)
block|{
name|wpabuf_free
argument_list|(
name|decrypted
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|wpa_hexdump_buf_key
argument_list|(
name|MSG_MSGDUMP
argument_list|,
literal|"WPS: Decrypted Encrypted Settings"
argument_list|,
name|decrypted
argument_list|)
expr_stmt|;
name|pos
operator|=
name|wpabuf_head_u8
argument_list|(
name|decrypted
argument_list|)
operator|+
name|wpabuf_len
argument_list|(
name|decrypted
argument_list|)
operator|-
literal|1
expr_stmt|;
name|pad
operator|=
operator|*
name|pos
expr_stmt|;
if|if
condition|(
name|pad
operator|>
name|wpabuf_len
argument_list|(
name|decrypted
argument_list|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Invalid PKCS#5 v2.0 pad value"
argument_list|)
expr_stmt|;
name|wpabuf_free
argument_list|(
name|decrypted
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|pad
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
operator|*
name|pos
operator|--
operator|!=
name|pad
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Invalid PKCS#5 v2.0 pad "
literal|"string"
argument_list|)
expr_stmt|;
name|wpabuf_free
argument_list|(
name|decrypted
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
block|}
name|decrypted
operator|->
name|used
operator|-=
name|pad
expr_stmt|;
return|return
name|decrypted
return|;
block|}
end_function

begin_comment
comment|/**  * wps_pin_checksum - Compute PIN checksum  * @pin: Seven digit PIN (i.e., eight digit PIN without the checksum digit)  * Returns: Checksum digit  */
end_comment

begin_function
name|unsigned
name|int
name|wps_pin_checksum
parameter_list|(
name|unsigned
name|int
name|pin
parameter_list|)
block|{
name|unsigned
name|int
name|accum
init|=
literal|0
decl_stmt|;
while|while
condition|(
name|pin
condition|)
block|{
name|accum
operator|+=
literal|3
operator|*
operator|(
name|pin
operator|%
literal|10
operator|)
expr_stmt|;
name|pin
operator|/=
literal|10
expr_stmt|;
name|accum
operator|+=
name|pin
operator|%
literal|10
expr_stmt|;
name|pin
operator|/=
literal|10
expr_stmt|;
block|}
return|return
operator|(
literal|10
operator|-
name|accum
operator|%
literal|10
operator|)
operator|%
literal|10
return|;
block|}
end_function

begin_comment
comment|/**  * wps_pin_valid - Check whether a PIN has a valid checksum  * @pin: Eight digit PIN (i.e., including the checksum digit)  * Returns: 1 if checksum digit is valid, or 0 if not  */
end_comment

begin_function
name|unsigned
name|int
name|wps_pin_valid
parameter_list|(
name|unsigned
name|int
name|pin
parameter_list|)
block|{
return|return
name|wps_pin_checksum
argument_list|(
name|pin
operator|/
literal|10
argument_list|)
operator|==
operator|(
name|pin
operator|%
literal|10
operator|)
return|;
block|}
end_function

begin_comment
comment|/**  * wps_generate_pin - Generate a random PIN  * Returns: Eight digit PIN (i.e., including the checksum digit)  */
end_comment

begin_function
name|unsigned
name|int
name|wps_generate_pin
parameter_list|(
name|void
parameter_list|)
block|{
name|unsigned
name|int
name|val
decl_stmt|;
comment|/* Generate seven random digits for the PIN */
if|if
condition|(
name|os_get_random
argument_list|(
operator|(
name|unsigned
name|char
operator|*
operator|)
operator|&
name|val
argument_list|,
sizeof|sizeof
argument_list|(
name|val
argument_list|)
argument_list|)
operator|<
literal|0
condition|)
block|{
name|struct
name|os_time
name|now
decl_stmt|;
name|os_get_time
argument_list|(
operator|&
name|now
argument_list|)
expr_stmt|;
name|val
operator|=
name|os_random
argument_list|()
operator|^
name|now
operator|.
name|sec
operator|^
name|now
operator|.
name|usec
expr_stmt|;
block|}
name|val
operator|%=
literal|10000000
expr_stmt|;
comment|/* Append checksum digit */
return|return
name|val
operator|*
literal|10
operator|+
name|wps_pin_checksum
argument_list|(
name|val
argument_list|)
return|;
block|}
end_function

begin_function
name|void
name|wps_fail_event
parameter_list|(
name|struct
name|wps_context
modifier|*
name|wps
parameter_list|,
name|enum
name|wps_msg_type
name|msg
parameter_list|)
block|{
name|union
name|wps_event_data
name|data
decl_stmt|;
if|if
condition|(
name|wps
operator|->
name|event_cb
operator|==
name|NULL
condition|)
return|return;
name|os_memset
argument_list|(
operator|&
name|data
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|data
argument_list|)
argument_list|)
expr_stmt|;
name|data
operator|.
name|fail
operator|.
name|msg
operator|=
name|msg
expr_stmt|;
name|wps
operator|->
name|event_cb
argument_list|(
name|wps
operator|->
name|cb_ctx
argument_list|,
name|WPS_EV_FAIL
argument_list|,
operator|&
name|data
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|wps_success_event
parameter_list|(
name|struct
name|wps_context
modifier|*
name|wps
parameter_list|)
block|{
if|if
condition|(
name|wps
operator|->
name|event_cb
operator|==
name|NULL
condition|)
return|return;
name|wps
operator|->
name|event_cb
argument_list|(
name|wps
operator|->
name|cb_ctx
argument_list|,
name|WPS_EV_SUCCESS
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|wps_pwd_auth_fail_event
parameter_list|(
name|struct
name|wps_context
modifier|*
name|wps
parameter_list|,
name|int
name|enrollee
parameter_list|,
name|int
name|part
parameter_list|)
block|{
name|union
name|wps_event_data
name|data
decl_stmt|;
if|if
condition|(
name|wps
operator|->
name|event_cb
operator|==
name|NULL
condition|)
return|return;
name|os_memset
argument_list|(
operator|&
name|data
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|data
argument_list|)
argument_list|)
expr_stmt|;
name|data
operator|.
name|pwd_auth_fail
operator|.
name|enrollee
operator|=
name|enrollee
expr_stmt|;
name|data
operator|.
name|pwd_auth_fail
operator|.
name|part
operator|=
name|part
expr_stmt|;
name|wps
operator|->
name|event_cb
argument_list|(
name|wps
operator|->
name|cb_ctx
argument_list|,
name|WPS_EV_PWD_AUTH_FAIL
argument_list|,
operator|&
name|data
argument_list|)
expr_stmt|;
block|}
end_function

end_unit


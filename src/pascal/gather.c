begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_include
include|#
directive|include
file|<ctype.h>
end_include

begin_include
include|#
directive|include
file|<sys/types.h>
end_include

begin_include
include|#
directive|include
file|<sys/stat.h>
end_include

begin_define
define|#
directive|define
name|fstat
value|_fstat
end_define

begin_comment
comment|/*  * Gather -code file  *  * Code indicates the exit status.  * File is the primary file name.  * We don't deal with #include here.  */
end_comment

begin_decl_stmt
name|char
modifier|*
name|pxerrs
index|[]
block|{
literal|"NORMAL"
operator|,
literal|"CHR"
operator|,
literal|"DIVCHK"
operator|,
literal|"FDIVCHK"
operator|,
literal|"HALT"
operator|,
literal|"NILPTR"
operator|,
literal|"PASTEOF"
operator|,
literal|"SQRT"
operator|,
literal|"STKNEMP"
operator|,
literal|"SUBSCR"
operator|,
literal|"REFINAF"
operator|,
literal|"WRITE"
operator|,
literal|"CREATE"
operator|,
literal|"LN"
operator|,
literal|"BADOP"
operator|,
literal|"BADINUM"
operator|,
literal|"GOTO"
operator|,
literal|"CASE"
operator|,
literal|"SEEK"
operator|,
literal|"ALLOC"
operator|,
literal|"OUTOFMEM"
operator|,
literal|"CTTOT"
operator|,
literal|"TOODIGITS"
operator|,
literal|"MODCHK"
operator|,
literal|"BADFNUM"
operator|,
literal|"REMOVE"
operator|,
literal|"CLOSE"
operator|,
literal|"OPEN"
operator|,
literal|"ARGV"
operator|,
literal|"PACK"
operator|,
literal|"UNPACK"
operator|,
literal|"RANGE"
operator|,
literal|"ASRT"
operator|,
literal|"READIT"
operator|,
literal|"WRITEIT"
operator|,
literal|"BIGGIE"
operator|,
literal|"STLIM"
operator|,
literal|"STKOVFLO"
operator|,
literal|"INTR"
operator|,
literal|"FPOVFLO"
block|}
end_decl_stmt

begin_empty_stmt
empty_stmt|;
end_empty_stmt

begin_decl_stmt
name|char
modifier|*
name|pierrs
index|[]
block|{
literal|"AOK"
operator|,
literal|"ERRS"
operator|,
literal|"NOSTART"
operator|,
literal|"DIED"
block|}
end_decl_stmt

begin_empty_stmt
empty_stmt|;
end_empty_stmt

begin_decl_stmt
name|char
name|gatherdir
index|[]
init|=
literal|"/d/gather"
decl_stmt|;
end_decl_stmt

begin_define
define|#
directive|define
name|GATHERID
value|7
end_define

begin_function
name|main
parameter_list|(
name|argc
parameter_list|,
name|argv
parameter_list|)
name|int
name|argc
decl_stmt|;
name|char
modifier|*
name|argv
index|[]
decl_stmt|;
block|{
name|FILE
modifier|*
name|control
decl_stmt|;
name|long
name|curtime
decl_stmt|;
specifier|register
name|int
name|c
decl_stmt|;
name|char
name|namebuf
index|[
literal|10
index|]
decl_stmt|;
name|struct
name|stat
name|stbuf
decl_stmt|;
specifier|register
name|char
modifier|*
name|cp
decl_stmt|;
name|argc
operator|--
operator|,
name|argv
operator|++
expr_stmt|;
if|if
condition|(
name|argc
operator|!=
literal|2
operator|||
name|argv
index|[
literal|0
index|]
index|[
literal|0
index|]
operator|!=
literal|'-'
operator|||
operator|!
name|digit
argument_list|(
name|argv
index|[
literal|0
index|]
index|[
literal|1
index|]
argument_list|)
condition|)
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|strcmp
argument_list|(
name|argv
index|[
literal|1
index|]
argument_list|,
literal|"px"
argument_list|)
operator|!=
literal|0
operator|&&
name|freopen
argument_list|(
name|argv
index|[
literal|1
index|]
argument_list|,
literal|"r"
argument_list|,
name|stdin
argument_list|)
operator|==
name|NULL
condition|)
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|chdir
argument_list|(
name|gatherdir
argument_list|)
operator|<
literal|0
condition|)
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|getname
argument_list|(
name|getuid
argument_list|()
argument_list|,
name|namebuf
argument_list|)
operator|<
literal|0
condition|)
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|chdir
argument_list|(
name|namebuf
argument_list|)
operator|<
literal|0
condition|)
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
name|control
operator|=
name|fopen
argument_list|(
literal|"control"
argument_list|,
literal|"a"
argument_list|)
expr_stmt|;
if|if
condition|(
name|control
operator|==
name|NULL
condition|)
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
name|time
argument_list|(
operator|&
name|curtime
argument_list|)
expr_stmt|;
name|fstat
argument_list|(
name|fileno
argument_list|(
name|control
argument_list|)
argument_list|,
operator|&
name|stbuf
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|control
argument_list|,
literal|"%07D.p\t%s\t%s\t%s"
argument_list|,
name|stbuf
operator|.
name|st_size
argument_list|,
name|decomp
argument_list|(
name|argv
index|[
literal|0
index|]
argument_list|,
name|argv
index|[
literal|1
index|]
argument_list|)
argument_list|,
name|argv
index|[
literal|1
index|]
argument_list|,
name|ctime
argument_list|(
operator|&
name|curtime
argument_list|)
argument_list|)
expr_stmt|;
name|fflush
argument_list|(
name|control
argument_list|)
expr_stmt|;
name|fclose
argument_list|(
name|control
argument_list|)
expr_stmt|;
name|sprintf
argument_list|(
name|namebuf
argument_list|,
literal|"%07D.p"
argument_list|,
name|stbuf
operator|.
name|st_size
argument_list|)
expr_stmt|;
if|if
condition|(
name|strcmp
argument_list|(
name|argv
index|[
literal|0
index|]
argument_list|,
literal|"-0"
argument_list|)
operator|==
literal|0
operator|||
name|strcmp
argument_list|(
name|argv
index|[
literal|1
index|]
argument_list|,
literal|"px"
argument_list|)
operator|==
literal|0
operator|||
name|strcmp
argument_list|(
name|argv
index|[
literal|0
index|]
argument_list|,
literal|"-2"
argument_list|)
operator|==
literal|0
condition|)
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
name|setuid
argument_list|(
name|GATHERID
argument_list|)
expr_stmt|;
if|if
condition|(
name|freopen
argument_list|(
name|namebuf
argument_list|,
literal|"w"
argument_list|,
name|stdout
argument_list|)
operator|==
name|NULL
condition|)
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
for|for
control|(
init|;
condition|;
control|)
block|{
name|c
operator|=
name|getc
argument_list|(
name|stdin
argument_list|)
expr_stmt|;
if|if
condition|(
name|c
operator|<
literal|0
condition|)
name|exit
argument_list|(
literal|0
argument_list|)
expr_stmt|;
name|putchar
argument_list|(
name|c
argument_list|)
expr_stmt|;
if|if
condition|(
name|ferror
argument_list|(
name|stdout
argument_list|)
condition|)
block|{
name|unlink
argument_list|(
name|namebuf
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
block|}
block|}
end_function

begin_macro
name|any
argument_list|(
argument|c
argument_list|,
argument|cp
argument_list|)
end_macro

begin_decl_stmt
name|int
name|c
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|char
modifier|*
name|cp
decl_stmt|;
end_decl_stmt

begin_block
block|{
while|while
condition|(
operator|*
name|cp
condition|)
if|if
condition|(
name|c
operator|==
operator|*
name|cp
operator|++
condition|)
return|return
operator|(
literal|1
operator|)
return|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_block

begin_macro
name|digit
argument_list|(
argument|c
argument_list|)
end_macro

begin_decl_stmt
name|char
name|c
decl_stmt|;
end_decl_stmt

begin_block
block|{
return|return
operator|(
name|c
operator|>=
literal|'0'
operator|&&
name|c
operator|<=
literal|'9'
operator|)
return|;
block|}
end_block

begin_expr_stmt
name|decomp
argument_list|(
name|cp
argument_list|,
name|dp
argument_list|)
specifier|register
name|char
operator|*
name|cp
expr_stmt|;
end_expr_stmt

begin_decl_stmt
name|char
modifier|*
name|dp
decl_stmt|;
end_decl_stmt

begin_block
block|{
specifier|register
name|int
name|i
decl_stmt|;
if|if
condition|(
operator|*
name|cp
operator|++
operator|!=
literal|'-'
condition|)
return|return
operator|(
operator|--
name|cp
operator|)
return|;
name|i
operator|=
literal|0
expr_stmt|;
while|while
condition|(
operator|*
name|cp
condition|)
name|i
operator|=
name|i
operator|*
literal|10
operator|+
operator|*
name|cp
operator|++
operator|-
literal|'0'
expr_stmt|;
if|if
condition|(
name|strcmp
argument_list|(
name|dp
argument_list|,
literal|"px"
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|i
operator|<
literal|0
operator|||
name|i
operator|>=
operator|(
operator|(
sizeof|sizeof
name|pxerrs
operator|)
operator|/
operator|(
sizeof|sizeof
name|pxerrs
index|[
literal|0
index|]
operator|)
operator|)
condition|)
return|return
operator|(
literal|"?????"
operator|)
return|;
return|return
operator|(
name|pxerrs
index|[
name|i
index|]
operator|)
return|;
block|}
else|else
block|{
if|if
condition|(
name|i
operator|<
literal|0
operator|||
name|i
operator|>=
operator|(
operator|(
sizeof|sizeof
name|pierrs
operator|)
operator|/
operator|(
sizeof|sizeof
name|pierrs
index|[
literal|0
index|]
operator|)
operator|)
condition|)
return|return
operator|(
literal|"?????"
operator|)
return|;
return|return
operator|(
name|pierrs
index|[
name|i
index|]
operator|)
return|;
block|}
block|}
end_block

end_unit


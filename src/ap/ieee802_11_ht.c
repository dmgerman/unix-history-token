begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * hostapd / IEEE 802.11n HT  * Copyright (c) 2002-2009, Jouni Malinen<j@w1.fi>  * Copyright (c) 2007-2008, Intel Corporation  *  * This software may be distributed under the terms of the BSD license.  * See README for more details.  */
end_comment

begin_include
include|#
directive|include
file|"utils/includes.h"
end_include

begin_include
include|#
directive|include
file|"utils/common.h"
end_include

begin_include
include|#
directive|include
file|"utils/eloop.h"
end_include

begin_include
include|#
directive|include
file|"common/ieee802_11_defs.h"
end_include

begin_include
include|#
directive|include
file|"hostapd.h"
end_include

begin_include
include|#
directive|include
file|"ap_config.h"
end_include

begin_include
include|#
directive|include
file|"sta_info.h"
end_include

begin_include
include|#
directive|include
file|"beacon.h"
end_include

begin_include
include|#
directive|include
file|"ieee802_11.h"
end_include

begin_include
include|#
directive|include
file|"hw_features.h"
end_include

begin_include
include|#
directive|include
file|"ap_drv_ops.h"
end_include

begin_function
name|u8
modifier|*
name|hostapd_eid_ht_capabilities
parameter_list|(
name|struct
name|hostapd_data
modifier|*
name|hapd
parameter_list|,
name|u8
modifier|*
name|eid
parameter_list|)
block|{
name|struct
name|ieee80211_ht_capabilities
modifier|*
name|cap
decl_stmt|;
name|u8
modifier|*
name|pos
init|=
name|eid
decl_stmt|;
if|if
condition|(
operator|!
name|hapd
operator|->
name|iconf
operator|->
name|ieee80211n
operator|||
operator|!
name|hapd
operator|->
name|iface
operator|->
name|current_mode
operator|||
name|hapd
operator|->
name|conf
operator|->
name|disable_11n
condition|)
return|return
name|eid
return|;
operator|*
name|pos
operator|++
operator|=
name|WLAN_EID_HT_CAP
expr_stmt|;
operator|*
name|pos
operator|++
operator|=
sizeof|sizeof
argument_list|(
operator|*
name|cap
argument_list|)
expr_stmt|;
name|cap
operator|=
operator|(
expr|struct
name|ieee80211_ht_capabilities
operator|*
operator|)
name|pos
expr_stmt|;
name|os_memset
argument_list|(
name|cap
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|cap
argument_list|)
argument_list|)
expr_stmt|;
name|cap
operator|->
name|ht_capabilities_info
operator|=
name|host_to_le16
argument_list|(
name|hapd
operator|->
name|iconf
operator|->
name|ht_capab
argument_list|)
expr_stmt|;
name|cap
operator|->
name|a_mpdu_params
operator|=
name|hapd
operator|->
name|iface
operator|->
name|current_mode
operator|->
name|a_mpdu_params
expr_stmt|;
name|os_memcpy
argument_list|(
name|cap
operator|->
name|supported_mcs_set
argument_list|,
name|hapd
operator|->
name|iface
operator|->
name|current_mode
operator|->
name|mcs_set
argument_list|,
literal|16
argument_list|)
expr_stmt|;
comment|/* TODO: ht_extended_capabilities (now fully disabled) */
comment|/* TODO: tx_bf_capability_info (now fully disabled) */
comment|/* TODO: asel_capabilities (now fully disabled) */
name|pos
operator|+=
sizeof|sizeof
argument_list|(
operator|*
name|cap
argument_list|)
expr_stmt|;
if|if
condition|(
name|hapd
operator|->
name|iconf
operator|->
name|obss_interval
condition|)
block|{
name|struct
name|ieee80211_obss_scan_parameters
modifier|*
name|scan_params
decl_stmt|;
operator|*
name|pos
operator|++
operator|=
name|WLAN_EID_OVERLAPPING_BSS_SCAN_PARAMS
expr_stmt|;
operator|*
name|pos
operator|++
operator|=
sizeof|sizeof
argument_list|(
operator|*
name|scan_params
argument_list|)
expr_stmt|;
name|scan_params
operator|=
operator|(
expr|struct
name|ieee80211_obss_scan_parameters
operator|*
operator|)
name|pos
expr_stmt|;
name|os_memset
argument_list|(
name|scan_params
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|scan_params
argument_list|)
argument_list|)
expr_stmt|;
name|scan_params
operator|->
name|width_trigger_scan_interval
operator|=
name|host_to_le16
argument_list|(
name|hapd
operator|->
name|iconf
operator|->
name|obss_interval
argument_list|)
expr_stmt|;
comment|/* Fill in default values for remaining parameters 		 * (IEEE Std 802.11-2012, 8.4.2.61 and MIB defval) */
name|scan_params
operator|->
name|scan_passive_dwell
operator|=
name|host_to_le16
argument_list|(
literal|20
argument_list|)
expr_stmt|;
name|scan_params
operator|->
name|scan_active_dwell
operator|=
name|host_to_le16
argument_list|(
literal|10
argument_list|)
expr_stmt|;
name|scan_params
operator|->
name|scan_passive_total_per_channel
operator|=
name|host_to_le16
argument_list|(
literal|200
argument_list|)
expr_stmt|;
name|scan_params
operator|->
name|scan_active_total_per_channel
operator|=
name|host_to_le16
argument_list|(
literal|20
argument_list|)
expr_stmt|;
name|scan_params
operator|->
name|channel_transition_delay_factor
operator|=
name|host_to_le16
argument_list|(
literal|5
argument_list|)
expr_stmt|;
name|scan_params
operator|->
name|scan_activity_threshold
operator|=
name|host_to_le16
argument_list|(
literal|25
argument_list|)
expr_stmt|;
name|pos
operator|+=
sizeof|sizeof
argument_list|(
operator|*
name|scan_params
argument_list|)
expr_stmt|;
block|}
return|return
name|pos
return|;
block|}
end_function

begin_function
name|u8
modifier|*
name|hostapd_eid_ht_operation
parameter_list|(
name|struct
name|hostapd_data
modifier|*
name|hapd
parameter_list|,
name|u8
modifier|*
name|eid
parameter_list|)
block|{
name|struct
name|ieee80211_ht_operation
modifier|*
name|oper
decl_stmt|;
name|u8
modifier|*
name|pos
init|=
name|eid
decl_stmt|;
if|if
condition|(
operator|!
name|hapd
operator|->
name|iconf
operator|->
name|ieee80211n
operator|||
name|hapd
operator|->
name|conf
operator|->
name|disable_11n
condition|)
return|return
name|eid
return|;
operator|*
name|pos
operator|++
operator|=
name|WLAN_EID_HT_OPERATION
expr_stmt|;
operator|*
name|pos
operator|++
operator|=
sizeof|sizeof
argument_list|(
operator|*
name|oper
argument_list|)
expr_stmt|;
name|oper
operator|=
operator|(
expr|struct
name|ieee80211_ht_operation
operator|*
operator|)
name|pos
expr_stmt|;
name|os_memset
argument_list|(
name|oper
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|oper
argument_list|)
argument_list|)
expr_stmt|;
name|oper
operator|->
name|primary_chan
operator|=
name|hapd
operator|->
name|iconf
operator|->
name|channel
expr_stmt|;
name|oper
operator|->
name|operation_mode
operator|=
name|host_to_le16
argument_list|(
name|hapd
operator|->
name|iface
operator|->
name|ht_op_mode
argument_list|)
expr_stmt|;
if|if
condition|(
name|hapd
operator|->
name|iconf
operator|->
name|secondary_channel
operator|==
literal|1
condition|)
name|oper
operator|->
name|ht_param
operator||=
name|HT_INFO_HT_PARAM_SECONDARY_CHNL_ABOVE
operator||
name|HT_INFO_HT_PARAM_STA_CHNL_WIDTH
expr_stmt|;
if|if
condition|(
name|hapd
operator|->
name|iconf
operator|->
name|secondary_channel
operator|==
operator|-
literal|1
condition|)
name|oper
operator|->
name|ht_param
operator||=
name|HT_INFO_HT_PARAM_SECONDARY_CHNL_BELOW
operator||
name|HT_INFO_HT_PARAM_STA_CHNL_WIDTH
expr_stmt|;
name|pos
operator|+=
sizeof|sizeof
argument_list|(
operator|*
name|oper
argument_list|)
expr_stmt|;
return|return
name|pos
return|;
block|}
end_function

begin_comment
comment|/* op_mode Set to 0 (HT pure) under the followign conditions 	- all STAs in the BSS are 20/40 MHz HT in 20/40 MHz BSS or 	- all STAs in the BSS are 20 MHz HT in 20 MHz BSS Set to 1 (HT non-member protection) if there may be non-HT STAs 	in both the primary and the secondary channel Set to 2 if only HT STAs are associated in BSS, 	however and at least one 20 MHz HT STA is associated Set to 3 (HT mixed mode) when one or more non-HT STAs are associated */
end_comment

begin_function
name|int
name|hostapd_ht_operation_update
parameter_list|(
name|struct
name|hostapd_iface
modifier|*
name|iface
parameter_list|)
block|{
name|u16
name|cur_op_mode
decl_stmt|,
name|new_op_mode
decl_stmt|;
name|int
name|op_mode_changes
init|=
literal|0
decl_stmt|;
if|if
condition|(
operator|!
name|iface
operator|->
name|conf
operator|->
name|ieee80211n
operator|||
name|iface
operator|->
name|conf
operator|->
name|ht_op_mode_fixed
condition|)
return|return
literal|0
return|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"%s current operation mode=0x%X"
argument_list|,
name|__func__
argument_list|,
name|iface
operator|->
name|ht_op_mode
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|iface
operator|->
name|ht_op_mode
operator|&
name|HT_OPER_OP_MODE_NON_GF_HT_STAS_PRESENT
operator|)
operator|&&
name|iface
operator|->
name|num_sta_ht_no_gf
condition|)
block|{
name|iface
operator|->
name|ht_op_mode
operator||=
name|HT_OPER_OP_MODE_NON_GF_HT_STAS_PRESENT
expr_stmt|;
name|op_mode_changes
operator|++
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|(
name|iface
operator|->
name|ht_op_mode
operator|&
name|HT_OPER_OP_MODE_NON_GF_HT_STAS_PRESENT
operator|)
operator|&&
name|iface
operator|->
name|num_sta_ht_no_gf
operator|==
literal|0
condition|)
block|{
name|iface
operator|->
name|ht_op_mode
operator|&=
operator|~
name|HT_OPER_OP_MODE_NON_GF_HT_STAS_PRESENT
expr_stmt|;
name|op_mode_changes
operator|++
expr_stmt|;
block|}
if|if
condition|(
operator|!
operator|(
name|iface
operator|->
name|ht_op_mode
operator|&
name|HT_OPER_OP_MODE_OBSS_NON_HT_STAS_PRESENT
operator|)
operator|&&
operator|(
name|iface
operator|->
name|num_sta_no_ht
operator|||
name|iface
operator|->
name|olbc_ht
operator|)
condition|)
block|{
name|iface
operator|->
name|ht_op_mode
operator||=
name|HT_OPER_OP_MODE_OBSS_NON_HT_STAS_PRESENT
expr_stmt|;
name|op_mode_changes
operator|++
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|(
name|iface
operator|->
name|ht_op_mode
operator|&
name|HT_OPER_OP_MODE_OBSS_NON_HT_STAS_PRESENT
operator|)
operator|&&
operator|(
name|iface
operator|->
name|num_sta_no_ht
operator|==
literal|0
operator|&&
operator|!
name|iface
operator|->
name|olbc_ht
operator|)
condition|)
block|{
name|iface
operator|->
name|ht_op_mode
operator|&=
operator|~
name|HT_OPER_OP_MODE_OBSS_NON_HT_STAS_PRESENT
expr_stmt|;
name|op_mode_changes
operator|++
expr_stmt|;
block|}
if|if
condition|(
name|iface
operator|->
name|num_sta_no_ht
condition|)
name|new_op_mode
operator|=
name|HT_PROT_NON_HT_MIXED
expr_stmt|;
elseif|else
if|if
condition|(
name|iface
operator|->
name|conf
operator|->
name|secondary_channel
operator|&&
name|iface
operator|->
name|num_sta_ht_20mhz
condition|)
name|new_op_mode
operator|=
name|HT_PROT_20MHZ_PROTECTION
expr_stmt|;
elseif|else
if|if
condition|(
name|iface
operator|->
name|olbc_ht
condition|)
name|new_op_mode
operator|=
name|HT_PROT_NONMEMBER_PROTECTION
expr_stmt|;
else|else
name|new_op_mode
operator|=
name|HT_PROT_NO_PROTECTION
expr_stmt|;
name|cur_op_mode
operator|=
name|iface
operator|->
name|ht_op_mode
operator|&
name|HT_OPER_OP_MODE_HT_PROT_MASK
expr_stmt|;
if|if
condition|(
name|cur_op_mode
operator|!=
name|new_op_mode
condition|)
block|{
name|iface
operator|->
name|ht_op_mode
operator|&=
operator|~
name|HT_OPER_OP_MODE_HT_PROT_MASK
expr_stmt|;
name|iface
operator|->
name|ht_op_mode
operator||=
name|new_op_mode
expr_stmt|;
name|op_mode_changes
operator|++
expr_stmt|;
block|}
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"%s new operation mode=0x%X changes=%d"
argument_list|,
name|__func__
argument_list|,
name|iface
operator|->
name|ht_op_mode
argument_list|,
name|op_mode_changes
argument_list|)
expr_stmt|;
return|return
name|op_mode_changes
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|is_40_allowed
parameter_list|(
name|struct
name|hostapd_iface
modifier|*
name|iface
parameter_list|,
name|int
name|channel
parameter_list|)
block|{
name|int
name|pri_freq
decl_stmt|,
name|sec_freq
decl_stmt|;
name|int
name|affected_start
decl_stmt|,
name|affected_end
decl_stmt|;
name|int
name|pri
init|=
literal|2407
operator|+
literal|5
operator|*
name|channel
decl_stmt|;
if|if
condition|(
name|iface
operator|->
name|current_mode
operator|->
name|mode
operator|!=
name|HOSTAPD_MODE_IEEE80211G
condition|)
return|return
literal|1
return|;
name|pri_freq
operator|=
name|hostapd_hw_get_freq
argument_list|(
name|iface
operator|->
name|bss
index|[
literal|0
index|]
argument_list|,
name|iface
operator|->
name|conf
operator|->
name|channel
argument_list|)
expr_stmt|;
if|if
condition|(
name|iface
operator|->
name|conf
operator|->
name|secondary_channel
operator|>
literal|0
condition|)
name|sec_freq
operator|=
name|pri_freq
operator|+
literal|20
expr_stmt|;
else|else
name|sec_freq
operator|=
name|pri_freq
operator|-
literal|20
expr_stmt|;
name|affected_start
operator|=
operator|(
name|pri_freq
operator|+
name|sec_freq
operator|)
operator|/
literal|2
operator|-
literal|25
expr_stmt|;
name|affected_end
operator|=
operator|(
name|pri_freq
operator|+
name|sec_freq
operator|)
operator|/
literal|2
operator|+
literal|25
expr_stmt|;
if|if
condition|(
operator|(
name|pri
operator|<
name|affected_start
operator|||
name|pri
operator|>
name|affected_end
operator|)
condition|)
return|return
literal|1
return|;
comment|/* not within affected channel range */
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"40 MHz affected channel range: [%d,%d] MHz"
argument_list|,
name|affected_start
argument_list|,
name|affected_end
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"Neighboring BSS: freq=%d"
argument_list|,
name|pri
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|void
name|hostapd_2040_coex_action
parameter_list|(
name|struct
name|hostapd_data
modifier|*
name|hapd
parameter_list|,
specifier|const
name|struct
name|ieee80211_mgmt
modifier|*
name|mgmt
parameter_list|,
name|size_t
name|len
parameter_list|)
block|{
name|struct
name|hostapd_iface
modifier|*
name|iface
init|=
name|hapd
operator|->
name|iface
decl_stmt|;
name|struct
name|ieee80211_2040_bss_coex_ie
modifier|*
name|bc_ie
decl_stmt|;
name|struct
name|ieee80211_2040_intol_chan_report
modifier|*
name|ic_report
decl_stmt|;
name|int
name|is_ht40_allowed
init|=
literal|1
decl_stmt|;
name|int
name|i
decl_stmt|;
specifier|const
name|u8
modifier|*
name|start
init|=
operator|(
specifier|const
name|u8
operator|*
operator|)
name|mgmt
decl_stmt|;
specifier|const
name|u8
modifier|*
name|data
init|=
name|start
operator|+
name|IEEE80211_HDRLEN
operator|+
literal|2
decl_stmt|;
name|hostapd_logger
argument_list|(
name|hapd
argument_list|,
name|mgmt
operator|->
name|sa
argument_list|,
name|HOSTAPD_MODULE_IEEE80211
argument_list|,
name|HOSTAPD_LEVEL_DEBUG
argument_list|,
literal|"hostapd_public_action - action=%d"
argument_list|,
name|mgmt
operator|->
name|u
operator|.
name|action
operator|.
name|u
operator|.
name|public_action
operator|.
name|action
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|iface
operator|->
name|conf
operator|->
name|ht_capab
operator|&
name|HT_CAP_INFO_SUPP_CHANNEL_WIDTH_SET
operator|)
condition|)
return|return;
if|if
condition|(
name|len
operator|<
name|IEEE80211_HDRLEN
operator|+
literal|2
operator|+
sizeof|sizeof
argument_list|(
operator|*
name|bc_ie
argument_list|)
condition|)
return|return;
name|bc_ie
operator|=
operator|(
expr|struct
name|ieee80211_2040_bss_coex_ie
operator|*
operator|)
name|data
expr_stmt|;
if|if
condition|(
name|bc_ie
operator|->
name|element_id
operator|!=
name|WLAN_EID_20_40_BSS_COEXISTENCE
operator|||
name|bc_ie
operator|->
name|length
operator|<
literal|1
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"Unexpected IE (%u,%u) in coex report"
argument_list|,
name|bc_ie
operator|->
name|element_id
argument_list|,
name|bc_ie
operator|->
name|length
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|len
operator|<
name|IEEE80211_HDRLEN
operator|+
literal|2
operator|+
literal|2
operator|+
name|bc_ie
operator|->
name|length
condition|)
return|return;
name|data
operator|+=
literal|2
operator|+
name|bc_ie
operator|->
name|length
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"20/40 BSS Coexistence Information field: 0x%x"
argument_list|,
name|bc_ie
operator|->
name|coex_param
argument_list|)
expr_stmt|;
if|if
condition|(
name|bc_ie
operator|->
name|coex_param
operator|&
name|WLAN_20_40_BSS_COEX_20MHZ_WIDTH_REQ
condition|)
block|{
name|hostapd_logger
argument_list|(
name|hapd
argument_list|,
name|mgmt
operator|->
name|sa
argument_list|,
name|HOSTAPD_MODULE_IEEE80211
argument_list|,
name|HOSTAPD_LEVEL_DEBUG
argument_list|,
literal|"20 MHz BSS width request bit is set in BSS coexistence information field"
argument_list|)
expr_stmt|;
name|is_ht40_allowed
operator|=
literal|0
expr_stmt|;
block|}
if|if
condition|(
name|bc_ie
operator|->
name|coex_param
operator|&
name|WLAN_20_40_BSS_COEX_40MHZ_INTOL
condition|)
block|{
name|hostapd_logger
argument_list|(
name|hapd
argument_list|,
name|mgmt
operator|->
name|sa
argument_list|,
name|HOSTAPD_MODULE_IEEE80211
argument_list|,
name|HOSTAPD_LEVEL_DEBUG
argument_list|,
literal|"40 MHz intolerant bit is set in BSS coexistence information field"
argument_list|)
expr_stmt|;
name|is_ht40_allowed
operator|=
literal|0
expr_stmt|;
block|}
if|if
condition|(
name|start
operator|+
name|len
operator|-
name|data
operator|>=
literal|3
operator|&&
name|data
index|[
literal|0
index|]
operator|==
name|WLAN_EID_20_40_BSS_INTOLERANT
operator|&&
name|data
index|[
literal|1
index|]
operator|>=
literal|1
condition|)
block|{
name|u8
name|ielen
init|=
name|data
index|[
literal|1
index|]
decl_stmt|;
if|if
condition|(
name|ielen
operator|>
name|start
operator|+
name|len
operator|-
name|data
operator|-
literal|2
condition|)
return|return;
name|ic_report
operator|=
operator|(
expr|struct
name|ieee80211_2040_intol_chan_report
operator|*
operator|)
name|data
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"20/40 BSS Intolerant Channel Report: Operating Class %u"
argument_list|,
name|ic_report
operator|->
name|op_class
argument_list|)
expr_stmt|;
comment|/* Go through the channel report to find any BSS there in the 		 * affected channel range */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|ielen
operator|-
literal|1
condition|;
name|i
operator|++
control|)
block|{
name|u8
name|chan
init|=
name|ic_report
operator|->
name|variable
index|[
name|i
index|]
decl_stmt|;
if|if
condition|(
name|is_40_allowed
argument_list|(
name|iface
argument_list|,
name|chan
argument_list|)
condition|)
continue|continue;
name|hostapd_logger
argument_list|(
name|hapd
argument_list|,
name|mgmt
operator|->
name|sa
argument_list|,
name|HOSTAPD_MODULE_IEEE80211
argument_list|,
name|HOSTAPD_LEVEL_DEBUG
argument_list|,
literal|"20_40_INTOLERANT channel %d reported"
argument_list|,
name|chan
argument_list|)
expr_stmt|;
name|is_ht40_allowed
operator|=
literal|0
expr_stmt|;
block|}
block|}
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"is_ht40_allowed=%d num_sta_ht40_intolerant=%d"
argument_list|,
name|is_ht40_allowed
argument_list|,
name|iface
operator|->
name|num_sta_ht40_intolerant
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|is_ht40_allowed
operator|&&
operator|(
name|iface
operator|->
name|drv_flags
operator|&
name|WPA_DRIVER_FLAGS_HT_2040_COEX
operator|)
condition|)
block|{
if|if
condition|(
name|iface
operator|->
name|conf
operator|->
name|secondary_channel
condition|)
block|{
name|hostapd_logger
argument_list|(
name|hapd
argument_list|,
name|mgmt
operator|->
name|sa
argument_list|,
name|HOSTAPD_MODULE_IEEE80211
argument_list|,
name|HOSTAPD_LEVEL_INFO
argument_list|,
literal|"Switching to 20 MHz operation"
argument_list|)
expr_stmt|;
name|iface
operator|->
name|conf
operator|->
name|secondary_channel
operator|=
literal|0
expr_stmt|;
name|ieee802_11_set_beacons
argument_list|(
name|iface
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|iface
operator|->
name|num_sta_ht40_intolerant
operator|&&
name|iface
operator|->
name|conf
operator|->
name|obss_interval
condition|)
block|{
name|unsigned
name|int
name|delay_time
decl_stmt|;
name|delay_time
operator|=
name|OVERLAPPING_BSS_TRANS_DELAY_FACTOR
operator|*
name|iface
operator|->
name|conf
operator|->
name|obss_interval
expr_stmt|;
name|eloop_cancel_timeout
argument_list|(
name|ap_ht2040_timeout
argument_list|,
name|hapd
operator|->
name|iface
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|eloop_register_timeout
argument_list|(
name|delay_time
argument_list|,
literal|0
argument_list|,
name|ap_ht2040_timeout
argument_list|,
name|hapd
operator|->
name|iface
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"Reschedule HT 20/40 timeout to occur in %u seconds"
argument_list|,
name|delay_time
argument_list|)
expr_stmt|;
block|}
block|}
block|}
end_function

begin_function
name|u16
name|copy_sta_ht_capab
parameter_list|(
name|struct
name|hostapd_data
modifier|*
name|hapd
parameter_list|,
name|struct
name|sta_info
modifier|*
name|sta
parameter_list|,
specifier|const
name|u8
modifier|*
name|ht_capab
parameter_list|)
block|{
comment|/* 	 * Disable HT caps for STAs associated to no-HT BSSes, or for stations 	 * that did not specify a valid WMM IE in the (Re)Association Request 	 * frame. 	 */
if|if
condition|(
operator|!
name|ht_capab
operator|||
operator|!
operator|(
name|sta
operator|->
name|flags
operator|&
name|WLAN_STA_WMM
operator|)
operator|||
name|hapd
operator|->
name|conf
operator|->
name|disable_11n
condition|)
block|{
name|sta
operator|->
name|flags
operator|&=
operator|~
name|WLAN_STA_HT
expr_stmt|;
name|os_free
argument_list|(
name|sta
operator|->
name|ht_capabilities
argument_list|)
expr_stmt|;
name|sta
operator|->
name|ht_capabilities
operator|=
name|NULL
expr_stmt|;
return|return
name|WLAN_STATUS_SUCCESS
return|;
block|}
if|if
condition|(
name|sta
operator|->
name|ht_capabilities
operator|==
name|NULL
condition|)
block|{
name|sta
operator|->
name|ht_capabilities
operator|=
name|os_zalloc
argument_list|(
sizeof|sizeof
argument_list|(
expr|struct
name|ieee80211_ht_capabilities
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|sta
operator|->
name|ht_capabilities
operator|==
name|NULL
condition|)
return|return
name|WLAN_STATUS_UNSPECIFIED_FAILURE
return|;
block|}
name|sta
operator|->
name|flags
operator||=
name|WLAN_STA_HT
expr_stmt|;
name|os_memcpy
argument_list|(
name|sta
operator|->
name|ht_capabilities
argument_list|,
name|ht_capab
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|ieee80211_ht_capabilities
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|WLAN_STATUS_SUCCESS
return|;
block|}
end_function

begin_function
name|void
name|ht40_intolerant_add
parameter_list|(
name|struct
name|hostapd_iface
modifier|*
name|iface
parameter_list|,
name|struct
name|sta_info
modifier|*
name|sta
parameter_list|)
block|{
if|if
condition|(
name|iface
operator|->
name|current_mode
operator|->
name|mode
operator|!=
name|HOSTAPD_MODE_IEEE80211G
condition|)
return|return;
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"HT: Forty MHz Intolerant is set by STA "
name|MACSTR
literal|" in Association Request"
argument_list|,
name|MAC2STR
argument_list|(
name|sta
operator|->
name|addr
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|sta
operator|->
name|ht40_intolerant_set
condition|)
return|return;
name|sta
operator|->
name|ht40_intolerant_set
operator|=
literal|1
expr_stmt|;
name|iface
operator|->
name|num_sta_ht40_intolerant
operator|++
expr_stmt|;
name|eloop_cancel_timeout
argument_list|(
name|ap_ht2040_timeout
argument_list|,
name|iface
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|iface
operator|->
name|conf
operator|->
name|secondary_channel
operator|&&
operator|(
name|iface
operator|->
name|drv_flags
operator|&
name|WPA_DRIVER_FLAGS_HT_2040_COEX
operator|)
condition|)
block|{
name|iface
operator|->
name|conf
operator|->
name|secondary_channel
operator|=
literal|0
expr_stmt|;
name|ieee802_11_set_beacons
argument_list|(
name|iface
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
name|void
name|ht40_intolerant_remove
parameter_list|(
name|struct
name|hostapd_iface
modifier|*
name|iface
parameter_list|,
name|struct
name|sta_info
modifier|*
name|sta
parameter_list|)
block|{
if|if
condition|(
operator|!
name|sta
operator|->
name|ht40_intolerant_set
condition|)
return|return;
name|sta
operator|->
name|ht40_intolerant_set
operator|=
literal|0
expr_stmt|;
name|iface
operator|->
name|num_sta_ht40_intolerant
operator|--
expr_stmt|;
if|if
condition|(
name|iface
operator|->
name|num_sta_ht40_intolerant
operator|==
literal|0
operator|&&
operator|(
name|iface
operator|->
name|conf
operator|->
name|ht_capab
operator|&
name|HT_CAP_INFO_SUPP_CHANNEL_WIDTH_SET
operator|)
operator|&&
operator|(
name|iface
operator|->
name|drv_flags
operator|&
name|WPA_DRIVER_FLAGS_HT_2040_COEX
operator|)
condition|)
block|{
name|unsigned
name|int
name|delay_time
init|=
name|OVERLAPPING_BSS_TRANS_DELAY_FACTOR
operator|*
name|iface
operator|->
name|conf
operator|->
name|obss_interval
decl_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"HT: Start 20->40 MHz transition timer (%d seconds)"
argument_list|,
name|delay_time
argument_list|)
expr_stmt|;
name|eloop_cancel_timeout
argument_list|(
name|ap_ht2040_timeout
argument_list|,
name|iface
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|eloop_register_timeout
argument_list|(
name|delay_time
argument_list|,
literal|0
argument_list|,
name|ap_ht2040_timeout
argument_list|,
name|iface
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|update_sta_ht
parameter_list|(
name|struct
name|hostapd_data
modifier|*
name|hapd
parameter_list|,
name|struct
name|sta_info
modifier|*
name|sta
parameter_list|)
block|{
name|u16
name|ht_capab
decl_stmt|;
name|ht_capab
operator|=
name|le_to_host16
argument_list|(
name|sta
operator|->
name|ht_capabilities
operator|->
name|ht_capabilities_info
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"HT: STA "
name|MACSTR
literal|" HT Capabilities Info: "
literal|"0x%04x"
argument_list|,
name|MAC2STR
argument_list|(
name|sta
operator|->
name|addr
argument_list|)
argument_list|,
name|ht_capab
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|ht_capab
operator|&
name|HT_CAP_INFO_GREEN_FIELD
operator|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
operator|!
name|sta
operator|->
name|no_ht_gf_set
condition|)
block|{
name|sta
operator|->
name|no_ht_gf_set
operator|=
literal|1
expr_stmt|;
name|hapd
operator|->
name|iface
operator|->
name|num_sta_ht_no_gf
operator|++
expr_stmt|;
block|}
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"%s STA "
name|MACSTR
literal|" - no greenfield, num "
literal|"of non-gf stations %d"
argument_list|,
name|__func__
argument_list|,
name|MAC2STR
argument_list|(
name|sta
operator|->
name|addr
argument_list|)
argument_list|,
name|hapd
operator|->
name|iface
operator|->
name|num_sta_ht_no_gf
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|ht_capab
operator|&
name|HT_CAP_INFO_SUPP_CHANNEL_WIDTH_SET
operator|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
operator|!
name|sta
operator|->
name|ht_20mhz_set
condition|)
block|{
name|sta
operator|->
name|ht_20mhz_set
operator|=
literal|1
expr_stmt|;
name|hapd
operator|->
name|iface
operator|->
name|num_sta_ht_20mhz
operator|++
expr_stmt|;
block|}
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"%s STA "
name|MACSTR
literal|" - 20 MHz HT, num of "
literal|"20MHz HT STAs %d"
argument_list|,
name|__func__
argument_list|,
name|MAC2STR
argument_list|(
name|sta
operator|->
name|addr
argument_list|)
argument_list|,
name|hapd
operator|->
name|iface
operator|->
name|num_sta_ht_20mhz
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|ht_capab
operator|&
name|HT_CAP_INFO_40MHZ_INTOLERANT
condition|)
name|ht40_intolerant_add
argument_list|(
name|hapd
operator|->
name|iface
argument_list|,
name|sta
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|update_sta_no_ht
parameter_list|(
name|struct
name|hostapd_data
modifier|*
name|hapd
parameter_list|,
name|struct
name|sta_info
modifier|*
name|sta
parameter_list|)
block|{
if|if
condition|(
operator|!
name|sta
operator|->
name|no_ht_set
condition|)
block|{
name|sta
operator|->
name|no_ht_set
operator|=
literal|1
expr_stmt|;
name|hapd
operator|->
name|iface
operator|->
name|num_sta_no_ht
operator|++
expr_stmt|;
block|}
if|if
condition|(
name|hapd
operator|->
name|iconf
operator|->
name|ieee80211n
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"%s STA "
name|MACSTR
literal|" - no HT, num of "
literal|"non-HT stations %d"
argument_list|,
name|__func__
argument_list|,
name|MAC2STR
argument_list|(
name|sta
operator|->
name|addr
argument_list|)
argument_list|,
name|hapd
operator|->
name|iface
operator|->
name|num_sta_no_ht
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
name|void
name|update_ht_state
parameter_list|(
name|struct
name|hostapd_data
modifier|*
name|hapd
parameter_list|,
name|struct
name|sta_info
modifier|*
name|sta
parameter_list|)
block|{
if|if
condition|(
operator|(
name|sta
operator|->
name|flags
operator|&
name|WLAN_STA_HT
operator|)
operator|&&
name|sta
operator|->
name|ht_capabilities
condition|)
name|update_sta_ht
argument_list|(
name|hapd
argument_list|,
name|sta
argument_list|)
expr_stmt|;
else|else
name|update_sta_no_ht
argument_list|(
name|hapd
argument_list|,
name|sta
argument_list|)
expr_stmt|;
if|if
condition|(
name|hostapd_ht_operation_update
argument_list|(
name|hapd
operator|->
name|iface
argument_list|)
operator|>
literal|0
condition|)
name|ieee802_11_set_beacons
argument_list|(
name|hapd
operator|->
name|iface
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|hostapd_get_ht_capab
parameter_list|(
name|struct
name|hostapd_data
modifier|*
name|hapd
parameter_list|,
name|struct
name|ieee80211_ht_capabilities
modifier|*
name|ht_cap
parameter_list|,
name|struct
name|ieee80211_ht_capabilities
modifier|*
name|neg_ht_cap
parameter_list|)
block|{
name|u16
name|cap
decl_stmt|;
if|if
condition|(
name|ht_cap
operator|==
name|NULL
condition|)
return|return;
name|os_memcpy
argument_list|(
name|neg_ht_cap
argument_list|,
name|ht_cap
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|neg_ht_cap
argument_list|)
argument_list|)
expr_stmt|;
name|cap
operator|=
name|le_to_host16
argument_list|(
name|neg_ht_cap
operator|->
name|ht_capabilities_info
argument_list|)
expr_stmt|;
comment|/* 	 * Mask out HT features we don't support, but don't overwrite 	 * non-symmetric features like STBC and SMPS. Just because 	 * we're not in dynamic SMPS mode the STA might still be. 	 */
name|cap
operator|&=
operator|(
name|hapd
operator|->
name|iconf
operator|->
name|ht_capab
operator||
name|HT_CAP_INFO_RX_STBC_MASK
operator||
name|HT_CAP_INFO_TX_STBC
operator||
name|HT_CAP_INFO_SMPS_MASK
operator|)
expr_stmt|;
comment|/* 	 * STBC needs to be handled specially 	 * if we don't support RX STBC, mask out TX STBC in the STA's HT caps 	 * if we don't support TX STBC, mask out RX STBC in the STA's HT caps 	 */
if|if
condition|(
operator|!
operator|(
name|hapd
operator|->
name|iconf
operator|->
name|ht_capab
operator|&
name|HT_CAP_INFO_RX_STBC_MASK
operator|)
condition|)
name|cap
operator|&=
operator|~
name|HT_CAP_INFO_TX_STBC
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|hapd
operator|->
name|iconf
operator|->
name|ht_capab
operator|&
name|HT_CAP_INFO_TX_STBC
operator|)
condition|)
name|cap
operator|&=
operator|~
name|HT_CAP_INFO_RX_STBC_MASK
expr_stmt|;
name|neg_ht_cap
operator|->
name|ht_capabilities_info
operator|=
name|host_to_le16
argument_list|(
name|cap
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|ap_ht2040_timeout
parameter_list|(
name|void
modifier|*
name|eloop_data
parameter_list|,
name|void
modifier|*
name|user_data
parameter_list|)
block|{
name|struct
name|hostapd_iface
modifier|*
name|iface
init|=
name|eloop_data
decl_stmt|;
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"Switching to 40 MHz operation"
argument_list|)
expr_stmt|;
name|iface
operator|->
name|conf
operator|->
name|secondary_channel
operator|=
name|iface
operator|->
name|secondary_ch
expr_stmt|;
name|ieee802_11_set_beacons
argument_list|(
name|iface
argument_list|)
expr_stmt|;
block|}
end_function

end_unit


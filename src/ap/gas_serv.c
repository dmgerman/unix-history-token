begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Generic advertisement service (GAS) server  * Copyright (c) 2011-2014, Qualcomm Atheros, Inc.  *  * This software may be distributed under the terms of the BSD license.  * See README for more details.  */
end_comment

begin_include
include|#
directive|include
file|"includes.h"
end_include

begin_include
include|#
directive|include
file|"common.h"
end_include

begin_include
include|#
directive|include
file|"common/ieee802_11_defs.h"
end_include

begin_include
include|#
directive|include
file|"common/gas.h"
end_include

begin_include
include|#
directive|include
file|"utils/eloop.h"
end_include

begin_include
include|#
directive|include
file|"hostapd.h"
end_include

begin_include
include|#
directive|include
file|"ap_config.h"
end_include

begin_include
include|#
directive|include
file|"ap_drv_ops.h"
end_include

begin_include
include|#
directive|include
file|"sta_info.h"
end_include

begin_include
include|#
directive|include
file|"gas_serv.h"
end_include

begin_function
specifier|static
name|void
name|convert_to_protected_dual
parameter_list|(
name|struct
name|wpabuf
modifier|*
name|msg
parameter_list|)
block|{
name|u8
modifier|*
name|categ
init|=
name|wpabuf_mhead_u8
argument_list|(
name|msg
argument_list|)
decl_stmt|;
operator|*
name|categ
operator|=
name|WLAN_ACTION_PROTECTED_DUAL
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|struct
name|gas_dialog_info
modifier|*
name|gas_dialog_create
parameter_list|(
name|struct
name|hostapd_data
modifier|*
name|hapd
parameter_list|,
specifier|const
name|u8
modifier|*
name|addr
parameter_list|,
name|u8
name|dialog_token
parameter_list|)
block|{
name|struct
name|sta_info
modifier|*
name|sta
decl_stmt|;
name|struct
name|gas_dialog_info
modifier|*
name|dia
init|=
name|NULL
decl_stmt|;
name|int
name|i
decl_stmt|,
name|j
decl_stmt|;
name|sta
operator|=
name|ap_get_sta
argument_list|(
name|hapd
argument_list|,
name|addr
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|sta
condition|)
block|{
comment|/* 		 * We need a STA entry to be able to maintain state for 		 * the GAS query. 		 */
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"ANQP: Add a temporary STA entry for "
literal|"GAS query"
argument_list|)
expr_stmt|;
name|sta
operator|=
name|ap_sta_add
argument_list|(
name|hapd
argument_list|,
name|addr
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|sta
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"Failed to add STA "
name|MACSTR
literal|" for GAS query"
argument_list|,
name|MAC2STR
argument_list|(
name|addr
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|sta
operator|->
name|flags
operator||=
name|WLAN_STA_GAS
expr_stmt|;
comment|/* 		 * The default inactivity is 300 seconds. We don't need 		 * it to be that long. 		 */
name|ap_sta_session_timeout
argument_list|(
name|hapd
argument_list|,
name|sta
argument_list|,
literal|5
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|ap_sta_replenish_timeout
argument_list|(
name|hapd
argument_list|,
name|sta
argument_list|,
literal|5
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|sta
operator|->
name|gas_dialog
operator|==
name|NULL
condition|)
block|{
name|sta
operator|->
name|gas_dialog
operator|=
name|os_calloc
argument_list|(
name|GAS_DIALOG_MAX
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|gas_dialog_info
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|sta
operator|->
name|gas_dialog
operator|==
name|NULL
condition|)
return|return
name|NULL
return|;
block|}
for|for
control|(
name|i
operator|=
name|sta
operator|->
name|gas_dialog_next
operator|,
name|j
operator|=
literal|0
init|;
name|j
operator|<
name|GAS_DIALOG_MAX
condition|;
name|i
operator|++
operator|,
name|j
operator|++
control|)
block|{
if|if
condition|(
name|i
operator|==
name|GAS_DIALOG_MAX
condition|)
name|i
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|sta
operator|->
name|gas_dialog
index|[
name|i
index|]
operator|.
name|valid
condition|)
continue|continue;
name|dia
operator|=
operator|&
name|sta
operator|->
name|gas_dialog
index|[
name|i
index|]
expr_stmt|;
name|dia
operator|->
name|valid
operator|=
literal|1
expr_stmt|;
name|dia
operator|->
name|dialog_token
operator|=
name|dialog_token
expr_stmt|;
name|sta
operator|->
name|gas_dialog_next
operator|=
operator|(
operator|++
name|i
operator|==
name|GAS_DIALOG_MAX
operator|)
condition|?
literal|0
else|:
name|i
expr_stmt|;
return|return
name|dia
return|;
block|}
name|wpa_msg
argument_list|(
name|hapd
operator|->
name|msg_ctx
argument_list|,
name|MSG_ERROR
argument_list|,
literal|"ANQP: Could not create dialog for "
name|MACSTR
literal|" dialog_token %u. Consider increasing "
literal|"GAS_DIALOG_MAX."
argument_list|,
name|MAC2STR
argument_list|(
name|addr
argument_list|)
argument_list|,
name|dialog_token
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
end_function

begin_function
name|struct
name|gas_dialog_info
modifier|*
name|gas_serv_dialog_find
parameter_list|(
name|struct
name|hostapd_data
modifier|*
name|hapd
parameter_list|,
specifier|const
name|u8
modifier|*
name|addr
parameter_list|,
name|u8
name|dialog_token
parameter_list|)
block|{
name|struct
name|sta_info
modifier|*
name|sta
decl_stmt|;
name|int
name|i
decl_stmt|;
name|sta
operator|=
name|ap_get_sta
argument_list|(
name|hapd
argument_list|,
name|addr
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|sta
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"ANQP: could not find STA "
name|MACSTR
argument_list|,
name|MAC2STR
argument_list|(
name|addr
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|sta
operator|->
name|gas_dialog
operator|&&
name|i
operator|<
name|GAS_DIALOG_MAX
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|sta
operator|->
name|gas_dialog
index|[
name|i
index|]
operator|.
name|dialog_token
operator|!=
name|dialog_token
operator|||
operator|!
name|sta
operator|->
name|gas_dialog
index|[
name|i
index|]
operator|.
name|valid
condition|)
continue|continue;
return|return
operator|&
name|sta
operator|->
name|gas_dialog
index|[
name|i
index|]
return|;
block|}
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"ANQP: Could not find dialog for "
name|MACSTR
literal|" dialog_token %u"
argument_list|,
name|MAC2STR
argument_list|(
name|addr
argument_list|)
argument_list|,
name|dialog_token
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
end_function

begin_function
name|void
name|gas_serv_dialog_clear
parameter_list|(
name|struct
name|gas_dialog_info
modifier|*
name|dia
parameter_list|)
block|{
name|wpabuf_free
argument_list|(
name|dia
operator|->
name|sd_resp
argument_list|)
expr_stmt|;
name|os_memset
argument_list|(
name|dia
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|dia
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|gas_serv_free_dialogs
parameter_list|(
name|struct
name|hostapd_data
modifier|*
name|hapd
parameter_list|,
specifier|const
name|u8
modifier|*
name|sta_addr
parameter_list|)
block|{
name|struct
name|sta_info
modifier|*
name|sta
decl_stmt|;
name|int
name|i
decl_stmt|;
name|sta
operator|=
name|ap_get_sta
argument_list|(
name|hapd
argument_list|,
name|sta_addr
argument_list|)
expr_stmt|;
if|if
condition|(
name|sta
operator|==
name|NULL
operator|||
name|sta
operator|->
name|gas_dialog
operator|==
name|NULL
condition|)
return|return;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|GAS_DIALOG_MAX
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|sta
operator|->
name|gas_dialog
index|[
name|i
index|]
operator|.
name|valid
condition|)
return|return;
block|}
name|os_free
argument_list|(
name|sta
operator|->
name|gas_dialog
argument_list|)
expr_stmt|;
name|sta
operator|->
name|gas_dialog
operator|=
name|NULL
expr_stmt|;
block|}
end_function

begin_ifdef
ifdef|#
directive|ifdef
name|CONFIG_HS20
end_ifdef

begin_function
specifier|static
name|void
name|anqp_add_hs_capab_list
parameter_list|(
name|struct
name|hostapd_data
modifier|*
name|hapd
parameter_list|,
name|struct
name|wpabuf
modifier|*
name|buf
parameter_list|)
block|{
name|u8
modifier|*
name|len
decl_stmt|;
name|len
operator|=
name|gas_anqp_add_element
argument_list|(
name|buf
argument_list|,
name|ANQP_VENDOR_SPECIFIC
argument_list|)
expr_stmt|;
name|wpabuf_put_be24
argument_list|(
name|buf
argument_list|,
name|OUI_WFA
argument_list|)
expr_stmt|;
name|wpabuf_put_u8
argument_list|(
name|buf
argument_list|,
name|HS20_ANQP_OUI_TYPE
argument_list|)
expr_stmt|;
name|wpabuf_put_u8
argument_list|(
name|buf
argument_list|,
name|HS20_STYPE_CAPABILITY_LIST
argument_list|)
expr_stmt|;
name|wpabuf_put_u8
argument_list|(
name|buf
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* Reserved */
name|wpabuf_put_u8
argument_list|(
name|buf
argument_list|,
name|HS20_STYPE_CAPABILITY_LIST
argument_list|)
expr_stmt|;
if|if
condition|(
name|hapd
operator|->
name|conf
operator|->
name|hs20_oper_friendly_name
condition|)
name|wpabuf_put_u8
argument_list|(
name|buf
argument_list|,
name|HS20_STYPE_OPERATOR_FRIENDLY_NAME
argument_list|)
expr_stmt|;
if|if
condition|(
name|hapd
operator|->
name|conf
operator|->
name|hs20_wan_metrics
condition|)
name|wpabuf_put_u8
argument_list|(
name|buf
argument_list|,
name|HS20_STYPE_WAN_METRICS
argument_list|)
expr_stmt|;
if|if
condition|(
name|hapd
operator|->
name|conf
operator|->
name|hs20_connection_capability
condition|)
name|wpabuf_put_u8
argument_list|(
name|buf
argument_list|,
name|HS20_STYPE_CONNECTION_CAPABILITY
argument_list|)
expr_stmt|;
if|if
condition|(
name|hapd
operator|->
name|conf
operator|->
name|nai_realm_data
condition|)
name|wpabuf_put_u8
argument_list|(
name|buf
argument_list|,
name|HS20_STYPE_NAI_HOME_REALM_QUERY
argument_list|)
expr_stmt|;
if|if
condition|(
name|hapd
operator|->
name|conf
operator|->
name|hs20_operating_class
condition|)
name|wpabuf_put_u8
argument_list|(
name|buf
argument_list|,
name|HS20_STYPE_OPERATING_CLASS
argument_list|)
expr_stmt|;
if|if
condition|(
name|hapd
operator|->
name|conf
operator|->
name|hs20_osu_providers_count
condition|)
name|wpabuf_put_u8
argument_list|(
name|buf
argument_list|,
name|HS20_STYPE_OSU_PROVIDERS_LIST
argument_list|)
expr_stmt|;
if|if
condition|(
name|hapd
operator|->
name|conf
operator|->
name|hs20_icons_count
condition|)
name|wpabuf_put_u8
argument_list|(
name|buf
argument_list|,
name|HS20_STYPE_ICON_REQUEST
argument_list|)
expr_stmt|;
name|gas_anqp_set_element_len
argument_list|(
name|buf
argument_list|,
name|len
argument_list|)
expr_stmt|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* CONFIG_HS20 */
end_comment

begin_function
specifier|static
name|void
name|anqp_add_capab_list
parameter_list|(
name|struct
name|hostapd_data
modifier|*
name|hapd
parameter_list|,
name|struct
name|wpabuf
modifier|*
name|buf
parameter_list|)
block|{
name|u8
modifier|*
name|len
decl_stmt|;
name|len
operator|=
name|gas_anqp_add_element
argument_list|(
name|buf
argument_list|,
name|ANQP_CAPABILITY_LIST
argument_list|)
expr_stmt|;
name|wpabuf_put_le16
argument_list|(
name|buf
argument_list|,
name|ANQP_CAPABILITY_LIST
argument_list|)
expr_stmt|;
if|if
condition|(
name|hapd
operator|->
name|conf
operator|->
name|venue_name
condition|)
name|wpabuf_put_le16
argument_list|(
name|buf
argument_list|,
name|ANQP_VENUE_NAME
argument_list|)
expr_stmt|;
if|if
condition|(
name|hapd
operator|->
name|conf
operator|->
name|network_auth_type
condition|)
name|wpabuf_put_le16
argument_list|(
name|buf
argument_list|,
name|ANQP_NETWORK_AUTH_TYPE
argument_list|)
expr_stmt|;
if|if
condition|(
name|hapd
operator|->
name|conf
operator|->
name|roaming_consortium
condition|)
name|wpabuf_put_le16
argument_list|(
name|buf
argument_list|,
name|ANQP_ROAMING_CONSORTIUM
argument_list|)
expr_stmt|;
if|if
condition|(
name|hapd
operator|->
name|conf
operator|->
name|ipaddr_type_configured
condition|)
name|wpabuf_put_le16
argument_list|(
name|buf
argument_list|,
name|ANQP_IP_ADDR_TYPE_AVAILABILITY
argument_list|)
expr_stmt|;
if|if
condition|(
name|hapd
operator|->
name|conf
operator|->
name|nai_realm_data
condition|)
name|wpabuf_put_le16
argument_list|(
name|buf
argument_list|,
name|ANQP_NAI_REALM
argument_list|)
expr_stmt|;
if|if
condition|(
name|hapd
operator|->
name|conf
operator|->
name|anqp_3gpp_cell_net
condition|)
name|wpabuf_put_le16
argument_list|(
name|buf
argument_list|,
name|ANQP_3GPP_CELLULAR_NETWORK
argument_list|)
expr_stmt|;
if|if
condition|(
name|hapd
operator|->
name|conf
operator|->
name|domain_name
condition|)
name|wpabuf_put_le16
argument_list|(
name|buf
argument_list|,
name|ANQP_DOMAIN_NAME
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|CONFIG_HS20
name|anqp_add_hs_capab_list
argument_list|(
name|hapd
argument_list|,
name|buf
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* CONFIG_HS20 */
name|gas_anqp_set_element_len
argument_list|(
name|buf
argument_list|,
name|len
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|anqp_add_venue_name
parameter_list|(
name|struct
name|hostapd_data
modifier|*
name|hapd
parameter_list|,
name|struct
name|wpabuf
modifier|*
name|buf
parameter_list|)
block|{
if|if
condition|(
name|hapd
operator|->
name|conf
operator|->
name|venue_name
condition|)
block|{
name|u8
modifier|*
name|len
decl_stmt|;
name|unsigned
name|int
name|i
decl_stmt|;
name|len
operator|=
name|gas_anqp_add_element
argument_list|(
name|buf
argument_list|,
name|ANQP_VENUE_NAME
argument_list|)
expr_stmt|;
name|wpabuf_put_u8
argument_list|(
name|buf
argument_list|,
name|hapd
operator|->
name|conf
operator|->
name|venue_group
argument_list|)
expr_stmt|;
name|wpabuf_put_u8
argument_list|(
name|buf
argument_list|,
name|hapd
operator|->
name|conf
operator|->
name|venue_type
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|hapd
operator|->
name|conf
operator|->
name|venue_name_count
condition|;
name|i
operator|++
control|)
block|{
name|struct
name|hostapd_lang_string
modifier|*
name|vn
decl_stmt|;
name|vn
operator|=
operator|&
name|hapd
operator|->
name|conf
operator|->
name|venue_name
index|[
name|i
index|]
expr_stmt|;
name|wpabuf_put_u8
argument_list|(
name|buf
argument_list|,
literal|3
operator|+
name|vn
operator|->
name|name_len
argument_list|)
expr_stmt|;
name|wpabuf_put_data
argument_list|(
name|buf
argument_list|,
name|vn
operator|->
name|lang
argument_list|,
literal|3
argument_list|)
expr_stmt|;
name|wpabuf_put_data
argument_list|(
name|buf
argument_list|,
name|vn
operator|->
name|name
argument_list|,
name|vn
operator|->
name|name_len
argument_list|)
expr_stmt|;
block|}
name|gas_anqp_set_element_len
argument_list|(
name|buf
argument_list|,
name|len
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|anqp_add_network_auth_type
parameter_list|(
name|struct
name|hostapd_data
modifier|*
name|hapd
parameter_list|,
name|struct
name|wpabuf
modifier|*
name|buf
parameter_list|)
block|{
if|if
condition|(
name|hapd
operator|->
name|conf
operator|->
name|network_auth_type
condition|)
block|{
name|wpabuf_put_le16
argument_list|(
name|buf
argument_list|,
name|ANQP_NETWORK_AUTH_TYPE
argument_list|)
expr_stmt|;
name|wpabuf_put_le16
argument_list|(
name|buf
argument_list|,
name|hapd
operator|->
name|conf
operator|->
name|network_auth_type_len
argument_list|)
expr_stmt|;
name|wpabuf_put_data
argument_list|(
name|buf
argument_list|,
name|hapd
operator|->
name|conf
operator|->
name|network_auth_type
argument_list|,
name|hapd
operator|->
name|conf
operator|->
name|network_auth_type_len
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|anqp_add_roaming_consortium
parameter_list|(
name|struct
name|hostapd_data
modifier|*
name|hapd
parameter_list|,
name|struct
name|wpabuf
modifier|*
name|buf
parameter_list|)
block|{
name|unsigned
name|int
name|i
decl_stmt|;
name|u8
modifier|*
name|len
decl_stmt|;
name|len
operator|=
name|gas_anqp_add_element
argument_list|(
name|buf
argument_list|,
name|ANQP_ROAMING_CONSORTIUM
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|hapd
operator|->
name|conf
operator|->
name|roaming_consortium_count
condition|;
name|i
operator|++
control|)
block|{
name|struct
name|hostapd_roaming_consortium
modifier|*
name|rc
decl_stmt|;
name|rc
operator|=
operator|&
name|hapd
operator|->
name|conf
operator|->
name|roaming_consortium
index|[
name|i
index|]
expr_stmt|;
name|wpabuf_put_u8
argument_list|(
name|buf
argument_list|,
name|rc
operator|->
name|len
argument_list|)
expr_stmt|;
name|wpabuf_put_data
argument_list|(
name|buf
argument_list|,
name|rc
operator|->
name|oi
argument_list|,
name|rc
operator|->
name|len
argument_list|)
expr_stmt|;
block|}
name|gas_anqp_set_element_len
argument_list|(
name|buf
argument_list|,
name|len
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|anqp_add_ip_addr_type_availability
parameter_list|(
name|struct
name|hostapd_data
modifier|*
name|hapd
parameter_list|,
name|struct
name|wpabuf
modifier|*
name|buf
parameter_list|)
block|{
if|if
condition|(
name|hapd
operator|->
name|conf
operator|->
name|ipaddr_type_configured
condition|)
block|{
name|wpabuf_put_le16
argument_list|(
name|buf
argument_list|,
name|ANQP_IP_ADDR_TYPE_AVAILABILITY
argument_list|)
expr_stmt|;
name|wpabuf_put_le16
argument_list|(
name|buf
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|wpabuf_put_u8
argument_list|(
name|buf
argument_list|,
name|hapd
operator|->
name|conf
operator|->
name|ipaddr_type_availability
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|anqp_add_nai_realm_eap
parameter_list|(
name|struct
name|wpabuf
modifier|*
name|buf
parameter_list|,
name|struct
name|hostapd_nai_realm_data
modifier|*
name|realm
parameter_list|)
block|{
name|unsigned
name|int
name|i
decl_stmt|,
name|j
decl_stmt|;
name|wpabuf_put_u8
argument_list|(
name|buf
argument_list|,
name|realm
operator|->
name|eap_method_count
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|realm
operator|->
name|eap_method_count
condition|;
name|i
operator|++
control|)
block|{
name|struct
name|hostapd_nai_realm_eap
modifier|*
name|eap
init|=
operator|&
name|realm
operator|->
name|eap_method
index|[
name|i
index|]
decl_stmt|;
name|wpabuf_put_u8
argument_list|(
name|buf
argument_list|,
literal|2
operator|+
operator|(
literal|3
operator|*
name|eap
operator|->
name|num_auths
operator|)
argument_list|)
expr_stmt|;
name|wpabuf_put_u8
argument_list|(
name|buf
argument_list|,
name|eap
operator|->
name|eap_method
argument_list|)
expr_stmt|;
name|wpabuf_put_u8
argument_list|(
name|buf
argument_list|,
name|eap
operator|->
name|num_auths
argument_list|)
expr_stmt|;
for|for
control|(
name|j
operator|=
literal|0
init|;
name|j
operator|<
name|eap
operator|->
name|num_auths
condition|;
name|j
operator|++
control|)
block|{
name|wpabuf_put_u8
argument_list|(
name|buf
argument_list|,
name|eap
operator|->
name|auth_id
index|[
name|j
index|]
argument_list|)
expr_stmt|;
name|wpabuf_put_u8
argument_list|(
name|buf
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|wpabuf_put_u8
argument_list|(
name|buf
argument_list|,
name|eap
operator|->
name|auth_val
index|[
name|j
index|]
argument_list|)
expr_stmt|;
block|}
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|anqp_add_nai_realm_data
parameter_list|(
name|struct
name|wpabuf
modifier|*
name|buf
parameter_list|,
name|struct
name|hostapd_nai_realm_data
modifier|*
name|realm
parameter_list|,
name|unsigned
name|int
name|realm_idx
parameter_list|)
block|{
name|u8
modifier|*
name|realm_data_len
decl_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"realm=%s, len=%d"
argument_list|,
name|realm
operator|->
name|realm
index|[
name|realm_idx
index|]
argument_list|,
operator|(
name|int
operator|)
name|os_strlen
argument_list|(
name|realm
operator|->
name|realm
index|[
name|realm_idx
index|]
argument_list|)
argument_list|)
expr_stmt|;
name|realm_data_len
operator|=
name|wpabuf_put
argument_list|(
name|buf
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|wpabuf_put_u8
argument_list|(
name|buf
argument_list|,
name|realm
operator|->
name|encoding
argument_list|)
expr_stmt|;
name|wpabuf_put_u8
argument_list|(
name|buf
argument_list|,
name|os_strlen
argument_list|(
name|realm
operator|->
name|realm
index|[
name|realm_idx
index|]
argument_list|)
argument_list|)
expr_stmt|;
name|wpabuf_put_str
argument_list|(
name|buf
argument_list|,
name|realm
operator|->
name|realm
index|[
name|realm_idx
index|]
argument_list|)
expr_stmt|;
name|anqp_add_nai_realm_eap
argument_list|(
name|buf
argument_list|,
name|realm
argument_list|)
expr_stmt|;
name|gas_anqp_set_element_len
argument_list|(
name|buf
argument_list|,
name|realm_data_len
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|hs20_add_nai_home_realm_matches
parameter_list|(
name|struct
name|hostapd_data
modifier|*
name|hapd
parameter_list|,
name|struct
name|wpabuf
modifier|*
name|buf
parameter_list|,
specifier|const
name|u8
modifier|*
name|home_realm
parameter_list|,
name|size_t
name|home_realm_len
parameter_list|)
block|{
name|unsigned
name|int
name|i
decl_stmt|,
name|j
decl_stmt|,
name|k
decl_stmt|;
name|u8
name|num_realms
decl_stmt|,
name|num_matching
init|=
literal|0
decl_stmt|,
name|encoding
decl_stmt|,
name|realm_len
decl_stmt|,
modifier|*
name|realm_list_len
decl_stmt|;
name|struct
name|hostapd_nai_realm_data
modifier|*
name|realm
decl_stmt|;
specifier|const
name|u8
modifier|*
name|pos
decl_stmt|,
modifier|*
name|realm_name
decl_stmt|,
modifier|*
name|end
decl_stmt|;
struct|struct
block|{
name|unsigned
name|int
name|realm_data_idx
decl_stmt|;
name|unsigned
name|int
name|realm_idx
decl_stmt|;
block|}
name|matches
index|[
literal|10
index|]
struct|;
name|pos
operator|=
name|home_realm
expr_stmt|;
name|end
operator|=
name|pos
operator|+
name|home_realm_len
expr_stmt|;
if|if
condition|(
name|pos
operator|+
literal|1
operator|>
name|end
condition|)
block|{
name|wpa_hexdump
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"Too short NAI Home Realm Query"
argument_list|,
name|home_realm
argument_list|,
name|home_realm_len
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|num_realms
operator|=
operator|*
name|pos
operator|++
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|num_realms
operator|&&
name|num_matching
operator|<
literal|10
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|pos
operator|+
literal|2
operator|>
name|end
condition|)
block|{
name|wpa_hexdump
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"Truncated NAI Home Realm Query"
argument_list|,
name|home_realm
argument_list|,
name|home_realm_len
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|encoding
operator|=
operator|*
name|pos
operator|++
expr_stmt|;
name|realm_len
operator|=
operator|*
name|pos
operator|++
expr_stmt|;
if|if
condition|(
name|pos
operator|+
name|realm_len
operator|>
name|end
condition|)
block|{
name|wpa_hexdump
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"Truncated NAI Home Realm Query"
argument_list|,
name|home_realm
argument_list|,
name|home_realm_len
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|realm_name
operator|=
name|pos
expr_stmt|;
for|for
control|(
name|j
operator|=
literal|0
init|;
name|j
operator|<
name|hapd
operator|->
name|conf
operator|->
name|nai_realm_count
operator|&&
name|num_matching
operator|<
literal|10
condition|;
name|j
operator|++
control|)
block|{
specifier|const
name|u8
modifier|*
name|rpos
decl_stmt|,
modifier|*
name|rend
decl_stmt|;
name|realm
operator|=
operator|&
name|hapd
operator|->
name|conf
operator|->
name|nai_realm_data
index|[
name|j
index|]
expr_stmt|;
if|if
condition|(
name|encoding
operator|!=
name|realm
operator|->
name|encoding
condition|)
continue|continue;
name|rpos
operator|=
name|realm_name
expr_stmt|;
while|while
condition|(
name|rpos
operator|<
name|realm_name
operator|+
name|realm_len
operator|&&
name|num_matching
operator|<
literal|10
condition|)
block|{
for|for
control|(
name|rend
operator|=
name|rpos
init|;
name|rend
operator|<
name|realm_name
operator|+
name|realm_len
condition|;
name|rend
operator|++
control|)
block|{
if|if
condition|(
operator|*
name|rend
operator|==
literal|';'
condition|)
break|break;
block|}
for|for
control|(
name|k
operator|=
literal|0
init|;
name|k
operator|<
name|MAX_NAI_REALMS
operator|&&
name|realm
operator|->
name|realm
index|[
name|k
index|]
operator|&&
name|num_matching
operator|<
literal|10
condition|;
name|k
operator|++
control|)
block|{
if|if
condition|(
operator|(
name|int
operator|)
name|os_strlen
argument_list|(
name|realm
operator|->
name|realm
index|[
name|k
index|]
argument_list|)
operator|!=
name|rend
operator|-
name|rpos
operator|||
name|os_strncmp
argument_list|(
operator|(
name|char
operator|*
operator|)
name|rpos
argument_list|,
name|realm
operator|->
name|realm
index|[
name|k
index|]
argument_list|,
name|rend
operator|-
name|rpos
argument_list|)
operator|!=
literal|0
condition|)
continue|continue;
name|matches
index|[
name|num_matching
index|]
operator|.
name|realm_data_idx
operator|=
name|j
expr_stmt|;
name|matches
index|[
name|num_matching
index|]
operator|.
name|realm_idx
operator|=
name|k
expr_stmt|;
name|num_matching
operator|++
expr_stmt|;
block|}
name|rpos
operator|=
name|rend
operator|+
literal|1
expr_stmt|;
block|}
block|}
name|pos
operator|+=
name|realm_len
expr_stmt|;
block|}
name|realm_list_len
operator|=
name|gas_anqp_add_element
argument_list|(
name|buf
argument_list|,
name|ANQP_NAI_REALM
argument_list|)
expr_stmt|;
name|wpabuf_put_le16
argument_list|(
name|buf
argument_list|,
name|num_matching
argument_list|)
expr_stmt|;
comment|/* 	 * There are two ways to format. 1. each realm in a NAI Realm Data unit 	 * 2. all realms that share the same EAP methods in a NAI Realm Data 	 * unit. The first format is likely to be bigger in size than the 	 * second, but may be easier to parse and process by the receiver. 	 */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|num_matching
condition|;
name|i
operator|++
control|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"realm_idx %d, realm_data_idx %d"
argument_list|,
name|matches
index|[
name|i
index|]
operator|.
name|realm_data_idx
argument_list|,
name|matches
index|[
name|i
index|]
operator|.
name|realm_idx
argument_list|)
expr_stmt|;
name|realm
operator|=
operator|&
name|hapd
operator|->
name|conf
operator|->
name|nai_realm_data
index|[
name|matches
index|[
name|i
index|]
operator|.
name|realm_data_idx
index|]
expr_stmt|;
name|anqp_add_nai_realm_data
argument_list|(
name|buf
argument_list|,
name|realm
argument_list|,
name|matches
index|[
name|i
index|]
operator|.
name|realm_idx
argument_list|)
expr_stmt|;
block|}
name|gas_anqp_set_element_len
argument_list|(
name|buf
argument_list|,
name|realm_list_len
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|anqp_add_nai_realm
parameter_list|(
name|struct
name|hostapd_data
modifier|*
name|hapd
parameter_list|,
name|struct
name|wpabuf
modifier|*
name|buf
parameter_list|,
specifier|const
name|u8
modifier|*
name|home_realm
parameter_list|,
name|size_t
name|home_realm_len
parameter_list|,
name|int
name|nai_realm
parameter_list|,
name|int
name|nai_home_realm
parameter_list|)
block|{
if|if
condition|(
name|nai_realm
operator|&&
name|hapd
operator|->
name|conf
operator|->
name|nai_realm_data
condition|)
block|{
name|u8
modifier|*
name|len
decl_stmt|;
name|unsigned
name|int
name|i
decl_stmt|,
name|j
decl_stmt|;
name|len
operator|=
name|gas_anqp_add_element
argument_list|(
name|buf
argument_list|,
name|ANQP_NAI_REALM
argument_list|)
expr_stmt|;
name|wpabuf_put_le16
argument_list|(
name|buf
argument_list|,
name|hapd
operator|->
name|conf
operator|->
name|nai_realm_count
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|hapd
operator|->
name|conf
operator|->
name|nai_realm_count
condition|;
name|i
operator|++
control|)
block|{
name|u8
modifier|*
name|realm_data_len
decl_stmt|,
modifier|*
name|realm_len
decl_stmt|;
name|struct
name|hostapd_nai_realm_data
modifier|*
name|realm
decl_stmt|;
name|realm
operator|=
operator|&
name|hapd
operator|->
name|conf
operator|->
name|nai_realm_data
index|[
name|i
index|]
expr_stmt|;
name|realm_data_len
operator|=
name|wpabuf_put
argument_list|(
name|buf
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|wpabuf_put_u8
argument_list|(
name|buf
argument_list|,
name|realm
operator|->
name|encoding
argument_list|)
expr_stmt|;
name|realm_len
operator|=
name|wpabuf_put
argument_list|(
name|buf
argument_list|,
literal|1
argument_list|)
expr_stmt|;
for|for
control|(
name|j
operator|=
literal|0
init|;
name|realm
operator|->
name|realm
index|[
name|j
index|]
condition|;
name|j
operator|++
control|)
block|{
if|if
condition|(
name|j
operator|>
literal|0
condition|)
name|wpabuf_put_u8
argument_list|(
name|buf
argument_list|,
literal|';'
argument_list|)
expr_stmt|;
name|wpabuf_put_str
argument_list|(
name|buf
argument_list|,
name|realm
operator|->
name|realm
index|[
name|j
index|]
argument_list|)
expr_stmt|;
block|}
operator|*
name|realm_len
operator|=
operator|(
name|u8
operator|*
operator|)
name|wpabuf_put
argument_list|(
name|buf
argument_list|,
literal|0
argument_list|)
operator|-
name|realm_len
operator|-
literal|1
expr_stmt|;
name|anqp_add_nai_realm_eap
argument_list|(
name|buf
argument_list|,
name|realm
argument_list|)
expr_stmt|;
name|gas_anqp_set_element_len
argument_list|(
name|buf
argument_list|,
name|realm_data_len
argument_list|)
expr_stmt|;
block|}
name|gas_anqp_set_element_len
argument_list|(
name|buf
argument_list|,
name|len
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|nai_home_realm
operator|&&
name|hapd
operator|->
name|conf
operator|->
name|nai_realm_data
operator|&&
name|home_realm
condition|)
block|{
name|hs20_add_nai_home_realm_matches
argument_list|(
name|hapd
argument_list|,
name|buf
argument_list|,
name|home_realm
argument_list|,
name|home_realm_len
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|anqp_add_3gpp_cellular_network
parameter_list|(
name|struct
name|hostapd_data
modifier|*
name|hapd
parameter_list|,
name|struct
name|wpabuf
modifier|*
name|buf
parameter_list|)
block|{
if|if
condition|(
name|hapd
operator|->
name|conf
operator|->
name|anqp_3gpp_cell_net
condition|)
block|{
name|wpabuf_put_le16
argument_list|(
name|buf
argument_list|,
name|ANQP_3GPP_CELLULAR_NETWORK
argument_list|)
expr_stmt|;
name|wpabuf_put_le16
argument_list|(
name|buf
argument_list|,
name|hapd
operator|->
name|conf
operator|->
name|anqp_3gpp_cell_net_len
argument_list|)
expr_stmt|;
name|wpabuf_put_data
argument_list|(
name|buf
argument_list|,
name|hapd
operator|->
name|conf
operator|->
name|anqp_3gpp_cell_net
argument_list|,
name|hapd
operator|->
name|conf
operator|->
name|anqp_3gpp_cell_net_len
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|anqp_add_domain_name
parameter_list|(
name|struct
name|hostapd_data
modifier|*
name|hapd
parameter_list|,
name|struct
name|wpabuf
modifier|*
name|buf
parameter_list|)
block|{
if|if
condition|(
name|hapd
operator|->
name|conf
operator|->
name|domain_name
condition|)
block|{
name|wpabuf_put_le16
argument_list|(
name|buf
argument_list|,
name|ANQP_DOMAIN_NAME
argument_list|)
expr_stmt|;
name|wpabuf_put_le16
argument_list|(
name|buf
argument_list|,
name|hapd
operator|->
name|conf
operator|->
name|domain_name_len
argument_list|)
expr_stmt|;
name|wpabuf_put_data
argument_list|(
name|buf
argument_list|,
name|hapd
operator|->
name|conf
operator|->
name|domain_name
argument_list|,
name|hapd
operator|->
name|conf
operator|->
name|domain_name_len
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_ifdef
ifdef|#
directive|ifdef
name|CONFIG_HS20
end_ifdef

begin_function
specifier|static
name|void
name|anqp_add_operator_friendly_name
parameter_list|(
name|struct
name|hostapd_data
modifier|*
name|hapd
parameter_list|,
name|struct
name|wpabuf
modifier|*
name|buf
parameter_list|)
block|{
if|if
condition|(
name|hapd
operator|->
name|conf
operator|->
name|hs20_oper_friendly_name
condition|)
block|{
name|u8
modifier|*
name|len
decl_stmt|;
name|unsigned
name|int
name|i
decl_stmt|;
name|len
operator|=
name|gas_anqp_add_element
argument_list|(
name|buf
argument_list|,
name|ANQP_VENDOR_SPECIFIC
argument_list|)
expr_stmt|;
name|wpabuf_put_be24
argument_list|(
name|buf
argument_list|,
name|OUI_WFA
argument_list|)
expr_stmt|;
name|wpabuf_put_u8
argument_list|(
name|buf
argument_list|,
name|HS20_ANQP_OUI_TYPE
argument_list|)
expr_stmt|;
name|wpabuf_put_u8
argument_list|(
name|buf
argument_list|,
name|HS20_STYPE_OPERATOR_FRIENDLY_NAME
argument_list|)
expr_stmt|;
name|wpabuf_put_u8
argument_list|(
name|buf
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* Reserved */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|hapd
operator|->
name|conf
operator|->
name|hs20_oper_friendly_name_count
condition|;
name|i
operator|++
control|)
block|{
name|struct
name|hostapd_lang_string
modifier|*
name|vn
decl_stmt|;
name|vn
operator|=
operator|&
name|hapd
operator|->
name|conf
operator|->
name|hs20_oper_friendly_name
index|[
name|i
index|]
expr_stmt|;
name|wpabuf_put_u8
argument_list|(
name|buf
argument_list|,
literal|3
operator|+
name|vn
operator|->
name|name_len
argument_list|)
expr_stmt|;
name|wpabuf_put_data
argument_list|(
name|buf
argument_list|,
name|vn
operator|->
name|lang
argument_list|,
literal|3
argument_list|)
expr_stmt|;
name|wpabuf_put_data
argument_list|(
name|buf
argument_list|,
name|vn
operator|->
name|name
argument_list|,
name|vn
operator|->
name|name_len
argument_list|)
expr_stmt|;
block|}
name|gas_anqp_set_element_len
argument_list|(
name|buf
argument_list|,
name|len
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|anqp_add_wan_metrics
parameter_list|(
name|struct
name|hostapd_data
modifier|*
name|hapd
parameter_list|,
name|struct
name|wpabuf
modifier|*
name|buf
parameter_list|)
block|{
if|if
condition|(
name|hapd
operator|->
name|conf
operator|->
name|hs20_wan_metrics
condition|)
block|{
name|u8
modifier|*
name|len
init|=
name|gas_anqp_add_element
argument_list|(
name|buf
argument_list|,
name|ANQP_VENDOR_SPECIFIC
argument_list|)
decl_stmt|;
name|wpabuf_put_be24
argument_list|(
name|buf
argument_list|,
name|OUI_WFA
argument_list|)
expr_stmt|;
name|wpabuf_put_u8
argument_list|(
name|buf
argument_list|,
name|HS20_ANQP_OUI_TYPE
argument_list|)
expr_stmt|;
name|wpabuf_put_u8
argument_list|(
name|buf
argument_list|,
name|HS20_STYPE_WAN_METRICS
argument_list|)
expr_stmt|;
name|wpabuf_put_u8
argument_list|(
name|buf
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* Reserved */
name|wpabuf_put_data
argument_list|(
name|buf
argument_list|,
name|hapd
operator|->
name|conf
operator|->
name|hs20_wan_metrics
argument_list|,
literal|13
argument_list|)
expr_stmt|;
name|gas_anqp_set_element_len
argument_list|(
name|buf
argument_list|,
name|len
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|anqp_add_connection_capability
parameter_list|(
name|struct
name|hostapd_data
modifier|*
name|hapd
parameter_list|,
name|struct
name|wpabuf
modifier|*
name|buf
parameter_list|)
block|{
if|if
condition|(
name|hapd
operator|->
name|conf
operator|->
name|hs20_connection_capability
condition|)
block|{
name|u8
modifier|*
name|len
init|=
name|gas_anqp_add_element
argument_list|(
name|buf
argument_list|,
name|ANQP_VENDOR_SPECIFIC
argument_list|)
decl_stmt|;
name|wpabuf_put_be24
argument_list|(
name|buf
argument_list|,
name|OUI_WFA
argument_list|)
expr_stmt|;
name|wpabuf_put_u8
argument_list|(
name|buf
argument_list|,
name|HS20_ANQP_OUI_TYPE
argument_list|)
expr_stmt|;
name|wpabuf_put_u8
argument_list|(
name|buf
argument_list|,
name|HS20_STYPE_CONNECTION_CAPABILITY
argument_list|)
expr_stmt|;
name|wpabuf_put_u8
argument_list|(
name|buf
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* Reserved */
name|wpabuf_put_data
argument_list|(
name|buf
argument_list|,
name|hapd
operator|->
name|conf
operator|->
name|hs20_connection_capability
argument_list|,
name|hapd
operator|->
name|conf
operator|->
name|hs20_connection_capability_len
argument_list|)
expr_stmt|;
name|gas_anqp_set_element_len
argument_list|(
name|buf
argument_list|,
name|len
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|anqp_add_operating_class
parameter_list|(
name|struct
name|hostapd_data
modifier|*
name|hapd
parameter_list|,
name|struct
name|wpabuf
modifier|*
name|buf
parameter_list|)
block|{
if|if
condition|(
name|hapd
operator|->
name|conf
operator|->
name|hs20_operating_class
condition|)
block|{
name|u8
modifier|*
name|len
init|=
name|gas_anqp_add_element
argument_list|(
name|buf
argument_list|,
name|ANQP_VENDOR_SPECIFIC
argument_list|)
decl_stmt|;
name|wpabuf_put_be24
argument_list|(
name|buf
argument_list|,
name|OUI_WFA
argument_list|)
expr_stmt|;
name|wpabuf_put_u8
argument_list|(
name|buf
argument_list|,
name|HS20_ANQP_OUI_TYPE
argument_list|)
expr_stmt|;
name|wpabuf_put_u8
argument_list|(
name|buf
argument_list|,
name|HS20_STYPE_OPERATING_CLASS
argument_list|)
expr_stmt|;
name|wpabuf_put_u8
argument_list|(
name|buf
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* Reserved */
name|wpabuf_put_data
argument_list|(
name|buf
argument_list|,
name|hapd
operator|->
name|conf
operator|->
name|hs20_operating_class
argument_list|,
name|hapd
operator|->
name|conf
operator|->
name|hs20_operating_class_len
argument_list|)
expr_stmt|;
name|gas_anqp_set_element_len
argument_list|(
name|buf
argument_list|,
name|len
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|anqp_add_osu_provider
parameter_list|(
name|struct
name|wpabuf
modifier|*
name|buf
parameter_list|,
name|struct
name|hostapd_bss_config
modifier|*
name|bss
parameter_list|,
name|struct
name|hs20_osu_provider
modifier|*
name|p
parameter_list|)
block|{
name|u8
modifier|*
name|len
decl_stmt|,
modifier|*
name|len2
decl_stmt|,
modifier|*
name|count
decl_stmt|;
name|unsigned
name|int
name|i
decl_stmt|;
name|len
operator|=
name|wpabuf_put
argument_list|(
name|buf
argument_list|,
literal|2
argument_list|)
expr_stmt|;
comment|/* OSU Provider Length to be filled */
comment|/* OSU Friendly Name Duples */
name|len2
operator|=
name|wpabuf_put
argument_list|(
name|buf
argument_list|,
literal|2
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|p
operator|->
name|friendly_name_count
condition|;
name|i
operator|++
control|)
block|{
name|struct
name|hostapd_lang_string
modifier|*
name|s
init|=
operator|&
name|p
operator|->
name|friendly_name
index|[
name|i
index|]
decl_stmt|;
name|wpabuf_put_u8
argument_list|(
name|buf
argument_list|,
literal|3
operator|+
name|s
operator|->
name|name_len
argument_list|)
expr_stmt|;
name|wpabuf_put_data
argument_list|(
name|buf
argument_list|,
name|s
operator|->
name|lang
argument_list|,
literal|3
argument_list|)
expr_stmt|;
name|wpabuf_put_data
argument_list|(
name|buf
argument_list|,
name|s
operator|->
name|name
argument_list|,
name|s
operator|->
name|name_len
argument_list|)
expr_stmt|;
block|}
name|WPA_PUT_LE16
argument_list|(
name|len2
argument_list|,
operator|(
name|u8
operator|*
operator|)
name|wpabuf_put
argument_list|(
name|buf
argument_list|,
literal|0
argument_list|)
operator|-
name|len2
operator|-
literal|2
argument_list|)
expr_stmt|;
comment|/* OSU Server URI */
if|if
condition|(
name|p
operator|->
name|server_uri
condition|)
block|{
name|wpabuf_put_u8
argument_list|(
name|buf
argument_list|,
name|os_strlen
argument_list|(
name|p
operator|->
name|server_uri
argument_list|)
argument_list|)
expr_stmt|;
name|wpabuf_put_str
argument_list|(
name|buf
argument_list|,
name|p
operator|->
name|server_uri
argument_list|)
expr_stmt|;
block|}
else|else
name|wpabuf_put_u8
argument_list|(
name|buf
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* OSU Method List */
name|count
operator|=
name|wpabuf_put
argument_list|(
name|buf
argument_list|,
literal|1
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|p
operator|->
name|method_list
index|[
name|i
index|]
operator|>=
literal|0
condition|;
name|i
operator|++
control|)
name|wpabuf_put_u8
argument_list|(
name|buf
argument_list|,
name|p
operator|->
name|method_list
index|[
name|i
index|]
argument_list|)
expr_stmt|;
operator|*
name|count
operator|=
name|i
expr_stmt|;
comment|/* Icons Available */
name|len2
operator|=
name|wpabuf_put
argument_list|(
name|buf
argument_list|,
literal|2
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|p
operator|->
name|icons_count
condition|;
name|i
operator|++
control|)
block|{
name|size_t
name|j
decl_stmt|;
name|struct
name|hs20_icon
modifier|*
name|icon
init|=
name|NULL
decl_stmt|;
for|for
control|(
name|j
operator|=
literal|0
init|;
name|j
operator|<
name|bss
operator|->
name|hs20_icons_count
operator|&&
operator|!
name|icon
condition|;
name|j
operator|++
control|)
block|{
if|if
condition|(
name|os_strcmp
argument_list|(
name|p
operator|->
name|icons
index|[
name|i
index|]
argument_list|,
name|bss
operator|->
name|hs20_icons
index|[
name|j
index|]
operator|.
name|name
argument_list|)
operator|==
literal|0
condition|)
name|icon
operator|=
operator|&
name|bss
operator|->
name|hs20_icons
index|[
name|j
index|]
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|icon
condition|)
continue|continue;
comment|/* icon info not found */
name|wpabuf_put_le16
argument_list|(
name|buf
argument_list|,
name|icon
operator|->
name|width
argument_list|)
expr_stmt|;
name|wpabuf_put_le16
argument_list|(
name|buf
argument_list|,
name|icon
operator|->
name|height
argument_list|)
expr_stmt|;
name|wpabuf_put_data
argument_list|(
name|buf
argument_list|,
name|icon
operator|->
name|language
argument_list|,
literal|3
argument_list|)
expr_stmt|;
name|wpabuf_put_u8
argument_list|(
name|buf
argument_list|,
name|os_strlen
argument_list|(
name|icon
operator|->
name|type
argument_list|)
argument_list|)
expr_stmt|;
name|wpabuf_put_str
argument_list|(
name|buf
argument_list|,
name|icon
operator|->
name|type
argument_list|)
expr_stmt|;
name|wpabuf_put_u8
argument_list|(
name|buf
argument_list|,
name|os_strlen
argument_list|(
name|icon
operator|->
name|name
argument_list|)
argument_list|)
expr_stmt|;
name|wpabuf_put_str
argument_list|(
name|buf
argument_list|,
name|icon
operator|->
name|name
argument_list|)
expr_stmt|;
block|}
name|WPA_PUT_LE16
argument_list|(
name|len2
argument_list|,
operator|(
name|u8
operator|*
operator|)
name|wpabuf_put
argument_list|(
name|buf
argument_list|,
literal|0
argument_list|)
operator|-
name|len2
operator|-
literal|2
argument_list|)
expr_stmt|;
comment|/* OSU_NAI */
if|if
condition|(
name|p
operator|->
name|osu_nai
condition|)
block|{
name|wpabuf_put_u8
argument_list|(
name|buf
argument_list|,
name|os_strlen
argument_list|(
name|p
operator|->
name|osu_nai
argument_list|)
argument_list|)
expr_stmt|;
name|wpabuf_put_str
argument_list|(
name|buf
argument_list|,
name|p
operator|->
name|osu_nai
argument_list|)
expr_stmt|;
block|}
else|else
name|wpabuf_put_u8
argument_list|(
name|buf
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* OSU Service Description Duples */
name|len2
operator|=
name|wpabuf_put
argument_list|(
name|buf
argument_list|,
literal|2
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|p
operator|->
name|service_desc_count
condition|;
name|i
operator|++
control|)
block|{
name|struct
name|hostapd_lang_string
modifier|*
name|s
init|=
operator|&
name|p
operator|->
name|service_desc
index|[
name|i
index|]
decl_stmt|;
name|wpabuf_put_u8
argument_list|(
name|buf
argument_list|,
literal|3
operator|+
name|s
operator|->
name|name_len
argument_list|)
expr_stmt|;
name|wpabuf_put_data
argument_list|(
name|buf
argument_list|,
name|s
operator|->
name|lang
argument_list|,
literal|3
argument_list|)
expr_stmt|;
name|wpabuf_put_data
argument_list|(
name|buf
argument_list|,
name|s
operator|->
name|name
argument_list|,
name|s
operator|->
name|name_len
argument_list|)
expr_stmt|;
block|}
name|WPA_PUT_LE16
argument_list|(
name|len2
argument_list|,
operator|(
name|u8
operator|*
operator|)
name|wpabuf_put
argument_list|(
name|buf
argument_list|,
literal|0
argument_list|)
operator|-
name|len2
operator|-
literal|2
argument_list|)
expr_stmt|;
name|WPA_PUT_LE16
argument_list|(
name|len
argument_list|,
operator|(
name|u8
operator|*
operator|)
name|wpabuf_put
argument_list|(
name|buf
argument_list|,
literal|0
argument_list|)
operator|-
name|len
operator|-
literal|2
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|anqp_add_osu_providers_list
parameter_list|(
name|struct
name|hostapd_data
modifier|*
name|hapd
parameter_list|,
name|struct
name|wpabuf
modifier|*
name|buf
parameter_list|)
block|{
if|if
condition|(
name|hapd
operator|->
name|conf
operator|->
name|hs20_osu_providers_count
condition|)
block|{
name|size_t
name|i
decl_stmt|;
name|u8
modifier|*
name|len
init|=
name|gas_anqp_add_element
argument_list|(
name|buf
argument_list|,
name|ANQP_VENDOR_SPECIFIC
argument_list|)
decl_stmt|;
name|wpabuf_put_be24
argument_list|(
name|buf
argument_list|,
name|OUI_WFA
argument_list|)
expr_stmt|;
name|wpabuf_put_u8
argument_list|(
name|buf
argument_list|,
name|HS20_ANQP_OUI_TYPE
argument_list|)
expr_stmt|;
name|wpabuf_put_u8
argument_list|(
name|buf
argument_list|,
name|HS20_STYPE_OSU_PROVIDERS_LIST
argument_list|)
expr_stmt|;
name|wpabuf_put_u8
argument_list|(
name|buf
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* Reserved */
comment|/* OSU SSID */
name|wpabuf_put_u8
argument_list|(
name|buf
argument_list|,
name|hapd
operator|->
name|conf
operator|->
name|osu_ssid_len
argument_list|)
expr_stmt|;
name|wpabuf_put_data
argument_list|(
name|buf
argument_list|,
name|hapd
operator|->
name|conf
operator|->
name|osu_ssid
argument_list|,
name|hapd
operator|->
name|conf
operator|->
name|osu_ssid_len
argument_list|)
expr_stmt|;
comment|/* Number of OSU Providers */
name|wpabuf_put_u8
argument_list|(
name|buf
argument_list|,
name|hapd
operator|->
name|conf
operator|->
name|hs20_osu_providers_count
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|hapd
operator|->
name|conf
operator|->
name|hs20_osu_providers_count
condition|;
name|i
operator|++
control|)
block|{
name|anqp_add_osu_provider
argument_list|(
name|buf
argument_list|,
name|hapd
operator|->
name|conf
argument_list|,
operator|&
name|hapd
operator|->
name|conf
operator|->
name|hs20_osu_providers
index|[
name|i
index|]
argument_list|)
expr_stmt|;
block|}
name|gas_anqp_set_element_len
argument_list|(
name|buf
argument_list|,
name|len
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|anqp_add_icon_binary_file
parameter_list|(
name|struct
name|hostapd_data
modifier|*
name|hapd
parameter_list|,
name|struct
name|wpabuf
modifier|*
name|buf
parameter_list|,
specifier|const
name|u8
modifier|*
name|name
parameter_list|,
name|size_t
name|name_len
parameter_list|)
block|{
name|struct
name|hs20_icon
modifier|*
name|icon
decl_stmt|;
name|size_t
name|i
decl_stmt|;
name|u8
modifier|*
name|len
decl_stmt|;
name|wpa_hexdump_ascii
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"HS 2.0: Requested Icon Filename"
argument_list|,
name|name
argument_list|,
name|name_len
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|hapd
operator|->
name|conf
operator|->
name|hs20_icons_count
condition|;
name|i
operator|++
control|)
block|{
name|icon
operator|=
operator|&
name|hapd
operator|->
name|conf
operator|->
name|hs20_icons
index|[
name|i
index|]
expr_stmt|;
if|if
condition|(
name|name_len
operator|==
name|os_strlen
argument_list|(
name|icon
operator|->
name|name
argument_list|)
operator|&&
name|os_memcmp
argument_list|(
name|name
argument_list|,
name|icon
operator|->
name|name
argument_list|,
name|name_len
argument_list|)
operator|==
literal|0
condition|)
break|break;
block|}
if|if
condition|(
name|i
operator|<
name|hapd
operator|->
name|conf
operator|->
name|hs20_icons_count
condition|)
name|icon
operator|=
operator|&
name|hapd
operator|->
name|conf
operator|->
name|hs20_icons
index|[
name|i
index|]
expr_stmt|;
else|else
name|icon
operator|=
name|NULL
expr_stmt|;
name|len
operator|=
name|gas_anqp_add_element
argument_list|(
name|buf
argument_list|,
name|ANQP_VENDOR_SPECIFIC
argument_list|)
expr_stmt|;
name|wpabuf_put_be24
argument_list|(
name|buf
argument_list|,
name|OUI_WFA
argument_list|)
expr_stmt|;
name|wpabuf_put_u8
argument_list|(
name|buf
argument_list|,
name|HS20_ANQP_OUI_TYPE
argument_list|)
expr_stmt|;
name|wpabuf_put_u8
argument_list|(
name|buf
argument_list|,
name|HS20_STYPE_ICON_BINARY_FILE
argument_list|)
expr_stmt|;
name|wpabuf_put_u8
argument_list|(
name|buf
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* Reserved */
if|if
condition|(
name|icon
condition|)
block|{
name|char
modifier|*
name|data
decl_stmt|;
name|size_t
name|data_len
decl_stmt|;
name|data
operator|=
name|os_readfile
argument_list|(
name|icon
operator|->
name|file
argument_list|,
operator|&
name|data_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|data
operator|==
name|NULL
operator|||
name|data_len
operator|>
literal|65535
condition|)
block|{
name|wpabuf_put_u8
argument_list|(
name|buf
argument_list|,
literal|2
argument_list|)
expr_stmt|;
comment|/* Download Status: 						* Unspecified file error */
name|wpabuf_put_u8
argument_list|(
name|buf
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|wpabuf_put_le16
argument_list|(
name|buf
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|wpabuf_put_u8
argument_list|(
name|buf
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* Download Status: Success */
name|wpabuf_put_u8
argument_list|(
name|buf
argument_list|,
name|os_strlen
argument_list|(
name|icon
operator|->
name|type
argument_list|)
argument_list|)
expr_stmt|;
name|wpabuf_put_str
argument_list|(
name|buf
argument_list|,
name|icon
operator|->
name|type
argument_list|)
expr_stmt|;
name|wpabuf_put_le16
argument_list|(
name|buf
argument_list|,
name|data_len
argument_list|)
expr_stmt|;
name|wpabuf_put_data
argument_list|(
name|buf
argument_list|,
name|data
argument_list|,
name|data_len
argument_list|)
expr_stmt|;
block|}
name|os_free
argument_list|(
name|data
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|wpabuf_put_u8
argument_list|(
name|buf
argument_list|,
literal|1
argument_list|)
expr_stmt|;
comment|/* Download Status: File not found */
name|wpabuf_put_u8
argument_list|(
name|buf
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|wpabuf_put_le16
argument_list|(
name|buf
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
name|gas_anqp_set_element_len
argument_list|(
name|buf
argument_list|,
name|len
argument_list|)
expr_stmt|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* CONFIG_HS20 */
end_comment

begin_function
specifier|static
name|struct
name|wpabuf
modifier|*
name|gas_serv_build_gas_resp_payload
parameter_list|(
name|struct
name|hostapd_data
modifier|*
name|hapd
parameter_list|,
name|unsigned
name|int
name|request
parameter_list|,
specifier|const
name|u8
modifier|*
name|home_realm
parameter_list|,
name|size_t
name|home_realm_len
parameter_list|,
specifier|const
name|u8
modifier|*
name|icon_name
parameter_list|,
name|size_t
name|icon_name_len
parameter_list|)
block|{
name|struct
name|wpabuf
modifier|*
name|buf
decl_stmt|;
name|size_t
name|len
decl_stmt|;
name|len
operator|=
literal|1400
expr_stmt|;
if|if
condition|(
name|request
operator|&
operator|(
name|ANQP_REQ_NAI_REALM
operator||
name|ANQP_REQ_NAI_HOME_REALM
operator|)
condition|)
name|len
operator|+=
literal|1000
expr_stmt|;
if|if
condition|(
name|request
operator|&
name|ANQP_REQ_ICON_REQUEST
condition|)
name|len
operator|+=
literal|65536
expr_stmt|;
name|buf
operator|=
name|wpabuf_alloc
argument_list|(
name|len
argument_list|)
expr_stmt|;
if|if
condition|(
name|buf
operator|==
name|NULL
condition|)
return|return
name|NULL
return|;
if|if
condition|(
name|request
operator|&
name|ANQP_REQ_CAPABILITY_LIST
condition|)
name|anqp_add_capab_list
argument_list|(
name|hapd
argument_list|,
name|buf
argument_list|)
expr_stmt|;
if|if
condition|(
name|request
operator|&
name|ANQP_REQ_VENUE_NAME
condition|)
name|anqp_add_venue_name
argument_list|(
name|hapd
argument_list|,
name|buf
argument_list|)
expr_stmt|;
if|if
condition|(
name|request
operator|&
name|ANQP_REQ_NETWORK_AUTH_TYPE
condition|)
name|anqp_add_network_auth_type
argument_list|(
name|hapd
argument_list|,
name|buf
argument_list|)
expr_stmt|;
if|if
condition|(
name|request
operator|&
name|ANQP_REQ_ROAMING_CONSORTIUM
condition|)
name|anqp_add_roaming_consortium
argument_list|(
name|hapd
argument_list|,
name|buf
argument_list|)
expr_stmt|;
if|if
condition|(
name|request
operator|&
name|ANQP_REQ_IP_ADDR_TYPE_AVAILABILITY
condition|)
name|anqp_add_ip_addr_type_availability
argument_list|(
name|hapd
argument_list|,
name|buf
argument_list|)
expr_stmt|;
if|if
condition|(
name|request
operator|&
operator|(
name|ANQP_REQ_NAI_REALM
operator||
name|ANQP_REQ_NAI_HOME_REALM
operator|)
condition|)
name|anqp_add_nai_realm
argument_list|(
name|hapd
argument_list|,
name|buf
argument_list|,
name|home_realm
argument_list|,
name|home_realm_len
argument_list|,
name|request
operator|&
name|ANQP_REQ_NAI_REALM
argument_list|,
name|request
operator|&
name|ANQP_REQ_NAI_HOME_REALM
argument_list|)
expr_stmt|;
if|if
condition|(
name|request
operator|&
name|ANQP_REQ_3GPP_CELLULAR_NETWORK
condition|)
name|anqp_add_3gpp_cellular_network
argument_list|(
name|hapd
argument_list|,
name|buf
argument_list|)
expr_stmt|;
if|if
condition|(
name|request
operator|&
name|ANQP_REQ_DOMAIN_NAME
condition|)
name|anqp_add_domain_name
argument_list|(
name|hapd
argument_list|,
name|buf
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|CONFIG_HS20
if|if
condition|(
name|request
operator|&
name|ANQP_REQ_HS_CAPABILITY_LIST
condition|)
name|anqp_add_hs_capab_list
argument_list|(
name|hapd
argument_list|,
name|buf
argument_list|)
expr_stmt|;
if|if
condition|(
name|request
operator|&
name|ANQP_REQ_OPERATOR_FRIENDLY_NAME
condition|)
name|anqp_add_operator_friendly_name
argument_list|(
name|hapd
argument_list|,
name|buf
argument_list|)
expr_stmt|;
if|if
condition|(
name|request
operator|&
name|ANQP_REQ_WAN_METRICS
condition|)
name|anqp_add_wan_metrics
argument_list|(
name|hapd
argument_list|,
name|buf
argument_list|)
expr_stmt|;
if|if
condition|(
name|request
operator|&
name|ANQP_REQ_CONNECTION_CAPABILITY
condition|)
name|anqp_add_connection_capability
argument_list|(
name|hapd
argument_list|,
name|buf
argument_list|)
expr_stmt|;
if|if
condition|(
name|request
operator|&
name|ANQP_REQ_OPERATING_CLASS
condition|)
name|anqp_add_operating_class
argument_list|(
name|hapd
argument_list|,
name|buf
argument_list|)
expr_stmt|;
if|if
condition|(
name|request
operator|&
name|ANQP_REQ_OSU_PROVIDERS_LIST
condition|)
name|anqp_add_osu_providers_list
argument_list|(
name|hapd
argument_list|,
name|buf
argument_list|)
expr_stmt|;
if|if
condition|(
name|request
operator|&
name|ANQP_REQ_ICON_REQUEST
condition|)
name|anqp_add_icon_binary_file
argument_list|(
name|hapd
argument_list|,
name|buf
argument_list|,
name|icon_name
argument_list|,
name|icon_name_len
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* CONFIG_HS20 */
return|return
name|buf
return|;
block|}
end_function

begin_struct
struct|struct
name|anqp_query_info
block|{
name|unsigned
name|int
name|request
decl_stmt|;
specifier|const
name|u8
modifier|*
name|home_realm_query
decl_stmt|;
name|size_t
name|home_realm_query_len
decl_stmt|;
specifier|const
name|u8
modifier|*
name|icon_name
decl_stmt|;
name|size_t
name|icon_name_len
decl_stmt|;
name|int
name|p2p_sd
decl_stmt|;
block|}
struct|;
end_struct

begin_function
specifier|static
name|void
name|set_anqp_req
parameter_list|(
name|unsigned
name|int
name|bit
parameter_list|,
specifier|const
name|char
modifier|*
name|name
parameter_list|,
name|int
name|local
parameter_list|,
name|struct
name|anqp_query_info
modifier|*
name|qi
parameter_list|)
block|{
name|qi
operator|->
name|request
operator||=
name|bit
expr_stmt|;
if|if
condition|(
name|local
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"ANQP: %s (local)"
argument_list|,
name|name
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"ANQP: %s not available"
argument_list|,
name|name
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|rx_anqp_query_list_id
parameter_list|(
name|struct
name|hostapd_data
modifier|*
name|hapd
parameter_list|,
name|u16
name|info_id
parameter_list|,
name|struct
name|anqp_query_info
modifier|*
name|qi
parameter_list|)
block|{
switch|switch
condition|(
name|info_id
condition|)
block|{
case|case
name|ANQP_CAPABILITY_LIST
case|:
name|set_anqp_req
argument_list|(
name|ANQP_REQ_CAPABILITY_LIST
argument_list|,
literal|"Capability List"
argument_list|,
literal|1
argument_list|,
name|qi
argument_list|)
expr_stmt|;
break|break;
case|case
name|ANQP_VENUE_NAME
case|:
name|set_anqp_req
argument_list|(
name|ANQP_REQ_VENUE_NAME
argument_list|,
literal|"Venue Name"
argument_list|,
name|hapd
operator|->
name|conf
operator|->
name|venue_name
operator|!=
name|NULL
argument_list|,
name|qi
argument_list|)
expr_stmt|;
break|break;
case|case
name|ANQP_NETWORK_AUTH_TYPE
case|:
name|set_anqp_req
argument_list|(
name|ANQP_REQ_NETWORK_AUTH_TYPE
argument_list|,
literal|"Network Auth Type"
argument_list|,
name|hapd
operator|->
name|conf
operator|->
name|network_auth_type
operator|!=
name|NULL
argument_list|,
name|qi
argument_list|)
expr_stmt|;
break|break;
case|case
name|ANQP_ROAMING_CONSORTIUM
case|:
name|set_anqp_req
argument_list|(
name|ANQP_REQ_ROAMING_CONSORTIUM
argument_list|,
literal|"Roaming Consortium"
argument_list|,
name|hapd
operator|->
name|conf
operator|->
name|roaming_consortium
operator|!=
name|NULL
argument_list|,
name|qi
argument_list|)
expr_stmt|;
break|break;
case|case
name|ANQP_IP_ADDR_TYPE_AVAILABILITY
case|:
name|set_anqp_req
argument_list|(
name|ANQP_REQ_IP_ADDR_TYPE_AVAILABILITY
argument_list|,
literal|"IP Addr Type Availability"
argument_list|,
name|hapd
operator|->
name|conf
operator|->
name|ipaddr_type_configured
argument_list|,
name|qi
argument_list|)
expr_stmt|;
break|break;
case|case
name|ANQP_NAI_REALM
case|:
name|set_anqp_req
argument_list|(
name|ANQP_REQ_NAI_REALM
argument_list|,
literal|"NAI Realm"
argument_list|,
name|hapd
operator|->
name|conf
operator|->
name|nai_realm_data
operator|!=
name|NULL
argument_list|,
name|qi
argument_list|)
expr_stmt|;
break|break;
case|case
name|ANQP_3GPP_CELLULAR_NETWORK
case|:
name|set_anqp_req
argument_list|(
name|ANQP_REQ_3GPP_CELLULAR_NETWORK
argument_list|,
literal|"3GPP Cellular Network"
argument_list|,
name|hapd
operator|->
name|conf
operator|->
name|anqp_3gpp_cell_net
operator|!=
name|NULL
argument_list|,
name|qi
argument_list|)
expr_stmt|;
break|break;
case|case
name|ANQP_DOMAIN_NAME
case|:
name|set_anqp_req
argument_list|(
name|ANQP_REQ_DOMAIN_NAME
argument_list|,
literal|"Domain Name"
argument_list|,
name|hapd
operator|->
name|conf
operator|->
name|domain_name
operator|!=
name|NULL
argument_list|,
name|qi
argument_list|)
expr_stmt|;
break|break;
default|default:
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"ANQP: Unsupported Info Id %u"
argument_list|,
name|info_id
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|rx_anqp_query_list
parameter_list|(
name|struct
name|hostapd_data
modifier|*
name|hapd
parameter_list|,
specifier|const
name|u8
modifier|*
name|pos
parameter_list|,
specifier|const
name|u8
modifier|*
name|end
parameter_list|,
name|struct
name|anqp_query_info
modifier|*
name|qi
parameter_list|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"ANQP: %u Info IDs requested in Query list"
argument_list|,
call|(
name|unsigned
name|int
call|)
argument_list|(
name|end
operator|-
name|pos
argument_list|)
operator|/
literal|2
argument_list|)
expr_stmt|;
while|while
condition|(
name|pos
operator|+
literal|2
operator|<=
name|end
condition|)
block|{
name|rx_anqp_query_list_id
argument_list|(
name|hapd
argument_list|,
name|WPA_GET_LE16
argument_list|(
name|pos
argument_list|)
argument_list|,
name|qi
argument_list|)
expr_stmt|;
name|pos
operator|+=
literal|2
expr_stmt|;
block|}
block|}
end_function

begin_ifdef
ifdef|#
directive|ifdef
name|CONFIG_HS20
end_ifdef

begin_function
specifier|static
name|void
name|rx_anqp_hs_query_list
parameter_list|(
name|struct
name|hostapd_data
modifier|*
name|hapd
parameter_list|,
name|u8
name|subtype
parameter_list|,
name|struct
name|anqp_query_info
modifier|*
name|qi
parameter_list|)
block|{
switch|switch
condition|(
name|subtype
condition|)
block|{
case|case
name|HS20_STYPE_CAPABILITY_LIST
case|:
name|set_anqp_req
argument_list|(
name|ANQP_REQ_HS_CAPABILITY_LIST
argument_list|,
literal|"HS Capability List"
argument_list|,
literal|1
argument_list|,
name|qi
argument_list|)
expr_stmt|;
break|break;
case|case
name|HS20_STYPE_OPERATOR_FRIENDLY_NAME
case|:
name|set_anqp_req
argument_list|(
name|ANQP_REQ_OPERATOR_FRIENDLY_NAME
argument_list|,
literal|"Operator Friendly Name"
argument_list|,
name|hapd
operator|->
name|conf
operator|->
name|hs20_oper_friendly_name
operator|!=
name|NULL
argument_list|,
name|qi
argument_list|)
expr_stmt|;
break|break;
case|case
name|HS20_STYPE_WAN_METRICS
case|:
name|set_anqp_req
argument_list|(
name|ANQP_REQ_WAN_METRICS
argument_list|,
literal|"WAN Metrics"
argument_list|,
name|hapd
operator|->
name|conf
operator|->
name|hs20_wan_metrics
operator|!=
name|NULL
argument_list|,
name|qi
argument_list|)
expr_stmt|;
break|break;
case|case
name|HS20_STYPE_CONNECTION_CAPABILITY
case|:
name|set_anqp_req
argument_list|(
name|ANQP_REQ_CONNECTION_CAPABILITY
argument_list|,
literal|"Connection Capability"
argument_list|,
name|hapd
operator|->
name|conf
operator|->
name|hs20_connection_capability
operator|!=
name|NULL
argument_list|,
name|qi
argument_list|)
expr_stmt|;
break|break;
case|case
name|HS20_STYPE_OPERATING_CLASS
case|:
name|set_anqp_req
argument_list|(
name|ANQP_REQ_OPERATING_CLASS
argument_list|,
literal|"Operating Class"
argument_list|,
name|hapd
operator|->
name|conf
operator|->
name|hs20_operating_class
operator|!=
name|NULL
argument_list|,
name|qi
argument_list|)
expr_stmt|;
break|break;
case|case
name|HS20_STYPE_OSU_PROVIDERS_LIST
case|:
name|set_anqp_req
argument_list|(
name|ANQP_REQ_OSU_PROVIDERS_LIST
argument_list|,
literal|"OSU Providers list"
argument_list|,
name|hapd
operator|->
name|conf
operator|->
name|hs20_osu_providers_count
argument_list|,
name|qi
argument_list|)
expr_stmt|;
break|break;
default|default:
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"ANQP: Unsupported HS 2.0 subtype %u"
argument_list|,
name|subtype
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|rx_anqp_hs_nai_home_realm
parameter_list|(
name|struct
name|hostapd_data
modifier|*
name|hapd
parameter_list|,
specifier|const
name|u8
modifier|*
name|pos
parameter_list|,
specifier|const
name|u8
modifier|*
name|end
parameter_list|,
name|struct
name|anqp_query_info
modifier|*
name|qi
parameter_list|)
block|{
name|qi
operator|->
name|request
operator||=
name|ANQP_REQ_NAI_HOME_REALM
expr_stmt|;
name|qi
operator|->
name|home_realm_query
operator|=
name|pos
expr_stmt|;
name|qi
operator|->
name|home_realm_query_len
operator|=
name|end
operator|-
name|pos
expr_stmt|;
if|if
condition|(
name|hapd
operator|->
name|conf
operator|->
name|nai_realm_data
operator|!=
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"ANQP: HS 2.0 NAI Home Realm Query "
literal|"(local)"
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"ANQP: HS 2.0 NAI Home Realm Query not "
literal|"available"
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|rx_anqp_hs_icon_request
parameter_list|(
name|struct
name|hostapd_data
modifier|*
name|hapd
parameter_list|,
specifier|const
name|u8
modifier|*
name|pos
parameter_list|,
specifier|const
name|u8
modifier|*
name|end
parameter_list|,
name|struct
name|anqp_query_info
modifier|*
name|qi
parameter_list|)
block|{
name|qi
operator|->
name|request
operator||=
name|ANQP_REQ_ICON_REQUEST
expr_stmt|;
name|qi
operator|->
name|icon_name
operator|=
name|pos
expr_stmt|;
name|qi
operator|->
name|icon_name_len
operator|=
name|end
operator|-
name|pos
expr_stmt|;
if|if
condition|(
name|hapd
operator|->
name|conf
operator|->
name|hs20_icons_count
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"ANQP: HS 2.0 Icon Request Query "
literal|"(local)"
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"ANQP: HS 2.0 Icon Request Query not "
literal|"available"
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|rx_anqp_vendor_specific
parameter_list|(
name|struct
name|hostapd_data
modifier|*
name|hapd
parameter_list|,
specifier|const
name|u8
modifier|*
name|pos
parameter_list|,
specifier|const
name|u8
modifier|*
name|end
parameter_list|,
name|struct
name|anqp_query_info
modifier|*
name|qi
parameter_list|)
block|{
name|u32
name|oui
decl_stmt|;
name|u8
name|subtype
decl_stmt|;
if|if
condition|(
name|pos
operator|+
literal|4
operator|>
name|end
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"ANQP: Too short vendor specific ANQP "
literal|"Query element"
argument_list|)
expr_stmt|;
return|return;
block|}
name|oui
operator|=
name|WPA_GET_BE24
argument_list|(
name|pos
argument_list|)
expr_stmt|;
name|pos
operator|+=
literal|3
expr_stmt|;
if|if
condition|(
name|oui
operator|!=
name|OUI_WFA
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"ANQP: Unsupported vendor OUI %06x"
argument_list|,
name|oui
argument_list|)
expr_stmt|;
return|return;
block|}
ifdef|#
directive|ifdef
name|CONFIG_P2P
if|if
condition|(
operator|*
name|pos
operator|==
name|P2P_OUI_TYPE
condition|)
block|{
comment|/* 		 * This is for P2P SD and will be taken care of by the P2P 		 * implementation. This query needs to be ignored in the generic 		 * GAS server to avoid duplicated response. 		 */
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"ANQP: Ignore WFA vendor type %u (P2P SD) in generic GAS server"
argument_list|,
operator|*
name|pos
argument_list|)
expr_stmt|;
name|qi
operator|->
name|p2p_sd
operator|=
literal|1
expr_stmt|;
return|return;
block|}
endif|#
directive|endif
comment|/* CONFIG_P2P */
if|if
condition|(
operator|*
name|pos
operator|!=
name|HS20_ANQP_OUI_TYPE
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"ANQP: Unsupported WFA vendor type %u"
argument_list|,
operator|*
name|pos
argument_list|)
expr_stmt|;
return|return;
block|}
name|pos
operator|++
expr_stmt|;
if|if
condition|(
name|pos
operator|+
literal|1
operator|>=
name|end
condition|)
return|return;
name|subtype
operator|=
operator|*
name|pos
operator|++
expr_stmt|;
name|pos
operator|++
expr_stmt|;
comment|/* Reserved */
switch|switch
condition|(
name|subtype
condition|)
block|{
case|case
name|HS20_STYPE_QUERY_LIST
case|:
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"ANQP: HS 2.0 Query List"
argument_list|)
expr_stmt|;
while|while
condition|(
name|pos
operator|<
name|end
condition|)
block|{
name|rx_anqp_hs_query_list
argument_list|(
name|hapd
argument_list|,
operator|*
name|pos
argument_list|,
name|qi
argument_list|)
expr_stmt|;
name|pos
operator|++
expr_stmt|;
block|}
break|break;
case|case
name|HS20_STYPE_NAI_HOME_REALM_QUERY
case|:
name|rx_anqp_hs_nai_home_realm
argument_list|(
name|hapd
argument_list|,
name|pos
argument_list|,
name|end
argument_list|,
name|qi
argument_list|)
expr_stmt|;
break|break;
case|case
name|HS20_STYPE_ICON_REQUEST
case|:
name|rx_anqp_hs_icon_request
argument_list|(
name|hapd
argument_list|,
name|pos
argument_list|,
name|end
argument_list|,
name|qi
argument_list|)
expr_stmt|;
break|break;
default|default:
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"ANQP: Unsupported HS 2.0 query subtype "
literal|"%u"
argument_list|,
name|subtype
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* CONFIG_HS20 */
end_comment

begin_function
specifier|static
name|void
name|gas_serv_req_local_processing
parameter_list|(
name|struct
name|hostapd_data
modifier|*
name|hapd
parameter_list|,
specifier|const
name|u8
modifier|*
name|sa
parameter_list|,
name|u8
name|dialog_token
parameter_list|,
name|struct
name|anqp_query_info
modifier|*
name|qi
parameter_list|,
name|int
name|prot
parameter_list|)
block|{
name|struct
name|wpabuf
modifier|*
name|buf
decl_stmt|,
modifier|*
name|tx_buf
decl_stmt|;
name|buf
operator|=
name|gas_serv_build_gas_resp_payload
argument_list|(
name|hapd
argument_list|,
name|qi
operator|->
name|request
argument_list|,
name|qi
operator|->
name|home_realm_query
argument_list|,
name|qi
operator|->
name|home_realm_query_len
argument_list|,
name|qi
operator|->
name|icon_name
argument_list|,
name|qi
operator|->
name|icon_name_len
argument_list|)
expr_stmt|;
name|wpa_hexdump_buf
argument_list|(
name|MSG_MSGDUMP
argument_list|,
literal|"ANQP: Locally generated ANQP responses"
argument_list|,
name|buf
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|buf
condition|)
return|return;
ifdef|#
directive|ifdef
name|CONFIG_P2P
if|if
condition|(
name|wpabuf_len
argument_list|(
name|buf
argument_list|)
operator|==
literal|0
operator|&&
name|qi
operator|->
name|p2p_sd
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"ANQP: Do not send response to P2P SD from generic GAS service (P2P SD implementation will process this)"
argument_list|)
expr_stmt|;
name|wpabuf_free
argument_list|(
name|buf
argument_list|)
expr_stmt|;
return|return;
block|}
endif|#
directive|endif
comment|/* CONFIG_P2P */
if|if
condition|(
name|wpabuf_len
argument_list|(
name|buf
argument_list|)
operator|>
name|hapd
operator|->
name|gas_frag_limit
operator|||
name|hapd
operator|->
name|conf
operator|->
name|gas_comeback_delay
condition|)
block|{
name|struct
name|gas_dialog_info
modifier|*
name|di
decl_stmt|;
name|u16
name|comeback_delay
init|=
literal|1
decl_stmt|;
if|if
condition|(
name|hapd
operator|->
name|conf
operator|->
name|gas_comeback_delay
condition|)
block|{
comment|/* Testing - allow overriding of the delay value */
name|comeback_delay
operator|=
name|hapd
operator|->
name|conf
operator|->
name|gas_comeback_delay
expr_stmt|;
block|}
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"ANQP: Too long response to fit in "
literal|"initial response - use GAS comeback"
argument_list|)
expr_stmt|;
name|di
operator|=
name|gas_dialog_create
argument_list|(
name|hapd
argument_list|,
name|sa
argument_list|,
name|dialog_token
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|di
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"ANQP: Could not create dialog "
literal|"for "
name|MACSTR
literal|" (dialog token %u)"
argument_list|,
name|MAC2STR
argument_list|(
name|sa
argument_list|)
argument_list|,
name|dialog_token
argument_list|)
expr_stmt|;
name|wpabuf_free
argument_list|(
name|buf
argument_list|)
expr_stmt|;
name|tx_buf
operator|=
name|gas_anqp_build_initial_resp_buf
argument_list|(
name|dialog_token
argument_list|,
name|WLAN_STATUS_UNSPECIFIED_FAILURE
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|di
operator|->
name|prot
operator|=
name|prot
expr_stmt|;
name|di
operator|->
name|sd_resp
operator|=
name|buf
expr_stmt|;
name|di
operator|->
name|sd_resp_pos
operator|=
literal|0
expr_stmt|;
name|tx_buf
operator|=
name|gas_anqp_build_initial_resp_buf
argument_list|(
name|dialog_token
argument_list|,
name|WLAN_STATUS_SUCCESS
argument_list|,
name|comeback_delay
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"ANQP: Initial response (no comeback)"
argument_list|)
expr_stmt|;
name|tx_buf
operator|=
name|gas_anqp_build_initial_resp_buf
argument_list|(
name|dialog_token
argument_list|,
name|WLAN_STATUS_SUCCESS
argument_list|,
literal|0
argument_list|,
name|buf
argument_list|)
expr_stmt|;
name|wpabuf_free
argument_list|(
name|buf
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|tx_buf
condition|)
return|return;
if|if
condition|(
name|prot
condition|)
name|convert_to_protected_dual
argument_list|(
name|tx_buf
argument_list|)
expr_stmt|;
name|hostapd_drv_send_action
argument_list|(
name|hapd
argument_list|,
name|hapd
operator|->
name|iface
operator|->
name|freq
argument_list|,
literal|0
argument_list|,
name|sa
argument_list|,
name|wpabuf_head
argument_list|(
name|tx_buf
argument_list|)
argument_list|,
name|wpabuf_len
argument_list|(
name|tx_buf
argument_list|)
argument_list|)
expr_stmt|;
name|wpabuf_free
argument_list|(
name|tx_buf
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|gas_serv_rx_gas_initial_req
parameter_list|(
name|struct
name|hostapd_data
modifier|*
name|hapd
parameter_list|,
specifier|const
name|u8
modifier|*
name|sa
parameter_list|,
specifier|const
name|u8
modifier|*
name|data
parameter_list|,
name|size_t
name|len
parameter_list|,
name|int
name|prot
parameter_list|)
block|{
specifier|const
name|u8
modifier|*
name|pos
init|=
name|data
decl_stmt|;
specifier|const
name|u8
modifier|*
name|end
init|=
name|data
operator|+
name|len
decl_stmt|;
specifier|const
name|u8
modifier|*
name|next
decl_stmt|;
name|u8
name|dialog_token
decl_stmt|;
name|u16
name|slen
decl_stmt|;
name|struct
name|anqp_query_info
name|qi
decl_stmt|;
specifier|const
name|u8
modifier|*
name|adv_proto
decl_stmt|;
if|if
condition|(
name|len
operator|<
literal|1
operator|+
literal|2
condition|)
return|return;
name|os_memset
argument_list|(
operator|&
name|qi
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|qi
argument_list|)
argument_list|)
expr_stmt|;
name|dialog_token
operator|=
operator|*
name|pos
operator|++
expr_stmt|;
name|wpa_msg
argument_list|(
name|hapd
operator|->
name|msg_ctx
argument_list|,
name|MSG_DEBUG
argument_list|,
literal|"GAS: GAS Initial Request from "
name|MACSTR
literal|" (dialog token %u) "
argument_list|,
name|MAC2STR
argument_list|(
name|sa
argument_list|)
argument_list|,
name|dialog_token
argument_list|)
expr_stmt|;
if|if
condition|(
operator|*
name|pos
operator|!=
name|WLAN_EID_ADV_PROTO
condition|)
block|{
name|wpa_msg
argument_list|(
name|hapd
operator|->
name|msg_ctx
argument_list|,
name|MSG_DEBUG
argument_list|,
literal|"GAS: Unexpected IE in GAS Initial Request: %u"
argument_list|,
operator|*
name|pos
argument_list|)
expr_stmt|;
return|return;
block|}
name|adv_proto
operator|=
name|pos
operator|++
expr_stmt|;
name|slen
operator|=
operator|*
name|pos
operator|++
expr_stmt|;
name|next
operator|=
name|pos
operator|+
name|slen
expr_stmt|;
if|if
condition|(
name|next
operator|>
name|end
operator|||
name|slen
operator|<
literal|2
condition|)
block|{
name|wpa_msg
argument_list|(
name|hapd
operator|->
name|msg_ctx
argument_list|,
name|MSG_DEBUG
argument_list|,
literal|"GAS: Invalid IE in GAS Initial Request"
argument_list|)
expr_stmt|;
return|return;
block|}
name|pos
operator|++
expr_stmt|;
comment|/* skip QueryRespLenLimit and PAME-BI */
if|if
condition|(
operator|*
name|pos
operator|!=
name|ACCESS_NETWORK_QUERY_PROTOCOL
condition|)
block|{
name|struct
name|wpabuf
modifier|*
name|buf
decl_stmt|;
name|wpa_msg
argument_list|(
name|hapd
operator|->
name|msg_ctx
argument_list|,
name|MSG_DEBUG
argument_list|,
literal|"GAS: Unsupported GAS advertisement protocol id %u"
argument_list|,
operator|*
name|pos
argument_list|)
expr_stmt|;
if|if
condition|(
name|sa
index|[
literal|0
index|]
operator|&
literal|0x01
condition|)
return|return;
comment|/* Invalid source address - drop silently */
name|buf
operator|=
name|gas_build_initial_resp
argument_list|(
name|dialog_token
argument_list|,
name|WLAN_STATUS_GAS_ADV_PROTO_NOT_SUPPORTED
argument_list|,
literal|0
argument_list|,
literal|2
operator|+
name|slen
operator|+
literal|2
argument_list|)
expr_stmt|;
if|if
condition|(
name|buf
operator|==
name|NULL
condition|)
return|return;
name|wpabuf_put_data
argument_list|(
name|buf
argument_list|,
name|adv_proto
argument_list|,
literal|2
operator|+
name|slen
argument_list|)
expr_stmt|;
name|wpabuf_put_le16
argument_list|(
name|buf
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* Query Response Length */
if|if
condition|(
name|prot
condition|)
name|convert_to_protected_dual
argument_list|(
name|buf
argument_list|)
expr_stmt|;
name|hostapd_drv_send_action
argument_list|(
name|hapd
argument_list|,
name|hapd
operator|->
name|iface
operator|->
name|freq
argument_list|,
literal|0
argument_list|,
name|sa
argument_list|,
name|wpabuf_head
argument_list|(
name|buf
argument_list|)
argument_list|,
name|wpabuf_len
argument_list|(
name|buf
argument_list|)
argument_list|)
expr_stmt|;
name|wpabuf_free
argument_list|(
name|buf
argument_list|)
expr_stmt|;
return|return;
block|}
name|pos
operator|=
name|next
expr_stmt|;
comment|/* Query Request */
if|if
condition|(
name|pos
operator|+
literal|2
operator|>
name|end
condition|)
return|return;
name|slen
operator|=
name|WPA_GET_LE16
argument_list|(
name|pos
argument_list|)
expr_stmt|;
name|pos
operator|+=
literal|2
expr_stmt|;
if|if
condition|(
name|pos
operator|+
name|slen
operator|>
name|end
condition|)
return|return;
name|end
operator|=
name|pos
operator|+
name|slen
expr_stmt|;
comment|/* ANQP Query Request */
while|while
condition|(
name|pos
operator|<
name|end
condition|)
block|{
name|u16
name|info_id
decl_stmt|,
name|elen
decl_stmt|;
if|if
condition|(
name|pos
operator|+
literal|4
operator|>
name|end
condition|)
return|return;
name|info_id
operator|=
name|WPA_GET_LE16
argument_list|(
name|pos
argument_list|)
expr_stmt|;
name|pos
operator|+=
literal|2
expr_stmt|;
name|elen
operator|=
name|WPA_GET_LE16
argument_list|(
name|pos
argument_list|)
expr_stmt|;
name|pos
operator|+=
literal|2
expr_stmt|;
if|if
condition|(
name|pos
operator|+
name|elen
operator|>
name|end
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"ANQP: Invalid Query Request"
argument_list|)
expr_stmt|;
return|return;
block|}
switch|switch
condition|(
name|info_id
condition|)
block|{
case|case
name|ANQP_QUERY_LIST
case|:
name|rx_anqp_query_list
argument_list|(
name|hapd
argument_list|,
name|pos
argument_list|,
name|pos
operator|+
name|elen
argument_list|,
operator|&
name|qi
argument_list|)
expr_stmt|;
break|break;
ifdef|#
directive|ifdef
name|CONFIG_HS20
case|case
name|ANQP_VENDOR_SPECIFIC
case|:
name|rx_anqp_vendor_specific
argument_list|(
name|hapd
argument_list|,
name|pos
argument_list|,
name|pos
operator|+
name|elen
argument_list|,
operator|&
name|qi
argument_list|)
expr_stmt|;
break|break;
endif|#
directive|endif
comment|/* CONFIG_HS20 */
default|default:
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"ANQP: Unsupported Query "
literal|"Request element %u"
argument_list|,
name|info_id
argument_list|)
expr_stmt|;
break|break;
block|}
name|pos
operator|+=
name|elen
expr_stmt|;
block|}
name|gas_serv_req_local_processing
argument_list|(
name|hapd
argument_list|,
name|sa
argument_list|,
name|dialog_token
argument_list|,
operator|&
name|qi
argument_list|,
name|prot
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|gas_serv_rx_gas_comeback_req
parameter_list|(
name|struct
name|hostapd_data
modifier|*
name|hapd
parameter_list|,
specifier|const
name|u8
modifier|*
name|sa
parameter_list|,
specifier|const
name|u8
modifier|*
name|data
parameter_list|,
name|size_t
name|len
parameter_list|,
name|int
name|prot
parameter_list|)
block|{
name|struct
name|gas_dialog_info
modifier|*
name|dialog
decl_stmt|;
name|struct
name|wpabuf
modifier|*
name|buf
decl_stmt|,
modifier|*
name|tx_buf
decl_stmt|;
name|u8
name|dialog_token
decl_stmt|;
name|size_t
name|frag_len
decl_stmt|;
name|int
name|more
init|=
literal|0
decl_stmt|;
name|wpa_hexdump
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"GAS: RX GAS Comeback Request"
argument_list|,
name|data
argument_list|,
name|len
argument_list|)
expr_stmt|;
if|if
condition|(
name|len
operator|<
literal|1
condition|)
return|return;
name|dialog_token
operator|=
operator|*
name|data
expr_stmt|;
name|wpa_msg
argument_list|(
name|hapd
operator|->
name|msg_ctx
argument_list|,
name|MSG_DEBUG
argument_list|,
literal|"GAS: Dialog Token: %u"
argument_list|,
name|dialog_token
argument_list|)
expr_stmt|;
name|dialog
operator|=
name|gas_serv_dialog_find
argument_list|(
name|hapd
argument_list|,
name|sa
argument_list|,
name|dialog_token
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|dialog
condition|)
block|{
name|wpa_msg
argument_list|(
name|hapd
operator|->
name|msg_ctx
argument_list|,
name|MSG_DEBUG
argument_list|,
literal|"GAS: No pending SD "
literal|"response fragment for "
name|MACSTR
literal|" dialog token %u"
argument_list|,
name|MAC2STR
argument_list|(
name|sa
argument_list|)
argument_list|,
name|dialog_token
argument_list|)
expr_stmt|;
if|if
condition|(
name|sa
index|[
literal|0
index|]
operator|&
literal|0x01
condition|)
return|return;
comment|/* Invalid source address - drop silently */
name|tx_buf
operator|=
name|gas_anqp_build_comeback_resp_buf
argument_list|(
name|dialog_token
argument_list|,
name|WLAN_STATUS_NO_OUTSTANDING_GAS_REQ
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|tx_buf
operator|==
name|NULL
condition|)
return|return;
goto|goto
name|send_resp
goto|;
block|}
name|frag_len
operator|=
name|wpabuf_len
argument_list|(
name|dialog
operator|->
name|sd_resp
argument_list|)
operator|-
name|dialog
operator|->
name|sd_resp_pos
expr_stmt|;
if|if
condition|(
name|frag_len
operator|>
name|hapd
operator|->
name|gas_frag_limit
condition|)
block|{
name|frag_len
operator|=
name|hapd
operator|->
name|gas_frag_limit
expr_stmt|;
name|more
operator|=
literal|1
expr_stmt|;
block|}
name|wpa_msg
argument_list|(
name|hapd
operator|->
name|msg_ctx
argument_list|,
name|MSG_DEBUG
argument_list|,
literal|"GAS: resp frag_len %u"
argument_list|,
operator|(
name|unsigned
name|int
operator|)
name|frag_len
argument_list|)
expr_stmt|;
name|buf
operator|=
name|wpabuf_alloc_copy
argument_list|(
name|wpabuf_head_u8
argument_list|(
name|dialog
operator|->
name|sd_resp
argument_list|)
operator|+
name|dialog
operator|->
name|sd_resp_pos
argument_list|,
name|frag_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|buf
operator|==
name|NULL
condition|)
block|{
name|wpa_msg
argument_list|(
name|hapd
operator|->
name|msg_ctx
argument_list|,
name|MSG_DEBUG
argument_list|,
literal|"GAS: Failed to allocate "
literal|"buffer"
argument_list|)
expr_stmt|;
name|gas_serv_dialog_clear
argument_list|(
name|dialog
argument_list|)
expr_stmt|;
return|return;
block|}
name|tx_buf
operator|=
name|gas_anqp_build_comeback_resp_buf
argument_list|(
name|dialog_token
argument_list|,
name|WLAN_STATUS_SUCCESS
argument_list|,
name|dialog
operator|->
name|sd_frag_id
argument_list|,
name|more
argument_list|,
literal|0
argument_list|,
name|buf
argument_list|)
expr_stmt|;
name|wpabuf_free
argument_list|(
name|buf
argument_list|)
expr_stmt|;
if|if
condition|(
name|tx_buf
operator|==
name|NULL
condition|)
block|{
name|gas_serv_dialog_clear
argument_list|(
name|dialog
argument_list|)
expr_stmt|;
return|return;
block|}
name|wpa_msg
argument_list|(
name|hapd
operator|->
name|msg_ctx
argument_list|,
name|MSG_DEBUG
argument_list|,
literal|"GAS: Tx GAS Comeback Response "
literal|"(frag_id %d more=%d frag_len=%d)"
argument_list|,
name|dialog
operator|->
name|sd_frag_id
argument_list|,
name|more
argument_list|,
operator|(
name|int
operator|)
name|frag_len
argument_list|)
expr_stmt|;
name|dialog
operator|->
name|sd_frag_id
operator|++
expr_stmt|;
name|dialog
operator|->
name|sd_resp_pos
operator|+=
name|frag_len
expr_stmt|;
if|if
condition|(
name|more
condition|)
block|{
name|wpa_msg
argument_list|(
name|hapd
operator|->
name|msg_ctx
argument_list|,
name|MSG_DEBUG
argument_list|,
literal|"GAS: %d more bytes remain "
literal|"to be sent"
argument_list|,
call|(
name|int
call|)
argument_list|(
name|wpabuf_len
argument_list|(
name|dialog
operator|->
name|sd_resp
argument_list|)
operator|-
name|dialog
operator|->
name|sd_resp_pos
argument_list|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|wpa_msg
argument_list|(
name|hapd
operator|->
name|msg_ctx
argument_list|,
name|MSG_DEBUG
argument_list|,
literal|"GAS: All fragments of "
literal|"SD response sent"
argument_list|)
expr_stmt|;
name|gas_serv_dialog_clear
argument_list|(
name|dialog
argument_list|)
expr_stmt|;
name|gas_serv_free_dialogs
argument_list|(
name|hapd
argument_list|,
name|sa
argument_list|)
expr_stmt|;
block|}
name|send_resp
label|:
if|if
condition|(
name|prot
condition|)
name|convert_to_protected_dual
argument_list|(
name|tx_buf
argument_list|)
expr_stmt|;
name|hostapd_drv_send_action
argument_list|(
name|hapd
argument_list|,
name|hapd
operator|->
name|iface
operator|->
name|freq
argument_list|,
literal|0
argument_list|,
name|sa
argument_list|,
name|wpabuf_head
argument_list|(
name|tx_buf
argument_list|)
argument_list|,
name|wpabuf_len
argument_list|(
name|tx_buf
argument_list|)
argument_list|)
expr_stmt|;
name|wpabuf_free
argument_list|(
name|tx_buf
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|gas_serv_rx_public_action
parameter_list|(
name|void
modifier|*
name|ctx
parameter_list|,
specifier|const
name|u8
modifier|*
name|buf
parameter_list|,
name|size_t
name|len
parameter_list|,
name|int
name|freq
parameter_list|)
block|{
name|struct
name|hostapd_data
modifier|*
name|hapd
init|=
name|ctx
decl_stmt|;
specifier|const
name|struct
name|ieee80211_mgmt
modifier|*
name|mgmt
decl_stmt|;
specifier|const
name|u8
modifier|*
name|sa
decl_stmt|,
modifier|*
name|data
decl_stmt|;
name|int
name|prot
decl_stmt|;
name|mgmt
operator|=
operator|(
specifier|const
expr|struct
name|ieee80211_mgmt
operator|*
operator|)
name|buf
expr_stmt|;
if|if
condition|(
name|len
operator|<
name|IEEE80211_HDRLEN
operator|+
literal|2
condition|)
return|return;
if|if
condition|(
name|mgmt
operator|->
name|u
operator|.
name|action
operator|.
name|category
operator|!=
name|WLAN_ACTION_PUBLIC
operator|&&
name|mgmt
operator|->
name|u
operator|.
name|action
operator|.
name|category
operator|!=
name|WLAN_ACTION_PROTECTED_DUAL
condition|)
return|return;
comment|/* 	 * Note: Public Action and Protected Dual of Public Action frames share 	 * the same payload structure, so it is fine to use definitions of 	 * Public Action frames to process both. 	 */
name|prot
operator|=
name|mgmt
operator|->
name|u
operator|.
name|action
operator|.
name|category
operator|==
name|WLAN_ACTION_PROTECTED_DUAL
expr_stmt|;
name|sa
operator|=
name|mgmt
operator|->
name|sa
expr_stmt|;
name|len
operator|-=
name|IEEE80211_HDRLEN
operator|+
literal|1
expr_stmt|;
name|data
operator|=
name|buf
operator|+
name|IEEE80211_HDRLEN
operator|+
literal|1
expr_stmt|;
switch|switch
condition|(
name|data
index|[
literal|0
index|]
condition|)
block|{
case|case
name|WLAN_PA_GAS_INITIAL_REQ
case|:
name|gas_serv_rx_gas_initial_req
argument_list|(
name|hapd
argument_list|,
name|sa
argument_list|,
name|data
operator|+
literal|1
argument_list|,
name|len
operator|-
literal|1
argument_list|,
name|prot
argument_list|)
expr_stmt|;
break|break;
case|case
name|WLAN_PA_GAS_COMEBACK_REQ
case|:
name|gas_serv_rx_gas_comeback_req
argument_list|(
name|hapd
argument_list|,
name|sa
argument_list|,
name|data
operator|+
literal|1
argument_list|,
name|len
operator|-
literal|1
argument_list|,
name|prot
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
end_function

begin_function
name|int
name|gas_serv_init
parameter_list|(
name|struct
name|hostapd_data
modifier|*
name|hapd
parameter_list|)
block|{
name|hapd
operator|->
name|public_action_cb2
operator|=
name|gas_serv_rx_public_action
expr_stmt|;
name|hapd
operator|->
name|public_action_cb2_ctx
operator|=
name|hapd
expr_stmt|;
name|hapd
operator|->
name|gas_frag_limit
operator|=
literal|1400
expr_stmt|;
if|if
condition|(
name|hapd
operator|->
name|conf
operator|->
name|gas_frag_limit
operator|>
literal|0
condition|)
name|hapd
operator|->
name|gas_frag_limit
operator|=
name|hapd
operator|->
name|conf
operator|->
name|gas_frag_limit
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|void
name|gas_serv_deinit
parameter_list|(
name|struct
name|hostapd_data
modifier|*
name|hapd
parameter_list|)
block|{ }
end_function

end_unit


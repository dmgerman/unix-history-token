begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * WPA Supplicant - driver interaction with old Broadcom wl.o driver  * Copyright (c) 2004, Nikki Chumkov<nikki@gattaca.ru>  * Copyright (c) 2004, Jouni Malinen<j@w1.fi>  *  * This program is free software; you can redistribute it and/or modify  * it under the terms of the GNU General Public License version 2 as  * published by the Free Software Foundation.  *  * Alternatively, this software may be distributed under the terms of BSD  * license.  *  * See README and COPYING for more details.  *  * Please note that the newer Broadcom driver ("hybrid Linux driver") supports  * Linux wireless extensions and does not need (or even work) with this old  * driver wrapper. Use driver_wext.c with that driver.  */
end_comment

begin_include
include|#
directive|include
file|"includes.h"
end_include

begin_include
include|#
directive|include
file|<sys/ioctl.h>
end_include

begin_include
include|#
directive|include
file|"common.h"
end_include

begin_if
if|#
directive|if
literal|0
end_if

begin_include
include|#
directive|include
file|<netpacket/packet.h>
end_include

begin_include
include|#
directive|include
file|<net/ethernet.h>
end_include

begin_comment
comment|/* the L2 protocols */
end_comment

begin_else
else|#
directive|else
end_else

begin_include
include|#
directive|include
file|<linux/if_packet.h>
end_include

begin_include
include|#
directive|include
file|<linux/if_ether.h>
end_include

begin_comment
comment|/* The L2 protocols */
end_comment

begin_endif
endif|#
directive|endif
end_endif

begin_include
include|#
directive|include
file|<net/if.h>
end_include

begin_include
include|#
directive|include
file|<typedefs.h>
end_include

begin_comment
comment|/* wlioctl.h is a Broadcom header file and it is available, e.g., from Linksys  * WRT54G GPL tarball. */
end_comment

begin_include
include|#
directive|include
file|<wlioctl.h>
end_include

begin_include
include|#
directive|include
file|"driver.h"
end_include

begin_include
include|#
directive|include
file|"eloop.h"
end_include

begin_struct
struct|struct
name|wpa_driver_broadcom_data
block|{
name|void
modifier|*
name|ctx
decl_stmt|;
name|int
name|ioctl_sock
decl_stmt|;
name|int
name|event_sock
decl_stmt|;
name|char
name|ifname
index|[
name|IFNAMSIZ
operator|+
literal|1
index|]
decl_stmt|;
block|}
struct|;
end_struct

begin_ifndef
ifndef|#
directive|ifndef
name|WLC_DEAUTHENTICATE
end_ifndef

begin_define
define|#
directive|define
name|WLC_DEAUTHENTICATE
value|143
end_define

begin_endif
endif|#
directive|endif
end_endif

begin_ifndef
ifndef|#
directive|ifndef
name|WLC_DEAUTHENTICATE_WITH_REASON
end_ifndef

begin_define
define|#
directive|define
name|WLC_DEAUTHENTICATE_WITH_REASON
value|201
end_define

begin_endif
endif|#
directive|endif
end_endif

begin_ifndef
ifndef|#
directive|ifndef
name|WLC_SET_TKIP_COUNTERMEASURES
end_ifndef

begin_define
define|#
directive|define
name|WLC_SET_TKIP_COUNTERMEASURES
value|202
end_define

begin_endif
endif|#
directive|endif
end_endif

begin_if
if|#
directive|if
operator|!
name|defined
argument_list|(
name|PSK_ENABLED
argument_list|)
end_if

begin_comment
comment|/* NEW driver interface */
end_comment

begin_define
define|#
directive|define
name|WL_VERSION
value|360130
end_define

begin_comment
comment|/* wireless authentication bit vector */
end_comment

begin_define
define|#
directive|define
name|WPA_ENABLED
value|1
end_define

begin_define
define|#
directive|define
name|PSK_ENABLED
value|2
end_define

begin_define
define|#
directive|define
name|WAUTH_WPA_ENABLED
parameter_list|(
name|wauth
parameter_list|)
value|((wauth)& WPA_ENABLED)
end_define

begin_define
define|#
directive|define
name|WAUTH_PSK_ENABLED
parameter_list|(
name|wauth
parameter_list|)
value|((wauth)& PSK_ENABLED)
end_define

begin_define
define|#
directive|define
name|WAUTH_ENABLED
parameter_list|(
name|wauth
parameter_list|)
value|((wauth)& (WPA_ENABLED | PSK_ENABLED))
end_define

begin_define
define|#
directive|define
name|WSEC_PRIMARY_KEY
value|WL_PRIMARY_KEY
end_define

begin_typedef
typedef|typedef
name|wl_wsec_key_t
name|wsec_key_t
typedef|;
end_typedef

begin_endif
endif|#
directive|endif
end_endif

begin_typedef
typedef|typedef
struct|struct
block|{
name|uint32
name|val
decl_stmt|;
name|struct
name|ether_addr
name|ea
decl_stmt|;
name|uint16
name|res
decl_stmt|;
block|}
name|wlc_deauth_t
typedef|;
end_typedef

begin_function_decl
specifier|static
name|void
name|wpa_driver_broadcom_scan_timeout
parameter_list|(
name|void
modifier|*
name|eloop_ctx
parameter_list|,
name|void
modifier|*
name|timeout_ctx
parameter_list|)
function_decl|;
end_function_decl

begin_function
specifier|static
name|int
name|broadcom_ioctl
parameter_list|(
name|struct
name|wpa_driver_broadcom_data
modifier|*
name|drv
parameter_list|,
name|int
name|cmd
parameter_list|,
name|void
modifier|*
name|buf
parameter_list|,
name|int
name|len
parameter_list|)
block|{
name|struct
name|ifreq
name|ifr
decl_stmt|;
name|wl_ioctl_t
name|ioc
decl_stmt|;
name|int
name|ret
init|=
literal|0
decl_stmt|;
name|wpa_printf
argument_list|(
name|MSG_MSGDUMP
argument_list|,
literal|"BROADCOM: wlioctl(%s,%d,len=%d,val=%p)"
argument_list|,
name|drv
operator|->
name|ifname
argument_list|,
name|cmd
argument_list|,
name|len
argument_list|,
name|buf
argument_list|)
expr_stmt|;
comment|/* wpa_hexdump(MSG_MSGDUMP, "BROADCOM: wlioctl buf", buf, len); */
name|ioc
operator|.
name|cmd
operator|=
name|cmd
expr_stmt|;
name|ioc
operator|.
name|buf
operator|=
name|buf
expr_stmt|;
name|ioc
operator|.
name|len
operator|=
name|len
expr_stmt|;
name|os_strlcpy
argument_list|(
name|ifr
operator|.
name|ifr_name
argument_list|,
name|drv
operator|->
name|ifname
argument_list|,
name|IFNAMSIZ
argument_list|)
expr_stmt|;
name|ifr
operator|.
name|ifr_data
operator|=
operator|(
name|caddr_t
operator|)
operator|&
name|ioc
expr_stmt|;
if|if
condition|(
operator|(
name|ret
operator|=
name|ioctl
argument_list|(
name|drv
operator|->
name|ioctl_sock
argument_list|,
name|SIOCDEVPRIVATE
argument_list|,
operator|&
name|ifr
argument_list|)
operator|)
operator|<
literal|0
condition|)
block|{
if|if
condition|(
name|cmd
operator|!=
name|WLC_GET_MAGIC
condition|)
name|perror
argument_list|(
name|ifr
operator|.
name|ifr_name
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_MSGDUMP
argument_list|,
literal|"BROADCOM: wlioctl cmd=%d res=%d"
argument_list|,
name|cmd
argument_list|,
name|ret
argument_list|)
expr_stmt|;
block|}
return|return
name|ret
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|wpa_driver_broadcom_get_bssid
parameter_list|(
name|void
modifier|*
name|priv
parameter_list|,
name|u8
modifier|*
name|bssid
parameter_list|)
block|{
name|struct
name|wpa_driver_broadcom_data
modifier|*
name|drv
init|=
name|priv
decl_stmt|;
if|if
condition|(
name|broadcom_ioctl
argument_list|(
name|drv
argument_list|,
name|WLC_GET_BSSID
argument_list|,
name|bssid
argument_list|,
name|ETH_ALEN
argument_list|)
operator|==
literal|0
condition|)
return|return
literal|0
return|;
name|os_memset
argument_list|(
name|bssid
argument_list|,
literal|0
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|wpa_driver_broadcom_get_ssid
parameter_list|(
name|void
modifier|*
name|priv
parameter_list|,
name|u8
modifier|*
name|ssid
parameter_list|)
block|{
name|struct
name|wpa_driver_broadcom_data
modifier|*
name|drv
init|=
name|priv
decl_stmt|;
name|wlc_ssid_t
name|s
decl_stmt|;
if|if
condition|(
name|broadcom_ioctl
argument_list|(
name|drv
argument_list|,
name|WLC_GET_SSID
argument_list|,
operator|&
name|s
argument_list|,
sizeof|sizeof
argument_list|(
name|s
argument_list|)
argument_list|)
operator|==
operator|-
literal|1
condition|)
return|return
operator|-
literal|1
return|;
name|os_memcpy
argument_list|(
name|ssid
argument_list|,
name|s
operator|.
name|SSID
argument_list|,
name|s
operator|.
name|SSID_len
argument_list|)
expr_stmt|;
return|return
name|s
operator|.
name|SSID_len
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|wpa_driver_broadcom_set_wpa
parameter_list|(
name|void
modifier|*
name|priv
parameter_list|,
name|int
name|enable
parameter_list|)
block|{
name|struct
name|wpa_driver_broadcom_data
modifier|*
name|drv
init|=
name|priv
decl_stmt|;
name|unsigned
name|int
name|wauth
decl_stmt|,
name|wsec
decl_stmt|;
name|struct
name|ether_addr
name|ea
decl_stmt|;
name|os_memset
argument_list|(
operator|&
name|ea
argument_list|,
name|enable
condition|?
literal|0xff
else|:
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|ea
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|broadcom_ioctl
argument_list|(
name|drv
argument_list|,
name|WLC_GET_WPA_AUTH
argument_list|,
operator|&
name|wauth
argument_list|,
sizeof|sizeof
argument_list|(
name|wauth
argument_list|)
argument_list|)
operator|==
operator|-
literal|1
operator|||
name|broadcom_ioctl
argument_list|(
name|drv
argument_list|,
name|WLC_GET_WSEC
argument_list|,
operator|&
name|wsec
argument_list|,
sizeof|sizeof
argument_list|(
name|wsec
argument_list|)
argument_list|)
operator|==
operator|-
literal|1
condition|)
return|return
operator|-
literal|1
return|;
if|if
condition|(
name|enable
condition|)
block|{
name|wauth
operator|=
name|PSK_ENABLED
expr_stmt|;
name|wsec
operator|=
name|TKIP_ENABLED
expr_stmt|;
block|}
else|else
block|{
name|wauth
operator|=
literal|255
expr_stmt|;
name|wsec
operator|&=
operator|~
operator|(
name|TKIP_ENABLED
operator||
name|AES_ENABLED
operator|)
expr_stmt|;
block|}
if|if
condition|(
name|broadcom_ioctl
argument_list|(
name|drv
argument_list|,
name|WLC_SET_WPA_AUTH
argument_list|,
operator|&
name|wauth
argument_list|,
sizeof|sizeof
argument_list|(
name|wauth
argument_list|)
argument_list|)
operator|==
operator|-
literal|1
operator|||
name|broadcom_ioctl
argument_list|(
name|drv
argument_list|,
name|WLC_SET_WSEC
argument_list|,
operator|&
name|wsec
argument_list|,
sizeof|sizeof
argument_list|(
name|wsec
argument_list|)
argument_list|)
operator|==
operator|-
literal|1
condition|)
return|return
operator|-
literal|1
return|;
comment|/* FIX: magic number / error handling? */
name|broadcom_ioctl
argument_list|(
name|drv
argument_list|,
literal|122
argument_list|,
operator|&
name|ea
argument_list|,
sizeof|sizeof
argument_list|(
name|ea
argument_list|)
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|wpa_driver_broadcom_set_key
parameter_list|(
specifier|const
name|char
modifier|*
name|ifname
parameter_list|,
name|void
modifier|*
name|priv
parameter_list|,
name|enum
name|wpa_alg
name|alg
parameter_list|,
specifier|const
name|u8
modifier|*
name|addr
parameter_list|,
name|int
name|key_idx
parameter_list|,
name|int
name|set_tx
parameter_list|,
specifier|const
name|u8
modifier|*
name|seq
parameter_list|,
name|size_t
name|seq_len
parameter_list|,
specifier|const
name|u8
modifier|*
name|key
parameter_list|,
name|size_t
name|key_len
parameter_list|)
block|{
name|struct
name|wpa_driver_broadcom_data
modifier|*
name|drv
init|=
name|priv
decl_stmt|;
name|int
name|ret
decl_stmt|;
name|wsec_key_t
name|wkt
decl_stmt|;
name|os_memset
argument_list|(
operator|&
name|wkt
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
name|wkt
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_MSGDUMP
argument_list|,
literal|"BROADCOM: SET %sKEY[%d] alg=%d"
argument_list|,
name|set_tx
condition|?
literal|"PRIMARY "
else|:
literal|""
argument_list|,
name|key_idx
argument_list|,
name|alg
argument_list|)
expr_stmt|;
if|if
condition|(
name|key
operator|&&
name|key_len
operator|>
literal|0
condition|)
name|wpa_hexdump_key
argument_list|(
name|MSG_MSGDUMP
argument_list|,
literal|"BROADCOM: key"
argument_list|,
name|key
argument_list|,
name|key_len
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|alg
condition|)
block|{
case|case
name|WPA_ALG_NONE
case|:
name|wkt
operator|.
name|algo
operator|=
name|CRYPTO_ALGO_OFF
expr_stmt|;
break|break;
case|case
name|WPA_ALG_WEP
case|:
name|wkt
operator|.
name|algo
operator|=
name|CRYPTO_ALGO_WEP128
expr_stmt|;
comment|/* CRYPTO_ALGO_WEP1? */
break|break;
case|case
name|WPA_ALG_TKIP
case|:
name|wkt
operator|.
name|algo
operator|=
literal|0
expr_stmt|;
comment|/* CRYPTO_ALGO_TKIP? */
break|break;
case|case
name|WPA_ALG_CCMP
case|:
name|wkt
operator|.
name|algo
operator|=
literal|0
expr_stmt|;
comment|/* CRYPTO_ALGO_AES_CCM; 			       * AES_OCB_MSDU, AES_OCB_MPDU? */
break|break;
default|default:
name|wkt
operator|.
name|algo
operator|=
name|CRYPTO_ALGO_NALG
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|seq
operator|&&
name|seq_len
operator|>
literal|0
condition|)
name|wpa_hexdump
argument_list|(
name|MSG_MSGDUMP
argument_list|,
literal|"BROADCOM: SEQ"
argument_list|,
name|seq
argument_list|,
name|seq_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|addr
condition|)
name|wpa_hexdump
argument_list|(
name|MSG_MSGDUMP
argument_list|,
literal|"BROADCOM: addr"
argument_list|,
name|addr
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
name|wkt
operator|.
name|index
operator|=
name|key_idx
expr_stmt|;
name|wkt
operator|.
name|len
operator|=
name|key_len
expr_stmt|;
if|if
condition|(
name|key
operator|&&
name|key_len
operator|>
literal|0
condition|)
block|{
name|os_memcpy
argument_list|(
name|wkt
operator|.
name|data
argument_list|,
name|key
argument_list|,
name|key_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|key_len
operator|==
literal|32
condition|)
block|{
comment|/* hack hack hack XXX */
name|os_memcpy
argument_list|(
operator|&
name|wkt
operator|.
name|data
index|[
literal|16
index|]
argument_list|,
operator|&
name|key
index|[
literal|24
index|]
argument_list|,
literal|8
argument_list|)
expr_stmt|;
name|os_memcpy
argument_list|(
operator|&
name|wkt
operator|.
name|data
index|[
literal|24
index|]
argument_list|,
operator|&
name|key
index|[
literal|16
index|]
argument_list|,
literal|8
argument_list|)
expr_stmt|;
block|}
block|}
comment|/* wkt.algo = CRYPTO_ALGO_...; */
name|wkt
operator|.
name|flags
operator|=
name|set_tx
condition|?
literal|0
else|:
name|WSEC_PRIMARY_KEY
expr_stmt|;
if|if
condition|(
name|addr
operator|&&
name|set_tx
condition|)
name|os_memcpy
argument_list|(
operator|&
name|wkt
operator|.
name|ea
argument_list|,
name|addr
argument_list|,
sizeof|sizeof
argument_list|(
name|wkt
operator|.
name|ea
argument_list|)
argument_list|)
expr_stmt|;
name|ret
operator|=
name|broadcom_ioctl
argument_list|(
name|drv
argument_list|,
name|WLC_SET_KEY
argument_list|,
operator|&
name|wkt
argument_list|,
sizeof|sizeof
argument_list|(
name|wkt
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|addr
operator|&&
name|set_tx
condition|)
block|{
comment|/* FIX: magic number / error handling? */
name|broadcom_ioctl
argument_list|(
name|drv
argument_list|,
literal|121
argument_list|,
operator|&
name|wkt
operator|.
name|ea
argument_list|,
sizeof|sizeof
argument_list|(
name|wkt
operator|.
name|ea
argument_list|)
argument_list|)
expr_stmt|;
block|}
return|return
name|ret
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|wpa_driver_broadcom_event_receive
parameter_list|(
name|int
name|sock
parameter_list|,
name|void
modifier|*
name|ctx
parameter_list|,
name|void
modifier|*
name|sock_ctx
parameter_list|)
block|{
name|char
name|buf
index|[
literal|8192
index|]
decl_stmt|;
name|int
name|left
decl_stmt|;
name|wl_wpa_header_t
modifier|*
name|wwh
decl_stmt|;
name|union
name|wpa_event_data
name|data
decl_stmt|;
name|u8
modifier|*
name|resp_ies
init|=
name|NULL
decl_stmt|;
if|if
condition|(
operator|(
name|left
operator|=
name|recv
argument_list|(
name|sock
argument_list|,
name|buf
argument_list|,
sizeof|sizeof
name|buf
argument_list|,
literal|0
argument_list|)
operator|)
operator|<
literal|0
condition|)
return|return;
name|wpa_hexdump
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"RECEIVE EVENT"
argument_list|,
operator|(
name|u8
operator|*
operator|)
name|buf
argument_list|,
name|left
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|size_t
operator|)
name|left
operator|<
sizeof|sizeof
argument_list|(
name|wl_wpa_header_t
argument_list|)
condition|)
return|return;
name|wwh
operator|=
operator|(
name|wl_wpa_header_t
operator|*
operator|)
name|buf
expr_stmt|;
if|if
condition|(
name|wwh
operator|->
name|snap
operator|.
name|type
operator|!=
name|WL_WPA_ETHER_TYPE
condition|)
return|return;
if|if
condition|(
name|os_memcmp
argument_list|(
operator|&
name|wwh
operator|->
name|snap
argument_list|,
name|wl_wpa_snap_template
argument_list|,
literal|6
argument_list|)
operator|!=
literal|0
condition|)
return|return;
name|os_memset
argument_list|(
operator|&
name|data
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|data
argument_list|)
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|wwh
operator|->
name|type
condition|)
block|{
case|case
name|WLC_ASSOC_MSG
case|:
name|left
operator|-=
name|WL_WPA_HEADER_LEN
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"BROADCOM: ASSOC MESSAGE (left: %d)"
argument_list|,
name|left
argument_list|)
expr_stmt|;
if|if
condition|(
name|left
operator|>
literal|0
condition|)
block|{
name|resp_ies
operator|=
name|os_malloc
argument_list|(
name|left
argument_list|)
expr_stmt|;
if|if
condition|(
name|resp_ies
operator|==
name|NULL
condition|)
return|return;
name|os_memcpy
argument_list|(
name|resp_ies
argument_list|,
name|buf
operator|+
name|WL_WPA_HEADER_LEN
argument_list|,
name|left
argument_list|)
expr_stmt|;
name|data
operator|.
name|assoc_info
operator|.
name|resp_ies
operator|=
name|resp_ies
expr_stmt|;
name|data
operator|.
name|assoc_info
operator|.
name|resp_ies_len
operator|=
name|left
expr_stmt|;
block|}
name|wpa_supplicant_event
argument_list|(
name|ctx
argument_list|,
name|EVENT_ASSOC
argument_list|,
operator|&
name|data
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|resp_ies
argument_list|)
expr_stmt|;
break|break;
case|case
name|WLC_DISASSOC_MSG
case|:
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"BROADCOM: DISASSOC MESSAGE"
argument_list|)
expr_stmt|;
name|wpa_supplicant_event
argument_list|(
name|ctx
argument_list|,
name|EVENT_DISASSOC
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
break|break;
case|case
name|WLC_PTK_MIC_MSG
case|:
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"BROADCOM: PTK MIC MSG MESSAGE"
argument_list|)
expr_stmt|;
name|data
operator|.
name|michael_mic_failure
operator|.
name|unicast
operator|=
literal|1
expr_stmt|;
name|wpa_supplicant_event
argument_list|(
name|ctx
argument_list|,
name|EVENT_MICHAEL_MIC_FAILURE
argument_list|,
operator|&
name|data
argument_list|)
expr_stmt|;
break|break;
case|case
name|WLC_GTK_MIC_MSG
case|:
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"BROADCOM: GTK MIC MSG MESSAGE"
argument_list|)
expr_stmt|;
name|data
operator|.
name|michael_mic_failure
operator|.
name|unicast
operator|=
literal|0
expr_stmt|;
name|wpa_supplicant_event
argument_list|(
name|ctx
argument_list|,
name|EVENT_MICHAEL_MIC_FAILURE
argument_list|,
operator|&
name|data
argument_list|)
expr_stmt|;
break|break;
default|default:
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"BROADCOM: UNKNOWN MESSAGE (%d)"
argument_list|,
name|wwh
operator|->
name|type
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
end_function

begin_function
specifier|static
name|void
modifier|*
name|wpa_driver_broadcom_init
parameter_list|(
name|void
modifier|*
name|ctx
parameter_list|,
specifier|const
name|char
modifier|*
name|ifname
parameter_list|)
block|{
name|int
name|s
decl_stmt|;
name|struct
name|sockaddr_ll
name|ll
decl_stmt|;
name|struct
name|wpa_driver_broadcom_data
modifier|*
name|drv
decl_stmt|;
name|struct
name|ifreq
name|ifr
decl_stmt|;
comment|/* open socket to kernel */
if|if
condition|(
operator|(
name|s
operator|=
name|socket
argument_list|(
name|AF_INET
argument_list|,
name|SOCK_DGRAM
argument_list|,
literal|0
argument_list|)
operator|)
operator|<
literal|0
condition|)
block|{
name|perror
argument_list|(
literal|"socket"
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
comment|/* do it */
name|os_strlcpy
argument_list|(
name|ifr
operator|.
name|ifr_name
argument_list|,
name|ifname
argument_list|,
name|IFNAMSIZ
argument_list|)
expr_stmt|;
if|if
condition|(
name|ioctl
argument_list|(
name|s
argument_list|,
name|SIOCGIFINDEX
argument_list|,
operator|&
name|ifr
argument_list|)
operator|<
literal|0
condition|)
block|{
name|perror
argument_list|(
name|ifr
operator|.
name|ifr_name
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|drv
operator|=
name|os_zalloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|drv
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|drv
operator|==
name|NULL
condition|)
return|return
name|NULL
return|;
name|drv
operator|->
name|ctx
operator|=
name|ctx
expr_stmt|;
name|os_strlcpy
argument_list|(
name|drv
operator|->
name|ifname
argument_list|,
name|ifname
argument_list|,
sizeof|sizeof
argument_list|(
name|drv
operator|->
name|ifname
argument_list|)
argument_list|)
expr_stmt|;
name|drv
operator|->
name|ioctl_sock
operator|=
name|s
expr_stmt|;
name|s
operator|=
name|socket
argument_list|(
name|PF_PACKET
argument_list|,
name|SOCK_RAW
argument_list|,
name|ntohs
argument_list|(
name|ETH_P_802_2
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|s
operator|<
literal|0
condition|)
block|{
name|perror
argument_list|(
literal|"socket(PF_PACKET, SOCK_RAW, ntohs(ETH_P_802_2))"
argument_list|)
expr_stmt|;
name|close
argument_list|(
name|drv
operator|->
name|ioctl_sock
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|drv
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|os_memset
argument_list|(
operator|&
name|ll
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|ll
argument_list|)
argument_list|)
expr_stmt|;
name|ll
operator|.
name|sll_family
operator|=
name|AF_PACKET
expr_stmt|;
name|ll
operator|.
name|sll_protocol
operator|=
name|ntohs
argument_list|(
name|ETH_P_802_2
argument_list|)
expr_stmt|;
name|ll
operator|.
name|sll_ifindex
operator|=
name|ifr
operator|.
name|ifr_ifindex
expr_stmt|;
name|ll
operator|.
name|sll_hatype
operator|=
literal|0
expr_stmt|;
name|ll
operator|.
name|sll_pkttype
operator|=
name|PACKET_HOST
expr_stmt|;
name|ll
operator|.
name|sll_halen
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|bind
argument_list|(
name|s
argument_list|,
operator|(
expr|struct
name|sockaddr
operator|*
operator|)
operator|&
name|ll
argument_list|,
sizeof|sizeof
argument_list|(
name|ll
argument_list|)
argument_list|)
operator|<
literal|0
condition|)
block|{
name|perror
argument_list|(
literal|"bind(netlink)"
argument_list|)
expr_stmt|;
name|close
argument_list|(
name|s
argument_list|)
expr_stmt|;
name|close
argument_list|(
name|drv
operator|->
name|ioctl_sock
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|drv
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|eloop_register_read_sock
argument_list|(
name|s
argument_list|,
name|wpa_driver_broadcom_event_receive
argument_list|,
name|ctx
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|drv
operator|->
name|event_sock
operator|=
name|s
expr_stmt|;
name|wpa_driver_broadcom_set_wpa
argument_list|(
name|drv
argument_list|,
literal|1
argument_list|)
expr_stmt|;
return|return
name|drv
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|wpa_driver_broadcom_deinit
parameter_list|(
name|void
modifier|*
name|priv
parameter_list|)
block|{
name|struct
name|wpa_driver_broadcom_data
modifier|*
name|drv
init|=
name|priv
decl_stmt|;
name|wpa_driver_broadcom_set_wpa
argument_list|(
name|drv
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|eloop_cancel_timeout
argument_list|(
name|wpa_driver_broadcom_scan_timeout
argument_list|,
name|drv
argument_list|,
name|drv
operator|->
name|ctx
argument_list|)
expr_stmt|;
name|eloop_unregister_read_sock
argument_list|(
name|drv
operator|->
name|event_sock
argument_list|)
expr_stmt|;
name|close
argument_list|(
name|drv
operator|->
name|event_sock
argument_list|)
expr_stmt|;
name|close
argument_list|(
name|drv
operator|->
name|ioctl_sock
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|drv
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|wpa_driver_broadcom_set_countermeasures
parameter_list|(
name|void
modifier|*
name|priv
parameter_list|,
name|int
name|enabled
parameter_list|)
block|{
if|#
directive|if
literal|0
block|struct wpa_driver_broadcom_data *drv = priv;
comment|/* FIX: ? */
block|return broadcom_ioctl(drv, WLC_SET_TKIP_COUNTERMEASURES,&enabled, 			      sizeof(enabled));
else|#
directive|else
return|return
literal|0
return|;
endif|#
directive|endif
block|}
end_function

begin_function
specifier|static
name|int
name|wpa_driver_broadcom_set_drop_unencrypted
parameter_list|(
name|void
modifier|*
name|priv
parameter_list|,
name|int
name|enabled
parameter_list|)
block|{
name|struct
name|wpa_driver_broadcom_data
modifier|*
name|drv
init|=
name|priv
decl_stmt|;
comment|/* SET_EAP_RESTRICT, SET_WEP_RESTRICT */
name|int
name|_restrict
init|=
operator|(
name|enabled
condition|?
literal|1
else|:
literal|0
operator|)
decl_stmt|;
if|if
condition|(
name|broadcom_ioctl
argument_list|(
name|drv
argument_list|,
name|WLC_SET_WEP_RESTRICT
argument_list|,
operator|&
name|_restrict
argument_list|,
sizeof|sizeof
argument_list|(
name|_restrict
argument_list|)
argument_list|)
operator|<
literal|0
operator|||
name|broadcom_ioctl
argument_list|(
name|drv
argument_list|,
name|WLC_SET_EAP_RESTRICT
argument_list|,
operator|&
name|_restrict
argument_list|,
sizeof|sizeof
argument_list|(
name|_restrict
argument_list|)
argument_list|)
operator|<
literal|0
condition|)
return|return
operator|-
literal|1
return|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|wpa_driver_broadcom_scan_timeout
parameter_list|(
name|void
modifier|*
name|eloop_ctx
parameter_list|,
name|void
modifier|*
name|timeout_ctx
parameter_list|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"Scan timeout - try to get results"
argument_list|)
expr_stmt|;
name|wpa_supplicant_event
argument_list|(
name|timeout_ctx
argument_list|,
name|EVENT_SCAN_RESULTS
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|wpa_driver_broadcom_scan
parameter_list|(
name|void
modifier|*
name|priv
parameter_list|,
name|struct
name|wpa_driver_scan_params
modifier|*
name|params
parameter_list|)
block|{
name|struct
name|wpa_driver_broadcom_data
modifier|*
name|drv
init|=
name|priv
decl_stmt|;
name|wlc_ssid_t
name|wst
init|=
block|{
literal|0
block|,
literal|""
block|}
decl_stmt|;
specifier|const
name|u8
modifier|*
name|ssid
init|=
name|params
operator|->
name|ssids
index|[
literal|0
index|]
operator|.
name|ssid
decl_stmt|;
name|size_t
name|ssid_len
init|=
name|params
operator|->
name|ssids
index|[
literal|0
index|]
operator|.
name|ssid_len
decl_stmt|;
if|if
condition|(
name|ssid
operator|&&
name|ssid_len
operator|>
literal|0
operator|&&
name|ssid_len
operator|<=
sizeof|sizeof
argument_list|(
name|wst
operator|.
name|SSID
argument_list|)
condition|)
block|{
name|wst
operator|.
name|SSID_len
operator|=
name|ssid_len
expr_stmt|;
name|os_memcpy
argument_list|(
name|wst
operator|.
name|SSID
argument_list|,
name|ssid
argument_list|,
name|ssid_len
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|broadcom_ioctl
argument_list|(
name|drv
argument_list|,
name|WLC_SCAN
argument_list|,
operator|&
name|wst
argument_list|,
sizeof|sizeof
argument_list|(
name|wst
argument_list|)
argument_list|)
operator|<
literal|0
condition|)
return|return
operator|-
literal|1
return|;
name|eloop_cancel_timeout
argument_list|(
name|wpa_driver_broadcom_scan_timeout
argument_list|,
name|drv
argument_list|,
name|drv
operator|->
name|ctx
argument_list|)
expr_stmt|;
name|eloop_register_timeout
argument_list|(
literal|3
argument_list|,
literal|0
argument_list|,
name|wpa_driver_broadcom_scan_timeout
argument_list|,
name|drv
argument_list|,
name|drv
operator|->
name|ctx
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_decl_stmt
specifier|static
specifier|const
name|int
name|frequency_list
index|[]
init|=
block|{
literal|2412
block|,
literal|2417
block|,
literal|2422
block|,
literal|2427
block|,
literal|2432
block|,
literal|2437
block|,
literal|2442
block|,
literal|2447
block|,
literal|2452
block|,
literal|2457
block|,
literal|2462
block|,
literal|2467
block|,
literal|2472
block|,
literal|2484
block|}
decl_stmt|;
end_decl_stmt

begin_struct
struct|struct
name|bss_ie_hdr
block|{
name|u8
name|elem_id
decl_stmt|;
name|u8
name|len
decl_stmt|;
name|u8
name|oui
index|[
literal|3
index|]
decl_stmt|;
comment|/* u8 oui_type; */
comment|/* u16 version; */
block|}
name|__attribute__
argument_list|(
operator|(
name|packed
operator|)
argument_list|)
struct|;
end_struct

begin_function
specifier|static
name|struct
name|wpa_scan_results
modifier|*
name|wpa_driver_broadcom_get_scan_results
parameter_list|(
name|void
modifier|*
name|priv
parameter_list|)
block|{
name|struct
name|wpa_driver_broadcom_data
modifier|*
name|drv
init|=
name|priv
decl_stmt|;
name|char
modifier|*
name|buf
decl_stmt|;
name|wl_scan_results_t
modifier|*
name|wsr
decl_stmt|;
name|wl_bss_info_t
modifier|*
name|wbi
decl_stmt|;
name|size_t
name|ap_num
decl_stmt|;
name|struct
name|wpa_scan_results
modifier|*
name|res
decl_stmt|;
name|buf
operator|=
name|os_malloc
argument_list|(
name|WLC_IOCTL_MAXLEN
argument_list|)
expr_stmt|;
if|if
condition|(
name|buf
operator|==
name|NULL
condition|)
return|return
name|NULL
return|;
name|wsr
operator|=
operator|(
name|wl_scan_results_t
operator|*
operator|)
name|buf
expr_stmt|;
name|wsr
operator|->
name|buflen
operator|=
name|WLC_IOCTL_MAXLEN
operator|-
sizeof|sizeof
argument_list|(
name|wsr
argument_list|)
expr_stmt|;
name|wsr
operator|->
name|version
operator|=
literal|107
expr_stmt|;
name|wsr
operator|->
name|count
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|broadcom_ioctl
argument_list|(
name|drv
argument_list|,
name|WLC_SCAN_RESULTS
argument_list|,
name|buf
argument_list|,
name|WLC_IOCTL_MAXLEN
argument_list|)
operator|<
literal|0
condition|)
block|{
name|os_free
argument_list|(
name|buf
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|res
operator|=
name|os_zalloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|res
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|res
operator|==
name|NULL
condition|)
block|{
name|os_free
argument_list|(
name|buf
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|res
operator|->
name|res
operator|=
name|os_zalloc
argument_list|(
name|wsr
operator|->
name|count
operator|*
sizeof|sizeof
argument_list|(
expr|struct
name|wpa_scan_res
operator|*
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|res
operator|->
name|res
operator|==
name|NULL
condition|)
block|{
name|os_free
argument_list|(
name|res
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|buf
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
for|for
control|(
name|ap_num
operator|=
literal|0
operator|,
name|wbi
operator|=
name|wsr
operator|->
name|bss_info
init|;
name|ap_num
operator|<
name|wsr
operator|->
name|count
condition|;
operator|++
name|ap_num
control|)
block|{
name|struct
name|wpa_scan_res
modifier|*
name|r
decl_stmt|;
name|r
operator|=
name|os_malloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|r
argument_list|)
operator|+
name|wbi
operator|->
name|ie_length
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
operator|==
name|NULL
condition|)
break|break;
name|res
operator|->
name|res
index|[
name|res
operator|->
name|num
operator|++
index|]
operator|=
name|r
expr_stmt|;
name|os_memcpy
argument_list|(
name|r
operator|->
name|bssid
argument_list|,
operator|&
name|wbi
operator|->
name|BSSID
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
name|r
operator|->
name|freq
operator|=
name|frequency_list
index|[
name|wbi
operator|->
name|channel
operator|-
literal|1
index|]
expr_stmt|;
comment|/* get ie's */
name|os_memcpy
argument_list|(
name|r
operator|+
literal|1
argument_list|,
name|wbi
operator|+
literal|1
argument_list|,
name|wbi
operator|->
name|ie_length
argument_list|)
expr_stmt|;
name|r
operator|->
name|ie_len
operator|=
name|wbi
operator|->
name|ie_length
expr_stmt|;
name|wbi
operator|=
operator|(
name|wl_bss_info_t
operator|*
operator|)
operator|(
operator|(
name|u8
operator|*
operator|)
name|wbi
operator|+
name|wbi
operator|->
name|length
operator|)
expr_stmt|;
block|}
name|wpa_printf
argument_list|(
name|MSG_MSGDUMP
argument_list|,
literal|"Received %d bytes of scan results (%lu "
literal|"BSSes)"
argument_list|,
name|wsr
operator|->
name|buflen
argument_list|,
operator|(
name|unsigned
name|long
operator|)
name|ap_num
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|buf
argument_list|)
expr_stmt|;
return|return
name|res
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|wpa_driver_broadcom_deauthenticate
parameter_list|(
name|void
modifier|*
name|priv
parameter_list|,
specifier|const
name|u8
modifier|*
name|addr
parameter_list|,
name|int
name|reason_code
parameter_list|)
block|{
name|struct
name|wpa_driver_broadcom_data
modifier|*
name|drv
init|=
name|priv
decl_stmt|;
name|wlc_deauth_t
name|wdt
decl_stmt|;
name|wdt
operator|.
name|val
operator|=
name|reason_code
expr_stmt|;
name|os_memcpy
argument_list|(
operator|&
name|wdt
operator|.
name|ea
argument_list|,
name|addr
argument_list|,
sizeof|sizeof
name|wdt
operator|.
name|ea
argument_list|)
expr_stmt|;
name|wdt
operator|.
name|res
operator|=
literal|0x7fff
expr_stmt|;
return|return
name|broadcom_ioctl
argument_list|(
name|drv
argument_list|,
name|WLC_DEAUTHENTICATE_WITH_REASON
argument_list|,
operator|&
name|wdt
argument_list|,
sizeof|sizeof
argument_list|(
name|wdt
argument_list|)
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|wpa_driver_broadcom_disassociate
parameter_list|(
name|void
modifier|*
name|priv
parameter_list|,
specifier|const
name|u8
modifier|*
name|addr
parameter_list|,
name|int
name|reason_code
parameter_list|)
block|{
name|struct
name|wpa_driver_broadcom_data
modifier|*
name|drv
init|=
name|priv
decl_stmt|;
return|return
name|broadcom_ioctl
argument_list|(
name|drv
argument_list|,
name|WLC_DISASSOC
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|wpa_driver_broadcom_associate
parameter_list|(
name|void
modifier|*
name|priv
parameter_list|,
name|struct
name|wpa_driver_associate_params
modifier|*
name|params
parameter_list|)
block|{
name|struct
name|wpa_driver_broadcom_data
modifier|*
name|drv
init|=
name|priv
decl_stmt|;
name|wlc_ssid_t
name|s
decl_stmt|;
name|int
name|infra
init|=
literal|1
decl_stmt|;
name|int
name|auth
init|=
literal|0
decl_stmt|;
name|int
name|wsec
init|=
literal|4
decl_stmt|;
name|int
name|dummy
decl_stmt|;
name|int
name|wpa_auth
decl_stmt|;
name|int
name|ret
decl_stmt|;
name|ret
operator|=
name|wpa_driver_broadcom_set_drop_unencrypted
argument_list|(
name|drv
argument_list|,
name|params
operator|->
name|drop_unencrypted
argument_list|)
expr_stmt|;
name|s
operator|.
name|SSID_len
operator|=
name|params
operator|->
name|ssid_len
expr_stmt|;
name|os_memcpy
argument_list|(
name|s
operator|.
name|SSID
argument_list|,
name|params
operator|->
name|ssid
argument_list|,
name|params
operator|->
name|ssid_len
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|params
operator|->
name|pairwise_suite
condition|)
block|{
case|case
name|CIPHER_WEP40
case|:
case|case
name|CIPHER_WEP104
case|:
name|wsec
operator|=
literal|1
expr_stmt|;
break|break;
case|case
name|CIPHER_TKIP
case|:
name|wsec
operator|=
literal|2
expr_stmt|;
break|break;
case|case
name|CIPHER_CCMP
case|:
name|wsec
operator|=
literal|4
expr_stmt|;
break|break;
default|default:
name|wsec
operator|=
literal|0
expr_stmt|;
break|break;
block|}
switch|switch
condition|(
name|params
operator|->
name|key_mgmt_suite
condition|)
block|{
case|case
name|KEY_MGMT_802_1X
case|:
name|wpa_auth
operator|=
literal|1
expr_stmt|;
break|break;
case|case
name|KEY_MGMT_PSK
case|:
name|wpa_auth
operator|=
literal|2
expr_stmt|;
break|break;
default|default:
name|wpa_auth
operator|=
literal|255
expr_stmt|;
break|break;
block|}
comment|/* printf("broadcom_associate: %u %u %u\n", pairwise_suite, 	 * group_suite, key_mgmt_suite); 	 * broadcom_ioctl(ifname, WLC_GET_WSEC,&wsec, sizeof(wsec)); 	 * wl join uses wlc_sec_wep here, not wlc_set_wsec */
if|if
condition|(
name|broadcom_ioctl
argument_list|(
name|drv
argument_list|,
name|WLC_SET_WSEC
argument_list|,
operator|&
name|wsec
argument_list|,
sizeof|sizeof
argument_list|(
name|wsec
argument_list|)
argument_list|)
operator|<
literal|0
operator|||
name|broadcom_ioctl
argument_list|(
name|drv
argument_list|,
name|WLC_SET_WPA_AUTH
argument_list|,
operator|&
name|wpa_auth
argument_list|,
sizeof|sizeof
argument_list|(
name|wpa_auth
argument_list|)
argument_list|)
operator|<
literal|0
operator|||
name|broadcom_ioctl
argument_list|(
name|drv
argument_list|,
name|WLC_GET_WEP
argument_list|,
operator|&
name|dummy
argument_list|,
sizeof|sizeof
argument_list|(
name|dummy
argument_list|)
argument_list|)
operator|<
literal|0
operator|||
name|broadcom_ioctl
argument_list|(
name|drv
argument_list|,
name|WLC_SET_INFRA
argument_list|,
operator|&
name|infra
argument_list|,
sizeof|sizeof
argument_list|(
name|infra
argument_list|)
argument_list|)
operator|<
literal|0
operator|||
name|broadcom_ioctl
argument_list|(
name|drv
argument_list|,
name|WLC_SET_AUTH
argument_list|,
operator|&
name|auth
argument_list|,
sizeof|sizeof
argument_list|(
name|auth
argument_list|)
argument_list|)
operator|<
literal|0
operator|||
name|broadcom_ioctl
argument_list|(
name|drv
argument_list|,
name|WLC_SET_WEP
argument_list|,
operator|&
name|wsec
argument_list|,
sizeof|sizeof
argument_list|(
name|wsec
argument_list|)
argument_list|)
operator|<
literal|0
operator|||
name|broadcom_ioctl
argument_list|(
name|drv
argument_list|,
name|WLC_SET_SSID
argument_list|,
operator|&
name|s
argument_list|,
sizeof|sizeof
argument_list|(
name|s
argument_list|)
argument_list|)
operator|<
literal|0
condition|)
return|return
operator|-
literal|1
return|;
return|return
name|ret
return|;
block|}
end_function

begin_decl_stmt
specifier|const
name|struct
name|wpa_driver_ops
name|wpa_driver_broadcom_ops
init|=
block|{
operator|.
name|name
operator|=
literal|"broadcom"
block|,
operator|.
name|desc
operator|=
literal|"Broadcom wl.o driver"
block|,
operator|.
name|get_bssid
operator|=
name|wpa_driver_broadcom_get_bssid
block|,
operator|.
name|get_ssid
operator|=
name|wpa_driver_broadcom_get_ssid
block|,
operator|.
name|set_key
operator|=
name|wpa_driver_broadcom_set_key
block|,
operator|.
name|init
operator|=
name|wpa_driver_broadcom_init
block|,
operator|.
name|deinit
operator|=
name|wpa_driver_broadcom_deinit
block|,
operator|.
name|set_countermeasures
operator|=
name|wpa_driver_broadcom_set_countermeasures
block|,
operator|.
name|scan2
operator|=
name|wpa_driver_broadcom_scan
block|,
operator|.
name|get_scan_results2
operator|=
name|wpa_driver_broadcom_get_scan_results
block|,
operator|.
name|deauthenticate
operator|=
name|wpa_driver_broadcom_deauthenticate
block|,
operator|.
name|disassociate
operator|=
name|wpa_driver_broadcom_disassociate
block|,
operator|.
name|associate
operator|=
name|wpa_driver_broadcom_associate
block|, }
decl_stmt|;
end_decl_stmt

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_include
include|#
directive|include
file|"includes.h"
end_include

begin_include
include|#
directive|include
file|<dlfcn.h>
end_include

begin_include
include|#
directive|include
file|"common.h"
end_include

begin_include
include|#
directive|include
file|<CoreFoundation/CoreFoundation.h>
end_include

begin_include
include|#
directive|include
file|"MobileApple80211.h"
end_include

begin_comment
comment|/*  * Code for dynamically loading Apple80211 functions from Aeropuerto to avoid  * having to link with full Preferences.framework.  */
end_comment

begin_decl_stmt
specifier|static
name|void
modifier|*
name|aeropuerto
init|=
name|NULL
decl_stmt|;
end_decl_stmt

begin_function
name|int
name|_Apple80211Initialized
parameter_list|(
name|void
parameter_list|)
block|{
return|return
name|aeropuerto
condition|?
literal|1
else|:
literal|0
return|;
block|}
end_function

begin_function_decl
specifier|static
name|int
function_decl|(
modifier|*
name|__Apple80211Open
function_decl|)
parameter_list|(
name|Apple80211Ref
modifier|*
name|ctx
parameter_list|)
init|=
name|NULL
function_decl|;
end_function_decl

begin_function
name|int
name|Apple80211Open
parameter_list|(
name|Apple80211Ref
modifier|*
name|ctx
parameter_list|)
block|{
return|return
name|__Apple80211Open
argument_list|(
name|ctx
argument_list|)
return|;
block|}
end_function

begin_function_decl
specifier|static
name|int
function_decl|(
modifier|*
name|__Apple80211Close
function_decl|)
parameter_list|(
name|Apple80211Ref
name|ctx
parameter_list|)
init|=
name|NULL
function_decl|;
end_function_decl

begin_function
name|int
name|Apple80211Close
parameter_list|(
name|Apple80211Ref
name|ctx
parameter_list|)
block|{
return|return
name|__Apple80211Close
argument_list|(
name|ctx
argument_list|)
return|;
block|}
end_function

begin_function_decl
specifier|static
name|int
function_decl|(
modifier|*
name|__Apple80211GetIfListCopy
function_decl|)
parameter_list|(
name|Apple80211Ref
name|handle
parameter_list|,
name|CFArrayRef
modifier|*
name|list
parameter_list|)
init|=
name|NULL
function_decl|;
end_function_decl

begin_function
name|int
name|Apple80211GetIfListCopy
parameter_list|(
name|Apple80211Ref
name|handle
parameter_list|,
name|CFArrayRef
modifier|*
name|list
parameter_list|)
block|{
return|return
name|__Apple80211GetIfListCopy
argument_list|(
name|handle
argument_list|,
name|list
argument_list|)
return|;
block|}
end_function

begin_function_decl
specifier|static
name|int
function_decl|(
modifier|*
name|__Apple80211BindToInterface
function_decl|)
parameter_list|(
name|Apple80211Ref
name|handle
parameter_list|,
name|CFStringRef
name|interface
parameter_list|)
init|=
name|NULL
function_decl|;
end_function_decl

begin_function
name|int
name|Apple80211BindToInterface
parameter_list|(
name|Apple80211Ref
name|handle
parameter_list|,
name|CFStringRef
name|interface
parameter_list|)
block|{
return|return
name|__Apple80211BindToInterface
argument_list|(
name|handle
argument_list|,
name|interface
argument_list|)
return|;
block|}
end_function

begin_function_decl
specifier|static
name|int
function_decl|(
modifier|*
name|__Apple80211GetInterfaceNameCopy
function_decl|)
parameter_list|(
name|Apple80211Ref
name|handle
parameter_list|,
name|CFStringRef
modifier|*
name|name
parameter_list|)
init|=
name|NULL
function_decl|;
end_function_decl

begin_function
name|int
name|Apple80211GetInterfaceNameCopy
parameter_list|(
name|Apple80211Ref
name|handle
parameter_list|,
name|CFStringRef
modifier|*
name|name
parameter_list|)
block|{
return|return
name|__Apple80211GetInterfaceNameCopy
argument_list|(
name|handle
argument_list|,
name|name
argument_list|)
return|;
block|}
end_function

begin_function_decl
specifier|static
name|int
function_decl|(
modifier|*
name|__Apple80211GetInfoCopy
function_decl|)
parameter_list|(
name|Apple80211Ref
name|handle
parameter_list|,
name|CFDictionaryRef
modifier|*
name|info
parameter_list|)
init|=
name|NULL
function_decl|;
end_function_decl

begin_function
name|int
name|Apple80211GetInfoCopy
parameter_list|(
name|Apple80211Ref
name|handle
parameter_list|,
name|CFDictionaryRef
modifier|*
name|info
parameter_list|)
block|{
return|return
name|__Apple80211GetInfoCopy
argument_list|(
name|handle
argument_list|,
name|info
argument_list|)
return|;
block|}
end_function

begin_function_decl
specifier|static
name|int
function_decl|(
modifier|*
name|__Apple80211GetPower
function_decl|)
parameter_list|(
name|Apple80211Ref
name|handle
parameter_list|,
name|char
modifier|*
name|pwr
parameter_list|)
init|=
name|NULL
function_decl|;
end_function_decl

begin_function
name|int
name|Apple80211GetPower
parameter_list|(
name|Apple80211Ref
name|handle
parameter_list|,
name|char
modifier|*
name|pwr
parameter_list|)
block|{
return|return
name|__Apple80211GetPower
argument_list|(
name|handle
argument_list|,
name|pwr
argument_list|)
return|;
block|}
end_function

begin_function_decl
specifier|static
name|int
function_decl|(
modifier|*
name|__Apple80211SetPower
function_decl|)
parameter_list|(
name|Apple80211Ref
name|handle
parameter_list|,
name|char
name|pwr
parameter_list|)
init|=
name|NULL
function_decl|;
end_function_decl

begin_function
name|int
name|Apple80211SetPower
parameter_list|(
name|Apple80211Ref
name|handle
parameter_list|,
name|char
name|pwr
parameter_list|)
block|{
return|return
name|__Apple80211SetPower
argument_list|(
name|handle
argument_list|,
name|pwr
argument_list|)
return|;
block|}
end_function

begin_function_decl
specifier|static
name|int
function_decl|(
modifier|*
name|__Apple80211Scan
function_decl|)
parameter_list|(
name|Apple80211Ref
name|handle
parameter_list|,
name|CFArrayRef
modifier|*
name|list
parameter_list|,
name|CFDictionaryRef
name|parameters
parameter_list|)
init|=
name|NULL
function_decl|;
end_function_decl

begin_function
name|int
name|Apple80211Scan
parameter_list|(
name|Apple80211Ref
name|handle
parameter_list|,
name|CFArrayRef
modifier|*
name|list
parameter_list|,
name|CFDictionaryRef
name|parameters
parameter_list|)
block|{
return|return
name|__Apple80211Scan
argument_list|(
name|handle
argument_list|,
name|list
argument_list|,
name|parameters
argument_list|)
return|;
block|}
end_function

begin_function_decl
specifier|static
name|int
function_decl|(
modifier|*
name|__Apple80211Associate
function_decl|)
parameter_list|(
name|Apple80211Ref
name|handle
parameter_list|,
name|CFDictionaryRef
name|bss
parameter_list|,
name|CFStringRef
name|password
parameter_list|)
init|=
name|NULL
function_decl|;
end_function_decl

begin_function
name|int
name|Apple80211Associate
parameter_list|(
name|Apple80211Ref
name|handle
parameter_list|,
name|CFDictionaryRef
name|bss
parameter_list|,
name|CFStringRef
name|password
parameter_list|)
block|{
return|return
name|__Apple80211Associate
argument_list|(
name|handle
argument_list|,
name|bss
argument_list|,
name|password
argument_list|)
return|;
block|}
end_function

begin_function_decl
specifier|static
name|int
function_decl|(
modifier|*
name|__Apple80211AssociateAndCopyInfo
function_decl|)
parameter_list|(
name|Apple80211Ref
name|handle
parameter_list|,
name|CFDictionaryRef
name|bss
parameter_list|,
name|CFStringRef
name|password
parameter_list|,
name|CFDictionaryRef
modifier|*
name|info
parameter_list|)
init|=
name|NULL
function_decl|;
end_function_decl

begin_function
name|int
name|Apple80211AssociateAndCopyInfo
parameter_list|(
name|Apple80211Ref
name|handle
parameter_list|,
name|CFDictionaryRef
name|bss
parameter_list|,
name|CFStringRef
name|password
parameter_list|,
name|CFDictionaryRef
modifier|*
name|info
parameter_list|)
block|{
return|return
name|__Apple80211AssociateAndCopyInfo
argument_list|(
name|handle
argument_list|,
name|bss
argument_list|,
name|password
argument_list|,
name|info
argument_list|)
return|;
block|}
end_function

begin_function_decl
specifier|static
name|int
function_decl|(
modifier|*
name|__Apple80211CopyValue
function_decl|)
parameter_list|(
name|Apple80211Ref
name|handle
parameter_list|,
name|int
name|field
parameter_list|,
name|CFDictionaryRef
name|arg2
parameter_list|,
name|void
modifier|*
name|value
parameter_list|)
init|=
name|NULL
function_decl|;
end_function_decl

begin_function
name|int
name|Apple80211CopyValue
parameter_list|(
name|Apple80211Ref
name|handle
parameter_list|,
name|int
name|field
parameter_list|,
name|CFDictionaryRef
name|arg2
parameter_list|,
name|void
modifier|*
name|value
parameter_list|)
block|{
return|return
name|__Apple80211CopyValue
argument_list|(
name|handle
argument_list|,
name|field
argument_list|,
name|arg2
argument_list|,
name|value
argument_list|)
return|;
block|}
end_function

begin_define
define|#
directive|define
name|DLSYM
parameter_list|(
name|s
parameter_list|)
define|\
value|do { \ 	__ ## s = dlsym(aeropuerto, #s); \ 	if (__ ## s == NULL) { \ 		wpa_printf(MSG_ERROR, "MobileApple80211: Could not resolve " \ 			   "symbol '" #s "' (%s)", dlerror()); \ 		err = 1; \ 	} \ } while (0)
end_define

begin_macro
name|__attribute__
argument_list|(
argument|(constructor)
argument_list|)
end_macro

begin_function
name|void
name|_Apple80211_constructor
parameter_list|(
name|void
parameter_list|)
block|{
specifier|const
name|char
modifier|*
name|fname
init|=
literal|"/System/Library/SystemConfiguration/"
literal|"Aeropuerto.bundle/Aeropuerto"
decl_stmt|;
name|int
name|err
init|=
literal|0
decl_stmt|;
name|aeropuerto
operator|=
name|dlopen
argument_list|(
name|fname
argument_list|,
name|RTLD_LAZY
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|aeropuerto
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"MobileApple80211: Failed to open %s "
literal|"for symbols"
argument_list|,
name|fname
argument_list|)
expr_stmt|;
return|return;
block|}
name|DLSYM
argument_list|(
name|Apple80211Open
argument_list|)
expr_stmt|;
name|DLSYM
argument_list|(
name|Apple80211Close
argument_list|)
expr_stmt|;
name|DLSYM
argument_list|(
name|Apple80211GetIfListCopy
argument_list|)
expr_stmt|;
name|DLSYM
argument_list|(
name|Apple80211BindToInterface
argument_list|)
expr_stmt|;
name|DLSYM
argument_list|(
name|Apple80211GetInterfaceNameCopy
argument_list|)
expr_stmt|;
name|DLSYM
argument_list|(
name|Apple80211GetInfoCopy
argument_list|)
expr_stmt|;
name|DLSYM
argument_list|(
name|Apple80211GetPower
argument_list|)
expr_stmt|;
name|DLSYM
argument_list|(
name|Apple80211SetPower
argument_list|)
expr_stmt|;
name|DLSYM
argument_list|(
name|Apple80211Scan
argument_list|)
expr_stmt|;
name|DLSYM
argument_list|(
name|Apple80211Associate
argument_list|)
expr_stmt|;
name|DLSYM
argument_list|(
name|Apple80211AssociateAndCopyInfo
argument_list|)
expr_stmt|;
name|DLSYM
argument_list|(
name|Apple80211CopyValue
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
block|{
name|dlclose
argument_list|(
name|aeropuerto
argument_list|)
expr_stmt|;
name|aeropuerto
operator|=
name|NULL
expr_stmt|;
block|}
block|}
end_function

begin_macro
name|__attribute__
argument_list|(
argument|(destructor)
argument_list|)
end_macro

begin_function
name|void
name|_Apple80211_destructor
parameter_list|(
name|void
parameter_list|)
block|{
if|if
condition|(
name|aeropuerto
condition|)
block|{
name|dlclose
argument_list|(
name|aeropuerto
argument_list|)
expr_stmt|;
name|aeropuerto
operator|=
name|NULL
expr_stmt|;
block|}
block|}
end_function

end_unit


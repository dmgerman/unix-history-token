begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Testing driver interface for a simulated network driver  * Copyright (c) 2004-2010, Jouni Malinen<j@w1.fi>  *  * This program is free software; you can redistribute it and/or modify  * it under the terms of the GNU General Public License version 2 as  * published by the Free Software Foundation.  *  * Alternatively, this software may be distributed under the terms of BSD  * license.  *  * See README and COPYING for more details.  */
end_comment

begin_comment
comment|/* Make sure we get winsock2.h for Windows build to get sockaddr_storage */
end_comment

begin_include
include|#
directive|include
file|"build_config.h"
end_include

begin_ifdef
ifdef|#
directive|ifdef
name|CONFIG_NATIVE_WINDOWS
end_ifdef

begin_include
include|#
directive|include
file|<winsock2.h>
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* CONFIG_NATIVE_WINDOWS */
end_comment

begin_include
include|#
directive|include
file|"utils/includes.h"
end_include

begin_ifndef
ifndef|#
directive|ifndef
name|CONFIG_NATIVE_WINDOWS
end_ifndef

begin_include
include|#
directive|include
file|<sys/un.h>
end_include

begin_include
include|#
directive|include
file|<dirent.h>
end_include

begin_include
include|#
directive|include
file|<sys/stat.h>
end_include

begin_define
define|#
directive|define
name|DRIVER_TEST_UNIX
end_define

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* CONFIG_NATIVE_WINDOWS */
end_comment

begin_include
include|#
directive|include
file|"utils/common.h"
end_include

begin_include
include|#
directive|include
file|"utils/eloop.h"
end_include

begin_include
include|#
directive|include
file|"utils/list.h"
end_include

begin_include
include|#
directive|include
file|"utils/trace.h"
end_include

begin_include
include|#
directive|include
file|"common/ieee802_11_defs.h"
end_include

begin_include
include|#
directive|include
file|"crypto/sha1.h"
end_include

begin_include
include|#
directive|include
file|"l2_packet/l2_packet.h"
end_include

begin_include
include|#
directive|include
file|"driver.h"
end_include

begin_struct
struct|struct
name|test_client_socket
block|{
name|struct
name|test_client_socket
modifier|*
name|next
decl_stmt|;
name|u8
name|addr
index|[
name|ETH_ALEN
index|]
decl_stmt|;
name|struct
name|sockaddr_un
name|un
decl_stmt|;
name|socklen_t
name|unlen
decl_stmt|;
name|struct
name|test_driver_bss
modifier|*
name|bss
decl_stmt|;
block|}
struct|;
end_struct

begin_struct
struct|struct
name|test_driver_bss
block|{
name|struct
name|wpa_driver_test_data
modifier|*
name|drv
decl_stmt|;
name|struct
name|dl_list
name|list
decl_stmt|;
name|void
modifier|*
name|bss_ctx
decl_stmt|;
name|char
name|ifname
index|[
name|IFNAMSIZ
index|]
decl_stmt|;
name|u8
name|bssid
index|[
name|ETH_ALEN
index|]
decl_stmt|;
name|u8
modifier|*
name|ie
decl_stmt|;
name|size_t
name|ielen
decl_stmt|;
name|u8
modifier|*
name|wps_beacon_ie
decl_stmt|;
name|size_t
name|wps_beacon_ie_len
decl_stmt|;
name|u8
modifier|*
name|wps_probe_resp_ie
decl_stmt|;
name|size_t
name|wps_probe_resp_ie_len
decl_stmt|;
name|u8
name|ssid
index|[
literal|32
index|]
decl_stmt|;
name|size_t
name|ssid_len
decl_stmt|;
name|int
name|privacy
decl_stmt|;
block|}
struct|;
end_struct

begin_struct
struct|struct
name|wpa_driver_test_global
block|{
name|int
name|bss_add_used
decl_stmt|;
name|u8
name|req_addr
index|[
name|ETH_ALEN
index|]
decl_stmt|;
block|}
struct|;
end_struct

begin_struct
struct|struct
name|wpa_driver_test_data
block|{
name|struct
name|wpa_driver_test_global
modifier|*
name|global
decl_stmt|;
name|void
modifier|*
name|ctx
decl_stmt|;
name|WPA_TRACE_REF
argument_list|(
name|ctx
argument_list|)
expr_stmt|;
name|u8
name|own_addr
index|[
name|ETH_ALEN
index|]
decl_stmt|;
name|int
name|test_socket
decl_stmt|;
ifdef|#
directive|ifdef
name|DRIVER_TEST_UNIX
name|struct
name|sockaddr_un
name|hostapd_addr
decl_stmt|;
endif|#
directive|endif
comment|/* DRIVER_TEST_UNIX */
name|int
name|hostapd_addr_set
decl_stmt|;
name|struct
name|sockaddr_in
name|hostapd_addr_udp
decl_stmt|;
name|int
name|hostapd_addr_udp_set
decl_stmt|;
name|char
modifier|*
name|own_socket_path
decl_stmt|;
name|char
modifier|*
name|test_dir
decl_stmt|;
define|#
directive|define
name|MAX_SCAN_RESULTS
value|30
name|struct
name|wpa_scan_res
modifier|*
name|scanres
index|[
name|MAX_SCAN_RESULTS
index|]
decl_stmt|;
name|size_t
name|num_scanres
decl_stmt|;
name|int
name|use_associnfo
decl_stmt|;
name|u8
name|assoc_wpa_ie
index|[
literal|80
index|]
decl_stmt|;
name|size_t
name|assoc_wpa_ie_len
decl_stmt|;
name|int
name|use_mlme
decl_stmt|;
name|int
name|associated
decl_stmt|;
name|u8
modifier|*
name|probe_req_ie
decl_stmt|;
name|size_t
name|probe_req_ie_len
decl_stmt|;
name|u8
name|probe_req_ssid
index|[
literal|32
index|]
decl_stmt|;
name|size_t
name|probe_req_ssid_len
decl_stmt|;
name|int
name|ibss
decl_stmt|;
name|int
name|ap
decl_stmt|;
name|struct
name|test_client_socket
modifier|*
name|cli
decl_stmt|;
name|struct
name|dl_list
name|bss
decl_stmt|;
name|int
name|udp_port
decl_stmt|;
name|int
name|alloc_iface_idx
decl_stmt|;
name|int
name|probe_req_report
decl_stmt|;
name|unsigned
name|int
name|remain_on_channel_freq
decl_stmt|;
name|unsigned
name|int
name|remain_on_channel_duration
decl_stmt|;
name|int
name|current_freq
decl_stmt|;
block|}
struct|;
end_struct

begin_function_decl
specifier|static
name|void
name|wpa_driver_test_deinit
parameter_list|(
name|void
modifier|*
name|priv
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|wpa_driver_test_attach
parameter_list|(
name|struct
name|wpa_driver_test_data
modifier|*
name|drv
parameter_list|,
specifier|const
name|char
modifier|*
name|dir
parameter_list|,
name|int
name|ap
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|wpa_driver_test_close_test_socket
parameter_list|(
name|struct
name|wpa_driver_test_data
modifier|*
name|drv
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|test_remain_on_channel_timeout
parameter_list|(
name|void
modifier|*
name|eloop_ctx
parameter_list|,
name|void
modifier|*
name|timeout_ctx
parameter_list|)
function_decl|;
end_function_decl

begin_function
specifier|static
name|void
name|test_driver_free_bss
parameter_list|(
name|struct
name|test_driver_bss
modifier|*
name|bss
parameter_list|)
block|{
name|os_free
argument_list|(
name|bss
operator|->
name|ie
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|bss
operator|->
name|wps_beacon_ie
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|bss
operator|->
name|wps_probe_resp_ie
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|bss
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|test_driver_free_bsses
parameter_list|(
name|struct
name|wpa_driver_test_data
modifier|*
name|drv
parameter_list|)
block|{
name|struct
name|test_driver_bss
modifier|*
name|bss
decl_stmt|,
modifier|*
name|tmp
decl_stmt|;
name|dl_list_for_each_safe
argument_list|(
argument|bss
argument_list|,
argument|tmp
argument_list|,
argument|&drv->bss
argument_list|,
argument|struct test_driver_bss
argument_list|,
argument|list
argument_list|)
block|{
name|dl_list_del
argument_list|(
operator|&
name|bss
operator|->
name|list
argument_list|)
expr_stmt|;
name|test_driver_free_bss
argument_list|(
name|bss
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|struct
name|test_client_socket
modifier|*
name|test_driver_get_cli
parameter_list|(
name|struct
name|wpa_driver_test_data
modifier|*
name|drv
parameter_list|,
name|struct
name|sockaddr_un
modifier|*
name|from
parameter_list|,
name|socklen_t
name|fromlen
parameter_list|)
block|{
name|struct
name|test_client_socket
modifier|*
name|cli
init|=
name|drv
operator|->
name|cli
decl_stmt|;
while|while
condition|(
name|cli
condition|)
block|{
if|if
condition|(
name|cli
operator|->
name|unlen
operator|==
name|fromlen
operator|&&
name|strncmp
argument_list|(
name|cli
operator|->
name|un
operator|.
name|sun_path
argument_list|,
name|from
operator|->
name|sun_path
argument_list|,
name|fromlen
operator|-
sizeof|sizeof
argument_list|(
name|cli
operator|->
name|un
operator|.
name|sun_family
argument_list|)
argument_list|)
operator|==
literal|0
condition|)
return|return
name|cli
return|;
name|cli
operator|=
name|cli
operator|->
name|next
expr_stmt|;
block|}
return|return
name|NULL
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|test_driver_send_eapol
parameter_list|(
name|void
modifier|*
name|priv
parameter_list|,
specifier|const
name|u8
modifier|*
name|addr
parameter_list|,
specifier|const
name|u8
modifier|*
name|data
parameter_list|,
name|size_t
name|data_len
parameter_list|,
name|int
name|encrypt
parameter_list|,
specifier|const
name|u8
modifier|*
name|own_addr
parameter_list|)
block|{
name|struct
name|test_driver_bss
modifier|*
name|dbss
init|=
name|priv
decl_stmt|;
name|struct
name|wpa_driver_test_data
modifier|*
name|drv
init|=
name|dbss
operator|->
name|drv
decl_stmt|;
name|struct
name|test_client_socket
modifier|*
name|cli
decl_stmt|;
name|struct
name|msghdr
name|msg
decl_stmt|;
name|struct
name|iovec
name|io
index|[
literal|3
index|]
decl_stmt|;
name|struct
name|l2_ethhdr
name|eth
decl_stmt|;
if|if
condition|(
name|drv
operator|->
name|test_socket
operator|<
literal|0
condition|)
return|return
operator|-
literal|1
return|;
name|cli
operator|=
name|drv
operator|->
name|cli
expr_stmt|;
while|while
condition|(
name|cli
condition|)
block|{
if|if
condition|(
name|memcmp
argument_list|(
name|cli
operator|->
name|addr
argument_list|,
name|addr
argument_list|,
name|ETH_ALEN
argument_list|)
operator|==
literal|0
condition|)
break|break;
name|cli
operator|=
name|cli
operator|->
name|next
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|cli
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"%s: no destination client entry"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|memcpy
argument_list|(
name|eth
operator|.
name|h_dest
argument_list|,
name|addr
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
name|eth
operator|.
name|h_source
argument_list|,
name|own_addr
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
name|eth
operator|.
name|h_proto
operator|=
name|host_to_be16
argument_list|(
name|ETH_P_EAPOL
argument_list|)
expr_stmt|;
name|io
index|[
literal|0
index|]
operator|.
name|iov_base
operator|=
literal|"EAPOL "
expr_stmt|;
name|io
index|[
literal|0
index|]
operator|.
name|iov_len
operator|=
literal|6
expr_stmt|;
name|io
index|[
literal|1
index|]
operator|.
name|iov_base
operator|=
operator|&
name|eth
expr_stmt|;
name|io
index|[
literal|1
index|]
operator|.
name|iov_len
operator|=
sizeof|sizeof
argument_list|(
name|eth
argument_list|)
expr_stmt|;
name|io
index|[
literal|2
index|]
operator|.
name|iov_base
operator|=
operator|(
name|u8
operator|*
operator|)
name|data
expr_stmt|;
name|io
index|[
literal|2
index|]
operator|.
name|iov_len
operator|=
name|data_len
expr_stmt|;
name|memset
argument_list|(
operator|&
name|msg
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|msg
argument_list|)
argument_list|)
expr_stmt|;
name|msg
operator|.
name|msg_iov
operator|=
name|io
expr_stmt|;
name|msg
operator|.
name|msg_iovlen
operator|=
literal|3
expr_stmt|;
name|msg
operator|.
name|msg_name
operator|=
operator|&
name|cli
operator|->
name|un
expr_stmt|;
name|msg
operator|.
name|msg_namelen
operator|=
name|cli
operator|->
name|unlen
expr_stmt|;
return|return
name|sendmsg
argument_list|(
name|drv
operator|->
name|test_socket
argument_list|,
operator|&
name|msg
argument_list|,
literal|0
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|test_driver_send_ether
parameter_list|(
name|void
modifier|*
name|priv
parameter_list|,
specifier|const
name|u8
modifier|*
name|dst
parameter_list|,
specifier|const
name|u8
modifier|*
name|src
parameter_list|,
name|u16
name|proto
parameter_list|,
specifier|const
name|u8
modifier|*
name|data
parameter_list|,
name|size_t
name|data_len
parameter_list|)
block|{
name|struct
name|test_driver_bss
modifier|*
name|dbss
init|=
name|priv
decl_stmt|;
name|struct
name|wpa_driver_test_data
modifier|*
name|drv
init|=
name|dbss
operator|->
name|drv
decl_stmt|;
name|struct
name|msghdr
name|msg
decl_stmt|;
name|struct
name|iovec
name|io
index|[
literal|3
index|]
decl_stmt|;
name|struct
name|l2_ethhdr
name|eth
decl_stmt|;
name|char
name|desttxt
index|[
literal|30
index|]
decl_stmt|;
name|struct
name|sockaddr_un
name|addr
decl_stmt|;
name|struct
name|dirent
modifier|*
name|dent
decl_stmt|;
name|DIR
modifier|*
name|dir
decl_stmt|;
name|int
name|ret
init|=
literal|0
decl_stmt|,
name|broadcast
init|=
literal|0
decl_stmt|,
name|count
init|=
literal|0
decl_stmt|;
if|if
condition|(
name|drv
operator|->
name|test_socket
operator|<
literal|0
operator|||
name|drv
operator|->
name|test_dir
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"%s: invalid parameters (sock=%d "
literal|"test_dir=%p)"
argument_list|,
name|__func__
argument_list|,
name|drv
operator|->
name|test_socket
argument_list|,
name|drv
operator|->
name|test_dir
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|broadcast
operator|=
name|memcmp
argument_list|(
name|dst
argument_list|,
literal|"\xff\xff\xff\xff\xff\xff"
argument_list|,
name|ETH_ALEN
argument_list|)
operator|==
literal|0
expr_stmt|;
name|snprintf
argument_list|(
name|desttxt
argument_list|,
sizeof|sizeof
argument_list|(
name|desttxt
argument_list|)
argument_list|,
name|MACSTR
argument_list|,
name|MAC2STR
argument_list|(
name|dst
argument_list|)
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
name|eth
operator|.
name|h_dest
argument_list|,
name|dst
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
name|eth
operator|.
name|h_source
argument_list|,
name|src
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
name|eth
operator|.
name|h_proto
operator|=
name|host_to_be16
argument_list|(
name|proto
argument_list|)
expr_stmt|;
name|io
index|[
literal|0
index|]
operator|.
name|iov_base
operator|=
literal|"ETHER "
expr_stmt|;
name|io
index|[
literal|0
index|]
operator|.
name|iov_len
operator|=
literal|6
expr_stmt|;
name|io
index|[
literal|1
index|]
operator|.
name|iov_base
operator|=
operator|&
name|eth
expr_stmt|;
name|io
index|[
literal|1
index|]
operator|.
name|iov_len
operator|=
sizeof|sizeof
argument_list|(
name|eth
argument_list|)
expr_stmt|;
name|io
index|[
literal|2
index|]
operator|.
name|iov_base
operator|=
operator|(
name|u8
operator|*
operator|)
name|data
expr_stmt|;
name|io
index|[
literal|2
index|]
operator|.
name|iov_len
operator|=
name|data_len
expr_stmt|;
name|memset
argument_list|(
operator|&
name|msg
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|msg
argument_list|)
argument_list|)
expr_stmt|;
name|msg
operator|.
name|msg_iov
operator|=
name|io
expr_stmt|;
name|msg
operator|.
name|msg_iovlen
operator|=
literal|3
expr_stmt|;
name|dir
operator|=
name|opendir
argument_list|(
name|drv
operator|->
name|test_dir
argument_list|)
expr_stmt|;
if|if
condition|(
name|dir
operator|==
name|NULL
condition|)
block|{
name|perror
argument_list|(
literal|"test_driver: opendir"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
while|while
condition|(
operator|(
name|dent
operator|=
name|readdir
argument_list|(
name|dir
argument_list|)
operator|)
condition|)
block|{
ifdef|#
directive|ifdef
name|_DIRENT_HAVE_D_TYPE
comment|/* Skip the file if it is not a socket. Also accept 		 * DT_UNKNOWN (0) in case the C library or underlying file 		 * system does not support d_type. */
if|if
condition|(
name|dent
operator|->
name|d_type
operator|!=
name|DT_SOCK
operator|&&
name|dent
operator|->
name|d_type
operator|!=
name|DT_UNKNOWN
condition|)
continue|continue;
endif|#
directive|endif
comment|/* _DIRENT_HAVE_D_TYPE */
if|if
condition|(
name|strcmp
argument_list|(
name|dent
operator|->
name|d_name
argument_list|,
literal|"."
argument_list|)
operator|==
literal|0
operator|||
name|strcmp
argument_list|(
name|dent
operator|->
name|d_name
argument_list|,
literal|".."
argument_list|)
operator|==
literal|0
condition|)
continue|continue;
name|memset
argument_list|(
operator|&
name|addr
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|addr
argument_list|)
argument_list|)
expr_stmt|;
name|addr
operator|.
name|sun_family
operator|=
name|AF_UNIX
expr_stmt|;
name|snprintf
argument_list|(
name|addr
operator|.
name|sun_path
argument_list|,
sizeof|sizeof
argument_list|(
name|addr
operator|.
name|sun_path
argument_list|)
argument_list|,
literal|"%s/%s"
argument_list|,
name|drv
operator|->
name|test_dir
argument_list|,
name|dent
operator|->
name|d_name
argument_list|)
expr_stmt|;
if|if
condition|(
name|strcmp
argument_list|(
name|addr
operator|.
name|sun_path
argument_list|,
name|drv
operator|->
name|own_socket_path
argument_list|)
operator|==
literal|0
condition|)
continue|continue;
if|if
condition|(
operator|!
name|broadcast
operator|&&
name|strstr
argument_list|(
name|dent
operator|->
name|d_name
argument_list|,
name|desttxt
argument_list|)
operator|==
name|NULL
condition|)
continue|continue;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"%s: Send ether frame to %s"
argument_list|,
name|__func__
argument_list|,
name|dent
operator|->
name|d_name
argument_list|)
expr_stmt|;
name|msg
operator|.
name|msg_name
operator|=
operator|&
name|addr
expr_stmt|;
name|msg
operator|.
name|msg_namelen
operator|=
sizeof|sizeof
argument_list|(
name|addr
argument_list|)
expr_stmt|;
name|ret
operator|=
name|sendmsg
argument_list|(
name|drv
operator|->
name|test_socket
argument_list|,
operator|&
name|msg
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|<
literal|0
condition|)
name|perror
argument_list|(
literal|"driver_test: sendmsg"
argument_list|)
expr_stmt|;
name|count
operator|++
expr_stmt|;
block|}
name|closedir
argument_list|(
name|dir
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|broadcast
operator|&&
name|count
operator|==
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"%s: Destination "
name|MACSTR
literal|" not found"
argument_list|,
name|__func__
argument_list|,
name|MAC2STR
argument_list|(
name|dst
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
return|return
name|ret
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|wpa_driver_test_send_mlme
parameter_list|(
name|void
modifier|*
name|priv
parameter_list|,
specifier|const
name|u8
modifier|*
name|data
parameter_list|,
name|size_t
name|data_len
parameter_list|)
block|{
name|struct
name|test_driver_bss
modifier|*
name|dbss
init|=
name|priv
decl_stmt|;
name|struct
name|wpa_driver_test_data
modifier|*
name|drv
init|=
name|dbss
operator|->
name|drv
decl_stmt|;
name|struct
name|msghdr
name|msg
decl_stmt|;
name|struct
name|iovec
name|io
index|[
literal|2
index|]
decl_stmt|;
specifier|const
name|u8
modifier|*
name|dest
decl_stmt|;
name|struct
name|sockaddr_un
name|addr
decl_stmt|;
name|struct
name|dirent
modifier|*
name|dent
decl_stmt|;
name|DIR
modifier|*
name|dir
decl_stmt|;
name|int
name|broadcast
decl_stmt|;
name|int
name|ret
init|=
literal|0
decl_stmt|;
name|struct
name|ieee80211_hdr
modifier|*
name|hdr
decl_stmt|;
name|u16
name|fc
decl_stmt|;
name|char
name|cmd
index|[
literal|50
index|]
decl_stmt|;
name|int
name|freq
decl_stmt|;
ifdef|#
directive|ifdef
name|HOSTAPD
name|char
name|desttxt
index|[
literal|30
index|]
decl_stmt|;
endif|#
directive|endif
comment|/* HOSTAPD */
name|union
name|wpa_event_data
name|event
decl_stmt|;
name|wpa_hexdump
argument_list|(
name|MSG_MSGDUMP
argument_list|,
literal|"test_send_mlme"
argument_list|,
name|data
argument_list|,
name|data_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|drv
operator|->
name|test_socket
operator|<
literal|0
operator|||
name|data_len
operator|<
literal|10
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"%s: invalid parameters (sock=%d len=%lu"
literal|" test_dir=%p)"
argument_list|,
name|__func__
argument_list|,
name|drv
operator|->
name|test_socket
argument_list|,
operator|(
name|unsigned
name|long
operator|)
name|data_len
argument_list|,
name|drv
operator|->
name|test_dir
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|dest
operator|=
name|data
operator|+
literal|4
expr_stmt|;
name|broadcast
operator|=
name|os_memcmp
argument_list|(
name|dest
argument_list|,
literal|"\xff\xff\xff\xff\xff\xff"
argument_list|,
name|ETH_ALEN
argument_list|)
operator|==
literal|0
expr_stmt|;
ifdef|#
directive|ifdef
name|HOSTAPD
name|snprintf
argument_list|(
name|desttxt
argument_list|,
sizeof|sizeof
argument_list|(
name|desttxt
argument_list|)
argument_list|,
name|MACSTR
argument_list|,
name|MAC2STR
argument_list|(
name|dest
argument_list|)
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* HOSTAPD */
if|if
condition|(
name|drv
operator|->
name|remain_on_channel_freq
condition|)
name|freq
operator|=
name|drv
operator|->
name|remain_on_channel_freq
expr_stmt|;
else|else
name|freq
operator|=
name|drv
operator|->
name|current_freq
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"test_driver(%s): MLME TX on freq %d MHz"
argument_list|,
name|dbss
operator|->
name|ifname
argument_list|,
name|freq
argument_list|)
expr_stmt|;
name|os_snprintf
argument_list|(
name|cmd
argument_list|,
sizeof|sizeof
argument_list|(
name|cmd
argument_list|)
argument_list|,
literal|"MLME freq=%d "
argument_list|,
name|freq
argument_list|)
expr_stmt|;
name|io
index|[
literal|0
index|]
operator|.
name|iov_base
operator|=
name|cmd
expr_stmt|;
name|io
index|[
literal|0
index|]
operator|.
name|iov_len
operator|=
name|os_strlen
argument_list|(
name|cmd
argument_list|)
expr_stmt|;
name|io
index|[
literal|1
index|]
operator|.
name|iov_base
operator|=
operator|(
name|void
operator|*
operator|)
name|data
expr_stmt|;
name|io
index|[
literal|1
index|]
operator|.
name|iov_len
operator|=
name|data_len
expr_stmt|;
name|os_memset
argument_list|(
operator|&
name|msg
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|msg
argument_list|)
argument_list|)
expr_stmt|;
name|msg
operator|.
name|msg_iov
operator|=
name|io
expr_stmt|;
name|msg
operator|.
name|msg_iovlen
operator|=
literal|2
expr_stmt|;
ifdef|#
directive|ifdef
name|HOSTAPD
if|if
condition|(
name|drv
operator|->
name|test_dir
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"%s: test_dir == NULL"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|dir
operator|=
name|opendir
argument_list|(
name|drv
operator|->
name|test_dir
argument_list|)
expr_stmt|;
if|if
condition|(
name|dir
operator|==
name|NULL
condition|)
block|{
name|perror
argument_list|(
literal|"test_driver: opendir"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
while|while
condition|(
operator|(
name|dent
operator|=
name|readdir
argument_list|(
name|dir
argument_list|)
operator|)
condition|)
block|{
ifdef|#
directive|ifdef
name|_DIRENT_HAVE_D_TYPE
comment|/* Skip the file if it is not a socket. Also accept 		 * DT_UNKNOWN (0) in case the C library or underlying file 		 * system does not support d_type. */
if|if
condition|(
name|dent
operator|->
name|d_type
operator|!=
name|DT_SOCK
operator|&&
name|dent
operator|->
name|d_type
operator|!=
name|DT_UNKNOWN
condition|)
continue|continue;
endif|#
directive|endif
comment|/* _DIRENT_HAVE_D_TYPE */
if|if
condition|(
name|os_strcmp
argument_list|(
name|dent
operator|->
name|d_name
argument_list|,
literal|"."
argument_list|)
operator|==
literal|0
operator|||
name|os_strcmp
argument_list|(
name|dent
operator|->
name|d_name
argument_list|,
literal|".."
argument_list|)
operator|==
literal|0
condition|)
continue|continue;
name|os_memset
argument_list|(
operator|&
name|addr
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|addr
argument_list|)
argument_list|)
expr_stmt|;
name|addr
operator|.
name|sun_family
operator|=
name|AF_UNIX
expr_stmt|;
name|os_snprintf
argument_list|(
name|addr
operator|.
name|sun_path
argument_list|,
sizeof|sizeof
argument_list|(
name|addr
operator|.
name|sun_path
argument_list|)
argument_list|,
literal|"%s/%s"
argument_list|,
name|drv
operator|->
name|test_dir
argument_list|,
name|dent
operator|->
name|d_name
argument_list|)
expr_stmt|;
if|if
condition|(
name|os_strcmp
argument_list|(
name|addr
operator|.
name|sun_path
argument_list|,
name|drv
operator|->
name|own_socket_path
argument_list|)
operator|==
literal|0
condition|)
continue|continue;
if|if
condition|(
operator|!
name|broadcast
operator|&&
name|os_strstr
argument_list|(
name|dent
operator|->
name|d_name
argument_list|,
name|desttxt
argument_list|)
operator|==
name|NULL
condition|)
continue|continue;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"%s: Send management frame to %s"
argument_list|,
name|__func__
argument_list|,
name|dent
operator|->
name|d_name
argument_list|)
expr_stmt|;
name|msg
operator|.
name|msg_name
operator|=
operator|&
name|addr
expr_stmt|;
name|msg
operator|.
name|msg_namelen
operator|=
sizeof|sizeof
argument_list|(
name|addr
argument_list|)
expr_stmt|;
name|ret
operator|=
name|sendmsg
argument_list|(
name|drv
operator|->
name|test_socket
argument_list|,
operator|&
name|msg
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|<
literal|0
condition|)
name|perror
argument_list|(
literal|"driver_test: sendmsg(test_socket)"
argument_list|)
expr_stmt|;
block|}
name|closedir
argument_list|(
name|dir
argument_list|)
expr_stmt|;
else|#
directive|else
comment|/* HOSTAPD */
if|if
condition|(
name|os_memcmp
argument_list|(
name|dest
argument_list|,
name|dbss
operator|->
name|bssid
argument_list|,
name|ETH_ALEN
argument_list|)
operator|==
literal|0
operator|||
name|drv
operator|->
name|test_dir
operator|==
name|NULL
condition|)
block|{
if|if
condition|(
name|drv
operator|->
name|hostapd_addr_udp_set
condition|)
block|{
name|msg
operator|.
name|msg_name
operator|=
operator|&
name|drv
operator|->
name|hostapd_addr_udp
expr_stmt|;
name|msg
operator|.
name|msg_namelen
operator|=
sizeof|sizeof
argument_list|(
name|drv
operator|->
name|hostapd_addr_udp
argument_list|)
expr_stmt|;
block|}
else|else
block|{
ifdef|#
directive|ifdef
name|DRIVER_TEST_UNIX
name|msg
operator|.
name|msg_name
operator|=
operator|&
name|drv
operator|->
name|hostapd_addr
expr_stmt|;
name|msg
operator|.
name|msg_namelen
operator|=
sizeof|sizeof
argument_list|(
name|drv
operator|->
name|hostapd_addr
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* DRIVER_TEST_UNIX */
block|}
block|}
elseif|else
if|if
condition|(
name|broadcast
condition|)
block|{
name|dir
operator|=
name|opendir
argument_list|(
name|drv
operator|->
name|test_dir
argument_list|)
expr_stmt|;
if|if
condition|(
name|dir
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
while|while
condition|(
operator|(
name|dent
operator|=
name|readdir
argument_list|(
name|dir
argument_list|)
operator|)
condition|)
block|{
ifdef|#
directive|ifdef
name|_DIRENT_HAVE_D_TYPE
comment|/* Skip the file if it is not a socket. 			 * Also accept DT_UNKNOWN (0) in case 			 * the C library or underlying file 			 * system does not support d_type. */
if|if
condition|(
name|dent
operator|->
name|d_type
operator|!=
name|DT_SOCK
operator|&&
name|dent
operator|->
name|d_type
operator|!=
name|DT_UNKNOWN
condition|)
continue|continue;
endif|#
directive|endif
comment|/* _DIRENT_HAVE_D_TYPE */
if|if
condition|(
name|os_strcmp
argument_list|(
name|dent
operator|->
name|d_name
argument_list|,
literal|"."
argument_list|)
operator|==
literal|0
operator|||
name|os_strcmp
argument_list|(
name|dent
operator|->
name|d_name
argument_list|,
literal|".."
argument_list|)
operator|==
literal|0
condition|)
continue|continue;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"%s: Send broadcast MLME to %s"
argument_list|,
name|__func__
argument_list|,
name|dent
operator|->
name|d_name
argument_list|)
expr_stmt|;
name|os_memset
argument_list|(
operator|&
name|addr
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|addr
argument_list|)
argument_list|)
expr_stmt|;
name|addr
operator|.
name|sun_family
operator|=
name|AF_UNIX
expr_stmt|;
name|os_snprintf
argument_list|(
name|addr
operator|.
name|sun_path
argument_list|,
sizeof|sizeof
argument_list|(
name|addr
operator|.
name|sun_path
argument_list|)
argument_list|,
literal|"%s/%s"
argument_list|,
name|drv
operator|->
name|test_dir
argument_list|,
name|dent
operator|->
name|d_name
argument_list|)
expr_stmt|;
name|msg
operator|.
name|msg_name
operator|=
operator|&
name|addr
expr_stmt|;
name|msg
operator|.
name|msg_namelen
operator|=
sizeof|sizeof
argument_list|(
name|addr
argument_list|)
expr_stmt|;
name|ret
operator|=
name|sendmsg
argument_list|(
name|drv
operator|->
name|test_socket
argument_list|,
operator|&
name|msg
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|<
literal|0
condition|)
name|perror
argument_list|(
literal|"driver_test: sendmsg(test_socket)"
argument_list|)
expr_stmt|;
block|}
name|closedir
argument_list|(
name|dir
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
else|else
block|{
name|struct
name|stat
name|st
decl_stmt|;
name|os_memset
argument_list|(
operator|&
name|addr
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|addr
argument_list|)
argument_list|)
expr_stmt|;
name|addr
operator|.
name|sun_family
operator|=
name|AF_UNIX
expr_stmt|;
name|os_snprintf
argument_list|(
name|addr
operator|.
name|sun_path
argument_list|,
sizeof|sizeof
argument_list|(
name|addr
operator|.
name|sun_path
argument_list|)
argument_list|,
literal|"%s/AP-"
name|MACSTR
argument_list|,
name|drv
operator|->
name|test_dir
argument_list|,
name|MAC2STR
argument_list|(
name|dest
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|stat
argument_list|(
name|addr
operator|.
name|sun_path
argument_list|,
operator|&
name|st
argument_list|)
operator|<
literal|0
condition|)
block|{
name|os_snprintf
argument_list|(
name|addr
operator|.
name|sun_path
argument_list|,
sizeof|sizeof
argument_list|(
name|addr
operator|.
name|sun_path
argument_list|)
argument_list|,
literal|"%s/STA-"
name|MACSTR
argument_list|,
name|drv
operator|->
name|test_dir
argument_list|,
name|MAC2STR
argument_list|(
name|dest
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|msg
operator|.
name|msg_name
operator|=
operator|&
name|addr
expr_stmt|;
name|msg
operator|.
name|msg_namelen
operator|=
sizeof|sizeof
argument_list|(
name|addr
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|sendmsg
argument_list|(
name|drv
operator|->
name|test_socket
argument_list|,
operator|&
name|msg
argument_list|,
literal|0
argument_list|)
operator|<
literal|0
condition|)
block|{
name|perror
argument_list|(
literal|"sendmsg(test_socket)"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
endif|#
directive|endif
comment|/* HOSTAPD */
name|hdr
operator|=
operator|(
expr|struct
name|ieee80211_hdr
operator|*
operator|)
name|data
expr_stmt|;
name|fc
operator|=
name|le_to_host16
argument_list|(
name|hdr
operator|->
name|frame_control
argument_list|)
expr_stmt|;
name|os_memset
argument_list|(
operator|&
name|event
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|event
argument_list|)
argument_list|)
expr_stmt|;
name|event
operator|.
name|tx_status
operator|.
name|type
operator|=
name|WLAN_FC_GET_TYPE
argument_list|(
name|fc
argument_list|)
expr_stmt|;
name|event
operator|.
name|tx_status
operator|.
name|stype
operator|=
name|WLAN_FC_GET_STYPE
argument_list|(
name|fc
argument_list|)
expr_stmt|;
name|event
operator|.
name|tx_status
operator|.
name|dst
operator|=
name|hdr
operator|->
name|addr1
expr_stmt|;
name|event
operator|.
name|tx_status
operator|.
name|data
operator|=
name|data
expr_stmt|;
name|event
operator|.
name|tx_status
operator|.
name|data_len
operator|=
name|data_len
expr_stmt|;
name|event
operator|.
name|tx_status
operator|.
name|ack
operator|=
name|ret
operator|>=
literal|0
expr_stmt|;
name|wpa_supplicant_event
argument_list|(
name|drv
operator|->
name|ctx
argument_list|,
name|EVENT_TX_STATUS
argument_list|,
operator|&
name|event
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|test_driver_scan
parameter_list|(
name|struct
name|wpa_driver_test_data
modifier|*
name|drv
parameter_list|,
name|struct
name|sockaddr_un
modifier|*
name|from
parameter_list|,
name|socklen_t
name|fromlen
parameter_list|,
name|char
modifier|*
name|data
parameter_list|)
block|{
name|char
name|buf
index|[
literal|512
index|]
decl_stmt|,
modifier|*
name|pos
decl_stmt|,
modifier|*
name|end
decl_stmt|;
name|int
name|ret
decl_stmt|;
name|struct
name|test_driver_bss
modifier|*
name|bss
decl_stmt|;
name|u8
name|sa
index|[
name|ETH_ALEN
index|]
decl_stmt|;
name|u8
name|ie
index|[
literal|512
index|]
decl_stmt|;
name|size_t
name|ielen
decl_stmt|;
name|union
name|wpa_event_data
name|event
decl_stmt|;
comment|/* data: optional [ ' ' | STA-addr | ' ' | IEs(hex) ] */
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"test_driver: SCAN"
argument_list|)
expr_stmt|;
if|if
condition|(
operator|*
name|data
condition|)
block|{
if|if
condition|(
operator|*
name|data
operator|!=
literal|' '
operator|||
name|hwaddr_aton
argument_list|(
name|data
operator|+
literal|1
argument_list|,
name|sa
argument_list|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"test_driver: Unexpected SCAN "
literal|"command format"
argument_list|)
expr_stmt|;
return|return;
block|}
name|data
operator|+=
literal|18
expr_stmt|;
while|while
condition|(
operator|*
name|data
operator|==
literal|' '
condition|)
name|data
operator|++
expr_stmt|;
name|ielen
operator|=
name|os_strlen
argument_list|(
name|data
argument_list|)
operator|/
literal|2
expr_stmt|;
if|if
condition|(
name|ielen
operator|>
sizeof|sizeof
argument_list|(
name|ie
argument_list|)
condition|)
name|ielen
operator|=
sizeof|sizeof
argument_list|(
name|ie
argument_list|)
expr_stmt|;
if|if
condition|(
name|hexstr2bin
argument_list|(
name|data
argument_list|,
name|ie
argument_list|,
name|ielen
argument_list|)
operator|<
literal|0
condition|)
name|ielen
operator|=
literal|0
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"test_driver: Scan from "
name|MACSTR
argument_list|,
name|MAC2STR
argument_list|(
name|sa
argument_list|)
argument_list|)
expr_stmt|;
name|wpa_hexdump
argument_list|(
name|MSG_MSGDUMP
argument_list|,
literal|"test_driver: scan IEs"
argument_list|,
name|ie
argument_list|,
name|ielen
argument_list|)
expr_stmt|;
name|os_memset
argument_list|(
operator|&
name|event
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|event
argument_list|)
argument_list|)
expr_stmt|;
name|event
operator|.
name|rx_probe_req
operator|.
name|sa
operator|=
name|sa
expr_stmt|;
name|event
operator|.
name|rx_probe_req
operator|.
name|ie
operator|=
name|ie
expr_stmt|;
name|event
operator|.
name|rx_probe_req
operator|.
name|ie_len
operator|=
name|ielen
expr_stmt|;
name|wpa_supplicant_event
argument_list|(
name|drv
operator|->
name|ctx
argument_list|,
name|EVENT_RX_PROBE_REQ
argument_list|,
operator|&
name|event
argument_list|)
expr_stmt|;
block|}
name|dl_list_for_each
argument_list|(
argument|bss
argument_list|,
argument|&drv->bss
argument_list|,
argument|struct test_driver_bss
argument_list|,
argument|list
argument_list|)
block|{
name|pos
operator|=
name|buf
expr_stmt|;
name|end
operator|=
name|buf
operator|+
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
expr_stmt|;
comment|/* reply: SCANRESP BSSID SSID IEs */
name|ret
operator|=
name|snprintf
argument_list|(
name|pos
argument_list|,
name|end
operator|-
name|pos
argument_list|,
literal|"SCANRESP "
name|MACSTR
literal|" "
argument_list|,
name|MAC2STR
argument_list|(
name|bss
operator|->
name|bssid
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|<
literal|0
operator|||
name|ret
operator|>=
name|end
operator|-
name|pos
condition|)
return|return;
name|pos
operator|+=
name|ret
expr_stmt|;
name|pos
operator|+=
name|wpa_snprintf_hex
argument_list|(
name|pos
argument_list|,
name|end
operator|-
name|pos
argument_list|,
name|bss
operator|->
name|ssid
argument_list|,
name|bss
operator|->
name|ssid_len
argument_list|)
expr_stmt|;
name|ret
operator|=
name|snprintf
argument_list|(
name|pos
argument_list|,
name|end
operator|-
name|pos
argument_list|,
literal|" "
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|<
literal|0
operator|||
name|ret
operator|>=
name|end
operator|-
name|pos
condition|)
return|return;
name|pos
operator|+=
name|ret
expr_stmt|;
name|pos
operator|+=
name|wpa_snprintf_hex
argument_list|(
name|pos
argument_list|,
name|end
operator|-
name|pos
argument_list|,
name|bss
operator|->
name|ie
argument_list|,
name|bss
operator|->
name|ielen
argument_list|)
expr_stmt|;
name|pos
operator|+=
name|wpa_snprintf_hex
argument_list|(
name|pos
argument_list|,
name|end
operator|-
name|pos
argument_list|,
name|bss
operator|->
name|wps_probe_resp_ie
argument_list|,
name|bss
operator|->
name|wps_probe_resp_ie_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|bss
operator|->
name|privacy
condition|)
block|{
name|ret
operator|=
name|snprintf
argument_list|(
name|pos
argument_list|,
name|end
operator|-
name|pos
argument_list|,
literal|" PRIVACY"
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|<
literal|0
operator|||
name|ret
operator|>=
name|end
operator|-
name|pos
condition|)
return|return;
name|pos
operator|+=
name|ret
expr_stmt|;
block|}
name|sendto
argument_list|(
name|drv
operator|->
name|test_socket
argument_list|,
name|buf
argument_list|,
name|pos
operator|-
name|buf
argument_list|,
literal|0
argument_list|,
operator|(
expr|struct
name|sockaddr
operator|*
operator|)
name|from
argument_list|,
name|fromlen
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|test_driver_assoc
parameter_list|(
name|struct
name|wpa_driver_test_data
modifier|*
name|drv
parameter_list|,
name|struct
name|sockaddr_un
modifier|*
name|from
parameter_list|,
name|socklen_t
name|fromlen
parameter_list|,
name|char
modifier|*
name|data
parameter_list|)
block|{
name|struct
name|test_client_socket
modifier|*
name|cli
decl_stmt|;
name|u8
name|ie
index|[
literal|256
index|]
decl_stmt|,
name|ssid
index|[
literal|32
index|]
decl_stmt|;
name|size_t
name|ielen
decl_stmt|,
name|ssid_len
init|=
literal|0
decl_stmt|;
name|char
modifier|*
name|pos
decl_stmt|,
modifier|*
name|pos2
decl_stmt|,
name|cmd
index|[
literal|50
index|]
decl_stmt|;
name|struct
name|test_driver_bss
modifier|*
name|bss
decl_stmt|,
modifier|*
name|tmp
decl_stmt|;
comment|/* data: STA-addr SSID(hex) IEs(hex) */
name|cli
operator|=
name|os_zalloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|cli
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|cli
operator|==
name|NULL
condition|)
return|return;
if|if
condition|(
name|hwaddr_aton
argument_list|(
name|data
argument_list|,
name|cli
operator|->
name|addr
argument_list|)
condition|)
block|{
name|printf
argument_list|(
literal|"test_socket: Invalid MAC address '%s' in ASSOC\n"
argument_list|,
name|data
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|cli
argument_list|)
expr_stmt|;
return|return;
block|}
name|pos
operator|=
name|data
operator|+
literal|17
expr_stmt|;
while|while
condition|(
operator|*
name|pos
operator|==
literal|' '
condition|)
name|pos
operator|++
expr_stmt|;
name|pos2
operator|=
name|strchr
argument_list|(
name|pos
argument_list|,
literal|' '
argument_list|)
expr_stmt|;
name|ielen
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|pos2
condition|)
block|{
name|ssid_len
operator|=
operator|(
name|pos2
operator|-
name|pos
operator|)
operator|/
literal|2
expr_stmt|;
if|if
condition|(
name|hexstr2bin
argument_list|(
name|pos
argument_list|,
name|ssid
argument_list|,
name|ssid_len
argument_list|)
operator|<
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"%s: Invalid SSID"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|cli
argument_list|)
expr_stmt|;
return|return;
block|}
name|wpa_hexdump_ascii
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"test_driver_assoc: SSID"
argument_list|,
name|ssid
argument_list|,
name|ssid_len
argument_list|)
expr_stmt|;
name|pos
operator|=
name|pos2
operator|+
literal|1
expr_stmt|;
name|ielen
operator|=
name|strlen
argument_list|(
name|pos
argument_list|)
operator|/
literal|2
expr_stmt|;
if|if
condition|(
name|ielen
operator|>
sizeof|sizeof
argument_list|(
name|ie
argument_list|)
condition|)
name|ielen
operator|=
sizeof|sizeof
argument_list|(
name|ie
argument_list|)
expr_stmt|;
if|if
condition|(
name|hexstr2bin
argument_list|(
name|pos
argument_list|,
name|ie
argument_list|,
name|ielen
argument_list|)
operator|<
literal|0
condition|)
name|ielen
operator|=
literal|0
expr_stmt|;
block|}
name|bss
operator|=
name|NULL
expr_stmt|;
name|dl_list_for_each
argument_list|(
argument|tmp
argument_list|,
argument|&drv->bss
argument_list|,
argument|struct test_driver_bss
argument_list|,
argument|list
argument_list|)
block|{
if|if
condition|(
name|tmp
operator|->
name|ssid_len
operator|==
name|ssid_len
operator|&&
name|os_memcmp
argument_list|(
name|tmp
operator|->
name|ssid
argument_list|,
name|ssid
argument_list|,
name|ssid_len
argument_list|)
operator|==
literal|0
condition|)
block|{
name|bss
operator|=
name|tmp
expr_stmt|;
break|break;
block|}
block|}
if|if
condition|(
name|bss
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"%s: No matching SSID found from "
literal|"configured BSSes"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|cli
argument_list|)
expr_stmt|;
return|return;
block|}
name|cli
operator|->
name|bss
operator|=
name|bss
expr_stmt|;
name|memcpy
argument_list|(
operator|&
name|cli
operator|->
name|un
argument_list|,
name|from
argument_list|,
sizeof|sizeof
argument_list|(
name|cli
operator|->
name|un
argument_list|)
argument_list|)
expr_stmt|;
name|cli
operator|->
name|unlen
operator|=
name|fromlen
expr_stmt|;
name|cli
operator|->
name|next
operator|=
name|drv
operator|->
name|cli
expr_stmt|;
name|drv
operator|->
name|cli
operator|=
name|cli
expr_stmt|;
name|wpa_hexdump_ascii
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"test_socket: ASSOC sun_path"
argument_list|,
operator|(
specifier|const
name|u8
operator|*
operator|)
name|cli
operator|->
name|un
operator|.
name|sun_path
argument_list|,
name|cli
operator|->
name|unlen
operator|-
sizeof|sizeof
argument_list|(
name|cli
operator|->
name|un
operator|.
name|sun_family
argument_list|)
argument_list|)
expr_stmt|;
name|snprintf
argument_list|(
name|cmd
argument_list|,
sizeof|sizeof
argument_list|(
name|cmd
argument_list|)
argument_list|,
literal|"ASSOCRESP "
name|MACSTR
literal|" 0"
argument_list|,
name|MAC2STR
argument_list|(
name|bss
operator|->
name|bssid
argument_list|)
argument_list|)
expr_stmt|;
name|sendto
argument_list|(
name|drv
operator|->
name|test_socket
argument_list|,
name|cmd
argument_list|,
name|strlen
argument_list|(
name|cmd
argument_list|)
argument_list|,
literal|0
argument_list|,
operator|(
expr|struct
name|sockaddr
operator|*
operator|)
name|from
argument_list|,
name|fromlen
argument_list|)
expr_stmt|;
name|drv_event_assoc
argument_list|(
name|bss
operator|->
name|bss_ctx
argument_list|,
name|cli
operator|->
name|addr
argument_list|,
name|ie
argument_list|,
name|ielen
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|test_driver_disassoc
parameter_list|(
name|struct
name|wpa_driver_test_data
modifier|*
name|drv
parameter_list|,
name|struct
name|sockaddr_un
modifier|*
name|from
parameter_list|,
name|socklen_t
name|fromlen
parameter_list|)
block|{
name|struct
name|test_client_socket
modifier|*
name|cli
decl_stmt|;
name|cli
operator|=
name|test_driver_get_cli
argument_list|(
name|drv
argument_list|,
name|from
argument_list|,
name|fromlen
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|cli
condition|)
return|return;
name|drv_event_disassoc
argument_list|(
name|drv
operator|->
name|ctx
argument_list|,
name|cli
operator|->
name|addr
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|test_driver_eapol
parameter_list|(
name|struct
name|wpa_driver_test_data
modifier|*
name|drv
parameter_list|,
name|struct
name|sockaddr_un
modifier|*
name|from
parameter_list|,
name|socklen_t
name|fromlen
parameter_list|,
name|u8
modifier|*
name|data
parameter_list|,
name|size_t
name|datalen
parameter_list|)
block|{
ifdef|#
directive|ifdef
name|HOSTAPD
name|struct
name|test_client_socket
modifier|*
name|cli
decl_stmt|;
endif|#
directive|endif
comment|/* HOSTAPD */
specifier|const
name|u8
modifier|*
name|src
init|=
name|NULL
decl_stmt|;
if|if
condition|(
name|datalen
operator|>
literal|14
condition|)
block|{
comment|/* Skip Ethernet header */
name|src
operator|=
name|data
operator|+
name|ETH_ALEN
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"test_driver: dst="
name|MACSTR
literal|" src="
name|MACSTR
literal|" proto=%04x"
argument_list|,
name|MAC2STR
argument_list|(
name|data
argument_list|)
argument_list|,
name|MAC2STR
argument_list|(
name|src
argument_list|)
argument_list|,
name|WPA_GET_BE16
argument_list|(
name|data
operator|+
literal|2
operator|*
name|ETH_ALEN
argument_list|)
argument_list|)
expr_stmt|;
name|data
operator|+=
literal|14
expr_stmt|;
name|datalen
operator|-=
literal|14
expr_stmt|;
block|}
ifdef|#
directive|ifdef
name|HOSTAPD
name|cli
operator|=
name|test_driver_get_cli
argument_list|(
name|drv
argument_list|,
name|from
argument_list|,
name|fromlen
argument_list|)
expr_stmt|;
if|if
condition|(
name|cli
condition|)
block|{
name|drv_event_eapol_rx
argument_list|(
name|cli
operator|->
name|bss
operator|->
name|bss_ctx
argument_list|,
name|cli
operator|->
name|addr
argument_list|,
name|data
argument_list|,
name|datalen
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"test_socket: EAPOL from unknown "
literal|"client"
argument_list|)
expr_stmt|;
block|}
else|#
directive|else
comment|/* HOSTAPD */
if|if
condition|(
name|src
condition|)
name|drv_event_eapol_rx
argument_list|(
name|drv
operator|->
name|ctx
argument_list|,
name|src
argument_list|,
name|data
argument_list|,
name|datalen
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* HOSTAPD */
block|}
end_function

begin_function
specifier|static
name|void
name|test_driver_ether
parameter_list|(
name|struct
name|wpa_driver_test_data
modifier|*
name|drv
parameter_list|,
name|struct
name|sockaddr_un
modifier|*
name|from
parameter_list|,
name|socklen_t
name|fromlen
parameter_list|,
name|u8
modifier|*
name|data
parameter_list|,
name|size_t
name|datalen
parameter_list|)
block|{
name|struct
name|l2_ethhdr
modifier|*
name|eth
decl_stmt|;
if|if
condition|(
name|datalen
operator|<
sizeof|sizeof
argument_list|(
operator|*
name|eth
argument_list|)
condition|)
return|return;
name|eth
operator|=
operator|(
expr|struct
name|l2_ethhdr
operator|*
operator|)
name|data
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"test_driver: RX ETHER dst="
name|MACSTR
literal|" src="
name|MACSTR
literal|" proto=%04x"
argument_list|,
name|MAC2STR
argument_list|(
name|eth
operator|->
name|h_dest
argument_list|)
argument_list|,
name|MAC2STR
argument_list|(
name|eth
operator|->
name|h_source
argument_list|)
argument_list|,
name|be_to_host16
argument_list|(
name|eth
operator|->
name|h_proto
argument_list|)
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|CONFIG_IEEE80211R
if|if
condition|(
name|be_to_host16
argument_list|(
name|eth
operator|->
name|h_proto
argument_list|)
operator|==
name|ETH_P_RRB
condition|)
block|{
name|union
name|wpa_event_data
name|ev
decl_stmt|;
name|os_memset
argument_list|(
operator|&
name|ev
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|ev
argument_list|)
argument_list|)
expr_stmt|;
name|ev
operator|.
name|ft_rrb_rx
operator|.
name|src
operator|=
name|eth
operator|->
name|h_source
expr_stmt|;
name|ev
operator|.
name|ft_rrb_rx
operator|.
name|data
operator|=
name|data
operator|+
sizeof|sizeof
argument_list|(
operator|*
name|eth
argument_list|)
expr_stmt|;
name|ev
operator|.
name|ft_rrb_rx
operator|.
name|data_len
operator|=
name|datalen
operator|-
sizeof|sizeof
argument_list|(
operator|*
name|eth
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
comment|/* CONFIG_IEEE80211R */
block|}
end_function

begin_function
specifier|static
name|void
name|test_driver_mlme
parameter_list|(
name|struct
name|wpa_driver_test_data
modifier|*
name|drv
parameter_list|,
name|struct
name|sockaddr_un
modifier|*
name|from
parameter_list|,
name|socklen_t
name|fromlen
parameter_list|,
name|u8
modifier|*
name|data
parameter_list|,
name|size_t
name|datalen
parameter_list|)
block|{
name|struct
name|ieee80211_hdr
modifier|*
name|hdr
decl_stmt|;
name|u16
name|fc
decl_stmt|;
name|union
name|wpa_event_data
name|event
decl_stmt|;
name|int
name|freq
init|=
literal|0
decl_stmt|,
name|own_freq
decl_stmt|;
name|struct
name|test_driver_bss
modifier|*
name|bss
decl_stmt|;
name|bss
operator|=
name|dl_list_first
argument_list|(
operator|&
name|drv
operator|->
name|bss
argument_list|,
expr|struct
name|test_driver_bss
argument_list|,
name|list
argument_list|)
expr_stmt|;
if|if
condition|(
name|datalen
operator|>
literal|6
operator|&&
name|os_memcmp
argument_list|(
name|data
argument_list|,
literal|"freq="
argument_list|,
literal|5
argument_list|)
operator|==
literal|0
condition|)
block|{
name|size_t
name|pos
decl_stmt|;
for|for
control|(
name|pos
operator|=
literal|5
init|;
name|pos
operator|<
name|datalen
condition|;
name|pos
operator|++
control|)
block|{
if|if
condition|(
name|data
index|[
name|pos
index|]
operator|==
literal|' '
condition|)
break|break;
block|}
if|if
condition|(
name|pos
operator|<
name|datalen
condition|)
block|{
name|freq
operator|=
name|atoi
argument_list|(
operator|(
specifier|const
name|char
operator|*
operator|)
operator|&
name|data
index|[
literal|5
index|]
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"test_driver(%s): MLME RX on "
literal|"freq %d MHz"
argument_list|,
name|bss
operator|->
name|ifname
argument_list|,
name|freq
argument_list|)
expr_stmt|;
name|pos
operator|++
expr_stmt|;
name|data
operator|+=
name|pos
expr_stmt|;
name|datalen
operator|-=
name|pos
expr_stmt|;
block|}
block|}
if|if
condition|(
name|drv
operator|->
name|remain_on_channel_freq
condition|)
name|own_freq
operator|=
name|drv
operator|->
name|remain_on_channel_freq
expr_stmt|;
else|else
name|own_freq
operator|=
name|drv
operator|->
name|current_freq
expr_stmt|;
if|if
condition|(
name|freq
operator|&&
name|own_freq
operator|&&
name|freq
operator|!=
name|own_freq
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"test_driver(%s): Ignore MLME RX on "
literal|"another frequency %d MHz (own %d MHz)"
argument_list|,
name|bss
operator|->
name|ifname
argument_list|,
name|freq
argument_list|,
name|own_freq
argument_list|)
expr_stmt|;
return|return;
block|}
name|hdr
operator|=
operator|(
expr|struct
name|ieee80211_hdr
operator|*
operator|)
name|data
expr_stmt|;
if|if
condition|(
name|test_driver_get_cli
argument_list|(
name|drv
argument_list|,
name|from
argument_list|,
name|fromlen
argument_list|)
operator|==
name|NULL
operator|&&
name|datalen
operator|>=
literal|16
condition|)
block|{
name|struct
name|test_client_socket
modifier|*
name|cli
decl_stmt|;
name|cli
operator|=
name|os_zalloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|cli
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|cli
operator|==
name|NULL
condition|)
return|return;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"Adding client entry for "
name|MACSTR
argument_list|,
name|MAC2STR
argument_list|(
name|hdr
operator|->
name|addr2
argument_list|)
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
name|cli
operator|->
name|addr
argument_list|,
name|hdr
operator|->
name|addr2
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
operator|&
name|cli
operator|->
name|un
argument_list|,
name|from
argument_list|,
sizeof|sizeof
argument_list|(
name|cli
operator|->
name|un
argument_list|)
argument_list|)
expr_stmt|;
name|cli
operator|->
name|unlen
operator|=
name|fromlen
expr_stmt|;
name|cli
operator|->
name|next
operator|=
name|drv
operator|->
name|cli
expr_stmt|;
name|drv
operator|->
name|cli
operator|=
name|cli
expr_stmt|;
block|}
name|wpa_hexdump
argument_list|(
name|MSG_MSGDUMP
argument_list|,
literal|"test_driver_mlme: received frame"
argument_list|,
name|data
argument_list|,
name|datalen
argument_list|)
expr_stmt|;
name|fc
operator|=
name|le_to_host16
argument_list|(
name|hdr
operator|->
name|frame_control
argument_list|)
expr_stmt|;
if|if
condition|(
name|WLAN_FC_GET_TYPE
argument_list|(
name|fc
argument_list|)
operator|!=
name|WLAN_FC_TYPE_MGMT
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"%s: received non-mgmt frame"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
return|return;
block|}
name|os_memset
argument_list|(
operator|&
name|event
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|event
argument_list|)
argument_list|)
expr_stmt|;
name|event
operator|.
name|rx_mgmt
operator|.
name|frame
operator|=
name|data
expr_stmt|;
name|event
operator|.
name|rx_mgmt
operator|.
name|frame_len
operator|=
name|datalen
expr_stmt|;
name|wpa_supplicant_event
argument_list|(
name|drv
operator|->
name|ctx
argument_list|,
name|EVENT_RX_MGMT
argument_list|,
operator|&
name|event
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|test_driver_receive_unix
parameter_list|(
name|int
name|sock
parameter_list|,
name|void
modifier|*
name|eloop_ctx
parameter_list|,
name|void
modifier|*
name|sock_ctx
parameter_list|)
block|{
name|struct
name|wpa_driver_test_data
modifier|*
name|drv
init|=
name|eloop_ctx
decl_stmt|;
name|char
name|buf
index|[
literal|2000
index|]
decl_stmt|;
name|int
name|res
decl_stmt|;
name|struct
name|sockaddr_un
name|from
decl_stmt|;
name|socklen_t
name|fromlen
init|=
sizeof|sizeof
argument_list|(
name|from
argument_list|)
decl_stmt|;
name|res
operator|=
name|recvfrom
argument_list|(
name|sock
argument_list|,
name|buf
argument_list|,
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
operator|-
literal|1
argument_list|,
literal|0
argument_list|,
operator|(
expr|struct
name|sockaddr
operator|*
operator|)
operator|&
name|from
argument_list|,
operator|&
name|fromlen
argument_list|)
expr_stmt|;
if|if
condition|(
name|res
operator|<
literal|0
condition|)
block|{
name|perror
argument_list|(
literal|"recvfrom(test_socket)"
argument_list|)
expr_stmt|;
return|return;
block|}
name|buf
index|[
name|res
index|]
operator|=
literal|'\0'
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"test_driver: received %u bytes"
argument_list|,
name|res
argument_list|)
expr_stmt|;
if|if
condition|(
name|strncmp
argument_list|(
name|buf
argument_list|,
literal|"SCAN"
argument_list|,
literal|4
argument_list|)
operator|==
literal|0
condition|)
block|{
name|test_driver_scan
argument_list|(
name|drv
argument_list|,
operator|&
name|from
argument_list|,
name|fromlen
argument_list|,
name|buf
operator|+
literal|4
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strncmp
argument_list|(
name|buf
argument_list|,
literal|"ASSOC "
argument_list|,
literal|6
argument_list|)
operator|==
literal|0
condition|)
block|{
name|test_driver_assoc
argument_list|(
name|drv
argument_list|,
operator|&
name|from
argument_list|,
name|fromlen
argument_list|,
name|buf
operator|+
literal|6
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|buf
argument_list|,
literal|"DISASSOC"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|test_driver_disassoc
argument_list|(
name|drv
argument_list|,
operator|&
name|from
argument_list|,
name|fromlen
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strncmp
argument_list|(
name|buf
argument_list|,
literal|"EAPOL "
argument_list|,
literal|6
argument_list|)
operator|==
literal|0
condition|)
block|{
name|test_driver_eapol
argument_list|(
name|drv
argument_list|,
operator|&
name|from
argument_list|,
name|fromlen
argument_list|,
operator|(
name|u8
operator|*
operator|)
name|buf
operator|+
literal|6
argument_list|,
name|res
operator|-
literal|6
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strncmp
argument_list|(
name|buf
argument_list|,
literal|"ETHER "
argument_list|,
literal|6
argument_list|)
operator|==
literal|0
condition|)
block|{
name|test_driver_ether
argument_list|(
name|drv
argument_list|,
operator|&
name|from
argument_list|,
name|fromlen
argument_list|,
operator|(
name|u8
operator|*
operator|)
name|buf
operator|+
literal|6
argument_list|,
name|res
operator|-
literal|6
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strncmp
argument_list|(
name|buf
argument_list|,
literal|"MLME "
argument_list|,
literal|5
argument_list|)
operator|==
literal|0
condition|)
block|{
name|test_driver_mlme
argument_list|(
name|drv
argument_list|,
operator|&
name|from
argument_list|,
name|fromlen
argument_list|,
operator|(
name|u8
operator|*
operator|)
name|buf
operator|+
literal|5
argument_list|,
name|res
operator|-
literal|5
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|wpa_hexdump_ascii
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"Unknown test_socket command"
argument_list|,
operator|(
name|u8
operator|*
operator|)
name|buf
argument_list|,
name|res
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|int
name|test_driver_set_generic_elem
parameter_list|(
name|void
modifier|*
name|priv
parameter_list|,
specifier|const
name|u8
modifier|*
name|elem
parameter_list|,
name|size_t
name|elem_len
parameter_list|)
block|{
name|struct
name|test_driver_bss
modifier|*
name|bss
init|=
name|priv
decl_stmt|;
name|os_free
argument_list|(
name|bss
operator|->
name|ie
argument_list|)
expr_stmt|;
if|if
condition|(
name|elem
operator|==
name|NULL
condition|)
block|{
name|bss
operator|->
name|ie
operator|=
name|NULL
expr_stmt|;
name|bss
operator|->
name|ielen
operator|=
literal|0
expr_stmt|;
return|return
literal|0
return|;
block|}
name|bss
operator|->
name|ie
operator|=
name|os_malloc
argument_list|(
name|elem_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|bss
operator|->
name|ie
operator|==
name|NULL
condition|)
block|{
name|bss
operator|->
name|ielen
operator|=
literal|0
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|memcpy
argument_list|(
name|bss
operator|->
name|ie
argument_list|,
name|elem
argument_list|,
name|elem_len
argument_list|)
expr_stmt|;
name|bss
operator|->
name|ielen
operator|=
name|elem_len
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|test_driver_set_ap_wps_ie
parameter_list|(
name|void
modifier|*
name|priv
parameter_list|,
specifier|const
name|struct
name|wpabuf
modifier|*
name|beacon
parameter_list|,
specifier|const
name|struct
name|wpabuf
modifier|*
name|proberesp
parameter_list|)
block|{
name|struct
name|test_driver_bss
modifier|*
name|bss
init|=
name|priv
decl_stmt|;
if|if
condition|(
name|beacon
operator|==
name|NULL
condition|)
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"test_driver: Clear Beacon WPS IE"
argument_list|)
expr_stmt|;
else|else
name|wpa_hexdump_buf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"test_driver: Beacon WPS IE"
argument_list|,
name|beacon
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|bss
operator|->
name|wps_beacon_ie
argument_list|)
expr_stmt|;
if|if
condition|(
name|beacon
operator|==
name|NULL
condition|)
block|{
name|bss
operator|->
name|wps_beacon_ie
operator|=
name|NULL
expr_stmt|;
name|bss
operator|->
name|wps_beacon_ie_len
operator|=
literal|0
expr_stmt|;
block|}
else|else
block|{
name|bss
operator|->
name|wps_beacon_ie
operator|=
name|os_malloc
argument_list|(
name|wpabuf_len
argument_list|(
name|beacon
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|bss
operator|->
name|wps_beacon_ie
operator|==
name|NULL
condition|)
block|{
name|bss
operator|->
name|wps_beacon_ie_len
operator|=
literal|0
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|os_memcpy
argument_list|(
name|bss
operator|->
name|wps_beacon_ie
argument_list|,
name|wpabuf_head
argument_list|(
name|beacon
argument_list|)
argument_list|,
name|wpabuf_len
argument_list|(
name|beacon
argument_list|)
argument_list|)
expr_stmt|;
name|bss
operator|->
name|wps_beacon_ie_len
operator|=
name|wpabuf_len
argument_list|(
name|beacon
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|proberesp
operator|==
name|NULL
condition|)
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"test_driver: Clear Probe Response WPS "
literal|"IE"
argument_list|)
expr_stmt|;
else|else
name|wpa_hexdump_buf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"test_driver: Probe Response WPS "
literal|"IE"
argument_list|,
name|proberesp
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|bss
operator|->
name|wps_probe_resp_ie
argument_list|)
expr_stmt|;
if|if
condition|(
name|proberesp
operator|==
name|NULL
condition|)
block|{
name|bss
operator|->
name|wps_probe_resp_ie
operator|=
name|NULL
expr_stmt|;
name|bss
operator|->
name|wps_probe_resp_ie_len
operator|=
literal|0
expr_stmt|;
block|}
else|else
block|{
name|bss
operator|->
name|wps_probe_resp_ie
operator|=
name|os_malloc
argument_list|(
name|wpabuf_len
argument_list|(
name|proberesp
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|bss
operator|->
name|wps_probe_resp_ie
operator|==
name|NULL
condition|)
block|{
name|bss
operator|->
name|wps_probe_resp_ie_len
operator|=
literal|0
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|os_memcpy
argument_list|(
name|bss
operator|->
name|wps_probe_resp_ie
argument_list|,
name|wpabuf_head
argument_list|(
name|proberesp
argument_list|)
argument_list|,
name|wpabuf_len
argument_list|(
name|proberesp
argument_list|)
argument_list|)
expr_stmt|;
name|bss
operator|->
name|wps_probe_resp_ie_len
operator|=
name|wpabuf_len
argument_list|(
name|proberesp
argument_list|)
expr_stmt|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|test_driver_sta_deauth
parameter_list|(
name|void
modifier|*
name|priv
parameter_list|,
specifier|const
name|u8
modifier|*
name|own_addr
parameter_list|,
specifier|const
name|u8
modifier|*
name|addr
parameter_list|,
name|int
name|reason
parameter_list|)
block|{
name|struct
name|test_driver_bss
modifier|*
name|dbss
init|=
name|priv
decl_stmt|;
name|struct
name|wpa_driver_test_data
modifier|*
name|drv
init|=
name|dbss
operator|->
name|drv
decl_stmt|;
name|struct
name|test_client_socket
modifier|*
name|cli
decl_stmt|;
if|if
condition|(
name|drv
operator|->
name|test_socket
operator|<
literal|0
condition|)
return|return
operator|-
literal|1
return|;
name|cli
operator|=
name|drv
operator|->
name|cli
expr_stmt|;
while|while
condition|(
name|cli
condition|)
block|{
if|if
condition|(
name|memcmp
argument_list|(
name|cli
operator|->
name|addr
argument_list|,
name|addr
argument_list|,
name|ETH_ALEN
argument_list|)
operator|==
literal|0
condition|)
break|break;
name|cli
operator|=
name|cli
operator|->
name|next
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|cli
condition|)
return|return
operator|-
literal|1
return|;
return|return
name|sendto
argument_list|(
name|drv
operator|->
name|test_socket
argument_list|,
literal|"DEAUTH"
argument_list|,
literal|6
argument_list|,
literal|0
argument_list|,
operator|(
expr|struct
name|sockaddr
operator|*
operator|)
operator|&
name|cli
operator|->
name|un
argument_list|,
name|cli
operator|->
name|unlen
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|test_driver_sta_disassoc
parameter_list|(
name|void
modifier|*
name|priv
parameter_list|,
specifier|const
name|u8
modifier|*
name|own_addr
parameter_list|,
specifier|const
name|u8
modifier|*
name|addr
parameter_list|,
name|int
name|reason
parameter_list|)
block|{
name|struct
name|test_driver_bss
modifier|*
name|dbss
init|=
name|priv
decl_stmt|;
name|struct
name|wpa_driver_test_data
modifier|*
name|drv
init|=
name|dbss
operator|->
name|drv
decl_stmt|;
name|struct
name|test_client_socket
modifier|*
name|cli
decl_stmt|;
if|if
condition|(
name|drv
operator|->
name|test_socket
operator|<
literal|0
condition|)
return|return
operator|-
literal|1
return|;
name|cli
operator|=
name|drv
operator|->
name|cli
expr_stmt|;
while|while
condition|(
name|cli
condition|)
block|{
if|if
condition|(
name|memcmp
argument_list|(
name|cli
operator|->
name|addr
argument_list|,
name|addr
argument_list|,
name|ETH_ALEN
argument_list|)
operator|==
literal|0
condition|)
break|break;
name|cli
operator|=
name|cli
operator|->
name|next
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|cli
condition|)
return|return
operator|-
literal|1
return|;
return|return
name|sendto
argument_list|(
name|drv
operator|->
name|test_socket
argument_list|,
literal|"DISASSOC"
argument_list|,
literal|8
argument_list|,
literal|0
argument_list|,
operator|(
expr|struct
name|sockaddr
operator|*
operator|)
operator|&
name|cli
operator|->
name|un
argument_list|,
name|cli
operator|->
name|unlen
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|test_driver_bss_add
parameter_list|(
name|void
modifier|*
name|priv
parameter_list|,
specifier|const
name|char
modifier|*
name|ifname
parameter_list|,
specifier|const
name|u8
modifier|*
name|bssid
parameter_list|,
name|void
modifier|*
name|bss_ctx
parameter_list|,
name|void
modifier|*
modifier|*
name|drv_priv
parameter_list|)
block|{
name|struct
name|test_driver_bss
modifier|*
name|dbss
init|=
name|priv
decl_stmt|;
name|struct
name|wpa_driver_test_data
modifier|*
name|drv
init|=
name|dbss
operator|->
name|drv
decl_stmt|;
name|struct
name|test_driver_bss
modifier|*
name|bss
decl_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"%s(ifname=%s bssid="
name|MACSTR
literal|")"
argument_list|,
name|__func__
argument_list|,
name|ifname
argument_list|,
name|MAC2STR
argument_list|(
name|bssid
argument_list|)
argument_list|)
expr_stmt|;
name|bss
operator|=
name|os_zalloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|bss
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|bss
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
name|bss
operator|->
name|bss_ctx
operator|=
name|bss_ctx
expr_stmt|;
name|bss
operator|->
name|drv
operator|=
name|drv
expr_stmt|;
name|os_strlcpy
argument_list|(
name|bss
operator|->
name|ifname
argument_list|,
name|ifname
argument_list|,
name|IFNAMSIZ
argument_list|)
expr_stmt|;
name|os_memcpy
argument_list|(
name|bss
operator|->
name|bssid
argument_list|,
name|bssid
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
name|dl_list_add
argument_list|(
operator|&
name|drv
operator|->
name|bss
argument_list|,
operator|&
name|bss
operator|->
name|list
argument_list|)
expr_stmt|;
if|if
condition|(
name|drv
operator|->
name|global
condition|)
block|{
name|drv
operator|->
name|global
operator|->
name|bss_add_used
operator|=
literal|1
expr_stmt|;
name|os_memcpy
argument_list|(
name|drv
operator|->
name|global
operator|->
name|req_addr
argument_list|,
name|bssid
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|drv_priv
condition|)
operator|*
name|drv_priv
operator|=
name|bss
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|test_driver_bss_remove
parameter_list|(
name|void
modifier|*
name|priv
parameter_list|,
specifier|const
name|char
modifier|*
name|ifname
parameter_list|)
block|{
name|struct
name|test_driver_bss
modifier|*
name|dbss
init|=
name|priv
decl_stmt|;
name|struct
name|wpa_driver_test_data
modifier|*
name|drv
init|=
name|dbss
operator|->
name|drv
decl_stmt|;
name|struct
name|test_driver_bss
modifier|*
name|bss
decl_stmt|;
name|struct
name|test_client_socket
modifier|*
name|cli
decl_stmt|,
modifier|*
name|prev_c
decl_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"%s(ifname=%s)"
argument_list|,
name|__func__
argument_list|,
name|ifname
argument_list|)
expr_stmt|;
name|dl_list_for_each
argument_list|(
argument|bss
argument_list|,
argument|&drv->bss
argument_list|,
argument|struct test_driver_bss
argument_list|,
argument|list
argument_list|)
block|{
if|if
condition|(
name|strcmp
argument_list|(
name|bss
operator|->
name|ifname
argument_list|,
name|ifname
argument_list|)
operator|!=
literal|0
condition|)
continue|continue;
for|for
control|(
name|prev_c
operator|=
name|NULL
operator|,
name|cli
operator|=
name|drv
operator|->
name|cli
init|;
name|cli
condition|;
name|prev_c
operator|=
name|cli
operator|,
name|cli
operator|=
name|cli
operator|->
name|next
control|)
block|{
if|if
condition|(
name|cli
operator|->
name|bss
operator|!=
name|bss
condition|)
continue|continue;
if|if
condition|(
name|prev_c
condition|)
name|prev_c
operator|->
name|next
operator|=
name|cli
operator|->
name|next
expr_stmt|;
else|else
name|drv
operator|->
name|cli
operator|=
name|cli
operator|->
name|next
expr_stmt|;
name|os_free
argument_list|(
name|cli
argument_list|)
expr_stmt|;
break|break;
block|}
name|dl_list_del
argument_list|(
operator|&
name|bss
operator|->
name|list
argument_list|)
expr_stmt|;
name|test_driver_free_bss
argument_list|(
name|bss
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
return|return
operator|-
literal|1
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|test_driver_if_add
parameter_list|(
name|void
modifier|*
name|priv
parameter_list|,
name|enum
name|wpa_driver_if_type
name|type
parameter_list|,
specifier|const
name|char
modifier|*
name|ifname
parameter_list|,
specifier|const
name|u8
modifier|*
name|addr
parameter_list|,
name|void
modifier|*
name|bss_ctx
parameter_list|,
name|void
modifier|*
modifier|*
name|drv_priv
parameter_list|,
name|char
modifier|*
name|force_ifname
parameter_list|,
name|u8
modifier|*
name|if_addr
parameter_list|)
block|{
name|struct
name|test_driver_bss
modifier|*
name|dbss
init|=
name|priv
decl_stmt|;
name|struct
name|wpa_driver_test_data
modifier|*
name|drv
init|=
name|dbss
operator|->
name|drv
decl_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"%s(type=%d ifname=%s bss_ctx=%p)"
argument_list|,
name|__func__
argument_list|,
name|type
argument_list|,
name|ifname
argument_list|,
name|bss_ctx
argument_list|)
expr_stmt|;
if|if
condition|(
name|addr
condition|)
name|os_memcpy
argument_list|(
name|if_addr
argument_list|,
name|addr
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
else|else
block|{
name|drv
operator|->
name|alloc_iface_idx
operator|++
expr_stmt|;
name|if_addr
index|[
literal|0
index|]
operator|=
literal|0x02
expr_stmt|;
comment|/* locally administered */
name|sha1_prf
argument_list|(
name|drv
operator|->
name|own_addr
argument_list|,
name|ETH_ALEN
argument_list|,
literal|"hostapd test addr generation"
argument_list|,
operator|(
specifier|const
name|u8
operator|*
operator|)
operator|&
name|drv
operator|->
name|alloc_iface_idx
argument_list|,
sizeof|sizeof
argument_list|(
name|drv
operator|->
name|alloc_iface_idx
argument_list|)
argument_list|,
name|if_addr
operator|+
literal|1
argument_list|,
name|ETH_ALEN
operator|-
literal|1
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|type
operator|==
name|WPA_IF_AP_BSS
condition|)
return|return
name|test_driver_bss_add
argument_list|(
name|priv
argument_list|,
name|ifname
argument_list|,
name|if_addr
argument_list|,
name|bss_ctx
argument_list|,
name|drv_priv
argument_list|)
return|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|test_driver_if_remove
parameter_list|(
name|void
modifier|*
name|priv
parameter_list|,
name|enum
name|wpa_driver_if_type
name|type
parameter_list|,
specifier|const
name|char
modifier|*
name|ifname
parameter_list|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"%s(type=%d ifname=%s)"
argument_list|,
name|__func__
argument_list|,
name|type
argument_list|,
name|ifname
argument_list|)
expr_stmt|;
if|if
condition|(
name|type
operator|==
name|WPA_IF_AP_BSS
condition|)
return|return
name|test_driver_bss_remove
argument_list|(
name|priv
argument_list|,
name|ifname
argument_list|)
return|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|test_driver_valid_bss_mask
parameter_list|(
name|void
modifier|*
name|priv
parameter_list|,
specifier|const
name|u8
modifier|*
name|addr
parameter_list|,
specifier|const
name|u8
modifier|*
name|mask
parameter_list|)
block|{
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|test_driver_set_ssid
parameter_list|(
name|void
modifier|*
name|priv
parameter_list|,
specifier|const
name|u8
modifier|*
name|buf
parameter_list|,
name|int
name|len
parameter_list|)
block|{
name|struct
name|test_driver_bss
modifier|*
name|bss
init|=
name|priv
decl_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"%s(ifname=%s)"
argument_list|,
name|__func__
argument_list|,
name|bss
operator|->
name|ifname
argument_list|)
expr_stmt|;
name|wpa_hexdump_ascii
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"test_driver_set_ssid: SSID"
argument_list|,
name|buf
argument_list|,
name|len
argument_list|)
expr_stmt|;
if|if
condition|(
name|len
operator|<
literal|0
operator|||
operator|(
name|size_t
operator|)
name|len
operator|>
sizeof|sizeof
argument_list|(
name|bss
operator|->
name|ssid
argument_list|)
condition|)
return|return
operator|-
literal|1
return|;
name|os_memcpy
argument_list|(
name|bss
operator|->
name|ssid
argument_list|,
name|buf
argument_list|,
name|len
argument_list|)
expr_stmt|;
name|bss
operator|->
name|ssid_len
operator|=
name|len
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|test_driver_set_privacy
parameter_list|(
name|void
modifier|*
name|priv
parameter_list|,
name|int
name|enabled
parameter_list|)
block|{
name|struct
name|test_driver_bss
modifier|*
name|dbss
init|=
name|priv
decl_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"%s(enabled=%d)"
argument_list|,
name|__func__
argument_list|,
name|enabled
argument_list|)
expr_stmt|;
name|dbss
operator|->
name|privacy
operator|=
name|enabled
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|test_driver_set_sta_vlan
parameter_list|(
name|void
modifier|*
name|priv
parameter_list|,
specifier|const
name|u8
modifier|*
name|addr
parameter_list|,
specifier|const
name|char
modifier|*
name|ifname
parameter_list|,
name|int
name|vlan_id
parameter_list|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"%s(addr="
name|MACSTR
literal|" ifname=%s vlan_id=%d)"
argument_list|,
name|__func__
argument_list|,
name|MAC2STR
argument_list|(
name|addr
argument_list|)
argument_list|,
name|ifname
argument_list|,
name|vlan_id
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|test_driver_sta_add
parameter_list|(
name|void
modifier|*
name|priv
parameter_list|,
name|struct
name|hostapd_sta_add_params
modifier|*
name|params
parameter_list|)
block|{
name|struct
name|test_driver_bss
modifier|*
name|bss
init|=
name|priv
decl_stmt|;
name|struct
name|wpa_driver_test_data
modifier|*
name|drv
init|=
name|bss
operator|->
name|drv
decl_stmt|;
name|struct
name|test_client_socket
modifier|*
name|cli
decl_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"%s(ifname=%s addr="
name|MACSTR
literal|" aid=%d "
literal|"capability=0x%x listen_interval=%d)"
argument_list|,
name|__func__
argument_list|,
name|bss
operator|->
name|ifname
argument_list|,
name|MAC2STR
argument_list|(
name|params
operator|->
name|addr
argument_list|)
argument_list|,
name|params
operator|->
name|aid
argument_list|,
name|params
operator|->
name|capability
argument_list|,
name|params
operator|->
name|listen_interval
argument_list|)
expr_stmt|;
name|wpa_hexdump
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"test_driver_sta_add - supp_rates"
argument_list|,
name|params
operator|->
name|supp_rates
argument_list|,
name|params
operator|->
name|supp_rates_len
argument_list|)
expr_stmt|;
name|cli
operator|=
name|drv
operator|->
name|cli
expr_stmt|;
while|while
condition|(
name|cli
condition|)
block|{
if|if
condition|(
name|os_memcmp
argument_list|(
name|cli
operator|->
name|addr
argument_list|,
name|params
operator|->
name|addr
argument_list|,
name|ETH_ALEN
argument_list|)
operator|==
literal|0
condition|)
break|break;
name|cli
operator|=
name|cli
operator|->
name|next
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|cli
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"%s: no matching client entry"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|cli
operator|->
name|bss
operator|=
name|bss
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|struct
name|wpa_driver_test_data
modifier|*
name|test_alloc_data
parameter_list|(
name|void
modifier|*
name|ctx
parameter_list|,
specifier|const
name|char
modifier|*
name|ifname
parameter_list|)
block|{
name|struct
name|wpa_driver_test_data
modifier|*
name|drv
decl_stmt|;
name|struct
name|test_driver_bss
modifier|*
name|bss
decl_stmt|;
name|drv
operator|=
name|os_zalloc
argument_list|(
sizeof|sizeof
argument_list|(
expr|struct
name|wpa_driver_test_data
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|drv
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"Could not allocate memory for test "
literal|"driver data"
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|bss
operator|=
name|os_zalloc
argument_list|(
sizeof|sizeof
argument_list|(
expr|struct
name|test_driver_bss
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|bss
operator|==
name|NULL
condition|)
block|{
name|os_free
argument_list|(
name|drv
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|drv
operator|->
name|ctx
operator|=
name|ctx
expr_stmt|;
name|wpa_trace_add_ref
argument_list|(
name|drv
argument_list|,
name|ctx
argument_list|,
name|ctx
argument_list|)
expr_stmt|;
name|dl_list_init
argument_list|(
operator|&
name|drv
operator|->
name|bss
argument_list|)
expr_stmt|;
name|dl_list_add
argument_list|(
operator|&
name|drv
operator|->
name|bss
argument_list|,
operator|&
name|bss
operator|->
name|list
argument_list|)
expr_stmt|;
name|os_strlcpy
argument_list|(
name|bss
operator|->
name|ifname
argument_list|,
name|ifname
argument_list|,
name|IFNAMSIZ
argument_list|)
expr_stmt|;
name|bss
operator|->
name|bss_ctx
operator|=
name|ctx
expr_stmt|;
name|bss
operator|->
name|drv
operator|=
name|drv
expr_stmt|;
comment|/* Generate a MAC address to help testing with multiple STAs */
name|drv
operator|->
name|own_addr
index|[
literal|0
index|]
operator|=
literal|0x02
expr_stmt|;
comment|/* locally administered */
name|sha1_prf
argument_list|(
operator|(
specifier|const
name|u8
operator|*
operator|)
name|ifname
argument_list|,
name|os_strlen
argument_list|(
name|ifname
argument_list|)
argument_list|,
literal|"test mac addr generation"
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|,
name|drv
operator|->
name|own_addr
operator|+
literal|1
argument_list|,
name|ETH_ALEN
operator|-
literal|1
argument_list|)
expr_stmt|;
return|return
name|drv
return|;
block|}
end_function

begin_function
specifier|static
name|void
modifier|*
name|test_driver_init
parameter_list|(
name|struct
name|hostapd_data
modifier|*
name|hapd
parameter_list|,
name|struct
name|wpa_init_params
modifier|*
name|params
parameter_list|)
block|{
name|struct
name|wpa_driver_test_data
modifier|*
name|drv
decl_stmt|;
name|struct
name|sockaddr_un
name|addr_un
decl_stmt|;
name|struct
name|sockaddr_in
name|addr_in
decl_stmt|;
name|struct
name|sockaddr
modifier|*
name|addr
decl_stmt|;
name|socklen_t
name|alen
decl_stmt|;
name|struct
name|test_driver_bss
modifier|*
name|bss
decl_stmt|;
name|drv
operator|=
name|test_alloc_data
argument_list|(
name|hapd
argument_list|,
name|params
operator|->
name|ifname
argument_list|)
expr_stmt|;
if|if
condition|(
name|drv
operator|==
name|NULL
condition|)
return|return
name|NULL
return|;
name|drv
operator|->
name|ap
operator|=
literal|1
expr_stmt|;
name|bss
operator|=
name|dl_list_first
argument_list|(
operator|&
name|drv
operator|->
name|bss
argument_list|,
expr|struct
name|test_driver_bss
argument_list|,
name|list
argument_list|)
expr_stmt|;
name|bss
operator|->
name|bss_ctx
operator|=
name|hapd
expr_stmt|;
name|os_memcpy
argument_list|(
name|bss
operator|->
name|bssid
argument_list|,
name|drv
operator|->
name|own_addr
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
name|os_memcpy
argument_list|(
name|params
operator|->
name|own_addr
argument_list|,
name|drv
operator|->
name|own_addr
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
if|if
condition|(
name|params
operator|->
name|test_socket
condition|)
block|{
if|if
condition|(
name|os_strlen
argument_list|(
name|params
operator|->
name|test_socket
argument_list|)
operator|>=
sizeof|sizeof
argument_list|(
name|addr_un
operator|.
name|sun_path
argument_list|)
condition|)
block|{
name|printf
argument_list|(
literal|"Too long test_socket path\n"
argument_list|)
expr_stmt|;
name|wpa_driver_test_deinit
argument_list|(
name|bss
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
if|if
condition|(
name|strncmp
argument_list|(
name|params
operator|->
name|test_socket
argument_list|,
literal|"DIR:"
argument_list|,
literal|4
argument_list|)
operator|==
literal|0
condition|)
block|{
name|size_t
name|len
init|=
name|strlen
argument_list|(
name|params
operator|->
name|test_socket
argument_list|)
operator|+
literal|30
decl_stmt|;
name|drv
operator|->
name|test_dir
operator|=
name|os_strdup
argument_list|(
name|params
operator|->
name|test_socket
operator|+
literal|4
argument_list|)
expr_stmt|;
name|drv
operator|->
name|own_socket_path
operator|=
name|os_malloc
argument_list|(
name|len
argument_list|)
expr_stmt|;
if|if
condition|(
name|drv
operator|->
name|own_socket_path
condition|)
block|{
name|snprintf
argument_list|(
name|drv
operator|->
name|own_socket_path
argument_list|,
name|len
argument_list|,
literal|"%s/AP-"
name|MACSTR
argument_list|,
name|params
operator|->
name|test_socket
operator|+
literal|4
argument_list|,
name|MAC2STR
argument_list|(
name|params
operator|->
name|own_addr
argument_list|)
argument_list|)
expr_stmt|;
block|}
block|}
elseif|else
if|if
condition|(
name|strncmp
argument_list|(
name|params
operator|->
name|test_socket
argument_list|,
literal|"UDP:"
argument_list|,
literal|4
argument_list|)
operator|==
literal|0
condition|)
block|{
name|drv
operator|->
name|udp_port
operator|=
name|atoi
argument_list|(
name|params
operator|->
name|test_socket
operator|+
literal|4
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|drv
operator|->
name|own_socket_path
operator|=
name|os_strdup
argument_list|(
name|params
operator|->
name|test_socket
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|drv
operator|->
name|own_socket_path
operator|==
name|NULL
operator|&&
name|drv
operator|->
name|udp_port
operator|==
literal|0
condition|)
block|{
name|wpa_driver_test_deinit
argument_list|(
name|bss
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|drv
operator|->
name|test_socket
operator|=
name|socket
argument_list|(
name|drv
operator|->
name|udp_port
condition|?
name|PF_INET
else|:
name|PF_UNIX
argument_list|,
name|SOCK_DGRAM
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|drv
operator|->
name|test_socket
operator|<
literal|0
condition|)
block|{
name|perror
argument_list|(
literal|"socket"
argument_list|)
expr_stmt|;
name|wpa_driver_test_deinit
argument_list|(
name|bss
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
if|if
condition|(
name|drv
operator|->
name|udp_port
condition|)
block|{
name|os_memset
argument_list|(
operator|&
name|addr_in
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|addr_in
argument_list|)
argument_list|)
expr_stmt|;
name|addr_in
operator|.
name|sin_family
operator|=
name|AF_INET
expr_stmt|;
name|addr_in
operator|.
name|sin_port
operator|=
name|htons
argument_list|(
name|drv
operator|->
name|udp_port
argument_list|)
expr_stmt|;
name|addr
operator|=
operator|(
expr|struct
name|sockaddr
operator|*
operator|)
operator|&
name|addr_in
expr_stmt|;
name|alen
operator|=
sizeof|sizeof
argument_list|(
name|addr_in
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|os_memset
argument_list|(
operator|&
name|addr_un
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|addr_un
argument_list|)
argument_list|)
expr_stmt|;
name|addr_un
operator|.
name|sun_family
operator|=
name|AF_UNIX
expr_stmt|;
name|os_strlcpy
argument_list|(
name|addr_un
operator|.
name|sun_path
argument_list|,
name|drv
operator|->
name|own_socket_path
argument_list|,
sizeof|sizeof
argument_list|(
name|addr_un
operator|.
name|sun_path
argument_list|)
argument_list|)
expr_stmt|;
name|addr
operator|=
operator|(
expr|struct
name|sockaddr
operator|*
operator|)
operator|&
name|addr_un
expr_stmt|;
name|alen
operator|=
sizeof|sizeof
argument_list|(
name|addr_un
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|bind
argument_list|(
name|drv
operator|->
name|test_socket
argument_list|,
name|addr
argument_list|,
name|alen
argument_list|)
operator|<
literal|0
condition|)
block|{
name|perror
argument_list|(
literal|"bind(PF_UNIX)"
argument_list|)
expr_stmt|;
name|close
argument_list|(
name|drv
operator|->
name|test_socket
argument_list|)
expr_stmt|;
if|if
condition|(
name|drv
operator|->
name|own_socket_path
condition|)
name|unlink
argument_list|(
name|drv
operator|->
name|own_socket_path
argument_list|)
expr_stmt|;
name|wpa_driver_test_deinit
argument_list|(
name|bss
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|eloop_register_read_sock
argument_list|(
name|drv
operator|->
name|test_socket
argument_list|,
name|test_driver_receive_unix
argument_list|,
name|drv
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
block|}
else|else
name|drv
operator|->
name|test_socket
operator|=
operator|-
literal|1
expr_stmt|;
return|return
name|bss
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|wpa_driver_test_poll
parameter_list|(
name|void
modifier|*
name|eloop_ctx
parameter_list|,
name|void
modifier|*
name|timeout_ctx
parameter_list|)
block|{
name|struct
name|wpa_driver_test_data
modifier|*
name|drv
init|=
name|eloop_ctx
decl_stmt|;
ifdef|#
directive|ifdef
name|DRIVER_TEST_UNIX
if|if
condition|(
name|drv
operator|->
name|associated
operator|&&
name|drv
operator|->
name|hostapd_addr_set
condition|)
block|{
name|struct
name|stat
name|st
decl_stmt|;
if|if
condition|(
name|stat
argument_list|(
name|drv
operator|->
name|hostapd_addr
operator|.
name|sun_path
argument_list|,
operator|&
name|st
argument_list|)
operator|<
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"%s: lost connection to AP: %s"
argument_list|,
name|__func__
argument_list|,
name|strerror
argument_list|(
name|errno
argument_list|)
argument_list|)
expr_stmt|;
name|drv
operator|->
name|associated
operator|=
literal|0
expr_stmt|;
name|wpa_supplicant_event
argument_list|(
name|drv
operator|->
name|ctx
argument_list|,
name|EVENT_DISASSOC
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
block|}
block|}
endif|#
directive|endif
comment|/* DRIVER_TEST_UNIX */
name|eloop_register_timeout
argument_list|(
literal|1
argument_list|,
literal|0
argument_list|,
name|wpa_driver_test_poll
argument_list|,
name|drv
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|wpa_driver_test_scan_timeout
parameter_list|(
name|void
modifier|*
name|eloop_ctx
parameter_list|,
name|void
modifier|*
name|timeout_ctx
parameter_list|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"Scan timeout - try to get results"
argument_list|)
expr_stmt|;
name|wpa_supplicant_event
argument_list|(
name|timeout_ctx
argument_list|,
name|EVENT_SCAN_RESULTS
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
block|}
end_function

begin_ifdef
ifdef|#
directive|ifdef
name|DRIVER_TEST_UNIX
end_ifdef

begin_function
specifier|static
name|void
name|wpa_driver_scan_dir
parameter_list|(
name|struct
name|wpa_driver_test_data
modifier|*
name|drv
parameter_list|,
specifier|const
name|char
modifier|*
name|path
parameter_list|)
block|{
name|struct
name|dirent
modifier|*
name|dent
decl_stmt|;
name|DIR
modifier|*
name|dir
decl_stmt|;
name|struct
name|sockaddr_un
name|addr
decl_stmt|;
name|char
name|cmd
index|[
literal|512
index|]
decl_stmt|,
modifier|*
name|pos
decl_stmt|,
modifier|*
name|end
decl_stmt|;
name|int
name|ret
decl_stmt|;
name|dir
operator|=
name|opendir
argument_list|(
name|path
argument_list|)
expr_stmt|;
if|if
condition|(
name|dir
operator|==
name|NULL
condition|)
return|return;
name|end
operator|=
name|cmd
operator|+
sizeof|sizeof
argument_list|(
name|cmd
argument_list|)
expr_stmt|;
name|pos
operator|=
name|cmd
expr_stmt|;
name|ret
operator|=
name|os_snprintf
argument_list|(
name|pos
argument_list|,
name|end
operator|-
name|pos
argument_list|,
literal|"SCAN "
name|MACSTR
argument_list|,
name|MAC2STR
argument_list|(
name|drv
operator|->
name|own_addr
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|>=
literal|0
operator|&&
name|ret
operator|<
name|end
operator|-
name|pos
condition|)
name|pos
operator|+=
name|ret
expr_stmt|;
if|if
condition|(
name|drv
operator|->
name|probe_req_ie
condition|)
block|{
name|ret
operator|=
name|os_snprintf
argument_list|(
name|pos
argument_list|,
name|end
operator|-
name|pos
argument_list|,
literal|" "
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|>=
literal|0
operator|&&
name|ret
operator|<
name|end
operator|-
name|pos
condition|)
name|pos
operator|+=
name|ret
expr_stmt|;
name|pos
operator|+=
name|wpa_snprintf_hex
argument_list|(
name|pos
argument_list|,
name|end
operator|-
name|pos
argument_list|,
name|drv
operator|->
name|probe_req_ie
argument_list|,
name|drv
operator|->
name|probe_req_ie_len
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|drv
operator|->
name|probe_req_ssid_len
condition|)
block|{
comment|/* Add SSID IE */
name|ret
operator|=
name|os_snprintf
argument_list|(
name|pos
argument_list|,
name|end
operator|-
name|pos
argument_list|,
literal|"%02x%02x"
argument_list|,
name|WLAN_EID_SSID
argument_list|,
operator|(
name|unsigned
name|int
operator|)
name|drv
operator|->
name|probe_req_ssid_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|>=
literal|0
operator|&&
name|ret
operator|<
name|end
operator|-
name|pos
condition|)
name|pos
operator|+=
name|ret
expr_stmt|;
name|pos
operator|+=
name|wpa_snprintf_hex
argument_list|(
name|pos
argument_list|,
name|end
operator|-
name|pos
argument_list|,
name|drv
operator|->
name|probe_req_ssid
argument_list|,
name|drv
operator|->
name|probe_req_ssid_len
argument_list|)
expr_stmt|;
block|}
name|end
index|[
operator|-
literal|1
index|]
operator|=
literal|'\0'
expr_stmt|;
while|while
condition|(
operator|(
name|dent
operator|=
name|readdir
argument_list|(
name|dir
argument_list|)
operator|)
condition|)
block|{
if|if
condition|(
name|os_strncmp
argument_list|(
name|dent
operator|->
name|d_name
argument_list|,
literal|"AP-"
argument_list|,
literal|3
argument_list|)
operator|!=
literal|0
operator|&&
name|os_strncmp
argument_list|(
name|dent
operator|->
name|d_name
argument_list|,
literal|"STA-"
argument_list|,
literal|4
argument_list|)
operator|!=
literal|0
condition|)
continue|continue;
if|if
condition|(
name|drv
operator|->
name|own_socket_path
condition|)
block|{
name|size_t
name|olen
decl_stmt|,
name|dlen
decl_stmt|;
name|olen
operator|=
name|os_strlen
argument_list|(
name|drv
operator|->
name|own_socket_path
argument_list|)
expr_stmt|;
name|dlen
operator|=
name|os_strlen
argument_list|(
name|dent
operator|->
name|d_name
argument_list|)
expr_stmt|;
if|if
condition|(
name|olen
operator|>=
name|dlen
operator|&&
name|os_strcmp
argument_list|(
name|dent
operator|->
name|d_name
argument_list|,
name|drv
operator|->
name|own_socket_path
operator|+
name|olen
operator|-
name|dlen
argument_list|)
operator|==
literal|0
condition|)
continue|continue;
block|}
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"%s: SCAN %s"
argument_list|,
name|__func__
argument_list|,
name|dent
operator|->
name|d_name
argument_list|)
expr_stmt|;
name|os_memset
argument_list|(
operator|&
name|addr
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|addr
argument_list|)
argument_list|)
expr_stmt|;
name|addr
operator|.
name|sun_family
operator|=
name|AF_UNIX
expr_stmt|;
name|os_snprintf
argument_list|(
name|addr
operator|.
name|sun_path
argument_list|,
sizeof|sizeof
argument_list|(
name|addr
operator|.
name|sun_path
argument_list|)
argument_list|,
literal|"%s/%s"
argument_list|,
name|path
argument_list|,
name|dent
operator|->
name|d_name
argument_list|)
expr_stmt|;
if|if
condition|(
name|sendto
argument_list|(
name|drv
operator|->
name|test_socket
argument_list|,
name|cmd
argument_list|,
name|os_strlen
argument_list|(
name|cmd
argument_list|)
argument_list|,
literal|0
argument_list|,
operator|(
expr|struct
name|sockaddr
operator|*
operator|)
operator|&
name|addr
argument_list|,
sizeof|sizeof
argument_list|(
name|addr
argument_list|)
argument_list|)
operator|<
literal|0
condition|)
block|{
name|perror
argument_list|(
literal|"sendto(test_socket)"
argument_list|)
expr_stmt|;
block|}
block|}
name|closedir
argument_list|(
name|dir
argument_list|)
expr_stmt|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* DRIVER_TEST_UNIX */
end_comment

begin_function
specifier|static
name|int
name|wpa_driver_test_scan
parameter_list|(
name|void
modifier|*
name|priv
parameter_list|,
name|struct
name|wpa_driver_scan_params
modifier|*
name|params
parameter_list|)
block|{
name|struct
name|test_driver_bss
modifier|*
name|dbss
init|=
name|priv
decl_stmt|;
name|struct
name|wpa_driver_test_data
modifier|*
name|drv
init|=
name|dbss
operator|->
name|drv
decl_stmt|;
name|size_t
name|i
decl_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"%s: priv=%p"
argument_list|,
name|__func__
argument_list|,
name|priv
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|drv
operator|->
name|probe_req_ie
argument_list|)
expr_stmt|;
if|if
condition|(
name|params
operator|->
name|extra_ies
condition|)
block|{
name|drv
operator|->
name|probe_req_ie
operator|=
name|os_malloc
argument_list|(
name|params
operator|->
name|extra_ies_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|drv
operator|->
name|probe_req_ie
operator|==
name|NULL
condition|)
block|{
name|drv
operator|->
name|probe_req_ie_len
operator|=
literal|0
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|os_memcpy
argument_list|(
name|drv
operator|->
name|probe_req_ie
argument_list|,
name|params
operator|->
name|extra_ies
argument_list|,
name|params
operator|->
name|extra_ies_len
argument_list|)
expr_stmt|;
name|drv
operator|->
name|probe_req_ie_len
operator|=
name|params
operator|->
name|extra_ies_len
expr_stmt|;
block|}
else|else
block|{
name|drv
operator|->
name|probe_req_ie
operator|=
name|NULL
expr_stmt|;
name|drv
operator|->
name|probe_req_ie_len
operator|=
literal|0
expr_stmt|;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|params
operator|->
name|num_ssids
condition|;
name|i
operator|++
control|)
name|wpa_hexdump
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"Scan SSID"
argument_list|,
name|params
operator|->
name|ssids
index|[
name|i
index|]
operator|.
name|ssid
argument_list|,
name|params
operator|->
name|ssids
index|[
name|i
index|]
operator|.
name|ssid_len
argument_list|)
expr_stmt|;
name|drv
operator|->
name|probe_req_ssid_len
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|params
operator|->
name|num_ssids
condition|)
block|{
name|os_memcpy
argument_list|(
name|drv
operator|->
name|probe_req_ssid
argument_list|,
name|params
operator|->
name|ssids
index|[
literal|0
index|]
operator|.
name|ssid
argument_list|,
name|params
operator|->
name|ssids
index|[
literal|0
index|]
operator|.
name|ssid_len
argument_list|)
expr_stmt|;
name|drv
operator|->
name|probe_req_ssid_len
operator|=
name|params
operator|->
name|ssids
index|[
literal|0
index|]
operator|.
name|ssid_len
expr_stmt|;
block|}
name|wpa_hexdump
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"Scan extra IE(s)"
argument_list|,
name|params
operator|->
name|extra_ies
argument_list|,
name|params
operator|->
name|extra_ies_len
argument_list|)
expr_stmt|;
name|drv
operator|->
name|num_scanres
operator|=
literal|0
expr_stmt|;
ifdef|#
directive|ifdef
name|DRIVER_TEST_UNIX
if|if
condition|(
name|drv
operator|->
name|test_socket
operator|>=
literal|0
operator|&&
name|drv
operator|->
name|test_dir
condition|)
name|wpa_driver_scan_dir
argument_list|(
name|drv
argument_list|,
name|drv
operator|->
name|test_dir
argument_list|)
expr_stmt|;
if|if
condition|(
name|drv
operator|->
name|test_socket
operator|>=
literal|0
operator|&&
name|drv
operator|->
name|hostapd_addr_set
operator|&&
name|sendto
argument_list|(
name|drv
operator|->
name|test_socket
argument_list|,
literal|"SCAN"
argument_list|,
literal|4
argument_list|,
literal|0
argument_list|,
operator|(
expr|struct
name|sockaddr
operator|*
operator|)
operator|&
name|drv
operator|->
name|hostapd_addr
argument_list|,
sizeof|sizeof
argument_list|(
name|drv
operator|->
name|hostapd_addr
argument_list|)
argument_list|)
operator|<
literal|0
condition|)
block|{
name|perror
argument_list|(
literal|"sendto(test_socket)"
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
comment|/* DRIVER_TEST_UNIX */
if|if
condition|(
name|drv
operator|->
name|test_socket
operator|>=
literal|0
operator|&&
name|drv
operator|->
name|hostapd_addr_udp_set
operator|&&
name|sendto
argument_list|(
name|drv
operator|->
name|test_socket
argument_list|,
literal|"SCAN"
argument_list|,
literal|4
argument_list|,
literal|0
argument_list|,
operator|(
expr|struct
name|sockaddr
operator|*
operator|)
operator|&
name|drv
operator|->
name|hostapd_addr_udp
argument_list|,
sizeof|sizeof
argument_list|(
name|drv
operator|->
name|hostapd_addr_udp
argument_list|)
argument_list|)
operator|<
literal|0
condition|)
block|{
name|perror
argument_list|(
literal|"sendto(test_socket)"
argument_list|)
expr_stmt|;
block|}
name|eloop_cancel_timeout
argument_list|(
name|wpa_driver_test_scan_timeout
argument_list|,
name|drv
argument_list|,
name|drv
operator|->
name|ctx
argument_list|)
expr_stmt|;
name|eloop_register_timeout
argument_list|(
literal|1
argument_list|,
literal|0
argument_list|,
name|wpa_driver_test_scan_timeout
argument_list|,
name|drv
argument_list|,
name|drv
operator|->
name|ctx
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|struct
name|wpa_scan_results
modifier|*
name|wpa_driver_test_get_scan_results2
parameter_list|(
name|void
modifier|*
name|priv
parameter_list|)
block|{
name|struct
name|test_driver_bss
modifier|*
name|dbss
init|=
name|priv
decl_stmt|;
name|struct
name|wpa_driver_test_data
modifier|*
name|drv
init|=
name|dbss
operator|->
name|drv
decl_stmt|;
name|struct
name|wpa_scan_results
modifier|*
name|res
decl_stmt|;
name|size_t
name|i
decl_stmt|;
name|res
operator|=
name|os_zalloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|res
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|res
operator|==
name|NULL
condition|)
return|return
name|NULL
return|;
name|res
operator|->
name|res
operator|=
name|os_zalloc
argument_list|(
name|drv
operator|->
name|num_scanres
operator|*
sizeof|sizeof
argument_list|(
expr|struct
name|wpa_scan_res
operator|*
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|res
operator|->
name|res
operator|==
name|NULL
condition|)
block|{
name|os_free
argument_list|(
name|res
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|drv
operator|->
name|num_scanres
condition|;
name|i
operator|++
control|)
block|{
name|struct
name|wpa_scan_res
modifier|*
name|r
decl_stmt|;
if|if
condition|(
name|drv
operator|->
name|scanres
index|[
name|i
index|]
operator|==
name|NULL
condition|)
continue|continue;
name|r
operator|=
name|os_malloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|r
argument_list|)
operator|+
name|drv
operator|->
name|scanres
index|[
name|i
index|]
operator|->
name|ie_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
operator|==
name|NULL
condition|)
break|break;
name|os_memcpy
argument_list|(
name|r
argument_list|,
name|drv
operator|->
name|scanres
index|[
name|i
index|]
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|r
argument_list|)
operator|+
name|drv
operator|->
name|scanres
index|[
name|i
index|]
operator|->
name|ie_len
argument_list|)
expr_stmt|;
name|res
operator|->
name|res
index|[
name|res
operator|->
name|num
operator|++
index|]
operator|=
name|r
expr_stmt|;
block|}
return|return
name|res
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|wpa_driver_test_set_key
parameter_list|(
specifier|const
name|char
modifier|*
name|ifname
parameter_list|,
name|void
modifier|*
name|priv
parameter_list|,
name|enum
name|wpa_alg
name|alg
parameter_list|,
specifier|const
name|u8
modifier|*
name|addr
parameter_list|,
name|int
name|key_idx
parameter_list|,
name|int
name|set_tx
parameter_list|,
specifier|const
name|u8
modifier|*
name|seq
parameter_list|,
name|size_t
name|seq_len
parameter_list|,
specifier|const
name|u8
modifier|*
name|key
parameter_list|,
name|size_t
name|key_len
parameter_list|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"%s: ifname=%s priv=%p alg=%d key_idx=%d "
literal|"set_tx=%d"
argument_list|,
name|__func__
argument_list|,
name|ifname
argument_list|,
name|priv
argument_list|,
name|alg
argument_list|,
name|key_idx
argument_list|,
name|set_tx
argument_list|)
expr_stmt|;
if|if
condition|(
name|addr
condition|)
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"   addr="
name|MACSTR
argument_list|,
name|MAC2STR
argument_list|(
name|addr
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|seq
condition|)
name|wpa_hexdump
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"   seq"
argument_list|,
name|seq
argument_list|,
name|seq_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|key
condition|)
name|wpa_hexdump_key
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"   key"
argument_list|,
name|key
argument_list|,
name|key_len
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|wpa_driver_update_mode
parameter_list|(
name|struct
name|wpa_driver_test_data
modifier|*
name|drv
parameter_list|,
name|int
name|ap
parameter_list|)
block|{
if|if
condition|(
name|ap
operator|&&
operator|!
name|drv
operator|->
name|ap
condition|)
block|{
name|wpa_driver_test_close_test_socket
argument_list|(
name|drv
argument_list|)
expr_stmt|;
name|wpa_driver_test_attach
argument_list|(
name|drv
argument_list|,
name|drv
operator|->
name|test_dir
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|drv
operator|->
name|ap
operator|=
literal|1
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|!
name|ap
operator|&&
name|drv
operator|->
name|ap
condition|)
block|{
name|wpa_driver_test_close_test_socket
argument_list|(
name|drv
argument_list|)
expr_stmt|;
name|wpa_driver_test_attach
argument_list|(
name|drv
argument_list|,
name|drv
operator|->
name|test_dir
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|drv
operator|->
name|ap
operator|=
literal|0
expr_stmt|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|wpa_driver_test_associate
parameter_list|(
name|void
modifier|*
name|priv
parameter_list|,
name|struct
name|wpa_driver_associate_params
modifier|*
name|params
parameter_list|)
block|{
name|struct
name|test_driver_bss
modifier|*
name|dbss
init|=
name|priv
decl_stmt|;
name|struct
name|wpa_driver_test_data
modifier|*
name|drv
init|=
name|dbss
operator|->
name|drv
decl_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"%s: priv=%p freq=%d pairwise_suite=%d "
literal|"group_suite=%d key_mgmt_suite=%d auth_alg=%d mode=%d"
argument_list|,
name|__func__
argument_list|,
name|priv
argument_list|,
name|params
operator|->
name|freq
argument_list|,
name|params
operator|->
name|pairwise_suite
argument_list|,
name|params
operator|->
name|group_suite
argument_list|,
name|params
operator|->
name|key_mgmt_suite
argument_list|,
name|params
operator|->
name|auth_alg
argument_list|,
name|params
operator|->
name|mode
argument_list|)
expr_stmt|;
if|if
condition|(
name|params
operator|->
name|bssid
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"   bssid="
name|MACSTR
argument_list|,
name|MAC2STR
argument_list|(
name|params
operator|->
name|bssid
argument_list|)
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|params
operator|->
name|ssid
condition|)
block|{
name|wpa_hexdump_ascii
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"   ssid"
argument_list|,
name|params
operator|->
name|ssid
argument_list|,
name|params
operator|->
name|ssid_len
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|params
operator|->
name|wpa_ie
condition|)
block|{
name|wpa_hexdump
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"   wpa_ie"
argument_list|,
name|params
operator|->
name|wpa_ie
argument_list|,
name|params
operator|->
name|wpa_ie_len
argument_list|)
expr_stmt|;
name|drv
operator|->
name|assoc_wpa_ie_len
operator|=
name|params
operator|->
name|wpa_ie_len
expr_stmt|;
if|if
condition|(
name|drv
operator|->
name|assoc_wpa_ie_len
operator|>
sizeof|sizeof
argument_list|(
name|drv
operator|->
name|assoc_wpa_ie
argument_list|)
condition|)
name|drv
operator|->
name|assoc_wpa_ie_len
operator|=
sizeof|sizeof
argument_list|(
name|drv
operator|->
name|assoc_wpa_ie
argument_list|)
expr_stmt|;
name|os_memcpy
argument_list|(
name|drv
operator|->
name|assoc_wpa_ie
argument_list|,
name|params
operator|->
name|wpa_ie
argument_list|,
name|drv
operator|->
name|assoc_wpa_ie_len
argument_list|)
expr_stmt|;
block|}
else|else
name|drv
operator|->
name|assoc_wpa_ie_len
operator|=
literal|0
expr_stmt|;
name|wpa_driver_update_mode
argument_list|(
name|drv
argument_list|,
name|params
operator|->
name|mode
operator|==
name|IEEE80211_MODE_AP
argument_list|)
expr_stmt|;
name|drv
operator|->
name|ibss
operator|=
name|params
operator|->
name|mode
operator|==
name|IEEE80211_MODE_IBSS
expr_stmt|;
name|dbss
operator|->
name|privacy
operator|=
name|params
operator|->
name|key_mgmt_suite
operator|&
operator|(
name|WPA_KEY_MGMT_IEEE8021X
operator||
name|WPA_KEY_MGMT_PSK
operator||
name|WPA_KEY_MGMT_WPA_NONE
operator||
name|WPA_KEY_MGMT_FT_IEEE8021X
operator||
name|WPA_KEY_MGMT_FT_PSK
operator||
name|WPA_KEY_MGMT_IEEE8021X_SHA256
operator||
name|WPA_KEY_MGMT_PSK_SHA256
operator|)
expr_stmt|;
if|if
condition|(
name|params
operator|->
name|wep_key_len
index|[
name|params
operator|->
name|wep_tx_keyidx
index|]
condition|)
name|dbss
operator|->
name|privacy
operator|=
literal|1
expr_stmt|;
ifdef|#
directive|ifdef
name|DRIVER_TEST_UNIX
if|if
condition|(
name|drv
operator|->
name|test_dir
operator|&&
name|params
operator|->
name|bssid
operator|&&
name|params
operator|->
name|mode
operator|!=
name|IEEE80211_MODE_IBSS
condition|)
block|{
name|os_memset
argument_list|(
operator|&
name|drv
operator|->
name|hostapd_addr
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|drv
operator|->
name|hostapd_addr
argument_list|)
argument_list|)
expr_stmt|;
name|drv
operator|->
name|hostapd_addr
operator|.
name|sun_family
operator|=
name|AF_UNIX
expr_stmt|;
name|os_snprintf
argument_list|(
name|drv
operator|->
name|hostapd_addr
operator|.
name|sun_path
argument_list|,
sizeof|sizeof
argument_list|(
name|drv
operator|->
name|hostapd_addr
operator|.
name|sun_path
argument_list|)
argument_list|,
literal|"%s/AP-"
name|MACSTR
argument_list|,
name|drv
operator|->
name|test_dir
argument_list|,
name|MAC2STR
argument_list|(
name|params
operator|->
name|bssid
argument_list|)
argument_list|)
expr_stmt|;
name|drv
operator|->
name|hostapd_addr_set
operator|=
literal|1
expr_stmt|;
block|}
endif|#
directive|endif
comment|/* DRIVER_TEST_UNIX */
if|if
condition|(
name|params
operator|->
name|mode
operator|==
name|IEEE80211_MODE_AP
condition|)
block|{
name|os_memcpy
argument_list|(
name|dbss
operator|->
name|ssid
argument_list|,
name|params
operator|->
name|ssid
argument_list|,
name|params
operator|->
name|ssid_len
argument_list|)
expr_stmt|;
name|dbss
operator|->
name|ssid_len
operator|=
name|params
operator|->
name|ssid_len
expr_stmt|;
name|os_memcpy
argument_list|(
name|dbss
operator|->
name|bssid
argument_list|,
name|drv
operator|->
name|own_addr
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
if|if
condition|(
name|params
operator|->
name|wpa_ie
operator|&&
name|params
operator|->
name|wpa_ie_len
condition|)
block|{
name|dbss
operator|->
name|ie
operator|=
name|os_malloc
argument_list|(
name|params
operator|->
name|wpa_ie_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|dbss
operator|->
name|ie
condition|)
block|{
name|os_memcpy
argument_list|(
name|dbss
operator|->
name|ie
argument_list|,
name|params
operator|->
name|wpa_ie
argument_list|,
name|params
operator|->
name|wpa_ie_len
argument_list|)
expr_stmt|;
name|dbss
operator|->
name|ielen
operator|=
name|params
operator|->
name|wpa_ie_len
expr_stmt|;
block|}
block|}
block|}
elseif|else
if|if
condition|(
name|drv
operator|->
name|test_socket
operator|>=
literal|0
operator|&&
operator|(
name|drv
operator|->
name|hostapd_addr_set
operator|||
name|drv
operator|->
name|hostapd_addr_udp_set
operator|)
condition|)
block|{
name|char
name|cmd
index|[
literal|200
index|]
decl_stmt|,
modifier|*
name|pos
decl_stmt|,
modifier|*
name|end
decl_stmt|;
name|int
name|ret
decl_stmt|;
name|end
operator|=
name|cmd
operator|+
sizeof|sizeof
argument_list|(
name|cmd
argument_list|)
expr_stmt|;
name|pos
operator|=
name|cmd
expr_stmt|;
name|ret
operator|=
name|os_snprintf
argument_list|(
name|pos
argument_list|,
name|end
operator|-
name|pos
argument_list|,
literal|"ASSOC "
name|MACSTR
literal|" "
argument_list|,
name|MAC2STR
argument_list|(
name|drv
operator|->
name|own_addr
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|>=
literal|0
operator|&&
name|ret
operator|<
name|end
operator|-
name|pos
condition|)
name|pos
operator|+=
name|ret
expr_stmt|;
name|pos
operator|+=
name|wpa_snprintf_hex
argument_list|(
name|pos
argument_list|,
name|end
operator|-
name|pos
argument_list|,
name|params
operator|->
name|ssid
argument_list|,
name|params
operator|->
name|ssid_len
argument_list|)
expr_stmt|;
name|ret
operator|=
name|os_snprintf
argument_list|(
name|pos
argument_list|,
name|end
operator|-
name|pos
argument_list|,
literal|" "
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|>=
literal|0
operator|&&
name|ret
operator|<
name|end
operator|-
name|pos
condition|)
name|pos
operator|+=
name|ret
expr_stmt|;
name|pos
operator|+=
name|wpa_snprintf_hex
argument_list|(
name|pos
argument_list|,
name|end
operator|-
name|pos
argument_list|,
name|params
operator|->
name|wpa_ie
argument_list|,
name|params
operator|->
name|wpa_ie_len
argument_list|)
expr_stmt|;
name|end
index|[
operator|-
literal|1
index|]
operator|=
literal|'\0'
expr_stmt|;
ifdef|#
directive|ifdef
name|DRIVER_TEST_UNIX
if|if
condition|(
name|drv
operator|->
name|hostapd_addr_set
operator|&&
name|sendto
argument_list|(
name|drv
operator|->
name|test_socket
argument_list|,
name|cmd
argument_list|,
name|os_strlen
argument_list|(
name|cmd
argument_list|)
argument_list|,
literal|0
argument_list|,
operator|(
expr|struct
name|sockaddr
operator|*
operator|)
operator|&
name|drv
operator|->
name|hostapd_addr
argument_list|,
sizeof|sizeof
argument_list|(
name|drv
operator|->
name|hostapd_addr
argument_list|)
argument_list|)
operator|<
literal|0
condition|)
block|{
name|perror
argument_list|(
literal|"sendto(test_socket)"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
endif|#
directive|endif
comment|/* DRIVER_TEST_UNIX */
if|if
condition|(
name|drv
operator|->
name|hostapd_addr_udp_set
operator|&&
name|sendto
argument_list|(
name|drv
operator|->
name|test_socket
argument_list|,
name|cmd
argument_list|,
name|os_strlen
argument_list|(
name|cmd
argument_list|)
argument_list|,
literal|0
argument_list|,
operator|(
expr|struct
name|sockaddr
operator|*
operator|)
operator|&
name|drv
operator|->
name|hostapd_addr_udp
argument_list|,
sizeof|sizeof
argument_list|(
name|drv
operator|->
name|hostapd_addr_udp
argument_list|)
argument_list|)
operator|<
literal|0
condition|)
block|{
name|perror
argument_list|(
literal|"sendto(test_socket)"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|os_memcpy
argument_list|(
name|dbss
operator|->
name|ssid
argument_list|,
name|params
operator|->
name|ssid
argument_list|,
name|params
operator|->
name|ssid_len
argument_list|)
expr_stmt|;
name|dbss
operator|->
name|ssid_len
operator|=
name|params
operator|->
name|ssid_len
expr_stmt|;
block|}
else|else
block|{
name|drv
operator|->
name|associated
operator|=
literal|1
expr_stmt|;
if|if
condition|(
name|params
operator|->
name|mode
operator|==
name|IEEE80211_MODE_IBSS
condition|)
block|{
name|os_memcpy
argument_list|(
name|dbss
operator|->
name|ssid
argument_list|,
name|params
operator|->
name|ssid
argument_list|,
name|params
operator|->
name|ssid_len
argument_list|)
expr_stmt|;
name|dbss
operator|->
name|ssid_len
operator|=
name|params
operator|->
name|ssid_len
expr_stmt|;
if|if
condition|(
name|params
operator|->
name|bssid
condition|)
name|os_memcpy
argument_list|(
name|dbss
operator|->
name|bssid
argument_list|,
name|params
operator|->
name|bssid
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
else|else
block|{
name|os_get_random
argument_list|(
name|dbss
operator|->
name|bssid
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
name|dbss
operator|->
name|bssid
index|[
literal|0
index|]
operator|&=
operator|~
literal|0x01
expr_stmt|;
name|dbss
operator|->
name|bssid
index|[
literal|0
index|]
operator||=
literal|0x02
expr_stmt|;
block|}
block|}
name|wpa_supplicant_event
argument_list|(
name|drv
operator|->
name|ctx
argument_list|,
name|EVENT_ASSOC
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|wpa_driver_test_get_bssid
parameter_list|(
name|void
modifier|*
name|priv
parameter_list|,
name|u8
modifier|*
name|bssid
parameter_list|)
block|{
name|struct
name|test_driver_bss
modifier|*
name|dbss
init|=
name|priv
decl_stmt|;
name|os_memcpy
argument_list|(
name|bssid
argument_list|,
name|dbss
operator|->
name|bssid
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|wpa_driver_test_get_ssid
parameter_list|(
name|void
modifier|*
name|priv
parameter_list|,
name|u8
modifier|*
name|ssid
parameter_list|)
block|{
name|struct
name|test_driver_bss
modifier|*
name|dbss
init|=
name|priv
decl_stmt|;
name|os_memcpy
argument_list|(
name|ssid
argument_list|,
name|dbss
operator|->
name|ssid
argument_list|,
literal|32
argument_list|)
expr_stmt|;
return|return
name|dbss
operator|->
name|ssid_len
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|wpa_driver_test_send_disassoc
parameter_list|(
name|struct
name|wpa_driver_test_data
modifier|*
name|drv
parameter_list|)
block|{
ifdef|#
directive|ifdef
name|DRIVER_TEST_UNIX
if|if
condition|(
name|drv
operator|->
name|test_socket
operator|>=
literal|0
operator|&&
name|sendto
argument_list|(
name|drv
operator|->
name|test_socket
argument_list|,
literal|"DISASSOC"
argument_list|,
literal|8
argument_list|,
literal|0
argument_list|,
operator|(
expr|struct
name|sockaddr
operator|*
operator|)
operator|&
name|drv
operator|->
name|hostapd_addr
argument_list|,
sizeof|sizeof
argument_list|(
name|drv
operator|->
name|hostapd_addr
argument_list|)
argument_list|)
operator|<
literal|0
condition|)
block|{
name|perror
argument_list|(
literal|"sendto(test_socket)"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
endif|#
directive|endif
comment|/* DRIVER_TEST_UNIX */
if|if
condition|(
name|drv
operator|->
name|test_socket
operator|>=
literal|0
operator|&&
name|drv
operator|->
name|hostapd_addr_udp_set
operator|&&
name|sendto
argument_list|(
name|drv
operator|->
name|test_socket
argument_list|,
literal|"DISASSOC"
argument_list|,
literal|8
argument_list|,
literal|0
argument_list|,
operator|(
expr|struct
name|sockaddr
operator|*
operator|)
operator|&
name|drv
operator|->
name|hostapd_addr_udp
argument_list|,
sizeof|sizeof
argument_list|(
name|drv
operator|->
name|hostapd_addr_udp
argument_list|)
argument_list|)
operator|<
literal|0
condition|)
block|{
name|perror
argument_list|(
literal|"sendto(test_socket)"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|wpa_driver_test_deauthenticate
parameter_list|(
name|void
modifier|*
name|priv
parameter_list|,
specifier|const
name|u8
modifier|*
name|addr
parameter_list|,
name|int
name|reason_code
parameter_list|)
block|{
name|struct
name|test_driver_bss
modifier|*
name|dbss
init|=
name|priv
decl_stmt|;
name|struct
name|wpa_driver_test_data
modifier|*
name|drv
init|=
name|dbss
operator|->
name|drv
decl_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"%s addr="
name|MACSTR
literal|" reason_code=%d"
argument_list|,
name|__func__
argument_list|,
name|MAC2STR
argument_list|(
name|addr
argument_list|)
argument_list|,
name|reason_code
argument_list|)
expr_stmt|;
name|os_memset
argument_list|(
name|dbss
operator|->
name|bssid
argument_list|,
literal|0
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
name|drv
operator|->
name|associated
operator|=
literal|0
expr_stmt|;
name|wpa_supplicant_event
argument_list|(
name|drv
operator|->
name|ctx
argument_list|,
name|EVENT_DISASSOC
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
return|return
name|wpa_driver_test_send_disassoc
argument_list|(
name|drv
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|wpa_driver_test_disassociate
parameter_list|(
name|void
modifier|*
name|priv
parameter_list|,
specifier|const
name|u8
modifier|*
name|addr
parameter_list|,
name|int
name|reason_code
parameter_list|)
block|{
name|struct
name|test_driver_bss
modifier|*
name|dbss
init|=
name|priv
decl_stmt|;
name|struct
name|wpa_driver_test_data
modifier|*
name|drv
init|=
name|dbss
operator|->
name|drv
decl_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"%s addr="
name|MACSTR
literal|" reason_code=%d"
argument_list|,
name|__func__
argument_list|,
name|MAC2STR
argument_list|(
name|addr
argument_list|)
argument_list|,
name|reason_code
argument_list|)
expr_stmt|;
name|os_memset
argument_list|(
name|dbss
operator|->
name|bssid
argument_list|,
literal|0
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
name|drv
operator|->
name|associated
operator|=
literal|0
expr_stmt|;
name|wpa_supplicant_event
argument_list|(
name|drv
operator|->
name|ctx
argument_list|,
name|EVENT_DISASSOC
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
return|return
name|wpa_driver_test_send_disassoc
argument_list|(
name|drv
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
specifier|const
name|u8
modifier|*
name|wpa_scan_get_ie
parameter_list|(
specifier|const
name|struct
name|wpa_scan_res
modifier|*
name|res
parameter_list|,
name|u8
name|ie
parameter_list|)
block|{
specifier|const
name|u8
modifier|*
name|end
decl_stmt|,
modifier|*
name|pos
decl_stmt|;
name|pos
operator|=
operator|(
specifier|const
name|u8
operator|*
operator|)
operator|(
name|res
operator|+
literal|1
operator|)
expr_stmt|;
name|end
operator|=
name|pos
operator|+
name|res
operator|->
name|ie_len
expr_stmt|;
while|while
condition|(
name|pos
operator|+
literal|1
operator|<
name|end
condition|)
block|{
if|if
condition|(
name|pos
operator|+
literal|2
operator|+
name|pos
index|[
literal|1
index|]
operator|>
name|end
condition|)
break|break;
if|if
condition|(
name|pos
index|[
literal|0
index|]
operator|==
name|ie
condition|)
return|return
name|pos
return|;
name|pos
operator|+=
literal|2
operator|+
name|pos
index|[
literal|1
index|]
expr_stmt|;
block|}
return|return
name|NULL
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|wpa_driver_test_scanresp
parameter_list|(
name|struct
name|wpa_driver_test_data
modifier|*
name|drv
parameter_list|,
name|struct
name|sockaddr
modifier|*
name|from
parameter_list|,
name|socklen_t
name|fromlen
parameter_list|,
specifier|const
name|char
modifier|*
name|data
parameter_list|)
block|{
name|struct
name|wpa_scan_res
modifier|*
name|res
decl_stmt|;
specifier|const
name|char
modifier|*
name|pos
decl_stmt|,
modifier|*
name|pos2
decl_stmt|;
name|size_t
name|len
decl_stmt|;
name|u8
modifier|*
name|ie_pos
decl_stmt|,
modifier|*
name|ie_start
decl_stmt|,
modifier|*
name|ie_end
decl_stmt|;
define|#
directive|define
name|MAX_IE_LEN
value|1000
specifier|const
name|u8
modifier|*
name|ds_params
decl_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"test_driver: SCANRESP %s"
argument_list|,
name|data
argument_list|)
expr_stmt|;
if|if
condition|(
name|drv
operator|->
name|num_scanres
operator|>=
name|MAX_SCAN_RESULTS
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"test_driver: No room for the new scan "
literal|"result"
argument_list|)
expr_stmt|;
return|return;
block|}
comment|/* SCANRESP BSSID SSID IEs */
name|res
operator|=
name|os_zalloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|res
argument_list|)
operator|+
name|MAX_IE_LEN
argument_list|)
expr_stmt|;
if|if
condition|(
name|res
operator|==
name|NULL
condition|)
return|return;
name|ie_start
operator|=
name|ie_pos
operator|=
operator|(
name|u8
operator|*
operator|)
operator|(
name|res
operator|+
literal|1
operator|)
expr_stmt|;
name|ie_end
operator|=
name|ie_pos
operator|+
name|MAX_IE_LEN
expr_stmt|;
if|if
condition|(
name|hwaddr_aton
argument_list|(
name|data
argument_list|,
name|res
operator|->
name|bssid
argument_list|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"test_driver: invalid BSSID in scanres"
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|res
argument_list|)
expr_stmt|;
return|return;
block|}
name|pos
operator|=
name|data
operator|+
literal|17
expr_stmt|;
while|while
condition|(
operator|*
name|pos
operator|==
literal|' '
condition|)
name|pos
operator|++
expr_stmt|;
name|pos2
operator|=
name|os_strchr
argument_list|(
name|pos
argument_list|,
literal|' '
argument_list|)
expr_stmt|;
if|if
condition|(
name|pos2
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"test_driver: invalid SSID termination "
literal|"in scanres"
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|res
argument_list|)
expr_stmt|;
return|return;
block|}
name|len
operator|=
operator|(
name|pos2
operator|-
name|pos
operator|)
operator|/
literal|2
expr_stmt|;
if|if
condition|(
name|len
operator|>
literal|32
condition|)
name|len
operator|=
literal|32
expr_stmt|;
comment|/* 	 * Generate SSID IE from the SSID field since this IE is not included 	 * in the main IE field. 	 */
operator|*
name|ie_pos
operator|++
operator|=
name|WLAN_EID_SSID
expr_stmt|;
operator|*
name|ie_pos
operator|++
operator|=
name|len
expr_stmt|;
if|if
condition|(
name|hexstr2bin
argument_list|(
name|pos
argument_list|,
name|ie_pos
argument_list|,
name|len
argument_list|)
operator|<
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"test_driver: invalid SSID in scanres"
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|res
argument_list|)
expr_stmt|;
return|return;
block|}
name|ie_pos
operator|+=
name|len
expr_stmt|;
name|pos
operator|=
name|pos2
operator|+
literal|1
expr_stmt|;
name|pos2
operator|=
name|os_strchr
argument_list|(
name|pos
argument_list|,
literal|' '
argument_list|)
expr_stmt|;
if|if
condition|(
name|pos2
operator|==
name|NULL
condition|)
name|len
operator|=
name|os_strlen
argument_list|(
name|pos
argument_list|)
operator|/
literal|2
expr_stmt|;
else|else
name|len
operator|=
operator|(
name|pos2
operator|-
name|pos
operator|)
operator|/
literal|2
expr_stmt|;
if|if
condition|(
operator|(
name|int
operator|)
name|len
operator|>
name|ie_end
operator|-
name|ie_pos
condition|)
name|len
operator|=
name|ie_end
operator|-
name|ie_pos
expr_stmt|;
if|if
condition|(
name|hexstr2bin
argument_list|(
name|pos
argument_list|,
name|ie_pos
argument_list|,
name|len
argument_list|)
operator|<
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"test_driver: invalid IEs in scanres"
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|res
argument_list|)
expr_stmt|;
return|return;
block|}
name|ie_pos
operator|+=
name|len
expr_stmt|;
name|res
operator|->
name|ie_len
operator|=
name|ie_pos
operator|-
name|ie_start
expr_stmt|;
if|if
condition|(
name|pos2
condition|)
block|{
name|pos
operator|=
name|pos2
operator|+
literal|1
expr_stmt|;
while|while
condition|(
operator|*
name|pos
operator|==
literal|' '
condition|)
name|pos
operator|++
expr_stmt|;
if|if
condition|(
name|os_strstr
argument_list|(
name|pos
argument_list|,
literal|"PRIVACY"
argument_list|)
condition|)
name|res
operator|->
name|caps
operator||=
name|IEEE80211_CAP_PRIVACY
expr_stmt|;
if|if
condition|(
name|os_strstr
argument_list|(
name|pos
argument_list|,
literal|"IBSS"
argument_list|)
condition|)
name|res
operator|->
name|caps
operator||=
name|IEEE80211_CAP_IBSS
expr_stmt|;
block|}
name|ds_params
operator|=
name|wpa_scan_get_ie
argument_list|(
name|res
argument_list|,
name|WLAN_EID_DS_PARAMS
argument_list|)
expr_stmt|;
if|if
condition|(
name|ds_params
operator|&&
name|ds_params
index|[
literal|1
index|]
operator|>
literal|0
condition|)
block|{
if|if
condition|(
name|ds_params
index|[
literal|2
index|]
operator|>=
literal|1
operator|&&
name|ds_params
index|[
literal|2
index|]
operator|<=
literal|13
condition|)
name|res
operator|->
name|freq
operator|=
literal|2407
operator|+
name|ds_params
index|[
literal|2
index|]
operator|*
literal|5
expr_stmt|;
block|}
name|os_free
argument_list|(
name|drv
operator|->
name|scanres
index|[
name|drv
operator|->
name|num_scanres
index|]
argument_list|)
expr_stmt|;
name|drv
operator|->
name|scanres
index|[
name|drv
operator|->
name|num_scanres
operator|++
index|]
operator|=
name|res
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|wpa_driver_test_assocresp
parameter_list|(
name|struct
name|wpa_driver_test_data
modifier|*
name|drv
parameter_list|,
name|struct
name|sockaddr
modifier|*
name|from
parameter_list|,
name|socklen_t
name|fromlen
parameter_list|,
specifier|const
name|char
modifier|*
name|data
parameter_list|)
block|{
name|struct
name|test_driver_bss
modifier|*
name|bss
decl_stmt|;
name|bss
operator|=
name|dl_list_first
argument_list|(
operator|&
name|drv
operator|->
name|bss
argument_list|,
expr|struct
name|test_driver_bss
argument_list|,
name|list
argument_list|)
expr_stmt|;
comment|/* ASSOCRESP BSSID<res> */
if|if
condition|(
name|hwaddr_aton
argument_list|(
name|data
argument_list|,
name|bss
operator|->
name|bssid
argument_list|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"test_driver: invalid BSSID in "
literal|"assocresp"
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|drv
operator|->
name|use_associnfo
condition|)
block|{
name|union
name|wpa_event_data
name|event
decl_stmt|;
name|os_memset
argument_list|(
operator|&
name|event
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|event
argument_list|)
argument_list|)
expr_stmt|;
name|event
operator|.
name|assoc_info
operator|.
name|req_ies
operator|=
name|drv
operator|->
name|assoc_wpa_ie
expr_stmt|;
name|event
operator|.
name|assoc_info
operator|.
name|req_ies_len
operator|=
name|drv
operator|->
name|assoc_wpa_ie_len
expr_stmt|;
name|wpa_supplicant_event
argument_list|(
name|drv
operator|->
name|ctx
argument_list|,
name|EVENT_ASSOCINFO
argument_list|,
operator|&
name|event
argument_list|)
expr_stmt|;
block|}
name|drv
operator|->
name|associated
operator|=
literal|1
expr_stmt|;
name|wpa_supplicant_event
argument_list|(
name|drv
operator|->
name|ctx
argument_list|,
name|EVENT_ASSOC
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|wpa_driver_test_disassoc
parameter_list|(
name|struct
name|wpa_driver_test_data
modifier|*
name|drv
parameter_list|,
name|struct
name|sockaddr
modifier|*
name|from
parameter_list|,
name|socklen_t
name|fromlen
parameter_list|)
block|{
name|drv
operator|->
name|associated
operator|=
literal|0
expr_stmt|;
name|wpa_supplicant_event
argument_list|(
name|drv
operator|->
name|ctx
argument_list|,
name|EVENT_DISASSOC
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|wpa_driver_test_eapol
parameter_list|(
name|struct
name|wpa_driver_test_data
modifier|*
name|drv
parameter_list|,
name|struct
name|sockaddr
modifier|*
name|from
parameter_list|,
name|socklen_t
name|fromlen
parameter_list|,
specifier|const
name|u8
modifier|*
name|data
parameter_list|,
name|size_t
name|data_len
parameter_list|)
block|{
specifier|const
name|u8
modifier|*
name|src
decl_stmt|;
name|struct
name|test_driver_bss
modifier|*
name|bss
decl_stmt|;
name|bss
operator|=
name|dl_list_first
argument_list|(
operator|&
name|drv
operator|->
name|bss
argument_list|,
expr|struct
name|test_driver_bss
argument_list|,
name|list
argument_list|)
expr_stmt|;
if|if
condition|(
name|data_len
operator|>
literal|14
condition|)
block|{
comment|/* Skip Ethernet header */
name|src
operator|=
name|data
operator|+
name|ETH_ALEN
expr_stmt|;
name|data
operator|+=
literal|14
expr_stmt|;
name|data_len
operator|-=
literal|14
expr_stmt|;
block|}
else|else
name|src
operator|=
name|bss
operator|->
name|bssid
expr_stmt|;
name|drv_event_eapol_rx
argument_list|(
name|drv
operator|->
name|ctx
argument_list|,
name|src
argument_list|,
name|data
argument_list|,
name|data_len
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|wpa_driver_test_mlme
parameter_list|(
name|struct
name|wpa_driver_test_data
modifier|*
name|drv
parameter_list|,
name|struct
name|sockaddr
modifier|*
name|from
parameter_list|,
name|socklen_t
name|fromlen
parameter_list|,
specifier|const
name|u8
modifier|*
name|data
parameter_list|,
name|size_t
name|data_len
parameter_list|)
block|{
name|int
name|freq
init|=
literal|0
decl_stmt|,
name|own_freq
decl_stmt|;
name|union
name|wpa_event_data
name|event
decl_stmt|;
name|struct
name|test_driver_bss
modifier|*
name|bss
decl_stmt|;
name|bss
operator|=
name|dl_list_first
argument_list|(
operator|&
name|drv
operator|->
name|bss
argument_list|,
expr|struct
name|test_driver_bss
argument_list|,
name|list
argument_list|)
expr_stmt|;
if|if
condition|(
name|data_len
operator|>
literal|6
operator|&&
name|os_memcmp
argument_list|(
name|data
argument_list|,
literal|"freq="
argument_list|,
literal|5
argument_list|)
operator|==
literal|0
condition|)
block|{
name|size_t
name|pos
decl_stmt|;
for|for
control|(
name|pos
operator|=
literal|5
init|;
name|pos
operator|<
name|data_len
condition|;
name|pos
operator|++
control|)
block|{
if|if
condition|(
name|data
index|[
name|pos
index|]
operator|==
literal|' '
condition|)
break|break;
block|}
if|if
condition|(
name|pos
operator|<
name|data_len
condition|)
block|{
name|freq
operator|=
name|atoi
argument_list|(
operator|(
specifier|const
name|char
operator|*
operator|)
operator|&
name|data
index|[
literal|5
index|]
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"test_driver(%s): MLME RX on "
literal|"freq %d MHz"
argument_list|,
name|bss
operator|->
name|ifname
argument_list|,
name|freq
argument_list|)
expr_stmt|;
name|pos
operator|++
expr_stmt|;
name|data
operator|+=
name|pos
expr_stmt|;
name|data_len
operator|-=
name|pos
expr_stmt|;
block|}
block|}
if|if
condition|(
name|drv
operator|->
name|remain_on_channel_freq
condition|)
name|own_freq
operator|=
name|drv
operator|->
name|remain_on_channel_freq
expr_stmt|;
else|else
name|own_freq
operator|=
name|drv
operator|->
name|current_freq
expr_stmt|;
if|if
condition|(
name|freq
operator|&&
name|own_freq
operator|&&
name|freq
operator|!=
name|own_freq
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"test_driver(%s): Ignore MLME RX on "
literal|"another frequency %d MHz (own %d MHz)"
argument_list|,
name|bss
operator|->
name|ifname
argument_list|,
name|freq
argument_list|,
name|own_freq
argument_list|)
expr_stmt|;
return|return;
block|}
name|os_memset
argument_list|(
operator|&
name|event
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|event
argument_list|)
argument_list|)
expr_stmt|;
name|event
operator|.
name|mlme_rx
operator|.
name|buf
operator|=
name|data
expr_stmt|;
name|event
operator|.
name|mlme_rx
operator|.
name|len
operator|=
name|data_len
expr_stmt|;
name|event
operator|.
name|mlme_rx
operator|.
name|freq
operator|=
name|freq
expr_stmt|;
name|wpa_supplicant_event
argument_list|(
name|drv
operator|->
name|ctx
argument_list|,
name|EVENT_MLME_RX
argument_list|,
operator|&
name|event
argument_list|)
expr_stmt|;
if|if
condition|(
name|drv
operator|->
name|probe_req_report
operator|&&
name|data_len
operator|>=
literal|24
condition|)
block|{
specifier|const
name|struct
name|ieee80211_mgmt
modifier|*
name|mgmt
decl_stmt|;
name|u16
name|fc
decl_stmt|;
name|mgmt
operator|=
operator|(
specifier|const
expr|struct
name|ieee80211_mgmt
operator|*
operator|)
name|data
expr_stmt|;
name|fc
operator|=
name|le_to_host16
argument_list|(
name|mgmt
operator|->
name|frame_control
argument_list|)
expr_stmt|;
if|if
condition|(
name|WLAN_FC_GET_TYPE
argument_list|(
name|fc
argument_list|)
operator|==
name|WLAN_FC_TYPE_MGMT
operator|&&
name|WLAN_FC_GET_STYPE
argument_list|(
name|fc
argument_list|)
operator|==
name|WLAN_FC_STYPE_PROBE_REQ
condition|)
block|{
name|os_memset
argument_list|(
operator|&
name|event
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|event
argument_list|)
argument_list|)
expr_stmt|;
name|event
operator|.
name|rx_probe_req
operator|.
name|sa
operator|=
name|mgmt
operator|->
name|sa
expr_stmt|;
name|event
operator|.
name|rx_probe_req
operator|.
name|ie
operator|=
name|mgmt
operator|->
name|u
operator|.
name|probe_req
operator|.
name|variable
expr_stmt|;
name|event
operator|.
name|rx_probe_req
operator|.
name|ie_len
operator|=
name|data_len
operator|-
operator|(
name|mgmt
operator|->
name|u
operator|.
name|probe_req
operator|.
name|variable
operator|-
name|data
operator|)
expr_stmt|;
name|wpa_supplicant_event
argument_list|(
name|drv
operator|->
name|ctx
argument_list|,
name|EVENT_RX_PROBE_REQ
argument_list|,
operator|&
name|event
argument_list|)
expr_stmt|;
block|}
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|wpa_driver_test_scan_cmd
parameter_list|(
name|struct
name|wpa_driver_test_data
modifier|*
name|drv
parameter_list|,
name|struct
name|sockaddr
modifier|*
name|from
parameter_list|,
name|socklen_t
name|fromlen
parameter_list|,
specifier|const
name|u8
modifier|*
name|data
parameter_list|,
name|size_t
name|data_len
parameter_list|)
block|{
name|char
name|buf
index|[
literal|512
index|]
decl_stmt|,
modifier|*
name|pos
decl_stmt|,
modifier|*
name|end
decl_stmt|;
name|int
name|ret
decl_stmt|;
name|struct
name|test_driver_bss
modifier|*
name|bss
decl_stmt|;
name|bss
operator|=
name|dl_list_first
argument_list|(
operator|&
name|drv
operator|->
name|bss
argument_list|,
expr|struct
name|test_driver_bss
argument_list|,
name|list
argument_list|)
expr_stmt|;
comment|/* data: optional [ STA-addr | ' ' | IEs(hex) ] */
if|if
condition|(
operator|!
name|drv
operator|->
name|ibss
condition|)
return|return;
name|pos
operator|=
name|buf
expr_stmt|;
name|end
operator|=
name|buf
operator|+
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
expr_stmt|;
comment|/* reply: SCANRESP BSSID SSID IEs */
name|ret
operator|=
name|snprintf
argument_list|(
name|pos
argument_list|,
name|end
operator|-
name|pos
argument_list|,
literal|"SCANRESP "
name|MACSTR
literal|" "
argument_list|,
name|MAC2STR
argument_list|(
name|bss
operator|->
name|bssid
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|<
literal|0
operator|||
name|ret
operator|>=
name|end
operator|-
name|pos
condition|)
return|return;
name|pos
operator|+=
name|ret
expr_stmt|;
name|pos
operator|+=
name|wpa_snprintf_hex
argument_list|(
name|pos
argument_list|,
name|end
operator|-
name|pos
argument_list|,
name|bss
operator|->
name|ssid
argument_list|,
name|bss
operator|->
name|ssid_len
argument_list|)
expr_stmt|;
name|ret
operator|=
name|snprintf
argument_list|(
name|pos
argument_list|,
name|end
operator|-
name|pos
argument_list|,
literal|" "
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|<
literal|0
operator|||
name|ret
operator|>=
name|end
operator|-
name|pos
condition|)
return|return;
name|pos
operator|+=
name|ret
expr_stmt|;
name|pos
operator|+=
name|wpa_snprintf_hex
argument_list|(
name|pos
argument_list|,
name|end
operator|-
name|pos
argument_list|,
name|drv
operator|->
name|assoc_wpa_ie
argument_list|,
name|drv
operator|->
name|assoc_wpa_ie_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|bss
operator|->
name|privacy
condition|)
block|{
name|ret
operator|=
name|snprintf
argument_list|(
name|pos
argument_list|,
name|end
operator|-
name|pos
argument_list|,
literal|" PRIVACY"
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|<
literal|0
operator|||
name|ret
operator|>=
name|end
operator|-
name|pos
condition|)
return|return;
name|pos
operator|+=
name|ret
expr_stmt|;
block|}
name|ret
operator|=
name|snprintf
argument_list|(
name|pos
argument_list|,
name|end
operator|-
name|pos
argument_list|,
literal|" IBSS"
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|<
literal|0
operator|||
name|ret
operator|>=
name|end
operator|-
name|pos
condition|)
return|return;
name|pos
operator|+=
name|ret
expr_stmt|;
name|sendto
argument_list|(
name|drv
operator|->
name|test_socket
argument_list|,
name|buf
argument_list|,
name|pos
operator|-
name|buf
argument_list|,
literal|0
argument_list|,
operator|(
expr|struct
name|sockaddr
operator|*
operator|)
name|from
argument_list|,
name|fromlen
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|wpa_driver_test_receive_unix
parameter_list|(
name|int
name|sock
parameter_list|,
name|void
modifier|*
name|eloop_ctx
parameter_list|,
name|void
modifier|*
name|sock_ctx
parameter_list|)
block|{
name|struct
name|wpa_driver_test_data
modifier|*
name|drv
init|=
name|eloop_ctx
decl_stmt|;
name|char
modifier|*
name|buf
decl_stmt|;
name|int
name|res
decl_stmt|;
name|struct
name|sockaddr_storage
name|from
decl_stmt|;
name|socklen_t
name|fromlen
init|=
sizeof|sizeof
argument_list|(
name|from
argument_list|)
decl_stmt|;
specifier|const
name|size_t
name|buflen
init|=
literal|2000
decl_stmt|;
if|if
condition|(
name|drv
operator|->
name|ap
condition|)
block|{
name|test_driver_receive_unix
argument_list|(
name|sock
argument_list|,
name|eloop_ctx
argument_list|,
name|sock_ctx
argument_list|)
expr_stmt|;
return|return;
block|}
name|buf
operator|=
name|os_malloc
argument_list|(
name|buflen
argument_list|)
expr_stmt|;
if|if
condition|(
name|buf
operator|==
name|NULL
condition|)
return|return;
name|res
operator|=
name|recvfrom
argument_list|(
name|sock
argument_list|,
name|buf
argument_list|,
name|buflen
operator|-
literal|1
argument_list|,
literal|0
argument_list|,
operator|(
expr|struct
name|sockaddr
operator|*
operator|)
operator|&
name|from
argument_list|,
operator|&
name|fromlen
argument_list|)
expr_stmt|;
if|if
condition|(
name|res
operator|<
literal|0
condition|)
block|{
name|perror
argument_list|(
literal|"recvfrom(test_socket)"
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|buf
argument_list|)
expr_stmt|;
return|return;
block|}
name|buf
index|[
name|res
index|]
operator|=
literal|'\0'
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"test_driver: received %u bytes"
argument_list|,
name|res
argument_list|)
expr_stmt|;
if|if
condition|(
name|os_strncmp
argument_list|(
name|buf
argument_list|,
literal|"SCANRESP "
argument_list|,
literal|9
argument_list|)
operator|==
literal|0
condition|)
block|{
name|wpa_driver_test_scanresp
argument_list|(
name|drv
argument_list|,
operator|(
expr|struct
name|sockaddr
operator|*
operator|)
operator|&
name|from
argument_list|,
name|fromlen
argument_list|,
name|buf
operator|+
literal|9
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|os_strncmp
argument_list|(
name|buf
argument_list|,
literal|"ASSOCRESP "
argument_list|,
literal|10
argument_list|)
operator|==
literal|0
condition|)
block|{
name|wpa_driver_test_assocresp
argument_list|(
name|drv
argument_list|,
operator|(
expr|struct
name|sockaddr
operator|*
operator|)
operator|&
name|from
argument_list|,
name|fromlen
argument_list|,
name|buf
operator|+
literal|10
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|os_strcmp
argument_list|(
name|buf
argument_list|,
literal|"DISASSOC"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|wpa_driver_test_disassoc
argument_list|(
name|drv
argument_list|,
operator|(
expr|struct
name|sockaddr
operator|*
operator|)
operator|&
name|from
argument_list|,
name|fromlen
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|os_strcmp
argument_list|(
name|buf
argument_list|,
literal|"DEAUTH"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|wpa_driver_test_disassoc
argument_list|(
name|drv
argument_list|,
operator|(
expr|struct
name|sockaddr
operator|*
operator|)
operator|&
name|from
argument_list|,
name|fromlen
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|os_strncmp
argument_list|(
name|buf
argument_list|,
literal|"EAPOL "
argument_list|,
literal|6
argument_list|)
operator|==
literal|0
condition|)
block|{
name|wpa_driver_test_eapol
argument_list|(
name|drv
argument_list|,
operator|(
expr|struct
name|sockaddr
operator|*
operator|)
operator|&
name|from
argument_list|,
name|fromlen
argument_list|,
operator|(
specifier|const
name|u8
operator|*
operator|)
name|buf
operator|+
literal|6
argument_list|,
name|res
operator|-
literal|6
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|os_strncmp
argument_list|(
name|buf
argument_list|,
literal|"MLME "
argument_list|,
literal|5
argument_list|)
operator|==
literal|0
condition|)
block|{
name|wpa_driver_test_mlme
argument_list|(
name|drv
argument_list|,
operator|(
expr|struct
name|sockaddr
operator|*
operator|)
operator|&
name|from
argument_list|,
name|fromlen
argument_list|,
operator|(
specifier|const
name|u8
operator|*
operator|)
name|buf
operator|+
literal|5
argument_list|,
name|res
operator|-
literal|5
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|os_strncmp
argument_list|(
name|buf
argument_list|,
literal|"SCAN "
argument_list|,
literal|5
argument_list|)
operator|==
literal|0
condition|)
block|{
name|wpa_driver_test_scan_cmd
argument_list|(
name|drv
argument_list|,
operator|(
expr|struct
name|sockaddr
operator|*
operator|)
operator|&
name|from
argument_list|,
name|fromlen
argument_list|,
operator|(
specifier|const
name|u8
operator|*
operator|)
name|buf
operator|+
literal|5
argument_list|,
name|res
operator|-
literal|5
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|wpa_hexdump_ascii
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"Unknown test_socket command"
argument_list|,
operator|(
name|u8
operator|*
operator|)
name|buf
argument_list|,
name|res
argument_list|)
expr_stmt|;
block|}
name|os_free
argument_list|(
name|buf
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
modifier|*
name|wpa_driver_test_init2
parameter_list|(
name|void
modifier|*
name|ctx
parameter_list|,
specifier|const
name|char
modifier|*
name|ifname
parameter_list|,
name|void
modifier|*
name|global_priv
parameter_list|)
block|{
name|struct
name|wpa_driver_test_data
modifier|*
name|drv
decl_stmt|;
name|struct
name|wpa_driver_test_global
modifier|*
name|global
init|=
name|global_priv
decl_stmt|;
name|struct
name|test_driver_bss
modifier|*
name|bss
decl_stmt|;
name|drv
operator|=
name|test_alloc_data
argument_list|(
name|ctx
argument_list|,
name|ifname
argument_list|)
expr_stmt|;
if|if
condition|(
name|drv
operator|==
name|NULL
condition|)
return|return
name|NULL
return|;
name|bss
operator|=
name|dl_list_first
argument_list|(
operator|&
name|drv
operator|->
name|bss
argument_list|,
expr|struct
name|test_driver_bss
argument_list|,
name|list
argument_list|)
expr_stmt|;
name|drv
operator|->
name|global
operator|=
name|global_priv
expr_stmt|;
name|drv
operator|->
name|test_socket
operator|=
operator|-
literal|1
expr_stmt|;
comment|/* Set dummy BSSID and SSID for testing. */
name|bss
operator|->
name|bssid
index|[
literal|0
index|]
operator|=
literal|0x02
expr_stmt|;
name|bss
operator|->
name|bssid
index|[
literal|1
index|]
operator|=
literal|0x00
expr_stmt|;
name|bss
operator|->
name|bssid
index|[
literal|2
index|]
operator|=
literal|0x00
expr_stmt|;
name|bss
operator|->
name|bssid
index|[
literal|3
index|]
operator|=
literal|0x00
expr_stmt|;
name|bss
operator|->
name|bssid
index|[
literal|4
index|]
operator|=
literal|0x00
expr_stmt|;
name|bss
operator|->
name|bssid
index|[
literal|5
index|]
operator|=
literal|0x01
expr_stmt|;
name|os_memcpy
argument_list|(
name|bss
operator|->
name|ssid
argument_list|,
literal|"test"
argument_list|,
literal|5
argument_list|)
expr_stmt|;
name|bss
operator|->
name|ssid_len
operator|=
literal|4
expr_stmt|;
if|if
condition|(
name|global
operator|->
name|bss_add_used
condition|)
block|{
name|os_memcpy
argument_list|(
name|drv
operator|->
name|own_addr
argument_list|,
name|global
operator|->
name|req_addr
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
name|global
operator|->
name|bss_add_used
operator|=
literal|0
expr_stmt|;
block|}
name|eloop_register_timeout
argument_list|(
literal|1
argument_list|,
literal|0
argument_list|,
name|wpa_driver_test_poll
argument_list|,
name|drv
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
return|return
name|bss
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|wpa_driver_test_close_test_socket
parameter_list|(
name|struct
name|wpa_driver_test_data
modifier|*
name|drv
parameter_list|)
block|{
if|if
condition|(
name|drv
operator|->
name|test_socket
operator|>=
literal|0
condition|)
block|{
name|eloop_unregister_read_sock
argument_list|(
name|drv
operator|->
name|test_socket
argument_list|)
expr_stmt|;
name|close
argument_list|(
name|drv
operator|->
name|test_socket
argument_list|)
expr_stmt|;
name|drv
operator|->
name|test_socket
operator|=
operator|-
literal|1
expr_stmt|;
block|}
if|if
condition|(
name|drv
operator|->
name|own_socket_path
condition|)
block|{
name|unlink
argument_list|(
name|drv
operator|->
name|own_socket_path
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|drv
operator|->
name|own_socket_path
argument_list|)
expr_stmt|;
name|drv
operator|->
name|own_socket_path
operator|=
name|NULL
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|wpa_driver_test_deinit
parameter_list|(
name|void
modifier|*
name|priv
parameter_list|)
block|{
name|struct
name|test_driver_bss
modifier|*
name|dbss
init|=
name|priv
decl_stmt|;
name|struct
name|wpa_driver_test_data
modifier|*
name|drv
init|=
name|dbss
operator|->
name|drv
decl_stmt|;
name|struct
name|test_client_socket
modifier|*
name|cli
decl_stmt|,
modifier|*
name|prev
decl_stmt|;
name|int
name|i
decl_stmt|;
name|cli
operator|=
name|drv
operator|->
name|cli
expr_stmt|;
while|while
condition|(
name|cli
condition|)
block|{
name|prev
operator|=
name|cli
expr_stmt|;
name|cli
operator|=
name|cli
operator|->
name|next
expr_stmt|;
name|os_free
argument_list|(
name|prev
argument_list|)
expr_stmt|;
block|}
ifdef|#
directive|ifdef
name|HOSTAPD
comment|/* There should be only one BSS remaining at this point. */
if|if
condition|(
name|dl_list_len
argument_list|(
operator|&
name|drv
operator|->
name|bss
argument_list|)
operator|!=
literal|1
condition|)
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"%s: %u remaining BSS entries"
argument_list|,
name|__func__
argument_list|,
name|dl_list_len
argument_list|(
operator|&
name|drv
operator|->
name|bss
argument_list|)
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* HOSTAPD */
name|test_driver_free_bsses
argument_list|(
name|drv
argument_list|)
expr_stmt|;
name|wpa_driver_test_close_test_socket
argument_list|(
name|drv
argument_list|)
expr_stmt|;
name|eloop_cancel_timeout
argument_list|(
name|wpa_driver_test_scan_timeout
argument_list|,
name|drv
argument_list|,
name|drv
operator|->
name|ctx
argument_list|)
expr_stmt|;
name|eloop_cancel_timeout
argument_list|(
name|wpa_driver_test_poll
argument_list|,
name|drv
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|eloop_cancel_timeout
argument_list|(
name|test_remain_on_channel_timeout
argument_list|,
name|drv
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|drv
operator|->
name|test_dir
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|MAX_SCAN_RESULTS
condition|;
name|i
operator|++
control|)
name|os_free
argument_list|(
name|drv
operator|->
name|scanres
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|drv
operator|->
name|probe_req_ie
argument_list|)
expr_stmt|;
name|wpa_trace_remove_ref
argument_list|(
name|drv
argument_list|,
name|ctx
argument_list|,
name|drv
operator|->
name|ctx
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|drv
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|wpa_driver_test_attach
parameter_list|(
name|struct
name|wpa_driver_test_data
modifier|*
name|drv
parameter_list|,
specifier|const
name|char
modifier|*
name|dir
parameter_list|,
name|int
name|ap
parameter_list|)
block|{
ifdef|#
directive|ifdef
name|DRIVER_TEST_UNIX
specifier|static
name|unsigned
name|int
name|counter
init|=
literal|0
decl_stmt|;
name|struct
name|sockaddr_un
name|addr
decl_stmt|;
name|size_t
name|len
decl_stmt|;
name|os_free
argument_list|(
name|drv
operator|->
name|own_socket_path
argument_list|)
expr_stmt|;
if|if
condition|(
name|dir
condition|)
block|{
name|len
operator|=
name|os_strlen
argument_list|(
name|dir
argument_list|)
operator|+
literal|30
expr_stmt|;
name|drv
operator|->
name|own_socket_path
operator|=
name|os_malloc
argument_list|(
name|len
argument_list|)
expr_stmt|;
if|if
condition|(
name|drv
operator|->
name|own_socket_path
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
name|os_snprintf
argument_list|(
name|drv
operator|->
name|own_socket_path
argument_list|,
name|len
argument_list|,
literal|"%s/%s-"
name|MACSTR
argument_list|,
name|dir
argument_list|,
name|ap
condition|?
literal|"AP"
else|:
literal|"STA"
argument_list|,
name|MAC2STR
argument_list|(
name|drv
operator|->
name|own_addr
argument_list|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|drv
operator|->
name|own_socket_path
operator|=
name|os_malloc
argument_list|(
literal|100
argument_list|)
expr_stmt|;
if|if
condition|(
name|drv
operator|->
name|own_socket_path
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
name|os_snprintf
argument_list|(
name|drv
operator|->
name|own_socket_path
argument_list|,
literal|100
argument_list|,
literal|"/tmp/wpa_supplicant_test-%d-%d"
argument_list|,
name|getpid
argument_list|()
argument_list|,
name|counter
operator|++
argument_list|)
expr_stmt|;
block|}
name|drv
operator|->
name|test_socket
operator|=
name|socket
argument_list|(
name|PF_UNIX
argument_list|,
name|SOCK_DGRAM
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|drv
operator|->
name|test_socket
operator|<
literal|0
condition|)
block|{
name|perror
argument_list|(
literal|"socket(PF_UNIX)"
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|drv
operator|->
name|own_socket_path
argument_list|)
expr_stmt|;
name|drv
operator|->
name|own_socket_path
operator|=
name|NULL
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|os_memset
argument_list|(
operator|&
name|addr
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|addr
argument_list|)
argument_list|)
expr_stmt|;
name|addr
operator|.
name|sun_family
operator|=
name|AF_UNIX
expr_stmt|;
name|os_strlcpy
argument_list|(
name|addr
operator|.
name|sun_path
argument_list|,
name|drv
operator|->
name|own_socket_path
argument_list|,
sizeof|sizeof
argument_list|(
name|addr
operator|.
name|sun_path
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|bind
argument_list|(
name|drv
operator|->
name|test_socket
argument_list|,
operator|(
expr|struct
name|sockaddr
operator|*
operator|)
operator|&
name|addr
argument_list|,
sizeof|sizeof
argument_list|(
name|addr
argument_list|)
argument_list|)
operator|<
literal|0
condition|)
block|{
name|perror
argument_list|(
literal|"bind(PF_UNIX)"
argument_list|)
expr_stmt|;
name|close
argument_list|(
name|drv
operator|->
name|test_socket
argument_list|)
expr_stmt|;
name|unlink
argument_list|(
name|drv
operator|->
name|own_socket_path
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|drv
operator|->
name|own_socket_path
argument_list|)
expr_stmt|;
name|drv
operator|->
name|own_socket_path
operator|=
name|NULL
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|eloop_register_read_sock
argument_list|(
name|drv
operator|->
name|test_socket
argument_list|,
name|wpa_driver_test_receive_unix
argument_list|,
name|drv
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
else|#
directive|else
comment|/* DRIVER_TEST_UNIX */
return|return
operator|-
literal|1
return|;
endif|#
directive|endif
comment|/* DRIVER_TEST_UNIX */
block|}
end_function

begin_function
specifier|static
name|int
name|wpa_driver_test_attach_udp
parameter_list|(
name|struct
name|wpa_driver_test_data
modifier|*
name|drv
parameter_list|,
name|char
modifier|*
name|dst
parameter_list|)
block|{
name|char
modifier|*
name|pos
decl_stmt|;
name|pos
operator|=
name|os_strchr
argument_list|(
name|dst
argument_list|,
literal|':'
argument_list|)
expr_stmt|;
if|if
condition|(
name|pos
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
operator|*
name|pos
operator|++
operator|=
literal|'\0'
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"%s: addr=%s port=%s"
argument_list|,
name|__func__
argument_list|,
name|dst
argument_list|,
name|pos
argument_list|)
expr_stmt|;
name|drv
operator|->
name|test_socket
operator|=
name|socket
argument_list|(
name|PF_INET
argument_list|,
name|SOCK_DGRAM
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|drv
operator|->
name|test_socket
operator|<
literal|0
condition|)
block|{
name|perror
argument_list|(
literal|"socket(PF_INET)"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|os_memset
argument_list|(
operator|&
name|drv
operator|->
name|hostapd_addr_udp
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|drv
operator|->
name|hostapd_addr_udp
argument_list|)
argument_list|)
expr_stmt|;
name|drv
operator|->
name|hostapd_addr_udp
operator|.
name|sin_family
operator|=
name|AF_INET
expr_stmt|;
if|#
directive|if
name|defined
argument_list|(
name|CONFIG_NATIVE_WINDOWS
argument_list|)
operator|||
name|defined
argument_list|(
name|CONFIG_ANSI_C_EXTRA
argument_list|)
block|{
name|int
name|a
index|[
literal|4
index|]
decl_stmt|;
name|u8
modifier|*
name|pos
decl_stmt|;
name|sscanf
argument_list|(
name|dst
argument_list|,
literal|"%d.%d.%d.%d"
argument_list|,
operator|&
name|a
index|[
literal|0
index|]
argument_list|,
operator|&
name|a
index|[
literal|1
index|]
argument_list|,
operator|&
name|a
index|[
literal|2
index|]
argument_list|,
operator|&
name|a
index|[
literal|3
index|]
argument_list|)
expr_stmt|;
name|pos
operator|=
operator|(
name|u8
operator|*
operator|)
operator|&
name|drv
operator|->
name|hostapd_addr_udp
operator|.
name|sin_addr
expr_stmt|;
operator|*
name|pos
operator|++
operator|=
name|a
index|[
literal|0
index|]
expr_stmt|;
operator|*
name|pos
operator|++
operator|=
name|a
index|[
literal|1
index|]
expr_stmt|;
operator|*
name|pos
operator|++
operator|=
name|a
index|[
literal|2
index|]
expr_stmt|;
operator|*
name|pos
operator|++
operator|=
name|a
index|[
literal|3
index|]
expr_stmt|;
block|}
else|#
directive|else
comment|/* CONFIG_NATIVE_WINDOWS or CONFIG_ANSI_C_EXTRA */
name|inet_aton
argument_list|(
name|dst
argument_list|,
operator|&
name|drv
operator|->
name|hostapd_addr_udp
operator|.
name|sin_addr
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* CONFIG_NATIVE_WINDOWS or CONFIG_ANSI_C_EXTRA */
name|drv
operator|->
name|hostapd_addr_udp
operator|.
name|sin_port
operator|=
name|htons
argument_list|(
name|atoi
argument_list|(
name|pos
argument_list|)
argument_list|)
expr_stmt|;
name|drv
operator|->
name|hostapd_addr_udp_set
operator|=
literal|1
expr_stmt|;
name|eloop_register_read_sock
argument_list|(
name|drv
operator|->
name|test_socket
argument_list|,
name|wpa_driver_test_receive_unix
argument_list|,
name|drv
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|wpa_driver_test_set_param
parameter_list|(
name|void
modifier|*
name|priv
parameter_list|,
specifier|const
name|char
modifier|*
name|param
parameter_list|)
block|{
name|struct
name|test_driver_bss
modifier|*
name|dbss
init|=
name|priv
decl_stmt|;
name|struct
name|wpa_driver_test_data
modifier|*
name|drv
init|=
name|dbss
operator|->
name|drv
decl_stmt|;
specifier|const
name|char
modifier|*
name|pos
decl_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"%s: param='%s'"
argument_list|,
name|__func__
argument_list|,
name|param
argument_list|)
expr_stmt|;
if|if
condition|(
name|param
operator|==
name|NULL
condition|)
return|return
literal|0
return|;
name|wpa_driver_test_close_test_socket
argument_list|(
name|drv
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|DRIVER_TEST_UNIX
name|pos
operator|=
name|os_strstr
argument_list|(
name|param
argument_list|,
literal|"test_socket="
argument_list|)
expr_stmt|;
if|if
condition|(
name|pos
condition|)
block|{
specifier|const
name|char
modifier|*
name|pos2
decl_stmt|;
name|size_t
name|len
decl_stmt|;
name|pos
operator|+=
literal|12
expr_stmt|;
name|pos2
operator|=
name|os_strchr
argument_list|(
name|pos
argument_list|,
literal|' '
argument_list|)
expr_stmt|;
if|if
condition|(
name|pos2
condition|)
name|len
operator|=
name|pos2
operator|-
name|pos
expr_stmt|;
else|else
name|len
operator|=
name|os_strlen
argument_list|(
name|pos
argument_list|)
expr_stmt|;
if|if
condition|(
name|len
operator|>
sizeof|sizeof
argument_list|(
name|drv
operator|->
name|hostapd_addr
operator|.
name|sun_path
argument_list|)
condition|)
return|return
operator|-
literal|1
return|;
name|os_memset
argument_list|(
operator|&
name|drv
operator|->
name|hostapd_addr
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|drv
operator|->
name|hostapd_addr
argument_list|)
argument_list|)
expr_stmt|;
name|drv
operator|->
name|hostapd_addr
operator|.
name|sun_family
operator|=
name|AF_UNIX
expr_stmt|;
name|os_memcpy
argument_list|(
name|drv
operator|->
name|hostapd_addr
operator|.
name|sun_path
argument_list|,
name|pos
argument_list|,
name|len
argument_list|)
expr_stmt|;
name|drv
operator|->
name|hostapd_addr_set
operator|=
literal|1
expr_stmt|;
block|}
endif|#
directive|endif
comment|/* DRIVER_TEST_UNIX */
name|pos
operator|=
name|os_strstr
argument_list|(
name|param
argument_list|,
literal|"test_dir="
argument_list|)
expr_stmt|;
if|if
condition|(
name|pos
condition|)
block|{
name|char
modifier|*
name|end
decl_stmt|;
name|os_free
argument_list|(
name|drv
operator|->
name|test_dir
argument_list|)
expr_stmt|;
name|drv
operator|->
name|test_dir
operator|=
name|os_strdup
argument_list|(
name|pos
operator|+
literal|9
argument_list|)
expr_stmt|;
if|if
condition|(
name|drv
operator|->
name|test_dir
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
name|end
operator|=
name|os_strchr
argument_list|(
name|drv
operator|->
name|test_dir
argument_list|,
literal|' '
argument_list|)
expr_stmt|;
if|if
condition|(
name|end
condition|)
operator|*
name|end
operator|=
literal|'\0'
expr_stmt|;
if|if
condition|(
name|wpa_driver_test_attach
argument_list|(
name|drv
argument_list|,
name|drv
operator|->
name|test_dir
argument_list|,
literal|0
argument_list|)
condition|)
return|return
operator|-
literal|1
return|;
block|}
else|else
block|{
name|pos
operator|=
name|os_strstr
argument_list|(
name|param
argument_list|,
literal|"test_udp="
argument_list|)
expr_stmt|;
if|if
condition|(
name|pos
condition|)
block|{
name|char
modifier|*
name|dst
decl_stmt|,
modifier|*
name|epos
decl_stmt|;
name|dst
operator|=
name|os_strdup
argument_list|(
name|pos
operator|+
literal|9
argument_list|)
expr_stmt|;
if|if
condition|(
name|dst
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
name|epos
operator|=
name|os_strchr
argument_list|(
name|dst
argument_list|,
literal|' '
argument_list|)
expr_stmt|;
if|if
condition|(
name|epos
condition|)
operator|*
name|epos
operator|=
literal|'\0'
expr_stmt|;
if|if
condition|(
name|wpa_driver_test_attach_udp
argument_list|(
name|drv
argument_list|,
name|dst
argument_list|)
condition|)
return|return
operator|-
literal|1
return|;
name|os_free
argument_list|(
name|dst
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|wpa_driver_test_attach
argument_list|(
name|drv
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
condition|)
return|return
operator|-
literal|1
return|;
block|}
if|if
condition|(
name|os_strstr
argument_list|(
name|param
argument_list|,
literal|"use_associnfo=1"
argument_list|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"test_driver: Use AssocInfo events"
argument_list|)
expr_stmt|;
name|drv
operator|->
name|use_associnfo
operator|=
literal|1
expr_stmt|;
block|}
ifdef|#
directive|ifdef
name|CONFIG_CLIENT_MLME
if|if
condition|(
name|os_strstr
argument_list|(
name|param
argument_list|,
literal|"use_mlme=1"
argument_list|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"test_driver: Use internal MLME"
argument_list|)
expr_stmt|;
name|drv
operator|->
name|use_mlme
operator|=
literal|1
expr_stmt|;
block|}
endif|#
directive|endif
comment|/* CONFIG_CLIENT_MLME */
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
specifier|const
name|u8
modifier|*
name|wpa_driver_test_get_mac_addr
parameter_list|(
name|void
modifier|*
name|priv
parameter_list|)
block|{
name|struct
name|test_driver_bss
modifier|*
name|dbss
init|=
name|priv
decl_stmt|;
name|struct
name|wpa_driver_test_data
modifier|*
name|drv
init|=
name|dbss
operator|->
name|drv
decl_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"%s"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
return|return
name|drv
operator|->
name|own_addr
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|wpa_driver_test_send_eapol
parameter_list|(
name|void
modifier|*
name|priv
parameter_list|,
specifier|const
name|u8
modifier|*
name|dest
parameter_list|,
name|u16
name|proto
parameter_list|,
specifier|const
name|u8
modifier|*
name|data
parameter_list|,
name|size_t
name|data_len
parameter_list|)
block|{
name|struct
name|test_driver_bss
modifier|*
name|dbss
init|=
name|priv
decl_stmt|;
name|struct
name|wpa_driver_test_data
modifier|*
name|drv
init|=
name|dbss
operator|->
name|drv
decl_stmt|;
name|char
modifier|*
name|msg
decl_stmt|;
name|size_t
name|msg_len
decl_stmt|;
name|struct
name|l2_ethhdr
name|eth
decl_stmt|;
name|struct
name|sockaddr
modifier|*
name|addr
decl_stmt|;
name|socklen_t
name|alen
decl_stmt|;
ifdef|#
directive|ifdef
name|DRIVER_TEST_UNIX
name|struct
name|sockaddr_un
name|addr_un
decl_stmt|;
endif|#
directive|endif
comment|/* DRIVER_TEST_UNIX */
name|wpa_hexdump
argument_list|(
name|MSG_MSGDUMP
argument_list|,
literal|"test_send_eapol TX frame"
argument_list|,
name|data
argument_list|,
name|data_len
argument_list|)
expr_stmt|;
name|os_memset
argument_list|(
operator|&
name|eth
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|eth
argument_list|)
argument_list|)
expr_stmt|;
name|os_memcpy
argument_list|(
name|eth
operator|.
name|h_dest
argument_list|,
name|dest
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
name|os_memcpy
argument_list|(
name|eth
operator|.
name|h_source
argument_list|,
name|drv
operator|->
name|own_addr
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
name|eth
operator|.
name|h_proto
operator|=
name|host_to_be16
argument_list|(
name|proto
argument_list|)
expr_stmt|;
name|msg_len
operator|=
literal|6
operator|+
sizeof|sizeof
argument_list|(
name|eth
argument_list|)
operator|+
name|data_len
expr_stmt|;
name|msg
operator|=
name|os_malloc
argument_list|(
name|msg_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|msg
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
name|os_memcpy
argument_list|(
name|msg
argument_list|,
literal|"EAPOL "
argument_list|,
literal|6
argument_list|)
expr_stmt|;
name|os_memcpy
argument_list|(
name|msg
operator|+
literal|6
argument_list|,
operator|&
name|eth
argument_list|,
sizeof|sizeof
argument_list|(
name|eth
argument_list|)
argument_list|)
expr_stmt|;
name|os_memcpy
argument_list|(
name|msg
operator|+
literal|6
operator|+
sizeof|sizeof
argument_list|(
name|eth
argument_list|)
argument_list|,
name|data
argument_list|,
name|data_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|os_memcmp
argument_list|(
name|dest
argument_list|,
name|dbss
operator|->
name|bssid
argument_list|,
name|ETH_ALEN
argument_list|)
operator|==
literal|0
operator|||
name|drv
operator|->
name|test_dir
operator|==
name|NULL
condition|)
block|{
if|if
condition|(
name|drv
operator|->
name|hostapd_addr_udp_set
condition|)
block|{
name|addr
operator|=
operator|(
expr|struct
name|sockaddr
operator|*
operator|)
operator|&
name|drv
operator|->
name|hostapd_addr_udp
expr_stmt|;
name|alen
operator|=
sizeof|sizeof
argument_list|(
name|drv
operator|->
name|hostapd_addr_udp
argument_list|)
expr_stmt|;
block|}
else|else
block|{
ifdef|#
directive|ifdef
name|DRIVER_TEST_UNIX
name|addr
operator|=
operator|(
expr|struct
name|sockaddr
operator|*
operator|)
operator|&
name|drv
operator|->
name|hostapd_addr
expr_stmt|;
name|alen
operator|=
sizeof|sizeof
argument_list|(
name|drv
operator|->
name|hostapd_addr
argument_list|)
expr_stmt|;
else|#
directive|else
comment|/* DRIVER_TEST_UNIX */
name|os_free
argument_list|(
name|msg
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
endif|#
directive|endif
comment|/* DRIVER_TEST_UNIX */
block|}
block|}
else|else
block|{
ifdef|#
directive|ifdef
name|DRIVER_TEST_UNIX
name|struct
name|stat
name|st
decl_stmt|;
name|os_memset
argument_list|(
operator|&
name|addr_un
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|addr_un
argument_list|)
argument_list|)
expr_stmt|;
name|addr_un
operator|.
name|sun_family
operator|=
name|AF_UNIX
expr_stmt|;
name|os_snprintf
argument_list|(
name|addr_un
operator|.
name|sun_path
argument_list|,
sizeof|sizeof
argument_list|(
name|addr_un
operator|.
name|sun_path
argument_list|)
argument_list|,
literal|"%s/STA-"
name|MACSTR
argument_list|,
name|drv
operator|->
name|test_dir
argument_list|,
name|MAC2STR
argument_list|(
name|dest
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|stat
argument_list|(
name|addr_un
operator|.
name|sun_path
argument_list|,
operator|&
name|st
argument_list|)
operator|<
literal|0
condition|)
block|{
name|os_snprintf
argument_list|(
name|addr_un
operator|.
name|sun_path
argument_list|,
sizeof|sizeof
argument_list|(
name|addr_un
operator|.
name|sun_path
argument_list|)
argument_list|,
literal|"%s/AP-"
name|MACSTR
argument_list|,
name|drv
operator|->
name|test_dir
argument_list|,
name|MAC2STR
argument_list|(
name|dest
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|addr
operator|=
operator|(
expr|struct
name|sockaddr
operator|*
operator|)
operator|&
name|addr_un
expr_stmt|;
name|alen
operator|=
sizeof|sizeof
argument_list|(
name|addr_un
argument_list|)
expr_stmt|;
else|#
directive|else
comment|/* DRIVER_TEST_UNIX */
name|os_free
argument_list|(
name|msg
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
endif|#
directive|endif
comment|/* DRIVER_TEST_UNIX */
block|}
if|if
condition|(
name|sendto
argument_list|(
name|drv
operator|->
name|test_socket
argument_list|,
name|msg
argument_list|,
name|msg_len
argument_list|,
literal|0
argument_list|,
name|addr
argument_list|,
name|alen
argument_list|)
operator|<
literal|0
condition|)
block|{
name|perror
argument_list|(
literal|"sendmsg(test_socket)"
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|msg
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|os_free
argument_list|(
name|msg
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|wpa_driver_test_get_capa
parameter_list|(
name|void
modifier|*
name|priv
parameter_list|,
name|struct
name|wpa_driver_capa
modifier|*
name|capa
parameter_list|)
block|{
name|struct
name|test_driver_bss
modifier|*
name|dbss
init|=
name|priv
decl_stmt|;
name|struct
name|wpa_driver_test_data
modifier|*
name|drv
init|=
name|dbss
operator|->
name|drv
decl_stmt|;
name|os_memset
argument_list|(
name|capa
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|capa
argument_list|)
argument_list|)
expr_stmt|;
name|capa
operator|->
name|key_mgmt
operator|=
name|WPA_DRIVER_CAPA_KEY_MGMT_WPA
operator||
name|WPA_DRIVER_CAPA_KEY_MGMT_WPA2
operator||
name|WPA_DRIVER_CAPA_KEY_MGMT_WPA_PSK
operator||
name|WPA_DRIVER_CAPA_KEY_MGMT_WPA2_PSK
operator||
name|WPA_DRIVER_CAPA_KEY_MGMT_WPA_NONE
operator||
name|WPA_DRIVER_CAPA_KEY_MGMT_FT
operator||
name|WPA_DRIVER_CAPA_KEY_MGMT_FT_PSK
expr_stmt|;
name|capa
operator|->
name|enc
operator|=
name|WPA_DRIVER_CAPA_ENC_WEP40
operator||
name|WPA_DRIVER_CAPA_ENC_WEP104
operator||
name|WPA_DRIVER_CAPA_ENC_TKIP
operator||
name|WPA_DRIVER_CAPA_ENC_CCMP
expr_stmt|;
name|capa
operator|->
name|auth
operator|=
name|WPA_DRIVER_AUTH_OPEN
operator||
name|WPA_DRIVER_AUTH_SHARED
operator||
name|WPA_DRIVER_AUTH_LEAP
expr_stmt|;
if|if
condition|(
name|drv
operator|->
name|use_mlme
condition|)
name|capa
operator|->
name|flags
operator||=
name|WPA_DRIVER_FLAGS_USER_SPACE_MLME
expr_stmt|;
name|capa
operator|->
name|flags
operator||=
name|WPA_DRIVER_FLAGS_AP
expr_stmt|;
name|capa
operator|->
name|max_scan_ssids
operator|=
literal|2
expr_stmt|;
name|capa
operator|->
name|max_remain_on_chan
operator|=
literal|60000
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|wpa_driver_test_mlme_setprotection
parameter_list|(
name|void
modifier|*
name|priv
parameter_list|,
specifier|const
name|u8
modifier|*
name|addr
parameter_list|,
name|int
name|protect_type
parameter_list|,
name|int
name|key_type
parameter_list|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"%s: protect_type=%d key_type=%d"
argument_list|,
name|__func__
argument_list|,
name|protect_type
argument_list|,
name|key_type
argument_list|)
expr_stmt|;
if|if
condition|(
name|addr
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"%s: addr="
name|MACSTR
argument_list|,
name|__func__
argument_list|,
name|MAC2STR
argument_list|(
name|addr
argument_list|)
argument_list|)
expr_stmt|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|wpa_driver_test_set_channel
parameter_list|(
name|void
modifier|*
name|priv
parameter_list|,
name|enum
name|hostapd_hw_mode
name|phymode
parameter_list|,
name|int
name|chan
parameter_list|,
name|int
name|freq
parameter_list|)
block|{
name|struct
name|test_driver_bss
modifier|*
name|dbss
init|=
name|priv
decl_stmt|;
name|struct
name|wpa_driver_test_data
modifier|*
name|drv
init|=
name|dbss
operator|->
name|drv
decl_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"%s: phymode=%d chan=%d freq=%d"
argument_list|,
name|__func__
argument_list|,
name|phymode
argument_list|,
name|chan
argument_list|,
name|freq
argument_list|)
expr_stmt|;
name|drv
operator|->
name|current_freq
operator|=
name|freq
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|wpa_driver_test_mlme_add_sta
parameter_list|(
name|void
modifier|*
name|priv
parameter_list|,
specifier|const
name|u8
modifier|*
name|addr
parameter_list|,
specifier|const
name|u8
modifier|*
name|supp_rates
parameter_list|,
name|size_t
name|supp_rates_len
parameter_list|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"%s: addr="
name|MACSTR
argument_list|,
name|__func__
argument_list|,
name|MAC2STR
argument_list|(
name|addr
argument_list|)
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|wpa_driver_test_mlme_remove_sta
parameter_list|(
name|void
modifier|*
name|priv
parameter_list|,
specifier|const
name|u8
modifier|*
name|addr
parameter_list|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"%s: addr="
name|MACSTR
argument_list|,
name|__func__
argument_list|,
name|MAC2STR
argument_list|(
name|addr
argument_list|)
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|wpa_driver_test_set_ssid
parameter_list|(
name|void
modifier|*
name|priv
parameter_list|,
specifier|const
name|u8
modifier|*
name|ssid
parameter_list|,
name|size_t
name|ssid_len
parameter_list|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"%s"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|wpa_driver_test_set_bssid
parameter_list|(
name|void
modifier|*
name|priv
parameter_list|,
specifier|const
name|u8
modifier|*
name|bssid
parameter_list|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"%s: bssid="
name|MACSTR
argument_list|,
name|__func__
argument_list|,
name|MAC2STR
argument_list|(
name|bssid
argument_list|)
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|void
modifier|*
name|wpa_driver_test_global_init
parameter_list|(
name|void
parameter_list|)
block|{
name|struct
name|wpa_driver_test_global
modifier|*
name|global
decl_stmt|;
name|global
operator|=
name|os_zalloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|global
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|global
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|wpa_driver_test_global_deinit
parameter_list|(
name|void
modifier|*
name|priv
parameter_list|)
block|{
name|struct
name|wpa_driver_test_global
modifier|*
name|global
init|=
name|priv
decl_stmt|;
name|os_free
argument_list|(
name|global
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|struct
name|wpa_interface_info
modifier|*
name|wpa_driver_test_get_interfaces
parameter_list|(
name|void
modifier|*
name|global_priv
parameter_list|)
block|{
comment|/* struct wpa_driver_test_global *global = priv; */
name|struct
name|wpa_interface_info
modifier|*
name|iface
decl_stmt|;
name|iface
operator|=
name|os_zalloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|iface
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|iface
operator|==
name|NULL
condition|)
return|return
name|iface
return|;
name|iface
operator|->
name|ifname
operator|=
name|os_strdup
argument_list|(
literal|"sta0"
argument_list|)
expr_stmt|;
name|iface
operator|->
name|desc
operator|=
name|os_strdup
argument_list|(
literal|"test interface 0"
argument_list|)
expr_stmt|;
name|iface
operator|->
name|drv_name
operator|=
literal|"test"
expr_stmt|;
name|iface
operator|->
name|next
operator|=
name|os_zalloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|iface
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|iface
operator|->
name|next
condition|)
block|{
name|iface
operator|->
name|next
operator|->
name|ifname
operator|=
name|os_strdup
argument_list|(
literal|"sta1"
argument_list|)
expr_stmt|;
name|iface
operator|->
name|next
operator|->
name|desc
operator|=
name|os_strdup
argument_list|(
literal|"test interface 1"
argument_list|)
expr_stmt|;
name|iface
operator|->
name|next
operator|->
name|drv_name
operator|=
literal|"test"
expr_stmt|;
block|}
return|return
name|iface
return|;
block|}
end_function

begin_function
specifier|static
name|struct
name|hostapd_hw_modes
modifier|*
name|wpa_driver_test_get_hw_feature_data
parameter_list|(
name|void
modifier|*
name|priv
parameter_list|,
name|u16
modifier|*
name|num_modes
parameter_list|,
name|u16
modifier|*
name|flags
parameter_list|)
block|{
name|struct
name|hostapd_hw_modes
modifier|*
name|modes
decl_stmt|;
name|size_t
name|i
decl_stmt|;
operator|*
name|num_modes
operator|=
literal|3
expr_stmt|;
operator|*
name|flags
operator|=
literal|0
expr_stmt|;
name|modes
operator|=
name|os_zalloc
argument_list|(
operator|*
name|num_modes
operator|*
sizeof|sizeof
argument_list|(
expr|struct
name|hostapd_hw_modes
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|modes
operator|==
name|NULL
condition|)
return|return
name|NULL
return|;
name|modes
index|[
literal|0
index|]
operator|.
name|mode
operator|=
name|HOSTAPD_MODE_IEEE80211G
expr_stmt|;
name|modes
index|[
literal|0
index|]
operator|.
name|num_channels
operator|=
literal|11
expr_stmt|;
name|modes
index|[
literal|0
index|]
operator|.
name|num_rates
operator|=
literal|12
expr_stmt|;
name|modes
index|[
literal|0
index|]
operator|.
name|channels
operator|=
name|os_zalloc
argument_list|(
literal|11
operator|*
sizeof|sizeof
argument_list|(
expr|struct
name|hostapd_channel_data
argument_list|)
argument_list|)
expr_stmt|;
name|modes
index|[
literal|0
index|]
operator|.
name|rates
operator|=
name|os_zalloc
argument_list|(
name|modes
index|[
literal|0
index|]
operator|.
name|num_rates
operator|*
sizeof|sizeof
argument_list|(
name|int
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|modes
index|[
literal|0
index|]
operator|.
name|channels
operator|==
name|NULL
operator|||
name|modes
index|[
literal|0
index|]
operator|.
name|rates
operator|==
name|NULL
condition|)
goto|goto
name|fail
goto|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|11
condition|;
name|i
operator|++
control|)
block|{
name|modes
index|[
literal|0
index|]
operator|.
name|channels
index|[
name|i
index|]
operator|.
name|chan
operator|=
name|i
operator|+
literal|1
expr_stmt|;
name|modes
index|[
literal|0
index|]
operator|.
name|channels
index|[
name|i
index|]
operator|.
name|freq
operator|=
literal|2412
operator|+
literal|5
operator|*
name|i
expr_stmt|;
name|modes
index|[
literal|0
index|]
operator|.
name|channels
index|[
name|i
index|]
operator|.
name|flag
operator|=
literal|0
expr_stmt|;
block|}
name|modes
index|[
literal|0
index|]
operator|.
name|rates
index|[
literal|0
index|]
operator|=
literal|10
expr_stmt|;
name|modes
index|[
literal|0
index|]
operator|.
name|rates
index|[
literal|1
index|]
operator|=
literal|20
expr_stmt|;
name|modes
index|[
literal|0
index|]
operator|.
name|rates
index|[
literal|2
index|]
operator|=
literal|55
expr_stmt|;
name|modes
index|[
literal|0
index|]
operator|.
name|rates
index|[
literal|3
index|]
operator|=
literal|110
expr_stmt|;
name|modes
index|[
literal|0
index|]
operator|.
name|rates
index|[
literal|4
index|]
operator|=
literal|60
expr_stmt|;
name|modes
index|[
literal|0
index|]
operator|.
name|rates
index|[
literal|5
index|]
operator|=
literal|90
expr_stmt|;
name|modes
index|[
literal|0
index|]
operator|.
name|rates
index|[
literal|6
index|]
operator|=
literal|120
expr_stmt|;
name|modes
index|[
literal|0
index|]
operator|.
name|rates
index|[
literal|7
index|]
operator|=
literal|180
expr_stmt|;
name|modes
index|[
literal|0
index|]
operator|.
name|rates
index|[
literal|8
index|]
operator|=
literal|240
expr_stmt|;
name|modes
index|[
literal|0
index|]
operator|.
name|rates
index|[
literal|9
index|]
operator|=
literal|360
expr_stmt|;
name|modes
index|[
literal|0
index|]
operator|.
name|rates
index|[
literal|10
index|]
operator|=
literal|480
expr_stmt|;
name|modes
index|[
literal|0
index|]
operator|.
name|rates
index|[
literal|11
index|]
operator|=
literal|540
expr_stmt|;
name|modes
index|[
literal|1
index|]
operator|.
name|mode
operator|=
name|HOSTAPD_MODE_IEEE80211B
expr_stmt|;
name|modes
index|[
literal|1
index|]
operator|.
name|num_channels
operator|=
literal|11
expr_stmt|;
name|modes
index|[
literal|1
index|]
operator|.
name|num_rates
operator|=
literal|4
expr_stmt|;
name|modes
index|[
literal|1
index|]
operator|.
name|channels
operator|=
name|os_zalloc
argument_list|(
literal|11
operator|*
sizeof|sizeof
argument_list|(
expr|struct
name|hostapd_channel_data
argument_list|)
argument_list|)
expr_stmt|;
name|modes
index|[
literal|1
index|]
operator|.
name|rates
operator|=
name|os_zalloc
argument_list|(
name|modes
index|[
literal|1
index|]
operator|.
name|num_rates
operator|*
sizeof|sizeof
argument_list|(
name|int
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|modes
index|[
literal|1
index|]
operator|.
name|channels
operator|==
name|NULL
operator|||
name|modes
index|[
literal|1
index|]
operator|.
name|rates
operator|==
name|NULL
condition|)
goto|goto
name|fail
goto|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|11
condition|;
name|i
operator|++
control|)
block|{
name|modes
index|[
literal|1
index|]
operator|.
name|channels
index|[
name|i
index|]
operator|.
name|chan
operator|=
name|i
operator|+
literal|1
expr_stmt|;
name|modes
index|[
literal|1
index|]
operator|.
name|channels
index|[
name|i
index|]
operator|.
name|freq
operator|=
literal|2412
operator|+
literal|5
operator|*
name|i
expr_stmt|;
name|modes
index|[
literal|1
index|]
operator|.
name|channels
index|[
name|i
index|]
operator|.
name|flag
operator|=
literal|0
expr_stmt|;
block|}
name|modes
index|[
literal|1
index|]
operator|.
name|rates
index|[
literal|0
index|]
operator|=
literal|10
expr_stmt|;
name|modes
index|[
literal|1
index|]
operator|.
name|rates
index|[
literal|1
index|]
operator|=
literal|20
expr_stmt|;
name|modes
index|[
literal|1
index|]
operator|.
name|rates
index|[
literal|2
index|]
operator|=
literal|55
expr_stmt|;
name|modes
index|[
literal|1
index|]
operator|.
name|rates
index|[
literal|3
index|]
operator|=
literal|110
expr_stmt|;
name|modes
index|[
literal|2
index|]
operator|.
name|mode
operator|=
name|HOSTAPD_MODE_IEEE80211A
expr_stmt|;
name|modes
index|[
literal|2
index|]
operator|.
name|num_channels
operator|=
literal|1
expr_stmt|;
name|modes
index|[
literal|2
index|]
operator|.
name|num_rates
operator|=
literal|8
expr_stmt|;
name|modes
index|[
literal|2
index|]
operator|.
name|channels
operator|=
name|os_zalloc
argument_list|(
sizeof|sizeof
argument_list|(
expr|struct
name|hostapd_channel_data
argument_list|)
argument_list|)
expr_stmt|;
name|modes
index|[
literal|2
index|]
operator|.
name|rates
operator|=
name|os_zalloc
argument_list|(
name|modes
index|[
literal|2
index|]
operator|.
name|num_rates
operator|*
sizeof|sizeof
argument_list|(
name|int
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|modes
index|[
literal|2
index|]
operator|.
name|channels
operator|==
name|NULL
operator|||
name|modes
index|[
literal|2
index|]
operator|.
name|rates
operator|==
name|NULL
condition|)
goto|goto
name|fail
goto|;
name|modes
index|[
literal|2
index|]
operator|.
name|channels
index|[
literal|0
index|]
operator|.
name|chan
operator|=
literal|60
expr_stmt|;
name|modes
index|[
literal|2
index|]
operator|.
name|channels
index|[
literal|0
index|]
operator|.
name|freq
operator|=
literal|5300
expr_stmt|;
name|modes
index|[
literal|2
index|]
operator|.
name|channels
index|[
literal|0
index|]
operator|.
name|flag
operator|=
literal|0
expr_stmt|;
name|modes
index|[
literal|2
index|]
operator|.
name|rates
index|[
literal|0
index|]
operator|=
literal|60
expr_stmt|;
name|modes
index|[
literal|2
index|]
operator|.
name|rates
index|[
literal|1
index|]
operator|=
literal|90
expr_stmt|;
name|modes
index|[
literal|2
index|]
operator|.
name|rates
index|[
literal|2
index|]
operator|=
literal|120
expr_stmt|;
name|modes
index|[
literal|2
index|]
operator|.
name|rates
index|[
literal|3
index|]
operator|=
literal|180
expr_stmt|;
name|modes
index|[
literal|2
index|]
operator|.
name|rates
index|[
literal|4
index|]
operator|=
literal|240
expr_stmt|;
name|modes
index|[
literal|2
index|]
operator|.
name|rates
index|[
literal|5
index|]
operator|=
literal|360
expr_stmt|;
name|modes
index|[
literal|2
index|]
operator|.
name|rates
index|[
literal|6
index|]
operator|=
literal|480
expr_stmt|;
name|modes
index|[
literal|2
index|]
operator|.
name|rates
index|[
literal|7
index|]
operator|=
literal|540
expr_stmt|;
return|return
name|modes
return|;
name|fail
label|:
if|if
condition|(
name|modes
condition|)
block|{
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
operator|*
name|num_modes
condition|;
name|i
operator|++
control|)
block|{
name|os_free
argument_list|(
name|modes
index|[
name|i
index|]
operator|.
name|channels
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|modes
index|[
name|i
index|]
operator|.
name|rates
argument_list|)
expr_stmt|;
block|}
name|os_free
argument_list|(
name|modes
argument_list|)
expr_stmt|;
block|}
return|return
name|NULL
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|wpa_driver_test_set_freq
parameter_list|(
name|void
modifier|*
name|priv
parameter_list|,
name|struct
name|hostapd_freq_params
modifier|*
name|freq
parameter_list|)
block|{
name|struct
name|test_driver_bss
modifier|*
name|dbss
init|=
name|priv
decl_stmt|;
name|struct
name|wpa_driver_test_data
modifier|*
name|drv
init|=
name|dbss
operator|->
name|drv
decl_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"test: set_freq %u MHz"
argument_list|,
name|freq
operator|->
name|freq
argument_list|)
expr_stmt|;
name|drv
operator|->
name|current_freq
operator|=
name|freq
operator|->
name|freq
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|wpa_driver_test_send_action
parameter_list|(
name|void
modifier|*
name|priv
parameter_list|,
name|unsigned
name|int
name|freq
parameter_list|,
specifier|const
name|u8
modifier|*
name|dst
parameter_list|,
specifier|const
name|u8
modifier|*
name|src
parameter_list|,
specifier|const
name|u8
modifier|*
name|bssid
parameter_list|,
specifier|const
name|u8
modifier|*
name|data
parameter_list|,
name|size_t
name|data_len
parameter_list|)
block|{
name|struct
name|test_driver_bss
modifier|*
name|dbss
init|=
name|priv
decl_stmt|;
name|struct
name|wpa_driver_test_data
modifier|*
name|drv
init|=
name|dbss
operator|->
name|drv
decl_stmt|;
name|int
name|ret
init|=
operator|-
literal|1
decl_stmt|;
name|u8
modifier|*
name|buf
decl_stmt|;
name|struct
name|ieee80211_hdr
modifier|*
name|hdr
decl_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"test: Send Action frame"
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|drv
operator|->
name|remain_on_channel_freq
operator|&&
name|freq
operator|!=
name|drv
operator|->
name|remain_on_channel_freq
operator|)
operator|||
operator|(
name|drv
operator|->
name|remain_on_channel_freq
operator|==
literal|0
operator|&&
name|freq
operator|!=
operator|(
name|unsigned
name|int
operator|)
name|drv
operator|->
name|current_freq
operator|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"test: Reject Action frame TX on "
literal|"unexpected channel: freq=%u MHz (current_freq=%u "
literal|"MHz, remain-on-channel freq=%u MHz)"
argument_list|,
name|freq
argument_list|,
name|drv
operator|->
name|current_freq
argument_list|,
name|drv
operator|->
name|remain_on_channel_freq
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|buf
operator|=
name|os_zalloc
argument_list|(
literal|24
operator|+
name|data_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|buf
operator|==
name|NULL
condition|)
return|return
name|ret
return|;
name|os_memcpy
argument_list|(
name|buf
operator|+
literal|24
argument_list|,
name|data
argument_list|,
name|data_len
argument_list|)
expr_stmt|;
name|hdr
operator|=
operator|(
expr|struct
name|ieee80211_hdr
operator|*
operator|)
name|buf
expr_stmt|;
name|hdr
operator|->
name|frame_control
operator|=
name|IEEE80211_FC
argument_list|(
name|WLAN_FC_TYPE_MGMT
argument_list|,
name|WLAN_FC_STYPE_ACTION
argument_list|)
expr_stmt|;
name|os_memcpy
argument_list|(
name|hdr
operator|->
name|addr1
argument_list|,
name|dst
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
name|os_memcpy
argument_list|(
name|hdr
operator|->
name|addr2
argument_list|,
name|src
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
name|os_memcpy
argument_list|(
name|hdr
operator|->
name|addr3
argument_list|,
name|bssid
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
name|ret
operator|=
name|wpa_driver_test_send_mlme
argument_list|(
name|priv
argument_list|,
name|buf
argument_list|,
literal|24
operator|+
name|data_len
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|buf
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|test_remain_on_channel_timeout
parameter_list|(
name|void
modifier|*
name|eloop_ctx
parameter_list|,
name|void
modifier|*
name|timeout_ctx
parameter_list|)
block|{
name|struct
name|wpa_driver_test_data
modifier|*
name|drv
init|=
name|eloop_ctx
decl_stmt|;
name|union
name|wpa_event_data
name|data
decl_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"test: Remain-on-channel timeout"
argument_list|)
expr_stmt|;
name|os_memset
argument_list|(
operator|&
name|data
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|data
argument_list|)
argument_list|)
expr_stmt|;
name|data
operator|.
name|remain_on_channel
operator|.
name|freq
operator|=
name|drv
operator|->
name|remain_on_channel_freq
expr_stmt|;
name|data
operator|.
name|remain_on_channel
operator|.
name|duration
operator|=
name|drv
operator|->
name|remain_on_channel_duration
expr_stmt|;
name|wpa_supplicant_event
argument_list|(
name|drv
operator|->
name|ctx
argument_list|,
name|EVENT_CANCEL_REMAIN_ON_CHANNEL
argument_list|,
operator|&
name|data
argument_list|)
expr_stmt|;
name|drv
operator|->
name|remain_on_channel_freq
operator|=
literal|0
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|wpa_driver_test_remain_on_channel
parameter_list|(
name|void
modifier|*
name|priv
parameter_list|,
name|unsigned
name|int
name|freq
parameter_list|,
name|unsigned
name|int
name|duration
parameter_list|)
block|{
name|struct
name|test_driver_bss
modifier|*
name|dbss
init|=
name|priv
decl_stmt|;
name|struct
name|wpa_driver_test_data
modifier|*
name|drv
init|=
name|dbss
operator|->
name|drv
decl_stmt|;
name|union
name|wpa_event_data
name|data
decl_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"%s(freq=%u, duration=%u)"
argument_list|,
name|__func__
argument_list|,
name|freq
argument_list|,
name|duration
argument_list|)
expr_stmt|;
if|if
condition|(
name|drv
operator|->
name|remain_on_channel_freq
operator|&&
name|drv
operator|->
name|remain_on_channel_freq
operator|!=
name|freq
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"test: Refuse concurrent "
literal|"remain_on_channel request"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|drv
operator|->
name|remain_on_channel_freq
operator|=
name|freq
expr_stmt|;
name|drv
operator|->
name|remain_on_channel_duration
operator|=
name|duration
expr_stmt|;
name|eloop_cancel_timeout
argument_list|(
name|test_remain_on_channel_timeout
argument_list|,
name|drv
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|eloop_register_timeout
argument_list|(
name|duration
operator|/
literal|1000
argument_list|,
operator|(
name|duration
operator|%
literal|1000
operator|)
operator|*
literal|1000
argument_list|,
name|test_remain_on_channel_timeout
argument_list|,
name|drv
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|os_memset
argument_list|(
operator|&
name|data
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|data
argument_list|)
argument_list|)
expr_stmt|;
name|data
operator|.
name|remain_on_channel
operator|.
name|freq
operator|=
name|freq
expr_stmt|;
name|data
operator|.
name|remain_on_channel
operator|.
name|duration
operator|=
name|duration
expr_stmt|;
name|wpa_supplicant_event
argument_list|(
name|drv
operator|->
name|ctx
argument_list|,
name|EVENT_REMAIN_ON_CHANNEL
argument_list|,
operator|&
name|data
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|wpa_driver_test_cancel_remain_on_channel
parameter_list|(
name|void
modifier|*
name|priv
parameter_list|)
block|{
name|struct
name|test_driver_bss
modifier|*
name|dbss
init|=
name|priv
decl_stmt|;
name|struct
name|wpa_driver_test_data
modifier|*
name|drv
init|=
name|dbss
operator|->
name|drv
decl_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"%s"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|drv
operator|->
name|remain_on_channel_freq
condition|)
return|return
operator|-
literal|1
return|;
name|drv
operator|->
name|remain_on_channel_freq
operator|=
literal|0
expr_stmt|;
name|eloop_cancel_timeout
argument_list|(
name|test_remain_on_channel_timeout
argument_list|,
name|drv
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|wpa_driver_test_probe_req_report
parameter_list|(
name|void
modifier|*
name|priv
parameter_list|,
name|int
name|report
parameter_list|)
block|{
name|struct
name|test_driver_bss
modifier|*
name|dbss
init|=
name|priv
decl_stmt|;
name|struct
name|wpa_driver_test_data
modifier|*
name|drv
init|=
name|dbss
operator|->
name|drv
decl_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"%s(report=%d)"
argument_list|,
name|__func__
argument_list|,
name|report
argument_list|)
expr_stmt|;
name|drv
operator|->
name|probe_req_report
operator|=
name|report
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_decl_stmt
specifier|const
name|struct
name|wpa_driver_ops
name|wpa_driver_test_ops
init|=
block|{
literal|"test"
block|,
literal|"wpa_supplicant test driver"
block|,
operator|.
name|hapd_init
operator|=
name|test_driver_init
block|,
operator|.
name|hapd_deinit
operator|=
name|wpa_driver_test_deinit
block|,
operator|.
name|hapd_send_eapol
operator|=
name|test_driver_send_eapol
block|,
operator|.
name|send_mlme
operator|=
name|wpa_driver_test_send_mlme
block|,
operator|.
name|set_generic_elem
operator|=
name|test_driver_set_generic_elem
block|,
operator|.
name|sta_deauth
operator|=
name|test_driver_sta_deauth
block|,
operator|.
name|sta_disassoc
operator|=
name|test_driver_sta_disassoc
block|,
operator|.
name|get_hw_feature_data
operator|=
name|wpa_driver_test_get_hw_feature_data
block|,
operator|.
name|if_add
operator|=
name|test_driver_if_add
block|,
operator|.
name|if_remove
operator|=
name|test_driver_if_remove
block|,
operator|.
name|valid_bss_mask
operator|=
name|test_driver_valid_bss_mask
block|,
operator|.
name|hapd_set_ssid
operator|=
name|test_driver_set_ssid
block|,
operator|.
name|set_privacy
operator|=
name|test_driver_set_privacy
block|,
operator|.
name|set_sta_vlan
operator|=
name|test_driver_set_sta_vlan
block|,
operator|.
name|sta_add
operator|=
name|test_driver_sta_add
block|,
operator|.
name|send_ether
operator|=
name|test_driver_send_ether
block|,
operator|.
name|set_ap_wps_ie
operator|=
name|test_driver_set_ap_wps_ie
block|,
operator|.
name|get_bssid
operator|=
name|wpa_driver_test_get_bssid
block|,
operator|.
name|get_ssid
operator|=
name|wpa_driver_test_get_ssid
block|,
operator|.
name|set_key
operator|=
name|wpa_driver_test_set_key
block|,
operator|.
name|deinit
operator|=
name|wpa_driver_test_deinit
block|,
operator|.
name|set_param
operator|=
name|wpa_driver_test_set_param
block|,
operator|.
name|deauthenticate
operator|=
name|wpa_driver_test_deauthenticate
block|,
operator|.
name|disassociate
operator|=
name|wpa_driver_test_disassociate
block|,
operator|.
name|associate
operator|=
name|wpa_driver_test_associate
block|,
operator|.
name|get_capa
operator|=
name|wpa_driver_test_get_capa
block|,
operator|.
name|get_mac_addr
operator|=
name|wpa_driver_test_get_mac_addr
block|,
operator|.
name|send_eapol
operator|=
name|wpa_driver_test_send_eapol
block|,
operator|.
name|mlme_setprotection
operator|=
name|wpa_driver_test_mlme_setprotection
block|,
operator|.
name|set_channel
operator|=
name|wpa_driver_test_set_channel
block|,
operator|.
name|set_ssid
operator|=
name|wpa_driver_test_set_ssid
block|,
operator|.
name|set_bssid
operator|=
name|wpa_driver_test_set_bssid
block|,
operator|.
name|mlme_add_sta
operator|=
name|wpa_driver_test_mlme_add_sta
block|,
operator|.
name|mlme_remove_sta
operator|=
name|wpa_driver_test_mlme_remove_sta
block|,
operator|.
name|get_scan_results2
operator|=
name|wpa_driver_test_get_scan_results2
block|,
operator|.
name|global_init
operator|=
name|wpa_driver_test_global_init
block|,
operator|.
name|global_deinit
operator|=
name|wpa_driver_test_global_deinit
block|,
operator|.
name|init2
operator|=
name|wpa_driver_test_init2
block|,
operator|.
name|get_interfaces
operator|=
name|wpa_driver_test_get_interfaces
block|,
operator|.
name|scan2
operator|=
name|wpa_driver_test_scan
block|,
operator|.
name|set_freq
operator|=
name|wpa_driver_test_set_freq
block|,
operator|.
name|send_action
operator|=
name|wpa_driver_test_send_action
block|,
operator|.
name|remain_on_channel
operator|=
name|wpa_driver_test_remain_on_channel
block|,
operator|.
name|cancel_remain_on_channel
operator|=
name|wpa_driver_test_cancel_remain_on_channel
block|,
operator|.
name|probe_req_report
operator|=
name|wpa_driver_test_probe_req_report
block|, }
decl_stmt|;
end_decl_stmt

end_unit


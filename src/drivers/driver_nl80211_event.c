begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Driver interaction with Linux nl80211/cfg80211 - Event processing  * Copyright (c) 2002-2014, Jouni Malinen<j@w1.fi>  * Copyright (c) 2007, Johannes Berg<johannes@sipsolutions.net>  * Copyright (c) 2009-2010, Atheros Communications  *  * This software may be distributed under the terms of the BSD license.  * See README for more details.  */
end_comment

begin_include
include|#
directive|include
file|"includes.h"
end_include

begin_include
include|#
directive|include
file|<netlink/genl/genl.h>
end_include

begin_include
include|#
directive|include
file|"utils/common.h"
end_include

begin_include
include|#
directive|include
file|"utils/eloop.h"
end_include

begin_include
include|#
directive|include
file|"common/qca-vendor.h"
end_include

begin_include
include|#
directive|include
file|"common/qca-vendor-attr.h"
end_include

begin_include
include|#
directive|include
file|"common/ieee802_11_defs.h"
end_include

begin_include
include|#
directive|include
file|"common/ieee802_11_common.h"
end_include

begin_include
include|#
directive|include
file|"driver_nl80211.h"
end_include

begin_function
specifier|static
specifier|const
name|char
modifier|*
name|nl80211_command_to_string
parameter_list|(
name|enum
name|nl80211_commands
name|cmd
parameter_list|)
block|{
define|#
directive|define
name|C2S
parameter_list|(
name|x
parameter_list|)
value|case x: return #x;
switch|switch
condition|(
name|cmd
condition|)
block|{
name|C2S
argument_list|(
argument|NL80211_CMD_UNSPEC
argument_list|)
name|C2S
argument_list|(
argument|NL80211_CMD_GET_WIPHY
argument_list|)
name|C2S
argument_list|(
argument|NL80211_CMD_SET_WIPHY
argument_list|)
name|C2S
argument_list|(
argument|NL80211_CMD_NEW_WIPHY
argument_list|)
name|C2S
argument_list|(
argument|NL80211_CMD_DEL_WIPHY
argument_list|)
name|C2S
argument_list|(
argument|NL80211_CMD_GET_INTERFACE
argument_list|)
name|C2S
argument_list|(
argument|NL80211_CMD_SET_INTERFACE
argument_list|)
name|C2S
argument_list|(
argument|NL80211_CMD_NEW_INTERFACE
argument_list|)
name|C2S
argument_list|(
argument|NL80211_CMD_DEL_INTERFACE
argument_list|)
name|C2S
argument_list|(
argument|NL80211_CMD_GET_KEY
argument_list|)
name|C2S
argument_list|(
argument|NL80211_CMD_SET_KEY
argument_list|)
name|C2S
argument_list|(
argument|NL80211_CMD_NEW_KEY
argument_list|)
name|C2S
argument_list|(
argument|NL80211_CMD_DEL_KEY
argument_list|)
name|C2S
argument_list|(
argument|NL80211_CMD_GET_BEACON
argument_list|)
name|C2S
argument_list|(
argument|NL80211_CMD_SET_BEACON
argument_list|)
name|C2S
argument_list|(
argument|NL80211_CMD_START_AP
argument_list|)
name|C2S
argument_list|(
argument|NL80211_CMD_STOP_AP
argument_list|)
name|C2S
argument_list|(
argument|NL80211_CMD_GET_STATION
argument_list|)
name|C2S
argument_list|(
argument|NL80211_CMD_SET_STATION
argument_list|)
name|C2S
argument_list|(
argument|NL80211_CMD_NEW_STATION
argument_list|)
name|C2S
argument_list|(
argument|NL80211_CMD_DEL_STATION
argument_list|)
name|C2S
argument_list|(
argument|NL80211_CMD_GET_MPATH
argument_list|)
name|C2S
argument_list|(
argument|NL80211_CMD_SET_MPATH
argument_list|)
name|C2S
argument_list|(
argument|NL80211_CMD_NEW_MPATH
argument_list|)
name|C2S
argument_list|(
argument|NL80211_CMD_DEL_MPATH
argument_list|)
name|C2S
argument_list|(
argument|NL80211_CMD_SET_BSS
argument_list|)
name|C2S
argument_list|(
argument|NL80211_CMD_SET_REG
argument_list|)
name|C2S
argument_list|(
argument|NL80211_CMD_REQ_SET_REG
argument_list|)
name|C2S
argument_list|(
argument|NL80211_CMD_GET_MESH_CONFIG
argument_list|)
name|C2S
argument_list|(
argument|NL80211_CMD_SET_MESH_CONFIG
argument_list|)
name|C2S
argument_list|(
argument|NL80211_CMD_SET_MGMT_EXTRA_IE
argument_list|)
name|C2S
argument_list|(
argument|NL80211_CMD_GET_REG
argument_list|)
name|C2S
argument_list|(
argument|NL80211_CMD_GET_SCAN
argument_list|)
name|C2S
argument_list|(
argument|NL80211_CMD_TRIGGER_SCAN
argument_list|)
name|C2S
argument_list|(
argument|NL80211_CMD_NEW_SCAN_RESULTS
argument_list|)
name|C2S
argument_list|(
argument|NL80211_CMD_SCAN_ABORTED
argument_list|)
name|C2S
argument_list|(
argument|NL80211_CMD_REG_CHANGE
argument_list|)
name|C2S
argument_list|(
argument|NL80211_CMD_AUTHENTICATE
argument_list|)
name|C2S
argument_list|(
argument|NL80211_CMD_ASSOCIATE
argument_list|)
name|C2S
argument_list|(
argument|NL80211_CMD_DEAUTHENTICATE
argument_list|)
name|C2S
argument_list|(
argument|NL80211_CMD_DISASSOCIATE
argument_list|)
name|C2S
argument_list|(
argument|NL80211_CMD_MICHAEL_MIC_FAILURE
argument_list|)
name|C2S
argument_list|(
argument|NL80211_CMD_REG_BEACON_HINT
argument_list|)
name|C2S
argument_list|(
argument|NL80211_CMD_JOIN_IBSS
argument_list|)
name|C2S
argument_list|(
argument|NL80211_CMD_LEAVE_IBSS
argument_list|)
name|C2S
argument_list|(
argument|NL80211_CMD_TESTMODE
argument_list|)
name|C2S
argument_list|(
argument|NL80211_CMD_CONNECT
argument_list|)
name|C2S
argument_list|(
argument|NL80211_CMD_ROAM
argument_list|)
name|C2S
argument_list|(
argument|NL80211_CMD_DISCONNECT
argument_list|)
name|C2S
argument_list|(
argument|NL80211_CMD_SET_WIPHY_NETNS
argument_list|)
name|C2S
argument_list|(
argument|NL80211_CMD_GET_SURVEY
argument_list|)
name|C2S
argument_list|(
argument|NL80211_CMD_NEW_SURVEY_RESULTS
argument_list|)
name|C2S
argument_list|(
argument|NL80211_CMD_SET_PMKSA
argument_list|)
name|C2S
argument_list|(
argument|NL80211_CMD_DEL_PMKSA
argument_list|)
name|C2S
argument_list|(
argument|NL80211_CMD_FLUSH_PMKSA
argument_list|)
name|C2S
argument_list|(
argument|NL80211_CMD_REMAIN_ON_CHANNEL
argument_list|)
name|C2S
argument_list|(
argument|NL80211_CMD_CANCEL_REMAIN_ON_CHANNEL
argument_list|)
name|C2S
argument_list|(
argument|NL80211_CMD_SET_TX_BITRATE_MASK
argument_list|)
name|C2S
argument_list|(
argument|NL80211_CMD_REGISTER_FRAME
argument_list|)
name|C2S
argument_list|(
argument|NL80211_CMD_FRAME
argument_list|)
name|C2S
argument_list|(
argument|NL80211_CMD_FRAME_TX_STATUS
argument_list|)
name|C2S
argument_list|(
argument|NL80211_CMD_SET_POWER_SAVE
argument_list|)
name|C2S
argument_list|(
argument|NL80211_CMD_GET_POWER_SAVE
argument_list|)
name|C2S
argument_list|(
argument|NL80211_CMD_SET_CQM
argument_list|)
name|C2S
argument_list|(
argument|NL80211_CMD_NOTIFY_CQM
argument_list|)
name|C2S
argument_list|(
argument|NL80211_CMD_SET_CHANNEL
argument_list|)
name|C2S
argument_list|(
argument|NL80211_CMD_SET_WDS_PEER
argument_list|)
name|C2S
argument_list|(
argument|NL80211_CMD_FRAME_WAIT_CANCEL
argument_list|)
name|C2S
argument_list|(
argument|NL80211_CMD_JOIN_MESH
argument_list|)
name|C2S
argument_list|(
argument|NL80211_CMD_LEAVE_MESH
argument_list|)
name|C2S
argument_list|(
argument|NL80211_CMD_UNPROT_DEAUTHENTICATE
argument_list|)
name|C2S
argument_list|(
argument|NL80211_CMD_UNPROT_DISASSOCIATE
argument_list|)
name|C2S
argument_list|(
argument|NL80211_CMD_NEW_PEER_CANDIDATE
argument_list|)
name|C2S
argument_list|(
argument|NL80211_CMD_GET_WOWLAN
argument_list|)
name|C2S
argument_list|(
argument|NL80211_CMD_SET_WOWLAN
argument_list|)
name|C2S
argument_list|(
argument|NL80211_CMD_START_SCHED_SCAN
argument_list|)
name|C2S
argument_list|(
argument|NL80211_CMD_STOP_SCHED_SCAN
argument_list|)
name|C2S
argument_list|(
argument|NL80211_CMD_SCHED_SCAN_RESULTS
argument_list|)
name|C2S
argument_list|(
argument|NL80211_CMD_SCHED_SCAN_STOPPED
argument_list|)
name|C2S
argument_list|(
argument|NL80211_CMD_SET_REKEY_OFFLOAD
argument_list|)
name|C2S
argument_list|(
argument|NL80211_CMD_PMKSA_CANDIDATE
argument_list|)
name|C2S
argument_list|(
argument|NL80211_CMD_TDLS_OPER
argument_list|)
name|C2S
argument_list|(
argument|NL80211_CMD_TDLS_MGMT
argument_list|)
name|C2S
argument_list|(
argument|NL80211_CMD_UNEXPECTED_FRAME
argument_list|)
name|C2S
argument_list|(
argument|NL80211_CMD_PROBE_CLIENT
argument_list|)
name|C2S
argument_list|(
argument|NL80211_CMD_REGISTER_BEACONS
argument_list|)
name|C2S
argument_list|(
argument|NL80211_CMD_UNEXPECTED_4ADDR_FRAME
argument_list|)
name|C2S
argument_list|(
argument|NL80211_CMD_SET_NOACK_MAP
argument_list|)
name|C2S
argument_list|(
argument|NL80211_CMD_CH_SWITCH_NOTIFY
argument_list|)
name|C2S
argument_list|(
argument|NL80211_CMD_START_P2P_DEVICE
argument_list|)
name|C2S
argument_list|(
argument|NL80211_CMD_STOP_P2P_DEVICE
argument_list|)
name|C2S
argument_list|(
argument|NL80211_CMD_CONN_FAILED
argument_list|)
name|C2S
argument_list|(
argument|NL80211_CMD_SET_MCAST_RATE
argument_list|)
name|C2S
argument_list|(
argument|NL80211_CMD_SET_MAC_ACL
argument_list|)
name|C2S
argument_list|(
argument|NL80211_CMD_RADAR_DETECT
argument_list|)
name|C2S
argument_list|(
argument|NL80211_CMD_GET_PROTOCOL_FEATURES
argument_list|)
name|C2S
argument_list|(
argument|NL80211_CMD_UPDATE_FT_IES
argument_list|)
name|C2S
argument_list|(
argument|NL80211_CMD_FT_EVENT
argument_list|)
name|C2S
argument_list|(
argument|NL80211_CMD_CRIT_PROTOCOL_START
argument_list|)
name|C2S
argument_list|(
argument|NL80211_CMD_CRIT_PROTOCOL_STOP
argument_list|)
name|C2S
argument_list|(
argument|NL80211_CMD_GET_COALESCE
argument_list|)
name|C2S
argument_list|(
argument|NL80211_CMD_SET_COALESCE
argument_list|)
name|C2S
argument_list|(
argument|NL80211_CMD_CHANNEL_SWITCH
argument_list|)
name|C2S
argument_list|(
argument|NL80211_CMD_VENDOR
argument_list|)
name|C2S
argument_list|(
argument|NL80211_CMD_SET_QOS_MAP
argument_list|)
name|C2S
argument_list|(
argument|NL80211_CMD_ADD_TX_TS
argument_list|)
name|C2S
argument_list|(
argument|NL80211_CMD_DEL_TX_TS
argument_list|)
default|default:
return|return
literal|"NL80211_CMD_UNKNOWN"
return|;
block|}
undef|#
directive|undef
name|C2S
block|}
end_function

begin_function
specifier|static
name|void
name|mlme_event_auth
parameter_list|(
name|struct
name|wpa_driver_nl80211_data
modifier|*
name|drv
parameter_list|,
specifier|const
name|u8
modifier|*
name|frame
parameter_list|,
name|size_t
name|len
parameter_list|)
block|{
specifier|const
name|struct
name|ieee80211_mgmt
modifier|*
name|mgmt
decl_stmt|;
name|union
name|wpa_event_data
name|event
decl_stmt|;
if|if
condition|(
operator|!
operator|(
name|drv
operator|->
name|capa
operator|.
name|flags
operator|&
name|WPA_DRIVER_FLAGS_SME
operator|)
operator|&&
name|drv
operator|->
name|force_connect_cmd
condition|)
block|{
comment|/* 		 * Avoid reporting two association events that would confuse 		 * the core code. 		 */
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"nl80211: Ignore auth event when using driver SME"
argument_list|)
expr_stmt|;
return|return;
block|}
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"nl80211: Authenticate event"
argument_list|)
expr_stmt|;
name|mgmt
operator|=
operator|(
specifier|const
expr|struct
name|ieee80211_mgmt
operator|*
operator|)
name|frame
expr_stmt|;
if|if
condition|(
name|len
operator|<
literal|24
operator|+
sizeof|sizeof
argument_list|(
name|mgmt
operator|->
name|u
operator|.
name|auth
argument_list|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"nl80211: Too short association event "
literal|"frame"
argument_list|)
expr_stmt|;
return|return;
block|}
name|os_memcpy
argument_list|(
name|drv
operator|->
name|auth_bssid
argument_list|,
name|mgmt
operator|->
name|sa
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
name|os_memset
argument_list|(
name|drv
operator|->
name|auth_attempt_bssid
argument_list|,
literal|0
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
name|os_memset
argument_list|(
operator|&
name|event
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|event
argument_list|)
argument_list|)
expr_stmt|;
name|os_memcpy
argument_list|(
name|event
operator|.
name|auth
operator|.
name|peer
argument_list|,
name|mgmt
operator|->
name|sa
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
name|event
operator|.
name|auth
operator|.
name|auth_type
operator|=
name|le_to_host16
argument_list|(
name|mgmt
operator|->
name|u
operator|.
name|auth
operator|.
name|auth_alg
argument_list|)
expr_stmt|;
name|event
operator|.
name|auth
operator|.
name|auth_transaction
operator|=
name|le_to_host16
argument_list|(
name|mgmt
operator|->
name|u
operator|.
name|auth
operator|.
name|auth_transaction
argument_list|)
expr_stmt|;
name|event
operator|.
name|auth
operator|.
name|status_code
operator|=
name|le_to_host16
argument_list|(
name|mgmt
operator|->
name|u
operator|.
name|auth
operator|.
name|status_code
argument_list|)
expr_stmt|;
if|if
condition|(
name|len
operator|>
literal|24
operator|+
sizeof|sizeof
argument_list|(
name|mgmt
operator|->
name|u
operator|.
name|auth
argument_list|)
condition|)
block|{
name|event
operator|.
name|auth
operator|.
name|ies
operator|=
name|mgmt
operator|->
name|u
operator|.
name|auth
operator|.
name|variable
expr_stmt|;
name|event
operator|.
name|auth
operator|.
name|ies_len
operator|=
name|len
operator|-
literal|24
operator|-
sizeof|sizeof
argument_list|(
name|mgmt
operator|->
name|u
operator|.
name|auth
argument_list|)
expr_stmt|;
block|}
name|wpa_supplicant_event
argument_list|(
name|drv
operator|->
name|ctx
argument_list|,
name|EVENT_AUTH
argument_list|,
operator|&
name|event
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|nl80211_parse_wmm_params
parameter_list|(
name|struct
name|nlattr
modifier|*
name|wmm_attr
parameter_list|,
name|struct
name|wmm_params
modifier|*
name|wmm_params
parameter_list|)
block|{
name|struct
name|nlattr
modifier|*
name|wmm_info
index|[
name|NL80211_STA_WME_MAX
operator|+
literal|1
index|]
decl_stmt|;
specifier|static
name|struct
name|nla_policy
name|wme_policy
index|[
name|NL80211_STA_WME_MAX
operator|+
literal|1
index|]
init|=
block|{
index|[
name|NL80211_STA_WME_UAPSD_QUEUES
index|]
operator|=
block|{
operator|.
name|type
operator|=
name|NLA_U8
block|}
block|, 	}
decl_stmt|;
if|if
condition|(
operator|!
name|wmm_attr
operator|||
name|nla_parse_nested
argument_list|(
name|wmm_info
argument_list|,
name|NL80211_STA_WME_MAX
argument_list|,
name|wmm_attr
argument_list|,
name|wme_policy
argument_list|)
operator|||
operator|!
name|wmm_info
index|[
name|NL80211_STA_WME_UAPSD_QUEUES
index|]
condition|)
return|return;
name|wmm_params
operator|->
name|uapsd_queues
operator|=
name|nla_get_u8
argument_list|(
name|wmm_info
index|[
name|NL80211_STA_WME_UAPSD_QUEUES
index|]
argument_list|)
expr_stmt|;
name|wmm_params
operator|->
name|info_bitmap
operator||=
name|WMM_PARAMS_UAPSD_QUEUES_INFO
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|mlme_event_assoc
parameter_list|(
name|struct
name|wpa_driver_nl80211_data
modifier|*
name|drv
parameter_list|,
specifier|const
name|u8
modifier|*
name|frame
parameter_list|,
name|size_t
name|len
parameter_list|,
name|struct
name|nlattr
modifier|*
name|wmm
parameter_list|)
block|{
specifier|const
name|struct
name|ieee80211_mgmt
modifier|*
name|mgmt
decl_stmt|;
name|union
name|wpa_event_data
name|event
decl_stmt|;
name|u16
name|status
decl_stmt|;
if|if
condition|(
operator|!
operator|(
name|drv
operator|->
name|capa
operator|.
name|flags
operator|&
name|WPA_DRIVER_FLAGS_SME
operator|)
operator|&&
name|drv
operator|->
name|force_connect_cmd
condition|)
block|{
comment|/* 		 * Avoid reporting two association events that would confuse 		 * the core code. 		 */
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"nl80211: Ignore assoc event when using driver SME"
argument_list|)
expr_stmt|;
return|return;
block|}
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"nl80211: Associate event"
argument_list|)
expr_stmt|;
name|mgmt
operator|=
operator|(
specifier|const
expr|struct
name|ieee80211_mgmt
operator|*
operator|)
name|frame
expr_stmt|;
if|if
condition|(
name|len
operator|<
literal|24
operator|+
sizeof|sizeof
argument_list|(
name|mgmt
operator|->
name|u
operator|.
name|assoc_resp
argument_list|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"nl80211: Too short association event "
literal|"frame"
argument_list|)
expr_stmt|;
return|return;
block|}
name|status
operator|=
name|le_to_host16
argument_list|(
name|mgmt
operator|->
name|u
operator|.
name|assoc_resp
operator|.
name|status_code
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|WLAN_STATUS_SUCCESS
condition|)
block|{
name|os_memset
argument_list|(
operator|&
name|event
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|event
argument_list|)
argument_list|)
expr_stmt|;
name|event
operator|.
name|assoc_reject
operator|.
name|bssid
operator|=
name|mgmt
operator|->
name|bssid
expr_stmt|;
if|if
condition|(
name|len
operator|>
literal|24
operator|+
sizeof|sizeof
argument_list|(
name|mgmt
operator|->
name|u
operator|.
name|assoc_resp
argument_list|)
condition|)
block|{
name|event
operator|.
name|assoc_reject
operator|.
name|resp_ies
operator|=
operator|(
name|u8
operator|*
operator|)
name|mgmt
operator|->
name|u
operator|.
name|assoc_resp
operator|.
name|variable
expr_stmt|;
name|event
operator|.
name|assoc_reject
operator|.
name|resp_ies_len
operator|=
name|len
operator|-
literal|24
operator|-
sizeof|sizeof
argument_list|(
name|mgmt
operator|->
name|u
operator|.
name|assoc_resp
argument_list|)
expr_stmt|;
block|}
name|event
operator|.
name|assoc_reject
operator|.
name|status_code
operator|=
name|status
expr_stmt|;
name|wpa_supplicant_event
argument_list|(
name|drv
operator|->
name|ctx
argument_list|,
name|EVENT_ASSOC_REJECT
argument_list|,
operator|&
name|event
argument_list|)
expr_stmt|;
return|return;
block|}
name|drv
operator|->
name|associated
operator|=
literal|1
expr_stmt|;
name|os_memcpy
argument_list|(
name|drv
operator|->
name|bssid
argument_list|,
name|mgmt
operator|->
name|sa
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
name|os_memcpy
argument_list|(
name|drv
operator|->
name|prev_bssid
argument_list|,
name|mgmt
operator|->
name|sa
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
name|os_memset
argument_list|(
operator|&
name|event
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|event
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|len
operator|>
literal|24
operator|+
sizeof|sizeof
argument_list|(
name|mgmt
operator|->
name|u
operator|.
name|assoc_resp
argument_list|)
condition|)
block|{
name|event
operator|.
name|assoc_info
operator|.
name|resp_ies
operator|=
operator|(
name|u8
operator|*
operator|)
name|mgmt
operator|->
name|u
operator|.
name|assoc_resp
operator|.
name|variable
expr_stmt|;
name|event
operator|.
name|assoc_info
operator|.
name|resp_ies_len
operator|=
name|len
operator|-
literal|24
operator|-
sizeof|sizeof
argument_list|(
name|mgmt
operator|->
name|u
operator|.
name|assoc_resp
argument_list|)
expr_stmt|;
block|}
name|event
operator|.
name|assoc_info
operator|.
name|freq
operator|=
name|drv
operator|->
name|assoc_freq
expr_stmt|;
name|nl80211_parse_wmm_params
argument_list|(
name|wmm
argument_list|,
operator|&
name|event
operator|.
name|assoc_info
operator|.
name|wmm_params
argument_list|)
expr_stmt|;
name|wpa_supplicant_event
argument_list|(
name|drv
operator|->
name|ctx
argument_list|,
name|EVENT_ASSOC
argument_list|,
operator|&
name|event
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|mlme_event_connect
parameter_list|(
name|struct
name|wpa_driver_nl80211_data
modifier|*
name|drv
parameter_list|,
name|enum
name|nl80211_commands
name|cmd
parameter_list|,
name|struct
name|nlattr
modifier|*
name|status
parameter_list|,
name|struct
name|nlattr
modifier|*
name|addr
parameter_list|,
name|struct
name|nlattr
modifier|*
name|req_ie
parameter_list|,
name|struct
name|nlattr
modifier|*
name|resp_ie
parameter_list|,
name|struct
name|nlattr
modifier|*
name|authorized
parameter_list|,
name|struct
name|nlattr
modifier|*
name|key_replay_ctr
parameter_list|,
name|struct
name|nlattr
modifier|*
name|ptk_kck
parameter_list|,
name|struct
name|nlattr
modifier|*
name|ptk_kek
parameter_list|)
block|{
name|union
name|wpa_event_data
name|event
decl_stmt|;
specifier|const
name|u8
modifier|*
name|ssid
decl_stmt|;
name|u16
name|status_code
decl_stmt|;
if|if
condition|(
name|drv
operator|->
name|capa
operator|.
name|flags
operator|&
name|WPA_DRIVER_FLAGS_SME
condition|)
block|{
comment|/* 		 * Avoid reporting two association events that would confuse 		 * the core code. 		 */
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"nl80211: Ignore connect event (cmd=%d) "
literal|"when using userspace SME"
argument_list|,
name|cmd
argument_list|)
expr_stmt|;
return|return;
block|}
name|status_code
operator|=
name|status
condition|?
name|nla_get_u16
argument_list|(
name|status
argument_list|)
else|:
name|WLAN_STATUS_SUCCESS
expr_stmt|;
if|if
condition|(
name|cmd
operator|==
name|NL80211_CMD_CONNECT
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"nl80211: Connect event (status=%u ignore_next_local_disconnect=%d)"
argument_list|,
name|status_code
argument_list|,
name|drv
operator|->
name|ignore_next_local_disconnect
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|cmd
operator|==
name|NL80211_CMD_ROAM
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"nl80211: Roam event"
argument_list|)
expr_stmt|;
block|}
name|os_memset
argument_list|(
operator|&
name|event
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|event
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|cmd
operator|==
name|NL80211_CMD_CONNECT
operator|&&
name|status_code
operator|!=
name|WLAN_STATUS_SUCCESS
condition|)
block|{
if|if
condition|(
name|addr
condition|)
name|event
operator|.
name|assoc_reject
operator|.
name|bssid
operator|=
name|nla_data
argument_list|(
name|addr
argument_list|)
expr_stmt|;
if|if
condition|(
name|drv
operator|->
name|ignore_next_local_disconnect
condition|)
block|{
name|drv
operator|->
name|ignore_next_local_disconnect
operator|=
literal|0
expr_stmt|;
if|if
condition|(
operator|!
name|event
operator|.
name|assoc_reject
operator|.
name|bssid
operator|||
operator|(
name|os_memcmp
argument_list|(
name|event
operator|.
name|assoc_reject
operator|.
name|bssid
argument_list|,
name|drv
operator|->
name|auth_attempt_bssid
argument_list|,
name|ETH_ALEN
argument_list|)
operator|!=
literal|0
operator|)
condition|)
block|{
comment|/* 				 * Ignore the event that came without a BSSID or 				 * for the old connection since this is likely 				 * not relevant to the new Connect command. 				 */
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"nl80211: Ignore connection failure event triggered during reassociation"
argument_list|)
expr_stmt|;
return|return;
block|}
block|}
if|if
condition|(
name|resp_ie
condition|)
block|{
name|event
operator|.
name|assoc_reject
operator|.
name|resp_ies
operator|=
name|nla_data
argument_list|(
name|resp_ie
argument_list|)
expr_stmt|;
name|event
operator|.
name|assoc_reject
operator|.
name|resp_ies_len
operator|=
name|nla_len
argument_list|(
name|resp_ie
argument_list|)
expr_stmt|;
block|}
name|event
operator|.
name|assoc_reject
operator|.
name|status_code
operator|=
name|status_code
expr_stmt|;
name|wpa_supplicant_event
argument_list|(
name|drv
operator|->
name|ctx
argument_list|,
name|EVENT_ASSOC_REJECT
argument_list|,
operator|&
name|event
argument_list|)
expr_stmt|;
return|return;
block|}
name|drv
operator|->
name|associated
operator|=
literal|1
expr_stmt|;
if|if
condition|(
name|addr
condition|)
block|{
name|os_memcpy
argument_list|(
name|drv
operator|->
name|bssid
argument_list|,
name|nla_data
argument_list|(
name|addr
argument_list|)
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
name|os_memcpy
argument_list|(
name|drv
operator|->
name|prev_bssid
argument_list|,
name|drv
operator|->
name|bssid
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|req_ie
condition|)
block|{
name|event
operator|.
name|assoc_info
operator|.
name|req_ies
operator|=
name|nla_data
argument_list|(
name|req_ie
argument_list|)
expr_stmt|;
name|event
operator|.
name|assoc_info
operator|.
name|req_ies_len
operator|=
name|nla_len
argument_list|(
name|req_ie
argument_list|)
expr_stmt|;
if|if
condition|(
name|cmd
operator|==
name|NL80211_CMD_ROAM
condition|)
block|{
name|ssid
operator|=
name|nl80211_get_ie
argument_list|(
name|event
operator|.
name|assoc_info
operator|.
name|req_ies
argument_list|,
name|event
operator|.
name|assoc_info
operator|.
name|req_ies_len
argument_list|,
name|WLAN_EID_SSID
argument_list|)
expr_stmt|;
if|if
condition|(
name|ssid
operator|&&
name|ssid
index|[
literal|1
index|]
operator|>
literal|0
operator|&&
name|ssid
index|[
literal|1
index|]
operator|<=
literal|32
condition|)
block|{
name|drv
operator|->
name|ssid_len
operator|=
name|ssid
index|[
literal|1
index|]
expr_stmt|;
name|os_memcpy
argument_list|(
name|drv
operator|->
name|ssid
argument_list|,
name|ssid
operator|+
literal|2
argument_list|,
name|ssid
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
block|}
block|}
block|}
if|if
condition|(
name|resp_ie
condition|)
block|{
name|event
operator|.
name|assoc_info
operator|.
name|resp_ies
operator|=
name|nla_data
argument_list|(
name|resp_ie
argument_list|)
expr_stmt|;
name|event
operator|.
name|assoc_info
operator|.
name|resp_ies_len
operator|=
name|nla_len
argument_list|(
name|resp_ie
argument_list|)
expr_stmt|;
block|}
name|event
operator|.
name|assoc_info
operator|.
name|freq
operator|=
name|nl80211_get_assoc_freq
argument_list|(
name|drv
argument_list|)
expr_stmt|;
if|if
condition|(
name|authorized
operator|&&
name|nla_get_u8
argument_list|(
name|authorized
argument_list|)
condition|)
block|{
name|event
operator|.
name|assoc_info
operator|.
name|authorized
operator|=
literal|1
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"nl80211: connection authorized"
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|key_replay_ctr
condition|)
block|{
name|event
operator|.
name|assoc_info
operator|.
name|key_replay_ctr
operator|=
name|nla_data
argument_list|(
name|key_replay_ctr
argument_list|)
expr_stmt|;
name|event
operator|.
name|assoc_info
operator|.
name|key_replay_ctr_len
operator|=
name|nla_len
argument_list|(
name|key_replay_ctr
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|ptk_kck
condition|)
block|{
name|event
operator|.
name|assoc_info
operator|.
name|ptk_kck
operator|=
name|nla_data
argument_list|(
name|ptk_kck
argument_list|)
expr_stmt|;
name|event
operator|.
name|assoc_info
operator|.
name|ptk_kck_len
operator|=
name|nla_len
argument_list|(
name|ptk_kck
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|ptk_kek
condition|)
block|{
name|event
operator|.
name|assoc_info
operator|.
name|ptk_kek
operator|=
name|nla_data
argument_list|(
name|ptk_kek
argument_list|)
expr_stmt|;
name|event
operator|.
name|assoc_info
operator|.
name|ptk_kek_len
operator|=
name|nla_len
argument_list|(
name|ptk_kek
argument_list|)
expr_stmt|;
block|}
name|wpa_supplicant_event
argument_list|(
name|drv
operator|->
name|ctx
argument_list|,
name|EVENT_ASSOC
argument_list|,
operator|&
name|event
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|mlme_event_disconnect
parameter_list|(
name|struct
name|wpa_driver_nl80211_data
modifier|*
name|drv
parameter_list|,
name|struct
name|nlattr
modifier|*
name|reason
parameter_list|,
name|struct
name|nlattr
modifier|*
name|addr
parameter_list|,
name|struct
name|nlattr
modifier|*
name|by_ap
parameter_list|)
block|{
name|union
name|wpa_event_data
name|data
decl_stmt|;
name|unsigned
name|int
name|locally_generated
init|=
name|by_ap
operator|==
name|NULL
decl_stmt|;
if|if
condition|(
name|drv
operator|->
name|capa
operator|.
name|flags
operator|&
name|WPA_DRIVER_FLAGS_SME
condition|)
block|{
comment|/* 		 * Avoid reporting two disassociation events that could 		 * confuse the core code. 		 */
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"nl80211: Ignore disconnect "
literal|"event when using userspace SME"
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|drv
operator|->
name|ignore_next_local_disconnect
condition|)
block|{
name|drv
operator|->
name|ignore_next_local_disconnect
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|locally_generated
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"nl80211: Ignore disconnect "
literal|"event triggered during reassociation"
argument_list|)
expr_stmt|;
return|return;
block|}
name|wpa_printf
argument_list|(
name|MSG_WARNING
argument_list|,
literal|"nl80211: Was expecting local "
literal|"disconnect but got another disconnect "
literal|"event first"
argument_list|)
expr_stmt|;
block|}
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"nl80211: Disconnect event"
argument_list|)
expr_stmt|;
name|nl80211_mark_disconnected
argument_list|(
name|drv
argument_list|)
expr_stmt|;
name|os_memset
argument_list|(
operator|&
name|data
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|data
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|reason
condition|)
name|data
operator|.
name|deauth_info
operator|.
name|reason_code
operator|=
name|nla_get_u16
argument_list|(
name|reason
argument_list|)
expr_stmt|;
name|data
operator|.
name|deauth_info
operator|.
name|locally_generated
operator|=
name|by_ap
operator|==
name|NULL
expr_stmt|;
name|wpa_supplicant_event
argument_list|(
name|drv
operator|->
name|ctx
argument_list|,
name|EVENT_DEAUTH
argument_list|,
operator|&
name|data
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|calculate_chan_offset
parameter_list|(
name|int
name|width
parameter_list|,
name|int
name|freq
parameter_list|,
name|int
name|cf1
parameter_list|,
name|int
name|cf2
parameter_list|)
block|{
name|int
name|freq1
init|=
literal|0
decl_stmt|;
switch|switch
condition|(
name|convert2width
argument_list|(
name|width
argument_list|)
condition|)
block|{
case|case
name|CHAN_WIDTH_20_NOHT
case|:
case|case
name|CHAN_WIDTH_20
case|:
return|return
literal|0
return|;
case|case
name|CHAN_WIDTH_40
case|:
name|freq1
operator|=
name|cf1
operator|-
literal|10
expr_stmt|;
break|break;
case|case
name|CHAN_WIDTH_80
case|:
name|freq1
operator|=
name|cf1
operator|-
literal|30
expr_stmt|;
break|break;
case|case
name|CHAN_WIDTH_160
case|:
name|freq1
operator|=
name|cf1
operator|-
literal|70
expr_stmt|;
break|break;
case|case
name|CHAN_WIDTH_UNKNOWN
case|:
case|case
name|CHAN_WIDTH_80P80
case|:
comment|/* FIXME: implement this */
return|return
literal|0
return|;
block|}
return|return
operator|(
name|abs
argument_list|(
name|freq
operator|-
name|freq1
argument_list|)
operator|/
literal|20
operator|)
operator|%
literal|2
operator|==
literal|0
condition|?
literal|1
else|:
operator|-
literal|1
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|mlme_event_ch_switch
parameter_list|(
name|struct
name|wpa_driver_nl80211_data
modifier|*
name|drv
parameter_list|,
name|struct
name|nlattr
modifier|*
name|ifindex
parameter_list|,
name|struct
name|nlattr
modifier|*
name|freq
parameter_list|,
name|struct
name|nlattr
modifier|*
name|type
parameter_list|,
name|struct
name|nlattr
modifier|*
name|bw
parameter_list|,
name|struct
name|nlattr
modifier|*
name|cf1
parameter_list|,
name|struct
name|nlattr
modifier|*
name|cf2
parameter_list|)
block|{
name|struct
name|i802_bss
modifier|*
name|bss
decl_stmt|;
name|union
name|wpa_event_data
name|data
decl_stmt|;
name|int
name|ht_enabled
init|=
literal|1
decl_stmt|;
name|int
name|chan_offset
init|=
literal|0
decl_stmt|;
name|int
name|ifidx
decl_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"nl80211: Channel switch event"
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|freq
condition|)
return|return;
name|ifidx
operator|=
name|nla_get_u32
argument_list|(
name|ifindex
argument_list|)
expr_stmt|;
name|bss
operator|=
name|get_bss_ifindex
argument_list|(
name|drv
argument_list|,
name|ifidx
argument_list|)
expr_stmt|;
if|if
condition|(
name|bss
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_WARNING
argument_list|,
literal|"nl80211: Unknown ifindex (%d) for channel switch, ignoring"
argument_list|,
name|ifidx
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|type
condition|)
block|{
name|enum
name|nl80211_channel_type
name|ch_type
init|=
name|nla_get_u32
argument_list|(
name|type
argument_list|)
decl_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"nl80211: Channel type: %d"
argument_list|,
name|ch_type
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|ch_type
condition|)
block|{
case|case
name|NL80211_CHAN_NO_HT
case|:
name|ht_enabled
operator|=
literal|0
expr_stmt|;
break|break;
case|case
name|NL80211_CHAN_HT20
case|:
break|break;
case|case
name|NL80211_CHAN_HT40PLUS
case|:
name|chan_offset
operator|=
literal|1
expr_stmt|;
break|break;
case|case
name|NL80211_CHAN_HT40MINUS
case|:
name|chan_offset
operator|=
operator|-
literal|1
expr_stmt|;
break|break;
block|}
block|}
elseif|else
if|if
condition|(
name|bw
operator|&&
name|cf1
condition|)
block|{
comment|/* This can happen for example with VHT80 ch switch */
name|chan_offset
operator|=
name|calculate_chan_offset
argument_list|(
name|nla_get_u32
argument_list|(
name|bw
argument_list|)
argument_list|,
name|nla_get_u32
argument_list|(
name|freq
argument_list|)
argument_list|,
name|nla_get_u32
argument_list|(
name|cf1
argument_list|)
argument_list|,
name|cf2
condition|?
name|nla_get_u32
argument_list|(
name|cf2
argument_list|)
else|:
literal|0
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|wpa_printf
argument_list|(
name|MSG_WARNING
argument_list|,
literal|"nl80211: Unknown secondary channel information - following channel definition calculations may fail"
argument_list|)
expr_stmt|;
block|}
name|os_memset
argument_list|(
operator|&
name|data
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|data
argument_list|)
argument_list|)
expr_stmt|;
name|data
operator|.
name|ch_switch
operator|.
name|freq
operator|=
name|nla_get_u32
argument_list|(
name|freq
argument_list|)
expr_stmt|;
name|data
operator|.
name|ch_switch
operator|.
name|ht_enabled
operator|=
name|ht_enabled
expr_stmt|;
name|data
operator|.
name|ch_switch
operator|.
name|ch_offset
operator|=
name|chan_offset
expr_stmt|;
if|if
condition|(
name|bw
condition|)
name|data
operator|.
name|ch_switch
operator|.
name|ch_width
operator|=
name|convert2width
argument_list|(
name|nla_get_u32
argument_list|(
name|bw
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|cf1
condition|)
name|data
operator|.
name|ch_switch
operator|.
name|cf1
operator|=
name|nla_get_u32
argument_list|(
name|cf1
argument_list|)
expr_stmt|;
if|if
condition|(
name|cf2
condition|)
name|data
operator|.
name|ch_switch
operator|.
name|cf2
operator|=
name|nla_get_u32
argument_list|(
name|cf2
argument_list|)
expr_stmt|;
name|bss
operator|->
name|freq
operator|=
name|data
operator|.
name|ch_switch
operator|.
name|freq
expr_stmt|;
name|wpa_supplicant_event
argument_list|(
name|bss
operator|->
name|ctx
argument_list|,
name|EVENT_CH_SWITCH
argument_list|,
operator|&
name|data
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|mlme_timeout_event
parameter_list|(
name|struct
name|wpa_driver_nl80211_data
modifier|*
name|drv
parameter_list|,
name|enum
name|nl80211_commands
name|cmd
parameter_list|,
name|struct
name|nlattr
modifier|*
name|addr
parameter_list|)
block|{
name|union
name|wpa_event_data
name|event
decl_stmt|;
name|enum
name|wpa_event_type
name|ev
decl_stmt|;
if|if
condition|(
name|nla_len
argument_list|(
name|addr
argument_list|)
operator|!=
name|ETH_ALEN
condition|)
return|return;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"nl80211: MLME event %d; timeout with "
name|MACSTR
argument_list|,
name|cmd
argument_list|,
name|MAC2STR
argument_list|(
operator|(
name|u8
operator|*
operator|)
name|nla_data
argument_list|(
name|addr
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|cmd
operator|==
name|NL80211_CMD_AUTHENTICATE
condition|)
name|ev
operator|=
name|EVENT_AUTH_TIMED_OUT
expr_stmt|;
elseif|else
if|if
condition|(
name|cmd
operator|==
name|NL80211_CMD_ASSOCIATE
condition|)
name|ev
operator|=
name|EVENT_ASSOC_TIMED_OUT
expr_stmt|;
else|else
return|return;
name|os_memset
argument_list|(
operator|&
name|event
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|event
argument_list|)
argument_list|)
expr_stmt|;
name|os_memcpy
argument_list|(
name|event
operator|.
name|timeout_event
operator|.
name|addr
argument_list|,
name|nla_data
argument_list|(
name|addr
argument_list|)
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
name|wpa_supplicant_event
argument_list|(
name|drv
operator|->
name|ctx
argument_list|,
name|ev
argument_list|,
operator|&
name|event
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|mlme_event_mgmt
parameter_list|(
name|struct
name|i802_bss
modifier|*
name|bss
parameter_list|,
name|struct
name|nlattr
modifier|*
name|freq
parameter_list|,
name|struct
name|nlattr
modifier|*
name|sig
parameter_list|,
specifier|const
name|u8
modifier|*
name|frame
parameter_list|,
name|size_t
name|len
parameter_list|)
block|{
name|struct
name|wpa_driver_nl80211_data
modifier|*
name|drv
init|=
name|bss
operator|->
name|drv
decl_stmt|;
specifier|const
name|struct
name|ieee80211_mgmt
modifier|*
name|mgmt
decl_stmt|;
name|union
name|wpa_event_data
name|event
decl_stmt|;
name|u16
name|fc
decl_stmt|,
name|stype
decl_stmt|;
name|int
name|ssi_signal
init|=
literal|0
decl_stmt|;
name|int
name|rx_freq
init|=
literal|0
decl_stmt|;
name|wpa_printf
argument_list|(
name|MSG_MSGDUMP
argument_list|,
literal|"nl80211: Frame event"
argument_list|)
expr_stmt|;
name|mgmt
operator|=
operator|(
specifier|const
expr|struct
name|ieee80211_mgmt
operator|*
operator|)
name|frame
expr_stmt|;
if|if
condition|(
name|len
operator|<
literal|24
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"nl80211: Too short management frame"
argument_list|)
expr_stmt|;
return|return;
block|}
name|fc
operator|=
name|le_to_host16
argument_list|(
name|mgmt
operator|->
name|frame_control
argument_list|)
expr_stmt|;
name|stype
operator|=
name|WLAN_FC_GET_STYPE
argument_list|(
name|fc
argument_list|)
expr_stmt|;
if|if
condition|(
name|sig
condition|)
name|ssi_signal
operator|=
operator|(
name|s32
operator|)
name|nla_get_u32
argument_list|(
name|sig
argument_list|)
expr_stmt|;
name|os_memset
argument_list|(
operator|&
name|event
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|event
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|freq
condition|)
block|{
name|event
operator|.
name|rx_mgmt
operator|.
name|freq
operator|=
name|nla_get_u32
argument_list|(
name|freq
argument_list|)
expr_stmt|;
name|rx_freq
operator|=
name|drv
operator|->
name|last_mgmt_freq
operator|=
name|event
operator|.
name|rx_mgmt
operator|.
name|freq
expr_stmt|;
block|}
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"nl80211: RX frame sa="
name|MACSTR
literal|" freq=%d ssi_signal=%d fc=0x%x seq_ctrl=0x%x stype=%u (%s) len=%u"
argument_list|,
name|MAC2STR
argument_list|(
name|mgmt
operator|->
name|sa
argument_list|)
argument_list|,
name|rx_freq
argument_list|,
name|ssi_signal
argument_list|,
name|fc
argument_list|,
name|le_to_host16
argument_list|(
name|mgmt
operator|->
name|seq_ctrl
argument_list|)
argument_list|,
name|stype
argument_list|,
name|fc2str
argument_list|(
name|fc
argument_list|)
argument_list|,
operator|(
name|unsigned
name|int
operator|)
name|len
argument_list|)
expr_stmt|;
name|event
operator|.
name|rx_mgmt
operator|.
name|frame
operator|=
name|frame
expr_stmt|;
name|event
operator|.
name|rx_mgmt
operator|.
name|frame_len
operator|=
name|len
expr_stmt|;
name|event
operator|.
name|rx_mgmt
operator|.
name|ssi_signal
operator|=
name|ssi_signal
expr_stmt|;
name|event
operator|.
name|rx_mgmt
operator|.
name|drv_priv
operator|=
name|bss
expr_stmt|;
name|wpa_supplicant_event
argument_list|(
name|drv
operator|->
name|ctx
argument_list|,
name|EVENT_RX_MGMT
argument_list|,
operator|&
name|event
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|mlme_event_mgmt_tx_status
parameter_list|(
name|struct
name|wpa_driver_nl80211_data
modifier|*
name|drv
parameter_list|,
name|struct
name|nlattr
modifier|*
name|cookie
parameter_list|,
specifier|const
name|u8
modifier|*
name|frame
parameter_list|,
name|size_t
name|len
parameter_list|,
name|struct
name|nlattr
modifier|*
name|ack
parameter_list|)
block|{
name|union
name|wpa_event_data
name|event
decl_stmt|;
specifier|const
name|struct
name|ieee80211_hdr
modifier|*
name|hdr
decl_stmt|;
name|u16
name|fc
decl_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"nl80211: Frame TX status event"
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|is_ap_interface
argument_list|(
name|drv
operator|->
name|nlmode
argument_list|)
condition|)
block|{
name|u64
name|cookie_val
decl_stmt|;
if|if
condition|(
operator|!
name|cookie
condition|)
return|return;
name|cookie_val
operator|=
name|nla_get_u64
argument_list|(
name|cookie
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"nl80211: Action TX status:"
literal|" cookie=0%llx%s (ack=%d)"
argument_list|,
operator|(
name|long
name|long
name|unsigned
name|int
operator|)
name|cookie_val
argument_list|,
name|cookie_val
operator|==
name|drv
operator|->
name|send_action_cookie
condition|?
literal|" (match)"
else|:
literal|" (unknown)"
argument_list|,
name|ack
operator|!=
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|cookie_val
operator|!=
name|drv
operator|->
name|send_action_cookie
condition|)
return|return;
block|}
name|hdr
operator|=
operator|(
specifier|const
expr|struct
name|ieee80211_hdr
operator|*
operator|)
name|frame
expr_stmt|;
name|fc
operator|=
name|le_to_host16
argument_list|(
name|hdr
operator|->
name|frame_control
argument_list|)
expr_stmt|;
name|os_memset
argument_list|(
operator|&
name|event
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|event
argument_list|)
argument_list|)
expr_stmt|;
name|event
operator|.
name|tx_status
operator|.
name|type
operator|=
name|WLAN_FC_GET_TYPE
argument_list|(
name|fc
argument_list|)
expr_stmt|;
name|event
operator|.
name|tx_status
operator|.
name|stype
operator|=
name|WLAN_FC_GET_STYPE
argument_list|(
name|fc
argument_list|)
expr_stmt|;
name|event
operator|.
name|tx_status
operator|.
name|dst
operator|=
name|hdr
operator|->
name|addr1
expr_stmt|;
name|event
operator|.
name|tx_status
operator|.
name|data
operator|=
name|frame
expr_stmt|;
name|event
operator|.
name|tx_status
operator|.
name|data_len
operator|=
name|len
expr_stmt|;
name|event
operator|.
name|tx_status
operator|.
name|ack
operator|=
name|ack
operator|!=
name|NULL
expr_stmt|;
name|wpa_supplicant_event
argument_list|(
name|drv
operator|->
name|ctx
argument_list|,
name|EVENT_TX_STATUS
argument_list|,
operator|&
name|event
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|mlme_event_deauth_disassoc
parameter_list|(
name|struct
name|wpa_driver_nl80211_data
modifier|*
name|drv
parameter_list|,
name|enum
name|wpa_event_type
name|type
parameter_list|,
specifier|const
name|u8
modifier|*
name|frame
parameter_list|,
name|size_t
name|len
parameter_list|)
block|{
specifier|const
name|struct
name|ieee80211_mgmt
modifier|*
name|mgmt
decl_stmt|;
name|union
name|wpa_event_data
name|event
decl_stmt|;
specifier|const
name|u8
modifier|*
name|bssid
init|=
name|NULL
decl_stmt|;
name|u16
name|reason_code
init|=
literal|0
decl_stmt|;
if|if
condition|(
name|type
operator|==
name|EVENT_DEAUTH
condition|)
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"nl80211: Deauthenticate event"
argument_list|)
expr_stmt|;
else|else
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"nl80211: Disassociate event"
argument_list|)
expr_stmt|;
name|mgmt
operator|=
operator|(
specifier|const
expr|struct
name|ieee80211_mgmt
operator|*
operator|)
name|frame
expr_stmt|;
if|if
condition|(
name|len
operator|>=
literal|24
condition|)
block|{
name|bssid
operator|=
name|mgmt
operator|->
name|bssid
expr_stmt|;
if|if
condition|(
operator|(
name|drv
operator|->
name|capa
operator|.
name|flags
operator|&
name|WPA_DRIVER_FLAGS_SME
operator|)
operator|&&
operator|!
name|drv
operator|->
name|associated
operator|&&
name|os_memcmp
argument_list|(
name|bssid
argument_list|,
name|drv
operator|->
name|auth_bssid
argument_list|,
name|ETH_ALEN
argument_list|)
operator|!=
literal|0
operator|&&
name|os_memcmp
argument_list|(
name|bssid
argument_list|,
name|drv
operator|->
name|auth_attempt_bssid
argument_list|,
name|ETH_ALEN
argument_list|)
operator|!=
literal|0
operator|&&
name|os_memcmp
argument_list|(
name|bssid
argument_list|,
name|drv
operator|->
name|prev_bssid
argument_list|,
name|ETH_ALEN
argument_list|)
operator|==
literal|0
condition|)
block|{
comment|/* 			 * Avoid issues with some roaming cases where 			 * disconnection event for the old AP may show up after 			 * we have started connection with the new AP. 			 */
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"nl80211: Ignore deauth/disassoc event from old AP "
name|MACSTR
literal|" when already authenticating with "
name|MACSTR
argument_list|,
name|MAC2STR
argument_list|(
name|bssid
argument_list|)
argument_list|,
name|MAC2STR
argument_list|(
name|drv
operator|->
name|auth_attempt_bssid
argument_list|)
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|drv
operator|->
name|associated
operator|!=
literal|0
operator|&&
name|os_memcmp
argument_list|(
name|bssid
argument_list|,
name|drv
operator|->
name|bssid
argument_list|,
name|ETH_ALEN
argument_list|)
operator|!=
literal|0
operator|&&
name|os_memcmp
argument_list|(
name|bssid
argument_list|,
name|drv
operator|->
name|auth_bssid
argument_list|,
name|ETH_ALEN
argument_list|)
operator|!=
literal|0
condition|)
block|{
comment|/* 			 * We have presumably received this deauth as a 			 * response to a clear_state_mismatch() outgoing 			 * deauth.  Don't let it take us offline! 			 */
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"nl80211: Deauth received "
literal|"from Unknown BSSID "
name|MACSTR
literal|" -- ignoring"
argument_list|,
name|MAC2STR
argument_list|(
name|bssid
argument_list|)
argument_list|)
expr_stmt|;
return|return;
block|}
block|}
name|nl80211_mark_disconnected
argument_list|(
name|drv
argument_list|)
expr_stmt|;
name|os_memset
argument_list|(
operator|&
name|event
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|event
argument_list|)
argument_list|)
expr_stmt|;
comment|/* Note: Same offset for Reason Code in both frame subtypes */
if|if
condition|(
name|len
operator|>=
literal|24
operator|+
sizeof|sizeof
argument_list|(
name|mgmt
operator|->
name|u
operator|.
name|deauth
argument_list|)
condition|)
name|reason_code
operator|=
name|le_to_host16
argument_list|(
name|mgmt
operator|->
name|u
operator|.
name|deauth
operator|.
name|reason_code
argument_list|)
expr_stmt|;
if|if
condition|(
name|type
operator|==
name|EVENT_DISASSOC
condition|)
block|{
name|event
operator|.
name|disassoc_info
operator|.
name|locally_generated
operator|=
operator|!
name|os_memcmp
argument_list|(
name|mgmt
operator|->
name|sa
argument_list|,
name|drv
operator|->
name|first_bss
operator|->
name|addr
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
name|event
operator|.
name|disassoc_info
operator|.
name|addr
operator|=
name|bssid
expr_stmt|;
name|event
operator|.
name|disassoc_info
operator|.
name|reason_code
operator|=
name|reason_code
expr_stmt|;
if|if
condition|(
name|frame
operator|+
name|len
operator|>
name|mgmt
operator|->
name|u
operator|.
name|disassoc
operator|.
name|variable
condition|)
block|{
name|event
operator|.
name|disassoc_info
operator|.
name|ie
operator|=
name|mgmt
operator|->
name|u
operator|.
name|disassoc
operator|.
name|variable
expr_stmt|;
name|event
operator|.
name|disassoc_info
operator|.
name|ie_len
operator|=
name|frame
operator|+
name|len
operator|-
name|mgmt
operator|->
name|u
operator|.
name|disassoc
operator|.
name|variable
expr_stmt|;
block|}
block|}
else|else
block|{
if|if
condition|(
name|drv
operator|->
name|ignore_deauth_event
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"nl80211: Ignore deauth event due to previous forced deauth-during-auth"
argument_list|)
expr_stmt|;
name|drv
operator|->
name|ignore_deauth_event
operator|=
literal|0
expr_stmt|;
return|return;
block|}
name|event
operator|.
name|deauth_info
operator|.
name|locally_generated
operator|=
operator|!
name|os_memcmp
argument_list|(
name|mgmt
operator|->
name|sa
argument_list|,
name|drv
operator|->
name|first_bss
operator|->
name|addr
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
if|if
condition|(
name|drv
operator|->
name|ignore_next_local_deauth
condition|)
block|{
name|drv
operator|->
name|ignore_next_local_deauth
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|event
operator|.
name|deauth_info
operator|.
name|locally_generated
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"nl80211: Ignore deauth event triggered due to own deauth request"
argument_list|)
expr_stmt|;
return|return;
block|}
name|wpa_printf
argument_list|(
name|MSG_WARNING
argument_list|,
literal|"nl80211: Was expecting local deauth but got another disconnect event first"
argument_list|)
expr_stmt|;
block|}
name|event
operator|.
name|deauth_info
operator|.
name|addr
operator|=
name|bssid
expr_stmt|;
name|event
operator|.
name|deauth_info
operator|.
name|reason_code
operator|=
name|reason_code
expr_stmt|;
if|if
condition|(
name|frame
operator|+
name|len
operator|>
name|mgmt
operator|->
name|u
operator|.
name|deauth
operator|.
name|variable
condition|)
block|{
name|event
operator|.
name|deauth_info
operator|.
name|ie
operator|=
name|mgmt
operator|->
name|u
operator|.
name|deauth
operator|.
name|variable
expr_stmt|;
name|event
operator|.
name|deauth_info
operator|.
name|ie_len
operator|=
name|frame
operator|+
name|len
operator|-
name|mgmt
operator|->
name|u
operator|.
name|deauth
operator|.
name|variable
expr_stmt|;
block|}
block|}
name|wpa_supplicant_event
argument_list|(
name|drv
operator|->
name|ctx
argument_list|,
name|type
argument_list|,
operator|&
name|event
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|mlme_event_unprot_disconnect
parameter_list|(
name|struct
name|wpa_driver_nl80211_data
modifier|*
name|drv
parameter_list|,
name|enum
name|wpa_event_type
name|type
parameter_list|,
specifier|const
name|u8
modifier|*
name|frame
parameter_list|,
name|size_t
name|len
parameter_list|)
block|{
specifier|const
name|struct
name|ieee80211_mgmt
modifier|*
name|mgmt
decl_stmt|;
name|union
name|wpa_event_data
name|event
decl_stmt|;
name|u16
name|reason_code
init|=
literal|0
decl_stmt|;
if|if
condition|(
name|type
operator|==
name|EVENT_UNPROT_DEAUTH
condition|)
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"nl80211: Unprot Deauthenticate event"
argument_list|)
expr_stmt|;
else|else
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"nl80211: Unprot Disassociate event"
argument_list|)
expr_stmt|;
if|if
condition|(
name|len
operator|<
literal|24
condition|)
return|return;
name|mgmt
operator|=
operator|(
specifier|const
expr|struct
name|ieee80211_mgmt
operator|*
operator|)
name|frame
expr_stmt|;
name|os_memset
argument_list|(
operator|&
name|event
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|event
argument_list|)
argument_list|)
expr_stmt|;
comment|/* Note: Same offset for Reason Code in both frame subtypes */
if|if
condition|(
name|len
operator|>=
literal|24
operator|+
sizeof|sizeof
argument_list|(
name|mgmt
operator|->
name|u
operator|.
name|deauth
argument_list|)
condition|)
name|reason_code
operator|=
name|le_to_host16
argument_list|(
name|mgmt
operator|->
name|u
operator|.
name|deauth
operator|.
name|reason_code
argument_list|)
expr_stmt|;
if|if
condition|(
name|type
operator|==
name|EVENT_UNPROT_DISASSOC
condition|)
block|{
name|event
operator|.
name|unprot_disassoc
operator|.
name|sa
operator|=
name|mgmt
operator|->
name|sa
expr_stmt|;
name|event
operator|.
name|unprot_disassoc
operator|.
name|da
operator|=
name|mgmt
operator|->
name|da
expr_stmt|;
name|event
operator|.
name|unprot_disassoc
operator|.
name|reason_code
operator|=
name|reason_code
expr_stmt|;
block|}
else|else
block|{
name|event
operator|.
name|unprot_deauth
operator|.
name|sa
operator|=
name|mgmt
operator|->
name|sa
expr_stmt|;
name|event
operator|.
name|unprot_deauth
operator|.
name|da
operator|=
name|mgmt
operator|->
name|da
expr_stmt|;
name|event
operator|.
name|unprot_deauth
operator|.
name|reason_code
operator|=
name|reason_code
expr_stmt|;
block|}
name|wpa_supplicant_event
argument_list|(
name|drv
operator|->
name|ctx
argument_list|,
name|type
argument_list|,
operator|&
name|event
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|mlme_event
parameter_list|(
name|struct
name|i802_bss
modifier|*
name|bss
parameter_list|,
name|enum
name|nl80211_commands
name|cmd
parameter_list|,
name|struct
name|nlattr
modifier|*
name|frame
parameter_list|,
name|struct
name|nlattr
modifier|*
name|addr
parameter_list|,
name|struct
name|nlattr
modifier|*
name|timed_out
parameter_list|,
name|struct
name|nlattr
modifier|*
name|freq
parameter_list|,
name|struct
name|nlattr
modifier|*
name|ack
parameter_list|,
name|struct
name|nlattr
modifier|*
name|cookie
parameter_list|,
name|struct
name|nlattr
modifier|*
name|sig
parameter_list|,
name|struct
name|nlattr
modifier|*
name|wmm
parameter_list|)
block|{
name|struct
name|wpa_driver_nl80211_data
modifier|*
name|drv
init|=
name|bss
operator|->
name|drv
decl_stmt|;
specifier|const
name|u8
modifier|*
name|data
decl_stmt|;
name|size_t
name|len
decl_stmt|;
if|if
condition|(
name|timed_out
operator|&&
name|addr
condition|)
block|{
name|mlme_timeout_event
argument_list|(
name|drv
argument_list|,
name|cmd
argument_list|,
name|addr
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|frame
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"nl80211: MLME event %d (%s) without frame data"
argument_list|,
name|cmd
argument_list|,
name|nl80211_command_to_string
argument_list|(
name|cmd
argument_list|)
argument_list|)
expr_stmt|;
return|return;
block|}
name|data
operator|=
name|nla_data
argument_list|(
name|frame
argument_list|)
expr_stmt|;
name|len
operator|=
name|nla_len
argument_list|(
name|frame
argument_list|)
expr_stmt|;
if|if
condition|(
name|len
operator|<
literal|4
operator|+
literal|2
operator|*
name|ETH_ALEN
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_MSGDUMP
argument_list|,
literal|"nl80211: MLME event %d (%s) on %s("
name|MACSTR
literal|") - too short"
argument_list|,
name|cmd
argument_list|,
name|nl80211_command_to_string
argument_list|(
name|cmd
argument_list|)
argument_list|,
name|bss
operator|->
name|ifname
argument_list|,
name|MAC2STR
argument_list|(
name|bss
operator|->
name|addr
argument_list|)
argument_list|)
expr_stmt|;
return|return;
block|}
name|wpa_printf
argument_list|(
name|MSG_MSGDUMP
argument_list|,
literal|"nl80211: MLME event %d (%s) on %s("
name|MACSTR
literal|") A1="
name|MACSTR
literal|" A2="
name|MACSTR
argument_list|,
name|cmd
argument_list|,
name|nl80211_command_to_string
argument_list|(
name|cmd
argument_list|)
argument_list|,
name|bss
operator|->
name|ifname
argument_list|,
name|MAC2STR
argument_list|(
name|bss
operator|->
name|addr
argument_list|)
argument_list|,
name|MAC2STR
argument_list|(
name|data
operator|+
literal|4
argument_list|)
argument_list|,
name|MAC2STR
argument_list|(
name|data
operator|+
literal|4
operator|+
name|ETH_ALEN
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|cmd
operator|!=
name|NL80211_CMD_FRAME_TX_STATUS
operator|&&
operator|!
operator|(
name|data
index|[
literal|4
index|]
operator|&
literal|0x01
operator|)
operator|&&
name|os_memcmp
argument_list|(
name|bss
operator|->
name|addr
argument_list|,
name|data
operator|+
literal|4
argument_list|,
name|ETH_ALEN
argument_list|)
operator|!=
literal|0
operator|&&
name|os_memcmp
argument_list|(
name|bss
operator|->
name|addr
argument_list|,
name|data
operator|+
literal|4
operator|+
name|ETH_ALEN
argument_list|,
name|ETH_ALEN
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_MSGDUMP
argument_list|,
literal|"nl80211: %s: Ignore MLME frame event "
literal|"for foreign address"
argument_list|,
name|bss
operator|->
name|ifname
argument_list|)
expr_stmt|;
return|return;
block|}
name|wpa_hexdump
argument_list|(
name|MSG_MSGDUMP
argument_list|,
literal|"nl80211: MLME event frame"
argument_list|,
name|nla_data
argument_list|(
name|frame
argument_list|)
argument_list|,
name|nla_len
argument_list|(
name|frame
argument_list|)
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|cmd
condition|)
block|{
case|case
name|NL80211_CMD_AUTHENTICATE
case|:
name|mlme_event_auth
argument_list|(
name|drv
argument_list|,
name|nla_data
argument_list|(
name|frame
argument_list|)
argument_list|,
name|nla_len
argument_list|(
name|frame
argument_list|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|NL80211_CMD_ASSOCIATE
case|:
name|mlme_event_assoc
argument_list|(
name|drv
argument_list|,
name|nla_data
argument_list|(
name|frame
argument_list|)
argument_list|,
name|nla_len
argument_list|(
name|frame
argument_list|)
argument_list|,
name|wmm
argument_list|)
expr_stmt|;
break|break;
case|case
name|NL80211_CMD_DEAUTHENTICATE
case|:
name|mlme_event_deauth_disassoc
argument_list|(
name|drv
argument_list|,
name|EVENT_DEAUTH
argument_list|,
name|nla_data
argument_list|(
name|frame
argument_list|)
argument_list|,
name|nla_len
argument_list|(
name|frame
argument_list|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|NL80211_CMD_DISASSOCIATE
case|:
name|mlme_event_deauth_disassoc
argument_list|(
name|drv
argument_list|,
name|EVENT_DISASSOC
argument_list|,
name|nla_data
argument_list|(
name|frame
argument_list|)
argument_list|,
name|nla_len
argument_list|(
name|frame
argument_list|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|NL80211_CMD_FRAME
case|:
name|mlme_event_mgmt
argument_list|(
name|bss
argument_list|,
name|freq
argument_list|,
name|sig
argument_list|,
name|nla_data
argument_list|(
name|frame
argument_list|)
argument_list|,
name|nla_len
argument_list|(
name|frame
argument_list|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|NL80211_CMD_FRAME_TX_STATUS
case|:
name|mlme_event_mgmt_tx_status
argument_list|(
name|drv
argument_list|,
name|cookie
argument_list|,
name|nla_data
argument_list|(
name|frame
argument_list|)
argument_list|,
name|nla_len
argument_list|(
name|frame
argument_list|)
argument_list|,
name|ack
argument_list|)
expr_stmt|;
break|break;
case|case
name|NL80211_CMD_UNPROT_DEAUTHENTICATE
case|:
name|mlme_event_unprot_disconnect
argument_list|(
name|drv
argument_list|,
name|EVENT_UNPROT_DEAUTH
argument_list|,
name|nla_data
argument_list|(
name|frame
argument_list|)
argument_list|,
name|nla_len
argument_list|(
name|frame
argument_list|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|NL80211_CMD_UNPROT_DISASSOCIATE
case|:
name|mlme_event_unprot_disconnect
argument_list|(
name|drv
argument_list|,
name|EVENT_UNPROT_DISASSOC
argument_list|,
name|nla_data
argument_list|(
name|frame
argument_list|)
argument_list|,
name|nla_len
argument_list|(
name|frame
argument_list|)
argument_list|)
expr_stmt|;
break|break;
default|default:
break|break;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|mlme_event_michael_mic_failure
parameter_list|(
name|struct
name|i802_bss
modifier|*
name|bss
parameter_list|,
name|struct
name|nlattr
modifier|*
name|tb
index|[]
parameter_list|)
block|{
name|union
name|wpa_event_data
name|data
decl_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"nl80211: MLME event Michael MIC failure"
argument_list|)
expr_stmt|;
name|os_memset
argument_list|(
operator|&
name|data
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|data
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|tb
index|[
name|NL80211_ATTR_MAC
index|]
condition|)
block|{
name|wpa_hexdump
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"nl80211: Source MAC address"
argument_list|,
name|nla_data
argument_list|(
name|tb
index|[
name|NL80211_ATTR_MAC
index|]
argument_list|)
argument_list|,
name|nla_len
argument_list|(
name|tb
index|[
name|NL80211_ATTR_MAC
index|]
argument_list|)
argument_list|)
expr_stmt|;
name|data
operator|.
name|michael_mic_failure
operator|.
name|src
operator|=
name|nla_data
argument_list|(
name|tb
index|[
name|NL80211_ATTR_MAC
index|]
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|tb
index|[
name|NL80211_ATTR_KEY_SEQ
index|]
condition|)
block|{
name|wpa_hexdump
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"nl80211: TSC"
argument_list|,
name|nla_data
argument_list|(
name|tb
index|[
name|NL80211_ATTR_KEY_SEQ
index|]
argument_list|)
argument_list|,
name|nla_len
argument_list|(
name|tb
index|[
name|NL80211_ATTR_KEY_SEQ
index|]
argument_list|)
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|tb
index|[
name|NL80211_ATTR_KEY_TYPE
index|]
condition|)
block|{
name|enum
name|nl80211_key_type
name|key_type
init|=
name|nla_get_u32
argument_list|(
name|tb
index|[
name|NL80211_ATTR_KEY_TYPE
index|]
argument_list|)
decl_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"nl80211: Key Type %d"
argument_list|,
name|key_type
argument_list|)
expr_stmt|;
if|if
condition|(
name|key_type
operator|==
name|NL80211_KEYTYPE_PAIRWISE
condition|)
name|data
operator|.
name|michael_mic_failure
operator|.
name|unicast
operator|=
literal|1
expr_stmt|;
block|}
else|else
name|data
operator|.
name|michael_mic_failure
operator|.
name|unicast
operator|=
literal|1
expr_stmt|;
if|if
condition|(
name|tb
index|[
name|NL80211_ATTR_KEY_IDX
index|]
condition|)
block|{
name|u8
name|key_id
init|=
name|nla_get_u8
argument_list|(
name|tb
index|[
name|NL80211_ATTR_KEY_IDX
index|]
argument_list|)
decl_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"nl80211: Key Id %d"
argument_list|,
name|key_id
argument_list|)
expr_stmt|;
block|}
name|wpa_supplicant_event
argument_list|(
name|bss
operator|->
name|ctx
argument_list|,
name|EVENT_MICHAEL_MIC_FAILURE
argument_list|,
operator|&
name|data
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|mlme_event_join_ibss
parameter_list|(
name|struct
name|wpa_driver_nl80211_data
modifier|*
name|drv
parameter_list|,
name|struct
name|nlattr
modifier|*
name|tb
index|[]
parameter_list|)
block|{
name|unsigned
name|int
name|freq
decl_stmt|;
if|if
condition|(
name|tb
index|[
name|NL80211_ATTR_MAC
index|]
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"nl80211: No address in IBSS joined "
literal|"event"
argument_list|)
expr_stmt|;
return|return;
block|}
name|os_memcpy
argument_list|(
name|drv
operator|->
name|bssid
argument_list|,
name|nla_data
argument_list|(
name|tb
index|[
name|NL80211_ATTR_MAC
index|]
argument_list|)
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
name|drv
operator|->
name|associated
operator|=
literal|1
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"nl80211: IBSS "
name|MACSTR
literal|" joined"
argument_list|,
name|MAC2STR
argument_list|(
name|drv
operator|->
name|bssid
argument_list|)
argument_list|)
expr_stmt|;
name|freq
operator|=
name|nl80211_get_assoc_freq
argument_list|(
name|drv
argument_list|)
expr_stmt|;
if|if
condition|(
name|freq
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"nl80211: IBSS on frequency %u MHz"
argument_list|,
name|freq
argument_list|)
expr_stmt|;
name|drv
operator|->
name|first_bss
operator|->
name|freq
operator|=
name|freq
expr_stmt|;
block|}
name|wpa_supplicant_event
argument_list|(
name|drv
operator|->
name|ctx
argument_list|,
name|EVENT_ASSOC
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|mlme_event_remain_on_channel
parameter_list|(
name|struct
name|wpa_driver_nl80211_data
modifier|*
name|drv
parameter_list|,
name|int
name|cancel_event
parameter_list|,
name|struct
name|nlattr
modifier|*
name|tb
index|[]
parameter_list|)
block|{
name|unsigned
name|int
name|freq
decl_stmt|,
name|chan_type
decl_stmt|,
name|duration
decl_stmt|;
name|union
name|wpa_event_data
name|data
decl_stmt|;
name|u64
name|cookie
decl_stmt|;
if|if
condition|(
name|tb
index|[
name|NL80211_ATTR_WIPHY_FREQ
index|]
condition|)
name|freq
operator|=
name|nla_get_u32
argument_list|(
name|tb
index|[
name|NL80211_ATTR_WIPHY_FREQ
index|]
argument_list|)
expr_stmt|;
else|else
name|freq
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|tb
index|[
name|NL80211_ATTR_WIPHY_CHANNEL_TYPE
index|]
condition|)
name|chan_type
operator|=
name|nla_get_u32
argument_list|(
name|tb
index|[
name|NL80211_ATTR_WIPHY_CHANNEL_TYPE
index|]
argument_list|)
expr_stmt|;
else|else
name|chan_type
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|tb
index|[
name|NL80211_ATTR_DURATION
index|]
condition|)
name|duration
operator|=
name|nla_get_u32
argument_list|(
name|tb
index|[
name|NL80211_ATTR_DURATION
index|]
argument_list|)
expr_stmt|;
else|else
name|duration
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|tb
index|[
name|NL80211_ATTR_COOKIE
index|]
condition|)
name|cookie
operator|=
name|nla_get_u64
argument_list|(
name|tb
index|[
name|NL80211_ATTR_COOKIE
index|]
argument_list|)
expr_stmt|;
else|else
name|cookie
operator|=
literal|0
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"nl80211: Remain-on-channel event (cancel=%d "
literal|"freq=%u channel_type=%u duration=%u cookie=0x%llx (%s))"
argument_list|,
name|cancel_event
argument_list|,
name|freq
argument_list|,
name|chan_type
argument_list|,
name|duration
argument_list|,
operator|(
name|long
name|long
name|unsigned
name|int
operator|)
name|cookie
argument_list|,
name|cookie
operator|==
name|drv
operator|->
name|remain_on_chan_cookie
condition|?
literal|"match"
else|:
literal|"unknown"
argument_list|)
expr_stmt|;
if|if
condition|(
name|cookie
operator|!=
name|drv
operator|->
name|remain_on_chan_cookie
condition|)
return|return;
comment|/* not for us */
if|if
condition|(
name|cancel_event
condition|)
name|drv
operator|->
name|pending_remain_on_chan
operator|=
literal|0
expr_stmt|;
name|os_memset
argument_list|(
operator|&
name|data
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|data
argument_list|)
argument_list|)
expr_stmt|;
name|data
operator|.
name|remain_on_channel
operator|.
name|freq
operator|=
name|freq
expr_stmt|;
name|data
operator|.
name|remain_on_channel
operator|.
name|duration
operator|=
name|duration
expr_stmt|;
name|wpa_supplicant_event
argument_list|(
name|drv
operator|->
name|ctx
argument_list|,
name|cancel_event
condition|?
name|EVENT_CANCEL_REMAIN_ON_CHANNEL
else|:
name|EVENT_REMAIN_ON_CHANNEL
argument_list|,
operator|&
name|data
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|mlme_event_ft_event
parameter_list|(
name|struct
name|wpa_driver_nl80211_data
modifier|*
name|drv
parameter_list|,
name|struct
name|nlattr
modifier|*
name|tb
index|[]
parameter_list|)
block|{
name|union
name|wpa_event_data
name|data
decl_stmt|;
name|os_memset
argument_list|(
operator|&
name|data
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|data
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|tb
index|[
name|NL80211_ATTR_IE
index|]
condition|)
block|{
name|data
operator|.
name|ft_ies
operator|.
name|ies
operator|=
name|nla_data
argument_list|(
name|tb
index|[
name|NL80211_ATTR_IE
index|]
argument_list|)
expr_stmt|;
name|data
operator|.
name|ft_ies
operator|.
name|ies_len
operator|=
name|nla_len
argument_list|(
name|tb
index|[
name|NL80211_ATTR_IE
index|]
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|tb
index|[
name|NL80211_ATTR_IE_RIC
index|]
condition|)
block|{
name|data
operator|.
name|ft_ies
operator|.
name|ric_ies
operator|=
name|nla_data
argument_list|(
name|tb
index|[
name|NL80211_ATTR_IE_RIC
index|]
argument_list|)
expr_stmt|;
name|data
operator|.
name|ft_ies
operator|.
name|ric_ies_len
operator|=
name|nla_len
argument_list|(
name|tb
index|[
name|NL80211_ATTR_IE_RIC
index|]
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|tb
index|[
name|NL80211_ATTR_MAC
index|]
condition|)
name|os_memcpy
argument_list|(
name|data
operator|.
name|ft_ies
operator|.
name|target_ap
argument_list|,
name|nla_data
argument_list|(
name|tb
index|[
name|NL80211_ATTR_MAC
index|]
argument_list|)
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"nl80211: FT event target_ap "
name|MACSTR
argument_list|,
name|MAC2STR
argument_list|(
name|data
operator|.
name|ft_ies
operator|.
name|target_ap
argument_list|)
argument_list|)
expr_stmt|;
name|wpa_supplicant_event
argument_list|(
name|drv
operator|->
name|ctx
argument_list|,
name|EVENT_FT_RESPONSE
argument_list|,
operator|&
name|data
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|send_scan_event
parameter_list|(
name|struct
name|wpa_driver_nl80211_data
modifier|*
name|drv
parameter_list|,
name|int
name|aborted
parameter_list|,
name|struct
name|nlattr
modifier|*
name|tb
index|[]
parameter_list|)
block|{
name|union
name|wpa_event_data
name|event
decl_stmt|;
name|struct
name|nlattr
modifier|*
name|nl
decl_stmt|;
name|int
name|rem
decl_stmt|;
name|struct
name|scan_info
modifier|*
name|info
decl_stmt|;
define|#
directive|define
name|MAX_REPORT_FREQS
value|50
name|int
name|freqs
index|[
name|MAX_REPORT_FREQS
index|]
decl_stmt|;
name|int
name|num_freqs
init|=
literal|0
decl_stmt|;
if|if
condition|(
name|drv
operator|->
name|scan_for_auth
condition|)
block|{
name|drv
operator|->
name|scan_for_auth
operator|=
literal|0
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"nl80211: Scan results for missing "
literal|"cfg80211 BSS entry"
argument_list|)
expr_stmt|;
name|wpa_driver_nl80211_authenticate_retry
argument_list|(
name|drv
argument_list|)
expr_stmt|;
return|return;
block|}
name|os_memset
argument_list|(
operator|&
name|event
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|event
argument_list|)
argument_list|)
expr_stmt|;
name|info
operator|=
operator|&
name|event
operator|.
name|scan_info
expr_stmt|;
name|info
operator|->
name|aborted
operator|=
name|aborted
expr_stmt|;
if|if
condition|(
name|tb
index|[
name|NL80211_ATTR_SCAN_SSIDS
index|]
condition|)
block|{
name|nla_for_each_nested
argument_list|(
argument|nl
argument_list|,
argument|tb[NL80211_ATTR_SCAN_SSIDS]
argument_list|,
argument|rem
argument_list|)
block|{
name|struct
name|wpa_driver_scan_ssid
modifier|*
name|s
init|=
operator|&
name|info
operator|->
name|ssids
index|[
name|info
operator|->
name|num_ssids
index|]
decl_stmt|;
name|s
operator|->
name|ssid
operator|=
name|nla_data
argument_list|(
name|nl
argument_list|)
expr_stmt|;
name|s
operator|->
name|ssid_len
operator|=
name|nla_len
argument_list|(
name|nl
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"nl80211: Scan probed for SSID '%s'"
argument_list|,
name|wpa_ssid_txt
argument_list|(
name|s
operator|->
name|ssid
argument_list|,
name|s
operator|->
name|ssid_len
argument_list|)
argument_list|)
expr_stmt|;
name|info
operator|->
name|num_ssids
operator|++
expr_stmt|;
if|if
condition|(
name|info
operator|->
name|num_ssids
operator|==
name|WPAS_MAX_SCAN_SSIDS
condition|)
break|break;
block|}
block|}
if|if
condition|(
name|tb
index|[
name|NL80211_ATTR_SCAN_FREQUENCIES
index|]
condition|)
block|{
name|char
name|msg
index|[
literal|200
index|]
decl_stmt|,
modifier|*
name|pos
decl_stmt|,
modifier|*
name|end
decl_stmt|;
name|int
name|res
decl_stmt|;
name|pos
operator|=
name|msg
expr_stmt|;
name|end
operator|=
name|pos
operator|+
sizeof|sizeof
argument_list|(
name|msg
argument_list|)
expr_stmt|;
operator|*
name|pos
operator|=
literal|'\0'
expr_stmt|;
name|nla_for_each_nested
argument_list|(
argument|nl
argument_list|,
argument|tb[NL80211_ATTR_SCAN_FREQUENCIES]
argument_list|,
argument|rem
argument_list|)
block|{
name|freqs
index|[
name|num_freqs
index|]
operator|=
name|nla_get_u32
argument_list|(
name|nl
argument_list|)
expr_stmt|;
name|res
operator|=
name|os_snprintf
argument_list|(
name|pos
argument_list|,
name|end
operator|-
name|pos
argument_list|,
literal|" %d"
argument_list|,
name|freqs
index|[
name|num_freqs
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|os_snprintf_error
argument_list|(
name|end
operator|-
name|pos
argument_list|,
name|res
argument_list|)
condition|)
name|pos
operator|+=
name|res
expr_stmt|;
name|num_freqs
operator|++
expr_stmt|;
if|if
condition|(
name|num_freqs
operator|==
name|MAX_REPORT_FREQS
operator|-
literal|1
condition|)
break|break;
block|}
name|info
operator|->
name|freqs
operator|=
name|freqs
expr_stmt|;
name|info
operator|->
name|num_freqs
operator|=
name|num_freqs
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"nl80211: Scan included frequencies:%s"
argument_list|,
name|msg
argument_list|)
expr_stmt|;
block|}
name|wpa_supplicant_event
argument_list|(
name|drv
operator|->
name|ctx
argument_list|,
name|EVENT_SCAN_RESULTS
argument_list|,
operator|&
name|event
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|nl80211_cqm_event
parameter_list|(
name|struct
name|wpa_driver_nl80211_data
modifier|*
name|drv
parameter_list|,
name|struct
name|nlattr
modifier|*
name|tb
index|[]
parameter_list|)
block|{
specifier|static
name|struct
name|nla_policy
name|cqm_policy
index|[
name|NL80211_ATTR_CQM_MAX
operator|+
literal|1
index|]
init|=
block|{
index|[
name|NL80211_ATTR_CQM_RSSI_THOLD
index|]
operator|=
block|{
operator|.
name|type
operator|=
name|NLA_U32
block|}
block|,
index|[
name|NL80211_ATTR_CQM_RSSI_HYST
index|]
operator|=
block|{
operator|.
name|type
operator|=
name|NLA_U8
block|}
block|,
index|[
name|NL80211_ATTR_CQM_RSSI_THRESHOLD_EVENT
index|]
operator|=
block|{
operator|.
name|type
operator|=
name|NLA_U32
block|}
block|,
index|[
name|NL80211_ATTR_CQM_PKT_LOSS_EVENT
index|]
operator|=
block|{
operator|.
name|type
operator|=
name|NLA_U32
block|}
block|, 	}
decl_stmt|;
name|struct
name|nlattr
modifier|*
name|cqm
index|[
name|NL80211_ATTR_CQM_MAX
operator|+
literal|1
index|]
decl_stmt|;
name|enum
name|nl80211_cqm_rssi_threshold_event
name|event
decl_stmt|;
name|union
name|wpa_event_data
name|ed
decl_stmt|;
name|struct
name|wpa_signal_info
name|sig
decl_stmt|;
name|int
name|res
decl_stmt|;
if|if
condition|(
name|tb
index|[
name|NL80211_ATTR_CQM
index|]
operator|==
name|NULL
operator|||
name|nla_parse_nested
argument_list|(
name|cqm
argument_list|,
name|NL80211_ATTR_CQM_MAX
argument_list|,
name|tb
index|[
name|NL80211_ATTR_CQM
index|]
argument_list|,
name|cqm_policy
argument_list|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"nl80211: Ignore invalid CQM event"
argument_list|)
expr_stmt|;
return|return;
block|}
name|os_memset
argument_list|(
operator|&
name|ed
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|ed
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|cqm
index|[
name|NL80211_ATTR_CQM_PKT_LOSS_EVENT
index|]
condition|)
block|{
if|if
condition|(
operator|!
name|tb
index|[
name|NL80211_ATTR_MAC
index|]
condition|)
return|return;
name|os_memcpy
argument_list|(
name|ed
operator|.
name|low_ack
operator|.
name|addr
argument_list|,
name|nla_data
argument_list|(
name|tb
index|[
name|NL80211_ATTR_MAC
index|]
argument_list|)
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
name|wpa_supplicant_event
argument_list|(
name|drv
operator|->
name|ctx
argument_list|,
name|EVENT_STATION_LOW_ACK
argument_list|,
operator|&
name|ed
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|cqm
index|[
name|NL80211_ATTR_CQM_RSSI_THRESHOLD_EVENT
index|]
operator|==
name|NULL
condition|)
return|return;
name|event
operator|=
name|nla_get_u32
argument_list|(
name|cqm
index|[
name|NL80211_ATTR_CQM_RSSI_THRESHOLD_EVENT
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|event
operator|==
name|NL80211_CQM_RSSI_THRESHOLD_EVENT_HIGH
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"nl80211: Connection quality monitor "
literal|"event: RSSI high"
argument_list|)
expr_stmt|;
name|ed
operator|.
name|signal_change
operator|.
name|above_threshold
operator|=
literal|1
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|event
operator|==
name|NL80211_CQM_RSSI_THRESHOLD_EVENT_LOW
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"nl80211: Connection quality monitor "
literal|"event: RSSI low"
argument_list|)
expr_stmt|;
name|ed
operator|.
name|signal_change
operator|.
name|above_threshold
operator|=
literal|0
expr_stmt|;
block|}
else|else
return|return;
name|res
operator|=
name|nl80211_get_link_signal
argument_list|(
name|drv
argument_list|,
operator|&
name|sig
argument_list|)
expr_stmt|;
if|if
condition|(
name|res
operator|==
literal|0
condition|)
block|{
name|ed
operator|.
name|signal_change
operator|.
name|current_signal
operator|=
name|sig
operator|.
name|current_signal
expr_stmt|;
name|ed
operator|.
name|signal_change
operator|.
name|current_txrate
operator|=
name|sig
operator|.
name|current_txrate
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"nl80211: Signal: %d dBm  txrate: %d"
argument_list|,
name|sig
operator|.
name|current_signal
argument_list|,
name|sig
operator|.
name|current_txrate
argument_list|)
expr_stmt|;
block|}
name|res
operator|=
name|nl80211_get_link_noise
argument_list|(
name|drv
argument_list|,
operator|&
name|sig
argument_list|)
expr_stmt|;
if|if
condition|(
name|res
operator|==
literal|0
condition|)
block|{
name|ed
operator|.
name|signal_change
operator|.
name|current_noise
operator|=
name|sig
operator|.
name|current_noise
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"nl80211: Noise: %d dBm"
argument_list|,
name|sig
operator|.
name|current_noise
argument_list|)
expr_stmt|;
block|}
name|wpa_supplicant_event
argument_list|(
name|drv
operator|->
name|ctx
argument_list|,
name|EVENT_SIGNAL_CHANGE
argument_list|,
operator|&
name|ed
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|nl80211_new_peer_candidate
parameter_list|(
name|struct
name|wpa_driver_nl80211_data
modifier|*
name|drv
parameter_list|,
name|struct
name|nlattr
modifier|*
modifier|*
name|tb
parameter_list|)
block|{
specifier|const
name|u8
modifier|*
name|addr
decl_stmt|;
name|union
name|wpa_event_data
name|data
decl_stmt|;
if|if
condition|(
name|drv
operator|->
name|nlmode
operator|!=
name|NL80211_IFTYPE_MESH_POINT
operator|||
operator|!
name|tb
index|[
name|NL80211_ATTR_MAC
index|]
operator|||
operator|!
name|tb
index|[
name|NL80211_ATTR_IE
index|]
condition|)
return|return;
name|addr
operator|=
name|nla_data
argument_list|(
name|tb
index|[
name|NL80211_ATTR_MAC
index|]
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"nl80211: New peer candidate"
name|MACSTR
argument_list|,
name|MAC2STR
argument_list|(
name|addr
argument_list|)
argument_list|)
expr_stmt|;
name|os_memset
argument_list|(
operator|&
name|data
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|data
argument_list|)
argument_list|)
expr_stmt|;
name|data
operator|.
name|mesh_peer
operator|.
name|peer
operator|=
name|addr
expr_stmt|;
name|data
operator|.
name|mesh_peer
operator|.
name|ies
operator|=
name|nla_data
argument_list|(
name|tb
index|[
name|NL80211_ATTR_IE
index|]
argument_list|)
expr_stmt|;
name|data
operator|.
name|mesh_peer
operator|.
name|ie_len
operator|=
name|nla_len
argument_list|(
name|tb
index|[
name|NL80211_ATTR_IE
index|]
argument_list|)
expr_stmt|;
name|wpa_supplicant_event
argument_list|(
name|drv
operator|->
name|ctx
argument_list|,
name|EVENT_NEW_PEER_CANDIDATE
argument_list|,
operator|&
name|data
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|nl80211_new_station_event
parameter_list|(
name|struct
name|wpa_driver_nl80211_data
modifier|*
name|drv
parameter_list|,
name|struct
name|i802_bss
modifier|*
name|bss
parameter_list|,
name|struct
name|nlattr
modifier|*
modifier|*
name|tb
parameter_list|)
block|{
name|u8
modifier|*
name|addr
decl_stmt|;
name|union
name|wpa_event_data
name|data
decl_stmt|;
if|if
condition|(
name|tb
index|[
name|NL80211_ATTR_MAC
index|]
operator|==
name|NULL
condition|)
return|return;
name|addr
operator|=
name|nla_data
argument_list|(
name|tb
index|[
name|NL80211_ATTR_MAC
index|]
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"nl80211: New station "
name|MACSTR
argument_list|,
name|MAC2STR
argument_list|(
name|addr
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|is_ap_interface
argument_list|(
name|drv
operator|->
name|nlmode
argument_list|)
operator|&&
name|drv
operator|->
name|device_ap_sme
condition|)
block|{
name|u8
modifier|*
name|ies
init|=
name|NULL
decl_stmt|;
name|size_t
name|ies_len
init|=
literal|0
decl_stmt|;
if|if
condition|(
name|tb
index|[
name|NL80211_ATTR_IE
index|]
condition|)
block|{
name|ies
operator|=
name|nla_data
argument_list|(
name|tb
index|[
name|NL80211_ATTR_IE
index|]
argument_list|)
expr_stmt|;
name|ies_len
operator|=
name|nla_len
argument_list|(
name|tb
index|[
name|NL80211_ATTR_IE
index|]
argument_list|)
expr_stmt|;
block|}
name|wpa_hexdump
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"nl80211: Assoc Req IEs"
argument_list|,
name|ies
argument_list|,
name|ies_len
argument_list|)
expr_stmt|;
name|drv_event_assoc
argument_list|(
name|bss
operator|->
name|ctx
argument_list|,
name|addr
argument_list|,
name|ies
argument_list|,
name|ies_len
argument_list|,
literal|0
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|drv
operator|->
name|nlmode
operator|!=
name|NL80211_IFTYPE_ADHOC
condition|)
return|return;
name|os_memset
argument_list|(
operator|&
name|data
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|data
argument_list|)
argument_list|)
expr_stmt|;
name|os_memcpy
argument_list|(
name|data
operator|.
name|ibss_rsn_start
operator|.
name|peer
argument_list|,
name|addr
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
name|wpa_supplicant_event
argument_list|(
name|bss
operator|->
name|ctx
argument_list|,
name|EVENT_IBSS_RSN_START
argument_list|,
operator|&
name|data
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|nl80211_del_station_event
parameter_list|(
name|struct
name|wpa_driver_nl80211_data
modifier|*
name|drv
parameter_list|,
name|struct
name|nlattr
modifier|*
modifier|*
name|tb
parameter_list|)
block|{
name|u8
modifier|*
name|addr
decl_stmt|;
name|union
name|wpa_event_data
name|data
decl_stmt|;
if|if
condition|(
name|tb
index|[
name|NL80211_ATTR_MAC
index|]
operator|==
name|NULL
condition|)
return|return;
name|addr
operator|=
name|nla_data
argument_list|(
name|tb
index|[
name|NL80211_ATTR_MAC
index|]
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"nl80211: Delete station "
name|MACSTR
argument_list|,
name|MAC2STR
argument_list|(
name|addr
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|is_ap_interface
argument_list|(
name|drv
operator|->
name|nlmode
argument_list|)
operator|&&
name|drv
operator|->
name|device_ap_sme
condition|)
block|{
name|drv_event_disassoc
argument_list|(
name|drv
operator|->
name|ctx
argument_list|,
name|addr
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|drv
operator|->
name|nlmode
operator|!=
name|NL80211_IFTYPE_ADHOC
condition|)
return|return;
name|os_memset
argument_list|(
operator|&
name|data
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|data
argument_list|)
argument_list|)
expr_stmt|;
name|os_memcpy
argument_list|(
name|data
operator|.
name|ibss_peer_lost
operator|.
name|peer
argument_list|,
name|addr
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
name|wpa_supplicant_event
argument_list|(
name|drv
operator|->
name|ctx
argument_list|,
name|EVENT_IBSS_PEER_LOST
argument_list|,
operator|&
name|data
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|nl80211_rekey_offload_event
parameter_list|(
name|struct
name|wpa_driver_nl80211_data
modifier|*
name|drv
parameter_list|,
name|struct
name|nlattr
modifier|*
modifier|*
name|tb
parameter_list|)
block|{
name|struct
name|nlattr
modifier|*
name|rekey_info
index|[
name|NUM_NL80211_REKEY_DATA
index|]
decl_stmt|;
specifier|static
name|struct
name|nla_policy
name|rekey_policy
index|[
name|NUM_NL80211_REKEY_DATA
index|]
init|=
block|{
index|[
name|NL80211_REKEY_DATA_KEK
index|]
operator|=
block|{
operator|.
name|minlen
operator|=
name|NL80211_KEK_LEN
block|,
operator|.
name|maxlen
operator|=
name|NL80211_KEK_LEN
block|, 		}
block|,
index|[
name|NL80211_REKEY_DATA_KCK
index|]
operator|=
block|{
operator|.
name|minlen
operator|=
name|NL80211_KCK_LEN
block|,
operator|.
name|maxlen
operator|=
name|NL80211_KCK_LEN
block|, 		}
block|,
index|[
name|NL80211_REKEY_DATA_REPLAY_CTR
index|]
operator|=
block|{
operator|.
name|minlen
operator|=
name|NL80211_REPLAY_CTR_LEN
block|,
operator|.
name|maxlen
operator|=
name|NL80211_REPLAY_CTR_LEN
block|, 		}
block|, 	}
decl_stmt|;
name|union
name|wpa_event_data
name|data
decl_stmt|;
if|if
condition|(
operator|!
name|tb
index|[
name|NL80211_ATTR_MAC
index|]
operator|||
operator|!
name|tb
index|[
name|NL80211_ATTR_REKEY_DATA
index|]
operator|||
name|nla_parse_nested
argument_list|(
name|rekey_info
argument_list|,
name|MAX_NL80211_REKEY_DATA
argument_list|,
name|tb
index|[
name|NL80211_ATTR_REKEY_DATA
index|]
argument_list|,
name|rekey_policy
argument_list|)
operator|||
operator|!
name|rekey_info
index|[
name|NL80211_REKEY_DATA_REPLAY_CTR
index|]
condition|)
return|return;
name|os_memset
argument_list|(
operator|&
name|data
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|data
argument_list|)
argument_list|)
expr_stmt|;
name|data
operator|.
name|driver_gtk_rekey
operator|.
name|bssid
operator|=
name|nla_data
argument_list|(
name|tb
index|[
name|NL80211_ATTR_MAC
index|]
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"nl80211: Rekey offload event for BSSID "
name|MACSTR
argument_list|,
name|MAC2STR
argument_list|(
name|data
operator|.
name|driver_gtk_rekey
operator|.
name|bssid
argument_list|)
argument_list|)
expr_stmt|;
name|data
operator|.
name|driver_gtk_rekey
operator|.
name|replay_ctr
operator|=
name|nla_data
argument_list|(
name|rekey_info
index|[
name|NL80211_REKEY_DATA_REPLAY_CTR
index|]
argument_list|)
expr_stmt|;
name|wpa_hexdump
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"nl80211: Rekey offload - Replay Counter"
argument_list|,
name|data
operator|.
name|driver_gtk_rekey
operator|.
name|replay_ctr
argument_list|,
name|NL80211_REPLAY_CTR_LEN
argument_list|)
expr_stmt|;
name|wpa_supplicant_event
argument_list|(
name|drv
operator|->
name|ctx
argument_list|,
name|EVENT_DRIVER_GTK_REKEY
argument_list|,
operator|&
name|data
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|nl80211_pmksa_candidate_event
parameter_list|(
name|struct
name|wpa_driver_nl80211_data
modifier|*
name|drv
parameter_list|,
name|struct
name|nlattr
modifier|*
modifier|*
name|tb
parameter_list|)
block|{
name|struct
name|nlattr
modifier|*
name|cand
index|[
name|NUM_NL80211_PMKSA_CANDIDATE
index|]
decl_stmt|;
specifier|static
name|struct
name|nla_policy
name|cand_policy
index|[
name|NUM_NL80211_PMKSA_CANDIDATE
index|]
init|=
block|{
index|[
name|NL80211_PMKSA_CANDIDATE_INDEX
index|]
operator|=
block|{
operator|.
name|type
operator|=
name|NLA_U32
block|}
block|,
index|[
name|NL80211_PMKSA_CANDIDATE_BSSID
index|]
operator|=
block|{
operator|.
name|minlen
operator|=
name|ETH_ALEN
block|,
operator|.
name|maxlen
operator|=
name|ETH_ALEN
block|, 		}
block|,
index|[
name|NL80211_PMKSA_CANDIDATE_PREAUTH
index|]
operator|=
block|{
operator|.
name|type
operator|=
name|NLA_FLAG
block|}
block|, 	}
decl_stmt|;
name|union
name|wpa_event_data
name|data
decl_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"nl80211: PMKSA candidate event"
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|tb
index|[
name|NL80211_ATTR_PMKSA_CANDIDATE
index|]
operator|||
name|nla_parse_nested
argument_list|(
name|cand
argument_list|,
name|MAX_NL80211_PMKSA_CANDIDATE
argument_list|,
name|tb
index|[
name|NL80211_ATTR_PMKSA_CANDIDATE
index|]
argument_list|,
name|cand_policy
argument_list|)
operator|||
operator|!
name|cand
index|[
name|NL80211_PMKSA_CANDIDATE_INDEX
index|]
operator|||
operator|!
name|cand
index|[
name|NL80211_PMKSA_CANDIDATE_BSSID
index|]
condition|)
return|return;
name|os_memset
argument_list|(
operator|&
name|data
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|data
argument_list|)
argument_list|)
expr_stmt|;
name|os_memcpy
argument_list|(
name|data
operator|.
name|pmkid_candidate
operator|.
name|bssid
argument_list|,
name|nla_data
argument_list|(
name|cand
index|[
name|NL80211_PMKSA_CANDIDATE_BSSID
index|]
argument_list|)
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
name|data
operator|.
name|pmkid_candidate
operator|.
name|index
operator|=
name|nla_get_u32
argument_list|(
name|cand
index|[
name|NL80211_PMKSA_CANDIDATE_INDEX
index|]
argument_list|)
expr_stmt|;
name|data
operator|.
name|pmkid_candidate
operator|.
name|preauth
operator|=
name|cand
index|[
name|NL80211_PMKSA_CANDIDATE_PREAUTH
index|]
operator|!=
name|NULL
expr_stmt|;
name|wpa_supplicant_event
argument_list|(
name|drv
operator|->
name|ctx
argument_list|,
name|EVENT_PMKID_CANDIDATE
argument_list|,
operator|&
name|data
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|nl80211_client_probe_event
parameter_list|(
name|struct
name|wpa_driver_nl80211_data
modifier|*
name|drv
parameter_list|,
name|struct
name|nlattr
modifier|*
modifier|*
name|tb
parameter_list|)
block|{
name|union
name|wpa_event_data
name|data
decl_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"nl80211: Probe client event"
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|tb
index|[
name|NL80211_ATTR_MAC
index|]
operator|||
operator|!
name|tb
index|[
name|NL80211_ATTR_ACK
index|]
condition|)
return|return;
name|os_memset
argument_list|(
operator|&
name|data
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|data
argument_list|)
argument_list|)
expr_stmt|;
name|os_memcpy
argument_list|(
name|data
operator|.
name|client_poll
operator|.
name|addr
argument_list|,
name|nla_data
argument_list|(
name|tb
index|[
name|NL80211_ATTR_MAC
index|]
argument_list|)
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
name|wpa_supplicant_event
argument_list|(
name|drv
operator|->
name|ctx
argument_list|,
name|EVENT_DRIVER_CLIENT_POLL_OK
argument_list|,
operator|&
name|data
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|nl80211_tdls_oper_event
parameter_list|(
name|struct
name|wpa_driver_nl80211_data
modifier|*
name|drv
parameter_list|,
name|struct
name|nlattr
modifier|*
modifier|*
name|tb
parameter_list|)
block|{
name|union
name|wpa_event_data
name|data
decl_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"nl80211: TDLS operation event"
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|tb
index|[
name|NL80211_ATTR_MAC
index|]
operator|||
operator|!
name|tb
index|[
name|NL80211_ATTR_TDLS_OPERATION
index|]
condition|)
return|return;
name|os_memset
argument_list|(
operator|&
name|data
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|data
argument_list|)
argument_list|)
expr_stmt|;
name|os_memcpy
argument_list|(
name|data
operator|.
name|tdls
operator|.
name|peer
argument_list|,
name|nla_data
argument_list|(
name|tb
index|[
name|NL80211_ATTR_MAC
index|]
argument_list|)
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|nla_get_u8
argument_list|(
name|tb
index|[
name|NL80211_ATTR_TDLS_OPERATION
index|]
argument_list|)
condition|)
block|{
case|case
name|NL80211_TDLS_SETUP
case|:
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"nl80211: TDLS setup request for peer "
name|MACSTR
argument_list|,
name|MAC2STR
argument_list|(
name|data
operator|.
name|tdls
operator|.
name|peer
argument_list|)
argument_list|)
expr_stmt|;
name|data
operator|.
name|tdls
operator|.
name|oper
operator|=
name|TDLS_REQUEST_SETUP
expr_stmt|;
break|break;
case|case
name|NL80211_TDLS_TEARDOWN
case|:
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"nl80211: TDLS teardown request for peer "
name|MACSTR
argument_list|,
name|MAC2STR
argument_list|(
name|data
operator|.
name|tdls
operator|.
name|peer
argument_list|)
argument_list|)
expr_stmt|;
name|data
operator|.
name|tdls
operator|.
name|oper
operator|=
name|TDLS_REQUEST_TEARDOWN
expr_stmt|;
break|break;
case|case
name|NL80211_TDLS_DISCOVERY_REQ
case|:
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"nl80211: TDLS discovery request for peer "
name|MACSTR
argument_list|,
name|MAC2STR
argument_list|(
name|data
operator|.
name|tdls
operator|.
name|peer
argument_list|)
argument_list|)
expr_stmt|;
name|data
operator|.
name|tdls
operator|.
name|oper
operator|=
name|TDLS_REQUEST_DISCOVER
expr_stmt|;
break|break;
default|default:
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"nl80211: Unsupported TDLS operatione "
literal|"event"
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|tb
index|[
name|NL80211_ATTR_REASON_CODE
index|]
condition|)
block|{
name|data
operator|.
name|tdls
operator|.
name|reason_code
operator|=
name|nla_get_u16
argument_list|(
name|tb
index|[
name|NL80211_ATTR_REASON_CODE
index|]
argument_list|)
expr_stmt|;
block|}
name|wpa_supplicant_event
argument_list|(
name|drv
operator|->
name|ctx
argument_list|,
name|EVENT_TDLS
argument_list|,
operator|&
name|data
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|nl80211_stop_ap
parameter_list|(
name|struct
name|wpa_driver_nl80211_data
modifier|*
name|drv
parameter_list|,
name|struct
name|nlattr
modifier|*
modifier|*
name|tb
parameter_list|)
block|{
name|wpa_supplicant_event
argument_list|(
name|drv
operator|->
name|ctx
argument_list|,
name|EVENT_INTERFACE_UNAVAILABLE
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|nl80211_connect_failed_event
parameter_list|(
name|struct
name|wpa_driver_nl80211_data
modifier|*
name|drv
parameter_list|,
name|struct
name|nlattr
modifier|*
modifier|*
name|tb
parameter_list|)
block|{
name|union
name|wpa_event_data
name|data
decl_stmt|;
name|u32
name|reason
decl_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"nl80211: Connect failed event"
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|tb
index|[
name|NL80211_ATTR_MAC
index|]
operator|||
operator|!
name|tb
index|[
name|NL80211_ATTR_CONN_FAILED_REASON
index|]
condition|)
return|return;
name|os_memset
argument_list|(
operator|&
name|data
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|data
argument_list|)
argument_list|)
expr_stmt|;
name|os_memcpy
argument_list|(
name|data
operator|.
name|connect_failed_reason
operator|.
name|addr
argument_list|,
name|nla_data
argument_list|(
name|tb
index|[
name|NL80211_ATTR_MAC
index|]
argument_list|)
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
name|reason
operator|=
name|nla_get_u32
argument_list|(
name|tb
index|[
name|NL80211_ATTR_CONN_FAILED_REASON
index|]
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|reason
condition|)
block|{
case|case
name|NL80211_CONN_FAIL_MAX_CLIENTS
case|:
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"nl80211: Max client reached"
argument_list|)
expr_stmt|;
name|data
operator|.
name|connect_failed_reason
operator|.
name|code
operator|=
name|MAX_CLIENT_REACHED
expr_stmt|;
break|break;
case|case
name|NL80211_CONN_FAIL_BLOCKED_CLIENT
case|:
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"nl80211: Blocked client "
name|MACSTR
literal|" tried to connect"
argument_list|,
name|MAC2STR
argument_list|(
name|data
operator|.
name|connect_failed_reason
operator|.
name|addr
argument_list|)
argument_list|)
expr_stmt|;
name|data
operator|.
name|connect_failed_reason
operator|.
name|code
operator|=
name|BLOCKED_CLIENT
expr_stmt|;
break|break;
default|default:
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"nl8021l: Unknown connect failed reason "
literal|"%u"
argument_list|,
name|reason
argument_list|)
expr_stmt|;
return|return;
block|}
name|wpa_supplicant_event
argument_list|(
name|drv
operator|->
name|ctx
argument_list|,
name|EVENT_CONNECT_FAILED_REASON
argument_list|,
operator|&
name|data
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|nl80211_radar_event
parameter_list|(
name|struct
name|wpa_driver_nl80211_data
modifier|*
name|drv
parameter_list|,
name|struct
name|nlattr
modifier|*
modifier|*
name|tb
parameter_list|)
block|{
name|union
name|wpa_event_data
name|data
decl_stmt|;
name|enum
name|nl80211_radar_event
name|event_type
decl_stmt|;
if|if
condition|(
operator|!
name|tb
index|[
name|NL80211_ATTR_WIPHY_FREQ
index|]
operator|||
operator|!
name|tb
index|[
name|NL80211_ATTR_RADAR_EVENT
index|]
condition|)
return|return;
name|os_memset
argument_list|(
operator|&
name|data
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|data
argument_list|)
argument_list|)
expr_stmt|;
name|data
operator|.
name|dfs_event
operator|.
name|freq
operator|=
name|nla_get_u32
argument_list|(
name|tb
index|[
name|NL80211_ATTR_WIPHY_FREQ
index|]
argument_list|)
expr_stmt|;
name|event_type
operator|=
name|nla_get_u32
argument_list|(
name|tb
index|[
name|NL80211_ATTR_RADAR_EVENT
index|]
argument_list|)
expr_stmt|;
comment|/* Check HT params */
if|if
condition|(
name|tb
index|[
name|NL80211_ATTR_WIPHY_CHANNEL_TYPE
index|]
condition|)
block|{
name|data
operator|.
name|dfs_event
operator|.
name|ht_enabled
operator|=
literal|1
expr_stmt|;
name|data
operator|.
name|dfs_event
operator|.
name|chan_offset
operator|=
literal|0
expr_stmt|;
switch|switch
condition|(
name|nla_get_u32
argument_list|(
name|tb
index|[
name|NL80211_ATTR_WIPHY_CHANNEL_TYPE
index|]
argument_list|)
condition|)
block|{
case|case
name|NL80211_CHAN_NO_HT
case|:
name|data
operator|.
name|dfs_event
operator|.
name|ht_enabled
operator|=
literal|0
expr_stmt|;
break|break;
case|case
name|NL80211_CHAN_HT20
case|:
break|break;
case|case
name|NL80211_CHAN_HT40PLUS
case|:
name|data
operator|.
name|dfs_event
operator|.
name|chan_offset
operator|=
literal|1
expr_stmt|;
break|break;
case|case
name|NL80211_CHAN_HT40MINUS
case|:
name|data
operator|.
name|dfs_event
operator|.
name|chan_offset
operator|=
operator|-
literal|1
expr_stmt|;
break|break;
block|}
block|}
comment|/* Get VHT params */
if|if
condition|(
name|tb
index|[
name|NL80211_ATTR_CHANNEL_WIDTH
index|]
condition|)
name|data
operator|.
name|dfs_event
operator|.
name|chan_width
operator|=
name|convert2width
argument_list|(
name|nla_get_u32
argument_list|(
name|tb
index|[
name|NL80211_ATTR_CHANNEL_WIDTH
index|]
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|tb
index|[
name|NL80211_ATTR_CENTER_FREQ1
index|]
condition|)
name|data
operator|.
name|dfs_event
operator|.
name|cf1
operator|=
name|nla_get_u32
argument_list|(
name|tb
index|[
name|NL80211_ATTR_CENTER_FREQ1
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|tb
index|[
name|NL80211_ATTR_CENTER_FREQ2
index|]
condition|)
name|data
operator|.
name|dfs_event
operator|.
name|cf2
operator|=
name|nla_get_u32
argument_list|(
name|tb
index|[
name|NL80211_ATTR_CENTER_FREQ2
index|]
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"nl80211: DFS event on freq %d MHz, ht: %d, offset: %d, width: %d, cf1: %dMHz, cf2: %dMHz"
argument_list|,
name|data
operator|.
name|dfs_event
operator|.
name|freq
argument_list|,
name|data
operator|.
name|dfs_event
operator|.
name|ht_enabled
argument_list|,
name|data
operator|.
name|dfs_event
operator|.
name|chan_offset
argument_list|,
name|data
operator|.
name|dfs_event
operator|.
name|chan_width
argument_list|,
name|data
operator|.
name|dfs_event
operator|.
name|cf1
argument_list|,
name|data
operator|.
name|dfs_event
operator|.
name|cf2
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|event_type
condition|)
block|{
case|case
name|NL80211_RADAR_DETECTED
case|:
name|wpa_supplicant_event
argument_list|(
name|drv
operator|->
name|ctx
argument_list|,
name|EVENT_DFS_RADAR_DETECTED
argument_list|,
operator|&
name|data
argument_list|)
expr_stmt|;
break|break;
case|case
name|NL80211_RADAR_CAC_FINISHED
case|:
name|wpa_supplicant_event
argument_list|(
name|drv
operator|->
name|ctx
argument_list|,
name|EVENT_DFS_CAC_FINISHED
argument_list|,
operator|&
name|data
argument_list|)
expr_stmt|;
break|break;
case|case
name|NL80211_RADAR_CAC_ABORTED
case|:
name|wpa_supplicant_event
argument_list|(
name|drv
operator|->
name|ctx
argument_list|,
name|EVENT_DFS_CAC_ABORTED
argument_list|,
operator|&
name|data
argument_list|)
expr_stmt|;
break|break;
case|case
name|NL80211_RADAR_NOP_FINISHED
case|:
name|wpa_supplicant_event
argument_list|(
name|drv
operator|->
name|ctx
argument_list|,
name|EVENT_DFS_NOP_FINISHED
argument_list|,
operator|&
name|data
argument_list|)
expr_stmt|;
break|break;
default|default:
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"nl80211: Unknown radar event %d "
literal|"received"
argument_list|,
name|event_type
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|nl80211_spurious_frame
parameter_list|(
name|struct
name|i802_bss
modifier|*
name|bss
parameter_list|,
name|struct
name|nlattr
modifier|*
modifier|*
name|tb
parameter_list|,
name|int
name|wds
parameter_list|)
block|{
name|struct
name|wpa_driver_nl80211_data
modifier|*
name|drv
init|=
name|bss
operator|->
name|drv
decl_stmt|;
name|union
name|wpa_event_data
name|event
decl_stmt|;
if|if
condition|(
operator|!
name|tb
index|[
name|NL80211_ATTR_MAC
index|]
condition|)
return|return;
name|os_memset
argument_list|(
operator|&
name|event
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|event
argument_list|)
argument_list|)
expr_stmt|;
name|event
operator|.
name|rx_from_unknown
operator|.
name|bssid
operator|=
name|bss
operator|->
name|addr
expr_stmt|;
name|event
operator|.
name|rx_from_unknown
operator|.
name|addr
operator|=
name|nla_data
argument_list|(
name|tb
index|[
name|NL80211_ATTR_MAC
index|]
argument_list|)
expr_stmt|;
name|event
operator|.
name|rx_from_unknown
operator|.
name|wds
operator|=
name|wds
expr_stmt|;
name|wpa_supplicant_event
argument_list|(
name|drv
operator|->
name|ctx
argument_list|,
name|EVENT_RX_FROM_UNKNOWN
argument_list|,
operator|&
name|event
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|qca_nl80211_avoid_freq
parameter_list|(
name|struct
name|wpa_driver_nl80211_data
modifier|*
name|drv
parameter_list|,
specifier|const
name|u8
modifier|*
name|data
parameter_list|,
name|size_t
name|len
parameter_list|)
block|{
name|u32
name|i
decl_stmt|,
name|count
decl_stmt|;
name|union
name|wpa_event_data
name|event
decl_stmt|;
name|struct
name|wpa_freq_range
modifier|*
name|range
init|=
name|NULL
decl_stmt|;
specifier|const
name|struct
name|qca_avoid_freq_list
modifier|*
name|freq_range
decl_stmt|;
name|freq_range
operator|=
operator|(
specifier|const
expr|struct
name|qca_avoid_freq_list
operator|*
operator|)
name|data
expr_stmt|;
if|if
condition|(
name|len
operator|<
sizeof|sizeof
argument_list|(
name|freq_range
operator|->
name|count
argument_list|)
condition|)
return|return;
name|count
operator|=
name|freq_range
operator|->
name|count
expr_stmt|;
if|if
condition|(
name|len
operator|<
sizeof|sizeof
argument_list|(
name|freq_range
operator|->
name|count
argument_list|)
operator|+
name|count
operator|*
sizeof|sizeof
argument_list|(
expr|struct
name|qca_avoid_freq_range
argument_list|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"nl80211: Ignored too short avoid frequency list (len=%u)"
argument_list|,
operator|(
name|unsigned
name|int
operator|)
name|len
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|count
operator|>
literal|0
condition|)
block|{
name|range
operator|=
name|os_calloc
argument_list|(
name|count
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|wpa_freq_range
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|range
operator|==
name|NULL
condition|)
return|return;
block|}
name|os_memset
argument_list|(
operator|&
name|event
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|event
argument_list|)
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|count
condition|;
name|i
operator|++
control|)
block|{
name|unsigned
name|int
name|idx
init|=
name|event
operator|.
name|freq_range
operator|.
name|num
decl_stmt|;
name|range
index|[
name|idx
index|]
operator|.
name|min
operator|=
name|freq_range
operator|->
name|range
index|[
name|i
index|]
operator|.
name|start_freq
expr_stmt|;
name|range
index|[
name|idx
index|]
operator|.
name|max
operator|=
name|freq_range
operator|->
name|range
index|[
name|i
index|]
operator|.
name|end_freq
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"nl80211: Avoid frequency range: %u-%u"
argument_list|,
name|range
index|[
name|idx
index|]
operator|.
name|min
argument_list|,
name|range
index|[
name|idx
index|]
operator|.
name|max
argument_list|)
expr_stmt|;
if|if
condition|(
name|range
index|[
name|idx
index|]
operator|.
name|min
operator|>
name|range
index|[
name|idx
index|]
operator|.
name|max
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"nl80211: Ignore invalid frequency range"
argument_list|)
expr_stmt|;
continue|continue;
block|}
name|event
operator|.
name|freq_range
operator|.
name|num
operator|++
expr_stmt|;
block|}
name|event
operator|.
name|freq_range
operator|.
name|range
operator|=
name|range
expr_stmt|;
name|wpa_supplicant_event
argument_list|(
name|drv
operator|->
name|ctx
argument_list|,
name|EVENT_AVOID_FREQUENCIES
argument_list|,
operator|&
name|event
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|range
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|enum
name|hostapd_hw_mode
name|get_qca_hw_mode
parameter_list|(
name|u8
name|hw_mode
parameter_list|)
block|{
switch|switch
condition|(
name|hw_mode
condition|)
block|{
case|case
name|QCA_ACS_MODE_IEEE80211B
case|:
return|return
name|HOSTAPD_MODE_IEEE80211B
return|;
case|case
name|QCA_ACS_MODE_IEEE80211G
case|:
return|return
name|HOSTAPD_MODE_IEEE80211G
return|;
case|case
name|QCA_ACS_MODE_IEEE80211A
case|:
return|return
name|HOSTAPD_MODE_IEEE80211A
return|;
case|case
name|QCA_ACS_MODE_IEEE80211AD
case|:
return|return
name|HOSTAPD_MODE_IEEE80211AD
return|;
case|case
name|QCA_ACS_MODE_IEEE80211ANY
case|:
return|return
name|HOSTAPD_MODE_IEEE80211ANY
return|;
default|default:
return|return
name|NUM_HOSTAPD_MODES
return|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|qca_nl80211_acs_select_ch
parameter_list|(
name|struct
name|wpa_driver_nl80211_data
modifier|*
name|drv
parameter_list|,
specifier|const
name|u8
modifier|*
name|data
parameter_list|,
name|size_t
name|len
parameter_list|)
block|{
name|struct
name|nlattr
modifier|*
name|tb
index|[
name|QCA_WLAN_VENDOR_ATTR_ACS_MAX
operator|+
literal|1
index|]
decl_stmt|;
name|union
name|wpa_event_data
name|event
decl_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"nl80211: ACS channel selection vendor event received"
argument_list|)
expr_stmt|;
if|if
condition|(
name|nla_parse
argument_list|(
name|tb
argument_list|,
name|QCA_WLAN_VENDOR_ATTR_ACS_MAX
argument_list|,
operator|(
expr|struct
name|nlattr
operator|*
operator|)
name|data
argument_list|,
name|len
argument_list|,
name|NULL
argument_list|)
operator|||
operator|!
name|tb
index|[
name|QCA_WLAN_VENDOR_ATTR_ACS_PRIMARY_CHANNEL
index|]
operator|||
operator|!
name|tb
index|[
name|QCA_WLAN_VENDOR_ATTR_ACS_SECONDARY_CHANNEL
index|]
condition|)
return|return;
name|os_memset
argument_list|(
operator|&
name|event
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|event
argument_list|)
argument_list|)
expr_stmt|;
name|event
operator|.
name|acs_selected_channels
operator|.
name|pri_channel
operator|=
name|nla_get_u8
argument_list|(
name|tb
index|[
name|QCA_WLAN_VENDOR_ATTR_ACS_PRIMARY_CHANNEL
index|]
argument_list|)
expr_stmt|;
name|event
operator|.
name|acs_selected_channels
operator|.
name|sec_channel
operator|=
name|nla_get_u8
argument_list|(
name|tb
index|[
name|QCA_WLAN_VENDOR_ATTR_ACS_SECONDARY_CHANNEL
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|tb
index|[
name|QCA_WLAN_VENDOR_ATTR_ACS_VHT_SEG0_CENTER_CHANNEL
index|]
condition|)
name|event
operator|.
name|acs_selected_channels
operator|.
name|vht_seg0_center_ch
operator|=
name|nla_get_u8
argument_list|(
name|tb
index|[
name|QCA_WLAN_VENDOR_ATTR_ACS_VHT_SEG0_CENTER_CHANNEL
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|tb
index|[
name|QCA_WLAN_VENDOR_ATTR_ACS_VHT_SEG0_CENTER_CHANNEL
index|]
condition|)
name|event
operator|.
name|acs_selected_channels
operator|.
name|vht_seg1_center_ch
operator|=
name|nla_get_u8
argument_list|(
name|tb
index|[
name|QCA_WLAN_VENDOR_ATTR_ACS_VHT_SEG1_CENTER_CHANNEL
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|tb
index|[
name|QCA_WLAN_VENDOR_ATTR_ACS_CHWIDTH
index|]
condition|)
name|event
operator|.
name|acs_selected_channels
operator|.
name|ch_width
operator|=
name|nla_get_u16
argument_list|(
name|tb
index|[
name|QCA_WLAN_VENDOR_ATTR_ACS_CHWIDTH
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|tb
index|[
name|QCA_WLAN_VENDOR_ATTR_ACS_HW_MODE
index|]
condition|)
block|{
name|u8
name|hw_mode
init|=
name|nla_get_u8
argument_list|(
name|tb
index|[
name|QCA_WLAN_VENDOR_ATTR_ACS_HW_MODE
index|]
argument_list|)
decl_stmt|;
name|event
operator|.
name|acs_selected_channels
operator|.
name|hw_mode
operator|=
name|get_qca_hw_mode
argument_list|(
name|hw_mode
argument_list|)
expr_stmt|;
if|if
condition|(
name|event
operator|.
name|acs_selected_channels
operator|.
name|hw_mode
operator|==
name|NUM_HOSTAPD_MODES
operator|||
name|event
operator|.
name|acs_selected_channels
operator|.
name|hw_mode
operator|==
name|HOSTAPD_MODE_IEEE80211ANY
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"nl80211: Invalid hw_mode %d in ACS selection event"
argument_list|,
name|hw_mode
argument_list|)
expr_stmt|;
return|return;
block|}
block|}
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"nl80211: ACS Results: PCH: %d SCH: %d BW: %d VHT0: %d VHT1: %d HW_MODE: %d"
argument_list|,
name|event
operator|.
name|acs_selected_channels
operator|.
name|pri_channel
argument_list|,
name|event
operator|.
name|acs_selected_channels
operator|.
name|sec_channel
argument_list|,
name|event
operator|.
name|acs_selected_channels
operator|.
name|ch_width
argument_list|,
name|event
operator|.
name|acs_selected_channels
operator|.
name|vht_seg0_center_ch
argument_list|,
name|event
operator|.
name|acs_selected_channels
operator|.
name|vht_seg1_center_ch
argument_list|,
name|event
operator|.
name|acs_selected_channels
operator|.
name|hw_mode
argument_list|)
expr_stmt|;
comment|/* Ignore ACS channel list check for backwards compatibility */
name|wpa_supplicant_event
argument_list|(
name|drv
operator|->
name|ctx
argument_list|,
name|EVENT_ACS_CHANNEL_SELECTED
argument_list|,
operator|&
name|event
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|qca_nl80211_key_mgmt_auth
parameter_list|(
name|struct
name|wpa_driver_nl80211_data
modifier|*
name|drv
parameter_list|,
specifier|const
name|u8
modifier|*
name|data
parameter_list|,
name|size_t
name|len
parameter_list|)
block|{
name|struct
name|nlattr
modifier|*
name|tb
index|[
name|QCA_WLAN_VENDOR_ATTR_ROAM_AUTH_MAX
operator|+
literal|1
index|]
decl_stmt|;
name|u8
modifier|*
name|bssid
decl_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"nl80211: Key management roam+auth vendor event received"
argument_list|)
expr_stmt|;
if|if
condition|(
name|nla_parse
argument_list|(
name|tb
argument_list|,
name|QCA_WLAN_VENDOR_ATTR_ROAM_AUTH_MAX
argument_list|,
operator|(
expr|struct
name|nlattr
operator|*
operator|)
name|data
argument_list|,
name|len
argument_list|,
name|NULL
argument_list|)
operator|||
operator|!
name|tb
index|[
name|QCA_WLAN_VENDOR_ATTR_ROAM_AUTH_BSSID
index|]
operator|||
name|nla_len
argument_list|(
name|tb
index|[
name|QCA_WLAN_VENDOR_ATTR_ROAM_AUTH_BSSID
index|]
argument_list|)
operator|!=
name|ETH_ALEN
operator|||
operator|!
name|tb
index|[
name|QCA_WLAN_VENDOR_ATTR_ROAM_AUTH_REQ_IE
index|]
operator|||
operator|!
name|tb
index|[
name|QCA_WLAN_VENDOR_ATTR_ROAM_AUTH_RESP_IE
index|]
operator|||
operator|!
name|tb
index|[
name|QCA_WLAN_VENDOR_ATTR_ROAM_AUTH_AUTHORIZED
index|]
condition|)
return|return;
name|bssid
operator|=
name|nla_data
argument_list|(
name|tb
index|[
name|QCA_WLAN_VENDOR_ATTR_ROAM_AUTH_BSSID
index|]
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"  * roam BSSID "
name|MACSTR
argument_list|,
name|MAC2STR
argument_list|(
name|bssid
argument_list|)
argument_list|)
expr_stmt|;
name|mlme_event_connect
argument_list|(
name|drv
argument_list|,
name|NL80211_CMD_ROAM
argument_list|,
name|NULL
argument_list|,
name|tb
index|[
name|QCA_WLAN_VENDOR_ATTR_ROAM_AUTH_BSSID
index|]
argument_list|,
name|tb
index|[
name|QCA_WLAN_VENDOR_ATTR_ROAM_AUTH_REQ_IE
index|]
argument_list|,
name|tb
index|[
name|QCA_WLAN_VENDOR_ATTR_ROAM_AUTH_RESP_IE
index|]
argument_list|,
name|tb
index|[
name|QCA_WLAN_VENDOR_ATTR_ROAM_AUTH_AUTHORIZED
index|]
argument_list|,
name|tb
index|[
name|QCA_WLAN_VENDOR_ATTR_ROAM_AUTH_KEY_REPLAY_CTR
index|]
argument_list|,
name|tb
index|[
name|QCA_WLAN_VENDOR_ATTR_ROAM_AUTH_PTK_KCK
index|]
argument_list|,
name|tb
index|[
name|QCA_WLAN_VENDOR_ATTR_ROAM_AUTH_PTK_KEK
index|]
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|qca_nl80211_dfs_offload_radar_event
parameter_list|(
name|struct
name|wpa_driver_nl80211_data
modifier|*
name|drv
parameter_list|,
name|u32
name|subcmd
parameter_list|,
name|u8
modifier|*
name|msg
parameter_list|,
name|int
name|length
parameter_list|)
block|{
name|union
name|wpa_event_data
name|data
decl_stmt|;
name|struct
name|nlattr
modifier|*
name|tb
index|[
name|NL80211_ATTR_MAX
operator|+
literal|1
index|]
decl_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"nl80211: DFS offload radar vendor event received"
argument_list|)
expr_stmt|;
if|if
condition|(
name|nla_parse
argument_list|(
name|tb
argument_list|,
name|NL80211_ATTR_MAX
argument_list|,
operator|(
expr|struct
name|nlattr
operator|*
operator|)
name|msg
argument_list|,
name|length
argument_list|,
name|NULL
argument_list|)
condition|)
return|return;
if|if
condition|(
operator|!
name|tb
index|[
name|NL80211_ATTR_WIPHY_FREQ
index|]
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"nl80211: Error parsing WIPHY_FREQ in FS offload radar vendor event"
argument_list|)
expr_stmt|;
return|return;
block|}
name|os_memset
argument_list|(
operator|&
name|data
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|data
argument_list|)
argument_list|)
expr_stmt|;
name|data
operator|.
name|dfs_event
operator|.
name|freq
operator|=
name|nla_get_u32
argument_list|(
name|tb
index|[
name|NL80211_ATTR_WIPHY_FREQ
index|]
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"nl80211: DFS event on freq %d MHz"
argument_list|,
name|data
operator|.
name|dfs_event
operator|.
name|freq
argument_list|)
expr_stmt|;
comment|/* Check HT params */
if|if
condition|(
name|tb
index|[
name|NL80211_ATTR_WIPHY_CHANNEL_TYPE
index|]
condition|)
block|{
name|data
operator|.
name|dfs_event
operator|.
name|ht_enabled
operator|=
literal|1
expr_stmt|;
name|data
operator|.
name|dfs_event
operator|.
name|chan_offset
operator|=
literal|0
expr_stmt|;
switch|switch
condition|(
name|nla_get_u32
argument_list|(
name|tb
index|[
name|NL80211_ATTR_WIPHY_CHANNEL_TYPE
index|]
argument_list|)
condition|)
block|{
case|case
name|NL80211_CHAN_NO_HT
case|:
name|data
operator|.
name|dfs_event
operator|.
name|ht_enabled
operator|=
literal|0
expr_stmt|;
break|break;
case|case
name|NL80211_CHAN_HT20
case|:
break|break;
case|case
name|NL80211_CHAN_HT40PLUS
case|:
name|data
operator|.
name|dfs_event
operator|.
name|chan_offset
operator|=
literal|1
expr_stmt|;
break|break;
case|case
name|NL80211_CHAN_HT40MINUS
case|:
name|data
operator|.
name|dfs_event
operator|.
name|chan_offset
operator|=
operator|-
literal|1
expr_stmt|;
break|break;
block|}
block|}
comment|/* Get VHT params */
if|if
condition|(
name|tb
index|[
name|NL80211_ATTR_CHANNEL_WIDTH
index|]
condition|)
name|data
operator|.
name|dfs_event
operator|.
name|chan_width
operator|=
name|convert2width
argument_list|(
name|nla_get_u32
argument_list|(
name|tb
index|[
name|NL80211_ATTR_CHANNEL_WIDTH
index|]
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|tb
index|[
name|NL80211_ATTR_CENTER_FREQ1
index|]
condition|)
name|data
operator|.
name|dfs_event
operator|.
name|cf1
operator|=
name|nla_get_u32
argument_list|(
name|tb
index|[
name|NL80211_ATTR_CENTER_FREQ1
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|tb
index|[
name|NL80211_ATTR_CENTER_FREQ2
index|]
condition|)
name|data
operator|.
name|dfs_event
operator|.
name|cf2
operator|=
name|nla_get_u32
argument_list|(
name|tb
index|[
name|NL80211_ATTR_CENTER_FREQ2
index|]
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"nl80211: DFS event on freq %d MHz, ht: %d, "
literal|"offset: %d, width: %d, cf1: %dMHz, cf2: %dMHz"
argument_list|,
name|data
operator|.
name|dfs_event
operator|.
name|freq
argument_list|,
name|data
operator|.
name|dfs_event
operator|.
name|ht_enabled
argument_list|,
name|data
operator|.
name|dfs_event
operator|.
name|chan_offset
argument_list|,
name|data
operator|.
name|dfs_event
operator|.
name|chan_width
argument_list|,
name|data
operator|.
name|dfs_event
operator|.
name|cf1
argument_list|,
name|data
operator|.
name|dfs_event
operator|.
name|cf2
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|subcmd
condition|)
block|{
case|case
name|QCA_NL80211_VENDOR_SUBCMD_DFS_OFFLOAD_RADAR_DETECTED
case|:
name|wpa_supplicant_event
argument_list|(
name|drv
operator|->
name|ctx
argument_list|,
name|EVENT_DFS_RADAR_DETECTED
argument_list|,
operator|&
name|data
argument_list|)
expr_stmt|;
break|break;
case|case
name|QCA_NL80211_VENDOR_SUBCMD_DFS_OFFLOAD_CAC_STARTED
case|:
name|wpa_supplicant_event
argument_list|(
name|drv
operator|->
name|ctx
argument_list|,
name|EVENT_DFS_CAC_STARTED
argument_list|,
operator|&
name|data
argument_list|)
expr_stmt|;
break|break;
case|case
name|QCA_NL80211_VENDOR_SUBCMD_DFS_OFFLOAD_CAC_FINISHED
case|:
name|wpa_supplicant_event
argument_list|(
name|drv
operator|->
name|ctx
argument_list|,
name|EVENT_DFS_CAC_FINISHED
argument_list|,
operator|&
name|data
argument_list|)
expr_stmt|;
break|break;
case|case
name|QCA_NL80211_VENDOR_SUBCMD_DFS_OFFLOAD_CAC_ABORTED
case|:
name|wpa_supplicant_event
argument_list|(
name|drv
operator|->
name|ctx
argument_list|,
name|EVENT_DFS_CAC_ABORTED
argument_list|,
operator|&
name|data
argument_list|)
expr_stmt|;
break|break;
case|case
name|QCA_NL80211_VENDOR_SUBCMD_DFS_OFFLOAD_CAC_NOP_FINISHED
case|:
name|wpa_supplicant_event
argument_list|(
name|drv
operator|->
name|ctx
argument_list|,
name|EVENT_DFS_NOP_FINISHED
argument_list|,
operator|&
name|data
argument_list|)
expr_stmt|;
break|break;
default|default:
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"nl80211: Unknown DFS offload radar event %d received"
argument_list|,
name|subcmd
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|nl80211_vendor_event_qca
parameter_list|(
name|struct
name|wpa_driver_nl80211_data
modifier|*
name|drv
parameter_list|,
name|u32
name|subcmd
parameter_list|,
name|u8
modifier|*
name|data
parameter_list|,
name|size_t
name|len
parameter_list|)
block|{
switch|switch
condition|(
name|subcmd
condition|)
block|{
case|case
name|QCA_NL80211_VENDOR_SUBCMD_TEST
case|:
name|wpa_hexdump
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"nl80211: QCA test event"
argument_list|,
name|data
argument_list|,
name|len
argument_list|)
expr_stmt|;
break|break;
case|case
name|QCA_NL80211_VENDOR_SUBCMD_AVOID_FREQUENCY
case|:
name|qca_nl80211_avoid_freq
argument_list|(
name|drv
argument_list|,
name|data
argument_list|,
name|len
argument_list|)
expr_stmt|;
break|break;
case|case
name|QCA_NL80211_VENDOR_SUBCMD_KEY_MGMT_ROAM_AUTH
case|:
name|qca_nl80211_key_mgmt_auth
argument_list|(
name|drv
argument_list|,
name|data
argument_list|,
name|len
argument_list|)
expr_stmt|;
break|break;
case|case
name|QCA_NL80211_VENDOR_SUBCMD_DO_ACS
case|:
name|qca_nl80211_acs_select_ch
argument_list|(
name|drv
argument_list|,
name|data
argument_list|,
name|len
argument_list|)
expr_stmt|;
break|break;
case|case
name|QCA_NL80211_VENDOR_SUBCMD_DFS_OFFLOAD_CAC_STARTED
case|:
case|case
name|QCA_NL80211_VENDOR_SUBCMD_DFS_OFFLOAD_CAC_FINISHED
case|:
case|case
name|QCA_NL80211_VENDOR_SUBCMD_DFS_OFFLOAD_CAC_ABORTED
case|:
case|case
name|QCA_NL80211_VENDOR_SUBCMD_DFS_OFFLOAD_CAC_NOP_FINISHED
case|:
case|case
name|QCA_NL80211_VENDOR_SUBCMD_DFS_OFFLOAD_RADAR_DETECTED
case|:
name|qca_nl80211_dfs_offload_radar_event
argument_list|(
name|drv
argument_list|,
name|subcmd
argument_list|,
name|data
argument_list|,
name|len
argument_list|)
expr_stmt|;
break|break;
default|default:
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"nl80211: Ignore unsupported QCA vendor event %u"
argument_list|,
name|subcmd
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|nl80211_vendor_event
parameter_list|(
name|struct
name|wpa_driver_nl80211_data
modifier|*
name|drv
parameter_list|,
name|struct
name|nlattr
modifier|*
modifier|*
name|tb
parameter_list|)
block|{
name|u32
name|vendor_id
decl_stmt|,
name|subcmd
decl_stmt|,
name|wiphy
init|=
literal|0
decl_stmt|;
name|int
name|wiphy_idx
decl_stmt|;
name|u8
modifier|*
name|data
init|=
name|NULL
decl_stmt|;
name|size_t
name|len
init|=
literal|0
decl_stmt|;
if|if
condition|(
operator|!
name|tb
index|[
name|NL80211_ATTR_VENDOR_ID
index|]
operator|||
operator|!
name|tb
index|[
name|NL80211_ATTR_VENDOR_SUBCMD
index|]
condition|)
return|return;
name|vendor_id
operator|=
name|nla_get_u32
argument_list|(
name|tb
index|[
name|NL80211_ATTR_VENDOR_ID
index|]
argument_list|)
expr_stmt|;
name|subcmd
operator|=
name|nla_get_u32
argument_list|(
name|tb
index|[
name|NL80211_ATTR_VENDOR_SUBCMD
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|tb
index|[
name|NL80211_ATTR_WIPHY
index|]
condition|)
name|wiphy
operator|=
name|nla_get_u32
argument_list|(
name|tb
index|[
name|NL80211_ATTR_WIPHY
index|]
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"nl80211: Vendor event: wiphy=%u vendor_id=0x%x subcmd=%u"
argument_list|,
name|wiphy
argument_list|,
name|vendor_id
argument_list|,
name|subcmd
argument_list|)
expr_stmt|;
if|if
condition|(
name|tb
index|[
name|NL80211_ATTR_VENDOR_DATA
index|]
condition|)
block|{
name|data
operator|=
name|nla_data
argument_list|(
name|tb
index|[
name|NL80211_ATTR_VENDOR_DATA
index|]
argument_list|)
expr_stmt|;
name|len
operator|=
name|nla_len
argument_list|(
name|tb
index|[
name|NL80211_ATTR_VENDOR_DATA
index|]
argument_list|)
expr_stmt|;
name|wpa_hexdump
argument_list|(
name|MSG_MSGDUMP
argument_list|,
literal|"nl80211: Vendor data"
argument_list|,
name|data
argument_list|,
name|len
argument_list|)
expr_stmt|;
block|}
name|wiphy_idx
operator|=
name|nl80211_get_wiphy_index
argument_list|(
name|drv
operator|->
name|first_bss
argument_list|)
expr_stmt|;
if|if
condition|(
name|wiphy_idx
operator|>=
literal|0
operator|&&
name|wiphy_idx
operator|!=
operator|(
name|int
operator|)
name|wiphy
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"nl80211: Ignore vendor event for foreign wiphy %u (own: %d)"
argument_list|,
name|wiphy
argument_list|,
name|wiphy_idx
argument_list|)
expr_stmt|;
return|return;
block|}
switch|switch
condition|(
name|vendor_id
condition|)
block|{
case|case
name|OUI_QCA
case|:
name|nl80211_vendor_event_qca
argument_list|(
name|drv
argument_list|,
name|subcmd
argument_list|,
name|data
argument_list|,
name|len
argument_list|)
expr_stmt|;
break|break;
default|default:
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"nl80211: Ignore unsupported vendor event"
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|nl80211_reg_change_event
parameter_list|(
name|struct
name|wpa_driver_nl80211_data
modifier|*
name|drv
parameter_list|,
name|struct
name|nlattr
modifier|*
name|tb
index|[]
parameter_list|)
block|{
name|union
name|wpa_event_data
name|data
decl_stmt|;
name|enum
name|nl80211_reg_initiator
name|init
decl_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"nl80211: Regulatory domain change"
argument_list|)
expr_stmt|;
if|if
condition|(
name|tb
index|[
name|NL80211_ATTR_REG_INITIATOR
index|]
operator|==
name|NULL
condition|)
return|return;
name|os_memset
argument_list|(
operator|&
name|data
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|data
argument_list|)
argument_list|)
expr_stmt|;
name|init
operator|=
name|nla_get_u8
argument_list|(
name|tb
index|[
name|NL80211_ATTR_REG_INITIATOR
index|]
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|" * initiator=%d"
argument_list|,
name|init
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|init
condition|)
block|{
case|case
name|NL80211_REGDOM_SET_BY_CORE
case|:
name|data
operator|.
name|channel_list_changed
operator|.
name|initiator
operator|=
name|REGDOM_SET_BY_CORE
expr_stmt|;
break|break;
case|case
name|NL80211_REGDOM_SET_BY_USER
case|:
name|data
operator|.
name|channel_list_changed
operator|.
name|initiator
operator|=
name|REGDOM_SET_BY_USER
expr_stmt|;
break|break;
case|case
name|NL80211_REGDOM_SET_BY_DRIVER
case|:
name|data
operator|.
name|channel_list_changed
operator|.
name|initiator
operator|=
name|REGDOM_SET_BY_DRIVER
expr_stmt|;
break|break;
case|case
name|NL80211_REGDOM_SET_BY_COUNTRY_IE
case|:
name|data
operator|.
name|channel_list_changed
operator|.
name|initiator
operator|=
name|REGDOM_SET_BY_COUNTRY_IE
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|tb
index|[
name|NL80211_ATTR_REG_TYPE
index|]
condition|)
block|{
name|enum
name|nl80211_reg_type
name|type
decl_stmt|;
name|type
operator|=
name|nla_get_u8
argument_list|(
name|tb
index|[
name|NL80211_ATTR_REG_TYPE
index|]
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|" * type=%d"
argument_list|,
name|type
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|type
condition|)
block|{
case|case
name|NL80211_REGDOM_TYPE_COUNTRY
case|:
name|data
operator|.
name|channel_list_changed
operator|.
name|type
operator|=
name|REGDOM_TYPE_COUNTRY
expr_stmt|;
break|break;
case|case
name|NL80211_REGDOM_TYPE_WORLD
case|:
name|data
operator|.
name|channel_list_changed
operator|.
name|type
operator|=
name|REGDOM_TYPE_WORLD
expr_stmt|;
break|break;
case|case
name|NL80211_REGDOM_TYPE_CUSTOM_WORLD
case|:
name|data
operator|.
name|channel_list_changed
operator|.
name|type
operator|=
name|REGDOM_TYPE_CUSTOM_WORLD
expr_stmt|;
break|break;
case|case
name|NL80211_REGDOM_TYPE_INTERSECTION
case|:
name|data
operator|.
name|channel_list_changed
operator|.
name|type
operator|=
name|REGDOM_TYPE_INTERSECTION
expr_stmt|;
break|break;
block|}
block|}
if|if
condition|(
name|tb
index|[
name|NL80211_ATTR_REG_ALPHA2
index|]
condition|)
block|{
name|os_strlcpy
argument_list|(
name|data
operator|.
name|channel_list_changed
operator|.
name|alpha2
argument_list|,
name|nla_get_string
argument_list|(
name|tb
index|[
name|NL80211_ATTR_REG_ALPHA2
index|]
argument_list|)
argument_list|,
sizeof|sizeof
argument_list|(
name|data
operator|.
name|channel_list_changed
operator|.
name|alpha2
argument_list|)
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|" * alpha2=%s"
argument_list|,
name|data
operator|.
name|channel_list_changed
operator|.
name|alpha2
argument_list|)
expr_stmt|;
block|}
name|wpa_supplicant_event
argument_list|(
name|drv
operator|->
name|ctx
argument_list|,
name|EVENT_CHANNEL_LIST_CHANGED
argument_list|,
operator|&
name|data
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|do_process_drv_event
parameter_list|(
name|struct
name|i802_bss
modifier|*
name|bss
parameter_list|,
name|int
name|cmd
parameter_list|,
name|struct
name|nlattr
modifier|*
modifier|*
name|tb
parameter_list|)
block|{
name|struct
name|wpa_driver_nl80211_data
modifier|*
name|drv
init|=
name|bss
operator|->
name|drv
decl_stmt|;
name|union
name|wpa_event_data
name|data
decl_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"nl80211: Drv Event %d (%s) received for %s"
argument_list|,
name|cmd
argument_list|,
name|nl80211_command_to_string
argument_list|(
name|cmd
argument_list|)
argument_list|,
name|bss
operator|->
name|ifname
argument_list|)
expr_stmt|;
if|if
condition|(
name|cmd
operator|==
name|NL80211_CMD_ROAM
operator|&&
operator|(
name|drv
operator|->
name|capa
operator|.
name|flags
operator|&
name|WPA_DRIVER_FLAGS_KEY_MGMT_OFFLOAD
operator|)
condition|)
block|{
comment|/* 		 * Device will use roam+auth vendor event to indicate 		 * roaming, so ignore the regular roam event. 		 */
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"nl80211: Ignore roam event (cmd=%d), device will use vendor event roam+auth"
argument_list|,
name|cmd
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|drv
operator|->
name|ap_scan_as_station
operator|!=
name|NL80211_IFTYPE_UNSPECIFIED
operator|&&
operator|(
name|cmd
operator|==
name|NL80211_CMD_NEW_SCAN_RESULTS
operator|||
name|cmd
operator|==
name|NL80211_CMD_SCAN_ABORTED
operator|)
condition|)
block|{
name|wpa_driver_nl80211_set_mode
argument_list|(
name|drv
operator|->
name|first_bss
argument_list|,
name|drv
operator|->
name|ap_scan_as_station
argument_list|)
expr_stmt|;
name|drv
operator|->
name|ap_scan_as_station
operator|=
name|NL80211_IFTYPE_UNSPECIFIED
expr_stmt|;
block|}
switch|switch
condition|(
name|cmd
condition|)
block|{
case|case
name|NL80211_CMD_TRIGGER_SCAN
case|:
name|wpa_dbg
argument_list|(
name|drv
operator|->
name|ctx
argument_list|,
name|MSG_DEBUG
argument_list|,
literal|"nl80211: Scan trigger"
argument_list|)
expr_stmt|;
name|drv
operator|->
name|scan_state
operator|=
name|SCAN_STARTED
expr_stmt|;
if|if
condition|(
name|drv
operator|->
name|scan_for_auth
condition|)
block|{
comment|/* 			 * Cannot indicate EVENT_SCAN_STARTED here since we skip 			 * EVENT_SCAN_RESULTS in scan_for_auth case and the 			 * upper layer implementation could get confused about 			 * scanning state. 			 */
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"nl80211: Do not indicate scan-start event due to internal scan_for_auth"
argument_list|)
expr_stmt|;
break|break;
block|}
name|wpa_supplicant_event
argument_list|(
name|drv
operator|->
name|ctx
argument_list|,
name|EVENT_SCAN_STARTED
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
break|break;
case|case
name|NL80211_CMD_START_SCHED_SCAN
case|:
name|wpa_dbg
argument_list|(
name|drv
operator|->
name|ctx
argument_list|,
name|MSG_DEBUG
argument_list|,
literal|"nl80211: Sched scan started"
argument_list|)
expr_stmt|;
name|drv
operator|->
name|scan_state
operator|=
name|SCHED_SCAN_STARTED
expr_stmt|;
break|break;
case|case
name|NL80211_CMD_SCHED_SCAN_STOPPED
case|:
name|wpa_dbg
argument_list|(
name|drv
operator|->
name|ctx
argument_list|,
name|MSG_DEBUG
argument_list|,
literal|"nl80211: Sched scan stopped"
argument_list|)
expr_stmt|;
name|drv
operator|->
name|scan_state
operator|=
name|SCHED_SCAN_STOPPED
expr_stmt|;
name|wpa_supplicant_event
argument_list|(
name|drv
operator|->
name|ctx
argument_list|,
name|EVENT_SCHED_SCAN_STOPPED
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
break|break;
case|case
name|NL80211_CMD_NEW_SCAN_RESULTS
case|:
name|wpa_dbg
argument_list|(
name|drv
operator|->
name|ctx
argument_list|,
name|MSG_DEBUG
argument_list|,
literal|"nl80211: New scan results available"
argument_list|)
expr_stmt|;
name|drv
operator|->
name|scan_state
operator|=
name|SCAN_COMPLETED
expr_stmt|;
name|drv
operator|->
name|scan_complete_events
operator|=
literal|1
expr_stmt|;
name|eloop_cancel_timeout
argument_list|(
name|wpa_driver_nl80211_scan_timeout
argument_list|,
name|drv
argument_list|,
name|drv
operator|->
name|ctx
argument_list|)
expr_stmt|;
name|send_scan_event
argument_list|(
name|drv
argument_list|,
literal|0
argument_list|,
name|tb
argument_list|)
expr_stmt|;
break|break;
case|case
name|NL80211_CMD_SCHED_SCAN_RESULTS
case|:
name|wpa_dbg
argument_list|(
name|drv
operator|->
name|ctx
argument_list|,
name|MSG_DEBUG
argument_list|,
literal|"nl80211: New sched scan results available"
argument_list|)
expr_stmt|;
name|drv
operator|->
name|scan_state
operator|=
name|SCHED_SCAN_RESULTS
expr_stmt|;
name|send_scan_event
argument_list|(
name|drv
argument_list|,
literal|0
argument_list|,
name|tb
argument_list|)
expr_stmt|;
break|break;
case|case
name|NL80211_CMD_SCAN_ABORTED
case|:
name|wpa_dbg
argument_list|(
name|drv
operator|->
name|ctx
argument_list|,
name|MSG_DEBUG
argument_list|,
literal|"nl80211: Scan aborted"
argument_list|)
expr_stmt|;
name|drv
operator|->
name|scan_state
operator|=
name|SCAN_ABORTED
expr_stmt|;
comment|/* 		 * Need to indicate that scan results are available in order 		 * not to make wpa_supplicant stop its scanning. 		 */
name|eloop_cancel_timeout
argument_list|(
name|wpa_driver_nl80211_scan_timeout
argument_list|,
name|drv
argument_list|,
name|drv
operator|->
name|ctx
argument_list|)
expr_stmt|;
name|send_scan_event
argument_list|(
name|drv
argument_list|,
literal|1
argument_list|,
name|tb
argument_list|)
expr_stmt|;
break|break;
case|case
name|NL80211_CMD_AUTHENTICATE
case|:
case|case
name|NL80211_CMD_ASSOCIATE
case|:
case|case
name|NL80211_CMD_DEAUTHENTICATE
case|:
case|case
name|NL80211_CMD_DISASSOCIATE
case|:
case|case
name|NL80211_CMD_FRAME_TX_STATUS
case|:
case|case
name|NL80211_CMD_UNPROT_DEAUTHENTICATE
case|:
case|case
name|NL80211_CMD_UNPROT_DISASSOCIATE
case|:
name|mlme_event
argument_list|(
name|bss
argument_list|,
name|cmd
argument_list|,
name|tb
index|[
name|NL80211_ATTR_FRAME
index|]
argument_list|,
name|tb
index|[
name|NL80211_ATTR_MAC
index|]
argument_list|,
name|tb
index|[
name|NL80211_ATTR_TIMED_OUT
index|]
argument_list|,
name|tb
index|[
name|NL80211_ATTR_WIPHY_FREQ
index|]
argument_list|,
name|tb
index|[
name|NL80211_ATTR_ACK
index|]
argument_list|,
name|tb
index|[
name|NL80211_ATTR_COOKIE
index|]
argument_list|,
name|tb
index|[
name|NL80211_ATTR_RX_SIGNAL_DBM
index|]
argument_list|,
name|tb
index|[
name|NL80211_ATTR_STA_WME
index|]
argument_list|)
expr_stmt|;
break|break;
case|case
name|NL80211_CMD_CONNECT
case|:
case|case
name|NL80211_CMD_ROAM
case|:
name|mlme_event_connect
argument_list|(
name|drv
argument_list|,
name|cmd
argument_list|,
name|tb
index|[
name|NL80211_ATTR_STATUS_CODE
index|]
argument_list|,
name|tb
index|[
name|NL80211_ATTR_MAC
index|]
argument_list|,
name|tb
index|[
name|NL80211_ATTR_REQ_IE
index|]
argument_list|,
name|tb
index|[
name|NL80211_ATTR_RESP_IE
index|]
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
break|break;
case|case
name|NL80211_CMD_CH_SWITCH_NOTIFY
case|:
name|mlme_event_ch_switch
argument_list|(
name|drv
argument_list|,
name|tb
index|[
name|NL80211_ATTR_IFINDEX
index|]
argument_list|,
name|tb
index|[
name|NL80211_ATTR_WIPHY_FREQ
index|]
argument_list|,
name|tb
index|[
name|NL80211_ATTR_WIPHY_CHANNEL_TYPE
index|]
argument_list|,
name|tb
index|[
name|NL80211_ATTR_CHANNEL_WIDTH
index|]
argument_list|,
name|tb
index|[
name|NL80211_ATTR_CENTER_FREQ1
index|]
argument_list|,
name|tb
index|[
name|NL80211_ATTR_CENTER_FREQ2
index|]
argument_list|)
expr_stmt|;
break|break;
case|case
name|NL80211_CMD_DISCONNECT
case|:
name|mlme_event_disconnect
argument_list|(
name|drv
argument_list|,
name|tb
index|[
name|NL80211_ATTR_REASON_CODE
index|]
argument_list|,
name|tb
index|[
name|NL80211_ATTR_MAC
index|]
argument_list|,
name|tb
index|[
name|NL80211_ATTR_DISCONNECTED_BY_AP
index|]
argument_list|)
expr_stmt|;
break|break;
case|case
name|NL80211_CMD_MICHAEL_MIC_FAILURE
case|:
name|mlme_event_michael_mic_failure
argument_list|(
name|bss
argument_list|,
name|tb
argument_list|)
expr_stmt|;
break|break;
case|case
name|NL80211_CMD_JOIN_IBSS
case|:
name|mlme_event_join_ibss
argument_list|(
name|drv
argument_list|,
name|tb
argument_list|)
expr_stmt|;
break|break;
case|case
name|NL80211_CMD_REMAIN_ON_CHANNEL
case|:
name|mlme_event_remain_on_channel
argument_list|(
name|drv
argument_list|,
literal|0
argument_list|,
name|tb
argument_list|)
expr_stmt|;
break|break;
case|case
name|NL80211_CMD_CANCEL_REMAIN_ON_CHANNEL
case|:
name|mlme_event_remain_on_channel
argument_list|(
name|drv
argument_list|,
literal|1
argument_list|,
name|tb
argument_list|)
expr_stmt|;
break|break;
case|case
name|NL80211_CMD_NOTIFY_CQM
case|:
name|nl80211_cqm_event
argument_list|(
name|drv
argument_list|,
name|tb
argument_list|)
expr_stmt|;
break|break;
case|case
name|NL80211_CMD_REG_CHANGE
case|:
name|nl80211_reg_change_event
argument_list|(
name|drv
argument_list|,
name|tb
argument_list|)
expr_stmt|;
break|break;
case|case
name|NL80211_CMD_REG_BEACON_HINT
case|:
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"nl80211: Regulatory beacon hint"
argument_list|)
expr_stmt|;
name|os_memset
argument_list|(
operator|&
name|data
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|data
argument_list|)
argument_list|)
expr_stmt|;
name|data
operator|.
name|channel_list_changed
operator|.
name|initiator
operator|=
name|REGDOM_BEACON_HINT
expr_stmt|;
name|wpa_supplicant_event
argument_list|(
name|drv
operator|->
name|ctx
argument_list|,
name|EVENT_CHANNEL_LIST_CHANGED
argument_list|,
operator|&
name|data
argument_list|)
expr_stmt|;
break|break;
case|case
name|NL80211_CMD_NEW_STATION
case|:
name|nl80211_new_station_event
argument_list|(
name|drv
argument_list|,
name|bss
argument_list|,
name|tb
argument_list|)
expr_stmt|;
break|break;
case|case
name|NL80211_CMD_DEL_STATION
case|:
name|nl80211_del_station_event
argument_list|(
name|drv
argument_list|,
name|tb
argument_list|)
expr_stmt|;
break|break;
case|case
name|NL80211_CMD_SET_REKEY_OFFLOAD
case|:
name|nl80211_rekey_offload_event
argument_list|(
name|drv
argument_list|,
name|tb
argument_list|)
expr_stmt|;
break|break;
case|case
name|NL80211_CMD_PMKSA_CANDIDATE
case|:
name|nl80211_pmksa_candidate_event
argument_list|(
name|drv
argument_list|,
name|tb
argument_list|)
expr_stmt|;
break|break;
case|case
name|NL80211_CMD_PROBE_CLIENT
case|:
name|nl80211_client_probe_event
argument_list|(
name|drv
argument_list|,
name|tb
argument_list|)
expr_stmt|;
break|break;
case|case
name|NL80211_CMD_TDLS_OPER
case|:
name|nl80211_tdls_oper_event
argument_list|(
name|drv
argument_list|,
name|tb
argument_list|)
expr_stmt|;
break|break;
case|case
name|NL80211_CMD_CONN_FAILED
case|:
name|nl80211_connect_failed_event
argument_list|(
name|drv
argument_list|,
name|tb
argument_list|)
expr_stmt|;
break|break;
case|case
name|NL80211_CMD_FT_EVENT
case|:
name|mlme_event_ft_event
argument_list|(
name|drv
argument_list|,
name|tb
argument_list|)
expr_stmt|;
break|break;
case|case
name|NL80211_CMD_RADAR_DETECT
case|:
name|nl80211_radar_event
argument_list|(
name|drv
argument_list|,
name|tb
argument_list|)
expr_stmt|;
break|break;
case|case
name|NL80211_CMD_STOP_AP
case|:
name|nl80211_stop_ap
argument_list|(
name|drv
argument_list|,
name|tb
argument_list|)
expr_stmt|;
break|break;
case|case
name|NL80211_CMD_VENDOR
case|:
name|nl80211_vendor_event
argument_list|(
name|drv
argument_list|,
name|tb
argument_list|)
expr_stmt|;
break|break;
case|case
name|NL80211_CMD_NEW_PEER_CANDIDATE
case|:
name|nl80211_new_peer_candidate
argument_list|(
name|drv
argument_list|,
name|tb
argument_list|)
expr_stmt|;
break|break;
default|default:
name|wpa_dbg
argument_list|(
name|drv
operator|->
name|ctx
argument_list|,
name|MSG_DEBUG
argument_list|,
literal|"nl80211: Ignored unknown event "
literal|"(cmd=%d)"
argument_list|,
name|cmd
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
end_function

begin_function
name|int
name|process_global_event
parameter_list|(
name|struct
name|nl_msg
modifier|*
name|msg
parameter_list|,
name|void
modifier|*
name|arg
parameter_list|)
block|{
name|struct
name|nl80211_global
modifier|*
name|global
init|=
name|arg
decl_stmt|;
name|struct
name|genlmsghdr
modifier|*
name|gnlh
init|=
name|nlmsg_data
argument_list|(
name|nlmsg_hdr
argument_list|(
name|msg
argument_list|)
argument_list|)
decl_stmt|;
name|struct
name|nlattr
modifier|*
name|tb
index|[
name|NL80211_ATTR_MAX
operator|+
literal|1
index|]
decl_stmt|;
name|struct
name|wpa_driver_nl80211_data
modifier|*
name|drv
decl_stmt|,
modifier|*
name|tmp
decl_stmt|;
name|int
name|ifidx
init|=
operator|-
literal|1
decl_stmt|;
name|struct
name|i802_bss
modifier|*
name|bss
decl_stmt|;
name|u64
name|wdev_id
init|=
literal|0
decl_stmt|;
name|int
name|wdev_id_set
init|=
literal|0
decl_stmt|;
name|nla_parse
argument_list|(
name|tb
argument_list|,
name|NL80211_ATTR_MAX
argument_list|,
name|genlmsg_attrdata
argument_list|(
name|gnlh
argument_list|,
literal|0
argument_list|)
argument_list|,
name|genlmsg_attrlen
argument_list|(
name|gnlh
argument_list|,
literal|0
argument_list|)
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|tb
index|[
name|NL80211_ATTR_IFINDEX
index|]
condition|)
name|ifidx
operator|=
name|nla_get_u32
argument_list|(
name|tb
index|[
name|NL80211_ATTR_IFINDEX
index|]
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|tb
index|[
name|NL80211_ATTR_WDEV
index|]
condition|)
block|{
name|wdev_id
operator|=
name|nla_get_u64
argument_list|(
name|tb
index|[
name|NL80211_ATTR_WDEV
index|]
argument_list|)
expr_stmt|;
name|wdev_id_set
operator|=
literal|1
expr_stmt|;
block|}
name|dl_list_for_each_safe
argument_list|(
argument|drv
argument_list|,
argument|tmp
argument_list|,
argument|&global->interfaces
argument_list|,
argument|struct wpa_driver_nl80211_data
argument_list|,
argument|list
argument_list|)
block|{
for|for
control|(
name|bss
operator|=
name|drv
operator|->
name|first_bss
init|;
name|bss
condition|;
name|bss
operator|=
name|bss
operator|->
name|next
control|)
block|{
if|if
condition|(
operator|(
name|ifidx
operator|==
operator|-
literal|1
operator|&&
operator|!
name|wdev_id_set
operator|)
operator|||
name|ifidx
operator|==
name|bss
operator|->
name|ifindex
operator|||
operator|(
name|wdev_id_set
operator|&&
name|bss
operator|->
name|wdev_id_set
operator|&&
name|wdev_id
operator|==
name|bss
operator|->
name|wdev_id
operator|)
condition|)
block|{
name|do_process_drv_event
argument_list|(
name|bss
argument_list|,
name|gnlh
operator|->
name|cmd
argument_list|,
name|tb
argument_list|)
expr_stmt|;
return|return
name|NL_SKIP
return|;
block|}
block|}
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"nl80211: Ignored event (cmd=%d) for foreign interface (ifindex %d wdev 0x%llx)"
argument_list|,
name|gnlh
operator|->
name|cmd
argument_list|,
name|ifidx
argument_list|,
operator|(
name|long
name|long
name|unsigned
name|int
operator|)
name|wdev_id
argument_list|)
expr_stmt|;
block|}
return|return
name|NL_SKIP
return|;
block|}
end_function

begin_function
name|int
name|process_bss_event
parameter_list|(
name|struct
name|nl_msg
modifier|*
name|msg
parameter_list|,
name|void
modifier|*
name|arg
parameter_list|)
block|{
name|struct
name|i802_bss
modifier|*
name|bss
init|=
name|arg
decl_stmt|;
name|struct
name|genlmsghdr
modifier|*
name|gnlh
init|=
name|nlmsg_data
argument_list|(
name|nlmsg_hdr
argument_list|(
name|msg
argument_list|)
argument_list|)
decl_stmt|;
name|struct
name|nlattr
modifier|*
name|tb
index|[
name|NL80211_ATTR_MAX
operator|+
literal|1
index|]
decl_stmt|;
name|nla_parse
argument_list|(
name|tb
argument_list|,
name|NL80211_ATTR_MAX
argument_list|,
name|genlmsg_attrdata
argument_list|(
name|gnlh
argument_list|,
literal|0
argument_list|)
argument_list|,
name|genlmsg_attrlen
argument_list|(
name|gnlh
argument_list|,
literal|0
argument_list|)
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"nl80211: BSS Event %d (%s) received for %s"
argument_list|,
name|gnlh
operator|->
name|cmd
argument_list|,
name|nl80211_command_to_string
argument_list|(
name|gnlh
operator|->
name|cmd
argument_list|)
argument_list|,
name|bss
operator|->
name|ifname
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|gnlh
operator|->
name|cmd
condition|)
block|{
case|case
name|NL80211_CMD_FRAME
case|:
case|case
name|NL80211_CMD_FRAME_TX_STATUS
case|:
name|mlme_event
argument_list|(
name|bss
argument_list|,
name|gnlh
operator|->
name|cmd
argument_list|,
name|tb
index|[
name|NL80211_ATTR_FRAME
index|]
argument_list|,
name|tb
index|[
name|NL80211_ATTR_MAC
index|]
argument_list|,
name|tb
index|[
name|NL80211_ATTR_TIMED_OUT
index|]
argument_list|,
name|tb
index|[
name|NL80211_ATTR_WIPHY_FREQ
index|]
argument_list|,
name|tb
index|[
name|NL80211_ATTR_ACK
index|]
argument_list|,
name|tb
index|[
name|NL80211_ATTR_COOKIE
index|]
argument_list|,
name|tb
index|[
name|NL80211_ATTR_RX_SIGNAL_DBM
index|]
argument_list|,
name|tb
index|[
name|NL80211_ATTR_STA_WME
index|]
argument_list|)
expr_stmt|;
break|break;
case|case
name|NL80211_CMD_UNEXPECTED_FRAME
case|:
name|nl80211_spurious_frame
argument_list|(
name|bss
argument_list|,
name|tb
argument_list|,
literal|0
argument_list|)
expr_stmt|;
break|break;
case|case
name|NL80211_CMD_UNEXPECTED_4ADDR_FRAME
case|:
name|nl80211_spurious_frame
argument_list|(
name|bss
argument_list|,
name|tb
argument_list|,
literal|1
argument_list|)
expr_stmt|;
break|break;
default|default:
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"nl80211: Ignored unknown event "
literal|"(cmd=%d)"
argument_list|,
name|gnlh
operator|->
name|cmd
argument_list|)
expr_stmt|;
break|break;
block|}
return|return
name|NL_SKIP
return|;
block|}
end_function

end_unit


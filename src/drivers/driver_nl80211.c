begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Driver interaction with Linux nl80211/cfg80211  * Copyright (c) 2002-2015, Jouni Malinen<j@w1.fi>  * Copyright (c) 2003-2004, Instant802 Networks, Inc.  * Copyright (c) 2005-2006, Devicescape Software, Inc.  * Copyright (c) 2007, Johannes Berg<johannes@sipsolutions.net>  * Copyright (c) 2009-2010, Atheros Communications  *  * This software may be distributed under the terms of the BSD license.  * See README for more details.  */
end_comment

begin_include
include|#
directive|include
file|"includes.h"
end_include

begin_include
include|#
directive|include
file|<sys/types.h>
end_include

begin_include
include|#
directive|include
file|<fcntl.h>
end_include

begin_include
include|#
directive|include
file|<net/if.h>
end_include

begin_include
include|#
directive|include
file|<netlink/genl/genl.h>
end_include

begin_include
include|#
directive|include
file|<netlink/genl/ctrl.h>
end_include

begin_ifdef
ifdef|#
directive|ifdef
name|CONFIG_LIBNL3_ROUTE
end_ifdef

begin_include
include|#
directive|include
file|<netlink/route/neighbour.h>
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* CONFIG_LIBNL3_ROUTE */
end_comment

begin_include
include|#
directive|include
file|<linux/rtnetlink.h>
end_include

begin_include
include|#
directive|include
file|<netpacket/packet.h>
end_include

begin_include
include|#
directive|include
file|<linux/errqueue.h>
end_include

begin_include
include|#
directive|include
file|"common.h"
end_include

begin_include
include|#
directive|include
file|"eloop.h"
end_include

begin_include
include|#
directive|include
file|"common/qca-vendor.h"
end_include

begin_include
include|#
directive|include
file|"common/qca-vendor-attr.h"
end_include

begin_include
include|#
directive|include
file|"common/ieee802_11_defs.h"
end_include

begin_include
include|#
directive|include
file|"common/ieee802_11_common.h"
end_include

begin_include
include|#
directive|include
file|"l2_packet/l2_packet.h"
end_include

begin_include
include|#
directive|include
file|"netlink.h"
end_include

begin_include
include|#
directive|include
file|"linux_defines.h"
end_include

begin_include
include|#
directive|include
file|"linux_ioctl.h"
end_include

begin_include
include|#
directive|include
file|"radiotap.h"
end_include

begin_include
include|#
directive|include
file|"radiotap_iter.h"
end_include

begin_include
include|#
directive|include
file|"rfkill.h"
end_include

begin_include
include|#
directive|include
file|"driver_nl80211.h"
end_include

begin_ifndef
ifndef|#
directive|ifndef
name|CONFIG_LIBNL20
end_ifndef

begin_comment
comment|/*  * libnl 1.1 has a bug, it tries to allocate socket numbers densely  * but when you free a socket again it will mess up its bitmap and  * and use the wrong number the next time it needs a socket ID.  * Therefore, we wrap the handle alloc/destroy and add our own pid  * accounting.  */
end_comment

begin_decl_stmt
specifier|static
name|uint32_t
name|port_bitmap
index|[
literal|32
index|]
init|=
block|{
literal|0
block|}
decl_stmt|;
end_decl_stmt

begin_function
specifier|static
name|struct
name|nl_handle
modifier|*
name|nl80211_handle_alloc
parameter_list|(
name|void
modifier|*
name|cb
parameter_list|)
block|{
name|struct
name|nl_handle
modifier|*
name|handle
decl_stmt|;
name|uint32_t
name|pid
init|=
name|getpid
argument_list|()
operator|&
literal|0x3FFFFF
decl_stmt|;
name|int
name|i
decl_stmt|;
name|handle
operator|=
name|nl_handle_alloc_cb
argument_list|(
name|cb
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|1024
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|port_bitmap
index|[
name|i
operator|/
literal|32
index|]
operator|&
operator|(
literal|1
operator|<<
operator|(
name|i
operator|%
literal|32
operator|)
operator|)
condition|)
continue|continue;
name|port_bitmap
index|[
name|i
operator|/
literal|32
index|]
operator||=
literal|1
operator|<<
operator|(
name|i
operator|%
literal|32
operator|)
expr_stmt|;
name|pid
operator|+=
name|i
operator|<<
literal|22
expr_stmt|;
break|break;
block|}
name|nl_socket_set_local_port
argument_list|(
name|handle
argument_list|,
name|pid
argument_list|)
expr_stmt|;
return|return
name|handle
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|nl80211_handle_destroy
parameter_list|(
name|struct
name|nl_handle
modifier|*
name|handle
parameter_list|)
block|{
name|uint32_t
name|port
init|=
name|nl_socket_get_local_port
argument_list|(
name|handle
argument_list|)
decl_stmt|;
name|port
operator|>>=
literal|22
expr_stmt|;
name|port_bitmap
index|[
name|port
operator|/
literal|32
index|]
operator|&=
operator|~
operator|(
literal|1
operator|<<
operator|(
name|port
operator|%
literal|32
operator|)
operator|)
expr_stmt|;
name|nl_handle_destroy
argument_list|(
name|handle
argument_list|)
expr_stmt|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* CONFIG_LIBNL20 */
end_comment

begin_ifdef
ifdef|#
directive|ifdef
name|ANDROID
end_ifdef

begin_comment
comment|/* system/core/libnl_2 does not include nl_socket_set_nonblocking() */
end_comment

begin_undef
undef|#
directive|undef
name|nl_socket_set_nonblocking
end_undef

begin_define
define|#
directive|define
name|nl_socket_set_nonblocking
parameter_list|(
name|h
parameter_list|)
value|android_nl_socket_set_nonblocking(h)
end_define

begin_define
define|#
directive|define
name|genl_ctrl_resolve
value|android_genl_ctrl_resolve
end_define

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* ANDROID */
end_comment

begin_function
specifier|static
name|struct
name|nl_handle
modifier|*
name|nl_create_handle
parameter_list|(
name|struct
name|nl_cb
modifier|*
name|cb
parameter_list|,
specifier|const
name|char
modifier|*
name|dbg
parameter_list|)
block|{
name|struct
name|nl_handle
modifier|*
name|handle
decl_stmt|;
name|handle
operator|=
name|nl80211_handle_alloc
argument_list|(
name|cb
argument_list|)
expr_stmt|;
if|if
condition|(
name|handle
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"nl80211: Failed to allocate netlink "
literal|"callbacks (%s)"
argument_list|,
name|dbg
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
if|if
condition|(
name|genl_connect
argument_list|(
name|handle
argument_list|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"nl80211: Failed to connect to generic "
literal|"netlink (%s)"
argument_list|,
name|dbg
argument_list|)
expr_stmt|;
name|nl80211_handle_destroy
argument_list|(
name|handle
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
return|return
name|handle
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|nl_destroy_handles
parameter_list|(
name|struct
name|nl_handle
modifier|*
modifier|*
name|handle
parameter_list|)
block|{
if|if
condition|(
operator|*
name|handle
operator|==
name|NULL
condition|)
return|return;
name|nl80211_handle_destroy
argument_list|(
operator|*
name|handle
argument_list|)
expr_stmt|;
operator|*
name|handle
operator|=
name|NULL
expr_stmt|;
block|}
end_function

begin_if
if|#
directive|if
name|__WORDSIZE
operator|==
literal|64
end_if

begin_define
define|#
directive|define
name|ELOOP_SOCKET_INVALID
value|(intptr_t) 0x8888888888888889ULL
end_define

begin_else
else|#
directive|else
end_else

begin_define
define|#
directive|define
name|ELOOP_SOCKET_INVALID
value|(intptr_t) 0x88888889ULL
end_define

begin_endif
endif|#
directive|endif
end_endif

begin_function
specifier|static
name|void
name|nl80211_register_eloop_read
parameter_list|(
name|struct
name|nl_handle
modifier|*
modifier|*
name|handle
parameter_list|,
name|eloop_sock_handler
name|handler
parameter_list|,
name|void
modifier|*
name|eloop_data
parameter_list|)
block|{
ifdef|#
directive|ifdef
name|CONFIG_LIBNL20
comment|/* 	 * libnl uses a pretty small buffer (32 kB that gets converted to 64 kB) 	 * by default. It is possible to hit that limit in some cases where 	 * operations are blocked, e.g., with a burst of Deauthentication frames 	 * to hostapd and STA entry deletion. Try to increase the buffer to make 	 * this less likely to occur. 	 */
if|if
condition|(
name|nl_socket_set_buffer_size
argument_list|(
operator|*
name|handle
argument_list|,
literal|262144
argument_list|,
literal|0
argument_list|)
operator|<
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"nl80211: Could not set nl_socket RX buffer size: %s"
argument_list|,
name|strerror
argument_list|(
name|errno
argument_list|)
argument_list|)
expr_stmt|;
comment|/* continue anyway with the default (smaller) buffer */
block|}
endif|#
directive|endif
comment|/* CONFIG_LIBNL20 */
name|nl_socket_set_nonblocking
argument_list|(
operator|*
name|handle
argument_list|)
expr_stmt|;
name|eloop_register_read_sock
argument_list|(
name|nl_socket_get_fd
argument_list|(
operator|*
name|handle
argument_list|)
argument_list|,
name|handler
argument_list|,
name|eloop_data
argument_list|,
operator|*
name|handle
argument_list|)
expr_stmt|;
operator|*
name|handle
operator|=
operator|(
name|void
operator|*
operator|)
operator|(
operator|(
operator|(
name|intptr_t
operator|)
operator|*
name|handle
operator|)
operator|^
name|ELOOP_SOCKET_INVALID
operator|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|nl80211_destroy_eloop_handle
parameter_list|(
name|struct
name|nl_handle
modifier|*
modifier|*
name|handle
parameter_list|)
block|{
operator|*
name|handle
operator|=
operator|(
name|void
operator|*
operator|)
operator|(
operator|(
operator|(
name|intptr_t
operator|)
operator|*
name|handle
operator|)
operator|^
name|ELOOP_SOCKET_INVALID
operator|)
expr_stmt|;
name|eloop_unregister_read_sock
argument_list|(
name|nl_socket_get_fd
argument_list|(
operator|*
name|handle
argument_list|)
argument_list|)
expr_stmt|;
name|nl_destroy_handles
argument_list|(
name|handle
argument_list|)
expr_stmt|;
block|}
end_function

begin_function_decl
specifier|static
name|void
name|nl80211_global_deinit
parameter_list|(
name|void
modifier|*
name|priv
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|nl80211_check_global
parameter_list|(
name|struct
name|nl80211_global
modifier|*
name|global
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|wpa_driver_nl80211_deinit
parameter_list|(
name|struct
name|i802_bss
modifier|*
name|bss
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|wpa_driver_nl80211_set_mode_ibss
parameter_list|(
name|struct
name|i802_bss
modifier|*
name|bss
parameter_list|,
name|struct
name|hostapd_freq_params
modifier|*
name|freq
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|wpa_driver_nl80211_finish_drv_init
parameter_list|(
name|struct
name|wpa_driver_nl80211_data
modifier|*
name|drv
parameter_list|,
specifier|const
name|u8
modifier|*
name|set_addr
parameter_list|,
name|int
name|first
parameter_list|,
specifier|const
name|char
modifier|*
name|driver_params
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|nl80211_send_frame_cmd
parameter_list|(
name|struct
name|i802_bss
modifier|*
name|bss
parameter_list|,
name|unsigned
name|int
name|freq
parameter_list|,
name|unsigned
name|int
name|wait
parameter_list|,
specifier|const
name|u8
modifier|*
name|buf
parameter_list|,
name|size_t
name|buf_len
parameter_list|,
name|u64
modifier|*
name|cookie
parameter_list|,
name|int
name|no_cck
parameter_list|,
name|int
name|no_ack
parameter_list|,
name|int
name|offchanok
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|wpa_driver_nl80211_probe_req_report
parameter_list|(
name|struct
name|i802_bss
modifier|*
name|bss
parameter_list|,
name|int
name|report
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|add_ifidx
parameter_list|(
name|struct
name|wpa_driver_nl80211_data
modifier|*
name|drv
parameter_list|,
name|int
name|ifidx
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|del_ifidx
parameter_list|(
name|struct
name|wpa_driver_nl80211_data
modifier|*
name|drv
parameter_list|,
name|int
name|ifidx
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|have_ifidx
parameter_list|(
name|struct
name|wpa_driver_nl80211_data
modifier|*
name|drv
parameter_list|,
name|int
name|ifidx
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|nl80211_set_channel
parameter_list|(
name|struct
name|i802_bss
modifier|*
name|bss
parameter_list|,
name|struct
name|hostapd_freq_params
modifier|*
name|freq
parameter_list|,
name|int
name|set_chan
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|nl80211_disable_11b_rates
parameter_list|(
name|struct
name|wpa_driver_nl80211_data
modifier|*
name|drv
parameter_list|,
name|int
name|ifindex
parameter_list|,
name|int
name|disabled
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|nl80211_leave_ibss
parameter_list|(
name|struct
name|wpa_driver_nl80211_data
modifier|*
name|drv
parameter_list|,
name|int
name|reset_mode
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|i802_set_iface_flags
parameter_list|(
name|struct
name|i802_bss
modifier|*
name|bss
parameter_list|,
name|int
name|up
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|nl80211_set_param
parameter_list|(
name|void
modifier|*
name|priv
parameter_list|,
specifier|const
name|char
modifier|*
name|param
parameter_list|)
function_decl|;
end_function_decl

begin_comment
comment|/* Converts nl80211_chan_width to a common format */
end_comment

begin_function
name|enum
name|chan_width
name|convert2width
parameter_list|(
name|int
name|width
parameter_list|)
block|{
switch|switch
condition|(
name|width
condition|)
block|{
case|case
name|NL80211_CHAN_WIDTH_20_NOHT
case|:
return|return
name|CHAN_WIDTH_20_NOHT
return|;
case|case
name|NL80211_CHAN_WIDTH_20
case|:
return|return
name|CHAN_WIDTH_20
return|;
case|case
name|NL80211_CHAN_WIDTH_40
case|:
return|return
name|CHAN_WIDTH_40
return|;
case|case
name|NL80211_CHAN_WIDTH_80
case|:
return|return
name|CHAN_WIDTH_80
return|;
case|case
name|NL80211_CHAN_WIDTH_80P80
case|:
return|return
name|CHAN_WIDTH_80P80
return|;
case|case
name|NL80211_CHAN_WIDTH_160
case|:
return|return
name|CHAN_WIDTH_160
return|;
block|}
return|return
name|CHAN_WIDTH_UNKNOWN
return|;
block|}
end_function

begin_function
name|int
name|is_ap_interface
parameter_list|(
name|enum
name|nl80211_iftype
name|nlmode
parameter_list|)
block|{
return|return
name|nlmode
operator|==
name|NL80211_IFTYPE_AP
operator|||
name|nlmode
operator|==
name|NL80211_IFTYPE_P2P_GO
return|;
block|}
end_function

begin_function
name|int
name|is_sta_interface
parameter_list|(
name|enum
name|nl80211_iftype
name|nlmode
parameter_list|)
block|{
return|return
name|nlmode
operator|==
name|NL80211_IFTYPE_STATION
operator|||
name|nlmode
operator|==
name|NL80211_IFTYPE_P2P_CLIENT
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|is_p2p_net_interface
parameter_list|(
name|enum
name|nl80211_iftype
name|nlmode
parameter_list|)
block|{
return|return
name|nlmode
operator|==
name|NL80211_IFTYPE_P2P_CLIENT
operator|||
name|nlmode
operator|==
name|NL80211_IFTYPE_P2P_GO
return|;
block|}
end_function

begin_function
name|struct
name|i802_bss
modifier|*
name|get_bss_ifindex
parameter_list|(
name|struct
name|wpa_driver_nl80211_data
modifier|*
name|drv
parameter_list|,
name|int
name|ifindex
parameter_list|)
block|{
name|struct
name|i802_bss
modifier|*
name|bss
decl_stmt|;
for|for
control|(
name|bss
operator|=
name|drv
operator|->
name|first_bss
init|;
name|bss
condition|;
name|bss
operator|=
name|bss
operator|->
name|next
control|)
block|{
if|if
condition|(
name|bss
operator|->
name|ifindex
operator|==
name|ifindex
condition|)
return|return
name|bss
return|;
block|}
return|return
name|NULL
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|is_mesh_interface
parameter_list|(
name|enum
name|nl80211_iftype
name|nlmode
parameter_list|)
block|{
return|return
name|nlmode
operator|==
name|NL80211_IFTYPE_MESH_POINT
return|;
block|}
end_function

begin_function
name|void
name|nl80211_mark_disconnected
parameter_list|(
name|struct
name|wpa_driver_nl80211_data
modifier|*
name|drv
parameter_list|)
block|{
if|if
condition|(
name|drv
operator|->
name|associated
condition|)
name|os_memcpy
argument_list|(
name|drv
operator|->
name|prev_bssid
argument_list|,
name|drv
operator|->
name|bssid
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
name|drv
operator|->
name|associated
operator|=
literal|0
expr_stmt|;
name|os_memset
argument_list|(
name|drv
operator|->
name|bssid
argument_list|,
literal|0
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* nl80211 code */
end_comment

begin_function
specifier|static
name|int
name|ack_handler
parameter_list|(
name|struct
name|nl_msg
modifier|*
name|msg
parameter_list|,
name|void
modifier|*
name|arg
parameter_list|)
block|{
name|int
modifier|*
name|err
init|=
name|arg
decl_stmt|;
operator|*
name|err
operator|=
literal|0
expr_stmt|;
return|return
name|NL_STOP
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|finish_handler
parameter_list|(
name|struct
name|nl_msg
modifier|*
name|msg
parameter_list|,
name|void
modifier|*
name|arg
parameter_list|)
block|{
name|int
modifier|*
name|ret
init|=
name|arg
decl_stmt|;
operator|*
name|ret
operator|=
literal|0
expr_stmt|;
return|return
name|NL_SKIP
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|error_handler
parameter_list|(
name|struct
name|sockaddr_nl
modifier|*
name|nla
parameter_list|,
name|struct
name|nlmsgerr
modifier|*
name|err
parameter_list|,
name|void
modifier|*
name|arg
parameter_list|)
block|{
name|int
modifier|*
name|ret
init|=
name|arg
decl_stmt|;
operator|*
name|ret
operator|=
name|err
operator|->
name|error
expr_stmt|;
return|return
name|NL_SKIP
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|no_seq_check
parameter_list|(
name|struct
name|nl_msg
modifier|*
name|msg
parameter_list|,
name|void
modifier|*
name|arg
parameter_list|)
block|{
return|return
name|NL_OK
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|nl80211_nlmsg_clear
parameter_list|(
name|struct
name|nl_msg
modifier|*
name|msg
parameter_list|)
block|{
comment|/* 	 * Clear nlmsg data, e.g., to make sure key material is not left in 	 * heap memory for unnecessarily long time. 	 */
if|if
condition|(
name|msg
condition|)
block|{
name|struct
name|nlmsghdr
modifier|*
name|hdr
init|=
name|nlmsg_hdr
argument_list|(
name|msg
argument_list|)
decl_stmt|;
name|void
modifier|*
name|data
init|=
name|nlmsg_data
argument_list|(
name|hdr
argument_list|)
decl_stmt|;
comment|/* 		 * This would use nlmsg_datalen() or the older nlmsg_len() if 		 * only libnl were to maintain a stable API.. Neither will work 		 * with all released versions, so just calculate the length 		 * here. 		 */
name|int
name|len
init|=
name|hdr
operator|->
name|nlmsg_len
operator|-
name|NLMSG_HDRLEN
decl_stmt|;
name|os_memset
argument_list|(
name|data
argument_list|,
literal|0
argument_list|,
name|len
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|int
name|send_and_recv
parameter_list|(
name|struct
name|nl80211_global
modifier|*
name|global
parameter_list|,
name|struct
name|nl_handle
modifier|*
name|nl_handle
parameter_list|,
name|struct
name|nl_msg
modifier|*
name|msg
parameter_list|,
name|int
function_decl|(
modifier|*
name|valid_handler
function_decl|)
parameter_list|(
name|struct
name|nl_msg
modifier|*
parameter_list|,
name|void
modifier|*
parameter_list|)
parameter_list|,
name|void
modifier|*
name|valid_data
parameter_list|)
block|{
name|struct
name|nl_cb
modifier|*
name|cb
decl_stmt|;
name|int
name|err
init|=
operator|-
name|ENOMEM
decl_stmt|;
if|if
condition|(
operator|!
name|msg
condition|)
return|return
operator|-
name|ENOMEM
return|;
name|cb
operator|=
name|nl_cb_clone
argument_list|(
name|global
operator|->
name|nl_cb
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|cb
condition|)
goto|goto
name|out
goto|;
name|err
operator|=
name|nl_send_auto_complete
argument_list|(
name|nl_handle
argument_list|,
name|msg
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
operator|<
literal|0
condition|)
goto|goto
name|out
goto|;
name|err
operator|=
literal|1
expr_stmt|;
name|nl_cb_err
argument_list|(
name|cb
argument_list|,
name|NL_CB_CUSTOM
argument_list|,
name|error_handler
argument_list|,
operator|&
name|err
argument_list|)
expr_stmt|;
name|nl_cb_set
argument_list|(
name|cb
argument_list|,
name|NL_CB_FINISH
argument_list|,
name|NL_CB_CUSTOM
argument_list|,
name|finish_handler
argument_list|,
operator|&
name|err
argument_list|)
expr_stmt|;
name|nl_cb_set
argument_list|(
name|cb
argument_list|,
name|NL_CB_ACK
argument_list|,
name|NL_CB_CUSTOM
argument_list|,
name|ack_handler
argument_list|,
operator|&
name|err
argument_list|)
expr_stmt|;
if|if
condition|(
name|valid_handler
condition|)
name|nl_cb_set
argument_list|(
name|cb
argument_list|,
name|NL_CB_VALID
argument_list|,
name|NL_CB_CUSTOM
argument_list|,
name|valid_handler
argument_list|,
name|valid_data
argument_list|)
expr_stmt|;
while|while
condition|(
name|err
operator|>
literal|0
condition|)
block|{
name|int
name|res
init|=
name|nl_recvmsgs
argument_list|(
name|nl_handle
argument_list|,
name|cb
argument_list|)
decl_stmt|;
if|if
condition|(
name|res
operator|<
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"nl80211: %s->nl_recvmsgs failed: %d"
argument_list|,
name|__func__
argument_list|,
name|res
argument_list|)
expr_stmt|;
block|}
block|}
name|out
label|:
name|nl_cb_put
argument_list|(
name|cb
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|valid_handler
operator|&&
name|valid_data
operator|==
operator|(
name|void
operator|*
operator|)
operator|-
literal|1
condition|)
name|nl80211_nlmsg_clear
argument_list|(
name|msg
argument_list|)
expr_stmt|;
name|nlmsg_free
argument_list|(
name|msg
argument_list|)
expr_stmt|;
return|return
name|err
return|;
block|}
end_function

begin_function
name|int
name|send_and_recv_msgs
parameter_list|(
name|struct
name|wpa_driver_nl80211_data
modifier|*
name|drv
parameter_list|,
name|struct
name|nl_msg
modifier|*
name|msg
parameter_list|,
name|int
function_decl|(
modifier|*
name|valid_handler
function_decl|)
parameter_list|(
name|struct
name|nl_msg
modifier|*
parameter_list|,
name|void
modifier|*
parameter_list|)
parameter_list|,
name|void
modifier|*
name|valid_data
parameter_list|)
block|{
return|return
name|send_and_recv
argument_list|(
name|drv
operator|->
name|global
argument_list|,
name|drv
operator|->
name|global
operator|->
name|nl
argument_list|,
name|msg
argument_list|,
name|valid_handler
argument_list|,
name|valid_data
argument_list|)
return|;
block|}
end_function

begin_struct
struct|struct
name|family_data
block|{
specifier|const
name|char
modifier|*
name|group
decl_stmt|;
name|int
name|id
decl_stmt|;
block|}
struct|;
end_struct

begin_function
specifier|static
name|int
name|family_handler
parameter_list|(
name|struct
name|nl_msg
modifier|*
name|msg
parameter_list|,
name|void
modifier|*
name|arg
parameter_list|)
block|{
name|struct
name|family_data
modifier|*
name|res
init|=
name|arg
decl_stmt|;
name|struct
name|nlattr
modifier|*
name|tb
index|[
name|CTRL_ATTR_MAX
operator|+
literal|1
index|]
decl_stmt|;
name|struct
name|genlmsghdr
modifier|*
name|gnlh
init|=
name|nlmsg_data
argument_list|(
name|nlmsg_hdr
argument_list|(
name|msg
argument_list|)
argument_list|)
decl_stmt|;
name|struct
name|nlattr
modifier|*
name|mcgrp
decl_stmt|;
name|int
name|i
decl_stmt|;
name|nla_parse
argument_list|(
name|tb
argument_list|,
name|CTRL_ATTR_MAX
argument_list|,
name|genlmsg_attrdata
argument_list|(
name|gnlh
argument_list|,
literal|0
argument_list|)
argument_list|,
name|genlmsg_attrlen
argument_list|(
name|gnlh
argument_list|,
literal|0
argument_list|)
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|tb
index|[
name|CTRL_ATTR_MCAST_GROUPS
index|]
condition|)
return|return
name|NL_SKIP
return|;
name|nla_for_each_nested
argument_list|(
argument|mcgrp
argument_list|,
argument|tb[CTRL_ATTR_MCAST_GROUPS]
argument_list|,
argument|i
argument_list|)
block|{
name|struct
name|nlattr
modifier|*
name|tb2
index|[
name|CTRL_ATTR_MCAST_GRP_MAX
operator|+
literal|1
index|]
decl_stmt|;
name|nla_parse
argument_list|(
name|tb2
argument_list|,
name|CTRL_ATTR_MCAST_GRP_MAX
argument_list|,
name|nla_data
argument_list|(
name|mcgrp
argument_list|)
argument_list|,
name|nla_len
argument_list|(
name|mcgrp
argument_list|)
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|tb2
index|[
name|CTRL_ATTR_MCAST_GRP_NAME
index|]
operator|||
operator|!
name|tb2
index|[
name|CTRL_ATTR_MCAST_GRP_ID
index|]
operator|||
name|os_strncmp
argument_list|(
name|nla_data
argument_list|(
name|tb2
index|[
name|CTRL_ATTR_MCAST_GRP_NAME
index|]
argument_list|)
argument_list|,
name|res
operator|->
name|group
argument_list|,
name|nla_len
argument_list|(
name|tb2
index|[
name|CTRL_ATTR_MCAST_GRP_NAME
index|]
argument_list|)
argument_list|)
operator|!=
literal|0
condition|)
continue|continue;
name|res
operator|->
name|id
operator|=
name|nla_get_u32
argument_list|(
name|tb2
index|[
name|CTRL_ATTR_MCAST_GRP_ID
index|]
argument_list|)
expr_stmt|;
break|break;
block|}
empty_stmt|;
return|return
name|NL_SKIP
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|nl_get_multicast_id
parameter_list|(
name|struct
name|nl80211_global
modifier|*
name|global
parameter_list|,
specifier|const
name|char
modifier|*
name|family
parameter_list|,
specifier|const
name|char
modifier|*
name|group
parameter_list|)
block|{
name|struct
name|nl_msg
modifier|*
name|msg
decl_stmt|;
name|int
name|ret
decl_stmt|;
name|struct
name|family_data
name|res
init|=
block|{
name|group
block|,
operator|-
name|ENOENT
block|}
decl_stmt|;
name|msg
operator|=
name|nlmsg_alloc
argument_list|()
expr_stmt|;
if|if
condition|(
operator|!
name|msg
condition|)
return|return
operator|-
name|ENOMEM
return|;
if|if
condition|(
operator|!
name|genlmsg_put
argument_list|(
name|msg
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
name|genl_ctrl_resolve
argument_list|(
name|global
operator|->
name|nl
argument_list|,
literal|"nlctrl"
argument_list|)
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
name|CTRL_CMD_GETFAMILY
argument_list|,
literal|0
argument_list|)
operator|||
name|nla_put_string
argument_list|(
name|msg
argument_list|,
name|CTRL_ATTR_FAMILY_NAME
argument_list|,
name|family
argument_list|)
condition|)
block|{
name|nlmsg_free
argument_list|(
name|msg
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|ret
operator|=
name|send_and_recv
argument_list|(
name|global
argument_list|,
name|global
operator|->
name|nl
argument_list|,
name|msg
argument_list|,
name|family_handler
argument_list|,
operator|&
name|res
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|==
literal|0
condition|)
name|ret
operator|=
name|res
operator|.
name|id
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_function
name|void
modifier|*
name|nl80211_cmd
parameter_list|(
name|struct
name|wpa_driver_nl80211_data
modifier|*
name|drv
parameter_list|,
name|struct
name|nl_msg
modifier|*
name|msg
parameter_list|,
name|int
name|flags
parameter_list|,
name|uint8_t
name|cmd
parameter_list|)
block|{
return|return
name|genlmsg_put
argument_list|(
name|msg
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
name|drv
operator|->
name|global
operator|->
name|nl80211_id
argument_list|,
literal|0
argument_list|,
name|flags
argument_list|,
name|cmd
argument_list|,
literal|0
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|nl80211_set_iface_id
parameter_list|(
name|struct
name|nl_msg
modifier|*
name|msg
parameter_list|,
name|struct
name|i802_bss
modifier|*
name|bss
parameter_list|)
block|{
if|if
condition|(
name|bss
operator|->
name|wdev_id_set
condition|)
return|return
name|nla_put_u64
argument_list|(
name|msg
argument_list|,
name|NL80211_ATTR_WDEV
argument_list|,
name|bss
operator|->
name|wdev_id
argument_list|)
return|;
return|return
name|nla_put_u32
argument_list|(
name|msg
argument_list|,
name|NL80211_ATTR_IFINDEX
argument_list|,
name|bss
operator|->
name|ifindex
argument_list|)
return|;
block|}
end_function

begin_function
name|struct
name|nl_msg
modifier|*
name|nl80211_cmd_msg
parameter_list|(
name|struct
name|i802_bss
modifier|*
name|bss
parameter_list|,
name|int
name|flags
parameter_list|,
name|uint8_t
name|cmd
parameter_list|)
block|{
name|struct
name|nl_msg
modifier|*
name|msg
decl_stmt|;
name|msg
operator|=
name|nlmsg_alloc
argument_list|()
expr_stmt|;
if|if
condition|(
operator|!
name|msg
condition|)
return|return
name|NULL
return|;
if|if
condition|(
operator|!
name|nl80211_cmd
argument_list|(
name|bss
operator|->
name|drv
argument_list|,
name|msg
argument_list|,
name|flags
argument_list|,
name|cmd
argument_list|)
operator|||
name|nl80211_set_iface_id
argument_list|(
name|msg
argument_list|,
name|bss
argument_list|)
operator|<
literal|0
condition|)
block|{
name|nlmsg_free
argument_list|(
name|msg
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
return|return
name|msg
return|;
block|}
end_function

begin_function
specifier|static
name|struct
name|nl_msg
modifier|*
name|nl80211_ifindex_msg
parameter_list|(
name|struct
name|wpa_driver_nl80211_data
modifier|*
name|drv
parameter_list|,
name|int
name|ifindex
parameter_list|,
name|int
name|flags
parameter_list|,
name|uint8_t
name|cmd
parameter_list|)
block|{
name|struct
name|nl_msg
modifier|*
name|msg
decl_stmt|;
name|msg
operator|=
name|nlmsg_alloc
argument_list|()
expr_stmt|;
if|if
condition|(
operator|!
name|msg
condition|)
return|return
name|NULL
return|;
if|if
condition|(
operator|!
name|nl80211_cmd
argument_list|(
name|drv
argument_list|,
name|msg
argument_list|,
name|flags
argument_list|,
name|cmd
argument_list|)
operator|||
name|nla_put_u32
argument_list|(
name|msg
argument_list|,
name|NL80211_ATTR_IFINDEX
argument_list|,
name|ifindex
argument_list|)
condition|)
block|{
name|nlmsg_free
argument_list|(
name|msg
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
return|return
name|msg
return|;
block|}
end_function

begin_function
name|struct
name|nl_msg
modifier|*
name|nl80211_drv_msg
parameter_list|(
name|struct
name|wpa_driver_nl80211_data
modifier|*
name|drv
parameter_list|,
name|int
name|flags
parameter_list|,
name|uint8_t
name|cmd
parameter_list|)
block|{
return|return
name|nl80211_ifindex_msg
argument_list|(
name|drv
argument_list|,
name|drv
operator|->
name|ifindex
argument_list|,
name|flags
argument_list|,
name|cmd
argument_list|)
return|;
block|}
end_function

begin_function
name|struct
name|nl_msg
modifier|*
name|nl80211_bss_msg
parameter_list|(
name|struct
name|i802_bss
modifier|*
name|bss
parameter_list|,
name|int
name|flags
parameter_list|,
name|uint8_t
name|cmd
parameter_list|)
block|{
return|return
name|nl80211_ifindex_msg
argument_list|(
name|bss
operator|->
name|drv
argument_list|,
name|bss
operator|->
name|ifindex
argument_list|,
name|flags
argument_list|,
name|cmd
argument_list|)
return|;
block|}
end_function

begin_struct
struct|struct
name|wiphy_idx_data
block|{
name|int
name|wiphy_idx
decl_stmt|;
name|enum
name|nl80211_iftype
name|nlmode
decl_stmt|;
name|u8
modifier|*
name|macaddr
decl_stmt|;
block|}
struct|;
end_struct

begin_function
specifier|static
name|int
name|netdev_info_handler
parameter_list|(
name|struct
name|nl_msg
modifier|*
name|msg
parameter_list|,
name|void
modifier|*
name|arg
parameter_list|)
block|{
name|struct
name|nlattr
modifier|*
name|tb
index|[
name|NL80211_ATTR_MAX
operator|+
literal|1
index|]
decl_stmt|;
name|struct
name|genlmsghdr
modifier|*
name|gnlh
init|=
name|nlmsg_data
argument_list|(
name|nlmsg_hdr
argument_list|(
name|msg
argument_list|)
argument_list|)
decl_stmt|;
name|struct
name|wiphy_idx_data
modifier|*
name|info
init|=
name|arg
decl_stmt|;
name|nla_parse
argument_list|(
name|tb
argument_list|,
name|NL80211_ATTR_MAX
argument_list|,
name|genlmsg_attrdata
argument_list|(
name|gnlh
argument_list|,
literal|0
argument_list|)
argument_list|,
name|genlmsg_attrlen
argument_list|(
name|gnlh
argument_list|,
literal|0
argument_list|)
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|tb
index|[
name|NL80211_ATTR_WIPHY
index|]
condition|)
name|info
operator|->
name|wiphy_idx
operator|=
name|nla_get_u32
argument_list|(
name|tb
index|[
name|NL80211_ATTR_WIPHY
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|tb
index|[
name|NL80211_ATTR_IFTYPE
index|]
condition|)
name|info
operator|->
name|nlmode
operator|=
name|nla_get_u32
argument_list|(
name|tb
index|[
name|NL80211_ATTR_IFTYPE
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|tb
index|[
name|NL80211_ATTR_MAC
index|]
operator|&&
name|info
operator|->
name|macaddr
condition|)
name|os_memcpy
argument_list|(
name|info
operator|->
name|macaddr
argument_list|,
name|nla_data
argument_list|(
name|tb
index|[
name|NL80211_ATTR_MAC
index|]
argument_list|)
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
return|return
name|NL_SKIP
return|;
block|}
end_function

begin_function
name|int
name|nl80211_get_wiphy_index
parameter_list|(
name|struct
name|i802_bss
modifier|*
name|bss
parameter_list|)
block|{
name|struct
name|nl_msg
modifier|*
name|msg
decl_stmt|;
name|struct
name|wiphy_idx_data
name|data
init|=
block|{
operator|.
name|wiphy_idx
operator|=
operator|-
literal|1
block|,
operator|.
name|macaddr
operator|=
name|NULL
block|, 	}
decl_stmt|;
if|if
condition|(
operator|!
operator|(
name|msg
operator|=
name|nl80211_cmd_msg
argument_list|(
name|bss
argument_list|,
literal|0
argument_list|,
name|NL80211_CMD_GET_INTERFACE
argument_list|)
operator|)
condition|)
return|return
operator|-
literal|1
return|;
if|if
condition|(
name|send_and_recv_msgs
argument_list|(
name|bss
operator|->
name|drv
argument_list|,
name|msg
argument_list|,
name|netdev_info_handler
argument_list|,
operator|&
name|data
argument_list|)
operator|==
literal|0
condition|)
return|return
name|data
operator|.
name|wiphy_idx
return|;
return|return
operator|-
literal|1
return|;
block|}
end_function

begin_function
specifier|static
name|enum
name|nl80211_iftype
name|nl80211_get_ifmode
parameter_list|(
name|struct
name|i802_bss
modifier|*
name|bss
parameter_list|)
block|{
name|struct
name|nl_msg
modifier|*
name|msg
decl_stmt|;
name|struct
name|wiphy_idx_data
name|data
init|=
block|{
operator|.
name|nlmode
operator|=
name|NL80211_IFTYPE_UNSPECIFIED
block|,
operator|.
name|macaddr
operator|=
name|NULL
block|, 	}
decl_stmt|;
if|if
condition|(
operator|!
operator|(
name|msg
operator|=
name|nl80211_cmd_msg
argument_list|(
name|bss
argument_list|,
literal|0
argument_list|,
name|NL80211_CMD_GET_INTERFACE
argument_list|)
operator|)
condition|)
return|return
name|NL80211_IFTYPE_UNSPECIFIED
return|;
if|if
condition|(
name|send_and_recv_msgs
argument_list|(
name|bss
operator|->
name|drv
argument_list|,
name|msg
argument_list|,
name|netdev_info_handler
argument_list|,
operator|&
name|data
argument_list|)
operator|==
literal|0
condition|)
return|return
name|data
operator|.
name|nlmode
return|;
return|return
name|NL80211_IFTYPE_UNSPECIFIED
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|nl80211_get_macaddr
parameter_list|(
name|struct
name|i802_bss
modifier|*
name|bss
parameter_list|)
block|{
name|struct
name|nl_msg
modifier|*
name|msg
decl_stmt|;
name|struct
name|wiphy_idx_data
name|data
init|=
block|{
operator|.
name|macaddr
operator|=
name|bss
operator|->
name|addr
block|, 	}
decl_stmt|;
if|if
condition|(
operator|!
operator|(
name|msg
operator|=
name|nl80211_cmd_msg
argument_list|(
name|bss
argument_list|,
literal|0
argument_list|,
name|NL80211_CMD_GET_INTERFACE
argument_list|)
operator|)
condition|)
return|return
operator|-
literal|1
return|;
return|return
name|send_and_recv_msgs
argument_list|(
name|bss
operator|->
name|drv
argument_list|,
name|msg
argument_list|,
name|netdev_info_handler
argument_list|,
operator|&
name|data
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|nl80211_register_beacons
parameter_list|(
name|struct
name|wpa_driver_nl80211_data
modifier|*
name|drv
parameter_list|,
name|struct
name|nl80211_wiphy_data
modifier|*
name|w
parameter_list|)
block|{
name|struct
name|nl_msg
modifier|*
name|msg
decl_stmt|;
name|int
name|ret
decl_stmt|;
name|msg
operator|=
name|nlmsg_alloc
argument_list|()
expr_stmt|;
if|if
condition|(
operator|!
name|msg
condition|)
return|return
operator|-
literal|1
return|;
if|if
condition|(
operator|!
name|nl80211_cmd
argument_list|(
name|drv
argument_list|,
name|msg
argument_list|,
literal|0
argument_list|,
name|NL80211_CMD_REGISTER_BEACONS
argument_list|)
operator|||
name|nla_put_u32
argument_list|(
name|msg
argument_list|,
name|NL80211_ATTR_WIPHY
argument_list|,
name|w
operator|->
name|wiphy_idx
argument_list|)
condition|)
block|{
name|nlmsg_free
argument_list|(
name|msg
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|ret
operator|=
name|send_and_recv
argument_list|(
name|drv
operator|->
name|global
argument_list|,
name|w
operator|->
name|nl_beacons
argument_list|,
name|msg
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"nl80211: Register beacons command "
literal|"failed: ret=%d (%s)"
argument_list|,
name|ret
argument_list|,
name|strerror
argument_list|(
operator|-
name|ret
argument_list|)
argument_list|)
expr_stmt|;
block|}
return|return
name|ret
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|nl80211_recv_beacons
parameter_list|(
name|int
name|sock
parameter_list|,
name|void
modifier|*
name|eloop_ctx
parameter_list|,
name|void
modifier|*
name|handle
parameter_list|)
block|{
name|struct
name|nl80211_wiphy_data
modifier|*
name|w
init|=
name|eloop_ctx
decl_stmt|;
name|int
name|res
decl_stmt|;
name|wpa_printf
argument_list|(
name|MSG_EXCESSIVE
argument_list|,
literal|"nl80211: Beacon event message available"
argument_list|)
expr_stmt|;
name|res
operator|=
name|nl_recvmsgs
argument_list|(
name|handle
argument_list|,
name|w
operator|->
name|nl_cb
argument_list|)
expr_stmt|;
if|if
condition|(
name|res
operator|<
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"nl80211: %s->nl_recvmsgs failed: %d"
argument_list|,
name|__func__
argument_list|,
name|res
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|int
name|process_beacon_event
parameter_list|(
name|struct
name|nl_msg
modifier|*
name|msg
parameter_list|,
name|void
modifier|*
name|arg
parameter_list|)
block|{
name|struct
name|nl80211_wiphy_data
modifier|*
name|w
init|=
name|arg
decl_stmt|;
name|struct
name|wpa_driver_nl80211_data
modifier|*
name|drv
decl_stmt|;
name|struct
name|genlmsghdr
modifier|*
name|gnlh
init|=
name|nlmsg_data
argument_list|(
name|nlmsg_hdr
argument_list|(
name|msg
argument_list|)
argument_list|)
decl_stmt|;
name|struct
name|nlattr
modifier|*
name|tb
index|[
name|NL80211_ATTR_MAX
operator|+
literal|1
index|]
decl_stmt|;
name|union
name|wpa_event_data
name|event
decl_stmt|;
name|nla_parse
argument_list|(
name|tb
argument_list|,
name|NL80211_ATTR_MAX
argument_list|,
name|genlmsg_attrdata
argument_list|(
name|gnlh
argument_list|,
literal|0
argument_list|)
argument_list|,
name|genlmsg_attrlen
argument_list|(
name|gnlh
argument_list|,
literal|0
argument_list|)
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|gnlh
operator|->
name|cmd
operator|!=
name|NL80211_CMD_FRAME
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"nl80211: Unexpected beacon event? (%d)"
argument_list|,
name|gnlh
operator|->
name|cmd
argument_list|)
expr_stmt|;
return|return
name|NL_SKIP
return|;
block|}
if|if
condition|(
operator|!
name|tb
index|[
name|NL80211_ATTR_FRAME
index|]
condition|)
return|return
name|NL_SKIP
return|;
name|dl_list_for_each
argument_list|(
argument|drv
argument_list|,
argument|&w->drvs
argument_list|,
argument|struct wpa_driver_nl80211_data
argument_list|,
argument|wiphy_list
argument_list|)
block|{
name|os_memset
argument_list|(
operator|&
name|event
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|event
argument_list|)
argument_list|)
expr_stmt|;
name|event
operator|.
name|rx_mgmt
operator|.
name|frame
operator|=
name|nla_data
argument_list|(
name|tb
index|[
name|NL80211_ATTR_FRAME
index|]
argument_list|)
expr_stmt|;
name|event
operator|.
name|rx_mgmt
operator|.
name|frame_len
operator|=
name|nla_len
argument_list|(
name|tb
index|[
name|NL80211_ATTR_FRAME
index|]
argument_list|)
expr_stmt|;
name|wpa_supplicant_event
argument_list|(
name|drv
operator|->
name|ctx
argument_list|,
name|EVENT_RX_MGMT
argument_list|,
operator|&
name|event
argument_list|)
expr_stmt|;
block|}
return|return
name|NL_SKIP
return|;
block|}
end_function

begin_function
specifier|static
name|struct
name|nl80211_wiphy_data
modifier|*
name|nl80211_get_wiphy_data_ap
parameter_list|(
name|struct
name|i802_bss
modifier|*
name|bss
parameter_list|)
block|{
specifier|static
name|DEFINE_DL_LIST
argument_list|(
name|nl80211_wiphys
argument_list|)
expr_stmt|;
name|struct
name|nl80211_wiphy_data
modifier|*
name|w
decl_stmt|;
name|int
name|wiphy_idx
decl_stmt|,
name|found
init|=
literal|0
decl_stmt|;
name|struct
name|i802_bss
modifier|*
name|tmp_bss
decl_stmt|;
if|if
condition|(
name|bss
operator|->
name|wiphy_data
operator|!=
name|NULL
condition|)
return|return
name|bss
operator|->
name|wiphy_data
return|;
name|wiphy_idx
operator|=
name|nl80211_get_wiphy_index
argument_list|(
name|bss
argument_list|)
expr_stmt|;
name|dl_list_for_each
argument_list|(
argument|w
argument_list|,
argument|&nl80211_wiphys
argument_list|,
argument|struct nl80211_wiphy_data
argument_list|,
argument|list
argument_list|)
block|{
if|if
condition|(
name|w
operator|->
name|wiphy_idx
operator|==
name|wiphy_idx
condition|)
goto|goto
name|add
goto|;
block|}
comment|/* alloc new one */
name|w
operator|=
name|os_zalloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|w
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|w
operator|==
name|NULL
condition|)
return|return
name|NULL
return|;
name|w
operator|->
name|wiphy_idx
operator|=
name|wiphy_idx
expr_stmt|;
name|dl_list_init
argument_list|(
operator|&
name|w
operator|->
name|bsss
argument_list|)
expr_stmt|;
name|dl_list_init
argument_list|(
operator|&
name|w
operator|->
name|drvs
argument_list|)
expr_stmt|;
name|w
operator|->
name|nl_cb
operator|=
name|nl_cb_alloc
argument_list|(
name|NL_CB_DEFAULT
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|w
operator|->
name|nl_cb
condition|)
block|{
name|os_free
argument_list|(
name|w
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|nl_cb_set
argument_list|(
name|w
operator|->
name|nl_cb
argument_list|,
name|NL_CB_SEQ_CHECK
argument_list|,
name|NL_CB_CUSTOM
argument_list|,
name|no_seq_check
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|nl_cb_set
argument_list|(
name|w
operator|->
name|nl_cb
argument_list|,
name|NL_CB_VALID
argument_list|,
name|NL_CB_CUSTOM
argument_list|,
name|process_beacon_event
argument_list|,
name|w
argument_list|)
expr_stmt|;
name|w
operator|->
name|nl_beacons
operator|=
name|nl_create_handle
argument_list|(
name|bss
operator|->
name|drv
operator|->
name|global
operator|->
name|nl_cb
argument_list|,
literal|"wiphy beacons"
argument_list|)
expr_stmt|;
if|if
condition|(
name|w
operator|->
name|nl_beacons
operator|==
name|NULL
condition|)
block|{
name|os_free
argument_list|(
name|w
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
if|if
condition|(
name|nl80211_register_beacons
argument_list|(
name|bss
operator|->
name|drv
argument_list|,
name|w
argument_list|)
condition|)
block|{
name|nl_destroy_handles
argument_list|(
operator|&
name|w
operator|->
name|nl_beacons
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|w
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|nl80211_register_eloop_read
argument_list|(
operator|&
name|w
operator|->
name|nl_beacons
argument_list|,
name|nl80211_recv_beacons
argument_list|,
name|w
argument_list|)
expr_stmt|;
name|dl_list_add
argument_list|(
operator|&
name|nl80211_wiphys
argument_list|,
operator|&
name|w
operator|->
name|list
argument_list|)
expr_stmt|;
name|add
label|:
comment|/* drv entry for this bss already there? */
name|dl_list_for_each
argument_list|(
argument|tmp_bss
argument_list|,
argument|&w->bsss
argument_list|,
argument|struct i802_bss
argument_list|,
argument|wiphy_list
argument_list|)
block|{
if|if
condition|(
name|tmp_bss
operator|->
name|drv
operator|==
name|bss
operator|->
name|drv
condition|)
block|{
name|found
operator|=
literal|1
expr_stmt|;
break|break;
block|}
block|}
comment|/* if not add it */
if|if
condition|(
operator|!
name|found
condition|)
name|dl_list_add
argument_list|(
operator|&
name|w
operator|->
name|drvs
argument_list|,
operator|&
name|bss
operator|->
name|drv
operator|->
name|wiphy_list
argument_list|)
expr_stmt|;
name|dl_list_add
argument_list|(
operator|&
name|w
operator|->
name|bsss
argument_list|,
operator|&
name|bss
operator|->
name|wiphy_list
argument_list|)
expr_stmt|;
name|bss
operator|->
name|wiphy_data
operator|=
name|w
expr_stmt|;
return|return
name|w
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|nl80211_put_wiphy_data_ap
parameter_list|(
name|struct
name|i802_bss
modifier|*
name|bss
parameter_list|)
block|{
name|struct
name|nl80211_wiphy_data
modifier|*
name|w
init|=
name|bss
operator|->
name|wiphy_data
decl_stmt|;
name|struct
name|i802_bss
modifier|*
name|tmp_bss
decl_stmt|;
name|int
name|found
init|=
literal|0
decl_stmt|;
if|if
condition|(
name|w
operator|==
name|NULL
condition|)
return|return;
name|bss
operator|->
name|wiphy_data
operator|=
name|NULL
expr_stmt|;
name|dl_list_del
argument_list|(
operator|&
name|bss
operator|->
name|wiphy_list
argument_list|)
expr_stmt|;
comment|/* still any for this drv present? */
name|dl_list_for_each
argument_list|(
argument|tmp_bss
argument_list|,
argument|&w->bsss
argument_list|,
argument|struct i802_bss
argument_list|,
argument|wiphy_list
argument_list|)
block|{
if|if
condition|(
name|tmp_bss
operator|->
name|drv
operator|==
name|bss
operator|->
name|drv
condition|)
block|{
name|found
operator|=
literal|1
expr_stmt|;
break|break;
block|}
block|}
comment|/* if not remove it */
if|if
condition|(
operator|!
name|found
condition|)
name|dl_list_del
argument_list|(
operator|&
name|bss
operator|->
name|drv
operator|->
name|wiphy_list
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|dl_list_empty
argument_list|(
operator|&
name|w
operator|->
name|bsss
argument_list|)
condition|)
return|return;
name|nl80211_destroy_eloop_handle
argument_list|(
operator|&
name|w
operator|->
name|nl_beacons
argument_list|)
expr_stmt|;
name|nl_cb_put
argument_list|(
name|w
operator|->
name|nl_cb
argument_list|)
expr_stmt|;
name|dl_list_del
argument_list|(
operator|&
name|w
operator|->
name|list
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|w
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|wpa_driver_nl80211_get_bssid
parameter_list|(
name|void
modifier|*
name|priv
parameter_list|,
name|u8
modifier|*
name|bssid
parameter_list|)
block|{
name|struct
name|i802_bss
modifier|*
name|bss
init|=
name|priv
decl_stmt|;
name|struct
name|wpa_driver_nl80211_data
modifier|*
name|drv
init|=
name|bss
operator|->
name|drv
decl_stmt|;
if|if
condition|(
operator|!
name|drv
operator|->
name|associated
condition|)
return|return
operator|-
literal|1
return|;
name|os_memcpy
argument_list|(
name|bssid
argument_list|,
name|drv
operator|->
name|bssid
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|wpa_driver_nl80211_get_ssid
parameter_list|(
name|void
modifier|*
name|priv
parameter_list|,
name|u8
modifier|*
name|ssid
parameter_list|)
block|{
name|struct
name|i802_bss
modifier|*
name|bss
init|=
name|priv
decl_stmt|;
name|struct
name|wpa_driver_nl80211_data
modifier|*
name|drv
init|=
name|bss
operator|->
name|drv
decl_stmt|;
if|if
condition|(
operator|!
name|drv
operator|->
name|associated
condition|)
return|return
operator|-
literal|1
return|;
name|os_memcpy
argument_list|(
name|ssid
argument_list|,
name|drv
operator|->
name|ssid
argument_list|,
name|drv
operator|->
name|ssid_len
argument_list|)
expr_stmt|;
return|return
name|drv
operator|->
name|ssid_len
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|wpa_driver_nl80211_event_newlink
parameter_list|(
name|struct
name|wpa_driver_nl80211_data
modifier|*
name|drv
parameter_list|,
specifier|const
name|char
modifier|*
name|ifname
parameter_list|)
block|{
name|union
name|wpa_event_data
name|event
decl_stmt|;
if|if
condition|(
name|os_strcmp
argument_list|(
name|drv
operator|->
name|first_bss
operator|->
name|ifname
argument_list|,
name|ifname
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|if_nametoindex
argument_list|(
name|drv
operator|->
name|first_bss
operator|->
name|ifname
argument_list|)
operator|==
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"nl80211: Interface %s does not exist - ignore RTM_NEWLINK"
argument_list|,
name|drv
operator|->
name|first_bss
operator|->
name|ifname
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
operator|!
name|drv
operator|->
name|if_removed
condition|)
return|return;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"nl80211: Mark if_removed=0 for %s based on RTM_NEWLINK event"
argument_list|,
name|drv
operator|->
name|first_bss
operator|->
name|ifname
argument_list|)
expr_stmt|;
name|drv
operator|->
name|if_removed
operator|=
literal|0
expr_stmt|;
block|}
name|os_memset
argument_list|(
operator|&
name|event
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|event
argument_list|)
argument_list|)
expr_stmt|;
name|os_strlcpy
argument_list|(
name|event
operator|.
name|interface_status
operator|.
name|ifname
argument_list|,
name|ifname
argument_list|,
sizeof|sizeof
argument_list|(
name|event
operator|.
name|interface_status
operator|.
name|ifname
argument_list|)
argument_list|)
expr_stmt|;
name|event
operator|.
name|interface_status
operator|.
name|ievent
operator|=
name|EVENT_INTERFACE_ADDED
expr_stmt|;
name|wpa_supplicant_event
argument_list|(
name|drv
operator|->
name|ctx
argument_list|,
name|EVENT_INTERFACE_STATUS
argument_list|,
operator|&
name|event
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|wpa_driver_nl80211_event_dellink
parameter_list|(
name|struct
name|wpa_driver_nl80211_data
modifier|*
name|drv
parameter_list|,
specifier|const
name|char
modifier|*
name|ifname
parameter_list|)
block|{
name|union
name|wpa_event_data
name|event
decl_stmt|;
if|if
condition|(
name|os_strcmp
argument_list|(
name|drv
operator|->
name|first_bss
operator|->
name|ifname
argument_list|,
name|ifname
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|drv
operator|->
name|if_removed
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"nl80211: if_removed already set - ignore RTM_DELLINK event for %s"
argument_list|,
name|ifname
argument_list|)
expr_stmt|;
return|return;
block|}
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"RTM_DELLINK: Interface '%s' removed - mark if_removed=1"
argument_list|,
name|ifname
argument_list|)
expr_stmt|;
name|drv
operator|->
name|if_removed
operator|=
literal|1
expr_stmt|;
block|}
else|else
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"RTM_DELLINK: Interface '%s' removed"
argument_list|,
name|ifname
argument_list|)
expr_stmt|;
block|}
name|os_memset
argument_list|(
operator|&
name|event
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|event
argument_list|)
argument_list|)
expr_stmt|;
name|os_strlcpy
argument_list|(
name|event
operator|.
name|interface_status
operator|.
name|ifname
argument_list|,
name|ifname
argument_list|,
sizeof|sizeof
argument_list|(
name|event
operator|.
name|interface_status
operator|.
name|ifname
argument_list|)
argument_list|)
expr_stmt|;
name|event
operator|.
name|interface_status
operator|.
name|ievent
operator|=
name|EVENT_INTERFACE_REMOVED
expr_stmt|;
name|wpa_supplicant_event
argument_list|(
name|drv
operator|->
name|ctx
argument_list|,
name|EVENT_INTERFACE_STATUS
argument_list|,
operator|&
name|event
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|wpa_driver_nl80211_own_ifname
parameter_list|(
name|struct
name|wpa_driver_nl80211_data
modifier|*
name|drv
parameter_list|,
name|u8
modifier|*
name|buf
parameter_list|,
name|size_t
name|len
parameter_list|)
block|{
name|int
name|attrlen
decl_stmt|,
name|rta_len
decl_stmt|;
name|struct
name|rtattr
modifier|*
name|attr
decl_stmt|;
name|attrlen
operator|=
name|len
expr_stmt|;
name|attr
operator|=
operator|(
expr|struct
name|rtattr
operator|*
operator|)
name|buf
expr_stmt|;
name|rta_len
operator|=
name|RTA_ALIGN
argument_list|(
sizeof|sizeof
argument_list|(
expr|struct
name|rtattr
argument_list|)
argument_list|)
expr_stmt|;
while|while
condition|(
name|RTA_OK
argument_list|(
name|attr
argument_list|,
name|attrlen
argument_list|)
condition|)
block|{
if|if
condition|(
name|attr
operator|->
name|rta_type
operator|==
name|IFLA_IFNAME
condition|)
block|{
if|if
condition|(
name|os_strcmp
argument_list|(
operator|(
operator|(
name|char
operator|*
operator|)
name|attr
operator|)
operator|+
name|rta_len
argument_list|,
name|drv
operator|->
name|first_bss
operator|->
name|ifname
argument_list|)
operator|==
literal|0
condition|)
return|return
literal|1
return|;
else|else
break|break;
block|}
name|attr
operator|=
name|RTA_NEXT
argument_list|(
name|attr
argument_list|,
name|attrlen
argument_list|)
expr_stmt|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|wpa_driver_nl80211_own_ifindex
parameter_list|(
name|struct
name|wpa_driver_nl80211_data
modifier|*
name|drv
parameter_list|,
name|int
name|ifindex
parameter_list|,
name|u8
modifier|*
name|buf
parameter_list|,
name|size_t
name|len
parameter_list|)
block|{
if|if
condition|(
name|drv
operator|->
name|ifindex
operator|==
name|ifindex
condition|)
return|return
literal|1
return|;
if|if
condition|(
name|drv
operator|->
name|if_removed
operator|&&
name|wpa_driver_nl80211_own_ifname
argument_list|(
name|drv
argument_list|,
name|buf
argument_list|,
name|len
argument_list|)
condition|)
block|{
name|nl80211_check_global
argument_list|(
name|drv
operator|->
name|global
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"nl80211: Update ifindex for a removed "
literal|"interface"
argument_list|)
expr_stmt|;
name|wpa_driver_nl80211_finish_drv_init
argument_list|(
name|drv
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
return|return
literal|1
return|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|struct
name|wpa_driver_nl80211_data
modifier|*
name|nl80211_find_drv
parameter_list|(
name|struct
name|nl80211_global
modifier|*
name|global
parameter_list|,
name|int
name|idx
parameter_list|,
name|u8
modifier|*
name|buf
parameter_list|,
name|size_t
name|len
parameter_list|)
block|{
name|struct
name|wpa_driver_nl80211_data
modifier|*
name|drv
decl_stmt|;
name|dl_list_for_each
argument_list|(
argument|drv
argument_list|,
argument|&global->interfaces
argument_list|,
argument|struct wpa_driver_nl80211_data
argument_list|,
argument|list
argument_list|)
block|{
if|if
condition|(
name|wpa_driver_nl80211_own_ifindex
argument_list|(
name|drv
argument_list|,
name|idx
argument_list|,
name|buf
argument_list|,
name|len
argument_list|)
operator|||
name|have_ifidx
argument_list|(
name|drv
argument_list|,
name|idx
argument_list|)
condition|)
return|return
name|drv
return|;
block|}
return|return
name|NULL
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|wpa_driver_nl80211_event_rtm_newlink
parameter_list|(
name|void
modifier|*
name|ctx
parameter_list|,
name|struct
name|ifinfomsg
modifier|*
name|ifi
parameter_list|,
name|u8
modifier|*
name|buf
parameter_list|,
name|size_t
name|len
parameter_list|)
block|{
name|struct
name|nl80211_global
modifier|*
name|global
init|=
name|ctx
decl_stmt|;
name|struct
name|wpa_driver_nl80211_data
modifier|*
name|drv
decl_stmt|;
name|int
name|attrlen
decl_stmt|;
name|struct
name|rtattr
modifier|*
name|attr
decl_stmt|;
name|u32
name|brid
init|=
literal|0
decl_stmt|;
name|char
name|namebuf
index|[
name|IFNAMSIZ
index|]
decl_stmt|;
name|char
name|ifname
index|[
name|IFNAMSIZ
operator|+
literal|1
index|]
decl_stmt|;
name|char
name|extra
index|[
literal|100
index|]
decl_stmt|,
modifier|*
name|pos
decl_stmt|,
modifier|*
name|end
decl_stmt|;
name|drv
operator|=
name|nl80211_find_drv
argument_list|(
name|global
argument_list|,
name|ifi
operator|->
name|ifi_index
argument_list|,
name|buf
argument_list|,
name|len
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|drv
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"nl80211: Ignore RTM_NEWLINK event for foreign ifindex %d"
argument_list|,
name|ifi
operator|->
name|ifi_index
argument_list|)
expr_stmt|;
return|return;
block|}
name|extra
index|[
literal|0
index|]
operator|=
literal|'\0'
expr_stmt|;
name|pos
operator|=
name|extra
expr_stmt|;
name|end
operator|=
name|pos
operator|+
sizeof|sizeof
argument_list|(
name|extra
argument_list|)
expr_stmt|;
name|ifname
index|[
literal|0
index|]
operator|=
literal|'\0'
expr_stmt|;
name|attrlen
operator|=
name|len
expr_stmt|;
name|attr
operator|=
operator|(
expr|struct
name|rtattr
operator|*
operator|)
name|buf
expr_stmt|;
while|while
condition|(
name|RTA_OK
argument_list|(
name|attr
argument_list|,
name|attrlen
argument_list|)
condition|)
block|{
switch|switch
condition|(
name|attr
operator|->
name|rta_type
condition|)
block|{
case|case
name|IFLA_IFNAME
case|:
if|if
condition|(
name|RTA_PAYLOAD
argument_list|(
name|attr
argument_list|)
operator|>=
name|IFNAMSIZ
condition|)
break|break;
name|os_memcpy
argument_list|(
name|ifname
argument_list|,
name|RTA_DATA
argument_list|(
name|attr
argument_list|)
argument_list|,
name|RTA_PAYLOAD
argument_list|(
name|attr
argument_list|)
argument_list|)
expr_stmt|;
name|ifname
index|[
name|RTA_PAYLOAD
argument_list|(
name|attr
argument_list|)
index|]
operator|=
literal|'\0'
expr_stmt|;
break|break;
case|case
name|IFLA_MASTER
case|:
name|brid
operator|=
name|nla_get_u32
argument_list|(
operator|(
expr|struct
name|nlattr
operator|*
operator|)
name|attr
argument_list|)
expr_stmt|;
name|pos
operator|+=
name|os_snprintf
argument_list|(
name|pos
argument_list|,
name|end
operator|-
name|pos
argument_list|,
literal|" master=%u"
argument_list|,
name|brid
argument_list|)
expr_stmt|;
break|break;
case|case
name|IFLA_WIRELESS
case|:
name|pos
operator|+=
name|os_snprintf
argument_list|(
name|pos
argument_list|,
name|end
operator|-
name|pos
argument_list|,
literal|" wext"
argument_list|)
expr_stmt|;
break|break;
case|case
name|IFLA_OPERSTATE
case|:
name|pos
operator|+=
name|os_snprintf
argument_list|(
name|pos
argument_list|,
name|end
operator|-
name|pos
argument_list|,
literal|" operstate=%u"
argument_list|,
name|nla_get_u32
argument_list|(
operator|(
expr|struct
name|nlattr
operator|*
operator|)
name|attr
argument_list|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|IFLA_LINKMODE
case|:
name|pos
operator|+=
name|os_snprintf
argument_list|(
name|pos
argument_list|,
name|end
operator|-
name|pos
argument_list|,
literal|" linkmode=%u"
argument_list|,
name|nla_get_u32
argument_list|(
operator|(
expr|struct
name|nlattr
operator|*
operator|)
name|attr
argument_list|)
argument_list|)
expr_stmt|;
break|break;
block|}
name|attr
operator|=
name|RTA_NEXT
argument_list|(
name|attr
argument_list|,
name|attrlen
argument_list|)
expr_stmt|;
block|}
name|extra
index|[
sizeof|sizeof
argument_list|(
name|extra
argument_list|)
operator|-
literal|1
index|]
operator|=
literal|'\0'
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"RTM_NEWLINK: ifi_index=%d ifname=%s%s ifi_family=%d ifi_flags=0x%x (%s%s%s%s)"
argument_list|,
name|ifi
operator|->
name|ifi_index
argument_list|,
name|ifname
argument_list|,
name|extra
argument_list|,
name|ifi
operator|->
name|ifi_family
argument_list|,
name|ifi
operator|->
name|ifi_flags
argument_list|,
operator|(
name|ifi
operator|->
name|ifi_flags
operator|&
name|IFF_UP
operator|)
condition|?
literal|"[UP]"
else|:
literal|""
argument_list|,
operator|(
name|ifi
operator|->
name|ifi_flags
operator|&
name|IFF_RUNNING
operator|)
condition|?
literal|"[RUNNING]"
else|:
literal|""
argument_list|,
operator|(
name|ifi
operator|->
name|ifi_flags
operator|&
name|IFF_LOWER_UP
operator|)
condition|?
literal|"[LOWER_UP]"
else|:
literal|""
argument_list|,
operator|(
name|ifi
operator|->
name|ifi_flags
operator|&
name|IFF_DORMANT
operator|)
condition|?
literal|"[DORMANT]"
else|:
literal|""
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|drv
operator|->
name|if_disabled
operator|&&
operator|!
operator|(
name|ifi
operator|->
name|ifi_flags
operator|&
name|IFF_UP
operator|)
condition|)
block|{
name|namebuf
index|[
literal|0
index|]
operator|=
literal|'\0'
expr_stmt|;
if|if
condition|(
name|if_indextoname
argument_list|(
name|ifi
operator|->
name|ifi_index
argument_list|,
name|namebuf
argument_list|)
operator|&&
name|linux_iface_up
argument_list|(
name|drv
operator|->
name|global
operator|->
name|ioctl_sock
argument_list|,
name|namebuf
argument_list|)
operator|>
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"nl80211: Ignore interface down "
literal|"event since interface %s is up"
argument_list|,
name|namebuf
argument_list|)
expr_stmt|;
name|drv
operator|->
name|ignore_if_down_event
operator|=
literal|0
expr_stmt|;
return|return;
block|}
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"nl80211: Interface down (%s/%s)"
argument_list|,
name|namebuf
argument_list|,
name|ifname
argument_list|)
expr_stmt|;
if|if
condition|(
name|os_strcmp
argument_list|(
name|drv
operator|->
name|first_bss
operator|->
name|ifname
argument_list|,
name|ifname
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"nl80211: Not the main interface (%s) - do not indicate interface down"
argument_list|,
name|drv
operator|->
name|first_bss
operator|->
name|ifname
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|drv
operator|->
name|ignore_if_down_event
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"nl80211: Ignore interface down "
literal|"event generated by mode change"
argument_list|)
expr_stmt|;
name|drv
operator|->
name|ignore_if_down_event
operator|=
literal|0
expr_stmt|;
block|}
else|else
block|{
name|drv
operator|->
name|if_disabled
operator|=
literal|1
expr_stmt|;
name|wpa_supplicant_event
argument_list|(
name|drv
operator|->
name|ctx
argument_list|,
name|EVENT_INTERFACE_DISABLED
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
comment|/* 			 * Try to get drv again, since it may be removed as 			 * part of the EVENT_INTERFACE_DISABLED handling for 			 * dynamic interfaces 			 */
name|drv
operator|=
name|nl80211_find_drv
argument_list|(
name|global
argument_list|,
name|ifi
operator|->
name|ifi_index
argument_list|,
name|buf
argument_list|,
name|len
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|drv
condition|)
return|return;
block|}
block|}
if|if
condition|(
name|drv
operator|->
name|if_disabled
operator|&&
operator|(
name|ifi
operator|->
name|ifi_flags
operator|&
name|IFF_UP
operator|)
condition|)
block|{
if|if
condition|(
name|if_indextoname
argument_list|(
name|ifi
operator|->
name|ifi_index
argument_list|,
name|namebuf
argument_list|)
operator|&&
name|linux_iface_up
argument_list|(
name|drv
operator|->
name|global
operator|->
name|ioctl_sock
argument_list|,
name|namebuf
argument_list|)
operator|==
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"nl80211: Ignore interface up "
literal|"event since interface %s is down"
argument_list|,
name|namebuf
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|if_nametoindex
argument_list|(
name|drv
operator|->
name|first_bss
operator|->
name|ifname
argument_list|)
operator|==
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"nl80211: Ignore interface up "
literal|"event since interface %s does not exist"
argument_list|,
name|drv
operator|->
name|first_bss
operator|->
name|ifname
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|drv
operator|->
name|if_removed
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"nl80211: Ignore interface up "
literal|"event since interface %s is marked "
literal|"removed"
argument_list|,
name|drv
operator|->
name|first_bss
operator|->
name|ifname
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|struct
name|i802_bss
modifier|*
name|bss
decl_stmt|;
name|u8
name|addr
index|[
name|ETH_ALEN
index|]
decl_stmt|;
comment|/* Re-read MAC address as it may have changed */
name|bss
operator|=
name|get_bss_ifindex
argument_list|(
name|drv
argument_list|,
name|ifi
operator|->
name|ifi_index
argument_list|)
expr_stmt|;
if|if
condition|(
name|bss
operator|&&
name|linux_get_ifhwaddr
argument_list|(
name|drv
operator|->
name|global
operator|->
name|ioctl_sock
argument_list|,
name|bss
operator|->
name|ifname
argument_list|,
name|addr
argument_list|)
operator|<
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"nl80211: %s: failed to re-read MAC address"
argument_list|,
name|bss
operator|->
name|ifname
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|bss
operator|&&
name|os_memcmp
argument_list|(
name|addr
argument_list|,
name|bss
operator|->
name|addr
argument_list|,
name|ETH_ALEN
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"nl80211: Own MAC address on ifindex %d (%s) changed from "
name|MACSTR
literal|" to "
name|MACSTR
argument_list|,
name|ifi
operator|->
name|ifi_index
argument_list|,
name|bss
operator|->
name|ifname
argument_list|,
name|MAC2STR
argument_list|(
name|bss
operator|->
name|addr
argument_list|)
argument_list|,
name|MAC2STR
argument_list|(
name|addr
argument_list|)
argument_list|)
expr_stmt|;
name|os_memcpy
argument_list|(
name|bss
operator|->
name|addr
argument_list|,
name|addr
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
block|}
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"nl80211: Interface up"
argument_list|)
expr_stmt|;
name|drv
operator|->
name|if_disabled
operator|=
literal|0
expr_stmt|;
name|wpa_supplicant_event
argument_list|(
name|drv
operator|->
name|ctx
argument_list|,
name|EVENT_INTERFACE_ENABLED
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
block|}
block|}
comment|/* 	 * Some drivers send the association event before the operup event--in 	 * this case, lifting operstate in wpa_driver_nl80211_set_operstate() 	 * fails. This will hit us when wpa_supplicant does not need to do 	 * IEEE 802.1X authentication 	 */
if|if
condition|(
name|drv
operator|->
name|operstate
operator|==
literal|1
operator|&&
operator|(
name|ifi
operator|->
name|ifi_flags
operator|&
operator|(
name|IFF_LOWER_UP
operator||
name|IFF_DORMANT
operator|)
operator|)
operator|==
name|IFF_LOWER_UP
operator|&&
operator|!
operator|(
name|ifi
operator|->
name|ifi_flags
operator|&
name|IFF_RUNNING
operator|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"nl80211: Set IF_OPER_UP again based on ifi_flags and expected operstate"
argument_list|)
expr_stmt|;
name|netlink_send_oper_ifla
argument_list|(
name|drv
operator|->
name|global
operator|->
name|netlink
argument_list|,
name|drv
operator|->
name|ifindex
argument_list|,
operator|-
literal|1
argument_list|,
name|IF_OPER_UP
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|ifname
index|[
literal|0
index|]
condition|)
name|wpa_driver_nl80211_event_newlink
argument_list|(
name|drv
argument_list|,
name|ifname
argument_list|)
expr_stmt|;
if|if
condition|(
name|ifi
operator|->
name|ifi_family
operator|==
name|AF_BRIDGE
operator|&&
name|brid
condition|)
block|{
name|struct
name|i802_bss
modifier|*
name|bss
decl_stmt|;
comment|/* device has been added to bridge */
if|if
condition|(
operator|!
name|if_indextoname
argument_list|(
name|brid
argument_list|,
name|namebuf
argument_list|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"nl80211: Could not find bridge ifname for ifindex %u"
argument_list|,
name|brid
argument_list|)
expr_stmt|;
return|return;
block|}
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"nl80211: Add ifindex %u for bridge %s"
argument_list|,
name|brid
argument_list|,
name|namebuf
argument_list|)
expr_stmt|;
name|add_ifidx
argument_list|(
name|drv
argument_list|,
name|brid
argument_list|)
expr_stmt|;
for|for
control|(
name|bss
operator|=
name|drv
operator|->
name|first_bss
init|;
name|bss
condition|;
name|bss
operator|=
name|bss
operator|->
name|next
control|)
block|{
if|if
condition|(
name|os_strcmp
argument_list|(
name|ifname
argument_list|,
name|bss
operator|->
name|ifname
argument_list|)
operator|==
literal|0
condition|)
block|{
name|os_strlcpy
argument_list|(
name|bss
operator|->
name|brname
argument_list|,
name|namebuf
argument_list|,
name|IFNAMSIZ
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|wpa_driver_nl80211_event_rtm_dellink
parameter_list|(
name|void
modifier|*
name|ctx
parameter_list|,
name|struct
name|ifinfomsg
modifier|*
name|ifi
parameter_list|,
name|u8
modifier|*
name|buf
parameter_list|,
name|size_t
name|len
parameter_list|)
block|{
name|struct
name|nl80211_global
modifier|*
name|global
init|=
name|ctx
decl_stmt|;
name|struct
name|wpa_driver_nl80211_data
modifier|*
name|drv
decl_stmt|;
name|int
name|attrlen
decl_stmt|;
name|struct
name|rtattr
modifier|*
name|attr
decl_stmt|;
name|u32
name|brid
init|=
literal|0
decl_stmt|;
name|char
name|ifname
index|[
name|IFNAMSIZ
operator|+
literal|1
index|]
decl_stmt|;
name|char
name|extra
index|[
literal|100
index|]
decl_stmt|,
modifier|*
name|pos
decl_stmt|,
modifier|*
name|end
decl_stmt|;
name|drv
operator|=
name|nl80211_find_drv
argument_list|(
name|global
argument_list|,
name|ifi
operator|->
name|ifi_index
argument_list|,
name|buf
argument_list|,
name|len
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|drv
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"nl80211: Ignore RTM_DELLINK event for foreign ifindex %d"
argument_list|,
name|ifi
operator|->
name|ifi_index
argument_list|)
expr_stmt|;
return|return;
block|}
name|extra
index|[
literal|0
index|]
operator|=
literal|'\0'
expr_stmt|;
name|pos
operator|=
name|extra
expr_stmt|;
name|end
operator|=
name|pos
operator|+
sizeof|sizeof
argument_list|(
name|extra
argument_list|)
expr_stmt|;
name|ifname
index|[
literal|0
index|]
operator|=
literal|'\0'
expr_stmt|;
name|attrlen
operator|=
name|len
expr_stmt|;
name|attr
operator|=
operator|(
expr|struct
name|rtattr
operator|*
operator|)
name|buf
expr_stmt|;
while|while
condition|(
name|RTA_OK
argument_list|(
name|attr
argument_list|,
name|attrlen
argument_list|)
condition|)
block|{
switch|switch
condition|(
name|attr
operator|->
name|rta_type
condition|)
block|{
case|case
name|IFLA_IFNAME
case|:
if|if
condition|(
name|RTA_PAYLOAD
argument_list|(
name|attr
argument_list|)
operator|>=
name|IFNAMSIZ
condition|)
break|break;
name|os_memcpy
argument_list|(
name|ifname
argument_list|,
name|RTA_DATA
argument_list|(
name|attr
argument_list|)
argument_list|,
name|RTA_PAYLOAD
argument_list|(
name|attr
argument_list|)
argument_list|)
expr_stmt|;
name|ifname
index|[
name|RTA_PAYLOAD
argument_list|(
name|attr
argument_list|)
index|]
operator|=
literal|'\0'
expr_stmt|;
break|break;
case|case
name|IFLA_MASTER
case|:
name|brid
operator|=
name|nla_get_u32
argument_list|(
operator|(
expr|struct
name|nlattr
operator|*
operator|)
name|attr
argument_list|)
expr_stmt|;
name|pos
operator|+=
name|os_snprintf
argument_list|(
name|pos
argument_list|,
name|end
operator|-
name|pos
argument_list|,
literal|" master=%u"
argument_list|,
name|brid
argument_list|)
expr_stmt|;
break|break;
case|case
name|IFLA_OPERSTATE
case|:
name|pos
operator|+=
name|os_snprintf
argument_list|(
name|pos
argument_list|,
name|end
operator|-
name|pos
argument_list|,
literal|" operstate=%u"
argument_list|,
name|nla_get_u32
argument_list|(
operator|(
expr|struct
name|nlattr
operator|*
operator|)
name|attr
argument_list|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|IFLA_LINKMODE
case|:
name|pos
operator|+=
name|os_snprintf
argument_list|(
name|pos
argument_list|,
name|end
operator|-
name|pos
argument_list|,
literal|" linkmode=%u"
argument_list|,
name|nla_get_u32
argument_list|(
operator|(
expr|struct
name|nlattr
operator|*
operator|)
name|attr
argument_list|)
argument_list|)
expr_stmt|;
break|break;
block|}
name|attr
operator|=
name|RTA_NEXT
argument_list|(
name|attr
argument_list|,
name|attrlen
argument_list|)
expr_stmt|;
block|}
name|extra
index|[
sizeof|sizeof
argument_list|(
name|extra
argument_list|)
operator|-
literal|1
index|]
operator|=
literal|'\0'
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"RTM_DELLINK: ifi_index=%d ifname=%s%s ifi_family=%d ifi_flags=0x%x (%s%s%s%s)"
argument_list|,
name|ifi
operator|->
name|ifi_index
argument_list|,
name|ifname
argument_list|,
name|extra
argument_list|,
name|ifi
operator|->
name|ifi_family
argument_list|,
name|ifi
operator|->
name|ifi_flags
argument_list|,
operator|(
name|ifi
operator|->
name|ifi_flags
operator|&
name|IFF_UP
operator|)
condition|?
literal|"[UP]"
else|:
literal|""
argument_list|,
operator|(
name|ifi
operator|->
name|ifi_flags
operator|&
name|IFF_RUNNING
operator|)
condition|?
literal|"[RUNNING]"
else|:
literal|""
argument_list|,
operator|(
name|ifi
operator|->
name|ifi_flags
operator|&
name|IFF_LOWER_UP
operator|)
condition|?
literal|"[LOWER_UP]"
else|:
literal|""
argument_list|,
operator|(
name|ifi
operator|->
name|ifi_flags
operator|&
name|IFF_DORMANT
operator|)
condition|?
literal|"[DORMANT]"
else|:
literal|""
argument_list|)
expr_stmt|;
if|if
condition|(
name|ifname
index|[
literal|0
index|]
operator|&&
operator|(
name|ifi
operator|->
name|ifi_family
operator|!=
name|AF_BRIDGE
operator|||
operator|!
name|brid
operator|)
condition|)
name|wpa_driver_nl80211_event_dellink
argument_list|(
name|drv
argument_list|,
name|ifname
argument_list|)
expr_stmt|;
if|if
condition|(
name|ifi
operator|->
name|ifi_family
operator|==
name|AF_BRIDGE
operator|&&
name|brid
condition|)
block|{
comment|/* device has been removed from bridge */
name|char
name|namebuf
index|[
name|IFNAMSIZ
index|]
decl_stmt|;
if|if
condition|(
operator|!
name|if_indextoname
argument_list|(
name|brid
argument_list|,
name|namebuf
argument_list|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"nl80211: Could not find bridge ifname for ifindex %u"
argument_list|,
name|brid
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"nl80211: Remove ifindex %u for bridge %s"
argument_list|,
name|brid
argument_list|,
name|namebuf
argument_list|)
expr_stmt|;
block|}
name|del_ifidx
argument_list|(
name|drv
argument_list|,
name|brid
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
name|unsigned
name|int
name|nl80211_get_assoc_freq
parameter_list|(
name|struct
name|wpa_driver_nl80211_data
modifier|*
name|drv
parameter_list|)
block|{
name|struct
name|nl_msg
modifier|*
name|msg
decl_stmt|;
name|int
name|ret
decl_stmt|;
name|struct
name|nl80211_bss_info_arg
name|arg
decl_stmt|;
name|msg
operator|=
name|nl80211_drv_msg
argument_list|(
name|drv
argument_list|,
name|NLM_F_DUMP
argument_list|,
name|NL80211_CMD_GET_SCAN
argument_list|)
expr_stmt|;
name|os_memset
argument_list|(
operator|&
name|arg
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|arg
argument_list|)
argument_list|)
expr_stmt|;
name|arg
operator|.
name|drv
operator|=
name|drv
expr_stmt|;
name|ret
operator|=
name|send_and_recv_msgs
argument_list|(
name|drv
argument_list|,
name|msg
argument_list|,
name|bss_info_handler
argument_list|,
operator|&
name|arg
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|==
literal|0
condition|)
block|{
name|unsigned
name|int
name|freq
init|=
name|drv
operator|->
name|nlmode
operator|==
name|NL80211_IFTYPE_ADHOC
condition|?
name|arg
operator|.
name|ibss_freq
else|:
name|arg
operator|.
name|assoc_freq
decl_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"nl80211: Operating frequency for the "
literal|"associated BSS from scan results: %u MHz"
argument_list|,
name|freq
argument_list|)
expr_stmt|;
if|if
condition|(
name|freq
condition|)
name|drv
operator|->
name|assoc_freq
operator|=
name|freq
expr_stmt|;
return|return
name|drv
operator|->
name|assoc_freq
return|;
block|}
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"nl80211: Scan result fetch failed: ret=%d "
literal|"(%s)"
argument_list|,
name|ret
argument_list|,
name|strerror
argument_list|(
operator|-
name|ret
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|drv
operator|->
name|assoc_freq
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|get_link_signal
parameter_list|(
name|struct
name|nl_msg
modifier|*
name|msg
parameter_list|,
name|void
modifier|*
name|arg
parameter_list|)
block|{
name|struct
name|nlattr
modifier|*
name|tb
index|[
name|NL80211_ATTR_MAX
operator|+
literal|1
index|]
decl_stmt|;
name|struct
name|genlmsghdr
modifier|*
name|gnlh
init|=
name|nlmsg_data
argument_list|(
name|nlmsg_hdr
argument_list|(
name|msg
argument_list|)
argument_list|)
decl_stmt|;
name|struct
name|nlattr
modifier|*
name|sinfo
index|[
name|NL80211_STA_INFO_MAX
operator|+
literal|1
index|]
decl_stmt|;
specifier|static
name|struct
name|nla_policy
name|policy
index|[
name|NL80211_STA_INFO_MAX
operator|+
literal|1
index|]
init|=
block|{
index|[
name|NL80211_STA_INFO_SIGNAL
index|]
operator|=
block|{
operator|.
name|type
operator|=
name|NLA_U8
block|}
block|,
index|[
name|NL80211_STA_INFO_SIGNAL_AVG
index|]
operator|=
block|{
operator|.
name|type
operator|=
name|NLA_U8
block|}
block|, 	}
decl_stmt|;
name|struct
name|nlattr
modifier|*
name|rinfo
index|[
name|NL80211_RATE_INFO_MAX
operator|+
literal|1
index|]
decl_stmt|;
specifier|static
name|struct
name|nla_policy
name|rate_policy
index|[
name|NL80211_RATE_INFO_MAX
operator|+
literal|1
index|]
init|=
block|{
index|[
name|NL80211_RATE_INFO_BITRATE
index|]
operator|=
block|{
operator|.
name|type
operator|=
name|NLA_U16
block|}
block|,
index|[
name|NL80211_RATE_INFO_MCS
index|]
operator|=
block|{
operator|.
name|type
operator|=
name|NLA_U8
block|}
block|,
index|[
name|NL80211_RATE_INFO_40_MHZ_WIDTH
index|]
operator|=
block|{
operator|.
name|type
operator|=
name|NLA_FLAG
block|}
block|,
index|[
name|NL80211_RATE_INFO_SHORT_GI
index|]
operator|=
block|{
operator|.
name|type
operator|=
name|NLA_FLAG
block|}
block|, 	}
decl_stmt|;
name|struct
name|wpa_signal_info
modifier|*
name|sig_change
init|=
name|arg
decl_stmt|;
name|nla_parse
argument_list|(
name|tb
argument_list|,
name|NL80211_ATTR_MAX
argument_list|,
name|genlmsg_attrdata
argument_list|(
name|gnlh
argument_list|,
literal|0
argument_list|)
argument_list|,
name|genlmsg_attrlen
argument_list|(
name|gnlh
argument_list|,
literal|0
argument_list|)
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|tb
index|[
name|NL80211_ATTR_STA_INFO
index|]
operator|||
name|nla_parse_nested
argument_list|(
name|sinfo
argument_list|,
name|NL80211_STA_INFO_MAX
argument_list|,
name|tb
index|[
name|NL80211_ATTR_STA_INFO
index|]
argument_list|,
name|policy
argument_list|)
condition|)
return|return
name|NL_SKIP
return|;
if|if
condition|(
operator|!
name|sinfo
index|[
name|NL80211_STA_INFO_SIGNAL
index|]
condition|)
return|return
name|NL_SKIP
return|;
name|sig_change
operator|->
name|current_signal
operator|=
operator|(
name|s8
operator|)
name|nla_get_u8
argument_list|(
name|sinfo
index|[
name|NL80211_STA_INFO_SIGNAL
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|sinfo
index|[
name|NL80211_STA_INFO_SIGNAL_AVG
index|]
condition|)
name|sig_change
operator|->
name|avg_signal
operator|=
operator|(
name|s8
operator|)
name|nla_get_u8
argument_list|(
name|sinfo
index|[
name|NL80211_STA_INFO_SIGNAL_AVG
index|]
argument_list|)
expr_stmt|;
else|else
name|sig_change
operator|->
name|avg_signal
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|sinfo
index|[
name|NL80211_STA_INFO_TX_BITRATE
index|]
condition|)
block|{
if|if
condition|(
name|nla_parse_nested
argument_list|(
name|rinfo
argument_list|,
name|NL80211_RATE_INFO_MAX
argument_list|,
name|sinfo
index|[
name|NL80211_STA_INFO_TX_BITRATE
index|]
argument_list|,
name|rate_policy
argument_list|)
condition|)
block|{
name|sig_change
operator|->
name|current_txrate
operator|=
literal|0
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|rinfo
index|[
name|NL80211_RATE_INFO_BITRATE
index|]
condition|)
block|{
name|sig_change
operator|->
name|current_txrate
operator|=
name|nla_get_u16
argument_list|(
name|rinfo
index|[
name|NL80211_RATE_INFO_BITRATE
index|]
argument_list|)
operator|*
literal|100
expr_stmt|;
block|}
block|}
block|}
return|return
name|NL_SKIP
return|;
block|}
end_function

begin_function
name|int
name|nl80211_get_link_signal
parameter_list|(
name|struct
name|wpa_driver_nl80211_data
modifier|*
name|drv
parameter_list|,
name|struct
name|wpa_signal_info
modifier|*
name|sig
parameter_list|)
block|{
name|struct
name|nl_msg
modifier|*
name|msg
decl_stmt|;
name|sig
operator|->
name|current_signal
operator|=
operator|-
literal|9999
expr_stmt|;
name|sig
operator|->
name|current_txrate
operator|=
literal|0
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|msg
operator|=
name|nl80211_drv_msg
argument_list|(
name|drv
argument_list|,
literal|0
argument_list|,
name|NL80211_CMD_GET_STATION
argument_list|)
operator|)
operator|||
name|nla_put
argument_list|(
name|msg
argument_list|,
name|NL80211_ATTR_MAC
argument_list|,
name|ETH_ALEN
argument_list|,
name|drv
operator|->
name|bssid
argument_list|)
condition|)
block|{
name|nlmsg_free
argument_list|(
name|msg
argument_list|)
expr_stmt|;
return|return
operator|-
name|ENOBUFS
return|;
block|}
return|return
name|send_and_recv_msgs
argument_list|(
name|drv
argument_list|,
name|msg
argument_list|,
name|get_link_signal
argument_list|,
name|sig
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|get_link_noise
parameter_list|(
name|struct
name|nl_msg
modifier|*
name|msg
parameter_list|,
name|void
modifier|*
name|arg
parameter_list|)
block|{
name|struct
name|nlattr
modifier|*
name|tb
index|[
name|NL80211_ATTR_MAX
operator|+
literal|1
index|]
decl_stmt|;
name|struct
name|genlmsghdr
modifier|*
name|gnlh
init|=
name|nlmsg_data
argument_list|(
name|nlmsg_hdr
argument_list|(
name|msg
argument_list|)
argument_list|)
decl_stmt|;
name|struct
name|nlattr
modifier|*
name|sinfo
index|[
name|NL80211_SURVEY_INFO_MAX
operator|+
literal|1
index|]
decl_stmt|;
specifier|static
name|struct
name|nla_policy
name|survey_policy
index|[
name|NL80211_SURVEY_INFO_MAX
operator|+
literal|1
index|]
init|=
block|{
index|[
name|NL80211_SURVEY_INFO_FREQUENCY
index|]
operator|=
block|{
operator|.
name|type
operator|=
name|NLA_U32
block|}
block|,
index|[
name|NL80211_SURVEY_INFO_NOISE
index|]
operator|=
block|{
operator|.
name|type
operator|=
name|NLA_U8
block|}
block|, 	}
decl_stmt|;
name|struct
name|wpa_signal_info
modifier|*
name|sig_change
init|=
name|arg
decl_stmt|;
name|nla_parse
argument_list|(
name|tb
argument_list|,
name|NL80211_ATTR_MAX
argument_list|,
name|genlmsg_attrdata
argument_list|(
name|gnlh
argument_list|,
literal|0
argument_list|)
argument_list|,
name|genlmsg_attrlen
argument_list|(
name|gnlh
argument_list|,
literal|0
argument_list|)
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|tb
index|[
name|NL80211_ATTR_SURVEY_INFO
index|]
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"nl80211: survey data missing!"
argument_list|)
expr_stmt|;
return|return
name|NL_SKIP
return|;
block|}
if|if
condition|(
name|nla_parse_nested
argument_list|(
name|sinfo
argument_list|,
name|NL80211_SURVEY_INFO_MAX
argument_list|,
name|tb
index|[
name|NL80211_ATTR_SURVEY_INFO
index|]
argument_list|,
name|survey_policy
argument_list|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"nl80211: failed to parse nested "
literal|"attributes!"
argument_list|)
expr_stmt|;
return|return
name|NL_SKIP
return|;
block|}
if|if
condition|(
operator|!
name|sinfo
index|[
name|NL80211_SURVEY_INFO_FREQUENCY
index|]
condition|)
return|return
name|NL_SKIP
return|;
if|if
condition|(
name|nla_get_u32
argument_list|(
name|sinfo
index|[
name|NL80211_SURVEY_INFO_FREQUENCY
index|]
argument_list|)
operator|!=
name|sig_change
operator|->
name|frequency
condition|)
return|return
name|NL_SKIP
return|;
if|if
condition|(
operator|!
name|sinfo
index|[
name|NL80211_SURVEY_INFO_NOISE
index|]
condition|)
return|return
name|NL_SKIP
return|;
name|sig_change
operator|->
name|current_noise
operator|=
operator|(
name|s8
operator|)
name|nla_get_u8
argument_list|(
name|sinfo
index|[
name|NL80211_SURVEY_INFO_NOISE
index|]
argument_list|)
expr_stmt|;
return|return
name|NL_SKIP
return|;
block|}
end_function

begin_function
name|int
name|nl80211_get_link_noise
parameter_list|(
name|struct
name|wpa_driver_nl80211_data
modifier|*
name|drv
parameter_list|,
name|struct
name|wpa_signal_info
modifier|*
name|sig_change
parameter_list|)
block|{
name|struct
name|nl_msg
modifier|*
name|msg
decl_stmt|;
name|sig_change
operator|->
name|current_noise
operator|=
literal|9999
expr_stmt|;
name|sig_change
operator|->
name|frequency
operator|=
name|drv
operator|->
name|assoc_freq
expr_stmt|;
name|msg
operator|=
name|nl80211_drv_msg
argument_list|(
name|drv
argument_list|,
name|NLM_F_DUMP
argument_list|,
name|NL80211_CMD_GET_SURVEY
argument_list|)
expr_stmt|;
return|return
name|send_and_recv_msgs
argument_list|(
name|drv
argument_list|,
name|msg
argument_list|,
name|get_link_noise
argument_list|,
name|sig_change
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|wpa_driver_nl80211_event_receive
parameter_list|(
name|int
name|sock
parameter_list|,
name|void
modifier|*
name|eloop_ctx
parameter_list|,
name|void
modifier|*
name|handle
parameter_list|)
block|{
name|struct
name|nl_cb
modifier|*
name|cb
init|=
name|eloop_ctx
decl_stmt|;
name|int
name|res
decl_stmt|;
name|wpa_printf
argument_list|(
name|MSG_MSGDUMP
argument_list|,
literal|"nl80211: Event message available"
argument_list|)
expr_stmt|;
name|res
operator|=
name|nl_recvmsgs
argument_list|(
name|handle
argument_list|,
name|cb
argument_list|)
expr_stmt|;
if|if
condition|(
name|res
operator|<
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"nl80211: %s->nl_recvmsgs failed: %d"
argument_list|,
name|__func__
argument_list|,
name|res
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/**  * wpa_driver_nl80211_set_country - ask nl80211 to set the regulatory domain  * @priv: driver_nl80211 private data  * @alpha2_arg: country to which to switch to  * Returns: 0 on success, -1 on failure  *  * This asks nl80211 to set the regulatory domain for given  * country ISO / IEC alpha2.  */
end_comment

begin_function
specifier|static
name|int
name|wpa_driver_nl80211_set_country
parameter_list|(
name|void
modifier|*
name|priv
parameter_list|,
specifier|const
name|char
modifier|*
name|alpha2_arg
parameter_list|)
block|{
name|struct
name|i802_bss
modifier|*
name|bss
init|=
name|priv
decl_stmt|;
name|struct
name|wpa_driver_nl80211_data
modifier|*
name|drv
init|=
name|bss
operator|->
name|drv
decl_stmt|;
name|char
name|alpha2
index|[
literal|3
index|]
decl_stmt|;
name|struct
name|nl_msg
modifier|*
name|msg
decl_stmt|;
name|msg
operator|=
name|nlmsg_alloc
argument_list|()
expr_stmt|;
if|if
condition|(
operator|!
name|msg
condition|)
return|return
operator|-
name|ENOMEM
return|;
name|alpha2
index|[
literal|0
index|]
operator|=
name|alpha2_arg
index|[
literal|0
index|]
expr_stmt|;
name|alpha2
index|[
literal|1
index|]
operator|=
name|alpha2_arg
index|[
literal|1
index|]
expr_stmt|;
name|alpha2
index|[
literal|2
index|]
operator|=
literal|'\0'
expr_stmt|;
if|if
condition|(
operator|!
name|nl80211_cmd
argument_list|(
name|drv
argument_list|,
name|msg
argument_list|,
literal|0
argument_list|,
name|NL80211_CMD_REQ_SET_REG
argument_list|)
operator|||
name|nla_put_string
argument_list|(
name|msg
argument_list|,
name|NL80211_ATTR_REG_ALPHA2
argument_list|,
name|alpha2
argument_list|)
condition|)
block|{
name|nlmsg_free
argument_list|(
name|msg
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
if|if
condition|(
name|send_and_recv_msgs
argument_list|(
name|drv
argument_list|,
name|msg
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
condition|)
return|return
operator|-
name|EINVAL
return|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|nl80211_get_country
parameter_list|(
name|struct
name|nl_msg
modifier|*
name|msg
parameter_list|,
name|void
modifier|*
name|arg
parameter_list|)
block|{
name|char
modifier|*
name|alpha2
init|=
name|arg
decl_stmt|;
name|struct
name|nlattr
modifier|*
name|tb_msg
index|[
name|NL80211_ATTR_MAX
operator|+
literal|1
index|]
decl_stmt|;
name|struct
name|genlmsghdr
modifier|*
name|gnlh
init|=
name|nlmsg_data
argument_list|(
name|nlmsg_hdr
argument_list|(
name|msg
argument_list|)
argument_list|)
decl_stmt|;
name|nla_parse
argument_list|(
name|tb_msg
argument_list|,
name|NL80211_ATTR_MAX
argument_list|,
name|genlmsg_attrdata
argument_list|(
name|gnlh
argument_list|,
literal|0
argument_list|)
argument_list|,
name|genlmsg_attrlen
argument_list|(
name|gnlh
argument_list|,
literal|0
argument_list|)
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|tb_msg
index|[
name|NL80211_ATTR_REG_ALPHA2
index|]
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"nl80211: No country information available"
argument_list|)
expr_stmt|;
return|return
name|NL_SKIP
return|;
block|}
name|os_strlcpy
argument_list|(
name|alpha2
argument_list|,
name|nla_data
argument_list|(
name|tb_msg
index|[
name|NL80211_ATTR_REG_ALPHA2
index|]
argument_list|)
argument_list|,
literal|3
argument_list|)
expr_stmt|;
return|return
name|NL_SKIP
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|wpa_driver_nl80211_get_country
parameter_list|(
name|void
modifier|*
name|priv
parameter_list|,
name|char
modifier|*
name|alpha2
parameter_list|)
block|{
name|struct
name|i802_bss
modifier|*
name|bss
init|=
name|priv
decl_stmt|;
name|struct
name|wpa_driver_nl80211_data
modifier|*
name|drv
init|=
name|bss
operator|->
name|drv
decl_stmt|;
name|struct
name|nl_msg
modifier|*
name|msg
decl_stmt|;
name|int
name|ret
decl_stmt|;
name|msg
operator|=
name|nlmsg_alloc
argument_list|()
expr_stmt|;
if|if
condition|(
operator|!
name|msg
condition|)
return|return
operator|-
name|ENOMEM
return|;
name|nl80211_cmd
argument_list|(
name|drv
argument_list|,
name|msg
argument_list|,
literal|0
argument_list|,
name|NL80211_CMD_GET_REG
argument_list|)
expr_stmt|;
name|alpha2
index|[
literal|0
index|]
operator|=
literal|'\0'
expr_stmt|;
name|ret
operator|=
name|send_and_recv_msgs
argument_list|(
name|drv
argument_list|,
name|msg
argument_list|,
name|nl80211_get_country
argument_list|,
name|alpha2
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|alpha2
index|[
literal|0
index|]
condition|)
name|ret
operator|=
operator|-
literal|1
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|wpa_driver_nl80211_init_nl_global
parameter_list|(
name|struct
name|nl80211_global
modifier|*
name|global
parameter_list|)
block|{
name|int
name|ret
decl_stmt|;
name|global
operator|->
name|nl_cb
operator|=
name|nl_cb_alloc
argument_list|(
name|NL_CB_DEFAULT
argument_list|)
expr_stmt|;
if|if
condition|(
name|global
operator|->
name|nl_cb
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"nl80211: Failed to allocate netlink "
literal|"callbacks"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|global
operator|->
name|nl
operator|=
name|nl_create_handle
argument_list|(
name|global
operator|->
name|nl_cb
argument_list|,
literal|"nl"
argument_list|)
expr_stmt|;
if|if
condition|(
name|global
operator|->
name|nl
operator|==
name|NULL
condition|)
goto|goto
name|err
goto|;
name|global
operator|->
name|nl80211_id
operator|=
name|genl_ctrl_resolve
argument_list|(
name|global
operator|->
name|nl
argument_list|,
literal|"nl80211"
argument_list|)
expr_stmt|;
if|if
condition|(
name|global
operator|->
name|nl80211_id
operator|<
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"nl80211: 'nl80211' generic netlink not "
literal|"found"
argument_list|)
expr_stmt|;
goto|goto
name|err
goto|;
block|}
name|global
operator|->
name|nl_event
operator|=
name|nl_create_handle
argument_list|(
name|global
operator|->
name|nl_cb
argument_list|,
literal|"event"
argument_list|)
expr_stmt|;
if|if
condition|(
name|global
operator|->
name|nl_event
operator|==
name|NULL
condition|)
goto|goto
name|err
goto|;
name|ret
operator|=
name|nl_get_multicast_id
argument_list|(
name|global
argument_list|,
literal|"nl80211"
argument_list|,
literal|"scan"
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|>=
literal|0
condition|)
name|ret
operator|=
name|nl_socket_add_membership
argument_list|(
name|global
operator|->
name|nl_event
argument_list|,
name|ret
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|<
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"nl80211: Could not add multicast "
literal|"membership for scan events: %d (%s)"
argument_list|,
name|ret
argument_list|,
name|strerror
argument_list|(
operator|-
name|ret
argument_list|)
argument_list|)
expr_stmt|;
goto|goto
name|err
goto|;
block|}
name|ret
operator|=
name|nl_get_multicast_id
argument_list|(
name|global
argument_list|,
literal|"nl80211"
argument_list|,
literal|"mlme"
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|>=
literal|0
condition|)
name|ret
operator|=
name|nl_socket_add_membership
argument_list|(
name|global
operator|->
name|nl_event
argument_list|,
name|ret
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|<
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"nl80211: Could not add multicast "
literal|"membership for mlme events: %d (%s)"
argument_list|,
name|ret
argument_list|,
name|strerror
argument_list|(
operator|-
name|ret
argument_list|)
argument_list|)
expr_stmt|;
goto|goto
name|err
goto|;
block|}
name|ret
operator|=
name|nl_get_multicast_id
argument_list|(
name|global
argument_list|,
literal|"nl80211"
argument_list|,
literal|"regulatory"
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|>=
literal|0
condition|)
name|ret
operator|=
name|nl_socket_add_membership
argument_list|(
name|global
operator|->
name|nl_event
argument_list|,
name|ret
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|<
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"nl80211: Could not add multicast "
literal|"membership for regulatory events: %d (%s)"
argument_list|,
name|ret
argument_list|,
name|strerror
argument_list|(
operator|-
name|ret
argument_list|)
argument_list|)
expr_stmt|;
comment|/* Continue without regulatory events */
block|}
name|ret
operator|=
name|nl_get_multicast_id
argument_list|(
name|global
argument_list|,
literal|"nl80211"
argument_list|,
literal|"vendor"
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|>=
literal|0
condition|)
name|ret
operator|=
name|nl_socket_add_membership
argument_list|(
name|global
operator|->
name|nl_event
argument_list|,
name|ret
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|<
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"nl80211: Could not add multicast "
literal|"membership for vendor events: %d (%s)"
argument_list|,
name|ret
argument_list|,
name|strerror
argument_list|(
operator|-
name|ret
argument_list|)
argument_list|)
expr_stmt|;
comment|/* Continue without vendor events */
block|}
name|nl_cb_set
argument_list|(
name|global
operator|->
name|nl_cb
argument_list|,
name|NL_CB_SEQ_CHECK
argument_list|,
name|NL_CB_CUSTOM
argument_list|,
name|no_seq_check
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|nl_cb_set
argument_list|(
name|global
operator|->
name|nl_cb
argument_list|,
name|NL_CB_VALID
argument_list|,
name|NL_CB_CUSTOM
argument_list|,
name|process_global_event
argument_list|,
name|global
argument_list|)
expr_stmt|;
name|nl80211_register_eloop_read
argument_list|(
operator|&
name|global
operator|->
name|nl_event
argument_list|,
name|wpa_driver_nl80211_event_receive
argument_list|,
name|global
operator|->
name|nl_cb
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
name|err
label|:
name|nl_destroy_handles
argument_list|(
operator|&
name|global
operator|->
name|nl_event
argument_list|)
expr_stmt|;
name|nl_destroy_handles
argument_list|(
operator|&
name|global
operator|->
name|nl
argument_list|)
expr_stmt|;
name|nl_cb_put
argument_list|(
name|global
operator|->
name|nl_cb
argument_list|)
expr_stmt|;
name|global
operator|->
name|nl_cb
operator|=
name|NULL
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|nl80211_check_global
parameter_list|(
name|struct
name|nl80211_global
modifier|*
name|global
parameter_list|)
block|{
name|struct
name|nl_handle
modifier|*
name|handle
decl_stmt|;
specifier|const
name|char
modifier|*
name|groups
index|[]
init|=
block|{
literal|"scan"
block|,
literal|"mlme"
block|,
literal|"regulatory"
block|,
literal|"vendor"
block|,
name|NULL
block|}
decl_stmt|;
name|int
name|ret
decl_stmt|;
name|unsigned
name|int
name|i
decl_stmt|;
comment|/* 	 * Try to re-add memberships to handle case of cfg80211 getting reloaded 	 * and all registration having been cleared. 	 */
name|handle
operator|=
operator|(
name|void
operator|*
operator|)
operator|(
operator|(
operator|(
name|intptr_t
operator|)
name|global
operator|->
name|nl_event
operator|)
operator|^
name|ELOOP_SOCKET_INVALID
operator|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|groups
index|[
name|i
index|]
condition|;
name|i
operator|++
control|)
block|{
name|ret
operator|=
name|nl_get_multicast_id
argument_list|(
name|global
argument_list|,
literal|"nl80211"
argument_list|,
name|groups
index|[
name|i
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|>=
literal|0
condition|)
name|ret
operator|=
name|nl_socket_add_membership
argument_list|(
name|handle
argument_list|,
name|ret
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|<
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"nl80211: Could not re-add multicast membership for %s events: %d (%s)"
argument_list|,
name|groups
index|[
name|i
index|]
argument_list|,
name|ret
argument_list|,
name|strerror
argument_list|(
operator|-
name|ret
argument_list|)
argument_list|)
expr_stmt|;
block|}
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|wpa_driver_nl80211_rfkill_blocked
parameter_list|(
name|void
modifier|*
name|ctx
parameter_list|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"nl80211: RFKILL blocked"
argument_list|)
expr_stmt|;
comment|/* 	 * This may be for any interface; use ifdown event to disable 	 * interface. 	 */
block|}
end_function

begin_function
specifier|static
name|void
name|wpa_driver_nl80211_rfkill_unblocked
parameter_list|(
name|void
modifier|*
name|ctx
parameter_list|)
block|{
name|struct
name|wpa_driver_nl80211_data
modifier|*
name|drv
init|=
name|ctx
decl_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"nl80211: RFKILL unblocked"
argument_list|)
expr_stmt|;
if|if
condition|(
name|i802_set_iface_flags
argument_list|(
name|drv
operator|->
name|first_bss
argument_list|,
literal|1
argument_list|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"nl80211: Could not set interface UP "
literal|"after rfkill unblock"
argument_list|)
expr_stmt|;
return|return;
block|}
comment|/* rtnetlink ifup handler will report interface as enabled */
block|}
end_function

begin_function
specifier|static
name|void
name|wpa_driver_nl80211_handle_eapol_tx_status
parameter_list|(
name|int
name|sock
parameter_list|,
name|void
modifier|*
name|eloop_ctx
parameter_list|,
name|void
modifier|*
name|handle
parameter_list|)
block|{
name|struct
name|wpa_driver_nl80211_data
modifier|*
name|drv
init|=
name|eloop_ctx
decl_stmt|;
name|u8
name|data
index|[
literal|2048
index|]
decl_stmt|;
name|struct
name|msghdr
name|msg
decl_stmt|;
name|struct
name|iovec
name|entry
decl_stmt|;
name|u8
name|control
index|[
literal|512
index|]
decl_stmt|;
name|struct
name|cmsghdr
modifier|*
name|cmsg
decl_stmt|;
name|int
name|res
decl_stmt|,
name|found_ee
init|=
literal|0
decl_stmt|,
name|found_wifi
init|=
literal|0
decl_stmt|,
name|acked
init|=
literal|0
decl_stmt|;
name|union
name|wpa_event_data
name|event
decl_stmt|;
name|memset
argument_list|(
operator|&
name|msg
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|msg
argument_list|)
argument_list|)
expr_stmt|;
name|msg
operator|.
name|msg_iov
operator|=
operator|&
name|entry
expr_stmt|;
name|msg
operator|.
name|msg_iovlen
operator|=
literal|1
expr_stmt|;
name|entry
operator|.
name|iov_base
operator|=
name|data
expr_stmt|;
name|entry
operator|.
name|iov_len
operator|=
sizeof|sizeof
argument_list|(
name|data
argument_list|)
expr_stmt|;
name|msg
operator|.
name|msg_control
operator|=
operator|&
name|control
expr_stmt|;
name|msg
operator|.
name|msg_controllen
operator|=
sizeof|sizeof
argument_list|(
name|control
argument_list|)
expr_stmt|;
name|res
operator|=
name|recvmsg
argument_list|(
name|sock
argument_list|,
operator|&
name|msg
argument_list|,
name|MSG_ERRQUEUE
argument_list|)
expr_stmt|;
comment|/* if error or not fitting 802.3 header, return */
if|if
condition|(
name|res
operator|<
literal|14
condition|)
return|return;
for|for
control|(
name|cmsg
operator|=
name|CMSG_FIRSTHDR
argument_list|(
operator|&
name|msg
argument_list|)
init|;
name|cmsg
condition|;
name|cmsg
operator|=
name|CMSG_NXTHDR
argument_list|(
operator|&
name|msg
argument_list|,
name|cmsg
argument_list|)
control|)
block|{
if|if
condition|(
name|cmsg
operator|->
name|cmsg_level
operator|==
name|SOL_SOCKET
operator|&&
name|cmsg
operator|->
name|cmsg_type
operator|==
name|SCM_WIFI_STATUS
condition|)
block|{
name|int
modifier|*
name|ack
decl_stmt|;
name|found_wifi
operator|=
literal|1
expr_stmt|;
name|ack
operator|=
operator|(
name|void
operator|*
operator|)
name|CMSG_DATA
argument_list|(
name|cmsg
argument_list|)
expr_stmt|;
name|acked
operator|=
operator|*
name|ack
expr_stmt|;
block|}
if|if
condition|(
name|cmsg
operator|->
name|cmsg_level
operator|==
name|SOL_PACKET
operator|&&
name|cmsg
operator|->
name|cmsg_type
operator|==
name|PACKET_TX_TIMESTAMP
condition|)
block|{
name|struct
name|sock_extended_err
modifier|*
name|err
init|=
operator|(
expr|struct
name|sock_extended_err
operator|*
operator|)
name|CMSG_DATA
argument_list|(
name|cmsg
argument_list|)
decl_stmt|;
if|if
condition|(
name|err
operator|->
name|ee_origin
operator|==
name|SO_EE_ORIGIN_TXSTATUS
condition|)
name|found_ee
operator|=
literal|1
expr_stmt|;
block|}
block|}
if|if
condition|(
operator|!
name|found_ee
operator|||
operator|!
name|found_wifi
condition|)
return|return;
name|memset
argument_list|(
operator|&
name|event
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|event
argument_list|)
argument_list|)
expr_stmt|;
name|event
operator|.
name|eapol_tx_status
operator|.
name|dst
operator|=
name|data
expr_stmt|;
name|event
operator|.
name|eapol_tx_status
operator|.
name|data
operator|=
name|data
operator|+
literal|14
expr_stmt|;
name|event
operator|.
name|eapol_tx_status
operator|.
name|data_len
operator|=
name|res
operator|-
literal|14
expr_stmt|;
name|event
operator|.
name|eapol_tx_status
operator|.
name|ack
operator|=
name|acked
expr_stmt|;
name|wpa_supplicant_event
argument_list|(
name|drv
operator|->
name|ctx
argument_list|,
name|EVENT_EAPOL_TX_STATUS
argument_list|,
operator|&
name|event
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|nl80211_init_bss
parameter_list|(
name|struct
name|i802_bss
modifier|*
name|bss
parameter_list|)
block|{
name|bss
operator|->
name|nl_cb
operator|=
name|nl_cb_alloc
argument_list|(
name|NL_CB_DEFAULT
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|bss
operator|->
name|nl_cb
condition|)
return|return
operator|-
literal|1
return|;
name|nl_cb_set
argument_list|(
name|bss
operator|->
name|nl_cb
argument_list|,
name|NL_CB_SEQ_CHECK
argument_list|,
name|NL_CB_CUSTOM
argument_list|,
name|no_seq_check
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|nl_cb_set
argument_list|(
name|bss
operator|->
name|nl_cb
argument_list|,
name|NL_CB_VALID
argument_list|,
name|NL_CB_CUSTOM
argument_list|,
name|process_bss_event
argument_list|,
name|bss
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|nl80211_destroy_bss
parameter_list|(
name|struct
name|i802_bss
modifier|*
name|bss
parameter_list|)
block|{
name|nl_cb_put
argument_list|(
name|bss
operator|->
name|nl_cb
argument_list|)
expr_stmt|;
name|bss
operator|->
name|nl_cb
operator|=
name|NULL
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
modifier|*
name|wpa_driver_nl80211_drv_init
parameter_list|(
name|void
modifier|*
name|ctx
parameter_list|,
specifier|const
name|char
modifier|*
name|ifname
parameter_list|,
name|void
modifier|*
name|global_priv
parameter_list|,
name|int
name|hostapd
parameter_list|,
specifier|const
name|u8
modifier|*
name|set_addr
parameter_list|,
specifier|const
name|char
modifier|*
name|driver_params
parameter_list|)
block|{
name|struct
name|wpa_driver_nl80211_data
modifier|*
name|drv
decl_stmt|;
name|struct
name|rfkill_config
modifier|*
name|rcfg
decl_stmt|;
name|struct
name|i802_bss
modifier|*
name|bss
decl_stmt|;
if|if
condition|(
name|global_priv
operator|==
name|NULL
condition|)
return|return
name|NULL
return|;
name|drv
operator|=
name|os_zalloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|drv
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|drv
operator|==
name|NULL
condition|)
return|return
name|NULL
return|;
name|drv
operator|->
name|global
operator|=
name|global_priv
expr_stmt|;
name|drv
operator|->
name|ctx
operator|=
name|ctx
expr_stmt|;
name|drv
operator|->
name|hostapd
operator|=
operator|!
operator|!
name|hostapd
expr_stmt|;
name|drv
operator|->
name|eapol_sock
operator|=
operator|-
literal|1
expr_stmt|;
comment|/* 	 * There is no driver capability flag for this, so assume it is 	 * supported and disable this on first attempt to use if the driver 	 * rejects the command due to missing support. 	 */
name|drv
operator|->
name|set_rekey_offload
operator|=
literal|1
expr_stmt|;
name|drv
operator|->
name|num_if_indices
operator|=
sizeof|sizeof
argument_list|(
name|drv
operator|->
name|default_if_indices
argument_list|)
operator|/
sizeof|sizeof
argument_list|(
name|int
argument_list|)
expr_stmt|;
name|drv
operator|->
name|if_indices
operator|=
name|drv
operator|->
name|default_if_indices
expr_stmt|;
name|drv
operator|->
name|first_bss
operator|=
name|os_zalloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|drv
operator|->
name|first_bss
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|drv
operator|->
name|first_bss
condition|)
block|{
name|os_free
argument_list|(
name|drv
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|bss
operator|=
name|drv
operator|->
name|first_bss
expr_stmt|;
name|bss
operator|->
name|drv
operator|=
name|drv
expr_stmt|;
name|bss
operator|->
name|ctx
operator|=
name|ctx
expr_stmt|;
name|os_strlcpy
argument_list|(
name|bss
operator|->
name|ifname
argument_list|,
name|ifname
argument_list|,
sizeof|sizeof
argument_list|(
name|bss
operator|->
name|ifname
argument_list|)
argument_list|)
expr_stmt|;
name|drv
operator|->
name|monitor_ifidx
operator|=
operator|-
literal|1
expr_stmt|;
name|drv
operator|->
name|monitor_sock
operator|=
operator|-
literal|1
expr_stmt|;
name|drv
operator|->
name|eapol_tx_sock
operator|=
operator|-
literal|1
expr_stmt|;
name|drv
operator|->
name|ap_scan_as_station
operator|=
name|NL80211_IFTYPE_UNSPECIFIED
expr_stmt|;
if|if
condition|(
name|nl80211_init_bss
argument_list|(
name|bss
argument_list|)
condition|)
goto|goto
name|failed
goto|;
name|rcfg
operator|=
name|os_zalloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|rcfg
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|rcfg
operator|==
name|NULL
condition|)
goto|goto
name|failed
goto|;
name|rcfg
operator|->
name|ctx
operator|=
name|drv
expr_stmt|;
name|os_strlcpy
argument_list|(
name|rcfg
operator|->
name|ifname
argument_list|,
name|ifname
argument_list|,
sizeof|sizeof
argument_list|(
name|rcfg
operator|->
name|ifname
argument_list|)
argument_list|)
expr_stmt|;
name|rcfg
operator|->
name|blocked_cb
operator|=
name|wpa_driver_nl80211_rfkill_blocked
expr_stmt|;
name|rcfg
operator|->
name|unblocked_cb
operator|=
name|wpa_driver_nl80211_rfkill_unblocked
expr_stmt|;
name|drv
operator|->
name|rfkill
operator|=
name|rfkill_init
argument_list|(
name|rcfg
argument_list|)
expr_stmt|;
if|if
condition|(
name|drv
operator|->
name|rfkill
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"nl80211: RFKILL status not available"
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|rcfg
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|linux_iface_up
argument_list|(
name|drv
operator|->
name|global
operator|->
name|ioctl_sock
argument_list|,
name|ifname
argument_list|)
operator|>
literal|0
condition|)
name|drv
operator|->
name|start_iface_up
operator|=
literal|1
expr_stmt|;
if|if
condition|(
name|wpa_driver_nl80211_finish_drv_init
argument_list|(
name|drv
argument_list|,
name|set_addr
argument_list|,
literal|1
argument_list|,
name|driver_params
argument_list|)
condition|)
goto|goto
name|failed
goto|;
name|drv
operator|->
name|eapol_tx_sock
operator|=
name|socket
argument_list|(
name|PF_PACKET
argument_list|,
name|SOCK_DGRAM
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|drv
operator|->
name|eapol_tx_sock
operator|<
literal|0
condition|)
goto|goto
name|failed
goto|;
if|if
condition|(
name|drv
operator|->
name|data_tx_status
condition|)
block|{
name|int
name|enabled
init|=
literal|1
decl_stmt|;
if|if
condition|(
name|setsockopt
argument_list|(
name|drv
operator|->
name|eapol_tx_sock
argument_list|,
name|SOL_SOCKET
argument_list|,
name|SO_WIFI_STATUS
argument_list|,
operator|&
name|enabled
argument_list|,
sizeof|sizeof
argument_list|(
name|enabled
argument_list|)
argument_list|)
operator|<
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"nl80211: wifi status sockopt failed\n"
argument_list|)
expr_stmt|;
name|drv
operator|->
name|data_tx_status
operator|=
literal|0
expr_stmt|;
if|if
condition|(
operator|!
name|drv
operator|->
name|use_monitor
condition|)
name|drv
operator|->
name|capa
operator|.
name|flags
operator|&=
operator|~
name|WPA_DRIVER_FLAGS_EAPOL_TX_STATUS
expr_stmt|;
block|}
else|else
block|{
name|eloop_register_read_sock
argument_list|(
name|drv
operator|->
name|eapol_tx_sock
argument_list|,
name|wpa_driver_nl80211_handle_eapol_tx_status
argument_list|,
name|drv
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
name|drv
operator|->
name|global
condition|)
block|{
name|nl80211_check_global
argument_list|(
name|drv
operator|->
name|global
argument_list|)
expr_stmt|;
name|dl_list_add
argument_list|(
operator|&
name|drv
operator|->
name|global
operator|->
name|interfaces
argument_list|,
operator|&
name|drv
operator|->
name|list
argument_list|)
expr_stmt|;
name|drv
operator|->
name|in_interface_list
operator|=
literal|1
expr_stmt|;
block|}
return|return
name|bss
return|;
name|failed
label|:
name|wpa_driver_nl80211_deinit
argument_list|(
name|bss
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
end_function

begin_comment
comment|/**  * wpa_driver_nl80211_init - Initialize nl80211 driver interface  * @ctx: context to be used when calling wpa_supplicant functions,  * e.g., wpa_supplicant_event()  * @ifname: interface name, e.g., wlan0  * @global_priv: private driver global data from global_init()  * Returns: Pointer to private data, %NULL on failure  */
end_comment

begin_function
specifier|static
name|void
modifier|*
name|wpa_driver_nl80211_init
parameter_list|(
name|void
modifier|*
name|ctx
parameter_list|,
specifier|const
name|char
modifier|*
name|ifname
parameter_list|,
name|void
modifier|*
name|global_priv
parameter_list|)
block|{
return|return
name|wpa_driver_nl80211_drv_init
argument_list|(
name|ctx
argument_list|,
name|ifname
argument_list|,
name|global_priv
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|nl80211_register_frame
parameter_list|(
name|struct
name|i802_bss
modifier|*
name|bss
parameter_list|,
name|struct
name|nl_handle
modifier|*
name|nl_handle
parameter_list|,
name|u16
name|type
parameter_list|,
specifier|const
name|u8
modifier|*
name|match
parameter_list|,
name|size_t
name|match_len
parameter_list|)
block|{
name|struct
name|wpa_driver_nl80211_data
modifier|*
name|drv
init|=
name|bss
operator|->
name|drv
decl_stmt|;
name|struct
name|nl_msg
modifier|*
name|msg
decl_stmt|;
name|int
name|ret
decl_stmt|;
name|char
name|buf
index|[
literal|30
index|]
decl_stmt|;
name|buf
index|[
literal|0
index|]
operator|=
literal|'\0'
expr_stmt|;
name|wpa_snprintf_hex
argument_list|(
name|buf
argument_list|,
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
argument_list|,
name|match
argument_list|,
name|match_len
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"nl80211: Register frame type=0x%x (%s) nl_handle=%p match=%s"
argument_list|,
name|type
argument_list|,
name|fc2str
argument_list|(
name|type
argument_list|)
argument_list|,
name|nl_handle
argument_list|,
name|buf
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|msg
operator|=
name|nl80211_cmd_msg
argument_list|(
name|bss
argument_list|,
literal|0
argument_list|,
name|NL80211_CMD_REGISTER_ACTION
argument_list|)
operator|)
operator|||
name|nla_put_u16
argument_list|(
name|msg
argument_list|,
name|NL80211_ATTR_FRAME_TYPE
argument_list|,
name|type
argument_list|)
operator|||
name|nla_put
argument_list|(
name|msg
argument_list|,
name|NL80211_ATTR_FRAME_MATCH
argument_list|,
name|match_len
argument_list|,
name|match
argument_list|)
condition|)
block|{
name|nlmsg_free
argument_list|(
name|msg
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|ret
operator|=
name|send_and_recv
argument_list|(
name|drv
operator|->
name|global
argument_list|,
name|nl_handle
argument_list|,
name|msg
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"nl80211: Register frame command "
literal|"failed (type=%u): ret=%d (%s)"
argument_list|,
name|type
argument_list|,
name|ret
argument_list|,
name|strerror
argument_list|(
operator|-
name|ret
argument_list|)
argument_list|)
expr_stmt|;
name|wpa_hexdump
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"nl80211: Register frame match"
argument_list|,
name|match
argument_list|,
name|match_len
argument_list|)
expr_stmt|;
block|}
return|return
name|ret
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|nl80211_alloc_mgmt_handle
parameter_list|(
name|struct
name|i802_bss
modifier|*
name|bss
parameter_list|)
block|{
if|if
condition|(
name|bss
operator|->
name|nl_mgmt
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"nl80211: Mgmt reporting "
literal|"already on! (nl_mgmt=%p)"
argument_list|,
name|bss
operator|->
name|nl_mgmt
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|bss
operator|->
name|nl_mgmt
operator|=
name|nl_create_handle
argument_list|(
name|bss
operator|->
name|nl_cb
argument_list|,
literal|"mgmt"
argument_list|)
expr_stmt|;
if|if
condition|(
name|bss
operator|->
name|nl_mgmt
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|nl80211_mgmt_handle_register_eloop
parameter_list|(
name|struct
name|i802_bss
modifier|*
name|bss
parameter_list|)
block|{
name|nl80211_register_eloop_read
argument_list|(
operator|&
name|bss
operator|->
name|nl_mgmt
argument_list|,
name|wpa_driver_nl80211_event_receive
argument_list|,
name|bss
operator|->
name|nl_cb
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|nl80211_register_action_frame
parameter_list|(
name|struct
name|i802_bss
modifier|*
name|bss
parameter_list|,
specifier|const
name|u8
modifier|*
name|match
parameter_list|,
name|size_t
name|match_len
parameter_list|)
block|{
name|u16
name|type
init|=
operator|(
name|WLAN_FC_TYPE_MGMT
operator|<<
literal|2
operator|)
operator||
operator|(
name|WLAN_FC_STYPE_ACTION
operator|<<
literal|4
operator|)
decl_stmt|;
return|return
name|nl80211_register_frame
argument_list|(
name|bss
argument_list|,
name|bss
operator|->
name|nl_mgmt
argument_list|,
name|type
argument_list|,
name|match
argument_list|,
name|match_len
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|nl80211_mgmt_subscribe_non_ap
parameter_list|(
name|struct
name|i802_bss
modifier|*
name|bss
parameter_list|)
block|{
name|struct
name|wpa_driver_nl80211_data
modifier|*
name|drv
init|=
name|bss
operator|->
name|drv
decl_stmt|;
name|int
name|ret
init|=
literal|0
decl_stmt|;
if|if
condition|(
name|nl80211_alloc_mgmt_handle
argument_list|(
name|bss
argument_list|)
condition|)
return|return
operator|-
literal|1
return|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"nl80211: Subscribe to mgmt frames with non-AP "
literal|"handle %p"
argument_list|,
name|bss
operator|->
name|nl_mgmt
argument_list|)
expr_stmt|;
if|if
condition|(
name|drv
operator|->
name|nlmode
operator|==
name|NL80211_IFTYPE_ADHOC
condition|)
block|{
name|u16
name|type
init|=
operator|(
name|WLAN_FC_TYPE_MGMT
operator|<<
literal|2
operator|)
operator||
operator|(
name|WLAN_FC_STYPE_AUTH
operator|<<
literal|4
operator|)
decl_stmt|;
comment|/* register for any AUTH message */
name|nl80211_register_frame
argument_list|(
name|bss
argument_list|,
name|bss
operator|->
name|nl_mgmt
argument_list|,
name|type
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
ifdef|#
directive|ifdef
name|CONFIG_INTERWORKING
comment|/* QoS Map Configure */
if|if
condition|(
name|nl80211_register_action_frame
argument_list|(
name|bss
argument_list|,
operator|(
name|u8
operator|*
operator|)
literal|"\x01\x04"
argument_list|,
literal|2
argument_list|)
operator|<
literal|0
condition|)
name|ret
operator|=
operator|-
literal|1
expr_stmt|;
endif|#
directive|endif
comment|/* CONFIG_INTERWORKING */
if|#
directive|if
name|defined
argument_list|(
name|CONFIG_P2P
argument_list|)
operator|||
name|defined
argument_list|(
name|CONFIG_INTERWORKING
argument_list|)
comment|/* GAS Initial Request */
if|if
condition|(
name|nl80211_register_action_frame
argument_list|(
name|bss
argument_list|,
operator|(
name|u8
operator|*
operator|)
literal|"\x04\x0a"
argument_list|,
literal|2
argument_list|)
operator|<
literal|0
condition|)
name|ret
operator|=
operator|-
literal|1
expr_stmt|;
comment|/* GAS Initial Response */
if|if
condition|(
name|nl80211_register_action_frame
argument_list|(
name|bss
argument_list|,
operator|(
name|u8
operator|*
operator|)
literal|"\x04\x0b"
argument_list|,
literal|2
argument_list|)
operator|<
literal|0
condition|)
name|ret
operator|=
operator|-
literal|1
expr_stmt|;
comment|/* GAS Comeback Request */
if|if
condition|(
name|nl80211_register_action_frame
argument_list|(
name|bss
argument_list|,
operator|(
name|u8
operator|*
operator|)
literal|"\x04\x0c"
argument_list|,
literal|2
argument_list|)
operator|<
literal|0
condition|)
name|ret
operator|=
operator|-
literal|1
expr_stmt|;
comment|/* GAS Comeback Response */
if|if
condition|(
name|nl80211_register_action_frame
argument_list|(
name|bss
argument_list|,
operator|(
name|u8
operator|*
operator|)
literal|"\x04\x0d"
argument_list|,
literal|2
argument_list|)
operator|<
literal|0
condition|)
name|ret
operator|=
operator|-
literal|1
expr_stmt|;
comment|/* Protected GAS Initial Request */
if|if
condition|(
name|nl80211_register_action_frame
argument_list|(
name|bss
argument_list|,
operator|(
name|u8
operator|*
operator|)
literal|"\x09\x0a"
argument_list|,
literal|2
argument_list|)
operator|<
literal|0
condition|)
name|ret
operator|=
operator|-
literal|1
expr_stmt|;
comment|/* Protected GAS Initial Response */
if|if
condition|(
name|nl80211_register_action_frame
argument_list|(
name|bss
argument_list|,
operator|(
name|u8
operator|*
operator|)
literal|"\x09\x0b"
argument_list|,
literal|2
argument_list|)
operator|<
literal|0
condition|)
name|ret
operator|=
operator|-
literal|1
expr_stmt|;
comment|/* Protected GAS Comeback Request */
if|if
condition|(
name|nl80211_register_action_frame
argument_list|(
name|bss
argument_list|,
operator|(
name|u8
operator|*
operator|)
literal|"\x09\x0c"
argument_list|,
literal|2
argument_list|)
operator|<
literal|0
condition|)
name|ret
operator|=
operator|-
literal|1
expr_stmt|;
comment|/* Protected GAS Comeback Response */
if|if
condition|(
name|nl80211_register_action_frame
argument_list|(
name|bss
argument_list|,
operator|(
name|u8
operator|*
operator|)
literal|"\x09\x0d"
argument_list|,
literal|2
argument_list|)
operator|<
literal|0
condition|)
name|ret
operator|=
operator|-
literal|1
expr_stmt|;
endif|#
directive|endif
comment|/* CONFIG_P2P || CONFIG_INTERWORKING */
ifdef|#
directive|ifdef
name|CONFIG_P2P
comment|/* P2P Public Action */
if|if
condition|(
name|nl80211_register_action_frame
argument_list|(
name|bss
argument_list|,
operator|(
name|u8
operator|*
operator|)
literal|"\x04\x09\x50\x6f\x9a\x09"
argument_list|,
literal|6
argument_list|)
operator|<
literal|0
condition|)
name|ret
operator|=
operator|-
literal|1
expr_stmt|;
comment|/* P2P Action */
if|if
condition|(
name|nl80211_register_action_frame
argument_list|(
name|bss
argument_list|,
operator|(
name|u8
operator|*
operator|)
literal|"\x7f\x50\x6f\x9a\x09"
argument_list|,
literal|5
argument_list|)
operator|<
literal|0
condition|)
name|ret
operator|=
operator|-
literal|1
expr_stmt|;
endif|#
directive|endif
comment|/* CONFIG_P2P */
ifdef|#
directive|ifdef
name|CONFIG_IEEE80211W
comment|/* SA Query Response */
if|if
condition|(
name|nl80211_register_action_frame
argument_list|(
name|bss
argument_list|,
operator|(
name|u8
operator|*
operator|)
literal|"\x08\x01"
argument_list|,
literal|2
argument_list|)
operator|<
literal|0
condition|)
name|ret
operator|=
operator|-
literal|1
expr_stmt|;
endif|#
directive|endif
comment|/* CONFIG_IEEE80211W */
ifdef|#
directive|ifdef
name|CONFIG_TDLS
if|if
condition|(
operator|(
name|drv
operator|->
name|capa
operator|.
name|flags
operator|&
name|WPA_DRIVER_FLAGS_TDLS_SUPPORT
operator|)
condition|)
block|{
comment|/* TDLS Discovery Response */
if|if
condition|(
name|nl80211_register_action_frame
argument_list|(
name|bss
argument_list|,
operator|(
name|u8
operator|*
operator|)
literal|"\x04\x0e"
argument_list|,
literal|2
argument_list|)
operator|<
literal|0
condition|)
name|ret
operator|=
operator|-
literal|1
expr_stmt|;
block|}
endif|#
directive|endif
comment|/* CONFIG_TDLS */
comment|/* FT Action frames */
if|if
condition|(
name|nl80211_register_action_frame
argument_list|(
name|bss
argument_list|,
operator|(
name|u8
operator|*
operator|)
literal|"\x06"
argument_list|,
literal|1
argument_list|)
operator|<
literal|0
condition|)
name|ret
operator|=
operator|-
literal|1
expr_stmt|;
else|else
name|drv
operator|->
name|capa
operator|.
name|key_mgmt
operator||=
name|WPA_DRIVER_CAPA_KEY_MGMT_FT
operator||
name|WPA_DRIVER_CAPA_KEY_MGMT_FT_PSK
expr_stmt|;
comment|/* WNM - BSS Transition Management Request */
if|if
condition|(
name|nl80211_register_action_frame
argument_list|(
name|bss
argument_list|,
operator|(
name|u8
operator|*
operator|)
literal|"\x0a\x07"
argument_list|,
literal|2
argument_list|)
operator|<
literal|0
condition|)
name|ret
operator|=
operator|-
literal|1
expr_stmt|;
comment|/* WNM-Sleep Mode Response */
if|if
condition|(
name|nl80211_register_action_frame
argument_list|(
name|bss
argument_list|,
operator|(
name|u8
operator|*
operator|)
literal|"\x0a\x11"
argument_list|,
literal|2
argument_list|)
operator|<
literal|0
condition|)
name|ret
operator|=
operator|-
literal|1
expr_stmt|;
ifdef|#
directive|ifdef
name|CONFIG_HS20
comment|/* WNM-Notification */
if|if
condition|(
name|nl80211_register_action_frame
argument_list|(
name|bss
argument_list|,
operator|(
name|u8
operator|*
operator|)
literal|"\x0a\x1a"
argument_list|,
literal|2
argument_list|)
operator|<
literal|0
condition|)
name|ret
operator|=
operator|-
literal|1
expr_stmt|;
endif|#
directive|endif
comment|/* CONFIG_HS20 */
comment|/* WMM-AC ADDTS Response */
if|if
condition|(
name|nl80211_register_action_frame
argument_list|(
name|bss
argument_list|,
operator|(
name|u8
operator|*
operator|)
literal|"\x11\x01"
argument_list|,
literal|2
argument_list|)
operator|<
literal|0
condition|)
name|ret
operator|=
operator|-
literal|1
expr_stmt|;
comment|/* WMM-AC DELTS */
if|if
condition|(
name|nl80211_register_action_frame
argument_list|(
name|bss
argument_list|,
operator|(
name|u8
operator|*
operator|)
literal|"\x11\x02"
argument_list|,
literal|2
argument_list|)
operator|<
literal|0
condition|)
name|ret
operator|=
operator|-
literal|1
expr_stmt|;
comment|/* Radio Measurement - Neighbor Report Response */
if|if
condition|(
name|nl80211_register_action_frame
argument_list|(
name|bss
argument_list|,
operator|(
name|u8
operator|*
operator|)
literal|"\x05\x05"
argument_list|,
literal|2
argument_list|)
operator|<
literal|0
condition|)
name|ret
operator|=
operator|-
literal|1
expr_stmt|;
comment|/* Radio Measurement - Link Measurement Request */
if|if
condition|(
operator|(
name|drv
operator|->
name|capa
operator|.
name|rrm_flags
operator|&
name|WPA_DRIVER_FLAGS_TX_POWER_INSERTION
operator|)
operator|&&
operator|(
name|nl80211_register_action_frame
argument_list|(
name|bss
argument_list|,
operator|(
name|u8
operator|*
operator|)
literal|"\x05\x02"
argument_list|,
literal|2
argument_list|)
operator|<
literal|0
operator|)
condition|)
name|ret
operator|=
operator|-
literal|1
expr_stmt|;
name|nl80211_mgmt_handle_register_eloop
argument_list|(
name|bss
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|nl80211_mgmt_subscribe_mesh
parameter_list|(
name|struct
name|i802_bss
modifier|*
name|bss
parameter_list|)
block|{
name|int
name|ret
init|=
literal|0
decl_stmt|;
if|if
condition|(
name|nl80211_alloc_mgmt_handle
argument_list|(
name|bss
argument_list|)
condition|)
return|return
operator|-
literal|1
return|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"nl80211: Subscribe to mgmt frames with mesh handle %p"
argument_list|,
name|bss
operator|->
name|nl_mgmt
argument_list|)
expr_stmt|;
comment|/* Auth frames for mesh SAE */
if|if
condition|(
name|nl80211_register_frame
argument_list|(
name|bss
argument_list|,
name|bss
operator|->
name|nl_mgmt
argument_list|,
operator|(
name|WLAN_FC_TYPE_MGMT
operator|<<
literal|2
operator|)
operator||
operator|(
name|WLAN_FC_STYPE_AUTH
operator|<<
literal|4
operator|)
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
operator|<
literal|0
condition|)
name|ret
operator|=
operator|-
literal|1
expr_stmt|;
comment|/* Mesh peering open */
if|if
condition|(
name|nl80211_register_action_frame
argument_list|(
name|bss
argument_list|,
operator|(
name|u8
operator|*
operator|)
literal|"\x0f\x01"
argument_list|,
literal|2
argument_list|)
operator|<
literal|0
condition|)
name|ret
operator|=
operator|-
literal|1
expr_stmt|;
comment|/* Mesh peering confirm */
if|if
condition|(
name|nl80211_register_action_frame
argument_list|(
name|bss
argument_list|,
operator|(
name|u8
operator|*
operator|)
literal|"\x0f\x02"
argument_list|,
literal|2
argument_list|)
operator|<
literal|0
condition|)
name|ret
operator|=
operator|-
literal|1
expr_stmt|;
comment|/* Mesh peering close */
if|if
condition|(
name|nl80211_register_action_frame
argument_list|(
name|bss
argument_list|,
operator|(
name|u8
operator|*
operator|)
literal|"\x0f\x03"
argument_list|,
literal|2
argument_list|)
operator|<
literal|0
condition|)
name|ret
operator|=
operator|-
literal|1
expr_stmt|;
name|nl80211_mgmt_handle_register_eloop
argument_list|(
name|bss
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|nl80211_register_spurious_class3
parameter_list|(
name|struct
name|i802_bss
modifier|*
name|bss
parameter_list|)
block|{
name|struct
name|nl_msg
modifier|*
name|msg
decl_stmt|;
name|int
name|ret
decl_stmt|;
name|msg
operator|=
name|nl80211_bss_msg
argument_list|(
name|bss
argument_list|,
literal|0
argument_list|,
name|NL80211_CMD_UNEXPECTED_FRAME
argument_list|)
expr_stmt|;
name|ret
operator|=
name|send_and_recv
argument_list|(
name|bss
operator|->
name|drv
operator|->
name|global
argument_list|,
name|bss
operator|->
name|nl_mgmt
argument_list|,
name|msg
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"nl80211: Register spurious class3 "
literal|"failed: ret=%d (%s)"
argument_list|,
name|ret
argument_list|,
name|strerror
argument_list|(
operator|-
name|ret
argument_list|)
argument_list|)
expr_stmt|;
block|}
return|return
name|ret
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|nl80211_mgmt_subscribe_ap
parameter_list|(
name|struct
name|i802_bss
modifier|*
name|bss
parameter_list|)
block|{
specifier|static
specifier|const
name|int
name|stypes
index|[]
init|=
block|{
name|WLAN_FC_STYPE_AUTH
block|,
name|WLAN_FC_STYPE_ASSOC_REQ
block|,
name|WLAN_FC_STYPE_REASSOC_REQ
block|,
name|WLAN_FC_STYPE_DISASSOC
block|,
name|WLAN_FC_STYPE_DEAUTH
block|,
name|WLAN_FC_STYPE_ACTION
block|,
name|WLAN_FC_STYPE_PROBE_REQ
block|,
comment|/* Beacon doesn't work as mac80211 doesn't currently allow  * it, but it wouldn't really be the right thing anyway as  * it isn't per interface ... maybe just dump the scan  * results periodically for OLBC?  */
comment|/* WLAN_FC_STYPE_BEACON, */
block|}
decl_stmt|;
name|unsigned
name|int
name|i
decl_stmt|;
if|if
condition|(
name|nl80211_alloc_mgmt_handle
argument_list|(
name|bss
argument_list|)
condition|)
return|return
operator|-
literal|1
return|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"nl80211: Subscribe to mgmt frames with AP "
literal|"handle %p"
argument_list|,
name|bss
operator|->
name|nl_mgmt
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|ARRAY_SIZE
argument_list|(
name|stypes
argument_list|)
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|nl80211_register_frame
argument_list|(
name|bss
argument_list|,
name|bss
operator|->
name|nl_mgmt
argument_list|,
operator|(
name|WLAN_FC_TYPE_MGMT
operator|<<
literal|2
operator|)
operator||
operator|(
name|stypes
index|[
name|i
index|]
operator|<<
literal|4
operator|)
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
operator|<
literal|0
condition|)
block|{
goto|goto
name|out_err
goto|;
block|}
block|}
if|if
condition|(
name|nl80211_register_spurious_class3
argument_list|(
name|bss
argument_list|)
condition|)
goto|goto
name|out_err
goto|;
if|if
condition|(
name|nl80211_get_wiphy_data_ap
argument_list|(
name|bss
argument_list|)
operator|==
name|NULL
condition|)
goto|goto
name|out_err
goto|;
name|nl80211_mgmt_handle_register_eloop
argument_list|(
name|bss
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
name|out_err
label|:
name|nl_destroy_handles
argument_list|(
operator|&
name|bss
operator|->
name|nl_mgmt
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|nl80211_mgmt_subscribe_ap_dev_sme
parameter_list|(
name|struct
name|i802_bss
modifier|*
name|bss
parameter_list|)
block|{
if|if
condition|(
name|nl80211_alloc_mgmt_handle
argument_list|(
name|bss
argument_list|)
condition|)
return|return
operator|-
literal|1
return|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"nl80211: Subscribe to mgmt frames with AP "
literal|"handle %p (device SME)"
argument_list|,
name|bss
operator|->
name|nl_mgmt
argument_list|)
expr_stmt|;
if|if
condition|(
name|nl80211_register_frame
argument_list|(
name|bss
argument_list|,
name|bss
operator|->
name|nl_mgmt
argument_list|,
operator|(
name|WLAN_FC_TYPE_MGMT
operator|<<
literal|2
operator|)
operator||
operator|(
name|WLAN_FC_STYPE_ACTION
operator|<<
literal|4
operator|)
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
operator|<
literal|0
condition|)
goto|goto
name|out_err
goto|;
name|nl80211_mgmt_handle_register_eloop
argument_list|(
name|bss
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
name|out_err
label|:
name|nl_destroy_handles
argument_list|(
operator|&
name|bss
operator|->
name|nl_mgmt
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|nl80211_mgmt_unsubscribe
parameter_list|(
name|struct
name|i802_bss
modifier|*
name|bss
parameter_list|,
specifier|const
name|char
modifier|*
name|reason
parameter_list|)
block|{
if|if
condition|(
name|bss
operator|->
name|nl_mgmt
operator|==
name|NULL
condition|)
return|return;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"nl80211: Unsubscribe mgmt frames handle %p "
literal|"(%s)"
argument_list|,
name|bss
operator|->
name|nl_mgmt
argument_list|,
name|reason
argument_list|)
expr_stmt|;
name|nl80211_destroy_eloop_handle
argument_list|(
operator|&
name|bss
operator|->
name|nl_mgmt
argument_list|)
expr_stmt|;
name|nl80211_put_wiphy_data_ap
argument_list|(
name|bss
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|wpa_driver_nl80211_send_rfkill
parameter_list|(
name|void
modifier|*
name|eloop_ctx
parameter_list|,
name|void
modifier|*
name|timeout_ctx
parameter_list|)
block|{
name|wpa_supplicant_event
argument_list|(
name|timeout_ctx
argument_list|,
name|EVENT_INTERFACE_DISABLED
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|nl80211_del_p2pdev
parameter_list|(
name|struct
name|i802_bss
modifier|*
name|bss
parameter_list|)
block|{
name|struct
name|nl_msg
modifier|*
name|msg
decl_stmt|;
name|int
name|ret
decl_stmt|;
name|msg
operator|=
name|nl80211_cmd_msg
argument_list|(
name|bss
argument_list|,
literal|0
argument_list|,
name|NL80211_CMD_DEL_INTERFACE
argument_list|)
expr_stmt|;
name|ret
operator|=
name|send_and_recv_msgs
argument_list|(
name|bss
operator|->
name|drv
argument_list|,
name|msg
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"nl80211: Delete P2P Device %s (0x%llx): %s"
argument_list|,
name|bss
operator|->
name|ifname
argument_list|,
operator|(
name|long
name|long
name|unsigned
name|int
operator|)
name|bss
operator|->
name|wdev_id
argument_list|,
name|strerror
argument_list|(
operator|-
name|ret
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|nl80211_set_p2pdev
parameter_list|(
name|struct
name|i802_bss
modifier|*
name|bss
parameter_list|,
name|int
name|start
parameter_list|)
block|{
name|struct
name|nl_msg
modifier|*
name|msg
decl_stmt|;
name|int
name|ret
decl_stmt|;
name|msg
operator|=
name|nl80211_cmd_msg
argument_list|(
name|bss
argument_list|,
literal|0
argument_list|,
name|start
condition|?
name|NL80211_CMD_START_P2P_DEVICE
else|:
name|NL80211_CMD_STOP_P2P_DEVICE
argument_list|)
expr_stmt|;
name|ret
operator|=
name|send_and_recv_msgs
argument_list|(
name|bss
operator|->
name|drv
argument_list|,
name|msg
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"nl80211: %s P2P Device %s (0x%llx): %s"
argument_list|,
name|start
condition|?
literal|"Start"
else|:
literal|"Stop"
argument_list|,
name|bss
operator|->
name|ifname
argument_list|,
operator|(
name|long
name|long
name|unsigned
name|int
operator|)
name|bss
operator|->
name|wdev_id
argument_list|,
name|strerror
argument_list|(
operator|-
name|ret
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|i802_set_iface_flags
parameter_list|(
name|struct
name|i802_bss
modifier|*
name|bss
parameter_list|,
name|int
name|up
parameter_list|)
block|{
name|enum
name|nl80211_iftype
name|nlmode
decl_stmt|;
name|nlmode
operator|=
name|nl80211_get_ifmode
argument_list|(
name|bss
argument_list|)
expr_stmt|;
if|if
condition|(
name|nlmode
operator|!=
name|NL80211_IFTYPE_P2P_DEVICE
condition|)
block|{
return|return
name|linux_set_iface_flags
argument_list|(
name|bss
operator|->
name|drv
operator|->
name|global
operator|->
name|ioctl_sock
argument_list|,
name|bss
operator|->
name|ifname
argument_list|,
name|up
argument_list|)
return|;
block|}
comment|/* P2P Device has start/stop which is equivalent */
return|return
name|nl80211_set_p2pdev
argument_list|(
name|bss
argument_list|,
name|up
argument_list|)
return|;
block|}
end_function

begin_ifdef
ifdef|#
directive|ifdef
name|CONFIG_TESTING_OPTIONS
end_ifdef

begin_function
specifier|static
name|int
name|qca_vendor_test_cmd_handler
parameter_list|(
name|struct
name|nl_msg
modifier|*
name|msg
parameter_list|,
name|void
modifier|*
name|arg
parameter_list|)
block|{
comment|/* struct wpa_driver_nl80211_data *drv = arg; */
name|struct
name|nlattr
modifier|*
name|tb
index|[
name|NL80211_ATTR_MAX
operator|+
literal|1
index|]
decl_stmt|;
name|struct
name|genlmsghdr
modifier|*
name|gnlh
init|=
name|nlmsg_data
argument_list|(
name|nlmsg_hdr
argument_list|(
name|msg
argument_list|)
argument_list|)
decl_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"nl80211: QCA vendor test command response received"
argument_list|)
expr_stmt|;
name|nla_parse
argument_list|(
name|tb
argument_list|,
name|NL80211_ATTR_MAX
argument_list|,
name|genlmsg_attrdata
argument_list|(
name|gnlh
argument_list|,
literal|0
argument_list|)
argument_list|,
name|genlmsg_attrlen
argument_list|(
name|gnlh
argument_list|,
literal|0
argument_list|)
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|tb
index|[
name|NL80211_ATTR_VENDOR_DATA
index|]
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"nl80211: No vendor data attribute"
argument_list|)
expr_stmt|;
return|return
name|NL_SKIP
return|;
block|}
name|wpa_hexdump
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"nl80211: Received QCA vendor test command response"
argument_list|,
name|nla_data
argument_list|(
name|tb
index|[
name|NL80211_ATTR_VENDOR_DATA
index|]
argument_list|)
argument_list|,
name|nla_len
argument_list|(
name|tb
index|[
name|NL80211_ATTR_VENDOR_DATA
index|]
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|NL_SKIP
return|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* CONFIG_TESTING_OPTIONS */
end_comment

begin_function
specifier|static
name|void
name|qca_vendor_test
parameter_list|(
name|struct
name|wpa_driver_nl80211_data
modifier|*
name|drv
parameter_list|)
block|{
ifdef|#
directive|ifdef
name|CONFIG_TESTING_OPTIONS
name|struct
name|nl_msg
modifier|*
name|msg
decl_stmt|;
name|struct
name|nlattr
modifier|*
name|params
decl_stmt|;
name|int
name|ret
decl_stmt|;
if|if
condition|(
operator|!
operator|(
name|msg
operator|=
name|nl80211_drv_msg
argument_list|(
name|drv
argument_list|,
literal|0
argument_list|,
name|NL80211_CMD_VENDOR
argument_list|)
operator|)
operator|||
name|nla_put_u32
argument_list|(
name|msg
argument_list|,
name|NL80211_ATTR_VENDOR_ID
argument_list|,
name|OUI_QCA
argument_list|)
operator|||
name|nla_put_u32
argument_list|(
name|msg
argument_list|,
name|NL80211_ATTR_VENDOR_SUBCMD
argument_list|,
name|QCA_NL80211_VENDOR_SUBCMD_TEST
argument_list|)
operator|||
operator|!
operator|(
name|params
operator|=
name|nla_nest_start
argument_list|(
name|msg
argument_list|,
name|NL80211_ATTR_VENDOR_DATA
argument_list|)
operator|)
operator|||
name|nla_put_u32
argument_list|(
name|msg
argument_list|,
name|QCA_WLAN_VENDOR_ATTR_TEST
argument_list|,
literal|123
argument_list|)
condition|)
block|{
name|nlmsg_free
argument_list|(
name|msg
argument_list|)
expr_stmt|;
return|return;
block|}
name|nla_nest_end
argument_list|(
name|msg
argument_list|,
name|params
argument_list|)
expr_stmt|;
name|ret
operator|=
name|send_and_recv_msgs
argument_list|(
name|drv
argument_list|,
name|msg
argument_list|,
name|qca_vendor_test_cmd_handler
argument_list|,
name|drv
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"nl80211: QCA vendor test command returned %d (%s)"
argument_list|,
name|ret
argument_list|,
name|strerror
argument_list|(
operator|-
name|ret
argument_list|)
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* CONFIG_TESTING_OPTIONS */
block|}
end_function

begin_function
specifier|static
name|int
name|wpa_driver_nl80211_finish_drv_init
parameter_list|(
name|struct
name|wpa_driver_nl80211_data
modifier|*
name|drv
parameter_list|,
specifier|const
name|u8
modifier|*
name|set_addr
parameter_list|,
name|int
name|first
parameter_list|,
specifier|const
name|char
modifier|*
name|driver_params
parameter_list|)
block|{
name|struct
name|i802_bss
modifier|*
name|bss
init|=
name|drv
operator|->
name|first_bss
decl_stmt|;
name|int
name|send_rfkill_event
init|=
literal|0
decl_stmt|;
name|enum
name|nl80211_iftype
name|nlmode
decl_stmt|;
name|drv
operator|->
name|ifindex
operator|=
name|if_nametoindex
argument_list|(
name|bss
operator|->
name|ifname
argument_list|)
expr_stmt|;
name|bss
operator|->
name|ifindex
operator|=
name|drv
operator|->
name|ifindex
expr_stmt|;
name|bss
operator|->
name|wdev_id
operator|=
name|drv
operator|->
name|global
operator|->
name|if_add_wdevid
expr_stmt|;
name|bss
operator|->
name|wdev_id_set
operator|=
name|drv
operator|->
name|global
operator|->
name|if_add_wdevid_set
expr_stmt|;
name|bss
operator|->
name|if_dynamic
operator|=
name|drv
operator|->
name|ifindex
operator|==
name|drv
operator|->
name|global
operator|->
name|if_add_ifindex
expr_stmt|;
name|bss
operator|->
name|if_dynamic
operator|=
name|bss
operator|->
name|if_dynamic
operator|||
name|drv
operator|->
name|global
operator|->
name|if_add_wdevid_set
expr_stmt|;
name|drv
operator|->
name|global
operator|->
name|if_add_wdevid_set
operator|=
literal|0
expr_stmt|;
if|if
condition|(
operator|!
name|bss
operator|->
name|if_dynamic
operator|&&
name|nl80211_get_ifmode
argument_list|(
name|bss
argument_list|)
operator|==
name|NL80211_IFTYPE_AP
condition|)
name|bss
operator|->
name|static_ap
operator|=
literal|1
expr_stmt|;
if|if
condition|(
name|wpa_driver_nl80211_capa
argument_list|(
name|drv
argument_list|)
condition|)
return|return
operator|-
literal|1
return|;
if|if
condition|(
name|driver_params
operator|&&
name|nl80211_set_param
argument_list|(
name|bss
argument_list|,
name|driver_params
argument_list|)
operator|<
literal|0
condition|)
return|return
operator|-
literal|1
return|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"nl80211: interface %s in phy %s"
argument_list|,
name|bss
operator|->
name|ifname
argument_list|,
name|drv
operator|->
name|phyname
argument_list|)
expr_stmt|;
if|if
condition|(
name|set_addr
operator|&&
operator|(
name|linux_set_iface_flags
argument_list|(
name|drv
operator|->
name|global
operator|->
name|ioctl_sock
argument_list|,
name|bss
operator|->
name|ifname
argument_list|,
literal|0
argument_list|)
operator|||
name|linux_set_ifhwaddr
argument_list|(
name|drv
operator|->
name|global
operator|->
name|ioctl_sock
argument_list|,
name|bss
operator|->
name|ifname
argument_list|,
name|set_addr
argument_list|)
operator|)
condition|)
return|return
operator|-
literal|1
return|;
if|if
condition|(
name|first
operator|&&
name|nl80211_get_ifmode
argument_list|(
name|bss
argument_list|)
operator|==
name|NL80211_IFTYPE_AP
condition|)
name|drv
operator|->
name|start_mode_ap
operator|=
literal|1
expr_stmt|;
if|if
condition|(
name|drv
operator|->
name|hostapd
operator|||
name|bss
operator|->
name|static_ap
condition|)
name|nlmode
operator|=
name|NL80211_IFTYPE_AP
expr_stmt|;
elseif|else
if|if
condition|(
name|bss
operator|->
name|if_dynamic
condition|)
name|nlmode
operator|=
name|nl80211_get_ifmode
argument_list|(
name|bss
argument_list|)
expr_stmt|;
else|else
name|nlmode
operator|=
name|NL80211_IFTYPE_STATION
expr_stmt|;
if|if
condition|(
name|wpa_driver_nl80211_set_mode
argument_list|(
name|bss
argument_list|,
name|nlmode
argument_list|)
operator|<
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"nl80211: Could not configure driver mode"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
if|if
condition|(
name|nlmode
operator|==
name|NL80211_IFTYPE_P2P_DEVICE
condition|)
name|nl80211_get_macaddr
argument_list|(
name|bss
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|rfkill_is_blocked
argument_list|(
name|drv
operator|->
name|rfkill
argument_list|)
condition|)
block|{
name|int
name|ret
init|=
name|i802_set_iface_flags
argument_list|(
name|bss
argument_list|,
literal|1
argument_list|)
decl_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"nl80211: Could not set "
literal|"interface '%s' UP"
argument_list|,
name|bss
operator|->
name|ifname
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
if|if
condition|(
name|nlmode
operator|==
name|NL80211_IFTYPE_P2P_DEVICE
condition|)
return|return
name|ret
return|;
block|}
else|else
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"nl80211: Could not yet enable "
literal|"interface '%s' due to rfkill"
argument_list|,
name|bss
operator|->
name|ifname
argument_list|)
expr_stmt|;
if|if
condition|(
name|nlmode
operator|==
name|NL80211_IFTYPE_P2P_DEVICE
condition|)
return|return
literal|0
return|;
name|drv
operator|->
name|if_disabled
operator|=
literal|1
expr_stmt|;
name|send_rfkill_event
operator|=
literal|1
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|drv
operator|->
name|hostapd
condition|)
name|netlink_send_oper_ifla
argument_list|(
name|drv
operator|->
name|global
operator|->
name|netlink
argument_list|,
name|drv
operator|->
name|ifindex
argument_list|,
literal|1
argument_list|,
name|IF_OPER_DORMANT
argument_list|)
expr_stmt|;
if|if
condition|(
name|linux_get_ifhwaddr
argument_list|(
name|drv
operator|->
name|global
operator|->
name|ioctl_sock
argument_list|,
name|bss
operator|->
name|ifname
argument_list|,
name|bss
operator|->
name|addr
argument_list|)
condition|)
return|return
operator|-
literal|1
return|;
name|os_memcpy
argument_list|(
name|drv
operator|->
name|perm_addr
argument_list|,
name|bss
operator|->
name|addr
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
if|if
condition|(
name|send_rfkill_event
condition|)
block|{
name|eloop_register_timeout
argument_list|(
literal|0
argument_list|,
literal|0
argument_list|,
name|wpa_driver_nl80211_send_rfkill
argument_list|,
name|drv
argument_list|,
name|drv
operator|->
name|ctx
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|drv
operator|->
name|vendor_cmd_test_avail
condition|)
name|qca_vendor_test
argument_list|(
name|drv
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|wpa_driver_nl80211_del_beacon
parameter_list|(
name|struct
name|wpa_driver_nl80211_data
modifier|*
name|drv
parameter_list|)
block|{
name|struct
name|nl_msg
modifier|*
name|msg
decl_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"nl80211: Remove beacon (ifindex=%d)"
argument_list|,
name|drv
operator|->
name|ifindex
argument_list|)
expr_stmt|;
name|msg
operator|=
name|nl80211_drv_msg
argument_list|(
name|drv
argument_list|,
literal|0
argument_list|,
name|NL80211_CMD_DEL_BEACON
argument_list|)
expr_stmt|;
return|return
name|send_and_recv_msgs
argument_list|(
name|drv
argument_list|,
name|msg
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/**  * wpa_driver_nl80211_deinit - Deinitialize nl80211 driver interface  * @bss: Pointer to private nl80211 data from wpa_driver_nl80211_init()  *  * Shut down driver interface and processing of driver events. Free  * private data buffer if one was allocated in wpa_driver_nl80211_init().  */
end_comment

begin_function
specifier|static
name|void
name|wpa_driver_nl80211_deinit
parameter_list|(
name|struct
name|i802_bss
modifier|*
name|bss
parameter_list|)
block|{
name|struct
name|wpa_driver_nl80211_data
modifier|*
name|drv
init|=
name|bss
operator|->
name|drv
decl_stmt|;
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"nl80211: deinit ifname=%s disabled_11b_rates=%d"
argument_list|,
name|bss
operator|->
name|ifname
argument_list|,
name|drv
operator|->
name|disabled_11b_rates
argument_list|)
expr_stmt|;
name|bss
operator|->
name|in_deinit
operator|=
literal|1
expr_stmt|;
if|if
condition|(
name|drv
operator|->
name|data_tx_status
condition|)
name|eloop_unregister_read_sock
argument_list|(
name|drv
operator|->
name|eapol_tx_sock
argument_list|)
expr_stmt|;
if|if
condition|(
name|drv
operator|->
name|eapol_tx_sock
operator|>=
literal|0
condition|)
name|close
argument_list|(
name|drv
operator|->
name|eapol_tx_sock
argument_list|)
expr_stmt|;
if|if
condition|(
name|bss
operator|->
name|nl_preq
condition|)
name|wpa_driver_nl80211_probe_req_report
argument_list|(
name|bss
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|bss
operator|->
name|added_if_into_bridge
condition|)
block|{
if|if
condition|(
name|linux_br_del_if
argument_list|(
name|drv
operator|->
name|global
operator|->
name|ioctl_sock
argument_list|,
name|bss
operator|->
name|brname
argument_list|,
name|bss
operator|->
name|ifname
argument_list|)
operator|<
literal|0
condition|)
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"nl80211: Failed to remove "
literal|"interface %s from bridge %s: %s"
argument_list|,
name|bss
operator|->
name|ifname
argument_list|,
name|bss
operator|->
name|brname
argument_list|,
name|strerror
argument_list|(
name|errno
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|drv
operator|->
name|rtnl_sk
condition|)
name|nl80211_handle_destroy
argument_list|(
name|drv
operator|->
name|rtnl_sk
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|bss
operator|->
name|added_bridge
condition|)
block|{
if|if
condition|(
name|linux_set_iface_flags
argument_list|(
name|drv
operator|->
name|global
operator|->
name|ioctl_sock
argument_list|,
name|bss
operator|->
name|brname
argument_list|,
literal|0
argument_list|)
operator|<
literal|0
condition|)
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"nl80211: Could not set bridge %s down"
argument_list|,
name|bss
operator|->
name|brname
argument_list|)
expr_stmt|;
if|if
condition|(
name|linux_br_del
argument_list|(
name|drv
operator|->
name|global
operator|->
name|ioctl_sock
argument_list|,
name|bss
operator|->
name|brname
argument_list|)
operator|<
literal|0
condition|)
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"nl80211: Failed to remove "
literal|"bridge %s: %s"
argument_list|,
name|bss
operator|->
name|brname
argument_list|,
name|strerror
argument_list|(
name|errno
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|nl80211_remove_monitor_interface
argument_list|(
name|drv
argument_list|)
expr_stmt|;
if|if
condition|(
name|is_ap_interface
argument_list|(
name|drv
operator|->
name|nlmode
argument_list|)
condition|)
name|wpa_driver_nl80211_del_beacon
argument_list|(
name|drv
argument_list|)
expr_stmt|;
if|if
condition|(
name|drv
operator|->
name|eapol_sock
operator|>=
literal|0
condition|)
block|{
name|eloop_unregister_read_sock
argument_list|(
name|drv
operator|->
name|eapol_sock
argument_list|)
expr_stmt|;
name|close
argument_list|(
name|drv
operator|->
name|eapol_sock
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|drv
operator|->
name|if_indices
operator|!=
name|drv
operator|->
name|default_if_indices
condition|)
name|os_free
argument_list|(
name|drv
operator|->
name|if_indices
argument_list|)
expr_stmt|;
if|if
condition|(
name|drv
operator|->
name|disabled_11b_rates
condition|)
name|nl80211_disable_11b_rates
argument_list|(
name|drv
argument_list|,
name|drv
operator|->
name|ifindex
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|netlink_send_oper_ifla
argument_list|(
name|drv
operator|->
name|global
operator|->
name|netlink
argument_list|,
name|drv
operator|->
name|ifindex
argument_list|,
literal|0
argument_list|,
name|IF_OPER_UP
argument_list|)
expr_stmt|;
name|eloop_cancel_timeout
argument_list|(
name|wpa_driver_nl80211_send_rfkill
argument_list|,
name|drv
argument_list|,
name|drv
operator|->
name|ctx
argument_list|)
expr_stmt|;
name|rfkill_deinit
argument_list|(
name|drv
operator|->
name|rfkill
argument_list|)
expr_stmt|;
name|eloop_cancel_timeout
argument_list|(
name|wpa_driver_nl80211_scan_timeout
argument_list|,
name|drv
argument_list|,
name|drv
operator|->
name|ctx
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|drv
operator|->
name|start_iface_up
condition|)
operator|(
name|void
operator|)
name|i802_set_iface_flags
argument_list|(
name|bss
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|drv
operator|->
name|addr_changed
condition|)
block|{
if|if
condition|(
name|linux_set_iface_flags
argument_list|(
name|drv
operator|->
name|global
operator|->
name|ioctl_sock
argument_list|,
name|bss
operator|->
name|ifname
argument_list|,
literal|0
argument_list|)
operator|<
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"nl80211: Could not set interface down to restore permanent MAC address"
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|linux_set_ifhwaddr
argument_list|(
name|drv
operator|->
name|global
operator|->
name|ioctl_sock
argument_list|,
name|bss
operator|->
name|ifname
argument_list|,
name|drv
operator|->
name|perm_addr
argument_list|)
operator|<
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"nl80211: Could not restore permanent MAC address"
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
name|drv
operator|->
name|nlmode
operator|!=
name|NL80211_IFTYPE_P2P_DEVICE
condition|)
block|{
if|if
condition|(
operator|!
name|drv
operator|->
name|hostapd
operator|||
operator|!
name|drv
operator|->
name|start_mode_ap
condition|)
name|wpa_driver_nl80211_set_mode
argument_list|(
name|bss
argument_list|,
name|NL80211_IFTYPE_STATION
argument_list|)
expr_stmt|;
name|nl80211_mgmt_unsubscribe
argument_list|(
name|bss
argument_list|,
literal|"deinit"
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|nl80211_mgmt_unsubscribe
argument_list|(
name|bss
argument_list|,
literal|"deinit"
argument_list|)
expr_stmt|;
name|nl80211_del_p2pdev
argument_list|(
name|bss
argument_list|)
expr_stmt|;
block|}
name|nl80211_destroy_bss
argument_list|(
name|drv
operator|->
name|first_bss
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|drv
operator|->
name|filter_ssids
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|drv
operator|->
name|auth_ie
argument_list|)
expr_stmt|;
if|if
condition|(
name|drv
operator|->
name|in_interface_list
condition|)
name|dl_list_del
argument_list|(
operator|&
name|drv
operator|->
name|list
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|drv
operator|->
name|extended_capa
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|drv
operator|->
name|extended_capa_mask
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|drv
operator|->
name|first_bss
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|drv
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|u32
name|wpa_alg_to_cipher_suite
parameter_list|(
name|enum
name|wpa_alg
name|alg
parameter_list|,
name|size_t
name|key_len
parameter_list|)
block|{
switch|switch
condition|(
name|alg
condition|)
block|{
case|case
name|WPA_ALG_WEP
case|:
if|if
condition|(
name|key_len
operator|==
literal|5
condition|)
return|return
name|WLAN_CIPHER_SUITE_WEP40
return|;
return|return
name|WLAN_CIPHER_SUITE_WEP104
return|;
case|case
name|WPA_ALG_TKIP
case|:
return|return
name|WLAN_CIPHER_SUITE_TKIP
return|;
case|case
name|WPA_ALG_CCMP
case|:
return|return
name|WLAN_CIPHER_SUITE_CCMP
return|;
case|case
name|WPA_ALG_GCMP
case|:
return|return
name|WLAN_CIPHER_SUITE_GCMP
return|;
case|case
name|WPA_ALG_CCMP_256
case|:
return|return
name|WLAN_CIPHER_SUITE_CCMP_256
return|;
case|case
name|WPA_ALG_GCMP_256
case|:
return|return
name|WLAN_CIPHER_SUITE_GCMP_256
return|;
case|case
name|WPA_ALG_IGTK
case|:
return|return
name|WLAN_CIPHER_SUITE_AES_CMAC
return|;
case|case
name|WPA_ALG_BIP_GMAC_128
case|:
return|return
name|WLAN_CIPHER_SUITE_BIP_GMAC_128
return|;
case|case
name|WPA_ALG_BIP_GMAC_256
case|:
return|return
name|WLAN_CIPHER_SUITE_BIP_GMAC_256
return|;
case|case
name|WPA_ALG_BIP_CMAC_256
case|:
return|return
name|WLAN_CIPHER_SUITE_BIP_CMAC_256
return|;
case|case
name|WPA_ALG_SMS4
case|:
return|return
name|WLAN_CIPHER_SUITE_SMS4
return|;
case|case
name|WPA_ALG_KRK
case|:
return|return
name|WLAN_CIPHER_SUITE_KRK
return|;
case|case
name|WPA_ALG_NONE
case|:
case|case
name|WPA_ALG_PMK
case|:
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"nl80211: Unexpected encryption algorithm %d"
argument_list|,
name|alg
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"nl80211: Unsupported encryption algorithm %d"
argument_list|,
name|alg
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|u32
name|wpa_cipher_to_cipher_suite
parameter_list|(
name|unsigned
name|int
name|cipher
parameter_list|)
block|{
switch|switch
condition|(
name|cipher
condition|)
block|{
case|case
name|WPA_CIPHER_CCMP_256
case|:
return|return
name|WLAN_CIPHER_SUITE_CCMP_256
return|;
case|case
name|WPA_CIPHER_GCMP_256
case|:
return|return
name|WLAN_CIPHER_SUITE_GCMP_256
return|;
case|case
name|WPA_CIPHER_CCMP
case|:
return|return
name|WLAN_CIPHER_SUITE_CCMP
return|;
case|case
name|WPA_CIPHER_GCMP
case|:
return|return
name|WLAN_CIPHER_SUITE_GCMP
return|;
case|case
name|WPA_CIPHER_TKIP
case|:
return|return
name|WLAN_CIPHER_SUITE_TKIP
return|;
case|case
name|WPA_CIPHER_WEP104
case|:
return|return
name|WLAN_CIPHER_SUITE_WEP104
return|;
case|case
name|WPA_CIPHER_WEP40
case|:
return|return
name|WLAN_CIPHER_SUITE_WEP40
return|;
case|case
name|WPA_CIPHER_GTK_NOT_USED
case|:
return|return
name|WLAN_CIPHER_SUITE_NO_GROUP_ADDR
return|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|wpa_cipher_to_cipher_suites
parameter_list|(
name|unsigned
name|int
name|ciphers
parameter_list|,
name|u32
name|suites
index|[]
parameter_list|,
name|int
name|max_suites
parameter_list|)
block|{
name|int
name|num_suites
init|=
literal|0
decl_stmt|;
if|if
condition|(
name|num_suites
operator|<
name|max_suites
operator|&&
name|ciphers
operator|&
name|WPA_CIPHER_CCMP_256
condition|)
name|suites
index|[
name|num_suites
operator|++
index|]
operator|=
name|WLAN_CIPHER_SUITE_CCMP_256
expr_stmt|;
if|if
condition|(
name|num_suites
operator|<
name|max_suites
operator|&&
name|ciphers
operator|&
name|WPA_CIPHER_GCMP_256
condition|)
name|suites
index|[
name|num_suites
operator|++
index|]
operator|=
name|WLAN_CIPHER_SUITE_GCMP_256
expr_stmt|;
if|if
condition|(
name|num_suites
operator|<
name|max_suites
operator|&&
name|ciphers
operator|&
name|WPA_CIPHER_CCMP
condition|)
name|suites
index|[
name|num_suites
operator|++
index|]
operator|=
name|WLAN_CIPHER_SUITE_CCMP
expr_stmt|;
if|if
condition|(
name|num_suites
operator|<
name|max_suites
operator|&&
name|ciphers
operator|&
name|WPA_CIPHER_GCMP
condition|)
name|suites
index|[
name|num_suites
operator|++
index|]
operator|=
name|WLAN_CIPHER_SUITE_GCMP
expr_stmt|;
if|if
condition|(
name|num_suites
operator|<
name|max_suites
operator|&&
name|ciphers
operator|&
name|WPA_CIPHER_TKIP
condition|)
name|suites
index|[
name|num_suites
operator|++
index|]
operator|=
name|WLAN_CIPHER_SUITE_TKIP
expr_stmt|;
if|if
condition|(
name|num_suites
operator|<
name|max_suites
operator|&&
name|ciphers
operator|&
name|WPA_CIPHER_WEP104
condition|)
name|suites
index|[
name|num_suites
operator|++
index|]
operator|=
name|WLAN_CIPHER_SUITE_WEP104
expr_stmt|;
if|if
condition|(
name|num_suites
operator|<
name|max_suites
operator|&&
name|ciphers
operator|&
name|WPA_CIPHER_WEP40
condition|)
name|suites
index|[
name|num_suites
operator|++
index|]
operator|=
name|WLAN_CIPHER_SUITE_WEP40
expr_stmt|;
return|return
name|num_suites
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|issue_key_mgmt_set_key
parameter_list|(
name|struct
name|wpa_driver_nl80211_data
modifier|*
name|drv
parameter_list|,
specifier|const
name|u8
modifier|*
name|key
parameter_list|,
name|size_t
name|key_len
parameter_list|)
block|{
name|struct
name|nl_msg
modifier|*
name|msg
decl_stmt|;
name|int
name|ret
decl_stmt|;
if|if
condition|(
operator|!
operator|(
name|drv
operator|->
name|capa
operator|.
name|flags
operator|&
name|WPA_DRIVER_FLAGS_KEY_MGMT_OFFLOAD
operator|)
condition|)
return|return
literal|0
return|;
if|if
condition|(
operator|!
operator|(
name|msg
operator|=
name|nl80211_drv_msg
argument_list|(
name|drv
argument_list|,
literal|0
argument_list|,
name|NL80211_CMD_VENDOR
argument_list|)
operator|)
operator|||
name|nla_put_u32
argument_list|(
name|msg
argument_list|,
name|NL80211_ATTR_VENDOR_ID
argument_list|,
name|OUI_QCA
argument_list|)
operator|||
name|nla_put_u32
argument_list|(
name|msg
argument_list|,
name|NL80211_ATTR_VENDOR_SUBCMD
argument_list|,
name|QCA_NL80211_VENDOR_SUBCMD_KEY_MGMT_SET_KEY
argument_list|)
operator|||
name|nla_put
argument_list|(
name|msg
argument_list|,
name|NL80211_ATTR_VENDOR_DATA
argument_list|,
name|key_len
argument_list|,
name|key
argument_list|)
condition|)
block|{
name|nl80211_nlmsg_clear
argument_list|(
name|msg
argument_list|)
expr_stmt|;
name|nlmsg_free
argument_list|(
name|msg
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|ret
operator|=
name|send_and_recv_msgs
argument_list|(
name|drv
argument_list|,
name|msg
argument_list|,
name|NULL
argument_list|,
operator|(
name|void
operator|*
operator|)
operator|-
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"nl80211: Key management set key failed: ret=%d (%s)"
argument_list|,
name|ret
argument_list|,
name|strerror
argument_list|(
operator|-
name|ret
argument_list|)
argument_list|)
expr_stmt|;
block|}
return|return
name|ret
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|wpa_driver_nl80211_set_key
parameter_list|(
specifier|const
name|char
modifier|*
name|ifname
parameter_list|,
name|struct
name|i802_bss
modifier|*
name|bss
parameter_list|,
name|enum
name|wpa_alg
name|alg
parameter_list|,
specifier|const
name|u8
modifier|*
name|addr
parameter_list|,
name|int
name|key_idx
parameter_list|,
name|int
name|set_tx
parameter_list|,
specifier|const
name|u8
modifier|*
name|seq
parameter_list|,
name|size_t
name|seq_len
parameter_list|,
specifier|const
name|u8
modifier|*
name|key
parameter_list|,
name|size_t
name|key_len
parameter_list|)
block|{
name|struct
name|wpa_driver_nl80211_data
modifier|*
name|drv
init|=
name|bss
operator|->
name|drv
decl_stmt|;
name|int
name|ifindex
decl_stmt|;
name|struct
name|nl_msg
modifier|*
name|msg
decl_stmt|;
name|int
name|ret
decl_stmt|;
name|int
name|tdls
init|=
literal|0
decl_stmt|;
comment|/* Ignore for P2P Device */
if|if
condition|(
name|drv
operator|->
name|nlmode
operator|==
name|NL80211_IFTYPE_P2P_DEVICE
condition|)
return|return
literal|0
return|;
name|ifindex
operator|=
name|if_nametoindex
argument_list|(
name|ifname
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"%s: ifindex=%d (%s) alg=%d addr=%p key_idx=%d "
literal|"set_tx=%d seq_len=%lu key_len=%lu"
argument_list|,
name|__func__
argument_list|,
name|ifindex
argument_list|,
name|ifname
argument_list|,
name|alg
argument_list|,
name|addr
argument_list|,
name|key_idx
argument_list|,
name|set_tx
argument_list|,
operator|(
name|unsigned
name|long
operator|)
name|seq_len
argument_list|,
operator|(
name|unsigned
name|long
operator|)
name|key_len
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|CONFIG_TDLS
if|if
condition|(
name|key_idx
operator|==
operator|-
literal|1
condition|)
block|{
name|key_idx
operator|=
literal|0
expr_stmt|;
name|tdls
operator|=
literal|1
expr_stmt|;
block|}
endif|#
directive|endif
comment|/* CONFIG_TDLS */
if|if
condition|(
name|alg
operator|==
name|WPA_ALG_PMK
operator|&&
operator|(
name|drv
operator|->
name|capa
operator|.
name|flags
operator|&
name|WPA_DRIVER_FLAGS_KEY_MGMT_OFFLOAD
operator|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"%s: calling issue_key_mgmt_set_key"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
name|ret
operator|=
name|issue_key_mgmt_set_key
argument_list|(
name|drv
argument_list|,
name|key
argument_list|,
name|key_len
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
if|if
condition|(
name|alg
operator|==
name|WPA_ALG_NONE
condition|)
block|{
name|msg
operator|=
name|nl80211_ifindex_msg
argument_list|(
name|drv
argument_list|,
name|ifindex
argument_list|,
literal|0
argument_list|,
name|NL80211_CMD_DEL_KEY
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|msg
condition|)
return|return
operator|-
name|ENOBUFS
return|;
block|}
else|else
block|{
name|msg
operator|=
name|nl80211_ifindex_msg
argument_list|(
name|drv
argument_list|,
name|ifindex
argument_list|,
literal|0
argument_list|,
name|NL80211_CMD_NEW_KEY
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|msg
operator|||
name|nla_put
argument_list|(
name|msg
argument_list|,
name|NL80211_ATTR_KEY_DATA
argument_list|,
name|key_len
argument_list|,
name|key
argument_list|)
operator|||
name|nla_put_u32
argument_list|(
name|msg
argument_list|,
name|NL80211_ATTR_KEY_CIPHER
argument_list|,
name|wpa_alg_to_cipher_suite
argument_list|(
name|alg
argument_list|,
name|key_len
argument_list|)
argument_list|)
condition|)
goto|goto
name|fail
goto|;
name|wpa_hexdump_key
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"nl80211: KEY_DATA"
argument_list|,
name|key
argument_list|,
name|key_len
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|seq
operator|&&
name|seq_len
condition|)
block|{
if|if
condition|(
name|nla_put
argument_list|(
name|msg
argument_list|,
name|NL80211_ATTR_KEY_SEQ
argument_list|,
name|seq_len
argument_list|,
name|seq
argument_list|)
condition|)
goto|goto
name|fail
goto|;
name|wpa_hexdump
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"nl80211: KEY_SEQ"
argument_list|,
name|seq
argument_list|,
name|seq_len
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|addr
operator|&&
operator|!
name|is_broadcast_ether_addr
argument_list|(
name|addr
argument_list|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"   addr="
name|MACSTR
argument_list|,
name|MAC2STR
argument_list|(
name|addr
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|nla_put
argument_list|(
name|msg
argument_list|,
name|NL80211_ATTR_MAC
argument_list|,
name|ETH_ALEN
argument_list|,
name|addr
argument_list|)
condition|)
goto|goto
name|fail
goto|;
if|if
condition|(
name|alg
operator|!=
name|WPA_ALG_WEP
operator|&&
name|key_idx
operator|&&
operator|!
name|set_tx
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"   RSN IBSS RX GTK"
argument_list|)
expr_stmt|;
if|if
condition|(
name|nla_put_u32
argument_list|(
name|msg
argument_list|,
name|NL80211_ATTR_KEY_TYPE
argument_list|,
name|NL80211_KEYTYPE_GROUP
argument_list|)
condition|)
goto|goto
name|fail
goto|;
block|}
block|}
elseif|else
if|if
condition|(
name|addr
operator|&&
name|is_broadcast_ether_addr
argument_list|(
name|addr
argument_list|)
condition|)
block|{
name|struct
name|nlattr
modifier|*
name|types
decl_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"   broadcast key"
argument_list|)
expr_stmt|;
name|types
operator|=
name|nla_nest_start
argument_list|(
name|msg
argument_list|,
name|NL80211_ATTR_KEY_DEFAULT_TYPES
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|types
operator|||
name|nla_put_flag
argument_list|(
name|msg
argument_list|,
name|NL80211_KEY_DEFAULT_TYPE_MULTICAST
argument_list|)
condition|)
goto|goto
name|fail
goto|;
name|nla_nest_end
argument_list|(
name|msg
argument_list|,
name|types
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|nla_put_u8
argument_list|(
name|msg
argument_list|,
name|NL80211_ATTR_KEY_IDX
argument_list|,
name|key_idx
argument_list|)
condition|)
goto|goto
name|fail
goto|;
name|ret
operator|=
name|send_and_recv_msgs
argument_list|(
name|drv
argument_list|,
name|msg
argument_list|,
name|NULL
argument_list|,
name|key
condition|?
operator|(
name|void
operator|*
operator|)
operator|-
literal|1
else|:
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|ret
operator|==
operator|-
name|ENOENT
operator|||
name|ret
operator|==
operator|-
name|ENOLINK
operator|)
operator|&&
name|alg
operator|==
name|WPA_ALG_NONE
condition|)
name|ret
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|ret
condition|)
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"nl80211: set_key failed; err=%d %s)"
argument_list|,
name|ret
argument_list|,
name|strerror
argument_list|(
operator|-
name|ret
argument_list|)
argument_list|)
expr_stmt|;
comment|/* 	 * If we failed or don't need to set the default TX key (below), 	 * we're done here. 	 */
if|if
condition|(
name|ret
operator|||
operator|!
name|set_tx
operator|||
name|alg
operator|==
name|WPA_ALG_NONE
operator|||
name|tdls
condition|)
return|return
name|ret
return|;
if|if
condition|(
name|is_ap_interface
argument_list|(
name|drv
operator|->
name|nlmode
argument_list|)
operator|&&
name|addr
operator|&&
operator|!
name|is_broadcast_ether_addr
argument_list|(
name|addr
argument_list|)
condition|)
return|return
name|ret
return|;
name|msg
operator|=
name|nl80211_ifindex_msg
argument_list|(
name|drv
argument_list|,
name|ifindex
argument_list|,
literal|0
argument_list|,
name|NL80211_CMD_SET_KEY
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|msg
operator|||
name|nla_put_u8
argument_list|(
name|msg
argument_list|,
name|NL80211_ATTR_KEY_IDX
argument_list|,
name|key_idx
argument_list|)
operator|||
name|nla_put_flag
argument_list|(
name|msg
argument_list|,
operator|(
name|alg
operator|==
name|WPA_ALG_IGTK
operator|||
name|alg
operator|==
name|WPA_ALG_BIP_GMAC_128
operator|||
name|alg
operator|==
name|WPA_ALG_BIP_GMAC_256
operator|||
name|alg
operator|==
name|WPA_ALG_BIP_CMAC_256
operator|)
condition|?
name|NL80211_ATTR_KEY_DEFAULT_MGMT
else|:
name|NL80211_ATTR_KEY_DEFAULT
argument_list|)
condition|)
goto|goto
name|fail
goto|;
if|if
condition|(
name|addr
operator|&&
name|is_broadcast_ether_addr
argument_list|(
name|addr
argument_list|)
condition|)
block|{
name|struct
name|nlattr
modifier|*
name|types
decl_stmt|;
name|types
operator|=
name|nla_nest_start
argument_list|(
name|msg
argument_list|,
name|NL80211_ATTR_KEY_DEFAULT_TYPES
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|types
operator|||
name|nla_put_flag
argument_list|(
name|msg
argument_list|,
name|NL80211_KEY_DEFAULT_TYPE_MULTICAST
argument_list|)
condition|)
goto|goto
name|fail
goto|;
name|nla_nest_end
argument_list|(
name|msg
argument_list|,
name|types
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|addr
condition|)
block|{
name|struct
name|nlattr
modifier|*
name|types
decl_stmt|;
name|types
operator|=
name|nla_nest_start
argument_list|(
name|msg
argument_list|,
name|NL80211_ATTR_KEY_DEFAULT_TYPES
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|types
operator|||
name|nla_put_flag
argument_list|(
name|msg
argument_list|,
name|NL80211_KEY_DEFAULT_TYPE_UNICAST
argument_list|)
condition|)
goto|goto
name|fail
goto|;
name|nla_nest_end
argument_list|(
name|msg
argument_list|,
name|types
argument_list|)
expr_stmt|;
block|}
name|ret
operator|=
name|send_and_recv_msgs
argument_list|(
name|drv
argument_list|,
name|msg
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|==
operator|-
name|ENOENT
condition|)
name|ret
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|ret
condition|)
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"nl80211: set_key default failed; "
literal|"err=%d %s)"
argument_list|,
name|ret
argument_list|,
name|strerror
argument_list|(
operator|-
name|ret
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
name|fail
label|:
name|nl80211_nlmsg_clear
argument_list|(
name|msg
argument_list|)
expr_stmt|;
name|nlmsg_free
argument_list|(
name|msg
argument_list|)
expr_stmt|;
return|return
operator|-
name|ENOBUFS
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|nl_add_key
parameter_list|(
name|struct
name|nl_msg
modifier|*
name|msg
parameter_list|,
name|enum
name|wpa_alg
name|alg
parameter_list|,
name|int
name|key_idx
parameter_list|,
name|int
name|defkey
parameter_list|,
specifier|const
name|u8
modifier|*
name|seq
parameter_list|,
name|size_t
name|seq_len
parameter_list|,
specifier|const
name|u8
modifier|*
name|key
parameter_list|,
name|size_t
name|key_len
parameter_list|)
block|{
name|struct
name|nlattr
modifier|*
name|key_attr
init|=
name|nla_nest_start
argument_list|(
name|msg
argument_list|,
name|NL80211_ATTR_KEY
argument_list|)
decl_stmt|;
if|if
condition|(
operator|!
name|key_attr
condition|)
return|return
operator|-
literal|1
return|;
if|if
condition|(
name|defkey
operator|&&
name|alg
operator|==
name|WPA_ALG_IGTK
condition|)
block|{
if|if
condition|(
name|nla_put_flag
argument_list|(
name|msg
argument_list|,
name|NL80211_KEY_DEFAULT_MGMT
argument_list|)
condition|)
return|return
operator|-
literal|1
return|;
block|}
elseif|else
if|if
condition|(
name|defkey
condition|)
block|{
if|if
condition|(
name|nla_put_flag
argument_list|(
name|msg
argument_list|,
name|NL80211_KEY_DEFAULT
argument_list|)
condition|)
return|return
operator|-
literal|1
return|;
block|}
if|if
condition|(
name|nla_put_u8
argument_list|(
name|msg
argument_list|,
name|NL80211_KEY_IDX
argument_list|,
name|key_idx
argument_list|)
operator|||
name|nla_put_u32
argument_list|(
name|msg
argument_list|,
name|NL80211_KEY_CIPHER
argument_list|,
name|wpa_alg_to_cipher_suite
argument_list|(
name|alg
argument_list|,
name|key_len
argument_list|)
argument_list|)
operator|||
operator|(
name|seq
operator|&&
name|seq_len
operator|&&
name|nla_put
argument_list|(
name|msg
argument_list|,
name|NL80211_KEY_SEQ
argument_list|,
name|seq_len
argument_list|,
name|seq
argument_list|)
operator|)
operator|||
name|nla_put
argument_list|(
name|msg
argument_list|,
name|NL80211_KEY_DATA
argument_list|,
name|key_len
argument_list|,
name|key
argument_list|)
condition|)
return|return
operator|-
literal|1
return|;
name|nla_nest_end
argument_list|(
name|msg
argument_list|,
name|key_attr
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|nl80211_set_conn_keys
parameter_list|(
name|struct
name|wpa_driver_associate_params
modifier|*
name|params
parameter_list|,
name|struct
name|nl_msg
modifier|*
name|msg
parameter_list|)
block|{
name|int
name|i
decl_stmt|,
name|privacy
init|=
literal|0
decl_stmt|;
name|struct
name|nlattr
modifier|*
name|nl_keys
decl_stmt|,
modifier|*
name|nl_key
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|4
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
operator|!
name|params
operator|->
name|wep_key
index|[
name|i
index|]
condition|)
continue|continue;
name|privacy
operator|=
literal|1
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|params
operator|->
name|wps
operator|==
name|WPS_MODE_PRIVACY
condition|)
name|privacy
operator|=
literal|1
expr_stmt|;
if|if
condition|(
name|params
operator|->
name|pairwise_suite
operator|&&
name|params
operator|->
name|pairwise_suite
operator|!=
name|WPA_CIPHER_NONE
condition|)
name|privacy
operator|=
literal|1
expr_stmt|;
if|if
condition|(
operator|!
name|privacy
condition|)
return|return
literal|0
return|;
if|if
condition|(
name|nla_put_flag
argument_list|(
name|msg
argument_list|,
name|NL80211_ATTR_PRIVACY
argument_list|)
condition|)
return|return
operator|-
name|ENOBUFS
return|;
name|nl_keys
operator|=
name|nla_nest_start
argument_list|(
name|msg
argument_list|,
name|NL80211_ATTR_KEYS
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|nl_keys
condition|)
return|return
operator|-
name|ENOBUFS
return|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|4
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
operator|!
name|params
operator|->
name|wep_key
index|[
name|i
index|]
condition|)
continue|continue;
name|nl_key
operator|=
name|nla_nest_start
argument_list|(
name|msg
argument_list|,
name|i
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|nl_key
operator|||
name|nla_put
argument_list|(
name|msg
argument_list|,
name|NL80211_KEY_DATA
argument_list|,
name|params
operator|->
name|wep_key_len
index|[
name|i
index|]
argument_list|,
name|params
operator|->
name|wep_key
index|[
name|i
index|]
argument_list|)
operator|||
name|nla_put_u32
argument_list|(
name|msg
argument_list|,
name|NL80211_KEY_CIPHER
argument_list|,
name|params
operator|->
name|wep_key_len
index|[
name|i
index|]
operator|==
literal|5
condition|?
name|WLAN_CIPHER_SUITE_WEP40
else|:
name|WLAN_CIPHER_SUITE_WEP104
argument_list|)
operator|||
name|nla_put_u8
argument_list|(
name|msg
argument_list|,
name|NL80211_KEY_IDX
argument_list|,
name|i
argument_list|)
operator|||
operator|(
name|i
operator|==
name|params
operator|->
name|wep_tx_keyidx
operator|&&
name|nla_put_flag
argument_list|(
name|msg
argument_list|,
name|NL80211_KEY_DEFAULT
argument_list|)
operator|)
condition|)
return|return
operator|-
name|ENOBUFS
return|;
name|nla_nest_end
argument_list|(
name|msg
argument_list|,
name|nl_key
argument_list|)
expr_stmt|;
block|}
name|nla_nest_end
argument_list|(
name|msg
argument_list|,
name|nl_keys
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|int
name|wpa_driver_nl80211_mlme
parameter_list|(
name|struct
name|wpa_driver_nl80211_data
modifier|*
name|drv
parameter_list|,
specifier|const
name|u8
modifier|*
name|addr
parameter_list|,
name|int
name|cmd
parameter_list|,
name|u16
name|reason_code
parameter_list|,
name|int
name|local_state_change
parameter_list|)
block|{
name|int
name|ret
decl_stmt|;
name|struct
name|nl_msg
modifier|*
name|msg
decl_stmt|;
if|if
condition|(
operator|!
operator|(
name|msg
operator|=
name|nl80211_drv_msg
argument_list|(
name|drv
argument_list|,
literal|0
argument_list|,
name|cmd
argument_list|)
operator|)
operator|||
name|nla_put_u16
argument_list|(
name|msg
argument_list|,
name|NL80211_ATTR_REASON_CODE
argument_list|,
name|reason_code
argument_list|)
operator|||
operator|(
name|addr
operator|&&
name|nla_put
argument_list|(
name|msg
argument_list|,
name|NL80211_ATTR_MAC
argument_list|,
name|ETH_ALEN
argument_list|,
name|addr
argument_list|)
operator|)
operator|||
operator|(
name|local_state_change
operator|&&
name|nla_put_flag
argument_list|(
name|msg
argument_list|,
name|NL80211_ATTR_LOCAL_STATE_CHANGE
argument_list|)
operator|)
condition|)
block|{
name|nlmsg_free
argument_list|(
name|msg
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|ret
operator|=
name|send_and_recv_msgs
argument_list|(
name|drv
argument_list|,
name|msg
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|wpa_dbg
argument_list|(
name|drv
operator|->
name|ctx
argument_list|,
name|MSG_DEBUG
argument_list|,
literal|"nl80211: MLME command failed: reason=%u ret=%d (%s)"
argument_list|,
name|reason_code
argument_list|,
name|ret
argument_list|,
name|strerror
argument_list|(
operator|-
name|ret
argument_list|)
argument_list|)
expr_stmt|;
block|}
return|return
name|ret
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|wpa_driver_nl80211_disconnect
parameter_list|(
name|struct
name|wpa_driver_nl80211_data
modifier|*
name|drv
parameter_list|,
name|int
name|reason_code
parameter_list|)
block|{
name|int
name|ret
decl_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"%s(reason_code=%d)"
argument_list|,
name|__func__
argument_list|,
name|reason_code
argument_list|)
expr_stmt|;
name|nl80211_mark_disconnected
argument_list|(
name|drv
argument_list|)
expr_stmt|;
comment|/* Disconnect command doesn't need BSSID - it uses cached value */
name|ret
operator|=
name|wpa_driver_nl80211_mlme
argument_list|(
name|drv
argument_list|,
name|NULL
argument_list|,
name|NL80211_CMD_DISCONNECT
argument_list|,
name|reason_code
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* 	 * For locally generated disconnect, supplicant already generates a 	 * DEAUTH event, so ignore the event from NL80211. 	 */
name|drv
operator|->
name|ignore_next_local_disconnect
operator|=
name|ret
operator|==
literal|0
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|wpa_driver_nl80211_deauthenticate
parameter_list|(
name|struct
name|i802_bss
modifier|*
name|bss
parameter_list|,
specifier|const
name|u8
modifier|*
name|addr
parameter_list|,
name|int
name|reason_code
parameter_list|)
block|{
name|struct
name|wpa_driver_nl80211_data
modifier|*
name|drv
init|=
name|bss
operator|->
name|drv
decl_stmt|;
name|int
name|ret
decl_stmt|;
if|if
condition|(
name|drv
operator|->
name|nlmode
operator|==
name|NL80211_IFTYPE_ADHOC
condition|)
block|{
name|nl80211_mark_disconnected
argument_list|(
name|drv
argument_list|)
expr_stmt|;
return|return
name|nl80211_leave_ibss
argument_list|(
name|drv
argument_list|,
literal|1
argument_list|)
return|;
block|}
if|if
condition|(
operator|!
operator|(
name|drv
operator|->
name|capa
operator|.
name|flags
operator|&
name|WPA_DRIVER_FLAGS_SME
operator|)
condition|)
return|return
name|wpa_driver_nl80211_disconnect
argument_list|(
name|drv
argument_list|,
name|reason_code
argument_list|)
return|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"%s(addr="
name|MACSTR
literal|" reason_code=%d)"
argument_list|,
name|__func__
argument_list|,
name|MAC2STR
argument_list|(
name|addr
argument_list|)
argument_list|,
name|reason_code
argument_list|)
expr_stmt|;
name|nl80211_mark_disconnected
argument_list|(
name|drv
argument_list|)
expr_stmt|;
name|ret
operator|=
name|wpa_driver_nl80211_mlme
argument_list|(
name|drv
argument_list|,
name|addr
argument_list|,
name|NL80211_CMD_DEAUTHENTICATE
argument_list|,
name|reason_code
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* 	 * For locally generated deauthenticate, supplicant already generates a 	 * DEAUTH event, so ignore the event from NL80211. 	 */
name|drv
operator|->
name|ignore_next_local_deauth
operator|=
name|ret
operator|==
literal|0
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|nl80211_copy_auth_params
parameter_list|(
name|struct
name|wpa_driver_nl80211_data
modifier|*
name|drv
parameter_list|,
name|struct
name|wpa_driver_auth_params
modifier|*
name|params
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
name|drv
operator|->
name|auth_freq
operator|=
name|params
operator|->
name|freq
expr_stmt|;
name|drv
operator|->
name|auth_alg
operator|=
name|params
operator|->
name|auth_alg
expr_stmt|;
name|drv
operator|->
name|auth_wep_tx_keyidx
operator|=
name|params
operator|->
name|wep_tx_keyidx
expr_stmt|;
name|drv
operator|->
name|auth_local_state_change
operator|=
name|params
operator|->
name|local_state_change
expr_stmt|;
name|drv
operator|->
name|auth_p2p
operator|=
name|params
operator|->
name|p2p
expr_stmt|;
if|if
condition|(
name|params
operator|->
name|bssid
condition|)
name|os_memcpy
argument_list|(
name|drv
operator|->
name|auth_bssid_
argument_list|,
name|params
operator|->
name|bssid
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
else|else
name|os_memset
argument_list|(
name|drv
operator|->
name|auth_bssid_
argument_list|,
literal|0
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
if|if
condition|(
name|params
operator|->
name|ssid
condition|)
block|{
name|os_memcpy
argument_list|(
name|drv
operator|->
name|auth_ssid
argument_list|,
name|params
operator|->
name|ssid
argument_list|,
name|params
operator|->
name|ssid_len
argument_list|)
expr_stmt|;
name|drv
operator|->
name|auth_ssid_len
operator|=
name|params
operator|->
name|ssid_len
expr_stmt|;
block|}
else|else
name|drv
operator|->
name|auth_ssid_len
operator|=
literal|0
expr_stmt|;
name|os_free
argument_list|(
name|drv
operator|->
name|auth_ie
argument_list|)
expr_stmt|;
name|drv
operator|->
name|auth_ie
operator|=
name|NULL
expr_stmt|;
name|drv
operator|->
name|auth_ie_len
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|params
operator|->
name|ie
condition|)
block|{
name|drv
operator|->
name|auth_ie
operator|=
name|os_malloc
argument_list|(
name|params
operator|->
name|ie_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|drv
operator|->
name|auth_ie
condition|)
block|{
name|os_memcpy
argument_list|(
name|drv
operator|->
name|auth_ie
argument_list|,
name|params
operator|->
name|ie
argument_list|,
name|params
operator|->
name|ie_len
argument_list|)
expr_stmt|;
name|drv
operator|->
name|auth_ie_len
operator|=
name|params
operator|->
name|ie_len
expr_stmt|;
block|}
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|4
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|params
operator|->
name|wep_key
index|[
name|i
index|]
operator|&&
name|params
operator|->
name|wep_key_len
index|[
name|i
index|]
operator|&&
name|params
operator|->
name|wep_key_len
index|[
name|i
index|]
operator|<=
literal|16
condition|)
block|{
name|os_memcpy
argument_list|(
name|drv
operator|->
name|auth_wep_key
index|[
name|i
index|]
argument_list|,
name|params
operator|->
name|wep_key
index|[
name|i
index|]
argument_list|,
name|params
operator|->
name|wep_key_len
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|drv
operator|->
name|auth_wep_key_len
index|[
name|i
index|]
operator|=
name|params
operator|->
name|wep_key_len
index|[
name|i
index|]
expr_stmt|;
block|}
else|else
name|drv
operator|->
name|auth_wep_key_len
index|[
name|i
index|]
operator|=
literal|0
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|nl80211_unmask_11b_rates
parameter_list|(
name|struct
name|i802_bss
modifier|*
name|bss
parameter_list|)
block|{
name|struct
name|wpa_driver_nl80211_data
modifier|*
name|drv
init|=
name|bss
operator|->
name|drv
decl_stmt|;
if|if
condition|(
name|is_p2p_net_interface
argument_list|(
name|drv
operator|->
name|nlmode
argument_list|)
operator|||
operator|!
name|drv
operator|->
name|disabled_11b_rates
condition|)
return|return;
comment|/* 	 * Looks like we failed to unmask 11b rates previously. This could 	 * happen, e.g., if the interface was down at the point in time when a 	 * P2P group was terminated. 	 */
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"nl80211: Interface %s mode is for non-P2P, but 11b rates were disabled - re-enable them"
argument_list|,
name|bss
operator|->
name|ifname
argument_list|)
expr_stmt|;
name|nl80211_disable_11b_rates
argument_list|(
name|drv
argument_list|,
name|drv
operator|->
name|ifindex
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|wpa_driver_nl80211_authenticate
parameter_list|(
name|struct
name|i802_bss
modifier|*
name|bss
parameter_list|,
name|struct
name|wpa_driver_auth_params
modifier|*
name|params
parameter_list|)
block|{
name|struct
name|wpa_driver_nl80211_data
modifier|*
name|drv
init|=
name|bss
operator|->
name|drv
decl_stmt|;
name|int
name|ret
init|=
operator|-
literal|1
decl_stmt|,
name|i
decl_stmt|;
name|struct
name|nl_msg
modifier|*
name|msg
decl_stmt|;
name|enum
name|nl80211_auth_type
name|type
decl_stmt|;
name|enum
name|nl80211_iftype
name|nlmode
decl_stmt|;
name|int
name|count
init|=
literal|0
decl_stmt|;
name|int
name|is_retry
decl_stmt|;
name|nl80211_unmask_11b_rates
argument_list|(
name|bss
argument_list|)
expr_stmt|;
name|is_retry
operator|=
name|drv
operator|->
name|retry_auth
expr_stmt|;
name|drv
operator|->
name|retry_auth
operator|=
literal|0
expr_stmt|;
name|drv
operator|->
name|ignore_deauth_event
operator|=
literal|0
expr_stmt|;
name|nl80211_mark_disconnected
argument_list|(
name|drv
argument_list|)
expr_stmt|;
name|os_memset
argument_list|(
name|drv
operator|->
name|auth_bssid
argument_list|,
literal|0
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
if|if
condition|(
name|params
operator|->
name|bssid
condition|)
name|os_memcpy
argument_list|(
name|drv
operator|->
name|auth_attempt_bssid
argument_list|,
name|params
operator|->
name|bssid
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
else|else
name|os_memset
argument_list|(
name|drv
operator|->
name|auth_attempt_bssid
argument_list|,
literal|0
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
comment|/* FIX: IBSS mode */
name|nlmode
operator|=
name|params
operator|->
name|p2p
condition|?
name|NL80211_IFTYPE_P2P_CLIENT
else|:
name|NL80211_IFTYPE_STATION
expr_stmt|;
if|if
condition|(
name|drv
operator|->
name|nlmode
operator|!=
name|nlmode
operator|&&
name|wpa_driver_nl80211_set_mode
argument_list|(
name|bss
argument_list|,
name|nlmode
argument_list|)
operator|<
literal|0
condition|)
return|return
operator|-
literal|1
return|;
name|retry
label|:
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"nl80211: Authenticate (ifindex=%d)"
argument_list|,
name|drv
operator|->
name|ifindex
argument_list|)
expr_stmt|;
name|msg
operator|=
name|nl80211_drv_msg
argument_list|(
name|drv
argument_list|,
literal|0
argument_list|,
name|NL80211_CMD_AUTHENTICATE
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|msg
condition|)
goto|goto
name|fail
goto|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|4
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
operator|!
name|params
operator|->
name|wep_key
index|[
name|i
index|]
condition|)
continue|continue;
name|wpa_driver_nl80211_set_key
argument_list|(
name|bss
operator|->
name|ifname
argument_list|,
name|bss
argument_list|,
name|WPA_ALG_WEP
argument_list|,
name|NULL
argument_list|,
name|i
argument_list|,
name|i
operator|==
name|params
operator|->
name|wep_tx_keyidx
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|,
name|params
operator|->
name|wep_key
index|[
name|i
index|]
argument_list|,
name|params
operator|->
name|wep_key_len
index|[
name|i
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|params
operator|->
name|wep_tx_keyidx
operator|!=
name|i
condition|)
continue|continue;
if|if
condition|(
name|nl_add_key
argument_list|(
name|msg
argument_list|,
name|WPA_ALG_WEP
argument_list|,
name|i
argument_list|,
literal|1
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|,
name|params
operator|->
name|wep_key
index|[
name|i
index|]
argument_list|,
name|params
operator|->
name|wep_key_len
index|[
name|i
index|]
argument_list|)
condition|)
goto|goto
name|fail
goto|;
block|}
if|if
condition|(
name|params
operator|->
name|bssid
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"  * bssid="
name|MACSTR
argument_list|,
name|MAC2STR
argument_list|(
name|params
operator|->
name|bssid
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|nla_put
argument_list|(
name|msg
argument_list|,
name|NL80211_ATTR_MAC
argument_list|,
name|ETH_ALEN
argument_list|,
name|params
operator|->
name|bssid
argument_list|)
condition|)
goto|goto
name|fail
goto|;
block|}
if|if
condition|(
name|params
operator|->
name|freq
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"  * freq=%d"
argument_list|,
name|params
operator|->
name|freq
argument_list|)
expr_stmt|;
if|if
condition|(
name|nla_put_u32
argument_list|(
name|msg
argument_list|,
name|NL80211_ATTR_WIPHY_FREQ
argument_list|,
name|params
operator|->
name|freq
argument_list|)
condition|)
goto|goto
name|fail
goto|;
block|}
if|if
condition|(
name|params
operator|->
name|ssid
condition|)
block|{
name|wpa_hexdump_ascii
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"  * SSID"
argument_list|,
name|params
operator|->
name|ssid
argument_list|,
name|params
operator|->
name|ssid_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|nla_put
argument_list|(
name|msg
argument_list|,
name|NL80211_ATTR_SSID
argument_list|,
name|params
operator|->
name|ssid_len
argument_list|,
name|params
operator|->
name|ssid
argument_list|)
condition|)
goto|goto
name|fail
goto|;
block|}
name|wpa_hexdump
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"  * IEs"
argument_list|,
name|params
operator|->
name|ie
argument_list|,
name|params
operator|->
name|ie_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|params
operator|->
name|ie
operator|&&
name|nla_put
argument_list|(
name|msg
argument_list|,
name|NL80211_ATTR_IE
argument_list|,
name|params
operator|->
name|ie_len
argument_list|,
name|params
operator|->
name|ie
argument_list|)
condition|)
goto|goto
name|fail
goto|;
if|if
condition|(
name|params
operator|->
name|sae_data
condition|)
block|{
name|wpa_hexdump
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"  * SAE data"
argument_list|,
name|params
operator|->
name|sae_data
argument_list|,
name|params
operator|->
name|sae_data_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|nla_put
argument_list|(
name|msg
argument_list|,
name|NL80211_ATTR_SAE_DATA
argument_list|,
name|params
operator|->
name|sae_data_len
argument_list|,
name|params
operator|->
name|sae_data
argument_list|)
condition|)
goto|goto
name|fail
goto|;
block|}
if|if
condition|(
name|params
operator|->
name|auth_alg
operator|&
name|WPA_AUTH_ALG_OPEN
condition|)
name|type
operator|=
name|NL80211_AUTHTYPE_OPEN_SYSTEM
expr_stmt|;
elseif|else
if|if
condition|(
name|params
operator|->
name|auth_alg
operator|&
name|WPA_AUTH_ALG_SHARED
condition|)
name|type
operator|=
name|NL80211_AUTHTYPE_SHARED_KEY
expr_stmt|;
elseif|else
if|if
condition|(
name|params
operator|->
name|auth_alg
operator|&
name|WPA_AUTH_ALG_LEAP
condition|)
name|type
operator|=
name|NL80211_AUTHTYPE_NETWORK_EAP
expr_stmt|;
elseif|else
if|if
condition|(
name|params
operator|->
name|auth_alg
operator|&
name|WPA_AUTH_ALG_FT
condition|)
name|type
operator|=
name|NL80211_AUTHTYPE_FT
expr_stmt|;
elseif|else
if|if
condition|(
name|params
operator|->
name|auth_alg
operator|&
name|WPA_AUTH_ALG_SAE
condition|)
name|type
operator|=
name|NL80211_AUTHTYPE_SAE
expr_stmt|;
else|else
goto|goto
name|fail
goto|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"  * Auth Type %d"
argument_list|,
name|type
argument_list|)
expr_stmt|;
if|if
condition|(
name|nla_put_u32
argument_list|(
name|msg
argument_list|,
name|NL80211_ATTR_AUTH_TYPE
argument_list|,
name|type
argument_list|)
condition|)
goto|goto
name|fail
goto|;
if|if
condition|(
name|params
operator|->
name|local_state_change
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"  * Local state change only"
argument_list|)
expr_stmt|;
if|if
condition|(
name|nla_put_flag
argument_list|(
name|msg
argument_list|,
name|NL80211_ATTR_LOCAL_STATE_CHANGE
argument_list|)
condition|)
goto|goto
name|fail
goto|;
block|}
name|ret
operator|=
name|send_and_recv_msgs
argument_list|(
name|drv
argument_list|,
name|msg
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|msg
operator|=
name|NULL
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|wpa_dbg
argument_list|(
name|drv
operator|->
name|ctx
argument_list|,
name|MSG_DEBUG
argument_list|,
literal|"nl80211: MLME command failed (auth): ret=%d (%s)"
argument_list|,
name|ret
argument_list|,
name|strerror
argument_list|(
operator|-
name|ret
argument_list|)
argument_list|)
expr_stmt|;
name|count
operator|++
expr_stmt|;
if|if
condition|(
name|ret
operator|==
operator|-
name|EALREADY
operator|&&
name|count
operator|==
literal|1
operator|&&
name|params
operator|->
name|bssid
operator|&&
operator|!
name|params
operator|->
name|local_state_change
condition|)
block|{
comment|/* 			 * mac80211 does not currently accept new 			 * authentication if we are already authenticated. As a 			 * workaround, force deauthentication and try again. 			 */
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"nl80211: Retry authentication "
literal|"after forced deauthentication"
argument_list|)
expr_stmt|;
name|drv
operator|->
name|ignore_deauth_event
operator|=
literal|1
expr_stmt|;
name|wpa_driver_nl80211_deauthenticate
argument_list|(
name|bss
argument_list|,
name|params
operator|->
name|bssid
argument_list|,
name|WLAN_REASON_PREV_AUTH_NOT_VALID
argument_list|)
expr_stmt|;
name|nlmsg_free
argument_list|(
name|msg
argument_list|)
expr_stmt|;
goto|goto
name|retry
goto|;
block|}
if|if
condition|(
name|ret
operator|==
operator|-
name|ENOENT
operator|&&
name|params
operator|->
name|freq
operator|&&
operator|!
name|is_retry
condition|)
block|{
comment|/* 			 * cfg80211 has likely expired the BSS entry even 			 * though it was previously available in our internal 			 * BSS table. To recover quickly, start a single 			 * channel scan on the specified channel. 			 */
name|struct
name|wpa_driver_scan_params
name|scan
decl_stmt|;
name|int
name|freqs
index|[
literal|2
index|]
decl_stmt|;
name|os_memset
argument_list|(
operator|&
name|scan
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|scan
argument_list|)
argument_list|)
expr_stmt|;
name|scan
operator|.
name|num_ssids
operator|=
literal|1
expr_stmt|;
if|if
condition|(
name|params
operator|->
name|ssid
condition|)
block|{
name|scan
operator|.
name|ssids
index|[
literal|0
index|]
operator|.
name|ssid
operator|=
name|params
operator|->
name|ssid
expr_stmt|;
name|scan
operator|.
name|ssids
index|[
literal|0
index|]
operator|.
name|ssid_len
operator|=
name|params
operator|->
name|ssid_len
expr_stmt|;
block|}
name|freqs
index|[
literal|0
index|]
operator|=
name|params
operator|->
name|freq
expr_stmt|;
name|freqs
index|[
literal|1
index|]
operator|=
literal|0
expr_stmt|;
name|scan
operator|.
name|freqs
operator|=
name|freqs
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"nl80211: Trigger single "
literal|"channel scan to refresh cfg80211 BSS "
literal|"entry"
argument_list|)
expr_stmt|;
name|ret
operator|=
name|wpa_driver_nl80211_scan
argument_list|(
name|bss
argument_list|,
operator|&
name|scan
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|==
literal|0
condition|)
block|{
name|nl80211_copy_auth_params
argument_list|(
name|drv
argument_list|,
name|params
argument_list|)
expr_stmt|;
name|drv
operator|->
name|scan_for_auth
operator|=
literal|1
expr_stmt|;
block|}
block|}
elseif|else
if|if
condition|(
name|is_retry
condition|)
block|{
comment|/* 			 * Need to indicate this with an event since the return 			 * value from the retry is not delivered to core code. 			 */
name|union
name|wpa_event_data
name|event
decl_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"nl80211: Authentication retry "
literal|"failed"
argument_list|)
expr_stmt|;
name|os_memset
argument_list|(
operator|&
name|event
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|event
argument_list|)
argument_list|)
expr_stmt|;
name|os_memcpy
argument_list|(
name|event
operator|.
name|timeout_event
operator|.
name|addr
argument_list|,
name|drv
operator|->
name|auth_bssid_
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
name|wpa_supplicant_event
argument_list|(
name|drv
operator|->
name|ctx
argument_list|,
name|EVENT_AUTH_TIMED_OUT
argument_list|,
operator|&
name|event
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"nl80211: Authentication request send successfully"
argument_list|)
expr_stmt|;
block|}
name|fail
label|:
name|nlmsg_free
argument_list|(
name|msg
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_function
name|int
name|wpa_driver_nl80211_authenticate_retry
parameter_list|(
name|struct
name|wpa_driver_nl80211_data
modifier|*
name|drv
parameter_list|)
block|{
name|struct
name|wpa_driver_auth_params
name|params
decl_stmt|;
name|struct
name|i802_bss
modifier|*
name|bss
init|=
name|drv
operator|->
name|first_bss
decl_stmt|;
name|int
name|i
decl_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"nl80211: Try to authenticate again"
argument_list|)
expr_stmt|;
name|os_memset
argument_list|(
operator|&
name|params
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|params
argument_list|)
argument_list|)
expr_stmt|;
name|params
operator|.
name|freq
operator|=
name|drv
operator|->
name|auth_freq
expr_stmt|;
name|params
operator|.
name|auth_alg
operator|=
name|drv
operator|->
name|auth_alg
expr_stmt|;
name|params
operator|.
name|wep_tx_keyidx
operator|=
name|drv
operator|->
name|auth_wep_tx_keyidx
expr_stmt|;
name|params
operator|.
name|local_state_change
operator|=
name|drv
operator|->
name|auth_local_state_change
expr_stmt|;
name|params
operator|.
name|p2p
operator|=
name|drv
operator|->
name|auth_p2p
expr_stmt|;
if|if
condition|(
operator|!
name|is_zero_ether_addr
argument_list|(
name|drv
operator|->
name|auth_bssid_
argument_list|)
condition|)
name|params
operator|.
name|bssid
operator|=
name|drv
operator|->
name|auth_bssid_
expr_stmt|;
if|if
condition|(
name|drv
operator|->
name|auth_ssid_len
condition|)
block|{
name|params
operator|.
name|ssid
operator|=
name|drv
operator|->
name|auth_ssid
expr_stmt|;
name|params
operator|.
name|ssid_len
operator|=
name|drv
operator|->
name|auth_ssid_len
expr_stmt|;
block|}
name|params
operator|.
name|ie
operator|=
name|drv
operator|->
name|auth_ie
expr_stmt|;
name|params
operator|.
name|ie_len
operator|=
name|drv
operator|->
name|auth_ie_len
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|4
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|drv
operator|->
name|auth_wep_key_len
index|[
name|i
index|]
condition|)
block|{
name|params
operator|.
name|wep_key
index|[
name|i
index|]
operator|=
name|drv
operator|->
name|auth_wep_key
index|[
name|i
index|]
expr_stmt|;
name|params
operator|.
name|wep_key_len
index|[
name|i
index|]
operator|=
name|drv
operator|->
name|auth_wep_key_len
index|[
name|i
index|]
expr_stmt|;
block|}
block|}
name|drv
operator|->
name|retry_auth
operator|=
literal|1
expr_stmt|;
return|return
name|wpa_driver_nl80211_authenticate
argument_list|(
name|bss
argument_list|,
operator|&
name|params
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|wpa_driver_nl80211_send_frame
parameter_list|(
name|struct
name|i802_bss
modifier|*
name|bss
parameter_list|,
specifier|const
name|void
modifier|*
name|data
parameter_list|,
name|size_t
name|len
parameter_list|,
name|int
name|encrypt
parameter_list|,
name|int
name|noack
parameter_list|,
name|unsigned
name|int
name|freq
parameter_list|,
name|int
name|no_cck
parameter_list|,
name|int
name|offchanok
parameter_list|,
name|unsigned
name|int
name|wait_time
parameter_list|)
block|{
name|struct
name|wpa_driver_nl80211_data
modifier|*
name|drv
init|=
name|bss
operator|->
name|drv
decl_stmt|;
name|u64
name|cookie
decl_stmt|;
name|int
name|res
decl_stmt|;
if|if
condition|(
name|freq
operator|==
literal|0
operator|&&
name|drv
operator|->
name|nlmode
operator|==
name|NL80211_IFTYPE_ADHOC
condition|)
block|{
name|freq
operator|=
name|nl80211_get_assoc_freq
argument_list|(
name|drv
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"nl80211: send_frame - Use assoc_freq=%u for IBSS"
argument_list|,
name|freq
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|freq
operator|==
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"nl80211: send_frame - Use bss->freq=%u"
argument_list|,
name|bss
operator|->
name|freq
argument_list|)
expr_stmt|;
name|freq
operator|=
name|bss
operator|->
name|freq
expr_stmt|;
block|}
if|if
condition|(
name|drv
operator|->
name|use_monitor
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"nl80211: send_frame(freq=%u bss->freq=%u) -> send_monitor"
argument_list|,
name|freq
argument_list|,
name|bss
operator|->
name|freq
argument_list|)
expr_stmt|;
return|return
name|nl80211_send_monitor
argument_list|(
name|drv
argument_list|,
name|data
argument_list|,
name|len
argument_list|,
name|encrypt
argument_list|,
name|noack
argument_list|)
return|;
block|}
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"nl80211: send_frame -> send_frame_cmd"
argument_list|)
expr_stmt|;
name|res
operator|=
name|nl80211_send_frame_cmd
argument_list|(
name|bss
argument_list|,
name|freq
argument_list|,
name|wait_time
argument_list|,
name|data
argument_list|,
name|len
argument_list|,
operator|&
name|cookie
argument_list|,
name|no_cck
argument_list|,
name|noack
argument_list|,
name|offchanok
argument_list|)
expr_stmt|;
if|if
condition|(
name|res
operator|==
literal|0
operator|&&
operator|!
name|noack
condition|)
block|{
specifier|const
name|struct
name|ieee80211_mgmt
modifier|*
name|mgmt
decl_stmt|;
name|u16
name|fc
decl_stmt|;
name|mgmt
operator|=
operator|(
specifier|const
expr|struct
name|ieee80211_mgmt
operator|*
operator|)
name|data
expr_stmt|;
name|fc
operator|=
name|le_to_host16
argument_list|(
name|mgmt
operator|->
name|frame_control
argument_list|)
expr_stmt|;
if|if
condition|(
name|WLAN_FC_GET_TYPE
argument_list|(
name|fc
argument_list|)
operator|==
name|WLAN_FC_TYPE_MGMT
operator|&&
name|WLAN_FC_GET_STYPE
argument_list|(
name|fc
argument_list|)
operator|==
name|WLAN_FC_STYPE_ACTION
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_MSGDUMP
argument_list|,
literal|"nl80211: Update send_action_cookie from 0x%llx to 0x%llx"
argument_list|,
operator|(
name|long
name|long
name|unsigned
name|int
operator|)
name|drv
operator|->
name|send_action_cookie
argument_list|,
operator|(
name|long
name|long
name|unsigned
name|int
operator|)
name|cookie
argument_list|)
expr_stmt|;
name|drv
operator|->
name|send_action_cookie
operator|=
name|cookie
expr_stmt|;
block|}
block|}
return|return
name|res
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|wpa_driver_nl80211_send_mlme
parameter_list|(
name|struct
name|i802_bss
modifier|*
name|bss
parameter_list|,
specifier|const
name|u8
modifier|*
name|data
parameter_list|,
name|size_t
name|data_len
parameter_list|,
name|int
name|noack
parameter_list|,
name|unsigned
name|int
name|freq
parameter_list|,
name|int
name|no_cck
parameter_list|,
name|int
name|offchanok
parameter_list|,
name|unsigned
name|int
name|wait_time
parameter_list|)
block|{
name|struct
name|wpa_driver_nl80211_data
modifier|*
name|drv
init|=
name|bss
operator|->
name|drv
decl_stmt|;
name|struct
name|ieee80211_mgmt
modifier|*
name|mgmt
decl_stmt|;
name|int
name|encrypt
init|=
literal|1
decl_stmt|;
name|u16
name|fc
decl_stmt|;
name|mgmt
operator|=
operator|(
expr|struct
name|ieee80211_mgmt
operator|*
operator|)
name|data
expr_stmt|;
name|fc
operator|=
name|le_to_host16
argument_list|(
name|mgmt
operator|->
name|frame_control
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"nl80211: send_mlme - da= "
name|MACSTR
literal|" noack=%d freq=%u no_cck=%d offchanok=%d wait_time=%u fc=0x%x (%s) nlmode=%d"
argument_list|,
name|MAC2STR
argument_list|(
name|mgmt
operator|->
name|da
argument_list|)
argument_list|,
name|noack
argument_list|,
name|freq
argument_list|,
name|no_cck
argument_list|,
name|offchanok
argument_list|,
name|wait_time
argument_list|,
name|fc
argument_list|,
name|fc2str
argument_list|(
name|fc
argument_list|)
argument_list|,
name|drv
operator|->
name|nlmode
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|is_sta_interface
argument_list|(
name|drv
operator|->
name|nlmode
argument_list|)
operator|||
name|drv
operator|->
name|nlmode
operator|==
name|NL80211_IFTYPE_P2P_DEVICE
operator|)
operator|&&
name|WLAN_FC_GET_TYPE
argument_list|(
name|fc
argument_list|)
operator|==
name|WLAN_FC_TYPE_MGMT
operator|&&
name|WLAN_FC_GET_STYPE
argument_list|(
name|fc
argument_list|)
operator|==
name|WLAN_FC_STYPE_PROBE_RESP
condition|)
block|{
comment|/* 		 * The use of last_mgmt_freq is a bit of a hack, 		 * but it works due to the single-threaded nature 		 * of wpa_supplicant. 		 */
if|if
condition|(
name|freq
operator|==
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"nl80211: Use last_mgmt_freq=%d"
argument_list|,
name|drv
operator|->
name|last_mgmt_freq
argument_list|)
expr_stmt|;
name|freq
operator|=
name|drv
operator|->
name|last_mgmt_freq
expr_stmt|;
block|}
return|return
name|nl80211_send_frame_cmd
argument_list|(
name|bss
argument_list|,
name|freq
argument_list|,
literal|0
argument_list|,
name|data
argument_list|,
name|data_len
argument_list|,
name|NULL
argument_list|,
literal|1
argument_list|,
name|noack
argument_list|,
literal|1
argument_list|)
return|;
block|}
if|if
condition|(
name|drv
operator|->
name|device_ap_sme
operator|&&
name|is_ap_interface
argument_list|(
name|drv
operator|->
name|nlmode
argument_list|)
condition|)
block|{
if|if
condition|(
name|freq
operator|==
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"nl80211: Use bss->freq=%d"
argument_list|,
name|bss
operator|->
name|freq
argument_list|)
expr_stmt|;
name|freq
operator|=
name|bss
operator|->
name|freq
expr_stmt|;
block|}
return|return
name|nl80211_send_frame_cmd
argument_list|(
name|bss
argument_list|,
name|freq
argument_list|,
operator|(
name|int
operator|)
name|freq
operator|==
name|bss
operator|->
name|freq
condition|?
literal|0
else|:
name|wait_time
argument_list|,
name|data
argument_list|,
name|data_len
argument_list|,
operator|&
name|drv
operator|->
name|send_action_cookie
argument_list|,
name|no_cck
argument_list|,
name|noack
argument_list|,
name|offchanok
argument_list|)
return|;
block|}
if|if
condition|(
name|WLAN_FC_GET_TYPE
argument_list|(
name|fc
argument_list|)
operator|==
name|WLAN_FC_TYPE_MGMT
operator|&&
name|WLAN_FC_GET_STYPE
argument_list|(
name|fc
argument_list|)
operator|==
name|WLAN_FC_STYPE_AUTH
condition|)
block|{
comment|/* 		 * Only one of the authentication frame types is encrypted. 		 * In order for static WEP encryption to work properly (i.e., 		 * to not encrypt the frame), we need to tell mac80211 about 		 * the frames that must not be encrypted. 		 */
name|u16
name|auth_alg
init|=
name|le_to_host16
argument_list|(
name|mgmt
operator|->
name|u
operator|.
name|auth
operator|.
name|auth_alg
argument_list|)
decl_stmt|;
name|u16
name|auth_trans
init|=
name|le_to_host16
argument_list|(
name|mgmt
operator|->
name|u
operator|.
name|auth
operator|.
name|auth_transaction
argument_list|)
decl_stmt|;
if|if
condition|(
name|auth_alg
operator|!=
name|WLAN_AUTH_SHARED_KEY
operator|||
name|auth_trans
operator|!=
literal|3
condition|)
name|encrypt
operator|=
literal|0
expr_stmt|;
block|}
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"nl80211: send_mlme -> send_frame"
argument_list|)
expr_stmt|;
return|return
name|wpa_driver_nl80211_send_frame
argument_list|(
name|bss
argument_list|,
name|data
argument_list|,
name|data_len
argument_list|,
name|encrypt
argument_list|,
name|noack
argument_list|,
name|freq
argument_list|,
name|no_cck
argument_list|,
name|offchanok
argument_list|,
name|wait_time
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|nl80211_put_basic_rates
parameter_list|(
name|struct
name|nl_msg
modifier|*
name|msg
parameter_list|,
specifier|const
name|int
modifier|*
name|basic_rates
parameter_list|)
block|{
name|u8
name|rates
index|[
name|NL80211_MAX_SUPP_RATES
index|]
decl_stmt|;
name|u8
name|rates_len
init|=
literal|0
decl_stmt|;
name|int
name|i
decl_stmt|;
if|if
condition|(
operator|!
name|basic_rates
condition|)
return|return
literal|0
return|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|NL80211_MAX_SUPP_RATES
operator|&&
name|basic_rates
index|[
name|i
index|]
operator|>=
literal|0
condition|;
name|i
operator|++
control|)
name|rates
index|[
name|rates_len
operator|++
index|]
operator|=
name|basic_rates
index|[
name|i
index|]
operator|/
literal|5
expr_stmt|;
return|return
name|nla_put
argument_list|(
name|msg
argument_list|,
name|NL80211_ATTR_BSS_BASIC_RATES
argument_list|,
name|rates_len
argument_list|,
name|rates
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|nl80211_set_bss
parameter_list|(
name|struct
name|i802_bss
modifier|*
name|bss
parameter_list|,
name|int
name|cts
parameter_list|,
name|int
name|preamble
parameter_list|,
name|int
name|slot
parameter_list|,
name|int
name|ht_opmode
parameter_list|,
name|int
name|ap_isolate
parameter_list|,
specifier|const
name|int
modifier|*
name|basic_rates
parameter_list|)
block|{
name|struct
name|wpa_driver_nl80211_data
modifier|*
name|drv
init|=
name|bss
operator|->
name|drv
decl_stmt|;
name|struct
name|nl_msg
modifier|*
name|msg
decl_stmt|;
if|if
condition|(
operator|!
operator|(
name|msg
operator|=
name|nl80211_bss_msg
argument_list|(
name|bss
argument_list|,
literal|0
argument_list|,
name|NL80211_CMD_SET_BSS
argument_list|)
operator|)
operator|||
operator|(
name|cts
operator|>=
literal|0
operator|&&
name|nla_put_u8
argument_list|(
name|msg
argument_list|,
name|NL80211_ATTR_BSS_CTS_PROT
argument_list|,
name|cts
argument_list|)
operator|)
operator|||
operator|(
name|preamble
operator|>=
literal|0
operator|&&
name|nla_put_u8
argument_list|(
name|msg
argument_list|,
name|NL80211_ATTR_BSS_SHORT_PREAMBLE
argument_list|,
name|preamble
argument_list|)
operator|)
operator|||
operator|(
name|slot
operator|>=
literal|0
operator|&&
name|nla_put_u8
argument_list|(
name|msg
argument_list|,
name|NL80211_ATTR_BSS_SHORT_SLOT_TIME
argument_list|,
name|slot
argument_list|)
operator|)
operator|||
operator|(
name|ht_opmode
operator|>=
literal|0
operator|&&
name|nla_put_u16
argument_list|(
name|msg
argument_list|,
name|NL80211_ATTR_BSS_HT_OPMODE
argument_list|,
name|ht_opmode
argument_list|)
operator|)
operator|||
operator|(
name|ap_isolate
operator|>=
literal|0
operator|&&
name|nla_put_u8
argument_list|(
name|msg
argument_list|,
name|NL80211_ATTR_AP_ISOLATE
argument_list|,
name|ap_isolate
argument_list|)
operator|)
operator|||
name|nl80211_put_basic_rates
argument_list|(
name|msg
argument_list|,
name|basic_rates
argument_list|)
condition|)
block|{
name|nlmsg_free
argument_list|(
name|msg
argument_list|)
expr_stmt|;
return|return
operator|-
name|ENOBUFS
return|;
block|}
return|return
name|send_and_recv_msgs
argument_list|(
name|drv
argument_list|,
name|msg
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|wpa_driver_nl80211_set_acl
parameter_list|(
name|void
modifier|*
name|priv
parameter_list|,
name|struct
name|hostapd_acl_params
modifier|*
name|params
parameter_list|)
block|{
name|struct
name|i802_bss
modifier|*
name|bss
init|=
name|priv
decl_stmt|;
name|struct
name|wpa_driver_nl80211_data
modifier|*
name|drv
init|=
name|bss
operator|->
name|drv
decl_stmt|;
name|struct
name|nl_msg
modifier|*
name|msg
decl_stmt|;
name|struct
name|nlattr
modifier|*
name|acl
decl_stmt|;
name|unsigned
name|int
name|i
decl_stmt|;
name|int
name|ret
decl_stmt|;
if|if
condition|(
operator|!
operator|(
name|drv
operator|->
name|capa
operator|.
name|max_acl_mac_addrs
operator|)
condition|)
return|return
operator|-
name|ENOTSUP
return|;
if|if
condition|(
name|params
operator|->
name|num_mac_acl
operator|>
name|drv
operator|->
name|capa
operator|.
name|max_acl_mac_addrs
condition|)
return|return
operator|-
name|ENOTSUP
return|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"nl80211: Set %s ACL (num_mac_acl=%u)"
argument_list|,
name|params
operator|->
name|acl_policy
condition|?
literal|"Accept"
else|:
literal|"Deny"
argument_list|,
name|params
operator|->
name|num_mac_acl
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|msg
operator|=
name|nl80211_drv_msg
argument_list|(
name|drv
argument_list|,
literal|0
argument_list|,
name|NL80211_CMD_SET_MAC_ACL
argument_list|)
operator|)
operator|||
name|nla_put_u32
argument_list|(
name|msg
argument_list|,
name|NL80211_ATTR_ACL_POLICY
argument_list|,
name|params
operator|->
name|acl_policy
condition|?
name|NL80211_ACL_POLICY_DENY_UNLESS_LISTED
else|:
name|NL80211_ACL_POLICY_ACCEPT_UNLESS_LISTED
argument_list|)
operator|||
operator|(
name|acl
operator|=
name|nla_nest_start
argument_list|(
name|msg
argument_list|,
name|NL80211_ATTR_MAC_ADDRS
argument_list|)
operator|)
operator|==
name|NULL
condition|)
block|{
name|nlmsg_free
argument_list|(
name|msg
argument_list|)
expr_stmt|;
return|return
operator|-
name|ENOMEM
return|;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|params
operator|->
name|num_mac_acl
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|nla_put
argument_list|(
name|msg
argument_list|,
name|i
operator|+
literal|1
argument_list|,
name|ETH_ALEN
argument_list|,
name|params
operator|->
name|mac_acl
index|[
name|i
index|]
operator|.
name|addr
argument_list|)
condition|)
block|{
name|nlmsg_free
argument_list|(
name|msg
argument_list|)
expr_stmt|;
return|return
operator|-
name|ENOMEM
return|;
block|}
block|}
name|nla_nest_end
argument_list|(
name|msg
argument_list|,
name|acl
argument_list|)
expr_stmt|;
name|ret
operator|=
name|send_and_recv_msgs
argument_list|(
name|drv
argument_list|,
name|msg
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"nl80211: Failed to set MAC ACL: %d (%s)"
argument_list|,
name|ret
argument_list|,
name|strerror
argument_list|(
operator|-
name|ret
argument_list|)
argument_list|)
expr_stmt|;
block|}
return|return
name|ret
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|nl80211_put_beacon_int
parameter_list|(
name|struct
name|nl_msg
modifier|*
name|msg
parameter_list|,
name|int
name|beacon_int
parameter_list|)
block|{
if|if
condition|(
name|beacon_int
operator|>
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"  * beacon_int=%d"
argument_list|,
name|beacon_int
argument_list|)
expr_stmt|;
return|return
name|nla_put_u32
argument_list|(
name|msg
argument_list|,
name|NL80211_ATTR_BEACON_INTERVAL
argument_list|,
name|beacon_int
argument_list|)
return|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|wpa_driver_nl80211_set_ap
parameter_list|(
name|void
modifier|*
name|priv
parameter_list|,
name|struct
name|wpa_driver_ap_params
modifier|*
name|params
parameter_list|)
block|{
name|struct
name|i802_bss
modifier|*
name|bss
init|=
name|priv
decl_stmt|;
name|struct
name|wpa_driver_nl80211_data
modifier|*
name|drv
init|=
name|bss
operator|->
name|drv
decl_stmt|;
name|struct
name|nl_msg
modifier|*
name|msg
decl_stmt|;
name|u8
name|cmd
init|=
name|NL80211_CMD_NEW_BEACON
decl_stmt|;
name|int
name|ret
decl_stmt|;
name|int
name|beacon_set
decl_stmt|;
name|int
name|num_suites
decl_stmt|;
name|int
name|smps_mode
decl_stmt|;
name|u32
name|suites
index|[
literal|10
index|]
decl_stmt|,
name|suite
decl_stmt|;
name|u32
name|ver
decl_stmt|;
name|beacon_set
operator|=
name|params
operator|->
name|reenable
condition|?
literal|0
else|:
name|bss
operator|->
name|beacon_set
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"nl80211: Set beacon (beacon_set=%d)"
argument_list|,
name|beacon_set
argument_list|)
expr_stmt|;
if|if
condition|(
name|beacon_set
condition|)
name|cmd
operator|=
name|NL80211_CMD_SET_BEACON
expr_stmt|;
name|wpa_hexdump
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"nl80211: Beacon head"
argument_list|,
name|params
operator|->
name|head
argument_list|,
name|params
operator|->
name|head_len
argument_list|)
expr_stmt|;
name|wpa_hexdump
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"nl80211: Beacon tail"
argument_list|,
name|params
operator|->
name|tail
argument_list|,
name|params
operator|->
name|tail_len
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"nl80211: ifindex=%d"
argument_list|,
name|bss
operator|->
name|ifindex
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"nl80211: beacon_int=%d"
argument_list|,
name|params
operator|->
name|beacon_int
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"nl80211: dtim_period=%d"
argument_list|,
name|params
operator|->
name|dtim_period
argument_list|)
expr_stmt|;
name|wpa_hexdump_ascii
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"nl80211: ssid"
argument_list|,
name|params
operator|->
name|ssid
argument_list|,
name|params
operator|->
name|ssid_len
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|msg
operator|=
name|nl80211_bss_msg
argument_list|(
name|bss
argument_list|,
literal|0
argument_list|,
name|cmd
argument_list|)
operator|)
operator|||
name|nla_put
argument_list|(
name|msg
argument_list|,
name|NL80211_ATTR_BEACON_HEAD
argument_list|,
name|params
operator|->
name|head_len
argument_list|,
name|params
operator|->
name|head
argument_list|)
operator|||
name|nla_put
argument_list|(
name|msg
argument_list|,
name|NL80211_ATTR_BEACON_TAIL
argument_list|,
name|params
operator|->
name|tail_len
argument_list|,
name|params
operator|->
name|tail
argument_list|)
operator|||
name|nl80211_put_beacon_int
argument_list|(
name|msg
argument_list|,
name|params
operator|->
name|beacon_int
argument_list|)
operator|||
name|nla_put_u32
argument_list|(
name|msg
argument_list|,
name|NL80211_ATTR_DTIM_PERIOD
argument_list|,
name|params
operator|->
name|dtim_period
argument_list|)
operator|||
name|nla_put
argument_list|(
name|msg
argument_list|,
name|NL80211_ATTR_SSID
argument_list|,
name|params
operator|->
name|ssid_len
argument_list|,
name|params
operator|->
name|ssid
argument_list|)
condition|)
goto|goto
name|fail
goto|;
if|if
condition|(
name|params
operator|->
name|proberesp
operator|&&
name|params
operator|->
name|proberesp_len
condition|)
block|{
name|wpa_hexdump
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"nl80211: proberesp (offload)"
argument_list|,
name|params
operator|->
name|proberesp
argument_list|,
name|params
operator|->
name|proberesp_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|nla_put
argument_list|(
name|msg
argument_list|,
name|NL80211_ATTR_PROBE_RESP
argument_list|,
name|params
operator|->
name|proberesp_len
argument_list|,
name|params
operator|->
name|proberesp
argument_list|)
condition|)
goto|goto
name|fail
goto|;
block|}
switch|switch
condition|(
name|params
operator|->
name|hide_ssid
condition|)
block|{
case|case
name|NO_SSID_HIDING
case|:
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"nl80211: hidden SSID not in use"
argument_list|)
expr_stmt|;
if|if
condition|(
name|nla_put_u32
argument_list|(
name|msg
argument_list|,
name|NL80211_ATTR_HIDDEN_SSID
argument_list|,
name|NL80211_HIDDEN_SSID_NOT_IN_USE
argument_list|)
condition|)
goto|goto
name|fail
goto|;
break|break;
case|case
name|HIDDEN_SSID_ZERO_LEN
case|:
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"nl80211: hidden SSID zero len"
argument_list|)
expr_stmt|;
if|if
condition|(
name|nla_put_u32
argument_list|(
name|msg
argument_list|,
name|NL80211_ATTR_HIDDEN_SSID
argument_list|,
name|NL80211_HIDDEN_SSID_ZERO_LEN
argument_list|)
condition|)
goto|goto
name|fail
goto|;
break|break;
case|case
name|HIDDEN_SSID_ZERO_CONTENTS
case|:
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"nl80211: hidden SSID zero contents"
argument_list|)
expr_stmt|;
if|if
condition|(
name|nla_put_u32
argument_list|(
name|msg
argument_list|,
name|NL80211_ATTR_HIDDEN_SSID
argument_list|,
name|NL80211_HIDDEN_SSID_ZERO_CONTENTS
argument_list|)
condition|)
goto|goto
name|fail
goto|;
break|break;
block|}
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"nl80211: privacy=%d"
argument_list|,
name|params
operator|->
name|privacy
argument_list|)
expr_stmt|;
if|if
condition|(
name|params
operator|->
name|privacy
operator|&&
name|nla_put_flag
argument_list|(
name|msg
argument_list|,
name|NL80211_ATTR_PRIVACY
argument_list|)
condition|)
goto|goto
name|fail
goto|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"nl80211: auth_algs=0x%x"
argument_list|,
name|params
operator|->
name|auth_algs
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|params
operator|->
name|auth_algs
operator|&
operator|(
name|WPA_AUTH_ALG_OPEN
operator||
name|WPA_AUTH_ALG_SHARED
operator|)
operator|)
operator|==
operator|(
name|WPA_AUTH_ALG_OPEN
operator||
name|WPA_AUTH_ALG_SHARED
operator|)
condition|)
block|{
comment|/* Leave out the attribute */
block|}
elseif|else
if|if
condition|(
name|params
operator|->
name|auth_algs
operator|&
name|WPA_AUTH_ALG_SHARED
condition|)
block|{
if|if
condition|(
name|nla_put_u32
argument_list|(
name|msg
argument_list|,
name|NL80211_ATTR_AUTH_TYPE
argument_list|,
name|NL80211_AUTHTYPE_SHARED_KEY
argument_list|)
condition|)
goto|goto
name|fail
goto|;
block|}
else|else
block|{
if|if
condition|(
name|nla_put_u32
argument_list|(
name|msg
argument_list|,
name|NL80211_ATTR_AUTH_TYPE
argument_list|,
name|NL80211_AUTHTYPE_OPEN_SYSTEM
argument_list|)
condition|)
goto|goto
name|fail
goto|;
block|}
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"nl80211: wpa_version=0x%x"
argument_list|,
name|params
operator|->
name|wpa_version
argument_list|)
expr_stmt|;
name|ver
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|params
operator|->
name|wpa_version
operator|&
name|WPA_PROTO_WPA
condition|)
name|ver
operator||=
name|NL80211_WPA_VERSION_1
expr_stmt|;
if|if
condition|(
name|params
operator|->
name|wpa_version
operator|&
name|WPA_PROTO_RSN
condition|)
name|ver
operator||=
name|NL80211_WPA_VERSION_2
expr_stmt|;
if|if
condition|(
name|ver
operator|&&
name|nla_put_u32
argument_list|(
name|msg
argument_list|,
name|NL80211_ATTR_WPA_VERSIONS
argument_list|,
name|ver
argument_list|)
condition|)
goto|goto
name|fail
goto|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"nl80211: key_mgmt_suites=0x%x"
argument_list|,
name|params
operator|->
name|key_mgmt_suites
argument_list|)
expr_stmt|;
name|num_suites
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|params
operator|->
name|key_mgmt_suites
operator|&
name|WPA_KEY_MGMT_IEEE8021X
condition|)
name|suites
index|[
name|num_suites
operator|++
index|]
operator|=
name|WLAN_AKM_SUITE_8021X
expr_stmt|;
if|if
condition|(
name|params
operator|->
name|key_mgmt_suites
operator|&
name|WPA_KEY_MGMT_PSK
condition|)
name|suites
index|[
name|num_suites
operator|++
index|]
operator|=
name|WLAN_AKM_SUITE_PSK
expr_stmt|;
if|if
condition|(
name|num_suites
operator|&&
name|nla_put
argument_list|(
name|msg
argument_list|,
name|NL80211_ATTR_AKM_SUITES
argument_list|,
name|num_suites
operator|*
sizeof|sizeof
argument_list|(
name|u32
argument_list|)
argument_list|,
name|suites
argument_list|)
condition|)
goto|goto
name|fail
goto|;
if|if
condition|(
name|params
operator|->
name|key_mgmt_suites
operator|&
name|WPA_KEY_MGMT_IEEE8021X_NO_WPA
operator|&&
name|params
operator|->
name|pairwise_ciphers
operator|&
operator|(
name|WPA_CIPHER_WEP104
operator||
name|WPA_CIPHER_WEP40
operator|)
operator|&&
name|nla_put_flag
argument_list|(
name|msg
argument_list|,
name|NL80211_ATTR_CONTROL_PORT_NO_ENCRYPT
argument_list|)
condition|)
goto|goto
name|fail
goto|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"nl80211: pairwise_ciphers=0x%x"
argument_list|,
name|params
operator|->
name|pairwise_ciphers
argument_list|)
expr_stmt|;
name|num_suites
operator|=
name|wpa_cipher_to_cipher_suites
argument_list|(
name|params
operator|->
name|pairwise_ciphers
argument_list|,
name|suites
argument_list|,
name|ARRAY_SIZE
argument_list|(
name|suites
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|num_suites
operator|&&
name|nla_put
argument_list|(
name|msg
argument_list|,
name|NL80211_ATTR_CIPHER_SUITES_PAIRWISE
argument_list|,
name|num_suites
operator|*
sizeof|sizeof
argument_list|(
name|u32
argument_list|)
argument_list|,
name|suites
argument_list|)
condition|)
goto|goto
name|fail
goto|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"nl80211: group_cipher=0x%x"
argument_list|,
name|params
operator|->
name|group_cipher
argument_list|)
expr_stmt|;
name|suite
operator|=
name|wpa_cipher_to_cipher_suite
argument_list|(
name|params
operator|->
name|group_cipher
argument_list|)
expr_stmt|;
if|if
condition|(
name|suite
operator|&&
name|nla_put_u32
argument_list|(
name|msg
argument_list|,
name|NL80211_ATTR_CIPHER_SUITE_GROUP
argument_list|,
name|suite
argument_list|)
condition|)
goto|goto
name|fail
goto|;
switch|switch
condition|(
name|params
operator|->
name|smps_mode
condition|)
block|{
case|case
name|HT_CAP_INFO_SMPS_DYNAMIC
case|:
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"nl80211: SMPS mode - dynamic"
argument_list|)
expr_stmt|;
name|smps_mode
operator|=
name|NL80211_SMPS_DYNAMIC
expr_stmt|;
break|break;
case|case
name|HT_CAP_INFO_SMPS_STATIC
case|:
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"nl80211: SMPS mode - static"
argument_list|)
expr_stmt|;
name|smps_mode
operator|=
name|NL80211_SMPS_STATIC
expr_stmt|;
break|break;
default|default:
comment|/* invalid - fallback to smps off */
case|case
name|HT_CAP_INFO_SMPS_DISABLED
case|:
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"nl80211: SMPS mode - off"
argument_list|)
expr_stmt|;
name|smps_mode
operator|=
name|NL80211_SMPS_OFF
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|nla_put_u32
argument_list|(
name|msg
argument_list|,
name|NL80211_ATTR_SMPS_MODE
argument_list|,
name|smps_mode
argument_list|)
condition|)
goto|goto
name|fail
goto|;
if|if
condition|(
name|params
operator|->
name|beacon_ies
condition|)
block|{
name|wpa_hexdump_buf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"nl80211: beacon_ies"
argument_list|,
name|params
operator|->
name|beacon_ies
argument_list|)
expr_stmt|;
if|if
condition|(
name|nla_put
argument_list|(
name|msg
argument_list|,
name|NL80211_ATTR_IE
argument_list|,
name|wpabuf_len
argument_list|(
name|params
operator|->
name|beacon_ies
argument_list|)
argument_list|,
name|wpabuf_head
argument_list|(
name|params
operator|->
name|beacon_ies
argument_list|)
argument_list|)
condition|)
goto|goto
name|fail
goto|;
block|}
if|if
condition|(
name|params
operator|->
name|proberesp_ies
condition|)
block|{
name|wpa_hexdump_buf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"nl80211: proberesp_ies"
argument_list|,
name|params
operator|->
name|proberesp_ies
argument_list|)
expr_stmt|;
if|if
condition|(
name|nla_put
argument_list|(
name|msg
argument_list|,
name|NL80211_ATTR_IE_PROBE_RESP
argument_list|,
name|wpabuf_len
argument_list|(
name|params
operator|->
name|proberesp_ies
argument_list|)
argument_list|,
name|wpabuf_head
argument_list|(
name|params
operator|->
name|proberesp_ies
argument_list|)
argument_list|)
condition|)
goto|goto
name|fail
goto|;
block|}
if|if
condition|(
name|params
operator|->
name|assocresp_ies
condition|)
block|{
name|wpa_hexdump_buf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"nl80211: assocresp_ies"
argument_list|,
name|params
operator|->
name|assocresp_ies
argument_list|)
expr_stmt|;
if|if
condition|(
name|nla_put
argument_list|(
name|msg
argument_list|,
name|NL80211_ATTR_IE_ASSOC_RESP
argument_list|,
name|wpabuf_len
argument_list|(
name|params
operator|->
name|assocresp_ies
argument_list|)
argument_list|,
name|wpabuf_head
argument_list|(
name|params
operator|->
name|assocresp_ies
argument_list|)
argument_list|)
condition|)
goto|goto
name|fail
goto|;
block|}
if|if
condition|(
name|drv
operator|->
name|capa
operator|.
name|flags
operator|&
name|WPA_DRIVER_FLAGS_INACTIVITY_TIMER
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"nl80211: ap_max_inactivity=%d"
argument_list|,
name|params
operator|->
name|ap_max_inactivity
argument_list|)
expr_stmt|;
if|if
condition|(
name|nla_put_u16
argument_list|(
name|msg
argument_list|,
name|NL80211_ATTR_INACTIVITY_TIMEOUT
argument_list|,
name|params
operator|->
name|ap_max_inactivity
argument_list|)
condition|)
goto|goto
name|fail
goto|;
block|}
ifdef|#
directive|ifdef
name|CONFIG_P2P
if|if
condition|(
name|params
operator|->
name|p2p_go_ctwindow
operator|>
literal|0
condition|)
block|{
if|if
condition|(
name|drv
operator|->
name|p2p_go_ctwindow_supported
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"nl80211: P2P GO ctwindow=%d"
argument_list|,
name|params
operator|->
name|p2p_go_ctwindow
argument_list|)
expr_stmt|;
if|if
condition|(
name|nla_put_u8
argument_list|(
name|msg
argument_list|,
name|NL80211_ATTR_P2P_CTWINDOW
argument_list|,
name|params
operator|->
name|p2p_go_ctwindow
argument_list|)
condition|)
goto|goto
name|fail
goto|;
block|}
else|else
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"nl80211: Driver does not support CTWindow configuration - ignore this parameter"
argument_list|)
expr_stmt|;
block|}
block|}
endif|#
directive|endif
comment|/* CONFIG_P2P */
name|ret
operator|=
name|send_and_recv_msgs
argument_list|(
name|drv
argument_list|,
name|msg
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"nl80211: Beacon set failed: %d (%s)"
argument_list|,
name|ret
argument_list|,
name|strerror
argument_list|(
operator|-
name|ret
argument_list|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|bss
operator|->
name|beacon_set
operator|=
literal|1
expr_stmt|;
name|nl80211_set_bss
argument_list|(
name|bss
argument_list|,
name|params
operator|->
name|cts_protect
argument_list|,
name|params
operator|->
name|preamble
argument_list|,
name|params
operator|->
name|short_slot_time
argument_list|,
name|params
operator|->
name|ht_opmode
argument_list|,
name|params
operator|->
name|isolate
argument_list|,
name|params
operator|->
name|basic_rates
argument_list|)
expr_stmt|;
if|if
condition|(
name|beacon_set
operator|&&
name|params
operator|->
name|freq
operator|&&
name|params
operator|->
name|freq
operator|->
name|bandwidth
operator|!=
name|bss
operator|->
name|bandwidth
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"nl80211: Update BSS %s bandwidth: %d -> %d"
argument_list|,
name|bss
operator|->
name|ifname
argument_list|,
name|bss
operator|->
name|bandwidth
argument_list|,
name|params
operator|->
name|freq
operator|->
name|bandwidth
argument_list|)
expr_stmt|;
name|ret
operator|=
name|nl80211_set_channel
argument_list|(
name|bss
argument_list|,
name|params
operator|->
name|freq
argument_list|,
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"nl80211: Frequency set failed: %d (%s)"
argument_list|,
name|ret
argument_list|,
name|strerror
argument_list|(
operator|-
name|ret
argument_list|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"nl80211: Frequency set succeeded for ht2040 coex"
argument_list|)
expr_stmt|;
name|bss
operator|->
name|bandwidth
operator|=
name|params
operator|->
name|freq
operator|->
name|bandwidth
expr_stmt|;
block|}
block|}
elseif|else
if|if
condition|(
operator|!
name|beacon_set
condition|)
block|{
comment|/* 			 * cfg80211 updates the driver on frequence change in AP 			 * mode only at the point when beaconing is started, so 			 * set the initial value here. 			 */
name|bss
operator|->
name|bandwidth
operator|=
name|params
operator|->
name|freq
operator|->
name|bandwidth
expr_stmt|;
block|}
block|}
return|return
name|ret
return|;
name|fail
label|:
name|nlmsg_free
argument_list|(
name|msg
argument_list|)
expr_stmt|;
return|return
operator|-
name|ENOBUFS
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|nl80211_put_freq_params
parameter_list|(
name|struct
name|nl_msg
modifier|*
name|msg
parameter_list|,
specifier|const
name|struct
name|hostapd_freq_params
modifier|*
name|freq
parameter_list|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"  * freq=%d"
argument_list|,
name|freq
operator|->
name|freq
argument_list|)
expr_stmt|;
if|if
condition|(
name|nla_put_u32
argument_list|(
name|msg
argument_list|,
name|NL80211_ATTR_WIPHY_FREQ
argument_list|,
name|freq
operator|->
name|freq
argument_list|)
condition|)
return|return
operator|-
name|ENOBUFS
return|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"  * vht_enabled=%d"
argument_list|,
name|freq
operator|->
name|vht_enabled
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"  * ht_enabled=%d"
argument_list|,
name|freq
operator|->
name|ht_enabled
argument_list|)
expr_stmt|;
if|if
condition|(
name|freq
operator|->
name|vht_enabled
condition|)
block|{
name|enum
name|nl80211_chan_width
name|cw
decl_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"  * bandwidth=%d"
argument_list|,
name|freq
operator|->
name|bandwidth
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|freq
operator|->
name|bandwidth
condition|)
block|{
case|case
literal|20
case|:
name|cw
operator|=
name|NL80211_CHAN_WIDTH_20
expr_stmt|;
break|break;
case|case
literal|40
case|:
name|cw
operator|=
name|NL80211_CHAN_WIDTH_40
expr_stmt|;
break|break;
case|case
literal|80
case|:
if|if
condition|(
name|freq
operator|->
name|center_freq2
condition|)
name|cw
operator|=
name|NL80211_CHAN_WIDTH_80P80
expr_stmt|;
else|else
name|cw
operator|=
name|NL80211_CHAN_WIDTH_80
expr_stmt|;
break|break;
case|case
literal|160
case|:
name|cw
operator|=
name|NL80211_CHAN_WIDTH_160
expr_stmt|;
break|break;
default|default:
return|return
operator|-
name|EINVAL
return|;
block|}
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"  * channel_width=%d"
argument_list|,
name|cw
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"  * center_freq1=%d"
argument_list|,
name|freq
operator|->
name|center_freq1
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"  * center_freq2=%d"
argument_list|,
name|freq
operator|->
name|center_freq2
argument_list|)
expr_stmt|;
if|if
condition|(
name|nla_put_u32
argument_list|(
name|msg
argument_list|,
name|NL80211_ATTR_CHANNEL_WIDTH
argument_list|,
name|cw
argument_list|)
operator|||
name|nla_put_u32
argument_list|(
name|msg
argument_list|,
name|NL80211_ATTR_CENTER_FREQ1
argument_list|,
name|freq
operator|->
name|center_freq1
argument_list|)
operator|||
operator|(
name|freq
operator|->
name|center_freq2
operator|&&
name|nla_put_u32
argument_list|(
name|msg
argument_list|,
name|NL80211_ATTR_CENTER_FREQ2
argument_list|,
name|freq
operator|->
name|center_freq2
argument_list|)
operator|)
condition|)
return|return
operator|-
name|ENOBUFS
return|;
block|}
elseif|else
if|if
condition|(
name|freq
operator|->
name|ht_enabled
condition|)
block|{
name|enum
name|nl80211_channel_type
name|ct
decl_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"  * sec_channel_offset=%d"
argument_list|,
name|freq
operator|->
name|sec_channel_offset
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|freq
operator|->
name|sec_channel_offset
condition|)
block|{
case|case
operator|-
literal|1
case|:
name|ct
operator|=
name|NL80211_CHAN_HT40MINUS
expr_stmt|;
break|break;
case|case
literal|1
case|:
name|ct
operator|=
name|NL80211_CHAN_HT40PLUS
expr_stmt|;
break|break;
default|default:
name|ct
operator|=
name|NL80211_CHAN_HT20
expr_stmt|;
break|break;
block|}
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"  * channel_type=%d"
argument_list|,
name|ct
argument_list|)
expr_stmt|;
if|if
condition|(
name|nla_put_u32
argument_list|(
name|msg
argument_list|,
name|NL80211_ATTR_WIPHY_CHANNEL_TYPE
argument_list|,
name|ct
argument_list|)
condition|)
return|return
operator|-
name|ENOBUFS
return|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|nl80211_set_channel
parameter_list|(
name|struct
name|i802_bss
modifier|*
name|bss
parameter_list|,
name|struct
name|hostapd_freq_params
modifier|*
name|freq
parameter_list|,
name|int
name|set_chan
parameter_list|)
block|{
name|struct
name|wpa_driver_nl80211_data
modifier|*
name|drv
init|=
name|bss
operator|->
name|drv
decl_stmt|;
name|struct
name|nl_msg
modifier|*
name|msg
decl_stmt|;
name|int
name|ret
decl_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"nl80211: Set freq %d (ht_enabled=%d, vht_enabled=%d, bandwidth=%d MHz, cf1=%d MHz, cf2=%d MHz)"
argument_list|,
name|freq
operator|->
name|freq
argument_list|,
name|freq
operator|->
name|ht_enabled
argument_list|,
name|freq
operator|->
name|vht_enabled
argument_list|,
name|freq
operator|->
name|bandwidth
argument_list|,
name|freq
operator|->
name|center_freq1
argument_list|,
name|freq
operator|->
name|center_freq2
argument_list|)
expr_stmt|;
name|msg
operator|=
name|nl80211_drv_msg
argument_list|(
name|drv
argument_list|,
literal|0
argument_list|,
name|set_chan
condition|?
name|NL80211_CMD_SET_CHANNEL
else|:
name|NL80211_CMD_SET_WIPHY
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|msg
operator|||
name|nl80211_put_freq_params
argument_list|(
name|msg
argument_list|,
name|freq
argument_list|)
operator|<
literal|0
condition|)
block|{
name|nlmsg_free
argument_list|(
name|msg
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|ret
operator|=
name|send_and_recv_msgs
argument_list|(
name|drv
argument_list|,
name|msg
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|==
literal|0
condition|)
block|{
name|bss
operator|->
name|freq
operator|=
name|freq
operator|->
name|freq
expr_stmt|;
return|return
literal|0
return|;
block|}
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"nl80211: Failed to set channel (freq=%d): "
literal|"%d (%s)"
argument_list|,
name|freq
operator|->
name|freq
argument_list|,
name|ret
argument_list|,
name|strerror
argument_list|(
operator|-
name|ret
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
end_function

begin_function
specifier|static
name|u32
name|sta_flags_nl80211
parameter_list|(
name|int
name|flags
parameter_list|)
block|{
name|u32
name|f
init|=
literal|0
decl_stmt|;
if|if
condition|(
name|flags
operator|&
name|WPA_STA_AUTHORIZED
condition|)
name|f
operator||=
name|BIT
argument_list|(
name|NL80211_STA_FLAG_AUTHORIZED
argument_list|)
expr_stmt|;
if|if
condition|(
name|flags
operator|&
name|WPA_STA_WMM
condition|)
name|f
operator||=
name|BIT
argument_list|(
name|NL80211_STA_FLAG_WME
argument_list|)
expr_stmt|;
if|if
condition|(
name|flags
operator|&
name|WPA_STA_SHORT_PREAMBLE
condition|)
name|f
operator||=
name|BIT
argument_list|(
name|NL80211_STA_FLAG_SHORT_PREAMBLE
argument_list|)
expr_stmt|;
if|if
condition|(
name|flags
operator|&
name|WPA_STA_MFP
condition|)
name|f
operator||=
name|BIT
argument_list|(
name|NL80211_STA_FLAG_MFP
argument_list|)
expr_stmt|;
if|if
condition|(
name|flags
operator|&
name|WPA_STA_TDLS_PEER
condition|)
name|f
operator||=
name|BIT
argument_list|(
name|NL80211_STA_FLAG_TDLS_PEER
argument_list|)
expr_stmt|;
if|if
condition|(
name|flags
operator|&
name|WPA_STA_AUTHENTICATED
condition|)
name|f
operator||=
name|BIT
argument_list|(
name|NL80211_STA_FLAG_AUTHENTICATED
argument_list|)
expr_stmt|;
return|return
name|f
return|;
block|}
end_function

begin_ifdef
ifdef|#
directive|ifdef
name|CONFIG_MESH
end_ifdef

begin_function
specifier|static
name|u32
name|sta_plink_state_nl80211
parameter_list|(
name|enum
name|mesh_plink_state
name|state
parameter_list|)
block|{
switch|switch
condition|(
name|state
condition|)
block|{
case|case
name|PLINK_LISTEN
case|:
return|return
name|NL80211_PLINK_LISTEN
return|;
case|case
name|PLINK_OPEN_SENT
case|:
return|return
name|NL80211_PLINK_OPN_SNT
return|;
case|case
name|PLINK_OPEN_RCVD
case|:
return|return
name|NL80211_PLINK_OPN_RCVD
return|;
case|case
name|PLINK_CNF_RCVD
case|:
return|return
name|NL80211_PLINK_CNF_RCVD
return|;
case|case
name|PLINK_ESTAB
case|:
return|return
name|NL80211_PLINK_ESTAB
return|;
case|case
name|PLINK_HOLDING
case|:
return|return
name|NL80211_PLINK_HOLDING
return|;
case|case
name|PLINK_BLOCKED
case|:
return|return
name|NL80211_PLINK_BLOCKED
return|;
default|default:
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"nl80211: Invalid mesh plink state %d"
argument_list|,
name|state
argument_list|)
expr_stmt|;
block|}
return|return
operator|-
literal|1
return|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* CONFIG_MESH */
end_comment

begin_function
specifier|static
name|int
name|wpa_driver_nl80211_sta_add
parameter_list|(
name|void
modifier|*
name|priv
parameter_list|,
name|struct
name|hostapd_sta_add_params
modifier|*
name|params
parameter_list|)
block|{
name|struct
name|i802_bss
modifier|*
name|bss
init|=
name|priv
decl_stmt|;
name|struct
name|wpa_driver_nl80211_data
modifier|*
name|drv
init|=
name|bss
operator|->
name|drv
decl_stmt|;
name|struct
name|nl_msg
modifier|*
name|msg
decl_stmt|;
name|struct
name|nl80211_sta_flag_update
name|upd
decl_stmt|;
name|int
name|ret
init|=
operator|-
name|ENOBUFS
decl_stmt|;
if|if
condition|(
operator|(
name|params
operator|->
name|flags
operator|&
name|WPA_STA_TDLS_PEER
operator|)
operator|&&
operator|!
operator|(
name|drv
operator|->
name|capa
operator|.
name|flags
operator|&
name|WPA_DRIVER_FLAGS_TDLS_SUPPORT
operator|)
condition|)
return|return
operator|-
name|EOPNOTSUPP
return|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"nl80211: %s STA "
name|MACSTR
argument_list|,
name|params
operator|->
name|set
condition|?
literal|"Set"
else|:
literal|"Add"
argument_list|,
name|MAC2STR
argument_list|(
name|params
operator|->
name|addr
argument_list|)
argument_list|)
expr_stmt|;
name|msg
operator|=
name|nl80211_bss_msg
argument_list|(
name|bss
argument_list|,
literal|0
argument_list|,
name|params
operator|->
name|set
condition|?
name|NL80211_CMD_SET_STATION
else|:
name|NL80211_CMD_NEW_STATION
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|msg
operator|||
name|nla_put
argument_list|(
name|msg
argument_list|,
name|NL80211_ATTR_MAC
argument_list|,
name|ETH_ALEN
argument_list|,
name|params
operator|->
name|addr
argument_list|)
condition|)
goto|goto
name|fail
goto|;
if|if
condition|(
operator|!
name|params
operator|->
name|set
operator|||
operator|(
name|params
operator|->
name|flags
operator|&
name|WPA_STA_TDLS_PEER
operator|)
condition|)
block|{
name|wpa_hexdump
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"  * supported rates"
argument_list|,
name|params
operator|->
name|supp_rates
argument_list|,
name|params
operator|->
name|supp_rates_len
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"  * capability=0x%x"
argument_list|,
name|params
operator|->
name|capability
argument_list|)
expr_stmt|;
if|if
condition|(
name|nla_put
argument_list|(
name|msg
argument_list|,
name|NL80211_ATTR_STA_SUPPORTED_RATES
argument_list|,
name|params
operator|->
name|supp_rates_len
argument_list|,
name|params
operator|->
name|supp_rates
argument_list|)
operator|||
name|nla_put_u16
argument_list|(
name|msg
argument_list|,
name|NL80211_ATTR_STA_CAPABILITY
argument_list|,
name|params
operator|->
name|capability
argument_list|)
condition|)
goto|goto
name|fail
goto|;
if|if
condition|(
name|params
operator|->
name|ht_capabilities
condition|)
block|{
name|wpa_hexdump
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"  * ht_capabilities"
argument_list|,
operator|(
name|u8
operator|*
operator|)
name|params
operator|->
name|ht_capabilities
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|params
operator|->
name|ht_capabilities
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|nla_put
argument_list|(
name|msg
argument_list|,
name|NL80211_ATTR_HT_CAPABILITY
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|params
operator|->
name|ht_capabilities
argument_list|)
argument_list|,
name|params
operator|->
name|ht_capabilities
argument_list|)
condition|)
goto|goto
name|fail
goto|;
block|}
if|if
condition|(
name|params
operator|->
name|vht_capabilities
condition|)
block|{
name|wpa_hexdump
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"  * vht_capabilities"
argument_list|,
operator|(
name|u8
operator|*
operator|)
name|params
operator|->
name|vht_capabilities
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|params
operator|->
name|vht_capabilities
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|nla_put
argument_list|(
name|msg
argument_list|,
name|NL80211_ATTR_VHT_CAPABILITY
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|params
operator|->
name|vht_capabilities
argument_list|)
argument_list|,
name|params
operator|->
name|vht_capabilities
argument_list|)
condition|)
goto|goto
name|fail
goto|;
block|}
if|if
condition|(
name|params
operator|->
name|ext_capab
condition|)
block|{
name|wpa_hexdump
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"  * ext_capab"
argument_list|,
name|params
operator|->
name|ext_capab
argument_list|,
name|params
operator|->
name|ext_capab_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|nla_put
argument_list|(
name|msg
argument_list|,
name|NL80211_ATTR_STA_EXT_CAPABILITY
argument_list|,
name|params
operator|->
name|ext_capab_len
argument_list|,
name|params
operator|->
name|ext_capab
argument_list|)
condition|)
goto|goto
name|fail
goto|;
block|}
block|}
if|if
condition|(
operator|!
name|params
operator|->
name|set
condition|)
block|{
if|if
condition|(
name|params
operator|->
name|aid
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"  * aid=%u"
argument_list|,
name|params
operator|->
name|aid
argument_list|)
expr_stmt|;
if|if
condition|(
name|nla_put_u16
argument_list|(
name|msg
argument_list|,
name|NL80211_ATTR_STA_AID
argument_list|,
name|params
operator|->
name|aid
argument_list|)
condition|)
goto|goto
name|fail
goto|;
block|}
else|else
block|{
comment|/* 			 * cfg80211 validates that AID is non-zero, so we have 			 * to make this a non-zero value for the TDLS case where 			 * a dummy STA entry is used for now. 			 */
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"  * aid=1 (TDLS workaround)"
argument_list|)
expr_stmt|;
if|if
condition|(
name|nla_put_u16
argument_list|(
name|msg
argument_list|,
name|NL80211_ATTR_STA_AID
argument_list|,
literal|1
argument_list|)
condition|)
goto|goto
name|fail
goto|;
block|}
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"  * listen_interval=%u"
argument_list|,
name|params
operator|->
name|listen_interval
argument_list|)
expr_stmt|;
if|if
condition|(
name|nla_put_u16
argument_list|(
name|msg
argument_list|,
name|NL80211_ATTR_STA_LISTEN_INTERVAL
argument_list|,
name|params
operator|->
name|listen_interval
argument_list|)
condition|)
goto|goto
name|fail
goto|;
block|}
elseif|else
if|if
condition|(
name|params
operator|->
name|aid
operator|&&
operator|(
name|params
operator|->
name|flags
operator|&
name|WPA_STA_TDLS_PEER
operator|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"  * peer_aid=%u"
argument_list|,
name|params
operator|->
name|aid
argument_list|)
expr_stmt|;
if|if
condition|(
name|nla_put_u16
argument_list|(
name|msg
argument_list|,
name|NL80211_ATTR_PEER_AID
argument_list|,
name|params
operator|->
name|aid
argument_list|)
condition|)
goto|goto
name|fail
goto|;
block|}
if|if
condition|(
name|params
operator|->
name|vht_opmode_enabled
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"  * opmode=%u"
argument_list|,
name|params
operator|->
name|vht_opmode
argument_list|)
expr_stmt|;
if|if
condition|(
name|nla_put_u8
argument_list|(
name|msg
argument_list|,
name|NL80211_ATTR_OPMODE_NOTIF
argument_list|,
name|params
operator|->
name|vht_opmode
argument_list|)
condition|)
goto|goto
name|fail
goto|;
block|}
if|if
condition|(
name|params
operator|->
name|supp_channels
condition|)
block|{
name|wpa_hexdump
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"  * supported channels"
argument_list|,
name|params
operator|->
name|supp_channels
argument_list|,
name|params
operator|->
name|supp_channels_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|nla_put
argument_list|(
name|msg
argument_list|,
name|NL80211_ATTR_STA_SUPPORTED_CHANNELS
argument_list|,
name|params
operator|->
name|supp_channels_len
argument_list|,
name|params
operator|->
name|supp_channels
argument_list|)
condition|)
goto|goto
name|fail
goto|;
block|}
if|if
condition|(
name|params
operator|->
name|supp_oper_classes
condition|)
block|{
name|wpa_hexdump
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"  * supported operating classes"
argument_list|,
name|params
operator|->
name|supp_oper_classes
argument_list|,
name|params
operator|->
name|supp_oper_classes_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|nla_put
argument_list|(
name|msg
argument_list|,
name|NL80211_ATTR_STA_SUPPORTED_OPER_CLASSES
argument_list|,
name|params
operator|->
name|supp_oper_classes_len
argument_list|,
name|params
operator|->
name|supp_oper_classes
argument_list|)
condition|)
goto|goto
name|fail
goto|;
block|}
name|os_memset
argument_list|(
operator|&
name|upd
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|upd
argument_list|)
argument_list|)
expr_stmt|;
name|upd
operator|.
name|set
operator|=
name|sta_flags_nl80211
argument_list|(
name|params
operator|->
name|flags
argument_list|)
expr_stmt|;
name|upd
operator|.
name|mask
operator|=
name|upd
operator|.
name|set
operator||
name|sta_flags_nl80211
argument_list|(
name|params
operator|->
name|flags_mask
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"  * flags set=0x%x mask=0x%x"
argument_list|,
name|upd
operator|.
name|set
argument_list|,
name|upd
operator|.
name|mask
argument_list|)
expr_stmt|;
if|if
condition|(
name|nla_put
argument_list|(
name|msg
argument_list|,
name|NL80211_ATTR_STA_FLAGS2
argument_list|,
sizeof|sizeof
argument_list|(
name|upd
argument_list|)
argument_list|,
operator|&
name|upd
argument_list|)
condition|)
goto|goto
name|fail
goto|;
ifdef|#
directive|ifdef
name|CONFIG_MESH
if|if
condition|(
name|params
operator|->
name|plink_state
operator|&&
name|nla_put_u8
argument_list|(
name|msg
argument_list|,
name|NL80211_ATTR_STA_PLINK_STATE
argument_list|,
name|sta_plink_state_nl80211
argument_list|(
name|params
operator|->
name|plink_state
argument_list|)
argument_list|)
condition|)
goto|goto
name|fail
goto|;
endif|#
directive|endif
comment|/* CONFIG_MESH */
if|if
condition|(
name|params
operator|->
name|flags
operator|&
name|WPA_STA_WMM
condition|)
block|{
name|struct
name|nlattr
modifier|*
name|wme
init|=
name|nla_nest_start
argument_list|(
name|msg
argument_list|,
name|NL80211_ATTR_STA_WME
argument_list|)
decl_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"  * qosinfo=0x%x"
argument_list|,
name|params
operator|->
name|qosinfo
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|wme
operator|||
name|nla_put_u8
argument_list|(
name|msg
argument_list|,
name|NL80211_STA_WME_UAPSD_QUEUES
argument_list|,
name|params
operator|->
name|qosinfo
operator|&
name|WMM_QOSINFO_STA_AC_MASK
argument_list|)
operator|||
name|nla_put_u8
argument_list|(
name|msg
argument_list|,
name|NL80211_STA_WME_MAX_SP
argument_list|,
operator|(
name|params
operator|->
name|qosinfo
operator|>>
name|WMM_QOSINFO_STA_SP_SHIFT
operator|)
operator|&
name|WMM_QOSINFO_STA_SP_MASK
argument_list|)
condition|)
goto|goto
name|fail
goto|;
name|nla_nest_end
argument_list|(
name|msg
argument_list|,
name|wme
argument_list|)
expr_stmt|;
block|}
name|ret
operator|=
name|send_and_recv_msgs
argument_list|(
name|drv
argument_list|,
name|msg
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|msg
operator|=
name|NULL
expr_stmt|;
if|if
condition|(
name|ret
condition|)
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"nl80211: NL80211_CMD_%s_STATION "
literal|"result: %d (%s)"
argument_list|,
name|params
operator|->
name|set
condition|?
literal|"SET"
else|:
literal|"NEW"
argument_list|,
name|ret
argument_list|,
name|strerror
argument_list|(
operator|-
name|ret
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|==
operator|-
name|EEXIST
condition|)
name|ret
operator|=
literal|0
expr_stmt|;
name|fail
label|:
name|nlmsg_free
argument_list|(
name|msg
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|rtnl_neigh_delete_fdb_entry
parameter_list|(
name|struct
name|i802_bss
modifier|*
name|bss
parameter_list|,
specifier|const
name|u8
modifier|*
name|addr
parameter_list|)
block|{
ifdef|#
directive|ifdef
name|CONFIG_LIBNL3_ROUTE
name|struct
name|wpa_driver_nl80211_data
modifier|*
name|drv
init|=
name|bss
operator|->
name|drv
decl_stmt|;
name|struct
name|rtnl_neigh
modifier|*
name|rn
decl_stmt|;
name|struct
name|nl_addr
modifier|*
name|nl_addr
decl_stmt|;
name|int
name|err
decl_stmt|;
name|rn
operator|=
name|rtnl_neigh_alloc
argument_list|()
expr_stmt|;
if|if
condition|(
operator|!
name|rn
condition|)
return|return;
name|rtnl_neigh_set_family
argument_list|(
name|rn
argument_list|,
name|AF_BRIDGE
argument_list|)
expr_stmt|;
name|rtnl_neigh_set_ifindex
argument_list|(
name|rn
argument_list|,
name|bss
operator|->
name|ifindex
argument_list|)
expr_stmt|;
name|nl_addr
operator|=
name|nl_addr_build
argument_list|(
name|AF_BRIDGE
argument_list|,
operator|(
name|void
operator|*
operator|)
name|addr
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|nl_addr
condition|)
block|{
name|rtnl_neigh_put
argument_list|(
name|rn
argument_list|)
expr_stmt|;
return|return;
block|}
name|rtnl_neigh_set_lladdr
argument_list|(
name|rn
argument_list|,
name|nl_addr
argument_list|)
expr_stmt|;
name|err
operator|=
name|rtnl_neigh_delete
argument_list|(
name|drv
operator|->
name|rtnl_sk
argument_list|,
name|rn
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
operator|<
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"nl80211: bridge FDB entry delete for "
name|MACSTR
literal|" ifindex=%d failed: %s"
argument_list|,
name|MAC2STR
argument_list|(
name|addr
argument_list|)
argument_list|,
name|bss
operator|->
name|ifindex
argument_list|,
name|nl_geterror
argument_list|(
name|err
argument_list|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"nl80211: deleted bridge FDB entry for "
name|MACSTR
argument_list|,
name|MAC2STR
argument_list|(
name|addr
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|nl_addr_put
argument_list|(
name|nl_addr
argument_list|)
expr_stmt|;
name|rtnl_neigh_put
argument_list|(
name|rn
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* CONFIG_LIBNL3_ROUTE */
block|}
end_function

begin_function
specifier|static
name|int
name|wpa_driver_nl80211_sta_remove
parameter_list|(
name|struct
name|i802_bss
modifier|*
name|bss
parameter_list|,
specifier|const
name|u8
modifier|*
name|addr
parameter_list|,
name|int
name|deauth
parameter_list|,
name|u16
name|reason_code
parameter_list|)
block|{
name|struct
name|wpa_driver_nl80211_data
modifier|*
name|drv
init|=
name|bss
operator|->
name|drv
decl_stmt|;
name|struct
name|nl_msg
modifier|*
name|msg
decl_stmt|;
name|int
name|ret
decl_stmt|;
if|if
condition|(
operator|!
operator|(
name|msg
operator|=
name|nl80211_bss_msg
argument_list|(
name|bss
argument_list|,
literal|0
argument_list|,
name|NL80211_CMD_DEL_STATION
argument_list|)
operator|)
operator|||
name|nla_put
argument_list|(
name|msg
argument_list|,
name|NL80211_ATTR_MAC
argument_list|,
name|ETH_ALEN
argument_list|,
name|addr
argument_list|)
operator|||
operator|(
name|deauth
operator|==
literal|0
operator|&&
name|nla_put_u8
argument_list|(
name|msg
argument_list|,
name|NL80211_ATTR_MGMT_SUBTYPE
argument_list|,
name|WLAN_FC_STYPE_DISASSOC
argument_list|)
operator|)
operator|||
operator|(
name|deauth
operator|==
literal|1
operator|&&
name|nla_put_u8
argument_list|(
name|msg
argument_list|,
name|NL80211_ATTR_MGMT_SUBTYPE
argument_list|,
name|WLAN_FC_STYPE_DEAUTH
argument_list|)
operator|)
operator|||
operator|(
name|reason_code
operator|&&
name|nla_put_u16
argument_list|(
name|msg
argument_list|,
name|NL80211_ATTR_REASON_CODE
argument_list|,
name|reason_code
argument_list|)
operator|)
condition|)
block|{
name|nlmsg_free
argument_list|(
name|msg
argument_list|)
expr_stmt|;
return|return
operator|-
name|ENOBUFS
return|;
block|}
name|ret
operator|=
name|send_and_recv_msgs
argument_list|(
name|drv
argument_list|,
name|msg
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"nl80211: sta_remove -> DEL_STATION %s "
name|MACSTR
literal|" --> %d (%s)"
argument_list|,
name|bss
operator|->
name|ifname
argument_list|,
name|MAC2STR
argument_list|(
name|addr
argument_list|)
argument_list|,
name|ret
argument_list|,
name|strerror
argument_list|(
operator|-
name|ret
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|drv
operator|->
name|rtnl_sk
condition|)
name|rtnl_neigh_delete_fdb_entry
argument_list|(
name|bss
argument_list|,
name|addr
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|==
operator|-
name|ENOENT
condition|)
return|return
literal|0
return|;
return|return
name|ret
return|;
block|}
end_function

begin_function
name|void
name|nl80211_remove_iface
parameter_list|(
name|struct
name|wpa_driver_nl80211_data
modifier|*
name|drv
parameter_list|,
name|int
name|ifidx
parameter_list|)
block|{
name|struct
name|nl_msg
modifier|*
name|msg
decl_stmt|;
name|struct
name|wpa_driver_nl80211_data
modifier|*
name|drv2
decl_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"nl80211: Remove interface ifindex=%d"
argument_list|,
name|ifidx
argument_list|)
expr_stmt|;
comment|/* stop listening for EAPOL on this interface */
name|dl_list_for_each
argument_list|(
argument|drv2
argument_list|,
argument|&drv->global->interfaces
argument_list|,
argument|struct wpa_driver_nl80211_data
argument_list|,
argument|list
argument_list|)
name|del_ifidx
argument_list|(
name|drv2
argument_list|,
name|ifidx
argument_list|)
expr_stmt|;
name|msg
operator|=
name|nl80211_ifindex_msg
argument_list|(
name|drv
argument_list|,
name|ifidx
argument_list|,
literal|0
argument_list|,
name|NL80211_CMD_DEL_INTERFACE
argument_list|)
expr_stmt|;
if|if
condition|(
name|send_and_recv_msgs
argument_list|(
name|drv
argument_list|,
name|msg
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
operator|==
literal|0
condition|)
return|return;
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"Failed to remove interface (ifidx=%d)"
argument_list|,
name|ifidx
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
specifier|const
name|char
modifier|*
name|nl80211_iftype_str
parameter_list|(
name|enum
name|nl80211_iftype
name|mode
parameter_list|)
block|{
switch|switch
condition|(
name|mode
condition|)
block|{
case|case
name|NL80211_IFTYPE_ADHOC
case|:
return|return
literal|"ADHOC"
return|;
case|case
name|NL80211_IFTYPE_STATION
case|:
return|return
literal|"STATION"
return|;
case|case
name|NL80211_IFTYPE_AP
case|:
return|return
literal|"AP"
return|;
case|case
name|NL80211_IFTYPE_AP_VLAN
case|:
return|return
literal|"AP_VLAN"
return|;
case|case
name|NL80211_IFTYPE_WDS
case|:
return|return
literal|"WDS"
return|;
case|case
name|NL80211_IFTYPE_MONITOR
case|:
return|return
literal|"MONITOR"
return|;
case|case
name|NL80211_IFTYPE_MESH_POINT
case|:
return|return
literal|"MESH_POINT"
return|;
case|case
name|NL80211_IFTYPE_P2P_CLIENT
case|:
return|return
literal|"P2P_CLIENT"
return|;
case|case
name|NL80211_IFTYPE_P2P_GO
case|:
return|return
literal|"P2P_GO"
return|;
case|case
name|NL80211_IFTYPE_P2P_DEVICE
case|:
return|return
literal|"P2P_DEVICE"
return|;
default|default:
return|return
literal|"unknown"
return|;
block|}
block|}
end_function

begin_function
specifier|static
name|int
name|nl80211_create_iface_once
parameter_list|(
name|struct
name|wpa_driver_nl80211_data
modifier|*
name|drv
parameter_list|,
specifier|const
name|char
modifier|*
name|ifname
parameter_list|,
name|enum
name|nl80211_iftype
name|iftype
parameter_list|,
specifier|const
name|u8
modifier|*
name|addr
parameter_list|,
name|int
name|wds
parameter_list|,
name|int
function_decl|(
modifier|*
name|handler
function_decl|)
parameter_list|(
name|struct
name|nl_msg
modifier|*
parameter_list|,
name|void
modifier|*
parameter_list|)
parameter_list|,
name|void
modifier|*
name|arg
parameter_list|)
block|{
name|struct
name|nl_msg
modifier|*
name|msg
decl_stmt|;
name|int
name|ifidx
decl_stmt|;
name|int
name|ret
init|=
operator|-
name|ENOBUFS
decl_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"nl80211: Create interface iftype %d (%s)"
argument_list|,
name|iftype
argument_list|,
name|nl80211_iftype_str
argument_list|(
name|iftype
argument_list|)
argument_list|)
expr_stmt|;
name|msg
operator|=
name|nl80211_cmd_msg
argument_list|(
name|drv
operator|->
name|first_bss
argument_list|,
literal|0
argument_list|,
name|NL80211_CMD_NEW_INTERFACE
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|msg
operator|||
name|nla_put_string
argument_list|(
name|msg
argument_list|,
name|NL80211_ATTR_IFNAME
argument_list|,
name|ifname
argument_list|)
operator|||
name|nla_put_u32
argument_list|(
name|msg
argument_list|,
name|NL80211_ATTR_IFTYPE
argument_list|,
name|iftype
argument_list|)
condition|)
goto|goto
name|fail
goto|;
if|if
condition|(
name|iftype
operator|==
name|NL80211_IFTYPE_MONITOR
condition|)
block|{
name|struct
name|nlattr
modifier|*
name|flags
decl_stmt|;
name|flags
operator|=
name|nla_nest_start
argument_list|(
name|msg
argument_list|,
name|NL80211_ATTR_MNTR_FLAGS
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|flags
operator|||
name|nla_put_flag
argument_list|(
name|msg
argument_list|,
name|NL80211_MNTR_FLAG_COOK_FRAMES
argument_list|)
condition|)
goto|goto
name|fail
goto|;
name|nla_nest_end
argument_list|(
name|msg
argument_list|,
name|flags
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|wds
condition|)
block|{
if|if
condition|(
name|nla_put_u8
argument_list|(
name|msg
argument_list|,
name|NL80211_ATTR_4ADDR
argument_list|,
name|wds
argument_list|)
condition|)
goto|goto
name|fail
goto|;
block|}
comment|/* 	 * Tell cfg80211 that the interface belongs to the socket that created 	 * it, and the interface should be deleted when the socket is closed. 	 */
if|if
condition|(
name|nla_put_flag
argument_list|(
name|msg
argument_list|,
name|NL80211_ATTR_IFACE_SOCKET_OWNER
argument_list|)
condition|)
goto|goto
name|fail
goto|;
name|ret
operator|=
name|send_and_recv_msgs
argument_list|(
name|drv
argument_list|,
name|msg
argument_list|,
name|handler
argument_list|,
name|arg
argument_list|)
expr_stmt|;
name|msg
operator|=
name|NULL
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|fail
label|:
name|nlmsg_free
argument_list|(
name|msg
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"Failed to create interface %s: %d (%s)"
argument_list|,
name|ifname
argument_list|,
name|ret
argument_list|,
name|strerror
argument_list|(
operator|-
name|ret
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
if|if
condition|(
name|iftype
operator|==
name|NL80211_IFTYPE_P2P_DEVICE
condition|)
return|return
literal|0
return|;
name|ifidx
operator|=
name|if_nametoindex
argument_list|(
name|ifname
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"nl80211: New interface %s created: ifindex=%d"
argument_list|,
name|ifname
argument_list|,
name|ifidx
argument_list|)
expr_stmt|;
if|if
condition|(
name|ifidx
operator|<=
literal|0
condition|)
return|return
operator|-
literal|1
return|;
comment|/* 	 * Some virtual interfaces need to process EAPOL packets and events on 	 * the parent interface. This is used mainly with hostapd. 	 */
if|if
condition|(
name|drv
operator|->
name|hostapd
operator|||
name|iftype
operator|==
name|NL80211_IFTYPE_AP_VLAN
operator|||
name|iftype
operator|==
name|NL80211_IFTYPE_WDS
operator|||
name|iftype
operator|==
name|NL80211_IFTYPE_MONITOR
condition|)
block|{
comment|/* start listening for EAPOL on this interface */
name|add_ifidx
argument_list|(
name|drv
argument_list|,
name|ifidx
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|addr
operator|&&
name|iftype
operator|!=
name|NL80211_IFTYPE_MONITOR
operator|&&
name|linux_set_ifhwaddr
argument_list|(
name|drv
operator|->
name|global
operator|->
name|ioctl_sock
argument_list|,
name|ifname
argument_list|,
name|addr
argument_list|)
condition|)
block|{
name|nl80211_remove_iface
argument_list|(
name|drv
argument_list|,
name|ifidx
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
return|return
name|ifidx
return|;
block|}
end_function

begin_function
name|int
name|nl80211_create_iface
parameter_list|(
name|struct
name|wpa_driver_nl80211_data
modifier|*
name|drv
parameter_list|,
specifier|const
name|char
modifier|*
name|ifname
parameter_list|,
name|enum
name|nl80211_iftype
name|iftype
parameter_list|,
specifier|const
name|u8
modifier|*
name|addr
parameter_list|,
name|int
name|wds
parameter_list|,
name|int
function_decl|(
modifier|*
name|handler
function_decl|)
parameter_list|(
name|struct
name|nl_msg
modifier|*
parameter_list|,
name|void
modifier|*
parameter_list|)
parameter_list|,
name|void
modifier|*
name|arg
parameter_list|,
name|int
name|use_existing
parameter_list|)
block|{
name|int
name|ret
decl_stmt|;
name|ret
operator|=
name|nl80211_create_iface_once
argument_list|(
name|drv
argument_list|,
name|ifname
argument_list|,
name|iftype
argument_list|,
name|addr
argument_list|,
name|wds
argument_list|,
name|handler
argument_list|,
name|arg
argument_list|)
expr_stmt|;
comment|/* if error occurred and interface exists already */
if|if
condition|(
name|ret
operator|==
operator|-
name|ENFILE
operator|&&
name|if_nametoindex
argument_list|(
name|ifname
argument_list|)
condition|)
block|{
if|if
condition|(
name|use_existing
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"nl80211: Continue using existing interface %s"
argument_list|,
name|ifname
argument_list|)
expr_stmt|;
if|if
condition|(
name|addr
operator|&&
name|iftype
operator|!=
name|NL80211_IFTYPE_MONITOR
operator|&&
name|linux_set_ifhwaddr
argument_list|(
name|drv
operator|->
name|global
operator|->
name|ioctl_sock
argument_list|,
name|ifname
argument_list|,
name|addr
argument_list|)
operator|<
literal|0
operator|&&
operator|(
name|linux_set_iface_flags
argument_list|(
name|drv
operator|->
name|global
operator|->
name|ioctl_sock
argument_list|,
name|ifname
argument_list|,
literal|0
argument_list|)
operator|<
literal|0
operator|||
name|linux_set_ifhwaddr
argument_list|(
name|drv
operator|->
name|global
operator|->
name|ioctl_sock
argument_list|,
name|ifname
argument_list|,
name|addr
argument_list|)
operator|<
literal|0
operator|||
name|linux_set_iface_flags
argument_list|(
name|drv
operator|->
name|global
operator|->
name|ioctl_sock
argument_list|,
name|ifname
argument_list|,
literal|1
argument_list|)
operator|<
literal|0
operator|)
condition|)
return|return
operator|-
literal|1
return|;
return|return
operator|-
name|ENFILE
return|;
block|}
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"Try to remove and re-create %s"
argument_list|,
name|ifname
argument_list|)
expr_stmt|;
comment|/* Try to remove the interface that was already there. */
name|nl80211_remove_iface
argument_list|(
name|drv
argument_list|,
name|if_nametoindex
argument_list|(
name|ifname
argument_list|)
argument_list|)
expr_stmt|;
comment|/* Try to create the interface again */
name|ret
operator|=
name|nl80211_create_iface_once
argument_list|(
name|drv
argument_list|,
name|ifname
argument_list|,
name|iftype
argument_list|,
name|addr
argument_list|,
name|wds
argument_list|,
name|handler
argument_list|,
name|arg
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|ret
operator|>=
literal|0
operator|&&
name|is_p2p_net_interface
argument_list|(
name|iftype
argument_list|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"nl80211: Interface %s created for P2P - disable 11b rates"
argument_list|,
name|ifname
argument_list|)
expr_stmt|;
name|nl80211_disable_11b_rates
argument_list|(
name|drv
argument_list|,
name|ret
argument_list|,
literal|1
argument_list|)
expr_stmt|;
block|}
return|return
name|ret
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|nl80211_setup_ap
parameter_list|(
name|struct
name|i802_bss
modifier|*
name|bss
parameter_list|)
block|{
name|struct
name|wpa_driver_nl80211_data
modifier|*
name|drv
init|=
name|bss
operator|->
name|drv
decl_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"nl80211: Setup AP(%s) - device_ap_sme=%d use_monitor=%d"
argument_list|,
name|bss
operator|->
name|ifname
argument_list|,
name|drv
operator|->
name|device_ap_sme
argument_list|,
name|drv
operator|->
name|use_monitor
argument_list|)
expr_stmt|;
comment|/* 	 * Disable Probe Request reporting unless we need it in this way for 	 * devices that include the AP SME, in the other case (unless using 	 * monitor iface) we'll get it through the nl_mgmt socket instead. 	 */
if|if
condition|(
operator|!
name|drv
operator|->
name|device_ap_sme
condition|)
name|wpa_driver_nl80211_probe_req_report
argument_list|(
name|bss
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|drv
operator|->
name|device_ap_sme
operator|&&
operator|!
name|drv
operator|->
name|use_monitor
condition|)
if|if
condition|(
name|nl80211_mgmt_subscribe_ap
argument_list|(
name|bss
argument_list|)
condition|)
return|return
operator|-
literal|1
return|;
if|if
condition|(
name|drv
operator|->
name|device_ap_sme
operator|&&
operator|!
name|drv
operator|->
name|use_monitor
condition|)
if|if
condition|(
name|nl80211_mgmt_subscribe_ap_dev_sme
argument_list|(
name|bss
argument_list|)
condition|)
return|return
operator|-
literal|1
return|;
if|if
condition|(
operator|!
name|drv
operator|->
name|device_ap_sme
operator|&&
name|drv
operator|->
name|use_monitor
operator|&&
name|nl80211_create_monitor_interface
argument_list|(
name|drv
argument_list|)
operator|&&
operator|!
name|drv
operator|->
name|device_ap_sme
condition|)
return|return
operator|-
literal|1
return|;
if|if
condition|(
name|drv
operator|->
name|device_ap_sme
operator|&&
name|wpa_driver_nl80211_probe_req_report
argument_list|(
name|bss
argument_list|,
literal|1
argument_list|)
operator|<
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"nl80211: Failed to enable "
literal|"Probe Request frame reporting in AP mode"
argument_list|)
expr_stmt|;
comment|/* Try to survive without this */
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|nl80211_teardown_ap
parameter_list|(
name|struct
name|i802_bss
modifier|*
name|bss
parameter_list|)
block|{
name|struct
name|wpa_driver_nl80211_data
modifier|*
name|drv
init|=
name|bss
operator|->
name|drv
decl_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"nl80211: Teardown AP(%s) - device_ap_sme=%d use_monitor=%d"
argument_list|,
name|bss
operator|->
name|ifname
argument_list|,
name|drv
operator|->
name|device_ap_sme
argument_list|,
name|drv
operator|->
name|use_monitor
argument_list|)
expr_stmt|;
if|if
condition|(
name|drv
operator|->
name|device_ap_sme
condition|)
block|{
name|wpa_driver_nl80211_probe_req_report
argument_list|(
name|bss
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|drv
operator|->
name|use_monitor
condition|)
name|nl80211_mgmt_unsubscribe
argument_list|(
name|bss
argument_list|,
literal|"AP teardown (dev SME)"
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|drv
operator|->
name|use_monitor
condition|)
name|nl80211_remove_monitor_interface
argument_list|(
name|drv
argument_list|)
expr_stmt|;
else|else
name|nl80211_mgmt_unsubscribe
argument_list|(
name|bss
argument_list|,
literal|"AP teardown"
argument_list|)
expr_stmt|;
name|bss
operator|->
name|beacon_set
operator|=
literal|0
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|nl80211_send_eapol_data
parameter_list|(
name|struct
name|i802_bss
modifier|*
name|bss
parameter_list|,
specifier|const
name|u8
modifier|*
name|addr
parameter_list|,
specifier|const
name|u8
modifier|*
name|data
parameter_list|,
name|size_t
name|data_len
parameter_list|)
block|{
name|struct
name|sockaddr_ll
name|ll
decl_stmt|;
name|int
name|ret
decl_stmt|;
if|if
condition|(
name|bss
operator|->
name|drv
operator|->
name|eapol_tx_sock
operator|<
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"nl80211: No socket to send EAPOL"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|os_memset
argument_list|(
operator|&
name|ll
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|ll
argument_list|)
argument_list|)
expr_stmt|;
name|ll
operator|.
name|sll_family
operator|=
name|AF_PACKET
expr_stmt|;
name|ll
operator|.
name|sll_ifindex
operator|=
name|bss
operator|->
name|ifindex
expr_stmt|;
name|ll
operator|.
name|sll_protocol
operator|=
name|htons
argument_list|(
name|ETH_P_PAE
argument_list|)
expr_stmt|;
name|ll
operator|.
name|sll_halen
operator|=
name|ETH_ALEN
expr_stmt|;
name|os_memcpy
argument_list|(
name|ll
operator|.
name|sll_addr
argument_list|,
name|addr
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
name|ret
operator|=
name|sendto
argument_list|(
name|bss
operator|->
name|drv
operator|->
name|eapol_tx_sock
argument_list|,
name|data
argument_list|,
name|data_len
argument_list|,
literal|0
argument_list|,
operator|(
expr|struct
name|sockaddr
operator|*
operator|)
operator|&
name|ll
argument_list|,
sizeof|sizeof
argument_list|(
name|ll
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|<
literal|0
condition|)
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"nl80211: EAPOL TX: %s"
argument_list|,
name|strerror
argument_list|(
name|errno
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_decl_stmt
specifier|static
specifier|const
name|u8
name|rfc1042_header
index|[
literal|6
index|]
init|=
block|{
literal|0xaa
block|,
literal|0xaa
block|,
literal|0x03
block|,
literal|0x00
block|,
literal|0x00
block|,
literal|0x00
block|}
decl_stmt|;
end_decl_stmt

begin_function
specifier|static
name|int
name|wpa_driver_nl80211_hapd_send_eapol
parameter_list|(
name|void
modifier|*
name|priv
parameter_list|,
specifier|const
name|u8
modifier|*
name|addr
parameter_list|,
specifier|const
name|u8
modifier|*
name|data
parameter_list|,
name|size_t
name|data_len
parameter_list|,
name|int
name|encrypt
parameter_list|,
specifier|const
name|u8
modifier|*
name|own_addr
parameter_list|,
name|u32
name|flags
parameter_list|)
block|{
name|struct
name|i802_bss
modifier|*
name|bss
init|=
name|priv
decl_stmt|;
name|struct
name|wpa_driver_nl80211_data
modifier|*
name|drv
init|=
name|bss
operator|->
name|drv
decl_stmt|;
name|struct
name|ieee80211_hdr
modifier|*
name|hdr
decl_stmt|;
name|size_t
name|len
decl_stmt|;
name|u8
modifier|*
name|pos
decl_stmt|;
name|int
name|res
decl_stmt|;
name|int
name|qos
init|=
name|flags
operator|&
name|WPA_STA_WMM
decl_stmt|;
if|if
condition|(
name|drv
operator|->
name|device_ap_sme
operator|||
operator|!
name|drv
operator|->
name|use_monitor
condition|)
return|return
name|nl80211_send_eapol_data
argument_list|(
name|bss
argument_list|,
name|addr
argument_list|,
name|data
argument_list|,
name|data_len
argument_list|)
return|;
name|len
operator|=
sizeof|sizeof
argument_list|(
operator|*
name|hdr
argument_list|)
operator|+
operator|(
name|qos
condition|?
literal|2
else|:
literal|0
operator|)
operator|+
sizeof|sizeof
argument_list|(
name|rfc1042_header
argument_list|)
operator|+
literal|2
operator|+
name|data_len
expr_stmt|;
name|hdr
operator|=
name|os_zalloc
argument_list|(
name|len
argument_list|)
expr_stmt|;
if|if
condition|(
name|hdr
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"nl80211: Failed to allocate EAPOL buffer(len=%lu)"
argument_list|,
operator|(
name|unsigned
name|long
operator|)
name|len
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|hdr
operator|->
name|frame_control
operator|=
name|IEEE80211_FC
argument_list|(
name|WLAN_FC_TYPE_DATA
argument_list|,
name|WLAN_FC_STYPE_DATA
argument_list|)
expr_stmt|;
name|hdr
operator|->
name|frame_control
operator||=
name|host_to_le16
argument_list|(
name|WLAN_FC_FROMDS
argument_list|)
expr_stmt|;
if|if
condition|(
name|encrypt
condition|)
name|hdr
operator|->
name|frame_control
operator||=
name|host_to_le16
argument_list|(
name|WLAN_FC_ISWEP
argument_list|)
expr_stmt|;
if|if
condition|(
name|qos
condition|)
block|{
name|hdr
operator|->
name|frame_control
operator||=
name|host_to_le16
argument_list|(
name|WLAN_FC_STYPE_QOS_DATA
operator|<<
literal|4
argument_list|)
expr_stmt|;
block|}
name|memcpy
argument_list|(
name|hdr
operator|->
name|IEEE80211_DA_FROMDS
argument_list|,
name|addr
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
name|hdr
operator|->
name|IEEE80211_BSSID_FROMDS
argument_list|,
name|own_addr
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
name|hdr
operator|->
name|IEEE80211_SA_FROMDS
argument_list|,
name|own_addr
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
name|pos
operator|=
operator|(
name|u8
operator|*
operator|)
operator|(
name|hdr
operator|+
literal|1
operator|)
expr_stmt|;
if|if
condition|(
name|qos
condition|)
block|{
comment|/* Set highest priority in QoS header */
name|pos
index|[
literal|0
index|]
operator|=
literal|7
expr_stmt|;
name|pos
index|[
literal|1
index|]
operator|=
literal|0
expr_stmt|;
name|pos
operator|+=
literal|2
expr_stmt|;
block|}
name|memcpy
argument_list|(
name|pos
argument_list|,
name|rfc1042_header
argument_list|,
sizeof|sizeof
argument_list|(
name|rfc1042_header
argument_list|)
argument_list|)
expr_stmt|;
name|pos
operator|+=
sizeof|sizeof
argument_list|(
name|rfc1042_header
argument_list|)
expr_stmt|;
name|WPA_PUT_BE16
argument_list|(
name|pos
argument_list|,
name|ETH_P_PAE
argument_list|)
expr_stmt|;
name|pos
operator|+=
literal|2
expr_stmt|;
name|memcpy
argument_list|(
name|pos
argument_list|,
name|data
argument_list|,
name|data_len
argument_list|)
expr_stmt|;
name|res
operator|=
name|wpa_driver_nl80211_send_frame
argument_list|(
name|bss
argument_list|,
operator|(
name|u8
operator|*
operator|)
name|hdr
argument_list|,
name|len
argument_list|,
name|encrypt
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|res
operator|<
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"i802_send_eapol - packet len: %lu - "
literal|"failed: %d (%s)"
argument_list|,
operator|(
name|unsigned
name|long
operator|)
name|len
argument_list|,
name|errno
argument_list|,
name|strerror
argument_list|(
name|errno
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|os_free
argument_list|(
name|hdr
argument_list|)
expr_stmt|;
return|return
name|res
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|wpa_driver_nl80211_sta_set_flags
parameter_list|(
name|void
modifier|*
name|priv
parameter_list|,
specifier|const
name|u8
modifier|*
name|addr
parameter_list|,
name|int
name|total_flags
parameter_list|,
name|int
name|flags_or
parameter_list|,
name|int
name|flags_and
parameter_list|)
block|{
name|struct
name|i802_bss
modifier|*
name|bss
init|=
name|priv
decl_stmt|;
name|struct
name|nl_msg
modifier|*
name|msg
decl_stmt|;
name|struct
name|nlattr
modifier|*
name|flags
decl_stmt|;
name|struct
name|nl80211_sta_flag_update
name|upd
decl_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"nl80211: Set STA flags - ifname=%s addr="
name|MACSTR
literal|" total_flags=0x%x flags_or=0x%x flags_and=0x%x authorized=%d"
argument_list|,
name|bss
operator|->
name|ifname
argument_list|,
name|MAC2STR
argument_list|(
name|addr
argument_list|)
argument_list|,
name|total_flags
argument_list|,
name|flags_or
argument_list|,
name|flags_and
argument_list|,
operator|!
operator|!
operator|(
name|total_flags
operator|&
name|WPA_STA_AUTHORIZED
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|msg
operator|=
name|nl80211_bss_msg
argument_list|(
name|bss
argument_list|,
literal|0
argument_list|,
name|NL80211_CMD_SET_STATION
argument_list|)
operator|)
operator|||
name|nla_put
argument_list|(
name|msg
argument_list|,
name|NL80211_ATTR_MAC
argument_list|,
name|ETH_ALEN
argument_list|,
name|addr
argument_list|)
condition|)
goto|goto
name|fail
goto|;
comment|/* 	 * Backwards compatibility version using NL80211_ATTR_STA_FLAGS. This 	 * can be removed eventually. 	 */
name|flags
operator|=
name|nla_nest_start
argument_list|(
name|msg
argument_list|,
name|NL80211_ATTR_STA_FLAGS
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|flags
operator|||
operator|(
operator|(
name|total_flags
operator|&
name|WPA_STA_AUTHORIZED
operator|)
operator|&&
name|nla_put_flag
argument_list|(
name|msg
argument_list|,
name|NL80211_STA_FLAG_AUTHORIZED
argument_list|)
operator|)
operator|||
operator|(
operator|(
name|total_flags
operator|&
name|WPA_STA_WMM
operator|)
operator|&&
name|nla_put_flag
argument_list|(
name|msg
argument_list|,
name|NL80211_STA_FLAG_WME
argument_list|)
operator|)
operator|||
operator|(
operator|(
name|total_flags
operator|&
name|WPA_STA_SHORT_PREAMBLE
operator|)
operator|&&
name|nla_put_flag
argument_list|(
name|msg
argument_list|,
name|NL80211_STA_FLAG_SHORT_PREAMBLE
argument_list|)
operator|)
operator|||
operator|(
operator|(
name|total_flags
operator|&
name|WPA_STA_MFP
operator|)
operator|&&
name|nla_put_flag
argument_list|(
name|msg
argument_list|,
name|NL80211_STA_FLAG_MFP
argument_list|)
operator|)
operator|||
operator|(
operator|(
name|total_flags
operator|&
name|WPA_STA_TDLS_PEER
operator|)
operator|&&
name|nla_put_flag
argument_list|(
name|msg
argument_list|,
name|NL80211_STA_FLAG_TDLS_PEER
argument_list|)
operator|)
condition|)
goto|goto
name|fail
goto|;
name|nla_nest_end
argument_list|(
name|msg
argument_list|,
name|flags
argument_list|)
expr_stmt|;
name|os_memset
argument_list|(
operator|&
name|upd
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|upd
argument_list|)
argument_list|)
expr_stmt|;
name|upd
operator|.
name|mask
operator|=
name|sta_flags_nl80211
argument_list|(
name|flags_or
operator||
operator|~
name|flags_and
argument_list|)
expr_stmt|;
name|upd
operator|.
name|set
operator|=
name|sta_flags_nl80211
argument_list|(
name|flags_or
argument_list|)
expr_stmt|;
if|if
condition|(
name|nla_put
argument_list|(
name|msg
argument_list|,
name|NL80211_ATTR_STA_FLAGS2
argument_list|,
sizeof|sizeof
argument_list|(
name|upd
argument_list|)
argument_list|,
operator|&
name|upd
argument_list|)
condition|)
goto|goto
name|fail
goto|;
return|return
name|send_and_recv_msgs
argument_list|(
name|bss
operator|->
name|drv
argument_list|,
name|msg
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
return|;
name|fail
label|:
name|nlmsg_free
argument_list|(
name|msg
argument_list|)
expr_stmt|;
return|return
operator|-
name|ENOBUFS
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|wpa_driver_nl80211_ap
parameter_list|(
name|struct
name|wpa_driver_nl80211_data
modifier|*
name|drv
parameter_list|,
name|struct
name|wpa_driver_associate_params
modifier|*
name|params
parameter_list|)
block|{
name|enum
name|nl80211_iftype
name|nlmode
decl_stmt|,
name|old_mode
decl_stmt|;
if|if
condition|(
name|params
operator|->
name|p2p
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"nl80211: Setup AP operations for P2P "
literal|"group (GO)"
argument_list|)
expr_stmt|;
name|nlmode
operator|=
name|NL80211_IFTYPE_P2P_GO
expr_stmt|;
block|}
else|else
name|nlmode
operator|=
name|NL80211_IFTYPE_AP
expr_stmt|;
name|old_mode
operator|=
name|drv
operator|->
name|nlmode
expr_stmt|;
if|if
condition|(
name|wpa_driver_nl80211_set_mode
argument_list|(
name|drv
operator|->
name|first_bss
argument_list|,
name|nlmode
argument_list|)
condition|)
block|{
name|nl80211_remove_monitor_interface
argument_list|(
name|drv
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
if|if
condition|(
name|params
operator|->
name|freq
operator|.
name|freq
operator|&&
name|nl80211_set_channel
argument_list|(
name|drv
operator|->
name|first_bss
argument_list|,
operator|&
name|params
operator|->
name|freq
argument_list|,
literal|0
argument_list|)
condition|)
block|{
if|if
condition|(
name|old_mode
operator|!=
name|nlmode
condition|)
name|wpa_driver_nl80211_set_mode
argument_list|(
name|drv
operator|->
name|first_bss
argument_list|,
name|old_mode
argument_list|)
expr_stmt|;
name|nl80211_remove_monitor_interface
argument_list|(
name|drv
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|nl80211_leave_ibss
parameter_list|(
name|struct
name|wpa_driver_nl80211_data
modifier|*
name|drv
parameter_list|,
name|int
name|reset_mode
parameter_list|)
block|{
name|struct
name|nl_msg
modifier|*
name|msg
decl_stmt|;
name|int
name|ret
decl_stmt|;
name|msg
operator|=
name|nl80211_drv_msg
argument_list|(
name|drv
argument_list|,
literal|0
argument_list|,
name|NL80211_CMD_LEAVE_IBSS
argument_list|)
expr_stmt|;
name|ret
operator|=
name|send_and_recv_msgs
argument_list|(
name|drv
argument_list|,
name|msg
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"nl80211: Leave IBSS failed: ret=%d "
literal|"(%s)"
argument_list|,
name|ret
argument_list|,
name|strerror
argument_list|(
operator|-
name|ret
argument_list|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"nl80211: Leave IBSS request sent successfully"
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|reset_mode
operator|&&
name|wpa_driver_nl80211_set_mode
argument_list|(
name|drv
operator|->
name|first_bss
argument_list|,
name|NL80211_IFTYPE_STATION
argument_list|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"nl80211: Failed to set interface into "
literal|"station mode"
argument_list|)
expr_stmt|;
block|}
return|return
name|ret
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|nl80211_ht_vht_overrides
parameter_list|(
name|struct
name|nl_msg
modifier|*
name|msg
parameter_list|,
name|struct
name|wpa_driver_associate_params
modifier|*
name|params
parameter_list|)
block|{
if|if
condition|(
name|params
operator|->
name|disable_ht
operator|&&
name|nla_put_flag
argument_list|(
name|msg
argument_list|,
name|NL80211_ATTR_DISABLE_HT
argument_list|)
condition|)
return|return
operator|-
literal|1
return|;
if|if
condition|(
name|params
operator|->
name|htcaps
operator|&&
name|params
operator|->
name|htcaps_mask
condition|)
block|{
name|int
name|sz
init|=
sizeof|sizeof
argument_list|(
expr|struct
name|ieee80211_ht_capabilities
argument_list|)
decl_stmt|;
name|wpa_hexdump
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"  * htcaps"
argument_list|,
name|params
operator|->
name|htcaps
argument_list|,
name|sz
argument_list|)
expr_stmt|;
name|wpa_hexdump
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"  * htcaps_mask"
argument_list|,
name|params
operator|->
name|htcaps_mask
argument_list|,
name|sz
argument_list|)
expr_stmt|;
if|if
condition|(
name|nla_put
argument_list|(
name|msg
argument_list|,
name|NL80211_ATTR_HT_CAPABILITY
argument_list|,
name|sz
argument_list|,
name|params
operator|->
name|htcaps
argument_list|)
operator|||
name|nla_put
argument_list|(
name|msg
argument_list|,
name|NL80211_ATTR_HT_CAPABILITY_MASK
argument_list|,
name|sz
argument_list|,
name|params
operator|->
name|htcaps_mask
argument_list|)
condition|)
return|return
operator|-
literal|1
return|;
block|}
ifdef|#
directive|ifdef
name|CONFIG_VHT_OVERRIDES
if|if
condition|(
name|params
operator|->
name|disable_vht
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"  * VHT disabled"
argument_list|)
expr_stmt|;
if|if
condition|(
name|nla_put_flag
argument_list|(
name|msg
argument_list|,
name|NL80211_ATTR_DISABLE_VHT
argument_list|)
condition|)
return|return
operator|-
literal|1
return|;
block|}
if|if
condition|(
name|params
operator|->
name|vhtcaps
operator|&&
name|params
operator|->
name|vhtcaps_mask
condition|)
block|{
name|int
name|sz
init|=
sizeof|sizeof
argument_list|(
expr|struct
name|ieee80211_vht_capabilities
argument_list|)
decl_stmt|;
name|wpa_hexdump
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"  * vhtcaps"
argument_list|,
name|params
operator|->
name|vhtcaps
argument_list|,
name|sz
argument_list|)
expr_stmt|;
name|wpa_hexdump
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"  * vhtcaps_mask"
argument_list|,
name|params
operator|->
name|vhtcaps_mask
argument_list|,
name|sz
argument_list|)
expr_stmt|;
if|if
condition|(
name|nla_put
argument_list|(
name|msg
argument_list|,
name|NL80211_ATTR_VHT_CAPABILITY
argument_list|,
name|sz
argument_list|,
name|params
operator|->
name|vhtcaps
argument_list|)
operator|||
name|nla_put
argument_list|(
name|msg
argument_list|,
name|NL80211_ATTR_VHT_CAPABILITY_MASK
argument_list|,
name|sz
argument_list|,
name|params
operator|->
name|vhtcaps_mask
argument_list|)
condition|)
return|return
operator|-
literal|1
return|;
block|}
endif|#
directive|endif
comment|/* CONFIG_VHT_OVERRIDES */
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|wpa_driver_nl80211_ibss
parameter_list|(
name|struct
name|wpa_driver_nl80211_data
modifier|*
name|drv
parameter_list|,
name|struct
name|wpa_driver_associate_params
modifier|*
name|params
parameter_list|)
block|{
name|struct
name|nl_msg
modifier|*
name|msg
decl_stmt|;
name|int
name|ret
init|=
operator|-
literal|1
decl_stmt|;
name|int
name|count
init|=
literal|0
decl_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"nl80211: Join IBSS (ifindex=%d)"
argument_list|,
name|drv
operator|->
name|ifindex
argument_list|)
expr_stmt|;
if|if
condition|(
name|wpa_driver_nl80211_set_mode_ibss
argument_list|(
name|drv
operator|->
name|first_bss
argument_list|,
operator|&
name|params
operator|->
name|freq
argument_list|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"nl80211: Failed to set interface into "
literal|"IBSS mode"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|retry
label|:
if|if
condition|(
operator|!
operator|(
name|msg
operator|=
name|nl80211_drv_msg
argument_list|(
name|drv
argument_list|,
literal|0
argument_list|,
name|NL80211_CMD_JOIN_IBSS
argument_list|)
operator|)
operator|||
name|params
operator|->
name|ssid
operator|==
name|NULL
operator|||
name|params
operator|->
name|ssid_len
operator|>
sizeof|sizeof
argument_list|(
name|drv
operator|->
name|ssid
argument_list|)
condition|)
goto|goto
name|fail
goto|;
name|wpa_hexdump_ascii
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"  * SSID"
argument_list|,
name|params
operator|->
name|ssid
argument_list|,
name|params
operator|->
name|ssid_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|nla_put
argument_list|(
name|msg
argument_list|,
name|NL80211_ATTR_SSID
argument_list|,
name|params
operator|->
name|ssid_len
argument_list|,
name|params
operator|->
name|ssid
argument_list|)
condition|)
goto|goto
name|fail
goto|;
name|os_memcpy
argument_list|(
name|drv
operator|->
name|ssid
argument_list|,
name|params
operator|->
name|ssid
argument_list|,
name|params
operator|->
name|ssid_len
argument_list|)
expr_stmt|;
name|drv
operator|->
name|ssid_len
operator|=
name|params
operator|->
name|ssid_len
expr_stmt|;
if|if
condition|(
name|nl80211_put_freq_params
argument_list|(
name|msg
argument_list|,
operator|&
name|params
operator|->
name|freq
argument_list|)
operator|<
literal|0
operator|||
name|nl80211_put_beacon_int
argument_list|(
name|msg
argument_list|,
name|params
operator|->
name|beacon_int
argument_list|)
condition|)
goto|goto
name|fail
goto|;
name|ret
operator|=
name|nl80211_set_conn_keys
argument_list|(
name|params
argument_list|,
name|msg
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
goto|goto
name|fail
goto|;
if|if
condition|(
name|params
operator|->
name|bssid
operator|&&
name|params
operator|->
name|fixed_bssid
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"  * BSSID="
name|MACSTR
argument_list|,
name|MAC2STR
argument_list|(
name|params
operator|->
name|bssid
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|nla_put
argument_list|(
name|msg
argument_list|,
name|NL80211_ATTR_MAC
argument_list|,
name|ETH_ALEN
argument_list|,
name|params
operator|->
name|bssid
argument_list|)
condition|)
goto|goto
name|fail
goto|;
block|}
if|if
condition|(
name|params
operator|->
name|fixed_freq
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"  * fixed_freq"
argument_list|)
expr_stmt|;
if|if
condition|(
name|nla_put_flag
argument_list|(
name|msg
argument_list|,
name|NL80211_ATTR_FREQ_FIXED
argument_list|)
condition|)
goto|goto
name|fail
goto|;
block|}
if|if
condition|(
name|params
operator|->
name|key_mgmt_suite
operator|==
name|WPA_KEY_MGMT_IEEE8021X
operator|||
name|params
operator|->
name|key_mgmt_suite
operator|==
name|WPA_KEY_MGMT_PSK
operator|||
name|params
operator|->
name|key_mgmt_suite
operator|==
name|WPA_KEY_MGMT_IEEE8021X_SHA256
operator|||
name|params
operator|->
name|key_mgmt_suite
operator|==
name|WPA_KEY_MGMT_PSK_SHA256
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"  * control port"
argument_list|)
expr_stmt|;
if|if
condition|(
name|nla_put_flag
argument_list|(
name|msg
argument_list|,
name|NL80211_ATTR_CONTROL_PORT
argument_list|)
condition|)
goto|goto
name|fail
goto|;
block|}
if|if
condition|(
name|params
operator|->
name|wpa_ie
condition|)
block|{
name|wpa_hexdump
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"  * Extra IEs for Beacon/Probe Response frames"
argument_list|,
name|params
operator|->
name|wpa_ie
argument_list|,
name|params
operator|->
name|wpa_ie_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|nla_put
argument_list|(
name|msg
argument_list|,
name|NL80211_ATTR_IE
argument_list|,
name|params
operator|->
name|wpa_ie_len
argument_list|,
name|params
operator|->
name|wpa_ie
argument_list|)
condition|)
goto|goto
name|fail
goto|;
block|}
if|if
condition|(
name|nl80211_ht_vht_overrides
argument_list|(
name|msg
argument_list|,
name|params
argument_list|)
operator|<
literal|0
condition|)
return|return
operator|-
literal|1
return|;
name|ret
operator|=
name|send_and_recv_msgs
argument_list|(
name|drv
argument_list|,
name|msg
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|msg
operator|=
name|NULL
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"nl80211: Join IBSS failed: ret=%d (%s)"
argument_list|,
name|ret
argument_list|,
name|strerror
argument_list|(
operator|-
name|ret
argument_list|)
argument_list|)
expr_stmt|;
name|count
operator|++
expr_stmt|;
if|if
condition|(
name|ret
operator|==
operator|-
name|EALREADY
operator|&&
name|count
operator|==
literal|1
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"nl80211: Retry IBSS join after "
literal|"forced leave"
argument_list|)
expr_stmt|;
name|nl80211_leave_ibss
argument_list|(
name|drv
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|nlmsg_free
argument_list|(
name|msg
argument_list|)
expr_stmt|;
goto|goto
name|retry
goto|;
block|}
block|}
else|else
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"nl80211: Join IBSS request sent successfully"
argument_list|)
expr_stmt|;
block|}
name|fail
label|:
name|nlmsg_free
argument_list|(
name|msg
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|nl80211_connect_common
parameter_list|(
name|struct
name|wpa_driver_nl80211_data
modifier|*
name|drv
parameter_list|,
name|struct
name|wpa_driver_associate_params
modifier|*
name|params
parameter_list|,
name|struct
name|nl_msg
modifier|*
name|msg
parameter_list|)
block|{
if|if
condition|(
name|params
operator|->
name|bssid
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"  * bssid="
name|MACSTR
argument_list|,
name|MAC2STR
argument_list|(
name|params
operator|->
name|bssid
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|nla_put
argument_list|(
name|msg
argument_list|,
name|NL80211_ATTR_MAC
argument_list|,
name|ETH_ALEN
argument_list|,
name|params
operator|->
name|bssid
argument_list|)
condition|)
return|return
operator|-
literal|1
return|;
block|}
if|if
condition|(
name|params
operator|->
name|bssid_hint
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"  * bssid_hint="
name|MACSTR
argument_list|,
name|MAC2STR
argument_list|(
name|params
operator|->
name|bssid_hint
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|nla_put
argument_list|(
name|msg
argument_list|,
name|NL80211_ATTR_MAC_HINT
argument_list|,
name|ETH_ALEN
argument_list|,
name|params
operator|->
name|bssid_hint
argument_list|)
condition|)
return|return
operator|-
literal|1
return|;
block|}
if|if
condition|(
name|params
operator|->
name|freq
operator|.
name|freq
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"  * freq=%d"
argument_list|,
name|params
operator|->
name|freq
operator|.
name|freq
argument_list|)
expr_stmt|;
if|if
condition|(
name|nla_put_u32
argument_list|(
name|msg
argument_list|,
name|NL80211_ATTR_WIPHY_FREQ
argument_list|,
name|params
operator|->
name|freq
operator|.
name|freq
argument_list|)
condition|)
return|return
operator|-
literal|1
return|;
name|drv
operator|->
name|assoc_freq
operator|=
name|params
operator|->
name|freq
operator|.
name|freq
expr_stmt|;
block|}
else|else
name|drv
operator|->
name|assoc_freq
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|params
operator|->
name|freq_hint
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"  * freq_hint=%d"
argument_list|,
name|params
operator|->
name|freq_hint
argument_list|)
expr_stmt|;
if|if
condition|(
name|nla_put_u32
argument_list|(
name|msg
argument_list|,
name|NL80211_ATTR_WIPHY_FREQ_HINT
argument_list|,
name|params
operator|->
name|freq_hint
argument_list|)
condition|)
return|return
operator|-
literal|1
return|;
block|}
if|if
condition|(
name|params
operator|->
name|bg_scan_period
operator|>=
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"  * bg scan period=%d"
argument_list|,
name|params
operator|->
name|bg_scan_period
argument_list|)
expr_stmt|;
if|if
condition|(
name|nla_put_u16
argument_list|(
name|msg
argument_list|,
name|NL80211_ATTR_BG_SCAN_PERIOD
argument_list|,
name|params
operator|->
name|bg_scan_period
argument_list|)
condition|)
return|return
operator|-
literal|1
return|;
block|}
if|if
condition|(
name|params
operator|->
name|ssid
condition|)
block|{
name|wpa_hexdump_ascii
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"  * SSID"
argument_list|,
name|params
operator|->
name|ssid
argument_list|,
name|params
operator|->
name|ssid_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|nla_put
argument_list|(
name|msg
argument_list|,
name|NL80211_ATTR_SSID
argument_list|,
name|params
operator|->
name|ssid_len
argument_list|,
name|params
operator|->
name|ssid
argument_list|)
condition|)
return|return
operator|-
literal|1
return|;
if|if
condition|(
name|params
operator|->
name|ssid_len
operator|>
sizeof|sizeof
argument_list|(
name|drv
operator|->
name|ssid
argument_list|)
condition|)
return|return
operator|-
literal|1
return|;
name|os_memcpy
argument_list|(
name|drv
operator|->
name|ssid
argument_list|,
name|params
operator|->
name|ssid
argument_list|,
name|params
operator|->
name|ssid_len
argument_list|)
expr_stmt|;
name|drv
operator|->
name|ssid_len
operator|=
name|params
operator|->
name|ssid_len
expr_stmt|;
block|}
name|wpa_hexdump
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"  * IEs"
argument_list|,
name|params
operator|->
name|wpa_ie
argument_list|,
name|params
operator|->
name|wpa_ie_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|params
operator|->
name|wpa_ie
operator|&&
name|nla_put
argument_list|(
name|msg
argument_list|,
name|NL80211_ATTR_IE
argument_list|,
name|params
operator|->
name|wpa_ie_len
argument_list|,
name|params
operator|->
name|wpa_ie
argument_list|)
condition|)
return|return
operator|-
literal|1
return|;
if|if
condition|(
name|params
operator|->
name|wpa_proto
condition|)
block|{
name|enum
name|nl80211_wpa_versions
name|ver
init|=
literal|0
decl_stmt|;
if|if
condition|(
name|params
operator|->
name|wpa_proto
operator|&
name|WPA_PROTO_WPA
condition|)
name|ver
operator||=
name|NL80211_WPA_VERSION_1
expr_stmt|;
if|if
condition|(
name|params
operator|->
name|wpa_proto
operator|&
name|WPA_PROTO_RSN
condition|)
name|ver
operator||=
name|NL80211_WPA_VERSION_2
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"  * WPA Versions 0x%x"
argument_list|,
name|ver
argument_list|)
expr_stmt|;
if|if
condition|(
name|nla_put_u32
argument_list|(
name|msg
argument_list|,
name|NL80211_ATTR_WPA_VERSIONS
argument_list|,
name|ver
argument_list|)
condition|)
return|return
operator|-
literal|1
return|;
block|}
if|if
condition|(
name|params
operator|->
name|pairwise_suite
operator|!=
name|WPA_CIPHER_NONE
condition|)
block|{
name|u32
name|cipher
init|=
name|wpa_cipher_to_cipher_suite
argument_list|(
name|params
operator|->
name|pairwise_suite
argument_list|)
decl_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"  * pairwise=0x%x"
argument_list|,
name|cipher
argument_list|)
expr_stmt|;
if|if
condition|(
name|nla_put_u32
argument_list|(
name|msg
argument_list|,
name|NL80211_ATTR_CIPHER_SUITES_PAIRWISE
argument_list|,
name|cipher
argument_list|)
condition|)
return|return
operator|-
literal|1
return|;
block|}
if|if
condition|(
name|params
operator|->
name|group_suite
operator|==
name|WPA_CIPHER_GTK_NOT_USED
operator|&&
operator|!
operator|(
name|drv
operator|->
name|capa
operator|.
name|enc
operator|&
name|WPA_DRIVER_CAPA_ENC_GTK_NOT_USED
operator|)
condition|)
block|{
comment|/* 		 * This is likely to work even though many drivers do not 		 * advertise support for operations without GTK. 		 */
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"  * skip group cipher configuration for GTK_NOT_USED due to missing driver support advertisement"
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|params
operator|->
name|group_suite
operator|!=
name|WPA_CIPHER_NONE
condition|)
block|{
name|u32
name|cipher
init|=
name|wpa_cipher_to_cipher_suite
argument_list|(
name|params
operator|->
name|group_suite
argument_list|)
decl_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"  * group=0x%x"
argument_list|,
name|cipher
argument_list|)
expr_stmt|;
if|if
condition|(
name|nla_put_u32
argument_list|(
name|msg
argument_list|,
name|NL80211_ATTR_CIPHER_SUITE_GROUP
argument_list|,
name|cipher
argument_list|)
condition|)
return|return
operator|-
literal|1
return|;
block|}
if|if
condition|(
name|params
operator|->
name|key_mgmt_suite
operator|==
name|WPA_KEY_MGMT_IEEE8021X
operator|||
name|params
operator|->
name|key_mgmt_suite
operator|==
name|WPA_KEY_MGMT_PSK
operator|||
name|params
operator|->
name|key_mgmt_suite
operator|==
name|WPA_KEY_MGMT_FT_IEEE8021X
operator|||
name|params
operator|->
name|key_mgmt_suite
operator|==
name|WPA_KEY_MGMT_FT_PSK
operator|||
name|params
operator|->
name|key_mgmt_suite
operator|==
name|WPA_KEY_MGMT_CCKM
operator|||
name|params
operator|->
name|key_mgmt_suite
operator|==
name|WPA_KEY_MGMT_OSEN
operator|||
name|params
operator|->
name|key_mgmt_suite
operator|==
name|WPA_KEY_MGMT_IEEE8021X_SHA256
operator|||
name|params
operator|->
name|key_mgmt_suite
operator|==
name|WPA_KEY_MGMT_PSK_SHA256
operator|||
name|params
operator|->
name|key_mgmt_suite
operator|==
name|WPA_KEY_MGMT_IEEE8021X_SUITE_B
operator|||
name|params
operator|->
name|key_mgmt_suite
operator|==
name|WPA_KEY_MGMT_IEEE8021X_SUITE_B_192
condition|)
block|{
name|int
name|mgmt
init|=
name|WLAN_AKM_SUITE_PSK
decl_stmt|;
switch|switch
condition|(
name|params
operator|->
name|key_mgmt_suite
condition|)
block|{
case|case
name|WPA_KEY_MGMT_CCKM
case|:
name|mgmt
operator|=
name|WLAN_AKM_SUITE_CCKM
expr_stmt|;
break|break;
case|case
name|WPA_KEY_MGMT_IEEE8021X
case|:
name|mgmt
operator|=
name|WLAN_AKM_SUITE_8021X
expr_stmt|;
break|break;
case|case
name|WPA_KEY_MGMT_FT_IEEE8021X
case|:
name|mgmt
operator|=
name|WLAN_AKM_SUITE_FT_8021X
expr_stmt|;
break|break;
case|case
name|WPA_KEY_MGMT_FT_PSK
case|:
name|mgmt
operator|=
name|WLAN_AKM_SUITE_FT_PSK
expr_stmt|;
break|break;
case|case
name|WPA_KEY_MGMT_IEEE8021X_SHA256
case|:
name|mgmt
operator|=
name|WLAN_AKM_SUITE_8021X_SHA256
expr_stmt|;
break|break;
case|case
name|WPA_KEY_MGMT_PSK_SHA256
case|:
name|mgmt
operator|=
name|WLAN_AKM_SUITE_PSK_SHA256
expr_stmt|;
break|break;
case|case
name|WPA_KEY_MGMT_OSEN
case|:
name|mgmt
operator|=
name|WLAN_AKM_SUITE_OSEN
expr_stmt|;
break|break;
case|case
name|WPA_KEY_MGMT_IEEE8021X_SUITE_B
case|:
name|mgmt
operator|=
name|WLAN_AKM_SUITE_8021X_SUITE_B
expr_stmt|;
break|break;
case|case
name|WPA_KEY_MGMT_IEEE8021X_SUITE_B_192
case|:
name|mgmt
operator|=
name|WLAN_AKM_SUITE_8021X_SUITE_B_192
expr_stmt|;
break|break;
case|case
name|WPA_KEY_MGMT_PSK
case|:
default|default:
name|mgmt
operator|=
name|WLAN_AKM_SUITE_PSK
expr_stmt|;
break|break;
block|}
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"  * akm=0x%x"
argument_list|,
name|mgmt
argument_list|)
expr_stmt|;
if|if
condition|(
name|nla_put_u32
argument_list|(
name|msg
argument_list|,
name|NL80211_ATTR_AKM_SUITES
argument_list|,
name|mgmt
argument_list|)
condition|)
return|return
operator|-
literal|1
return|;
block|}
if|if
condition|(
name|nla_put_flag
argument_list|(
name|msg
argument_list|,
name|NL80211_ATTR_CONTROL_PORT
argument_list|)
condition|)
return|return
operator|-
literal|1
return|;
if|if
condition|(
name|params
operator|->
name|mgmt_frame_protection
operator|==
name|MGMT_FRAME_PROTECTION_REQUIRED
operator|&&
name|nla_put_u32
argument_list|(
name|msg
argument_list|,
name|NL80211_ATTR_USE_MFP
argument_list|,
name|NL80211_MFP_REQUIRED
argument_list|)
condition|)
return|return
operator|-
literal|1
return|;
if|if
condition|(
name|params
operator|->
name|rrm_used
condition|)
block|{
name|u32
name|drv_rrm_flags
init|=
name|drv
operator|->
name|capa
operator|.
name|rrm_flags
decl_stmt|;
if|if
condition|(
operator|!
operator|(
name|drv_rrm_flags
operator|&
name|WPA_DRIVER_FLAGS_DS_PARAM_SET_IE_IN_PROBES
operator|)
operator|||
operator|!
operator|(
name|drv_rrm_flags
operator|&
name|WPA_DRIVER_FLAGS_QUIET
operator|)
operator|||
name|nla_put_flag
argument_list|(
name|msg
argument_list|,
name|NL80211_ATTR_USE_RRM
argument_list|)
condition|)
return|return
operator|-
literal|1
return|;
block|}
if|if
condition|(
name|nl80211_ht_vht_overrides
argument_list|(
name|msg
argument_list|,
name|params
argument_list|)
operator|<
literal|0
condition|)
return|return
operator|-
literal|1
return|;
if|if
condition|(
name|params
operator|->
name|p2p
condition|)
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"  * P2P group"
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|wpa_driver_nl80211_try_connect
parameter_list|(
name|struct
name|wpa_driver_nl80211_data
modifier|*
name|drv
parameter_list|,
name|struct
name|wpa_driver_associate_params
modifier|*
name|params
parameter_list|)
block|{
name|struct
name|nl_msg
modifier|*
name|msg
decl_stmt|;
name|enum
name|nl80211_auth_type
name|type
decl_stmt|;
name|int
name|ret
decl_stmt|;
name|int
name|algs
decl_stmt|;
if|if
condition|(
name|params
operator|->
name|req_key_mgmt_offload
operator|&&
name|params
operator|->
name|psk
operator|&&
operator|(
name|params
operator|->
name|key_mgmt_suite
operator|==
name|WPA_KEY_MGMT_PSK
operator|||
name|params
operator|->
name|key_mgmt_suite
operator|==
name|WPA_KEY_MGMT_PSK_SHA256
operator|||
name|params
operator|->
name|key_mgmt_suite
operator|==
name|WPA_KEY_MGMT_FT_PSK
operator|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"nl80211: Key management set PSK"
argument_list|)
expr_stmt|;
name|ret
operator|=
name|issue_key_mgmt_set_key
argument_list|(
name|drv
argument_list|,
name|params
operator|->
name|psk
argument_list|,
literal|32
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
return|return
name|ret
return|;
block|}
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"nl80211: Connect (ifindex=%d)"
argument_list|,
name|drv
operator|->
name|ifindex
argument_list|)
expr_stmt|;
name|msg
operator|=
name|nl80211_drv_msg
argument_list|(
name|drv
argument_list|,
literal|0
argument_list|,
name|NL80211_CMD_CONNECT
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|msg
condition|)
return|return
operator|-
literal|1
return|;
name|ret
operator|=
name|nl80211_connect_common
argument_list|(
name|drv
argument_list|,
name|params
argument_list|,
name|msg
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
goto|goto
name|fail
goto|;
name|algs
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|params
operator|->
name|auth_alg
operator|&
name|WPA_AUTH_ALG_OPEN
condition|)
name|algs
operator|++
expr_stmt|;
if|if
condition|(
name|params
operator|->
name|auth_alg
operator|&
name|WPA_AUTH_ALG_SHARED
condition|)
name|algs
operator|++
expr_stmt|;
if|if
condition|(
name|params
operator|->
name|auth_alg
operator|&
name|WPA_AUTH_ALG_LEAP
condition|)
name|algs
operator|++
expr_stmt|;
if|if
condition|(
name|algs
operator|>
literal|1
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"  * Leave out Auth Type for automatic "
literal|"selection"
argument_list|)
expr_stmt|;
goto|goto
name|skip_auth_type
goto|;
block|}
if|if
condition|(
name|params
operator|->
name|auth_alg
operator|&
name|WPA_AUTH_ALG_OPEN
condition|)
name|type
operator|=
name|NL80211_AUTHTYPE_OPEN_SYSTEM
expr_stmt|;
elseif|else
if|if
condition|(
name|params
operator|->
name|auth_alg
operator|&
name|WPA_AUTH_ALG_SHARED
condition|)
name|type
operator|=
name|NL80211_AUTHTYPE_SHARED_KEY
expr_stmt|;
elseif|else
if|if
condition|(
name|params
operator|->
name|auth_alg
operator|&
name|WPA_AUTH_ALG_LEAP
condition|)
name|type
operator|=
name|NL80211_AUTHTYPE_NETWORK_EAP
expr_stmt|;
elseif|else
if|if
condition|(
name|params
operator|->
name|auth_alg
operator|&
name|WPA_AUTH_ALG_FT
condition|)
name|type
operator|=
name|NL80211_AUTHTYPE_FT
expr_stmt|;
else|else
goto|goto
name|fail
goto|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"  * Auth Type %d"
argument_list|,
name|type
argument_list|)
expr_stmt|;
if|if
condition|(
name|nla_put_u32
argument_list|(
name|msg
argument_list|,
name|NL80211_ATTR_AUTH_TYPE
argument_list|,
name|type
argument_list|)
condition|)
goto|goto
name|fail
goto|;
name|skip_auth_type
label|:
name|ret
operator|=
name|nl80211_set_conn_keys
argument_list|(
name|params
argument_list|,
name|msg
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
goto|goto
name|fail
goto|;
name|ret
operator|=
name|send_and_recv_msgs
argument_list|(
name|drv
argument_list|,
name|msg
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|msg
operator|=
name|NULL
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"nl80211: MLME connect failed: ret=%d "
literal|"(%s)"
argument_list|,
name|ret
argument_list|,
name|strerror
argument_list|(
operator|-
name|ret
argument_list|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"nl80211: Connect request send successfully"
argument_list|)
expr_stmt|;
block|}
name|fail
label|:
name|nlmsg_free
argument_list|(
name|msg
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|wpa_driver_nl80211_connect
parameter_list|(
name|struct
name|wpa_driver_nl80211_data
modifier|*
name|drv
parameter_list|,
name|struct
name|wpa_driver_associate_params
modifier|*
name|params
parameter_list|)
block|{
name|int
name|ret
decl_stmt|;
comment|/* Store the connection attempted bssid for future use */
if|if
condition|(
name|params
operator|->
name|bssid
condition|)
name|os_memcpy
argument_list|(
name|drv
operator|->
name|auth_attempt_bssid
argument_list|,
name|params
operator|->
name|bssid
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
else|else
name|os_memset
argument_list|(
name|drv
operator|->
name|auth_attempt_bssid
argument_list|,
literal|0
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
name|ret
operator|=
name|wpa_driver_nl80211_try_connect
argument_list|(
name|drv
argument_list|,
name|params
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|==
operator|-
name|EALREADY
condition|)
block|{
comment|/* 		 * cfg80211 does not currently accept new connections if 		 * we are already connected. As a workaround, force 		 * disconnection and try again. 		 */
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"nl80211: Explicitly "
literal|"disconnecting before reassociation "
literal|"attempt"
argument_list|)
expr_stmt|;
if|if
condition|(
name|wpa_driver_nl80211_disconnect
argument_list|(
name|drv
argument_list|,
name|WLAN_REASON_PREV_AUTH_NOT_VALID
argument_list|)
condition|)
return|return
operator|-
literal|1
return|;
name|ret
operator|=
name|wpa_driver_nl80211_try_connect
argument_list|(
name|drv
argument_list|,
name|params
argument_list|)
expr_stmt|;
block|}
return|return
name|ret
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|wpa_driver_nl80211_associate
parameter_list|(
name|void
modifier|*
name|priv
parameter_list|,
name|struct
name|wpa_driver_associate_params
modifier|*
name|params
parameter_list|)
block|{
name|struct
name|i802_bss
modifier|*
name|bss
init|=
name|priv
decl_stmt|;
name|struct
name|wpa_driver_nl80211_data
modifier|*
name|drv
init|=
name|bss
operator|->
name|drv
decl_stmt|;
name|int
name|ret
init|=
operator|-
literal|1
decl_stmt|;
name|struct
name|nl_msg
modifier|*
name|msg
decl_stmt|;
name|nl80211_unmask_11b_rates
argument_list|(
name|bss
argument_list|)
expr_stmt|;
if|if
condition|(
name|params
operator|->
name|mode
operator|==
name|IEEE80211_MODE_AP
condition|)
return|return
name|wpa_driver_nl80211_ap
argument_list|(
name|drv
argument_list|,
name|params
argument_list|)
return|;
if|if
condition|(
name|params
operator|->
name|mode
operator|==
name|IEEE80211_MODE_IBSS
condition|)
return|return
name|wpa_driver_nl80211_ibss
argument_list|(
name|drv
argument_list|,
name|params
argument_list|)
return|;
if|if
condition|(
operator|!
operator|(
name|drv
operator|->
name|capa
operator|.
name|flags
operator|&
name|WPA_DRIVER_FLAGS_SME
operator|)
condition|)
block|{
name|enum
name|nl80211_iftype
name|nlmode
init|=
name|params
operator|->
name|p2p
condition|?
name|NL80211_IFTYPE_P2P_CLIENT
else|:
name|NL80211_IFTYPE_STATION
decl_stmt|;
if|if
condition|(
name|wpa_driver_nl80211_set_mode
argument_list|(
name|priv
argument_list|,
name|nlmode
argument_list|)
operator|<
literal|0
condition|)
return|return
operator|-
literal|1
return|;
return|return
name|wpa_driver_nl80211_connect
argument_list|(
name|drv
argument_list|,
name|params
argument_list|)
return|;
block|}
name|nl80211_mark_disconnected
argument_list|(
name|drv
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"nl80211: Associate (ifindex=%d)"
argument_list|,
name|drv
operator|->
name|ifindex
argument_list|)
expr_stmt|;
name|msg
operator|=
name|nl80211_drv_msg
argument_list|(
name|drv
argument_list|,
literal|0
argument_list|,
name|NL80211_CMD_ASSOCIATE
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|msg
condition|)
return|return
operator|-
literal|1
return|;
name|ret
operator|=
name|nl80211_connect_common
argument_list|(
name|drv
argument_list|,
name|params
argument_list|,
name|msg
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
goto|goto
name|fail
goto|;
if|if
condition|(
name|params
operator|->
name|prev_bssid
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"  * prev_bssid="
name|MACSTR
argument_list|,
name|MAC2STR
argument_list|(
name|params
operator|->
name|prev_bssid
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|nla_put
argument_list|(
name|msg
argument_list|,
name|NL80211_ATTR_PREV_BSSID
argument_list|,
name|ETH_ALEN
argument_list|,
name|params
operator|->
name|prev_bssid
argument_list|)
condition|)
goto|goto
name|fail
goto|;
block|}
name|ret
operator|=
name|send_and_recv_msgs
argument_list|(
name|drv
argument_list|,
name|msg
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|msg
operator|=
name|NULL
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|wpa_dbg
argument_list|(
name|drv
operator|->
name|ctx
argument_list|,
name|MSG_DEBUG
argument_list|,
literal|"nl80211: MLME command failed (assoc): ret=%d (%s)"
argument_list|,
name|ret
argument_list|,
name|strerror
argument_list|(
operator|-
name|ret
argument_list|)
argument_list|)
expr_stmt|;
name|nl80211_dump_scan
argument_list|(
name|drv
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"nl80211: Association request send successfully"
argument_list|)
expr_stmt|;
block|}
name|fail
label|:
name|nlmsg_free
argument_list|(
name|msg
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|nl80211_set_mode
parameter_list|(
name|struct
name|wpa_driver_nl80211_data
modifier|*
name|drv
parameter_list|,
name|int
name|ifindex
parameter_list|,
name|enum
name|nl80211_iftype
name|mode
parameter_list|)
block|{
name|struct
name|nl_msg
modifier|*
name|msg
decl_stmt|;
name|int
name|ret
init|=
operator|-
name|ENOBUFS
decl_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"nl80211: Set mode ifindex %d iftype %d (%s)"
argument_list|,
name|ifindex
argument_list|,
name|mode
argument_list|,
name|nl80211_iftype_str
argument_list|(
name|mode
argument_list|)
argument_list|)
expr_stmt|;
name|msg
operator|=
name|nl80211_cmd_msg
argument_list|(
name|drv
operator|->
name|first_bss
argument_list|,
literal|0
argument_list|,
name|NL80211_CMD_SET_INTERFACE
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|msg
operator|||
name|nla_put_u32
argument_list|(
name|msg
argument_list|,
name|NL80211_ATTR_IFTYPE
argument_list|,
name|mode
argument_list|)
condition|)
goto|goto
name|fail
goto|;
name|ret
operator|=
name|send_and_recv_msgs
argument_list|(
name|drv
argument_list|,
name|msg
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|msg
operator|=
name|NULL
expr_stmt|;
if|if
condition|(
operator|!
name|ret
condition|)
return|return
literal|0
return|;
name|fail
label|:
name|nlmsg_free
argument_list|(
name|msg
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"nl80211: Failed to set interface %d to mode %d:"
literal|" %d (%s)"
argument_list|,
name|ifindex
argument_list|,
name|mode
argument_list|,
name|ret
argument_list|,
name|strerror
argument_list|(
operator|-
name|ret
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|wpa_driver_nl80211_set_mode_impl
parameter_list|(
name|struct
name|i802_bss
modifier|*
name|bss
parameter_list|,
name|enum
name|nl80211_iftype
name|nlmode
parameter_list|,
name|struct
name|hostapd_freq_params
modifier|*
name|desired_freq_params
parameter_list|)
block|{
name|struct
name|wpa_driver_nl80211_data
modifier|*
name|drv
init|=
name|bss
operator|->
name|drv
decl_stmt|;
name|int
name|ret
init|=
operator|-
literal|1
decl_stmt|;
name|int
name|i
decl_stmt|;
name|int
name|was_ap
init|=
name|is_ap_interface
argument_list|(
name|drv
operator|->
name|nlmode
argument_list|)
decl_stmt|;
name|int
name|res
decl_stmt|;
name|int
name|mode_switch_res
decl_stmt|;
name|mode_switch_res
operator|=
name|nl80211_set_mode
argument_list|(
name|drv
argument_list|,
name|drv
operator|->
name|ifindex
argument_list|,
name|nlmode
argument_list|)
expr_stmt|;
if|if
condition|(
name|mode_switch_res
operator|&&
name|nlmode
operator|==
name|nl80211_get_ifmode
argument_list|(
name|bss
argument_list|)
condition|)
name|mode_switch_res
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|mode_switch_res
operator|==
literal|0
condition|)
block|{
name|drv
operator|->
name|nlmode
operator|=
name|nlmode
expr_stmt|;
name|ret
operator|=
literal|0
expr_stmt|;
goto|goto
name|done
goto|;
block|}
if|if
condition|(
name|mode_switch_res
operator|==
operator|-
name|ENODEV
condition|)
return|return
operator|-
literal|1
return|;
if|if
condition|(
name|nlmode
operator|==
name|drv
operator|->
name|nlmode
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"nl80211: Interface already in "
literal|"requested mode - ignore error"
argument_list|)
expr_stmt|;
name|ret
operator|=
literal|0
expr_stmt|;
goto|goto
name|done
goto|;
comment|/* Already in the requested mode */
block|}
comment|/* mac80211 doesn't allow mode changes while the device is up, so 	 * take the device down, try to set the mode again, and bring the 	 * device back up. 	 */
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"nl80211: Try mode change after setting "
literal|"interface down"
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|10
condition|;
name|i
operator|++
control|)
block|{
name|res
operator|=
name|i802_set_iface_flags
argument_list|(
name|bss
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|res
operator|==
operator|-
name|EACCES
operator|||
name|res
operator|==
operator|-
name|ENODEV
condition|)
break|break;
if|if
condition|(
name|res
operator|!=
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"nl80211: Failed to set "
literal|"interface down"
argument_list|)
expr_stmt|;
name|os_sleep
argument_list|(
literal|0
argument_list|,
literal|100000
argument_list|)
expr_stmt|;
continue|continue;
block|}
comment|/* 		 * Setting the mode will fail for some drivers if the phy is 		 * on a frequency that the mode is disallowed in. 		 */
if|if
condition|(
name|desired_freq_params
condition|)
block|{
name|res
operator|=
name|nl80211_set_channel
argument_list|(
name|bss
argument_list|,
name|desired_freq_params
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|res
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"nl80211: Failed to set frequency on interface"
argument_list|)
expr_stmt|;
block|}
block|}
comment|/* Try to set the mode again while the interface is down */
name|mode_switch_res
operator|=
name|nl80211_set_mode
argument_list|(
name|drv
argument_list|,
name|drv
operator|->
name|ifindex
argument_list|,
name|nlmode
argument_list|)
expr_stmt|;
if|if
condition|(
name|mode_switch_res
operator|==
operator|-
name|EBUSY
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"nl80211: Delaying mode set while interface going down"
argument_list|)
expr_stmt|;
name|os_sleep
argument_list|(
literal|0
argument_list|,
literal|100000
argument_list|)
expr_stmt|;
continue|continue;
block|}
name|ret
operator|=
name|mode_switch_res
expr_stmt|;
break|break;
block|}
if|if
condition|(
operator|!
name|ret
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"nl80211: Mode change succeeded while "
literal|"interface is down"
argument_list|)
expr_stmt|;
name|drv
operator|->
name|nlmode
operator|=
name|nlmode
expr_stmt|;
name|drv
operator|->
name|ignore_if_down_event
operator|=
literal|1
expr_stmt|;
block|}
comment|/* Bring the interface back up */
name|res
operator|=
name|linux_set_iface_flags
argument_list|(
name|drv
operator|->
name|global
operator|->
name|ioctl_sock
argument_list|,
name|bss
operator|->
name|ifname
argument_list|,
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|res
operator|!=
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"nl80211: Failed to set interface up after switching mode"
argument_list|)
expr_stmt|;
name|ret
operator|=
operator|-
literal|1
expr_stmt|;
block|}
name|done
label|:
if|if
condition|(
name|ret
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"nl80211: Interface mode change to %d "
literal|"from %d failed"
argument_list|,
name|nlmode
argument_list|,
name|drv
operator|->
name|nlmode
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
if|if
condition|(
name|is_p2p_net_interface
argument_list|(
name|nlmode
argument_list|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"nl80211: Interface %s mode change to P2P - disable 11b rates"
argument_list|,
name|bss
operator|->
name|ifname
argument_list|)
expr_stmt|;
name|nl80211_disable_11b_rates
argument_list|(
name|drv
argument_list|,
name|drv
operator|->
name|ifindex
argument_list|,
literal|1
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|drv
operator|->
name|disabled_11b_rates
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"nl80211: Interface %s mode changed to non-P2P - re-enable 11b rates"
argument_list|,
name|bss
operator|->
name|ifname
argument_list|)
expr_stmt|;
name|nl80211_disable_11b_rates
argument_list|(
name|drv
argument_list|,
name|drv
operator|->
name|ifindex
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|is_ap_interface
argument_list|(
name|nlmode
argument_list|)
condition|)
block|{
name|nl80211_mgmt_unsubscribe
argument_list|(
name|bss
argument_list|,
literal|"start AP"
argument_list|)
expr_stmt|;
comment|/* Setup additional AP mode functionality if needed */
if|if
condition|(
name|nl80211_setup_ap
argument_list|(
name|bss
argument_list|)
condition|)
return|return
operator|-
literal|1
return|;
block|}
elseif|else
if|if
condition|(
name|was_ap
condition|)
block|{
comment|/* Remove additional AP mode functionality */
name|nl80211_teardown_ap
argument_list|(
name|bss
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|nl80211_mgmt_unsubscribe
argument_list|(
name|bss
argument_list|,
literal|"mode change"
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|is_mesh_interface
argument_list|(
name|nlmode
argument_list|)
operator|&&
name|nl80211_mgmt_subscribe_mesh
argument_list|(
name|bss
argument_list|)
condition|)
return|return
operator|-
literal|1
return|;
if|if
condition|(
operator|!
name|bss
operator|->
name|in_deinit
operator|&&
operator|!
name|is_ap_interface
argument_list|(
name|nlmode
argument_list|)
operator|&&
operator|!
name|is_mesh_interface
argument_list|(
name|nlmode
argument_list|)
operator|&&
name|nl80211_mgmt_subscribe_non_ap
argument_list|(
name|bss
argument_list|)
operator|<
literal|0
condition|)
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"nl80211: Failed to register Action "
literal|"frame processing - ignore for now"
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|int
name|wpa_driver_nl80211_set_mode
parameter_list|(
name|struct
name|i802_bss
modifier|*
name|bss
parameter_list|,
name|enum
name|nl80211_iftype
name|nlmode
parameter_list|)
block|{
return|return
name|wpa_driver_nl80211_set_mode_impl
argument_list|(
name|bss
argument_list|,
name|nlmode
argument_list|,
name|NULL
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|wpa_driver_nl80211_set_mode_ibss
parameter_list|(
name|struct
name|i802_bss
modifier|*
name|bss
parameter_list|,
name|struct
name|hostapd_freq_params
modifier|*
name|freq
parameter_list|)
block|{
return|return
name|wpa_driver_nl80211_set_mode_impl
argument_list|(
name|bss
argument_list|,
name|NL80211_IFTYPE_ADHOC
argument_list|,
name|freq
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|wpa_driver_nl80211_get_capa
parameter_list|(
name|void
modifier|*
name|priv
parameter_list|,
name|struct
name|wpa_driver_capa
modifier|*
name|capa
parameter_list|)
block|{
name|struct
name|i802_bss
modifier|*
name|bss
init|=
name|priv
decl_stmt|;
name|struct
name|wpa_driver_nl80211_data
modifier|*
name|drv
init|=
name|bss
operator|->
name|drv
decl_stmt|;
if|if
condition|(
operator|!
name|drv
operator|->
name|has_capability
condition|)
return|return
operator|-
literal|1
return|;
name|os_memcpy
argument_list|(
name|capa
argument_list|,
operator|&
name|drv
operator|->
name|capa
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|capa
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|drv
operator|->
name|extended_capa
operator|&&
name|drv
operator|->
name|extended_capa_mask
condition|)
block|{
name|capa
operator|->
name|extended_capa
operator|=
name|drv
operator|->
name|extended_capa
expr_stmt|;
name|capa
operator|->
name|extended_capa_mask
operator|=
name|drv
operator|->
name|extended_capa_mask
expr_stmt|;
name|capa
operator|->
name|extended_capa_len
operator|=
name|drv
operator|->
name|extended_capa_len
expr_stmt|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|wpa_driver_nl80211_set_operstate
parameter_list|(
name|void
modifier|*
name|priv
parameter_list|,
name|int
name|state
parameter_list|)
block|{
name|struct
name|i802_bss
modifier|*
name|bss
init|=
name|priv
decl_stmt|;
name|struct
name|wpa_driver_nl80211_data
modifier|*
name|drv
init|=
name|bss
operator|->
name|drv
decl_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"nl80211: Set %s operstate %d->%d (%s)"
argument_list|,
name|bss
operator|->
name|ifname
argument_list|,
name|drv
operator|->
name|operstate
argument_list|,
name|state
argument_list|,
name|state
condition|?
literal|"UP"
else|:
literal|"DORMANT"
argument_list|)
expr_stmt|;
name|drv
operator|->
name|operstate
operator|=
name|state
expr_stmt|;
return|return
name|netlink_send_oper_ifla
argument_list|(
name|drv
operator|->
name|global
operator|->
name|netlink
argument_list|,
name|drv
operator|->
name|ifindex
argument_list|,
operator|-
literal|1
argument_list|,
name|state
condition|?
name|IF_OPER_UP
else|:
name|IF_OPER_DORMANT
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|wpa_driver_nl80211_set_supp_port
parameter_list|(
name|void
modifier|*
name|priv
parameter_list|,
name|int
name|authorized
parameter_list|)
block|{
name|struct
name|i802_bss
modifier|*
name|bss
init|=
name|priv
decl_stmt|;
name|struct
name|wpa_driver_nl80211_data
modifier|*
name|drv
init|=
name|bss
operator|->
name|drv
decl_stmt|;
name|struct
name|nl_msg
modifier|*
name|msg
decl_stmt|;
name|struct
name|nl80211_sta_flag_update
name|upd
decl_stmt|;
name|int
name|ret
decl_stmt|;
if|if
condition|(
operator|!
name|drv
operator|->
name|associated
operator|&&
name|is_zero_ether_addr
argument_list|(
name|drv
operator|->
name|bssid
argument_list|)
operator|&&
operator|!
name|authorized
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"nl80211: Skip set_supp_port(unauthorized) while not associated"
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"nl80211: Set supplicant port %sauthorized for "
name|MACSTR
argument_list|,
name|authorized
condition|?
literal|""
else|:
literal|"un"
argument_list|,
name|MAC2STR
argument_list|(
name|drv
operator|->
name|bssid
argument_list|)
argument_list|)
expr_stmt|;
name|os_memset
argument_list|(
operator|&
name|upd
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|upd
argument_list|)
argument_list|)
expr_stmt|;
name|upd
operator|.
name|mask
operator|=
name|BIT
argument_list|(
name|NL80211_STA_FLAG_AUTHORIZED
argument_list|)
expr_stmt|;
if|if
condition|(
name|authorized
condition|)
name|upd
operator|.
name|set
operator|=
name|BIT
argument_list|(
name|NL80211_STA_FLAG_AUTHORIZED
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|msg
operator|=
name|nl80211_bss_msg
argument_list|(
name|bss
argument_list|,
literal|0
argument_list|,
name|NL80211_CMD_SET_STATION
argument_list|)
operator|)
operator|||
name|nla_put
argument_list|(
name|msg
argument_list|,
name|NL80211_ATTR_MAC
argument_list|,
name|ETH_ALEN
argument_list|,
name|drv
operator|->
name|bssid
argument_list|)
operator|||
name|nla_put
argument_list|(
name|msg
argument_list|,
name|NL80211_ATTR_STA_FLAGS2
argument_list|,
sizeof|sizeof
argument_list|(
name|upd
argument_list|)
argument_list|,
operator|&
name|upd
argument_list|)
condition|)
block|{
name|nlmsg_free
argument_list|(
name|msg
argument_list|)
expr_stmt|;
return|return
operator|-
name|ENOBUFS
return|;
block|}
name|ret
operator|=
name|send_and_recv_msgs
argument_list|(
name|drv
argument_list|,
name|msg
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|ret
condition|)
return|return
literal|0
return|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"nl80211: Failed to set STA flag: %d (%s)"
argument_list|,
name|ret
argument_list|,
name|strerror
argument_list|(
operator|-
name|ret
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_comment
comment|/* Set kernel driver on given frequency (MHz) */
end_comment

begin_function
specifier|static
name|int
name|i802_set_freq
parameter_list|(
name|void
modifier|*
name|priv
parameter_list|,
name|struct
name|hostapd_freq_params
modifier|*
name|freq
parameter_list|)
block|{
name|struct
name|i802_bss
modifier|*
name|bss
init|=
name|priv
decl_stmt|;
return|return
name|nl80211_set_channel
argument_list|(
name|bss
argument_list|,
name|freq
argument_list|,
literal|0
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
specifier|inline
name|int
name|min_int
parameter_list|(
name|int
name|a
parameter_list|,
name|int
name|b
parameter_list|)
block|{
if|if
condition|(
name|a
operator|<
name|b
condition|)
return|return
name|a
return|;
return|return
name|b
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|get_key_handler
parameter_list|(
name|struct
name|nl_msg
modifier|*
name|msg
parameter_list|,
name|void
modifier|*
name|arg
parameter_list|)
block|{
name|struct
name|nlattr
modifier|*
name|tb
index|[
name|NL80211_ATTR_MAX
operator|+
literal|1
index|]
decl_stmt|;
name|struct
name|genlmsghdr
modifier|*
name|gnlh
init|=
name|nlmsg_data
argument_list|(
name|nlmsg_hdr
argument_list|(
name|msg
argument_list|)
argument_list|)
decl_stmt|;
name|nla_parse
argument_list|(
name|tb
argument_list|,
name|NL80211_ATTR_MAX
argument_list|,
name|genlmsg_attrdata
argument_list|(
name|gnlh
argument_list|,
literal|0
argument_list|)
argument_list|,
name|genlmsg_attrlen
argument_list|(
name|gnlh
argument_list|,
literal|0
argument_list|)
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
comment|/* 	 * TODO: validate the key index and mac address! 	 * Otherwise, there's a race condition as soon as 	 * the kernel starts sending key notifications. 	 */
if|if
condition|(
name|tb
index|[
name|NL80211_ATTR_KEY_SEQ
index|]
condition|)
name|memcpy
argument_list|(
name|arg
argument_list|,
name|nla_data
argument_list|(
name|tb
index|[
name|NL80211_ATTR_KEY_SEQ
index|]
argument_list|)
argument_list|,
name|min_int
argument_list|(
name|nla_len
argument_list|(
name|tb
index|[
name|NL80211_ATTR_KEY_SEQ
index|]
argument_list|)
argument_list|,
literal|6
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|NL_SKIP
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|i802_get_seqnum
parameter_list|(
specifier|const
name|char
modifier|*
name|iface
parameter_list|,
name|void
modifier|*
name|priv
parameter_list|,
specifier|const
name|u8
modifier|*
name|addr
parameter_list|,
name|int
name|idx
parameter_list|,
name|u8
modifier|*
name|seq
parameter_list|)
block|{
name|struct
name|i802_bss
modifier|*
name|bss
init|=
name|priv
decl_stmt|;
name|struct
name|wpa_driver_nl80211_data
modifier|*
name|drv
init|=
name|bss
operator|->
name|drv
decl_stmt|;
name|struct
name|nl_msg
modifier|*
name|msg
decl_stmt|;
name|msg
operator|=
name|nl80211_ifindex_msg
argument_list|(
name|drv
argument_list|,
name|if_nametoindex
argument_list|(
name|iface
argument_list|)
argument_list|,
literal|0
argument_list|,
name|NL80211_CMD_GET_KEY
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|msg
operator|||
operator|(
name|addr
operator|&&
name|nla_put
argument_list|(
name|msg
argument_list|,
name|NL80211_ATTR_MAC
argument_list|,
name|ETH_ALEN
argument_list|,
name|addr
argument_list|)
operator|)
operator|||
name|nla_put_u8
argument_list|(
name|msg
argument_list|,
name|NL80211_ATTR_KEY_IDX
argument_list|,
name|idx
argument_list|)
condition|)
block|{
name|nlmsg_free
argument_list|(
name|msg
argument_list|)
expr_stmt|;
return|return
operator|-
name|ENOBUFS
return|;
block|}
name|memset
argument_list|(
name|seq
argument_list|,
literal|0
argument_list|,
literal|6
argument_list|)
expr_stmt|;
return|return
name|send_and_recv_msgs
argument_list|(
name|drv
argument_list|,
name|msg
argument_list|,
name|get_key_handler
argument_list|,
name|seq
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|i802_set_rts
parameter_list|(
name|void
modifier|*
name|priv
parameter_list|,
name|int
name|rts
parameter_list|)
block|{
name|struct
name|i802_bss
modifier|*
name|bss
init|=
name|priv
decl_stmt|;
name|struct
name|wpa_driver_nl80211_data
modifier|*
name|drv
init|=
name|bss
operator|->
name|drv
decl_stmt|;
name|struct
name|nl_msg
modifier|*
name|msg
decl_stmt|;
name|int
name|ret
decl_stmt|;
name|u32
name|val
decl_stmt|;
if|if
condition|(
name|rts
operator|>=
literal|2347
condition|)
name|val
operator|=
operator|(
name|u32
operator|)
operator|-
literal|1
expr_stmt|;
else|else
name|val
operator|=
name|rts
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|msg
operator|=
name|nl80211_drv_msg
argument_list|(
name|drv
argument_list|,
literal|0
argument_list|,
name|NL80211_CMD_SET_WIPHY
argument_list|)
operator|)
operator|||
name|nla_put_u32
argument_list|(
name|msg
argument_list|,
name|NL80211_ATTR_WIPHY_RTS_THRESHOLD
argument_list|,
name|val
argument_list|)
condition|)
block|{
name|nlmsg_free
argument_list|(
name|msg
argument_list|)
expr_stmt|;
return|return
operator|-
name|ENOBUFS
return|;
block|}
name|ret
operator|=
name|send_and_recv_msgs
argument_list|(
name|drv
argument_list|,
name|msg
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|ret
condition|)
return|return
literal|0
return|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"nl80211: Failed to set RTS threshold %d: "
literal|"%d (%s)"
argument_list|,
name|rts
argument_list|,
name|ret
argument_list|,
name|strerror
argument_list|(
operator|-
name|ret
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|i802_set_frag
parameter_list|(
name|void
modifier|*
name|priv
parameter_list|,
name|int
name|frag
parameter_list|)
block|{
name|struct
name|i802_bss
modifier|*
name|bss
init|=
name|priv
decl_stmt|;
name|struct
name|wpa_driver_nl80211_data
modifier|*
name|drv
init|=
name|bss
operator|->
name|drv
decl_stmt|;
name|struct
name|nl_msg
modifier|*
name|msg
decl_stmt|;
name|int
name|ret
decl_stmt|;
name|u32
name|val
decl_stmt|;
if|if
condition|(
name|frag
operator|>=
literal|2346
condition|)
name|val
operator|=
operator|(
name|u32
operator|)
operator|-
literal|1
expr_stmt|;
else|else
name|val
operator|=
name|frag
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|msg
operator|=
name|nl80211_drv_msg
argument_list|(
name|drv
argument_list|,
literal|0
argument_list|,
name|NL80211_CMD_SET_WIPHY
argument_list|)
operator|)
operator|||
name|nla_put_u32
argument_list|(
name|msg
argument_list|,
name|NL80211_ATTR_WIPHY_FRAG_THRESHOLD
argument_list|,
name|val
argument_list|)
condition|)
block|{
name|nlmsg_free
argument_list|(
name|msg
argument_list|)
expr_stmt|;
return|return
operator|-
name|ENOBUFS
return|;
block|}
name|ret
operator|=
name|send_and_recv_msgs
argument_list|(
name|drv
argument_list|,
name|msg
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|ret
condition|)
return|return
literal|0
return|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"nl80211: Failed to set fragmentation threshold "
literal|"%d: %d (%s)"
argument_list|,
name|frag
argument_list|,
name|ret
argument_list|,
name|strerror
argument_list|(
operator|-
name|ret
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|i802_flush
parameter_list|(
name|void
modifier|*
name|priv
parameter_list|)
block|{
name|struct
name|i802_bss
modifier|*
name|bss
init|=
name|priv
decl_stmt|;
name|struct
name|nl_msg
modifier|*
name|msg
decl_stmt|;
name|int
name|res
decl_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"nl80211: flush -> DEL_STATION %s (all)"
argument_list|,
name|bss
operator|->
name|ifname
argument_list|)
expr_stmt|;
comment|/* 	 * XXX: FIX! this needs to flush all VLANs too 	 */
name|msg
operator|=
name|nl80211_bss_msg
argument_list|(
name|bss
argument_list|,
literal|0
argument_list|,
name|NL80211_CMD_DEL_STATION
argument_list|)
expr_stmt|;
name|res
operator|=
name|send_and_recv_msgs
argument_list|(
name|bss
operator|->
name|drv
argument_list|,
name|msg
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|res
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"nl80211: Station flush failed: ret=%d "
literal|"(%s)"
argument_list|,
name|res
argument_list|,
name|strerror
argument_list|(
operator|-
name|res
argument_list|)
argument_list|)
expr_stmt|;
block|}
return|return
name|res
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|get_sta_handler
parameter_list|(
name|struct
name|nl_msg
modifier|*
name|msg
parameter_list|,
name|void
modifier|*
name|arg
parameter_list|)
block|{
name|struct
name|nlattr
modifier|*
name|tb
index|[
name|NL80211_ATTR_MAX
operator|+
literal|1
index|]
decl_stmt|;
name|struct
name|genlmsghdr
modifier|*
name|gnlh
init|=
name|nlmsg_data
argument_list|(
name|nlmsg_hdr
argument_list|(
name|msg
argument_list|)
argument_list|)
decl_stmt|;
name|struct
name|hostap_sta_driver_data
modifier|*
name|data
init|=
name|arg
decl_stmt|;
name|struct
name|nlattr
modifier|*
name|stats
index|[
name|NL80211_STA_INFO_MAX
operator|+
literal|1
index|]
decl_stmt|;
specifier|static
name|struct
name|nla_policy
name|stats_policy
index|[
name|NL80211_STA_INFO_MAX
operator|+
literal|1
index|]
init|=
block|{
index|[
name|NL80211_STA_INFO_INACTIVE_TIME
index|]
operator|=
block|{
operator|.
name|type
operator|=
name|NLA_U32
block|}
block|,
index|[
name|NL80211_STA_INFO_RX_BYTES
index|]
operator|=
block|{
operator|.
name|type
operator|=
name|NLA_U32
block|}
block|,
index|[
name|NL80211_STA_INFO_TX_BYTES
index|]
operator|=
block|{
operator|.
name|type
operator|=
name|NLA_U32
block|}
block|,
index|[
name|NL80211_STA_INFO_RX_PACKETS
index|]
operator|=
block|{
operator|.
name|type
operator|=
name|NLA_U32
block|}
block|,
index|[
name|NL80211_STA_INFO_TX_PACKETS
index|]
operator|=
block|{
operator|.
name|type
operator|=
name|NLA_U32
block|}
block|,
index|[
name|NL80211_STA_INFO_TX_FAILED
index|]
operator|=
block|{
operator|.
name|type
operator|=
name|NLA_U32
block|}
block|, 	}
decl_stmt|;
name|nla_parse
argument_list|(
name|tb
argument_list|,
name|NL80211_ATTR_MAX
argument_list|,
name|genlmsg_attrdata
argument_list|(
name|gnlh
argument_list|,
literal|0
argument_list|)
argument_list|,
name|genlmsg_attrlen
argument_list|(
name|gnlh
argument_list|,
literal|0
argument_list|)
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
comment|/* 	 * TODO: validate the interface and mac address! 	 * Otherwise, there's a race condition as soon as 	 * the kernel starts sending station notifications. 	 */
if|if
condition|(
operator|!
name|tb
index|[
name|NL80211_ATTR_STA_INFO
index|]
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"sta stats missing!"
argument_list|)
expr_stmt|;
return|return
name|NL_SKIP
return|;
block|}
if|if
condition|(
name|nla_parse_nested
argument_list|(
name|stats
argument_list|,
name|NL80211_STA_INFO_MAX
argument_list|,
name|tb
index|[
name|NL80211_ATTR_STA_INFO
index|]
argument_list|,
name|stats_policy
argument_list|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"failed to parse nested attributes!"
argument_list|)
expr_stmt|;
return|return
name|NL_SKIP
return|;
block|}
if|if
condition|(
name|stats
index|[
name|NL80211_STA_INFO_INACTIVE_TIME
index|]
condition|)
name|data
operator|->
name|inactive_msec
operator|=
name|nla_get_u32
argument_list|(
name|stats
index|[
name|NL80211_STA_INFO_INACTIVE_TIME
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|stats
index|[
name|NL80211_STA_INFO_RX_BYTES
index|]
condition|)
name|data
operator|->
name|rx_bytes
operator|=
name|nla_get_u32
argument_list|(
name|stats
index|[
name|NL80211_STA_INFO_RX_BYTES
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|stats
index|[
name|NL80211_STA_INFO_TX_BYTES
index|]
condition|)
name|data
operator|->
name|tx_bytes
operator|=
name|nla_get_u32
argument_list|(
name|stats
index|[
name|NL80211_STA_INFO_TX_BYTES
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|stats
index|[
name|NL80211_STA_INFO_RX_PACKETS
index|]
condition|)
name|data
operator|->
name|rx_packets
operator|=
name|nla_get_u32
argument_list|(
name|stats
index|[
name|NL80211_STA_INFO_RX_PACKETS
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|stats
index|[
name|NL80211_STA_INFO_TX_PACKETS
index|]
condition|)
name|data
operator|->
name|tx_packets
operator|=
name|nla_get_u32
argument_list|(
name|stats
index|[
name|NL80211_STA_INFO_TX_PACKETS
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|stats
index|[
name|NL80211_STA_INFO_TX_FAILED
index|]
condition|)
name|data
operator|->
name|tx_retry_failed
operator|=
name|nla_get_u32
argument_list|(
name|stats
index|[
name|NL80211_STA_INFO_TX_FAILED
index|]
argument_list|)
expr_stmt|;
return|return
name|NL_SKIP
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|i802_read_sta_data
parameter_list|(
name|struct
name|i802_bss
modifier|*
name|bss
parameter_list|,
name|struct
name|hostap_sta_driver_data
modifier|*
name|data
parameter_list|,
specifier|const
name|u8
modifier|*
name|addr
parameter_list|)
block|{
name|struct
name|nl_msg
modifier|*
name|msg
decl_stmt|;
name|os_memset
argument_list|(
name|data
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|data
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|msg
operator|=
name|nl80211_bss_msg
argument_list|(
name|bss
argument_list|,
literal|0
argument_list|,
name|NL80211_CMD_GET_STATION
argument_list|)
operator|)
operator|||
name|nla_put
argument_list|(
name|msg
argument_list|,
name|NL80211_ATTR_MAC
argument_list|,
name|ETH_ALEN
argument_list|,
name|addr
argument_list|)
condition|)
block|{
name|nlmsg_free
argument_list|(
name|msg
argument_list|)
expr_stmt|;
return|return
operator|-
name|ENOBUFS
return|;
block|}
return|return
name|send_and_recv_msgs
argument_list|(
name|bss
operator|->
name|drv
argument_list|,
name|msg
argument_list|,
name|get_sta_handler
argument_list|,
name|data
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|i802_set_tx_queue_params
parameter_list|(
name|void
modifier|*
name|priv
parameter_list|,
name|int
name|queue
parameter_list|,
name|int
name|aifs
parameter_list|,
name|int
name|cw_min
parameter_list|,
name|int
name|cw_max
parameter_list|,
name|int
name|burst_time
parameter_list|)
block|{
name|struct
name|i802_bss
modifier|*
name|bss
init|=
name|priv
decl_stmt|;
name|struct
name|wpa_driver_nl80211_data
modifier|*
name|drv
init|=
name|bss
operator|->
name|drv
decl_stmt|;
name|struct
name|nl_msg
modifier|*
name|msg
decl_stmt|;
name|struct
name|nlattr
modifier|*
name|txq
decl_stmt|,
modifier|*
name|params
decl_stmt|;
name|msg
operator|=
name|nl80211_bss_msg
argument_list|(
name|bss
argument_list|,
literal|0
argument_list|,
name|NL80211_CMD_SET_WIPHY
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|msg
condition|)
return|return
operator|-
literal|1
return|;
name|txq
operator|=
name|nla_nest_start
argument_list|(
name|msg
argument_list|,
name|NL80211_ATTR_WIPHY_TXQ_PARAMS
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|txq
condition|)
goto|goto
name|fail
goto|;
comment|/* We are only sending parameters for a single TXQ at a time */
name|params
operator|=
name|nla_nest_start
argument_list|(
name|msg
argument_list|,
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|params
condition|)
goto|goto
name|fail
goto|;
switch|switch
condition|(
name|queue
condition|)
block|{
case|case
literal|0
case|:
if|if
condition|(
name|nla_put_u8
argument_list|(
name|msg
argument_list|,
name|NL80211_TXQ_ATTR_QUEUE
argument_list|,
name|NL80211_TXQ_Q_VO
argument_list|)
condition|)
goto|goto
name|fail
goto|;
break|break;
case|case
literal|1
case|:
if|if
condition|(
name|nla_put_u8
argument_list|(
name|msg
argument_list|,
name|NL80211_TXQ_ATTR_QUEUE
argument_list|,
name|NL80211_TXQ_Q_VI
argument_list|)
condition|)
goto|goto
name|fail
goto|;
break|break;
case|case
literal|2
case|:
if|if
condition|(
name|nla_put_u8
argument_list|(
name|msg
argument_list|,
name|NL80211_TXQ_ATTR_QUEUE
argument_list|,
name|NL80211_TXQ_Q_BE
argument_list|)
condition|)
goto|goto
name|fail
goto|;
break|break;
case|case
literal|3
case|:
if|if
condition|(
name|nla_put_u8
argument_list|(
name|msg
argument_list|,
name|NL80211_TXQ_ATTR_QUEUE
argument_list|,
name|NL80211_TXQ_Q_BK
argument_list|)
condition|)
goto|goto
name|fail
goto|;
break|break;
block|}
comment|/* Burst time is configured in units of 0.1 msec and TXOP parameter in 	 * 32 usec, so need to convert the value here. */
if|if
condition|(
name|nla_put_u16
argument_list|(
name|msg
argument_list|,
name|NL80211_TXQ_ATTR_TXOP
argument_list|,
operator|(
name|burst_time
operator|*
literal|100
operator|+
literal|16
operator|)
operator|/
literal|32
argument_list|)
operator|||
name|nla_put_u16
argument_list|(
name|msg
argument_list|,
name|NL80211_TXQ_ATTR_CWMIN
argument_list|,
name|cw_min
argument_list|)
operator|||
name|nla_put_u16
argument_list|(
name|msg
argument_list|,
name|NL80211_TXQ_ATTR_CWMAX
argument_list|,
name|cw_max
argument_list|)
operator|||
name|nla_put_u8
argument_list|(
name|msg
argument_list|,
name|NL80211_TXQ_ATTR_AIFS
argument_list|,
name|aifs
argument_list|)
condition|)
goto|goto
name|fail
goto|;
name|nla_nest_end
argument_list|(
name|msg
argument_list|,
name|params
argument_list|)
expr_stmt|;
name|nla_nest_end
argument_list|(
name|msg
argument_list|,
name|txq
argument_list|)
expr_stmt|;
if|if
condition|(
name|send_and_recv_msgs
argument_list|(
name|drv
argument_list|,
name|msg
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
operator|==
literal|0
condition|)
return|return
literal|0
return|;
name|msg
operator|=
name|NULL
expr_stmt|;
name|fail
label|:
name|nlmsg_free
argument_list|(
name|msg
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|i802_set_sta_vlan
parameter_list|(
name|struct
name|i802_bss
modifier|*
name|bss
parameter_list|,
specifier|const
name|u8
modifier|*
name|addr
parameter_list|,
specifier|const
name|char
modifier|*
name|ifname
parameter_list|,
name|int
name|vlan_id
parameter_list|)
block|{
name|struct
name|wpa_driver_nl80211_data
modifier|*
name|drv
init|=
name|bss
operator|->
name|drv
decl_stmt|;
name|struct
name|nl_msg
modifier|*
name|msg
decl_stmt|;
name|int
name|ret
decl_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"nl80211: %s[%d]: set_sta_vlan("
name|MACSTR
literal|", ifname=%s[%d], vlan_id=%d)"
argument_list|,
name|bss
operator|->
name|ifname
argument_list|,
name|if_nametoindex
argument_list|(
name|bss
operator|->
name|ifname
argument_list|)
argument_list|,
name|MAC2STR
argument_list|(
name|addr
argument_list|)
argument_list|,
name|ifname
argument_list|,
name|if_nametoindex
argument_list|(
name|ifname
argument_list|)
argument_list|,
name|vlan_id
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|msg
operator|=
name|nl80211_bss_msg
argument_list|(
name|bss
argument_list|,
literal|0
argument_list|,
name|NL80211_CMD_SET_STATION
argument_list|)
operator|)
operator|||
name|nla_put
argument_list|(
name|msg
argument_list|,
name|NL80211_ATTR_MAC
argument_list|,
name|ETH_ALEN
argument_list|,
name|addr
argument_list|)
operator|||
name|nla_put_u32
argument_list|(
name|msg
argument_list|,
name|NL80211_ATTR_STA_VLAN
argument_list|,
name|if_nametoindex
argument_list|(
name|ifname
argument_list|)
argument_list|)
condition|)
block|{
name|nlmsg_free
argument_list|(
name|msg
argument_list|)
expr_stmt|;
return|return
operator|-
name|ENOBUFS
return|;
block|}
name|ret
operator|=
name|send_and_recv_msgs
argument_list|(
name|drv
argument_list|,
name|msg
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|<
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"nl80211: NL80211_ATTR_STA_VLAN (addr="
name|MACSTR
literal|" ifname=%s vlan_id=%d) failed: %d (%s)"
argument_list|,
name|MAC2STR
argument_list|(
name|addr
argument_list|)
argument_list|,
name|ifname
argument_list|,
name|vlan_id
argument_list|,
name|ret
argument_list|,
name|strerror
argument_list|(
operator|-
name|ret
argument_list|)
argument_list|)
expr_stmt|;
block|}
return|return
name|ret
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|i802_get_inact_sec
parameter_list|(
name|void
modifier|*
name|priv
parameter_list|,
specifier|const
name|u8
modifier|*
name|addr
parameter_list|)
block|{
name|struct
name|hostap_sta_driver_data
name|data
decl_stmt|;
name|int
name|ret
decl_stmt|;
name|data
operator|.
name|inactive_msec
operator|=
operator|(
name|unsigned
name|long
operator|)
operator|-
literal|1
expr_stmt|;
name|ret
operator|=
name|i802_read_sta_data
argument_list|(
name|priv
argument_list|,
operator|&
name|data
argument_list|,
name|addr
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|==
operator|-
name|ENOENT
condition|)
return|return
operator|-
name|ENOENT
return|;
if|if
condition|(
name|ret
operator|||
name|data
operator|.
name|inactive_msec
operator|==
operator|(
name|unsigned
name|long
operator|)
operator|-
literal|1
condition|)
return|return
operator|-
literal|1
return|;
return|return
name|data
operator|.
name|inactive_msec
operator|/
literal|1000
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|i802_sta_clear_stats
parameter_list|(
name|void
modifier|*
name|priv
parameter_list|,
specifier|const
name|u8
modifier|*
name|addr
parameter_list|)
block|{
if|#
directive|if
literal|0
comment|/* TODO */
endif|#
directive|endif
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|i802_sta_deauth
parameter_list|(
name|void
modifier|*
name|priv
parameter_list|,
specifier|const
name|u8
modifier|*
name|own_addr
parameter_list|,
specifier|const
name|u8
modifier|*
name|addr
parameter_list|,
name|int
name|reason
parameter_list|)
block|{
name|struct
name|i802_bss
modifier|*
name|bss
init|=
name|priv
decl_stmt|;
name|struct
name|wpa_driver_nl80211_data
modifier|*
name|drv
init|=
name|bss
operator|->
name|drv
decl_stmt|;
name|struct
name|ieee80211_mgmt
name|mgmt
decl_stmt|;
if|if
condition|(
name|is_mesh_interface
argument_list|(
name|drv
operator|->
name|nlmode
argument_list|)
condition|)
return|return
operator|-
literal|1
return|;
if|if
condition|(
name|drv
operator|->
name|device_ap_sme
condition|)
return|return
name|wpa_driver_nl80211_sta_remove
argument_list|(
name|bss
argument_list|,
name|addr
argument_list|,
literal|1
argument_list|,
name|reason
argument_list|)
return|;
name|memset
argument_list|(
operator|&
name|mgmt
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|mgmt
argument_list|)
argument_list|)
expr_stmt|;
name|mgmt
operator|.
name|frame_control
operator|=
name|IEEE80211_FC
argument_list|(
name|WLAN_FC_TYPE_MGMT
argument_list|,
name|WLAN_FC_STYPE_DEAUTH
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
name|mgmt
operator|.
name|da
argument_list|,
name|addr
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
name|mgmt
operator|.
name|sa
argument_list|,
name|own_addr
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
name|mgmt
operator|.
name|bssid
argument_list|,
name|own_addr
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
name|mgmt
operator|.
name|u
operator|.
name|deauth
operator|.
name|reason_code
operator|=
name|host_to_le16
argument_list|(
name|reason
argument_list|)
expr_stmt|;
return|return
name|wpa_driver_nl80211_send_mlme
argument_list|(
name|bss
argument_list|,
operator|(
name|u8
operator|*
operator|)
operator|&
name|mgmt
argument_list|,
name|IEEE80211_HDRLEN
operator|+
sizeof|sizeof
argument_list|(
name|mgmt
operator|.
name|u
operator|.
name|deauth
argument_list|)
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|i802_sta_disassoc
parameter_list|(
name|void
modifier|*
name|priv
parameter_list|,
specifier|const
name|u8
modifier|*
name|own_addr
parameter_list|,
specifier|const
name|u8
modifier|*
name|addr
parameter_list|,
name|int
name|reason
parameter_list|)
block|{
name|struct
name|i802_bss
modifier|*
name|bss
init|=
name|priv
decl_stmt|;
name|struct
name|wpa_driver_nl80211_data
modifier|*
name|drv
init|=
name|bss
operator|->
name|drv
decl_stmt|;
name|struct
name|ieee80211_mgmt
name|mgmt
decl_stmt|;
if|if
condition|(
name|is_mesh_interface
argument_list|(
name|drv
operator|->
name|nlmode
argument_list|)
condition|)
return|return
operator|-
literal|1
return|;
if|if
condition|(
name|drv
operator|->
name|device_ap_sme
condition|)
return|return
name|wpa_driver_nl80211_sta_remove
argument_list|(
name|bss
argument_list|,
name|addr
argument_list|,
literal|0
argument_list|,
name|reason
argument_list|)
return|;
name|memset
argument_list|(
operator|&
name|mgmt
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|mgmt
argument_list|)
argument_list|)
expr_stmt|;
name|mgmt
operator|.
name|frame_control
operator|=
name|IEEE80211_FC
argument_list|(
name|WLAN_FC_TYPE_MGMT
argument_list|,
name|WLAN_FC_STYPE_DISASSOC
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
name|mgmt
operator|.
name|da
argument_list|,
name|addr
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
name|mgmt
operator|.
name|sa
argument_list|,
name|own_addr
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
name|mgmt
operator|.
name|bssid
argument_list|,
name|own_addr
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
name|mgmt
operator|.
name|u
operator|.
name|disassoc
operator|.
name|reason_code
operator|=
name|host_to_le16
argument_list|(
name|reason
argument_list|)
expr_stmt|;
return|return
name|wpa_driver_nl80211_send_mlme
argument_list|(
name|bss
argument_list|,
operator|(
name|u8
operator|*
operator|)
operator|&
name|mgmt
argument_list|,
name|IEEE80211_HDRLEN
operator|+
sizeof|sizeof
argument_list|(
name|mgmt
operator|.
name|u
operator|.
name|disassoc
argument_list|)
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|dump_ifidx
parameter_list|(
name|struct
name|wpa_driver_nl80211_data
modifier|*
name|drv
parameter_list|)
block|{
name|char
name|buf
index|[
literal|200
index|]
decl_stmt|,
modifier|*
name|pos
decl_stmt|,
modifier|*
name|end
decl_stmt|;
name|int
name|i
decl_stmt|,
name|res
decl_stmt|;
name|pos
operator|=
name|buf
expr_stmt|;
name|end
operator|=
name|pos
operator|+
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|drv
operator|->
name|num_if_indices
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
operator|!
name|drv
operator|->
name|if_indices
index|[
name|i
index|]
condition|)
continue|continue;
name|res
operator|=
name|os_snprintf
argument_list|(
name|pos
argument_list|,
name|end
operator|-
name|pos
argument_list|,
literal|" %d"
argument_list|,
name|drv
operator|->
name|if_indices
index|[
name|i
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|os_snprintf_error
argument_list|(
name|end
operator|-
name|pos
argument_list|,
name|res
argument_list|)
condition|)
break|break;
name|pos
operator|+=
name|res
expr_stmt|;
block|}
operator|*
name|pos
operator|=
literal|'\0'
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"nl80211: if_indices[%d]:%s"
argument_list|,
name|drv
operator|->
name|num_if_indices
argument_list|,
name|buf
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|add_ifidx
parameter_list|(
name|struct
name|wpa_driver_nl80211_data
modifier|*
name|drv
parameter_list|,
name|int
name|ifidx
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
name|int
modifier|*
name|old
decl_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"nl80211: Add own interface ifindex %d"
argument_list|,
name|ifidx
argument_list|)
expr_stmt|;
if|if
condition|(
name|have_ifidx
argument_list|(
name|drv
argument_list|,
name|ifidx
argument_list|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"nl80211: ifindex %d already in the list"
argument_list|,
name|ifidx
argument_list|)
expr_stmt|;
return|return;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|drv
operator|->
name|num_if_indices
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|drv
operator|->
name|if_indices
index|[
name|i
index|]
operator|==
literal|0
condition|)
block|{
name|drv
operator|->
name|if_indices
index|[
name|i
index|]
operator|=
name|ifidx
expr_stmt|;
name|dump_ifidx
argument_list|(
name|drv
argument_list|)
expr_stmt|;
return|return;
block|}
block|}
if|if
condition|(
name|drv
operator|->
name|if_indices
operator|!=
name|drv
operator|->
name|default_if_indices
condition|)
name|old
operator|=
name|drv
operator|->
name|if_indices
expr_stmt|;
else|else
name|old
operator|=
name|NULL
expr_stmt|;
name|drv
operator|->
name|if_indices
operator|=
name|os_realloc_array
argument_list|(
name|old
argument_list|,
name|drv
operator|->
name|num_if_indices
operator|+
literal|1
argument_list|,
sizeof|sizeof
argument_list|(
name|int
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|drv
operator|->
name|if_indices
condition|)
block|{
if|if
condition|(
operator|!
name|old
condition|)
name|drv
operator|->
name|if_indices
operator|=
name|drv
operator|->
name|default_if_indices
expr_stmt|;
else|else
name|drv
operator|->
name|if_indices
operator|=
name|old
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"Failed to reallocate memory for "
literal|"interfaces"
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"Ignoring EAPOL on interface %d"
argument_list|,
name|ifidx
argument_list|)
expr_stmt|;
return|return;
block|}
elseif|else
if|if
condition|(
operator|!
name|old
condition|)
name|os_memcpy
argument_list|(
name|drv
operator|->
name|if_indices
argument_list|,
name|drv
operator|->
name|default_if_indices
argument_list|,
sizeof|sizeof
argument_list|(
name|drv
operator|->
name|default_if_indices
argument_list|)
argument_list|)
expr_stmt|;
name|drv
operator|->
name|if_indices
index|[
name|drv
operator|->
name|num_if_indices
index|]
operator|=
name|ifidx
expr_stmt|;
name|drv
operator|->
name|num_if_indices
operator|++
expr_stmt|;
name|dump_ifidx
argument_list|(
name|drv
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|del_ifidx
parameter_list|(
name|struct
name|wpa_driver_nl80211_data
modifier|*
name|drv
parameter_list|,
name|int
name|ifidx
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|drv
operator|->
name|num_if_indices
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|drv
operator|->
name|if_indices
index|[
name|i
index|]
operator|==
name|ifidx
condition|)
block|{
name|drv
operator|->
name|if_indices
index|[
name|i
index|]
operator|=
literal|0
expr_stmt|;
break|break;
block|}
block|}
name|dump_ifidx
argument_list|(
name|drv
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|have_ifidx
parameter_list|(
name|struct
name|wpa_driver_nl80211_data
modifier|*
name|drv
parameter_list|,
name|int
name|ifidx
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|drv
operator|->
name|num_if_indices
condition|;
name|i
operator|++
control|)
if|if
condition|(
name|drv
operator|->
name|if_indices
index|[
name|i
index|]
operator|==
name|ifidx
condition|)
return|return
literal|1
return|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|i802_set_wds_sta
parameter_list|(
name|void
modifier|*
name|priv
parameter_list|,
specifier|const
name|u8
modifier|*
name|addr
parameter_list|,
name|int
name|aid
parameter_list|,
name|int
name|val
parameter_list|,
specifier|const
name|char
modifier|*
name|bridge_ifname
parameter_list|,
name|char
modifier|*
name|ifname_wds
parameter_list|)
block|{
name|struct
name|i802_bss
modifier|*
name|bss
init|=
name|priv
decl_stmt|;
name|struct
name|wpa_driver_nl80211_data
modifier|*
name|drv
init|=
name|bss
operator|->
name|drv
decl_stmt|;
name|char
name|name
index|[
name|IFNAMSIZ
operator|+
literal|1
index|]
decl_stmt|;
name|os_snprintf
argument_list|(
name|name
argument_list|,
sizeof|sizeof
argument_list|(
name|name
argument_list|)
argument_list|,
literal|"%s.sta%d"
argument_list|,
name|bss
operator|->
name|ifname
argument_list|,
name|aid
argument_list|)
expr_stmt|;
if|if
condition|(
name|ifname_wds
condition|)
name|os_strlcpy
argument_list|(
name|ifname_wds
argument_list|,
name|name
argument_list|,
name|IFNAMSIZ
operator|+
literal|1
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"nl80211: Set WDS STA addr="
name|MACSTR
literal|" aid=%d val=%d name=%s"
argument_list|,
name|MAC2STR
argument_list|(
name|addr
argument_list|)
argument_list|,
name|aid
argument_list|,
name|val
argument_list|,
name|name
argument_list|)
expr_stmt|;
if|if
condition|(
name|val
condition|)
block|{
if|if
condition|(
operator|!
name|if_nametoindex
argument_list|(
name|name
argument_list|)
condition|)
block|{
if|if
condition|(
name|nl80211_create_iface
argument_list|(
name|drv
argument_list|,
name|name
argument_list|,
name|NL80211_IFTYPE_AP_VLAN
argument_list|,
name|bss
operator|->
name|addr
argument_list|,
literal|1
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
operator|<
literal|0
condition|)
return|return
operator|-
literal|1
return|;
if|if
condition|(
name|bridge_ifname
operator|&&
name|linux_br_add_if
argument_list|(
name|drv
operator|->
name|global
operator|->
name|ioctl_sock
argument_list|,
name|bridge_ifname
argument_list|,
name|name
argument_list|)
operator|<
literal|0
condition|)
return|return
operator|-
literal|1
return|;
block|}
if|if
condition|(
name|linux_set_iface_flags
argument_list|(
name|drv
operator|->
name|global
operator|->
name|ioctl_sock
argument_list|,
name|name
argument_list|,
literal|1
argument_list|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"nl80211: Failed to set WDS STA "
literal|"interface %s up"
argument_list|,
name|name
argument_list|)
expr_stmt|;
block|}
return|return
name|i802_set_sta_vlan
argument_list|(
name|priv
argument_list|,
name|addr
argument_list|,
name|name
argument_list|,
literal|0
argument_list|)
return|;
block|}
else|else
block|{
if|if
condition|(
name|bridge_ifname
condition|)
name|linux_br_del_if
argument_list|(
name|drv
operator|->
name|global
operator|->
name|ioctl_sock
argument_list|,
name|bridge_ifname
argument_list|,
name|name
argument_list|)
expr_stmt|;
name|i802_set_sta_vlan
argument_list|(
name|priv
argument_list|,
name|addr
argument_list|,
name|bss
operator|->
name|ifname
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|nl80211_remove_iface
argument_list|(
name|drv
argument_list|,
name|if_nametoindex
argument_list|(
name|name
argument_list|)
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|handle_eapol
parameter_list|(
name|int
name|sock
parameter_list|,
name|void
modifier|*
name|eloop_ctx
parameter_list|,
name|void
modifier|*
name|sock_ctx
parameter_list|)
block|{
name|struct
name|wpa_driver_nl80211_data
modifier|*
name|drv
init|=
name|eloop_ctx
decl_stmt|;
name|struct
name|sockaddr_ll
name|lladdr
decl_stmt|;
name|unsigned
name|char
name|buf
index|[
literal|3000
index|]
decl_stmt|;
name|int
name|len
decl_stmt|;
name|socklen_t
name|fromlen
init|=
sizeof|sizeof
argument_list|(
name|lladdr
argument_list|)
decl_stmt|;
name|len
operator|=
name|recvfrom
argument_list|(
name|sock
argument_list|,
name|buf
argument_list|,
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
argument_list|,
literal|0
argument_list|,
operator|(
expr|struct
name|sockaddr
operator|*
operator|)
operator|&
name|lladdr
argument_list|,
operator|&
name|fromlen
argument_list|)
expr_stmt|;
if|if
condition|(
name|len
operator|<
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"nl80211: EAPOL recv failed: %s"
argument_list|,
name|strerror
argument_list|(
name|errno
argument_list|)
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|have_ifidx
argument_list|(
name|drv
argument_list|,
name|lladdr
operator|.
name|sll_ifindex
argument_list|)
condition|)
name|drv_event_eapol_rx
argument_list|(
name|drv
operator|->
name|ctx
argument_list|,
name|lladdr
operator|.
name|sll_addr
argument_list|,
name|buf
argument_list|,
name|len
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|i802_check_bridge
parameter_list|(
name|struct
name|wpa_driver_nl80211_data
modifier|*
name|drv
parameter_list|,
name|struct
name|i802_bss
modifier|*
name|bss
parameter_list|,
specifier|const
name|char
modifier|*
name|brname
parameter_list|,
specifier|const
name|char
modifier|*
name|ifname
parameter_list|)
block|{
name|int
name|br_ifindex
decl_stmt|;
name|char
name|in_br
index|[
name|IFNAMSIZ
index|]
decl_stmt|;
name|os_strlcpy
argument_list|(
name|bss
operator|->
name|brname
argument_list|,
name|brname
argument_list|,
name|IFNAMSIZ
argument_list|)
expr_stmt|;
name|br_ifindex
operator|=
name|if_nametoindex
argument_list|(
name|brname
argument_list|)
expr_stmt|;
if|if
condition|(
name|br_ifindex
operator|==
literal|0
condition|)
block|{
comment|/* 		 * Bridge was configured, but the bridge device does 		 * not exist. Try to add it now. 		 */
if|if
condition|(
name|linux_br_add
argument_list|(
name|drv
operator|->
name|global
operator|->
name|ioctl_sock
argument_list|,
name|brname
argument_list|)
operator|<
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"nl80211: Failed to add the "
literal|"bridge interface %s: %s"
argument_list|,
name|brname
argument_list|,
name|strerror
argument_list|(
name|errno
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|bss
operator|->
name|added_bridge
operator|=
literal|1
expr_stmt|;
name|br_ifindex
operator|=
name|if_nametoindex
argument_list|(
name|brname
argument_list|)
expr_stmt|;
name|add_ifidx
argument_list|(
name|drv
argument_list|,
name|br_ifindex
argument_list|)
expr_stmt|;
block|}
name|bss
operator|->
name|br_ifindex
operator|=
name|br_ifindex
expr_stmt|;
if|if
condition|(
name|linux_br_get
argument_list|(
name|in_br
argument_list|,
name|ifname
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|os_strcmp
argument_list|(
name|in_br
argument_list|,
name|brname
argument_list|)
operator|==
literal|0
condition|)
return|return
literal|0
return|;
comment|/* already in the bridge */
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"nl80211: Removing interface %s from "
literal|"bridge %s"
argument_list|,
name|ifname
argument_list|,
name|in_br
argument_list|)
expr_stmt|;
if|if
condition|(
name|linux_br_del_if
argument_list|(
name|drv
operator|->
name|global
operator|->
name|ioctl_sock
argument_list|,
name|in_br
argument_list|,
name|ifname
argument_list|)
operator|<
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"nl80211: Failed to "
literal|"remove interface %s from bridge "
literal|"%s: %s"
argument_list|,
name|ifname
argument_list|,
name|brname
argument_list|,
name|strerror
argument_list|(
name|errno
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
block|}
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"nl80211: Adding interface %s into bridge %s"
argument_list|,
name|ifname
argument_list|,
name|brname
argument_list|)
expr_stmt|;
if|if
condition|(
name|linux_br_add_if
argument_list|(
name|drv
operator|->
name|global
operator|->
name|ioctl_sock
argument_list|,
name|brname
argument_list|,
name|ifname
argument_list|)
operator|<
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"nl80211: Failed to add interface %s "
literal|"into bridge %s: %s"
argument_list|,
name|ifname
argument_list|,
name|brname
argument_list|,
name|strerror
argument_list|(
name|errno
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|bss
operator|->
name|added_if_into_bridge
operator|=
literal|1
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|void
modifier|*
name|i802_init
parameter_list|(
name|struct
name|hostapd_data
modifier|*
name|hapd
parameter_list|,
name|struct
name|wpa_init_params
modifier|*
name|params
parameter_list|)
block|{
name|struct
name|wpa_driver_nl80211_data
modifier|*
name|drv
decl_stmt|;
name|struct
name|i802_bss
modifier|*
name|bss
decl_stmt|;
name|size_t
name|i
decl_stmt|;
name|char
name|brname
index|[
name|IFNAMSIZ
index|]
decl_stmt|;
name|int
name|ifindex
decl_stmt|,
name|br_ifindex
decl_stmt|;
name|int
name|br_added
init|=
literal|0
decl_stmt|;
name|bss
operator|=
name|wpa_driver_nl80211_drv_init
argument_list|(
name|hapd
argument_list|,
name|params
operator|->
name|ifname
argument_list|,
name|params
operator|->
name|global_priv
argument_list|,
literal|1
argument_list|,
name|params
operator|->
name|bssid
argument_list|,
name|params
operator|->
name|driver_params
argument_list|)
expr_stmt|;
if|if
condition|(
name|bss
operator|==
name|NULL
condition|)
return|return
name|NULL
return|;
name|drv
operator|=
name|bss
operator|->
name|drv
expr_stmt|;
if|if
condition|(
name|linux_br_get
argument_list|(
name|brname
argument_list|,
name|params
operator|->
name|ifname
argument_list|)
operator|==
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"nl80211: Interface %s is in bridge %s"
argument_list|,
name|params
operator|->
name|ifname
argument_list|,
name|brname
argument_list|)
expr_stmt|;
name|br_ifindex
operator|=
name|if_nametoindex
argument_list|(
name|brname
argument_list|)
expr_stmt|;
name|os_strlcpy
argument_list|(
name|bss
operator|->
name|brname
argument_list|,
name|brname
argument_list|,
name|IFNAMSIZ
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|brname
index|[
literal|0
index|]
operator|=
literal|'\0'
expr_stmt|;
name|br_ifindex
operator|=
literal|0
expr_stmt|;
block|}
name|bss
operator|->
name|br_ifindex
operator|=
name|br_ifindex
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|params
operator|->
name|num_bridge
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|params
operator|->
name|bridge
index|[
name|i
index|]
condition|)
block|{
name|ifindex
operator|=
name|if_nametoindex
argument_list|(
name|params
operator|->
name|bridge
index|[
name|i
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|ifindex
condition|)
name|add_ifidx
argument_list|(
name|drv
argument_list|,
name|ifindex
argument_list|)
expr_stmt|;
if|if
condition|(
name|ifindex
operator|==
name|br_ifindex
condition|)
name|br_added
operator|=
literal|1
expr_stmt|;
block|}
block|}
comment|/* start listening for EAPOL on the default AP interface */
name|add_ifidx
argument_list|(
name|drv
argument_list|,
name|drv
operator|->
name|ifindex
argument_list|)
expr_stmt|;
if|if
condition|(
name|params
operator|->
name|num_bridge
operator|&&
name|params
operator|->
name|bridge
index|[
literal|0
index|]
condition|)
block|{
if|if
condition|(
name|i802_check_bridge
argument_list|(
name|drv
argument_list|,
name|bss
argument_list|,
name|params
operator|->
name|bridge
index|[
literal|0
index|]
argument_list|,
name|params
operator|->
name|ifname
argument_list|)
operator|<
literal|0
condition|)
goto|goto
name|failed
goto|;
if|if
condition|(
name|os_strcmp
argument_list|(
name|params
operator|->
name|bridge
index|[
literal|0
index|]
argument_list|,
name|brname
argument_list|)
operator|!=
literal|0
condition|)
name|br_added
operator|=
literal|1
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|br_added
operator|&&
name|br_ifindex
operator|&&
operator|(
name|params
operator|->
name|num_bridge
operator|==
literal|0
operator|||
operator|!
name|params
operator|->
name|bridge
index|[
literal|0
index|]
operator|)
condition|)
name|add_ifidx
argument_list|(
name|drv
argument_list|,
name|br_ifindex
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|CONFIG_LIBNL3_ROUTE
if|if
condition|(
name|bss
operator|->
name|added_if_into_bridge
condition|)
block|{
name|drv
operator|->
name|rtnl_sk
operator|=
name|nl_socket_alloc
argument_list|()
expr_stmt|;
if|if
condition|(
name|drv
operator|->
name|rtnl_sk
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"nl80211: Failed to allocate nl_sock"
argument_list|)
expr_stmt|;
goto|goto
name|failed
goto|;
block|}
if|if
condition|(
name|nl_connect
argument_list|(
name|drv
operator|->
name|rtnl_sk
argument_list|,
name|NETLINK_ROUTE
argument_list|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"nl80211: Failed to connect nl_sock to NETLINK_ROUTE: %s"
argument_list|,
name|strerror
argument_list|(
name|errno
argument_list|)
argument_list|)
expr_stmt|;
goto|goto
name|failed
goto|;
block|}
block|}
endif|#
directive|endif
comment|/* CONFIG_LIBNL3_ROUTE */
name|drv
operator|->
name|eapol_sock
operator|=
name|socket
argument_list|(
name|PF_PACKET
argument_list|,
name|SOCK_DGRAM
argument_list|,
name|htons
argument_list|(
name|ETH_P_PAE
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|drv
operator|->
name|eapol_sock
operator|<
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"nl80211: socket(PF_PACKET, SOCK_DGRAM, ETH_P_PAE) failed: %s"
argument_list|,
name|strerror
argument_list|(
name|errno
argument_list|)
argument_list|)
expr_stmt|;
goto|goto
name|failed
goto|;
block|}
if|if
condition|(
name|eloop_register_read_sock
argument_list|(
name|drv
operator|->
name|eapol_sock
argument_list|,
name|handle_eapol
argument_list|,
name|drv
argument_list|,
name|NULL
argument_list|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"nl80211: Could not register read socket for eapol"
argument_list|)
expr_stmt|;
goto|goto
name|failed
goto|;
block|}
if|if
condition|(
name|linux_get_ifhwaddr
argument_list|(
name|drv
operator|->
name|global
operator|->
name|ioctl_sock
argument_list|,
name|bss
operator|->
name|ifname
argument_list|,
name|params
operator|->
name|own_addr
argument_list|)
condition|)
goto|goto
name|failed
goto|;
name|os_memcpy
argument_list|(
name|drv
operator|->
name|perm_addr
argument_list|,
name|params
operator|->
name|own_addr
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
name|bss
operator|->
name|addr
argument_list|,
name|params
operator|->
name|own_addr
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
return|return
name|bss
return|;
name|failed
label|:
name|wpa_driver_nl80211_deinit
argument_list|(
name|bss
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|i802_deinit
parameter_list|(
name|void
modifier|*
name|priv
parameter_list|)
block|{
name|struct
name|i802_bss
modifier|*
name|bss
init|=
name|priv
decl_stmt|;
name|wpa_driver_nl80211_deinit
argument_list|(
name|bss
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|enum
name|nl80211_iftype
name|wpa_driver_nl80211_if_type
parameter_list|(
name|enum
name|wpa_driver_if_type
name|type
parameter_list|)
block|{
switch|switch
condition|(
name|type
condition|)
block|{
case|case
name|WPA_IF_STATION
case|:
return|return
name|NL80211_IFTYPE_STATION
return|;
case|case
name|WPA_IF_P2P_CLIENT
case|:
case|case
name|WPA_IF_P2P_GROUP
case|:
return|return
name|NL80211_IFTYPE_P2P_CLIENT
return|;
case|case
name|WPA_IF_AP_VLAN
case|:
return|return
name|NL80211_IFTYPE_AP_VLAN
return|;
case|case
name|WPA_IF_AP_BSS
case|:
return|return
name|NL80211_IFTYPE_AP
return|;
case|case
name|WPA_IF_P2P_GO
case|:
return|return
name|NL80211_IFTYPE_P2P_GO
return|;
case|case
name|WPA_IF_P2P_DEVICE
case|:
return|return
name|NL80211_IFTYPE_P2P_DEVICE
return|;
case|case
name|WPA_IF_MESH
case|:
return|return
name|NL80211_IFTYPE_MESH_POINT
return|;
block|}
return|return
operator|-
literal|1
return|;
block|}
end_function

begin_if
if|#
directive|if
name|defined
argument_list|(
name|CONFIG_P2P
argument_list|)
operator|||
name|defined
argument_list|(
name|CONFIG_MESH
argument_list|)
end_if

begin_function
specifier|static
name|int
name|nl80211_addr_in_use
parameter_list|(
name|struct
name|nl80211_global
modifier|*
name|global
parameter_list|,
specifier|const
name|u8
modifier|*
name|addr
parameter_list|)
block|{
name|struct
name|wpa_driver_nl80211_data
modifier|*
name|drv
decl_stmt|;
name|dl_list_for_each
argument_list|(
argument|drv
argument_list|,
argument|&global->interfaces
argument_list|,
argument|struct wpa_driver_nl80211_data
argument_list|,
argument|list
argument_list|)
block|{
if|if
condition|(
name|os_memcmp
argument_list|(
name|addr
argument_list|,
name|drv
operator|->
name|first_bss
operator|->
name|addr
argument_list|,
name|ETH_ALEN
argument_list|)
operator|==
literal|0
condition|)
return|return
literal|1
return|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|nl80211_vif_addr
parameter_list|(
name|struct
name|wpa_driver_nl80211_data
modifier|*
name|drv
parameter_list|,
name|u8
modifier|*
name|new_addr
parameter_list|)
block|{
name|unsigned
name|int
name|idx
decl_stmt|;
if|if
condition|(
operator|!
name|drv
operator|->
name|global
condition|)
return|return
operator|-
literal|1
return|;
name|os_memcpy
argument_list|(
name|new_addr
argument_list|,
name|drv
operator|->
name|first_bss
operator|->
name|addr
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
for|for
control|(
name|idx
operator|=
literal|0
init|;
name|idx
operator|<
literal|64
condition|;
name|idx
operator|++
control|)
block|{
name|new_addr
index|[
literal|0
index|]
operator|=
name|drv
operator|->
name|first_bss
operator|->
name|addr
index|[
literal|0
index|]
operator||
literal|0x02
expr_stmt|;
name|new_addr
index|[
literal|0
index|]
operator|^=
name|idx
operator|<<
literal|2
expr_stmt|;
if|if
condition|(
operator|!
name|nl80211_addr_in_use
argument_list|(
name|drv
operator|->
name|global
argument_list|,
name|new_addr
argument_list|)
condition|)
break|break;
block|}
if|if
condition|(
name|idx
operator|==
literal|64
condition|)
return|return
operator|-
literal|1
return|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"nl80211: Assigned new virtual interface address "
name|MACSTR
argument_list|,
name|MAC2STR
argument_list|(
name|new_addr
argument_list|)
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* CONFIG_P2P || CONFIG_MESH */
end_comment

begin_struct
struct|struct
name|wdev_info
block|{
name|u64
name|wdev_id
decl_stmt|;
name|int
name|wdev_id_set
decl_stmt|;
name|u8
name|macaddr
index|[
name|ETH_ALEN
index|]
decl_stmt|;
block|}
struct|;
end_struct

begin_function
specifier|static
name|int
name|nl80211_wdev_handler
parameter_list|(
name|struct
name|nl_msg
modifier|*
name|msg
parameter_list|,
name|void
modifier|*
name|arg
parameter_list|)
block|{
name|struct
name|genlmsghdr
modifier|*
name|gnlh
init|=
name|nlmsg_data
argument_list|(
name|nlmsg_hdr
argument_list|(
name|msg
argument_list|)
argument_list|)
decl_stmt|;
name|struct
name|nlattr
modifier|*
name|tb
index|[
name|NL80211_ATTR_MAX
operator|+
literal|1
index|]
decl_stmt|;
name|struct
name|wdev_info
modifier|*
name|wi
init|=
name|arg
decl_stmt|;
name|nla_parse
argument_list|(
name|tb
argument_list|,
name|NL80211_ATTR_MAX
argument_list|,
name|genlmsg_attrdata
argument_list|(
name|gnlh
argument_list|,
literal|0
argument_list|)
argument_list|,
name|genlmsg_attrlen
argument_list|(
name|gnlh
argument_list|,
literal|0
argument_list|)
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|tb
index|[
name|NL80211_ATTR_WDEV
index|]
condition|)
block|{
name|wi
operator|->
name|wdev_id
operator|=
name|nla_get_u64
argument_list|(
name|tb
index|[
name|NL80211_ATTR_WDEV
index|]
argument_list|)
expr_stmt|;
name|wi
operator|->
name|wdev_id_set
operator|=
literal|1
expr_stmt|;
block|}
if|if
condition|(
name|tb
index|[
name|NL80211_ATTR_MAC
index|]
condition|)
name|os_memcpy
argument_list|(
name|wi
operator|->
name|macaddr
argument_list|,
name|nla_data
argument_list|(
name|tb
index|[
name|NL80211_ATTR_MAC
index|]
argument_list|)
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
return|return
name|NL_SKIP
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|wpa_driver_nl80211_if_add
parameter_list|(
name|void
modifier|*
name|priv
parameter_list|,
name|enum
name|wpa_driver_if_type
name|type
parameter_list|,
specifier|const
name|char
modifier|*
name|ifname
parameter_list|,
specifier|const
name|u8
modifier|*
name|addr
parameter_list|,
name|void
modifier|*
name|bss_ctx
parameter_list|,
name|void
modifier|*
modifier|*
name|drv_priv
parameter_list|,
name|char
modifier|*
name|force_ifname
parameter_list|,
name|u8
modifier|*
name|if_addr
parameter_list|,
specifier|const
name|char
modifier|*
name|bridge
parameter_list|,
name|int
name|use_existing
parameter_list|)
block|{
name|enum
name|nl80211_iftype
name|nlmode
decl_stmt|;
name|struct
name|i802_bss
modifier|*
name|bss
init|=
name|priv
decl_stmt|;
name|struct
name|wpa_driver_nl80211_data
modifier|*
name|drv
init|=
name|bss
operator|->
name|drv
decl_stmt|;
name|int
name|ifidx
decl_stmt|;
name|int
name|added
init|=
literal|1
decl_stmt|;
if|if
condition|(
name|addr
condition|)
name|os_memcpy
argument_list|(
name|if_addr
argument_list|,
name|addr
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
name|nlmode
operator|=
name|wpa_driver_nl80211_if_type
argument_list|(
name|type
argument_list|)
expr_stmt|;
if|if
condition|(
name|nlmode
operator|==
name|NL80211_IFTYPE_P2P_DEVICE
condition|)
block|{
name|struct
name|wdev_info
name|p2pdev_info
decl_stmt|;
name|os_memset
argument_list|(
operator|&
name|p2pdev_info
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|p2pdev_info
argument_list|)
argument_list|)
expr_stmt|;
name|ifidx
operator|=
name|nl80211_create_iface
argument_list|(
name|drv
argument_list|,
name|ifname
argument_list|,
name|nlmode
argument_list|,
name|addr
argument_list|,
literal|0
argument_list|,
name|nl80211_wdev_handler
argument_list|,
operator|&
name|p2pdev_info
argument_list|,
name|use_existing
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|p2pdev_info
operator|.
name|wdev_id_set
operator|||
name|ifidx
operator|!=
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"nl80211: Failed to create a P2P Device interface %s"
argument_list|,
name|ifname
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|drv
operator|->
name|global
operator|->
name|if_add_wdevid
operator|=
name|p2pdev_info
operator|.
name|wdev_id
expr_stmt|;
name|drv
operator|->
name|global
operator|->
name|if_add_wdevid_set
operator|=
name|p2pdev_info
operator|.
name|wdev_id_set
expr_stmt|;
if|if
condition|(
operator|!
name|is_zero_ether_addr
argument_list|(
name|p2pdev_info
operator|.
name|macaddr
argument_list|)
condition|)
name|os_memcpy
argument_list|(
name|if_addr
argument_list|,
name|p2pdev_info
operator|.
name|macaddr
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"nl80211: New P2P Device interface %s (0x%llx) created"
argument_list|,
name|ifname
argument_list|,
operator|(
name|long
name|long
name|unsigned
name|int
operator|)
name|p2pdev_info
operator|.
name|wdev_id
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|ifidx
operator|=
name|nl80211_create_iface
argument_list|(
name|drv
argument_list|,
name|ifname
argument_list|,
name|nlmode
argument_list|,
name|addr
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|use_existing
argument_list|)
expr_stmt|;
if|if
condition|(
name|use_existing
operator|&&
name|ifidx
operator|==
operator|-
name|ENFILE
condition|)
block|{
name|added
operator|=
literal|0
expr_stmt|;
name|ifidx
operator|=
name|if_nametoindex
argument_list|(
name|ifname
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|ifidx
operator|<
literal|0
condition|)
block|{
return|return
operator|-
literal|1
return|;
block|}
block|}
if|if
condition|(
operator|!
name|addr
condition|)
block|{
if|if
condition|(
name|drv
operator|->
name|nlmode
operator|==
name|NL80211_IFTYPE_P2P_DEVICE
condition|)
name|os_memcpy
argument_list|(
name|if_addr
argument_list|,
name|bss
operator|->
name|addr
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|linux_get_ifhwaddr
argument_list|(
name|drv
operator|->
name|global
operator|->
name|ioctl_sock
argument_list|,
name|bss
operator|->
name|ifname
argument_list|,
name|if_addr
argument_list|)
operator|<
literal|0
condition|)
block|{
if|if
condition|(
name|added
condition|)
name|nl80211_remove_iface
argument_list|(
name|drv
argument_list|,
name|ifidx
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
block|}
if|#
directive|if
name|defined
argument_list|(
name|CONFIG_P2P
argument_list|)
operator|||
name|defined
argument_list|(
name|CONFIG_MESH
argument_list|)
if|if
condition|(
operator|!
name|addr
operator|&&
operator|(
name|type
operator|==
name|WPA_IF_P2P_CLIENT
operator|||
name|type
operator|==
name|WPA_IF_P2P_GROUP
operator|||
name|type
operator|==
name|WPA_IF_P2P_GO
operator|||
name|type
operator|==
name|WPA_IF_MESH
operator|)
condition|)
block|{
comment|/* Enforce unique P2P Interface Address */
name|u8
name|new_addr
index|[
name|ETH_ALEN
index|]
decl_stmt|;
if|if
condition|(
name|linux_get_ifhwaddr
argument_list|(
name|drv
operator|->
name|global
operator|->
name|ioctl_sock
argument_list|,
name|ifname
argument_list|,
name|new_addr
argument_list|)
operator|<
literal|0
condition|)
block|{
if|if
condition|(
name|added
condition|)
name|nl80211_remove_iface
argument_list|(
name|drv
argument_list|,
name|ifidx
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
if|if
condition|(
name|nl80211_addr_in_use
argument_list|(
name|drv
operator|->
name|global
argument_list|,
name|new_addr
argument_list|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"nl80211: Allocate new address "
literal|"for %s interface"
argument_list|,
name|type
operator|==
name|WPA_IF_MESH
condition|?
literal|"mesh"
else|:
literal|"P2P group"
argument_list|)
expr_stmt|;
if|if
condition|(
name|nl80211_vif_addr
argument_list|(
name|drv
argument_list|,
name|new_addr
argument_list|)
operator|<
literal|0
condition|)
block|{
if|if
condition|(
name|added
condition|)
name|nl80211_remove_iface
argument_list|(
name|drv
argument_list|,
name|ifidx
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
if|if
condition|(
name|linux_set_ifhwaddr
argument_list|(
name|drv
operator|->
name|global
operator|->
name|ioctl_sock
argument_list|,
name|ifname
argument_list|,
name|new_addr
argument_list|)
operator|<
literal|0
condition|)
block|{
if|if
condition|(
name|added
condition|)
name|nl80211_remove_iface
argument_list|(
name|drv
argument_list|,
name|ifidx
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
block|}
name|os_memcpy
argument_list|(
name|if_addr
argument_list|,
name|new_addr
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
comment|/* CONFIG_P2P || CONFIG_MESH */
if|if
condition|(
name|type
operator|==
name|WPA_IF_AP_BSS
condition|)
block|{
name|struct
name|i802_bss
modifier|*
name|new_bss
init|=
name|os_zalloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|new_bss
argument_list|)
argument_list|)
decl_stmt|;
if|if
condition|(
name|new_bss
operator|==
name|NULL
condition|)
block|{
if|if
condition|(
name|added
condition|)
name|nl80211_remove_iface
argument_list|(
name|drv
argument_list|,
name|ifidx
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
if|if
condition|(
name|bridge
operator|&&
name|i802_check_bridge
argument_list|(
name|drv
argument_list|,
name|new_bss
argument_list|,
name|bridge
argument_list|,
name|ifname
argument_list|)
operator|<
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"nl80211: Failed to add the new "
literal|"interface %s to a bridge %s"
argument_list|,
name|ifname
argument_list|,
name|bridge
argument_list|)
expr_stmt|;
if|if
condition|(
name|added
condition|)
name|nl80211_remove_iface
argument_list|(
name|drv
argument_list|,
name|ifidx
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|new_bss
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
if|if
condition|(
name|linux_set_iface_flags
argument_list|(
name|drv
operator|->
name|global
operator|->
name|ioctl_sock
argument_list|,
name|ifname
argument_list|,
literal|1
argument_list|)
condition|)
block|{
if|if
condition|(
name|added
condition|)
name|nl80211_remove_iface
argument_list|(
name|drv
argument_list|,
name|ifidx
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|new_bss
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|os_strlcpy
argument_list|(
name|new_bss
operator|->
name|ifname
argument_list|,
name|ifname
argument_list|,
name|IFNAMSIZ
argument_list|)
expr_stmt|;
name|os_memcpy
argument_list|(
name|new_bss
operator|->
name|addr
argument_list|,
name|if_addr
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
name|new_bss
operator|->
name|ifindex
operator|=
name|ifidx
expr_stmt|;
name|new_bss
operator|->
name|drv
operator|=
name|drv
expr_stmt|;
name|new_bss
operator|->
name|next
operator|=
name|drv
operator|->
name|first_bss
operator|->
name|next
expr_stmt|;
name|new_bss
operator|->
name|freq
operator|=
name|drv
operator|->
name|first_bss
operator|->
name|freq
expr_stmt|;
name|new_bss
operator|->
name|ctx
operator|=
name|bss_ctx
expr_stmt|;
name|new_bss
operator|->
name|added_if
operator|=
name|added
expr_stmt|;
name|drv
operator|->
name|first_bss
operator|->
name|next
operator|=
name|new_bss
expr_stmt|;
if|if
condition|(
name|drv_priv
condition|)
operator|*
name|drv_priv
operator|=
name|new_bss
expr_stmt|;
name|nl80211_init_bss
argument_list|(
name|new_bss
argument_list|)
expr_stmt|;
comment|/* Subscribe management frames for this WPA_IF_AP_BSS */
if|if
condition|(
name|nl80211_setup_ap
argument_list|(
name|new_bss
argument_list|)
condition|)
return|return
operator|-
literal|1
return|;
block|}
if|if
condition|(
name|drv
operator|->
name|global
condition|)
name|drv
operator|->
name|global
operator|->
name|if_add_ifindex
operator|=
name|ifidx
expr_stmt|;
comment|/* 	 * Some virtual interfaces need to process EAPOL packets and events on 	 * the parent interface. This is used mainly with hostapd. 	 */
if|if
condition|(
name|ifidx
operator|>
literal|0
operator|&&
operator|(
name|drv
operator|->
name|hostapd
operator|||
name|nlmode
operator|==
name|NL80211_IFTYPE_AP_VLAN
operator|||
name|nlmode
operator|==
name|NL80211_IFTYPE_WDS
operator|||
name|nlmode
operator|==
name|NL80211_IFTYPE_MONITOR
operator|)
condition|)
name|add_ifidx
argument_list|(
name|drv
argument_list|,
name|ifidx
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|wpa_driver_nl80211_if_remove
parameter_list|(
name|struct
name|i802_bss
modifier|*
name|bss
parameter_list|,
name|enum
name|wpa_driver_if_type
name|type
parameter_list|,
specifier|const
name|char
modifier|*
name|ifname
parameter_list|)
block|{
name|struct
name|wpa_driver_nl80211_data
modifier|*
name|drv
init|=
name|bss
operator|->
name|drv
decl_stmt|;
name|int
name|ifindex
init|=
name|if_nametoindex
argument_list|(
name|ifname
argument_list|)
decl_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"nl80211: %s(type=%d ifname=%s) ifindex=%d added_if=%d"
argument_list|,
name|__func__
argument_list|,
name|type
argument_list|,
name|ifname
argument_list|,
name|ifindex
argument_list|,
name|bss
operator|->
name|added_if
argument_list|)
expr_stmt|;
if|if
condition|(
name|ifindex
operator|>
literal|0
operator|&&
operator|(
name|bss
operator|->
name|added_if
operator|||
name|bss
operator|->
name|ifindex
operator|!=
name|ifindex
operator|)
condition|)
name|nl80211_remove_iface
argument_list|(
name|drv
argument_list|,
name|ifindex
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|ifindex
operator|>
literal|0
operator|&&
operator|!
name|bss
operator|->
name|added_if
condition|)
block|{
name|struct
name|wpa_driver_nl80211_data
modifier|*
name|drv2
decl_stmt|;
name|dl_list_for_each
argument_list|(
argument|drv2
argument_list|,
argument|&drv->global->interfaces
argument_list|,
argument|struct wpa_driver_nl80211_data
argument_list|,
argument|list
argument_list|)
name|del_ifidx
argument_list|(
name|drv2
argument_list|,
name|ifindex
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|type
operator|!=
name|WPA_IF_AP_BSS
condition|)
return|return
literal|0
return|;
if|if
condition|(
name|bss
operator|->
name|added_if_into_bridge
condition|)
block|{
if|if
condition|(
name|linux_br_del_if
argument_list|(
name|drv
operator|->
name|global
operator|->
name|ioctl_sock
argument_list|,
name|bss
operator|->
name|brname
argument_list|,
name|bss
operator|->
name|ifname
argument_list|)
operator|<
literal|0
condition|)
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"nl80211: Failed to remove "
literal|"interface %s from bridge %s: %s"
argument_list|,
name|bss
operator|->
name|ifname
argument_list|,
name|bss
operator|->
name|brname
argument_list|,
name|strerror
argument_list|(
name|errno
argument_list|)
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|bss
operator|->
name|added_bridge
condition|)
block|{
if|if
condition|(
name|linux_br_del
argument_list|(
name|drv
operator|->
name|global
operator|->
name|ioctl_sock
argument_list|,
name|bss
operator|->
name|brname
argument_list|)
operator|<
literal|0
condition|)
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"nl80211: Failed to remove "
literal|"bridge %s: %s"
argument_list|,
name|bss
operator|->
name|brname
argument_list|,
name|strerror
argument_list|(
name|errno
argument_list|)
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|bss
operator|!=
name|drv
operator|->
name|first_bss
condition|)
block|{
name|struct
name|i802_bss
modifier|*
name|tbss
decl_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"nl80211: Not the first BSS - remove it"
argument_list|)
expr_stmt|;
for|for
control|(
name|tbss
operator|=
name|drv
operator|->
name|first_bss
init|;
name|tbss
condition|;
name|tbss
operator|=
name|tbss
operator|->
name|next
control|)
block|{
if|if
condition|(
name|tbss
operator|->
name|next
operator|==
name|bss
condition|)
block|{
name|tbss
operator|->
name|next
operator|=
name|bss
operator|->
name|next
expr_stmt|;
comment|/* Unsubscribe management frames */
name|nl80211_teardown_ap
argument_list|(
name|bss
argument_list|)
expr_stmt|;
name|nl80211_destroy_bss
argument_list|(
name|bss
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|bss
operator|->
name|added_if
condition|)
name|i802_set_iface_flags
argument_list|(
name|bss
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|bss
argument_list|)
expr_stmt|;
name|bss
operator|=
name|NULL
expr_stmt|;
break|break;
block|}
block|}
if|if
condition|(
name|bss
condition|)
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"nl80211: %s - could not find "
literal|"BSS %p in the list"
argument_list|,
name|__func__
argument_list|,
name|bss
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"nl80211: First BSS - reassign context"
argument_list|)
expr_stmt|;
name|nl80211_teardown_ap
argument_list|(
name|bss
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|bss
operator|->
name|added_if
operator|&&
operator|!
name|drv
operator|->
name|first_bss
operator|->
name|next
condition|)
name|wpa_driver_nl80211_del_beacon
argument_list|(
name|drv
argument_list|)
expr_stmt|;
name|nl80211_destroy_bss
argument_list|(
name|bss
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|bss
operator|->
name|added_if
condition|)
name|i802_set_iface_flags
argument_list|(
name|bss
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|drv
operator|->
name|first_bss
operator|->
name|next
condition|)
block|{
name|drv
operator|->
name|first_bss
operator|=
name|drv
operator|->
name|first_bss
operator|->
name|next
expr_stmt|;
name|drv
operator|->
name|ctx
operator|=
name|drv
operator|->
name|first_bss
operator|->
name|ctx
expr_stmt|;
name|os_free
argument_list|(
name|bss
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"nl80211: No second BSS to reassign context to"
argument_list|)
expr_stmt|;
block|}
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|cookie_handler
parameter_list|(
name|struct
name|nl_msg
modifier|*
name|msg
parameter_list|,
name|void
modifier|*
name|arg
parameter_list|)
block|{
name|struct
name|nlattr
modifier|*
name|tb
index|[
name|NL80211_ATTR_MAX
operator|+
literal|1
index|]
decl_stmt|;
name|struct
name|genlmsghdr
modifier|*
name|gnlh
init|=
name|nlmsg_data
argument_list|(
name|nlmsg_hdr
argument_list|(
name|msg
argument_list|)
argument_list|)
decl_stmt|;
name|u64
modifier|*
name|cookie
init|=
name|arg
decl_stmt|;
name|nla_parse
argument_list|(
name|tb
argument_list|,
name|NL80211_ATTR_MAX
argument_list|,
name|genlmsg_attrdata
argument_list|(
name|gnlh
argument_list|,
literal|0
argument_list|)
argument_list|,
name|genlmsg_attrlen
argument_list|(
name|gnlh
argument_list|,
literal|0
argument_list|)
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|tb
index|[
name|NL80211_ATTR_COOKIE
index|]
condition|)
operator|*
name|cookie
operator|=
name|nla_get_u64
argument_list|(
name|tb
index|[
name|NL80211_ATTR_COOKIE
index|]
argument_list|)
expr_stmt|;
return|return
name|NL_SKIP
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|nl80211_send_frame_cmd
parameter_list|(
name|struct
name|i802_bss
modifier|*
name|bss
parameter_list|,
name|unsigned
name|int
name|freq
parameter_list|,
name|unsigned
name|int
name|wait
parameter_list|,
specifier|const
name|u8
modifier|*
name|buf
parameter_list|,
name|size_t
name|buf_len
parameter_list|,
name|u64
modifier|*
name|cookie_out
parameter_list|,
name|int
name|no_cck
parameter_list|,
name|int
name|no_ack
parameter_list|,
name|int
name|offchanok
parameter_list|)
block|{
name|struct
name|wpa_driver_nl80211_data
modifier|*
name|drv
init|=
name|bss
operator|->
name|drv
decl_stmt|;
name|struct
name|nl_msg
modifier|*
name|msg
decl_stmt|;
name|u64
name|cookie
decl_stmt|;
name|int
name|ret
init|=
operator|-
literal|1
decl_stmt|;
name|wpa_printf
argument_list|(
name|MSG_MSGDUMP
argument_list|,
literal|"nl80211: CMD_FRAME freq=%u wait=%u no_cck=%d "
literal|"no_ack=%d offchanok=%d"
argument_list|,
name|freq
argument_list|,
name|wait
argument_list|,
name|no_cck
argument_list|,
name|no_ack
argument_list|,
name|offchanok
argument_list|)
expr_stmt|;
name|wpa_hexdump
argument_list|(
name|MSG_MSGDUMP
argument_list|,
literal|"CMD_FRAME"
argument_list|,
name|buf
argument_list|,
name|buf_len
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|msg
operator|=
name|nl80211_cmd_msg
argument_list|(
name|bss
argument_list|,
literal|0
argument_list|,
name|NL80211_CMD_FRAME
argument_list|)
operator|)
operator|||
operator|(
name|freq
operator|&&
name|nla_put_u32
argument_list|(
name|msg
argument_list|,
name|NL80211_ATTR_WIPHY_FREQ
argument_list|,
name|freq
argument_list|)
operator|)
operator|||
operator|(
name|wait
operator|&&
name|nla_put_u32
argument_list|(
name|msg
argument_list|,
name|NL80211_ATTR_DURATION
argument_list|,
name|wait
argument_list|)
operator|)
operator|||
operator|(
name|offchanok
operator|&&
operator|(
operator|(
name|drv
operator|->
name|capa
operator|.
name|flags
operator|&
name|WPA_DRIVER_FLAGS_OFFCHANNEL_TX
operator|)
operator|||
name|drv
operator|->
name|test_use_roc_tx
operator|)
operator|&&
name|nla_put_flag
argument_list|(
name|msg
argument_list|,
name|NL80211_ATTR_OFFCHANNEL_TX_OK
argument_list|)
operator|)
operator|||
operator|(
name|no_cck
operator|&&
name|nla_put_flag
argument_list|(
name|msg
argument_list|,
name|NL80211_ATTR_TX_NO_CCK_RATE
argument_list|)
operator|)
operator|||
operator|(
name|no_ack
operator|&&
name|nla_put_flag
argument_list|(
name|msg
argument_list|,
name|NL80211_ATTR_DONT_WAIT_FOR_ACK
argument_list|)
operator|)
operator|||
name|nla_put
argument_list|(
name|msg
argument_list|,
name|NL80211_ATTR_FRAME
argument_list|,
name|buf_len
argument_list|,
name|buf
argument_list|)
condition|)
goto|goto
name|fail
goto|;
name|cookie
operator|=
literal|0
expr_stmt|;
name|ret
operator|=
name|send_and_recv_msgs
argument_list|(
name|drv
argument_list|,
name|msg
argument_list|,
name|cookie_handler
argument_list|,
operator|&
name|cookie
argument_list|)
expr_stmt|;
name|msg
operator|=
name|NULL
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"nl80211: Frame command failed: ret=%d "
literal|"(%s) (freq=%u wait=%u)"
argument_list|,
name|ret
argument_list|,
name|strerror
argument_list|(
operator|-
name|ret
argument_list|)
argument_list|,
name|freq
argument_list|,
name|wait
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|wpa_printf
argument_list|(
name|MSG_MSGDUMP
argument_list|,
literal|"nl80211: Frame TX command accepted%s; "
literal|"cookie 0x%llx"
argument_list|,
name|no_ack
condition|?
literal|" (no ACK)"
else|:
literal|""
argument_list|,
operator|(
name|long
name|long
name|unsigned
name|int
operator|)
name|cookie
argument_list|)
expr_stmt|;
if|if
condition|(
name|cookie_out
condition|)
operator|*
name|cookie_out
operator|=
name|no_ack
condition|?
operator|(
name|u64
operator|)
operator|-
literal|1
else|:
name|cookie
expr_stmt|;
block|}
name|fail
label|:
name|nlmsg_free
argument_list|(
name|msg
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|wpa_driver_nl80211_send_action
parameter_list|(
name|struct
name|i802_bss
modifier|*
name|bss
parameter_list|,
name|unsigned
name|int
name|freq
parameter_list|,
name|unsigned
name|int
name|wait_time
parameter_list|,
specifier|const
name|u8
modifier|*
name|dst
parameter_list|,
specifier|const
name|u8
modifier|*
name|src
parameter_list|,
specifier|const
name|u8
modifier|*
name|bssid
parameter_list|,
specifier|const
name|u8
modifier|*
name|data
parameter_list|,
name|size_t
name|data_len
parameter_list|,
name|int
name|no_cck
parameter_list|)
block|{
name|struct
name|wpa_driver_nl80211_data
modifier|*
name|drv
init|=
name|bss
operator|->
name|drv
decl_stmt|;
name|int
name|ret
init|=
operator|-
literal|1
decl_stmt|;
name|u8
modifier|*
name|buf
decl_stmt|;
name|struct
name|ieee80211_hdr
modifier|*
name|hdr
decl_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"nl80211: Send Action frame (ifindex=%d, "
literal|"freq=%u MHz wait=%d ms no_cck=%d)"
argument_list|,
name|drv
operator|->
name|ifindex
argument_list|,
name|freq
argument_list|,
name|wait_time
argument_list|,
name|no_cck
argument_list|)
expr_stmt|;
name|buf
operator|=
name|os_zalloc
argument_list|(
literal|24
operator|+
name|data_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|buf
operator|==
name|NULL
condition|)
return|return
name|ret
return|;
name|os_memcpy
argument_list|(
name|buf
operator|+
literal|24
argument_list|,
name|data
argument_list|,
name|data_len
argument_list|)
expr_stmt|;
name|hdr
operator|=
operator|(
expr|struct
name|ieee80211_hdr
operator|*
operator|)
name|buf
expr_stmt|;
name|hdr
operator|->
name|frame_control
operator|=
name|IEEE80211_FC
argument_list|(
name|WLAN_FC_TYPE_MGMT
argument_list|,
name|WLAN_FC_STYPE_ACTION
argument_list|)
expr_stmt|;
name|os_memcpy
argument_list|(
name|hdr
operator|->
name|addr1
argument_list|,
name|dst
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
name|os_memcpy
argument_list|(
name|hdr
operator|->
name|addr2
argument_list|,
name|src
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
name|os_memcpy
argument_list|(
name|hdr
operator|->
name|addr3
argument_list|,
name|bssid
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
if|if
condition|(
name|is_ap_interface
argument_list|(
name|drv
operator|->
name|nlmode
argument_list|)
operator|&&
operator|(
operator|!
operator|(
name|drv
operator|->
name|capa
operator|.
name|flags
operator|&
name|WPA_DRIVER_FLAGS_OFFCHANNEL_TX
operator|)
operator|||
operator|(
name|int
operator|)
name|freq
operator|==
name|bss
operator|->
name|freq
operator|||
name|drv
operator|->
name|device_ap_sme
operator|||
operator|!
name|drv
operator|->
name|use_monitor
operator|)
condition|)
name|ret
operator|=
name|wpa_driver_nl80211_send_mlme
argument_list|(
name|bss
argument_list|,
name|buf
argument_list|,
literal|24
operator|+
name|data_len
argument_list|,
literal|0
argument_list|,
name|freq
argument_list|,
name|no_cck
argument_list|,
literal|1
argument_list|,
name|wait_time
argument_list|)
expr_stmt|;
else|else
name|ret
operator|=
name|nl80211_send_frame_cmd
argument_list|(
name|bss
argument_list|,
name|freq
argument_list|,
name|wait_time
argument_list|,
name|buf
argument_list|,
literal|24
operator|+
name|data_len
argument_list|,
operator|&
name|drv
operator|->
name|send_action_cookie
argument_list|,
name|no_cck
argument_list|,
literal|0
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|buf
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|wpa_driver_nl80211_send_action_cancel_wait
parameter_list|(
name|void
modifier|*
name|priv
parameter_list|)
block|{
name|struct
name|i802_bss
modifier|*
name|bss
init|=
name|priv
decl_stmt|;
name|struct
name|wpa_driver_nl80211_data
modifier|*
name|drv
init|=
name|bss
operator|->
name|drv
decl_stmt|;
name|struct
name|nl_msg
modifier|*
name|msg
decl_stmt|;
name|int
name|ret
decl_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"nl80211: Cancel TX frame wait: cookie=0x%llx"
argument_list|,
operator|(
name|long
name|long
name|unsigned
name|int
operator|)
name|drv
operator|->
name|send_action_cookie
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|msg
operator|=
name|nl80211_cmd_msg
argument_list|(
name|bss
argument_list|,
literal|0
argument_list|,
name|NL80211_CMD_FRAME_WAIT_CANCEL
argument_list|)
operator|)
operator|||
name|nla_put_u64
argument_list|(
name|msg
argument_list|,
name|NL80211_ATTR_COOKIE
argument_list|,
name|drv
operator|->
name|send_action_cookie
argument_list|)
condition|)
block|{
name|nlmsg_free
argument_list|(
name|msg
argument_list|)
expr_stmt|;
return|return;
block|}
name|ret
operator|=
name|send_and_recv_msgs
argument_list|(
name|drv
argument_list|,
name|msg
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"nl80211: wait cancel failed: ret=%d "
literal|"(%s)"
argument_list|,
name|ret
argument_list|,
name|strerror
argument_list|(
operator|-
name|ret
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|wpa_driver_nl80211_remain_on_channel
parameter_list|(
name|void
modifier|*
name|priv
parameter_list|,
name|unsigned
name|int
name|freq
parameter_list|,
name|unsigned
name|int
name|duration
parameter_list|)
block|{
name|struct
name|i802_bss
modifier|*
name|bss
init|=
name|priv
decl_stmt|;
name|struct
name|wpa_driver_nl80211_data
modifier|*
name|drv
init|=
name|bss
operator|->
name|drv
decl_stmt|;
name|struct
name|nl_msg
modifier|*
name|msg
decl_stmt|;
name|int
name|ret
decl_stmt|;
name|u64
name|cookie
decl_stmt|;
if|if
condition|(
operator|!
operator|(
name|msg
operator|=
name|nl80211_cmd_msg
argument_list|(
name|bss
argument_list|,
literal|0
argument_list|,
name|NL80211_CMD_REMAIN_ON_CHANNEL
argument_list|)
operator|)
operator|||
name|nla_put_u32
argument_list|(
name|msg
argument_list|,
name|NL80211_ATTR_WIPHY_FREQ
argument_list|,
name|freq
argument_list|)
operator|||
name|nla_put_u32
argument_list|(
name|msg
argument_list|,
name|NL80211_ATTR_DURATION
argument_list|,
name|duration
argument_list|)
condition|)
block|{
name|nlmsg_free
argument_list|(
name|msg
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|cookie
operator|=
literal|0
expr_stmt|;
name|ret
operator|=
name|send_and_recv_msgs
argument_list|(
name|drv
argument_list|,
name|msg
argument_list|,
name|cookie_handler
argument_list|,
operator|&
name|cookie
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|==
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"nl80211: Remain-on-channel cookie "
literal|"0x%llx for freq=%u MHz duration=%u"
argument_list|,
operator|(
name|long
name|long
name|unsigned
name|int
operator|)
name|cookie
argument_list|,
name|freq
argument_list|,
name|duration
argument_list|)
expr_stmt|;
name|drv
operator|->
name|remain_on_chan_cookie
operator|=
name|cookie
expr_stmt|;
name|drv
operator|->
name|pending_remain_on_chan
operator|=
literal|1
expr_stmt|;
return|return
literal|0
return|;
block|}
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"nl80211: Failed to request remain-on-channel "
literal|"(freq=%d duration=%u): %d (%s)"
argument_list|,
name|freq
argument_list|,
name|duration
argument_list|,
name|ret
argument_list|,
name|strerror
argument_list|(
operator|-
name|ret
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|wpa_driver_nl80211_cancel_remain_on_channel
parameter_list|(
name|void
modifier|*
name|priv
parameter_list|)
block|{
name|struct
name|i802_bss
modifier|*
name|bss
init|=
name|priv
decl_stmt|;
name|struct
name|wpa_driver_nl80211_data
modifier|*
name|drv
init|=
name|bss
operator|->
name|drv
decl_stmt|;
name|struct
name|nl_msg
modifier|*
name|msg
decl_stmt|;
name|int
name|ret
decl_stmt|;
if|if
condition|(
operator|!
name|drv
operator|->
name|pending_remain_on_chan
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"nl80211: No pending remain-on-channel "
literal|"to cancel"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"nl80211: Cancel remain-on-channel with cookie "
literal|"0x%llx"
argument_list|,
operator|(
name|long
name|long
name|unsigned
name|int
operator|)
name|drv
operator|->
name|remain_on_chan_cookie
argument_list|)
expr_stmt|;
name|msg
operator|=
name|nl80211_cmd_msg
argument_list|(
name|bss
argument_list|,
literal|0
argument_list|,
name|NL80211_CMD_CANCEL_REMAIN_ON_CHANNEL
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|msg
operator|||
name|nla_put_u64
argument_list|(
name|msg
argument_list|,
name|NL80211_ATTR_COOKIE
argument_list|,
name|drv
operator|->
name|remain_on_chan_cookie
argument_list|)
condition|)
block|{
name|nlmsg_free
argument_list|(
name|msg
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|ret
operator|=
name|send_and_recv_msgs
argument_list|(
name|drv
argument_list|,
name|msg
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|==
literal|0
condition|)
return|return
literal|0
return|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"nl80211: Failed to cancel remain-on-channel: "
literal|"%d (%s)"
argument_list|,
name|ret
argument_list|,
name|strerror
argument_list|(
operator|-
name|ret
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|wpa_driver_nl80211_probe_req_report
parameter_list|(
name|struct
name|i802_bss
modifier|*
name|bss
parameter_list|,
name|int
name|report
parameter_list|)
block|{
name|struct
name|wpa_driver_nl80211_data
modifier|*
name|drv
init|=
name|bss
operator|->
name|drv
decl_stmt|;
if|if
condition|(
operator|!
name|report
condition|)
block|{
if|if
condition|(
name|bss
operator|->
name|nl_preq
operator|&&
name|drv
operator|->
name|device_ap_sme
operator|&&
name|is_ap_interface
argument_list|(
name|drv
operator|->
name|nlmode
argument_list|)
operator|&&
operator|!
name|bss
operator|->
name|in_deinit
operator|&&
operator|!
name|bss
operator|->
name|static_ap
condition|)
block|{
comment|/* 			 * Do not disable Probe Request reporting that was 			 * enabled in nl80211_setup_ap(). 			 */
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"nl80211: Skip disabling of "
literal|"Probe Request reporting nl_preq=%p while "
literal|"in AP mode"
argument_list|,
name|bss
operator|->
name|nl_preq
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|bss
operator|->
name|nl_preq
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"nl80211: Disable Probe Request "
literal|"reporting nl_preq=%p"
argument_list|,
name|bss
operator|->
name|nl_preq
argument_list|)
expr_stmt|;
name|nl80211_destroy_eloop_handle
argument_list|(
operator|&
name|bss
operator|->
name|nl_preq
argument_list|)
expr_stmt|;
block|}
return|return
literal|0
return|;
block|}
if|if
condition|(
name|bss
operator|->
name|nl_preq
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"nl80211: Probe Request reporting "
literal|"already on! nl_preq=%p"
argument_list|,
name|bss
operator|->
name|nl_preq
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
name|bss
operator|->
name|nl_preq
operator|=
name|nl_create_handle
argument_list|(
name|drv
operator|->
name|global
operator|->
name|nl_cb
argument_list|,
literal|"preq"
argument_list|)
expr_stmt|;
if|if
condition|(
name|bss
operator|->
name|nl_preq
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"nl80211: Enable Probe Request "
literal|"reporting nl_preq=%p"
argument_list|,
name|bss
operator|->
name|nl_preq
argument_list|)
expr_stmt|;
if|if
condition|(
name|nl80211_register_frame
argument_list|(
name|bss
argument_list|,
name|bss
operator|->
name|nl_preq
argument_list|,
operator|(
name|WLAN_FC_TYPE_MGMT
operator|<<
literal|2
operator|)
operator||
operator|(
name|WLAN_FC_STYPE_PROBE_REQ
operator|<<
literal|4
operator|)
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
operator|<
literal|0
condition|)
goto|goto
name|out_err
goto|;
name|nl80211_register_eloop_read
argument_list|(
operator|&
name|bss
operator|->
name|nl_preq
argument_list|,
name|wpa_driver_nl80211_event_receive
argument_list|,
name|bss
operator|->
name|nl_cb
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
name|out_err
label|:
name|nl_destroy_handles
argument_list|(
operator|&
name|bss
operator|->
name|nl_preq
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|nl80211_disable_11b_rates
parameter_list|(
name|struct
name|wpa_driver_nl80211_data
modifier|*
name|drv
parameter_list|,
name|int
name|ifindex
parameter_list|,
name|int
name|disabled
parameter_list|)
block|{
name|struct
name|nl_msg
modifier|*
name|msg
decl_stmt|;
name|struct
name|nlattr
modifier|*
name|bands
decl_stmt|,
modifier|*
name|band
decl_stmt|;
name|int
name|ret
decl_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"nl80211: NL80211_CMD_SET_TX_BITRATE_MASK (ifindex=%d %s)"
argument_list|,
name|ifindex
argument_list|,
name|disabled
condition|?
literal|"NL80211_TXRATE_LEGACY=OFDM-only"
else|:
literal|"no NL80211_TXRATE_LEGACY constraint"
argument_list|)
expr_stmt|;
name|msg
operator|=
name|nl80211_ifindex_msg
argument_list|(
name|drv
argument_list|,
name|ifindex
argument_list|,
literal|0
argument_list|,
name|NL80211_CMD_SET_TX_BITRATE_MASK
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|msg
condition|)
return|return
operator|-
literal|1
return|;
name|bands
operator|=
name|nla_nest_start
argument_list|(
name|msg
argument_list|,
name|NL80211_ATTR_TX_RATES
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|bands
condition|)
goto|goto
name|fail
goto|;
comment|/* 	 * Disable 2 GHz rates 1, 2, 5.5, 11 Mbps by masking out everything 	 * else apart from 6, 9, 12, 18, 24, 36, 48, 54 Mbps from non-MCS 	 * rates. All 5 GHz rates are left enabled. 	 */
name|band
operator|=
name|nla_nest_start
argument_list|(
name|msg
argument_list|,
name|NL80211_BAND_2GHZ
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|band
operator|||
operator|(
name|disabled
operator|&&
name|nla_put
argument_list|(
name|msg
argument_list|,
name|NL80211_TXRATE_LEGACY
argument_list|,
literal|8
argument_list|,
literal|"\x0c\x12\x18\x24\x30\x48\x60\x6c"
argument_list|)
operator|)
condition|)
goto|goto
name|fail
goto|;
name|nla_nest_end
argument_list|(
name|msg
argument_list|,
name|band
argument_list|)
expr_stmt|;
name|nla_nest_end
argument_list|(
name|msg
argument_list|,
name|bands
argument_list|)
expr_stmt|;
name|ret
operator|=
name|send_and_recv_msgs
argument_list|(
name|drv
argument_list|,
name|msg
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"nl80211: Set TX rates failed: ret=%d "
literal|"(%s)"
argument_list|,
name|ret
argument_list|,
name|strerror
argument_list|(
operator|-
name|ret
argument_list|)
argument_list|)
expr_stmt|;
block|}
else|else
name|drv
operator|->
name|disabled_11b_rates
operator|=
name|disabled
expr_stmt|;
return|return
name|ret
return|;
name|fail
label|:
name|nlmsg_free
argument_list|(
name|msg
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|wpa_driver_nl80211_deinit_ap
parameter_list|(
name|void
modifier|*
name|priv
parameter_list|)
block|{
name|struct
name|i802_bss
modifier|*
name|bss
init|=
name|priv
decl_stmt|;
name|struct
name|wpa_driver_nl80211_data
modifier|*
name|drv
init|=
name|bss
operator|->
name|drv
decl_stmt|;
if|if
condition|(
operator|!
name|is_ap_interface
argument_list|(
name|drv
operator|->
name|nlmode
argument_list|)
condition|)
return|return
operator|-
literal|1
return|;
name|wpa_driver_nl80211_del_beacon
argument_list|(
name|drv
argument_list|)
expr_stmt|;
name|bss
operator|->
name|beacon_set
operator|=
literal|0
expr_stmt|;
comment|/* 	 * If the P2P GO interface was dynamically added, then it is 	 * possible that the interface change to station is not possible. 	 */
if|if
condition|(
name|drv
operator|->
name|nlmode
operator|==
name|NL80211_IFTYPE_P2P_GO
operator|&&
name|bss
operator|->
name|if_dynamic
condition|)
return|return
literal|0
return|;
return|return
name|wpa_driver_nl80211_set_mode
argument_list|(
name|priv
argument_list|,
name|NL80211_IFTYPE_STATION
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|wpa_driver_nl80211_stop_ap
parameter_list|(
name|void
modifier|*
name|priv
parameter_list|)
block|{
name|struct
name|i802_bss
modifier|*
name|bss
init|=
name|priv
decl_stmt|;
name|struct
name|wpa_driver_nl80211_data
modifier|*
name|drv
init|=
name|bss
operator|->
name|drv
decl_stmt|;
if|if
condition|(
operator|!
name|is_ap_interface
argument_list|(
name|drv
operator|->
name|nlmode
argument_list|)
condition|)
return|return
operator|-
literal|1
return|;
name|wpa_driver_nl80211_del_beacon
argument_list|(
name|drv
argument_list|)
expr_stmt|;
name|bss
operator|->
name|beacon_set
operator|=
literal|0
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|wpa_driver_nl80211_deinit_p2p_cli
parameter_list|(
name|void
modifier|*
name|priv
parameter_list|)
block|{
name|struct
name|i802_bss
modifier|*
name|bss
init|=
name|priv
decl_stmt|;
name|struct
name|wpa_driver_nl80211_data
modifier|*
name|drv
init|=
name|bss
operator|->
name|drv
decl_stmt|;
if|if
condition|(
name|drv
operator|->
name|nlmode
operator|!=
name|NL80211_IFTYPE_P2P_CLIENT
condition|)
return|return
operator|-
literal|1
return|;
comment|/* 	 * If the P2P Client interface was dynamically added, then it is 	 * possible that the interface change to station is not possible. 	 */
if|if
condition|(
name|bss
operator|->
name|if_dynamic
condition|)
return|return
literal|0
return|;
return|return
name|wpa_driver_nl80211_set_mode
argument_list|(
name|priv
argument_list|,
name|NL80211_IFTYPE_STATION
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|wpa_driver_nl80211_resume
parameter_list|(
name|void
modifier|*
name|priv
parameter_list|)
block|{
name|struct
name|i802_bss
modifier|*
name|bss
init|=
name|priv
decl_stmt|;
if|if
condition|(
name|i802_set_iface_flags
argument_list|(
name|bss
argument_list|,
literal|1
argument_list|)
condition|)
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"nl80211: Failed to set interface up on resume event"
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|nl80211_signal_monitor
parameter_list|(
name|void
modifier|*
name|priv
parameter_list|,
name|int
name|threshold
parameter_list|,
name|int
name|hysteresis
parameter_list|)
block|{
name|struct
name|i802_bss
modifier|*
name|bss
init|=
name|priv
decl_stmt|;
name|struct
name|wpa_driver_nl80211_data
modifier|*
name|drv
init|=
name|bss
operator|->
name|drv
decl_stmt|;
name|struct
name|nl_msg
modifier|*
name|msg
decl_stmt|;
name|struct
name|nlattr
modifier|*
name|cqm
decl_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"nl80211: Signal monitor threshold=%d "
literal|"hysteresis=%d"
argument_list|,
name|threshold
argument_list|,
name|hysteresis
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|msg
operator|=
name|nl80211_bss_msg
argument_list|(
name|bss
argument_list|,
literal|0
argument_list|,
name|NL80211_CMD_SET_CQM
argument_list|)
operator|)
operator|||
operator|!
operator|(
name|cqm
operator|=
name|nla_nest_start
argument_list|(
name|msg
argument_list|,
name|NL80211_ATTR_CQM
argument_list|)
operator|)
operator|||
name|nla_put_u32
argument_list|(
name|msg
argument_list|,
name|NL80211_ATTR_CQM_RSSI_THOLD
argument_list|,
name|threshold
argument_list|)
operator|||
name|nla_put_u32
argument_list|(
name|msg
argument_list|,
name|NL80211_ATTR_CQM_RSSI_HYST
argument_list|,
name|hysteresis
argument_list|)
condition|)
block|{
name|nlmsg_free
argument_list|(
name|msg
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|nla_nest_end
argument_list|(
name|msg
argument_list|,
name|cqm
argument_list|)
expr_stmt|;
return|return
name|send_and_recv_msgs
argument_list|(
name|drv
argument_list|,
name|msg
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|get_channel_width
parameter_list|(
name|struct
name|nl_msg
modifier|*
name|msg
parameter_list|,
name|void
modifier|*
name|arg
parameter_list|)
block|{
name|struct
name|nlattr
modifier|*
name|tb
index|[
name|NL80211_ATTR_MAX
operator|+
literal|1
index|]
decl_stmt|;
name|struct
name|genlmsghdr
modifier|*
name|gnlh
init|=
name|nlmsg_data
argument_list|(
name|nlmsg_hdr
argument_list|(
name|msg
argument_list|)
argument_list|)
decl_stmt|;
name|struct
name|wpa_signal_info
modifier|*
name|sig_change
init|=
name|arg
decl_stmt|;
name|nla_parse
argument_list|(
name|tb
argument_list|,
name|NL80211_ATTR_MAX
argument_list|,
name|genlmsg_attrdata
argument_list|(
name|gnlh
argument_list|,
literal|0
argument_list|)
argument_list|,
name|genlmsg_attrlen
argument_list|(
name|gnlh
argument_list|,
literal|0
argument_list|)
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|sig_change
operator|->
name|center_frq1
operator|=
operator|-
literal|1
expr_stmt|;
name|sig_change
operator|->
name|center_frq2
operator|=
operator|-
literal|1
expr_stmt|;
name|sig_change
operator|->
name|chanwidth
operator|=
name|CHAN_WIDTH_UNKNOWN
expr_stmt|;
if|if
condition|(
name|tb
index|[
name|NL80211_ATTR_CHANNEL_WIDTH
index|]
condition|)
block|{
name|sig_change
operator|->
name|chanwidth
operator|=
name|convert2width
argument_list|(
name|nla_get_u32
argument_list|(
name|tb
index|[
name|NL80211_ATTR_CHANNEL_WIDTH
index|]
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|tb
index|[
name|NL80211_ATTR_CENTER_FREQ1
index|]
condition|)
name|sig_change
operator|->
name|center_frq1
operator|=
name|nla_get_u32
argument_list|(
name|tb
index|[
name|NL80211_ATTR_CENTER_FREQ1
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|tb
index|[
name|NL80211_ATTR_CENTER_FREQ2
index|]
condition|)
name|sig_change
operator|->
name|center_frq2
operator|=
name|nla_get_u32
argument_list|(
name|tb
index|[
name|NL80211_ATTR_CENTER_FREQ2
index|]
argument_list|)
expr_stmt|;
block|}
return|return
name|NL_SKIP
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|nl80211_get_channel_width
parameter_list|(
name|struct
name|wpa_driver_nl80211_data
modifier|*
name|drv
parameter_list|,
name|struct
name|wpa_signal_info
modifier|*
name|sig
parameter_list|)
block|{
name|struct
name|nl_msg
modifier|*
name|msg
decl_stmt|;
name|msg
operator|=
name|nl80211_drv_msg
argument_list|(
name|drv
argument_list|,
literal|0
argument_list|,
name|NL80211_CMD_GET_INTERFACE
argument_list|)
expr_stmt|;
return|return
name|send_and_recv_msgs
argument_list|(
name|drv
argument_list|,
name|msg
argument_list|,
name|get_channel_width
argument_list|,
name|sig
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|nl80211_signal_poll
parameter_list|(
name|void
modifier|*
name|priv
parameter_list|,
name|struct
name|wpa_signal_info
modifier|*
name|si
parameter_list|)
block|{
name|struct
name|i802_bss
modifier|*
name|bss
init|=
name|priv
decl_stmt|;
name|struct
name|wpa_driver_nl80211_data
modifier|*
name|drv
init|=
name|bss
operator|->
name|drv
decl_stmt|;
name|int
name|res
decl_stmt|;
name|os_memset
argument_list|(
name|si
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|si
argument_list|)
argument_list|)
expr_stmt|;
name|res
operator|=
name|nl80211_get_link_signal
argument_list|(
name|drv
argument_list|,
name|si
argument_list|)
expr_stmt|;
if|if
condition|(
name|res
operator|!=
literal|0
condition|)
return|return
name|res
return|;
name|res
operator|=
name|nl80211_get_channel_width
argument_list|(
name|drv
argument_list|,
name|si
argument_list|)
expr_stmt|;
if|if
condition|(
name|res
operator|!=
literal|0
condition|)
return|return
name|res
return|;
return|return
name|nl80211_get_link_noise
argument_list|(
name|drv
argument_list|,
name|si
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|wpa_driver_nl80211_shared_freq
parameter_list|(
name|void
modifier|*
name|priv
parameter_list|)
block|{
name|struct
name|i802_bss
modifier|*
name|bss
init|=
name|priv
decl_stmt|;
name|struct
name|wpa_driver_nl80211_data
modifier|*
name|drv
init|=
name|bss
operator|->
name|drv
decl_stmt|;
name|struct
name|wpa_driver_nl80211_data
modifier|*
name|driver
decl_stmt|;
name|int
name|freq
init|=
literal|0
decl_stmt|;
comment|/* 	 * If the same PHY is in connected state with some other interface, 	 * then retrieve the assoc freq. 	 */
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"nl80211: Get shared freq for PHY %s"
argument_list|,
name|drv
operator|->
name|phyname
argument_list|)
expr_stmt|;
name|dl_list_for_each
argument_list|(
argument|driver
argument_list|,
argument|&drv->global->interfaces
argument_list|,
argument|struct wpa_driver_nl80211_data
argument_list|,
argument|list
argument_list|)
block|{
if|if
condition|(
name|drv
operator|==
name|driver
operator|||
name|os_strcmp
argument_list|(
name|drv
operator|->
name|phyname
argument_list|,
name|driver
operator|->
name|phyname
argument_list|)
operator|!=
literal|0
operator|||
operator|!
name|driver
operator|->
name|associated
condition|)
continue|continue;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"nl80211: Found a match for PHY %s - %s "
name|MACSTR
argument_list|,
name|driver
operator|->
name|phyname
argument_list|,
name|driver
operator|->
name|first_bss
operator|->
name|ifname
argument_list|,
name|MAC2STR
argument_list|(
name|driver
operator|->
name|first_bss
operator|->
name|addr
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|is_ap_interface
argument_list|(
name|driver
operator|->
name|nlmode
argument_list|)
condition|)
name|freq
operator|=
name|driver
operator|->
name|first_bss
operator|->
name|freq
expr_stmt|;
else|else
name|freq
operator|=
name|nl80211_get_assoc_freq
argument_list|(
name|driver
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"nl80211: Shared freq for PHY %s: %d"
argument_list|,
name|drv
operator|->
name|phyname
argument_list|,
name|freq
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|freq
condition|)
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"nl80211: No shared interface for "
literal|"PHY (%s) in associated state"
argument_list|,
name|drv
operator|->
name|phyname
argument_list|)
expr_stmt|;
return|return
name|freq
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|nl80211_send_frame
parameter_list|(
name|void
modifier|*
name|priv
parameter_list|,
specifier|const
name|u8
modifier|*
name|data
parameter_list|,
name|size_t
name|data_len
parameter_list|,
name|int
name|encrypt
parameter_list|)
block|{
name|struct
name|i802_bss
modifier|*
name|bss
init|=
name|priv
decl_stmt|;
return|return
name|wpa_driver_nl80211_send_frame
argument_list|(
name|bss
argument_list|,
name|data
argument_list|,
name|data_len
argument_list|,
name|encrypt
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|nl80211_set_param
parameter_list|(
name|void
modifier|*
name|priv
parameter_list|,
specifier|const
name|char
modifier|*
name|param
parameter_list|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"nl80211: driver param='%s'"
argument_list|,
name|param
argument_list|)
expr_stmt|;
if|if
condition|(
name|param
operator|==
name|NULL
condition|)
return|return
literal|0
return|;
ifdef|#
directive|ifdef
name|CONFIG_P2P
if|if
condition|(
name|os_strstr
argument_list|(
name|param
argument_list|,
literal|"use_p2p_group_interface=1"
argument_list|)
condition|)
block|{
name|struct
name|i802_bss
modifier|*
name|bss
init|=
name|priv
decl_stmt|;
name|struct
name|wpa_driver_nl80211_data
modifier|*
name|drv
init|=
name|bss
operator|->
name|drv
decl_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"nl80211: Use separate P2P group "
literal|"interface"
argument_list|)
expr_stmt|;
name|drv
operator|->
name|capa
operator|.
name|flags
operator||=
name|WPA_DRIVER_FLAGS_P2P_CONCURRENT
expr_stmt|;
name|drv
operator|->
name|capa
operator|.
name|flags
operator||=
name|WPA_DRIVER_FLAGS_P2P_MGMT_AND_NON_P2P
expr_stmt|;
block|}
endif|#
directive|endif
comment|/* CONFIG_P2P */
if|if
condition|(
name|os_strstr
argument_list|(
name|param
argument_list|,
literal|"use_monitor=1"
argument_list|)
condition|)
block|{
name|struct
name|i802_bss
modifier|*
name|bss
init|=
name|priv
decl_stmt|;
name|struct
name|wpa_driver_nl80211_data
modifier|*
name|drv
init|=
name|bss
operator|->
name|drv
decl_stmt|;
name|drv
operator|->
name|use_monitor
operator|=
literal|1
expr_stmt|;
block|}
if|if
condition|(
name|os_strstr
argument_list|(
name|param
argument_list|,
literal|"force_connect_cmd=1"
argument_list|)
condition|)
block|{
name|struct
name|i802_bss
modifier|*
name|bss
init|=
name|priv
decl_stmt|;
name|struct
name|wpa_driver_nl80211_data
modifier|*
name|drv
init|=
name|bss
operator|->
name|drv
decl_stmt|;
name|drv
operator|->
name|capa
operator|.
name|flags
operator|&=
operator|~
name|WPA_DRIVER_FLAGS_SME
expr_stmt|;
name|drv
operator|->
name|force_connect_cmd
operator|=
literal|1
expr_stmt|;
block|}
if|if
condition|(
name|os_strstr
argument_list|(
name|param
argument_list|,
literal|"no_offchannel_tx=1"
argument_list|)
condition|)
block|{
name|struct
name|i802_bss
modifier|*
name|bss
init|=
name|priv
decl_stmt|;
name|struct
name|wpa_driver_nl80211_data
modifier|*
name|drv
init|=
name|bss
operator|->
name|drv
decl_stmt|;
name|drv
operator|->
name|capa
operator|.
name|flags
operator|&=
operator|~
name|WPA_DRIVER_FLAGS_OFFCHANNEL_TX
expr_stmt|;
name|drv
operator|->
name|test_use_roc_tx
operator|=
literal|1
expr_stmt|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|void
modifier|*
name|nl80211_global_init
parameter_list|(
name|void
parameter_list|)
block|{
name|struct
name|nl80211_global
modifier|*
name|global
decl_stmt|;
name|struct
name|netlink_config
modifier|*
name|cfg
decl_stmt|;
name|global
operator|=
name|os_zalloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|global
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|global
operator|==
name|NULL
condition|)
return|return
name|NULL
return|;
name|global
operator|->
name|ioctl_sock
operator|=
operator|-
literal|1
expr_stmt|;
name|dl_list_init
argument_list|(
operator|&
name|global
operator|->
name|interfaces
argument_list|)
expr_stmt|;
name|global
operator|->
name|if_add_ifindex
operator|=
operator|-
literal|1
expr_stmt|;
name|cfg
operator|=
name|os_zalloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|cfg
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|cfg
operator|==
name|NULL
condition|)
goto|goto
name|err
goto|;
name|cfg
operator|->
name|ctx
operator|=
name|global
expr_stmt|;
name|cfg
operator|->
name|newlink_cb
operator|=
name|wpa_driver_nl80211_event_rtm_newlink
expr_stmt|;
name|cfg
operator|->
name|dellink_cb
operator|=
name|wpa_driver_nl80211_event_rtm_dellink
expr_stmt|;
name|global
operator|->
name|netlink
operator|=
name|netlink_init
argument_list|(
name|cfg
argument_list|)
expr_stmt|;
if|if
condition|(
name|global
operator|->
name|netlink
operator|==
name|NULL
condition|)
block|{
name|os_free
argument_list|(
name|cfg
argument_list|)
expr_stmt|;
goto|goto
name|err
goto|;
block|}
if|if
condition|(
name|wpa_driver_nl80211_init_nl_global
argument_list|(
name|global
argument_list|)
operator|<
literal|0
condition|)
goto|goto
name|err
goto|;
name|global
operator|->
name|ioctl_sock
operator|=
name|socket
argument_list|(
name|PF_INET
argument_list|,
name|SOCK_DGRAM
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|global
operator|->
name|ioctl_sock
operator|<
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"nl80211: socket(PF_INET,SOCK_DGRAM) failed: %s"
argument_list|,
name|strerror
argument_list|(
name|errno
argument_list|)
argument_list|)
expr_stmt|;
goto|goto
name|err
goto|;
block|}
return|return
name|global
return|;
name|err
label|:
name|nl80211_global_deinit
argument_list|(
name|global
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|nl80211_global_deinit
parameter_list|(
name|void
modifier|*
name|priv
parameter_list|)
block|{
name|struct
name|nl80211_global
modifier|*
name|global
init|=
name|priv
decl_stmt|;
if|if
condition|(
name|global
operator|==
name|NULL
condition|)
return|return;
if|if
condition|(
operator|!
name|dl_list_empty
argument_list|(
operator|&
name|global
operator|->
name|interfaces
argument_list|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"nl80211: %u interface(s) remain at "
literal|"nl80211_global_deinit"
argument_list|,
name|dl_list_len
argument_list|(
operator|&
name|global
operator|->
name|interfaces
argument_list|)
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|global
operator|->
name|netlink
condition|)
name|netlink_deinit
argument_list|(
name|global
operator|->
name|netlink
argument_list|)
expr_stmt|;
name|nl_destroy_handles
argument_list|(
operator|&
name|global
operator|->
name|nl
argument_list|)
expr_stmt|;
if|if
condition|(
name|global
operator|->
name|nl_event
condition|)
name|nl80211_destroy_eloop_handle
argument_list|(
operator|&
name|global
operator|->
name|nl_event
argument_list|)
expr_stmt|;
name|nl_cb_put
argument_list|(
name|global
operator|->
name|nl_cb
argument_list|)
expr_stmt|;
if|if
condition|(
name|global
operator|->
name|ioctl_sock
operator|>=
literal|0
condition|)
name|close
argument_list|(
name|global
operator|->
name|ioctl_sock
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|global
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
specifier|const
name|char
modifier|*
name|nl80211_get_radio_name
parameter_list|(
name|void
modifier|*
name|priv
parameter_list|)
block|{
name|struct
name|i802_bss
modifier|*
name|bss
init|=
name|priv
decl_stmt|;
name|struct
name|wpa_driver_nl80211_data
modifier|*
name|drv
init|=
name|bss
operator|->
name|drv
decl_stmt|;
return|return
name|drv
operator|->
name|phyname
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|nl80211_pmkid
parameter_list|(
name|struct
name|i802_bss
modifier|*
name|bss
parameter_list|,
name|int
name|cmd
parameter_list|,
specifier|const
name|u8
modifier|*
name|bssid
parameter_list|,
specifier|const
name|u8
modifier|*
name|pmkid
parameter_list|)
block|{
name|struct
name|nl_msg
modifier|*
name|msg
decl_stmt|;
if|if
condition|(
operator|!
operator|(
name|msg
operator|=
name|nl80211_bss_msg
argument_list|(
name|bss
argument_list|,
literal|0
argument_list|,
name|cmd
argument_list|)
operator|)
operator|||
operator|(
name|pmkid
operator|&&
name|nla_put
argument_list|(
name|msg
argument_list|,
name|NL80211_ATTR_PMKID
argument_list|,
literal|16
argument_list|,
name|pmkid
argument_list|)
operator|)
operator|||
operator|(
name|bssid
operator|&&
name|nla_put
argument_list|(
name|msg
argument_list|,
name|NL80211_ATTR_MAC
argument_list|,
name|ETH_ALEN
argument_list|,
name|bssid
argument_list|)
operator|)
condition|)
block|{
name|nlmsg_free
argument_list|(
name|msg
argument_list|)
expr_stmt|;
return|return
operator|-
name|ENOBUFS
return|;
block|}
return|return
name|send_and_recv_msgs
argument_list|(
name|bss
operator|->
name|drv
argument_list|,
name|msg
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|nl80211_add_pmkid
parameter_list|(
name|void
modifier|*
name|priv
parameter_list|,
specifier|const
name|u8
modifier|*
name|bssid
parameter_list|,
specifier|const
name|u8
modifier|*
name|pmkid
parameter_list|)
block|{
name|struct
name|i802_bss
modifier|*
name|bss
init|=
name|priv
decl_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"nl80211: Add PMKID for "
name|MACSTR
argument_list|,
name|MAC2STR
argument_list|(
name|bssid
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|nl80211_pmkid
argument_list|(
name|bss
argument_list|,
name|NL80211_CMD_SET_PMKSA
argument_list|,
name|bssid
argument_list|,
name|pmkid
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|nl80211_remove_pmkid
parameter_list|(
name|void
modifier|*
name|priv
parameter_list|,
specifier|const
name|u8
modifier|*
name|bssid
parameter_list|,
specifier|const
name|u8
modifier|*
name|pmkid
parameter_list|)
block|{
name|struct
name|i802_bss
modifier|*
name|bss
init|=
name|priv
decl_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"nl80211: Delete PMKID for "
name|MACSTR
argument_list|,
name|MAC2STR
argument_list|(
name|bssid
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|nl80211_pmkid
argument_list|(
name|bss
argument_list|,
name|NL80211_CMD_DEL_PMKSA
argument_list|,
name|bssid
argument_list|,
name|pmkid
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|nl80211_flush_pmkid
parameter_list|(
name|void
modifier|*
name|priv
parameter_list|)
block|{
name|struct
name|i802_bss
modifier|*
name|bss
init|=
name|priv
decl_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"nl80211: Flush PMKIDs"
argument_list|)
expr_stmt|;
return|return
name|nl80211_pmkid
argument_list|(
name|bss
argument_list|,
name|NL80211_CMD_FLUSH_PMKSA
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|clean_survey_results
parameter_list|(
name|struct
name|survey_results
modifier|*
name|survey_results
parameter_list|)
block|{
name|struct
name|freq_survey
modifier|*
name|survey
decl_stmt|,
modifier|*
name|tmp
decl_stmt|;
if|if
condition|(
name|dl_list_empty
argument_list|(
operator|&
name|survey_results
operator|->
name|survey_list
argument_list|)
condition|)
return|return;
name|dl_list_for_each_safe
argument_list|(
argument|survey
argument_list|,
argument|tmp
argument_list|,
argument|&survey_results->survey_list
argument_list|,
argument|struct freq_survey
argument_list|,
argument|list
argument_list|)
block|{
name|dl_list_del
argument_list|(
operator|&
name|survey
operator|->
name|list
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|survey
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|add_survey
parameter_list|(
name|struct
name|nlattr
modifier|*
modifier|*
name|sinfo
parameter_list|,
name|u32
name|ifidx
parameter_list|,
name|struct
name|dl_list
modifier|*
name|survey_list
parameter_list|)
block|{
name|struct
name|freq_survey
modifier|*
name|survey
decl_stmt|;
name|survey
operator|=
name|os_zalloc
argument_list|(
sizeof|sizeof
argument_list|(
expr|struct
name|freq_survey
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|survey
condition|)
return|return;
name|survey
operator|->
name|ifidx
operator|=
name|ifidx
expr_stmt|;
name|survey
operator|->
name|freq
operator|=
name|nla_get_u32
argument_list|(
name|sinfo
index|[
name|NL80211_SURVEY_INFO_FREQUENCY
index|]
argument_list|)
expr_stmt|;
name|survey
operator|->
name|filled
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|sinfo
index|[
name|NL80211_SURVEY_INFO_NOISE
index|]
condition|)
block|{
name|survey
operator|->
name|nf
operator|=
operator|(
name|int8_t
operator|)
name|nla_get_u8
argument_list|(
name|sinfo
index|[
name|NL80211_SURVEY_INFO_NOISE
index|]
argument_list|)
expr_stmt|;
name|survey
operator|->
name|filled
operator||=
name|SURVEY_HAS_NF
expr_stmt|;
block|}
if|if
condition|(
name|sinfo
index|[
name|NL80211_SURVEY_INFO_CHANNEL_TIME
index|]
condition|)
block|{
name|survey
operator|->
name|channel_time
operator|=
name|nla_get_u64
argument_list|(
name|sinfo
index|[
name|NL80211_SURVEY_INFO_CHANNEL_TIME
index|]
argument_list|)
expr_stmt|;
name|survey
operator|->
name|filled
operator||=
name|SURVEY_HAS_CHAN_TIME
expr_stmt|;
block|}
if|if
condition|(
name|sinfo
index|[
name|NL80211_SURVEY_INFO_CHANNEL_TIME_BUSY
index|]
condition|)
block|{
name|survey
operator|->
name|channel_time_busy
operator|=
name|nla_get_u64
argument_list|(
name|sinfo
index|[
name|NL80211_SURVEY_INFO_CHANNEL_TIME_BUSY
index|]
argument_list|)
expr_stmt|;
name|survey
operator|->
name|filled
operator||=
name|SURVEY_HAS_CHAN_TIME_BUSY
expr_stmt|;
block|}
if|if
condition|(
name|sinfo
index|[
name|NL80211_SURVEY_INFO_CHANNEL_TIME_RX
index|]
condition|)
block|{
name|survey
operator|->
name|channel_time_rx
operator|=
name|nla_get_u64
argument_list|(
name|sinfo
index|[
name|NL80211_SURVEY_INFO_CHANNEL_TIME_RX
index|]
argument_list|)
expr_stmt|;
name|survey
operator|->
name|filled
operator||=
name|SURVEY_HAS_CHAN_TIME_RX
expr_stmt|;
block|}
if|if
condition|(
name|sinfo
index|[
name|NL80211_SURVEY_INFO_CHANNEL_TIME_TX
index|]
condition|)
block|{
name|survey
operator|->
name|channel_time_tx
operator|=
name|nla_get_u64
argument_list|(
name|sinfo
index|[
name|NL80211_SURVEY_INFO_CHANNEL_TIME_TX
index|]
argument_list|)
expr_stmt|;
name|survey
operator|->
name|filled
operator||=
name|SURVEY_HAS_CHAN_TIME_TX
expr_stmt|;
block|}
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"nl80211: Freq survey dump event (freq=%d MHz noise=%d channel_time=%ld busy_time=%ld tx_time=%ld rx_time=%ld filled=%04x)"
argument_list|,
name|survey
operator|->
name|freq
argument_list|,
name|survey
operator|->
name|nf
argument_list|,
operator|(
name|unsigned
name|long
name|int
operator|)
name|survey
operator|->
name|channel_time
argument_list|,
operator|(
name|unsigned
name|long
name|int
operator|)
name|survey
operator|->
name|channel_time_busy
argument_list|,
operator|(
name|unsigned
name|long
name|int
operator|)
name|survey
operator|->
name|channel_time_tx
argument_list|,
operator|(
name|unsigned
name|long
name|int
operator|)
name|survey
operator|->
name|channel_time_rx
argument_list|,
name|survey
operator|->
name|filled
argument_list|)
expr_stmt|;
name|dl_list_add_tail
argument_list|(
name|survey_list
argument_list|,
operator|&
name|survey
operator|->
name|list
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|check_survey_ok
parameter_list|(
name|struct
name|nlattr
modifier|*
modifier|*
name|sinfo
parameter_list|,
name|u32
name|surveyed_freq
parameter_list|,
name|unsigned
name|int
name|freq_filter
parameter_list|)
block|{
if|if
condition|(
operator|!
name|freq_filter
condition|)
return|return
literal|1
return|;
return|return
name|freq_filter
operator|==
name|surveyed_freq
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|survey_handler
parameter_list|(
name|struct
name|nl_msg
modifier|*
name|msg
parameter_list|,
name|void
modifier|*
name|arg
parameter_list|)
block|{
name|struct
name|nlattr
modifier|*
name|tb
index|[
name|NL80211_ATTR_MAX
operator|+
literal|1
index|]
decl_stmt|;
name|struct
name|genlmsghdr
modifier|*
name|gnlh
init|=
name|nlmsg_data
argument_list|(
name|nlmsg_hdr
argument_list|(
name|msg
argument_list|)
argument_list|)
decl_stmt|;
name|struct
name|nlattr
modifier|*
name|sinfo
index|[
name|NL80211_SURVEY_INFO_MAX
operator|+
literal|1
index|]
decl_stmt|;
name|struct
name|survey_results
modifier|*
name|survey_results
decl_stmt|;
name|u32
name|surveyed_freq
init|=
literal|0
decl_stmt|;
name|u32
name|ifidx
decl_stmt|;
specifier|static
name|struct
name|nla_policy
name|survey_policy
index|[
name|NL80211_SURVEY_INFO_MAX
operator|+
literal|1
index|]
init|=
block|{
index|[
name|NL80211_SURVEY_INFO_FREQUENCY
index|]
operator|=
block|{
operator|.
name|type
operator|=
name|NLA_U32
block|}
block|,
index|[
name|NL80211_SURVEY_INFO_NOISE
index|]
operator|=
block|{
operator|.
name|type
operator|=
name|NLA_U8
block|}
block|, 	}
decl_stmt|;
name|survey_results
operator|=
operator|(
expr|struct
name|survey_results
operator|*
operator|)
name|arg
expr_stmt|;
name|nla_parse
argument_list|(
name|tb
argument_list|,
name|NL80211_ATTR_MAX
argument_list|,
name|genlmsg_attrdata
argument_list|(
name|gnlh
argument_list|,
literal|0
argument_list|)
argument_list|,
name|genlmsg_attrlen
argument_list|(
name|gnlh
argument_list|,
literal|0
argument_list|)
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|tb
index|[
name|NL80211_ATTR_IFINDEX
index|]
condition|)
return|return
name|NL_SKIP
return|;
name|ifidx
operator|=
name|nla_get_u32
argument_list|(
name|tb
index|[
name|NL80211_ATTR_IFINDEX
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|tb
index|[
name|NL80211_ATTR_SURVEY_INFO
index|]
condition|)
return|return
name|NL_SKIP
return|;
if|if
condition|(
name|nla_parse_nested
argument_list|(
name|sinfo
argument_list|,
name|NL80211_SURVEY_INFO_MAX
argument_list|,
name|tb
index|[
name|NL80211_ATTR_SURVEY_INFO
index|]
argument_list|,
name|survey_policy
argument_list|)
condition|)
return|return
name|NL_SKIP
return|;
if|if
condition|(
operator|!
name|sinfo
index|[
name|NL80211_SURVEY_INFO_FREQUENCY
index|]
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"nl80211: Invalid survey data"
argument_list|)
expr_stmt|;
return|return
name|NL_SKIP
return|;
block|}
name|surveyed_freq
operator|=
name|nla_get_u32
argument_list|(
name|sinfo
index|[
name|NL80211_SURVEY_INFO_FREQUENCY
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|check_survey_ok
argument_list|(
name|sinfo
argument_list|,
name|surveyed_freq
argument_list|,
name|survey_results
operator|->
name|freq_filter
argument_list|)
condition|)
return|return
name|NL_SKIP
return|;
if|if
condition|(
name|survey_results
operator|->
name|freq_filter
operator|&&
name|survey_results
operator|->
name|freq_filter
operator|!=
name|surveyed_freq
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_EXCESSIVE
argument_list|,
literal|"nl80211: Ignoring survey data for freq %d MHz"
argument_list|,
name|surveyed_freq
argument_list|)
expr_stmt|;
return|return
name|NL_SKIP
return|;
block|}
name|add_survey
argument_list|(
name|sinfo
argument_list|,
name|ifidx
argument_list|,
operator|&
name|survey_results
operator|->
name|survey_list
argument_list|)
expr_stmt|;
return|return
name|NL_SKIP
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|wpa_driver_nl80211_get_survey
parameter_list|(
name|void
modifier|*
name|priv
parameter_list|,
name|unsigned
name|int
name|freq
parameter_list|)
block|{
name|struct
name|i802_bss
modifier|*
name|bss
init|=
name|priv
decl_stmt|;
name|struct
name|wpa_driver_nl80211_data
modifier|*
name|drv
init|=
name|bss
operator|->
name|drv
decl_stmt|;
name|struct
name|nl_msg
modifier|*
name|msg
decl_stmt|;
name|int
name|err
decl_stmt|;
name|union
name|wpa_event_data
name|data
decl_stmt|;
name|struct
name|survey_results
modifier|*
name|survey_results
decl_stmt|;
name|os_memset
argument_list|(
operator|&
name|data
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|data
argument_list|)
argument_list|)
expr_stmt|;
name|survey_results
operator|=
operator|&
name|data
operator|.
name|survey_results
expr_stmt|;
name|dl_list_init
argument_list|(
operator|&
name|survey_results
operator|->
name|survey_list
argument_list|)
expr_stmt|;
name|msg
operator|=
name|nl80211_drv_msg
argument_list|(
name|drv
argument_list|,
name|NLM_F_DUMP
argument_list|,
name|NL80211_CMD_GET_SURVEY
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|msg
condition|)
return|return
operator|-
name|ENOBUFS
return|;
if|if
condition|(
name|freq
condition|)
name|data
operator|.
name|survey_results
operator|.
name|freq_filter
operator|=
name|freq
expr_stmt|;
do|do
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"nl80211: Fetch survey data"
argument_list|)
expr_stmt|;
name|err
operator|=
name|send_and_recv_msgs
argument_list|(
name|drv
argument_list|,
name|msg
argument_list|,
name|survey_handler
argument_list|,
name|survey_results
argument_list|)
expr_stmt|;
block|}
do|while
condition|(
name|err
operator|>
literal|0
condition|)
do|;
if|if
condition|(
name|err
condition|)
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"nl80211: Failed to process survey data"
argument_list|)
expr_stmt|;
else|else
name|wpa_supplicant_event
argument_list|(
name|drv
operator|->
name|ctx
argument_list|,
name|EVENT_SURVEY
argument_list|,
operator|&
name|data
argument_list|)
expr_stmt|;
name|clean_survey_results
argument_list|(
name|survey_results
argument_list|)
expr_stmt|;
return|return
name|err
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|nl80211_set_rekey_info
parameter_list|(
name|void
modifier|*
name|priv
parameter_list|,
specifier|const
name|u8
modifier|*
name|kek
parameter_list|,
name|size_t
name|kek_len
parameter_list|,
specifier|const
name|u8
modifier|*
name|kck
parameter_list|,
name|size_t
name|kck_len
parameter_list|,
specifier|const
name|u8
modifier|*
name|replay_ctr
parameter_list|)
block|{
name|struct
name|i802_bss
modifier|*
name|bss
init|=
name|priv
decl_stmt|;
name|struct
name|wpa_driver_nl80211_data
modifier|*
name|drv
init|=
name|bss
operator|->
name|drv
decl_stmt|;
name|struct
name|nlattr
modifier|*
name|replay_nested
decl_stmt|;
name|struct
name|nl_msg
modifier|*
name|msg
decl_stmt|;
name|int
name|ret
decl_stmt|;
if|if
condition|(
operator|!
name|drv
operator|->
name|set_rekey_offload
condition|)
return|return;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"nl80211: Set rekey offload"
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|msg
operator|=
name|nl80211_bss_msg
argument_list|(
name|bss
argument_list|,
literal|0
argument_list|,
name|NL80211_CMD_SET_REKEY_OFFLOAD
argument_list|)
operator|)
operator|||
operator|!
operator|(
name|replay_nested
operator|=
name|nla_nest_start
argument_list|(
name|msg
argument_list|,
name|NL80211_ATTR_REKEY_DATA
argument_list|)
operator|)
operator|||
name|nla_put
argument_list|(
name|msg
argument_list|,
name|NL80211_REKEY_DATA_KEK
argument_list|,
name|kek_len
argument_list|,
name|kek
argument_list|)
operator|||
name|nla_put
argument_list|(
name|msg
argument_list|,
name|NL80211_REKEY_DATA_KCK
argument_list|,
name|kck_len
argument_list|,
name|kck
argument_list|)
operator|||
name|nla_put
argument_list|(
name|msg
argument_list|,
name|NL80211_REKEY_DATA_REPLAY_CTR
argument_list|,
name|NL80211_REPLAY_CTR_LEN
argument_list|,
name|replay_ctr
argument_list|)
condition|)
block|{
name|nl80211_nlmsg_clear
argument_list|(
name|msg
argument_list|)
expr_stmt|;
name|nlmsg_free
argument_list|(
name|msg
argument_list|)
expr_stmt|;
return|return;
block|}
name|nla_nest_end
argument_list|(
name|msg
argument_list|,
name|replay_nested
argument_list|)
expr_stmt|;
name|ret
operator|=
name|send_and_recv_msgs
argument_list|(
name|drv
argument_list|,
name|msg
argument_list|,
name|NULL
argument_list|,
operator|(
name|void
operator|*
operator|)
operator|-
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|==
operator|-
name|EOPNOTSUPP
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"nl80211: Driver does not support rekey offload"
argument_list|)
expr_stmt|;
name|drv
operator|->
name|set_rekey_offload
operator|=
literal|0
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|nl80211_send_null_frame
parameter_list|(
name|struct
name|i802_bss
modifier|*
name|bss
parameter_list|,
specifier|const
name|u8
modifier|*
name|own_addr
parameter_list|,
specifier|const
name|u8
modifier|*
name|addr
parameter_list|,
name|int
name|qos
parameter_list|)
block|{
comment|/* send data frame to poll STA and check whether 	 * this frame is ACKed */
struct|struct
block|{
name|struct
name|ieee80211_hdr
name|hdr
decl_stmt|;
name|u16
name|qos_ctl
decl_stmt|;
block|}
name|STRUCT_PACKED
name|nulldata
struct|;
name|size_t
name|size
decl_stmt|;
comment|/* Send data frame to poll STA and check whether this frame is ACKed */
name|os_memset
argument_list|(
operator|&
name|nulldata
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|nulldata
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|qos
condition|)
block|{
name|nulldata
operator|.
name|hdr
operator|.
name|frame_control
operator|=
name|IEEE80211_FC
argument_list|(
name|WLAN_FC_TYPE_DATA
argument_list|,
name|WLAN_FC_STYPE_QOS_NULL
argument_list|)
expr_stmt|;
name|size
operator|=
sizeof|sizeof
argument_list|(
name|nulldata
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|nulldata
operator|.
name|hdr
operator|.
name|frame_control
operator|=
name|IEEE80211_FC
argument_list|(
name|WLAN_FC_TYPE_DATA
argument_list|,
name|WLAN_FC_STYPE_NULLFUNC
argument_list|)
expr_stmt|;
name|size
operator|=
sizeof|sizeof
argument_list|(
expr|struct
name|ieee80211_hdr
argument_list|)
expr_stmt|;
block|}
name|nulldata
operator|.
name|hdr
operator|.
name|frame_control
operator||=
name|host_to_le16
argument_list|(
name|WLAN_FC_FROMDS
argument_list|)
expr_stmt|;
name|os_memcpy
argument_list|(
name|nulldata
operator|.
name|hdr
operator|.
name|IEEE80211_DA_FROMDS
argument_list|,
name|addr
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
name|os_memcpy
argument_list|(
name|nulldata
operator|.
name|hdr
operator|.
name|IEEE80211_BSSID_FROMDS
argument_list|,
name|own_addr
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
name|os_memcpy
argument_list|(
name|nulldata
operator|.
name|hdr
operator|.
name|IEEE80211_SA_FROMDS
argument_list|,
name|own_addr
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
if|if
condition|(
name|wpa_driver_nl80211_send_mlme
argument_list|(
name|bss
argument_list|,
operator|(
name|u8
operator|*
operator|)
operator|&
name|nulldata
argument_list|,
name|size
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
operator|<
literal|0
condition|)
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"nl80211_send_null_frame: Failed to "
literal|"send poll frame"
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|nl80211_poll_client
parameter_list|(
name|void
modifier|*
name|priv
parameter_list|,
specifier|const
name|u8
modifier|*
name|own_addr
parameter_list|,
specifier|const
name|u8
modifier|*
name|addr
parameter_list|,
name|int
name|qos
parameter_list|)
block|{
name|struct
name|i802_bss
modifier|*
name|bss
init|=
name|priv
decl_stmt|;
name|struct
name|wpa_driver_nl80211_data
modifier|*
name|drv
init|=
name|bss
operator|->
name|drv
decl_stmt|;
name|struct
name|nl_msg
modifier|*
name|msg
decl_stmt|;
name|int
name|ret
decl_stmt|;
if|if
condition|(
operator|!
name|drv
operator|->
name|poll_command_supported
condition|)
block|{
name|nl80211_send_null_frame
argument_list|(
name|bss
argument_list|,
name|own_addr
argument_list|,
name|addr
argument_list|,
name|qos
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
operator|!
operator|(
name|msg
operator|=
name|nl80211_bss_msg
argument_list|(
name|bss
argument_list|,
literal|0
argument_list|,
name|NL80211_CMD_PROBE_CLIENT
argument_list|)
operator|)
operator|||
name|nla_put
argument_list|(
name|msg
argument_list|,
name|NL80211_ATTR_MAC
argument_list|,
name|ETH_ALEN
argument_list|,
name|addr
argument_list|)
condition|)
block|{
name|nlmsg_free
argument_list|(
name|msg
argument_list|)
expr_stmt|;
return|return;
block|}
name|ret
operator|=
name|send_and_recv_msgs
argument_list|(
name|drv
argument_list|,
name|msg
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|<
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"nl80211: Client probe request for "
name|MACSTR
literal|" failed: ret=%d (%s)"
argument_list|,
name|MAC2STR
argument_list|(
name|addr
argument_list|)
argument_list|,
name|ret
argument_list|,
name|strerror
argument_list|(
operator|-
name|ret
argument_list|)
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|int
name|nl80211_set_power_save
parameter_list|(
name|struct
name|i802_bss
modifier|*
name|bss
parameter_list|,
name|int
name|enabled
parameter_list|)
block|{
name|struct
name|nl_msg
modifier|*
name|msg
decl_stmt|;
if|if
condition|(
operator|!
operator|(
name|msg
operator|=
name|nl80211_bss_msg
argument_list|(
name|bss
argument_list|,
literal|0
argument_list|,
name|NL80211_CMD_SET_POWER_SAVE
argument_list|)
operator|)
operator|||
name|nla_put_u32
argument_list|(
name|msg
argument_list|,
name|NL80211_ATTR_PS_STATE
argument_list|,
name|enabled
condition|?
name|NL80211_PS_ENABLED
else|:
name|NL80211_PS_DISABLED
argument_list|)
condition|)
block|{
name|nlmsg_free
argument_list|(
name|msg
argument_list|)
expr_stmt|;
return|return
operator|-
name|ENOBUFS
return|;
block|}
return|return
name|send_and_recv_msgs
argument_list|(
name|bss
operator|->
name|drv
argument_list|,
name|msg
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|nl80211_set_p2p_powersave
parameter_list|(
name|void
modifier|*
name|priv
parameter_list|,
name|int
name|legacy_ps
parameter_list|,
name|int
name|opp_ps
parameter_list|,
name|int
name|ctwindow
parameter_list|)
block|{
name|struct
name|i802_bss
modifier|*
name|bss
init|=
name|priv
decl_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"nl80211: set_p2p_powersave (legacy_ps=%d "
literal|"opp_ps=%d ctwindow=%d)"
argument_list|,
name|legacy_ps
argument_list|,
name|opp_ps
argument_list|,
name|ctwindow
argument_list|)
expr_stmt|;
if|if
condition|(
name|opp_ps
operator|!=
operator|-
literal|1
operator|||
name|ctwindow
operator|!=
operator|-
literal|1
condition|)
block|{
ifdef|#
directive|ifdef
name|ANDROID_P2P
name|wpa_driver_set_p2p_ps
argument_list|(
name|priv
argument_list|,
name|legacy_ps
argument_list|,
name|opp_ps
argument_list|,
name|ctwindow
argument_list|)
expr_stmt|;
else|#
directive|else
comment|/* ANDROID_P2P */
return|return
operator|-
literal|1
return|;
comment|/* Not yet supported */
endif|#
directive|endif
comment|/* ANDROID_P2P */
block|}
if|if
condition|(
name|legacy_ps
operator|==
operator|-
literal|1
condition|)
return|return
literal|0
return|;
if|if
condition|(
name|legacy_ps
operator|!=
literal|0
operator|&&
name|legacy_ps
operator|!=
literal|1
condition|)
return|return
operator|-
literal|1
return|;
comment|/* Not yet supported */
return|return
name|nl80211_set_power_save
argument_list|(
name|bss
argument_list|,
name|legacy_ps
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|nl80211_start_radar_detection
parameter_list|(
name|void
modifier|*
name|priv
parameter_list|,
name|struct
name|hostapd_freq_params
modifier|*
name|freq
parameter_list|)
block|{
name|struct
name|i802_bss
modifier|*
name|bss
init|=
name|priv
decl_stmt|;
name|struct
name|wpa_driver_nl80211_data
modifier|*
name|drv
init|=
name|bss
operator|->
name|drv
decl_stmt|;
name|struct
name|nl_msg
modifier|*
name|msg
decl_stmt|;
name|int
name|ret
decl_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"nl80211: Start radar detection (CAC) %d MHz (ht_enabled=%d, vht_enabled=%d, bandwidth=%d MHz, cf1=%d MHz, cf2=%d MHz)"
argument_list|,
name|freq
operator|->
name|freq
argument_list|,
name|freq
operator|->
name|ht_enabled
argument_list|,
name|freq
operator|->
name|vht_enabled
argument_list|,
name|freq
operator|->
name|bandwidth
argument_list|,
name|freq
operator|->
name|center_freq1
argument_list|,
name|freq
operator|->
name|center_freq2
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|drv
operator|->
name|capa
operator|.
name|flags
operator|&
name|WPA_DRIVER_FLAGS_RADAR
operator|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"nl80211: Driver does not support radar "
literal|"detection"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
if|if
condition|(
operator|!
operator|(
name|msg
operator|=
name|nl80211_drv_msg
argument_list|(
name|drv
argument_list|,
literal|0
argument_list|,
name|NL80211_CMD_RADAR_DETECT
argument_list|)
operator|)
operator|||
name|nl80211_put_freq_params
argument_list|(
name|msg
argument_list|,
name|freq
argument_list|)
operator|<
literal|0
condition|)
block|{
name|nlmsg_free
argument_list|(
name|msg
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|ret
operator|=
name|send_and_recv_msgs
argument_list|(
name|drv
argument_list|,
name|msg
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|==
literal|0
condition|)
return|return
literal|0
return|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"nl80211: Failed to start radar detection: "
literal|"%d (%s)"
argument_list|,
name|ret
argument_list|,
name|strerror
argument_list|(
operator|-
name|ret
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
end_function

begin_ifdef
ifdef|#
directive|ifdef
name|CONFIG_TDLS
end_ifdef

begin_function
specifier|static
name|int
name|nl80211_send_tdls_mgmt
parameter_list|(
name|void
modifier|*
name|priv
parameter_list|,
specifier|const
name|u8
modifier|*
name|dst
parameter_list|,
name|u8
name|action_code
parameter_list|,
name|u8
name|dialog_token
parameter_list|,
name|u16
name|status_code
parameter_list|,
name|u32
name|peer_capab
parameter_list|,
name|int
name|initiator
parameter_list|,
specifier|const
name|u8
modifier|*
name|buf
parameter_list|,
name|size_t
name|len
parameter_list|)
block|{
name|struct
name|i802_bss
modifier|*
name|bss
init|=
name|priv
decl_stmt|;
name|struct
name|wpa_driver_nl80211_data
modifier|*
name|drv
init|=
name|bss
operator|->
name|drv
decl_stmt|;
name|struct
name|nl_msg
modifier|*
name|msg
decl_stmt|;
if|if
condition|(
operator|!
operator|(
name|drv
operator|->
name|capa
operator|.
name|flags
operator|&
name|WPA_DRIVER_FLAGS_TDLS_SUPPORT
operator|)
condition|)
return|return
operator|-
name|EOPNOTSUPP
return|;
if|if
condition|(
operator|!
name|dst
condition|)
return|return
operator|-
name|EINVAL
return|;
if|if
condition|(
operator|!
operator|(
name|msg
operator|=
name|nl80211_drv_msg
argument_list|(
name|drv
argument_list|,
literal|0
argument_list|,
name|NL80211_CMD_TDLS_MGMT
argument_list|)
operator|)
operator|||
name|nla_put
argument_list|(
name|msg
argument_list|,
name|NL80211_ATTR_MAC
argument_list|,
name|ETH_ALEN
argument_list|,
name|dst
argument_list|)
operator|||
name|nla_put_u8
argument_list|(
name|msg
argument_list|,
name|NL80211_ATTR_TDLS_ACTION
argument_list|,
name|action_code
argument_list|)
operator|||
name|nla_put_u8
argument_list|(
name|msg
argument_list|,
name|NL80211_ATTR_TDLS_DIALOG_TOKEN
argument_list|,
name|dialog_token
argument_list|)
operator|||
name|nla_put_u16
argument_list|(
name|msg
argument_list|,
name|NL80211_ATTR_STATUS_CODE
argument_list|,
name|status_code
argument_list|)
condition|)
goto|goto
name|fail
goto|;
if|if
condition|(
name|peer_capab
condition|)
block|{
comment|/* 		 * The internal enum tdls_peer_capability definition is 		 * currently identical with the nl80211 enum 		 * nl80211_tdls_peer_capability, so no conversion is needed 		 * here. 		 */
if|if
condition|(
name|nla_put_u32
argument_list|(
name|msg
argument_list|,
name|NL80211_ATTR_TDLS_PEER_CAPABILITY
argument_list|,
name|peer_capab
argument_list|)
condition|)
goto|goto
name|fail
goto|;
block|}
if|if
condition|(
operator|(
name|initiator
operator|&&
name|nla_put_flag
argument_list|(
name|msg
argument_list|,
name|NL80211_ATTR_TDLS_INITIATOR
argument_list|)
operator|)
operator|||
name|nla_put
argument_list|(
name|msg
argument_list|,
name|NL80211_ATTR_IE
argument_list|,
name|len
argument_list|,
name|buf
argument_list|)
condition|)
goto|goto
name|fail
goto|;
return|return
name|send_and_recv_msgs
argument_list|(
name|drv
argument_list|,
name|msg
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
return|;
name|fail
label|:
name|nlmsg_free
argument_list|(
name|msg
argument_list|)
expr_stmt|;
return|return
operator|-
name|ENOBUFS
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|nl80211_tdls_oper
parameter_list|(
name|void
modifier|*
name|priv
parameter_list|,
name|enum
name|tdls_oper
name|oper
parameter_list|,
specifier|const
name|u8
modifier|*
name|peer
parameter_list|)
block|{
name|struct
name|i802_bss
modifier|*
name|bss
init|=
name|priv
decl_stmt|;
name|struct
name|wpa_driver_nl80211_data
modifier|*
name|drv
init|=
name|bss
operator|->
name|drv
decl_stmt|;
name|struct
name|nl_msg
modifier|*
name|msg
decl_stmt|;
name|enum
name|nl80211_tdls_operation
name|nl80211_oper
decl_stmt|;
if|if
condition|(
operator|!
operator|(
name|drv
operator|->
name|capa
operator|.
name|flags
operator|&
name|WPA_DRIVER_FLAGS_TDLS_SUPPORT
operator|)
condition|)
return|return
operator|-
name|EOPNOTSUPP
return|;
switch|switch
condition|(
name|oper
condition|)
block|{
case|case
name|TDLS_DISCOVERY_REQ
case|:
name|nl80211_oper
operator|=
name|NL80211_TDLS_DISCOVERY_REQ
expr_stmt|;
break|break;
case|case
name|TDLS_SETUP
case|:
name|nl80211_oper
operator|=
name|NL80211_TDLS_SETUP
expr_stmt|;
break|break;
case|case
name|TDLS_TEARDOWN
case|:
name|nl80211_oper
operator|=
name|NL80211_TDLS_TEARDOWN
expr_stmt|;
break|break;
case|case
name|TDLS_ENABLE_LINK
case|:
name|nl80211_oper
operator|=
name|NL80211_TDLS_ENABLE_LINK
expr_stmt|;
break|break;
case|case
name|TDLS_DISABLE_LINK
case|:
name|nl80211_oper
operator|=
name|NL80211_TDLS_DISABLE_LINK
expr_stmt|;
break|break;
case|case
name|TDLS_ENABLE
case|:
return|return
literal|0
return|;
case|case
name|TDLS_DISABLE
case|:
return|return
literal|0
return|;
default|default:
return|return
operator|-
name|EINVAL
return|;
block|}
if|if
condition|(
operator|!
operator|(
name|msg
operator|=
name|nl80211_drv_msg
argument_list|(
name|drv
argument_list|,
literal|0
argument_list|,
name|NL80211_CMD_TDLS_OPER
argument_list|)
operator|)
operator|||
name|nla_put_u8
argument_list|(
name|msg
argument_list|,
name|NL80211_ATTR_TDLS_OPERATION
argument_list|,
name|nl80211_oper
argument_list|)
operator|||
name|nla_put
argument_list|(
name|msg
argument_list|,
name|NL80211_ATTR_MAC
argument_list|,
name|ETH_ALEN
argument_list|,
name|peer
argument_list|)
condition|)
block|{
name|nlmsg_free
argument_list|(
name|msg
argument_list|)
expr_stmt|;
return|return
operator|-
name|ENOBUFS
return|;
block|}
return|return
name|send_and_recv_msgs
argument_list|(
name|drv
argument_list|,
name|msg
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|nl80211_tdls_enable_channel_switch
parameter_list|(
name|void
modifier|*
name|priv
parameter_list|,
specifier|const
name|u8
modifier|*
name|addr
parameter_list|,
name|u8
name|oper_class
parameter_list|,
specifier|const
name|struct
name|hostapd_freq_params
modifier|*
name|params
parameter_list|)
block|{
name|struct
name|i802_bss
modifier|*
name|bss
init|=
name|priv
decl_stmt|;
name|struct
name|wpa_driver_nl80211_data
modifier|*
name|drv
init|=
name|bss
operator|->
name|drv
decl_stmt|;
name|struct
name|nl_msg
modifier|*
name|msg
decl_stmt|;
name|int
name|ret
init|=
operator|-
name|ENOBUFS
decl_stmt|;
if|if
condition|(
operator|!
operator|(
name|drv
operator|->
name|capa
operator|.
name|flags
operator|&
name|WPA_DRIVER_FLAGS_TDLS_SUPPORT
operator|)
operator|||
operator|!
operator|(
name|drv
operator|->
name|capa
operator|.
name|flags
operator|&
name|WPA_DRIVER_FLAGS_TDLS_CHANNEL_SWITCH
operator|)
condition|)
return|return
operator|-
name|EOPNOTSUPP
return|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"nl80211: Enable TDLS channel switch "
name|MACSTR
literal|" oper_class=%u freq=%u"
argument_list|,
name|MAC2STR
argument_list|(
name|addr
argument_list|)
argument_list|,
name|oper_class
argument_list|,
name|params
operator|->
name|freq
argument_list|)
expr_stmt|;
name|msg
operator|=
name|nl80211_cmd_msg
argument_list|(
name|bss
argument_list|,
literal|0
argument_list|,
name|NL80211_CMD_TDLS_CHANNEL_SWITCH
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|msg
operator|||
name|nla_put
argument_list|(
name|msg
argument_list|,
name|NL80211_ATTR_MAC
argument_list|,
name|ETH_ALEN
argument_list|,
name|addr
argument_list|)
operator|||
name|nla_put_u8
argument_list|(
name|msg
argument_list|,
name|NL80211_ATTR_OPER_CLASS
argument_list|,
name|oper_class
argument_list|)
operator|||
operator|(
name|ret
operator|=
name|nl80211_put_freq_params
argument_list|(
name|msg
argument_list|,
name|params
argument_list|)
operator|)
condition|)
block|{
name|nlmsg_free
argument_list|(
name|msg
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"nl80211: Could not build TDLS chan switch"
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
return|return
name|send_and_recv_msgs
argument_list|(
name|drv
argument_list|,
name|msg
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|nl80211_tdls_disable_channel_switch
parameter_list|(
name|void
modifier|*
name|priv
parameter_list|,
specifier|const
name|u8
modifier|*
name|addr
parameter_list|)
block|{
name|struct
name|i802_bss
modifier|*
name|bss
init|=
name|priv
decl_stmt|;
name|struct
name|wpa_driver_nl80211_data
modifier|*
name|drv
init|=
name|bss
operator|->
name|drv
decl_stmt|;
name|struct
name|nl_msg
modifier|*
name|msg
decl_stmt|;
if|if
condition|(
operator|!
operator|(
name|drv
operator|->
name|capa
operator|.
name|flags
operator|&
name|WPA_DRIVER_FLAGS_TDLS_SUPPORT
operator|)
operator|||
operator|!
operator|(
name|drv
operator|->
name|capa
operator|.
name|flags
operator|&
name|WPA_DRIVER_FLAGS_TDLS_CHANNEL_SWITCH
operator|)
condition|)
return|return
operator|-
name|EOPNOTSUPP
return|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"nl80211: Disable TDLS channel switch "
name|MACSTR
argument_list|,
name|MAC2STR
argument_list|(
name|addr
argument_list|)
argument_list|)
expr_stmt|;
name|msg
operator|=
name|nl80211_cmd_msg
argument_list|(
name|bss
argument_list|,
literal|0
argument_list|,
name|NL80211_CMD_TDLS_CANCEL_CHANNEL_SWITCH
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|msg
operator|||
name|nla_put
argument_list|(
name|msg
argument_list|,
name|NL80211_ATTR_MAC
argument_list|,
name|ETH_ALEN
argument_list|,
name|addr
argument_list|)
condition|)
block|{
name|nlmsg_free
argument_list|(
name|msg
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"nl80211: Could not build TDLS cancel chan switch"
argument_list|)
expr_stmt|;
return|return
operator|-
name|ENOBUFS
return|;
block|}
return|return
name|send_and_recv_msgs
argument_list|(
name|drv
argument_list|,
name|msg
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
return|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* CONFIG TDLS */
end_comment

begin_function
specifier|static
name|int
name|driver_nl80211_set_key
parameter_list|(
specifier|const
name|char
modifier|*
name|ifname
parameter_list|,
name|void
modifier|*
name|priv
parameter_list|,
name|enum
name|wpa_alg
name|alg
parameter_list|,
specifier|const
name|u8
modifier|*
name|addr
parameter_list|,
name|int
name|key_idx
parameter_list|,
name|int
name|set_tx
parameter_list|,
specifier|const
name|u8
modifier|*
name|seq
parameter_list|,
name|size_t
name|seq_len
parameter_list|,
specifier|const
name|u8
modifier|*
name|key
parameter_list|,
name|size_t
name|key_len
parameter_list|)
block|{
name|struct
name|i802_bss
modifier|*
name|bss
init|=
name|priv
decl_stmt|;
return|return
name|wpa_driver_nl80211_set_key
argument_list|(
name|ifname
argument_list|,
name|bss
argument_list|,
name|alg
argument_list|,
name|addr
argument_list|,
name|key_idx
argument_list|,
name|set_tx
argument_list|,
name|seq
argument_list|,
name|seq_len
argument_list|,
name|key
argument_list|,
name|key_len
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|driver_nl80211_scan2
parameter_list|(
name|void
modifier|*
name|priv
parameter_list|,
name|struct
name|wpa_driver_scan_params
modifier|*
name|params
parameter_list|)
block|{
name|struct
name|i802_bss
modifier|*
name|bss
init|=
name|priv
decl_stmt|;
return|return
name|wpa_driver_nl80211_scan
argument_list|(
name|bss
argument_list|,
name|params
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|driver_nl80211_deauthenticate
parameter_list|(
name|void
modifier|*
name|priv
parameter_list|,
specifier|const
name|u8
modifier|*
name|addr
parameter_list|,
name|int
name|reason_code
parameter_list|)
block|{
name|struct
name|i802_bss
modifier|*
name|bss
init|=
name|priv
decl_stmt|;
return|return
name|wpa_driver_nl80211_deauthenticate
argument_list|(
name|bss
argument_list|,
name|addr
argument_list|,
name|reason_code
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|driver_nl80211_authenticate
parameter_list|(
name|void
modifier|*
name|priv
parameter_list|,
name|struct
name|wpa_driver_auth_params
modifier|*
name|params
parameter_list|)
block|{
name|struct
name|i802_bss
modifier|*
name|bss
init|=
name|priv
decl_stmt|;
return|return
name|wpa_driver_nl80211_authenticate
argument_list|(
name|bss
argument_list|,
name|params
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|driver_nl80211_deinit
parameter_list|(
name|void
modifier|*
name|priv
parameter_list|)
block|{
name|struct
name|i802_bss
modifier|*
name|bss
init|=
name|priv
decl_stmt|;
name|wpa_driver_nl80211_deinit
argument_list|(
name|bss
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|driver_nl80211_if_remove
parameter_list|(
name|void
modifier|*
name|priv
parameter_list|,
name|enum
name|wpa_driver_if_type
name|type
parameter_list|,
specifier|const
name|char
modifier|*
name|ifname
parameter_list|)
block|{
name|struct
name|i802_bss
modifier|*
name|bss
init|=
name|priv
decl_stmt|;
return|return
name|wpa_driver_nl80211_if_remove
argument_list|(
name|bss
argument_list|,
name|type
argument_list|,
name|ifname
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|driver_nl80211_send_mlme
parameter_list|(
name|void
modifier|*
name|priv
parameter_list|,
specifier|const
name|u8
modifier|*
name|data
parameter_list|,
name|size_t
name|data_len
parameter_list|,
name|int
name|noack
parameter_list|)
block|{
name|struct
name|i802_bss
modifier|*
name|bss
init|=
name|priv
decl_stmt|;
return|return
name|wpa_driver_nl80211_send_mlme
argument_list|(
name|bss
argument_list|,
name|data
argument_list|,
name|data_len
argument_list|,
name|noack
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|driver_nl80211_sta_remove
parameter_list|(
name|void
modifier|*
name|priv
parameter_list|,
specifier|const
name|u8
modifier|*
name|addr
parameter_list|)
block|{
name|struct
name|i802_bss
modifier|*
name|bss
init|=
name|priv
decl_stmt|;
return|return
name|wpa_driver_nl80211_sta_remove
argument_list|(
name|bss
argument_list|,
name|addr
argument_list|,
operator|-
literal|1
argument_list|,
literal|0
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|driver_nl80211_set_sta_vlan
parameter_list|(
name|void
modifier|*
name|priv
parameter_list|,
specifier|const
name|u8
modifier|*
name|addr
parameter_list|,
specifier|const
name|char
modifier|*
name|ifname
parameter_list|,
name|int
name|vlan_id
parameter_list|)
block|{
name|struct
name|i802_bss
modifier|*
name|bss
init|=
name|priv
decl_stmt|;
return|return
name|i802_set_sta_vlan
argument_list|(
name|bss
argument_list|,
name|addr
argument_list|,
name|ifname
argument_list|,
name|vlan_id
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|driver_nl80211_read_sta_data
parameter_list|(
name|void
modifier|*
name|priv
parameter_list|,
name|struct
name|hostap_sta_driver_data
modifier|*
name|data
parameter_list|,
specifier|const
name|u8
modifier|*
name|addr
parameter_list|)
block|{
name|struct
name|i802_bss
modifier|*
name|bss
init|=
name|priv
decl_stmt|;
return|return
name|i802_read_sta_data
argument_list|(
name|bss
argument_list|,
name|data
argument_list|,
name|addr
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|driver_nl80211_send_action
parameter_list|(
name|void
modifier|*
name|priv
parameter_list|,
name|unsigned
name|int
name|freq
parameter_list|,
name|unsigned
name|int
name|wait_time
parameter_list|,
specifier|const
name|u8
modifier|*
name|dst
parameter_list|,
specifier|const
name|u8
modifier|*
name|src
parameter_list|,
specifier|const
name|u8
modifier|*
name|bssid
parameter_list|,
specifier|const
name|u8
modifier|*
name|data
parameter_list|,
name|size_t
name|data_len
parameter_list|,
name|int
name|no_cck
parameter_list|)
block|{
name|struct
name|i802_bss
modifier|*
name|bss
init|=
name|priv
decl_stmt|;
return|return
name|wpa_driver_nl80211_send_action
argument_list|(
name|bss
argument_list|,
name|freq
argument_list|,
name|wait_time
argument_list|,
name|dst
argument_list|,
name|src
argument_list|,
name|bssid
argument_list|,
name|data
argument_list|,
name|data_len
argument_list|,
name|no_cck
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|driver_nl80211_probe_req_report
parameter_list|(
name|void
modifier|*
name|priv
parameter_list|,
name|int
name|report
parameter_list|)
block|{
name|struct
name|i802_bss
modifier|*
name|bss
init|=
name|priv
decl_stmt|;
return|return
name|wpa_driver_nl80211_probe_req_report
argument_list|(
name|bss
argument_list|,
name|report
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|wpa_driver_nl80211_update_ft_ies
parameter_list|(
name|void
modifier|*
name|priv
parameter_list|,
specifier|const
name|u8
modifier|*
name|md
parameter_list|,
specifier|const
name|u8
modifier|*
name|ies
parameter_list|,
name|size_t
name|ies_len
parameter_list|)
block|{
name|int
name|ret
decl_stmt|;
name|struct
name|nl_msg
modifier|*
name|msg
decl_stmt|;
name|struct
name|i802_bss
modifier|*
name|bss
init|=
name|priv
decl_stmt|;
name|struct
name|wpa_driver_nl80211_data
modifier|*
name|drv
init|=
name|bss
operator|->
name|drv
decl_stmt|;
name|u16
name|mdid
init|=
name|WPA_GET_LE16
argument_list|(
name|md
argument_list|)
decl_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"nl80211: Updating FT IEs"
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|msg
operator|=
name|nl80211_drv_msg
argument_list|(
name|drv
argument_list|,
literal|0
argument_list|,
name|NL80211_CMD_UPDATE_FT_IES
argument_list|)
operator|)
operator|||
name|nla_put
argument_list|(
name|msg
argument_list|,
name|NL80211_ATTR_IE
argument_list|,
name|ies_len
argument_list|,
name|ies
argument_list|)
operator|||
name|nla_put_u16
argument_list|(
name|msg
argument_list|,
name|NL80211_ATTR_MDID
argument_list|,
name|mdid
argument_list|)
condition|)
block|{
name|nlmsg_free
argument_list|(
name|msg
argument_list|)
expr_stmt|;
return|return
operator|-
name|ENOBUFS
return|;
block|}
name|ret
operator|=
name|send_and_recv_msgs
argument_list|(
name|drv
argument_list|,
name|msg
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"nl80211: update_ft_ies failed "
literal|"err=%d (%s)"
argument_list|,
name|ret
argument_list|,
name|strerror
argument_list|(
operator|-
name|ret
argument_list|)
argument_list|)
expr_stmt|;
block|}
return|return
name|ret
return|;
block|}
end_function

begin_function
specifier|const
name|u8
modifier|*
name|wpa_driver_nl80211_get_macaddr
parameter_list|(
name|void
modifier|*
name|priv
parameter_list|)
block|{
name|struct
name|i802_bss
modifier|*
name|bss
init|=
name|priv
decl_stmt|;
name|struct
name|wpa_driver_nl80211_data
modifier|*
name|drv
init|=
name|bss
operator|->
name|drv
decl_stmt|;
if|if
condition|(
name|drv
operator|->
name|nlmode
operator|!=
name|NL80211_IFTYPE_P2P_DEVICE
condition|)
return|return
name|NULL
return|;
return|return
name|bss
operator|->
name|addr
return|;
block|}
end_function

begin_function
specifier|static
specifier|const
name|char
modifier|*
name|scan_state_str
parameter_list|(
name|enum
name|scan_states
name|scan_state
parameter_list|)
block|{
switch|switch
condition|(
name|scan_state
condition|)
block|{
case|case
name|NO_SCAN
case|:
return|return
literal|"NO_SCAN"
return|;
case|case
name|SCAN_REQUESTED
case|:
return|return
literal|"SCAN_REQUESTED"
return|;
case|case
name|SCAN_STARTED
case|:
return|return
literal|"SCAN_STARTED"
return|;
case|case
name|SCAN_COMPLETED
case|:
return|return
literal|"SCAN_COMPLETED"
return|;
case|case
name|SCAN_ABORTED
case|:
return|return
literal|"SCAN_ABORTED"
return|;
case|case
name|SCHED_SCAN_STARTED
case|:
return|return
literal|"SCHED_SCAN_STARTED"
return|;
case|case
name|SCHED_SCAN_STOPPED
case|:
return|return
literal|"SCHED_SCAN_STOPPED"
return|;
case|case
name|SCHED_SCAN_RESULTS
case|:
return|return
literal|"SCHED_SCAN_RESULTS"
return|;
block|}
return|return
literal|"??"
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|wpa_driver_nl80211_status
parameter_list|(
name|void
modifier|*
name|priv
parameter_list|,
name|char
modifier|*
name|buf
parameter_list|,
name|size_t
name|buflen
parameter_list|)
block|{
name|struct
name|i802_bss
modifier|*
name|bss
init|=
name|priv
decl_stmt|;
name|struct
name|wpa_driver_nl80211_data
modifier|*
name|drv
init|=
name|bss
operator|->
name|drv
decl_stmt|;
name|int
name|res
decl_stmt|;
name|char
modifier|*
name|pos
decl_stmt|,
modifier|*
name|end
decl_stmt|;
name|pos
operator|=
name|buf
expr_stmt|;
name|end
operator|=
name|buf
operator|+
name|buflen
expr_stmt|;
name|res
operator|=
name|os_snprintf
argument_list|(
name|pos
argument_list|,
name|end
operator|-
name|pos
argument_list|,
literal|"ifindex=%d\n"
literal|"ifname=%s\n"
literal|"brname=%s\n"
literal|"addr="
name|MACSTR
literal|"\n"
literal|"freq=%d\n"
literal|"%s%s%s%s%s"
argument_list|,
name|bss
operator|->
name|ifindex
argument_list|,
name|bss
operator|->
name|ifname
argument_list|,
name|bss
operator|->
name|brname
argument_list|,
name|MAC2STR
argument_list|(
name|bss
operator|->
name|addr
argument_list|)
argument_list|,
name|bss
operator|->
name|freq
argument_list|,
name|bss
operator|->
name|beacon_set
condition|?
literal|"beacon_set=1\n"
else|:
literal|""
argument_list|,
name|bss
operator|->
name|added_if_into_bridge
condition|?
literal|"added_if_into_bridge=1\n"
else|:
literal|""
argument_list|,
name|bss
operator|->
name|added_bridge
condition|?
literal|"added_bridge=1\n"
else|:
literal|""
argument_list|,
name|bss
operator|->
name|in_deinit
condition|?
literal|"in_deinit=1\n"
else|:
literal|""
argument_list|,
name|bss
operator|->
name|if_dynamic
condition|?
literal|"if_dynamic=1\n"
else|:
literal|""
argument_list|)
expr_stmt|;
if|if
condition|(
name|os_snprintf_error
argument_list|(
name|end
operator|-
name|pos
argument_list|,
name|res
argument_list|)
condition|)
return|return
name|pos
operator|-
name|buf
return|;
name|pos
operator|+=
name|res
expr_stmt|;
if|if
condition|(
name|bss
operator|->
name|wdev_id_set
condition|)
block|{
name|res
operator|=
name|os_snprintf
argument_list|(
name|pos
argument_list|,
name|end
operator|-
name|pos
argument_list|,
literal|"wdev_id=%llu\n"
argument_list|,
operator|(
name|unsigned
name|long
name|long
operator|)
name|bss
operator|->
name|wdev_id
argument_list|)
expr_stmt|;
if|if
condition|(
name|os_snprintf_error
argument_list|(
name|end
operator|-
name|pos
argument_list|,
name|res
argument_list|)
condition|)
return|return
name|pos
operator|-
name|buf
return|;
name|pos
operator|+=
name|res
expr_stmt|;
block|}
name|res
operator|=
name|os_snprintf
argument_list|(
name|pos
argument_list|,
name|end
operator|-
name|pos
argument_list|,
literal|"phyname=%s\n"
literal|"perm_addr="
name|MACSTR
literal|"\n"
literal|"drv_ifindex=%d\n"
literal|"operstate=%d\n"
literal|"scan_state=%s\n"
literal|"auth_bssid="
name|MACSTR
literal|"\n"
literal|"auth_attempt_bssid="
name|MACSTR
literal|"\n"
literal|"bssid="
name|MACSTR
literal|"\n"
literal|"prev_bssid="
name|MACSTR
literal|"\n"
literal|"associated=%d\n"
literal|"assoc_freq=%u\n"
literal|"monitor_sock=%d\n"
literal|"monitor_ifidx=%d\n"
literal|"monitor_refcount=%d\n"
literal|"last_mgmt_freq=%u\n"
literal|"eapol_tx_sock=%d\n"
literal|"%s%s%s%s%s%s%s%s%s%s%s%s%s"
argument_list|,
name|drv
operator|->
name|phyname
argument_list|,
name|MAC2STR
argument_list|(
name|drv
operator|->
name|perm_addr
argument_list|)
argument_list|,
name|drv
operator|->
name|ifindex
argument_list|,
name|drv
operator|->
name|operstate
argument_list|,
name|scan_state_str
argument_list|(
name|drv
operator|->
name|scan_state
argument_list|)
argument_list|,
name|MAC2STR
argument_list|(
name|drv
operator|->
name|auth_bssid
argument_list|)
argument_list|,
name|MAC2STR
argument_list|(
name|drv
operator|->
name|auth_attempt_bssid
argument_list|)
argument_list|,
name|MAC2STR
argument_list|(
name|drv
operator|->
name|bssid
argument_list|)
argument_list|,
name|MAC2STR
argument_list|(
name|drv
operator|->
name|prev_bssid
argument_list|)
argument_list|,
name|drv
operator|->
name|associated
argument_list|,
name|drv
operator|->
name|assoc_freq
argument_list|,
name|drv
operator|->
name|monitor_sock
argument_list|,
name|drv
operator|->
name|monitor_ifidx
argument_list|,
name|drv
operator|->
name|monitor_refcount
argument_list|,
name|drv
operator|->
name|last_mgmt_freq
argument_list|,
name|drv
operator|->
name|eapol_tx_sock
argument_list|,
name|drv
operator|->
name|ignore_if_down_event
condition|?
literal|"ignore_if_down_event=1\n"
else|:
literal|""
argument_list|,
name|drv
operator|->
name|scan_complete_events
condition|?
literal|"scan_complete_events=1\n"
else|:
literal|""
argument_list|,
name|drv
operator|->
name|disabled_11b_rates
condition|?
literal|"disabled_11b_rates=1\n"
else|:
literal|""
argument_list|,
name|drv
operator|->
name|pending_remain_on_chan
condition|?
literal|"pending_remain_on_chan=1\n"
else|:
literal|""
argument_list|,
name|drv
operator|->
name|in_interface_list
condition|?
literal|"in_interface_list=1\n"
else|:
literal|""
argument_list|,
name|drv
operator|->
name|device_ap_sme
condition|?
literal|"device_ap_sme=1\n"
else|:
literal|""
argument_list|,
name|drv
operator|->
name|poll_command_supported
condition|?
literal|"poll_command_supported=1\n"
else|:
literal|""
argument_list|,
name|drv
operator|->
name|data_tx_status
condition|?
literal|"data_tx_status=1\n"
else|:
literal|""
argument_list|,
name|drv
operator|->
name|scan_for_auth
condition|?
literal|"scan_for_auth=1\n"
else|:
literal|""
argument_list|,
name|drv
operator|->
name|retry_auth
condition|?
literal|"retry_auth=1\n"
else|:
literal|""
argument_list|,
name|drv
operator|->
name|use_monitor
condition|?
literal|"use_monitor=1\n"
else|:
literal|""
argument_list|,
name|drv
operator|->
name|ignore_next_local_disconnect
condition|?
literal|"ignore_next_local_disconnect=1\n"
else|:
literal|""
argument_list|,
name|drv
operator|->
name|ignore_next_local_deauth
condition|?
literal|"ignore_next_local_deauth=1\n"
else|:
literal|""
argument_list|)
expr_stmt|;
if|if
condition|(
name|os_snprintf_error
argument_list|(
name|end
operator|-
name|pos
argument_list|,
name|res
argument_list|)
condition|)
return|return
name|pos
operator|-
name|buf
return|;
name|pos
operator|+=
name|res
expr_stmt|;
if|if
condition|(
name|drv
operator|->
name|has_capability
condition|)
block|{
name|res
operator|=
name|os_snprintf
argument_list|(
name|pos
argument_list|,
name|end
operator|-
name|pos
argument_list|,
literal|"capa.key_mgmt=0x%x\n"
literal|"capa.enc=0x%x\n"
literal|"capa.auth=0x%x\n"
literal|"capa.flags=0x%llx\n"
literal|"capa.rrm_flags=0x%x\n"
literal|"capa.max_scan_ssids=%d\n"
literal|"capa.max_sched_scan_ssids=%d\n"
literal|"capa.sched_scan_supported=%d\n"
literal|"capa.max_match_sets=%d\n"
literal|"capa.max_remain_on_chan=%u\n"
literal|"capa.max_stations=%u\n"
literal|"capa.probe_resp_offloads=0x%x\n"
literal|"capa.max_acl_mac_addrs=%u\n"
literal|"capa.num_multichan_concurrent=%u\n"
literal|"capa.mac_addr_rand_sched_scan_supported=%d\n"
literal|"capa.mac_addr_rand_scan_supported=%d\n"
argument_list|,
name|drv
operator|->
name|capa
operator|.
name|key_mgmt
argument_list|,
name|drv
operator|->
name|capa
operator|.
name|enc
argument_list|,
name|drv
operator|->
name|capa
operator|.
name|auth
argument_list|,
operator|(
name|unsigned
name|long
name|long
operator|)
name|drv
operator|->
name|capa
operator|.
name|flags
argument_list|,
name|drv
operator|->
name|capa
operator|.
name|rrm_flags
argument_list|,
name|drv
operator|->
name|capa
operator|.
name|max_scan_ssids
argument_list|,
name|drv
operator|->
name|capa
operator|.
name|max_sched_scan_ssids
argument_list|,
name|drv
operator|->
name|capa
operator|.
name|sched_scan_supported
argument_list|,
name|drv
operator|->
name|capa
operator|.
name|max_match_sets
argument_list|,
name|drv
operator|->
name|capa
operator|.
name|max_remain_on_chan
argument_list|,
name|drv
operator|->
name|capa
operator|.
name|max_stations
argument_list|,
name|drv
operator|->
name|capa
operator|.
name|probe_resp_offloads
argument_list|,
name|drv
operator|->
name|capa
operator|.
name|max_acl_mac_addrs
argument_list|,
name|drv
operator|->
name|capa
operator|.
name|num_multichan_concurrent
argument_list|,
name|drv
operator|->
name|capa
operator|.
name|mac_addr_rand_sched_scan_supported
argument_list|,
name|drv
operator|->
name|capa
operator|.
name|mac_addr_rand_scan_supported
argument_list|)
expr_stmt|;
if|if
condition|(
name|os_snprintf_error
argument_list|(
name|end
operator|-
name|pos
argument_list|,
name|res
argument_list|)
condition|)
return|return
name|pos
operator|-
name|buf
return|;
name|pos
operator|+=
name|res
expr_stmt|;
block|}
return|return
name|pos
operator|-
name|buf
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|set_beacon_data
parameter_list|(
name|struct
name|nl_msg
modifier|*
name|msg
parameter_list|,
name|struct
name|beacon_data
modifier|*
name|settings
parameter_list|)
block|{
if|if
condition|(
operator|(
name|settings
operator|->
name|head
operator|&&
name|nla_put
argument_list|(
name|msg
argument_list|,
name|NL80211_ATTR_BEACON_HEAD
argument_list|,
name|settings
operator|->
name|head_len
argument_list|,
name|settings
operator|->
name|head
argument_list|)
operator|)
operator|||
operator|(
name|settings
operator|->
name|tail
operator|&&
name|nla_put
argument_list|(
name|msg
argument_list|,
name|NL80211_ATTR_BEACON_TAIL
argument_list|,
name|settings
operator|->
name|tail_len
argument_list|,
name|settings
operator|->
name|tail
argument_list|)
operator|)
operator|||
operator|(
name|settings
operator|->
name|beacon_ies
operator|&&
name|nla_put
argument_list|(
name|msg
argument_list|,
name|NL80211_ATTR_IE
argument_list|,
name|settings
operator|->
name|beacon_ies_len
argument_list|,
name|settings
operator|->
name|beacon_ies
argument_list|)
operator|)
operator|||
operator|(
name|settings
operator|->
name|proberesp_ies
operator|&&
name|nla_put
argument_list|(
name|msg
argument_list|,
name|NL80211_ATTR_IE_PROBE_RESP
argument_list|,
name|settings
operator|->
name|proberesp_ies_len
argument_list|,
name|settings
operator|->
name|proberesp_ies
argument_list|)
operator|)
operator|||
operator|(
name|settings
operator|->
name|assocresp_ies
operator|&&
name|nla_put
argument_list|(
name|msg
argument_list|,
name|NL80211_ATTR_IE_ASSOC_RESP
argument_list|,
name|settings
operator|->
name|assocresp_ies_len
argument_list|,
name|settings
operator|->
name|assocresp_ies
argument_list|)
operator|)
operator|||
operator|(
name|settings
operator|->
name|probe_resp
operator|&&
name|nla_put
argument_list|(
name|msg
argument_list|,
name|NL80211_ATTR_PROBE_RESP
argument_list|,
name|settings
operator|->
name|probe_resp_len
argument_list|,
name|settings
operator|->
name|probe_resp
argument_list|)
operator|)
condition|)
return|return
operator|-
name|ENOBUFS
return|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|nl80211_switch_channel
parameter_list|(
name|void
modifier|*
name|priv
parameter_list|,
name|struct
name|csa_settings
modifier|*
name|settings
parameter_list|)
block|{
name|struct
name|nl_msg
modifier|*
name|msg
decl_stmt|;
name|struct
name|i802_bss
modifier|*
name|bss
init|=
name|priv
decl_stmt|;
name|struct
name|wpa_driver_nl80211_data
modifier|*
name|drv
init|=
name|bss
operator|->
name|drv
decl_stmt|;
name|struct
name|nlattr
modifier|*
name|beacon_csa
decl_stmt|;
name|int
name|ret
init|=
operator|-
name|ENOBUFS
decl_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"nl80211: Channel switch request (cs_count=%u block_tx=%u freq=%d width=%d cf1=%d cf2=%d)"
argument_list|,
name|settings
operator|->
name|cs_count
argument_list|,
name|settings
operator|->
name|block_tx
argument_list|,
name|settings
operator|->
name|freq_params
operator|.
name|freq
argument_list|,
name|settings
operator|->
name|freq_params
operator|.
name|bandwidth
argument_list|,
name|settings
operator|->
name|freq_params
operator|.
name|center_freq1
argument_list|,
name|settings
operator|->
name|freq_params
operator|.
name|center_freq2
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|drv
operator|->
name|capa
operator|.
name|flags
operator|&
name|WPA_DRIVER_FLAGS_AP_CSA
operator|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"nl80211: Driver does not support channel switch command"
argument_list|)
expr_stmt|;
return|return
operator|-
name|EOPNOTSUPP
return|;
block|}
if|if
condition|(
operator|(
name|drv
operator|->
name|nlmode
operator|!=
name|NL80211_IFTYPE_AP
operator|)
operator|&&
operator|(
name|drv
operator|->
name|nlmode
operator|!=
name|NL80211_IFTYPE_P2P_GO
operator|)
condition|)
return|return
operator|-
name|EOPNOTSUPP
return|;
comment|/* check settings validity */
if|if
condition|(
operator|!
name|settings
operator|->
name|beacon_csa
operator|.
name|tail
operator|||
operator|(
operator|(
name|settings
operator|->
name|beacon_csa
operator|.
name|tail_len
operator|<=
name|settings
operator|->
name|counter_offset_beacon
operator|)
operator|||
operator|(
name|settings
operator|->
name|beacon_csa
operator|.
name|tail
index|[
name|settings
operator|->
name|counter_offset_beacon
index|]
operator|!=
name|settings
operator|->
name|cs_count
operator|)
operator|)
condition|)
return|return
operator|-
name|EINVAL
return|;
if|if
condition|(
name|settings
operator|->
name|beacon_csa
operator|.
name|probe_resp
operator|&&
operator|(
operator|(
name|settings
operator|->
name|beacon_csa
operator|.
name|probe_resp_len
operator|<=
name|settings
operator|->
name|counter_offset_presp
operator|)
operator|||
operator|(
name|settings
operator|->
name|beacon_csa
operator|.
name|probe_resp
index|[
name|settings
operator|->
name|counter_offset_presp
index|]
operator|!=
name|settings
operator|->
name|cs_count
operator|)
operator|)
condition|)
return|return
operator|-
name|EINVAL
return|;
if|if
condition|(
operator|!
operator|(
name|msg
operator|=
name|nl80211_bss_msg
argument_list|(
name|bss
argument_list|,
literal|0
argument_list|,
name|NL80211_CMD_CHANNEL_SWITCH
argument_list|)
operator|)
operator|||
name|nla_put_u32
argument_list|(
name|msg
argument_list|,
name|NL80211_ATTR_CH_SWITCH_COUNT
argument_list|,
name|settings
operator|->
name|cs_count
argument_list|)
operator|||
operator|(
name|ret
operator|=
name|nl80211_put_freq_params
argument_list|(
name|msg
argument_list|,
operator|&
name|settings
operator|->
name|freq_params
argument_list|)
operator|)
operator|||
operator|(
name|settings
operator|->
name|block_tx
operator|&&
name|nla_put_flag
argument_list|(
name|msg
argument_list|,
name|NL80211_ATTR_CH_SWITCH_BLOCK_TX
argument_list|)
operator|)
condition|)
goto|goto
name|error
goto|;
comment|/* beacon_after params */
name|ret
operator|=
name|set_beacon_data
argument_list|(
name|msg
argument_list|,
operator|&
name|settings
operator|->
name|beacon_after
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
goto|goto
name|error
goto|;
comment|/* beacon_csa params */
name|beacon_csa
operator|=
name|nla_nest_start
argument_list|(
name|msg
argument_list|,
name|NL80211_ATTR_CSA_IES
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|beacon_csa
condition|)
goto|goto
name|fail
goto|;
name|ret
operator|=
name|set_beacon_data
argument_list|(
name|msg
argument_list|,
operator|&
name|settings
operator|->
name|beacon_csa
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
goto|goto
name|error
goto|;
if|if
condition|(
name|nla_put_u16
argument_list|(
name|msg
argument_list|,
name|NL80211_ATTR_CSA_C_OFF_BEACON
argument_list|,
name|settings
operator|->
name|counter_offset_beacon
argument_list|)
operator|||
operator|(
name|settings
operator|->
name|beacon_csa
operator|.
name|probe_resp
operator|&&
name|nla_put_u16
argument_list|(
name|msg
argument_list|,
name|NL80211_ATTR_CSA_C_OFF_PRESP
argument_list|,
name|settings
operator|->
name|counter_offset_presp
argument_list|)
operator|)
condition|)
goto|goto
name|fail
goto|;
name|nla_nest_end
argument_list|(
name|msg
argument_list|,
name|beacon_csa
argument_list|)
expr_stmt|;
name|ret
operator|=
name|send_and_recv_msgs
argument_list|(
name|drv
argument_list|,
name|msg
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"nl80211: switch_channel failed err=%d (%s)"
argument_list|,
name|ret
argument_list|,
name|strerror
argument_list|(
operator|-
name|ret
argument_list|)
argument_list|)
expr_stmt|;
block|}
return|return
name|ret
return|;
name|fail
label|:
name|ret
operator|=
operator|-
name|ENOBUFS
expr_stmt|;
name|error
label|:
name|nlmsg_free
argument_list|(
name|msg
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"nl80211: Could not build channel switch request"
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|nl80211_add_ts
parameter_list|(
name|void
modifier|*
name|priv
parameter_list|,
name|u8
name|tsid
parameter_list|,
specifier|const
name|u8
modifier|*
name|addr
parameter_list|,
name|u8
name|user_priority
parameter_list|,
name|u16
name|admitted_time
parameter_list|)
block|{
name|struct
name|i802_bss
modifier|*
name|bss
init|=
name|priv
decl_stmt|;
name|struct
name|wpa_driver_nl80211_data
modifier|*
name|drv
init|=
name|bss
operator|->
name|drv
decl_stmt|;
name|struct
name|nl_msg
modifier|*
name|msg
decl_stmt|;
name|int
name|ret
decl_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"nl80211: add_ts request: tsid=%u admitted_time=%u up=%d"
argument_list|,
name|tsid
argument_list|,
name|admitted_time
argument_list|,
name|user_priority
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|is_sta_interface
argument_list|(
name|drv
operator|->
name|nlmode
argument_list|)
condition|)
return|return
operator|-
name|ENOTSUP
return|;
name|msg
operator|=
name|nl80211_cmd_msg
argument_list|(
name|bss
argument_list|,
literal|0
argument_list|,
name|NL80211_CMD_ADD_TX_TS
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|msg
operator|||
name|nla_put_u8
argument_list|(
name|msg
argument_list|,
name|NL80211_ATTR_TSID
argument_list|,
name|tsid
argument_list|)
operator|||
name|nla_put
argument_list|(
name|msg
argument_list|,
name|NL80211_ATTR_MAC
argument_list|,
name|ETH_ALEN
argument_list|,
name|addr
argument_list|)
operator|||
name|nla_put_u8
argument_list|(
name|msg
argument_list|,
name|NL80211_ATTR_USER_PRIO
argument_list|,
name|user_priority
argument_list|)
operator|||
name|nla_put_u16
argument_list|(
name|msg
argument_list|,
name|NL80211_ATTR_ADMITTED_TIME
argument_list|,
name|admitted_time
argument_list|)
condition|)
block|{
name|nlmsg_free
argument_list|(
name|msg
argument_list|)
expr_stmt|;
return|return
operator|-
name|ENOBUFS
return|;
block|}
name|ret
operator|=
name|send_and_recv_msgs
argument_list|(
name|drv
argument_list|,
name|msg
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"nl80211: add_ts failed err=%d (%s)"
argument_list|,
name|ret
argument_list|,
name|strerror
argument_list|(
operator|-
name|ret
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|nl80211_del_ts
parameter_list|(
name|void
modifier|*
name|priv
parameter_list|,
name|u8
name|tsid
parameter_list|,
specifier|const
name|u8
modifier|*
name|addr
parameter_list|)
block|{
name|struct
name|i802_bss
modifier|*
name|bss
init|=
name|priv
decl_stmt|;
name|struct
name|wpa_driver_nl80211_data
modifier|*
name|drv
init|=
name|bss
operator|->
name|drv
decl_stmt|;
name|struct
name|nl_msg
modifier|*
name|msg
decl_stmt|;
name|int
name|ret
decl_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"nl80211: del_ts request: tsid=%u"
argument_list|,
name|tsid
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|is_sta_interface
argument_list|(
name|drv
operator|->
name|nlmode
argument_list|)
condition|)
return|return
operator|-
name|ENOTSUP
return|;
if|if
condition|(
operator|!
operator|(
name|msg
operator|=
name|nl80211_cmd_msg
argument_list|(
name|bss
argument_list|,
literal|0
argument_list|,
name|NL80211_CMD_DEL_TX_TS
argument_list|)
operator|)
operator|||
name|nla_put_u8
argument_list|(
name|msg
argument_list|,
name|NL80211_ATTR_TSID
argument_list|,
name|tsid
argument_list|)
operator|||
name|nla_put
argument_list|(
name|msg
argument_list|,
name|NL80211_ATTR_MAC
argument_list|,
name|ETH_ALEN
argument_list|,
name|addr
argument_list|)
condition|)
block|{
name|nlmsg_free
argument_list|(
name|msg
argument_list|)
expr_stmt|;
return|return
operator|-
name|ENOBUFS
return|;
block|}
name|ret
operator|=
name|send_and_recv_msgs
argument_list|(
name|drv
argument_list|,
name|msg
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"nl80211: del_ts failed err=%d (%s)"
argument_list|,
name|ret
argument_list|,
name|strerror
argument_list|(
operator|-
name|ret
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_ifdef
ifdef|#
directive|ifdef
name|CONFIG_TESTING_OPTIONS
end_ifdef

begin_function
specifier|static
name|int
name|cmd_reply_handler
parameter_list|(
name|struct
name|nl_msg
modifier|*
name|msg
parameter_list|,
name|void
modifier|*
name|arg
parameter_list|)
block|{
name|struct
name|genlmsghdr
modifier|*
name|gnlh
init|=
name|nlmsg_data
argument_list|(
name|nlmsg_hdr
argument_list|(
name|msg
argument_list|)
argument_list|)
decl_stmt|;
name|struct
name|wpabuf
modifier|*
name|buf
init|=
name|arg
decl_stmt|;
if|if
condition|(
operator|!
name|buf
condition|)
return|return
name|NL_SKIP
return|;
if|if
condition|(
operator|(
name|size_t
operator|)
name|genlmsg_attrlen
argument_list|(
name|gnlh
argument_list|,
literal|0
argument_list|)
operator|>
name|wpabuf_tailroom
argument_list|(
name|buf
argument_list|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"nl80211: insufficient buffer space for reply"
argument_list|)
expr_stmt|;
return|return
name|NL_SKIP
return|;
block|}
name|wpabuf_put_data
argument_list|(
name|buf
argument_list|,
name|genlmsg_attrdata
argument_list|(
name|gnlh
argument_list|,
literal|0
argument_list|)
argument_list|,
name|genlmsg_attrlen
argument_list|(
name|gnlh
argument_list|,
literal|0
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|NL_SKIP
return|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* CONFIG_TESTING_OPTIONS */
end_comment

begin_function
specifier|static
name|int
name|vendor_reply_handler
parameter_list|(
name|struct
name|nl_msg
modifier|*
name|msg
parameter_list|,
name|void
modifier|*
name|arg
parameter_list|)
block|{
name|struct
name|nlattr
modifier|*
name|tb
index|[
name|NL80211_ATTR_MAX
operator|+
literal|1
index|]
decl_stmt|;
name|struct
name|nlattr
modifier|*
name|nl_vendor_reply
decl_stmt|,
modifier|*
name|nl
decl_stmt|;
name|struct
name|genlmsghdr
modifier|*
name|gnlh
init|=
name|nlmsg_data
argument_list|(
name|nlmsg_hdr
argument_list|(
name|msg
argument_list|)
argument_list|)
decl_stmt|;
name|struct
name|wpabuf
modifier|*
name|buf
init|=
name|arg
decl_stmt|;
name|int
name|rem
decl_stmt|;
if|if
condition|(
operator|!
name|buf
condition|)
return|return
name|NL_SKIP
return|;
name|nla_parse
argument_list|(
name|tb
argument_list|,
name|NL80211_ATTR_MAX
argument_list|,
name|genlmsg_attrdata
argument_list|(
name|gnlh
argument_list|,
literal|0
argument_list|)
argument_list|,
name|genlmsg_attrlen
argument_list|(
name|gnlh
argument_list|,
literal|0
argument_list|)
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|nl_vendor_reply
operator|=
name|tb
index|[
name|NL80211_ATTR_VENDOR_DATA
index|]
expr_stmt|;
if|if
condition|(
operator|!
name|nl_vendor_reply
condition|)
return|return
name|NL_SKIP
return|;
if|if
condition|(
operator|(
name|size_t
operator|)
name|nla_len
argument_list|(
name|nl_vendor_reply
argument_list|)
operator|>
name|wpabuf_tailroom
argument_list|(
name|buf
argument_list|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"nl80211: Vendor command: insufficient buffer space for reply"
argument_list|)
expr_stmt|;
return|return
name|NL_SKIP
return|;
block|}
name|nla_for_each_nested
argument_list|(
argument|nl
argument_list|,
argument|nl_vendor_reply
argument_list|,
argument|rem
argument_list|)
block|{
name|wpabuf_put_data
argument_list|(
name|buf
argument_list|,
name|nla_data
argument_list|(
name|nl
argument_list|)
argument_list|,
name|nla_len
argument_list|(
name|nl
argument_list|)
argument_list|)
expr_stmt|;
block|}
return|return
name|NL_SKIP
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|nl80211_vendor_cmd
parameter_list|(
name|void
modifier|*
name|priv
parameter_list|,
name|unsigned
name|int
name|vendor_id
parameter_list|,
name|unsigned
name|int
name|subcmd
parameter_list|,
specifier|const
name|u8
modifier|*
name|data
parameter_list|,
name|size_t
name|data_len
parameter_list|,
name|struct
name|wpabuf
modifier|*
name|buf
parameter_list|)
block|{
name|struct
name|i802_bss
modifier|*
name|bss
init|=
name|priv
decl_stmt|;
name|struct
name|wpa_driver_nl80211_data
modifier|*
name|drv
init|=
name|bss
operator|->
name|drv
decl_stmt|;
name|struct
name|nl_msg
modifier|*
name|msg
decl_stmt|;
name|int
name|ret
decl_stmt|;
ifdef|#
directive|ifdef
name|CONFIG_TESTING_OPTIONS
if|if
condition|(
name|vendor_id
operator|==
literal|0xffffffff
condition|)
block|{
name|msg
operator|=
name|nlmsg_alloc
argument_list|()
expr_stmt|;
if|if
condition|(
operator|!
name|msg
condition|)
return|return
operator|-
name|ENOMEM
return|;
name|nl80211_cmd
argument_list|(
name|drv
argument_list|,
name|msg
argument_list|,
literal|0
argument_list|,
name|subcmd
argument_list|)
expr_stmt|;
if|if
condition|(
name|nlmsg_append
argument_list|(
name|msg
argument_list|,
operator|(
name|void
operator|*
operator|)
name|data
argument_list|,
name|data_len
argument_list|,
name|NLMSG_ALIGNTO
argument_list|)
operator|<
literal|0
condition|)
goto|goto
name|fail
goto|;
name|ret
operator|=
name|send_and_recv_msgs
argument_list|(
name|drv
argument_list|,
name|msg
argument_list|,
name|cmd_reply_handler
argument_list|,
name|buf
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"nl80211: command failed err=%d"
argument_list|,
name|ret
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
endif|#
directive|endif
comment|/* CONFIG_TESTING_OPTIONS */
if|if
condition|(
operator|!
operator|(
name|msg
operator|=
name|nl80211_cmd_msg
argument_list|(
name|bss
argument_list|,
literal|0
argument_list|,
name|NL80211_CMD_VENDOR
argument_list|)
operator|)
operator|||
name|nla_put_u32
argument_list|(
name|msg
argument_list|,
name|NL80211_ATTR_VENDOR_ID
argument_list|,
name|vendor_id
argument_list|)
operator|||
name|nla_put_u32
argument_list|(
name|msg
argument_list|,
name|NL80211_ATTR_VENDOR_SUBCMD
argument_list|,
name|subcmd
argument_list|)
operator|||
operator|(
name|data
operator|&&
name|nla_put
argument_list|(
name|msg
argument_list|,
name|NL80211_ATTR_VENDOR_DATA
argument_list|,
name|data_len
argument_list|,
name|data
argument_list|)
operator|)
condition|)
goto|goto
name|fail
goto|;
name|ret
operator|=
name|send_and_recv_msgs
argument_list|(
name|drv
argument_list|,
name|msg
argument_list|,
name|vendor_reply_handler
argument_list|,
name|buf
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"nl80211: vendor command failed err=%d"
argument_list|,
name|ret
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
name|fail
label|:
name|nlmsg_free
argument_list|(
name|msg
argument_list|)
expr_stmt|;
return|return
operator|-
name|ENOBUFS
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|nl80211_set_qos_map
parameter_list|(
name|void
modifier|*
name|priv
parameter_list|,
specifier|const
name|u8
modifier|*
name|qos_map_set
parameter_list|,
name|u8
name|qos_map_set_len
parameter_list|)
block|{
name|struct
name|i802_bss
modifier|*
name|bss
init|=
name|priv
decl_stmt|;
name|struct
name|wpa_driver_nl80211_data
modifier|*
name|drv
init|=
name|bss
operator|->
name|drv
decl_stmt|;
name|struct
name|nl_msg
modifier|*
name|msg
decl_stmt|;
name|int
name|ret
decl_stmt|;
name|wpa_hexdump
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"nl80211: Setting QoS Map"
argument_list|,
name|qos_map_set
argument_list|,
name|qos_map_set_len
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|msg
operator|=
name|nl80211_drv_msg
argument_list|(
name|drv
argument_list|,
literal|0
argument_list|,
name|NL80211_CMD_SET_QOS_MAP
argument_list|)
operator|)
operator|||
name|nla_put
argument_list|(
name|msg
argument_list|,
name|NL80211_ATTR_QOS_MAP
argument_list|,
name|qos_map_set_len
argument_list|,
name|qos_map_set
argument_list|)
condition|)
block|{
name|nlmsg_free
argument_list|(
name|msg
argument_list|)
expr_stmt|;
return|return
operator|-
name|ENOBUFS
return|;
block|}
name|ret
operator|=
name|send_and_recv_msgs
argument_list|(
name|drv
argument_list|,
name|msg
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"nl80211: Setting QoS Map failed"
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|nl80211_set_wowlan
parameter_list|(
name|void
modifier|*
name|priv
parameter_list|,
specifier|const
name|struct
name|wowlan_triggers
modifier|*
name|triggers
parameter_list|)
block|{
name|struct
name|i802_bss
modifier|*
name|bss
init|=
name|priv
decl_stmt|;
name|struct
name|wpa_driver_nl80211_data
modifier|*
name|drv
init|=
name|bss
operator|->
name|drv
decl_stmt|;
name|struct
name|nl_msg
modifier|*
name|msg
decl_stmt|;
name|struct
name|nlattr
modifier|*
name|wowlan_triggers
decl_stmt|;
name|int
name|ret
decl_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"nl80211: Setting wowlan"
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|msg
operator|=
name|nl80211_drv_msg
argument_list|(
name|drv
argument_list|,
literal|0
argument_list|,
name|NL80211_CMD_SET_WOWLAN
argument_list|)
operator|)
operator|||
operator|!
operator|(
name|wowlan_triggers
operator|=
name|nla_nest_start
argument_list|(
name|msg
argument_list|,
name|NL80211_ATTR_WOWLAN_TRIGGERS
argument_list|)
operator|)
operator|||
operator|(
name|triggers
operator|->
name|any
operator|&&
name|nla_put_flag
argument_list|(
name|msg
argument_list|,
name|NL80211_WOWLAN_TRIG_ANY
argument_list|)
operator|)
operator|||
operator|(
name|triggers
operator|->
name|disconnect
operator|&&
name|nla_put_flag
argument_list|(
name|msg
argument_list|,
name|NL80211_WOWLAN_TRIG_DISCONNECT
argument_list|)
operator|)
operator|||
operator|(
name|triggers
operator|->
name|magic_pkt
operator|&&
name|nla_put_flag
argument_list|(
name|msg
argument_list|,
name|NL80211_WOWLAN_TRIG_MAGIC_PKT
argument_list|)
operator|)
operator|||
operator|(
name|triggers
operator|->
name|gtk_rekey_failure
operator|&&
name|nla_put_flag
argument_list|(
name|msg
argument_list|,
name|NL80211_WOWLAN_TRIG_GTK_REKEY_FAILURE
argument_list|)
operator|)
operator|||
operator|(
name|triggers
operator|->
name|eap_identity_req
operator|&&
name|nla_put_flag
argument_list|(
name|msg
argument_list|,
name|NL80211_WOWLAN_TRIG_EAP_IDENT_REQUEST
argument_list|)
operator|)
operator|||
operator|(
name|triggers
operator|->
name|four_way_handshake
operator|&&
name|nla_put_flag
argument_list|(
name|msg
argument_list|,
name|NL80211_WOWLAN_TRIG_4WAY_HANDSHAKE
argument_list|)
operator|)
operator|||
operator|(
name|triggers
operator|->
name|rfkill_release
operator|&&
name|nla_put_flag
argument_list|(
name|msg
argument_list|,
name|NL80211_WOWLAN_TRIG_RFKILL_RELEASE
argument_list|)
operator|)
condition|)
block|{
name|nlmsg_free
argument_list|(
name|msg
argument_list|)
expr_stmt|;
return|return
operator|-
name|ENOBUFS
return|;
block|}
name|nla_nest_end
argument_list|(
name|msg
argument_list|,
name|wowlan_triggers
argument_list|)
expr_stmt|;
name|ret
operator|=
name|send_and_recv_msgs
argument_list|(
name|drv
argument_list|,
name|msg
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"nl80211: Setting wowlan failed"
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|nl80211_roaming
parameter_list|(
name|void
modifier|*
name|priv
parameter_list|,
name|int
name|allowed
parameter_list|,
specifier|const
name|u8
modifier|*
name|bssid
parameter_list|)
block|{
name|struct
name|i802_bss
modifier|*
name|bss
init|=
name|priv
decl_stmt|;
name|struct
name|wpa_driver_nl80211_data
modifier|*
name|drv
init|=
name|bss
operator|->
name|drv
decl_stmt|;
name|struct
name|nl_msg
modifier|*
name|msg
decl_stmt|;
name|struct
name|nlattr
modifier|*
name|params
decl_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"nl80211: Roaming policy: allowed=%d"
argument_list|,
name|allowed
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|drv
operator|->
name|roaming_vendor_cmd_avail
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"nl80211: Ignore roaming policy change since driver does not provide command for setting it"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
if|if
condition|(
operator|!
operator|(
name|msg
operator|=
name|nl80211_drv_msg
argument_list|(
name|drv
argument_list|,
literal|0
argument_list|,
name|NL80211_CMD_VENDOR
argument_list|)
operator|)
operator|||
name|nla_put_u32
argument_list|(
name|msg
argument_list|,
name|NL80211_ATTR_VENDOR_ID
argument_list|,
name|OUI_QCA
argument_list|)
operator|||
name|nla_put_u32
argument_list|(
name|msg
argument_list|,
name|NL80211_ATTR_VENDOR_SUBCMD
argument_list|,
name|QCA_NL80211_VENDOR_SUBCMD_ROAMING
argument_list|)
operator|||
operator|!
operator|(
name|params
operator|=
name|nla_nest_start
argument_list|(
name|msg
argument_list|,
name|NL80211_ATTR_VENDOR_DATA
argument_list|)
operator|)
operator|||
name|nla_put_u32
argument_list|(
name|msg
argument_list|,
name|QCA_WLAN_VENDOR_ATTR_ROAMING_POLICY
argument_list|,
name|allowed
condition|?
name|QCA_ROAMING_ALLOWED_WITHIN_ESS
else|:
name|QCA_ROAMING_NOT_ALLOWED
argument_list|)
operator|||
operator|(
name|bssid
operator|&&
name|nla_put
argument_list|(
name|msg
argument_list|,
name|QCA_WLAN_VENDOR_ATTR_MAC_ADDR
argument_list|,
name|ETH_ALEN
argument_list|,
name|bssid
argument_list|)
operator|)
condition|)
block|{
name|nlmsg_free
argument_list|(
name|msg
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|nla_nest_end
argument_list|(
name|msg
argument_list|,
name|params
argument_list|)
expr_stmt|;
return|return
name|send_and_recv_msgs
argument_list|(
name|drv
argument_list|,
name|msg
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|nl80211_set_mac_addr
parameter_list|(
name|void
modifier|*
name|priv
parameter_list|,
specifier|const
name|u8
modifier|*
name|addr
parameter_list|)
block|{
name|struct
name|i802_bss
modifier|*
name|bss
init|=
name|priv
decl_stmt|;
name|struct
name|wpa_driver_nl80211_data
modifier|*
name|drv
init|=
name|bss
operator|->
name|drv
decl_stmt|;
name|int
name|new_addr
init|=
name|addr
operator|!=
name|NULL
decl_stmt|;
if|if
condition|(
operator|!
name|addr
condition|)
name|addr
operator|=
name|drv
operator|->
name|perm_addr
expr_stmt|;
if|if
condition|(
name|linux_set_iface_flags
argument_list|(
name|drv
operator|->
name|global
operator|->
name|ioctl_sock
argument_list|,
name|bss
operator|->
name|ifname
argument_list|,
literal|0
argument_list|)
operator|<
literal|0
condition|)
return|return
operator|-
literal|1
return|;
if|if
condition|(
name|linux_set_ifhwaddr
argument_list|(
name|drv
operator|->
name|global
operator|->
name|ioctl_sock
argument_list|,
name|bss
operator|->
name|ifname
argument_list|,
name|addr
argument_list|)
operator|<
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"nl80211: failed to set_mac_addr for %s to "
name|MACSTR
argument_list|,
name|bss
operator|->
name|ifname
argument_list|,
name|MAC2STR
argument_list|(
name|addr
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|linux_set_iface_flags
argument_list|(
name|drv
operator|->
name|global
operator|->
name|ioctl_sock
argument_list|,
name|bss
operator|->
name|ifname
argument_list|,
literal|1
argument_list|)
operator|<
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"nl80211: Could not restore interface UP after failed set_mac_addr"
argument_list|)
expr_stmt|;
block|}
return|return
operator|-
literal|1
return|;
block|}
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"nl80211: set_mac_addr for %s to "
name|MACSTR
argument_list|,
name|bss
operator|->
name|ifname
argument_list|,
name|MAC2STR
argument_list|(
name|addr
argument_list|)
argument_list|)
expr_stmt|;
name|drv
operator|->
name|addr_changed
operator|=
name|new_addr
expr_stmt|;
name|os_memcpy
argument_list|(
name|bss
operator|->
name|addr
argument_list|,
name|addr
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
if|if
condition|(
name|linux_set_iface_flags
argument_list|(
name|drv
operator|->
name|global
operator|->
name|ioctl_sock
argument_list|,
name|bss
operator|->
name|ifname
argument_list|,
literal|1
argument_list|)
operator|<
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"nl80211: Could not restore interface UP after set_mac_addr"
argument_list|)
expr_stmt|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_ifdef
ifdef|#
directive|ifdef
name|CONFIG_MESH
end_ifdef

begin_function
specifier|static
name|int
name|wpa_driver_nl80211_init_mesh
parameter_list|(
name|void
modifier|*
name|priv
parameter_list|)
block|{
if|if
condition|(
name|wpa_driver_nl80211_set_mode
argument_list|(
name|priv
argument_list|,
name|NL80211_IFTYPE_MESH_POINT
argument_list|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"nl80211: Failed to set interface into mesh mode"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|nl80211_put_mesh_id
parameter_list|(
name|struct
name|nl_msg
modifier|*
name|msg
parameter_list|,
specifier|const
name|u8
modifier|*
name|mesh_id
parameter_list|,
name|size_t
name|mesh_id_len
parameter_list|)
block|{
if|if
condition|(
name|mesh_id
condition|)
block|{
name|wpa_hexdump_ascii
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"  * Mesh ID (SSID)"
argument_list|,
name|mesh_id
argument_list|,
name|mesh_id_len
argument_list|)
expr_stmt|;
return|return
name|nla_put
argument_list|(
name|msg
argument_list|,
name|NL80211_ATTR_MESH_ID
argument_list|,
name|mesh_id_len
argument_list|,
name|mesh_id
argument_list|)
return|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|nl80211_join_mesh
parameter_list|(
name|struct
name|i802_bss
modifier|*
name|bss
parameter_list|,
name|struct
name|wpa_driver_mesh_join_params
modifier|*
name|params
parameter_list|)
block|{
name|struct
name|wpa_driver_nl80211_data
modifier|*
name|drv
init|=
name|bss
operator|->
name|drv
decl_stmt|;
name|struct
name|nl_msg
modifier|*
name|msg
decl_stmt|;
name|struct
name|nlattr
modifier|*
name|container
decl_stmt|;
name|int
name|ret
init|=
operator|-
literal|1
decl_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"nl80211: mesh join (ifindex=%d)"
argument_list|,
name|drv
operator|->
name|ifindex
argument_list|)
expr_stmt|;
name|msg
operator|=
name|nl80211_drv_msg
argument_list|(
name|drv
argument_list|,
literal|0
argument_list|,
name|NL80211_CMD_JOIN_MESH
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|msg
operator|||
name|nl80211_put_freq_params
argument_list|(
name|msg
argument_list|,
operator|&
name|params
operator|->
name|freq
argument_list|)
operator|||
name|nl80211_put_basic_rates
argument_list|(
name|msg
argument_list|,
name|params
operator|->
name|basic_rates
argument_list|)
operator|||
name|nl80211_put_mesh_id
argument_list|(
name|msg
argument_list|,
name|params
operator|->
name|meshid
argument_list|,
name|params
operator|->
name|meshid_len
argument_list|)
operator|||
name|nl80211_put_beacon_int
argument_list|(
name|msg
argument_list|,
name|params
operator|->
name|beacon_int
argument_list|)
condition|)
goto|goto
name|fail
goto|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"  * flags=%08X"
argument_list|,
name|params
operator|->
name|flags
argument_list|)
expr_stmt|;
name|container
operator|=
name|nla_nest_start
argument_list|(
name|msg
argument_list|,
name|NL80211_ATTR_MESH_SETUP
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|container
condition|)
goto|goto
name|fail
goto|;
if|if
condition|(
name|params
operator|->
name|ies
condition|)
block|{
name|wpa_hexdump
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"  * IEs"
argument_list|,
name|params
operator|->
name|ies
argument_list|,
name|params
operator|->
name|ie_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|nla_put
argument_list|(
name|msg
argument_list|,
name|NL80211_MESH_SETUP_IE
argument_list|,
name|params
operator|->
name|ie_len
argument_list|,
name|params
operator|->
name|ies
argument_list|)
condition|)
goto|goto
name|fail
goto|;
block|}
comment|/* WPA_DRIVER_MESH_FLAG_OPEN_AUTH is treated as default by nl80211 */
if|if
condition|(
name|params
operator|->
name|flags
operator|&
name|WPA_DRIVER_MESH_FLAG_SAE_AUTH
condition|)
block|{
if|if
condition|(
name|nla_put_u8
argument_list|(
name|msg
argument_list|,
name|NL80211_MESH_SETUP_AUTH_PROTOCOL
argument_list|,
literal|0x1
argument_list|)
operator|||
name|nla_put_flag
argument_list|(
name|msg
argument_list|,
name|NL80211_MESH_SETUP_USERSPACE_AUTH
argument_list|)
condition|)
goto|goto
name|fail
goto|;
block|}
if|if
condition|(
operator|(
name|params
operator|->
name|flags
operator|&
name|WPA_DRIVER_MESH_FLAG_AMPE
operator|)
operator|&&
name|nla_put_flag
argument_list|(
name|msg
argument_list|,
name|NL80211_MESH_SETUP_USERSPACE_AMPE
argument_list|)
condition|)
goto|goto
name|fail
goto|;
if|if
condition|(
operator|(
name|params
operator|->
name|flags
operator|&
name|WPA_DRIVER_MESH_FLAG_USER_MPM
operator|)
operator|&&
name|nla_put_flag
argument_list|(
name|msg
argument_list|,
name|NL80211_MESH_SETUP_USERSPACE_MPM
argument_list|)
condition|)
goto|goto
name|fail
goto|;
name|nla_nest_end
argument_list|(
name|msg
argument_list|,
name|container
argument_list|)
expr_stmt|;
name|container
operator|=
name|nla_nest_start
argument_list|(
name|msg
argument_list|,
name|NL80211_ATTR_MESH_CONFIG
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|container
condition|)
goto|goto
name|fail
goto|;
if|if
condition|(
operator|!
operator|(
name|params
operator|->
name|conf
operator|.
name|flags
operator|&
name|WPA_DRIVER_MESH_CONF_FLAG_AUTO_PLINKS
operator|)
operator|&&
name|nla_put_u32
argument_list|(
name|msg
argument_list|,
name|NL80211_MESHCONF_AUTO_OPEN_PLINKS
argument_list|,
literal|0
argument_list|)
condition|)
goto|goto
name|fail
goto|;
if|if
condition|(
operator|(
name|params
operator|->
name|conf
operator|.
name|flags
operator|&
name|WPA_DRIVER_MESH_FLAG_DRIVER_MPM
operator|)
operator|&&
name|nla_put_u16
argument_list|(
name|msg
argument_list|,
name|NL80211_MESHCONF_MAX_PEER_LINKS
argument_list|,
name|params
operator|->
name|max_peer_links
argument_list|)
condition|)
goto|goto
name|fail
goto|;
comment|/* 	 * Set NL80211_MESHCONF_PLINK_TIMEOUT even if user mpm is used because 	 * the timer could disconnect stations even in that case. 	 */
if|if
condition|(
name|nla_put_u32
argument_list|(
name|msg
argument_list|,
name|NL80211_MESHCONF_PLINK_TIMEOUT
argument_list|,
name|params
operator|->
name|conf
operator|.
name|peer_link_timeout
argument_list|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"nl80211: Failed to set PLINK_TIMEOUT"
argument_list|)
expr_stmt|;
goto|goto
name|fail
goto|;
block|}
name|nla_nest_end
argument_list|(
name|msg
argument_list|,
name|container
argument_list|)
expr_stmt|;
name|ret
operator|=
name|send_and_recv_msgs
argument_list|(
name|drv
argument_list|,
name|msg
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|msg
operator|=
name|NULL
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"nl80211: mesh join failed: ret=%d (%s)"
argument_list|,
name|ret
argument_list|,
name|strerror
argument_list|(
operator|-
name|ret
argument_list|)
argument_list|)
expr_stmt|;
goto|goto
name|fail
goto|;
block|}
name|ret
operator|=
literal|0
expr_stmt|;
name|bss
operator|->
name|freq
operator|=
name|params
operator|->
name|freq
operator|.
name|freq
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"nl80211: mesh join request send successfully"
argument_list|)
expr_stmt|;
name|fail
label|:
name|nlmsg_free
argument_list|(
name|msg
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|wpa_driver_nl80211_join_mesh
parameter_list|(
name|void
modifier|*
name|priv
parameter_list|,
name|struct
name|wpa_driver_mesh_join_params
modifier|*
name|params
parameter_list|)
block|{
name|struct
name|i802_bss
modifier|*
name|bss
init|=
name|priv
decl_stmt|;
name|int
name|ret
decl_stmt|,
name|timeout
decl_stmt|;
name|timeout
operator|=
name|params
operator|->
name|conf
operator|.
name|peer_link_timeout
expr_stmt|;
comment|/* Disable kernel inactivity timer */
if|if
condition|(
name|params
operator|->
name|flags
operator|&
name|WPA_DRIVER_MESH_FLAG_USER_MPM
condition|)
name|params
operator|->
name|conf
operator|.
name|peer_link_timeout
operator|=
literal|0
expr_stmt|;
name|ret
operator|=
name|nl80211_join_mesh
argument_list|(
name|bss
argument_list|,
name|params
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|==
operator|-
name|EINVAL
operator|&&
name|params
operator|->
name|conf
operator|.
name|peer_link_timeout
operator|==
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"nl80211: Mesh join retry for peer_link_timeout"
argument_list|)
expr_stmt|;
comment|/* 		 * Old kernel does not support setting 		 * NL80211_MESHCONF_PLINK_TIMEOUT to zero, so set 60 seconds 		 * into future from peer_link_timeout. 		 */
name|params
operator|->
name|conf
operator|.
name|peer_link_timeout
operator|=
name|timeout
operator|+
literal|60
expr_stmt|;
name|ret
operator|=
name|nl80211_join_mesh
argument_list|(
name|priv
argument_list|,
name|params
argument_list|)
expr_stmt|;
block|}
name|params
operator|->
name|conf
operator|.
name|peer_link_timeout
operator|=
name|timeout
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|wpa_driver_nl80211_leave_mesh
parameter_list|(
name|void
modifier|*
name|priv
parameter_list|)
block|{
name|struct
name|i802_bss
modifier|*
name|bss
init|=
name|priv
decl_stmt|;
name|struct
name|wpa_driver_nl80211_data
modifier|*
name|drv
init|=
name|bss
operator|->
name|drv
decl_stmt|;
name|struct
name|nl_msg
modifier|*
name|msg
decl_stmt|;
name|int
name|ret
decl_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"nl80211: mesh leave (ifindex=%d)"
argument_list|,
name|drv
operator|->
name|ifindex
argument_list|)
expr_stmt|;
name|msg
operator|=
name|nl80211_drv_msg
argument_list|(
name|drv
argument_list|,
literal|0
argument_list|,
name|NL80211_CMD_LEAVE_MESH
argument_list|)
expr_stmt|;
name|ret
operator|=
name|send_and_recv_msgs
argument_list|(
name|drv
argument_list|,
name|msg
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"nl80211: mesh leave failed: ret=%d (%s)"
argument_list|,
name|ret
argument_list|,
name|strerror
argument_list|(
operator|-
name|ret
argument_list|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"nl80211: mesh leave request send successfully"
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|wpa_driver_nl80211_set_mode
argument_list|(
name|drv
operator|->
name|first_bss
argument_list|,
name|NL80211_IFTYPE_STATION
argument_list|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"nl80211: Failed to set interface into station mode"
argument_list|)
expr_stmt|;
block|}
return|return
name|ret
return|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* CONFIG_MESH */
end_comment

begin_function
specifier|static
name|int
name|wpa_driver_br_add_ip_neigh
parameter_list|(
name|void
modifier|*
name|priv
parameter_list|,
name|u8
name|version
parameter_list|,
specifier|const
name|u8
modifier|*
name|ipaddr
parameter_list|,
name|int
name|prefixlen
parameter_list|,
specifier|const
name|u8
modifier|*
name|addr
parameter_list|)
block|{
ifdef|#
directive|ifdef
name|CONFIG_LIBNL3_ROUTE
name|struct
name|i802_bss
modifier|*
name|bss
init|=
name|priv
decl_stmt|;
name|struct
name|wpa_driver_nl80211_data
modifier|*
name|drv
init|=
name|bss
operator|->
name|drv
decl_stmt|;
name|struct
name|rtnl_neigh
modifier|*
name|rn
decl_stmt|;
name|struct
name|nl_addr
modifier|*
name|nl_ipaddr
init|=
name|NULL
decl_stmt|;
name|struct
name|nl_addr
modifier|*
name|nl_lladdr
init|=
name|NULL
decl_stmt|;
name|int
name|family
decl_stmt|,
name|addrsize
decl_stmt|;
name|int
name|res
decl_stmt|;
if|if
condition|(
operator|!
name|ipaddr
operator|||
name|prefixlen
operator|==
literal|0
operator|||
operator|!
name|addr
condition|)
return|return
operator|-
name|EINVAL
return|;
if|if
condition|(
name|bss
operator|->
name|br_ifindex
operator|==
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"nl80211: bridge must be set before adding an ip neigh to it"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
if|if
condition|(
operator|!
name|drv
operator|->
name|rtnl_sk
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"nl80211: nl_sock for NETLINK_ROUTE is not initialized"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
if|if
condition|(
name|version
operator|==
literal|4
condition|)
block|{
name|family
operator|=
name|AF_INET
expr_stmt|;
name|addrsize
operator|=
literal|4
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|version
operator|==
literal|6
condition|)
block|{
name|family
operator|=
name|AF_INET6
expr_stmt|;
name|addrsize
operator|=
literal|16
expr_stmt|;
block|}
else|else
block|{
return|return
operator|-
name|EINVAL
return|;
block|}
name|rn
operator|=
name|rtnl_neigh_alloc
argument_list|()
expr_stmt|;
if|if
condition|(
name|rn
operator|==
name|NULL
condition|)
return|return
operator|-
name|ENOMEM
return|;
comment|/* set the destination ip address for neigh */
name|nl_ipaddr
operator|=
name|nl_addr_build
argument_list|(
name|family
argument_list|,
operator|(
name|void
operator|*
operator|)
name|ipaddr
argument_list|,
name|addrsize
argument_list|)
expr_stmt|;
if|if
condition|(
name|nl_ipaddr
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"nl80211: nl_ipaddr build failed"
argument_list|)
expr_stmt|;
name|res
operator|=
operator|-
name|ENOMEM
expr_stmt|;
goto|goto
name|errout
goto|;
block|}
name|nl_addr_set_prefixlen
argument_list|(
name|nl_ipaddr
argument_list|,
name|prefixlen
argument_list|)
expr_stmt|;
name|res
operator|=
name|rtnl_neigh_set_dst
argument_list|(
name|rn
argument_list|,
name|nl_ipaddr
argument_list|)
expr_stmt|;
if|if
condition|(
name|res
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"nl80211: neigh set destination addr failed"
argument_list|)
expr_stmt|;
goto|goto
name|errout
goto|;
block|}
comment|/* set the corresponding lladdr for neigh */
name|nl_lladdr
operator|=
name|nl_addr_build
argument_list|(
name|AF_BRIDGE
argument_list|,
operator|(
name|u8
operator|*
operator|)
name|addr
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
if|if
condition|(
name|nl_lladdr
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"nl80211: neigh set lladdr failed"
argument_list|)
expr_stmt|;
name|res
operator|=
operator|-
name|ENOMEM
expr_stmt|;
goto|goto
name|errout
goto|;
block|}
name|rtnl_neigh_set_lladdr
argument_list|(
name|rn
argument_list|,
name|nl_lladdr
argument_list|)
expr_stmt|;
name|rtnl_neigh_set_ifindex
argument_list|(
name|rn
argument_list|,
name|bss
operator|->
name|br_ifindex
argument_list|)
expr_stmt|;
name|rtnl_neigh_set_state
argument_list|(
name|rn
argument_list|,
name|NUD_PERMANENT
argument_list|)
expr_stmt|;
name|res
operator|=
name|rtnl_neigh_add
argument_list|(
name|drv
operator|->
name|rtnl_sk
argument_list|,
name|rn
argument_list|,
name|NLM_F_CREATE
argument_list|)
expr_stmt|;
if|if
condition|(
name|res
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"nl80211: Adding bridge ip neigh failed: %s"
argument_list|,
name|strerror
argument_list|(
name|errno
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|errout
label|:
if|if
condition|(
name|nl_lladdr
condition|)
name|nl_addr_put
argument_list|(
name|nl_lladdr
argument_list|)
expr_stmt|;
if|if
condition|(
name|nl_ipaddr
condition|)
name|nl_addr_put
argument_list|(
name|nl_ipaddr
argument_list|)
expr_stmt|;
if|if
condition|(
name|rn
condition|)
name|rtnl_neigh_put
argument_list|(
name|rn
argument_list|)
expr_stmt|;
return|return
name|res
return|;
else|#
directive|else
comment|/* CONFIG_LIBNL3_ROUTE */
return|return
operator|-
literal|1
return|;
endif|#
directive|endif
comment|/* CONFIG_LIBNL3_ROUTE */
block|}
end_function

begin_function
specifier|static
name|int
name|wpa_driver_br_delete_ip_neigh
parameter_list|(
name|void
modifier|*
name|priv
parameter_list|,
name|u8
name|version
parameter_list|,
specifier|const
name|u8
modifier|*
name|ipaddr
parameter_list|)
block|{
ifdef|#
directive|ifdef
name|CONFIG_LIBNL3_ROUTE
name|struct
name|i802_bss
modifier|*
name|bss
init|=
name|priv
decl_stmt|;
name|struct
name|wpa_driver_nl80211_data
modifier|*
name|drv
init|=
name|bss
operator|->
name|drv
decl_stmt|;
name|struct
name|rtnl_neigh
modifier|*
name|rn
decl_stmt|;
name|struct
name|nl_addr
modifier|*
name|nl_ipaddr
decl_stmt|;
name|int
name|family
decl_stmt|,
name|addrsize
decl_stmt|;
name|int
name|res
decl_stmt|;
if|if
condition|(
operator|!
name|ipaddr
condition|)
return|return
operator|-
name|EINVAL
return|;
if|if
condition|(
name|version
operator|==
literal|4
condition|)
block|{
name|family
operator|=
name|AF_INET
expr_stmt|;
name|addrsize
operator|=
literal|4
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|version
operator|==
literal|6
condition|)
block|{
name|family
operator|=
name|AF_INET6
expr_stmt|;
name|addrsize
operator|=
literal|16
expr_stmt|;
block|}
else|else
block|{
return|return
operator|-
name|EINVAL
return|;
block|}
if|if
condition|(
name|bss
operator|->
name|br_ifindex
operator|==
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"nl80211: bridge must be set to delete an ip neigh"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
if|if
condition|(
operator|!
name|drv
operator|->
name|rtnl_sk
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"nl80211: nl_sock for NETLINK_ROUTE is not initialized"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|rn
operator|=
name|rtnl_neigh_alloc
argument_list|()
expr_stmt|;
if|if
condition|(
name|rn
operator|==
name|NULL
condition|)
return|return
operator|-
name|ENOMEM
return|;
comment|/* set the destination ip address for neigh */
name|nl_ipaddr
operator|=
name|nl_addr_build
argument_list|(
name|family
argument_list|,
operator|(
name|void
operator|*
operator|)
name|ipaddr
argument_list|,
name|addrsize
argument_list|)
expr_stmt|;
if|if
condition|(
name|nl_ipaddr
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"nl80211: nl_ipaddr build failed"
argument_list|)
expr_stmt|;
name|res
operator|=
operator|-
name|ENOMEM
expr_stmt|;
goto|goto
name|errout
goto|;
block|}
name|res
operator|=
name|rtnl_neigh_set_dst
argument_list|(
name|rn
argument_list|,
name|nl_ipaddr
argument_list|)
expr_stmt|;
if|if
condition|(
name|res
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"nl80211: neigh set destination addr failed"
argument_list|)
expr_stmt|;
goto|goto
name|errout
goto|;
block|}
name|rtnl_neigh_set_ifindex
argument_list|(
name|rn
argument_list|,
name|bss
operator|->
name|br_ifindex
argument_list|)
expr_stmt|;
name|res
operator|=
name|rtnl_neigh_delete
argument_list|(
name|drv
operator|->
name|rtnl_sk
argument_list|,
name|rn
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|res
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"nl80211: Deleting bridge ip neigh failed: %s"
argument_list|,
name|strerror
argument_list|(
name|errno
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|errout
label|:
if|if
condition|(
name|nl_ipaddr
condition|)
name|nl_addr_put
argument_list|(
name|nl_ipaddr
argument_list|)
expr_stmt|;
if|if
condition|(
name|rn
condition|)
name|rtnl_neigh_put
argument_list|(
name|rn
argument_list|)
expr_stmt|;
return|return
name|res
return|;
else|#
directive|else
comment|/* CONFIG_LIBNL3_ROUTE */
return|return
operator|-
literal|1
return|;
endif|#
directive|endif
comment|/* CONFIG_LIBNL3_ROUTE */
block|}
end_function

begin_function
specifier|static
name|int
name|linux_write_system_file
parameter_list|(
specifier|const
name|char
modifier|*
name|path
parameter_list|,
name|unsigned
name|int
name|val
parameter_list|)
block|{
name|char
name|buf
index|[
literal|50
index|]
decl_stmt|;
name|int
name|fd
decl_stmt|,
name|len
decl_stmt|;
name|len
operator|=
name|os_snprintf
argument_list|(
name|buf
argument_list|,
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
argument_list|,
literal|"%u\n"
argument_list|,
name|val
argument_list|)
expr_stmt|;
if|if
condition|(
name|os_snprintf_error
argument_list|(
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
argument_list|,
name|len
argument_list|)
condition|)
return|return
operator|-
literal|1
return|;
name|fd
operator|=
name|open
argument_list|(
name|path
argument_list|,
name|O_WRONLY
argument_list|)
expr_stmt|;
if|if
condition|(
name|fd
operator|<
literal|0
condition|)
return|return
operator|-
literal|1
return|;
if|if
condition|(
name|write
argument_list|(
name|fd
argument_list|,
name|buf
argument_list|,
name|len
argument_list|)
operator|<
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"nl80211: Failed to write Linux system file: %s with the value of %d"
argument_list|,
name|path
argument_list|,
name|val
argument_list|)
expr_stmt|;
name|close
argument_list|(
name|fd
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|close
argument_list|(
name|fd
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
specifier|const
name|char
modifier|*
name|drv_br_port_attr_str
parameter_list|(
name|enum
name|drv_br_port_attr
name|attr
parameter_list|)
block|{
switch|switch
condition|(
name|attr
condition|)
block|{
case|case
name|DRV_BR_PORT_ATTR_PROXYARP
case|:
return|return
literal|"proxyarp_wifi"
return|;
case|case
name|DRV_BR_PORT_ATTR_HAIRPIN_MODE
case|:
return|return
literal|"hairpin_mode"
return|;
block|}
return|return
name|NULL
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|wpa_driver_br_port_set_attr
parameter_list|(
name|void
modifier|*
name|priv
parameter_list|,
name|enum
name|drv_br_port_attr
name|attr
parameter_list|,
name|unsigned
name|int
name|val
parameter_list|)
block|{
name|struct
name|i802_bss
modifier|*
name|bss
init|=
name|priv
decl_stmt|;
name|char
name|path
index|[
literal|128
index|]
decl_stmt|;
specifier|const
name|char
modifier|*
name|attr_txt
decl_stmt|;
name|attr_txt
operator|=
name|drv_br_port_attr_str
argument_list|(
name|attr
argument_list|)
expr_stmt|;
if|if
condition|(
name|attr_txt
operator|==
name|NULL
condition|)
return|return
operator|-
name|EINVAL
return|;
name|os_snprintf
argument_list|(
name|path
argument_list|,
sizeof|sizeof
argument_list|(
name|path
argument_list|)
argument_list|,
literal|"/sys/class/net/%s/brport/%s"
argument_list|,
name|bss
operator|->
name|ifname
argument_list|,
name|attr_txt
argument_list|)
expr_stmt|;
if|if
condition|(
name|linux_write_system_file
argument_list|(
name|path
argument_list|,
name|val
argument_list|)
condition|)
return|return
operator|-
literal|1
return|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
specifier|const
name|char
modifier|*
name|drv_br_net_param_str
parameter_list|(
name|enum
name|drv_br_net_param
name|param
parameter_list|)
block|{
switch|switch
condition|(
name|param
condition|)
block|{
case|case
name|DRV_BR_NET_PARAM_GARP_ACCEPT
case|:
return|return
literal|"arp_accept"
return|;
block|}
return|return
name|NULL
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|wpa_driver_br_set_net_param
parameter_list|(
name|void
modifier|*
name|priv
parameter_list|,
name|enum
name|drv_br_net_param
name|param
parameter_list|,
name|unsigned
name|int
name|val
parameter_list|)
block|{
name|struct
name|i802_bss
modifier|*
name|bss
init|=
name|priv
decl_stmt|;
name|char
name|path
index|[
literal|128
index|]
decl_stmt|;
specifier|const
name|char
modifier|*
name|param_txt
decl_stmt|;
name|int
name|ip_version
init|=
literal|4
decl_stmt|;
name|param_txt
operator|=
name|drv_br_net_param_str
argument_list|(
name|param
argument_list|)
expr_stmt|;
if|if
condition|(
name|param_txt
operator|==
name|NULL
condition|)
return|return
operator|-
name|EINVAL
return|;
switch|switch
condition|(
name|param
condition|)
block|{
case|case
name|DRV_BR_NET_PARAM_GARP_ACCEPT
case|:
name|ip_version
operator|=
literal|4
expr_stmt|;
break|break;
default|default:
return|return
operator|-
name|EINVAL
return|;
block|}
name|os_snprintf
argument_list|(
name|path
argument_list|,
sizeof|sizeof
argument_list|(
name|path
argument_list|)
argument_list|,
literal|"/proc/sys/net/ipv%d/conf/%s/%s"
argument_list|,
name|ip_version
argument_list|,
name|bss
operator|->
name|brname
argument_list|,
name|param_txt
argument_list|)
expr_stmt|;
if|if
condition|(
name|linux_write_system_file
argument_list|(
name|path
argument_list|,
name|val
argument_list|)
condition|)
return|return
operator|-
literal|1
return|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|hw_mode_to_qca_acs
parameter_list|(
name|enum
name|hostapd_hw_mode
name|hw_mode
parameter_list|)
block|{
switch|switch
condition|(
name|hw_mode
condition|)
block|{
case|case
name|HOSTAPD_MODE_IEEE80211B
case|:
return|return
name|QCA_ACS_MODE_IEEE80211B
return|;
case|case
name|HOSTAPD_MODE_IEEE80211G
case|:
return|return
name|QCA_ACS_MODE_IEEE80211G
return|;
case|case
name|HOSTAPD_MODE_IEEE80211A
case|:
return|return
name|QCA_ACS_MODE_IEEE80211A
return|;
case|case
name|HOSTAPD_MODE_IEEE80211AD
case|:
return|return
name|QCA_ACS_MODE_IEEE80211AD
return|;
default|default:
return|return
operator|-
literal|1
return|;
block|}
block|}
end_function

begin_function
specifier|static
name|int
name|wpa_driver_do_acs
parameter_list|(
name|void
modifier|*
name|priv
parameter_list|,
name|struct
name|drv_acs_params
modifier|*
name|params
parameter_list|)
block|{
name|struct
name|i802_bss
modifier|*
name|bss
init|=
name|priv
decl_stmt|;
name|struct
name|wpa_driver_nl80211_data
modifier|*
name|drv
init|=
name|bss
operator|->
name|drv
decl_stmt|;
name|struct
name|nl_msg
modifier|*
name|msg
decl_stmt|;
name|struct
name|nlattr
modifier|*
name|data
decl_stmt|;
name|int
name|ret
decl_stmt|;
name|int
name|mode
decl_stmt|;
name|mode
operator|=
name|hw_mode_to_qca_acs
argument_list|(
name|params
operator|->
name|hw_mode
argument_list|)
expr_stmt|;
if|if
condition|(
name|mode
operator|<
literal|0
condition|)
return|return
operator|-
literal|1
return|;
if|if
condition|(
operator|!
operator|(
name|msg
operator|=
name|nl80211_drv_msg
argument_list|(
name|drv
argument_list|,
literal|0
argument_list|,
name|NL80211_CMD_VENDOR
argument_list|)
operator|)
operator|||
name|nla_put_u32
argument_list|(
name|msg
argument_list|,
name|NL80211_ATTR_VENDOR_ID
argument_list|,
name|OUI_QCA
argument_list|)
operator|||
name|nla_put_u32
argument_list|(
name|msg
argument_list|,
name|NL80211_ATTR_VENDOR_SUBCMD
argument_list|,
name|QCA_NL80211_VENDOR_SUBCMD_DO_ACS
argument_list|)
operator|||
operator|!
operator|(
name|data
operator|=
name|nla_nest_start
argument_list|(
name|msg
argument_list|,
name|NL80211_ATTR_VENDOR_DATA
argument_list|)
operator|)
operator|||
name|nla_put_u8
argument_list|(
name|msg
argument_list|,
name|QCA_WLAN_VENDOR_ATTR_ACS_HW_MODE
argument_list|,
name|mode
argument_list|)
operator|||
operator|(
name|params
operator|->
name|ht_enabled
operator|&&
name|nla_put_flag
argument_list|(
name|msg
argument_list|,
name|QCA_WLAN_VENDOR_ATTR_ACS_HT_ENABLED
argument_list|)
operator|)
operator|||
operator|(
name|params
operator|->
name|ht40_enabled
operator|&&
name|nla_put_flag
argument_list|(
name|msg
argument_list|,
name|QCA_WLAN_VENDOR_ATTR_ACS_HT40_ENABLED
argument_list|)
operator|)
condition|)
block|{
name|nlmsg_free
argument_list|(
name|msg
argument_list|)
expr_stmt|;
return|return
operator|-
name|ENOBUFS
return|;
block|}
name|nla_nest_end
argument_list|(
name|msg
argument_list|,
name|data
argument_list|)
expr_stmt|;
name|ret
operator|=
name|send_and_recv_msgs
argument_list|(
name|drv
argument_list|,
name|msg
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"nl80211: Failed to invoke driver ACS function: %s"
argument_list|,
name|strerror
argument_list|(
name|errno
argument_list|)
argument_list|)
expr_stmt|;
block|}
return|return
name|ret
return|;
block|}
end_function

begin_decl_stmt
specifier|const
name|struct
name|wpa_driver_ops
name|wpa_driver_nl80211_ops
init|=
block|{
operator|.
name|name
operator|=
literal|"nl80211"
block|,
operator|.
name|desc
operator|=
literal|"Linux nl80211/cfg80211"
block|,
operator|.
name|get_bssid
operator|=
name|wpa_driver_nl80211_get_bssid
block|,
operator|.
name|get_ssid
operator|=
name|wpa_driver_nl80211_get_ssid
block|,
operator|.
name|set_key
operator|=
name|driver_nl80211_set_key
block|,
operator|.
name|scan2
operator|=
name|driver_nl80211_scan2
block|,
operator|.
name|sched_scan
operator|=
name|wpa_driver_nl80211_sched_scan
block|,
operator|.
name|stop_sched_scan
operator|=
name|wpa_driver_nl80211_stop_sched_scan
block|,
operator|.
name|get_scan_results2
operator|=
name|wpa_driver_nl80211_get_scan_results
block|,
operator|.
name|deauthenticate
operator|=
name|driver_nl80211_deauthenticate
block|,
operator|.
name|authenticate
operator|=
name|driver_nl80211_authenticate
block|,
operator|.
name|associate
operator|=
name|wpa_driver_nl80211_associate
block|,
operator|.
name|global_init
operator|=
name|nl80211_global_init
block|,
operator|.
name|global_deinit
operator|=
name|nl80211_global_deinit
block|,
operator|.
name|init2
operator|=
name|wpa_driver_nl80211_init
block|,
operator|.
name|deinit
operator|=
name|driver_nl80211_deinit
block|,
operator|.
name|get_capa
operator|=
name|wpa_driver_nl80211_get_capa
block|,
operator|.
name|set_operstate
operator|=
name|wpa_driver_nl80211_set_operstate
block|,
operator|.
name|set_supp_port
operator|=
name|wpa_driver_nl80211_set_supp_port
block|,
operator|.
name|set_country
operator|=
name|wpa_driver_nl80211_set_country
block|,
operator|.
name|get_country
operator|=
name|wpa_driver_nl80211_get_country
block|,
operator|.
name|set_ap
operator|=
name|wpa_driver_nl80211_set_ap
block|,
operator|.
name|set_acl
operator|=
name|wpa_driver_nl80211_set_acl
block|,
operator|.
name|if_add
operator|=
name|wpa_driver_nl80211_if_add
block|,
operator|.
name|if_remove
operator|=
name|driver_nl80211_if_remove
block|,
operator|.
name|send_mlme
operator|=
name|driver_nl80211_send_mlme
block|,
operator|.
name|get_hw_feature_data
operator|=
name|nl80211_get_hw_feature_data
block|,
operator|.
name|sta_add
operator|=
name|wpa_driver_nl80211_sta_add
block|,
operator|.
name|sta_remove
operator|=
name|driver_nl80211_sta_remove
block|,
operator|.
name|hapd_send_eapol
operator|=
name|wpa_driver_nl80211_hapd_send_eapol
block|,
operator|.
name|sta_set_flags
operator|=
name|wpa_driver_nl80211_sta_set_flags
block|,
operator|.
name|hapd_init
operator|=
name|i802_init
block|,
operator|.
name|hapd_deinit
operator|=
name|i802_deinit
block|,
operator|.
name|set_wds_sta
operator|=
name|i802_set_wds_sta
block|,
operator|.
name|get_seqnum
operator|=
name|i802_get_seqnum
block|,
operator|.
name|flush
operator|=
name|i802_flush
block|,
operator|.
name|get_inact_sec
operator|=
name|i802_get_inact_sec
block|,
operator|.
name|sta_clear_stats
operator|=
name|i802_sta_clear_stats
block|,
operator|.
name|set_rts
operator|=
name|i802_set_rts
block|,
operator|.
name|set_frag
operator|=
name|i802_set_frag
block|,
operator|.
name|set_tx_queue_params
operator|=
name|i802_set_tx_queue_params
block|,
operator|.
name|set_sta_vlan
operator|=
name|driver_nl80211_set_sta_vlan
block|,
operator|.
name|sta_deauth
operator|=
name|i802_sta_deauth
block|,
operator|.
name|sta_disassoc
operator|=
name|i802_sta_disassoc
block|,
operator|.
name|read_sta_data
operator|=
name|driver_nl80211_read_sta_data
block|,
operator|.
name|set_freq
operator|=
name|i802_set_freq
block|,
operator|.
name|send_action
operator|=
name|driver_nl80211_send_action
block|,
operator|.
name|send_action_cancel_wait
operator|=
name|wpa_driver_nl80211_send_action_cancel_wait
block|,
operator|.
name|remain_on_channel
operator|=
name|wpa_driver_nl80211_remain_on_channel
block|,
operator|.
name|cancel_remain_on_channel
operator|=
name|wpa_driver_nl80211_cancel_remain_on_channel
block|,
operator|.
name|probe_req_report
operator|=
name|driver_nl80211_probe_req_report
block|,
operator|.
name|deinit_ap
operator|=
name|wpa_driver_nl80211_deinit_ap
block|,
operator|.
name|deinit_p2p_cli
operator|=
name|wpa_driver_nl80211_deinit_p2p_cli
block|,
operator|.
name|resume
operator|=
name|wpa_driver_nl80211_resume
block|,
operator|.
name|signal_monitor
operator|=
name|nl80211_signal_monitor
block|,
operator|.
name|signal_poll
operator|=
name|nl80211_signal_poll
block|,
operator|.
name|send_frame
operator|=
name|nl80211_send_frame
block|,
operator|.
name|shared_freq
operator|=
name|wpa_driver_nl80211_shared_freq
block|,
operator|.
name|set_param
operator|=
name|nl80211_set_param
block|,
operator|.
name|get_radio_name
operator|=
name|nl80211_get_radio_name
block|,
operator|.
name|add_pmkid
operator|=
name|nl80211_add_pmkid
block|,
operator|.
name|remove_pmkid
operator|=
name|nl80211_remove_pmkid
block|,
operator|.
name|flush_pmkid
operator|=
name|nl80211_flush_pmkid
block|,
operator|.
name|set_rekey_info
operator|=
name|nl80211_set_rekey_info
block|,
operator|.
name|poll_client
operator|=
name|nl80211_poll_client
block|,
operator|.
name|set_p2p_powersave
operator|=
name|nl80211_set_p2p_powersave
block|,
operator|.
name|start_dfs_cac
operator|=
name|nl80211_start_radar_detection
block|,
operator|.
name|stop_ap
operator|=
name|wpa_driver_nl80211_stop_ap
block|,
ifdef|#
directive|ifdef
name|CONFIG_TDLS
operator|.
name|send_tdls_mgmt
operator|=
name|nl80211_send_tdls_mgmt
block|,
operator|.
name|tdls_oper
operator|=
name|nl80211_tdls_oper
block|,
operator|.
name|tdls_enable_channel_switch
operator|=
name|nl80211_tdls_enable_channel_switch
block|,
operator|.
name|tdls_disable_channel_switch
operator|=
name|nl80211_tdls_disable_channel_switch
block|,
endif|#
directive|endif
comment|/* CONFIG_TDLS */
operator|.
name|update_ft_ies
operator|=
name|wpa_driver_nl80211_update_ft_ies
block|,
operator|.
name|get_mac_addr
operator|=
name|wpa_driver_nl80211_get_macaddr
block|,
operator|.
name|get_survey
operator|=
name|wpa_driver_nl80211_get_survey
block|,
operator|.
name|status
operator|=
name|wpa_driver_nl80211_status
block|,
operator|.
name|switch_channel
operator|=
name|nl80211_switch_channel
block|,
ifdef|#
directive|ifdef
name|ANDROID_P2P
operator|.
name|set_noa
operator|=
name|wpa_driver_set_p2p_noa
block|,
operator|.
name|get_noa
operator|=
name|wpa_driver_get_p2p_noa
block|,
operator|.
name|set_ap_wps_ie
operator|=
name|wpa_driver_set_ap_wps_p2p_ie
block|,
endif|#
directive|endif
comment|/* ANDROID_P2P */
ifdef|#
directive|ifdef
name|ANDROID
operator|.
name|driver_cmd
operator|=
name|wpa_driver_nl80211_driver_cmd
block|,
endif|#
directive|endif
comment|/* ANDROID */
operator|.
name|vendor_cmd
operator|=
name|nl80211_vendor_cmd
block|,
operator|.
name|set_qos_map
operator|=
name|nl80211_set_qos_map
block|,
operator|.
name|set_wowlan
operator|=
name|nl80211_set_wowlan
block|,
operator|.
name|roaming
operator|=
name|nl80211_roaming
block|,
operator|.
name|set_mac_addr
operator|=
name|nl80211_set_mac_addr
block|,
ifdef|#
directive|ifdef
name|CONFIG_MESH
operator|.
name|init_mesh
operator|=
name|wpa_driver_nl80211_init_mesh
block|,
operator|.
name|join_mesh
operator|=
name|wpa_driver_nl80211_join_mesh
block|,
operator|.
name|leave_mesh
operator|=
name|wpa_driver_nl80211_leave_mesh
block|,
endif|#
directive|endif
comment|/* CONFIG_MESH */
operator|.
name|br_add_ip_neigh
operator|=
name|wpa_driver_br_add_ip_neigh
block|,
operator|.
name|br_delete_ip_neigh
operator|=
name|wpa_driver_br_delete_ip_neigh
block|,
operator|.
name|br_port_set_attr
operator|=
name|wpa_driver_br_port_set_attr
block|,
operator|.
name|br_set_net_param
operator|=
name|wpa_driver_br_set_net_param
block|,
operator|.
name|add_tx_ts
operator|=
name|nl80211_add_ts
block|,
operator|.
name|del_tx_ts
operator|=
name|nl80211_del_ts
block|,
operator|.
name|do_acs
operator|=
name|wpa_driver_do_acs
block|, }
decl_stmt|;
end_decl_stmt

end_unit


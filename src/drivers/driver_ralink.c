begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * WPA Supplicant - driver interaction with Ralink Wireless Client  * Copyright (c) 2003-2006, Jouni Malinen<j@w1.fi>  * Copyright (c) 2007, Snowpin Lee<snowpin_lee@ralinktech.com.tw>  *  * This program is free software; you can redistribute it and/or modify  * it under the terms of the GNU General Public License version 2 as  * published by the Free Software Foundation.  *  * Alternatively, this software may be distributed under the terms of BSD  * license.  *  * See README and COPYING for more details.  *  */
end_comment

begin_include
include|#
directive|include
file|"includes.h"
end_include

begin_include
include|#
directive|include
file|<sys/ioctl.h>
end_include

begin_include
include|#
directive|include
file|"wireless_copy.h"
end_include

begin_include
include|#
directive|include
file|"common.h"
end_include

begin_include
include|#
directive|include
file|"driver.h"
end_include

begin_include
include|#
directive|include
file|"l2_packet/l2_packet.h"
end_include

begin_include
include|#
directive|include
file|"eloop.h"
end_include

begin_include
include|#
directive|include
file|"ieee802_11_defs.h"
end_include

begin_include
include|#
directive|include
file|"priv_netlink.h"
end_include

begin_include
include|#
directive|include
file|"driver_ralink.h"
end_include

begin_function_decl
specifier|static
name|void
name|wpa_driver_ralink_scan_timeout
parameter_list|(
name|void
modifier|*
name|eloop_ctx
parameter_list|,
name|void
modifier|*
name|timeout_ctx
parameter_list|)
function_decl|;
end_function_decl

begin_define
define|#
directive|define
name|MAX_SSID_LEN
value|32
end_define

begin_struct
struct|struct
name|wpa_driver_ralink_data
block|{
name|void
modifier|*
name|ctx
decl_stmt|;
name|int
name|ioctl_sock
decl_stmt|;
name|int
name|event_sock
decl_stmt|;
name|char
name|ifname
index|[
name|IFNAMSIZ
operator|+
literal|1
index|]
decl_stmt|;
name|u8
modifier|*
name|assoc_req_ies
decl_stmt|;
name|size_t
name|assoc_req_ies_len
decl_stmt|;
name|u8
modifier|*
name|assoc_resp_ies
decl_stmt|;
name|size_t
name|assoc_resp_ies_len
decl_stmt|;
name|int
name|no_of_pmkid
decl_stmt|;
name|struct
name|ndis_pmkid_entry
modifier|*
name|pmkid
decl_stmt|;
name|int
name|we_version_compiled
decl_stmt|;
name|int
name|ap_scan
decl_stmt|;
name|int
name|scanning_done
decl_stmt|;
name|u8
name|g_driver_down
decl_stmt|;
block|}
struct|;
end_struct

begin_function
specifier|static
name|int
name|ralink_set_oid
parameter_list|(
name|struct
name|wpa_driver_ralink_data
modifier|*
name|drv
parameter_list|,
name|unsigned
name|short
name|oid
parameter_list|,
name|char
modifier|*
name|data
parameter_list|,
name|int
name|len
parameter_list|)
block|{
name|char
modifier|*
name|buf
decl_stmt|;
name|struct
name|iwreq
name|iwr
decl_stmt|;
name|buf
operator|=
name|os_zalloc
argument_list|(
name|len
argument_list|)
expr_stmt|;
if|if
condition|(
name|buf
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
name|os_memset
argument_list|(
operator|&
name|iwr
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|iwr
argument_list|)
argument_list|)
expr_stmt|;
name|os_strlcpy
argument_list|(
name|iwr
operator|.
name|ifr_name
argument_list|,
name|drv
operator|->
name|ifname
argument_list|,
name|IFNAMSIZ
argument_list|)
expr_stmt|;
name|iwr
operator|.
name|u
operator|.
name|data
operator|.
name|flags
operator|=
name|oid
expr_stmt|;
name|iwr
operator|.
name|u
operator|.
name|data
operator|.
name|flags
operator||=
name|OID_GET_SET_TOGGLE
expr_stmt|;
if|if
condition|(
name|data
condition|)
name|os_memcpy
argument_list|(
name|buf
argument_list|,
name|data
argument_list|,
name|len
argument_list|)
expr_stmt|;
name|iwr
operator|.
name|u
operator|.
name|data
operator|.
name|pointer
operator|=
operator|(
name|caddr_t
operator|)
name|buf
expr_stmt|;
name|iwr
operator|.
name|u
operator|.
name|data
operator|.
name|length
operator|=
name|len
expr_stmt|;
if|if
condition|(
name|ioctl
argument_list|(
name|drv
operator|->
name|ioctl_sock
argument_list|,
name|RT_PRIV_IOCTL
argument_list|,
operator|&
name|iwr
argument_list|)
operator|<
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"%s: oid=0x%x len (%d) failed"
argument_list|,
name|__func__
argument_list|,
name|oid
argument_list|,
name|len
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|buf
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|os_free
argument_list|(
name|buf
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|ralink_get_new_driver_flag
parameter_list|(
name|struct
name|wpa_driver_ralink_data
modifier|*
name|drv
parameter_list|)
block|{
name|struct
name|iwreq
name|iwr
decl_stmt|;
name|UCHAR
name|enabled
init|=
literal|0
decl_stmt|;
name|os_memset
argument_list|(
operator|&
name|iwr
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|iwr
argument_list|)
argument_list|)
expr_stmt|;
name|os_strlcpy
argument_list|(
name|iwr
operator|.
name|ifr_name
argument_list|,
name|drv
operator|->
name|ifname
argument_list|,
name|IFNAMSIZ
argument_list|)
expr_stmt|;
name|iwr
operator|.
name|u
operator|.
name|data
operator|.
name|pointer
operator|=
operator|(
name|UCHAR
operator|*
operator|)
operator|&
name|enabled
expr_stmt|;
name|iwr
operator|.
name|u
operator|.
name|data
operator|.
name|flags
operator|=
name|RT_OID_NEW_DRIVER
expr_stmt|;
if|if
condition|(
name|ioctl
argument_list|(
name|drv
operator|->
name|ioctl_sock
argument_list|,
name|RT_PRIV_IOCTL
argument_list|,
operator|&
name|iwr
argument_list|)
operator|<
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"%s: failed"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
return|return
operator|(
name|enabled
operator|==
literal|1
operator|)
condition|?
literal|1
else|:
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|wpa_driver_ralink_get_bssid
parameter_list|(
name|void
modifier|*
name|priv
parameter_list|,
name|u8
modifier|*
name|bssid
parameter_list|)
block|{
name|struct
name|wpa_driver_ralink_data
modifier|*
name|drv
init|=
name|priv
decl_stmt|;
name|struct
name|iwreq
name|iwr
decl_stmt|;
name|int
name|ret
init|=
literal|0
decl_stmt|;
if|if
condition|(
name|drv
operator|->
name|g_driver_down
operator|==
literal|1
condition|)
return|return
operator|-
literal|1
return|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"%s"
argument_list|,
name|__FUNCTION__
argument_list|)
expr_stmt|;
name|os_memset
argument_list|(
operator|&
name|iwr
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|iwr
argument_list|)
argument_list|)
expr_stmt|;
name|os_strlcpy
argument_list|(
name|iwr
operator|.
name|ifr_name
argument_list|,
name|drv
operator|->
name|ifname
argument_list|,
name|IFNAMSIZ
argument_list|)
expr_stmt|;
if|if
condition|(
name|ioctl
argument_list|(
name|drv
operator|->
name|ioctl_sock
argument_list|,
name|SIOCGIWAP
argument_list|,
operator|&
name|iwr
argument_list|)
operator|<
literal|0
condition|)
block|{
name|perror
argument_list|(
literal|"ioctl[SIOCGIWAP]"
argument_list|)
expr_stmt|;
name|ret
operator|=
operator|-
literal|1
expr_stmt|;
block|}
name|os_memcpy
argument_list|(
name|bssid
argument_list|,
name|iwr
operator|.
name|u
operator|.
name|ap_addr
operator|.
name|sa_data
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|wpa_driver_ralink_get_ssid
parameter_list|(
name|void
modifier|*
name|priv
parameter_list|,
name|u8
modifier|*
name|ssid
parameter_list|)
block|{
name|struct
name|wpa_driver_ralink_data
modifier|*
name|drv
init|=
name|priv
decl_stmt|;
if|#
directive|if
literal|0
block|struct wpa_supplicant *wpa_s = drv->ctx; 	struct wpa_ssid *entry;
endif|#
directive|endif
name|int
name|ssid_len
decl_stmt|;
name|u8
name|bssid
index|[
name|ETH_ALEN
index|]
decl_stmt|;
name|u8
name|ssid_str
index|[
name|MAX_SSID_LEN
index|]
decl_stmt|;
name|struct
name|iwreq
name|iwr
decl_stmt|;
if|#
directive|if
literal|0
block|int result = 0;
endif|#
directive|endif
name|int
name|ret
init|=
literal|0
decl_stmt|;
if|#
directive|if
literal|0
block|BOOLEAN	ieee8021x_mode = FALSE; 	BOOLEAN ieee8021x_required_key = FALSE;
endif|#
directive|endif
if|if
condition|(
name|drv
operator|->
name|g_driver_down
operator|==
literal|1
condition|)
return|return
operator|-
literal|1
return|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"%s"
argument_list|,
name|__FUNCTION__
argument_list|)
expr_stmt|;
name|os_memset
argument_list|(
operator|&
name|iwr
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|iwr
argument_list|)
argument_list|)
expr_stmt|;
name|os_strlcpy
argument_list|(
name|iwr
operator|.
name|ifr_name
argument_list|,
name|drv
operator|->
name|ifname
argument_list|,
name|IFNAMSIZ
argument_list|)
expr_stmt|;
name|iwr
operator|.
name|u
operator|.
name|essid
operator|.
name|pointer
operator|=
operator|(
name|caddr_t
operator|)
name|ssid
expr_stmt|;
name|iwr
operator|.
name|u
operator|.
name|essid
operator|.
name|length
operator|=
literal|32
expr_stmt|;
if|if
condition|(
name|ioctl
argument_list|(
name|drv
operator|->
name|ioctl_sock
argument_list|,
name|SIOCGIWESSID
argument_list|,
operator|&
name|iwr
argument_list|)
operator|<
literal|0
condition|)
block|{
name|perror
argument_list|(
literal|"ioctl[SIOCGIWESSID]"
argument_list|)
expr_stmt|;
name|ret
operator|=
operator|-
literal|1
expr_stmt|;
block|}
else|else
name|ret
operator|=
name|iwr
operator|.
name|u
operator|.
name|essid
operator|.
name|length
expr_stmt|;
if|if
condition|(
name|ret
operator|<=
literal|0
condition|)
return|return
name|ret
return|;
name|ssid_len
operator|=
name|ret
expr_stmt|;
name|os_memset
argument_list|(
name|ssid_str
argument_list|,
literal|0
argument_list|,
name|MAX_SSID_LEN
argument_list|)
expr_stmt|;
name|os_memcpy
argument_list|(
name|ssid_str
argument_list|,
name|ssid
argument_list|,
name|ssid_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|drv
operator|->
name|ap_scan
operator|==
literal|0
condition|)
block|{
comment|/* Read BSSID form driver */
if|if
condition|(
name|wpa_driver_ralink_get_bssid
argument_list|(
name|priv
argument_list|,
name|bssid
argument_list|)
operator|<
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_WARNING
argument_list|,
literal|"Could not read BSSID from "
literal|"driver."
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
if|#
directive|if
literal|0
block|entry = wpa_s->conf->ssid; 		while (entry) { 			if (!entry->disabled&& ssid_len == entry->ssid_len&& 			    os_memcmp(ssid_str, entry->ssid, ssid_len) == 0&& 			    (!entry->bssid_set || 			     os_memcmp(bssid, entry->bssid, ETH_ALEN) == 0)) {
comment|/* match the config of driver */
block|result = 1; 				break; 			} 			entry = entry->next; 		}  		if (result) { 			wpa_printf(MSG_DEBUG, "Ready to set 802.1x mode and " 				   "ieee_required_keys parameters to driver");
comment|/* set 802.1x mode and ieee_required_keys parameter */
block|if (entry->key_mgmt == WPA_KEY_MGMT_IEEE8021X_NO_WPA) { 				if ((entry->eapol_flags& (EAPOL_FLAG_REQUIRE_KEY_UNICAST | EAPOL_FLAG_REQUIRE_KEY_BROADCAST))) 						ieee8021x_required_key = TRUE; 				ieee8021x_mode = TRUE; 			}  			if (ralink_set_oid(drv, OID_802_11_SET_IEEE8021X, (char *)&ieee8021x_mode, sizeof(BOOLEAN))< 0) 			{ 				wpa_printf(MSG_DEBUG, "RALINK: Failed to set OID_802_11_SET_IEEE8021X(%d)", (int) ieee8021x_mode); 			} 			else 			{ 				wpa_printf(MSG_DEBUG, "ieee8021x_mode is %s", ieee8021x_mode ? "TRUE" : "FALSE"); 			}  			if (ralink_set_oid(drv, OID_802_11_SET_IEEE8021X_REQUIRE_KEY, (char *)&ieee8021x_required_key, sizeof(BOOLEAN))< 0) 			{ 				wpa_printf(MSG_DEBUG, "ERROR: Failed to set OID_802_11_SET_IEEE8021X_REQUIRE_KEY(%d)", (int) ieee8021x_required_key); 			} 			else 			{ 				wpa_printf(MSG_DEBUG, "ieee8021x_required_key is %s and eapol_flag(%d)", ieee8021x_required_key ? "TRUE" : "FALSE", 																								entry->eapol_flags); 			} 		}
endif|#
directive|endif
block|}
return|return
name|ret
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|wpa_driver_ralink_set_ssid
parameter_list|(
name|struct
name|wpa_driver_ralink_data
modifier|*
name|drv
parameter_list|,
specifier|const
name|u8
modifier|*
name|ssid
parameter_list|,
name|size_t
name|ssid_len
parameter_list|)
block|{
name|NDIS_802_11_SSID
modifier|*
name|buf
decl_stmt|;
name|int
name|ret
init|=
literal|0
decl_stmt|;
name|struct
name|iwreq
name|iwr
decl_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"%s"
argument_list|,
name|__FUNCTION__
argument_list|)
expr_stmt|;
name|buf
operator|=
name|os_zalloc
argument_list|(
sizeof|sizeof
argument_list|(
name|NDIS_802_11_SSID
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|buf
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
name|os_memset
argument_list|(
name|buf
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
argument_list|)
expr_stmt|;
name|buf
operator|->
name|SsidLength
operator|=
name|ssid_len
expr_stmt|;
name|os_memcpy
argument_list|(
name|buf
operator|->
name|Ssid
argument_list|,
name|ssid
argument_list|,
name|ssid_len
argument_list|)
expr_stmt|;
name|os_memset
argument_list|(
operator|&
name|iwr
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|iwr
argument_list|)
argument_list|)
expr_stmt|;
name|os_strlcpy
argument_list|(
name|iwr
operator|.
name|ifr_name
argument_list|,
name|drv
operator|->
name|ifname
argument_list|,
name|IFNAMSIZ
argument_list|)
expr_stmt|;
name|iwr
operator|.
name|u
operator|.
name|data
operator|.
name|flags
operator|=
name|OID_802_11_SSID
expr_stmt|;
name|iwr
operator|.
name|u
operator|.
name|data
operator|.
name|flags
operator||=
name|OID_GET_SET_TOGGLE
expr_stmt|;
name|iwr
operator|.
name|u
operator|.
name|data
operator|.
name|pointer
operator|=
operator|(
name|caddr_t
operator|)
name|buf
expr_stmt|;
name|iwr
operator|.
name|u
operator|.
name|data
operator|.
name|length
operator|=
sizeof|sizeof
argument_list|(
name|NDIS_802_11_SSID
argument_list|)
expr_stmt|;
if|if
condition|(
name|ioctl
argument_list|(
name|drv
operator|->
name|ioctl_sock
argument_list|,
name|RT_PRIV_IOCTL
argument_list|,
operator|&
name|iwr
argument_list|)
operator|<
literal|0
condition|)
block|{
name|perror
argument_list|(
literal|"ioctl[RT_PRIV_IOCTL] -- OID_802_11_SSID"
argument_list|)
expr_stmt|;
name|ret
operator|=
operator|-
literal|1
expr_stmt|;
block|}
name|os_free
argument_list|(
name|buf
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|wpa_driver_ralink_event_pmkid
parameter_list|(
name|struct
name|wpa_driver_ralink_data
modifier|*
name|drv
parameter_list|,
specifier|const
name|u8
modifier|*
name|data
parameter_list|,
name|size_t
name|data_len
parameter_list|)
block|{
name|NDIS_802_11_PMKID_CANDIDATE_LIST
modifier|*
name|pmkid
decl_stmt|;
name|size_t
name|i
decl_stmt|;
name|union
name|wpa_event_data
name|event
decl_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"%s"
argument_list|,
name|__FUNCTION__
argument_list|)
expr_stmt|;
if|if
condition|(
name|data_len
operator|<
literal|8
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"RALINK: Too short PMKID Candidate List "
literal|"Event (len=%lu)"
argument_list|,
operator|(
name|unsigned
name|long
operator|)
name|data_len
argument_list|)
expr_stmt|;
return|return;
block|}
name|pmkid
operator|=
operator|(
name|NDIS_802_11_PMKID_CANDIDATE_LIST
operator|*
operator|)
name|data
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"RALINK: PMKID Candidate List Event - Version %d"
literal|" NumCandidates %d"
argument_list|,
operator|(
name|int
operator|)
name|pmkid
operator|->
name|Version
argument_list|,
operator|(
name|int
operator|)
name|pmkid
operator|->
name|NumCandidates
argument_list|)
expr_stmt|;
if|if
condition|(
name|pmkid
operator|->
name|Version
operator|!=
literal|1
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"RALINK: Unsupported PMKID Candidate "
literal|"List Version %d"
argument_list|,
operator|(
name|int
operator|)
name|pmkid
operator|->
name|Version
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|data_len
operator|<
literal|8
operator|+
name|pmkid
operator|->
name|NumCandidates
operator|*
sizeof|sizeof
argument_list|(
name|PMKID_CANDIDATE
argument_list|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"RALINK: PMKID Candidate List "
literal|"underflow"
argument_list|)
expr_stmt|;
return|return;
block|}
name|os_memset
argument_list|(
operator|&
name|event
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|event
argument_list|)
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|pmkid
operator|->
name|NumCandidates
condition|;
name|i
operator|++
control|)
block|{
name|PMKID_CANDIDATE
modifier|*
name|p
init|=
operator|&
name|pmkid
operator|->
name|CandidateList
index|[
name|i
index|]
decl_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"RALINK: %lu: "
name|MACSTR
literal|" Flags 0x%x"
argument_list|,
operator|(
name|unsigned
name|long
operator|)
name|i
argument_list|,
name|MAC2STR
argument_list|(
name|p
operator|->
name|BSSID
argument_list|)
argument_list|,
operator|(
name|int
operator|)
name|p
operator|->
name|Flags
argument_list|)
expr_stmt|;
name|os_memcpy
argument_list|(
name|event
operator|.
name|pmkid_candidate
operator|.
name|bssid
argument_list|,
name|p
operator|->
name|BSSID
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
name|event
operator|.
name|pmkid_candidate
operator|.
name|index
operator|=
name|i
expr_stmt|;
name|event
operator|.
name|pmkid_candidate
operator|.
name|preauth
operator|=
name|p
operator|->
name|Flags
operator|&
name|NDIS_802_11_PMKID_CANDIDATE_PREAUTH_ENABLED
expr_stmt|;
name|wpa_supplicant_event
argument_list|(
name|drv
operator|->
name|ctx
argument_list|,
name|EVENT_PMKID_CANDIDATE
argument_list|,
operator|&
name|event
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|int
name|wpa_driver_ralink_set_pmkid
parameter_list|(
name|struct
name|wpa_driver_ralink_data
modifier|*
name|drv
parameter_list|)
block|{
name|int
name|len
decl_stmt|,
name|count
decl_stmt|,
name|i
decl_stmt|,
name|ret
decl_stmt|;
name|struct
name|ndis_pmkid_entry
modifier|*
name|entry
decl_stmt|;
name|NDIS_802_11_PMKID
modifier|*
name|p
decl_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"%s"
argument_list|,
name|__FUNCTION__
argument_list|)
expr_stmt|;
name|count
operator|=
literal|0
expr_stmt|;
name|entry
operator|=
name|drv
operator|->
name|pmkid
expr_stmt|;
while|while
condition|(
name|entry
condition|)
block|{
name|count
operator|++
expr_stmt|;
if|if
condition|(
name|count
operator|>=
name|drv
operator|->
name|no_of_pmkid
condition|)
break|break;
name|entry
operator|=
name|entry
operator|->
name|next
expr_stmt|;
block|}
name|len
operator|=
literal|8
operator|+
name|count
operator|*
sizeof|sizeof
argument_list|(
name|BSSID_INFO
argument_list|)
expr_stmt|;
name|p
operator|=
name|os_zalloc
argument_list|(
name|len
argument_list|)
expr_stmt|;
if|if
condition|(
name|p
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
name|p
operator|->
name|Length
operator|=
name|len
expr_stmt|;
name|p
operator|->
name|BSSIDInfoCount
operator|=
name|count
expr_stmt|;
name|entry
operator|=
name|drv
operator|->
name|pmkid
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|count
condition|;
name|i
operator|++
control|)
block|{
name|os_memcpy
argument_list|(
operator|&
name|p
operator|->
name|BSSIDInfo
index|[
name|i
index|]
operator|.
name|BSSID
argument_list|,
name|entry
operator|->
name|bssid
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
name|os_memcpy
argument_list|(
operator|&
name|p
operator|->
name|BSSIDInfo
index|[
name|i
index|]
operator|.
name|PMKID
argument_list|,
name|entry
operator|->
name|pmkid
argument_list|,
literal|16
argument_list|)
expr_stmt|;
name|entry
operator|=
name|entry
operator|->
name|next
expr_stmt|;
block|}
name|wpa_hexdump
argument_list|(
name|MSG_MSGDUMP
argument_list|,
literal|"NDIS: OID_802_11_PMKID"
argument_list|,
operator|(
specifier|const
name|u8
operator|*
operator|)
name|p
argument_list|,
name|len
argument_list|)
expr_stmt|;
name|ret
operator|=
name|ralink_set_oid
argument_list|(
name|drv
argument_list|,
name|OID_802_11_PMKID
argument_list|,
operator|(
name|char
operator|*
operator|)
name|p
argument_list|,
name|len
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|p
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|wpa_driver_ralink_add_pmkid
parameter_list|(
name|void
modifier|*
name|priv
parameter_list|,
specifier|const
name|u8
modifier|*
name|bssid
parameter_list|,
specifier|const
name|u8
modifier|*
name|pmkid
parameter_list|)
block|{
name|struct
name|wpa_driver_ralink_data
modifier|*
name|drv
init|=
name|priv
decl_stmt|;
name|struct
name|ndis_pmkid_entry
modifier|*
name|entry
decl_stmt|,
modifier|*
name|prev
decl_stmt|;
if|if
condition|(
name|drv
operator|->
name|g_driver_down
operator|==
literal|1
condition|)
return|return
operator|-
literal|1
return|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"%s"
argument_list|,
name|__FUNCTION__
argument_list|)
expr_stmt|;
if|if
condition|(
name|drv
operator|->
name|no_of_pmkid
operator|==
literal|0
condition|)
return|return
literal|0
return|;
name|prev
operator|=
name|NULL
expr_stmt|;
name|entry
operator|=
name|drv
operator|->
name|pmkid
expr_stmt|;
while|while
condition|(
name|entry
condition|)
block|{
if|if
condition|(
name|os_memcmp
argument_list|(
name|entry
operator|->
name|bssid
argument_list|,
name|bssid
argument_list|,
name|ETH_ALEN
argument_list|)
operator|==
literal|0
condition|)
break|break;
name|prev
operator|=
name|entry
expr_stmt|;
name|entry
operator|=
name|entry
operator|->
name|next
expr_stmt|;
block|}
if|if
condition|(
name|entry
condition|)
block|{
comment|/* Replace existing entry for this BSSID and move it into the 		 * beginning of the list. */
name|os_memcpy
argument_list|(
name|entry
operator|->
name|pmkid
argument_list|,
name|pmkid
argument_list|,
literal|16
argument_list|)
expr_stmt|;
if|if
condition|(
name|prev
condition|)
block|{
name|prev
operator|->
name|next
operator|=
name|entry
operator|->
name|next
expr_stmt|;
name|entry
operator|->
name|next
operator|=
name|drv
operator|->
name|pmkid
expr_stmt|;
name|drv
operator|->
name|pmkid
operator|=
name|entry
expr_stmt|;
block|}
block|}
else|else
block|{
name|entry
operator|=
name|os_malloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|entry
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|entry
condition|)
block|{
name|os_memcpy
argument_list|(
name|entry
operator|->
name|bssid
argument_list|,
name|bssid
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
name|os_memcpy
argument_list|(
name|entry
operator|->
name|pmkid
argument_list|,
name|pmkid
argument_list|,
literal|16
argument_list|)
expr_stmt|;
name|entry
operator|->
name|next
operator|=
name|drv
operator|->
name|pmkid
expr_stmt|;
name|drv
operator|->
name|pmkid
operator|=
name|entry
expr_stmt|;
block|}
block|}
return|return
name|wpa_driver_ralink_set_pmkid
argument_list|(
name|drv
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|wpa_driver_ralink_remove_pmkid
parameter_list|(
name|void
modifier|*
name|priv
parameter_list|,
specifier|const
name|u8
modifier|*
name|bssid
parameter_list|,
specifier|const
name|u8
modifier|*
name|pmkid
parameter_list|)
block|{
name|struct
name|wpa_driver_ralink_data
modifier|*
name|drv
init|=
name|priv
decl_stmt|;
name|struct
name|ndis_pmkid_entry
modifier|*
name|entry
decl_stmt|,
modifier|*
name|prev
decl_stmt|;
if|if
condition|(
name|drv
operator|->
name|g_driver_down
operator|==
literal|1
condition|)
return|return
operator|-
literal|1
return|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"%s"
argument_list|,
name|__FUNCTION__
argument_list|)
expr_stmt|;
if|if
condition|(
name|drv
operator|->
name|no_of_pmkid
operator|==
literal|0
condition|)
return|return
literal|0
return|;
name|entry
operator|=
name|drv
operator|->
name|pmkid
expr_stmt|;
name|prev
operator|=
name|NULL
expr_stmt|;
name|drv
operator|->
name|pmkid
operator|=
name|NULL
expr_stmt|;
while|while
condition|(
name|entry
condition|)
block|{
if|if
condition|(
name|os_memcmp
argument_list|(
name|entry
operator|->
name|bssid
argument_list|,
name|bssid
argument_list|,
name|ETH_ALEN
argument_list|)
operator|==
literal|0
operator|&&
name|os_memcmp
argument_list|(
name|entry
operator|->
name|pmkid
argument_list|,
name|pmkid
argument_list|,
literal|16
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|prev
condition|)
name|prev
operator|->
name|next
operator|=
name|entry
operator|->
name|next
expr_stmt|;
else|else
name|drv
operator|->
name|pmkid
operator|=
name|entry
operator|->
name|next
expr_stmt|;
name|os_free
argument_list|(
name|entry
argument_list|)
expr_stmt|;
break|break;
block|}
name|prev
operator|=
name|entry
expr_stmt|;
name|entry
operator|=
name|entry
operator|->
name|next
expr_stmt|;
block|}
return|return
name|wpa_driver_ralink_set_pmkid
argument_list|(
name|drv
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|wpa_driver_ralink_flush_pmkid
parameter_list|(
name|void
modifier|*
name|priv
parameter_list|)
block|{
name|struct
name|wpa_driver_ralink_data
modifier|*
name|drv
init|=
name|priv
decl_stmt|;
name|NDIS_802_11_PMKID
name|p
decl_stmt|;
name|struct
name|ndis_pmkid_entry
modifier|*
name|pmkid
decl_stmt|,
modifier|*
name|prev
decl_stmt|;
if|if
condition|(
name|drv
operator|->
name|g_driver_down
operator|==
literal|1
condition|)
return|return
operator|-
literal|1
return|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"%s"
argument_list|,
name|__FUNCTION__
argument_list|)
expr_stmt|;
if|if
condition|(
name|drv
operator|->
name|no_of_pmkid
operator|==
literal|0
condition|)
return|return
literal|0
return|;
name|pmkid
operator|=
name|drv
operator|->
name|pmkid
expr_stmt|;
name|drv
operator|->
name|pmkid
operator|=
name|NULL
expr_stmt|;
while|while
condition|(
name|pmkid
condition|)
block|{
name|prev
operator|=
name|pmkid
expr_stmt|;
name|pmkid
operator|=
name|pmkid
operator|->
name|next
expr_stmt|;
name|os_free
argument_list|(
name|prev
argument_list|)
expr_stmt|;
block|}
name|os_memset
argument_list|(
operator|&
name|p
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|p
argument_list|)
argument_list|)
expr_stmt|;
name|p
operator|.
name|Length
operator|=
literal|8
expr_stmt|;
name|p
operator|.
name|BSSIDInfoCount
operator|=
literal|0
expr_stmt|;
name|wpa_hexdump
argument_list|(
name|MSG_MSGDUMP
argument_list|,
literal|"NDIS: OID_802_11_PMKID (flush)"
argument_list|,
operator|(
specifier|const
name|u8
operator|*
operator|)
operator|&
name|p
argument_list|,
literal|8
argument_list|)
expr_stmt|;
return|return
name|ralink_set_oid
argument_list|(
name|drv
argument_list|,
name|OID_802_11_PMKID
argument_list|,
operator|(
name|char
operator|*
operator|)
operator|&
name|p
argument_list|,
literal|8
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|wpa_driver_ralink_event_wireless_custom
parameter_list|(
name|struct
name|wpa_driver_ralink_data
modifier|*
name|drv
parameter_list|,
name|void
modifier|*
name|ctx
parameter_list|,
name|char
modifier|*
name|custom
parameter_list|)
block|{
name|union
name|wpa_event_data
name|data
decl_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"%s"
argument_list|,
name|__FUNCTION__
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"Custom wireless event: '%s'"
argument_list|,
name|custom
argument_list|)
expr_stmt|;
name|os_memset
argument_list|(
operator|&
name|data
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|data
argument_list|)
argument_list|)
expr_stmt|;
comment|/* Host AP driver */
if|if
condition|(
name|os_strncmp
argument_list|(
name|custom
argument_list|,
literal|"MLME-MICHAELMICFAILURE.indication"
argument_list|,
literal|33
argument_list|)
operator|==
literal|0
condition|)
block|{
comment|/* receive a MICFAILURE report */
name|data
operator|.
name|michael_mic_failure
operator|.
name|unicast
operator|=
name|os_strstr
argument_list|(
name|custom
argument_list|,
literal|" unicast"
argument_list|)
operator|!=
name|NULL
expr_stmt|;
comment|/* TODO: parse parameters(?) */
name|wpa_supplicant_event
argument_list|(
name|ctx
argument_list|,
name|EVENT_MICHAEL_MIC_FAILURE
argument_list|,
operator|&
name|data
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|os_strncmp
argument_list|(
name|custom
argument_list|,
literal|"ASSOCINFO_ReqIEs="
argument_list|,
literal|17
argument_list|)
operator|==
literal|0
condition|)
block|{
comment|/* receive assoc. req. IEs */
name|char
modifier|*
name|spos
decl_stmt|;
name|int
name|bytes
decl_stmt|;
name|spos
operator|=
name|custom
operator|+
literal|17
expr_stmt|;
comment|/*get IE's length */
comment|/* 		 * bytes = strlen(spos); ==> bug, bytes may less than original 		 * size by using this way to get size. snowpin 20070312 		 * if (!bytes) 		 *	return; 		 */
name|bytes
operator|=
name|drv
operator|->
name|assoc_req_ies_len
expr_stmt|;
name|data
operator|.
name|assoc_info
operator|.
name|req_ies
operator|=
name|os_malloc
argument_list|(
name|bytes
argument_list|)
expr_stmt|;
if|if
condition|(
name|data
operator|.
name|assoc_info
operator|.
name|req_ies
operator|==
name|NULL
condition|)
return|return;
name|data
operator|.
name|assoc_info
operator|.
name|req_ies_len
operator|=
name|bytes
expr_stmt|;
name|os_memcpy
argument_list|(
name|data
operator|.
name|assoc_info
operator|.
name|req_ies
argument_list|,
name|spos
argument_list|,
name|bytes
argument_list|)
expr_stmt|;
comment|/* skip the '\0' byte */
name|spos
operator|+=
name|bytes
operator|+
literal|1
expr_stmt|;
name|data
operator|.
name|assoc_info
operator|.
name|resp_ies
operator|=
name|NULL
expr_stmt|;
name|data
operator|.
name|assoc_info
operator|.
name|resp_ies_len
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|os_strncmp
argument_list|(
name|spos
argument_list|,
literal|" RespIEs="
argument_list|,
literal|9
argument_list|)
operator|==
literal|0
condition|)
block|{
comment|/* receive assoc. resp. IEs */
name|spos
operator|+=
literal|9
expr_stmt|;
comment|/* get IE's length */
name|bytes
operator|=
name|os_strlen
argument_list|(
name|spos
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|bytes
condition|)
goto|goto
name|done
goto|;
name|data
operator|.
name|assoc_info
operator|.
name|resp_ies
operator|=
name|os_malloc
argument_list|(
name|bytes
argument_list|)
expr_stmt|;
if|if
condition|(
name|data
operator|.
name|assoc_info
operator|.
name|resp_ies
operator|==
name|NULL
condition|)
goto|goto
name|done
goto|;
name|data
operator|.
name|assoc_info
operator|.
name|resp_ies_len
operator|=
name|bytes
expr_stmt|;
name|os_memcpy
argument_list|(
name|data
operator|.
name|assoc_info
operator|.
name|resp_ies
argument_list|,
name|spos
argument_list|,
name|bytes
argument_list|)
expr_stmt|;
block|}
name|wpa_supplicant_event
argument_list|(
name|ctx
argument_list|,
name|EVENT_ASSOCINFO
argument_list|,
operator|&
name|data
argument_list|)
expr_stmt|;
comment|/* free allocated memory */
name|done
label|:
name|os_free
argument_list|(
name|data
operator|.
name|assoc_info
operator|.
name|resp_ies
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|data
operator|.
name|assoc_info
operator|.
name|req_ies
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|wpa_driver_ralink_event_wireless
parameter_list|(
name|struct
name|wpa_driver_ralink_data
modifier|*
name|drv
parameter_list|,
name|void
modifier|*
name|ctx
parameter_list|,
name|char
modifier|*
name|data
parameter_list|,
name|int
name|len
parameter_list|)
block|{
name|struct
name|iw_event
name|iwe_buf
decl_stmt|,
modifier|*
name|iwe
init|=
operator|&
name|iwe_buf
decl_stmt|;
name|char
modifier|*
name|pos
decl_stmt|,
modifier|*
name|end
decl_stmt|,
modifier|*
name|custom
decl_stmt|,
modifier|*
name|buf
decl_stmt|,
modifier|*
name|assoc_info_buf
decl_stmt|,
modifier|*
name|info_pos
decl_stmt|;
if|#
directive|if
literal|0
block|BOOLEAN ieee8021x_required_key = FALSE;
endif|#
directive|endif
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"%s"
argument_list|,
name|__FUNCTION__
argument_list|)
expr_stmt|;
name|assoc_info_buf
operator|=
name|info_pos
operator|=
name|NULL
expr_stmt|;
name|pos
operator|=
name|data
expr_stmt|;
name|end
operator|=
name|data
operator|+
name|len
expr_stmt|;
while|while
condition|(
name|pos
operator|+
name|IW_EV_LCP_LEN
operator|<=
name|end
condition|)
block|{
comment|/* Event data may be unaligned, so make a local, aligned copy 		 * before processing. */
name|os_memcpy
argument_list|(
operator|&
name|iwe_buf
argument_list|,
name|pos
argument_list|,
name|IW_EV_LCP_LEN
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"Wireless event: cmd=0x%x len=%d"
argument_list|,
name|iwe
operator|->
name|cmd
argument_list|,
name|iwe
operator|->
name|len
argument_list|)
expr_stmt|;
if|if
condition|(
name|iwe
operator|->
name|len
operator|<=
name|IW_EV_LCP_LEN
condition|)
return|return;
name|custom
operator|=
name|pos
operator|+
name|IW_EV_POINT_LEN
expr_stmt|;
if|if
condition|(
name|drv
operator|->
name|we_version_compiled
operator|>
literal|18
operator|&&
name|iwe
operator|->
name|cmd
operator|==
name|IWEVCUSTOM
condition|)
block|{
comment|/* WE-19 removed the pointer from struct iw_point */
name|char
modifier|*
name|dpos
init|=
operator|(
name|char
operator|*
operator|)
operator|&
name|iwe_buf
operator|.
name|u
operator|.
name|data
operator|.
name|length
decl_stmt|;
name|int
name|dlen
init|=
name|dpos
operator|-
operator|(
name|char
operator|*
operator|)
operator|&
name|iwe_buf
decl_stmt|;
name|os_memcpy
argument_list|(
name|dpos
argument_list|,
name|pos
operator|+
name|IW_EV_LCP_LEN
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|iw_event
argument_list|)
operator|-
name|dlen
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|os_memcpy
argument_list|(
operator|&
name|iwe_buf
argument_list|,
name|pos
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|iw_event
argument_list|)
argument_list|)
expr_stmt|;
name|custom
operator|+=
name|IW_EV_POINT_OFF
expr_stmt|;
block|}
switch|switch
condition|(
name|iwe
operator|->
name|cmd
condition|)
block|{
case|case
name|IWEVCUSTOM
case|:
if|if
condition|(
name|custom
operator|+
name|iwe
operator|->
name|u
operator|.
name|data
operator|.
name|length
operator|>
name|end
condition|)
return|return;
name|buf
operator|=
name|os_malloc
argument_list|(
name|iwe
operator|->
name|u
operator|.
name|data
operator|.
name|length
operator|+
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|buf
operator|==
name|NULL
condition|)
return|return;
name|os_memcpy
argument_list|(
name|buf
argument_list|,
name|custom
argument_list|,
name|iwe
operator|->
name|u
operator|.
name|data
operator|.
name|length
argument_list|)
expr_stmt|;
name|buf
index|[
name|iwe
operator|->
name|u
operator|.
name|data
operator|.
name|length
index|]
operator|=
literal|'\0'
expr_stmt|;
if|if
condition|(
name|drv
operator|->
name|ap_scan
operator|==
literal|1
condition|)
block|{
if|if
condition|(
operator|(
name|iwe
operator|->
name|u
operator|.
name|data
operator|.
name|flags
operator|==
name|RT_ASSOC_EVENT_FLAG
operator|)
operator|||
operator|(
name|iwe
operator|->
name|u
operator|.
name|data
operator|.
name|flags
operator|==
name|RT_REQIE_EVENT_FLAG
operator|)
operator|||
operator|(
name|iwe
operator|->
name|u
operator|.
name|data
operator|.
name|flags
operator|==
name|RT_RESPIE_EVENT_FLAG
operator|)
operator|||
operator|(
name|iwe
operator|->
name|u
operator|.
name|data
operator|.
name|flags
operator|==
name|RT_ASSOCINFO_EVENT_FLAG
operator|)
condition|)
block|{
if|if
condition|(
name|drv
operator|->
name|scanning_done
operator|==
literal|0
condition|)
block|{
name|os_free
argument_list|(
name|buf
argument_list|)
expr_stmt|;
return|return;
block|}
block|}
block|}
if|if
condition|(
name|iwe
operator|->
name|u
operator|.
name|data
operator|.
name|flags
operator|==
name|RT_ASSOC_EVENT_FLAG
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"Custom wireless event: "
literal|"receive ASSOCIATED_EVENT !!!"
argument_list|)
expr_stmt|;
comment|/* determine whether the dynamic-WEP is used or 				 * not */
if|#
directive|if
literal|0
block|if (wpa_s&& wpa_s->current_ssid&& 				    wpa_s->current_ssid->key_mgmt == 				    WPA_KEY_MGMT_IEEE8021X_NO_WPA) { 					if ((wpa_s->current_ssid->eapol_flags& 					     (EAPOL_FLAG_REQUIRE_KEY_UNICAST | EAPOL_FLAG_REQUIRE_KEY_BROADCAST))) {
comment|//wpa_printf(MSG_DEBUG, "The current ssid - (%s), eapol_flag = %d.\n",
comment|//	 wpa_ssid_txt(wpa_s->current_ssid->ssid, wpa_s->current_ssid->ssid_len),wpa_s->current_ssid->eapol_flags);
block|ieee8021x_required_key = TRUE; 					}  					if (ralink_set_oid(drv, OID_802_11_SET_IEEE8021X_REQUIRE_KEY, (char *)&ieee8021x_required_key, sizeof(BOOLEAN))< 0) 					{ 						wpa_printf(MSG_DEBUG, "ERROR: Failed to set OID_802_11_SET_IEEE8021X_REQUIRE_KEY(%d)", 							   (int) ieee8021x_required_key); 					}  					wpa_printf(MSG_DEBUG, "ieee8021x_required_key is %s and eapol_flag(%d).\n", ieee8021x_required_key ? "TRUE" : "FALSE", 																								wpa_s->current_ssid->eapol_flags); 				}
endif|#
directive|endif
name|wpa_supplicant_event
argument_list|(
name|ctx
argument_list|,
name|EVENT_ASSOC
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|iwe
operator|->
name|u
operator|.
name|data
operator|.
name|flags
operator|==
name|RT_REQIE_EVENT_FLAG
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"Custom wireless event: "
literal|"receive ReqIEs !!!"
argument_list|)
expr_stmt|;
name|drv
operator|->
name|assoc_req_ies
operator|=
name|os_malloc
argument_list|(
name|iwe
operator|->
name|u
operator|.
name|data
operator|.
name|length
argument_list|)
expr_stmt|;
if|if
condition|(
name|drv
operator|->
name|assoc_req_ies
operator|==
name|NULL
condition|)
block|{
name|os_free
argument_list|(
name|buf
argument_list|)
expr_stmt|;
return|return;
block|}
name|drv
operator|->
name|assoc_req_ies_len
operator|=
name|iwe
operator|->
name|u
operator|.
name|data
operator|.
name|length
expr_stmt|;
name|os_memcpy
argument_list|(
name|drv
operator|->
name|assoc_req_ies
argument_list|,
name|custom
argument_list|,
name|iwe
operator|->
name|u
operator|.
name|data
operator|.
name|length
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|iwe
operator|->
name|u
operator|.
name|data
operator|.
name|flags
operator|==
name|RT_RESPIE_EVENT_FLAG
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"Custom wireless event: "
literal|"receive RespIEs !!!"
argument_list|)
expr_stmt|;
name|drv
operator|->
name|assoc_resp_ies
operator|=
name|os_malloc
argument_list|(
name|iwe
operator|->
name|u
operator|.
name|data
operator|.
name|length
argument_list|)
expr_stmt|;
if|if
condition|(
name|drv
operator|->
name|assoc_resp_ies
operator|==
name|NULL
condition|)
block|{
name|os_free
argument_list|(
name|drv
operator|->
name|assoc_req_ies
argument_list|)
expr_stmt|;
name|drv
operator|->
name|assoc_req_ies
operator|=
name|NULL
expr_stmt|;
name|os_free
argument_list|(
name|buf
argument_list|)
expr_stmt|;
return|return;
block|}
name|drv
operator|->
name|assoc_resp_ies_len
operator|=
name|iwe
operator|->
name|u
operator|.
name|data
operator|.
name|length
expr_stmt|;
name|os_memcpy
argument_list|(
name|drv
operator|->
name|assoc_resp_ies
argument_list|,
name|custom
argument_list|,
name|iwe
operator|->
name|u
operator|.
name|data
operator|.
name|length
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|iwe
operator|->
name|u
operator|.
name|data
operator|.
name|flags
operator|==
name|RT_ASSOCINFO_EVENT_FLAG
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"Custom wireless event: "
literal|"receive ASSOCINFO_EVENT !!!"
argument_list|)
expr_stmt|;
name|assoc_info_buf
operator|=
name|os_zalloc
argument_list|(
name|drv
operator|->
name|assoc_req_ies_len
operator|+
name|drv
operator|->
name|assoc_resp_ies_len
operator|+
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|assoc_info_buf
operator|==
name|NULL
condition|)
block|{
name|os_free
argument_list|(
name|drv
operator|->
name|assoc_req_ies
argument_list|)
expr_stmt|;
name|drv
operator|->
name|assoc_req_ies
operator|=
name|NULL
expr_stmt|;
name|os_free
argument_list|(
name|drv
operator|->
name|assoc_resp_ies
argument_list|)
expr_stmt|;
name|drv
operator|->
name|assoc_resp_ies
operator|=
name|NULL
expr_stmt|;
name|os_free
argument_list|(
name|buf
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|drv
operator|->
name|assoc_req_ies
condition|)
block|{
name|os_memcpy
argument_list|(
name|assoc_info_buf
argument_list|,
name|drv
operator|->
name|assoc_req_ies
argument_list|,
name|drv
operator|->
name|assoc_req_ies_len
argument_list|)
expr_stmt|;
block|}
name|info_pos
operator|=
name|assoc_info_buf
operator|+
name|drv
operator|->
name|assoc_req_ies_len
expr_stmt|;
if|if
condition|(
name|drv
operator|->
name|assoc_resp_ies
condition|)
block|{
name|os_memcpy
argument_list|(
name|info_pos
argument_list|,
name|drv
operator|->
name|assoc_resp_ies
argument_list|,
name|drv
operator|->
name|assoc_resp_ies_len
argument_list|)
expr_stmt|;
block|}
name|assoc_info_buf
index|[
name|drv
operator|->
name|assoc_req_ies_len
operator|+
name|drv
operator|->
name|assoc_resp_ies_len
index|]
operator|=
literal|'\0'
expr_stmt|;
name|wpa_driver_ralink_event_wireless_custom
argument_list|(
name|drv
argument_list|,
name|ctx
argument_list|,
name|assoc_info_buf
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|drv
operator|->
name|assoc_req_ies
argument_list|)
expr_stmt|;
name|drv
operator|->
name|assoc_req_ies
operator|=
name|NULL
expr_stmt|;
name|os_free
argument_list|(
name|drv
operator|->
name|assoc_resp_ies
argument_list|)
expr_stmt|;
name|drv
operator|->
name|assoc_resp_ies
operator|=
name|NULL
expr_stmt|;
name|os_free
argument_list|(
name|assoc_info_buf
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|iwe
operator|->
name|u
operator|.
name|data
operator|.
name|flags
operator|==
name|RT_DISASSOC_EVENT_FLAG
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"Custom wireless event: "
literal|"receive DISASSOCIATED_EVENT !!!"
argument_list|)
expr_stmt|;
name|wpa_supplicant_event
argument_list|(
name|ctx
argument_list|,
name|EVENT_DISASSOC
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|iwe
operator|->
name|u
operator|.
name|data
operator|.
name|flags
operator|==
name|RT_PMKIDCAND_FLAG
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"Custom wireless event: "
literal|"receive PMKIDCAND_EVENT !!!"
argument_list|)
expr_stmt|;
name|wpa_driver_ralink_event_pmkid
argument_list|(
name|drv
argument_list|,
operator|(
specifier|const
name|u8
operator|*
operator|)
name|custom
argument_list|,
name|iwe
operator|->
name|u
operator|.
name|data
operator|.
name|length
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|iwe
operator|->
name|u
operator|.
name|data
operator|.
name|flags
operator|==
name|RT_INTERFACE_DOWN
condition|)
block|{
name|drv
operator|->
name|g_driver_down
operator|=
literal|1
expr_stmt|;
name|eloop_terminate
argument_list|()
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|iwe
operator|->
name|u
operator|.
name|data
operator|.
name|flags
operator|==
name|RT_REPORT_AP_INFO
condition|)
block|{
if|if
condition|(
name|drv
operator|->
name|ap_scan
operator|!=
literal|1
condition|)
block|{
typedef|typedef
struct|struct
name|PACKED
block|{
name|UCHAR
name|bssid
index|[
name|MAC_ADDR_LEN
index|]
decl_stmt|;
name|UCHAR
name|ssid
index|[
name|MAX_LEN_OF_SSID
index|]
decl_stmt|;
name|INT
name|ssid_len
decl_stmt|;
name|UCHAR
name|wpa_ie
index|[
literal|40
index|]
decl_stmt|;
name|INT
name|wpa_ie_len
decl_stmt|;
name|UCHAR
name|rsn_ie
index|[
literal|40
index|]
decl_stmt|;
name|INT
name|rsn_ie_len
decl_stmt|;
name|INT
name|freq
decl_stmt|;
name|USHORT
name|caps
decl_stmt|;
block|}
typedef|*
name|PAPINFO
typedef|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"Custom wireless"
literal|" event: receive "
literal|"RT_REPORT_AP_INFO !!!"
argument_list|)
expr_stmt|;
comment|//printf("iwe->u.data.length = %d\n", iwe->u.data.length);
comment|//wpa_hexdump(MSG_DEBUG, "AP_Info: ", buf, iwe->u.data.length);
if|#
directive|if
literal|0
block|wpa_s->num_scan_results = 1; 					if (wpa_s->scan_results) 						os_free(wpa_s->scan_results); 					wpa_s->scan_results = os_malloc(sizeof(struct wpa_scan_result) + 1); 					if (wpa_s->scan_results) { 						PAPINFO pApInfo = (PAPINFO)buf; 						os_memcpy(wpa_s->scan_results[0].bssid, pApInfo->bssid, ETH_ALEN); 						os_memcpy(wpa_s->scan_results[0].ssid, pApInfo->ssid, pApInfo->ssid_len); 						wpa_s->scan_results[0].ssid_len = pApInfo->ssid_len; 						if (pApInfo->wpa_ie_len> 0) { 							os_memcpy(wpa_s->scan_results[0].wpa_ie, pApInfo->wpa_ie, pApInfo->wpa_ie_len); 							wpa_s->scan_results[0].wpa_ie_len = pApInfo->wpa_ie_len; 						} else if (pApInfo->rsn_ie_len> 0) { 							os_memcpy(wpa_s->scan_results[0].rsn_ie, pApInfo->rsn_ie, pApInfo->rsn_ie_len); 							wpa_s->scan_results[0].rsn_ie_len = pApInfo->rsn_ie_len; 						} 						wpa_s->scan_results[0].caps = pApInfo->caps; 						wpa_s->scan_results[0].freq = pApInfo->freq; 					} else { 						wpa_printf("wpa_s->scan_" 							   "results fail to " 							   "os_malloc!!\n"); 					}
endif|#
directive|endif
block|}
block|}
else|else
block|{
name|wpa_driver_ralink_event_wireless_custom
argument_list|(
name|drv
argument_list|,
name|ctx
argument_list|,
name|buf
argument_list|)
expr_stmt|;
block|}
name|os_free
argument_list|(
name|buf
argument_list|)
expr_stmt|;
break|break;
block|}
name|pos
operator|+=
name|iwe
operator|->
name|len
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|wpa_driver_ralink_event_rtm_newlink
parameter_list|(
name|struct
name|wpa_driver_ralink_data
modifier|*
name|drv
parameter_list|,
name|void
modifier|*
name|ctx
parameter_list|,
name|struct
name|nlmsghdr
modifier|*
name|h
parameter_list|,
name|int
name|len
parameter_list|)
block|{
name|struct
name|ifinfomsg
modifier|*
name|ifi
decl_stmt|;
name|int
name|attrlen
decl_stmt|,
name|nlmsg_len
decl_stmt|,
name|rta_len
decl_stmt|;
name|struct
name|rtattr
modifier|*
name|attr
decl_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"%s"
argument_list|,
name|__FUNCTION__
argument_list|)
expr_stmt|;
if|if
condition|(
name|len
operator|<
operator|(
name|int
operator|)
sizeof|sizeof
argument_list|(
operator|*
name|ifi
argument_list|)
condition|)
return|return;
name|ifi
operator|=
name|NLMSG_DATA
argument_list|(
name|h
argument_list|)
expr_stmt|;
name|wpa_hexdump
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"ifi: "
argument_list|,
operator|(
name|u8
operator|*
operator|)
name|ifi
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|ifinfomsg
argument_list|)
argument_list|)
expr_stmt|;
name|nlmsg_len
operator|=
name|NLMSG_ALIGN
argument_list|(
sizeof|sizeof
argument_list|(
expr|struct
name|ifinfomsg
argument_list|)
argument_list|)
expr_stmt|;
name|attrlen
operator|=
name|h
operator|->
name|nlmsg_len
operator|-
name|nlmsg_len
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"attrlen=%d"
argument_list|,
name|attrlen
argument_list|)
expr_stmt|;
if|if
condition|(
name|attrlen
operator|<
literal|0
condition|)
return|return;
name|attr
operator|=
operator|(
expr|struct
name|rtattr
operator|*
operator|)
operator|(
operator|(
operator|(
name|char
operator|*
operator|)
name|ifi
operator|)
operator|+
name|nlmsg_len
operator|)
expr_stmt|;
name|wpa_hexdump
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"attr1: "
argument_list|,
operator|(
name|u8
operator|*
operator|)
name|attr
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|rtattr
argument_list|)
argument_list|)
expr_stmt|;
name|rta_len
operator|=
name|RTA_ALIGN
argument_list|(
sizeof|sizeof
argument_list|(
expr|struct
name|rtattr
argument_list|)
argument_list|)
expr_stmt|;
name|wpa_hexdump
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"attr2: "
argument_list|,
operator|(
name|u8
operator|*
operator|)
name|attr
argument_list|,
name|rta_len
argument_list|)
expr_stmt|;
while|while
condition|(
name|RTA_OK
argument_list|(
name|attr
argument_list|,
name|attrlen
argument_list|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"rta_type=%02x\n"
argument_list|,
name|attr
operator|->
name|rta_type
argument_list|)
expr_stmt|;
if|if
condition|(
name|attr
operator|->
name|rta_type
operator|==
name|IFLA_WIRELESS
condition|)
block|{
name|wpa_driver_ralink_event_wireless
argument_list|(
name|drv
argument_list|,
name|ctx
argument_list|,
operator|(
operator|(
name|char
operator|*
operator|)
name|attr
operator|)
operator|+
name|rta_len
argument_list|,
name|attr
operator|->
name|rta_len
operator|-
name|rta_len
argument_list|)
expr_stmt|;
block|}
name|attr
operator|=
name|RTA_NEXT
argument_list|(
name|attr
argument_list|,
name|attrlen
argument_list|)
expr_stmt|;
name|wpa_hexdump
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"attr3: "
argument_list|,
operator|(
name|u8
operator|*
operator|)
name|attr
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|rtattr
argument_list|)
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|wpa_driver_ralink_event_receive
parameter_list|(
name|int
name|sock
parameter_list|,
name|void
modifier|*
name|ctx
parameter_list|,
name|void
modifier|*
name|sock_ctx
parameter_list|)
block|{
name|char
name|buf
index|[
literal|8192
index|]
decl_stmt|;
name|int
name|left
decl_stmt|;
name|struct
name|sockaddr_nl
name|from
decl_stmt|;
name|socklen_t
name|fromlen
decl_stmt|;
name|struct
name|nlmsghdr
modifier|*
name|h
decl_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"%s"
argument_list|,
name|__FUNCTION__
argument_list|)
expr_stmt|;
name|fromlen
operator|=
sizeof|sizeof
argument_list|(
name|from
argument_list|)
expr_stmt|;
name|left
operator|=
name|recvfrom
argument_list|(
name|sock
argument_list|,
name|buf
argument_list|,
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
argument_list|,
name|MSG_DONTWAIT
argument_list|,
operator|(
expr|struct
name|sockaddr
operator|*
operator|)
operator|&
name|from
argument_list|,
operator|&
name|fromlen
argument_list|)
expr_stmt|;
if|if
condition|(
name|left
operator|<
literal|0
condition|)
block|{
if|if
condition|(
name|errno
operator|!=
name|EINTR
operator|&&
name|errno
operator|!=
name|EAGAIN
condition|)
name|perror
argument_list|(
literal|"recvfrom(netlink)"
argument_list|)
expr_stmt|;
return|return;
block|}
name|h
operator|=
operator|(
expr|struct
name|nlmsghdr
operator|*
operator|)
name|buf
expr_stmt|;
name|wpa_hexdump
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"h: "
argument_list|,
operator|(
name|u8
operator|*
operator|)
name|h
argument_list|,
name|h
operator|->
name|nlmsg_len
argument_list|)
expr_stmt|;
while|while
condition|(
name|left
operator|>=
operator|(
name|int
operator|)
sizeof|sizeof
argument_list|(
operator|*
name|h
argument_list|)
condition|)
block|{
name|int
name|len
decl_stmt|,
name|plen
decl_stmt|;
name|len
operator|=
name|h
operator|->
name|nlmsg_len
expr_stmt|;
name|plen
operator|=
name|len
operator|-
sizeof|sizeof
argument_list|(
operator|*
name|h
argument_list|)
expr_stmt|;
if|if
condition|(
name|len
operator|>
name|left
operator|||
name|plen
operator|<
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"Malformed netlink message: "
literal|"len=%d left=%d plen=%d"
argument_list|,
name|len
argument_list|,
name|left
argument_list|,
name|plen
argument_list|)
expr_stmt|;
break|break;
block|}
switch|switch
condition|(
name|h
operator|->
name|nlmsg_type
condition|)
block|{
case|case
name|RTM_NEWLINK
case|:
name|wpa_driver_ralink_event_rtm_newlink
argument_list|(
name|ctx
argument_list|,
name|sock_ctx
argument_list|,
name|h
argument_list|,
name|plen
argument_list|)
expr_stmt|;
break|break;
block|}
name|len
operator|=
name|NLMSG_ALIGN
argument_list|(
name|len
argument_list|)
expr_stmt|;
name|left
operator|-=
name|len
expr_stmt|;
name|h
operator|=
operator|(
expr|struct
name|nlmsghdr
operator|*
operator|)
operator|(
operator|(
name|char
operator|*
operator|)
name|h
operator|+
name|len
operator|)
expr_stmt|;
block|}
if|if
condition|(
name|left
operator|>
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"%d extra bytes in the end of netlink "
literal|"message"
argument_list|,
name|left
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|int
name|ralink_get_we_version_compiled
parameter_list|(
name|struct
name|wpa_driver_ralink_data
modifier|*
name|drv
parameter_list|)
block|{
name|struct
name|iwreq
name|iwr
decl_stmt|;
name|UINT
name|we_version_compiled
init|=
literal|0
decl_stmt|;
name|os_memset
argument_list|(
operator|&
name|iwr
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|iwr
argument_list|)
argument_list|)
expr_stmt|;
name|os_strlcpy
argument_list|(
name|iwr
operator|.
name|ifr_name
argument_list|,
name|drv
operator|->
name|ifname
argument_list|,
name|IFNAMSIZ
argument_list|)
expr_stmt|;
name|iwr
operator|.
name|u
operator|.
name|data
operator|.
name|pointer
operator|=
operator|(
name|caddr_t
operator|)
operator|&
name|we_version_compiled
expr_stmt|;
name|iwr
operator|.
name|u
operator|.
name|data
operator|.
name|flags
operator|=
name|RT_OID_WE_VERSION_COMPILED
expr_stmt|;
if|if
condition|(
name|ioctl
argument_list|(
name|drv
operator|->
name|ioctl_sock
argument_list|,
name|RT_PRIV_IOCTL
argument_list|,
operator|&
name|iwr
argument_list|)
operator|<
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"%s: failed"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|drv
operator|->
name|we_version_compiled
operator|=
name|we_version_compiled
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|ralink_set_iface_flags
parameter_list|(
name|void
modifier|*
name|priv
parameter_list|,
name|int
name|dev_up
parameter_list|)
block|{
name|struct
name|wpa_driver_ralink_data
modifier|*
name|drv
init|=
name|priv
decl_stmt|;
name|struct
name|ifreq
name|ifr
decl_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"%s"
argument_list|,
name|__FUNCTION__
argument_list|)
expr_stmt|;
if|if
condition|(
name|drv
operator|->
name|ioctl_sock
operator|<
literal|0
condition|)
return|return
operator|-
literal|1
return|;
name|os_memset
argument_list|(
operator|&
name|ifr
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|ifr
argument_list|)
argument_list|)
expr_stmt|;
name|os_snprintf
argument_list|(
name|ifr
operator|.
name|ifr_name
argument_list|,
name|IFNAMSIZ
argument_list|,
literal|"%s"
argument_list|,
name|drv
operator|->
name|ifname
argument_list|)
expr_stmt|;
if|if
condition|(
name|ioctl
argument_list|(
name|drv
operator|->
name|ioctl_sock
argument_list|,
name|SIOCGIFFLAGS
argument_list|,
operator|&
name|ifr
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|perror
argument_list|(
literal|"ioctl[SIOCGIFFLAGS]"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
if|if
condition|(
name|dev_up
condition|)
name|ifr
operator|.
name|ifr_flags
operator||=
name|IFF_UP
expr_stmt|;
else|else
name|ifr
operator|.
name|ifr_flags
operator|&=
operator|~
name|IFF_UP
expr_stmt|;
if|if
condition|(
name|ioctl
argument_list|(
name|drv
operator|->
name|ioctl_sock
argument_list|,
name|SIOCSIFFLAGS
argument_list|,
operator|&
name|ifr
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|perror
argument_list|(
literal|"ioctl[SIOCSIFFLAGS]"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|void
modifier|*
name|wpa_driver_ralink_init
parameter_list|(
name|void
modifier|*
name|ctx
parameter_list|,
specifier|const
name|char
modifier|*
name|ifname
parameter_list|)
block|{
name|int
name|s
decl_stmt|;
name|struct
name|wpa_driver_ralink_data
modifier|*
name|drv
decl_stmt|;
name|struct
name|ifreq
name|ifr
decl_stmt|;
name|struct
name|sockaddr_nl
name|local
decl_stmt|;
name|UCHAR
name|enable_wpa_supplicant
init|=
literal|0
decl_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"%s"
argument_list|,
name|__FUNCTION__
argument_list|)
expr_stmt|;
comment|/* open socket to kernel */
if|if
condition|(
operator|(
name|s
operator|=
name|socket
argument_list|(
name|AF_INET
argument_list|,
name|SOCK_DGRAM
argument_list|,
literal|0
argument_list|)
operator|)
operator|<
literal|0
condition|)
block|{
name|perror
argument_list|(
literal|"socket"
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
comment|/* do it */
name|os_strlcpy
argument_list|(
name|ifr
operator|.
name|ifr_name
argument_list|,
name|ifname
argument_list|,
name|IFNAMSIZ
argument_list|)
expr_stmt|;
if|if
condition|(
name|ioctl
argument_list|(
name|s
argument_list|,
name|SIOCGIFINDEX
argument_list|,
operator|&
name|ifr
argument_list|)
operator|<
literal|0
condition|)
block|{
name|perror
argument_list|(
name|ifr
operator|.
name|ifr_name
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|drv
operator|=
name|os_zalloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|drv
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|drv
operator|==
name|NULL
condition|)
return|return
name|NULL
return|;
name|drv
operator|->
name|scanning_done
operator|=
literal|1
expr_stmt|;
name|drv
operator|->
name|ap_scan
operator|=
literal|1
expr_stmt|;
comment|/* for now - let's assume ap_scan=1 is used */
name|drv
operator|->
name|ctx
operator|=
name|ctx
expr_stmt|;
name|os_strlcpy
argument_list|(
name|drv
operator|->
name|ifname
argument_list|,
name|ifname
argument_list|,
sizeof|sizeof
argument_list|(
name|drv
operator|->
name|ifname
argument_list|)
argument_list|)
expr_stmt|;
name|drv
operator|->
name|ioctl_sock
operator|=
name|s
expr_stmt|;
name|drv
operator|->
name|g_driver_down
operator|=
literal|0
expr_stmt|;
name|s
operator|=
name|socket
argument_list|(
name|PF_NETLINK
argument_list|,
name|SOCK_RAW
argument_list|,
name|NETLINK_ROUTE
argument_list|)
expr_stmt|;
if|if
condition|(
name|s
operator|<
literal|0
condition|)
block|{
name|perror
argument_list|(
literal|"socket(PF_NETLINK,SOCK_RAW,NETLINK_ROUTE)"
argument_list|)
expr_stmt|;
name|close
argument_list|(
name|drv
operator|->
name|ioctl_sock
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|drv
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|os_memset
argument_list|(
operator|&
name|local
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|local
argument_list|)
argument_list|)
expr_stmt|;
name|local
operator|.
name|nl_family
operator|=
name|AF_NETLINK
expr_stmt|;
name|local
operator|.
name|nl_groups
operator|=
name|RTMGRP_LINK
expr_stmt|;
if|if
condition|(
name|bind
argument_list|(
name|s
argument_list|,
operator|(
expr|struct
name|sockaddr
operator|*
operator|)
operator|&
name|local
argument_list|,
sizeof|sizeof
argument_list|(
name|local
argument_list|)
argument_list|)
operator|<
literal|0
condition|)
block|{
name|perror
argument_list|(
literal|"bind(netlink)"
argument_list|)
expr_stmt|;
name|close
argument_list|(
name|s
argument_list|)
expr_stmt|;
name|close
argument_list|(
name|drv
operator|->
name|ioctl_sock
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|drv
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|eloop_register_read_sock
argument_list|(
name|s
argument_list|,
name|wpa_driver_ralink_event_receive
argument_list|,
name|drv
argument_list|,
name|ctx
argument_list|)
expr_stmt|;
name|drv
operator|->
name|event_sock
operator|=
name|s
expr_stmt|;
name|drv
operator|->
name|no_of_pmkid
operator|=
literal|4
expr_stmt|;
comment|/* Number of PMKID saved supported */
name|ralink_set_iface_flags
argument_list|(
name|drv
argument_list|,
literal|1
argument_list|)
expr_stmt|;
comment|/* mark up during setup */
name|ralink_get_we_version_compiled
argument_list|(
name|drv
argument_list|)
expr_stmt|;
name|wpa_driver_ralink_flush_pmkid
argument_list|(
name|drv
argument_list|)
expr_stmt|;
if|if
condition|(
name|drv
operator|->
name|ap_scan
operator|==
literal|1
condition|)
name|enable_wpa_supplicant
operator|=
literal|1
expr_stmt|;
else|else
name|enable_wpa_supplicant
operator|=
literal|2
expr_stmt|;
comment|/* trigger driver support wpa_supplicant */
if|if
condition|(
name|ralink_set_oid
argument_list|(
name|drv
argument_list|,
name|RT_OID_WPA_SUPPLICANT_SUPPORT
argument_list|,
operator|(
name|PCHAR
operator|)
operator|&
name|enable_wpa_supplicant
argument_list|,
sizeof|sizeof
argument_list|(
name|UCHAR
argument_list|)
argument_list|)
operator|<
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"RALINK: Failed to set "
literal|"RT_OID_WPA_SUPPLICANT_SUPPORT(%d)"
argument_list|,
operator|(
name|int
operator|)
name|enable_wpa_supplicant
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"RALINK: Driver does not support "
literal|"wpa_supplicant"
argument_list|)
expr_stmt|;
name|close
argument_list|(
name|s
argument_list|)
expr_stmt|;
name|close
argument_list|(
name|drv
operator|->
name|ioctl_sock
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|drv
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
if|if
condition|(
name|drv
operator|->
name|ap_scan
operator|==
literal|1
condition|)
name|drv
operator|->
name|scanning_done
operator|=
literal|0
expr_stmt|;
return|return
name|drv
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|wpa_driver_ralink_deinit
parameter_list|(
name|void
modifier|*
name|priv
parameter_list|)
block|{
name|struct
name|wpa_driver_ralink_data
modifier|*
name|drv
init|=
name|priv
decl_stmt|;
name|UCHAR
name|enable_wpa_supplicant
decl_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"%s"
argument_list|,
name|__FUNCTION__
argument_list|)
expr_stmt|;
name|enable_wpa_supplicant
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|drv
operator|->
name|g_driver_down
operator|==
literal|0
condition|)
block|{
comment|/* trigger driver disable wpa_supplicant support */
if|if
condition|(
name|ralink_set_oid
argument_list|(
name|drv
argument_list|,
name|RT_OID_WPA_SUPPLICANT_SUPPORT
argument_list|,
operator|(
name|char
operator|*
operator|)
operator|&
name|enable_wpa_supplicant
argument_list|,
sizeof|sizeof
argument_list|(
name|BOOLEAN
argument_list|)
argument_list|)
operator|<
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"RALINK: Failed to set "
literal|"RT_OID_WPA_SUPPLICANT_SUPPORT(%d)"
argument_list|,
operator|(
name|int
operator|)
name|enable_wpa_supplicant
argument_list|)
expr_stmt|;
block|}
name|wpa_driver_ralink_flush_pmkid
argument_list|(
name|drv
argument_list|)
expr_stmt|;
name|sleep
argument_list|(
literal|1
argument_list|)
expr_stmt|;
name|ralink_set_iface_flags
argument_list|(
name|drv
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
name|eloop_cancel_timeout
argument_list|(
name|wpa_driver_ralink_scan_timeout
argument_list|,
name|drv
argument_list|,
name|drv
operator|->
name|ctx
argument_list|)
expr_stmt|;
name|eloop_unregister_read_sock
argument_list|(
name|drv
operator|->
name|event_sock
argument_list|)
expr_stmt|;
name|close
argument_list|(
name|drv
operator|->
name|event_sock
argument_list|)
expr_stmt|;
name|close
argument_list|(
name|drv
operator|->
name|ioctl_sock
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|drv
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|wpa_driver_ralink_scan_timeout
parameter_list|(
name|void
modifier|*
name|eloop_ctx
parameter_list|,
name|void
modifier|*
name|timeout_ctx
parameter_list|)
block|{
name|struct
name|wpa_driver_ralink_data
modifier|*
name|drv
init|=
name|eloop_ctx
decl_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"%s"
argument_list|,
name|__FUNCTION__
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"Scan timeout - try to get results"
argument_list|)
expr_stmt|;
name|wpa_supplicant_event
argument_list|(
name|timeout_ctx
argument_list|,
name|EVENT_SCAN_RESULTS
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|drv
operator|->
name|scanning_done
operator|=
literal|1
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|wpa_driver_ralink_scan
parameter_list|(
name|void
modifier|*
name|priv
parameter_list|,
specifier|const
name|u8
modifier|*
name|ssid
parameter_list|,
name|size_t
name|ssid_len
parameter_list|)
block|{
name|struct
name|wpa_driver_ralink_data
modifier|*
name|drv
init|=
name|priv
decl_stmt|;
name|struct
name|iwreq
name|iwr
decl_stmt|;
name|int
name|ret
init|=
literal|0
decl_stmt|;
if|if
condition|(
name|drv
operator|->
name|g_driver_down
operator|==
literal|1
condition|)
return|return
operator|-
literal|1
return|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"%s"
argument_list|,
name|__FUNCTION__
argument_list|)
expr_stmt|;
if|if
condition|(
name|ssid_len
operator|>
name|IW_ESSID_MAX_SIZE
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"%s: too long SSID (%lu)"
argument_list|,
name|__FUNCTION__
argument_list|,
operator|(
name|unsigned
name|long
operator|)
name|ssid_len
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
comment|/* wpa_driver_ralink_set_ssid(drv, ssid, ssid_len); */
name|os_memset
argument_list|(
operator|&
name|iwr
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|iwr
argument_list|)
argument_list|)
expr_stmt|;
name|os_strlcpy
argument_list|(
name|iwr
operator|.
name|ifr_name
argument_list|,
name|drv
operator|->
name|ifname
argument_list|,
name|IFNAMSIZ
argument_list|)
expr_stmt|;
if|if
condition|(
name|ioctl
argument_list|(
name|drv
operator|->
name|ioctl_sock
argument_list|,
name|SIOCSIWSCAN
argument_list|,
operator|&
name|iwr
argument_list|)
operator|<
literal|0
condition|)
block|{
name|perror
argument_list|(
literal|"ioctl[SIOCSIWSCAN]"
argument_list|)
expr_stmt|;
name|ret
operator|=
operator|-
literal|1
expr_stmt|;
block|}
comment|/* Not all drivers generate "scan completed" wireless event, so try to 	 * read results after a timeout. */
name|eloop_cancel_timeout
argument_list|(
name|wpa_driver_ralink_scan_timeout
argument_list|,
name|drv
argument_list|,
name|drv
operator|->
name|ctx
argument_list|)
expr_stmt|;
name|eloop_register_timeout
argument_list|(
literal|4
argument_list|,
literal|0
argument_list|,
name|wpa_driver_ralink_scan_timeout
argument_list|,
name|drv
argument_list|,
name|drv
operator|->
name|ctx
argument_list|)
expr_stmt|;
name|drv
operator|->
name|scanning_done
operator|=
literal|0
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|wpa_driver_ralink_get_scan_results
parameter_list|(
name|void
modifier|*
name|priv
parameter_list|,
name|struct
name|wpa_scan_result
modifier|*
name|results
parameter_list|,
name|size_t
name|max_size
parameter_list|)
block|{
name|struct
name|wpa_driver_ralink_data
modifier|*
name|drv
init|=
name|priv
decl_stmt|;
name|UCHAR
modifier|*
name|buf
init|=
name|NULL
decl_stmt|;
name|NDIS_802_11_BSSID_LIST_EX
modifier|*
name|wsr
decl_stmt|;
name|NDIS_WLAN_BSSID_EX
modifier|*
name|wbi
decl_stmt|;
name|struct
name|iwreq
name|iwr
decl_stmt|;
name|int
name|rv
init|=
literal|0
decl_stmt|;
name|size_t
name|ap_num
decl_stmt|;
name|u8
modifier|*
name|pos
decl_stmt|,
modifier|*
name|end
decl_stmt|;
if|if
condition|(
name|drv
operator|->
name|g_driver_down
operator|==
literal|1
condition|)
return|return
operator|-
literal|1
return|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"%s"
argument_list|,
name|__FUNCTION__
argument_list|)
expr_stmt|;
if|if
condition|(
name|drv
operator|->
name|we_version_compiled
operator|>=
literal|17
condition|)
block|{
name|buf
operator|=
name|os_zalloc
argument_list|(
literal|8192
argument_list|)
expr_stmt|;
name|iwr
operator|.
name|u
operator|.
name|data
operator|.
name|length
operator|=
literal|8192
expr_stmt|;
block|}
else|else
block|{
name|buf
operator|=
name|os_zalloc
argument_list|(
literal|4096
argument_list|)
expr_stmt|;
name|iwr
operator|.
name|u
operator|.
name|data
operator|.
name|length
operator|=
literal|4096
expr_stmt|;
block|}
if|if
condition|(
name|buf
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
name|wsr
operator|=
operator|(
name|NDIS_802_11_BSSID_LIST_EX
operator|*
operator|)
name|buf
expr_stmt|;
name|wsr
operator|->
name|NumberOfItems
operator|=
literal|0
expr_stmt|;
name|os_strlcpy
argument_list|(
name|iwr
operator|.
name|ifr_name
argument_list|,
name|drv
operator|->
name|ifname
argument_list|,
name|IFNAMSIZ
argument_list|)
expr_stmt|;
name|iwr
operator|.
name|u
operator|.
name|data
operator|.
name|pointer
operator|=
operator|(
name|void
operator|*
operator|)
name|buf
expr_stmt|;
name|iwr
operator|.
name|u
operator|.
name|data
operator|.
name|flags
operator|=
name|OID_802_11_BSSID_LIST
expr_stmt|;
if|if
condition|(
operator|(
name|rv
operator|=
name|ioctl
argument_list|(
name|drv
operator|->
name|ioctl_sock
argument_list|,
name|RT_PRIV_IOCTL
argument_list|,
operator|&
name|iwr
argument_list|)
operator|)
operator|<
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"ioctl fail: rv = %d"
argument_list|,
name|rv
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|buf
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|os_memset
argument_list|(
name|results
argument_list|,
literal|0
argument_list|,
name|max_size
operator|*
sizeof|sizeof
argument_list|(
expr|struct
name|wpa_scan_result
argument_list|)
argument_list|)
expr_stmt|;
for|for
control|(
name|ap_num
operator|=
literal|0
operator|,
name|wbi
operator|=
name|wsr
operator|->
name|Bssid
init|;
name|ap_num
operator|<
name|wsr
operator|->
name|NumberOfItems
condition|;
operator|++
name|ap_num
control|)
block|{
name|os_memcpy
argument_list|(
name|results
index|[
name|ap_num
index|]
operator|.
name|bssid
argument_list|,
operator|&
name|wbi
operator|->
name|MacAddress
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
name|os_memcpy
argument_list|(
name|results
index|[
name|ap_num
index|]
operator|.
name|ssid
argument_list|,
name|wbi
operator|->
name|Ssid
operator|.
name|Ssid
argument_list|,
name|wbi
operator|->
name|Ssid
operator|.
name|SsidLength
argument_list|)
expr_stmt|;
name|results
index|[
name|ap_num
index|]
operator|.
name|ssid_len
operator|=
name|wbi
operator|->
name|Ssid
operator|.
name|SsidLength
expr_stmt|;
name|results
index|[
name|ap_num
index|]
operator|.
name|freq
operator|=
operator|(
name|wbi
operator|->
name|Configuration
operator|.
name|DSConfig
operator|/
literal|1000
operator|)
expr_stmt|;
comment|/* get ie's */
name|wpa_hexdump
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"RALINK: AP IEs"
argument_list|,
operator|(
name|u8
operator|*
operator|)
name|wbi
operator|+
sizeof|sizeof
argument_list|(
operator|*
name|wbi
argument_list|)
operator|-
literal|1
argument_list|,
name|wbi
operator|->
name|IELength
argument_list|)
expr_stmt|;
name|pos
operator|=
operator|(
name|u8
operator|*
operator|)
name|wbi
operator|+
sizeof|sizeof
argument_list|(
operator|*
name|wbi
argument_list|)
operator|-
literal|1
expr_stmt|;
name|end
operator|=
operator|(
name|u8
operator|*
operator|)
name|wbi
operator|+
sizeof|sizeof
argument_list|(
operator|*
name|wbi
argument_list|)
operator|+
name|wbi
operator|->
name|IELength
expr_stmt|;
if|if
condition|(
name|wbi
operator|->
name|IELength
operator|<
sizeof|sizeof
argument_list|(
name|NDIS_802_11_FIXED_IEs
argument_list|)
condition|)
break|break;
name|pos
operator|+=
sizeof|sizeof
argument_list|(
name|NDIS_802_11_FIXED_IEs
argument_list|)
operator|-
literal|2
expr_stmt|;
name|os_memcpy
argument_list|(
operator|&
name|results
index|[
name|ap_num
index|]
operator|.
name|caps
argument_list|,
name|pos
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|pos
operator|+=
literal|2
expr_stmt|;
while|while
condition|(
name|pos
operator|+
literal|1
operator|<
name|end
operator|&&
name|pos
operator|+
literal|2
operator|+
name|pos
index|[
literal|1
index|]
operator|<=
name|end
condition|)
block|{
name|u8
name|ielen
init|=
literal|2
operator|+
name|pos
index|[
literal|1
index|]
decl_stmt|;
if|if
condition|(
name|ielen
operator|>
name|SSID_MAX_WPA_IE_LEN
condition|)
block|{
name|pos
operator|+=
name|ielen
expr_stmt|;
continue|continue;
block|}
if|if
condition|(
name|pos
index|[
literal|0
index|]
operator|==
name|WLAN_EID_VENDOR_SPECIFIC
operator|&&
name|pos
index|[
literal|1
index|]
operator|>=
literal|4
operator|&&
name|os_memcmp
argument_list|(
name|pos
operator|+
literal|2
argument_list|,
literal|"\x00\x50\xf2\x01"
argument_list|,
literal|4
argument_list|)
operator|==
literal|0
condition|)
block|{
name|os_memcpy
argument_list|(
name|results
index|[
name|ap_num
index|]
operator|.
name|wpa_ie
argument_list|,
name|pos
argument_list|,
name|ielen
argument_list|)
expr_stmt|;
name|results
index|[
name|ap_num
index|]
operator|.
name|wpa_ie_len
operator|=
name|ielen
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|pos
index|[
literal|0
index|]
operator|==
name|WLAN_EID_RSN
condition|)
block|{
name|os_memcpy
argument_list|(
name|results
index|[
name|ap_num
index|]
operator|.
name|rsn_ie
argument_list|,
name|pos
argument_list|,
name|ielen
argument_list|)
expr_stmt|;
name|results
index|[
name|ap_num
index|]
operator|.
name|rsn_ie_len
operator|=
name|ielen
expr_stmt|;
block|}
name|pos
operator|+=
name|ielen
expr_stmt|;
block|}
name|wbi
operator|=
operator|(
name|NDIS_WLAN_BSSID_EX
operator|*
operator|)
operator|(
operator|(
name|u8
operator|*
operator|)
name|wbi
operator|+
name|wbi
operator|->
name|Length
operator|)
expr_stmt|;
block|}
name|os_free
argument_list|(
name|buf
argument_list|)
expr_stmt|;
return|return
name|ap_num
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|ralink_set_auth_mode
parameter_list|(
name|struct
name|wpa_driver_ralink_data
modifier|*
name|drv
parameter_list|,
name|NDIS_802_11_AUTHENTICATION_MODE
name|mode
parameter_list|)
block|{
name|NDIS_802_11_AUTHENTICATION_MODE
name|auth_mode
init|=
name|mode
decl_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"%s"
argument_list|,
name|__FUNCTION__
argument_list|)
expr_stmt|;
if|if
condition|(
name|ralink_set_oid
argument_list|(
name|drv
argument_list|,
name|OID_802_11_AUTHENTICATION_MODE
argument_list|,
operator|(
name|char
operator|*
operator|)
operator|&
name|auth_mode
argument_list|,
sizeof|sizeof
argument_list|(
name|auth_mode
argument_list|)
argument_list|)
operator|<
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"RALINK: Failed to set "
literal|"OID_802_11_AUTHENTICATION_MODE (%d)"
argument_list|,
operator|(
name|int
operator|)
name|auth_mode
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|wpa_driver_ralink_remove_key
parameter_list|(
name|struct
name|wpa_driver_ralink_data
modifier|*
name|drv
parameter_list|,
name|int
name|key_idx
parameter_list|,
specifier|const
name|u8
modifier|*
name|addr
parameter_list|,
specifier|const
name|u8
modifier|*
name|bssid
parameter_list|,
name|int
name|pairwise
parameter_list|)
block|{
name|NDIS_802_11_REMOVE_KEY
name|rkey
decl_stmt|;
name|NDIS_802_11_KEY_INDEX
name|_index
decl_stmt|;
name|int
name|res
decl_stmt|,
name|res2
decl_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"%s"
argument_list|,
name|__FUNCTION__
argument_list|)
expr_stmt|;
name|os_memset
argument_list|(
operator|&
name|rkey
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|rkey
argument_list|)
argument_list|)
expr_stmt|;
name|rkey
operator|.
name|Length
operator|=
sizeof|sizeof
argument_list|(
name|rkey
argument_list|)
expr_stmt|;
name|rkey
operator|.
name|KeyIndex
operator|=
name|key_idx
expr_stmt|;
if|if
condition|(
name|pairwise
condition|)
name|rkey
operator|.
name|KeyIndex
operator||=
literal|1
operator|<<
literal|30
expr_stmt|;
name|os_memcpy
argument_list|(
name|rkey
operator|.
name|BSSID
argument_list|,
name|bssid
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
name|res
operator|=
name|ralink_set_oid
argument_list|(
name|drv
argument_list|,
name|OID_802_11_REMOVE_KEY
argument_list|,
operator|(
name|char
operator|*
operator|)
operator|&
name|rkey
argument_list|,
sizeof|sizeof
argument_list|(
name|rkey
argument_list|)
argument_list|)
expr_stmt|;
comment|/* AlbertY@20060210 removed it */
if|if
condition|(
literal|0
comment|/* !pairwise */
condition|)
block|{
name|res2
operator|=
name|ralink_set_oid
argument_list|(
name|drv
argument_list|,
name|OID_802_11_REMOVE_WEP
argument_list|,
operator|(
name|char
operator|*
operator|)
operator|&
name|_index
argument_list|,
sizeof|sizeof
argument_list|(
name|_index
argument_list|)
argument_list|)
expr_stmt|;
block|}
else|else
name|res2
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|res
operator|<
literal|0
operator|&&
name|res2
operator|<
literal|0
condition|)
return|return
name|res
return|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|wpa_driver_ralink_add_wep
parameter_list|(
name|struct
name|wpa_driver_ralink_data
modifier|*
name|drv
parameter_list|,
name|int
name|pairwise
parameter_list|,
name|int
name|key_idx
parameter_list|,
name|int
name|set_tx
parameter_list|,
specifier|const
name|u8
modifier|*
name|key
parameter_list|,
name|size_t
name|key_len
parameter_list|)
block|{
name|NDIS_802_11_WEP
modifier|*
name|wep
decl_stmt|;
name|size_t
name|len
decl_stmt|;
name|int
name|res
decl_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"%s"
argument_list|,
name|__FUNCTION__
argument_list|)
expr_stmt|;
name|len
operator|=
literal|12
operator|+
name|key_len
expr_stmt|;
name|wep
operator|=
name|os_zalloc
argument_list|(
name|len
argument_list|)
expr_stmt|;
if|if
condition|(
name|wep
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
name|wep
operator|->
name|Length
operator|=
name|len
expr_stmt|;
name|wep
operator|->
name|KeyIndex
operator|=
name|key_idx
expr_stmt|;
if|if
condition|(
name|set_tx
condition|)
name|wep
operator|->
name|KeyIndex
operator||=
literal|0x80000000
expr_stmt|;
name|wep
operator|->
name|KeyLength
operator|=
name|key_len
expr_stmt|;
name|os_memcpy
argument_list|(
name|wep
operator|->
name|KeyMaterial
argument_list|,
name|key
argument_list|,
name|key_len
argument_list|)
expr_stmt|;
name|wpa_hexdump_key
argument_list|(
name|MSG_MSGDUMP
argument_list|,
literal|"RALINK: OID_802_11_ADD_WEP"
argument_list|,
operator|(
specifier|const
name|u8
operator|*
operator|)
name|wep
argument_list|,
name|len
argument_list|)
expr_stmt|;
name|res
operator|=
name|ralink_set_oid
argument_list|(
name|drv
argument_list|,
name|OID_802_11_ADD_WEP
argument_list|,
operator|(
name|char
operator|*
operator|)
name|wep
argument_list|,
name|len
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|wep
argument_list|)
expr_stmt|;
return|return
name|res
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|wpa_driver_ralink_set_key
parameter_list|(
name|void
modifier|*
name|priv
parameter_list|,
name|wpa_alg
name|alg
parameter_list|,
specifier|const
name|u8
modifier|*
name|addr
parameter_list|,
name|int
name|key_idx
parameter_list|,
name|int
name|set_tx
parameter_list|,
specifier|const
name|u8
modifier|*
name|seq
parameter_list|,
name|size_t
name|seq_len
parameter_list|,
specifier|const
name|u8
modifier|*
name|key
parameter_list|,
name|size_t
name|key_len
parameter_list|)
block|{
name|struct
name|wpa_driver_ralink_data
modifier|*
name|drv
init|=
name|priv
decl_stmt|;
name|size_t
name|len
decl_stmt|,
name|i
decl_stmt|;
name|NDIS_802_11_KEY
modifier|*
name|nkey
decl_stmt|;
name|int
name|res
decl_stmt|,
name|pairwise
decl_stmt|;
name|u8
name|bssid
index|[
name|ETH_ALEN
index|]
decl_stmt|;
if|if
condition|(
name|drv
operator|->
name|g_driver_down
operator|==
literal|1
condition|)
return|return
operator|-
literal|1
return|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"%s"
argument_list|,
name|__FUNCTION__
argument_list|)
expr_stmt|;
if|if
condition|(
name|addr
operator|==
name|NULL
operator|||
name|os_memcmp
argument_list|(
name|addr
argument_list|,
literal|"\xff\xff\xff\xff\xff\xff"
argument_list|,
name|ETH_ALEN
argument_list|)
operator|==
literal|0
condition|)
block|{
comment|/* Group Key */
name|pairwise
operator|=
literal|0
expr_stmt|;
name|wpa_driver_ralink_get_bssid
argument_list|(
name|drv
argument_list|,
name|bssid
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|/* Pairwise Key */
name|pairwise
operator|=
literal|1
expr_stmt|;
name|os_memcpy
argument_list|(
name|bssid
argument_list|,
name|addr
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|alg
operator|==
name|WPA_ALG_NONE
operator|||
name|key_len
operator|==
literal|0
condition|)
block|{
return|return
name|wpa_driver_ralink_remove_key
argument_list|(
name|drv
argument_list|,
name|key_idx
argument_list|,
name|addr
argument_list|,
name|bssid
argument_list|,
name|pairwise
argument_list|)
return|;
block|}
if|if
condition|(
name|alg
operator|==
name|WPA_ALG_WEP
condition|)
block|{
return|return
name|wpa_driver_ralink_add_wep
argument_list|(
name|drv
argument_list|,
name|pairwise
argument_list|,
name|key_idx
argument_list|,
name|set_tx
argument_list|,
name|key
argument_list|,
name|key_len
argument_list|)
return|;
block|}
name|len
operator|=
literal|12
operator|+
literal|6
operator|+
literal|6
operator|+
literal|8
operator|+
name|key_len
expr_stmt|;
name|nkey
operator|=
name|os_zalloc
argument_list|(
name|len
argument_list|)
expr_stmt|;
if|if
condition|(
name|nkey
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
name|nkey
operator|->
name|Length
operator|=
name|len
expr_stmt|;
name|nkey
operator|->
name|KeyIndex
operator|=
name|key_idx
expr_stmt|;
if|if
condition|(
name|set_tx
condition|)
name|nkey
operator|->
name|KeyIndex
operator||=
literal|1
operator|<<
literal|31
expr_stmt|;
if|if
condition|(
name|pairwise
condition|)
name|nkey
operator|->
name|KeyIndex
operator||=
literal|1
operator|<<
literal|30
expr_stmt|;
if|if
condition|(
name|seq
operator|&&
name|seq_len
condition|)
name|nkey
operator|->
name|KeyIndex
operator||=
literal|1
operator|<<
literal|29
expr_stmt|;
name|nkey
operator|->
name|KeyLength
operator|=
name|key_len
expr_stmt|;
name|os_memcpy
argument_list|(
name|nkey
operator|->
name|BSSID
argument_list|,
name|bssid
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
if|if
condition|(
name|seq
operator|&&
name|seq_len
condition|)
block|{
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|seq_len
condition|;
name|i
operator|++
control|)
name|nkey
operator|->
name|KeyRSC
operator||=
name|seq
index|[
name|i
index|]
operator|<<
operator|(
name|i
operator|*
literal|8
operator|)
expr_stmt|;
block|}
if|if
condition|(
name|alg
operator|==
name|WPA_ALG_TKIP
operator|&&
name|key_len
operator|==
literal|32
condition|)
block|{
name|os_memcpy
argument_list|(
name|nkey
operator|->
name|KeyMaterial
argument_list|,
name|key
argument_list|,
literal|16
argument_list|)
expr_stmt|;
name|os_memcpy
argument_list|(
name|nkey
operator|->
name|KeyMaterial
operator|+
literal|16
argument_list|,
name|key
operator|+
literal|24
argument_list|,
literal|8
argument_list|)
expr_stmt|;
name|os_memcpy
argument_list|(
name|nkey
operator|->
name|KeyMaterial
operator|+
literal|24
argument_list|,
name|key
operator|+
literal|16
argument_list|,
literal|8
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|os_memcpy
argument_list|(
name|nkey
operator|->
name|KeyMaterial
argument_list|,
name|key
argument_list|,
name|key_len
argument_list|)
expr_stmt|;
block|}
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"%s: alg=%d key_idx=%d set_tx=%d seq_len=%lu "
literal|"key_len=%lu"
argument_list|,
name|__FUNCTION__
argument_list|,
name|alg
argument_list|,
name|key_idx
argument_list|,
name|set_tx
argument_list|,
operator|(
name|unsigned
name|long
operator|)
name|seq_len
argument_list|,
operator|(
name|unsigned
name|long
operator|)
name|key_len
argument_list|)
expr_stmt|;
name|wpa_hexdump_key
argument_list|(
name|MSG_MSGDUMP
argument_list|,
literal|"RALINK: OID_802_11_ADD_KEY"
argument_list|,
operator|(
specifier|const
name|u8
operator|*
operator|)
name|nkey
argument_list|,
name|len
argument_list|)
expr_stmt|;
name|res
operator|=
name|ralink_set_oid
argument_list|(
name|drv
argument_list|,
name|OID_802_11_ADD_KEY
argument_list|,
operator|(
name|char
operator|*
operator|)
name|nkey
argument_list|,
name|len
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|nkey
argument_list|)
expr_stmt|;
return|return
name|res
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|wpa_driver_ralink_disassociate
parameter_list|(
name|void
modifier|*
name|priv
parameter_list|,
specifier|const
name|u8
modifier|*
name|addr
parameter_list|,
name|int
name|reason_code
parameter_list|)
block|{
name|struct
name|wpa_driver_ralink_data
modifier|*
name|drv
init|=
name|priv
decl_stmt|;
if|if
condition|(
name|drv
operator|->
name|g_driver_down
operator|==
literal|1
condition|)
return|return
operator|-
literal|1
return|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"%s"
argument_list|,
name|__FUNCTION__
argument_list|)
expr_stmt|;
if|if
condition|(
name|ralink_set_oid
argument_list|(
name|drv
argument_list|,
name|OID_802_11_DISASSOCIATE
argument_list|,
literal|"    "
argument_list|,
literal|4
argument_list|)
operator|<
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"RALINK: Failed to set "
literal|"OID_802_11_DISASSOCIATE"
argument_list|)
expr_stmt|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|wpa_driver_ralink_deauthenticate
parameter_list|(
name|void
modifier|*
name|priv
parameter_list|,
specifier|const
name|u8
modifier|*
name|addr
parameter_list|,
name|int
name|reason_code
parameter_list|)
block|{
name|struct
name|wpa_driver_ralink_data
modifier|*
name|drv
init|=
name|priv
decl_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"g_driver_down = %d"
argument_list|,
name|drv
operator|->
name|g_driver_down
argument_list|)
expr_stmt|;
if|if
condition|(
name|drv
operator|->
name|g_driver_down
operator|==
literal|1
condition|)
return|return
operator|-
literal|1
return|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"%s"
argument_list|,
name|__FUNCTION__
argument_list|)
expr_stmt|;
if|if
condition|(
name|ralink_get_new_driver_flag
argument_list|(
name|drv
argument_list|)
operator|==
literal|0
condition|)
block|{
return|return
name|wpa_driver_ralink_disassociate
argument_list|(
name|priv
argument_list|,
name|addr
argument_list|,
name|reason_code
argument_list|)
return|;
block|}
else|else
block|{
name|MLME_DEAUTH_REQ_STRUCT
name|mlme
decl_stmt|;
name|os_memset
argument_list|(
operator|&
name|mlme
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|MLME_DEAUTH_REQ_STRUCT
argument_list|)
argument_list|)
expr_stmt|;
name|mlme
operator|.
name|Reason
operator|=
name|reason_code
expr_stmt|;
name|os_memcpy
argument_list|(
name|mlme
operator|.
name|Addr
argument_list|,
name|addr
argument_list|,
name|MAC_ADDR_LEN
argument_list|)
expr_stmt|;
return|return
name|ralink_set_oid
argument_list|(
name|drv
argument_list|,
name|OID_802_11_DEAUTHENTICATION
argument_list|,
operator|(
name|char
operator|*
operator|)
operator|&
name|mlme
argument_list|,
sizeof|sizeof
argument_list|(
name|MLME_DEAUTH_REQ_STRUCT
argument_list|)
argument_list|)
return|;
block|}
block|}
end_function

begin_function
specifier|static
name|int
name|wpa_driver_ralink_associate
parameter_list|(
name|void
modifier|*
name|priv
parameter_list|,
name|struct
name|wpa_driver_associate_params
modifier|*
name|params
parameter_list|)
block|{
name|struct
name|wpa_driver_ralink_data
modifier|*
name|drv
init|=
name|priv
decl_stmt|;
name|NDIS_802_11_NETWORK_INFRASTRUCTURE
name|mode
decl_stmt|;
name|NDIS_802_11_AUTHENTICATION_MODE
name|auth_mode
decl_stmt|;
name|NDIS_802_11_WEP_STATUS
name|encr
decl_stmt|;
name|BOOLEAN
name|ieee8021xMode
decl_stmt|;
if|if
condition|(
name|drv
operator|->
name|g_driver_down
operator|==
literal|1
condition|)
return|return
operator|-
literal|1
return|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"%s"
argument_list|,
name|__FUNCTION__
argument_list|)
expr_stmt|;
if|if
condition|(
name|params
operator|->
name|mode
operator|==
name|IEEE80211_MODE_IBSS
condition|)
name|mode
operator|=
name|Ndis802_11IBSS
expr_stmt|;
else|else
name|mode
operator|=
name|Ndis802_11Infrastructure
expr_stmt|;
if|if
condition|(
name|ralink_set_oid
argument_list|(
name|drv
argument_list|,
name|OID_802_11_INFRASTRUCTURE_MODE
argument_list|,
operator|(
name|char
operator|*
operator|)
operator|&
name|mode
argument_list|,
sizeof|sizeof
argument_list|(
name|mode
argument_list|)
argument_list|)
operator|<
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"RALINK: Failed to set "
literal|"OID_802_11_INFRASTRUCTURE_MODE (%d)"
argument_list|,
operator|(
name|int
operator|)
name|mode
argument_list|)
expr_stmt|;
comment|/* Try to continue anyway */
block|}
if|if
condition|(
name|params
operator|->
name|wpa_ie
operator|==
name|NULL
operator|||
name|params
operator|->
name|wpa_ie_len
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|params
operator|->
name|auth_alg
operator|&
name|AUTH_ALG_SHARED_KEY
condition|)
block|{
if|if
condition|(
name|params
operator|->
name|auth_alg
operator|&
name|AUTH_ALG_OPEN_SYSTEM
condition|)
name|auth_mode
operator|=
name|Ndis802_11AuthModeAutoSwitch
expr_stmt|;
else|else
name|auth_mode
operator|=
name|Ndis802_11AuthModeShared
expr_stmt|;
block|}
else|else
name|auth_mode
operator|=
name|Ndis802_11AuthModeOpen
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|params
operator|->
name|wpa_ie
index|[
literal|0
index|]
operator|==
name|WLAN_EID_RSN
condition|)
block|{
if|if
condition|(
name|params
operator|->
name|key_mgmt_suite
operator|==
name|KEY_MGMT_PSK
condition|)
name|auth_mode
operator|=
name|Ndis802_11AuthModeWPA2PSK
expr_stmt|;
else|else
name|auth_mode
operator|=
name|Ndis802_11AuthModeWPA2
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|params
operator|->
name|key_mgmt_suite
operator|==
name|KEY_MGMT_WPA_NONE
condition|)
name|auth_mode
operator|=
name|Ndis802_11AuthModeWPANone
expr_stmt|;
elseif|else
if|if
condition|(
name|params
operator|->
name|key_mgmt_suite
operator|==
name|KEY_MGMT_PSK
condition|)
name|auth_mode
operator|=
name|Ndis802_11AuthModeWPAPSK
expr_stmt|;
else|else
name|auth_mode
operator|=
name|Ndis802_11AuthModeWPA
expr_stmt|;
block|}
switch|switch
condition|(
name|params
operator|->
name|pairwise_suite
condition|)
block|{
case|case
name|CIPHER_CCMP
case|:
name|encr
operator|=
name|Ndis802_11Encryption3Enabled
expr_stmt|;
break|break;
case|case
name|CIPHER_TKIP
case|:
name|encr
operator|=
name|Ndis802_11Encryption2Enabled
expr_stmt|;
break|break;
case|case
name|CIPHER_WEP40
case|:
case|case
name|CIPHER_WEP104
case|:
name|encr
operator|=
name|Ndis802_11Encryption1Enabled
expr_stmt|;
break|break;
case|case
name|CIPHER_NONE
case|:
if|if
condition|(
name|params
operator|->
name|group_suite
operator|==
name|CIPHER_CCMP
condition|)
name|encr
operator|=
name|Ndis802_11Encryption3Enabled
expr_stmt|;
elseif|else
if|if
condition|(
name|params
operator|->
name|group_suite
operator|==
name|CIPHER_TKIP
condition|)
name|encr
operator|=
name|Ndis802_11Encryption2Enabled
expr_stmt|;
else|else
name|encr
operator|=
name|Ndis802_11EncryptionDisabled
expr_stmt|;
break|break;
default|default:
name|encr
operator|=
name|Ndis802_11EncryptionDisabled
expr_stmt|;
break|break;
block|}
name|ralink_set_auth_mode
argument_list|(
name|drv
argument_list|,
name|auth_mode
argument_list|)
expr_stmt|;
comment|/* notify driver that IEEE8021x mode is enabled */
if|if
condition|(
name|params
operator|->
name|key_mgmt_suite
operator|==
name|KEY_MGMT_802_1X_NO_WPA
condition|)
name|ieee8021xMode
operator|=
name|TRUE
expr_stmt|;
else|else
name|ieee8021xMode
operator|=
name|FALSE
expr_stmt|;
if|if
condition|(
name|ralink_set_oid
argument_list|(
name|drv
argument_list|,
name|OID_802_11_SET_IEEE8021X
argument_list|,
operator|(
name|char
operator|*
operator|)
operator|&
name|ieee8021xMode
argument_list|,
sizeof|sizeof
argument_list|(
name|BOOLEAN
argument_list|)
argument_list|)
operator|<
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"RALINK: Failed to set "
literal|"OID_802_11_SET_IEEE8021X(%d)"
argument_list|,
operator|(
name|int
operator|)
name|ieee8021xMode
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|ralink_set_oid
argument_list|(
name|drv
argument_list|,
name|OID_802_11_WEP_STATUS
argument_list|,
operator|(
name|char
operator|*
operator|)
operator|&
name|encr
argument_list|,
sizeof|sizeof
argument_list|(
name|encr
argument_list|)
argument_list|)
operator|<
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"RALINK: Failed to set "
literal|"OID_802_11_WEP_STATUS(%d)"
argument_list|,
operator|(
name|int
operator|)
name|encr
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|ieee8021xMode
operator|==
name|FALSE
operator|)
operator|&&
operator|(
name|encr
operator|==
name|Ndis802_11Encryption1Enabled
operator|)
condition|)
block|{
comment|/* static WEP */
name|int
name|enabled
init|=
literal|0
decl_stmt|;
if|if
condition|(
name|ralink_set_oid
argument_list|(
name|drv
argument_list|,
name|OID_802_11_DROP_UNENCRYPTED
argument_list|,
operator|(
name|char
operator|*
operator|)
operator|&
name|enabled
argument_list|,
sizeof|sizeof
argument_list|(
name|enabled
argument_list|)
argument_list|)
operator|<
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"RALINK: Failed to set "
literal|"OID_802_11_DROP_UNENCRYPTED(%d)"
argument_list|,
operator|(
name|int
operator|)
name|encr
argument_list|)
expr_stmt|;
block|}
block|}
return|return
name|wpa_driver_ralink_set_ssid
argument_list|(
name|drv
argument_list|,
name|params
operator|->
name|ssid
argument_list|,
name|params
operator|->
name|ssid_len
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|wpa_driver_ralink_set_countermeasures
parameter_list|(
name|void
modifier|*
name|priv
parameter_list|,
name|int
name|enabled
parameter_list|)
block|{
name|struct
name|wpa_driver_ralink_data
modifier|*
name|drv
init|=
name|priv
decl_stmt|;
if|if
condition|(
name|drv
operator|->
name|g_driver_down
operator|==
literal|1
condition|)
return|return
operator|-
literal|1
return|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"%s: enabled=%d"
argument_list|,
name|__FUNCTION__
argument_list|,
name|enabled
argument_list|)
expr_stmt|;
return|return
name|ralink_set_oid
argument_list|(
name|drv
argument_list|,
name|OID_SET_COUNTERMEASURES
argument_list|,
operator|(
name|char
operator|*
operator|)
operator|&
name|enabled
argument_list|,
sizeof|sizeof
argument_list|(
name|int
argument_list|)
argument_list|)
return|;
block|}
end_function

begin_decl_stmt
specifier|const
name|struct
name|wpa_driver_ops
name|wpa_driver_ralink_ops
init|=
block|{
operator|.
name|name
operator|=
literal|"ralink"
block|,
operator|.
name|desc
operator|=
literal|"Ralink Wireless Client driver"
block|,
operator|.
name|get_bssid
operator|=
name|wpa_driver_ralink_get_bssid
block|,
operator|.
name|get_ssid
operator|=
name|wpa_driver_ralink_get_ssid
block|,
operator|.
name|set_key
operator|=
name|wpa_driver_ralink_set_key
block|,
operator|.
name|init
operator|=
name|wpa_driver_ralink_init
block|,
operator|.
name|deinit
operator|=
name|wpa_driver_ralink_deinit
block|,
operator|.
name|set_countermeasures
operator|=
name|wpa_driver_ralink_set_countermeasures
block|,
operator|.
name|scan
operator|=
name|wpa_driver_ralink_scan
block|,
operator|.
name|get_scan_results
operator|=
name|wpa_driver_ralink_get_scan_results
block|,
operator|.
name|deauthenticate
operator|=
name|wpa_driver_ralink_deauthenticate
block|,
operator|.
name|disassociate
operator|=
name|wpa_driver_ralink_disassociate
block|,
operator|.
name|associate
operator|=
name|wpa_driver_ralink_associate
block|,
operator|.
name|add_pmkid
operator|=
name|wpa_driver_ralink_add_pmkid
block|,
operator|.
name|remove_pmkid
operator|=
name|wpa_driver_ralink_remove_pmkid
block|,
operator|.
name|flush_pmkid
operator|=
name|wpa_driver_ralink_flush_pmkid
block|, }
decl_stmt|;
end_decl_stmt

end_unit


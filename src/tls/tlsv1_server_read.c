begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * TLSv1 server - read handshake message  * Copyright (c) 2006-2014, Jouni Malinen<j@w1.fi>  *  * This software may be distributed under the terms of the BSD license.  * See README for more details.  */
end_comment

begin_include
include|#
directive|include
file|"includes.h"
end_include

begin_include
include|#
directive|include
file|"common.h"
end_include

begin_include
include|#
directive|include
file|"crypto/md5.h"
end_include

begin_include
include|#
directive|include
file|"crypto/sha1.h"
end_include

begin_include
include|#
directive|include
file|"crypto/sha256.h"
end_include

begin_include
include|#
directive|include
file|"crypto/tls.h"
end_include

begin_include
include|#
directive|include
file|"x509v3.h"
end_include

begin_include
include|#
directive|include
file|"tlsv1_common.h"
end_include

begin_include
include|#
directive|include
file|"tlsv1_record.h"
end_include

begin_include
include|#
directive|include
file|"tlsv1_server.h"
end_include

begin_include
include|#
directive|include
file|"tlsv1_server_i.h"
end_include

begin_function_decl
specifier|static
name|int
name|tls_process_client_key_exchange
parameter_list|(
name|struct
name|tlsv1_server
modifier|*
name|conn
parameter_list|,
name|u8
name|ct
parameter_list|,
specifier|const
name|u8
modifier|*
name|in_data
parameter_list|,
name|size_t
modifier|*
name|in_len
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|tls_process_change_cipher_spec
parameter_list|(
name|struct
name|tlsv1_server
modifier|*
name|conn
parameter_list|,
name|u8
name|ct
parameter_list|,
specifier|const
name|u8
modifier|*
name|in_data
parameter_list|,
name|size_t
modifier|*
name|in_len
parameter_list|)
function_decl|;
end_function_decl

begin_function
specifier|static
name|int
name|testing_cipher_suite_filter
parameter_list|(
name|struct
name|tlsv1_server
modifier|*
name|conn
parameter_list|,
name|u16
name|suite
parameter_list|)
block|{
ifdef|#
directive|ifdef
name|CONFIG_TESTING_OPTIONS
if|if
condition|(
operator|(
name|conn
operator|->
name|test_flags
operator|&
operator|(
name|TLS_BREAK_SRV_KEY_X_HASH
operator||
name|TLS_BREAK_SRV_KEY_X_SIGNATURE
operator||
name|TLS_DHE_PRIME_511B
operator||
name|TLS_DHE_PRIME_767B
operator||
name|TLS_DHE_PRIME_15
operator||
name|TLS_DHE_PRIME_58B
operator||
name|TLS_DHE_NON_PRIME
operator|)
operator|)
operator|&&
name|suite
operator|!=
name|TLS_DHE_RSA_WITH_AES_256_CBC_SHA256
operator|&&
name|suite
operator|!=
name|TLS_DHE_RSA_WITH_AES_256_CBC_SHA
operator|&&
name|suite
operator|!=
name|TLS_DHE_RSA_WITH_AES_128_CBC_SHA256
operator|&&
name|suite
operator|!=
name|TLS_DHE_RSA_WITH_AES_128_CBC_SHA
operator|&&
name|suite
operator|!=
name|TLS_DHE_RSA_WITH_3DES_EDE_CBC_SHA
condition|)
return|return
literal|1
return|;
endif|#
directive|endif
comment|/* CONFIG_TESTING_OPTIONS */
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|tls_process_client_hello
parameter_list|(
name|struct
name|tlsv1_server
modifier|*
name|conn
parameter_list|,
name|u8
name|ct
parameter_list|,
specifier|const
name|u8
modifier|*
name|in_data
parameter_list|,
name|size_t
modifier|*
name|in_len
parameter_list|)
block|{
specifier|const
name|u8
modifier|*
name|pos
decl_stmt|,
modifier|*
name|end
decl_stmt|,
modifier|*
name|c
decl_stmt|;
name|size_t
name|left
decl_stmt|,
name|len
decl_stmt|,
name|i
decl_stmt|,
name|j
decl_stmt|;
name|u16
name|cipher_suite
decl_stmt|;
name|u16
name|num_suites
decl_stmt|;
name|int
name|compr_null_found
decl_stmt|;
name|u16
name|ext_type
decl_stmt|,
name|ext_len
decl_stmt|;
if|if
condition|(
name|ct
operator|!=
name|TLS_CONTENT_TYPE_HANDSHAKE
condition|)
block|{
name|tlsv1_server_log
argument_list|(
name|conn
argument_list|,
literal|"Expected Handshake; received content type 0x%x"
argument_list|,
name|ct
argument_list|)
expr_stmt|;
name|tlsv1_server_alert
argument_list|(
name|conn
argument_list|,
name|TLS_ALERT_LEVEL_FATAL
argument_list|,
name|TLS_ALERT_UNEXPECTED_MESSAGE
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|pos
operator|=
name|in_data
expr_stmt|;
name|left
operator|=
operator|*
name|in_len
expr_stmt|;
if|if
condition|(
name|left
operator|<
literal|4
condition|)
goto|goto
name|decode_error
goto|;
comment|/* HandshakeType msg_type */
if|if
condition|(
operator|*
name|pos
operator|!=
name|TLS_HANDSHAKE_TYPE_CLIENT_HELLO
condition|)
block|{
name|tlsv1_server_log
argument_list|(
name|conn
argument_list|,
literal|"Received unexpected handshake message %d (expected ClientHello)"
argument_list|,
operator|*
name|pos
argument_list|)
expr_stmt|;
name|tlsv1_server_alert
argument_list|(
name|conn
argument_list|,
name|TLS_ALERT_LEVEL_FATAL
argument_list|,
name|TLS_ALERT_UNEXPECTED_MESSAGE
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|tlsv1_server_log
argument_list|(
name|conn
argument_list|,
literal|"Received ClientHello"
argument_list|)
expr_stmt|;
name|pos
operator|++
expr_stmt|;
comment|/* uint24 length */
name|len
operator|=
name|WPA_GET_BE24
argument_list|(
name|pos
argument_list|)
expr_stmt|;
name|pos
operator|+=
literal|3
expr_stmt|;
name|left
operator|-=
literal|4
expr_stmt|;
if|if
condition|(
name|len
operator|>
name|left
condition|)
goto|goto
name|decode_error
goto|;
comment|/* body - ClientHello */
name|wpa_hexdump
argument_list|(
name|MSG_MSGDUMP
argument_list|,
literal|"TLSv1: ClientHello"
argument_list|,
name|pos
argument_list|,
name|len
argument_list|)
expr_stmt|;
name|end
operator|=
name|pos
operator|+
name|len
expr_stmt|;
comment|/* ProtocolVersion client_version */
if|if
condition|(
name|end
operator|-
name|pos
operator|<
literal|2
condition|)
goto|goto
name|decode_error
goto|;
name|conn
operator|->
name|client_version
operator|=
name|WPA_GET_BE16
argument_list|(
name|pos
argument_list|)
expr_stmt|;
name|tlsv1_server_log
argument_list|(
name|conn
argument_list|,
literal|"Client version %d.%d"
argument_list|,
name|conn
operator|->
name|client_version
operator|>>
literal|8
argument_list|,
name|conn
operator|->
name|client_version
operator|&
literal|0xff
argument_list|)
expr_stmt|;
if|if
condition|(
name|conn
operator|->
name|client_version
operator|<
name|TLS_VERSION_1
condition|)
block|{
name|tlsv1_server_log
argument_list|(
name|conn
argument_list|,
literal|"Unexpected protocol version in ClientHello %u.%u"
argument_list|,
name|conn
operator|->
name|client_version
operator|>>
literal|8
argument_list|,
name|conn
operator|->
name|client_version
operator|&
literal|0xff
argument_list|)
expr_stmt|;
name|tlsv1_server_alert
argument_list|(
name|conn
argument_list|,
name|TLS_ALERT_LEVEL_FATAL
argument_list|,
name|TLS_ALERT_PROTOCOL_VERSION
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|pos
operator|+=
literal|2
expr_stmt|;
if|if
condition|(
name|TLS_VERSION
operator|==
name|TLS_VERSION_1
condition|)
name|conn
operator|->
name|rl
operator|.
name|tls_version
operator|=
name|TLS_VERSION_1
expr_stmt|;
ifdef|#
directive|ifdef
name|CONFIG_TLSV12
elseif|else
if|if
condition|(
name|conn
operator|->
name|client_version
operator|>=
name|TLS_VERSION_1_2
condition|)
name|conn
operator|->
name|rl
operator|.
name|tls_version
operator|=
name|TLS_VERSION_1_2
expr_stmt|;
endif|#
directive|endif
comment|/* CONFIG_TLSV12 */
elseif|else
if|if
condition|(
name|conn
operator|->
name|client_version
operator|>
name|TLS_VERSION_1_1
condition|)
name|conn
operator|->
name|rl
operator|.
name|tls_version
operator|=
name|TLS_VERSION_1_1
expr_stmt|;
else|else
name|conn
operator|->
name|rl
operator|.
name|tls_version
operator|=
name|conn
operator|->
name|client_version
expr_stmt|;
name|tlsv1_server_log
argument_list|(
name|conn
argument_list|,
literal|"Using TLS v%s"
argument_list|,
name|tls_version_str
argument_list|(
name|conn
operator|->
name|rl
operator|.
name|tls_version
argument_list|)
argument_list|)
expr_stmt|;
comment|/* Random random */
if|if
condition|(
name|end
operator|-
name|pos
operator|<
name|TLS_RANDOM_LEN
condition|)
goto|goto
name|decode_error
goto|;
name|os_memcpy
argument_list|(
name|conn
operator|->
name|client_random
argument_list|,
name|pos
argument_list|,
name|TLS_RANDOM_LEN
argument_list|)
expr_stmt|;
name|pos
operator|+=
name|TLS_RANDOM_LEN
expr_stmt|;
name|wpa_hexdump
argument_list|(
name|MSG_MSGDUMP
argument_list|,
literal|"TLSv1: client_random"
argument_list|,
name|conn
operator|->
name|client_random
argument_list|,
name|TLS_RANDOM_LEN
argument_list|)
expr_stmt|;
comment|/* SessionID session_id */
if|if
condition|(
name|end
operator|-
name|pos
operator|<
literal|1
condition|)
goto|goto
name|decode_error
goto|;
if|if
condition|(
name|end
operator|-
name|pos
operator|<
literal|1
operator|+
operator|*
name|pos
operator|||
operator|*
name|pos
operator|>
name|TLS_SESSION_ID_MAX_LEN
condition|)
goto|goto
name|decode_error
goto|;
name|wpa_hexdump
argument_list|(
name|MSG_MSGDUMP
argument_list|,
literal|"TLSv1: client session_id"
argument_list|,
name|pos
operator|+
literal|1
argument_list|,
operator|*
name|pos
argument_list|)
expr_stmt|;
name|pos
operator|+=
literal|1
operator|+
operator|*
name|pos
expr_stmt|;
comment|/* TODO: add support for session resumption */
comment|/* CipherSuite cipher_suites<2..2^16-1> */
if|if
condition|(
name|end
operator|-
name|pos
operator|<
literal|2
condition|)
goto|goto
name|decode_error
goto|;
name|num_suites
operator|=
name|WPA_GET_BE16
argument_list|(
name|pos
argument_list|)
expr_stmt|;
name|pos
operator|+=
literal|2
expr_stmt|;
if|if
condition|(
name|end
operator|-
name|pos
operator|<
name|num_suites
condition|)
goto|goto
name|decode_error
goto|;
name|wpa_hexdump
argument_list|(
name|MSG_MSGDUMP
argument_list|,
literal|"TLSv1: client cipher suites"
argument_list|,
name|pos
argument_list|,
name|num_suites
argument_list|)
expr_stmt|;
if|if
condition|(
name|num_suites
operator|&
literal|1
condition|)
goto|goto
name|decode_error
goto|;
name|num_suites
operator|/=
literal|2
expr_stmt|;
name|cipher_suite
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
operator|!
name|cipher_suite
operator|&&
name|i
operator|<
name|conn
operator|->
name|num_cipher_suites
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|testing_cipher_suite_filter
argument_list|(
name|conn
argument_list|,
name|conn
operator|->
name|cipher_suites
index|[
name|i
index|]
argument_list|)
condition|)
continue|continue;
name|c
operator|=
name|pos
expr_stmt|;
for|for
control|(
name|j
operator|=
literal|0
init|;
name|j
operator|<
name|num_suites
condition|;
name|j
operator|++
control|)
block|{
name|u16
name|tmp
init|=
name|WPA_GET_BE16
argument_list|(
name|c
argument_list|)
decl_stmt|;
name|c
operator|+=
literal|2
expr_stmt|;
if|if
condition|(
operator|!
name|cipher_suite
operator|&&
name|tmp
operator|==
name|conn
operator|->
name|cipher_suites
index|[
name|i
index|]
condition|)
block|{
name|cipher_suite
operator|=
name|tmp
expr_stmt|;
break|break;
block|}
block|}
block|}
name|pos
operator|+=
name|num_suites
operator|*
literal|2
expr_stmt|;
if|if
condition|(
operator|!
name|cipher_suite
condition|)
block|{
name|tlsv1_server_log
argument_list|(
name|conn
argument_list|,
literal|"No supported cipher suite available"
argument_list|)
expr_stmt|;
name|tlsv1_server_alert
argument_list|(
name|conn
argument_list|,
name|TLS_ALERT_LEVEL_FATAL
argument_list|,
name|TLS_ALERT_ILLEGAL_PARAMETER
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
if|if
condition|(
name|tlsv1_record_set_cipher_suite
argument_list|(
operator|&
name|conn
operator|->
name|rl
argument_list|,
name|cipher_suite
argument_list|)
operator|<
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"TLSv1: Failed to set CipherSuite for "
literal|"record layer"
argument_list|)
expr_stmt|;
name|tlsv1_server_alert
argument_list|(
name|conn
argument_list|,
name|TLS_ALERT_LEVEL_FATAL
argument_list|,
name|TLS_ALERT_INTERNAL_ERROR
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|conn
operator|->
name|cipher_suite
operator|=
name|cipher_suite
expr_stmt|;
comment|/* CompressionMethod compression_methods<1..2^8-1> */
if|if
condition|(
name|end
operator|-
name|pos
operator|<
literal|1
condition|)
goto|goto
name|decode_error
goto|;
name|num_suites
operator|=
operator|*
name|pos
operator|++
expr_stmt|;
if|if
condition|(
name|end
operator|-
name|pos
operator|<
name|num_suites
condition|)
goto|goto
name|decode_error
goto|;
name|wpa_hexdump
argument_list|(
name|MSG_MSGDUMP
argument_list|,
literal|"TLSv1: client compression_methods"
argument_list|,
name|pos
argument_list|,
name|num_suites
argument_list|)
expr_stmt|;
name|compr_null_found
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|num_suites
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
operator|*
name|pos
operator|++
operator|==
name|TLS_COMPRESSION_NULL
condition|)
name|compr_null_found
operator|=
literal|1
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|compr_null_found
condition|)
block|{
name|tlsv1_server_log
argument_list|(
name|conn
argument_list|,
literal|"Client does not accept NULL compression"
argument_list|)
expr_stmt|;
name|tlsv1_server_alert
argument_list|(
name|conn
argument_list|,
name|TLS_ALERT_LEVEL_FATAL
argument_list|,
name|TLS_ALERT_ILLEGAL_PARAMETER
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
if|if
condition|(
name|end
operator|-
name|pos
operator|==
literal|1
condition|)
block|{
name|tlsv1_server_log
argument_list|(
name|conn
argument_list|,
literal|"Unexpected extra octet in the end of ClientHello: 0x%02x"
argument_list|,
operator|*
name|pos
argument_list|)
expr_stmt|;
goto|goto
name|decode_error
goto|;
block|}
if|if
condition|(
name|end
operator|-
name|pos
operator|>=
literal|2
condition|)
block|{
comment|/* Extension client_hello_extension_list<0..2^16-1> */
name|ext_len
operator|=
name|WPA_GET_BE16
argument_list|(
name|pos
argument_list|)
expr_stmt|;
name|pos
operator|+=
literal|2
expr_stmt|;
name|tlsv1_server_log
argument_list|(
name|conn
argument_list|,
literal|"%u bytes of ClientHello extensions"
argument_list|,
name|ext_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|end
operator|-
name|pos
operator|!=
name|ext_len
condition|)
block|{
name|tlsv1_server_log
argument_list|(
name|conn
argument_list|,
literal|"Invalid ClientHello extension list length %u (expected %u)"
argument_list|,
name|ext_len
argument_list|,
call|(
name|unsigned
name|int
call|)
argument_list|(
name|end
operator|-
name|pos
argument_list|)
argument_list|)
expr_stmt|;
goto|goto
name|decode_error
goto|;
block|}
comment|/* 		 * struct { 		 *   ExtensionType extension_type (0..65535) 		 *   opaque extension_data<0..2^16-1> 		 * } Extension; 		 */
while|while
condition|(
name|pos
operator|<
name|end
condition|)
block|{
if|if
condition|(
name|end
operator|-
name|pos
operator|<
literal|2
condition|)
block|{
name|tlsv1_server_log
argument_list|(
name|conn
argument_list|,
literal|"Invalid extension_type field"
argument_list|)
expr_stmt|;
goto|goto
name|decode_error
goto|;
block|}
name|ext_type
operator|=
name|WPA_GET_BE16
argument_list|(
name|pos
argument_list|)
expr_stmt|;
name|pos
operator|+=
literal|2
expr_stmt|;
if|if
condition|(
name|end
operator|-
name|pos
operator|<
literal|2
condition|)
block|{
name|tlsv1_server_log
argument_list|(
name|conn
argument_list|,
literal|"Invalid extension_data length field"
argument_list|)
expr_stmt|;
goto|goto
name|decode_error
goto|;
block|}
name|ext_len
operator|=
name|WPA_GET_BE16
argument_list|(
name|pos
argument_list|)
expr_stmt|;
name|pos
operator|+=
literal|2
expr_stmt|;
if|if
condition|(
name|end
operator|-
name|pos
operator|<
name|ext_len
condition|)
block|{
name|tlsv1_server_log
argument_list|(
name|conn
argument_list|,
literal|"Invalid extension_data field"
argument_list|)
expr_stmt|;
goto|goto
name|decode_error
goto|;
block|}
name|tlsv1_server_log
argument_list|(
name|conn
argument_list|,
literal|"ClientHello Extension type %u"
argument_list|,
name|ext_type
argument_list|)
expr_stmt|;
name|wpa_hexdump
argument_list|(
name|MSG_MSGDUMP
argument_list|,
literal|"TLSv1: ClientHello "
literal|"Extension data"
argument_list|,
name|pos
argument_list|,
name|ext_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|ext_type
operator|==
name|TLS_EXT_SESSION_TICKET
condition|)
block|{
name|os_free
argument_list|(
name|conn
operator|->
name|session_ticket
argument_list|)
expr_stmt|;
name|conn
operator|->
name|session_ticket
operator|=
name|os_malloc
argument_list|(
name|ext_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|conn
operator|->
name|session_ticket
condition|)
block|{
name|os_memcpy
argument_list|(
name|conn
operator|->
name|session_ticket
argument_list|,
name|pos
argument_list|,
name|ext_len
argument_list|)
expr_stmt|;
name|conn
operator|->
name|session_ticket_len
operator|=
name|ext_len
expr_stmt|;
block|}
block|}
name|pos
operator|+=
name|ext_len
expr_stmt|;
block|}
block|}
operator|*
name|in_len
operator|=
name|end
operator|-
name|in_data
expr_stmt|;
name|tlsv1_server_log
argument_list|(
name|conn
argument_list|,
literal|"ClientHello OK - proceed to ServerHello"
argument_list|)
expr_stmt|;
name|conn
operator|->
name|state
operator|=
name|SERVER_HELLO
expr_stmt|;
return|return
literal|0
return|;
name|decode_error
label|:
name|tlsv1_server_log
argument_list|(
name|conn
argument_list|,
literal|"Failed to decode ClientHello"
argument_list|)
expr_stmt|;
name|tlsv1_server_alert
argument_list|(
name|conn
argument_list|,
name|TLS_ALERT_LEVEL_FATAL
argument_list|,
name|TLS_ALERT_DECODE_ERROR
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|tls_process_certificate
parameter_list|(
name|struct
name|tlsv1_server
modifier|*
name|conn
parameter_list|,
name|u8
name|ct
parameter_list|,
specifier|const
name|u8
modifier|*
name|in_data
parameter_list|,
name|size_t
modifier|*
name|in_len
parameter_list|)
block|{
specifier|const
name|u8
modifier|*
name|pos
decl_stmt|,
modifier|*
name|end
decl_stmt|;
name|size_t
name|left
decl_stmt|,
name|len
decl_stmt|,
name|list_len
decl_stmt|,
name|cert_len
decl_stmt|,
name|idx
decl_stmt|;
name|u8
name|type
decl_stmt|;
name|struct
name|x509_certificate
modifier|*
name|chain
init|=
name|NULL
decl_stmt|,
modifier|*
name|last
init|=
name|NULL
decl_stmt|,
modifier|*
name|cert
decl_stmt|;
name|int
name|reason
decl_stmt|;
if|if
condition|(
name|ct
operator|!=
name|TLS_CONTENT_TYPE_HANDSHAKE
condition|)
block|{
name|tlsv1_server_log
argument_list|(
name|conn
argument_list|,
literal|"Expected Handshake; received content type 0x%x"
argument_list|,
name|ct
argument_list|)
expr_stmt|;
name|tlsv1_server_alert
argument_list|(
name|conn
argument_list|,
name|TLS_ALERT_LEVEL_FATAL
argument_list|,
name|TLS_ALERT_UNEXPECTED_MESSAGE
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|pos
operator|=
name|in_data
expr_stmt|;
name|left
operator|=
operator|*
name|in_len
expr_stmt|;
if|if
condition|(
name|left
operator|<
literal|4
condition|)
block|{
name|tlsv1_server_log
argument_list|(
name|conn
argument_list|,
literal|"Too short Certificate message (len=%lu)"
argument_list|,
operator|(
name|unsigned
name|long
operator|)
name|left
argument_list|)
expr_stmt|;
name|tlsv1_server_alert
argument_list|(
name|conn
argument_list|,
name|TLS_ALERT_LEVEL_FATAL
argument_list|,
name|TLS_ALERT_DECODE_ERROR
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|type
operator|=
operator|*
name|pos
operator|++
expr_stmt|;
name|len
operator|=
name|WPA_GET_BE24
argument_list|(
name|pos
argument_list|)
expr_stmt|;
name|pos
operator|+=
literal|3
expr_stmt|;
name|left
operator|-=
literal|4
expr_stmt|;
if|if
condition|(
name|len
operator|>
name|left
condition|)
block|{
name|tlsv1_server_log
argument_list|(
name|conn
argument_list|,
literal|"Unexpected Certificate message length (len=%lu != left=%lu)"
argument_list|,
operator|(
name|unsigned
name|long
operator|)
name|len
argument_list|,
operator|(
name|unsigned
name|long
operator|)
name|left
argument_list|)
expr_stmt|;
name|tlsv1_server_alert
argument_list|(
name|conn
argument_list|,
name|TLS_ALERT_LEVEL_FATAL
argument_list|,
name|TLS_ALERT_DECODE_ERROR
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
if|if
condition|(
name|type
operator|==
name|TLS_HANDSHAKE_TYPE_CLIENT_KEY_EXCHANGE
condition|)
block|{
if|if
condition|(
name|conn
operator|->
name|verify_peer
condition|)
block|{
name|tlsv1_server_log
argument_list|(
name|conn
argument_list|,
literal|"Client did not include Certificate"
argument_list|)
expr_stmt|;
name|tlsv1_server_alert
argument_list|(
name|conn
argument_list|,
name|TLS_ALERT_LEVEL_FATAL
argument_list|,
name|TLS_ALERT_UNEXPECTED_MESSAGE
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
return|return
name|tls_process_client_key_exchange
argument_list|(
name|conn
argument_list|,
name|ct
argument_list|,
name|in_data
argument_list|,
name|in_len
argument_list|)
return|;
block|}
if|if
condition|(
name|type
operator|!=
name|TLS_HANDSHAKE_TYPE_CERTIFICATE
condition|)
block|{
name|tlsv1_server_log
argument_list|(
name|conn
argument_list|,
literal|"Received unexpected handshake message %d (expected Certificate/ClientKeyExchange)"
argument_list|,
name|type
argument_list|)
expr_stmt|;
name|tlsv1_server_alert
argument_list|(
name|conn
argument_list|,
name|TLS_ALERT_LEVEL_FATAL
argument_list|,
name|TLS_ALERT_UNEXPECTED_MESSAGE
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|tlsv1_server_log
argument_list|(
name|conn
argument_list|,
literal|"Received Certificate (certificate_list len %lu)"
argument_list|,
operator|(
name|unsigned
name|long
operator|)
name|len
argument_list|)
expr_stmt|;
comment|/* 	 * opaque ASN.1Cert<2^24-1>; 	 * 	 * struct { 	 *     ASN.1Cert certificate_list<1..2^24-1>; 	 * } Certificate; 	 */
name|end
operator|=
name|pos
operator|+
name|len
expr_stmt|;
if|if
condition|(
name|end
operator|-
name|pos
operator|<
literal|3
condition|)
block|{
name|tlsv1_server_log
argument_list|(
name|conn
argument_list|,
literal|"Too short Certificate (left=%lu)"
argument_list|,
operator|(
name|unsigned
name|long
operator|)
name|left
argument_list|)
expr_stmt|;
name|tlsv1_server_alert
argument_list|(
name|conn
argument_list|,
name|TLS_ALERT_LEVEL_FATAL
argument_list|,
name|TLS_ALERT_DECODE_ERROR
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|list_len
operator|=
name|WPA_GET_BE24
argument_list|(
name|pos
argument_list|)
expr_stmt|;
name|pos
operator|+=
literal|3
expr_stmt|;
if|if
condition|(
call|(
name|size_t
call|)
argument_list|(
name|end
operator|-
name|pos
argument_list|)
operator|!=
name|list_len
condition|)
block|{
name|tlsv1_server_log
argument_list|(
name|conn
argument_list|,
literal|"Unexpected certificate_list length (len=%lu left=%lu)"
argument_list|,
operator|(
name|unsigned
name|long
operator|)
name|list_len
argument_list|,
call|(
name|unsigned
name|long
call|)
argument_list|(
name|end
operator|-
name|pos
argument_list|)
argument_list|)
expr_stmt|;
name|tlsv1_server_alert
argument_list|(
name|conn
argument_list|,
name|TLS_ALERT_LEVEL_FATAL
argument_list|,
name|TLS_ALERT_DECODE_ERROR
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|idx
operator|=
literal|0
expr_stmt|;
while|while
condition|(
name|pos
operator|<
name|end
condition|)
block|{
if|if
condition|(
name|end
operator|-
name|pos
operator|<
literal|3
condition|)
block|{
name|tlsv1_server_log
argument_list|(
name|conn
argument_list|,
literal|"Failed to parse certificate_list"
argument_list|)
expr_stmt|;
name|tlsv1_server_alert
argument_list|(
name|conn
argument_list|,
name|TLS_ALERT_LEVEL_FATAL
argument_list|,
name|TLS_ALERT_DECODE_ERROR
argument_list|)
expr_stmt|;
name|x509_certificate_chain_free
argument_list|(
name|chain
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|cert_len
operator|=
name|WPA_GET_BE24
argument_list|(
name|pos
argument_list|)
expr_stmt|;
name|pos
operator|+=
literal|3
expr_stmt|;
if|if
condition|(
call|(
name|size_t
call|)
argument_list|(
name|end
operator|-
name|pos
argument_list|)
operator|<
name|cert_len
condition|)
block|{
name|tlsv1_server_log
argument_list|(
name|conn
argument_list|,
literal|"Unexpected certificate length (len=%lu left=%lu)"
argument_list|,
operator|(
name|unsigned
name|long
operator|)
name|cert_len
argument_list|,
call|(
name|unsigned
name|long
call|)
argument_list|(
name|end
operator|-
name|pos
argument_list|)
argument_list|)
expr_stmt|;
name|tlsv1_server_alert
argument_list|(
name|conn
argument_list|,
name|TLS_ALERT_LEVEL_FATAL
argument_list|,
name|TLS_ALERT_DECODE_ERROR
argument_list|)
expr_stmt|;
name|x509_certificate_chain_free
argument_list|(
name|chain
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|tlsv1_server_log
argument_list|(
name|conn
argument_list|,
literal|"Certificate %lu (len %lu)"
argument_list|,
operator|(
name|unsigned
name|long
operator|)
name|idx
argument_list|,
operator|(
name|unsigned
name|long
operator|)
name|cert_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|idx
operator|==
literal|0
condition|)
block|{
name|crypto_public_key_free
argument_list|(
name|conn
operator|->
name|client_rsa_key
argument_list|)
expr_stmt|;
if|if
condition|(
name|tls_parse_cert
argument_list|(
name|pos
argument_list|,
name|cert_len
argument_list|,
operator|&
name|conn
operator|->
name|client_rsa_key
argument_list|)
condition|)
block|{
name|tlsv1_server_log
argument_list|(
name|conn
argument_list|,
literal|"Failed to parse the certificate"
argument_list|)
expr_stmt|;
name|tlsv1_server_alert
argument_list|(
name|conn
argument_list|,
name|TLS_ALERT_LEVEL_FATAL
argument_list|,
name|TLS_ALERT_BAD_CERTIFICATE
argument_list|)
expr_stmt|;
name|x509_certificate_chain_free
argument_list|(
name|chain
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
block|}
name|cert
operator|=
name|x509_certificate_parse
argument_list|(
name|pos
argument_list|,
name|cert_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|cert
operator|==
name|NULL
condition|)
block|{
name|tlsv1_server_log
argument_list|(
name|conn
argument_list|,
literal|"Failed to parse the certificate"
argument_list|)
expr_stmt|;
name|tlsv1_server_alert
argument_list|(
name|conn
argument_list|,
name|TLS_ALERT_LEVEL_FATAL
argument_list|,
name|TLS_ALERT_BAD_CERTIFICATE
argument_list|)
expr_stmt|;
name|x509_certificate_chain_free
argument_list|(
name|chain
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
if|if
condition|(
name|last
operator|==
name|NULL
condition|)
name|chain
operator|=
name|cert
expr_stmt|;
else|else
name|last
operator|->
name|next
operator|=
name|cert
expr_stmt|;
name|last
operator|=
name|cert
expr_stmt|;
name|idx
operator|++
expr_stmt|;
name|pos
operator|+=
name|cert_len
expr_stmt|;
block|}
if|if
condition|(
name|x509_certificate_chain_validate
argument_list|(
name|conn
operator|->
name|cred
operator|->
name|trusted_certs
argument_list|,
name|chain
argument_list|,
operator|&
name|reason
argument_list|,
literal|0
argument_list|)
operator|<
literal|0
condition|)
block|{
name|int
name|tls_reason
decl_stmt|;
name|tlsv1_server_log
argument_list|(
name|conn
argument_list|,
literal|"Server certificate chain validation failed (reason=%d)"
argument_list|,
name|reason
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|reason
condition|)
block|{
case|case
name|X509_VALIDATE_BAD_CERTIFICATE
case|:
name|tls_reason
operator|=
name|TLS_ALERT_BAD_CERTIFICATE
expr_stmt|;
break|break;
case|case
name|X509_VALIDATE_UNSUPPORTED_CERTIFICATE
case|:
name|tls_reason
operator|=
name|TLS_ALERT_UNSUPPORTED_CERTIFICATE
expr_stmt|;
break|break;
case|case
name|X509_VALIDATE_CERTIFICATE_REVOKED
case|:
name|tls_reason
operator|=
name|TLS_ALERT_CERTIFICATE_REVOKED
expr_stmt|;
break|break;
case|case
name|X509_VALIDATE_CERTIFICATE_EXPIRED
case|:
name|tls_reason
operator|=
name|TLS_ALERT_CERTIFICATE_EXPIRED
expr_stmt|;
break|break;
case|case
name|X509_VALIDATE_CERTIFICATE_UNKNOWN
case|:
name|tls_reason
operator|=
name|TLS_ALERT_CERTIFICATE_UNKNOWN
expr_stmt|;
break|break;
case|case
name|X509_VALIDATE_UNKNOWN_CA
case|:
name|tls_reason
operator|=
name|TLS_ALERT_UNKNOWN_CA
expr_stmt|;
break|break;
default|default:
name|tls_reason
operator|=
name|TLS_ALERT_BAD_CERTIFICATE
expr_stmt|;
break|break;
block|}
name|tlsv1_server_alert
argument_list|(
name|conn
argument_list|,
name|TLS_ALERT_LEVEL_FATAL
argument_list|,
name|tls_reason
argument_list|)
expr_stmt|;
name|x509_certificate_chain_free
argument_list|(
name|chain
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|x509_certificate_chain_free
argument_list|(
name|chain
argument_list|)
expr_stmt|;
operator|*
name|in_len
operator|=
name|end
operator|-
name|in_data
expr_stmt|;
name|conn
operator|->
name|state
operator|=
name|CLIENT_KEY_EXCHANGE
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|tls_process_client_key_exchange_rsa
parameter_list|(
name|struct
name|tlsv1_server
modifier|*
name|conn
parameter_list|,
specifier|const
name|u8
modifier|*
name|pos
parameter_list|,
specifier|const
name|u8
modifier|*
name|end
parameter_list|)
block|{
name|u8
modifier|*
name|out
decl_stmt|;
name|size_t
name|outlen
decl_stmt|,
name|outbuflen
decl_stmt|;
name|u16
name|encr_len
decl_stmt|;
name|int
name|res
decl_stmt|;
name|int
name|use_random
init|=
literal|0
decl_stmt|;
if|if
condition|(
name|end
operator|-
name|pos
operator|<
literal|2
condition|)
block|{
name|tlsv1_server_alert
argument_list|(
name|conn
argument_list|,
name|TLS_ALERT_LEVEL_FATAL
argument_list|,
name|TLS_ALERT_DECODE_ERROR
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|encr_len
operator|=
name|WPA_GET_BE16
argument_list|(
name|pos
argument_list|)
expr_stmt|;
name|pos
operator|+=
literal|2
expr_stmt|;
if|if
condition|(
name|pos
operator|+
name|encr_len
operator|>
name|end
condition|)
block|{
name|tlsv1_server_log
argument_list|(
name|conn
argument_list|,
literal|"Invalid ClientKeyExchange format: encr_len=%u left=%u"
argument_list|,
name|encr_len
argument_list|,
call|(
name|unsigned
name|int
call|)
argument_list|(
name|end
operator|-
name|pos
argument_list|)
argument_list|)
expr_stmt|;
name|tlsv1_server_alert
argument_list|(
name|conn
argument_list|,
name|TLS_ALERT_LEVEL_FATAL
argument_list|,
name|TLS_ALERT_DECODE_ERROR
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|outbuflen
operator|=
name|outlen
operator|=
name|end
operator|-
name|pos
expr_stmt|;
name|out
operator|=
name|os_malloc
argument_list|(
name|outlen
operator|>=
name|TLS_PRE_MASTER_SECRET_LEN
condition|?
name|outlen
else|:
name|TLS_PRE_MASTER_SECRET_LEN
argument_list|)
expr_stmt|;
if|if
condition|(
name|out
operator|==
name|NULL
condition|)
block|{
name|tlsv1_server_alert
argument_list|(
name|conn
argument_list|,
name|TLS_ALERT_LEVEL_FATAL
argument_list|,
name|TLS_ALERT_INTERNAL_ERROR
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
comment|/* 	 * struct { 	 *   ProtocolVersion client_version; 	 *   opaque random[46]; 	 * } PreMasterSecret; 	 * 	 * struct { 	 *   public-key-encrypted PreMasterSecret pre_master_secret; 	 * } EncryptedPreMasterSecret; 	 */
comment|/* 	 * Note: To avoid Bleichenbacher attack, we do not report decryption or 	 * parsing errors from EncryptedPreMasterSecret processing to the 	 * client. Instead, a random pre-master secret is used to force the 	 * handshake to fail. 	 */
if|if
condition|(
name|crypto_private_key_decrypt_pkcs1_v15
argument_list|(
name|conn
operator|->
name|cred
operator|->
name|key
argument_list|,
name|pos
argument_list|,
name|encr_len
argument_list|,
name|out
argument_list|,
operator|&
name|outlen
argument_list|)
operator|<
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"TLSv1: Failed to decrypt "
literal|"PreMasterSecret (encr_len=%u outlen=%lu)"
argument_list|,
name|encr_len
argument_list|,
operator|(
name|unsigned
name|long
operator|)
name|outlen
argument_list|)
expr_stmt|;
name|use_random
operator|=
literal|1
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|use_random
operator|&&
name|outlen
operator|!=
name|TLS_PRE_MASTER_SECRET_LEN
condition|)
block|{
name|tlsv1_server_log
argument_list|(
name|conn
argument_list|,
literal|"Unexpected PreMasterSecret length %lu"
argument_list|,
operator|(
name|unsigned
name|long
operator|)
name|outlen
argument_list|)
expr_stmt|;
name|use_random
operator|=
literal|1
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|use_random
operator|&&
name|WPA_GET_BE16
argument_list|(
name|out
argument_list|)
operator|!=
name|conn
operator|->
name|client_version
condition|)
block|{
name|tlsv1_server_log
argument_list|(
name|conn
argument_list|,
literal|"Client version in ClientKeyExchange does not match with version in ClientHello"
argument_list|)
expr_stmt|;
name|use_random
operator|=
literal|1
expr_stmt|;
block|}
if|if
condition|(
name|use_random
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"TLSv1: Using random premaster secret "
literal|"to avoid revealing information about private key"
argument_list|)
expr_stmt|;
name|outlen
operator|=
name|TLS_PRE_MASTER_SECRET_LEN
expr_stmt|;
if|if
condition|(
name|os_get_random
argument_list|(
name|out
argument_list|,
name|outlen
argument_list|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"TLSv1: Failed to get random "
literal|"data"
argument_list|)
expr_stmt|;
name|tlsv1_server_alert
argument_list|(
name|conn
argument_list|,
name|TLS_ALERT_LEVEL_FATAL
argument_list|,
name|TLS_ALERT_INTERNAL_ERROR
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|out
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
block|}
name|res
operator|=
name|tlsv1_server_derive_keys
argument_list|(
name|conn
argument_list|,
name|out
argument_list|,
name|outlen
argument_list|)
expr_stmt|;
comment|/* Clear the pre-master secret since it is not needed anymore */
name|os_memset
argument_list|(
name|out
argument_list|,
literal|0
argument_list|,
name|outbuflen
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|out
argument_list|)
expr_stmt|;
if|if
condition|(
name|res
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"TLSv1: Failed to derive keys"
argument_list|)
expr_stmt|;
name|tlsv1_server_alert
argument_list|(
name|conn
argument_list|,
name|TLS_ALERT_LEVEL_FATAL
argument_list|,
name|TLS_ALERT_INTERNAL_ERROR
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|tls_process_client_key_exchange_dh
parameter_list|(
name|struct
name|tlsv1_server
modifier|*
name|conn
parameter_list|,
specifier|const
name|u8
modifier|*
name|pos
parameter_list|,
specifier|const
name|u8
modifier|*
name|end
parameter_list|)
block|{
specifier|const
name|u8
modifier|*
name|dh_yc
decl_stmt|;
name|u16
name|dh_yc_len
decl_stmt|;
name|u8
modifier|*
name|shared
decl_stmt|;
name|size_t
name|shared_len
decl_stmt|;
name|int
name|res
decl_stmt|;
specifier|const
name|u8
modifier|*
name|dh_p
decl_stmt|;
name|size_t
name|dh_p_len
decl_stmt|;
comment|/* 	 * struct { 	 *   select (PublicValueEncoding) { 	 *     case implicit: struct { }; 	 *     case explicit: opaque dh_Yc<1..2^16-1>; 	 *   } dh_public; 	 * } ClientDiffieHellmanPublic; 	 */
name|tlsv1_server_log
argument_list|(
name|conn
argument_list|,
literal|"ClientDiffieHellmanPublic received"
argument_list|)
expr_stmt|;
name|wpa_hexdump
argument_list|(
name|MSG_MSGDUMP
argument_list|,
literal|"TLSv1: ClientDiffieHellmanPublic"
argument_list|,
name|pos
argument_list|,
name|end
operator|-
name|pos
argument_list|)
expr_stmt|;
if|if
condition|(
name|end
operator|==
name|pos
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"TLSv1: Implicit public value encoding "
literal|"not supported"
argument_list|)
expr_stmt|;
name|tlsv1_server_alert
argument_list|(
name|conn
argument_list|,
name|TLS_ALERT_LEVEL_FATAL
argument_list|,
name|TLS_ALERT_INTERNAL_ERROR
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
if|if
condition|(
name|end
operator|-
name|pos
operator|<
literal|3
condition|)
block|{
name|tlsv1_server_log
argument_list|(
name|conn
argument_list|,
literal|"Invalid client public value length"
argument_list|)
expr_stmt|;
name|tlsv1_server_alert
argument_list|(
name|conn
argument_list|,
name|TLS_ALERT_LEVEL_FATAL
argument_list|,
name|TLS_ALERT_DECODE_ERROR
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|dh_yc_len
operator|=
name|WPA_GET_BE16
argument_list|(
name|pos
argument_list|)
expr_stmt|;
name|dh_yc
operator|=
name|pos
operator|+
literal|2
expr_stmt|;
if|if
condition|(
name|dh_yc_len
operator|>
name|end
operator|-
name|dh_yc
condition|)
block|{
name|tlsv1_server_log
argument_list|(
name|conn
argument_list|,
literal|"Client public value overflow (length %d)"
argument_list|,
name|dh_yc_len
argument_list|)
expr_stmt|;
name|tlsv1_server_alert
argument_list|(
name|conn
argument_list|,
name|TLS_ALERT_LEVEL_FATAL
argument_list|,
name|TLS_ALERT_DECODE_ERROR
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|wpa_hexdump
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"TLSv1: DH Yc (client's public value)"
argument_list|,
name|dh_yc
argument_list|,
name|dh_yc_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|conn
operator|->
name|cred
operator|==
name|NULL
operator|||
name|conn
operator|->
name|cred
operator|->
name|dh_p
operator|==
name|NULL
operator|||
name|conn
operator|->
name|dh_secret
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"TLSv1: No DH parameters available"
argument_list|)
expr_stmt|;
name|tlsv1_server_alert
argument_list|(
name|conn
argument_list|,
name|TLS_ALERT_LEVEL_FATAL
argument_list|,
name|TLS_ALERT_INTERNAL_ERROR
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|tlsv1_server_get_dh_p
argument_list|(
name|conn
argument_list|,
operator|&
name|dh_p
argument_list|,
operator|&
name|dh_p_len
argument_list|)
expr_stmt|;
name|shared_len
operator|=
name|dh_p_len
expr_stmt|;
name|shared
operator|=
name|os_malloc
argument_list|(
name|shared_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|shared
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"TLSv1: Could not allocate memory for "
literal|"DH"
argument_list|)
expr_stmt|;
name|tlsv1_server_alert
argument_list|(
name|conn
argument_list|,
name|TLS_ALERT_LEVEL_FATAL
argument_list|,
name|TLS_ALERT_INTERNAL_ERROR
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
comment|/* shared = Yc^secret mod p */
if|if
condition|(
name|crypto_mod_exp
argument_list|(
name|dh_yc
argument_list|,
name|dh_yc_len
argument_list|,
name|conn
operator|->
name|dh_secret
argument_list|,
name|conn
operator|->
name|dh_secret_len
argument_list|,
name|dh_p
argument_list|,
name|dh_p_len
argument_list|,
name|shared
argument_list|,
operator|&
name|shared_len
argument_list|)
condition|)
block|{
name|os_free
argument_list|(
name|shared
argument_list|)
expr_stmt|;
name|tlsv1_server_alert
argument_list|(
name|conn
argument_list|,
name|TLS_ALERT_LEVEL_FATAL
argument_list|,
name|TLS_ALERT_INTERNAL_ERROR
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|wpa_hexdump_key
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"TLSv1: Shared secret from DH key exchange"
argument_list|,
name|shared
argument_list|,
name|shared_len
argument_list|)
expr_stmt|;
name|os_memset
argument_list|(
name|conn
operator|->
name|dh_secret
argument_list|,
literal|0
argument_list|,
name|conn
operator|->
name|dh_secret_len
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|conn
operator|->
name|dh_secret
argument_list|)
expr_stmt|;
name|conn
operator|->
name|dh_secret
operator|=
name|NULL
expr_stmt|;
name|res
operator|=
name|tlsv1_server_derive_keys
argument_list|(
name|conn
argument_list|,
name|shared
argument_list|,
name|shared_len
argument_list|)
expr_stmt|;
comment|/* Clear the pre-master secret since it is not needed anymore */
name|os_memset
argument_list|(
name|shared
argument_list|,
literal|0
argument_list|,
name|shared_len
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|shared
argument_list|)
expr_stmt|;
if|if
condition|(
name|res
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"TLSv1: Failed to derive keys"
argument_list|)
expr_stmt|;
name|tlsv1_server_alert
argument_list|(
name|conn
argument_list|,
name|TLS_ALERT_LEVEL_FATAL
argument_list|,
name|TLS_ALERT_INTERNAL_ERROR
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|tls_process_client_key_exchange
parameter_list|(
name|struct
name|tlsv1_server
modifier|*
name|conn
parameter_list|,
name|u8
name|ct
parameter_list|,
specifier|const
name|u8
modifier|*
name|in_data
parameter_list|,
name|size_t
modifier|*
name|in_len
parameter_list|)
block|{
specifier|const
name|u8
modifier|*
name|pos
decl_stmt|,
modifier|*
name|end
decl_stmt|;
name|size_t
name|left
decl_stmt|,
name|len
decl_stmt|;
name|u8
name|type
decl_stmt|;
name|tls_key_exchange
name|keyx
decl_stmt|;
specifier|const
name|struct
name|tls_cipher_suite
modifier|*
name|suite
decl_stmt|;
if|if
condition|(
name|ct
operator|!=
name|TLS_CONTENT_TYPE_HANDSHAKE
condition|)
block|{
name|tlsv1_server_log
argument_list|(
name|conn
argument_list|,
literal|"Expected Handshake; received content type 0x%x"
argument_list|,
name|ct
argument_list|)
expr_stmt|;
name|tlsv1_server_alert
argument_list|(
name|conn
argument_list|,
name|TLS_ALERT_LEVEL_FATAL
argument_list|,
name|TLS_ALERT_UNEXPECTED_MESSAGE
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|pos
operator|=
name|in_data
expr_stmt|;
name|left
operator|=
operator|*
name|in_len
expr_stmt|;
if|if
condition|(
name|left
operator|<
literal|4
condition|)
block|{
name|tlsv1_server_log
argument_list|(
name|conn
argument_list|,
literal|"Too short ClientKeyExchange (Left=%lu)"
argument_list|,
operator|(
name|unsigned
name|long
operator|)
name|left
argument_list|)
expr_stmt|;
name|tlsv1_server_alert
argument_list|(
name|conn
argument_list|,
name|TLS_ALERT_LEVEL_FATAL
argument_list|,
name|TLS_ALERT_DECODE_ERROR
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|type
operator|=
operator|*
name|pos
operator|++
expr_stmt|;
name|len
operator|=
name|WPA_GET_BE24
argument_list|(
name|pos
argument_list|)
expr_stmt|;
name|pos
operator|+=
literal|3
expr_stmt|;
name|left
operator|-=
literal|4
expr_stmt|;
if|if
condition|(
name|len
operator|>
name|left
condition|)
block|{
name|tlsv1_server_log
argument_list|(
name|conn
argument_list|,
literal|"Mismatch in ClientKeyExchange length (len=%lu != left=%lu)"
argument_list|,
operator|(
name|unsigned
name|long
operator|)
name|len
argument_list|,
operator|(
name|unsigned
name|long
operator|)
name|left
argument_list|)
expr_stmt|;
name|tlsv1_server_alert
argument_list|(
name|conn
argument_list|,
name|TLS_ALERT_LEVEL_FATAL
argument_list|,
name|TLS_ALERT_DECODE_ERROR
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|end
operator|=
name|pos
operator|+
name|len
expr_stmt|;
if|if
condition|(
name|type
operator|!=
name|TLS_HANDSHAKE_TYPE_CLIENT_KEY_EXCHANGE
condition|)
block|{
name|tlsv1_server_log
argument_list|(
name|conn
argument_list|,
literal|"Received unexpected handshake message %d (expected ClientKeyExchange)"
argument_list|,
name|type
argument_list|)
expr_stmt|;
name|tlsv1_server_alert
argument_list|(
name|conn
argument_list|,
name|TLS_ALERT_LEVEL_FATAL
argument_list|,
name|TLS_ALERT_UNEXPECTED_MESSAGE
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|tlsv1_server_log
argument_list|(
name|conn
argument_list|,
literal|"Received ClientKeyExchange"
argument_list|)
expr_stmt|;
name|wpa_hexdump
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"TLSv1: ClientKeyExchange"
argument_list|,
name|pos
argument_list|,
name|len
argument_list|)
expr_stmt|;
name|suite
operator|=
name|tls_get_cipher_suite
argument_list|(
name|conn
operator|->
name|rl
operator|.
name|cipher_suite
argument_list|)
expr_stmt|;
if|if
condition|(
name|suite
operator|==
name|NULL
condition|)
name|keyx
operator|=
name|TLS_KEY_X_NULL
expr_stmt|;
else|else
name|keyx
operator|=
name|suite
operator|->
name|key_exchange
expr_stmt|;
if|if
condition|(
operator|(
name|keyx
operator|==
name|TLS_KEY_X_DH_anon
operator|||
name|keyx
operator|==
name|TLS_KEY_X_DHE_RSA
operator|)
operator|&&
name|tls_process_client_key_exchange_dh
argument_list|(
name|conn
argument_list|,
name|pos
argument_list|,
name|end
argument_list|)
operator|<
literal|0
condition|)
return|return
operator|-
literal|1
return|;
if|if
condition|(
name|keyx
operator|!=
name|TLS_KEY_X_DH_anon
operator|&&
name|keyx
operator|!=
name|TLS_KEY_X_DHE_RSA
operator|&&
name|tls_process_client_key_exchange_rsa
argument_list|(
name|conn
argument_list|,
name|pos
argument_list|,
name|end
argument_list|)
operator|<
literal|0
condition|)
return|return
operator|-
literal|1
return|;
operator|*
name|in_len
operator|=
name|end
operator|-
name|in_data
expr_stmt|;
name|conn
operator|->
name|state
operator|=
name|CERTIFICATE_VERIFY
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|tls_process_certificate_verify
parameter_list|(
name|struct
name|tlsv1_server
modifier|*
name|conn
parameter_list|,
name|u8
name|ct
parameter_list|,
specifier|const
name|u8
modifier|*
name|in_data
parameter_list|,
name|size_t
modifier|*
name|in_len
parameter_list|)
block|{
specifier|const
name|u8
modifier|*
name|pos
decl_stmt|,
modifier|*
name|end
decl_stmt|;
name|size_t
name|left
decl_stmt|,
name|len
decl_stmt|;
name|u8
name|type
decl_stmt|;
name|size_t
name|hlen
decl_stmt|;
name|u8
name|hash
index|[
name|MD5_MAC_LEN
operator|+
name|SHA1_MAC_LEN
index|]
decl_stmt|,
modifier|*
name|hpos
decl_stmt|;
name|u8
name|alert
decl_stmt|;
if|if
condition|(
name|ct
operator|==
name|TLS_CONTENT_TYPE_CHANGE_CIPHER_SPEC
condition|)
block|{
if|if
condition|(
name|conn
operator|->
name|verify_peer
condition|)
block|{
name|tlsv1_server_log
argument_list|(
name|conn
argument_list|,
literal|"Client did not include CertificateVerify"
argument_list|)
expr_stmt|;
name|tlsv1_server_alert
argument_list|(
name|conn
argument_list|,
name|TLS_ALERT_LEVEL_FATAL
argument_list|,
name|TLS_ALERT_UNEXPECTED_MESSAGE
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
return|return
name|tls_process_change_cipher_spec
argument_list|(
name|conn
argument_list|,
name|ct
argument_list|,
name|in_data
argument_list|,
name|in_len
argument_list|)
return|;
block|}
if|if
condition|(
name|ct
operator|!=
name|TLS_CONTENT_TYPE_HANDSHAKE
condition|)
block|{
name|tlsv1_server_log
argument_list|(
name|conn
argument_list|,
literal|"Expected Handshake; received content type 0x%x"
argument_list|,
name|ct
argument_list|)
expr_stmt|;
name|tlsv1_server_alert
argument_list|(
name|conn
argument_list|,
name|TLS_ALERT_LEVEL_FATAL
argument_list|,
name|TLS_ALERT_UNEXPECTED_MESSAGE
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|pos
operator|=
name|in_data
expr_stmt|;
name|left
operator|=
operator|*
name|in_len
expr_stmt|;
if|if
condition|(
name|left
operator|<
literal|4
condition|)
block|{
name|tlsv1_server_log
argument_list|(
name|conn
argument_list|,
literal|"Too short CertificateVerify message (len=%lu)"
argument_list|,
operator|(
name|unsigned
name|long
operator|)
name|left
argument_list|)
expr_stmt|;
name|tlsv1_server_alert
argument_list|(
name|conn
argument_list|,
name|TLS_ALERT_LEVEL_FATAL
argument_list|,
name|TLS_ALERT_DECODE_ERROR
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|type
operator|=
operator|*
name|pos
operator|++
expr_stmt|;
name|len
operator|=
name|WPA_GET_BE24
argument_list|(
name|pos
argument_list|)
expr_stmt|;
name|pos
operator|+=
literal|3
expr_stmt|;
name|left
operator|-=
literal|4
expr_stmt|;
if|if
condition|(
name|len
operator|>
name|left
condition|)
block|{
name|tlsv1_server_log
argument_list|(
name|conn
argument_list|,
literal|"Unexpected CertificateVerify message length (len=%lu != left=%lu)"
argument_list|,
operator|(
name|unsigned
name|long
operator|)
name|len
argument_list|,
operator|(
name|unsigned
name|long
operator|)
name|left
argument_list|)
expr_stmt|;
name|tlsv1_server_alert
argument_list|(
name|conn
argument_list|,
name|TLS_ALERT_LEVEL_FATAL
argument_list|,
name|TLS_ALERT_DECODE_ERROR
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|end
operator|=
name|pos
operator|+
name|len
expr_stmt|;
if|if
condition|(
name|type
operator|!=
name|TLS_HANDSHAKE_TYPE_CERTIFICATE_VERIFY
condition|)
block|{
name|tlsv1_server_log
argument_list|(
name|conn
argument_list|,
literal|"Received unexpected handshake message %d (expected CertificateVerify)"
argument_list|,
name|type
argument_list|)
expr_stmt|;
name|tlsv1_server_alert
argument_list|(
name|conn
argument_list|,
name|TLS_ALERT_LEVEL_FATAL
argument_list|,
name|TLS_ALERT_UNEXPECTED_MESSAGE
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|tlsv1_server_log
argument_list|(
name|conn
argument_list|,
literal|"Received CertificateVerify"
argument_list|)
expr_stmt|;
comment|/* 	 * struct { 	 *   Signature signature; 	 * } CertificateVerify; 	 */
name|hpos
operator|=
name|hash
expr_stmt|;
ifdef|#
directive|ifdef
name|CONFIG_TLSV12
if|if
condition|(
name|conn
operator|->
name|rl
operator|.
name|tls_version
operator|==
name|TLS_VERSION_1_2
condition|)
block|{
comment|/* 		 * RFC 5246, 4.7: 		 * TLS v1.2 adds explicit indication of the used signature and 		 * hash algorithms. 		 * 		 * struct { 		 *   HashAlgorithm hash; 		 *   SignatureAlgorithm signature; 		 * } SignatureAndHashAlgorithm; 		 */
if|if
condition|(
name|end
operator|-
name|pos
operator|<
literal|2
condition|)
block|{
name|tlsv1_server_alert
argument_list|(
name|conn
argument_list|,
name|TLS_ALERT_LEVEL_FATAL
argument_list|,
name|TLS_ALERT_DECODE_ERROR
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
if|if
condition|(
name|pos
index|[
literal|0
index|]
operator|!=
name|TLS_HASH_ALG_SHA256
operator|||
name|pos
index|[
literal|1
index|]
operator|!=
name|TLS_SIGN_ALG_RSA
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"TLSv1.2: Unsupported hash(%u)/"
literal|"signature(%u) algorithm"
argument_list|,
name|pos
index|[
literal|0
index|]
argument_list|,
name|pos
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
name|tlsv1_server_alert
argument_list|(
name|conn
argument_list|,
name|TLS_ALERT_LEVEL_FATAL
argument_list|,
name|TLS_ALERT_INTERNAL_ERROR
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|pos
operator|+=
literal|2
expr_stmt|;
name|hlen
operator|=
name|SHA256_MAC_LEN
expr_stmt|;
if|if
condition|(
name|conn
operator|->
name|verify
operator|.
name|sha256_cert
operator|==
name|NULL
operator|||
name|crypto_hash_finish
argument_list|(
name|conn
operator|->
name|verify
operator|.
name|sha256_cert
argument_list|,
name|hpos
argument_list|,
operator|&
name|hlen
argument_list|)
operator|<
literal|0
condition|)
block|{
name|conn
operator|->
name|verify
operator|.
name|sha256_cert
operator|=
name|NULL
expr_stmt|;
name|tlsv1_server_alert
argument_list|(
name|conn
argument_list|,
name|TLS_ALERT_LEVEL_FATAL
argument_list|,
name|TLS_ALERT_INTERNAL_ERROR
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|conn
operator|->
name|verify
operator|.
name|sha256_cert
operator|=
name|NULL
expr_stmt|;
block|}
else|else
block|{
endif|#
directive|endif
comment|/* CONFIG_TLSV12 */
name|hlen
operator|=
name|MD5_MAC_LEN
expr_stmt|;
if|if
condition|(
name|conn
operator|->
name|verify
operator|.
name|md5_cert
operator|==
name|NULL
operator|||
name|crypto_hash_finish
argument_list|(
name|conn
operator|->
name|verify
operator|.
name|md5_cert
argument_list|,
name|hpos
argument_list|,
operator|&
name|hlen
argument_list|)
operator|<
literal|0
condition|)
block|{
name|tlsv1_server_alert
argument_list|(
name|conn
argument_list|,
name|TLS_ALERT_LEVEL_FATAL
argument_list|,
name|TLS_ALERT_INTERNAL_ERROR
argument_list|)
expr_stmt|;
name|conn
operator|->
name|verify
operator|.
name|md5_cert
operator|=
name|NULL
expr_stmt|;
name|crypto_hash_finish
argument_list|(
name|conn
operator|->
name|verify
operator|.
name|sha1_cert
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|conn
operator|->
name|verify
operator|.
name|sha1_cert
operator|=
name|NULL
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|hpos
operator|+=
name|MD5_MAC_LEN
expr_stmt|;
name|conn
operator|->
name|verify
operator|.
name|md5_cert
operator|=
name|NULL
expr_stmt|;
name|hlen
operator|=
name|SHA1_MAC_LEN
expr_stmt|;
if|if
condition|(
name|conn
operator|->
name|verify
operator|.
name|sha1_cert
operator|==
name|NULL
operator|||
name|crypto_hash_finish
argument_list|(
name|conn
operator|->
name|verify
operator|.
name|sha1_cert
argument_list|,
name|hpos
argument_list|,
operator|&
name|hlen
argument_list|)
operator|<
literal|0
condition|)
block|{
name|conn
operator|->
name|verify
operator|.
name|sha1_cert
operator|=
name|NULL
expr_stmt|;
name|tlsv1_server_alert
argument_list|(
name|conn
argument_list|,
name|TLS_ALERT_LEVEL_FATAL
argument_list|,
name|TLS_ALERT_INTERNAL_ERROR
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|conn
operator|->
name|verify
operator|.
name|sha1_cert
operator|=
name|NULL
expr_stmt|;
name|hlen
operator|+=
name|MD5_MAC_LEN
expr_stmt|;
ifdef|#
directive|ifdef
name|CONFIG_TLSV12
block|}
endif|#
directive|endif
comment|/* CONFIG_TLSV12 */
name|wpa_hexdump
argument_list|(
name|MSG_MSGDUMP
argument_list|,
literal|"TLSv1: CertificateVerify hash"
argument_list|,
name|hash
argument_list|,
name|hlen
argument_list|)
expr_stmt|;
if|if
condition|(
name|tls_verify_signature
argument_list|(
name|conn
operator|->
name|rl
operator|.
name|tls_version
argument_list|,
name|conn
operator|->
name|client_rsa_key
argument_list|,
name|hash
argument_list|,
name|hlen
argument_list|,
name|pos
argument_list|,
name|end
operator|-
name|pos
argument_list|,
operator|&
name|alert
argument_list|)
operator|<
literal|0
condition|)
block|{
name|tlsv1_server_log
argument_list|(
name|conn
argument_list|,
literal|"Invalid Signature in CertificateVerify"
argument_list|)
expr_stmt|;
name|tlsv1_server_alert
argument_list|(
name|conn
argument_list|,
name|TLS_ALERT_LEVEL_FATAL
argument_list|,
name|alert
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
operator|*
name|in_len
operator|=
name|end
operator|-
name|in_data
expr_stmt|;
name|conn
operator|->
name|state
operator|=
name|CHANGE_CIPHER_SPEC
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|tls_process_change_cipher_spec
parameter_list|(
name|struct
name|tlsv1_server
modifier|*
name|conn
parameter_list|,
name|u8
name|ct
parameter_list|,
specifier|const
name|u8
modifier|*
name|in_data
parameter_list|,
name|size_t
modifier|*
name|in_len
parameter_list|)
block|{
specifier|const
name|u8
modifier|*
name|pos
decl_stmt|;
name|size_t
name|left
decl_stmt|;
if|if
condition|(
name|ct
operator|!=
name|TLS_CONTENT_TYPE_CHANGE_CIPHER_SPEC
condition|)
block|{
name|tlsv1_server_log
argument_list|(
name|conn
argument_list|,
literal|"Expected ChangeCipherSpec; received content type 0x%x"
argument_list|,
name|ct
argument_list|)
expr_stmt|;
name|tlsv1_server_alert
argument_list|(
name|conn
argument_list|,
name|TLS_ALERT_LEVEL_FATAL
argument_list|,
name|TLS_ALERT_UNEXPECTED_MESSAGE
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|pos
operator|=
name|in_data
expr_stmt|;
name|left
operator|=
operator|*
name|in_len
expr_stmt|;
if|if
condition|(
name|left
operator|<
literal|1
condition|)
block|{
name|tlsv1_server_log
argument_list|(
name|conn
argument_list|,
literal|"Too short ChangeCipherSpec"
argument_list|)
expr_stmt|;
name|tlsv1_server_alert
argument_list|(
name|conn
argument_list|,
name|TLS_ALERT_LEVEL_FATAL
argument_list|,
name|TLS_ALERT_DECODE_ERROR
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
if|if
condition|(
operator|*
name|pos
operator|!=
name|TLS_CHANGE_CIPHER_SPEC
condition|)
block|{
name|tlsv1_server_log
argument_list|(
name|conn
argument_list|,
literal|"Expected ChangeCipherSpec; received data 0x%x"
argument_list|,
operator|*
name|pos
argument_list|)
expr_stmt|;
name|tlsv1_server_alert
argument_list|(
name|conn
argument_list|,
name|TLS_ALERT_LEVEL_FATAL
argument_list|,
name|TLS_ALERT_UNEXPECTED_MESSAGE
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|tlsv1_server_log
argument_list|(
name|conn
argument_list|,
literal|"Received ChangeCipherSpec"
argument_list|)
expr_stmt|;
if|if
condition|(
name|tlsv1_record_change_read_cipher
argument_list|(
operator|&
name|conn
operator|->
name|rl
argument_list|)
operator|<
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"TLSv1: Failed to change read cipher "
literal|"for record layer"
argument_list|)
expr_stmt|;
name|tlsv1_server_alert
argument_list|(
name|conn
argument_list|,
name|TLS_ALERT_LEVEL_FATAL
argument_list|,
name|TLS_ALERT_INTERNAL_ERROR
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
operator|*
name|in_len
operator|=
name|pos
operator|+
literal|1
operator|-
name|in_data
expr_stmt|;
name|conn
operator|->
name|state
operator|=
name|CLIENT_FINISHED
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|tls_process_client_finished
parameter_list|(
name|struct
name|tlsv1_server
modifier|*
name|conn
parameter_list|,
name|u8
name|ct
parameter_list|,
specifier|const
name|u8
modifier|*
name|in_data
parameter_list|,
name|size_t
modifier|*
name|in_len
parameter_list|)
block|{
specifier|const
name|u8
modifier|*
name|pos
decl_stmt|,
modifier|*
name|end
decl_stmt|;
name|size_t
name|left
decl_stmt|,
name|len
decl_stmt|,
name|hlen
decl_stmt|;
name|u8
name|verify_data
index|[
name|TLS_VERIFY_DATA_LEN
index|]
decl_stmt|;
name|u8
name|hash
index|[
name|MD5_MAC_LEN
operator|+
name|SHA1_MAC_LEN
index|]
decl_stmt|;
ifdef|#
directive|ifdef
name|CONFIG_TESTING_OPTIONS
if|if
condition|(
operator|(
name|conn
operator|->
name|test_flags
operator|&
operator|(
name|TLS_BREAK_SRV_KEY_X_HASH
operator||
name|TLS_BREAK_SRV_KEY_X_SIGNATURE
operator|)
operator|)
operator|&&
operator|!
name|conn
operator|->
name|test_failure_reported
condition|)
block|{
name|tlsv1_server_log
argument_list|(
name|conn
argument_list|,
literal|"TEST-FAILURE: Client Finished received after invalid ServerKeyExchange"
argument_list|)
expr_stmt|;
name|conn
operator|->
name|test_failure_reported
operator|=
literal|1
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|conn
operator|->
name|test_flags
operator|&
name|TLS_DHE_PRIME_15
operator|)
operator|&&
operator|!
name|conn
operator|->
name|test_failure_reported
condition|)
block|{
name|tlsv1_server_log
argument_list|(
name|conn
argument_list|,
literal|"TEST-FAILURE: Client Finished received after bogus DHE \"prime\" 15"
argument_list|)
expr_stmt|;
name|conn
operator|->
name|test_failure_reported
operator|=
literal|1
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|conn
operator|->
name|test_flags
operator|&
name|TLS_DHE_PRIME_58B
operator|)
operator|&&
operator|!
name|conn
operator|->
name|test_failure_reported
condition|)
block|{
name|tlsv1_server_log
argument_list|(
name|conn
argument_list|,
literal|"TEST-FAILURE: Client Finished received after short 58-bit DHE prime in long container"
argument_list|)
expr_stmt|;
name|conn
operator|->
name|test_failure_reported
operator|=
literal|1
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|conn
operator|->
name|test_flags
operator|&
name|TLS_DHE_PRIME_511B
operator|)
operator|&&
operator|!
name|conn
operator|->
name|test_failure_reported
condition|)
block|{
name|tlsv1_server_log
argument_list|(
name|conn
argument_list|,
literal|"TEST-WARNING: Client Finished received after short 511-bit DHE prime (insecure)"
argument_list|)
expr_stmt|;
name|conn
operator|->
name|test_failure_reported
operator|=
literal|1
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|conn
operator|->
name|test_flags
operator|&
name|TLS_DHE_PRIME_767B
operator|)
operator|&&
operator|!
name|conn
operator|->
name|test_failure_reported
condition|)
block|{
name|tlsv1_server_log
argument_list|(
name|conn
argument_list|,
literal|"TEST-NOTE: Client Finished received after 767-bit DHE prime (relatively insecure)"
argument_list|)
expr_stmt|;
name|conn
operator|->
name|test_failure_reported
operator|=
literal|1
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|conn
operator|->
name|test_flags
operator|&
name|TLS_DHE_NON_PRIME
operator|)
operator|&&
operator|!
name|conn
operator|->
name|test_failure_reported
condition|)
block|{
name|tlsv1_server_log
argument_list|(
name|conn
argument_list|,
literal|"TEST-NOTE: Client Finished received after non-prime claimed as DHE prime"
argument_list|)
expr_stmt|;
name|conn
operator|->
name|test_failure_reported
operator|=
literal|1
expr_stmt|;
block|}
endif|#
directive|endif
comment|/* CONFIG_TESTING_OPTIONS */
if|if
condition|(
name|ct
operator|!=
name|TLS_CONTENT_TYPE_HANDSHAKE
condition|)
block|{
name|tlsv1_server_log
argument_list|(
name|conn
argument_list|,
literal|"Expected Finished; received content type 0x%x"
argument_list|,
name|ct
argument_list|)
expr_stmt|;
name|tlsv1_server_alert
argument_list|(
name|conn
argument_list|,
name|TLS_ALERT_LEVEL_FATAL
argument_list|,
name|TLS_ALERT_UNEXPECTED_MESSAGE
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|pos
operator|=
name|in_data
expr_stmt|;
name|left
operator|=
operator|*
name|in_len
expr_stmt|;
if|if
condition|(
name|left
operator|<
literal|4
condition|)
block|{
name|tlsv1_server_log
argument_list|(
name|conn
argument_list|,
literal|"Too short record (left=%lu) forFinished"
argument_list|,
operator|(
name|unsigned
name|long
operator|)
name|left
argument_list|)
expr_stmt|;
name|tlsv1_server_alert
argument_list|(
name|conn
argument_list|,
name|TLS_ALERT_LEVEL_FATAL
argument_list|,
name|TLS_ALERT_DECODE_ERROR
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
if|if
condition|(
name|pos
index|[
literal|0
index|]
operator|!=
name|TLS_HANDSHAKE_TYPE_FINISHED
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"TLSv1: Expected Finished; received "
literal|"type 0x%x"
argument_list|,
name|pos
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
name|tlsv1_server_alert
argument_list|(
name|conn
argument_list|,
name|TLS_ALERT_LEVEL_FATAL
argument_list|,
name|TLS_ALERT_UNEXPECTED_MESSAGE
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|len
operator|=
name|WPA_GET_BE24
argument_list|(
name|pos
operator|+
literal|1
argument_list|)
expr_stmt|;
name|pos
operator|+=
literal|4
expr_stmt|;
name|left
operator|-=
literal|4
expr_stmt|;
if|if
condition|(
name|len
operator|>
name|left
condition|)
block|{
name|tlsv1_server_log
argument_list|(
name|conn
argument_list|,
literal|"Too short buffer for Finished (len=%lu> left=%lu)"
argument_list|,
operator|(
name|unsigned
name|long
operator|)
name|len
argument_list|,
operator|(
name|unsigned
name|long
operator|)
name|left
argument_list|)
expr_stmt|;
name|tlsv1_server_alert
argument_list|(
name|conn
argument_list|,
name|TLS_ALERT_LEVEL_FATAL
argument_list|,
name|TLS_ALERT_DECODE_ERROR
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|end
operator|=
name|pos
operator|+
name|len
expr_stmt|;
if|if
condition|(
name|len
operator|!=
name|TLS_VERIFY_DATA_LEN
condition|)
block|{
name|tlsv1_server_log
argument_list|(
name|conn
argument_list|,
literal|"Unexpected verify_data length in Finished: %lu (expected %d)"
argument_list|,
operator|(
name|unsigned
name|long
operator|)
name|len
argument_list|,
name|TLS_VERIFY_DATA_LEN
argument_list|)
expr_stmt|;
name|tlsv1_server_alert
argument_list|(
name|conn
argument_list|,
name|TLS_ALERT_LEVEL_FATAL
argument_list|,
name|TLS_ALERT_DECODE_ERROR
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|wpa_hexdump
argument_list|(
name|MSG_MSGDUMP
argument_list|,
literal|"TLSv1: verify_data in Finished"
argument_list|,
name|pos
argument_list|,
name|TLS_VERIFY_DATA_LEN
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|CONFIG_TLSV12
if|if
condition|(
name|conn
operator|->
name|rl
operator|.
name|tls_version
operator|>=
name|TLS_VERSION_1_2
condition|)
block|{
name|hlen
operator|=
name|SHA256_MAC_LEN
expr_stmt|;
if|if
condition|(
name|conn
operator|->
name|verify
operator|.
name|sha256_client
operator|==
name|NULL
operator|||
name|crypto_hash_finish
argument_list|(
name|conn
operator|->
name|verify
operator|.
name|sha256_client
argument_list|,
name|hash
argument_list|,
operator|&
name|hlen
argument_list|)
operator|<
literal|0
condition|)
block|{
name|tlsv1_server_alert
argument_list|(
name|conn
argument_list|,
name|TLS_ALERT_LEVEL_FATAL
argument_list|,
name|TLS_ALERT_INTERNAL_ERROR
argument_list|)
expr_stmt|;
name|conn
operator|->
name|verify
operator|.
name|sha256_client
operator|=
name|NULL
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|conn
operator|->
name|verify
operator|.
name|sha256_client
operator|=
name|NULL
expr_stmt|;
block|}
else|else
block|{
endif|#
directive|endif
comment|/* CONFIG_TLSV12 */
name|hlen
operator|=
name|MD5_MAC_LEN
expr_stmt|;
if|if
condition|(
name|conn
operator|->
name|verify
operator|.
name|md5_client
operator|==
name|NULL
operator|||
name|crypto_hash_finish
argument_list|(
name|conn
operator|->
name|verify
operator|.
name|md5_client
argument_list|,
name|hash
argument_list|,
operator|&
name|hlen
argument_list|)
operator|<
literal|0
condition|)
block|{
name|tlsv1_server_alert
argument_list|(
name|conn
argument_list|,
name|TLS_ALERT_LEVEL_FATAL
argument_list|,
name|TLS_ALERT_INTERNAL_ERROR
argument_list|)
expr_stmt|;
name|conn
operator|->
name|verify
operator|.
name|md5_client
operator|=
name|NULL
expr_stmt|;
name|crypto_hash_finish
argument_list|(
name|conn
operator|->
name|verify
operator|.
name|sha1_client
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|conn
operator|->
name|verify
operator|.
name|sha1_client
operator|=
name|NULL
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|conn
operator|->
name|verify
operator|.
name|md5_client
operator|=
name|NULL
expr_stmt|;
name|hlen
operator|=
name|SHA1_MAC_LEN
expr_stmt|;
if|if
condition|(
name|conn
operator|->
name|verify
operator|.
name|sha1_client
operator|==
name|NULL
operator|||
name|crypto_hash_finish
argument_list|(
name|conn
operator|->
name|verify
operator|.
name|sha1_client
argument_list|,
name|hash
operator|+
name|MD5_MAC_LEN
argument_list|,
operator|&
name|hlen
argument_list|)
operator|<
literal|0
condition|)
block|{
name|conn
operator|->
name|verify
operator|.
name|sha1_client
operator|=
name|NULL
expr_stmt|;
name|tlsv1_server_alert
argument_list|(
name|conn
argument_list|,
name|TLS_ALERT_LEVEL_FATAL
argument_list|,
name|TLS_ALERT_INTERNAL_ERROR
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|conn
operator|->
name|verify
operator|.
name|sha1_client
operator|=
name|NULL
expr_stmt|;
name|hlen
operator|=
name|MD5_MAC_LEN
operator|+
name|SHA1_MAC_LEN
expr_stmt|;
ifdef|#
directive|ifdef
name|CONFIG_TLSV12
block|}
endif|#
directive|endif
comment|/* CONFIG_TLSV12 */
if|if
condition|(
name|tls_prf
argument_list|(
name|conn
operator|->
name|rl
operator|.
name|tls_version
argument_list|,
name|conn
operator|->
name|master_secret
argument_list|,
name|TLS_MASTER_SECRET_LEN
argument_list|,
literal|"client finished"
argument_list|,
name|hash
argument_list|,
name|hlen
argument_list|,
name|verify_data
argument_list|,
name|TLS_VERIFY_DATA_LEN
argument_list|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"TLSv1: Failed to derive verify_data"
argument_list|)
expr_stmt|;
name|tlsv1_server_alert
argument_list|(
name|conn
argument_list|,
name|TLS_ALERT_LEVEL_FATAL
argument_list|,
name|TLS_ALERT_DECRYPT_ERROR
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|wpa_hexdump_key
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"TLSv1: verify_data (client)"
argument_list|,
name|verify_data
argument_list|,
name|TLS_VERIFY_DATA_LEN
argument_list|)
expr_stmt|;
if|if
condition|(
name|os_memcmp_const
argument_list|(
name|pos
argument_list|,
name|verify_data
argument_list|,
name|TLS_VERIFY_DATA_LEN
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|tlsv1_server_log
argument_list|(
name|conn
argument_list|,
literal|"Mismatch in verify_data"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|tlsv1_server_log
argument_list|(
name|conn
argument_list|,
literal|"Received Finished"
argument_list|)
expr_stmt|;
operator|*
name|in_len
operator|=
name|end
operator|-
name|in_data
expr_stmt|;
if|if
condition|(
name|conn
operator|->
name|use_session_ticket
condition|)
block|{
comment|/* Abbreviated handshake using session ticket; RFC 4507 */
name|tlsv1_server_log
argument_list|(
name|conn
argument_list|,
literal|"Abbreviated handshake completed successfully"
argument_list|)
expr_stmt|;
name|conn
operator|->
name|state
operator|=
name|ESTABLISHED
expr_stmt|;
block|}
else|else
block|{
comment|/* Full handshake */
name|conn
operator|->
name|state
operator|=
name|SERVER_CHANGE_CIPHER_SPEC
expr_stmt|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
name|int
name|tlsv1_server_process_handshake
parameter_list|(
name|struct
name|tlsv1_server
modifier|*
name|conn
parameter_list|,
name|u8
name|ct
parameter_list|,
specifier|const
name|u8
modifier|*
name|buf
parameter_list|,
name|size_t
modifier|*
name|len
parameter_list|)
block|{
if|if
condition|(
name|ct
operator|==
name|TLS_CONTENT_TYPE_ALERT
condition|)
block|{
if|if
condition|(
operator|*
name|len
operator|<
literal|2
condition|)
block|{
name|tlsv1_server_log
argument_list|(
name|conn
argument_list|,
literal|"Alert underflow"
argument_list|)
expr_stmt|;
name|tlsv1_server_alert
argument_list|(
name|conn
argument_list|,
name|TLS_ALERT_LEVEL_FATAL
argument_list|,
name|TLS_ALERT_DECODE_ERROR
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|tlsv1_server_log
argument_list|(
name|conn
argument_list|,
literal|"Received alert %d:%d"
argument_list|,
name|buf
index|[
literal|0
index|]
argument_list|,
name|buf
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
operator|*
name|len
operator|=
literal|2
expr_stmt|;
name|conn
operator|->
name|state
operator|=
name|FAILED
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
switch|switch
condition|(
name|conn
operator|->
name|state
condition|)
block|{
case|case
name|CLIENT_HELLO
case|:
if|if
condition|(
name|tls_process_client_hello
argument_list|(
name|conn
argument_list|,
name|ct
argument_list|,
name|buf
argument_list|,
name|len
argument_list|)
condition|)
return|return
operator|-
literal|1
return|;
break|break;
case|case
name|CLIENT_CERTIFICATE
case|:
if|if
condition|(
name|tls_process_certificate
argument_list|(
name|conn
argument_list|,
name|ct
argument_list|,
name|buf
argument_list|,
name|len
argument_list|)
condition|)
return|return
operator|-
literal|1
return|;
break|break;
case|case
name|CLIENT_KEY_EXCHANGE
case|:
if|if
condition|(
name|tls_process_client_key_exchange
argument_list|(
name|conn
argument_list|,
name|ct
argument_list|,
name|buf
argument_list|,
name|len
argument_list|)
condition|)
return|return
operator|-
literal|1
return|;
break|break;
case|case
name|CERTIFICATE_VERIFY
case|:
if|if
condition|(
name|tls_process_certificate_verify
argument_list|(
name|conn
argument_list|,
name|ct
argument_list|,
name|buf
argument_list|,
name|len
argument_list|)
condition|)
return|return
operator|-
literal|1
return|;
break|break;
case|case
name|CHANGE_CIPHER_SPEC
case|:
if|if
condition|(
name|tls_process_change_cipher_spec
argument_list|(
name|conn
argument_list|,
name|ct
argument_list|,
name|buf
argument_list|,
name|len
argument_list|)
condition|)
return|return
operator|-
literal|1
return|;
break|break;
case|case
name|CLIENT_FINISHED
case|:
if|if
condition|(
name|tls_process_client_finished
argument_list|(
name|conn
argument_list|,
name|ct
argument_list|,
name|buf
argument_list|,
name|len
argument_list|)
condition|)
return|return
operator|-
literal|1
return|;
break|break;
default|default:
name|tlsv1_server_log
argument_list|(
name|conn
argument_list|,
literal|"Unexpected state %d while processing received message"
argument_list|,
name|conn
operator|->
name|state
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
if|if
condition|(
name|ct
operator|==
name|TLS_CONTENT_TYPE_HANDSHAKE
condition|)
name|tls_verify_hash_add
argument_list|(
operator|&
name|conn
operator|->
name|verify
argument_list|,
name|buf
argument_list|,
operator|*
name|len
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * RADIUS message processing  * Copyright (c) 2002-2009, Jouni Malinen<j@w1.fi>  *  * This program is free software; you can redistribute it and/or modify  * it under the terms of the GNU General Public License version 2 as  * published by the Free Software Foundation.  *  * Alternatively, this software may be distributed under the terms of BSD  * license.  *  * See README and COPYING for more details.  */
end_comment

begin_include
include|#
directive|include
file|"utils/includes.h"
end_include

begin_include
include|#
directive|include
file|"utils/common.h"
end_include

begin_include
include|#
directive|include
file|"utils/wpabuf.h"
end_include

begin_include
include|#
directive|include
file|"crypto/md5.h"
end_include

begin_include
include|#
directive|include
file|"crypto/crypto.h"
end_include

begin_include
include|#
directive|include
file|"radius.h"
end_include

begin_comment
comment|/**  * struct radius_msg - RADIUS message structure for new and parsed messages  */
end_comment

begin_struct
struct|struct
name|radius_msg
block|{
comment|/** 	 * buf - Allocated buffer for RADIUS message 	 */
name|struct
name|wpabuf
modifier|*
name|buf
decl_stmt|;
comment|/** 	 * hdr - Pointer to the RADIUS header in buf 	 */
name|struct
name|radius_hdr
modifier|*
name|hdr
decl_stmt|;
comment|/** 	 * attr_pos - Array of indexes to attributes 	 * 	 * The values are number of bytes from buf to the beginning of 	 * struct radius_attr_hdr. 	 */
name|size_t
modifier|*
name|attr_pos
decl_stmt|;
comment|/** 	 * attr_size - Total size of the attribute pointer array 	 */
name|size_t
name|attr_size
decl_stmt|;
comment|/** 	 * attr_used - Total number of attributes in the array 	 */
name|size_t
name|attr_used
decl_stmt|;
block|}
struct|;
end_struct

begin_function
name|struct
name|radius_hdr
modifier|*
name|radius_msg_get_hdr
parameter_list|(
name|struct
name|radius_msg
modifier|*
name|msg
parameter_list|)
block|{
return|return
name|msg
operator|->
name|hdr
return|;
block|}
end_function

begin_function
name|struct
name|wpabuf
modifier|*
name|radius_msg_get_buf
parameter_list|(
name|struct
name|radius_msg
modifier|*
name|msg
parameter_list|)
block|{
return|return
name|msg
operator|->
name|buf
return|;
block|}
end_function

begin_function
specifier|static
name|struct
name|radius_attr_hdr
modifier|*
name|radius_get_attr_hdr
parameter_list|(
name|struct
name|radius_msg
modifier|*
name|msg
parameter_list|,
name|int
name|idx
parameter_list|)
block|{
return|return
operator|(
expr|struct
name|radius_attr_hdr
operator|*
operator|)
operator|(
name|wpabuf_mhead_u8
argument_list|(
name|msg
operator|->
name|buf
argument_list|)
operator|+
name|msg
operator|->
name|attr_pos
index|[
name|idx
index|]
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|radius_msg_set_hdr
parameter_list|(
name|struct
name|radius_msg
modifier|*
name|msg
parameter_list|,
name|u8
name|code
parameter_list|,
name|u8
name|identifier
parameter_list|)
block|{
name|msg
operator|->
name|hdr
operator|->
name|code
operator|=
name|code
expr_stmt|;
name|msg
operator|->
name|hdr
operator|->
name|identifier
operator|=
name|identifier
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|radius_msg_initialize
parameter_list|(
name|struct
name|radius_msg
modifier|*
name|msg
parameter_list|)
block|{
name|msg
operator|->
name|attr_pos
operator|=
name|os_zalloc
argument_list|(
name|RADIUS_DEFAULT_ATTR_COUNT
operator|*
sizeof|sizeof
argument_list|(
operator|*
name|msg
operator|->
name|attr_pos
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|msg
operator|->
name|attr_pos
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
name|msg
operator|->
name|attr_size
operator|=
name|RADIUS_DEFAULT_ATTR_COUNT
expr_stmt|;
name|msg
operator|->
name|attr_used
operator|=
literal|0
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/**  * radius_msg_new - Create a new RADIUS message  * @code: Code for RADIUS header  * @identifier: Identifier for RADIUS header  * Returns: Context for RADIUS message or %NULL on failure  *  * The caller is responsible for freeing the returned data with  * radius_msg_free().  */
end_comment

begin_function
name|struct
name|radius_msg
modifier|*
name|radius_msg_new
parameter_list|(
name|u8
name|code
parameter_list|,
name|u8
name|identifier
parameter_list|)
block|{
name|struct
name|radius_msg
modifier|*
name|msg
decl_stmt|;
name|msg
operator|=
name|os_zalloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|msg
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|msg
operator|==
name|NULL
condition|)
return|return
name|NULL
return|;
name|msg
operator|->
name|buf
operator|=
name|wpabuf_alloc
argument_list|(
name|RADIUS_DEFAULT_MSG_SIZE
argument_list|)
expr_stmt|;
if|if
condition|(
name|msg
operator|->
name|buf
operator|==
name|NULL
operator|||
name|radius_msg_initialize
argument_list|(
name|msg
argument_list|)
condition|)
block|{
name|radius_msg_free
argument_list|(
name|msg
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|msg
operator|->
name|hdr
operator|=
name|wpabuf_put
argument_list|(
name|msg
operator|->
name|buf
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|radius_hdr
argument_list|)
argument_list|)
expr_stmt|;
name|radius_msg_set_hdr
argument_list|(
name|msg
argument_list|,
name|code
argument_list|,
name|identifier
argument_list|)
expr_stmt|;
return|return
name|msg
return|;
block|}
end_function

begin_comment
comment|/**  * radius_msg_free - Free a RADIUS message  * @msg: RADIUS message from radius_msg_new() or radius_msg_parse()  */
end_comment

begin_function
name|void
name|radius_msg_free
parameter_list|(
name|struct
name|radius_msg
modifier|*
name|msg
parameter_list|)
block|{
if|if
condition|(
name|msg
operator|==
name|NULL
condition|)
return|return;
name|wpabuf_free
argument_list|(
name|msg
operator|->
name|buf
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|msg
operator|->
name|attr_pos
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|msg
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
specifier|const
name|char
modifier|*
name|radius_code_string
parameter_list|(
name|u8
name|code
parameter_list|)
block|{
switch|switch
condition|(
name|code
condition|)
block|{
case|case
name|RADIUS_CODE_ACCESS_REQUEST
case|:
return|return
literal|"Access-Request"
return|;
case|case
name|RADIUS_CODE_ACCESS_ACCEPT
case|:
return|return
literal|"Access-Accept"
return|;
case|case
name|RADIUS_CODE_ACCESS_REJECT
case|:
return|return
literal|"Access-Reject"
return|;
case|case
name|RADIUS_CODE_ACCOUNTING_REQUEST
case|:
return|return
literal|"Accounting-Request"
return|;
case|case
name|RADIUS_CODE_ACCOUNTING_RESPONSE
case|:
return|return
literal|"Accounting-Response"
return|;
case|case
name|RADIUS_CODE_ACCESS_CHALLENGE
case|:
return|return
literal|"Access-Challenge"
return|;
case|case
name|RADIUS_CODE_STATUS_SERVER
case|:
return|return
literal|"Status-Server"
return|;
case|case
name|RADIUS_CODE_STATUS_CLIENT
case|:
return|return
literal|"Status-Client"
return|;
case|case
name|RADIUS_CODE_RESERVED
case|:
return|return
literal|"Reserved"
return|;
default|default:
return|return
literal|"?Unknown?"
return|;
block|}
block|}
end_function

begin_struct
struct|struct
name|radius_attr_type
block|{
name|u8
name|type
decl_stmt|;
name|char
modifier|*
name|name
decl_stmt|;
enum|enum
block|{
name|RADIUS_ATTR_UNDIST
block|,
name|RADIUS_ATTR_TEXT
block|,
name|RADIUS_ATTR_IP
block|,
name|RADIUS_ATTR_HEXDUMP
block|,
name|RADIUS_ATTR_INT32
block|,
name|RADIUS_ATTR_IPV6
block|}
name|data_type
enum|;
block|}
struct|;
end_struct

begin_decl_stmt
specifier|static
name|struct
name|radius_attr_type
name|radius_attrs
index|[]
init|=
block|{
block|{
name|RADIUS_ATTR_USER_NAME
block|,
literal|"User-Name"
block|,
name|RADIUS_ATTR_TEXT
block|}
block|,
block|{
name|RADIUS_ATTR_USER_PASSWORD
block|,
literal|"User-Password"
block|,
name|RADIUS_ATTR_UNDIST
block|}
block|,
block|{
name|RADIUS_ATTR_NAS_IP_ADDRESS
block|,
literal|"NAS-IP-Address"
block|,
name|RADIUS_ATTR_IP
block|}
block|,
block|{
name|RADIUS_ATTR_NAS_PORT
block|,
literal|"NAS-Port"
block|,
name|RADIUS_ATTR_INT32
block|}
block|,
block|{
name|RADIUS_ATTR_FRAMED_MTU
block|,
literal|"Framed-MTU"
block|,
name|RADIUS_ATTR_INT32
block|}
block|,
block|{
name|RADIUS_ATTR_REPLY_MESSAGE
block|,
literal|"Reply-Message"
block|,
name|RADIUS_ATTR_TEXT
block|}
block|,
block|{
name|RADIUS_ATTR_STATE
block|,
literal|"State"
block|,
name|RADIUS_ATTR_UNDIST
block|}
block|,
block|{
name|RADIUS_ATTR_CLASS
block|,
literal|"Class"
block|,
name|RADIUS_ATTR_UNDIST
block|}
block|,
block|{
name|RADIUS_ATTR_VENDOR_SPECIFIC
block|,
literal|"Vendor-Specific"
block|,
name|RADIUS_ATTR_UNDIST
block|}
block|,
block|{
name|RADIUS_ATTR_SESSION_TIMEOUT
block|,
literal|"Session-Timeout"
block|,
name|RADIUS_ATTR_INT32
block|}
block|,
block|{
name|RADIUS_ATTR_IDLE_TIMEOUT
block|,
literal|"Idle-Timeout"
block|,
name|RADIUS_ATTR_INT32
block|}
block|,
block|{
name|RADIUS_ATTR_TERMINATION_ACTION
block|,
literal|"Termination-Action"
block|,
name|RADIUS_ATTR_INT32
block|}
block|,
block|{
name|RADIUS_ATTR_CALLED_STATION_ID
block|,
literal|"Called-Station-Id"
block|,
name|RADIUS_ATTR_TEXT
block|}
block|,
block|{
name|RADIUS_ATTR_CALLING_STATION_ID
block|,
literal|"Calling-Station-Id"
block|,
name|RADIUS_ATTR_TEXT
block|}
block|,
block|{
name|RADIUS_ATTR_NAS_IDENTIFIER
block|,
literal|"NAS-Identifier"
block|,
name|RADIUS_ATTR_TEXT
block|}
block|,
block|{
name|RADIUS_ATTR_PROXY_STATE
block|,
literal|"Proxy-State"
block|,
name|RADIUS_ATTR_UNDIST
block|}
block|,
block|{
name|RADIUS_ATTR_ACCT_STATUS_TYPE
block|,
literal|"Acct-Status-Type"
block|,
name|RADIUS_ATTR_INT32
block|}
block|,
block|{
name|RADIUS_ATTR_ACCT_DELAY_TIME
block|,
literal|"Acct-Delay-Time"
block|,
name|RADIUS_ATTR_INT32
block|}
block|,
block|{
name|RADIUS_ATTR_ACCT_INPUT_OCTETS
block|,
literal|"Acct-Input-Octets"
block|,
name|RADIUS_ATTR_INT32
block|}
block|,
block|{
name|RADIUS_ATTR_ACCT_OUTPUT_OCTETS
block|,
literal|"Acct-Output-Octets"
block|,
name|RADIUS_ATTR_INT32
block|}
block|,
block|{
name|RADIUS_ATTR_ACCT_SESSION_ID
block|,
literal|"Acct-Session-Id"
block|,
name|RADIUS_ATTR_TEXT
block|}
block|,
block|{
name|RADIUS_ATTR_ACCT_AUTHENTIC
block|,
literal|"Acct-Authentic"
block|,
name|RADIUS_ATTR_INT32
block|}
block|,
block|{
name|RADIUS_ATTR_ACCT_SESSION_TIME
block|,
literal|"Acct-Session-Time"
block|,
name|RADIUS_ATTR_INT32
block|}
block|,
block|{
name|RADIUS_ATTR_ACCT_INPUT_PACKETS
block|,
literal|"Acct-Input-Packets"
block|,
name|RADIUS_ATTR_INT32
block|}
block|,
block|{
name|RADIUS_ATTR_ACCT_OUTPUT_PACKETS
block|,
literal|"Acct-Output-Packets"
block|,
name|RADIUS_ATTR_INT32
block|}
block|,
block|{
name|RADIUS_ATTR_ACCT_TERMINATE_CAUSE
block|,
literal|"Acct-Terminate-Cause"
block|,
name|RADIUS_ATTR_INT32
block|}
block|,
block|{
name|RADIUS_ATTR_ACCT_MULTI_SESSION_ID
block|,
literal|"Acct-Multi-Session-Id"
block|,
name|RADIUS_ATTR_TEXT
block|}
block|,
block|{
name|RADIUS_ATTR_ACCT_LINK_COUNT
block|,
literal|"Acct-Link-Count"
block|,
name|RADIUS_ATTR_INT32
block|}
block|,
block|{
name|RADIUS_ATTR_ACCT_INPUT_GIGAWORDS
block|,
literal|"Acct-Input-Gigawords"
block|,
name|RADIUS_ATTR_INT32
block|}
block|,
block|{
name|RADIUS_ATTR_ACCT_OUTPUT_GIGAWORDS
block|,
literal|"Acct-Output-Gigawords"
block|,
name|RADIUS_ATTR_INT32
block|}
block|,
block|{
name|RADIUS_ATTR_EVENT_TIMESTAMP
block|,
literal|"Event-Timestamp"
block|,
name|RADIUS_ATTR_INT32
block|}
block|,
block|{
name|RADIUS_ATTR_NAS_PORT_TYPE
block|,
literal|"NAS-Port-Type"
block|,
name|RADIUS_ATTR_INT32
block|}
block|,
block|{
name|RADIUS_ATTR_TUNNEL_TYPE
block|,
literal|"Tunnel-Type"
block|,
name|RADIUS_ATTR_HEXDUMP
block|}
block|,
block|{
name|RADIUS_ATTR_TUNNEL_MEDIUM_TYPE
block|,
literal|"Tunnel-Medium-Type"
block|,
name|RADIUS_ATTR_HEXDUMP
block|}
block|,
block|{
name|RADIUS_ATTR_CONNECT_INFO
block|,
literal|"Connect-Info"
block|,
name|RADIUS_ATTR_TEXT
block|}
block|,
block|{
name|RADIUS_ATTR_EAP_MESSAGE
block|,
literal|"EAP-Message"
block|,
name|RADIUS_ATTR_UNDIST
block|}
block|,
block|{
name|RADIUS_ATTR_MESSAGE_AUTHENTICATOR
block|,
literal|"Message-Authenticator"
block|,
name|RADIUS_ATTR_UNDIST
block|}
block|,
block|{
name|RADIUS_ATTR_TUNNEL_PRIVATE_GROUP_ID
block|,
literal|"Tunnel-Private-Group-Id"
block|,
name|RADIUS_ATTR_HEXDUMP
block|}
block|,
block|{
name|RADIUS_ATTR_ACCT_INTERIM_INTERVAL
block|,
literal|"Acct-Interim-Interval"
block|,
name|RADIUS_ATTR_INT32
block|}
block|,
block|{
name|RADIUS_ATTR_CHARGEABLE_USER_IDENTITY
block|,
literal|"Chargable-User-Identity"
block|,
name|RADIUS_ATTR_TEXT
block|}
block|,
block|{
name|RADIUS_ATTR_NAS_IPV6_ADDRESS
block|,
literal|"NAS-IPv6-Address"
block|,
name|RADIUS_ATTR_IPV6
block|}
block|, }
decl_stmt|;
end_decl_stmt

begin_define
define|#
directive|define
name|RADIUS_ATTRS
value|(sizeof(radius_attrs) / sizeof(radius_attrs[0]))
end_define

begin_function
specifier|static
name|struct
name|radius_attr_type
modifier|*
name|radius_get_attr_type
parameter_list|(
name|u8
name|type
parameter_list|)
block|{
name|size_t
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|RADIUS_ATTRS
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|type
operator|==
name|radius_attrs
index|[
name|i
index|]
operator|.
name|type
condition|)
return|return
operator|&
name|radius_attrs
index|[
name|i
index|]
return|;
block|}
return|return
name|NULL
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|print_char
parameter_list|(
name|char
name|c
parameter_list|)
block|{
if|if
condition|(
name|c
operator|>=
literal|32
operator|&&
name|c
operator|<
literal|127
condition|)
name|printf
argument_list|(
literal|"%c"
argument_list|,
name|c
argument_list|)
expr_stmt|;
else|else
name|printf
argument_list|(
literal|"<%02x>"
argument_list|,
name|c
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|radius_msg_dump_attr
parameter_list|(
name|struct
name|radius_attr_hdr
modifier|*
name|hdr
parameter_list|)
block|{
name|struct
name|radius_attr_type
modifier|*
name|attr
decl_stmt|;
name|int
name|i
decl_stmt|,
name|len
decl_stmt|;
name|unsigned
name|char
modifier|*
name|pos
decl_stmt|;
name|attr
operator|=
name|radius_get_attr_type
argument_list|(
name|hdr
operator|->
name|type
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"   Attribute %d (%s) length=%d\n"
argument_list|,
name|hdr
operator|->
name|type
argument_list|,
name|attr
condition|?
name|attr
operator|->
name|name
else|:
literal|"?Unknown?"
argument_list|,
name|hdr
operator|->
name|length
argument_list|)
expr_stmt|;
if|if
condition|(
name|attr
operator|==
name|NULL
condition|)
return|return;
name|len
operator|=
name|hdr
operator|->
name|length
operator|-
sizeof|sizeof
argument_list|(
expr|struct
name|radius_attr_hdr
argument_list|)
expr_stmt|;
name|pos
operator|=
operator|(
name|unsigned
name|char
operator|*
operator|)
operator|(
name|hdr
operator|+
literal|1
operator|)
expr_stmt|;
switch|switch
condition|(
name|attr
operator|->
name|data_type
condition|)
block|{
case|case
name|RADIUS_ATTR_TEXT
case|:
name|printf
argument_list|(
literal|"      Value: '"
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|len
condition|;
name|i
operator|++
control|)
name|print_char
argument_list|(
name|pos
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"'\n"
argument_list|)
expr_stmt|;
break|break;
case|case
name|RADIUS_ATTR_IP
case|:
if|if
condition|(
name|len
operator|==
literal|4
condition|)
block|{
name|struct
name|in_addr
name|addr
decl_stmt|;
name|os_memcpy
argument_list|(
operator|&
name|addr
argument_list|,
name|pos
argument_list|,
literal|4
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"      Value: %s\n"
argument_list|,
name|inet_ntoa
argument_list|(
name|addr
argument_list|)
argument_list|)
expr_stmt|;
block|}
else|else
name|printf
argument_list|(
literal|"      Invalid IP address length %d\n"
argument_list|,
name|len
argument_list|)
expr_stmt|;
break|break;
ifdef|#
directive|ifdef
name|CONFIG_IPV6
case|case
name|RADIUS_ATTR_IPV6
case|:
if|if
condition|(
name|len
operator|==
literal|16
condition|)
block|{
name|char
name|buf
index|[
literal|128
index|]
decl_stmt|;
specifier|const
name|char
modifier|*
name|atxt
decl_stmt|;
name|struct
name|in6_addr
modifier|*
name|addr
init|=
operator|(
expr|struct
name|in6_addr
operator|*
operator|)
name|pos
decl_stmt|;
name|atxt
operator|=
name|inet_ntop
argument_list|(
name|AF_INET6
argument_list|,
name|addr
argument_list|,
name|buf
argument_list|,
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"      Value: %s\n"
argument_list|,
name|atxt
condition|?
name|atxt
else|:
literal|"?"
argument_list|)
expr_stmt|;
block|}
else|else
name|printf
argument_list|(
literal|"      Invalid IPv6 address length %d\n"
argument_list|,
name|len
argument_list|)
expr_stmt|;
break|break;
endif|#
directive|endif
comment|/* CONFIG_IPV6 */
case|case
name|RADIUS_ATTR_HEXDUMP
case|:
case|case
name|RADIUS_ATTR_UNDIST
case|:
name|printf
argument_list|(
literal|"      Value:"
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|len
condition|;
name|i
operator|++
control|)
name|printf
argument_list|(
literal|" %02x"
argument_list|,
name|pos
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
break|break;
case|case
name|RADIUS_ATTR_INT32
case|:
if|if
condition|(
name|len
operator|==
literal|4
condition|)
name|printf
argument_list|(
literal|"      Value: %u\n"
argument_list|,
name|WPA_GET_BE32
argument_list|(
name|pos
argument_list|)
argument_list|)
expr_stmt|;
else|else
name|printf
argument_list|(
literal|"      Invalid INT32 length %d\n"
argument_list|,
name|len
argument_list|)
expr_stmt|;
break|break;
default|default:
break|break;
block|}
block|}
end_function

begin_function
name|void
name|radius_msg_dump
parameter_list|(
name|struct
name|radius_msg
modifier|*
name|msg
parameter_list|)
block|{
name|size_t
name|i
decl_stmt|;
name|printf
argument_list|(
literal|"RADIUS message: code=%d (%s) identifier=%d length=%d\n"
argument_list|,
name|msg
operator|->
name|hdr
operator|->
name|code
argument_list|,
name|radius_code_string
argument_list|(
name|msg
operator|->
name|hdr
operator|->
name|code
argument_list|)
argument_list|,
name|msg
operator|->
name|hdr
operator|->
name|identifier
argument_list|,
name|ntohs
argument_list|(
name|msg
operator|->
name|hdr
operator|->
name|length
argument_list|)
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|msg
operator|->
name|attr_used
condition|;
name|i
operator|++
control|)
block|{
name|struct
name|radius_attr_hdr
modifier|*
name|attr
init|=
name|radius_get_attr_hdr
argument_list|(
name|msg
argument_list|,
name|i
argument_list|)
decl_stmt|;
name|radius_msg_dump_attr
argument_list|(
name|attr
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
name|int
name|radius_msg_finish
parameter_list|(
name|struct
name|radius_msg
modifier|*
name|msg
parameter_list|,
specifier|const
name|u8
modifier|*
name|secret
parameter_list|,
name|size_t
name|secret_len
parameter_list|)
block|{
if|if
condition|(
name|secret
condition|)
block|{
name|u8
name|auth
index|[
name|MD5_MAC_LEN
index|]
decl_stmt|;
name|struct
name|radius_attr_hdr
modifier|*
name|attr
decl_stmt|;
name|os_memset
argument_list|(
name|auth
argument_list|,
literal|0
argument_list|,
name|MD5_MAC_LEN
argument_list|)
expr_stmt|;
name|attr
operator|=
name|radius_msg_add_attr
argument_list|(
name|msg
argument_list|,
name|RADIUS_ATTR_MESSAGE_AUTHENTICATOR
argument_list|,
name|auth
argument_list|,
name|MD5_MAC_LEN
argument_list|)
expr_stmt|;
if|if
condition|(
name|attr
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_WARNING
argument_list|,
literal|"RADIUS: Could not add "
literal|"Message-Authenticator"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|msg
operator|->
name|hdr
operator|->
name|length
operator|=
name|htons
argument_list|(
name|wpabuf_len
argument_list|(
name|msg
operator|->
name|buf
argument_list|)
argument_list|)
expr_stmt|;
name|hmac_md5
argument_list|(
name|secret
argument_list|,
name|secret_len
argument_list|,
name|wpabuf_head
argument_list|(
name|msg
operator|->
name|buf
argument_list|)
argument_list|,
name|wpabuf_len
argument_list|(
name|msg
operator|->
name|buf
argument_list|)
argument_list|,
operator|(
name|u8
operator|*
operator|)
operator|(
name|attr
operator|+
literal|1
operator|)
argument_list|)
expr_stmt|;
block|}
else|else
name|msg
operator|->
name|hdr
operator|->
name|length
operator|=
name|htons
argument_list|(
name|wpabuf_len
argument_list|(
name|msg
operator|->
name|buf
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|wpabuf_len
argument_list|(
name|msg
operator|->
name|buf
argument_list|)
operator|>
literal|0xffff
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_WARNING
argument_list|,
literal|"RADIUS: Too long message (%lu)"
argument_list|,
operator|(
name|unsigned
name|long
operator|)
name|wpabuf_len
argument_list|(
name|msg
operator|->
name|buf
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
name|int
name|radius_msg_finish_srv
parameter_list|(
name|struct
name|radius_msg
modifier|*
name|msg
parameter_list|,
specifier|const
name|u8
modifier|*
name|secret
parameter_list|,
name|size_t
name|secret_len
parameter_list|,
specifier|const
name|u8
modifier|*
name|req_authenticator
parameter_list|)
block|{
name|u8
name|auth
index|[
name|MD5_MAC_LEN
index|]
decl_stmt|;
name|struct
name|radius_attr_hdr
modifier|*
name|attr
decl_stmt|;
specifier|const
name|u8
modifier|*
name|addr
index|[
literal|4
index|]
decl_stmt|;
name|size_t
name|len
index|[
literal|4
index|]
decl_stmt|;
name|os_memset
argument_list|(
name|auth
argument_list|,
literal|0
argument_list|,
name|MD5_MAC_LEN
argument_list|)
expr_stmt|;
name|attr
operator|=
name|radius_msg_add_attr
argument_list|(
name|msg
argument_list|,
name|RADIUS_ATTR_MESSAGE_AUTHENTICATOR
argument_list|,
name|auth
argument_list|,
name|MD5_MAC_LEN
argument_list|)
expr_stmt|;
if|if
condition|(
name|attr
operator|==
name|NULL
condition|)
block|{
name|printf
argument_list|(
literal|"WARNING: Could not add Message-Authenticator\n"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|msg
operator|->
name|hdr
operator|->
name|length
operator|=
name|htons
argument_list|(
name|wpabuf_len
argument_list|(
name|msg
operator|->
name|buf
argument_list|)
argument_list|)
expr_stmt|;
name|os_memcpy
argument_list|(
name|msg
operator|->
name|hdr
operator|->
name|authenticator
argument_list|,
name|req_authenticator
argument_list|,
sizeof|sizeof
argument_list|(
name|msg
operator|->
name|hdr
operator|->
name|authenticator
argument_list|)
argument_list|)
expr_stmt|;
name|hmac_md5
argument_list|(
name|secret
argument_list|,
name|secret_len
argument_list|,
name|wpabuf_head
argument_list|(
name|msg
operator|->
name|buf
argument_list|)
argument_list|,
name|wpabuf_len
argument_list|(
name|msg
operator|->
name|buf
argument_list|)
argument_list|,
operator|(
name|u8
operator|*
operator|)
operator|(
name|attr
operator|+
literal|1
operator|)
argument_list|)
expr_stmt|;
comment|/* ResponseAuth = MD5(Code+ID+Length+RequestAuth+Attributes+Secret) */
name|addr
index|[
literal|0
index|]
operator|=
operator|(
name|u8
operator|*
operator|)
name|msg
operator|->
name|hdr
expr_stmt|;
name|len
index|[
literal|0
index|]
operator|=
literal|1
operator|+
literal|1
operator|+
literal|2
expr_stmt|;
name|addr
index|[
literal|1
index|]
operator|=
name|req_authenticator
expr_stmt|;
name|len
index|[
literal|1
index|]
operator|=
name|MD5_MAC_LEN
expr_stmt|;
name|addr
index|[
literal|2
index|]
operator|=
name|wpabuf_head_u8
argument_list|(
name|msg
operator|->
name|buf
argument_list|)
operator|+
sizeof|sizeof
argument_list|(
expr|struct
name|radius_hdr
argument_list|)
expr_stmt|;
name|len
index|[
literal|2
index|]
operator|=
name|wpabuf_len
argument_list|(
name|msg
operator|->
name|buf
argument_list|)
operator|-
sizeof|sizeof
argument_list|(
expr|struct
name|radius_hdr
argument_list|)
expr_stmt|;
name|addr
index|[
literal|3
index|]
operator|=
name|secret
expr_stmt|;
name|len
index|[
literal|3
index|]
operator|=
name|secret_len
expr_stmt|;
name|md5_vector
argument_list|(
literal|4
argument_list|,
name|addr
argument_list|,
name|len
argument_list|,
name|msg
operator|->
name|hdr
operator|->
name|authenticator
argument_list|)
expr_stmt|;
if|if
condition|(
name|wpabuf_len
argument_list|(
name|msg
operator|->
name|buf
argument_list|)
operator|>
literal|0xffff
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_WARNING
argument_list|,
literal|"RADIUS: Too long message (%lu)"
argument_list|,
operator|(
name|unsigned
name|long
operator|)
name|wpabuf_len
argument_list|(
name|msg
operator|->
name|buf
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
name|void
name|radius_msg_finish_acct
parameter_list|(
name|struct
name|radius_msg
modifier|*
name|msg
parameter_list|,
specifier|const
name|u8
modifier|*
name|secret
parameter_list|,
name|size_t
name|secret_len
parameter_list|)
block|{
specifier|const
name|u8
modifier|*
name|addr
index|[
literal|2
index|]
decl_stmt|;
name|size_t
name|len
index|[
literal|2
index|]
decl_stmt|;
name|msg
operator|->
name|hdr
operator|->
name|length
operator|=
name|htons
argument_list|(
name|wpabuf_len
argument_list|(
name|msg
operator|->
name|buf
argument_list|)
argument_list|)
expr_stmt|;
name|os_memset
argument_list|(
name|msg
operator|->
name|hdr
operator|->
name|authenticator
argument_list|,
literal|0
argument_list|,
name|MD5_MAC_LEN
argument_list|)
expr_stmt|;
name|addr
index|[
literal|0
index|]
operator|=
name|wpabuf_head
argument_list|(
name|msg
operator|->
name|buf
argument_list|)
expr_stmt|;
name|len
index|[
literal|0
index|]
operator|=
name|wpabuf_len
argument_list|(
name|msg
operator|->
name|buf
argument_list|)
expr_stmt|;
name|addr
index|[
literal|1
index|]
operator|=
name|secret
expr_stmt|;
name|len
index|[
literal|1
index|]
operator|=
name|secret_len
expr_stmt|;
name|md5_vector
argument_list|(
literal|2
argument_list|,
name|addr
argument_list|,
name|len
argument_list|,
name|msg
operator|->
name|hdr
operator|->
name|authenticator
argument_list|)
expr_stmt|;
if|if
condition|(
name|wpabuf_len
argument_list|(
name|msg
operator|->
name|buf
argument_list|)
operator|>
literal|0xffff
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_WARNING
argument_list|,
literal|"RADIUS: Too long messages (%lu)"
argument_list|,
operator|(
name|unsigned
name|long
operator|)
name|wpabuf_len
argument_list|(
name|msg
operator|->
name|buf
argument_list|)
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|int
name|radius_msg_add_attr_to_array
parameter_list|(
name|struct
name|radius_msg
modifier|*
name|msg
parameter_list|,
name|struct
name|radius_attr_hdr
modifier|*
name|attr
parameter_list|)
block|{
if|if
condition|(
name|msg
operator|->
name|attr_used
operator|>=
name|msg
operator|->
name|attr_size
condition|)
block|{
name|size_t
modifier|*
name|nattr_pos
decl_stmt|;
name|int
name|nlen
init|=
name|msg
operator|->
name|attr_size
operator|*
literal|2
decl_stmt|;
name|nattr_pos
operator|=
name|os_realloc
argument_list|(
name|msg
operator|->
name|attr_pos
argument_list|,
name|nlen
operator|*
sizeof|sizeof
argument_list|(
operator|*
name|msg
operator|->
name|attr_pos
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|nattr_pos
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
name|msg
operator|->
name|attr_pos
operator|=
name|nattr_pos
expr_stmt|;
name|msg
operator|->
name|attr_size
operator|=
name|nlen
expr_stmt|;
block|}
name|msg
operator|->
name|attr_pos
index|[
name|msg
operator|->
name|attr_used
operator|++
index|]
operator|=
operator|(
name|unsigned
name|char
operator|*
operator|)
name|attr
operator|-
name|wpabuf_head_u8
argument_list|(
name|msg
operator|->
name|buf
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|struct
name|radius_attr_hdr
modifier|*
name|radius_msg_add_attr
parameter_list|(
name|struct
name|radius_msg
modifier|*
name|msg
parameter_list|,
name|u8
name|type
parameter_list|,
specifier|const
name|u8
modifier|*
name|data
parameter_list|,
name|size_t
name|data_len
parameter_list|)
block|{
name|size_t
name|buf_needed
decl_stmt|;
name|struct
name|radius_attr_hdr
modifier|*
name|attr
decl_stmt|;
if|if
condition|(
name|data_len
operator|>
name|RADIUS_MAX_ATTR_LEN
condition|)
block|{
name|printf
argument_list|(
literal|"radius_msg_add_attr: too long attribute (%lu bytes)\n"
argument_list|,
operator|(
name|unsigned
name|long
operator|)
name|data_len
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|buf_needed
operator|=
sizeof|sizeof
argument_list|(
operator|*
name|attr
argument_list|)
operator|+
name|data_len
expr_stmt|;
if|if
condition|(
name|wpabuf_tailroom
argument_list|(
name|msg
operator|->
name|buf
argument_list|)
operator|<
name|buf_needed
condition|)
block|{
comment|/* allocate more space for message buffer */
if|if
condition|(
name|wpabuf_resize
argument_list|(
operator|&
name|msg
operator|->
name|buf
argument_list|,
name|buf_needed
argument_list|)
operator|<
literal|0
condition|)
return|return
name|NULL
return|;
name|msg
operator|->
name|hdr
operator|=
name|wpabuf_mhead
argument_list|(
name|msg
operator|->
name|buf
argument_list|)
expr_stmt|;
block|}
name|attr
operator|=
name|wpabuf_put
argument_list|(
name|msg
operator|->
name|buf
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|radius_attr_hdr
argument_list|)
argument_list|)
expr_stmt|;
name|attr
operator|->
name|type
operator|=
name|type
expr_stmt|;
name|attr
operator|->
name|length
operator|=
sizeof|sizeof
argument_list|(
operator|*
name|attr
argument_list|)
operator|+
name|data_len
expr_stmt|;
name|wpabuf_put_data
argument_list|(
name|msg
operator|->
name|buf
argument_list|,
name|data
argument_list|,
name|data_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|radius_msg_add_attr_to_array
argument_list|(
name|msg
argument_list|,
name|attr
argument_list|)
condition|)
return|return
name|NULL
return|;
return|return
name|attr
return|;
block|}
end_function

begin_comment
comment|/**  * radius_msg_parse - Parse a RADIUS message  * @data: RADIUS message to be parsed  * @len: Length of data buffer in octets  * Returns: Parsed RADIUS message or %NULL on failure  *  * This parses a RADIUS message and makes a copy of its data. The caller is  * responsible for freeing the returned data with radius_msg_free().  */
end_comment

begin_function
name|struct
name|radius_msg
modifier|*
name|radius_msg_parse
parameter_list|(
specifier|const
name|u8
modifier|*
name|data
parameter_list|,
name|size_t
name|len
parameter_list|)
block|{
name|struct
name|radius_msg
modifier|*
name|msg
decl_stmt|;
name|struct
name|radius_hdr
modifier|*
name|hdr
decl_stmt|;
name|struct
name|radius_attr_hdr
modifier|*
name|attr
decl_stmt|;
name|size_t
name|msg_len
decl_stmt|;
name|unsigned
name|char
modifier|*
name|pos
decl_stmt|,
modifier|*
name|end
decl_stmt|;
if|if
condition|(
name|data
operator|==
name|NULL
operator|||
name|len
operator|<
sizeof|sizeof
argument_list|(
operator|*
name|hdr
argument_list|)
condition|)
return|return
name|NULL
return|;
name|hdr
operator|=
operator|(
expr|struct
name|radius_hdr
operator|*
operator|)
name|data
expr_stmt|;
name|msg_len
operator|=
name|ntohs
argument_list|(
name|hdr
operator|->
name|length
argument_list|)
expr_stmt|;
if|if
condition|(
name|msg_len
operator|<
sizeof|sizeof
argument_list|(
operator|*
name|hdr
argument_list|)
operator|||
name|msg_len
operator|>
name|len
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"RADIUS: Invalid message length"
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
if|if
condition|(
name|msg_len
operator|<
name|len
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"RADIUS: Ignored %lu extra bytes after "
literal|"RADIUS message"
argument_list|,
operator|(
name|unsigned
name|long
operator|)
name|len
operator|-
name|msg_len
argument_list|)
expr_stmt|;
block|}
name|msg
operator|=
name|os_zalloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|msg
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|msg
operator|==
name|NULL
condition|)
return|return
name|NULL
return|;
name|msg
operator|->
name|buf
operator|=
name|wpabuf_alloc_copy
argument_list|(
name|data
argument_list|,
name|msg_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|msg
operator|->
name|buf
operator|==
name|NULL
operator|||
name|radius_msg_initialize
argument_list|(
name|msg
argument_list|)
condition|)
block|{
name|radius_msg_free
argument_list|(
name|msg
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|msg
operator|->
name|hdr
operator|=
name|wpabuf_mhead
argument_list|(
name|msg
operator|->
name|buf
argument_list|)
expr_stmt|;
comment|/* parse attributes */
name|pos
operator|=
name|wpabuf_mhead_u8
argument_list|(
name|msg
operator|->
name|buf
argument_list|)
operator|+
sizeof|sizeof
argument_list|(
expr|struct
name|radius_hdr
argument_list|)
expr_stmt|;
name|end
operator|=
name|wpabuf_mhead_u8
argument_list|(
name|msg
operator|->
name|buf
argument_list|)
operator|+
name|wpabuf_len
argument_list|(
name|msg
operator|->
name|buf
argument_list|)
expr_stmt|;
while|while
condition|(
name|pos
operator|<
name|end
condition|)
block|{
if|if
condition|(
call|(
name|size_t
call|)
argument_list|(
name|end
operator|-
name|pos
argument_list|)
operator|<
sizeof|sizeof
argument_list|(
operator|*
name|attr
argument_list|)
condition|)
goto|goto
name|fail
goto|;
name|attr
operator|=
operator|(
expr|struct
name|radius_attr_hdr
operator|*
operator|)
name|pos
expr_stmt|;
if|if
condition|(
name|pos
operator|+
name|attr
operator|->
name|length
operator|>
name|end
operator|||
name|attr
operator|->
name|length
operator|<
sizeof|sizeof
argument_list|(
operator|*
name|attr
argument_list|)
condition|)
goto|goto
name|fail
goto|;
comment|/* TODO: check that attr->length is suitable for attr->type */
if|if
condition|(
name|radius_msg_add_attr_to_array
argument_list|(
name|msg
argument_list|,
name|attr
argument_list|)
condition|)
goto|goto
name|fail
goto|;
name|pos
operator|+=
name|attr
operator|->
name|length
expr_stmt|;
block|}
return|return
name|msg
return|;
name|fail
label|:
name|radius_msg_free
argument_list|(
name|msg
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
end_function

begin_function
name|int
name|radius_msg_add_eap
parameter_list|(
name|struct
name|radius_msg
modifier|*
name|msg
parameter_list|,
specifier|const
name|u8
modifier|*
name|data
parameter_list|,
name|size_t
name|data_len
parameter_list|)
block|{
specifier|const
name|u8
modifier|*
name|pos
init|=
name|data
decl_stmt|;
name|size_t
name|left
init|=
name|data_len
decl_stmt|;
while|while
condition|(
name|left
operator|>
literal|0
condition|)
block|{
name|int
name|len
decl_stmt|;
if|if
condition|(
name|left
operator|>
name|RADIUS_MAX_ATTR_LEN
condition|)
name|len
operator|=
name|RADIUS_MAX_ATTR_LEN
expr_stmt|;
else|else
name|len
operator|=
name|left
expr_stmt|;
if|if
condition|(
operator|!
name|radius_msg_add_attr
argument_list|(
name|msg
argument_list|,
name|RADIUS_ATTR_EAP_MESSAGE
argument_list|,
name|pos
argument_list|,
name|len
argument_list|)
condition|)
return|return
literal|0
return|;
name|pos
operator|+=
name|len
expr_stmt|;
name|left
operator|-=
name|len
expr_stmt|;
block|}
return|return
literal|1
return|;
block|}
end_function

begin_function
name|u8
modifier|*
name|radius_msg_get_eap
parameter_list|(
name|struct
name|radius_msg
modifier|*
name|msg
parameter_list|,
name|size_t
modifier|*
name|eap_len
parameter_list|)
block|{
name|u8
modifier|*
name|eap
decl_stmt|,
modifier|*
name|pos
decl_stmt|;
name|size_t
name|len
decl_stmt|,
name|i
decl_stmt|;
name|struct
name|radius_attr_hdr
modifier|*
name|attr
decl_stmt|;
if|if
condition|(
name|msg
operator|==
name|NULL
condition|)
return|return
name|NULL
return|;
name|len
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|msg
operator|->
name|attr_used
condition|;
name|i
operator|++
control|)
block|{
name|attr
operator|=
name|radius_get_attr_hdr
argument_list|(
name|msg
argument_list|,
name|i
argument_list|)
expr_stmt|;
if|if
condition|(
name|attr
operator|->
name|type
operator|==
name|RADIUS_ATTR_EAP_MESSAGE
condition|)
name|len
operator|+=
name|attr
operator|->
name|length
operator|-
sizeof|sizeof
argument_list|(
expr|struct
name|radius_attr_hdr
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|len
operator|==
literal|0
condition|)
return|return
name|NULL
return|;
name|eap
operator|=
name|os_malloc
argument_list|(
name|len
argument_list|)
expr_stmt|;
if|if
condition|(
name|eap
operator|==
name|NULL
condition|)
return|return
name|NULL
return|;
name|pos
operator|=
name|eap
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|msg
operator|->
name|attr_used
condition|;
name|i
operator|++
control|)
block|{
name|attr
operator|=
name|radius_get_attr_hdr
argument_list|(
name|msg
argument_list|,
name|i
argument_list|)
expr_stmt|;
if|if
condition|(
name|attr
operator|->
name|type
operator|==
name|RADIUS_ATTR_EAP_MESSAGE
condition|)
block|{
name|int
name|flen
init|=
name|attr
operator|->
name|length
operator|-
sizeof|sizeof
argument_list|(
operator|*
name|attr
argument_list|)
decl_stmt|;
name|os_memcpy
argument_list|(
name|pos
argument_list|,
name|attr
operator|+
literal|1
argument_list|,
name|flen
argument_list|)
expr_stmt|;
name|pos
operator|+=
name|flen
expr_stmt|;
block|}
block|}
if|if
condition|(
name|eap_len
condition|)
operator|*
name|eap_len
operator|=
name|len
expr_stmt|;
return|return
name|eap
return|;
block|}
end_function

begin_function
name|int
name|radius_msg_verify_msg_auth
parameter_list|(
name|struct
name|radius_msg
modifier|*
name|msg
parameter_list|,
specifier|const
name|u8
modifier|*
name|secret
parameter_list|,
name|size_t
name|secret_len
parameter_list|,
specifier|const
name|u8
modifier|*
name|req_auth
parameter_list|)
block|{
name|u8
name|auth
index|[
name|MD5_MAC_LEN
index|]
decl_stmt|,
name|orig
index|[
name|MD5_MAC_LEN
index|]
decl_stmt|;
name|u8
name|orig_authenticator
index|[
literal|16
index|]
decl_stmt|;
name|struct
name|radius_attr_hdr
modifier|*
name|attr
init|=
name|NULL
decl_stmt|,
modifier|*
name|tmp
decl_stmt|;
name|size_t
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|msg
operator|->
name|attr_used
condition|;
name|i
operator|++
control|)
block|{
name|tmp
operator|=
name|radius_get_attr_hdr
argument_list|(
name|msg
argument_list|,
name|i
argument_list|)
expr_stmt|;
if|if
condition|(
name|tmp
operator|->
name|type
operator|==
name|RADIUS_ATTR_MESSAGE_AUTHENTICATOR
condition|)
block|{
if|if
condition|(
name|attr
operator|!=
name|NULL
condition|)
block|{
name|printf
argument_list|(
literal|"Multiple Message-Authenticator "
literal|"attributes in RADIUS message\n"
argument_list|)
expr_stmt|;
return|return
literal|1
return|;
block|}
name|attr
operator|=
name|tmp
expr_stmt|;
block|}
block|}
if|if
condition|(
name|attr
operator|==
name|NULL
condition|)
block|{
name|printf
argument_list|(
literal|"No Message-Authenticator attribute found\n"
argument_list|)
expr_stmt|;
return|return
literal|1
return|;
block|}
name|os_memcpy
argument_list|(
name|orig
argument_list|,
name|attr
operator|+
literal|1
argument_list|,
name|MD5_MAC_LEN
argument_list|)
expr_stmt|;
name|os_memset
argument_list|(
name|attr
operator|+
literal|1
argument_list|,
literal|0
argument_list|,
name|MD5_MAC_LEN
argument_list|)
expr_stmt|;
if|if
condition|(
name|req_auth
condition|)
block|{
name|os_memcpy
argument_list|(
name|orig_authenticator
argument_list|,
name|msg
operator|->
name|hdr
operator|->
name|authenticator
argument_list|,
sizeof|sizeof
argument_list|(
name|orig_authenticator
argument_list|)
argument_list|)
expr_stmt|;
name|os_memcpy
argument_list|(
name|msg
operator|->
name|hdr
operator|->
name|authenticator
argument_list|,
name|req_auth
argument_list|,
sizeof|sizeof
argument_list|(
name|msg
operator|->
name|hdr
operator|->
name|authenticator
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|hmac_md5
argument_list|(
name|secret
argument_list|,
name|secret_len
argument_list|,
name|wpabuf_head
argument_list|(
name|msg
operator|->
name|buf
argument_list|)
argument_list|,
name|wpabuf_len
argument_list|(
name|msg
operator|->
name|buf
argument_list|)
argument_list|,
name|auth
argument_list|)
expr_stmt|;
name|os_memcpy
argument_list|(
name|attr
operator|+
literal|1
argument_list|,
name|orig
argument_list|,
name|MD5_MAC_LEN
argument_list|)
expr_stmt|;
if|if
condition|(
name|req_auth
condition|)
block|{
name|os_memcpy
argument_list|(
name|msg
operator|->
name|hdr
operator|->
name|authenticator
argument_list|,
name|orig_authenticator
argument_list|,
sizeof|sizeof
argument_list|(
name|orig_authenticator
argument_list|)
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|os_memcmp
argument_list|(
name|orig
argument_list|,
name|auth
argument_list|,
name|MD5_MAC_LEN
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|printf
argument_list|(
literal|"Invalid Message-Authenticator!\n"
argument_list|)
expr_stmt|;
return|return
literal|1
return|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
name|int
name|radius_msg_verify
parameter_list|(
name|struct
name|radius_msg
modifier|*
name|msg
parameter_list|,
specifier|const
name|u8
modifier|*
name|secret
parameter_list|,
name|size_t
name|secret_len
parameter_list|,
name|struct
name|radius_msg
modifier|*
name|sent_msg
parameter_list|,
name|int
name|auth
parameter_list|)
block|{
specifier|const
name|u8
modifier|*
name|addr
index|[
literal|4
index|]
decl_stmt|;
name|size_t
name|len
index|[
literal|4
index|]
decl_stmt|;
name|u8
name|hash
index|[
name|MD5_MAC_LEN
index|]
decl_stmt|;
if|if
condition|(
name|sent_msg
operator|==
name|NULL
condition|)
block|{
name|printf
argument_list|(
literal|"No matching Access-Request message found\n"
argument_list|)
expr_stmt|;
return|return
literal|1
return|;
block|}
if|if
condition|(
name|auth
operator|&&
name|radius_msg_verify_msg_auth
argument_list|(
name|msg
argument_list|,
name|secret
argument_list|,
name|secret_len
argument_list|,
name|sent_msg
operator|->
name|hdr
operator|->
name|authenticator
argument_list|)
condition|)
block|{
return|return
literal|1
return|;
block|}
comment|/* ResponseAuth = MD5(Code+ID+Length+RequestAuth+Attributes+Secret) */
name|addr
index|[
literal|0
index|]
operator|=
operator|(
name|u8
operator|*
operator|)
name|msg
operator|->
name|hdr
expr_stmt|;
name|len
index|[
literal|0
index|]
operator|=
literal|1
operator|+
literal|1
operator|+
literal|2
expr_stmt|;
name|addr
index|[
literal|1
index|]
operator|=
name|sent_msg
operator|->
name|hdr
operator|->
name|authenticator
expr_stmt|;
name|len
index|[
literal|1
index|]
operator|=
name|MD5_MAC_LEN
expr_stmt|;
name|addr
index|[
literal|2
index|]
operator|=
name|wpabuf_head_u8
argument_list|(
name|msg
operator|->
name|buf
argument_list|)
operator|+
sizeof|sizeof
argument_list|(
expr|struct
name|radius_hdr
argument_list|)
expr_stmt|;
name|len
index|[
literal|2
index|]
operator|=
name|wpabuf_len
argument_list|(
name|msg
operator|->
name|buf
argument_list|)
operator|-
sizeof|sizeof
argument_list|(
expr|struct
name|radius_hdr
argument_list|)
expr_stmt|;
name|addr
index|[
literal|3
index|]
operator|=
name|secret
expr_stmt|;
name|len
index|[
literal|3
index|]
operator|=
name|secret_len
expr_stmt|;
name|md5_vector
argument_list|(
literal|4
argument_list|,
name|addr
argument_list|,
name|len
argument_list|,
name|hash
argument_list|)
expr_stmt|;
if|if
condition|(
name|os_memcmp
argument_list|(
name|hash
argument_list|,
name|msg
operator|->
name|hdr
operator|->
name|authenticator
argument_list|,
name|MD5_MAC_LEN
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|printf
argument_list|(
literal|"Response Authenticator invalid!\n"
argument_list|)
expr_stmt|;
return|return
literal|1
return|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
name|int
name|radius_msg_copy_attr
parameter_list|(
name|struct
name|radius_msg
modifier|*
name|dst
parameter_list|,
name|struct
name|radius_msg
modifier|*
name|src
parameter_list|,
name|u8
name|type
parameter_list|)
block|{
name|struct
name|radius_attr_hdr
modifier|*
name|attr
decl_stmt|;
name|size_t
name|i
decl_stmt|;
name|int
name|count
init|=
literal|0
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|src
operator|->
name|attr_used
condition|;
name|i
operator|++
control|)
block|{
name|attr
operator|=
name|radius_get_attr_hdr
argument_list|(
name|src
argument_list|,
name|i
argument_list|)
expr_stmt|;
if|if
condition|(
name|attr
operator|->
name|type
operator|==
name|type
condition|)
block|{
if|if
condition|(
operator|!
name|radius_msg_add_attr
argument_list|(
name|dst
argument_list|,
name|type
argument_list|,
operator|(
name|u8
operator|*
operator|)
operator|(
name|attr
operator|+
literal|1
operator|)
argument_list|,
name|attr
operator|->
name|length
operator|-
sizeof|sizeof
argument_list|(
operator|*
name|attr
argument_list|)
argument_list|)
condition|)
return|return
operator|-
literal|1
return|;
name|count
operator|++
expr_stmt|;
block|}
block|}
return|return
name|count
return|;
block|}
end_function

begin_comment
comment|/* Create Request Authenticator. The value should be unique over the lifetime  * of the shared secret between authenticator and authentication server.  * Use one-way MD5 hash calculated from current timestamp and some data given  * by the caller. */
end_comment

begin_function
name|void
name|radius_msg_make_authenticator
parameter_list|(
name|struct
name|radius_msg
modifier|*
name|msg
parameter_list|,
specifier|const
name|u8
modifier|*
name|data
parameter_list|,
name|size_t
name|len
parameter_list|)
block|{
name|struct
name|os_time
name|tv
decl_stmt|;
name|long
name|int
name|l
decl_stmt|;
specifier|const
name|u8
modifier|*
name|addr
index|[
literal|3
index|]
decl_stmt|;
name|size_t
name|elen
index|[
literal|3
index|]
decl_stmt|;
name|os_get_time
argument_list|(
operator|&
name|tv
argument_list|)
expr_stmt|;
name|l
operator|=
name|os_random
argument_list|()
expr_stmt|;
name|addr
index|[
literal|0
index|]
operator|=
operator|(
name|u8
operator|*
operator|)
operator|&
name|tv
expr_stmt|;
name|elen
index|[
literal|0
index|]
operator|=
sizeof|sizeof
argument_list|(
name|tv
argument_list|)
expr_stmt|;
name|addr
index|[
literal|1
index|]
operator|=
name|data
expr_stmt|;
name|elen
index|[
literal|1
index|]
operator|=
name|len
expr_stmt|;
name|addr
index|[
literal|2
index|]
operator|=
operator|(
name|u8
operator|*
operator|)
operator|&
name|l
expr_stmt|;
name|elen
index|[
literal|2
index|]
operator|=
sizeof|sizeof
argument_list|(
name|l
argument_list|)
expr_stmt|;
name|md5_vector
argument_list|(
literal|3
argument_list|,
name|addr
argument_list|,
name|elen
argument_list|,
name|msg
operator|->
name|hdr
operator|->
name|authenticator
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* Get Vendor-specific RADIUS Attribute from a parsed RADIUS message.  * Returns the Attribute payload and sets alen to indicate the length of the  * payload if a vendor attribute with subtype is found, otherwise returns NULL.  * The returned payload is allocated with os_malloc() and caller must free it  * by calling os_free().  */
end_comment

begin_function
specifier|static
name|u8
modifier|*
name|radius_msg_get_vendor_attr
parameter_list|(
name|struct
name|radius_msg
modifier|*
name|msg
parameter_list|,
name|u32
name|vendor
parameter_list|,
name|u8
name|subtype
parameter_list|,
name|size_t
modifier|*
name|alen
parameter_list|)
block|{
name|u8
modifier|*
name|data
decl_stmt|,
modifier|*
name|pos
decl_stmt|;
name|size_t
name|i
decl_stmt|,
name|len
decl_stmt|;
if|if
condition|(
name|msg
operator|==
name|NULL
condition|)
return|return
name|NULL
return|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|msg
operator|->
name|attr_used
condition|;
name|i
operator|++
control|)
block|{
name|struct
name|radius_attr_hdr
modifier|*
name|attr
init|=
name|radius_get_attr_hdr
argument_list|(
name|msg
argument_list|,
name|i
argument_list|)
decl_stmt|;
name|size_t
name|left
decl_stmt|;
name|u32
name|vendor_id
decl_stmt|;
name|struct
name|radius_attr_vendor
modifier|*
name|vhdr
decl_stmt|;
if|if
condition|(
name|attr
operator|->
name|type
operator|!=
name|RADIUS_ATTR_VENDOR_SPECIFIC
condition|)
continue|continue;
name|left
operator|=
name|attr
operator|->
name|length
operator|-
sizeof|sizeof
argument_list|(
operator|*
name|attr
argument_list|)
expr_stmt|;
if|if
condition|(
name|left
operator|<
literal|4
condition|)
continue|continue;
name|pos
operator|=
operator|(
name|u8
operator|*
operator|)
operator|(
name|attr
operator|+
literal|1
operator|)
expr_stmt|;
name|os_memcpy
argument_list|(
operator|&
name|vendor_id
argument_list|,
name|pos
argument_list|,
literal|4
argument_list|)
expr_stmt|;
name|pos
operator|+=
literal|4
expr_stmt|;
name|left
operator|-=
literal|4
expr_stmt|;
if|if
condition|(
name|ntohl
argument_list|(
name|vendor_id
argument_list|)
operator|!=
name|vendor
condition|)
continue|continue;
while|while
condition|(
name|left
operator|>=
sizeof|sizeof
argument_list|(
operator|*
name|vhdr
argument_list|)
condition|)
block|{
name|vhdr
operator|=
operator|(
expr|struct
name|radius_attr_vendor
operator|*
operator|)
name|pos
expr_stmt|;
if|if
condition|(
name|vhdr
operator|->
name|vendor_length
operator|>
name|left
operator|||
name|vhdr
operator|->
name|vendor_length
operator|<
sizeof|sizeof
argument_list|(
operator|*
name|vhdr
argument_list|)
condition|)
block|{
name|left
operator|=
literal|0
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|vhdr
operator|->
name|vendor_type
operator|!=
name|subtype
condition|)
block|{
name|pos
operator|+=
name|vhdr
operator|->
name|vendor_length
expr_stmt|;
name|left
operator|-=
name|vhdr
operator|->
name|vendor_length
expr_stmt|;
continue|continue;
block|}
name|len
operator|=
name|vhdr
operator|->
name|vendor_length
operator|-
sizeof|sizeof
argument_list|(
operator|*
name|vhdr
argument_list|)
expr_stmt|;
name|data
operator|=
name|os_malloc
argument_list|(
name|len
argument_list|)
expr_stmt|;
if|if
condition|(
name|data
operator|==
name|NULL
condition|)
return|return
name|NULL
return|;
name|os_memcpy
argument_list|(
name|data
argument_list|,
name|pos
operator|+
sizeof|sizeof
argument_list|(
operator|*
name|vhdr
argument_list|)
argument_list|,
name|len
argument_list|)
expr_stmt|;
if|if
condition|(
name|alen
condition|)
operator|*
name|alen
operator|=
name|len
expr_stmt|;
return|return
name|data
return|;
block|}
block|}
return|return
name|NULL
return|;
block|}
end_function

begin_function
specifier|static
name|u8
modifier|*
name|decrypt_ms_key
parameter_list|(
specifier|const
name|u8
modifier|*
name|key
parameter_list|,
name|size_t
name|len
parameter_list|,
specifier|const
name|u8
modifier|*
name|req_authenticator
parameter_list|,
specifier|const
name|u8
modifier|*
name|secret
parameter_list|,
name|size_t
name|secret_len
parameter_list|,
name|size_t
modifier|*
name|reslen
parameter_list|)
block|{
name|u8
modifier|*
name|plain
decl_stmt|,
modifier|*
name|ppos
decl_stmt|,
modifier|*
name|res
decl_stmt|;
specifier|const
name|u8
modifier|*
name|pos
decl_stmt|;
name|size_t
name|left
decl_stmt|,
name|plen
decl_stmt|;
name|u8
name|hash
index|[
name|MD5_MAC_LEN
index|]
decl_stmt|;
name|int
name|i
decl_stmt|,
name|first
init|=
literal|1
decl_stmt|;
specifier|const
name|u8
modifier|*
name|addr
index|[
literal|3
index|]
decl_stmt|;
name|size_t
name|elen
index|[
literal|3
index|]
decl_stmt|;
comment|/* key: 16-bit salt followed by encrypted key info */
if|if
condition|(
name|len
operator|<
literal|2
operator|+
literal|16
condition|)
return|return
name|NULL
return|;
name|pos
operator|=
name|key
operator|+
literal|2
expr_stmt|;
name|left
operator|=
name|len
operator|-
literal|2
expr_stmt|;
if|if
condition|(
name|left
operator|%
literal|16
condition|)
block|{
name|printf
argument_list|(
literal|"Invalid ms key len %lu\n"
argument_list|,
operator|(
name|unsigned
name|long
operator|)
name|left
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|plen
operator|=
name|left
expr_stmt|;
name|ppos
operator|=
name|plain
operator|=
name|os_malloc
argument_list|(
name|plen
argument_list|)
expr_stmt|;
if|if
condition|(
name|plain
operator|==
name|NULL
condition|)
return|return
name|NULL
return|;
name|plain
index|[
literal|0
index|]
operator|=
literal|0
expr_stmt|;
while|while
condition|(
name|left
operator|>
literal|0
condition|)
block|{
comment|/* b(1) = MD5(Secret + Request-Authenticator + Salt) 		 * b(i) = MD5(Secret + c(i - 1)) for i> 1 */
name|addr
index|[
literal|0
index|]
operator|=
name|secret
expr_stmt|;
name|elen
index|[
literal|0
index|]
operator|=
name|secret_len
expr_stmt|;
if|if
condition|(
name|first
condition|)
block|{
name|addr
index|[
literal|1
index|]
operator|=
name|req_authenticator
expr_stmt|;
name|elen
index|[
literal|1
index|]
operator|=
name|MD5_MAC_LEN
expr_stmt|;
name|addr
index|[
literal|2
index|]
operator|=
name|key
expr_stmt|;
name|elen
index|[
literal|2
index|]
operator|=
literal|2
expr_stmt|;
comment|/* Salt */
block|}
else|else
block|{
name|addr
index|[
literal|1
index|]
operator|=
name|pos
operator|-
name|MD5_MAC_LEN
expr_stmt|;
name|elen
index|[
literal|1
index|]
operator|=
name|MD5_MAC_LEN
expr_stmt|;
block|}
name|md5_vector
argument_list|(
name|first
condition|?
literal|3
else|:
literal|2
argument_list|,
name|addr
argument_list|,
name|elen
argument_list|,
name|hash
argument_list|)
expr_stmt|;
name|first
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|MD5_MAC_LEN
condition|;
name|i
operator|++
control|)
operator|*
name|ppos
operator|++
operator|=
operator|*
name|pos
operator|++
operator|^
name|hash
index|[
name|i
index|]
expr_stmt|;
name|left
operator|-=
name|MD5_MAC_LEN
expr_stmt|;
block|}
if|if
condition|(
name|plain
index|[
literal|0
index|]
operator|==
literal|0
operator|||
name|plain
index|[
literal|0
index|]
operator|>
name|plen
operator|-
literal|1
condition|)
block|{
name|printf
argument_list|(
literal|"Failed to decrypt MPPE key\n"
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|plain
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|res
operator|=
name|os_malloc
argument_list|(
name|plain
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|res
operator|==
name|NULL
condition|)
block|{
name|os_free
argument_list|(
name|plain
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|os_memcpy
argument_list|(
name|res
argument_list|,
name|plain
operator|+
literal|1
argument_list|,
name|plain
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|reslen
condition|)
operator|*
name|reslen
operator|=
name|plain
index|[
literal|0
index|]
expr_stmt|;
name|os_free
argument_list|(
name|plain
argument_list|)
expr_stmt|;
return|return
name|res
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|encrypt_ms_key
parameter_list|(
specifier|const
name|u8
modifier|*
name|key
parameter_list|,
name|size_t
name|key_len
parameter_list|,
name|u16
name|salt
parameter_list|,
specifier|const
name|u8
modifier|*
name|req_authenticator
parameter_list|,
specifier|const
name|u8
modifier|*
name|secret
parameter_list|,
name|size_t
name|secret_len
parameter_list|,
name|u8
modifier|*
name|ebuf
parameter_list|,
name|size_t
modifier|*
name|elen
parameter_list|)
block|{
name|int
name|i
decl_stmt|,
name|len
decl_stmt|,
name|first
init|=
literal|1
decl_stmt|;
name|u8
name|hash
index|[
name|MD5_MAC_LEN
index|]
decl_stmt|,
name|saltbuf
index|[
literal|2
index|]
decl_stmt|,
modifier|*
name|pos
decl_stmt|;
specifier|const
name|u8
modifier|*
name|addr
index|[
literal|3
index|]
decl_stmt|;
name|size_t
name|_len
index|[
literal|3
index|]
decl_stmt|;
name|WPA_PUT_BE16
argument_list|(
name|saltbuf
argument_list|,
name|salt
argument_list|)
expr_stmt|;
name|len
operator|=
literal|1
operator|+
name|key_len
expr_stmt|;
if|if
condition|(
name|len
operator|&
literal|0x0f
condition|)
block|{
name|len
operator|=
operator|(
name|len
operator|&
literal|0xf0
operator|)
operator|+
literal|16
expr_stmt|;
block|}
name|os_memset
argument_list|(
name|ebuf
argument_list|,
literal|0
argument_list|,
name|len
argument_list|)
expr_stmt|;
name|ebuf
index|[
literal|0
index|]
operator|=
name|key_len
expr_stmt|;
name|os_memcpy
argument_list|(
name|ebuf
operator|+
literal|1
argument_list|,
name|key
argument_list|,
name|key_len
argument_list|)
expr_stmt|;
operator|*
name|elen
operator|=
name|len
expr_stmt|;
name|pos
operator|=
name|ebuf
expr_stmt|;
while|while
condition|(
name|len
operator|>
literal|0
condition|)
block|{
comment|/* b(1) = MD5(Secret + Request-Authenticator + Salt) 		 * b(i) = MD5(Secret + c(i - 1)) for i> 1 */
name|addr
index|[
literal|0
index|]
operator|=
name|secret
expr_stmt|;
name|_len
index|[
literal|0
index|]
operator|=
name|secret_len
expr_stmt|;
if|if
condition|(
name|first
condition|)
block|{
name|addr
index|[
literal|1
index|]
operator|=
name|req_authenticator
expr_stmt|;
name|_len
index|[
literal|1
index|]
operator|=
name|MD5_MAC_LEN
expr_stmt|;
name|addr
index|[
literal|2
index|]
operator|=
name|saltbuf
expr_stmt|;
name|_len
index|[
literal|2
index|]
operator|=
sizeof|sizeof
argument_list|(
name|saltbuf
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|addr
index|[
literal|1
index|]
operator|=
name|pos
operator|-
name|MD5_MAC_LEN
expr_stmt|;
name|_len
index|[
literal|1
index|]
operator|=
name|MD5_MAC_LEN
expr_stmt|;
block|}
name|md5_vector
argument_list|(
name|first
condition|?
literal|3
else|:
literal|2
argument_list|,
name|addr
argument_list|,
name|_len
argument_list|,
name|hash
argument_list|)
expr_stmt|;
name|first
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|MD5_MAC_LEN
condition|;
name|i
operator|++
control|)
operator|*
name|pos
operator|++
operator|^=
name|hash
index|[
name|i
index|]
expr_stmt|;
name|len
operator|-=
name|MD5_MAC_LEN
expr_stmt|;
block|}
block|}
end_function

begin_function
name|struct
name|radius_ms_mppe_keys
modifier|*
name|radius_msg_get_ms_keys
parameter_list|(
name|struct
name|radius_msg
modifier|*
name|msg
parameter_list|,
name|struct
name|radius_msg
modifier|*
name|sent_msg
parameter_list|,
specifier|const
name|u8
modifier|*
name|secret
parameter_list|,
name|size_t
name|secret_len
parameter_list|)
block|{
name|u8
modifier|*
name|key
decl_stmt|;
name|size_t
name|keylen
decl_stmt|;
name|struct
name|radius_ms_mppe_keys
modifier|*
name|keys
decl_stmt|;
if|if
condition|(
name|msg
operator|==
name|NULL
operator|||
name|sent_msg
operator|==
name|NULL
condition|)
return|return
name|NULL
return|;
name|keys
operator|=
name|os_zalloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|keys
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|keys
operator|==
name|NULL
condition|)
return|return
name|NULL
return|;
name|key
operator|=
name|radius_msg_get_vendor_attr
argument_list|(
name|msg
argument_list|,
name|RADIUS_VENDOR_ID_MICROSOFT
argument_list|,
name|RADIUS_VENDOR_ATTR_MS_MPPE_SEND_KEY
argument_list|,
operator|&
name|keylen
argument_list|)
expr_stmt|;
if|if
condition|(
name|key
condition|)
block|{
name|keys
operator|->
name|send
operator|=
name|decrypt_ms_key
argument_list|(
name|key
argument_list|,
name|keylen
argument_list|,
name|sent_msg
operator|->
name|hdr
operator|->
name|authenticator
argument_list|,
name|secret
argument_list|,
name|secret_len
argument_list|,
operator|&
name|keys
operator|->
name|send_len
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|key
argument_list|)
expr_stmt|;
block|}
name|key
operator|=
name|radius_msg_get_vendor_attr
argument_list|(
name|msg
argument_list|,
name|RADIUS_VENDOR_ID_MICROSOFT
argument_list|,
name|RADIUS_VENDOR_ATTR_MS_MPPE_RECV_KEY
argument_list|,
operator|&
name|keylen
argument_list|)
expr_stmt|;
if|if
condition|(
name|key
condition|)
block|{
name|keys
operator|->
name|recv
operator|=
name|decrypt_ms_key
argument_list|(
name|key
argument_list|,
name|keylen
argument_list|,
name|sent_msg
operator|->
name|hdr
operator|->
name|authenticator
argument_list|,
name|secret
argument_list|,
name|secret_len
argument_list|,
operator|&
name|keys
operator|->
name|recv_len
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|key
argument_list|)
expr_stmt|;
block|}
return|return
name|keys
return|;
block|}
end_function

begin_function
name|struct
name|radius_ms_mppe_keys
modifier|*
name|radius_msg_get_cisco_keys
parameter_list|(
name|struct
name|radius_msg
modifier|*
name|msg
parameter_list|,
name|struct
name|radius_msg
modifier|*
name|sent_msg
parameter_list|,
specifier|const
name|u8
modifier|*
name|secret
parameter_list|,
name|size_t
name|secret_len
parameter_list|)
block|{
name|u8
modifier|*
name|key
decl_stmt|;
name|size_t
name|keylen
decl_stmt|;
name|struct
name|radius_ms_mppe_keys
modifier|*
name|keys
decl_stmt|;
if|if
condition|(
name|msg
operator|==
name|NULL
operator|||
name|sent_msg
operator|==
name|NULL
condition|)
return|return
name|NULL
return|;
name|keys
operator|=
name|os_zalloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|keys
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|keys
operator|==
name|NULL
condition|)
return|return
name|NULL
return|;
name|key
operator|=
name|radius_msg_get_vendor_attr
argument_list|(
name|msg
argument_list|,
name|RADIUS_VENDOR_ID_CISCO
argument_list|,
name|RADIUS_CISCO_AV_PAIR
argument_list|,
operator|&
name|keylen
argument_list|)
expr_stmt|;
if|if
condition|(
name|key
operator|&&
name|keylen
operator|==
literal|51
operator|&&
name|os_memcmp
argument_list|(
name|key
argument_list|,
literal|"leap:session-key="
argument_list|,
literal|17
argument_list|)
operator|==
literal|0
condition|)
block|{
name|keys
operator|->
name|recv
operator|=
name|decrypt_ms_key
argument_list|(
name|key
operator|+
literal|17
argument_list|,
name|keylen
operator|-
literal|17
argument_list|,
name|sent_msg
operator|->
name|hdr
operator|->
name|authenticator
argument_list|,
name|secret
argument_list|,
name|secret_len
argument_list|,
operator|&
name|keys
operator|->
name|recv_len
argument_list|)
expr_stmt|;
block|}
name|os_free
argument_list|(
name|key
argument_list|)
expr_stmt|;
return|return
name|keys
return|;
block|}
end_function

begin_function
name|int
name|radius_msg_add_mppe_keys
parameter_list|(
name|struct
name|radius_msg
modifier|*
name|msg
parameter_list|,
specifier|const
name|u8
modifier|*
name|req_authenticator
parameter_list|,
specifier|const
name|u8
modifier|*
name|secret
parameter_list|,
name|size_t
name|secret_len
parameter_list|,
specifier|const
name|u8
modifier|*
name|send_key
parameter_list|,
name|size_t
name|send_key_len
parameter_list|,
specifier|const
name|u8
modifier|*
name|recv_key
parameter_list|,
name|size_t
name|recv_key_len
parameter_list|)
block|{
name|struct
name|radius_attr_hdr
modifier|*
name|attr
decl_stmt|;
name|u32
name|vendor_id
init|=
name|htonl
argument_list|(
name|RADIUS_VENDOR_ID_MICROSOFT
argument_list|)
decl_stmt|;
name|u8
modifier|*
name|buf
decl_stmt|;
name|struct
name|radius_attr_vendor
modifier|*
name|vhdr
decl_stmt|;
name|u8
modifier|*
name|pos
decl_stmt|;
name|size_t
name|elen
decl_stmt|;
name|int
name|hlen
decl_stmt|;
name|u16
name|salt
decl_stmt|;
name|hlen
operator|=
sizeof|sizeof
argument_list|(
name|vendor_id
argument_list|)
operator|+
sizeof|sizeof
argument_list|(
operator|*
name|vhdr
argument_list|)
operator|+
literal|2
expr_stmt|;
comment|/* MS-MPPE-Send-Key */
name|buf
operator|=
name|os_malloc
argument_list|(
name|hlen
operator|+
name|send_key_len
operator|+
literal|16
argument_list|)
expr_stmt|;
if|if
condition|(
name|buf
operator|==
name|NULL
condition|)
block|{
return|return
literal|0
return|;
block|}
name|pos
operator|=
name|buf
expr_stmt|;
name|os_memcpy
argument_list|(
name|pos
argument_list|,
operator|&
name|vendor_id
argument_list|,
sizeof|sizeof
argument_list|(
name|vendor_id
argument_list|)
argument_list|)
expr_stmt|;
name|pos
operator|+=
sizeof|sizeof
argument_list|(
name|vendor_id
argument_list|)
expr_stmt|;
name|vhdr
operator|=
operator|(
expr|struct
name|radius_attr_vendor
operator|*
operator|)
name|pos
expr_stmt|;
name|vhdr
operator|->
name|vendor_type
operator|=
name|RADIUS_VENDOR_ATTR_MS_MPPE_SEND_KEY
expr_stmt|;
name|pos
operator|=
operator|(
name|u8
operator|*
operator|)
operator|(
name|vhdr
operator|+
literal|1
operator|)
expr_stmt|;
name|salt
operator|=
name|os_random
argument_list|()
operator||
literal|0x8000
expr_stmt|;
name|WPA_PUT_BE16
argument_list|(
name|pos
argument_list|,
name|salt
argument_list|)
expr_stmt|;
name|pos
operator|+=
literal|2
expr_stmt|;
name|encrypt_ms_key
argument_list|(
name|send_key
argument_list|,
name|send_key_len
argument_list|,
name|salt
argument_list|,
name|req_authenticator
argument_list|,
name|secret
argument_list|,
name|secret_len
argument_list|,
name|pos
argument_list|,
operator|&
name|elen
argument_list|)
expr_stmt|;
name|vhdr
operator|->
name|vendor_length
operator|=
name|hlen
operator|+
name|elen
operator|-
sizeof|sizeof
argument_list|(
name|vendor_id
argument_list|)
expr_stmt|;
name|attr
operator|=
name|radius_msg_add_attr
argument_list|(
name|msg
argument_list|,
name|RADIUS_ATTR_VENDOR_SPECIFIC
argument_list|,
name|buf
argument_list|,
name|hlen
operator|+
name|elen
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|buf
argument_list|)
expr_stmt|;
if|if
condition|(
name|attr
operator|==
name|NULL
condition|)
block|{
return|return
literal|0
return|;
block|}
comment|/* MS-MPPE-Recv-Key */
name|buf
operator|=
name|os_malloc
argument_list|(
name|hlen
operator|+
name|send_key_len
operator|+
literal|16
argument_list|)
expr_stmt|;
if|if
condition|(
name|buf
operator|==
name|NULL
condition|)
block|{
return|return
literal|0
return|;
block|}
name|pos
operator|=
name|buf
expr_stmt|;
name|os_memcpy
argument_list|(
name|pos
argument_list|,
operator|&
name|vendor_id
argument_list|,
sizeof|sizeof
argument_list|(
name|vendor_id
argument_list|)
argument_list|)
expr_stmt|;
name|pos
operator|+=
sizeof|sizeof
argument_list|(
name|vendor_id
argument_list|)
expr_stmt|;
name|vhdr
operator|=
operator|(
expr|struct
name|radius_attr_vendor
operator|*
operator|)
name|pos
expr_stmt|;
name|vhdr
operator|->
name|vendor_type
operator|=
name|RADIUS_VENDOR_ATTR_MS_MPPE_RECV_KEY
expr_stmt|;
name|pos
operator|=
operator|(
name|u8
operator|*
operator|)
operator|(
name|vhdr
operator|+
literal|1
operator|)
expr_stmt|;
name|salt
operator|^=
literal|1
expr_stmt|;
name|WPA_PUT_BE16
argument_list|(
name|pos
argument_list|,
name|salt
argument_list|)
expr_stmt|;
name|pos
operator|+=
literal|2
expr_stmt|;
name|encrypt_ms_key
argument_list|(
name|recv_key
argument_list|,
name|recv_key_len
argument_list|,
name|salt
argument_list|,
name|req_authenticator
argument_list|,
name|secret
argument_list|,
name|secret_len
argument_list|,
name|pos
argument_list|,
operator|&
name|elen
argument_list|)
expr_stmt|;
name|vhdr
operator|->
name|vendor_length
operator|=
name|hlen
operator|+
name|elen
operator|-
sizeof|sizeof
argument_list|(
name|vendor_id
argument_list|)
expr_stmt|;
name|attr
operator|=
name|radius_msg_add_attr
argument_list|(
name|msg
argument_list|,
name|RADIUS_ATTR_VENDOR_SPECIFIC
argument_list|,
name|buf
argument_list|,
name|hlen
operator|+
name|elen
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|buf
argument_list|)
expr_stmt|;
if|if
condition|(
name|attr
operator|==
name|NULL
condition|)
block|{
return|return
literal|0
return|;
block|}
return|return
literal|1
return|;
block|}
end_function

begin_comment
comment|/* Add User-Password attribute to a RADIUS message and encrypt it as specified  * in RFC 2865, Chap. 5.2 */
end_comment

begin_function
name|struct
name|radius_attr_hdr
modifier|*
name|radius_msg_add_attr_user_password
parameter_list|(
name|struct
name|radius_msg
modifier|*
name|msg
parameter_list|,
specifier|const
name|u8
modifier|*
name|data
parameter_list|,
name|size_t
name|data_len
parameter_list|,
specifier|const
name|u8
modifier|*
name|secret
parameter_list|,
name|size_t
name|secret_len
parameter_list|)
block|{
name|u8
name|buf
index|[
literal|128
index|]
decl_stmt|;
name|int
name|padlen
decl_stmt|,
name|i
decl_stmt|;
name|size_t
name|buf_len
decl_stmt|,
name|pos
decl_stmt|;
specifier|const
name|u8
modifier|*
name|addr
index|[
literal|2
index|]
decl_stmt|;
name|size_t
name|len
index|[
literal|2
index|]
decl_stmt|;
name|u8
name|hash
index|[
literal|16
index|]
decl_stmt|;
if|if
condition|(
name|data_len
operator|>
literal|128
condition|)
return|return
name|NULL
return|;
name|os_memcpy
argument_list|(
name|buf
argument_list|,
name|data
argument_list|,
name|data_len
argument_list|)
expr_stmt|;
name|buf_len
operator|=
name|data_len
expr_stmt|;
name|padlen
operator|=
name|data_len
operator|%
literal|16
expr_stmt|;
if|if
condition|(
name|padlen
condition|)
block|{
name|padlen
operator|=
literal|16
operator|-
name|padlen
expr_stmt|;
name|os_memset
argument_list|(
name|buf
operator|+
name|data_len
argument_list|,
literal|0
argument_list|,
name|padlen
argument_list|)
expr_stmt|;
name|buf_len
operator|+=
name|padlen
expr_stmt|;
block|}
name|addr
index|[
literal|0
index|]
operator|=
name|secret
expr_stmt|;
name|len
index|[
literal|0
index|]
operator|=
name|secret_len
expr_stmt|;
name|addr
index|[
literal|1
index|]
operator|=
name|msg
operator|->
name|hdr
operator|->
name|authenticator
expr_stmt|;
name|len
index|[
literal|1
index|]
operator|=
literal|16
expr_stmt|;
name|md5_vector
argument_list|(
literal|2
argument_list|,
name|addr
argument_list|,
name|len
argument_list|,
name|hash
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|16
condition|;
name|i
operator|++
control|)
name|buf
index|[
name|i
index|]
operator|^=
name|hash
index|[
name|i
index|]
expr_stmt|;
name|pos
operator|=
literal|16
expr_stmt|;
while|while
condition|(
name|pos
operator|<
name|buf_len
condition|)
block|{
name|addr
index|[
literal|0
index|]
operator|=
name|secret
expr_stmt|;
name|len
index|[
literal|0
index|]
operator|=
name|secret_len
expr_stmt|;
name|addr
index|[
literal|1
index|]
operator|=
operator|&
name|buf
index|[
name|pos
operator|-
literal|16
index|]
expr_stmt|;
name|len
index|[
literal|1
index|]
operator|=
literal|16
expr_stmt|;
name|md5_vector
argument_list|(
literal|2
argument_list|,
name|addr
argument_list|,
name|len
argument_list|,
name|hash
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|16
condition|;
name|i
operator|++
control|)
name|buf
index|[
name|pos
operator|+
name|i
index|]
operator|^=
name|hash
index|[
name|i
index|]
expr_stmt|;
name|pos
operator|+=
literal|16
expr_stmt|;
block|}
return|return
name|radius_msg_add_attr
argument_list|(
name|msg
argument_list|,
name|RADIUS_ATTR_USER_PASSWORD
argument_list|,
name|buf
argument_list|,
name|buf_len
argument_list|)
return|;
block|}
end_function

begin_function
name|int
name|radius_msg_get_attr
parameter_list|(
name|struct
name|radius_msg
modifier|*
name|msg
parameter_list|,
name|u8
name|type
parameter_list|,
name|u8
modifier|*
name|buf
parameter_list|,
name|size_t
name|len
parameter_list|)
block|{
name|struct
name|radius_attr_hdr
modifier|*
name|attr
init|=
name|NULL
decl_stmt|,
modifier|*
name|tmp
decl_stmt|;
name|size_t
name|i
decl_stmt|,
name|dlen
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|msg
operator|->
name|attr_used
condition|;
name|i
operator|++
control|)
block|{
name|tmp
operator|=
name|radius_get_attr_hdr
argument_list|(
name|msg
argument_list|,
name|i
argument_list|)
expr_stmt|;
if|if
condition|(
name|tmp
operator|->
name|type
operator|==
name|type
condition|)
block|{
name|attr
operator|=
name|tmp
expr_stmt|;
break|break;
block|}
block|}
if|if
condition|(
operator|!
name|attr
condition|)
return|return
operator|-
literal|1
return|;
name|dlen
operator|=
name|attr
operator|->
name|length
operator|-
sizeof|sizeof
argument_list|(
operator|*
name|attr
argument_list|)
expr_stmt|;
if|if
condition|(
name|buf
condition|)
name|os_memcpy
argument_list|(
name|buf
argument_list|,
operator|(
name|attr
operator|+
literal|1
operator|)
argument_list|,
name|dlen
operator|>
name|len
condition|?
name|len
else|:
name|dlen
argument_list|)
expr_stmt|;
return|return
name|dlen
return|;
block|}
end_function

begin_function
name|int
name|radius_msg_get_attr_ptr
parameter_list|(
name|struct
name|radius_msg
modifier|*
name|msg
parameter_list|,
name|u8
name|type
parameter_list|,
name|u8
modifier|*
modifier|*
name|buf
parameter_list|,
name|size_t
modifier|*
name|len
parameter_list|,
specifier|const
name|u8
modifier|*
name|start
parameter_list|)
block|{
name|size_t
name|i
decl_stmt|;
name|struct
name|radius_attr_hdr
modifier|*
name|attr
init|=
name|NULL
decl_stmt|,
modifier|*
name|tmp
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|msg
operator|->
name|attr_used
condition|;
name|i
operator|++
control|)
block|{
name|tmp
operator|=
name|radius_get_attr_hdr
argument_list|(
name|msg
argument_list|,
name|i
argument_list|)
expr_stmt|;
if|if
condition|(
name|tmp
operator|->
name|type
operator|==
name|type
operator|&&
operator|(
name|start
operator|==
name|NULL
operator|||
operator|(
name|u8
operator|*
operator|)
name|tmp
operator|>
name|start
operator|)
condition|)
block|{
name|attr
operator|=
name|tmp
expr_stmt|;
break|break;
block|}
block|}
if|if
condition|(
operator|!
name|attr
condition|)
return|return
operator|-
literal|1
return|;
operator|*
name|buf
operator|=
operator|(
name|u8
operator|*
operator|)
operator|(
name|attr
operator|+
literal|1
operator|)
expr_stmt|;
operator|*
name|len
operator|=
name|attr
operator|->
name|length
operator|-
sizeof|sizeof
argument_list|(
operator|*
name|attr
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|int
name|radius_msg_count_attr
parameter_list|(
name|struct
name|radius_msg
modifier|*
name|msg
parameter_list|,
name|u8
name|type
parameter_list|,
name|int
name|min_len
parameter_list|)
block|{
name|size_t
name|i
decl_stmt|;
name|int
name|count
decl_stmt|;
for|for
control|(
name|count
operator|=
literal|0
operator|,
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|msg
operator|->
name|attr_used
condition|;
name|i
operator|++
control|)
block|{
name|struct
name|radius_attr_hdr
modifier|*
name|attr
init|=
name|radius_get_attr_hdr
argument_list|(
name|msg
argument_list|,
name|i
argument_list|)
decl_stmt|;
if|if
condition|(
name|attr
operator|->
name|type
operator|==
name|type
operator|&&
name|attr
operator|->
name|length
operator|>=
sizeof|sizeof
argument_list|(
expr|struct
name|radius_attr_hdr
argument_list|)
operator|+
name|min_len
condition|)
name|count
operator|++
expr_stmt|;
block|}
return|return
name|count
return|;
block|}
end_function

begin_struct
struct|struct
name|radius_tunnel_attrs
block|{
name|int
name|tag_used
decl_stmt|;
name|int
name|type
decl_stmt|;
comment|/* Tunnel-Type */
name|int
name|medium_type
decl_stmt|;
comment|/* Tunnel-Medium-Type */
name|int
name|vlanid
decl_stmt|;
block|}
struct|;
end_struct

begin_comment
comment|/**  * radius_msg_get_vlanid - Parse RADIUS attributes for VLAN tunnel information  * @msg: RADIUS message  * Returns: VLAN ID for the first tunnel configuration of -1 if none is found  */
end_comment

begin_function
name|int
name|radius_msg_get_vlanid
parameter_list|(
name|struct
name|radius_msg
modifier|*
name|msg
parameter_list|)
block|{
name|struct
name|radius_tunnel_attrs
name|tunnel
index|[
name|RADIUS_TUNNEL_TAGS
index|]
decl_stmt|,
modifier|*
name|tun
decl_stmt|;
name|size_t
name|i
decl_stmt|;
name|struct
name|radius_attr_hdr
modifier|*
name|attr
init|=
name|NULL
decl_stmt|;
specifier|const
name|u8
modifier|*
name|data
decl_stmt|;
name|char
name|buf
index|[
literal|10
index|]
decl_stmt|;
name|size_t
name|dlen
decl_stmt|;
name|os_memset
argument_list|(
operator|&
name|tunnel
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|tunnel
argument_list|)
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|msg
operator|->
name|attr_used
condition|;
name|i
operator|++
control|)
block|{
name|attr
operator|=
name|radius_get_attr_hdr
argument_list|(
name|msg
argument_list|,
name|i
argument_list|)
expr_stmt|;
name|data
operator|=
operator|(
specifier|const
name|u8
operator|*
operator|)
operator|(
name|attr
operator|+
literal|1
operator|)
expr_stmt|;
name|dlen
operator|=
name|attr
operator|->
name|length
operator|-
sizeof|sizeof
argument_list|(
operator|*
name|attr
argument_list|)
expr_stmt|;
if|if
condition|(
name|attr
operator|->
name|length
operator|<
literal|3
condition|)
continue|continue;
if|if
condition|(
name|data
index|[
literal|0
index|]
operator|>=
name|RADIUS_TUNNEL_TAGS
condition|)
name|tun
operator|=
operator|&
name|tunnel
index|[
literal|0
index|]
expr_stmt|;
else|else
name|tun
operator|=
operator|&
name|tunnel
index|[
name|data
index|[
literal|0
index|]
index|]
expr_stmt|;
switch|switch
condition|(
name|attr
operator|->
name|type
condition|)
block|{
case|case
name|RADIUS_ATTR_TUNNEL_TYPE
case|:
if|if
condition|(
name|attr
operator|->
name|length
operator|!=
literal|6
condition|)
break|break;
name|tun
operator|->
name|tag_used
operator|++
expr_stmt|;
name|tun
operator|->
name|type
operator|=
name|WPA_GET_BE24
argument_list|(
name|data
operator|+
literal|1
argument_list|)
expr_stmt|;
break|break;
case|case
name|RADIUS_ATTR_TUNNEL_MEDIUM_TYPE
case|:
if|if
condition|(
name|attr
operator|->
name|length
operator|!=
literal|6
condition|)
break|break;
name|tun
operator|->
name|tag_used
operator|++
expr_stmt|;
name|tun
operator|->
name|medium_type
operator|=
name|WPA_GET_BE24
argument_list|(
name|data
operator|+
literal|1
argument_list|)
expr_stmt|;
break|break;
case|case
name|RADIUS_ATTR_TUNNEL_PRIVATE_GROUP_ID
case|:
if|if
condition|(
name|data
index|[
literal|0
index|]
operator|<
name|RADIUS_TUNNEL_TAGS
condition|)
block|{
name|data
operator|++
expr_stmt|;
name|dlen
operator|--
expr_stmt|;
block|}
if|if
condition|(
name|dlen
operator|>=
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
condition|)
break|break;
name|os_memcpy
argument_list|(
name|buf
argument_list|,
name|data
argument_list|,
name|dlen
argument_list|)
expr_stmt|;
name|buf
index|[
name|dlen
index|]
operator|=
literal|'\0'
expr_stmt|;
name|tun
operator|->
name|tag_used
operator|++
expr_stmt|;
name|tun
operator|->
name|vlanid
operator|=
name|atoi
argument_list|(
name|buf
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|RADIUS_TUNNEL_TAGS
condition|;
name|i
operator|++
control|)
block|{
name|tun
operator|=
operator|&
name|tunnel
index|[
name|i
index|]
expr_stmt|;
if|if
condition|(
name|tun
operator|->
name|tag_used
operator|&&
name|tun
operator|->
name|type
operator|==
name|RADIUS_TUNNEL_TYPE_VLAN
operator|&&
name|tun
operator|->
name|medium_type
operator|==
name|RADIUS_TUNNEL_MEDIUM_TYPE_802
operator|&&
name|tun
operator|->
name|vlanid
operator|>
literal|0
condition|)
return|return
name|tun
operator|->
name|vlanid
return|;
block|}
return|return
operator|-
literal|1
return|;
block|}
end_function

begin_function
name|void
name|radius_free_class
parameter_list|(
name|struct
name|radius_class_data
modifier|*
name|c
parameter_list|)
block|{
name|size_t
name|i
decl_stmt|;
if|if
condition|(
name|c
operator|==
name|NULL
condition|)
return|return;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|c
operator|->
name|count
condition|;
name|i
operator|++
control|)
name|os_free
argument_list|(
name|c
operator|->
name|attr
index|[
name|i
index|]
operator|.
name|data
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|c
operator|->
name|attr
argument_list|)
expr_stmt|;
name|c
operator|->
name|attr
operator|=
name|NULL
expr_stmt|;
name|c
operator|->
name|count
operator|=
literal|0
expr_stmt|;
block|}
end_function

begin_function
name|int
name|radius_copy_class
parameter_list|(
name|struct
name|radius_class_data
modifier|*
name|dst
parameter_list|,
specifier|const
name|struct
name|radius_class_data
modifier|*
name|src
parameter_list|)
block|{
name|size_t
name|i
decl_stmt|;
if|if
condition|(
name|src
operator|->
name|attr
operator|==
name|NULL
condition|)
return|return
literal|0
return|;
name|dst
operator|->
name|attr
operator|=
name|os_zalloc
argument_list|(
name|src
operator|->
name|count
operator|*
sizeof|sizeof
argument_list|(
expr|struct
name|radius_attr_data
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|dst
operator|->
name|attr
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
name|dst
operator|->
name|count
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|src
operator|->
name|count
condition|;
name|i
operator|++
control|)
block|{
name|dst
operator|->
name|attr
index|[
name|i
index|]
operator|.
name|data
operator|=
name|os_malloc
argument_list|(
name|src
operator|->
name|attr
index|[
name|i
index|]
operator|.
name|len
argument_list|)
expr_stmt|;
if|if
condition|(
name|dst
operator|->
name|attr
index|[
name|i
index|]
operator|.
name|data
operator|==
name|NULL
condition|)
break|break;
name|dst
operator|->
name|count
operator|++
expr_stmt|;
name|os_memcpy
argument_list|(
name|dst
operator|->
name|attr
index|[
name|i
index|]
operator|.
name|data
argument_list|,
name|src
operator|->
name|attr
index|[
name|i
index|]
operator|.
name|data
argument_list|,
name|src
operator|->
name|attr
index|[
name|i
index|]
operator|.
name|len
argument_list|)
expr_stmt|;
name|dst
operator|->
name|attr
index|[
name|i
index|]
operator|.
name|len
operator|=
name|src
operator|->
name|attr
index|[
name|i
index|]
operator|.
name|len
expr_stmt|;
block|}
return|return
literal|0
return|;
block|}
end_function

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_decl_stmt
specifier|static
name|char
name|sccsid
index|[]
init|=
literal|"@(#)netmail.c	4.1	(Berkeley)	%G%"
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* sccs id variable */
end_comment

begin_decl_stmt
specifier|static
name|char
modifier|*
name|netmail_sid
init|=
literal|"@(#)netmail.c	1.2"
decl_stmt|;
end_decl_stmt

begin_comment
comment|/*    netmail [-c] [-l ...] [-p ...] [-f] [-n] [-q] ([mach] | [mach:username])     Read mail on remote machine "mach"    Sends a command to the remote machine to "mail" the mail    to this machine.     If the -c option is specified, this command is a mail check command,    and in this mode it logs into the remote machine as "network"    and determines if mach:username has mail.    It writes/mails a message to that effect.    This variant is intended to be used in .login files, silently    checking if you have mail on another machine.     Must duplicate effort that will be redone by the net command-    the calls to commandfile and promptlogin are necessary    to get a value for the login name to send to the prmail    command on the other machine.    May read the passwd file: 	1. Commandfile calls getenv(HOME) to get the home directory. 	   If not easily reached,.... 	2. SnCurrent() calls getlogin(). If no entry in utmp file, 	   will read passwd file.  */
end_comment

begin_include
include|#
directive|include
file|"defs.h"
end_include

begin_comment
comment|/* global variables */
end_comment

begin_decl_stmt
name|struct
name|userinfo
name|status
decl_stmt|;
end_decl_stmt

begin_function
name|main
parameter_list|(
name|argc
parameter_list|,
name|argv
parameter_list|)
name|char
modifier|*
modifier|*
name|argv
decl_stmt|;
block|{
name|char
modifier|*
name|s
decl_stmt|;
name|char
name|machparm
index|[
name|BUFSIZ
index|]
decl_stmt|,
name|fromaddress
index|[
name|BUFSIZ
index|]
decl_stmt|,
name|fMailCheck
init|=
literal|0
decl_stmt|;
name|char
name|rcmd
index|[
name|BUFSIZ
index|]
decl_stmt|,
name|fquiet
init|=
literal|0
decl_stmt|;
name|debugflg
operator|=
name|DBV
expr_stmt|;
name|strcpy
argument_list|(
name|rcmd
argument_list|,
literal|"netmail"
argument_list|)
expr_stmt|;
name|argc
operator|--
expr_stmt|;
name|argv
operator|++
expr_stmt|;
while|while
condition|(
name|argc
operator|>
literal|0
operator|&&
name|argv
index|[
literal|0
index|]
index|[
literal|0
index|]
operator|==
literal|'-'
condition|)
block|{
switch|switch
condition|(
name|argv
index|[
literal|0
index|]
index|[
literal|1
index|]
condition|)
block|{
case|case
literal|'b'
case|:
name|status
operator|.
name|nonotify
operator|++
expr_stmt|;
name|appss
argument_list|(
name|rcmd
argument_list|,
name|argv
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'c'
case|:
name|fMailCheck
operator|++
expr_stmt|;
name|appss
argument_list|(
name|rcmd
argument_list|,
name|argv
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'f'
case|:
name|status
operator|.
name|force
operator|++
expr_stmt|;
name|appss
argument_list|(
name|rcmd
argument_list|,
name|argv
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'l'
case|:
name|harg
argument_list|(
name|status
operator|.
name|login
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'n'
case|:
name|status
operator|.
name|nowrite
operator|++
expr_stmt|;
name|appss
argument_list|(
name|rcmd
argument_list|,
name|argv
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'p'
case|:
name|harg
argument_list|(
name|status
operator|.
name|mpasswd
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'q'
case|:
name|fquiet
operator|=
literal|1
expr_stmt|;
name|appss
argument_list|(
name|rcmd
argument_list|,
name|argv
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
break|break;
default|default:
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Usage: netmail [-l login] [-p password] [-c] [-f] [-n] [-q] [mach]\n"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
name|EX_USAGE
argument_list|)
expr_stmt|;
block|}
name|argc
operator|--
operator|,
name|argv
operator|++
expr_stmt|;
block|}
if|if
condition|(
name|argc
operator|>
literal|0
condition|)
block|{
if|if
condition|(
name|FMemberSCh
argument_list|(
name|argv
index|[
literal|0
index|]
argument_list|,
literal|':'
argument_list|)
condition|)
name|remote
operator|=
name|MchSFromAddr
argument_list|(
name|status
operator|.
name|login
argument_list|,
name|argv
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
else|else
name|remote
operator|=
name|lookup
argument_list|(
name|argv
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|remote
operator|==
literal|0
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Unknown machine %s\n"
argument_list|,
name|argv
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
name|exit
argument_list|(
name|EX_NOHOST
argument_list|)
expr_stmt|;
block|}
name|appss
argument_list|(
name|rcmd
argument_list|,
name|argv
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
block|}
comment|/* read the .netrc file to get a value for remote */
comment|/* will get status.login, passwd, and force for fetch variant */
name|commandfile
argument_list|()
expr_stmt|;
if|if
condition|(
name|remote
operator|==
literal|0
condition|)
name|remote
operator|=
name|getremote
argument_list|(
name|local
argument_list|)
expr_stmt|;
name|sprintf
argument_list|(
name|machparm
argument_list|,
literal|"-m%c"
argument_list|,
name|remote
argument_list|)
expr_stmt|;
if|if
condition|(
name|remote
operator|==
name|local
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Use the mail command to read your mail on this machine.\n"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
name|EX_USAGE
argument_list|)
expr_stmt|;
block|}
comment|/* read pw file, get local addr to send to prmail, store in status.localname */
name|s
operator|=
name|SnFromUid
argument_list|(
name|getuid
argument_list|()
argument_list|)
expr_stmt|;
if|if
condition|(
name|s
operator|==
name|NULL
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Unknown local user\n"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
name|EX_OSFILE
argument_list|)
expr_stmt|;
block|}
name|strcpy
argument_list|(
name|status
operator|.
name|localname
argument_list|,
name|s
argument_list|)
expr_stmt|;
name|sprintf
argument_list|(
name|fromaddress
argument_list|,
literal|"%s:%s"
argument_list|,
name|longname
argument_list|(
name|local
argument_list|)
argument_list|,
name|s
argument_list|)
expr_stmt|;
comment|/* mail check variant */
if|if
condition|(
name|fMailCheck
condition|)
block|{
if|if
condition|(
name|status
operator|.
name|login
index|[
literal|0
index|]
operator|==
literal|0
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Must supply a remote user name for mail check.\n"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
name|EX_USAGE
argument_list|)
expr_stmt|;
block|}
comment|/* send mail check over, no passwd needed */
if|if
condition|(
name|fquiet
condition|)
name|mexecl
argument_list|(
name|netcmd
argument_list|,
literal|"net"
argument_list|,
literal|"-q"
argument_list|,
name|machparm
argument_list|,
literal|"-l"
argument_list|,
literal|"network"
argument_list|,
literal|"-c"
argument_list|,
name|rcmd
argument_list|,
name|PRMAIL
argument_list|,
literal|"-c"
argument_list|,
literal|"-l"
argument_list|,
name|status
operator|.
name|login
argument_list|,
literal|"-f"
argument_list|,
name|fromaddress
argument_list|,
literal|0
argument_list|)
expr_stmt|;
else|else
name|mexecl
argument_list|(
name|netcmd
argument_list|,
literal|"net"
argument_list|,
literal|"-q"
argument_list|,
name|machparm
argument_list|,
literal|"-l"
argument_list|,
literal|"network"
argument_list|,
literal|"-c"
argument_list|,
name|rcmd
argument_list|,
name|PRMAIL
argument_list|,
literal|"-c"
argument_list|,
literal|"-l"
argument_list|,
name|status
operator|.
name|login
argument_list|,
literal|"-f"
argument_list|,
name|fromaddress
argument_list|,
literal|"-k"
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|perror
argument_list|(
name|netcmd
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Network is down\n"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
name|EX_UNAVAILABLE
argument_list|)
expr_stmt|;
block|}
comment|/* mail forward variant */
comment|/*  	   get name to send as parameter to prmail. 	   required for multiple login names with the same uid's 	   stored in status.login 	*/
name|envloginpasswd
argument_list|(
name|remote
argument_list|,
name|status
operator|.
name|login
argument_list|,
name|status
operator|.
name|mpasswd
argument_list|)
expr_stmt|;
comment|/* look in env */
name|promptlogin
argument_list|(
name|remote
argument_list|)
expr_stmt|;
comment|/* prompt for name, passwd explicitely */
if|if
condition|(
name|fquiet
condition|)
name|kexecl
argument_list|(
name|netcmd
argument_list|,
literal|"net"
argument_list|,
literal|"-q"
argument_list|,
name|machparm
argument_list|,
literal|"-c"
argument_list|,
name|rcmd
argument_list|,
name|PRMAIL
argument_list|,
literal|"-l"
argument_list|,
name|status
operator|.
name|login
argument_list|,
literal|"-f"
argument_list|,
name|fromaddress
argument_list|,
literal|"-r"
argument_list|,
literal|0
argument_list|)
expr_stmt|;
else|else
name|kexecl
argument_list|(
name|netcmd
argument_list|,
literal|"net"
argument_list|,
literal|"-q"
argument_list|,
name|machparm
argument_list|,
literal|"-c"
argument_list|,
name|rcmd
argument_list|,
name|PRMAIL
argument_list|,
literal|"-l"
argument_list|,
name|status
operator|.
name|login
argument_list|,
literal|"-f"
argument_list|,
name|fromaddress
argument_list|,
literal|"-r"
argument_list|,
literal|"-k"
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|perror
argument_list|(
name|netcmd
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Network is down\n"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
name|EX_UNAVAILABLE
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* 	append string sfrom to end of string sto, preceded by blank */
end_comment

begin_expr_stmt
name|appss
argument_list|(
name|sto
argument_list|,
name|sfrom
argument_list|)
specifier|register
name|char
operator|*
name|sto
operator|,
operator|*
name|sfrom
expr_stmt|;
end_expr_stmt

begin_block
block|{
name|strcat
argument_list|(
name|sto
argument_list|,
literal|" "
argument_list|)
expr_stmt|;
name|strcat
argument_list|(
name|sto
argument_list|,
name|sfrom
argument_list|)
expr_stmt|;
block|}
end_block

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/* Copyright (c) 1983 Regents of the University of California */
end_comment

begin_ifndef
ifndef|#
directive|ifndef
name|lint
end_ifndef

begin_decl_stmt
specifier|static
name|char
name|sccsid
index|[]
init|=
literal|"@(#)cpio.c	4.1	(Berkeley)	%G%"
decl_stmt|;
end_decl_stmt

begin_endif
endif|#
directive|endif
endif|not lint
end_endif

begin_comment
comment|/*	cpio	COMPILE:	cc -O cpio.c -s -i -o cpio  	cpio -- copy file collections  */
end_comment

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_include
include|#
directive|include
file|<sys/types.h>
end_include

begin_include
include|#
directive|include
file|<sys/stat.h>
end_include

begin_include
include|#
directive|include
file|<signal.h>
end_include

begin_ifdef
ifdef|#
directive|ifdef
name|RT
end_ifdef

begin_define
define|#
directive|define
name|S_IFEXT
value|0120000
end_define

begin_comment
comment|/*  allocated by extents  */
end_comment

begin_define
define|#
directive|define
name|S_IF1EXT
value|0130000
end_define

begin_comment
comment|/*  one extent  */
end_comment

begin_endif
endif|#
directive|endif
end_endif

begin_define
define|#
directive|define
name|EQ
parameter_list|(
name|x
parameter_list|,
name|y
parameter_list|)
value|(strcmp(x,y)==0)
end_define

begin_comment
comment|/* for VAX, Interdata, ... */
end_comment

begin_define
define|#
directive|define
name|MKSHORT
parameter_list|(
name|v
parameter_list|,
name|lv
parameter_list|)
value|{U.l=1L;if(U.c[0]) U.l=lv,v[0]=U.s[1],v[1]=U.s[0]; else U.l=lv,v[0]=U.s[0],v[1]=U.s[1];}
end_define

begin_define
define|#
directive|define
name|MAGIC
value|070707
end_define

begin_define
define|#
directive|define
name|IN
value|1
end_define

begin_define
define|#
directive|define
name|OUT
value|2
end_define

begin_define
define|#
directive|define
name|PASS
value|3
end_define

begin_define
define|#
directive|define
name|HDRSIZE
value|((sizeof Hdr)-256)
end_define

begin_define
define|#
directive|define
name|LINKS
value|1000
end_define

begin_define
define|#
directive|define
name|MERT
value|0
end_define

begin_define
define|#
directive|define
name|CHARS
value|76
end_define

begin_ifdef
ifdef|#
directive|ifdef
name|RT
end_ifdef

begin_define
define|#
directive|define
name|MERT
value|1
end_define

begin_comment
comment|/* yes = 1 ;  no = 0 */
end_comment

begin_decl_stmt
specifier|extern
name|long
name|filespace
decl_stmt|;
end_decl_stmt

begin_endif
endif|#
directive|endif
end_endif

begin_decl_stmt
name|struct
name|stat
name|Statb
decl_stmt|,
name|Xstatb
decl_stmt|;
end_decl_stmt

begin_struct
struct|struct
name|header
block|{
name|short
name|h_magic
decl_stmt|,
name|h_dev
decl_stmt|;
name|unsigned
name|short
name|h_ino
decl_stmt|,
name|h_mode
decl_stmt|,
name|h_uid
decl_stmt|,
name|h_gid
decl_stmt|;
name|short
name|h_nlink
decl_stmt|,
name|h_rdev
decl_stmt|,
name|h_mtime
index|[
literal|2
index|]
decl_stmt|,
name|h_namesize
decl_stmt|,
name|h_filesize
index|[
literal|2
index|]
decl_stmt|;
name|char
name|h_name
index|[
literal|256
index|]
decl_stmt|;
block|}
name|Hdr
struct|;
end_struct

begin_decl_stmt
name|int
name|Bufsize
init|=
literal|512
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|short
name|Buf
index|[
literal|256
index|]
decl_stmt|,
modifier|*
name|Dbuf
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|char
name|BBuf
index|[
literal|512
index|]
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|char
modifier|*
name|Cbuf
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|Wct
decl_stmt|,
name|Wc
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|short
modifier|*
name|Wp
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|char
modifier|*
name|Cp
decl_stmt|;
end_decl_stmt

begin_ifdef
ifdef|#
directive|ifdef
name|RT
end_ifdef

begin_decl_stmt
name|short
name|Actual_size
index|[
literal|2
index|]
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* MERT variable */
end_comment

begin_struct
struct|struct
block|{
name|long
name|long_size
decl_stmt|;
block|}
struct|;
end_struct

begin_endif
endif|#
directive|endif
end_endif

begin_decl_stmt
name|short
name|Option
decl_stmt|,
name|Dir
decl_stmt|,
name|Uncond
decl_stmt|,
name|Link
decl_stmt|,
name|Rename
decl_stmt|,
name|Toc
decl_stmt|,
name|Verbose
decl_stmt|,
name|Select
decl_stmt|,
name|Mod_time
decl_stmt|,
name|Acc_time
decl_stmt|,
name|Cflag
decl_stmt|,
name|Swap
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|Ifile
decl_stmt|,
name|Ofile
decl_stmt|,
name|Input
init|=
literal|0
decl_stmt|,
name|Output
init|=
literal|1
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|long
name|Blocks
decl_stmt|,
name|Longfile
decl_stmt|,
name|Longtime
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|char
name|Fullname
index|[
literal|256
index|]
decl_stmt|,
name|Name
index|[
literal|256
index|]
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|Pathend
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|FILE
modifier|*
name|Rtty
decl_stmt|,
modifier|*
name|Wtty
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|char
modifier|*
name|Pattern
index|[
literal|100
index|]
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|char
name|Strhdr
index|[
literal|500
index|]
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|char
modifier|*
name|Chdr
init|=
name|Strhdr
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|short
name|Dev
decl_stmt|,
name|Uid
decl_stmt|,
name|Gid
decl_stmt|,
name|A_directory
decl_stmt|,
name|A_special
decl_stmt|,
ifdef|#
directive|ifdef
name|RT
name|One_extent
decl_stmt|,
name|Multi_extent
decl_stmt|,
endif|#
directive|endif
name|Filetype
init|=
name|S_IFMT
decl_stmt|;
end_decl_stmt

begin_ifdef
ifdef|#
directive|ifdef
name|RT
end_ifdef

begin_decl_stmt
name|short
name|Remove_mode
init|=
literal|0007777
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|short
name|New_mode
decl_stmt|;
end_decl_stmt

begin_endif
endif|#
directive|endif
end_endif

begin_extern
extern|extern	errno;
end_extern

begin_function_decl
name|char
modifier|*
name|malloc
parameter_list|()
function_decl|;
end_function_decl

begin_function_decl
name|char
modifier|*
name|cd
parameter_list|()
function_decl|;
end_function_decl

begin_decl_stmt
name|char
modifier|*
name|Cd_name
decl_stmt|;
end_decl_stmt

begin_function_decl
name|FILE
modifier|*
name|popen
parameter_list|()
function_decl|;
end_function_decl

begin_union
union|union
block|{
name|long
name|l
decl_stmt|;
name|short
name|s
index|[
literal|2
index|]
decl_stmt|;
name|char
name|c
index|[
literal|4
index|]
decl_stmt|;
block|}
name|U
union|;
end_union

begin_comment
comment|/* for VAX, Interdata, ... */
end_comment

begin_function
name|long
name|mklong
parameter_list|(
name|v
parameter_list|)
name|short
name|v
index|[]
decl_stmt|;
block|{
name|U
operator|.
name|l
operator|=
literal|1
expr_stmt|;
if|if
condition|(
name|U
operator|.
name|c
index|[
literal|0
index|]
condition|)
name|U
operator|.
name|s
index|[
literal|0
index|]
operator|=
name|v
index|[
literal|1
index|]
operator|,
name|U
operator|.
name|s
index|[
literal|1
index|]
operator|=
name|v
index|[
literal|0
index|]
expr_stmt|;
else|else
name|U
operator|.
name|s
index|[
literal|0
index|]
operator|=
name|v
index|[
literal|0
index|]
operator|,
name|U
operator|.
name|s
index|[
literal|1
index|]
operator|=
name|v
index|[
literal|1
index|]
expr_stmt|;
return|return
name|U
operator|.
name|l
return|;
block|}
end_function

begin_function
name|main
parameter_list|(
name|argc
parameter_list|,
name|argv
parameter_list|)
name|char
modifier|*
modifier|*
name|argv
decl_stmt|;
block|{
specifier|register
name|ct
expr_stmt|;
name|long
name|filesz
decl_stmt|;
name|long
name|lng
decl_stmt|;
specifier|register
name|char
modifier|*
name|fullp
decl_stmt|;
specifier|register
name|i
expr_stmt|;
name|signal
argument_list|(
name|SIGSYS
argument_list|,
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
operator|*
name|argv
index|[
literal|1
index|]
operator|!=
literal|'-'
condition|)
name|usage
argument_list|()
expr_stmt|;
name|Uid
operator|=
name|getuid
argument_list|()
expr_stmt|;
name|umask
argument_list|(
literal|0
argument_list|)
expr_stmt|;
name|Gid
operator|=
name|getgid
argument_list|()
expr_stmt|;
name|Pattern
index|[
literal|0
index|]
operator|=
literal|"*"
expr_stmt|;
while|while
condition|(
operator|*
operator|++
name|argv
index|[
literal|1
index|]
condition|)
block|{
switch|switch
condition|(
operator|*
name|argv
index|[
literal|1
index|]
condition|)
block|{
case|case
literal|'a'
case|:
name|Acc_time
operator|++
expr_stmt|;
break|break;
case|case
literal|'B'
case|:
name|Bufsize
operator|=
literal|5120
expr_stmt|;
break|break;
case|case
literal|'i'
case|:
name|Option
operator|=
name|IN
expr_stmt|;
if|if
condition|(
name|argc
operator|>
literal|2
condition|)
block|{
for|for
control|(
name|i
operator|=
literal|0
init|;
operator|(
name|i
operator|+
literal|2
operator|)
operator|<
name|argc
condition|;
operator|++
name|i
control|)
name|Pattern
index|[
name|i
index|]
operator|=
name|argv
index|[
name|i
operator|+
literal|2
index|]
expr_stmt|;
block|}
break|break;
case|case
literal|'o'
case|:
if|if
condition|(
name|argc
operator|!=
literal|2
condition|)
name|usage
argument_list|()
expr_stmt|;
name|Option
operator|=
name|OUT
expr_stmt|;
break|break;
case|case
literal|'p'
case|:
if|if
condition|(
name|argc
operator|!=
literal|3
condition|)
name|usage
argument_list|()
expr_stmt|;
if|if
condition|(
name|access
argument_list|(
name|argv
index|[
literal|2
index|]
argument_list|,
literal|2
argument_list|)
operator|==
operator|-
literal|1
condition|)
block|{
name|accerr
label|:
name|err
argument_list|(
literal|"cannot write in<%s>\n"
argument_list|,
name|argv
index|[
literal|2
index|]
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|2
argument_list|)
expr_stmt|;
block|}
name|strcpy
argument_list|(
name|Fullname
argument_list|,
name|argv
index|[
literal|2
index|]
argument_list|)
expr_stmt|;
name|strcat
argument_list|(
name|Fullname
argument_list|,
literal|"/"
argument_list|)
expr_stmt|;
name|stat
argument_list|(
name|Fullname
argument_list|,
operator|&
name|Xstatb
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|Xstatb
operator|.
name|st_mode
operator|&
name|S_IFMT
operator|)
operator|!=
name|S_IFDIR
condition|)
goto|goto
name|accerr
goto|;
name|Option
operator|=
name|PASS
expr_stmt|;
name|Dev
operator|=
name|Xstatb
operator|.
name|st_dev
expr_stmt|;
break|break;
case|case
literal|'c'
case|:
name|Cflag
operator|++
expr_stmt|;
break|break;
case|case
literal|'d'
case|:
name|Dir
operator|++
expr_stmt|;
break|break;
case|case
literal|'l'
case|:
name|Link
operator|++
expr_stmt|;
break|break;
case|case
literal|'m'
case|:
name|Mod_time
operator|++
expr_stmt|;
break|break;
case|case
literal|'r'
case|:
name|Rename
operator|++
expr_stmt|;
name|Rtty
operator|=
name|fopen
argument_list|(
literal|"/dev/tty"
argument_list|,
literal|"r"
argument_list|)
expr_stmt|;
name|Wtty
operator|=
name|fopen
argument_list|(
literal|"/dev/tty"
argument_list|,
literal|"w"
argument_list|)
expr_stmt|;
if|if
condition|(
name|Rtty
operator|==
name|NULL
operator|||
name|Wtty
operator|==
name|NULL
condition|)
block|{
name|err
argument_list|(
literal|"Cannot rename (/dev/tty missing)\n"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|2
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
literal|'s'
case|:
name|Swap
operator|++
expr_stmt|;
break|break;
case|case
literal|'t'
case|:
name|Toc
operator|++
expr_stmt|;
break|break;
case|case
literal|'u'
case|:
name|Uncond
operator|++
expr_stmt|;
break|break;
case|case
literal|'v'
case|:
name|Verbose
operator|++
expr_stmt|;
break|break;
case|case
literal|'6'
case|:
name|Filetype
operator|=
literal|060000
expr_stmt|;
break|break;
default|default:
name|usage
argument_list|()
expr_stmt|;
block|}
block|}
if|if
condition|(
operator|!
name|Option
condition|)
block|{
name|err
argument_list|(
literal|"Options must include o|i|p\n"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|2
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|Cflag
operator|&&
name|Swap
condition|)
block|{
name|err
argument_list|(
literal|"Swap flag is ignored with Cflag\n"
argument_list|)
expr_stmt|;
name|Swap
operator|=
literal|0
expr_stmt|;
block|}
if|if
condition|(
name|Option
operator|!=
name|PASS
condition|)
block|{
name|Wp
operator|=
name|Dbuf
operator|=
operator|(
name|short
operator|*
operator|)
name|malloc
argument_list|(
name|Bufsize
argument_list|)
expr_stmt|;
name|Cp
operator|=
name|Cbuf
operator|=
operator|(
name|char
operator|*
operator|)
name|malloc
argument_list|(
name|Bufsize
argument_list|)
expr_stmt|;
block|}
name|Wct
operator|=
name|Bufsize
operator|>>
literal|1
expr_stmt|;
name|Wc
operator|=
name|Bufsize
expr_stmt|;
if|if
condition|(
name|Option
operator|==
name|PASS
operator|&&
name|Rename
condition|)
block|{
name|err
argument_list|(
literal|"Pass and Rename cannot be used together"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|2
argument_list|)
expr_stmt|;
block|}
switch|switch
condition|(
name|Option
condition|)
block|{
case|case
name|OUT
case|:
while|while
condition|(
name|getname
argument_list|()
condition|)
block|{
if|if
condition|(
name|mklong
argument_list|(
name|Hdr
operator|.
name|h_filesize
argument_list|)
operator|==
literal|0L
condition|)
block|{
if|if
condition|(
name|Cflag
condition|)
name|writehdr
argument_list|(
name|Chdr
argument_list|,
name|CHARS
operator|+
name|Hdr
operator|.
name|h_namesize
argument_list|)
expr_stmt|;
else|else
name|bwrite
argument_list|(
operator|&
name|Hdr
argument_list|,
name|HDRSIZE
operator|+
name|Hdr
operator|.
name|h_namesize
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|RT
if|if
condition|(
operator|(
name|MERT
operator|)
operator|&&
operator|(
operator|(
operator|(
name|Hdr
operator|.
name|h_mode
operator|&
name|Filetype
operator|)
operator|==
name|S_IF1EXT
operator|)
operator|||
operator|(
operator|(
name|Hdr
operator|.
name|h_mode
operator|&
name|Filetype
operator|)
operator|==
name|S_IFEXT
operator|)
operator|)
condition|)
block|{
name|actsize
argument_list|()
expr_stmt|;
name|bwrite
argument_list|(
operator|&
name|Hdr
argument_list|,
name|HDRSIZE
operator|+
name|Hdr
operator|.
name|h_namesize
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
continue|continue;
block|}
if|if
condition|(
operator|(
name|Ifile
operator|=
name|open
argument_list|(
name|Hdr
operator|.
name|h_name
argument_list|,
literal|0
argument_list|)
operator|)
operator|<
literal|0
condition|)
block|{
name|err
argument_list|(
literal|"<%s> ?\n"
argument_list|,
name|Hdr
operator|.
name|h_name
argument_list|)
expr_stmt|;
continue|continue;
block|}
if|if
condition|(
name|Cflag
condition|)
name|writehdr
argument_list|(
name|Chdr
argument_list|,
name|CHARS
operator|+
name|Hdr
operator|.
name|h_namesize
argument_list|)
expr_stmt|;
else|else
name|bwrite
argument_list|(
operator|&
name|Hdr
argument_list|,
name|HDRSIZE
operator|+
name|Hdr
operator|.
name|h_namesize
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|RT
if|if
condition|(
operator|(
name|MERT
operator|)
operator|&&
operator|(
operator|(
operator|(
name|Hdr
operator|.
name|h_mode
operator|&
name|Filetype
operator|)
operator|==
name|S_IF1EXT
operator|)
operator|||
operator|(
operator|(
name|Hdr
operator|.
name|h_mode
operator|&
name|Filetype
operator|)
operator|==
name|S_IFEXT
operator|)
operator|)
condition|)
block|{
name|actsize
argument_list|()
expr_stmt|;
name|bwrite
argument_list|(
operator|&
name|Hdr
argument_list|,
name|HDRSIZE
operator|+
name|Hdr
operator|.
name|h_namesize
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
for|for
control|(
name|filesz
operator|=
name|mklong
argument_list|(
name|Hdr
operator|.
name|h_filesize
argument_list|)
init|;
name|filesz
operator|>
literal|0
condition|;
name|filesz
operator|-=
literal|512
control|)
block|{
name|ct
operator|=
name|filesz
operator|>
literal|512
condition|?
literal|512
else|:
name|filesz
expr_stmt|;
if|if
condition|(
name|read
argument_list|(
name|Ifile
argument_list|,
name|Cflag
condition|?
name|BBuf
else|:
operator|(
name|char
operator|*
operator|)
name|Buf
argument_list|,
name|ct
argument_list|)
operator|<
literal|0
condition|)
block|{
name|err
argument_list|(
literal|"Cannot read %s\n"
argument_list|,
name|Hdr
operator|.
name|h_name
argument_list|)
expr_stmt|;
continue|continue;
block|}
name|Cflag
condition|?
name|writehdr
argument_list|(
name|BBuf
argument_list|,
name|ct
argument_list|)
else|:
name|bwrite
argument_list|(
name|Buf
argument_list|,
name|ct
argument_list|)
expr_stmt|;
block|}
name|close
argument_list|(
name|Ifile
argument_list|)
expr_stmt|;
if|if
condition|(
name|Acc_time
condition|)
name|utime
argument_list|(
name|Hdr
operator|.
name|h_name
argument_list|,
operator|&
name|Statb
operator|.
name|st_atime
argument_list|)
expr_stmt|;
if|if
condition|(
name|Verbose
condition|)
name|err
argument_list|(
literal|"%s\n"
argument_list|,
name|Hdr
operator|.
name|h_name
argument_list|)
expr_stmt|;
block|}
name|strcpy
argument_list|(
name|Hdr
operator|.
name|h_name
argument_list|,
literal|"TRAILER!!!"
argument_list|)
expr_stmt|;
name|Hdr
operator|.
name|h_magic
operator|=
name|MAGIC
expr_stmt|;
name|MKSHORT
argument_list|(
name|Hdr
operator|.
name|h_filesize
argument_list|,
literal|0L
argument_list|)
expr_stmt|;
name|Hdr
operator|.
name|h_namesize
operator|=
name|strlen
argument_list|(
literal|"TRAILER!!!"
argument_list|)
operator|+
literal|1
expr_stmt|;
if|if
condition|(
name|Cflag
condition|)
block|{
name|lng
operator|=
literal|0
expr_stmt|;
name|bintochar
argument_list|(
name|lng
argument_list|)
expr_stmt|;
name|writehdr
argument_list|(
name|Chdr
argument_list|,
name|CHARS
operator|+
name|Hdr
operator|.
name|h_namesize
argument_list|)
expr_stmt|;
block|}
else|else
name|bwrite
argument_list|(
operator|&
name|Hdr
argument_list|,
name|HDRSIZE
operator|+
name|Hdr
operator|.
name|h_namesize
argument_list|)
expr_stmt|;
name|Cflag
condition|?
name|writehdr
argument_list|(
name|Cbuf
argument_list|,
name|Bufsize
argument_list|)
else|:
name|bwrite
argument_list|(
name|Dbuf
argument_list|,
name|Bufsize
argument_list|)
expr_stmt|;
break|break;
case|case
name|IN
case|:
name|pwd
argument_list|()
expr_stmt|;
while|while
condition|(
name|gethdr
argument_list|()
condition|)
block|{
name|Ofile
operator|=
name|ckname
argument_list|(
name|Hdr
operator|.
name|h_name
argument_list|)
condition|?
name|openout
argument_list|(
name|Hdr
operator|.
name|h_name
argument_list|)
else|:
literal|0
expr_stmt|;
for|for
control|(
name|filesz
operator|=
name|mklong
argument_list|(
name|Hdr
operator|.
name|h_filesize
argument_list|)
init|;
name|filesz
operator|>
literal|0
condition|;
name|filesz
operator|-=
literal|512
control|)
block|{
name|ct
operator|=
name|filesz
operator|>
literal|512
condition|?
literal|512
else|:
name|filesz
expr_stmt|;
name|Cflag
condition|?
name|readhdr
argument_list|(
name|BBuf
argument_list|,
name|ct
argument_list|)
else|:
name|bread
argument_list|(
name|Buf
argument_list|,
name|ct
argument_list|)
expr_stmt|;
if|if
condition|(
name|Ofile
condition|)
block|{
if|if
condition|(
name|Swap
condition|)
name|swap
argument_list|(
name|Buf
argument_list|,
name|ct
argument_list|)
expr_stmt|;
if|if
condition|(
name|write
argument_list|(
name|Ofile
argument_list|,
name|Cflag
condition|?
name|BBuf
else|:
operator|(
name|char
operator|*
operator|)
name|Buf
argument_list|,
name|ct
argument_list|)
operator|<
literal|0
condition|)
block|{
name|err
argument_list|(
literal|"Cannot write %s\n"
argument_list|,
name|Hdr
operator|.
name|h_name
argument_list|)
expr_stmt|;
continue|continue;
block|}
block|}
block|}
if|if
condition|(
name|Ofile
condition|)
block|{
name|close
argument_list|(
name|Ofile
argument_list|)
expr_stmt|;
name|set_time
argument_list|(
name|Cd_name
argument_list|,
name|mklong
argument_list|(
name|Hdr
operator|.
name|h_mtime
argument_list|)
argument_list|,
name|mklong
argument_list|(
name|Hdr
operator|.
name|h_mtime
argument_list|)
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|Select
condition|)
continue|continue;
if|if
condition|(
name|Verbose
condition|)
if|if
condition|(
name|Toc
condition|)
name|pentry
argument_list|(
name|Hdr
operator|.
name|h_name
argument_list|)
expr_stmt|;
else|else
name|puts
argument_list|(
name|Hdr
operator|.
name|h_name
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|Toc
condition|)
name|puts
argument_list|(
name|Hdr
operator|.
name|h_name
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
name|PASS
case|:
name|fullp
operator|=
name|Fullname
operator|+
name|strlen
argument_list|(
name|Fullname
argument_list|)
expr_stmt|;
while|while
condition|(
name|getname
argument_list|()
condition|)
block|{
if|if
condition|(
operator|!
name|ckname
argument_list|(
name|Hdr
operator|.
name|h_name
argument_list|)
condition|)
continue|continue;
name|strcpy
argument_list|(
name|fullp
argument_list|,
name|Hdr
operator|.
name|h_name
argument_list|)
expr_stmt|;
if|if
condition|(
name|Link
operator|&&
operator|!
name|A_directory
operator|&&
name|Dev
operator|==
name|Statb
operator|.
name|st_dev
condition|)
block|{
comment|/* ???&& (Uid == Statb.st_uid || !Uid)) {*/
if|if
condition|(
name|link
argument_list|(
name|Hdr
operator|.
name|h_name
argument_list|,
name|Fullname
argument_list|)
operator|<
literal|0
condition|)
block|{
comment|/* missing dir.? */
name|unlink
argument_list|(
name|Fullname
argument_list|)
expr_stmt|;
name|missdir
argument_list|(
name|Fullname
argument_list|)
expr_stmt|;
if|if
condition|(
name|link
argument_list|(
name|Hdr
operator|.
name|h_name
argument_list|,
name|Fullname
argument_list|)
operator|<
literal|0
condition|)
block|{
name|err
argument_list|(
literal|"Cannot link<%s>&<%s>\n"
argument_list|,
name|Hdr
operator|.
name|h_name
argument_list|,
name|Fullname
argument_list|)
expr_stmt|;
continue|continue;
block|}
block|}
name|set_time
argument_list|(
name|Hdr
operator|.
name|h_name
argument_list|,
name|mklong
argument_list|(
name|Hdr
operator|.
name|h_mtime
argument_list|)
argument_list|,
name|mklong
argument_list|(
name|Hdr
operator|.
name|h_mtime
argument_list|)
argument_list|)
expr_stmt|;
goto|goto
name|ckverbose
goto|;
block|}
if|if
condition|(
operator|!
operator|(
name|Ofile
operator|=
name|openout
argument_list|(
name|Fullname
argument_list|)
operator|)
condition|)
continue|continue;
if|if
condition|(
operator|(
name|Ifile
operator|=
name|open
argument_list|(
name|Hdr
operator|.
name|h_name
argument_list|,
literal|0
argument_list|)
operator|)
operator|<
literal|0
condition|)
block|{
name|err
argument_list|(
literal|"<%s> ?\n"
argument_list|,
name|Hdr
operator|.
name|h_name
argument_list|)
expr_stmt|;
name|close
argument_list|(
name|Ofile
argument_list|)
expr_stmt|;
continue|continue;
block|}
name|filesz
operator|=
name|Statb
operator|.
name|st_size
expr_stmt|;
for|for
control|(
init|;
name|filesz
operator|>
literal|0
condition|;
name|filesz
operator|-=
literal|512
control|)
block|{
name|ct
operator|=
name|filesz
operator|>
literal|512
condition|?
literal|512
else|:
name|filesz
expr_stmt|;
if|if
condition|(
name|read
argument_list|(
name|Ifile
argument_list|,
name|Buf
argument_list|,
name|ct
argument_list|)
operator|<
literal|0
condition|)
block|{
name|err
argument_list|(
literal|"Cannot read %s\n"
argument_list|,
name|Hdr
operator|.
name|h_name
argument_list|)
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|Ofile
condition|)
if|if
condition|(
name|write
argument_list|(
name|Ofile
argument_list|,
name|Buf
argument_list|,
name|ct
argument_list|)
operator|<
literal|0
condition|)
block|{
name|err
argument_list|(
literal|"Cannot write %s\n"
argument_list|,
name|Hdr
operator|.
name|h_name
argument_list|)
expr_stmt|;
break|break;
block|}
operator|++
name|Blocks
expr_stmt|;
block|}
name|close
argument_list|(
name|Ifile
argument_list|)
expr_stmt|;
if|if
condition|(
name|Acc_time
condition|)
name|utime
argument_list|(
name|Hdr
operator|.
name|h_name
argument_list|,
operator|&
name|Statb
operator|.
name|st_atime
argument_list|)
expr_stmt|;
if|if
condition|(
name|Ofile
condition|)
block|{
name|close
argument_list|(
name|Ofile
argument_list|)
expr_stmt|;
name|set_time
argument_list|(
name|Fullname
argument_list|,
name|Statb
operator|.
name|st_atime
argument_list|,
name|mklong
argument_list|(
name|Hdr
operator|.
name|h_mtime
argument_list|)
argument_list|)
expr_stmt|;
name|ckverbose
label|:
if|if
condition|(
name|Verbose
condition|)
name|puts
argument_list|(
name|Fullname
argument_list|)
expr_stmt|;
block|}
block|}
block|}
name|err
argument_list|(
literal|"%ld blocks\n"
argument_list|,
name|Blocks
operator|*
operator|(
name|Bufsize
operator|>>
literal|9
operator|)
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|0
argument_list|)
expr_stmt|;
block|}
end_function

begin_macro
name|usage
argument_list|()
end_macro

begin_block
block|{
name|err
argument_list|(
literal|"Usage: cpio -o[acvB]<name-list>collection\n%s\n%s\n"
argument_list|,
literal|"       cpio -i[cdmrstuvB6] [pattern ...]<collection"
argument_list|,
literal|"       cpio -p[adlmruv] directory<name-list"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|2
argument_list|)
expr_stmt|;
block|}
end_block

begin_macro
name|getname
argument_list|()
end_macro

begin_block
block|{
specifier|register
name|char
modifier|*
name|namep
init|=
name|Name
decl_stmt|;
name|long
name|tlong
decl_stmt|;
for|for
control|(
init|;
condition|;
control|)
block|{
if|if
condition|(
name|gets
argument_list|(
name|namep
argument_list|)
operator|==
name|NULL
condition|)
return|return
literal|0
return|;
if|if
condition|(
operator|*
name|namep
operator|==
literal|'.'
operator|&&
name|namep
index|[
literal|1
index|]
operator|==
literal|'/'
condition|)
name|namep
operator|+=
literal|2
expr_stmt|;
name|strcpy
argument_list|(
name|Hdr
operator|.
name|h_name
argument_list|,
name|namep
argument_list|)
expr_stmt|;
if|if
condition|(
name|stat
argument_list|(
name|namep
argument_list|,
operator|&
name|Statb
argument_list|)
operator|<
literal|0
condition|)
block|{
name|err
argument_list|(
literal|"< %s> ?\n"
argument_list|,
name|Hdr
operator|.
name|h_name
argument_list|)
expr_stmt|;
continue|continue;
block|}
name|A_directory
operator|=
operator|(
name|Statb
operator|.
name|st_mode
operator|&
name|Filetype
operator|)
operator|==
name|S_IFDIR
expr_stmt|;
name|A_special
operator|=
operator|(
operator|(
name|Statb
operator|.
name|st_mode
operator|&
name|Filetype
operator|)
operator|==
name|S_IFBLK
operator|)
operator|||
operator|(
operator|(
name|Statb
operator|.
name|st_mode
operator|&
name|Filetype
operator|)
operator|==
name|S_IFCHR
operator|)
expr_stmt|;
ifdef|#
directive|ifdef
name|RT
if|if
condition|(
name|MERT
condition|)
block|{
name|One_extent
operator|=
operator|(
name|Statb
operator|.
name|st_mode
operator|&
name|Filetype
operator|)
operator|==
name|S_IF1EXT
expr_stmt|;
name|Multi_extent
operator|=
operator|(
name|Statb
operator|.
name|st_mode
operator|&
name|Filetype
operator|)
operator|==
name|S_IFEXT
expr_stmt|;
block|}
endif|#
directive|endif
name|Hdr
operator|.
name|h_magic
operator|=
name|MAGIC
expr_stmt|;
name|Hdr
operator|.
name|h_namesize
operator|=
name|strlen
argument_list|(
name|Hdr
operator|.
name|h_name
argument_list|)
operator|+
literal|1
expr_stmt|;
name|Hdr
operator|.
name|h_uid
operator|=
name|Statb
operator|.
name|st_uid
expr_stmt|;
name|Hdr
operator|.
name|h_gid
operator|=
name|Statb
operator|.
name|st_gid
expr_stmt|;
name|Hdr
operator|.
name|h_dev
operator|=
name|Statb
operator|.
name|st_dev
expr_stmt|;
name|Hdr
operator|.
name|h_ino
operator|=
name|Statb
operator|.
name|st_ino
expr_stmt|;
name|Hdr
operator|.
name|h_mode
operator|=
name|Statb
operator|.
name|st_mode
expr_stmt|;
name|MKSHORT
argument_list|(
name|Hdr
operator|.
name|h_mtime
argument_list|,
name|Statb
operator|.
name|st_mtime
argument_list|)
expr_stmt|;
name|Hdr
operator|.
name|h_nlink
operator|=
name|Statb
operator|.
name|st_nlink
expr_stmt|;
name|tlong
operator|=
name|Hdr
operator|.
name|h_mode
operator|&
name|S_IFREG
condition|?
name|Statb
operator|.
name|st_size
else|:
literal|0L
expr_stmt|;
name|MKSHORT
argument_list|(
name|Hdr
operator|.
name|h_filesize
argument_list|,
name|tlong
argument_list|)
expr_stmt|;
name|Hdr
operator|.
name|h_rdev
operator|=
name|Statb
operator|.
name|st_rdev
expr_stmt|;
if|if
condition|(
name|Cflag
condition|)
name|bintochar
argument_list|(
name|tlong
argument_list|)
expr_stmt|;
return|return
literal|1
return|;
block|}
block|}
end_block

begin_macro
name|bintochar
argument_list|(
argument|t
argument_list|)
end_macro

begin_decl_stmt
name|long
name|t
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|sprintf
argument_list|(
name|Chdr
argument_list|,
literal|"%.6o%.6ho%.6ho%.6ho%.6ho%.6ho%.6ho%.6ho%.11lo%.6ho%.11lo%s"
argument_list|,
name|MAGIC
argument_list|,
name|Statb
operator|.
name|st_dev
argument_list|,
name|Statb
operator|.
name|st_ino
argument_list|,
name|Statb
operator|.
name|st_mode
argument_list|,
name|Statb
operator|.
name|st_uid
argument_list|,
name|Statb
operator|.
name|st_gid
argument_list|,
name|Statb
operator|.
name|st_nlink
argument_list|,
name|Statb
operator|.
name|st_rdev
operator|&
literal|00000177777
argument_list|,
name|Statb
operator|.
name|st_mtime
argument_list|,
operator|(
name|short
operator|)
name|strlen
argument_list|(
name|Hdr
operator|.
name|h_name
argument_list|)
operator|+
literal|1
argument_list|,
name|t
argument_list|,
name|Hdr
operator|.
name|h_name
argument_list|)
expr_stmt|;
block|}
end_block

begin_macro
name|chartobin
argument_list|()
end_macro

begin_block
block|{
name|sscanf
argument_list|(
name|Chdr
argument_list|,
literal|"%6o%6ho%6ho%6ho%6ho%6ho%6ho%6ho%11lo%6ho%11lo"
argument_list|,
operator|&
name|Hdr
operator|.
name|h_magic
argument_list|,
operator|&
name|Hdr
operator|.
name|h_dev
argument_list|,
operator|&
name|Hdr
operator|.
name|h_ino
argument_list|,
operator|&
name|Hdr
operator|.
name|h_mode
argument_list|,
operator|&
name|Hdr
operator|.
name|h_uid
argument_list|,
operator|&
name|Hdr
operator|.
name|h_gid
argument_list|,
operator|&
name|Hdr
operator|.
name|h_nlink
argument_list|,
operator|&
name|Hdr
operator|.
name|h_rdev
argument_list|,
operator|&
name|Longtime
argument_list|,
operator|&
name|Hdr
operator|.
name|h_namesize
argument_list|,
operator|&
name|Longfile
argument_list|)
expr_stmt|;
name|MKSHORT
argument_list|(
name|Hdr
operator|.
name|h_filesize
argument_list|,
name|Longfile
argument_list|)
expr_stmt|;
name|MKSHORT
argument_list|(
name|Hdr
operator|.
name|h_mtime
argument_list|,
name|Longtime
argument_list|)
expr_stmt|;
block|}
end_block

begin_macro
name|gethdr
argument_list|()
end_macro

begin_block
block|{
if|if
condition|(
name|Cflag
condition|)
block|{
name|readhdr
argument_list|(
name|Chdr
argument_list|,
name|CHARS
argument_list|)
expr_stmt|;
name|chartobin
argument_list|()
expr_stmt|;
block|}
else|else
name|bread
argument_list|(
operator|&
name|Hdr
argument_list|,
name|HDRSIZE
argument_list|)
expr_stmt|;
if|if
condition|(
name|Hdr
operator|.
name|h_magic
operator|!=
name|MAGIC
condition|)
block|{
name|err
argument_list|(
literal|"Out of phase--get help"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|2
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|Cflag
condition|)
name|bread
argument_list|(
name|Hdr
operator|.
name|h_name
argument_list|,
name|Hdr
operator|.
name|h_namesize
argument_list|)
expr_stmt|;
else|else
name|readhdr
argument_list|(
name|Hdr
operator|.
name|h_name
argument_list|,
name|Hdr
operator|.
name|h_namesize
argument_list|)
expr_stmt|;
if|if
condition|(
name|Swap
condition|)
name|swap
argument_list|(
name|Hdr
operator|.
name|h_name
argument_list|,
name|Hdr
operator|.
name|h_namesize
argument_list|)
expr_stmt|;
if|if
condition|(
name|EQ
argument_list|(
name|Hdr
operator|.
name|h_name
argument_list|,
literal|"TRAILER!!!"
argument_list|)
condition|)
return|return
literal|0
return|;
name|A_directory
operator|=
operator|(
name|Hdr
operator|.
name|h_mode
operator|&
name|Filetype
operator|)
operator|==
name|S_IFDIR
expr_stmt|;
name|A_special
operator|=
operator|(
operator|(
name|Hdr
operator|.
name|h_mode
operator|&
name|Filetype
operator|)
operator|==
name|S_IFBLK
operator|)
operator|||
operator|(
operator|(
name|Hdr
operator|.
name|h_mode
operator|&
name|Filetype
operator|)
operator|==
name|S_IFCHR
operator|)
expr_stmt|;
ifdef|#
directive|ifdef
name|RT
if|if
condition|(
operator|(
name|MERT
operator|)
operator|&&
operator|(
operator|(
operator|(
name|Hdr
operator|.
name|h_mode
operator|&
name|Filetype
operator|)
operator|==
name|S_IF1EXT
operator|)
operator|||
operator|(
operator|(
name|Hdr
operator|.
name|h_mode
operator|&
name|Filetype
operator|)
operator|==
name|S_IFEXT
operator|)
operator|)
condition|)
block|{
name|One_extent
operator|=
operator|(
name|Hdr
operator|.
name|h_mode
operator|&
name|Filetype
operator|)
operator|==
name|S_IF1EXT
expr_stmt|;
name|Multi_extent
operator|=
operator|(
name|Hdr
operator|.
name|h_mode
operator|&
name|Filetype
operator|)
operator|==
name|S_IFEXT
expr_stmt|;
name|Actual_size
index|[
literal|0
index|]
operator|=
name|Hdr
operator|.
name|h_filesize
index|[
literal|0
index|]
expr_stmt|;
name|Actual_size
index|[
literal|1
index|]
operator|=
name|Hdr
operator|.
name|h_filesize
index|[
literal|1
index|]
expr_stmt|;
name|bread
argument_list|(
operator|&
name|Hdr
argument_list|,
name|HDRSIZE
argument_list|)
expr_stmt|;
if|if
condition|(
name|Hdr
operator|.
name|h_magic
operator|!=
name|MAGIC
condition|)
block|{
name|err
argument_list|(
literal|"Out of phase--get MERT help"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|2
argument_list|)
expr_stmt|;
block|}
name|bread
argument_list|(
name|Hdr
operator|.
name|h_name
argument_list|,
name|Hdr
operator|.
name|h_namesize
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
return|return
literal|1
return|;
block|}
end_block

begin_expr_stmt
name|ckname
argument_list|(
name|namep
argument_list|)
specifier|register
name|char
operator|*
name|namep
expr_stmt|;
end_expr_stmt

begin_block
block|{
operator|++
name|Select
expr_stmt|;
if|if
condition|(
operator|!
name|nmatch
argument_list|(
name|namep
argument_list|,
name|Pattern
argument_list|)
condition|)
block|{
name|Select
operator|=
literal|0
expr_stmt|;
return|return
literal|0
return|;
block|}
if|if
condition|(
name|Rename
operator|&&
operator|!
name|A_directory
condition|)
block|{
name|fprintf
argument_list|(
name|Wtty
argument_list|,
literal|"Rename<%s>\n"
argument_list|,
name|namep
argument_list|)
expr_stmt|;
name|fflush
argument_list|(
name|Wtty
argument_list|)
expr_stmt|;
name|fgets
argument_list|(
name|namep
argument_list|,
literal|128
argument_list|,
name|Rtty
argument_list|)
expr_stmt|;
if|if
condition|(
name|feof
argument_list|(
name|Rtty
argument_list|)
condition|)
name|exit
argument_list|(
literal|2
argument_list|)
expr_stmt|;
name|namep
index|[
name|strlen
argument_list|(
name|namep
argument_list|)
operator|-
literal|1
index|]
operator|=
literal|'\0'
expr_stmt|;
if|if
condition|(
name|EQ
argument_list|(
name|namep
argument_list|,
literal|""
argument_list|)
condition|)
block|{
name|printf
argument_list|(
literal|"Skipped\n"
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
block|}
return|return
operator|!
name|Toc
return|;
block|}
end_block

begin_expr_stmt
name|openout
argument_list|(
name|namep
argument_list|)
specifier|register
name|char
operator|*
name|namep
expr_stmt|;
end_expr_stmt

begin_block
block|{
specifier|register
name|f
expr_stmt|;
specifier|register
name|char
modifier|*
name|np
decl_stmt|;
if|if
condition|(
operator|!
name|strncmp
argument_list|(
name|namep
argument_list|,
literal|"./"
argument_list|,
literal|2
argument_list|)
condition|)
name|namep
operator|+=
literal|2
expr_stmt|;
name|np
operator|=
name|namep
expr_stmt|;
if|if
condition|(
name|Option
operator|==
name|IN
condition|)
name|Cd_name
operator|=
name|namep
operator|=
name|cd
argument_list|(
name|namep
argument_list|)
expr_stmt|;
if|if
condition|(
name|A_directory
condition|)
block|{
if|if
condition|(
operator|!
name|Dir
operator|||
name|Rename
operator|||
name|EQ
argument_list|(
name|namep
argument_list|,
literal|"."
argument_list|)
operator|||
name|EQ
argument_list|(
name|namep
argument_list|,
literal|".."
argument_list|)
operator|||
name|stat
argument_list|(
name|namep
argument_list|,
operator|&
name|Xstatb
argument_list|)
operator|==
literal|0
condition|)
return|return
literal|0
return|;
if|if
condition|(
operator|!
name|makdir
argument_list|(
name|namep
argument_list|)
condition|)
block|{
name|missdir
argument_list|(
name|namep
argument_list|)
expr_stmt|;
block|}
name|ret
label|:
name|chmod
argument_list|(
name|namep
argument_list|,
name|Hdr
operator|.
name|h_mode
argument_list|)
expr_stmt|;
if|if
condition|(
name|Uid
operator|==
literal|0
condition|)
name|chown
argument_list|(
name|namep
argument_list|,
name|Hdr
operator|.
name|h_uid
argument_list|,
name|Hdr
operator|.
name|h_gid
argument_list|)
expr_stmt|;
name|set_time
argument_list|(
name|namep
argument_list|,
name|mklong
argument_list|(
name|Hdr
operator|.
name|h_mtime
argument_list|)
argument_list|,
name|mklong
argument_list|(
name|Hdr
operator|.
name|h_mtime
argument_list|)
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
if|if
condition|(
name|Hdr
operator|.
name|h_nlink
operator|>
literal|1
condition|)
if|if
condition|(
operator|!
name|postml
argument_list|(
name|namep
argument_list|,
name|np
argument_list|)
condition|)
return|return
literal|0
return|;
if|if
condition|(
name|A_special
condition|)
block|{
name|s_again
label|:
if|if
condition|(
name|mknod
argument_list|(
name|namep
argument_list|,
name|Hdr
operator|.
name|h_mode
argument_list|,
name|Hdr
operator|.
name|h_rdev
argument_list|)
operator|<
literal|0
condition|)
block|{
if|if
condition|(
name|missdir
argument_list|(
name|namep
argument_list|)
condition|)
goto|goto
name|s_again
goto|;
name|err
argument_list|(
literal|"Cannot mknod<%s>\n"
argument_list|,
name|namep
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
goto|goto
name|ret
goto|;
block|}
if|if
condition|(
name|stat
argument_list|(
name|namep
argument_list|,
operator|&
name|Xstatb
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|Uncond
operator|&&
operator|!
operator|(
name|Xstatb
operator|.
name|st_mode
operator|&
name|S_IWRITE
operator|)
condition|)
name|unlink
argument_list|(
name|namep
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|Uncond
operator|&&
operator|(
name|mklong
argument_list|(
name|Hdr
operator|.
name|h_mtime
argument_list|)
operator|<
name|Xstatb
operator|.
name|st_mtime
operator|)
condition|)
block|{
name|err
argument_list|(
literal|"current<%s> newer\n"
argument_list|,
name|namep
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
block|}
if|if
condition|(
name|Option
operator|==
name|PASS
operator|&&
name|Hdr
operator|.
name|h_ino
operator|==
name|Xstatb
operator|.
name|st_ino
operator|&&
name|Hdr
operator|.
name|h_dev
operator|==
name|Xstatb
operator|.
name|st_dev
condition|)
block|{
name|err
argument_list|(
literal|"Attempt to pass file to self!\n"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|2
argument_list|)
expr_stmt|;
block|}
ifdef|#
directive|ifdef
name|RT
name|one_again
label|:
if|if
condition|(
name|One_extent
operator|||
name|Multi_extent
condition|)
block|{
if|if
condition|(
operator|(
name|f
operator|=
name|falloc
argument_list|(
name|namep
argument_list|,
name|Hdr
operator|.
name|h_mode
argument_list|,
name|Hdr
operator|.
name|h_filesize
index|[
literal|0
index|]
operator|.
name|long_size
argument_list|)
operator|)
operator|<
literal|0
condition|)
block|{
if|if
condition|(
name|missdir
argument_list|(
name|namep
argument_list|)
condition|)
goto|goto
name|one_again
goto|;
name|err
argument_list|(
literal|"Cannot create<%s> (errno:%d)\n"
argument_list|,
name|namep
argument_list|,
name|errno
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
if|if
condition|(
name|filespace
operator|<
name|Hdr
operator|.
name|h_filesize
index|[
literal|0
index|]
operator|.
name|long_size
condition|)
block|{
name|err
argument_list|(
literal|"Cannot create contiguous file<%s> proper size\n"
argument_list|,
name|namep
argument_list|)
expr_stmt|;
name|err
argument_list|(
literal|"<%s> will be created as a regular file\n"
argument_list|,
name|namep
argument_list|)
expr_stmt|;
if|if
condition|(
name|unlink
argument_list|(
name|Fullname
argument_list|)
operator|!=
literal|0
condition|)
name|err
argument_list|(
literal|"<%s> not removed\n"
argument_list|,
name|namep
argument_list|)
expr_stmt|;
name|New_mode
operator|=
name|Hdr
operator|.
name|h_mode
operator|&
name|Remove_mode
expr_stmt|;
name|New_mode
operator|=
name|New_mode
operator||
name|S_IFREG
expr_stmt|;
name|once_again
label|:
if|if
condition|(
operator|(
name|f
operator|=
name|creat
argument_list|(
name|namep
argument_list|,
name|New_mode
argument_list|)
operator|)
operator|<
literal|0
condition|)
block|{
if|if
condition|(
name|missdir
argument_list|(
name|namep
argument_list|)
condition|)
goto|goto
name|once_again
goto|;
name|err
argument_list|(
literal|"Cannot create<%s> (errno:%d)\n"
argument_list|,
name|namep
argument_list|,
name|errno
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
block|}
block|}
endif|#
directive|endif
ifdef|#
directive|ifdef
name|RT
if|if
condition|(
name|MERT
operator|&&
operator|(
name|One_extent
operator|||
name|Multi_extent
operator|)
condition|)
goto|goto
name|skip_c
goto|;
endif|#
directive|endif
name|c_again
label|:
if|if
condition|(
operator|(
name|f
operator|=
name|creat
argument_list|(
name|namep
argument_list|,
name|Hdr
operator|.
name|h_mode
argument_list|)
operator|)
operator|<
literal|0
condition|)
block|{
if|if
condition|(
name|missdir
argument_list|(
name|namep
argument_list|)
condition|)
goto|goto
name|c_again
goto|;
name|err
argument_list|(
literal|"Cannot create<%s> (errno:%d)\n"
argument_list|,
name|namep
argument_list|,
name|errno
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
ifdef|#
directive|ifdef
name|RT
name|skip_c
label|:
endif|#
directive|endif
if|if
condition|(
name|Uid
operator|==
literal|0
condition|)
name|chown
argument_list|(
name|namep
argument_list|,
name|Hdr
operator|.
name|h_uid
argument_list|,
name|Hdr
operator|.
name|h_gid
argument_list|)
expr_stmt|;
return|return
name|f
return|;
block|}
end_block

begin_expr_stmt
name|bread
argument_list|(
name|b
argument_list|,
name|c
argument_list|)
specifier|register
name|c
expr_stmt|;
end_expr_stmt

begin_decl_stmt
specifier|register
name|short
modifier|*
name|b
decl_stmt|;
end_decl_stmt

begin_block
block|{
specifier|static
name|nleft
operator|=
literal|0
expr_stmt|;
specifier|static
name|short
modifier|*
name|ip
decl_stmt|;
specifier|register
name|short
modifier|*
name|p
init|=
name|ip
decl_stmt|;
name|c
operator|=
operator|(
name|c
operator|+
literal|1
operator|)
operator|>>
literal|1
expr_stmt|;
while|while
condition|(
name|c
operator|--
condition|)
block|{
if|if
condition|(
operator|!
name|nleft
condition|)
block|{
name|again
label|:
if|if
condition|(
name|read
argument_list|(
name|Input
argument_list|,
name|Dbuf
argument_list|,
name|Bufsize
argument_list|)
operator|!=
name|Bufsize
condition|)
block|{
name|Input
operator|=
name|chgreel
argument_list|(
literal|0
argument_list|,
name|Input
argument_list|)
expr_stmt|;
goto|goto
name|again
goto|;
block|}
name|nleft
operator|=
name|Bufsize
operator|>>
literal|1
expr_stmt|;
name|p
operator|=
name|Dbuf
expr_stmt|;
operator|++
name|Blocks
expr_stmt|;
block|}
operator|*
name|b
operator|++
operator|=
operator|*
name|p
operator|++
expr_stmt|;
operator|--
name|nleft
expr_stmt|;
block|}
name|ip
operator|=
name|p
expr_stmt|;
block|}
end_block

begin_expr_stmt
name|readhdr
argument_list|(
name|b
argument_list|,
name|c
argument_list|)
specifier|register
name|c
expr_stmt|;
end_expr_stmt

begin_decl_stmt
specifier|register
name|char
modifier|*
name|b
decl_stmt|;
end_decl_stmt

begin_block
block|{
specifier|static
name|nleft
operator|=
literal|0
expr_stmt|;
specifier|static
name|char
modifier|*
name|ip
decl_stmt|;
specifier|register
name|char
modifier|*
name|p
init|=
name|ip
decl_stmt|;
while|while
condition|(
name|c
operator|--
condition|)
block|{
if|if
condition|(
operator|!
name|nleft
condition|)
block|{
name|again
label|:
if|if
condition|(
name|read
argument_list|(
name|Input
argument_list|,
name|Cbuf
argument_list|,
name|Bufsize
argument_list|)
operator|!=
name|Bufsize
condition|)
block|{
name|Input
operator|=
name|chgreel
argument_list|(
literal|0
argument_list|,
name|Input
argument_list|)
expr_stmt|;
goto|goto
name|again
goto|;
block|}
name|nleft
operator|=
name|Bufsize
expr_stmt|;
name|p
operator|=
name|Cbuf
expr_stmt|;
operator|++
name|Blocks
expr_stmt|;
block|}
operator|*
name|b
operator|++
operator|=
operator|*
name|p
operator|++
expr_stmt|;
operator|--
name|nleft
expr_stmt|;
block|}
name|ip
operator|=
name|p
expr_stmt|;
block|}
end_block

begin_expr_stmt
name|bwrite
argument_list|(
name|rp
argument_list|,
name|c
argument_list|)
specifier|register
name|short
operator|*
name|rp
expr_stmt|;
end_expr_stmt

begin_expr_stmt
specifier|register
name|c
expr_stmt|;
end_expr_stmt

begin_block
block|{
specifier|register
name|short
modifier|*
name|wp
init|=
name|Wp
decl_stmt|;
name|c
operator|=
operator|(
name|c
operator|+
literal|1
operator|)
operator|>>
literal|1
expr_stmt|;
while|while
condition|(
name|c
operator|--
condition|)
block|{
if|if
condition|(
operator|!
name|Wct
condition|)
block|{
name|again
label|:
if|if
condition|(
name|write
argument_list|(
name|Output
argument_list|,
name|Dbuf
argument_list|,
name|Bufsize
argument_list|)
operator|<
literal|0
condition|)
block|{
name|Output
operator|=
name|chgreel
argument_list|(
literal|1
argument_list|,
name|Output
argument_list|)
expr_stmt|;
goto|goto
name|again
goto|;
block|}
name|Wct
operator|=
name|Bufsize
operator|>>
literal|1
expr_stmt|;
name|wp
operator|=
name|Dbuf
expr_stmt|;
operator|++
name|Blocks
expr_stmt|;
block|}
operator|*
name|wp
operator|++
operator|=
operator|*
name|rp
operator|++
expr_stmt|;
operator|--
name|Wct
expr_stmt|;
block|}
name|Wp
operator|=
name|wp
expr_stmt|;
block|}
end_block

begin_expr_stmt
name|writehdr
argument_list|(
name|rp
argument_list|,
name|c
argument_list|)
specifier|register
name|char
operator|*
name|rp
expr_stmt|;
end_expr_stmt

begin_expr_stmt
specifier|register
name|c
expr_stmt|;
end_expr_stmt

begin_block
block|{
specifier|register
name|char
modifier|*
name|cp
init|=
name|Cp
decl_stmt|;
while|while
condition|(
name|c
operator|--
condition|)
block|{
if|if
condition|(
operator|!
name|Wc
condition|)
block|{
name|again
label|:
if|if
condition|(
name|write
argument_list|(
name|Output
argument_list|,
name|Cbuf
argument_list|,
name|Bufsize
argument_list|)
operator|<
literal|0
condition|)
block|{
name|Output
operator|=
name|chgreel
argument_list|(
literal|1
argument_list|,
name|Output
argument_list|)
expr_stmt|;
goto|goto
name|again
goto|;
block|}
name|Wc
operator|=
name|Bufsize
expr_stmt|;
name|cp
operator|=
name|Cbuf
expr_stmt|;
operator|++
name|Blocks
expr_stmt|;
block|}
operator|*
name|cp
operator|++
operator|=
operator|*
name|rp
operator|++
expr_stmt|;
operator|--
name|Wc
expr_stmt|;
block|}
name|Cp
operator|=
name|cp
expr_stmt|;
block|}
end_block

begin_expr_stmt
name|postml
argument_list|(
name|namep
argument_list|,
name|np
argument_list|)
specifier|register
name|char
operator|*
name|namep
operator|,
operator|*
name|np
expr_stmt|;
end_expr_stmt

begin_block
block|{
specifier|register
name|i
expr_stmt|;
specifier|static
struct|struct
name|ml
block|{
name|short
name|m_dev
decl_stmt|,
name|m_ino
decl_stmt|;
name|char
name|m_name
index|[
literal|2
index|]
decl_stmt|;
block|}
modifier|*
name|ml
index|[
name|LINKS
index|]
struct|;
specifier|static
name|mlinks
operator|=
literal|0
expr_stmt|;
name|char
modifier|*
name|mlp
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|mlinks
condition|;
operator|++
name|i
control|)
block|{
if|if
condition|(
name|mlinks
operator|==
name|LINKS
condition|)
break|break;
if|if
condition|(
name|ml
index|[
name|i
index|]
operator|->
name|m_ino
operator|==
name|Hdr
operator|.
name|h_ino
operator|&&
name|ml
index|[
name|i
index|]
operator|->
name|m_dev
operator|==
name|Hdr
operator|.
name|h_dev
condition|)
block|{
if|if
condition|(
name|Verbose
condition|)
name|printf
argument_list|(
literal|"%s linked to %s\n"
argument_list|,
name|ml
index|[
name|i
index|]
operator|->
name|m_name
argument_list|,
name|np
argument_list|)
expr_stmt|;
name|unlink
argument_list|(
name|namep
argument_list|)
expr_stmt|;
if|if
condition|(
name|Option
operator|==
name|IN
condition|)
block|{
name|Fullname
index|[
name|Pathend
index|]
operator|=
literal|'\0'
expr_stmt|;
name|strcat
argument_list|(
name|Fullname
argument_list|,
name|ml
index|[
name|i
index|]
operator|->
name|m_name
argument_list|)
expr_stmt|;
name|mlp
operator|=
name|Fullname
expr_stmt|;
block|}
else|else
name|mlp
operator|=
name|ml
index|[
name|i
index|]
operator|->
name|m_name
expr_stmt|;
name|l_again
label|:
if|if
condition|(
name|link
argument_list|(
name|mlp
argument_list|,
name|namep
argument_list|)
operator|<
literal|0
condition|)
block|{
if|if
condition|(
name|missdir
argument_list|(
name|np
argument_list|)
condition|)
goto|goto
name|l_again
goto|;
name|err
argument_list|(
literal|"Cannot link<%s>&<%s>.\n"
argument_list|,
name|ml
index|[
name|i
index|]
operator|->
name|m_name
argument_list|,
name|np
argument_list|)
expr_stmt|;
block|}
name|set_time
argument_list|(
name|namep
argument_list|,
name|mklong
argument_list|(
name|Hdr
operator|.
name|h_mtime
argument_list|)
argument_list|,
name|mklong
argument_list|(
name|Hdr
operator|.
name|h_mtime
argument_list|)
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
block|}
if|if
condition|(
name|mlinks
operator|==
name|LINKS
operator|||
operator|!
operator|(
name|ml
index|[
name|mlinks
index|]
operator|=
operator|(
expr|struct
name|ml
operator|*
operator|)
name|malloc
argument_list|(
name|strlen
argument_list|(
name|np
argument_list|)
operator|+
literal|2
operator|+
sizeof|sizeof
argument_list|(
expr|struct
name|ml
argument_list|)
argument_list|)
operator|)
condition|)
block|{
specifier|static
name|int
name|first
init|=
literal|1
decl_stmt|;
if|if
condition|(
name|first
condition|)
if|if
condition|(
name|mlinks
operator|==
name|LINKS
condition|)
name|err
argument_list|(
literal|"Too many links\n"
argument_list|)
expr_stmt|;
else|else
name|err
argument_list|(
literal|"No memory for links\n"
argument_list|)
expr_stmt|;
name|mlinks
operator|=
name|LINKS
expr_stmt|;
name|first
operator|=
literal|0
expr_stmt|;
return|return
literal|1
return|;
block|}
name|ml
index|[
name|mlinks
index|]
operator|->
name|m_dev
operator|=
name|Hdr
operator|.
name|h_dev
expr_stmt|;
name|ml
index|[
name|mlinks
index|]
operator|->
name|m_ino
operator|=
name|Hdr
operator|.
name|h_ino
expr_stmt|;
name|strcpy
argument_list|(
name|ml
index|[
name|mlinks
index|]
operator|->
name|m_name
argument_list|,
name|np
argument_list|)
expr_stmt|;
operator|++
name|mlinks
expr_stmt|;
return|return
literal|1
return|;
block|}
end_block

begin_expr_stmt
name|pentry
argument_list|(
name|namep
argument_list|)
specifier|register
name|char
operator|*
name|namep
expr_stmt|;
end_expr_stmt

begin_block
block|{
specifier|register
name|i
expr_stmt|;
specifier|static
name|short
name|lastid
init|=
operator|-
literal|1
decl_stmt|;
include|#
directive|include
file|<pwd.h>
specifier|static
name|struct
name|passwd
modifier|*
name|pw
decl_stmt|;
name|struct
name|passwd
modifier|*
name|getpwuid
parameter_list|()
function_decl|;
specifier|static
name|char
name|tbuf
index|[
literal|32
index|]
decl_stmt|;
name|printf
argument_list|(
literal|"%-7o"
argument_list|,
name|Hdr
operator|.
name|h_mode
operator|&
literal|0177777
argument_list|)
expr_stmt|;
if|if
condition|(
name|lastid
operator|==
name|Hdr
operator|.
name|h_uid
condition|)
name|printf
argument_list|(
literal|"%-6s"
argument_list|,
name|pw
operator|->
name|pw_name
argument_list|)
expr_stmt|;
else|else
block|{
name|setpwent
argument_list|()
expr_stmt|;
if|if
condition|(
name|pw
operator|=
name|getpwuid
argument_list|(
name|Hdr
operator|.
name|h_uid
argument_list|)
condition|)
block|{
name|printf
argument_list|(
literal|"%-6s"
argument_list|,
name|pw
operator|->
name|pw_name
argument_list|)
expr_stmt|;
name|lastid
operator|=
name|Hdr
operator|.
name|h_uid
expr_stmt|;
block|}
else|else
block|{
name|printf
argument_list|(
literal|"%-6d"
argument_list|,
name|Hdr
operator|.
name|h_uid
argument_list|)
expr_stmt|;
name|lastid
operator|=
operator|-
literal|1
expr_stmt|;
block|}
block|}
name|printf
argument_list|(
literal|"%7ld "
argument_list|,
name|mklong
argument_list|(
name|Hdr
operator|.
name|h_filesize
argument_list|)
argument_list|)
expr_stmt|;
name|U
operator|.
name|l
operator|=
name|mklong
argument_list|(
name|Hdr
operator|.
name|h_mtime
argument_list|)
expr_stmt|;
name|strcpy
argument_list|(
name|tbuf
argument_list|,
name|ctime
argument_list|(
operator|&
name|U
operator|.
name|l
argument_list|)
argument_list|)
expr_stmt|;
name|tbuf
index|[
literal|24
index|]
operator|=
literal|'\0'
expr_stmt|;
name|printf
argument_list|(
literal|" %s  %s\n"
argument_list|,
operator|&
name|tbuf
index|[
literal|4
index|]
argument_list|,
name|namep
argument_list|)
expr_stmt|;
block|}
end_block

begin_macro
name|nmatch
argument_list|(
argument|s
argument_list|,
argument|pat
argument_list|)
end_macro

begin_decl_stmt
name|char
modifier|*
name|s
decl_stmt|,
modifier|*
modifier|*
name|pat
decl_stmt|;
end_decl_stmt

begin_block
block|{
if|if
condition|(
name|EQ
argument_list|(
operator|*
name|pat
argument_list|,
literal|"*"
argument_list|)
condition|)
return|return
literal|1
return|;
while|while
condition|(
operator|*
name|pat
condition|)
block|{
if|if
condition|(
operator|(
operator|*
operator|*
name|pat
operator|==
literal|'!'
operator|&&
operator|!
name|gmatch
argument_list|(
name|s
argument_list|,
operator|*
name|pat
operator|+
literal|1
argument_list|)
operator|)
operator|||
name|gmatch
argument_list|(
name|s
argument_list|,
operator|*
name|pat
argument_list|)
condition|)
return|return
literal|1
return|;
operator|++
name|pat
expr_stmt|;
block|}
return|return
literal|0
return|;
block|}
end_block

begin_expr_stmt
name|gmatch
argument_list|(
name|s
argument_list|,
name|p
argument_list|)
specifier|register
name|char
operator|*
name|s
operator|,
operator|*
name|p
expr_stmt|;
end_expr_stmt

begin_block
block|{
specifier|register
name|int
name|c
decl_stmt|;
specifier|register
name|cc
operator|,
name|ok
operator|,
name|lc
operator|,
name|scc
expr_stmt|;
name|scc
operator|=
operator|*
name|s
expr_stmt|;
name|lc
operator|=
literal|077777
expr_stmt|;
switch|switch
condition|(
name|c
operator|=
operator|*
name|p
condition|)
block|{
case|case
literal|'['
case|:
name|ok
operator|=
literal|0
expr_stmt|;
while|while
condition|(
name|cc
operator|=
operator|*
operator|++
name|p
condition|)
block|{
switch|switch
condition|(
name|cc
condition|)
block|{
case|case
literal|']'
case|:
if|if
condition|(
name|ok
condition|)
return|return
operator|(
name|gmatch
argument_list|(
operator|++
name|s
argument_list|,
operator|++
name|p
argument_list|)
operator|)
return|;
else|else
return|return
operator|(
literal|0
operator|)
return|;
case|case
literal|'-'
case|:
name|ok
operator||=
operator|(
name|lc
operator|<=
name|scc
operator|&
name|scc
operator|<=
operator|(
name|cc
operator|=
name|p
index|[
literal|1
index|]
operator|)
operator|)
expr_stmt|;
block|}
if|if
condition|(
name|scc
operator|==
operator|(
name|lc
operator|=
name|cc
operator|)
condition|)
name|ok
operator|++
expr_stmt|;
block|}
return|return
operator|(
literal|0
operator|)
return|;
case|case
literal|'?'
case|:
name|caseq
label|:
if|if
condition|(
name|scc
condition|)
return|return
operator|(
name|gmatch
argument_list|(
operator|++
name|s
argument_list|,
operator|++
name|p
argument_list|)
operator|)
return|;
return|return
operator|(
literal|0
operator|)
return|;
case|case
literal|'*'
case|:
return|return
operator|(
name|umatch
argument_list|(
name|s
argument_list|,
operator|++
name|p
argument_list|)
operator|)
return|;
case|case
literal|0
case|:
return|return
operator|(
operator|!
name|scc
operator|)
return|;
block|}
if|if
condition|(
name|c
operator|==
name|scc
condition|)
goto|goto
name|caseq
goto|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_block

begin_expr_stmt
name|umatch
argument_list|(
name|s
argument_list|,
name|p
argument_list|)
specifier|register
name|char
operator|*
name|s
operator|,
operator|*
name|p
expr_stmt|;
end_expr_stmt

begin_block
block|{
if|if
condition|(
operator|*
name|p
operator|==
literal|0
condition|)
return|return
operator|(
literal|1
operator|)
return|;
while|while
condition|(
operator|*
name|s
condition|)
if|if
condition|(
name|gmatch
argument_list|(
name|s
operator|++
argument_list|,
name|p
argument_list|)
condition|)
return|return
operator|(
literal|1
operator|)
return|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_block

begin_expr_stmt
name|makdir
argument_list|(
name|namep
argument_list|)
specifier|register
name|char
operator|*
name|namep
expr_stmt|;
end_expr_stmt

begin_block
block|{
specifier|static
name|status
expr_stmt|;
specifier|register
name|pid
expr_stmt|;
if|if
condition|(
name|pid
operator|=
name|fork
argument_list|()
condition|)
while|while
condition|(
name|wait
argument_list|(
operator|&
name|status
argument_list|)
operator|!=
name|pid
condition|)
empty_stmt|;
else|else
block|{
name|close
argument_list|(
literal|2
argument_list|)
expr_stmt|;
name|execl
argument_list|(
literal|"/bin/mkdir"
argument_list|,
literal|"mkdir"
argument_list|,
name|namep
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|2
argument_list|)
expr_stmt|;
block|}
return|return
operator|(
operator|(
name|status
operator|>>
literal|8
operator|)
operator|&
literal|0377
operator|)
condition|?
literal|0
else|:
literal|1
return|;
block|}
end_block

begin_expr_stmt
name|swap
argument_list|(
name|buf
argument_list|,
name|ct
argument_list|)
specifier|register
name|ct
expr_stmt|;
end_expr_stmt

begin_union
specifier|register
union|union
name|swp
block|{
name|short
name|shortw
decl_stmt|;
name|char
name|charv
index|[
literal|2
index|]
decl_stmt|;
block|}
modifier|*
name|buf
union|;
end_union

begin_block
block|{
specifier|register
name|char
name|c
decl_stmt|;
name|ct
operator|=
operator|(
name|ct
operator|+
literal|1
operator|)
operator|>>
literal|1
expr_stmt|;
while|while
condition|(
name|ct
operator|--
condition|)
block|{
name|c
operator|=
name|buf
operator|->
name|charv
index|[
literal|0
index|]
expr_stmt|;
name|buf
operator|->
name|charv
index|[
literal|0
index|]
operator|=
name|buf
operator|->
name|charv
index|[
literal|1
index|]
expr_stmt|;
name|buf
operator|->
name|charv
index|[
literal|1
index|]
operator|=
name|c
expr_stmt|;
operator|++
name|buf
expr_stmt|;
block|}
block|}
end_block

begin_expr_stmt
name|set_time
argument_list|(
name|namep
argument_list|,
name|atime
argument_list|,
name|mtime
argument_list|)
specifier|register
operator|*
name|namep
expr_stmt|;
end_expr_stmt

begin_decl_stmt
name|long
name|atime
decl_stmt|,
name|mtime
decl_stmt|;
end_decl_stmt

begin_block
block|{
specifier|static
name|long
name|timevec
index|[
literal|2
index|]
decl_stmt|;
if|if
condition|(
operator|!
name|Mod_time
condition|)
return|return;
name|timevec
index|[
literal|0
index|]
operator|=
name|atime
expr_stmt|;
name|timevec
index|[
literal|1
index|]
operator|=
name|mtime
expr_stmt|;
name|utime
argument_list|(
name|namep
argument_list|,
name|timevec
argument_list|)
expr_stmt|;
block|}
end_block

begin_macro
name|chgreel
argument_list|(
argument|x
argument_list|,
argument|fl
argument_list|)
end_macro

begin_block
block|{
specifier|register
name|f
expr_stmt|;
name|char
name|str
index|[
literal|22
index|]
decl_stmt|;
name|FILE
modifier|*
name|devtty
decl_stmt|;
name|struct
name|stat
name|statb
decl_stmt|;
name|err
argument_list|(
literal|"errno: %d, "
argument_list|,
name|errno
argument_list|)
expr_stmt|;
name|err
argument_list|(
literal|"Can't %s\n"
argument_list|,
name|x
condition|?
literal|"write output"
else|:
literal|"read input"
argument_list|)
expr_stmt|;
name|fstat
argument_list|(
name|fl
argument_list|,
operator|&
name|statb
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|RT
if|if
condition|(
operator|!
name|MERT
condition|)
block|{
if|if
condition|(
operator|(
name|statb
operator|.
name|st_mode
operator|&
name|S_IFMT
operator|)
operator|!=
name|S_IFCHR
condition|)
name|exit
argument_list|(
literal|2
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|(
name|statb
operator|.
name|st_mode
operator|&
operator|(
name|S_IFBLK
operator||
name|S_IFREC
operator|)
operator|)
operator|==
literal|0
condition|)
name|exit
argument_list|(
literal|2
argument_list|)
expr_stmt|;
endif|#
directive|endif
ifndef|#
directive|ifndef
name|RT
if|if
condition|(
operator|(
name|statb
operator|.
name|st_mode
operator|&
name|S_IFMT
operator|)
operator|!=
name|S_IFCHR
condition|)
name|exit
argument_list|(
literal|2
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|again
label|:
name|err
argument_list|(
literal|"If you want to go on, type device/file name when ready\n"
argument_list|)
expr_stmt|;
name|devtty
operator|=
name|fopen
argument_list|(
literal|"/dev/tty"
argument_list|,
literal|"r"
argument_list|)
expr_stmt|;
name|fgets
argument_list|(
name|str
argument_list|,
literal|20
argument_list|,
name|devtty
argument_list|)
expr_stmt|;
name|str
index|[
name|strlen
argument_list|(
name|str
argument_list|)
operator|-
literal|1
index|]
operator|=
literal|'\0'
expr_stmt|;
if|if
condition|(
operator|!
operator|*
name|str
condition|)
name|exit
argument_list|(
literal|2
argument_list|)
expr_stmt|;
name|close
argument_list|(
name|fl
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|f
operator|=
name|open
argument_list|(
name|str
argument_list|,
name|x
condition|?
literal|1
else|:
literal|0
argument_list|)
operator|)
operator|<
literal|0
condition|)
block|{
name|err
argument_list|(
literal|"That didn't work"
argument_list|)
expr_stmt|;
name|fclose
argument_list|(
name|devtty
argument_list|)
expr_stmt|;
goto|goto
name|again
goto|;
block|}
return|return
name|f
return|;
block|}
end_block

begin_expr_stmt
name|missdir
argument_list|(
name|namep
argument_list|)
specifier|register
name|char
operator|*
name|namep
expr_stmt|;
end_expr_stmt

begin_block
block|{
specifier|register
name|char
modifier|*
name|np
decl_stmt|;
specifier|register
name|ct
operator|=
literal|0
expr_stmt|;
if|if
condition|(
operator|!
name|Dir
condition|)
return|return
literal|0
return|;
for|for
control|(
name|np
operator|=
name|namep
init|;
operator|*
name|np
condition|;
operator|++
name|np
control|)
if|if
condition|(
operator|*
name|np
operator|==
literal|'/'
condition|)
block|{
operator|*
name|np
operator|=
literal|'\0'
expr_stmt|;
if|if
condition|(
name|stat
argument_list|(
name|namep
argument_list|,
operator|&
name|Xstatb
argument_list|)
operator|==
operator|-
literal|1
condition|)
name|makdir
argument_list|(
name|namep
argument_list|)
operator|,
operator|++
name|ct
expr_stmt|;
operator|*
name|np
operator|=
literal|'/'
expr_stmt|;
block|}
return|return
name|ct
return|;
block|}
end_block

begin_macro
name|err
argument_list|(
argument|a
argument_list|,
argument|b
argument_list|,
argument|c
argument_list|)
end_macro

begin_block
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
name|a
argument_list|,
name|b
argument_list|,
name|c
argument_list|)
expr_stmt|;
block|}
end_block

begin_macro
name|pwd
argument_list|()
end_macro

begin_block
block|{
name|FILE
modifier|*
name|dir
decl_stmt|;
name|dir
operator|=
name|popen
argument_list|(
literal|"pwd"
argument_list|,
literal|"r"
argument_list|)
expr_stmt|;
name|fgets
argument_list|(
name|Fullname
argument_list|,
literal|256
argument_list|,
name|dir
argument_list|)
expr_stmt|;
if|if
condition|(
name|pclose
argument_list|(
name|dir
argument_list|)
condition|)
name|exit
argument_list|(
literal|2
argument_list|)
expr_stmt|;
name|Pathend
operator|=
name|strlen
argument_list|(
name|Fullname
argument_list|)
expr_stmt|;
name|Fullname
index|[
name|Pathend
operator|-
literal|1
index|]
operator|=
literal|'/'
expr_stmt|;
block|}
end_block

begin_function
name|char
modifier|*
name|cd
parameter_list|(
name|n
parameter_list|)
specifier|register
name|char
modifier|*
name|n
decl_stmt|;
block|{
name|char
modifier|*
name|p_save
init|=
name|Name
decl_stmt|,
modifier|*
name|n_save
init|=
name|n
decl_stmt|,
modifier|*
name|p_end
init|=
literal|0
decl_stmt|;
specifier|register
name|char
modifier|*
name|p
init|=
name|Name
decl_stmt|;
specifier|static
name|char
name|dotdot
index|[]
init|=
literal|"../../../../../../../../../../../../../../../../../../../../../../../../../../../../../../../../"
decl_stmt|;
name|int
name|slashes
decl_stmt|;
if|if
condition|(
operator|*
name|n
operator|==
literal|'/'
condition|)
comment|/* don't try to chdir on full pathnames */
return|return
name|n
return|;
for|for
control|(
init|;
operator|*
name|p
operator|&&
operator|*
name|n
operator|==
operator|*
name|p
condition|;
operator|++
name|p
operator|,
operator|++
name|n
control|)
block|{
comment|/* whatever part of strings == */
if|if
condition|(
operator|*
name|p
operator|==
literal|'/'
condition|)
name|p_save
operator|=
name|p
operator|+
literal|1
operator|,
name|n_save
operator|=
name|n
operator|+
literal|1
expr_stmt|;
block|}
name|p
operator|=
name|p_save
expr_stmt|;
operator|*
name|p
operator|++
operator|=
literal|'\0'
expr_stmt|;
for|for
control|(
name|slashes
operator|=
literal|0
init|;
operator|*
name|p
condition|;
operator|++
name|p
control|)
block|{
comment|/* if prev is longer, chdir("..") */
if|if
condition|(
operator|*
name|p
operator|==
literal|'/'
condition|)
operator|++
name|slashes
expr_stmt|;
block|}
name|p
operator|=
name|p_save
expr_stmt|;
if|if
condition|(
name|slashes
condition|)
block|{
name|slashes
operator|=
name|slashes
operator|*
literal|3
operator|-
literal|1
expr_stmt|;
name|dotdot
index|[
name|slashes
index|]
operator|=
literal|'\0'
expr_stmt|;
name|chdir
argument_list|(
name|dotdot
argument_list|)
expr_stmt|;
name|dotdot
index|[
name|slashes
index|]
operator|=
literal|'/'
expr_stmt|;
block|}
name|n
operator|=
name|n_save
expr_stmt|;
for|for
control|(
init|;
operator|*
name|n
condition|;
operator|++
name|n
operator|,
operator|++
name|p
control|)
block|{
operator|*
name|p
operator|=
operator|*
name|n
expr_stmt|;
if|if
condition|(
operator|*
name|n
operator|==
literal|'/'
condition|)
name|p_end
operator|=
name|p
operator|+
literal|1
operator|,
name|n_save
operator|=
name|n
operator|+
literal|1
expr_stmt|;
block|}
operator|*
name|p
operator|=
literal|'\0'
expr_stmt|;
if|if
condition|(
name|p_end
condition|)
block|{
operator|*
name|p_end
operator|=
literal|'\0'
expr_stmt|;
if|if
condition|(
name|chdir
argument_list|(
name|p_save
argument_list|)
operator|==
operator|-
literal|1
condition|)
block|{
if|if
condition|(
operator|!
name|missdir
argument_list|(
name|p_save
argument_list|)
condition|)
block|{
name|cd_err
label|:
name|err
argument_list|(
literal|"Cannot chdir (no `d' option)\n"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|2
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|chdir
argument_list|(
name|p_save
argument_list|)
operator|==
operator|-
literal|1
condition|)
goto|goto
name|cd_err
goto|;
block|}
block|}
else|else
operator|*
name|p_save
operator|=
literal|'\0'
expr_stmt|;
return|return
name|n_save
return|;
block|}
end_function

begin_ifdef
ifdef|#
directive|ifdef
name|RT
end_ifdef

begin_macro
name|actsize
argument_list|()
end_macro

begin_block
block|{ }
end_block

begin_endif
endif|#
directive|endif
end_endif

end_unit


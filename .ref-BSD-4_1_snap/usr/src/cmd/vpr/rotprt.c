begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_include
include|#
directive|include
file|<vfont.h>
end_include

begin_include
include|#
directive|include
file|<sys/types.h>
end_include

begin_include
include|#
directive|include
file|<sys/stat.h>
end_include

begin_decl_stmt
name|char
modifier|*
name|chp
decl_stmt|;
end_decl_stmt

begin_function_decl
name|char
modifier|*
name|sbrk
parameter_list|()
function_decl|;
end_function_decl

begin_function
name|main
parameter_list|(
name|argc
parameter_list|,
name|argv
parameter_list|)
name|char
modifier|*
modifier|*
name|argv
decl_stmt|;
block|{
name|struct
name|header
name|h
decl_stmt|;
name|struct
name|dispatch
name|d
index|[
literal|256
index|]
decl_stmt|;
name|struct
name|stat
name|stb
decl_stmt|;
name|off_t
name|tell
parameter_list|()
function_decl|;
name|int
name|i
decl_stmt|,
name|size
decl_stmt|;
name|argc
operator|--
operator|,
name|argv
operator|++
expr_stmt|;
if|if
condition|(
name|argc
operator|>
literal|0
condition|)
block|{
name|close
argument_list|(
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|open
argument_list|(
name|argv
index|[
literal|0
index|]
argument_list|,
literal|0
argument_list|)
operator|<
literal|0
condition|)
name|perror
argument_list|(
name|argv
index|[
literal|0
index|]
argument_list|)
operator|,
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|read
argument_list|(
literal|0
argument_list|,
operator|&
name|h
argument_list|,
sizeof|sizeof
argument_list|(
name|h
argument_list|)
argument_list|)
operator|!=
sizeof|sizeof
argument_list|(
name|h
argument_list|)
condition|)
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"header read error\n"
argument_list|)
operator|,
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|h
operator|.
name|magic
operator|!=
literal|0436
condition|)
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"bad magic number\n"
argument_list|)
operator|,
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|read
argument_list|(
literal|0
argument_list|,
name|d
argument_list|,
sizeof|sizeof
argument_list|(
name|d
argument_list|)
argument_list|)
operator|!=
sizeof|sizeof
argument_list|(
name|d
argument_list|)
condition|)
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"dispatch read error\n"
argument_list|)
operator|,
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
name|fstat
argument_list|(
literal|0
argument_list|,
operator|&
name|stb
argument_list|)
expr_stmt|;
name|size
operator|=
name|stb
operator|.
name|st_size
operator|-
name|tell
argument_list|(
literal|0
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"%d bytes of characters\n"
argument_list|,
name|size
argument_list|)
expr_stmt|;
name|chp
operator|=
name|sbrk
argument_list|(
name|size
argument_list|)
expr_stmt|;
name|read
argument_list|(
literal|0
argument_list|,
name|chp
argument_list|,
name|size
argument_list|)
expr_stmt|;
comment|/* write(1,&h, sizeof (h)); */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|256
condition|;
name|i
operator|++
control|)
name|rprt
argument_list|(
name|i
argument_list|,
operator|&
name|d
index|[
name|i
index|]
argument_list|,
name|chp
operator|+
name|d
index|[
name|i
index|]
operator|.
name|addr
argument_list|)
expr_stmt|;
block|}
end_function

begin_macro
name|rprt
argument_list|(
argument|i
argument_list|,
argument|dp
argument_list|,
argument|cp
argument_list|)
end_macro

begin_decl_stmt
name|int
name|i
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|struct
name|dispatch
modifier|*
name|dp
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|char
modifier|*
name|cp
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|int
name|bpl
decl_stmt|,
name|j
decl_stmt|;
if|if
condition|(
name|dp
operator|->
name|nbytes
operator|==
literal|0
condition|)
return|return;
if|if
condition|(
name|i
operator|>=
literal|0200
condition|)
name|printf
argument_list|(
literal|"M-"
argument_list|)
operator|,
name|i
operator|-=
literal|0200
expr_stmt|;
if|if
condition|(
name|i
operator|<
literal|040
condition|)
name|printf
argument_list|(
literal|"^%c"
argument_list|,
name|i
operator||
literal|'@'
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|i
operator|==
literal|0177
condition|)
name|printf
argument_list|(
literal|"^?"
argument_list|)
expr_stmt|;
else|else
name|printf
argument_list|(
literal|"%c"
argument_list|,
name|i
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"%d bytes, l %d r %d u %d d %d:\n"
argument_list|,
name|dp
operator|->
name|nbytes
argument_list|,
name|dp
operator|->
name|left
argument_list|,
name|dp
operator|->
name|right
argument_list|,
name|dp
operator|->
name|up
argument_list|,
name|dp
operator|->
name|down
argument_list|)
expr_stmt|;
name|bpl
operator|=
operator|(
name|dp
operator|->
name|up
operator|+
name|dp
operator|->
name|down
operator|+
literal|7
operator|)
operator|/
literal|8
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|dp
operator|->
name|right
operator|+
name|dp
operator|->
name|left
condition|;
name|i
operator|++
control|)
block|{
for|for
control|(
name|j
operator|=
literal|0
init|;
name|j
operator|<
name|bpl
condition|;
name|j
operator|++
control|)
name|pbits
argument_list|(
name|cp
index|[
name|j
index|]
argument_list|)
expr_stmt|;
name|cp
operator|+=
name|bpl
expr_stmt|;
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
block|}
name|printf
argument_list|(
literal|"========\n"
argument_list|)
expr_stmt|;
block|}
end_block

begin_expr_stmt
name|pbits
argument_list|(
name|i
argument_list|)
specifier|register
name|int
name|i
expr_stmt|;
end_expr_stmt

begin_block
block|{
specifier|register
name|int
name|j
decl_stmt|;
for|for
control|(
name|j
operator|=
literal|8
init|;
name|j
operator|>
literal|0
condition|;
name|j
operator|--
control|)
block|{
name|printf
argument_list|(
operator|(
name|i
operator|&
literal|0x80
operator|)
condition|?
literal|" *"
else|:
literal|"  "
argument_list|)
expr_stmt|;
name|i
operator|<<=
literal|1
expr_stmt|;
block|}
block|}
end_block

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Reads standard graphics input  * Makes a plot on a 200 dot-per-inch 11" wide  * Versatek plotter.  *  * Creates and leaves /usr/tmp/raster (1000 blocks)  * which is the bitmap  */
end_comment

begin_include
include|#
directive|include
file|"stdio.h"
end_include

begin_include
include|#
directive|include
file|<signal.h>
end_include

begin_define
define|#
directive|define
name|NB
value|88
end_define

begin_define
define|#
directive|define
name|BSIZ
value|512
end_define

begin_define
define|#
directive|define
name|mapx
parameter_list|(
name|x
parameter_list|)
value|((1536*((x)-botx)/del)+centx)
end_define

begin_define
define|#
directive|define
name|mapy
parameter_list|(
name|y
parameter_list|)
value|((1536*(del-(y)+boty)/del)-centy)
end_define

begin_define
define|#
directive|define
name|SOLID
value|-1
end_define

begin_define
define|#
directive|define
name|DOTTED
value|014
end_define

begin_define
define|#
directive|define
name|SHORTDASHED
value|034
end_define

begin_define
define|#
directive|define
name|DOTDASHED
value|054
end_define

begin_define
define|#
directive|define
name|LONGDASHED
value|074
end_define

begin_define
define|#
directive|define
name|SETSTATE
value|(('v'<<8)+1)
end_define

begin_decl_stmt
name|int
name|linmod
init|=
name|SOLID
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|again
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|done1
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|char
name|chrtab
index|[]
index|[
literal|16
index|]
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|plotcom
index|[]
init|=
block|{
literal|0200
block|,
literal|0
block|,
literal|0
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|eotcom
index|[]
init|=
block|{
literal|0210
block|,
literal|0
block|,
literal|0
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|char
name|blocks
index|[
name|NB
index|]
index|[
name|BSIZ
index|]
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|obuf
index|[
literal|264
index|]
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|lastx
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|lasty
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|double
name|topx
init|=
literal|1536
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|double
name|topy
init|=
literal|1536
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|double
name|botx
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|double
name|boty
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|centx
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|centy
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|double
name|delx
init|=
literal|1536
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|double
name|dely
init|=
literal|1536
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|double
name|del
init|=
literal|1536
decl_stmt|;
end_decl_stmt

begin_struct
struct|struct
name|buf
block|{
name|int
name|bno
decl_stmt|;
name|char
modifier|*
name|block
decl_stmt|;
block|}
struct|;
end_struct

begin_decl_stmt
name|struct
name|buf
name|bufs
index|[
name|NB
index|]
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|in
decl_stmt|,
name|out
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|char
modifier|*
name|picture
init|=
literal|"/usr/tmp/raster"
decl_stmt|;
end_decl_stmt

begin_function
name|main
parameter_list|(
name|argc
parameter_list|,
name|argv
parameter_list|)
name|char
modifier|*
modifier|*
name|argv
decl_stmt|;
block|{
specifier|extern
name|int
name|onintr
parameter_list|()
function_decl|;
specifier|register
name|i
expr_stmt|;
if|if
condition|(
name|argc
operator|>
literal|1
condition|)
block|{
name|in
operator|=
name|open
argument_list|(
name|argv
index|[
literal|1
index|]
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|putpict
argument_list|()
expr_stmt|;
name|exit
argument_list|(
literal|0
argument_list|)
expr_stmt|;
block|}
name|signal
argument_list|(
name|SIGTERM
argument_list|,
name|onintr
argument_list|)
expr_stmt|;
if|if
condition|(
name|signal
argument_list|(
name|SIGINT
argument_list|,
name|SIG_IGN
argument_list|)
operator|!=
name|SIG_IGN
condition|)
name|signal
argument_list|(
name|SIGINT
argument_list|,
name|onintr
argument_list|)
expr_stmt|;
name|another
label|:
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|NB
condition|;
name|i
operator|++
control|)
block|{
name|bufs
index|[
name|i
index|]
operator|.
name|bno
operator|=
operator|-
literal|1
expr_stmt|;
name|bufs
index|[
name|i
index|]
operator|.
name|block
operator|=
name|blocks
index|[
name|i
index|]
expr_stmt|;
block|}
name|out
operator|=
name|creat
argument_list|(
name|picture
argument_list|,
literal|0666
argument_list|)
expr_stmt|;
name|in
operator|=
name|open
argument_list|(
name|picture
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|zseek
argument_list|(
name|out
argument_list|,
literal|32
operator|*
literal|32
argument_list|)
expr_stmt|;
name|write
argument_list|(
name|out
argument_list|,
name|blocks
index|[
literal|0
index|]
argument_list|,
name|BSIZ
argument_list|)
expr_stmt|;
comment|/*delete following code when filsys deals properly with holes in files*/
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|512
condition|;
name|i
operator|++
control|)
name|blocks
index|[
literal|0
index|]
index|[
name|i
index|]
operator|=
literal|0
expr_stmt|;
name|zseek
argument_list|(
name|out
argument_list|,
literal|0
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|32
operator|*
literal|32
condition|;
name|i
operator|++
control|)
name|write
argument_list|(
name|out
argument_list|,
name|blocks
index|[
literal|0
index|]
argument_list|,
literal|512
argument_list|)
expr_stmt|;
comment|/**/
name|getpict
argument_list|()
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|NB
condition|;
name|i
operator|++
control|)
if|if
condition|(
name|bufs
index|[
name|i
index|]
operator|.
name|bno
operator|!=
operator|-
literal|1
condition|)
block|{
name|zseek
argument_list|(
name|out
argument_list|,
name|bufs
index|[
name|i
index|]
operator|.
name|bno
argument_list|)
expr_stmt|;
name|write
argument_list|(
name|out
argument_list|,
name|bufs
index|[
name|i
index|]
operator|.
name|block
argument_list|,
name|BSIZ
argument_list|)
expr_stmt|;
block|}
name|putpict
argument_list|()
expr_stmt|;
if|if
condition|(
name|again
condition|)
block|{
name|close
argument_list|(
name|in
argument_list|)
expr_stmt|;
name|close
argument_list|(
name|out
argument_list|)
expr_stmt|;
goto|goto
name|another
goto|;
block|}
name|exit
argument_list|(
literal|0
argument_list|)
expr_stmt|;
block|}
end_function

begin_macro
name|getpict
argument_list|()
end_macro

begin_block
block|{
specifier|register
name|x1
operator|,
name|y1
expr_stmt|;
name|again
operator|=
literal|0
expr_stmt|;
for|for
control|(
init|;
condition|;
control|)
switch|switch
condition|(
name|x1
operator|=
name|getc
argument_list|(
name|stdin
argument_list|)
condition|)
block|{
case|case
literal|'s'
case|:
name|botx
operator|=
name|getw
argument_list|(
name|stdin
argument_list|)
expr_stmt|;
name|boty
operator|=
name|getw
argument_list|(
name|stdin
argument_list|)
expr_stmt|;
name|topx
operator|=
name|getw
argument_list|(
name|stdin
argument_list|)
expr_stmt|;
name|topy
operator|=
name|getw
argument_list|(
name|stdin
argument_list|)
expr_stmt|;
name|delx
operator|=
name|topx
operator|-
name|botx
expr_stmt|;
name|dely
operator|=
name|topy
operator|-
name|boty
expr_stmt|;
if|if
condition|(
name|dely
operator|/
name|delx
operator|>
literal|1536.
operator|/
literal|2048.
condition|)
name|del
operator|=
name|dely
expr_stmt|;
else|else
name|del
operator|=
name|delx
operator|*
operator|(
literal|1566.
operator|/
literal|2048.
operator|)
expr_stmt|;
name|centx
operator|=
literal|0
expr_stmt|;
name|centx
operator|=
operator|(
literal|2048
operator|-
name|mapx
argument_list|(
name|topx
argument_list|)
operator|)
operator|/
literal|2
expr_stmt|;
name|centy
operator|=
literal|0
expr_stmt|;
name|centy
operator|=
name|mapy
argument_list|(
name|topy
argument_list|)
operator|/
literal|2
expr_stmt|;
continue|continue;
case|case
literal|'l'
case|:
name|done1
operator||=
literal|01
expr_stmt|;
name|x1
operator|=
name|mapx
argument_list|(
name|getw
argument_list|(
name|stdin
argument_list|)
argument_list|)
expr_stmt|;
name|y1
operator|=
name|mapy
argument_list|(
name|getw
argument_list|(
name|stdin
argument_list|)
argument_list|)
expr_stmt|;
name|lastx
operator|=
name|mapx
argument_list|(
name|getw
argument_list|(
name|stdin
argument_list|)
argument_list|)
expr_stmt|;
name|lasty
operator|=
name|mapy
argument_list|(
name|getw
argument_list|(
name|stdin
argument_list|)
argument_list|)
expr_stmt|;
name|line
argument_list|(
name|x1
argument_list|,
name|y1
argument_list|,
name|lastx
argument_list|,
name|lasty
argument_list|)
expr_stmt|;
continue|continue;
case|case
literal|'m'
case|:
name|lastx
operator|=
name|mapx
argument_list|(
name|getw
argument_list|(
name|stdin
argument_list|)
argument_list|)
expr_stmt|;
name|lasty
operator|=
name|mapy
argument_list|(
name|getw
argument_list|(
name|stdin
argument_list|)
argument_list|)
expr_stmt|;
continue|continue;
case|case
literal|'t'
case|:
name|done1
operator||=
literal|01
expr_stmt|;
while|while
condition|(
operator|(
name|x1
operator|=
name|getc
argument_list|(
name|stdin
argument_list|)
operator|)
operator|!=
literal|'\n'
condition|)
name|plotch
argument_list|(
name|x1
argument_list|)
expr_stmt|;
continue|continue;
case|case
literal|'e'
case|:
if|if
condition|(
name|done1
condition|)
block|{
name|again
operator|++
expr_stmt|;
return|return;
block|}
continue|continue;
case|case
literal|'p'
case|:
name|done1
operator||=
literal|01
expr_stmt|;
name|lastx
operator|=
name|mapx
argument_list|(
name|getw
argument_list|(
name|stdin
argument_list|)
argument_list|)
expr_stmt|;
name|lasty
operator|=
name|mapy
argument_list|(
name|getw
argument_list|(
name|stdin
argument_list|)
argument_list|)
expr_stmt|;
name|point
argument_list|(
name|lastx
argument_list|,
name|lasty
argument_list|)
expr_stmt|;
name|point
argument_list|(
name|lastx
operator|+
literal|1
argument_list|,
name|lasty
argument_list|)
expr_stmt|;
name|point
argument_list|(
name|lastx
argument_list|,
name|lasty
operator|+
literal|1
argument_list|)
expr_stmt|;
name|point
argument_list|(
name|lastx
operator|+
literal|1
argument_list|,
name|lasty
operator|+
literal|1
argument_list|)
expr_stmt|;
continue|continue;
case|case
literal|'n'
case|:
name|done1
operator||=
literal|01
expr_stmt|;
name|x1
operator|=
name|mapx
argument_list|(
name|getw
argument_list|(
name|stdin
argument_list|)
argument_list|)
expr_stmt|;
name|y1
operator|=
name|mapy
argument_list|(
name|getw
argument_list|(
name|stdin
argument_list|)
argument_list|)
expr_stmt|;
name|line
argument_list|(
name|lastx
argument_list|,
name|lasty
argument_list|,
name|x1
argument_list|,
name|y1
argument_list|)
expr_stmt|;
name|lastx
operator|=
name|x1
expr_stmt|;
name|lasty
operator|=
name|y1
expr_stmt|;
continue|continue;
case|case
literal|'f'
case|:
name|getw
argument_list|(
name|stdin
argument_list|)
expr_stmt|;
name|getc
argument_list|(
name|stdin
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|getc
argument_list|(
name|stdin
argument_list|)
condition|)
block|{
case|case
literal|'t'
case|:
name|linmod
operator|=
name|DOTTED
expr_stmt|;
break|break;
default|default:
case|case
literal|'i'
case|:
name|linmod
operator|=
name|SOLID
expr_stmt|;
break|break;
case|case
literal|'g'
case|:
name|linmod
operator|=
name|LONGDASHED
expr_stmt|;
break|break;
case|case
literal|'r'
case|:
name|linmod
operator|=
name|SHORTDASHED
expr_stmt|;
break|break;
case|case
literal|'d'
case|:
name|linmod
operator|=
name|DOTDASHED
expr_stmt|;
break|break;
block|}
while|while
condition|(
operator|(
name|x1
operator|=
name|getc
argument_list|(
name|stdin
argument_list|)
operator|)
operator|!=
literal|'\n'
condition|)
if|if
condition|(
name|x1
operator|==
operator|-
literal|1
condition|)
return|return;
continue|continue;
case|case
literal|'d'
case|:
name|getw
argument_list|(
name|stdin
argument_list|)
expr_stmt|;
name|getw
argument_list|(
name|stdin
argument_list|)
expr_stmt|;
name|getw
argument_list|(
name|stdin
argument_list|)
expr_stmt|;
name|x1
operator|=
name|getw
argument_list|(
name|stdin
argument_list|)
expr_stmt|;
while|while
condition|(
operator|--
name|x1
operator|>=
literal|0
condition|)
name|getw
argument_list|(
name|stdin
argument_list|)
expr_stmt|;
continue|continue;
case|case
operator|-
literal|1
case|:
return|return;
default|default:
name|printf
argument_list|(
literal|"Botch\n"
argument_list|)
expr_stmt|;
return|return;
block|}
block|}
end_block

begin_expr_stmt
name|plotch
argument_list|(
name|c
argument_list|)
specifier|register
name|c
expr_stmt|;
end_expr_stmt

begin_block
block|{
specifier|register
name|j
expr_stmt|;
specifier|register
name|char
modifier|*
name|cp
decl_stmt|;
name|int
name|i
decl_stmt|;
if|if
condition|(
name|c
operator|<
literal|' '
operator|||
name|c
operator|>
literal|0177
condition|)
return|return;
name|cp
operator|=
name|chrtab
index|[
name|c
operator|-
literal|' '
index|]
expr_stmt|;
for|for
control|(
name|i
operator|=
operator|-
literal|16
init|;
name|i
operator|<
literal|16
condition|;
name|i
operator|+=
literal|2
control|)
block|{
name|c
operator|=
operator|*
name|cp
operator|++
expr_stmt|;
for|for
control|(
name|j
operator|=
literal|7
init|;
name|j
operator|>=
literal|0
condition|;
operator|--
name|j
control|)
if|if
condition|(
operator|(
name|c
operator|>>
name|j
operator|)
operator|&
literal|1
condition|)
block|{
name|point
argument_list|(
name|lastx
operator|+
literal|6
operator|-
name|j
operator|*
literal|2
argument_list|,
name|lasty
operator|+
name|i
argument_list|)
expr_stmt|;
name|point
argument_list|(
name|lastx
operator|+
literal|7
operator|-
name|j
operator|*
literal|2
argument_list|,
name|lasty
operator|+
name|i
argument_list|)
expr_stmt|;
name|point
argument_list|(
name|lastx
operator|+
literal|6
operator|-
name|j
operator|*
literal|2
argument_list|,
name|lasty
operator|+
name|i
operator|+
literal|1
argument_list|)
expr_stmt|;
name|point
argument_list|(
name|lastx
operator|+
literal|7
operator|-
name|j
operator|*
literal|2
argument_list|,
name|lasty
operator|+
name|i
operator|+
literal|1
argument_list|)
expr_stmt|;
block|}
block|}
name|lastx
operator|+=
literal|16
expr_stmt|;
block|}
end_block

begin_decl_stmt
name|int
name|f
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* versatec file number */
end_comment

begin_macro
name|putpict
argument_list|()
end_macro

begin_block
block|{
specifier|register
name|x
operator|,
operator|*
name|ip
operator|,
operator|*
name|op
expr_stmt|;
name|int
name|y
decl_stmt|;
if|if
condition|(
name|f
operator|==
literal|0
condition|)
block|{
name|f
operator|=
name|open
argument_list|(
literal|"/dev/vp0"
argument_list|,
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|f
operator|<
literal|0
condition|)
block|{
name|printf
argument_list|(
literal|"Cannot open vp\n"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
name|ioctl
argument_list|(
name|f
argument_list|,
name|SETSTATE
argument_list|,
name|plotcom
argument_list|)
expr_stmt|;
block|}
name|op
operator|=
name|obuf
expr_stmt|;
name|lseek
argument_list|(
name|in
argument_list|,
literal|0L
argument_list|,
literal|0
argument_list|)
expr_stmt|;
for|for
control|(
name|y
operator|=
literal|0
init|;
name|y
operator|<
literal|2048
condition|;
name|y
operator|++
control|)
block|{
if|if
condition|(
operator|(
name|y
operator|&
literal|077
operator|)
operator|==
literal|0
condition|)
name|read
argument_list|(
name|in
argument_list|,
name|blocks
index|[
literal|0
index|]
argument_list|,
literal|32
operator|*
name|BSIZ
argument_list|)
expr_stmt|;
for|for
control|(
name|x
operator|=
literal|0
init|;
name|x
operator|<
literal|32
condition|;
name|x
operator|++
control|)
block|{
name|ip
operator|=
operator|(
name|int
operator|*
operator|)
operator|&
name|blocks
index|[
name|x
index|]
index|[
operator|(
name|y
operator|&
literal|077
operator|)
operator|<<
literal|3
index|]
expr_stmt|;
operator|*
name|op
operator|++
operator|=
operator|*
name|ip
operator|++
expr_stmt|;
operator|*
name|op
operator|++
operator|=
operator|*
name|ip
operator|++
expr_stmt|;
operator|*
name|op
operator|++
operator|=
operator|*
name|ip
operator|++
expr_stmt|;
operator|*
name|op
operator|++
operator|=
operator|*
name|ip
operator|++
expr_stmt|;
block|}
operator|*
name|op
operator|++
operator|=
literal|0
expr_stmt|;
operator|*
name|op
operator|++
operator|=
literal|0
expr_stmt|;
operator|*
name|op
operator|++
operator|=
literal|0
expr_stmt|;
operator|*
name|op
operator|++
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|y
operator|&
literal|1
condition|)
block|{
name|write
argument_list|(
name|f
argument_list|,
operator|(
name|char
operator|*
operator|)
name|obuf
argument_list|,
sizeof|sizeof
argument_list|(
name|obuf
argument_list|)
argument_list|)
expr_stmt|;
name|op
operator|=
name|obuf
expr_stmt|;
block|}
block|}
block|}
end_block

begin_expr_stmt
name|line
argument_list|(
name|x0
argument_list|,
name|y0
argument_list|,
name|x1
argument_list|,
name|y1
argument_list|)
specifier|register
name|x0
operator|,
name|y0
expr_stmt|;
end_expr_stmt

begin_block
block|{
name|int
name|dx
decl_stmt|,
name|dy
decl_stmt|;
name|int
name|xinc
decl_stmt|,
name|yinc
decl_stmt|;
specifier|register
name|res1
expr_stmt|;
name|int
name|res2
decl_stmt|;
name|int
name|slope
decl_stmt|;
name|xinc
operator|=
literal|1
expr_stmt|;
name|yinc
operator|=
literal|1
expr_stmt|;
if|if
condition|(
operator|(
name|dx
operator|=
name|x1
operator|-
name|x0
operator|)
operator|<
literal|0
condition|)
block|{
name|xinc
operator|=
operator|-
literal|1
expr_stmt|;
name|dx
operator|=
operator|-
name|dx
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|dy
operator|=
name|y1
operator|-
name|y0
operator|)
operator|<
literal|0
condition|)
block|{
name|yinc
operator|=
operator|-
literal|1
expr_stmt|;
name|dy
operator|=
operator|-
name|dy
expr_stmt|;
block|}
name|slope
operator|=
name|xinc
operator|*
name|yinc
expr_stmt|;
name|res1
operator|=
literal|0
expr_stmt|;
name|res2
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|dx
operator|>=
name|dy
condition|)
while|while
condition|(
name|x0
operator|!=
name|x1
condition|)
block|{
if|if
condition|(
operator|(
name|x0
operator|+
name|slope
operator|*
name|y0
operator|)
operator|&
name|linmod
condition|)
if|if
condition|(
operator|(
operator|(
name|x0
operator|>>
literal|6
operator|)
operator|+
operator|(
operator|(
name|y0
operator|&
operator|~
literal|077
operator|)
operator|>>
literal|1
operator|)
operator|)
operator|==
name|bufs
index|[
literal|0
index|]
operator|.
name|bno
condition|)
name|bufs
index|[
literal|0
index|]
operator|.
name|block
index|[
operator|(
operator|(
name|y0
operator|&
literal|077
operator|)
operator|<<
literal|3
operator|)
operator|+
operator|(
operator|(
name|x0
operator|>>
literal|3
operator|)
operator|&
literal|07
operator|)
index|]
operator||=
literal|1
operator|<<
operator|(
literal|7
operator|-
operator|(
name|x0
operator|&
literal|07
operator|)
operator|)
expr_stmt|;
else|else
name|point
argument_list|(
name|x0
argument_list|,
name|y0
argument_list|)
expr_stmt|;
if|if
condition|(
name|res1
operator|>
name|res2
condition|)
block|{
name|res2
operator|+=
name|dx
operator|-
name|res1
expr_stmt|;
name|res1
operator|=
literal|0
expr_stmt|;
name|y0
operator|+=
name|yinc
expr_stmt|;
block|}
name|res1
operator|+=
name|dy
expr_stmt|;
name|x0
operator|+=
name|xinc
expr_stmt|;
block|}
else|else
while|while
condition|(
name|y0
operator|!=
name|y1
condition|)
block|{
if|if
condition|(
operator|(
name|x0
operator|+
name|slope
operator|*
name|y0
operator|)
operator|&
name|linmod
condition|)
if|if
condition|(
operator|(
operator|(
name|x0
operator|>>
literal|6
operator|)
operator|+
operator|(
operator|(
name|y0
operator|&
operator|~
literal|077
operator|)
operator|>>
literal|1
operator|)
operator|)
operator|==
name|bufs
index|[
literal|0
index|]
operator|.
name|bno
condition|)
name|bufs
index|[
literal|0
index|]
operator|.
name|block
index|[
operator|(
operator|(
name|y0
operator|&
literal|077
operator|)
operator|<<
literal|3
operator|)
operator|+
operator|(
operator|(
name|x0
operator|>>
literal|3
operator|)
operator|&
literal|07
operator|)
index|]
operator||=
literal|1
operator|<<
operator|(
literal|7
operator|-
operator|(
name|x0
operator|&
literal|07
operator|)
operator|)
expr_stmt|;
else|else
name|point
argument_list|(
name|x0
argument_list|,
name|y0
argument_list|)
expr_stmt|;
if|if
condition|(
name|res1
operator|>
name|res2
condition|)
block|{
name|res2
operator|+=
name|dy
operator|-
name|res1
expr_stmt|;
name|res1
operator|=
literal|0
expr_stmt|;
name|x0
operator|+=
name|xinc
expr_stmt|;
block|}
name|res1
operator|+=
name|dx
expr_stmt|;
name|y0
operator|+=
name|yinc
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|x1
operator|+
name|slope
operator|*
name|y1
operator|)
operator|&
name|linmod
condition|)
if|if
condition|(
operator|(
operator|(
name|x1
operator|>>
literal|6
operator|)
operator|+
operator|(
operator|(
name|y1
operator|&
operator|~
literal|077
operator|)
operator|>>
literal|1
operator|)
operator|)
operator|==
name|bufs
index|[
literal|0
index|]
operator|.
name|bno
condition|)
name|bufs
index|[
literal|0
index|]
operator|.
name|block
index|[
operator|(
operator|(
name|y1
operator|&
literal|077
operator|)
operator|<<
literal|3
operator|)
operator|+
operator|(
operator|(
name|x1
operator|>>
literal|3
operator|)
operator|&
literal|07
operator|)
index|]
operator||=
literal|1
operator|<<
operator|(
literal|7
operator|-
operator|(
name|x1
operator|&
literal|07
operator|)
operator|)
expr_stmt|;
else|else
name|point
argument_list|(
name|x1
argument_list|,
name|y1
argument_list|)
expr_stmt|;
block|}
end_block

begin_expr_stmt
name|point
argument_list|(
name|x
argument_list|,
name|y
argument_list|)
specifier|register
name|x
operator|,
name|y
expr_stmt|;
end_expr_stmt

begin_block
block|{
specifier|register
name|bno
expr_stmt|;
name|bno
operator|=
operator|(
operator|(
name|x
operator|&
literal|03700
operator|)
operator|>>
literal|6
operator|)
operator|+
operator|(
operator|(
name|y
operator|&
literal|03700
operator|)
operator|>>
literal|1
operator|)
expr_stmt|;
if|if
condition|(
name|bno
operator|!=
name|bufs
index|[
literal|0
index|]
operator|.
name|bno
condition|)
block|{
if|if
condition|(
name|bno
operator|<
literal|0
operator|||
name|bno
operator|>=
literal|1024
condition|)
return|return;
name|getblk
argument_list|(
name|bno
argument_list|)
expr_stmt|;
block|}
name|bufs
index|[
literal|0
index|]
operator|.
name|block
index|[
operator|(
operator|(
name|y
operator|&
literal|077
operator|)
operator|<<
literal|3
operator|)
operator|+
operator|(
operator|(
name|x
operator|>>
literal|3
operator|)
operator|&
literal|07
operator|)
index|]
operator||=
literal|1
operator|<<
operator|(
literal|7
operator|-
operator|(
name|x
operator|&
literal|07
operator|)
operator|)
expr_stmt|;
block|}
end_block

begin_expr_stmt
name|getblk
argument_list|(
name|b
argument_list|)
specifier|register
name|b
expr_stmt|;
end_expr_stmt

begin_block
block|{
specifier|register
name|struct
name|buf
modifier|*
name|bp1
decl_stmt|,
modifier|*
name|bp2
decl_stmt|;
specifier|register
name|char
modifier|*
name|tp
decl_stmt|;
name|loop
label|:
for|for
control|(
name|bp1
operator|=
name|bufs
init|;
name|bp1
operator|<
operator|&
name|bufs
index|[
name|NB
index|]
condition|;
name|bp1
operator|++
control|)
block|{
if|if
condition|(
name|bp1
operator|->
name|bno
operator|==
name|b
operator|||
name|bp1
operator|->
name|bno
operator|==
operator|-
literal|1
condition|)
block|{
name|tp
operator|=
name|bp1
operator|->
name|block
expr_stmt|;
for|for
control|(
name|bp2
operator|=
name|bp1
init|;
name|bp2
operator|>
name|bufs
condition|;
operator|--
name|bp2
control|)
block|{
name|bp2
operator|->
name|bno
operator|=
operator|(
name|bp2
operator|-
literal|1
operator|)
operator|->
name|bno
expr_stmt|;
name|bp2
operator|->
name|block
operator|=
operator|(
name|bp2
operator|-
literal|1
operator|)
operator|->
name|block
expr_stmt|;
block|}
name|bufs
index|[
literal|0
index|]
operator|.
name|bno
operator|=
name|b
expr_stmt|;
name|bufs
index|[
literal|0
index|]
operator|.
name|block
operator|=
name|tp
expr_stmt|;
return|return;
block|}
block|}
name|zseek
argument_list|(
name|out
argument_list|,
name|bufs
index|[
name|NB
operator|-
literal|1
index|]
operator|.
name|bno
argument_list|)
expr_stmt|;
name|write
argument_list|(
name|out
argument_list|,
name|bufs
index|[
name|NB
operator|-
literal|1
index|]
operator|.
name|block
argument_list|,
name|BSIZ
argument_list|)
expr_stmt|;
name|zseek
argument_list|(
name|in
argument_list|,
name|b
argument_list|)
expr_stmt|;
name|read
argument_list|(
name|in
argument_list|,
name|bufs
index|[
name|NB
operator|-
literal|1
index|]
operator|.
name|block
argument_list|,
name|BSIZ
argument_list|)
expr_stmt|;
name|bufs
index|[
name|NB
operator|-
literal|1
index|]
operator|.
name|bno
operator|=
name|b
expr_stmt|;
goto|goto
name|loop
goto|;
block|}
end_block

begin_macro
name|onintr
argument_list|()
end_macro

begin_block
block|{
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
end_block

begin_macro
name|zseek
argument_list|(
argument|a
argument_list|,
argument|b
argument_list|)
end_macro

begin_block
block|{
return|return
operator|(
name|lseek
argument_list|(
name|a
argument_list|,
operator|(
name|long
operator|)
name|b
operator|*
literal|512
argument_list|,
literal|0
argument_list|)
operator|)
return|;
block|}
end_block

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_include
include|#
directive|include
file|"global.h"
end_include

begin_include
include|#
directive|include
file|"gc.h"
end_include

begin_include
include|#
directive|include
file|<sys/types.h>
end_include

begin_include
include|#
directive|include
file|<sys/vtimes.h>
end_include

begin_comment
comment|/* this file  is temporary and will contain routines to meter     the garbage collector */
end_comment

begin_comment
comment|/* gcstat - temporary routine used to report on gc statistics.    if this causes variables to be undefined,then it should be removed */
end_comment

begin_decl_stmt
specifier|extern
name|int
name|beginsweep
decl_stmt|,
name|gensymcounter
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|gcstat
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|markdpcount
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|gccount
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|conssame
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|consdiff
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|consnil
decl_stmt|;
end_decl_stmt

begin_comment
comment|/*  *	gcstat  - initiate and record gc statistics  * calls:  *  	(gcstat 0) -- initiate gc statistics by creating gc.out  *		      and writing header.  *	(gcstat 1) -- finish off gc statistics file by writing typetable  *		      and closing file.  */
end_comment

begin_function
name|lispval
name|Lgcstat
parameter_list|()
block|{
specifier|register
name|lispval
name|handy
decl_stmt|,
name|retval
decl_stmt|;
name|int
name|nbytes
decl_stmt|;
name|struct
name|gchead
name|hhh
decl_stmt|;
name|chkarg
argument_list|(
literal|1
argument_list|,
literal|"gcstat"
argument_list|)
expr_stmt|;
if|if
condition|(
name|TYPE
argument_list|(
name|handy
operator|=
name|lbot
operator|->
name|val
argument_list|)
operator|!=
name|INT
condition|)
block|{
name|error
argument_list|(
literal|"gcstat: non integer arg "
argument_list|,
name|FALSE
argument_list|)
expr_stmt|;
block|}
switch|switch
condition|(
name|handy
operator|->
name|i
condition|)
block|{
case|case
literal|0
case|:
if|if
condition|(
operator|(
name|gcstat
operator|=
name|creat
argument_list|(
literal|"gc.out"
argument_list|,
literal|0644
argument_list|)
operator|)
operator|<
literal|0
condition|)
name|error
argument_list|(
literal|"cant open gc.out"
argument_list|,
name|FALSE
argument_list|)
expr_stmt|;
name|hhh
operator|.
name|version
operator|=
literal|5
expr_stmt|;
name|hhh
operator|.
name|lowdata
operator|=
operator|(
name|int
operator|)
name|beginsweep
expr_stmt|;
name|printf
argument_list|(
literal|"writing %d bytes \n"
argument_list|,
sizeof|sizeof
argument_list|(
name|hhh
argument_list|)
argument_list|)
expr_stmt|;
name|write
argument_list|(
name|gcstat
argument_list|,
operator|&
name|hhh
argument_list|,
sizeof|sizeof
argument_list|(
name|hhh
argument_list|)
argument_list|)
expr_stmt|;
name|gccount
operator|=
literal|0
expr_stmt|;
return|return
operator|(
name|tatom
operator|)
return|;
case|case
literal|1
case|:
comment|/* first write out the type table */
name|nbytes
operator|=
literal|0
expr_stmt|;
comment|/* 0 means type table follows */
name|printf
argument_list|(
literal|"gc's %d, writing %d bytes \n"
argument_list|,
name|gccount
argument_list|,
sizeof|sizeof
argument_list|(
name|nbytes
argument_list|)
argument_list|)
expr_stmt|;
name|write
argument_list|(
name|gcstat
argument_list|,
operator|&
name|nbytes
argument_list|,
sizeof|sizeof
argument_list|(
name|nbytes
argument_list|)
argument_list|)
expr_stmt|;
name|write
argument_list|(
name|gcstat
argument_list|,
operator|&
name|typetable
index|[
operator|(
operator|(
name|int
operator|)
name|beginsweep
operator|>>
literal|9
operator|)
operator|+
literal|1
index|]
argument_list|,
name|nbytes
operator|=
operator|(
operator|(
name|int
operator|)
name|datalim
operator|-
operator|(
name|int
operator|)
name|beginsweep
operator|)
operator|>>
literal|9
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"writing %d bytes \n"
argument_list|,
name|nbytes
operator|+
sizeof|sizeof
argument_list|(
name|nbytes
argument_list|)
argument_list|)
expr_stmt|;
name|write
argument_list|(
name|gcstat
argument_list|,
operator|&
name|nbytes
argument_list|,
sizeof|sizeof
argument_list|(
name|nbytes
argument_list|)
argument_list|)
expr_stmt|;
name|close
argument_list|(
name|gcstat
argument_list|)
expr_stmt|;
name|gcstat
operator|=
literal|0
expr_stmt|;
return|return
operator|(
name|inewint
argument_list|(
name|nbytes
argument_list|)
operator|)
return|;
default|default:
name|error
argument_list|(
literal|"Bad value to gcstat "
argument_list|,
name|TRUE
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_decl_stmt
specifier|extern
name|char
name|bitmapi
index|[]
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* a bit of a lie it is really a double array*/
end_comment

begin_decl_stmt
name|char
modifier|*
name|bitmapc
init|=
name|bitmapi
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|struct
name|vtimes
name|premark
decl_stmt|,
name|presweep
decl_stmt|,
name|alldone
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* called in the garbage collector after the bit maps have been made     only if gcstat is non zero */
end_comment

begin_macro
name|gcdump
argument_list|()
end_macro

begin_block
block|{
name|int
name|nbytes
decl_stmt|,
name|recsize
decl_stmt|;
comment|/* 16 bytes/page in the bitmap */
name|nbytes
operator|=
operator|(
operator|(
operator|(
name|int
operator|)
name|datalim
operator|-
operator|(
name|int
operator|)
name|beginsweep
operator|)
operator|>>
literal|9
operator|)
operator|*
literal|16
expr_stmt|;
name|recsize
operator|=
name|nbytes
operator|+
literal|6
operator|*
sizeof|sizeof
argument_list|(
name|int
argument_list|)
operator|+
literal|3
operator|*
sizeof|sizeof
argument_list|(
expr|struct
name|vtimes
argument_list|)
expr_stmt|;
name|write
argument_list|(
name|gcstat
argument_list|,
operator|&
name|recsize
argument_list|,
sizeof|sizeof
argument_list|(
name|recsize
argument_list|)
argument_list|)
expr_stmt|;
comment|/* whole record size */
name|write
argument_list|(
name|gcstat
argument_list|,
operator|&
name|premark
argument_list|,
sizeof|sizeof
argument_list|(
name|premark
argument_list|)
argument_list|)
expr_stmt|;
name|write
argument_list|(
name|gcstat
argument_list|,
operator|&
name|presweep
argument_list|,
sizeof|sizeof
argument_list|(
name|presweep
argument_list|)
argument_list|)
expr_stmt|;
name|write
argument_list|(
name|gcstat
argument_list|,
operator|&
name|alldone
argument_list|,
sizeof|sizeof
argument_list|(
name|alldone
argument_list|)
argument_list|)
expr_stmt|;
name|write
argument_list|(
name|gcstat
argument_list|,
operator|&
name|gensymcounter
argument_list|,
sizeof|sizeof
argument_list|(
name|int
argument_list|)
argument_list|)
expr_stmt|;
name|write
argument_list|(
name|gcstat
argument_list|,
operator|&
name|conssame
argument_list|,
sizeof|sizeof
argument_list|(
name|int
argument_list|)
argument_list|)
expr_stmt|;
name|write
argument_list|(
name|gcstat
argument_list|,
operator|&
name|consdiff
argument_list|,
sizeof|sizeof
argument_list|(
name|int
argument_list|)
argument_list|)
expr_stmt|;
name|write
argument_list|(
name|gcstat
argument_list|,
operator|&
name|consnil
argument_list|,
sizeof|sizeof
argument_list|(
name|int
argument_list|)
argument_list|)
expr_stmt|;
name|write
argument_list|(
name|gcstat
argument_list|,
operator|&
name|markdpcount
argument_list|,
sizeof|sizeof
argument_list|(
name|int
argument_list|)
argument_list|)
expr_stmt|;
name|write
argument_list|(
name|gcstat
argument_list|,
operator|&
name|nbytes
argument_list|,
sizeof|sizeof
argument_list|(
name|nbytes
argument_list|)
argument_list|)
expr_stmt|;
comment|/* bit table size */
name|write
argument_list|(
name|gcstat
argument_list|,
operator|&
name|bitmapc
index|[
operator|(
operator|(
name|int
operator|)
name|beginsweep
operator|>>
literal|9
operator|)
operator|*
literal|16
index|]
argument_list|,
name|nbytes
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"gc: %d, written %d bytes\n"
argument_list|,
operator|++
name|gccount
argument_list|,
name|nbytes
argument_list|)
expr_stmt|;
block|}
end_block

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*-  * Copyright 2014 Jonathan Anderson.  * All rights reserved.  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions  * are met:  * 1. Redistributions of source code must retain the above copyright  *    notice, this list of conditions and the following disclaimer.  * 2. Redistributions in binary form must reproduce the above copyright  *    notice, this list of conditions and the following disclaimer in the  *    documentation and/or other materials provided with the distribution.  *  * THIS SOFTWARE IS PROVIDED BY THE AUTHOR ``AS IS'' AND ANY EXPRESS OR  * IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES  * OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED.  * IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY DIRECT, INDIRECT,  * INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT  * NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,  * DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY  * THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT  * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF  * THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.  *  * $FreeBSD$  */
end_comment

begin_include
include|#
directive|include
file|<atf-c.h>
end_include

begin_include
include|#
directive|include
file|<fcntl.h>
end_include

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_struct
struct|struct
name|descriptors
block|{
name|int
name|binary
decl_stmt|;
name|int
name|testdir
decl_stmt|;
name|int
name|root
decl_stmt|;
name|int
name|etc
decl_stmt|;
name|int
name|usr
decl_stmt|;
block|}
struct|;
end_struct

begin_function_decl
specifier|static
name|void
name|setup
parameter_list|(
name|struct
name|descriptors
modifier|*
parameter_list|,
specifier|const
name|atf_tc_t
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|expect_success
parameter_list|(
name|int
name|binary
parameter_list|,
name|char
modifier|*
name|pathfds
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|expect_missing_library
parameter_list|(
name|int
name|binary
parameter_list|,
name|char
modifier|*
name|pathfds
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|try_to_run
parameter_list|(
name|int
name|binary
parameter_list|,
name|int
name|expected_exit_status
parameter_list|,
name|char
modifier|*
specifier|const
modifier|*
name|env
parameter_list|,
specifier|const
name|char
modifier|*
name|expected_out
parameter_list|,
specifier|const
name|char
modifier|*
name|expected_err
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|opendir
parameter_list|(
specifier|const
name|char
modifier|*
name|name
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|opendirat
parameter_list|(
name|int
name|parent
parameter_list|,
specifier|const
name|char
modifier|*
name|name
parameter_list|)
function_decl|;
end_function_decl

begin_expr_stmt
name|ATF_TC_WITHOUT_HEAD
argument_list|(
name|missing_library
argument_list|)
expr_stmt|;
end_expr_stmt

begin_macro
name|ATF_TC_BODY
argument_list|(
argument|missing_library
argument_list|,
argument|tc
argument_list|)
end_macro

begin_block
block|{
name|struct
name|descriptors
name|files
decl_stmt|;
name|setup
argument_list|(
operator|&
name|files
argument_list|,
name|tc
argument_list|)
expr_stmt|;
name|expect_missing_library
argument_list|(
name|files
operator|.
name|binary
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
block|}
end_block

begin_expr_stmt
name|ATF_TC_WITHOUT_HEAD
argument_list|(
name|wrong_library_directories
argument_list|)
expr_stmt|;
end_expr_stmt

begin_macro
name|ATF_TC_BODY
argument_list|(
argument|wrong_library_directories
argument_list|,
argument|tc
argument_list|)
end_macro

begin_block
block|{
name|struct
name|descriptors
name|files
decl_stmt|;
name|char
modifier|*
name|pathfds
decl_stmt|;
name|setup
argument_list|(
operator|&
name|files
argument_list|,
name|tc
argument_list|)
expr_stmt|;
name|ATF_REQUIRE
argument_list|(
name|asprintf
argument_list|(
operator|&
name|pathfds
argument_list|,
literal|"LD_LIBRARY_PATH_FDS=%d"
argument_list|,
name|files
operator|.
name|etc
argument_list|)
operator|>
literal|0
argument_list|)
expr_stmt|;
name|expect_missing_library
argument_list|(
name|files
operator|.
name|binary
argument_list|,
name|pathfds
argument_list|)
expr_stmt|;
block|}
end_block

begin_expr_stmt
name|ATF_TC_WITHOUT_HEAD
argument_list|(
name|bad_library_directories
argument_list|)
expr_stmt|;
end_expr_stmt

begin_macro
name|ATF_TC_BODY
argument_list|(
argument|bad_library_directories
argument_list|,
argument|tc
argument_list|)
end_macro

begin_block
block|{
name|struct
name|descriptors
name|files
decl_stmt|;
name|char
modifier|*
name|pathfds
decl_stmt|;
name|setup
argument_list|(
operator|&
name|files
argument_list|,
name|tc
argument_list|)
expr_stmt|;
name|ATF_REQUIRE
argument_list|(
name|asprintf
argument_list|(
operator|&
name|pathfds
argument_list|,
literal|"LD_LIBRARY_PATH_FDS=::"
argument_list|)
operator|>
literal|0
argument_list|)
expr_stmt|;
name|expect_missing_library
argument_list|(
name|files
operator|.
name|binary
argument_list|,
name|pathfds
argument_list|)
expr_stmt|;
block|}
end_block

begin_expr_stmt
name|ATF_TC_WITHOUT_HEAD
argument_list|(
name|single_library_directory
argument_list|)
expr_stmt|;
end_expr_stmt

begin_macro
name|ATF_TC_BODY
argument_list|(
argument|single_library_directory
argument_list|,
argument|tc
argument_list|)
end_macro

begin_block
block|{
name|struct
name|descriptors
name|files
decl_stmt|;
name|char
modifier|*
name|pathfds
decl_stmt|;
name|setup
argument_list|(
operator|&
name|files
argument_list|,
name|tc
argument_list|)
expr_stmt|;
name|ATF_REQUIRE
argument_list|(
name|asprintf
argument_list|(
operator|&
name|pathfds
argument_list|,
literal|"LD_LIBRARY_PATH_FDS=%d"
argument_list|,
name|files
operator|.
name|testdir
argument_list|)
operator|>
literal|0
argument_list|)
expr_stmt|;
name|expect_success
argument_list|(
name|files
operator|.
name|binary
argument_list|,
name|pathfds
argument_list|)
expr_stmt|;
block|}
end_block

begin_expr_stmt
name|ATF_TC_WITHOUT_HEAD
argument_list|(
name|first_library_directory
argument_list|)
expr_stmt|;
end_expr_stmt

begin_macro
name|ATF_TC_BODY
argument_list|(
argument|first_library_directory
argument_list|,
argument|tc
argument_list|)
end_macro

begin_block
block|{
name|struct
name|descriptors
name|files
decl_stmt|;
name|char
modifier|*
name|pathfds
decl_stmt|;
name|setup
argument_list|(
operator|&
name|files
argument_list|,
name|tc
argument_list|)
expr_stmt|;
name|ATF_REQUIRE
argument_list|(
name|asprintf
argument_list|(
operator|&
name|pathfds
argument_list|,
literal|"LD_LIBRARY_PATH_FDS=%d:%d"
argument_list|,
name|files
operator|.
name|testdir
argument_list|,
name|files
operator|.
name|etc
argument_list|)
operator|>
literal|0
argument_list|)
expr_stmt|;
name|expect_success
argument_list|(
name|files
operator|.
name|binary
argument_list|,
name|pathfds
argument_list|)
expr_stmt|;
block|}
end_block

begin_expr_stmt
name|ATF_TC_WITHOUT_HEAD
argument_list|(
name|middle_library_directory
argument_list|)
expr_stmt|;
end_expr_stmt

begin_macro
name|ATF_TC_BODY
argument_list|(
argument|middle_library_directory
argument_list|,
argument|tc
argument_list|)
end_macro

begin_block
block|{
name|struct
name|descriptors
name|files
decl_stmt|;
name|char
modifier|*
name|pathfds
decl_stmt|;
name|setup
argument_list|(
operator|&
name|files
argument_list|,
name|tc
argument_list|)
expr_stmt|;
name|ATF_REQUIRE
argument_list|(
name|asprintf
argument_list|(
operator|&
name|pathfds
argument_list|,
literal|"LD_LIBRARY_PATH_FDS=%d:%d:%d"
argument_list|,
name|files
operator|.
name|root
argument_list|,
name|files
operator|.
name|testdir
argument_list|,
name|files
operator|.
name|usr
argument_list|)
operator|>
literal|0
argument_list|)
expr_stmt|;
name|expect_success
argument_list|(
name|files
operator|.
name|binary
argument_list|,
name|pathfds
argument_list|)
expr_stmt|;
block|}
end_block

begin_expr_stmt
name|ATF_TC_WITHOUT_HEAD
argument_list|(
name|last_library_directory
argument_list|)
expr_stmt|;
end_expr_stmt

begin_macro
name|ATF_TC_BODY
argument_list|(
argument|last_library_directory
argument_list|,
argument|tc
argument_list|)
end_macro

begin_block
block|{
name|struct
name|descriptors
name|files
decl_stmt|;
name|char
modifier|*
name|pathfds
decl_stmt|;
name|setup
argument_list|(
operator|&
name|files
argument_list|,
name|tc
argument_list|)
expr_stmt|;
name|ATF_REQUIRE
argument_list|(
name|asprintf
argument_list|(
operator|&
name|pathfds
argument_list|,
literal|"LD_LIBRARY_PATH_FDS=%d:%d"
argument_list|,
name|files
operator|.
name|root
argument_list|,
name|files
operator|.
name|testdir
argument_list|)
operator|>
literal|0
argument_list|)
expr_stmt|;
name|expect_success
argument_list|(
name|files
operator|.
name|binary
argument_list|,
name|pathfds
argument_list|)
expr_stmt|;
block|}
end_block

begin_comment
comment|/* Register test cases with ATF. */
end_comment

begin_macro
name|ATF_TP_ADD_TCS
argument_list|(
argument|tp
argument_list|)
end_macro

begin_block
block|{
name|ATF_TP_ADD_TC
argument_list|(
name|tp
argument_list|,
name|missing_library
argument_list|)
expr_stmt|;
name|ATF_TP_ADD_TC
argument_list|(
name|tp
argument_list|,
name|wrong_library_directories
argument_list|)
expr_stmt|;
name|ATF_TP_ADD_TC
argument_list|(
name|tp
argument_list|,
name|bad_library_directories
argument_list|)
expr_stmt|;
name|ATF_TP_ADD_TC
argument_list|(
name|tp
argument_list|,
name|single_library_directory
argument_list|)
expr_stmt|;
name|ATF_TP_ADD_TC
argument_list|(
name|tp
argument_list|,
name|first_library_directory
argument_list|)
expr_stmt|;
name|ATF_TP_ADD_TC
argument_list|(
name|tp
argument_list|,
name|middle_library_directory
argument_list|)
expr_stmt|;
name|ATF_TP_ADD_TC
argument_list|(
name|tp
argument_list|,
name|last_library_directory
argument_list|)
expr_stmt|;
return|return
name|atf_no_error
argument_list|()
return|;
block|}
end_block

begin_function
specifier|static
name|void
name|setup
parameter_list|(
name|struct
name|descriptors
modifier|*
name|dp
parameter_list|,
specifier|const
name|atf_tc_t
modifier|*
name|tc
parameter_list|)
block|{
name|dp
operator|->
name|testdir
operator|=
name|opendir
argument_list|(
name|atf_tc_get_config_var
argument_list|(
name|tc
argument_list|,
literal|"srcdir"
argument_list|)
argument_list|)
expr_stmt|;
name|ATF_REQUIRE
argument_list|(
name|dp
operator|->
name|testdir
operator|>=
literal|0
argument_list|)
expr_stmt|;
name|ATF_REQUIRE
argument_list|(
operator|(
name|dp
operator|->
name|binary
operator|=
name|openat
argument_list|(
name|dp
operator|->
name|testdir
argument_list|,
literal|"target"
argument_list|,
name|O_RDONLY
argument_list|)
operator|)
operator|>=
literal|0
argument_list|)
expr_stmt|;
name|ATF_REQUIRE
argument_list|(
operator|(
name|dp
operator|->
name|root
operator|=
name|opendir
argument_list|(
literal|"/"
argument_list|)
operator|)
operator|>=
literal|0
argument_list|)
expr_stmt|;
name|ATF_REQUIRE
argument_list|(
operator|(
name|dp
operator|->
name|etc
operator|=
name|opendirat
argument_list|(
name|dp
operator|->
name|root
argument_list|,
literal|"etc"
argument_list|)
operator|)
operator|>=
literal|0
argument_list|)
expr_stmt|;
name|ATF_REQUIRE
argument_list|(
operator|(
name|dp
operator|->
name|usr
operator|=
name|opendirat
argument_list|(
name|dp
operator|->
name|root
argument_list|,
literal|"usr"
argument_list|)
operator|)
operator|>=
literal|0
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|expect_success
parameter_list|(
name|int
name|binary
parameter_list|,
name|char
modifier|*
name|pathfds
parameter_list|)
block|{
name|char
modifier|*
specifier|const
name|env
index|[]
init|=
block|{
name|pathfds
block|,
name|NULL
block|}
decl_stmt|;
name|try_to_run
argument_list|(
name|binary
argument_list|,
literal|0
argument_list|,
name|env
argument_list|,
literal|"the hypotenuse of 3 and 4 is 5\n"
argument_list|,
literal|""
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|expect_missing_library
parameter_list|(
name|int
name|binary
parameter_list|,
name|char
modifier|*
name|pathfds
parameter_list|)
block|{
name|char
modifier|*
specifier|const
name|env
index|[]
init|=
block|{
name|pathfds
block|,
name|NULL
block|}
decl_stmt|;
name|try_to_run
argument_list|(
name|binary
argument_list|,
literal|1
argument_list|,
name|env
argument_list|,
literal|""
argument_list|,
literal|"Shared object \"libpythagoras.so.0\" not found,"
literal|" required by \"target\"\n"
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|try_to_run
parameter_list|(
name|int
name|binary
parameter_list|,
name|int
name|exit_status
parameter_list|,
name|char
modifier|*
specifier|const
modifier|*
name|env
parameter_list|,
specifier|const
name|char
modifier|*
name|expected_out
parameter_list|,
specifier|const
name|char
modifier|*
name|expected_err
parameter_list|)
block|{
name|pid_t
name|child
init|=
name|atf_utils_fork
argument_list|()
decl_stmt|;
if|if
condition|(
name|child
operator|==
literal|0
condition|)
block|{
name|char
modifier|*
specifier|const
name|args
index|[]
init|=
block|{
literal|"target"
block|,
name|NULL
block|}
decl_stmt|;
name|fexecve
argument_list|(
name|binary
argument_list|,
name|args
argument_list|,
name|env
argument_list|)
expr_stmt|;
name|atf_tc_fail
argument_list|(
literal|"fexecve() failed"
argument_list|)
expr_stmt|;
block|}
name|atf_utils_wait
argument_list|(
name|child
argument_list|,
name|exit_status
argument_list|,
name|expected_out
argument_list|,
name|expected_err
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|opendir
parameter_list|(
specifier|const
name|char
modifier|*
name|name
parameter_list|)
block|{
return|return
name|open
argument_list|(
name|name
argument_list|,
name|O_RDONLY
operator||
name|O_DIRECTORY
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|opendirat
parameter_list|(
name|int
name|parent
parameter_list|,
specifier|const
name|char
modifier|*
name|name
parameter_list|)
block|{
return|return
name|openat
argument_list|(
name|parent
argument_list|,
name|name
argument_list|,
name|O_RDONLY
operator||
name|O_DIRECTORY
argument_list|)
return|;
block|}
end_function

end_unit


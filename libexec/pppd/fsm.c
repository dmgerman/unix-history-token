begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * fsm.c - {Link, IP} Control Protocol Finite State Machine.  *  * Copyright (c) 1989 Carnegie Mellon University.  * All rights reserved.  *  * Redistribution and use in source and binary forms are permitted  * provided that the above copyright notice and this paragraph are  * duplicated in all such forms and that any documentation,  * advertising materials, and other materials related to such  * distribution and use acknowledge that the software was developed  * by Carnegie Mellon University.  The name of the  * University may not be used to endorse or promote products derived  * from this software without specific prior written permission.  * THIS SOFTWARE IS PROVIDED ``AS IS'' AND WITHOUT ANY EXPRESS OR  * IMPLIED WARRANTIES, INCLUDING, WITHOUT LIMITATION, THE IMPLIED  * WARRANTIES OF MERCHANTIBILITY AND FITNESS FOR A PARTICULAR PURPOSE.  */
end_comment

begin_comment
comment|/*  * TODO:  * Mechanism to exit() and/or drop DTR.  * Hold-down on open?  * Randomize fsm id on link/init.  * Deal with variable outgoing MTU.  */
end_comment

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_include
include|#
directive|include
file|<sys/types.h>
end_include

begin_comment
comment|/*#include<malloc.h>*/
end_comment

begin_include
include|#
directive|include
file|<syslog.h>
end_include

begin_ifdef
ifdef|#
directive|ifdef
name|STREAMS
end_ifdef

begin_include
include|#
directive|include
file|<sys/stream.h>
end_include

begin_include
include|#
directive|include
file|<sys/socket.h>
end_include

begin_include
include|#
directive|include
file|<net/if.h>
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_include
include|#
directive|include
file|<net/ppp.h>
end_include

begin_include
include|#
directive|include
file|"pppd.h"
end_include

begin_include
include|#
directive|include
file|"fsm.h"
end_include

begin_function_decl
specifier|extern
name|char
modifier|*
name|proto_name
parameter_list|()
function_decl|;
end_function_decl

begin_decl_stmt
specifier|static
name|void
name|fsm_timeout
name|__ARGS
argument_list|(
operator|(
name|caddr_t
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|void
name|fsm_rconfack
name|__ARGS
argument_list|(
operator|(
name|fsm
operator|*
operator|,
name|u_char
operator|*
operator|,
name|int
operator|,
name|int
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|void
name|fsm_rconfnak
name|__ARGS
argument_list|(
operator|(
name|fsm
operator|*
operator|,
name|u_char
operator|*
operator|,
name|int
operator|,
name|int
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|void
name|fsm_rconfrej
name|__ARGS
argument_list|(
operator|(
name|fsm
operator|*
operator|,
name|u_char
operator|*
operator|,
name|int
operator|,
name|int
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|void
name|fsm_rtermreq
name|__ARGS
argument_list|(
operator|(
name|fsm
operator|*
operator|,
name|int
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|void
name|fsm_rtermack
name|__ARGS
argument_list|(
operator|(
name|fsm
operator|*
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|void
name|fsm_rcoderej
name|__ARGS
argument_list|(
operator|(
name|fsm
operator|*
operator|,
name|u_char
operator|*
operator|,
name|int
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|void
name|fsm_rprotrej
name|__ARGS
argument_list|(
operator|(
name|fsm
operator|*
operator|,
name|u_char
operator|*
operator|,
name|int
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|void
name|fsm_sconfreq
name|__ARGS
argument_list|(
operator|(
name|fsm
operator|*
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_comment
comment|/*  * fsm_init - Initialize fsm.  *  * Initialize fsm state.  */
end_comment

begin_function
name|void
name|fsm_init
parameter_list|(
name|f
parameter_list|)
name|fsm
modifier|*
name|f
decl_stmt|;
block|{
name|f
operator|->
name|state
operator|=
name|CLOSED
expr_stmt|;
name|f
operator|->
name|flags
operator|=
literal|0
expr_stmt|;
name|f
operator|->
name|id
operator|=
literal|0
expr_stmt|;
comment|/* XXX Start with random id? */
block|}
end_function

begin_comment
comment|/*  * fsm_activeopen - Actively open connection.  *  * Set new state, reset desired options and send requests.  */
end_comment

begin_function
name|void
name|fsm_activeopen
parameter_list|(
name|f
parameter_list|)
name|fsm
modifier|*
name|f
decl_stmt|;
block|{
name|f
operator|->
name|flags
operator|&=
operator|~
operator|(
name|AOPENDING
operator||
name|POPENDING
operator|)
expr_stmt|;
comment|/* Clear pending flags */
if|if
condition|(
name|f
operator|->
name|state
operator|==
name|REQSENT
operator|||
comment|/* Already actively open(ing)? */
name|f
operator|->
name|state
operator|==
name|ACKRCVD
operator|||
name|f
operator|->
name|state
operator|==
name|ACKSENT
operator|||
name|f
operator|->
name|state
operator|==
name|OPEN
condition|)
return|return;
if|if
condition|(
name|f
operator|->
name|state
operator|==
name|TERMSENT
operator|||
comment|/* Closing or */
operator|!
operator|(
name|f
operator|->
name|flags
operator|&
name|LOWERUP
operator|)
condition|)
block|{
comment|/*  lower layer down? */
name|f
operator|->
name|flags
operator||=
name|AOPENDING
expr_stmt|;
comment|/* Wait for desired event */
return|return;
block|}
if|if
condition|(
name|f
operator|->
name|callbacks
operator|->
name|resetci
condition|)
call|(
modifier|*
name|f
operator|->
name|callbacks
operator|->
name|resetci
call|)
argument_list|(
name|f
argument_list|)
expr_stmt|;
comment|/* Reset options */
name|fsm_sconfreq
argument_list|(
name|f
argument_list|)
expr_stmt|;
comment|/* Send Configure-Request */
name|TIMEOUT
argument_list|(
name|fsm_timeout
argument_list|,
operator|(
name|caddr_t
operator|)
name|f
argument_list|,
name|f
operator|->
name|timeouttime
argument_list|)
expr_stmt|;
name|f
operator|->
name|state
operator|=
name|REQSENT
expr_stmt|;
name|f
operator|->
name|retransmits
operator|=
literal|0
expr_stmt|;
comment|/* Reset retransmits count */
name|f
operator|->
name|nakloops
operator|=
literal|0
expr_stmt|;
comment|/* Reset nakloops count */
block|}
end_function

begin_comment
comment|/*  * fsm_passiveopen - Passively open connection.  *  * Set new state and reset desired options.  */
end_comment

begin_function
name|void
name|fsm_passiveopen
parameter_list|(
name|f
parameter_list|)
name|fsm
modifier|*
name|f
decl_stmt|;
block|{
name|f
operator|->
name|flags
operator|&=
operator|~
operator|(
name|AOPENDING
operator||
name|POPENDING
operator|)
expr_stmt|;
comment|/* Clear pending flags */
if|if
condition|(
name|f
operator|->
name|state
operator|==
name|LISTEN
operator|||
comment|/* Already passively open(ing)? */
name|f
operator|->
name|state
operator|==
name|OPEN
condition|)
return|return;
if|if
condition|(
name|f
operator|->
name|state
operator|==
name|REQSENT
operator|||
comment|/* Active-Opening or */
name|f
operator|->
name|state
operator|==
name|ACKRCVD
operator|||
name|f
operator|->
name|state
operator|==
name|ACKSENT
operator|||
name|f
operator|->
name|state
operator|==
name|TERMSENT
operator|||
comment|/*  closing or */
operator|!
operator|(
name|f
operator|->
name|flags
operator|&
name|LOWERUP
operator|)
condition|)
block|{
comment|/*  lower layer down? */
name|f
operator|->
name|flags
operator||=
name|POPENDING
expr_stmt|;
comment|/* Wait for desired event */
return|return;
block|}
if|if
condition|(
name|f
operator|->
name|callbacks
operator|->
name|resetci
condition|)
call|(
modifier|*
name|f
operator|->
name|callbacks
operator|->
name|resetci
call|)
argument_list|(
name|f
argument_list|)
expr_stmt|;
comment|/* Reset options */
name|f
operator|->
name|state
operator|=
name|LISTEN
expr_stmt|;
name|f
operator|->
name|retransmits
operator|=
literal|0
expr_stmt|;
comment|/* Reset retransmits count */
name|f
operator|->
name|nakloops
operator|=
literal|0
expr_stmt|;
comment|/* Reset nakloops count */
block|}
end_function

begin_comment
comment|/*  * fsm_close - Start closing connection.  *  * Cancel timeouts and either initiate close or possibly go directly to  * the CLOSED state.  */
end_comment

begin_function
name|void
name|fsm_close
parameter_list|(
name|f
parameter_list|)
name|fsm
modifier|*
name|f
decl_stmt|;
block|{
name|f
operator|->
name|flags
operator|&=
operator|~
operator|(
name|AOPENDING
operator||
name|POPENDING
operator|)
expr_stmt|;
comment|/* Clear pending flags */
if|if
condition|(
name|f
operator|->
name|state
operator|==
name|CLOSED
operator|||
comment|/* Already CLOSED or Closing? */
name|f
operator|->
name|state
operator|==
name|TERMSENT
condition|)
return|return;
if|if
condition|(
name|f
operator|->
name|state
operator|==
name|REQSENT
operator|||
comment|/* Timeout pending for Open? */
name|f
operator|->
name|state
operator|==
name|ACKRCVD
operator|||
name|f
operator|->
name|state
operator|==
name|ACKSENT
condition|)
name|UNTIMEOUT
argument_list|(
name|fsm_timeout
argument_list|,
operator|(
name|caddr_t
operator|)
name|f
argument_list|)
expr_stmt|;
comment|/* Cancel timeout */
if|if
condition|(
name|f
operator|->
name|state
operator|==
name|OPEN
operator|&&
comment|/* Open? */
name|f
operator|->
name|callbacks
operator|->
name|down
condition|)
call|(
modifier|*
name|f
operator|->
name|callbacks
operator|->
name|down
call|)
argument_list|(
name|f
argument_list|)
expr_stmt|;
comment|/* Inform upper layers we're down */
if|if
condition|(
name|f
operator|->
name|state
operator|==
name|ACKSENT
operator|||
comment|/* Could peer be OPEN? */
name|f
operator|->
name|state
operator|==
name|OPEN
condition|)
block|{
name|fsm_sdata
argument_list|(
name|f
argument_list|,
name|TERMREQ
argument_list|,
name|f
operator|->
name|reqid
operator|=
operator|++
name|f
operator|->
name|id
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* Send Terminate-Request */
name|TIMEOUT
argument_list|(
name|fsm_timeout
argument_list|,
operator|(
name|caddr_t
operator|)
name|f
argument_list|,
name|f
operator|->
name|timeouttime
argument_list|)
expr_stmt|;
name|f
operator|->
name|state
operator|=
name|TERMSENT
expr_stmt|;
name|f
operator|->
name|retransmits
operator|=
literal|0
expr_stmt|;
comment|/* Reset retransmits count */
block|}
else|else
block|{
name|f
operator|->
name|state
operator|=
name|CLOSED
expr_stmt|;
if|if
condition|(
name|f
operator|->
name|callbacks
operator|->
name|closed
condition|)
call|(
modifier|*
name|f
operator|->
name|callbacks
operator|->
name|closed
call|)
argument_list|(
name|f
argument_list|)
expr_stmt|;
comment|/* Exit/restart/etc. */
block|}
block|}
end_function

begin_comment
comment|/*  * fsm_timeout - Timeout expired.  */
end_comment

begin_function
specifier|static
name|void
name|fsm_timeout
parameter_list|(
name|arg
parameter_list|)
name|caddr_t
name|arg
decl_stmt|;
block|{
name|fsm
modifier|*
name|f
init|=
operator|(
name|fsm
operator|*
operator|)
name|arg
decl_stmt|;
switch|switch
condition|(
name|f
operator|->
name|state
condition|)
block|{
case|case
name|REQSENT
case|:
case|case
name|ACKRCVD
case|:
case|case
name|ACKSENT
case|:
if|if
condition|(
name|f
operator|->
name|flags
operator|&
name|POPENDING
condition|)
block|{
comment|/* Go passive? */
name|f
operator|->
name|state
operator|=
name|CLOSED
expr_stmt|;
comment|/* Pretend for a moment... */
name|fsm_passiveopen
argument_list|(
name|f
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|f
operator|->
name|retransmits
operator|>
name|f
operator|->
name|maxconfreqtransmits
condition|)
block|{
if|if
condition|(
name|f
operator|->
name|nakloops
operator|>
name|f
operator|->
name|maxnakloops
condition|)
block|{
name|syslog
argument_list|(
name|LOG_INFO
argument_list|,
literal|"%s: timeout sending Config-Requests"
argument_list|,
name|proto_name
argument_list|(
name|f
operator|->
name|protocol
argument_list|)
argument_list|)
expr_stmt|;
block|}
else|else
name|syslog
argument_list|(
name|LOG_INFO
argument_list|,
literal|"%s: timed out. Config-Requests not accepted"
argument_list|,
name|proto_name
argument_list|(
name|f
operator|->
name|protocol
argument_list|)
argument_list|)
expr_stmt|;
comment|/* timeout sending config-requests */
name|fsm_close
argument_list|(
name|f
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|f
operator|->
name|callbacks
operator|->
name|retransmit
condition|)
comment|/* If there is a retransmit rtn? */
call|(
modifier|*
name|f
operator|->
name|callbacks
operator|->
name|retransmit
call|)
argument_list|(
name|f
argument_list|)
expr_stmt|;
name|fsm_sconfreq
argument_list|(
name|f
argument_list|)
expr_stmt|;
comment|/* Send Configure-Request */
name|TIMEOUT
argument_list|(
name|fsm_timeout
argument_list|,
operator|(
name|caddr_t
operator|)
name|f
argument_list|,
name|f
operator|->
name|timeouttime
argument_list|)
expr_stmt|;
name|f
operator|->
name|state
operator|=
name|REQSENT
expr_stmt|;
operator|++
name|f
operator|->
name|retransmits
expr_stmt|;
name|f
operator|->
name|nakloops
operator|=
literal|0
expr_stmt|;
break|break;
case|case
name|TERMSENT
case|:
if|if
condition|(
name|f
operator|->
name|flags
operator|&
name|POPENDING
condition|)
block|{
comment|/* Go passive? */
name|f
operator|->
name|state
operator|=
name|CLOSED
expr_stmt|;
comment|/* Pretend for a moment... */
name|fsm_passiveopen
argument_list|(
name|f
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
operator|++
name|f
operator|->
name|retransmits
operator|>
name|f
operator|->
name|maxtermtransmits
condition|)
block|{
comment|/* 	     * We've waited for an ack long enough.  Peer probably heard us. 	     */
name|f
operator|->
name|state
operator|=
name|CLOSED
expr_stmt|;
if|if
condition|(
name|f
operator|->
name|callbacks
operator|->
name|closed
condition|)
call|(
modifier|*
name|f
operator|->
name|callbacks
operator|->
name|closed
call|)
argument_list|(
name|f
argument_list|)
expr_stmt|;
comment|/* Exit/restart/etc. */
return|return;
block|}
if|if
condition|(
name|f
operator|->
name|callbacks
operator|->
name|retransmit
condition|)
comment|/* If there is a retransmit rtn? */
call|(
modifier|*
name|f
operator|->
name|callbacks
operator|->
name|retransmit
call|)
argument_list|(
name|f
argument_list|)
expr_stmt|;
name|fsm_sdata
argument_list|(
name|f
argument_list|,
name|TERMREQ
argument_list|,
name|f
operator|->
name|reqid
operator|=
operator|++
name|f
operator|->
name|id
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* Send Terminate-Request */
name|TIMEOUT
argument_list|(
name|fsm_timeout
argument_list|,
operator|(
name|caddr_t
operator|)
name|f
argument_list|,
name|f
operator|->
name|timeouttime
argument_list|)
expr_stmt|;
operator|++
name|f
operator|->
name|retransmits
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/*  * fsm_lowerup - The lower layer is up.  *  * Start Active or Passive Open if pending.  */
end_comment

begin_function
name|void
name|fsm_lowerup
parameter_list|(
name|f
parameter_list|)
name|fsm
modifier|*
name|f
decl_stmt|;
block|{
name|f
operator|->
name|flags
operator||=
name|LOWERUP
expr_stmt|;
if|if
condition|(
name|f
operator|->
name|flags
operator|&
name|AOPENDING
condition|)
comment|/* Attempting Active-Open? */
name|fsm_activeopen
argument_list|(
name|f
argument_list|)
expr_stmt|;
comment|/* Try it now */
elseif|else
if|if
condition|(
name|f
operator|->
name|flags
operator|&
name|POPENDING
condition|)
comment|/* Attempting Passive-Open? */
name|fsm_passiveopen
argument_list|(
name|f
argument_list|)
expr_stmt|;
comment|/* Try it now */
block|}
end_function

begin_comment
comment|/*  * fsm_lowerdown - The lower layer is down.  *  * Cancel all timeouts and inform upper layers.  */
end_comment

begin_function
name|void
name|fsm_lowerdown
parameter_list|(
name|f
parameter_list|)
name|fsm
modifier|*
name|f
decl_stmt|;
block|{
name|f
operator|->
name|flags
operator|&=
operator|~
name|LOWERUP
expr_stmt|;
if|if
condition|(
name|f
operator|->
name|state
operator|==
name|REQSENT
operator|||
comment|/* Timeout pending? */
name|f
operator|->
name|state
operator|==
name|ACKRCVD
operator|||
name|f
operator|->
name|state
operator|==
name|ACKSENT
operator|||
name|f
operator|->
name|state
operator|==
name|TERMSENT
condition|)
name|UNTIMEOUT
argument_list|(
name|fsm_timeout
argument_list|,
operator|(
name|caddr_t
operator|)
name|f
argument_list|)
expr_stmt|;
comment|/* Cancel timeout */
if|if
condition|(
name|f
operator|->
name|state
operator|==
name|OPEN
operator|&&
comment|/* OPEN? */
name|f
operator|->
name|callbacks
operator|->
name|down
condition|)
call|(
modifier|*
name|f
operator|->
name|callbacks
operator|->
name|down
call|)
argument_list|(
name|f
argument_list|)
expr_stmt|;
comment|/* Inform upper layers */
name|f
operator|->
name|state
operator|=
name|CLOSED
expr_stmt|;
if|if
condition|(
name|f
operator|->
name|callbacks
operator|->
name|closed
condition|)
call|(
modifier|*
name|f
operator|->
name|callbacks
operator|->
name|closed
call|)
argument_list|(
name|f
argument_list|)
expr_stmt|;
comment|/* Exit/restart/etc. */
block|}
end_function

begin_comment
comment|/*  * fsm_protreject - Peer doesn't speak this protocol.  *  * Pretend that the lower layer went down.  */
end_comment

begin_function
name|void
name|fsm_protreject
parameter_list|(
name|f
parameter_list|)
name|fsm
modifier|*
name|f
decl_stmt|;
block|{
name|fsm_lowerdown
argument_list|(
name|f
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * fsm_input - Input packet.  */
end_comment

begin_function
name|void
name|fsm_input
parameter_list|(
name|f
parameter_list|,
name|inpacket
parameter_list|,
name|l
parameter_list|)
name|fsm
modifier|*
name|f
decl_stmt|;
name|u_char
modifier|*
name|inpacket
decl_stmt|;
name|int
name|l
decl_stmt|;
block|{
name|u_char
modifier|*
name|inp
decl_stmt|,
modifier|*
name|outp
decl_stmt|;
name|u_char
name|code
decl_stmt|,
name|id
decl_stmt|;
name|int
name|len
decl_stmt|;
comment|/*    * Parse header (code, id and length).    * If packet too short, drop it.    */
name|inp
operator|=
name|inpacket
expr_stmt|;
if|if
condition|(
name|l
operator|<
name|HEADERLEN
condition|)
block|{
name|FSMDEBUG
argument_list|(
argument|(LOG_WARNING,
literal|"fsm_input(%x): Rcvd short header."
argument|, f->protocol)
argument_list|)
return|return;
block|}
name|GETCHAR
argument_list|(
name|code
argument_list|,
name|inp
argument_list|)
expr_stmt|;
name|GETCHAR
argument_list|(
name|id
argument_list|,
name|inp
argument_list|)
expr_stmt|;
name|GETSHORT
argument_list|(
name|len
argument_list|,
name|inp
argument_list|)
expr_stmt|;
if|if
condition|(
name|len
operator|<
name|HEADERLEN
condition|)
block|{
name|FSMDEBUG
argument_list|(
argument|(LOG_INFO,
literal|"fsm_input(%x): Rcvd illegal length."
argument|, 	      f->protocol)
argument_list|)
return|return;
block|}
if|if
condition|(
name|len
operator|>
name|l
condition|)
block|{
name|FSMDEBUG
argument_list|(
argument|(LOG_INFO,
literal|"fsm_input(%x): Rcvd short packet."
argument|, 	      f->protocol)
argument_list|)
return|return;
block|}
name|len
operator|-=
name|HEADERLEN
expr_stmt|;
comment|/* subtract header length */
comment|/*    * Action depends on code.    */
switch|switch
condition|(
name|code
condition|)
block|{
case|case
name|CONFREQ
case|:
name|FSMDEBUG
argument_list|(
argument|(LOG_INFO,
literal|"fsm_rconfreq(%x): Rcvd id %d."
argument|, 	      f->protocol, id)
argument_list|)
if|if
condition|(
name|f
operator|->
name|state
operator|==
name|TERMSENT
condition|)
return|return;
if|if
condition|(
name|f
operator|->
name|state
operator|==
name|CLOSED
condition|)
block|{
name|fsm_sdata
argument_list|(
name|f
argument_list|,
name|TERMACK
argument_list|,
name|id
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|f
operator|->
name|state
operator|==
name|OPEN
operator|&&
name|f
operator|->
name|callbacks
operator|->
name|down
condition|)
call|(
modifier|*
name|f
operator|->
name|callbacks
operator|->
name|down
call|)
argument_list|(
name|f
argument_list|)
expr_stmt|;
comment|/* Inform upper layers */
if|if
condition|(
name|f
operator|->
name|state
operator|==
name|OPEN
operator|||
name|f
operator|->
name|state
operator|==
name|LISTEN
condition|)
block|{
comment|/* XXX Possibly need hold-down on OPEN? */
name|fsm_sconfreq
argument_list|(
name|f
argument_list|)
expr_stmt|;
comment|/* Send Configure-Request */
name|TIMEOUT
argument_list|(
name|fsm_timeout
argument_list|,
operator|(
name|caddr_t
operator|)
name|f
argument_list|,
name|f
operator|->
name|timeouttime
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|f
operator|->
name|callbacks
operator|->
name|reqci
condition|)
comment|/* Check CI */
name|code
operator|=
call|(
modifier|*
name|f
operator|->
name|callbacks
operator|->
name|reqci
call|)
argument_list|(
name|f
argument_list|,
name|inp
argument_list|,
operator|&
name|len
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|len
condition|)
name|code
operator|=
name|CONFREJ
expr_stmt|;
comment|/* Reject all CI */
name|len
operator|+=
name|HEADERLEN
expr_stmt|;
comment|/* add header length back on */
name|inp
operator|=
name|inpacket
expr_stmt|;
comment|/* Reset to header */
name|outp
operator|=
name|outpacket_buf
expr_stmt|;
comment|/* get pointer to output buffer */
name|MAKEHEADER
argument_list|(
name|outp
argument_list|,
name|f
operator|->
name|protocol
argument_list|)
expr_stmt|;
comment|/* paste in DLL header */
name|BCOPY
argument_list|(
name|inp
argument_list|,
name|outp
argument_list|,
name|len
argument_list|)
expr_stmt|;
comment|/* copy input packet */
name|PUTCHAR
argument_list|(
name|code
argument_list|,
name|outp
argument_list|)
expr_stmt|;
comment|/* put in the code, id, and length*/
name|PUTCHAR
argument_list|(
name|id
argument_list|,
name|outp
argument_list|)
expr_stmt|;
name|PUTSHORT
argument_list|(
name|len
argument_list|,
name|outp
argument_list|)
expr_stmt|;
name|output
argument_list|(
name|f
operator|->
name|unit
argument_list|,
name|outpacket_buf
argument_list|,
name|len
operator|+
name|DLLHEADERLEN
argument_list|)
expr_stmt|;
comment|/* send it out */
if|if
condition|(
name|code
operator|==
name|CONFACK
condition|)
block|{
if|if
condition|(
name|f
operator|->
name|state
operator|==
name|ACKRCVD
condition|)
block|{
name|UNTIMEOUT
argument_list|(
name|fsm_timeout
argument_list|,
operator|(
name|caddr_t
operator|)
name|f
argument_list|)
expr_stmt|;
comment|/* Cancel timeout */
if|if
condition|(
name|f
operator|->
name|callbacks
operator|->
name|up
condition|)
call|(
modifier|*
name|f
operator|->
name|callbacks
operator|->
name|up
call|)
argument_list|(
name|f
argument_list|)
expr_stmt|;
comment|/* Inform upper layers */
name|f
operator|->
name|state
operator|=
name|OPEN
expr_stmt|;
block|}
else|else
name|f
operator|->
name|state
operator|=
name|ACKSENT
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|f
operator|->
name|state
operator|!=
name|ACKRCVD
condition|)
name|f
operator|->
name|state
operator|=
name|REQSENT
expr_stmt|;
block|}
return|return;
case|case
name|CONFACK
case|:
name|fsm_rconfack
argument_list|(
name|f
argument_list|,
name|inp
argument_list|,
name|id
argument_list|,
name|len
argument_list|)
expr_stmt|;
break|break;
case|case
name|CONFNAK
case|:
name|fsm_rconfnak
argument_list|(
name|f
argument_list|,
name|inp
argument_list|,
name|id
argument_list|,
name|len
argument_list|)
expr_stmt|;
break|break;
case|case
name|CONFREJ
case|:
name|fsm_rconfrej
argument_list|(
name|f
argument_list|,
name|inp
argument_list|,
name|id
argument_list|,
name|len
argument_list|)
expr_stmt|;
break|break;
case|case
name|TERMREQ
case|:
name|fsm_rtermreq
argument_list|(
name|f
argument_list|,
name|id
argument_list|)
expr_stmt|;
break|break;
case|case
name|TERMACK
case|:
name|fsm_rtermack
argument_list|(
name|f
argument_list|)
expr_stmt|;
break|break;
case|case
name|CODEREJ
case|:
name|fsm_rcoderej
argument_list|(
name|f
argument_list|,
name|inp
argument_list|,
name|len
argument_list|)
expr_stmt|;
break|break;
case|case
name|PROTREJ
case|:
name|fsm_rprotrej
argument_list|(
name|f
argument_list|,
name|inp
argument_list|,
name|len
argument_list|)
expr_stmt|;
break|break;
case|case
name|ECHOREQ
case|:
name|FSMDEBUG
argument_list|(
operator|(
name|LOG_INFO
operator|,
literal|"lcp: Echo-Request, Rcvd id %d"
operator|,
name|id
operator|)
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|f
operator|->
name|state
condition|)
block|{
case|case
name|CLOSED
case|:
case|case
name|LISTEN
case|:
name|fsm_sdata
argument_list|(
name|f
argument_list|,
name|TERMACK
argument_list|,
name|id
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
break|break;
case|case
name|OPEN
case|:
name|inp
operator|=
name|inpacket
expr_stmt|;
comment|/* Reset to header */
name|outp
operator|=
name|outpacket_buf
expr_stmt|;
comment|/* get pointer to output buffer */
name|MAKEHEADER
argument_list|(
name|outp
argument_list|,
name|f
operator|->
name|protocol
argument_list|)
expr_stmt|;
comment|/* add DLL header */
name|len
operator|+=
name|HEADERLEN
expr_stmt|;
comment|/* add header length */
name|BCOPY
argument_list|(
name|inp
argument_list|,
name|outp
argument_list|,
name|len
argument_list|)
expr_stmt|;
comment|/* copy input packet to output buffer */
name|PUTCHAR
argument_list|(
name|ECHOREP
argument_list|,
name|outp
argument_list|)
expr_stmt|;
comment|/* set code to echo reply */
name|PUTCHAR
argument_list|(
name|id
argument_list|,
name|outp
argument_list|)
expr_stmt|;
comment|/* add in id */
name|PUTSHORT
argument_list|(
name|len
argument_list|,
name|outp
argument_list|)
expr_stmt|;
comment|/* and length */
name|output
argument_list|(
name|f
operator|->
name|unit
argument_list|,
name|outpacket_buf
argument_list|,
name|len
operator|+
name|DLLHEADERLEN
argument_list|)
expr_stmt|;
comment|/* send it */
return|return;
block|}
break|break;
case|case
name|ECHOREP
case|:
case|case
name|DISCREQ
case|:
comment|/* XXX Deliver to ECHOREQ sender? */
break|break;
default|default:
name|fsm_sdata
argument_list|(
name|f
argument_list|,
name|CODEREJ
argument_list|,
operator|++
name|f
operator|->
name|id
argument_list|,
name|inpacket
argument_list|,
name|len
operator|+
name|HEADERLEN
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
end_function

begin_comment
comment|/*  * fsm_rconfack - Receive Configure-Ack.  */
end_comment

begin_function
specifier|static
name|void
name|fsm_rconfack
parameter_list|(
name|f
parameter_list|,
name|inp
parameter_list|,
name|id
parameter_list|,
name|len
parameter_list|)
name|fsm
modifier|*
name|f
decl_stmt|;
name|u_char
modifier|*
name|inp
decl_stmt|;
name|u_char
name|id
decl_stmt|;
name|int
name|len
decl_stmt|;
block|{
name|FSMDEBUG
argument_list|(
argument|(LOG_INFO,
literal|"fsm_rconfack(%x): Rcvd id %d."
argument|, 	      f->protocol, id)
argument_list|)
switch|switch
condition|(
name|f
operator|->
name|state
condition|)
block|{
case|case
name|LISTEN
case|:
case|case
name|CLOSED
case|:
name|fsm_sdata
argument_list|(
name|f
argument_list|,
name|TERMACK
argument_list|,
name|id
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
break|break;
case|case
name|ACKRCVD
case|:
case|case
name|REQSENT
case|:
if|if
condition|(
name|id
operator|!=
name|f
operator|->
name|reqid
condition|)
comment|/* Expected id? */
break|break;
comment|/* Nope, toss... */
if|if
condition|(
name|f
operator|->
name|callbacks
operator|->
name|ackci
operator|&&
call|(
modifier|*
name|f
operator|->
name|callbacks
operator|->
name|ackci
call|)
argument_list|(
name|f
argument_list|,
name|inp
argument_list|,
name|len
argument_list|)
condition|)
comment|/* Good ack? */
name|f
operator|->
name|state
operator|=
name|ACKRCVD
expr_stmt|;
else|else
name|f
operator|->
name|state
operator|=
name|REQSENT
expr_stmt|;
comment|/* Wait for timeout to retransmit */
break|break;
case|case
name|ACKSENT
case|:
if|if
condition|(
name|id
operator|!=
name|f
operator|->
name|reqid
condition|)
comment|/* Expected id? */
break|break;
comment|/* Nope, toss... */
if|if
condition|(
name|f
operator|->
name|callbacks
operator|->
name|ackci
operator|&&
call|(
modifier|*
name|f
operator|->
name|callbacks
operator|->
name|ackci
call|)
argument_list|(
name|f
argument_list|,
name|inp
argument_list|,
name|len
argument_list|)
condition|)
block|{
comment|/* Good ack? */
name|UNTIMEOUT
argument_list|(
name|fsm_timeout
argument_list|,
operator|(
name|caddr_t
operator|)
name|f
argument_list|)
expr_stmt|;
comment|/* Cancel timeout */
if|if
condition|(
name|f
operator|->
name|callbacks
operator|->
name|up
condition|)
call|(
modifier|*
name|f
operator|->
name|callbacks
operator|->
name|up
call|)
argument_list|(
name|f
argument_list|)
expr_stmt|;
comment|/* Inform upper layers */
name|f
operator|->
name|state
operator|=
name|OPEN
expr_stmt|;
block|}
else|else
name|f
operator|->
name|state
operator|=
name|REQSENT
expr_stmt|;
comment|/* Wait for timeout to retransmit */
break|break;
case|case
name|OPEN
case|:
if|if
condition|(
name|f
operator|->
name|callbacks
operator|->
name|down
condition|)
call|(
modifier|*
name|f
operator|->
name|callbacks
operator|->
name|down
call|)
argument_list|(
name|f
argument_list|)
expr_stmt|;
comment|/* Inform upper layers */
name|f
operator|->
name|state
operator|=
name|CLOSED
expr_stmt|;
comment|/* Only for a moment... */
name|fsm_activeopen
argument_list|(
name|f
argument_list|)
expr_stmt|;
comment|/* Restart */
break|break;
block|}
block|}
end_function

begin_comment
comment|/*  * fsm_rconfnak - Receive Configure-Nak.  */
end_comment

begin_function
specifier|static
name|void
name|fsm_rconfnak
parameter_list|(
name|f
parameter_list|,
name|inp
parameter_list|,
name|id
parameter_list|,
name|len
parameter_list|)
name|fsm
modifier|*
name|f
decl_stmt|;
name|u_char
modifier|*
name|inp
decl_stmt|;
name|u_char
name|id
decl_stmt|;
name|int
name|len
decl_stmt|;
block|{
name|FSMDEBUG
argument_list|(
argument|(LOG_INFO,
literal|"fsm_rconfnak(%x): Rcvd id %d."
argument|, 	      f->protocol, id)
argument_list|)
switch|switch
condition|(
name|f
operator|->
name|state
condition|)
block|{
case|case
name|LISTEN
case|:
case|case
name|CLOSED
case|:
name|fsm_sdata
argument_list|(
name|f
argument_list|,
name|TERMACK
argument_list|,
name|id
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
break|break;
case|case
name|REQSENT
case|:
case|case
name|ACKSENT
case|:
if|if
condition|(
name|id
operator|!=
name|f
operator|->
name|reqid
condition|)
comment|/* Expected id? */
break|break;
comment|/* Nope, toss... */
if|if
condition|(
operator|++
name|f
operator|->
name|nakloops
operator|>
name|f
operator|->
name|maxnakloops
condition|)
block|{
name|FSMDEBUG
argument_list|(
argument|(LOG_INFO,
literal|"fsm_rconfnak(%x): Possible CONFNAK loop!"
argument|, 		      f->protocol)
argument_list|)
break|break;
comment|/* Break the loop */
block|}
name|UNTIMEOUT
argument_list|(
name|fsm_timeout
argument_list|,
operator|(
name|caddr_t
operator|)
name|f
argument_list|)
expr_stmt|;
comment|/* Cancel timeout */
if|if
condition|(
name|f
operator|->
name|callbacks
operator|->
name|nakci
condition|)
call|(
modifier|*
name|f
operator|->
name|callbacks
operator|->
name|nakci
call|)
argument_list|(
name|f
argument_list|,
name|inp
argument_list|,
name|len
argument_list|)
expr_stmt|;
name|fsm_sconfreq
argument_list|(
name|f
argument_list|)
expr_stmt|;
comment|/* Send Configure-Request */
name|TIMEOUT
argument_list|(
name|fsm_timeout
argument_list|,
operator|(
name|caddr_t
operator|)
name|f
argument_list|,
name|f
operator|->
name|timeouttime
argument_list|)
expr_stmt|;
operator|++
name|f
operator|->
name|retransmits
expr_stmt|;
break|break;
case|case
name|ACKRCVD
case|:
name|f
operator|->
name|state
operator|=
name|REQSENT
expr_stmt|;
comment|/* Wait for timeout to retransmit */
break|break;
case|case
name|OPEN
case|:
if|if
condition|(
name|f
operator|->
name|callbacks
operator|->
name|down
condition|)
call|(
modifier|*
name|f
operator|->
name|callbacks
operator|->
name|down
call|)
argument_list|(
name|f
argument_list|)
expr_stmt|;
comment|/* Inform upper layers */
name|f
operator|->
name|state
operator|=
name|CLOSED
expr_stmt|;
comment|/* Only for a moment... */
name|fsm_activeopen
argument_list|(
name|f
argument_list|)
expr_stmt|;
comment|/* Restart */
break|break;
block|}
block|}
end_function

begin_comment
comment|/*  * fsm_rconfrej - Receive Configure-Rej.  */
end_comment

begin_function
specifier|static
name|void
name|fsm_rconfrej
parameter_list|(
name|f
parameter_list|,
name|inp
parameter_list|,
name|id
parameter_list|,
name|len
parameter_list|)
name|fsm
modifier|*
name|f
decl_stmt|;
name|u_char
modifier|*
name|inp
decl_stmt|;
name|u_char
name|id
decl_stmt|;
name|int
name|len
decl_stmt|;
block|{
name|FSMDEBUG
argument_list|(
argument|(LOG_INFO,
literal|"fsm_rconfrej(%x): Rcvd id %d."
argument|, 	      f->protocol, id)
argument_list|)
switch|switch
condition|(
name|f
operator|->
name|state
condition|)
block|{
case|case
name|LISTEN
case|:
case|case
name|CLOSED
case|:
name|fsm_sdata
argument_list|(
name|f
argument_list|,
name|TERMACK
argument_list|,
name|id
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
break|break;
case|case
name|REQSENT
case|:
case|case
name|ACKSENT
case|:
if|if
condition|(
name|id
operator|!=
name|f
operator|->
name|reqid
condition|)
comment|/* Expected id? */
break|break;
comment|/* Nope, toss... */
if|if
condition|(
operator|++
name|f
operator|->
name|nakloops
operator|>
name|f
operator|->
name|maxnakloops
condition|)
break|break;
comment|/* Break the loop */
name|UNTIMEOUT
argument_list|(
name|fsm_timeout
argument_list|,
operator|(
name|caddr_t
operator|)
name|f
argument_list|)
expr_stmt|;
comment|/* Cancel timeout */
if|if
condition|(
name|f
operator|->
name|callbacks
operator|->
name|rejci
condition|)
call|(
modifier|*
name|f
operator|->
name|callbacks
operator|->
name|rejci
call|)
argument_list|(
name|f
argument_list|,
name|inp
argument_list|,
name|len
argument_list|)
expr_stmt|;
name|fsm_sconfreq
argument_list|(
name|f
argument_list|)
expr_stmt|;
comment|/* Send Configure-Request */
name|TIMEOUT
argument_list|(
name|fsm_timeout
argument_list|,
operator|(
name|caddr_t
operator|)
name|f
argument_list|,
name|f
operator|->
name|timeouttime
argument_list|)
expr_stmt|;
operator|++
name|f
operator|->
name|retransmits
expr_stmt|;
break|break;
case|case
name|ACKRCVD
case|:
name|f
operator|->
name|state
operator|=
name|REQSENT
expr_stmt|;
comment|/* Wait for timeout to retransmit */
break|break;
case|case
name|OPEN
case|:
name|f
operator|->
name|state
operator|=
name|CLOSED
expr_stmt|;
comment|/* Only for a moment... */
name|fsm_activeopen
argument_list|(
name|f
argument_list|)
expr_stmt|;
comment|/* Restart */
break|break;
block|}
block|}
end_function

begin_comment
comment|/*  * fsm_rtermreq - Receive Terminate-Req.  */
end_comment

begin_function
specifier|static
name|void
name|fsm_rtermreq
parameter_list|(
name|f
parameter_list|,
name|id
parameter_list|)
name|fsm
modifier|*
name|f
decl_stmt|;
name|u_char
name|id
decl_stmt|;
block|{
name|FSMDEBUG
argument_list|(
argument|(LOG_INFO,
literal|"fsm_rtermreq(%x): Rcvd id %d."
argument|, 	      f->protocol, id)
argument_list|)
name|fsm_sdata
argument_list|(
name|f
argument_list|,
name|TERMACK
argument_list|,
name|id
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|f
operator|->
name|state
condition|)
block|{
case|case
name|ACKRCVD
case|:
case|case
name|ACKSENT
case|:
name|f
operator|->
name|state
operator|=
name|REQSENT
expr_stmt|;
comment|/* Start over but keep trying */
break|break;
case|case
name|OPEN
case|:
if|if
condition|(
name|f
operator|->
name|callbacks
operator|->
name|down
condition|)
call|(
modifier|*
name|f
operator|->
name|callbacks
operator|->
name|down
call|)
argument_list|(
name|f
argument_list|)
expr_stmt|;
comment|/* Inform upper layers */
name|f
operator|->
name|state
operator|=
name|CLOSED
expr_stmt|;
if|if
condition|(
name|f
operator|->
name|callbacks
operator|->
name|closed
condition|)
call|(
modifier|*
name|f
operator|->
name|callbacks
operator|->
name|closed
call|)
argument_list|(
name|f
argument_list|)
expr_stmt|;
comment|/* Exit/restart/etc. */
break|break;
block|}
block|}
end_function

begin_comment
comment|/*  * fsm_rtermack - Receive Terminate-Ack.  */
end_comment

begin_function
specifier|static
name|void
name|fsm_rtermack
parameter_list|(
name|f
parameter_list|)
name|fsm
modifier|*
name|f
decl_stmt|;
block|{
name|FSMDEBUG
argument_list|(
argument|(LOG_INFO,
literal|"fsm_rtermack(%x)."
argument|, f->protocol)
argument_list|)
switch|switch
condition|(
name|f
operator|->
name|state
condition|)
block|{
case|case
name|OPEN
case|:
if|if
condition|(
name|f
operator|->
name|callbacks
operator|->
name|down
condition|)
call|(
modifier|*
name|f
operator|->
name|callbacks
operator|->
name|down
call|)
argument_list|(
name|f
argument_list|)
expr_stmt|;
comment|/* Inform upper layers */
name|f
operator|->
name|state
operator|=
name|CLOSED
expr_stmt|;
if|if
condition|(
name|f
operator|->
name|callbacks
operator|->
name|closed
condition|)
call|(
modifier|*
name|f
operator|->
name|callbacks
operator|->
name|closed
call|)
argument_list|(
name|f
argument_list|)
expr_stmt|;
comment|/* Exit/restart/etc. */
break|break;
case|case
name|TERMSENT
case|:
name|UNTIMEOUT
argument_list|(
name|fsm_timeout
argument_list|,
operator|(
name|caddr_t
operator|)
name|f
argument_list|)
expr_stmt|;
comment|/* Cancel timeout */
name|f
operator|->
name|state
operator|=
name|CLOSED
expr_stmt|;
if|if
condition|(
name|f
operator|->
name|callbacks
operator|->
name|closed
condition|)
call|(
modifier|*
name|f
operator|->
name|callbacks
operator|->
name|closed
call|)
argument_list|(
name|f
argument_list|)
expr_stmt|;
comment|/* Exit/restart/etc. */
break|break;
block|}
block|}
end_function

begin_comment
comment|/*  * fsm_rcoderej - Receive an Code-Reject.  */
end_comment

begin_function
specifier|static
name|void
name|fsm_rcoderej
parameter_list|(
name|f
parameter_list|,
name|inp
parameter_list|,
name|len
parameter_list|)
name|fsm
modifier|*
name|f
decl_stmt|;
name|u_char
modifier|*
name|inp
decl_stmt|;
name|int
name|len
decl_stmt|;
block|{
name|u_char
name|code
decl_stmt|;
name|FSMDEBUG
argument_list|(
argument|(LOG_INFO,
literal|"fsm_rcoderej(%x)."
argument|, f->protocol)
argument_list|)
if|if
condition|(
name|len
operator|<
sizeof|sizeof
argument_list|(
name|u_char
argument_list|)
condition|)
block|{
name|FSMDEBUG
argument_list|(
argument|(LOG_INFO,
literal|"fsm_rcoderej: Rcvd short Code-Reject packet!"
argument|)
argument_list|)
return|return;
block|}
name|GETCHAR
argument_list|(
name|code
argument_list|,
name|inp
argument_list|)
expr_stmt|;
name|FSMDEBUG
argument_list|(
argument|(LOG_INFO,
literal|"fsm_rcoderej: Rcvd Code-Reject for code %d!"
argument|, 	      code)
argument_list|)
block|}
end_function

begin_comment
comment|/*  * fsm_rprotrej - Receive an Protocol-Reject.  *  * Figure out which protocol is rejected and inform it.  */
end_comment

begin_function
specifier|static
name|void
name|fsm_rprotrej
parameter_list|(
name|f
parameter_list|,
name|inp
parameter_list|,
name|len
parameter_list|)
name|fsm
modifier|*
name|f
decl_stmt|;
name|u_char
modifier|*
name|inp
decl_stmt|;
name|int
name|len
decl_stmt|;
block|{
name|u_short
name|prot
decl_stmt|;
name|FSMDEBUG
argument_list|(
argument|(LOG_INFO,
literal|"fsm_rprotrej."
argument|)
argument_list|)
if|if
condition|(
name|len
operator|<
sizeof|sizeof
argument_list|(
name|u_short
argument_list|)
condition|)
block|{
name|FSMDEBUG
argument_list|(
argument|(LOG_INFO,
literal|"fsm_rprotrej: Rcvd short Protocol-Reject packet!"
argument|)
argument_list|)
return|return;
block|}
if|if
condition|(
name|f
operator|->
name|protocol
operator|!=
name|LCP
condition|)
block|{
comment|/* Only valid for LCP */
name|FSMDEBUG
argument_list|(
argument|(LOG_INFO,
literal|"fsm_rprotrej: Rcvd non-LCP Protocol-Reject!"
argument|)
argument_list|)
return|return;
block|}
name|GETSHORT
argument_list|(
name|prot
argument_list|,
name|inp
argument_list|)
expr_stmt|;
name|FSMDEBUG
argument_list|(
argument|(LOG_INFO,
literal|"fsm_rprotrej: Rcvd Protocol-Reject packet for %x!"
argument|, 	      prot)
argument_list|)
name|DEMUXPROTREJ
argument_list|(
name|f
operator|->
name|unit
argument_list|,
name|prot
argument_list|)
expr_stmt|;
comment|/* Inform protocol */
block|}
end_function

begin_comment
comment|/*  * fsm_sconfreq - Send a Configure-Request.  */
end_comment

begin_function
specifier|static
name|void
name|fsm_sconfreq
parameter_list|(
name|f
parameter_list|)
name|fsm
modifier|*
name|f
decl_stmt|;
block|{
name|u_char
modifier|*
name|outp
decl_stmt|;
name|int
name|outlen
decl_stmt|;
name|outlen
operator|=
name|HEADERLEN
operator|+
operator|(
name|f
operator|->
name|callbacks
operator|->
name|cilen
condition|?
call|(
modifier|*
name|f
operator|->
name|callbacks
operator|->
name|cilen
call|)
argument_list|(
name|f
argument_list|)
else|:
literal|0
operator|)
expr_stmt|;
comment|/* XXX Adjust outlen to MTU */
name|outp
operator|=
name|outpacket_buf
expr_stmt|;
name|MAKEHEADER
argument_list|(
name|outp
argument_list|,
name|f
operator|->
name|protocol
argument_list|)
expr_stmt|;
name|PUTCHAR
argument_list|(
name|CONFREQ
argument_list|,
name|outp
argument_list|)
expr_stmt|;
name|PUTCHAR
argument_list|(
name|f
operator|->
name|reqid
operator|=
operator|++
name|f
operator|->
name|id
argument_list|,
name|outp
argument_list|)
expr_stmt|;
name|PUTSHORT
argument_list|(
name|outlen
argument_list|,
name|outp
argument_list|)
expr_stmt|;
if|if
condition|(
name|f
operator|->
name|callbacks
operator|->
name|cilen
operator|&&
name|f
operator|->
name|callbacks
operator|->
name|addci
condition|)
call|(
modifier|*
name|f
operator|->
name|callbacks
operator|->
name|addci
call|)
argument_list|(
name|f
argument_list|,
name|outp
argument_list|)
expr_stmt|;
name|output
argument_list|(
name|f
operator|->
name|unit
argument_list|,
name|outpacket_buf
argument_list|,
name|outlen
operator|+
name|DLLHEADERLEN
argument_list|)
expr_stmt|;
name|FSMDEBUG
argument_list|(
argument|(LOG_INFO,
literal|"%s: sending Configure-Request, id %d"
argument|, 	      proto_name(f->protocol), f->reqid)
argument_list|)
block|}
end_function

begin_comment
comment|/*  * fsm_sdata - Send some data.  *  * Used for Terminate-Request, Terminate-Ack, Code-Reject, Protocol-Reject,  * Echo-Request, and Discard-Request.  */
end_comment

begin_function
name|void
name|fsm_sdata
parameter_list|(
name|f
parameter_list|,
name|code
parameter_list|,
name|id
parameter_list|,
name|data
parameter_list|,
name|datalen
parameter_list|)
name|fsm
modifier|*
name|f
decl_stmt|;
name|u_char
name|code
decl_stmt|,
name|id
decl_stmt|;
name|u_char
modifier|*
name|data
decl_stmt|;
name|int
name|datalen
decl_stmt|;
block|{
name|u_char
modifier|*
name|outp
decl_stmt|;
name|int
name|outlen
decl_stmt|;
comment|/* Adjust length to be smaller than MTU */
if|if
condition|(
name|datalen
operator|>
name|MTU
operator|-
name|HEADERLEN
condition|)
name|datalen
operator|=
name|MTU
operator|-
name|HEADERLEN
expr_stmt|;
name|outlen
operator|=
name|datalen
operator|+
name|HEADERLEN
expr_stmt|;
name|outp
operator|=
name|outpacket_buf
expr_stmt|;
name|MAKEHEADER
argument_list|(
name|outp
argument_list|,
name|f
operator|->
name|protocol
argument_list|)
expr_stmt|;
name|PUTCHAR
argument_list|(
name|code
argument_list|,
name|outp
argument_list|)
expr_stmt|;
name|PUTCHAR
argument_list|(
name|id
argument_list|,
name|outp
argument_list|)
expr_stmt|;
name|PUTSHORT
argument_list|(
name|outlen
argument_list|,
name|outp
argument_list|)
expr_stmt|;
if|if
condition|(
name|datalen
condition|)
name|BCOPY
argument_list|(
name|data
argument_list|,
name|outp
argument_list|,
name|datalen
argument_list|)
expr_stmt|;
name|output
argument_list|(
name|f
operator|->
name|unit
argument_list|,
name|outpacket_buf
argument_list|,
name|outlen
operator|+
name|DLLHEADERLEN
argument_list|)
expr_stmt|;
name|FSMDEBUG
argument_list|(
argument|(LOG_INFO,
literal|"fsm_sdata(%x): Sent code %d, id %d."
argument|, 	      f->protocol, code, id)
argument_list|)
block|}
end_function

end_unit


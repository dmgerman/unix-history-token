begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/* elvprsv.c */
end_comment

begin_comment
comment|/* Author:  *	Steve Kirkendall  *	14407 SW Teal Blvd. #C  *	Beaverton, OR 97005  *	kirkenda@cs.pdx.edu  */
end_comment

begin_comment
comment|/* This file contains the portable sources for the "elvprsv" program.  * "Elvprsv" is run by Elvis when Elvis is about to die.  It is also  * run when the computer boots up.  It is not intended to be run directly  * by the user, ever.  *  * Basically, this program does the following four things:  *    - It extracts the text from the temporary file, and places the text in  *	a file in the /usr/preserve directory.  *    - It adds a line to the /usr/preserve/Index file, describing the file  *	that it just preserved.  *    - It removes the temporary file.  *    -	It sends mail to the owner of the file, saying that the file was  *	preserved, and how it can be recovered.  *  * The /usr/preserve/Index file is a log file that contains one line for each  * file that has ever been preserved.  Each line of this file describes one  * preserved file.  The first word on the line is the name of the file that  * contains the preserved text.  The second word is the full pathname of the  * file that was being edited; for anonymous buffers, this is the directory  * name plus "/foo".  *  * If elvprsv's first argument (after the command name) starts with a hyphen,  * then the characters after the hyphen are used as a description of when  * the editor went away.  This is optional.  *  * The remaining arguments are all the names of temporary files that are  * to be preserved.  For example, on a UNIX system, the /etc/rc file might  * invoke it this way:  *  *	elvprsv "-the system went down" /tmp/elv_*.*  *  * This file contains only the portable parts of the preserve program.  * It must #include a system-specific file.  The system-specific file is  * expected to define the following functions:  *  *	char *ownername(char *filename)	- returns name of person who owns file  *  *	void mail(char *user, char *name, char *when)  *					- tell user that file was preserved  */
end_comment

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_include
include|#
directive|include
file|"config.h"
end_include

begin_include
include|#
directive|include
file|"vi.h"
end_include

begin_comment
comment|/* We include ctype.c here (instead of including just ctype.h and linking  * with ctype.o) because on some systems ctype.o will have been compiled in  * "large model" and the elvprsv program is to be compiled in "small model"   * You can't mix models.  By including ctype.c here, we can avoid linking  * with ctype.o.  */
end_comment

begin_include
include|#
directive|include
file|"ctype.c"
end_include

begin_decl_stmt
name|void
name|preserve
name|P_
argument_list|(
operator|(
name|char
operator|*
operator|,
name|char
operator|*
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|void
decl|main
name|P_
argument_list|(
operator|(
name|int
operator|,
name|char
operator|*
operator|*
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_if
if|#
directive|if
name|AMIGA
end_if

begin_decl_stmt
name|BLK
name|tmpblk
decl_stmt|;
end_decl_stmt

begin_include
include|#
directive|include
file|"amiwild.c"
end_include

begin_include
include|#
directive|include
file|"amiprsv.c"
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_if
if|#
directive|if
name|OSK
end_if

begin_undef
undef|#
directive|undef
name|sprintf
end_undef

begin_endif
endif|#
directive|endif
end_endif

begin_if
if|#
directive|if
name|ANY_UNIX
operator|||
name|OSK
end_if

begin_include
include|#
directive|include
file|"prsvunix.c"
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_if
if|#
directive|if
name|MSDOS
operator|||
name|TOS
end_if

begin_include
include|#
directive|include
file|"prsvdos.c"
end_include

begin_define
define|#
directive|define
name|WILDCARD_NO_MAIN
end_define

begin_include
include|#
directive|include
file|"wildcard.c"
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_decl_stmt
name|BLK
name|buf
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|BLK
name|hdr
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|BLK
name|name
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|rewrite_now
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* boolean: should we send text directly to orig file? */
end_comment

begin_comment
comment|/* This function preserves a single file, and announces its success/failure  * via an e-mail message.  */
end_comment

begin_function
name|void
name|preserve
parameter_list|(
name|tname
parameter_list|,
name|when
parameter_list|)
name|char
modifier|*
name|tname
decl_stmt|;
comment|/* name of a temp file to be preserved */
name|char
modifier|*
name|when
decl_stmt|;
comment|/* description of when the editor died */
block|{
name|int
name|infd
decl_stmt|;
comment|/* fd used for reading from the temp file */
name|FILE
modifier|*
name|outfp
decl_stmt|;
comment|/* fp used for writing to the recovery file */
name|FILE
modifier|*
name|index
decl_stmt|;
comment|/* fp used for appending to index file */
name|char
name|outname
index|[
literal|100
index|]
decl_stmt|;
comment|/* the name of the recovery file */
name|char
modifier|*
name|user
decl_stmt|;
comment|/* name of the owner of the temp file */
if|#
directive|if
name|AMIGA
name|char
modifier|*
name|prsvdir
decl_stmt|;
endif|#
directive|endif
name|int
name|i
decl_stmt|;
comment|/* open the temp file */
name|infd
operator|=
name|open
argument_list|(
name|tname
argument_list|,
name|O_RDONLY
operator||
name|O_BINARY
argument_list|)
expr_stmt|;
if|if
condition|(
name|infd
operator|<
literal|0
condition|)
block|{
comment|/* if we can't open the file, then we should assume that 		 * the filename contains wildcard characters that weren't 		 * expanded... and also assume that they weren't expanded 		 * because there are no files that need to be preserved. 		 * THEREFORE... we should silently ignore it. 		 * (Or loudly ignore it if the user was using -R) 		 */
if|if
condition|(
name|rewrite_now
condition|)
block|{
name|perror
argument_list|(
name|tname
argument_list|)
expr_stmt|;
block|}
return|return;
block|}
comment|/* read the header and name from the file */
if|if
condition|(
name|read
argument_list|(
name|infd
argument_list|,
name|hdr
operator|.
name|c
argument_list|,
name|BLKSIZE
argument_list|)
operator|!=
name|BLKSIZE
operator|||
name|read
argument_list|(
name|infd
argument_list|,
name|name
operator|.
name|c
argument_list|,
name|BLKSIZE
argument_list|)
operator|!=
name|BLKSIZE
condition|)
block|{
comment|/* something wrong with the file - sorry */
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"%s: truncated header blocks\n"
argument_list|,
name|tname
argument_list|)
expr_stmt|;
name|close
argument_list|(
name|infd
argument_list|)
expr_stmt|;
return|return;
block|}
comment|/* If the filename block contains an empty string, then Elvis was 	 * only keeping the temp file around because it contained some text 	 * that was needed for a named cut buffer.  The user doesn't care 	 * about that kind of temp file, so we should silently delete it. 	 */
if|if
condition|(
name|name
operator|.
name|c
index|[
literal|0
index|]
operator|==
literal|'\0'
operator|&&
name|name
operator|.
name|c
index|[
literal|1
index|]
operator|==
literal|'\177'
condition|)
block|{
name|close
argument_list|(
name|infd
argument_list|)
expr_stmt|;
name|unlink
argument_list|(
name|tname
argument_list|)
expr_stmt|;
return|return;
block|}
comment|/* If there are no text blocks in the file, then we must've never 	 * really started editing.  Discard the file. 	 */
if|if
condition|(
name|hdr
operator|.
name|n
index|[
literal|1
index|]
operator|==
literal|0
condition|)
block|{
name|close
argument_list|(
name|infd
argument_list|)
expr_stmt|;
name|unlink
argument_list|(
name|tname
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|rewrite_now
condition|)
block|{
comment|/* we don't need to open the index file */
name|index
operator|=
operator|(
name|FILE
operator|*
operator|)
literal|0
expr_stmt|;
comment|/* make sure we can read every block! */
for|for
control|(
name|i
operator|=
literal|1
init|;
name|i
operator|<
name|MAXBLKS
operator|&&
name|hdr
operator|.
name|n
index|[
name|i
index|]
condition|;
name|i
operator|++
control|)
block|{
name|lseek
argument_list|(
name|infd
argument_list|,
operator|(
name|long
operator|)
name|hdr
operator|.
name|n
index|[
name|i
index|]
operator|*
operator|(
name|long
operator|)
name|BLKSIZE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|read
argument_list|(
name|infd
argument_list|,
name|buf
operator|.
name|c
argument_list|,
name|BLKSIZE
argument_list|)
operator|!=
name|BLKSIZE
operator|||
name|buf
operator|.
name|c
index|[
literal|0
index|]
operator|==
literal|'\0'
condition|)
block|{
comment|/* messed up header */
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"%s: unrecoverable -- header trashed\n"
argument_list|,
name|name
operator|.
name|c
argument_list|)
expr_stmt|;
name|close
argument_list|(
name|infd
argument_list|)
expr_stmt|;
return|return;
block|}
block|}
comment|/* open the user's file for writing */
name|outfp
operator|=
name|fopen
argument_list|(
name|name
operator|.
name|c
argument_list|,
literal|"w"
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|outfp
condition|)
block|{
name|perror
argument_list|(
name|name
operator|.
name|c
argument_list|)
expr_stmt|;
name|close
argument_list|(
name|infd
argument_list|)
expr_stmt|;
return|return;
block|}
block|}
else|else
block|{
comment|/* open/create the index file */
name|index
operator|=
name|fopen
argument_list|(
name|PRSVINDEX
argument_list|,
literal|"a"
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|index
condition|)
block|{
name|perror
argument_list|(
name|PRSVINDEX
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|2
argument_list|)
expr_stmt|;
block|}
comment|/* should be at the end of the file already, but MAKE SURE */
name|fseek
argument_list|(
name|index
argument_list|,
literal|0L
argument_list|,
literal|2
argument_list|)
expr_stmt|;
comment|/* create the recovery file in the PRESVDIR directory */
if|#
directive|if
name|AMIGA
name|prsvdir
operator|=
operator|&
name|PRSVDIR
index|[
name|strlen
argument_list|(
name|PRSVDIR
argument_list|)
operator|-
literal|1
index|]
expr_stmt|;
if|if
condition|(
operator|*
name|prsvdir
operator|==
literal|'/'
operator|||
operator|*
name|prsvdir
operator|==
literal|':'
condition|)
block|{
name|sprintf
argument_list|(
name|outname
argument_list|,
literal|"%sp%ld"
argument_list|,
name|PRSVDIR
argument_list|,
name|ftell
argument_list|(
name|index
argument_list|)
argument_list|)
expr_stmt|;
block|}
else|else
endif|#
directive|endif
name|sprintf
argument_list|(
name|outname
argument_list|,
literal|"%s%cp%ld"
argument_list|,
name|PRSVDIR
argument_list|,
name|SLASH
argument_list|,
name|ftell
argument_list|(
name|index
argument_list|)
argument_list|)
expr_stmt|;
name|outfp
operator|=
name|fopen
argument_list|(
name|outname
argument_list|,
literal|"w"
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|outfp
condition|)
block|{
name|perror
argument_list|(
name|outname
argument_list|)
expr_stmt|;
name|close
argument_list|(
name|infd
argument_list|)
expr_stmt|;
name|fclose
argument_list|(
name|index
argument_list|)
expr_stmt|;
return|return;
block|}
block|}
comment|/* write the text of the file out to the recovery file */
for|for
control|(
name|i
operator|=
literal|1
init|;
name|i
operator|<
name|MAXBLKS
operator|&&
name|hdr
operator|.
name|n
index|[
name|i
index|]
condition|;
name|i
operator|++
control|)
block|{
name|lseek
argument_list|(
name|infd
argument_list|,
operator|(
name|long
operator|)
name|hdr
operator|.
name|n
index|[
name|i
index|]
operator|*
operator|(
name|long
operator|)
name|BLKSIZE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|read
argument_list|(
name|infd
argument_list|,
name|buf
operator|.
name|c
argument_list|,
name|BLKSIZE
argument_list|)
operator|!=
name|BLKSIZE
operator|||
name|buf
operator|.
name|c
index|[
literal|0
index|]
operator|==
literal|'\0'
condition|)
block|{
comment|/* messed up header */
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"%s: unrecoverable -- header trashed\n"
argument_list|,
name|name
operator|.
name|c
argument_list|)
expr_stmt|;
name|fclose
argument_list|(
name|outfp
argument_list|)
expr_stmt|;
name|close
argument_list|(
name|infd
argument_list|)
expr_stmt|;
if|if
condition|(
name|index
condition|)
block|{
name|fclose
argument_list|(
name|index
argument_list|)
expr_stmt|;
block|}
name|unlink
argument_list|(
name|outname
argument_list|)
expr_stmt|;
return|return;
block|}
name|fputs
argument_list|(
name|buf
operator|.
name|c
argument_list|,
name|outfp
argument_list|)
expr_stmt|;
block|}
comment|/* add a line to the index file */
if|if
condition|(
name|index
condition|)
block|{
name|fprintf
argument_list|(
name|index
argument_list|,
literal|"%s %s\n"
argument_list|,
name|outname
argument_list|,
name|name
operator|.
name|c
argument_list|)
expr_stmt|;
block|}
comment|/* close everything */
name|close
argument_list|(
name|infd
argument_list|)
expr_stmt|;
name|fclose
argument_list|(
name|outfp
argument_list|)
expr_stmt|;
if|if
condition|(
name|index
condition|)
block|{
name|fclose
argument_list|(
name|index
argument_list|)
expr_stmt|;
block|}
comment|/* Are we doing this due to something more frightening than just 	 * a ":preserve" command? 	 */
if|if
condition|(
operator|*
name|when
condition|)
block|{
comment|/* send a mail message */
name|mail
argument_list|(
name|ownername
argument_list|(
name|tname
argument_list|)
argument_list|,
name|name
operator|.
name|c
argument_list|,
name|when
argument_list|)
expr_stmt|;
comment|/* remove the temp file -- the editor has died already */
name|unlink
argument_list|(
name|tname
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
name|void
name|main
parameter_list|(
name|argc
parameter_list|,
name|argv
parameter_list|)
name|int
name|argc
decl_stmt|;
name|char
modifier|*
modifier|*
name|argv
decl_stmt|;
block|{
name|int
name|i
decl_stmt|;
name|char
modifier|*
name|when
init|=
literal|"the editor went away"
decl_stmt|;
if|#
directive|if
name|MSDOS
operator|||
name|TOS
comment|/* expand any wildcards in the command line */
name|_ct_init
argument_list|(
literal|""
argument_list|)
expr_stmt|;
name|argv
operator|=
name|wildexpand
argument_list|(
operator|&
name|argc
argument_list|,
name|argv
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* do we have a "-c", "-R", or "-when elvis died" argument? */
name|i
operator|=
literal|1
expr_stmt|;
if|if
condition|(
name|argc
operator|>=
name|i
operator|+
literal|1
operator|&&
operator|!
name|strcmp
argument_list|(
name|argv
index|[
name|i
index|]
argument_list|,
literal|"-R"
argument_list|)
condition|)
block|{
name|rewrite_now
operator|=
literal|1
expr_stmt|;
name|when
operator|=
literal|""
expr_stmt|;
name|i
operator|++
expr_stmt|;
if|#
directive|if
name|ANY_UNIX
name|setuid
argument_list|(
name|geteuid
argument_list|()
argument_list|)
expr_stmt|;
endif|#
directive|endif
block|}
if|#
directive|if
name|OSK
else|else
block|{
name|setuid
argument_list|(
literal|0
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
if|if
condition|(
name|argc
operator|>=
name|i
operator|+
literal|1
operator|&&
name|argv
index|[
name|i
index|]
index|[
literal|0
index|]
operator|==
literal|'-'
condition|)
block|{
name|when
operator|=
name|argv
index|[
name|i
index|]
operator|+
literal|1
expr_stmt|;
name|i
operator|++
expr_stmt|;
block|}
comment|/* preserve everything we're supposed to */
while|while
condition|(
name|i
operator|<
name|argc
condition|)
block|{
name|preserve
argument_list|(
name|argv
index|[
name|i
index|]
argument_list|,
name|when
argument_list|)
expr_stmt|;
name|i
operator|++
expr_stmt|;
block|}
block|}
end_function

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Copyright (c) 1988-1990  *      The Regents of the University of California.  All rights reserved.  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that:  * 1. Source code distributions retain the above copyright  *    notice and this paragraph in its entirety  * 2. Distributions including binary code include the above copyright  *    notice and this paragraph in its entirety in the documentation  *    or other materials provided with the distribution, and   * 3. Neither the name of the University nor the names of its contributors  *    may be used to endorse or promote products derived from this software  *    without specific prior written permission.  *  * THIS SOFTWARE IS PROVIDED ``AS IS'' AND WITHOUT ANY EXPRESS OR IMPLIED  * WARRANTIES, INCLUDING, WITHOUT LIMITATION, THE IMPLIED WARRANTIES OF  * MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE.  *  * Format and print bootp packets.  *  * This file was copied from tcpdump-2.1.1 and modified.  * There is an e-mail list for tcpdump:<tcpdump@ee.lbl.gov>  *  * $FreeBSD$  */
end_comment

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_include
include|#
directive|include
file|<sys/param.h>
end_include

begin_include
include|#
directive|include
file|<sys/types.h>
end_include

begin_include
include|#
directive|include
file|<sys/socket.h>
end_include

begin_include
include|#
directive|include
file|<sys/time.h>
end_include

begin_comment
comment|/* for struct timeval in net/if.h */
end_comment

begin_include
include|#
directive|include
file|<net/if.h>
end_include

begin_include
include|#
directive|include
file|<netinet/in.h>
end_include

begin_include
include|#
directive|include
file|<string.h>
end_include

begin_include
include|#
directive|include
file|<ctype.h>
end_include

begin_include
include|#
directive|include
file|"bootp.h"
end_include

begin_include
include|#
directive|include
file|"bootptest.h"
end_include

begin_comment
comment|/* These decode the vendor data. */
end_comment

begin_function_decl
specifier|extern
name|int
name|printfn
parameter_list|()
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|rfc1048_print
parameter_list|()
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|cmu_print
parameter_list|()
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|other_print
parameter_list|()
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|dump_hex
parameter_list|()
function_decl|;
end_function_decl

begin_comment
comment|/*  * Print bootp requests  */
end_comment

begin_function
name|void
name|bootp_print
parameter_list|(
name|bp
parameter_list|,
name|length
parameter_list|,
name|sport
parameter_list|,
name|dport
parameter_list|)
name|struct
name|bootp
modifier|*
name|bp
decl_stmt|;
name|int
name|length
decl_stmt|;
name|u_short
name|sport
decl_stmt|,
name|dport
decl_stmt|;
block|{
specifier|static
name|char
name|tstr
index|[]
init|=
literal|" [|bootp]"
decl_stmt|;
specifier|static
name|unsigned
name|char
name|vm_cmu
index|[
literal|4
index|]
init|=
name|VM_CMU
decl_stmt|;
specifier|static
name|unsigned
name|char
name|vm_rfc1048
index|[
literal|4
index|]
init|=
name|VM_RFC1048
decl_stmt|;
name|u_char
modifier|*
name|ep
decl_stmt|;
name|int
name|vdlen
decl_stmt|;
define|#
directive|define
name|TCHECK
parameter_list|(
name|var
parameter_list|,
name|l
parameter_list|)
value|if ((u_char *)&(var)> ep - l) goto trunc
comment|/* Note funny sized packets */
if|if
condition|(
name|length
operator|!=
sizeof|sizeof
argument_list|(
expr|struct
name|bootp
argument_list|)
condition|)
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|" [len=%d]"
argument_list|,
name|length
argument_list|)
expr_stmt|;
comment|/* 'ep' points to the end of avaible data. */
name|ep
operator|=
operator|(
name|u_char
operator|*
operator|)
name|snapend
expr_stmt|;
switch|switch
condition|(
name|bp
operator|->
name|bp_op
condition|)
block|{
case|case
name|BOOTREQUEST
case|:
comment|/* Usually, a request goes from a client to a server */
if|if
condition|(
name|sport
operator|!=
name|IPPORT_BOOTPC
operator|||
name|dport
operator|!=
name|IPPORT_BOOTPS
condition|)
name|printf
argument_list|(
literal|" (request)"
argument_list|)
expr_stmt|;
break|break;
case|case
name|BOOTREPLY
case|:
comment|/* Usually, a reply goes from a server to a client */
if|if
condition|(
name|sport
operator|!=
name|IPPORT_BOOTPS
operator|||
name|dport
operator|!=
name|IPPORT_BOOTPC
condition|)
name|printf
argument_list|(
literal|" (reply)"
argument_list|)
expr_stmt|;
break|break;
default|default:
name|printf
argument_list|(
literal|" bootp-#%d"
argument_list|,
name|bp
operator|->
name|bp_op
argument_list|)
expr_stmt|;
block|}
comment|/* The usual hardware address type is 1 (10Mb Ethernet) */
if|if
condition|(
name|bp
operator|->
name|bp_htype
operator|!=
literal|1
condition|)
name|printf
argument_list|(
literal|" htype:%d"
argument_list|,
name|bp
operator|->
name|bp_htype
argument_list|)
expr_stmt|;
comment|/* The usual length for 10Mb Ethernet address is 6 bytes */
if|if
condition|(
name|bp
operator|->
name|bp_hlen
operator|!=
literal|6
condition|)
name|printf
argument_list|(
literal|" hlen:%d"
argument_list|,
name|bp
operator|->
name|bp_hlen
argument_list|)
expr_stmt|;
comment|/* Client's Hardware address */
if|if
condition|(
name|bp
operator|->
name|bp_hlen
condition|)
block|{
specifier|register
name|struct
name|ether_header
modifier|*
name|eh
decl_stmt|;
specifier|register
name|char
modifier|*
name|e
decl_stmt|;
name|TCHECK
argument_list|(
name|bp
operator|->
name|bp_chaddr
index|[
literal|0
index|]
argument_list|,
literal|6
argument_list|)
expr_stmt|;
name|eh
operator|=
operator|(
expr|struct
name|ether_header
operator|*
operator|)
name|packetp
expr_stmt|;
if|if
condition|(
name|bp
operator|->
name|bp_op
operator|==
name|BOOTREQUEST
condition|)
name|e
operator|=
operator|(
name|char
operator|*
operator|)
name|ESRC
argument_list|(
name|eh
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|bp
operator|->
name|bp_op
operator|==
name|BOOTREPLY
condition|)
name|e
operator|=
operator|(
name|char
operator|*
operator|)
name|EDST
argument_list|(
name|eh
argument_list|)
expr_stmt|;
else|else
name|e
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|e
operator|==
literal|0
operator|||
name|bcmp
argument_list|(
operator|(
name|char
operator|*
operator|)
name|bp
operator|->
name|bp_chaddr
argument_list|,
name|e
argument_list|,
literal|6
argument_list|)
condition|)
name|dump_hex
argument_list|(
name|bp
operator|->
name|bp_chaddr
argument_list|,
name|bp
operator|->
name|bp_hlen
argument_list|)
expr_stmt|;
block|}
comment|/* Only print interesting fields */
if|if
condition|(
name|bp
operator|->
name|bp_hops
condition|)
name|printf
argument_list|(
literal|" hops:%d"
argument_list|,
name|bp
operator|->
name|bp_hops
argument_list|)
expr_stmt|;
if|if
condition|(
name|bp
operator|->
name|bp_xid
condition|)
name|printf
argument_list|(
literal|" xid:%ld"
argument_list|,
operator|(
name|long
operator|)
name|ntohl
argument_list|(
name|bp
operator|->
name|bp_xid
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|bp
operator|->
name|bp_secs
condition|)
name|printf
argument_list|(
literal|" secs:%d"
argument_list|,
name|ntohs
argument_list|(
name|bp
operator|->
name|bp_secs
argument_list|)
argument_list|)
expr_stmt|;
comment|/* Client's ip address */
name|TCHECK
argument_list|(
name|bp
operator|->
name|bp_ciaddr
argument_list|,
sizeof|sizeof
argument_list|(
name|bp
operator|->
name|bp_ciaddr
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|bp
operator|->
name|bp_ciaddr
operator|.
name|s_addr
condition|)
name|printf
argument_list|(
literal|" C:%s"
argument_list|,
name|ipaddr_string
argument_list|(
operator|&
name|bp
operator|->
name|bp_ciaddr
argument_list|)
argument_list|)
expr_stmt|;
comment|/* 'your' ip address (bootp client) */
name|TCHECK
argument_list|(
name|bp
operator|->
name|bp_yiaddr
argument_list|,
sizeof|sizeof
argument_list|(
name|bp
operator|->
name|bp_yiaddr
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|bp
operator|->
name|bp_yiaddr
operator|.
name|s_addr
condition|)
name|printf
argument_list|(
literal|" Y:%s"
argument_list|,
name|ipaddr_string
argument_list|(
operator|&
name|bp
operator|->
name|bp_yiaddr
argument_list|)
argument_list|)
expr_stmt|;
comment|/* Server's ip address */
name|TCHECK
argument_list|(
name|bp
operator|->
name|bp_siaddr
argument_list|,
sizeof|sizeof
argument_list|(
name|bp
operator|->
name|bp_siaddr
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|bp
operator|->
name|bp_siaddr
operator|.
name|s_addr
condition|)
name|printf
argument_list|(
literal|" S:%s"
argument_list|,
name|ipaddr_string
argument_list|(
operator|&
name|bp
operator|->
name|bp_siaddr
argument_list|)
argument_list|)
expr_stmt|;
comment|/* Gateway's ip address */
name|TCHECK
argument_list|(
name|bp
operator|->
name|bp_giaddr
argument_list|,
sizeof|sizeof
argument_list|(
name|bp
operator|->
name|bp_giaddr
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|bp
operator|->
name|bp_giaddr
operator|.
name|s_addr
condition|)
name|printf
argument_list|(
literal|" G:%s"
argument_list|,
name|ipaddr_string
argument_list|(
operator|&
name|bp
operator|->
name|bp_giaddr
argument_list|)
argument_list|)
expr_stmt|;
name|TCHECK
argument_list|(
name|bp
operator|->
name|bp_sname
index|[
literal|0
index|]
argument_list|,
sizeof|sizeof
argument_list|(
name|bp
operator|->
name|bp_sname
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|*
name|bp
operator|->
name|bp_sname
condition|)
block|{
name|printf
argument_list|(
literal|" sname:"
argument_list|)
expr_stmt|;
if|if
condition|(
name|printfn
argument_list|(
name|bp
operator|->
name|bp_sname
argument_list|,
name|ep
argument_list|)
condition|)
block|{
name|fputs
argument_list|(
name|tstr
operator|+
literal|1
argument_list|,
name|stdout
argument_list|)
expr_stmt|;
return|return;
block|}
block|}
name|TCHECK
argument_list|(
name|bp
operator|->
name|bp_file
index|[
literal|0
index|]
argument_list|,
sizeof|sizeof
argument_list|(
name|bp
operator|->
name|bp_file
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|*
name|bp
operator|->
name|bp_file
condition|)
block|{
name|printf
argument_list|(
literal|" file:"
argument_list|)
expr_stmt|;
if|if
condition|(
name|printfn
argument_list|(
name|bp
operator|->
name|bp_file
argument_list|,
name|ep
argument_list|)
condition|)
block|{
name|fputs
argument_list|(
name|tstr
operator|+
literal|1
argument_list|,
name|stdout
argument_list|)
expr_stmt|;
return|return;
block|}
block|}
comment|/* Don't try to decode the vendor buffer unless we're verbose */
if|if
condition|(
name|vflag
operator|<=
literal|0
condition|)
return|return;
name|vdlen
operator|=
sizeof|sizeof
argument_list|(
name|bp
operator|->
name|bp_vend
argument_list|)
expr_stmt|;
comment|/* Vendor data can extend to the end of the packet. */
if|if
condition|(
name|vdlen
operator|<
operator|(
name|ep
operator|-
name|bp
operator|->
name|bp_vend
operator|)
condition|)
name|vdlen
operator|=
operator|(
name|ep
operator|-
name|bp
operator|->
name|bp_vend
operator|)
expr_stmt|;
name|TCHECK
argument_list|(
name|bp
operator|->
name|bp_vend
index|[
literal|0
index|]
argument_list|,
name|vdlen
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|" vend"
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|bcmp
argument_list|(
name|bp
operator|->
name|bp_vend
argument_list|,
name|vm_rfc1048
argument_list|,
sizeof|sizeof
argument_list|(
name|u_int32
argument_list|)
argument_list|)
condition|)
name|rfc1048_print
argument_list|(
name|bp
operator|->
name|bp_vend
argument_list|,
name|vdlen
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
operator|!
name|bcmp
argument_list|(
name|bp
operator|->
name|bp_vend
argument_list|,
name|vm_cmu
argument_list|,
sizeof|sizeof
argument_list|(
name|u_int32
argument_list|)
argument_list|)
condition|)
name|cmu_print
argument_list|(
name|bp
operator|->
name|bp_vend
argument_list|,
name|vdlen
argument_list|)
expr_stmt|;
else|else
name|other_print
argument_list|(
name|bp
operator|->
name|bp_vend
argument_list|,
name|vdlen
argument_list|)
expr_stmt|;
return|return;
name|trunc
label|:
name|fputs
argument_list|(
name|tstr
argument_list|,
name|stdout
argument_list|)
expr_stmt|;
undef|#
directive|undef
name|TCHECK
block|}
end_function

begin_escape
end_escape

begin_comment
comment|/*  * Option description data follows.  * These are described in: RFC-1048, RFC-1395, RFC-1497, RFC-1533  *  * The first char of each option string encodes the data format:  * ?: unknown  * a: ASCII  * b: byte (8-bit)  * i: inet address  * l: int32  * s: short (16-bit)  */
end_comment

begin_decl_stmt
name|char
modifier|*
name|rfc1048_opts
index|[]
init|=
block|{
comment|/* Originally from RFC-1048: */
literal|"?PAD"
block|,
comment|/*  0: Padding - special, no data. */
literal|"iSM"
block|,
comment|/*  1: subnet mask (RFC950)*/
literal|"lTZ"
block|,
comment|/*  2: time offset, seconds from UTC */
literal|"iGW"
block|,
comment|/*  3: gateways (or routers) */
literal|"iTS"
block|,
comment|/*  4: time servers (RFC868) */
literal|"iINS"
block|,
comment|/*  5: IEN name servers (IEN116) */
literal|"iDNS"
block|,
comment|/*  6: domain name servers (RFC1035)(1034?) */
literal|"iLOG"
block|,
comment|/*  7: MIT log servers */
literal|"iCS"
block|,
comment|/*  8: cookie servers (RFC865) */
literal|"iLPR"
block|,
comment|/*  9: lpr server (RFC1179) */
literal|"iIPS"
block|,
comment|/* 10: impress servers (Imagen) */
literal|"iRLP"
block|,
comment|/* 11: resource location servers (RFC887) */
literal|"aHN"
block|,
comment|/* 12: host name (ASCII) */
literal|"sBFS"
block|,
comment|/* 13: boot file size (in 512 byte blocks) */
comment|/* Added by RFC-1395: */
literal|"aDUMP"
block|,
comment|/* 14: Merit Dump File */
literal|"aDNAM"
block|,
comment|/* 15: Domain Name (for DNS) */
literal|"iSWAP"
block|,
comment|/* 16: Swap Server */
literal|"aROOT"
block|,
comment|/* 17: Root Path */
comment|/* Added by RFC-1497: */
literal|"aEXTF"
block|,
comment|/* 18: Extensions Path (more options) */
comment|/* Added by RFC-1533: (many, many options...) */
if|#
directive|if
literal|1
comment|/* These might not be worth recognizing by name. */
comment|/* IP Layer Parameters, per-host (RFC-1533, sect. 4) */
literal|"bIP-forward"
block|,
comment|/* 19: IP Forwarding flag */
literal|"bIP-srcroute"
block|,
comment|/* 20: IP Source Routing Enable flag */
literal|"iIP-filters"
block|,
comment|/* 21: IP Policy Filter (addr pairs) */
literal|"sIP-maxudp"
block|,
comment|/* 22: IP Max-UDP reassembly size */
literal|"bIP-ttlive"
block|,
comment|/* 23: IP Time to Live */
literal|"lIP-pmtuage"
block|,
comment|/* 24: IP Path MTU aging timeout */
literal|"sIP-pmtutab"
block|,
comment|/* 25: IP Path MTU plateau table */
comment|/* IP parameters, per-interface (RFC-1533, sect. 5) */
literal|"sIP-mtu-sz"
block|,
comment|/* 26: IP MTU size */
literal|"bIP-mtu-sl"
block|,
comment|/* 27: IP MTU all subnets local */
literal|"bIP-bcast1"
block|,
comment|/* 28: IP Broadcast Addr ones flag */
literal|"bIP-mask-d"
block|,
comment|/* 29: IP do mask discovery */
literal|"bIP-mask-s"
block|,
comment|/* 30: IP do mask supplier */
literal|"bIP-rt-dsc"
block|,
comment|/* 31: IP do router discovery */
literal|"iIP-rt-sa"
block|,
comment|/* 32: IP router solicitation addr */
literal|"iIP-routes"
block|,
comment|/* 33: IP static routes (dst,router) */
comment|/* Link Layer parameters, per-interface (RFC-1533, sect. 6) */
literal|"bLL-trailer"
block|,
comment|/* 34: do tralier encapsulation */
literal|"lLL-arp-tmo"
block|,
comment|/* 35: ARP cache timeout */
literal|"bLL-ether2"
block|,
comment|/* 36: Ethernet version 2 (IEEE 802.3) */
comment|/* TCP parameters (RFC-1533, sect. 7) */
literal|"bTCP-def-ttl"
block|,
comment|/* 37: default time to live */
literal|"lTCP-KA-tmo"
block|,
comment|/* 38: keepalive time interval */
literal|"bTCP-KA-junk"
block|,
comment|/* 39: keepalive sends extra junk */
comment|/* Application and Service Parameters (RFC-1533, sect. 8) */
literal|"aNISDOM"
block|,
comment|/* 40: NIS Domain (Sun YP) */
literal|"iNISSRV"
block|,
comment|/* 41: NIS Servers */
literal|"iNTPSRV"
block|,
comment|/* 42: NTP (time) Servers (RFC 1129) */
literal|"?VSINFO"
block|,
comment|/* 43: Vendor Specific Info (encapsulated) */
literal|"iNBiosNS"
block|,
comment|/* 44: NetBIOS Name Server (RFC-1001,1..2) */
literal|"iNBiosDD"
block|,
comment|/* 45: NetBIOS Datagram Dist. Server. */
literal|"bNBiosNT"
block|,
comment|/* 46: NetBIOS Note Type */
literal|"?NBiosS"
block|,
comment|/* 47: NetBIOS Scope */
literal|"iXW-FS"
block|,
comment|/* 48: X Window System Font Servers */
literal|"iXW-DM"
block|,
comment|/* 49: X Window System Display Managers */
comment|/* DHCP extensions (RFC-1533, sect. 9) */
endif|#
directive|endif
block|}
decl_stmt|;
end_decl_stmt

begin_define
define|#
directive|define
name|KNOWN_OPTIONS
value|(sizeof(rfc1048_opts) / sizeof(rfc1048_opts[0]))
end_define

begin_function
specifier|static
name|void
name|rfc1048_print
parameter_list|(
name|bp
parameter_list|,
name|length
parameter_list|)
specifier|register
name|u_char
modifier|*
name|bp
decl_stmt|;
name|int
name|length
decl_stmt|;
block|{
name|u_char
name|tag
decl_stmt|;
name|u_char
modifier|*
name|ep
decl_stmt|;
specifier|register
name|int
name|len
decl_stmt|;
name|u_int32
name|ul
decl_stmt|;
name|u_short
name|us
decl_stmt|;
name|struct
name|in_addr
name|ia
decl_stmt|;
name|char
modifier|*
name|optstr
decl_stmt|;
name|printf
argument_list|(
literal|"-rfc1395"
argument_list|)
expr_stmt|;
comment|/* Step over magic cookie */
name|bp
operator|+=
sizeof|sizeof
argument_list|(
name|int32
argument_list|)
expr_stmt|;
comment|/* Setup end pointer */
name|ep
operator|=
name|bp
operator|+
name|length
expr_stmt|;
while|while
condition|(
name|bp
operator|<
name|ep
condition|)
block|{
name|tag
operator|=
operator|*
name|bp
operator|++
expr_stmt|;
comment|/* Check for tags with no data first. */
if|if
condition|(
name|tag
operator|==
name|TAG_PAD
condition|)
continue|continue;
if|if
condition|(
name|tag
operator|==
name|TAG_END
condition|)
return|return;
if|if
condition|(
name|tag
operator|<
name|KNOWN_OPTIONS
condition|)
block|{
name|optstr
operator|=
name|rfc1048_opts
index|[
name|tag
index|]
expr_stmt|;
name|printf
argument_list|(
literal|" %s:"
argument_list|,
name|optstr
operator|+
literal|1
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|printf
argument_list|(
literal|" T%d:"
argument_list|,
name|tag
argument_list|)
expr_stmt|;
name|optstr
operator|=
literal|"?"
expr_stmt|;
block|}
comment|/* Now scan the length byte. */
name|len
operator|=
operator|*
name|bp
operator|++
expr_stmt|;
if|if
condition|(
name|bp
operator|+
name|len
operator|>
name|ep
condition|)
block|{
comment|/* truncated option */
name|printf
argument_list|(
literal|" |(%d>%td)"
argument_list|,
name|len
argument_list|,
name|ep
operator|-
name|bp
argument_list|)
expr_stmt|;
return|return;
block|}
comment|/* Print the option value(s). */
switch|switch
condition|(
name|optstr
index|[
literal|0
index|]
condition|)
block|{
case|case
literal|'a'
case|:
comment|/* ASCII string */
name|printfn
argument_list|(
name|bp
argument_list|,
name|bp
operator|+
name|len
argument_list|)
expr_stmt|;
name|bp
operator|+=
name|len
expr_stmt|;
name|len
operator|=
literal|0
expr_stmt|;
break|break;
case|case
literal|'s'
case|:
comment|/* Word formats */
while|while
condition|(
name|len
operator|>=
literal|2
condition|)
block|{
name|bcopy
argument_list|(
operator|(
name|char
operator|*
operator|)
name|bp
argument_list|,
operator|(
name|char
operator|*
operator|)
operator|&
name|us
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"%d"
argument_list|,
name|ntohs
argument_list|(
name|us
argument_list|)
argument_list|)
expr_stmt|;
name|bp
operator|+=
literal|2
expr_stmt|;
name|len
operator|-=
literal|2
expr_stmt|;
if|if
condition|(
name|len
condition|)
name|printf
argument_list|(
literal|","
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|len
condition|)
name|printf
argument_list|(
literal|"(junk=%d)"
argument_list|,
name|len
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'l'
case|:
comment|/* Long words */
while|while
condition|(
name|len
operator|>=
literal|4
condition|)
block|{
name|bcopy
argument_list|(
operator|(
name|char
operator|*
operator|)
name|bp
argument_list|,
operator|(
name|char
operator|*
operator|)
operator|&
name|ul
argument_list|,
literal|4
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"%ld"
argument_list|,
operator|(
name|long
operator|)
name|ntohl
argument_list|(
name|ul
argument_list|)
argument_list|)
expr_stmt|;
name|bp
operator|+=
literal|4
expr_stmt|;
name|len
operator|-=
literal|4
expr_stmt|;
if|if
condition|(
name|len
condition|)
name|printf
argument_list|(
literal|","
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|len
condition|)
name|printf
argument_list|(
literal|"(junk=%d)"
argument_list|,
name|len
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'i'
case|:
comment|/* INET addresses */
while|while
condition|(
name|len
operator|>=
literal|4
condition|)
block|{
name|bcopy
argument_list|(
operator|(
name|char
operator|*
operator|)
name|bp
argument_list|,
operator|(
name|char
operator|*
operator|)
operator|&
name|ia
argument_list|,
literal|4
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"%s"
argument_list|,
name|ipaddr_string
argument_list|(
operator|&
name|ia
argument_list|)
argument_list|)
expr_stmt|;
name|bp
operator|+=
literal|4
expr_stmt|;
name|len
operator|-=
literal|4
expr_stmt|;
if|if
condition|(
name|len
condition|)
name|printf
argument_list|(
literal|","
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|len
condition|)
name|printf
argument_list|(
literal|"(junk=%d)"
argument_list|,
name|len
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'b'
case|:
default|default:
break|break;
block|}
comment|/* switch */
comment|/* Print as characters, if appropriate. */
if|if
condition|(
name|len
condition|)
block|{
name|dump_hex
argument_list|(
name|bp
argument_list|,
name|len
argument_list|)
expr_stmt|;
if|if
condition|(
name|isascii
argument_list|(
operator|*
name|bp
argument_list|)
operator|&&
name|isprint
argument_list|(
operator|*
name|bp
argument_list|)
condition|)
block|{
name|printf
argument_list|(
literal|"("
argument_list|)
expr_stmt|;
name|printfn
argument_list|(
name|bp
argument_list|,
name|bp
operator|+
name|len
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|")"
argument_list|)
expr_stmt|;
block|}
name|bp
operator|+=
name|len
expr_stmt|;
name|len
operator|=
literal|0
expr_stmt|;
block|}
block|}
comment|/* while bp< ep */
block|}
end_function

begin_function
specifier|static
name|void
name|cmu_print
parameter_list|(
name|bp
parameter_list|,
name|length
parameter_list|)
specifier|register
name|u_char
modifier|*
name|bp
decl_stmt|;
name|int
name|length
decl_stmt|;
block|{
name|struct
name|cmu_vend
modifier|*
name|v
decl_stmt|;
name|u_char
modifier|*
name|ep
decl_stmt|;
name|printf
argument_list|(
literal|"-cmu"
argument_list|)
expr_stmt|;
name|v
operator|=
operator|(
expr|struct
name|cmu_vend
operator|*
operator|)
name|bp
expr_stmt|;
if|if
condition|(
name|length
operator|<
sizeof|sizeof
argument_list|(
operator|*
name|v
argument_list|)
condition|)
block|{
name|printf
argument_list|(
literal|" |L=%d"
argument_list|,
name|length
argument_list|)
expr_stmt|;
return|return;
block|}
comment|/* Setup end pointer */
name|ep
operator|=
name|bp
operator|+
name|length
expr_stmt|;
comment|/* Subnet mask */
if|if
condition|(
name|v
operator|->
name|v_flags
operator|&
name|VF_SMASK
condition|)
block|{
name|printf
argument_list|(
literal|" SM:%s"
argument_list|,
name|ipaddr_string
argument_list|(
operator|&
name|v
operator|->
name|v_smask
argument_list|)
argument_list|)
expr_stmt|;
block|}
comment|/* Default gateway */
if|if
condition|(
name|v
operator|->
name|v_dgate
operator|.
name|s_addr
condition|)
name|printf
argument_list|(
literal|" GW:%s"
argument_list|,
name|ipaddr_string
argument_list|(
operator|&
name|v
operator|->
name|v_dgate
argument_list|)
argument_list|)
expr_stmt|;
comment|/* Domain name servers */
if|if
condition|(
name|v
operator|->
name|v_dns1
operator|.
name|s_addr
condition|)
name|printf
argument_list|(
literal|" DNS1:%s"
argument_list|,
name|ipaddr_string
argument_list|(
operator|&
name|v
operator|->
name|v_dns1
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|v
operator|->
name|v_dns2
operator|.
name|s_addr
condition|)
name|printf
argument_list|(
literal|" DNS2:%s"
argument_list|,
name|ipaddr_string
argument_list|(
operator|&
name|v
operator|->
name|v_dns2
argument_list|)
argument_list|)
expr_stmt|;
comment|/* IEN-116 name servers */
if|if
condition|(
name|v
operator|->
name|v_ins1
operator|.
name|s_addr
condition|)
name|printf
argument_list|(
literal|" INS1:%s"
argument_list|,
name|ipaddr_string
argument_list|(
operator|&
name|v
operator|->
name|v_ins1
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|v
operator|->
name|v_ins2
operator|.
name|s_addr
condition|)
name|printf
argument_list|(
literal|" INS2:%s"
argument_list|,
name|ipaddr_string
argument_list|(
operator|&
name|v
operator|->
name|v_ins2
argument_list|)
argument_list|)
expr_stmt|;
comment|/* Time servers */
if|if
condition|(
name|v
operator|->
name|v_ts1
operator|.
name|s_addr
condition|)
name|printf
argument_list|(
literal|" TS1:%s"
argument_list|,
name|ipaddr_string
argument_list|(
operator|&
name|v
operator|->
name|v_ts1
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|v
operator|->
name|v_ts2
operator|.
name|s_addr
condition|)
name|printf
argument_list|(
literal|" TS2:%s"
argument_list|,
name|ipaddr_string
argument_list|(
operator|&
name|v
operator|->
name|v_ts2
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * Print out arbitrary, unknown vendor data.  */
end_comment

begin_function
specifier|static
name|void
name|other_print
parameter_list|(
name|bp
parameter_list|,
name|length
parameter_list|)
specifier|register
name|u_char
modifier|*
name|bp
decl_stmt|;
name|int
name|length
decl_stmt|;
block|{
name|u_char
modifier|*
name|ep
decl_stmt|;
comment|/* end pointer */
name|u_char
modifier|*
name|zp
decl_stmt|;
comment|/* points one past last non-zero byte */
comment|/* Setup end pointer */
name|ep
operator|=
name|bp
operator|+
name|length
expr_stmt|;
comment|/* Find the last non-zero byte. */
for|for
control|(
name|zp
operator|=
name|ep
init|;
name|zp
operator|>
name|bp
condition|;
name|zp
operator|--
control|)
block|{
if|if
condition|(
name|zp
index|[
operator|-
literal|1
index|]
operator|!=
literal|0
condition|)
break|break;
block|}
comment|/* Print the all-zero case in a compact representation. */
if|if
condition|(
name|zp
operator|==
name|bp
condition|)
block|{
name|printf
argument_list|(
literal|"-all-zero"
argument_list|)
expr_stmt|;
return|return;
block|}
name|printf
argument_list|(
literal|"-unknown"
argument_list|)
expr_stmt|;
comment|/* Are there enough trailing zeros to make "00..." worthwhile? */
if|if
condition|(
name|zp
operator|+
literal|2
operator|>
name|ep
condition|)
name|zp
operator|=
name|ep
expr_stmt|;
comment|/* print them all normally */
comment|/* Now just print all the non-zero data. */
while|while
condition|(
name|bp
operator|<
name|zp
condition|)
block|{
name|printf
argument_list|(
literal|".%02X"
argument_list|,
operator|*
name|bp
argument_list|)
expr_stmt|;
name|bp
operator|++
expr_stmt|;
block|}
if|if
condition|(
name|zp
operator|<
name|ep
condition|)
name|printf
argument_list|(
literal|".00..."
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_function
specifier|static
name|void
name|dump_hex
parameter_list|(
name|bp
parameter_list|,
name|len
parameter_list|)
name|u_char
modifier|*
name|bp
decl_stmt|;
name|int
name|len
decl_stmt|;
block|{
while|while
condition|(
name|len
operator|>
literal|0
condition|)
block|{
name|printf
argument_list|(
literal|"%02X"
argument_list|,
operator|*
name|bp
argument_list|)
expr_stmt|;
name|bp
operator|++
expr_stmt|;
name|len
operator|--
expr_stmt|;
if|if
condition|(
name|len
condition|)
name|printf
argument_list|(
literal|"."
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/*  * Local Variables:  * tab-width: 4  * c-indent-level: 4  * c-argdecl-indent: 4  * c-continued-statement-offset: 4  * c-continued-brace-offset: -4  * c-label-offset: -4  * c-brace-offset: 0  * End:  */
end_comment

end_unit


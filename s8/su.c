begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/* su -- set user id */
end_comment

begin_decl_stmt
name|int
name|chngflg
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|char
name|password
index|[
literal|100
index|]
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|char
name|pwbuf
index|[
literal|100
index|]
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|ttybuf
index|[
literal|3
index|]
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|uid
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|char
name|Home
index|[
literal|40
index|]
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|Uid
decl_stmt|,
name|attyn
decl_stmt|;
end_decl_stmt

begin_extern
extern|extern	htmp;
end_extern

begin_function
name|main
parameter_list|(
name|argc
parameter_list|,
name|argv
parameter_list|)
name|char
modifier|*
modifier|*
name|argv
decl_stmt|;
block|{
specifier|register
name|char
modifier|*
name|p
decl_stmt|,
modifier|*
name|q
decl_stmt|;
name|int
name|i
decl_stmt|;
name|char
modifier|*
name|nptr
decl_stmt|;
name|int
name|badsw
decl_stmt|;
extern|extern fin;
name|badsw
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|argc
operator|>
literal|1
condition|)
block|{
if|if
condition|(
name|getuid
argument_list|()
operator|!=
literal|0
condition|)
block|{
name|printf
argument_list|(
literal|"sorry: not super-user\n"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
name|nptr
operator|=
operator|*
operator|++
name|argv
expr_stmt|;
block|}
else|else
name|nptr
operator|=
literal|"root"
expr_stmt|;
if|if
condition|(
operator|(
name|uid
operator|=
name|getpwid
argument_list|(
name|nptr
argument_list|,
name|pwbuf
argument_list|,
literal|"/etc/passwdf"
argument_list|)
operator|)
operator|==
operator|-
literal|1
condition|)
name|badsw
operator|++
expr_stmt|;
operator|(
operator|&
name|fin
operator|)
index|[
literal|1
index|]
operator|=
literal|0
expr_stmt|;
name|p
operator|=
name|pwbuf
expr_stmt|;
while|while
condition|(
operator|*
name|p
operator|!=
literal|':'
condition|)
if|if
condition|(
operator|*
name|p
operator|++
operator|==
literal|'\0'
condition|)
goto|goto
name|badpw
goto|;
if|if
condition|(
operator|*
operator|++
name|p
operator|==
literal|':'
condition|)
goto|goto
name|ok
goto|;
if|if
condition|(
name|getuid
argument_list|()
operator|==
literal|0
condition|)
block|{
while|while
condition|(
operator|*
name|p
operator|!=
literal|':'
condition|)
if|if
condition|(
operator|*
name|p
operator|++
operator|==
literal|'\0'
condition|)
goto|goto
name|badpw
goto|;
goto|goto
name|ok
goto|;
block|}
name|gtty
argument_list|(
literal|0
argument_list|,
name|ttybuf
argument_list|)
expr_stmt|;
name|ttybuf
index|[
literal|2
index|]
operator|=
operator|&
operator|~
literal|010
expr_stmt|;
name|stty
argument_list|(
literal|0
argument_list|,
name|ttybuf
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Password: "
argument_list|)
expr_stmt|;
name|q
operator|=
name|password
expr_stmt|;
while|while
condition|(
operator|(
operator|*
name|q
operator|=
name|getchar
argument_list|()
operator|)
operator|!=
literal|'\n'
condition|)
block|{
if|if
condition|(
name|q
operator|>=
operator|&
name|password
index|[
literal|80
index|]
condition|)
block|{
name|badsw
operator|++
expr_stmt|;
break|break;
block|}
if|if
condition|(
operator|*
name|q
operator|++
operator|==
literal|'\0'
condition|)
return|return;
block|}
operator|*
name|q
operator|=
literal|'\0'
expr_stmt|;
name|ttybuf
index|[
literal|2
index|]
operator|=
operator||
literal|010
expr_stmt|;
name|stty
argument_list|(
literal|0
argument_list|,
name|ttybuf
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
if|if
condition|(
name|badsw
condition|)
goto|goto
name|error
goto|;
name|q
operator|=
name|crypt
argument_list|(
name|password
argument_list|)
expr_stmt|;
while|while
condition|(
operator|*
name|q
operator|++
operator|==
operator|*
name|p
operator|++
condition|)
empty_stmt|;
if|if
condition|(
operator|*
operator|--
name|q
operator|==
literal|'\0'
operator|&&
operator|*
operator|--
name|p
operator|==
literal|':'
condition|)
goto|goto
name|ok
goto|;
goto|goto
name|error
goto|;
name|badpw
label|:
name|printf
argument_list|(
literal|"bad password file\n"
argument_list|)
expr_stmt|;
return|return;
name|ok
label|:
if|if
condition|(
name|getpwid
argument_list|(
name|nptr
argument_list|,
name|pwbuf
argument_list|,
literal|"/etc/passwd"
argument_list|)
operator|==
operator|-
literal|1
condition|)
goto|goto
name|badpw
goto|;
name|p
operator|=
name|pwbuf
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|5
condition|;
name|i
operator|++
control|)
block|{
name|p
operator|++
expr_stmt|;
while|while
condition|(
operator|*
name|p
operator|!=
literal|':'
condition|)
if|if
condition|(
operator|*
name|p
operator|++
operator|==
literal|'\0'
condition|)
goto|goto
name|badpw
goto|;
block|}
name|q
operator|=
operator|++
name|p
expr_stmt|;
while|while
condition|(
operator|*
name|p
operator|!=
literal|':'
condition|)
if|if
condition|(
operator|*
name|p
operator|++
operator|==
literal|'\0'
condition|)
goto|goto
name|badpw
goto|;
operator|*
name|p
operator|++
operator|=
literal|'\0'
expr_stmt|;
name|attyn
operator|=
name|ttyn
argument_list|(
literal|2
argument_list|)
expr_stmt|;
name|hget
argument_list|(
name|attyn
argument_list|)
expr_stmt|;
name|strcpy
argument_list|(
name|Home
argument_list|,
name|hgethome
argument_list|()
argument_list|)
expr_stmt|;
name|Uid
operator|=
name|hgetuid
argument_list|()
expr_stmt|;
name|hsethome
argument_list|(
name|q
argument_list|)
expr_stmt|;
name|hsetuid
argument_list|(
name|uid
argument_list|)
expr_stmt|;
name|hput
argument_list|(
name|attyn
argument_list|)
expr_stmt|;
if|if
condition|(
name|uid
operator|!=
literal|0
operator|&&
name|chdir
argument_list|(
name|q
argument_list|)
operator|<
literal|0
condition|)
block|{
name|printf
argument_list|(
literal|"no directory!\n"
argument_list|)
expr_stmt|;
name|terminate
argument_list|()
expr_stmt|;
block|}
if|if
condition|(
operator|*
name|p
operator|!=
literal|'\0'
condition|)
block|{
name|update
argument_list|(
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|fork
argument_list|()
operator|==
literal|0
condition|)
block|{
name|setuid
argument_list|(
name|uid
argument_list|)
expr_stmt|;
name|execl
argument_list|(
name|p
argument_list|,
literal|"-setuser"
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"no shell!\n"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
name|terminate
argument_list|()
expr_stmt|;
block|}
name|trace
argument_list|(
literal|"ok "
argument_list|)
expr_stmt|;
name|update
argument_list|(
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|fork
argument_list|()
operator|==
literal|0
condition|)
block|{
name|setuid
argument_list|(
name|uid
argument_list|)
expr_stmt|;
name|execl
argument_list|(
literal|"/bin/sh"
argument_list|,
literal|"-setuser"
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"cannot execute shell\n"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
name|terminate
argument_list|()
expr_stmt|;
name|error
label|:
name|printf
argument_list|(
literal|"sorry\n"
argument_list|)
expr_stmt|;
name|trace
argument_list|(
literal|"bad"
argument_list|)
expr_stmt|;
block|}
end_function

begin_macro
name|trace
argument_list|(
argument|ptr
argument_list|)
end_macro

begin_decl_stmt
name|char
modifier|*
name|ptr
decl_stmt|;
end_decl_stmt

begin_block
block|{
specifier|register
name|char
modifier|*
name|p
decl_stmt|,
modifier|*
name|q
decl_stmt|;
specifier|register
name|int
name|num
decl_stmt|;
name|char
name|passbuf
index|[
literal|200
index|]
decl_stmt|;
name|int
name|fp
decl_stmt|;
if|if
condition|(
name|uid
operator|!=
literal|0
condition|)
return|return;
if|if
condition|(
operator|(
name|fp
operator|=
name|open
argument_list|(
literal|"/usr/adm/su"
argument_list|,
literal|2
argument_list|)
operator|)
operator|<
literal|0
condition|)
return|return;
name|seek
argument_list|(
name|fp
argument_list|,
literal|0
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|q
operator|=
name|passbuf
expr_stmt|;
name|p
operator|=
name|ptr
expr_stmt|;
while|while
condition|(
operator|*
name|p
operator|!=
literal|'\0'
condition|)
operator|*
name|q
operator|++
operator|=
operator|*
name|p
operator|++
expr_stmt|;
for|for
control|(
name|num
operator|=
literal|0
init|;
name|num
operator|<
literal|4
condition|;
name|num
operator|++
control|)
operator|*
name|q
operator|++
operator|=
literal|' '
expr_stmt|;
name|time
argument_list|(
name|ttybuf
argument_list|)
expr_stmt|;
name|p
operator|=
name|ctime
argument_list|(
name|ttybuf
argument_list|)
expr_stmt|;
while|while
condition|(
operator|*
name|p
operator|!=
literal|'\n'
condition|)
operator|*
name|q
operator|++
operator|=
operator|*
name|p
operator|++
expr_stmt|;
for|for
control|(
name|num
operator|=
literal|0
init|;
name|num
operator|<
literal|4
condition|;
name|num
operator|++
control|)
operator|*
name|q
operator|++
operator|=
literal|' '
expr_stmt|;
name|num
operator|=
name|getuid
argument_list|()
expr_stmt|;
if|if
condition|(
name|getpw
argument_list|(
name|num
argument_list|,
name|pwbuf
argument_list|)
operator|==
literal|0
condition|)
block|{
name|p
operator|=
name|pwbuf
expr_stmt|;
while|while
condition|(
operator|*
name|p
operator|&&
operator|*
name|p
operator|!=
literal|':'
condition|)
operator|*
name|q
operator|++
operator|=
operator|*
name|p
operator|++
expr_stmt|;
block|}
if|if
condition|(
name|ptr
index|[
literal|0
index|]
operator|==
literal|'b'
condition|)
block|{
name|p
operator|=
literal|"\tpw = "
expr_stmt|;
while|while
condition|(
operator|*
name|q
operator|++
operator|=
operator|*
name|p
operator|++
condition|)
empty_stmt|;
operator|--
name|q
expr_stmt|;
name|p
operator|=
name|password
expr_stmt|;
while|while
condition|(
operator|*
name|q
operator|++
operator|=
operator|*
name|p
operator|++
condition|)
empty_stmt|;
operator|--
name|q
expr_stmt|;
operator|*
name|q
operator|++
operator|=
literal|'\t'
expr_stmt|;
name|p
operator|=
literal|"tty = "
expr_stmt|;
while|while
condition|(
operator|*
name|q
operator|++
operator|=
operator|*
name|p
operator|++
condition|)
empty_stmt|;
operator|--
name|q
expr_stmt|;
operator|*
name|q
operator|++
operator|=
name|ttyn
argument_list|(
literal|0
argument_list|)
expr_stmt|;
block|}
operator|*
name|q
operator|++
operator|=
literal|'\n'
expr_stmt|;
name|write
argument_list|(
name|fp
argument_list|,
name|passbuf
argument_list|,
name|q
operator|-
name|passbuf
argument_list|)
expr_stmt|;
name|close
argument_list|(
name|fp
argument_list|)
expr_stmt|;
block|}
end_block

begin_comment
comment|/* 	getpwid -- return user id from user name */
end_comment

begin_macro
name|getpwid
argument_list|(
argument|name
argument_list|,
argument|buf
argument_list|,
argument|fname
argument_list|)
end_macro

begin_decl_stmt
name|char
modifier|*
name|name
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|char
name|buf
index|[]
decl_stmt|;
end_decl_stmt

begin_block
block|{
specifier|static
name|pbuf
index|[
literal|259
index|]
expr_stmt|;
specifier|register
name|char
name|c
decl_stmt|;
specifier|register
name|char
modifier|*
name|bp
decl_stmt|,
modifier|*
name|aptr
decl_stmt|;
name|int
name|n
decl_stmt|,
name|m
decl_stmt|;
if|if
condition|(
name|fopen
argument_list|(
name|fname
argument_list|,
name|pbuf
argument_list|)
operator|<
literal|0
condition|)
return|return
operator|(
operator|-
literal|1
operator|)
return|;
name|m
operator|=
literal|0
expr_stmt|;
name|n
operator|=
operator|-
literal|1
expr_stmt|;
for|for
control|(
init|;
condition|;
control|)
block|{
name|bp
operator|=
name|buf
expr_stmt|;
while|while
condition|(
operator|(
name|c
operator|=
name|getc
argument_list|(
name|pbuf
argument_list|)
operator|)
operator|!=
literal|'\n'
condition|)
block|{
if|if
condition|(
name|c
operator|<=
literal|'\0'
condition|)
goto|goto
name|out
goto|;
operator|*
name|bp
operator|++
operator|=
name|c
expr_stmt|;
block|}
operator|*
name|bp
operator|++
operator|=
literal|'\0'
expr_stmt|;
name|bp
operator|=
name|buf
expr_stmt|;
name|aptr
operator|=
name|name
expr_stmt|;
while|while
condition|(
operator|(
name|c
operator|=
operator|*
name|bp
operator|++
operator|)
operator|!=
literal|':'
condition|)
if|if
condition|(
name|c
operator|!=
operator|*
name|aptr
operator|++
condition|)
goto|goto
name|next
goto|;
if|if
condition|(
operator|*
name|aptr
operator|!=
literal|'\0'
operator|&&
operator|*
name|aptr
operator|!=
literal|' '
condition|)
goto|goto
name|next
goto|;
while|while
condition|(
operator|(
name|c
operator|=
operator|*
name|bp
operator|++
operator|)
operator|!=
literal|':'
condition|)
if|if
condition|(
name|c
operator|==
literal|'\0'
condition|)
goto|goto
name|out
goto|;
name|n
operator|=
literal|0
expr_stmt|;
while|while
condition|(
operator|(
name|c
operator|=
operator|*
name|bp
operator|++
operator|)
operator|!=
literal|':'
condition|)
name|n
operator|=
name|n
operator|*
literal|10
operator|+
name|c
operator|-
literal|'0'
expr_stmt|;
while|while
condition|(
operator|(
name|c
operator|=
operator|*
name|bp
operator|++
operator|)
operator|!=
literal|':'
condition|)
name|m
operator|=
name|m
operator|*
literal|10
operator|+
name|c
operator|-
literal|'0'
expr_stmt|;
name|out
label|:
name|close
argument_list|(
name|pbuf
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
name|pbuf
index|[
literal|0
index|]
operator|=
literal|0
expr_stmt|;
name|pbuf
index|[
literal|1
index|]
operator|=
literal|0
expr_stmt|;
name|pbuf
index|[
literal|2
index|]
operator|=
literal|0
expr_stmt|;
return|return
operator|(
name|m
operator|<<
literal|8
operator||
name|n
operator|)
return|;
name|next
label|:
continue|continue;
block|}
block|}
end_block

begin_macro
name|update
argument_list|(
argument|flag
argument_list|)
end_macro

begin_block
block|{
specifier|register
name|i
operator|,
name|tty
expr_stmt|;
name|i
operator|=
name|open
argument_list|(
literal|"/etc/utmp"
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|tty
operator|=
name|ttyn
argument_list|(
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|tty
operator|==
literal|'x'
condition|)
block|{
name|printf
argument_list|(
literal|"standard input not a tty!\n"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
name|seek
argument_list|(
name|i
argument_list|,
operator|(
name|tty
operator|&
literal|0177
operator|)
operator|*
literal|16
operator|+
literal|9
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|read
argument_list|(
name|i
argument_list|,
operator|&
name|chngflg
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|seek
argument_list|(
name|i
argument_list|,
operator|-
literal|1
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|write
argument_list|(
name|i
argument_list|,
operator|&
name|flag
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|seek
argument_list|(
name|i
argument_list|,
literal|4
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|write
argument_list|(
name|i
argument_list|,
operator|&
name|uid
argument_list|,
literal|2
argument_list|)
expr_stmt|;
block|}
end_block

begin_macro
name|terminate
argument_list|()
end_macro

begin_block
block|{
name|int
name|i
decl_stmt|;
name|signal
argument_list|(
literal|1
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|signal
argument_list|(
literal|2
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|signal
argument_list|(
literal|3
argument_list|,
literal|1
argument_list|)
expr_stmt|;
while|while
condition|(
name|wait
argument_list|(
operator|&
name|i
argument_list|)
operator|!=
operator|-
literal|1
condition|)
empty_stmt|;
name|uid
operator|=
name|getuid
argument_list|()
expr_stmt|;
name|update
argument_list|(
name|chngflg
argument_list|)
expr_stmt|;
name|strcpy
argument_list|(
name|hgethome
argument_list|()
argument_list|,
name|Home
argument_list|)
expr_stmt|;
name|hsetuid
argument_list|(
name|Uid
argument_list|)
expr_stmt|;
name|hput
argument_list|(
name|attyn
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|0
argument_list|)
expr_stmt|;
block|}
end_block

begin_macro
name|strcpy
argument_list|(
argument|to
argument_list|,
argument|from
argument_list|)
end_macro

begin_decl_stmt
name|char
modifier|*
name|to
decl_stmt|,
modifier|*
name|from
decl_stmt|;
end_decl_stmt

begin_block
block|{
while|while
condition|(
operator|*
name|to
operator|++
operator|=
operator|*
name|from
operator|++
condition|)
continue|continue;
block|}
end_block

end_unit


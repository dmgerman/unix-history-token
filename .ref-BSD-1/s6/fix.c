begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_empty
empty|#
end_empty

begin_comment
comment|/*  * fix - fix up data  *  * Author: Kurt Shoens UCB July, 1977  *  * Fix reads the concatenation of the files presented to  * it and transcribes them to the standard output with unprintable  * characters removed.  A report of the bad characters found is put  * on the diagnostic output stream if desired.  The options of this  * program are as follows:  *  * fix [ -crnhfqblo ] file ...  *	c	carriage returns (015) are illegal  *	r	a report is put on diagnostic output  *	n	no output is put on standard output (report only)  *	h	erase processing is done on control-h's  *	f	form feeds (014) are illegal  *	q	given multiple files, this suppresses printing of file name  *		on report lines  *	l	line numbers are printed on report lines.  *	o	bad characters are printed in octal instead of as ?'s  *  * The n, l, and o flags turn on the r flag.  */
end_comment

begin_define
define|#
directive|define
name|CLEAN
value|1
end_define

begin_define
define|#
directive|define
name|REPORT
value|2
end_define

begin_define
define|#
directive|define
name|CTLH
value|4
end_define

begin_define
define|#
directive|define
name|CRILL
value|8
end_define

begin_define
define|#
directive|define
name|FFILL
value|16
end_define

begin_define
define|#
directive|define
name|VERBOSE
value|32
end_define

begin_define
define|#
directive|define
name|BELLILL
value|64
end_define

begin_define
define|#
directive|define
name|LNO
value|128
end_define

begin_define
define|#
directive|define
name|OCTAL
value|256
end_define

begin_decl_stmt
name|char
name|buf
index|[
literal|512
index|]
decl_stmt|,
name|wbuf
index|[
literal|512
index|]
decl_stmt|,
modifier|*
name|nxtchar
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|wcount
decl_stmt|,
name|avail
decl_stmt|,
name|eof
decl_stmt|,
name|errs
decl_stmt|,
name|linenum
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|FLAGS
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|extern
name|int
name|fout
decl_stmt|;
end_decl_stmt

begin_function
name|main
parameter_list|(
name|argc
parameter_list|,
name|argv
parameter_list|)
name|char
modifier|*
modifier|*
name|argv
decl_stmt|;
block|{
specifier|register
name|fd
expr_stmt|;
specifier|register
name|char
modifier|*
name|cp
decl_stmt|;
name|FLAGS
operator|=
name|CLEAN
operator||
name|VERBOSE
expr_stmt|;
if|if
condition|(
operator|*
name|argv
index|[
literal|1
index|]
operator|==
literal|'-'
condition|)
block|{
name|cp
operator|=
operator|*
operator|++
name|argv
expr_stmt|;
operator|++
name|cp
expr_stmt|;
operator|--
name|argc
expr_stmt|;
while|while
condition|(
operator|*
name|cp
condition|)
block|{
switch|switch
condition|(
operator|*
name|cp
condition|)
block|{
case|case
literal|'c'
case|:
name|FLAGS
operator|=
operator||
name|CRILL
expr_stmt|;
break|break;
case|case
literal|'r'
case|:
name|FLAGS
operator|=
operator||
name|REPORT
expr_stmt|;
break|break;
case|case
literal|'n'
case|:
name|FLAGS
operator|=
operator|&
operator|~
name|CLEAN
expr_stmt|;
name|FLAGS
operator|=
operator||
name|REPORT
expr_stmt|;
break|break;
case|case
literal|'h'
case|:
name|FLAGS
operator|=
operator||
name|CTLH
expr_stmt|;
break|break;
case|case
literal|'f'
case|:
name|FLAGS
operator|=
operator||
name|FFILL
expr_stmt|;
break|break;
case|case
literal|'q'
case|:
name|FLAGS
operator|=
operator|&
operator|~
name|VERBOSE
expr_stmt|;
break|break;
case|case
literal|'b'
case|:
name|FLAGS
operator|=
operator||
name|BELLILL
expr_stmt|;
break|break;
case|case
literal|'l'
case|:
name|FLAGS
operator|=
operator||
name|LNO
operator||
name|REPORT
expr_stmt|;
break|break;
case|case
literal|'o'
case|:
name|FLAGS
operator|=
operator||
name|OCTAL
operator||
name|REPORT
expr_stmt|;
break|break;
default|default:
name|prs
argument_list|(
literal|"Usage: fix [ -crnhfqblo ] [ file ... ]\n"
argument_list|)
expr_stmt|;
name|errs
operator|++
expr_stmt|;
name|exit
argument_list|(
name|errs
argument_list|)
expr_stmt|;
block|}
operator|++
name|cp
expr_stmt|;
block|}
block|}
if|if
condition|(
name|errs
condition|)
name|exit
argument_list|(
name|errs
argument_list|)
expr_stmt|;
if|if
condition|(
name|argc
operator|==
literal|1
condition|)
block|{
name|FLAGS
operator|=
operator|&
operator|~
name|VERBOSE
expr_stmt|;
name|linenum
operator|=
literal|0
expr_stmt|;
name|eof
operator|=
literal|0
expr_stmt|;
name|fix
argument_list|(
literal|0
argument_list|,
literal|"standard input"
argument_list|)
expr_stmt|;
name|flushout
argument_list|()
expr_stmt|;
name|exit
argument_list|(
name|errs
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|argc
operator|==
literal|2
condition|)
name|FLAGS
operator|=
operator|&
operator|~
name|VERBOSE
expr_stmt|;
while|while
condition|(
operator|--
name|argc
condition|)
block|{
name|fd
operator|=
name|open
argument_list|(
operator|*
operator|++
name|argv
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|fd
operator|<
literal|0
condition|)
block|{
name|perror
argument_list|(
operator|*
name|argv
argument_list|)
expr_stmt|;
name|errs
operator|++
expr_stmt|;
continue|continue;
block|}
name|nxtchar
operator|=
name|buf
operator|+
literal|512
expr_stmt|;
name|eof
operator|=
literal|0
expr_stmt|;
name|avail
operator|=
literal|0
expr_stmt|;
name|linenum
operator|=
literal|0
expr_stmt|;
name|fix
argument_list|(
name|fd
argument_list|,
operator|*
name|argv
argument_list|)
expr_stmt|;
name|close
argument_list|(
name|fd
argument_list|)
expr_stmt|;
block|}
name|flushout
argument_list|()
expr_stmt|;
block|}
end_function

begin_macro
name|fix
argument_list|(
argument|f
argument_list|,
argument|file
argument_list|)
end_macro

begin_decl_stmt
name|char
modifier|*
name|file
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|char
name|line
index|[
literal|512
index|]
decl_stmt|,
modifier|*
name|cp
decl_stmt|,
name|ch
decl_stmt|;
name|int
name|count
decl_stmt|;
while|while
condition|(
operator|!
name|eof
condition|)
block|{
name|ch
operator|=
name|bread
argument_list|(
name|f
argument_list|)
expr_stmt|;
name|count
operator|=
literal|0
expr_stmt|;
name|cp
operator|=
name|line
expr_stmt|;
while|while
condition|(
name|ch
operator|!=
literal|012
operator|&&
name|ch
operator|!=
literal|015
operator|&&
operator|!
name|eof
operator|&&
name|count
operator|<
literal|512
condition|)
block|{
operator|*
name|cp
operator|++
operator|=
name|ch
expr_stmt|;
name|count
operator|++
expr_stmt|;
name|ch
operator|=
name|bread
argument_list|(
name|f
argument_list|)
expr_stmt|;
block|}
operator|++
name|linenum
expr_stmt|;
if|if
condition|(
name|count
operator|>=
literal|512
condition|)
block|{
name|prs
argument_list|(
literal|"Line too long.\n"
argument_list|)
expr_stmt|;
while|while
condition|(
name|ch
operator|!=
literal|012
operator|&&
name|ch
operator|!=
literal|015
operator|&&
operator|!
name|eof
condition|)
name|ch
operator|=
name|bread
argument_list|(
name|f
argument_list|)
expr_stmt|;
operator|++
name|errs
expr_stmt|;
block|}
operator|*
name|cp
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|FLAGS
operator|&
name|REPORT
condition|)
name|printbad
argument_list|(
name|line
argument_list|,
name|file
argument_list|)
expr_stmt|;
if|if
condition|(
name|FLAGS
operator|&
name|CTLH
condition|)
name|fixctlh
argument_list|(
name|line
argument_list|)
expr_stmt|;
if|if
condition|(
name|FLAGS
operator|&
name|CLEAN
condition|)
block|{
name|cp
operator|=
name|line
expr_stmt|;
while|while
condition|(
operator|*
name|cp
condition|)
if|if
condition|(
name|legalchar
argument_list|(
operator|*
name|cp
argument_list|)
condition|)
name|bwrite
argument_list|(
operator|*
name|cp
operator|++
argument_list|)
expr_stmt|;
else|else
operator|++
name|cp
expr_stmt|;
if|if
condition|(
name|ch
operator|==
literal|012
condition|)
name|bwrite
argument_list|(
literal|012
argument_list|)
expr_stmt|;
block|}
block|}
block|}
end_block

begin_macro
name|printbad
argument_list|(
argument|cp
argument_list|,
argument|file
argument_list|)
end_macro

begin_decl_stmt
name|char
modifier|*
name|cp
decl_stmt|,
modifier|*
name|file
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|char
name|mine
index|[
literal|512
index|]
decl_stmt|;
specifier|register
name|char
modifier|*
name|cp2
decl_stmt|;
specifier|register
name|bad
operator|,
name|x
expr_stmt|;
name|cp2
operator|=
name|mine
expr_stmt|;
name|bad
operator|=
literal|0
expr_stmt|;
while|while
condition|(
operator|*
name|cp
condition|)
if|if
condition|(
operator|!
name|legalchar
argument_list|(
operator|*
name|cp
argument_list|)
condition|)
block|{
if|if
condition|(
name|FLAGS
operator|&
name|OCTAL
condition|)
block|{
name|x
operator|=
operator|*
name|cp
expr_stmt|;
operator|*
name|cp2
operator|++
operator|=
literal|'\\'
expr_stmt|;
operator|*
name|cp2
operator|++
operator|=
operator|(
operator|(
name|x
operator|&
literal|0300
operator|)
operator|>>
literal|6
operator|)
operator||
literal|'0'
expr_stmt|;
operator|*
name|cp2
operator|++
operator|=
operator|(
operator|(
name|x
operator|&
literal|0070
operator|)
operator|>>
literal|3
operator|)
operator||
literal|'0'
expr_stmt|;
operator|*
name|cp2
operator|++
operator|=
operator|(
operator|(
name|x
operator|&
literal|0007
operator|)
operator|)
operator||
literal|'0'
expr_stmt|;
block|}
else|else
operator|*
name|cp2
operator|++
operator|=
literal|'?'
expr_stmt|;
operator|++
name|bad
expr_stmt|;
operator|++
name|cp
expr_stmt|;
block|}
else|else
operator|*
name|cp2
operator|++
operator|=
operator|*
name|cp
operator|++
expr_stmt|;
operator|*
name|cp2
operator|++
operator|=
literal|012
expr_stmt|;
if|if
condition|(
name|bad
condition|)
block|{
if|if
condition|(
name|FLAGS
operator|&
name|VERBOSE
condition|)
block|{
name|prs
argument_list|(
name|file
argument_list|)
expr_stmt|;
if|if
condition|(
name|FLAGS
operator|&
name|LNO
condition|)
name|prs
argument_list|(
literal|"/"
argument_list|)
expr_stmt|;
else|else
name|prs
argument_list|(
literal|":"
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|FLAGS
operator|&
name|LNO
condition|)
block|{
name|prd
argument_list|(
name|linenum
argument_list|)
expr_stmt|;
name|prs
argument_list|(
literal|":"
argument_list|)
expr_stmt|;
block|}
name|write
argument_list|(
literal|2
argument_list|,
name|mine
argument_list|,
name|cp2
operator|-
name|mine
argument_list|)
expr_stmt|;
block|}
block|}
end_block

begin_macro
name|fixctlh
argument_list|(
argument|cp
argument_list|)
end_macro

begin_decl_stmt
name|char
modifier|*
name|cp
decl_stmt|;
end_decl_stmt

begin_block
block|{
specifier|register
name|char
modifier|*
name|np
decl_stmt|,
modifier|*
name|bp
decl_stmt|;
name|bp
operator|=
name|np
operator|=
name|cp
expr_stmt|;
while|while
condition|(
operator|*
name|cp
condition|)
block|{
if|if
condition|(
operator|*
name|cp
operator|==
literal|'\b'
condition|)
block|{
operator|++
name|cp
expr_stmt|;
if|if
condition|(
name|bp
operator|!=
name|np
condition|)
operator|--
name|np
expr_stmt|;
block|}
else|else
operator|*
name|np
operator|++
operator|=
operator|*
name|cp
operator|++
expr_stmt|;
block|}
operator|*
name|np
operator|=
literal|0
expr_stmt|;
block|}
end_block

begin_macro
name|bread
argument_list|(
argument|f
argument_list|)
end_macro

begin_block
block|{
for|for
control|(
init|;
condition|;
control|)
block|{
if|if
condition|(
name|eof
condition|)
return|return
operator|(
operator|-
literal|1
operator|)
return|;
if|if
condition|(
operator|!
name|avail
condition|)
block|{
name|avail
operator|=
name|read
argument_list|(
name|f
argument_list|,
name|buf
argument_list|,
literal|512
argument_list|)
expr_stmt|;
name|nxtchar
operator|=
name|buf
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|avail
condition|)
block|{
name|eof
operator|=
literal|1
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
operator|--
name|avail
expr_stmt|;
if|if
condition|(
operator|*
name|nxtchar
condition|)
return|return
operator|(
operator|*
name|nxtchar
operator|++
operator|)
return|;
operator|++
name|nxtchar
expr_stmt|;
return|return
operator|(
literal|0177
operator|)
return|;
block|}
block|}
end_block

begin_macro
name|bwrite
argument_list|(
argument|ch
argument_list|)
end_macro

begin_block
block|{
name|wbuf
index|[
name|wcount
operator|++
index|]
operator|=
name|ch
expr_stmt|;
if|if
condition|(
name|wcount
operator|>=
literal|512
condition|)
block|{
name|wcount
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|write
argument_list|(
literal|1
argument_list|,
name|wbuf
argument_list|,
literal|512
argument_list|)
operator|!=
literal|512
condition|)
block|{
name|prs
argument_list|(
literal|"fatal write error.\n"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
block|}
block|}
end_block

begin_macro
name|flushout
argument_list|()
end_macro

begin_block
block|{
if|if
condition|(
name|write
argument_list|(
literal|1
argument_list|,
name|wbuf
argument_list|,
name|wcount
argument_list|)
operator|!=
name|wcount
condition|)
block|{
name|prs
argument_list|(
literal|"fatal write error\n"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
block|}
end_block

begin_macro
name|prs
argument_list|(
argument|str
argument_list|)
end_macro

begin_decl_stmt
name|char
modifier|*
name|str
decl_stmt|;
end_decl_stmt

begin_block
block|{
specifier|register
name|char
modifier|*
name|dart
decl_stmt|;
name|dart
operator|=
name|str
expr_stmt|;
while|while
condition|(
operator|*
name|dart
condition|)
name|dart
operator|++
expr_stmt|;
name|write
argument_list|(
literal|2
argument_list|,
name|str
argument_list|,
name|dart
operator|-
name|str
argument_list|)
expr_stmt|;
block|}
end_block

begin_macro
name|legalchar
argument_list|(
argument|ch
argument_list|)
end_macro

begin_decl_stmt
name|char
name|ch
decl_stmt|;
end_decl_stmt

begin_block
block|{
if|if
condition|(
name|FLAGS
operator|&
name|FFILL
operator|&&
name|ch
operator|==
literal|014
condition|)
return|return
operator|(
literal|0
operator|)
return|;
if|if
condition|(
name|FLAGS
operator|&
name|CRILL
operator|&&
name|ch
operator|==
literal|015
condition|)
return|return
operator|(
literal|0
operator|)
return|;
if|if
condition|(
name|FLAGS
operator|&
name|BELLILL
operator|&&
name|ch
operator|==
literal|007
condition|)
return|return
operator|(
literal|0
operator|)
return|;
if|if
condition|(
name|any
argument_list|(
name|ch
argument_list|,
literal|"\t\014\015\007"
argument_list|)
condition|)
return|return
operator|(
literal|1
operator|)
return|;
if|if
condition|(
name|ch
operator|<
literal|040
operator|||
name|ch
operator|>
literal|0176
condition|)
return|return
operator|(
literal|0
operator|)
return|;
return|return
operator|(
literal|1
operator|)
return|;
block|}
end_block

begin_macro
name|any
argument_list|(
argument|c
argument_list|,
argument|cp
argument_list|)
end_macro

begin_decl_stmt
name|char
name|c
decl_stmt|,
modifier|*
name|cp
decl_stmt|;
end_decl_stmt

begin_block
block|{
while|while
condition|(
operator|*
name|cp
condition|)
if|if
condition|(
name|c
operator|==
operator|*
name|cp
operator|++
condition|)
return|return
operator|(
operator|-
literal|1
operator|)
return|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_block

begin_macro
name|prd
argument_list|(
argument|x
argument_list|)
end_macro

begin_block
block|{
name|char
name|nbuf
index|[
literal|10
index|]
decl_stmt|;
name|int
name|i
decl_stmt|,
name|j
decl_stmt|,
name|negf
decl_stmt|;
if|if
condition|(
operator|!
name|x
condition|)
block|{
name|prs
argument_list|(
literal|"0"
argument_list|)
expr_stmt|;
return|return;
block|}
name|i
operator|=
literal|8
expr_stmt|;
name|nbuf
index|[
literal|9
index|]
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|x
operator|<
literal|0
condition|)
block|{
name|negf
operator|=
literal|1
expr_stmt|;
name|x
operator|=
operator|-
name|x
expr_stmt|;
block|}
else|else
name|negf
operator|=
literal|0
expr_stmt|;
while|while
condition|(
name|x
condition|)
block|{
name|j
operator|=
name|x
operator|%
literal|10
expr_stmt|;
name|nbuf
index|[
name|i
operator|--
index|]
operator|=
name|j
operator|+
literal|060
expr_stmt|;
name|x
operator|=
operator|/
literal|10
expr_stmt|;
block|}
if|if
condition|(
name|negf
condition|)
name|prs
argument_list|(
literal|"-"
argument_list|)
expr_stmt|;
name|prs
argument_list|(
name|nbuf
operator|+
operator|++
name|i
argument_list|)
expr_stmt|;
block|}
end_block

end_unit


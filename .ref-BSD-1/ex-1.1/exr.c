begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_include
include|#
directive|include
file|"ex.h"
end_include

begin_include
include|#
directive|include
file|"ex_io.h"
end_include

begin_comment
comment|/*  * Ex - a text editor  * Bill Joy UCB June 1977  */
end_comment

begin_macro
name|rop
argument_list|(
argument|c
argument_list|)
end_macro

begin_decl_stmt
name|char
name|c
decl_stmt|;
end_decl_stmt

begin_block
block|{
specifier|register
name|int
name|i
decl_stmt|;
name|struct
name|stb
name|stbuf
decl_stmt|;
name|int
name|magic
decl_stmt|;
name|io
operator|=
name|open
argument_list|(
name|file
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|io
operator|<
literal|0
condition|)
block|{
if|if
condition|(
name|c
operator|==
literal|'e'
operator|&
name|errno
operator|==
name|ENOENT
condition|)
name|value
argument_list|(
name|EDITED
argument_list|)
operator|++
expr_stmt|;
name|ioerror
argument_list|()
expr_stmt|;
block|}
if|if
condition|(
name|value
argument_list|(
name|EDITANY
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|fstat
argument_list|(
name|io
argument_list|,
operator|&
name|stbuf
argument_list|)
condition|)
name|ioerror
argument_list|()
expr_stmt|;
switch|switch
condition|(
name|stbuf
operator|.
name|flags
operator|&
name|FILETYP
condition|)
block|{
case|case
name|FBLSPEC
case|:
name|error
argument_list|(
literal|" Block special file"
argument_list|)
expr_stmt|;
case|case
name|FCHSPEC
case|:
if|if
condition|(
name|gTTY
argument_list|(
name|io
argument_list|)
operator|==
literal|0
condition|)
name|error
argument_list|(
literal|" Teletype"
argument_list|)
expr_stmt|;
if|if
condition|(
name|stbuf
operator|.
name|dmajor
operator|==
name|DVNLMAJ
operator|&&
name|stbuf
operator|.
name|dminor
operator|==
name|DVNLMIN
condition|)
break|break;
name|error
argument_list|(
literal|" Character special file"
argument_list|)
expr_stmt|;
case|case
name|FDIRECT
case|:
name|error
argument_list|(
literal|" Directory"
argument_list|)
expr_stmt|;
case|case
name|FPLAIN
case|:
name|i
operator|=
name|read
argument_list|(
name|io
argument_list|,
operator|&
name|magic
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|seek
argument_list|(
name|io
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|i
operator|!=
literal|2
condition|)
break|break;
switch|switch
condition|(
name|magic
condition|)
block|{
case|case
literal|0404
case|:
name|error
argument_list|(
literal|" Pascal object"
argument_list|)
expr_stmt|;
case|case
literal|0405
case|:
name|error
argument_list|(
literal|" Overlay executable"
argument_list|)
expr_stmt|;
case|case
literal|0407
case|:
name|error
argument_list|(
literal|" Executable"
argument_list|)
expr_stmt|;
case|case
literal|0410
case|:
name|error
argument_list|(
literal|" Pure executbable"
argument_list|)
expr_stmt|;
case|case
literal|0411
case|:
name|error
argument_list|(
literal|" Separate executable"
argument_list|)
expr_stmt|;
case|case
literal|0177545
case|:
name|error
argument_list|(
literal|" Archive"
argument_list|)
expr_stmt|;
case|case
literal|0177555
case|:
name|error
argument_list|(
literal|" Old archive"
argument_list|)
expr_stmt|;
default|default:
if|if
condition|(
name|magic
operator|&
literal|0100200
condition|)
name|error
argument_list|(
literal|" Non-ascii file"
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
block|}
if|if
condition|(
name|c
operator|==
literal|'r'
condition|)
name|setdot
argument_list|()
expr_stmt|;
else|else
name|setall
argument_list|()
expr_stmt|;
name|rop2
argument_list|()
expr_stmt|;
name|rop3
argument_list|(
name|c
argument_list|)
expr_stmt|;
block|}
end_block

begin_macro
name|rop2
argument_list|()
end_macro

begin_block
block|{
name|deletenone
argument_list|()
expr_stmt|;
name|clrstats
argument_list|()
expr_stmt|;
name|append
argument_list|(
name|getfile
argument_list|,
name|addr2
argument_list|)
expr_stmt|;
block|}
end_block

begin_macro
name|rop3
argument_list|(
argument|c
argument_list|)
end_macro

begin_decl_stmt
name|char
name|c
decl_stmt|;
end_decl_stmt

begin_block
block|{
if|if
condition|(
name|iostats
argument_list|()
operator|==
literal|0
condition|)
if|if
condition|(
name|c
operator|==
literal|'e'
condition|)
name|value
argument_list|(
name|EDITED
argument_list|)
operator|++
expr_stmt|;
if|if
condition|(
name|c
operator|==
literal|'e'
condition|)
name|undkind
operator|=
name|UNDNONE
expr_stmt|;
if|if
condition|(
name|laste
condition|)
block|{
name|laste
operator|=
literal|0
expr_stmt|;
name|sync
argument_list|()
expr_stmt|;
block|}
block|}
end_block

end_unit


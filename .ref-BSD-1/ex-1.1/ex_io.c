begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_include
include|#
directive|include
file|"ex.h"
end_include

begin_include
include|#
directive|include
file|"ex_re.h"
end_include

begin_include
include|#
directive|include
file|"ex_io.h"
end_include

begin_comment
comment|/*  * Ex - a text editor  * Bill Joy UCB June 1977  */
end_comment

begin_extern
extern|extern	int tfile -1;
end_extern

begin_define
define|#
directive|define
name|READ
value|0
end_define

begin_define
define|#
directive|define
name|WRITE
value|1
end_define

begin_decl_stmt
name|STATIC
name|char
name|ichanged
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|STATIC
name|int
name|nleft
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|STATIC
name|int
name|ninbuf
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|STATIC
name|int
name|tline
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|STATIC
name|long
name|cntch
decl_stmt|,
name|cntnull
decl_stmt|,
name|cntodd
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|STATIC
name|int
name|cntln
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|STATIC
name|char
name|ibuff
index|[
literal|512
index|]
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|STATIC
name|int
name|iblock
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|STATIC
name|char
name|obuff
index|[
literal|512
index|]
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|STATIC
name|int
name|oblock
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|STATIC
name|char
name|tfname
index|[
literal|40
index|]
decl_stmt|;
end_decl_stmt

begin_expr_stmt
name|STATIC
name|char
name|tftail
index|[]
literal|"/ExXXXXX"
expr_stmt|;
end_expr_stmt

begin_decl_stmt
name|STATIC
name|char
name|havetmp
decl_stmt|;
end_decl_stmt

begin_macro
name|fileinit
argument_list|()
end_macro

begin_block
block|{
specifier|register
name|char
modifier|*
name|p
decl_stmt|;
specifier|register
name|int
name|i
decl_stmt|,
name|j
decl_stmt|;
name|struct
name|stb
name|stbuf
decl_stmt|;
name|int
name|serrno
decl_stmt|;
name|char
name|dumbcnt
decl_stmt|;
name|cleanup
argument_list|()
expr_stmt|;
name|close
argument_list|(
name|tfile
argument_list|)
expr_stmt|;
name|tline
operator|=
literal|0200
operator|*
literal|3
expr_stmt|;
name|blocks
index|[
literal|0
index|]
operator|=
literal|1
expr_stmt|;
name|blocks
index|[
literal|1
index|]
operator|=
literal|2
expr_stmt|;
name|blocks
index|[
literal|2
index|]
operator|=
operator|-
literal|1
expr_stmt|;
name|dirtcnt
operator|=
literal|0
expr_stmt|;
name|iblock
operator|=
operator|-
literal|1
expr_stmt|;
name|oblock
operator|=
operator|-
literal|1
expr_stmt|;
name|strcpy
argument_list|(
name|tfname
argument_list|,
name|value
argument_list|(
name|DIRECTORY
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|stat
argument_list|(
name|tfname
argument_list|,
operator|&
name|stbuf
argument_list|)
condition|)
block|{
name|dumbness
label|:
name|serrno
operator|=
name|errno
expr_stmt|;
name|lprintf
argument_list|(
literal|"PANIC: \"%s\":"
argument_list|,
name|tfname
argument_list|)
expr_stmt|;
name|flush
argument_list|()
expr_stmt|;
name|dumbcnt
operator|=
literal|0
expr_stmt|;
name|setexit
argument_list|()
expr_stmt|;
if|if
condition|(
name|dumbcnt
operator|==
literal|0
condition|)
block|{
name|errno
operator|=
name|serrno
expr_stmt|;
name|dumbcnt
operator|++
expr_stmt|;
name|ioerror
argument_list|()
expr_stmt|;
block|}
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|stbuf
operator|.
name|flags
operator|&
name|FILETYP
operator|)
operator|!=
name|FDIRECT
condition|)
block|{
name|errno
operator|=
name|ENOTDIR
expr_stmt|;
goto|goto
name|dumbness
goto|;
block|}
name|ichanged
operator|=
literal|0
expr_stmt|;
name|strcat
argument_list|(
name|tfname
argument_list|,
name|tftail
argument_list|)
expr_stmt|;
for|for
control|(
name|p
operator|=
name|strend
argument_list|(
name|tfname
argument_list|)
operator|,
name|i
operator|=
literal|5
operator|,
name|j
operator|=
name|getpid
argument_list|()
init|;
name|i
operator|>
literal|0
condition|;
name|i
operator|--
operator|,
name|j
operator|=
operator|/
literal|10
control|)
operator|*
operator|--
name|p
operator|=
name|j
operator|%
literal|10
operator||
literal|'0'
expr_stmt|;
name|tfile
operator|=
name|creat
argument_list|(
name|tfname
argument_list|,
literal|0600
argument_list|)
expr_stmt|;
if|if
condition|(
name|tfile
operator|<
literal|0
condition|)
goto|goto
name|dumbness
goto|;
name|havetmp
operator|=
literal|1
expr_stmt|;
name|close
argument_list|(
name|tfile
argument_list|)
expr_stmt|;
name|tfile
operator|=
name|open
argument_list|(
name|tfname
argument_list|,
literal|2
argument_list|)
expr_stmt|;
if|if
condition|(
name|tfile
operator|<
literal|0
condition|)
goto|goto
name|dumbness
goto|;
name|brk
argument_list|(
name|fendcore
argument_list|)
expr_stmt|;
block|}
end_block

begin_macro
name|cleanup
argument_list|()
end_macro

begin_block
block|{
if|if
condition|(
name|havetmp
condition|)
name|unlink
argument_list|(
name|tfname
argument_list|)
expr_stmt|;
name|havetmp
operator|=
literal|0
expr_stmt|;
block|}
end_block

begin_macro
name|onhup
argument_list|()
end_macro

begin_block
block|{
if|if
condition|(
name|chngflag
operator|==
literal|0
operator|||
name|preserve
argument_list|()
condition|)
name|cleanup
argument_list|()
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
end_block

begin_macro
name|clrstats
argument_list|()
end_macro

begin_block
block|{
name|ninbuf
operator|=
literal|0
expr_stmt|;
name|cntch
operator|=
literal|0
expr_stmt|;
name|cntln
operator|=
literal|0
expr_stmt|;
name|cntnull
operator|=
literal|0
expr_stmt|;
name|cntodd
operator|=
literal|0
expr_stmt|;
block|}
end_block

begin_macro
name|iostats
argument_list|()
end_macro

begin_block
block|{
name|close
argument_list|(
name|io
argument_list|)
expr_stmt|;
name|io
operator|=
operator|-
literal|1
expr_stmt|;
if|if
condition|(
name|value
argument_list|(
name|HUSH
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|value
argument_list|(
name|TERSE
argument_list|)
condition|)
name|printf
argument_list|(
literal|" %d/%ld"
argument_list|,
name|cntln
argument_list|,
name|cntch
argument_list|)
expr_stmt|;
else|else
name|printf
argument_list|(
literal|" %d line%s, %ld character%s"
argument_list|,
name|cntln
argument_list|,
name|plural
argument_list|(
name|cntln
argument_list|)
argument_list|,
name|cntch
argument_list|,
name|cntch
operator|==
literal|1
condition|?
literal|""
else|:
literal|"s"
argument_list|)
expr_stmt|;
if|if
condition|(
name|cntnull
operator|||
name|cntodd
condition|)
block|{
name|printf
argument_list|(
literal|" ("
argument_list|)
expr_stmt|;
if|if
condition|(
name|cntnull
condition|)
block|{
name|printf
argument_list|(
literal|"%ld null"
argument_list|,
name|cntnull
argument_list|)
expr_stmt|;
if|if
condition|(
name|cntodd
condition|)
name|printf
argument_list|(
literal|", "
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|cntodd
condition|)
name|printf
argument_list|(
literal|"%ld dirty"
argument_list|,
name|cntodd
argument_list|)
expr_stmt|;
name|putchar
argument_list|(
literal|')'
argument_list|)
expr_stmt|;
block|}
name|putnl
argument_list|()
expr_stmt|;
block|}
return|return
operator|(
name|cntnull
operator|!=
literal|0
operator|||
name|cntodd
operator|!=
literal|0
operator|)
return|;
block|}
end_block

begin_macro
name|plural
argument_list|(
argument|i
argument_list|)
end_macro

begin_decl_stmt
name|int
name|i
decl_stmt|;
end_decl_stmt

begin_block
block|{
return|return
operator|(
name|i
operator|==
literal|1
condition|?
literal|""
else|:
literal|"s"
operator|)
return|;
block|}
end_block

begin_macro
name|getline
argument_list|(
argument|tl
argument_list|)
end_macro

begin_decl_stmt
name|int
name|tl
decl_stmt|;
end_decl_stmt

begin_block
block|{
specifier|register
name|char
modifier|*
name|bp
decl_stmt|,
modifier|*
name|lp
decl_stmt|;
specifier|register
name|nl
expr_stmt|;
name|char
name|scratch
index|[
name|LBSIZE
index|]
decl_stmt|;
name|lp
operator|=
name|scratch
expr_stmt|;
name|bp
operator|=
name|getblock
argument_list|(
name|tl
argument_list|,
name|READ
argument_list|)
expr_stmt|;
name|nl
operator|=
name|nleft
expr_stmt|;
name|tl
operator|=
operator|&
operator|~
literal|0177
expr_stmt|;
while|while
condition|(
operator|*
name|lp
operator|++
operator|=
operator|*
name|bp
operator|++
condition|)
if|if
condition|(
operator|--
name|nl
operator|==
literal|0
condition|)
block|{
name|bp
operator|=
name|getblock
argument_list|(
name|tl
operator|=
operator|+
literal|0200
argument_list|,
name|READ
argument_list|)
expr_stmt|;
name|nl
operator|=
name|nleft
expr_stmt|;
block|}
return|return
operator|(
name|unpack
argument_list|(
name|scratch
argument_list|)
operator|)
return|;
block|}
end_block

begin_macro
name|putline
argument_list|()
end_macro

begin_block
block|{
specifier|register
name|char
modifier|*
name|bp
decl_stmt|,
modifier|*
name|lp
decl_stmt|;
specifier|register
name|nl
expr_stmt|;
name|int
name|tl
decl_stmt|;
name|char
name|scratch
index|[
name|LBSIZE
index|]
decl_stmt|;
name|dirtcnt
operator|++
expr_stmt|;
name|lp
operator|=
name|scratch
expr_stmt|;
name|pack
argument_list|(
name|lp
argument_list|)
expr_stmt|;
name|change
argument_list|()
expr_stmt|;
name|tl
operator|=
name|tline
expr_stmt|;
name|bp
operator|=
name|getblock
argument_list|(
name|tl
argument_list|,
name|WRITE
argument_list|)
expr_stmt|;
name|nl
operator|=
name|nleft
expr_stmt|;
name|tl
operator|=
operator|&
operator|~
literal|0177
expr_stmt|;
while|while
condition|(
operator|*
name|bp
operator|++
operator|=
operator|*
name|lp
operator|++
condition|)
block|{
if|if
condition|(
operator|--
name|nl
operator|==
literal|0
condition|)
block|{
name|bp
operator|=
name|getblock
argument_list|(
name|tl
operator|=
operator|+
literal|0200
argument_list|,
name|WRITE
argument_list|)
expr_stmt|;
name|nl
operator|=
name|nleft
expr_stmt|;
block|}
block|}
name|nl
operator|=
name|tline
expr_stmt|;
name|tline
operator|=
operator|+
operator|(
operator|(
operator|(
name|lp
operator|-
name|scratch
operator|)
operator|+
literal|07
operator|)
operator|>>
literal|2
operator|)
operator|&
literal|077776
expr_stmt|;
return|return
operator|(
name|nl
operator|)
return|;
block|}
end_block

begin_decl_stmt
name|STATIC
name|char
modifier|*
name|nextip
decl_stmt|;
end_decl_stmt

begin_macro
name|getfile
argument_list|()
end_macro

begin_block
block|{
specifier|register
name|c
expr_stmt|;
specifier|register
name|char
modifier|*
name|lp
decl_stmt|,
modifier|*
name|fp
decl_stmt|;
name|lp
operator|=
name|linebuf
expr_stmt|;
name|fp
operator|=
name|nextip
expr_stmt|;
do|do
block|{
if|if
condition|(
operator|--
name|ninbuf
operator|<
literal|0
condition|)
block|{
name|ninbuf
operator|=
name|read
argument_list|(
name|io
argument_list|,
name|genbuf
argument_list|,
name|LBSIZE
argument_list|)
operator|-
literal|1
expr_stmt|;
if|if
condition|(
name|ninbuf
operator|<
literal|0
condition|)
block|{
if|if
condition|(
name|lp
operator|!=
name|linebuf
condition|)
block|{
name|printf
argument_list|(
literal|"[Incomplete last line] "
argument_list|)
expr_stmt|;
break|break;
block|}
return|return
operator|(
name|EOF
operator|)
return|;
block|}
name|fp
operator|=
name|genbuf
expr_stmt|;
block|}
if|if
condition|(
name|lp
operator|>=
operator|&
name|linebuf
index|[
name|LBSIZE
index|]
condition|)
name|error
argument_list|(
literal|" Line too long@- limit 512 characters"
argument_list|)
expr_stmt|;
name|c
operator|=
operator|*
name|fp
operator|++
expr_stmt|;
if|if
condition|(
name|c
operator|==
literal|0
condition|)
block|{
name|cntnull
operator|++
expr_stmt|;
continue|continue;
block|}
if|if
condition|(
name|c
operator|&
literal|0200
condition|)
block|{
name|cntodd
operator|++
expr_stmt|;
name|c
operator|=
operator|&
literal|0177
expr_stmt|;
if|if
condition|(
name|c
operator|==
literal|0
condition|)
continue|continue;
block|}
operator|*
name|lp
operator|++
operator|=
name|c
expr_stmt|;
block|}
do|while
condition|(
name|c
operator|!=
literal|'\n'
condition|)
do|;
name|cntch
operator|=
operator|+
name|lp
operator|-
name|linebuf
expr_stmt|;
operator|*
operator|--
name|lp
operator|=
literal|0
expr_stmt|;
name|nextip
operator|=
name|fp
expr_stmt|;
name|cntln
operator|++
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_block

begin_macro
name|putfile
argument_list|()
end_macro

begin_block
block|{
name|int
modifier|*
name|a1
decl_stmt|;
specifier|register
name|char
modifier|*
name|fp
decl_stmt|,
modifier|*
name|lp
decl_stmt|;
specifier|register
name|int
name|nib
decl_stmt|;
name|a1
operator|=
name|addr1
expr_stmt|;
name|clrstats
argument_list|()
expr_stmt|;
name|cntln
operator|=
name|addr2
operator|-
name|a1
operator|+
literal|1
expr_stmt|;
if|if
condition|(
name|cntln
operator|==
literal|0
condition|)
return|return;
name|nib
operator|=
literal|512
expr_stmt|;
name|fp
operator|=
name|genbuf
expr_stmt|;
do|do
block|{
name|lp
operator|=
name|getline
argument_list|(
operator|*
name|a1
operator|++
argument_list|)
expr_stmt|;
for|for
control|(
init|;
condition|;
control|)
block|{
if|if
condition|(
operator|--
name|nib
operator|<
literal|0
condition|)
block|{
if|if
condition|(
name|write
argument_list|(
name|io
argument_list|,
name|genbuf
argument_list|,
name|nib
operator|=
name|fp
operator|-
name|genbuf
argument_list|)
operator|!=
name|nib
condition|)
name|wrerror
argument_list|()
expr_stmt|;
name|cntch
operator|=
operator|+
name|nib
expr_stmt|;
name|nib
operator|=
literal|511
expr_stmt|;
name|fp
operator|=
name|genbuf
expr_stmt|;
block|}
if|if
condition|(
operator|(
operator|*
name|fp
operator|++
operator|=
operator|*
name|lp
operator|++
operator|)
operator|==
literal|0
condition|)
block|{
name|fp
index|[
operator|-
literal|1
index|]
operator|=
literal|'\n'
expr_stmt|;
break|break;
block|}
block|}
block|}
do|while
condition|(
name|a1
operator|<=
name|addr2
condition|)
do|;
if|if
condition|(
name|write
argument_list|(
name|io
argument_list|,
name|genbuf
argument_list|,
name|nib
operator|=
name|fp
operator|-
name|genbuf
argument_list|)
operator|!=
name|nib
condition|)
name|wrerror
argument_list|()
expr_stmt|;
name|cntch
operator|=
operator|+
name|nib
expr_stmt|;
block|}
end_block

begin_macro
name|wrerror
argument_list|()
end_macro

begin_block
block|{
if|if
condition|(
name|eq
argument_list|(
name|file
argument_list|,
name|savedfile
argument_list|)
operator|&&
name|value
argument_list|(
name|EDITED
argument_list|)
condition|)
name|change
argument_list|()
expr_stmt|;
name|ioerror
argument_list|()
expr_stmt|;
block|}
end_block

begin_macro
name|ioerror
argument_list|()
end_macro

begin_block
block|{
switch|switch
condition|(
name|errno
condition|)
block|{
case|case
name|ENOENT
case|:
name|error
argument_list|(
literal|" No such file or directory"
argument_list|)
expr_stmt|;
case|case
name|EIO
case|:
name|error
argument_list|(
literal|" Physical I/O error"
argument_list|)
expr_stmt|;
case|case
name|EACCESS
case|:
name|error
argument_list|(
literal|" Permission denied"
argument_list|)
expr_stmt|;
case|case
name|ENOTDIR
case|:
name|error
argument_list|(
literal|" Not a directory"
argument_list|)
expr_stmt|;
case|case
name|EISDIR
case|:
name|error
argument_list|(
literal|" Is a directory"
argument_list|)
expr_stmt|;
case|case
name|ENFILE
case|:
name|error
argument_list|(
literal|" File table overflow"
argument_list|)
expr_stmt|;
case|case
name|ENOSPC
case|:
name|error
argument_list|(
literal|" No space left on device"
argument_list|)
expr_stmt|;
case|case
name|EQUOT
case|:
name|error
argument_list|(
literal|" Quota exceeded"
argument_list|)
expr_stmt|;
case|case
name|EROFS
case|:
name|error
argument_list|(
literal|" Read-only file system"
argument_list|)
expr_stmt|;
default|default:
name|error
argument_list|(
literal|" I/O error %d"
argument_list|,
name|errno
argument_list|)
expr_stmt|;
block|}
block|}
end_block

begin_function_decl
name|int
name|read
parameter_list|()
function_decl|;
end_function_decl

begin_function_decl
name|int
name|write
parameter_list|()
function_decl|;
end_function_decl

begin_macro
name|getblock
argument_list|(
argument|atl
argument_list|,
argument|iof
argument_list|)
end_macro

begin_decl_stmt
name|int
name|atl
decl_stmt|;
end_decl_stmt

begin_function_decl
name|int
function_decl|(
modifier|*
name|iof
function_decl|)
parameter_list|()
function_decl|;
end_function_decl

begin_block
block|{
specifier|register
name|int
name|bno
decl_stmt|,
name|off
decl_stmt|;
name|bno
operator|=
operator|(
name|atl
operator|>>
literal|7
operator|)
operator|&
literal|0777
expr_stmt|;
name|off
operator|=
operator|(
name|atl
operator|<<
literal|2
operator|)
operator|&
literal|0770
expr_stmt|;
if|if
condition|(
name|bno
operator|>=
literal|506
condition|)
name|error
argument_list|(
literal|" Tmp file too large"
argument_list|)
expr_stmt|;
name|nleft
operator|=
literal|512
operator|-
name|off
expr_stmt|;
if|if
condition|(
name|bno
operator|==
name|iblock
condition|)
block|{
name|ichanged
operator|=
operator||
name|iof
expr_stmt|;
return|return
operator|(
name|ibuff
operator|+
name|off
operator|)
return|;
block|}
if|if
condition|(
name|bno
operator|==
name|oblock
condition|)
return|return
operator|(
name|obuff
operator|+
name|off
operator|)
return|;
if|if
condition|(
name|iof
operator|==
name|READ
condition|)
block|{
if|if
condition|(
name|ichanged
condition|)
name|blkio
argument_list|(
name|iblock
argument_list|,
name|ibuff
argument_list|,
name|write
argument_list|)
expr_stmt|;
name|ichanged
operator|=
literal|0
expr_stmt|;
name|iblock
operator|=
name|bno
expr_stmt|;
name|blkio
argument_list|(
name|bno
argument_list|,
name|ibuff
argument_list|,
name|read
argument_list|)
expr_stmt|;
return|return
operator|(
name|ibuff
operator|+
name|off
operator|)
return|;
block|}
if|if
condition|(
name|oblock
operator|>=
literal|0
condition|)
name|blkio
argument_list|(
name|oblock
argument_list|,
name|obuff
argument_list|,
name|write
argument_list|)
expr_stmt|;
name|oblock
operator|=
name|bno
expr_stmt|;
return|return
operator|(
name|obuff
operator|+
name|off
operator|)
return|;
block|}
end_block

begin_macro
name|blkio
argument_list|(
argument|b
argument_list|,
argument|buf
argument_list|,
argument|iofcn
argument_list|)
end_macro

begin_function_decl
name|int
function_decl|(
modifier|*
name|iofcn
function_decl|)
parameter_list|()
function_decl|;
end_function_decl

begin_block
block|{
name|seek
argument_list|(
name|tfile
argument_list|,
name|b
argument_list|,
literal|3
argument_list|)
expr_stmt|;
if|if
condition|(
call|(
modifier|*
name|iofcn
call|)
argument_list|(
name|tfile
argument_list|,
name|buf
argument_list|,
literal|512
argument_list|)
operator|!=
literal|512
condition|)
name|ioerror
argument_list|()
expr_stmt|;
block|}
end_block

begin_macro
name|synctmp
argument_list|()
end_macro

begin_block
block|{
specifier|register
name|int
modifier|*
name|bp
decl_stmt|,
modifier|*
name|a
decl_stmt|,
name|cnt
decl_stmt|;
if|if
condition|(
name|ichanged
condition|)
name|blkio
argument_list|(
name|iblock
argument_list|,
name|ibuff
argument_list|,
name|write
argument_list|)
expr_stmt|;
name|ichanged
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|oblock
operator|!=
operator|-
literal|1
condition|)
name|blkio
argument_list|(
name|oblock
argument_list|,
name|obuff
argument_list|,
name|write
argument_list|)
expr_stmt|;
name|time
argument_list|(
operator|&
name|header
operator|.
name|Atime
argument_list|)
expr_stmt|;
name|header
operator|.
name|Auid
operator|=
name|getuid
argument_list|()
operator|&
name|mask
expr_stmt|;
operator|*
name|zero
operator|=
name|header
operator|.
name|Atime
index|[
literal|1
index|]
expr_stmt|;
for|for
control|(
name|a
operator|=
name|zero
operator|,
name|bp
operator|=
name|blocks
init|;
name|a
operator|<=
name|dol
condition|;
name|a
operator|=
operator|+
literal|256
operator|,
name|bp
operator|++
control|)
block|{
if|if
condition|(
operator|*
name|bp
operator|<
literal|0
condition|)
block|{
name|tline
operator|=
operator|(
name|tline
operator|+
literal|0177
operator|)
operator|&
operator|~
literal|0177
expr_stmt|;
operator|*
name|bp
operator|=
operator|(
operator|(
name|tline
operator|>>
literal|7
operator|)
operator|&
literal|0777
operator|)
expr_stmt|;
name|tline
operator|=
operator|+
literal|0200
expr_stmt|;
name|oblock
operator|=
operator|*
name|bp
operator|+
literal|1
expr_stmt|;
name|bp
index|[
literal|1
index|]
operator|=
operator|-
literal|1
expr_stmt|;
block|}
name|seek
argument_list|(
name|tfile
argument_list|,
operator|*
name|bp
argument_list|,
literal|3
argument_list|)
expr_stmt|;
name|cnt
operator|=
operator|(
name|dol
operator|-
name|a
operator|+
literal|2
operator|)
operator|<<
literal|1
expr_stmt|;
if|if
condition|(
name|cnt
operator|>
literal|512
condition|)
name|cnt
operator|=
literal|512
expr_stmt|;
if|if
condition|(
name|write
argument_list|(
name|tfile
argument_list|,
name|a
argument_list|,
name|cnt
argument_list|)
operator|!=
name|cnt
condition|)
block|{
name|oops
label|:
operator|*
name|zero
operator|=
literal|0
expr_stmt|;
name|printf
argument_list|(
literal|"SYNC error:"
argument_list|)
expr_stmt|;
name|ioerror
argument_list|()
expr_stmt|;
block|}
operator|*
name|zero
operator|=
literal|0
expr_stmt|;
block|}
name|header
operator|.
name|Alines
operator|=
name|dol
operator|-
name|zero
expr_stmt|;
name|seek
argument_list|(
name|tfile
argument_list|,
literal|0
argument_list|,
literal|3
argument_list|)
expr_stmt|;
if|if
condition|(
name|write
argument_list|(
name|tfile
argument_list|,
operator|&
name|header
argument_list|,
sizeof|sizeof
name|header
argument_list|)
operator|!=
sizeof|sizeof
name|header
condition|)
goto|goto
name|oops
goto|;
comment|/* 	seek(tfile, 504, 0); 	write(tfile, "LOST", 5); */
block|}
end_block

begin_macro
name|TSYNC
argument_list|()
end_macro

begin_block
block|{
if|if
condition|(
name|dirtcnt
operator|>
literal|12
condition|)
block|{
name|synctmp
argument_list|()
expr_stmt|;
name|dirtcnt
operator|=
literal|0
expr_stmt|;
block|}
block|}
end_block

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/***********************license start***************  * Copyright (c) 2003-2010  Cavium Inc. (support@cavium.com). All rights  * reserved.  *  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions are  * met:  *  *   * Redistributions of source code must retain the above copyright  *     notice, this list of conditions and the following disclaimer.  *  *   * Redistributions in binary form must reproduce the above  *     copyright notice, this list of conditions and the following  *     disclaimer in the documentation and/or other materials provided  *     with the distribution.   *   * Neither the name of Cavium Inc. nor the names of  *     its contributors may be used to endorse or promote products  *     derived from this software without specific prior written  *     permission.   * This Software, including technical data, may be subject to U.S. export  control  * laws, including the U.S. Export Administration Act and its  associated  * regulations, and may be subject to export or import  regulations in other  * countries.   * TO THE MAXIMUM EXTENT PERMITTED BY LAW, THE SOFTWARE IS PROVIDED "AS IS"  * AND WITH ALL FAULTS AND CAVIUM INC. MAKES NO PROMISES, REPRESENTATIONS OR  * WARRANTIES, EITHER EXPRESS, IMPLIED, STATUTORY, OR OTHERWISE, WITH RESPECT TO  * THE SOFTWARE, INCLUDING ITS CONDITION, ITS CONFORMITY TO ANY REPRESENTATION OR  * DESCRIPTION, OR THE EXISTENCE OF ANY LATENT OR PATENT DEFECTS, AND CAVIUM  * SPECIFICALLY DISCLAIMS ALL IMPLIED (IF ANY) WARRANTIES OF TITLE,  * MERCHANTABILITY, NONINFRINGEMENT, FITNESS FOR A PARTICULAR PURPOSE, LACK OF  * VIRUSES, ACCURACY OR COMPLETENESS, QUIET ENJOYMENT, QUIET POSSESSION OR  * CORRESPONDENCE TO DESCRIPTION. THE ENTIRE  RISK ARISING OUT OF USE OR  * PERFORMANCE OF THE SOFTWARE LIES WITH YOU.  ***********************license end**************************************/
end_comment

begin_comment
comment|/**  * @file  *  * Helper functions for FPA setup.  *  *<hr>$Revision: 70030 $<hr>  */
end_comment

begin_include
include|#
directive|include
file|"executive-config.h"
end_include

begin_include
include|#
directive|include
file|"cvmx-config.h"
end_include

begin_include
include|#
directive|include
file|"cvmx.h"
end_include

begin_include
include|#
directive|include
file|"cvmx-bootmem.h"
end_include

begin_include
include|#
directive|include
file|"cvmx-fpa.h"
end_include

begin_include
include|#
directive|include
file|"cvmx-helper-fpa.h"
end_include

begin_comment
comment|/**  * @INTERNAL  * Allocate memory for and initialize a single FPA pool.  *  * @param pool    Pool to initialize  * @param buffer_size  Size of buffers to allocate in bytes  * @param buffers Number of buffers to put in the pool. Zero is allowed  * @param name    String name of the pool for debugging purposes  * @return Zero on success, non-zero on failure  */
end_comment

begin_function
specifier|static
name|int
name|__cvmx_helper_initialize_fpa_pool
parameter_list|(
name|int
name|pool
parameter_list|,
name|uint64_t
name|buffer_size
parameter_list|,
name|uint64_t
name|buffers
parameter_list|,
specifier|const
name|char
modifier|*
name|name
parameter_list|)
block|{
name|uint64_t
name|current_num
decl_stmt|;
name|void
modifier|*
name|memory
decl_stmt|;
name|uint64_t
name|align
init|=
name|CVMX_CACHE_LINE_SIZE
decl_stmt|;
comment|/* Align the allocation so that power of 2 size buffers are naturally aligned */
while|while
condition|(
name|align
operator|<
name|buffer_size
condition|)
name|align
operator|=
name|align
operator|<<
literal|1
expr_stmt|;
if|if
condition|(
name|buffers
operator|==
literal|0
condition|)
return|return
literal|0
return|;
name|current_num
operator|=
name|cvmx_read_csr
argument_list|(
name|CVMX_FPA_QUEX_AVAILABLE
argument_list|(
name|pool
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|current_num
condition|)
block|{
name|cvmx_dprintf
argument_list|(
literal|"Fpa pool %d(%s) already has %llu buffers. Skipping setup.\n"
argument_list|,
name|pool
argument_list|,
name|name
argument_list|,
operator|(
name|unsigned
name|long
name|long
operator|)
name|current_num
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
name|memory
operator|=
name|cvmx_bootmem_alloc
argument_list|(
name|buffer_size
operator|*
name|buffers
argument_list|,
name|align
argument_list|)
expr_stmt|;
if|if
condition|(
name|memory
operator|==
name|NULL
condition|)
block|{
name|cvmx_dprintf
argument_list|(
literal|"Out of memory initializing fpa pool %d(%s).\n"
argument_list|,
name|pool
argument_list|,
name|name
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|cvmx_fpa_setup_pool
argument_list|(
name|pool
argument_list|,
name|name
argument_list|,
name|memory
argument_list|,
name|buffer_size
argument_list|,
name|buffers
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/**  * @INTERNAL  * Allocate memory and initialize the FPA pools using memory  * from cvmx-bootmem. Specifying zero for the number of  * buffers will cause that FPA pool to not be setup. This is  * useful if you aren't using some of the hardware and want  * to save memory. Use cvmx_helper_initialize_fpa instead of  * this function directly.  *  * @param pip_pool Should always be CVMX_FPA_PACKET_POOL  * @param pip_size Should always be CVMX_FPA_PACKET_POOL_SIZE  * @param pip_buffers  *                 Number of packet buffers.  * @param wqe_pool Should always be CVMX_FPA_WQE_POOL  * @param wqe_size Should always be CVMX_FPA_WQE_POOL_SIZE  * @param wqe_entries  *                 Number of work queue entries  * @param pko_pool Should always be CVMX_FPA_OUTPUT_BUFFER_POOL  * @param pko_size Should always be CVMX_FPA_OUTPUT_BUFFER_POOL_SIZE  * @param pko_buffers  *                 PKO Command buffers. You should at minimum have two per  *                 each PKO queue.  * @param tim_pool Should always be CVMX_FPA_TIMER_POOL  * @param tim_size Should always be CVMX_FPA_TIMER_POOL_SIZE  * @param tim_buffers  *                 TIM ring buffer command queues. At least two per timer bucket  *                 is recommended.  * @param dfa_pool Should always be CVMX_FPA_DFA_POOL  * @param dfa_size Should always be CVMX_FPA_DFA_POOL_SIZE  * @param dfa_buffers  *                 DFA command buffer. A relatively small (32 for example)  *                 number should work.  * @return Zero on success, non-zero if out of memory  */
end_comment

begin_function
specifier|static
name|int
name|__cvmx_helper_initialize_fpa
parameter_list|(
name|int
name|pip_pool
parameter_list|,
name|int
name|pip_size
parameter_list|,
name|int
name|pip_buffers
parameter_list|,
name|int
name|wqe_pool
parameter_list|,
name|int
name|wqe_size
parameter_list|,
name|int
name|wqe_entries
parameter_list|,
name|int
name|pko_pool
parameter_list|,
name|int
name|pko_size
parameter_list|,
name|int
name|pko_buffers
parameter_list|,
name|int
name|tim_pool
parameter_list|,
name|int
name|tim_size
parameter_list|,
name|int
name|tim_buffers
parameter_list|,
name|int
name|dfa_pool
parameter_list|,
name|int
name|dfa_size
parameter_list|,
name|int
name|dfa_buffers
parameter_list|)
block|{
name|int
name|status
decl_stmt|;
name|cvmx_fpa_enable
argument_list|()
expr_stmt|;
if|if
condition|(
operator|(
name|pip_buffers
operator|>
literal|0
operator|)
operator|&&
operator|(
name|pip_buffers
operator|<=
literal|64
operator|)
condition|)
name|cvmx_dprintf
argument_list|(
literal|"Warning: %d packet buffers may not be enough for hardware"
literal|" prefetch. 65 or more is recommended.\n"
argument_list|,
name|pip_buffers
argument_list|)
expr_stmt|;
if|if
condition|(
name|pip_pool
operator|>=
literal|0
condition|)
block|{
name|status
operator|=
name|__cvmx_helper_initialize_fpa_pool
argument_list|(
name|pip_pool
argument_list|,
name|pip_size
argument_list|,
name|pip_buffers
argument_list|,
literal|"Packet Buffers"
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
condition|)
return|return
name|status
return|;
block|}
if|if
condition|(
name|wqe_pool
operator|>=
literal|0
condition|)
block|{
name|status
operator|=
name|__cvmx_helper_initialize_fpa_pool
argument_list|(
name|wqe_pool
argument_list|,
name|wqe_size
argument_list|,
name|wqe_entries
argument_list|,
literal|"Work Queue Entries"
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
condition|)
return|return
name|status
return|;
block|}
if|if
condition|(
name|pko_pool
operator|>=
literal|0
condition|)
block|{
name|status
operator|=
name|__cvmx_helper_initialize_fpa_pool
argument_list|(
name|pko_pool
argument_list|,
name|pko_size
argument_list|,
name|pko_buffers
argument_list|,
literal|"PKO Command Buffers"
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
condition|)
return|return
name|status
return|;
block|}
if|if
condition|(
name|tim_pool
operator|>=
literal|0
condition|)
block|{
name|status
operator|=
name|__cvmx_helper_initialize_fpa_pool
argument_list|(
name|tim_pool
argument_list|,
name|tim_size
argument_list|,
name|tim_buffers
argument_list|,
literal|"TIM Command Buffers"
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
condition|)
return|return
name|status
return|;
block|}
if|if
condition|(
name|dfa_pool
operator|>=
literal|0
condition|)
block|{
name|status
operator|=
name|__cvmx_helper_initialize_fpa_pool
argument_list|(
name|dfa_pool
argument_list|,
name|dfa_size
argument_list|,
name|dfa_buffers
argument_list|,
literal|"DFA Command Buffers"
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
condition|)
return|return
name|status
return|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/**  * Allocate memory and initialize the FPA pools using memory  * from cvmx-bootmem. Sizes of each element in the pools is  * controlled by the cvmx-config.h header file. Specifying  * zero for any parameter will cause that FPA pool to not be  * setup. This is useful if you aren't using some of the  * hardware and want to save memory.  *  * @param packet_buffers  *               Number of packet buffers to allocate  * @param work_queue_entries  *               Number of work queue entries  * @param pko_buffers  *               PKO Command buffers. You should at minimum have two per  *               each PKO queue.  * @param tim_buffers  *               TIM ring buffer command queues. At least two per timer bucket  *               is recommended.  * @param dfa_buffers  *               DFA command buffer. A relatively small (32 for example)  *               number should work.  * @return Zero on success, non-zero if out of memory  */
end_comment

begin_function
name|int
name|cvmx_helper_initialize_fpa
parameter_list|(
name|int
name|packet_buffers
parameter_list|,
name|int
name|work_queue_entries
parameter_list|,
name|int
name|pko_buffers
parameter_list|,
name|int
name|tim_buffers
parameter_list|,
name|int
name|dfa_buffers
parameter_list|)
block|{
ifndef|#
directive|ifndef
name|CVMX_FPA_PACKET_POOL
define|#
directive|define
name|CVMX_FPA_PACKET_POOL
value|-1
define|#
directive|define
name|CVMX_FPA_PACKET_POOL_SIZE
value|0
endif|#
directive|endif
ifndef|#
directive|ifndef
name|CVMX_FPA_WQE_POOL
define|#
directive|define
name|CVMX_FPA_WQE_POOL
value|-1
define|#
directive|define
name|CVMX_FPA_WQE_POOL_SIZE
value|0
endif|#
directive|endif
ifndef|#
directive|ifndef
name|CVMX_FPA_OUTPUT_BUFFER_POOL
define|#
directive|define
name|CVMX_FPA_OUTPUT_BUFFER_POOL
value|-1
define|#
directive|define
name|CVMX_FPA_OUTPUT_BUFFER_POOL_SIZE
value|0
endif|#
directive|endif
ifndef|#
directive|ifndef
name|CVMX_FPA_TIMER_POOL
define|#
directive|define
name|CVMX_FPA_TIMER_POOL
value|-1
define|#
directive|define
name|CVMX_FPA_TIMER_POOL_SIZE
value|0
endif|#
directive|endif
ifndef|#
directive|ifndef
name|CVMX_FPA_DFA_POOL
define|#
directive|define
name|CVMX_FPA_DFA_POOL
value|-1
define|#
directive|define
name|CVMX_FPA_DFA_POOL_SIZE
value|0
endif|#
directive|endif
return|return
name|__cvmx_helper_initialize_fpa
argument_list|(
name|CVMX_FPA_PACKET_POOL
argument_list|,
name|CVMX_FPA_PACKET_POOL_SIZE
argument_list|,
name|packet_buffers
argument_list|,
name|CVMX_FPA_WQE_POOL
argument_list|,
name|CVMX_FPA_WQE_POOL_SIZE
argument_list|,
name|work_queue_entries
argument_list|,
name|CVMX_FPA_OUTPUT_BUFFER_POOL
argument_list|,
name|CVMX_FPA_OUTPUT_BUFFER_POOL_SIZE
argument_list|,
name|pko_buffers
argument_list|,
name|CVMX_FPA_TIMER_POOL
argument_list|,
name|CVMX_FPA_TIMER_POOL_SIZE
argument_list|,
name|tim_buffers
argument_list|,
name|CVMX_FPA_DFA_POOL
argument_list|,
name|CVMX_FPA_DFA_POOL_SIZE
argument_list|,
name|dfa_buffers
argument_list|)
return|;
block|}
end_function

end_unit


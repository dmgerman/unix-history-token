begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * The new sysinstall program.  *  * This is probably the last attempt in the `sysinstall' line, the next  * generation being slated to essentially a complete rewrite.  *  * $Id: network.c,v 1.6.2.1 1995/06/03 04:16:51 jkh Exp $  *  * Copyright (c) 1995  *	Jordan Hubbard.  All rights reserved.  * Copyright (c) 1995  * 	Gary J Palmer. All rights reserved.  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions  * are met:  * 1. Redistributions of source code must retain the above copyright  *    notice, this list of conditions and the following disclaimer,  *    verbatim and that no modifications are made prior to this  *    point in the file.  * 2. Redistributions in binary form must reproduce the above copyright  *    notice, this list of conditions and the following disclaimer in the  *    documentation and/or other materials provided with the distribution.  * 3. All advertising materials mentioning features or use of this software  *    must display the following acknowledgement:  *	This product includes software developed by Jordan Hubbard  *	for the FreeBSD Project.  * 4. The name of Jordan Hubbard or the FreeBSD project may not be used to  *    endorse or promote products derived from this software without specific  *    prior written permission.  *  * THIS SOFTWARE IS PROVIDED BY JORDAN HUBBARD ``AS IS'' AND  * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE  * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE  * ARE DISCLAIMED.  IN NO EVENT SHALL JORDAN HUBBARD OR HIS PETS BE LIABLE  * FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL  * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS  * OR SERVICES; LOSS OF USE, DATA, LIFE OR PROFITS; OR BUSINESS INTERRUPTION)  * HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT  * LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY  * OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF  * SUCH DAMAGE.  *  */
end_comment

begin_comment
comment|/* These routines deal with getting things off of network media */
end_comment

begin_include
include|#
directive|include
file|"sysinstall.h"
end_include

begin_include
include|#
directive|include
file|<sys/fcntl.h>
end_include

begin_include
include|#
directive|include
file|<sys/stat.h>
end_include

begin_decl_stmt
specifier|static
name|Boolean
name|networkInitialized
decl_stmt|;
end_decl_stmt

begin_function_decl
specifier|static
name|Boolean
name|startPPP
parameter_list|(
name|Device
modifier|*
name|devp
parameter_list|)
function_decl|;
end_function_decl

begin_function
name|Boolean
name|mediaInitNetwork
parameter_list|(
name|Device
modifier|*
name|dev
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
name|char
modifier|*
name|rp
decl_stmt|;
if|if
condition|(
name|networkInitialized
condition|)
return|return
name|TRUE
return|;
name|configResolv
argument_list|()
expr_stmt|;
if|if
condition|(
operator|!
name|strncmp
argument_list|(
literal|"cuaa"
argument_list|,
name|dev
operator|->
name|name
argument_list|,
literal|4
argument_list|)
condition|)
block|{
if|if
condition|(
operator|!
name|msgYesNo
argument_list|(
literal|"You have selected a serial-line network interface.\nDo you want to use PPP with it?"
argument_list|)
condition|)
block|{
if|if
condition|(
operator|!
name|startPPP
argument_list|(
name|dev
argument_list|)
condition|)
block|{
name|msgConfirm
argument_list|(
literal|"Unable to start PPP!  This installation method\ncannot be used."
argument_list|)
expr_stmt|;
return|return
name|FALSE
return|;
block|}
name|networkInitialized
operator|=
name|TRUE
expr_stmt|;
return|return
name|TRUE
return|;
block|}
else|else
block|{
name|char
modifier|*
name|val
decl_stmt|;
name|char
name|attach
index|[
literal|256
index|]
decl_stmt|;
comment|/* Cheesy slip attach */
name|snprintf
argument_list|(
name|attach
argument_list|,
literal|256
argument_list|,
literal|"slattach -a -h -l -s 9600 %s"
argument_list|,
name|dev
operator|->
name|devname
argument_list|)
expr_stmt|;
name|val
operator|=
name|msgGetInput
argument_list|(
name|attach
argument_list|,
literal|"Warning:  SLIP is rather poorly supported in this revision\nof the installation due to the lack of a dialing utility.\nIf you can use PPP for this instead then you're much better\noff doing so, otherwise SLIP works fairly well for *hardwired*\nlinks.  Please edit the following slattach command for\ncorrectness (default here is VJ compression, Hardware flow-control,\nignore carrier and 9600 baud data rate) and hit return to execute it."
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|val
condition|)
return|return
name|FALSE
return|;
elseif|else
if|if
condition|(
operator|!
name|vsystem
argument_list|(
name|attach
argument_list|)
condition|)
return|return
name|TRUE
return|;
else|else
block|{
name|msgConfirm
argument_list|(
literal|"slattach returned a bad status!  Please verify that\nthe command is correct and try again."
argument_list|)
expr_stmt|;
return|return
name|FALSE
return|;
block|}
block|}
block|}
else|else
block|{
name|char
modifier|*
name|cp
decl_stmt|,
name|ifconfig
index|[
literal|64
index|]
decl_stmt|;
name|snprintf
argument_list|(
name|ifconfig
argument_list|,
literal|64
argument_list|,
literal|"%s%s"
argument_list|,
name|VAR_IFCONFIG
argument_list|,
name|dev
operator|->
name|name
argument_list|)
expr_stmt|;
name|cp
operator|=
name|getenv
argument_list|(
name|ifconfig
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|cp
condition|)
block|{
name|msgConfirm
argument_list|(
literal|"The %s device is not configured.  You will need to do so\nin the Networking configuration menu before proceeding."
argument_list|)
expr_stmt|;
return|return
name|FALSE
return|;
block|}
name|i
operator|=
name|vsystem
argument_list|(
literal|"ifconfig %s %s"
argument_list|,
name|dev
operator|->
name|name
argument_list|,
name|cp
argument_list|)
expr_stmt|;
if|if
condition|(
name|i
condition|)
block|{
name|msgConfirm
argument_list|(
literal|"Unable to configure the %s interface!\nThis installation method cannot be used."
argument_list|,
name|dev
operator|->
name|name
argument_list|)
expr_stmt|;
return|return
name|FALSE
return|;
block|}
block|}
name|rp
operator|=
name|getenv
argument_list|(
name|VAR_GATEWAY
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|rp
condition|)
name|msgConfirm
argument_list|(
literal|"No gateway has been set. You will not be able to access hosts\n not on the local network\n"
argument_list|)
expr_stmt|;
else|else
name|vsystem
argument_list|(
literal|"route add default %s"
argument_list|,
name|rp
argument_list|)
expr_stmt|;
name|networkInitialized
operator|=
name|TRUE
expr_stmt|;
return|return
name|TRUE
return|;
block|}
end_function

begin_function
name|void
name|mediaShutdownNetwork
parameter_list|(
name|Device
modifier|*
name|dev
parameter_list|)
block|{
name|char
modifier|*
name|cp
decl_stmt|;
if|if
condition|(
operator|!
name|networkInitialized
condition|)
return|return;
comment|/* If we're running PPP or SLIP, it's too much trouble to shut down so forget it */
if|if
condition|(
name|strncmp
argument_list|(
literal|"cuaa"
argument_list|,
name|dev
operator|->
name|name
argument_list|,
literal|4
argument_list|)
condition|)
block|{
name|int
name|i
decl_stmt|;
name|char
name|ifconfig
index|[
literal|64
index|]
decl_stmt|;
name|snprintf
argument_list|(
name|ifconfig
argument_list|,
literal|64
argument_list|,
literal|"%s%s"
argument_list|,
name|VAR_IFCONFIG
argument_list|,
name|dev
operator|->
name|name
argument_list|)
expr_stmt|;
name|cp
operator|=
name|getenv
argument_list|(
name|ifconfig
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|cp
condition|)
return|return;
name|i
operator|=
name|vsystem
argument_list|(
literal|"ifconfig %s down"
argument_list|,
name|dev
operator|->
name|name
argument_list|)
expr_stmt|;
if|if
condition|(
name|i
condition|)
name|msgConfirm
argument_list|(
literal|"Warning: Unable to down the %s interface properly"
argument_list|,
name|dev
operator|->
name|name
argument_list|)
expr_stmt|;
name|cp
operator|=
name|getenv
argument_list|(
name|VAR_GATEWAY
argument_list|)
expr_stmt|;
if|if
condition|(
name|cp
condition|)
name|vsystem
argument_list|(
literal|"route delete default"
argument_list|)
expr_stmt|;
name|networkInitialized
operator|=
name|FALSE
expr_stmt|;
block|}
block|}
end_function

begin_function
name|int
name|configRoutedFlags
parameter_list|(
name|char
modifier|*
name|str
parameter_list|)
block|{
name|char
modifier|*
name|val
decl_stmt|;
name|val
operator|=
name|msgGetInput
argument_list|(
literal|"-q"
argument_list|,
literal|"Specify the flags for routed; -q is the default, -s is\na good choice for gateway machines."
argument_list|)
expr_stmt|;
if|if
condition|(
name|val
condition|)
name|variable_set2
argument_list|(
literal|"routedflags"
argument_list|,
name|val
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/* Start PPP on the 3rd screen */
end_comment

begin_function
specifier|static
name|Boolean
name|startPPP
parameter_list|(
name|Device
modifier|*
name|devp
parameter_list|)
block|{
name|int
name|fd
decl_stmt|,
name|fd2
decl_stmt|;
name|FILE
modifier|*
name|fp
decl_stmt|;
name|char
modifier|*
name|val
decl_stmt|;
name|char
name|myaddr
index|[
literal|16
index|]
decl_stmt|,
name|provider
index|[
literal|16
index|]
decl_stmt|,
name|netmask
index|[
literal|16
index|]
decl_stmt|;
name|fd
operator|=
name|open
argument_list|(
literal|"/dev/ttyv2"
argument_list|,
name|O_RDWR
argument_list|)
expr_stmt|;
if|if
condition|(
name|fd
operator|==
operator|-
literal|1
condition|)
return|return
name|FALSE
return|;
name|Mkdir
argument_list|(
literal|"/var/log"
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|Mkdir
argument_list|(
literal|"/var/spool/lock"
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|Mkdir
argument_list|(
literal|"/etc/ppp"
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|fd2
operator|=
name|open
argument_list|(
literal|"/etc/ppp/ppp.linkup"
argument_list|,
name|O_CREAT
argument_list|)
expr_stmt|;
if|if
condition|(
name|fd2
operator|!=
operator|-
literal|1
condition|)
block|{
name|fchmod
argument_list|(
name|fd2
argument_list|,
literal|0755
argument_list|)
expr_stmt|;
name|close
argument_list|(
name|fd2
argument_list|)
expr_stmt|;
block|}
name|fd2
operator|=
name|open
argument_list|(
literal|"/etc/ppp/ppp.secret"
argument_list|,
name|O_CREAT
argument_list|)
expr_stmt|;
if|if
condition|(
name|fd2
operator|!=
operator|-
literal|1
condition|)
block|{
name|fchmod
argument_list|(
name|fd2
argument_list|,
literal|0755
argument_list|)
expr_stmt|;
name|close
argument_list|(
name|fd2
argument_list|)
expr_stmt|;
block|}
name|fp
operator|=
name|fopen
argument_list|(
literal|"/etc/ppp/ppp.conf"
argument_list|,
literal|"w"
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|fp
condition|)
block|{
name|msgConfirm
argument_list|(
literal|"Couldn't open /etc/ppp/ppp.conf file!  This isn't going to work"
argument_list|)
expr_stmt|;
return|return
name|FALSE
return|;
block|}
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"default:\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|" set device %s\n"
argument_list|,
name|devp
operator|->
name|devname
argument_list|)
expr_stmt|;
name|val
operator|=
name|msgGetInput
argument_list|(
literal|"115200"
argument_list|,
literal|"Enter the baud rate for your modem - this can be higher than the actual\nmaximum data rate since most modems can talk at one speed to the\ncomputer and at another speed to the remote end.\n\nIf you're not sure what to put here, just select the default."
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|val
condition|)
name|val
operator|=
literal|"115200"
expr_stmt|;
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|" set speed %s\n"
argument_list|,
name|val
argument_list|)
expr_stmt|;
name|strcpy
argument_list|(
name|provider
argument_list|,
name|getenv
argument_list|(
name|VAR_GATEWAY
argument_list|)
condition|?
name|getenv
argument_list|(
name|VAR_GATEWAY
argument_list|)
else|:
literal|"0"
argument_list|)
expr_stmt|;
name|val
operator|=
name|msgGetInput
argument_list|(
name|provider
argument_list|,
literal|"Enter the IP address of your service provider or 0 if you\ndon't know it and would prefer to negotiate it dynamically."
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|val
condition|)
name|val
operator|=
literal|"0"
expr_stmt|;
if|if
condition|(
name|devp
operator|->
name|private
operator|&&
operator|(
operator|(
name|DevInfo
operator|*
operator|)
name|devp
operator|->
name|private
operator|)
operator|->
name|ipaddr
index|[
literal|0
index|]
condition|)
name|strcpy
argument_list|(
name|myaddr
argument_list|,
operator|(
operator|(
name|DevInfo
operator|*
operator|)
name|devp
operator|->
name|private
operator|)
operator|->
name|ipaddr
argument_list|)
expr_stmt|;
else|else
name|strcpy
argument_list|(
name|myaddr
argument_list|,
literal|"0"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|" set ifaddr %s %s\n"
argument_list|,
name|myaddr
argument_list|,
name|val
argument_list|)
expr_stmt|;
name|strcpy
argument_list|(
name|netmask
argument_list|,
name|getenv
argument_list|(
literal|"netmask"
argument_list|)
condition|?
name|getenv
argument_list|(
literal|"netmask"
argument_list|)
else|:
literal|"0xffffffff"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"add 0 %s %s\n"
argument_list|,
name|netmask
argument_list|,
name|provider
argument_list|)
expr_stmt|;
name|fclose
argument_list|(
name|fp
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|fork
argument_list|()
condition|)
block|{
name|dup2
argument_list|(
name|fd
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|dup2
argument_list|(
name|fd
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|dup2
argument_list|(
name|fd
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|execl
argument_list|(
literal|"/stand/ppp"
argument_list|,
literal|"/stand/ppp"
argument_list|,
operator|(
name|char
operator|*
operator|)
name|NULL
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
name|msgConfirm
argument_list|(
literal|"The PPP command is now started on screen 3 (type ALT-F3 to\ninteract with it, ALT-F1 to switch back here). The only command\nyou'll probably want or need to use is the \"term\" command\nwhich starts a terminal emulator you can use to talk to your\nmodem and dial the service provider.  Once you're connected,\ncome back to this screen and press return.  DO NOT PRESS RETURN\nHERE UNTIL THE CONNECTION IS FULLY ESTABLISHED!"
argument_list|)
expr_stmt|;
return|return
name|TRUE
return|;
block|}
end_function

end_unit


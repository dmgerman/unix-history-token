begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * PC-card support for sysinstall  *  * $Id$  *  * Copyright (c) 1997-1999  *	Tatsumi Hosokawa<hosokawa@jp.FreeBSD.org>.  All rights reserved.  *  * This software may be used, modified, copied, and distributed, in  * both source and binary form provided that the above copyright and  * these terms are retained. Under no circumstances is the author  * responsible for the proper functioning of this software, nor does  * the author assume any responsibility for damages incurred with its  * use.  */
end_comment

begin_include
include|#
directive|include
file|"sysinstall.h"
end_include

begin_include
include|#
directive|include
file|"pccard_conf.h"
end_include

begin_include
include|#
directive|include
file|<sys/fcntl.h>
end_include

begin_include
include|#
directive|include
file|<sys/time.h>
end_include

begin_include
include|#
directive|include
file|<pccard/cardinfo.h>
end_include

begin_ifdef
ifdef|#
directive|ifdef
name|PCCARD
end_ifdef

begin_decl_stmt
name|int
name|pccard_mode
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|DMenu
name|MenuPCICMem
init|=
block|{
name|DMENU_NORMAL_TYPE
operator||
name|DMENU_SELECTION_RETURNS
block|,
literal|"Please select free address area used by PC-card controller"
block|,
literal|"PC-card controller uses memory area to get card information.\n"
literal|"Please specify an address that is not used by other devices.\n"
literal|"If you're uncertain of detailed specification of your hardware,\n"
literal|"leave it untouched (default == 0xd0000)."
block|,
literal|"Press F1 for more HELP"
block|,
literal|"pccard"
block|,
block|{
block|{
literal|"Default"
block|,
literal|"I/O address 0xd0000 - 0xd3fff"
block|,
name|NULL
block|,
name|dmenuSetVariable
block|,
name|NULL
block|,
literal|"_pcicmem=0"
block|}
block|,
block|{
literal|"D4"
block|,
literal|"I/O address 0xd4000 - 0xd7fff"
block|,
name|NULL
block|,
name|dmenuSetVariable
block|,
name|NULL
block|,
literal|"_pcicmem=1"
block|}
block|,
block|{
literal|"D8"
block|,
literal|"I/O address 0xd8000 - 0xdbfff"
block|,
name|NULL
block|,
name|dmenuSetVariable
block|,
name|NULL
block|,
literal|"_pcicmem=2"
block|}
block|,
block|{
literal|"DC"
block|,
literal|"I/O address 0xdc000 - 0xdffff"
block|,
name|NULL
block|,
name|dmenuSetVariable
block|,
name|NULL
block|,
literal|"_pcicmem=3"
block|}
block|,
block|{
name|NULL
block|}
block|}
block|, }
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|DMenu
name|MenuCardIRQ
init|=
block|{
name|DMENU_NORMAL_TYPE
operator||
name|DMENU_SELECTION_RETURNS
block|,
literal|"Please select IRQs that can be used by PC-cards"
block|,
literal|"Please specify an IRQs that CANNOT be used by PC-card.\n"
literal|"For example, if you have a sound card that can't be probed by\n"
literal|"this installation floppy and it uses IRQ 10, you have to \n"
literal|"choose \"Option 1\" or \"Option 2\" at this menu.\n"
block|,
literal|"Press F1 for more HELP"
block|,
literal|"pccard"
block|,
block|{
block|{
literal|"Default"
block|,
literal|"IRQ 10, 11"
block|,
name|NULL
block|,
name|dmenuSetVariable
block|,
name|NULL
block|,
literal|"_cardirq=0"
block|}
block|,
block|{
literal|"Option 1"
block|,
literal|"IRQ 5, 11 (ex. soundcard on IRQ 10)"
block|,
name|NULL
block|,
name|dmenuSetVariable
block|,
name|NULL
block|,
literal|"_cardirq=1"
block|}
block|,
block|{
literal|"Option 2"
block|,
literal|"IRQ 11 (ex. something on IRQ 5 and 10)"
block|,
name|NULL
block|,
name|dmenuSetVariable
block|,
name|NULL
block|,
literal|"_cardirq=2"
block|}
block|,
block|{
name|NULL
block|}
block|}
block|, }
decl_stmt|;
end_decl_stmt

begin_function
name|void
name|pccardInitialize
parameter_list|(
name|void
parameter_list|)
block|{
name|int
name|fd
decl_stmt|;
name|int
name|t
decl_stmt|;
name|int
name|pcic_mem
init|=
literal|0xd0000
decl_stmt|;
name|char
name|card_device
index|[
literal|16
index|]
decl_stmt|;
name|char
modifier|*
name|card_irq
init|=
literal|""
decl_stmt|;
name|char
modifier|*
name|spcic_mem
decl_stmt|;
name|char
modifier|*
name|scard_irq
decl_stmt|;
name|char
name|pccardd_flags
index|[
literal|128
index|]
decl_stmt|;
name|char
name|pccardd_cmd
index|[
literal|256
index|]
decl_stmt|;
name|pccard_mode
operator|=
literal|1
expr_stmt|;
if|if
condition|(
operator|!
name|RunningAsInit
operator|&&
operator|!
name|Fake
condition|)
block|{
comment|/* It's not my job... */
return|return;
block|}
name|dmenuOpenSimple
argument_list|(
operator|&
name|MenuPCICMem
argument_list|,
name|FALSE
argument_list|)
expr_stmt|;
name|spcic_mem
operator|=
name|variable_get
argument_list|(
literal|"_pcicmem"
argument_list|)
expr_stmt|;
name|dmenuOpenSimple
argument_list|(
operator|&
name|MenuCardIRQ
argument_list|,
name|FALSE
argument_list|)
expr_stmt|;
name|scard_irq
operator|=
name|variable_get
argument_list|(
literal|"_cardirq"
argument_list|)
expr_stmt|;
name|sscanf
argument_list|(
name|spcic_mem
argument_list|,
literal|"%d"
argument_list|,
operator|&
name|t
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|t
condition|)
block|{
case|case
literal|0
case|:
name|pcic_mem
operator|=
literal|0xd0000
expr_stmt|;
name|variable_set2
argument_list|(
literal|"pccard_mem"
argument_list|,
literal|"DEFAULT"
argument_list|,
literal|1
argument_list|)
expr_stmt|;
break|break;
case|case
literal|1
case|:
name|pcic_mem
operator|=
literal|0xd4000
expr_stmt|;
name|variable_set2
argument_list|(
literal|"pccard_mem"
argument_list|,
literal|"0xd4000"
argument_list|,
literal|1
argument_list|)
expr_stmt|;
break|break;
case|case
literal|2
case|:
name|pcic_mem
operator|=
literal|0xd8000
expr_stmt|;
name|variable_set2
argument_list|(
literal|"pccard_mem"
argument_list|,
literal|"0xd8000"
argument_list|,
literal|1
argument_list|)
expr_stmt|;
break|break;
case|case
literal|3
case|:
name|pcic_mem
operator|=
literal|0xdc000
expr_stmt|;
name|variable_set2
argument_list|(
literal|"pccard_mem"
argument_list|,
literal|"0xdc000"
argument_list|,
literal|1
argument_list|)
expr_stmt|;
break|break;
block|}
name|sscanf
argument_list|(
name|scard_irq
argument_list|,
literal|"%d"
argument_list|,
operator|&
name|t
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|t
condition|)
block|{
case|case
literal|0
case|:
name|card_irq
operator|=
literal|"-i 10 -i 11"
expr_stmt|;
break|break;
case|case
literal|1
case|:
name|card_irq
operator|=
literal|"-i 5 -i 11"
expr_stmt|;
break|break;
case|case
literal|2
case|:
name|card_irq
operator|=
literal|"-i 11"
expr_stmt|;
break|break;
block|}
name|sprintf
argument_list|(
name|card_device
argument_list|,
name|CARD_DEVICE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|dialog_clear
argument_list|()
expr_stmt|;
name|msgConfirm
argument_list|(
literal|"Now starts initializing PC-card controller and cards.\n"
literal|"If you've executed this installer from PC-card floppy\n"
literal|"drive, this is the last chance to replace it with\n"
literal|"installation media (PC-card Ethernet, CDROM, etc.).\n"
literal|"Please insert installation media and press [Enter].\n"
literal|"If you've not plugged the PC-card installation media\n"
literal|"yet, please plug it now and press [Enter].\n"
literal|"Otherwise, just press [Enter] to proceed."
argument_list|)
expr_stmt|;
name|dialog_clear
argument_list|()
expr_stmt|;
name|msgNotify
argument_list|(
literal|"Initializing PC-card controller...."
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|Fake
condition|)
block|{
if|if
condition|(
operator|(
name|fd
operator|=
name|open
argument_list|(
name|card_device
argument_list|,
name|O_RDWR
argument_list|)
operator|)
operator|<
literal|1
condition|)
block|{
name|msgNotify
argument_list|(
literal|"Can't open PC-card controller %s.\n"
argument_list|,
name|card_device
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|ioctl
argument_list|(
name|fd
argument_list|,
name|PIOCRWMEM
argument_list|,
operator|&
name|pcic_mem
argument_list|)
operator|<
literal|0
condition|)
block|{
name|msgNotify
argument_list|(
literal|"ioctl %s failed.\n"
argument_list|,
name|card_device
argument_list|)
expr_stmt|;
return|return;
block|}
block|}
name|strcpy
argument_list|(
name|pccardd_cmd
argument_list|,
literal|"/stand/pccardd "
argument_list|)
expr_stmt|;
name|strcat
argument_list|(
name|pccardd_cmd
argument_list|,
name|card_irq
argument_list|)
expr_stmt|;
name|strcat
argument_list|(
name|pccardd_cmd
argument_list|,
literal|" -z"
argument_list|)
expr_stmt|;
name|strcpy
argument_list|(
name|pccardd_flags
argument_list|,
name|card_irq
argument_list|)
expr_stmt|;
name|variable_set2
argument_list|(
literal|"pccardd_flags"
argument_list|,
name|card_irq
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|vsystem
argument_list|(
name|pccardd_cmd
argument_list|)
expr_stmt|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* PCCARD */
end_comment

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * The new sysinstall program.  *  * This is probably the last program in the `sysinstall' line - the next  * generation being essentially a complete rewrite.  *  * $Id: register.c,v 1.1.2.5 1997/03/25 02:45:59 jkh Exp $  *  * Copyright (c) 1997  *	Jordan Hubbard.  All rights reserved.  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions  * are met:  * 1. Redistributions of source code must retain the above copyright  *    notice, this list of conditions and the following disclaimer,  *    verbatim and that no modifications are made prior to this  *    point in the file.  * 2. Redistributions in binary form must reproduce the above copyright  *    notice, this list of conditions and the following disclaimer in the  *    documentation and/or other materials provided with the distribution.  *  * THIS SOFTWARE IS PROVIDED BY JORDAN HUBBARD ``AS IS'' AND  * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE  * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE  * ARE DISCLAIMED.  IN NO EVENT SHALL JORDAN HUBBARD OR HIS PETS BE LIABLE  * FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL  * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS  * OR SERVICES; LOSS OF USE, DATA, LIFE OR PROFITS; OR BUSINESS INTERRUPTION)  * HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT  * LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY  * OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF  * SUCH DAMAGE.  *  */
end_comment

begin_include
include|#
directive|include
file|"sysinstall.h"
end_include

begin_include
include|#
directive|include
file|<ctype.h>
end_include

begin_define
define|#
directive|define
name|REGISTER_HELPFILE
value|"register"
end_define

begin_define
define|#
directive|define
name|REGISTRATION_FNAME
value|"/new-registration"
end_define

begin_define
define|#
directive|define
name|REGISTRATION_ADDRESS
value|"register@freebsd.org"
end_define

begin_define
define|#
directive|define
name|MAJORDOMO_ADDRESS
value|"majordomo@freebsd.org"
end_define

begin_define
define|#
directive|define
name|FIRSTNAME_FIELD_LEN
value|25
end_define

begin_define
define|#
directive|define
name|LASTNAME_FIELD_LEN
value|30
end_define

begin_define
define|#
directive|define
name|EMAIL_FIELD_LEN
value|61
end_define

begin_define
define|#
directive|define
name|ADDRESS_FIELD_LEN
value|160
end_define

begin_define
define|#
directive|define
name|CITY_FIELD_LEN
value|20
end_define

begin_define
define|#
directive|define
name|STATE_FIELD_LEN
value|15
end_define

begin_define
define|#
directive|define
name|ZIP_FIELD_LEN
value|15
end_define

begin_decl_stmt
specifier|static
name|char
name|firstname
index|[
name|FIRSTNAME_FIELD_LEN
index|]
decl_stmt|,
name|lastname
index|[
name|LASTNAME_FIELD_LEN
index|]
decl_stmt|,
name|email
index|[
name|EMAIL_FIELD_LEN
index|]
decl_stmt|,
name|address
index|[
name|ADDRESS_FIELD_LEN
index|]
decl_stmt|,
name|city
index|[
name|CITY_FIELD_LEN
index|]
decl_stmt|,
name|state
index|[
name|STATE_FIELD_LEN
index|]
decl_stmt|,
name|zip
index|[
name|ZIP_FIELD_LEN
index|]
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|okbutton
decl_stmt|,
name|cancelbutton
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* What the screen size is meant to be */
end_comment

begin_define
define|#
directive|define
name|REGISTER_DIALOG_Y
value|0
end_define

begin_define
define|#
directive|define
name|REGISTER_DIALOG_X
value|2
end_define

begin_define
define|#
directive|define
name|REGISTER_DIALOG_WIDTH
value|COLS - 4
end_define

begin_define
define|#
directive|define
name|REGISTER_DIALOG_HEIGHT
value|LINES - 2
end_define

begin_decl_stmt
specifier|static
name|Layout
name|layout
index|[]
init|=
block|{
define|#
directive|define
name|LAYOUT_LASTNAME
value|0
block|{
literal|1
block|,
literal|2
block|,
name|LASTNAME_FIELD_LEN
operator|-
literal|1
block|,
name|LASTNAME_FIELD_LEN
operator|-
literal|1
block|,
literal|"Last Name:"
block|,
literal|"Your surname (family name) or company name should go here."
block|,
name|lastname
block|,
name|STRINGOBJ
block|,
name|NULL
block|}
block|,
define|#
directive|define
name|LAYOUT_FIRSTNAME
value|1
block|{
literal|1
block|,
literal|36
block|,
name|FIRSTNAME_FIELD_LEN
operator|-
literal|1
block|,
name|FIRSTNAME_FIELD_LEN
operator|-
literal|1
block|,
literal|"First Name:"
block|,
literal|"Your given name or a contact name if registering for a company."
block|,
name|firstname
block|,
name|STRINGOBJ
block|,
name|NULL
block|}
block|,
define|#
directive|define
name|LAYOUT_EMAIL
value|2
block|{
literal|6
block|,
literal|2
block|,
name|EMAIL_FIELD_LEN
operator|-
literal|1
block|,
name|EMAIL_FIELD_LEN
operator|-
literal|1
block|,
literal|"EMail Address:"
block|,
literal|"Where you'd like any announcement email sent, e.g. bsdmail@someplace.com"
block|,
name|email
block|,
name|STRINGOBJ
block|,
name|NULL
block|}
block|,
define|#
directive|define
name|LAYOUT_ADDRESS
value|3
block|{
literal|10
block|,
literal|2
block|,
literal|60
block|,
name|ADDRESS_FIELD_LEN
operator|-
literal|1
block|,
literal|"Street address:"
block|,
literal|"Your street address, all in one line (optional)."
block|,
name|address
block|,
name|STRINGOBJ
block|,
name|NULL
block|}
block|,
define|#
directive|define
name|LAYOUT_CITY
value|4
block|{
literal|14
block|,
literal|2
block|,
name|CITY_FIELD_LEN
operator|-
literal|1
block|,
name|CITY_FIELD_LEN
operator|-
literal|1
block|,
literal|"City:"
block|,
literal|"Your city name (optional)"
block|,
name|city
block|,
name|STRINGOBJ
block|,
name|NULL
block|}
block|,
define|#
directive|define
name|LAYOUT_STATE
value|5
block|{
literal|14
block|,
literal|26
block|,
name|STATE_FIELD_LEN
operator|-
literal|1
block|,
name|STATE_FIELD_LEN
operator|-
literal|1
block|,
literal|"State / Province:"
block|,
literal|"Your local state or province."
block|,
name|state
block|,
name|STRINGOBJ
block|,
name|NULL
block|}
block|,
define|#
directive|define
name|LAYOUT_ZIP
value|5
block|{
literal|14
block|,
literal|50
block|,
name|ZIP_FIELD_LEN
operator|-
literal|1
block|,
name|ZIP_FIELD_LEN
operator|-
literal|1
block|,
literal|"Zip / Country Code:"
block|,
literal|"Your U.S. Zip code or International country code (optional)."
block|,
name|zip
block|,
name|STRINGOBJ
block|,
name|NULL
block|}
block|,
define|#
directive|define
name|LAYOUT_OKBUTTON
value|7
block|{
literal|18
block|,
literal|20
block|,
literal|0
block|,
literal|0
block|,
literal|"OK"
block|,
literal|"Select this if you are happy with these settings"
block|,
operator|&
name|okbutton
block|,
name|BUTTONOBJ
block|,
name|NULL
block|}
block|,
define|#
directive|define
name|LAYOUT_CANCELBUTTON
value|8
block|{
literal|18
block|,
literal|40
block|,
literal|0
block|,
literal|0
block|,
literal|"CANCEL"
block|,
literal|"Select this if you wish to cancel this registration"
block|,
operator|&
name|cancelbutton
block|,
name|BUTTONOBJ
block|,
name|NULL
block|}
block|,
block|{
name|NULL
block|}
block|, }
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* Submenu selections */
end_comment

begin_define
define|#
directive|define
name|COMMERCE_MAIL
value|0
end_define

begin_define
define|#
directive|define
name|COMMERCE_EMAIL
value|1
end_define

begin_define
define|#
directive|define
name|ANNOUNCE_LIST
value|2
end_define

begin_define
define|#
directive|define
name|NEWSLETTER
value|3
end_define

begin_struct
specifier|static
struct|struct
block|{
name|int
name|y
decl_stmt|,
name|x
decl_stmt|,
name|sel
decl_stmt|;
name|char
modifier|*
name|desc
decl_stmt|,
modifier|*
name|allowed
decl_stmt|;
block|}
name|hotspots
index|[]
init|=
block|{
block|{
literal|5
block|,
literal|35
block|,
literal|0
block|,
literal|"Do you wish to receive FreeBSD [ONLY!] related commercial mail?"
block|,
literal|"Y"
block|}
block|,
block|{
literal|5
block|,
literal|57
block|,
literal|0
block|,
literal|"Do you wish to receive FreeBSD [ONLY!] related commercial email?"
block|,
literal|"Y"
block|}
block|,
block|{
literal|6
block|,
literal|35
block|,
literal|0
block|,
literal|"Sign up (with majordomo@FreeBSD.org) for important announcements?"
block|,
literal|"Y"
block|}
block|,
block|{
literal|10
block|,
literal|35
block|,
literal|0
block|,
literal|"Sign up for the FreeBSD Newsletter?  P = Postal (paper) copy, E = Email"
block|,
literal|"PE"
block|}
block|, }
struct|;
end_struct

begin_comment
comment|/* Check the accuracy of user's choices before letting them move on */
end_comment

begin_function
specifier|static
name|int
name|verifySettings
parameter_list|(
name|void
parameter_list|)
block|{
if|if
condition|(
operator|!
name|lastname
index|[
literal|0
index|]
condition|)
block|{
name|msgConfirm
argument_list|(
literal|"Missing last name / company name field."
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
elseif|else
if|if
condition|(
name|email
index|[
literal|0
index|]
operator|&&
operator|!
name|index
argument_list|(
name|email
argument_list|,
literal|'@'
argument_list|)
condition|)
return|return
operator|!
name|msgYesNo
argument_list|(
literal|"Hmmmm, this email address has no `@' in it.  Are you\n"
literal|"sure that %s is a valid address?"
argument_list|)
return|;
elseif|else
if|if
condition|(
name|address
index|[
literal|0
index|]
operator|&&
operator|!
name|city
index|[
literal|0
index|]
condition|)
block|{
name|msgConfirm
argument_list|(
literal|"Missing City name."
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
elseif|else
if|if
condition|(
operator|!
name|email
index|[
literal|0
index|]
operator|&&
operator|(
name|hotspots
index|[
name|COMMERCE_EMAIL
index|]
operator|.
name|sel
operator|||
name|hotspots
index|[
name|NEWSLETTER
index|]
operator|.
name|sel
operator|==
literal|2
operator|)
condition|)
block|{
name|msgConfirm
argument_list|(
literal|"You've signed up to receive commercial email or the newsletter by\n"
literal|"email but have no email address specified!"
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
elseif|else
if|if
condition|(
operator|!
name|address
index|[
literal|0
index|]
operator|&&
operator|(
name|hotspots
index|[
name|COMMERCE_MAIL
index|]
operator|.
name|sel
operator|||
name|hotspots
index|[
name|NEWSLETTER
index|]
operator|.
name|sel
operator|==
literal|1
operator|)
condition|)
block|{
name|msgConfirm
argument_list|(
literal|"You've signed up to receive commercial mail or the newsletter by\n"
literal|"post but have no postal address specified!"
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
return|return
literal|1
return|;
block|}
end_function

begin_comment
comment|/* Do the actual work of mailing out the registration once all is filled in */
end_comment

begin_function
specifier|static
name|void
name|handle_registration
parameter_list|(
name|void
parameter_list|)
block|{
name|FILE
modifier|*
name|fp
decl_stmt|;
name|WINDOW
modifier|*
name|save
init|=
name|savescr
argument_list|()
decl_stmt|;
name|dialog_clear_norefresh
argument_list|()
expr_stmt|;
operator|(
name|void
operator|)
name|unlink
argument_list|(
name|REGISTRATION_FNAME
argument_list|)
expr_stmt|;
name|fp
operator|=
name|fopen
argument_list|(
name|REGISTRATION_FNAME
argument_list|,
literal|"w"
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|fp
condition|)
block|{
name|msgConfirm
argument_list|(
literal|"Unable to open %s for the new registration.\n"
literal|"That's pretty bad!  Please fix whatever's wrong\n"
literal|"and try this registration again."
argument_list|)
expr_stmt|;
name|restorescr
argument_list|(
name|save
argument_list|)
expr_stmt|;
return|return;
block|}
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"<entry>\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"<first>%s</first>\n"
argument_list|,
name|firstname
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"<last>%s</last>\n"
argument_list|,
name|lastname
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"<email>%s</email>\n"
argument_list|,
name|email
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"<address>%s</address>\n"
argument_list|,
name|address
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"<city>%s</city>\n"
argument_list|,
name|city
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"<state>%s</state>\n"
argument_list|,
name|state
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"<zip>%s</zip>\n"
argument_list|,
name|zip
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"<options commerce_email=\"%s\" commerce_mail=\"%s\" announce=\"%s\" newsletter=\"%s\"></options>\n"
argument_list|,
name|hotspots
index|[
name|COMMERCE_EMAIL
index|]
operator|.
name|sel
condition|?
literal|"yes"
else|:
literal|"no"
argument_list|,
name|hotspots
index|[
name|COMMERCE_MAIL
index|]
operator|.
name|sel
condition|?
literal|"yes"
else|:
literal|"no"
argument_list|,
name|hotspots
index|[
name|ANNOUNCE_LIST
index|]
operator|.
name|sel
condition|?
literal|"yes"
else|:
literal|"no"
argument_list|,
name|hotspots
index|[
name|NEWSLETTER
index|]
operator|.
name|sel
operator|==
literal|0
condition|?
literal|"no"
else|:
name|hotspots
index|[
name|NEWSLETTER
index|]
operator|.
name|sel
operator|==
literal|1
condition|?
literal|"postal"
else|:
literal|"email"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"<version>%s</version>\n"
argument_list|,
name|RELEASE_NAME
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"</entry>\n"
argument_list|)
expr_stmt|;
name|fclose
argument_list|(
name|fp
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|msgYesNo
argument_list|(
literal|"Do you have a working network connection and outgoing email\n"
literal|"enabled at this time?  I need to be able to reach freebsd.org\n"
literal|"in order to submit your registration."
argument_list|)
condition|)
block|{
name|dialog_clear_norefresh
argument_list|()
expr_stmt|;
if|if
condition|(
operator|!
name|vsystem
argument_list|(
literal|"mail %s< %s"
argument_list|,
name|REGISTRATION_ADDRESS
argument_list|,
name|REGISTRATION_FNAME
argument_list|)
condition|)
block|{
name|msgConfirm
argument_list|(
literal|"Thank you!  Your registration has been sent in successfully.\n"
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|unlink
argument_list|(
name|REGISTRATION_FNAME
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|msgConfirm
argument_list|(
literal|"Argh!  The mail program returned a bad status - there\n"
literal|"must be something still not quite configured correctly.\n"
literal|"leaving the registration in: %s\n"
literal|"When you're connected to the net and ready to send it,\n"
literal|"simply type:  mail %s< %s\n"
argument_list|,
name|REGISTRATION_ADDRESS
argument_list|,
name|REGISTRATION_FNAME
argument_list|,
name|REGISTRATION_FNAME
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|hotspots
index|[
name|ANNOUNCE_LIST
index|]
operator|.
name|sel
condition|)
block|{
name|char
modifier|*
name|cp
decl_stmt|;
name|dialog_clear_norefresh
argument_list|()
expr_stmt|;
name|cp
operator|=
name|msgGetInput
argument_list|(
name|email
argument_list|,
literal|"What email address would you like to subscribe under?\n"
literal|"This is a fairly low-traffic mailing list and only generates\n"
literal|"around 5 messages a month, so it's also safe to receive at your\n"
literal|"standard email address."
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|cp
condition|)
name|msgConfirm
argument_list|(
literal|"OK, I won't subscribe to announce at this time.  To do it manually\n"
literal|"yourself, simply send mail to %s."
argument_list|,
name|MAJORDOMO_ADDRESS
argument_list|)
expr_stmt|;
else|else
block|{
name|dialog_clear_norefresh
argument_list|()
expr_stmt|;
if|if
condition|(
operator|!
name|vsystem
argument_list|(
literal|"echo subscribe freebsd-announce %s | mail %s"
argument_list|,
name|email
argument_list|,
name|MAJORDOMO_ADDRESS
argument_list|)
condition|)
name|msgConfirm
argument_list|(
literal|"Your request to join the announce mailing list has been sent.\n"
literal|"you should receive notification back in 24 hours or less, otherwise\n"
literal|"something has gone wrong and you should try this again by sending\n"
literal|"a message to %s which contains the line:\n\n"
literal|"subscribe freebsd-announce %s\n"
argument_list|,
name|MAJORDOMO_ADDRESS
argument_list|,
name|email
argument_list|)
expr_stmt|;
else|else
name|msgConfirm
argument_list|(
literal|"Argh!  The mail program returned a bad status - there\n"
literal|"must be something still not quite configured correctly.\n"
literal|"Please fix this then try again by sending a message to\n"
literal|"to %s which contains the line:\n\n"
literal|"subscribe freebsd-announce %s\n"
argument_list|,
name|MAJORDOMO_ADDRESS
argument_list|,
name|email
argument_list|)
expr_stmt|;
block|}
block|}
block|}
else|else
block|{
name|dialog_clear_norefresh
argument_list|()
expr_stmt|;
name|msgConfirm
argument_list|(
literal|"OK, your registration has been left in the file %s\n"
literal|"When you're connected to the net and ready to send it,\n"
literal|"simply type:  mail %s< %s\n"
argument_list|,
name|REGISTRATION_FNAME
argument_list|,
name|REGISTRATION_ADDRESS
argument_list|,
name|REGISTRATION_FNAME
argument_list|)
expr_stmt|;
block|}
name|restorescr
argument_list|(
name|save
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* Put up a subdialog for the registration options */
end_comment

begin_function
specifier|static
name|void
name|subdialog
parameter_list|(
name|WINDOW
modifier|*
name|win
parameter_list|)
block|{
name|int
name|i
decl_stmt|,
name|j
decl_stmt|,
name|attrs
decl_stmt|;
name|char
name|help_line
index|[
literal|80
index|]
decl_stmt|;
name|attrs
operator|=
name|getattrs
argument_list|(
name|win
argument_list|)
expr_stmt|;
name|mvwaddstr
argument_list|(
name|win
argument_list|,
name|hotspots
index|[
name|COMMERCE_MAIL
index|]
operator|.
name|y
argument_list|,
name|hotspots
index|[
name|COMMERCE_MAIL
index|]
operator|.
name|x
operator|-
literal|1
argument_list|,
literal|"[ ] Postal Adverts"
argument_list|)
expr_stmt|;
name|mvwaddstr
argument_list|(
name|win
argument_list|,
name|hotspots
index|[
name|COMMERCE_EMAIL
index|]
operator|.
name|y
argument_list|,
name|hotspots
index|[
name|COMMERCE_EMAIL
index|]
operator|.
name|x
operator|-
literal|1
argument_list|,
literal|"[ ] Email Adverts"
argument_list|)
expr_stmt|;
name|mvwaddstr
argument_list|(
name|win
argument_list|,
name|hotspots
index|[
name|ANNOUNCE_LIST
index|]
operator|.
name|y
argument_list|,
name|hotspots
index|[
name|ANNOUNCE_LIST
index|]
operator|.
name|x
operator|-
literal|1
argument_list|,
literal|"[ ] The announce@FreeBSD.ORG mailing list."
argument_list|)
expr_stmt|;
name|mvwaddstr
argument_list|(
name|win
argument_list|,
name|hotspots
index|[
name|NEWSLETTER
index|]
operator|.
name|y
argument_list|,
name|hotspots
index|[
name|NEWSLETTER
index|]
operator|.
name|x
operator|-
literal|1
argument_list|,
literal|"[ ] The FreeBSD Newsletter."
argument_list|)
expr_stmt|;
comment|/* Tack up the initial values */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
sizeof|sizeof
argument_list|(
name|hotspots
argument_list|)
operator|/
sizeof|sizeof
argument_list|(
name|hotspots
index|[
literal|0
index|]
argument_list|)
condition|;
name|i
operator|++
control|)
block|{
name|wattrset
argument_list|(
name|win
argument_list|,
name|attrs
operator||
name|A_BOLD
argument_list|)
expr_stmt|;
name|mvwaddch
argument_list|(
name|win
argument_list|,
name|hotspots
index|[
name|i
index|]
operator|.
name|y
argument_list|,
name|hotspots
index|[
name|i
index|]
operator|.
name|x
argument_list|,
name|hotspots
index|[
name|i
index|]
operator|.
name|sel
condition|?
name|hotspots
index|[
name|i
index|]
operator|.
name|allowed
index|[
name|hotspots
index|[
name|i
index|]
operator|.
name|sel
operator|-
literal|1
index|]
else|:
literal|'N'
argument_list|)
expr_stmt|;
block|}
name|wattrset
argument_list|(
name|win
argument_list|,
name|attrs
argument_list|)
expr_stmt|;
name|wrefresh
argument_list|(
name|win
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
sizeof|sizeof
argument_list|(
name|hotspots
argument_list|)
operator|/
sizeof|sizeof
argument_list|(
name|hotspots
index|[
literal|0
index|]
argument_list|)
condition|;
control|)
block|{
name|int
name|ch
decl_stmt|,
name|len
init|=
name|strlen
argument_list|(
name|hotspots
index|[
name|i
index|]
operator|.
name|desc
argument_list|)
decl_stmt|;
name|char
modifier|*
name|cp
decl_stmt|;
comment|/* Display the help line at the bottom of the screen */
for|for
control|(
name|j
operator|=
literal|0
init|;
name|j
operator|<
literal|79
condition|;
name|j
operator|++
control|)
name|help_line
index|[
name|j
index|]
operator|=
operator|(
name|j
operator|<
name|len
operator|)
condition|?
name|hotspots
index|[
name|i
index|]
operator|.
name|desc
index|[
name|j
index|]
else|:
literal|' '
expr_stmt|;
name|help_line
index|[
name|j
index|]
operator|=
literal|'\0'
expr_stmt|;
name|use_helpline
argument_list|(
name|help_line
argument_list|)
expr_stmt|;
name|display_helpline
argument_list|(
name|win
argument_list|,
name|LINES
operator|-
literal|1
argument_list|,
name|COLS
operator|-
literal|1
argument_list|)
expr_stmt|;
name|wmove
argument_list|(
name|win
argument_list|,
name|hotspots
index|[
name|i
index|]
operator|.
name|y
argument_list|,
name|hotspots
index|[
name|i
index|]
operator|.
name|x
argument_list|)
expr_stmt|;
name|wrefresh
argument_list|(
name|win
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|ch
operator|=
name|toupper
argument_list|(
name|getch
argument_list|()
argument_list|)
condition|)
block|{
case|case
name|KEY_UP
case|:
if|if
condition|(
name|i
condition|)
name|i
operator|--
expr_stmt|;
continue|continue;
case|case
name|KEY_DOWN
case|:
case|case
literal|'\011'
case|:
comment|/* TAB */
case|case
literal|'\012'
case|:
comment|/* ^J */
case|case
literal|'\014'
case|:
comment|/* ^M */
comment|/* Treat as a no-change op */
operator|++
name|i
expr_stmt|;
break|break;
case|case
literal|'N'
case|:
comment|/* No is generic to all */
name|hotspots
index|[
name|i
index|]
operator|.
name|sel
operator|=
literal|0
expr_stmt|;
name|wattrset
argument_list|(
name|win
argument_list|,
name|attrs
operator||
name|A_BOLD
argument_list|)
expr_stmt|;
name|mvwaddch
argument_list|(
name|win
argument_list|,
name|hotspots
index|[
name|i
index|]
operator|.
name|y
argument_list|,
name|hotspots
index|[
name|i
index|]
operator|.
name|x
argument_list|,
literal|'N'
argument_list|)
expr_stmt|;
name|wattrset
argument_list|(
name|win
argument_list|,
name|attrs
argument_list|)
expr_stmt|;
name|wrefresh
argument_list|(
name|win
argument_list|)
expr_stmt|;
operator|++
name|i
expr_stmt|;
break|break;
default|default:
name|cp
operator|=
name|index
argument_list|(
name|hotspots
index|[
name|i
index|]
operator|.
name|allowed
argument_list|,
name|ch
argument_list|)
expr_stmt|;
if|if
condition|(
name|cp
condition|)
block|{
name|hotspots
index|[
name|i
index|]
operator|.
name|sel
operator|=
operator|(
name|cp
operator|-
name|hotspots
index|[
name|i
index|]
operator|.
name|allowed
operator|)
operator|+
literal|1
expr_stmt|;
name|wattrset
argument_list|(
name|win
argument_list|,
name|attrs
operator||
name|A_BOLD
argument_list|)
expr_stmt|;
name|mvwaddch
argument_list|(
name|win
argument_list|,
name|hotspots
index|[
name|i
index|]
operator|.
name|y
argument_list|,
name|hotspots
index|[
name|i
index|]
operator|.
name|x
argument_list|,
operator|*
name|cp
argument_list|)
expr_stmt|;
name|wattrset
argument_list|(
name|win
argument_list|,
name|attrs
argument_list|)
expr_stmt|;
name|wrefresh
argument_list|(
name|win
argument_list|)
expr_stmt|;
operator|++
name|i
expr_stmt|;
block|}
else|else
name|beep
argument_list|()
expr_stmt|;
break|break;
block|}
block|}
block|}
end_function

begin_comment
comment|/* Register a user */
end_comment

begin_function
name|int
name|registerOpenDialog
parameter_list|(
name|void
parameter_list|)
block|{
name|WINDOW
modifier|*
name|ds_win
decl_stmt|,
modifier|*
name|save
init|=
name|savescr
argument_list|()
decl_stmt|;
name|ComposeObj
modifier|*
name|obj
init|=
name|NULL
decl_stmt|;
name|int
name|n
init|=
literal|0
decl_stmt|,
name|cancel
init|=
name|FALSE
decl_stmt|;
name|int
name|max
decl_stmt|,
name|ret
init|=
name|DITEM_SUCCESS
decl_stmt|;
name|dialog_clear_norefresh
argument_list|()
expr_stmt|;
comment|/* We need a curses window */
if|if
condition|(
operator|!
operator|(
name|ds_win
operator|=
name|openLayoutDialog
argument_list|(
name|REGISTER_HELPFILE
argument_list|,
literal|" FreeBSD Registration Form:  Press F1 for Help / General Info "
argument_list|,
name|REGISTER_DIALOG_X
argument_list|,
name|REGISTER_DIALOG_Y
argument_list|,
name|REGISTER_DIALOG_WIDTH
argument_list|,
name|REGISTER_DIALOG_HEIGHT
argument_list|)
operator|)
condition|)
block|{
name|beep
argument_list|()
expr_stmt|;
name|msgConfirm
argument_list|(
literal|"Cannot open registration dialog window!!"
argument_list|)
expr_stmt|;
name|restorescr
argument_list|(
name|save
argument_list|)
expr_stmt|;
return|return
name|DITEM_FAILURE
return|;
block|}
comment|/* Some more initialisation before we go into the main input loop */
name|obj
operator|=
name|initLayoutDialog
argument_list|(
name|ds_win
argument_list|,
name|layout
argument_list|,
name|REGISTER_DIALOG_X
argument_list|,
name|REGISTER_DIALOG_Y
argument_list|,
operator|&
name|max
argument_list|)
expr_stmt|;
name|reenter
label|:
name|cancelbutton
operator|=
name|okbutton
operator|=
literal|0
expr_stmt|;
while|while
condition|(
name|layoutDialogLoop
argument_list|(
name|ds_win
argument_list|,
name|layout
argument_list|,
operator|&
name|obj
argument_list|,
operator|&
name|n
argument_list|,
name|max
argument_list|,
operator|&
name|cancelbutton
argument_list|,
operator|&
name|cancel
argument_list|)
condition|)
block|{
if|if
condition|(
name|n
operator|==
name|LAYOUT_ADDRESS
condition|)
name|subdialog
argument_list|(
name|ds_win
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|cancel
operator|&&
operator|!
name|verifySettings
argument_list|()
condition|)
goto|goto
name|reenter
goto|;
comment|/* OK, we've got a valid registration, now push it out */
name|handle_registration
argument_list|()
expr_stmt|;
comment|/* Clear this crap off the screen */
name|delwin
argument_list|(
name|ds_win
argument_list|)
expr_stmt|;
name|dialog_clear_norefresh
argument_list|()
expr_stmt|;
name|use_helpfile
argument_list|(
name|NULL
argument_list|)
expr_stmt|;
name|restorescr
argument_list|(
name|save
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

end_unit


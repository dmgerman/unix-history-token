begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * The new sysinstall program.  *  * This is probably the last program in the `sysinstall' line - the next  * generation being essentially a complete rewrite.  *  * $Id: installUpgrade.c,v 1.52 1997/10/01 01:30:35 jkh Exp $  *  * Copyright (c) 1995  *	Jordan Hubbard.  All rights reserved.  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions  * are met:  * 1. Redistributions of source code must retain the above copyright  *    notice, this list of conditions and the following disclaimer,  *    verbatim and that no modifications are made prior to this  *    point in the file.  * 2. Redistributions in binary form must reproduce the above copyright  *    notice, this list of conditions and the following disclaimer in the  *    documentation and/or other materials provided with the distribution.  *  * THIS SOFTWARE IS PROVIDED BY JORDAN HUBBARD ``AS IS'' AND  * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE  * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE  * ARE DISCLAIMED.  IN NO EVENT SHALL JORDAN HUBBARD OR HIS PETS BE LIABLE  * FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL  * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS  * OR SERVICES; LOSS OF USE, DATA, LIFE OR PROFITS; OR BUSINESS INTERRUPTION)  * HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT  * LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY  * OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF  * SUCH DAMAGE.  *  */
end_comment

begin_include
include|#
directive|include
file|"sysinstall.h"
end_include

begin_include
include|#
directive|include
file|<sys/disklabel.h>
end_include

begin_include
include|#
directive|include
file|<sys/errno.h>
end_include

begin_include
include|#
directive|include
file|<sys/ioctl.h>
end_include

begin_include
include|#
directive|include
file|<sys/fcntl.h>
end_include

begin_include
include|#
directive|include
file|<sys/wait.h>
end_include

begin_include
include|#
directive|include
file|<sys/param.h>
end_include

begin_include
include|#
directive|include
file|<sys/stat.h>
end_include

begin_include
include|#
directive|include
file|<unistd.h>
end_include

begin_include
include|#
directive|include
file|<sys/mount.h>
end_include

begin_function_decl
specifier|static
name|int
name|installUpgradeNonInteractive
parameter_list|(
name|dialogMenuItem
modifier|*
name|self
parameter_list|)
function_decl|;
end_function_decl

begin_typedef
typedef|typedef
struct|struct
name|_hitList
block|{
enum|enum
block|{
name|JUST_COPY
block|,
name|CALL_HANDLER
block|}
name|action
enum|;
name|char
modifier|*
name|name
decl_stmt|;
name|Boolean
name|optional
decl_stmt|;
name|void
function_decl|(
modifier|*
name|handler
function_decl|)
parameter_list|(
name|struct
name|_hitList
modifier|*
name|self
parameter_list|)
function_decl|;
block|}
name|HitList
typedef|;
end_typedef

begin_comment
comment|/* These are the only meaningful files I know about */
end_comment

begin_decl_stmt
specifier|static
name|HitList
name|etc_files
index|[]
init|=
block|{
block|{
name|JUST_COPY
block|,
literal|"Xaccel.ini"
block|,
name|TRUE
block|,
name|NULL
block|}
block|,
block|{
name|JUST_COPY
block|,
literal|"adduser.conf"
block|,
name|TRUE
block|,
name|NULL
block|}
block|,
block|{
name|JUST_COPY
block|,
literal|"aliases"
block|,
name|TRUE
block|,
name|NULL
block|}
block|,
block|{
name|JUST_COPY
block|,
literal|"aliases.db"
block|,
name|TRUE
block|,
name|NULL
block|}
block|,
block|{
name|JUST_COPY
block|,
literal|"amd.map"
block|,
name|TRUE
block|,
name|NULL
block|}
block|,
block|{
name|JUST_COPY
block|,
literal|"crontab"
block|,
name|TRUE
block|,
name|NULL
block|}
block|,
block|{
name|JUST_COPY
block|,
literal|"csh.cshrc"
block|,
name|TRUE
block|,
name|NULL
block|}
block|,
block|{
name|JUST_COPY
block|,
literal|"csh.login"
block|,
name|TRUE
block|,
name|NULL
block|}
block|,
block|{
name|JUST_COPY
block|,
literal|"csh.logout"
block|,
name|TRUE
block|,
name|NULL
block|}
block|,
block|{
name|JUST_COPY
block|,
literal|"daily"
block|,
name|TRUE
block|,
name|NULL
block|}
block|,
block|{
name|JUST_COPY
block|,
literal|"disktab"
block|,
name|TRUE
block|,
name|NULL
block|}
block|,
block|{
name|JUST_COPY
block|,
literal|"dm.conf"
block|,
name|TRUE
block|,
name|NULL
block|}
block|,
block|{
name|JUST_COPY
block|,
literal|"exports"
block|,
name|TRUE
block|,
name|NULL
block|}
block|,
block|{
name|JUST_COPY
block|,
literal|"fbtab"
block|,
name|TRUE
block|,
name|NULL
block|}
block|,
block|{
name|JUST_COPY
block|,
literal|"fstab"
block|,
name|FALSE
block|,
name|NULL
block|}
block|,
block|{
name|JUST_COPY
block|,
literal|"ftpusers"
block|,
name|TRUE
block|,
name|NULL
block|}
block|,
block|{
name|JUST_COPY
block|,
literal|"gettytab"
block|,
name|TRUE
block|,
name|NULL
block|}
block|,
block|{
name|JUST_COPY
block|,
literal|"gnats"
block|,
name|TRUE
block|,
name|NULL
block|}
block|,
block|{
name|JUST_COPY
block|,
literal|"group"
block|,
name|FALSE
block|,
name|NULL
block|}
block|,
block|{
name|JUST_COPY
block|,
literal|"host.conf"
block|,
name|TRUE
block|,
name|NULL
block|}
block|,
block|{
name|JUST_COPY
block|,
literal|"hosts"
block|,
name|TRUE
block|,
name|NULL
block|}
block|,
block|{
name|JUST_COPY
block|,
literal|"hosts.equiv"
block|,
name|TRUE
block|,
name|NULL
block|}
block|,
block|{
name|JUST_COPY
block|,
literal|"hosts.lpd"
block|,
name|TRUE
block|,
name|NULL
block|}
block|,
block|{
name|JUST_COPY
block|,
literal|"inetd.conf"
block|,
name|TRUE
block|,
name|NULL
block|}
block|,
block|{
name|JUST_COPY
block|,
literal|"kerberosIV"
block|,
name|TRUE
block|,
name|NULL
block|}
block|,
block|{
name|JUST_COPY
block|,
literal|"localtime"
block|,
name|TRUE
block|,
name|NULL
block|}
block|,
block|{
name|JUST_COPY
block|,
literal|"login.access"
block|,
name|TRUE
block|,
name|NULL
block|}
block|,
block|{
name|JUST_COPY
block|,
literal|"mail.rc"
block|,
name|TRUE
block|,
name|NULL
block|}
block|,
block|{
name|JUST_COPY
block|,
literal|"make.conf"
block|,
name|TRUE
block|,
name|NULL
block|}
block|,
block|{
name|JUST_COPY
block|,
literal|"manpath.config"
block|,
name|TRUE
block|,
name|NULL
block|}
block|,
block|{
name|JUST_COPY
block|,
literal|"master.passwd"
block|,
name|TRUE
block|,
name|NULL
block|}
block|,
block|{
name|JUST_COPY
block|,
literal|"mib.txt"
block|,
name|TRUE
block|,
name|NULL
block|}
block|,
block|{
name|JUST_COPY
block|,
literal|"modems"
block|,
name|TRUE
block|,
name|NULL
block|}
block|,
block|{
name|JUST_COPY
block|,
literal|"monthly"
block|,
name|TRUE
block|,
name|NULL
block|}
block|,
block|{
name|JUST_COPY
block|,
literal|"motd"
block|,
name|TRUE
block|,
name|NULL
block|}
block|,
block|{
name|JUST_COPY
block|,
literal|"namedb"
block|,
name|TRUE
block|,
name|NULL
block|}
block|,
block|{
name|JUST_COPY
block|,
literal|"networks"
block|,
name|TRUE
block|,
name|NULL
block|}
block|,
block|{
name|JUST_COPY
block|,
literal|"passwd"
block|,
name|FALSE
block|,
name|NULL
block|}
block|,
block|{
name|JUST_COPY
block|,
literal|"phones"
block|,
name|TRUE
block|,
name|NULL
block|}
block|,
block|{
name|JUST_COPY
block|,
literal|"ppp"
block|,
name|TRUE
block|,
name|NULL
block|}
block|,
block|{
name|JUST_COPY
block|,
literal|"printcap"
block|,
name|TRUE
block|,
name|NULL
block|}
block|,
block|{
name|JUST_COPY
block|,
literal|"profile"
block|,
name|TRUE
block|,
name|NULL
block|}
block|,
block|{
name|JUST_COPY
block|,
literal|"protocols"
block|,
name|TRUE
block|,
name|NULL
block|}
block|,
block|{
name|JUST_COPY
block|,
literal|"pwd.db"
block|,
name|TRUE
block|,
name|NULL
block|}
block|,
block|{
name|JUST_COPY
block|,
literal|"rc.local"
block|,
name|TRUE
block|,
name|NULL
block|}
block|,
block|{
name|JUST_COPY
block|,
literal|"rc.conf"
block|,
name|FALSE
block|,
name|NULL
block|}
block|,
block|{
name|JUST_COPY
block|,
literal|"remote"
block|,
name|TRUE
block|,
name|NULL
block|}
block|,
block|{
name|JUST_COPY
block|,
literal|"resolv.conf"
block|,
name|TRUE
block|,
name|NULL
block|}
block|,
block|{
name|JUST_COPY
block|,
literal|"rmt"
block|,
name|TRUE
block|,
name|NULL
block|}
block|,
block|{
name|JUST_COPY
block|,
literal|"security"
block|,
name|TRUE
block|,
name|NULL
block|}
block|,
block|{
name|JUST_COPY
block|,
literal|"sendmail.cf"
block|,
name|TRUE
block|,
name|NULL
block|}
block|,
block|{
name|JUST_COPY
block|,
literal|"services"
block|,
name|TRUE
block|,
name|NULL
block|}
block|,
block|{
name|JUST_COPY
block|,
literal|"shells"
block|,
name|TRUE
block|,
name|NULL
block|}
block|,
block|{
name|JUST_COPY
block|,
literal|"skeykeys"
block|,
name|TRUE
block|,
name|NULL
block|}
block|,
block|{
name|JUST_COPY
block|,
literal|"spwd.db"
block|,
name|TRUE
block|,
name|NULL
block|}
block|,
block|{
name|JUST_COPY
block|,
literal|"supfile"
block|,
name|TRUE
block|,
name|NULL
block|}
block|,
block|{
name|JUST_COPY
block|,
literal|"syslog.conf"
block|,
name|TRUE
block|,
name|NULL
block|}
block|,
block|{
name|JUST_COPY
block|,
literal|"termcap"
block|,
name|TRUE
block|,
name|NULL
block|}
block|,
block|{
name|JUST_COPY
block|,
literal|"ttys"
block|,
name|TRUE
block|,
name|NULL
block|}
block|,
block|{
name|JUST_COPY
block|,
literal|"uucp"
block|,
name|TRUE
block|,
name|NULL
block|}
block|,
block|{
name|JUST_COPY
block|,
literal|"weekly"
block|,
name|TRUE
block|,
name|NULL
block|}
block|,
block|{
literal|0
block|}
block|, }
decl_stmt|;
end_decl_stmt

begin_function
name|void
name|traverseHitlist
parameter_list|(
name|HitList
modifier|*
name|h
parameter_list|)
block|{
name|system
argument_list|(
literal|"rm -rf /etc/upgrade"
argument_list|)
expr_stmt|;
name|Mkdir
argument_list|(
literal|"/etc/upgrade"
argument_list|)
expr_stmt|;
while|while
condition|(
name|h
operator|->
name|name
condition|)
block|{
if|if
condition|(
operator|!
name|file_readable
argument_list|(
name|h
operator|->
name|name
argument_list|)
condition|)
block|{
if|if
condition|(
operator|!
name|h
operator|->
name|optional
condition|)
name|msgConfirm
argument_list|(
literal|"Unable to find an old /etc/%s file!  That is decidedly non-standard and\n"
literal|"your upgraded system may function a little strangely as a result."
argument_list|,
name|h
operator|->
name|name
argument_list|)
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|h
operator|->
name|action
operator|==
name|JUST_COPY
condition|)
block|{
comment|/* Move the just-loaded copy aside */
name|vsystem
argument_list|(
literal|"mv /etc/%s /etc/upgrade/%s"
argument_list|,
name|h
operator|->
name|name
argument_list|,
name|h
operator|->
name|name
argument_list|)
expr_stmt|;
comment|/* Copy the old one into its place */
name|msgNotify
argument_list|(
literal|"Resurrecting %s.."
argument_list|,
name|h
operator|->
name|name
argument_list|)
expr_stmt|;
comment|/* Do this with tar so that symlinks and such are preserved */
if|if
condition|(
name|vsystem
argument_list|(
literal|"tar cf - %s | tar xpf - -C /etc"
argument_list|,
name|h
operator|->
name|name
argument_list|)
condition|)
name|msgConfirm
argument_list|(
literal|"Unable to resurrect your old /etc/%s!  Hmmmm."
argument_list|,
name|h
operator|->
name|name
argument_list|)
expr_stmt|;
block|}
else|else
comment|/* call handler */
name|h
operator|->
name|handler
argument_list|(
name|h
argument_list|)
expr_stmt|;
block|}
operator|++
name|h
expr_stmt|;
block|}
block|}
end_function

begin_function
name|int
name|installUpgrade
parameter_list|(
name|dialogMenuItem
modifier|*
name|self
parameter_list|)
block|{
name|char
name|saved_etc
index|[
name|FILENAME_MAX
index|]
decl_stmt|;
name|Boolean
name|extractingBin
init|=
name|TRUE
decl_stmt|;
if|if
condition|(
name|variable_get
argument_list|(
name|VAR_NONINTERACTIVE
argument_list|)
condition|)
return|return
name|installUpgradeNonInteractive
argument_list|(
name|self
argument_list|)
return|;
name|variable_set2
argument_list|(
name|SYSTEM_STATE
argument_list|,
literal|"upgrade"
argument_list|)
expr_stmt|;
name|systemDisplayHelp
argument_list|(
literal|"upgrade"
argument_list|)
expr_stmt|;
name|dialog_clear_norefresh
argument_list|()
expr_stmt|;
if|if
condition|(
name|msgYesNo
argument_list|(
literal|"Given all that scary stuff you just read, are you sure you want to\n"
literal|"risk it all and proceed with this upgrade?"
argument_list|)
operator|!=
literal|0
condition|)
return|return
name|DITEM_FAILURE
operator||
name|DITEM_RESTORE
return|;
if|if
condition|(
operator|!
name|Dists
condition|)
block|{
name|msgConfirm
argument_list|(
literal|"First, you must select some distribution components.  The upgrade procedure\n"
literal|"will only upgrade the distributions you select in the next set of menus."
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|dmenuOpenSimple
argument_list|(
operator|&
name|MenuDistributions
argument_list|,
name|FALSE
argument_list|)
operator|||
operator|!
name|Dists
condition|)
return|return
name|DITEM_FAILURE
operator||
name|DITEM_RESTORE
return|;
name|dialog_clear_norefresh
argument_list|()
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|!
operator|(
name|Dists
operator|&
name|DIST_BIN
operator|)
condition|)
block|{
comment|/* No bin selected?  Not much of an upgrade.. */
if|if
condition|(
name|msgYesNo
argument_list|(
literal|"You didn't select the bin distribution as one of the distributons to load.\n"
literal|"This one is pretty vital to a successful upgrade.  Are you SURE you don't\n"
literal|"want to select the bin distribution?  Chose No to bring up the Distributions\n"
literal|"menu again."
argument_list|)
operator|!=
literal|0
condition|)
block|{
if|if
condition|(
operator|!
name|dmenuOpenSimple
argument_list|(
operator|&
name|MenuDistributions
argument_list|,
name|FALSE
argument_list|)
condition|)
return|return
name|DITEM_FAILURE
operator||
name|DITEM_RESTORE
return|;
name|dialog_clear_norefresh
argument_list|()
expr_stmt|;
block|}
block|}
comment|/* Still?!  OK!  They must know what they're doing.. */
if|if
condition|(
operator|!
operator|(
name|Dists
operator|&
name|DIST_BIN
operator|)
condition|)
name|extractingBin
operator|=
name|FALSE
expr_stmt|;
if|if
condition|(
name|RunningAsInit
condition|)
block|{
name|Device
modifier|*
modifier|*
name|devs
decl_stmt|;
name|int
name|i
decl_stmt|,
name|cnt
decl_stmt|;
name|char
modifier|*
name|cp
decl_stmt|;
name|cp
operator|=
name|variable_get
argument_list|(
name|VAR_DISK
argument_list|)
expr_stmt|;
name|devs
operator|=
name|deviceFind
argument_list|(
name|cp
argument_list|,
name|DEVICE_TYPE_DISK
argument_list|)
expr_stmt|;
name|cnt
operator|=
name|deviceCount
argument_list|(
name|devs
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|cnt
condition|)
block|{
name|msgConfirm
argument_list|(
literal|"No disks found!  Please verify that your disk controller is being\n"
literal|"properly probed at boot time.  See the Hardware Guide on the\n"
literal|"Documentation menu for clues on diagnosing this type of problem."
argument_list|)
expr_stmt|;
return|return
name|DITEM_FAILURE
return|;
block|}
else|else
block|{
comment|/* Enable all the drives befor we start */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|cnt
condition|;
name|i
operator|++
control|)
name|devs
index|[
name|i
index|]
operator|->
name|enabled
operator|=
name|TRUE
expr_stmt|;
block|}
name|msgConfirm
argument_list|(
literal|"OK.  First, we're going to go to the disk label editor.  In this editor\n"
literal|"you will be expected to Mount any partitions you're interested in\n"
literal|"upgrading.  DO NOT set the Newfs flag to Y on anything in the label editor\n"
literal|"unless you're absolutely sure you know what you're doing!  In this\n"
literal|"instance, you'll be using the label editor as little more than a fancy\n"
literal|"screen-oriented partition mounting tool.\n\n"
literal|"Once you're done in the label editor, press Q to return here for the next\n"
literal|"step."
argument_list|)
expr_stmt|;
if|if
condition|(
name|DITEM_STATUS
argument_list|(
name|diskLabelEditor
argument_list|(
name|self
argument_list|)
argument_list|)
operator|==
name|DITEM_FAILURE
condition|)
block|{
name|msgConfirm
argument_list|(
literal|"The disk label editor returned an error status.  Upgrade operation\n"
literal|"aborted."
argument_list|)
expr_stmt|;
return|return
name|DITEM_FAILURE
operator||
name|DITEM_RESTORE
return|;
block|}
comment|/* Don't write out MBR info */
name|variable_set2
argument_list|(
name|DISK_PARTITIONED
argument_list|,
literal|"written"
argument_list|)
expr_stmt|;
if|if
condition|(
name|DITEM_STATUS
argument_list|(
name|diskLabelCommit
argument_list|(
name|self
argument_list|)
argument_list|)
operator|==
name|DITEM_FAILURE
condition|)
block|{
name|msgConfirm
argument_list|(
literal|"Not all file systems were properly mounted.  Upgrade operation\n"
literal|"aborted."
argument_list|)
expr_stmt|;
name|variable_unset
argument_list|(
name|DISK_PARTITIONED
argument_list|)
expr_stmt|;
return|return
name|DITEM_FAILURE
operator||
name|DITEM_RESTORE
return|;
block|}
if|if
condition|(
name|extractingBin
condition|)
block|{
name|msgNotify
argument_list|(
literal|"chflags'ing old binaries - please wait."
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|vsystem
argument_list|(
literal|"chflags -R noschg /mnt/"
argument_list|)
expr_stmt|;
block|}
name|msgNotify
argument_list|(
literal|"Updating /stand on root filesystem"
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|vsystem
argument_list|(
literal|"find -x /stand | cpio %s -pdum /mnt"
argument_list|,
name|cpioVerbosity
argument_list|()
argument_list|)
expr_stmt|;
if|if
condition|(
name|DITEM_STATUS
argument_list|(
name|chroot
argument_list|(
literal|"/mnt"
argument_list|)
argument_list|)
operator|==
name|DITEM_FAILURE
condition|)
block|{
name|msgConfirm
argument_list|(
literal|"Unable to chroot to /mnt - something is wrong with the\n"
literal|"root partition or the way it's mounted if this doesn't work."
argument_list|)
expr_stmt|;
name|variable_unset
argument_list|(
name|DISK_PARTITIONED
argument_list|)
expr_stmt|;
return|return
name|DITEM_FAILURE
operator||
name|DITEM_RESTORE
return|;
block|}
name|chdir
argument_list|(
literal|"/"
argument_list|)
expr_stmt|;
name|systemCreateHoloshell
argument_list|()
expr_stmt|;
block|}
name|saved_etc
index|[
literal|0
index|]
operator|=
literal|'\0'
expr_stmt|;
if|if
condition|(
name|extractingBin
condition|)
block|{
while|while
condition|(
operator|!
operator|*
name|saved_etc
condition|)
block|{
name|char
modifier|*
name|cp
init|=
name|msgGetInput
argument_list|(
literal|"/usr/tmp/etc"
argument_list|,
literal|"Under which directory do you wish to save your current /etc?"
argument_list|)
decl_stmt|;
if|if
condition|(
operator|!
name|cp
operator|||
operator|!
operator|*
name|cp
operator|||
name|Mkdir
argument_list|(
name|cp
argument_list|)
condition|)
block|{
if|if
condition|(
name|msgYesNo
argument_list|(
literal|"Directory was not specified, was invalid or user selected Cancel.\n\n"
literal|"Doing an upgrade without first backing up your /etc directory is a very\n"
literal|"bad idea!  Do you want to go back and specify the save directory again?"
argument_list|)
operator|!=
literal|0
condition|)
break|break;
block|}
else|else
block|{
name|SAFE_STRCPY
argument_list|(
name|saved_etc
argument_list|,
name|cp
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
name|saved_etc
index|[
literal|0
index|]
condition|)
block|{
name|msgNotify
argument_list|(
literal|"Preserving /etc directory.."
argument_list|)
expr_stmt|;
if|if
condition|(
name|vsystem
argument_list|(
literal|"tar -cBpf - -C /etc . | tar --unlink -xBpf - -C %s"
argument_list|,
name|saved_etc
argument_list|)
condition|)
if|if
condition|(
name|msgYesNo
argument_list|(
literal|"Unable to backup your /etc into %s.\n"
literal|"Do you want to continue anyway?"
argument_list|,
name|saved_etc
argument_list|)
operator|!=
literal|0
condition|)
return|return
name|DITEM_FAILURE
operator||
name|DITEM_RESTORE
return|;
block|}
if|if
condition|(
name|file_readable
argument_list|(
literal|"/kernel"
argument_list|)
condition|)
block|{
name|msgNotify
argument_list|(
literal|"Moving old kernel to /kernel.prev"
argument_list|)
expr_stmt|;
if|if
condition|(
name|system
argument_list|(
literal|"chflags noschg /kernel&& mv /kernel /kernel.prev"
argument_list|)
condition|)
block|{
if|if
condition|(
operator|!
name|msgYesNo
argument_list|(
literal|"Hmmm!  I couldn't move the old kernel over!  Do you want to\n"
literal|"treat this as a big problem and abort the upgrade?  Due to the\n"
literal|"way that this upgrade process works, you will have to reboot\n"
literal|"and start over from the beginning.  Select Yes to reboot now"
argument_list|)
condition|)
name|systemShutdown
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
else|else
comment|/* Give us a working kernel in case we crash and reboot */
name|system
argument_list|(
literal|"cp /kernel.prev /kernel"
argument_list|)
expr_stmt|;
block|}
block|}
name|media
label|:
comment|/* We do this very late, but we unfortunately need to back up /etc first */
if|if
condition|(
operator|!
name|mediaVerify
argument_list|()
condition|)
return|return
name|DITEM_FAILURE
operator||
name|DITEM_RESTORE
return|;
if|if
condition|(
operator|!
name|mediaDevice
operator|->
name|init
argument_list|(
name|mediaDevice
argument_list|)
condition|)
block|{
if|if
condition|(
operator|!
name|msgYesNo
argument_list|(
literal|"Couldn't initialize the media.  Would you like\n"
literal|"to adjust your media selection and try again?"
argument_list|)
condition|)
block|{
name|mediaDevice
operator|=
name|NULL
expr_stmt|;
goto|goto
name|media
goto|;
block|}
else|else
return|return
name|DITEM_FAILURE
operator||
name|DITEM_REDRAW
return|;
block|}
name|msgNotify
argument_list|(
literal|"Beginning extraction of distributions.."
argument_list|)
expr_stmt|;
if|if
condition|(
name|DITEM_STATUS
argument_list|(
name|distExtractAll
argument_list|(
name|self
argument_list|)
argument_list|)
operator|==
name|DITEM_FAILURE
condition|)
block|{
name|msgConfirm
argument_list|(
literal|"Hmmmm.  We couldn't even extract the bin distribution.  This upgrade\n"
literal|"should be considered a failure and started from the beginning, sorry!\n"
literal|"The system will reboot now."
argument_list|)
expr_stmt|;
name|dialog_clear
argument_list|()
expr_stmt|;
name|systemShutdown
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|Dists
condition|)
block|{
if|if
condition|(
operator|!
name|extractingBin
operator|||
operator|!
operator|(
name|Dists
operator|&
name|DIST_BIN
operator|)
condition|)
block|{
name|msgNotify
argument_list|(
literal|"The extraction process seems to have had some problems, but we got most\n"
literal|"of the essentials.  We'll treat this as a warning since it may have been\n"
literal|"only non-essential distributions which failed to load."
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|msgConfirm
argument_list|(
literal|"Hmmmm.  We couldn't even extract the bin distribution.  This upgrade\n"
literal|"should be considered a failure and started from the beginning, sorry!\n"
literal|"The system will reboot now."
argument_list|)
expr_stmt|;
name|dialog_clear
argument_list|()
expr_stmt|;
name|systemShutdown
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
name|extractingBin
condition|)
block|{
name|msgNotify
argument_list|(
literal|"OK, now it's time to go pound on your root a little bit to create all the\n"
literal|"/dev entries and such that a new system expects to see.  I'll also perform a\n"
literal|"few \"fixup\" operations to repair the effects of splatting a bin distribution\n"
literal|"on top of an existing system.."
argument_list|)
expr_stmt|;
if|if
condition|(
name|DITEM_STATUS
argument_list|(
name|installFixup
argument_list|(
name|self
argument_list|)
argument_list|)
operator|==
name|DITEM_FAILURE
condition|)
block|{
name|msgConfirm
argument_list|(
literal|"Hmmmmm.  The fixups don't seem to have been very happy.\n"
literal|"You may wish to examine the system a little more closely when\n"
literal|"it comes time to merge your /etc customizations back."
argument_list|)
expr_stmt|;
block|}
block|}
name|msgNotify
argument_list|(
literal|"First stage of upgrade completed successfully!\n\n"
literal|"Next comes stage 2, where we attempt to resurrect your /etc\n"
literal|"directory!"
argument_list|)
expr_stmt|;
if|if
condition|(
name|saved_etc
operator|&&
name|chdir
argument_list|(
name|saved_etc
argument_list|)
condition|)
block|{
name|msgConfirm
argument_list|(
literal|"Unable to go to your saved /etc directory in %s?!  Argh!\n"
literal|"Something went seriously wrong!  It's quite possible that\n"
literal|"your former /etc is toast.  I hope you didn't have any\n"
literal|"important customizations you wanted to keep in there.. :("
argument_list|,
name|saved_etc
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|/* Now try to resurrect the /etc files */
name|traverseHitlist
argument_list|(
name|etc_files
argument_list|)
expr_stmt|;
block|}
name|msgConfirm
argument_list|(
literal|"OK!  At this stage, we've resurrected all the /etc files\n"
literal|"and moved each new copy over to /etc/upgrade/<file> in case you want\n"
literal|"to see what the new versions look like.  If you want to wander over\n"
literal|"to the Emergency Holographic Shell [ALT-F4] at this point to do\n"
literal|"that, now would be a good time.  When you're ready to reboot into\n"
literal|"the new system, just exit the installation."
argument_list|)
expr_stmt|;
return|return
name|DITEM_SUCCESS
operator||
name|DITEM_REDRAW
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|installUpgradeNonInteractive
parameter_list|(
name|dialogMenuItem
modifier|*
name|self
parameter_list|)
block|{
name|char
modifier|*
name|saved_etc
decl_stmt|;
name|Boolean
name|extractingBin
init|=
name|TRUE
decl_stmt|;
name|variable_set2
argument_list|(
name|SYSTEM_STATE
argument_list|,
literal|"upgrade"
argument_list|)
expr_stmt|;
comment|/* Make sure at least BIN is selected */
name|Dists
operator||=
name|DIST_BIN
expr_stmt|;
if|if
condition|(
name|RunningAsInit
condition|)
block|{
name|Device
modifier|*
modifier|*
name|devs
decl_stmt|;
name|int
name|i
decl_stmt|,
name|cnt
decl_stmt|;
name|char
modifier|*
name|cp
decl_stmt|;
name|cp
operator|=
name|variable_get
argument_list|(
name|VAR_DISK
argument_list|)
expr_stmt|;
name|devs
operator|=
name|deviceFind
argument_list|(
name|cp
argument_list|,
name|DEVICE_TYPE_DISK
argument_list|)
expr_stmt|;
name|cnt
operator|=
name|deviceCount
argument_list|(
name|devs
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|cnt
condition|)
block|{
name|msgConfirm
argument_list|(
literal|"No disks found!  Please verify that your disk controller is being\n"
literal|"properly probed at boot time.  See the Hardware Guide on the\n"
literal|"Documentation menu for clues on diagnosing this type of problem."
argument_list|)
expr_stmt|;
return|return
name|DITEM_FAILURE
return|;
block|}
else|else
block|{
comment|/* Enable all the drives befor we start */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|cnt
condition|;
name|i
operator|++
control|)
name|devs
index|[
name|i
index|]
operator|->
name|enabled
operator|=
name|TRUE
expr_stmt|;
block|}
name|msgConfirm
argument_list|(
literal|"OK.  First, we're going to go to the disk label editor.  In this editor\n"
literal|"you will be expected to Mount any partitions you're interested in\n"
literal|"upgrading.  DO NOT set the Newfs flag to Y on anything in the label editor\n"
literal|"unless you're absolutely sure you know what you're doing!  In this\n"
literal|"instance, you'll be using the label editor as little more than a fancy\n"
literal|"screen-oriented partition mounting tool.\n\n"
literal|"Once you're done in the label editor, press Q to return here for the next\n"
literal|"step."
argument_list|)
expr_stmt|;
if|if
condition|(
name|DITEM_STATUS
argument_list|(
name|diskLabelEditor
argument_list|(
name|self
argument_list|)
argument_list|)
operator|==
name|DITEM_FAILURE
condition|)
block|{
name|msgConfirm
argument_list|(
literal|"The disk label editor returned an error status.  Upgrade operation\n"
literal|"aborted."
argument_list|)
expr_stmt|;
return|return
name|DITEM_FAILURE
operator||
name|DITEM_RESTORE
return|;
block|}
comment|/* Don't write out MBR info */
name|variable_set2
argument_list|(
name|DISK_PARTITIONED
argument_list|,
literal|"written"
argument_list|)
expr_stmt|;
if|if
condition|(
name|DITEM_STATUS
argument_list|(
name|diskLabelCommit
argument_list|(
name|self
argument_list|)
argument_list|)
operator|==
name|DITEM_FAILURE
condition|)
block|{
name|msgConfirm
argument_list|(
literal|"Not all file systems were properly mounted.  Upgrade operation\n"
literal|"aborted."
argument_list|)
expr_stmt|;
name|variable_unset
argument_list|(
name|DISK_PARTITIONED
argument_list|)
expr_stmt|;
return|return
name|DITEM_FAILURE
operator||
name|DITEM_RESTORE
return|;
block|}
if|if
condition|(
name|extractingBin
condition|)
block|{
name|msgNotify
argument_list|(
literal|"chflags'ing old binaries - please wait."
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|vsystem
argument_list|(
literal|"chflags -R noschg /mnt/"
argument_list|)
expr_stmt|;
block|}
name|msgNotify
argument_list|(
literal|"Updating /stand on root filesystem"
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|vsystem
argument_list|(
literal|"find -x /stand | cpio %s -pdum /mnt"
argument_list|,
name|cpioVerbosity
argument_list|()
argument_list|)
expr_stmt|;
if|if
condition|(
name|DITEM_STATUS
argument_list|(
name|chroot
argument_list|(
literal|"/mnt"
argument_list|)
argument_list|)
operator|==
name|DITEM_FAILURE
condition|)
block|{
name|msgConfirm
argument_list|(
literal|"Unable to chroot to /mnt - something is wrong with the\n"
literal|"root partition or the way it's mounted if this doesn't work."
argument_list|)
expr_stmt|;
name|variable_unset
argument_list|(
name|DISK_PARTITIONED
argument_list|)
expr_stmt|;
return|return
name|DITEM_FAILURE
operator||
name|DITEM_RESTORE
return|;
block|}
name|chdir
argument_list|(
literal|"/"
argument_list|)
expr_stmt|;
name|systemCreateHoloshell
argument_list|()
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|mediaVerify
argument_list|()
operator|||
operator|!
name|mediaDevice
operator|->
name|init
argument_list|(
name|mediaDevice
argument_list|)
condition|)
block|{
name|msgNotify
argument_list|(
literal|"Upgrade: Couldn't initialize media."
argument_list|)
expr_stmt|;
return|return
name|DITEM_FAILURE
operator||
name|DITEM_RESTORE
return|;
block|}
name|saved_etc
operator|=
literal|"/usr/tmp/etc"
expr_stmt|;
name|Mkdir
argument_list|(
name|saved_etc
argument_list|)
expr_stmt|;
name|msgNotify
argument_list|(
literal|"Preserving /etc directory.."
argument_list|)
expr_stmt|;
if|if
condition|(
name|vsystem
argument_list|(
literal|"tar -cpBf - -C /etc . | tar -xpBf - -C %s"
argument_list|,
name|saved_etc
argument_list|)
condition|)
block|{
name|msgNotify
argument_list|(
literal|"Unable to backup your /etc into %s."
argument_list|,
name|saved_etc
argument_list|)
expr_stmt|;
return|return
name|DITEM_FAILURE
operator||
name|DITEM_RESTORE
return|;
block|}
if|if
condition|(
name|file_readable
argument_list|(
literal|"/kernel"
argument_list|)
condition|)
block|{
name|msgNotify
argument_list|(
literal|"Moving old kernel to /kernel.prev"
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|system
argument_list|(
literal|"chflags noschg /kernel&& mv /kernel /kernel.prev"
argument_list|)
condition|)
block|{
comment|/* Give us a working kernel in case we crash and reboot */
name|system
argument_list|(
literal|"cp /kernel.prev /kernel"
argument_list|)
expr_stmt|;
block|}
block|}
name|msgNotify
argument_list|(
literal|"Beginning extraction of distributions.."
argument_list|)
expr_stmt|;
if|if
condition|(
name|DITEM_STATUS
argument_list|(
name|distExtractAll
argument_list|(
name|self
argument_list|)
argument_list|)
operator|==
name|DITEM_FAILURE
condition|)
block|{
name|msgConfirm
argument_list|(
literal|"Hmmmm.  We couldn't even extract the bin distribution.  This upgrade\n"
literal|"should be considered a failure and started from the beginning, sorry!\n"
literal|"The system will reboot now."
argument_list|)
expr_stmt|;
name|dialog_clear
argument_list|()
expr_stmt|;
name|systemShutdown
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|Dists
condition|)
block|{
if|if
condition|(
operator|!
operator|(
name|Dists
operator|&
name|DIST_BIN
operator|)
condition|)
block|{
name|msgNotify
argument_list|(
literal|"The extraction process seems to have had some problems, but we got most\n"
literal|"of the essentials.  We'll treat this as a warning since it may have been\n"
literal|"only non-essential distributions which failed to upgrade."
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|msgConfirm
argument_list|(
literal|"Hmmmm.  We couldn't even extract the bin distribution.  This upgrade\n"
literal|"should be considered a failure and started from the beginning, sorry!\n"
literal|"The system will reboot now."
argument_list|)
expr_stmt|;
name|dialog_clear
argument_list|()
expr_stmt|;
name|systemShutdown
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
block|}
name|msgNotify
argument_list|(
literal|"OK, now it's time to go pound on your root a little bit to create all the\n"
literal|"/dev entries and such that a new system expects to see.  I'll also perform a\n"
literal|"few \"fixup\" operations to repair the effects of splatting a bin distribution\n"
literal|"on top of an existing system.."
argument_list|)
expr_stmt|;
if|if
condition|(
name|DITEM_STATUS
argument_list|(
name|installFixup
argument_list|(
name|self
argument_list|)
argument_list|)
operator|==
name|DITEM_FAILURE
condition|)
block|{
name|msgNotify
argument_list|(
literal|"Hmmmmm.  The fixups don't seem to have been very happy.\n"
literal|"You may wish to examine the system a little more closely when\n"
literal|"it comes time to merge your /etc customizations back."
argument_list|)
expr_stmt|;
block|}
name|msgNotify
argument_list|(
literal|"First stage of upgrade completed successfully."
argument_list|)
expr_stmt|;
if|if
condition|(
name|vsystem
argument_list|(
literal|"tar -cpBf - -C %s . | tar --unlink -xpBf - -C /etc"
argument_list|,
name|saved_etc
argument_list|)
condition|)
block|{
name|msgNotify
argument_list|(
literal|"Unable to resurrect your old /etc!"
argument_list|)
expr_stmt|;
return|return
name|DITEM_FAILURE
operator||
name|DITEM_RESTORE
return|;
block|}
return|return
name|DITEM_SUCCESS
operator||
name|DITEM_REDRAW
return|;
block|}
end_function

end_unit


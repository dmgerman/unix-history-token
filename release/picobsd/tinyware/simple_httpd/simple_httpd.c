begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*	simpleHTTPd (C) 1998 netSTOR Technologies, Inc. ("netSTOR") 	FreeBSD port and additional work by Marc Nicholas<marc@netstor.com> 	Based on work by:- 	Thierry Leconte& Yury Shimanovsky 	My Russian webserver writing friends :-)  	This is an HTTP daemon that will serve up HTML, text files, JPEGs, 	GIFs and do simple CGI work.  	You may use this code for non-commercial distribution only. Commercial 	distribution requires the express, written permission of netSTOR. No 	warranty is implied or given -- use at your own risk! */
end_comment

begin_comment
comment|/*  * $Id: simple_httpd.c,v 1.1 1998/08/19 16:24:06 abial Exp $  */
end_comment

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_include
include|#
directive|include
file|<unistd.h>
end_include

begin_include
include|#
directive|include
file|<stdlib.h>
end_include

begin_include
include|#
directive|include
file|<sys/stat.h>
end_include

begin_include
include|#
directive|include
file|<sys/time.h>
end_include

begin_include
include|#
directive|include
file|<sys/types.h>
end_include

begin_include
include|#
directive|include
file|<time.h>
end_include

begin_include
include|#
directive|include
file|<sys/socket.h>
end_include

begin_include
include|#
directive|include
file|<netinet/in.h>
end_include

begin_include
include|#
directive|include
file|<arpa/inet.h>
end_include

begin_include
include|#
directive|include
file|<netdb.h>
end_include

begin_include
include|#
directive|include
file|<fcntl.h>
end_include

begin_include
include|#
directive|include
file|<string.h>
end_include

begin_include
include|#
directive|include
file|<signal.h>
end_include

begin_include
include|#
directive|include
file|<sys/wait.h>
end_include

begin_decl_stmt
name|int
name|http_sock
decl_stmt|,
name|con_sock
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|http_port
init|=
literal|80
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|struct
name|sockaddr_in
name|source
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|char
name|homedir
index|[
literal|100
index|]
decl_stmt|;
end_decl_stmt

begin_function_decl
name|char
modifier|*
name|adate
parameter_list|()
function_decl|;
end_function_decl

begin_decl_stmt
name|struct
name|hostent
modifier|*
name|hst
decl_stmt|;
end_decl_stmt

begin_function
name|void
name|init_servconnection
parameter_list|(
name|void
parameter_list|)
block|{
name|struct
name|sockaddr_in
name|server
decl_stmt|;
comment|/* Create a socket */
name|http_sock
operator|=
name|socket
argument_list|(
name|AF_INET
argument_list|,
name|SOCK_STREAM
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|http_sock
operator|<
literal|0
condition|)
block|{
name|perror
argument_list|(
literal|"socket"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
name|server
operator|.
name|sin_family
operator|=
name|AF_INET
expr_stmt|;
name|server
operator|.
name|sin_port
operator|=
name|htons
argument_list|(
name|http_port
argument_list|)
expr_stmt|;
name|server
operator|.
name|sin_addr
operator|.
name|s_addr
operator|=
name|INADDR_ANY
expr_stmt|;
if|if
condition|(
name|bind
argument_list|(
name|http_sock
argument_list|,
operator|(
expr|struct
name|sockaddr
operator|*
operator|)
operator|&
name|server
argument_list|,
sizeof|sizeof
argument_list|(
name|server
argument_list|)
argument_list|)
operator|<
literal|0
condition|)
block|{
name|perror
argument_list|(
literal|"bind socket"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
name|printf
argument_list|(
literal|"simpleHTTPd running on %d port\n"
argument_list|,
name|http_port
argument_list|)
expr_stmt|;
block|}
end_function

begin_macro
name|attenteconnection
argument_list|(
argument|void
argument_list|)
end_macro

begin_block
block|{
name|int
name|lg
decl_stmt|;
name|lg
operator|=
sizeof|sizeof
argument_list|(
expr|struct
name|sockaddr_in
argument_list|)
expr_stmt|;
name|con_sock
operator|=
name|accept
argument_list|(
name|http_sock
argument_list|,
operator|(
expr|struct
name|sockaddr
operator|*
operator|)
operator|&
name|source
argument_list|,
operator|&
name|lg
argument_list|)
expr_stmt|;
if|if
condition|(
name|con_sock
operator|<=
literal|0
condition|)
block|{
name|perror
argument_list|(
literal|"accept"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
block|}
end_block

begin_macro
name|outdate
argument_list|()
end_macro

begin_block
block|{
name|time_t
name|tl
decl_stmt|;
name|char
name|buff
index|[
literal|50
index|]
decl_stmt|;
name|tl
operator|=
name|time
argument_list|(
name|NULL
argument_list|)
expr_stmt|;
name|strftime
argument_list|(
name|buff
argument_list|,
literal|50
argument_list|,
literal|"Date: %a, %d %h %Y %H:%M:%S %Z\r\n"
argument_list|,
name|gmtime
argument_list|(
operator|&
name|tl
argument_list|)
argument_list|)
expr_stmt|;
name|write
argument_list|(
name|con_sock
argument_list|,
name|buff
argument_list|,
name|strlen
argument_list|(
name|buff
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_block

begin_decl_stmt
name|char
modifier|*
name|rep_err_nget
index|[
literal|2
index|]
init|=
block|{
literal|"<HTML><HEAD><TITLE>Error</TITLE></HEAD><BODY><H1>Error 405</H1>\ This server is supports only GET and HEAD  requests\n</BODY></HTML>\r\n"
block|,
literal|"HTTP/1.0 405 Method Not allowed\r\nAllow: GET,HEAD\r\nServer: jhttpd\r\n"
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|char
modifier|*
name|rep_err_acc
index|[
literal|2
index|]
init|=
block|{
literal|"<HTML><HEAD><TITLE>Error</TITLE></HEAD><BODY><H1>Error 404</H1>\ Not found - file doesn't exist or is read protected\n</BODY></HTML>\r\n"
block|,
literal|"HTTP/1.0 404 Not found\r\nServer: jhttpd\r\n"
block|}
decl_stmt|;
end_decl_stmt

begin_macro
name|outerror
argument_list|(
argument|char **rep
argument_list|,
argument|int http1
argument_list|)
end_macro

begin_comment
comment|/* ÷ÙÄÙÞÁ ÏÛÉÂËÉ ËÌÉÅÎÔÕ × html- ×ÉÄÅ */
end_comment

begin_block
block|{
if|if
condition|(
name|http1
condition|)
block|{
name|write
argument_list|(
name|con_sock
argument_list|,
name|rep
index|[
literal|1
index|]
argument_list|,
name|strlen
argument_list|(
name|rep
index|[
literal|1
index|]
argument_list|)
argument_list|)
expr_stmt|;
name|outdate
argument_list|()
expr_stmt|;
name|write
argument_list|(
name|con_sock
argument_list|,
literal|"\r\n"
argument_list|,
literal|2
argument_list|)
expr_stmt|;
block|}
name|write
argument_list|(
name|con_sock
argument_list|,
name|rep
index|[
literal|0
index|]
argument_list|,
name|strlen
argument_list|(
name|rep
index|[
literal|0
index|]
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_block

begin_decl_stmt
name|char
name|rep_head
index|[]
init|=
literal|"HTTP/1.0 200 OK\r\nServer: simpleHTTPD\r\n"
decl_stmt|;
end_decl_stmt

begin_macro
name|traite_req
argument_list|()
end_macro

begin_block
block|{
name|char
name|buff
index|[
literal|8192
index|]
decl_stmt|;
name|int
name|fd
decl_stmt|,
name|lg
decl_stmt|,
name|cmd
decl_stmt|,
name|http1
decl_stmt|,
name|i
decl_stmt|;
name|char
modifier|*
name|filename
decl_stmt|,
modifier|*
name|c
decl_stmt|;
name|struct
name|stat
name|statres
decl_stmt|;
name|char
name|req
index|[
literal|1024
index|]
decl_stmt|;
name|char
name|logfile
index|[
literal|80
index|]
decl_stmt|;
name|char
name|msg
index|[
literal|1024
index|]
decl_stmt|;
name|char
modifier|*
name|p
decl_stmt|,
modifier|*
name|par
decl_stmt|;
name|long
name|addr
decl_stmt|;
name|FILE
modifier|*
name|log
decl_stmt|;
name|lg
operator|=
name|read
argument_list|(
name|con_sock
argument_list|,
name|req
argument_list|,
literal|1024
argument_list|)
expr_stmt|;
if|if
condition|(
name|p
operator|=
name|strstr
argument_list|(
name|req
argument_list|,
literal|"\n"
argument_list|)
condition|)
operator|*
name|p
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|p
operator|=
name|strstr
argument_list|(
name|req
argument_list|,
literal|"\r"
argument_list|)
condition|)
operator|*
name|p
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|geteuid
argument_list|()
condition|)
block|{
name|strcpy
argument_list|(
name|logfile
argument_list|,
name|getenv
argument_list|(
literal|"HOME"
argument_list|)
argument_list|)
expr_stmt|;
name|strcat
argument_list|(
name|logfile
argument_list|,
literal|"/"
argument_list|)
expr_stmt|;
name|strcat
argument_list|(
name|logfile
argument_list|,
literal|"jhttp.log"
argument_list|)
expr_stmt|;
block|}
else|else
name|strcpy
argument_list|(
name|logfile
argument_list|,
literal|"/usr/adm/jhttpd.log"
argument_list|)
expr_stmt|;
if|if
condition|(
name|access
argument_list|(
name|logfile
argument_list|,
name|W_OK
argument_list|)
condition|)
block|{
name|lg
operator|=
name|creat
argument_list|(
name|logfile
argument_list|,
name|O_WRONLY
argument_list|)
expr_stmt|;
name|chmod
argument_list|(
name|logfile
argument_list|,
literal|00600
argument_list|)
expr_stmt|;
name|close
argument_list|(
name|lg
argument_list|)
expr_stmt|;
block|}
name|strcpy
argument_list|(
name|buff
argument_list|,
name|inet_ntoa
argument_list|(
name|source
operator|.
name|sin_addr
argument_list|)
argument_list|)
expr_stmt|;
name|addr
operator|=
name|inet_addr
argument_list|(
name|buff
argument_list|)
expr_stmt|;
name|strcpy
argument_list|(
name|msg
argument_list|,
name|adate
argument_list|()
argument_list|)
expr_stmt|;
name|strcat
argument_list|(
name|msg
argument_list|,
literal|"    "
argument_list|)
expr_stmt|;
name|hst
operator|=
name|gethostbyaddr
argument_list|(
operator|(
name|char
operator|*
operator|)
operator|&
name|addr
argument_list|,
literal|4
argument_list|,
name|AF_INET
argument_list|)
expr_stmt|;
if|if
condition|(
name|hst
condition|)
name|strcat
argument_list|(
name|msg
argument_list|,
name|hst
operator|->
name|h_name
argument_list|)
expr_stmt|;
name|strcat
argument_list|(
name|msg
argument_list|,
literal|" ("
argument_list|)
expr_stmt|;
name|strcat
argument_list|(
name|msg
argument_list|,
name|buff
argument_list|)
expr_stmt|;
name|strcat
argument_list|(
name|msg
argument_list|,
literal|")   "
argument_list|)
expr_stmt|;
name|strcat
argument_list|(
name|msg
argument_list|,
name|req
argument_list|)
expr_stmt|;
name|log
operator|=
name|fopen
argument_list|(
name|logfile
argument_list|,
literal|"a"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|log
argument_list|,
literal|"%s\n"
argument_list|,
name|msg
argument_list|)
expr_stmt|;
name|fclose
argument_list|(
name|log
argument_list|)
expr_stmt|;
name|c
operator|=
name|strtok
argument_list|(
name|req
argument_list|,
literal|" "
argument_list|)
expr_stmt|;
if|if
condition|(
name|c
operator|==
name|NULL
condition|)
block|{
name|outerror
argument_list|(
name|rep_err_nget
argument_list|,
literal|0
argument_list|)
expr_stmt|;
goto|goto
name|error
goto|;
block|}
name|cmd
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|strncmp
argument_list|(
name|c
argument_list|,
literal|"GET"
argument_list|,
literal|3
argument_list|)
operator|==
literal|0
condition|)
name|cmd
operator|=
literal|1
expr_stmt|;
if|if
condition|(
name|strncmp
argument_list|(
name|c
argument_list|,
literal|"HEAD"
argument_list|,
literal|4
argument_list|)
operator|==
literal|0
condition|)
block|{
name|cmd
operator|=
literal|2
expr_stmt|;
block|}
name|filename
operator|=
name|strtok
argument_list|(
name|NULL
argument_list|,
literal|" "
argument_list|)
expr_stmt|;
name|http1
operator|=
literal|0
expr_stmt|;
name|c
operator|=
name|strtok
argument_list|(
name|NULL
argument_list|,
literal|" "
argument_list|)
expr_stmt|;
if|if
condition|(
name|c
operator|!=
name|NULL
operator|&&
name|strncmp
argument_list|(
name|c
argument_list|,
literal|"HTTP"
argument_list|,
literal|4
argument_list|)
operator|==
literal|0
condition|)
name|http1
operator|=
literal|1
expr_stmt|;
if|if
condition|(
name|cmd
operator|==
literal|0
condition|)
block|{
name|outerror
argument_list|(
name|rep_err_nget
argument_list|,
name|http1
argument_list|)
expr_stmt|;
goto|goto
name|error
goto|;
block|}
if|if
condition|(
name|filename
operator|==
name|NULL
operator|||
name|strlen
argument_list|(
name|filename
argument_list|)
operator|==
literal|1
condition|)
name|filename
operator|=
literal|"/index.html"
expr_stmt|;
while|while
condition|(
name|filename
index|[
literal|0
index|]
operator|==
literal|'/'
condition|)
name|filename
operator|++
expr_stmt|;
comment|/**/
if|if
condition|(
operator|!
name|strncmp
argument_list|(
name|filename
argument_list|,
literal|"cgi-bin/"
argument_list|,
literal|8
argument_list|)
condition|)
block|{
name|par
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|par
operator|=
name|strstr
argument_list|(
name|filename
argument_list|,
literal|"?"
argument_list|)
condition|)
block|{
operator|*
name|par
operator|=
literal|0
expr_stmt|;
name|par
operator|++
expr_stmt|;
block|}
if|if
condition|(
name|access
argument_list|(
name|filename
argument_list|,
name|X_OK
argument_list|)
condition|)
goto|goto
name|conti
goto|;
name|stat
argument_list|(
name|filename
argument_list|,
operator|&
name|statres
argument_list|)
expr_stmt|;
if|if
condition|(
name|setuid
argument_list|(
name|statres
operator|.
name|st_uid
argument_list|)
condition|)
return|return
operator|(
literal|0
operator|)
return|;
if|if
condition|(
name|seteuid
argument_list|(
name|statres
operator|.
name|st_uid
argument_list|)
condition|)
return|return
operator|(
literal|0
operator|)
return|;
if|if
condition|(
operator|!
name|fork
argument_list|()
condition|)
block|{
name|close
argument_list|(
literal|1
argument_list|)
expr_stmt|;
name|dup
argument_list|(
name|con_sock
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"HTTP/1.0 200 OK\nContent-type: text/html\n\n\n"
argument_list|)
expr_stmt|;
name|execlp
argument_list|(
name|filename
argument_list|,
name|filename
argument_list|,
name|par
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
name|wait
argument_list|(
operator|&
name|i
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
name|conti
label|:
if|if
condition|(
name|filename
operator|==
name|NULL
condition|)
block|{
name|outerror
argument_list|(
name|rep_err_acc
argument_list|,
name|http1
argument_list|)
expr_stmt|;
goto|goto
name|error
goto|;
block|}
comment|/* interdit les .. dans le path */
name|c
operator|=
name|filename
expr_stmt|;
while|while
condition|(
operator|*
name|c
operator|!=
literal|'\0'
condition|)
if|if
condition|(
name|c
index|[
literal|0
index|]
operator|==
literal|'.'
operator|&&
name|c
index|[
literal|1
index|]
operator|==
literal|'.'
condition|)
block|{
name|outerror
argument_list|(
name|rep_err_acc
argument_list|,
name|http1
argument_list|)
expr_stmt|;
goto|goto
name|error
goto|;
block|}
else|else
name|c
operator|++
expr_stmt|;
name|fd
operator|=
name|open
argument_list|(
name|filename
argument_list|,
name|O_RDONLY
argument_list|)
expr_stmt|;
if|if
condition|(
name|fd
operator|<
literal|0
condition|)
block|{
name|outerror
argument_list|(
name|rep_err_acc
argument_list|,
name|http1
argument_list|)
expr_stmt|;
goto|goto
name|error
goto|;
block|}
if|if
condition|(
name|fstat
argument_list|(
name|fd
argument_list|,
operator|&
name|statres
argument_list|)
operator|<
literal|0
condition|)
block|{
name|outerror
argument_list|(
name|rep_err_acc
argument_list|,
name|http1
argument_list|)
expr_stmt|;
goto|goto
name|error
goto|;
block|}
if|if
condition|(
operator|!
name|S_ISREG
argument_list|(
name|statres
operator|.
name|st_mode
argument_list|)
condition|)
block|{
name|outerror
argument_list|(
name|rep_err_acc
argument_list|,
name|http1
argument_list|)
expr_stmt|;
goto|goto
name|error
goto|;
block|}
if|if
condition|(
name|http1
condition|)
block|{
name|char
name|buff
index|[
literal|50
index|]
decl_stmt|;
name|time_t
name|tl
decl_stmt|;
name|write
argument_list|(
name|con_sock
argument_list|,
name|rep_head
argument_list|,
name|strlen
argument_list|(
name|rep_head
argument_list|)
argument_list|)
expr_stmt|;
name|sprintf
argument_list|(
name|buff
argument_list|,
literal|"Content-length: %d\r\n"
argument_list|,
name|statres
operator|.
name|st_size
argument_list|)
expr_stmt|;
name|write
argument_list|(
name|con_sock
argument_list|,
name|buff
argument_list|,
name|strlen
argument_list|(
name|buff
argument_list|)
argument_list|)
expr_stmt|;
name|outdate
argument_list|()
expr_stmt|;
if|if
condition|(
name|strstr
argument_list|(
name|filename
argument_list|,
literal|"."
argument_list|)
condition|)
block|{
name|strcpy
argument_list|(
name|buff
argument_list|,
literal|"Content-type: "
argument_list|)
expr_stmt|;
name|strcat
argument_list|(
name|buff
argument_list|,
name|strstr
argument_list|(
name|filename
argument_list|,
literal|"."
argument_list|)
operator|+
literal|1
argument_list|)
expr_stmt|;
name|strcat
argument_list|(
name|buff
argument_list|,
literal|"\r\n"
argument_list|)
expr_stmt|;
name|write
argument_list|(
name|con_sock
argument_list|,
name|buff
argument_list|,
name|strlen
argument_list|(
name|buff
argument_list|)
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|strstr
argument_list|(
name|filename
argument_list|,
literal|".txt"
argument_list|)
condition|)
block|{
name|strcpy
argument_list|(
name|buff
argument_list|,
literal|"Content-type: text/plain\r\n"
argument_list|)
expr_stmt|;
name|write
argument_list|(
name|con_sock
argument_list|,
name|buff
argument_list|,
name|strlen
argument_list|(
name|buff
argument_list|)
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|strstr
argument_list|(
name|filename
argument_list|,
literal|".html"
argument_list|)
operator|||
name|strstr
argument_list|(
name|filename
argument_list|,
literal|".htm"
argument_list|)
condition|)
block|{
name|strcpy
argument_list|(
name|buff
argument_list|,
literal|"Content-type: text/html\r\n"
argument_list|)
expr_stmt|;
name|write
argument_list|(
name|con_sock
argument_list|,
name|buff
argument_list|,
name|strlen
argument_list|(
name|buff
argument_list|)
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|strstr
argument_list|(
name|filename
argument_list|,
literal|".gif"
argument_list|)
condition|)
block|{
name|strcpy
argument_list|(
name|buff
argument_list|,
literal|"Content-type: image/gif\r\n"
argument_list|)
expr_stmt|;
name|write
argument_list|(
name|con_sock
argument_list|,
name|buff
argument_list|,
name|strlen
argument_list|(
name|buff
argument_list|)
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|strstr
argument_list|(
name|filename
argument_list|,
literal|".jpg"
argument_list|)
condition|)
block|{
name|strcpy
argument_list|(
name|buff
argument_list|,
literal|"Content-type: image/jpeg\r\n"
argument_list|)
expr_stmt|;
name|write
argument_list|(
name|con_sock
argument_list|,
name|buff
argument_list|,
name|strlen
argument_list|(
name|buff
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|strftime
argument_list|(
name|buff
argument_list|,
literal|50
argument_list|,
literal|"Last-Modified: %a, %d %h %Y %H:%M:%S %Z\r\n\r\n"
argument_list|,
name|gmtime
argument_list|(
operator|&
name|statres
operator|.
name|st_mtime
argument_list|)
argument_list|)
expr_stmt|;
name|write
argument_list|(
name|con_sock
argument_list|,
name|buff
argument_list|,
name|strlen
argument_list|(
name|buff
argument_list|)
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|cmd
operator|==
literal|1
condition|)
block|{
while|while
condition|(
name|lg
operator|=
name|read
argument_list|(
name|fd
argument_list|,
name|buff
argument_list|,
literal|8192
argument_list|)
condition|)
name|write
argument_list|(
name|con_sock
argument_list|,
name|buff
argument_list|,
name|lg
argument_list|)
expr_stmt|;
block|}
name|error
label|:
name|close
argument_list|(
name|fd
argument_list|)
expr_stmt|;
name|close
argument_list|(
name|con_sock
argument_list|)
expr_stmt|;
block|}
end_block

begin_function
name|main
parameter_list|(
name|int
name|argc
parameter_list|,
name|char
modifier|*
modifier|*
name|argv
parameter_list|)
block|{
name|int
name|lg
decl_stmt|;
name|char
name|hello
index|[
literal|100
index|]
decl_stmt|;
if|if
condition|(
name|argc
operator|<
literal|2
operator|&&
name|geteuid
argument_list|()
condition|)
block|{
name|printf
argument_list|(
literal|"Usage: simple_htppd<port>\n"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|argc
operator|>=
literal|2
condition|)
name|http_port
operator|=
name|atoi
argument_list|(
name|argv
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
name|strcpy
argument_list|(
name|homedir
argument_list|,
name|getenv
argument_list|(
literal|"HOME"
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|geteuid
argument_list|()
condition|)
name|strcpy
argument_list|(
name|homedir
argument_list|,
literal|"/httphome"
argument_list|)
expr_stmt|;
else|else
name|strcat
argument_list|(
name|homedir
argument_list|,
literal|"/httphome"
argument_list|)
expr_stmt|;
name|strcpy
argument_list|(
name|hello
argument_list|,
name|homedir
argument_list|)
expr_stmt|;
name|strcat
argument_list|(
name|hello
argument_list|,
literal|"/0hello.html"
argument_list|)
expr_stmt|;
if|if
condition|(
name|chdir
argument_list|(
name|homedir
argument_list|)
condition|)
block|{
name|perror
argument_list|(
literal|"chdir"
argument_list|)
expr_stmt|;
name|puts
argument_list|(
name|homedir
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
name|init_servconnection
argument_list|()
expr_stmt|;
if|if
condition|(
name|fork
argument_list|()
condition|)
name|exit
argument_list|(
literal|0
argument_list|)
expr_stmt|;
name|setpgrp
argument_list|(
literal|0
argument_list|,
literal|65534
argument_list|)
expr_stmt|;
name|signal
argument_list|(
name|SIGQUIT
argument_list|,
name|SIG_IGN
argument_list|)
expr_stmt|;
name|signal
argument_list|(
name|SIGHUP
argument_list|,
name|SIG_IGN
argument_list|)
expr_stmt|;
if|if
condition|(
name|listen
argument_list|(
name|http_sock
argument_list|,
literal|100
argument_list|)
operator|<
literal|0
condition|)
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
name|label
label|:
name|attenteconnection
argument_list|()
expr_stmt|;
if|if
condition|(
name|fork
argument_list|()
condition|)
block|{
name|close
argument_list|(
name|con_sock
argument_list|)
expr_stmt|;
goto|goto
name|label
goto|;
block|}
name|alarm
argument_list|(
literal|1800
argument_list|)
expr_stmt|;
name|traite_req
argument_list|()
expr_stmt|;
name|exit
argument_list|(
literal|0
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|char
modifier|*
name|adate
parameter_list|()
block|{
specifier|static
name|char
name|out
index|[
literal|50
index|]
decl_stmt|;
name|long
name|now
decl_stmt|;
name|struct
name|tm
modifier|*
name|t
decl_stmt|;
name|time
argument_list|(
operator|&
name|now
argument_list|)
expr_stmt|;
name|t
operator|=
name|localtime
argument_list|(
operator|&
name|now
argument_list|)
expr_stmt|;
name|sprintf
argument_list|(
name|out
argument_list|,
literal|"%02d:%02d:%02d %02d/%02d/%02d"
argument_list|,
name|t
operator|->
name|tm_hour
argument_list|,
name|t
operator|->
name|tm_min
argument_list|,
name|t
operator|->
name|tm_sec
argument_list|,
name|t
operator|->
name|tm_mday
argument_list|,
name|t
operator|->
name|tm_mon
operator|+
literal|1
argument_list|,
name|t
operator|->
name|tm_year
argument_list|)
expr_stmt|;
return|return
name|out
return|;
block|}
end_function

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Copyright (c) 1986 Regents of the University of California.  * All rights reserved.  The Berkeley software License Agreement  * specifies the terms and conditions for redistribution.  *  *	@(#)kdb_command.c	7.4 (Berkeley) %G%  */
end_comment

begin_include
include|#
directive|include
file|"../kdb/defs.h"
end_include

begin_decl_stmt
name|char
modifier|*
name|kdbBADEQ
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|char
modifier|*
name|kdbNOMATCH
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|char
modifier|*
name|kdbBADVAR
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|char
modifier|*
name|kdbBADCOM
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|kdbexecuting
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|char
modifier|*
name|kdblp
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|char
name|kdblastc
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|char
name|kdbeqformat
index|[
literal|512
index|]
init|=
literal|"z"
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|char
name|kdbstformat
index|[
literal|512
index|]
init|=
literal|"X\"= \"^i"
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|long
name|kdbditto
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|kdblastcom
init|=
literal|'='
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|long
name|kdblocval
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|long
name|kdblocmsk
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|long
name|kdbexpv
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* command decoding */
end_comment

begin_macro
name|kdbcommand
argument_list|(
argument|buf
argument_list|,
argument|defcom
argument_list|)
end_macro

begin_decl_stmt
name|char
modifier|*
name|buf
decl_stmt|,
name|defcom
decl_stmt|;
end_decl_stmt

begin_block
block|{
specifier|register
name|itype
operator|,
name|ptype
operator|,
name|modifier
operator|,
name|regptr
expr_stmt|;
name|int
name|longpr
decl_stmt|,
name|eqcom
decl_stmt|;
name|char
name|wformat
index|[
literal|1
index|]
decl_stmt|,
name|savc
decl_stmt|;
specifier|register
name|long
name|w
decl_stmt|,
name|savdot
decl_stmt|;
name|char
modifier|*
name|savlp
init|=
name|kdblp
decl_stmt|;
if|if
condition|(
name|buf
condition|)
block|{
if|if
condition|(
operator|*
name|buf
operator|==
name|EOR
condition|)
return|return
operator|(
literal|0
operator|)
return|;
name|kdblp
operator|=
name|buf
expr_stmt|;
block|}
do|do
block|{
if|if
condition|(
name|kdbadrflg
operator|=
name|kdbexpr
argument_list|(
literal|0
argument_list|)
condition|)
block|{
name|kdbdot
operator|=
name|kdbexpv
expr_stmt|;
name|kdbditto
operator|=
name|kdbdot
expr_stmt|;
block|}
name|kdbadrval
operator|=
name|kdbdot
expr_stmt|;
name|kdbcntflg
operator|=
operator|(
name|kdbrdc
argument_list|()
operator|==
literal|','
operator|&&
name|kdbexpr
argument_list|(
literal|0
argument_list|)
operator|)
expr_stmt|;
if|if
condition|(
name|kdbcntflg
condition|)
name|kdbcntval
operator|=
name|kdbexpv
expr_stmt|;
else|else
name|kdbcntval
operator|=
literal|1
operator|,
name|kdblp
operator|--
expr_stmt|;
if|if
condition|(
name|kdbeol
argument_list|(
name|kdbrdc
argument_list|()
argument_list|)
condition|)
block|{
if|if
condition|(
operator|!
name|kdbadrflg
condition|)
name|kdbdot
operator|=
name|kdbinkdot
argument_list|(
name|kdbdotinc
argument_list|)
expr_stmt|;
name|kdblp
operator|--
expr_stmt|;
name|kdblastcom
operator|=
name|defcom
expr_stmt|;
block|}
else|else
name|kdblastcom
operator|=
name|kdblastc
expr_stmt|;
switch|switch
condition|(
name|kdblastcom
operator|&
name|STRIP
condition|)
block|{
case|case
literal|'/'
case|:
name|itype
operator|=
name|DSP
expr_stmt|;
name|ptype
operator|=
name|DSYM
expr_stmt|;
goto|goto
name|trystar
goto|;
case|case
literal|'='
case|:
name|itype
operator|=
name|NSP
expr_stmt|;
name|ptype
operator|=
literal|0
expr_stmt|;
goto|goto
name|trypr
goto|;
case|case
literal|'?'
case|:
name|itype
operator|=
name|ISP
expr_stmt|;
name|ptype
operator|=
name|ISYM
expr_stmt|;
goto|goto
name|trystar
goto|;
name|trystar
label|:
if|if
condition|(
name|kdbrdc
argument_list|()
operator|==
literal|'*'
condition|)
name|kdblastcom
operator||=
name|QUOTE
expr_stmt|;
else|else
name|kdblp
operator|--
expr_stmt|;
if|if
condition|(
name|kdblastcom
operator|&
name|QUOTE
condition|)
block|{
name|itype
operator||=
name|STAR
expr_stmt|;
name|ptype
operator|=
operator|(
name|DSYM
operator|+
name|ISYM
operator|)
operator|-
name|ptype
expr_stmt|;
block|}
name|trypr
label|:
name|longpr
operator|=
literal|0
expr_stmt|;
name|eqcom
operator|=
name|kdblastcom
operator|==
literal|'='
expr_stmt|;
switch|switch
condition|(
name|kdbrdc
argument_list|()
condition|)
block|{
case|case
literal|'L'
case|:
name|longpr
operator|=
literal|1
expr_stmt|;
case|case
literal|'l'
case|:
comment|/*search for exp*/
if|if
condition|(
name|eqcom
condition|)
name|kdberror
argument_list|(
name|kdbBADEQ
argument_list|)
expr_stmt|;
name|kdbdotinc
operator|=
operator|(
name|longpr
condition|?
literal|4
else|:
literal|2
operator|)
expr_stmt|;
name|savdot
operator|=
name|kdbdot
expr_stmt|;
operator|(
name|void
operator|)
name|kdbexpr
argument_list|(
literal|1
argument_list|)
expr_stmt|;
name|kdblocval
operator|=
name|kdbexpv
expr_stmt|;
if|if
condition|(
name|kdbexpr
argument_list|(
literal|0
argument_list|)
condition|)
name|kdblocmsk
operator|=
name|kdbexpv
expr_stmt|;
else|else
name|kdblocmsk
operator|=
operator|-
literal|1L
expr_stmt|;
if|if
condition|(
operator|!
name|longpr
condition|)
block|{
name|kdblocmsk
operator|&=
literal|0xFFFF
expr_stmt|;
name|kdblocval
operator|&=
literal|0xFFFF
expr_stmt|;
block|}
for|for
control|(
init|;
condition|;
control|)
block|{
name|w
operator|=
name|kdbget
argument_list|(
name|kdbdot
argument_list|,
name|itype
argument_list|)
expr_stmt|;
if|if
condition|(
name|kdberrflg
operator|||
name|kdbmkfault
operator|||
operator|(
name|w
operator|&
name|kdblocmsk
operator|)
operator|==
name|kdblocval
condition|)
break|break;
name|kdbdot
operator|=
name|kdbinkdot
argument_list|(
name|kdbdotinc
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|kdberrflg
condition|)
block|{
name|kdbdot
operator|=
name|savdot
expr_stmt|;
name|kdberrflg
operator|=
name|kdbNOMATCH
expr_stmt|;
block|}
name|kdbpsymoff
argument_list|(
name|kdbdot
argument_list|,
name|ptype
argument_list|,
literal|""
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'W'
case|:
name|longpr
operator|=
literal|1
expr_stmt|;
case|case
literal|'w'
case|:
if|if
condition|(
name|eqcom
condition|)
name|kdberror
argument_list|(
name|kdbBADEQ
argument_list|)
expr_stmt|;
name|wformat
index|[
literal|0
index|]
operator|=
name|kdblastc
expr_stmt|;
operator|(
name|void
operator|)
name|kdbexpr
argument_list|(
literal|1
argument_list|)
expr_stmt|;
do|do
block|{
name|savdot
operator|=
name|kdbdot
expr_stmt|;
name|kdbpsymoff
argument_list|(
name|kdbdot
argument_list|,
name|ptype
argument_list|,
literal|":%16t"
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|kdbexform
argument_list|(
literal|1
argument_list|,
name|wformat
argument_list|,
name|itype
argument_list|,
name|ptype
argument_list|)
expr_stmt|;
name|kdberrflg
operator|=
literal|0
expr_stmt|;
name|kdbdot
operator|=
name|savdot
expr_stmt|;
if|if
condition|(
name|longpr
condition|)
name|kdbput
argument_list|(
name|kdbdot
argument_list|,
name|itype
argument_list|,
name|kdbexpv
argument_list|)
expr_stmt|;
else|else
name|kdbput
argument_list|(
name|kdbdot
argument_list|,
name|itype
argument_list|,
name|itol
argument_list|(
name|kdbexpv
argument_list|,
name|kdbget
argument_list|(
name|kdbdot
argument_list|,
name|itype
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
name|savdot
operator|=
name|kdbdot
expr_stmt|;
name|kdbprintf
argument_list|(
literal|"=%8t"
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|kdbexform
argument_list|(
literal|1
argument_list|,
name|wformat
argument_list|,
name|itype
argument_list|,
name|ptype
argument_list|)
expr_stmt|;
name|kdbprintc
argument_list|(
name|EOR
argument_list|)
expr_stmt|;
block|}
do|while
condition|(
name|kdbexpr
argument_list|(
literal|0
argument_list|)
operator|&&
name|kdberrflg
operator|==
literal|0
condition|)
do|;
name|kdbdot
operator|=
name|savdot
expr_stmt|;
name|kdbchkerr
argument_list|()
expr_stmt|;
break|break;
default|default:
name|kdblp
operator|--
expr_stmt|;
name|kdbgetformat
argument_list|(
name|eqcom
condition|?
name|kdbeqformat
else|:
name|kdbstformat
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|eqcom
condition|)
name|kdbpsymoff
argument_list|(
name|kdbdot
argument_list|,
name|ptype
argument_list|,
literal|":%16t"
argument_list|)
expr_stmt|;
name|kdbscanform
argument_list|(
name|kdbcntval
argument_list|,
operator|(
name|eqcom
condition|?
name|kdbeqformat
else|:
name|kdbstformat
operator|)
argument_list|,
name|itype
argument_list|,
name|ptype
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
literal|'>'
case|:
name|kdblastcom
operator|=
literal|0
expr_stmt|;
name|savc
operator|=
name|kdbrdc
argument_list|()
expr_stmt|;
if|if
condition|(
operator|(
name|regptr
operator|=
name|kdbgetreg
argument_list|(
name|savc
argument_list|)
operator|)
operator|!=
operator|-
literal|1
condition|)
operator|*
operator|(
name|int
operator|*
operator|)
name|regptr
operator|=
name|kdbdot
expr_stmt|;
elseif|else
if|if
condition|(
operator|(
name|modifier
operator|=
name|kdbvarchk
argument_list|(
name|savc
argument_list|)
operator|)
operator|!=
operator|-
literal|1
condition|)
name|kdbvar
index|[
name|modifier
index|]
operator|=
name|kdbdot
expr_stmt|;
else|else
name|kdberror
argument_list|(
name|kdbBADVAR
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'$'
case|:
name|kdblastcom
operator|=
literal|0
expr_stmt|;
name|kdbprinttrace
argument_list|(
name|kdbnextchar
argument_list|()
argument_list|)
expr_stmt|;
break|break;
case|case
literal|':'
case|:
if|if
condition|(
name|kdbexecuting
condition|)
break|break;
name|kdbexecuting
operator|=
literal|1
expr_stmt|;
name|kdbsubpcs
argument_list|(
name|kdbnextchar
argument_list|()
argument_list|)
expr_stmt|;
name|kdbexecuting
operator|=
literal|0
expr_stmt|;
name|kdblastcom
operator|=
literal|0
expr_stmt|;
break|break;
case|case
literal|'\0'
case|:
break|break;
default|default:
name|kdberror
argument_list|(
name|kdbBADCOM
argument_list|)
expr_stmt|;
block|}
name|kdbflushbuf
argument_list|()
expr_stmt|;
block|}
do|while
condition|(
name|kdbrdc
argument_list|()
operator|==
literal|';'
condition|)
do|;
if|if
condition|(
name|buf
condition|)
name|kdblp
operator|=
name|savlp
expr_stmt|;
else|else
name|kdblp
operator|--
expr_stmt|;
return|return
operator|(
name|kdbadrflg
operator|&&
name|kdbdot
operator|!=
literal|0
operator|)
return|;
block|}
end_block

end_unit


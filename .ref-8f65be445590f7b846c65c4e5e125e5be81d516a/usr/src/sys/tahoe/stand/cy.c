begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*	cy.c	7.11	90/12/16	*/
end_comment

begin_comment
comment|/*  * Cypher tape driver. Stand alone version.  */
end_comment

begin_include
include|#
directive|include
file|"../include/pte.h"
end_include

begin_include
include|#
directive|include
file|"../include/mtpr.h"
end_include

begin_include
include|#
directive|include
file|"sys/param.h"
end_include

begin_include
include|#
directive|include
file|"sys/time.h"
end_include

begin_include
include|#
directive|include
file|"stand/saio.h"
end_include

begin_define
define|#
directive|define
name|CYERROR
end_define

begin_include
include|#
directive|include
file|"../vba/cyreg.h"
end_include

begin_include
include|#
directive|include
file|"../vba/vbaparam.h"
end_include

begin_comment
comment|/*  * NB: this driver assumes unit 0 throughout.  */
end_comment

begin_decl_stmt
name|long
name|cystd
index|[]
init|=
block|{
literal|0xf4000
block|,
literal|0
block|}
decl_stmt|;
end_decl_stmt

begin_define
define|#
directive|define
name|CYADDR
parameter_list|(
name|i
parameter_list|)
value|(cystd[i] + (int)VBIOBASE)
end_define

begin_decl_stmt
name|struct
name|cyscp
modifier|*
name|cyscp
index|[]
init|=
block|{
operator|(
expr|struct
name|cyscp
operator|*
operator|)
literal|0xc06
block|,
operator|(
expr|struct
name|cyscp
operator|*
operator|)
literal|0
block|}
decl_stmt|;
end_decl_stmt

begin_define
define|#
directive|define
name|CYSCP
parameter_list|(
name|i
parameter_list|)
value|(cyscp[i])
end_define

begin_decl_stmt
name|struct
name|cyscp
modifier|*
name|SCP
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|struct
name|cyscb
name|scb
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|struct
name|cyccb
name|ccb
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|struct
name|cytpb
name|tpb
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|struct
name|cytpb
name|cycool
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* tape parameter block to clear interrupts */
end_comment

begin_ifdef
ifdef|#
directive|ifdef
name|notdef
end_ifdef

begin_decl_stmt
name|int
name|cyblocksize
init|=
literal|1024
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* foreign tape size as found in open routine */
end_comment

begin_endif
endif|#
directive|endif
end_endif

begin_decl_stmt
name|int
name|cybufsize
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* controller buffer size */
end_comment

begin_decl_stmt
name|long
name|cyblock
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* next block number for i/o */
end_comment

begin_comment
comment|/*  * Reset the controller.  */
end_comment

begin_expr_stmt
name|cyopen
argument_list|(
name|io
argument_list|)
specifier|register
expr|struct
name|iob
operator|*
name|io
expr_stmt|;
end_expr_stmt

begin_block
block|{
specifier|register
name|ctlradr
operator|=
name|CYADDR
argument_list|(
literal|0
argument_list|)
expr_stmt|;
specifier|register
name|int
name|skip
decl_stmt|;
if|if
condition|(
operator|(
name|u_int
operator|)
name|io
operator|->
name|i_adapt
condition|)
return|return
operator|(
name|EADAPT
operator|)
return|;
if|if
condition|(
operator|(
name|u_int
operator|)
name|io
operator|->
name|i_ctlr
condition|)
return|return
operator|(
name|ECTLR
operator|)
return|;
name|SCP
operator|=
name|CYSCP
argument_list|(
literal|0
argument_list|)
expr_stmt|;
comment|/* absolute - for setup */
name|CY_RESET
argument_list|(
name|ctlradr
argument_list|)
expr_stmt|;
comment|/* reset the controller */
comment|/* 	 * Initialize the system configuration pointer 	 */
name|SCP
operator|->
name|csp_buswidth
operator|=
literal|1
expr_stmt|;
comment|/* system width = 16 bits. */
name|SCP
operator|->
name|csp_unused
operator|=
literal|0
expr_stmt|;
comment|/* initialize the pointer to the system configuration block */
name|cyldmba
argument_list|(
name|SCP
operator|->
name|csp_scb
argument_list|,
operator|(
name|caddr_t
operator|)
operator|&
name|scb
argument_list|)
expr_stmt|;
comment|/* 	 * Initialize the system configuration block. 	 */
name|scb
operator|.
name|csb_fixed
operator|=
name|CSB_FIXED
expr_stmt|;
comment|/* fixed value */
comment|/* initialize the pointer to the channel control block */
name|cyldmba
argument_list|(
name|scb
operator|.
name|csb_ccb
argument_list|,
operator|(
name|caddr_t
operator|)
operator|&
name|ccb
argument_list|)
expr_stmt|;
comment|/* 	 * Initialize the channel control block. 	 */
name|ccb
operator|.
name|cbcw
operator|=
name|CBCW_IE
expr_stmt|;
comment|/* normal interrupts */
comment|/* initialize the pointer to the tape parameter block */
name|cyldmba
argument_list|(
name|ccb
operator|.
name|cbtpb
argument_list|,
operator|(
name|caddr_t
operator|)
operator|&
name|tpb
argument_list|)
expr_stmt|;
comment|/* 	 * set the command to be CY_NOP. 	 */
name|tpb
operator|.
name|tpcmd
operator|=
name|CY_NOP
expr_stmt|;
comment|/* 	 * TPB not used on first attention 	 */
name|tpb
operator|.
name|tpcontrol
operator|=
name|CYCW_LOCK
operator||
name|CYCW_16BITS
expr_stmt|;
name|ccb
operator|.
name|cbgate
operator|=
name|GATE_CLOSED
expr_stmt|;
name|CY_GO
argument_list|(
name|ctlradr
argument_list|)
expr_stmt|;
comment|/* execute! */
name|cywait
argument_list|(
literal|10
operator|*
literal|1000
argument_list|)
expr_stmt|;
comment|/* 	 * set the command to be CY_CONFIGURE. 	 * NO interrupt on completion. 	 */
name|tpb
operator|.
name|tpcmd
operator|=
name|CY_CONFIG
expr_stmt|;
name|tpb
operator|.
name|tpcontrol
operator|=
name|CYCW_LOCK
operator||
name|CYCW_16BITS
expr_stmt|;
name|tpb
operator|.
name|tpstatus
operator|=
literal|0
expr_stmt|;
name|ccb
operator|.
name|cbgate
operator|=
name|GATE_CLOSED
expr_stmt|;
name|CY_GO
argument_list|(
name|ctlradr
argument_list|)
expr_stmt|;
comment|/* execute! */
name|cywait
argument_list|(
literal|10
operator|*
literal|1000
argument_list|)
expr_stmt|;
name|uncache
argument_list|(
operator|&
name|tpb
operator|.
name|tpstatus
argument_list|)
expr_stmt|;
if|if
condition|(
name|tpb
operator|.
name|tpstatus
operator|&
name|CYS_ERR
condition|)
block|{
name|printf
argument_list|(
literal|"Cypher initialization error!\n"
argument_list|)
expr_stmt|;
name|cy_print_error
argument_list|(
name|tpb
operator|.
name|tpcmd
argument_list|,
name|tpb
operator|.
name|tpstatus
argument_list|)
expr_stmt|;
return|return
operator|(
name|ENXIO
operator|)
return|;
block|}
name|uncache
argument_list|(
operator|&
name|tpb
operator|.
name|tpcount
argument_list|)
expr_stmt|;
name|cybufsize
operator|=
name|tpb
operator|.
name|tpcount
expr_stmt|;
if|if
condition|(
name|cycmd
argument_list|(
name|io
argument_list|,
name|CY_REW
argument_list|)
operator|==
operator|-
literal|1
condition|)
block|{
name|printf
argument_list|(
literal|"cy%d: Rewind failed!\n"
argument_list|,
name|io
operator|->
name|i_unit
argument_list|)
expr_stmt|;
return|return
operator|(
name|ENXIO
operator|)
return|;
block|}
for|for
control|(
name|skip
operator|=
name|io
operator|->
name|i_part
init|;
name|skip
operator|--
condition|;
control|)
if|if
condition|(
name|cycmd
argument_list|(
name|io
argument_list|,
name|CY_FSF
argument_list|)
operator|==
operator|-
literal|1
condition|)
block|{
name|printf
argument_list|(
literal|"cy%d: seek failure!\n"
argument_list|,
name|io
operator|->
name|i_unit
argument_list|)
expr_stmt|;
return|return
operator|(
name|ENXIO
operator|)
return|;
block|}
ifdef|#
directive|ifdef
name|notdef
ifdef|#
directive|ifdef
name|NOBLOCK
if|if
condition|(
name|io
operator|->
name|i_flgs
operator|&
name|F_READ
condition|)
block|{
name|cyblocksize
operator|=
name|cycmd
argument_list|(
name|io
argument_list|,
name|CY_READFORN
argument_list|)
expr_stmt|;
if|if
condition|(
name|cyblocksize
operator|==
operator|-
literal|1
condition|)
name|_stop
argument_list|(
literal|"Read foreign tape failed\n"
argument_list|)
expr_stmt|;
name|cyblock
operator|++
expr_stmt|;
comment|/* XXX force backspace record */
if|if
condition|(
name|cycmd
argument_list|(
name|io
argument_list|,
name|CY_SFORW
argument_list|)
operator|==
operator|-
literal|1
condition|)
name|_stop
argument_list|(
literal|"Backspace after read foreign failed\n"
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
endif|#
directive|endif
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_block

begin_expr_stmt
name|cyclose
argument_list|(
name|io
argument_list|)
specifier|register
expr|struct
name|iob
operator|*
name|io
expr_stmt|;
end_expr_stmt

begin_block
block|{
if|if
condition|(
name|io
operator|->
name|i_flgs
operator|&
name|F_WRITE
condition|)
block|{
comment|/* if writing, write file marks */
name|cycmd
argument_list|(
name|io
argument_list|,
name|CY_WEOF
argument_list|)
expr_stmt|;
name|cycmd
argument_list|(
name|io
argument_list|,
name|CY_WEOF
argument_list|)
expr_stmt|;
block|}
name|cycmd
argument_list|(
name|io
argument_list|,
name|CY_REW
argument_list|)
expr_stmt|;
block|}
end_block

begin_expr_stmt
name|cystrategy
argument_list|(
name|io
argument_list|,
name|func
argument_list|)
specifier|register
expr|struct
name|iob
operator|*
name|io
expr_stmt|;
end_expr_stmt

begin_expr_stmt
specifier|register
name|func
expr_stmt|;
end_expr_stmt

begin_block
block|{
specifier|register
name|count
expr_stmt|;
ifndef|#
directive|ifndef
name|NOBLOCK
if|if
condition|(
name|func
operator|!=
name|CY_SFORW
operator|&&
name|func
operator|!=
name|CY_REW
operator|&&
name|io
operator|->
name|i_bn
operator|!=
name|cyblock
condition|)
block|{
name|cycmd
argument_list|(
name|io
argument_list|,
name|CY_SFORW
argument_list|)
expr_stmt|;
name|tpb
operator|.
name|tprec
operator|=
literal|0
expr_stmt|;
block|}
if|if
condition|(
name|func
operator|==
name|READ
operator|||
name|func
operator|==
name|WRITE
condition|)
block|{
name|struct
name|iob
name|liob
decl_stmt|;
specifier|register
name|struct
name|iob
modifier|*
name|lio
init|=
operator|&
name|liob
decl_stmt|;
name|liob
operator|=
operator|*
name|io
expr_stmt|;
while|while
condition|(
name|lio
operator|->
name|i_cc
operator|>
literal|0
condition|)
block|{
if|if
condition|(
operator|(
name|count
operator|=
name|cycmd
argument_list|(
name|lio
argument_list|,
name|func
argument_list|)
operator|)
operator|==
literal|0
condition|)
block|{
name|printf
argument_list|(
literal|"cy%d: I/O error bn %d\n"
argument_list|,
name|io
operator|->
name|i_unit
argument_list|,
name|io
operator|->
name|i_bn
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
name|lio
operator|->
name|i_cc
operator|-=
name|count
expr_stmt|;
name|lio
operator|->
name|i_ma
operator|+=
name|count
expr_stmt|;
block|}
return|return
operator|(
name|io
operator|->
name|i_cc
operator|)
return|;
block|}
endif|#
directive|endif
name|count
operator|=
name|cycmd
argument_list|(
name|io
argument_list|,
name|func
argument_list|)
expr_stmt|;
if|if
condition|(
name|count
operator|==
operator|-
literal|1
condition|)
name|printf
argument_list|(
literal|"cy%d: I/O error bn %d\n"
argument_list|,
name|io
operator|->
name|i_unit
argument_list|,
name|io
operator|->
name|i_bn
argument_list|)
expr_stmt|;
return|return
operator|(
name|count
operator|)
return|;
block|}
end_block

begin_expr_stmt
name|cycmd
argument_list|(
name|io
argument_list|,
name|func
argument_list|)
specifier|register
expr|struct
name|iob
operator|*
name|io
expr_stmt|;
end_expr_stmt

begin_decl_stmt
name|long
name|func
decl_stmt|;
end_decl_stmt

begin_block
block|{
specifier|register
name|ctlradr
operator|=
name|CYADDR
argument_list|(
literal|0
argument_list|)
expr_stmt|;
name|int
name|timeout
init|=
literal|0
decl_stmt|;
name|int
name|err
decl_stmt|;
name|short
name|j
decl_stmt|;
name|cywait
argument_list|(
literal|9000
argument_list|)
expr_stmt|;
comment|/* shouldn't be needed */
define|#
directive|define
name|PACKUNIT
parameter_list|(
name|unit
parameter_list|)
value|(((unit&1)<<11)|((unit&2)<<9)|((unit&4)>>2))
name|tpb
operator|.
name|tpcontrol
operator|=
name|CYCW_LOCK
operator||
name|CYCW_16BITS
operator||
name|PACKUNIT
argument_list|(
name|io
operator|->
name|i_unit
argument_list|)
expr_stmt|;
name|tpb
operator|.
name|tpstatus
operator|=
literal|0
expr_stmt|;
name|tpb
operator|.
name|tpcount
operator|=
literal|0
expr_stmt|;
name|cyldmba
argument_list|(
name|ccb
operator|.
name|cbtpb
argument_list|,
operator|(
name|caddr_t
operator|)
operator|&
name|tpb
argument_list|)
expr_stmt|;
name|tpb
operator|.
name|tpcmd
operator|=
name|func
expr_stmt|;
switch|switch
condition|(
name|func
condition|)
block|{
case|case
name|READ
case|:
ifdef|#
directive|ifdef
name|notdef
if|if
condition|(
name|io
operator|->
name|i_cc
operator|>
name|cyblocksize
condition|)
name|tpb
operator|.
name|tpsize
operator|=
name|htoms
argument_list|(
name|cyblocksize
argument_list|)
expr_stmt|;
else|else
endif|#
directive|endif
name|tpb
operator|.
name|tpsize
operator|=
name|htoms
argument_list|(
name|io
operator|->
name|i_cc
argument_list|)
expr_stmt|;
name|cyldmba
argument_list|(
name|tpb
operator|.
name|tpdata
argument_list|,
name|io
operator|->
name|i_ma
argument_list|)
expr_stmt|;
name|tpb
operator|.
name|tpcmd
operator|=
name|CY_RCOM
expr_stmt|;
name|cyblock
operator|++
expr_stmt|;
break|break;
case|case
name|WRITE
case|:
name|tpb
operator|.
name|tpcmd
operator|=
name|CY_WCOM
expr_stmt|;
name|tpb
operator|.
name|tpsize
operator|=
name|htoms
argument_list|(
name|io
operator|->
name|i_cc
argument_list|)
expr_stmt|;
name|cyldmba
argument_list|(
name|tpb
operator|.
name|tpdata
argument_list|,
name|io
operator|->
name|i_ma
argument_list|)
expr_stmt|;
name|cyblock
operator|++
expr_stmt|;
break|break;
case|case
name|CY_SFORW
case|:
if|if
condition|(
operator|(
name|j
operator|=
name|io
operator|->
name|i_bn
operator|-
name|cyblock
operator|)
operator|<
literal|0
condition|)
block|{
name|j
operator|=
operator|-
name|j
expr_stmt|;
name|tpb
operator|.
name|tpcontrol
operator||=
name|CYCW_REV
expr_stmt|;
name|cyblock
operator|-=
name|j
expr_stmt|;
block|}
else|else
name|cyblock
operator|+=
name|j
expr_stmt|;
name|tpb
operator|.
name|tprec
operator|=
name|htoms
argument_list|(
name|j
argument_list|)
expr_stmt|;
name|timeout
operator|=
literal|60
operator|*
literal|5
expr_stmt|;
break|break;
case|case
name|CY_FSF
case|:
name|tpb
operator|.
name|tprec
operator|=
name|htoms
argument_list|(
literal|1
argument_list|)
expr_stmt|;
comment|/* fall thru... */
case|case
name|CY_REW
case|:
name|cyblock
operator|=
literal|0
expr_stmt|;
name|timeout
operator|=
literal|60
operator|*
literal|5
expr_stmt|;
break|break;
block|}
name|ccb
operator|.
name|cbgate
operator|=
name|GATE_CLOSED
expr_stmt|;
name|CY_GO
argument_list|(
name|ctlradr
argument_list|)
expr_stmt|;
comment|/* execute! */
if|if
condition|(
name|timeout
operator|==
literal|0
condition|)
name|timeout
operator|=
literal|10
expr_stmt|;
name|cywait
argument_list|(
name|timeout
operator|*
literal|1000
argument_list|)
expr_stmt|;
comment|/* 	 * First we clear the interrupt and close the gate. 	 */
name|mtpr
argument_list|(
name|PADC
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|ccb
operator|.
name|cbgate
operator|=
name|GATE_CLOSED
expr_stmt|;
name|cyldmba
argument_list|(
name|ccb
operator|.
name|cbtpb
argument_list|,
operator|(
name|caddr_t
operator|)
operator|&
name|cycool
argument_list|)
expr_stmt|;
name|cycool
operator|.
name|tpcontrol
operator|=
name|CYCW_LOCK
expr_stmt|;
comment|/* No INTERRUPTS */
name|CY_GO
argument_list|(
name|ctlradr
argument_list|)
expr_stmt|;
name|cywait
argument_list|(
literal|20000
argument_list|)
expr_stmt|;
name|uncache
argument_list|(
operator|&
name|tpb
operator|.
name|tpstatus
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|err
operator|=
operator|(
name|tpb
operator|.
name|tpstatus
operator|&
name|CYS_ERR
operator|)
operator|)
operator|&&
name|err
operator|!=
name|CYER_FM
operator|&&
operator|(
name|err
operator|!=
name|CYER_STROBE
operator|||
name|tpb
operator|.
name|tpcmd
operator|!=
name|CY_RCOM
operator|)
condition|)
block|{
name|cy_print_error
argument_list|(
name|tpb
operator|.
name|tpcmd
argument_list|,
name|tpb
operator|.
name|tpstatus
argument_list|)
expr_stmt|;
name|io
operator|->
name|i_error
operator|=
name|EIO
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
name|uncache
argument_list|(
operator|&
name|tpb
operator|.
name|tpcount
argument_list|)
expr_stmt|;
return|return
operator|(
operator|(
name|int
operator|)
name|htoms
argument_list|(
name|tpb
operator|.
name|tpcount
argument_list|)
operator|)
return|;
block|}
end_block

begin_macro
name|cy_print_error
argument_list|(
argument|op
argument_list|,
argument|status
argument_list|)
end_macro

begin_decl_stmt
name|int
name|op
decl_stmt|,
name|status
decl_stmt|;
end_decl_stmt

begin_block
block|{
specifier|register
name|char
modifier|*
name|message
decl_stmt|;
if|if
condition|(
operator|(
name|status
operator|&
name|CYS_ERR
operator|)
operator|<
name|NCYERROR
condition|)
name|message
operator|=
name|cyerror
index|[
name|status
operator|&
name|CYS_ERR
index|]
expr_stmt|;
else|else
name|message
operator|=
literal|"unknown error"
expr_stmt|;
name|printf
argument_list|(
literal|"cy0: cmd %x %s, status=%b.\n"
argument_list|,
name|op
argument_list|,
name|message
argument_list|,
name|status
argument_list|,
name|CYS_BITS
argument_list|)
expr_stmt|;
block|}
end_block

begin_expr_stmt
name|cywait
argument_list|(
name|timeout
argument_list|)
specifier|register
name|timeout
expr_stmt|;
end_expr_stmt

begin_block
block|{
do|do
block|{
name|DELAY
argument_list|(
literal|1000
argument_list|)
expr_stmt|;
name|uncache
argument_list|(
operator|&
name|ccb
operator|.
name|cbgate
argument_list|)
expr_stmt|;
block|}
do|while
condition|(
name|ccb
operator|.
name|cbgate
operator|!=
name|GATE_OPEN
operator|&&
operator|--
name|timeout
operator|>
literal|0
condition|)
do|;
if|if
condition|(
name|timeout
operator|<=
literal|0
condition|)
name|_stop
argument_list|(
literal|"cy: Transfer timeout"
argument_list|)
expr_stmt|;
block|}
end_block

begin_comment
comment|/*  * Load a 20 bit pointer into a Tapemaster pointer.  */
end_comment

begin_expr_stmt
name|cyldmba
argument_list|(
name|reg
argument_list|,
name|value
argument_list|)
specifier|register
name|caddr_t
name|reg
expr_stmt|;
end_expr_stmt

begin_decl_stmt
name|caddr_t
name|value
decl_stmt|;
end_decl_stmt

begin_block
block|{
specifier|register
name|int
name|v
init|=
operator|(
name|int
operator|)
name|value
decl_stmt|;
operator|*
name|reg
operator|++
operator|=
name|v
expr_stmt|;
operator|*
name|reg
operator|++
operator|=
name|v
operator|>>
literal|8
expr_stmt|;
operator|*
name|reg
operator|++
operator|=
literal|0
expr_stmt|;
operator|*
name|reg
operator|=
operator|(
name|v
operator|&
literal|0xf0000
operator|)
operator|>>
literal|12
expr_stmt|;
block|}
end_block

end_unit


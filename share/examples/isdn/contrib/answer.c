begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|// $FreeBSD$
end_comment

begin_comment
comment|// changed ".g711a" to ".al" (-hm)
end_comment

begin_comment
comment|// Tue Mar  3 02:42:14 MET 1998 	dave@turbocat.de
end_comment

begin_comment
comment|// started
end_comment

begin_define
define|#
directive|define
name|BLK_SIZE
value|2048
end_define

begin_define
define|#
directive|define
name|SOX
value|"/usr/local/bin/sox"
end_define

begin_define
define|#
directive|define
name|ALAWULAW
value|"/usr/local/bin/alaw2ulaw"
end_define

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_include
include|#
directive|include
file|<time.h>
end_include

begin_decl_stmt
name|FILE
modifier|*
name|device
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|FILE
modifier|*
name|logfile
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|char
name|srcNum
index|[
literal|30
index|]
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|char
name|destNum
index|[
literal|30
index|]
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|char
name|argbuf
index|[
literal|255
index|]
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|char
name|tmpBuf
index|[
literal|1024
index|]
init|=
literal|""
decl_stmt|;
end_decl_stmt

begin_function
name|void
name|writeToPhone
parameter_list|(
name|char
modifier|*
name|path
parameter_list|)
block|{
name|char
name|buf
index|[
name|BLK_SIZE
index|]
decl_stmt|;
name|FILE
modifier|*
name|srcfile
decl_stmt|;
name|int
name|i
init|=
literal|0
decl_stmt|;
name|int
name|readcount
init|=
literal|0
decl_stmt|;
name|srcfile
operator|=
name|fopen
argument_list|(
name|path
argument_list|,
literal|"r"
argument_list|)
expr_stmt|;
if|if
condition|(
name|srcfile
condition|)
block|{
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|BLK_SIZE
condition|;
name|i
operator|++
control|)
block|{
name|buf
index|[
name|i
index|]
operator|=
literal|'\0'
expr_stmt|;
block|}
name|readcount
operator|=
name|BLK_SIZE
expr_stmt|;
name|i
operator|=
literal|0
expr_stmt|;
do|do
block|{
name|readcount
operator|=
name|fread
argument_list|(
name|buf
argument_list|,
literal|1
argument_list|,
name|BLK_SIZE
argument_list|,
name|srcfile
argument_list|)
expr_stmt|;
name|fwrite
argument_list|(
name|buf
argument_list|,
literal|1
argument_list|,
name|readcount
argument_list|,
name|device
argument_list|)
expr_stmt|;
name|i
operator|=
name|readcount
operator|+
name|i
expr_stmt|;
comment|//			fprintf(logfile,"%d read (%d)\n",i,readcount);
block|}
do|while
condition|(
name|readcount
operator|==
name|BLK_SIZE
condition|)
do|;
name|fclose
argument_list|(
name|srcfile
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|fprintf
argument_list|(
name|logfile
argument_list|,
literal|"Can't open file '%s'\n"
argument_list|,
name|path
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
name|void
name|readFromPhone
parameter_list|(
name|char
modifier|*
name|path
parameter_list|)
block|{
name|char
name|buf
index|[
name|BLK_SIZE
index|]
decl_stmt|;
name|FILE
modifier|*
name|destfile
decl_stmt|;
name|int
name|i
init|=
literal|0
decl_stmt|;
name|int
name|readcount
init|=
literal|0
decl_stmt|;
name|destfile
operator|=
name|fopen
argument_list|(
name|path
argument_list|,
literal|"a"
argument_list|)
expr_stmt|;
if|if
condition|(
name|destfile
condition|)
block|{
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|BLK_SIZE
condition|;
name|i
operator|++
control|)
block|{
name|buf
index|[
name|i
index|]
operator|=
literal|'\0'
expr_stmt|;
block|}
name|readcount
operator|=
name|BLK_SIZE
expr_stmt|;
name|i
operator|=
literal|0
expr_stmt|;
do|do
block|{
name|readcount
operator|=
name|fread
argument_list|(
name|buf
argument_list|,
literal|1
argument_list|,
name|BLK_SIZE
argument_list|,
name|device
argument_list|)
expr_stmt|;
name|fwrite
argument_list|(
name|buf
argument_list|,
literal|1
argument_list|,
name|readcount
argument_list|,
name|destfile
argument_list|)
expr_stmt|;
name|i
operator|=
name|readcount
operator|+
name|i
expr_stmt|;
comment|//			fprintf(logfile,"%d read (%d)\n",i,readcount);
block|}
do|while
condition|(
name|readcount
operator|==
name|BLK_SIZE
condition|)
do|;
name|fclose
argument_list|(
name|destfile
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|fprintf
argument_list|(
name|logfile
argument_list|,
literal|"Can't open file '%s'\n"
argument_list|,
name|path
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
name|void
name|usage
parameter_list|(
name|void
parameter_list|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Usage: answer -D device -d destination -s source\n"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|const
name|char
modifier|*
name|argWithName
parameter_list|(
specifier|const
name|char
modifier|*
name|aName
parameter_list|)
block|{
comment|// '-D /dev/null -d 82834 -s 3305682834'
name|int
name|i
init|=
literal|0
decl_stmt|;
name|int
name|optionSeen
init|=
literal|0
decl_stmt|;
name|int
name|startpos
init|=
literal|0
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
sizeof|sizeof
argument_list|(
name|tmpBuf
argument_list|)
condition|;
name|i
operator|++
control|)
block|{
name|tmpBuf
index|[
name|i
index|]
operator|=
literal|'\0'
expr_stmt|;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|strlen
argument_list|(
name|argbuf
argument_list|)
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|optionSeen
condition|)
block|{
for|for
control|(
init|;
operator|(
name|i
operator|<
name|strlen
argument_list|(
name|argbuf
argument_list|)
operator|&&
operator|(
name|argbuf
index|[
name|i
index|]
operator|!=
literal|' '
operator|)
operator|)
condition|;
name|i
operator|++
control|)
block|{ 			}
name|i
operator|++
expr_stmt|;
name|startpos
operator|=
name|i
expr_stmt|;
for|for
control|(
init|;
operator|(
name|i
operator|<
name|strlen
argument_list|(
name|argbuf
argument_list|)
operator|&&
operator|(
name|argbuf
index|[
name|i
index|]
operator|!=
literal|' '
operator|)
operator|)
condition|;
name|i
operator|++
control|)
block|{ 			}
name|strncpy
argument_list|(
name|tmpBuf
argument_list|,
operator|&
name|argbuf
index|[
name|startpos
index|]
argument_list|,
name|i
operator|-
name|startpos
argument_list|)
expr_stmt|;
return|return
name|tmpBuf
return|;
block|}
if|if
condition|(
literal|0
operator|==
name|strncmp
argument_list|(
name|aName
argument_list|,
operator|&
name|argbuf
index|[
name|i
index|]
argument_list|,
name|strlen
argument_list|(
name|aName
argument_list|)
argument_list|)
condition|)
block|{
name|optionSeen
operator|=
literal|1
expr_stmt|;
block|}
block|}
name|usage
argument_list|()
expr_stmt|;
return|return
name|NULL
return|;
block|}
end_function

begin_function
name|int
name|main
parameter_list|(
name|int
name|argc
parameter_list|,
specifier|const
name|char
modifier|*
name|argv
index|[]
parameter_list|)
block|{
name|int
name|i
decl_stmt|,
name|pos
init|=
literal|0
decl_stmt|;
specifier|extern
name|char
modifier|*
name|optarg
decl_stmt|;
specifier|extern
name|int
name|optind
decl_stmt|;
name|int
name|bflag
decl_stmt|,
name|ch
decl_stmt|;
name|char
name|timeStr
index|[
literal|50
index|]
decl_stmt|;
name|char
name|outfileName
index|[
literal|1024
index|]
init|=
literal|""
decl_stmt|;
name|char
name|cmdStr
index|[
literal|2048
index|]
init|=
literal|""
decl_stmt|;
name|time_t
name|now
decl_stmt|;
name|now
operator|=
name|time
argument_list|(
name|NULL
argument_list|)
expr_stmt|;
name|strftime
argument_list|(
name|timeStr
argument_list|,
literal|40
argument_list|,
name|I4B_TIME_FORMAT
argument_list|,
name|localtime
argument_list|(
operator|&
name|now
argument_list|)
argument_list|)
expr_stmt|;
name|logfile
operator|=
name|fopen
argument_list|(
literal|"/var/log/answer.log"
argument_list|,
literal|"a"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|logfile
argument_list|,
literal|"%s Started\n"
argument_list|,
name|timeStr
argument_list|)
expr_stmt|;
name|pos
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|1
init|;
name|i
operator|<
name|argc
condition|;
name|i
operator|++
control|)
block|{
name|sprintf
argument_list|(
operator|&
name|argbuf
index|[
name|strlen
argument_list|(
name|argbuf
argument_list|)
index|]
argument_list|,
literal|"%s "
argument_list|,
name|argv
index|[
name|i
index|]
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|strlen
argument_list|(
name|argbuf
argument_list|)
operator|>
literal|2
condition|)
block|{
name|argbuf
index|[
name|strlen
argument_list|(
name|argbuf
argument_list|)
operator|-
literal|1
index|]
operator|=
literal|'\0'
expr_stmt|;
block|}
name|device
operator|=
name|fopen
argument_list|(
name|argWithName
argument_list|(
literal|"-D"
argument_list|)
argument_list|,
literal|"r+"
argument_list|)
expr_stmt|;
name|strcpy
argument_list|(
name|destNum
argument_list|,
name|argWithName
argument_list|(
literal|"-d"
argument_list|)
argument_list|)
expr_stmt|;
name|strcpy
argument_list|(
name|srcNum
argument_list|,
name|argWithName
argument_list|(
literal|"-s"
argument_list|)
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|logfile
argument_list|,
literal|"device '%s'\n"
argument_list|,
name|argWithName
argument_list|(
literal|"-D"
argument_list|)
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|logfile
argument_list|,
literal|"srcNum '%s'\n"
argument_list|,
name|srcNum
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|logfile
argument_list|,
literal|"destNum '%s'\n"
argument_list|,
name|destNum
argument_list|)
expr_stmt|;
if|if
condition|(
name|device
condition|)
block|{
name|strftime
argument_list|(
name|timeStr
argument_list|,
literal|40
argument_list|,
name|I4B_TIME_FORMAT
argument_list|,
name|localtime
argument_list|(
operator|&
name|now
argument_list|)
argument_list|)
expr_stmt|;
name|sprintf
argument_list|(
name|outfileName
argument_list|,
literal|"/var/isdn/%s_%s_%s"
argument_list|,
name|timeStr
argument_list|,
name|srcNum
argument_list|,
name|destNum
argument_list|)
expr_stmt|;
name|writeToPhone
argument_list|(
literal|"/usr/local/lib/isdn/msg.al"
argument_list|)
expr_stmt|;
name|readFromPhone
argument_list|(
name|outfileName
argument_list|)
expr_stmt|;
name|sprintf
argument_list|(
name|cmdStr
argument_list|,
literal|"/bin/cat %s | %s | %s -t raw -U -b -r 8000 - -t .au %s.snd"
argument_list|,
name|outfileName
argument_list|,
name|ALAWULAW
argument_list|,
name|SOX
argument_list|,
name|outfileName
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|logfile
argument_list|,
literal|"%s\n"
argument_list|,
name|cmdStr
argument_list|)
expr_stmt|;
name|system
argument_list|(
name|cmdStr
argument_list|)
expr_stmt|;
name|unlink
argument_list|(
name|outfileName
argument_list|)
expr_stmt|;
name|fclose
argument_list|(
name|device
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|fprintf
argument_list|(
name|logfile
argument_list|,
literal|"Can't open file '%s'\n"
argument_list|,
name|argWithName
argument_list|(
literal|"-D"
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|now
operator|=
name|time
argument_list|(
name|NULL
argument_list|)
expr_stmt|;
name|strftime
argument_list|(
name|timeStr
argument_list|,
literal|40
argument_list|,
name|I4B_TIME_FORMAT
argument_list|,
name|localtime
argument_list|(
operator|&
name|now
argument_list|)
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|logfile
argument_list|,
literal|"%s Done\n"
argument_list|,
name|timeStr
argument_list|)
expr_stmt|;
name|fclose
argument_list|(
name|logfile
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|0
argument_list|)
expr_stmt|;
comment|// insure the process exit status is 0
return|return
literal|0
return|;
comment|// ...and make main fit the ANSI spec.
block|}
end_function

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Copyright (c) 1997 - 2006 Kungliga Tekniska HÃ¶gskolan  * (Royal Institute of Technology, Stockholm, Sweden).   * All rights reserved.   *  * Redistribution and use in source and binary forms, with or without   * modification, are permitted provided that the following conditions   * are met:   *  * 1. Redistributions of source code must retain the above copyright   *    notice, this list of conditions and the following disclaimer.   *  * 2. Redistributions in binary form must reproduce the above copyright   *    notice, this list of conditions and the following disclaimer in the   *    documentation and/or other materials provided with the distribution.   *  * 3. Neither the name of the Institute nor the names of its contributors   *    may be used to endorse or promote products derived from this software   *    without specific prior written permission.   *  * THIS SOFTWARE IS PROVIDED BY THE INSTITUTE AND CONTRIBUTORS ``AS IS'' AND   * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE   * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE   * ARE DISCLAIMED.  IN NO EVENT SHALL THE INSTITUTE OR CONTRIBUTORS BE LIABLE   * FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL   * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS   * OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)   * HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT   * LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY   * OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF   * SUCH DAMAGE.   */
end_comment

begin_include
include|#
directive|include
file|"kdc_locl.h"
end_include

begin_include
include|#
directive|include
file|<krb5-v4compat.h>
end_include

begin_expr_stmt
name|RCSID
argument_list|(
literal|"$Id: kerberos4.c 21577 2007-07-16 08:14:06Z lha $"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_ifndef
ifndef|#
directive|ifndef
name|swap32
end_ifndef

begin_function
specifier|static
name|uint32_t
name|swap32
parameter_list|(
name|uint32_t
name|x
parameter_list|)
block|{
return|return
operator|(
operator|(
name|x
operator|<<
literal|24
operator|)
operator|&
literal|0xff000000
operator|)
operator||
operator|(
operator|(
name|x
operator|<<
literal|8
operator|)
operator|&
literal|0xff0000
operator|)
operator||
operator|(
operator|(
name|x
operator|>>
literal|8
operator|)
operator|&
literal|0xff00
operator|)
operator||
operator|(
operator|(
name|x
operator|>>
literal|24
operator|)
operator|&
literal|0xff
operator|)
return|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* swap32 */
end_comment

begin_function
name|int
name|_kdc_maybe_version4
parameter_list|(
name|unsigned
name|char
modifier|*
name|buf
parameter_list|,
name|int
name|len
parameter_list|)
block|{
return|return
name|len
operator|>
literal|0
operator|&&
operator|*
name|buf
operator|==
literal|4
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|make_err_reply
parameter_list|(
name|krb5_context
name|context
parameter_list|,
name|krb5_data
modifier|*
name|reply
parameter_list|,
name|int
name|code
parameter_list|,
specifier|const
name|char
modifier|*
name|msg
parameter_list|)
block|{
name|_krb5_krb_cr_err_reply
argument_list|(
name|context
argument_list|,
literal|""
argument_list|,
literal|""
argument_list|,
literal|""
argument_list|,
name|kdc_time
argument_list|,
name|code
argument_list|,
name|msg
argument_list|,
name|reply
argument_list|)
expr_stmt|;
block|}
end_function

begin_struct
struct|struct
name|valid_princ_ctx
block|{
name|krb5_kdc_configuration
modifier|*
name|config
decl_stmt|;
name|unsigned
name|flags
decl_stmt|;
block|}
struct|;
end_struct

begin_function
specifier|static
name|krb5_boolean
name|valid_princ
parameter_list|(
name|krb5_context
name|context
parameter_list|,
name|void
modifier|*
name|funcctx
parameter_list|,
name|krb5_principal
name|princ
parameter_list|)
block|{
name|struct
name|valid_princ_ctx
modifier|*
name|ctx
init|=
name|funcctx
decl_stmt|;
name|krb5_error_code
name|ret
decl_stmt|;
name|char
modifier|*
name|s
decl_stmt|;
name|hdb_entry_ex
modifier|*
name|ent
decl_stmt|;
name|ret
operator|=
name|krb5_unparse_name
argument_list|(
name|context
argument_list|,
name|princ
argument_list|,
operator|&
name|s
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
return|return
name|FALSE
return|;
name|ret
operator|=
name|_kdc_db_fetch
argument_list|(
name|context
argument_list|,
name|ctx
operator|->
name|config
argument_list|,
name|princ
argument_list|,
name|ctx
operator|->
name|flags
argument_list|,
name|NULL
argument_list|,
operator|&
name|ent
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|kdc_log
argument_list|(
name|context
argument_list|,
name|ctx
operator|->
name|config
argument_list|,
literal|7
argument_list|,
literal|"Lookup %s failed: %s"
argument_list|,
name|s
argument_list|,
name|krb5_get_err_text
argument_list|(
name|context
argument_list|,
name|ret
argument_list|)
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|s
argument_list|)
expr_stmt|;
return|return
name|FALSE
return|;
block|}
name|kdc_log
argument_list|(
name|context
argument_list|,
name|ctx
operator|->
name|config
argument_list|,
literal|7
argument_list|,
literal|"Lookup %s succeeded"
argument_list|,
name|s
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|s
argument_list|)
expr_stmt|;
name|_kdc_free_ent
argument_list|(
name|context
argument_list|,
name|ent
argument_list|)
expr_stmt|;
return|return
name|TRUE
return|;
block|}
end_function

begin_function
name|krb5_error_code
name|_kdc_db_fetch4
parameter_list|(
name|krb5_context
name|context
parameter_list|,
name|krb5_kdc_configuration
modifier|*
name|config
parameter_list|,
specifier|const
name|char
modifier|*
name|name
parameter_list|,
specifier|const
name|char
modifier|*
name|instance
parameter_list|,
specifier|const
name|char
modifier|*
name|realm
parameter_list|,
name|unsigned
name|flags
parameter_list|,
name|hdb_entry_ex
modifier|*
modifier|*
name|ent
parameter_list|)
block|{
name|krb5_principal
name|p
decl_stmt|;
name|krb5_error_code
name|ret
decl_stmt|;
name|struct
name|valid_princ_ctx
name|ctx
decl_stmt|;
name|ctx
operator|.
name|config
operator|=
name|config
expr_stmt|;
name|ctx
operator|.
name|flags
operator|=
name|flags
expr_stmt|;
name|ret
operator|=
name|krb5_425_conv_principal_ext2
argument_list|(
name|context
argument_list|,
name|name
argument_list|,
name|instance
argument_list|,
name|realm
argument_list|,
name|valid_princ
argument_list|,
operator|&
name|ctx
argument_list|,
literal|0
argument_list|,
operator|&
name|p
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
return|return
name|ret
return|;
name|ret
operator|=
name|_kdc_db_fetch
argument_list|(
name|context
argument_list|,
name|config
argument_list|,
name|p
argument_list|,
name|flags
argument_list|,
name|NULL
argument_list|,
name|ent
argument_list|)
expr_stmt|;
name|krb5_free_principal
argument_list|(
name|context
argument_list|,
name|p
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_define
define|#
directive|define
name|RCHECK
parameter_list|(
name|X
parameter_list|,
name|L
parameter_list|)
value|if(X){make_err_reply(context, reply, KFAILURE, "Packet too short"); goto L;}
end_define

begin_comment
comment|/*  * Process the v4 request in `buf, len' (received from `addr'  * (with string `from').  * Return an error code and a reply in `reply'.  */
end_comment

begin_function
name|krb5_error_code
name|_kdc_do_version4
parameter_list|(
name|krb5_context
name|context
parameter_list|,
name|krb5_kdc_configuration
modifier|*
name|config
parameter_list|,
name|unsigned
name|char
modifier|*
name|buf
parameter_list|,
name|size_t
name|len
parameter_list|,
name|krb5_data
modifier|*
name|reply
parameter_list|,
specifier|const
name|char
modifier|*
name|from
parameter_list|,
name|struct
name|sockaddr_in
modifier|*
name|addr
parameter_list|)
block|{
name|krb5_storage
modifier|*
name|sp
decl_stmt|;
name|krb5_error_code
name|ret
decl_stmt|;
name|hdb_entry_ex
modifier|*
name|client
init|=
name|NULL
decl_stmt|,
modifier|*
name|server
init|=
name|NULL
decl_stmt|;
name|Key
modifier|*
name|ckey
decl_stmt|,
modifier|*
name|skey
decl_stmt|;
name|int8_t
name|pvno
decl_stmt|;
name|int8_t
name|msg_type
decl_stmt|;
name|int
name|lsb
decl_stmt|;
name|char
modifier|*
name|name
init|=
name|NULL
decl_stmt|,
modifier|*
name|inst
init|=
name|NULL
decl_stmt|,
modifier|*
name|realm
init|=
name|NULL
decl_stmt|;
name|char
modifier|*
name|sname
init|=
name|NULL
decl_stmt|,
modifier|*
name|sinst
init|=
name|NULL
decl_stmt|;
name|int32_t
name|req_time
decl_stmt|;
name|time_t
name|max_life
decl_stmt|;
name|uint8_t
name|life
decl_stmt|;
name|char
name|client_name
index|[
literal|256
index|]
decl_stmt|;
name|char
name|server_name
index|[
literal|256
index|]
decl_stmt|;
if|if
condition|(
operator|!
name|config
operator|->
name|enable_v4
condition|)
block|{
name|kdc_log
argument_list|(
name|context
argument_list|,
name|config
argument_list|,
literal|0
argument_list|,
literal|"Rejected version 4 request from %s"
argument_list|,
name|from
argument_list|)
expr_stmt|;
name|make_err_reply
argument_list|(
name|context
argument_list|,
name|reply
argument_list|,
name|KRB4ET_KDC_GEN_ERR
argument_list|,
literal|"Function not enabled"
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
name|sp
operator|=
name|krb5_storage_from_mem
argument_list|(
name|buf
argument_list|,
name|len
argument_list|)
expr_stmt|;
name|RCHECK
argument_list|(
name|krb5_ret_int8
argument_list|(
name|sp
argument_list|,
operator|&
name|pvno
argument_list|)
argument_list|,
name|out
argument_list|)
expr_stmt|;
if|if
condition|(
name|pvno
operator|!=
literal|4
condition|)
block|{
name|kdc_log
argument_list|(
name|context
argument_list|,
name|config
argument_list|,
literal|0
argument_list|,
literal|"Protocol version mismatch (krb4) (%d)"
argument_list|,
name|pvno
argument_list|)
expr_stmt|;
name|make_err_reply
argument_list|(
name|context
argument_list|,
name|reply
argument_list|,
name|KRB4ET_KDC_PKT_VER
argument_list|,
literal|"protocol mismatch"
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
name|RCHECK
argument_list|(
name|krb5_ret_int8
argument_list|(
name|sp
argument_list|,
operator|&
name|msg_type
argument_list|)
argument_list|,
name|out
argument_list|)
expr_stmt|;
name|lsb
operator|=
name|msg_type
operator|&
literal|1
expr_stmt|;
name|msg_type
operator|&=
operator|~
literal|1
expr_stmt|;
switch|switch
condition|(
name|msg_type
condition|)
block|{
case|case
name|AUTH_MSG_KDC_REQUEST
case|:
block|{
name|krb5_data
name|ticket
decl_stmt|,
name|cipher
decl_stmt|;
name|krb5_keyblock
name|session
decl_stmt|;
name|krb5_data_zero
argument_list|(
operator|&
name|ticket
argument_list|)
expr_stmt|;
name|krb5_data_zero
argument_list|(
operator|&
name|cipher
argument_list|)
expr_stmt|;
name|RCHECK
argument_list|(
name|krb5_ret_stringz
argument_list|(
name|sp
argument_list|,
operator|&
name|name
argument_list|)
argument_list|,
name|out1
argument_list|)
expr_stmt|;
name|RCHECK
argument_list|(
name|krb5_ret_stringz
argument_list|(
name|sp
argument_list|,
operator|&
name|inst
argument_list|)
argument_list|,
name|out1
argument_list|)
expr_stmt|;
name|RCHECK
argument_list|(
name|krb5_ret_stringz
argument_list|(
name|sp
argument_list|,
operator|&
name|realm
argument_list|)
argument_list|,
name|out1
argument_list|)
expr_stmt|;
name|RCHECK
argument_list|(
name|krb5_ret_int32
argument_list|(
name|sp
argument_list|,
operator|&
name|req_time
argument_list|)
argument_list|,
name|out1
argument_list|)
expr_stmt|;
if|if
condition|(
name|lsb
condition|)
name|req_time
operator|=
name|swap32
argument_list|(
name|req_time
argument_list|)
expr_stmt|;
name|RCHECK
argument_list|(
name|krb5_ret_uint8
argument_list|(
name|sp
argument_list|,
operator|&
name|life
argument_list|)
argument_list|,
name|out1
argument_list|)
expr_stmt|;
name|RCHECK
argument_list|(
name|krb5_ret_stringz
argument_list|(
name|sp
argument_list|,
operator|&
name|sname
argument_list|)
argument_list|,
name|out1
argument_list|)
expr_stmt|;
name|RCHECK
argument_list|(
name|krb5_ret_stringz
argument_list|(
name|sp
argument_list|,
operator|&
name|sinst
argument_list|)
argument_list|,
name|out1
argument_list|)
expr_stmt|;
name|snprintf
argument_list|(
name|client_name
argument_list|,
sizeof|sizeof
argument_list|(
name|client_name
argument_list|)
argument_list|,
literal|"%s.%s@%s"
argument_list|,
name|name
argument_list|,
name|inst
argument_list|,
name|realm
argument_list|)
expr_stmt|;
name|snprintf
argument_list|(
name|server_name
argument_list|,
sizeof|sizeof
argument_list|(
name|server_name
argument_list|)
argument_list|,
literal|"%s.%s@%s"
argument_list|,
name|sname
argument_list|,
name|sinst
argument_list|,
name|config
operator|->
name|v4_realm
argument_list|)
expr_stmt|;
name|kdc_log
argument_list|(
name|context
argument_list|,
name|config
argument_list|,
literal|0
argument_list|,
literal|"AS-REQ (krb4) %s from %s for %s"
argument_list|,
name|client_name
argument_list|,
name|from
argument_list|,
name|server_name
argument_list|)
expr_stmt|;
name|ret
operator|=
name|_kdc_db_fetch4
argument_list|(
name|context
argument_list|,
name|config
argument_list|,
name|name
argument_list|,
name|inst
argument_list|,
name|realm
argument_list|,
name|HDB_F_GET_CLIENT
argument_list|,
operator|&
name|client
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|kdc_log
argument_list|(
name|context
argument_list|,
name|config
argument_list|,
literal|0
argument_list|,
literal|"Client not found in database: %s: %s"
argument_list|,
name|client_name
argument_list|,
name|krb5_get_err_text
argument_list|(
name|context
argument_list|,
name|ret
argument_list|)
argument_list|)
expr_stmt|;
name|make_err_reply
argument_list|(
name|context
argument_list|,
name|reply
argument_list|,
name|KRB4ET_KDC_PR_UNKNOWN
argument_list|,
literal|"principal unknown"
argument_list|)
expr_stmt|;
goto|goto
name|out1
goto|;
block|}
name|ret
operator|=
name|_kdc_db_fetch4
argument_list|(
name|context
argument_list|,
name|config
argument_list|,
name|sname
argument_list|,
name|sinst
argument_list|,
name|config
operator|->
name|v4_realm
argument_list|,
name|HDB_F_GET_SERVER
argument_list|,
operator|&
name|server
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|kdc_log
argument_list|(
name|context
argument_list|,
name|config
argument_list|,
literal|0
argument_list|,
literal|"Server not found in database: %s: %s"
argument_list|,
name|server_name
argument_list|,
name|krb5_get_err_text
argument_list|(
name|context
argument_list|,
name|ret
argument_list|)
argument_list|)
expr_stmt|;
name|make_err_reply
argument_list|(
name|context
argument_list|,
name|reply
argument_list|,
name|KRB4ET_KDC_PR_UNKNOWN
argument_list|,
literal|"principal unknown"
argument_list|)
expr_stmt|;
goto|goto
name|out1
goto|;
block|}
name|ret
operator|=
name|_kdc_check_flags
argument_list|(
name|context
argument_list|,
name|config
argument_list|,
name|client
argument_list|,
name|client_name
argument_list|,
name|server
argument_list|,
name|server_name
argument_list|,
name|TRUE
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
comment|/* good error code? */
name|make_err_reply
argument_list|(
name|context
argument_list|,
name|reply
argument_list|,
name|KRB4ET_KDC_NAME_EXP
argument_list|,
literal|"operation not allowed"
argument_list|)
expr_stmt|;
goto|goto
name|out1
goto|;
block|}
if|if
condition|(
name|config
operator|->
name|enable_v4_per_principal
operator|&&
name|client
operator|->
name|entry
operator|.
name|flags
operator|.
name|allow_kerberos4
operator|==
literal|0
condition|)
block|{
name|kdc_log
argument_list|(
name|context
argument_list|,
name|config
argument_list|,
literal|0
argument_list|,
literal|"Per principal Kerberos 4 flag not turned on for %s"
argument_list|,
name|client_name
argument_list|)
expr_stmt|;
name|make_err_reply
argument_list|(
name|context
argument_list|,
name|reply
argument_list|,
name|KRB4ET_KDC_NULL_KEY
argument_list|,
literal|"allow kerberos4 flag required"
argument_list|)
expr_stmt|;
goto|goto
name|out1
goto|;
block|}
comment|/* 	 * There's no way to do pre-authentication in v4 and thus no 	 * good error code to return if preauthentication is required. 	 */
if|if
condition|(
name|config
operator|->
name|require_preauth
operator|||
name|client
operator|->
name|entry
operator|.
name|flags
operator|.
name|require_preauth
operator|||
name|server
operator|->
name|entry
operator|.
name|flags
operator|.
name|require_preauth
condition|)
block|{
name|kdc_log
argument_list|(
name|context
argument_list|,
name|config
argument_list|,
literal|0
argument_list|,
literal|"Pre-authentication required for v4-request: "
literal|"%s for %s"
argument_list|,
name|client_name
argument_list|,
name|server_name
argument_list|)
expr_stmt|;
name|make_err_reply
argument_list|(
name|context
argument_list|,
name|reply
argument_list|,
name|KRB4ET_KDC_NULL_KEY
argument_list|,
literal|"preauth required"
argument_list|)
expr_stmt|;
goto|goto
name|out1
goto|;
block|}
name|ret
operator|=
name|_kdc_get_des_key
argument_list|(
name|context
argument_list|,
name|client
argument_list|,
name|FALSE
argument_list|,
name|FALSE
argument_list|,
operator|&
name|ckey
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|kdc_log
argument_list|(
name|context
argument_list|,
name|config
argument_list|,
literal|0
argument_list|,
literal|"no suitable DES key for client"
argument_list|)
expr_stmt|;
name|make_err_reply
argument_list|(
name|context
argument_list|,
name|reply
argument_list|,
name|KRB4ET_KDC_NULL_KEY
argument_list|,
literal|"no suitable DES key for client"
argument_list|)
expr_stmt|;
goto|goto
name|out1
goto|;
block|}
if|#
directive|if
literal|0
comment|/* this is not necessary with the new code in libkrb */
comment|/* find a properly salted key */
block|while(ckey->salt == NULL || ckey->salt->salt.length != 0) 	    ret = hdb_next_keytype2key(context,&client->entry, KEYTYPE_DES,&ckey); 	if(ret){ 	    kdc_log(context, config, 0, "No version-4 salted key in database -- %s.%s@%s",  		    name, inst, realm); 	    make_err_reply(context, reply, KRB4ET_KDC_NULL_KEY,  			   "No version-4 salted key in database"); 	    goto out1; 	}
endif|#
directive|endif
name|ret
operator|=
name|_kdc_get_des_key
argument_list|(
name|context
argument_list|,
name|server
argument_list|,
name|TRUE
argument_list|,
name|FALSE
argument_list|,
operator|&
name|skey
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|kdc_log
argument_list|(
name|context
argument_list|,
name|config
argument_list|,
literal|0
argument_list|,
literal|"no suitable DES key for server"
argument_list|)
expr_stmt|;
name|make_err_reply
argument_list|(
name|context
argument_list|,
name|reply
argument_list|,
name|KRB4ET_KDC_NULL_KEY
argument_list|,
literal|"no suitable DES key for server"
argument_list|)
expr_stmt|;
goto|goto
name|out1
goto|;
block|}
name|max_life
operator|=
name|_krb5_krb_life_to_time
argument_list|(
literal|0
argument_list|,
name|life
argument_list|)
expr_stmt|;
if|if
condition|(
name|client
operator|->
name|entry
operator|.
name|max_life
condition|)
name|max_life
operator|=
name|min
argument_list|(
name|max_life
argument_list|,
operator|*
name|client
operator|->
name|entry
operator|.
name|max_life
argument_list|)
expr_stmt|;
if|if
condition|(
name|server
operator|->
name|entry
operator|.
name|max_life
condition|)
name|max_life
operator|=
name|min
argument_list|(
name|max_life
argument_list|,
operator|*
name|server
operator|->
name|entry
operator|.
name|max_life
argument_list|)
expr_stmt|;
name|life
operator|=
name|krb_time_to_life
argument_list|(
name|kdc_time
argument_list|,
name|kdc_time
operator|+
name|max_life
argument_list|)
expr_stmt|;
name|ret
operator|=
name|krb5_generate_random_keyblock
argument_list|(
name|context
argument_list|,
name|ETYPE_DES_PCBC_NONE
argument_list|,
operator|&
name|session
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|make_err_reply
argument_list|(
name|context
argument_list|,
name|reply
argument_list|,
name|KFAILURE
argument_list|,
literal|"Not enough random i KDC"
argument_list|)
expr_stmt|;
goto|goto
name|out1
goto|;
block|}
name|ret
operator|=
name|_krb5_krb_create_ticket
argument_list|(
name|context
argument_list|,
literal|0
argument_list|,
name|name
argument_list|,
name|inst
argument_list|,
name|config
operator|->
name|v4_realm
argument_list|,
name|addr
operator|->
name|sin_addr
operator|.
name|s_addr
argument_list|,
operator|&
name|session
argument_list|,
name|life
argument_list|,
name|kdc_time
argument_list|,
name|sname
argument_list|,
name|sinst
argument_list|,
operator|&
name|skey
operator|->
name|key
argument_list|,
operator|&
name|ticket
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|krb5_free_keyblock_contents
argument_list|(
name|context
argument_list|,
operator|&
name|session
argument_list|)
expr_stmt|;
name|make_err_reply
argument_list|(
name|context
argument_list|,
name|reply
argument_list|,
name|KFAILURE
argument_list|,
literal|"failed to create v4 ticket"
argument_list|)
expr_stmt|;
goto|goto
name|out1
goto|;
block|}
name|ret
operator|=
name|_krb5_krb_create_ciph
argument_list|(
name|context
argument_list|,
operator|&
name|session
argument_list|,
name|sname
argument_list|,
name|sinst
argument_list|,
name|config
operator|->
name|v4_realm
argument_list|,
name|life
argument_list|,
name|server
operator|->
name|entry
operator|.
name|kvno
operator|%
literal|255
argument_list|,
operator|&
name|ticket
argument_list|,
name|kdc_time
argument_list|,
operator|&
name|ckey
operator|->
name|key
argument_list|,
operator|&
name|cipher
argument_list|)
expr_stmt|;
name|krb5_free_keyblock_contents
argument_list|(
name|context
argument_list|,
operator|&
name|session
argument_list|)
expr_stmt|;
name|krb5_data_free
argument_list|(
operator|&
name|ticket
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|make_err_reply
argument_list|(
name|context
argument_list|,
name|reply
argument_list|,
name|KFAILURE
argument_list|,
literal|"Failed to create v4 cipher"
argument_list|)
expr_stmt|;
goto|goto
name|out1
goto|;
block|}
name|ret
operator|=
name|_krb5_krb_create_auth_reply
argument_list|(
name|context
argument_list|,
name|name
argument_list|,
name|inst
argument_list|,
name|realm
argument_list|,
name|req_time
argument_list|,
literal|0
argument_list|,
name|client
operator|->
name|entry
operator|.
name|pw_end
condition|?
operator|*
name|client
operator|->
name|entry
operator|.
name|pw_end
else|:
literal|0
argument_list|,
name|client
operator|->
name|entry
operator|.
name|kvno
operator|%
literal|256
argument_list|,
operator|&
name|cipher
argument_list|,
name|reply
argument_list|)
expr_stmt|;
name|krb5_data_free
argument_list|(
operator|&
name|cipher
argument_list|)
expr_stmt|;
name|out1
label|:
break|break;
block|}
case|case
name|AUTH_MSG_APPL_REQUEST
case|:
block|{
name|struct
name|_krb5_krb_auth_data
name|ad
decl_stmt|;
name|int8_t
name|kvno
decl_stmt|;
name|int8_t
name|ticket_len
decl_stmt|;
name|int8_t
name|req_len
decl_stmt|;
name|krb5_data
name|auth
decl_stmt|;
name|int32_t
name|address
decl_stmt|;
name|size_t
name|pos
decl_stmt|;
name|krb5_principal
name|tgt_princ
init|=
name|NULL
decl_stmt|;
name|hdb_entry_ex
modifier|*
name|tgt
init|=
name|NULL
decl_stmt|;
name|Key
modifier|*
name|tkey
decl_stmt|;
name|time_t
name|max_end
decl_stmt|,
name|actual_end
decl_stmt|,
name|issue_time
decl_stmt|;
name|memset
argument_list|(
operator|&
name|ad
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|ad
argument_list|)
argument_list|)
expr_stmt|;
name|krb5_data_zero
argument_list|(
operator|&
name|auth
argument_list|)
expr_stmt|;
name|RCHECK
argument_list|(
name|krb5_ret_int8
argument_list|(
name|sp
argument_list|,
operator|&
name|kvno
argument_list|)
argument_list|,
name|out2
argument_list|)
expr_stmt|;
name|RCHECK
argument_list|(
name|krb5_ret_stringz
argument_list|(
name|sp
argument_list|,
operator|&
name|realm
argument_list|)
argument_list|,
name|out2
argument_list|)
expr_stmt|;
name|ret
operator|=
name|krb5_425_conv_principal
argument_list|(
name|context
argument_list|,
literal|"krbtgt"
argument_list|,
name|realm
argument_list|,
name|config
operator|->
name|v4_realm
argument_list|,
operator|&
name|tgt_princ
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|kdc_log
argument_list|(
name|context
argument_list|,
name|config
argument_list|,
literal|0
argument_list|,
literal|"Converting krbtgt principal (krb4): %s"
argument_list|,
name|krb5_get_err_text
argument_list|(
name|context
argument_list|,
name|ret
argument_list|)
argument_list|)
expr_stmt|;
name|make_err_reply
argument_list|(
name|context
argument_list|,
name|reply
argument_list|,
name|KFAILURE
argument_list|,
literal|"Failed to convert v4 principal (krbtgt)"
argument_list|)
expr_stmt|;
goto|goto
name|out2
goto|;
block|}
name|ret
operator|=
name|_kdc_db_fetch
argument_list|(
name|context
argument_list|,
name|config
argument_list|,
name|tgt_princ
argument_list|,
name|HDB_F_GET_KRBTGT
argument_list|,
name|NULL
argument_list|,
operator|&
name|tgt
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|char
modifier|*
name|s
decl_stmt|;
name|s
operator|=
name|kdc_log_msg
argument_list|(
name|context
argument_list|,
name|config
argument_list|,
literal|0
argument_list|,
literal|"Ticket-granting ticket not "
literal|"found in database (krb4): krbtgt.%s@%s: %s"
argument_list|,
name|realm
argument_list|,
name|config
operator|->
name|v4_realm
argument_list|,
name|krb5_get_err_text
argument_list|(
name|context
argument_list|,
name|ret
argument_list|)
argument_list|)
expr_stmt|;
name|make_err_reply
argument_list|(
name|context
argument_list|,
name|reply
argument_list|,
name|KFAILURE
argument_list|,
name|s
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|s
argument_list|)
expr_stmt|;
goto|goto
name|out2
goto|;
block|}
if|if
condition|(
name|tgt
operator|->
name|entry
operator|.
name|kvno
operator|%
literal|256
operator|!=
name|kvno
condition|)
block|{
name|kdc_log
argument_list|(
name|context
argument_list|,
name|config
argument_list|,
literal|0
argument_list|,
literal|"tgs-req (krb4) with old kvno %d (current %d) for "
literal|"krbtgt.%s@%s"
argument_list|,
name|kvno
argument_list|,
name|tgt
operator|->
name|entry
operator|.
name|kvno
operator|%
literal|256
argument_list|,
name|realm
argument_list|,
name|config
operator|->
name|v4_realm
argument_list|)
expr_stmt|;
name|make_err_reply
argument_list|(
name|context
argument_list|,
name|reply
argument_list|,
name|KRB4ET_KDC_AUTH_EXP
argument_list|,
literal|"old krbtgt kvno used"
argument_list|)
expr_stmt|;
goto|goto
name|out2
goto|;
block|}
name|ret
operator|=
name|_kdc_get_des_key
argument_list|(
name|context
argument_list|,
name|tgt
argument_list|,
name|TRUE
argument_list|,
name|FALSE
argument_list|,
operator|&
name|tkey
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|kdc_log
argument_list|(
name|context
argument_list|,
name|config
argument_list|,
literal|0
argument_list|,
literal|"no suitable DES key for krbtgt (krb4)"
argument_list|)
expr_stmt|;
name|make_err_reply
argument_list|(
name|context
argument_list|,
name|reply
argument_list|,
name|KRB4ET_KDC_NULL_KEY
argument_list|,
literal|"no suitable DES key for krbtgt"
argument_list|)
expr_stmt|;
goto|goto
name|out2
goto|;
block|}
name|RCHECK
argument_list|(
name|krb5_ret_int8
argument_list|(
name|sp
argument_list|,
operator|&
name|ticket_len
argument_list|)
argument_list|,
name|out2
argument_list|)
expr_stmt|;
name|RCHECK
argument_list|(
name|krb5_ret_int8
argument_list|(
name|sp
argument_list|,
operator|&
name|req_len
argument_list|)
argument_list|,
name|out2
argument_list|)
expr_stmt|;
name|pos
operator|=
name|krb5_storage_seek
argument_list|(
name|sp
argument_list|,
name|ticket_len
operator|+
name|req_len
argument_list|,
name|SEEK_CUR
argument_list|)
expr_stmt|;
name|auth
operator|.
name|data
operator|=
name|buf
expr_stmt|;
name|auth
operator|.
name|length
operator|=
name|pos
expr_stmt|;
if|if
condition|(
name|config
operator|->
name|check_ticket_addresses
condition|)
name|address
operator|=
name|addr
operator|->
name|sin_addr
operator|.
name|s_addr
expr_stmt|;
else|else
name|address
operator|=
literal|0
expr_stmt|;
name|ret
operator|=
name|_krb5_krb_rd_req
argument_list|(
name|context
argument_list|,
operator|&
name|auth
argument_list|,
literal|"krbtgt"
argument_list|,
name|realm
argument_list|,
name|config
operator|->
name|v4_realm
argument_list|,
name|address
argument_list|,
operator|&
name|tkey
operator|->
name|key
argument_list|,
operator|&
name|ad
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|kdc_log
argument_list|(
name|context
argument_list|,
name|config
argument_list|,
literal|0
argument_list|,
literal|"krb_rd_req: %d"
argument_list|,
name|ret
argument_list|)
expr_stmt|;
name|make_err_reply
argument_list|(
name|context
argument_list|,
name|reply
argument_list|,
name|ret
argument_list|,
literal|"failed to parse request"
argument_list|)
expr_stmt|;
goto|goto
name|out2
goto|;
block|}
name|RCHECK
argument_list|(
name|krb5_ret_int32
argument_list|(
name|sp
argument_list|,
operator|&
name|req_time
argument_list|)
argument_list|,
name|out2
argument_list|)
expr_stmt|;
if|if
condition|(
name|lsb
condition|)
name|req_time
operator|=
name|swap32
argument_list|(
name|req_time
argument_list|)
expr_stmt|;
name|RCHECK
argument_list|(
name|krb5_ret_uint8
argument_list|(
name|sp
argument_list|,
operator|&
name|life
argument_list|)
argument_list|,
name|out2
argument_list|)
expr_stmt|;
name|RCHECK
argument_list|(
name|krb5_ret_stringz
argument_list|(
name|sp
argument_list|,
operator|&
name|sname
argument_list|)
argument_list|,
name|out2
argument_list|)
expr_stmt|;
name|RCHECK
argument_list|(
name|krb5_ret_stringz
argument_list|(
name|sp
argument_list|,
operator|&
name|sinst
argument_list|)
argument_list|,
name|out2
argument_list|)
expr_stmt|;
name|snprintf
argument_list|(
name|server_name
argument_list|,
sizeof|sizeof
argument_list|(
name|server_name
argument_list|)
argument_list|,
literal|"%s.%s@%s"
argument_list|,
name|sname
argument_list|,
name|sinst
argument_list|,
name|config
operator|->
name|v4_realm
argument_list|)
expr_stmt|;
name|snprintf
argument_list|(
name|client_name
argument_list|,
sizeof|sizeof
argument_list|(
name|client_name
argument_list|)
argument_list|,
literal|"%s.%s@%s"
argument_list|,
name|ad
operator|.
name|pname
argument_list|,
name|ad
operator|.
name|pinst
argument_list|,
name|ad
operator|.
name|prealm
argument_list|)
expr_stmt|;
name|kdc_log
argument_list|(
name|context
argument_list|,
name|config
argument_list|,
literal|0
argument_list|,
literal|"TGS-REQ (krb4) %s from %s for %s"
argument_list|,
name|client_name
argument_list|,
name|from
argument_list|,
name|server_name
argument_list|)
expr_stmt|;
if|if
condition|(
name|strcmp
argument_list|(
name|ad
operator|.
name|prealm
argument_list|,
name|realm
argument_list|)
condition|)
block|{
name|kdc_log
argument_list|(
name|context
argument_list|,
name|config
argument_list|,
literal|0
argument_list|,
literal|"Can't hop realms (krb4) %s -> %s"
argument_list|,
name|realm
argument_list|,
name|ad
operator|.
name|prealm
argument_list|)
expr_stmt|;
name|make_err_reply
argument_list|(
name|context
argument_list|,
name|reply
argument_list|,
name|KRB4ET_KDC_PR_UNKNOWN
argument_list|,
literal|"Can't hop realms"
argument_list|)
expr_stmt|;
goto|goto
name|out2
goto|;
block|}
if|if
condition|(
operator|!
name|config
operator|->
name|enable_v4_cross_realm
operator|&&
name|strcmp
argument_list|(
name|realm
argument_list|,
name|config
operator|->
name|v4_realm
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|kdc_log
argument_list|(
name|context
argument_list|,
name|config
argument_list|,
literal|0
argument_list|,
literal|"krb4 Cross-realm %s -> %s disabled"
argument_list|,
name|realm
argument_list|,
name|config
operator|->
name|v4_realm
argument_list|)
expr_stmt|;
name|make_err_reply
argument_list|(
name|context
argument_list|,
name|reply
argument_list|,
name|KRB4ET_KDC_PR_UNKNOWN
argument_list|,
literal|"Can't hop realms"
argument_list|)
expr_stmt|;
goto|goto
name|out2
goto|;
block|}
if|if
condition|(
name|strcmp
argument_list|(
name|sname
argument_list|,
literal|"changepw"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|kdc_log
argument_list|(
name|context
argument_list|,
name|config
argument_list|,
literal|0
argument_list|,
literal|"Bad request for changepw ticket (krb4)"
argument_list|)
expr_stmt|;
name|make_err_reply
argument_list|(
name|context
argument_list|,
name|reply
argument_list|,
name|KRB4ET_KDC_PR_UNKNOWN
argument_list|,
literal|"Can't authorize password change based on TGT"
argument_list|)
expr_stmt|;
goto|goto
name|out2
goto|;
block|}
name|ret
operator|=
name|_kdc_db_fetch4
argument_list|(
name|context
argument_list|,
name|config
argument_list|,
name|ad
operator|.
name|pname
argument_list|,
name|ad
operator|.
name|pinst
argument_list|,
name|ad
operator|.
name|prealm
argument_list|,
name|HDB_F_GET_CLIENT
argument_list|,
operator|&
name|client
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|&&
name|ret
operator|!=
name|HDB_ERR_NOENTRY
condition|)
block|{
name|char
modifier|*
name|s
decl_stmt|;
name|s
operator|=
name|kdc_log_msg
argument_list|(
name|context
argument_list|,
name|config
argument_list|,
literal|0
argument_list|,
literal|"Client not found in database: (krb4) %s: %s"
argument_list|,
name|client_name
argument_list|,
name|krb5_get_err_text
argument_list|(
name|context
argument_list|,
name|ret
argument_list|)
argument_list|)
expr_stmt|;
name|make_err_reply
argument_list|(
name|context
argument_list|,
name|reply
argument_list|,
name|KRB4ET_KDC_PR_UNKNOWN
argument_list|,
name|s
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|s
argument_list|)
expr_stmt|;
goto|goto
name|out2
goto|;
block|}
if|if
condition|(
name|client
operator|==
name|NULL
operator|&&
name|strcmp
argument_list|(
name|ad
operator|.
name|prealm
argument_list|,
name|config
operator|->
name|v4_realm
argument_list|)
operator|==
literal|0
condition|)
block|{
name|char
modifier|*
name|s
decl_stmt|;
name|s
operator|=
name|kdc_log_msg
argument_list|(
name|context
argument_list|,
name|config
argument_list|,
literal|0
argument_list|,
literal|"Local client not found in database: (krb4) "
literal|"%s"
argument_list|,
name|client_name
argument_list|)
expr_stmt|;
name|make_err_reply
argument_list|(
name|context
argument_list|,
name|reply
argument_list|,
name|KRB4ET_KDC_PR_UNKNOWN
argument_list|,
name|s
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|s
argument_list|)
expr_stmt|;
goto|goto
name|out2
goto|;
block|}
name|ret
operator|=
name|_kdc_db_fetch4
argument_list|(
name|context
argument_list|,
name|config
argument_list|,
name|sname
argument_list|,
name|sinst
argument_list|,
name|config
operator|->
name|v4_realm
argument_list|,
name|HDB_F_GET_SERVER
argument_list|,
operator|&
name|server
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|char
modifier|*
name|s
decl_stmt|;
name|s
operator|=
name|kdc_log_msg
argument_list|(
name|context
argument_list|,
name|config
argument_list|,
literal|0
argument_list|,
literal|"Server not found in database (krb4): %s: %s"
argument_list|,
name|server_name
argument_list|,
name|krb5_get_err_text
argument_list|(
name|context
argument_list|,
name|ret
argument_list|)
argument_list|)
expr_stmt|;
name|make_err_reply
argument_list|(
name|context
argument_list|,
name|reply
argument_list|,
name|KRB4ET_KDC_PR_UNKNOWN
argument_list|,
name|s
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|s
argument_list|)
expr_stmt|;
goto|goto
name|out2
goto|;
block|}
name|ret
operator|=
name|_kdc_check_flags
argument_list|(
name|context
argument_list|,
name|config
argument_list|,
name|client
argument_list|,
name|client_name
argument_list|,
name|server
argument_list|,
name|server_name
argument_list|,
name|FALSE
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|make_err_reply
argument_list|(
name|context
argument_list|,
name|reply
argument_list|,
name|KRB4ET_KDC_NAME_EXP
argument_list|,
literal|"operation not allowed"
argument_list|)
expr_stmt|;
goto|goto
name|out2
goto|;
block|}
name|ret
operator|=
name|_kdc_get_des_key
argument_list|(
name|context
argument_list|,
name|server
argument_list|,
name|TRUE
argument_list|,
name|FALSE
argument_list|,
operator|&
name|skey
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|kdc_log
argument_list|(
name|context
argument_list|,
name|config
argument_list|,
literal|0
argument_list|,
literal|"no suitable DES key for server (krb4)"
argument_list|)
expr_stmt|;
name|make_err_reply
argument_list|(
name|context
argument_list|,
name|reply
argument_list|,
name|KRB4ET_KDC_NULL_KEY
argument_list|,
literal|"no suitable DES key for server"
argument_list|)
expr_stmt|;
goto|goto
name|out2
goto|;
block|}
name|max_end
operator|=
name|_krb5_krb_life_to_time
argument_list|(
name|ad
operator|.
name|time_sec
argument_list|,
name|ad
operator|.
name|life
argument_list|)
expr_stmt|;
name|max_end
operator|=
name|min
argument_list|(
name|max_end
argument_list|,
name|_krb5_krb_life_to_time
argument_list|(
name|kdc_time
argument_list|,
name|life
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|server
operator|->
name|entry
operator|.
name|max_life
condition|)
name|max_end
operator|=
name|min
argument_list|(
name|max_end
argument_list|,
name|kdc_time
operator|+
operator|*
name|server
operator|->
name|entry
operator|.
name|max_life
argument_list|)
expr_stmt|;
if|if
condition|(
name|client
operator|&&
name|client
operator|->
name|entry
operator|.
name|max_life
condition|)
name|max_end
operator|=
name|min
argument_list|(
name|max_end
argument_list|,
name|kdc_time
operator|+
operator|*
name|client
operator|->
name|entry
operator|.
name|max_life
argument_list|)
expr_stmt|;
name|life
operator|=
name|min
argument_list|(
name|life
argument_list|,
name|krb_time_to_life
argument_list|(
name|kdc_time
argument_list|,
name|max_end
argument_list|)
argument_list|)
expr_stmt|;
name|issue_time
operator|=
name|kdc_time
expr_stmt|;
name|actual_end
operator|=
name|_krb5_krb_life_to_time
argument_list|(
name|issue_time
argument_list|,
name|life
argument_list|)
expr_stmt|;
while|while
condition|(
name|actual_end
operator|>
name|max_end
operator|&&
name|life
operator|>
literal|1
condition|)
block|{
comment|/* move them into the next earlier lifetime bracket */
name|life
operator|--
expr_stmt|;
name|actual_end
operator|=
name|_krb5_krb_life_to_time
argument_list|(
name|issue_time
argument_list|,
name|life
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|actual_end
operator|>
name|max_end
condition|)
block|{
comment|/* if life<= 1 and it's still too long, backdate the ticket */
name|issue_time
operator|-=
name|actual_end
operator|-
name|max_end
expr_stmt|;
block|}
block|{
name|krb5_data
name|ticket
decl_stmt|,
name|cipher
decl_stmt|;
name|krb5_keyblock
name|session
decl_stmt|;
name|krb5_data_zero
argument_list|(
operator|&
name|ticket
argument_list|)
expr_stmt|;
name|krb5_data_zero
argument_list|(
operator|&
name|cipher
argument_list|)
expr_stmt|;
name|ret
operator|=
name|krb5_generate_random_keyblock
argument_list|(
name|context
argument_list|,
name|ETYPE_DES_PCBC_NONE
argument_list|,
operator|&
name|session
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|make_err_reply
argument_list|(
name|context
argument_list|,
name|reply
argument_list|,
name|KFAILURE
argument_list|,
literal|"Not enough random i KDC"
argument_list|)
expr_stmt|;
goto|goto
name|out2
goto|;
block|}
name|ret
operator|=
name|_krb5_krb_create_ticket
argument_list|(
name|context
argument_list|,
literal|0
argument_list|,
name|ad
operator|.
name|pname
argument_list|,
name|ad
operator|.
name|pinst
argument_list|,
name|ad
operator|.
name|prealm
argument_list|,
name|addr
operator|->
name|sin_addr
operator|.
name|s_addr
argument_list|,
operator|&
name|session
argument_list|,
name|life
argument_list|,
name|issue_time
argument_list|,
name|sname
argument_list|,
name|sinst
argument_list|,
operator|&
name|skey
operator|->
name|key
argument_list|,
operator|&
name|ticket
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|krb5_free_keyblock_contents
argument_list|(
name|context
argument_list|,
operator|&
name|session
argument_list|)
expr_stmt|;
name|make_err_reply
argument_list|(
name|context
argument_list|,
name|reply
argument_list|,
name|KFAILURE
argument_list|,
literal|"failed to create v4 ticket"
argument_list|)
expr_stmt|;
goto|goto
name|out2
goto|;
block|}
name|ret
operator|=
name|_krb5_krb_create_ciph
argument_list|(
name|context
argument_list|,
operator|&
name|session
argument_list|,
name|sname
argument_list|,
name|sinst
argument_list|,
name|config
operator|->
name|v4_realm
argument_list|,
name|life
argument_list|,
name|server
operator|->
name|entry
operator|.
name|kvno
operator|%
literal|255
argument_list|,
operator|&
name|ticket
argument_list|,
name|issue_time
argument_list|,
operator|&
name|ad
operator|.
name|session
argument_list|,
operator|&
name|cipher
argument_list|)
expr_stmt|;
name|krb5_free_keyblock_contents
argument_list|(
name|context
argument_list|,
operator|&
name|session
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|make_err_reply
argument_list|(
name|context
argument_list|,
name|reply
argument_list|,
name|KFAILURE
argument_list|,
literal|"failed to create v4 cipher"
argument_list|)
expr_stmt|;
goto|goto
name|out2
goto|;
block|}
name|ret
operator|=
name|_krb5_krb_create_auth_reply
argument_list|(
name|context
argument_list|,
name|ad
operator|.
name|pname
argument_list|,
name|ad
operator|.
name|pinst
argument_list|,
name|ad
operator|.
name|prealm
argument_list|,
name|req_time
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
operator|&
name|cipher
argument_list|,
name|reply
argument_list|)
expr_stmt|;
name|krb5_data_free
argument_list|(
operator|&
name|cipher
argument_list|)
expr_stmt|;
block|}
name|out2
label|:
name|_krb5_krb_free_auth_data
argument_list|(
name|context
argument_list|,
operator|&
name|ad
argument_list|)
expr_stmt|;
if|if
condition|(
name|tgt_princ
condition|)
name|krb5_free_principal
argument_list|(
name|context
argument_list|,
name|tgt_princ
argument_list|)
expr_stmt|;
if|if
condition|(
name|tgt
condition|)
name|_kdc_free_ent
argument_list|(
name|context
argument_list|,
name|tgt
argument_list|)
expr_stmt|;
break|break;
block|}
case|case
name|AUTH_MSG_ERR_REPLY
case|:
break|break;
default|default:
name|kdc_log
argument_list|(
name|context
argument_list|,
name|config
argument_list|,
literal|0
argument_list|,
literal|"Unknown message type (krb4): %d from %s"
argument_list|,
name|msg_type
argument_list|,
name|from
argument_list|)
expr_stmt|;
name|make_err_reply
argument_list|(
name|context
argument_list|,
name|reply
argument_list|,
name|KFAILURE
argument_list|,
literal|"Unknown message type"
argument_list|)
expr_stmt|;
block|}
name|out
label|:
if|if
condition|(
name|name
condition|)
name|free
argument_list|(
name|name
argument_list|)
expr_stmt|;
if|if
condition|(
name|inst
condition|)
name|free
argument_list|(
name|inst
argument_list|)
expr_stmt|;
if|if
condition|(
name|realm
condition|)
name|free
argument_list|(
name|realm
argument_list|)
expr_stmt|;
if|if
condition|(
name|sname
condition|)
name|free
argument_list|(
name|sname
argument_list|)
expr_stmt|;
if|if
condition|(
name|sinst
condition|)
name|free
argument_list|(
name|sinst
argument_list|)
expr_stmt|;
if|if
condition|(
name|client
condition|)
name|_kdc_free_ent
argument_list|(
name|context
argument_list|,
name|client
argument_list|)
expr_stmt|;
if|if
condition|(
name|server
condition|)
name|_kdc_free_ent
argument_list|(
name|context
argument_list|,
name|server
argument_list|)
expr_stmt|;
name|krb5_storage_free
argument_list|(
name|sp
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|krb5_error_code
name|_kdc_encode_v4_ticket
parameter_list|(
name|krb5_context
name|context
parameter_list|,
name|krb5_kdc_configuration
modifier|*
name|config
parameter_list|,
name|void
modifier|*
name|buf
parameter_list|,
name|size_t
name|len
parameter_list|,
specifier|const
name|EncTicketPart
modifier|*
name|et
parameter_list|,
specifier|const
name|PrincipalName
modifier|*
name|service
parameter_list|,
name|size_t
modifier|*
name|size
parameter_list|)
block|{
name|krb5_storage
modifier|*
name|sp
decl_stmt|;
name|krb5_error_code
name|ret
decl_stmt|;
name|char
name|name
index|[
literal|40
index|]
decl_stmt|,
name|inst
index|[
literal|40
index|]
decl_stmt|,
name|realm
index|[
literal|40
index|]
decl_stmt|;
name|char
name|sname
index|[
literal|40
index|]
decl_stmt|,
name|sinst
index|[
literal|40
index|]
decl_stmt|;
block|{
name|krb5_principal
name|princ
decl_stmt|;
name|_krb5_principalname2krb5_principal
argument_list|(
name|context
argument_list|,
operator|&
name|princ
argument_list|,
operator|*
name|service
argument_list|,
name|et
operator|->
name|crealm
argument_list|)
expr_stmt|;
name|ret
operator|=
name|krb5_524_conv_principal
argument_list|(
name|context
argument_list|,
name|princ
argument_list|,
name|sname
argument_list|,
name|sinst
argument_list|,
name|realm
argument_list|)
expr_stmt|;
name|krb5_free_principal
argument_list|(
name|context
argument_list|,
name|princ
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
return|return
name|ret
return|;
name|_krb5_principalname2krb5_principal
argument_list|(
name|context
argument_list|,
operator|&
name|princ
argument_list|,
name|et
operator|->
name|cname
argument_list|,
name|et
operator|->
name|crealm
argument_list|)
expr_stmt|;
name|ret
operator|=
name|krb5_524_conv_principal
argument_list|(
name|context
argument_list|,
name|princ
argument_list|,
name|name
argument_list|,
name|inst
argument_list|,
name|realm
argument_list|)
expr_stmt|;
name|krb5_free_principal
argument_list|(
name|context
argument_list|,
name|princ
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|ret
condition|)
return|return
name|ret
return|;
name|sp
operator|=
name|krb5_storage_emem
argument_list|()
expr_stmt|;
name|krb5_store_int8
argument_list|(
name|sp
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* flags */
name|krb5_store_stringz
argument_list|(
name|sp
argument_list|,
name|name
argument_list|)
expr_stmt|;
name|krb5_store_stringz
argument_list|(
name|sp
argument_list|,
name|inst
argument_list|)
expr_stmt|;
name|krb5_store_stringz
argument_list|(
name|sp
argument_list|,
name|realm
argument_list|)
expr_stmt|;
block|{
name|unsigned
name|char
name|tmp
index|[
literal|4
index|]
init|=
block|{
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|}
decl_stmt|;
name|int
name|i
decl_stmt|;
if|if
condition|(
name|et
operator|->
name|caddr
condition|)
block|{
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|et
operator|->
name|caddr
operator|->
name|len
condition|;
name|i
operator|++
control|)
if|if
condition|(
name|et
operator|->
name|caddr
operator|->
name|val
index|[
name|i
index|]
operator|.
name|addr_type
operator|==
name|AF_INET
operator|&&
name|et
operator|->
name|caddr
operator|->
name|val
index|[
name|i
index|]
operator|.
name|address
operator|.
name|length
operator|==
literal|4
condition|)
block|{
name|memcpy
argument_list|(
name|tmp
argument_list|,
name|et
operator|->
name|caddr
operator|->
name|val
index|[
name|i
index|]
operator|.
name|address
operator|.
name|data
argument_list|,
literal|4
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
name|krb5_storage_write
argument_list|(
name|sp
argument_list|,
name|tmp
argument_list|,
sizeof|sizeof
argument_list|(
name|tmp
argument_list|)
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|et
operator|->
name|key
operator|.
name|keytype
operator|!=
name|ETYPE_DES_CBC_MD5
operator|&&
name|et
operator|->
name|key
operator|.
name|keytype
operator|!=
name|ETYPE_DES_CBC_MD4
operator|&&
name|et
operator|->
name|key
operator|.
name|keytype
operator|!=
name|ETYPE_DES_CBC_CRC
operator|)
operator|||
name|et
operator|->
name|key
operator|.
name|keyvalue
operator|.
name|length
operator|!=
literal|8
condition|)
return|return
operator|-
literal|1
return|;
name|krb5_storage_write
argument_list|(
name|sp
argument_list|,
name|et
operator|->
name|key
operator|.
name|keyvalue
operator|.
name|data
argument_list|,
literal|8
argument_list|)
expr_stmt|;
block|{
name|time_t
name|start
init|=
name|et
operator|->
name|starttime
condition|?
operator|*
name|et
operator|->
name|starttime
else|:
name|et
operator|->
name|authtime
decl_stmt|;
name|krb5_store_int8
argument_list|(
name|sp
argument_list|,
name|krb_time_to_life
argument_list|(
name|start
argument_list|,
name|et
operator|->
name|endtime
argument_list|)
argument_list|)
expr_stmt|;
name|krb5_store_int32
argument_list|(
name|sp
argument_list|,
name|start
argument_list|)
expr_stmt|;
block|}
name|krb5_store_stringz
argument_list|(
name|sp
argument_list|,
name|sname
argument_list|)
expr_stmt|;
name|krb5_store_stringz
argument_list|(
name|sp
argument_list|,
name|sinst
argument_list|)
expr_stmt|;
block|{
name|krb5_data
name|data
decl_stmt|;
name|krb5_storage_to_data
argument_list|(
name|sp
argument_list|,
operator|&
name|data
argument_list|)
expr_stmt|;
name|krb5_storage_free
argument_list|(
name|sp
argument_list|)
expr_stmt|;
operator|*
name|size
operator|=
operator|(
name|data
operator|.
name|length
operator|+
literal|7
operator|)
operator|&
operator|~
literal|7
expr_stmt|;
comment|/* pad to 8 bytes */
if|if
condition|(
operator|*
name|size
operator|>
name|len
condition|)
return|return
operator|-
literal|1
return|;
name|memset
argument_list|(
operator|(
name|unsigned
name|char
operator|*
operator|)
name|buf
operator|-
operator|*
name|size
operator|+
literal|1
argument_list|,
literal|0
argument_list|,
operator|*
name|size
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
operator|(
name|unsigned
name|char
operator|*
operator|)
name|buf
operator|-
operator|*
name|size
operator|+
literal|1
argument_list|,
name|data
operator|.
name|data
argument_list|,
name|data
operator|.
name|length
argument_list|)
expr_stmt|;
name|krb5_data_free
argument_list|(
operator|&
name|data
argument_list|)
expr_stmt|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
name|krb5_error_code
name|_kdc_get_des_key
parameter_list|(
name|krb5_context
name|context
parameter_list|,
name|hdb_entry_ex
modifier|*
name|principal
parameter_list|,
name|krb5_boolean
name|is_server
parameter_list|,
name|krb5_boolean
name|prefer_afs_key
parameter_list|,
name|Key
modifier|*
modifier|*
name|ret_key
parameter_list|)
block|{
name|Key
modifier|*
name|v5_key
init|=
name|NULL
decl_stmt|,
modifier|*
name|v4_key
init|=
name|NULL
decl_stmt|,
modifier|*
name|afs_key
init|=
name|NULL
decl_stmt|,
modifier|*
name|server_key
init|=
name|NULL
decl_stmt|;
name|int
name|i
decl_stmt|;
name|krb5_enctype
name|etypes
index|[]
init|=
block|{
name|ETYPE_DES_CBC_MD5
block|,
name|ETYPE_DES_CBC_MD4
block|,
name|ETYPE_DES_CBC_CRC
block|}
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
sizeof|sizeof
argument_list|(
name|etypes
argument_list|)
operator|/
sizeof|sizeof
argument_list|(
name|etypes
index|[
literal|0
index|]
argument_list|)
operator|&&
operator|(
name|v5_key
operator|==
name|NULL
operator|||
name|v4_key
operator|==
name|NULL
operator|||
name|afs_key
operator|==
name|NULL
operator|||
name|server_key
operator|==
name|NULL
operator|)
condition|;
operator|++
name|i
control|)
block|{
name|Key
modifier|*
name|key
init|=
name|NULL
decl_stmt|;
while|while
condition|(
name|hdb_next_enctype2key
argument_list|(
name|context
argument_list|,
operator|&
name|principal
operator|->
name|entry
argument_list|,
name|etypes
index|[
name|i
index|]
argument_list|,
operator|&
name|key
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|key
operator|->
name|salt
operator|==
name|NULL
condition|)
block|{
if|if
condition|(
name|v5_key
operator|==
name|NULL
condition|)
name|v5_key
operator|=
name|key
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|key
operator|->
name|salt
operator|->
name|type
operator|==
name|hdb_pw_salt
operator|&&
name|key
operator|->
name|salt
operator|->
name|salt
operator|.
name|length
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|v4_key
operator|==
name|NULL
condition|)
name|v4_key
operator|=
name|key
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|key
operator|->
name|salt
operator|->
name|type
operator|==
name|hdb_afs3_salt
condition|)
block|{
if|if
condition|(
name|afs_key
operator|==
name|NULL
condition|)
name|afs_key
operator|=
name|key
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|server_key
operator|==
name|NULL
condition|)
name|server_key
operator|=
name|key
expr_stmt|;
block|}
block|}
if|if
condition|(
name|prefer_afs_key
condition|)
block|{
if|if
condition|(
name|afs_key
condition|)
operator|*
name|ret_key
operator|=
name|afs_key
expr_stmt|;
elseif|else
if|if
condition|(
name|v4_key
condition|)
operator|*
name|ret_key
operator|=
name|v4_key
expr_stmt|;
elseif|else
if|if
condition|(
name|v5_key
condition|)
operator|*
name|ret_key
operator|=
name|v5_key
expr_stmt|;
elseif|else
if|if
condition|(
name|is_server
operator|&&
name|server_key
condition|)
operator|*
name|ret_key
operator|=
name|server_key
expr_stmt|;
else|else
return|return
name|KRB4ET_KDC_NULL_KEY
return|;
block|}
else|else
block|{
if|if
condition|(
name|v4_key
condition|)
operator|*
name|ret_key
operator|=
name|v4_key
expr_stmt|;
elseif|else
if|if
condition|(
name|afs_key
condition|)
operator|*
name|ret_key
operator|=
name|afs_key
expr_stmt|;
elseif|else
if|if
condition|(
name|v5_key
condition|)
operator|*
name|ret_key
operator|=
name|v5_key
expr_stmt|;
elseif|else
if|if
condition|(
name|is_server
operator|&&
name|server_key
condition|)
operator|*
name|ret_key
operator|=
name|server_key
expr_stmt|;
else|else
return|return
name|KRB4ET_KDC_NULL_KEY
return|;
block|}
if|if
condition|(
operator|(
operator|*
name|ret_key
operator|)
operator|->
name|key
operator|.
name|keyvalue
operator|.
name|length
operator|==
literal|0
condition|)
return|return
name|KRB4ET_KDC_NULL_KEY
return|;
return|return
literal|0
return|;
block|}
end_function

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/* This file contains code for X-CHESS.    Copyright (C) 1986 Free Software Foundation, Inc.  This file is part of X-CHESS.  X-CHESS is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY.  No author or distributor accepts responsibility to anyone for the consequences of using it or for whether it serves any particular purpose or works at all, unless he says so in writing.  Refer to the X-CHESS General Public License for full details.  Everyone is granted permission to copy, modify and redistribute X-CHESS, but only under the conditions described in the X-CHESS General Public License.   A copy of this license is supposed to have been given to you along with X-CHESS so you can know your rights and responsibilities.  It should be in a file named COPYING.  Among other things, the copyright notice and this notice must be preserved on all copies.  */
end_comment

begin_comment
comment|/* RCS Info: $Revision: 1.5 $ on $Date: 86/11/26 12:11:15 $  *           $Source: /users/faustus/xchess/RCS/window.c,v $  * Copyright (c) 1986 Wayne A. Christopher, U. C. Berkeley CAD Group  *	Permission is granted to do anything with this code except sell it  *	or remove this message.  *  * Deal with the two (or one) windows.  */
end_comment

begin_include
include|#
directive|include
file|"xchess.h"
end_include

begin_include
include|#
directive|include
file|<X11/Xutil.h>
end_include

begin_include
include|#
directive|include
file|<sys/time.h>
end_include

begin_include
include|#
directive|include
file|"pawn.bitmap"
end_include

begin_include
include|#
directive|include
file|"rook.bitmap"
end_include

begin_include
include|#
directive|include
file|"knight.bitmap"
end_include

begin_include
include|#
directive|include
file|"bishop.bitmap"
end_include

begin_include
include|#
directive|include
file|"queen.bitmap"
end_include

begin_include
include|#
directive|include
file|"king.bitmap"
end_include

begin_include
include|#
directive|include
file|"pawn_outline.bitmap"
end_include

begin_include
include|#
directive|include
file|"rook_outline.bitmap"
end_include

begin_include
include|#
directive|include
file|"knight_outline.bitmap"
end_include

begin_include
include|#
directive|include
file|"bishop_outline.bitmap"
end_include

begin_include
include|#
directive|include
file|"queen_outline.bitmap"
end_include

begin_include
include|#
directive|include
file|"king_outline.bitmap"
end_include

begin_include
include|#
directive|include
file|"pawn_mask.bitmap"
end_include

begin_include
include|#
directive|include
file|"rook_mask.bitmap"
end_include

begin_include
include|#
directive|include
file|"knight_mask.bitmap"
end_include

begin_include
include|#
directive|include
file|"bishop_mask.bitmap"
end_include

begin_include
include|#
directive|include
file|"queen_mask.bitmap"
end_include

begin_include
include|#
directive|include
file|"king_mask.bitmap"
end_include

begin_include
include|#
directive|include
file|"shade.bitmap"
end_include

begin_include
include|#
directive|include
file|"xchess.cur"
end_include

begin_include
include|#
directive|include
file|"xchess_mask.cur"
end_include

begin_include
include|#
directive|include
file|"xchess.icon"
end_include

begin_decl_stmt
name|windata
modifier|*
name|win1
decl_stmt|,
modifier|*
name|win2
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|bool
name|win_flashmove
init|=
name|false
decl_stmt|;
end_decl_stmt

begin_function_decl
specifier|extern
name|bool
name|setup
parameter_list|()
function_decl|;
end_function_decl

begin_decl_stmt
specifier|extern
name|void
name|service
argument_list|()
decl_stmt|,
name|drawgrid
argument_list|()
decl_stmt|,
name|icon_refresh
argument_list|()
decl_stmt|;
end_decl_stmt

begin_function
name|bool
name|win_setup
parameter_list|(
name|disp1
parameter_list|,
name|disp2
parameter_list|)
name|char
modifier|*
name|disp1
decl_stmt|,
decl|*
name|disp2
decl_stmt|;
end_function

begin_block
block|{
name|win1
operator|=
name|alloc
argument_list|(
name|windata
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|oneboard
condition|)
name|win2
operator|=
name|alloc
argument_list|(
name|windata
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|setup
argument_list|(
name|disp1
argument_list|,
name|win1
argument_list|)
operator|||
operator|(
operator|!
name|oneboard
operator|&&
operator|!
name|setup
argument_list|(
name|disp2
argument_list|,
name|win2
argument_list|)
operator|)
condition|)
return|return
operator|(
name|false
operator|)
return|;
if|if
condition|(
name|blackflag
condition|)
block|{
name|win1
operator|->
name|color
operator|=
name|BLACK
expr_stmt|;
name|win1
operator|->
name|flipped
operator|=
name|true
expr_stmt|;
block|}
else|else
name|win1
operator|->
name|color
operator|=
name|WHITE
expr_stmt|;
name|win_drawboard
argument_list|(
name|win1
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|oneboard
condition|)
block|{
name|win2
operator|->
name|color
operator|=
name|BLACK
expr_stmt|;
name|win2
operator|->
name|flipped
operator|=
name|true
expr_stmt|;
name|win_drawboard
argument_list|(
name|win2
argument_list|)
expr_stmt|;
block|}
return|return
operator|(
name|true
operator|)
return|;
block|}
end_block

begin_comment
comment|/* Draw the chess board... */
end_comment

begin_function
name|void
name|win_drawboard
parameter_list|(
name|win
parameter_list|)
name|windata
modifier|*
name|win
decl_stmt|;
block|{
name|int
name|i
decl_stmt|,
name|j
decl_stmt|;
name|drawgrid
argument_list|(
name|win
argument_list|)
expr_stmt|;
comment|/* Now toss on the squares... */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|SIZE
condition|;
name|i
operator|++
control|)
for|for
control|(
name|j
operator|=
literal|0
init|;
name|j
operator|<
name|SIZE
condition|;
name|j
operator|++
control|)
name|win_erasepiece
argument_list|(
name|j
argument_list|,
name|i
argument_list|,
name|win
operator|->
name|color
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_comment
comment|/* Draw one piece. */
end_comment

begin_function
name|void
name|win_drawpiece
parameter_list|(
name|p
parameter_list|,
name|y
parameter_list|,
name|x
parameter_list|,
name|wnum
parameter_list|)
name|piece
modifier|*
name|p
decl_stmt|;
name|int
name|y
decl_stmt|,
name|x
decl_stmt|;
name|color
name|wnum
decl_stmt|;
block|{
name|char
modifier|*
name|bits
decl_stmt|,
modifier|*
name|maskbits
decl_stmt|,
modifier|*
name|outline
decl_stmt|;
name|windata
modifier|*
name|win
decl_stmt|;
name|char
name|buf
index|[
name|BSIZE
index|]
decl_stmt|;
name|XImage
modifier|*
name|tmpImage
decl_stmt|;
name|Pixmap
name|tmpPM
decl_stmt|,
name|maskPM
decl_stmt|;
name|XGCValues
name|gc
decl_stmt|;
if|if
condition|(
name|oneboard
operator|||
operator|(
name|wnum
operator|==
name|win1
operator|->
name|color
operator|)
condition|)
name|win
operator|=
name|win1
expr_stmt|;
else|else
name|win
operator|=
name|win2
expr_stmt|;
if|if
condition|(
name|win
operator|->
name|flipped
condition|)
block|{
name|y
operator|=
name|SIZE
operator|-
name|y
operator|-
literal|1
expr_stmt|;
name|x
operator|=
name|SIZE
operator|-
name|x
operator|-
literal|1
expr_stmt|;
block|}
comment|/*       if (debug)       fprintf(stderr, "draw a %s at (%d, %d) on board %d\n",       piecenames[(int) p->type], y, x, wnum);       */
if|if
condition|(
operator|(
name|x
operator|<
literal|0
operator|)
operator|||
operator|(
name|x
operator|>
literal|7
operator|)
operator|||
operator|(
name|y
operator|<
literal|0
operator|)
operator|||
operator|(
name|y
operator|>
literal|7
operator|)
condition|)
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|p
operator|->
name|type
condition|)
block|{
case|case
name|PAWN
case|:
name|bits
operator|=
name|pawn_bits
expr_stmt|;
name|maskbits
operator|=
name|pawn_mask_bits
expr_stmt|;
name|outline
operator|=
name|pawn_outline_bits
expr_stmt|;
break|break;
case|case
name|ROOK
case|:
name|bits
operator|=
name|rook_bits
expr_stmt|;
name|maskbits
operator|=
name|rook_mask_bits
expr_stmt|;
name|outline
operator|=
name|rook_outline_bits
expr_stmt|;
break|break;
case|case
name|KNIGHT
case|:
name|bits
operator|=
name|knight_bits
expr_stmt|;
name|maskbits
operator|=
name|knight_mask_bits
expr_stmt|;
name|outline
operator|=
name|knight_outline_bits
expr_stmt|;
break|break;
case|case
name|BISHOP
case|:
name|bits
operator|=
name|bishop_bits
expr_stmt|;
name|maskbits
operator|=
name|bishop_mask_bits
expr_stmt|;
name|outline
operator|=
name|bishop_outline_bits
expr_stmt|;
break|break;
case|case
name|QUEEN
case|:
name|bits
operator|=
name|queen_bits
expr_stmt|;
name|maskbits
operator|=
name|queen_mask_bits
expr_stmt|;
name|outline
operator|=
name|queen_outline_bits
expr_stmt|;
break|break;
case|case
name|KING
case|:
name|bits
operator|=
name|king_bits
expr_stmt|;
name|maskbits
operator|=
name|king_mask_bits
expr_stmt|;
name|outline
operator|=
name|king_outline_bits
expr_stmt|;
break|break;
default|default:
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Internal Error: win_drawpiece: bad piece type %d\n"
argument_list|,
name|p
operator|->
name|type
argument_list|)
expr_stmt|;
block|}
comment|/* There are two things we can do... If this is a black and white      * display, we have to shade the square and use an outline if the piece      * is white.  We also have to use a mask...  Since we don't want      * to use up too many bitmaps, create the mask bitmap, put the bits,      * and then destroy it.      */
if|if
condition|(
name|win
operator|->
name|bnw
operator|&&
operator|(
name|p
operator|->
name|color
operator|==
name|WHITE
operator|)
condition|)
name|bits
operator|=
name|outline
expr_stmt|;
if|if
condition|(
name|win
operator|->
name|bnw
operator|&&
operator|!
name|iswhite
argument_list|(
name|win
argument_list|,
name|x
argument_list|,
name|y
argument_list|)
condition|)
block|{
name|XSetState
argument_list|(
name|win
operator|->
name|display
argument_list|,
name|DefaultGC
argument_list|(
name|win
operator|->
name|display
argument_list|,
literal|0
argument_list|)
argument_list|,
name|BlackPixel
argument_list|(
name|win
operator|->
name|display
argument_list|,
literal|0
argument_list|)
argument_list|,
name|WhitePixel
argument_list|(
name|win
operator|->
name|display
argument_list|,
literal|0
argument_list|)
argument_list|,
name|GXcopy
argument_list|,
name|AllPlanes
argument_list|)
expr_stmt|;
name|tmpPM
operator|=
name|XCreateBitmapFromData
argument_list|(
name|win
operator|->
name|display
argument_list|,
name|win
operator|->
name|boardwin
argument_list|,
name|shade_bits
argument_list|,
name|SQUARE_WIDTH
argument_list|,
name|SQUARE_HEIGHT
argument_list|)
expr_stmt|;
name|XCopyPlane
argument_list|(
name|win
operator|->
name|display
argument_list|,
name|tmpPM
argument_list|,
name|win
operator|->
name|boardwin
argument_list|,
name|DefaultGC
argument_list|(
name|win
operator|->
name|display
argument_list|,
literal|0
argument_list|)
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
name|SQUARE_WIDTH
argument_list|,
name|SQUARE_HEIGHT
argument_list|,
name|x
operator|*
operator|(
name|SQUARE_WIDTH
operator|+
name|BORDER_WIDTH
operator|)
argument_list|,
name|y
operator|*
operator|(
name|SQUARE_HEIGHT
operator|+
name|BORDER_WIDTH
operator|)
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|XFreePixmap
argument_list|(
name|win
operator|->
name|display
argument_list|,
name|tmpPM
argument_list|)
expr_stmt|;
name|XSetFunction
argument_list|(
name|win
operator|->
name|display
argument_list|,
name|DefaultGC
argument_list|(
name|win
operator|->
name|display
argument_list|,
literal|0
argument_list|)
argument_list|,
name|GXandInverted
argument_list|)
expr_stmt|;
name|maskPM
operator|=
name|XCreateBitmapFromData
argument_list|(
name|win
operator|->
name|display
argument_list|,
name|win
operator|->
name|boardwin
argument_list|,
name|maskbits
argument_list|,
name|SQUARE_WIDTH
argument_list|,
name|SQUARE_HEIGHT
argument_list|)
expr_stmt|;
name|XCopyPlane
argument_list|(
name|win
operator|->
name|display
argument_list|,
name|maskPM
argument_list|,
name|win
operator|->
name|boardwin
argument_list|,
name|DefaultGC
argument_list|(
name|win
operator|->
name|display
argument_list|,
literal|0
argument_list|)
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
name|SQUARE_WIDTH
argument_list|,
name|SQUARE_HEIGHT
argument_list|,
name|x
operator|*
operator|(
name|SQUARE_WIDTH
operator|+
name|BORDER_WIDTH
operator|)
argument_list|,
name|y
operator|*
operator|(
name|SQUARE_HEIGHT
operator|+
name|BORDER_WIDTH
operator|)
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|XFreePixmap
argument_list|(
name|win
operator|->
name|display
argument_list|,
name|maskPM
argument_list|)
expr_stmt|;
name|XSetFunction
argument_list|(
name|win
operator|->
name|display
argument_list|,
name|DefaultGC
argument_list|(
name|win
operator|->
name|display
argument_list|,
literal|0
argument_list|)
argument_list|,
name|GXor
argument_list|)
expr_stmt|;
name|tmpPM
operator|=
name|XCreateBitmapFromData
argument_list|(
name|win
operator|->
name|display
argument_list|,
name|win
operator|->
name|boardwin
argument_list|,
name|bits
argument_list|,
name|SQUARE_WIDTH
argument_list|,
name|SQUARE_HEIGHT
argument_list|)
expr_stmt|;
name|XCopyPlane
argument_list|(
name|win
operator|->
name|display
argument_list|,
name|tmpPM
argument_list|,
name|win
operator|->
name|boardwin
argument_list|,
name|DefaultGC
argument_list|(
name|win
operator|->
name|display
argument_list|,
literal|0
argument_list|)
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
name|SQUARE_WIDTH
argument_list|,
name|SQUARE_HEIGHT
argument_list|,
name|x
operator|*
operator|(
name|SQUARE_WIDTH
operator|+
name|BORDER_WIDTH
operator|)
argument_list|,
name|y
operator|*
operator|(
name|SQUARE_HEIGHT
operator|+
name|BORDER_WIDTH
operator|)
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|XFreePixmap
argument_list|(
name|win
operator|->
name|display
argument_list|,
name|tmpPM
argument_list|)
expr_stmt|;
name|XSetFunction
argument_list|(
name|win
operator|->
name|display
argument_list|,
name|DefaultGC
argument_list|(
name|win
operator|->
name|display
argument_list|,
literal|0
argument_list|)
argument_list|,
name|GXcopy
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|win
operator|->
name|bnw
condition|)
block|{
name|XSetState
argument_list|(
name|win
operator|->
name|display
argument_list|,
name|DefaultGC
argument_list|(
name|win
operator|->
name|display
argument_list|,
literal|0
argument_list|)
argument_list|,
name|BlackPixel
argument_list|(
name|win
operator|->
name|display
argument_list|,
literal|0
argument_list|)
argument_list|,
name|WhitePixel
argument_list|(
name|win
operator|->
name|display
argument_list|,
literal|0
argument_list|)
argument_list|,
name|GXcopy
argument_list|,
name|AllPlanes
argument_list|)
expr_stmt|;
name|tmpPM
operator|=
name|XCreateBitmapFromData
argument_list|(
name|win
operator|->
name|display
argument_list|,
name|win
operator|->
name|boardwin
argument_list|,
name|bits
argument_list|,
name|SQUARE_WIDTH
argument_list|,
name|SQUARE_HEIGHT
argument_list|)
expr_stmt|;
name|XCopyPlane
argument_list|(
name|win
operator|->
name|display
argument_list|,
name|tmpPM
argument_list|,
name|win
operator|->
name|boardwin
argument_list|,
name|DefaultGC
argument_list|(
name|win
operator|->
name|display
argument_list|,
literal|0
argument_list|)
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
name|SQUARE_WIDTH
argument_list|,
name|SQUARE_HEIGHT
argument_list|,
name|x
operator|*
operator|(
name|SQUARE_WIDTH
operator|+
name|BORDER_WIDTH
operator|)
argument_list|,
name|y
operator|*
operator|(
name|SQUARE_HEIGHT
operator|+
name|BORDER_WIDTH
operator|)
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|XFreePixmap
argument_list|(
name|win
operator|->
name|display
argument_list|,
name|tmpPM
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|XSetState
argument_list|(
name|win
operator|->
name|display
argument_list|,
name|DefaultGC
argument_list|(
name|win
operator|->
name|display
argument_list|,
literal|0
argument_list|)
argument_list|,
operator|(
operator|(
name|p
operator|->
name|color
operator|==
name|WHITE
operator|)
condition|?
name|win
operator|->
name|whitepiece
operator|.
name|pixel
else|:
name|win
operator|->
name|blackpiece
operator|.
name|pixel
operator|)
argument_list|,
operator|(
name|iswhite
argument_list|(
name|win
argument_list|,
name|x
argument_list|,
name|y
argument_list|)
condition|?
name|win
operator|->
name|whitesquare
operator|.
name|pixel
else|:
name|win
operator|->
name|blacksquare
operator|.
name|pixel
operator|)
argument_list|,
name|GXcopy
argument_list|,
name|AllPlanes
argument_list|)
expr_stmt|;
name|tmpPM
operator|=
name|XCreateBitmapFromData
argument_list|(
name|win
operator|->
name|display
argument_list|,
name|win
operator|->
name|boardwin
argument_list|,
name|bits
argument_list|,
name|SQUARE_WIDTH
argument_list|,
name|SQUARE_HEIGHT
argument_list|)
expr_stmt|;
name|XCopyPlane
argument_list|(
name|win
operator|->
name|display
argument_list|,
name|tmpPM
argument_list|,
name|win
operator|->
name|boardwin
argument_list|,
name|DefaultGC
argument_list|(
name|win
operator|->
name|display
argument_list|,
literal|0
argument_list|)
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
name|SQUARE_WIDTH
argument_list|,
name|SQUARE_HEIGHT
argument_list|,
name|x
operator|*
operator|(
name|SQUARE_WIDTH
operator|+
name|BORDER_WIDTH
operator|)
argument_list|,
name|y
operator|*
operator|(
name|SQUARE_HEIGHT
operator|+
name|BORDER_WIDTH
operator|)
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|XFreePixmap
argument_list|(
name|win
operator|->
name|display
argument_list|,
name|tmpPM
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|record_english
condition|)
block|{
name|gc
operator|.
name|foreground
operator|=
name|win
operator|->
name|textcolor
operator|.
name|pixel
expr_stmt|;
if|if
condition|(
name|iswhite
argument_list|(
name|win
argument_list|,
name|x
argument_list|,
name|y
argument_list|)
operator|||
name|win
operator|->
name|bnw
condition|)
name|gc
operator|.
name|background
operator|=
name|win
operator|->
name|whitesquare
operator|.
name|pixel
expr_stmt|;
else|else
name|gc
operator|.
name|background
operator|=
name|win
operator|->
name|blacksquare
operator|.
name|pixel
expr_stmt|;
name|gc
operator|.
name|font
operator|=
name|win
operator|->
name|small
operator|->
name|fid
expr_stmt|;
name|XChangeGC
argument_list|(
name|win
operator|->
name|display
argument_list|,
name|DefaultGC
argument_list|(
name|win
operator|->
name|display
argument_list|,
literal|0
argument_list|)
argument_list|,
name|GCForeground
operator||
name|GCBackground
operator||
name|GCFont
argument_list|,
operator|&
name|gc
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|x
condition|)
block|{
name|sprintf
argument_list|(
name|buf
argument_list|,
literal|" %d"
argument_list|,
name|SIZE
operator|-
name|y
argument_list|)
expr_stmt|;
name|XDrawImageString
argument_list|(
name|win
operator|->
name|display
argument_list|,
name|win
operator|->
name|boardwin
argument_list|,
name|DefaultGC
argument_list|(
name|win
operator|->
name|display
argument_list|,
literal|0
argument_list|)
argument_list|,
literal|1
argument_list|,
operator|(
name|y
operator|+
literal|1
operator|)
operator|*
operator|(
name|SQUARE_HEIGHT
operator|+
name|BORDER_WIDTH
operator|)
operator|-
name|BORDER_WIDTH
operator|+
name|win
operator|->
name|small
operator|->
name|max_bounds
operator|.
name|ascent
operator|-
literal|1
argument_list|,
name|buf
argument_list|,
literal|2
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|y
operator|==
name|SIZE
operator|-
literal|1
condition|)
block|{
name|sprintf
argument_list|(
name|buf
argument_list|,
literal|"%c"
argument_list|,
literal|'A'
operator|+
name|x
argument_list|)
expr_stmt|;
name|XDrawImageString
argument_list|(
name|win
operator|->
name|display
argument_list|,
name|win
operator|->
name|boardwin
argument_list|,
name|DefaultGC
argument_list|(
name|win
operator|->
name|display
argument_list|,
literal|0
argument_list|)
argument_list|,
name|x
operator|*
operator|(
name|SQUARE_WIDTH
operator|+
name|BORDER_WIDTH
operator|)
operator|+
literal|1
argument_list|,
name|SIZE
operator|*
operator|(
name|SQUARE_HEIGHT
operator|+
name|BORDER_WIDTH
operator|)
operator|-
name|BORDER_WIDTH
operator|+
name|win
operator|->
name|small
operator|->
name|max_bounds
operator|.
name|ascent
operator|-
literal|1
argument_list|,
name|buf
argument_list|,
literal|1
argument_list|)
expr_stmt|;
block|}
block|}
return|return;
block|}
end_function

begin_function
name|void
name|win_erasepiece
parameter_list|(
name|y
parameter_list|,
name|x
parameter_list|,
name|wnum
parameter_list|)
name|int
name|y
decl_stmt|,
name|x
decl_stmt|;
name|color
name|wnum
decl_stmt|;
block|{
name|windata
modifier|*
name|win
decl_stmt|;
name|char
name|buf
index|[
name|BSIZE
index|]
decl_stmt|;
name|XGCValues
name|gc
decl_stmt|;
name|Pixmap
name|tmpPM
decl_stmt|;
if|if
condition|(
name|oneboard
operator|||
operator|(
name|wnum
operator|==
name|win1
operator|->
name|color
operator|)
condition|)
name|win
operator|=
name|win1
expr_stmt|;
else|else
name|win
operator|=
name|win2
expr_stmt|;
if|if
condition|(
name|win
operator|->
name|flipped
condition|)
block|{
name|y
operator|=
name|SIZE
operator|-
name|y
operator|-
literal|1
expr_stmt|;
name|x
operator|=
name|SIZE
operator|-
name|x
operator|-
literal|1
expr_stmt|;
block|}
comment|/*       if (debug)       fprintf(stderr, "erase square (%d, %d) on board %d\n", y, x,       wnum);       */
if|if
condition|(
operator|(
name|x
operator|<
literal|0
operator|)
operator|||
operator|(
name|x
operator|>
literal|7
operator|)
operator|||
operator|(
name|y
operator|<
literal|0
operator|)
operator|||
operator|(
name|y
operator|>
literal|7
operator|)
condition|)
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|win
operator|->
name|bnw
operator|&&
operator|!
name|iswhite
argument_list|(
name|win
argument_list|,
name|x
argument_list|,
name|y
argument_list|)
condition|)
block|{
name|XSetState
argument_list|(
name|win
operator|->
name|display
argument_list|,
name|DefaultGC
argument_list|(
name|win
operator|->
name|display
argument_list|,
literal|0
argument_list|)
argument_list|,
name|BlackPixel
argument_list|(
name|win
operator|->
name|display
argument_list|,
literal|0
argument_list|)
argument_list|,
name|WhitePixel
argument_list|(
name|win
operator|->
name|display
argument_list|,
literal|0
argument_list|)
argument_list|,
name|GXcopy
argument_list|,
name|AllPlanes
argument_list|)
expr_stmt|;
name|tmpPM
operator|=
name|XCreateBitmapFromData
argument_list|(
name|win
operator|->
name|display
argument_list|,
name|win
operator|->
name|boardwin
argument_list|,
name|shade_bits
argument_list|,
name|SQUARE_WIDTH
argument_list|,
name|SQUARE_HEIGHT
argument_list|)
expr_stmt|;
name|XCopyPlane
argument_list|(
name|win
operator|->
name|display
argument_list|,
name|tmpPM
argument_list|,
name|win
operator|->
name|boardwin
argument_list|,
name|DefaultGC
argument_list|(
name|win
operator|->
name|display
argument_list|,
literal|0
argument_list|)
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
name|SQUARE_WIDTH
argument_list|,
name|SQUARE_HEIGHT
argument_list|,
name|x
operator|*
operator|(
name|SQUARE_WIDTH
operator|+
name|BORDER_WIDTH
operator|)
argument_list|,
name|y
operator|*
operator|(
name|SQUARE_HEIGHT
operator|+
name|BORDER_WIDTH
operator|)
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|XFreePixmap
argument_list|(
name|win
operator|->
name|display
argument_list|,
name|tmpPM
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|XSetFillStyle
argument_list|(
name|win
operator|->
name|display
argument_list|,
name|DefaultGC
argument_list|(
name|win
operator|->
name|display
argument_list|,
literal|0
argument_list|)
argument_list|,
name|FillSolid
argument_list|)
expr_stmt|;
name|XSetForeground
argument_list|(
name|win
operator|->
name|display
argument_list|,
name|DefaultGC
argument_list|(
name|win
operator|->
name|display
argument_list|,
literal|0
argument_list|)
argument_list|,
name|iswhite
argument_list|(
name|win
argument_list|,
name|x
argument_list|,
name|y
argument_list|)
condition|?
name|win
operator|->
name|whitesquare
operator|.
name|pixel
else|:
name|win
operator|->
name|blacksquare
operator|.
name|pixel
argument_list|)
expr_stmt|;
name|XFillRectangle
argument_list|(
name|win
operator|->
name|display
argument_list|,
name|win
operator|->
name|boardwin
argument_list|,
name|DefaultGC
argument_list|(
name|win
operator|->
name|display
argument_list|,
literal|0
argument_list|)
argument_list|,
name|x
operator|*
operator|(
name|SQUARE_WIDTH
operator|+
name|BORDER_WIDTH
operator|)
argument_list|,
name|y
operator|*
operator|(
name|SQUARE_HEIGHT
operator|+
name|BORDER_WIDTH
operator|)
argument_list|,
name|SQUARE_WIDTH
argument_list|,
name|SQUARE_HEIGHT
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|record_english
condition|)
block|{
name|gc
operator|.
name|foreground
operator|=
name|win
operator|->
name|textcolor
operator|.
name|pixel
expr_stmt|;
if|if
condition|(
name|iswhite
argument_list|(
name|win
argument_list|,
name|x
argument_list|,
name|y
argument_list|)
operator|||
name|win
operator|->
name|bnw
condition|)
name|gc
operator|.
name|background
operator|=
name|win
operator|->
name|whitesquare
operator|.
name|pixel
expr_stmt|;
else|else
name|gc
operator|.
name|background
operator|=
name|win
operator|->
name|blacksquare
operator|.
name|pixel
expr_stmt|;
name|gc
operator|.
name|font
operator|=
name|win
operator|->
name|small
operator|->
name|fid
expr_stmt|;
name|XChangeGC
argument_list|(
name|win
operator|->
name|display
argument_list|,
name|DefaultGC
argument_list|(
name|win
operator|->
name|display
argument_list|,
literal|0
argument_list|)
argument_list|,
name|GCForeground
operator||
name|GCBackground
operator||
name|GCFont
argument_list|,
operator|&
name|gc
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|x
condition|)
block|{
name|sprintf
argument_list|(
name|buf
argument_list|,
literal|" %d"
argument_list|,
name|SIZE
operator|-
name|y
argument_list|)
expr_stmt|;
name|XDrawImageString
argument_list|(
name|win
operator|->
name|display
argument_list|,
name|win
operator|->
name|boardwin
argument_list|,
name|DefaultGC
argument_list|(
name|win
operator|->
name|display
argument_list|,
literal|0
argument_list|)
argument_list|,
literal|1
argument_list|,
operator|(
name|y
operator|+
literal|1
operator|)
operator|*
operator|(
name|SQUARE_HEIGHT
operator|+
name|BORDER_WIDTH
operator|)
operator|-
name|BORDER_WIDTH
operator|+
name|win
operator|->
name|small
operator|->
name|max_bounds
operator|.
name|ascent
operator|-
literal|1
argument_list|,
name|buf
argument_list|,
literal|2
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|y
operator|==
name|SIZE
operator|-
literal|1
condition|)
block|{
name|sprintf
argument_list|(
name|buf
argument_list|,
literal|"%c"
argument_list|,
literal|'A'
operator|+
name|x
argument_list|)
expr_stmt|;
name|XDrawImageString
argument_list|(
name|win
operator|->
name|display
argument_list|,
name|win
operator|->
name|boardwin
argument_list|,
name|DefaultGC
argument_list|(
name|win
operator|->
name|display
argument_list|,
literal|0
argument_list|)
argument_list|,
name|x
operator|*
operator|(
name|SQUARE_WIDTH
operator|+
name|BORDER_WIDTH
operator|)
operator|+
literal|1
argument_list|,
name|SIZE
operator|*
operator|(
name|SQUARE_HEIGHT
operator|+
name|BORDER_WIDTH
operator|)
operator|-
name|BORDER_WIDTH
operator|+
name|win
operator|->
name|small
operator|->
name|max_bounds
operator|.
name|ascent
operator|-
literal|1
argument_list|,
name|buf
argument_list|,
literal|1
argument_list|)
expr_stmt|;
block|}
block|}
return|return;
block|}
end_function

begin_function
name|void
name|win_flash
parameter_list|(
name|m
parameter_list|,
name|wnum
parameter_list|)
name|move
modifier|*
name|m
decl_stmt|;
name|color
name|wnum
decl_stmt|;
block|{
name|windata
modifier|*
name|win
decl_stmt|;
name|int
name|sx
decl_stmt|,
name|sy
decl_stmt|,
name|ex
decl_stmt|,
name|ey
decl_stmt|,
name|i
decl_stmt|;
if|if
condition|(
name|oneboard
operator|||
operator|(
name|wnum
operator|==
name|win1
operator|->
name|color
operator|)
condition|)
name|win
operator|=
name|win1
expr_stmt|;
else|else
name|win
operator|=
name|win2
expr_stmt|;
if|if
condition|(
name|win
operator|->
name|flipped
condition|)
block|{
name|sx
operator|=
name|SIZE
operator|-
name|m
operator|->
name|fromx
operator|-
literal|1
expr_stmt|;
name|sy
operator|=
name|SIZE
operator|-
name|m
operator|->
name|fromy
operator|-
literal|1
expr_stmt|;
name|ex
operator|=
name|SIZE
operator|-
name|m
operator|->
name|tox
operator|-
literal|1
expr_stmt|;
name|ey
operator|=
name|SIZE
operator|-
name|m
operator|->
name|toy
operator|-
literal|1
expr_stmt|;
block|}
else|else
block|{
name|sx
operator|=
name|m
operator|->
name|fromx
expr_stmt|;
name|sy
operator|=
name|m
operator|->
name|fromy
expr_stmt|;
name|ex
operator|=
name|m
operator|->
name|tox
expr_stmt|;
name|ey
operator|=
name|m
operator|->
name|toy
expr_stmt|;
block|}
name|sx
operator|=
name|sx
operator|*
operator|(
name|SQUARE_WIDTH
operator|+
name|BORDER_WIDTH
operator|)
operator|+
name|SQUARE_WIDTH
operator|/
literal|2
expr_stmt|;
name|sy
operator|=
name|sy
operator|*
operator|(
name|SQUARE_HEIGHT
operator|+
name|BORDER_WIDTH
operator|)
operator|+
name|SQUARE_HEIGHT
operator|/
literal|2
expr_stmt|;
name|ex
operator|=
name|ex
operator|*
operator|(
name|SQUARE_WIDTH
operator|+
name|BORDER_WIDTH
operator|)
operator|+
name|SQUARE_WIDTH
operator|/
literal|2
expr_stmt|;
name|ey
operator|=
name|ey
operator|*
operator|(
name|SQUARE_HEIGHT
operator|+
name|BORDER_WIDTH
operator|)
operator|+
name|SQUARE_HEIGHT
operator|/
literal|2
expr_stmt|;
name|XSetFunction
argument_list|(
name|win
operator|->
name|display
argument_list|,
name|DefaultGC
argument_list|(
name|win
operator|->
name|display
argument_list|,
literal|0
argument_list|)
argument_list|,
name|GXinvert
argument_list|)
expr_stmt|;
name|XSetLineAttributes
argument_list|(
name|win
operator|->
name|display
argument_list|,
name|DefaultGC
argument_list|(
name|win
operator|->
name|display
argument_list|,
literal|0
argument_list|)
argument_list|,
literal|0
argument_list|,
name|LineSolid
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|num_flashes
operator|*
literal|2
condition|;
name|i
operator|++
control|)
block|{
name|XDrawLine
argument_list|(
name|win
operator|->
name|display
argument_list|,
name|win
operator|->
name|boardwin
argument_list|,
name|DefaultGC
argument_list|(
name|win
operator|->
name|display
argument_list|,
literal|0
argument_list|)
argument_list|,
name|sx
argument_list|,
name|sy
argument_list|,
name|ex
argument_list|,
name|ey
argument_list|)
expr_stmt|;
block|}
name|XSetFunction
argument_list|(
name|win
operator|->
name|display
argument_list|,
name|DefaultGC
argument_list|(
name|win
operator|->
name|display
argument_list|,
literal|0
argument_list|)
argument_list|,
name|GXcopy
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_comment
comment|/* Handle input from the players. */
end_comment

begin_function
name|void
name|win_process
parameter_list|(
name|quick
parameter_list|)
name|bool
name|quick
decl_stmt|;
block|{
name|int
name|i
decl_stmt|,
name|rfd
init|=
literal|0
decl_stmt|,
name|wfd
init|=
literal|0
decl_stmt|,
name|xfd
init|=
literal|0
decl_stmt|;
name|struct
name|timeval
name|timeout
decl_stmt|;
name|timeout
operator|.
name|tv_sec
operator|=
literal|0
expr_stmt|;
name|timeout
operator|.
name|tv_usec
operator|=
operator|(
name|quick
condition|?
literal|0
else|:
literal|500000
operator|)
expr_stmt|;
if|if
condition|(
name|XPending
argument_list|(
name|win1
operator|->
name|display
argument_list|)
condition|)
name|service
argument_list|(
name|win1
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|oneboard
condition|)
block|{
if|if
condition|(
name|XPending
argument_list|(
name|win1
operator|->
name|display
argument_list|)
condition|)
name|service
argument_list|(
name|win2
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|oneboard
condition|)
name|rfd
operator|=
literal|1
operator|<<
name|win1
operator|->
name|display
operator|->
name|fd
expr_stmt|;
else|else
name|rfd
operator|=
operator|(
literal|1
operator|<<
name|win1
operator|->
name|display
operator|->
name|fd
operator|)
operator||
operator|(
literal|1
operator|<<
name|win2
operator|->
name|display
operator|->
name|fd
operator|)
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|i
operator|=
name|select
argument_list|(
literal|32
argument_list|,
operator|&
name|rfd
argument_list|,
operator|&
name|wfd
argument_list|,
operator|&
name|xfd
argument_list|,
operator|&
name|timeout
argument_list|)
operator|)
condition|)
return|return;
if|if
condition|(
name|i
operator|==
operator|-
literal|1
condition|)
block|{
name|perror
argument_list|(
literal|"select"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|rfd
operator|&
operator|(
literal|1
operator|<<
name|win1
operator|->
name|display
operator|->
name|fd
operator|)
condition|)
name|service
argument_list|(
name|win1
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|oneboard
operator|&&
operator|(
name|rfd
operator|&
operator|(
literal|1
operator|<<
name|win2
operator|->
name|display
operator|->
name|fd
operator|)
operator|)
condition|)
name|service
argument_list|(
name|win2
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_function
specifier|static
name|void
name|service
parameter_list|(
name|win
parameter_list|)
name|windata
modifier|*
name|win
decl_stmt|;
block|{
name|XEvent
name|ev
decl_stmt|;
while|while
condition|(
name|XPending
argument_list|(
name|win
operator|->
name|display
argument_list|)
condition|)
block|{
name|XNextEvent
argument_list|(
name|win
operator|->
name|display
argument_list|,
operator|&
name|ev
argument_list|)
expr_stmt|;
if|if
condition|(
name|TxtFilter
argument_list|(
name|win
operator|->
name|display
argument_list|,
operator|&
name|ev
argument_list|)
condition|)
continue|continue;
if|if
condition|(
name|ev
operator|.
name|xany
operator|.
name|window
operator|==
name|win
operator|->
name|boardwin
condition|)
block|{
switch|switch
condition|(
name|ev
operator|.
name|type
condition|)
block|{
case|case
name|ButtonPress
case|:
name|button_pressed
argument_list|(
operator|&
name|ev
argument_list|,
name|win
argument_list|)
expr_stmt|;
break|break;
case|case
name|ButtonRelease
case|:
name|button_released
argument_list|(
operator|&
name|ev
argument_list|,
name|win
argument_list|)
expr_stmt|;
break|break;
case|case
name|Expose
case|:
comment|/* Redraw... */
name|win_redraw
argument_list|(
name|win
argument_list|,
operator|&
name|ev
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0
case|:
case|case
name|NoExpose
case|:
break|break;
default|default:
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Bad event type %d\n"
argument_list|,
name|ev
operator|.
name|type
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
block|}
elseif|else
if|if
condition|(
name|ev
operator|.
name|xany
operator|.
name|window
operator|==
name|win
operator|->
name|wclockwin
condition|)
block|{
switch|switch
condition|(
name|ev
operator|.
name|type
condition|)
block|{
case|case
name|Expose
case|:
name|clock_draw
argument_list|(
name|win
argument_list|,
name|WHITE
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0
case|:
case|case
name|NoExpose
case|:
break|break;
default|default:
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Bad event type %d\n"
argument_list|,
name|ev
operator|.
name|type
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
block|}
elseif|else
if|if
condition|(
name|ev
operator|.
name|xany
operator|.
name|window
operator|==
name|win
operator|->
name|bclockwin
condition|)
block|{
switch|switch
condition|(
name|ev
operator|.
name|type
condition|)
block|{
case|case
name|Expose
case|:
name|clock_draw
argument_list|(
name|win
argument_list|,
name|BLACK
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0
case|:
case|case
name|NoExpose
case|:
break|break;
default|default:
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Bad event type %d\n"
argument_list|,
name|ev
operator|.
name|type
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
block|}
elseif|else
if|if
condition|(
name|ev
operator|.
name|xany
operator|.
name|window
operator|==
name|win
operator|->
name|jailwin
condition|)
block|{
switch|switch
condition|(
name|ev
operator|.
name|type
condition|)
block|{
case|case
name|Expose
case|:
name|jail_draw
argument_list|(
name|win
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0
case|:
case|case
name|NoExpose
case|:
break|break;
default|default:
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Bad event type %d\n"
argument_list|,
name|ev
operator|.
name|type
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
block|}
elseif|else
if|if
condition|(
name|ev
operator|.
name|xany
operator|.
name|window
operator|==
name|win
operator|->
name|buttonwin
condition|)
block|{
switch|switch
condition|(
name|ev
operator|.
name|type
condition|)
block|{
case|case
name|ButtonPress
case|:
name|button_service
argument_list|(
name|win
argument_list|,
operator|&
name|ev
argument_list|)
expr_stmt|;
break|break;
case|case
name|Expose
case|:
name|button_draw
argument_list|(
name|win
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0
case|:
case|case
name|NoExpose
case|:
break|break;
default|default:
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Bad event type %d\n"
argument_list|,
name|ev
operator|.
name|type
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
block|}
elseif|else
if|if
condition|(
name|ev
operator|.
name|xany
operator|.
name|window
operator|==
name|win
operator|->
name|icon
condition|)
block|{
name|icon_refresh
argument_list|(
name|win
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|ev
operator|.
name|xany
operator|.
name|window
operator|==
name|win
operator|->
name|basewin
condition|)
block|{
name|message_send
argument_list|(
name|win
argument_list|,
operator|&
name|ev
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Internal Error: service: bad win\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"window = %d, event = %d\n"
argument_list|,
name|ev
operator|.
name|xany
operator|.
name|window
argument_list|,
name|ev
operator|.
name|type
argument_list|)
expr_stmt|;
block|}
block|}
return|return;
block|}
end_function

begin_function
name|void
name|win_redraw
parameter_list|(
name|win
parameter_list|,
name|event
parameter_list|)
name|windata
modifier|*
name|win
decl_stmt|;
name|XEvent
modifier|*
name|event
decl_stmt|;
block|{
name|XExposeEvent
modifier|*
name|ev
init|=
operator|&
name|event
operator|->
name|xexpose
decl_stmt|;
name|int
name|x1
decl_stmt|,
name|y1
decl_stmt|,
name|x2
decl_stmt|,
name|y2
decl_stmt|,
name|i
decl_stmt|,
name|j
decl_stmt|;
name|drawgrid
argument_list|(
name|win
argument_list|)
expr_stmt|;
if|if
condition|(
name|ev
condition|)
block|{
name|x1
operator|=
name|ev
operator|->
name|x
operator|/
operator|(
name|SQUARE_WIDTH
operator|+
name|BORDER_WIDTH
operator|)
expr_stmt|;
name|y1
operator|=
name|ev
operator|->
name|y
operator|/
operator|(
name|SQUARE_HEIGHT
operator|+
name|BORDER_WIDTH
operator|)
expr_stmt|;
name|x2
operator|=
operator|(
name|ev
operator|->
name|x
operator|+
name|ev
operator|->
name|width
operator|)
operator|/
operator|(
name|SQUARE_WIDTH
operator|+
name|BORDER_WIDTH
operator|)
expr_stmt|;
name|y2
operator|=
operator|(
name|ev
operator|->
name|y
operator|+
name|ev
operator|->
name|height
operator|)
operator|/
operator|(
name|SQUARE_HEIGHT
operator|+
name|BORDER_WIDTH
operator|)
expr_stmt|;
block|}
else|else
block|{
name|x1
operator|=
literal|0
expr_stmt|;
name|y1
operator|=
literal|0
expr_stmt|;
name|x2
operator|=
name|SIZE
operator|-
literal|1
expr_stmt|;
name|y2
operator|=
name|SIZE
operator|-
literal|1
expr_stmt|;
block|}
if|if
condition|(
name|x1
operator|<
literal|0
condition|)
name|x1
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|y1
operator|<
literal|0
condition|)
name|y1
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|x2
operator|<
literal|0
condition|)
name|x2
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|y2
operator|<
literal|0
condition|)
name|y2
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|x1
operator|>
name|SIZE
operator|-
literal|1
condition|)
name|x1
operator|=
name|SIZE
operator|-
literal|1
expr_stmt|;
if|if
condition|(
name|y1
operator|>
name|SIZE
operator|-
literal|1
condition|)
name|y1
operator|=
name|SIZE
operator|-
literal|1
expr_stmt|;
if|if
condition|(
name|x2
operator|>
name|SIZE
operator|-
literal|1
condition|)
name|x2
operator|=
name|SIZE
operator|-
literal|1
expr_stmt|;
if|if
condition|(
name|y2
operator|>
name|SIZE
operator|-
literal|1
condition|)
name|y2
operator|=
name|SIZE
operator|-
literal|1
expr_stmt|;
if|if
condition|(
name|win
operator|->
name|flipped
condition|)
block|{
name|y1
operator|=
name|SIZE
operator|-
name|y2
operator|-
literal|1
expr_stmt|;
name|y2
operator|=
name|SIZE
operator|-
name|y1
operator|-
literal|1
expr_stmt|;
name|x1
operator|=
name|SIZE
operator|-
name|x2
operator|-
literal|1
expr_stmt|;
name|x2
operator|=
name|SIZE
operator|-
name|x1
operator|-
literal|1
expr_stmt|;
block|}
for|for
control|(
name|i
operator|=
name|x1
init|;
name|i
operator|<=
name|x2
condition|;
name|i
operator|++
control|)
for|for
control|(
name|j
operator|=
name|y1
init|;
name|j
operator|<=
name|y2
condition|;
name|j
operator|++
control|)
block|{
if|if
condition|(
name|chessboard
operator|->
name|square
index|[
name|j
index|]
index|[
name|i
index|]
operator|.
name|color
operator|==
name|NONE
condition|)
name|win_erasepiece
argument_list|(
name|j
argument_list|,
name|i
argument_list|,
name|WHITE
argument_list|)
expr_stmt|;
else|else
name|win_drawpiece
argument_list|(
operator|&
name|chessboard
operator|->
name|square
index|[
name|j
index|]
index|[
name|i
index|]
argument_list|,
name|j
argument_list|,
name|i
argument_list|,
name|WHITE
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|oneboard
condition|)
block|{
if|if
condition|(
name|chessboard
operator|->
name|square
index|[
name|j
index|]
index|[
name|i
index|]
operator|.
name|color
operator|==
name|NONE
condition|)
name|win_erasepiece
argument_list|(
name|j
argument_list|,
name|i
argument_list|,
name|BLACK
argument_list|)
expr_stmt|;
else|else
name|win_drawpiece
argument_list|(
operator|&
name|chessboard
operator|->
name|square
index|[
name|j
index|]
index|[
name|i
index|]
argument_list|,
name|j
argument_list|,
name|i
argument_list|,
name|BLACK
argument_list|)
expr_stmt|;
block|}
block|}
return|return;
block|}
end_function

begin_function
specifier|static
name|bool
name|setup
parameter_list|(
name|dispname
parameter_list|,
name|win
parameter_list|)
name|char
modifier|*
name|dispname
decl_stmt|;
name|windata
modifier|*
name|win
decl_stmt|;
block|{
name|char
name|buf
index|[
name|BSIZE
index|]
decl_stmt|,
modifier|*
name|s
decl_stmt|;
name|Pixmap
name|bm
decl_stmt|,
name|bmask
decl_stmt|;
name|Cursor
name|cur
decl_stmt|;
specifier|extern
name|char
modifier|*
name|program
decl_stmt|,
modifier|*
name|recfile
decl_stmt|;
name|XSizeHints
name|xsizes
decl_stmt|;
if|if
condition|(
operator|!
operator|(
name|win
operator|->
name|display
operator|=
name|XOpenDisplay
argument_list|(
name|dispname
argument_list|)
operator|)
condition|)
return|return
operator|(
name|false
operator|)
return|;
comment|/* Now get boolean defaults... */
if|if
condition|(
operator|(
name|s
operator|=
name|XGetDefault
argument_list|(
name|win
operator|->
name|display
argument_list|,
name|program
argument_list|,
literal|"noisy"
argument_list|)
operator|)
operator|&&
name|eq
argument_list|(
name|s
argument_list|,
literal|"on"
argument_list|)
condition|)
name|noisyflag
operator|=
name|true
expr_stmt|;
if|if
condition|(
operator|(
name|s
operator|=
name|XGetDefault
argument_list|(
name|win
operator|->
name|display
argument_list|,
name|program
argument_list|,
literal|"savemoves"
argument_list|)
operator|)
operator|&&
name|eq
argument_list|(
name|s
argument_list|,
literal|"on"
argument_list|)
condition|)
name|saveflag
operator|=
name|true
expr_stmt|;
if|if
condition|(
operator|(
name|s
operator|=
name|XGetDefault
argument_list|(
name|win
operator|->
name|display
argument_list|,
name|program
argument_list|,
literal|"algebraic"
argument_list|)
operator|)
operator|&&
name|eq
argument_list|(
name|s
argument_list|,
literal|"on"
argument_list|)
condition|)
name|record_english
operator|=
name|false
expr_stmt|;
if|if
condition|(
operator|(
name|s
operator|=
name|XGetDefault
argument_list|(
name|win
operator|->
name|display
argument_list|,
name|program
argument_list|,
literal|"blackandwhite"
argument_list|)
operator|)
operator|&&
name|eq
argument_list|(
name|s
argument_list|,
literal|"on"
argument_list|)
condition|)
name|bnwflag
operator|=
name|true
expr_stmt|;
if|if
condition|(
operator|(
name|s
operator|=
name|XGetDefault
argument_list|(
name|win
operator|->
name|display
argument_list|,
name|program
argument_list|,
literal|"quickrestore"
argument_list|)
operator|)
operator|&&
name|eq
argument_list|(
name|s
argument_list|,
literal|"on"
argument_list|)
condition|)
name|quickflag
operator|=
name|true
expr_stmt|;
if|if
condition|(
operator|(
name|s
operator|=
name|XGetDefault
argument_list|(
name|win
operator|->
name|display
argument_list|,
name|program
argument_list|,
literal|"flash"
argument_list|)
operator|)
operator|&&
name|eq
argument_list|(
name|s
argument_list|,
literal|"on"
argument_list|)
condition|)
name|win_flashmove
operator|=
name|true
expr_stmt|;
comment|/* ... numeric variables ... */
if|if
condition|(
name|s
operator|=
name|XGetDefault
argument_list|(
name|win
operator|->
name|display
argument_list|,
name|program
argument_list|,
literal|"numflashes"
argument_list|)
condition|)
name|num_flashes
operator|=
name|atoi
argument_list|(
name|s
argument_list|)
expr_stmt|;
if|if
condition|(
name|s
operator|=
name|XGetDefault
argument_list|(
name|win
operator|->
name|display
argument_list|,
name|program
argument_list|,
literal|"flashsize"
argument_list|)
condition|)
name|flash_size
operator|=
name|atoi
argument_list|(
name|s
argument_list|)
expr_stmt|;
comment|/* ... and strings. */
if|if
condition|(
name|s
operator|=
name|XGetDefault
argument_list|(
name|win
operator|->
name|display
argument_list|,
name|program
argument_list|,
literal|"progname"
argument_list|)
condition|)
name|progname
operator|=
name|s
expr_stmt|;
if|if
condition|(
name|s
operator|=
name|XGetDefault
argument_list|(
name|win
operator|->
name|display
argument_list|,
name|program
argument_list|,
literal|"proghost"
argument_list|)
condition|)
name|proghost
operator|=
name|s
expr_stmt|;
if|if
condition|(
name|s
operator|=
name|XGetDefault
argument_list|(
name|win
operator|->
name|display
argument_list|,
name|program
argument_list|,
literal|"recordfile"
argument_list|)
condition|)
name|recfile
operator|=
name|s
expr_stmt|;
if|if
condition|(
name|s
operator|=
name|XGetDefault
argument_list|(
name|win
operator|->
name|display
argument_list|,
name|program
argument_list|,
literal|"blackpiece"
argument_list|)
condition|)
name|black_piece_color
operator|=
name|s
expr_stmt|;
if|if
condition|(
name|s
operator|=
name|XGetDefault
argument_list|(
name|win
operator|->
name|display
argument_list|,
name|program
argument_list|,
literal|"whitepiece"
argument_list|)
condition|)
name|white_piece_color
operator|=
name|s
expr_stmt|;
if|if
condition|(
name|s
operator|=
name|XGetDefault
argument_list|(
name|win
operator|->
name|display
argument_list|,
name|program
argument_list|,
literal|"blacksquare"
argument_list|)
condition|)
name|black_square_color
operator|=
name|s
expr_stmt|;
if|if
condition|(
name|s
operator|=
name|XGetDefault
argument_list|(
name|win
operator|->
name|display
argument_list|,
name|program
argument_list|,
literal|"whitesquare"
argument_list|)
condition|)
name|white_square_color
operator|=
name|s
expr_stmt|;
if|if
condition|(
name|s
operator|=
name|XGetDefault
argument_list|(
name|win
operator|->
name|display
argument_list|,
name|program
argument_list|,
literal|"bordercolor"
argument_list|)
condition|)
name|border_color
operator|=
name|s
expr_stmt|;
if|if
condition|(
name|s
operator|=
name|XGetDefault
argument_list|(
name|win
operator|->
name|display
argument_list|,
name|program
argument_list|,
literal|"textcolor"
argument_list|)
condition|)
name|text_color
operator|=
name|s
expr_stmt|;
if|if
condition|(
name|s
operator|=
name|XGetDefault
argument_list|(
name|win
operator|->
name|display
argument_list|,
name|program
argument_list|,
literal|"textback"
argument_list|)
condition|)
name|text_back
operator|=
name|s
expr_stmt|;
if|if
condition|(
name|s
operator|=
name|XGetDefault
argument_list|(
name|win
operator|->
name|display
argument_list|,
name|program
argument_list|,
literal|"errortext"
argument_list|)
condition|)
name|error_text
operator|=
name|s
expr_stmt|;
if|if
condition|(
name|s
operator|=
name|XGetDefault
argument_list|(
name|win
operator|->
name|display
argument_list|,
name|program
argument_list|,
literal|"playertext"
argument_list|)
condition|)
name|player_text
operator|=
name|s
expr_stmt|;
if|if
condition|(
name|s
operator|=
name|XGetDefault
argument_list|(
name|win
operator|->
name|display
argument_list|,
name|program
argument_list|,
literal|"cursorcolor"
argument_list|)
condition|)
name|cursor_color
operator|=
name|s
expr_stmt|;
if|if
condition|(
operator|(
name|DisplayPlanes
argument_list|(
name|win
operator|->
name|display
argument_list|,
literal|0
argument_list|)
operator|==
literal|1
operator|)
operator|||
name|bnwflag
condition|)
name|win
operator|->
name|bnw
operator|=
name|true
expr_stmt|;
comment|/* Allocate colors... */
if|if
condition|(
name|win
operator|->
name|bnw
condition|)
block|{
name|win
operator|->
name|blackpiece
operator|.
name|pixel
operator|=
name|BlackPixel
argument_list|(
name|win
operator|->
name|display
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|win
operator|->
name|whitepiece
operator|.
name|pixel
operator|=
name|WhitePixel
argument_list|(
name|win
operator|->
name|display
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|win
operator|->
name|blacksquare
operator|.
name|pixel
operator|=
name|BlackPixel
argument_list|(
name|win
operator|->
name|display
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|win
operator|->
name|whitesquare
operator|.
name|pixel
operator|=
name|WhitePixel
argument_list|(
name|win
operator|->
name|display
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|win
operator|->
name|border
operator|.
name|pixel
operator|=
name|BlackPixel
argument_list|(
name|win
operator|->
name|display
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|win
operator|->
name|textcolor
operator|.
name|pixel
operator|=
name|BlackPixel
argument_list|(
name|win
operator|->
name|display
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|win
operator|->
name|textback
operator|.
name|pixel
operator|=
name|WhitePixel
argument_list|(
name|win
operator|->
name|display
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|win
operator|->
name|playertext
operator|.
name|pixel
operator|=
name|BlackPixel
argument_list|(
name|win
operator|->
name|display
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|win
operator|->
name|errortext
operator|.
name|pixel
operator|=
name|BlackPixel
argument_list|(
name|win
operator|->
name|display
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|win
operator|->
name|cursorcolor
operator|.
name|pixel
operator|=
name|BlackPixel
argument_list|(
name|win
operator|->
name|display
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
operator|!
name|XParseColor
argument_list|(
name|win
operator|->
name|display
argument_list|,
name|DefaultColormap
argument_list|(
name|win
operator|->
name|display
argument_list|,
literal|0
argument_list|)
argument_list|,
name|black_piece_color
argument_list|,
operator|&
name|win
operator|->
name|blackpiece
argument_list|)
operator|||
operator|!
name|XParseColor
argument_list|(
name|win
operator|->
name|display
argument_list|,
name|DefaultColormap
argument_list|(
name|win
operator|->
name|display
argument_list|,
literal|0
argument_list|)
argument_list|,
name|white_piece_color
argument_list|,
operator|&
name|win
operator|->
name|whitepiece
argument_list|)
operator|||
operator|!
name|XParseColor
argument_list|(
name|win
operator|->
name|display
argument_list|,
name|DefaultColormap
argument_list|(
name|win
operator|->
name|display
argument_list|,
literal|0
argument_list|)
argument_list|,
name|black_square_color
argument_list|,
operator|&
name|win
operator|->
name|blacksquare
argument_list|)
operator|||
operator|!
name|XParseColor
argument_list|(
name|win
operator|->
name|display
argument_list|,
name|DefaultColormap
argument_list|(
name|win
operator|->
name|display
argument_list|,
literal|0
argument_list|)
argument_list|,
name|white_square_color
argument_list|,
operator|&
name|win
operator|->
name|whitesquare
argument_list|)
operator|||
operator|!
name|XParseColor
argument_list|(
name|win
operator|->
name|display
argument_list|,
name|DefaultColormap
argument_list|(
name|win
operator|->
name|display
argument_list|,
literal|0
argument_list|)
argument_list|,
name|border_color
argument_list|,
operator|&
name|win
operator|->
name|border
argument_list|)
operator|||
operator|!
name|XParseColor
argument_list|(
name|win
operator|->
name|display
argument_list|,
name|DefaultColormap
argument_list|(
name|win
operator|->
name|display
argument_list|,
literal|0
argument_list|)
argument_list|,
name|text_color
argument_list|,
operator|&
name|win
operator|->
name|textcolor
argument_list|)
operator|||
operator|!
name|XParseColor
argument_list|(
name|win
operator|->
name|display
argument_list|,
name|DefaultColormap
argument_list|(
name|win
operator|->
name|display
argument_list|,
literal|0
argument_list|)
argument_list|,
name|text_back
argument_list|,
operator|&
name|win
operator|->
name|textback
argument_list|)
operator|||
operator|!
name|XParseColor
argument_list|(
name|win
operator|->
name|display
argument_list|,
name|DefaultColormap
argument_list|(
name|win
operator|->
name|display
argument_list|,
literal|0
argument_list|)
argument_list|,
name|error_text
argument_list|,
operator|&
name|win
operator|->
name|errortext
argument_list|)
operator|||
operator|!
name|XParseColor
argument_list|(
name|win
operator|->
name|display
argument_list|,
name|DefaultColormap
argument_list|(
name|win
operator|->
name|display
argument_list|,
literal|0
argument_list|)
argument_list|,
name|player_text
argument_list|,
operator|&
name|win
operator|->
name|playertext
argument_list|)
operator|||
operator|!
name|XParseColor
argument_list|(
name|win
operator|->
name|display
argument_list|,
name|DefaultColormap
argument_list|(
name|win
operator|->
name|display
argument_list|,
literal|0
argument_list|)
argument_list|,
name|cursor_color
argument_list|,
operator|&
name|win
operator|->
name|cursorcolor
argument_list|)
operator|||
operator|!
name|XAllocColor
argument_list|(
name|win
operator|->
name|display
argument_list|,
name|DefaultColormap
argument_list|(
name|win
operator|->
name|display
argument_list|,
literal|0
argument_list|)
argument_list|,
operator|&
name|win
operator|->
name|blackpiece
argument_list|)
operator|||
operator|!
name|XAllocColor
argument_list|(
name|win
operator|->
name|display
argument_list|,
name|DefaultColormap
argument_list|(
name|win
operator|->
name|display
argument_list|,
literal|0
argument_list|)
argument_list|,
operator|&
name|win
operator|->
name|whitepiece
argument_list|)
operator|||
operator|!
name|XAllocColor
argument_list|(
name|win
operator|->
name|display
argument_list|,
name|DefaultColormap
argument_list|(
name|win
operator|->
name|display
argument_list|,
literal|0
argument_list|)
argument_list|,
operator|&
name|win
operator|->
name|blacksquare
argument_list|)
operator|||
operator|!
name|XAllocColor
argument_list|(
name|win
operator|->
name|display
argument_list|,
name|DefaultColormap
argument_list|(
name|win
operator|->
name|display
argument_list|,
literal|0
argument_list|)
argument_list|,
operator|&
name|win
operator|->
name|whitesquare
argument_list|)
operator|||
operator|!
name|XAllocColor
argument_list|(
name|win
operator|->
name|display
argument_list|,
name|DefaultColormap
argument_list|(
name|win
operator|->
name|display
argument_list|,
literal|0
argument_list|)
argument_list|,
operator|&
name|win
operator|->
name|border
argument_list|)
operator|||
operator|!
name|XAllocColor
argument_list|(
name|win
operator|->
name|display
argument_list|,
name|DefaultColormap
argument_list|(
name|win
operator|->
name|display
argument_list|,
literal|0
argument_list|)
argument_list|,
operator|&
name|win
operator|->
name|textcolor
argument_list|)
operator|||
operator|!
name|XAllocColor
argument_list|(
name|win
operator|->
name|display
argument_list|,
name|DefaultColormap
argument_list|(
name|win
operator|->
name|display
argument_list|,
literal|0
argument_list|)
argument_list|,
operator|&
name|win
operator|->
name|textback
argument_list|)
operator|||
operator|!
name|XAllocColor
argument_list|(
name|win
operator|->
name|display
argument_list|,
name|DefaultColormap
argument_list|(
name|win
operator|->
name|display
argument_list|,
literal|0
argument_list|)
argument_list|,
operator|&
name|win
operator|->
name|errortext
argument_list|)
operator|||
operator|!
name|XAllocColor
argument_list|(
name|win
operator|->
name|display
argument_list|,
name|DefaultColormap
argument_list|(
name|win
operator|->
name|display
argument_list|,
literal|0
argument_list|)
argument_list|,
operator|&
name|win
operator|->
name|playertext
argument_list|)
operator|||
operator|!
name|XAllocColor
argument_list|(
name|win
operator|->
name|display
argument_list|,
name|DefaultColormap
argument_list|(
name|win
operator|->
name|display
argument_list|,
literal|0
argument_list|)
argument_list|,
operator|&
name|win
operator|->
name|cursorcolor
argument_list|)
condition|)
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Can't get colors...\n"
argument_list|)
expr_stmt|;
block|}
comment|/* Get fonts... */
if|if
condition|(
operator|(
name|win
operator|->
name|small
operator|=
name|XLoadQueryFont
argument_list|(
name|win
operator|->
name|display
argument_list|,
name|SMALL_FONT
argument_list|)
operator|)
operator|==
name|NULL
condition|)
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Can't get small font...\n"
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|win
operator|->
name|medium
operator|=
name|XLoadQueryFont
argument_list|(
name|win
operator|->
name|display
argument_list|,
name|MEDIUM_FONT
argument_list|)
operator|)
operator|==
name|NULL
condition|)
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Can't get medium font...\n"
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|win
operator|->
name|large
operator|=
name|XLoadQueryFont
argument_list|(
name|win
operator|->
name|display
argument_list|,
name|LARGE_FONT
argument_list|)
operator|)
operator|==
name|NULL
condition|)
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Can't get large font...\n"
argument_list|)
expr_stmt|;
comment|/* Create the windows... */
name|win
operator|->
name|basewin
operator|=
name|XCreateSimpleWindow
argument_list|(
name|win
operator|->
name|display
argument_list|,
name|DefaultRootWindow
argument_list|(
name|win
operator|->
name|display
argument_list|)
argument_list|,
name|BASE_XPOS
argument_list|,
name|BASE_YPOS
argument_list|,
name|BASE_WIDTH
argument_list|,
name|BASE_HEIGHT
argument_list|,
literal|0
argument_list|,
name|BlackPixel
argument_list|(
name|win
operator|->
name|display
argument_list|,
literal|0
argument_list|)
argument_list|,
name|WhitePixel
argument_list|(
name|win
operator|->
name|display
argument_list|,
literal|0
argument_list|)
argument_list|)
expr_stmt|;
name|win
operator|->
name|boardwin
operator|=
name|XCreateSimpleWindow
argument_list|(
name|win
operator|->
name|display
argument_list|,
name|win
operator|->
name|basewin
argument_list|,
name|BOARD_XPOS
argument_list|,
name|BOARD_YPOS
argument_list|,
name|BOARD_WIDTH
argument_list|,
name|BOARD_HEIGHT
argument_list|,
name|BORDER_WIDTH
argument_list|,
name|win
operator|->
name|border
operator|.
name|pixel
argument_list|,
name|WhitePixel
argument_list|(
name|win
operator|->
name|display
argument_list|,
literal|0
argument_list|)
argument_list|)
expr_stmt|;
name|win
operator|->
name|recwin
operator|=
name|XCreateSimpleWindow
argument_list|(
name|win
operator|->
name|display
argument_list|,
name|win
operator|->
name|basewin
argument_list|,
name|RECORD_XPOS
argument_list|,
name|RECORD_YPOS
argument_list|,
name|RECORD_WIDTH
argument_list|,
name|RECORD_HEIGHT
argument_list|,
name|BORDER_WIDTH
argument_list|,
name|win
operator|->
name|border
operator|.
name|pixel
argument_list|,
name|win
operator|->
name|textback
operator|.
name|pixel
argument_list|)
expr_stmt|;
name|win
operator|->
name|jailwin
operator|=
name|XCreateSimpleWindow
argument_list|(
name|win
operator|->
name|display
argument_list|,
name|win
operator|->
name|basewin
argument_list|,
name|JAIL_XPOS
argument_list|,
name|JAIL_YPOS
argument_list|,
name|JAIL_WIDTH
argument_list|,
name|JAIL_HEIGHT
argument_list|,
name|BORDER_WIDTH
argument_list|,
name|win
operator|->
name|border
operator|.
name|pixel
argument_list|,
name|win
operator|->
name|textback
operator|.
name|pixel
argument_list|)
expr_stmt|;
name|win
operator|->
name|wclockwin
operator|=
name|XCreateSimpleWindow
argument_list|(
name|win
operator|->
name|display
argument_list|,
name|win
operator|->
name|basewin
argument_list|,
name|WCLOCK_XPOS
argument_list|,
name|WCLOCK_YPOS
argument_list|,
name|CLOCK_WIDTH
argument_list|,
name|CLOCK_HEIGHT
argument_list|,
name|BORDER_WIDTH
argument_list|,
name|win
operator|->
name|border
operator|.
name|pixel
argument_list|,
name|win
operator|->
name|textback
operator|.
name|pixel
argument_list|)
expr_stmt|;
name|win
operator|->
name|bclockwin
operator|=
name|XCreateSimpleWindow
argument_list|(
name|win
operator|->
name|display
argument_list|,
name|win
operator|->
name|basewin
argument_list|,
name|BCLOCK_XPOS
argument_list|,
name|BCLOCK_YPOS
argument_list|,
name|CLOCK_WIDTH
argument_list|,
name|CLOCK_HEIGHT
argument_list|,
name|BORDER_WIDTH
argument_list|,
name|win
operator|->
name|border
operator|.
name|pixel
argument_list|,
name|win
operator|->
name|textback
operator|.
name|pixel
argument_list|)
expr_stmt|;
name|win
operator|->
name|messagewin
operator|=
name|XCreateSimpleWindow
argument_list|(
name|win
operator|->
name|display
argument_list|,
name|win
operator|->
name|basewin
argument_list|,
name|MESS_XPOS
argument_list|,
name|MESS_YPOS
argument_list|,
name|MESS_WIDTH
argument_list|,
name|MESS_HEIGHT
argument_list|,
name|BORDER_WIDTH
argument_list|,
name|win
operator|->
name|border
operator|.
name|pixel
argument_list|,
name|win
operator|->
name|textback
operator|.
name|pixel
argument_list|)
expr_stmt|;
name|win
operator|->
name|buttonwin
operator|=
name|XCreateSimpleWindow
argument_list|(
name|win
operator|->
name|display
argument_list|,
name|win
operator|->
name|basewin
argument_list|,
name|BUTTON_XPOS
argument_list|,
name|BUTTON_YPOS
argument_list|,
name|BUTTON_WIDTH
argument_list|,
name|BUTTON_HEIGHT
argument_list|,
name|BORDER_WIDTH
argument_list|,
name|win
operator|->
name|border
operator|.
name|pixel
argument_list|,
name|win
operator|->
name|textback
operator|.
name|pixel
argument_list|)
expr_stmt|;
comment|/* Let's define an icon... */
name|win
operator|->
name|iconpixmap
operator|=
name|XCreatePixmapFromBitmapData
argument_list|(
name|win
operator|->
name|display
argument_list|,
name|win
operator|->
name|basewin
argument_list|,
name|icon_bits
argument_list|,
name|icon_width
argument_list|,
name|icon_height
argument_list|,
name|win
operator|->
name|blacksquare
operator|.
name|pixel
argument_list|,
name|win
operator|->
name|whitesquare
operator|.
name|pixel
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|xsizes
operator|.
name|flags
operator|=
name|PSize
operator||
name|PMinSize
operator||
name|PPosition
expr_stmt|;
name|xsizes
operator|.
name|min_width
operator|=
name|BASE_WIDTH
expr_stmt|;
name|xsizes
operator|.
name|min_height
operator|=
name|BASE_HEIGHT
expr_stmt|;
name|xsizes
operator|.
name|x
operator|=
name|BASE_XPOS
expr_stmt|;
name|xsizes
operator|.
name|y
operator|=
name|BASE_YPOS
expr_stmt|;
name|XSetStandardProperties
argument_list|(
name|win
operator|->
name|display
argument_list|,
name|win
operator|->
name|basewin
argument_list|,
name|program
argument_list|,
name|program
argument_list|,
name|win
operator|->
name|iconpixmap
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|,
operator|&
name|xsizes
argument_list|)
expr_stmt|;
name|bm
operator|=
name|XCreateBitmapFromData
argument_list|(
name|win
operator|->
name|display
argument_list|,
name|win
operator|->
name|basewin
argument_list|,
name|xchess_bits
argument_list|,
name|xchess_width
argument_list|,
name|xchess_height
argument_list|)
expr_stmt|;
name|bmask
operator|=
name|XCreateBitmapFromData
argument_list|(
name|win
operator|->
name|display
argument_list|,
name|win
operator|->
name|basewin
argument_list|,
name|xchess_mask_bits
argument_list|,
name|xchess_width
argument_list|,
name|xchess_height
argument_list|)
expr_stmt|;
name|cur
operator|=
name|XCreatePixmapCursor
argument_list|(
name|win
operator|->
name|display
argument_list|,
name|bm
argument_list|,
name|bmask
argument_list|,
operator|&
name|win
operator|->
name|cursorcolor
argument_list|,
operator|&
name|WhitePixel
argument_list|(
name|win
operator|->
name|display
argument_list|,
literal|0
argument_list|)
argument_list|,
name|xchess_x_hot
argument_list|,
name|xchess_y_hot
argument_list|)
expr_stmt|;
name|XFreePixmap
argument_list|(
name|win
operator|->
name|display
argument_list|,
name|bm
argument_list|)
expr_stmt|;
name|XFreePixmap
argument_list|(
name|win
operator|->
name|display
argument_list|,
name|bmask
argument_list|)
expr_stmt|;
name|XDefineCursor
argument_list|(
name|win
operator|->
name|display
argument_list|,
name|win
operator|->
name|basewin
argument_list|,
name|cur
argument_list|)
expr_stmt|;
name|XMapSubwindows
argument_list|(
name|win
operator|->
name|display
argument_list|,
name|win
operator|->
name|basewin
argument_list|)
expr_stmt|;
name|XMapRaised
argument_list|(
name|win
operator|->
name|display
argument_list|,
name|win
operator|->
name|basewin
argument_list|)
expr_stmt|;
name|XSelectInput
argument_list|(
name|win
operator|->
name|display
argument_list|,
name|win
operator|->
name|basewin
argument_list|,
name|KeyPressMask
argument_list|)
expr_stmt|;
name|XSelectInput
argument_list|(
name|win
operator|->
name|display
argument_list|,
name|win
operator|->
name|boardwin
argument_list|,
name|ButtonPressMask
operator||
name|ButtonReleaseMask
operator||
name|ExposureMask
argument_list|)
expr_stmt|;
name|XSelectInput
argument_list|(
name|win
operator|->
name|display
argument_list|,
name|win
operator|->
name|recwin
argument_list|,
name|ButtonReleaseMask
operator||
name|ExposureMask
argument_list|)
expr_stmt|;
name|XSelectInput
argument_list|(
name|win
operator|->
name|display
argument_list|,
name|win
operator|->
name|jailwin
argument_list|,
name|ExposureMask
argument_list|)
expr_stmt|;
name|XSelectInput
argument_list|(
name|win
operator|->
name|display
argument_list|,
name|win
operator|->
name|wclockwin
argument_list|,
name|ExposureMask
argument_list|)
expr_stmt|;
name|XSelectInput
argument_list|(
name|win
operator|->
name|display
argument_list|,
name|win
operator|->
name|bclockwin
argument_list|,
name|ExposureMask
argument_list|)
expr_stmt|;
name|XSelectInput
argument_list|(
name|win
operator|->
name|display
argument_list|,
name|win
operator|->
name|messagewin
argument_list|,
name|ButtonReleaseMask
operator||
name|ExposureMask
argument_list|)
expr_stmt|;
name|XSelectInput
argument_list|(
name|win
operator|->
name|display
argument_list|,
name|win
operator|->
name|buttonwin
argument_list|,
name|ButtonPressMask
operator||
name|ExposureMask
argument_list|)
expr_stmt|;
name|message_init
argument_list|(
name|win
argument_list|)
expr_stmt|;
name|record_init
argument_list|(
name|win
argument_list|)
expr_stmt|;
name|button_draw
argument_list|(
name|win
argument_list|)
expr_stmt|;
name|jail_init
argument_list|(
name|win
argument_list|)
expr_stmt|;
name|clock_init
argument_list|(
name|win
argument_list|,
name|WHITE
argument_list|)
expr_stmt|;
name|clock_init
argument_list|(
name|win
argument_list|,
name|BLACK
argument_list|)
expr_stmt|;
if|if
condition|(
name|timeunit
condition|)
block|{
if|if
condition|(
name|timeunit
operator|>
literal|1800
condition|)
name|sprintf
argument_list|(
name|buf
argument_list|,
literal|"%d moves every %.2lg hours.\n"
argument_list|,
name|movesperunit
argument_list|,
operator|(
operator|(
name|double
operator|)
name|timeunit
operator|)
operator|/
literal|3600
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|timeunit
operator|>
literal|30
condition|)
name|sprintf
argument_list|(
name|buf
argument_list|,
literal|"%d moves every %.2lg minutes.\n"
argument_list|,
name|movesperunit
argument_list|,
operator|(
operator|(
name|double
operator|)
name|timeunit
operator|)
operator|/
literal|60
argument_list|)
expr_stmt|;
else|else
name|sprintf
argument_list|(
name|buf
argument_list|,
literal|"%d moves every %d seconds.\n"
argument_list|,
name|movesperunit
argument_list|,
name|timeunit
argument_list|)
expr_stmt|;
name|message_add
argument_list|(
name|win
argument_list|,
name|buf
argument_list|,
name|false
argument_list|)
expr_stmt|;
block|}
return|return
operator|(
name|true
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|drawgrid
parameter_list|(
name|win
parameter_list|)
name|windata
modifier|*
name|win
decl_stmt|;
block|{
name|int
name|i
decl_stmt|;
name|XGCValues
name|gc
decl_stmt|;
name|gc
operator|.
name|function
operator|=
name|GXcopy
expr_stmt|;
name|gc
operator|.
name|plane_mask
operator|=
name|AllPlanes
expr_stmt|;
name|gc
operator|.
name|foreground
operator|=
name|win
operator|->
name|border
operator|.
name|pixel
expr_stmt|;
name|gc
operator|.
name|line_width
operator|=
literal|0
expr_stmt|;
name|gc
operator|.
name|line_style
operator|=
name|LineSolid
expr_stmt|;
name|XChangeGC
argument_list|(
name|win
operator|->
name|display
argument_list|,
name|DefaultGC
argument_list|(
name|win
operator|->
name|display
argument_list|,
literal|0
argument_list|)
argument_list|,
name|GCFunction
operator||
name|GCPlaneMask
operator||
name|GCForeground
operator||
name|GCLineWidth
operator||
name|GCLineStyle
argument_list|,
operator|&
name|gc
argument_list|)
expr_stmt|;
comment|/* Draw the lines... horizontal, */
for|for
control|(
name|i
operator|=
literal|1
init|;
name|i
operator|<
name|SIZE
condition|;
name|i
operator|++
control|)
name|XDrawLine
argument_list|(
name|win
operator|->
name|display
argument_list|,
name|win
operator|->
name|boardwin
argument_list|,
name|DefaultGC
argument_list|(
name|win
operator|->
name|display
argument_list|,
literal|0
argument_list|)
argument_list|,
literal|0
argument_list|,
name|i
operator|*
operator|(
name|SQUARE_WIDTH
operator|+
name|BORDER_WIDTH
operator|)
operator|-
name|BORDER_WIDTH
operator|/
literal|2
argument_list|,
name|SIZE
operator|*
operator|(
name|SQUARE_WIDTH
operator|+
name|BORDER_WIDTH
operator|)
argument_list|,
name|i
operator|*
operator|(
name|SQUARE_WIDTH
operator|+
name|BORDER_WIDTH
operator|)
operator|-
name|BORDER_WIDTH
operator|/
literal|2
argument_list|)
expr_stmt|;
comment|/* and vertical... */
for|for
control|(
name|i
operator|=
literal|1
init|;
name|i
operator|<
name|SIZE
condition|;
name|i
operator|++
control|)
name|XDrawLine
argument_list|(
name|win
operator|->
name|display
argument_list|,
name|win
operator|->
name|boardwin
argument_list|,
name|DefaultGC
argument_list|(
name|win
operator|->
name|display
argument_list|,
literal|0
argument_list|)
argument_list|,
name|i
operator|*
operator|(
name|SQUARE_WIDTH
operator|+
name|BORDER_WIDTH
operator|)
operator|-
name|BORDER_WIDTH
operator|/
literal|2
argument_list|,
literal|0
argument_list|,
name|i
operator|*
operator|(
name|SQUARE_WIDTH
operator|+
name|BORDER_WIDTH
operator|)
operator|-
name|BORDER_WIDTH
operator|/
literal|2
argument_list|,
name|SIZE
operator|*
operator|(
name|SQUARE_WIDTH
operator|+
name|BORDER_WIDTH
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_function
name|void
name|win_restart
parameter_list|()
block|{
name|win1
operator|->
name|flipped
operator|=
name|false
expr_stmt|;
name|win_redraw
argument_list|(
name|win1
argument_list|,
operator|(
name|XEvent
operator|*
operator|)
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|oneboard
condition|)
block|{
name|win2
operator|->
name|flipped
operator|=
name|true
expr_stmt|;
name|win_redraw
argument_list|(
name|win2
argument_list|,
operator|(
name|XEvent
operator|*
operator|)
name|NULL
argument_list|)
expr_stmt|;
block|}
return|return;
block|}
end_function

begin_function
specifier|static
name|void
name|icon_refresh
parameter_list|(
name|win
parameter_list|)
name|windata
modifier|*
name|win
decl_stmt|;
block|{
name|XCopyArea
argument_list|(
name|win
operator|->
name|display
argument_list|,
name|win
operator|->
name|iconpixmap
argument_list|,
name|win
operator|->
name|icon
argument_list|,
name|DefaultGC
argument_list|(
name|win
operator|->
name|display
argument_list|,
literal|0
argument_list|)
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
name|icon_width
argument_list|,
name|icon_height
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*-  * Copyright (c) 1988, 1993  *	The Regents of the University of California.  All rights reserved.  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions  * are met:  * 1. Redistributions of source code must retain the above copyright  *    notice, this list of conditions and the following disclaimer.  * 2. Redistributions in binary form must reproduce the above copyright  *    notice, this list of conditions and the following disclaimer in the  *    documentation and/or other materials provided with the distribution.  * 3. All advertising materials mentioning features or use of this software  *    must display the following acknowledgement:  *	This product includes software developed by the University of  *	California, Berkeley and its contributors.  * 4. Neither the name of the University nor the names of its contributors  *    may be used to endorse or promote products derived from this software  *    without specific prior written permission.  *  * THIS SOFTWARE IS PROVIDED BY THE REGENTS AND CONTRIBUTORS ``AS IS'' AND  * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE  * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE  * ARE DISCLAIMED.  IN NO EVENT SHALL THE REGENTS OR CONTRIBUTORS BE LIABLE  * FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL  * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS  * OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)  * HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT  * LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY  * OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF  * SUCH DAMAGE.  */
end_comment

begin_ifndef
ifndef|#
directive|ifndef
name|lint
end_ifndef

begin_decl_stmt
specifier|static
name|char
name|copyright
index|[]
init|=
literal|"@(#) Copyright (c) 1988, 1993\n\ 	The Regents of the University of California.  All rights reserved.\n"
decl_stmt|;
end_decl_stmt

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* not lint */
end_comment

begin_ifndef
ifndef|#
directive|ifndef
name|lint
end_ifndef

begin_decl_stmt
specifier|static
name|char
name|sccsid
index|[]
init|=
literal|"@(#)tnrecv.c	8.1 (Berkeley) 6/6/93"
decl_stmt|;
end_decl_stmt

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* not lint */
end_comment

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_include
include|#
directive|include
file|<api/apilib.h>
end_include

begin_include
include|#
directive|include
file|"tncomp.h"
end_include

begin_include
include|#
directive|include
file|"../ctlr/api.h"
end_include

begin_include
include|#
directive|include
file|"../ctlr/function.h"
end_include

begin_include
include|#
directive|include
file|"../ctlr/hostctlr.h"
end_include

begin_include
include|#
directive|include
file|"../ctlr/oia.h"
end_include

begin_include
include|#
directive|include
file|"../ctlr/screen.h"
end_include

begin_include
include|#
directive|include
file|"../api/disp_asc.h"
end_include

begin_include
include|#
directive|include
file|"../api/astosc.h"
end_include

begin_include
include|#
directive|include
file|"../general/general.h"
end_include

begin_decl_stmt
name|ScreenImage
name|Host
index|[
name|MAXSCREENSIZE
index|]
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|char
name|a_send_sequence
index|[
name|SEND_SEQUENCE_LENGTH
operator|+
literal|1
index|]
decl_stmt|,
name|a_ack_sequence
index|[
name|ACK_SEQUENCE_LENGTH
operator|+
literal|1
index|]
decl_stmt|,
name|a_checksum
index|[
name|CHECKSUM_LENGTH
operator|+
literal|1
index|]
decl_stmt|,
name|data_array
index|[
name|DATA_LENGTH
operator|+
literal|1
index|]
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|verbose
decl_stmt|,
name|blocks
decl_stmt|,
name|enter_index
decl_stmt|,
name|clear_index
decl_stmt|,
name|ScreenSize
decl_stmt|,
name|session_id
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|unsigned
name|int
name|send_sequence
decl_stmt|,
name|ack_sequence
init|=
operator|-
literal|1
decl_stmt|,
name|checksum
decl_stmt|;
end_decl_stmt

begin_macro
name|api_perror
argument_list|(
argument|string
argument_list|)
end_macro

begin_decl_stmt
name|char
modifier|*
name|string
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Error: [0x%x/0x%x:0x%x/0x%x] from %s.\n"
argument_list|,
name|api_sup_fcn_id
argument_list|,
name|api_sup_errno
argument_list|,
name|api_fcn_fcn_id
argument_list|,
name|api_fcn_errno
argument_list|,
name|string
argument_list|)
expr_stmt|;
block|}
end_block

begin_function
name|char
modifier|*
name|session_type
parameter_list|(
name|type
parameter_list|)
name|int
name|type
decl_stmt|;
block|{
switch|switch
condition|(
name|type
condition|)
block|{
case|case
name|TYPE_WSCTL
case|:
return|return
literal|"work station control"
return|;
case|case
name|TYPE_DFT
case|:
return|return
literal|"distributed function terminal"
return|;
case|case
name|TYPE_CUT
case|:
return|return
literal|"control unit terminal"
return|;
case|case
name|TYPE_NOTEPAD
case|:
return|return
literal|"notepad"
return|;
case|case
name|TYPE_PC
case|:
return|return
literal|"personal computer"
return|;
default|default:
return|return
literal|"(UNKNOWN)"
return|;
block|}
block|}
end_function

begin_function
specifier|static
name|int
name|wait_for_ps_or_oia
parameter_list|()
block|{
if|#
directive|if
name|defined
argument_list|(
name|unix
argument_list|)
return|return
name|api_ps_or_oia_modified
argument_list|()
return|;
endif|#
directive|endif
comment|/* defined(unix) */
block|}
end_function

begin_function
specifier|static
name|int
name|wait_for_unlock
parameter_list|()
block|{
name|OIA
name|oia
decl_stmt|;
name|ReadOiaGroupParms
name|re
decl_stmt|;
specifier|static
name|char
name|zeroes
index|[
sizeof|sizeof
name|oia
operator|.
name|input_inhibited
index|]
init|=
block|{
literal|0
block|}
decl_stmt|;
do|do
block|{
name|re
operator|.
name|rc
operator|=
name|re
operator|.
name|function_id
operator|=
literal|0
expr_stmt|;
name|re
operator|.
name|session_id
operator|=
name|session_id
expr_stmt|;
name|re
operator|.
name|oia_buffer
operator|=
operator|(
name|char
name|far
operator|*
operator|)
operator|&
name|oia
expr_stmt|;
name|re
operator|.
name|oia_group_number
operator|=
name|API_OIA_ALL_GROUPS
expr_stmt|;
if|if
condition|(
name|api_read_oia_group
argument_list|(
operator|&
name|re
argument_list|)
operator|==
operator|-
literal|1
condition|)
block|{
name|api_perror
argument_list|(
literal|"api_read_oia_group"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
elseif|else
if|if
condition|(
name|verbose
condition|)
block|{
if|if
condition|(
name|IsOiaReady3274
argument_list|(
operator|&
name|oia
argument_list|)
condition|)
block|{
name|printf
argument_list|(
literal|"3274 ready, "
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|IsOiaMyJob
argument_list|(
operator|&
name|oia
argument_list|)
condition|)
block|{
name|printf
argument_list|(
literal|"my job, "
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|IsOiaInsert
argument_list|(
operator|&
name|oia
argument_list|)
condition|)
block|{
name|printf
argument_list|(
literal|"insert mode, "
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|IsOiaSystemLocked
argument_list|(
operator|&
name|oia
argument_list|)
condition|)
block|{
name|printf
argument_list|(
literal|"system locked, "
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|IsOiaTWait
argument_list|(
operator|&
name|oia
argument_list|)
condition|)
block|{
name|printf
argument_list|(
literal|"terminal wait, "
argument_list|)
expr_stmt|;
block|}
name|printf
argument_list|(
literal|"are some bits from the OIA.\n"
argument_list|)
expr_stmt|;
block|}
comment|/* We turned this on, so turn it off now */
name|ResetOiaApiInhibit
argument_list|(
operator|&
name|oia
argument_list|)
expr_stmt|;
if|if
condition|(
name|memcmp
argument_list|(
name|zeroes
argument_list|,
name|oia
operator|.
name|input_inhibited
argument_list|,
sizeof|sizeof
name|oia
operator|.
name|input_inhibited
argument_list|)
condition|)
block|{
if|if
condition|(
name|wait_for_ps_or_oia
argument_list|()
operator|==
operator|-
literal|1
condition|)
block|{
return|return
operator|-
literal|1
return|;
block|}
block|}
block|}
do|while
condition|(
name|memcmp
argument_list|(
name|zeroes
argument_list|,
name|oia
operator|.
name|input_inhibited
argument_list|,
sizeof|sizeof
name|oia
operator|.
name|input_inhibited
argument_list|)
condition|)
do|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|initialize
parameter_list|()
block|{
name|QuerySessionIdParms
name|id
decl_stmt|;
name|QuerySessionParametersParms
name|pa
decl_stmt|;
name|QuerySessionCursorParms
name|cu
decl_stmt|;
name|ConnectToKeyboardParms
name|conn
decl_stmt|;
name|DisableInputParms
name|disable
decl_stmt|;
name|NameArray
name|namearray
decl_stmt|;
if|if
condition|(
name|api_init
argument_list|()
operator|==
literal|0
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"API function not available.\n"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|id
operator|.
name|rc
operator|=
literal|0
expr_stmt|;
name|id
operator|.
name|function_id
operator|=
literal|0
expr_stmt|;
name|id
operator|.
name|option_code
operator|=
name|ID_OPTION_BY_NAME
expr_stmt|;
name|id
operator|.
name|data_code
operator|=
literal|'E'
expr_stmt|;
name|id
operator|.
name|name_array
operator|=
operator|&
name|namearray
expr_stmt|;
name|namearray
operator|.
name|length
operator|=
sizeof|sizeof
name|namearray
expr_stmt|;
if|if
condition|(
name|api_query_session_id
argument_list|(
operator|&
name|id
argument_list|)
condition|)
block|{
name|api_perror
argument_list|(
literal|"api_query_session_id"
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|namearray
operator|.
name|number_matching_session
operator|==
literal|0
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"query_session_id:  No matching sessions!\n"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
elseif|else
if|if
condition|(
name|verbose
condition|)
block|{
name|printf
argument_list|(
literal|"Session short name 0x%x, type is "
argument_list|,
name|namearray
operator|.
name|name_array_element
operator|.
name|short_name
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"%s"
argument_list|,
name|session_type
argument_list|(
name|namearray
operator|.
name|name_array_element
operator|.
name|type
argument_list|)
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|", session ID is: 0x%x\n"
argument_list|,
name|namearray
operator|.
name|name_array_element
operator|.
name|session_id
argument_list|)
expr_stmt|;
block|}
name|session_id
operator|=
name|namearray
operator|.
name|name_array_element
operator|.
name|session_id
expr_stmt|;
name|pa
operator|.
name|rc
operator|=
name|pa
operator|.
name|function_id
operator|=
literal|0
expr_stmt|;
name|pa
operator|.
name|session_id
operator|=
name|session_id
expr_stmt|;
if|if
condition|(
name|api_query_session_parameters
argument_list|(
operator|&
name|pa
argument_list|)
operator|==
operator|-
literal|1
condition|)
block|{
name|api_perror
argument_list|(
literal|"api_query_session_parameters"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
elseif|else
if|if
condition|(
name|verbose
condition|)
block|{
name|printf
argument_list|(
literal|"Session type %s, "
argument_list|,
name|session_type
argument_list|(
name|pa
operator|.
name|session_type
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|pa
operator|.
name|session_characteristics
operator|&
name|CHARACTERISTIC_EAB
condition|)
block|{
name|printf
argument_list|(
literal|" has EAB, "
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|pa
operator|.
name|session_characteristics
operator|&
name|CHARACTERISTIC_PSS
condition|)
block|{
name|printf
argument_list|(
literal|" has PSS, "
argument_list|)
expr_stmt|;
block|}
name|printf
argument_list|(
literal|"%d rows, %d columns "
argument_list|,
name|pa
operator|.
name|rows
argument_list|,
name|pa
operator|.
name|columns
argument_list|)
expr_stmt|;
if|if
condition|(
name|pa
operator|.
name|presentation_space
condition|)
block|{
name|printf
argument_list|(
literal|"presentation space at 0x%x:0x%x.\n"
argument_list|,
name|FP_SEG
argument_list|(
name|pa
operator|.
name|presentation_space
argument_list|)
argument_list|,
name|FP_OFF
argument_list|(
name|pa
operator|.
name|presentation_space
argument_list|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|printf
argument_list|(
literal|"(no direct presentation space access).\n"
argument_list|)
expr_stmt|;
block|}
block|}
name|ScreenSize
operator|=
name|pa
operator|.
name|rows
operator|*
name|pa
operator|.
name|columns
expr_stmt|;
if|if
condition|(
name|pa
operator|.
name|session_characteristics
operator|&
name|CHARACTERISTIC_EAB
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"tncomp utilities not designed to work with extended attribute buffers.\n"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
if|if
condition|(
name|verbose
condition|)
block|{
name|cu
operator|.
name|rc
operator|=
name|cu
operator|.
name|function_id
operator|=
literal|0
expr_stmt|;
name|cu
operator|.
name|session_id
operator|=
name|session_id
expr_stmt|;
if|if
condition|(
name|api_query_session_cursor
argument_list|(
operator|&
name|cu
argument_list|)
operator|==
operator|-
literal|1
condition|)
block|{
name|api_perror
argument_list|(
literal|"api_query_session_cursor"
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|printf
argument_list|(
literal|"cursor"
argument_list|)
expr_stmt|;
if|if
condition|(
name|cu
operator|.
name|cursor_type
operator|&
name|CURSOR_INHIBITED_AUTOSCROLL
condition|)
block|{
name|printf
argument_list|(
literal|" inhibited autoscroll"
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|cu
operator|.
name|cursor_type
operator|&
name|CURSOR_INHIBITED
condition|)
block|{
name|printf
argument_list|(
literal|" inhibited"
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|cu
operator|.
name|cursor_type
operator|&
name|CURSOR_BLINKING
condition|)
block|{
name|printf
argument_list|(
literal|" blinking"
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|printf
argument_list|(
literal|" not blinking"
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|cu
operator|.
name|cursor_type
operator|&
name|CURSOR_BOX
condition|)
block|{
name|printf
argument_list|(
literal|" box "
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|printf
argument_list|(
literal|" not box "
argument_list|)
expr_stmt|;
block|}
name|printf
argument_list|(
literal|"at row %d, column %d.\n"
argument_list|,
name|cu
operator|.
name|row_address
argument_list|,
name|cu
operator|.
name|column_address
argument_list|)
expr_stmt|;
block|}
block|}
name|conn
operator|.
name|rc
operator|=
name|conn
operator|.
name|function_id
operator|=
literal|0
expr_stmt|;
name|conn
operator|.
name|session_id
operator|=
name|session_id
expr_stmt|;
name|conn
operator|.
name|event_queue_id
operator|=
name|conn
operator|.
name|input_queue_id
operator|=
literal|0
expr_stmt|;
name|conn
operator|.
name|intercept_options
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|api_connect_to_keyboard
argument_list|(
operator|&
name|conn
argument_list|)
operator|==
operator|-
literal|1
condition|)
block|{
name|api_perror
argument_list|(
literal|"api_connect_to_keyboard"
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|verbose
condition|)
block|{
if|if
condition|(
name|conn
operator|.
name|first_connection_identifier
condition|)
block|{
name|printf
argument_list|(
literal|"First keyboard connection.\n"
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|printf
argument_list|(
literal|"Not first keyboard connection.\n"
argument_list|)
expr_stmt|;
block|}
block|}
name|disable
operator|.
name|rc
operator|=
name|disable
operator|.
name|function_id
operator|=
literal|0
expr_stmt|;
name|disable
operator|.
name|session_id
operator|=
name|session_id
expr_stmt|;
name|disable
operator|.
name|connectors_task_id
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|api_disable_input
argument_list|(
operator|&
name|disable
argument_list|)
operator|==
operator|-
literal|1
condition|)
block|{
name|api_perror
argument_list|(
literal|"api_disable_input"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
elseif|else
if|if
condition|(
name|verbose
condition|)
block|{
name|printf
argument_list|(
literal|"Disabled.\n"
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|enter_index
operator|=
name|ascii_to_index
argument_list|(
literal|"ENTER"
argument_list|)
operator|)
operator|==
operator|-
literal|1
condition|)
block|{
return|return
operator|-
literal|1
return|;
block|}
if|if
condition|(
operator|(
name|clear_index
operator|=
name|ascii_to_index
argument_list|(
literal|"CLEAR"
argument_list|)
operator|)
operator|==
operator|-
literal|1
condition|)
block|{
return|return
operator|-
literal|1
return|;
block|}
return|return
literal|0
return|;
comment|/* all ok */
block|}
end_function

begin_function
specifier|static
name|int
name|send_key
parameter_list|(
name|index
parameter_list|)
name|int
name|index
decl_stmt|;
block|{
name|WriteKeystrokeParms
name|wr
decl_stmt|;
specifier|extern
name|struct
name|astosc
name|astosc
index|[]
decl_stmt|;
name|wait_for_unlock
argument_list|()
expr_stmt|;
name|wr
operator|.
name|rc
operator|=
name|wr
operator|.
name|function_id
operator|=
literal|0
expr_stmt|;
name|wr
operator|.
name|session_id
operator|=
name|session_id
expr_stmt|;
name|wr
operator|.
name|connectors_task_id
operator|=
literal|0
expr_stmt|;
name|wr
operator|.
name|options
operator|=
name|OPTION_SINGLE_KEYSTROKE
expr_stmt|;
name|wr
operator|.
name|number_of_keys_sent
operator|=
literal|0
expr_stmt|;
name|wr
operator|.
name|keystroke_specifier
operator|.
name|keystroke_entry
operator|.
name|scancode
operator|=
name|astosc
index|[
name|index
index|]
operator|.
name|scancode
expr_stmt|;
name|wr
operator|.
name|keystroke_specifier
operator|.
name|keystroke_entry
operator|.
name|shift_state
operator|=
name|astosc
index|[
name|index
index|]
operator|.
name|shiftstate
expr_stmt|;
if|if
condition|(
name|api_write_keystroke
argument_list|(
operator|&
name|wr
argument_list|)
operator|==
operator|-
literal|1
condition|)
block|{
name|api_perror
argument_list|(
literal|"api_write_keystroke"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
elseif|else
if|if
condition|(
name|wr
operator|.
name|number_of_keys_sent
operator|!=
literal|1
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"write_keystroke claims to have sent %d keystrokes.\n"
argument_list|,
name|wr
operator|.
name|number_of_keys_sent
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
elseif|else
if|if
condition|(
name|verbose
condition|)
block|{
name|printf
argument_list|(
literal|"Keystroke sent.\n"
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|wait_for_ps_or_oia
argument_list|()
operator|==
operator|-
literal|1
condition|)
block|{
return|return
operator|-
literal|1
return|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|terminate
parameter_list|()
block|{
name|EnableInputParms
name|enable
decl_stmt|;
name|DisconnectFromKeyboardParms
name|disc
decl_stmt|;
name|enable
operator|.
name|rc
operator|=
name|enable
operator|.
name|function_id
operator|=
literal|0
expr_stmt|;
name|enable
operator|.
name|session_id
operator|=
name|session_id
expr_stmt|;
name|enable
operator|.
name|connectors_task_id
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|api_enable_input
argument_list|(
operator|&
name|enable
argument_list|)
operator|==
operator|-
literal|1
condition|)
block|{
name|api_perror
argument_list|(
literal|"api_enable"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
elseif|else
if|if
condition|(
name|verbose
condition|)
block|{
name|printf
argument_list|(
literal|"Enabled.\n"
argument_list|)
expr_stmt|;
block|}
name|disc
operator|.
name|rc
operator|=
name|disc
operator|.
name|function_id
operator|=
literal|0
expr_stmt|;
name|disc
operator|.
name|session_id
operator|=
name|session_id
expr_stmt|;
name|disc
operator|.
name|connectors_task_id
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|api_disconnect_from_keyboard
argument_list|(
operator|&
name|disc
argument_list|)
operator|==
operator|-
literal|1
condition|)
block|{
name|api_perror
argument_list|(
literal|"api_disconnect_from_keyboard"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
elseif|else
if|if
condition|(
name|verbose
condition|)
block|{
name|printf
argument_list|(
literal|"Disconnected from keyboard.\n"
argument_list|)
expr_stmt|;
block|}
operator|(
name|void
operator|)
name|api_finish
argument_list|()
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|get_screen
parameter_list|()
block|{
name|CopyStringParms
name|copy
decl_stmt|;
comment|/* Time copy services */
name|wait_for_unlock
argument_list|()
expr_stmt|;
name|copy
operator|.
name|copy_mode
operator|=
literal|0
expr_stmt|;
name|copy
operator|.
name|rc
operator|=
name|copy
operator|.
name|function_id
operator|=
literal|0
expr_stmt|;
name|copy
operator|.
name|source
operator|.
name|session_id
operator|=
name|session_id
expr_stmt|;
name|copy
operator|.
name|source
operator|.
name|buffer
operator|=
literal|0
expr_stmt|;
name|copy
operator|.
name|source
operator|.
name|characteristics
operator|=
literal|0
expr_stmt|;
name|copy
operator|.
name|source
operator|.
name|session_type
operator|=
name|TYPE_DFT
expr_stmt|;
name|copy
operator|.
name|source
operator|.
name|begin
operator|=
literal|0
expr_stmt|;
name|copy
operator|.
name|source_end
operator|=
name|ScreenSize
expr_stmt|;
name|copy
operator|.
name|target
operator|.
name|session_id
operator|=
literal|0
expr_stmt|;
name|copy
operator|.
name|target
operator|.
name|buffer
operator|=
operator|(
name|char
operator|*
operator|)
operator|&
name|Host
index|[
literal|0
index|]
expr_stmt|;
name|copy
operator|.
name|target
operator|.
name|characteristics
operator|=
literal|0
expr_stmt|;
name|copy
operator|.
name|target
operator|.
name|session_type
operator|=
name|TYPE_DFT
expr_stmt|;
if|if
condition|(
name|api_copy_string
argument_list|(
operator|&
name|copy
argument_list|)
operator|==
operator|-
literal|1
condition|)
block|{
name|api_perror
argument_list|(
literal|"api_copy_string"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_macro
name|put_at
argument_list|(
argument|offset
argument_list|,
argument|from
argument_list|,
argument|length
argument_list|,
argument|attribute
argument_list|)
end_macro

begin_decl_stmt
name|int
name|offset
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|char
modifier|*
name|from
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|length
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|CopyStringParms
name|copy
decl_stmt|;
name|wait_for_unlock
argument_list|()
expr_stmt|;
name|copy
operator|.
name|copy_mode
operator|=
literal|0
expr_stmt|;
name|copy
operator|.
name|rc
operator|=
name|copy
operator|.
name|function_id
operator|=
literal|0
expr_stmt|;
name|copy
operator|.
name|source
operator|.
name|session_id
operator|=
literal|0
expr_stmt|;
name|copy
operator|.
name|source
operator|.
name|buffer
operator|=
name|from
expr_stmt|;
name|copy
operator|.
name|source
operator|.
name|characteristics
operator|=
literal|0
expr_stmt|;
name|copy
operator|.
name|source
operator|.
name|session_type
operator|=
name|TYPE_DFT
expr_stmt|;
name|copy
operator|.
name|source
operator|.
name|begin
operator|=
literal|0
expr_stmt|;
name|copy
operator|.
name|source_end
operator|=
name|length
operator|-
literal|1
expr_stmt|;
name|copy
operator|.
name|target
operator|.
name|session_id
operator|=
name|session_id
expr_stmt|;
name|copy
operator|.
name|target
operator|.
name|buffer
operator|=
literal|0
expr_stmt|;
name|copy
operator|.
name|target
operator|.
name|characteristics
operator|=
literal|0
expr_stmt|;
name|copy
operator|.
name|target
operator|.
name|session_type
operator|=
name|TYPE_DFT
expr_stmt|;
name|copy
operator|.
name|target
operator|.
name|begin
operator|=
name|offset
expr_stmt|;
if|if
condition|(
name|api_copy_string
argument_list|(
operator|&
name|copy
argument_list|)
operator|==
operator|-
literal|1
condition|)
block|{
name|api_perror
argument_list|(
literal|"api_copy_string"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
return|return
literal|0
return|;
block|}
end_block

begin_decl_stmt
specifier|static
name|void
name|translate
argument_list|(
name|input
argument_list|,
name|output
argument_list|,
name|table
argument_list|,
name|length
argument_list|)
name|char
modifier|*
name|input
decl_stmt|,
modifier|*
name|output
decl_stmt|,
name|table
index|[]
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|length
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|unsigned
name|char
modifier|*
name|indices
init|=
operator|(
name|unsigned
name|char
operator|*
operator|)
name|input
decl_stmt|;
while|while
condition|(
name|length
operator|--
condition|)
block|{
operator|*
name|output
operator|++
operator|=
name|table
index|[
operator|*
name|indices
operator|++
index|]
expr_stmt|;
block|}
block|}
end_block

begin_function
specifier|static
name|int
name|find_input_area
parameter_list|(
name|from
parameter_list|)
name|int
name|from
decl_stmt|;
block|{
define|#
directive|define
name|FieldDec
parameter_list|(
name|p
parameter_list|)
value|(0)
comment|/* We don't really use this */
specifier|register
name|int
name|i
decl_stmt|,
name|attr
decl_stmt|;
for|for
control|(
name|i
operator|=
name|from
init|;
name|i
operator|<
name|MAXSCREENSIZE
condition|;
control|)
block|{
if|if
condition|(
name|IsStartField
argument_list|(
name|i
argument_list|)
condition|)
block|{
name|attr
operator|=
name|FieldAttributes
argument_list|(
name|i
argument_list|)
expr_stmt|;
name|i
operator|++
expr_stmt|;
if|if
condition|(
operator|!
name|IsProtectedAttr
argument_list|(
name|i
argument_list|,
name|attr
argument_list|)
condition|)
block|{
return|return
name|i
return|;
block|}
block|}
else|else
block|{
name|i
operator|++
expr_stmt|;
block|}
block|}
return|return
operator|-
literal|1
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|getascii
parameter_list|(
name|offset
parameter_list|,
name|to
parameter_list|,
name|length
parameter_list|)
name|int
name|offset
decl_stmt|;
comment|/* Where in screen */
name|char
modifier|*
name|to
decl_stmt|;
comment|/* Where it goes to */
name|int
name|length
decl_stmt|;
comment|/* Where to put it */
block|{
name|translate
argument_list|(
name|Host
operator|+
name|offset
argument_list|,
name|to
argument_list|,
name|disp_asc
argument_list|,
name|length
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|putascii
parameter_list|(
name|offset
parameter_list|,
name|from
parameter_list|,
name|length
parameter_list|,
name|before
parameter_list|)
name|int
name|offset
decl_stmt|;
comment|/* Where in screen */
name|char
modifier|*
name|from
decl_stmt|;
comment|/* Where it comes from */
name|int
name|length
decl_stmt|;
comment|/* Where to put it */
name|int
name|before
decl_stmt|;
comment|/* How much else should go */
block|{
name|translate
argument_list|(
name|from
argument_list|,
name|Host
operator|+
name|offset
argument_list|,
name|asc_disp
argument_list|,
name|length
argument_list|)
expr_stmt|;
if|if
condition|(
name|put_at
argument_list|(
name|offset
operator|-
name|before
argument_list|,
operator|(
name|char
operator|*
operator|)
name|Host
operator|+
name|offset
operator|-
name|before
argument_list|,
name|length
operator|+
name|before
argument_list|)
operator|==
operator|-
literal|1
condition|)
block|{
return|return
operator|-
literal|1
return|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|ack
parameter_list|()
block|{
specifier|static
name|char
name|ack_blanks
index|[
sizeof|sizeof
name|a_ack_sequence
index|]
init|=
block|{
literal|0
block|}
decl_stmt|;
if|if
condition|(
name|ack_blanks
index|[
literal|0
index|]
operator|==
literal|0
condition|)
block|{
name|int
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
sizeof|sizeof
name|ack_blanks
condition|;
name|i
operator|++
control|)
block|{
name|ack_blanks
index|[
name|i
index|]
operator|=
literal|' '
expr_stmt|;
block|}
block|}
name|memcpy
argument_list|(
name|a_ack_sequence
argument_list|,
name|ack_blanks
argument_list|,
sizeof|sizeof
name|a_ack_sequence
argument_list|)
expr_stmt|;
name|sprintf
argument_list|(
name|a_ack_sequence
argument_list|,
literal|"%d"
argument_list|,
name|ack_sequence
argument_list|)
expr_stmt|;
name|a_ack_sequence
index|[
name|strlen
argument_list|(
name|a_ack_sequence
argument_list|)
index|]
operator|=
literal|' '
expr_stmt|;
if|if
condition|(
name|putascii
argument_list|(
name|ACK_SEQUENCE
argument_list|,
name|a_ack_sequence
argument_list|,
name|ACK_SEQUENCE_LENGTH
argument_list|,
literal|0
argument_list|)
operator|==
operator|-
literal|1
condition|)
block|{
return|return
operator|-
literal|1
return|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|formatted_correct
parameter_list|()
block|{
if|if
condition|(
operator|(
name|find_input_area
argument_list|(
name|SEND_SEQUENCE
operator|-
literal|1
argument_list|)
operator|!=
name|SEND_SEQUENCE
operator|)
operator|||
operator|(
name|find_input_area
argument_list|(
name|SEND_SEQUENCE
argument_list|)
operator|!=
name|ACK_SEQUENCE
operator|)
operator|||
operator|(
name|find_input_area
argument_list|(
name|ACK_SEQUENCE
argument_list|)
operator|!=
name|CHECKSUM
operator|)
operator|||
operator|(
name|find_input_area
argument_list|(
name|CHECKSUM
argument_list|)
operator|!=
name|DATA
operator|)
condition|)
block|{
return|return
operator|-
literal|1
return|;
block|}
else|else
block|{
return|return
literal|0
return|;
block|}
block|}
end_function

begin_function
name|main
parameter_list|(
name|argc
parameter_list|,
name|argv
parameter_list|)
name|int
name|argc
decl_stmt|;
name|char
modifier|*
name|argv
index|[]
decl_stmt|;
block|{
specifier|register
name|int
name|i
decl_stmt|;
name|int
name|data_length
decl_stmt|,
name|input_length
decl_stmt|;
name|char
name|ascii
index|[
literal|8
index|]
decl_stmt|;
comment|/* Lots of room */
name|FILE
modifier|*
name|outfile
decl_stmt|;
name|char
modifier|*
name|data
decl_stmt|;
name|char
modifier|*
name|argv0
init|=
name|argv
index|[
literal|0
index|]
decl_stmt|;
name|argc
operator|--
expr_stmt|;
name|argv
operator|++
expr_stmt|;
comment|/* Process any flags */
while|while
condition|(
name|argc
operator|&&
operator|(
name|argv
index|[
literal|0
index|]
index|[
literal|0
index|]
operator|==
literal|'-'
operator|)
condition|)
block|{
switch|switch
condition|(
name|argv
index|[
literal|0
index|]
index|[
literal|1
index|]
condition|)
block|{
case|case
literal|'v'
case|:
name|verbose
operator|=
literal|1
expr_stmt|;
break|break;
case|case
literal|'b'
case|:
name|blocks
operator|=
literal|1
expr_stmt|;
break|break;
block|}
name|argc
operator|--
expr_stmt|;
name|argv
operator|++
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|argc
operator|)
operator|<
literal|2
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"usage: %s [-b] [-v] local.file remote.file [remote.options]\n"
argument_list|,
name|argv0
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
comment|/* Open the local file */
if|if
condition|(
operator|(
name|outfile
operator|=
name|fopen
argument_list|(
name|argv
index|[
literal|0
index|]
argument_list|,
literal|"w"
argument_list|)
operator|)
operator|==
name|NULL
condition|)
block|{
name|perror
argument_list|(
literal|"fopen"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|2
argument_list|)
expr_stmt|;
block|}
name|argc
operator|--
expr_stmt|;
name|argv
operator|++
expr_stmt|;
if|if
condition|(
name|initialize
argument_list|()
operator|==
operator|-
literal|1
condition|)
block|{
return|return
operator|-
literal|1
return|;
block|}
comment|/* build the command line */
name|data
operator|=
name|data_array
expr_stmt|;
name|strcpy
argument_list|(
name|data
argument_list|,
literal|"TNCOMP SEND"
argument_list|)
expr_stmt|;
name|data
operator|+=
name|strlen
argument_list|(
name|data
argument_list|)
expr_stmt|;
while|while
condition|(
name|argc
operator|--
condition|)
block|{
operator|*
name|data
operator|++
operator|=
literal|' '
expr_stmt|;
name|strcpy
argument_list|(
name|data
argument_list|,
name|argv
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
name|data
operator|+=
name|strlen
argument_list|(
name|argv
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
name|argv
operator|++
expr_stmt|;
block|}
if|if
condition|(
name|verbose
condition|)
block|{
name|printf
argument_list|(
literal|"%s\n"
argument_list|,
name|data_array
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|get_screen
argument_list|()
operator|==
operator|-
literal|1
condition|)
block|{
return|return
operator|-
literal|1
return|;
block|}
name|data_length
operator|=
name|strlen
argument_list|(
name|data_array
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|i
operator|=
name|find_input_area
argument_list|(
literal|0
argument_list|)
operator|)
operator|==
operator|-
literal|1
condition|)
block|{
comment|/* Get an input area */
if|if
condition|(
name|send_key
argument_list|(
name|clear_index
argument_list|)
operator|==
operator|-
literal|1
condition|)
block|{
return|return
operator|-
literal|1
return|;
block|}
if|if
condition|(
operator|(
name|i
operator|=
name|find_input_area
argument_list|(
literal|0
argument_list|)
operator|)
operator|==
operator|-
literal|1
condition|)
block|{
comment|/* Try again */
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Unable to enter command line.\n"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
block|}
if|if
condition|(
name|putascii
argument_list|(
name|i
argument_list|,
name|data_array
argument_list|,
name|data_length
argument_list|,
literal|0
argument_list|)
operator|==
operator|-
literal|1
condition|)
block|{
return|return
operator|-
literal|1
return|;
block|}
if|if
condition|(
name|send_key
argument_list|(
name|enter_index
argument_list|)
operator|==
operator|-
literal|1
condition|)
block|{
return|return
operator|-
literal|1
return|;
block|}
do|do
block|{
if|if
condition|(
name|get_screen
argument_list|()
operator|==
operator|-
literal|1
condition|)
block|{
return|return
operator|-
literal|1
return|;
block|}
block|}
do|while
condition|(
name|formatted_correct
argument_list|()
operator|==
operator|-
literal|1
condition|)
do|;
do|do
block|{
if|if
condition|(
name|get_screen
argument_list|()
operator|==
operator|-
literal|1
condition|)
block|{
return|return
operator|-
literal|1
return|;
block|}
comment|/* For each screen */
if|if
condition|(
name|formatted_correct
argument_list|()
operator|==
operator|-
literal|1
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Bad screen written by host.\n"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
comment|/* If MDT isn't reset in the sequence number, go around again */
if|if
condition|(
name|Host
index|[
name|ACK_SEQUENCE
operator|-
literal|1
index|]
operator|&
name|ATTR_MDT
condition|)
block|{
if|if
condition|(
name|wait_for_ps_or_oia
argument_list|()
operator|==
operator|-
literal|1
condition|)
block|{
return|return
operator|-
literal|1
return|;
block|}
continue|continue;
block|}
name|getascii
argument_list|(
name|SEND_SEQUENCE
argument_list|,
name|a_send_sequence
argument_list|,
name|SEND_SEQUENCE_LENGTH
argument_list|)
expr_stmt|;
name|send_sequence
operator|=
name|atoi
argument_list|(
name|a_send_sequence
argument_list|)
expr_stmt|;
name|getascii
argument_list|(
name|CHECKSUM
argument_list|,
name|a_checksum
argument_list|,
name|CHECKSUM_LENGTH
argument_list|)
expr_stmt|;
name|checksum
operator|=
name|atoi
argument_list|(
name|a_checksum
argument_list|)
expr_stmt|;
name|getascii
argument_list|(
name|DATA
argument_list|,
name|data_array
argument_list|,
name|DATA_LENGTH
argument_list|)
expr_stmt|;
name|data
operator|=
name|data_array
expr_stmt|;
if|if
condition|(
name|send_sequence
operator|!=
operator|(
name|ack_sequence
operator|+
literal|1
operator|)
condition|)
block|{
if|if
condition|(
name|ack
argument_list|()
operator|==
operator|-
literal|1
condition|)
block|{
return|return
operator|-
literal|1
return|;
block|}
name|data
operator|=
literal|"1234"
expr_stmt|;
comment|/* Keep loop from failing */
if|if
condition|(
name|send_key
argument_list|(
name|enter_index
argument_list|)
operator|==
operator|-
literal|1
condition|)
block|{
return|return
operator|-
literal|1
return|;
block|}
if|if
condition|(
name|get_screen
argument_list|()
operator|==
operator|-
literal|1
condition|)
block|{
return|return
operator|-
literal|1
return|;
block|}
continue|continue;
block|}
name|data_length
operator|=
name|DATA_LENGTH
expr_stmt|;
while|while
condition|(
name|data_length
operator|&&
name|memcmp
argument_list|(
name|data
argument_list|,
literal|" EOF"
argument_list|,
literal|4
argument_list|)
operator|&&
name|memcmp
argument_list|(
name|data
argument_list|,
literal|"    "
argument_list|,
literal|4
argument_list|)
condition|)
block|{
name|memcpy
argument_list|(
name|ascii
argument_list|,
name|data
argument_list|,
literal|4
argument_list|)
expr_stmt|;
name|data
operator|+=
literal|4
expr_stmt|;
name|data_length
operator|-=
literal|4
expr_stmt|;
name|ascii
index|[
literal|4
index|]
operator|=
literal|0
expr_stmt|;
name|input_length
operator|=
name|atoi
argument_list|(
name|ascii
argument_list|)
expr_stmt|;
comment|/* CMS can't live with zero length records */
if|if
condition|(
operator|(
name|input_length
operator|>
literal|1
operator|)
operator|||
operator|(
operator|(
name|input_length
operator|==
literal|1
operator|)
operator|&&
operator|(
name|data
index|[
literal|0
index|]
operator|!=
literal|' '
operator|)
operator|)
condition|)
block|{
if|if
condition|(
name|fwrite
argument_list|(
name|data
argument_list|,
sizeof|sizeof
argument_list|(
name|char
argument_list|)
argument_list|,
name|input_length
argument_list|,
name|outfile
argument_list|)
operator|==
literal|0
condition|)
block|{
name|perror
argument_list|(
literal|"fwrite"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|9
argument_list|)
expr_stmt|;
block|}
block|}
name|fprintf
argument_list|(
name|outfile
argument_list|,
literal|"\n"
argument_list|)
expr_stmt|;
name|data
operator|+=
name|input_length
expr_stmt|;
name|data_length
operator|-=
name|input_length
expr_stmt|;
block|}
name|ack_sequence
operator|=
name|send_sequence
expr_stmt|;
if|if
condition|(
name|blocks
condition|)
block|{
name|printf
argument_list|(
literal|"#"
argument_list|)
expr_stmt|;
name|fflush
argument_list|(
name|stdout
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|ack
argument_list|()
operator|==
operator|-
literal|1
condition|)
block|{
return|return
operator|-
literal|1
return|;
block|}
if|if
condition|(
name|send_key
argument_list|(
name|enter_index
argument_list|)
operator|==
operator|-
literal|1
condition|)
block|{
return|return
operator|-
literal|1
return|;
block|}
block|}
do|while
condition|(
name|memcmp
argument_list|(
name|data
argument_list|,
literal|" EOF"
argument_list|,
literal|4
argument_list|)
condition|)
do|;
if|if
condition|(
name|blocks
condition|)
block|{
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|terminate
argument_list|()
operator|==
operator|-
literal|1
condition|)
block|{
return|return
operator|-
literal|1
return|;
block|}
return|return
literal|0
return|;
block|}
end_function

end_unit


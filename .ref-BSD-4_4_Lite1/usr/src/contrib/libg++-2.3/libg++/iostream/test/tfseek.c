begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  anyhow, i was elated when my small test worked! but then was dismayed when my x11 stuff still failed [this is after a make clean and remake total]. after a little digging i found it was still an fseek problem, but with a twist. too bad the testing wasn't up to snuff... here is a test which shows the problem. the #if 0 section was put in so i could upload the same random byte file from linux, just in case... it worked on the sun in either case. here are the results  sunos: seeking to 10 (9 bytes)... seeking to 1125 (1114 bytes)... seeking to 2999 (1873 bytes)...  linux: initializing... writing 3000 bytes as test to FOO seeking to 10 (9 bytes)... seeking to 1125 (1114 bytes)... ftell returned 101, not 1125 seeking to 2999 (1873 bytes)... ftell returned 951, not 2999 wrong byte at 2999 [140 vs 228]  ahh... the joys of debugging :-) zorst [reply to obz@sisd.kodak.com]  --cut here-- */
end_comment

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_include
include|#
directive|include
file|<stdlib.h>
end_include

begin_include
include|#
directive|include
file|<unistd.h>
end_include

begin_function
name|main
parameter_list|(
name|argc
parameter_list|,
name|argv
parameter_list|)
name|int
name|argc
decl_stmt|;
name|char
modifier|*
modifier|*
name|argv
decl_stmt|;
block|{
name|int
name|seek_kind
init|=
name|SEEK_CUR
decl_stmt|;
name|int
name|use_stdout
init|=
literal|1
decl_stmt|;
name|FILE
modifier|*
name|fp
decl_stmt|;
name|char
name|buf
index|[
literal|3000
index|]
decl_stmt|;
name|int
name|i
decl_stmt|,
name|j
decl_stmt|,
name|k
decl_stmt|;
specifier|static
name|int
name|seektbl
index|[]
init|=
block|{
literal|0
block|,
literal|10
block|,
literal|1125
block|,
literal|2999
block|}
decl_stmt|;
name|int
name|nseektbl
init|=
sizeof|sizeof
argument_list|(
name|seektbl
argument_list|)
operator|/
sizeof|sizeof
argument_list|(
name|seektbl
index|[
literal|0
index|]
argument_list|)
decl_stmt|;
while|while
condition|(
operator|*
operator|++
name|argv
condition|)
block|{
if|if
condition|(
name|strcmp
argument_list|(
operator|*
name|argv
argument_list|,
literal|"SEEK_SET"
argument_list|)
operator|==
literal|0
condition|)
name|seek_kind
operator|=
name|SEEK_SET
expr_stmt|;
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
operator|*
name|argv
argument_list|,
literal|"SEEK_CUR"
argument_list|)
operator|==
literal|0
condition|)
name|seek_kind
operator|=
name|SEEK_CUR
expr_stmt|;
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
operator|*
name|argv
argument_list|,
literal|"fopen"
argument_list|)
operator|==
literal|0
condition|)
name|use_stdout
operator|=
literal|0
expr_stmt|;
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
operator|*
name|argv
argument_list|,
literal|"freopen"
argument_list|)
operator|==
literal|0
condition|)
name|use_stdout
operator|=
literal|1
expr_stmt|;
else|else
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Unknown option %s\n"
argument_list|,
operator|*
name|argv
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
block|}
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Using seek_kind: %d\n"
argument_list|,
name|seek_kind
argument_list|)
expr_stmt|;
if|if
condition|(
name|use_stdout
condition|)
name|fp
operator|=
name|stdout
expr_stmt|;
if|#
directive|if
literal|1
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"initializing...\n"
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
condition|;
operator|++
name|i
control|)
name|buf
index|[
name|i
index|]
operator|=
name|i
operator|&
literal|0xfe
expr_stmt|;
comment|/* avoid -1 */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
condition|;
operator|++
name|i
control|)
block|{
name|j
operator|=
name|rand
argument_list|()
operator|%
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
expr_stmt|;
name|k
operator|=
name|buf
index|[
name|i
index|]
expr_stmt|;
name|buf
index|[
name|i
index|]
operator|=
name|buf
index|[
name|j
index|]
expr_stmt|;
name|buf
index|[
name|j
index|]
operator|=
name|k
expr_stmt|;
block|}
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"writing %d bytes as test to FOO\n"
argument_list|,
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|use_stdout
condition|)
name|fp
operator|=
name|freopen
argument_list|(
literal|"FOO"
argument_list|,
literal|"w"
argument_list|,
name|stdout
argument_list|)
expr_stmt|;
else|else
name|fp
operator|=
name|fopen
argument_list|(
literal|"FOO"
argument_list|,
literal|"w"
argument_list|)
expr_stmt|;
if|if
condition|(
name|fp
operator|==
name|NULL
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"can't open FOO for writing\n"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
if|if
condition|(
name|fwrite
argument_list|(
name|buf
argument_list|,
literal|1
argument_list|,
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
argument_list|,
name|fp
argument_list|)
operator|!=
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"failed to write\n"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
else|#
directive|else
if|if
condition|(
name|use_stdout
condition|)
name|fp
operator|=
name|freopen
argument_list|(
literal|"FOO"
argument_list|,
literal|"r"
argument_list|,
name|stdout
argument_list|)
expr_stmt|;
else|else
name|fp
operator|=
name|fopen
argument_list|(
literal|"FOO"
argument_list|,
literal|"r"
argument_list|)
expr_stmt|;
if|if
condition|(
name|fp
operator|==
name|NULL
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"can't open FOO for initial read\n"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
if|if
condition|(
name|fread
argument_list|(
name|buf
argument_list|,
literal|1
argument_list|,
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
argument_list|,
name|fp
argument_list|)
operator|!=
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"failed to initial read\n"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
endif|#
directive|endif
if|if
condition|(
name|use_stdout
condition|)
name|fp
operator|=
name|freopen
argument_list|(
literal|"FOO"
argument_list|,
literal|"r"
argument_list|,
name|stdout
argument_list|)
expr_stmt|;
else|else
block|{
name|fclose
argument_list|(
name|fp
argument_list|)
expr_stmt|;
name|fp
operator|=
name|fopen
argument_list|(
literal|"FOO"
argument_list|,
literal|"r"
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|fp
operator|==
name|NULL
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"can't open FOO for reading\n"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|i
operator|=
name|getc
argument_list|(
name|fp
argument_list|)
operator|&
literal|0xff
expr_stmt|;
if|if
condition|(
name|i
operator|!=
name|buf
index|[
literal|0
index|]
operator|&
literal|0xff
condition|)
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"wrong first byte!\n"
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|1
init|;
name|i
operator|<
name|nseektbl
condition|;
operator|++
name|i
control|)
block|{
if|if
condition|(
name|seek_kind
operator|==
name|SEEK_CUR
condition|)
name|j
operator|=
name|seektbl
index|[
name|i
index|]
operator|-
name|seektbl
index|[
name|i
operator|-
literal|1
index|]
operator|-
literal|1
expr_stmt|;
else|else
name|j
operator|=
name|seektbl
index|[
name|i
index|]
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"seeking to %d (%d bytes)...\n"
argument_list|,
name|seektbl
index|[
name|i
index|]
argument_list|,
name|j
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"we are at: %d\n"
argument_list|,
name|ftell
argument_list|(
name|fp
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|fseek
argument_list|(
name|fp
argument_list|,
name|j
argument_list|,
name|seek_kind
argument_list|)
operator|<
literal|0
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"can't seek to %d\n"
argument_list|,
name|seektbl
index|[
name|i
index|]
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|j
operator|=
name|ftell
argument_list|(
name|fp
argument_list|)
expr_stmt|;
if|if
condition|(
name|j
operator|!=
name|seektbl
index|[
name|i
index|]
condition|)
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"ftell returned %d, not %d\n"
argument_list|,
name|j
argument_list|,
name|seektbl
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|j
operator|=
name|getc
argument_list|(
name|fp
argument_list|)
operator|&
literal|0xff
expr_stmt|;
name|k
operator|=
name|buf
index|[
name|seektbl
index|[
name|i
index|]
index|]
operator|&
literal|0xff
expr_stmt|;
if|if
condition|(
name|j
operator|!=
name|k
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"wrong byte at %d [%d vs %d]\n"
argument_list|,
name|seektbl
index|[
name|i
index|]
argument_list|,
name|j
argument_list|,
name|k
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
block|}
return|return
literal|0
return|;
block|}
end_function

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/* $Header: registerhost.c,v 2.5 87/04/01 11:48:11 jqj Exp $ */
end_comment

begin_comment
comment|/*  * This program enters a Unix host into the Clearinghouse as a server and  * workstation, hence eligible for gap telnet   */
end_comment

begin_comment
comment|/*  * $Log:	registerhost.c,v $  * Revision 2.5  87/04/01  11:48:11  jqj  * merged Webster changes: added -f switch for registering as file service  *   * Revision 2.4  87/02/19  13:29:59  jqj  * If hostname() returns a fully qualified Internet domain name, use only  * the leaf (first) componenent.  *   * Revision 2.3  86/12/15  11:27:06  jqj  * rework address code to permit multihomed hosts.  *   * Revision 2.2  86/05/07  14:05:27  jqj  * eliminated use of ns_netof, since it has alignment problems on Gould  *   * Revision 2.1  85/12/17  10:25:34  jqj  * from Sklower:  default to our address as set by ifconfig  *   * Revision 2.0  85/11/21  07:22:36  jqj  * 4.3BSD standard release  *   * Revision 1.1  85/11/20  13:54:08  jqj  * Initial revision  *   */
end_comment

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_include
include|#
directive|include
file|<sys/types.h>
end_include

begin_include
include|#
directive|include
file|<netns/ns.h>
end_include

begin_include
include|#
directive|include
file|"Clearinghouse2_defs.h"
end_include

begin_include
include|#
directive|include
file|<xnscourier/CHEntries.h>
end_include

begin_include
include|#
directive|include
file|<xnscourier/CH.h>
end_include

begin_include
include|#
directive|include
file|<xnscourier/except.h>
end_include

begin_escape
end_escape

begin_function
name|char
modifier|*
name|ItemToString
parameter_list|(
name|item
parameter_list|)
name|Item
name|item
decl_stmt|;
block|{
name|char
modifier|*
name|strval
decl_stmt|;
name|Unspecified
name|buf
index|[
literal|501
index|]
decl_stmt|,
modifier|*
name|bp
decl_stmt|;
name|Cardinal
name|len
decl_stmt|;
name|externalize_Item
argument_list|(
operator|&
name|item
argument_list|,
name|buf
argument_list|)
expr_stmt|;
name|bp
operator|=
name|buf
expr_stmt|;
name|bp
operator|+=
name|internalize_Cardinal
argument_list|(
operator|&
name|len
argument_list|,
name|bp
argument_list|)
expr_stmt|;
name|bp
operator|+=
name|internalize_String
argument_list|(
operator|&
name|strval
argument_list|,
name|bp
argument_list|)
expr_stmt|;
return|return
operator|(
name|strval
operator|)
return|;
block|}
end_function

begin_function
name|Item
name|StringToItem
parameter_list|(
name|strval
parameter_list|)
name|String
name|strval
decl_stmt|;
block|{
name|Unspecified
name|buf
index|[
literal|501
index|]
decl_stmt|,
modifier|*
name|bp
decl_stmt|;
name|Item
name|item
decl_stmt|;
name|Cardinal
name|len
decl_stmt|;
name|bp
operator|=
name|buf
operator|+
name|sizeof_Cardinal
argument_list|(
name|len
argument_list|)
expr_stmt|;
name|len
operator|=
name|externalize_String
argument_list|(
operator|&
name|strval
argument_list|,
name|bp
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|externalize_Cardinal
argument_list|(
operator|&
name|len
argument_list|,
name|buf
argument_list|)
expr_stmt|;
name|internalize_Item
argument_list|(
operator|&
name|item
argument_list|,
name|buf
argument_list|)
expr_stmt|;
return|return
operator|(
name|item
operator|)
return|;
block|}
end_function

begin_function
name|int
name|isprop
parameter_list|(
name|prop
parameter_list|,
name|proplist
parameter_list|)
name|Property
name|prop
decl_stmt|;
name|Properties
name|proplist
decl_stmt|;
block|{
name|int
name|i
decl_stmt|;
name|prop
operator|=
name|prop
operator|<<
literal|16
expr_stmt|;
comment|/* correct for bug in Clearinghouse v 2 */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|proplist
operator|.
name|length
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|proplist
operator|.
name|sequence
index|[
name|i
index|]
operator|==
name|prop
condition|)
return|return
operator|(
literal|1
operator|)
return|;
block|}
return|return
operator|(
literal|0
operator|)
return|;
comment|/* not found */
block|}
end_function

begin_function
name|char
modifier|*
name|XNSaddrToString
parameter_list|(
name|addr
parameter_list|)
name|struct
name|ns_addr
modifier|*
name|addr
decl_stmt|;
block|{
name|u_char
modifier|*
name|s
decl_stmt|;
specifier|static
name|char
name|buf
index|[
literal|21
index|]
decl_stmt|;
union|union
block|{
name|u_short
name|y_net
index|[
literal|2
index|]
decl_stmt|;
name|u_long
name|y_long
decl_stmt|;
block|}
name|netvalue
union|;
name|s
operator|=
name|addr
operator|->
name|x_host
operator|.
name|c_host
expr_stmt|;
name|netvalue
operator|.
name|y_net
index|[
literal|0
index|]
operator|=
name|addr
operator|->
name|x_net
operator|.
name|s_net
index|[
literal|0
index|]
expr_stmt|;
name|netvalue
operator|.
name|y_net
index|[
literal|1
index|]
operator|=
name|addr
operator|->
name|x_net
operator|.
name|s_net
index|[
literal|1
index|]
expr_stmt|;
name|sprintf
argument_list|(
name|buf
argument_list|,
literal|"%lx#%x.%x.%x.%x.%x.%x#%x"
argument_list|,
name|ntohl
argument_list|(
name|netvalue
operator|.
name|y_long
argument_list|)
argument_list|,
name|s
index|[
literal|0
index|]
argument_list|,
name|s
index|[
literal|1
index|]
argument_list|,
name|s
index|[
literal|2
index|]
argument_list|,
name|s
index|[
literal|3
index|]
argument_list|,
name|s
index|[
literal|4
index|]
argument_list|,
name|s
index|[
literal|5
index|]
argument_list|,
name|ntohs
argument_list|(
name|addr
operator|->
name|x_port
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|(
name|buf
operator|)
return|;
block|}
end_function

begin_macro
name|addNAelem
argument_list|(
argument|nalistp
argument_list|,
argument|addr
argument_list|)
end_macro

begin_decl_stmt
name|NetworkAddressList
modifier|*
name|nalistp
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|struct
name|ns_addr
modifier|*
name|addr
decl_stmt|;
end_decl_stmt

begin_block
block|{
specifier|register
name|NetworkAddress
modifier|*
name|naddrp
decl_stmt|;
name|naddrp
operator|=
name|nalistp
operator|->
name|sequence
operator|+
name|nalistp
operator|->
name|length
expr_stmt|;
name|nalistp
operator|->
name|length
operator|++
expr_stmt|;
name|naddrp
operator|->
name|network
index|[
literal|0
index|]
operator|=
name|htons
argument_list|(
name|addr
operator|->
name|x_net
operator|.
name|s_net
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
name|naddrp
operator|->
name|network
index|[
literal|1
index|]
operator|=
name|htons
argument_list|(
name|addr
operator|->
name|x_net
operator|.
name|s_net
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
name|naddrp
operator|->
name|host
index|[
literal|0
index|]
operator|=
name|htons
argument_list|(
name|addr
operator|->
name|x_host
operator|.
name|s_host
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
name|naddrp
operator|->
name|host
index|[
literal|1
index|]
operator|=
name|htons
argument_list|(
name|addr
operator|->
name|x_host
operator|.
name|s_host
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
name|naddrp
operator|->
name|host
index|[
literal|2
index|]
operator|=
name|htons
argument_list|(
name|addr
operator|->
name|x_host
operator|.
name|s_host
index|[
literal|2
index|]
argument_list|)
expr_stmt|;
block|}
end_block

begin_function
name|Item
name|getaddresslist
parameter_list|(
name|myaddr
parameter_list|)
name|struct
name|ns_addr
modifier|*
name|myaddr
decl_stmt|;
block|{
name|char
name|addrstr
index|[
literal|200
index|]
decl_stmt|;
name|struct
name|ns_addr
name|addr
decl_stmt|;
specifier|extern
name|struct
name|ns_addr
name|ns_addr
parameter_list|()
function_decl|;
name|NetworkAddressList
name|nalist
decl_stmt|;
name|Unspecified
name|buf
index|[
literal|501
index|]
decl_stmt|,
modifier|*
name|bp
decl_stmt|;
name|Item
name|item
decl_stmt|;
name|Cardinal
name|len
decl_stmt|;
name|NetworkAddress
name|naddrs
index|[
literal|10
index|]
decl_stmt|;
name|nalist
operator|.
name|length
operator|=
literal|0
expr_stmt|;
name|nalist
operator|.
name|sequence
operator|=
name|naddrs
expr_stmt|;
name|printf
argument_list|(
literal|"NS address (e.g. 2-273#2-613-688-939-672, - for default, CR to end):\nPrimary NS address: "
argument_list|)
expr_stmt|;
comment|/* get list of addresses */
name|gets
argument_list|(
name|addrstr
argument_list|)
expr_stmt|;
while|while
condition|(
operator|*
name|addrstr
operator|!=
literal|0
condition|)
block|{
if|if
condition|(
operator|*
name|addrstr
operator|==
literal|'-'
condition|)
block|{
name|addNAelem
argument_list|(
operator|&
name|nalist
argument_list|,
name|myaddr
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|addr
operator|=
name|ns_addr
argument_list|(
name|addrstr
argument_list|)
expr_stmt|;
name|addNAelem
argument_list|(
operator|&
name|nalist
argument_list|,
operator|&
name|addr
argument_list|)
expr_stmt|;
block|}
name|printf
argument_list|(
literal|"Additional NS address (CR for none): "
argument_list|)
expr_stmt|;
name|gets
argument_list|(
name|addrstr
argument_list|)
expr_stmt|;
block|}
comment|/* canonicalize socket #s */
for|for
control|(
name|len
operator|=
literal|0
init|;
name|len
operator|<
name|nalist
operator|.
name|length
condition|;
name|len
operator|++
control|)
name|nalist
operator|.
name|sequence
index|[
name|len
index|]
operator|.
name|socket
operator|=
literal|0
expr_stmt|;
comment|/* encode */
name|bp
operator|=
name|buf
operator|+
name|sizeof_Cardinal
argument_list|(
name|len
argument_list|)
expr_stmt|;
name|len
operator|=
name|externalize_NetworkAddressList
argument_list|(
operator|&
name|nalist
argument_list|,
name|bp
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|externalize_Cardinal
argument_list|(
operator|&
name|len
argument_list|,
name|buf
argument_list|)
expr_stmt|;
name|internalize_Item
argument_list|(
operator|&
name|item
argument_list|,
name|buf
argument_list|)
expr_stmt|;
return|return
operator|(
name|item
operator|)
return|;
block|}
end_function

begin_escape
end_escape

begin_function
name|main
parameter_list|(
name|argc
parameter_list|,
name|argv
parameter_list|)
name|int
name|argc
decl_stmt|;
name|char
modifier|*
name|argv
index|[]
decl_stmt|;
block|{
name|ObjectName
name|myname
decl_stmt|,
name|name
decl_stmt|,
name|defname
decl_stmt|,
name|fsname
decl_stmt|;
name|struct
name|ns_addr
modifier|*
name|destaddr
decl_stmt|,
modifier|*
name|getXNSaddr
argument_list|()
decl_stmt|,
modifier|*
name|myaddr
decl_stmt|;
name|struct
name|sockaddr_ns
name|sns
decl_stmt|;
name|Authenticator
name|agent
decl_stmt|;
name|CourierConnection
modifier|*
name|conn
decl_stmt|;
name|int
name|i
decl_stmt|;
name|ListPropertiesResults
name|LPresult
decl_stmt|;
name|RetrieveItemResults
name|RIresult
decl_stmt|;
name|ChangeItemResults
name|CIresult
decl_stmt|;
name|AddItemPropertyResults
name|AIPresult
decl_stmt|;
name|char
modifier|*
name|pwd
decl_stmt|,
modifier|*
name|propval
decl_stmt|,
modifier|*
name|getXNSpass
argument_list|()
decl_stmt|,
modifier|*
name|malloc
argument_list|()
decl_stmt|,
modifier|*
name|gets
argument_list|()
decl_stmt|,
name|mystrname
index|[
literal|200
index|]
decl_stmt|,
modifier|*
name|myhostname
decl_stmt|;
name|String
name|ItemToString
parameter_list|()
function_decl|;
name|Item
name|item
decl_stmt|,
name|StringToItem
argument_list|()
decl_stmt|,
name|addrToItem
argument_list|()
decl_stmt|;
name|Property
name|propnum
decl_stmt|;
name|struct
name|ns_addr
modifier|*
name|addr
decl_stmt|;
specifier|static
name|Boolean
name|authseq
index|[
literal|2
index|]
init|=
block|{
literal|1
block|,
literal|0
block|}
decl_stmt|;
comment|/* simple, not strong */
name|Boolean
name|fileservice
init|=
literal|0
decl_stmt|;
name|int
name|opt
decl_stmt|;
specifier|extern
name|int
name|optind
decl_stmt|;
specifier|extern
name|char
modifier|*
name|optarg
decl_stmt|;
if|if
condition|(
name|argc
operator|<
literal|1
operator|||
name|argc
operator|>
literal|5
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Usage: %s [-f] [hostname]\n"
argument_list|,
name|argv
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
while|while
condition|(
operator|(
name|opt
operator|=
name|getopt
argument_list|(
name|argc
argument_list|,
name|argv
argument_list|,
literal|"f"
argument_list|)
operator|)
operator|!=
name|EOF
condition|)
switch|switch
condition|(
name|opt
condition|)
block|{
case|case
literal|'f'
case|:
name|fileservice
operator|++
expr_stmt|;
break|break;
default|default :
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Invalid command option -%c\n"
argument_list|,
name|opt
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
name|CH_NameDefault
argument_list|(
operator|&
name|defname
argument_list|)
expr_stmt|;
if|if
condition|(
name|argc
operator|==
name|optind
condition|)
block|{
name|char
modifier|*
name|tmp
decl_stmt|;
specifier|extern
name|char
modifier|*
name|index
parameter_list|()
function_decl|;
name|gethostname
argument_list|(
name|myhostname
operator|=
name|malloc
argument_list|(
literal|100
argument_list|)
argument_list|,
literal|100
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|tmp
operator|=
name|index
argument_list|(
name|myhostname
argument_list|,
literal|'.'
argument_list|)
operator|)
operator|!=
name|NULL
condition|)
operator|*
name|tmp
operator|=
literal|'\0'
expr_stmt|;
name|name
operator|=
name|CH_StringToName
argument_list|(
name|myhostname
argument_list|,
operator|&
name|defname
argument_list|)
expr_stmt|;
block|}
else|else
name|name
operator|=
name|CH_StringToName
argument_list|(
name|argv
index|[
name|optind
index|]
argument_list|,
operator|&
name|defname
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Registering host %s\n"
argument_list|,
name|CH_NameToString
argument_list|(
name|name
argument_list|)
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"XNS UserName: "
argument_list|)
expr_stmt|;
name|gets
argument_list|(
name|mystrname
argument_list|)
expr_stmt|;
name|myname
operator|=
name|CH_StringToName
argument_list|(
name|mystrname
argument_list|,
operator|&
name|name
argument_list|)
expr_stmt|;
name|pwd
operator|=
name|getXNSpass
argument_list|(
literal|"Password:"
argument_list|)
expr_stmt|;
name|MakeSimpleCredsAndVerifier
argument_list|(
operator|&
name|myname
argument_list|,
name|pwd
argument_list|,
operator|&
name|agent
operator|.
name|credentials
argument_list|,
operator|&
name|agent
operator|.
name|verifier
argument_list|)
expr_stmt|;
name|conn
operator|=
name|CH_GetFirstCH
argument_list|()
expr_stmt|;
name|i
operator|=
sizeof|sizeof
argument_list|(
name|sns
argument_list|)
expr_stmt|;
name|myaddr
operator|=
operator|&
name|sns
operator|.
name|sns_addr
expr_stmt|;
name|getsockname
argument_list|(
operator|*
operator|(
name|int
operator|*
operator|)
name|conn
argument_list|,
operator|&
name|sns
argument_list|,
operator|&
name|i
argument_list|)
expr_stmt|;
name|myaddr
operator|->
name|x_port
operator|=
literal|0
expr_stmt|;
name|DURING
block|{
name|LPresult
operator|=
name|ListProperties
argument_list|(
name|conn
argument_list|,
name|NULL
argument_list|,
name|name
argument_list|,
name|agent
argument_list|)
expr_stmt|;
block|}
name|HANDLER
block|{
if|if
condition|(
name|Exception
operator|.
name|Code
operator|==
name|ArgumentError
condition|)
block|{
name|DURING
name|CreateObject
argument_list|(
name|conn
argument_list|,
name|NULL
argument_list|,
name|name
argument_list|,
name|agent
argument_list|)
decl_stmt|;
name|HANDLER
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Can't create object. Error %d\n"
argument_list|,
name|Exception
operator|.
name|Code
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
name|END_HANDLER
expr_stmt|;
name|LPresult
operator|.
name|properties
operator|.
name|length
operator|=
literal|0
expr_stmt|;
block|}
else|else
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"ListProperties failed.  Error %d\n"
argument_list|,
name|Exception
operator|.
name|Code
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
block|}
name|END_HANDLER
expr_stmt|;
comment|/* AddressList property */
if|if
condition|(
name|isprop
argument_list|(
literal|4
argument_list|,
name|LPresult
operator|.
name|properties
argument_list|)
condition|)
block|{
name|addr
operator|=
name|CH_LookupAddr
argument_list|(
name|name
argument_list|,
literal|4
argument_list|)
expr_stmt|;
if|if
condition|(
name|addr
operator|==
literal|0
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"NetworkAddress is in property list, but CH_LookupAddr failed\n"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
name|printf
argument_list|(
literal|"Old address: %s\n"
argument_list|,
name|XNSaddrToString
argument_list|(
name|addr
argument_list|)
argument_list|)
expr_stmt|;
name|myaddr
operator|->
name|x_port
operator|=
literal|0
expr_stmt|;
name|item
operator|=
name|getaddresslist
argument_list|(
name|myaddr
argument_list|)
expr_stmt|;
name|DURING
name|CIresult
init|=
name|ChangeItem
argument_list|(
name|conn
argument_list|,
name|NULL
argument_list|,
name|name
argument_list|,
literal|4
argument_list|,
name|item
argument_list|,
name|agent
argument_list|)
decl_stmt|;
name|HANDLER
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Can't change address.  Error %d\n"
argument_list|,
name|Exception
operator|.
name|Code
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
name|END_HANDLER
expr_stmt|;
block|}
else|else
block|{
name|item
operator|=
name|getaddresslist
argument_list|(
name|myaddr
argument_list|)
expr_stmt|;
name|DURING
name|AIPresult
init|=
name|AddItemProperty
argument_list|(
name|conn
argument_list|,
name|NULL
argument_list|,
name|name
argument_list|,
literal|4
argument_list|,
name|item
argument_list|,
name|agent
argument_list|)
decl_stmt|;
name|HANDLER
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Can't add address property.  Error %d\n"
argument_list|,
name|Exception
operator|.
name|Code
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
name|END_HANDLER
expr_stmt|;
block|}
comment|/* AuthenticationLevel property */
if|if
condition|(
operator|!
name|isprop
argument_list|(
literal|8
argument_list|,
name|LPresult
operator|.
name|properties
argument_list|)
condition|)
block|{
name|item
operator|.
name|length
operator|=
literal|2
expr_stmt|;
name|item
operator|.
name|sequence
operator|=
operator|(
name|Unspecified
operator|*
operator|)
name|authseq
expr_stmt|;
name|DURING
name|AIPresult
init|=
name|AddItemProperty
argument_list|(
name|conn
argument_list|,
name|NULL
argument_list|,
name|name
argument_list|,
literal|8
argument_list|,
name|item
argument_list|,
name|agent
argument_list|)
decl_stmt|;
name|HANDLER
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Can't add AuthenticationLevel property.\n"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
name|END_HANDLER
expr_stmt|;
block|}
comment|/* description */
name|DURING
block|{
name|propnum
operator|=
literal|10005
expr_stmt|;
comment|/* 10005<<16; */
if|if
condition|(
name|isprop
argument_list|(
name|propnum
argument_list|,
name|LPresult
operator|.
name|properties
argument_list|)
condition|)
block|{
name|RIresult
operator|=
name|RetrieveItem
argument_list|(
name|conn
argument_list|,
name|NULL
argument_list|,
name|name
argument_list|,
name|propnum
argument_list|,
name|agent
argument_list|)
expr_stmt|;
name|propval
operator|=
name|ItemToString
argument_list|(
name|RIresult
operator|.
name|value
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Workstation description (Property 10005) has value ``%s''\n"
argument_list|,
name|propval
argument_list|)
expr_stmt|;
name|clear_RetrieveItemResults
argument_list|(
operator|&
name|RIresult
argument_list|)
expr_stmt|;
block|}
name|propnum
operator|=
literal|10024
expr_stmt|;
comment|/* 10024<<16; */
if|if
condition|(
name|isprop
argument_list|(
name|propnum
argument_list|,
name|LPresult
operator|.
name|properties
argument_list|)
condition|)
block|{
name|RIresult
operator|=
name|RetrieveItem
argument_list|(
name|conn
argument_list|,
name|NULL
argument_list|,
name|name
argument_list|,
name|propnum
argument_list|,
name|agent
argument_list|)
expr_stmt|;
name|propval
operator|=
name|ItemToString
argument_list|(
name|RIresult
operator|.
name|value
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Server description (Property 10024) has value ``%s''\nNew value: "
argument_list|,
name|propval
argument_list|)
expr_stmt|;
name|propval
operator|=
name|gets
argument_list|(
name|malloc
argument_list|(
literal|100
argument_list|)
argument_list|)
expr_stmt|;
name|item
operator|=
name|StringToItem
argument_list|(
name|propval
argument_list|)
expr_stmt|;
name|CIresult
operator|=
name|ChangeItem
argument_list|(
name|conn
argument_list|,
name|NULL
argument_list|,
name|name
argument_list|,
name|propnum
argument_list|,
name|item
argument_list|,
name|agent
argument_list|)
expr_stmt|;
name|clear_RetrieveItemResults
argument_list|(
operator|&
name|RIresult
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|printf
argument_list|(
literal|"Enter new description: "
argument_list|)
expr_stmt|;
name|propval
operator|=
name|gets
argument_list|(
name|malloc
argument_list|(
literal|100
argument_list|)
argument_list|)
expr_stmt|;
name|item
operator|=
name|StringToItem
argument_list|(
name|propval
argument_list|)
expr_stmt|;
name|AIPresult
operator|=
name|AddItemProperty
argument_list|(
name|conn
argument_list|,
name|NULL
argument_list|,
name|name
argument_list|,
name|propnum
argument_list|,
name|item
argument_list|,
name|agent
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|fileservice
condition|)
block|{
name|propnum
operator|=
literal|10000
expr_stmt|;
comment|/* 10000<<16 */
if|if
condition|(
name|isprop
argument_list|(
literal|10000
argument_list|,
name|LPresult
operator|.
name|properties
argument_list|)
condition|)
block|{
name|RIresult
operator|=
name|RetrieveItem
argument_list|(
name|conn
argument_list|,
name|NULL
argument_list|,
name|name
argument_list|,
name|propnum
argument_list|,
name|agent
argument_list|)
expr_stmt|;
name|propval
operator|=
name|ItemToString
argument_list|(
name|RIresult
operator|.
name|value
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"FileService description (Property 10000) has value ``%s''\nNew value: "
argument_list|,
name|propval
argument_list|)
expr_stmt|;
name|propval
operator|=
name|gets
argument_list|(
name|malloc
argument_list|(
literal|100
argument_list|)
argument_list|)
expr_stmt|;
name|item
operator|=
name|StringToItem
argument_list|(
name|propval
argument_list|)
expr_stmt|;
name|CIresult
operator|=
name|ChangeItem
argument_list|(
name|conn
argument_list|,
name|NULL
argument_list|,
name|name
argument_list|,
name|propnum
argument_list|,
name|item
argument_list|,
name|agent
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|printf
argument_list|(
literal|"Enter new FileService description: "
argument_list|)
expr_stmt|;
name|propval
operator|=
name|gets
argument_list|(
name|malloc
argument_list|(
literal|100
argument_list|)
argument_list|)
expr_stmt|;
name|item
operator|=
name|StringToItem
argument_list|(
name|propval
argument_list|)
expr_stmt|;
name|AIPresult
operator|=
name|AddItemProperty
argument_list|(
name|conn
argument_list|,
name|NULL
argument_list|,
name|name
argument_list|,
name|propnum
argument_list|,
name|item
argument_list|,
name|agent
argument_list|)
expr_stmt|;
block|}
block|}
block|}
name|HANDLER
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Error during Property manipulations, %d (%d)\n"
argument_list|,
name|Exception
operator|.
name|Code
argument_list|,
name|CourierErrArgs
argument_list|(
name|Clearinghouse2_CallErrorArgs
argument_list|,
name|problem
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|END_HANDLER
expr_stmt|;
block|}
end_function

end_unit


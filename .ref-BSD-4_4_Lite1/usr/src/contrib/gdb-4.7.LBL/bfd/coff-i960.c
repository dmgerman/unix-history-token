begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/* BFD back-end for Intel 960 COFF files.    Copyright (C) 1990, 1991, 1992 Free Software Foundation, Inc.    Written by Cygnus Support.  This file is part of BFD, the Binary File Descriptor library.  This program is free software; you can redistribute it and/or modify it under the terms of the GNU General Public License as published by the Free Software Foundation; either version 2 of the License, or (at your option) any later version.  This program is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License for more details.  You should have received a copy of the GNU General Public License along with this program; if not, write to the Free Software Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.  */
end_comment

begin_define
define|#
directive|define
name|I960
value|1
end_define

begin_define
define|#
directive|define
name|BADMAG
parameter_list|(
name|x
parameter_list|)
value|I960BADMAG(x)
end_define

begin_include
include|#
directive|include
file|"bfd.h"
end_include

begin_include
include|#
directive|include
file|"sysdep.h"
end_include

begin_include
include|#
directive|include
file|"libbfd.h"
end_include

begin_include
include|#
directive|include
file|"obstack.h"
end_include

begin_include
include|#
directive|include
file|"coff/i960.h"
end_include

begin_include
include|#
directive|include
file|"coff/internal.h"
end_include

begin_include
include|#
directive|include
file|"libcoff.h"
end_include

begin_comment
comment|/* to allow easier abstraction-breaking */
end_comment

begin_define
define|#
directive|define
name|COFF_LONG_FILENAMES
end_define

begin_define
define|#
directive|define
name|CALLS
value|0x66003800
end_define

begin_comment
comment|/* Template for 'calls' instruction	*/
end_comment

begin_define
define|#
directive|define
name|BAL
value|0x0b000000
end_define

begin_comment
comment|/* Template for 'bal' instruction	*/
end_comment

begin_define
define|#
directive|define
name|BAL_MASK
value|0x00ffffff
end_define

begin_decl_stmt
specifier|static
name|bfd_reloc_status_type
name|DEFUN
argument_list|(
name|optcall_callback
argument_list|,
operator|(
name|abfd
operator|,
name|reloc_entry
operator|,
name|symbol_in
operator|,
name|data
operator|,
name|ignore_input_section
operator|,
name|ignore_bfd
operator|)
argument_list|,
name|bfd
operator|*
name|abfd
name|AND
name|arelent
operator|*
name|reloc_entry
name|AND
name|asymbol
operator|*
name|symbol_in
name|AND
name|PTR
name|data
name|AND
name|asection
operator|*
name|ignore_input_section
name|AND
name|bfd
operator|*
name|ignore_bfd
argument_list|)
block|{
comment|/* This item has already been relocated correctly, but we may be    * able to patch in yet better code - done by digging out the    * correct info on this symbol */
name|bfd_reloc_status_type
name|result
decl_stmt|;
name|coff_symbol_type
modifier|*
name|cs
init|=
name|coffsymbol
argument_list|(
name|symbol_in
argument_list|)
decl_stmt|;
comment|/* So the target symbol has to be of coff type, and the symbol       has to have the correct native information within it */
if|if
condition|(
operator|(
name|cs
operator|->
name|symbol
operator|.
name|the_bfd
operator|->
name|xvec
operator|->
name|flavour
operator|!=
name|bfd_target_coff_flavour
operator|)
operator|||
operator|(
name|cs
operator|->
name|native
operator|==
operator|(
name|combined_entry_type
operator|*
operator|)
name|NULL
operator|)
condition|)
block|{
comment|/* This is interesting, consider the case where we're outputting */
comment|/* coff from a mix n match input, linking from coff to a symbol */
comment|/* defined in a bout file will cause this match to be true. Should */
comment|/* I complain ? - This will only work if the bout symbol is non */
comment|/* leaf. */
name|result
operator|=
name|bfd_reloc_dangerous
expr_stmt|;
block|}
else|else
block|{
switch|switch
condition|(
name|cs
operator|->
name|native
operator|->
name|u
operator|.
name|syment
operator|.
name|n_sclass
condition|)
block|{
case|case
name|C_LEAFSTAT
case|:
case|case
name|C_LEAFEXT
case|:
comment|/* This is a call to a leaf procedure, replace instruction with a bal 	 to the correct location */
block|{
name|union
name|internal_auxent
modifier|*
name|aux
init|=
operator|&
operator|(
operator|(
name|cs
operator|->
name|native
operator|+
literal|2
operator|)
operator|->
name|u
operator|.
name|auxent
operator|)
decl_stmt|;
name|int
name|word
init|=
name|bfd_get_32
argument_list|(
name|abfd
argument_list|,
operator|(
name|bfd_byte
operator|*
operator|)
name|data
operator|+
name|reloc_entry
operator|->
name|address
argument_list|)
decl_stmt|;
name|int
name|olf
init|=
operator|(
name|aux
operator|->
name|x_bal
operator|.
name|x_balntry
operator|-
name|cs
operator|->
name|native
operator|->
name|u
operator|.
name|syment
operator|.
name|n_value
operator|)
decl_stmt|;
name|BFD_ASSERT
argument_list|(
name|cs
operator|->
name|native
operator|->
name|u
operator|.
name|syment
operator|.
name|n_numaux
operator|==
literal|2
argument_list|)
expr_stmt|;
comment|/* We replace the original call instruction with a bal to */
comment|/* the bal entry point - the offset of which is described in the */
comment|/* 2nd auxent of the original symbol. We keep the native sym and */
comment|/* auxents untouched, so the delta between the two is the */
comment|/* offset of the bal entry point */
name|word
operator|=
operator|(
operator|(
name|word
operator|+
name|olf
operator|)
operator|&
name|BAL_MASK
operator|)
operator||
name|BAL
expr_stmt|;
name|bfd_put_32
argument_list|(
name|abfd
argument_list|,
name|word
argument_list|,
operator|(
name|bfd_byte
operator|*
operator|)
name|data
operator|+
name|reloc_entry
operator|->
name|address
argument_list|)
expr_stmt|;
block|}
name|result
operator|=
name|bfd_reloc_ok
expr_stmt|;
break|break;
case|case
name|C_SCALL
case|:
comment|/* This is a call to a system call, replace with a calls to # */
name|BFD_ASSERT
argument_list|(
literal|0
argument_list|)
expr_stmt|;
name|result
operator|=
name|bfd_reloc_ok
expr_stmt|;
break|break;
default|default:
name|result
operator|=
name|bfd_reloc_ok
expr_stmt|;
break|break;
block|}
block|}
return|return
name|result
return|;
block|}
end_decl_stmt

begin_decl_stmt
specifier|static
name|reloc_howto_type
name|howto_rellong
init|=
block|{
operator|(
name|unsigned
name|int
operator|)
name|R_RELLONG
block|,
literal|0
block|,
literal|2
block|,
literal|32
block|,
name|false
block|,
literal|0
block|,
name|true
block|,
name|true
block|,
literal|0
block|,
literal|"rellong"
block|,
name|true
block|,
literal|0xffffffff
block|,
literal|0xffffffff
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|reloc_howto_type
name|howto_iprmed
init|=
block|{
name|R_IPRMED
block|,
literal|0
block|,
literal|2
block|,
literal|24
block|,
name|true
block|,
literal|0
block|,
name|true
block|,
name|true
block|,
literal|0
block|,
literal|"iprmed "
block|,
name|true
block|,
literal|0x00ffffff
block|,
literal|0x00ffffff
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|reloc_howto_type
name|howto_optcall
init|=
block|{
name|R_OPTCALL
block|,
literal|0
block|,
literal|2
block|,
literal|24
block|,
name|true
block|,
literal|0
block|,
name|true
block|,
name|true
block|,
name|optcall_callback
block|,
literal|"optcall"
block|,
name|true
block|,
literal|0x00ffffff
block|,
literal|0x00ffffff
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|reloc_howto_type
modifier|*
name|DEFUN
argument_list|(
name|coff_i960_reloc_type_lookup
argument_list|,
operator|(
name|abfd
operator|,
name|code
operator|)
argument_list|,
name|bfd
operator|*
name|abfd
name|AND
name|bfd_reloc_code_real_type
name|code
argument_list|)
block|{
switch|switch
condition|(
name|code
condition|)
block|{
default|default:
return|return
literal|0
return|;
case|case
name|BFD_RELOC_I960_CALLJ
case|:
return|return
operator|&
name|howto_optcall
return|;
case|case
name|BFD_RELOC_32
case|:
return|return
operator|&
name|howto_rellong
return|;
case|case
name|BFD_RELOC_24_PCREL
case|:
return|return
operator|&
name|howto_iprmed
return|;
block|}
block|}
end_decl_stmt

begin_comment
comment|/* The real code is in coffcode.h */
end_comment

begin_define
define|#
directive|define
name|RTYPE2HOWTO
parameter_list|(
name|cache_ptr
parameter_list|,
name|dst
parameter_list|)
define|\
value|{							\    reloc_howto_type *howto_ptr;				\    switch ((dst)->r_type) {				\      case 17: howto_ptr =&howto_rellong; break;	\      case 25: howto_ptr =&howto_iprmed; break;		\      case 27: howto_ptr =&howto_optcall; break;	\      default: howto_ptr = 0; break;			\      }							\    cache_ptr->howto = howto_ptr;			\  }
end_define

begin_include
include|#
directive|include
file|"coffcode.h"
end_include

begin_decl_stmt
name|bfd_target
name|icoff_little_vec
init|=
block|{
literal|"coff-Intel-little"
block|,
comment|/* name */
name|bfd_target_coff_flavour
block|,
name|false
block|,
comment|/* data byte order is little */
name|false
block|,
comment|/* header byte order is little */
operator|(
name|HAS_RELOC
operator||
name|EXEC_P
operator||
comment|/* object flags */
name|HAS_LINENO
operator||
name|HAS_DEBUG
operator||
name|HAS_SYMS
operator||
name|HAS_LOCALS
operator||
name|DYNAMIC
operator||
name|WP_TEXT
operator|)
block|,
operator|(
name|SEC_HAS_CONTENTS
operator||
name|SEC_ALLOC
operator||
name|SEC_LOAD
operator||
name|SEC_RELOC
operator|)
block|,
comment|/* section flags */
literal|0
block|,
comment|/* leading underscore */
literal|'/'
block|,
comment|/* ar_pad_char */
literal|15
block|,
comment|/* ar_max_namelen */
literal|3
block|,
comment|/* minimum alignment power */
name|_do_getl64
block|,
name|_do_putl64
block|,
name|_do_getl32
block|,
name|_do_putl32
block|,
name|_do_getl16
block|,
name|_do_putl16
block|,
comment|/* data */
name|_do_getl64
block|,
name|_do_putl64
block|,
name|_do_getl32
block|,
name|_do_putl32
block|,
name|_do_getl16
block|,
name|_do_putl16
block|,
comment|/* hdrs */
block|{
name|_bfd_dummy_target
block|,
name|coff_object_p
block|,
comment|/* bfd_check_format */
name|bfd_generic_archive_p
block|,
name|_bfd_dummy_target
block|}
block|,
block|{
name|bfd_false
block|,
name|coff_mkobject
block|,
comment|/* bfd_set_format */
name|_bfd_generic_mkarchive
block|,
name|bfd_false
block|}
block|,
block|{
name|bfd_false
block|,
name|coff_write_object_contents
block|,
comment|/* bfd_write_contents */
name|_bfd_write_archive_contents
block|,
name|bfd_false
block|}
block|,
name|JUMP_TABLE
argument_list|(
name|coff
argument_list|)
block|,
name|COFF_SWAP_TABLE
block|,
name|coff_i960_reloc_type_lookup
block|,
name|coff_make_debug_symbol
block|, }
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|bfd_target
name|icoff_big_vec
init|=
block|{
literal|"coff-Intel-big"
block|,
comment|/* name */
name|bfd_target_coff_flavour
block|,
name|false
block|,
comment|/* data byte order is little */
name|true
block|,
comment|/* header byte order is big */
operator|(
name|HAS_RELOC
operator||
name|EXEC_P
operator||
comment|/* object flags */
name|HAS_LINENO
operator||
name|HAS_DEBUG
operator||
name|HAS_SYMS
operator||
name|HAS_LOCALS
operator||
name|DYNAMIC
operator||
name|WP_TEXT
operator|)
block|,
operator|(
name|SEC_HAS_CONTENTS
operator||
name|SEC_ALLOC
operator||
name|SEC_LOAD
operator||
name|SEC_RELOC
operator|)
block|,
comment|/* section flags */
literal|0
block|,
comment|/* leading underscore */
literal|'/'
block|,
comment|/* ar_pad_char */
literal|15
block|,
comment|/* ar_max_namelen */
literal|3
block|,
comment|/* minimum alignment power */
name|_do_getl64
block|,
name|_do_putl64
block|,
name|_do_getl32
block|,
name|_do_putl32
block|,
name|_do_getl16
block|,
name|_do_putl16
block|,
comment|/* data */
name|_do_getb64
block|,
name|_do_putb64
block|,
name|_do_getb32
block|,
name|_do_putb32
block|,
name|_do_getb16
block|,
name|_do_putb16
block|,
comment|/* hdrs */
block|{
name|_bfd_dummy_target
block|,
name|coff_object_p
block|,
comment|/* bfd_check_format */
name|bfd_generic_archive_p
block|,
name|_bfd_dummy_target
block|}
block|,
block|{
name|bfd_false
block|,
name|coff_mkobject
block|,
comment|/* bfd_set_format */
name|_bfd_generic_mkarchive
block|,
name|bfd_false
block|}
block|,
block|{
name|bfd_false
block|,
name|coff_write_object_contents
block|,
comment|/* bfd_write_contents */
name|_bfd_write_archive_contents
block|,
name|bfd_false
block|}
block|,
name|JUMP_TABLE
argument_list|(
name|coff
argument_list|)
block|,
name|COFF_SWAP_TABLE
block|,
name|coff_i960_reloc_type_lookup
block|,
name|coff_make_debug_symbol
block|, }
decl_stmt|;
end_decl_stmt

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * vms_cli.c - command line interface routines.  *							Pat Rankin, Nov'89  *	Routines called from vms_gawk.c for DCL parsing.  */
end_comment

begin_define
define|#
directive|define
name|P
parameter_list|(
name|foo
parameter_list|)
value|()
end_define

begin_include
include|#
directive|include
file|"config.h"
end_include

begin_comment
comment|/* in case we want to suppress 'const'&c */
end_comment

begin_include
include|#
directive|include
file|"vms.h"
end_include

begin_ifndef
ifndef|#
directive|ifndef
name|_STRING_H
end_ifndef

begin_include
include|#
directive|include
file|<string.h>
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_function_decl
specifier|extern
name|u_long
name|CLI$PRESENT
parameter_list|(
specifier|const
name|Dsc
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|extern
name|u_long
name|CLI$GET_VALUE
parameter_list|(
specifier|const
name|Dsc
modifier|*
parameter_list|,
name|Dsc
modifier|*
parameter_list|,
name|short
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|extern
name|u_long
name|CLI$DCL_PARSE
parameter_list|(
specifier|const
name|Dsc
modifier|*
parameter_list|,
specifier|const
name|void
modifier|*
parameter_list|,
modifier|...
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|extern
name|u_long
name|SYS$CLI
parameter_list|(
name|void
modifier|*
parameter_list|,
modifier|...
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|extern
name|u_long
name|SYS$FILESCAN
parameter_list|(
specifier|const
name|Dsc
modifier|*
parameter_list|,
name|void
modifier|*
parameter_list|,
name|long
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|extern
name|void
modifier|*
name|LIB$ESTABLISH
parameter_list|(
name|u_long
function_decl|(
modifier|*
name|handler
function_decl|)
parameter_list|(
name|void
modifier|*
parameter_list|,
name|void
modifier|*
parameter_list|)
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|extern
name|u_long
name|LIB$SIG_TO_RET
parameter_list|(
name|void
modifier|*
parameter_list|,
name|void
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_comment
comment|/* condition handler */
end_comment

begin_comment
comment|/* Cli_Present() - call CLI$PRESENT to determine whether a parameter or     */
end_comment

begin_comment
comment|/*		  qualifier is present on the [already parsed] command line */
end_comment

begin_function
name|u_long
name|Cli_Present
parameter_list|(
specifier|const
name|char
modifier|*
name|item
parameter_list|)
block|{
name|Dsc
name|item_dsc
decl_stmt|;
operator|(
name|void
operator|)
name|LIB$ESTABLISH
argument_list|(
name|LIB$SIG_TO_RET
argument_list|)
expr_stmt|;
name|item_dsc
operator|.
name|len
operator|=
name|strlen
argument_list|(
name|item_dsc
operator|.
name|adr
operator|=
operator|(
name|char
operator|*
operator|)
name|item
argument_list|)
expr_stmt|;
return|return
name|CLI$PRESENT
argument_list|(
operator|&
name|item_dsc
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/* Cli_Get_Value() - call CLI$GET_VALUE to retreive the value of a */
end_comment

begin_comment
comment|/*		    parameter or qualifier from the command line   */
end_comment

begin_function
name|u_long
name|Cli_Get_Value
parameter_list|(
specifier|const
name|char
modifier|*
name|item
parameter_list|,
name|char
modifier|*
name|result
parameter_list|,
name|int
name|size
parameter_list|)
block|{
name|Dsc
name|item_dsc
decl_stmt|,
name|res_dsc
decl_stmt|;
name|u_long
name|sts
decl_stmt|;
name|short
name|len
init|=
literal|0
decl_stmt|;
operator|(
name|void
operator|)
name|LIB$ESTABLISH
argument_list|(
name|LIB$SIG_TO_RET
argument_list|)
expr_stmt|;
name|item_dsc
operator|.
name|len
operator|=
name|strlen
argument_list|(
name|item_dsc
operator|.
name|adr
operator|=
operator|(
name|char
operator|*
operator|)
name|item
argument_list|)
expr_stmt|;
name|res_dsc
operator|.
name|len
operator|=
name|size
operator|,
name|res_dsc
operator|.
name|adr
operator|=
name|result
expr_stmt|;
name|sts
operator|=
name|CLI$GET_VALUE
argument_list|(
operator|&
name|item_dsc
argument_list|,
operator|&
name|res_dsc
argument_list|,
operator|&
name|len
argument_list|)
expr_stmt|;
name|result
index|[
name|len
index|]
operator|=
literal|'\0'
expr_stmt|;
return|return
name|sts
return|;
block|}
end_function

begin_comment
comment|/* Cli_Parse_Command() - use the $CLI system service (undocumented) to	 */
end_comment

begin_comment
comment|/*			retreive the actual command line (which might be */
end_comment

begin_comment
comment|/*			"run prog" or "mcr prog [params]") and then call */
end_comment

begin_comment
comment|/*			CLI$DCL_PARSE to parse it using specified tables */
end_comment

begin_function
name|u_long
name|Cli_Parse_Command
parameter_list|(
specifier|const
name|void
modifier|*
name|cmd_tables
parameter_list|,
specifier|const
name|char
modifier|*
name|cmd_verb
parameter_list|)
block|{
struct|struct
block|{
name|short
name|len
decl_stmt|,
name|code
decl_stmt|;
name|void
modifier|*
name|adr
decl_stmt|;
block|}
name|fscn
index|[
literal|2
index|]
struct|;
struct|struct
block|{
name|char
name|rqtype
decl_stmt|,
name|rqindx
decl_stmt|,
name|rqflags
decl_stmt|,
name|rqstat
decl_stmt|;
name|unsigned
label|:
literal|32
expr_stmt|;
name|Dsc
name|rdesc
decl_stmt|;
name|unsigned
label|:
literal|32
expr_stmt|;
name|unsigned
label|:
literal|32
expr_stmt|;
name|unsigned
label|:
literal|32
expr_stmt|;
block|}
name|cmd
struct|;
name|u_long
name|sts
decl_stmt|;
name|int
name|ltmp
decl_stmt|;
name|char
name|longbuf
index|[
literal|2600
index|]
decl_stmt|;
operator|(
name|void
operator|)
name|LIB$ESTABLISH
argument_list|(
name|LIB$SIG_TO_RET
argument_list|)
expr_stmt|;
name|memset
argument_list|(
operator|&
name|cmd
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
name|cmd
argument_list|)
expr_stmt|;
name|cmd
operator|.
name|rqtype
operator|=
name|CLI$K_GETCMD
expr_stmt|;
comment|/* command line minus the verb */
name|sts
operator|=
name|SYS$CLI
argument_list|(
operator|&
name|cmd
argument_list|,
operator|(
name|void
operator|*
operator|)
literal|0
argument_list|,
operator|(
name|void
operator|*
operator|)
literal|0
argument_list|)
expr_stmt|;
comment|/* get actual command line */
if|if
condition|(
name|vmswork
argument_list|(
name|sts
argument_list|)
condition|)
block|{
comment|/* ok => cli available& verb wasn't "RUN" */
comment|/* invoked via symbol => have command line (which might be empty) */
comment|/*    [might also be invoked via mcr or dcl; that's ok]		  */
if|if
condition|(
name|cmd
operator|.
name|rqstat
operator|==
name|CLI$K_VERB_MCR
condition|)
block|{
comment|/* need to strip image name from MCR invocation   */
name|memset
argument_list|(
name|fscn
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
name|fscn
argument_list|)
expr_stmt|;
name|fscn
index|[
literal|0
index|]
operator|.
name|code
operator|=
name|FSCN$_FILESPEC
expr_stmt|;
comment|/* full file specification */
operator|(
name|void
operator|)
name|SYS$FILESCAN
argument_list|(
operator|&
name|cmd
operator|.
name|rdesc
argument_list|,
name|fscn
argument_list|,
operator|(
name|long
operator|*
operator|)
literal|0
argument_list|)
expr_stmt|;
name|cmd
operator|.
name|rdesc
operator|.
name|len
operator|-=
name|fscn
index|[
literal|0
index|]
operator|.
name|len
expr_stmt|;
comment|/* shrink size */
name|cmd
operator|.
name|rdesc
operator|.
name|adr
operator|+=
name|fscn
index|[
literal|0
index|]
operator|.
name|len
expr_stmt|;
comment|/* advance ptr */
block|}
comment|/* prepend verb and then parse the command line */
name|strcat
argument_list|(
name|strcpy
argument_list|(
name|longbuf
argument_list|,
name|cmd_verb
argument_list|)
argument_list|,
literal|" "
argument_list|)
operator|,
name|ltmp
operator|=
name|strlen
argument_list|(
name|longbuf
argument_list|)
expr_stmt|;
if|if
condition|(
name|cmd
operator|.
name|rdesc
operator|.
name|len
operator|+
name|ltmp
operator|>
sizeof|sizeof
name|longbuf
condition|)
name|cmd
operator|.
name|rdesc
operator|.
name|len
operator|=
sizeof|sizeof
name|longbuf
operator|-
name|ltmp
expr_stmt|;
name|strncpy
argument_list|(
operator|&
name|longbuf
index|[
name|ltmp
index|]
argument_list|,
name|cmd
operator|.
name|rdesc
operator|.
name|adr
argument_list|,
name|cmd
operator|.
name|rdesc
operator|.
name|len
argument_list|)
expr_stmt|;
name|cmd
operator|.
name|rdesc
operator|.
name|len
operator|+=
name|ltmp
operator|,
name|cmd
operator|.
name|rdesc
operator|.
name|adr
operator|=
name|longbuf
expr_stmt|;
name|sts
operator|=
name|CLI$DCL_PARSE
argument_list|(
operator|&
name|cmd
operator|.
name|rdesc
argument_list|,
name|cmd_tables
argument_list|)
expr_stmt|;
block|}
return|return
name|sts
return|;
block|}
end_function

end_unit


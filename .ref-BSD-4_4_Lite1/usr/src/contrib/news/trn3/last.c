begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/* $Id: last.c,v 3.0 1992/02/01 03:09:32 davison Trn $  */
end_comment

begin_comment
comment|/* This software is Copyright 1991 by Stan Barber.   *  * Permission is hereby granted to copy, reproduce, redistribute or otherwise  * use this software as long as: there is no monetary profit gained  * specifically from the use or reproduction of this software, it is not  * sold, rented, traded or otherwise marketed, and this copyright notice is  * included prominently in any copy made.   *  * The author make no claims as to the fitness or correctness of this software  * for any use whatsoever, and it is provided as is. Any use of this software  * is at the user's own risk.   */
end_comment

begin_include
include|#
directive|include
file|"EXTERN.h"
end_include

begin_include
include|#
directive|include
file|"common.h"
end_include

begin_include
include|#
directive|include
file|"trn.h"
end_include

begin_include
include|#
directive|include
file|"util.h"
end_include

begin_include
include|#
directive|include
file|"intrp.h"
end_include

begin_include
include|#
directive|include
file|"INTERN.h"
end_include

begin_include
include|#
directive|include
file|"last.h"
end_include

begin_decl_stmt
name|char
modifier|*
name|lastname
init|=
name|Nullch
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* path name of .rnlast file */
end_comment

begin_function
name|void
name|last_init
parameter_list|(
name|tcbuf
parameter_list|)
name|char
modifier|*
name|tcbuf
decl_stmt|;
block|{
name|lastname
operator|=
name|savestr
argument_list|(
name|filexp
argument_list|(
name|LASTNAME
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|tmpfp
operator|=
name|fopen
argument_list|(
name|lastname
argument_list|,
literal|"r"
argument_list|)
operator|)
operator|!=
name|Nullfp
operator|&&
name|fgets
argument_list|(
name|tcbuf
argument_list|,
literal|1024
argument_list|,
name|tmpfp
argument_list|)
operator|!=
name|Nullch
condition|)
block|{
name|tcbuf
index|[
name|strlen
argument_list|(
name|tcbuf
argument_list|)
operator|-
literal|1
index|]
operator|=
literal|'\0'
expr_stmt|;
name|lastngname
operator|=
name|savestr
argument_list|(
name|tcbuf
argument_list|)
expr_stmt|;
name|fgets
argument_list|(
name|tcbuf
argument_list|,
literal|1024
argument_list|,
name|tmpfp
argument_list|)
expr_stmt|;
name|lasttime
operator|=
name|atol
argument_list|(
name|tcbuf
argument_list|)
expr_stmt|;
name|fgets
argument_list|(
name|tcbuf
argument_list|,
literal|1024
argument_list|,
name|tmpfp
argument_list|)
expr_stmt|;
name|lastactsiz
operator|=
name|atol
argument_list|(
name|tcbuf
argument_list|)
expr_stmt|;
if|if
condition|(
name|fgets
argument_list|(
name|tcbuf
argument_list|,
literal|1024
argument_list|,
name|tmpfp
argument_list|)
operator|!=
name|Nullch
condition|)
name|lastnewtime
operator|=
name|atol
argument_list|(
name|tcbuf
argument_list|)
expr_stmt|;
else|else
name|lastnewtime
operator|=
operator|(
name|lasttime
condition|?
name|lasttime
else|:
name|time
argument_list|(
name|Null
argument_list|(
name|time_t
operator|*
argument_list|)
argument_list|)
operator|-
literal|24L
operator|*
literal|60
operator|*
literal|60
operator|)
expr_stmt|;
if|if
condition|(
name|fgets
argument_list|(
name|tcbuf
argument_list|,
literal|1024
argument_list|,
name|tmpfp
argument_list|)
operator|!=
name|Nullch
condition|)
name|lastnewsize
operator|=
name|atol
argument_list|(
name|tcbuf
argument_list|)
expr_stmt|;
else|else
name|lastnewsize
operator|=
literal|0
expr_stmt|;
name|fclose
argument_list|(
name|tmpfp
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|lastngname
operator|=
name|nullstr
expr_stmt|;
name|lasttime
operator|=
literal|0
expr_stmt|;
name|lastactsiz
operator|=
literal|0
expr_stmt|;
name|lastnewsize
operator|=
literal|0
expr_stmt|;
comment|/* Use yesterday as an initial value for finding new groups. */
name|lastnewtime
operator|=
name|time
argument_list|(
name|Null
argument_list|(
name|time_t
operator|*
argument_list|)
argument_list|)
operator|-
literal|24L
operator|*
literal|60
operator|*
literal|60
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/* put out certain values for next run of rn */
end_comment

begin_function
name|void
name|writelast
parameter_list|()
block|{
if|if
condition|(
operator|(
name|tmpfp
operator|=
name|fopen
argument_list|(
name|lastname
argument_list|,
literal|"w"
argument_list|)
operator|)
operator|!=
name|Nullfp
condition|)
block|{
name|fprintf
argument_list|(
name|tmpfp
argument_list|,
literal|"%s\n%ld\n%ld\n%ld\n%ld\n"
argument_list|,
operator|(
name|ngname
operator|==
name|Nullch
condition|?
name|nullstr
else|:
name|ngname
operator|)
argument_list|,
operator|(
name|long
operator|)
name|lasttime
argument_list|,
operator|(
name|long
operator|)
name|lastactsiz
argument_list|,
operator|(
name|long
operator|)
name|lastnewtime
argument_list|,
operator|(
name|long
operator|)
name|lastnewsize
argument_list|)
expr_stmt|;
name|fclose
argument_list|(
name|tmpfp
argument_list|)
expr_stmt|;
block|}
else|else
name|printf
argument_list|(
argument|cantcreate
argument_list|,
argument|lastname
argument_list|)
name|FLUSH
expr_stmt|;
block|}
end_function

end_unit


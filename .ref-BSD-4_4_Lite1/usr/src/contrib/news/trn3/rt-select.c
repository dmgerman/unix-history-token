begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/* $Id: rt-select.c,v 3.0 1992/12/14 00:14:12 davison Trn $ */
end_comment

begin_include
include|#
directive|include
file|"EXTERN.h"
end_include

begin_include
include|#
directive|include
file|"common.h"
end_include

begin_include
include|#
directive|include
file|"trn.h"
end_include

begin_include
include|#
directive|include
file|"term.h"
end_include

begin_include
include|#
directive|include
file|"final.h"
end_include

begin_include
include|#
directive|include
file|"util.h"
end_include

begin_include
include|#
directive|include
file|"help.h"
end_include

begin_include
include|#
directive|include
file|"cache.h"
end_include

begin_include
include|#
directive|include
file|"bits.h"
end_include

begin_include
include|#
directive|include
file|"artsrch.h"
end_include

begin_include
include|#
directive|include
file|"ng.h"
end_include

begin_include
include|#
directive|include
file|"ngdata.h"
end_include

begin_include
include|#
directive|include
file|"ngstuff.h"
end_include

begin_include
include|#
directive|include
file|"kfile.h"
end_include

begin_include
include|#
directive|include
file|"rthread.h"
end_include

begin_include
include|#
directive|include
file|"rt-page.h"
end_include

begin_include
include|#
directive|include
file|"rt-util.h"
end_include

begin_include
include|#
directive|include
file|"INTERN.h"
end_include

begin_include
include|#
directive|include
file|"rt-select.h"
end_include

begin_comment
comment|/* When display mode is 'l', each author gets a separate line; when 's', no ** authors are displayed. */
end_comment

begin_decl_stmt
name|char
modifier|*
name|display_mode
init|=
name|select_order
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|char
name|sel_disp_char
index|[]
init|=
block|{
literal|' '
block|,
literal|'+'
block|,
literal|'-'
block|,
literal|'*'
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|char
name|sel_ret
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|bool
name|empty_ok
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|bool
name|disp_status_line
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|bool
name|clean_screen
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* Display a menu of threads/subjects/articles for the user to choose from. ** If "cmd" is '+' we display all the unread items and allow the user to mark ** them as selected and perform various commands upon them.  If "cmd" is 'U' ** the list consists of previously-read items for the user to mark as unread. */
end_comment

begin_function
name|char
name|do_selector
parameter_list|(
name|cmd
parameter_list|)
name|char_int
name|cmd
decl_stmt|;
block|{
specifier|register
name|int
name|j
decl_stmt|;
name|int
name|got_dash
decl_stmt|;
name|int
name|ch
decl_stmt|,
name|action
decl_stmt|;
name|char
name|page_char
decl_stmt|,
name|end_char
decl_stmt|;
name|char
name|promptbuf
index|[
literal|80
index|]
decl_stmt|;
name|char
name|oldmode
init|=
name|mode
decl_stmt|;
name|char
modifier|*
name|in_select
decl_stmt|;
name|mode
operator|=
literal|'t'
expr_stmt|;
name|sel_rereading
operator|=
operator|(
name|cmd
operator|==
literal|'U'
operator|)
expr_stmt|;
name|clear_on_stop
operator|=
name|TRUE
expr_stmt|;
name|empty_ok
operator|=
name|FALSE
expr_stmt|;
name|set_sel_mode
argument_list|(
name|cmd
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|cache_range
argument_list|(
name|sel_rereading
condition|?
name|absfirst
else|:
name|firstart
argument_list|,
name|lastart
argument_list|)
condition|)
block|{
name|sel_ret
operator|=
literal|'+'
expr_stmt|;
goto|goto
name|sel_exit
goto|;
block|}
name|start_selector
label|:
comment|/* Setup for selecting articles to read or set unread */
if|if
condition|(
name|sel_rereading
condition|)
block|{
name|page_char
operator|=
literal|'>'
expr_stmt|;
name|end_char
operator|=
literal|'Z'
expr_stmt|;
name|sel_page_app
operator|=
name|Null
argument_list|(
name|ARTICLE
operator|*
operator|*
argument_list|)
expr_stmt|;
name|sel_page_sp
operator|=
name|Nullsubj
expr_stmt|;
name|sel_mask
operator|=
name|AF_DELSEL
expr_stmt|;
block|}
else|else
block|{
name|page_char
operator|=
name|page_select
expr_stmt|;
name|end_char
operator|=
name|end_select
expr_stmt|;
if|if
condition|(
name|curr_artp
condition|)
block|{
name|sel_last_ap
operator|=
name|curr_artp
expr_stmt|;
name|sel_last_sp
operator|=
name|curr_artp
operator|->
name|subj
expr_stmt|;
block|}
name|sel_mask
operator|=
name|AF_SEL
expr_stmt|;
block|}
name|selected_only
operator|=
name|TRUE
expr_stmt|;
name|count_subjects
argument_list|(
name|cmd
condition|?
name|CS_UNSEL_STORE
else|:
name|CS_NORM
argument_list|)
expr_stmt|;
comment|/* If nothing to display, we're done. */
if|if
condition|(
operator|!
name|article_count
operator|&&
operator|!
name|empty_ok
condition|)
block|{
name|empty_complaint
argument_list|()
expr_stmt|;
name|sel_ret
operator|=
literal|'+'
expr_stmt|;
goto|goto
name|sel_exit
goto|;
block|}
name|init_pages
argument_list|()
expr_stmt|;
name|sel_item_index
operator|=
literal|0
expr_stmt|;
operator|*
name|promptbuf
operator|=
literal|'\0'
expr_stmt|;
name|disp_status_line
operator|=
name|FALSE
expr_stmt|;
if|if
condition|(
name|added_articles
operator|>
literal|0
condition|)
block|{
name|sprintf
argument_list|(
name|promptbuf
argument_list|,
literal|"** %ld new article%s arrived **  "
argument_list|,
operator|(
name|long
operator|)
name|added_articles
argument_list|,
name|added_articles
operator|==
literal|1
condition|?
name|nullstr
else|:
literal|"s"
argument_list|)
expr_stmt|;
name|disp_status_line
operator|=
name|TRUE
expr_stmt|;
block|}
name|added_articles
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|cmd
operator|&&
name|selected_count
condition|)
block|{
name|sprintf
argument_list|(
name|promptbuf
operator|+
name|strlen
argument_list|(
name|promptbuf
argument_list|)
argument_list|,
literal|"%ld article%s selected."
argument_list|,
operator|(
name|long
operator|)
name|selected_count
argument_list|,
name|selected_count
operator|==
literal|1
condition|?
literal|" is"
else|:
literal|"s are"
argument_list|)
expr_stmt|;
name|disp_status_line
operator|=
name|TRUE
expr_stmt|;
block|}
name|cmd
operator|=
literal|0
expr_stmt|;
name|display_selector
label|:
comment|/* Present a page of items to the user */
name|display_page
argument_list|()
expr_stmt|;
comment|/* Check if there is really anything left to display. */
if|if
condition|(
operator|!
name|sel_item_cnt
operator|&&
operator|!
name|empty_ok
condition|)
block|{
comment|/*TODO: this may not be needed anymore */
name|empty_complaint
argument_list|()
expr_stmt|;
name|sel_ret
operator|=
literal|'+'
expr_stmt|;
goto|goto
name|sel_exit
goto|;
block|}
name|empty_ok
operator|=
name|FALSE
expr_stmt|;
if|if
condition|(
name|sel_item_index
operator|>=
name|sel_item_cnt
condition|)
name|sel_item_index
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|disp_status_line
condition|)
block|{
name|printf
argument_list|(
literal|"\n%s"
argument_list|,
name|promptbuf
argument_list|)
expr_stmt|;
if|if
condition|(
name|can_home
condition|)
block|{
name|carriage_return
argument_list|()
expr_stmt|;
name|goto_line
argument_list|(
name|sel_last_line
operator|+
literal|1
argument_list|,
name|sel_last_line
argument_list|)
expr_stmt|;
block|}
else|else
name|putchar
argument_list|(
literal|'\n'
argument_list|)
expr_stmt|;
block|}
name|reask_selector
label|:
comment|/* Prompt the user */
ifdef|#
directive|ifdef
name|MAILCALL
name|setmail
argument_list|(
name|FALSE
argument_list|)
expr_stmt|;
endif|#
directive|endif
if|if
condition|(
name|sel_at_end
condition|)
name|sprintf
argument_list|(
name|cmd_buf
argument_list|,
literal|"%s [%c%c] --"
argument_list|,
operator|(
operator|!
name|sel_prior_arts
condition|?
literal|"All"
else|:
literal|"Bot"
operator|)
argument_list|,
name|end_char
argument_list|,
name|page_char
argument_list|)
expr_stmt|;
else|else
name|sprintf
argument_list|(
name|cmd_buf
argument_list|,
literal|"%s%ld%% [%c%c] --"
argument_list|,
operator|(
operator|!
name|sel_prior_arts
condition|?
literal|"Top "
else|:
name|nullstr
operator|)
argument_list|,
call|(
name|long
call|)
argument_list|(
operator|(
name|sel_prior_arts
operator|+
name|sel_page_arts
operator|)
operator|*
literal|100
operator|/
name|sel_total_arts
argument_list|)
argument_list|,
name|page_char
argument_list|,
name|end_char
argument_list|)
expr_stmt|;
name|sprintf
argument_list|(
name|promptbuf
argument_list|,
literal|"%s-- %s %s (%s%s order) -- %s"
argument_list|,
name|mailcall
argument_list|,
name|sel_exclusive
condition|?
literal|"SELECTED"
else|:
literal|"Select"
argument_list|,
name|sel_mode_string
argument_list|,
name|sel_direction
operator|<
literal|0
condition|?
literal|"reverse "
else|:
name|nullstr
argument_list|,
name|sel_sort_string
argument_list|,
name|cmd_buf
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|CLEAREOL
if|if
condition|(
name|erase_screen
operator|&&
name|can_home_clear
condition|)
name|clear_rest
argument_list|()
expr_stmt|;
endif|#
directive|endif
name|standout
argument_list|()
expr_stmt|;
name|fputs
argument_list|(
name|promptbuf
argument_list|,
name|stdout
argument_list|)
expr_stmt|;
name|un_standout
argument_list|()
expr_stmt|;
if|if
condition|(
name|can_home
condition|)
name|carriage_return
argument_list|()
expr_stmt|;
name|sel_line
operator|=
name|sel_last_line
expr_stmt|;
name|position_selector
label|:
name|got_dash
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|can_home
condition|)
name|goto_line
argument_list|(
name|sel_line
argument_list|,
name|sel_items
index|[
name|sel_item_index
index|]
operator|.
name|line
argument_list|)
expr_stmt|;
name|sel_line
operator|=
name|sel_items
index|[
name|sel_item_index
index|]
operator|.
name|line
expr_stmt|;
name|reinp_selector
label|:
comment|/* Grab some commands from the user */
name|fflush
argument_list|(
name|stdout
argument_list|)
expr_stmt|;
name|eat_typeahead
argument_list|()
expr_stmt|;
name|spin_char
operator|=
name|sel_chars
index|[
name|sel_item_index
index|]
expr_stmt|;
name|cache_until_key
argument_list|()
expr_stmt|;
name|spin_char
operator|=
literal|' '
expr_stmt|;
ifdef|#
directive|ifdef
name|CONDSUB
name|getcmd
argument_list|(
name|buf
argument_list|)
expr_stmt|;
name|ch
operator|=
operator|*
name|buf
expr_stmt|;
else|#
directive|else
name|getcmd
argument_list|(
name|cmd_buf
argument_list|)
expr_stmt|;
comment|/* If no conditionals, don't allow macros */
name|buf
index|[
literal|0
index|]
operator|=
name|ch
operator|=
operator|*
name|cmd_buf
expr_stmt|;
name|buf
index|[
literal|1
index|]
operator|=
name|FINISHCMD
expr_stmt|;
endif|#
directive|endif
if|if
condition|(
name|errno
condition|)
name|ch
operator|=
name|Ctl
argument_list|(
literal|'l'
argument_list|)
expr_stmt|;
if|if
condition|(
name|disp_status_line
condition|)
block|{
if|if
condition|(
name|can_home
condition|)
block|{
name|goto_line
argument_list|(
name|sel_line
argument_list|,
name|sel_last_line
operator|+
literal|1
argument_list|)
expr_stmt|;
name|erase_eol
argument_list|()
expr_stmt|;
name|sel_line
operator|=
name|sel_last_line
operator|+
literal|1
expr_stmt|;
block|}
name|disp_status_line
operator|=
name|FALSE
expr_stmt|;
block|}
if|if
condition|(
name|ch
operator|==
literal|'-'
condition|)
block|{
name|got_dash
operator|=
literal|1
expr_stmt|;
if|if
condition|(
operator|!
name|can_home
condition|)
name|putchar
argument_list|(
literal|'-'
argument_list|)
operator|,
name|fflush
argument_list|(
name|stdout
argument_list|)
expr_stmt|;
goto|goto
name|reinp_selector
goto|;
block|}
if|if
condition|(
name|ch
operator|==
literal|' '
condition|)
block|{
if|if
condition|(
name|sel_at_end
condition|)
name|ch
operator|=
name|end_char
expr_stmt|;
else|else
name|ch
operator|=
name|page_char
expr_stmt|;
block|}
name|in_select
operator|=
name|index
argument_list|(
name|sel_chars
argument_list|,
name|ch
argument_list|)
expr_stmt|;
if|if
condition|(
name|in_select
condition|)
block|{
name|j
operator|=
name|in_select
operator|-
name|sel_chars
expr_stmt|;
if|if
condition|(
name|j
operator|>=
name|sel_item_cnt
condition|)
block|{
name|dingaling
argument_list|()
expr_stmt|;
goto|goto
name|position_selector
goto|;
block|}
elseif|else
if|if
condition|(
name|got_dash
condition|)
empty_stmt|;
elseif|else
if|if
condition|(
name|sel_items
index|[
name|j
index|]
operator|.
name|sel
operator|==
literal|1
condition|)
name|action
operator|=
operator|(
name|sel_rereading
condition|?
literal|'k'
else|:
literal|'-'
operator|)
expr_stmt|;
else|else
name|action
operator|=
literal|'+'
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|ch
operator|==
literal|'*'
operator|&&
name|sel_mode
operator|==
name|SM_ARTICLE
condition|)
block|{
specifier|register
name|ARTICLE
modifier|*
name|ap
init|=
operator|(
name|ARTICLE
operator|*
operator|)
name|sel_items
index|[
name|sel_item_index
index|]
operator|.
name|ptr
decl_stmt|;
if|if
condition|(
name|sel_items
index|[
name|sel_item_index
index|]
operator|.
name|sel
condition|)
name|deselect_subject
argument_list|(
name|ap
operator|->
name|subj
argument_list|)
expr_stmt|;
else|else
name|select_subject
argument_list|(
name|ap
operator|->
name|subj
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|update_page
argument_list|()
expr_stmt|;
goto|goto
name|position_selector
goto|;
block|}
elseif|else
if|if
condition|(
name|ch
operator|==
literal|'y'
operator|||
name|ch
operator|==
literal|'.'
operator|||
name|ch
operator|==
literal|'*'
condition|)
block|{
name|j
operator|=
name|sel_item_index
expr_stmt|;
if|if
condition|(
name|sel_items
index|[
name|j
index|]
operator|.
name|sel
operator|==
literal|1
condition|)
name|action
operator|=
operator|(
name|sel_rereading
condition|?
literal|'k'
else|:
literal|'-'
operator|)
expr_stmt|;
else|else
name|action
operator|=
literal|'+'
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|ch
operator|==
literal|'k'
operator|||
name|ch
operator|==
literal|'j'
operator|||
name|ch
operator|==
literal|','
condition|)
block|{
name|j
operator|=
name|sel_item_index
expr_stmt|;
name|action
operator|=
literal|'k'
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|ch
operator|==
literal|'m'
operator|||
name|ch
operator|==
literal|'\\'
condition|)
block|{
name|j
operator|=
name|sel_item_index
expr_stmt|;
name|action
operator|=
literal|'-'
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|ch
operator|==
literal|'M'
condition|)
block|{
name|j
operator|=
name|sel_item_index
expr_stmt|;
name|action
operator|=
literal|'M'
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|ch
operator|==
literal|'@'
condition|)
block|{
name|sel_item_index
operator|=
literal|0
expr_stmt|;
name|j
operator|=
name|sel_item_cnt
operator|-
literal|1
expr_stmt|;
name|got_dash
operator|=
literal|1
expr_stmt|;
name|action
operator|=
literal|'@'
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|ch
operator|==
literal|'['
operator|||
name|ch
operator|==
literal|'p'
condition|)
block|{
if|if
condition|(
operator|--
name|sel_item_index
operator|<
literal|0
condition|)
name|sel_item_index
operator|=
name|sel_item_cnt
condition|?
name|sel_item_cnt
operator|-
literal|1
else|:
literal|0
expr_stmt|;
goto|goto
name|position_selector
goto|;
block|}
elseif|else
if|if
condition|(
name|ch
operator|==
literal|']'
operator|||
name|ch
operator|==
literal|'n'
condition|)
block|{
if|if
condition|(
operator|++
name|sel_item_index
operator|>=
name|sel_item_cnt
condition|)
name|sel_item_index
operator|=
literal|0
expr_stmt|;
goto|goto
name|position_selector
goto|;
block|}
else|else
block|{
name|sel_ret
operator|=
name|ch
expr_stmt|;
switch|switch
condition|(
name|sel_command
argument_list|(
name|ch
argument_list|)
condition|)
block|{
case|case
name|DS_POS
case|:
if|if
condition|(
operator|!
name|clean_screen
condition|)
goto|goto
name|display_selector
goto|;
goto|goto
name|position_selector
goto|;
case|case
name|DS_ASK
case|:
if|if
condition|(
operator|!
name|clean_screen
condition|)
goto|goto
name|display_selector
goto|;
goto|goto
name|reask_selector
goto|;
case|case
name|DS_DISPLAY
case|:
name|ds_display
label|:
if|if
condition|(
name|disp_status_line
condition|)
name|strcpy
argument_list|(
name|promptbuf
argument_list|,
name|buf
argument_list|)
expr_stmt|;
goto|goto
name|display_selector
goto|;
case|case
name|DS_UPDATE
case|:
if|if
condition|(
operator|!
name|clean_screen
condition|)
goto|goto
name|ds_display
goto|;
if|if
condition|(
name|disp_status_line
condition|)
block|{
name|printf
argument_list|(
literal|"\n%s"
argument_list|,
name|buf
argument_list|)
expr_stmt|;
if|if
condition|(
name|can_home
condition|)
block|{
name|carriage_return
argument_list|()
expr_stmt|;
name|up_line
argument_list|()
expr_stmt|;
name|erase_eol
argument_list|()
expr_stmt|;
block|}
block|}
name|update_page
argument_list|()
expr_stmt|;
if|if
condition|(
name|can_home
condition|)
block|{
name|goto_line
argument_list|(
name|sel_line
argument_list|,
name|sel_last_line
argument_list|)
expr_stmt|;
name|sel_line
operator|=
name|sel_last_line
expr_stmt|;
block|}
goto|goto
name|reask_selector
goto|;
case|case
name|DS_RESTART
case|:
goto|goto
name|start_selector
goto|;
case|case
name|DS_QUIT
case|:
name|sel_cleanup
argument_list|()
expr_stmt|;
if|if
condition|(
operator|!
name|output_chase_phrase
condition|)
name|putchar
argument_list|(
literal|'\n'
argument_list|)
name|FLUSH
expr_stmt|;
goto|goto
name|sel_exit
goto|;
case|case
name|DS_STATUS
case|:
name|disp_status_line
operator|=
name|TRUE
expr_stmt|;
if|if
condition|(
operator|!
name|clean_screen
condition|)
block|{
name|strcpy
argument_list|(
name|promptbuf
argument_list|,
name|buf
argument_list|)
expr_stmt|;
goto|goto
name|display_selector
goto|;
block|}
if|if
condition|(
name|can_home
condition|)
block|{
name|goto_line
argument_list|(
name|sel_line
argument_list|,
name|sel_last_line
operator|+
literal|1
argument_list|)
expr_stmt|;
name|sel_line
operator|=
name|sel_last_line
operator|+
literal|1
expr_stmt|;
block|}
else|else
name|putchar
argument_list|(
literal|'\n'
argument_list|)
expr_stmt|;
name|fputs
argument_list|(
name|buf
argument_list|,
name|stdout
argument_list|)
expr_stmt|;
if|if
condition|(
name|can_home
condition|)
name|carriage_return
argument_list|()
expr_stmt|;
else|else
name|putchar
argument_list|(
literal|'\n'
argument_list|)
expr_stmt|;
goto|goto
name|position_selector
goto|;
block|}
block|}
comment|/* The user manipulated one of the letters -- handle it. */
if|if
condition|(
operator|!
name|got_dash
condition|)
name|sel_item_index
operator|=
name|j
expr_stmt|;
else|else
block|{
if|if
condition|(
name|j
operator|<
name|sel_item_index
condition|)
block|{
name|ch
operator|=
name|sel_item_index
operator|-
literal|1
expr_stmt|;
name|sel_item_index
operator|=
name|j
expr_stmt|;
name|j
operator|=
name|ch
expr_stmt|;
block|}
block|}
if|if
condition|(
operator|++
name|j
operator|==
name|sel_item_cnt
condition|)
name|j
operator|=
literal|0
expr_stmt|;
do|do
block|{
specifier|register
name|int
name|sel
init|=
name|sel_items
index|[
name|sel_item_index
index|]
operator|.
name|sel
decl_stmt|;
specifier|register
name|SUBJECT
modifier|*
name|sp
init|=
operator|(
name|SUBJECT
operator|*
operator|)
name|sel_items
index|[
name|sel_item_index
index|]
operator|.
name|ptr
decl_stmt|;
if|if
condition|(
name|can_home
condition|)
block|{
name|goto_line
argument_list|(
name|sel_line
argument_list|,
name|sel_items
index|[
name|sel_item_index
index|]
operator|.
name|line
argument_list|)
expr_stmt|;
name|sel_line
operator|=
name|sel_items
index|[
name|sel_item_index
index|]
operator|.
name|line
expr_stmt|;
block|}
if|if
condition|(
name|action
operator|==
literal|'@'
condition|)
block|{
if|if
condition|(
name|sel
operator|==
literal|2
condition|)
name|ch
operator|=
operator|(
name|sel_rereading
condition|?
literal|'+'
else|:
literal|' '
operator|)
expr_stmt|;
elseif|else
if|if
condition|(
name|sel_rereading
condition|)
name|ch
operator|=
literal|'k'
expr_stmt|;
elseif|else
if|if
condition|(
name|sel
operator|==
literal|1
condition|)
name|ch
operator|=
literal|'-'
expr_stmt|;
else|else
name|ch
operator|=
literal|'+'
expr_stmt|;
block|}
else|else
name|ch
operator|=
name|action
expr_stmt|;
switch|switch
condition|(
name|ch
condition|)
block|{
case|case
literal|'+'
case|:
if|if
condition|(
name|sel_mode
operator|==
name|SM_THREAD
condition|)
name|select_thread
argument_list|(
name|sp
operator|->
name|thread
argument_list|,
literal|0
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|sel_mode
operator|==
name|SM_SUBJECT
condition|)
name|select_subject
argument_list|(
name|sp
argument_list|,
literal|0
argument_list|)
expr_stmt|;
else|else
name|select_article
argument_list|(
operator|(
name|ARTICLE
operator|*
operator|)
name|sp
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|output_sel
argument_list|(
literal|1
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'-'
case|:
case|case
literal|'k'
case|:
case|case
literal|'M'
case|:
block|{
name|bool
name|sel_reread_save
init|=
name|sel_rereading
decl_stmt|;
if|if
condition|(
name|ch
operator|==
literal|'M'
condition|)
block|{
if|if
condition|(
name|sel_mode
operator|==
name|SM_ARTICLE
condition|)
name|delay_unmark
argument_list|(
operator|(
name|ARTICLE
operator|*
operator|)
name|sp
argument_list|)
expr_stmt|;
else|else
block|{
specifier|register
name|ARTICLE
modifier|*
name|ap
decl_stmt|;
if|if
condition|(
name|sel_mode
operator|==
name|SM_THREAD
condition|)
block|{
for|for
control|(
name|ap
operator|=
name|first_art
argument_list|(
name|sp
argument_list|)
init|;
name|ap
condition|;
name|ap
operator|=
name|next_art
argument_list|(
name|ap
argument_list|)
control|)
if|if
condition|(
operator|!
operator|(
name|ap
operator|->
name|flags
operator|&
name|AF_READ
operator|)
operator|^
name|sel_rereading
condition|)
name|delay_unmark
argument_list|(
name|ap
argument_list|)
expr_stmt|;
block|}
else|else
block|{
for|for
control|(
name|ap
operator|=
name|sp
operator|->
name|articles
init|;
name|ap
condition|;
name|ap
operator|=
name|ap
operator|->
name|subj_next
control|)
if|if
condition|(
operator|!
operator|(
name|ap
operator|->
name|flags
operator|&
name|AF_READ
operator|)
operator|^
name|sel_rereading
condition|)
name|delay_unmark
argument_list|(
name|ap
argument_list|)
expr_stmt|;
block|}
block|}
block|}
if|if
condition|(
name|ch
operator|==
literal|'-'
condition|)
name|sel_rereading
operator|=
name|FALSE
expr_stmt|;
else|else
name|sel_rereading
operator|=
name|TRUE
expr_stmt|;
if|if
condition|(
name|sel_mode
operator|==
name|SM_THREAD
condition|)
name|deselect_thread
argument_list|(
name|sp
operator|->
name|thread
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|sel_mode
operator|==
name|SM_SUBJECT
condition|)
name|deselect_subject
argument_list|(
name|sp
argument_list|)
expr_stmt|;
else|else
name|deselect_article
argument_list|(
operator|(
name|ARTICLE
operator|*
operator|)
name|sp
argument_list|)
expr_stmt|;
name|sel_rereading
operator|=
name|sel_reread_save
expr_stmt|;
name|output_sel
argument_list|(
name|ch
operator|==
literal|'-'
condition|?
literal|0
else|:
literal|2
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
name|fflush
argument_list|(
name|stdout
argument_list|)
expr_stmt|;
if|if
condition|(
operator|++
name|sel_item_index
operator|==
name|sel_item_cnt
condition|)
name|sel_item_index
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|can_home
condition|)
name|carriage_return
argument_list|()
expr_stmt|;
block|}
do|while
condition|(
name|sel_item_index
operator|!=
name|j
condition|)
do|;
goto|goto
name|position_selector
goto|;
name|sel_exit
label|:
if|if
condition|(
name|sel_rereading
condition|)
block|{
name|sel_rereading
operator|=
literal|0
expr_stmt|;
name|sel_mask
operator|=
name|AF_SEL
expr_stmt|;
block|}
if|if
condition|(
name|sel_mode
operator|!=
name|SM_ARTICLE
operator|||
name|sel_sort
operator|==
name|SS_GROUPS
operator|||
name|sel_sort
operator|==
name|SS_SUBJECT
condition|)
block|{
if|if
condition|(
name|artptr_list
condition|)
block|{
name|free
argument_list|(
operator|(
name|char
operator|*
operator|)
name|artptr_list
argument_list|)
expr_stmt|;
name|artptr_list
operator|=
name|sel_page_app
operator|=
name|Null
argument_list|(
name|ARTICLE
operator|*
operator|*
argument_list|)
expr_stmt|;
name|sort_subjects
argument_list|()
expr_stmt|;
block|}
name|artptr
operator|=
name|Null
argument_list|(
name|ARTICLE
operator|*
operator|*
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|ARTSEARCH
if|if
condition|(
operator|!
name|ThreadedGroup
condition|)
name|srchahead
operator|=
operator|-
literal|1
expr_stmt|;
endif|#
directive|endif
block|}
ifdef|#
directive|ifdef
name|ARTSEARCH
else|else
name|srchahead
operator|=
literal|0
expr_stmt|;
endif|#
directive|endif
name|selected_only
operator|=
operator|(
name|selected_count
operator|||
operator|!
name|article_count
operator|)
expr_stmt|;
if|if
condition|(
name|sel_ret
operator|!=
literal|'#'
condition|)
name|count_subjects
argument_list|(
name|sel_ret
operator|==
literal|'+'
condition|?
name|CS_RESELECT
else|:
name|CS_UNSELECT
argument_list|)
expr_stmt|;
name|clear_on_stop
operator|=
name|FALSE
expr_stmt|;
name|mode
operator|=
name|oldmode
expr_stmt|;
if|if
condition|(
name|sel_ret
operator|==
literal|'+'
condition|)
block|{
name|art
operator|=
name|curr_art
expr_stmt|;
name|artp
operator|=
name|curr_artp
expr_stmt|;
block|}
else|else
name|top_article
argument_list|()
expr_stmt|;
return|return
name|sel_ret
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|sel_cleanup
parameter_list|()
block|{
if|if
condition|(
name|sel_rereading
condition|)
block|{
comment|/* Turn selections into unread selected articles.  Let 	** count_subjects() fix the counts after we're through. 	*/
specifier|register
name|SUBJECT
modifier|*
name|sp
decl_stmt|;
name|sel_last_ap
operator|=
name|Nullart
expr_stmt|;
name|sel_last_sp
operator|=
name|Nullsubj
expr_stmt|;
for|for
control|(
name|sp
operator|=
name|first_subject
init|;
name|sp
condition|;
name|sp
operator|=
name|sp
operator|->
name|next
control|)
name|unkill_subject
argument_list|(
name|sp
argument_list|)
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|sel_mode
operator|==
name|SM_ARTICLE
condition|)
block|{
specifier|register
name|ARTICLE
modifier|*
name|ap
decl_stmt|;
specifier|register
name|ART_NUM
name|an
decl_stmt|;
for|for
control|(
name|an
operator|=
name|absfirst
operator|,
name|ap
operator|=
name|article_ptr
argument_list|(
name|an
argument_list|)
init|;
name|an
operator|<=
name|lastart
condition|;
name|an
operator|++
operator|,
name|ap
operator|++
control|)
block|{
if|if
condition|(
name|ap
operator|->
name|flags
operator|&
name|AF_DEL
condition|)
block|{
name|ap
operator|->
name|flags
operator|&=
operator|~
name|AF_DEL
expr_stmt|;
name|set_read
argument_list|(
name|ap
argument_list|)
expr_stmt|;
block|}
block|}
block|}
else|else
block|{
specifier|register
name|SUBJECT
modifier|*
name|sp
decl_stmt|;
for|for
control|(
name|sp
operator|=
name|first_subject
init|;
name|sp
condition|;
name|sp
operator|=
name|sp
operator|->
name|next
control|)
block|{
if|if
condition|(
name|sp
operator|->
name|flags
operator|&
name|SF_DEL
condition|)
block|{
name|sp
operator|->
name|flags
operator|&=
operator|~
name|SF_DEL
expr_stmt|;
if|if
condition|(
name|sel_mode
operator|==
name|SM_THREAD
condition|)
name|kill_thread
argument_list|(
name|sp
operator|->
name|thread
argument_list|,
name|KF_UNSELECTED
argument_list|)
expr_stmt|;
else|else
name|kill_subject
argument_list|(
name|sp
argument_list|,
name|KF_UNSELECTED
argument_list|)
expr_stmt|;
block|}
block|}
block|}
block|}
block|}
end_function

begin_function
specifier|static
name|int
name|sel_command
parameter_list|(
name|ch
parameter_list|)
name|char_int
name|ch
decl_stmt|;
block|{
if|if
condition|(
name|can_home
condition|)
name|goto_line
argument_list|(
name|sel_line
argument_list|,
name|sel_last_line
argument_list|)
expr_stmt|;
name|sel_line
operator|=
name|sel_last_line
expr_stmt|;
name|clean_screen
operator|=
name|TRUE
expr_stmt|;
name|do_command
label|:
name|output_chase_phrase
operator|=
name|TRUE
expr_stmt|;
switch|switch
condition|(
name|ch
condition|)
block|{
case|case
literal|'>'
case|:
name|sel_item_index
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|next_page
argument_list|()
condition|)
return|return
name|DS_DISPLAY
return|;
return|return
name|DS_POS
return|;
case|case
literal|'<'
case|:
name|sel_item_index
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|prev_page
argument_list|()
condition|)
return|return
name|DS_DISPLAY
return|;
return|return
name|DS_POS
return|;
case|case
literal|'^'
case|:
case|case
name|Ctl
argument_list|(
literal|'r'
argument_list|)
case|:
name|sel_item_index
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|first_page
argument_list|()
condition|)
return|return
name|DS_DISPLAY
return|;
return|return
name|DS_POS
return|;
case|case
literal|'$'
case|:
name|sel_item_index
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|last_page
argument_list|()
condition|)
return|return
name|DS_DISPLAY
return|;
return|return
name|DS_POS
return|;
case|case
name|Ctl
argument_list|(
literal|'l'
argument_list|)
case|:
return|return
name|DS_DISPLAY
return|;
case|case
name|Ctl
argument_list|(
literal|'f'
argument_list|)
case|:
name|erase_eol
argument_list|()
expr_stmt|;
comment|/* erase the prompt */
ifdef|#
directive|ifdef
name|MAILCALL
name|setmail
argument_list|(
name|TRUE
argument_list|)
expr_stmt|;
comment|/* force a mail check */
endif|#
directive|endif
return|return
name|DS_ASK
return|;
case|case
literal|'#'
case|:
block|{
specifier|register
name|SUBJECT
modifier|*
name|sp
decl_stmt|;
for|for
control|(
name|sp
operator|=
name|first_subject
init|;
name|sp
condition|;
name|sp
operator|=
name|sp
operator|->
name|next
control|)
name|sp
operator|->
name|flags
operator|&=
operator|~
name|SF_VISIT
expr_stmt|;
name|selected_count
operator|=
literal|0
expr_stmt|;
name|sp
operator|=
operator|(
name|SUBJECT
operator|*
operator|)
name|sel_items
index|[
name|sel_item_index
index|]
operator|.
name|ptr
expr_stmt|;
switch|switch
condition|(
name|sel_mode
condition|)
block|{
case|case
name|SM_THREAD
case|:
name|deselect_thread
argument_list|(
name|sp
operator|->
name|thread
argument_list|)
expr_stmt|;
name|select_thread
argument_list|(
name|sp
operator|->
name|thread
argument_list|,
literal|0
argument_list|)
expr_stmt|;
break|break;
case|case
name|SM_SUBJECT
case|:
name|deselect_subject
argument_list|(
name|sp
argument_list|)
expr_stmt|;
name|select_subject
argument_list|(
name|sp
argument_list|,
literal|0
argument_list|)
expr_stmt|;
break|break;
case|case
name|SM_ARTICLE
case|:
name|deselect_article
argument_list|(
operator|(
name|ARTICLE
operator|*
operator|)
name|sp
argument_list|)
expr_stmt|;
name|select_article
argument_list|(
operator|(
name|ARTICLE
operator|*
operator|)
name|sp
argument_list|,
literal|0
argument_list|)
expr_stmt|;
break|break;
block|}
return|return
name|DS_QUIT
return|;
block|}
case|case
literal|'\r'
case|:
case|case
literal|'\n'
case|:
if|if
condition|(
operator|!
name|selected_count
condition|)
block|{
if|if
condition|(
name|sel_rereading
operator|||
name|sel_items
index|[
name|sel_item_index
index|]
operator|.
name|sel
operator|!=
literal|2
condition|)
block|{
specifier|register
name|SUBJECT
modifier|*
name|sp
init|=
operator|(
name|SUBJECT
operator|*
operator|)
name|sel_items
index|[
name|sel_item_index
index|]
operator|.
name|ptr
decl_stmt|;
switch|switch
condition|(
name|sel_mode
condition|)
block|{
case|case
name|SM_THREAD
case|:
name|select_thread
argument_list|(
name|sp
operator|->
name|thread
argument_list|,
literal|0
argument_list|)
expr_stmt|;
break|break;
case|case
name|SM_SUBJECT
case|:
name|select_subject
argument_list|(
name|sp
argument_list|,
literal|0
argument_list|)
expr_stmt|;
break|break;
case|case
name|SM_ARTICLE
case|:
name|select_article
argument_list|(
operator|(
name|ARTICLE
operator|*
operator|)
name|sp
argument_list|,
literal|0
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
block|}
return|return
name|DS_QUIT
return|;
case|case
literal|'Z'
case|:
case|case
literal|'\t'
case|:
return|return
name|DS_QUIT
return|;
case|case
literal|'q'
case|:
case|case
literal|'Q'
case|:
return|return
name|DS_QUIT
return|;
case|case
name|Ctl
argument_list|(
literal|'Q'
argument_list|)
case|:
case|case
literal|'\033'
case|:
case|case
literal|'+'
case|:
name|sel_ret
operator|=
literal|'+'
expr_stmt|;
return|return
name|DS_QUIT
return|;
case|case
literal|'N'
case|:
case|case
literal|'P'
case|:
return|return
name|DS_QUIT
return|;
case|case
literal|'L'
case|:
if|if
condition|(
operator|!
operator|*
operator|++
name|display_mode
condition|)
name|display_mode
operator|=
name|select_order
expr_stmt|;
return|return
name|DS_DISPLAY
return|;
case|case
literal|'Y'
case|:
if|if
condition|(
operator|!
name|dmcount
condition|)
block|{
name|sprintf
argument_list|(
name|buf
argument_list|,
literal|"No marked articles to yank back."
argument_list|)
expr_stmt|;
return|return
name|DS_STATUS
return|;
block|}
name|yankback
argument_list|()
expr_stmt|;
name|sel_line
operator|++
expr_stmt|;
if|if
condition|(
operator|!
name|sel_rereading
condition|)
name|sel_cleanup
argument_list|()
expr_stmt|;
name|disp_status_line
operator|=
name|TRUE
expr_stmt|;
name|count_subjects
argument_list|(
name|CS_NORM
argument_list|)
expr_stmt|;
name|sel_page_sp
operator|=
name|Nullsubj
expr_stmt|;
name|sel_page_app
operator|=
name|Null
argument_list|(
name|ARTICLE
operator|*
operator|*
argument_list|)
expr_stmt|;
name|init_pages
argument_list|()
expr_stmt|;
return|return
name|DS_DISPLAY
return|;
case|case
literal|'U'
case|:
name|sel_cleanup
argument_list|()
expr_stmt|;
name|sel_rereading
operator|=
operator|!
name|sel_rereading
expr_stmt|;
name|sel_page_sp
operator|=
name|Nullsubj
expr_stmt|;
name|sel_page_app
operator|=
name|Null
argument_list|(
name|ARTICLE
operator|*
operator|*
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|cache_range
argument_list|(
name|sel_rereading
condition|?
name|absfirst
else|:
name|firstart
argument_list|,
name|lastart
argument_list|)
condition|)
name|sel_rereading
operator|=
operator|!
name|sel_rereading
expr_stmt|;
name|empty_ok
operator|=
name|TRUE
expr_stmt|;
return|return
name|DS_RESTART
return|;
case|case
literal|'='
case|:
if|if
condition|(
operator|!
name|sel_rereading
condition|)
name|sel_cleanup
argument_list|()
expr_stmt|;
if|if
condition|(
name|sel_mode
operator|==
name|SM_ARTICLE
condition|)
block|{
name|set_selector
argument_list|(
name|sel_threadmode
argument_list|,
name|sel_threadsort
argument_list|)
expr_stmt|;
name|sel_page_sp
operator|=
name|sel_page_app
index|[
literal|0
index|]
operator|->
name|subj
expr_stmt|;
block|}
else|else
block|{
name|set_selector
argument_list|(
name|SM_ARTICLE
argument_list|,
name|sel_artsort
argument_list|)
expr_stmt|;
name|sel_page_app
operator|=
literal|0
expr_stmt|;
block|}
name|count_subjects
argument_list|(
name|CS_NORM
argument_list|)
expr_stmt|;
name|sel_item_index
operator|=
literal|0
expr_stmt|;
name|init_pages
argument_list|()
expr_stmt|;
return|return
name|DS_DISPLAY
return|;
case|case
literal|'S'
case|:
if|if
condition|(
operator|!
name|sel_rereading
condition|)
name|sel_cleanup
argument_list|()
expr_stmt|;
name|erase_eol
argument_list|()
expr_stmt|;
comment|/* erase the prompt */
name|reask_output
label|:
name|in_char
argument_list|(
literal|"Selector mode:  Threads, Subjects, Articles? [tsa] "
argument_list|,
literal|'o'
argument_list|)
expr_stmt|;
name|setdef
argument_list|(
name|buf
argument_list|,
literal|"t"
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|VERIFY
name|printcmd
argument_list|()
expr_stmt|;
endif|#
directive|endif
if|if
condition|(
operator|*
name|buf
operator|==
literal|'h'
condition|)
block|{
ifdef|#
directive|ifdef
name|VERBOSE
name|IF
argument_list|(
argument|verbose
argument_list|)
name|fputs
argument_list|(
literal|"\n\ Type t or SP to display/select thread groups (threads the group, if needed).\n\ Type s to display/select subject groups.\n\ Type a to display/select individual articles.\n\ Type q to leave things as they are.\n\n\ "
argument_list|,
argument|stdout
argument_list|)
name|FLUSH
expr_stmt|;
name|ELSE
endif|#
directive|endif
ifdef|#
directive|ifdef
name|TERSE
name|fputs
argument_list|(
literal|"\n\ t or SP selects thread groups (threads the group too).\n\ s selects subject groups.\n\ a selects individual articles.\n\ q does nothing.\n\n\ "
argument_list|,
name|stdout
argument_list|)
name|FLUSH
decl_stmt|;
endif|#
directive|endif
name|clean_screen
operator|=
name|FALSE
expr_stmt|;
goto|goto
name|reask_output
goto|;
block|}
elseif|else
if|if
condition|(
operator|*
name|buf
operator|==
literal|'q'
condition|)
block|{
if|if
condition|(
name|can_home
condition|)
block|{
name|carriage_return
argument_list|()
expr_stmt|;
name|erase_eol
argument_list|()
expr_stmt|;
block|}
return|return
name|DS_ASK
return|;
block|}
name|set_sel_mode
argument_list|(
operator|*
name|buf
argument_list|)
expr_stmt|;
name|count_subjects
argument_list|(
name|CS_NORM
argument_list|)
expr_stmt|;
name|init_pages
argument_list|()
expr_stmt|;
return|return
name|DS_DISPLAY
return|;
case|case
literal|'O'
case|:
if|if
condition|(
operator|!
name|sel_rereading
condition|)
name|sel_cleanup
argument_list|()
expr_stmt|;
name|erase_eol
argument_list|()
expr_stmt|;
comment|/* erase the prompt */
name|reask_sort
label|:
if|if
condition|(
name|sel_mode
operator|==
name|SM_ARTICLE
condition|)
name|in_char
argument_list|(
literal|"Order by Date, Subject, Author, subject-date Groups? [dsagDSAG] "
argument_list|,
literal|'q'
argument_list|)
expr_stmt|;
else|else
name|in_char
argument_list|(
literal|"Order by Date, Subject, or Count? [dscDSC] "
argument_list|,
literal|'q'
argument_list|)
expr_stmt|;
name|setdef
argument_list|(
name|buf
argument_list|,
literal|"d"
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|VERIFY
name|printcmd
argument_list|()
expr_stmt|;
endif|#
directive|endif
if|if
condition|(
operator|*
name|buf
operator|==
literal|'h'
condition|)
block|{
ifdef|#
directive|ifdef
name|VERBOSE
name|IF
argument_list|(
argument|verbose
argument_list|)
block|{
name|fputs
argument_list|(
literal|"\n\ Type d or SP to order the displayed items by date.\n\ Type s to order the items by subject.\n\ "
argument_list|,
argument|stdout
argument_list|)
name|FLUSH
expr_stmt|;
if|if
condition|(
name|sel_mode
operator|==
name|SM_ARTICLE
condition|)
name|fputs
argument_list|(
literal|"\ Type a to order the items by author.\n\ Type g to order the items in subject-groups by date.\n\ "
argument_list|,
argument|stdout
argument_list|)
name|FLUSH
expr_stmt|;
else|else
name|fputs
argument_list|(
literal|"\ Type c to order the items by article-count.\n\ "
argument_list|,
argument|stdout
argument_list|)
name|FLUSH
expr_stmt|;
name|fputs
argument_list|(
literal|"\ Typing your selection in upper case it will reverse the selected order.\n\ Type q to leave things as they are.\n\n\ "
argument_list|,
argument|stdout
argument_list|)
name|FLUSH
expr_stmt|;
block|}
name|ELSE
endif|#
directive|endif
ifdef|#
directive|ifdef
name|TERSE
block|{
name|fputs
argument_list|(
literal|"\n\ d or SP sorts by date.\n\ s sorts by subject.\n\ "
argument_list|,
argument|stdout
argument_list|)
name|FLUSH
expr_stmt|;
if|if
condition|(
name|sel_mode
operator|==
name|SM_ARTICLE
condition|)
name|fputs
argument_list|(
literal|"\ a sorts by author.\n\ g sorts in subject-groups by date.\n\ "
argument_list|,
argument|stdout
argument_list|)
name|FLUSH
expr_stmt|;
else|else
name|fputs
argument_list|(
literal|"\ c sorts by article-count.\n\ "
argument_list|,
argument|stdout
argument_list|)
name|FLUSH
expr_stmt|;
name|fputs
argument_list|(
literal|"\ Upper case reverses the sort.\n\ q does nothing.\n\n\ "
argument_list|,
argument|stdout
argument_list|)
name|FLUSH
expr_stmt|;
block|}
endif|#
directive|endif
name|clean_screen
operator|=
name|FALSE
expr_stmt|;
goto|goto
name|reask_sort
goto|;
block|}
elseif|else
if|if
condition|(
operator|*
name|buf
operator|==
literal|'q'
condition|)
block|{
if|if
condition|(
name|can_home
condition|)
block|{
name|carriage_return
argument_list|()
expr_stmt|;
name|erase_eol
argument_list|()
expr_stmt|;
block|}
return|return
name|DS_ASK
return|;
block|}
name|set_sel_sort
argument_list|(
operator|*
name|buf
argument_list|)
expr_stmt|;
name|count_subjects
argument_list|(
name|CS_NORM
argument_list|)
expr_stmt|;
if|#
directive|if
literal|0
block|sel_last_sp = (SUBJECT*)sel_items[sel_item_index].ptr; 	sel_last_ap = sel_page_app[sel_item_index];
else|#
directive|else
name|sel_page_sp
operator|=
name|Nullsubj
expr_stmt|;
name|sel_page_app
operator|=
name|Null
argument_list|(
name|ARTICLE
operator|*
operator|*
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|init_pages
argument_list|()
expr_stmt|;
return|return
name|DS_DISPLAY
return|;
case|case
literal|'R'
case|:
if|if
condition|(
operator|!
name|sel_rereading
condition|)
name|sel_cleanup
argument_list|()
expr_stmt|;
name|sel_direction
operator|*=
operator|-
literal|1
expr_stmt|;
name|count_subjects
argument_list|(
name|CS_NORM
argument_list|)
expr_stmt|;
if|#
directive|if
literal|0
block|sel_last_sp = (SUBJECT*)sel_items[sel_item_index].ptr; 	sel_last_ap = sel_page_app[sel_item_index];
else|#
directive|else
name|sel_page_sp
operator|=
name|Nullsubj
expr_stmt|;
name|sel_page_app
operator|=
name|Null
argument_list|(
name|ARTICLE
operator|*
operator|*
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|init_pages
argument_list|()
expr_stmt|;
return|return
name|DS_DISPLAY
return|;
case|case
literal|'E'
case|:
if|if
condition|(
operator|!
name|sel_rereading
condition|)
name|sel_cleanup
argument_list|()
expr_stmt|;
name|sel_exclusive
operator|=
operator|!
name|sel_exclusive
expr_stmt|;
name|count_subjects
argument_list|(
name|CS_NORM
argument_list|)
expr_stmt|;
name|sel_page_sp
operator|=
name|Nullsubj
expr_stmt|;
name|sel_page_app
operator|=
name|Null
argument_list|(
name|ARTICLE
operator|*
operator|*
argument_list|)
expr_stmt|;
name|init_pages
argument_list|()
expr_stmt|;
name|empty_ok
operator|=
name|TRUE
expr_stmt|;
return|return
name|DS_DISPLAY
return|;
case|case
literal|'X'
case|:
case|case
literal|'D'
case|:
case|case
literal|'J'
case|:
if|if
condition|(
operator|!
name|sel_rereading
condition|)
block|{
if|if
condition|(
name|sel_mode
operator|==
name|SM_ARTICLE
condition|)
block|{
specifier|register
name|ARTICLE
modifier|*
name|ap
decl_stmt|,
modifier|*
modifier|*
name|app
decl_stmt|,
modifier|*
modifier|*
name|limit
decl_stmt|;
name|limit
operator|=
name|artptr_list
operator|+
name|article_count
expr_stmt|;
if|if
condition|(
name|ch
operator|==
literal|'D'
condition|)
name|app
operator|=
name|sel_page_app
expr_stmt|;
else|else
name|app
operator|=
name|artptr_list
expr_stmt|;
for|for
control|(
init|;
condition|;
control|)
block|{
name|ap
operator|=
operator|*
name|app
expr_stmt|;
if|if
condition|(
operator|(
operator|!
operator|(
name|ap
operator|->
name|flags
operator|&
name|AF_SEL
operator|)
operator|^
operator|(
name|ch
operator|==
literal|'J'
operator|)
operator|)
operator|||
operator|(
name|ap
operator|->
name|flags
operator|&
name|AF_DEL
operator|)
condition|)
if|if
condition|(
operator|!
name|sel_exclusive
operator|||
operator|(
name|ap
operator|->
name|flags
operator|&
name|AF_INCLUDED
operator|)
condition|)
name|set_read
argument_list|(
name|ap
argument_list|)
expr_stmt|;
name|app
operator|++
expr_stmt|;
if|if
condition|(
name|app
operator|>=
name|limit
operator|||
operator|(
name|ch
operator|==
literal|'D'
operator|&&
name|app
operator|==
name|sel_next_app
operator|)
condition|)
break|break;
block|}
block|}
else|else
block|{
specifier|register
name|SUBJECT
modifier|*
name|sp
decl_stmt|;
if|if
condition|(
name|ch
operator|==
literal|'D'
condition|)
name|sp
operator|=
name|sel_page_sp
expr_stmt|;
else|else
name|sp
operator|=
name|first_subject
expr_stmt|;
for|for
control|(
init|;
condition|;
control|)
block|{
if|if
condition|(
operator|(
operator|(
operator|!
operator|(
name|sp
operator|->
name|flags
operator|&
name|SF_SEL
operator|)
operator|^
operator|(
name|ch
operator|==
literal|'J'
operator|)
operator|)
operator|&&
name|sp
operator|->
name|misc
operator|)
operator|||
operator|(
name|sp
operator|->
name|flags
operator|&
name|SF_DEL
operator|)
condition|)
block|{
if|if
condition|(
operator|!
name|sel_exclusive
operator|||
operator|(
name|sp
operator|->
name|flags
operator|&
name|SF_INCLUDED
operator|)
condition|)
name|kill_subject
argument_list|(
name|sp
argument_list|,
name|ch
operator|==
literal|'J'
condition|?
name|KF_ALL
else|:
name|KF_UNSELECTED
argument_list|)
expr_stmt|;
block|}
name|sp
operator|=
name|sp
operator|->
name|next
expr_stmt|;
if|if
condition|(
operator|!
name|sp
operator|||
operator|(
name|ch
operator|==
literal|'D'
operator|&&
name|sp
operator|==
name|sel_next_sp
operator|)
condition|)
break|break;
block|}
block|}
name|count_subjects
argument_list|(
name|CS_UNSELECT
argument_list|)
expr_stmt|;
if|if
condition|(
name|article_count
operator|&&
operator|(
name|ch
operator|==
literal|'J'
operator|||
operator|(
name|ch
operator|==
literal|'D'
operator|&&
operator|!
name|selected_count
operator|)
operator|)
condition|)
block|{
if|if
condition|(
name|ch
operator|==
literal|'D'
condition|)
block|{
name|sel_page_sp
operator|=
name|sel_next_sp
expr_stmt|;
name|sel_page_app
operator|=
name|sel_next_app
expr_stmt|;
block|}
name|init_pages
argument_list|()
expr_stmt|;
name|sel_item_index
operator|=
literal|0
expr_stmt|;
return|return
name|DS_DISPLAY
return|;
block|}
if|if
condition|(
name|artptr_list
operator|&&
name|article_count
condition|)
name|sort_articles
argument_list|()
expr_stmt|;
return|return
name|DS_QUIT
return|;
block|}
elseif|else
if|if
condition|(
name|ch
operator|==
literal|'J'
condition|)
block|{
specifier|register
name|SUBJECT
modifier|*
name|sp
decl_stmt|;
for|for
control|(
name|sp
operator|=
name|first_subject
init|;
name|sp
condition|;
name|sp
operator|=
name|sp
operator|->
name|next
control|)
name|deselect_subject
argument_list|(
name|sp
argument_list|)
expr_stmt|;
name|selected_subj_cnt
operator|=
name|selected_count
operator|=
literal|0
expr_stmt|;
return|return
name|DS_DISPLAY
return|;
block|}
name|sprintf
argument_list|(
name|buf
argument_list|,
literal|"That command does not work in the set-unread selector."
argument_list|)
expr_stmt|;
return|return
name|DS_STATUS
return|;
case|case
literal|'T'
case|:
if|if
condition|(
operator|!
name|ThreadedGroup
condition|)
block|{
name|sprintf
argument_list|(
name|buf
argument_list|,
literal|"Group is not threaded."
argument_list|)
expr_stmt|;
return|return
name|DS_STATUS
return|;
block|}
comment|/* FALL THROUGH */
case|case
literal|'A'
case|:
name|erase_eol
argument_list|()
expr_stmt|;
comment|/* erase the prompt */
if|if
condition|(
name|sel_mode
operator|==
name|SM_ARTICLE
condition|)
name|artp
operator|=
operator|(
name|ARTICLE
operator|*
operator|)
name|sel_items
index|[
name|sel_item_index
index|]
operator|.
name|ptr
expr_stmt|;
else|else
name|artp
operator|=
operator|(
operator|(
name|SUBJECT
operator|*
operator|)
name|sel_items
index|[
name|sel_item_index
index|]
operator|.
name|ptr
operator|)
operator|->
name|articles
expr_stmt|;
name|art
operator|=
name|article_num
argument_list|(
name|artp
argument_list|)
expr_stmt|;
comment|/* This call executes the action too */
switch|switch
condition|(
name|ask_memorize
argument_list|(
name|ch
argument_list|)
condition|)
block|{
case|case
literal|'j'
case|:
case|case
literal|','
case|:
name|count_subjects
argument_list|(
name|sel_rereading
condition|?
name|CS_NORM
else|:
name|CS_UNSELECT
argument_list|)
expr_stmt|;
name|init_pages
argument_list|()
expr_stmt|;
name|sprintf
argument_list|(
name|buf
argument_list|,
literal|"Kill memorized."
argument_list|)
expr_stmt|;
name|disp_status_line
operator|=
name|TRUE
expr_stmt|;
return|return
name|DS_DISPLAY
return|;
case|case
literal|'.'
case|:
name|sprintf
argument_list|(
name|buf
argument_list|,
literal|"Selection memorized."
argument_list|)
expr_stmt|;
name|disp_status_line
operator|=
name|TRUE
expr_stmt|;
return|return
name|DS_DISPLAY
return|;
case|case
literal|'+'
case|:
name|sprintf
argument_list|(
name|buf
argument_list|,
literal|"Selection memorized."
argument_list|)
expr_stmt|;
name|disp_status_line
operator|=
name|TRUE
expr_stmt|;
return|return
name|DS_UPDATE
return|;
case|case
literal|'c'
case|:
case|case
literal|'C'
case|:
name|sprintf
argument_list|(
name|buf
argument_list|,
literal|"Auto-commands cleared."
argument_list|)
expr_stmt|;
name|disp_status_line
operator|=
name|TRUE
expr_stmt|;
return|return
name|DS_DISPLAY
return|;
case|case
literal|'q'
case|:
return|return
name|DS_DISPLAY
return|;
case|case
literal|'Q'
case|:
break|break;
block|}
if|if
condition|(
name|can_home
condition|)
block|{
name|carriage_return
argument_list|()
expr_stmt|;
name|erase_eol
argument_list|()
expr_stmt|;
block|}
return|return
name|DS_ASK
return|;
case|case
name|Ctl
argument_list|(
literal|'k'
argument_list|)
case|:
name|edit_kfile
argument_list|()
expr_stmt|;
return|return
name|DS_DISPLAY
return|;
case|case
literal|':'
case|:
case|case
literal|'/'
case|:
case|case
literal|'&'
case|:
case|case
literal|'!'
case|:
name|erase_eol
argument_list|()
expr_stmt|;
comment|/* erase the prompt */
if|if
condition|(
operator|!
name|finish_command
argument_list|(
name|TRUE
argument_list|)
condition|)
block|{
comment|/* get rest of command */
if|if
condition|(
name|clean_screen
condition|)
return|return
name|DS_ASK
return|;
goto|goto
name|extend_done
goto|;
block|}
if|if
condition|(
name|ch
operator|==
literal|'&'
operator|||
name|ch
operator|==
literal|'!'
condition|)
block|{
name|one_command
operator|=
name|TRUE
expr_stmt|;
name|perform
argument_list|(
name|buf
argument_list|,
name|FALSE
argument_list|)
expr_stmt|;
name|one_command
operator|=
name|FALSE
expr_stmt|;
name|putchar
argument_list|(
literal|'\n'
argument_list|)
name|FLUSH
expr_stmt|;
name|clean_screen
operator|=
name|FALSE
expr_stmt|;
block|}
else|else
block|{
name|int
name|sel_art_save
init|=
name|selected_count
decl_stmt|;
if|if
condition|(
name|ch
operator|==
literal|':'
condition|)
block|{
name|clean_screen
operator|=
operator|(
name|use_selected
argument_list|()
operator|==
literal|2
operator|)
operator|&&
name|clean_screen
expr_stmt|;
if|if
condition|(
operator|!
name|sel_rereading
condition|)
block|{
specifier|register
name|SUBJECT
modifier|*
name|sp
decl_stmt|;
for|for
control|(
name|sp
operator|=
name|first_subject
init|;
name|sp
condition|;
name|sp
operator|=
name|sp
operator|->
name|next
control|)
block|{
if|if
condition|(
name|sp
operator|->
name|flags
operator|&
name|SF_DEL
condition|)
block|{
name|sp
operator|->
name|flags
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|sel_mode
operator|==
name|SM_THREAD
condition|)
name|kill_thread
argument_list|(
name|sp
operator|->
name|thread
argument_list|,
name|KF_UNSELECTED
argument_list|)
expr_stmt|;
else|else
name|kill_subject
argument_list|(
name|sp
argument_list|,
name|KF_UNSELECTED
argument_list|)
expr_stmt|;
block|}
block|}
block|}
block|}
else|else
block|{
comment|/* Force the search to begin at absfirst or firstart, 		** depending upon whether they specified the 'r' option. 		*/
name|art
operator|=
name|lastart
operator|+
literal|1
expr_stmt|;
name|page_line
operator|=
literal|1
expr_stmt|;
switch|switch
condition|(
name|art_search
argument_list|(
name|buf
argument_list|,
sizeof|sizeof
name|buf
argument_list|,
name|FALSE
argument_list|)
condition|)
block|{
case|case
name|SRCH_ERROR
case|:
case|case
name|SRCH_ABORT
case|:
case|case
name|SRCH_INTR
case|:
name|fputs
argument_list|(
literal|"\nInterrupted\n"
argument_list|,
argument|stdout
argument_list|)
name|FLUSH
expr_stmt|;
break|break;
case|case
name|SRCH_DONE
case|:
case|case
name|SRCH_SUBJDONE
case|:
name|fputs
argument_list|(
literal|"Done\n"
argument_list|,
argument|stdout
argument_list|)
name|FLUSH
expr_stmt|;
break|break;
case|case
name|SRCH_NOTFOUND
case|:
name|fputs
argument_list|(
literal|"\nNot found.\n"
argument_list|,
argument|stdout
argument_list|)
name|FLUSH
expr_stmt|;
break|break;
case|case
name|SRCH_FOUND
case|:
break|break;
block|}
name|clean_screen
operator|=
name|FALSE
expr_stmt|;
block|}
comment|/* Recount, in case something has changed. */
name|count_subjects
argument_list|(
name|sel_rereading
condition|?
name|CS_NORM
else|:
name|CS_UNSELECT
argument_list|)
expr_stmt|;
name|init_pages
argument_list|()
expr_stmt|;
name|sel_item_index
operator|=
literal|0
expr_stmt|;
name|sel_art_save
operator|-=
name|selected_count
expr_stmt|;
if|if
condition|(
name|sel_art_save
condition|)
block|{
name|putchar
argument_list|(
literal|'\n'
argument_list|)
expr_stmt|;
if|if
condition|(
name|sel_art_save
operator|<
literal|0
condition|)
block|{
name|fputs
argument_list|(
literal|"S"
argument_list|,
name|stdout
argument_list|)
expr_stmt|;
name|sel_art_save
operator|*=
operator|-
literal|1
expr_stmt|;
block|}
else|else
name|fputs
argument_list|(
literal|"Des"
argument_list|,
name|stdout
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"elected %d article%s."
argument_list|,
name|sel_art_save
argument_list|,
name|sel_art_save
operator|==
literal|1
condition|?
name|nullstr
else|:
literal|"s"
argument_list|)
expr_stmt|;
name|clean_screen
operator|=
name|FALSE
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|clean_screen
condition|)
name|putchar
argument_list|(
literal|'\n'
argument_list|)
name|FLUSH
expr_stmt|;
block|}
comment|/* if !& else :/ */
if|if
condition|(
name|clean_screen
condition|)
block|{
name|carriage_return
argument_list|()
expr_stmt|;
name|up_line
argument_list|()
expr_stmt|;
name|erase_eol
argument_list|()
expr_stmt|;
return|return
name|DS_ASK
return|;
block|}
name|extend_done
label|:
if|if
condition|(
operator|(
name|ch
operator|=
name|pause_getcmd
argument_list|()
operator|)
condition|)
block|{
name|got_cmd
label|:
if|if
condition|(
name|ch
operator|>
literal|0
condition|)
block|{
comment|/* try to optimize the screen update for some commands. */
if|if
condition|(
operator|!
name|index
argument_list|(
name|sel_chars
argument_list|,
name|ch
argument_list|)
operator|&&
operator|(
name|index
argument_list|(
literal|"<+>^$!?&:/hDEJLNOPqQRSUXYZ\n\r\t\033"
argument_list|,
name|ch
argument_list|)
operator|||
name|ch
operator|==
name|Ctl
argument_list|(
literal|'k'
argument_list|)
operator|)
condition|)
block|{
name|buf
index|[
literal|0
index|]
operator|=
name|sel_ret
operator|=
name|ch
expr_stmt|;
name|buf
index|[
literal|1
index|]
operator|=
name|FINISHCMD
expr_stmt|;
goto|goto
name|do_command
goto|;
block|}
name|pushchar
argument_list|(
name|ch
operator||
literal|0200
argument_list|)
expr_stmt|;
block|}
block|}
return|return
name|DS_DISPLAY
return|;
case|case
literal|'c'
case|:
name|erase_eol
argument_list|()
expr_stmt|;
comment|/* erase the prompt */
if|if
condition|(
operator|(
name|ch
operator|=
name|ask_catchup
argument_list|()
operator|)
operator|==
literal|'y'
operator|||
name|ch
operator|==
literal|'u'
condition|)
block|{
name|count_subjects
argument_list|(
name|CS_UNSELECT
argument_list|)
expr_stmt|;
if|if
condition|(
name|ch
operator|!=
literal|'u'
operator|&&
name|article_count
condition|)
block|{
name|sel_page_sp
operator|=
name|Nullsubj
expr_stmt|;
name|sel_page_app
operator|=
name|Null
argument_list|(
name|ARTICLE
operator|*
operator|*
argument_list|)
expr_stmt|;
name|init_pages
argument_list|()
expr_stmt|;
return|return
name|DS_DISPLAY
return|;
block|}
name|sel_ret
operator|=
literal|'Z'
expr_stmt|;
return|return
name|DS_QUIT
return|;
block|}
if|if
condition|(
name|ch
operator|!=
literal|'N'
condition|)
return|return
name|DS_DISPLAY
return|;
if|if
condition|(
name|can_home
condition|)
block|{
name|carriage_return
argument_list|()
expr_stmt|;
name|erase_eol
argument_list|()
expr_stmt|;
block|}
return|return
name|DS_ASK
return|;
case|case
literal|'h'
case|:
case|case
literal|'?'
case|:
name|putchar
argument_list|(
literal|'\n'
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|ch
operator|=
name|help_select
argument_list|()
operator|)
operator|||
operator|(
name|ch
operator|=
name|pause_getcmd
argument_list|()
operator|)
condition|)
goto|goto
name|got_cmd
goto|;
return|return
name|DS_DISPLAY
return|;
default|default:
name|sprintf
argument_list|(
name|buf
argument_list|,
literal|"Type ? for help."
argument_list|)
expr_stmt|;
name|settle_down
argument_list|()
expr_stmt|;
if|if
condition|(
name|clean_screen
condition|)
return|return
name|DS_STATUS
return|;
name|printf
argument_list|(
literal|"\n%s\n"
argument_list|,
name|buf
argument_list|)
expr_stmt|;
goto|goto
name|extend_done
goto|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|empty_complaint
parameter_list|()
block|{
name|clear_on_stop
operator|=
name|FALSE
expr_stmt|;
name|putchar
argument_list|(
literal|'\n'
argument_list|)
expr_stmt|;
if|if
condition|(
name|sel_rereading
condition|)
block|{
ifdef|#
directive|ifdef
name|VERBOSE
name|IF
argument_list|(
argument|verbose
argument_list|)
name|fputs
argument_list|(
literal|"\nNo articles to set unread.\n"
argument_list|,
name|stdout
argument_list|)
expr_stmt|;
name|ELSE
endif|#
directive|endif
ifdef|#
directive|ifdef
name|TERSE
name|fputs
argument_list|(
literal|"\nNo articles.\n"
argument_list|,
name|stdout
argument_list|)
name|FLUSH
decl_stmt|;
endif|#
directive|endif
name|sel_rereading
operator|=
literal|0
expr_stmt|;
name|sel_mask
operator|=
name|AF_SEL
expr_stmt|;
block|}
else|else
block|{
ifdef|#
directive|ifdef
name|VERBOSE
name|IF
argument_list|(
argument|verbose
argument_list|)
name|fputs
argument_list|(
literal|"\nNo unread articles to select."
argument_list|,
name|stdout
argument_list|)
expr_stmt|;
name|ELSE
endif|#
directive|endif
ifdef|#
directive|ifdef
name|TERSE
name|fputs
argument_list|(
literal|"\nNo unread articles."
argument_list|,
name|stdout
argument_list|)
decl_stmt|;
endif|#
directive|endif
name|putchar
argument_list|(
literal|'\n'
argument_list|)
expr_stmt|;
comment|/* let "them" FLUSH */
block|}
name|selected_only
operator|=
name|FALSE
expr_stmt|;
name|art
operator|=
name|curr_art
expr_stmt|;
name|artp
operator|=
name|curr_artp
expr_stmt|;
block|}
end_function

end_unit


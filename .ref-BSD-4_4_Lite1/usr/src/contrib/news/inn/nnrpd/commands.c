begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  $Revision: 1.14 $ ** **  Miscellaneous commands. */
end_comment

begin_include
include|#
directive|include
file|"nnrpd.h"
end_include

begin_include
include|#
directive|include
file|<time.h>
end_include

begin_typedef
typedef|typedef
struct|struct
name|_LISTINFO
block|{
name|STRING
name|File
decl_stmt|;
name|STRING
name|Items
decl_stmt|;
name|STRING
name|Format
decl_stmt|;
block|}
name|LISTINFO
typedef|;
end_typedef

begin_decl_stmt
name|STATIC
name|LISTINFO
name|INFOactive
init|=
block|{
name|ACTIVE
block|,
literal|"active newsgroups"
block|,
literal|"Newsgroups in form \"group high low flags\""
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|STATIC
name|LISTINFO
name|INFOactivetimes
init|=
block|{
name|ACTIVETIMES
block|,
literal|"creation times"
block|,
literal|"Group creations in form \"name time who\""
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|STATIC
name|LISTINFO
name|INFOdistribs
init|=
block|{
name|_PATH_NNRPDIST
block|,
literal|"newsgroup distributions"
block|,
literal|"Distributions in form \"area description\""
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|STATIC
name|LISTINFO
name|INFOdistribpats
init|=
block|{
name|_PATH_DISTPATS
block|,
literal|"distribution patterns"
block|,
literal|"Default distributions in form \"weight:pattern:value\""
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|STATIC
name|LISTINFO
name|INFOgroups
init|=
block|{
name|NEWSGROUPS
block|,
literal|"newsgroup descriptions"
block|,
literal|"Descriptions in form \"group description\""
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|STATIC
name|LISTINFO
name|INFOschema
init|=
block|{
name|_PATH_SCHEMA
block|,
literal|"overview schema"
block|,
literal|"Order of fields in overview database"
block|}
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* ARGSUSED */
end_comment

begin_function
name|FUNCTYPE
name|CMDauthinfo
parameter_list|(
name|ac
parameter_list|,
name|av
parameter_list|)
name|int
name|ac
decl_stmt|;
name|char
modifier|*
name|av
index|[]
decl_stmt|;
block|{
specifier|static
name|char
name|User
index|[
literal|30
index|]
decl_stmt|;
specifier|static
name|char
name|Password
index|[
literal|30
index|]
decl_stmt|;
name|char
name|accesslist
index|[
name|BIG_BUFFER
index|]
decl_stmt|;
if|if
condition|(
name|caseEQ
argument_list|(
name|av
index|[
literal|1
index|]
argument_list|,
literal|"user"
argument_list|)
condition|)
block|{
operator|(
name|void
operator|)
name|strncpy
argument_list|(
name|User
argument_list|,
name|av
index|[
literal|2
index|]
argument_list|,
sizeof|sizeof
name|User
operator|-
literal|1
argument_list|)
expr_stmt|;
name|User
index|[
sizeof|sizeof
name|User
operator|-
literal|1
index|]
operator|=
literal|0
expr_stmt|;
name|Reply
argument_list|(
literal|"%d PASS required\r\n"
argument_list|,
name|NNTP_AUTH_NEXT_VAL
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
operator|!
name|caseEQ
argument_list|(
name|av
index|[
literal|1
index|]
argument_list|,
literal|"pass"
argument_list|)
condition|)
block|{
name|Reply
argument_list|(
literal|"%d bad authinfo param\r\n"
argument_list|,
name|NNTP_BAD_COMMAND_VAL
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|User
index|[
literal|0
index|]
operator|==
literal|'\0'
condition|)
block|{
name|Reply
argument_list|(
literal|"%d USER required\r\n"
argument_list|,
name|NNTP_AUTH_REJECT_VAL
argument_list|)
expr_stmt|;
return|return;
block|}
operator|(
name|void
operator|)
name|strncpy
argument_list|(
name|Password
argument_list|,
name|av
index|[
literal|2
index|]
argument_list|,
sizeof|sizeof
name|Password
operator|-
literal|1
argument_list|)
expr_stmt|;
name|Password
index|[
sizeof|sizeof
name|Password
operator|-
literal|1
index|]
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|EQ
argument_list|(
name|User
argument_list|,
name|PERMuser
argument_list|)
operator|&&
name|EQ
argument_list|(
name|Password
argument_list|,
name|PERMpass
argument_list|)
condition|)
block|{
name|syslog
argument_list|(
name|L_NOTICE
argument_list|,
literal|"%s user %s"
argument_list|,
name|ClientHost
argument_list|,
name|User
argument_list|)
expr_stmt|;
name|Reply
argument_list|(
literal|"%d Ok\r\n"
argument_list|,
name|NNTP_AUTH_OK_VAL
argument_list|)
expr_stmt|;
name|PERMneedauth
operator|=
name|FALSE
expr_stmt|;
name|PERMauthorized
operator|=
name|TRUE
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|PERMinfile
argument_list|(
operator|(
name|char
operator|*
operator|)
name|NULL
argument_list|,
operator|(
name|char
operator|*
operator|)
name|NULL
argument_list|,
name|User
argument_list|,
name|Password
argument_list|,
name|accesslist
argument_list|)
condition|)
block|{
name|PERMspecified
operator|=
name|NGgetlist
argument_list|(
operator|&
name|PERMlist
argument_list|,
name|accesslist
argument_list|)
expr_stmt|;
name|syslog
argument_list|(
name|L_NOTICE
argument_list|,
literal|"%s user %s"
argument_list|,
name|ClientHost
argument_list|,
name|User
argument_list|)
expr_stmt|;
name|Reply
argument_list|(
literal|"%d Ok\r\n"
argument_list|,
name|NNTP_AUTH_OK_VAL
argument_list|)
expr_stmt|;
name|PERMneedauth
operator|=
name|FALSE
expr_stmt|;
name|PERMauthorized
operator|=
name|TRUE
expr_stmt|;
return|return;
block|}
name|syslog
argument_list|(
name|L_FATAL
argument_list|,
literal|"%s bad_auth"
argument_list|,
name|ClientHost
argument_list|)
expr_stmt|;
name|Reply
argument_list|(
literal|"%d Authentication error\r\n"
argument_list|,
name|NNTP_ACCESS_VAL
argument_list|)
expr_stmt|;
name|ExitWithStats
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* **  The "DATE" command.  Part of NNTPv2. */
end_comment

begin_comment
comment|/* ARGSUSED0 */
end_comment

begin_function
name|FUNCTYPE
name|CMDdate
parameter_list|(
name|ac
parameter_list|,
name|av
parameter_list|)
name|int
name|ac
decl_stmt|;
name|char
modifier|*
name|av
index|[]
decl_stmt|;
block|{
name|TIMEINFO
name|t
decl_stmt|;
name|struct
name|tm
modifier|*
name|gmt
decl_stmt|;
if|if
condition|(
name|GetTimeInfo
argument_list|(
operator|&
name|t
argument_list|)
operator|<
literal|0
operator|||
operator|(
name|gmt
operator|=
name|gmtime
argument_list|(
operator|&
name|t
operator|.
name|time
argument_list|)
operator|)
operator|==
name|NULL
condition|)
block|{
name|Reply
argument_list|(
literal|"%d Can't get time, %s\r\n"
argument_list|,
name|NNTP_TEMPERR_VAL
argument_list|,
name|strerror
argument_list|(
name|errno
argument_list|)
argument_list|)
expr_stmt|;
return|return;
block|}
name|Reply
argument_list|(
literal|"%d %04.4d%02.2d%02.2d%02.2d%02.2d%02.2d\r\n"
argument_list|,
name|NNTP_DATE_FOLLOWS_VAL
argument_list|,
name|gmt
operator|->
name|tm_year
operator|+
literal|1900
argument_list|,
name|gmt
operator|->
name|tm_mon
operator|+
literal|1
argument_list|,
name|gmt
operator|->
name|tm_mday
argument_list|,
name|gmt
operator|->
name|tm_hour
argument_list|,
name|gmt
operator|->
name|tm_min
argument_list|,
name|gmt
operator|->
name|tm_sec
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* **  List active newsgroups, newsgroup descriptions, and distributions. */
end_comment

begin_comment
comment|/* ARGSUSED0 */
end_comment

begin_function
name|FUNCTYPE
name|CMDlist
parameter_list|(
name|ac
parameter_list|,
name|av
parameter_list|)
name|int
name|ac
decl_stmt|;
name|char
modifier|*
name|av
index|[]
decl_stmt|;
block|{
specifier|register
name|QIOSTATE
modifier|*
name|qp
decl_stmt|;
specifier|register
name|char
modifier|*
name|p
decl_stmt|;
specifier|register
name|char
modifier|*
name|save
decl_stmt|;
name|char
modifier|*
name|grplist
index|[
literal|2
index|]
decl_stmt|;
name|LISTINFO
modifier|*
name|lp
decl_stmt|;
name|p
operator|=
name|av
index|[
literal|1
index|]
expr_stmt|;
if|if
condition|(
name|p
operator|==
name|NULL
operator|||
name|caseEQ
argument_list|(
name|p
argument_list|,
literal|"active"
argument_list|)
condition|)
block|{
if|if
condition|(
operator|!
name|GetGroupList
argument_list|()
condition|)
block|{
name|syslog
argument_list|(
name|L_NOTICE
argument_list|,
literal|"%s cant getgroupslist for list %m"
argument_list|,
name|ClientHost
argument_list|)
expr_stmt|;
name|Reply
argument_list|(
literal|"%d Group update failed. Try later.\r\n"
argument_list|,
name|NNTP_TEMPERR_VAL
argument_list|)
expr_stmt|;
name|ExitWithStats
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
name|lp
operator|=
operator|&
name|INFOactive
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|caseEQ
argument_list|(
name|p
argument_list|,
literal|"active.times"
argument_list|)
condition|)
name|lp
operator|=
operator|&
name|INFOactivetimes
expr_stmt|;
elseif|else
if|if
condition|(
name|caseEQ
argument_list|(
name|p
argument_list|,
literal|"distributions"
argument_list|)
condition|)
name|lp
operator|=
operator|&
name|INFOdistribs
expr_stmt|;
elseif|else
if|if
condition|(
name|caseEQ
argument_list|(
name|p
argument_list|,
literal|"distrib.pats"
argument_list|)
condition|)
name|lp
operator|=
operator|&
name|INFOdistribpats
expr_stmt|;
elseif|else
if|if
condition|(
name|caseEQ
argument_list|(
name|p
argument_list|,
literal|"newsgroups"
argument_list|)
condition|)
name|lp
operator|=
operator|&
name|INFOgroups
expr_stmt|;
elseif|else
if|if
condition|(
name|caseEQ
argument_list|(
name|p
argument_list|,
literal|"overview.fmt"
argument_list|)
condition|)
name|lp
operator|=
operator|&
name|INFOschema
expr_stmt|;
else|else
block|{
name|Reply
argument_list|(
literal|"%s\r\n"
argument_list|,
name|NNTP_SYNTAX_USE
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
operator|(
name|qp
operator|=
name|QIOopen
argument_list|(
name|lp
operator|->
name|File
argument_list|,
name|QIO_BUFFER
argument_list|)
operator|)
operator|==
name|NULL
condition|)
block|{
name|syslog
argument_list|(
name|L_ERROR
argument_list|,
literal|"%s cant fopen %s %m"
argument_list|,
name|ClientHost
argument_list|,
name|lp
operator|->
name|File
argument_list|)
expr_stmt|;
name|Reply
argument_list|(
literal|"%d No list of %s available.\r\n"
argument_list|,
name|NNTP_TEMPERR_VAL
argument_list|,
name|lp
operator|->
name|Items
argument_list|)
expr_stmt|;
return|return;
block|}
name|Reply
argument_list|(
literal|"%d %s.\r\n"
argument_list|,
name|NNTP_LIST_FOLLOWS_VAL
argument_list|,
name|lp
operator|->
name|Format
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|PERMspecified
operator|&&
operator|!
name|PERMdefault
condition|)
block|{
comment|/* Optmize for unlikely case of no permissions and FALSE default. */
operator|(
name|void
operator|)
name|QIOclose
argument_list|(
name|qp
argument_list|)
expr_stmt|;
name|Printf
argument_list|(
literal|".\r\n"
argument_list|)
expr_stmt|;
block|}
comment|/* Set up group list terminator. */
name|grplist
index|[
literal|1
index|]
operator|=
name|NULL
expr_stmt|;
comment|/* Read lines, ignore long ones. */
while|while
condition|(
operator|(
name|p
operator|=
name|QIOread
argument_list|(
name|qp
argument_list|)
operator|)
operator|!=
name|NULL
condition|)
block|{
if|if
condition|(
name|lp
operator|==
operator|&
name|INFOdistribs
operator|||
name|lp
operator|==
operator|&
name|INFOdistribpats
condition|)
block|{
name|Printf
argument_list|(
literal|"%s\r\n"
argument_list|,
name|p
argument_list|)
expr_stmt|;
continue|continue;
block|}
if|if
condition|(
name|lp
operator|==
operator|&
name|INFOschema
condition|)
block|{
if|if
condition|(
operator|*
name|p
operator|!=
literal|'\0'
operator|&&
operator|*
name|p
operator|!=
literal|'#'
condition|)
name|Printf
argument_list|(
literal|"%s\r\n"
argument_list|,
name|p
argument_list|)
expr_stmt|;
continue|continue;
block|}
if|if
condition|(
operator|(
name|save
operator|=
name|strchr
argument_list|(
name|p
argument_list|,
literal|' '
argument_list|)
operator|)
operator|!=
name|NULL
condition|)
operator|*
name|save
operator|=
literal|'\0'
expr_stmt|;
if|if
condition|(
name|PERMspecified
condition|)
block|{
name|grplist
index|[
literal|0
index|]
operator|=
name|p
expr_stmt|;
if|if
condition|(
operator|!
name|PERMmatch
argument_list|(
name|PERMdefault
argument_list|,
name|PERMlist
argument_list|,
name|grplist
argument_list|)
condition|)
continue|continue;
block|}
if|if
condition|(
name|save
operator|!=
name|NULL
condition|)
operator|*
name|save
operator|=
literal|' '
expr_stmt|;
name|Printf
argument_list|(
literal|"%s\r\n"
argument_list|,
name|p
argument_list|)
expr_stmt|;
block|}
name|QIOclose
argument_list|(
name|qp
argument_list|)
expr_stmt|;
name|Printf
argument_list|(
literal|".\r\n"
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* **  Handle the "mode" command. */
end_comment

begin_comment
comment|/* ARGSUSED */
end_comment

begin_function
name|FUNCTYPE
name|CMDmode
parameter_list|(
name|ac
parameter_list|,
name|av
parameter_list|)
name|int
name|ac
decl_stmt|;
name|char
modifier|*
name|av
index|[]
decl_stmt|;
block|{
if|if
condition|(
name|caseEQ
argument_list|(
name|av
index|[
literal|1
index|]
argument_list|,
literal|"reader"
argument_list|)
condition|)
name|Reply
argument_list|(
literal|"%d %s InterNetNews NNRP server %s ready (%s).\r\n"
argument_list|,
name|PERMcanpost
condition|?
name|NNTP_POSTOK_VAL
else|:
name|NNTP_NOPOSTOK_VAL
argument_list|,
name|MyHostName
argument_list|,
name|INNVersion
argument_list|()
argument_list|,
name|PERMcanpost
condition|?
literal|"posting ok"
else|:
literal|"no posting"
argument_list|)
expr_stmt|;
else|else
name|Reply
argument_list|(
literal|"%d What?\r\n"
argument_list|,
name|NNTP_BAD_COMMAND_VAL
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* **  Display new newsgroups since a given date and time for specified **<distributions>. */
end_comment

begin_function
name|FUNCTYPE
name|CMDnewgroups
parameter_list|(
name|ac
parameter_list|,
name|av
parameter_list|)
name|int
name|ac
decl_stmt|;
name|char
modifier|*
name|av
index|[]
decl_stmt|;
block|{
specifier|static
name|char
name|USAGE
index|[]
init|=
literal|"NEWGROUPS yymmdd hhmmss [\"GMT\"] [<distributions>]"
decl_stmt|;
specifier|static
name|char
modifier|*
modifier|*
name|distlist
decl_stmt|;
specifier|register
name|char
modifier|*
name|p
decl_stmt|;
specifier|register
name|char
modifier|*
name|q
decl_stmt|;
specifier|register
name|char
modifier|*
modifier|*
name|dp
decl_stmt|;
specifier|register
name|QIOSTATE
modifier|*
name|qp
decl_stmt|;
specifier|register
name|GROUPENTRY
modifier|*
name|gp
decl_stmt|;
name|BOOL
name|All
decl_stmt|;
name|long
name|date
decl_stmt|;
name|char
modifier|*
name|grplist
index|[
literal|2
index|]
decl_stmt|;
comment|/* Parse the date. */
name|date
operator|=
name|NNTPtoGMT
argument_list|(
name|av
index|[
literal|1
index|]
argument_list|,
name|av
index|[
literal|2
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|date
operator|<
literal|0
condition|)
block|{
name|Reply
argument_list|(
literal|"%d Usage: %s\r\n"
argument_list|,
name|NNTP_SYNTAX_VAL
argument_list|,
name|USAGE
argument_list|)
expr_stmt|;
return|return;
block|}
name|ac
operator|-=
literal|3
expr_stmt|;
name|av
operator|+=
literal|3
expr_stmt|;
if|if
condition|(
name|ac
operator|>
literal|0
operator|&&
name|caseEQ
argument_list|(
operator|*
name|av
argument_list|,
literal|"GMT"
argument_list|)
condition|)
block|{
name|av
operator|++
expr_stmt|;
name|ac
operator|--
expr_stmt|;
block|}
else|else
name|date
operator|=
name|LOCALtoGMT
argument_list|(
name|date
argument_list|)
expr_stmt|;
if|if
condition|(
name|ac
operator|==
literal|0
condition|)
name|All
operator|=
name|TRUE
expr_stmt|;
else|else
block|{
if|if
condition|(
operator|!
name|ParseDistlist
argument_list|(
operator|&
name|distlist
argument_list|,
operator|*
name|av
argument_list|)
operator|<
literal|0
condition|)
block|{
name|Reply
argument_list|(
literal|"%d Bad distribution list %s:\r\n"
argument_list|,
name|NNTP_SYNTAX_VAL
argument_list|,
operator|*
name|av
argument_list|)
expr_stmt|;
return|return;
block|}
name|All
operator|=
name|FALSE
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|GetGroupList
argument_list|()
condition|)
block|{
name|syslog
argument_list|(
name|L_NOTICE
argument_list|,
literal|"%s cant getgroupslist for list %m"
argument_list|,
name|ClientHost
argument_list|)
expr_stmt|;
name|Reply
argument_list|(
literal|"%d Group update failed. Try later.\r\n"
argument_list|,
name|NNTP_TEMPERR_VAL
argument_list|)
expr_stmt|;
name|ExitWithStats
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|qp
operator|=
name|QIOopen
argument_list|(
name|ACTIVETIMES
argument_list|,
name|QIO_BUFFER
argument_list|)
operator|)
operator|==
name|NULL
condition|)
block|{
name|syslog
argument_list|(
name|L_ERROR
argument_list|,
literal|"%s cant fopen %s %m"
argument_list|,
name|ClientHost
argument_list|,
name|ACTIVETIMES
argument_list|)
expr_stmt|;
name|Reply
argument_list|(
literal|"%d Cannot open newsgroup date file.\r\n"
argument_list|,
name|NNTP_TEMPERR_VAL
argument_list|)
expr_stmt|;
return|return;
block|}
name|Reply
argument_list|(
literal|"%d New newsgroups follow.\r\n"
argument_list|,
name|NNTP_NEWGROUPS_FOLLOWS_VAL
argument_list|)
expr_stmt|;
comment|/* Read the file, ignoring long lines. */
while|while
condition|(
operator|(
name|p
operator|=
name|QIOread
argument_list|(
name|qp
argument_list|)
operator|)
operator|!=
name|NULL
condition|)
block|{
if|if
condition|(
operator|(
name|q
operator|=
name|strchr
argument_list|(
name|p
argument_list|,
literal|' '
argument_list|)
operator|)
operator|==
name|NULL
condition|)
continue|continue;
operator|*
name|q
operator|++
operator|=
literal|'\0'
expr_stmt|;
if|if
condition|(
name|atol
argument_list|(
name|q
argument_list|)
operator|<
name|date
operator|||
operator|(
name|gp
operator|=
name|GRPfind
argument_list|(
name|p
argument_list|)
operator|)
operator|==
name|NULL
condition|)
continue|continue;
if|if
condition|(
name|PERMspecified
condition|)
block|{
name|grplist
index|[
literal|0
index|]
operator|=
name|p
expr_stmt|;
name|grplist
index|[
literal|1
index|]
operator|=
name|NULL
expr_stmt|;
if|if
condition|(
operator|!
name|PERMmatch
argument_list|(
name|PERMdefault
argument_list|,
name|PERMlist
argument_list|,
name|grplist
argument_list|)
condition|)
continue|continue;
block|}
elseif|else
if|if
condition|(
operator|!
name|PERMdefault
condition|)
continue|continue;
if|if
condition|(
operator|!
name|All
condition|)
block|{
if|if
condition|(
operator|(
name|q
operator|=
name|strchr
argument_list|(
name|p
argument_list|,
literal|'.'
argument_list|)
operator|)
operator|==
name|NULL
condition|)
continue|continue;
for|for
control|(
operator|*
name|q
operator|=
literal|'\0'
operator|,
name|dp
operator|=
name|distlist
init|;
operator|*
name|dp
condition|;
name|dp
operator|++
control|)
if|if
condition|(
name|EQ
argument_list|(
name|p
argument_list|,
operator|*
name|dp
argument_list|)
condition|)
block|{
operator|*
name|q
operator|=
literal|'.'
expr_stmt|;
break|break;
block|}
if|if
condition|(
operator|*
name|dp
operator|==
name|NULL
condition|)
continue|continue;
block|}
name|Printf
argument_list|(
literal|"%s %ld %ld %c%s\r\n"
argument_list|,
name|p
argument_list|,
operator|(
name|long
operator|)
name|gp
operator|->
name|High
argument_list|,
operator|(
name|long
operator|)
name|gp
operator|->
name|Low
argument_list|,
name|gp
operator|->
name|Flag
argument_list|,
name|gp
operator|->
name|Alias
condition|?
name|gp
operator|->
name|Alias
else|:
literal|""
argument_list|)
expr_stmt|;
block|}
name|QIOclose
argument_list|(
name|qp
argument_list|)
expr_stmt|;
name|Printf
argument_list|(
literal|".\r\n"
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* **  Post an article. */
end_comment

begin_comment
comment|/* ARGSUSED */
end_comment

begin_function
name|FUNCTYPE
name|CMDpost
parameter_list|(
name|ac
parameter_list|,
name|av
parameter_list|)
name|int
name|ac
decl_stmt|;
name|char
modifier|*
name|av
index|[]
decl_stmt|;
block|{
specifier|static
name|char
modifier|*
name|article
decl_stmt|;
specifier|static
name|int
name|size
decl_stmt|;
specifier|register
name|char
modifier|*
name|p
decl_stmt|;
specifier|register
name|char
modifier|*
name|end
decl_stmt|;
specifier|register
name|int
name|longline
decl_stmt|;
specifier|register
name|READTYPE
name|r
decl_stmt|;
name|int
name|i
decl_stmt|;
name|long
name|l
decl_stmt|;
name|STRING
name|response
decl_stmt|;
name|char
name|idbuff
index|[
name|SMBUF
index|]
decl_stmt|;
if|if
condition|(
operator|!
name|PERMcanpost
condition|)
block|{
name|syslog
argument_list|(
name|L_NOTICE
argument_list|,
literal|"%s noperm post without permission"
argument_list|,
name|ClientHost
argument_list|)
expr_stmt|;
name|Reply
argument_list|(
literal|"%s\r\n"
argument_list|,
name|NNTP_CANTPOST
argument_list|)
expr_stmt|;
return|return;
block|}
comment|/* Start at beginning of buffer. */
if|if
condition|(
name|article
operator|==
name|NULL
condition|)
block|{
name|size
operator|=
literal|4096
expr_stmt|;
name|article
operator|=
name|NEW
argument_list|(
name|char
argument_list|,
name|size
argument_list|)
expr_stmt|;
block|}
name|p
operator|=
name|article
expr_stmt|;
name|end
operator|=
operator|&
name|article
index|[
name|size
index|]
expr_stmt|;
name|Reply
argument_list|(
literal|"%d Ok\r\n"
argument_list|,
name|NNTP_START_POST_VAL
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|fflush
argument_list|(
name|stdout
argument_list|)
expr_stmt|;
for|for
control|(
name|l
operator|=
literal|0
operator|,
name|longline
operator|=
literal|0
init|;
condition|;
name|l
operator|++
control|)
block|{
comment|/* Need more room? */
if|if
condition|(
name|end
operator|-
name|p
operator|<
name|ART_LINE_MALLOC
condition|)
block|{
name|i
operator|=
name|p
operator|-
name|article
expr_stmt|;
name|size
operator|+=
name|ART_LINE_MALLOC
expr_stmt|;
name|RENEW
argument_list|(
name|article
argument_list|,
name|char
argument_list|,
name|size
argument_list|)
expr_stmt|;
name|end
operator|=
operator|&
name|article
index|[
name|size
index|]
expr_stmt|;
name|p
operator|=
name|i
operator|+
name|article
expr_stmt|;
block|}
comment|/* Read line, process bad cases. */
switch|switch
condition|(
name|r
operator|=
name|READline
argument_list|(
name|p
argument_list|,
name|ART_LINE_LENGTH
argument_list|,
name|DEFAULT_TIMEOUT
argument_list|)
condition|)
block|{
default|default:
name|syslog
argument_list|(
name|L_ERROR
argument_list|,
literal|"%s internal %d in post"
argument_list|,
name|ClientHost
argument_list|,
name|r
argument_list|)
expr_stmt|;
comment|/* FALLTHROUGH */
case|case
name|RTtimeout
case|:
name|syslog
argument_list|(
name|L_ERROR
argument_list|,
literal|"%s timeout in post"
argument_list|,
name|ClientHost
argument_list|)
expr_stmt|;
name|Printf
argument_list|(
literal|"%d timeout after %d seconds, closing connection\r\n"
argument_list|,
name|NNTP_TEMPERR_VAL
argument_list|,
name|DEFAULT_TIMEOUT
argument_list|)
expr_stmt|;
name|ExitWithStats
argument_list|(
literal|1
argument_list|)
expr_stmt|;
comment|/* NOTREACHED */
case|case
name|RTeof
case|:
name|syslog
argument_list|(
name|L_ERROR
argument_list|,
literal|"%s eof in post"
argument_list|,
name|ClientHost
argument_list|)
expr_stmt|;
name|ExitWithStats
argument_list|(
literal|1
argument_list|)
expr_stmt|;
comment|/* NOTREACHED */
case|case
name|RTlong
case|:
if|if
condition|(
name|longline
operator|==
literal|0
condition|)
name|longline
operator|=
name|l
operator|+
literal|1
expr_stmt|;
continue|continue;
case|case
name|RTok
case|:
break|break;
block|}
comment|/* Process normal text. */
if|if
condition|(
operator|*
name|p
operator|!=
literal|'.'
condition|)
block|{
name|p
operator|+=
name|strlen
argument_list|(
name|p
argument_list|)
expr_stmt|;
operator|*
name|p
operator|++
operator|=
literal|'\n'
expr_stmt|;
operator|*
name|p
operator|=
literal|'\0'
expr_stmt|;
continue|continue;
block|}
comment|/* Got a leading period; see if it's the terminator. */
if|if
condition|(
name|p
index|[
literal|1
index|]
operator|==
literal|'\0'
condition|)
block|{
operator|*
name|p
operator|=
literal|'\0'
expr_stmt|;
break|break;
block|}
comment|/* "Arnold, please copy down over the period for me." */
while|while
condition|(
operator|(
name|p
index|[
literal|0
index|]
operator|=
name|p
index|[
literal|1
index|]
operator|)
operator|!=
literal|'\0'
condition|)
name|p
operator|++
expr_stmt|;
operator|*
name|p
operator|++
operator|=
literal|'\n'
expr_stmt|;
operator|*
name|p
operator|=
literal|'\0'
expr_stmt|;
block|}
if|if
condition|(
name|longline
condition|)
block|{
name|syslog
argument_list|(
name|L_NOTICE
argument_list|,
literal|"%s toolong in post"
argument_list|,
name|ClientHost
argument_list|)
expr_stmt|;
name|Printf
argument_list|(
literal|"%d Line %d too long\r\n"
argument_list|,
name|NNTP_POSTFAIL_VAL
argument_list|,
name|longline
argument_list|)
expr_stmt|;
name|POSTrejected
operator|++
expr_stmt|;
return|return;
block|}
comment|/* Send the article to the server. */
name|response
operator|=
name|ARTpost
argument_list|(
name|article
argument_list|,
name|idbuff
argument_list|)
expr_stmt|;
if|if
condition|(
name|response
operator|==
name|NULL
condition|)
block|{
name|syslog
argument_list|(
name|L_NOTICE
argument_list|,
literal|"%s post ok %s"
argument_list|,
name|ClientHost
argument_list|,
name|idbuff
argument_list|)
expr_stmt|;
name|Reply
argument_list|(
literal|"%s\r\n"
argument_list|,
name|NNTP_POSTEDOK
argument_list|)
expr_stmt|;
name|POSTreceived
operator|++
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
operator|(
name|p
operator|=
name|strchr
argument_list|(
name|response
argument_list|,
literal|'\r'
argument_list|)
operator|)
operator|!=
name|NULL
condition|)
operator|*
name|p
operator|=
literal|'\0'
expr_stmt|;
if|if
condition|(
operator|(
name|p
operator|=
name|strchr
argument_list|(
name|response
argument_list|,
literal|'\n'
argument_list|)
operator|)
operator|!=
name|NULL
condition|)
operator|*
name|p
operator|=
literal|'\0'
expr_stmt|;
name|syslog
argument_list|(
name|L_NOTICE
argument_list|,
literal|"%s post failed %s"
argument_list|,
name|ClientHost
argument_list|,
name|response
argument_list|)
expr_stmt|;
name|Reply
argument_list|(
literal|"%d %s\r\n"
argument_list|,
name|NNTP_POSTFAIL_VAL
argument_list|,
name|response
argument_list|)
expr_stmt|;
name|POSTrejected
operator|++
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/* **  The "xpath" command.  An uncommon extension. */
end_comment

begin_comment
comment|/* ARGSUSED */
end_comment

begin_function
name|FUNCTYPE
name|CMDxpath
parameter_list|(
name|ac
parameter_list|,
name|av
parameter_list|)
name|int
name|ac
decl_stmt|;
name|char
modifier|*
name|av
index|[]
decl_stmt|;
block|{
name|char
modifier|*
name|p
decl_stmt|;
if|if
condition|(
operator|(
name|p
operator|=
name|HISgetent
argument_list|(
name|av
index|[
literal|1
index|]
argument_list|,
name|TRUE
argument_list|)
operator|)
operator|==
name|NULL
condition|)
name|Reply
argument_list|(
literal|"%d Don't have it\r\n"
argument_list|,
name|NNTP_DONTHAVEIT_VAL
argument_list|)
expr_stmt|;
else|else
name|Reply
argument_list|(
literal|"%d %s\r\n"
argument_list|,
name|NNTP_NOTHING_FOLLOWS_VAL
argument_list|,
name|p
argument_list|)
expr_stmt|;
block|}
end_function

end_unit


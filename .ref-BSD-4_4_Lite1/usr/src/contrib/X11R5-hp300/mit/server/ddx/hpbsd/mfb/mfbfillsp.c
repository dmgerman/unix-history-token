begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/* Combined Purdue/PurduePlus patches, level 2.0, 1/17/89 */
end_comment

begin_comment
comment|/*********************************************************** Copyright 1987 by Digital Equipment Corporation, Maynard, Massachusetts, and the Massachusetts Institute of Technology, Cambridge, Massachusetts.                          All Rights Reserved  Permission to use, copy, modify, and distribute this software and its  documentation for any purpose and without fee is hereby granted,  provided that the above copyright notice appear in all copies and that both that copyright notice and this permission notice appear in  supporting documentation, and that the names of Digital or MIT not be used in advertising or publicity pertaining to distribution of the software without specific, written prior permission.    DIGITAL DISCLAIMS ALL WARRANTIES WITH REGARD TO THIS SOFTWARE, INCLUDING ALL IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS, IN NO EVENT SHALL DIGITAL BE LIABLE FOR ANY SPECIAL, INDIRECT OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM LOSS OF USE, DATA OR PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE OR OTHER TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR PERFORMANCE OF THIS SOFTWARE.  ******************************************************************/
end_comment

begin_comment
comment|/* $XConsortium: mfbfillsp.c,v 5.7 90/05/15 18:38:15 keith Exp $ */
end_comment

begin_include
include|#
directive|include
file|"X.h"
end_include

begin_include
include|#
directive|include
file|"Xmd.h"
end_include

begin_include
include|#
directive|include
file|"gcstruct.h"
end_include

begin_include
include|#
directive|include
file|"window.h"
end_include

begin_include
include|#
directive|include
file|"pixmapstr.h"
end_include

begin_include
include|#
directive|include
file|"scrnintstr.h"
end_include

begin_include
include|#
directive|include
file|"windowstr.h"
end_include

begin_include
include|#
directive|include
file|"mfb.h"
end_include

begin_include
include|#
directive|include
file|"maskbits.h"
end_include

begin_include
include|#
directive|include
file|"mergerop.h"
end_include

begin_include
include|#
directive|include
file|"servermd.h"
end_include

begin_comment
comment|/* scanline filling for monochrome frame buffer    written by drewry, oct 1986     these routines all clip.  they assume that anything that has called them has already translated the points (i.e. pGC->miTranslate is non-zero, which is howit gets set in mfbCreateGC().)     the number of new scnalines created by clipping == MaxRectsPerBand * nSpans.      FillSolid is overloaded to be used for OpaqueStipple as well, if fgPixel == bgPixel.         FillTiled is overloaded to be used for OpaqueStipple, if fgPixel != bgPixel.  based on the fill style, it uses {RotatedPixmap, gc.alu} or {RotatedPixmap, PrivGC.ropOpStip} */
end_comment

begin_function
name|void
name|mfbBlackSolidFS
parameter_list|(
name|pDrawable
parameter_list|,
name|pGC
parameter_list|,
name|nInit
parameter_list|,
name|pptInit
parameter_list|,
name|pwidthInit
parameter_list|,
name|fSorted
parameter_list|)
name|DrawablePtr
name|pDrawable
decl_stmt|;
name|GCPtr
name|pGC
decl_stmt|;
name|int
name|nInit
decl_stmt|;
comment|/* number of spans to fill */
name|DDXPointPtr
name|pptInit
decl_stmt|;
comment|/* pointer to list of start points */
name|int
modifier|*
name|pwidthInit
decl_stmt|;
comment|/* pointer to list of n widths */
name|int
name|fSorted
decl_stmt|;
block|{
comment|/* next three parameters are post-clip */
name|int
name|n
decl_stmt|;
comment|/* number of spans to fill */
specifier|register
name|DDXPointPtr
name|ppt
decl_stmt|;
comment|/* pointer to list of start points */
specifier|register
name|int
modifier|*
name|pwidth
decl_stmt|;
comment|/* pointer to list of n widths */
name|int
modifier|*
name|addrlBase
decl_stmt|;
comment|/* pointer to start of bitmap */
name|int
name|nlwidth
decl_stmt|;
comment|/* width in longwords of bitmap */
specifier|register
name|int
modifier|*
name|addrl
decl_stmt|;
comment|/* pointer to current longword in bitmap */
specifier|register
name|int
name|nlmiddle
decl_stmt|;
specifier|register
name|int
name|startmask
decl_stmt|;
specifier|register
name|int
name|endmask
decl_stmt|;
name|int
modifier|*
name|pwidthFree
decl_stmt|;
comment|/* copies of the pointers to free */
name|DDXPointPtr
name|pptFree
decl_stmt|;
if|if
condition|(
operator|!
operator|(
name|pGC
operator|->
name|planemask
operator|&
literal|1
operator|)
condition|)
return|return;
name|n
operator|=
name|nInit
operator|*
name|miFindMaxBand
argument_list|(
operator|(
operator|(
name|mfbPrivGC
operator|*
operator|)
operator|(
name|pGC
operator|->
name|devPrivates
index|[
name|mfbGCPrivateIndex
index|]
operator|.
name|ptr
operator|)
operator|)
operator|->
name|pCompositeClip
argument_list|)
expr_stmt|;
name|pwidthFree
operator|=
operator|(
name|int
operator|*
operator|)
name|ALLOCATE_LOCAL
argument_list|(
name|n
operator|*
sizeof|sizeof
argument_list|(
name|int
argument_list|)
argument_list|)
expr_stmt|;
name|pptFree
operator|=
operator|(
name|DDXPointRec
operator|*
operator|)
name|ALLOCATE_LOCAL
argument_list|(
name|n
operator|*
sizeof|sizeof
argument_list|(
name|DDXPointRec
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|pptFree
operator|||
operator|!
name|pwidthFree
condition|)
block|{
if|if
condition|(
name|pptFree
condition|)
name|DEALLOCATE_LOCAL
argument_list|(
name|pptFree
argument_list|)
expr_stmt|;
if|if
condition|(
name|pwidthFree
condition|)
name|DEALLOCATE_LOCAL
argument_list|(
name|pwidthFree
argument_list|)
expr_stmt|;
return|return;
block|}
name|pwidth
operator|=
name|pwidthFree
expr_stmt|;
name|ppt
operator|=
name|pptFree
expr_stmt|;
name|n
operator|=
name|miClipSpans
argument_list|(
operator|(
operator|(
name|mfbPrivGC
operator|*
operator|)
operator|(
name|pGC
operator|->
name|devPrivates
index|[
name|mfbGCPrivateIndex
index|]
operator|.
name|ptr
operator|)
operator|)
operator|->
name|pCompositeClip
argument_list|,
name|pptInit
argument_list|,
name|pwidthInit
argument_list|,
name|nInit
argument_list|,
name|ppt
argument_list|,
name|pwidth
argument_list|,
name|fSorted
argument_list|)
expr_stmt|;
if|if
condition|(
name|pDrawable
operator|->
name|type
operator|==
name|DRAWABLE_WINDOW
condition|)
block|{
name|addrlBase
operator|=
operator|(
name|int
operator|*
operator|)
name|getPrivScreenPtr
argument_list|(
name|pDrawable
operator|->
name|pScreen
argument_list|)
operator|->
name|bits
expr_stmt|;
name|nlwidth
operator|=
operator|(
name|int
operator|)
name|getPrivScreenPtr
argument_list|(
name|pDrawable
operator|->
name|pScreen
argument_list|)
operator|->
name|stride
operator|>>
literal|2
expr_stmt|;
block|}
else|else
block|{
name|addrlBase
operator|=
operator|(
name|int
operator|*
operator|)
name|getPrivPixmapPtr
argument_list|(
name|pDrawable
argument_list|)
operator|->
name|bits
expr_stmt|;
name|nlwidth
operator|=
operator|(
name|int
operator|)
name|getPrivPixmapPtr
argument_list|(
name|pDrawable
argument_list|)
operator|->
name|stride
operator|>>
literal|2
expr_stmt|;
block|}
while|while
condition|(
name|n
operator|--
condition|)
block|{
name|addrl
operator|=
name|addrlBase
operator|+
operator|(
name|ppt
operator|->
name|y
operator|*
name|nlwidth
operator|)
operator|+
operator|(
name|ppt
operator|->
name|x
operator|>>
literal|5
operator|)
expr_stmt|;
if|if
condition|(
operator|*
name|pwidth
condition|)
block|{
if|if
condition|(
operator|(
operator|(
name|ppt
operator|->
name|x
operator|&
literal|0x1f
operator|)
operator|+
operator|*
name|pwidth
operator|)
operator|<
literal|32
condition|)
block|{
comment|/* all bits inside same longword */
name|maskpartialbits
argument_list|(
name|ppt
operator|->
name|x
argument_list|,
operator|*
name|pwidth
argument_list|,
name|startmask
argument_list|)
expr_stmt|;
operator|*
name|addrl
operator|&=
operator|~
name|startmask
expr_stmt|;
block|}
else|else
block|{
name|maskbits
argument_list|(
name|ppt
operator|->
name|x
argument_list|,
operator|*
name|pwidth
argument_list|,
name|startmask
argument_list|,
name|endmask
argument_list|,
name|nlmiddle
argument_list|)
expr_stmt|;
if|if
condition|(
name|startmask
condition|)
operator|*
name|addrl
operator|++
operator|&=
operator|~
name|startmask
expr_stmt|;
name|Duff
argument_list|(
name|nlmiddle
argument_list|,
operator|*
name|addrl
operator|++
operator|=
literal|0x0
argument_list|)
expr_stmt|;
if|if
condition|(
name|endmask
condition|)
operator|*
name|addrl
operator|&=
operator|~
name|endmask
expr_stmt|;
block|}
block|}
name|pwidth
operator|++
expr_stmt|;
name|ppt
operator|++
expr_stmt|;
block|}
name|DEALLOCATE_LOCAL
argument_list|(
name|pptFree
argument_list|)
expr_stmt|;
name|DEALLOCATE_LOCAL
argument_list|(
name|pwidthFree
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|mfbWhiteSolidFS
parameter_list|(
name|pDrawable
parameter_list|,
name|pGC
parameter_list|,
name|nInit
parameter_list|,
name|pptInit
parameter_list|,
name|pwidthInit
parameter_list|,
name|fSorted
parameter_list|)
name|DrawablePtr
name|pDrawable
decl_stmt|;
name|GCPtr
name|pGC
decl_stmt|;
name|int
name|nInit
decl_stmt|;
comment|/* number of spans to fill */
name|DDXPointPtr
name|pptInit
decl_stmt|;
comment|/* pointer to list of start points */
name|int
modifier|*
name|pwidthInit
decl_stmt|;
comment|/* pointer to list of n widths */
name|int
name|fSorted
decl_stmt|;
block|{
comment|/* next three parameters are post-clip */
name|int
name|n
decl_stmt|;
comment|/* number of spans to fill */
specifier|register
name|DDXPointPtr
name|ppt
decl_stmt|;
comment|/* pointer to list of start points */
specifier|register
name|int
modifier|*
name|pwidth
decl_stmt|;
comment|/* pointer to list of n widths */
name|int
modifier|*
name|addrlBase
decl_stmt|;
comment|/* pointer to start of bitmap */
name|int
name|nlwidth
decl_stmt|;
comment|/* width in longwords of bitmap */
specifier|register
name|int
modifier|*
name|addrl
decl_stmt|;
comment|/* pointer to current longword in bitmap */
specifier|register
name|int
name|nlmiddle
decl_stmt|;
specifier|register
name|int
name|startmask
decl_stmt|;
specifier|register
name|int
name|endmask
decl_stmt|;
name|int
modifier|*
name|pwidthFree
decl_stmt|;
comment|/* copies of the pointers to free */
name|DDXPointPtr
name|pptFree
decl_stmt|;
if|if
condition|(
operator|!
operator|(
name|pGC
operator|->
name|planemask
operator|&
literal|1
operator|)
condition|)
return|return;
name|n
operator|=
name|nInit
operator|*
name|miFindMaxBand
argument_list|(
operator|(
operator|(
name|mfbPrivGC
operator|*
operator|)
operator|(
name|pGC
operator|->
name|devPrivates
index|[
name|mfbGCPrivateIndex
index|]
operator|.
name|ptr
operator|)
operator|)
operator|->
name|pCompositeClip
argument_list|)
expr_stmt|;
name|pwidthFree
operator|=
operator|(
name|int
operator|*
operator|)
name|ALLOCATE_LOCAL
argument_list|(
name|n
operator|*
sizeof|sizeof
argument_list|(
name|int
argument_list|)
argument_list|)
expr_stmt|;
name|pptFree
operator|=
operator|(
name|DDXPointRec
operator|*
operator|)
name|ALLOCATE_LOCAL
argument_list|(
name|n
operator|*
sizeof|sizeof
argument_list|(
name|DDXPointRec
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|pptFree
operator|||
operator|!
name|pwidthFree
condition|)
block|{
if|if
condition|(
name|pptFree
condition|)
name|DEALLOCATE_LOCAL
argument_list|(
name|pptFree
argument_list|)
expr_stmt|;
if|if
condition|(
name|pwidthFree
condition|)
name|DEALLOCATE_LOCAL
argument_list|(
name|pwidthFree
argument_list|)
expr_stmt|;
return|return;
block|}
name|pwidth
operator|=
name|pwidthFree
expr_stmt|;
name|ppt
operator|=
name|pptFree
expr_stmt|;
name|n
operator|=
name|miClipSpans
argument_list|(
operator|(
operator|(
name|mfbPrivGC
operator|*
operator|)
operator|(
name|pGC
operator|->
name|devPrivates
index|[
name|mfbGCPrivateIndex
index|]
operator|.
name|ptr
operator|)
operator|)
operator|->
name|pCompositeClip
argument_list|,
name|pptInit
argument_list|,
name|pwidthInit
argument_list|,
name|nInit
argument_list|,
name|ppt
argument_list|,
name|pwidth
argument_list|,
name|fSorted
argument_list|)
expr_stmt|;
if|if
condition|(
name|pDrawable
operator|->
name|type
operator|==
name|DRAWABLE_WINDOW
condition|)
block|{
name|addrlBase
operator|=
operator|(
name|int
operator|*
operator|)
name|getPrivScreenPtr
argument_list|(
name|pDrawable
operator|->
name|pScreen
argument_list|)
operator|->
name|bits
expr_stmt|;
name|nlwidth
operator|=
operator|(
name|int
operator|)
name|getPrivScreenPtr
argument_list|(
name|pDrawable
operator|->
name|pScreen
argument_list|)
operator|->
name|stride
operator|>>
literal|2
expr_stmt|;
block|}
else|else
block|{
name|addrlBase
operator|=
operator|(
name|int
operator|*
operator|)
name|getPrivPixmapPtr
argument_list|(
name|pDrawable
argument_list|)
operator|->
name|bits
expr_stmt|;
name|nlwidth
operator|=
operator|(
name|int
operator|)
name|getPrivPixmapPtr
argument_list|(
name|pDrawable
argument_list|)
operator|->
name|stride
operator|>>
literal|2
expr_stmt|;
block|}
while|while
condition|(
name|n
operator|--
condition|)
block|{
name|addrl
operator|=
name|addrlBase
operator|+
operator|(
name|ppt
operator|->
name|y
operator|*
name|nlwidth
operator|)
operator|+
operator|(
name|ppt
operator|->
name|x
operator|>>
literal|5
operator|)
expr_stmt|;
if|if
condition|(
operator|*
name|pwidth
condition|)
block|{
if|if
condition|(
operator|(
operator|(
name|ppt
operator|->
name|x
operator|&
literal|0x1f
operator|)
operator|+
operator|*
name|pwidth
operator|)
operator|<
literal|32
condition|)
block|{
comment|/* all bits inside same longword */
name|maskpartialbits
argument_list|(
name|ppt
operator|->
name|x
argument_list|,
operator|*
name|pwidth
argument_list|,
name|startmask
argument_list|)
expr_stmt|;
operator|*
name|addrl
operator||=
name|startmask
expr_stmt|;
block|}
else|else
block|{
name|maskbits
argument_list|(
name|ppt
operator|->
name|x
argument_list|,
operator|*
name|pwidth
argument_list|,
name|startmask
argument_list|,
name|endmask
argument_list|,
name|nlmiddle
argument_list|)
expr_stmt|;
if|if
condition|(
name|startmask
condition|)
operator|*
name|addrl
operator|++
operator||=
name|startmask
expr_stmt|;
name|Duff
argument_list|(
name|nlmiddle
argument_list|,
operator|*
name|addrl
operator|++
operator|=
literal|0xffffffff
argument_list|)
expr_stmt|;
if|if
condition|(
name|endmask
condition|)
operator|*
name|addrl
operator||=
name|endmask
expr_stmt|;
block|}
block|}
name|pwidth
operator|++
expr_stmt|;
name|ppt
operator|++
expr_stmt|;
block|}
name|DEALLOCATE_LOCAL
argument_list|(
name|pptFree
argument_list|)
expr_stmt|;
name|DEALLOCATE_LOCAL
argument_list|(
name|pwidthFree
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|mfbInvertSolidFS
parameter_list|(
name|pDrawable
parameter_list|,
name|pGC
parameter_list|,
name|nInit
parameter_list|,
name|pptInit
parameter_list|,
name|pwidthInit
parameter_list|,
name|fSorted
parameter_list|)
name|DrawablePtr
name|pDrawable
decl_stmt|;
name|GCPtr
name|pGC
decl_stmt|;
name|int
name|nInit
decl_stmt|;
comment|/* number of spans to fill */
name|DDXPointPtr
name|pptInit
decl_stmt|;
comment|/* pointer to list of start points */
name|int
modifier|*
name|pwidthInit
decl_stmt|;
comment|/* pointer to list of n widths */
name|int
name|fSorted
decl_stmt|;
block|{
comment|/* next three parameters are post-clip */
name|int
name|n
decl_stmt|;
comment|/* number of spans to fill */
specifier|register
name|DDXPointPtr
name|ppt
decl_stmt|;
comment|/* pointer to list of start points */
specifier|register
name|int
modifier|*
name|pwidth
decl_stmt|;
comment|/* pointer to list of n widths */
name|int
modifier|*
name|addrlBase
decl_stmt|;
comment|/* pointer to start of bitmap */
name|int
name|nlwidth
decl_stmt|;
comment|/* width in longwords of bitmap */
specifier|register
name|int
modifier|*
name|addrl
decl_stmt|;
comment|/* pointer to current longword in bitmap */
specifier|register
name|int
name|nlmiddle
decl_stmt|;
specifier|register
name|int
name|startmask
decl_stmt|;
specifier|register
name|int
name|endmask
decl_stmt|;
name|int
modifier|*
name|pwidthFree
decl_stmt|;
comment|/* copies of the pointers to free */
name|DDXPointPtr
name|pptFree
decl_stmt|;
if|if
condition|(
operator|!
operator|(
name|pGC
operator|->
name|planemask
operator|&
literal|1
operator|)
condition|)
return|return;
name|n
operator|=
name|nInit
operator|*
name|miFindMaxBand
argument_list|(
operator|(
operator|(
name|mfbPrivGC
operator|*
operator|)
operator|(
name|pGC
operator|->
name|devPrivates
index|[
name|mfbGCPrivateIndex
index|]
operator|.
name|ptr
operator|)
operator|)
operator|->
name|pCompositeClip
argument_list|)
expr_stmt|;
name|pwidthFree
operator|=
operator|(
name|int
operator|*
operator|)
name|ALLOCATE_LOCAL
argument_list|(
name|n
operator|*
sizeof|sizeof
argument_list|(
name|int
argument_list|)
argument_list|)
expr_stmt|;
name|pptFree
operator|=
operator|(
name|DDXPointRec
operator|*
operator|)
name|ALLOCATE_LOCAL
argument_list|(
name|n
operator|*
sizeof|sizeof
argument_list|(
name|DDXPointRec
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|pptFree
operator|||
operator|!
name|pwidthFree
condition|)
block|{
if|if
condition|(
name|pptFree
condition|)
name|DEALLOCATE_LOCAL
argument_list|(
name|pptFree
argument_list|)
expr_stmt|;
if|if
condition|(
name|pwidthFree
condition|)
name|DEALLOCATE_LOCAL
argument_list|(
name|pwidthFree
argument_list|)
expr_stmt|;
return|return;
block|}
name|pwidth
operator|=
name|pwidthFree
expr_stmt|;
name|ppt
operator|=
name|pptFree
expr_stmt|;
name|n
operator|=
name|miClipSpans
argument_list|(
operator|(
operator|(
name|mfbPrivGC
operator|*
operator|)
operator|(
name|pGC
operator|->
name|devPrivates
index|[
name|mfbGCPrivateIndex
index|]
operator|.
name|ptr
operator|)
operator|)
operator|->
name|pCompositeClip
argument_list|,
name|pptInit
argument_list|,
name|pwidthInit
argument_list|,
name|nInit
argument_list|,
name|ppt
argument_list|,
name|pwidth
argument_list|,
name|fSorted
argument_list|)
expr_stmt|;
if|if
condition|(
name|pDrawable
operator|->
name|type
operator|==
name|DRAWABLE_WINDOW
condition|)
block|{
name|addrlBase
operator|=
operator|(
name|int
operator|*
operator|)
name|getPrivScreenPtr
argument_list|(
name|pDrawable
operator|->
name|pScreen
argument_list|)
operator|->
name|bits
expr_stmt|;
name|nlwidth
operator|=
operator|(
name|int
operator|)
name|getPrivScreenPtr
argument_list|(
name|pDrawable
operator|->
name|pScreen
argument_list|)
operator|->
name|stride
operator|>>
literal|2
expr_stmt|;
block|}
else|else
block|{
name|addrlBase
operator|=
operator|(
name|int
operator|*
operator|)
name|getPrivPixmapPtr
argument_list|(
name|pDrawable
argument_list|)
operator|->
name|bits
expr_stmt|;
name|nlwidth
operator|=
operator|(
name|int
operator|)
name|getPrivPixmapPtr
argument_list|(
name|pDrawable
argument_list|)
operator|->
name|stride
operator|>>
literal|2
expr_stmt|;
block|}
while|while
condition|(
name|n
operator|--
condition|)
block|{
name|addrl
operator|=
name|addrlBase
operator|+
operator|(
name|ppt
operator|->
name|y
operator|*
name|nlwidth
operator|)
operator|+
operator|(
name|ppt
operator|->
name|x
operator|>>
literal|5
operator|)
expr_stmt|;
if|if
condition|(
operator|*
name|pwidth
condition|)
block|{
if|if
condition|(
operator|(
operator|(
name|ppt
operator|->
name|x
operator|&
literal|0x1f
operator|)
operator|+
operator|*
name|pwidth
operator|)
operator|<
literal|32
condition|)
block|{
comment|/* all bits inside same longword */
name|maskpartialbits
argument_list|(
name|ppt
operator|->
name|x
argument_list|,
operator|*
name|pwidth
argument_list|,
name|startmask
argument_list|)
expr_stmt|;
operator|*
name|addrl
operator|^=
name|startmask
expr_stmt|;
block|}
else|else
block|{
name|maskbits
argument_list|(
name|ppt
operator|->
name|x
argument_list|,
operator|*
name|pwidth
argument_list|,
name|startmask
argument_list|,
name|endmask
argument_list|,
name|nlmiddle
argument_list|)
expr_stmt|;
if|if
condition|(
name|startmask
condition|)
operator|*
name|addrl
operator|++
operator|^=
name|startmask
expr_stmt|;
name|Duff
argument_list|(
name|nlmiddle
argument_list|,
operator|*
name|addrl
operator|++
operator|^=
literal|0xffffffff
argument_list|)
expr_stmt|;
if|if
condition|(
name|endmask
condition|)
operator|*
name|addrl
operator|^=
name|endmask
expr_stmt|;
block|}
block|}
name|pwidth
operator|++
expr_stmt|;
name|ppt
operator|++
expr_stmt|;
block|}
name|DEALLOCATE_LOCAL
argument_list|(
name|pptFree
argument_list|)
expr_stmt|;
name|DEALLOCATE_LOCAL
argument_list|(
name|pwidthFree
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|mfbWhiteStippleFS
parameter_list|(
name|pDrawable
parameter_list|,
name|pGC
parameter_list|,
name|nInit
parameter_list|,
name|pptInit
parameter_list|,
name|pwidthInit
parameter_list|,
name|fSorted
parameter_list|)
name|DrawablePtr
name|pDrawable
decl_stmt|;
name|GC
modifier|*
name|pGC
decl_stmt|;
name|int
name|nInit
decl_stmt|;
comment|/* number of spans to fill */
name|DDXPointPtr
name|pptInit
decl_stmt|;
comment|/* pointer to list of start points */
name|int
modifier|*
name|pwidthInit
decl_stmt|;
comment|/* pointer to list of n widths */
name|int
name|fSorted
decl_stmt|;
block|{
comment|/* next three parameters are post-clip */
name|int
name|n
decl_stmt|;
comment|/* number of spans to fill */
specifier|register
name|DDXPointPtr
name|ppt
decl_stmt|;
comment|/* pointer to list of start points */
specifier|register
name|int
modifier|*
name|pwidth
decl_stmt|;
comment|/* pointer to list of n widths */
name|int
modifier|*
name|addrlBase
decl_stmt|;
comment|/* pointer to start of bitmap */
name|int
name|nlwidth
decl_stmt|;
comment|/* width in longwords of bitmap */
specifier|register
name|int
modifier|*
name|addrl
decl_stmt|;
comment|/* pointer to current longword in bitmap */
specifier|register
name|int
name|src
decl_stmt|;
specifier|register
name|int
name|nlmiddle
decl_stmt|;
specifier|register
name|int
name|startmask
decl_stmt|;
specifier|register
name|int
name|endmask
decl_stmt|;
name|PixmapPtr
name|pStipple
decl_stmt|;
name|int
modifier|*
name|psrc
decl_stmt|;
name|int
name|tileHeight
decl_stmt|;
name|int
modifier|*
name|pwidthFree
decl_stmt|;
comment|/* copies of the pointers to free */
name|DDXPointPtr
name|pptFree
decl_stmt|;
if|if
condition|(
operator|!
operator|(
name|pGC
operator|->
name|planemask
operator|&
literal|1
operator|)
condition|)
return|return;
name|n
operator|=
name|nInit
operator|*
name|miFindMaxBand
argument_list|(
operator|(
operator|(
name|mfbPrivGC
operator|*
operator|)
operator|(
name|pGC
operator|->
name|devPrivates
index|[
name|mfbGCPrivateIndex
index|]
operator|.
name|ptr
operator|)
operator|)
operator|->
name|pCompositeClip
argument_list|)
expr_stmt|;
name|pwidthFree
operator|=
operator|(
name|int
operator|*
operator|)
name|ALLOCATE_LOCAL
argument_list|(
name|n
operator|*
sizeof|sizeof
argument_list|(
name|int
argument_list|)
argument_list|)
expr_stmt|;
name|pptFree
operator|=
operator|(
name|DDXPointRec
operator|*
operator|)
name|ALLOCATE_LOCAL
argument_list|(
name|n
operator|*
sizeof|sizeof
argument_list|(
name|DDXPointRec
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|pptFree
operator|||
operator|!
name|pwidthFree
condition|)
block|{
if|if
condition|(
name|pptFree
condition|)
name|DEALLOCATE_LOCAL
argument_list|(
name|pptFree
argument_list|)
expr_stmt|;
if|if
condition|(
name|pwidthFree
condition|)
name|DEALLOCATE_LOCAL
argument_list|(
name|pwidthFree
argument_list|)
expr_stmt|;
return|return;
block|}
name|pwidth
operator|=
name|pwidthFree
expr_stmt|;
name|ppt
operator|=
name|pptFree
expr_stmt|;
name|n
operator|=
name|miClipSpans
argument_list|(
operator|(
operator|(
name|mfbPrivGC
operator|*
operator|)
operator|(
name|pGC
operator|->
name|devPrivates
index|[
name|mfbGCPrivateIndex
index|]
operator|.
name|ptr
operator|)
operator|)
operator|->
name|pCompositeClip
argument_list|,
name|pptInit
argument_list|,
name|pwidthInit
argument_list|,
name|nInit
argument_list|,
name|ppt
argument_list|,
name|pwidth
argument_list|,
name|fSorted
argument_list|)
expr_stmt|;
if|if
condition|(
name|pDrawable
operator|->
name|type
operator|==
name|DRAWABLE_WINDOW
condition|)
block|{
name|addrlBase
operator|=
operator|(
name|int
operator|*
operator|)
name|getPrivScreenPtr
argument_list|(
name|pDrawable
operator|->
name|pScreen
argument_list|)
operator|->
name|bits
expr_stmt|;
name|nlwidth
operator|=
operator|(
name|int
operator|)
name|getPrivScreenPtr
argument_list|(
name|pDrawable
operator|->
name|pScreen
argument_list|)
operator|->
name|stride
operator|>>
literal|2
expr_stmt|;
block|}
else|else
block|{
name|addrlBase
operator|=
operator|(
name|int
operator|*
operator|)
name|getPrivPixmapPtr
argument_list|(
name|pDrawable
argument_list|)
operator|->
name|bits
expr_stmt|;
name|nlwidth
operator|=
operator|(
name|int
operator|)
name|getPrivPixmapPtr
argument_list|(
name|pDrawable
argument_list|)
operator|->
name|stride
operator|>>
literal|2
expr_stmt|;
block|}
name|pStipple
operator|=
operator|(
operator|(
name|mfbPrivGC
operator|*
operator|)
operator|(
name|pGC
operator|->
name|devPrivates
index|[
name|mfbGCPrivateIndex
index|]
operator|.
name|ptr
operator|)
operator|)
operator|->
name|pRotatedPixmap
expr_stmt|;
name|tileHeight
operator|=
name|pStipple
operator|->
name|drawable
operator|.
name|height
expr_stmt|;
name|psrc
operator|=
operator|(
name|int
operator|*
operator|)
operator|(
operator|(
call|(
name|hpPrivPixmapPtr
call|)
argument_list|(
name|pStipple
operator|->
name|devPrivate
operator|.
name|ptr
argument_list|)
operator|)
operator|->
name|bits
operator|)
expr_stmt|;
while|while
condition|(
name|n
operator|--
condition|)
block|{
name|addrl
operator|=
name|addrlBase
operator|+
operator|(
name|ppt
operator|->
name|y
operator|*
name|nlwidth
operator|)
operator|+
operator|(
name|ppt
operator|->
name|x
operator|>>
literal|5
operator|)
expr_stmt|;
name|src
operator|=
name|psrc
index|[
name|ppt
operator|->
name|y
operator|%
name|tileHeight
index|]
expr_stmt|;
comment|/* all bits inside same longword */
if|if
condition|(
operator|(
operator|(
name|ppt
operator|->
name|x
operator|&
literal|0x1f
operator|)
operator|+
operator|*
name|pwidth
operator|)
operator|<
literal|32
condition|)
block|{
name|maskpartialbits
argument_list|(
name|ppt
operator|->
name|x
argument_list|,
operator|*
name|pwidth
argument_list|,
name|startmask
argument_list|)
expr_stmt|;
operator|*
name|addrl
operator||=
operator|(
name|src
operator|&
name|startmask
operator|)
expr_stmt|;
block|}
else|else
block|{
name|maskbits
argument_list|(
name|ppt
operator|->
name|x
argument_list|,
operator|*
name|pwidth
argument_list|,
name|startmask
argument_list|,
name|endmask
argument_list|,
name|nlmiddle
argument_list|)
expr_stmt|;
if|if
condition|(
name|startmask
condition|)
operator|*
name|addrl
operator|++
operator||=
operator|(
name|src
operator|&
name|startmask
operator|)
expr_stmt|;
name|Duff
argument_list|(
name|nlmiddle
argument_list|,
operator|*
name|addrl
operator|++
operator||=
name|src
argument_list|)
expr_stmt|;
if|if
condition|(
name|endmask
condition|)
operator|*
name|addrl
operator||=
operator|(
name|src
operator|&
name|endmask
operator|)
expr_stmt|;
block|}
name|pwidth
operator|++
expr_stmt|;
name|ppt
operator|++
expr_stmt|;
block|}
name|DEALLOCATE_LOCAL
argument_list|(
name|pptFree
argument_list|)
expr_stmt|;
name|DEALLOCATE_LOCAL
argument_list|(
name|pwidthFree
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|mfbBlackStippleFS
parameter_list|(
name|pDrawable
parameter_list|,
name|pGC
parameter_list|,
name|nInit
parameter_list|,
name|pptInit
parameter_list|,
name|pwidthInit
parameter_list|,
name|fSorted
parameter_list|)
name|DrawablePtr
name|pDrawable
decl_stmt|;
name|GC
modifier|*
name|pGC
decl_stmt|;
name|int
name|nInit
decl_stmt|;
comment|/* number of spans to fill */
name|DDXPointPtr
name|pptInit
decl_stmt|;
comment|/* pointer to list of start points */
name|int
modifier|*
name|pwidthInit
decl_stmt|;
comment|/* pointer to list of n widths */
name|int
name|fSorted
decl_stmt|;
block|{
comment|/* next three parameters are post-clip */
name|int
name|n
decl_stmt|;
comment|/* number of spans to fill */
specifier|register
name|DDXPointPtr
name|ppt
decl_stmt|;
comment|/* pointer to list of start points */
specifier|register
name|int
modifier|*
name|pwidth
decl_stmt|;
comment|/* pointer to list of n widths */
name|int
modifier|*
name|addrlBase
decl_stmt|;
comment|/* pointer to start of bitmap */
name|int
name|nlwidth
decl_stmt|;
comment|/* width in longwords of bitmap */
specifier|register
name|int
modifier|*
name|addrl
decl_stmt|;
comment|/* pointer to current longword in bitmap */
specifier|register
name|int
name|src
decl_stmt|;
specifier|register
name|int
name|nlmiddle
decl_stmt|;
specifier|register
name|int
name|startmask
decl_stmt|;
specifier|register
name|int
name|endmask
decl_stmt|;
name|PixmapPtr
name|pStipple
decl_stmt|;
name|int
modifier|*
name|psrc
decl_stmt|;
name|int
name|tileHeight
decl_stmt|;
name|int
modifier|*
name|pwidthFree
decl_stmt|;
comment|/* copies of the pointers to free */
name|DDXPointPtr
name|pptFree
decl_stmt|;
if|if
condition|(
operator|!
operator|(
name|pGC
operator|->
name|planemask
operator|&
literal|1
operator|)
condition|)
return|return;
name|n
operator|=
name|nInit
operator|*
name|miFindMaxBand
argument_list|(
operator|(
operator|(
name|mfbPrivGC
operator|*
operator|)
operator|(
name|pGC
operator|->
name|devPrivates
index|[
name|mfbGCPrivateIndex
index|]
operator|.
name|ptr
operator|)
operator|)
operator|->
name|pCompositeClip
argument_list|)
expr_stmt|;
name|pwidthFree
operator|=
operator|(
name|int
operator|*
operator|)
name|ALLOCATE_LOCAL
argument_list|(
name|n
operator|*
sizeof|sizeof
argument_list|(
name|int
argument_list|)
argument_list|)
expr_stmt|;
name|pptFree
operator|=
operator|(
name|DDXPointRec
operator|*
operator|)
name|ALLOCATE_LOCAL
argument_list|(
name|n
operator|*
sizeof|sizeof
argument_list|(
name|DDXPointRec
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|pptFree
operator|||
operator|!
name|pwidthFree
condition|)
block|{
if|if
condition|(
name|pptFree
condition|)
name|DEALLOCATE_LOCAL
argument_list|(
name|pptFree
argument_list|)
expr_stmt|;
if|if
condition|(
name|pwidthFree
condition|)
name|DEALLOCATE_LOCAL
argument_list|(
name|pwidthFree
argument_list|)
expr_stmt|;
return|return;
block|}
name|pwidth
operator|=
name|pwidthFree
expr_stmt|;
name|ppt
operator|=
name|pptFree
expr_stmt|;
name|n
operator|=
name|miClipSpans
argument_list|(
operator|(
operator|(
name|mfbPrivGC
operator|*
operator|)
operator|(
name|pGC
operator|->
name|devPrivates
index|[
name|mfbGCPrivateIndex
index|]
operator|.
name|ptr
operator|)
operator|)
operator|->
name|pCompositeClip
argument_list|,
name|pptInit
argument_list|,
name|pwidthInit
argument_list|,
name|nInit
argument_list|,
name|ppt
argument_list|,
name|pwidth
argument_list|,
name|fSorted
argument_list|)
expr_stmt|;
if|if
condition|(
name|pDrawable
operator|->
name|type
operator|==
name|DRAWABLE_WINDOW
condition|)
block|{
name|addrlBase
operator|=
operator|(
name|int
operator|*
operator|)
name|getPrivScreenPtr
argument_list|(
name|pDrawable
operator|->
name|pScreen
argument_list|)
operator|->
name|bits
expr_stmt|;
name|nlwidth
operator|=
operator|(
name|int
operator|)
name|getPrivScreenPtr
argument_list|(
name|pDrawable
operator|->
name|pScreen
argument_list|)
operator|->
name|stride
operator|>>
literal|2
expr_stmt|;
block|}
else|else
block|{
name|addrlBase
operator|=
operator|(
name|int
operator|*
operator|)
name|getPrivPixmapPtr
argument_list|(
name|pDrawable
argument_list|)
operator|->
name|bits
expr_stmt|;
name|nlwidth
operator|=
operator|(
name|int
operator|)
name|getPrivPixmapPtr
argument_list|(
name|pDrawable
argument_list|)
operator|->
name|stride
operator|>>
literal|2
expr_stmt|;
block|}
name|pStipple
operator|=
operator|(
operator|(
name|mfbPrivGC
operator|*
operator|)
operator|(
name|pGC
operator|->
name|devPrivates
index|[
name|mfbGCPrivateIndex
index|]
operator|.
name|ptr
operator|)
operator|)
operator|->
name|pRotatedPixmap
expr_stmt|;
name|tileHeight
operator|=
name|pStipple
operator|->
name|drawable
operator|.
name|height
expr_stmt|;
name|psrc
operator|=
operator|(
name|int
operator|*
operator|)
operator|(
operator|(
call|(
name|hpPrivPixmapPtr
call|)
argument_list|(
name|pStipple
operator|->
name|devPrivate
operator|.
name|ptr
argument_list|)
operator|)
operator|->
name|bits
operator|)
expr_stmt|;
while|while
condition|(
name|n
operator|--
condition|)
block|{
name|addrl
operator|=
name|addrlBase
operator|+
operator|(
name|ppt
operator|->
name|y
operator|*
name|nlwidth
operator|)
operator|+
operator|(
name|ppt
operator|->
name|x
operator|>>
literal|5
operator|)
expr_stmt|;
name|src
operator|=
name|psrc
index|[
name|ppt
operator|->
name|y
operator|%
name|tileHeight
index|]
expr_stmt|;
comment|/* all bits inside same longword */
if|if
condition|(
operator|(
operator|(
name|ppt
operator|->
name|x
operator|&
literal|0x1f
operator|)
operator|+
operator|*
name|pwidth
operator|)
operator|<
literal|32
condition|)
block|{
name|maskpartialbits
argument_list|(
name|ppt
operator|->
name|x
argument_list|,
operator|*
name|pwidth
argument_list|,
name|startmask
argument_list|)
expr_stmt|;
operator|*
name|addrl
operator|&=
operator|~
operator|(
name|src
operator|&
name|startmask
operator|)
expr_stmt|;
block|}
else|else
block|{
name|maskbits
argument_list|(
name|ppt
operator|->
name|x
argument_list|,
operator|*
name|pwidth
argument_list|,
name|startmask
argument_list|,
name|endmask
argument_list|,
name|nlmiddle
argument_list|)
expr_stmt|;
if|if
condition|(
name|startmask
condition|)
operator|*
name|addrl
operator|++
operator|&=
operator|~
operator|(
name|src
operator|&
name|startmask
operator|)
expr_stmt|;
name|Duff
argument_list|(
name|nlmiddle
argument_list|,
operator|*
name|addrl
operator|++
operator|&=
operator|~
name|src
argument_list|)
expr_stmt|;
if|if
condition|(
name|endmask
condition|)
operator|*
name|addrl
operator|&=
operator|~
operator|(
name|src
operator|&
name|endmask
operator|)
expr_stmt|;
block|}
name|pwidth
operator|++
expr_stmt|;
name|ppt
operator|++
expr_stmt|;
block|}
name|DEALLOCATE_LOCAL
argument_list|(
name|pptFree
argument_list|)
expr_stmt|;
name|DEALLOCATE_LOCAL
argument_list|(
name|pwidthFree
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|mfbInvertStippleFS
parameter_list|(
name|pDrawable
parameter_list|,
name|pGC
parameter_list|,
name|nInit
parameter_list|,
name|pptInit
parameter_list|,
name|pwidthInit
parameter_list|,
name|fSorted
parameter_list|)
name|DrawablePtr
name|pDrawable
decl_stmt|;
name|GC
modifier|*
name|pGC
decl_stmt|;
name|int
name|nInit
decl_stmt|;
comment|/* number of spans to fill */
name|DDXPointPtr
name|pptInit
decl_stmt|;
comment|/* pointer to list of start points */
name|int
modifier|*
name|pwidthInit
decl_stmt|;
comment|/* pointer to list of n widths */
name|int
name|fSorted
decl_stmt|;
block|{
comment|/* next three parameters are post-clip */
name|int
name|n
decl_stmt|;
comment|/* number of spans to fill */
specifier|register
name|DDXPointPtr
name|ppt
decl_stmt|;
comment|/* pointer to list of start points */
specifier|register
name|int
modifier|*
name|pwidth
decl_stmt|;
comment|/* pointer to list of n widths */
name|int
modifier|*
name|addrlBase
decl_stmt|;
comment|/* pointer to start of bitmap */
name|int
name|nlwidth
decl_stmt|;
comment|/* width in longwords of bitmap */
specifier|register
name|int
modifier|*
name|addrl
decl_stmt|;
comment|/* pointer to current longword in bitmap */
specifier|register
name|int
name|src
decl_stmt|;
specifier|register
name|int
name|nlmiddle
decl_stmt|;
specifier|register
name|int
name|startmask
decl_stmt|;
specifier|register
name|int
name|endmask
decl_stmt|;
name|PixmapPtr
name|pStipple
decl_stmt|;
name|int
modifier|*
name|psrc
decl_stmt|;
name|int
name|tileHeight
decl_stmt|;
name|int
modifier|*
name|pwidthFree
decl_stmt|;
comment|/* copies of the pointers to free */
name|DDXPointPtr
name|pptFree
decl_stmt|;
if|if
condition|(
operator|!
operator|(
name|pGC
operator|->
name|planemask
operator|&
literal|1
operator|)
condition|)
return|return;
name|n
operator|=
name|nInit
operator|*
name|miFindMaxBand
argument_list|(
operator|(
operator|(
name|mfbPrivGC
operator|*
operator|)
operator|(
name|pGC
operator|->
name|devPrivates
index|[
name|mfbGCPrivateIndex
index|]
operator|.
name|ptr
operator|)
operator|)
operator|->
name|pCompositeClip
argument_list|)
expr_stmt|;
name|pwidthFree
operator|=
operator|(
name|int
operator|*
operator|)
name|ALLOCATE_LOCAL
argument_list|(
name|n
operator|*
sizeof|sizeof
argument_list|(
name|int
argument_list|)
argument_list|)
expr_stmt|;
name|pptFree
operator|=
operator|(
name|DDXPointRec
operator|*
operator|)
name|ALLOCATE_LOCAL
argument_list|(
name|n
operator|*
sizeof|sizeof
argument_list|(
name|DDXPointRec
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|pptFree
operator|||
operator|!
name|pwidthFree
condition|)
block|{
if|if
condition|(
name|pptFree
condition|)
name|DEALLOCATE_LOCAL
argument_list|(
name|pptFree
argument_list|)
expr_stmt|;
if|if
condition|(
name|pwidthFree
condition|)
name|DEALLOCATE_LOCAL
argument_list|(
name|pwidthFree
argument_list|)
expr_stmt|;
return|return;
block|}
name|pwidth
operator|=
name|pwidthFree
expr_stmt|;
name|ppt
operator|=
name|pptFree
expr_stmt|;
name|n
operator|=
name|miClipSpans
argument_list|(
operator|(
operator|(
name|mfbPrivGC
operator|*
operator|)
operator|(
name|pGC
operator|->
name|devPrivates
index|[
name|mfbGCPrivateIndex
index|]
operator|.
name|ptr
operator|)
operator|)
operator|->
name|pCompositeClip
argument_list|,
name|pptInit
argument_list|,
name|pwidthInit
argument_list|,
name|nInit
argument_list|,
name|ppt
argument_list|,
name|pwidth
argument_list|,
name|fSorted
argument_list|)
expr_stmt|;
if|if
condition|(
name|pDrawable
operator|->
name|type
operator|==
name|DRAWABLE_WINDOW
condition|)
block|{
name|addrlBase
operator|=
operator|(
name|int
operator|*
operator|)
name|getPrivScreenPtr
argument_list|(
name|pDrawable
operator|->
name|pScreen
argument_list|)
operator|->
name|bits
expr_stmt|;
name|nlwidth
operator|=
operator|(
name|int
operator|)
name|getPrivScreenPtr
argument_list|(
name|pDrawable
operator|->
name|pScreen
argument_list|)
operator|->
name|stride
operator|>>
literal|2
expr_stmt|;
block|}
else|else
block|{
name|addrlBase
operator|=
operator|(
name|int
operator|*
operator|)
name|getPrivPixmapPtr
argument_list|(
name|pDrawable
argument_list|)
operator|->
name|bits
expr_stmt|;
name|nlwidth
operator|=
operator|(
name|int
operator|)
name|getPrivPixmapPtr
argument_list|(
name|pDrawable
argument_list|)
operator|->
name|stride
operator|>>
literal|2
expr_stmt|;
block|}
name|pStipple
operator|=
operator|(
operator|(
name|mfbPrivGC
operator|*
operator|)
operator|(
name|pGC
operator|->
name|devPrivates
index|[
name|mfbGCPrivateIndex
index|]
operator|.
name|ptr
operator|)
operator|)
operator|->
name|pRotatedPixmap
expr_stmt|;
name|tileHeight
operator|=
name|pStipple
operator|->
name|drawable
operator|.
name|height
expr_stmt|;
name|psrc
operator|=
operator|(
name|int
operator|*
operator|)
operator|(
operator|(
call|(
name|hpPrivPixmapPtr
call|)
argument_list|(
name|pStipple
operator|->
name|devPrivate
operator|.
name|ptr
argument_list|)
operator|)
operator|->
name|bits
operator|)
expr_stmt|;
while|while
condition|(
name|n
operator|--
condition|)
block|{
name|addrl
operator|=
name|addrlBase
operator|+
operator|(
name|ppt
operator|->
name|y
operator|*
name|nlwidth
operator|)
operator|+
operator|(
name|ppt
operator|->
name|x
operator|>>
literal|5
operator|)
expr_stmt|;
name|src
operator|=
name|psrc
index|[
name|ppt
operator|->
name|y
operator|%
name|tileHeight
index|]
expr_stmt|;
comment|/* all bits inside same longword */
if|if
condition|(
operator|(
operator|(
name|ppt
operator|->
name|x
operator|&
literal|0x1f
operator|)
operator|+
operator|*
name|pwidth
operator|)
operator|<
literal|32
condition|)
block|{
name|maskpartialbits
argument_list|(
name|ppt
operator|->
name|x
argument_list|,
operator|*
name|pwidth
argument_list|,
name|startmask
argument_list|)
expr_stmt|;
operator|*
name|addrl
operator|^=
operator|(
name|src
operator|&
name|startmask
operator|)
expr_stmt|;
block|}
else|else
block|{
name|maskbits
argument_list|(
name|ppt
operator|->
name|x
argument_list|,
operator|*
name|pwidth
argument_list|,
name|startmask
argument_list|,
name|endmask
argument_list|,
name|nlmiddle
argument_list|)
expr_stmt|;
if|if
condition|(
name|startmask
condition|)
operator|*
name|addrl
operator|++
operator|^=
operator|(
name|src
operator|&
name|startmask
operator|)
expr_stmt|;
name|Duff
argument_list|(
name|nlmiddle
argument_list|,
operator|*
name|addrl
operator|++
operator|^=
name|src
argument_list|)
expr_stmt|;
if|if
condition|(
name|endmask
condition|)
operator|*
name|addrl
operator|^=
operator|(
name|src
operator|&
name|endmask
operator|)
expr_stmt|;
block|}
name|pwidth
operator|++
expr_stmt|;
name|ppt
operator|++
expr_stmt|;
block|}
name|DEALLOCATE_LOCAL
argument_list|(
name|pptFree
argument_list|)
expr_stmt|;
name|DEALLOCATE_LOCAL
argument_list|(
name|pwidthFree
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* this works with tiles of width == 32 */
end_comment

begin_define
define|#
directive|define
name|FILLSPAN32
parameter_list|(
name|ROP
parameter_list|)
define|\
value|while (n--) \     { \ 	if (*pwidth) \ 	{ \             addrl = addrlBase + (ppt->y * nlwidth) + (ppt->x>> 5); \ 	    src = psrc[ppt->y % tileHeight]; \             if ( ((ppt->x& 0x1f) + *pwidth)< 32) \             { \ 	        maskpartialbits(ppt->x, *pwidth, startmask); \ 	        *addrl = (*addrl& ~startmask) | \ 		         (ROP(src, *addrl)& startmask); \             } \             else \             { \ 	        maskbits(ppt->x, *pwidth, startmask, endmask, nlmiddle); \ 	        if (startmask) \ 	        { \ 	            *addrl = (*addrl& ~startmask) | \ 			     (ROP(src, *addrl)& startmask); \ 		    addrl++; \ 	        } \ 	        while (nlmiddle--) \ 	        { \ 		    *addrl = ROP(src, *addrl); \ 		    addrl++; \ 	        } \ 	        if (endmask) \ 	            *addrl = (*addrl& ~endmask) | \ 			     (ROP(src, *addrl)& endmask); \             } \ 	} \ 	pwidth++; \ 	ppt++; \     }
end_define

begin_function
name|void
name|mfbTileFS
parameter_list|(
name|pDrawable
parameter_list|,
name|pGC
parameter_list|,
name|nInit
parameter_list|,
name|pptInit
parameter_list|,
name|pwidthInit
parameter_list|,
name|fSorted
parameter_list|)
name|DrawablePtr
name|pDrawable
decl_stmt|;
name|GC
modifier|*
name|pGC
decl_stmt|;
name|int
name|nInit
decl_stmt|;
comment|/* number of spans to fill */
name|DDXPointPtr
name|pptInit
decl_stmt|;
comment|/* pointer to list of start points */
name|int
modifier|*
name|pwidthInit
decl_stmt|;
comment|/* pointer to list of n widths */
name|int
name|fSorted
decl_stmt|;
block|{
comment|/* next three parameters are post-clip */
name|int
name|n
decl_stmt|;
comment|/* number of spans to fill */
specifier|register
name|DDXPointPtr
name|ppt
decl_stmt|;
comment|/* pointer to list of start points */
specifier|register
name|int
modifier|*
name|pwidth
decl_stmt|;
comment|/* pointer to list of n widths */
name|int
modifier|*
name|addrlBase
decl_stmt|;
comment|/* pointer to start of bitmap */
name|int
name|nlwidth
decl_stmt|;
comment|/* width in longwords of bitmap */
specifier|register
name|int
modifier|*
name|addrl
decl_stmt|;
comment|/* pointer to current longword in bitmap */
specifier|register
name|int
name|src
decl_stmt|;
specifier|register
name|int
name|nlmiddle
decl_stmt|;
specifier|register
name|int
name|startmask
decl_stmt|;
specifier|register
name|int
name|endmask
decl_stmt|;
name|PixmapPtr
name|pTile
decl_stmt|;
name|int
modifier|*
name|psrc
decl_stmt|;
name|int
name|tileHeight
decl_stmt|;
name|int
name|rop
decl_stmt|;
name|int
modifier|*
name|pwidthFree
decl_stmt|;
comment|/* copies of the pointers to free */
name|DDXPointPtr
name|pptFree
decl_stmt|;
name|unsigned
name|long
name|flip
decl_stmt|;
if|if
condition|(
operator|!
operator|(
name|pGC
operator|->
name|planemask
operator|&
literal|1
operator|)
condition|)
return|return;
name|n
operator|=
name|nInit
operator|*
name|miFindMaxBand
argument_list|(
operator|(
operator|(
name|mfbPrivGC
operator|*
operator|)
operator|(
name|pGC
operator|->
name|devPrivates
index|[
name|mfbGCPrivateIndex
index|]
operator|.
name|ptr
operator|)
operator|)
operator|->
name|pCompositeClip
argument_list|)
expr_stmt|;
name|pwidthFree
operator|=
operator|(
name|int
operator|*
operator|)
name|ALLOCATE_LOCAL
argument_list|(
name|n
operator|*
sizeof|sizeof
argument_list|(
name|int
argument_list|)
argument_list|)
expr_stmt|;
name|pptFree
operator|=
operator|(
name|DDXPointRec
operator|*
operator|)
name|ALLOCATE_LOCAL
argument_list|(
name|n
operator|*
sizeof|sizeof
argument_list|(
name|DDXPointRec
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|pptFree
operator|||
operator|!
name|pwidthFree
condition|)
block|{
if|if
condition|(
name|pptFree
condition|)
name|DEALLOCATE_LOCAL
argument_list|(
name|pptFree
argument_list|)
expr_stmt|;
if|if
condition|(
name|pwidthFree
condition|)
name|DEALLOCATE_LOCAL
argument_list|(
name|pwidthFree
argument_list|)
expr_stmt|;
return|return;
block|}
name|pwidth
operator|=
name|pwidthFree
expr_stmt|;
name|ppt
operator|=
name|pptFree
expr_stmt|;
name|n
operator|=
name|miClipSpans
argument_list|(
operator|(
operator|(
name|mfbPrivGC
operator|*
operator|)
operator|(
name|pGC
operator|->
name|devPrivates
index|[
name|mfbGCPrivateIndex
index|]
operator|.
name|ptr
operator|)
operator|)
operator|->
name|pCompositeClip
argument_list|,
name|pptInit
argument_list|,
name|pwidthInit
argument_list|,
name|nInit
argument_list|,
name|ppt
argument_list|,
name|pwidth
argument_list|,
name|fSorted
argument_list|)
expr_stmt|;
if|if
condition|(
name|pDrawable
operator|->
name|type
operator|==
name|DRAWABLE_WINDOW
condition|)
block|{
name|addrlBase
operator|=
operator|(
name|int
operator|*
operator|)
name|getPrivScreenPtr
argument_list|(
name|pDrawable
operator|->
name|pScreen
argument_list|)
operator|->
name|bits
expr_stmt|;
name|nlwidth
operator|=
operator|(
name|int
operator|)
name|getPrivScreenPtr
argument_list|(
name|pDrawable
operator|->
name|pScreen
argument_list|)
operator|->
name|stride
operator|>>
literal|2
expr_stmt|;
block|}
else|else
block|{
name|addrlBase
operator|=
operator|(
name|int
operator|*
operator|)
name|getPrivPixmapPtr
argument_list|(
name|pDrawable
argument_list|)
operator|->
name|bits
expr_stmt|;
name|nlwidth
operator|=
operator|(
name|int
operator|)
name|getPrivPixmapPtr
argument_list|(
name|pDrawable
argument_list|)
operator|->
name|stride
operator|>>
literal|2
expr_stmt|;
block|}
name|pTile
operator|=
operator|(
operator|(
name|mfbPrivGC
operator|*
operator|)
operator|(
name|pGC
operator|->
name|devPrivates
index|[
name|mfbGCPrivateIndex
index|]
operator|.
name|ptr
operator|)
operator|)
operator|->
name|pRotatedPixmap
expr_stmt|;
name|tileHeight
operator|=
name|pTile
operator|->
name|drawable
operator|.
name|height
expr_stmt|;
name|psrc
operator|=
operator|(
name|int
operator|*
operator|)
operator|(
operator|(
call|(
name|hpPrivPixmapPtr
call|)
argument_list|(
name|pTile
operator|->
name|devPrivate
operator|.
name|ptr
argument_list|)
operator|)
operator|->
name|bits
operator|)
expr_stmt|;
if|if
condition|(
name|pGC
operator|->
name|fillStyle
operator|==
name|FillTiled
condition|)
name|rop
operator|=
name|pGC
operator|->
name|alu
expr_stmt|;
else|else
name|rop
operator|=
operator|(
operator|(
name|mfbPrivGC
operator|*
operator|)
operator|(
name|pGC
operator|->
name|devPrivates
index|[
name|mfbGCPrivateIndex
index|]
operator|.
name|ptr
operator|)
operator|)
operator|->
name|ropOpStip
expr_stmt|;
name|flip
operator|=
literal|0
expr_stmt|;
switch|switch
condition|(
name|rop
condition|)
block|{
case|case
name|GXcopyInverted
case|:
comment|/* for opaque stipples */
name|flip
operator|=
operator|~
literal|0
expr_stmt|;
case|case
name|GXcopy
case|:
block|{
define|#
directive|define
name|DoMaskCopyRop
parameter_list|(
name|src
parameter_list|,
name|dst
parameter_list|,
name|mask
parameter_list|)
value|((dst)& ~(mask) | (src)& (mask))
while|while
condition|(
name|n
operator|--
condition|)
block|{
if|if
condition|(
operator|*
name|pwidth
condition|)
block|{
name|addrl
operator|=
name|addrlBase
operator|+
operator|(
name|ppt
operator|->
name|y
operator|*
name|nlwidth
operator|)
operator|+
operator|(
name|ppt
operator|->
name|x
operator|>>
literal|5
operator|)
expr_stmt|;
name|src
operator|=
name|psrc
index|[
name|ppt
operator|->
name|y
operator|%
name|tileHeight
index|]
operator|^
name|flip
expr_stmt|;
if|if
condition|(
operator|(
operator|(
name|ppt
operator|->
name|x
operator|&
literal|0x1f
operator|)
operator|+
operator|*
name|pwidth
operator|)
operator|<
literal|32
condition|)
block|{
name|maskpartialbits
argument_list|(
name|ppt
operator|->
name|x
argument_list|,
operator|*
name|pwidth
argument_list|,
name|startmask
argument_list|)
expr_stmt|;
operator|*
name|addrl
operator|=
name|DoMaskCopyRop
argument_list|(
name|src
argument_list|,
operator|*
name|addrl
argument_list|,
name|startmask
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|maskbits
argument_list|(
name|ppt
operator|->
name|x
argument_list|,
operator|*
name|pwidth
argument_list|,
name|startmask
argument_list|,
name|endmask
argument_list|,
name|nlmiddle
argument_list|)
expr_stmt|;
if|if
condition|(
name|startmask
condition|)
block|{
operator|*
name|addrl
operator|=
name|DoMaskCopyRop
argument_list|(
name|src
argument_list|,
operator|*
name|addrl
argument_list|,
name|startmask
argument_list|)
expr_stmt|;
name|addrl
operator|++
expr_stmt|;
block|}
while|while
condition|(
name|nlmiddle
operator|--
condition|)
block|{
operator|*
name|addrl
operator|=
name|src
expr_stmt|;
name|addrl
operator|++
expr_stmt|;
block|}
if|if
condition|(
name|endmask
condition|)
operator|*
name|addrl
operator|=
name|DoMaskCopyRop
argument_list|(
name|src
argument_list|,
operator|*
name|addrl
argument_list|,
name|endmask
argument_list|)
expr_stmt|;
block|}
block|}
name|pwidth
operator|++
expr_stmt|;
name|ppt
operator|++
expr_stmt|;
block|}
block|}
break|break;
default|default:
block|{
specifier|register
name|DeclareMergeRop
argument_list|()
expr_stmt|;
name|InitializeMergeRop
argument_list|(
name|rop
argument_list|,
operator|~
literal|0
argument_list|)
expr_stmt|;
while|while
condition|(
name|n
operator|--
condition|)
block|{
if|if
condition|(
operator|*
name|pwidth
condition|)
block|{
name|addrl
operator|=
name|addrlBase
operator|+
operator|(
name|ppt
operator|->
name|y
operator|*
name|nlwidth
operator|)
operator|+
operator|(
name|ppt
operator|->
name|x
operator|>>
literal|5
operator|)
expr_stmt|;
name|src
operator|=
name|psrc
index|[
name|ppt
operator|->
name|y
operator|%
name|tileHeight
index|]
expr_stmt|;
if|if
condition|(
operator|(
operator|(
name|ppt
operator|->
name|x
operator|&
literal|0x1f
operator|)
operator|+
operator|*
name|pwidth
operator|)
operator|<
literal|32
condition|)
block|{
name|maskpartialbits
argument_list|(
name|ppt
operator|->
name|x
argument_list|,
operator|*
name|pwidth
argument_list|,
name|startmask
argument_list|)
expr_stmt|;
operator|*
name|addrl
operator|=
name|DoMaskMergeRop
argument_list|(
name|src
argument_list|,
operator|*
name|addrl
argument_list|,
name|startmask
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|maskbits
argument_list|(
name|ppt
operator|->
name|x
argument_list|,
operator|*
name|pwidth
argument_list|,
name|startmask
argument_list|,
name|endmask
argument_list|,
name|nlmiddle
argument_list|)
expr_stmt|;
if|if
condition|(
name|startmask
condition|)
block|{
operator|*
name|addrl
operator|=
name|DoMaskMergeRop
argument_list|(
name|src
argument_list|,
operator|*
name|addrl
argument_list|,
name|startmask
argument_list|)
expr_stmt|;
name|addrl
operator|++
expr_stmt|;
block|}
while|while
condition|(
name|nlmiddle
operator|--
condition|)
block|{
operator|*
name|addrl
operator|=
name|DoMergeRop
argument_list|(
name|src
argument_list|,
operator|*
name|addrl
argument_list|)
expr_stmt|;
name|addrl
operator|++
expr_stmt|;
block|}
if|if
condition|(
name|endmask
condition|)
operator|*
name|addrl
operator|=
name|DoMaskMergeRop
argument_list|(
name|src
argument_list|,
operator|*
name|addrl
argument_list|,
name|endmask
argument_list|)
expr_stmt|;
block|}
block|}
name|pwidth
operator|++
expr_stmt|;
name|ppt
operator|++
expr_stmt|;
block|}
block|}
break|break;
block|}
name|DEALLOCATE_LOCAL
argument_list|(
name|pptFree
argument_list|)
expr_stmt|;
name|DEALLOCATE_LOCAL
argument_list|(
name|pwidthFree
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* Fill spans with tiles that aren't 32 bits wide */
end_comment

begin_function
name|void
name|mfbUnnaturalTileFS
parameter_list|(
name|pDrawable
parameter_list|,
name|pGC
parameter_list|,
name|nInit
parameter_list|,
name|pptInit
parameter_list|,
name|pwidthInit
parameter_list|,
name|fSorted
parameter_list|)
name|DrawablePtr
name|pDrawable
decl_stmt|;
name|GC
modifier|*
name|pGC
decl_stmt|;
name|int
name|nInit
decl_stmt|;
comment|/* number of spans to fill */
name|DDXPointPtr
name|pptInit
decl_stmt|;
comment|/* pointer to list of start points */
name|int
modifier|*
name|pwidthInit
decl_stmt|;
comment|/* pointer to list of n widths */
name|int
name|fSorted
decl_stmt|;
block|{
name|int
name|iline
decl_stmt|;
comment|/* first line of tile to use */
comment|/* next three parameters are post-clip */
name|int
name|n
decl_stmt|;
comment|/* number of spans to fill */
specifier|register
name|DDXPointPtr
name|ppt
decl_stmt|;
comment|/* pointer to list of start points */
specifier|register
name|int
modifier|*
name|pwidth
decl_stmt|;
comment|/* pointer to list of n widths */
name|unsigned
name|int
modifier|*
name|addrlBase
decl_stmt|;
comment|/* pointer to start of bitmap */
name|int
name|nlwidth
decl_stmt|;
comment|/* width in longwords of bitmap */
specifier|register
name|unsigned
name|int
modifier|*
name|pdst
decl_stmt|;
comment|/* pointer to current word in bitmap */
specifier|register
name|unsigned
name|int
modifier|*
name|psrc
decl_stmt|;
comment|/* pointer to current word in tile */
specifier|register
name|int
name|nlMiddle
decl_stmt|;
specifier|register
name|int
name|rop
decl_stmt|,
name|nstart
decl_stmt|;
name|unsigned
name|int
name|startmask
decl_stmt|;
name|PixmapPtr
name|pTile
decl_stmt|;
comment|/* pointer to tile we want to fill with */
name|hpPrivPixmapPtr
name|pPrivTile
decl_stmt|;
name|int
name|w
decl_stmt|,
name|width
decl_stmt|,
name|x
decl_stmt|,
name|xSrc
decl_stmt|,
name|ySrc
decl_stmt|,
name|srcStartOver
decl_stmt|,
name|nend
decl_stmt|;
name|int
name|tlwidth
decl_stmt|,
name|rem
decl_stmt|,
name|tileWidth
decl_stmt|,
name|tileHeight
decl_stmt|,
name|endinc
decl_stmt|;
name|unsigned
name|int
name|endmask
decl_stmt|,
modifier|*
name|psrcT
decl_stmt|;
name|int
modifier|*
name|pwidthFree
decl_stmt|;
comment|/* copies of the pointers to free */
name|DDXPointPtr
name|pptFree
decl_stmt|;
if|if
condition|(
operator|!
operator|(
name|pGC
operator|->
name|planemask
operator|&
literal|1
operator|)
condition|)
return|return;
name|n
operator|=
name|nInit
operator|*
name|miFindMaxBand
argument_list|(
operator|(
operator|(
name|mfbPrivGC
operator|*
operator|)
operator|(
name|pGC
operator|->
name|devPrivates
index|[
name|mfbGCPrivateIndex
index|]
operator|.
name|ptr
operator|)
operator|)
operator|->
name|pCompositeClip
argument_list|)
expr_stmt|;
name|pwidthFree
operator|=
operator|(
name|int
operator|*
operator|)
name|ALLOCATE_LOCAL
argument_list|(
name|n
operator|*
sizeof|sizeof
argument_list|(
name|int
argument_list|)
argument_list|)
expr_stmt|;
name|pptFree
operator|=
operator|(
name|DDXPointRec
operator|*
operator|)
name|ALLOCATE_LOCAL
argument_list|(
name|n
operator|*
sizeof|sizeof
argument_list|(
name|DDXPointRec
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|pptFree
operator|||
operator|!
name|pwidthFree
condition|)
block|{
if|if
condition|(
name|pptFree
condition|)
name|DEALLOCATE_LOCAL
argument_list|(
name|pptFree
argument_list|)
expr_stmt|;
if|if
condition|(
name|pwidthFree
condition|)
name|DEALLOCATE_LOCAL
argument_list|(
name|pwidthFree
argument_list|)
expr_stmt|;
return|return;
block|}
name|pwidth
operator|=
name|pwidthFree
expr_stmt|;
name|ppt
operator|=
name|pptFree
expr_stmt|;
name|n
operator|=
name|miClipSpans
argument_list|(
operator|(
operator|(
name|mfbPrivGC
operator|*
operator|)
operator|(
name|pGC
operator|->
name|devPrivates
index|[
name|mfbGCPrivateIndex
index|]
operator|.
name|ptr
operator|)
operator|)
operator|->
name|pCompositeClip
argument_list|,
name|pptInit
argument_list|,
name|pwidthInit
argument_list|,
name|nInit
argument_list|,
name|ppt
argument_list|,
name|pwidth
argument_list|,
name|fSorted
argument_list|)
expr_stmt|;
if|if
condition|(
name|pGC
operator|->
name|fillStyle
operator|==
name|FillTiled
condition|)
block|{
name|pTile
operator|=
name|pGC
operator|->
name|tile
operator|.
name|pixmap
expr_stmt|;
name|rop
operator|=
name|pGC
operator|->
name|alu
expr_stmt|;
block|}
else|else
block|{
name|pTile
operator|=
name|pGC
operator|->
name|stipple
expr_stmt|;
name|rop
operator|=
operator|(
operator|(
name|mfbPrivGC
operator|*
operator|)
operator|(
name|pGC
operator|->
name|devPrivates
index|[
name|mfbGCPrivateIndex
index|]
operator|.
name|ptr
operator|)
operator|)
operator|->
name|ropOpStip
expr_stmt|;
block|}
name|pPrivTile
operator|=
operator|(
name|hpPrivPixmapPtr
operator|)
name|pTile
operator|->
name|devPrivate
operator|.
name|ptr
expr_stmt|;
name|tlwidth
operator|=
name|pPrivTile
operator|->
name|stride
operator|>>
literal|2
expr_stmt|;
name|xSrc
operator|=
name|pDrawable
operator|->
name|x
expr_stmt|;
name|ySrc
operator|=
name|pDrawable
operator|->
name|y
expr_stmt|;
if|if
condition|(
name|pDrawable
operator|->
name|type
operator|==
name|DRAWABLE_WINDOW
condition|)
block|{
name|addrlBase
operator|=
operator|(
name|unsigned
name|int
operator|*
operator|)
name|getPrivScreenPtr
argument_list|(
name|pDrawable
operator|->
name|pScreen
argument_list|)
operator|->
name|bits
expr_stmt|;
name|nlwidth
operator|=
operator|(
name|int
operator|)
name|getPrivScreenPtr
argument_list|(
name|pDrawable
operator|->
name|pScreen
argument_list|)
operator|->
name|stride
operator|>>
literal|2
expr_stmt|;
block|}
else|else
block|{
name|addrlBase
operator|=
operator|(
name|unsigned
name|int
operator|*
operator|)
name|getPrivPixmapPtr
argument_list|(
name|pDrawable
argument_list|)
operator|->
name|bits
expr_stmt|;
name|nlwidth
operator|=
operator|(
name|int
operator|)
name|getPrivPixmapPtr
argument_list|(
name|pDrawable
argument_list|)
operator|->
name|stride
operator|>>
literal|2
expr_stmt|;
block|}
name|tileWidth
operator|=
name|pTile
operator|->
name|drawable
operator|.
name|width
expr_stmt|;
name|tileHeight
operator|=
name|pTile
operator|->
name|drawable
operator|.
name|height
expr_stmt|;
comment|/* this replaces rotating the tile. Instead we just adjust the offset      * at which we start grabbing bits from the tile.      * Ensure that ppt->x - xSrc>= 0 and ppt->y - ySrc>= 0,      * so that iline and rem always stay within the tile bounds.      */
name|xSrc
operator|+=
operator|(
name|pGC
operator|->
name|patOrg
operator|.
name|x
operator|%
name|tileWidth
operator|)
operator|-
name|tileWidth
expr_stmt|;
name|ySrc
operator|+=
operator|(
name|pGC
operator|->
name|patOrg
operator|.
name|y
operator|%
name|tileHeight
operator|)
operator|-
name|tileHeight
expr_stmt|;
while|while
condition|(
name|n
operator|--
condition|)
block|{
name|iline
operator|=
operator|(
name|ppt
operator|->
name|y
operator|-
name|ySrc
operator|)
operator|%
name|tileHeight
expr_stmt|;
name|pdst
operator|=
name|addrlBase
operator|+
operator|(
name|ppt
operator|->
name|y
operator|*
name|nlwidth
operator|)
operator|+
operator|(
name|ppt
operator|->
name|x
operator|>>
literal|5
operator|)
expr_stmt|;
name|psrcT
operator|=
operator|(
name|unsigned
name|int
operator|*
operator|)
name|pPrivTile
operator|->
name|bits
operator|+
operator|(
name|iline
operator|*
name|tlwidth
operator|)
expr_stmt|;
name|x
operator|=
name|ppt
operator|->
name|x
expr_stmt|;
if|if
condition|(
operator|*
name|pwidth
condition|)
block|{
name|width
operator|=
operator|*
name|pwidth
expr_stmt|;
while|while
condition|(
name|width
operator|>
literal|0
condition|)
block|{
name|psrc
operator|=
name|psrcT
expr_stmt|;
name|w
operator|=
name|min
argument_list|(
name|tileWidth
argument_list|,
name|width
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|rem
operator|=
operator|(
name|x
operator|-
name|xSrc
operator|)
operator|%
name|tileWidth
operator|)
operator|!=
literal|0
condition|)
block|{
comment|/* if we're in the middle of the tile, get 		       as many bits as will finish the span, or 		       as many as will get to the left edge of the tile, 		       or a longword worth, starting at the appropriate 		       offset in the tile. 		    */
name|w
operator|=
name|min
argument_list|(
name|min
argument_list|(
name|tileWidth
operator|-
name|rem
argument_list|,
name|width
argument_list|)
argument_list|,
name|BITMAP_SCANLINE_UNIT
argument_list|)
expr_stmt|;
name|endinc
operator|=
name|rem
operator|/
name|BITMAP_SCANLINE_UNIT
expr_stmt|;
name|getandputrop
argument_list|(
operator|(
name|psrc
operator|+
name|endinc
operator|)
argument_list|,
operator|(
name|rem
operator|&
literal|0x1f
operator|)
argument_list|,
operator|(
name|x
operator|&
literal|0x1f
operator|)
argument_list|,
name|w
argument_list|,
name|pdst
argument_list|,
name|rop
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|x
operator|&
literal|0x1f
operator|)
operator|+
name|w
operator|>=
literal|0x20
condition|)
name|pdst
operator|++
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|(
operator|(
name|x
operator|&
literal|0x1f
operator|)
operator|+
name|w
operator|)
operator|<
literal|32
condition|)
block|{
comment|/* doing< 32 bits is easy, and worth special-casing */
name|putbitsrop
argument_list|(
operator|*
name|psrc
argument_list|,
name|x
operator|&
literal|0x1f
argument_list|,
name|w
argument_list|,
name|pdst
argument_list|,
name|rop
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|/* start at the left edge of the tile, 		       and put down as much as we can 		    */
name|maskbits
argument_list|(
name|x
argument_list|,
name|w
argument_list|,
name|startmask
argument_list|,
name|endmask
argument_list|,
name|nlMiddle
argument_list|)
expr_stmt|;
if|if
condition|(
name|startmask
condition|)
name|nstart
operator|=
literal|32
operator|-
operator|(
name|x
operator|&
literal|0x1f
operator|)
expr_stmt|;
else|else
name|nstart
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|endmask
condition|)
name|nend
operator|=
operator|(
name|x
operator|+
name|w
operator|)
operator|&
literal|0x1f
expr_stmt|;
else|else
name|nend
operator|=
literal|0
expr_stmt|;
name|srcStartOver
operator|=
name|nstart
operator|>
literal|31
expr_stmt|;
if|if
condition|(
name|startmask
condition|)
block|{
name|putbitsrop
argument_list|(
operator|*
name|psrc
argument_list|,
operator|(
name|x
operator|&
literal|0x1f
operator|)
argument_list|,
name|nstart
argument_list|,
name|pdst
argument_list|,
name|rop
argument_list|)
expr_stmt|;
name|pdst
operator|++
expr_stmt|;
if|if
condition|(
name|srcStartOver
condition|)
name|psrc
operator|++
expr_stmt|;
block|}
while|while
condition|(
name|nlMiddle
operator|--
condition|)
block|{
name|getandputrop0
argument_list|(
name|psrc
argument_list|,
name|nstart
argument_list|,
literal|32
argument_list|,
name|pdst
argument_list|,
name|rop
argument_list|)
expr_stmt|;
name|pdst
operator|++
expr_stmt|;
name|psrc
operator|++
expr_stmt|;
block|}
if|if
condition|(
name|endmask
condition|)
block|{
name|getandputrop0
argument_list|(
name|psrc
argument_list|,
name|nstart
argument_list|,
name|nend
argument_list|,
name|pdst
argument_list|,
name|rop
argument_list|)
expr_stmt|;
block|}
block|}
name|x
operator|+=
name|w
expr_stmt|;
name|width
operator|-=
name|w
expr_stmt|;
block|}
block|}
name|ppt
operator|++
expr_stmt|;
name|pwidth
operator|++
expr_stmt|;
block|}
name|DEALLOCATE_LOCAL
argument_list|(
name|pptFree
argument_list|)
expr_stmt|;
name|DEALLOCATE_LOCAL
argument_list|(
name|pwidthFree
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* Fill spans with stipples that aren't 32 bits wide */
end_comment

begin_function
name|void
name|mfbUnnaturalStippleFS
parameter_list|(
name|pDrawable
parameter_list|,
name|pGC
parameter_list|,
name|nInit
parameter_list|,
name|pptInit
parameter_list|,
name|pwidthInit
parameter_list|,
name|fSorted
parameter_list|)
name|DrawablePtr
name|pDrawable
decl_stmt|;
name|GC
modifier|*
name|pGC
decl_stmt|;
name|int
name|nInit
decl_stmt|;
comment|/* number of spans to fill */
name|DDXPointPtr
name|pptInit
decl_stmt|;
comment|/* pointer to list of start points */
name|int
modifier|*
name|pwidthInit
decl_stmt|;
comment|/* pointer to list of n widths */
name|int
name|fSorted
decl_stmt|;
block|{
comment|/* next three parameters are post-clip */
name|int
name|n
decl_stmt|;
comment|/* number of spans to fill */
specifier|register
name|DDXPointPtr
name|ppt
decl_stmt|;
comment|/* pointer to list of start points */
specifier|register
name|int
modifier|*
name|pwidth
decl_stmt|;
comment|/* pointer to list of n widths */
name|int
name|iline
decl_stmt|;
comment|/* first line of tile to use */
name|int
modifier|*
name|addrlBase
decl_stmt|;
comment|/* pointer to start of bitmap */
name|int
name|nlwidth
decl_stmt|;
comment|/* width in longwords of bitmap */
specifier|register
name|int
modifier|*
name|pdst
decl_stmt|;
comment|/* pointer to current word in bitmap */
specifier|register
name|int
modifier|*
name|psrc
decl_stmt|;
comment|/* pointer to current word in tile */
specifier|register
name|int
name|nlMiddle
decl_stmt|;
specifier|register
name|int
name|rop
decl_stmt|,
name|nstart
decl_stmt|;
name|int
name|startmask
decl_stmt|;
name|PixmapPtr
name|pTile
decl_stmt|;
comment|/* pointer to tile we want to fill with */
name|hpPrivPixmapPtr
name|pPrivTile
decl_stmt|;
name|int
name|w
decl_stmt|,
name|width
decl_stmt|,
name|x
decl_stmt|,
name|xSrc
decl_stmt|,
name|ySrc
decl_stmt|,
name|srcStartOver
decl_stmt|,
name|nend
decl_stmt|;
name|int
name|endmask
decl_stmt|,
name|tlwidth
decl_stmt|,
name|rem
decl_stmt|,
name|tileWidth
decl_stmt|,
modifier|*
name|psrcT
decl_stmt|,
name|endinc
decl_stmt|;
name|int
name|tileHeight
decl_stmt|;
name|int
modifier|*
name|pwidthFree
decl_stmt|;
comment|/* copies of the pointers to free */
name|DDXPointPtr
name|pptFree
decl_stmt|;
if|if
condition|(
operator|!
operator|(
name|pGC
operator|->
name|planemask
operator|&
literal|1
operator|)
condition|)
return|return;
name|n
operator|=
name|nInit
operator|*
name|miFindMaxBand
argument_list|(
operator|(
operator|(
name|mfbPrivGC
operator|*
operator|)
operator|(
name|pGC
operator|->
name|devPrivates
index|[
name|mfbGCPrivateIndex
index|]
operator|.
name|ptr
operator|)
operator|)
operator|->
name|pCompositeClip
argument_list|)
expr_stmt|;
name|pwidthFree
operator|=
operator|(
name|int
operator|*
operator|)
name|ALLOCATE_LOCAL
argument_list|(
name|n
operator|*
sizeof|sizeof
argument_list|(
name|int
argument_list|)
argument_list|)
expr_stmt|;
name|pptFree
operator|=
operator|(
name|DDXPointRec
operator|*
operator|)
name|ALLOCATE_LOCAL
argument_list|(
name|n
operator|*
sizeof|sizeof
argument_list|(
name|DDXPointRec
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|pptFree
operator|||
operator|!
name|pwidthFree
condition|)
block|{
if|if
condition|(
name|pptFree
condition|)
name|DEALLOCATE_LOCAL
argument_list|(
name|pptFree
argument_list|)
expr_stmt|;
if|if
condition|(
name|pwidthFree
condition|)
name|DEALLOCATE_LOCAL
argument_list|(
name|pwidthFree
argument_list|)
expr_stmt|;
return|return;
block|}
name|pwidth
operator|=
name|pwidthFree
expr_stmt|;
name|ppt
operator|=
name|pptFree
expr_stmt|;
name|n
operator|=
name|miClipSpans
argument_list|(
operator|(
operator|(
name|mfbPrivGC
operator|*
operator|)
operator|(
name|pGC
operator|->
name|devPrivates
index|[
name|mfbGCPrivateIndex
index|]
operator|.
name|ptr
operator|)
operator|)
operator|->
name|pCompositeClip
argument_list|,
name|pptInit
argument_list|,
name|pwidthInit
argument_list|,
name|nInit
argument_list|,
name|ppt
argument_list|,
name|pwidth
argument_list|,
name|fSorted
argument_list|)
expr_stmt|;
name|pTile
operator|=
name|pGC
operator|->
name|stipple
expr_stmt|;
name|pPrivTile
operator|=
operator|(
name|hpPrivPixmapPtr
operator|)
name|pTile
operator|->
name|devPrivate
operator|.
name|ptr
expr_stmt|;
name|rop
operator|=
operator|(
operator|(
name|mfbPrivGC
operator|*
operator|)
operator|(
name|pGC
operator|->
name|devPrivates
index|[
name|mfbGCPrivateIndex
index|]
operator|.
name|ptr
operator|)
operator|)
operator|->
name|rop
expr_stmt|;
name|tlwidth
operator|=
name|pPrivTile
operator|->
name|stride
operator|>>
literal|2
expr_stmt|;
name|xSrc
operator|=
name|pDrawable
operator|->
name|x
expr_stmt|;
name|ySrc
operator|=
name|pDrawable
operator|->
name|y
expr_stmt|;
if|if
condition|(
name|pDrawable
operator|->
name|type
operator|==
name|DRAWABLE_WINDOW
condition|)
block|{
name|addrlBase
operator|=
operator|(
name|int
operator|*
operator|)
name|getPrivScreenPtr
argument_list|(
name|pDrawable
operator|->
name|pScreen
argument_list|)
operator|->
name|bits
expr_stmt|;
name|nlwidth
operator|=
operator|(
name|int
operator|)
name|getPrivScreenPtr
argument_list|(
name|pDrawable
operator|->
name|pScreen
argument_list|)
operator|->
name|stride
operator|>>
literal|2
expr_stmt|;
block|}
else|else
block|{
name|addrlBase
operator|=
operator|(
name|int
operator|*
operator|)
name|getPrivPixmapPtr
argument_list|(
name|pDrawable
argument_list|)
operator|->
name|bits
expr_stmt|;
name|nlwidth
operator|=
operator|(
name|int
operator|)
name|getPrivPixmapPtr
argument_list|(
name|pDrawable
argument_list|)
operator|->
name|stride
operator|>>
literal|2
expr_stmt|;
block|}
name|tileWidth
operator|=
name|pTile
operator|->
name|drawable
operator|.
name|width
expr_stmt|;
name|tileHeight
operator|=
name|pTile
operator|->
name|drawable
operator|.
name|height
expr_stmt|;
comment|/* this replaces rotating the stipple.  Instead, we just adjust the offset      * at which we start grabbing bits from the stipple.      * Ensure that ppt->x - xSrc>= 0 and ppt->y - ySrc>= 0,      * so that iline and rem always stay within the tile bounds.      */
name|xSrc
operator|+=
operator|(
name|pGC
operator|->
name|patOrg
operator|.
name|x
operator|%
name|tileWidth
operator|)
operator|-
name|tileWidth
expr_stmt|;
name|ySrc
operator|+=
operator|(
name|pGC
operator|->
name|patOrg
operator|.
name|y
operator|%
name|tileHeight
operator|)
operator|-
name|tileHeight
expr_stmt|;
while|while
condition|(
name|n
operator|--
condition|)
block|{
name|iline
operator|=
operator|(
name|ppt
operator|->
name|y
operator|-
name|ySrc
operator|)
operator|%
name|tileHeight
expr_stmt|;
name|pdst
operator|=
name|addrlBase
operator|+
operator|(
name|ppt
operator|->
name|y
operator|*
name|nlwidth
operator|)
operator|+
operator|(
name|ppt
operator|->
name|x
operator|>>
literal|5
operator|)
expr_stmt|;
name|psrcT
operator|=
operator|(
name|int
operator|*
operator|)
name|pPrivTile
operator|->
name|bits
operator|+
operator|(
name|iline
operator|*
name|tlwidth
operator|)
expr_stmt|;
name|x
operator|=
name|ppt
operator|->
name|x
expr_stmt|;
if|if
condition|(
operator|*
name|pwidth
condition|)
block|{
name|width
operator|=
operator|*
name|pwidth
expr_stmt|;
while|while
condition|(
name|width
operator|>
literal|0
condition|)
block|{
name|psrc
operator|=
name|psrcT
expr_stmt|;
name|w
operator|=
name|min
argument_list|(
name|tileWidth
argument_list|,
name|width
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|rem
operator|=
operator|(
name|x
operator|-
name|xSrc
operator|)
operator|%
name|tileWidth
operator|)
operator|!=
literal|0
condition|)
block|{
comment|/* if we're in the middle of the tile, get 		       as many bits as will finish the span, or 		       as many as will get to the left edge of the tile, 		       or a longword worth, starting at the appropriate 		       offset in the tile. 		    */
name|w
operator|=
name|min
argument_list|(
name|min
argument_list|(
name|tileWidth
operator|-
name|rem
argument_list|,
name|width
argument_list|)
argument_list|,
name|BITMAP_SCANLINE_UNIT
argument_list|)
expr_stmt|;
name|endinc
operator|=
name|rem
operator|/
name|BITMAP_SCANLINE_UNIT
expr_stmt|;
name|getandputrrop
argument_list|(
argument|(psrc + endinc)
argument_list|,
argument|(rem&
literal|0x1f
argument|)
argument_list|,
argument|(x&
literal|0x1f
argument|)
argument_list|,
argument|w
argument_list|,
argument|pdst
argument_list|,
argument|rop
argument_list|)
if|if
condition|(
operator|(
name|x
operator|&
literal|0x1f
operator|)
operator|+
name|w
operator|>=
literal|0x20
condition|)
name|pdst
operator|++
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|(
operator|(
name|x
operator|&
literal|0x1f
operator|)
operator|+
name|w
operator|)
operator|<
literal|32
condition|)
block|{
comment|/* doing< 32 bits is easy, and worth special-casing */
name|putbitsrrop
argument_list|(
operator|*
name|psrc
argument_list|,
name|x
operator|&
literal|0x1f
argument_list|,
name|w
argument_list|,
name|pdst
argument_list|,
name|rop
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|/* start at the left edge of the tile, 		       and put down as much as we can 		    */
name|maskbits
argument_list|(
name|x
argument_list|,
name|w
argument_list|,
name|startmask
argument_list|,
name|endmask
argument_list|,
name|nlMiddle
argument_list|)
expr_stmt|;
if|if
condition|(
name|startmask
condition|)
name|nstart
operator|=
literal|32
operator|-
operator|(
name|x
operator|&
literal|0x1f
operator|)
expr_stmt|;
else|else
name|nstart
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|endmask
condition|)
name|nend
operator|=
operator|(
name|x
operator|+
name|w
operator|)
operator|&
literal|0x1f
expr_stmt|;
else|else
name|nend
operator|=
literal|0
expr_stmt|;
name|srcStartOver
operator|=
name|nstart
operator|>
literal|31
expr_stmt|;
if|if
condition|(
name|startmask
condition|)
block|{
name|putbitsrrop
argument_list|(
operator|*
name|psrc
argument_list|,
operator|(
name|x
operator|&
literal|0x1f
operator|)
argument_list|,
name|nstart
argument_list|,
name|pdst
argument_list|,
name|rop
argument_list|)
expr_stmt|;
name|pdst
operator|++
expr_stmt|;
if|if
condition|(
name|srcStartOver
condition|)
name|psrc
operator|++
expr_stmt|;
block|}
while|while
condition|(
name|nlMiddle
operator|--
condition|)
block|{
name|getandputrrop0
argument_list|(
name|psrc
argument_list|,
name|nstart
argument_list|,
literal|32
argument_list|,
name|pdst
argument_list|,
name|rop
argument_list|)
expr_stmt|;
name|pdst
operator|++
expr_stmt|;
name|psrc
operator|++
expr_stmt|;
block|}
if|if
condition|(
name|endmask
condition|)
block|{
name|getandputrrop0
argument_list|(
name|psrc
argument_list|,
name|nstart
argument_list|,
name|nend
argument_list|,
name|pdst
argument_list|,
name|rop
argument_list|)
expr_stmt|;
block|}
block|}
name|x
operator|+=
name|w
expr_stmt|;
name|width
operator|-=
name|w
expr_stmt|;
block|}
block|}
name|ppt
operator|++
expr_stmt|;
name|pwidth
operator|++
expr_stmt|;
block|}
name|DEALLOCATE_LOCAL
argument_list|(
name|pptFree
argument_list|)
expr_stmt|;
name|DEALLOCATE_LOCAL
argument_list|(
name|pwidthFree
argument_list|)
expr_stmt|;
block|}
end_function

end_unit


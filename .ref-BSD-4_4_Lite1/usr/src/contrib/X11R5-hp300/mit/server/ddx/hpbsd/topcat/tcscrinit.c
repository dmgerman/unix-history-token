begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/************************************************************ Copyright 1987 by Sun Microsystems, Inc. Mountain View, CA.                      All Rights Reserved  Permission  to  use,  copy,  modify,  and  distribute   this software  and  its documentation for any purpose and without fee is hereby granted, provided that the above copyright no- tice  appear  in all copies and that both that copyright no- tice and this permission notice appear in  supporting  docu- mentation,  and  that the names of Sun or MIT not be used in advertising or publicity pertaining to distribution  of  the software  without specific prior written permission. Sun and M.I.T. make no representations about the suitability of this software for any purpose. It is provided "as is" without any express or implied warranty.  SUN DISCLAIMS ALL WARRANTIES WITH REGARD TO  THIS  SOFTWARE, INCLUDING ALL IMPLIED WARRANTIES OF MERCHANTABILITY AND FIT- NESS FOR A PARTICULAR PURPOSE. IN NO EVENT SHALL SUN BE  LI- ABLE  FOR  ANY SPECIAL, INDIRECT OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM LOSS OF USE,  DATA  OR PROFITS,  WHETHER  IN  AN  ACTION OF CONTRACT, NEGLIGENCE OR OTHER TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION  WITH THE USE OR PERFORMANCE OF THIS SOFTWARE.  ********************************************************/
end_comment

begin_include
include|#
directive|include
file|"X.h"
end_include

begin_include
include|#
directive|include
file|"Xmd.h"
end_include

begin_include
include|#
directive|include
file|"servermd.h"
end_include

begin_include
include|#
directive|include
file|"scrnintstr.h"
end_include

begin_include
include|#
directive|include
file|"pixmapstr.h"
end_include

begin_include
include|#
directive|include
file|"resource.h"
end_include

begin_include
include|#
directive|include
file|"colormap.h"
end_include

begin_include
include|#
directive|include
file|"colormapst.h"
end_include

begin_include
include|#
directive|include
file|"../cfb/cfb.h"
end_include

begin_include
include|#
directive|include
file|"mi.h"
end_include

begin_include
include|#
directive|include
file|"mistruct.h"
end_include

begin_include
include|#
directive|include
file|"dix.h"
end_include

begin_include
include|#
directive|include
file|"../cfb/cfbmskbits.h"
end_include

begin_include
include|#
directive|include
file|"mibstore.h"
end_include

begin_include
include|#
directive|include
file|"topcat.h"
end_include

begin_function_decl
specifier|extern
name|RegionPtr
name|mfbPixmapToRegion
parameter_list|()
function_decl|;
end_function_decl

begin_function_decl
specifier|extern
name|Bool
name|mfbAllocatePrivates
parameter_list|()
function_decl|;
end_function_decl

begin_decl_stmt
specifier|extern
name|Bool
name|hpRealizeFont
argument_list|()
decl_stmt|,
name|hpUnrealizeFont
argument_list|()
decl_stmt|;
end_decl_stmt

begin_function_decl
specifier|extern
name|void
name|hpGetByteImage
parameter_list|()
function_decl|;
end_function_decl

begin_decl_stmt
specifier|extern
name|int
name|defaultColorVisualClass
decl_stmt|;
end_decl_stmt

begin_define
define|#
directive|define
name|_BP
value|8
end_define

begin_define
define|#
directive|define
name|_RZ
value|((PSZ + 2) / 3)
end_define

begin_define
define|#
directive|define
name|_RS
value|0
end_define

begin_define
define|#
directive|define
name|_RM
value|((1<< _RZ) - 1)
end_define

begin_define
define|#
directive|define
name|_GZ
value|((PSZ - _RZ + 1) / 2)
end_define

begin_define
define|#
directive|define
name|_GS
value|_RZ
end_define

begin_define
define|#
directive|define
name|_GM
value|(((1<< _GZ) - 1)<< _GS)
end_define

begin_define
define|#
directive|define
name|_BZ
value|(PSZ - _RZ - _GZ)
end_define

begin_define
define|#
directive|define
name|_BS
value|(_RZ + _GZ)
end_define

begin_define
define|#
directive|define
name|_BM
value|(((1<< _BZ) - 1)<< _BS)
end_define

begin_define
define|#
directive|define
name|_CE
value|(1<< _RZ)
end_define

begin_if
if|#
directive|if
literal|0
end_if

begin_comment
unit|static VisualRec visuals[] = {
comment|/* vid  class        bpRGB cmpE nplan rMask gMask bMask oRed oGreen oBlue */
end_comment

begin_ifndef
ifndef|#
directive|ifndef
name|STATIC_COLOR
end_ifndef

begin_endif
unit|0,  PseudoColor, _BP,  1<<PSZ,   PSZ,  0,   0,   0,   0,   0,   0,     0,  DirectColor, _BP, _CE,       PSZ,  _RM, _GM, _BM, _RS, _GS, _BS,     0,  GrayScale,   _BP,  1<<PSZ,   PSZ,  0,   0,   0,   0,   0,   0,     0,  StaticGray,  _BP,  1<<PSZ,   PSZ,  0,   0,   0,   0,   0,   0,
endif|#
directive|endif
end_endif

begin_define
unit|0,  StaticColor, _BP,  1<<PSZ,   PSZ,  _RM, _GM, _BM, _RS, _GS, _BS,     0,  TrueColor,   _BP, _CE,       PSZ,  _RM, _GM, _BM, _RS, _GS, _BS };
define|#
directive|define
name|NUMVISUALS
value|((sizeof visuals)/(sizeof visuals[0]))
end_define

begin_comment
unit|static  VisualID VIDs[NUMVISUALS];  static DepthRec depths[] = {
comment|/* depth	numVid		vids */
end_comment

begin_define
unit|1,		0,		NULL,     8,		NUMVISUALS,	VIDs };
define|#
directive|define
name|NUMDEPTHS
value|((sizeof depths)/(sizeof depths[0]))
end_define

begin_else
else|#
directive|else
end_else

begin_comment
comment|/* vid  class        bpRGB cmpE nplan rMask gMask bMask oRed oGreen oBlue */
end_comment

begin_decl_stmt
specifier|static
name|VisualRec
name|PseudoColorVisual
init|=
block|{
literal|0
block|,
name|PseudoColor
block|,
name|_BP
block|,
literal|1
operator|<<
name|PSZ
block|,
name|PSZ
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|, }
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|VisualRec
name|StaticGrayVisual
init|=
block|{
literal|0
block|,
name|StaticGray
block|,
literal|1
block|,
literal|2
block|,
literal|1
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|, }
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|DepthRec
name|depth1
init|=
block|{
comment|/* depth        numVid          vids */
literal|1
block|,
literal|0
block|,
name|NULL
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|DepthRec
name|depth8
init|=
block|{
comment|/* depth        numVid          vids */
literal|8
block|,
literal|1
block|,
name|NULL
block|}
decl_stmt|;
end_decl_stmt

begin_endif
endif|#
directive|endif
end_endif

begin_decl_stmt
name|int
name|cfbWindowPrivateIndex
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|cfbGCPrivateIndex
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|unsigned
name|long
name|hpfbGeneration
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|extern
name|void
name|hpSaveAreas
argument_list|()
decl_stmt|,
name|hpRestoreAreas
argument_list|()
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|miBSFuncRec
name|tcBSFuncRec
init|=
block|{
name|hpSaveAreas
block|,
name|hpRestoreAreas
block|,
operator|(
name|void
argument_list|(
operator|*
argument_list|)
argument_list|()
operator|)
literal|0
block|,
operator|(
name|PixmapPtr
argument_list|(
operator|*
argument_list|)
argument_list|()
operator|)
literal|0
block|,
operator|(
name|PixmapPtr
argument_list|(
operator|*
argument_list|)
argument_list|()
operator|)
literal|0
block|, }
decl_stmt|;
end_decl_stmt

begin_comment
comment|/*ARGSUSED*/
end_comment

begin_function
name|Bool
name|tcCloseScreen
parameter_list|(
name|index
parameter_list|,
name|pScreen
parameter_list|)
name|int
name|index
decl_stmt|;
name|ScreenPtr
name|pScreen
decl_stmt|;
block|{
name|xfree
argument_list|(
name|pScreen
operator|->
name|visuals
argument_list|)
expr_stmt|;
name|xfree
argument_list|(
name|pScreen
operator|->
name|allowedDepths
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|cfbDestroyPixmap
argument_list|(
name|getPrivScreenPtr
argument_list|(
name|pScreen
argument_list|)
operator|->
name|pTmpPixmap
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|cfbDestroyPixmap
argument_list|(
name|getPrivScreenPtr
argument_list|(
name|pScreen
argument_list|)
operator|->
name|pDrawable
argument_list|)
expr_stmt|;
return|return
name|TRUE
return|;
block|}
end_function

begin_comment
comment|/* dts * (inch/dot) * (25.4 mm / inch) = mm */
end_comment

begin_function
name|Bool
name|tcScreenInit
parameter_list|(
name|pScreen
parameter_list|,
name|pbits
parameter_list|,
name|xsize
parameter_list|,
name|ysize
parameter_list|,
name|dpix
parameter_list|,
name|dpiy
parameter_list|,
name|numPlanes
parameter_list|)
specifier|register
name|ScreenPtr
name|pScreen
decl_stmt|;
name|pointer
name|pbits
decl_stmt|;
comment|/* pointer to screen bitmap */
name|int
name|xsize
decl_stmt|,
name|ysize
decl_stmt|;
comment|/* in pixels */
name|int
name|dpix
decl_stmt|,
name|dpiy
decl_stmt|;
comment|/* dots per inch */
name|int
name|numPlanes
decl_stmt|;
comment|/* number of planes in frame buffer */
block|{
name|int
name|i
decl_stmt|;
name|int
name|numVisuals
decl_stmt|;
name|int
name|numDepths
decl_stmt|;
name|VisualRec
modifier|*
name|visuals
decl_stmt|;
name|DepthRec
modifier|*
name|depths
decl_stmt|;
if|if
condition|(
name|hpfbGeneration
operator|!=
name|serverGeneration
condition|)
block|{
name|numVisuals
operator|=
literal|1
expr_stmt|;
name|visuals
operator|=
operator|(
name|VisualRec
operator|*
operator|)
name|xalloc
argument_list|(
name|numVisuals
operator|*
sizeof|sizeof
argument_list|(
name|VisualRec
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|numPlanes
operator|==
literal|1
condition|)
name|bcopy
argument_list|(
operator|&
name|StaticGrayVisual
argument_list|,
operator|&
operator|(
name|visuals
index|[
literal|0
index|]
operator|)
argument_list|,
sizeof|sizeof
argument_list|(
name|VisualRec
argument_list|)
argument_list|)
expr_stmt|;
else|else
block|{
name|bcopy
argument_list|(
operator|&
name|PseudoColorVisual
argument_list|,
operator|&
operator|(
name|visuals
index|[
literal|0
index|]
operator|)
argument_list|,
sizeof|sizeof
argument_list|(
name|VisualRec
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|numPlanes
operator|!=
name|PSZ
condition|)
block|{
name|visuals
index|[
literal|0
index|]
operator|.
name|nplanes
operator|=
name|numPlanes
expr_stmt|;
name|visuals
index|[
literal|0
index|]
operator|.
name|ColormapEntries
operator|=
literal|1
operator|<<
name|numPlanes
expr_stmt|;
if|if
condition|(
name|numPlanes
operator|<
literal|4
condition|)
name|visuals
index|[
literal|0
index|]
operator|.
name|class
operator|=
name|StaticGray
expr_stmt|;
block|}
block|}
comment|/*  Set up the visual IDs */
name|visuals
index|[
literal|0
index|]
operator|.
name|vid
operator|=
name|FakeClientID
argument_list|(
literal|0
argument_list|)
expr_stmt|;
name|numDepths
operator|=
literal|2
expr_stmt|;
name|depths
operator|=
operator|(
name|DepthRec
operator|*
operator|)
name|xalloc
argument_list|(
name|numDepths
operator|*
sizeof|sizeof
argument_list|(
name|DepthRec
argument_list|)
argument_list|)
expr_stmt|;
name|bcopy
argument_list|(
operator|&
name|depth8
argument_list|,
operator|&
operator|(
name|depths
index|[
literal|0
index|]
operator|)
argument_list|,
sizeof|sizeof
argument_list|(
name|DepthRec
argument_list|)
argument_list|)
expr_stmt|;
name|bcopy
argument_list|(
operator|&
name|depth1
argument_list|,
operator|&
operator|(
name|depths
index|[
literal|1
index|]
operator|)
argument_list|,
sizeof|sizeof
argument_list|(
name|DepthRec
argument_list|)
argument_list|)
expr_stmt|;
comment|/*  Set up the remaining fields in the depths[] array */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|numDepths
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|depths
index|[
name|i
index|]
operator|.
name|numVids
operator|>
literal|0
condition|)
block|{
name|depths
index|[
name|i
index|]
operator|.
name|vids
operator|=
operator|(
name|VisualID
operator|*
operator|)
name|xalloc
argument_list|(
sizeof|sizeof
argument_list|(
name|VisualID
argument_list|)
operator|*
name|depths
index|[
name|i
index|]
operator|.
name|numVids
argument_list|)
expr_stmt|;
comment|/* XXX - here we offer only the 8-bit visual */
name|depths
index|[
name|i
index|]
operator|.
name|vids
index|[
literal|0
index|]
operator|=
name|visuals
index|[
literal|0
index|]
operator|.
name|vid
expr_stmt|;
block|}
block|}
name|hpfbGeneration
operator|=
name|serverGeneration
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|mfbAllocatePrivates
argument_list|(
name|pScreen
argument_list|,
operator|&
name|cfbWindowPrivateIndex
argument_list|,
operator|&
name|cfbGCPrivateIndex
argument_list|)
condition|)
return|return
name|FALSE
return|;
if|if
condition|(
operator|!
name|AllocateWindowPrivate
argument_list|(
name|pScreen
argument_list|,
name|cfbWindowPrivateIndex
argument_list|,
sizeof|sizeof
argument_list|(
name|cfbPrivWin
argument_list|)
argument_list|)
operator|||
operator|!
name|AllocateGCPrivate
argument_list|(
name|pScreen
argument_list|,
name|cfbGCPrivateIndex
argument_list|,
sizeof|sizeof
argument_list|(
name|cfbPrivGC
argument_list|)
argument_list|)
condition|)
return|return
name|FALSE
return|;
name|pScreen
operator|->
name|defColormap
operator|=
name|FakeClientID
argument_list|(
literal|0
argument_list|)
expr_stmt|;
comment|/* let CreateDefColormap do whatever it wants */
name|pScreen
operator|->
name|blackPixel
operator|=
name|pScreen
operator|->
name|whitePixel
operator|=
operator|(
name|Pixel
operator|)
literal|0
expr_stmt|;
name|pScreen
operator|->
name|QueryBestSize
operator|=
name|mfbQueryBestSize
expr_stmt|;
comment|/* SaveScreen */
name|pScreen
operator|->
name|GetImage
operator|=
name|hpGetByteImage
expr_stmt|;
name|pScreen
operator|->
name|GetSpans
operator|=
name|cfbGetSpans
expr_stmt|;
name|pScreen
operator|->
name|CreateWindow
operator|=
name|cfbCreateWindow
expr_stmt|;
name|pScreen
operator|->
name|DestroyWindow
operator|=
name|cfbDestroyWindow
expr_stmt|;
name|pScreen
operator|->
name|PositionWindow
operator|=
name|cfbPositionWindow
expr_stmt|;
name|pScreen
operator|->
name|ChangeWindowAttributes
operator|=
name|cfbChangeWindowAttributes
expr_stmt|;
name|pScreen
operator|->
name|RealizeWindow
operator|=
name|cfbMapWindow
expr_stmt|;
name|pScreen
operator|->
name|UnrealizeWindow
operator|=
name|cfbUnmapWindow
expr_stmt|;
name|pScreen
operator|->
name|PaintWindowBackground
operator|=
name|tcPaintWindow
expr_stmt|;
name|pScreen
operator|->
name|PaintWindowBorder
operator|=
name|tcPaintWindow
expr_stmt|;
name|pScreen
operator|->
name|CopyWindow
operator|=
name|cfbCopyWindow
expr_stmt|;
name|pScreen
operator|->
name|CreatePixmap
operator|=
name|cfbCreatePixmap
expr_stmt|;
name|pScreen
operator|->
name|DestroyPixmap
operator|=
name|cfbDestroyPixmap
expr_stmt|;
name|pScreen
operator|->
name|RealizeFont
operator|=
name|hpRealizeFont
expr_stmt|;
name|pScreen
operator|->
name|UnrealizeFont
operator|=
name|hpUnrealizeFont
expr_stmt|;
name|pScreen
operator|->
name|CreateGC
operator|=
name|topcatCreateGC
expr_stmt|;
name|pScreen
operator|->
name|CreateColormap
operator|=
name|cfbInitializeColormap
expr_stmt|;
name|pScreen
operator|->
name|DestroyColormap
operator|=
name|NoopDDA
expr_stmt|;
ifdef|#
directive|ifdef
name|STATIC_COLOR
name|pScreen
operator|->
name|InstallColormap
operator|=
name|cfbInstallColormap
expr_stmt|;
name|pScreen
operator|->
name|UninstallColormap
operator|=
name|cfbUninstallColormap
expr_stmt|;
name|pScreen
operator|->
name|ListInstalledColormaps
operator|=
name|cfbListInstalledColormaps
expr_stmt|;
name|pScreen
operator|->
name|StoreColors
operator|=
name|NoopDDA
expr_stmt|;
name|pScreen
operator|->
name|ResolveColor
operator|=
name|cfbResolveColor
expr_stmt|;
else|#
directive|else
name|pScreen
operator|->
name|InstallColormap
operator|=
name|topcatInstallColormap
expr_stmt|;
name|pScreen
operator|->
name|UninstallColormap
operator|=
name|topcatUninstallColormap
expr_stmt|;
name|pScreen
operator|->
name|ListInstalledColormaps
operator|=
name|topcatListInstalledColormaps
expr_stmt|;
name|pScreen
operator|->
name|StoreColors
operator|=
name|topcatStoreColors
expr_stmt|;
name|pScreen
operator|->
name|ResolveColor
operator|=
name|topcatResolvePseudoColor
expr_stmt|;
endif|#
directive|endif
name|pScreen
operator|->
name|BitmapToRegion
operator|=
name|mfbPixmapToRegion
expr_stmt|;
if|if
condition|(
operator|!
name|hpScreenInit
argument_list|(
name|pScreen
argument_list|,
name|pbits
argument_list|,
name|xsize
argument_list|,
name|ysize
argument_list|,
name|dpix
argument_list|,
name|dpiy
argument_list|,
comment|/*width,*/
name|depths
index|[
literal|0
index|]
operator|.
name|depth
argument_list|,
name|numDepths
argument_list|,
name|depths
argument_list|,
name|visuals
index|[
literal|0
index|]
operator|.
name|vid
argument_list|,
name|numVisuals
argument_list|,
name|visuals
argument_list|,
operator|&
name|tcBSFuncRec
argument_list|)
condition|)
return|return
name|FALSE
return|;
name|getPrivScreenPtr
argument_list|(
name|pScreen
argument_list|)
operator|->
name|pTmpPixmap
operator|=
operator|(
name|pointer
operator|)
name|cfbCreatePixmap
argument_list|(
name|pScreen
argument_list|,
name|PRIV_PIX_WIDTH
argument_list|,
name|PRIV_PIX_HEIGHT
argument_list|,
name|pScreen
operator|->
name|rootDepth
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|getPrivScreenPtr
argument_list|(
name|pScreen
argument_list|)
operator|->
name|pTmpPixmap
condition|)
block|{
operator|(
name|void
operator|)
name|cfbDestroyPixmap
argument_list|(
name|getPrivScreenPtr
argument_list|(
name|pScreen
argument_list|)
operator|->
name|pDrawable
argument_list|)
expr_stmt|;
return|return
name|FALSE
return|;
block|}
return|return
name|TRUE
return|;
block|}
end_function

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/* $XConsortium: XGetProp.c,v 11.17 91/01/06 11:46:15 rws Exp $ */
end_comment

begin_comment
comment|/* Copyright    Massachusetts Institute of Technology    1986	*/
end_comment

begin_comment
comment|/* Permission to use, copy, modify, distribute, and sell this software and its documentation for any purpose is hereby granted without fee, provided that the above copyright notice appear in all copies and that both that copyright notice and this permission notice appear in supporting documentation, and that the name of M.I.T. not be used in advertising or publicity pertaining to distribution of the software without specific, written prior permission.  M.I.T. makes no representations about the suitability of this software for any purpose.  It is provided "as is" without express or implied warranty. */
end_comment

begin_define
define|#
directive|define
name|NEED_REPLIES
end_define

begin_include
include|#
directive|include
file|"Xlibint.h"
end_include

begin_function
name|int
name|XGetWindowProperty
parameter_list|(
name|dpy
parameter_list|,
name|w
parameter_list|,
name|property
parameter_list|,
name|offset
parameter_list|,
name|length
parameter_list|,
name|delete
parameter_list|,
name|req_type
parameter_list|,
name|actual_type
parameter_list|,
name|actual_format
parameter_list|,
name|nitems
parameter_list|,
name|bytesafter
parameter_list|,
name|prop
parameter_list|)
specifier|register
name|Display
modifier|*
name|dpy
decl_stmt|;
name|Window
name|w
decl_stmt|;
name|Atom
name|property
decl_stmt|;
name|Bool
name|delete
decl_stmt|;
name|Atom
name|req_type
decl_stmt|;
name|Atom
modifier|*
name|actual_type
decl_stmt|;
comment|/* RETURN */
name|int
modifier|*
name|actual_format
decl_stmt|;
comment|/* RETURN  8, 16, or 32 */
name|long
name|offset
decl_stmt|,
name|length
decl_stmt|;
name|unsigned
name|long
modifier|*
name|nitems
decl_stmt|;
comment|/* RETURN  # of 8-, 16-, or 32-bit entities */
name|unsigned
name|long
modifier|*
name|bytesafter
decl_stmt|;
comment|/* RETURN */
name|unsigned
name|char
modifier|*
modifier|*
name|prop
decl_stmt|;
comment|/* RETURN */
block|{
name|xGetPropertyReply
name|reply
decl_stmt|;
specifier|register
name|xGetPropertyReq
modifier|*
name|req
decl_stmt|;
name|LockDisplay
argument_list|(
name|dpy
argument_list|)
expr_stmt|;
name|GetReq
argument_list|(
name|GetProperty
argument_list|,
name|req
argument_list|)
expr_stmt|;
name|req
operator|->
name|window
operator|=
name|w
expr_stmt|;
name|req
operator|->
name|property
operator|=
name|property
expr_stmt|;
name|req
operator|->
name|type
operator|=
name|req_type
expr_stmt|;
name|req
operator|->
name|delete
operator|=
name|delete
expr_stmt|;
name|req
operator|->
name|longOffset
operator|=
name|offset
expr_stmt|;
name|req
operator|->
name|longLength
operator|=
name|length
expr_stmt|;
if|if
condition|(
operator|!
name|_XReply
argument_list|(
name|dpy
argument_list|,
operator|(
name|xReply
operator|*
operator|)
operator|&
name|reply
argument_list|,
literal|0
argument_list|,
name|xFalse
argument_list|)
condition|)
block|{
name|UnlockDisplay
argument_list|(
name|dpy
argument_list|)
expr_stmt|;
name|SyncHandle
argument_list|()
expr_stmt|;
return|return
operator|(
literal|1
operator|)
return|;
comment|/* not Success */
block|}
operator|*
name|prop
operator|=
operator|(
name|unsigned
name|char
operator|*
operator|)
name|NULL
expr_stmt|;
if|if
condition|(
name|reply
operator|.
name|propertyType
operator|!=
name|None
condition|)
block|{
name|long
name|nbytes
decl_stmt|,
name|netbytes
decl_stmt|;
switch|switch
condition|(
name|reply
operator|.
name|format
condition|)
block|{
comment|/*         * One extra byte is malloced than is needed to contain the property        * data, but this last byte is null terminated and convenient for         * returning string properties, so the client doesn't then have to         * recopy the string to make it null terminated.         */
case|case
literal|8
case|:
name|nbytes
operator|=
name|netbytes
operator|=
name|reply
operator|.
name|nItems
expr_stmt|;
if|if
condition|(
operator|*
name|prop
operator|=
operator|(
name|unsigned
name|char
operator|*
operator|)
name|Xmalloc
argument_list|(
operator|(
name|unsigned
operator|)
name|nbytes
operator|+
literal|1
argument_list|)
condition|)
name|_XReadPad
argument_list|(
name|dpy
argument_list|,
operator|(
name|char
operator|*
operator|)
operator|*
name|prop
argument_list|,
name|netbytes
argument_list|)
expr_stmt|;
break|break;
case|case
literal|16
case|:
name|nbytes
operator|=
name|reply
operator|.
name|nItems
operator|*
sizeof|sizeof
argument_list|(
name|short
argument_list|)
expr_stmt|;
name|netbytes
operator|=
name|reply
operator|.
name|nItems
operator|<<
literal|1
expr_stmt|;
if|if
condition|(
operator|*
name|prop
operator|=
operator|(
name|unsigned
name|char
operator|*
operator|)
name|Xmalloc
argument_list|(
operator|(
name|unsigned
operator|)
name|nbytes
operator|+
literal|1
argument_list|)
condition|)
name|_XRead16Pad
argument_list|(
name|dpy
argument_list|,
operator|(
name|short
operator|*
operator|)
operator|*
name|prop
argument_list|,
name|netbytes
argument_list|)
expr_stmt|;
break|break;
case|case
literal|32
case|:
name|nbytes
operator|=
name|reply
operator|.
name|nItems
operator|*
sizeof|sizeof
argument_list|(
name|long
argument_list|)
expr_stmt|;
name|netbytes
operator|=
name|reply
operator|.
name|nItems
operator|<<
literal|2
expr_stmt|;
if|if
condition|(
operator|*
name|prop
operator|=
operator|(
name|unsigned
name|char
operator|*
operator|)
name|Xmalloc
argument_list|(
operator|(
name|unsigned
operator|)
name|nbytes
operator|+
literal|1
argument_list|)
condition|)
name|_XRead32
argument_list|(
name|dpy
argument_list|,
operator|(
name|long
operator|*
operator|)
operator|*
name|prop
argument_list|,
name|netbytes
argument_list|)
expr_stmt|;
break|break;
default|default:
comment|/* 	     * This part of the code should never be reached.  If it is, 	     * the server sent back a property with an invalid format. 	     * This is a BadImplementation error.  	     */
block|{
name|xError
name|error
decl_stmt|;
name|error
operator|.
name|sequenceNumber
operator|=
name|dpy
operator|->
name|request
expr_stmt|;
name|error
operator|.
name|type
operator|=
name|X_Error
expr_stmt|;
name|error
operator|.
name|majorCode
operator|=
name|X_GetProperty
expr_stmt|;
name|error
operator|.
name|minorCode
operator|=
literal|0
expr_stmt|;
name|error
operator|.
name|errorCode
operator|=
name|BadImplementation
expr_stmt|;
name|_XError
argument_list|(
name|dpy
argument_list|,
operator|&
name|error
argument_list|)
expr_stmt|;
block|}
name|netbytes
operator|=
literal|0L
expr_stmt|;
break|break;
block|}
if|if
condition|(
operator|!
operator|*
name|prop
condition|)
block|{
name|_XEatData
argument_list|(
name|dpy
argument_list|,
operator|(
name|unsigned
name|long
operator|)
name|netbytes
argument_list|)
expr_stmt|;
name|UnlockDisplay
argument_list|(
name|dpy
argument_list|)
expr_stmt|;
name|SyncHandle
argument_list|()
expr_stmt|;
return|return
operator|(
name|BadAlloc
operator|)
return|;
comment|/* not Success */
block|}
operator|(
operator|*
name|prop
operator|)
index|[
name|nbytes
index|]
operator|=
literal|'\0'
expr_stmt|;
block|}
operator|*
name|actual_type
operator|=
name|reply
operator|.
name|propertyType
expr_stmt|;
operator|*
name|actual_format
operator|=
name|reply
operator|.
name|format
expr_stmt|;
operator|*
name|nitems
operator|=
name|reply
operator|.
name|nItems
expr_stmt|;
operator|*
name|bytesafter
operator|=
name|reply
operator|.
name|bytesAfter
expr_stmt|;
name|UnlockDisplay
argument_list|(
name|dpy
argument_list|)
expr_stmt|;
name|SyncHandle
argument_list|()
expr_stmt|;
return|return
operator|(
name|Success
operator|)
return|;
block|}
end_function

end_unit


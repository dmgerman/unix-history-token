begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/* $XConsortium: XGetPntMap.c,v 1.14 91/01/06 11:46:14 rws Exp $ */
end_comment

begin_comment
comment|/* Copyright    Massachusetts Institute of Technology    1986	*/
end_comment

begin_comment
comment|/* Permission to use, copy, modify, distribute, and sell this software and its documentation for any purpose is hereby granted without fee, provided that the above copyright notice appear in all copies and that both that copyright notice and this permission notice appear in supporting documentation, and that the name of M.I.T. not be used in advertising or publicity pertaining to distribution of the software without specific, written prior permission.  M.I.T. makes no representations about the suitability of this software for any purpose.  It is provided "as is" without express or implied warranty. */
end_comment

begin_define
define|#
directive|define
name|NEED_REPLIES
end_define

begin_include
include|#
directive|include
file|"Xlibint.h"
end_include

begin_ifdef
ifdef|#
directive|ifdef
name|MIN
end_ifdef

begin_comment
comment|/* some systems define this in<sys/param.h> */
end_comment

begin_undef
undef|#
directive|undef
name|MIN
end_undef

begin_endif
endif|#
directive|endif
end_endif

begin_define
define|#
directive|define
name|MIN
parameter_list|(
name|a
parameter_list|,
name|b
parameter_list|)
value|((a)< (b) ? (a) : (b))
end_define

begin_function
name|int
name|XGetPointerMapping
parameter_list|(
name|dpy
parameter_list|,
name|map
parameter_list|,
name|nmaps
parameter_list|)
specifier|register
name|Display
modifier|*
name|dpy
decl_stmt|;
name|unsigned
name|char
modifier|*
name|map
decl_stmt|;
comment|/* RETURN */
name|int
name|nmaps
decl_stmt|;
block|{
name|unsigned
name|char
name|mapping
index|[
literal|256
index|]
decl_stmt|;
comment|/* known fixed size */
name|long
name|nbytes
decl_stmt|;
name|xGetPointerMappingReply
name|rep
decl_stmt|;
specifier|register
name|xReq
modifier|*
name|req
decl_stmt|;
name|LockDisplay
argument_list|(
name|dpy
argument_list|)
expr_stmt|;
name|GetEmptyReq
argument_list|(
name|GetPointerMapping
argument_list|,
name|req
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|_XReply
argument_list|(
name|dpy
argument_list|,
operator|(
name|xReply
operator|*
operator|)
operator|&
name|rep
argument_list|,
literal|0
argument_list|,
name|xFalse
argument_list|)
expr_stmt|;
name|nbytes
operator|=
operator|(
name|long
operator|)
name|rep
operator|.
name|length
operator|<<
literal|2
expr_stmt|;
name|_XRead
argument_list|(
name|dpy
argument_list|,
operator|(
name|char
operator|*
operator|)
name|mapping
argument_list|,
name|nbytes
argument_list|)
expr_stmt|;
comment|/* don't return more data than the user asked for. */
if|if
condition|(
name|rep
operator|.
name|nElts
condition|)
block|{
name|bcopy
argument_list|(
operator|(
name|char
operator|*
operator|)
name|mapping
argument_list|,
operator|(
name|char
operator|*
operator|)
name|map
argument_list|,
name|MIN
argument_list|(
operator|(
name|int
operator|)
name|rep
operator|.
name|nElts
argument_list|,
name|nmaps
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|UnlockDisplay
argument_list|(
name|dpy
argument_list|)
expr_stmt|;
name|SyncHandle
argument_list|()
expr_stmt|;
return|return
operator|(
operator|(
name|int
operator|)
name|rep
operator|.
name|nElts
operator|)
return|;
block|}
end_function

begin_if
if|#
directive|if
name|NeedFunctionPrototypes
end_if

begin_decl_stmt
name|KeySym
modifier|*
name|XGetKeyboardMapping
argument_list|(
name|Display
operator|*
name|dpy
argument_list|,
if|#
directive|if
name|NeedWidePrototypes
name|unsigned
name|int
name|first_keycode
argument_list|,
else|#
directive|else
name|KeyCode
name|first_keycode
argument_list|,
endif|#
directive|endif
name|int
name|count
argument_list|,
name|int
operator|*
name|keysyms_per_keycode
argument_list|)
else|#
directive|else
name|KeySym
modifier|*
name|XGetKeyboardMapping
argument_list|(
name|dpy
argument_list|,
name|first_keycode
argument_list|,
name|count
argument_list|,
name|keysyms_per_keycode
argument_list|)
decl|register
name|Display
modifier|*
name|dpy
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|KeyCode
name|first_keycode
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|count
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
modifier|*
name|keysyms_per_keycode
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* RETURN */
end_comment

begin_endif
endif|#
directive|endif
end_endif

begin_block
block|{
name|long
name|nbytes
decl_stmt|;
name|unsigned
name|long
name|nkeysyms
decl_stmt|;
specifier|register
name|KeySym
modifier|*
name|mapping
init|=
name|NULL
decl_stmt|;
name|xGetKeyboardMappingReply
name|rep
decl_stmt|;
specifier|register
name|xGetKeyboardMappingReq
modifier|*
name|req
decl_stmt|;
name|LockDisplay
argument_list|(
name|dpy
argument_list|)
expr_stmt|;
name|GetReq
argument_list|(
name|GetKeyboardMapping
argument_list|,
name|req
argument_list|)
expr_stmt|;
name|req
operator|->
name|firstKeyCode
operator|=
name|first_keycode
expr_stmt|;
name|req
operator|->
name|count
operator|=
name|count
expr_stmt|;
if|if
condition|(
operator|!
name|_XReply
argument_list|(
name|dpy
argument_list|,
operator|(
name|xReply
operator|*
operator|)
operator|&
name|rep
argument_list|,
literal|0
argument_list|,
name|xFalse
argument_list|)
condition|)
block|{
name|UnlockDisplay
argument_list|(
name|dpy
argument_list|)
expr_stmt|;
name|SyncHandle
argument_list|()
expr_stmt|;
return|return
operator|(
name|KeySym
operator|*
operator|)
name|NULL
return|;
block|}
name|nkeysyms
operator|=
operator|(
name|unsigned
name|long
operator|)
name|rep
operator|.
name|length
expr_stmt|;
if|if
condition|(
name|nkeysyms
operator|>
literal|0
condition|)
block|{
name|nbytes
operator|=
name|nkeysyms
operator|*
sizeof|sizeof
argument_list|(
name|KeySym
argument_list|)
expr_stmt|;
name|mapping
operator|=
operator|(
name|KeySym
operator|*
operator|)
name|Xmalloc
argument_list|(
operator|(
name|unsigned
operator|)
name|nbytes
argument_list|)
expr_stmt|;
name|nbytes
operator|=
name|nkeysyms
operator|<<
literal|2
expr_stmt|;
if|if
condition|(
operator|!
name|mapping
condition|)
block|{
name|_XEatData
argument_list|(
name|dpy
argument_list|,
operator|(
name|unsigned
name|long
operator|)
name|nbytes
argument_list|)
expr_stmt|;
name|UnlockDisplay
argument_list|(
name|dpy
argument_list|)
expr_stmt|;
name|SyncHandle
argument_list|()
expr_stmt|;
return|return
operator|(
name|KeySym
operator|*
operator|)
name|NULL
return|;
block|}
name|_XRead32
argument_list|(
name|dpy
argument_list|,
operator|(
name|char
operator|*
operator|)
name|mapping
argument_list|,
name|nbytes
argument_list|)
expr_stmt|;
block|}
operator|*
name|keysyms_per_keycode
operator|=
name|rep
operator|.
name|keySymsPerKeyCode
expr_stmt|;
name|UnlockDisplay
argument_list|(
name|dpy
argument_list|)
expr_stmt|;
name|SyncHandle
argument_list|()
expr_stmt|;
return|return
operator|(
name|mapping
operator|)
return|;
block|}
end_block

end_unit


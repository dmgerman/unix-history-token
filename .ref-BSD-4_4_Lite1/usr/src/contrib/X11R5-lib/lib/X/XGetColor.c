begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/* $XConsortium: XGetColor.c,v 11.25 91/07/22 22:33:20 rws Exp $ */
end_comment

begin_comment
comment|/* Copyright    Massachusetts Institute of Technology    1986	*/
end_comment

begin_comment
comment|/* Permission to use, copy, modify, distribute, and sell this software and its documentation for any purpose is hereby granted without fee, provided that the above copyright notice appear in all copies and that both that copyright notice and this permission notice appear in supporting documentation, and that the name of M.I.T. not be used in advertising or publicity pertaining to distribution of the software without specific, written prior permission.  M.I.T. makes no representations about the suitability of this software for any purpose.  It is provided "as is" without express or implied warranty. */
end_comment

begin_define
define|#
directive|define
name|NEED_REPLIES
end_define

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_include
include|#
directive|include
file|"Xlibint.h"
end_include

begin_include
include|#
directive|include
file|"Xcmsint.h"
end_include

begin_function_decl
specifier|extern
name|void
name|_XcmsRGB_to_XColor
parameter_list|()
function_decl|;
end_function_decl

begin_if
if|#
directive|if
name|NeedFunctionPrototypes
end_if

begin_decl_stmt
name|Status
name|XAllocNamedColor
argument_list|(
specifier|register
name|Display
operator|*
name|dpy
argument_list|,
name|Colormap
name|cmap
argument_list|,
name|_Xconst
name|char
operator|*
name|colorname
argument_list|,
comment|/* STRING8 */
name|XColor
operator|*
name|hard_def
argument_list|,
comment|/* RETURN */
name|XColor
operator|*
name|exact_def
argument_list|)
comment|/* RETURN */
else|#
directive|else
name|Status
name|XAllocNamedColor
argument_list|(
name|dpy
argument_list|,
name|cmap
argument_list|,
name|colorname
argument_list|,
name|hard_def
argument_list|,
name|exact_def
argument_list|)
decl|register
name|Display
modifier|*
name|dpy
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|Colormap
name|cmap
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|char
modifier|*
name|colorname
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* STRING8 */
end_comment

begin_decl_stmt
name|XColor
modifier|*
name|hard_def
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* RETURN */
end_comment

begin_decl_stmt
name|XColor
modifier|*
name|exact_def
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* RETURN */
end_comment

begin_endif
endif|#
directive|endif
end_endif

begin_block
block|{
name|long
name|nbytes
decl_stmt|;
name|xAllocNamedColorReply
name|rep
decl_stmt|;
name|xAllocNamedColorReq
modifier|*
name|req
decl_stmt|;
name|XcmsCCC
name|ccc
decl_stmt|;
name|XcmsColor
name|cmsColor_exact
decl_stmt|;
name|Status
name|ret
decl_stmt|;
comment|/*      * Let's Attempt to use TekCMS and i18n approach to Parse Color      */
comment|/* copy string to allow overwrite by _XcmsResolveColorString() */
if|if
condition|(
operator|(
name|ccc
operator|=
name|XcmsCCCOfColormap
argument_list|(
name|dpy
argument_list|,
name|cmap
argument_list|)
operator|)
operator|!=
operator|(
name|XcmsCCC
operator|)
name|NULL
condition|)
block|{
if|if
condition|(
name|_XcmsResolveColorString
argument_list|(
name|ccc
argument_list|,
operator|&
name|colorname
argument_list|,
operator|&
name|cmsColor_exact
argument_list|,
name|XcmsRGBFormat
argument_list|)
operator|!=
name|XcmsFailure
condition|)
block|{
name|_XcmsRGB_to_XColor
argument_list|(
operator|&
name|cmsColor_exact
argument_list|,
name|exact_def
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|bcopy
argument_list|(
operator|(
name|char
operator|*
operator|)
name|exact_def
argument_list|,
operator|(
name|char
operator|*
operator|)
name|hard_def
argument_list|,
sizeof|sizeof
argument_list|(
name|XColor
argument_list|)
argument_list|)
expr_stmt|;
name|ret
operator|=
name|XAllocColor
argument_list|(
name|dpy
argument_list|,
name|cmap
argument_list|,
name|hard_def
argument_list|)
expr_stmt|;
name|exact_def
operator|->
name|pixel
operator|=
name|hard_def
operator|->
name|pixel
expr_stmt|;
return|return
operator|(
name|ret
operator|)
return|;
block|}
comment|/* 	 * Otherwise we failed; or colorname was changed with yet another 	 * name.  Thus pass name to the X Server. 	 */
block|}
comment|/*      * TekCMS and i18n approach failed.      */
name|LockDisplay
argument_list|(
name|dpy
argument_list|)
expr_stmt|;
name|GetReq
argument_list|(
name|AllocNamedColor
argument_list|,
name|req
argument_list|)
expr_stmt|;
name|req
operator|->
name|cmap
operator|=
name|cmap
expr_stmt|;
name|nbytes
operator|=
name|req
operator|->
name|nbytes
operator|=
name|strlen
argument_list|(
name|colorname
argument_list|)
expr_stmt|;
name|req
operator|->
name|length
operator|+=
operator|(
name|nbytes
operator|+
literal|3
operator|)
operator|>>
literal|2
expr_stmt|;
comment|/* round up to mult of 4 */
name|_XSend
argument_list|(
name|dpy
argument_list|,
name|colorname
argument_list|,
name|nbytes
argument_list|)
expr_stmt|;
comment|/* _XSend is more efficient that Data, since _XReply follows */
if|if
condition|(
operator|!
name|_XReply
argument_list|(
name|dpy
argument_list|,
operator|(
name|xReply
operator|*
operator|)
operator|&
name|rep
argument_list|,
literal|0
argument_list|,
name|xTrue
argument_list|)
condition|)
block|{
name|UnlockDisplay
argument_list|(
name|dpy
argument_list|)
expr_stmt|;
name|SyncHandle
argument_list|()
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
name|exact_def
operator|->
name|red
operator|=
name|rep
operator|.
name|exactRed
expr_stmt|;
name|exact_def
operator|->
name|green
operator|=
name|rep
operator|.
name|exactGreen
expr_stmt|;
name|exact_def
operator|->
name|blue
operator|=
name|rep
operator|.
name|exactBlue
expr_stmt|;
name|hard_def
operator|->
name|red
operator|=
name|rep
operator|.
name|screenRed
expr_stmt|;
name|hard_def
operator|->
name|green
operator|=
name|rep
operator|.
name|screenGreen
expr_stmt|;
name|hard_def
operator|->
name|blue
operator|=
name|rep
operator|.
name|screenBlue
expr_stmt|;
name|exact_def
operator|->
name|pixel
operator|=
name|hard_def
operator|->
name|pixel
operator|=
name|rep
operator|.
name|pixel
expr_stmt|;
name|UnlockDisplay
argument_list|(
name|dpy
argument_list|)
expr_stmt|;
name|SyncHandle
argument_list|()
expr_stmt|;
return|return
operator|(
literal|1
operator|)
return|;
block|}
end_block

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/* $XConsortium: XFont.c,v 11.38 91/12/19 18:14:14 rws Exp $ */
end_comment

begin_comment
comment|/* Copyright    Massachusetts Institute of Technology    1986	*/
end_comment

begin_comment
comment|/* Permission to use, copy, modify, distribute, and sell this software and its documentation for any purpose is hereby granted without fee, provided that the above copyright notice appear in all copies and that both that copyright notice and this permission notice appear in supporting documentation, and that the name of M.I.T. not be used in advertising or publicity pertaining to distribution of the software without specific, written prior permission.  M.I.T. makes no representations about the suitability of this software for any purpose.  It is provided "as is" without express or implied warranty. */
end_comment

begin_define
define|#
directive|define
name|NEED_REPLIES
end_define

begin_include
include|#
directive|include
file|"Xlibint.h"
end_include

begin_function_decl
specifier|static
name|int
name|_XQueryFont
parameter_list|()
function_decl|;
end_function_decl

begin_if
if|#
directive|if
name|NeedFunctionPrototypes
end_if

begin_decl_stmt
name|XFontStruct
modifier|*
name|XLoadQueryFont
argument_list|(
specifier|register
name|Display
operator|*
name|dpy
argument_list|,
name|_Xconst
name|char
operator|*
name|name
argument_list|)
else|#
directive|else
name|XFontStruct
modifier|*
name|XLoadQueryFont
argument_list|(
name|dpy
argument_list|,
name|name
argument_list|)
decl|register
name|Display
modifier|*
name|dpy
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|char
modifier|*
name|name
decl_stmt|;
end_decl_stmt

begin_endif
endif|#
directive|endif
end_endif

begin_block
block|{
name|XFontStruct
modifier|*
name|font_result
decl_stmt|;
specifier|register
name|long
name|nbytes
decl_stmt|;
name|Font
name|fid
decl_stmt|;
name|xOpenFontReq
modifier|*
name|req
decl_stmt|;
name|int
name|seqadj
init|=
literal|1
decl_stmt|;
name|int
name|error_status
decl_stmt|;
name|LockDisplay
argument_list|(
name|dpy
argument_list|)
expr_stmt|;
name|GetReq
argument_list|(
name|OpenFont
argument_list|,
name|req
argument_list|)
expr_stmt|;
name|nbytes
operator|=
name|req
operator|->
name|nbytes
operator|=
name|name
condition|?
name|strlen
argument_list|(
name|name
argument_list|)
else|:
literal|0
expr_stmt|;
name|req
operator|->
name|fid
operator|=
name|fid
operator|=
name|XAllocID
argument_list|(
name|dpy
argument_list|)
expr_stmt|;
name|req
operator|->
name|length
operator|+=
operator|(
name|nbytes
operator|+
literal|3
operator|)
operator|>>
literal|2
expr_stmt|;
name|Data
argument_list|(
name|dpy
argument_list|,
name|name
argument_list|,
name|nbytes
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|WORD64
comment|/*       *  If a NoOp is generated, the sequence number will be off      *  by one, so this temporarily adjusts the sequence number.      */
if|if
condition|(
operator|(
name|long
operator|)
name|dpy
operator|->
name|bufptr
operator|>>
literal|61
condition|)
name|seqadj
operator|=
literal|2
expr_stmt|;
endif|#
directive|endif
name|dpy
operator|->
name|request
operator|-=
name|seqadj
expr_stmt|;
name|error_status
operator|=
name|_XQueryFont
argument_list|(
name|dpy
argument_list|,
name|fid
argument_list|,
operator|&
name|font_result
argument_list|)
expr_stmt|;
name|dpy
operator|->
name|request
operator|+=
name|seqadj
expr_stmt|;
if|if
condition|(
name|error_status
condition|)
block|{
name|font_result
operator|=
operator|(
name|XFontStruct
operator|*
operator|)
name|NULL
expr_stmt|;
if|if
condition|(
name|error_status
operator|==
literal|1
condition|)
block|{
comment|/* if _XQueryFont returned 1, then the OpenFont request got 	       a BadName error.  This means that the following QueryFont 	       request is guaranteed to get a BadFont error, since the id 	       passed to QueryFont wasn't really a valid font id.  To read 	       and discard this second error, we call _XReply again. */
name|xReply
name|reply
decl_stmt|;
operator|(
name|void
operator|)
name|_XReply
argument_list|(
name|dpy
argument_list|,
operator|&
name|reply
argument_list|,
literal|0
argument_list|,
name|xFalse
argument_list|)
expr_stmt|;
block|}
block|}
name|UnlockDisplay
argument_list|(
name|dpy
argument_list|)
expr_stmt|;
name|SyncHandle
argument_list|()
expr_stmt|;
return|return
name|font_result
return|;
block|}
end_block

begin_expr_stmt
name|XFreeFont
argument_list|(
name|dpy
argument_list|,
name|fs
argument_list|)
specifier|register
name|Display
operator|*
name|dpy
expr_stmt|;
end_expr_stmt

begin_decl_stmt
name|XFontStruct
modifier|*
name|fs
decl_stmt|;
end_decl_stmt

begin_block
block|{
specifier|register
name|xResourceReq
modifier|*
name|req
decl_stmt|;
specifier|register
name|_XExtension
modifier|*
name|ext
init|=
name|dpy
operator|->
name|ext_procs
decl_stmt|;
name|LockDisplay
argument_list|(
name|dpy
argument_list|)
expr_stmt|;
while|while
condition|(
name|ext
condition|)
block|{
comment|/* call out to any extensions interested */
if|if
condition|(
name|ext
operator|->
name|free_Font
operator|!=
name|NULL
condition|)
call|(
modifier|*
name|ext
operator|->
name|free_Font
call|)
argument_list|(
name|dpy
argument_list|,
name|fs
argument_list|,
operator|&
name|ext
operator|->
name|codes
argument_list|)
expr_stmt|;
name|ext
operator|=
name|ext
operator|->
name|next
expr_stmt|;
block|}
name|GetResReq
argument_list|(
name|CloseFont
argument_list|,
name|fs
operator|->
name|fid
argument_list|,
name|req
argument_list|)
expr_stmt|;
name|UnlockDisplay
argument_list|(
name|dpy
argument_list|)
expr_stmt|;
name|SyncHandle
argument_list|()
expr_stmt|;
name|_XFreeExtData
argument_list|(
name|fs
operator|->
name|ext_data
argument_list|)
expr_stmt|;
if|if
condition|(
name|fs
operator|->
name|per_char
condition|)
name|Xfree
argument_list|(
operator|(
name|char
operator|*
operator|)
name|fs
operator|->
name|per_char
argument_list|)
expr_stmt|;
if|if
condition|(
name|fs
operator|->
name|properties
condition|)
name|Xfree
argument_list|(
operator|(
name|char
operator|*
operator|)
name|fs
operator|->
name|properties
argument_list|)
expr_stmt|;
name|Xfree
argument_list|(
operator|(
name|char
operator|*
operator|)
name|fs
argument_list|)
expr_stmt|;
block|}
end_block

begin_comment
comment|/*  * Returns:	0	success  *		1	protocol error  *		2	Xlib memory allocation failed  */
end_comment

begin_function
specifier|static
name|int
name|_XQueryFont
parameter_list|(
name|dpy
parameter_list|,
name|fid
parameter_list|,
name|xfs
parameter_list|)
comment|/* Internal-only entry point */
specifier|register
name|Display
modifier|*
name|dpy
decl_stmt|;
name|Font
name|fid
decl_stmt|;
name|XFontStruct
modifier|*
modifier|*
name|xfs
decl_stmt|;
comment|/* RETURN */
block|{
specifier|register
name|XFontStruct
modifier|*
name|fs
decl_stmt|;
specifier|register
name|long
name|nbytes
decl_stmt|;
name|xQueryFontReply
name|reply
decl_stmt|;
specifier|register
name|xResourceReq
modifier|*
name|req
decl_stmt|;
specifier|register
name|_XExtension
modifier|*
name|ext
decl_stmt|;
name|GetResReq
argument_list|(
name|QueryFont
argument_list|,
name|fid
argument_list|,
name|req
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|_XReply
argument_list|(
name|dpy
argument_list|,
operator|(
name|xReply
operator|*
operator|)
operator|&
name|reply
argument_list|,
operator|(
operator|(
name|SIZEOF
argument_list|(
name|xQueryFontReply
argument_list|)
operator|-
name|SIZEOF
argument_list|(
name|xReply
argument_list|)
operator|)
operator|>>
literal|2
operator|)
argument_list|,
name|xFalse
argument_list|)
condition|)
return|return
literal|1
return|;
if|if
condition|(
operator|!
operator|(
name|fs
operator|=
operator|(
name|XFontStruct
operator|*
operator|)
name|Xmalloc
argument_list|(
sizeof|sizeof
argument_list|(
name|XFontStruct
argument_list|)
argument_list|)
operator|)
condition|)
return|return
literal|2
return|;
name|fs
operator|->
name|ext_data
operator|=
name|NULL
expr_stmt|;
name|fs
operator|->
name|fid
operator|=
name|fid
expr_stmt|;
name|fs
operator|->
name|direction
operator|=
name|reply
operator|.
name|drawDirection
expr_stmt|;
name|fs
operator|->
name|min_char_or_byte2
operator|=
name|reply
operator|.
name|minCharOrByte2
expr_stmt|;
name|fs
operator|->
name|max_char_or_byte2
operator|=
name|reply
operator|.
name|maxCharOrByte2
expr_stmt|;
name|fs
operator|->
name|min_byte1
operator|=
name|reply
operator|.
name|minByte1
expr_stmt|;
name|fs
operator|->
name|max_byte1
operator|=
name|reply
operator|.
name|maxByte1
expr_stmt|;
name|fs
operator|->
name|default_char
operator|=
name|reply
operator|.
name|defaultChar
expr_stmt|;
name|fs
operator|->
name|all_chars_exist
operator|=
name|reply
operator|.
name|allCharsExist
expr_stmt|;
name|fs
operator|->
name|ascent
operator|=
name|cvtINT16toInt
argument_list|(
name|reply
operator|.
name|fontAscent
argument_list|)
expr_stmt|;
name|fs
operator|->
name|descent
operator|=
name|cvtINT16toInt
argument_list|(
name|reply
operator|.
name|fontDescent
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|MUSTCOPY
block|{
name|xCharInfo
modifier|*
name|xcip
decl_stmt|;
name|xcip
operator|=
operator|(
name|xCharInfo
operator|*
operator|)
operator|&
name|reply
operator|.
name|minBounds
expr_stmt|;
name|fs
operator|->
name|min_bounds
operator|.
name|lbearing
operator|=
name|cvtINT16toShort
argument_list|(
name|xcip
operator|->
name|leftSideBearing
argument_list|)
expr_stmt|;
name|fs
operator|->
name|min_bounds
operator|.
name|rbearing
operator|=
name|cvtINT16toShort
argument_list|(
name|xcip
operator|->
name|rightSideBearing
argument_list|)
expr_stmt|;
name|fs
operator|->
name|min_bounds
operator|.
name|width
operator|=
name|cvtINT16toShort
argument_list|(
name|xcip
operator|->
name|characterWidth
argument_list|)
expr_stmt|;
name|fs
operator|->
name|min_bounds
operator|.
name|ascent
operator|=
name|cvtINT16toShort
argument_list|(
name|xcip
operator|->
name|ascent
argument_list|)
expr_stmt|;
name|fs
operator|->
name|min_bounds
operator|.
name|descent
operator|=
name|cvtINT16toShort
argument_list|(
name|xcip
operator|->
name|descent
argument_list|)
expr_stmt|;
name|fs
operator|->
name|min_bounds
operator|.
name|attributes
operator|=
name|xcip
operator|->
name|attributes
expr_stmt|;
name|xcip
operator|=
operator|(
name|xCharInfo
operator|*
operator|)
operator|&
name|reply
operator|.
name|maxBounds
expr_stmt|;
name|fs
operator|->
name|max_bounds
operator|.
name|lbearing
operator|=
name|cvtINT16toShort
argument_list|(
name|xcip
operator|->
name|leftSideBearing
argument_list|)
expr_stmt|;
name|fs
operator|->
name|max_bounds
operator|.
name|rbearing
operator|=
name|cvtINT16toShort
argument_list|(
name|xcip
operator|->
name|rightSideBearing
argument_list|)
expr_stmt|;
name|fs
operator|->
name|max_bounds
operator|.
name|width
operator|=
name|cvtINT16toShort
argument_list|(
name|xcip
operator|->
name|characterWidth
argument_list|)
expr_stmt|;
name|fs
operator|->
name|max_bounds
operator|.
name|ascent
operator|=
name|cvtINT16toShort
argument_list|(
name|xcip
operator|->
name|ascent
argument_list|)
expr_stmt|;
name|fs
operator|->
name|max_bounds
operator|.
name|descent
operator|=
name|cvtINT16toShort
argument_list|(
name|xcip
operator|->
name|descent
argument_list|)
expr_stmt|;
name|fs
operator|->
name|max_bounds
operator|.
name|attributes
operator|=
name|xcip
operator|->
name|attributes
expr_stmt|;
block|}
else|#
directive|else
comment|/* XXX the next two statements won't work if short isn't 16 bits */
name|fs
operator|->
name|min_bounds
operator|=
operator|*
operator|(
name|XCharStruct
operator|*
operator|)
operator|&
name|reply
operator|.
name|minBounds
expr_stmt|;
name|fs
operator|->
name|max_bounds
operator|=
operator|*
operator|(
name|XCharStruct
operator|*
operator|)
operator|&
name|reply
operator|.
name|maxBounds
expr_stmt|;
endif|#
directive|endif
comment|/* MUSTCOPY */
name|fs
operator|->
name|n_properties
operator|=
name|reply
operator|.
name|nFontProps
expr_stmt|;
comment|/*       * if no properties defined for the font, then it is bad      * font, but shouldn't try to read nothing.      */
name|fs
operator|->
name|properties
operator|=
name|NULL
expr_stmt|;
if|if
condition|(
name|fs
operator|->
name|n_properties
operator|>
literal|0
condition|)
block|{
name|nbytes
operator|=
name|reply
operator|.
name|nFontProps
operator|*
sizeof|sizeof
argument_list|(
name|XFontProp
argument_list|)
expr_stmt|;
name|fs
operator|->
name|properties
operator|=
operator|(
name|XFontProp
operator|*
operator|)
name|Xmalloc
argument_list|(
operator|(
name|unsigned
operator|)
name|nbytes
argument_list|)
expr_stmt|;
name|nbytes
operator|=
name|reply
operator|.
name|nFontProps
operator|*
name|SIZEOF
argument_list|(
name|xFontProp
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|fs
operator|->
name|properties
condition|)
block|{
name|Xfree
argument_list|(
operator|(
name|char
operator|*
operator|)
name|fs
argument_list|)
expr_stmt|;
name|_XEatData
argument_list|(
name|dpy
argument_list|,
call|(
name|unsigned
name|long
call|)
argument_list|(
name|nbytes
operator|+
name|reply
operator|.
name|nCharInfos
operator|*
name|SIZEOF
argument_list|(
name|xCharInfo
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
return|return
literal|2
return|;
block|}
name|_XRead32
argument_list|(
name|dpy
argument_list|,
operator|(
name|char
operator|*
operator|)
name|fs
operator|->
name|properties
argument_list|,
name|nbytes
argument_list|)
expr_stmt|;
block|}
comment|/*      * If no characters in font, then it is a bad font, but      * shouldn't try to read nothing.      */
comment|/* have to unpack charinfos on some machines (CRAY) */
name|fs
operator|->
name|per_char
operator|=
name|NULL
expr_stmt|;
if|if
condition|(
name|reply
operator|.
name|nCharInfos
operator|>
literal|0
condition|)
block|{
name|nbytes
operator|=
name|reply
operator|.
name|nCharInfos
operator|*
sizeof|sizeof
argument_list|(
name|XCharStruct
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|fs
operator|->
name|per_char
operator|=
operator|(
name|XCharStruct
operator|*
operator|)
name|Xmalloc
argument_list|(
operator|(
name|unsigned
operator|)
name|nbytes
argument_list|)
operator|)
condition|)
block|{
if|if
condition|(
name|fs
operator|->
name|n_properties
condition|)
name|Xfree
argument_list|(
operator|(
name|char
operator|*
operator|)
name|fs
operator|->
name|n_properties
argument_list|)
expr_stmt|;
name|Xfree
argument_list|(
operator|(
name|char
operator|*
operator|)
name|fs
argument_list|)
expr_stmt|;
name|_XEatData
argument_list|(
name|dpy
argument_list|,
call|(
name|unsigned
name|long
call|)
argument_list|(
name|reply
operator|.
name|nCharInfos
operator|*
name|SIZEOF
argument_list|(
name|xCharInfo
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
return|return
literal|2
return|;
block|}
ifdef|#
directive|ifdef
name|MUSTCOPY
block|{
specifier|register
name|XCharStruct
modifier|*
name|cs
init|=
name|fs
operator|->
name|per_char
decl_stmt|;
specifier|register
name|int
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|reply
operator|.
name|nCharInfos
condition|;
name|i
operator|++
operator|,
name|cs
operator|++
control|)
block|{
name|xCharInfo
name|xcip
decl_stmt|;
name|_XRead
argument_list|(
name|dpy
argument_list|,
operator|&
name|xcip
argument_list|,
name|SIZEOF
argument_list|(
name|xCharInfo
argument_list|)
argument_list|)
expr_stmt|;
name|cs
operator|->
name|lbearing
operator|=
name|cvtINT16toShort
argument_list|(
name|xcip
operator|.
name|leftSideBearing
argument_list|)
expr_stmt|;
name|cs
operator|->
name|rbearing
operator|=
name|cvtINT16toShort
argument_list|(
name|xcip
operator|.
name|rightSideBearing
argument_list|)
expr_stmt|;
name|cs
operator|->
name|width
operator|=
name|cvtINT16toShort
argument_list|(
name|xcip
operator|.
name|characterWidth
argument_list|)
expr_stmt|;
name|cs
operator|->
name|ascent
operator|=
name|cvtINT16toShort
argument_list|(
name|xcip
operator|.
name|ascent
argument_list|)
expr_stmt|;
name|cs
operator|->
name|descent
operator|=
name|cvtINT16toShort
argument_list|(
name|xcip
operator|.
name|descent
argument_list|)
expr_stmt|;
name|cs
operator|->
name|attributes
operator|=
name|xcip
operator|.
name|attributes
expr_stmt|;
block|}
block|}
else|#
directive|else
name|nbytes
operator|=
name|reply
operator|.
name|nCharInfos
operator|*
name|SIZEOF
argument_list|(
name|xCharInfo
argument_list|)
expr_stmt|;
name|_XRead16
argument_list|(
name|dpy
argument_list|,
operator|(
name|char
operator|*
operator|)
name|fs
operator|->
name|per_char
argument_list|,
name|nbytes
argument_list|)
expr_stmt|;
endif|#
directive|endif
block|}
name|ext
operator|=
name|dpy
operator|->
name|ext_procs
expr_stmt|;
while|while
condition|(
name|ext
condition|)
block|{
comment|/* call out to any extensions interested */
if|if
condition|(
name|ext
operator|->
name|create_Font
operator|!=
name|NULL
condition|)
call|(
modifier|*
name|ext
operator|->
name|create_Font
call|)
argument_list|(
name|dpy
argument_list|,
name|fs
argument_list|,
operator|&
name|ext
operator|->
name|codes
argument_list|)
expr_stmt|;
name|ext
operator|=
name|ext
operator|->
name|next
expr_stmt|;
block|}
operator|*
name|xfs
operator|=
name|fs
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|XFontStruct
modifier|*
name|XQueryFont
parameter_list|(
name|dpy
parameter_list|,
name|fid
parameter_list|)
specifier|register
name|Display
modifier|*
name|dpy
decl_stmt|;
name|Font
name|fid
decl_stmt|;
block|{
name|XFontStruct
modifier|*
name|font_result
decl_stmt|;
name|LockDisplay
argument_list|(
name|dpy
argument_list|)
expr_stmt|;
if|if
condition|(
name|_XQueryFont
argument_list|(
name|dpy
argument_list|,
name|fid
argument_list|,
operator|&
name|font_result
argument_list|)
operator|>
literal|0
condition|)
name|font_result
operator|=
operator|(
name|XFontStruct
operator|*
operator|)
name|NULL
expr_stmt|;
name|UnlockDisplay
argument_list|(
name|dpy
argument_list|)
expr_stmt|;
name|SyncHandle
argument_list|()
expr_stmt|;
return|return
name|font_result
return|;
block|}
end_function

end_unit


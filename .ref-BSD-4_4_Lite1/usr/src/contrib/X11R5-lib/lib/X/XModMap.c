begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/* $XConsortium: XModMap.c,v 11.12 91/01/06 11:47:03 rws Exp $ */
end_comment

begin_comment
comment|/* Copyright    Massachusetts Institute of Technology    1986	*/
end_comment

begin_comment
comment|/* Permission to use, copy, modify, distribute, and sell this software and its documentation for any purpose is hereby granted without fee, provided that the above copyright notice appear in all copies and that both that copyright notice and this permission notice appear in supporting documentation, and that the name of M.I.T. not be used in advertising or publicity pertaining to distribution of the software without specific, written prior permission.  M.I.T. makes no representations about the suitability of this software for any purpose.  It is provided "as is" without express or implied warranty. */
end_comment

begin_define
define|#
directive|define
name|NEED_REPLIES
end_define

begin_include
include|#
directive|include
file|"Xlibint.h"
end_include

begin_function
name|XModifierKeymap
modifier|*
name|XGetModifierMapping
parameter_list|(
name|dpy
parameter_list|)
specifier|register
name|Display
modifier|*
name|dpy
decl_stmt|;
block|{
name|xGetModifierMappingReply
name|rep
decl_stmt|;
specifier|register
name|xReq
modifier|*
name|req
decl_stmt|;
name|unsigned
name|long
name|nbytes
decl_stmt|;
name|XModifierKeymap
modifier|*
name|res
decl_stmt|;
name|LockDisplay
argument_list|(
name|dpy
argument_list|)
expr_stmt|;
name|GetEmptyReq
argument_list|(
name|GetModifierMapping
argument_list|,
name|req
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|_XReply
argument_list|(
name|dpy
argument_list|,
operator|(
name|xReply
operator|*
operator|)
operator|&
name|rep
argument_list|,
literal|0
argument_list|,
name|xFalse
argument_list|)
expr_stmt|;
name|nbytes
operator|=
operator|(
name|unsigned
name|long
operator|)
name|rep
operator|.
name|length
operator|<<
literal|2
expr_stmt|;
name|res
operator|=
operator|(
name|XModifierKeymap
operator|*
operator|)
name|Xmalloc
argument_list|(
sizeof|sizeof
argument_list|(
name|XModifierKeymap
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|res
condition|)
name|res
operator|->
name|modifiermap
operator|=
operator|(
name|KeyCode
operator|*
operator|)
name|Xmalloc
argument_list|(
operator|(
name|unsigned
operator|)
name|nbytes
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
operator|!
name|res
operator|)
operator|||
operator|(
operator|!
name|res
operator|->
name|modifiermap
operator|)
condition|)
block|{
if|if
condition|(
name|res
condition|)
name|Xfree
argument_list|(
operator|(
name|char
operator|*
operator|)
name|res
argument_list|)
expr_stmt|;
name|res
operator|=
operator|(
name|XModifierKeymap
operator|*
operator|)
name|NULL
expr_stmt|;
name|_XEatData
argument_list|(
name|dpy
argument_list|,
name|nbytes
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|_XReadPad
argument_list|(
name|dpy
argument_list|,
operator|(
name|char
operator|*
operator|)
name|res
operator|->
name|modifiermap
argument_list|,
operator|(
name|long
operator|)
name|nbytes
argument_list|)
expr_stmt|;
name|res
operator|->
name|max_keypermod
operator|=
name|rep
operator|.
name|numKeyPerModifier
expr_stmt|;
block|}
name|UnlockDisplay
argument_list|(
name|dpy
argument_list|)
expr_stmt|;
name|SyncHandle
argument_list|()
expr_stmt|;
return|return
operator|(
name|res
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  *	Returns:  *	0	Success  *	1	Busy - one or more old or new modifiers are down  *	2	Failed - one or more new modifiers unacceptable  */
end_comment

begin_function
name|int
name|XSetModifierMapping
parameter_list|(
name|dpy
parameter_list|,
name|modifier_map
parameter_list|)
specifier|register
name|Display
modifier|*
name|dpy
decl_stmt|;
specifier|register
name|XModifierKeymap
modifier|*
name|modifier_map
decl_stmt|;
block|{
specifier|register
name|xSetModifierMappingReq
modifier|*
name|req
decl_stmt|;
name|xSetModifierMappingReply
name|rep
decl_stmt|;
name|int
name|mapSize
init|=
name|modifier_map
operator|->
name|max_keypermod
operator|<<
literal|3
decl_stmt|;
comment|/* 8 modifiers */
name|LockDisplay
argument_list|(
name|dpy
argument_list|)
expr_stmt|;
name|GetReqExtra
argument_list|(
name|SetModifierMapping
argument_list|,
name|mapSize
argument_list|,
name|req
argument_list|)
expr_stmt|;
name|req
operator|->
name|numKeyPerModifier
operator|=
name|modifier_map
operator|->
name|max_keypermod
expr_stmt|;
name|bcopy
argument_list|(
operator|(
name|char
operator|*
operator|)
name|modifier_map
operator|->
name|modifiermap
argument_list|,
operator|(
name|char
operator|*
operator|)
name|NEXTPTR
argument_list|(
name|req
argument_list|,
name|xSetModifierMappingReq
argument_list|)
argument_list|,
name|mapSize
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|_XReply
argument_list|(
name|dpy
argument_list|,
operator|(
name|xReply
operator|*
operator|)
operator|&
name|rep
argument_list|,
operator|(
name|SIZEOF
argument_list|(
name|xSetModifierMappingReply
argument_list|)
operator|-
name|SIZEOF
argument_list|(
name|xReply
argument_list|)
operator|)
operator|>>
literal|2
argument_list|,
name|xTrue
argument_list|)
expr_stmt|;
name|UnlockDisplay
argument_list|(
name|dpy
argument_list|)
expr_stmt|;
name|SyncHandle
argument_list|()
expr_stmt|;
return|return
operator|(
name|rep
operator|.
name|success
operator|)
return|;
block|}
end_function

begin_function
name|XModifierKeymap
modifier|*
name|XNewModifiermap
parameter_list|(
name|keyspermodifier
parameter_list|)
name|int
name|keyspermodifier
decl_stmt|;
block|{
name|XModifierKeymap
modifier|*
name|res
init|=
operator|(
name|XModifierKeymap
operator|*
operator|)
name|Xmalloc
argument_list|(
operator|(
sizeof|sizeof
argument_list|(
name|XModifierKeymap
argument_list|)
operator|)
argument_list|)
decl_stmt|;
if|if
condition|(
name|res
condition|)
block|{
name|res
operator|->
name|max_keypermod
operator|=
name|keyspermodifier
expr_stmt|;
name|res
operator|->
name|modifiermap
operator|=
operator|(
name|keyspermodifier
operator|>
literal|0
condition|?
operator|(
name|KeyCode
operator|*
operator|)
name|Xmalloc
argument_list|(
call|(
name|unsigned
call|)
argument_list|(
literal|8
operator|*
name|keyspermodifier
argument_list|)
argument_list|)
else|:
operator|(
name|KeyCode
operator|*
operator|)
name|NULL
operator|)
expr_stmt|;
if|if
condition|(
name|keyspermodifier
operator|&&
operator|(
name|res
operator|->
name|modifiermap
operator|==
name|NULL
operator|)
condition|)
block|{
name|Xfree
argument_list|(
operator|(
name|char
operator|*
operator|)
name|res
argument_list|)
expr_stmt|;
return|return
operator|(
name|XModifierKeymap
operator|*
operator|)
name|NULL
return|;
block|}
block|}
return|return
operator|(
name|res
operator|)
return|;
block|}
end_function

begin_macro
name|XFreeModifiermap
argument_list|(
argument|map
argument_list|)
end_macro

begin_decl_stmt
name|XModifierKeymap
modifier|*
name|map
decl_stmt|;
end_decl_stmt

begin_block
block|{
if|if
condition|(
name|map
condition|)
block|{
if|if
condition|(
name|map
operator|->
name|modifiermap
condition|)
name|Xfree
argument_list|(
operator|(
name|char
operator|*
operator|)
name|map
operator|->
name|modifiermap
argument_list|)
expr_stmt|;
name|Xfree
argument_list|(
operator|(
name|char
operator|*
operator|)
name|map
argument_list|)
expr_stmt|;
block|}
block|}
end_block

begin_if
if|#
directive|if
name|NeedFunctionPrototypes
end_if

begin_function
name|XModifierKeymap
modifier|*
name|XInsertModifiermapEntry
parameter_list|(
name|XModifierKeymap
modifier|*
name|map
parameter_list|,
if|#
directive|if
name|NeedWidePrototypes
name|unsigned
name|int
name|keycode
parameter_list|,
else|#
directive|else
name|KeyCode
name|keycode
parameter_list|,
endif|#
directive|endif
name|int
name|modifier
parameter_list|)
else|#
directive|else
function|XModifierKeymap * XInsertModifiermapEntry
parameter_list|(
name|map
parameter_list|,
name|keycode
parameter_list|,
name|modifier
parameter_list|)
name|XModifierKeymap
modifier|*
name|map
decl_stmt|;
name|KeyCode
name|keycode
decl_stmt|;
name|int
name|modifier
decl_stmt|;
endif|#
directive|endif
block|{
name|XModifierKeymap
modifier|*
name|newmap
decl_stmt|;
name|int
name|i
decl_stmt|,
name|row
init|=
name|modifier
operator|*
name|map
operator|->
name|max_keypermod
decl_stmt|,
name|newrow
decl_stmt|,
name|lastrow
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|map
operator|->
name|max_keypermod
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|map
operator|->
name|modifiermap
index|[
name|row
operator|+
name|i
index|]
operator|==
name|keycode
condition|)
return|return
operator|(
name|map
operator|)
return|;
comment|/* already in the map */
if|if
condition|(
name|map
operator|->
name|modifiermap
index|[
name|row
operator|+
name|i
index|]
operator|==
literal|0
condition|)
block|{
name|map
operator|->
name|modifiermap
index|[
name|row
operator|+
name|i
index|]
operator|=
name|keycode
expr_stmt|;
return|return
operator|(
name|map
operator|)
return|;
comment|/* we added it without stretching the map */
block|}
block|}
comment|/* stretch the map */
if|if
condition|(
operator|(
name|newmap
operator|=
name|XNewModifiermap
argument_list|(
name|map
operator|->
name|max_keypermod
operator|+
literal|1
argument_list|)
operator|)
operator|==
name|NULL
condition|)
return|return
operator|(
name|XModifierKeymap
operator|*
operator|)
name|NULL
return|;
name|newrow
operator|=
name|row
operator|=
literal|0
expr_stmt|;
name|lastrow
operator|=
name|newmap
operator|->
name|max_keypermod
operator|*
literal|8
expr_stmt|;
while|while
condition|(
name|newrow
operator|<
name|lastrow
condition|)
block|{
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|map
operator|->
name|max_keypermod
condition|;
name|i
operator|++
control|)
name|newmap
operator|->
name|modifiermap
index|[
name|newrow
operator|+
name|i
index|]
operator|=
name|map
operator|->
name|modifiermap
index|[
name|row
operator|+
name|i
index|]
expr_stmt|;
name|newmap
operator|->
name|modifiermap
index|[
name|newrow
operator|+
name|i
index|]
operator|=
literal|0
expr_stmt|;
name|row
operator|+=
name|map
operator|->
name|max_keypermod
expr_stmt|;
name|newrow
operator|+=
name|newmap
operator|->
name|max_keypermod
expr_stmt|;
block|}
name|XFreeModifiermap
argument_list|(
name|map
argument_list|)
expr_stmt|;
name|newrow
operator|=
name|newmap
operator|->
name|max_keypermod
operator|*
name|modifier
operator|+
name|newmap
operator|->
name|max_keypermod
operator|-
literal|1
expr_stmt|;
name|newmap
operator|->
name|modifiermap
index|[
name|newrow
index|]
operator|=
name|keycode
expr_stmt|;
return|return
operator|(
name|newmap
operator|)
return|;
block|}
end_function

begin_if
if|#
directive|if
name|NeedFunctionPrototypes
end_if

begin_function
name|XModifierKeymap
modifier|*
name|XDeleteModifiermapEntry
parameter_list|(
name|XModifierKeymap
modifier|*
name|map
parameter_list|,
if|#
directive|if
name|NeedWidePrototypes
name|unsigned
name|int
name|keycode
parameter_list|,
else|#
directive|else
name|KeyCode
name|keycode
parameter_list|,
endif|#
directive|endif
name|int
name|modifier
parameter_list|)
else|#
directive|else
function|XModifierKeymap * XDeleteModifiermapEntry
parameter_list|(
name|map
parameter_list|,
name|keycode
parameter_list|,
name|modifier
parameter_list|)
name|XModifierKeymap
modifier|*
name|map
decl_stmt|;
name|KeyCode
name|keycode
decl_stmt|;
name|int
name|modifier
decl_stmt|;
endif|#
directive|endif
block|{
name|int
name|i
decl_stmt|,
name|row
init|=
name|modifier
operator|*
name|map
operator|->
name|max_keypermod
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|map
operator|->
name|max_keypermod
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|map
operator|->
name|modifiermap
index|[
name|row
operator|+
name|i
index|]
operator|==
name|keycode
condition|)
name|map
operator|->
name|modifiermap
index|[
name|row
operator|+
name|i
index|]
operator|=
literal|0
expr_stmt|;
block|}
comment|/* should we shrink the map?? */
return|return
operator|(
name|map
operator|)
return|;
block|}
end_function

end_unit


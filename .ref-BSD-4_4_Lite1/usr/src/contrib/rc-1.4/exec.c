begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/* exec.c */
end_comment

begin_include
include|#
directive|include
file|<signal.h>
end_include

begin_include
include|#
directive|include
file|<errno.h>
end_include

begin_include
include|#
directive|include
file|<setjmp.h>
end_include

begin_include
include|#
directive|include
file|"rc.h"
end_include

begin_include
include|#
directive|include
file|"jbwrap.h"
end_include

begin_comment
comment|/*    Takes an argument list and does the appropriate thing (calls a    builtin, calls a function, etc.) */
end_comment

begin_function
specifier|extern
name|void
name|exec
parameter_list|(
name|List
modifier|*
name|s
parameter_list|,
name|bool
name|parent
parameter_list|)
block|{
name|char
modifier|*
modifier|*
name|av
decl_stmt|,
modifier|*
modifier|*
name|ev
init|=
name|NULL
decl_stmt|;
name|int
name|pid
decl_stmt|,
name|stat
decl_stmt|;
name|builtin_t
modifier|*
name|b
decl_stmt|;
name|char
modifier|*
name|path
init|=
name|NULL
decl_stmt|;
name|bool
name|didfork
decl_stmt|,
name|returning
decl_stmt|,
name|saw_exec
decl_stmt|,
name|saw_builtin
decl_stmt|;
name|av
operator|=
name|list2array
argument_list|(
name|s
argument_list|,
name|dashex
argument_list|)
expr_stmt|;
name|saw_builtin
operator|=
name|saw_exec
operator|=
name|FALSE
expr_stmt|;
do|do
block|{
if|if
condition|(
operator|*
name|av
operator|==
name|NULL
operator|||
name|isabsolute
argument_list|(
operator|*
name|av
argument_list|)
condition|)
name|b
operator|=
name|NULL
expr_stmt|;
elseif|else
if|if
condition|(
operator|!
name|saw_builtin
operator|&&
name|fnlookup
argument_list|(
operator|*
name|av
argument_list|)
operator|!=
name|NULL
condition|)
name|b
operator|=
name|funcall
expr_stmt|;
else|else
name|b
operator|=
name|isbuiltin
argument_list|(
operator|*
name|av
argument_list|)
expr_stmt|;
comment|/* 		   a builtin applies only to the immmediately following 		   command, e.g., builtin exec echo hi 		*/
name|saw_builtin
operator|=
name|FALSE
expr_stmt|;
if|if
condition|(
name|b
operator|==
name|b_exec
condition|)
block|{
name|av
operator|++
expr_stmt|;
name|saw_exec
operator|=
name|TRUE
expr_stmt|;
name|parent
operator|=
name|FALSE
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|b
operator|==
name|b_builtin
condition|)
block|{
name|av
operator|++
expr_stmt|;
name|saw_builtin
operator|=
name|TRUE
expr_stmt|;
block|}
block|}
do|while
condition|(
name|b
operator|==
name|b_exec
operator|||
name|b
operator|==
name|b_builtin
condition|)
do|;
if|if
condition|(
operator|*
name|av
operator|==
name|NULL
operator|&&
name|saw_exec
condition|)
block|{
comment|/* do redirs and return on a null exec */
name|doredirs
argument_list|()
expr_stmt|;
return|return;
block|}
comment|/* force an exit on exec with any rc_error, but not for null commands as above */
if|if
condition|(
name|saw_exec
condition|)
name|rc_pid
operator|=
operator|-
literal|1
expr_stmt|;
if|if
condition|(
name|b
operator|==
name|NULL
condition|)
block|{
name|path
operator|=
name|which
argument_list|(
operator|*
name|av
argument_list|,
name|TRUE
argument_list|)
expr_stmt|;
if|if
condition|(
name|path
operator|==
name|NULL
operator|&&
operator|*
name|av
operator|!=
name|NULL
condition|)
block|{
comment|/* perform null commands for redirections */
name|set
argument_list|(
name|FALSE
argument_list|)
expr_stmt|;
name|redirq
operator|=
name|NULL
expr_stmt|;
if|if
condition|(
name|parent
condition|)
return|return;
name|rc_exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
name|ev
operator|=
name|makeenv
argument_list|()
expr_stmt|;
comment|/* environment only needs to be built for execve() */
block|}
comment|/* 	   If parent& the redirq is nonnull, builtin or not it has to fork. 	   If the fifoq is nonnull, then it must be emptied at the end so we 	   must fork no matter what. 	 */
if|if
condition|(
operator|(
name|parent
operator|&&
operator|(
name|b
operator|==
name|NULL
operator|||
name|redirq
operator|!=
name|NULL
operator|)
operator|)
operator|||
name|outstanding_cmdarg
argument_list|()
condition|)
block|{
name|pid
operator|=
name|rc_fork
argument_list|()
expr_stmt|;
name|didfork
operator|=
name|TRUE
expr_stmt|;
block|}
else|else
block|{
name|pid
operator|=
literal|0
expr_stmt|;
name|didfork
operator|=
name|FALSE
expr_stmt|;
block|}
name|returning
operator|=
operator|(
operator|!
name|didfork
operator|&&
name|parent
operator|)
expr_stmt|;
switch|switch
condition|(
name|pid
condition|)
block|{
case|case
operator|-
literal|1
case|:
name|uerror
argument_list|(
literal|"fork"
argument_list|)
expr_stmt|;
name|rc_error
argument_list|(
name|NULL
argument_list|)
expr_stmt|;
comment|/* NOTREACHED */
case|case
literal|0
case|:
if|if
condition|(
operator|!
name|returning
condition|)
name|setsigdefaults
argument_list|(
name|FALSE
argument_list|)
expr_stmt|;
name|pop_cmdarg
argument_list|(
name|FALSE
argument_list|)
expr_stmt|;
name|doredirs
argument_list|()
expr_stmt|;
comment|/* null commands performed for redirections */
if|if
condition|(
operator|*
name|av
operator|==
name|NULL
operator|||
name|b
operator|!=
name|NULL
condition|)
block|{
if|if
condition|(
name|b
operator|!=
name|NULL
condition|)
call|(
modifier|*
name|b
call|)
argument_list|(
name|av
argument_list|)
expr_stmt|;
if|if
condition|(
name|returning
condition|)
return|return;
name|rc_exit
argument_list|(
name|getstatus
argument_list|()
argument_list|)
expr_stmt|;
block|}
name|execve
argument_list|(
name|path
argument_list|,
operator|(
name|char
operator|*
specifier|const
operator|*
operator|)
name|av
argument_list|,
operator|(
name|char
operator|*
specifier|const
operator|*
operator|)
name|ev
argument_list|)
expr_stmt|;
name|uerror
argument_list|(
operator|*
name|av
argument_list|)
expr_stmt|;
name|rc_exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
comment|/* NOTREACHED */
default|default:
name|redirq
operator|=
name|NULL
expr_stmt|;
name|rc_wait4
argument_list|(
name|pid
argument_list|,
operator|&
name|stat
argument_list|,
name|TRUE
argument_list|)
expr_stmt|;
name|setstatus
argument_list|(
operator|-
literal|1
argument_list|,
name|stat
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|stat
operator|&
literal|0xff
operator|)
operator|==
literal|0
condition|)
name|nl_on_intr
operator|=
name|FALSE
expr_stmt|;
name|SIGCHK
expr_stmt|;
name|nl_on_intr
operator|=
name|TRUE
expr_stmt|;
name|pop_cmdarg
argument_list|(
name|TRUE
argument_list|)
expr_stmt|;
block|}
block|}
end_function

end_unit


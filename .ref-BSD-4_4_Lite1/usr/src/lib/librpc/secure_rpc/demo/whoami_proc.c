begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_if
if|#
directive|if
name|defined
argument_list|(
name|LIBC_SCCS
argument_list|)
operator|&&
operator|!
name|defined
argument_list|(
name|lint
argument_list|)
end_if

begin_decl_stmt
specifier|static
name|char
name|sccsid
index|[]
init|=
literal|"@(#)whoami_proc.c	2.3 89/07/11 4.0 RPCSRC"
decl_stmt|;
end_decl_stmt

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/*  * whoami_proc.c: secure identity verifier and reporter: server proc  */
end_comment

begin_include
include|#
directive|include
file|<sys/param.h>
end_include

begin_include
include|#
directive|include
file|<rpc/rpc.h>
end_include

begin_include
include|#
directive|include
file|<rpc/key_prot.h>
end_include

begin_include
include|#
directive|include
file|<pwd.h>
end_include

begin_include
include|#
directive|include
file|"whoami.h"
end_include

begin_function_decl
specifier|extern
name|char
modifier|*
name|strcpy
parameter_list|()
function_decl|;
end_function_decl

begin_comment
comment|/*  * Report on the server's notion of the client's identity.  */
end_comment

begin_function
name|remote_identity
modifier|*
name|whoami_iask_1
parameter_list|(
name|nullarg
parameter_list|,
name|rqstp
parameter_list|)
name|void
modifier|*
name|nullarg
decl_stmt|;
name|struct
name|svc_req
modifier|*
name|rqstp
decl_stmt|;
block|{
specifier|static
name|remote_identity
name|whoisthem
decl_stmt|;
specifier|static
name|char
name|username
index|[
name|MAXNETNAMELEN
operator|+
literal|1
index|]
decl_stmt|;
specifier|static
name|char
name|realname
index|[
name|MAXNETNAMELEN
operator|+
literal|1
index|]
decl_stmt|;
comment|/* really gecos field */
specifier|static
name|int
name|grouplist
index|[
name|NGROUPS
index|]
decl_stmt|;
name|char
name|publickey
index|[
name|HEXKEYBYTES
operator|+
literal|1
index|]
decl_stmt|;
name|struct
name|authdes_cred
modifier|*
name|des_cred
decl_stmt|;
name|struct
name|passwd
modifier|*
name|pwdent
decl_stmt|;
switch|switch
condition|(
name|rqstp
operator|->
name|rq_cred
operator|.
name|oa_flavor
condition|)
block|{
case|case
name|AUTH_DES
case|:
name|whoisthem
operator|.
name|remote_username
operator|=
name|username
expr_stmt|;
name|whoisthem
operator|.
name|remote_realname
operator|=
name|realname
expr_stmt|;
name|whoisthem
operator|.
name|gids
operator|.
name|gids_val
operator|=
name|grouplist
expr_stmt|;
name|des_cred
operator|=
operator|(
expr|struct
name|authdes_cred
operator|*
operator|)
name|rqstp
operator|->
name|rq_clntcred
expr_stmt|;
comment|/*          * Check to see if the netname being used is in the public key          * database (if not, reject this (potential) imposter).          */
if|if
condition|(
operator|!
name|getpublickey
argument_list|(
name|des_cred
operator|->
name|adc_fullname
operator|.
name|name
argument_list|,
name|publickey
argument_list|)
condition|)
block|{
name|svcerr_weakauth
argument_list|(
name|rqstp
operator|->
name|rq_xprt
argument_list|)
expr_stmt|;
return|return
operator|(
name|NULL
operator|)
return|;
block|}
comment|/*          * Get the info that the client wants.          */
if|if
condition|(
operator|!
name|netname2user
argument_list|(
name|des_cred
operator|->
name|adc_fullname
operator|.
name|name
argument_list|,
operator|&
name|whoisthem
operator|.
name|uid
argument_list|,
operator|&
name|whoisthem
operator|.
name|gid
argument_list|,
operator|&
name|whoisthem
operator|.
name|gids
operator|.
name|gids_len
argument_list|,
name|whoisthem
operator|.
name|gids
operator|.
name|gids_val
argument_list|)
condition|)
block|{
comment|/* netname not found */
name|whoisthem
operator|.
name|authenticated
operator|=
name|FALSE
expr_stmt|;
name|strcpy
argument_list|(
name|whoisthem
operator|.
name|remote_username
argument_list|,
literal|"nobody"
argument_list|)
expr_stmt|;
name|strcpy
argument_list|(
name|whoisthem
operator|.
name|remote_realname
argument_list|,
literal|"INTERLOPER!"
argument_list|)
expr_stmt|;
name|whoisthem
operator|.
name|uid
operator|=
operator|-
literal|2
expr_stmt|;
name|whoisthem
operator|.
name|gid
operator|=
operator|-
literal|2
expr_stmt|;
name|whoisthem
operator|.
name|gids
operator|.
name|gids_len
operator|=
literal|0
expr_stmt|;
return|return
operator|(
operator|&
name|whoisthem
operator|)
return|;
block|}
comment|/* else we found the netname */
name|whoisthem
operator|.
name|authenticated
operator|=
name|TRUE
expr_stmt|;
name|pwdent
operator|=
name|getpwuid
argument_list|(
name|whoisthem
operator|.
name|uid
argument_list|)
expr_stmt|;
name|strcpy
argument_list|(
name|whoisthem
operator|.
name|remote_username
argument_list|,
name|pwdent
operator|->
name|pw_name
argument_list|)
expr_stmt|;
name|strcpy
argument_list|(
name|whoisthem
operator|.
name|remote_realname
argument_list|,
name|pwdent
operator|->
name|pw_gecos
argument_list|)
expr_stmt|;
return|return
operator|(
operator|&
name|whoisthem
operator|)
return|;
break|break;
case|case
name|AUTH_UNIX
case|:
case|case
name|AUTH_NULL
case|:
default|default:
name|svcerr_weakauth
argument_list|(
name|rqstp
operator|->
name|rq_xprt
argument_list|)
expr_stmt|;
return|return
operator|(
name|NULL
operator|)
return|;
block|}
block|}
end_function

begin_comment
comment|/*  * Return server's netname. AUTH_NONE is valid.  * This routine allows this server to be started under any uid,  * and the client can ask us our netname for use in authdes_create().  */
end_comment

begin_function
name|name
modifier|*
name|whoami_whoru_1
parameter_list|(
name|nullarg
parameter_list|,
name|rqstp
parameter_list|)
name|void
modifier|*
name|nullarg
decl_stmt|;
name|struct
name|svc_req
modifier|*
name|rqstp
decl_stmt|;
block|{
specifier|static
name|name
name|whoru
decl_stmt|;
specifier|static
name|char
name|servername
index|[
name|MAXNETNAMELEN
operator|+
literal|1
index|]
decl_stmt|;
name|whoru
operator|=
name|servername
expr_stmt|;
name|getnetname
argument_list|(
name|servername
argument_list|)
expr_stmt|;
return|return
operator|(
operator|&
name|whoru
operator|)
return|;
block|}
end_function

end_unit


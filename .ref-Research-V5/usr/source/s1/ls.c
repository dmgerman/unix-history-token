begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_empty
empty|#
end_empty

begin_comment
comment|/*  * list file or directory  */
end_comment

begin_struct
struct|struct
block|{
name|int
name|fdes
decl_stmt|;
name|int
name|nleft
decl_stmt|;
name|char
modifier|*
name|nextc
decl_stmt|;
name|char
name|buff
index|[
literal|512
index|]
decl_stmt|;
block|}
name|inf
struct|;
end_struct

begin_struct
struct|struct
name|ibuf
block|{
name|int
name|idev
decl_stmt|;
name|int
name|inum
decl_stmt|;
name|int
name|iflags
decl_stmt|;
name|char
name|inl
decl_stmt|;
name|char
name|iuid
decl_stmt|;
name|char
name|igid
decl_stmt|;
name|char
name|isize0
decl_stmt|;
name|int
name|isize
decl_stmt|;
name|int
name|iaddr
index|[
literal|8
index|]
decl_stmt|;
name|char
modifier|*
name|iatime
index|[
literal|2
index|]
decl_stmt|;
name|char
modifier|*
name|imtime
index|[
literal|2
index|]
decl_stmt|;
block|}
struct|;
end_struct

begin_struct
struct|struct
name|lbuf
block|{
name|char
name|lname
index|[
literal|15
index|]
decl_stmt|;
name|int
name|lnum
decl_stmt|;
name|int
name|lflags
decl_stmt|;
name|char
name|lnl
decl_stmt|;
name|char
name|luid
decl_stmt|;
name|char
name|lgid
decl_stmt|;
name|char
name|lsize0
decl_stmt|;
name|int
name|lsize
decl_stmt|;
name|char
modifier|*
name|lmtime
index|[
literal|2
index|]
decl_stmt|;
block|}
struct|;
end_struct

begin_struct
struct|struct
name|lbufx
block|{
name|char
modifier|*
name|namep
decl_stmt|;
block|}
struct|;
end_struct

begin_decl_stmt
name|int
name|aflg
decl_stmt|,
name|dflg
decl_stmt|,
name|lflg
decl_stmt|,
name|sflg
decl_stmt|,
name|tflg
decl_stmt|,
name|uflg
decl_stmt|,
name|iflg
decl_stmt|,
name|fflg
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|fout
decl_stmt|;
end_decl_stmt

begin_expr_stmt
name|int
name|rflg
literal|1
expr_stmt|;
end_expr_stmt

begin_decl_stmt
name|int
name|flags
decl_stmt|;
end_decl_stmt

begin_expr_stmt
name|int
name|uidfil
operator|-
literal|1
expr_stmt|;
end_expr_stmt

begin_decl_stmt
name|int
name|tblocks
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|statreq
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|struct
name|lbuf
modifier|*
name|lastp
modifier|&
name|end
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|struct
name|lbuf
modifier|*
name|rlastp
modifier|&
name|end
decl_stmt|;
end_decl_stmt

begin_expr_stmt
name|char
operator|*
name|dotp
literal|"."
expr_stmt|;
end_expr_stmt

begin_define
define|#
directive|define
name|IFMT
value|060000
end_define

begin_define
define|#
directive|define
name|DIR
value|0100000
end_define

begin_define
define|#
directive|define
name|CHR
value|020000
end_define

begin_define
define|#
directive|define
name|BLK
value|040000
end_define

begin_define
define|#
directive|define
name|ISARG
value|01000
end_define

begin_define
define|#
directive|define
name|LARGE
value|010000
end_define

begin_define
define|#
directive|define
name|STXT
value|010000
end_define

begin_define
define|#
directive|define
name|SUID
value|04000
end_define

begin_define
define|#
directive|define
name|SGID
value|02000
end_define

begin_define
define|#
directive|define
name|ROWN
value|0400
end_define

begin_define
define|#
directive|define
name|WOWN
value|0200
end_define

begin_define
define|#
directive|define
name|XOWN
value|0100
end_define

begin_define
define|#
directive|define
name|RGRP
value|040
end_define

begin_define
define|#
directive|define
name|WGRP
value|020
end_define

begin_define
define|#
directive|define
name|XGRP
value|010
end_define

begin_define
define|#
directive|define
name|ROTH
value|04
end_define

begin_define
define|#
directive|define
name|WOTH
value|02
end_define

begin_define
define|#
directive|define
name|XOTH
value|01
end_define

begin_define
define|#
directive|define
name|RSTXT
value|01000
end_define

begin_function
name|main
parameter_list|(
name|argc
parameter_list|,
name|argv
parameter_list|)
name|char
modifier|*
modifier|*
name|argv
decl_stmt|;
block|{
name|int
name|i
decl_stmt|,
name|j
decl_stmt|;
specifier|extern
name|struct
name|lbuf
name|end
decl_stmt|;
specifier|register
name|struct
name|lbuf
modifier|*
name|ep
decl_stmt|,
modifier|*
name|ep1
decl_stmt|;
specifier|register
name|struct
name|lbuf
modifier|*
name|slastp
decl_stmt|;
name|struct
name|lbuf
name|lb
decl_stmt|;
name|int
name|compar
parameter_list|()
function_decl|;
name|fout
operator|=
name|dup
argument_list|(
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
operator|--
name|argc
operator|>
literal|0
operator|&&
operator|*
name|argv
index|[
literal|1
index|]
operator|==
literal|'-'
condition|)
block|{
name|argv
operator|++
expr_stmt|;
while|while
condition|(
operator|*
operator|++
operator|*
name|argv
condition|)
switch|switch
condition|(
operator|*
operator|*
name|argv
condition|)
block|{
case|case
literal|'a'
case|:
name|aflg
operator|++
expr_stmt|;
continue|continue;
case|case
literal|'s'
case|:
name|sflg
operator|++
expr_stmt|;
name|statreq
operator|++
expr_stmt|;
continue|continue;
case|case
literal|'d'
case|:
name|dflg
operator|++
expr_stmt|;
continue|continue;
case|case
literal|'l'
case|:
name|lflg
operator|++
expr_stmt|;
name|statreq
operator|++
expr_stmt|;
name|uidfil
operator|=
name|open
argument_list|(
literal|"/etc/passwd"
argument_list|,
literal|0
argument_list|)
expr_stmt|;
continue|continue;
case|case
literal|'r'
case|:
name|rflg
operator|=
operator|-
literal|1
expr_stmt|;
continue|continue;
case|case
literal|'t'
case|:
name|tflg
operator|++
expr_stmt|;
name|statreq
operator|++
expr_stmt|;
continue|continue;
case|case
literal|'u'
case|:
name|uflg
operator|++
expr_stmt|;
continue|continue;
case|case
literal|'i'
case|:
name|iflg
operator|++
expr_stmt|;
continue|continue;
case|case
literal|'f'
case|:
name|fflg
operator|++
expr_stmt|;
continue|continue;
default|default:
continue|continue;
block|}
name|argc
operator|--
expr_stmt|;
block|}
if|if
condition|(
name|fflg
condition|)
block|{
name|aflg
operator|++
expr_stmt|;
name|lflg
operator|=
literal|0
expr_stmt|;
name|sflg
operator|=
literal|0
expr_stmt|;
name|tflg
operator|=
literal|0
expr_stmt|;
name|statreq
operator|=
literal|0
expr_stmt|;
block|}
if|if
condition|(
name|argc
operator|==
literal|0
condition|)
block|{
name|argc
operator|++
expr_stmt|;
name|argv
operator|=
operator|&
name|dotp
operator|-
literal|1
expr_stmt|;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|argc
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
operator|(
name|ep
operator|=
name|gstat
argument_list|(
operator|*
operator|++
name|argv
argument_list|,
literal|1
argument_list|)
operator|)
operator|==
literal|0
condition|)
continue|continue;
name|ep
operator|->
name|namep
operator|=
operator|*
name|argv
expr_stmt|;
name|ep
operator|->
name|lflags
operator|=
operator||
name|ISARG
expr_stmt|;
block|}
name|qsort
argument_list|(
operator|&
name|end
argument_list|,
name|lastp
operator|-
operator|&
name|end
argument_list|,
sizeof|sizeof
expr|*
name|lastp
argument_list|,
name|compar
argument_list|)
expr_stmt|;
name|slastp
operator|=
name|lastp
expr_stmt|;
for|for
control|(
name|ep
operator|=
operator|&
name|end
init|;
name|ep
operator|<
name|slastp
condition|;
name|ep
operator|++
control|)
block|{
if|if
condition|(
name|ep
operator|->
name|lflags
operator|&
name|DIR
operator|&&
name|dflg
operator|==
literal|0
operator|||
name|fflg
condition|)
block|{
if|if
condition|(
name|argc
operator|>
literal|1
condition|)
name|printf
argument_list|(
literal|"\n%s:\n"
argument_list|,
name|ep
operator|->
name|namep
argument_list|)
expr_stmt|;
name|lastp
operator|=
name|slastp
expr_stmt|;
name|readdir
argument_list|(
name|ep
operator|->
name|namep
argument_list|)
expr_stmt|;
if|if
condition|(
name|fflg
operator|==
literal|0
condition|)
name|qsort
argument_list|(
name|slastp
argument_list|,
name|lastp
operator|-
name|slastp
argument_list|,
sizeof|sizeof
expr|*
name|lastp
argument_list|,
name|compar
argument_list|)
expr_stmt|;
if|if
condition|(
name|statreq
condition|)
name|printf
argument_list|(
literal|"total %d\n"
argument_list|,
name|tblocks
argument_list|)
expr_stmt|;
for|for
control|(
name|ep1
operator|=
name|slastp
init|;
name|ep1
operator|<
name|lastp
condition|;
name|ep1
operator|++
control|)
name|pentry
argument_list|(
name|ep1
argument_list|)
expr_stmt|;
block|}
else|else
name|pentry
argument_list|(
name|ep
argument_list|)
expr_stmt|;
block|}
name|flush
argument_list|()
expr_stmt|;
block|}
end_function

begin_macro
name|pentry
argument_list|(
argument|ap
argument_list|)
end_macro

begin_decl_stmt
name|struct
name|lbuf
modifier|*
name|ap
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|char
name|tbuf
index|[
literal|16
index|]
decl_stmt|;
struct|struct
block|{
name|char
name|dminor
decl_stmt|,
name|dmajor
decl_stmt|;
block|}
struct|;
specifier|register
name|struct
name|lbuf
modifier|*
name|p
decl_stmt|;
name|p
operator|=
name|ap
expr_stmt|;
if|if
condition|(
name|p
operator|->
name|lnum
operator|==
operator|-
literal|1
condition|)
return|return;
if|if
condition|(
name|iflg
condition|)
name|printf
argument_list|(
literal|"%5d "
argument_list|,
name|p
operator|->
name|lnum
argument_list|)
expr_stmt|;
if|if
condition|(
name|lflg
condition|)
block|{
name|pmode
argument_list|(
name|p
operator|->
name|lflags
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"%2d "
argument_list|,
name|p
operator|->
name|lnl
argument_list|)
expr_stmt|;
if|if
condition|(
name|getname
argument_list|(
name|p
operator|->
name|luid
operator|&
literal|0377
argument_list|,
name|tbuf
argument_list|)
operator|==
literal|0
condition|)
name|printf
argument_list|(
literal|"%-6.6s"
argument_list|,
name|tbuf
argument_list|)
expr_stmt|;
else|else
name|printf
argument_list|(
literal|"%-6d"
argument_list|,
name|p
operator|->
name|luid
operator|&
literal|0377
argument_list|)
expr_stmt|;
if|if
condition|(
name|p
operator|->
name|lflags
operator|&
operator|(
name|BLK
operator||
name|CHR
operator|)
condition|)
name|printf
argument_list|(
literal|"%3d,%3d"
argument_list|,
name|p
operator|->
name|lsize
operator|.
name|dmajor
operator|&
literal|0377
argument_list|,
name|p
operator|->
name|lsize
operator|.
name|dminor
operator|&
literal|0377
argument_list|)
expr_stmt|;
else|else
name|printf
argument_list|(
literal|"%7s"
argument_list|,
name|locv
argument_list|(
name|p
operator|->
name|lsize0
argument_list|,
name|p
operator|->
name|lsize
argument_list|)
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|" %-12.12s "
argument_list|,
name|ctime
argument_list|(
name|p
operator|->
name|lmtime
argument_list|)
operator|+
literal|4
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|sflg
condition|)
name|printf
argument_list|(
literal|"%4d "
argument_list|,
name|nblock
argument_list|(
name|p
operator|->
name|lsize0
argument_list|,
name|p
operator|->
name|lsize
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|p
operator|->
name|lflags
operator|&
name|ISARG
condition|)
name|printf
argument_list|(
literal|"%s\n"
argument_list|,
name|p
operator|->
name|namep
argument_list|)
expr_stmt|;
else|else
name|printf
argument_list|(
literal|"%.14s\n"
argument_list|,
name|p
operator|->
name|lname
argument_list|)
expr_stmt|;
block|}
end_block

begin_macro
name|getname
argument_list|(
argument|uid
argument_list|,
argument|buf
argument_list|)
end_macro

begin_decl_stmt
name|int
name|uid
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|char
name|buf
index|[]
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|int
name|j
decl_stmt|,
name|c
decl_stmt|,
name|n
decl_stmt|,
name|i
decl_stmt|;
name|inf
operator|.
name|fdes
operator|=
name|uidfil
expr_stmt|;
name|seek
argument_list|(
name|inf
operator|.
name|fdes
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|inf
operator|.
name|nleft
operator|=
literal|0
expr_stmt|;
do|do
block|{
name|i
operator|=
literal|0
expr_stmt|;
name|j
operator|=
literal|0
expr_stmt|;
name|n
operator|=
literal|0
expr_stmt|;
while|while
condition|(
operator|(
name|c
operator|=
name|getc
argument_list|(
operator|&
name|inf
argument_list|)
operator|)
operator|!=
literal|'\n'
condition|)
block|{
if|if
condition|(
name|c
operator|<
literal|0
condition|)
return|return
operator|(
operator|-
literal|1
operator|)
return|;
if|if
condition|(
name|c
operator|==
literal|':'
condition|)
block|{
name|j
operator|++
expr_stmt|;
name|c
operator|=
literal|'0'
expr_stmt|;
block|}
if|if
condition|(
name|j
operator|==
literal|0
condition|)
name|buf
index|[
name|i
operator|++
index|]
operator|=
name|c
expr_stmt|;
if|if
condition|(
name|j
operator|==
literal|2
condition|)
name|n
operator|=
name|n
operator|*
literal|10
operator|+
name|c
operator|-
literal|'0'
expr_stmt|;
block|}
block|}
do|while
condition|(
name|n
operator|!=
name|uid
condition|)
do|;
name|buf
index|[
name|i
operator|++
index|]
operator|=
literal|'\0'
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_block

begin_macro
name|nblock
argument_list|(
argument|size0
argument_list|,
argument|size
argument_list|)
end_macro

begin_decl_stmt
name|char
modifier|*
name|size0
decl_stmt|,
modifier|*
name|size
decl_stmt|;
end_decl_stmt

begin_block
block|{
specifier|register
name|int
name|n
decl_stmt|;
name|n
operator|=
name|ldiv
argument_list|(
name|size0
argument_list|,
name|size
argument_list|,
literal|512
argument_list|)
expr_stmt|;
if|if
condition|(
name|size
operator|&
literal|0777
condition|)
name|n
operator|++
expr_stmt|;
if|if
condition|(
name|n
operator|>
literal|8
condition|)
name|n
operator|=
operator|+
operator|(
name|n
operator|+
literal|255
operator|)
operator|/
literal|256
expr_stmt|;
return|return
operator|(
name|n
operator|)
return|;
block|}
end_block

begin_decl_stmt
name|int
name|m0
index|[]
block|{
literal|3
operator|,
name|DIR
operator|,
literal|'d'
operator|,
name|BLK
operator|,
literal|'b'
operator|,
name|CHR
operator|,
literal|'c'
operator|,
literal|'-'
block|}
end_decl_stmt

begin_empty_stmt
empty_stmt|;
end_empty_stmt

begin_decl_stmt
name|int
name|m1
index|[]
block|{
literal|1
operator|,
name|ROWN
operator|,
literal|'r'
operator|,
literal|'-'
block|}
end_decl_stmt

begin_empty_stmt
empty_stmt|;
end_empty_stmt

begin_decl_stmt
name|int
name|m2
index|[]
block|{
literal|1
operator|,
name|WOWN
operator|,
literal|'w'
operator|,
literal|'-'
block|}
end_decl_stmt

begin_empty_stmt
empty_stmt|;
end_empty_stmt

begin_decl_stmt
name|int
name|m3
index|[]
block|{
literal|2
operator|,
name|SUID
operator|,
literal|'s'
operator|,
name|XOWN
operator|,
literal|'x'
operator|,
literal|'-'
block|}
end_decl_stmt

begin_empty_stmt
empty_stmt|;
end_empty_stmt

begin_decl_stmt
name|int
name|m4
index|[]
block|{
literal|1
operator|,
name|RGRP
operator|,
literal|'r'
operator|,
literal|'-'
block|}
end_decl_stmt

begin_empty_stmt
empty_stmt|;
end_empty_stmt

begin_decl_stmt
name|int
name|m5
index|[]
block|{
literal|1
operator|,
name|WGRP
operator|,
literal|'w'
operator|,
literal|'-'
block|}
end_decl_stmt

begin_empty_stmt
empty_stmt|;
end_empty_stmt

begin_decl_stmt
name|int
name|m6
index|[]
block|{
literal|2
operator|,
name|SGID
operator|,
literal|'s'
operator|,
name|XGRP
operator|,
literal|'x'
operator|,
literal|'-'
block|}
end_decl_stmt

begin_empty_stmt
empty_stmt|;
end_empty_stmt

begin_decl_stmt
name|int
name|m7
index|[]
block|{
literal|1
operator|,
name|ROTH
operator|,
literal|'r'
operator|,
literal|'-'
block|}
end_decl_stmt

begin_empty_stmt
empty_stmt|;
end_empty_stmt

begin_decl_stmt
name|int
name|m8
index|[]
block|{
literal|1
operator|,
name|WOTH
operator|,
literal|'w'
operator|,
literal|'-'
block|}
end_decl_stmt

begin_empty_stmt
empty_stmt|;
end_empty_stmt

begin_decl_stmt
name|int
name|m9
index|[]
block|{
literal|1
operator|,
name|XOTH
operator|,
literal|'x'
operator|,
literal|'-'
block|}
end_decl_stmt

begin_empty_stmt
empty_stmt|;
end_empty_stmt

begin_decl_stmt
name|int
name|m10
index|[]
block|{
literal|1
operator|,
name|STXT
operator|,
literal|'t'
operator|,
literal|' '
block|}
end_decl_stmt

begin_empty_stmt
empty_stmt|;
end_empty_stmt

begin_decl_stmt
name|int
modifier|*
name|m
index|[]
block|{
name|m0
operator|,
name|m1
operator|,
name|m2
operator|,
name|m3
operator|,
name|m4
operator|,
name|m5
operator|,
name|m6
operator|,
name|m7
operator|,
name|m8
operator|,
name|m9
operator|,
name|m10
block|}
end_decl_stmt

begin_empty_stmt
empty_stmt|;
end_empty_stmt

begin_macro
name|pmode
argument_list|(
argument|aflag
argument_list|)
end_macro

begin_block
block|{
specifier|register
name|int
modifier|*
modifier|*
name|mp
decl_stmt|;
name|flags
operator|=
name|aflag
expr_stmt|;
for|for
control|(
name|mp
operator|=
operator|&
name|m
index|[
literal|0
index|]
init|;
name|mp
operator|<
operator|&
name|m
index|[
literal|11
index|]
condition|;
control|)
name|select
argument_list|(
operator|*
name|mp
operator|++
argument_list|)
expr_stmt|;
block|}
end_block

begin_macro
name|select
argument_list|(
argument|pairp
argument_list|)
end_macro

begin_decl_stmt
name|int
modifier|*
name|pairp
decl_stmt|;
end_decl_stmt

begin_block
block|{
specifier|register
name|int
name|n
decl_stmt|,
modifier|*
name|ap
decl_stmt|;
name|ap
operator|=
name|pairp
expr_stmt|;
name|n
operator|=
operator|*
name|ap
operator|++
expr_stmt|;
while|while
condition|(
operator|--
name|n
operator|>=
literal|0
operator|&&
operator|(
name|flags
operator|&
operator|*
name|ap
operator|++
operator|)
operator|==
literal|0
condition|)
name|ap
operator|++
expr_stmt|;
name|putchar
argument_list|(
operator|*
name|ap
argument_list|)
expr_stmt|;
block|}
end_block

begin_macro
name|makename
argument_list|(
argument|dir
argument_list|,
argument|file
argument_list|)
end_macro

begin_decl_stmt
name|char
modifier|*
name|dir
decl_stmt|,
modifier|*
name|file
decl_stmt|;
end_decl_stmt

begin_block
block|{
specifier|static
name|char
name|dfile
index|[
literal|100
index|]
decl_stmt|;
specifier|register
name|char
modifier|*
name|dp
decl_stmt|,
modifier|*
name|fp
decl_stmt|;
specifier|register
name|int
name|i
decl_stmt|;
name|dp
operator|=
name|dfile
expr_stmt|;
name|fp
operator|=
name|dir
expr_stmt|;
while|while
condition|(
operator|*
name|fp
condition|)
operator|*
name|dp
operator|++
operator|=
operator|*
name|fp
operator|++
expr_stmt|;
operator|*
name|dp
operator|++
operator|=
literal|'/'
expr_stmt|;
name|fp
operator|=
name|file
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|14
condition|;
name|i
operator|++
control|)
operator|*
name|dp
operator|++
operator|=
operator|*
name|fp
operator|++
expr_stmt|;
operator|*
name|dp
operator|=
literal|0
expr_stmt|;
return|return
operator|(
name|dfile
operator|)
return|;
block|}
end_block

begin_macro
name|readdir
argument_list|(
argument|dir
argument_list|)
end_macro

begin_decl_stmt
name|char
modifier|*
name|dir
decl_stmt|;
end_decl_stmt

begin_block
block|{
specifier|static
struct|struct
block|{
name|int
name|dinode
decl_stmt|;
name|char
name|dname
index|[
literal|14
index|]
decl_stmt|;
block|}
name|dentry
struct|;
specifier|register
name|char
modifier|*
name|p
decl_stmt|;
specifier|register
name|int
name|j
decl_stmt|;
specifier|register
name|struct
name|lbuf
modifier|*
name|ep
decl_stmt|;
if|if
condition|(
name|fopen
argument_list|(
name|dir
argument_list|,
operator|&
name|inf
argument_list|)
operator|<
literal|0
condition|)
block|{
name|printf
argument_list|(
literal|"%s unreadable\n"
argument_list|,
name|dir
argument_list|)
expr_stmt|;
return|return;
block|}
name|tblocks
operator|=
literal|0
expr_stmt|;
for|for
control|(
init|;
condition|;
control|)
block|{
name|p
operator|=
operator|&
name|dentry
expr_stmt|;
for|for
control|(
name|j
operator|=
literal|0
init|;
name|j
operator|<
literal|16
condition|;
name|j
operator|++
control|)
operator|*
name|p
operator|++
operator|=
name|getc
argument_list|(
operator|&
name|inf
argument_list|)
expr_stmt|;
if|if
condition|(
name|dentry
operator|.
name|dinode
operator|==
literal|0
operator|||
name|aflg
operator|==
literal|0
operator|&&
name|dentry
operator|.
name|dname
index|[
literal|0
index|]
operator|==
literal|'.'
condition|)
continue|continue;
if|if
condition|(
name|dentry
operator|.
name|dinode
operator|==
operator|-
literal|1
condition|)
break|break;
name|ep
operator|=
name|gstat
argument_list|(
name|makename
argument_list|(
name|dir
argument_list|,
name|dentry
operator|.
name|dname
argument_list|)
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|ep
operator|->
name|lnum
operator|!=
operator|-
literal|1
condition|)
name|ep
operator|->
name|lnum
operator|=
name|dentry
operator|.
name|dinode
expr_stmt|;
for|for
control|(
name|j
operator|=
literal|0
init|;
name|j
operator|<
literal|14
condition|;
name|j
operator|++
control|)
name|ep
operator|->
name|lname
index|[
name|j
index|]
operator|=
name|dentry
operator|.
name|dname
index|[
name|j
index|]
expr_stmt|;
block|}
name|close
argument_list|(
name|inf
operator|.
name|fdes
argument_list|)
expr_stmt|;
block|}
end_block

begin_macro
name|gstat
argument_list|(
argument|file
argument_list|,
argument|argfl
argument_list|)
end_macro

begin_decl_stmt
name|char
modifier|*
name|file
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|struct
name|ibuf
name|statb
decl_stmt|;
specifier|register
name|struct
name|lbuf
modifier|*
name|rep
decl_stmt|;
if|if
condition|(
name|lastp
operator|+
literal|1
operator|>=
name|rlastp
condition|)
block|{
name|sbrk
argument_list|(
literal|512
argument_list|)
expr_stmt|;
name|rlastp
operator|.
name|idev
operator|=
operator|+
literal|512
expr_stmt|;
block|}
name|rep
operator|=
name|lastp
expr_stmt|;
name|lastp
operator|++
expr_stmt|;
name|rep
operator|->
name|lflags
operator|=
literal|0
expr_stmt|;
name|rep
operator|->
name|lnum
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|argfl
operator|||
name|statreq
condition|)
block|{
if|if
condition|(
name|stat
argument_list|(
name|file
argument_list|,
operator|&
name|statb
argument_list|)
operator|<
literal|0
condition|)
block|{
name|printf
argument_list|(
literal|"%s not found\n"
argument_list|,
name|file
argument_list|)
expr_stmt|;
name|statb
operator|.
name|inum
operator|=
operator|-
literal|1
expr_stmt|;
name|statb
operator|.
name|isize0
operator|=
literal|0
expr_stmt|;
name|statb
operator|.
name|isize
operator|=
literal|0
expr_stmt|;
name|statb
operator|.
name|iflags
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|argfl
condition|)
block|{
name|lastp
operator|--
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
block|}
name|rep
operator|->
name|lnum
operator|=
name|statb
operator|.
name|inum
expr_stmt|;
name|statb
operator|.
name|iflags
operator|=
operator|&
operator|~
name|DIR
expr_stmt|;
if|if
condition|(
operator|(
name|statb
operator|.
name|iflags
operator|&
name|IFMT
operator|)
operator|==
literal|060000
condition|)
block|{
name|statb
operator|.
name|iflags
operator|=
operator|&
operator|~
literal|020000
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|(
name|statb
operator|.
name|iflags
operator|&
name|IFMT
operator|)
operator|==
literal|040000
condition|)
block|{
name|statb
operator|.
name|iflags
operator|=
operator|&
operator|~
name|IFMT
expr_stmt|;
name|statb
operator|.
name|iflags
operator|=
operator||
name|DIR
expr_stmt|;
block|}
name|statb
operator|.
name|iflags
operator|=
operator|&
operator|~
name|LARGE
expr_stmt|;
if|if
condition|(
name|statb
operator|.
name|iflags
operator|&
name|RSTXT
condition|)
name|statb
operator|.
name|iflags
operator|=
operator||
name|STXT
expr_stmt|;
name|statb
operator|.
name|iflags
operator|=
operator|&
operator|~
name|RSTXT
expr_stmt|;
name|rep
operator|->
name|lflags
operator|=
name|statb
operator|.
name|iflags
expr_stmt|;
name|rep
operator|->
name|luid
operator|=
name|statb
operator|.
name|iuid
expr_stmt|;
name|rep
operator|->
name|lgid
operator|=
name|statb
operator|.
name|igid
expr_stmt|;
name|rep
operator|->
name|lnl
operator|=
name|statb
operator|.
name|inl
expr_stmt|;
name|rep
operator|->
name|lsize0
operator|=
name|statb
operator|.
name|isize0
expr_stmt|;
name|rep
operator|->
name|lsize
operator|=
name|statb
operator|.
name|isize
expr_stmt|;
if|if
condition|(
name|rep
operator|->
name|lflags
operator|&
operator|(
name|BLK
operator||
name|CHR
operator|)
operator|&&
name|lflg
condition|)
name|rep
operator|->
name|lsize
operator|=
name|statb
operator|.
name|iaddr
index|[
literal|0
index|]
expr_stmt|;
name|rep
operator|->
name|lmtime
index|[
literal|0
index|]
operator|=
name|statb
operator|.
name|imtime
index|[
literal|0
index|]
expr_stmt|;
name|rep
operator|->
name|lmtime
index|[
literal|1
index|]
operator|=
name|statb
operator|.
name|imtime
index|[
literal|1
index|]
expr_stmt|;
if|if
condition|(
name|uflg
condition|)
block|{
name|rep
operator|->
name|lmtime
index|[
literal|0
index|]
operator|=
name|statb
operator|.
name|iatime
index|[
literal|0
index|]
expr_stmt|;
name|rep
operator|->
name|lmtime
index|[
literal|1
index|]
operator|=
name|statb
operator|.
name|iatime
index|[
literal|1
index|]
expr_stmt|;
block|}
name|tblocks
operator|=
operator|+
name|nblock
argument_list|(
name|statb
operator|.
name|isize0
argument_list|,
name|statb
operator|.
name|isize
argument_list|)
expr_stmt|;
block|}
return|return
operator|(
name|rep
operator|)
return|;
block|}
end_block

begin_macro
name|compar
argument_list|(
argument|ap1
argument_list|,
argument|ap2
argument_list|)
end_macro

begin_decl_stmt
name|struct
name|lbuf
modifier|*
name|ap1
decl_stmt|,
modifier|*
name|ap2
decl_stmt|;
end_decl_stmt

begin_block
block|{
specifier|register
name|struct
name|lbuf
modifier|*
name|p1
decl_stmt|,
modifier|*
name|p2
decl_stmt|;
specifier|register
name|int
name|i
decl_stmt|;
name|int
name|j
decl_stmt|;
struct|struct
block|{
name|char
modifier|*
name|charp
decl_stmt|;
block|}
struct|;
name|p1
operator|=
name|ap1
expr_stmt|;
name|p2
operator|=
name|ap2
expr_stmt|;
if|if
condition|(
name|dflg
operator|==
literal|0
condition|)
block|{
if|if
condition|(
operator|(
name|p1
operator|->
name|lflags
operator|&
operator|(
name|DIR
operator||
name|ISARG
operator|)
operator|)
operator|==
operator|(
name|DIR
operator||
name|ISARG
operator|)
condition|)
block|{
if|if
condition|(
operator|(
name|p2
operator|->
name|lflags
operator|&
operator|(
name|DIR
operator||
name|ISARG
operator|)
operator|)
operator|!=
operator|(
name|DIR
operator||
name|ISARG
operator|)
condition|)
return|return
operator|(
literal|1
operator|)
return|;
block|}
else|else
block|{
if|if
condition|(
operator|(
name|p2
operator|->
name|lflags
operator|&
operator|(
name|DIR
operator||
name|ISARG
operator|)
operator|)
operator|==
operator|(
name|DIR
operator||
name|ISARG
operator|)
condition|)
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
block|}
if|if
condition|(
name|tflg
condition|)
block|{
name|i
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|p2
operator|->
name|lmtime
index|[
literal|0
index|]
operator|>
name|p1
operator|->
name|lmtime
index|[
literal|0
index|]
condition|)
name|i
operator|++
expr_stmt|;
elseif|else
if|if
condition|(
name|p2
operator|->
name|lmtime
index|[
literal|0
index|]
operator|<
name|p1
operator|->
name|lmtime
index|[
literal|0
index|]
condition|)
name|i
operator|--
expr_stmt|;
elseif|else
if|if
condition|(
name|p2
operator|->
name|lmtime
index|[
literal|1
index|]
operator|>
name|p1
operator|->
name|lmtime
index|[
literal|1
index|]
condition|)
name|i
operator|++
expr_stmt|;
elseif|else
if|if
condition|(
name|p2
operator|->
name|lmtime
index|[
literal|1
index|]
operator|<
name|p1
operator|->
name|lmtime
index|[
literal|1
index|]
condition|)
name|i
operator|--
expr_stmt|;
return|return
operator|(
name|i
operator|*
name|rflg
operator|)
return|;
block|}
if|if
condition|(
name|p1
operator|->
name|lflags
operator|&
name|ISARG
condition|)
name|p1
operator|=
name|p1
operator|->
name|namep
expr_stmt|;
else|else
name|p1
operator|=
name|p1
operator|->
name|lname
expr_stmt|;
if|if
condition|(
name|p2
operator|->
name|lflags
operator|&
name|ISARG
condition|)
name|p2
operator|=
name|p2
operator|->
name|namep
expr_stmt|;
else|else
name|p2
operator|=
name|p2
operator|->
name|lname
expr_stmt|;
for|for
control|(
init|;
condition|;
control|)
if|if
condition|(
operator|(
name|j
operator|=
operator|*
name|p1
operator|.
name|charp
operator|++
operator|-
operator|*
name|p2
operator|.
name|charp
operator|++
operator|)
operator|||
name|p1
operator|.
name|charp
index|[
operator|-
literal|1
index|]
operator|==
literal|0
condition|)
return|return
operator|(
name|rflg
operator|*
name|j
operator|)
return|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_block

end_unit


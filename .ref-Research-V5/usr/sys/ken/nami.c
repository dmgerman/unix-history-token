begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_empty
empty|#
end_empty

begin_comment
comment|/*  *	Copyright 1973 Bell Telephone Laboratories Inc  */
end_comment

begin_include
include|#
directive|include
file|"../param.h"
end_include

begin_include
include|#
directive|include
file|"../inode.h"
end_include

begin_include
include|#
directive|include
file|"../user.h"
end_include

begin_include
include|#
directive|include
file|"../systm.h"
end_include

begin_include
include|#
directive|include
file|"../buf.h"
end_include

begin_macro
name|namei
argument_list|(
argument|func
argument_list|,
argument|flag
argument_list|)
end_macro

begin_function_decl
name|int
function_decl|(
modifier|*
name|func
function_decl|)
parameter_list|()
function_decl|;
end_function_decl

begin_decl_stmt
name|int
name|flag
decl_stmt|;
end_decl_stmt

begin_comment
comment|/*  * func = function called to get name  *&uchar if name is in user space  *&schar if name is in system space  * flag = 0 if name is saught  *	1 if name is to be created  *	2 if name is to be deleted  * return is incremented locked inode.  *	NULL if name not found  */
end_comment

begin_block
block|{
specifier|register
name|struct
name|inode
modifier|*
name|dp
decl_stmt|;
specifier|register
name|c
expr_stmt|;
specifier|register
name|char
modifier|*
name|cp
decl_stmt|;
name|int
name|eo
decl_stmt|,
modifier|*
name|bp
decl_stmt|;
comment|/* 	 * start from indicated 	 * directory 	 */
name|dp
operator|=
name|u
operator|.
name|u_cdir
expr_stmt|;
if|if
condition|(
operator|(
name|c
operator|=
call|(
modifier|*
name|func
call|)
argument_list|()
operator|)
operator|==
literal|'/'
condition|)
name|dp
operator|=
name|rootdir
expr_stmt|;
name|iget
argument_list|(
name|dp
operator|->
name|i_dev
argument_list|,
name|dp
operator|->
name|i_number
argument_list|)
expr_stmt|;
while|while
condition|(
name|c
operator|==
literal|'/'
condition|)
name|c
operator|=
call|(
modifier|*
name|func
call|)
argument_list|()
expr_stmt|;
if|if
condition|(
name|c
operator|==
literal|'\0'
operator|&&
name|flag
operator|!=
literal|0
condition|)
block|{
name|u
operator|.
name|u_error
operator|=
name|ENOENT
expr_stmt|;
goto|goto
name|out
goto|;
block|}
name|cloop
label|:
comment|/* 	 * here dp contains pointer 	 * to last component matched. 	 */
if|if
condition|(
name|u
operator|.
name|u_error
condition|)
goto|goto
name|out
goto|;
if|if
condition|(
name|c
operator|==
literal|'\0'
condition|)
return|return
operator|(
name|dp
operator|)
return|;
comment|/* 	 * if there is another component, 	 * dp must be a directory and 	 * must have x permission 	 */
if|if
condition|(
operator|(
name|dp
operator|->
name|i_mode
operator|&
name|IFMT
operator|)
operator|!=
name|IFDIR
condition|)
block|{
name|u
operator|.
name|u_error
operator|=
name|ENOTDIR
expr_stmt|;
goto|goto
name|out
goto|;
block|}
if|if
condition|(
name|access
argument_list|(
name|dp
argument_list|,
name|IEXEC
argument_list|)
condition|)
goto|goto
name|out
goto|;
comment|/* 	 * gather up name into 	 * users' dir buffer 	 */
name|cp
operator|=
operator|&
name|u
operator|.
name|u_dbuf
index|[
literal|0
index|]
expr_stmt|;
while|while
condition|(
name|c
operator|!=
literal|'/'
operator|&&
name|c
operator|!=
literal|'\0'
operator|&&
name|u
operator|.
name|u_error
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|cp
operator|<
operator|&
name|u
operator|.
name|u_dbuf
index|[
name|DIRSIZ
index|]
condition|)
operator|*
name|cp
operator|++
operator|=
name|c
expr_stmt|;
name|c
operator|=
call|(
modifier|*
name|func
call|)
argument_list|()
expr_stmt|;
block|}
while|while
condition|(
name|cp
operator|<
operator|&
name|u
operator|.
name|u_dbuf
index|[
name|DIRSIZ
index|]
condition|)
operator|*
name|cp
operator|++
operator|=
literal|'\0'
expr_stmt|;
while|while
condition|(
name|c
operator|==
literal|'/'
condition|)
name|c
operator|=
call|(
modifier|*
name|func
call|)
argument_list|()
expr_stmt|;
if|if
condition|(
name|u
operator|.
name|u_error
condition|)
goto|goto
name|out
goto|;
comment|/* 	 * search the directory 	 */
name|u
operator|.
name|u_offset
index|[
literal|1
index|]
operator|=
literal|0
expr_stmt|;
name|u
operator|.
name|u_offset
index|[
literal|0
index|]
operator|=
literal|0
expr_stmt|;
name|u
operator|.
name|u_segflg
operator|=
literal|1
expr_stmt|;
name|eo
operator|=
literal|0
expr_stmt|;
name|u
operator|.
name|u_count
operator|=
name|ldiv
argument_list|(
name|dp
operator|->
name|i_size1
argument_list|,
name|DIRSIZ
operator|+
literal|2
argument_list|)
expr_stmt|;
name|bp
operator|=
name|NULL
expr_stmt|;
name|eloop
label|:
if|if
condition|(
name|u
operator|.
name|u_count
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|bp
operator|!=
name|NULL
condition|)
name|brelse
argument_list|(
name|bp
argument_list|)
expr_stmt|;
if|if
condition|(
name|flag
operator|==
literal|1
operator|&&
name|c
operator|==
literal|'\0'
condition|)
block|{
if|if
condition|(
name|access
argument_list|(
name|dp
argument_list|,
name|IWRITE
argument_list|)
condition|)
goto|goto
name|out
goto|;
name|u
operator|.
name|u_pdir
operator|=
name|dp
expr_stmt|;
if|if
condition|(
name|eo
condition|)
name|u
operator|.
name|u_offset
index|[
literal|1
index|]
operator|=
name|eo
operator|-
name|DIRSIZ
operator|-
literal|2
expr_stmt|;
else|else
name|dp
operator|->
name|i_flag
operator|=
operator||
name|IUPD
expr_stmt|;
return|return
operator|(
name|NULL
operator|)
return|;
block|}
name|u
operator|.
name|u_error
operator|=
name|ENOENT
expr_stmt|;
goto|goto
name|out
goto|;
block|}
if|if
condition|(
operator|(
name|u
operator|.
name|u_offset
index|[
literal|1
index|]
operator|&
literal|0777
operator|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|bp
operator|!=
name|NULL
condition|)
name|brelse
argument_list|(
name|bp
argument_list|)
expr_stmt|;
name|bp
operator|=
name|bread
argument_list|(
name|dp
operator|->
name|i_dev
argument_list|,
name|bmap
argument_list|(
name|dp
argument_list|,
name|ldiv
argument_list|(
name|u
operator|.
name|u_offset
index|[
literal|1
index|]
argument_list|,
literal|512
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|bcopy
argument_list|(
name|bp
operator|->
name|b_addr
operator|+
operator|(
name|u
operator|.
name|u_offset
index|[
literal|1
index|]
operator|&
literal|0777
operator|)
argument_list|,
operator|&
name|u
operator|.
name|u_dent
argument_list|,
operator|(
name|DIRSIZ
operator|+
literal|2
operator|)
operator|/
literal|2
argument_list|)
expr_stmt|;
name|u
operator|.
name|u_offset
index|[
literal|1
index|]
operator|=
operator|+
name|DIRSIZ
operator|+
literal|2
expr_stmt|;
name|u
operator|.
name|u_count
operator|--
expr_stmt|;
if|if
condition|(
name|u
operator|.
name|u_dent
operator|.
name|u_ino
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|eo
operator|==
literal|0
condition|)
name|eo
operator|=
name|u
operator|.
name|u_offset
index|[
literal|1
index|]
expr_stmt|;
goto|goto
name|eloop
goto|;
block|}
for|for
control|(
name|cp
operator|=
operator|&
name|u
operator|.
name|u_dbuf
index|[
literal|0
index|]
init|;
name|cp
operator|<
operator|&
name|u
operator|.
name|u_dbuf
index|[
name|DIRSIZ
index|]
condition|;
name|cp
operator|++
control|)
if|if
condition|(
operator|*
name|cp
operator|!=
name|cp
index|[
name|u
operator|.
name|u_dent
operator|.
name|u_name
operator|-
name|u
operator|.
name|u_dbuf
index|]
condition|)
goto|goto
name|eloop
goto|;
if|if
condition|(
name|bp
operator|!=
name|NULL
condition|)
name|brelse
argument_list|(
name|bp
argument_list|)
expr_stmt|;
if|if
condition|(
name|flag
operator|==
literal|2
operator|&&
name|c
operator|==
literal|'\0'
condition|)
block|{
if|if
condition|(
name|access
argument_list|(
name|dp
argument_list|,
name|IWRITE
argument_list|)
condition|)
goto|goto
name|out
goto|;
return|return
operator|(
name|dp
operator|)
return|;
block|}
name|bp
operator|=
name|dp
operator|->
name|i_dev
expr_stmt|;
name|iput
argument_list|(
name|dp
argument_list|)
expr_stmt|;
name|dp
operator|=
name|iget
argument_list|(
name|bp
argument_list|,
name|u
operator|.
name|u_dent
operator|.
name|u_ino
argument_list|)
expr_stmt|;
if|if
condition|(
name|dp
operator|==
name|NULL
condition|)
return|return
operator|(
name|NULL
operator|)
return|;
goto|goto
name|cloop
goto|;
name|out
label|:
name|iput
argument_list|(
name|dp
argument_list|)
expr_stmt|;
return|return
operator|(
name|NULL
operator|)
return|;
block|}
end_block

begin_macro
name|schar
argument_list|()
end_macro

begin_block
block|{
return|return
operator|(
operator|*
name|u
operator|.
name|u_dirp
operator|++
operator|&
literal|0377
operator|)
return|;
block|}
end_block

begin_macro
name|uchar
argument_list|()
end_macro

begin_block
block|{
specifier|register
name|c
expr_stmt|;
name|c
operator|=
name|fubyte
argument_list|(
name|u
operator|.
name|u_dirp
operator|++
argument_list|)
expr_stmt|;
if|if
condition|(
name|c
operator|==
operator|-
literal|1
condition|)
name|u
operator|.
name|u_error
operator|=
name|EFAULT
expr_stmt|;
return|return
operator|(
name|c
operator|)
return|;
block|}
end_block

end_unit


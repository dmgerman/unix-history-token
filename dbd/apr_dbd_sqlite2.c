begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/* Licensed to the Apache Software Foundation (ASF) under one or more  * contributor license agreements.  See the NOTICE file distributed with  * this work for additional information regarding copyright ownership.  * The ASF licenses this file to You under the Apache License, Version 2.0  * (the "License"); you may not use this file except in compliance with  * the License.  You may obtain a copy of the License at  *  *     http://www.apache.org/licenses/LICENSE-2.0  *  * Unless required by applicable law or agreed to in writing, software  * distributed under the License is distributed on an "AS IS" BASIS,  * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.  * See the License for the specific language governing permissions and  * limitations under the License.  */
end_comment

begin_include
include|#
directive|include
file|"apu.h"
end_include

begin_if
if|#
directive|if
name|APU_HAVE_SQLITE2
end_if

begin_include
include|#
directive|include
file|<ctype.h>
end_include

begin_include
include|#
directive|include
file|<stdlib.h>
end_include

begin_include
include|#
directive|include
file|<sqlite.h>
end_include

begin_include
include|#
directive|include
file|"apr_strings.h"
end_include

begin_include
include|#
directive|include
file|"apr_time.h"
end_include

begin_include
include|#
directive|include
file|"apr_buckets.h"
end_include

begin_include
include|#
directive|include
file|"apr_dbd_internal.h"
end_include

begin_struct
struct|struct
name|apr_dbd_transaction_t
block|{
name|int
name|mode
decl_stmt|;
name|int
name|errnum
decl_stmt|;
name|apr_dbd_t
modifier|*
name|handle
decl_stmt|;
block|}
struct|;
end_struct

begin_struct
struct|struct
name|apr_dbd_t
block|{
name|sqlite
modifier|*
name|conn
decl_stmt|;
name|char
modifier|*
name|errmsg
decl_stmt|;
name|apr_dbd_transaction_t
modifier|*
name|trans
decl_stmt|;
block|}
struct|;
end_struct

begin_struct
struct|struct
name|apr_dbd_results_t
block|{
name|int
name|random
decl_stmt|;
name|sqlite
modifier|*
name|handle
decl_stmt|;
name|char
modifier|*
modifier|*
name|res
decl_stmt|;
name|size_t
name|ntuples
decl_stmt|;
name|size_t
name|sz
decl_stmt|;
name|size_t
name|index
decl_stmt|;
name|apr_pool_t
modifier|*
name|pool
decl_stmt|;
block|}
struct|;
end_struct

begin_struct
struct|struct
name|apr_dbd_row_t
block|{
name|int
name|n
decl_stmt|;
name|char
modifier|*
modifier|*
name|data
decl_stmt|;
name|apr_dbd_results_t
modifier|*
name|res
decl_stmt|;
block|}
struct|;
end_struct

begin_struct
struct|struct
name|apr_dbd_prepared_t
block|{
specifier|const
name|char
modifier|*
name|name
decl_stmt|;
name|int
name|prepared
decl_stmt|;
block|}
struct|;
end_struct

begin_define
define|#
directive|define
name|FREE_ERROR_MSG
parameter_list|(
name|dbd
parameter_list|)
define|\
value|do { \ 		if(dbd&& dbd->errmsg) { \ 			free(dbd->errmsg); \ 			dbd->errmsg = NULL; \ 		} \ 	} while(0);
end_define

begin_function
specifier|static
name|apr_status_t
name|free_table
parameter_list|(
name|void
modifier|*
name|data
parameter_list|)
block|{
name|sqlite_free_table
argument_list|(
name|data
argument_list|)
expr_stmt|;
return|return
name|APR_SUCCESS
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|dbd_sqlite_select
parameter_list|(
name|apr_pool_t
modifier|*
name|pool
parameter_list|,
name|apr_dbd_t
modifier|*
name|sql
parameter_list|,
name|apr_dbd_results_t
modifier|*
modifier|*
name|results
parameter_list|,
specifier|const
name|char
modifier|*
name|query
parameter_list|,
name|int
name|seek
parameter_list|)
block|{
name|char
modifier|*
modifier|*
name|result
decl_stmt|;
name|int
name|ret
init|=
literal|0
decl_stmt|;
name|int
name|tuples
init|=
literal|0
decl_stmt|;
name|int
name|fields
init|=
literal|0
decl_stmt|;
if|if
condition|(
name|sql
operator|->
name|trans
operator|&&
name|sql
operator|->
name|trans
operator|->
name|errnum
condition|)
block|{
return|return
name|sql
operator|->
name|trans
operator|->
name|errnum
return|;
block|}
name|FREE_ERROR_MSG
argument_list|(
name|sql
argument_list|)
expr_stmt|;
name|ret
operator|=
name|sqlite_get_table
argument_list|(
name|sql
operator|->
name|conn
argument_list|,
name|query
argument_list|,
operator|&
name|result
argument_list|,
operator|&
name|tuples
argument_list|,
operator|&
name|fields
argument_list|,
operator|&
name|sql
operator|->
name|errmsg
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|==
name|SQLITE_OK
condition|)
block|{
if|if
condition|(
operator|!
operator|*
name|results
condition|)
block|{
operator|*
name|results
operator|=
name|apr_pcalloc
argument_list|(
name|pool
argument_list|,
sizeof|sizeof
argument_list|(
name|apr_dbd_results_t
argument_list|)
argument_list|)
expr_stmt|;
block|}
operator|(
operator|*
name|results
operator|)
operator|->
name|res
operator|=
name|result
expr_stmt|;
operator|(
operator|*
name|results
operator|)
operator|->
name|ntuples
operator|=
name|tuples
expr_stmt|;
operator|(
operator|*
name|results
operator|)
operator|->
name|sz
operator|=
name|fields
expr_stmt|;
operator|(
operator|*
name|results
operator|)
operator|->
name|random
operator|=
name|seek
expr_stmt|;
operator|(
operator|*
name|results
operator|)
operator|->
name|pool
operator|=
name|pool
expr_stmt|;
if|if
condition|(
name|tuples
operator|>
literal|0
condition|)
name|apr_pool_cleanup_register
argument_list|(
name|pool
argument_list|,
name|result
argument_list|,
name|free_table
argument_list|,
name|apr_pool_cleanup_null
argument_list|)
expr_stmt|;
name|ret
operator|=
literal|0
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|TXN_NOTICE_ERRORS
argument_list|(
name|sql
operator|->
name|trans
argument_list|)
condition|)
block|{
name|sql
operator|->
name|trans
operator|->
name|errnum
operator|=
name|ret
expr_stmt|;
block|}
block|}
return|return
name|ret
return|;
block|}
end_function

begin_function
specifier|static
specifier|const
name|char
modifier|*
name|dbd_sqlite_get_name
parameter_list|(
specifier|const
name|apr_dbd_results_t
modifier|*
name|res
parameter_list|,
name|int
name|n
parameter_list|)
block|{
if|if
condition|(
operator|(
name|n
operator|<
literal|0
operator|)
operator|||
operator|(
name|n
operator|>=
name|res
operator|->
name|sz
operator|)
condition|)
block|{
return|return
name|NULL
return|;
block|}
return|return
name|res
operator|->
name|res
index|[
name|n
index|]
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|dbd_sqlite_get_row
parameter_list|(
name|apr_pool_t
modifier|*
name|pool
parameter_list|,
name|apr_dbd_results_t
modifier|*
name|res
parameter_list|,
name|apr_dbd_row_t
modifier|*
modifier|*
name|rowp
parameter_list|,
name|int
name|rownum
parameter_list|)
block|{
name|apr_dbd_row_t
modifier|*
name|row
init|=
operator|*
name|rowp
decl_stmt|;
name|int
name|sequential
init|=
operator|(
operator|(
name|rownum
operator|>=
literal|0
operator|)
operator|&&
name|res
operator|->
name|random
operator|)
condition|?
literal|0
else|:
literal|1
decl_stmt|;
if|if
condition|(
name|row
operator|==
name|NULL
condition|)
block|{
name|row
operator|=
name|apr_palloc
argument_list|(
name|pool
argument_list|,
sizeof|sizeof
argument_list|(
name|apr_dbd_row_t
argument_list|)
argument_list|)
expr_stmt|;
operator|*
name|rowp
operator|=
name|row
expr_stmt|;
name|row
operator|->
name|res
operator|=
name|res
expr_stmt|;
name|row
operator|->
name|n
operator|=
name|sequential
condition|?
literal|0
else|:
name|rownum
operator|-
literal|1
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|sequential
condition|)
block|{
operator|++
name|row
operator|->
name|n
expr_stmt|;
block|}
else|else
block|{
name|row
operator|->
name|n
operator|=
name|rownum
operator|-
literal|1
expr_stmt|;
block|}
block|}
if|if
condition|(
name|row
operator|->
name|n
operator|>=
name|res
operator|->
name|ntuples
condition|)
block|{
operator|*
name|rowp
operator|=
name|NULL
expr_stmt|;
name|apr_pool_cleanup_run
argument_list|(
name|res
operator|->
name|pool
argument_list|,
name|res
operator|->
name|res
argument_list|,
name|free_table
argument_list|)
expr_stmt|;
name|res
operator|->
name|res
operator|=
name|NULL
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
comment|/* Pointer magic explanation:      *      The sqlite result is an array such that the first res->sz elements are       *      the column names and each tuple follows afterwards       *      ex: (from the sqlite2 documentation)      SELECT employee_name, login, host FROM users WHERE login LIKE *        'd%';       nrow = 2      ncolumn = 3      result[0] = "employee_name"      result[1] = "login"      result[2] = "host"      result[3] = "dummy"      result[4] = "No such user"      result[5] = 0      result[6] = "D. Richard Hipp"      result[7] = "drh"      result[8] = "zadok"      */
name|row
operator|->
name|data
operator|=
name|res
operator|->
name|res
operator|+
name|res
operator|->
name|sz
operator|+
operator|(
name|res
operator|->
name|sz
operator|*
name|row
operator|->
name|n
operator|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
specifier|const
name|char
modifier|*
name|dbd_sqlite_get_entry
parameter_list|(
specifier|const
name|apr_dbd_row_t
modifier|*
name|row
parameter_list|,
name|int
name|n
parameter_list|)
block|{
if|if
condition|(
operator|(
name|n
operator|<
literal|0
operator|)
operator|||
operator|(
name|n
operator|>=
name|row
operator|->
name|res
operator|->
name|sz
operator|)
condition|)
block|{
return|return
name|NULL
return|;
block|}
return|return
name|row
operator|->
name|data
index|[
name|n
index|]
return|;
block|}
end_function

begin_function
specifier|static
name|apr_status_t
name|dbd_sqlite_datum_get
parameter_list|(
specifier|const
name|apr_dbd_row_t
modifier|*
name|row
parameter_list|,
name|int
name|n
parameter_list|,
name|apr_dbd_type_e
name|type
parameter_list|,
name|void
modifier|*
name|data
parameter_list|)
block|{
if|if
condition|(
operator|(
name|n
operator|<
literal|0
operator|)
operator|||
operator|(
name|n
operator|>=
name|row
operator|->
name|res
operator|->
name|sz
operator|)
condition|)
block|{
return|return
name|APR_EGENERAL
return|;
block|}
if|if
condition|(
name|row
operator|->
name|data
index|[
name|n
index|]
operator|==
name|NULL
condition|)
block|{
return|return
name|APR_ENOENT
return|;
block|}
switch|switch
condition|(
name|type
condition|)
block|{
case|case
name|APR_DBD_TYPE_TINY
case|:
operator|*
operator|(
name|char
operator|*
operator|)
name|data
operator|=
name|atoi
argument_list|(
name|row
operator|->
name|data
index|[
name|n
index|]
argument_list|)
expr_stmt|;
break|break;
case|case
name|APR_DBD_TYPE_UTINY
case|:
operator|*
operator|(
name|unsigned
name|char
operator|*
operator|)
name|data
operator|=
name|atoi
argument_list|(
name|row
operator|->
name|data
index|[
name|n
index|]
argument_list|)
expr_stmt|;
break|break;
case|case
name|APR_DBD_TYPE_SHORT
case|:
operator|*
operator|(
name|short
operator|*
operator|)
name|data
operator|=
name|atoi
argument_list|(
name|row
operator|->
name|data
index|[
name|n
index|]
argument_list|)
expr_stmt|;
break|break;
case|case
name|APR_DBD_TYPE_USHORT
case|:
operator|*
operator|(
name|unsigned
name|short
operator|*
operator|)
name|data
operator|=
name|atoi
argument_list|(
name|row
operator|->
name|data
index|[
name|n
index|]
argument_list|)
expr_stmt|;
break|break;
case|case
name|APR_DBD_TYPE_INT
case|:
operator|*
operator|(
name|int
operator|*
operator|)
name|data
operator|=
name|atoi
argument_list|(
name|row
operator|->
name|data
index|[
name|n
index|]
argument_list|)
expr_stmt|;
break|break;
case|case
name|APR_DBD_TYPE_UINT
case|:
operator|*
operator|(
name|unsigned
name|int
operator|*
operator|)
name|data
operator|=
name|atoi
argument_list|(
name|row
operator|->
name|data
index|[
name|n
index|]
argument_list|)
expr_stmt|;
break|break;
case|case
name|APR_DBD_TYPE_LONG
case|:
operator|*
operator|(
name|long
operator|*
operator|)
name|data
operator|=
name|atol
argument_list|(
name|row
operator|->
name|data
index|[
name|n
index|]
argument_list|)
expr_stmt|;
break|break;
case|case
name|APR_DBD_TYPE_ULONG
case|:
operator|*
operator|(
name|unsigned
name|long
operator|*
operator|)
name|data
operator|=
name|atol
argument_list|(
name|row
operator|->
name|data
index|[
name|n
index|]
argument_list|)
expr_stmt|;
break|break;
case|case
name|APR_DBD_TYPE_LONGLONG
case|:
operator|*
operator|(
name|apr_int64_t
operator|*
operator|)
name|data
operator|=
name|apr_atoi64
argument_list|(
name|row
operator|->
name|data
index|[
name|n
index|]
argument_list|)
expr_stmt|;
break|break;
case|case
name|APR_DBD_TYPE_ULONGLONG
case|:
operator|*
operator|(
name|apr_uint64_t
operator|*
operator|)
name|data
operator|=
name|apr_atoi64
argument_list|(
name|row
operator|->
name|data
index|[
name|n
index|]
argument_list|)
expr_stmt|;
break|break;
case|case
name|APR_DBD_TYPE_FLOAT
case|:
operator|*
operator|(
name|float
operator|*
operator|)
name|data
operator|=
name|atof
argument_list|(
name|row
operator|->
name|data
index|[
name|n
index|]
argument_list|)
expr_stmt|;
break|break;
case|case
name|APR_DBD_TYPE_DOUBLE
case|:
operator|*
operator|(
name|double
operator|*
operator|)
name|data
operator|=
name|atof
argument_list|(
name|row
operator|->
name|data
index|[
name|n
index|]
argument_list|)
expr_stmt|;
break|break;
case|case
name|APR_DBD_TYPE_STRING
case|:
case|case
name|APR_DBD_TYPE_TEXT
case|:
case|case
name|APR_DBD_TYPE_TIME
case|:
case|case
name|APR_DBD_TYPE_DATE
case|:
case|case
name|APR_DBD_TYPE_DATETIME
case|:
case|case
name|APR_DBD_TYPE_TIMESTAMP
case|:
case|case
name|APR_DBD_TYPE_ZTIMESTAMP
case|:
operator|*
operator|(
name|char
operator|*
operator|*
operator|)
name|data
operator|=
name|row
operator|->
name|data
index|[
name|n
index|]
expr_stmt|;
break|break;
case|case
name|APR_DBD_TYPE_BLOB
case|:
case|case
name|APR_DBD_TYPE_CLOB
case|:
block|{
name|apr_bucket
modifier|*
name|e
decl_stmt|;
name|apr_bucket_brigade
modifier|*
name|b
init|=
operator|(
name|apr_bucket_brigade
operator|*
operator|)
name|data
decl_stmt|;
name|e
operator|=
name|apr_bucket_pool_create
argument_list|(
name|row
operator|->
name|data
index|[
name|n
index|]
argument_list|,
name|strlen
argument_list|(
name|row
operator|->
name|data
index|[
name|n
index|]
argument_list|)
argument_list|,
name|row
operator|->
name|res
operator|->
name|pool
argument_list|,
name|b
operator|->
name|bucket_alloc
argument_list|)
expr_stmt|;
name|APR_BRIGADE_INSERT_TAIL
argument_list|(
name|b
argument_list|,
name|e
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
name|APR_DBD_TYPE_NULL
case|:
operator|*
operator|(
name|void
operator|*
operator|*
operator|)
name|data
operator|=
name|NULL
expr_stmt|;
break|break;
default|default:
return|return
name|APR_EGENERAL
return|;
block|}
return|return
name|APR_SUCCESS
return|;
block|}
end_function

begin_function
specifier|static
specifier|const
name|char
modifier|*
name|dbd_sqlite_error
parameter_list|(
name|apr_dbd_t
modifier|*
name|sql
parameter_list|,
name|int
name|n
parameter_list|)
block|{
return|return
name|sql
operator|->
name|errmsg
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|dbd_sqlite_query
parameter_list|(
name|apr_dbd_t
modifier|*
name|sql
parameter_list|,
name|int
modifier|*
name|nrows
parameter_list|,
specifier|const
name|char
modifier|*
name|query
parameter_list|)
block|{
name|char
modifier|*
modifier|*
name|result
decl_stmt|;
name|int
name|ret
decl_stmt|;
name|int
name|tuples
init|=
literal|0
decl_stmt|;
name|int
name|fields
init|=
literal|0
decl_stmt|;
if|if
condition|(
name|sql
operator|->
name|trans
operator|&&
name|sql
operator|->
name|trans
operator|->
name|errnum
condition|)
block|{
return|return
name|sql
operator|->
name|trans
operator|->
name|errnum
return|;
block|}
name|FREE_ERROR_MSG
argument_list|(
name|sql
argument_list|)
expr_stmt|;
name|ret
operator|=
name|sqlite_get_table
argument_list|(
name|sql
operator|->
name|conn
argument_list|,
name|query
argument_list|,
operator|&
name|result
argument_list|,
operator|&
name|tuples
argument_list|,
operator|&
name|fields
argument_list|,
operator|&
name|sql
operator|->
name|errmsg
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|==
name|SQLITE_OK
condition|)
block|{
operator|*
name|nrows
operator|=
name|sqlite_changes
argument_list|(
name|sql
operator|->
name|conn
argument_list|)
expr_stmt|;
if|if
condition|(
name|tuples
operator|>
literal|0
condition|)
name|free
argument_list|(
name|result
argument_list|)
expr_stmt|;
name|ret
operator|=
literal|0
expr_stmt|;
block|}
if|if
condition|(
name|TXN_NOTICE_ERRORS
argument_list|(
name|sql
operator|->
name|trans
argument_list|)
condition|)
block|{
name|sql
operator|->
name|trans
operator|->
name|errnum
operator|=
name|ret
expr_stmt|;
block|}
return|return
name|ret
return|;
block|}
end_function

begin_function
specifier|static
name|apr_status_t
name|free_mem
parameter_list|(
name|void
modifier|*
name|data
parameter_list|)
block|{
name|sqlite_freemem
argument_list|(
name|data
argument_list|)
expr_stmt|;
return|return
name|APR_SUCCESS
return|;
block|}
end_function

begin_function
specifier|static
specifier|const
name|char
modifier|*
name|dbd_sqlite_escape
parameter_list|(
name|apr_pool_t
modifier|*
name|pool
parameter_list|,
specifier|const
name|char
modifier|*
name|arg
parameter_list|,
name|apr_dbd_t
modifier|*
name|sql
parameter_list|)
block|{
name|char
modifier|*
name|ret
init|=
name|sqlite_mprintf
argument_list|(
literal|"%q"
argument_list|,
name|arg
argument_list|)
decl_stmt|;
name|apr_pool_cleanup_register
argument_list|(
name|pool
argument_list|,
name|ret
argument_list|,
name|free_mem
argument_list|,
name|apr_pool_cleanup_null
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|dbd_sqlite_prepare
parameter_list|(
name|apr_pool_t
modifier|*
name|pool
parameter_list|,
name|apr_dbd_t
modifier|*
name|sql
parameter_list|,
specifier|const
name|char
modifier|*
name|query
parameter_list|,
specifier|const
name|char
modifier|*
name|label
parameter_list|,
name|int
name|nargs
parameter_list|,
name|int
name|nvals
parameter_list|,
name|apr_dbd_type_e
modifier|*
name|types
parameter_list|,
name|apr_dbd_prepared_t
modifier|*
modifier|*
name|statement
parameter_list|)
block|{
return|return
name|APR_ENOTIMPL
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|dbd_sqlite_pquery
parameter_list|(
name|apr_pool_t
modifier|*
name|pool
parameter_list|,
name|apr_dbd_t
modifier|*
name|sql
parameter_list|,
name|int
modifier|*
name|nrows
parameter_list|,
name|apr_dbd_prepared_t
modifier|*
name|statement
parameter_list|,
specifier|const
name|char
modifier|*
modifier|*
name|values
parameter_list|)
block|{
return|return
name|APR_ENOTIMPL
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|dbd_sqlite_pvquery
parameter_list|(
name|apr_pool_t
modifier|*
name|pool
parameter_list|,
name|apr_dbd_t
modifier|*
name|sql
parameter_list|,
name|int
modifier|*
name|nrows
parameter_list|,
name|apr_dbd_prepared_t
modifier|*
name|statement
parameter_list|,
name|va_list
name|args
parameter_list|)
block|{
return|return
name|APR_ENOTIMPL
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|dbd_sqlite_pselect
parameter_list|(
name|apr_pool_t
modifier|*
name|pool
parameter_list|,
name|apr_dbd_t
modifier|*
name|sql
parameter_list|,
name|apr_dbd_results_t
modifier|*
modifier|*
name|results
parameter_list|,
name|apr_dbd_prepared_t
modifier|*
name|statement
parameter_list|,
name|int
name|seek
parameter_list|,
specifier|const
name|char
modifier|*
modifier|*
name|values
parameter_list|)
block|{
return|return
name|APR_ENOTIMPL
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|dbd_sqlite_pvselect
parameter_list|(
name|apr_pool_t
modifier|*
name|pool
parameter_list|,
name|apr_dbd_t
modifier|*
name|sql
parameter_list|,
name|apr_dbd_results_t
modifier|*
modifier|*
name|results
parameter_list|,
name|apr_dbd_prepared_t
modifier|*
name|statement
parameter_list|,
name|int
name|seek
parameter_list|,
name|va_list
name|args
parameter_list|)
block|{
return|return
name|APR_ENOTIMPL
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|dbd_sqlite_pbquery
parameter_list|(
name|apr_pool_t
modifier|*
name|pool
parameter_list|,
name|apr_dbd_t
modifier|*
name|sql
parameter_list|,
name|int
modifier|*
name|nrows
parameter_list|,
name|apr_dbd_prepared_t
modifier|*
name|statement
parameter_list|,
specifier|const
name|void
modifier|*
modifier|*
name|values
parameter_list|)
block|{
return|return
name|APR_ENOTIMPL
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|dbd_sqlite_pvbquery
parameter_list|(
name|apr_pool_t
modifier|*
name|pool
parameter_list|,
name|apr_dbd_t
modifier|*
name|sql
parameter_list|,
name|int
modifier|*
name|nrows
parameter_list|,
name|apr_dbd_prepared_t
modifier|*
name|statement
parameter_list|,
name|va_list
name|args
parameter_list|)
block|{
return|return
name|APR_ENOTIMPL
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|dbd_sqlite_pbselect
parameter_list|(
name|apr_pool_t
modifier|*
name|pool
parameter_list|,
name|apr_dbd_t
modifier|*
name|sql
parameter_list|,
name|apr_dbd_results_t
modifier|*
modifier|*
name|results
parameter_list|,
name|apr_dbd_prepared_t
modifier|*
name|statement
parameter_list|,
name|int
name|seek
parameter_list|,
specifier|const
name|void
modifier|*
modifier|*
name|values
parameter_list|)
block|{
return|return
name|APR_ENOTIMPL
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|dbd_sqlite_pvbselect
parameter_list|(
name|apr_pool_t
modifier|*
name|pool
parameter_list|,
name|apr_dbd_t
modifier|*
name|sql
parameter_list|,
name|apr_dbd_results_t
modifier|*
modifier|*
name|results
parameter_list|,
name|apr_dbd_prepared_t
modifier|*
name|statement
parameter_list|,
name|int
name|seek
parameter_list|,
name|va_list
name|args
parameter_list|)
block|{
return|return
name|APR_ENOTIMPL
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|dbd_sqlite_start_transaction
parameter_list|(
name|apr_pool_t
modifier|*
name|pool
parameter_list|,
name|apr_dbd_t
modifier|*
name|handle
parameter_list|,
name|apr_dbd_transaction_t
modifier|*
modifier|*
name|trans
parameter_list|)
block|{
name|int
name|ret
decl_stmt|,
name|rows
decl_stmt|;
name|ret
operator|=
name|dbd_sqlite_query
argument_list|(
name|handle
argument_list|,
operator|&
name|rows
argument_list|,
literal|"BEGIN TRANSACTION"
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|==
literal|0
condition|)
block|{
if|if
condition|(
operator|!
operator|*
name|trans
condition|)
block|{
operator|*
name|trans
operator|=
name|apr_pcalloc
argument_list|(
name|pool
argument_list|,
sizeof|sizeof
argument_list|(
name|apr_dbd_transaction_t
argument_list|)
argument_list|)
expr_stmt|;
block|}
operator|(
operator|*
name|trans
operator|)
operator|->
name|handle
operator|=
name|handle
expr_stmt|;
name|handle
operator|->
name|trans
operator|=
operator|*
name|trans
expr_stmt|;
block|}
else|else
block|{
name|ret
operator|=
operator|-
literal|1
expr_stmt|;
block|}
return|return
name|ret
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|dbd_sqlite_end_transaction
parameter_list|(
name|apr_dbd_transaction_t
modifier|*
name|trans
parameter_list|)
block|{
name|int
name|rows
decl_stmt|;
name|int
name|ret
init|=
operator|-
literal|1
decl_stmt|;
comment|/* no transaction is an error cond */
if|if
condition|(
name|trans
condition|)
block|{
comment|/* rollback on error or explicit rollback request */
if|if
condition|(
name|trans
operator|->
name|errnum
operator|||
name|TXN_DO_ROLLBACK
argument_list|(
name|trans
argument_list|)
condition|)
block|{
name|trans
operator|->
name|errnum
operator|=
literal|0
expr_stmt|;
name|ret
operator|=
name|dbd_sqlite_query
argument_list|(
name|trans
operator|->
name|handle
argument_list|,
operator|&
name|rows
argument_list|,
literal|"ROLLBACK TRANSACTION"
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|ret
operator|=
name|dbd_sqlite_query
argument_list|(
name|trans
operator|->
name|handle
argument_list|,
operator|&
name|rows
argument_list|,
literal|"COMMIT TRANSACTION"
argument_list|)
expr_stmt|;
block|}
name|trans
operator|->
name|handle
operator|->
name|trans
operator|=
name|NULL
expr_stmt|;
block|}
return|return
name|ret
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|dbd_sqlite_transaction_mode_get
parameter_list|(
name|apr_dbd_transaction_t
modifier|*
name|trans
parameter_list|)
block|{
if|if
condition|(
operator|!
name|trans
condition|)
return|return
name|APR_DBD_TRANSACTION_COMMIT
return|;
return|return
name|trans
operator|->
name|mode
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|dbd_sqlite_transaction_mode_set
parameter_list|(
name|apr_dbd_transaction_t
modifier|*
name|trans
parameter_list|,
name|int
name|mode
parameter_list|)
block|{
if|if
condition|(
operator|!
name|trans
condition|)
return|return
name|APR_DBD_TRANSACTION_COMMIT
return|;
return|return
name|trans
operator|->
name|mode
operator|=
operator|(
name|mode
operator|&
name|TXN_MODE_BITS
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|apr_status_t
name|error_free
parameter_list|(
name|void
modifier|*
name|data
parameter_list|)
block|{
name|free
argument_list|(
name|data
argument_list|)
expr_stmt|;
return|return
name|APR_SUCCESS
return|;
block|}
end_function

begin_function
specifier|static
name|apr_dbd_t
modifier|*
name|dbd_sqlite_open
parameter_list|(
name|apr_pool_t
modifier|*
name|pool
parameter_list|,
specifier|const
name|char
modifier|*
name|params_
parameter_list|,
specifier|const
name|char
modifier|*
modifier|*
name|error
parameter_list|)
block|{
name|apr_dbd_t
modifier|*
name|sql
decl_stmt|;
name|sqlite
modifier|*
name|conn
init|=
name|NULL
decl_stmt|;
name|char
modifier|*
name|perm
decl_stmt|;
name|int
name|iperms
init|=
literal|600
decl_stmt|;
name|char
modifier|*
name|params
init|=
name|apr_pstrdup
argument_list|(
name|pool
argument_list|,
name|params_
argument_list|)
decl_stmt|;
comment|/* params = "[filename]:[permissions]"      *    example: "shopping.db:600"      */
name|perm
operator|=
name|strstr
argument_list|(
name|params
argument_list|,
literal|":"
argument_list|)
expr_stmt|;
if|if
condition|(
name|perm
condition|)
block|{
operator|*
operator|(
name|perm
operator|++
operator|)
operator|=
literal|'\x00'
expr_stmt|;
comment|/* split the filename and permissions */
if|if
condition|(
name|strlen
argument_list|(
name|perm
argument_list|)
operator|>
literal|0
condition|)
name|iperms
operator|=
name|atoi
argument_list|(
name|perm
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|error
condition|)
block|{
operator|*
name|error
operator|=
name|NULL
expr_stmt|;
name|conn
operator|=
name|sqlite_open
argument_list|(
name|params
argument_list|,
name|iperms
argument_list|,
operator|(
name|char
operator|*
operator|*
operator|)
name|error
argument_list|)
expr_stmt|;
if|if
condition|(
operator|*
name|error
condition|)
block|{
name|apr_pool_cleanup_register
argument_list|(
name|pool
argument_list|,
operator|*
name|error
argument_list|,
name|error_free
argument_list|,
name|apr_pool_cleanup_null
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
name|conn
operator|=
name|sqlite_open
argument_list|(
name|params
argument_list|,
name|iperms
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
block|}
name|sql
operator|=
name|apr_pcalloc
argument_list|(
name|pool
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|sql
argument_list|)
argument_list|)
expr_stmt|;
name|sql
operator|->
name|conn
operator|=
name|conn
expr_stmt|;
return|return
name|sql
return|;
block|}
end_function

begin_function
specifier|static
name|apr_status_t
name|dbd_sqlite_close
parameter_list|(
name|apr_dbd_t
modifier|*
name|handle
parameter_list|)
block|{
if|if
condition|(
name|handle
operator|->
name|conn
condition|)
block|{
name|sqlite_close
argument_list|(
name|handle
operator|->
name|conn
argument_list|)
expr_stmt|;
name|handle
operator|->
name|conn
operator|=
name|NULL
expr_stmt|;
block|}
return|return
name|APR_SUCCESS
return|;
block|}
end_function

begin_function
specifier|static
name|apr_status_t
name|dbd_sqlite_check_conn
parameter_list|(
name|apr_pool_t
modifier|*
name|pool
parameter_list|,
name|apr_dbd_t
modifier|*
name|handle
parameter_list|)
block|{
if|if
condition|(
name|handle
operator|->
name|conn
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
return|return
name|APR_SUCCESS
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|dbd_sqlite_select_db
parameter_list|(
name|apr_pool_t
modifier|*
name|pool
parameter_list|,
name|apr_dbd_t
modifier|*
name|handle
parameter_list|,
specifier|const
name|char
modifier|*
name|name
parameter_list|)
block|{
return|return
name|APR_ENOTIMPL
return|;
block|}
end_function

begin_function
specifier|static
name|void
modifier|*
name|dbd_sqlite_native
parameter_list|(
name|apr_dbd_t
modifier|*
name|handle
parameter_list|)
block|{
return|return
name|handle
operator|->
name|conn
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|dbd_sqlite_num_cols
parameter_list|(
name|apr_dbd_results_t
modifier|*
name|res
parameter_list|)
block|{
return|return
name|res
operator|->
name|sz
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|dbd_sqlite_num_tuples
parameter_list|(
name|apr_dbd_results_t
modifier|*
name|res
parameter_list|)
block|{
return|return
name|res
operator|->
name|ntuples
return|;
block|}
end_function

begin_decl_stmt
name|APU_MODULE_DECLARE_DATA
specifier|const
name|apr_dbd_driver_t
name|apr_dbd_sqlite2_driver
init|=
block|{
literal|"sqlite2"
block|,
name|NULL
block|,
name|dbd_sqlite_native
block|,
name|dbd_sqlite_open
block|,
name|dbd_sqlite_check_conn
block|,
name|dbd_sqlite_close
block|,
name|dbd_sqlite_select_db
block|,
name|dbd_sqlite_start_transaction
block|,
name|dbd_sqlite_end_transaction
block|,
name|dbd_sqlite_query
block|,
name|dbd_sqlite_select
block|,
name|dbd_sqlite_num_cols
block|,
name|dbd_sqlite_num_tuples
block|,
name|dbd_sqlite_get_row
block|,
name|dbd_sqlite_get_entry
block|,
name|dbd_sqlite_error
block|,
name|dbd_sqlite_escape
block|,
name|dbd_sqlite_prepare
block|,
name|dbd_sqlite_pvquery
block|,
name|dbd_sqlite_pvselect
block|,
name|dbd_sqlite_pquery
block|,
name|dbd_sqlite_pselect
block|,
name|dbd_sqlite_get_name
block|,
name|dbd_sqlite_transaction_mode_get
block|,
name|dbd_sqlite_transaction_mode_set
block|,
name|NULL
block|,
name|dbd_sqlite_pvbquery
block|,
name|dbd_sqlite_pvbselect
block|,
name|dbd_sqlite_pbquery
block|,
name|dbd_sqlite_pbselect
block|,
name|dbd_sqlite_datum_get
block|}
decl_stmt|;
end_decl_stmt

begin_endif
endif|#
directive|endif
end_endif

end_unit


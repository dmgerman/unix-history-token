begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Copyright (c) 1992, 1993, 1996  *	Berkeley Software Design, Inc.  All rights reserved.  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions  * are met:  * 1. Redistributions of source code must retain the above copyright  *    notice, this list of conditions and the following disclaimer.  * 2. Redistributions in binary form must reproduce the above copyright  *    notice, this list of conditions and the following disclaimer in the  *    documentation and/or other materials provided with the distribution.  * 3. All advertising materials mentioning features or use of this software  *    must display the following acknowledgement:  *	This product includes software developed by Berkeley Software  *	Design, Inc.  *  * THIS SOFTWARE IS PROVIDED BY Berkeley Software Design, Inc. ``AS IS'' AND  * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE  * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE  * ARE DISCLAIMED.  IN NO EVENT SHALL Berkeley Software Design, Inc. BE LIABLE  * FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL  * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS  * OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)  * HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT  * LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY  * OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF  * SUCH DAMAGE.  *  *	BSDI int16.c,v 2.2 1996/04/08 19:32:47 bostic Exp  *  * $FreeBSD$  */
end_comment

begin_include
include|#
directive|include
file|"doscmd.h"
end_include

begin_include
include|#
directive|include
file|"tty.h"
end_include

begin_define
define|#
directive|define
name|K_NEXT
value|*(u_short *)0x41a
end_define

begin_define
define|#
directive|define
name|K_FREE
value|*(u_short *)0x41c
end_define

begin_define
define|#
directive|define
name|KbdEmpty
parameter_list|()
value|(K_NEXT == K_FREE)
end_define

begin_define
define|#
directive|define
name|HWM
value|16
end_define

begin_decl_stmt
specifier|volatile
name|int
name|poll_cnt
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_function
name|void
name|wakeup_poll
parameter_list|(
name|void
parameter_list|)
block|{
if|if
condition|(
name|poll_cnt
operator|<=
literal|0
condition|)
name|poll_cnt
operator|=
name|HWM
expr_stmt|;
block|}
end_function

begin_function
name|void
name|reset_poll
parameter_list|(
name|void
parameter_list|)
block|{
name|poll_cnt
operator|=
name|HWM
expr_stmt|;
block|}
end_function

begin_function
name|void
name|sleep_poll
parameter_list|(
name|void
parameter_list|)
block|{
if|#
directive|if
literal|0
block|printf("sleep_poll: poll_cnt=%d\n", poll_cnt);     if (poll_cnt == 14) 	tmode = 1;
endif|#
directive|endif
if|if
condition|(
operator|--
name|poll_cnt
operator|<=
literal|0
condition|)
block|{
name|poll_cnt
operator|=
literal|0
expr_stmt|;
while|while
condition|(
name|KbdEmpty
argument_list|()
operator|&&
name|poll_cnt
operator|<=
literal|0
condition|)
block|{
if|#
directive|if
literal|0
block|softint(0x28);
endif|#
directive|endif
if|if
condition|(
name|KbdEmpty
argument_list|()
operator|&&
name|poll_cnt
operator|<=
literal|0
condition|)
name|tty_pause
argument_list|()
expr_stmt|;
block|}
block|}
block|}
end_function

begin_function
name|void
name|int16
parameter_list|(
name|regcontext_t
modifier|*
name|REGS
parameter_list|)
block|{
if|if
condition|(
operator|!
name|xmode
operator|&&
operator|!
name|raw_kbd
condition|)
block|{
if|if
condition|(
name|vflag
condition|)
name|dump_regs
argument_list|(
name|REGS
argument_list|)
expr_stmt|;
name|fatal
argument_list|(
literal|"int16 func 0x%x only supported in X mode\n"
argument_list|,
name|R_AH
argument_list|)
expr_stmt|;
block|}
switch|switch
condition|(
name|R_AH
condition|)
block|{
case|case
literal|0x00
case|:
case|case
literal|0x10
case|:
comment|/* Get enhanced keystroke */
name|poll_cnt
operator|=
literal|16
expr_stmt|;
while|while
condition|(
name|KbdEmpty
argument_list|()
condition|)
name|tty_pause
argument_list|()
expr_stmt|;
name|R_AX
operator|=
name|KbdRead
argument_list|()
expr_stmt|;
break|break;
case|case
literal|0x01
case|:
comment|/* Get keystroke */
case|case
literal|0x11
case|:
comment|/* Get enhanced keystroke */
if|if
condition|(
name|KbdEmpty
argument_list|()
condition|)
block|{
name|R_FLAGS
operator||=
name|PSL_Z
expr_stmt|;
break|break;
block|}
name|R_FLAGS
operator|&=
operator|~
name|PSL_Z
expr_stmt|;
name|R_AX
operator|=
name|KbdPeek
argument_list|()
expr_stmt|;
break|break;
case|case
literal|0x02
case|:
name|R_AL
operator|=
name|tty_state
argument_list|()
expr_stmt|;
break|break;
case|case
literal|0x12
case|:
name|R_AH
operator|=
name|tty_estate
argument_list|()
expr_stmt|;
name|R_AL
operator|=
name|tty_state
argument_list|()
expr_stmt|;
break|break;
case|case
literal|0x03
case|:
comment|/* Set typematic and delay rate */
break|break;
case|case
literal|0x05
case|:
name|KbdWrite
argument_list|(
name|R_CX
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x55
case|:
name|R_AX
operator|=
literal|0x43af
expr_stmt|;
comment|/* Empirical value ... */
break|break;
case|case
literal|0x92
case|:
name|R_AH
operator|=
literal|0x00
expr_stmt|;
break|break;
case|case
literal|0xa2
case|:
name|debug
argument_list|(
name|D_HALF
argument_list|,
literal|"122-key keyboard support check\n"
argument_list|)
expr_stmt|;
break|break;
default|default:
name|unknown_int2
argument_list|(
literal|0x16
argument_list|,
name|R_AH
argument_list|,
name|REGS
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
end_function

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Copyright (c) 1992, 1993, 1996  *	Berkeley Software Design, Inc.  All rights reserved.  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions  * are met:  * 1. Redistributions of source code must retain the above copyright  *    notice, this list of conditions and the following disclaimer.  * 2. Redistributions in binary form must reproduce the above copyright  *    notice, this list of conditions and the following disclaimer in the  *    documentation and/or other materials provided with the distribution.  * 3. All advertising materials mentioning features or use of this software  *    must display the following acknowledgement:  *	This product includes software developed by Berkeley Software  *	Design, Inc.  *  * THIS SOFTWARE IS PROVIDED BY Berkeley Software Design, Inc. ``AS IS'' AND  * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE  * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE  * ARE DISCLAIMED.  IN NO EVENT SHALL Berkeley Software Design, Inc. BE LIABLE  * FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL  * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS  * OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)  * HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT  * LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY  * OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF  * SUCH DAMAGE.  *  *	BSDI tty.c,v 2.4 1996/04/08 22:03:27 prb Exp  */
end_comment

begin_include
include|#
directive|include
file|<sys/cdefs.h>
end_include

begin_expr_stmt
name|__FBSDID
argument_list|(
literal|"$FreeBSD$"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_include
include|#
directive|include
file|<sys/ioctl.h>
end_include

begin_include
include|#
directive|include
file|<sys/time.h>
end_include

begin_include
include|#
directive|include
file|<sys/types.h>
end_include

begin_include
include|#
directive|include
file|<sys/mman.h>
end_include

begin_include
include|#
directive|include
file|<ctype.h>
end_include

begin_include
include|#
directive|include
file|<err.h>
end_include

begin_include
include|#
directive|include
file|<fcntl.h>
end_include

begin_include
include|#
directive|include
file|<limits.h>
end_include

begin_include
include|#
directive|include
file|<paths.h>
end_include

begin_include
include|#
directive|include
file|<signal.h>
end_include

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_include
include|#
directive|include
file|<termios.h>
end_include

begin_include
include|#
directive|include
file|<unistd.h>
end_include

begin_ifdef
ifdef|#
directive|ifdef
name|__FreeBSD__
end_ifdef

begin_include
include|#
directive|include
file|<osreldate.h>
end_include

begin_if
if|#
directive|if
name|__FreeBSD_version
operator|>=
literal|500014
end_if

begin_include
include|#
directive|include
file|<sys/kbio.h>
end_include

begin_else
else|#
directive|else
end_else

begin_include
include|#
directive|include
file|<machine/console.h>
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_else
else|#
directive|else
end_else

begin_ifdef
ifdef|#
directive|ifdef
name|__NetBSD__
end_ifdef

begin_include
include|#
directive|include
file|"machine/pccons.h"
end_include

begin_else
else|#
directive|else
end_else

begin_comment
comment|/* BSD/OS */
end_comment

begin_include
include|#
directive|include
file|"/sys/i386/isa/pcconsioctl.h"
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_endif
endif|#
directive|endif
end_endif

begin_ifndef
ifndef|#
directive|ifndef
name|NO_X
end_ifndef

begin_include
include|#
directive|include
file|<X11/Xlib.h>
end_include

begin_include
include|#
directive|include
file|<X11/Xutil.h>
end_include

begin_include
include|#
directive|include
file|<X11/keysym.h>
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_include
include|#
directive|include
file|"doscmd.h"
end_include

begin_include
include|#
directive|include
file|"AsyncIO.h"
end_include

begin_include
include|#
directive|include
file|"font8x8.h"
end_include

begin_include
include|#
directive|include
file|"font8x14.h"
end_include

begin_include
include|#
directive|include
file|"font8x16.h"
end_include

begin_include
include|#
directive|include
file|"mouse.h"
end_include

begin_include
include|#
directive|include
file|"trap.h"
end_include

begin_include
include|#
directive|include
file|"tty.h"
end_include

begin_include
include|#
directive|include
file|"video.h"
end_include

begin_ifndef
ifndef|#
directive|ifndef
name|NO_X
end_ifndef

begin_decl_stmt
specifier|static
name|int
name|show
init|=
literal|1
decl_stmt|;
end_decl_stmt

begin_endif
endif|#
directive|endif
end_endif

begin_decl_stmt
specifier|static
name|int
name|blink
init|=
literal|1
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|flipdelete
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* Flip meaning of delete and backspace */
end_comment

begin_decl_stmt
specifier|static
name|u_short
name|break_code
init|=
literal|0x00
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|u_short
name|scan_code
init|=
literal|0x00
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|height
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|width
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|vattr
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|const
name|char
modifier|*
name|xfont
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_ifndef
ifndef|#
directive|ifndef
name|NO_X
end_ifndef

begin_decl_stmt
name|Display
modifier|*
name|dpy
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|Window
name|win
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|XFontStruct
modifier|*
name|font
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|XImage
modifier|*
name|xi
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|Visual
modifier|*
name|visual
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|unsigned
name|int
name|depth
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|unsigned
name|long
name|black
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|unsigned
name|long
name|white
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|FW
decl_stmt|,
name|FH
decl_stmt|,
name|FD
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|GC
name|gc
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|GC
name|cgc
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|xfd
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* LUT for the vram -> XImage conversion */
end_comment

begin_decl_stmt
name|u_int8_t
name|lut
index|[
literal|4
index|]
index|[
literal|256
index|]
index|[
literal|8
index|]
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* X pixel values for the RGB triples */
end_comment

begin_decl_stmt
name|unsigned
name|long
name|pixels
index|[
literal|16
index|]
decl_stmt|;
end_decl_stmt

begin_endif
endif|#
directive|endif
end_endif

begin_typedef
typedef|typedef
struct|struct
name|TextLine
block|{
name|u_short
modifier|*
name|data
decl_stmt|;
name|u_char
name|max_length
decl_stmt|;
comment|/* Not used, but here for future use */
name|u_char
name|changed
range|:
literal|1
decl_stmt|;
block|}
name|TextLine
typedef|;
end_typedef

begin_decl_stmt
name|TextLine
modifier|*
name|lines
init|=
name|NULL
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|kbd_fd
init|=
operator|-
literal|1
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|kbd_read
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|struct
name|termios
name|tty_cook
decl_stmt|,
name|tty_raw
decl_stmt|;
end_decl_stmt

begin_define
define|#
directive|define
name|row
value|(CursRow0)
end_define

begin_define
define|#
directive|define
name|col
value|(CursCol0)
end_define

begin_comment
comment|/* Local functions */
end_comment

begin_function_decl
specifier|static
name|void
name|_kbd_event
parameter_list|(
name|int
parameter_list|,
name|int
parameter_list|,
name|void
modifier|*
parameter_list|,
name|regcontext_t
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|Failure
parameter_list|(
name|void
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|SetVREGCur
parameter_list|(
name|void
parameter_list|)
function_decl|;
end_function_decl

begin_ifndef
ifndef|#
directive|ifndef
name|NO_X
end_ifndef

begin_function_decl
specifier|static
name|void
name|debug_event
parameter_list|(
name|int
parameter_list|,
name|int
parameter_list|,
name|void
modifier|*
parameter_list|,
name|regcontext_t
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_endif
endif|#
directive|endif
end_endif

begin_function_decl
specifier|static
name|unsigned
name|char
name|inb_port60
parameter_list|(
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|inrange
parameter_list|(
name|int
parameter_list|,
name|int
parameter_list|,
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_ifndef
ifndef|#
directive|ifndef
name|NO_X
end_ifndef

begin_function_decl
specifier|static
name|void
name|kbd_event
parameter_list|(
name|int
parameter_list|,
name|int
parameter_list|,
name|void
modifier|*
parameter_list|,
name|regcontext_t
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|u_short
name|read_raw_kbd
parameter_list|(
name|int
parameter_list|,
name|u_short
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|setgc
parameter_list|(
name|u_short
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|video_async_event
parameter_list|(
name|int
parameter_list|,
name|int
parameter_list|,
name|void
modifier|*
parameter_list|,
name|regcontext_t
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_endif
endif|#
directive|endif
end_endif

begin_ifndef
ifndef|#
directive|ifndef
name|NO_X
end_ifndef

begin_function_decl
specifier|static
name|void
name|dac2rgb
parameter_list|(
name|XColor
modifier|*
parameter_list|,
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|prepare_lut
parameter_list|(
name|void
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|putchar_graphics
parameter_list|(
name|int
parameter_list|,
name|int
parameter_list|,
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|tty_rwrite_graphics
parameter_list|(
name|int
parameter_list|,
name|int
parameter_list|,
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|video_event
parameter_list|(
name|XEvent
modifier|*
name|ev
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|video_update_graphics
parameter_list|(
name|void
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|video_update_text
parameter_list|(
name|void
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|vram2ximage
parameter_list|(
name|void
parameter_list|)
function_decl|;
end_function_decl

begin_endif
endif|#
directive|endif
end_endif

begin_define
define|#
directive|define
name|PEEKSZ
value|16
end_define

begin_define
define|#
directive|define
name|K_NEXT
value|*(u_short *)0x41a
end_define

begin_define
define|#
directive|define
name|K_FREE
value|*(u_short *)0x41c
end_define

begin_define
define|#
directive|define
name|K_BUFSTARTP
value|*(u_short *)0x480
end_define

begin_define
define|#
directive|define
name|K_BUFENDP
value|*(u_short *)0x482
end_define

begin_define
define|#
directive|define
name|K_BUFSTART
value|((u_short *)(0x400 + *(u_short *)0x480))
end_define

begin_define
define|#
directive|define
name|K_BUFEND
value|((u_short *)(0x400 + *(u_short *)0x482))
end_define

begin_define
define|#
directive|define
name|K_BUF
parameter_list|(
name|i
parameter_list|)
value|*((u_short *)((u_char *)0x400 + (i)))
end_define

begin_define
define|#
directive|define
name|K1_STATUS
value|BIOSDATA[0x17]
end_define

begin_define
define|#
directive|define
name|K1_RSHIFT
value|0x01
end_define

begin_define
define|#
directive|define
name|K1_LSHIFT
value|0x02
end_define

begin_define
define|#
directive|define
name|K1_SHIFT
value|0x03
end_define

begin_define
define|#
directive|define
name|K1_CTRL
value|0x04
end_define

begin_define
define|#
directive|define
name|K1_ALT
value|0x08
end_define

begin_define
define|#
directive|define
name|K1_SLOCK
value|0x10
end_define

begin_comment
comment|/* Active */
end_comment

begin_define
define|#
directive|define
name|K1_NLOCK
value|0x20
end_define

begin_comment
comment|/* Active */
end_comment

begin_define
define|#
directive|define
name|K1_CLOCK
value|0x40
end_define

begin_comment
comment|/* Active */
end_comment

begin_define
define|#
directive|define
name|K1_INSERT
value|0x80
end_define

begin_comment
comment|/* Active */
end_comment

begin_define
define|#
directive|define
name|K2_STATUS
value|BIOSDATA[0x18]
end_define

begin_define
define|#
directive|define
name|K2_LCTRL
value|0x01
end_define

begin_define
define|#
directive|define
name|K2_LALT
value|0x02
end_define

begin_define
define|#
directive|define
name|K2_SYSREQ
value|0x04
end_define

begin_define
define|#
directive|define
name|K2_PAUSE
value|0x08
end_define

begin_define
define|#
directive|define
name|K2_SLOCK
value|0x10
end_define

begin_comment
comment|/* Actually held down */
end_comment

begin_define
define|#
directive|define
name|K2_NLOCK
value|0x20
end_define

begin_comment
comment|/* Actually held down */
end_comment

begin_define
define|#
directive|define
name|K2_CLOCK
value|0x40
end_define

begin_comment
comment|/* Actually held down */
end_comment

begin_define
define|#
directive|define
name|K2_INSERT
value|0x80
end_define

begin_comment
comment|/* Actually held down */
end_comment

begin_define
define|#
directive|define
name|K3_STATUS
value|BIOSDATA[0x96]
end_define

begin_define
define|#
directive|define
name|K3_E1
value|0x01
end_define

begin_comment
comment|/* Last code read was e1 */
end_comment

begin_define
define|#
directive|define
name|K3_E2
value|0x02
end_define

begin_comment
comment|/* Last code read was e2 */
end_comment

begin_define
define|#
directive|define
name|K3_RCTRL
value|0x04
end_define

begin_define
define|#
directive|define
name|K3_RALT
value|0x08
end_define

begin_define
define|#
directive|define
name|K3_ENHANCED
value|0x10
end_define

begin_define
define|#
directive|define
name|K3_FORCENLOCK
value|0x20
end_define

begin_define
define|#
directive|define
name|K3_TWOBYTE
value|0x40
end_define

begin_comment
comment|/* last code was first of 2 */
end_comment

begin_define
define|#
directive|define
name|K3_READID
value|0x80
end_define

begin_comment
comment|/* read ID in progress */
end_comment

begin_define
define|#
directive|define
name|K4_STATUS
value|BIOSDATA[0x97]
end_define

begin_define
define|#
directive|define
name|K4_SLOCK_LED
value|0x01
end_define

begin_define
define|#
directive|define
name|K4_NLOCK_LED
value|0x02
end_define

begin_define
define|#
directive|define
name|K4_CLOCK_LED
value|0x04
end_define

begin_define
define|#
directive|define
name|K4_ACK
value|0x10
end_define

begin_comment
comment|/* ACK recieved from keyboard */
end_comment

begin_define
define|#
directive|define
name|K4_RESEND
value|0x20
end_define

begin_comment
comment|/* RESEND recieved from keyboard */
end_comment

begin_define
define|#
directive|define
name|K4_LED
value|0x40
end_define

begin_comment
comment|/* LED update in progress */
end_comment

begin_define
define|#
directive|define
name|K4_ERROR
value|0x80
end_define

begin_function
specifier|static
name|void
name|Failure
parameter_list|(
name|void
modifier|*
name|arg
name|__unused
parameter_list|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"X Connection shutdown\n"
argument_list|)
expr_stmt|;
name|quit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|SetVREGCur
parameter_list|()
block|{
name|int
name|cp
init|=
name|row
operator|*
name|width
operator|+
name|col
decl_stmt|;
name|VGA_CRTC
index|[
name|CRTC_CurLocHi
index|]
operator|=
name|cp
operator|>>
literal|8
expr_stmt|;
name|VGA_CRTC
index|[
name|CRTC_CurLocLo
index|]
operator|=
name|cp
operator|&
literal|0xff
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|console_denit
parameter_list|(
name|void
modifier|*
name|arg
parameter_list|)
block|{
name|int
name|fd
init|=
operator|*
operator|(
name|int
operator|*
operator|)
name|arg
decl_stmt|;
ifdef|#
directive|ifdef
name|__FreeBSD__
if|if
condition|(
name|ioctl
argument_list|(
name|fd
argument_list|,
name|KDSKBMODE
argument_list|,
name|K_XLATE
argument_list|)
condition|)
name|perror
argument_list|(
literal|"KDSKBMODE/K_XLATE"
argument_list|)
expr_stmt|;
else|#
directive|else
ifdef|#
directive|ifdef
name|__NetBSD__
if|if
condition|(
name|ioctl
argument_list|(
name|fd
argument_list|,
name|CONSOLE_X_MODE_OFF
argument_list|,
literal|0
argument_list|)
condition|)
name|perror
argument_list|(
literal|"CONSOLE_X_MODE_OFF"
argument_list|)
expr_stmt|;
else|#
directive|else
comment|/* BSD/OS */
if|if
condition|(
name|ioctl
argument_list|(
name|fd
argument_list|,
name|PCCONIOCCOOK
argument_list|,
literal|0
argument_list|)
condition|)
name|perror
argument_list|(
literal|"PCCONIOCCOOK"
argument_list|)
expr_stmt|;
endif|#
directive|endif
endif|#
directive|endif
if|if
condition|(
name|tcsetattr
argument_list|(
name|fd
argument_list|,
name|TCSANOW
argument_list|,
operator|&
name|tty_cook
argument_list|)
condition|)
name|perror
argument_list|(
literal|"tcsetattr"
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|_kbd_event
parameter_list|(
name|int
name|fd
parameter_list|,
name|int
name|cond
parameter_list|,
name|void
modifier|*
name|arg
name|__unused
parameter_list|,
name|regcontext_t
modifier|*
name|REGS
name|__unused
parameter_list|)
block|{
if|if
condition|(
operator|!
operator|(
name|cond
operator|&
name|AS_RD
operator|)
condition|)
return|return;
name|printf
argument_list|(
literal|"_kbd_event: fd=%d\n"
argument_list|,
name|fd
argument_list|)
expr_stmt|;
name|kbd_read
operator|=
literal|1
expr_stmt|;
block|}
end_function

begin_function
name|void
name|console_init
parameter_list|()
block|{
name|int
name|fd
decl_stmt|;
name|caddr_t
name|addr
decl_stmt|;
if|if
condition|(
operator|(
name|fd
operator|=
name|open
argument_list|(
name|_PATH_DEV
literal|"vga"
argument_list|,
literal|2
argument_list|)
operator|)
operator|<
literal|0
condition|)
block|{
name|perror
argument_list|(
name|_PATH_DEV
literal|"vga"
argument_list|)
expr_stmt|;
name|quit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
name|addr
operator|=
name|mmap
argument_list|(
operator|(
name|caddr_t
operator|)
literal|0xA0000
argument_list|,
literal|5
operator|*
literal|64
operator|*
literal|1024
argument_list|,
name|PROT_EXEC
operator||
name|PROT_READ
operator||
name|PROT_WRITE
argument_list|,
name|MAP_FILE
operator||
name|MAP_FIXED
operator||
name|MAP_SHARED
argument_list|,
name|fd
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|addr
operator|!=
operator|(
name|caddr_t
operator|)
literal|0xA0000
condition|)
block|{
name|perror
argument_list|(
literal|"mmap"
argument_list|)
expr_stmt|;
name|quit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
if|#
directive|if
literal|0
block|addr = mmap((caddr_t)0x100000 - 0x1000, 0x1000, 		PROT_EXEC | PROT_READ | PROT_WRITE, 		MAP_FILE | MAP_FIXED | MAP_SHARED, 		fd, 0);     if (addr != (caddr_t)(0x100000 - 0x1000)) { 	perror("mmap"); 	quit(1);     }
endif|#
directive|endif
if|if
condition|(
operator|(
name|fd
operator|=
name|open
argument_list|(
name|_PATH_CONSOLE
argument_list|,
literal|2
argument_list|)
operator|)
operator|<
literal|0
condition|)
block|{
name|perror
argument_list|(
name|_PATH_CONSOLE
argument_list|)
expr_stmt|;
name|quit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
name|fd
operator|=
name|squirrel_fd
argument_list|(
name|fd
argument_list|)
expr_stmt|;
name|kbd_fd
operator|=
name|fd
expr_stmt|;
ifdef|#
directive|ifdef
name|__FreeBSD__
if|if
condition|(
name|ioctl
argument_list|(
name|fd
argument_list|,
name|KDSKBMODE
argument_list|,
name|K_RAW
argument_list|)
condition|)
block|{
name|perror
argument_list|(
literal|"KDSKBMODE/K_RAW"
argument_list|)
expr_stmt|;
name|quit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
else|#
directive|else
ifdef|#
directive|ifdef
name|__NetBSD__
if|if
condition|(
name|ioctl
argument_list|(
name|fd
argument_list|,
name|CONSOLE_X_MODE_ON
argument_list|,
literal|0
argument_list|)
condition|)
block|{
name|perror
argument_list|(
literal|"CONSOLE_X_MODE_ON"
argument_list|)
expr_stmt|;
name|quit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
else|#
directive|else
comment|/* BSD/OS */
if|if
condition|(
name|ioctl
argument_list|(
name|fd
argument_list|,
name|PCCONIOCRAW
argument_list|,
literal|0
argument_list|)
condition|)
block|{
name|perror
argument_list|(
literal|"PCCONIOCRAW"
argument_list|)
expr_stmt|;
name|quit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
endif|#
directive|endif
name|call_on_quit
argument_list|(
name|console_denit
argument_list|,
operator|&
name|kbd_fd
argument_list|)
expr_stmt|;
if|if
condition|(
name|fcntl
argument_list|(
name|fd
argument_list|,
name|F_SETFL
argument_list|,
name|O_NDELAY
operator||
name|O_ASYNC
argument_list|)
operator|<
literal|0
condition|)
block|{
name|perror
argument_list|(
literal|"fcntl"
argument_list|)
expr_stmt|;
name|quit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|tcgetattr
argument_list|(
name|fd
argument_list|,
operator|&
name|tty_cook
argument_list|)
condition|)
block|{
name|perror
argument_list|(
literal|"tcgetattr"
argument_list|)
expr_stmt|;
name|quit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
name|tty_raw
operator|=
name|tty_cook
expr_stmt|;
name|cfmakeraw
argument_list|(
operator|&
name|tty_raw
argument_list|)
expr_stmt|;
if|if
condition|(
name|tcsetattr
argument_list|(
name|fd
argument_list|,
name|TCSANOW
argument_list|,
operator|&
name|tty_raw
argument_list|)
condition|)
block|{
name|perror
argument_list|(
literal|"tcsetattr"
argument_list|)
expr_stmt|;
name|quit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
if|#
directive|if
literal|0
block|_RegisterIO(STDIN_FILENO, debug_event, 0, Failure);     _RegisterIO(fd, kbd_event, 0, Failure);
endif|#
directive|endif
name|_RegisterIO
argument_list|(
name|fd
argument_list|,
name|_kbd_event
argument_list|,
literal|0
argument_list|,
name|Failure
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|video_setborder
parameter_list|(
name|int
name|color
name|__unused
parameter_list|)
block|{
ifndef|#
directive|ifndef
name|NO_X
name|XSetWindowBackground
argument_list|(
name|dpy
argument_list|,
name|win
argument_list|,
name|pixels
index|[
name|color
operator|&
literal|0xf
index|]
argument_list|)
expr_stmt|;
endif|#
directive|endif
block|}
end_function

begin_function
name|void
name|video_blink
parameter_list|(
name|int
name|mode
parameter_list|)
block|{
name|blink
operator|=
name|mode
expr_stmt|;
block|}
end_function

begin_ifndef
ifndef|#
directive|ifndef
name|NO_X
end_ifndef

begin_function
specifier|static
name|void
name|setgc
parameter_list|(
name|u_short
name|attr
parameter_list|)
block|{
name|XGCValues
name|v
decl_stmt|;
if|if
condition|(
name|blink
operator|&&
operator|!
name|show
operator|&&
operator|(
name|attr
operator|&
literal|0x8000
operator|)
condition|)
name|v
operator|.
name|foreground
operator|=
name|pixels
index|[
operator|(
name|attr
operator|>>
literal|12
operator|)
operator|&
literal|0x07
index|]
expr_stmt|;
else|else
name|v
operator|.
name|foreground
operator|=
name|pixels
index|[
operator|(
name|attr
operator|>>
literal|8
operator|)
operator|&
literal|0x0f
index|]
expr_stmt|;
name|v
operator|.
name|background
operator|=
name|pixels
index|[
operator|(
name|attr
operator|>>
literal|12
operator|)
operator|&
operator|(
name|blink
condition|?
literal|0x07
else|:
literal|0x0f
operator|)
index|]
expr_stmt|;
name|XChangeGC
argument_list|(
name|dpy
argument_list|,
name|gc
argument_list|,
name|GCForeground
operator||
name|GCBackground
argument_list|,
operator|&
name|v
argument_list|)
expr_stmt|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_function
name|void
name|video_update
parameter_list|(
name|regcontext_t
modifier|*
name|REGS
name|__unused
parameter_list|)
block|{
ifndef|#
directive|ifndef
name|NO_X
specifier|static
name|int
name|icnt
init|=
literal|3
decl_stmt|;
if|if
condition|(
name|kbd_read
condition|)
name|kbd_event
argument_list|(
name|kbd_fd
argument_list|,
name|AS_RD
argument_list|,
literal|0
argument_list|,
name|REGS
argument_list|)
expr_stmt|;
if|if
condition|(
operator|--
name|icnt
operator|==
literal|0
condition|)
block|{
name|icnt
operator|=
literal|3
expr_stmt|;
name|lpt_poll
argument_list|()
expr_stmt|;
comment|/* Handle timeout on lpt code */
comment|/* quick and dirty */
if|if
condition|(
name|VGA_ATC
index|[
name|ATC_ModeCtrl
index|]
operator|&
literal|1
condition|)
name|video_update_graphics
argument_list|()
expr_stmt|;
else|else
name|video_update_text
argument_list|()
expr_stmt|;
block|}
endif|#
directive|endif
block|}
end_function

begin_ifndef
ifndef|#
directive|ifndef
name|NO_X
end_ifndef

begin_function
specifier|static
name|void
name|video_update_graphics
parameter_list|()
block|{
name|vram2ximage
argument_list|()
expr_stmt|;
name|XPutImage
argument_list|(
name|dpy
argument_list|,
name|win
argument_list|,
name|DefaultGC
argument_list|(
name|dpy
argument_list|,
name|DefaultScreen
argument_list|(
name|dpy
argument_list|)
argument_list|)
argument_list|,
name|xi
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
name|width
argument_list|,
name|height
argument_list|)
expr_stmt|;
name|XFlush
argument_list|(
name|dpy
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_function
specifier|static
name|void
name|video_update_text
parameter_list|()
block|{
specifier|static
name|int
name|or
init|=
operator|-
literal|1
decl_stmt|;
specifier|static
name|int
name|oc
init|=
operator|-
literal|1
decl_stmt|;
specifier|static
name|char
name|buf
index|[
literal|256
index|]
decl_stmt|;
name|int
name|r
decl_stmt|,
name|c
decl_stmt|;
name|int
name|attr
init|=
name|vmem
index|[
literal|0
index|]
operator|&
literal|0xff00
decl_stmt|;
name|XGCValues
name|v
decl_stmt|;
if|if
condition|(
name|xmode
condition|)
block|{
name|wakeup_poll
argument_list|()
expr_stmt|;
comment|/* Wake up anyone waiting on kbd poll */
name|show
operator|^=
literal|1
expr_stmt|;
name|setgc
argument_list|(
name|attr
argument_list|)
expr_stmt|;
for|for
control|(
name|r
operator|=
literal|0
init|;
name|r
operator|<
name|height
condition|;
operator|++
name|r
control|)
block|{
name|int
name|cc
init|=
literal|0
decl_stmt|;
if|if
condition|(
operator|!
name|lines
index|[
name|r
index|]
operator|.
name|changed
condition|)
block|{
if|if
condition|(
operator|(
name|r
operator|==
name|or
operator|||
name|r
operator|==
name|row
operator|)
operator|&&
operator|(
name|or
operator|!=
name|row
operator|||
name|oc
operator|!=
name|col
operator|)
condition|)
name|lines
index|[
name|r
index|]
operator|.
name|changed
operator|=
literal|1
expr_stmt|;
else|else
block|{
for|for
control|(
name|c
operator|=
literal|0
init|;
name|c
operator|<
name|width
condition|;
operator|++
name|c
control|)
block|{
if|if
condition|(
name|lines
index|[
name|r
index|]
operator|.
name|data
index|[
name|c
index|]
operator|!=
name|vmem
index|[
name|r
operator|*
name|width
operator|+
name|c
index|]
condition|)
block|{
name|lines
index|[
name|r
index|]
operator|.
name|changed
operator|=
literal|1
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|blink
operator|&&
name|lines
index|[
name|r
index|]
operator|.
name|data
index|[
name|c
index|]
operator|&
literal|0x8000
condition|)
block|{
name|lines
index|[
name|r
index|]
operator|.
name|changed
operator|=
literal|1
expr_stmt|;
break|break;
block|}
block|}
block|}
block|}
if|if
condition|(
operator|!
name|lines
index|[
name|r
index|]
operator|.
name|changed
condition|)
continue|continue;
name|reset_poll
argument_list|()
expr_stmt|;
name|lines
index|[
name|r
index|]
operator|.
name|changed
operator|=
literal|0
expr_stmt|;
name|memcpy
argument_list|(
name|lines
index|[
name|r
index|]
operator|.
name|data
argument_list|,
operator|&
name|vmem
index|[
name|r
operator|*
name|width
index|]
argument_list|,
sizeof|sizeof
argument_list|(
name|u_short
argument_list|)
operator|*
name|width
argument_list|)
expr_stmt|;
for|for
control|(
name|c
operator|=
literal|0
init|;
name|c
operator|<
name|width
condition|;
operator|++
name|c
control|)
block|{
name|int
name|cv
init|=
name|vmem
index|[
name|r
operator|*
name|width
operator|+
name|c
index|]
decl_stmt|;
if|if
condition|(
operator|(
name|cv
operator|&
literal|0xff00
operator|)
operator|!=
name|attr
condition|)
block|{
if|if
condition|(
name|cc
operator|<
name|c
condition|)
name|XDrawImageString
argument_list|(
name|dpy
argument_list|,
name|win
argument_list|,
name|gc
argument_list|,
literal|2
operator|+
name|cc
operator|*
name|FW
argument_list|,
literal|2
operator|+
operator|(
name|r
operator|+
literal|1
operator|)
operator|*
name|FH
argument_list|,
name|buf
operator|+
name|cc
argument_list|,
name|c
operator|-
name|cc
argument_list|)
expr_stmt|;
name|cc
operator|=
name|c
expr_stmt|;
name|attr
operator|=
name|cv
operator|&
literal|0xff00
expr_stmt|;
name|setgc
argument_list|(
name|attr
argument_list|)
expr_stmt|;
block|}
name|buf
index|[
name|c
index|]
operator|=
operator|(
name|cv
operator|&
literal|0xff
operator|)
condition|?
name|cv
operator|&
literal|0xff
else|:
literal|' '
expr_stmt|;
block|}
if|if
condition|(
name|cc
operator|<
name|c
condition|)
block|{
name|XDrawImageString
argument_list|(
name|dpy
argument_list|,
name|win
argument_list|,
name|gc
argument_list|,
literal|2
operator|+
name|cc
operator|*
name|FW
argument_list|,
literal|2
operator|+
operator|(
name|r
operator|+
literal|1
operator|)
operator|*
name|FH
argument_list|,
name|buf
operator|+
name|cc
argument_list|,
name|c
operator|-
name|cc
argument_list|)
expr_stmt|;
block|}
block|}
name|or
operator|=
name|row
expr_stmt|;
name|oc
operator|=
name|col
expr_stmt|;
if|if
condition|(
name|CursStart
operator|<=
name|CursEnd
operator|&&
name|CursEnd
operator|<=
name|FH
operator|&&
name|show
operator|&&
name|row
operator|<
name|height
operator|&&
name|col
operator|<
name|width
condition|)
block|{
name|attr
operator|=
name|vmem
index|[
name|row
operator|*
name|width
operator|+
name|col
index|]
operator|&
literal|0xff00
expr_stmt|;
name|v
operator|.
name|foreground
operator|=
name|pixels
index|[
operator|(
name|attr
operator|>>
literal|8
operator|)
operator|&
literal|0x0f
index|]
operator|^
name|pixels
index|[
operator|(
name|attr
operator|>>
literal|12
operator|)
operator|&
operator|(
name|blink
condition|?
literal|0x07
else|:
literal|0x0f
operator|)
index|]
expr_stmt|;
if|if
condition|(
name|v
operator|.
name|foreground
condition|)
block|{
name|v
operator|.
name|function
operator|=
name|GXxor
expr_stmt|;
block|}
else|else
block|{
name|v
operator|.
name|foreground
operator|=
name|pixels
index|[
literal|7
index|]
expr_stmt|;
name|v
operator|.
name|function
operator|=
name|GXcopy
expr_stmt|;
block|}
name|XChangeGC
argument_list|(
name|dpy
argument_list|,
name|cgc
argument_list|,
name|GCForeground
operator||
name|GCFunction
argument_list|,
operator|&
name|v
argument_list|)
expr_stmt|;
name|XFillRectangle
argument_list|(
name|dpy
argument_list|,
name|win
argument_list|,
name|cgc
argument_list|,
literal|2
operator|+
name|col
operator|*
name|FW
argument_list|,
literal|2
operator|+
name|row
operator|*
name|FH
operator|+
name|CursStart
operator|+
name|FD
argument_list|,
name|FW
argument_list|,
name|CursEnd
operator|+
literal|1
operator|-
name|CursStart
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|mouse_status
operator|.
name|installed
operator|&&
name|mouse_status
operator|.
name|show
condition|)
block|{
name|c
operator|=
name|mouse_status
operator|.
name|x
operator|/
name|mouse_status
operator|.
name|hmickey
expr_stmt|;
name|r
operator|=
name|mouse_status
operator|.
name|y
operator|/
name|mouse_status
operator|.
name|vmickey
expr_stmt|;
name|lines
index|[
name|r
index|]
operator|.
name|changed
operator|=
literal|1
expr_stmt|;
name|attr
operator|=
name|vmem
index|[
name|r
operator|*
name|width
operator|+
name|c
index|]
operator|&
literal|0xff00
expr_stmt|;
name|v
operator|.
name|foreground
operator|=
name|pixels
index|[
operator|(
name|attr
operator|>>
literal|8
operator|)
operator|&
literal|0x0f
index|]
operator|^
name|pixels
index|[
operator|(
name|attr
operator|>>
literal|12
operator|)
operator|&
literal|0x0f
index|]
expr_stmt|;
if|if
condition|(
name|v
operator|.
name|foreground
condition|)
block|{
name|v
operator|.
name|function
operator|=
name|GXxor
expr_stmt|;
block|}
else|else
block|{
name|v
operator|.
name|foreground
operator|=
name|pixels
index|[
literal|7
index|]
expr_stmt|;
name|v
operator|.
name|function
operator|=
name|GXcopy
expr_stmt|;
block|}
name|XChangeGC
argument_list|(
name|dpy
argument_list|,
name|cgc
argument_list|,
name|GCForeground
operator||
name|GCFunction
argument_list|,
operator|&
name|v
argument_list|)
expr_stmt|;
name|XFillRectangle
argument_list|(
name|dpy
argument_list|,
name|win
argument_list|,
name|cgc
argument_list|,
literal|2
operator|+
name|c
operator|*
name|FW
argument_list|,
literal|2
operator|+
name|r
operator|*
name|FH
operator|+
literal|2
argument_list|,
name|FW
argument_list|,
name|FH
argument_list|)
expr_stmt|;
block|}
name|XFlush
argument_list|(
name|dpy
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/* Convert the contents of the video RAM into an XImage.     Bugs: - The function is way too slow. 	 - It only works for the 16 color modes. 	 - It only works on 15/16-bit TrueColor visuals. */
end_comment

begin_function
specifier|static
name|void
name|vram2ximage
parameter_list|()
block|{
name|int
name|i
decl_stmt|,
name|x
decl_stmt|,
name|y
decl_stmt|,
name|yoffset
decl_stmt|;
name|u_int16_t
modifier|*
name|image
init|=
operator|(
name|u_int16_t
operator|*
operator|)
name|xi
operator|->
name|data
decl_stmt|;
name|yoffset
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|y
operator|=
literal|0
init|;
name|y
operator|<
name|height
condition|;
name|y
operator|++
control|)
block|{
name|yoffset
operator|+=
name|width
operator|/
literal|8
expr_stmt|;
for|for
control|(
name|x
operator|=
literal|0
init|;
name|x
operator|<
name|width
condition|;
name|x
operator|+=
literal|8
control|)
block|{
name|int
name|offset
init|=
name|yoffset
operator|+
name|x
operator|/
literal|8
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|8
condition|;
name|i
operator|++
control|)
block|{
name|int
name|color
init|=
name|lut
index|[
literal|0
index|]
index|[
name|vplane0
index|[
name|offset
index|]
index|]
index|[
name|i
index|]
operator||
name|lut
index|[
literal|1
index|]
index|[
name|vplane1
index|[
name|offset
index|]
index|]
index|[
name|i
index|]
operator||
name|lut
index|[
literal|2
index|]
index|[
name|vplane2
index|[
name|offset
index|]
index|]
index|[
name|i
index|]
operator||
name|lut
index|[
literal|3
index|]
index|[
name|vplane3
index|[
name|offset
index|]
index|]
index|[
name|i
index|]
decl_stmt|;
operator|*
name|image
operator|++
operator|=
operator|(
name|u_int16_t
operator|)
name|pixels
index|[
name|color
index|]
expr_stmt|;
block|}
block|}
block|}
return|return;
block|}
end_function

begin_decl_stmt
specifier|static
name|u_short
name|Ascii2Scan
index|[]
init|=
block|{
literal|0xffff
block|,
literal|0xffff
block|,
literal|0xffff
block|,
literal|0xffff
block|,
literal|0xffff
block|,
literal|0xffff
block|,
literal|0xffff
block|,
literal|0xffff
block|,
literal|0x000e
block|,
literal|0x000f
block|,
literal|0xffff
block|,
literal|0xffff
block|,
literal|0xffff
block|,
literal|0x001c
block|,
literal|0xffff
block|,
literal|0xffff
block|,
literal|0xffff
block|,
literal|0xffff
block|,
literal|0xffff
block|,
literal|0xffff
block|,
literal|0xffff
block|,
literal|0xffff
block|,
literal|0xffff
block|,
literal|0xffff
block|,
literal|0xffff
block|,
literal|0xffff
block|,
literal|0xffff
block|,
literal|0x0001
block|,
literal|0xffff
block|,
literal|0xffff
block|,
literal|0xffff
block|,
literal|0xffff
block|,
literal|0x0039
block|,
literal|0x0102
block|,
literal|0x0128
block|,
literal|0x0104
block|,
literal|0x0105
block|,
literal|0x0106
block|,
literal|0x0108
block|,
literal|0x0028
block|,
literal|0x010a
block|,
literal|0x010b
block|,
literal|0x0109
block|,
literal|0x010d
block|,
literal|0x0033
block|,
literal|0x000c
block|,
literal|0x0034
block|,
literal|0x0035
block|,
literal|0x000b
block|,
literal|0x0002
block|,
literal|0x0003
block|,
literal|0x0004
block|,
literal|0x0005
block|,
literal|0x0006
block|,
literal|0x0007
block|,
literal|0x0008
block|,
literal|0x0009
block|,
literal|0x000a
block|,
literal|0x0127
block|,
literal|0x0027
block|,
literal|0x0133
block|,
literal|0x000d
block|,
literal|0x0134
block|,
literal|0x0135
block|,
literal|0x0103
block|,
literal|0x011e
block|,
literal|0x0130
block|,
literal|0x012e
block|,
literal|0x0120
block|,
literal|0x0112
block|,
literal|0x0121
block|,
literal|0x0122
block|,
literal|0x0123
block|,
literal|0x0117
block|,
literal|0x0124
block|,
literal|0x0125
block|,
literal|0x0126
block|,
literal|0x0132
block|,
literal|0x0131
block|,
literal|0x0118
block|,
literal|0x0119
block|,
literal|0x0110
block|,
literal|0x0113
block|,
literal|0x011f
block|,
literal|0x0114
block|,
literal|0x0116
block|,
literal|0x012f
block|,
literal|0x0111
block|,
literal|0x012d
block|,
literal|0x0115
block|,
literal|0x012c
block|,
literal|0x001a
block|,
literal|0x002b
block|,
literal|0x001b
block|,
literal|0x0107
block|,
literal|0x010c
block|,
literal|0x0029
block|,
literal|0x001e
block|,
literal|0x0030
block|,
literal|0x002e
block|,
literal|0x0020
block|,
literal|0x0012
block|,
literal|0x0021
block|,
literal|0x0022
block|,
literal|0x0023
block|,
literal|0x0017
block|,
literal|0x0024
block|,
literal|0x0025
block|,
literal|0x0026
block|,
literal|0x0032
block|,
literal|0x0031
block|,
literal|0x0018
block|,
literal|0x0019
block|,
literal|0x0010
block|,
literal|0x0013
block|,
literal|0x001f
block|,
literal|0x0014
block|,
literal|0x0016
block|,
literal|0x002f
block|,
literal|0x0011
block|,
literal|0x002d
block|,
literal|0x0015
block|,
literal|0x002c
block|,
literal|0x011a
block|,
literal|0x012b
block|,
literal|0x011b
block|,
literal|0x0129
block|,
literal|0xffff
block|, }
decl_stmt|;
end_decl_stmt

begin_endif
endif|#
directive|endif
end_endif

begin_struct
struct|struct
block|{
name|u_short
name|base
decl_stmt|;
name|u_short
name|shift
decl_stmt|;
name|u_short
name|ctrl
decl_stmt|;
name|u_short
name|alt
decl_stmt|;
block|}
name|ScanCodes
index|[]
init|=
block|{
block|{
literal|0xffff
block|,
literal|0xffff
block|,
literal|0xffff
block|,
literal|0xffff
block|}
block|,
comment|/* key  0 */
block|{
literal|0x011b
block|,
literal|0x011b
block|,
literal|0x011b
block|,
literal|0xffff
block|}
block|,
comment|/* key  1 - Escape key */
block|{
literal|0x0231
block|,
literal|0x0221
block|,
literal|0xffff
block|,
literal|0x7800
block|}
block|,
comment|/* key  2 - '1' */
block|{
literal|0x0332
block|,
literal|0x0340
block|,
literal|0x0300
block|,
literal|0x7900
block|}
block|,
comment|/* key  3 - '2' - special handling */
block|{
literal|0x0433
block|,
literal|0x0423
block|,
literal|0xffff
block|,
literal|0x7a00
block|}
block|,
comment|/* key  4 - '3' */
block|{
literal|0x0534
block|,
literal|0x0524
block|,
literal|0xffff
block|,
literal|0x7b00
block|}
block|,
comment|/* key  5 - '4' */
block|{
literal|0x0635
block|,
literal|0x0625
block|,
literal|0xffff
block|,
literal|0x7c00
block|}
block|,
comment|/* key  6 - '5' */
block|{
literal|0x0736
block|,
literal|0x075e
block|,
literal|0x071e
block|,
literal|0x7d00
block|}
block|,
comment|/* key  7 - '6' */
block|{
literal|0x0837
block|,
literal|0x0826
block|,
literal|0xffff
block|,
literal|0x7e00
block|}
block|,
comment|/* key  8 - '7' */
block|{
literal|0x0938
block|,
literal|0x092a
block|,
literal|0xffff
block|,
literal|0x7f00
block|}
block|,
comment|/* key  9 - '8' */
block|{
literal|0x0a39
block|,
literal|0x0a28
block|,
literal|0xffff
block|,
literal|0x8000
block|}
block|,
comment|/* key 10 - '9' */
block|{
literal|0x0b30
block|,
literal|0x0b29
block|,
literal|0xffff
block|,
literal|0x8100
block|}
block|,
comment|/* key 11 - '0' */
block|{
literal|0x0c2d
block|,
literal|0x0c5f
block|,
literal|0x0c1f
block|,
literal|0x8200
block|}
block|,
comment|/* key 12 - '-' */
block|{
literal|0x0d3d
block|,
literal|0x0d2b
block|,
literal|0xffff
block|,
literal|0x8300
block|}
block|,
comment|/* key 13 - '=' */
block|{
literal|0x0e08
block|,
literal|0x0e08
block|,
literal|0x0e7f
block|,
literal|0xffff
block|}
block|,
comment|/* key 14 - backspace */
block|{
literal|0x0f09
block|,
literal|0x0f00
block|,
literal|0xffff
block|,
literal|0xffff
block|}
block|,
comment|/* key 15 - tab */
block|{
literal|0x1071
block|,
literal|0x1051
block|,
literal|0x1011
block|,
literal|0x1000
block|}
block|,
comment|/* key 16 - 'Q' */
block|{
literal|0x1177
block|,
literal|0x1157
block|,
literal|0x1117
block|,
literal|0x1100
block|}
block|,
comment|/* key 17 - 'W' */
block|{
literal|0x1265
block|,
literal|0x1245
block|,
literal|0x1205
block|,
literal|0x1200
block|}
block|,
comment|/* key 18 - 'E' */
block|{
literal|0x1372
block|,
literal|0x1352
block|,
literal|0x1312
block|,
literal|0x1300
block|}
block|,
comment|/* key 19 - 'R' */
block|{
literal|0x1474
block|,
literal|0x1454
block|,
literal|0x1414
block|,
literal|0x1400
block|}
block|,
comment|/* key 20 - 'T' */
block|{
literal|0x1579
block|,
literal|0x1559
block|,
literal|0x1519
block|,
literal|0x1500
block|}
block|,
comment|/* key 21 - 'Y' */
block|{
literal|0x1675
block|,
literal|0x1655
block|,
literal|0x1615
block|,
literal|0x1600
block|}
block|,
comment|/* key 22 - 'U' */
block|{
literal|0x1769
block|,
literal|0x1749
block|,
literal|0x1709
block|,
literal|0x1700
block|}
block|,
comment|/* key 23 - 'I' */
block|{
literal|0x186f
block|,
literal|0x184f
block|,
literal|0x180f
block|,
literal|0x1800
block|}
block|,
comment|/* key 24 - 'O' */
block|{
literal|0x1970
block|,
literal|0x1950
block|,
literal|0x1910
block|,
literal|0x1900
block|}
block|,
comment|/* key 25 - 'P' */
block|{
literal|0x1a5b
block|,
literal|0x1a7b
block|,
literal|0x1a1b
block|,
literal|0xffff
block|}
block|,
comment|/* key 26 - '[' */
block|{
literal|0x1b5d
block|,
literal|0x1b7d
block|,
literal|0x1b1d
block|,
literal|0xffff
block|}
block|,
comment|/* key 27 - ']' */
block|{
literal|0x1c0d
block|,
literal|0x1c0d
block|,
literal|0x1c0a
block|,
literal|0xffff
block|}
block|,
comment|/* key 28 - CR */
block|{
literal|0xffff
block|,
literal|0xffff
block|,
literal|0xffff
block|,
literal|0xffff
block|}
block|,
comment|/* key 29 - control */
block|{
literal|0x1e61
block|,
literal|0x1e41
block|,
literal|0x1e01
block|,
literal|0x1e00
block|}
block|,
comment|/* key 30 - 'A' */
block|{
literal|0x1f73
block|,
literal|0x1f53
block|,
literal|0x1f13
block|,
literal|0x1f00
block|}
block|,
comment|/* key 31 - 'S' */
block|{
literal|0x2064
block|,
literal|0x2044
block|,
literal|0x2004
block|,
literal|0x2000
block|}
block|,
comment|/* key 32 - 'D' */
block|{
literal|0x2166
block|,
literal|0x2146
block|,
literal|0x2106
block|,
literal|0x2100
block|}
block|,
comment|/* key 33 - 'F' */
block|{
literal|0x2267
block|,
literal|0x2247
block|,
literal|0x2207
block|,
literal|0x2200
block|}
block|,
comment|/* key 34 - 'G' */
block|{
literal|0x2368
block|,
literal|0x2348
block|,
literal|0x2308
block|,
literal|0x2300
block|}
block|,
comment|/* key 35 - 'H' */
block|{
literal|0x246a
block|,
literal|0x244a
block|,
literal|0x240a
block|,
literal|0x2400
block|}
block|,
comment|/* key 36 - 'J' */
block|{
literal|0x256b
block|,
literal|0x254b
block|,
literal|0x250b
block|,
literal|0x2500
block|}
block|,
comment|/* key 37 - 'K' */
block|{
literal|0x266c
block|,
literal|0x264c
block|,
literal|0x260c
block|,
literal|0x2600
block|}
block|,
comment|/* key 38 - 'L' */
block|{
literal|0x273b
block|,
literal|0x273a
block|,
literal|0xffff
block|,
literal|0xffff
block|}
block|,
comment|/* key 39 - ';' */
block|{
literal|0x2827
block|,
literal|0x2822
block|,
literal|0xffff
block|,
literal|0xffff
block|}
block|,
comment|/* key 40 - ''' */
block|{
literal|0x2960
block|,
literal|0x297e
block|,
literal|0xffff
block|,
literal|0xffff
block|}
block|,
comment|/* key 41 - '`' */
block|{
literal|0xffff
block|,
literal|0xffff
block|,
literal|0xffff
block|,
literal|0xffff
block|}
block|,
comment|/* key 42 - left shift */
block|{
literal|0x2b5c
block|,
literal|0x2b7c
block|,
literal|0x2b1c
block|,
literal|0xffff
block|}
block|,
comment|/* key 43 - '' */
block|{
literal|0x2c7a
block|,
literal|0x2c5a
block|,
literal|0x2c1a
block|,
literal|0x2c00
block|}
block|,
comment|/* key 44 - 'Z' */
block|{
literal|0x2d78
block|,
literal|0x2d58
block|,
literal|0x2d18
block|,
literal|0x2d00
block|}
block|,
comment|/* key 45 - 'X' */
block|{
literal|0x2e63
block|,
literal|0x2e43
block|,
literal|0x2e03
block|,
literal|0x2e00
block|}
block|,
comment|/* key 46 - 'C' */
block|{
literal|0x2f76
block|,
literal|0x2f56
block|,
literal|0x2f16
block|,
literal|0x2f00
block|}
block|,
comment|/* key 47 - 'V' */
block|{
literal|0x3062
block|,
literal|0x3042
block|,
literal|0x3002
block|,
literal|0x3000
block|}
block|,
comment|/* key 48 - 'B' */
block|{
literal|0x316e
block|,
literal|0x314e
block|,
literal|0x310e
block|,
literal|0x3100
block|}
block|,
comment|/* key 49 - 'N' */
block|{
literal|0x326d
block|,
literal|0x324d
block|,
literal|0x320d
block|,
literal|0x3200
block|}
block|,
comment|/* key 50 - 'M' */
block|{
literal|0x332c
block|,
literal|0x333c
block|,
literal|0xffff
block|,
literal|0xffff
block|}
block|,
comment|/* key 51 - ',' */
block|{
literal|0x342e
block|,
literal|0x343e
block|,
literal|0xffff
block|,
literal|0xffff
block|}
block|,
comment|/* key 52 - '.' */
block|{
literal|0x352f
block|,
literal|0x353f
block|,
literal|0xffff
block|,
literal|0xffff
block|}
block|,
comment|/* key 53 - '/' */
block|{
literal|0xffff
block|,
literal|0xffff
block|,
literal|0xffff
block|,
literal|0xffff
block|}
block|,
comment|/* key 54 - right shift - */
block|{
literal|0x372a
block|,
literal|0xffff
block|,
literal|0x3772
block|,
literal|0xffff
block|}
block|,
comment|/* key 55 - prt-scr - */
block|{
literal|0xffff
block|,
literal|0xffff
block|,
literal|0xffff
block|,
literal|0xffff
block|}
block|,
comment|/* key 56 - Alt - */
block|{
literal|0x3920
block|,
literal|0x3920
block|,
literal|0x3920
block|,
literal|0x3920
block|}
block|,
comment|/* key 57 - space bar */
block|{
literal|0xffff
block|,
literal|0xffff
block|,
literal|0xffff
block|,
literal|0xffff
block|}
block|,
comment|/* key 58 - caps-lock -  */
block|{
literal|0x3b00
block|,
literal|0x5400
block|,
literal|0x5e00
block|,
literal|0x6800
block|}
block|,
comment|/* key 59 - F1 */
block|{
literal|0x3c00
block|,
literal|0x5500
block|,
literal|0x5f00
block|,
literal|0x6900
block|}
block|,
comment|/* key 60 - F2 */
block|{
literal|0x3d00
block|,
literal|0x5600
block|,
literal|0x6000
block|,
literal|0x6a00
block|}
block|,
comment|/* key 61 - F3 */
block|{
literal|0x3e00
block|,
literal|0x5700
block|,
literal|0x6100
block|,
literal|0x6b00
block|}
block|,
comment|/* key 62 - F4 */
block|{
literal|0x3f00
block|,
literal|0x5800
block|,
literal|0x6200
block|,
literal|0x6c00
block|}
block|,
comment|/* key 63 - F5 */
block|{
literal|0x4000
block|,
literal|0x5900
block|,
literal|0x6300
block|,
literal|0x6d00
block|}
block|,
comment|/* key 64 - F6 */
block|{
literal|0x4100
block|,
literal|0x5a00
block|,
literal|0x6400
block|,
literal|0x6e00
block|}
block|,
comment|/* key 65 - F7 */
block|{
literal|0x4200
block|,
literal|0x5b00
block|,
literal|0x6500
block|,
literal|0x6f00
block|}
block|,
comment|/* key 66 - F8 */
block|{
literal|0x4300
block|,
literal|0x5c00
block|,
literal|0x6600
block|,
literal|0x7000
block|}
block|,
comment|/* key 67 - F9 */
block|{
literal|0x4400
block|,
literal|0x5d00
block|,
literal|0x6700
block|,
literal|0x7100
block|}
block|,
comment|/* key 68 - F10 */
block|{
literal|0xffff
block|,
literal|0xffff
block|,
literal|0xffff
block|,
literal|0xffff
block|}
block|,
comment|/* key 69 - num-lock - */
block|{
literal|0xffff
block|,
literal|0xffff
block|,
literal|0xffff
block|,
literal|0xffff
block|}
block|,
comment|/* key 70 - scroll-lock -  */
block|{
literal|0x4700
block|,
literal|0x4737
block|,
literal|0x7700
block|,
literal|0xffff
block|}
block|,
comment|/* key 71 - home */
block|{
literal|0x4800
block|,
literal|0x4838
block|,
literal|0xffff
block|,
literal|0xffff
block|}
block|,
comment|/* key 72 - cursor up */
block|{
literal|0x4900
block|,
literal|0x4939
block|,
literal|0x8400
block|,
literal|0xffff
block|}
block|,
comment|/* key 73 - page up */
block|{
literal|0x4a2d
block|,
literal|0x4a2d
block|,
literal|0xffff
block|,
literal|0xffff
block|}
block|,
comment|/* key 74 - minus sign */
block|{
literal|0x4b00
block|,
literal|0x4b34
block|,
literal|0x7300
block|,
literal|0xffff
block|}
block|,
comment|/* key 75 - cursor left */
block|{
literal|0xffff
block|,
literal|0x4c35
block|,
literal|0xffff
block|,
literal|0xffff
block|}
block|,
comment|/* key 76 - center key */
block|{
literal|0x4d00
block|,
literal|0x4d36
block|,
literal|0x7400
block|,
literal|0xffff
block|}
block|,
comment|/* key 77 - cursor right */
block|{
literal|0x4e2b
block|,
literal|0x4e2b
block|,
literal|0xffff
block|,
literal|0xffff
block|}
block|,
comment|/* key 78 - plus sign */
block|{
literal|0x4f00
block|,
literal|0x4f31
block|,
literal|0x7500
block|,
literal|0xffff
block|}
block|,
comment|/* key 79 - end */
block|{
literal|0x5000
block|,
literal|0x5032
block|,
literal|0xffff
block|,
literal|0xffff
block|}
block|,
comment|/* key 80 - cursor down */
block|{
literal|0x5100
block|,
literal|0x5133
block|,
literal|0x7600
block|,
literal|0xffff
block|}
block|,
comment|/* key 81 - page down */
block|{
literal|0x5200
block|,
literal|0x5230
block|,
literal|0xffff
block|,
literal|0xffff
block|}
block|,
comment|/* key 82 - insert */
block|{
literal|0x5300
block|,
literal|0x532e
block|,
literal|0xffff
block|,
literal|0xffff
block|}
block|,
comment|/* key 83 - delete */
block|{
literal|0xffff
block|,
literal|0xffff
block|,
literal|0xffff
block|,
literal|0xffff
block|}
block|,
comment|/* key 84 - sys key */
block|{
literal|0xffff
block|,
literal|0xffff
block|,
literal|0xffff
block|,
literal|0xffff
block|}
block|,
comment|/* key 85 */
block|{
literal|0xffff
block|,
literal|0xffff
block|,
literal|0xffff
block|,
literal|0xffff
block|}
block|,
comment|/* key 86 */
block|{
literal|0x8500
block|,
literal|0x5787
block|,
literal|0x8900
block|,
literal|0x8b00
block|}
block|,
comment|/* key 87 - F11 */
block|{
literal|0x8600
block|,
literal|0x5888
block|,
literal|0x8a00
block|,
literal|0x8c00
block|}
block|,
comment|/* key 88 - F12 */
block|}
struct|;
end_struct

begin_ifndef
ifndef|#
directive|ifndef
name|NO_X
end_ifndef

begin_function
name|void
name|debug_event
parameter_list|(
name|int
name|fd
name|__unused
parameter_list|,
name|int
name|cond
parameter_list|,
name|void
modifier|*
name|arg
name|__unused
parameter_list|,
name|regcontext_t
modifier|*
name|REGS
parameter_list|)
block|{
specifier|static
name|char
name|ibuf
index|[
literal|1024
index|]
decl_stmt|;
specifier|static
name|int
name|icnt
init|=
literal|0
decl_stmt|;
specifier|static
name|u_short
name|ds
init|=
literal|0
decl_stmt|;
specifier|static
name|u_short
name|di
init|=
literal|0
decl_stmt|;
specifier|static
name|u_short
name|cnt
init|=
literal|16
operator|*
literal|8
decl_stmt|;
name|char
modifier|*
name|ep
decl_stmt|;
name|int
name|r
decl_stmt|;
if|if
condition|(
operator|!
operator|(
name|cond
operator|&
name|AS_RD
operator|)
condition|)
return|return;
name|r
operator|=
name|read
argument_list|(
name|STDIN_FILENO
argument_list|,
name|ibuf
operator|+
name|icnt
argument_list|,
sizeof|sizeof
argument_list|(
name|ibuf
argument_list|)
operator|-
name|icnt
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
operator|<=
literal|0
condition|)
return|return;
name|icnt
operator|+=
name|r
expr_stmt|;
name|ibuf
index|[
name|icnt
index|]
operator|=
literal|0
expr_stmt|;
while|while
condition|(
operator|(
name|ep
operator|=
name|strchr
argument_list|(
name|ibuf
argument_list|,
literal|'\n'
argument_list|)
operator|)
operator|!=
literal|0
condition|)
block|{
name|int
name|ac
decl_stmt|;
name|char
modifier|*
name|_av
index|[
literal|16
index|]
decl_stmt|;
name|char
modifier|*
modifier|*
name|av
decl_stmt|;
operator|*
name|ep
operator|++
operator|=
literal|0
expr_stmt|;
name|ac
operator|=
name|ParseBuffer
argument_list|(
name|ibuf
argument_list|,
name|av
operator|=
name|_av
argument_list|,
literal|16
argument_list|)
expr_stmt|;
if|if
condition|(
name|ac
operator|>
literal|0
condition|)
block|{
if|if
condition|(
operator|!
name|strcasecmp
argument_list|(
name|av
index|[
literal|0
index|]
argument_list|,
literal|"dump"
argument_list|)
condition|)
block|{
if|if
condition|(
name|ac
operator|>
literal|1
condition|)
block|{
name|char
modifier|*
name|c
decl_stmt|;
if|if
condition|(
operator|(
name|c
operator|=
name|strchr
argument_list|(
name|av
index|[
literal|1
index|]
argument_list|,
literal|':'
argument_list|)
operator|)
operator|!=
literal|0
condition|)
block|{
name|ds
operator|=
name|strtol
argument_list|(
name|av
index|[
literal|1
index|]
argument_list|,
literal|0
argument_list|,
literal|16
argument_list|)
expr_stmt|;
name|di
operator|=
name|strtol
argument_list|(
name|c
operator|+
literal|1
argument_list|,
literal|0
argument_list|,
literal|16
argument_list|)
expr_stmt|;
block|}
else|else
name|di
operator|=
name|strtol
argument_list|(
name|av
index|[
literal|1
index|]
argument_list|,
literal|0
argument_list|,
literal|16
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|ac
operator|>
literal|2
condition|)
name|cnt
operator|=
name|strtol
argument_list|(
name|av
index|[
literal|2
index|]
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|cnt
operator|=
operator|(
name|cnt
operator|+
literal|0xf
operator|)
operator|&
operator|~
literal|0xf
expr_stmt|;
if|if
condition|(
name|cnt
operator|==
literal|0
condition|)
name|cnt
operator|=
literal|0x10
expr_stmt|;
name|di
operator|&=
operator|~
literal|0xf
expr_stmt|;
for|for
control|(
name|r
operator|=
literal|0
init|;
name|r
operator|<
name|cnt
condition|;
name|r
operator|+=
literal|0x10
operator|,
name|di
operator|=
operator|(
name|di
operator|+
literal|0x10
operator|)
operator|&
literal|0xffff
control|)
block|{
name|int
name|i
decl_stmt|;
name|u_char
modifier|*
name|ap
init|=
operator|(
name|u_char
operator|*
operator|)
operator|(
operator|(
operator|(
name|u_long
operator|)
name|ds
operator|<<
literal|4
operator|)
operator|+
name|di
operator|)
decl_stmt|;
name|printf
argument_list|(
literal|"%04x:%04x:"
argument_list|,
name|ds
argument_list|,
name|di
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|8
condition|;
operator|++
name|i
control|)
name|printf
argument_list|(
literal|" %02x"
argument_list|,
name|ap
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|" "
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|8
init|;
name|i
operator|<
literal|16
condition|;
operator|++
name|i
control|)
name|printf
argument_list|(
literal|" %02x"
argument_list|,
name|ap
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|": "
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|8
condition|;
operator|++
name|i
control|)
name|printf
argument_list|(
literal|"%c"
argument_list|,
operator|(
name|ap
index|[
name|i
index|]
operator|<
literal|' '
operator|||
name|ap
index|[
name|i
index|]
operator|>
literal|'~'
operator|)
condition|?
literal|'.'
else|:
name|ap
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|" "
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|8
init|;
name|i
operator|<
literal|16
condition|;
operator|++
name|i
control|)
name|printf
argument_list|(
literal|"%c"
argument_list|,
operator|(
name|ap
index|[
name|i
index|]
operator|<
literal|' '
operator|||
name|ap
index|[
name|i
index|]
operator|>
literal|'~'
operator|)
condition|?
literal|'.'
else|:
name|ap
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
block|}
block|}
elseif|else
if|if
condition|(
operator|!
name|strcasecmp
argument_list|(
name|av
index|[
literal|0
index|]
argument_list|,
literal|"dis"
argument_list|)
condition|)
block|{
name|u_char
modifier|*
name|ap
init|=
operator|(
name|u_char
operator|*
operator|)
operator|(
operator|(
operator|(
name|u_long
operator|)
name|ds
operator|<<
literal|4
operator|)
operator|+
name|di
operator|)
decl_stmt|;
if|if
condition|(
name|ac
operator|>
literal|1
condition|)
block|{
name|char
modifier|*
name|c
decl_stmt|;
if|if
condition|(
operator|(
name|c
operator|=
name|strchr
argument_list|(
name|av
index|[
literal|1
index|]
argument_list|,
literal|':'
argument_list|)
operator|)
operator|!=
literal|0
condition|)
block|{
name|ds
operator|=
name|strtol
argument_list|(
name|av
index|[
literal|1
index|]
argument_list|,
literal|0
argument_list|,
literal|16
argument_list|)
expr_stmt|;
name|di
operator|=
name|strtol
argument_list|(
name|c
operator|+
literal|1
argument_list|,
literal|0
argument_list|,
literal|16
argument_list|)
expr_stmt|;
block|}
else|else
name|di
operator|=
name|strtol
argument_list|(
name|av
index|[
literal|1
index|]
argument_list|,
literal|0
argument_list|,
literal|16
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|ac
operator|>
literal|2
condition|)
name|cnt
operator|=
name|strtol
argument_list|(
name|av
index|[
literal|2
index|]
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
for|for
control|(
name|r
operator|=
literal|0
init|;
name|r
operator|<
name|cnt
condition|;
operator|++
name|r
control|)
block|{
name|char
name|buf
index|[
literal|16
index|]
decl_stmt|;
name|int
name|c
init|=
name|i386dis
argument_list|(
name|ds
argument_list|,
name|di
argument_list|,
name|ap
argument_list|,
name|buf
argument_list|,
literal|0
argument_list|)
decl_stmt|;
name|printf
argument_list|(
literal|"%04x:%04x %s\n"
argument_list|,
name|ds
argument_list|,
name|di
argument_list|,
name|buf
argument_list|)
expr_stmt|;
name|di
operator|+=
name|c
expr_stmt|;
name|ap
operator|+=
name|c
expr_stmt|;
block|}
block|}
elseif|else
if|if
condition|(
operator|!
name|strcasecmp
argument_list|(
name|av
index|[
literal|0
index|]
argument_list|,
literal|"regs"
argument_list|)
condition|)
block|{
name|dump_regs
argument_list|(
name|REGS
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|!
name|strcasecmp
argument_list|(
name|av
index|[
literal|0
index|]
argument_list|,
literal|"force"
argument_list|)
condition|)
block|{
name|char
modifier|*
name|p
init|=
name|av
index|[
literal|1
index|]
decl_stmt|;
while|while
condition|(
operator|(
name|p
operator|=
operator|*
operator|++
name|av
operator|)
operator|!=
literal|0
condition|)
block|{
while|while
condition|(
operator|*
name|p
condition|)
block|{
if|if
condition|(
operator|*
name|p
operator|>=
literal|' '
operator|&&
operator|*
name|p
operator|<=
literal|'~'
condition|)
name|KbdWrite
argument_list|(
name|ScanCodes
index|[
name|Ascii2Scan
index|[
operator|(
name|int
operator|)
operator|*
name|p
index|]
operator|&
literal|0xff
index|]
operator|.
name|base
argument_list|)
expr_stmt|;
operator|++
name|p
expr_stmt|;
block|}
block|}
name|KbdWrite
argument_list|(
name|ScanCodes
index|[
literal|28
index|]
operator|.
name|base
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|!
name|strcasecmp
argument_list|(
name|av
index|[
literal|0
index|]
argument_list|,
literal|"bell"
argument_list|)
condition|)
block|{
ifndef|#
directive|ifndef
name|NO_X
name|XBell
argument_list|(
name|dpy
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|XFlush
argument_list|(
name|dpy
argument_list|)
expr_stmt|;
endif|#
directive|endif
block|}
else|else
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"%s: unknown command\n"
argument_list|,
name|av
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
name|ep
operator|<
name|ibuf
operator|+
name|icnt
condition|)
block|{
name|char
modifier|*
name|f
init|=
name|ep
decl_stmt|;
name|char
modifier|*
name|t
init|=
name|ibuf
decl_stmt|;
name|icnt
operator|-=
name|ep
operator|-
name|ibuf
expr_stmt|;
while|while
condition|(
name|icnt
operator|--
condition|)
operator|*
name|t
operator|++
operator|=
operator|*
name|f
operator|++
expr_stmt|;
block|}
else|else
name|icnt
operator|=
literal|0
expr_stmt|;
name|ibuf
index|[
name|icnt
index|]
operator|=
literal|0
expr_stmt|;
block|}
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_function
name|unsigned
name|char
name|inb_port60
parameter_list|(
name|int
name|port
name|__unused
parameter_list|)
block|{
name|int
name|r
init|=
name|break_code
decl_stmt|;
name|break_code
operator|=
literal|0
expr_stmt|;
name|scan_code
operator|=
literal|0xffff
expr_stmt|;
return|return
operator|(
name|r
operator|)
return|;
block|}
end_function

begin_ifndef
ifndef|#
directive|ifndef
name|NO_X
end_ifndef

begin_function
name|void
name|kbd_event
parameter_list|(
name|int
name|fd
parameter_list|,
name|int
name|cond
parameter_list|,
name|void
modifier|*
name|arg
name|__unused
parameter_list|,
name|regcontext_t
modifier|*
name|REGS
name|__unused
parameter_list|)
block|{
if|if
condition|(
operator|!
operator|(
name|cond
operator|&
name|AS_RD
operator|)
condition|)
return|return;
name|kbd_read
operator|=
literal|0
expr_stmt|;
name|printf
argument_list|(
literal|"kbd_event: fd=%d\n"
argument_list|,
name|fd
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|break_code
operator|=
name|read_raw_kbd
argument_list|(
name|fd
argument_list|,
operator|&
name|scan_code
argument_list|)
operator|)
operator|!=
literal|0xffff
condition|)
name|hardint
argument_list|(
literal|0x01
argument_list|)
expr_stmt|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_function
name|void
name|int09
parameter_list|(
name|REGISTERS
name|__unused
parameter_list|)
block|{
if|if
condition|(
name|raw_kbd
condition|)
block|{
if|if
condition|(
name|scan_code
operator|!=
literal|0xffff
condition|)
block|{
name|KbdWrite
argument_list|(
name|scan_code
argument_list|)
expr_stmt|;
name|break_code
operator|=
literal|0
expr_stmt|;
name|scan_code
operator|=
literal|0xffff
expr_stmt|;
if|#
directive|if
literal|0
block|kbd_event(kbd_fd, 0, sc, REGS);
endif|#
directive|endif
block|}
block|}
name|send_eoi
argument_list|()
expr_stmt|;
block|}
end_function

begin_ifndef
ifndef|#
directive|ifndef
name|NO_X
end_ifndef

begin_function
name|u_short
name|read_raw_kbd
parameter_list|(
name|int
name|fd
parameter_list|,
name|u_short
modifier|*
name|code
parameter_list|)
block|{
name|unsigned
name|char
name|c
decl_stmt|;
operator|*
name|code
operator|=
literal|0xffff
expr_stmt|;
if|if
condition|(
name|read
argument_list|(
name|fd
argument_list|,
operator|&
name|c
argument_list|,
literal|1
argument_list|)
operator|==
literal|1
condition|)
block|{
if|if
condition|(
name|c
operator|==
literal|0xe0
condition|)
block|{
name|K3_STATUS
operator||=
name|K3_TWOBYTE
expr_stmt|;
return|return
operator|(
name|c
operator|)
return|;
block|}
switch|switch
condition|(
name|c
condition|)
block|{
case|case
literal|29
case|:
comment|/* Control */
name|K1_STATUS
operator||=
name|K1_CTRL
expr_stmt|;
if|if
condition|(
name|K3_STATUS
operator|&
name|K3_TWOBYTE
condition|)
name|K3_STATUS
operator||=
name|K3_RCTRL
expr_stmt|;
else|else
name|K2_STATUS
operator||=
name|K2_LCTRL
expr_stmt|;
break|break;
case|case
literal|29
operator||
literal|0x80
case|:
comment|/* Control */
name|K1_STATUS
operator|&=
operator|~
name|K1_CTRL
expr_stmt|;
if|if
condition|(
name|K3_STATUS
operator|&
name|K3_TWOBYTE
condition|)
name|K3_STATUS
operator|&=
operator|~
name|K3_RCTRL
expr_stmt|;
else|else
name|K2_STATUS
operator|&=
operator|~
name|K2_LCTRL
expr_stmt|;
break|break;
case|case
literal|42
case|:
comment|/* left shift */
name|K1_STATUS
operator||=
name|K1_LSHIFT
expr_stmt|;
break|break;
case|case
literal|42
operator||
literal|0x80
case|:
comment|/* left shift */
name|K1_STATUS
operator|&=
operator|~
name|K1_LSHIFT
expr_stmt|;
break|break;
case|case
literal|54
case|:
comment|/* right shift */
name|K1_STATUS
operator||=
name|K1_RSHIFT
expr_stmt|;
break|break;
case|case
literal|54
operator||
literal|0x80
case|:
comment|/* right shift */
name|K1_STATUS
operator|&=
operator|~
name|K1_RSHIFT
expr_stmt|;
break|break;
case|case
literal|56
case|:
comment|/* Alt */
name|K1_STATUS
operator||=
name|K1_ALT
expr_stmt|;
if|if
condition|(
name|K3_STATUS
operator|&
name|K3_TWOBYTE
condition|)
name|K3_STATUS
operator||=
name|K3_RALT
expr_stmt|;
else|else
name|K2_STATUS
operator||=
name|K2_LALT
expr_stmt|;
break|break;
case|case
literal|56
operator||
literal|0x80
case|:
comment|/* Alt */
name|K1_STATUS
operator|&=
operator|~
name|K1_ALT
expr_stmt|;
if|if
condition|(
name|K3_STATUS
operator|&
name|K3_TWOBYTE
condition|)
name|K3_STATUS
operator|&=
operator|~
name|K3_RALT
expr_stmt|;
else|else
name|K2_STATUS
operator|&=
operator|~
name|K2_LALT
expr_stmt|;
break|break;
case|case
literal|58
case|:
comment|/* caps-lock */
name|K1_STATUS
operator|^=
name|K1_CLOCK
expr_stmt|;
if|if
condition|(
name|K1_STATUS
operator|&
name|K1_CLOCK
condition|)
name|K4_STATUS
operator||=
name|K4_CLOCK_LED
expr_stmt|;
else|else
name|K4_STATUS
operator|&=
operator|~
name|K4_CLOCK_LED
expr_stmt|;
name|K2_STATUS
operator||=
name|K2_CLOCK
expr_stmt|;
break|break;
case|case
literal|58
operator||
literal|0x80
case|:
comment|/* caps-lock */
name|K2_STATUS
operator|&=
operator|~
name|K2_CLOCK
expr_stmt|;
break|break;
case|case
literal|69
case|:
comment|/* num-lock */
name|K1_STATUS
operator|^=
name|K1_NLOCK
expr_stmt|;
if|if
condition|(
name|K1_STATUS
operator|&
name|K1_NLOCK
condition|)
name|K4_STATUS
operator||=
name|K4_NLOCK_LED
expr_stmt|;
else|else
name|K4_STATUS
operator|&=
operator|~
name|K4_NLOCK_LED
expr_stmt|;
name|K2_STATUS
operator||=
name|K2_NLOCK
expr_stmt|;
break|break;
case|case
literal|69
operator||
literal|0x80
case|:
comment|/* num-lock */
name|K2_STATUS
operator|&=
operator|~
name|K2_NLOCK
expr_stmt|;
break|break;
case|case
literal|70
case|:
comment|/* scroll-lock */
name|K1_STATUS
operator|^=
name|K1_SLOCK
expr_stmt|;
if|if
condition|(
name|K1_STATUS
operator|&
name|K1_SLOCK
condition|)
name|K4_STATUS
operator||=
name|K4_SLOCK_LED
expr_stmt|;
else|else
name|K4_STATUS
operator|&=
operator|~
name|K4_SLOCK_LED
expr_stmt|;
name|K2_STATUS
operator||=
name|K2_SLOCK
expr_stmt|;
break|break;
case|case
literal|70
operator||
literal|0x80
case|:
comment|/* scroll-lock */
name|K2_STATUS
operator|&=
operator|~
name|K2_SLOCK
expr_stmt|;
break|break;
case|case
literal|82
case|:
comment|/* insert */
name|K1_STATUS
operator|^=
name|K1_INSERT
expr_stmt|;
name|K2_STATUS
operator||=
name|K2_INSERT
expr_stmt|;
break|break;
case|case
literal|82
operator||
literal|0x80
case|:
comment|/* insert */
name|K2_STATUS
operator|&=
operator|~
name|K2_INSERT
expr_stmt|;
break|break;
block|}
if|#
directive|if
literal|0
comment|/*XXXXX*/
block|if ((K4_STATUS& 0x07) != oldled) { 	    oldled = K4_STATUS& 0x07; 	    ioctl (fd, PCCONIOCSETLED,&oldled); 	}
endif|#
directive|endif
if|if
condition|(
name|c
operator|==
literal|83
operator|&&
operator|(
name|K1_STATUS
operator|&
operator|(
name|K1_ALT
operator||
name|K1_CTRL
operator|)
operator|)
operator|==
operator|(
name|K1_ALT
operator||
name|K1_CTRL
operator|)
condition|)
name|quit
argument_list|(
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|c
operator|<
literal|89
condition|)
block|{
name|u_short
name|scode
decl_stmt|;
if|if
condition|(
name|K1_STATUS
operator|&
name|K1_ALT
condition|)
block|{
name|scode
operator|=
name|ScanCodes
index|[
name|c
index|]
operator|.
name|alt
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|K1_STATUS
operator|&
name|K1_CTRL
condition|)
block|{
name|scode
operator|=
name|ScanCodes
index|[
name|c
index|]
operator|.
name|ctrl
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|K1_STATUS
operator|&
name|K1_SHIFT
condition|)
block|{
name|scode
operator|=
name|ScanCodes
index|[
name|c
index|]
operator|.
name|shift
expr_stmt|;
block|}
else|else
block|{
name|scode
operator|=
name|ScanCodes
index|[
name|c
index|]
operator|.
name|base
expr_stmt|;
if|if
condition|(
name|K1_STATUS
operator|&
name|K1_CLOCK
condition|)
block|{
if|if
condition|(
name|islower
argument_list|(
name|scode
operator|&
literal|0xff
argument_list|)
condition|)
block|{
name|scode
operator|=
operator|(
name|scode
operator|&
literal|0xff00
operator|)
operator||
name|toupper
argument_list|(
name|scode
operator|&
literal|0xff
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
operator|(
name|K1_STATUS
operator|&
name|K1_NLOCK
operator|)
operator|&&
operator|(
name|K3_STATUS
operator|&
name|K3_TWOBYTE
operator|)
operator|==
literal|0
condition|)
block|{
switch|switch
condition|(
name|c
condition|)
block|{
case|case
literal|71
case|:
comment|/* home */
case|case
literal|72
case|:
comment|/* cursor up */
case|case
literal|73
case|:
comment|/* page up */
case|case
literal|75
case|:
comment|/* cursor left */
case|case
literal|76
case|:
comment|/* center key */
case|case
literal|77
case|:
comment|/* cursor right */
case|case
literal|79
case|:
comment|/* end */
case|case
literal|80
case|:
comment|/* cursor down */
case|case
literal|81
case|:
comment|/* page down */
case|case
literal|82
case|:
comment|/* insert */
case|case
literal|83
case|:
comment|/* delete */
name|scode
operator|=
name|ScanCodes
index|[
name|c
index|]
operator|.
name|shift
expr_stmt|;
break|break;
block|}
block|}
block|}
operator|*
name|code
operator|=
name|scode
expr_stmt|;
block|}
name|K3_STATUS
operator|&=
operator|~
name|K3_TWOBYTE
expr_stmt|;
if|if
condition|(
operator|(
name|K1_STATUS
operator|&
operator|(
name|K1_ALT
operator||
name|K1_CTRL
operator|)
operator|)
operator|==
operator|(
name|K1_ALT
operator||
name|K1_CTRL
operator|)
condition|)
block|{
switch|switch
condition|(
name|c
condition|)
block|{
case|case
literal|0x13
case|:
comment|/* R */
name|kill
argument_list|(
name|getpid
argument_list|()
argument_list|,
name|SIGALRM
argument_list|)
expr_stmt|;
comment|/* force redraw */
name|printf
argument_list|(
literal|"FORCED REDRAW\n"
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0xffff
operator|)
return|;
case|case
literal|0x14
case|:
comment|/* T */
name|tmode
operator|^=
literal|1
expr_stmt|;
if|if
condition|(
operator|!
name|tmode
condition|)
name|resettrace
argument_list|(
operator|(
name|regcontext_t
operator|*
operator|)
operator|&
name|saved_sigframe
operator|->
name|sf_uc
operator|.
name|uc_mcontext
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0xffff
operator|)
return|;
case|case
literal|0x53
case|:
comment|/* DEL */
name|quit
argument_list|(
literal|0
argument_list|)
expr_stmt|;
block|}
block|}
return|return
operator|(
name|c
operator|)
return|;
block|}
else|else
block|{
return|return
operator|(
literal|0xffff
operator|)
return|;
block|}
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_ifndef
ifndef|#
directive|ifndef
name|NO_X
end_ifndef

begin_function
name|void
name|video_async_event
parameter_list|(
name|int
name|fd
parameter_list|,
name|int
name|cond
parameter_list|,
name|void
modifier|*
name|arg
name|__unused
parameter_list|,
name|regcontext_t
modifier|*
name|REGS
name|__unused
parameter_list|)
block|{
name|int
name|int9
init|=
literal|0
decl_stmt|;
if|if
condition|(
operator|!
operator|(
name|cond
operator|&
name|AS_RD
operator|)
condition|)
return|return;
for|for
control|(
init|;
condition|;
control|)
block|{
name|int
name|x
decl_stmt|;
name|fd_set
name|fdset
decl_stmt|;
name|XEvent
name|ev
decl_stmt|;
specifier|static
name|struct
name|timeval
name|tv
decl_stmt|;
comment|/*                  * Handle any events just sitting around...                  */
name|XFlush
argument_list|(
name|dpy
argument_list|)
expr_stmt|;
while|while
condition|(
name|QLength
argument_list|(
name|dpy
argument_list|)
operator|>
literal|0
condition|)
block|{
name|XNextEvent
argument_list|(
name|dpy
argument_list|,
operator|&
name|ev
argument_list|)
expr_stmt|;
name|int9
operator||=
name|video_event
argument_list|(
operator|&
name|ev
argument_list|)
expr_stmt|;
block|}
name|FD_ZERO
argument_list|(
operator|&
name|fdset
argument_list|)
expr_stmt|;
name|FD_SET
argument_list|(
name|fd
argument_list|,
operator|&
name|fdset
argument_list|)
expr_stmt|;
name|x
operator|=
name|select
argument_list|(
name|FD_SETSIZE
argument_list|,
operator|&
name|fdset
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
operator|&
name|tv
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|x
condition|)
block|{
case|case
operator|-
literal|1
case|:
comment|/*                          * Errno might be wrong, so we just select again.                          * This could cause a problem is something really                          * was wrong with select....                          */
name|perror
argument_list|(
literal|"select"
argument_list|)
expr_stmt|;
return|return;
case|case
literal|0
case|:
name|XFlush
argument_list|(
name|dpy
argument_list|)
expr_stmt|;
if|if
condition|(
name|int9
condition|)
name|hardint
argument_list|(
literal|0x01
argument_list|)
expr_stmt|;
return|return;
default|default:
if|if
condition|(
name|FD_ISSET
argument_list|(
name|fd
argument_list|,
operator|&
name|fdset
argument_list|)
condition|)
block|{
do|do
block|{
name|XNextEvent
argument_list|(
name|dpy
argument_list|,
operator|&
name|ev
argument_list|)
expr_stmt|;
name|int9
operator||=
name|video_event
argument_list|(
operator|&
name|ev
argument_list|)
expr_stmt|;
block|}
do|while
condition|(
name|QLength
argument_list|(
name|dpy
argument_list|)
condition|)
do|;
block|}
break|break;
block|}
block|}
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_ifndef
ifndef|#
directive|ifndef
name|NO_X
end_ifndef

begin_function
specifier|static
name|int
name|video_event
parameter_list|(
name|XEvent
modifier|*
name|ev
parameter_list|)
block|{
switch|switch
condition|(
name|ev
operator|->
name|type
condition|)
block|{
case|case
name|MotionNotify
case|:
block|{
name|XMotionEvent
modifier|*
name|me
init|=
operator|(
name|XMotionEvent
operator|*
operator|)
name|ev
decl_stmt|;
name|me
operator|->
name|x
operator|-=
literal|2
expr_stmt|;
name|me
operator|->
name|y
operator|-=
literal|2
expr_stmt|;
name|mouse_status
operator|.
name|x
operator|=
operator|(
name|me
operator|->
name|x
operator|<
name|mouse_status
operator|.
name|range
operator|.
name|x
operator|)
condition|?
name|mouse_status
operator|.
name|range
operator|.
name|x
else|:
operator|(
name|me
operator|->
name|x
operator|>
name|mouse_status
operator|.
name|range
operator|.
name|w
operator|)
condition|?
name|mouse_status
operator|.
name|range
operator|.
name|w
else|:
name|me
operator|->
name|x
expr_stmt|;
name|mouse_status
operator|.
name|y
operator|=
operator|(
name|me
operator|->
name|y
operator|<
name|mouse_status
operator|.
name|range
operator|.
name|y
operator|)
condition|?
name|mouse_status
operator|.
name|range
operator|.
name|y
else|:
operator|(
name|me
operator|->
name|y
operator|>
name|mouse_status
operator|.
name|range
operator|.
name|h
operator|)
condition|?
name|mouse_status
operator|.
name|range
operator|.
name|h
else|:
name|me
operator|->
name|y
expr_stmt|;
break|break;
block|}
case|case
name|ButtonRelease
case|:
block|{
name|XButtonEvent
modifier|*
name|be
init|=
operator|(
name|XButtonEvent
operator|*
operator|)
name|ev
decl_stmt|;
name|be
operator|->
name|x
operator|-=
literal|2
expr_stmt|;
name|be
operator|->
name|y
operator|-=
literal|2
expr_stmt|;
if|if
condition|(
name|be
operator|->
name|button
operator|<
literal|3
condition|)
name|mouse_status
operator|.
name|ups
index|[
name|be
operator|->
name|button
index|]
operator|++
expr_stmt|;
name|mouse_status
operator|.
name|x
operator|=
operator|(
name|be
operator|->
name|x
operator|<
name|mouse_status
operator|.
name|range
operator|.
name|x
operator|)
condition|?
name|mouse_status
operator|.
name|range
operator|.
name|x
else|:
operator|(
name|be
operator|->
name|x
operator|>
name|mouse_status
operator|.
name|range
operator|.
name|w
operator|)
condition|?
name|mouse_status
operator|.
name|range
operator|.
name|w
else|:
name|be
operator|->
name|x
expr_stmt|;
name|mouse_status
operator|.
name|y
operator|=
operator|(
name|be
operator|->
name|y
operator|<
name|mouse_status
operator|.
name|range
operator|.
name|y
operator|)
condition|?
name|mouse_status
operator|.
name|range
operator|.
name|y
else|:
operator|(
name|be
operator|->
name|y
operator|>
name|mouse_status
operator|.
name|range
operator|.
name|h
operator|)
condition|?
name|mouse_status
operator|.
name|range
operator|.
name|h
else|:
name|be
operator|->
name|y
expr_stmt|;
break|break;
block|}
case|case
name|ButtonPress
case|:
block|{
name|XButtonEvent
modifier|*
name|be
init|=
operator|(
name|XButtonEvent
operator|*
operator|)
name|ev
decl_stmt|;
name|be
operator|->
name|x
operator|-=
literal|2
expr_stmt|;
name|be
operator|->
name|y
operator|-=
literal|2
expr_stmt|;
if|if
condition|(
name|be
operator|->
name|button
operator|<
literal|3
condition|)
name|mouse_status
operator|.
name|downs
index|[
name|be
operator|->
name|button
index|]
operator|++
expr_stmt|;
name|mouse_status
operator|.
name|x
operator|=
operator|(
name|be
operator|->
name|x
operator|<
name|mouse_status
operator|.
name|range
operator|.
name|x
operator|)
condition|?
name|mouse_status
operator|.
name|range
operator|.
name|x
else|:
operator|(
name|be
operator|->
name|x
operator|>
name|mouse_status
operator|.
name|range
operator|.
name|w
operator|)
condition|?
name|mouse_status
operator|.
name|range
operator|.
name|w
else|:
name|be
operator|->
name|x
expr_stmt|;
name|mouse_status
operator|.
name|y
operator|=
operator|(
name|be
operator|->
name|y
operator|<
name|mouse_status
operator|.
name|range
operator|.
name|y
operator|)
condition|?
name|mouse_status
operator|.
name|range
operator|.
name|y
else|:
operator|(
name|be
operator|->
name|y
operator|>
name|mouse_status
operator|.
name|range
operator|.
name|h
operator|)
condition|?
name|mouse_status
operator|.
name|range
operator|.
name|h
else|:
name|be
operator|->
name|y
expr_stmt|;
if|if
condition|(
operator|(
name|K1_STATUS
operator|&
operator|(
name|K1_ALT
operator||
name|K1_CTRL
operator|)
operator|)
operator|==
operator|(
name|K1_ALT
operator||
name|K1_CTRL
operator|)
condition|)
block|{
name|quit
argument_list|(
literal|0
argument_list|)
expr_stmt|;
block|}
break|break;
block|}
case|case
name|NoExpose
case|:
break|break;
case|case
name|GraphicsExpose
case|:
case|case
name|Expose
case|:
block|{
name|int
name|r
decl_stmt|;
for|for
control|(
name|r
operator|=
literal|0
init|;
name|r
operator|<
name|height
condition|;
operator|++
name|r
control|)
name|lines
index|[
name|r
index|]
operator|.
name|changed
operator|=
literal|1
expr_stmt|;
break|break;
block|}
case|case
name|KeyRelease
case|:
block|{
specifier|static
name|char
name|buf
index|[
literal|128
index|]
decl_stmt|;
name|KeySym
name|ks
decl_stmt|;
name|break_code
operator||=
literal|0x80
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|ev
operator|->
name|xkey
operator|.
name|state
operator|&
name|ShiftMask
operator|)
condition|)
block|{
name|K1_STATUS
operator|&=
operator|~
name|K1_LSHIFT
expr_stmt|;
name|K1_STATUS
operator|&=
operator|~
name|K1_RSHIFT
expr_stmt|;
block|}
if|if
condition|(
operator|!
operator|(
name|ev
operator|->
name|xkey
operator|.
name|state
operator|&
name|ControlMask
operator|)
condition|)
block|{
name|K1_STATUS
operator|&=
operator|~
name|K1_CTRL
expr_stmt|;
name|K2_STATUS
operator|&=
operator|~
name|K2_LCTRL
expr_stmt|;
name|K3_STATUS
operator|&=
operator|~
name|K3_RCTRL
expr_stmt|;
block|}
if|if
condition|(
operator|!
operator|(
name|ev
operator|->
name|xkey
operator|.
name|state
operator|&
name|Mod1Mask
operator|)
condition|)
block|{
name|K1_STATUS
operator|&=
operator|~
name|K1_ALT
expr_stmt|;
name|K2_STATUS
operator|&=
operator|~
name|K2_LALT
expr_stmt|;
name|K3_STATUS
operator|&=
operator|~
name|K3_RALT
expr_stmt|;
block|}
if|if
condition|(
operator|!
operator|(
name|ev
operator|->
name|xkey
operator|.
name|state
operator|&
name|LockMask
operator|)
condition|)
block|{
name|K2_STATUS
operator|&=
operator|~
name|K2_CLOCK
expr_stmt|;
block|}
name|XLookupString
argument_list|(
operator|(
name|XKeyEvent
operator|*
operator|)
name|ev
argument_list|,
name|buf
argument_list|,
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
argument_list|,
operator|&
name|ks
argument_list|,
literal|0
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|ks
condition|)
block|{
case|case
name|XK_Shift_L
case|:
name|K1_STATUS
operator|&=
operator|~
name|K1_LSHIFT
expr_stmt|;
break|break;
case|case
name|XK_Shift_R
case|:
name|K1_STATUS
operator|&=
operator|~
name|K1_RSHIFT
expr_stmt|;
break|break;
case|case
name|XK_Control_L
case|:
name|K1_STATUS
operator|&=
operator|~
name|K1_CTRL
expr_stmt|;
name|K2_STATUS
operator|&=
operator|~
name|K2_LCTRL
expr_stmt|;
break|break;
case|case
name|XK_Control_R
case|:
name|K1_STATUS
operator|&=
operator|~
name|K1_CTRL
expr_stmt|;
name|K3_STATUS
operator|&=
operator|~
name|K3_RCTRL
expr_stmt|;
break|break;
case|case
name|XK_Alt_L
case|:
name|K1_STATUS
operator|&=
operator|~
name|K1_ALT
expr_stmt|;
name|K2_STATUS
operator|&=
operator|~
name|K2_LALT
expr_stmt|;
break|break;
case|case
name|XK_Alt_R
case|:
name|K1_STATUS
operator|&=
operator|~
name|K1_ALT
expr_stmt|;
name|K3_STATUS
operator|&=
operator|~
name|K3_RALT
expr_stmt|;
break|break;
case|case
name|XK_Scroll_Lock
case|:
name|K2_STATUS
operator|&=
operator|~
name|K2_SLOCK
expr_stmt|;
break|break;
case|case
name|XK_Num_Lock
case|:
name|K2_STATUS
operator|&=
operator|~
name|K2_NLOCK
expr_stmt|;
break|break;
case|case
name|XK_Caps_Lock
case|:
name|K2_STATUS
operator|&=
operator|~
name|K2_CLOCK
expr_stmt|;
break|break;
case|case
name|XK_Insert
case|:
name|K2_STATUS
operator|&=
operator|~
name|K2_INSERT
expr_stmt|;
break|break;
block|}
return|return
operator|(
literal|1
operator|)
return|;
block|}
case|case
name|KeyPress
case|:
block|{
specifier|static
name|char
name|buf
index|[
literal|128
index|]
decl_stmt|;
name|KeySym
name|ks
decl_stmt|;
name|int
name|n
decl_stmt|;
name|int
name|nlock
init|=
literal|0
decl_stmt|;
name|u_short
name|scan
init|=
literal|0xffff
decl_stmt|;
if|if
condition|(
operator|!
operator|(
name|ev
operator|->
name|xkey
operator|.
name|state
operator|&
name|ShiftMask
operator|)
condition|)
block|{
name|K1_STATUS
operator|&=
operator|~
name|K1_LSHIFT
expr_stmt|;
name|K1_STATUS
operator|&=
operator|~
name|K1_RSHIFT
expr_stmt|;
block|}
if|if
condition|(
operator|!
operator|(
name|ev
operator|->
name|xkey
operator|.
name|state
operator|&
name|ControlMask
operator|)
condition|)
block|{
name|K1_STATUS
operator|&=
operator|~
name|K1_CTRL
expr_stmt|;
name|K2_STATUS
operator|&=
operator|~
name|K2_LCTRL
expr_stmt|;
name|K3_STATUS
operator|&=
operator|~
name|K3_RCTRL
expr_stmt|;
block|}
if|if
condition|(
operator|!
operator|(
name|ev
operator|->
name|xkey
operator|.
name|state
operator|&
name|Mod1Mask
operator|)
condition|)
block|{
name|K1_STATUS
operator|&=
operator|~
name|K1_ALT
expr_stmt|;
name|K2_STATUS
operator|&=
operator|~
name|K2_LALT
expr_stmt|;
name|K3_STATUS
operator|&=
operator|~
name|K3_RALT
expr_stmt|;
block|}
if|if
condition|(
operator|!
operator|(
name|ev
operator|->
name|xkey
operator|.
name|state
operator|&
name|LockMask
operator|)
condition|)
block|{
name|K2_STATUS
operator|&=
operator|~
name|K2_CLOCK
expr_stmt|;
block|}
name|n
operator|=
name|XLookupString
argument_list|(
operator|(
name|XKeyEvent
operator|*
operator|)
name|ev
argument_list|,
name|buf
argument_list|,
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
argument_list|,
operator|&
name|ks
argument_list|,
literal|0
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|ks
condition|)
block|{
case|case
name|XK_Shift_L
case|:
name|K1_STATUS
operator||=
name|K1_LSHIFT
expr_stmt|;
break|break;
case|case
name|XK_Shift_R
case|:
name|K1_STATUS
operator||=
name|K1_RSHIFT
expr_stmt|;
break|break;
case|case
name|XK_Control_L
case|:
name|K1_STATUS
operator||=
name|K1_CTRL
expr_stmt|;
name|K2_STATUS
operator||=
name|K2_LCTRL
expr_stmt|;
break|break;
case|case
name|XK_Control_R
case|:
name|K1_STATUS
operator||=
name|K1_CTRL
expr_stmt|;
name|K3_STATUS
operator||=
name|K3_RCTRL
expr_stmt|;
break|break;
case|case
name|XK_Alt_L
case|:
name|K1_STATUS
operator||=
name|K1_ALT
expr_stmt|;
name|K2_STATUS
operator||=
name|K2_LALT
expr_stmt|;
break|break;
case|case
name|XK_Alt_R
case|:
name|K1_STATUS
operator||=
name|K1_ALT
expr_stmt|;
name|K3_STATUS
operator||=
name|K3_RALT
expr_stmt|;
break|break;
case|case
name|XK_Scroll_Lock
case|:
name|K1_STATUS
operator|^=
name|K1_SLOCK
expr_stmt|;
name|K2_STATUS
operator||=
name|K2_SLOCK
expr_stmt|;
break|break;
case|case
name|XK_Num_Lock
case|:
name|K1_STATUS
operator|^=
name|K1_NLOCK
expr_stmt|;
name|K2_STATUS
operator||=
name|K2_NLOCK
expr_stmt|;
break|break;
case|case
name|XK_Caps_Lock
case|:
name|K1_STATUS
operator|^=
name|K1_CLOCK
expr_stmt|;
name|K2_STATUS
operator||=
name|K2_CLOCK
expr_stmt|;
break|break;
case|case
name|XK_Insert
case|:
case|case
name|XK_KP_Insert
case|:
name|K1_STATUS
operator|^=
name|K1_INSERT
expr_stmt|;
name|K2_STATUS
operator||=
name|K2_INSERT
expr_stmt|;
name|scan
operator|=
literal|82
expr_stmt|;
goto|goto
name|docode
goto|;
case|case
name|XK_Escape
case|:
name|scan
operator|=
literal|1
expr_stmt|;
goto|goto
name|docode
goto|;
case|case
name|XK_Tab
case|:
case|case
name|XK_ISO_Left_Tab
case|:
name|scan
operator|=
literal|15
expr_stmt|;
goto|goto
name|docode
goto|;
case|case
name|XK_Return
case|:
case|case
name|XK_KP_Enter
case|:
name|scan
operator|=
literal|28
expr_stmt|;
goto|goto
name|docode
goto|;
case|case
name|XK_Print
case|:
name|scan
operator|=
literal|55
expr_stmt|;
goto|goto
name|docode
goto|;
case|case
name|XK_F1
case|:
case|case
name|XK_F2
case|:
case|case
name|XK_F3
case|:
case|case
name|XK_F4
case|:
case|case
name|XK_F5
case|:
case|case
name|XK_F6
case|:
case|case
name|XK_F7
case|:
case|case
name|XK_F8
case|:
case|case
name|XK_F9
case|:
case|case
name|XK_F10
case|:
name|scan
operator|=
name|ks
operator|-
name|XK_F1
operator|+
literal|59
expr_stmt|;
goto|goto
name|docode
goto|;
case|case
name|XK_KP_7
case|:
name|nlock
operator|=
literal|1
expr_stmt|;
case|case
name|XK_Home
case|:
case|case
name|XK_KP_Home
case|:
name|scan
operator|=
literal|71
expr_stmt|;
goto|goto
name|docode
goto|;
case|case
name|XK_KP_8
case|:
name|nlock
operator|=
literal|1
expr_stmt|;
case|case
name|XK_Up
case|:
case|case
name|XK_KP_Up
case|:
name|scan
operator|=
literal|72
expr_stmt|;
goto|goto
name|docode
goto|;
case|case
name|XK_KP_9
case|:
name|nlock
operator|=
literal|1
expr_stmt|;
case|case
name|XK_Prior
case|:
case|case
name|XK_KP_Prior
case|:
name|scan
operator|=
literal|73
expr_stmt|;
goto|goto
name|docode
goto|;
case|case
name|XK_KP_Subtract
case|:
name|scan
operator|=
literal|74
expr_stmt|;
goto|goto
name|docode
goto|;
case|case
name|XK_KP_4
case|:
name|nlock
operator|=
literal|1
expr_stmt|;
case|case
name|XK_Left
case|:
case|case
name|XK_KP_Left
case|:
name|scan
operator|=
literal|75
expr_stmt|;
goto|goto
name|docode
goto|;
case|case
name|XK_KP_5
case|:
name|nlock
operator|=
literal|1
expr_stmt|;
case|case
name|XK_Begin
case|:
case|case
name|XK_KP_Begin
case|:
name|scan
operator|=
literal|76
expr_stmt|;
goto|goto
name|docode
goto|;
case|case
name|XK_KP_6
case|:
name|nlock
operator|=
literal|1
expr_stmt|;
case|case
name|XK_Right
case|:
case|case
name|XK_KP_Right
case|:
name|scan
operator|=
literal|77
expr_stmt|;
goto|goto
name|docode
goto|;
case|case
name|XK_KP_Add
case|:
name|scan
operator|=
literal|78
expr_stmt|;
goto|goto
name|docode
goto|;
case|case
name|XK_KP_1
case|:
name|nlock
operator|=
literal|1
expr_stmt|;
case|case
name|XK_End
case|:
case|case
name|XK_KP_End
case|:
name|scan
operator|=
literal|79
expr_stmt|;
goto|goto
name|docode
goto|;
case|case
name|XK_KP_2
case|:
name|nlock
operator|=
literal|1
expr_stmt|;
case|case
name|XK_Down
case|:
case|case
name|XK_KP_Down
case|:
name|scan
operator|=
literal|80
expr_stmt|;
goto|goto
name|docode
goto|;
case|case
name|XK_KP_3
case|:
name|nlock
operator|=
literal|1
expr_stmt|;
case|case
name|XK_Next
case|:
case|case
name|XK_KP_Next
case|:
name|scan
operator|=
literal|81
expr_stmt|;
goto|goto
name|docode
goto|;
case|case
name|XK_KP_0
case|:
name|nlock
operator|=
literal|1
expr_stmt|;
comment|/* case XK_Insert: This is above */
name|scan
operator|=
literal|82
expr_stmt|;
goto|goto
name|docode
goto|;
case|case
name|XK_KP_Decimal
case|:
name|nlock
operator|=
literal|1
expr_stmt|;
name|scan
operator|=
literal|83
expr_stmt|;
goto|goto
name|docode
goto|;
case|case
name|XK_Delete
case|:
case|case
name|XK_KP_Delete
case|:
name|scan
operator|=
name|flipdelete
condition|?
literal|14
else|:
literal|83
expr_stmt|;
goto|goto
name|docode
goto|;
case|case
name|XK_BackSpace
case|:
name|scan
operator|=
name|flipdelete
condition|?
literal|83
else|:
literal|14
expr_stmt|;
goto|goto
name|docode
goto|;
case|case
name|XK_F11
case|:
name|scan
operator|=
literal|87
expr_stmt|;
goto|goto
name|docode
goto|;
case|case
name|XK_F12
case|:
name|scan
operator|=
literal|88
expr_stmt|;
goto|goto
name|docode
goto|;
case|case
name|XK_KP_Divide
case|:
name|scan
operator|=
name|Ascii2Scan
index|[
literal|'/'
index|]
expr_stmt|;
goto|goto
name|docode
goto|;
case|case
name|XK_KP_Multiply
case|:
name|scan
operator|=
name|Ascii2Scan
index|[
literal|'*'
index|]
expr_stmt|;
goto|goto
name|docode
goto|;
default|default:
if|if
condition|(
operator|(
name|K1_STATUS
operator|&
operator|(
name|K1_ALT
operator||
name|K1_CTRL
operator|)
operator|)
operator|==
operator|(
name|K1_ALT
operator||
name|K1_CTRL
operator|)
condition|)
block|{
if|if
condition|(
name|ks
operator|==
literal|'T'
operator|||
name|ks
operator|==
literal|'t'
condition|)
block|{
name|tmode
operator|^=
literal|1
expr_stmt|;
if|if
condition|(
operator|!
name|tmode
condition|)
name|resettrace
argument_list|(
operator|(
name|regcontext_t
operator|*
operator|)
operator|&
name|saved_sigframe
operator|->
name|sf_uc
operator|.
name|uc_mcontext
argument_list|)
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|ks
operator|==
literal|'R'
operator|||
name|ks
operator|==
literal|'r'
condition|)
block|{
name|kill
argument_list|(
name|getpid
argument_list|()
argument_list|,
name|SIGALRM
argument_list|)
expr_stmt|;
comment|/* redraw */
break|break;
block|}
block|}
if|if
condition|(
name|ks
operator|<
literal|' '
operator|||
name|ks
operator|>
literal|'~'
condition|)
break|break;
name|scan
operator|=
name|Ascii2Scan
index|[
name|ks
index|]
expr_stmt|;
name|docode
label|:
if|if
condition|(
name|nlock
condition|)
name|scan
operator||=
literal|0x100
expr_stmt|;
if|if
condition|(
operator|(
name|scan
operator|&
operator|~
literal|0x100
operator|)
operator|>
literal|88
condition|)
block|{
name|scan
operator|=
literal|0xffff
expr_stmt|;
break|break;
block|}
if|if
condition|(
operator|(
name|K1_STATUS
operator|&
name|K1_SHIFT
operator|)
operator|||
operator|(
name|scan
operator|&
literal|0x100
operator|)
condition|)
block|{
name|scan
operator|=
name|ScanCodes
index|[
name|scan
operator|&
literal|0xff
index|]
operator|.
name|shift
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|K1_STATUS
operator|&
name|K1_CTRL
condition|)
block|{
name|scan
operator|=
name|ScanCodes
index|[
name|scan
operator|&
literal|0xff
index|]
operator|.
name|ctrl
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|K1_STATUS
operator|&
name|K1_ALT
condition|)
block|{
name|scan
operator|=
name|ScanCodes
index|[
name|scan
operator|&
literal|0xff
index|]
operator|.
name|alt
expr_stmt|;
block|}
else|else
name|scan
operator|=
name|ScanCodes
index|[
name|scan
operator|&
literal|0xff
index|]
operator|.
name|base
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|scan
operator|!=
literal|0xffff
condition|)
block|{
name|break_code
operator|=
name|scan
operator|>>
literal|8
expr_stmt|;
name|KbdWrite
argument_list|(
name|scan
argument_list|)
expr_stmt|;
block|}
return|return
operator|(
literal|1
operator|)
return|;
block|}
default|default:
break|break;
block|}
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_function
name|void
name|tty_move
parameter_list|(
name|int
name|r
parameter_list|,
name|int
name|c
parameter_list|)
block|{
name|row
operator|=
name|r
expr_stmt|;
name|col
operator|=
name|c
expr_stmt|;
name|SetVREGCur
argument_list|()
expr_stmt|;
block|}
end_function

begin_function
name|void
name|tty_report
parameter_list|(
name|int
modifier|*
name|r
parameter_list|,
name|int
modifier|*
name|c
parameter_list|)
block|{
operator|*
name|r
operator|=
name|row
expr_stmt|;
operator|*
name|c
operator|=
name|col
expr_stmt|;
block|}
end_function

begin_function
name|void
name|tty_flush
parameter_list|()
block|{
name|K_NEXT
operator|=
name|K_FREE
operator|=
name|K_BUFSTARTP
expr_stmt|;
block|}
end_function

begin_function
name|void
name|tty_index
parameter_list|(
name|int
name|scroll
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
if|if
condition|(
name|row
operator|>
operator|(
name|height
operator|-
literal|1
operator|)
condition|)
name|row
operator|=
literal|0
expr_stmt|;
elseif|else
if|if
condition|(
operator|++
name|row
operator|>=
name|height
condition|)
block|{
name|row
operator|=
name|height
operator|-
literal|1
expr_stmt|;
if|if
condition|(
name|scroll
condition|)
block|{
name|memcpy
argument_list|(
name|vmem
argument_list|,
operator|&
name|vmem
index|[
name|width
index|]
argument_list|,
literal|2
operator|*
name|width
operator|*
operator|(
name|height
operator|-
literal|1
operator|)
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|width
condition|;
operator|++
name|i
control|)
name|vmem
index|[
operator|(
name|height
operator|-
literal|1
operator|)
operator|*
name|width
operator|+
name|i
index|]
operator|=
name|vattr
operator||
literal|' '
expr_stmt|;
block|}
block|}
name|SetVREGCur
argument_list|()
expr_stmt|;
block|}
end_function

begin_function
name|void
name|tty_write
parameter_list|(
name|int
name|c
parameter_list|,
name|int
name|attr
parameter_list|)
block|{
if|if
condition|(
name|attr
operator|==
name|TTYF_REDIRECT
condition|)
block|{
if|if
condition|(
name|redirect1
condition|)
block|{
name|write
argument_list|(
literal|1
argument_list|,
operator|&
name|c
argument_list|,
literal|1
argument_list|)
expr_stmt|;
return|return;
block|}
name|attr
operator|=
operator|-
literal|1
expr_stmt|;
block|}
if|if
condition|(
name|capture_fd
operator|>=
literal|0
condition|)
block|{
name|char
name|cc
init|=
name|c
decl_stmt|;
name|write
argument_list|(
name|capture_fd
argument_list|,
operator|&
name|cc
argument_list|,
literal|1
argument_list|)
expr_stmt|;
block|}
name|c
operator|&=
literal|0xff
expr_stmt|;
switch|switch
condition|(
name|c
condition|)
block|{
case|case
literal|0x07
case|:
if|if
condition|(
name|xmode
condition|)
block|{
ifndef|#
directive|ifndef
name|NO_X
name|XBell
argument_list|(
name|dpy
argument_list|,
literal|0
argument_list|)
expr_stmt|;
endif|#
directive|endif
block|}
else|else
name|write
argument_list|(
literal|1
argument_list|,
literal|"\007"
argument_list|,
literal|1
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x08
case|:
if|if
condition|(
name|row
operator|>
operator|(
name|height
operator|-
literal|1
operator|)
operator|||
name|col
operator|>
name|width
condition|)
break|break;
if|if
condition|(
name|col
operator|>
literal|0
condition|)
operator|--
name|col
expr_stmt|;
name|vmem
index|[
name|row
operator|*
name|width
operator|+
name|col
index|]
operator|&=
literal|0xff00
expr_stmt|;
break|break;
case|case
literal|'\t'
case|:
if|if
condition|(
name|row
operator|>
operator|(
name|height
operator|-
literal|1
operator|)
condition|)
name|row
operator|=
literal|0
expr_stmt|;
name|col
operator|=
operator|(
name|col
operator|+
literal|8
operator|)
operator|&
operator|~
literal|0x07
expr_stmt|;
if|if
condition|(
name|col
operator|>
name|width
condition|)
block|{
name|col
operator|=
literal|0
expr_stmt|;
name|tty_index
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
literal|'\r'
case|:
name|col
operator|=
literal|0
expr_stmt|;
break|break;
case|case
literal|'\n'
case|:
name|tty_index
argument_list|(
literal|1
argument_list|)
expr_stmt|;
break|break;
default|default:
if|if
condition|(
name|col
operator|>=
name|width
condition|)
block|{
name|col
operator|=
literal|0
expr_stmt|;
name|tty_index
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|row
operator|>
operator|(
name|height
operator|-
literal|1
operator|)
condition|)
name|row
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|attr
operator|>=
literal|0
condition|)
name|vmem
index|[
name|row
operator|*
name|width
operator|+
name|col
index|]
operator|=
name|attr
operator|&
literal|0xff00
expr_stmt|;
else|else
name|vmem
index|[
name|row
operator|*
name|width
operator|+
name|col
index|]
operator|&=
literal|0xff00
expr_stmt|;
name|vmem
index|[
name|row
operator|*
name|width
operator|+
name|col
operator|++
index|]
operator||=
name|c
expr_stmt|;
break|break;
block|}
name|SetVREGCur
argument_list|()
expr_stmt|;
block|}
end_function

begin_function
name|void
name|tty_rwrite
parameter_list|(
name|int
name|n
parameter_list|,
name|int
name|c
parameter_list|,
name|int
name|attr
parameter_list|)
block|{
name|u_char
name|srow
decl_stmt|,
name|scol
decl_stmt|;
name|c
operator|&=
literal|0xff
expr_stmt|;
ifndef|#
directive|ifndef
name|NO_X
if|if
condition|(
name|VGA_ATC
index|[
name|ATC_ModeCtrl
index|]
operator|&
literal|1
condition|)
block|{
name|tty_rwrite_graphics
argument_list|(
name|n
argument_list|,
name|c
argument_list|,
name|attr
argument_list|)
expr_stmt|;
return|return;
block|}
endif|#
directive|endif
name|srow
operator|=
name|row
expr_stmt|;
name|scol
operator|=
name|col
expr_stmt|;
while|while
condition|(
name|n
operator|--
condition|)
block|{
if|if
condition|(
name|col
operator|>=
name|width
condition|)
block|{
name|col
operator|=
literal|0
expr_stmt|;
name|tty_index
argument_list|(
literal|0
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|row
operator|>
operator|(
name|height
operator|-
literal|1
operator|)
condition|)
name|row
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|attr
operator|>=
literal|0
condition|)
name|vmem
index|[
name|row
operator|*
name|width
operator|+
name|col
index|]
operator|=
name|attr
operator|&
literal|0xff00
expr_stmt|;
else|else
name|vmem
index|[
name|row
operator|*
name|width
operator|+
name|col
index|]
operator|&=
literal|0xff00
expr_stmt|;
name|vmem
index|[
name|row
operator|*
name|width
operator|+
name|col
operator|++
index|]
operator||=
name|c
expr_stmt|;
block|}
name|row
operator|=
name|srow
expr_stmt|;
name|col
operator|=
name|scol
expr_stmt|;
name|SetVREGCur
argument_list|()
expr_stmt|;
block|}
end_function

begin_ifndef
ifndef|#
directive|ifndef
name|NO_X
end_ifndef

begin_comment
comment|/* Write a character in graphics mode. Note that the text is put at *text*    coordinates. */
end_comment

begin_function
specifier|static
name|void
name|tty_rwrite_graphics
parameter_list|(
name|int
name|n
parameter_list|,
name|int
name|c
parameter_list|,
name|int
name|attr
parameter_list|)
block|{
name|u_int8_t
name|srow
decl_stmt|,
name|scol
decl_stmt|;
name|int
name|ht
init|=
name|height
operator|/
name|CharHeight
decl_stmt|;
name|int
name|wd
init|=
name|width
operator|/
literal|8
decl_stmt|;
name|srow
operator|=
name|row
expr_stmt|;
name|scol
operator|=
name|col
expr_stmt|;
while|while
condition|(
name|n
operator|--
condition|)
block|{
if|if
condition|(
name|col
operator|>=
name|wd
condition|)
block|{
name|col
operator|=
literal|0
expr_stmt|;
comment|/* tty_index(0); */
comment|/* scroll up if last line is filled */
block|}
if|if
condition|(
name|row
operator|>
operator|(
name|ht
operator|-
literal|1
operator|)
condition|)
name|row
operator|=
literal|0
expr_stmt|;
name|putchar_graphics
argument_list|(
name|row
operator|*
name|wd
operator|*
name|CharHeight
operator|+
name|col
argument_list|,
name|c
argument_list|,
name|attr
argument_list|)
expr_stmt|;
name|col
operator|++
expr_stmt|;
block|}
name|row
operator|=
name|srow
expr_stmt|;
name|col
operator|=
name|scol
expr_stmt|;
name|SetVREGCur
argument_list|()
expr_stmt|;
return|return;
block|}
end_function

begin_comment
comment|/* Put the character together from its pixel representation in 'font8xXX[]'    and write it to 'vram'. The attribute byte gives the desired color; if bit    7 is set, the pixels are XOR'd with the underlying color(s).     XXX This must be updated for the 256 color modes. */
end_comment

begin_function
specifier|static
name|void
name|putchar_graphics
parameter_list|(
name|int
name|xy
parameter_list|,
name|int
name|c
parameter_list|,
name|int
name|attr
parameter_list|)
block|{
name|int
name|i
decl_stmt|,
name|j
decl_stmt|;
name|u_int8_t
name|cline
decl_stmt|;
name|u_int8_t
modifier|*
name|cpos
decl_stmt|;
comment|/* get char position in the pixel representation */
name|cpos
operator|=
operator|(
name|u_int8_t
operator|*
operator|)
operator|(
literal|0xC3000
operator|+
name|c
operator|*
name|CharHeight
operator|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|CharHeight
condition|;
name|i
operator|++
control|)
block|{
name|cline
operator|=
name|cpos
index|[
name|i
index|]
expr_stmt|;
for|for
control|(
name|j
operator|=
literal|0
init|;
name|j
operator|<
literal|4
condition|;
name|j
operator|++
control|)
block|{
if|if
condition|(
name|attr
operator|&
literal|0x8000
condition|)
block|{
comment|/* XOR */
if|if
condition|(
name|attr
operator|&
operator|(
literal|0x0100
operator|<<
name|j
operator|)
condition|)
name|vram
index|[
name|xy
operator|+
name|i
operator|*
name|width
operator|/
literal|8
operator|+
name|j
operator|*
literal|0x10000
index|]
operator|^=
name|cline
expr_stmt|;
block|}
else|else
block|{
comment|/* replace */
if|if
condition|(
name|attr
operator|&
operator|(
literal|0x0100
operator|<<
name|j
operator|)
condition|)
name|vram
index|[
name|xy
operator|+
name|i
operator|*
name|width
operator|/
literal|8
operator|+
name|j
operator|*
literal|0x10000
index|]
operator|&=
operator|~
name|cline
expr_stmt|;
else|else
name|vram
index|[
name|xy
operator|+
name|i
operator|*
name|width
operator|/
literal|8
operator|+
name|j
operator|*
literal|0x10000
index|]
operator||=
name|cline
expr_stmt|;
block|}
block|}
block|}
return|return;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_function
name|void
name|tty_pause
parameter_list|()
block|{
name|sigset_t
name|set
decl_stmt|;
name|sigprocmask
argument_list|(
literal|0
argument_list|,
literal|0
argument_list|,
operator|&
name|set
argument_list|)
expr_stmt|;
name|sigdelset
argument_list|(
operator|&
name|set
argument_list|,
name|SIGIO
argument_list|)
expr_stmt|;
name|sigdelset
argument_list|(
operator|&
name|set
argument_list|,
name|SIGALRM
argument_list|)
expr_stmt|;
name|sigsuspend
argument_list|(
operator|&
name|set
argument_list|)
expr_stmt|;
block|}
end_function

begin_decl_stmt
specifier|static
name|int
name|nextchar
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_function
name|int
name|tty_read
parameter_list|(
name|REGISTERS
parameter_list|,
name|int
name|flag
parameter_list|)
block|{
name|int
name|r
decl_stmt|;
if|if
condition|(
operator|(
name|r
operator|=
name|nextchar
operator|)
operator|!=
literal|0
condition|)
block|{
name|nextchar
operator|=
literal|0
expr_stmt|;
return|return
operator|(
name|r
operator|&
literal|0xff
operator|)
return|;
block|}
if|if
condition|(
operator|(
name|flag
operator|&
name|TTYF_REDIRECT
operator|)
operator|&&
name|redirect0
condition|)
block|{
name|char
name|c
decl_stmt|;
if|if
condition|(
name|read
argument_list|(
name|STDIN_FILENO
argument_list|,
operator|&
name|c
argument_list|,
literal|1
argument_list|)
operator|!=
literal|1
condition|)
return|return
operator|(
operator|-
literal|1
operator|)
return|;
if|if
condition|(
name|c
operator|==
literal|'\n'
condition|)
name|c
operator|=
literal|'\r'
expr_stmt|;
return|return
operator|(
name|c
operator|)
return|;
block|}
if|if
condition|(
name|KbdEmpty
argument_list|()
condition|)
block|{
if|if
condition|(
name|flag
operator|&
name|TTYF_BLOCK
condition|)
block|{
while|while
condition|(
name|KbdEmpty
argument_list|()
condition|)
name|tty_pause
argument_list|()
expr_stmt|;
block|}
else|else
block|{
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
block|}
name|r
operator|=
name|KbdRead
argument_list|()
expr_stmt|;
if|if
condition|(
operator|(
name|r
operator|&
literal|0xff
operator|)
operator|==
literal|0
condition|)
name|nextchar
operator|=
name|r
operator|>>
literal|8
expr_stmt|;
name|r
operator|&=
literal|0xff
expr_stmt|;
if|if
condition|(
name|flag
operator|&
name|TTYF_CTRL
condition|)
block|{
if|if
condition|(
name|r
operator|==
literal|3
condition|)
block|{
comment|/* 	     * XXX - Not quite sure where we should return, maybe not 	     *       all the way to the user, but... 	     */
if|if
condition|(
name|ivec
index|[
literal|0x23
index|]
operator|&&
operator|(
name|ivec
index|[
literal|0x23
index|]
operator|>>
literal|16
operator|)
operator|!=
literal|0xF000
condition|)
block|{
name|fake_int
argument_list|(
name|REGS
argument_list|,
literal|0x23
argument_list|)
expr_stmt|;
name|R_EIP
operator|=
name|R_EIP
operator|-
literal|2
expr_stmt|;
return|return
operator|(
operator|-
literal|2
operator|)
return|;
block|}
block|}
block|}
if|if
condition|(
name|flag
operator|&
name|TTYF_ECHO
condition|)
block|{
if|if
condition|(
operator|(
name|flag
operator|&
name|TTYF_ECHONL
operator|)
operator|&&
operator|(
name|r
operator|==
literal|'\n'
operator|||
name|r
operator|==
literal|'\r'
operator|)
condition|)
block|{
name|tty_write
argument_list|(
literal|'\r'
argument_list|,
operator|-
literal|1
argument_list|)
expr_stmt|;
name|tty_write
argument_list|(
literal|'\n'
argument_list|,
operator|-
literal|1
argument_list|)
expr_stmt|;
block|}
else|else
name|tty_write
argument_list|(
name|r
argument_list|,
operator|-
literal|1
argument_list|)
expr_stmt|;
block|}
return|return
operator|(
name|r
operator|&
literal|0xff
operator|)
return|;
block|}
end_function

begin_function
name|int
name|tty_peek
parameter_list|(
name|REGISTERS
parameter_list|,
name|int
name|flag
parameter_list|)
block|{
name|int
name|c
decl_stmt|;
if|if
condition|(
name|c
operator|==
name|nextchar
condition|)
return|return
operator|(
name|nextchar
operator|&
literal|0xff
operator|)
return|;
if|if
condition|(
name|KbdEmpty
argument_list|()
condition|)
block|{
if|if
condition|(
name|flag
operator|&
name|TTYF_POLL
condition|)
block|{
name|sleep_poll
argument_list|()
expr_stmt|;
if|if
condition|(
name|KbdEmpty
argument_list|()
condition|)
return|return
operator|(
literal|0
operator|)
return|;
block|}
elseif|else
if|if
condition|(
name|flag
operator|&
name|TTYF_BLOCK
condition|)
block|{
while|while
condition|(
name|KbdEmpty
argument_list|()
condition|)
name|tty_pause
argument_list|()
expr_stmt|;
block|}
else|else
return|return
operator|(
literal|0
operator|)
return|;
block|}
name|c
operator|=
name|KbdPeek
argument_list|()
expr_stmt|;
if|if
condition|(
operator|(
name|c
operator|&
literal|0xff
operator|)
operator|==
literal|3
condition|)
block|{
comment|/* 	     * XXX - Not quite sure where we should return, maybe not 	     *       all the way to the user, but... 	     */
if|if
condition|(
name|ivec
index|[
literal|0x23
index|]
operator|&&
operator|(
name|ivec
index|[
literal|0x23
index|]
operator|>>
literal|16
operator|)
operator|!=
literal|0xF000
condition|)
block|{
name|fake_int
argument_list|(
name|REGS
argument_list|,
literal|0x23
argument_list|)
expr_stmt|;
name|R_EIP
operator|=
name|R_EIP
operator|-
literal|2
expr_stmt|;
return|return
operator|(
operator|-
literal|2
operator|)
return|;
block|}
block|}
return|return
operator|(
literal|0xff
operator|)
return|;
block|}
end_function

begin_function
name|int
name|tty_state
parameter_list|()
block|{
return|return
operator|(
name|K1_STATUS
operator|)
return|;
block|}
end_function

begin_function
name|int
name|tty_estate
parameter_list|()
block|{
name|int
name|state
init|=
literal|0
decl_stmt|;
if|if
condition|(
name|K2_STATUS
operator|&
name|K2_SYSREQ
condition|)
name|state
operator||=
literal|0x80
expr_stmt|;
if|if
condition|(
name|K2_STATUS
operator|&
name|K2_CLOCK
condition|)
name|state
operator||=
literal|0x40
expr_stmt|;
if|if
condition|(
name|K2_STATUS
operator|&
name|K2_NLOCK
condition|)
name|state
operator||=
literal|0x20
expr_stmt|;
if|if
condition|(
name|K2_STATUS
operator|&
name|K2_SLOCK
condition|)
name|state
operator||=
literal|0x10
expr_stmt|;
if|if
condition|(
name|K3_STATUS
operator|&
name|K3_RALT
condition|)
name|state
operator||=
literal|0x08
expr_stmt|;
if|if
condition|(
name|K3_STATUS
operator|&
name|K3_RCTRL
condition|)
name|state
operator||=
literal|0x04
expr_stmt|;
if|if
condition|(
name|K2_STATUS
operator|&
name|K2_LALT
condition|)
name|state
operator||=
literal|0x02
expr_stmt|;
if|if
condition|(
name|K2_STATUS
operator|&
name|K2_LCTRL
condition|)
name|state
operator||=
literal|0x01
expr_stmt|;
return|return
operator|(
name|state
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|inrange
parameter_list|(
name|int
name|a
parameter_list|,
name|int
name|n
parameter_list|,
name|int
name|x
parameter_list|)
block|{
return|return
operator|(
name|a
operator|<
name|n
condition|?
name|n
else|:
name|a
operator|>
name|x
condition|?
name|x
else|:
name|a
operator|)
return|;
block|}
end_function

begin_function
name|void
name|tty_scroll
parameter_list|(
name|int
name|sr
parameter_list|,
name|int
name|sc
parameter_list|,
name|int
name|er
parameter_list|,
name|int
name|ec
parameter_list|,
name|int
name|n
parameter_list|,
name|int
name|attr
parameter_list|)
block|{
name|int
name|i
decl_stmt|,
name|j
decl_stmt|;
name|sr
operator|=
name|inrange
argument_list|(
name|sr
argument_list|,
literal|0
argument_list|,
name|height
argument_list|)
expr_stmt|;
name|er
operator|=
name|inrange
argument_list|(
name|er
argument_list|,
literal|0
argument_list|,
name|height
argument_list|)
expr_stmt|;
name|sc
operator|=
name|inrange
argument_list|(
name|sc
argument_list|,
literal|0
argument_list|,
name|width
argument_list|)
expr_stmt|;
name|ec
operator|=
name|inrange
argument_list|(
name|ec
argument_list|,
literal|0
argument_list|,
name|width
argument_list|)
expr_stmt|;
if|if
condition|(
name|sr
operator|>
name|er
operator|||
name|sc
operator|>
name|ec
condition|)
return|return;
operator|++
name|er
expr_stmt|;
operator|++
name|ec
expr_stmt|;
name|attr
operator|&=
literal|0xff00
expr_stmt|;
name|attr
operator||=
literal|' '
expr_stmt|;
if|if
condition|(
name|n
operator|>
literal|0
operator|&&
name|n
operator|<
name|er
operator|-
name|sr
condition|)
block|{
for|for
control|(
name|j
operator|=
name|sr
init|;
name|j
operator|<
name|er
operator|-
name|n
condition|;
control|)
block|{
name|memcpy
argument_list|(
operator|&
name|vmem
index|[
name|j
operator|*
name|width
operator|+
name|sc
index|]
argument_list|,
operator|&
name|vmem
index|[
operator|(
name|j
operator|+
name|n
operator|)
operator|*
name|width
operator|+
name|sc
index|]
argument_list|,
sizeof|sizeof
argument_list|(
name|vmem
index|[
literal|0
index|]
argument_list|)
operator|*
operator|(
name|ec
operator|-
name|sc
operator|)
argument_list|)
expr_stmt|;
operator|++
name|j
expr_stmt|;
block|}
block|}
else|else
name|n
operator|=
name|er
operator|-
name|sr
expr_stmt|;
for|for
control|(
name|j
operator|=
name|er
operator|-
name|n
init|;
name|j
operator|<
name|er
condition|;
control|)
block|{
for|for
control|(
name|i
operator|=
name|sc
init|;
name|i
operator|<
name|ec
condition|;
operator|++
name|i
control|)
name|vmem
index|[
name|j
operator|*
name|width
operator|+
name|i
index|]
operator|=
name|attr
expr_stmt|;
operator|++
name|j
expr_stmt|;
block|}
block|}
end_function

begin_function
name|void
name|tty_rscroll
parameter_list|(
name|int
name|sr
parameter_list|,
name|int
name|sc
parameter_list|,
name|int
name|er
parameter_list|,
name|int
name|ec
parameter_list|,
name|int
name|n
parameter_list|,
name|int
name|attr
parameter_list|)
block|{
name|int
name|i
decl_stmt|,
name|j
decl_stmt|;
name|sr
operator|=
name|inrange
argument_list|(
name|sr
argument_list|,
literal|0
argument_list|,
name|height
argument_list|)
expr_stmt|;
name|er
operator|=
name|inrange
argument_list|(
name|er
argument_list|,
literal|0
argument_list|,
name|height
argument_list|)
expr_stmt|;
name|sc
operator|=
name|inrange
argument_list|(
name|sc
argument_list|,
literal|0
argument_list|,
name|width
argument_list|)
expr_stmt|;
name|ec
operator|=
name|inrange
argument_list|(
name|ec
argument_list|,
literal|0
argument_list|,
name|width
argument_list|)
expr_stmt|;
if|if
condition|(
name|sr
operator|>
name|er
operator|||
name|sc
operator|>
name|ec
condition|)
return|return;
operator|++
name|er
expr_stmt|;
operator|++
name|ec
expr_stmt|;
name|attr
operator|&=
literal|0xff00
expr_stmt|;
name|attr
operator||=
literal|' '
expr_stmt|;
if|if
condition|(
name|n
operator|>
literal|0
operator|&&
name|n
operator|<
name|er
operator|-
name|sr
condition|)
block|{
for|for
control|(
name|j
operator|=
name|er
init|;
name|j
operator|>
name|sr
operator|+
name|n
condition|;
control|)
block|{
operator|--
name|j
expr_stmt|;
name|memcpy
argument_list|(
operator|&
name|vmem
index|[
name|j
operator|*
name|width
operator|+
name|sc
index|]
argument_list|,
operator|&
name|vmem
index|[
operator|(
name|j
operator|-
name|n
operator|)
operator|*
name|width
operator|+
name|sc
index|]
argument_list|,
sizeof|sizeof
argument_list|(
name|vmem
index|[
literal|0
index|]
argument_list|)
operator|*
operator|(
name|ec
operator|-
name|sc
operator|)
argument_list|)
expr_stmt|;
block|}
block|}
else|else
name|n
operator|=
name|er
operator|-
name|sr
expr_stmt|;
for|for
control|(
name|j
operator|=
name|sr
operator|+
name|n
init|;
name|j
operator|>
name|sr
condition|;
control|)
block|{
operator|--
name|j
expr_stmt|;
for|for
control|(
name|i
operator|=
name|sc
init|;
name|i
operator|<
name|ec
condition|;
operator|++
name|i
control|)
name|vmem
index|[
name|j
operator|*
name|width
operator|+
name|i
index|]
operator|=
name|attr
expr_stmt|;
block|}
block|}
end_function

begin_function
name|int
name|tty_char
parameter_list|(
name|int
name|r
parameter_list|,
name|int
name|c
parameter_list|)
block|{
if|if
condition|(
name|r
operator|==
operator|-
literal|1
condition|)
name|r
operator|=
name|row
expr_stmt|;
if|if
condition|(
name|c
operator|==
operator|-
literal|1
condition|)
name|c
operator|=
name|col
expr_stmt|;
name|r
operator|=
name|inrange
argument_list|(
name|r
argument_list|,
literal|0
argument_list|,
name|height
argument_list|)
expr_stmt|;
name|c
operator|=
name|inrange
argument_list|(
name|c
argument_list|,
literal|0
argument_list|,
name|width
argument_list|)
expr_stmt|;
return|return
operator|(
name|vmem
index|[
name|r
operator|*
name|width
operator|+
name|c
index|]
operator|)
return|;
block|}
end_function

begin_function
name|int
name|KbdEmpty
parameter_list|()
block|{
return|return
operator|(
name|K_NEXT
operator|==
name|K_FREE
operator|)
return|;
block|}
end_function

begin_function
name|void
name|KbdWrite
parameter_list|(
name|u_short
name|code
parameter_list|)
block|{
name|int
name|kf
decl_stmt|;
name|kf
operator|=
name|K_FREE
operator|+
literal|2
expr_stmt|;
if|if
condition|(
name|kf
operator|==
name|K_BUFENDP
condition|)
name|kf
operator|=
name|K_BUFSTARTP
expr_stmt|;
if|if
condition|(
name|kf
operator|==
name|K_NEXT
condition|)
block|{
ifndef|#
directive|ifndef
name|NO_X
name|XBell
argument_list|(
name|dpy
argument_list|,
literal|0
argument_list|)
expr_stmt|;
endif|#
directive|endif
return|return;
block|}
name|K_BUF
argument_list|(
name|K_FREE
argument_list|)
operator|=
name|code
expr_stmt|;
name|K_FREE
operator|=
name|kf
expr_stmt|;
block|}
end_function

begin_function
name|u_short
name|KbdRead
parameter_list|()
block|{
name|int
name|kf
init|=
name|K_NEXT
decl_stmt|;
name|K_NEXT
operator|=
name|K_NEXT
operator|+
literal|2
expr_stmt|;
if|if
condition|(
name|K_NEXT
operator|==
name|K_BUFENDP
condition|)
name|K_NEXT
operator|=
name|K_BUFSTARTP
expr_stmt|;
return|return
operator|(
name|K_BUF
argument_list|(
name|kf
argument_list|)
operator|)
return|;
block|}
end_function

begin_function
name|u_short
name|KbdPeek
parameter_list|()
block|{
return|return
operator|(
name|K_BUF
argument_list|(
name|K_NEXT
argument_list|)
operator|)
return|;
block|}
end_function

begin_function
name|void
name|kbd_init
parameter_list|()
block|{
name|u_long
name|vec
decl_stmt|;
name|define_input_port_handler
argument_list|(
literal|0x60
argument_list|,
name|inb_port60
argument_list|)
expr_stmt|;
name|K_BUFSTARTP
operator|=
literal|0x1e
expr_stmt|;
comment|/* Start of keyboard buffer */
name|K_BUFENDP
operator|=
literal|0x3e
expr_stmt|;
comment|/* End of keyboard buffer */
name|K_NEXT
operator|=
name|K_FREE
operator|=
name|K_BUFSTARTP
expr_stmt|;
name|vec
operator|=
name|insert_hardint_trampoline
argument_list|()
expr_stmt|;
name|ivec
index|[
literal|0x09
index|]
operator|=
name|vec
expr_stmt|;
name|register_callback
argument_list|(
name|vec
argument_list|,
name|int09
argument_list|,
literal|"int 09"
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_function
name|void
name|kbd_bios_init
parameter_list|()
block|{
name|BIOSDATA
index|[
literal|0x96
index|]
operator|=
literal|0x10
expr_stmt|;
comment|/* MF II kbd, 101 keys */
name|K1_STATUS
operator|=
literal|0
expr_stmt|;
name|K2_STATUS
operator|=
literal|0
expr_stmt|;
name|K3_STATUS
operator|=
literal|0
expr_stmt|;
name|K4_STATUS
operator|=
literal|0
expr_stmt|;
block|}
end_function

begin_ifndef
ifndef|#
directive|ifndef
name|NO_X
end_ifndef

begin_comment
comment|/* Calculate 16 bit RGB values for X from the 6 bit DAC values and the    palette. This works for 16 and 256 color modes, although we don't really    support the latter yet. */
end_comment

begin_function
specifier|static
name|void
name|dac2rgb
parameter_list|(
name|XColor
modifier|*
name|color
parameter_list|,
name|int
name|i
parameter_list|)
block|{
name|int
name|n
decl_stmt|,
name|m
decl_stmt|;
comment|/* 256 colors are easy; just take the RGB values from the DAC and        shift left. For the pedants: multiplication with 65535./63. and        rounding makes a difference of less than two percent. */
if|if
condition|(
name|VGA_ATC
index|[
name|ATC_ModeCtrl
index|]
operator|&
literal|0x40
condition|)
block|{
name|color
operator|->
name|red
operator|=
name|dac_rgb
index|[
name|i
index|]
operator|.
name|red
operator|<<
literal|10
expr_stmt|;
name|color
operator|->
name|green
operator|=
name|dac_rgb
index|[
name|i
index|]
operator|.
name|green
operator|<<
literal|10
expr_stmt|;
name|color
operator|->
name|blue
operator|=
name|dac_rgb
index|[
name|i
index|]
operator|.
name|blue
operator|<<
literal|10
expr_stmt|;
return|return;
block|}
comment|/* For the 16 color modes, check bit 7 of the Mode Control register in        the ATC. If set, we take bits 0-3 of the Color Select register and        bits 0-3 of the palette register 'i' to build the index into the        DAC table; otherwise, bits 2 and 3 of the CS reg and bits 0-5 of        the palette register are used. Note that the entries in 'palette[]'        are supposed to be already masked to 6 bits. */
if|if
condition|(
name|VGA_ATC
index|[
name|ATC_ModeCtrl
index|]
operator|&
literal|0x80
condition|)
block|{
name|n
operator|=
name|VGA_ATC
index|[
name|ATC_ColorSelect
index|]
operator|&
literal|0x0f
expr_stmt|;
name|m
operator|=
name|palette
index|[
name|i
index|]
operator|&
literal|0x0f
expr_stmt|;
block|}
else|else
block|{
name|n
operator|=
name|VGA_ATC
index|[
name|ATC_ColorSelect
index|]
operator|&
literal|0x0c
expr_stmt|;
name|m
operator|=
name|palette
index|[
name|i
index|]
expr_stmt|;
block|}
name|color
operator|->
name|red
operator|=
name|dac_rgb
index|[
literal|16
operator|*
name|n
operator|+
name|m
index|]
operator|.
name|red
operator|<<
literal|10
expr_stmt|;
name|color
operator|->
name|green
operator|=
name|dac_rgb
index|[
literal|16
operator|*
name|n
operator|+
name|m
index|]
operator|.
name|green
operator|<<
literal|10
expr_stmt|;
name|color
operator|->
name|blue
operator|=
name|dac_rgb
index|[
literal|16
operator|*
name|n
operator|+
name|m
index|]
operator|.
name|blue
operator|<<
literal|10
expr_stmt|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* Get a connection to the X server and create the window. */
end_comment

begin_function
name|void
name|init_window
parameter_list|()
block|{
ifndef|#
directive|ifndef
name|NO_X
name|XGCValues
name|gcv
decl_stmt|;
name|int
name|i
decl_stmt|;
block|{
comment|/* 	 * Arg...  I can no longer change X's fd out from under it. 	 * Open up all the available fd's, leave 3 behind for X 	 * to play with, open X and then release all the other fds 	 */
name|int
name|nfds
init|=
name|sysconf
argument_list|(
name|_SC_OPEN_MAX
argument_list|)
decl_stmt|;
name|int
modifier|*
name|fds
init|=
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
name|int
argument_list|)
operator|*
name|nfds
argument_list|)
decl_stmt|;
name|i
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|fds
condition|)
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|nfds
operator|&&
operator|(
name|i
operator|==
literal|0
operator|||
name|fds
index|[
name|i
operator|-
literal|1
index|]
operator|<
literal|63
operator|)
condition|;
operator|++
name|i
control|)
if|if
condition|(
operator|(
name|fds
index|[
name|i
index|]
operator|=
name|open
argument_list|(
name|_PATH_DEVNULL
argument_list|,
literal|0
argument_list|)
operator|)
operator|<
literal|0
condition|)
break|break;
comment|/* 	 * Leave 3 fds behind for X to play with 	 */
if|if
condition|(
name|i
operator|>
literal|0
condition|)
name|close
argument_list|(
name|fds
index|[
operator|--
name|i
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|i
operator|>
literal|0
condition|)
name|close
argument_list|(
name|fds
index|[
operator|--
name|i
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|i
operator|>
literal|0
condition|)
name|close
argument_list|(
name|fds
index|[
operator|--
name|i
index|]
argument_list|)
expr_stmt|;
name|dpy
operator|=
name|XOpenDisplay
argument_list|(
name|NULL
argument_list|)
expr_stmt|;
while|while
condition|(
name|i
operator|>
literal|0
condition|)
name|close
argument_list|(
name|fds
index|[
operator|--
name|i
index|]
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|dpy
operator|==
name|NULL
condition|)
name|err
argument_list|(
literal|1
argument_list|,
literal|"Could not open display ``%s''\n"
argument_list|,
name|XDisplayName
argument_list|(
name|NULL
argument_list|)
argument_list|)
expr_stmt|;
name|xfd
operator|=
name|ConnectionNumber
argument_list|(
name|dpy
argument_list|)
expr_stmt|;
name|_RegisterIO
argument_list|(
name|xfd
argument_list|,
name|video_async_event
argument_list|,
literal|0
argument_list|,
name|Failure
argument_list|)
expr_stmt|;
if|if
condition|(
name|debug_flags
operator|&
name|D_DEBUGIN
condition|)
name|_RegisterIO
argument_list|(
literal|0
argument_list|,
name|debug_event
argument_list|,
literal|0
argument_list|,
name|Failure
argument_list|)
expr_stmt|;
comment|/* Create window, but defer setting a size and GC. */
name|win
operator|=
name|XCreateSimpleWindow
argument_list|(
name|dpy
argument_list|,
name|DefaultRootWindow
argument_list|(
name|dpy
argument_list|)
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|,
literal|2
argument_list|,
name|black
argument_list|,
name|black
argument_list|)
expr_stmt|;
name|gcv
operator|.
name|foreground
operator|=
name|white
expr_stmt|;
name|gcv
operator|.
name|background
operator|=
name|black
expr_stmt|;
name|gc
operator|=
name|XCreateGC
argument_list|(
name|dpy
argument_list|,
name|win
argument_list|,
name|GCForeground
operator||
name|GCBackground
argument_list|,
operator|&
name|gcv
argument_list|)
expr_stmt|;
name|gcv
operator|.
name|foreground
operator|=
literal|1
expr_stmt|;
name|gcv
operator|.
name|background
operator|=
literal|0
expr_stmt|;
name|gcv
operator|.
name|function
operator|=
name|GXxor
expr_stmt|;
name|cgc
operator|=
name|XCreateGC
argument_list|(
name|dpy
argument_list|,
name|win
argument_list|,
name|GCForeground
operator||
name|GCBackground
operator||
name|GCFunction
argument_list|,
operator|&
name|gcv
argument_list|)
expr_stmt|;
if|if
condition|(
name|raw_kbd
condition|)
block|{
name|XSelectInput
argument_list|(
name|dpy
argument_list|,
name|win
argument_list|,
name|ExposureMask
operator||
name|ButtonPressMask
operator||
name|ButtonReleaseMask
operator||
name|PointerMotionMask
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|XSelectInput
argument_list|(
name|dpy
argument_list|,
name|win
argument_list|,
name|KeyReleaseMask
operator||
name|KeyPressMask
operator||
name|ExposureMask
operator||
name|ButtonPressMask
operator||
name|ButtonReleaseMask
operator||
name|PointerMotionMask
argument_list|)
expr_stmt|;
block|}
name|XStoreName
argument_list|(
name|dpy
argument_list|,
name|win
argument_list|,
literal|"DOS"
argument_list|)
expr_stmt|;
comment|/* Get the default visual and depth for later use. */
name|depth
operator|=
name|DefaultDepth
argument_list|(
name|dpy
argument_list|,
name|DefaultScreen
argument_list|(
name|dpy
argument_list|)
argument_list|)
expr_stmt|;
name|visual
operator|=
name|DefaultVisual
argument_list|(
name|dpy
argument_list|,
name|DefaultScreen
argument_list|(
name|dpy
argument_list|)
argument_list|)
expr_stmt|;
name|prepare_lut
argument_list|()
expr_stmt|;
if|#
directive|if
literal|0
comment|/* While we are developing the graphics code ... */
block|call_on_quit(write_vram, NULL);
endif|#
directive|endif
endif|#
directive|endif
block|}
end_function

begin_function
name|void
name|load_font
parameter_list|()
block|{
ifndef|#
directive|ifndef
name|NO_X
name|XGCValues
name|gcv
decl_stmt|;
if|if
condition|(
operator|!
name|xfont
condition|)
name|xfont
operator|=
name|FONTVGA
expr_stmt|;
name|font
operator|=
name|XLoadQueryFont
argument_list|(
name|dpy
argument_list|,
name|xfont
argument_list|)
expr_stmt|;
if|if
condition|(
name|font
operator|==
name|NULL
condition|)
name|font
operator|=
name|XLoadQueryFont
argument_list|(
name|dpy
argument_list|,
name|FONTVGA
argument_list|)
expr_stmt|;
if|if
condition|(
name|font
operator|==
name|NULL
condition|)
name|err
argument_list|(
literal|1
argument_list|,
literal|"Could not open font ``%s''\n"
argument_list|,
name|xfont
argument_list|)
expr_stmt|;
name|gcv
operator|.
name|font
operator|=
name|font
operator|->
name|fid
expr_stmt|;
name|XChangeGC
argument_list|(
name|dpy
argument_list|,
name|gc
argument_list|,
name|GCFont
argument_list|,
operator|&
name|gcv
argument_list|)
expr_stmt|;
name|FW
operator|=
name|font
operator|->
name|max_bounds
operator|.
name|width
expr_stmt|;
name|FH
operator|=
name|font
operator|->
name|max_bounds
operator|.
name|ascent
operator|+
name|font
operator|->
name|max_bounds
operator|.
name|descent
expr_stmt|;
name|FD
operator|=
name|font
operator|->
name|max_bounds
operator|.
name|descent
expr_stmt|;
comment|/* Put the pixel representation at c000:3000. */
switch|switch
condition|(
name|CharHeight
condition|)
block|{
case|case
literal|8
case|:
name|memcpy
argument_list|(
operator|(
name|void
operator|*
operator|)
literal|0xc3000
argument_list|,
name|font8x8
argument_list|,
sizeof|sizeof
argument_list|(
name|font8x8
argument_list|)
argument_list|)
expr_stmt|;
break|break;
case|case
literal|14
case|:
name|memcpy
argument_list|(
operator|(
name|void
operator|*
operator|)
literal|0xc3000
argument_list|,
name|font8x14
argument_list|,
sizeof|sizeof
argument_list|(
name|font8x14
argument_list|)
argument_list|)
expr_stmt|;
break|break;
case|case
literal|16
case|:
name|memcpy
argument_list|(
operator|(
name|void
operator|*
operator|)
literal|0xc3000
argument_list|,
name|font8x16
argument_list|,
sizeof|sizeof
argument_list|(
name|font8x16
argument_list|)
argument_list|)
expr_stmt|;
break|break;
default|default:
name|err
argument_list|(
literal|1
argument_list|,
literal|"load_font: CharHeight = %d?"
argument_list|,
name|CharHeight
argument_list|)
expr_stmt|;
block|}
return|return;
endif|#
directive|endif
block|}
end_function

begin_comment
comment|/* Get a new, or resize an old XImage as canvas for the graphics display. */
end_comment

begin_function
name|void
name|get_ximage
parameter_list|()
block|{
ifndef|#
directive|ifndef
name|NO_X
if|if
condition|(
name|xi
operator|!=
name|NULL
condition|)
name|XFree
argument_list|(
name|xi
argument_list|)
expr_stmt|;
name|xi
operator|=
name|XCreateImage
argument_list|(
name|dpy
argument_list|,
name|visual
argument_list|,
name|depth
argument_list|,
name|ZPixmap
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|,
name|width
argument_list|,
name|height
argument_list|,
literal|32
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|xi
operator|==
name|NULL
condition|)
name|err
argument_list|(
literal|1
argument_list|,
literal|"Could not get ximage"
argument_list|)
expr_stmt|;
name|xi
operator|->
name|data
operator|=
name|malloc
argument_list|(
name|width
operator|*
name|height
operator|*
name|depth
operator|/
literal|8
argument_list|)
expr_stmt|;
if|if
condition|(
name|xi
operator|->
name|data
operator|==
name|NULL
condition|)
block|{
name|XDestroyImage
argument_list|(
name|xi
argument_list|)
expr_stmt|;
name|err
argument_list|(
literal|1
argument_list|,
literal|"Could not get memory for ximage data"
argument_list|)
expr_stmt|;
block|}
return|return;
endif|#
directive|endif
block|}
end_function

begin_comment
comment|/* Get memory for the text line buffer. */
end_comment

begin_function
name|void
name|get_lines
parameter_list|()
block|{
name|int
name|i
decl_stmt|;
if|if
condition|(
name|lines
operator|==
name|NULL
condition|)
block|{
name|lines
operator|=
operator|(
name|TextLine
operator|*
operator|)
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
name|TextLine
argument_list|)
operator|*
name|height
argument_list|)
expr_stmt|;
if|if
condition|(
name|lines
operator|==
name|NULL
condition|)
name|err
argument_list|(
literal|1
argument_list|,
literal|"Could not allocate data structure for text lines\n"
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|height
condition|;
operator|++
name|i
control|)
block|{
name|lines
index|[
name|i
index|]
operator|.
name|max_length
operator|=
name|width
expr_stmt|;
name|lines
index|[
name|i
index|]
operator|.
name|data
operator|=
operator|(
name|u_short
operator|*
operator|)
name|malloc
argument_list|(
name|width
operator|*
sizeof|sizeof
argument_list|(
name|u_short
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|lines
index|[
name|i
index|]
operator|.
name|data
operator|==
name|NULL
condition|)
name|err
argument_list|(
literal|1
argument_list|,
literal|"Could not allocate data structure for text lines\n"
argument_list|)
expr_stmt|;
name|lines
index|[
name|i
index|]
operator|.
name|changed
operator|=
literal|1
expr_stmt|;
block|}
block|}
else|else
block|{
name|lines
operator|=
operator|(
name|TextLine
operator|*
operator|)
name|realloc
argument_list|(
name|lines
argument_list|,
sizeof|sizeof
argument_list|(
name|TextLine
argument_list|)
operator|*
name|height
argument_list|)
expr_stmt|;
if|if
condition|(
name|lines
operator|==
name|NULL
condition|)
name|err
argument_list|(
literal|1
argument_list|,
literal|"Could not allocate data structure for text lines\n"
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|height
condition|;
operator|++
name|i
control|)
block|{
name|lines
index|[
name|i
index|]
operator|.
name|max_length
operator|=
name|width
expr_stmt|;
name|lines
index|[
name|i
index|]
operator|.
name|data
operator|=
operator|(
name|u_short
operator|*
operator|)
name|realloc
argument_list|(
name|lines
index|[
name|i
index|]
operator|.
name|data
argument_list|,
name|width
operator|*
sizeof|sizeof
argument_list|(
name|u_short
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|lines
index|[
name|i
index|]
operator|.
name|data
operator|==
name|NULL
condition|)
name|err
argument_list|(
literal|1
argument_list|,
literal|"Could not allocate data structure for text lines\n"
argument_list|)
expr_stmt|;
name|lines
index|[
name|i
index|]
operator|.
name|changed
operator|=
literal|1
expr_stmt|;
block|}
block|}
block|}
end_function

begin_ifndef
ifndef|#
directive|ifndef
name|NO_X
end_ifndef

begin_comment
comment|/* Prepare the LUT for the VRAM -> XImage conversion. */
end_comment

begin_function
specifier|static
name|void
name|prepare_lut
parameter_list|()
block|{
name|int
name|i
decl_stmt|,
name|j
decl_stmt|,
name|k
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|4
condition|;
name|i
operator|++
control|)
block|{
for|for
control|(
name|j
operator|=
literal|0
init|;
name|j
operator|<
literal|256
condition|;
name|j
operator|++
control|)
block|{
for|for
control|(
name|k
operator|=
literal|0
init|;
name|k
operator|<
literal|8
condition|;
name|k
operator|++
control|)
block|{
name|lut
index|[
name|i
index|]
index|[
name|j
index|]
index|[
literal|7
operator|-
name|k
index|]
operator|=
operator|(
operator|(
name|j
operator|&
operator|(
literal|1
operator|<<
name|k
operator|)
operator|)
condition|?
operator|(
literal|1
operator|<<
name|i
operator|)
else|:
literal|0
operator|)
expr_stmt|;
block|}
block|}
block|}
return|return;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* Resize the window, using information from 'vga_status[]'. This function is    called after a mode change. */
end_comment

begin_function
name|void
name|resize_window
parameter_list|()
block|{
ifndef|#
directive|ifndef
name|NO_X
name|XSizeHints
modifier|*
name|sh
decl_stmt|;
name|vmode_t
name|vmode
decl_stmt|;
name|sh
operator|=
name|XAllocSizeHints
argument_list|()
expr_stmt|;
if|if
condition|(
name|sh
operator|==
name|NULL
condition|)
name|err
argument_list|(
literal|1
argument_list|,
literal|"Could not get XSizeHints structure"
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|width
operator|=
name|DpyCols
expr_stmt|;
name|height
operator|=
name|DpyRows
operator|+
literal|1
expr_stmt|;
ifndef|#
directive|ifndef
name|NO_X
name|vmode
operator|=
name|vmodelist
index|[
name|find_vmode
argument_list|(
name|VideoMode
argument_list|)
index|]
expr_stmt|;
if|if
condition|(
name|vmode
operator|.
name|type
operator|==
name|TEXT
condition|)
block|{
name|sh
operator|->
name|base_width
operator|=
name|FW
operator|*
name|width
operator|+
literal|4
expr_stmt|;
name|sh
operator|->
name|base_height
operator|=
name|FH
operator|*
name|height
operator|+
literal|4
expr_stmt|;
name|sh
operator|->
name|base_width
operator|+=
literal|4
expr_stmt|;
name|sh
operator|->
name|base_height
operator|+=
literal|4
expr_stmt|;
block|}
else|else
block|{
name|width
operator|*=
literal|8
expr_stmt|;
name|height
operator|*=
name|CharHeight
expr_stmt|;
name|sh
operator|->
name|base_width
operator|=
name|width
expr_stmt|;
name|sh
operator|->
name|base_height
operator|=
name|height
expr_stmt|;
block|}
name|sh
operator|->
name|min_width
operator|=
name|sh
operator|->
name|max_width
operator|=
name|sh
operator|->
name|base_width
expr_stmt|;
name|sh
operator|->
name|min_height
operator|=
name|sh
operator|->
name|max_height
operator|=
name|sh
operator|->
name|base_height
expr_stmt|;
name|sh
operator|->
name|flags
operator|=
name|USSize
operator||
name|PMinSize
operator||
name|PMaxSize
operator||
name|PSize
expr_stmt|;
name|debug
argument_list|(
name|D_VIDEO
argument_list|,
literal|"VGA: Set window size %dx%d\n"
argument_list|,
name|sh
operator|->
name|base_width
argument_list|,
name|sh
operator|->
name|base_height
argument_list|)
expr_stmt|;
name|XSetWMNormalHints
argument_list|(
name|dpy
argument_list|,
name|win
argument_list|,
name|sh
argument_list|)
expr_stmt|;
name|XResizeWindow
argument_list|(
name|dpy
argument_list|,
name|win
argument_list|,
name|sh
operator|->
name|base_width
argument_list|,
name|sh
operator|->
name|base_height
argument_list|)
expr_stmt|;
name|XMapWindow
argument_list|(
name|dpy
argument_list|,
name|win
argument_list|)
expr_stmt|;
name|XFlush
argument_list|(
name|dpy
argument_list|)
expr_stmt|;
name|XFree
argument_list|(
name|sh
argument_list|)
expr_stmt|;
return|return;
endif|#
directive|endif
block|}
end_function

begin_comment
comment|/* Calculate 'pixels[]' from the current DAC table and palette.     To do: do not use 'pixels[]', use an array of 'XColor's which we can    allocate and free on demand. Install a private colormap if necessary. */
end_comment

begin_function
name|void
name|update_pixels
parameter_list|()
block|{
ifndef|#
directive|ifndef
name|NO_X
name|int
name|i
decl_stmt|;
comment|/* We support only 16 colors for now. */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|16
condition|;
name|i
operator|++
control|)
block|{
name|XColor
name|color
decl_stmt|;
name|dac2rgb
argument_list|(
operator|&
name|color
argument_list|,
name|i
argument_list|)
expr_stmt|;
if|if
condition|(
name|XAllocColor
argument_list|(
name|dpy
argument_list|,
name|DefaultColormap
argument_list|(
name|dpy
argument_list|,
name|DefaultScreen
argument_list|(
name|dpy
argument_list|)
argument_list|)
argument_list|,
operator|&
name|color
argument_list|)
condition|)
block|{
name|pixels
index|[
name|i
index|]
operator|=
name|color
operator|.
name|pixel
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|i
operator|<
literal|7
condition|)
name|pixels
index|[
name|i
index|]
operator|=
name|BlackPixel
argument_list|(
name|dpy
argument_list|,
name|DefaultScreen
argument_list|(
name|dpy
argument_list|)
argument_list|)
expr_stmt|;
else|else
name|pixels
index|[
name|i
index|]
operator|=
name|WhitePixel
argument_list|(
name|dpy
argument_list|,
name|DefaultScreen
argument_list|(
name|dpy
argument_list|)
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
block|}
end_function

begin_function
name|void
name|write_vram
parameter_list|(
name|void
modifier|*
name|arg
name|__unused
parameter_list|)
block|{
name|int
name|fd
decl_stmt|;
if|if
condition|(
operator|(
name|fd
operator|=
name|open
argument_list|(
literal|"vram"
argument_list|,
name|O_WRONLY
operator||
name|O_CREAT
argument_list|,
literal|0644
argument_list|)
operator|)
operator|==
operator|-
literal|1
condition|)
name|err
argument_list|(
literal|1
argument_list|,
literal|"Can't open vram file"
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|write
argument_list|(
name|fd
argument_list|,
operator|(
name|void
operator|*
operator|)
name|vram
argument_list|,
literal|256
operator|*
literal|1024
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

end_unit


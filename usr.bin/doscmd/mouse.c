begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Copyright (c) 1992, 1993, 1996  *	Berkeley Software Design, Inc.  All rights reserved.  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions  * are met:  * 1. Redistributions of source code must retain the above copyright  *    notice, this list of conditions and the following disclaimer.  * 2. Redistributions in binary form must reproduce the above copyright  *    notice, this list of conditions and the following disclaimer in the  *    documentation and/or other materials provided with the distribution.  * 3. All advertising materials mentioning features or use of this software  *    must display the following acknowledgement:  *	This product includes software developed by Berkeley Software  *	Design, Inc.  *  * THIS SOFTWARE IS PROVIDED BY Berkeley Software Design, Inc. ``AS IS'' AND  * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE  * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE  * ARE DISCLAIMED.  IN NO EVENT SHALL Berkeley Software Design, Inc. BE LIABLE  * FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL  * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS  * OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)  * HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT  * LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY  * OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF  * SUCH DAMAGE.  *  *	BSDI int33.c,v 2.2 1996/04/08 19:32:54 bostic Exp  *  * $FreeBSD$  */
end_comment

begin_include
include|#
directive|include
file|"doscmd.h"
end_include

begin_include
include|#
directive|include
file|"mouse.h"
end_include

begin_decl_stmt
name|mouse_t
name|mouse_status
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|u_char
modifier|*
name|mouse_area
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|nmice
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_function
specifier|static
name|void
name|mouse_probe
parameter_list|(
name|void
parameter_list|)
block|{  }
end_function

begin_function
name|void
name|int33
parameter_list|(
name|regcontext_t
modifier|*
name|REGS
parameter_list|)
block|{
name|u_long
name|vec
decl_stmt|;
name|u_short
name|mask
decl_stmt|;
name|void
modifier|*
name|addr
decl_stmt|;
name|int
name|i
decl_stmt|;
if|if
condition|(
operator|!
name|nmice
condition|)
block|{
name|R_FLAGS
operator||=
name|PSL_C
expr_stmt|;
comment|/* We don't support a mouse */
return|return;
block|}
name|printf
argument_list|(
literal|"Mouse: %02x\n"
argument_list|,
name|R_AX
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|R_AX
condition|)
block|{
case|case
literal|0x00
case|:
comment|/* Reset Mouse */
name|printf
argument_list|(
literal|"Installing mouse driver\n"
argument_list|)
expr_stmt|;
name|R_AX
operator|=
literal|0xffff
expr_stmt|;
comment|/* Mouse installed */
name|R_BX
operator|=
literal|2
expr_stmt|;
comment|/* Number of mouse buttons */
name|memset
argument_list|(
operator|&
name|mouse_status
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|mouse_status
argument_list|)
argument_list|)
expr_stmt|;
name|mouse_status
operator|.
name|installed
operator|=
literal|1
expr_stmt|;
name|mouse_status
operator|.
name|hardcursor
operator|=
literal|1
expr_stmt|;
name|mouse_status
operator|.
name|end
operator|=
literal|16
expr_stmt|;
name|mouse_status
operator|.
name|hmickey
operator|=
literal|8
expr_stmt|;
name|mouse_status
operator|.
name|vmickey
operator|=
literal|16
expr_stmt|;
name|mouse_status
operator|.
name|doubling
operator|=
literal|100
expr_stmt|;
name|mouse_status
operator|.
name|init
operator|=
operator|-
literal|1
expr_stmt|;
name|mouse_status
operator|.
name|range
operator|.
name|w
operator|=
literal|8
operator|*
literal|80
expr_stmt|;
name|mouse_status
operator|.
name|range
operator|.
name|h
operator|=
literal|16
operator|*
literal|25
expr_stmt|;
break|break;
case|case
literal|0x01
case|:
comment|/* Display Mouse Cursor */
if|if
condition|(
operator|(
name|mouse_status
operator|.
name|init
operator|+=
literal|1
operator|)
operator|==
literal|0
condition|)
block|{
name|mouse_status
operator|.
name|show
operator|=
literal|1
expr_stmt|;
block|}
break|break;
case|case
literal|0x02
case|:
comment|/* Hide Mouse Cursor */
if|if
condition|(
name|mouse_status
operator|.
name|init
operator|==
literal|0
condition|)
name|mouse_status
operator|.
name|show
operator|=
literal|0
expr_stmt|;
name|mouse_status
operator|.
name|init
operator|-=
literal|1
expr_stmt|;
break|break;
case|case
literal|0x03
case|:
comment|/* Get cursor position/button status */
name|mouse_probe
argument_list|()
expr_stmt|;
name|R_CX
operator|=
name|mouse_status
operator|.
name|x
expr_stmt|;
name|R_DX
operator|=
name|mouse_status
operator|.
name|y
expr_stmt|;
name|R_BX
operator|=
name|mouse_status
operator|.
name|buttons
expr_stmt|;
break|break;
case|case
literal|0x04
case|:
comment|/* Move mouse cursor */
comment|/* mouse_move(GET16(sc->sc_ecx), GET16(sc->sc_edx)); */
break|break;
case|case
literal|0x05
case|:
comment|/* Determine number of times mouse button was active */
name|i
operator|=
name|R_BX
operator|&
literal|3
expr_stmt|;
if|if
condition|(
name|i
operator|==
literal|3
condition|)
name|i
operator|=
literal|1
expr_stmt|;
name|R_BX
operator|=
name|mouse_status
operator|.
name|downs
index|[
name|i
index|]
expr_stmt|;
name|mouse_status
operator|.
name|downs
index|[
name|i
index|]
operator|=
literal|0
expr_stmt|;
name|R_AX
operator|=
name|mouse_status
operator|.
name|buttons
expr_stmt|;
name|R_CX
operator|=
name|mouse_status
operator|.
name|x
expr_stmt|;
comment|/* Not quite right */
name|R_DX
operator|=
name|mouse_status
operator|.
name|y
expr_stmt|;
comment|/* Not quite right */
break|break;
case|case
literal|0x06
case|:
comment|/* Determine number of times mouse button was relsd */
name|i
operator|=
name|R_DX
operator|&
literal|3
expr_stmt|;
if|if
condition|(
name|i
operator|==
literal|3
condition|)
name|i
operator|=
literal|1
expr_stmt|;
name|R_BX
operator|=
name|mouse_status
operator|.
name|ups
index|[
name|i
index|]
expr_stmt|;
name|mouse_status
operator|.
name|ups
index|[
name|i
index|]
operator|=
literal|0
expr_stmt|;
name|R_AX
operator|=
name|mouse_status
operator|.
name|buttons
expr_stmt|;
name|R_CX
operator|=
name|mouse_status
operator|.
name|x
expr_stmt|;
comment|/* Not quite right */
name|R_DX
operator|=
name|mouse_status
operator|.
name|y
expr_stmt|;
comment|/* Not quite right */
break|break;
case|case
literal|0x07
case|:
comment|/* Set min/max horizontal cursor position */
name|mouse_status
operator|.
name|range
operator|.
name|x
operator|=
name|R_CX
expr_stmt|;
name|mouse_status
operator|.
name|range
operator|.
name|w
operator|=
name|R_DX
operator|-
name|R_CX
expr_stmt|;
break|break;
case|case
literal|0x08
case|:
comment|/* Set min/max vertical cursor position */
name|mouse_status
operator|.
name|range
operator|.
name|y
operator|=
name|R_CX
expr_stmt|;
name|mouse_status
operator|.
name|range
operator|.
name|h
operator|=
name|R_DX
operator|-
name|R_CX
expr_stmt|;
case|case
literal|0x09
case|:
comment|/* Set graphics cursor block */
comment|/* BX,CX is hot spot, ES:DX is data. */
break|break;
case|case
literal|0x0a
case|:
comment|/* Set Text Cursor */
name|mouse_status
operator|.
name|hardcursor
operator|=
name|R_BX
condition|?
literal|1
else|:
literal|0
expr_stmt|;
name|mouse_status
operator|.
name|start
operator|=
name|R_CX
expr_stmt|;
name|mouse_status
operator|.
name|end
operator|=
name|R_CX
expr_stmt|;
comment|/* XXX is this right ? */
break|break;
case|case
literal|0x0b
case|:
comment|/* Read Mouse Motion Counters */
name|mouse_probe
argument_list|()
expr_stmt|;
name|R_CX
operator|=
name|mouse_status
operator|.
name|x
operator|-
name|mouse_status
operator|.
name|lastx
expr_stmt|;
name|R_DX
operator|=
name|mouse_status
operator|.
name|y
operator|-
name|mouse_status
operator|.
name|lasty
expr_stmt|;
name|mouse_status
operator|.
name|lastx
operator|-
name|mouse_status
operator|.
name|x
expr_stmt|;
name|mouse_status
operator|.
name|lasty
operator|-
name|mouse_status
operator|.
name|y
expr_stmt|;
break|break;
case|case
literal|0x0c
case|:
comment|/* Set event handler */
name|mouse_status
operator|.
name|mask
operator|=
name|R_CX
expr_stmt|;
name|mouse_status
operator|.
name|handler
operator|=
name|N_GETVEC
argument_list|(
name|R_ES
argument_list|,
name|R_DX
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x0d
case|:
comment|/* Enable light pen */
case|case
literal|0x0e
case|:
comment|/* Disable light pen */
break|break;
case|case
literal|0x0f
case|:
comment|/* Set cursor speed */
name|mouse_status
operator|.
name|hmickey
operator|=
name|R_CX
expr_stmt|;
name|mouse_status
operator|.
name|vmickey
operator|=
name|R_DX
expr_stmt|;
break|break;
case|case
literal|0x10
case|:
comment|/* Exclusive area */
name|mouse_status
operator|.
name|exclude
operator|.
name|x
operator|=
name|R_CX
expr_stmt|;
name|mouse_status
operator|.
name|exclude
operator|.
name|y
operator|=
name|R_DX
expr_stmt|;
name|mouse_status
operator|.
name|exclude
operator|.
name|w
operator|=
name|R_SI
operator|-
name|R_CX
expr_stmt|;
name|mouse_status
operator|.
name|exclude
operator|.
name|h
operator|=
name|R_DI
operator|-
name|R_DX
expr_stmt|;
break|break;
case|case
literal|0x13
case|:
comment|/* Set maximum for mouse speed doubling */
break|break;
case|case
literal|0x14
case|:
comment|/* Exchange event handlers */
name|mask
operator|=
name|mouse_status
operator|.
name|mask
expr_stmt|;
name|vec
operator|=
name|mouse_status
operator|.
name|handler
expr_stmt|;
name|mouse_status
operator|.
name|mask
operator|=
name|R_CX
expr_stmt|;
name|mouse_status
operator|.
name|handler
operator|=
name|GETVEC
argument_list|(
name|R_ES
argument_list|,
name|R_DX
argument_list|)
expr_stmt|;
name|R_CX
operator|=
name|mask
expr_stmt|;
name|N_PUTVEC
argument_list|(
name|R_ES
argument_list|,
name|R_DX
argument_list|,
name|vec
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x15
case|:
comment|/* Determine mouse status buffer size */
name|R_BX
operator|=
sizeof|sizeof
argument_list|(
name|mouse_status
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x16
case|:
comment|/* Store mouse buffer */
name|memcpy
argument_list|(
operator|(
name|char
operator|*
operator|)
name|N_GETPTR
argument_list|(
name|R_ES
argument_list|,
name|R_DX
argument_list|)
argument_list|,
operator|&
name|mouse_status
argument_list|,
sizeof|sizeof
argument_list|(
name|mouse_status
argument_list|)
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x17
case|:
comment|/* Restore mouse buffer */
name|memcpy
argument_list|(
operator|&
name|mouse_status
argument_list|,
operator|(
name|char
operator|*
operator|)
name|N_GETPTR
argument_list|(
name|R_ES
argument_list|,
name|R_DX
argument_list|)
argument_list|,
sizeof|sizeof
argument_list|(
name|mouse_status
argument_list|)
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x18
case|:
comment|/* Install alternate handler */
name|mask
operator|=
name|R_CX
operator|&
literal|0xff
expr_stmt|;
if|if
condition|(
operator|(
name|R_CX
operator|&
literal|0xe0
operator|)
operator|==
literal|0x00
operator|||
name|mask
operator|==
name|mouse_status
operator|.
name|altmask
index|[
literal|0
index|]
operator|||
name|mask
operator|==
name|mouse_status
operator|.
name|altmask
index|[
literal|1
index|]
operator|||
name|mask
operator|==
name|mouse_status
operator|.
name|altmask
index|[
literal|2
index|]
operator|||
operator|(
name|mouse_status
operator|.
name|altmask
index|[
name|i
operator|=
literal|0
index|]
operator|&&
name|mouse_status
operator|.
name|altmask
index|[
name|i
operator|=
literal|1
index|]
operator|&&
name|mouse_status
operator|.
name|altmask
index|[
name|i
operator|=
literal|2
index|]
operator|)
condition|)
block|{
name|R_AX
operator|=
literal|0xffff
expr_stmt|;
break|break;
block|}
name|mouse_status
operator|.
name|altmask
index|[
name|i
index|]
operator|=
name|R_CX
expr_stmt|;
name|mouse_status
operator|.
name|althandler
index|[
name|i
index|]
operator|=
name|N_GETVEC
argument_list|(
name|R_ES
argument_list|,
name|R_DX
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x19
case|:
comment|/* Determine address of alternate event handler */
name|mask
operator|=
name|R_CX
operator|&
literal|0xff
expr_stmt|;
if|if
condition|(
name|mask
operator|==
name|mouse_status
operator|.
name|altmask
index|[
literal|0
index|]
condition|)
name|vec
operator|=
name|mouse_status
operator|.
name|althandler
index|[
literal|0
index|]
expr_stmt|;
elseif|else
if|if
condition|(
name|mask
operator|==
name|mouse_status
operator|.
name|altmask
index|[
literal|1
index|]
condition|)
name|vec
operator|=
name|mouse_status
operator|.
name|althandler
index|[
literal|1
index|]
expr_stmt|;
elseif|else
if|if
condition|(
name|mask
operator|==
name|mouse_status
operator|.
name|altmask
index|[
literal|2
index|]
condition|)
name|vec
operator|=
name|mouse_status
operator|.
name|althandler
index|[
literal|2
index|]
expr_stmt|;
else|else
name|R_CX
operator|=
literal|0
expr_stmt|;
name|N_PUTVEC
argument_list|(
name|R_ES
argument_list|,
name|R_DX
argument_list|,
name|vec
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x1a
case|:
comment|/* set mouse sensitivity */
name|mouse_status
operator|.
name|hmickey
operator|=
name|R_BX
expr_stmt|;
name|mouse_status
operator|.
name|vmickey
operator|=
name|R_CX
expr_stmt|;
name|mouse_status
operator|.
name|doubling
operator|=
name|R_DX
expr_stmt|;
break|break;
case|case
literal|0x1b
case|:
comment|/* set mouse sensitivity */
name|R_BX
operator|=
name|mouse_status
operator|.
name|hmickey
expr_stmt|;
name|R_CX
operator|=
name|mouse_status
operator|.
name|vmickey
expr_stmt|;
name|R_DX
operator|=
name|mouse_status
operator|.
name|doubling
expr_stmt|;
break|break;
case|case
literal|0x1c
case|:
comment|/* set mouse hardware rate */
case|case
literal|0x1d
case|:
comment|/* set display page */
break|break;
case|case
literal|0x1e
case|:
comment|/* get display page */
name|R_BX
operator|=
literal|0
expr_stmt|;
comment|/* Always on display page 0 */
break|break;
case|case
literal|0x1f
case|:
comment|/* Disable mouse driver */
if|if
condition|(
name|mouse_status
operator|.
name|installed
condition|)
block|{
name|N_PUTVEC
argument_list|(
name|R_ES
argument_list|,
name|R_DX
argument_list|,
name|mouse_status
operator|.
name|handler
argument_list|)
expr_stmt|;
name|mouse_status
operator|.
name|installed
operator|=
literal|0
expr_stmt|;
block|}
else|else
block|{
name|R_AX
operator|=
literal|0xffff
expr_stmt|;
block|}
break|break;
case|case
literal|0x20
case|:
comment|/* Enable mouse driver */
name|mouse_status
operator|.
name|installed
operator|=
literal|1
expr_stmt|;
break|break;
case|case
literal|0x21
case|:
comment|/* Reset mouse driver */
if|if
condition|(
name|mouse_status
operator|.
name|installed
condition|)
block|{
name|mouse_status
operator|.
name|show
operator|=
literal|0
expr_stmt|;
name|mouse_status
operator|.
name|handler
operator|=
literal|0
expr_stmt|;
name|mouse_status
operator|.
name|mask
operator|=
literal|0
expr_stmt|;
name|mouse_status
operator|.
name|cursor
operator|=
literal|0
expr_stmt|;
block|}
else|else
block|{
name|R_AX
operator|=
literal|0xffff
expr_stmt|;
block|}
break|break;
case|case
literal|0x22
case|:
comment|/* Specified language for mouse messages */
break|break;
case|case
literal|0x23
case|:
comment|/* Get language number */
name|R_BX
operator|=
literal|0
expr_stmt|;
comment|/* Always return english */
break|break;
case|case
literal|0x24
case|:
comment|/* Get mouse type */
name|R_CX
operator|=
literal|0x0400
expr_stmt|;
comment|/* PS/2 style mouse */
name|R_BX
operator|=
literal|0x0600
operator|+
literal|24
expr_stmt|;
comment|/* Version 6.24 */
break|break;
default|default:
name|R_FLAGS
operator||=
name|PSL_C
expr_stmt|;
break|break;
block|}
block|}
end_function

begin_function
name|void
name|mouse_init
parameter_list|(
name|void
parameter_list|)
block|{
name|u_long
name|vec
decl_stmt|;
name|vec
operator|=
name|insert_softint_trampoline
argument_list|()
expr_stmt|;
name|ivec
index|[
literal|0x33
index|]
operator|=
name|vec
expr_stmt|;
name|register_callback
argument_list|(
name|vec
argument_list|,
name|int33
argument_list|,
literal|"int 33"
argument_list|)
expr_stmt|;
name|mouse_area
index|[
literal|1
index|]
operator|=
literal|24
expr_stmt|;
block|}
end_function

end_unit


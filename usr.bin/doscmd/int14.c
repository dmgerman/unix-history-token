begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Copyright (c) 1992, 1993, 1996  *	Berkeley Software Design, Inc.  All rights reserved.  *  * This code is derived from software contributed to Berkeley Software  * Design, Inc. by Mark Linoman.  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions  * are met:  * 1. Redistributions of source code must retain the above copyright  *    notice, this list of conditions and the following disclaimer.  * 2. Redistributions in binary form must reproduce the above copyright  *    notice, this list of conditions and the following disclaimer in the  *    documentation and/or other materials provided with the distribution.  * 3. All advertising materials mentioning features or use of this software  *    must display the following acknowledgement:  *	This product includes software developed by Berkeley Software  *	Design, Inc.  *  * THIS SOFTWARE IS PROVIDED BY Berkeley Software Design, Inc. ``AS IS'' AND  * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE  * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE  * ARE DISCLAIMED.  IN NO EVENT SHALL Berkeley Software Design, Inc. BE LIABLE  * FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL  * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS  * OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)  * HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT  * LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY  * OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF  * SUCH DAMAGE.  *  *	BSDI int14.c,v 2.2 1996/04/08 19:32:45 bostic Exp  */
end_comment

begin_include
include|#
directive|include
file|<sys/cdefs.h>
end_include

begin_expr_stmt
name|__FBSDID
argument_list|(
literal|"$FreeBSD$"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_include
include|#
directive|include
file|<sys/ioctl.h>
end_include

begin_include
include|#
directive|include
file|<sys/types.h>
end_include

begin_include
include|#
directive|include
file|<sys/uio.h>
end_include

begin_include
include|#
directive|include
file|<termios.h>
end_include

begin_include
include|#
directive|include
file|<unistd.h>
end_include

begin_include
include|#
directive|include
file|"doscmd.h"
end_include

begin_include
include|#
directive|include
file|"AsyncIO.h"
end_include

begin_include
include|#
directive|include
file|"com.h"
end_include

begin_define
define|#
directive|define
name|N_BYTES
value|1024
end_define

begin_struct
struct|struct
name|com_data_struct
block|{
name|int
name|fd
decl_stmt|;
comment|/* BSD/386 file descriptor */
name|char
modifier|*
name|path
decl_stmt|;
comment|/* BSD/386 pathname */
name|int
name|addr
decl_stmt|;
comment|/* ISA I/O address */
name|unsigned
name|char
name|irq
decl_stmt|;
comment|/* ISA IRQ */
name|unsigned
name|char
name|inbuf
index|[
name|N_BYTES
index|]
decl_stmt|;
comment|/* input buffer */
name|unsigned
name|char
name|outbuf
index|[
name|N_BYTES
index|]
decl_stmt|;
comment|/* output buffer */
name|int
name|ids
decl_stmt|;
comment|/* input data size */
name|int
name|ods
decl_stmt|;
comment|/* output data size */
name|int
name|emptyint
decl_stmt|;
name|struct
name|termios
name|tty
decl_stmt|;
name|unsigned
name|char
name|div_latch
index|[
literal|2
index|]
decl_stmt|;
comment|/* mirror of 16550 R0':R1' 					   read/write */
name|unsigned
name|char
name|int_enable
decl_stmt|;
comment|/* mirror of 16550 R1 read/write */
name|unsigned
name|char
name|fifo_ctrl
decl_stmt|;
comment|/* mirror of 16550 R2 write only */
name|unsigned
name|char
name|line_ctrl
decl_stmt|;
comment|/* mirror of 16550 R3 read/write */
name|unsigned
name|char
name|modem_ctrl
decl_stmt|;
comment|/* mirror of 16550 R4 read/write */
name|unsigned
name|char
name|modem_stat
decl_stmt|;
comment|/* mirror of 16550 R6 read/write */
name|unsigned
name|char
name|uart_spare
decl_stmt|;
comment|/* mirror of 16550 R7 read/write */
block|}
struct|;
end_struct

begin_define
define|#
directive|define
name|DIV_LATCH_LOW
value|0
end_define

begin_define
define|#
directive|define
name|DIV_LATCH_HIGH
value|1
end_define

begin_decl_stmt
name|struct
name|com_data_struct
name|com_data
index|[
name|N_COMS_MAX
index|]
decl_stmt|;
end_decl_stmt

begin_function_decl
specifier|static
name|unsigned
name|char
name|com_port_in
parameter_list|(
name|int
name|port
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|com_port_out
parameter_list|(
name|int
name|port
parameter_list|,
name|unsigned
name|char
name|val
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|com_set_line
parameter_list|(
name|struct
name|com_data_struct
modifier|*
name|cdsp
parameter_list|,
name|unsigned
name|char
name|port
parameter_list|,
name|unsigned
name|char
name|param
parameter_list|)
function_decl|;
end_function_decl

begin_function
specifier|static
name|void
name|manage_int
parameter_list|(
name|struct
name|com_data_struct
modifier|*
name|cdsp
parameter_list|)
block|{
if|if
condition|(
operator|(
name|cdsp
operator|->
name|int_enable
operator|&
name|IE_RCV_DATA
operator|)
operator|&&
name|cdsp
operator|->
name|ids
operator|>
literal|0
condition|)
block|{
name|hardint
argument_list|(
name|cdsp
operator|->
name|irq
argument_list|)
expr_stmt|;
name|debug
argument_list|(
name|D_PORT
argument_list|,
literal|"manage_int: hardint rd\n"
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
operator|(
name|cdsp
operator|->
name|int_enable
operator|&
name|IE_TRANS_HLD
operator|)
operator|&&
name|cdsp
operator|->
name|emptyint
condition|)
block|{
name|hardint
argument_list|(
name|cdsp
operator|->
name|irq
argument_list|)
expr_stmt|;
name|debug
argument_list|(
name|D_PORT
argument_list|,
literal|"manage_int: hardint wr\n"
argument_list|)
expr_stmt|;
return|return;
block|}
name|unpend
argument_list|(
name|cdsp
operator|->
name|irq
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|has_enough_data
parameter_list|(
name|struct
name|com_data_struct
modifier|*
name|cdsp
parameter_list|)
block|{
switch|switch
condition|(
name|cdsp
operator|->
name|fifo_ctrl
operator|&
operator|(
name|FC_FIFO_EN
operator||
name|FC_FIFO_SZ_MASK
operator|)
condition|)
block|{
case|case
name|FC_FIFO_EN
operator||
name|FC_FIFO_4B
case|:
return|return
name|cdsp
operator|->
name|ids
operator|>=
literal|4
return|;
case|case
name|FC_FIFO_EN
operator||
name|FC_FIFO_8B
case|:
return|return
name|cdsp
operator|->
name|ids
operator|>=
literal|8
return|;
case|case
name|FC_FIFO_EN
operator||
name|FC_FIFO_14B
case|:
return|return
name|cdsp
operator|->
name|ids
operator|>=
literal|14
return|;
block|}
return|return
name|cdsp
operator|->
name|ids
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|input
parameter_list|(
name|struct
name|com_data_struct
modifier|*
name|cdsp
parameter_list|,
name|int
name|force_read
parameter_list|)
block|{
name|int
name|nbytes
decl_stmt|;
if|if
condition|(
name|cdsp
operator|->
name|ids
operator|<
name|N_BYTES
operator|&&
operator|(
name|force_read
operator|||
operator|!
name|has_enough_data
argument_list|(
name|cdsp
argument_list|)
operator|)
condition|)
block|{
name|nbytes
operator|=
name|read
argument_list|(
name|cdsp
operator|->
name|fd
argument_list|,
operator|&
name|cdsp
operator|->
name|inbuf
index|[
name|cdsp
operator|->
name|ids
index|]
argument_list|,
name|N_BYTES
operator|-
name|cdsp
operator|->
name|ids
argument_list|)
expr_stmt|;
name|debug
argument_list|(
name|D_PORT
argument_list|,
literal|"read of fd %d on '%s' returned %d (%s)\n"
argument_list|,
name|cdsp
operator|->
name|fd
argument_list|,
name|cdsp
operator|->
name|path
argument_list|,
name|nbytes
argument_list|,
name|nbytes
operator|==
operator|-
literal|1
condition|?
name|strerror
argument_list|(
name|errno
argument_list|)
else|:
literal|""
argument_list|)
expr_stmt|;
if|if
condition|(
name|nbytes
operator|!=
operator|-
literal|1
condition|)
name|cdsp
operator|->
name|ids
operator|+=
name|nbytes
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|output
parameter_list|(
name|struct
name|com_data_struct
modifier|*
name|cdsp
parameter_list|)
block|{
name|int
name|nbytes
decl_stmt|;
if|if
condition|(
name|cdsp
operator|->
name|ods
operator|>
literal|0
condition|)
block|{
name|nbytes
operator|=
name|write
argument_list|(
name|cdsp
operator|->
name|fd
argument_list|,
operator|&
name|cdsp
operator|->
name|outbuf
index|[
literal|0
index|]
argument_list|,
name|cdsp
operator|->
name|ods
argument_list|)
expr_stmt|;
name|debug
argument_list|(
name|D_PORT
argument_list|,
literal|"write of fd %d on '%s' returned %d (%s)\n"
argument_list|,
name|cdsp
operator|->
name|fd
argument_list|,
name|cdsp
operator|->
name|path
argument_list|,
name|nbytes
argument_list|,
name|nbytes
operator|==
operator|-
literal|1
condition|?
name|strerror
argument_list|(
name|errno
argument_list|)
else|:
literal|""
argument_list|)
expr_stmt|;
if|if
condition|(
name|nbytes
operator|!=
operator|-
literal|1
condition|)
block|{
name|cdsp
operator|->
name|ods
operator|-=
name|nbytes
expr_stmt|;
name|memmove
argument_list|(
operator|&
name|cdsp
operator|->
name|outbuf
index|[
literal|0
index|]
argument_list|,
operator|&
name|cdsp
operator|->
name|outbuf
index|[
name|nbytes
index|]
argument_list|,
name|cdsp
operator|->
name|ods
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|cdsp
operator|->
name|int_enable
operator|&
name|IE_TRANS_HLD
operator|)
operator|&&
name|cdsp
operator|->
name|ods
operator|==
literal|0
condition|)
name|cdsp
operator|->
name|emptyint
operator|=
literal|1
expr_stmt|;
block|}
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|flush_out
parameter_list|(
name|void
modifier|*
name|arg
parameter_list|)
block|{
name|struct
name|com_data_struct
modifier|*
name|cdsp
init|=
operator|(
expr|struct
name|com_data_struct
operator|*
operator|)
name|arg
decl_stmt|;
name|output
argument_list|(
name|cdsp
argument_list|)
expr_stmt|;
name|manage_int
argument_list|(
name|cdsp
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  *  We postponed flush till the end of interrupt processing  *   (see int.c).  */
end_comment

begin_function
specifier|static
name|int
name|write_char
parameter_list|(
name|struct
name|com_data_struct
modifier|*
name|cdsp
parameter_list|,
name|char
name|c
parameter_list|)
block|{
name|int
name|r
init|=
literal|0
decl_stmt|;
name|cdsp
operator|->
name|emptyint
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|cdsp
operator|->
name|ods
operator|>=
name|N_BYTES
condition|)
name|output
argument_list|(
name|cdsp
argument_list|)
expr_stmt|;
if|if
condition|(
name|cdsp
operator|->
name|ods
operator|<
name|N_BYTES
condition|)
block|{
name|cdsp
operator|->
name|outbuf
index|[
name|cdsp
operator|->
name|ods
operator|++
index|]
operator|=
name|c
expr_stmt|;
if|if
condition|(
operator|!
name|isinhardint
argument_list|(
name|cdsp
operator|->
name|irq
argument_list|)
condition|)
name|output
argument_list|(
name|cdsp
argument_list|)
expr_stmt|;
name|r
operator|=
literal|1
expr_stmt|;
block|}
name|manage_int
argument_list|(
name|cdsp
argument_list|)
expr_stmt|;
return|return
name|r
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|read_char
parameter_list|(
name|struct
name|com_data_struct
modifier|*
name|cdsp
parameter_list|)
block|{
name|int
name|c
init|=
operator|-
literal|1
decl_stmt|;
name|input
argument_list|(
name|cdsp
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|cdsp
operator|->
name|ids
operator|>
literal|0
condition|)
block|{
name|c
operator|=
name|cdsp
operator|->
name|inbuf
index|[
literal|0
index|]
expr_stmt|;
name|cdsp
operator|->
name|ids
operator|--
expr_stmt|;
name|memmove
argument_list|(
operator|&
name|cdsp
operator|->
name|inbuf
index|[
literal|0
index|]
argument_list|,
operator|&
name|cdsp
operator|->
name|inbuf
index|[
literal|1
index|]
argument_list|,
name|cdsp
operator|->
name|ids
argument_list|)
expr_stmt|;
block|}
name|manage_int
argument_list|(
name|cdsp
argument_list|)
expr_stmt|;
name|debug
argument_list|(
name|D_PORT
argument_list|,
literal|"read_char: %x\n"
argument_list|,
name|c
argument_list|)
expr_stmt|;
return|return
name|c
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|new_ii
parameter_list|(
name|struct
name|com_data_struct
modifier|*
name|cdsp
parameter_list|)
block|{
if|if
condition|(
operator|(
name|cdsp
operator|->
name|int_enable
operator|&
name|IE_TRANS_HLD
operator|)
operator|&&
name|cdsp
operator|->
name|ods
operator|==
literal|0
condition|)
name|cdsp
operator|->
name|emptyint
operator|=
literal|1
expr_stmt|;
name|manage_int
argument_list|(
name|cdsp
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|unsigned
name|char
name|get_status
parameter_list|(
name|struct
name|com_data_struct
modifier|*
name|cdsp
parameter_list|)
block|{
name|unsigned
name|char
name|s
init|=
operator|(
name|LS_X_DATA_E
operator||
name|LS_X_HOLD_E
operator|)
decl_stmt|;
if|if
condition|(
name|cdsp
operator|->
name|ids
operator|>
literal|0
condition|)
name|s
operator||=
name|LS_RCV_DATA_RD
expr_stmt|;
if|if
condition|(
name|cdsp
operator|->
name|ods
operator|>
literal|0
condition|)
block|{
name|s
operator|&=
operator|~
name|LS_X_DATA_E
expr_stmt|;
if|if
condition|(
name|cdsp
operator|->
name|ods
operator|>=
name|N_BYTES
condition|)
name|s
operator|&=
operator|~
name|LS_X_HOLD_E
expr_stmt|;
block|}
name|debug
argument_list|(
name|D_PORT
argument_list|,
literal|"get_status: %x\n"
argument_list|,
operator|(
name|unsigned
operator|)
name|s
argument_list|)
expr_stmt|;
return|return
name|s
return|;
block|}
end_function

begin_function
specifier|static
name|unsigned
name|char
name|get_int_id
parameter_list|(
name|struct
name|com_data_struct
modifier|*
name|cdsp
parameter_list|)
block|{
name|unsigned
name|char
name|s
init|=
name|II_PEND_INT
decl_stmt|;
if|if
condition|(
name|cdsp
operator|->
name|fifo_ctrl
operator|&
name|FC_FIFO_EN
condition|)
name|s
operator||=
name|II_FIFOS_EN
expr_stmt|;
if|if
condition|(
operator|(
name|cdsp
operator|->
name|int_enable
operator|&
name|IE_RCV_DATA
operator|)
operator|&&
name|cdsp
operator|->
name|ids
operator|>
literal|0
condition|)
block|{
if|if
condition|(
name|has_enough_data
argument_list|(
name|cdsp
argument_list|)
condition|)
name|s
operator|=
operator|(
name|s
operator|&
operator|~
name|II_PEND_INT
operator|)
operator||
name|II_RCV_DATA
expr_stmt|;
else|else
name|s
operator|=
operator|(
name|s
operator|&
operator|~
name|II_PEND_INT
operator|)
operator||
name|II_TO
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|(
name|cdsp
operator|->
name|int_enable
operator|&
name|IE_TRANS_HLD
operator|)
operator|&&
name|cdsp
operator|->
name|emptyint
condition|)
block|{
name|cdsp
operator|->
name|emptyint
operator|=
literal|0
expr_stmt|;
name|s
operator|=
operator|(
name|s
operator|&
operator|~
name|II_PEND_INT
operator|)
operator||
name|II_TRANS_HLD
expr_stmt|;
block|}
name|debug
argument_list|(
name|D_PORT
argument_list|,
literal|"get_int_id: %x\n"
argument_list|,
operator|(
name|unsigned
operator|)
name|s
argument_list|)
expr_stmt|;
return|return
name|s
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|com_async
parameter_list|(
name|int
name|fd
name|__unused
parameter_list|,
name|int
name|cond
parameter_list|,
name|void
modifier|*
name|arg
parameter_list|,
name|regcontext_t
modifier|*
name|REGS
name|__unused
parameter_list|)
block|{
name|struct
name|com_data_struct
modifier|*
name|cdsp
init|=
operator|(
expr|struct
name|com_data_struct
operator|*
operator|)
name|arg
decl_stmt|;
name|debug
argument_list|(
name|D_PORT
argument_list|,
literal|"com_async: %X.\n"
argument_list|,
name|cond
argument_list|)
expr_stmt|;
if|if
condition|(
name|cond
operator|&
name|AS_RD
condition|)
name|input
argument_list|(
name|cdsp
argument_list|,
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|cond
operator|&
name|AS_WR
condition|)
name|output
argument_list|(
name|cdsp
argument_list|)
expr_stmt|;
name|manage_int
argument_list|(
name|cdsp
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|int14
parameter_list|(
name|regcontext_t
modifier|*
name|REGS
parameter_list|)
block|{
name|struct
name|com_data_struct
modifier|*
name|cdsp
decl_stmt|;
name|int
name|i
decl_stmt|;
name|debug
argument_list|(
name|D_PORT
argument_list|,
literal|"int14: dl = 0x%02X, al = 0x%02X.\n"
argument_list|,
name|R_DL
argument_list|,
name|R_AL
argument_list|)
expr_stmt|;
if|if
condition|(
name|R_DL
operator|>=
name|N_COMS_MAX
condition|)
block|{
if|if
condition|(
name|vflag
condition|)
name|dump_regs
argument_list|(
name|REGS
argument_list|)
expr_stmt|;
name|fatal
argument_list|(
literal|"int14: illegal com port COM%d"
argument_list|,
name|R_DL
operator|+
literal|1
argument_list|)
expr_stmt|;
block|}
name|cdsp
operator|=
operator|&
operator|(
name|com_data
index|[
name|R_DL
index|]
operator|)
expr_stmt|;
switch|switch
condition|(
name|R_AH
condition|)
block|{
case|case
literal|0x00
case|:
comment|/* Initialize Serial Port */
name|com_set_line
argument_list|(
name|cdsp
argument_list|,
name|R_DL
operator|+
literal|1
argument_list|,
name|R_AL
argument_list|)
expr_stmt|;
name|R_AH
operator|=
name|get_status
argument_list|(
name|cdsp
argument_list|)
expr_stmt|;
name|R_AL
operator|=
literal|0
expr_stmt|;
break|break;
case|case
literal|0x01
case|:
comment|/* Write Character */
if|if
condition|(
name|write_char
argument_list|(
name|cdsp
argument_list|,
name|R_AL
argument_list|)
condition|)
block|{
name|R_AH
operator|=
name|get_status
argument_list|(
name|cdsp
argument_list|)
expr_stmt|;
name|R_AL
operator|=
literal|0
expr_stmt|;
block|}
else|else
block|{
name|debug
argument_list|(
name|D_PORT
argument_list|,
literal|"int14: lost output character 0x%02x\n"
argument_list|,
name|R_AL
argument_list|)
expr_stmt|;
name|R_AH
operator|=
name|LS_SW_TIME_OUT
expr_stmt|;
name|R_AL
operator|=
literal|0
expr_stmt|;
block|}
break|break;
case|case
literal|0x02
case|:
comment|/* Read Character */
name|i
operator|=
name|read_char
argument_list|(
name|cdsp
argument_list|)
expr_stmt|;
if|if
condition|(
name|i
operator|!=
operator|-
literal|1
condition|)
block|{
name|R_AH
operator|=
name|get_status
argument_list|(
name|cdsp
argument_list|)
expr_stmt|;
name|R_AL
operator|=
operator|(
name|char
operator|)
name|i
expr_stmt|;
block|}
else|else
block|{
name|R_AH
operator|=
name|LS_SW_TIME_OUT
expr_stmt|;
name|R_AL
operator|=
literal|0x60
expr_stmt|;
block|}
break|break;
case|case
literal|0x03
case|:
comment|/* Status Request */
name|R_AH
operator|=
name|get_status
argument_list|(
name|cdsp
argument_list|)
expr_stmt|;
name|R_AL
operator|=
literal|0
expr_stmt|;
break|break;
case|case
literal|0x04
case|:
comment|/* Extended Initialization */
name|R_AX
operator|=
operator|(
name|LS_SW_TIME_OUT
operator|)
operator|<<
literal|8
expr_stmt|;
break|break;
case|case
literal|0x05
case|:
comment|/* Modem Control Register operations */
switch|switch
condition|(
name|R_AH
condition|)
block|{
case|case
literal|0x00
case|:
comment|/* Read Modem Control Register */
name|R_AX
operator|=
operator|(
name|LS_SW_TIME_OUT
operator|)
operator|<<
literal|8
expr_stmt|;
break|break;
case|case
literal|0x01
case|:
comment|/* Write Modem Control Register */
name|R_AX
operator|=
operator|(
name|LS_SW_TIME_OUT
operator|)
operator|<<
literal|8
expr_stmt|;
break|break;
default|default:
name|unknown_int3
argument_list|(
literal|0x14
argument_list|,
literal|0x05
argument_list|,
name|R_AL
argument_list|,
name|REGS
argument_list|)
expr_stmt|;
break|break;
block|}
break|break;
default|default:
name|unknown_int2
argument_list|(
literal|0x14
argument_list|,
name|R_AH
argument_list|,
name|REGS
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
end_function

begin_comment
comment|/* called when doscmd initializes a single line */
end_comment

begin_function
specifier|static
name|void
name|com_set_line
parameter_list|(
name|struct
name|com_data_struct
modifier|*
name|cdsp
parameter_list|,
name|unsigned
name|char
name|port
parameter_list|,
name|unsigned
name|char
name|param
parameter_list|)
block|{
name|struct
name|stat
name|stat_buf
decl_stmt|;
name|int
name|mode
init|=
literal|0
decl_stmt|;
comment|/* read | write */
name|int
name|reg_num
decl_stmt|,
name|ret_val
decl_stmt|,
name|spd
decl_stmt|,
name|speed
decl_stmt|;
name|u_int8_t
name|div_hi
decl_stmt|,
name|div_lo
decl_stmt|;
name|debug
argument_list|(
name|D_PORT
argument_list|,
literal|"com_set_line: cdsp = %8p, port = 0x%04x,"
literal|"param = 0x%04X.\n"
argument_list|,
name|cdsp
argument_list|,
name|port
argument_list|,
name|param
argument_list|)
expr_stmt|;
if|if
condition|(
name|cdsp
operator|->
name|fd
operator|>
literal|0
condition|)
block|{
name|debug
argument_list|(
name|D_PORT
argument_list|,
literal|"Re-initialize serial port com%d\n"
argument_list|,
name|port
argument_list|)
expr_stmt|;
name|_RegisterIO
argument_list|(
name|cdsp
operator|->
name|fd
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|close
argument_list|(
name|cdsp
operator|->
name|fd
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|debug
argument_list|(
name|D_PORT
argument_list|,
literal|"Initialize serial port com%d\n"
argument_list|,
name|port
argument_list|)
expr_stmt|;
block|}
name|stat
argument_list|(
name|cdsp
operator|->
name|path
argument_list|,
operator|&
name|stat_buf
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|S_ISCHR
argument_list|(
name|stat_buf
operator|.
name|st_mode
argument_list|)
operator|||
operator|(
operator|(
name|cdsp
operator|->
name|fd
operator|=
name|open
argument_list|(
name|cdsp
operator|->
name|path
argument_list|,
name|O_RDWR
operator||
name|O_NONBLOCK
argument_list|,
literal|0666
argument_list|)
operator|)
operator|==
operator|-
literal|1
operator|)
condition|)
block|{
name|debug
argument_list|(
name|D_PORT
argument_list|,
literal|"Could not initialize serial port com%d on path '%s'\n"
argument_list|,
name|port
argument_list|,
name|cdsp
operator|->
name|path
argument_list|)
expr_stmt|;
return|return;
block|}
name|cdsp
operator|->
name|ids
operator|=
name|cdsp
operator|->
name|ods
operator|=
name|cdsp
operator|->
name|emptyint
operator|=
literal|0
expr_stmt|;
name|cdsp
operator|->
name|int_enable
operator|=
literal|0
expr_stmt|;
name|cdsp
operator|->
name|fifo_ctrl
operator|=
literal|0
expr_stmt|;
name|cdsp
operator|->
name|modem_ctrl
operator|=
literal|0
expr_stmt|;
name|cdsp
operator|->
name|modem_stat
operator|=
literal|0
expr_stmt|;
name|cdsp
operator|->
name|uart_spare
operator|=
literal|0
expr_stmt|;
if|if
condition|(
operator|(
name|param
operator|&
name|PARITY_EVEN
operator|)
operator|==
name|PARITY_NONE
condition|)
name|cdsp
operator|->
name|tty
operator|.
name|c_iflag
operator|=
name|IGNBRK
operator||
name|IGNPAR
comment|/* | IXON | IXOFF | IXANY */
expr_stmt|;
else|else
name|cdsp
operator|->
name|tty
operator|.
name|c_iflag
operator|=
name|IGNBRK
comment|/* | IXON | IXOFF | IXANY */
expr_stmt|;
name|cdsp
operator|->
name|tty
operator|.
name|c_oflag
operator|=
literal|0
expr_stmt|;
name|cdsp
operator|->
name|tty
operator|.
name|c_lflag
operator|=
literal|0
expr_stmt|;
name|cdsp
operator|->
name|tty
operator|.
name|c_cc
index|[
name|VTIME
index|]
operator|=
literal|0
expr_stmt|;
name|cdsp
operator|->
name|tty
operator|.
name|c_cc
index|[
name|VMIN
index|]
operator|=
literal|0
expr_stmt|;
name|cdsp
operator|->
name|tty
operator|.
name|c_cflag
operator|=
name|CREAD
operator||
name|CLOCAL
operator||
name|HUPCL
expr_stmt|;
comment|/* MCL WHY CLOCAL ??????; but, gets errno EIO on writes, else */
if|if
condition|(
operator|(
name|param
operator|&
name|TXLEN_8BITS
operator|)
operator|==
name|TXLEN_8BITS
condition|)
block|{
name|cdsp
operator|->
name|tty
operator|.
name|c_cflag
operator||=
name|CS8
expr_stmt|;
name|cdsp
operator|->
name|line_ctrl
operator||=
literal|3
expr_stmt|;
block|}
else|else
block|{
name|cdsp
operator|->
name|tty
operator|.
name|c_cflag
operator||=
name|CS7
expr_stmt|;
name|cdsp
operator|->
name|line_ctrl
operator||=
literal|2
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|param
operator|&
name|STOPBIT_2
operator|)
operator|==
name|STOPBIT_2
condition|)
block|{
name|cdsp
operator|->
name|tty
operator|.
name|c_cflag
operator||=
name|CSTOPB
expr_stmt|;
name|cdsp
operator|->
name|line_ctrl
operator||=
name|LC_STOP_B
expr_stmt|;
block|}
else|else
block|{
name|cdsp
operator|->
name|tty
operator|.
name|c_cflag
operator|&=
operator|~
name|CSTOPB
expr_stmt|;
name|cdsp
operator|->
name|line_ctrl
operator|&=
operator|~
name|LC_STOP_B
expr_stmt|;
block|}
switch|switch
condition|(
name|param
operator|&
name|PARITY_EVEN
condition|)
block|{
case|case
name|PARITY_ODD
case|:
name|cdsp
operator|->
name|tty
operator|.
name|c_cflag
operator||=
operator|(
name|PARENB
operator||
name|PARODD
operator|)
expr_stmt|;
name|cdsp
operator|->
name|line_ctrl
operator|&=
operator|~
name|LC_EVEN_P
expr_stmt|;
name|cdsp
operator|->
name|line_ctrl
operator||=
name|LC_PAR_E
expr_stmt|;
break|break;
case|case
name|PARITY_EVEN
case|:
name|cdsp
operator|->
name|tty
operator|.
name|c_cflag
operator||=
name|PARENB
expr_stmt|;
name|cdsp
operator|->
name|line_ctrl
operator||=
name|LC_EVEN_P
operator||
name|LC_PAR_E
expr_stmt|;
break|break;
case|case
name|PARITY_NONE
case|:
name|cdsp
operator|->
name|line_ctrl
operator|&=
operator|~
name|LC_PAR_E
expr_stmt|;
default|default:
break|break;
block|}
switch|switch
condition|(
name|param
operator|&
name|BITRATE_9600
condition|)
block|{
case|case
name|BITRATE_110
case|:
name|speed
operator|=
name|B110
expr_stmt|;
name|spd
operator|=
literal|110
expr_stmt|;
break|break;
case|case
name|BITRATE_150
case|:
name|speed
operator|=
name|B150
expr_stmt|;
name|spd
operator|=
literal|150
expr_stmt|;
break|break;
case|case
name|BITRATE_300
case|:
name|speed
operator|=
name|B300
expr_stmt|;
name|spd
operator|=
literal|300
expr_stmt|;
break|break;
case|case
name|BITRATE_600
case|:
name|speed
operator|=
name|B600
expr_stmt|;
name|spd
operator|=
literal|600
expr_stmt|;
break|break;
case|case
name|BITRATE_1200
case|:
name|speed
operator|=
name|B1200
expr_stmt|;
name|spd
operator|=
literal|1200
expr_stmt|;
break|break;
case|case
name|BITRATE_2400
case|:
name|speed
operator|=
name|B2400
expr_stmt|;
name|spd
operator|=
literal|2400
expr_stmt|;
break|break;
case|case
name|BITRATE_4800
case|:
name|speed
operator|=
name|B4800
expr_stmt|;
name|spd
operator|=
literal|4800
expr_stmt|;
break|break;
case|case
name|BITRATE_9600
case|:
name|speed
operator|=
name|B9600
expr_stmt|;
name|spd
operator|=
literal|9600
expr_stmt|;
break|break;
block|}
name|debug
argument_list|(
name|D_PORT
argument_list|,
literal|"com_set_line: going with cflag 0x%X iflag 0x%X speed %d.\n"
argument_list|,
name|cdsp
operator|->
name|tty
operator|.
name|c_cflag
argument_list|,
name|cdsp
operator|->
name|tty
operator|.
name|c_iflag
argument_list|,
name|speed
argument_list|)
expr_stmt|;
name|div_lo
operator|=
operator|(
literal|115200
operator|/
name|spd
operator|)
operator|&
literal|0x00ff
expr_stmt|;
name|div_hi
operator|=
operator|(
literal|115200
operator|/
name|spd
operator|)
operator|&
literal|0xff00
expr_stmt|;
name|cdsp
operator|->
name|div_latch
index|[
name|DIV_LATCH_LOW
index|]
operator|=
name|div_lo
expr_stmt|;
name|cdsp
operator|->
name|div_latch
index|[
name|DIV_LATCH_HIGH
index|]
operator|=
name|div_hi
expr_stmt|;
name|errno
operator|=
literal|0
expr_stmt|;
name|ret_val
operator|=
name|cfsetispeed
argument_list|(
operator|&
name|cdsp
operator|->
name|tty
argument_list|,
name|speed
argument_list|)
expr_stmt|;
name|debug
argument_list|(
name|D_PORT
argument_list|,
literal|"com_set_line: cfsetispeed returned 0x%X.\n"
argument_list|,
name|ret_val
argument_list|)
expr_stmt|;
name|errno
operator|=
literal|0
expr_stmt|;
name|ret_val
operator|=
name|cfsetospeed
argument_list|(
operator|&
name|cdsp
operator|->
name|tty
argument_list|,
name|speed
argument_list|)
expr_stmt|;
name|debug
argument_list|(
name|D_PORT
argument_list|,
literal|"com_set_line: cfsetospeed returned 0x%X.\n"
argument_list|,
name|ret_val
argument_list|)
expr_stmt|;
name|errno
operator|=
literal|0
expr_stmt|;
name|ret_val
operator|=
name|tcsetattr
argument_list|(
name|cdsp
operator|->
name|fd
argument_list|,
literal|0
argument_list|,
operator|&
name|cdsp
operator|->
name|tty
argument_list|)
expr_stmt|;
name|debug
argument_list|(
name|D_PORT
argument_list|,
literal|"com_set_line: tcsetattr returned 0x%X (%s).\n"
argument_list|,
name|ret_val
argument_list|,
name|ret_val
operator|==
operator|-
literal|1
condition|?
name|strerror
argument_list|(
name|errno
argument_list|)
else|:
literal|""
argument_list|)
expr_stmt|;
name|errno
operator|=
literal|0
expr_stmt|;
name|ret_val
operator|=
name|fcntl
argument_list|(
name|cdsp
operator|->
name|fd
argument_list|,
name|F_SETFL
argument_list|,
name|O_NDELAY
argument_list|)
expr_stmt|;
name|debug
argument_list|(
name|D_PORT
argument_list|,
literal|"fcntl of 0x%X, 0x%X to fd %d returned %d errno %d\n"
argument_list|,
name|F_SETFL
argument_list|,
name|O_NDELAY
argument_list|,
name|cdsp
operator|->
name|fd
argument_list|,
name|ret_val
argument_list|,
name|errno
argument_list|)
expr_stmt|;
name|errno
operator|=
literal|0
expr_stmt|;
name|ret_val
operator|=
name|ioctl
argument_list|(
name|cdsp
operator|->
name|fd
argument_list|,
name|TIOCFLUSH
argument_list|,
operator|&
name|mode
argument_list|)
expr_stmt|;
name|debug
argument_list|(
name|D_PORT
argument_list|,
literal|"ioctl of 0x%02lx to fd %d on 0x%X returned %d errno %d\n"
argument_list|,
name|TIOCFLUSH
argument_list|,
name|cdsp
operator|->
name|fd
argument_list|,
name|mode
argument_list|,
name|ret_val
argument_list|,
name|errno
argument_list|)
expr_stmt|;
for|for
control|(
name|reg_num
operator|=
literal|0
init|;
name|reg_num
operator|<
name|N_OF_COM_REGS
condition|;
name|reg_num
operator|++
control|)
block|{
name|define_input_port_handler
argument_list|(
name|cdsp
operator|->
name|addr
operator|+
name|reg_num
argument_list|,
name|com_port_in
argument_list|)
expr_stmt|;
name|define_output_port_handler
argument_list|(
name|cdsp
operator|->
name|addr
operator|+
name|reg_num
argument_list|,
name|com_port_out
argument_list|)
expr_stmt|;
block|}
name|debug
argument_list|(
name|D_PORT
argument_list|,
literal|"com%d: attached '%s' at addr 0x%04x irq %d\n"
argument_list|,
name|port
argument_list|,
name|cdsp
operator|->
name|path
argument_list|,
name|cdsp
operator|->
name|addr
argument_list|,
name|cdsp
operator|->
name|irq
argument_list|)
expr_stmt|;
name|set_eoir
argument_list|(
name|cdsp
operator|->
name|irq
argument_list|,
name|flush_out
argument_list|,
name|cdsp
argument_list|)
expr_stmt|;
name|_RegisterIO
argument_list|(
name|cdsp
operator|->
name|fd
argument_list|,
name|com_async
argument_list|,
name|cdsp
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|try_set_speed
parameter_list|(
name|struct
name|com_data_struct
modifier|*
name|cdsp
parameter_list|)
block|{
name|unsigned
name|divisor
decl_stmt|,
name|speed
decl_stmt|;
name|int
name|ret_val
decl_stmt|;
name|divisor
operator|=
operator|(
name|unsigned
operator|)
name|cdsp
operator|->
name|div_latch
index|[
name|DIV_LATCH_HIGH
index|]
operator|<<
literal|8
operator||
operator|(
name|unsigned
operator|)
name|cdsp
operator|->
name|div_latch
index|[
name|DIV_LATCH_LOW
index|]
expr_stmt|;
name|debug
argument_list|(
name|D_PORT
argument_list|,
literal|"try_set_speed: divisor = %u\n"
argument_list|,
name|divisor
argument_list|)
expr_stmt|;
if|if
condition|(
name|divisor
operator|==
literal|0
condition|)
return|return;
name|speed
operator|=
literal|115200
operator|/
name|divisor
expr_stmt|;
if|if
condition|(
name|speed
operator|==
literal|0
condition|)
return|return;
name|errno
operator|=
literal|0
expr_stmt|;
name|ret_val
operator|=
name|cfsetispeed
argument_list|(
operator|&
name|cdsp
operator|->
name|tty
argument_list|,
name|speed
argument_list|)
expr_stmt|;
name|debug
argument_list|(
name|D_PORT
argument_list|,
literal|"try_set_speed: cfsetispeed returned 0x%X.\n"
argument_list|,
name|ret_val
argument_list|)
expr_stmt|;
name|errno
operator|=
literal|0
expr_stmt|;
name|ret_val
operator|=
name|cfsetospeed
argument_list|(
operator|&
name|cdsp
operator|->
name|tty
argument_list|,
name|speed
argument_list|)
expr_stmt|;
name|debug
argument_list|(
name|D_PORT
argument_list|,
literal|"try_set_speed: cfsetospeed returned 0x%X.\n"
argument_list|,
name|ret_val
argument_list|)
expr_stmt|;
name|errno
operator|=
literal|0
expr_stmt|;
name|ret_val
operator|=
name|tcsetattr
argument_list|(
name|cdsp
operator|->
name|fd
argument_list|,
literal|0
argument_list|,
operator|&
name|cdsp
operator|->
name|tty
argument_list|)
expr_stmt|;
name|debug
argument_list|(
name|D_PORT
argument_list|,
literal|"try_set_speed: tcsetattr returned 0x%X (%s).\n"
argument_list|,
name|ret_val
argument_list|,
name|ret_val
operator|==
operator|-
literal|1
condition|?
name|strerror
argument_list|(
name|errno
argument_list|)
else|:
literal|""
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* called when config.c initializes a single line */
end_comment

begin_function
name|void
name|init_com
parameter_list|(
name|int
name|port
parameter_list|,
name|char
modifier|*
name|path
parameter_list|,
name|int
name|addr
parameter_list|,
name|unsigned
name|char
name|irq
parameter_list|)
block|{
name|struct
name|com_data_struct
modifier|*
name|cdsp
decl_stmt|;
name|debug
argument_list|(
name|D_PORT
argument_list|,
literal|"init_com: port = 0x%04x, addr = 0x%04X, irq = %d.\n"
argument_list|,
name|port
argument_list|,
name|addr
argument_list|,
name|irq
argument_list|)
expr_stmt|;
name|cdsp
operator|=
operator|&
operator|(
name|com_data
index|[
name|port
index|]
operator|)
expr_stmt|;
name|cdsp
operator|->
name|path
operator|=
name|path
expr_stmt|;
comment|/* XXX DEBUG strcpy? */
name|cdsp
operator|->
name|addr
operator|=
name|addr
expr_stmt|;
name|cdsp
operator|->
name|irq
operator|=
name|irq
expr_stmt|;
name|cdsp
operator|->
name|fd
operator|=
operator|-
literal|1
expr_stmt|;
name|com_set_line
argument_list|(
name|cdsp
argument_list|,
name|port
operator|+
literal|1
argument_list|,
name|TXLEN_8BITS
operator||
name|BITRATE_9600
argument_list|)
expr_stmt|;
comment|/* update BIOS variables */
name|nserial
operator|++
expr_stmt|;
operator|*
operator|(
name|u_int16_t
operator|*
operator|)
operator|&
name|BIOSDATA
index|[
literal|0x00
operator|+
literal|2
operator|*
name|port
index|]
operator|=
operator|(
name|u_int16_t
operator|)
name|addr
expr_stmt|;
block|}
end_function

begin_comment
comment|/* called when DOS wants to read directly from a physical port */
end_comment

begin_function
name|unsigned
name|char
name|com_port_in
parameter_list|(
name|int
name|port
parameter_list|)
block|{
name|struct
name|com_data_struct
modifier|*
name|cdsp
decl_stmt|;
name|unsigned
name|char
name|rs
decl_stmt|;
name|unsigned
name|char
name|i
decl_stmt|;
name|int
name|r
decl_stmt|;
comment|/* search for a valid COM ???or MOUSE??? port */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|N_COMS_MAX
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|com_data
index|[
name|i
index|]
operator|.
name|addr
operator|==
operator|(
operator|(
name|unsigned
name|short
operator|)
name|port
operator|&
literal|0xfff8
operator|)
condition|)
block|{
name|cdsp
operator|=
operator|&
operator|(
name|com_data
index|[
name|i
index|]
operator|)
expr_stmt|;
break|break;
block|}
block|}
if|if
condition|(
name|i
operator|==
name|N_COMS_MAX
condition|)
block|{
name|debug
argument_list|(
name|D_PORT
argument_list|,
literal|"com port 0x%04x not found\n"
argument_list|,
name|port
argument_list|)
expr_stmt|;
return|return
literal|0xff
return|;
block|}
switch|switch
condition|(
name|port
operator|-
name|cdsp
operator|->
name|addr
condition|)
block|{
comment|/* 0x03F8 - (receive buffer) or (divisor latch LO) */
case|case
literal|0
case|:
if|if
condition|(
name|cdsp
operator|->
name|line_ctrl
operator|&
name|LC_DIV_ACC
condition|)
name|rs
operator|=
name|cdsp
operator|->
name|div_latch
index|[
name|DIV_LATCH_LOW
index|]
expr_stmt|;
else|else
block|{
name|rs
operator|=
literal|0x60
expr_stmt|;
name|r
operator|=
name|read_char
argument_list|(
name|cdsp
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
operator|!=
operator|-
literal|1
condition|)
name|rs
operator|=
operator|(
name|unsigned
name|char
operator|)
name|r
expr_stmt|;
block|}
break|break;
comment|/* 0x03F9 - (interrupt enable) or (divisor latch HI) */
case|case
literal|1
case|:
if|if
condition|(
name|cdsp
operator|->
name|line_ctrl
operator|&
name|LC_DIV_ACC
condition|)
name|rs
operator|=
name|cdsp
operator|->
name|div_latch
index|[
name|DIV_LATCH_HIGH
index|]
expr_stmt|;
else|else
name|rs
operator|=
name|cdsp
operator|->
name|int_enable
expr_stmt|;
break|break;
comment|/* 0x03FA - interrupt identification register */
case|case
literal|2
case|:
name|rs
operator|=
name|get_int_id
argument_list|(
name|cdsp
argument_list|)
expr_stmt|;
break|break;
comment|/* 0x03FB - line control register */
case|case
literal|3
case|:
name|rs
operator|=
name|cdsp
operator|->
name|line_ctrl
expr_stmt|;
break|break;
comment|/* 0x03FC - modem control register */
case|case
literal|4
case|:
name|rs
operator|=
name|cdsp
operator|->
name|modem_ctrl
expr_stmt|;
break|break;
comment|/* 0x03FD - line status register */
case|case
literal|5
case|:
name|rs
operator|=
name|get_status
argument_list|(
name|cdsp
argument_list|)
expr_stmt|;
break|break;
comment|/* 0x03FE - modem status register */
case|case
literal|6
case|:
name|rs
operator|=
name|cdsp
operator|->
name|modem_stat
operator||
name|MS_DCD
operator||
name|MS_DSR
operator||
name|MS_CTS
expr_stmt|;
break|break;
comment|/* 0x03FF - spare register */
case|case
literal|7
case|:
name|rs
operator|=
name|cdsp
operator|->
name|uart_spare
expr_stmt|;
break|break;
default|default:
name|debug
argument_list|(
name|D_PORT
argument_list|,
literal|"com_port_in: illegal port index 0x%04x - 0x%04x\n"
argument_list|,
name|port
argument_list|,
name|cdsp
operator|->
name|addr
argument_list|)
expr_stmt|;
break|break;
block|}
return|return
name|rs
return|;
block|}
end_function

begin_comment
comment|/* called when DOS wants to write directly to a physical port */
end_comment

begin_function
name|void
name|com_port_out
parameter_list|(
name|int
name|port
parameter_list|,
name|unsigned
name|char
name|val
parameter_list|)
block|{
name|struct
name|com_data_struct
modifier|*
name|cdsp
decl_stmt|;
name|int
name|i
decl_stmt|;
comment|/* search for a valid COM ???or MOUSE??? port */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|N_COMS_MAX
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|com_data
index|[
name|i
index|]
operator|.
name|addr
operator|==
operator|(
operator|(
name|unsigned
name|short
operator|)
name|port
operator|&
literal|0xfff8
operator|)
condition|)
block|{
name|cdsp
operator|=
operator|&
operator|(
name|com_data
index|[
name|i
index|]
operator|)
expr_stmt|;
break|break;
block|}
block|}
if|if
condition|(
name|i
operator|==
name|N_COMS_MAX
condition|)
block|{
name|debug
argument_list|(
name|D_PORT
argument_list|,
literal|"com port 0x%04x not found\n"
argument_list|,
name|port
argument_list|)
expr_stmt|;
return|return;
block|}
switch|switch
condition|(
name|port
operator|-
name|cdsp
operator|->
name|addr
condition|)
block|{
comment|/* 0x03F8 - (transmit buffer) or (divisor latch LO) */
case|case
literal|0
case|:
if|if
condition|(
name|cdsp
operator|->
name|line_ctrl
operator|&
name|LC_DIV_ACC
condition|)
block|{
name|cdsp
operator|->
name|div_latch
index|[
name|DIV_LATCH_LOW
index|]
operator|=
name|val
expr_stmt|;
name|try_set_speed
argument_list|(
name|cdsp
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|write_char
argument_list|(
name|cdsp
argument_list|,
name|val
argument_list|)
expr_stmt|;
block|}
break|break;
comment|/* 0x03F9 - (interrupt enable) or (divisor latch HI) */
case|case
literal|1
case|:
if|if
condition|(
name|cdsp
operator|->
name|line_ctrl
operator|&
name|LC_DIV_ACC
condition|)
block|{
name|cdsp
operator|->
name|div_latch
index|[
name|DIV_LATCH_HIGH
index|]
operator|=
name|val
expr_stmt|;
name|try_set_speed
argument_list|(
name|cdsp
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|cdsp
operator|->
name|int_enable
operator|=
name|val
expr_stmt|;
name|new_ii
argument_list|(
name|cdsp
argument_list|)
expr_stmt|;
block|}
break|break;
comment|/* 0x03FA - FIFO control register */
case|case
literal|2
case|:
name|cdsp
operator|->
name|fifo_ctrl
operator|=
name|val
operator|&
operator|(
name|FC_FIFO_EN
operator||
name|FC_FIFO_SZ_MASK
operator|)
expr_stmt|;
if|if
condition|(
name|val
operator|&
name|FC_FIFO_CRV
condition|)
name|cdsp
operator|->
name|ids
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|val
operator|&
name|FC_FIFO_CTR
condition|)
block|{
name|cdsp
operator|->
name|ods
operator|=
literal|0
expr_stmt|;
name|cdsp
operator|->
name|emptyint
operator|=
literal|1
expr_stmt|;
block|}
name|input
argument_list|(
name|cdsp
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|manage_int
argument_list|(
name|cdsp
argument_list|)
expr_stmt|;
break|break;
comment|/* 0x03FB - line control register */
case|case
literal|3
case|:
name|cdsp
operator|->
name|line_ctrl
operator|=
name|val
expr_stmt|;
break|break;
comment|/* 0x03FC - modem control register */
case|case
literal|4
case|:
name|cdsp
operator|->
name|modem_ctrl
operator|=
name|val
expr_stmt|;
break|break;
comment|/* 0x03FD - line status register */
case|case
literal|5
case|:
comment|/* read-only */
break|break;
comment|/* 0x03FE - modem status register */
case|case
literal|6
case|:
name|cdsp
operator|->
name|modem_stat
operator|=
name|val
expr_stmt|;
break|break;
comment|/* 0x03FF - spare register */
case|case
literal|7
case|:
name|cdsp
operator|->
name|uart_spare
operator|=
name|val
expr_stmt|;
break|break;
default|default:
name|debug
argument_list|(
name|D_PORT
argument_list|,
literal|"com_port_out: illegal port index 0x%04x - 0x%04x\n"
argument_list|,
name|port
argument_list|,
name|cdsp
operator|->
name|addr
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
end_function

end_unit


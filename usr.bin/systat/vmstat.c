begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*-  * Copyright (c) 1983, 1989, 1992, 1993  *	The Regents of the University of California.  All rights reserved.  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions  * are met:  * 1. Redistributions of source code must retain the above copyright  *    notice, this list of conditions and the following disclaimer.  * 2. Redistributions in binary form must reproduce the above copyright  *    notice, this list of conditions and the following disclaimer in the  *    documentation and/or other materials provided with the distribution.  * 3. All advertising materials mentioning features or use of this software  *    must display the following acknowledgement:  *	This product includes software developed by the University of  *	California, Berkeley and its contributors.  * 4. Neither the name of the University nor the names of its contributors  *    may be used to endorse or promote products derived from this software  *    without specific prior written permission.  *  * THIS SOFTWARE IS PROVIDED BY THE REGENTS AND CONTRIBUTORS ``AS IS'' AND  * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE  * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE  * ARE DISCLAIMED.  IN NO EVENT SHALL THE REGENTS OR CONTRIBUTORS BE LIABLE  * FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL  * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS  * OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)  * HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT  * LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY  * OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF  * SUCH DAMAGE.  */
end_comment

begin_ifndef
ifndef|#
directive|ifndef
name|lint
end_ifndef

begin_if
if|#
directive|if
literal|0
end_if

begin_endif
unit|static char sccsid[] = "@(#)vmstat.c	8.2 (Berkeley) 1/12/94";
endif|#
directive|endif
end_endif

begin_decl_stmt
specifier|static
specifier|const
name|char
name|rcsid
index|[]
init|=
literal|"$FreeBSD$"
decl_stmt|;
end_decl_stmt

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* not lint */
end_comment

begin_comment
comment|/*  * Cursed vmstat -- from Robert Elz.  */
end_comment

begin_include
include|#
directive|include
file|<sys/param.h>
end_include

begin_include
include|#
directive|include
file|<sys/stat.h>
end_include

begin_include
include|#
directive|include
file|<sys/time.h>
end_include

begin_include
include|#
directive|include
file|<sys/proc.h>
end_include

begin_include
include|#
directive|include
file|<sys/uio.h>
end_include

begin_include
include|#
directive|include
file|<sys/namei.h>
end_include

begin_include
include|#
directive|include
file|<sys/sysctl.h>
end_include

begin_include
include|#
directive|include
file|<sys/dkstat.h>
end_include

begin_include
include|#
directive|include
file|<sys/vmmeter.h>
end_include

begin_include
include|#
directive|include
file|<vm/vm_param.h>
end_include

begin_include
include|#
directive|include
file|<ctype.h>
end_include

begin_include
include|#
directive|include
file|<err.h>
end_include

begin_include
include|#
directive|include
file|<errno.h>
end_include

begin_include
include|#
directive|include
file|<nlist.h>
end_include

begin_include
include|#
directive|include
file|<paths.h>
end_include

begin_include
include|#
directive|include
file|<signal.h>
end_include

begin_include
include|#
directive|include
file|<stdlib.h>
end_include

begin_include
include|#
directive|include
file|<string.h>
end_include

begin_include
include|#
directive|include
file|<time.h>
end_include

begin_include
include|#
directive|include
file|<unistd.h>
end_include

begin_include
include|#
directive|include
file|<utmp.h>
end_include

begin_include
include|#
directive|include
file|<devstat.h>
end_include

begin_include
include|#
directive|include
file|"systat.h"
end_include

begin_include
include|#
directive|include
file|"extern.h"
end_include

begin_include
include|#
directive|include
file|"devs.h"
end_include

begin_struct
specifier|static
struct|struct
name|Info
block|{
name|long
name|time
index|[
name|CPUSTATES
index|]
decl_stmt|;
name|struct
name|vmmeter
name|Cnt
decl_stmt|;
name|struct
name|vmtotal
name|Total
decl_stmt|;
name|struct
name|nchstats
name|nchstats
decl_stmt|;
name|long
name|nchcount
decl_stmt|;
name|long
modifier|*
name|intrcnt
decl_stmt|;
name|int
name|bufspace
decl_stmt|;
name|int
name|desiredvnodes
decl_stmt|;
name|long
name|numvnodes
decl_stmt|;
name|long
name|freevnodes
decl_stmt|;
name|long
name|numdirtybuffers
decl_stmt|;
block|}
name|s
struct|,
name|s1
struct|,
name|s2
struct|,
name|z
struct|;
end_struct

begin_decl_stmt
name|struct
name|statinfo
name|cur
decl_stmt|,
name|last
decl_stmt|,
name|run
decl_stmt|;
end_decl_stmt

begin_define
define|#
directive|define
name|cnt
value|s.Cnt
end_define

begin_define
define|#
directive|define
name|oldcnt
value|s1.Cnt
end_define

begin_define
define|#
directive|define
name|total
value|s.Total
end_define

begin_define
define|#
directive|define
name|nchtotal
value|s.nchstats
end_define

begin_define
define|#
directive|define
name|oldnchtotal
value|s1.nchstats
end_define

begin_enum
specifier|static
enum|enum
name|state
block|{
name|BOOT
block|,
name|TIME
block|,
name|RUN
block|}
name|state
init|=
name|TIME
enum|;
end_enum

begin_decl_stmt
specifier|static
name|void
name|allocinfo
name|__P
argument_list|(
operator|(
expr|struct
name|Info
operator|*
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|void
name|copyinfo
name|__P
argument_list|(
operator|(
expr|struct
name|Info
operator|*
operator|,
expr|struct
name|Info
operator|*
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|float
name|cputime
name|__P
argument_list|(
operator|(
name|int
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|void
name|dinfo
name|__P
argument_list|(
operator|(
name|int
operator|,
name|int
operator|,
expr|struct
name|statinfo
operator|*
operator|,
expr|struct
name|statinfo
operator|*
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|void
name|getinfo
name|__P
argument_list|(
operator|(
expr|struct
name|Info
operator|*
operator|,
expr|enum
name|state
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|void
name|putint
name|__P
argument_list|(
operator|(
name|int
operator|,
name|int
operator|,
name|int
operator|,
name|int
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|void
name|putfloat
name|__P
argument_list|(
operator|(
name|double
operator|,
name|int
operator|,
name|int
operator|,
name|int
operator|,
name|int
operator|,
name|int
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|void
name|putlongdouble
name|__P
argument_list|(
operator|(
name|long
name|double
operator|,
name|int
operator|,
name|int
operator|,
name|int
operator|,
name|int
operator|,
name|int
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|ucount
name|__P
argument_list|(
operator|(
name|void
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|ncpu
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|ut
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|char
name|buf
index|[
literal|26
index|]
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|time_t
name|t
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|double
name|etime
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|nintr
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|long
modifier|*
name|intrloc
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|char
modifier|*
modifier|*
name|intrname
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|nextintsrow
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|extended_vm_stats
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|struct
name|utmp
name|utmp
decl_stmt|;
end_decl_stmt

begin_function
name|WINDOW
modifier|*
name|openkre
parameter_list|()
block|{
name|ut
operator|=
name|open
argument_list|(
name|_PATH_UTMP
argument_list|,
name|O_RDONLY
argument_list|)
expr_stmt|;
if|if
condition|(
name|ut
operator|<
literal|0
condition|)
name|error
argument_list|(
literal|"No utmp"
argument_list|)
expr_stmt|;
return|return
operator|(
name|stdscr
operator|)
return|;
block|}
end_function

begin_function
name|void
name|closekre
parameter_list|(
name|w
parameter_list|)
name|WINDOW
modifier|*
name|w
decl_stmt|;
block|{
operator|(
name|void
operator|)
name|close
argument_list|(
name|ut
argument_list|)
expr_stmt|;
if|if
condition|(
name|w
operator|==
name|NULL
condition|)
return|return;
name|wclear
argument_list|(
name|w
argument_list|)
expr_stmt|;
name|wrefresh
argument_list|(
name|w
argument_list|)
expr_stmt|;
block|}
end_function

begin_decl_stmt
specifier|static
name|struct
name|nlist
name|namelist
index|[]
init|=
block|{
define|#
directive|define
name|X_CPTIME
value|0
block|{
literal|"_cp_time"
block|}
block|,
define|#
directive|define
name|X_CNT
value|1
block|{
literal|"_cnt"
block|}
block|,
define|#
directive|define
name|X_BUFFERSPACE
value|2
block|{
literal|"_bufspace"
block|}
block|,
define|#
directive|define
name|X_NCHSTATS
value|3
block|{
literal|"_nchstats"
block|}
block|,
define|#
directive|define
name|X_INTRNAMES
value|4
block|{
literal|"_intrnames"
block|}
block|,
define|#
directive|define
name|X_EINTRNAMES
value|5
block|{
literal|"_eintrnames"
block|}
block|,
define|#
directive|define
name|X_INTRCNT
value|6
block|{
literal|"_intrcnt"
block|}
block|,
define|#
directive|define
name|X_EINTRCNT
value|7
block|{
literal|"_eintrcnt"
block|}
block|,
define|#
directive|define
name|X_DESIREDVNODES
value|8
block|{
literal|"_desiredvnodes"
block|}
block|,
define|#
directive|define
name|X_NUMVNODES
value|9
block|{
literal|"_numvnodes"
block|}
block|,
define|#
directive|define
name|X_FREEVNODES
value|10
block|{
literal|"_freevnodes"
block|}
block|,
define|#
directive|define
name|X_NUMDIRTYBUFFERS
value|11
block|{
literal|"_numdirtybuffers"
block|}
block|,
block|{
literal|""
block|}
block|, }
decl_stmt|;
end_decl_stmt

begin_comment
comment|/*  * These constants define where the major pieces are laid out  */
end_comment

begin_define
define|#
directive|define
name|STATROW
value|0
end_define

begin_comment
comment|/* uses 1 row and 68 cols */
end_comment

begin_define
define|#
directive|define
name|STATCOL
value|2
end_define

begin_define
define|#
directive|define
name|MEMROW
value|2
end_define

begin_comment
comment|/* uses 4 rows and 31 cols */
end_comment

begin_define
define|#
directive|define
name|MEMCOL
value|0
end_define

begin_define
define|#
directive|define
name|PAGEROW
value|2
end_define

begin_comment
comment|/* uses 4 rows and 26 cols */
end_comment

begin_define
define|#
directive|define
name|PAGECOL
value|46
end_define

begin_define
define|#
directive|define
name|INTSROW
value|6
end_define

begin_comment
comment|/* uses all rows to bottom and 17 cols */
end_comment

begin_define
define|#
directive|define
name|INTSCOL
value|61
end_define

begin_define
define|#
directive|define
name|PROCSROW
value|7
end_define

begin_comment
comment|/* uses 2 rows and 20 cols */
end_comment

begin_define
define|#
directive|define
name|PROCSCOL
value|0
end_define

begin_define
define|#
directive|define
name|GENSTATROW
value|7
end_define

begin_comment
comment|/* uses 2 rows and 30 cols */
end_comment

begin_define
define|#
directive|define
name|GENSTATCOL
value|20
end_define

begin_define
define|#
directive|define
name|VMSTATROW
value|6
end_define

begin_comment
comment|/* uses 17 rows and 12 cols */
end_comment

begin_define
define|#
directive|define
name|VMSTATCOL
value|48
end_define

begin_define
define|#
directive|define
name|GRAPHROW
value|10
end_define

begin_comment
comment|/* uses 3 rows and 51 cols */
end_comment

begin_define
define|#
directive|define
name|GRAPHCOL
value|0
end_define

begin_define
define|#
directive|define
name|NAMEIROW
value|14
end_define

begin_comment
comment|/* uses 3 rows and 38 cols */
end_comment

begin_define
define|#
directive|define
name|NAMEICOL
value|0
end_define

begin_define
define|#
directive|define
name|DISKROW
value|18
end_define

begin_comment
comment|/* uses 5 rows and 50 cols (for 9 drives) */
end_comment

begin_define
define|#
directive|define
name|DISKCOL
value|0
end_define

begin_define
define|#
directive|define
name|DRIVESPACE
value|7
end_define

begin_comment
comment|/* max # for space */
end_comment

begin_define
define|#
directive|define
name|MAXDRIVES
value|DRIVESPACE
end_define

begin_comment
comment|/* max # to display */
end_comment

begin_function
name|int
name|initkre
parameter_list|()
block|{
name|char
modifier|*
name|intrnamebuf
decl_stmt|,
modifier|*
name|cp
decl_stmt|;
name|int
name|i
decl_stmt|;
if|if
condition|(
name|namelist
index|[
literal|0
index|]
operator|.
name|n_type
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|kvm_nlist
argument_list|(
name|kd
argument_list|,
name|namelist
argument_list|)
condition|)
block|{
name|nlisterr
argument_list|(
name|namelist
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
if|if
condition|(
name|namelist
index|[
literal|0
index|]
operator|.
name|n_type
operator|==
literal|0
condition|)
block|{
name|error
argument_list|(
literal|"No namelist"
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
block|}
if|if
condition|(
name|num_devices
operator|=
name|getnumdevs
argument_list|()
operator|<
literal|0
condition|)
block|{
name|warnx
argument_list|(
literal|"%s"
argument_list|,
name|devstat_errbuf
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
name|cur
operator|.
name|dinfo
operator|=
operator|(
expr|struct
name|devinfo
operator|*
operator|)
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
expr|struct
name|devinfo
argument_list|)
argument_list|)
expr_stmt|;
name|last
operator|.
name|dinfo
operator|=
operator|(
expr|struct
name|devinfo
operator|*
operator|)
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
expr|struct
name|devinfo
argument_list|)
argument_list|)
expr_stmt|;
name|run
operator|.
name|dinfo
operator|=
operator|(
expr|struct
name|devinfo
operator|*
operator|)
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
expr|struct
name|devinfo
argument_list|)
argument_list|)
expr_stmt|;
name|bzero
argument_list|(
name|cur
operator|.
name|dinfo
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|devinfo
argument_list|)
argument_list|)
expr_stmt|;
name|bzero
argument_list|(
name|last
operator|.
name|dinfo
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|devinfo
argument_list|)
argument_list|)
expr_stmt|;
name|bzero
argument_list|(
name|run
operator|.
name|dinfo
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|devinfo
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|dsinit
argument_list|(
name|MAXDRIVES
argument_list|,
operator|&
name|cur
argument_list|,
operator|&
name|last
argument_list|,
operator|&
name|run
argument_list|)
operator|!=
literal|1
condition|)
return|return
operator|(
literal|0
operator|)
return|;
if|if
condition|(
name|nintr
operator|==
literal|0
condition|)
block|{
name|nintr
operator|=
operator|(
name|namelist
index|[
name|X_EINTRCNT
index|]
operator|.
name|n_value
operator|-
name|namelist
index|[
name|X_INTRCNT
index|]
operator|.
name|n_value
operator|)
operator|/
sizeof|sizeof
argument_list|(
name|long
argument_list|)
expr_stmt|;
name|intrloc
operator|=
name|calloc
argument_list|(
name|nintr
argument_list|,
sizeof|sizeof
argument_list|(
name|long
argument_list|)
argument_list|)
expr_stmt|;
name|intrname
operator|=
name|calloc
argument_list|(
name|nintr
argument_list|,
sizeof|sizeof
argument_list|(
name|long
argument_list|)
argument_list|)
expr_stmt|;
name|intrnamebuf
operator|=
name|malloc
argument_list|(
name|namelist
index|[
name|X_EINTRNAMES
index|]
operator|.
name|n_value
operator|-
name|namelist
index|[
name|X_INTRNAMES
index|]
operator|.
name|n_value
argument_list|)
expr_stmt|;
if|if
condition|(
name|intrnamebuf
operator|==
literal|0
operator|||
name|intrname
operator|==
literal|0
operator|||
name|intrloc
operator|==
literal|0
condition|)
block|{
name|error
argument_list|(
literal|"Out of memory\n"
argument_list|)
expr_stmt|;
if|if
condition|(
name|intrnamebuf
condition|)
name|free
argument_list|(
name|intrnamebuf
argument_list|)
expr_stmt|;
if|if
condition|(
name|intrname
condition|)
name|free
argument_list|(
name|intrname
argument_list|)
expr_stmt|;
if|if
condition|(
name|intrloc
condition|)
name|free
argument_list|(
name|intrloc
argument_list|)
expr_stmt|;
name|nintr
operator|=
literal|0
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
name|NREAD
argument_list|(
name|X_INTRNAMES
argument_list|,
name|intrnamebuf
argument_list|,
name|NVAL
argument_list|(
name|X_EINTRNAMES
argument_list|)
operator|-
name|NVAL
argument_list|(
name|X_INTRNAMES
argument_list|)
argument_list|)
expr_stmt|;
for|for
control|(
name|cp
operator|=
name|intrnamebuf
operator|,
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|nintr
condition|;
name|i
operator|++
control|)
block|{
name|intrname
index|[
name|i
index|]
operator|=
name|cp
expr_stmt|;
name|cp
operator|+=
name|strlen
argument_list|(
name|cp
argument_list|)
operator|+
literal|1
expr_stmt|;
block|}
name|nextintsrow
operator|=
name|INTSROW
operator|+
literal|2
expr_stmt|;
name|allocinfo
argument_list|(
operator|&
name|s
argument_list|)
expr_stmt|;
name|allocinfo
argument_list|(
operator|&
name|s1
argument_list|)
expr_stmt|;
name|allocinfo
argument_list|(
operator|&
name|s2
argument_list|)
expr_stmt|;
name|allocinfo
argument_list|(
operator|&
name|z
argument_list|)
expr_stmt|;
block|}
name|getinfo
argument_list|(
operator|&
name|s2
argument_list|,
name|RUN
argument_list|)
expr_stmt|;
name|copyinfo
argument_list|(
operator|&
name|s2
argument_list|,
operator|&
name|s1
argument_list|)
expr_stmt|;
return|return
operator|(
literal|1
operator|)
return|;
block|}
end_function

begin_function
name|void
name|fetchkre
parameter_list|()
block|{
name|time_t
name|now
decl_stmt|;
name|struct
name|tm
modifier|*
name|tp
decl_stmt|;
name|time
argument_list|(
operator|&
name|now
argument_list|)
expr_stmt|;
name|tp
operator|=
name|localtime
argument_list|(
operator|&
name|now
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|strftime
argument_list|(
name|buf
argument_list|,
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
argument_list|,
literal|"%c"
argument_list|,
name|tp
argument_list|)
expr_stmt|;
name|buf
index|[
literal|16
index|]
operator|=
literal|'\0'
expr_stmt|;
name|getinfo
argument_list|(
operator|&
name|s
argument_list|,
name|state
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|labelkre
parameter_list|()
block|{
specifier|register
name|int
name|i
decl_stmt|,
name|j
decl_stmt|;
name|clear
argument_list|()
expr_stmt|;
name|mvprintw
argument_list|(
name|STATROW
argument_list|,
name|STATCOL
operator|+
literal|4
argument_list|,
literal|"users    Load"
argument_list|)
expr_stmt|;
name|mvprintw
argument_list|(
name|MEMROW
argument_list|,
name|MEMCOL
argument_list|,
literal|"Mem:KB    REAL            VIRTUAL"
argument_list|)
expr_stmt|;
name|mvprintw
argument_list|(
name|MEMROW
operator|+
literal|1
argument_list|,
name|MEMCOL
argument_list|,
literal|"        Tot   Share      Tot    Share"
argument_list|)
expr_stmt|;
name|mvprintw
argument_list|(
name|MEMROW
operator|+
literal|2
argument_list|,
name|MEMCOL
argument_list|,
literal|"Act"
argument_list|)
expr_stmt|;
name|mvprintw
argument_list|(
name|MEMROW
operator|+
literal|3
argument_list|,
name|MEMCOL
argument_list|,
literal|"All"
argument_list|)
expr_stmt|;
name|mvprintw
argument_list|(
name|MEMROW
operator|+
literal|1
argument_list|,
name|MEMCOL
operator|+
literal|41
argument_list|,
literal|"Free"
argument_list|)
expr_stmt|;
name|mvprintw
argument_list|(
name|PAGEROW
argument_list|,
name|PAGECOL
argument_list|,
literal|"        VN PAGER  SWAP PAGER "
argument_list|)
expr_stmt|;
name|mvprintw
argument_list|(
name|PAGEROW
operator|+
literal|1
argument_list|,
name|PAGECOL
argument_list|,
literal|"        in  out     in  out "
argument_list|)
expr_stmt|;
name|mvprintw
argument_list|(
name|PAGEROW
operator|+
literal|2
argument_list|,
name|PAGECOL
argument_list|,
literal|"count"
argument_list|)
expr_stmt|;
name|mvprintw
argument_list|(
name|PAGEROW
operator|+
literal|3
argument_list|,
name|PAGECOL
argument_list|,
literal|"pages"
argument_list|)
expr_stmt|;
name|mvprintw
argument_list|(
name|INTSROW
argument_list|,
name|INTSCOL
operator|+
literal|3
argument_list|,
literal|" Interrupts"
argument_list|)
expr_stmt|;
name|mvprintw
argument_list|(
name|INTSROW
operator|+
literal|1
argument_list|,
name|INTSCOL
operator|+
literal|9
argument_list|,
literal|"total"
argument_list|)
expr_stmt|;
name|mvprintw
argument_list|(
name|VMSTATROW
operator|+
literal|1
argument_list|,
name|VMSTATCOL
operator|+
literal|10
argument_list|,
literal|"cow"
argument_list|)
expr_stmt|;
name|mvprintw
argument_list|(
name|VMSTATROW
operator|+
literal|2
argument_list|,
name|VMSTATCOL
operator|+
literal|10
argument_list|,
literal|"wire"
argument_list|)
expr_stmt|;
name|mvprintw
argument_list|(
name|VMSTATROW
operator|+
literal|3
argument_list|,
name|VMSTATCOL
operator|+
literal|10
argument_list|,
literal|"act"
argument_list|)
expr_stmt|;
name|mvprintw
argument_list|(
name|VMSTATROW
operator|+
literal|4
argument_list|,
name|VMSTATCOL
operator|+
literal|10
argument_list|,
literal|"inact"
argument_list|)
expr_stmt|;
name|mvprintw
argument_list|(
name|VMSTATROW
operator|+
literal|5
argument_list|,
name|VMSTATCOL
operator|+
literal|10
argument_list|,
literal|"cache"
argument_list|)
expr_stmt|;
name|mvprintw
argument_list|(
name|VMSTATROW
operator|+
literal|6
argument_list|,
name|VMSTATCOL
operator|+
literal|10
argument_list|,
literal|"free"
argument_list|)
expr_stmt|;
name|mvprintw
argument_list|(
name|VMSTATROW
operator|+
literal|7
argument_list|,
name|VMSTATCOL
operator|+
literal|10
argument_list|,
literal|"daefr"
argument_list|)
expr_stmt|;
name|mvprintw
argument_list|(
name|VMSTATROW
operator|+
literal|8
argument_list|,
name|VMSTATCOL
operator|+
literal|10
argument_list|,
literal|"prcfr"
argument_list|)
expr_stmt|;
name|mvprintw
argument_list|(
name|VMSTATROW
operator|+
literal|9
argument_list|,
name|VMSTATCOL
operator|+
literal|10
argument_list|,
literal|"react"
argument_list|)
expr_stmt|;
name|mvprintw
argument_list|(
name|VMSTATROW
operator|+
literal|10
argument_list|,
name|VMSTATCOL
operator|+
literal|10
argument_list|,
literal|"pdwake"
argument_list|)
expr_stmt|;
name|mvprintw
argument_list|(
name|VMSTATROW
operator|+
literal|11
argument_list|,
name|VMSTATCOL
operator|+
literal|10
argument_list|,
literal|"pdpgs"
argument_list|)
expr_stmt|;
name|mvprintw
argument_list|(
name|VMSTATROW
operator|+
literal|12
argument_list|,
name|VMSTATCOL
operator|+
literal|10
argument_list|,
literal|"intrn"
argument_list|)
expr_stmt|;
name|mvprintw
argument_list|(
name|VMSTATROW
operator|+
literal|13
argument_list|,
name|VMSTATCOL
operator|+
literal|10
argument_list|,
literal|"buf"
argument_list|)
expr_stmt|;
name|mvprintw
argument_list|(
name|VMSTATROW
operator|+
literal|14
argument_list|,
name|VMSTATCOL
operator|+
literal|10
argument_list|,
literal|"dirtybuf"
argument_list|)
expr_stmt|;
name|mvprintw
argument_list|(
name|VMSTATROW
operator|+
literal|15
argument_list|,
name|VMSTATCOL
operator|+
literal|10
argument_list|,
literal|"desiredvnodes"
argument_list|)
expr_stmt|;
name|mvprintw
argument_list|(
name|VMSTATROW
operator|+
literal|16
argument_list|,
name|VMSTATCOL
operator|+
literal|10
argument_list|,
literal|"numvnodes"
argument_list|)
expr_stmt|;
name|mvprintw
argument_list|(
name|VMSTATROW
operator|+
literal|17
argument_list|,
name|VMSTATCOL
operator|+
literal|10
argument_list|,
literal|"freevnodes"
argument_list|)
expr_stmt|;
name|mvprintw
argument_list|(
name|GENSTATROW
argument_list|,
name|GENSTATCOL
argument_list|,
literal|"  Csw  Trp  Sys  Int  Sof  Flt"
argument_list|)
expr_stmt|;
name|mvprintw
argument_list|(
name|GRAPHROW
argument_list|,
name|GRAPHCOL
argument_list|,
literal|"  . %%Sys    . %%Intr   . %%User   . %%Nice   . %%Idle"
argument_list|)
expr_stmt|;
name|mvprintw
argument_list|(
name|PROCSROW
argument_list|,
name|PROCSCOL
argument_list|,
literal|"Proc:r  p  d  s  w"
argument_list|)
expr_stmt|;
name|mvprintw
argument_list|(
name|GRAPHROW
operator|+
literal|1
argument_list|,
name|GRAPHCOL
argument_list|,
literal|"|    |    |    |    |    |    |    |    |    |    |"
argument_list|)
expr_stmt|;
name|mvprintw
argument_list|(
name|NAMEIROW
argument_list|,
name|NAMEICOL
argument_list|,
literal|"Namei         Name-cache    Dir-cache"
argument_list|)
expr_stmt|;
name|mvprintw
argument_list|(
name|NAMEIROW
operator|+
literal|1
argument_list|,
name|NAMEICOL
argument_list|,
literal|"    Calls     hits    %%     hits    %%"
argument_list|)
expr_stmt|;
name|mvprintw
argument_list|(
name|DISKROW
argument_list|,
name|DISKCOL
argument_list|,
literal|"Disks"
argument_list|)
expr_stmt|;
name|mvprintw
argument_list|(
name|DISKROW
operator|+
literal|1
argument_list|,
name|DISKCOL
argument_list|,
literal|"KB/t"
argument_list|)
expr_stmt|;
name|mvprintw
argument_list|(
name|DISKROW
operator|+
literal|2
argument_list|,
name|DISKCOL
argument_list|,
literal|"tps"
argument_list|)
expr_stmt|;
name|mvprintw
argument_list|(
name|DISKROW
operator|+
literal|3
argument_list|,
name|DISKCOL
argument_list|,
literal|"MB/s"
argument_list|)
expr_stmt|;
name|mvprintw
argument_list|(
name|DISKROW
operator|+
literal|4
argument_list|,
name|DISKCOL
argument_list|,
literal|"%% busy"
argument_list|)
expr_stmt|;
comment|/* 	 * For now, we don't support a fourth disk statistic.  So there's 	 * no point in providing a label for it.  If someone can think of a 	 * fourth useful disk statistic, there is room to add it. 	 */
comment|/* mvprintw(DISKROW + 4, DISKCOL, " msps"); */
name|j
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|num_devices
operator|&&
name|j
operator|<
name|MAXDRIVES
condition|;
name|i
operator|++
control|)
if|if
condition|(
name|dev_select
index|[
name|i
index|]
operator|.
name|selected
condition|)
block|{
name|char
name|tmpstr
index|[
literal|80
index|]
decl_stmt|;
name|sprintf
argument_list|(
name|tmpstr
argument_list|,
literal|"%s%d"
argument_list|,
name|dev_select
index|[
name|i
index|]
operator|.
name|device_name
argument_list|,
name|dev_select
index|[
name|i
index|]
operator|.
name|unit_number
argument_list|)
expr_stmt|;
name|mvprintw
argument_list|(
name|DISKROW
argument_list|,
name|DISKCOL
operator|+
literal|5
operator|+
literal|6
operator|*
name|j
argument_list|,
literal|" %5.5s"
argument_list|,
name|tmpstr
argument_list|)
expr_stmt|;
name|j
operator|++
expr_stmt|;
block|}
if|if
condition|(
name|j
operator|<=
literal|4
condition|)
block|{
comment|/* 		 * room for extended VM stats 		 */
name|mvprintw
argument_list|(
name|VMSTATROW
operator|+
literal|11
argument_list|,
name|VMSTATCOL
operator|-
literal|6
argument_list|,
literal|"zfod"
argument_list|)
expr_stmt|;
name|mvprintw
argument_list|(
name|VMSTATROW
operator|+
literal|12
argument_list|,
name|VMSTATCOL
operator|-
literal|6
argument_list|,
literal|"ofod"
argument_list|)
expr_stmt|;
name|mvprintw
argument_list|(
name|VMSTATROW
operator|+
literal|13
argument_list|,
name|VMSTATCOL
operator|-
literal|6
argument_list|,
literal|"%%slo-z"
argument_list|)
expr_stmt|;
name|mvprintw
argument_list|(
name|VMSTATROW
operator|+
literal|14
argument_list|,
name|VMSTATCOL
operator|-
literal|6
argument_list|,
literal|"tfree"
argument_list|)
expr_stmt|;
name|extended_vm_stats
operator|=
literal|1
expr_stmt|;
block|}
else|else
block|{
name|extended_vm_stats
operator|=
literal|0
expr_stmt|;
name|mvprintw
argument_list|(
name|VMSTATROW
operator|+
literal|0
argument_list|,
name|VMSTATCOL
operator|+
literal|10
argument_list|,
literal|"zfod"
argument_list|)
expr_stmt|;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|nintr
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|intrloc
index|[
name|i
index|]
operator|==
literal|0
condition|)
continue|continue;
name|mvprintw
argument_list|(
name|intrloc
index|[
name|i
index|]
argument_list|,
name|INTSCOL
operator|+
literal|9
argument_list|,
literal|"%-10.10s"
argument_list|,
name|intrname
index|[
name|i
index|]
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_define
define|#
directive|define
name|X
parameter_list|(
name|fld
parameter_list|)
value|{t=s.fld[i]; s.fld[i]-=s1.fld[i]; if(state==TIME) s1.fld[i]=t;}
end_define

begin_define
define|#
directive|define
name|Q
parameter_list|(
name|fld
parameter_list|)
value|{t=cur.fld[i]; cur.fld[i]-=last.fld[i]; if(state==TIME) last.fld[i]=t;}
end_define

begin_define
define|#
directive|define
name|Y
parameter_list|(
name|fld
parameter_list|)
value|{t = s.fld; s.fld -= s1.fld; if(state == TIME) s1.fld = t;}
end_define

begin_define
define|#
directive|define
name|Z
parameter_list|(
name|fld
parameter_list|)
value|{t = s.nchstats.fld; s.nchstats.fld -= s1.nchstats.fld; \ 	if(state == TIME) s1.nchstats.fld = t;}
end_define

begin_define
define|#
directive|define
name|PUTRATE
parameter_list|(
name|fld
parameter_list|,
name|l
parameter_list|,
name|c
parameter_list|,
name|w
parameter_list|)
define|\
value|Y(fld); \ 	putint((int)((float)s.fld/etime + 0.5), l, c, w)
end_define

begin_define
define|#
directive|define
name|MAXFAIL
value|5
end_define

begin_decl_stmt
specifier|static
name|char
name|cpuchar
index|[
name|CPUSTATES
index|]
init|=
block|{
literal|'='
block|,
literal|'+'
block|,
literal|'>'
block|,
literal|'-'
block|,
literal|' '
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|char
name|cpuorder
index|[
name|CPUSTATES
index|]
init|=
block|{
name|CP_SYS
block|,
name|CP_INTR
block|,
name|CP_USER
block|,
name|CP_NICE
block|,
name|CP_IDLE
block|}
decl_stmt|;
end_decl_stmt

begin_function
name|void
name|showkre
parameter_list|()
block|{
name|float
name|f1
decl_stmt|,
name|f2
decl_stmt|;
name|int
name|psiz
decl_stmt|,
name|inttotal
decl_stmt|;
name|int
name|i
decl_stmt|,
name|l
decl_stmt|,
name|c
decl_stmt|;
specifier|static
name|int
name|failcnt
init|=
literal|0
decl_stmt|;
name|etime
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|CPUSTATES
condition|;
name|i
operator|++
control|)
block|{
name|X
argument_list|(
name|time
argument_list|)
expr_stmt|;
name|Q
argument_list|(
name|cp_time
argument_list|)
expr_stmt|;
name|etime
operator|+=
name|s
operator|.
name|time
index|[
name|i
index|]
expr_stmt|;
block|}
if|if
condition|(
name|etime
operator|<
literal|5.0
condition|)
block|{
comment|/*< 5 ticks - ignore this trash */
if|if
condition|(
name|failcnt
operator|++
operator|>=
name|MAXFAIL
condition|)
block|{
name|clear
argument_list|()
expr_stmt|;
name|mvprintw
argument_list|(
literal|2
argument_list|,
literal|10
argument_list|,
literal|"The alternate system clock has died!"
argument_list|)
expr_stmt|;
name|mvprintw
argument_list|(
literal|3
argument_list|,
literal|10
argument_list|,
literal|"Reverting to ``pigs'' display."
argument_list|)
expr_stmt|;
name|move
argument_list|(
name|CMDLINE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|refresh
argument_list|()
expr_stmt|;
name|failcnt
operator|=
literal|0
expr_stmt|;
name|sleep
argument_list|(
literal|5
argument_list|)
expr_stmt|;
name|command
argument_list|(
literal|"pigs"
argument_list|)
expr_stmt|;
block|}
return|return;
block|}
name|failcnt
operator|=
literal|0
expr_stmt|;
name|etime
operator|/=
name|hertz
expr_stmt|;
name|etime
operator|/=
name|ncpu
expr_stmt|;
name|inttotal
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|nintr
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|s
operator|.
name|intrcnt
index|[
name|i
index|]
operator|==
literal|0
condition|)
continue|continue;
if|if
condition|(
name|intrloc
index|[
name|i
index|]
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|nextintsrow
operator|==
name|LINES
condition|)
continue|continue;
name|intrloc
index|[
name|i
index|]
operator|=
name|nextintsrow
operator|++
expr_stmt|;
name|mvprintw
argument_list|(
name|intrloc
index|[
name|i
index|]
argument_list|,
name|INTSCOL
operator|+
literal|9
argument_list|,
literal|"%-10.10s"
argument_list|,
name|intrname
index|[
name|i
index|]
argument_list|)
expr_stmt|;
block|}
name|X
argument_list|(
name|intrcnt
argument_list|)
expr_stmt|;
name|l
operator|=
call|(
name|int
call|)
argument_list|(
operator|(
name|float
operator|)
name|s
operator|.
name|intrcnt
index|[
name|i
index|]
operator|/
name|etime
operator|+
literal|0.5
argument_list|)
expr_stmt|;
name|inttotal
operator|+=
name|l
expr_stmt|;
name|putint
argument_list|(
name|l
argument_list|,
name|intrloc
index|[
name|i
index|]
argument_list|,
name|INTSCOL
operator|+
literal|2
argument_list|,
literal|6
argument_list|)
expr_stmt|;
block|}
name|putint
argument_list|(
name|inttotal
argument_list|,
name|INTSROW
operator|+
literal|1
argument_list|,
name|INTSCOL
operator|+
literal|2
argument_list|,
literal|6
argument_list|)
expr_stmt|;
name|Z
argument_list|(
name|ncs_goodhits
argument_list|)
expr_stmt|;
name|Z
argument_list|(
name|ncs_badhits
argument_list|)
expr_stmt|;
name|Z
argument_list|(
name|ncs_miss
argument_list|)
expr_stmt|;
name|Z
argument_list|(
name|ncs_long
argument_list|)
expr_stmt|;
name|Z
argument_list|(
name|ncs_pass2
argument_list|)
expr_stmt|;
name|Z
argument_list|(
name|ncs_2passes
argument_list|)
expr_stmt|;
name|Z
argument_list|(
name|ncs_neghits
argument_list|)
expr_stmt|;
name|s
operator|.
name|nchcount
operator|=
name|nchtotal
operator|.
name|ncs_goodhits
operator|+
name|nchtotal
operator|.
name|ncs_badhits
operator|+
name|nchtotal
operator|.
name|ncs_miss
operator|+
name|nchtotal
operator|.
name|ncs_long
operator|+
name|nchtotal
operator|.
name|ncs_neghits
expr_stmt|;
if|if
condition|(
name|state
operator|==
name|TIME
condition|)
name|s1
operator|.
name|nchcount
operator|=
name|s
operator|.
name|nchcount
expr_stmt|;
name|psiz
operator|=
literal|0
expr_stmt|;
name|f2
operator|=
literal|0.0
expr_stmt|;
for|for
control|(
name|c
operator|=
literal|0
init|;
name|c
operator|<
name|CPUSTATES
condition|;
name|c
operator|++
control|)
block|{
name|i
operator|=
name|cpuorder
index|[
name|c
index|]
expr_stmt|;
name|f1
operator|=
name|cputime
argument_list|(
name|i
argument_list|)
expr_stmt|;
name|f2
operator|+=
name|f1
expr_stmt|;
name|l
operator|=
call|(
name|int
call|)
argument_list|(
operator|(
name|f2
operator|+
literal|1.0
operator|)
operator|/
literal|2.0
argument_list|)
operator|-
name|psiz
expr_stmt|;
if|if
condition|(
name|f1
operator|>
literal|99.9
condition|)
name|f1
operator|=
literal|99.9
expr_stmt|;
comment|/* no room to display 100.0 */
name|putfloat
argument_list|(
name|f1
argument_list|,
name|GRAPHROW
argument_list|,
name|GRAPHCOL
operator|+
literal|10
operator|*
name|c
argument_list|,
literal|4
argument_list|,
literal|1
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|move
argument_list|(
name|GRAPHROW
operator|+
literal|2
argument_list|,
name|psiz
argument_list|)
expr_stmt|;
name|psiz
operator|+=
name|l
expr_stmt|;
while|while
condition|(
name|l
operator|--
operator|>
literal|0
condition|)
name|addch
argument_list|(
name|cpuchar
index|[
name|c
index|]
argument_list|)
expr_stmt|;
block|}
name|putint
argument_list|(
name|ucount
argument_list|()
argument_list|,
name|STATROW
argument_list|,
name|STATCOL
argument_list|,
literal|3
argument_list|)
expr_stmt|;
name|putfloat
argument_list|(
name|avenrun
index|[
literal|0
index|]
argument_list|,
name|STATROW
argument_list|,
name|STATCOL
operator|+
literal|17
argument_list|,
literal|6
argument_list|,
literal|2
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|putfloat
argument_list|(
name|avenrun
index|[
literal|1
index|]
argument_list|,
name|STATROW
argument_list|,
name|STATCOL
operator|+
literal|23
argument_list|,
literal|6
argument_list|,
literal|2
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|putfloat
argument_list|(
name|avenrun
index|[
literal|2
index|]
argument_list|,
name|STATROW
argument_list|,
name|STATCOL
operator|+
literal|29
argument_list|,
literal|6
argument_list|,
literal|2
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|mvaddstr
argument_list|(
name|STATROW
argument_list|,
name|STATCOL
operator|+
literal|53
argument_list|,
name|buf
argument_list|)
expr_stmt|;
define|#
directive|define
name|pgtokb
parameter_list|(
name|pg
parameter_list|)
value|((pg) * cnt.v_page_size / 1024)
name|putint
argument_list|(
name|pgtokb
argument_list|(
name|total
operator|.
name|t_arm
argument_list|)
argument_list|,
name|MEMROW
operator|+
literal|2
argument_list|,
name|MEMCOL
operator|+
literal|3
argument_list|,
literal|8
argument_list|)
expr_stmt|;
name|putint
argument_list|(
name|pgtokb
argument_list|(
name|total
operator|.
name|t_armshr
argument_list|)
argument_list|,
name|MEMROW
operator|+
literal|2
argument_list|,
name|MEMCOL
operator|+
literal|11
argument_list|,
literal|8
argument_list|)
expr_stmt|;
name|putint
argument_list|(
name|pgtokb
argument_list|(
name|total
operator|.
name|t_avm
argument_list|)
argument_list|,
name|MEMROW
operator|+
literal|2
argument_list|,
name|MEMCOL
operator|+
literal|19
argument_list|,
literal|9
argument_list|)
expr_stmt|;
name|putint
argument_list|(
name|pgtokb
argument_list|(
name|total
operator|.
name|t_avmshr
argument_list|)
argument_list|,
name|MEMROW
operator|+
literal|2
argument_list|,
name|MEMCOL
operator|+
literal|28
argument_list|,
literal|9
argument_list|)
expr_stmt|;
name|putint
argument_list|(
name|pgtokb
argument_list|(
name|total
operator|.
name|t_rm
argument_list|)
argument_list|,
name|MEMROW
operator|+
literal|3
argument_list|,
name|MEMCOL
operator|+
literal|3
argument_list|,
literal|8
argument_list|)
expr_stmt|;
name|putint
argument_list|(
name|pgtokb
argument_list|(
name|total
operator|.
name|t_rmshr
argument_list|)
argument_list|,
name|MEMROW
operator|+
literal|3
argument_list|,
name|MEMCOL
operator|+
literal|11
argument_list|,
literal|8
argument_list|)
expr_stmt|;
name|putint
argument_list|(
name|pgtokb
argument_list|(
name|total
operator|.
name|t_vm
argument_list|)
argument_list|,
name|MEMROW
operator|+
literal|3
argument_list|,
name|MEMCOL
operator|+
literal|19
argument_list|,
literal|9
argument_list|)
expr_stmt|;
name|putint
argument_list|(
name|pgtokb
argument_list|(
name|total
operator|.
name|t_vmshr
argument_list|)
argument_list|,
name|MEMROW
operator|+
literal|3
argument_list|,
name|MEMCOL
operator|+
literal|28
argument_list|,
literal|9
argument_list|)
expr_stmt|;
name|putint
argument_list|(
name|pgtokb
argument_list|(
name|total
operator|.
name|t_free
argument_list|)
argument_list|,
name|MEMROW
operator|+
literal|2
argument_list|,
name|MEMCOL
operator|+
literal|37
argument_list|,
literal|8
argument_list|)
expr_stmt|;
name|putint
argument_list|(
name|total
operator|.
name|t_rq
operator|-
literal|1
argument_list|,
name|PROCSROW
operator|+
literal|1
argument_list|,
name|PROCSCOL
operator|+
literal|3
argument_list|,
literal|3
argument_list|)
expr_stmt|;
name|putint
argument_list|(
name|total
operator|.
name|t_pw
argument_list|,
name|PROCSROW
operator|+
literal|1
argument_list|,
name|PROCSCOL
operator|+
literal|6
argument_list|,
literal|3
argument_list|)
expr_stmt|;
name|putint
argument_list|(
name|total
operator|.
name|t_dw
argument_list|,
name|PROCSROW
operator|+
literal|1
argument_list|,
name|PROCSCOL
operator|+
literal|9
argument_list|,
literal|3
argument_list|)
expr_stmt|;
name|putint
argument_list|(
name|total
operator|.
name|t_sl
argument_list|,
name|PROCSROW
operator|+
literal|1
argument_list|,
name|PROCSCOL
operator|+
literal|12
argument_list|,
literal|3
argument_list|)
expr_stmt|;
name|putint
argument_list|(
name|total
operator|.
name|t_sw
argument_list|,
name|PROCSROW
operator|+
literal|1
argument_list|,
name|PROCSCOL
operator|+
literal|15
argument_list|,
literal|3
argument_list|)
expr_stmt|;
if|if
condition|(
name|extended_vm_stats
operator|==
literal|0
condition|)
block|{
name|PUTRATE
argument_list|(
name|Cnt
operator|.
name|v_zfod
argument_list|,
name|VMSTATROW
operator|+
literal|0
argument_list|,
name|VMSTATCOL
operator|+
literal|4
argument_list|,
literal|5
argument_list|)
expr_stmt|;
block|}
name|PUTRATE
argument_list|(
name|Cnt
operator|.
name|v_cow_faults
argument_list|,
name|VMSTATROW
operator|+
literal|1
argument_list|,
name|VMSTATCOL
operator|+
literal|3
argument_list|,
literal|6
argument_list|)
expr_stmt|;
name|putint
argument_list|(
name|pgtokb
argument_list|(
name|cnt
operator|.
name|v_wire_count
argument_list|)
argument_list|,
name|VMSTATROW
operator|+
literal|2
argument_list|,
name|VMSTATCOL
argument_list|,
literal|9
argument_list|)
expr_stmt|;
name|putint
argument_list|(
name|pgtokb
argument_list|(
name|cnt
operator|.
name|v_active_count
argument_list|)
argument_list|,
name|VMSTATROW
operator|+
literal|3
argument_list|,
name|VMSTATCOL
argument_list|,
literal|9
argument_list|)
expr_stmt|;
name|putint
argument_list|(
name|pgtokb
argument_list|(
name|cnt
operator|.
name|v_inactive_count
argument_list|)
argument_list|,
name|VMSTATROW
operator|+
literal|4
argument_list|,
name|VMSTATCOL
argument_list|,
literal|9
argument_list|)
expr_stmt|;
name|putint
argument_list|(
name|pgtokb
argument_list|(
name|cnt
operator|.
name|v_cache_count
argument_list|)
argument_list|,
name|VMSTATROW
operator|+
literal|5
argument_list|,
name|VMSTATCOL
argument_list|,
literal|9
argument_list|)
expr_stmt|;
name|putint
argument_list|(
name|pgtokb
argument_list|(
name|cnt
operator|.
name|v_free_count
argument_list|)
argument_list|,
name|VMSTATROW
operator|+
literal|6
argument_list|,
name|VMSTATCOL
argument_list|,
literal|9
argument_list|)
expr_stmt|;
name|PUTRATE
argument_list|(
name|Cnt
operator|.
name|v_dfree
argument_list|,
name|VMSTATROW
operator|+
literal|7
argument_list|,
name|VMSTATCOL
argument_list|,
literal|9
argument_list|)
expr_stmt|;
name|PUTRATE
argument_list|(
name|Cnt
operator|.
name|v_pfree
argument_list|,
name|VMSTATROW
operator|+
literal|8
argument_list|,
name|VMSTATCOL
argument_list|,
literal|9
argument_list|)
expr_stmt|;
name|PUTRATE
argument_list|(
name|Cnt
operator|.
name|v_reactivated
argument_list|,
name|VMSTATROW
operator|+
literal|9
argument_list|,
name|VMSTATCOL
argument_list|,
literal|9
argument_list|)
expr_stmt|;
name|PUTRATE
argument_list|(
name|Cnt
operator|.
name|v_pdwakeups
argument_list|,
name|VMSTATROW
operator|+
literal|10
argument_list|,
name|VMSTATCOL
argument_list|,
literal|9
argument_list|)
expr_stmt|;
name|PUTRATE
argument_list|(
name|Cnt
operator|.
name|v_pdpages
argument_list|,
name|VMSTATROW
operator|+
literal|11
argument_list|,
name|VMSTATCOL
argument_list|,
literal|9
argument_list|)
expr_stmt|;
name|PUTRATE
argument_list|(
name|Cnt
operator|.
name|v_intrans
argument_list|,
name|VMSTATROW
operator|+
literal|12
argument_list|,
name|VMSTATCOL
argument_list|,
literal|9
argument_list|)
expr_stmt|;
if|if
condition|(
name|extended_vm_stats
condition|)
block|{
name|PUTRATE
argument_list|(
name|Cnt
operator|.
name|v_zfod
argument_list|,
name|VMSTATROW
operator|+
literal|11
argument_list|,
name|VMSTATCOL
operator|-
literal|16
argument_list|,
literal|9
argument_list|)
expr_stmt|;
name|PUTRATE
argument_list|(
name|Cnt
operator|.
name|v_ozfod
argument_list|,
name|VMSTATROW
operator|+
literal|12
argument_list|,
name|VMSTATCOL
operator|-
literal|16
argument_list|,
literal|9
argument_list|)
expr_stmt|;
name|putint
argument_list|(
operator|(
operator|(
name|s
operator|.
name|Cnt
operator|.
name|v_ozfod
operator|<
name|s
operator|.
name|Cnt
operator|.
name|v_zfod
operator|)
condition|?
name|s
operator|.
name|Cnt
operator|.
name|v_ozfod
operator|*
literal|100
operator|/
name|s
operator|.
name|Cnt
operator|.
name|v_zfod
else|:
literal|0
operator|)
argument_list|,
name|VMSTATROW
operator|+
literal|13
argument_list|,
name|VMSTATCOL
operator|-
literal|16
argument_list|,
literal|9
argument_list|)
expr_stmt|;
name|PUTRATE
argument_list|(
name|Cnt
operator|.
name|v_tfree
argument_list|,
name|VMSTATROW
operator|+
literal|14
argument_list|,
name|VMSTATCOL
operator|-
literal|16
argument_list|,
literal|9
argument_list|)
expr_stmt|;
block|}
name|putint
argument_list|(
name|s
operator|.
name|bufspace
operator|/
literal|1024
argument_list|,
name|VMSTATROW
operator|+
literal|13
argument_list|,
name|VMSTATCOL
argument_list|,
literal|9
argument_list|)
expr_stmt|;
name|putint
argument_list|(
name|s
operator|.
name|numdirtybuffers
argument_list|,
name|VMSTATROW
operator|+
literal|14
argument_list|,
name|VMSTATCOL
argument_list|,
literal|9
argument_list|)
expr_stmt|;
name|putint
argument_list|(
name|s
operator|.
name|desiredvnodes
argument_list|,
name|VMSTATROW
operator|+
literal|15
argument_list|,
name|VMSTATCOL
argument_list|,
literal|9
argument_list|)
expr_stmt|;
name|putint
argument_list|(
name|s
operator|.
name|numvnodes
argument_list|,
name|VMSTATROW
operator|+
literal|16
argument_list|,
name|VMSTATCOL
argument_list|,
literal|9
argument_list|)
expr_stmt|;
name|putint
argument_list|(
name|s
operator|.
name|freevnodes
argument_list|,
name|VMSTATROW
operator|+
literal|17
argument_list|,
name|VMSTATCOL
argument_list|,
literal|9
argument_list|)
expr_stmt|;
name|PUTRATE
argument_list|(
name|Cnt
operator|.
name|v_vnodein
argument_list|,
name|PAGEROW
operator|+
literal|2
argument_list|,
name|PAGECOL
operator|+
literal|5
argument_list|,
literal|5
argument_list|)
expr_stmt|;
name|PUTRATE
argument_list|(
name|Cnt
operator|.
name|v_vnodeout
argument_list|,
name|PAGEROW
operator|+
literal|2
argument_list|,
name|PAGECOL
operator|+
literal|10
argument_list|,
literal|5
argument_list|)
expr_stmt|;
name|PUTRATE
argument_list|(
name|Cnt
operator|.
name|v_swapin
argument_list|,
name|PAGEROW
operator|+
literal|2
argument_list|,
name|PAGECOL
operator|+
literal|17
argument_list|,
literal|5
argument_list|)
expr_stmt|;
name|PUTRATE
argument_list|(
name|Cnt
operator|.
name|v_swapout
argument_list|,
name|PAGEROW
operator|+
literal|2
argument_list|,
name|PAGECOL
operator|+
literal|22
argument_list|,
literal|5
argument_list|)
expr_stmt|;
name|PUTRATE
argument_list|(
name|Cnt
operator|.
name|v_vnodepgsin
argument_list|,
name|PAGEROW
operator|+
literal|3
argument_list|,
name|PAGECOL
operator|+
literal|5
argument_list|,
literal|5
argument_list|)
expr_stmt|;
name|PUTRATE
argument_list|(
name|Cnt
operator|.
name|v_vnodepgsout
argument_list|,
name|PAGEROW
operator|+
literal|3
argument_list|,
name|PAGECOL
operator|+
literal|10
argument_list|,
literal|5
argument_list|)
expr_stmt|;
name|PUTRATE
argument_list|(
name|Cnt
operator|.
name|v_swappgsin
argument_list|,
name|PAGEROW
operator|+
literal|3
argument_list|,
name|PAGECOL
operator|+
literal|17
argument_list|,
literal|5
argument_list|)
expr_stmt|;
name|PUTRATE
argument_list|(
name|Cnt
operator|.
name|v_swappgsout
argument_list|,
name|PAGEROW
operator|+
literal|3
argument_list|,
name|PAGECOL
operator|+
literal|22
argument_list|,
literal|5
argument_list|)
expr_stmt|;
name|PUTRATE
argument_list|(
name|Cnt
operator|.
name|v_swtch
argument_list|,
name|GENSTATROW
operator|+
literal|1
argument_list|,
name|GENSTATCOL
argument_list|,
literal|5
argument_list|)
expr_stmt|;
name|PUTRATE
argument_list|(
name|Cnt
operator|.
name|v_trap
argument_list|,
name|GENSTATROW
operator|+
literal|1
argument_list|,
name|GENSTATCOL
operator|+
literal|5
argument_list|,
literal|5
argument_list|)
expr_stmt|;
name|PUTRATE
argument_list|(
name|Cnt
operator|.
name|v_syscall
argument_list|,
name|GENSTATROW
operator|+
literal|1
argument_list|,
name|GENSTATCOL
operator|+
literal|10
argument_list|,
literal|5
argument_list|)
expr_stmt|;
name|PUTRATE
argument_list|(
name|Cnt
operator|.
name|v_intr
argument_list|,
name|GENSTATROW
operator|+
literal|1
argument_list|,
name|GENSTATCOL
operator|+
literal|15
argument_list|,
literal|5
argument_list|)
expr_stmt|;
name|PUTRATE
argument_list|(
name|Cnt
operator|.
name|v_soft
argument_list|,
name|GENSTATROW
operator|+
literal|1
argument_list|,
name|GENSTATCOL
operator|+
literal|20
argument_list|,
literal|5
argument_list|)
expr_stmt|;
name|PUTRATE
argument_list|(
name|Cnt
operator|.
name|v_vm_faults
argument_list|,
name|GENSTATROW
operator|+
literal|1
argument_list|,
name|GENSTATCOL
operator|+
literal|25
argument_list|,
literal|5
argument_list|)
expr_stmt|;
name|mvprintw
argument_list|(
name|DISKROW
argument_list|,
name|DISKCOL
operator|+
literal|5
argument_list|,
literal|"                              "
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
operator|,
name|c
operator|=
literal|0
init|;
name|i
operator|<
name|num_devices
operator|&&
name|c
operator|<
name|MAXDRIVES
condition|;
name|i
operator|++
control|)
if|if
condition|(
name|dev_select
index|[
name|i
index|]
operator|.
name|selected
condition|)
block|{
name|char
name|tmpstr
index|[
literal|80
index|]
decl_stmt|;
name|sprintf
argument_list|(
name|tmpstr
argument_list|,
literal|"%s%d"
argument_list|,
name|dev_select
index|[
name|i
index|]
operator|.
name|device_name
argument_list|,
name|dev_select
index|[
name|i
index|]
operator|.
name|unit_number
argument_list|)
expr_stmt|;
name|mvprintw
argument_list|(
name|DISKROW
argument_list|,
name|DISKCOL
operator|+
literal|5
operator|+
literal|6
operator|*
name|c
argument_list|,
literal|" %5.5s"
argument_list|,
name|tmpstr
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|state
condition|)
block|{
case|case
name|TIME
case|:
name|dinfo
argument_list|(
name|i
argument_list|,
operator|++
name|c
argument_list|,
operator|&
name|cur
argument_list|,
operator|&
name|last
argument_list|)
expr_stmt|;
break|break;
case|case
name|RUN
case|:
name|dinfo
argument_list|(
name|i
argument_list|,
operator|++
name|c
argument_list|,
operator|&
name|cur
argument_list|,
operator|&
name|run
argument_list|)
expr_stmt|;
break|break;
case|case
name|BOOT
case|:
name|dinfo
argument_list|(
name|i
argument_list|,
operator|++
name|c
argument_list|,
operator|&
name|cur
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
name|putint
argument_list|(
name|s
operator|.
name|nchcount
argument_list|,
name|NAMEIROW
operator|+
literal|2
argument_list|,
name|NAMEICOL
argument_list|,
literal|9
argument_list|)
expr_stmt|;
name|putint
argument_list|(
operator|(
name|nchtotal
operator|.
name|ncs_goodhits
operator|+
name|nchtotal
operator|.
name|ncs_neghits
operator|)
argument_list|,
name|NAMEIROW
operator|+
literal|2
argument_list|,
name|NAMEICOL
operator|+
literal|9
argument_list|,
literal|9
argument_list|)
expr_stmt|;
define|#
directive|define
name|nz
parameter_list|(
name|x
parameter_list|)
value|((x) ? (x) : 1)
name|putfloat
argument_list|(
operator|(
name|nchtotal
operator|.
name|ncs_goodhits
operator|+
name|nchtotal
operator|.
name|ncs_neghits
operator|)
operator|*
literal|100.0
operator|/
name|nz
argument_list|(
name|s
operator|.
name|nchcount
argument_list|)
argument_list|,
name|NAMEIROW
operator|+
literal|2
argument_list|,
name|NAMEICOL
operator|+
literal|19
argument_list|,
literal|4
argument_list|,
literal|0
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|putint
argument_list|(
name|nchtotal
operator|.
name|ncs_pass2
argument_list|,
name|NAMEIROW
operator|+
literal|2
argument_list|,
name|NAMEICOL
operator|+
literal|23
argument_list|,
literal|9
argument_list|)
expr_stmt|;
name|putfloat
argument_list|(
name|nchtotal
operator|.
name|ncs_pass2
operator|*
literal|100.0
operator|/
name|nz
argument_list|(
name|s
operator|.
name|nchcount
argument_list|)
argument_list|,
name|NAMEIROW
operator|+
literal|2
argument_list|,
name|NAMEICOL
operator|+
literal|33
argument_list|,
literal|4
argument_list|,
literal|0
argument_list|,
literal|1
argument_list|)
expr_stmt|;
undef|#
directive|undef
name|nz
block|}
end_function

begin_function
name|int
name|cmdkre
parameter_list|(
name|cmd
parameter_list|,
name|args
parameter_list|)
name|char
modifier|*
name|cmd
decl_stmt|,
decl|*
name|args
decl_stmt|;
end_function

begin_block
block|{
name|int
name|retval
decl_stmt|;
if|if
condition|(
name|prefix
argument_list|(
name|cmd
argument_list|,
literal|"run"
argument_list|)
condition|)
block|{
name|retval
operator|=
literal|1
expr_stmt|;
name|copyinfo
argument_list|(
operator|&
name|s2
argument_list|,
operator|&
name|s1
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|getdevs
argument_list|(
operator|&
name|run
argument_list|)
condition|)
block|{
case|case
operator|-
literal|1
case|:
name|errx
argument_list|(
literal|1
argument_list|,
literal|"%s"
argument_list|,
name|devstat_errbuf
argument_list|)
expr_stmt|;
break|break;
case|case
literal|1
case|:
name|num_devices
operator|=
name|run
operator|.
name|dinfo
operator|->
name|numdevs
expr_stmt|;
name|generation
operator|=
name|run
operator|.
name|dinfo
operator|->
name|generation
expr_stmt|;
name|retval
operator|=
name|dscmd
argument_list|(
literal|"refresh"
argument_list|,
name|NULL
argument_list|,
name|MAXDRIVES
argument_list|,
operator|&
name|cur
argument_list|)
expr_stmt|;
if|if
condition|(
name|retval
operator|==
literal|2
condition|)
name|labelkre
argument_list|()
expr_stmt|;
break|break;
default|default:
break|break;
block|}
name|state
operator|=
name|RUN
expr_stmt|;
return|return
operator|(
name|retval
operator|)
return|;
block|}
if|if
condition|(
name|prefix
argument_list|(
name|cmd
argument_list|,
literal|"boot"
argument_list|)
condition|)
block|{
name|state
operator|=
name|BOOT
expr_stmt|;
name|copyinfo
argument_list|(
operator|&
name|z
argument_list|,
operator|&
name|s1
argument_list|)
expr_stmt|;
return|return
operator|(
literal|1
operator|)
return|;
block|}
if|if
condition|(
name|prefix
argument_list|(
name|cmd
argument_list|,
literal|"time"
argument_list|)
condition|)
block|{
name|state
operator|=
name|TIME
expr_stmt|;
return|return
operator|(
literal|1
operator|)
return|;
block|}
if|if
condition|(
name|prefix
argument_list|(
name|cmd
argument_list|,
literal|"zero"
argument_list|)
condition|)
block|{
name|retval
operator|=
literal|1
expr_stmt|;
if|if
condition|(
name|state
operator|==
name|RUN
condition|)
block|{
name|getinfo
argument_list|(
operator|&
name|s1
argument_list|,
name|RUN
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|getdevs
argument_list|(
operator|&
name|run
argument_list|)
condition|)
block|{
case|case
operator|-
literal|1
case|:
name|errx
argument_list|(
literal|1
argument_list|,
literal|"%s"
argument_list|,
name|devstat_errbuf
argument_list|)
expr_stmt|;
break|break;
case|case
literal|1
case|:
name|num_devices
operator|=
name|run
operator|.
name|dinfo
operator|->
name|numdevs
expr_stmt|;
name|generation
operator|=
name|run
operator|.
name|dinfo
operator|->
name|generation
expr_stmt|;
name|retval
operator|=
name|dscmd
argument_list|(
literal|"refresh"
argument_list|,
name|NULL
argument_list|,
name|MAXDRIVES
argument_list|,
operator|&
name|cur
argument_list|)
expr_stmt|;
if|if
condition|(
name|retval
operator|==
literal|2
condition|)
name|labelkre
argument_list|()
expr_stmt|;
break|break;
default|default:
break|break;
block|}
block|}
return|return
operator|(
name|retval
operator|)
return|;
block|}
name|retval
operator|=
name|dscmd
argument_list|(
name|cmd
argument_list|,
name|args
argument_list|,
name|MAXDRIVES
argument_list|,
operator|&
name|cur
argument_list|)
expr_stmt|;
if|if
condition|(
name|retval
operator|==
literal|2
condition|)
name|labelkre
argument_list|()
expr_stmt|;
return|return
operator|(
name|retval
operator|)
return|;
block|}
end_block

begin_comment
comment|/* calculate number of users on the system */
end_comment

begin_function
specifier|static
name|int
name|ucount
parameter_list|()
block|{
specifier|register
name|int
name|nusers
init|=
literal|0
decl_stmt|;
if|if
condition|(
name|ut
operator|<
literal|0
condition|)
return|return
operator|(
literal|0
operator|)
return|;
while|while
condition|(
name|read
argument_list|(
name|ut
argument_list|,
operator|&
name|utmp
argument_list|,
sizeof|sizeof
argument_list|(
name|utmp
argument_list|)
argument_list|)
condition|)
if|if
condition|(
name|utmp
operator|.
name|ut_name
index|[
literal|0
index|]
operator|!=
literal|'\0'
condition|)
name|nusers
operator|++
expr_stmt|;
name|lseek
argument_list|(
name|ut
argument_list|,
literal|0L
argument_list|,
name|L_SET
argument_list|)
expr_stmt|;
return|return
operator|(
name|nusers
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|float
name|cputime
parameter_list|(
name|indx
parameter_list|)
name|int
name|indx
decl_stmt|;
block|{
name|double
name|t
decl_stmt|;
specifier|register
name|int
name|i
decl_stmt|;
name|t
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|CPUSTATES
condition|;
name|i
operator|++
control|)
name|t
operator|+=
name|s
operator|.
name|time
index|[
name|i
index|]
expr_stmt|;
if|if
condition|(
name|t
operator|==
literal|0.0
condition|)
name|t
operator|=
literal|1.0
expr_stmt|;
return|return
operator|(
name|s
operator|.
name|time
index|[
name|indx
index|]
operator|*
literal|100.0
operator|/
name|t
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|putint
parameter_list|(
name|n
parameter_list|,
name|l
parameter_list|,
name|c
parameter_list|,
name|w
parameter_list|)
name|int
name|n
decl_stmt|,
name|l
decl_stmt|,
name|c
decl_stmt|,
name|w
decl_stmt|;
block|{
name|char
name|b
index|[
literal|128
index|]
decl_stmt|;
name|move
argument_list|(
name|l
argument_list|,
name|c
argument_list|)
expr_stmt|;
if|if
condition|(
name|n
operator|==
literal|0
condition|)
block|{
while|while
condition|(
name|w
operator|--
operator|>
literal|0
condition|)
name|addch
argument_list|(
literal|' '
argument_list|)
expr_stmt|;
return|return;
block|}
name|snprintf
argument_list|(
name|b
argument_list|,
sizeof|sizeof
argument_list|(
name|b
argument_list|)
argument_list|,
literal|"%*d"
argument_list|,
name|w
argument_list|,
name|n
argument_list|)
expr_stmt|;
if|if
condition|(
name|strlen
argument_list|(
name|b
argument_list|)
operator|>
name|w
condition|)
block|{
while|while
condition|(
name|w
operator|--
operator|>
literal|0
condition|)
name|addch
argument_list|(
literal|'*'
argument_list|)
expr_stmt|;
return|return;
block|}
name|addstr
argument_list|(
name|b
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|putfloat
parameter_list|(
name|f
parameter_list|,
name|l
parameter_list|,
name|c
parameter_list|,
name|w
parameter_list|,
name|d
parameter_list|,
name|nz
parameter_list|)
name|double
name|f
decl_stmt|;
name|int
name|l
decl_stmt|,
name|c
decl_stmt|,
name|w
decl_stmt|,
name|d
decl_stmt|,
name|nz
decl_stmt|;
block|{
name|char
name|b
index|[
literal|128
index|]
decl_stmt|;
name|move
argument_list|(
name|l
argument_list|,
name|c
argument_list|)
expr_stmt|;
if|if
condition|(
name|nz
operator|&&
name|f
operator|==
literal|0.0
condition|)
block|{
while|while
condition|(
operator|--
name|w
operator|>=
literal|0
condition|)
name|addch
argument_list|(
literal|' '
argument_list|)
expr_stmt|;
return|return;
block|}
name|snprintf
argument_list|(
name|b
argument_list|,
sizeof|sizeof
argument_list|(
name|b
argument_list|)
argument_list|,
literal|"%*.*f"
argument_list|,
name|w
argument_list|,
name|d
argument_list|,
name|f
argument_list|)
expr_stmt|;
if|if
condition|(
name|strlen
argument_list|(
name|b
argument_list|)
operator|>
name|w
condition|)
name|snprintf
argument_list|(
name|b
argument_list|,
sizeof|sizeof
argument_list|(
name|b
argument_list|)
argument_list|,
literal|"%*.0f"
argument_list|,
name|w
argument_list|,
name|f
argument_list|)
expr_stmt|;
if|if
condition|(
name|strlen
argument_list|(
name|b
argument_list|)
operator|>
name|w
condition|)
block|{
while|while
condition|(
operator|--
name|w
operator|>=
literal|0
condition|)
name|addch
argument_list|(
literal|'*'
argument_list|)
expr_stmt|;
return|return;
block|}
name|addstr
argument_list|(
name|b
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|putlongdouble
parameter_list|(
name|f
parameter_list|,
name|l
parameter_list|,
name|c
parameter_list|,
name|w
parameter_list|,
name|d
parameter_list|,
name|nz
parameter_list|)
name|long
name|double
name|f
decl_stmt|;
name|int
name|l
decl_stmt|,
name|c
decl_stmt|,
name|w
decl_stmt|,
name|d
decl_stmt|,
name|nz
decl_stmt|;
block|{
name|char
name|b
index|[
literal|128
index|]
decl_stmt|;
name|move
argument_list|(
name|l
argument_list|,
name|c
argument_list|)
expr_stmt|;
if|if
condition|(
name|nz
operator|&&
name|f
operator|==
literal|0.0
condition|)
block|{
while|while
condition|(
operator|--
name|w
operator|>=
literal|0
condition|)
name|addch
argument_list|(
literal|' '
argument_list|)
expr_stmt|;
return|return;
block|}
name|sprintf
argument_list|(
name|b
argument_list|,
literal|"%*.*Lf"
argument_list|,
name|w
argument_list|,
name|d
argument_list|,
name|f
argument_list|)
expr_stmt|;
if|if
condition|(
name|strlen
argument_list|(
name|b
argument_list|)
operator|>
name|w
condition|)
name|sprintf
argument_list|(
name|b
argument_list|,
literal|"%*.0Lf"
argument_list|,
name|w
argument_list|,
name|f
argument_list|)
expr_stmt|;
if|if
condition|(
name|strlen
argument_list|(
name|b
argument_list|)
operator|>
name|w
condition|)
block|{
while|while
condition|(
operator|--
name|w
operator|>=
literal|0
condition|)
name|addch
argument_list|(
literal|'*'
argument_list|)
expr_stmt|;
return|return;
block|}
name|addstr
argument_list|(
name|b
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|getinfo
parameter_list|(
name|s
parameter_list|,
name|st
parameter_list|)
name|struct
name|Info
modifier|*
name|s
decl_stmt|;
name|enum
name|state
name|st
decl_stmt|;
block|{
name|struct
name|devinfo
modifier|*
name|tmp_dinfo
decl_stmt|;
name|size_t
name|size
decl_stmt|;
name|int
name|mib
index|[
literal|2
index|]
decl_stmt|;
name|NREAD
argument_list|(
name|X_CPTIME
argument_list|,
name|s
operator|->
name|time
argument_list|,
sizeof|sizeof
name|s
operator|->
name|time
argument_list|)
expr_stmt|;
name|NREAD
argument_list|(
name|X_CPTIME
argument_list|,
name|cur
operator|.
name|cp_time
argument_list|,
sizeof|sizeof
argument_list|(
name|cur
operator|.
name|cp_time
argument_list|)
argument_list|)
expr_stmt|;
name|NREAD
argument_list|(
name|X_CNT
argument_list|,
operator|&
name|s
operator|->
name|Cnt
argument_list|,
sizeof|sizeof
name|s
operator|->
name|Cnt
argument_list|)
expr_stmt|;
name|NREAD
argument_list|(
name|X_BUFFERSPACE
argument_list|,
operator|&
name|s
operator|->
name|bufspace
argument_list|,
sizeof|sizeof
argument_list|(
name|s
operator|->
name|bufspace
argument_list|)
argument_list|)
expr_stmt|;
name|NREAD
argument_list|(
name|X_DESIREDVNODES
argument_list|,
operator|&
name|s
operator|->
name|desiredvnodes
argument_list|,
sizeof|sizeof
argument_list|(
name|s
operator|->
name|desiredvnodes
argument_list|)
argument_list|)
expr_stmt|;
name|NREAD
argument_list|(
name|X_NUMVNODES
argument_list|,
operator|&
name|s
operator|->
name|numvnodes
argument_list|,
name|LONG
argument_list|)
expr_stmt|;
name|NREAD
argument_list|(
name|X_FREEVNODES
argument_list|,
operator|&
name|s
operator|->
name|freevnodes
argument_list|,
name|LONG
argument_list|)
expr_stmt|;
name|NREAD
argument_list|(
name|X_NCHSTATS
argument_list|,
operator|&
name|s
operator|->
name|nchstats
argument_list|,
sizeof|sizeof
name|s
operator|->
name|nchstats
argument_list|)
expr_stmt|;
name|NREAD
argument_list|(
name|X_INTRCNT
argument_list|,
name|s
operator|->
name|intrcnt
argument_list|,
name|nintr
operator|*
name|LONG
argument_list|)
expr_stmt|;
name|NREAD
argument_list|(
name|X_NUMDIRTYBUFFERS
argument_list|,
operator|&
name|s
operator|->
name|numdirtybuffers
argument_list|,
sizeof|sizeof
argument_list|(
name|s
operator|->
name|numdirtybuffers
argument_list|)
argument_list|)
expr_stmt|;
name|size
operator|=
sizeof|sizeof
argument_list|(
name|s
operator|->
name|Total
argument_list|)
expr_stmt|;
name|mib
index|[
literal|0
index|]
operator|=
name|CTL_VM
expr_stmt|;
name|mib
index|[
literal|1
index|]
operator|=
name|VM_METER
expr_stmt|;
if|if
condition|(
name|sysctl
argument_list|(
name|mib
argument_list|,
literal|2
argument_list|,
operator|&
name|s
operator|->
name|Total
argument_list|,
operator|&
name|size
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
operator|<
literal|0
condition|)
block|{
name|error
argument_list|(
literal|"Can't get kernel info: %s\n"
argument_list|,
name|strerror
argument_list|(
name|errno
argument_list|)
argument_list|)
expr_stmt|;
name|bzero
argument_list|(
operator|&
name|s
operator|->
name|Total
argument_list|,
sizeof|sizeof
argument_list|(
name|s
operator|->
name|Total
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|size
operator|=
sizeof|sizeof
argument_list|(
name|ncpu
argument_list|)
expr_stmt|;
if|if
condition|(
name|sysctlbyname
argument_list|(
literal|"hw.ncpu"
argument_list|,
operator|&
name|ncpu
argument_list|,
operator|&
name|size
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
operator|<
literal|0
condition|)
name|ncpu
operator|=
literal|1
expr_stmt|;
name|tmp_dinfo
operator|=
name|last
operator|.
name|dinfo
expr_stmt|;
name|last
operator|.
name|dinfo
operator|=
name|cur
operator|.
name|dinfo
expr_stmt|;
name|cur
operator|.
name|dinfo
operator|=
name|tmp_dinfo
expr_stmt|;
name|last
operator|.
name|busy_time
operator|=
name|cur
operator|.
name|busy_time
expr_stmt|;
switch|switch
condition|(
name|getdevs
argument_list|(
operator|&
name|cur
argument_list|)
condition|)
block|{
case|case
operator|-
literal|1
case|:
name|errx
argument_list|(
literal|1
argument_list|,
literal|"%s"
argument_list|,
name|devstat_errbuf
argument_list|)
expr_stmt|;
break|break;
case|case
literal|1
case|:
name|num_devices
operator|=
name|cur
operator|.
name|dinfo
operator|->
name|numdevs
expr_stmt|;
name|generation
operator|=
name|cur
operator|.
name|dinfo
operator|->
name|generation
expr_stmt|;
name|cmdkre
argument_list|(
literal|"refresh"
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
break|break;
default|default:
break|break;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|allocinfo
parameter_list|(
name|s
parameter_list|)
name|struct
name|Info
modifier|*
name|s
decl_stmt|;
block|{
name|s
operator|->
name|intrcnt
operator|=
operator|(
name|long
operator|*
operator|)
name|calloc
argument_list|(
name|nintr
argument_list|,
sizeof|sizeof
argument_list|(
name|long
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|s
operator|->
name|intrcnt
operator|==
name|NULL
condition|)
name|errx
argument_list|(
literal|2
argument_list|,
literal|"out of memory"
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|copyinfo
parameter_list|(
name|from
parameter_list|,
name|to
parameter_list|)
specifier|register
name|struct
name|Info
modifier|*
name|from
decl_stmt|,
decl|*
name|to
decl_stmt|;
end_function

begin_block
block|{
name|long
modifier|*
name|intrcnt
decl_stmt|;
comment|/* 	 * time, wds, seek, and xfer are malloc'd so we have to 	 * save the pointers before the structure copy and then 	 * copy by hand. 	 */
name|intrcnt
operator|=
name|to
operator|->
name|intrcnt
expr_stmt|;
operator|*
name|to
operator|=
operator|*
name|from
expr_stmt|;
name|bcopy
argument_list|(
name|from
operator|->
name|intrcnt
argument_list|,
name|to
operator|->
name|intrcnt
operator|=
name|intrcnt
argument_list|,
name|nintr
operator|*
sizeof|sizeof
argument_list|(
name|int
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_block

begin_function
specifier|static
name|void
name|dinfo
parameter_list|(
name|dn
parameter_list|,
name|c
parameter_list|,
name|now
parameter_list|,
name|then
parameter_list|)
name|int
name|dn
decl_stmt|,
name|c
decl_stmt|;
name|struct
name|statinfo
modifier|*
name|now
decl_stmt|,
decl|*
name|then
decl_stmt|;
end_function

begin_block
block|{
name|long
name|double
name|transfers_per_second
decl_stmt|;
name|long
name|double
name|kb_per_transfer
decl_stmt|,
name|mb_per_second
decl_stmt|;
name|long
name|double
name|elapsed_time
decl_stmt|,
name|device_busy
decl_stmt|;
name|int
name|di
decl_stmt|;
name|di
operator|=
name|dev_select
index|[
name|dn
index|]
operator|.
name|position
expr_stmt|;
name|elapsed_time
operator|=
name|compute_etime
argument_list|(
name|now
operator|->
name|busy_time
argument_list|,
name|then
condition|?
name|then
operator|->
name|busy_time
else|:
name|now
operator|->
name|dinfo
operator|->
name|devices
index|[
name|di
index|]
operator|.
name|dev_creation_time
argument_list|)
expr_stmt|;
name|device_busy
operator|=
name|compute_etime
argument_list|(
name|now
operator|->
name|dinfo
operator|->
name|devices
index|[
name|di
index|]
operator|.
name|busy_time
argument_list|,
name|then
condition|?
name|then
operator|->
name|dinfo
operator|->
name|devices
index|[
name|di
index|]
operator|.
name|busy_time
else|:
name|now
operator|->
name|dinfo
operator|->
name|devices
index|[
name|di
index|]
operator|.
name|dev_creation_time
argument_list|)
expr_stmt|;
if|if
condition|(
name|compute_stats
argument_list|(
operator|&
name|now
operator|->
name|dinfo
operator|->
name|devices
index|[
name|di
index|]
argument_list|,
name|then
condition|?
operator|&
name|then
operator|->
name|dinfo
operator|->
name|devices
index|[
name|di
index|]
else|:
name|NULL
argument_list|,
name|elapsed_time
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
operator|&
name|kb_per_transfer
argument_list|,
operator|&
name|transfers_per_second
argument_list|,
operator|&
name|mb_per_second
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
operator|!=
literal|0
condition|)
name|errx
argument_list|(
literal|1
argument_list|,
literal|"%s"
argument_list|,
name|devstat_errbuf
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|device_busy
operator|==
literal|0
operator|)
operator|&&
operator|(
name|transfers_per_second
operator|>
literal|5
operator|)
condition|)
comment|/* the device has been 100% busy, fake it because 		 * as long as the device is 100% busy the busy_time 		 * field in the devstat struct is not updated */
name|device_busy
operator|=
name|elapsed_time
expr_stmt|;
if|if
condition|(
name|device_busy
operator|>
name|elapsed_time
condition|)
comment|/* this normally happens after one or more periods 		 * where the device has been 100% busy, correct it */
name|device_busy
operator|=
name|elapsed_time
expr_stmt|;
name|c
operator|=
name|DISKCOL
operator|+
name|c
operator|*
literal|6
expr_stmt|;
name|putlongdouble
argument_list|(
name|kb_per_transfer
argument_list|,
name|DISKROW
operator|+
literal|1
argument_list|,
name|c
argument_list|,
literal|5
argument_list|,
literal|2
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|putlongdouble
argument_list|(
name|transfers_per_second
argument_list|,
name|DISKROW
operator|+
literal|2
argument_list|,
name|c
argument_list|,
literal|5
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|putlongdouble
argument_list|(
name|mb_per_second
argument_list|,
name|DISKROW
operator|+
literal|3
argument_list|,
name|c
argument_list|,
literal|5
argument_list|,
literal|2
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|putlongdouble
argument_list|(
name|device_busy
operator|*
literal|100
operator|/
name|elapsed_time
argument_list|,
name|DISKROW
operator|+
literal|4
argument_list|,
name|c
argument_list|,
literal|5
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
end_block

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*-  * Copyright (c) 1980, 1992, 1993  *	The Regents of the University of California.  All rights reserved.  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions  * are met:  * 1. Redistributions of source code must retain the above copyright  *    notice, this list of conditions and the following disclaimer.  * 2. Redistributions in binary form must reproduce the above copyright  *    notice, this list of conditions and the following disclaimer in the  *    documentation and/or other materials provided with the distribution.  * 3. All advertising materials mentioning features or use of this software  *    must display the following acknowledgement:  *	This product includes software developed by the University of  *	California, Berkeley and its contributors.  * 4. Neither the name of the University nor the names of its contributors  *    may be used to endorse or promote products derived from this software  *    without specific prior written permission.  *  * THIS SOFTWARE IS PROVIDED BY THE REGENTS AND CONTRIBUTORS ``AS IS'' AND  * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE  * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE  * ARE DISCLAIMED.  IN NO EVENT SHALL THE REGENTS OR CONTRIBUTORS BE LIABLE  * FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL  * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS  * OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)  * HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT  * LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY  * OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF  * SUCH DAMAGE.  */
end_comment

begin_include
include|#
directive|include
file|<sys/cdefs.h>
end_include

begin_expr_stmt
name|__FBSDID
argument_list|(
literal|"$FreeBSD$"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_ifdef
ifdef|#
directive|ifdef
name|lint
end_ifdef

begin_decl_stmt
specifier|static
name|char
name|sccsid
index|[]
init|=
literal|"@(#)mbufs.c	8.1 (Berkeley) 6/6/93"
decl_stmt|;
end_decl_stmt

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* From: 	"Id: mbufs.c,v 1.5 1997/02/24 20:59:03 wollman Exp" */
end_comment

begin_include
include|#
directive|include
file|<sys/param.h>
end_include

begin_include
include|#
directive|include
file|<sys/types.h>
end_include

begin_include
include|#
directive|include
file|<sys/socket.h>
end_include

begin_include
include|#
directive|include
file|<sys/sysctl.h>
end_include

begin_include
include|#
directive|include
file|<netinet/in.h>
end_include

begin_include
include|#
directive|include
file|<netinet/in_systm.h>
end_include

begin_include
include|#
directive|include
file|<netinet/ip.h>
end_include

begin_include
include|#
directive|include
file|<netinet/ip_icmp.h>
end_include

begin_include
include|#
directive|include
file|<netinet/icmp_var.h>
end_include

begin_include
include|#
directive|include
file|<stdlib.h>
end_include

begin_include
include|#
directive|include
file|<string.h>
end_include

begin_include
include|#
directive|include
file|<paths.h>
end_include

begin_include
include|#
directive|include
file|"systat.h"
end_include

begin_include
include|#
directive|include
file|"extern.h"
end_include

begin_include
include|#
directive|include
file|"mode.h"
end_include

begin_decl_stmt
specifier|static
name|struct
name|icmpstat
name|icmpstat
decl_stmt|,
name|initstat
decl_stmt|,
name|oldstat
decl_stmt|;
end_decl_stmt

begin_comment
comment|/*- --0         1         2         3         4         5         6         7 --0123456789012345678901234567890123456789012345678901234567890123456789012345 00          ICMP Input                         ICMP Output 01999999999 total messages           999999999 total messages 02999999999 with bad code            999999999 errors generated 03999999999 with bad length          999999999 suppressed - original too short 04999999999 with bad checksum        999999999 suppressed - original was ICMP 05999999999 with insufficient data   999999999 responses sent 06                                   999999999 suppressed - multicast echo 07                                   999999999 suppressed - multicast tstamp 08 09          Input Histogram                    Output Histogram 10999999999 echo response            999999999 echo response 11999999999 echo request             999999999 echo request 12999999999 destination unreachable  999999999 destination unreachable 13999999999 redirect                 999999999 redirect 14999999999 time-to-live exceeded    999999999 time-to-line exceeded 15999999999 parameter problem        999999999 parameter problem 16999999999 router advertisement     999999999 router solicitation 17 18 --0123456789012345678901234567890123456789012345678901234567890123456789012345 --0         1         2         3         4         5         6         7 */
end_comment

begin_function
name|WINDOW
modifier|*
name|openicmp
parameter_list|(
name|void
parameter_list|)
block|{
return|return
operator|(
name|subwin
argument_list|(
name|stdscr
argument_list|,
name|LINES
operator|-
literal|3
operator|-
literal|1
argument_list|,
literal|0
argument_list|,
name|MAINWIN_ROW
argument_list|,
literal|0
argument_list|)
operator|)
return|;
block|}
end_function

begin_function
name|void
name|closeicmp
parameter_list|(
name|w
parameter_list|)
name|WINDOW
modifier|*
name|w
decl_stmt|;
block|{
if|if
condition|(
name|w
operator|==
name|NULL
condition|)
return|return;
name|wclear
argument_list|(
name|w
argument_list|)
expr_stmt|;
name|wrefresh
argument_list|(
name|w
argument_list|)
expr_stmt|;
name|delwin
argument_list|(
name|w
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|labelicmp
parameter_list|(
name|void
parameter_list|)
block|{
name|wmove
argument_list|(
name|wnd
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|wclrtoeol
argument_list|(
name|wnd
argument_list|)
expr_stmt|;
define|#
directive|define
name|L
parameter_list|(
name|row
parameter_list|,
name|str
parameter_list|)
value|mvwprintw(wnd, row, 10, str)
define|#
directive|define
name|R
parameter_list|(
name|row
parameter_list|,
name|str
parameter_list|)
value|mvwprintw(wnd, row, 45, str);
name|L
argument_list|(
literal|0
argument_list|,
literal|"ICMP Input"
argument_list|)
expr_stmt|;
name|R
argument_list|(
literal|0
argument_list|,
literal|"ICMP Output"
argument_list|)
expr_stmt|;
name|L
argument_list|(
literal|1
argument_list|,
literal|"total messages"
argument_list|)
expr_stmt|;
name|R
argument_list|(
literal|1
argument_list|,
literal|"total messages"
argument_list|)
expr_stmt|;
name|L
argument_list|(
literal|2
argument_list|,
literal|"with bad code"
argument_list|)
expr_stmt|;
name|R
argument_list|(
literal|2
argument_list|,
literal|"errors generated"
argument_list|)
expr_stmt|;
name|L
argument_list|(
literal|3
argument_list|,
literal|"with bad length"
argument_list|)
expr_stmt|;
name|R
argument_list|(
literal|3
argument_list|,
literal|"suppressed - original too short"
argument_list|)
expr_stmt|;
name|L
argument_list|(
literal|4
argument_list|,
literal|"with bad checksum"
argument_list|)
expr_stmt|;
name|R
argument_list|(
literal|4
argument_list|,
literal|"suppressed - original was ICMP"
argument_list|)
expr_stmt|;
name|L
argument_list|(
literal|5
argument_list|,
literal|"with insufficient data"
argument_list|)
expr_stmt|;
name|R
argument_list|(
literal|5
argument_list|,
literal|"responses sent"
argument_list|)
expr_stmt|;
name|R
argument_list|(
literal|6
argument_list|,
literal|"suppressed - multicast echo"
argument_list|)
expr_stmt|;
name|R
argument_list|(
literal|7
argument_list|,
literal|"suppressed - multicast tstamp"
argument_list|)
expr_stmt|;
name|L
argument_list|(
literal|9
argument_list|,
literal|"Input Histogram"
argument_list|)
expr_stmt|;
name|R
argument_list|(
literal|9
argument_list|,
literal|"Output Histogram"
argument_list|)
expr_stmt|;
define|#
directive|define
name|B
parameter_list|(
name|row
parameter_list|,
name|str
parameter_list|)
value|L(row, str); R(row, str)
name|B
argument_list|(
literal|10
argument_list|,
literal|"echo response"
argument_list|)
expr_stmt|;
name|B
argument_list|(
literal|11
argument_list|,
literal|"echo request"
argument_list|)
expr_stmt|;
name|B
argument_list|(
literal|12
argument_list|,
literal|"destination unreachable"
argument_list|)
expr_stmt|;
name|B
argument_list|(
literal|13
argument_list|,
literal|"redirect"
argument_list|)
expr_stmt|;
name|B
argument_list|(
literal|14
argument_list|,
literal|"time-to-live exceeded"
argument_list|)
expr_stmt|;
name|B
argument_list|(
literal|15
argument_list|,
literal|"parameter problem"
argument_list|)
expr_stmt|;
name|L
argument_list|(
literal|16
argument_list|,
literal|"router advertisement"
argument_list|)
expr_stmt|;
name|R
argument_list|(
literal|16
argument_list|,
literal|"router solicitation"
argument_list|)
expr_stmt|;
undef|#
directive|undef
name|L
undef|#
directive|undef
name|R
undef|#
directive|undef
name|B
block|}
end_function

begin_function
specifier|static
name|void
name|domode
parameter_list|(
name|struct
name|icmpstat
modifier|*
name|ret
parameter_list|)
block|{
specifier|const
name|struct
name|icmpstat
modifier|*
name|sub
decl_stmt|;
name|int
name|i
decl_stmt|,
name|divisor
init|=
literal|1
decl_stmt|;
switch|switch
condition|(
name|currentmode
condition|)
block|{
case|case
name|display_RATE
case|:
name|sub
operator|=
operator|&
name|oldstat
expr_stmt|;
name|divisor
operator|=
name|naptime
expr_stmt|;
break|break;
case|case
name|display_DELTA
case|:
name|sub
operator|=
operator|&
name|oldstat
expr_stmt|;
break|break;
case|case
name|display_SINCE
case|:
name|sub
operator|=
operator|&
name|initstat
expr_stmt|;
break|break;
default|default:
operator|*
name|ret
operator|=
name|icmpstat
expr_stmt|;
return|return;
block|}
define|#
directive|define
name|DO
parameter_list|(
name|stat
parameter_list|)
value|ret->stat = (icmpstat.stat - sub->stat) / divisor
name|DO
argument_list|(
name|icps_error
argument_list|)
expr_stmt|;
name|DO
argument_list|(
name|icps_oldshort
argument_list|)
expr_stmt|;
name|DO
argument_list|(
name|icps_oldicmp
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<=
name|ICMP_MAXTYPE
condition|;
name|i
operator|++
control|)
block|{
name|DO
argument_list|(
name|icps_outhist
index|[
name|i
index|]
argument_list|)
expr_stmt|;
block|}
name|DO
argument_list|(
name|icps_badcode
argument_list|)
expr_stmt|;
name|DO
argument_list|(
name|icps_tooshort
argument_list|)
expr_stmt|;
name|DO
argument_list|(
name|icps_checksum
argument_list|)
expr_stmt|;
name|DO
argument_list|(
name|icps_badlen
argument_list|)
expr_stmt|;
name|DO
argument_list|(
name|icps_reflect
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<=
name|ICMP_MAXTYPE
condition|;
name|i
operator|++
control|)
block|{
name|DO
argument_list|(
name|icps_inhist
index|[
name|i
index|]
argument_list|)
expr_stmt|;
block|}
name|DO
argument_list|(
name|icps_bmcastecho
argument_list|)
expr_stmt|;
name|DO
argument_list|(
name|icps_bmcasttstamp
argument_list|)
expr_stmt|;
undef|#
directive|undef
name|DO
block|}
end_function

begin_function
name|void
name|showicmp
parameter_list|(
name|void
parameter_list|)
block|{
name|struct
name|icmpstat
name|stats
decl_stmt|;
name|u_long
name|totalin
decl_stmt|,
name|totalout
decl_stmt|;
name|int
name|i
decl_stmt|;
name|memset
argument_list|(
operator|&
name|stats
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
name|stats
argument_list|)
expr_stmt|;
name|domode
argument_list|(
operator|&
name|stats
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
name|totalin
operator|=
name|totalout
operator|=
literal|0
init|;
name|i
operator|<=
name|ICMP_MAXTYPE
condition|;
name|i
operator|++
control|)
block|{
name|totalin
operator|+=
name|stats
operator|.
name|icps_inhist
index|[
name|i
index|]
expr_stmt|;
name|totalout
operator|+=
name|stats
operator|.
name|icps_outhist
index|[
name|i
index|]
expr_stmt|;
block|}
name|totalin
operator|+=
name|stats
operator|.
name|icps_badcode
operator|+
name|stats
operator|.
name|icps_badlen
operator|+
name|stats
operator|.
name|icps_checksum
operator|+
name|stats
operator|.
name|icps_tooshort
expr_stmt|;
name|mvwprintw
argument_list|(
name|wnd
argument_list|,
literal|1
argument_list|,
literal|0
argument_list|,
literal|"%9lu"
argument_list|,
name|totalin
argument_list|)
expr_stmt|;
name|mvwprintw
argument_list|(
name|wnd
argument_list|,
literal|1
argument_list|,
literal|35
argument_list|,
literal|"%9lu"
argument_list|,
name|totalout
argument_list|)
expr_stmt|;
define|#
directive|define
name|DO
parameter_list|(
name|stat
parameter_list|,
name|row
parameter_list|,
name|col
parameter_list|)
define|\
value|mvwprintw(wnd, row, col, "%9lu", stats.stat)
name|DO
argument_list|(
name|icps_badcode
argument_list|,
literal|2
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|DO
argument_list|(
name|icps_badlen
argument_list|,
literal|3
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|DO
argument_list|(
name|icps_checksum
argument_list|,
literal|4
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|DO
argument_list|(
name|icps_tooshort
argument_list|,
literal|5
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|DO
argument_list|(
name|icps_error
argument_list|,
literal|2
argument_list|,
literal|35
argument_list|)
expr_stmt|;
name|DO
argument_list|(
name|icps_oldshort
argument_list|,
literal|3
argument_list|,
literal|35
argument_list|)
expr_stmt|;
name|DO
argument_list|(
name|icps_oldicmp
argument_list|,
literal|4
argument_list|,
literal|35
argument_list|)
expr_stmt|;
name|DO
argument_list|(
name|icps_reflect
argument_list|,
literal|5
argument_list|,
literal|35
argument_list|)
expr_stmt|;
name|DO
argument_list|(
name|icps_bmcastecho
argument_list|,
literal|6
argument_list|,
literal|35
argument_list|)
expr_stmt|;
name|DO
argument_list|(
name|icps_bmcasttstamp
argument_list|,
literal|7
argument_list|,
literal|35
argument_list|)
expr_stmt|;
define|#
directive|define
name|DO2
parameter_list|(
name|type
parameter_list|,
name|row
parameter_list|)
value|DO(icps_inhist[type], row, 0); DO(icps_outhist[type], \ 							 row, 35)
name|DO2
argument_list|(
name|ICMP_ECHOREPLY
argument_list|,
literal|10
argument_list|)
expr_stmt|;
name|DO2
argument_list|(
name|ICMP_ECHO
argument_list|,
literal|11
argument_list|)
expr_stmt|;
name|DO2
argument_list|(
name|ICMP_UNREACH
argument_list|,
literal|12
argument_list|)
expr_stmt|;
name|DO2
argument_list|(
name|ICMP_REDIRECT
argument_list|,
literal|13
argument_list|)
expr_stmt|;
name|DO2
argument_list|(
name|ICMP_TIMXCEED
argument_list|,
literal|14
argument_list|)
expr_stmt|;
name|DO2
argument_list|(
name|ICMP_PARAMPROB
argument_list|,
literal|15
argument_list|)
expr_stmt|;
name|DO
argument_list|(
name|icps_inhist
index|[
name|ICMP_ROUTERADVERT
index|]
argument_list|,
literal|16
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|DO
argument_list|(
name|icps_outhist
index|[
name|ICMP_ROUTERSOLICIT
index|]
argument_list|,
literal|16
argument_list|,
literal|35
argument_list|)
expr_stmt|;
undef|#
directive|undef
name|DO
undef|#
directive|undef
name|DO2
block|}
end_function

begin_function
name|int
name|initicmp
parameter_list|(
name|void
parameter_list|)
block|{
name|size_t
name|len
decl_stmt|;
name|int
name|name
index|[
literal|4
index|]
decl_stmt|;
name|name
index|[
literal|0
index|]
operator|=
name|CTL_NET
expr_stmt|;
name|name
index|[
literal|1
index|]
operator|=
name|PF_INET
expr_stmt|;
name|name
index|[
literal|2
index|]
operator|=
name|IPPROTO_ICMP
expr_stmt|;
name|name
index|[
literal|3
index|]
operator|=
name|ICMPCTL_STATS
expr_stmt|;
name|len
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|sysctl
argument_list|(
name|name
argument_list|,
literal|4
argument_list|,
literal|0
argument_list|,
operator|&
name|len
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
operator|<
literal|0
condition|)
block|{
name|error
argument_list|(
literal|"sysctl getting icmpstat size failed"
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
if|if
condition|(
name|len
operator|>
sizeof|sizeof
name|icmpstat
condition|)
block|{
name|error
argument_list|(
literal|"icmpstat structure has grown--recompile systat!"
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
if|if
condition|(
name|sysctl
argument_list|(
name|name
argument_list|,
literal|4
argument_list|,
operator|&
name|initstat
argument_list|,
operator|&
name|len
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
operator|<
literal|0
condition|)
block|{
name|error
argument_list|(
literal|"sysctl getting icmpstat size failed"
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
name|oldstat
operator|=
name|initstat
expr_stmt|;
return|return
literal|1
return|;
block|}
end_function

begin_function
name|void
name|reseticmp
parameter_list|(
name|void
parameter_list|)
block|{
name|size_t
name|len
decl_stmt|;
name|int
name|name
index|[
literal|4
index|]
decl_stmt|;
name|name
index|[
literal|0
index|]
operator|=
name|CTL_NET
expr_stmt|;
name|name
index|[
literal|1
index|]
operator|=
name|PF_INET
expr_stmt|;
name|name
index|[
literal|2
index|]
operator|=
name|IPPROTO_ICMP
expr_stmt|;
name|name
index|[
literal|3
index|]
operator|=
name|ICMPCTL_STATS
expr_stmt|;
name|len
operator|=
sizeof|sizeof
name|initstat
expr_stmt|;
if|if
condition|(
name|sysctl
argument_list|(
name|name
argument_list|,
literal|4
argument_list|,
operator|&
name|initstat
argument_list|,
operator|&
name|len
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
operator|<
literal|0
condition|)
block|{
name|error
argument_list|(
literal|"sysctl getting icmpstat size failed"
argument_list|)
expr_stmt|;
block|}
name|oldstat
operator|=
name|initstat
expr_stmt|;
block|}
end_function

begin_function
name|void
name|fetchicmp
parameter_list|(
name|void
parameter_list|)
block|{
name|int
name|name
index|[
literal|4
index|]
decl_stmt|;
name|size_t
name|len
decl_stmt|;
name|oldstat
operator|=
name|icmpstat
expr_stmt|;
name|name
index|[
literal|0
index|]
operator|=
name|CTL_NET
expr_stmt|;
name|name
index|[
literal|1
index|]
operator|=
name|PF_INET
expr_stmt|;
name|name
index|[
literal|2
index|]
operator|=
name|IPPROTO_ICMP
expr_stmt|;
name|name
index|[
literal|3
index|]
operator|=
name|ICMPCTL_STATS
expr_stmt|;
name|len
operator|=
sizeof|sizeof
name|icmpstat
expr_stmt|;
if|if
condition|(
name|sysctl
argument_list|(
name|name
argument_list|,
literal|4
argument_list|,
operator|&
name|icmpstat
argument_list|,
operator|&
name|len
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
operator|<
literal|0
condition|)
return|return;
block|}
end_function

end_unit


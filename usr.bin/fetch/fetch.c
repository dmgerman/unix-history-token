begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*-  * Copyright (c) 2000 Dag-Erling Coïdan Smørgrav  * All rights reserved.  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions  * are met:  * 1. Redistributions of source code must retain the above copyright  *    notice, this list of conditions and the following disclaimer  *    in this position and unchanged.  * 2. Redistributions in binary form must reproduce the above copyright  *    notice, this list of conditions and the following disclaimer in the  *    documentation and/or other materials provided with the distribution.  * 3. The name of the author may not be used to endorse or promote products  *    derived from this software without specific prior written permission  *  * THIS SOFTWARE IS PROVIDED BY THE AUTHOR ``AS IS'' AND ANY EXPRESS OR  * IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES  * OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED.  * IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY DIRECT, INDIRECT,  * INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT  * NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,  * DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY  * THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT  * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF  * THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.  *  *	$FreeBSD$  */
end_comment

begin_include
include|#
directive|include
file|<sys/param.h>
end_include

begin_include
include|#
directive|include
file|<sys/stat.h>
end_include

begin_include
include|#
directive|include
file|<sys/socket.h>
end_include

begin_include
include|#
directive|include
file|<ctype.h>
end_include

begin_include
include|#
directive|include
file|<err.h>
end_include

begin_include
include|#
directive|include
file|<errno.h>
end_include

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_include
include|#
directive|include
file|<stdlib.h>
end_include

begin_include
include|#
directive|include
file|<string.h>
end_include

begin_include
include|#
directive|include
file|<sysexits.h>
end_include

begin_include
include|#
directive|include
file|<unistd.h>
end_include

begin_include
include|#
directive|include
file|<fetch.h>
end_include

begin_define
define|#
directive|define
name|MINBUFSIZE
value|4096
end_define

begin_comment
comment|/* Option flags */
end_comment

begin_decl_stmt
name|int
name|A_flag
decl_stmt|;
end_decl_stmt

begin_comment
comment|/*    -A: do not follow 302 redirects */
end_comment

begin_decl_stmt
name|int
name|a_flag
decl_stmt|;
end_decl_stmt

begin_comment
comment|/*    -a: auto retry */
end_comment

begin_decl_stmt
name|size_t
name|B_size
decl_stmt|;
end_decl_stmt

begin_comment
comment|/*    -B: buffer size */
end_comment

begin_decl_stmt
name|int
name|b_flag
decl_stmt|;
end_decl_stmt

begin_comment
comment|/*!   -b: workaround TCP bug */
end_comment

begin_decl_stmt
name|char
modifier|*
name|c_dirname
decl_stmt|;
end_decl_stmt

begin_comment
comment|/*    -c: remote directory */
end_comment

begin_decl_stmt
name|int
name|d_flag
decl_stmt|;
end_decl_stmt

begin_comment
comment|/*    -d: direct connection */
end_comment

begin_decl_stmt
name|int
name|F_flag
decl_stmt|;
end_decl_stmt

begin_comment
comment|/*    -F: restart without checking mtime  */
end_comment

begin_decl_stmt
name|char
modifier|*
name|f_filename
decl_stmt|;
end_decl_stmt

begin_comment
comment|/*    -f: file to fetch */
end_comment

begin_decl_stmt
name|int
name|H_flag
decl_stmt|;
end_decl_stmt

begin_comment
comment|/*    -H: use high port */
end_comment

begin_decl_stmt
name|char
modifier|*
name|h_hostname
decl_stmt|;
end_decl_stmt

begin_comment
comment|/*    -h: host to fetch from */
end_comment

begin_decl_stmt
name|int
name|l_flag
decl_stmt|;
end_decl_stmt

begin_comment
comment|/*    -l: link rather than copy file: URLs */
end_comment

begin_decl_stmt
name|int
name|m_flag
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* -[Mm]: mirror mode */
end_comment

begin_decl_stmt
name|int
name|n_flag
decl_stmt|;
end_decl_stmt

begin_comment
comment|/*    -n: do not preserve modification time */
end_comment

begin_decl_stmt
name|int
name|o_flag
decl_stmt|;
end_decl_stmt

begin_comment
comment|/*    -o: specify output file */
end_comment

begin_decl_stmt
name|int
name|o_directory
decl_stmt|;
end_decl_stmt

begin_comment
comment|/*        output file is a directory */
end_comment

begin_decl_stmt
name|char
modifier|*
name|o_filename
decl_stmt|;
end_decl_stmt

begin_comment
comment|/*        name of output file */
end_comment

begin_decl_stmt
name|int
name|o_stdout
decl_stmt|;
end_decl_stmt

begin_comment
comment|/*        output file is stdout */
end_comment

begin_decl_stmt
name|int
name|once_flag
decl_stmt|;
end_decl_stmt

begin_comment
comment|/*    -1: stop at first successful file */
end_comment

begin_decl_stmt
name|int
name|p_flag
init|=
literal|1
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* -[Pp]: use passive FTP */
end_comment

begin_decl_stmt
name|int
name|R_flag
decl_stmt|;
end_decl_stmt

begin_comment
comment|/*    -R: don't delete partially transferred files */
end_comment

begin_decl_stmt
name|int
name|r_flag
decl_stmt|;
end_decl_stmt

begin_comment
comment|/*    -r: restart previously interrupted transfer */
end_comment

begin_decl_stmt
name|u_int
name|T_secs
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_comment
comment|/*    -T: transfer timeout in seconds */
end_comment

begin_decl_stmt
name|int
name|s_flag
decl_stmt|;
end_decl_stmt

begin_comment
comment|/*    -s: show size, don't fetch */
end_comment

begin_decl_stmt
name|off_t
name|S_size
decl_stmt|;
end_decl_stmt

begin_comment
comment|/*    -S: require size to match */
end_comment

begin_decl_stmt
name|int
name|t_flag
decl_stmt|;
end_decl_stmt

begin_comment
comment|/*!   -t: workaround TCP bug */
end_comment

begin_decl_stmt
name|int
name|v_level
init|=
literal|1
decl_stmt|;
end_decl_stmt

begin_comment
comment|/*    -v: verbosity level */
end_comment

begin_decl_stmt
name|int
name|v_tty
decl_stmt|;
end_decl_stmt

begin_comment
comment|/*        stdout is a tty */
end_comment

begin_decl_stmt
name|u_int
name|w_secs
decl_stmt|;
end_decl_stmt

begin_comment
comment|/*    -w: retry delay */
end_comment

begin_decl_stmt
name|int
name|family
init|=
name|PF_UNSPEC
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* -[46]: address family to use */
end_comment

begin_decl_stmt
name|u_int
name|ftp_timeout
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* default timeout for FTP transfers */
end_comment

begin_decl_stmt
name|u_int
name|http_timeout
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* default timeout for HTTP transfers */
end_comment

begin_decl_stmt
name|u_char
modifier|*
name|buf
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* transfer buffer */
end_comment

begin_function
name|void
name|sig_handler
parameter_list|(
name|int
name|sig
parameter_list|)
block|{
name|errx
argument_list|(
literal|1
argument_list|,
literal|"Transfer timed out"
argument_list|)
expr_stmt|;
block|}
end_function

begin_struct
struct|struct
name|xferstat
block|{
name|char
name|name
index|[
literal|40
index|]
decl_stmt|;
name|struct
name|timeval
name|start
decl_stmt|;
name|struct
name|timeval
name|end
decl_stmt|;
name|struct
name|timeval
name|last
decl_stmt|;
name|off_t
name|size
decl_stmt|;
name|off_t
name|offset
decl_stmt|;
name|off_t
name|rcvd
decl_stmt|;
block|}
struct|;
end_struct

begin_function_decl
name|void
name|stat_start
parameter_list|(
name|struct
name|xferstat
modifier|*
parameter_list|,
name|char
modifier|*
parameter_list|,
name|off_t
parameter_list|,
name|off_t
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|void
name|stat_update
parameter_list|(
name|struct
name|xferstat
modifier|*
parameter_list|,
name|off_t
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|void
name|stat_end
parameter_list|(
name|struct
name|xferstat
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function
name|void
name|stat_start
parameter_list|(
name|struct
name|xferstat
modifier|*
name|xs
parameter_list|,
name|char
modifier|*
name|name
parameter_list|,
name|off_t
name|size
parameter_list|,
name|off_t
name|offset
parameter_list|)
block|{
name|snprintf
argument_list|(
name|xs
operator|->
name|name
argument_list|,
sizeof|sizeof
name|xs
operator|->
name|name
argument_list|,
literal|"%s"
argument_list|,
name|name
argument_list|)
expr_stmt|;
name|gettimeofday
argument_list|(
operator|&
name|xs
operator|->
name|start
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|xs
operator|->
name|last
operator|.
name|tv_sec
operator|=
name|xs
operator|->
name|last
operator|.
name|tv_usec
operator|=
literal|0
expr_stmt|;
name|xs
operator|->
name|end
operator|=
name|xs
operator|->
name|last
expr_stmt|;
name|xs
operator|->
name|size
operator|=
name|size
expr_stmt|;
name|xs
operator|->
name|offset
operator|=
name|offset
expr_stmt|;
name|stat_update
argument_list|(
name|xs
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|stat_update
parameter_list|(
name|struct
name|xferstat
modifier|*
name|xs
parameter_list|,
name|off_t
name|rcvd
parameter_list|)
block|{
name|struct
name|timeval
name|now
decl_stmt|;
name|xs
operator|->
name|rcvd
operator|=
name|rcvd
expr_stmt|;
if|if
condition|(
name|v_level
operator|<=
literal|1
operator|||
operator|!
name|v_tty
condition|)
return|return;
name|gettimeofday
argument_list|(
operator|&
name|now
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|now
operator|.
name|tv_sec
operator|<=
name|xs
operator|->
name|last
operator|.
name|tv_sec
condition|)
return|return;
name|xs
operator|->
name|last
operator|=
name|now
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"\rReceiving %s"
argument_list|,
name|xs
operator|->
name|name
argument_list|)
expr_stmt|;
if|if
condition|(
name|xs
operator|->
name|size
operator|==
operator|-
literal|1
condition|)
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|": %lld bytes"
argument_list|,
name|xs
operator|->
name|size
argument_list|)
expr_stmt|;
else|else
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|" (%lld bytes): %d%%"
argument_list|,
name|xs
operator|->
name|size
argument_list|,
call|(
name|int
call|)
argument_list|(
operator|(
literal|100.0
operator|*
operator|(
name|xs
operator|->
name|rcvd
operator|+
name|xs
operator|->
name|offset
operator|)
operator|)
operator|/
name|xs
operator|->
name|size
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|stat_end
parameter_list|(
name|struct
name|xferstat
modifier|*
name|xs
parameter_list|)
block|{
name|double
name|delta
decl_stmt|;
name|double
name|bps
decl_stmt|;
name|gettimeofday
argument_list|(
operator|&
name|xs
operator|->
name|end
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|v_level
condition|)
return|return;
name|fputc
argument_list|(
literal|'\n'
argument_list|,
name|stderr
argument_list|)
expr_stmt|;
name|delta
operator|=
operator|(
name|xs
operator|->
name|end
operator|.
name|tv_sec
operator|+
operator|(
name|xs
operator|->
name|end
operator|.
name|tv_usec
operator|/
literal|1.e6
operator|)
operator|)
operator|-
operator|(
name|xs
operator|->
name|start
operator|.
name|tv_sec
operator|+
operator|(
name|xs
operator|->
name|start
operator|.
name|tv_usec
operator|/
literal|1.e6
operator|)
operator|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"%lld bytes transferred in %.1f seconds "
argument_list|,
name|xs
operator|->
name|rcvd
operator|-
name|xs
operator|->
name|offset
argument_list|,
name|delta
argument_list|)
expr_stmt|;
name|bps
operator|=
operator|(
name|xs
operator|->
name|rcvd
operator|-
name|xs
operator|->
name|offset
operator|)
operator|/
name|delta
expr_stmt|;
if|if
condition|(
name|bps
operator|>
literal|1024
operator|*
literal|1024
condition|)
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"(%.2f MBps)\n"
argument_list|,
name|bps
operator|/
operator|(
literal|1024
operator|*
literal|1024
operator|)
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|bps
operator|>
literal|1024
condition|)
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"(%.2f kBps)\n"
argument_list|,
name|bps
operator|/
literal|1024
argument_list|)
expr_stmt|;
else|else
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"(%.2f Bps)\n"
argument_list|,
name|bps
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|int
name|fetch
parameter_list|(
name|char
modifier|*
name|URL
parameter_list|,
name|char
modifier|*
name|path
parameter_list|)
block|{
name|struct
name|url
modifier|*
name|url
decl_stmt|;
name|struct
name|url_stat
name|us
decl_stmt|;
name|struct
name|stat
name|sb
decl_stmt|;
name|struct
name|xferstat
name|xs
decl_stmt|;
name|FILE
modifier|*
name|f
decl_stmt|,
modifier|*
name|of
decl_stmt|;
name|size_t
name|size
decl_stmt|;
name|off_t
name|count
decl_stmt|;
name|char
name|flags
index|[
literal|8
index|]
decl_stmt|;
name|int
name|ch
decl_stmt|,
name|n
decl_stmt|,
name|r
decl_stmt|;
name|u_int
name|timeout
decl_stmt|;
name|f
operator|=
name|of
operator|=
name|NULL
expr_stmt|;
comment|/* parse URL */
if|if
condition|(
operator|(
name|url
operator|=
name|fetchParseURL
argument_list|(
name|URL
argument_list|)
operator|)
operator|==
name|NULL
condition|)
block|{
name|warnx
argument_list|(
literal|"%s: parse error"
argument_list|,
name|URL
argument_list|)
expr_stmt|;
goto|goto
name|failure
goto|;
block|}
name|timeout
operator|=
literal|0
expr_stmt|;
operator|*
name|flags
operator|=
literal|0
expr_stmt|;
comment|/* common flags */
if|if
condition|(
name|v_level
operator|>
literal|2
condition|)
name|strcat
argument_list|(
name|flags
argument_list|,
literal|"v"
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|family
condition|)
block|{
case|case
name|PF_INET
case|:
name|strcat
argument_list|(
name|flags
argument_list|,
literal|"4"
argument_list|)
expr_stmt|;
break|break;
case|case
name|PF_INET6
case|:
name|strcat
argument_list|(
name|flags
argument_list|,
literal|"6"
argument_list|)
expr_stmt|;
break|break;
block|}
comment|/* FTP specific flags */
if|if
condition|(
name|strcmp
argument_list|(
name|url
operator|->
name|scheme
argument_list|,
literal|"ftp"
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|p_flag
condition|)
name|strcat
argument_list|(
name|flags
argument_list|,
literal|"p"
argument_list|)
expr_stmt|;
if|if
condition|(
name|d_flag
condition|)
name|strcat
argument_list|(
name|flags
argument_list|,
literal|"d"
argument_list|)
expr_stmt|;
if|if
condition|(
name|H_flag
condition|)
name|strcat
argument_list|(
name|flags
argument_list|,
literal|"h"
argument_list|)
expr_stmt|;
name|timeout
operator|=
name|T_secs
condition|?
name|T_secs
else|:
name|ftp_timeout
expr_stmt|;
block|}
comment|/* HTTP specific flags */
if|if
condition|(
name|strcmp
argument_list|(
name|url
operator|->
name|scheme
argument_list|,
literal|"http"
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|d_flag
condition|)
name|strcat
argument_list|(
name|flags
argument_list|,
literal|"d"
argument_list|)
expr_stmt|;
if|if
condition|(
name|A_flag
condition|)
name|strcat
argument_list|(
name|flags
argument_list|,
literal|"A"
argument_list|)
expr_stmt|;
name|timeout
operator|=
name|T_secs
condition|?
name|T_secs
else|:
name|http_timeout
expr_stmt|;
block|}
comment|/*      * Set the protocol timeout.      * This currently only works for FTP, so we still use      * alarm(timeout) further down.      */
name|fetchTimeout
operator|=
name|timeout
expr_stmt|;
comment|/* stat remote file */
name|alarm
argument_list|(
name|timeout
argument_list|)
expr_stmt|;
if|if
condition|(
name|fetchStat
argument_list|(
name|url
argument_list|,
operator|&
name|us
argument_list|,
name|flags
argument_list|)
operator|==
operator|-
literal|1
condition|)
name|warnx
argument_list|(
literal|"%s: size not known"
argument_list|,
name|path
argument_list|)
expr_stmt|;
name|alarm
argument_list|(
name|timeout
argument_list|)
expr_stmt|;
comment|/* just print size */
if|if
condition|(
name|s_flag
condition|)
block|{
if|if
condition|(
name|us
operator|.
name|size
operator|==
operator|-
literal|1
condition|)
name|printf
argument_list|(
literal|"Unknown\n"
argument_list|)
expr_stmt|;
else|else
name|printf
argument_list|(
literal|"%lld\n"
argument_list|,
name|us
operator|.
name|size
argument_list|)
expr_stmt|;
goto|goto
name|success
goto|;
block|}
comment|/* check that size is as expected */
if|if
condition|(
name|S_size
operator|&&
name|us
operator|.
name|size
operator|!=
operator|-
literal|1
operator|&&
name|us
operator|.
name|size
operator|!=
name|S_size
condition|)
block|{
name|warnx
argument_list|(
literal|"%s: size mismatch: expected %lld, actual %lld"
argument_list|,
name|path
argument_list|,
name|S_size
argument_list|,
name|us
operator|.
name|size
argument_list|)
expr_stmt|;
goto|goto
name|failure
goto|;
block|}
comment|/* symlink instead of copy */
if|if
condition|(
name|l_flag
operator|&&
name|strcmp
argument_list|(
name|url
operator|->
name|scheme
argument_list|,
literal|"file"
argument_list|)
operator|==
literal|0
operator|&&
operator|!
name|o_stdout
condition|)
block|{
if|if
condition|(
name|symlink
argument_list|(
name|url
operator|->
name|doc
argument_list|,
name|path
argument_list|)
operator|==
operator|-
literal|1
condition|)
block|{
name|warn
argument_list|(
literal|"%s: symlink()"
argument_list|,
name|path
argument_list|)
expr_stmt|;
goto|goto
name|failure
goto|;
block|}
goto|goto
name|success
goto|;
block|}
if|if
condition|(
name|o_stdout
condition|)
block|{
comment|/* output to stdout */
name|of
operator|=
name|stdout
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|r_flag
operator|&&
name|us
operator|.
name|size
operator|!=
operator|-
literal|1
operator|&&
name|stat
argument_list|(
name|path
argument_list|,
operator|&
name|sb
argument_list|)
operator|!=
operator|-
literal|1
operator|&&
operator|(
name|F_flag
operator|||
operator|(
name|us
operator|.
name|mtime
operator|&&
name|sb
operator|.
name|st_mtime
operator|==
name|us
operator|.
name|mtime
operator|)
operator|)
condition|)
block|{
comment|/* output to file, restart aborted transfer */
if|if
condition|(
name|us
operator|.
name|size
operator|==
name|sb
operator|.
name|st_size
condition|)
goto|goto
name|success
goto|;
elseif|else
if|if
condition|(
name|sb
operator|.
name|st_size
operator|>
name|us
operator|.
name|size
operator|&&
name|truncate
argument_list|(
name|path
argument_list|,
name|us
operator|.
name|size
argument_list|)
operator|==
operator|-
literal|1
condition|)
block|{
name|warn
argument_list|(
literal|"%s: truncate()"
argument_list|,
name|path
argument_list|)
expr_stmt|;
goto|goto
name|failure
goto|;
block|}
if|if
condition|(
operator|(
name|of
operator|=
name|fopen
argument_list|(
name|path
argument_list|,
literal|"a"
argument_list|)
operator|)
operator|==
name|NULL
condition|)
block|{
name|warn
argument_list|(
literal|"%s: open()"
argument_list|,
name|path
argument_list|)
expr_stmt|;
goto|goto
name|failure
goto|;
block|}
name|url
operator|->
name|offset
operator|=
name|sb
operator|.
name|st_size
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|m_flag
operator|&&
name|us
operator|.
name|size
operator|!=
operator|-
literal|1
operator|&&
name|stat
argument_list|(
name|path
argument_list|,
operator|&
name|sb
argument_list|)
operator|!=
operator|-
literal|1
condition|)
block|{
comment|/* output to file, mirror mode */
if|if
condition|(
name|sb
operator|.
name|st_size
operator|==
name|us
operator|.
name|size
operator|&&
name|sb
operator|.
name|st_mtime
operator|==
name|us
operator|.
name|mtime
condition|)
return|return
literal|0
return|;
if|if
condition|(
operator|(
name|of
operator|=
name|fopen
argument_list|(
name|path
argument_list|,
literal|"w"
argument_list|)
operator|)
operator|==
name|NULL
condition|)
block|{
name|warn
argument_list|(
literal|"%s: open()"
argument_list|,
name|path
argument_list|)
expr_stmt|;
goto|goto
name|failure
goto|;
block|}
block|}
else|else
block|{
comment|/* output to file, all other cases */
if|if
condition|(
operator|(
name|of
operator|=
name|fopen
argument_list|(
name|path
argument_list|,
literal|"w"
argument_list|)
operator|)
operator|==
name|NULL
condition|)
block|{
name|warn
argument_list|(
literal|"%s: open()"
argument_list|,
name|path
argument_list|)
expr_stmt|;
goto|goto
name|failure
goto|;
block|}
block|}
name|count
operator|=
name|url
operator|->
name|offset
expr_stmt|;
comment|/* start the transfer */
if|if
condition|(
operator|(
name|f
operator|=
name|fetchGet
argument_list|(
name|url
argument_list|,
name|flags
argument_list|)
operator|)
operator|==
name|NULL
condition|)
block|{
name|warnx
argument_list|(
literal|"%s"
argument_list|,
name|fetchLastErrString
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|R_flag
operator|&&
operator|!
name|r_flag
operator|&&
operator|!
name|o_stdout
condition|)
name|unlink
argument_list|(
name|path
argument_list|)
expr_stmt|;
goto|goto
name|failure
goto|;
block|}
comment|/* start the counter */
name|stat_start
argument_list|(
operator|&
name|xs
argument_list|,
name|path
argument_list|,
name|us
operator|.
name|size
argument_list|,
name|count
argument_list|)
expr_stmt|;
name|n
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|us
operator|.
name|size
operator|==
operator|-
literal|1
condition|)
block|{
comment|/*	   	 * We have no idea how much data to expect, so do it byte by          * byte. This is incredibly inefficient, but there's not much          * we can do about it... :(	  	 */
while|while
condition|(
literal|1
condition|)
block|{
if|if
condition|(
name|timeout
condition|)
name|alarm
argument_list|(
name|timeout
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|STDIO_HACK
comment|/*	       	     * This is a non-portable hack, but it makes things go 	     * faster. Basically, if there is data in the input file's 	     * buffer, write it out; then fall through to the fgetc() 	     * which forces a refill. It saves a memcpy() and reduces 	     * the number of iterations, i.e the number of calls to 	     * alarm(). Empirical evidence shows this can cut user 	     * time by up to 90%. There may be better (even portable) 	     * ways to do this. 	     */
if|if
condition|(
name|f
operator|->
name|_r
operator|&&
operator|(
name|f
operator|->
name|_ub
operator|.
name|_base
operator|==
name|NULL
operator|)
condition|)
block|{
if|if
condition|(
name|fwrite
argument_list|(
name|f
operator|->
name|_p
argument_list|,
name|f
operator|->
name|_r
argument_list|,
literal|1
argument_list|,
name|of
argument_list|)
operator|<
literal|1
condition|)
break|break;
name|count
operator|+=
name|f
operator|->
name|_r
expr_stmt|;
name|f
operator|->
name|_p
operator|+=
name|f
operator|->
name|_r
expr_stmt|;
name|f
operator|->
name|_r
operator|=
literal|0
expr_stmt|;
block|}
endif|#
directive|endif
if|if
condition|(
operator|(
name|ch
operator|=
name|fgetc
argument_list|(
name|f
argument_list|)
operator|)
operator|==
name|EOF
operator|||
name|fputc
argument_list|(
name|ch
argument_list|,
name|of
argument_list|)
operator|==
name|EOF
condition|)
break|break;
name|stat_update
argument_list|(
operator|&
name|xs
argument_list|,
name|count
operator|++
argument_list|)
expr_stmt|;
name|n
operator|++
expr_stmt|;
block|}
block|}
else|else
block|{
comment|/* we know exactly how much to transfer, so do it efficiently */
for|for
control|(
name|size
operator|=
name|B_size
init|;
name|count
operator|!=
name|us
operator|.
name|size
condition|;
name|n
operator|++
control|)
block|{
if|if
condition|(
name|us
operator|.
name|size
operator|-
name|count
operator|<
name|B_size
condition|)
name|size
operator|=
name|us
operator|.
name|size
operator|-
name|count
expr_stmt|;
if|if
condition|(
name|timeout
condition|)
name|alarm
argument_list|(
name|timeout
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|size
operator|=
name|fread
argument_list|(
name|buf
argument_list|,
literal|1
argument_list|,
name|size
argument_list|,
name|f
argument_list|)
operator|)
operator|<=
literal|0
condition|)
break|break;
name|stat_update
argument_list|(
operator|&
name|xs
argument_list|,
name|count
operator|+=
name|size
argument_list|)
expr_stmt|;
if|if
condition|(
name|fwrite
argument_list|(
name|buf
argument_list|,
name|size
argument_list|,
literal|1
argument_list|,
name|of
argument_list|)
operator|!=
literal|1
condition|)
break|break;
block|}
block|}
if|if
condition|(
name|timeout
condition|)
name|alarm
argument_list|(
literal|0
argument_list|)
expr_stmt|;
name|stat_end
argument_list|(
operator|&
name|xs
argument_list|)
expr_stmt|;
comment|/* check the status of our files */
if|if
condition|(
name|ferror
argument_list|(
name|f
argument_list|)
condition|)
name|warn
argument_list|(
literal|"%s"
argument_list|,
name|URL
argument_list|)
expr_stmt|;
if|if
condition|(
name|ferror
argument_list|(
name|of
argument_list|)
condition|)
name|warn
argument_list|(
literal|"%s"
argument_list|,
name|path
argument_list|)
expr_stmt|;
if|if
condition|(
name|ferror
argument_list|(
name|f
argument_list|)
operator|||
name|ferror
argument_list|(
name|of
argument_list|)
condition|)
block|{
if|if
condition|(
operator|!
name|R_flag
operator|&&
operator|!
name|r_flag
operator|&&
operator|!
name|o_stdout
condition|)
name|unlink
argument_list|(
name|path
argument_list|)
expr_stmt|;
goto|goto
name|failure
goto|;
block|}
comment|/* need to close the file before setting mtime */
if|if
condition|(
name|of
operator|!=
name|stdout
condition|)
block|{
name|fclose
argument_list|(
name|of
argument_list|)
expr_stmt|;
name|of
operator|=
name|NULL
expr_stmt|;
block|}
comment|/* Set mtime of local file */
if|if
condition|(
operator|!
name|n_flag
operator|&&
name|us
operator|.
name|size
operator|!=
operator|-
literal|1
operator|&&
operator|!
name|o_stdout
condition|)
block|{
name|struct
name|timeval
name|tv
index|[
literal|2
index|]
decl_stmt|;
name|tv
index|[
literal|0
index|]
operator|.
name|tv_sec
operator|=
operator|(
name|long
operator|)
name|us
operator|.
name|atime
expr_stmt|;
name|tv
index|[
literal|1
index|]
operator|.
name|tv_sec
operator|=
operator|(
name|long
operator|)
name|us
operator|.
name|mtime
expr_stmt|;
name|tv
index|[
literal|0
index|]
operator|.
name|tv_usec
operator|=
name|tv
index|[
literal|1
index|]
operator|.
name|tv_usec
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|utimes
argument_list|(
name|path
argument_list|,
name|tv
argument_list|)
condition|)
name|warn
argument_list|(
literal|"%s: utimes()"
argument_list|,
name|path
argument_list|)
expr_stmt|;
block|}
comment|/* check the file size */
if|if
condition|(
name|us
operator|.
name|size
operator|!=
operator|-
literal|1
operator|&&
name|count
operator|<
name|us
operator|.
name|size
condition|)
block|{
name|warnx
argument_list|(
literal|"%s appears to be truncated: %lld/%lld bytes"
argument_list|,
name|path
argument_list|,
name|count
argument_list|,
name|us
operator|.
name|size
argument_list|)
expr_stmt|;
goto|goto
name|failure
goto|;
block|}
name|success
label|:
name|r
operator|=
literal|0
expr_stmt|;
goto|goto
name|done
goto|;
name|failure
label|:
name|r
operator|=
operator|-
literal|1
expr_stmt|;
goto|goto
name|done
goto|;
name|done
label|:
if|if
condition|(
name|f
condition|)
name|fclose
argument_list|(
name|f
argument_list|)
expr_stmt|;
if|if
condition|(
name|of
operator|&&
name|of
operator|!=
name|stdout
condition|)
name|fclose
argument_list|(
name|of
argument_list|)
expr_stmt|;
if|if
condition|(
name|url
condition|)
name|fetchFreeURL
argument_list|(
name|url
argument_list|)
expr_stmt|;
return|return
name|r
return|;
block|}
end_function

begin_function
name|void
name|usage
parameter_list|(
name|void
parameter_list|)
block|{
comment|/* XXX badly out of synch */
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Usage: fetch [-1AFHMPRabdlmnpqrstv] [-o outputfile] [-S bytes]\n"
literal|"             [-B bytes] [-T seconds] [-w seconds]\n"
literal|"             [-f file -h host [-c dir] | URL ...]\n"
argument_list|)
expr_stmt|;
block|}
end_function

begin_define
define|#
directive|define
name|PARSENUM
parameter_list|(
name|NAME
parameter_list|,
name|TYPE
parameter_list|)
define|\
value|int					\ NAME(char *s, TYPE *v)			\ {					\     *v = 0;				\     for (*v = 0; *s; s++)		\ 	if (isdigit(*s))		\ 	    *v = *v * 10 + *s - '0';	\ 	else				\ 	    return -1;			\     return 0;				\ }
end_define

begin_macro
name|PARSENUM
argument_list|(
argument|parseint
argument_list|,
argument|u_int
argument_list|)
end_macro

begin_macro
name|PARSENUM
argument_list|(
argument|parsesize
argument_list|,
argument|size_t
argument_list|)
end_macro

begin_macro
name|PARSENUM
argument_list|(
argument|parseoff
argument_list|,
argument|off_t
argument_list|)
end_macro

begin_function
name|int
name|main
parameter_list|(
name|int
name|argc
parameter_list|,
name|char
modifier|*
name|argv
index|[]
parameter_list|)
block|{
name|struct
name|stat
name|sb
decl_stmt|;
name|char
modifier|*
name|p
decl_stmt|,
modifier|*
name|q
decl_stmt|,
modifier|*
name|s
decl_stmt|;
name|int
name|c
decl_stmt|,
name|e
decl_stmt|,
name|r
decl_stmt|;
while|while
condition|(
operator|(
name|c
operator|=
name|getopt
argument_list|(
name|argc
argument_list|,
name|argv
argument_list|,
literal|"146AaB:bc:dFf:h:lHMmnPpo:qRrS:sT:tvw:"
argument_list|)
operator|)
operator|!=
name|EOF
condition|)
switch|switch
condition|(
name|c
condition|)
block|{
case|case
literal|'1'
case|:
name|once_flag
operator|=
literal|1
expr_stmt|;
break|break;
case|case
literal|'4'
case|:
name|family
operator|=
name|PF_INET
expr_stmt|;
break|break;
case|case
literal|'6'
case|:
name|family
operator|=
name|PF_INET6
expr_stmt|;
break|break;
case|case
literal|'A'
case|:
name|A_flag
operator|=
literal|1
expr_stmt|;
break|break;
case|case
literal|'a'
case|:
name|a_flag
operator|=
literal|1
expr_stmt|;
break|break;
case|case
literal|'B'
case|:
if|if
condition|(
name|parsesize
argument_list|(
name|optarg
argument_list|,
operator|&
name|B_size
argument_list|)
operator|==
operator|-
literal|1
condition|)
name|errx
argument_list|(
literal|1
argument_list|,
literal|"invalid buffer size"
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'b'
case|:
name|warnx
argument_list|(
literal|"warning: the -b option is deprecated"
argument_list|)
expr_stmt|;
name|b_flag
operator|=
literal|1
expr_stmt|;
break|break;
case|case
literal|'c'
case|:
name|c_dirname
operator|=
name|optarg
expr_stmt|;
break|break;
case|case
literal|'d'
case|:
name|d_flag
operator|=
literal|1
expr_stmt|;
break|break;
case|case
literal|'F'
case|:
name|F_flag
operator|=
literal|1
expr_stmt|;
break|break;
case|case
literal|'f'
case|:
name|f_filename
operator|=
name|optarg
expr_stmt|;
break|break;
case|case
literal|'H'
case|:
name|H_flag
operator|=
literal|1
expr_stmt|;
break|break;
case|case
literal|'h'
case|:
name|h_hostname
operator|=
name|optarg
expr_stmt|;
break|break;
case|case
literal|'l'
case|:
name|l_flag
operator|=
literal|1
expr_stmt|;
break|break;
case|case
literal|'o'
case|:
name|o_flag
operator|=
literal|1
expr_stmt|;
name|o_filename
operator|=
name|optarg
expr_stmt|;
break|break;
case|case
literal|'M'
case|:
case|case
literal|'m'
case|:
name|m_flag
operator|=
literal|1
expr_stmt|;
break|break;
case|case
literal|'n'
case|:
name|n_flag
operator|=
literal|1
expr_stmt|;
break|break;
case|case
literal|'P'
case|:
case|case
literal|'p'
case|:
name|p_flag
operator|=
literal|1
expr_stmt|;
break|break;
case|case
literal|'q'
case|:
name|v_level
operator|=
literal|0
expr_stmt|;
break|break;
case|case
literal|'R'
case|:
name|R_flag
operator|=
literal|1
expr_stmt|;
break|break;
case|case
literal|'r'
case|:
name|r_flag
operator|=
literal|1
expr_stmt|;
break|break;
case|case
literal|'S'
case|:
if|if
condition|(
name|parseoff
argument_list|(
name|optarg
argument_list|,
operator|&
name|S_size
argument_list|)
operator|==
operator|-
literal|1
condition|)
name|errx
argument_list|(
literal|1
argument_list|,
literal|"invalid size"
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'s'
case|:
name|s_flag
operator|=
literal|1
expr_stmt|;
break|break;
case|case
literal|'T'
case|:
if|if
condition|(
name|parseint
argument_list|(
name|optarg
argument_list|,
operator|&
name|T_secs
argument_list|)
operator|==
operator|-
literal|1
condition|)
name|errx
argument_list|(
literal|1
argument_list|,
literal|"invalid timeout"
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'t'
case|:
name|t_flag
operator|=
literal|1
expr_stmt|;
name|warnx
argument_list|(
literal|"warning: the -t option is deprecated"
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'v'
case|:
name|v_level
operator|++
expr_stmt|;
break|break;
case|case
literal|'w'
case|:
name|a_flag
operator|=
literal|1
expr_stmt|;
if|if
condition|(
name|parseint
argument_list|(
name|optarg
argument_list|,
operator|&
name|w_secs
argument_list|)
operator|==
operator|-
literal|1
condition|)
name|errx
argument_list|(
literal|1
argument_list|,
literal|"invalid delay"
argument_list|)
expr_stmt|;
break|break;
default|default:
name|usage
argument_list|()
expr_stmt|;
name|exit
argument_list|(
name|EX_USAGE
argument_list|)
expr_stmt|;
block|}
name|argc
operator|-=
name|optind
expr_stmt|;
name|argv
operator|+=
name|optind
expr_stmt|;
if|if
condition|(
name|h_hostname
operator|||
name|f_filename
operator|||
name|c_dirname
condition|)
block|{
if|if
condition|(
operator|!
name|h_hostname
operator|||
operator|!
name|f_filename
operator|||
name|argc
condition|)
block|{
name|usage
argument_list|()
expr_stmt|;
name|exit
argument_list|(
name|EX_USAGE
argument_list|)
expr_stmt|;
block|}
comment|/* XXX this is a hack. */
if|if
condition|(
name|strcspn
argument_list|(
name|h_hostname
argument_list|,
literal|"@:/"
argument_list|)
operator|!=
name|strlen
argument_list|(
name|h_hostname
argument_list|)
condition|)
name|errx
argument_list|(
literal|1
argument_list|,
literal|"invalid hostname"
argument_list|)
expr_stmt|;
if|if
condition|(
name|asprintf
argument_list|(
name|argv
argument_list|,
literal|"ftp://%s/%s/%s"
argument_list|,
name|h_hostname
argument_list|,
name|c_dirname
condition|?
name|c_dirname
else|:
literal|""
argument_list|,
name|f_filename
argument_list|)
operator|==
operator|-
literal|1
condition|)
name|errx
argument_list|(
literal|1
argument_list|,
name|strerror
argument_list|(
name|ENOMEM
argument_list|)
argument_list|)
expr_stmt|;
name|argc
operator|++
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|argc
condition|)
block|{
name|usage
argument_list|()
expr_stmt|;
name|exit
argument_list|(
name|EX_USAGE
argument_list|)
expr_stmt|;
block|}
comment|/* allocate buffer */
if|if
condition|(
name|B_size
operator|<
name|MINBUFSIZE
condition|)
name|B_size
operator|=
name|MINBUFSIZE
expr_stmt|;
if|if
condition|(
operator|(
name|buf
operator|=
name|malloc
argument_list|(
name|B_size
argument_list|)
operator|)
operator|==
name|NULL
condition|)
name|errx
argument_list|(
literal|1
argument_list|,
name|strerror
argument_list|(
name|ENOMEM
argument_list|)
argument_list|)
expr_stmt|;
comment|/* timeout handling */
name|signal
argument_list|(
name|SIGALRM
argument_list|,
name|sig_handler
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|s
operator|=
name|getenv
argument_list|(
literal|"FTP_TIMEOUT"
argument_list|)
operator|)
operator|!=
name|NULL
condition|)
block|{
if|if
condition|(
name|parseint
argument_list|(
name|s
argument_list|,
operator|&
name|ftp_timeout
argument_list|)
operator|==
operator|-
literal|1
condition|)
block|{
name|warnx
argument_list|(
literal|"FTP_TIMEOUT is not a positive integer"
argument_list|)
expr_stmt|;
name|ftp_timeout
operator|=
literal|0
expr_stmt|;
block|}
block|}
if|if
condition|(
operator|(
name|s
operator|=
name|getenv
argument_list|(
literal|"HTTP_TIMEOUT"
argument_list|)
operator|)
operator|!=
name|NULL
condition|)
block|{
if|if
condition|(
name|parseint
argument_list|(
name|s
argument_list|,
operator|&
name|http_timeout
argument_list|)
operator|==
operator|-
literal|1
condition|)
block|{
name|warnx
argument_list|(
literal|"HTTP_TIMEOUT is not a positive integer"
argument_list|)
expr_stmt|;
name|http_timeout
operator|=
literal|0
expr_stmt|;
block|}
block|}
comment|/* output file */
if|if
condition|(
name|o_flag
condition|)
block|{
if|if
condition|(
name|strcmp
argument_list|(
name|o_filename
argument_list|,
literal|"-"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|o_stdout
operator|=
literal|1
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|stat
argument_list|(
name|o_filename
argument_list|,
operator|&
name|sb
argument_list|)
operator|==
operator|-
literal|1
condition|)
block|{
if|if
condition|(
name|errno
operator|==
name|ENOENT
condition|)
block|{
if|if
condition|(
name|argc
operator|>
literal|1
condition|)
name|errx
argument_list|(
name|EX_USAGE
argument_list|,
literal|"%s is not a directory"
argument_list|,
name|o_filename
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|err
argument_list|(
name|EX_IOERR
argument_list|,
literal|"%s"
argument_list|,
name|o_filename
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
if|if
condition|(
name|sb
operator|.
name|st_mode
operator|&
name|S_IFDIR
condition|)
name|o_directory
operator|=
literal|1
expr_stmt|;
block|}
block|}
comment|/* check if output is to a tty (for progress report) */
name|v_tty
operator|=
name|isatty
argument_list|(
name|STDERR_FILENO
argument_list|)
expr_stmt|;
name|r
operator|=
literal|0
expr_stmt|;
while|while
condition|(
name|argc
condition|)
block|{
if|if
condition|(
operator|(
name|p
operator|=
name|strrchr
argument_list|(
operator|*
name|argv
argument_list|,
literal|'/'
argument_list|)
operator|)
operator|==
name|NULL
condition|)
name|p
operator|=
operator|*
name|argv
expr_stmt|;
else|else
name|p
operator|++
expr_stmt|;
if|if
condition|(
operator|!
operator|*
name|p
condition|)
name|p
operator|=
literal|"fetch.out"
expr_stmt|;
name|fetchLastErrCode
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|o_flag
condition|)
block|{
if|if
condition|(
name|o_stdout
condition|)
block|{
name|e
operator|=
name|fetch
argument_list|(
operator|*
name|argv
argument_list|,
literal|"-"
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|o_directory
condition|)
block|{
name|asprintf
argument_list|(
operator|&
name|q
argument_list|,
literal|"%s/%s"
argument_list|,
name|o_filename
argument_list|,
name|p
argument_list|)
expr_stmt|;
name|e
operator|=
name|fetch
argument_list|(
operator|*
name|argv
argument_list|,
name|q
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|q
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|e
operator|=
name|fetch
argument_list|(
operator|*
name|argv
argument_list|,
name|o_filename
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
name|e
operator|=
name|fetch
argument_list|(
operator|*
name|argv
argument_list|,
name|p
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|e
operator|==
literal|0
operator|&&
name|once_flag
condition|)
name|exit
argument_list|(
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|e
condition|)
block|{
name|r
operator|=
literal|1
expr_stmt|;
if|if
condition|(
operator|(
name|fetchLastErrCode
operator|&&
name|fetchLastErrCode
operator|!=
name|FETCH_UNAVAIL
operator|&&
name|fetchLastErrCode
operator|!=
name|FETCH_MOVED
operator|&&
name|fetchLastErrCode
operator|!=
name|FETCH_URL
operator|&&
name|fetchLastErrCode
operator|!=
name|FETCH_RESOLV
operator|&&
name|fetchLastErrCode
operator|!=
name|FETCH_UNKNOWN
operator|)
condition|)
block|{
if|if
condition|(
name|w_secs
condition|)
block|{
if|if
condition|(
name|v_level
condition|)
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Waiting %d seconds before retrying\n"
argument_list|,
name|w_secs
argument_list|)
expr_stmt|;
name|sleep
argument_list|(
name|w_secs
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|a_flag
condition|)
continue|continue;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Skipping %s\n"
argument_list|,
operator|*
name|argv
argument_list|)
expr_stmt|;
block|}
block|}
name|argc
operator|--
operator|,
name|argv
operator|++
expr_stmt|;
block|}
name|exit
argument_list|(
name|r
argument_list|)
expr_stmt|;
block|}
end_function

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*-  * Copyright 2003-2005 Colin Percival  * All rights reserved  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted providing that the following conditions   * are met:  * 1. Redistributions of source code must retain the above copyright  *    notice, this list of conditions and the following disclaimer.  * 2. Redistributions in binary form must reproduce the above copyright  *    notice, this list of conditions and the following disclaimer in the  *    documentation and/or other materials provided with the distribution.  *  * THIS SOFTWARE IS PROVIDED BY THE AUTHOR ``AS IS'' AND ANY EXPRESS OR  * IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED  * WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE  * ARE DISCLAIMED.  IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY  * DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL  * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS  * OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)  * HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT,  * STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING  * IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE  * POSSIBILITY OF SUCH DAMAGE.  */
end_comment

begin_include
include|#
directive|include
file|<sys/cdefs.h>
end_include

begin_expr_stmt
name|__FBSDID
argument_list|(
literal|"$FreeBSD$"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_include
include|#
directive|include
file|<sys/types.h>
end_include

begin_include
include|#
directive|include
file|<bzlib.h>
end_include

begin_include
include|#
directive|include
file|<err.h>
end_include

begin_include
include|#
directive|include
file|<errno.h>
end_include

begin_include
include|#
directive|include
file|<fcntl.h>
end_include

begin_include
include|#
directive|include
file|<limits.h>
end_include

begin_include
include|#
directive|include
file|<stdint.h>
end_include

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_include
include|#
directive|include
file|<stdlib.h>
end_include

begin_include
include|#
directive|include
file|<string.h>
end_include

begin_include
include|#
directive|include
file|<unistd.h>
end_include

begin_ifndef
ifndef|#
directive|ifndef
name|O_BINARY
end_ifndef

begin_define
define|#
directive|define
name|O_BINARY
value|0
end_define

begin_endif
endif|#
directive|endif
end_endif

begin_define
define|#
directive|define
name|MIN
parameter_list|(
name|x
parameter_list|,
name|y
parameter_list|)
value|(((x)<(y)) ? (x) : (y))
end_define

begin_function
specifier|static
name|void
name|split
parameter_list|(
name|off_t
modifier|*
name|I
parameter_list|,
name|off_t
modifier|*
name|V
parameter_list|,
name|off_t
name|start
parameter_list|,
name|off_t
name|len
parameter_list|,
name|off_t
name|h
parameter_list|)
block|{
name|off_t
name|i
decl_stmt|,
name|j
decl_stmt|,
name|k
decl_stmt|,
name|x
decl_stmt|,
name|tmp
decl_stmt|,
name|jj
decl_stmt|,
name|kk
decl_stmt|;
if|if
condition|(
name|len
operator|<
literal|16
condition|)
block|{
for|for
control|(
name|k
operator|=
name|start
init|;
name|k
operator|<
name|start
operator|+
name|len
condition|;
name|k
operator|+=
name|j
control|)
block|{
name|j
operator|=
literal|1
expr_stmt|;
name|x
operator|=
name|V
index|[
name|I
index|[
name|k
index|]
operator|+
name|h
index|]
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|1
init|;
name|k
operator|+
name|i
operator|<
name|start
operator|+
name|len
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|V
index|[
name|I
index|[
name|k
operator|+
name|i
index|]
operator|+
name|h
index|]
operator|<
name|x
condition|)
block|{
name|x
operator|=
name|V
index|[
name|I
index|[
name|k
operator|+
name|i
index|]
operator|+
name|h
index|]
expr_stmt|;
name|j
operator|=
literal|0
expr_stmt|;
block|}
if|if
condition|(
name|V
index|[
name|I
index|[
name|k
operator|+
name|i
index|]
operator|+
name|h
index|]
operator|==
name|x
condition|)
block|{
name|tmp
operator|=
name|I
index|[
name|k
operator|+
name|j
index|]
expr_stmt|;
name|I
index|[
name|k
operator|+
name|j
index|]
operator|=
name|I
index|[
name|k
operator|+
name|i
index|]
expr_stmt|;
name|I
index|[
name|k
operator|+
name|i
index|]
operator|=
name|tmp
expr_stmt|;
name|j
operator|++
expr_stmt|;
block|}
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|j
condition|;
name|i
operator|++
control|)
name|V
index|[
name|I
index|[
name|k
operator|+
name|i
index|]
index|]
operator|=
name|k
operator|+
name|j
operator|-
literal|1
expr_stmt|;
if|if
condition|(
name|j
operator|==
literal|1
condition|)
name|I
index|[
name|k
index|]
operator|=
operator|-
literal|1
expr_stmt|;
block|}
return|return;
block|}
name|x
operator|=
name|V
index|[
name|I
index|[
name|start
operator|+
name|len
operator|/
literal|2
index|]
operator|+
name|h
index|]
expr_stmt|;
name|jj
operator|=
literal|0
expr_stmt|;
name|kk
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|i
operator|=
name|start
init|;
name|i
operator|<
name|start
operator|+
name|len
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|V
index|[
name|I
index|[
name|i
index|]
operator|+
name|h
index|]
operator|<
name|x
condition|)
name|jj
operator|++
expr_stmt|;
if|if
condition|(
name|V
index|[
name|I
index|[
name|i
index|]
operator|+
name|h
index|]
operator|==
name|x
condition|)
name|kk
operator|++
expr_stmt|;
block|}
name|jj
operator|+=
name|start
expr_stmt|;
name|kk
operator|+=
name|jj
expr_stmt|;
name|i
operator|=
name|start
expr_stmt|;
name|j
operator|=
literal|0
expr_stmt|;
name|k
operator|=
literal|0
expr_stmt|;
while|while
condition|(
name|i
operator|<
name|jj
condition|)
block|{
if|if
condition|(
name|V
index|[
name|I
index|[
name|i
index|]
operator|+
name|h
index|]
operator|<
name|x
condition|)
block|{
name|i
operator|++
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|V
index|[
name|I
index|[
name|i
index|]
operator|+
name|h
index|]
operator|==
name|x
condition|)
block|{
name|tmp
operator|=
name|I
index|[
name|i
index|]
expr_stmt|;
name|I
index|[
name|i
index|]
operator|=
name|I
index|[
name|jj
operator|+
name|j
index|]
expr_stmt|;
name|I
index|[
name|jj
operator|+
name|j
index|]
operator|=
name|tmp
expr_stmt|;
name|j
operator|++
expr_stmt|;
block|}
else|else
block|{
name|tmp
operator|=
name|I
index|[
name|i
index|]
expr_stmt|;
name|I
index|[
name|i
index|]
operator|=
name|I
index|[
name|kk
operator|+
name|k
index|]
expr_stmt|;
name|I
index|[
name|kk
operator|+
name|k
index|]
operator|=
name|tmp
expr_stmt|;
name|k
operator|++
expr_stmt|;
block|}
block|}
while|while
condition|(
name|jj
operator|+
name|j
operator|<
name|kk
condition|)
block|{
if|if
condition|(
name|V
index|[
name|I
index|[
name|jj
operator|+
name|j
index|]
operator|+
name|h
index|]
operator|==
name|x
condition|)
block|{
name|j
operator|++
expr_stmt|;
block|}
else|else
block|{
name|tmp
operator|=
name|I
index|[
name|jj
operator|+
name|j
index|]
expr_stmt|;
name|I
index|[
name|jj
operator|+
name|j
index|]
operator|=
name|I
index|[
name|kk
operator|+
name|k
index|]
expr_stmt|;
name|I
index|[
name|kk
operator|+
name|k
index|]
operator|=
name|tmp
expr_stmt|;
name|k
operator|++
expr_stmt|;
block|}
block|}
if|if
condition|(
name|jj
operator|>
name|start
condition|)
name|split
argument_list|(
name|I
argument_list|,
name|V
argument_list|,
name|start
argument_list|,
name|jj
operator|-
name|start
argument_list|,
name|h
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|kk
operator|-
name|jj
condition|;
name|i
operator|++
control|)
name|V
index|[
name|I
index|[
name|jj
operator|+
name|i
index|]
index|]
operator|=
name|kk
operator|-
literal|1
expr_stmt|;
if|if
condition|(
name|jj
operator|==
name|kk
operator|-
literal|1
condition|)
name|I
index|[
name|jj
index|]
operator|=
operator|-
literal|1
expr_stmt|;
if|if
condition|(
name|start
operator|+
name|len
operator|>
name|kk
condition|)
name|split
argument_list|(
name|I
argument_list|,
name|V
argument_list|,
name|kk
argument_list|,
name|start
operator|+
name|len
operator|-
name|kk
argument_list|,
name|h
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|qsufsort
parameter_list|(
name|off_t
modifier|*
name|I
parameter_list|,
name|off_t
modifier|*
name|V
parameter_list|,
name|u_char
modifier|*
name|old
parameter_list|,
name|off_t
name|oldsize
parameter_list|)
block|{
name|off_t
name|buckets
index|[
literal|256
index|]
decl_stmt|;
name|off_t
name|i
decl_stmt|,
name|h
decl_stmt|,
name|len
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|256
condition|;
name|i
operator|++
control|)
name|buckets
index|[
name|i
index|]
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|oldsize
condition|;
name|i
operator|++
control|)
name|buckets
index|[
name|old
index|[
name|i
index|]
index|]
operator|++
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|1
init|;
name|i
operator|<
literal|256
condition|;
name|i
operator|++
control|)
name|buckets
index|[
name|i
index|]
operator|+=
name|buckets
index|[
name|i
operator|-
literal|1
index|]
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|255
init|;
name|i
operator|>
literal|0
condition|;
name|i
operator|--
control|)
name|buckets
index|[
name|i
index|]
operator|=
name|buckets
index|[
name|i
operator|-
literal|1
index|]
expr_stmt|;
name|buckets
index|[
literal|0
index|]
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|oldsize
condition|;
name|i
operator|++
control|)
name|I
index|[
operator|++
name|buckets
index|[
name|old
index|[
name|i
index|]
index|]
index|]
operator|=
name|i
expr_stmt|;
name|I
index|[
literal|0
index|]
operator|=
name|oldsize
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|oldsize
condition|;
name|i
operator|++
control|)
name|V
index|[
name|i
index|]
operator|=
name|buckets
index|[
name|old
index|[
name|i
index|]
index|]
expr_stmt|;
name|V
index|[
name|oldsize
index|]
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|1
init|;
name|i
operator|<
literal|256
condition|;
name|i
operator|++
control|)
if|if
condition|(
name|buckets
index|[
name|i
index|]
operator|==
name|buckets
index|[
name|i
operator|-
literal|1
index|]
operator|+
literal|1
condition|)
name|I
index|[
name|buckets
index|[
name|i
index|]
index|]
operator|=
operator|-
literal|1
expr_stmt|;
name|I
index|[
literal|0
index|]
operator|=
operator|-
literal|1
expr_stmt|;
for|for
control|(
name|h
operator|=
literal|1
init|;
name|I
index|[
literal|0
index|]
operator|!=
operator|-
operator|(
name|oldsize
operator|+
literal|1
operator|)
condition|;
name|h
operator|+=
name|h
control|)
block|{
name|len
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|oldsize
operator|+
literal|1
condition|;
control|)
block|{
if|if
condition|(
name|I
index|[
name|i
index|]
operator|<
literal|0
condition|)
block|{
name|len
operator|-=
name|I
index|[
name|i
index|]
expr_stmt|;
name|i
operator|-=
name|I
index|[
name|i
index|]
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|len
condition|)
name|I
index|[
name|i
operator|-
name|len
index|]
operator|=
operator|-
name|len
expr_stmt|;
name|len
operator|=
name|V
index|[
name|I
index|[
name|i
index|]
index|]
operator|+
literal|1
operator|-
name|i
expr_stmt|;
name|split
argument_list|(
name|I
argument_list|,
name|V
argument_list|,
name|i
argument_list|,
name|len
argument_list|,
name|h
argument_list|)
expr_stmt|;
name|i
operator|+=
name|len
expr_stmt|;
name|len
operator|=
literal|0
expr_stmt|;
block|}
block|}
if|if
condition|(
name|len
condition|)
name|I
index|[
name|i
operator|-
name|len
index|]
operator|=
operator|-
name|len
expr_stmt|;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|oldsize
operator|+
literal|1
condition|;
name|i
operator|++
control|)
name|I
index|[
name|V
index|[
name|i
index|]
index|]
operator|=
name|i
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|off_t
name|matchlen
parameter_list|(
name|u_char
modifier|*
name|old
parameter_list|,
name|off_t
name|oldsize
parameter_list|,
name|u_char
modifier|*
name|new
parameter_list|,
name|off_t
name|newsize
parameter_list|)
block|{
name|off_t
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
operator|(
name|i
operator|<
name|oldsize
operator|)
operator|&&
operator|(
name|i
operator|<
name|newsize
operator|)
condition|;
name|i
operator|++
control|)
if|if
condition|(
name|old
index|[
name|i
index|]
operator|!=
name|new
index|[
name|i
index|]
condition|)
break|break;
return|return
name|i
return|;
block|}
end_function

begin_function
specifier|static
name|off_t
name|search
parameter_list|(
name|off_t
modifier|*
name|I
parameter_list|,
name|u_char
modifier|*
name|old
parameter_list|,
name|off_t
name|oldsize
parameter_list|,
name|u_char
modifier|*
name|new
parameter_list|,
name|off_t
name|newsize
parameter_list|,
name|off_t
name|st
parameter_list|,
name|off_t
name|en
parameter_list|,
name|off_t
modifier|*
name|pos
parameter_list|)
block|{
name|off_t
name|x
decl_stmt|,
name|y
decl_stmt|;
if|if
condition|(
name|en
operator|-
name|st
operator|<
literal|2
condition|)
block|{
name|x
operator|=
name|matchlen
argument_list|(
name|old
operator|+
name|I
index|[
name|st
index|]
argument_list|,
name|oldsize
operator|-
name|I
index|[
name|st
index|]
argument_list|,
name|new
argument_list|,
name|newsize
argument_list|)
expr_stmt|;
name|y
operator|=
name|matchlen
argument_list|(
name|old
operator|+
name|I
index|[
name|en
index|]
argument_list|,
name|oldsize
operator|-
name|I
index|[
name|en
index|]
argument_list|,
name|new
argument_list|,
name|newsize
argument_list|)
expr_stmt|;
if|if
condition|(
name|x
operator|>
name|y
condition|)
block|{
operator|*
name|pos
operator|=
name|I
index|[
name|st
index|]
expr_stmt|;
return|return
name|x
return|;
block|}
else|else
block|{
operator|*
name|pos
operator|=
name|I
index|[
name|en
index|]
expr_stmt|;
return|return
name|y
return|;
block|}
block|}
name|x
operator|=
name|st
operator|+
operator|(
name|en
operator|-
name|st
operator|)
operator|/
literal|2
expr_stmt|;
if|if
condition|(
name|memcmp
argument_list|(
name|old
operator|+
name|I
index|[
name|x
index|]
argument_list|,
name|new
argument_list|,
name|MIN
argument_list|(
name|oldsize
operator|-
name|I
index|[
name|x
index|]
argument_list|,
name|newsize
argument_list|)
argument_list|)
operator|<
literal|0
condition|)
block|{
return|return
name|search
argument_list|(
name|I
argument_list|,
name|old
argument_list|,
name|oldsize
argument_list|,
name|new
argument_list|,
name|newsize
argument_list|,
name|x
argument_list|,
name|en
argument_list|,
name|pos
argument_list|)
return|;
block|}
else|else
block|{
return|return
name|search
argument_list|(
name|I
argument_list|,
name|old
argument_list|,
name|oldsize
argument_list|,
name|new
argument_list|,
name|newsize
argument_list|,
name|st
argument_list|,
name|x
argument_list|,
name|pos
argument_list|)
return|;
block|}
empty_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|offtout
parameter_list|(
name|off_t
name|x
parameter_list|,
name|u_char
modifier|*
name|buf
parameter_list|)
block|{
name|off_t
name|y
decl_stmt|;
if|if
condition|(
name|x
operator|<
literal|0
condition|)
name|y
operator|=
operator|-
name|x
expr_stmt|;
else|else
name|y
operator|=
name|x
expr_stmt|;
name|buf
index|[
literal|0
index|]
operator|=
name|y
operator|%
literal|256
expr_stmt|;
name|y
operator|-=
name|buf
index|[
literal|0
index|]
expr_stmt|;
name|y
operator|=
name|y
operator|/
literal|256
expr_stmt|;
name|buf
index|[
literal|1
index|]
operator|=
name|y
operator|%
literal|256
expr_stmt|;
name|y
operator|-=
name|buf
index|[
literal|1
index|]
expr_stmt|;
name|y
operator|=
name|y
operator|/
literal|256
expr_stmt|;
name|buf
index|[
literal|2
index|]
operator|=
name|y
operator|%
literal|256
expr_stmt|;
name|y
operator|-=
name|buf
index|[
literal|2
index|]
expr_stmt|;
name|y
operator|=
name|y
operator|/
literal|256
expr_stmt|;
name|buf
index|[
literal|3
index|]
operator|=
name|y
operator|%
literal|256
expr_stmt|;
name|y
operator|-=
name|buf
index|[
literal|3
index|]
expr_stmt|;
name|y
operator|=
name|y
operator|/
literal|256
expr_stmt|;
name|buf
index|[
literal|4
index|]
operator|=
name|y
operator|%
literal|256
expr_stmt|;
name|y
operator|-=
name|buf
index|[
literal|4
index|]
expr_stmt|;
name|y
operator|=
name|y
operator|/
literal|256
expr_stmt|;
name|buf
index|[
literal|5
index|]
operator|=
name|y
operator|%
literal|256
expr_stmt|;
name|y
operator|-=
name|buf
index|[
literal|5
index|]
expr_stmt|;
name|y
operator|=
name|y
operator|/
literal|256
expr_stmt|;
name|buf
index|[
literal|6
index|]
operator|=
name|y
operator|%
literal|256
expr_stmt|;
name|y
operator|-=
name|buf
index|[
literal|6
index|]
expr_stmt|;
name|y
operator|=
name|y
operator|/
literal|256
expr_stmt|;
name|buf
index|[
literal|7
index|]
operator|=
name|y
operator|%
literal|256
expr_stmt|;
if|if
condition|(
name|x
operator|<
literal|0
condition|)
name|buf
index|[
literal|7
index|]
operator||=
literal|0x80
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|usage
parameter_list|(
name|void
parameter_list|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"usage: bsdiff oldfile newfile patchfile\n"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|int
name|main
parameter_list|(
name|int
name|argc
parameter_list|,
name|char
modifier|*
name|argv
index|[]
parameter_list|)
block|{
name|int
name|fd
decl_stmt|;
name|u_char
modifier|*
name|old
decl_stmt|,
modifier|*
name|new
decl_stmt|;
name|off_t
name|oldsize
decl_stmt|,
name|newsize
decl_stmt|;
name|off_t
modifier|*
name|I
decl_stmt|,
modifier|*
name|V
decl_stmt|;
name|off_t
name|scan
decl_stmt|,
name|pos
decl_stmt|,
name|len
decl_stmt|;
name|off_t
name|lastscan
decl_stmt|,
name|lastpos
decl_stmt|,
name|lastoffset
decl_stmt|;
name|off_t
name|oldscore
decl_stmt|,
name|scsc
decl_stmt|;
name|off_t
name|s
decl_stmt|,
name|Sf
decl_stmt|,
name|lenf
decl_stmt|,
name|Sb
decl_stmt|,
name|lenb
decl_stmt|;
name|off_t
name|overlap
decl_stmt|,
name|Ss
decl_stmt|,
name|lens
decl_stmt|;
name|off_t
name|i
decl_stmt|;
name|off_t
name|dblen
decl_stmt|,
name|eblen
decl_stmt|;
name|u_char
modifier|*
name|db
decl_stmt|,
modifier|*
name|eb
decl_stmt|;
name|u_char
name|buf
index|[
literal|8
index|]
decl_stmt|;
name|u_char
name|header
index|[
literal|32
index|]
decl_stmt|;
name|FILE
modifier|*
name|pf
decl_stmt|;
name|BZFILE
modifier|*
name|pfbz2
decl_stmt|;
name|int
name|bz2err
decl_stmt|;
if|if
condition|(
name|argc
operator|!=
literal|4
condition|)
name|usage
argument_list|()
expr_stmt|;
comment|/* Allocate oldsize+1 bytes instead of oldsize bytes to ensure 		that we never try to malloc(0) and get a NULL pointer */
if|if
condition|(
operator|(
operator|(
name|fd
operator|=
name|open
argument_list|(
name|argv
index|[
literal|1
index|]
argument_list|,
name|O_RDONLY
operator||
name|O_BINARY
argument_list|,
literal|0
argument_list|)
operator|)
operator|<
literal|0
operator|)
operator|||
operator|(
operator|(
name|oldsize
operator|=
name|lseek
argument_list|(
name|fd
argument_list|,
literal|0
argument_list|,
name|SEEK_END
argument_list|)
operator|)
operator|==
operator|-
literal|1
operator|)
condition|)
name|err
argument_list|(
literal|1
argument_list|,
literal|"%s"
argument_list|,
name|argv
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|oldsize
operator|>
name|SSIZE_MAX
operator|||
operator|(
name|uintmax_t
operator|)
name|oldsize
operator|>=
name|SIZE_T_MAX
operator|/
sizeof|sizeof
argument_list|(
name|off_t
argument_list|)
operator|||
name|oldsize
operator|==
name|OFF_MAX
condition|)
block|{
name|errno
operator|=
name|EFBIG
expr_stmt|;
name|err
argument_list|(
literal|1
argument_list|,
literal|"%s"
argument_list|,
name|argv
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|(
operator|(
name|old
operator|=
name|malloc
argument_list|(
name|oldsize
operator|+
literal|1
argument_list|)
operator|)
operator|==
name|NULL
operator|)
operator|||
operator|(
name|lseek
argument_list|(
name|fd
argument_list|,
literal|0
argument_list|,
name|SEEK_SET
argument_list|)
operator|!=
literal|0
operator|)
operator|||
operator|(
name|read
argument_list|(
name|fd
argument_list|,
name|old
argument_list|,
name|oldsize
argument_list|)
operator|!=
name|oldsize
operator|)
operator|||
operator|(
name|close
argument_list|(
name|fd
argument_list|)
operator|==
operator|-
literal|1
operator|)
condition|)
name|err
argument_list|(
literal|1
argument_list|,
literal|"%s"
argument_list|,
name|argv
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
operator|(
name|I
operator|=
name|malloc
argument_list|(
operator|(
name|oldsize
operator|+
literal|1
operator|)
operator|*
sizeof|sizeof
argument_list|(
name|off_t
argument_list|)
argument_list|)
operator|)
operator|==
name|NULL
operator|)
operator|||
operator|(
operator|(
name|V
operator|=
name|malloc
argument_list|(
operator|(
name|oldsize
operator|+
literal|1
operator|)
operator|*
sizeof|sizeof
argument_list|(
name|off_t
argument_list|)
argument_list|)
operator|)
operator|==
name|NULL
operator|)
condition|)
name|err
argument_list|(
literal|1
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|qsufsort
argument_list|(
name|I
argument_list|,
name|V
argument_list|,
name|old
argument_list|,
name|oldsize
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|V
argument_list|)
expr_stmt|;
comment|/* Allocate newsize+1 bytes instead of newsize bytes to ensure 		that we never try to malloc(0) and get a NULL pointer */
if|if
condition|(
operator|(
operator|(
name|fd
operator|=
name|open
argument_list|(
name|argv
index|[
literal|2
index|]
argument_list|,
name|O_RDONLY
operator||
name|O_BINARY
argument_list|,
literal|0
argument_list|)
operator|)
operator|<
literal|0
operator|)
operator|||
operator|(
operator|(
name|newsize
operator|=
name|lseek
argument_list|(
name|fd
argument_list|,
literal|0
argument_list|,
name|SEEK_END
argument_list|)
operator|)
operator|==
operator|-
literal|1
operator|)
condition|)
name|err
argument_list|(
literal|1
argument_list|,
literal|"%s"
argument_list|,
name|argv
index|[
literal|2
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|newsize
operator|>
name|SSIZE_MAX
operator|||
operator|(
name|uintmax_t
operator|)
name|newsize
operator|>=
name|SIZE_T_MAX
operator|||
name|newsize
operator|==
name|OFF_MAX
condition|)
block|{
name|errno
operator|=
name|EFBIG
expr_stmt|;
name|err
argument_list|(
literal|1
argument_list|,
literal|"%s"
argument_list|,
name|argv
index|[
literal|2
index|]
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|(
operator|(
name|new
operator|=
name|malloc
argument_list|(
name|newsize
operator|+
literal|1
argument_list|)
operator|)
operator|==
name|NULL
operator|)
operator|||
operator|(
name|lseek
argument_list|(
name|fd
argument_list|,
literal|0
argument_list|,
name|SEEK_SET
argument_list|)
operator|!=
literal|0
operator|)
operator|||
operator|(
name|read
argument_list|(
name|fd
argument_list|,
name|new
argument_list|,
name|newsize
argument_list|)
operator|!=
name|newsize
operator|)
operator|||
operator|(
name|close
argument_list|(
name|fd
argument_list|)
operator|==
operator|-
literal|1
operator|)
condition|)
name|err
argument_list|(
literal|1
argument_list|,
literal|"%s"
argument_list|,
name|argv
index|[
literal|2
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
operator|(
name|db
operator|=
name|malloc
argument_list|(
name|newsize
operator|+
literal|1
argument_list|)
operator|)
operator|==
name|NULL
operator|)
operator|||
operator|(
operator|(
name|eb
operator|=
name|malloc
argument_list|(
name|newsize
operator|+
literal|1
argument_list|)
operator|)
operator|==
name|NULL
operator|)
condition|)
name|err
argument_list|(
literal|1
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|dblen
operator|=
literal|0
expr_stmt|;
name|eblen
operator|=
literal|0
expr_stmt|;
comment|/* Create the patch file */
if|if
condition|(
operator|(
name|pf
operator|=
name|fopen
argument_list|(
name|argv
index|[
literal|3
index|]
argument_list|,
literal|"wb"
argument_list|)
operator|)
operator|==
name|NULL
condition|)
name|err
argument_list|(
literal|1
argument_list|,
literal|"%s"
argument_list|,
name|argv
index|[
literal|3
index|]
argument_list|)
expr_stmt|;
comment|/* Header is 		0	8	 "BSDIFF40" 		8	8	length of bzip2ed ctrl block 		16	8	length of bzip2ed diff block 		24	8	length of new file */
comment|/* File is 		0	32	Header 		32	??	Bzip2ed ctrl block 		??	??	Bzip2ed diff block 		??	??	Bzip2ed extra block */
name|memcpy
argument_list|(
name|header
argument_list|,
literal|"BSDIFF40"
argument_list|,
literal|8
argument_list|)
expr_stmt|;
name|offtout
argument_list|(
literal|0
argument_list|,
name|header
operator|+
literal|8
argument_list|)
expr_stmt|;
name|offtout
argument_list|(
literal|0
argument_list|,
name|header
operator|+
literal|16
argument_list|)
expr_stmt|;
name|offtout
argument_list|(
name|newsize
argument_list|,
name|header
operator|+
literal|24
argument_list|)
expr_stmt|;
if|if
condition|(
name|fwrite
argument_list|(
name|header
argument_list|,
literal|32
argument_list|,
literal|1
argument_list|,
name|pf
argument_list|)
operator|!=
literal|1
condition|)
name|err
argument_list|(
literal|1
argument_list|,
literal|"fwrite(%s)"
argument_list|,
name|argv
index|[
literal|3
index|]
argument_list|)
expr_stmt|;
comment|/* Compute the differences, writing ctrl as we go */
if|if
condition|(
operator|(
name|pfbz2
operator|=
name|BZ2_bzWriteOpen
argument_list|(
operator|&
name|bz2err
argument_list|,
name|pf
argument_list|,
literal|9
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
operator|)
operator|==
name|NULL
condition|)
name|errx
argument_list|(
literal|1
argument_list|,
literal|"BZ2_bzWriteOpen, bz2err = %d"
argument_list|,
name|bz2err
argument_list|)
expr_stmt|;
name|scan
operator|=
literal|0
expr_stmt|;
name|len
operator|=
literal|0
expr_stmt|;
name|pos
operator|=
literal|0
expr_stmt|;
name|lastscan
operator|=
literal|0
expr_stmt|;
name|lastpos
operator|=
literal|0
expr_stmt|;
name|lastoffset
operator|=
literal|0
expr_stmt|;
while|while
condition|(
name|scan
operator|<
name|newsize
condition|)
block|{
name|oldscore
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|scsc
operator|=
name|scan
operator|+=
name|len
init|;
name|scan
operator|<
name|newsize
condition|;
name|scan
operator|++
control|)
block|{
name|len
operator|=
name|search
argument_list|(
name|I
argument_list|,
name|old
argument_list|,
name|oldsize
argument_list|,
name|new
operator|+
name|scan
argument_list|,
name|newsize
operator|-
name|scan
argument_list|,
literal|0
argument_list|,
name|oldsize
argument_list|,
operator|&
name|pos
argument_list|)
expr_stmt|;
for|for
control|(
init|;
name|scsc
operator|<
name|scan
operator|+
name|len
condition|;
name|scsc
operator|++
control|)
if|if
condition|(
operator|(
name|scsc
operator|+
name|lastoffset
operator|<
name|oldsize
operator|)
operator|&&
operator|(
name|old
index|[
name|scsc
operator|+
name|lastoffset
index|]
operator|==
name|new
index|[
name|scsc
index|]
operator|)
condition|)
name|oldscore
operator|++
expr_stmt|;
if|if
condition|(
operator|(
operator|(
name|len
operator|==
name|oldscore
operator|)
operator|&&
operator|(
name|len
operator|!=
literal|0
operator|)
operator|)
operator|||
operator|(
name|len
operator|>
name|oldscore
operator|+
literal|8
operator|)
condition|)
break|break;
if|if
condition|(
operator|(
name|scan
operator|+
name|lastoffset
operator|<
name|oldsize
operator|)
operator|&&
operator|(
name|old
index|[
name|scan
operator|+
name|lastoffset
index|]
operator|==
name|new
index|[
name|scan
index|]
operator|)
condition|)
name|oldscore
operator|--
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|len
operator|!=
name|oldscore
operator|)
operator|||
operator|(
name|scan
operator|==
name|newsize
operator|)
condition|)
block|{
name|s
operator|=
literal|0
expr_stmt|;
name|Sf
operator|=
literal|0
expr_stmt|;
name|lenf
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
operator|(
name|lastscan
operator|+
name|i
operator|<
name|scan
operator|)
operator|&&
operator|(
name|lastpos
operator|+
name|i
operator|<
name|oldsize
operator|)
condition|;
control|)
block|{
if|if
condition|(
name|old
index|[
name|lastpos
operator|+
name|i
index|]
operator|==
name|new
index|[
name|lastscan
operator|+
name|i
index|]
condition|)
name|s
operator|++
expr_stmt|;
name|i
operator|++
expr_stmt|;
if|if
condition|(
name|s
operator|*
literal|2
operator|-
name|i
operator|>
name|Sf
operator|*
literal|2
operator|-
name|lenf
condition|)
block|{
name|Sf
operator|=
name|s
expr_stmt|;
name|lenf
operator|=
name|i
expr_stmt|;
block|}
block|}
name|lenb
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|scan
operator|<
name|newsize
condition|)
block|{
name|s
operator|=
literal|0
expr_stmt|;
name|Sb
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|1
init|;
operator|(
name|scan
operator|>=
name|lastscan
operator|+
name|i
operator|)
operator|&&
operator|(
name|pos
operator|>=
name|i
operator|)
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|old
index|[
name|pos
operator|-
name|i
index|]
operator|==
name|new
index|[
name|scan
operator|-
name|i
index|]
condition|)
name|s
operator|++
expr_stmt|;
if|if
condition|(
name|s
operator|*
literal|2
operator|-
name|i
operator|>
name|Sb
operator|*
literal|2
operator|-
name|lenb
condition|)
block|{
name|Sb
operator|=
name|s
expr_stmt|;
name|lenb
operator|=
name|i
expr_stmt|;
block|}
block|}
block|}
if|if
condition|(
name|lastscan
operator|+
name|lenf
operator|>
name|scan
operator|-
name|lenb
condition|)
block|{
name|overlap
operator|=
operator|(
name|lastscan
operator|+
name|lenf
operator|)
operator|-
operator|(
name|scan
operator|-
name|lenb
operator|)
expr_stmt|;
name|s
operator|=
literal|0
expr_stmt|;
name|Ss
operator|=
literal|0
expr_stmt|;
name|lens
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|overlap
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|new
index|[
name|lastscan
operator|+
name|lenf
operator|-
name|overlap
operator|+
name|i
index|]
operator|==
name|old
index|[
name|lastpos
operator|+
name|lenf
operator|-
name|overlap
operator|+
name|i
index|]
condition|)
name|s
operator|++
expr_stmt|;
if|if
condition|(
name|new
index|[
name|scan
operator|-
name|lenb
operator|+
name|i
index|]
operator|==
name|old
index|[
name|pos
operator|-
name|lenb
operator|+
name|i
index|]
condition|)
name|s
operator|--
expr_stmt|;
if|if
condition|(
name|s
operator|>
name|Ss
condition|)
block|{
name|Ss
operator|=
name|s
expr_stmt|;
name|lens
operator|=
name|i
operator|+
literal|1
expr_stmt|;
block|}
block|}
name|lenf
operator|+=
name|lens
operator|-
name|overlap
expr_stmt|;
name|lenb
operator|-=
name|lens
expr_stmt|;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|lenf
condition|;
name|i
operator|++
control|)
name|db
index|[
name|dblen
operator|+
name|i
index|]
operator|=
name|new
index|[
name|lastscan
operator|+
name|i
index|]
operator|-
name|old
index|[
name|lastpos
operator|+
name|i
index|]
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
operator|(
name|scan
operator|-
name|lenb
operator|)
operator|-
operator|(
name|lastscan
operator|+
name|lenf
operator|)
condition|;
name|i
operator|++
control|)
name|eb
index|[
name|eblen
operator|+
name|i
index|]
operator|=
name|new
index|[
name|lastscan
operator|+
name|lenf
operator|+
name|i
index|]
expr_stmt|;
name|dblen
operator|+=
name|lenf
expr_stmt|;
name|eblen
operator|+=
operator|(
name|scan
operator|-
name|lenb
operator|)
operator|-
operator|(
name|lastscan
operator|+
name|lenf
operator|)
expr_stmt|;
name|offtout
argument_list|(
name|lenf
argument_list|,
name|buf
argument_list|)
expr_stmt|;
name|BZ2_bzWrite
argument_list|(
operator|&
name|bz2err
argument_list|,
name|pfbz2
argument_list|,
name|buf
argument_list|,
literal|8
argument_list|)
expr_stmt|;
if|if
condition|(
name|bz2err
operator|!=
name|BZ_OK
condition|)
name|errx
argument_list|(
literal|1
argument_list|,
literal|"BZ2_bzWrite, bz2err = %d"
argument_list|,
name|bz2err
argument_list|)
expr_stmt|;
name|offtout
argument_list|(
operator|(
name|scan
operator|-
name|lenb
operator|)
operator|-
operator|(
name|lastscan
operator|+
name|lenf
operator|)
argument_list|,
name|buf
argument_list|)
expr_stmt|;
name|BZ2_bzWrite
argument_list|(
operator|&
name|bz2err
argument_list|,
name|pfbz2
argument_list|,
name|buf
argument_list|,
literal|8
argument_list|)
expr_stmt|;
if|if
condition|(
name|bz2err
operator|!=
name|BZ_OK
condition|)
name|errx
argument_list|(
literal|1
argument_list|,
literal|"BZ2_bzWrite, bz2err = %d"
argument_list|,
name|bz2err
argument_list|)
expr_stmt|;
name|offtout
argument_list|(
operator|(
name|pos
operator|-
name|lenb
operator|)
operator|-
operator|(
name|lastpos
operator|+
name|lenf
operator|)
argument_list|,
name|buf
argument_list|)
expr_stmt|;
name|BZ2_bzWrite
argument_list|(
operator|&
name|bz2err
argument_list|,
name|pfbz2
argument_list|,
name|buf
argument_list|,
literal|8
argument_list|)
expr_stmt|;
if|if
condition|(
name|bz2err
operator|!=
name|BZ_OK
condition|)
name|errx
argument_list|(
literal|1
argument_list|,
literal|"BZ2_bzWrite, bz2err = %d"
argument_list|,
name|bz2err
argument_list|)
expr_stmt|;
name|lastscan
operator|=
name|scan
operator|-
name|lenb
expr_stmt|;
name|lastpos
operator|=
name|pos
operator|-
name|lenb
expr_stmt|;
name|lastoffset
operator|=
name|pos
operator|-
name|scan
expr_stmt|;
block|}
block|}
name|BZ2_bzWriteClose
argument_list|(
operator|&
name|bz2err
argument_list|,
name|pfbz2
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|bz2err
operator|!=
name|BZ_OK
condition|)
name|errx
argument_list|(
literal|1
argument_list|,
literal|"BZ2_bzWriteClose, bz2err = %d"
argument_list|,
name|bz2err
argument_list|)
expr_stmt|;
comment|/* Compute size of compressed ctrl data */
if|if
condition|(
operator|(
name|len
operator|=
name|ftello
argument_list|(
name|pf
argument_list|)
operator|)
operator|==
operator|-
literal|1
condition|)
name|err
argument_list|(
literal|1
argument_list|,
literal|"ftello"
argument_list|)
expr_stmt|;
name|offtout
argument_list|(
name|len
operator|-
literal|32
argument_list|,
name|header
operator|+
literal|8
argument_list|)
expr_stmt|;
comment|/* Write compressed diff data */
if|if
condition|(
operator|(
name|pfbz2
operator|=
name|BZ2_bzWriteOpen
argument_list|(
operator|&
name|bz2err
argument_list|,
name|pf
argument_list|,
literal|9
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
operator|)
operator|==
name|NULL
condition|)
name|errx
argument_list|(
literal|1
argument_list|,
literal|"BZ2_bzWriteOpen, bz2err = %d"
argument_list|,
name|bz2err
argument_list|)
expr_stmt|;
name|BZ2_bzWrite
argument_list|(
operator|&
name|bz2err
argument_list|,
name|pfbz2
argument_list|,
name|db
argument_list|,
name|dblen
argument_list|)
expr_stmt|;
if|if
condition|(
name|bz2err
operator|!=
name|BZ_OK
condition|)
name|errx
argument_list|(
literal|1
argument_list|,
literal|"BZ2_bzWrite, bz2err = %d"
argument_list|,
name|bz2err
argument_list|)
expr_stmt|;
name|BZ2_bzWriteClose
argument_list|(
operator|&
name|bz2err
argument_list|,
name|pfbz2
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|bz2err
operator|!=
name|BZ_OK
condition|)
name|errx
argument_list|(
literal|1
argument_list|,
literal|"BZ2_bzWriteClose, bz2err = %d"
argument_list|,
name|bz2err
argument_list|)
expr_stmt|;
comment|/* Compute size of compressed diff data */
if|if
condition|(
operator|(
name|newsize
operator|=
name|ftello
argument_list|(
name|pf
argument_list|)
operator|)
operator|==
operator|-
literal|1
condition|)
name|err
argument_list|(
literal|1
argument_list|,
literal|"ftello"
argument_list|)
expr_stmt|;
name|offtout
argument_list|(
name|newsize
operator|-
name|len
argument_list|,
name|header
operator|+
literal|16
argument_list|)
expr_stmt|;
comment|/* Write compressed extra data */
if|if
condition|(
operator|(
name|pfbz2
operator|=
name|BZ2_bzWriteOpen
argument_list|(
operator|&
name|bz2err
argument_list|,
name|pf
argument_list|,
literal|9
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
operator|)
operator|==
name|NULL
condition|)
name|errx
argument_list|(
literal|1
argument_list|,
literal|"BZ2_bzWriteOpen, bz2err = %d"
argument_list|,
name|bz2err
argument_list|)
expr_stmt|;
name|BZ2_bzWrite
argument_list|(
operator|&
name|bz2err
argument_list|,
name|pfbz2
argument_list|,
name|eb
argument_list|,
name|eblen
argument_list|)
expr_stmt|;
if|if
condition|(
name|bz2err
operator|!=
name|BZ_OK
condition|)
name|errx
argument_list|(
literal|1
argument_list|,
literal|"BZ2_bzWrite, bz2err = %d"
argument_list|,
name|bz2err
argument_list|)
expr_stmt|;
name|BZ2_bzWriteClose
argument_list|(
operator|&
name|bz2err
argument_list|,
name|pfbz2
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|bz2err
operator|!=
name|BZ_OK
condition|)
name|errx
argument_list|(
literal|1
argument_list|,
literal|"BZ2_bzWriteClose, bz2err = %d"
argument_list|,
name|bz2err
argument_list|)
expr_stmt|;
comment|/* Seek to the beginning, write the header, and close the file */
if|if
condition|(
name|fseeko
argument_list|(
name|pf
argument_list|,
literal|0
argument_list|,
name|SEEK_SET
argument_list|)
condition|)
name|err
argument_list|(
literal|1
argument_list|,
literal|"fseeko"
argument_list|)
expr_stmt|;
if|if
condition|(
name|fwrite
argument_list|(
name|header
argument_list|,
literal|32
argument_list|,
literal|1
argument_list|,
name|pf
argument_list|)
operator|!=
literal|1
condition|)
name|err
argument_list|(
literal|1
argument_list|,
literal|"fwrite(%s)"
argument_list|,
name|argv
index|[
literal|3
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|fclose
argument_list|(
name|pf
argument_list|)
condition|)
name|err
argument_list|(
literal|1
argument_list|,
literal|"fclose"
argument_list|)
expr_stmt|;
comment|/* Free the memory we used */
name|free
argument_list|(
name|db
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|eb
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|I
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|old
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|new
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

end_unit


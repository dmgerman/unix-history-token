begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*-  * Copyright (c) 2007 Robert N. M. Watson  * All rights reserved.  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions  * are met:  * 1. Redistributions of source code must retain the above copyright  *    notice, this list of conditions and the following disclaimer.  * 2. Redistributions in binary form must reproduce the above copyright  *    notice, this list of conditions and the following disclaimer in the  *    documentation and/or other materials provided with the distribution.  *  * THIS SOFTWARE IS PROVIDED BY THE AUTHOR AND CONTRIBUTORS ``AS IS'' AND  * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE  * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE  * ARE DISCLAIMED.  IN NO EVENT SHALL THE AUTHOR OR CONTRIBUTORS BE LIABLE  * FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL  * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS  * OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)  * HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT  * LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY  * OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF  * SUCH DAMAGE.  *  * $FreeBSD$  */
end_comment

begin_include
include|#
directive|include
file|<sys/param.h>
end_include

begin_include
include|#
directive|include
file|<sys/socket.h>
end_include

begin_include
include|#
directive|include
file|<sys/sysctl.h>
end_include

begin_include
include|#
directive|include
file|<sys/un.h>
end_include

begin_include
include|#
directive|include
file|<sys/user.h>
end_include

begin_include
include|#
directive|include
file|<netinet/in.h>
end_include

begin_include
include|#
directive|include
file|<arpa/inet.h>
end_include

begin_include
include|#
directive|include
file|<err.h>
end_include

begin_include
include|#
directive|include
file|<inttypes.h>
end_include

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_include
include|#
directive|include
file|<stdlib.h>
end_include

begin_include
include|#
directive|include
file|<string.h>
end_include

begin_include
include|#
directive|include
file|<libutil.h>
end_include

begin_include
include|#
directive|include
file|"procstat.h"
end_include

begin_function
specifier|static
specifier|const
name|char
modifier|*
name|protocol_to_string
parameter_list|(
name|int
name|domain
parameter_list|,
name|int
name|type
parameter_list|,
name|int
name|protocol
parameter_list|)
block|{
switch|switch
condition|(
name|domain
condition|)
block|{
case|case
name|AF_INET
case|:
case|case
name|AF_INET6
case|:
switch|switch
condition|(
name|protocol
condition|)
block|{
case|case
name|IPPROTO_TCP
case|:
return|return
operator|(
literal|"TCP"
operator|)
return|;
case|case
name|IPPROTO_UDP
case|:
return|return
operator|(
literal|"UDP"
operator|)
return|;
case|case
name|IPPROTO_ICMP
case|:
return|return
operator|(
literal|"ICM"
operator|)
return|;
case|case
name|IPPROTO_RAW
case|:
return|return
operator|(
literal|"RAW"
operator|)
return|;
case|case
name|IPPROTO_SCTP
case|:
return|return
operator|(
literal|"SCT"
operator|)
return|;
case|case
name|IPPROTO_DIVERT
case|:
return|return
operator|(
literal|"IPD"
operator|)
return|;
default|default:
return|return
operator|(
literal|"IP?"
operator|)
return|;
block|}
case|case
name|AF_LOCAL
case|:
switch|switch
condition|(
name|type
condition|)
block|{
case|case
name|SOCK_STREAM
case|:
return|return
operator|(
literal|"UDS"
operator|)
return|;
case|case
name|SOCK_DGRAM
case|:
return|return
operator|(
literal|"UDD"
operator|)
return|;
default|default:
return|return
operator|(
literal|"UD?"
operator|)
return|;
block|}
default|default:
return|return
operator|(
literal|"?"
operator|)
return|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|addr_to_string
parameter_list|(
name|struct
name|sockaddr_storage
modifier|*
name|ss
parameter_list|,
name|char
modifier|*
name|buffer
parameter_list|,
name|int
name|buflen
parameter_list|)
block|{
name|char
name|buffer2
index|[
name|INET6_ADDRSTRLEN
index|]
decl_stmt|;
name|struct
name|sockaddr_in6
modifier|*
name|sin6
decl_stmt|;
name|struct
name|sockaddr_in
modifier|*
name|sin
decl_stmt|;
name|struct
name|sockaddr_un
modifier|*
name|sun
decl_stmt|;
switch|switch
condition|(
name|ss
operator|->
name|ss_family
condition|)
block|{
case|case
name|AF_LOCAL
case|:
name|sun
operator|=
operator|(
expr|struct
name|sockaddr_un
operator|*
operator|)
name|ss
expr_stmt|;
if|if
condition|(
name|strlen
argument_list|(
name|sun
operator|->
name|sun_path
argument_list|)
operator|==
literal|0
condition|)
name|strlcpy
argument_list|(
name|buffer
argument_list|,
literal|"-"
argument_list|,
name|buflen
argument_list|)
expr_stmt|;
else|else
name|strlcpy
argument_list|(
name|buffer
argument_list|,
name|sun
operator|->
name|sun_path
argument_list|,
name|buflen
argument_list|)
expr_stmt|;
break|break;
case|case
name|AF_INET
case|:
name|sin
operator|=
operator|(
expr|struct
name|sockaddr_in
operator|*
operator|)
name|ss
expr_stmt|;
name|snprintf
argument_list|(
name|buffer
argument_list|,
name|buflen
argument_list|,
literal|"%s:%d"
argument_list|,
name|inet_ntoa
argument_list|(
name|sin
operator|->
name|sin_addr
argument_list|)
argument_list|,
name|ntohs
argument_list|(
name|sin
operator|->
name|sin_port
argument_list|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|AF_INET6
case|:
name|sin6
operator|=
operator|(
expr|struct
name|sockaddr_in6
operator|*
operator|)
name|ss
expr_stmt|;
if|if
condition|(
name|inet_ntop
argument_list|(
name|AF_INET6
argument_list|,
operator|&
name|sin6
operator|->
name|sin6_addr
argument_list|,
name|buffer2
argument_list|,
sizeof|sizeof
argument_list|(
name|buffer2
argument_list|)
argument_list|)
operator|!=
name|NULL
condition|)
name|snprintf
argument_list|(
name|buffer
argument_list|,
name|buflen
argument_list|,
literal|"%s.%d"
argument_list|,
name|buffer2
argument_list|,
name|ntohs
argument_list|(
name|sin6
operator|->
name|sin6_port
argument_list|)
argument_list|)
expr_stmt|;
else|else
name|strlcpy
argument_list|(
name|buffer
argument_list|,
literal|"-"
argument_list|,
sizeof|sizeof
argument_list|(
name|buffer
argument_list|)
argument_list|)
expr_stmt|;
break|break;
default|default:
name|strlcpy
argument_list|(
name|buffer
argument_list|,
literal|""
argument_list|,
name|buflen
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|print_address
parameter_list|(
name|struct
name|sockaddr_storage
modifier|*
name|ss
parameter_list|)
block|{
name|char
name|addr
index|[
name|PATH_MAX
index|]
decl_stmt|;
name|addr_to_string
argument_list|(
name|ss
argument_list|,
name|addr
argument_list|,
sizeof|sizeof
argument_list|(
name|addr
argument_list|)
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"%s"
argument_list|,
name|addr
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|procstat_files
parameter_list|(
name|pid_t
name|pid
parameter_list|,
name|struct
name|kinfo_proc
modifier|*
name|kipp
parameter_list|)
block|{
name|struct
name|kinfo_file
modifier|*
name|freep
decl_stmt|,
modifier|*
name|kif
decl_stmt|;
name|int
name|i
decl_stmt|,
name|cnt
decl_stmt|;
specifier|const
name|char
modifier|*
name|str
decl_stmt|;
if|if
condition|(
operator|!
name|hflag
condition|)
name|printf
argument_list|(
literal|"%5s %-16s %4s %1s %1s %-8s %3s %7s %-3s %-12s\n"
argument_list|,
literal|"PID"
argument_list|,
literal|"COMM"
argument_list|,
literal|"FD"
argument_list|,
literal|"T"
argument_list|,
literal|"V"
argument_list|,
literal|"FLAGS"
argument_list|,
literal|"REF"
argument_list|,
literal|"OFFSET"
argument_list|,
literal|"PRO"
argument_list|,
literal|"NAME"
argument_list|)
expr_stmt|;
name|freep
operator|=
name|kinfo_getfile
argument_list|(
name|pid
argument_list|,
operator|&
name|cnt
argument_list|)
expr_stmt|;
if|if
condition|(
name|freep
operator|==
name|NULL
condition|)
return|return;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|cnt
condition|;
name|i
operator|++
control|)
block|{
name|kif
operator|=
operator|&
name|freep
index|[
name|i
index|]
expr_stmt|;
name|printf
argument_list|(
literal|"%5d "
argument_list|,
name|pid
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"%-16s "
argument_list|,
name|kipp
operator|->
name|ki_comm
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|kif
operator|->
name|kf_fd
condition|)
block|{
case|case
name|KF_FD_TYPE_CWD
case|:
name|printf
argument_list|(
literal|" cwd "
argument_list|)
expr_stmt|;
break|break;
case|case
name|KF_FD_TYPE_ROOT
case|:
name|printf
argument_list|(
literal|"root "
argument_list|)
expr_stmt|;
break|break;
case|case
name|KF_FD_TYPE_JAIL
case|:
name|printf
argument_list|(
literal|"jail "
argument_list|)
expr_stmt|;
break|break;
default|default:
name|printf
argument_list|(
literal|"%4d "
argument_list|,
name|kif
operator|->
name|kf_fd
argument_list|)
expr_stmt|;
break|break;
block|}
switch|switch
condition|(
name|kif
operator|->
name|kf_type
condition|)
block|{
case|case
name|KF_TYPE_VNODE
case|:
name|str
operator|=
literal|"v"
expr_stmt|;
break|break;
case|case
name|KF_TYPE_SOCKET
case|:
name|str
operator|=
literal|"s"
expr_stmt|;
break|break;
case|case
name|KF_TYPE_PIPE
case|:
name|str
operator|=
literal|"p"
expr_stmt|;
break|break;
case|case
name|KF_TYPE_FIFO
case|:
name|str
operator|=
literal|"f"
expr_stmt|;
break|break;
case|case
name|KF_TYPE_KQUEUE
case|:
name|str
operator|=
literal|"k"
expr_stmt|;
break|break;
case|case
name|KF_TYPE_CRYPTO
case|:
name|str
operator|=
literal|"c"
expr_stmt|;
break|break;
case|case
name|KF_TYPE_MQUEUE
case|:
name|str
operator|=
literal|"m"
expr_stmt|;
break|break;
case|case
name|KF_TYPE_SHM
case|:
name|str
operator|=
literal|"h"
expr_stmt|;
break|break;
case|case
name|KF_TYPE_PTS
case|:
name|str
operator|=
literal|"t"
expr_stmt|;
break|break;
case|case
name|KF_TYPE_SEM
case|:
name|str
operator|=
literal|"e"
expr_stmt|;
break|break;
case|case
name|KF_TYPE_NONE
case|:
case|case
name|KF_TYPE_UNKNOWN
case|:
default|default:
name|str
operator|=
literal|"?"
expr_stmt|;
break|break;
block|}
name|printf
argument_list|(
literal|"%1s "
argument_list|,
name|str
argument_list|)
expr_stmt|;
name|str
operator|=
literal|"-"
expr_stmt|;
if|if
condition|(
name|kif
operator|->
name|kf_type
operator|==
name|KF_TYPE_VNODE
condition|)
block|{
switch|switch
condition|(
name|kif
operator|->
name|kf_vnode_type
condition|)
block|{
case|case
name|KF_VTYPE_VREG
case|:
name|str
operator|=
literal|"r"
expr_stmt|;
break|break;
case|case
name|KF_VTYPE_VDIR
case|:
name|str
operator|=
literal|"d"
expr_stmt|;
break|break;
case|case
name|KF_VTYPE_VBLK
case|:
name|str
operator|=
literal|"b"
expr_stmt|;
break|break;
case|case
name|KF_VTYPE_VCHR
case|:
name|str
operator|=
literal|"c"
expr_stmt|;
break|break;
case|case
name|KF_VTYPE_VLNK
case|:
name|str
operator|=
literal|"l"
expr_stmt|;
break|break;
case|case
name|KF_VTYPE_VSOCK
case|:
name|str
operator|=
literal|"s"
expr_stmt|;
break|break;
case|case
name|KF_VTYPE_VFIFO
case|:
name|str
operator|=
literal|"f"
expr_stmt|;
break|break;
case|case
name|KF_VTYPE_VBAD
case|:
name|str
operator|=
literal|"x"
expr_stmt|;
break|break;
case|case
name|KF_VTYPE_VNON
case|:
case|case
name|KF_VTYPE_UNKNOWN
case|:
default|default:
name|str
operator|=
literal|"?"
expr_stmt|;
break|break;
block|}
block|}
name|printf
argument_list|(
literal|"%1s "
argument_list|,
name|str
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"%s"
argument_list|,
name|kif
operator|->
name|kf_flags
operator|&
name|KF_FLAG_READ
condition|?
literal|"r"
else|:
literal|"-"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"%s"
argument_list|,
name|kif
operator|->
name|kf_flags
operator|&
name|KF_FLAG_WRITE
condition|?
literal|"w"
else|:
literal|"-"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"%s"
argument_list|,
name|kif
operator|->
name|kf_flags
operator|&
name|KF_FLAG_APPEND
condition|?
literal|"a"
else|:
literal|"-"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"%s"
argument_list|,
name|kif
operator|->
name|kf_flags
operator|&
name|KF_FLAG_ASYNC
condition|?
literal|"s"
else|:
literal|"-"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"%s"
argument_list|,
name|kif
operator|->
name|kf_flags
operator|&
name|KF_FLAG_FSYNC
condition|?
literal|"f"
else|:
literal|"-"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"%s"
argument_list|,
name|kif
operator|->
name|kf_flags
operator|&
name|KF_FLAG_NONBLOCK
condition|?
literal|"n"
else|:
literal|"-"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"%s"
argument_list|,
name|kif
operator|->
name|kf_flags
operator|&
name|KF_FLAG_DIRECT
condition|?
literal|"d"
else|:
literal|"-"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"%s "
argument_list|,
name|kif
operator|->
name|kf_flags
operator|&
name|KF_FLAG_HASLOCK
condition|?
literal|"l"
else|:
literal|"-"
argument_list|)
expr_stmt|;
if|if
condition|(
name|kif
operator|->
name|kf_ref_count
operator|>
operator|-
literal|1
condition|)
name|printf
argument_list|(
literal|"%3d "
argument_list|,
name|kif
operator|->
name|kf_ref_count
argument_list|)
expr_stmt|;
else|else
name|printf
argument_list|(
literal|"%3c "
argument_list|,
literal|'-'
argument_list|)
expr_stmt|;
if|if
condition|(
name|kif
operator|->
name|kf_offset
operator|>
operator|-
literal|1
condition|)
name|printf
argument_list|(
literal|"%7jd "
argument_list|,
operator|(
name|intmax_t
operator|)
name|kif
operator|->
name|kf_offset
argument_list|)
expr_stmt|;
else|else
name|printf
argument_list|(
literal|"%7c "
argument_list|,
literal|'-'
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|kif
operator|->
name|kf_type
condition|)
block|{
case|case
name|KF_TYPE_SOCKET
case|:
name|printf
argument_list|(
literal|"%-3s "
argument_list|,
name|protocol_to_string
argument_list|(
name|kif
operator|->
name|kf_sock_domain
argument_list|,
name|kif
operator|->
name|kf_sock_type
argument_list|,
name|kif
operator|->
name|kf_sock_protocol
argument_list|)
argument_list|)
expr_stmt|;
comment|/* 			 * While generally we like to print two addresses, 			 * local and peer, for sockets, it turns out to be 			 * more useful to print the first non-nul address for 			 * local sockets, as typically they aren't bound and 			 *  connected, and the path strings can get long. 			 */
if|if
condition|(
name|kif
operator|->
name|kf_sock_domain
operator|==
name|AF_LOCAL
condition|)
block|{
name|struct
name|sockaddr_un
modifier|*
name|sun
init|=
operator|(
expr|struct
name|sockaddr_un
operator|*
operator|)
operator|&
name|kif
operator|->
name|kf_sa_local
decl_stmt|;
if|if
condition|(
name|sun
operator|->
name|sun_path
index|[
literal|0
index|]
operator|!=
literal|0
condition|)
name|print_address
argument_list|(
operator|&
name|kif
operator|->
name|kf_sa_local
argument_list|)
expr_stmt|;
else|else
name|print_address
argument_list|(
operator|&
name|kif
operator|->
name|kf_sa_peer
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|print_address
argument_list|(
operator|&
name|kif
operator|->
name|kf_sa_local
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|" "
argument_list|)
expr_stmt|;
name|print_address
argument_list|(
operator|&
name|kif
operator|->
name|kf_sa_peer
argument_list|)
expr_stmt|;
block|}
break|break;
default|default:
name|printf
argument_list|(
literal|"%-3s "
argument_list|,
literal|"-"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"%-18s"
argument_list|,
name|kif
operator|->
name|kf_path
index|[
literal|0
index|]
operator|!=
literal|'\0'
condition|?
name|kif
operator|->
name|kf_path
else|:
literal|"-"
argument_list|)
expr_stmt|;
block|}
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
block|}
name|free
argument_list|(
name|freep
argument_list|)
expr_stmt|;
block|}
end_function

end_unit


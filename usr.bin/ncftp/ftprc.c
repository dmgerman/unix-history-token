begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/* ftprc.c */
end_comment

begin_comment
comment|/*  $RCSfile: ftprc.c,v $  *  $Revision: 14020.11 $  *  $Date: 93/07/09 10:58:37 $  */
end_comment

begin_include
include|#
directive|include
file|"sys.h"
end_include

begin_include
include|#
directive|include
file|<sys/stat.h>
end_include

begin_include
include|#
directive|include
file|<ctype.h>
end_include

begin_include
include|#
directive|include
file|<signal.h>
end_include

begin_include
include|#
directive|include
file|"util.h"
end_include

begin_include
include|#
directive|include
file|"ftprc.h"
end_include

begin_include
include|#
directive|include
file|"main.h"
end_include

begin_include
include|#
directive|include
file|"cmds.h"
end_include

begin_include
include|#
directive|include
file|"set.h"
end_include

begin_include
include|#
directive|include
file|"defaults.h"
end_include

begin_include
include|#
directive|include
file|"copyright.h"
end_include

begin_comment
comment|/* ftprc.c global variables */
end_comment

begin_decl_stmt
name|siteptr
name|firstsite
init|=
name|NULL
decl_stmt|,
name|lastsite
init|=
name|NULL
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|recentsite
name|recents
index|[
name|dMAXRECENTS
index|]
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|nRecents
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|nSites
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|keep_recent
init|=
name|dRECENT_ON
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|longstring
name|rcname
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|longstring
name|recent_file
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|parsing_rc
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|extern
name|char
modifier|*
name|line
decl_stmt|,
modifier|*
name|margv
index|[]
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|extern
name|int
name|margc
decl_stmt|,
name|fromatty
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|extern
name|string
name|anon_password
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* most likely your email address */
end_comment

begin_decl_stmt
specifier|extern
name|string
name|pager
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|extern
name|struct
name|userinfo
name|uinfo
decl_stmt|;
end_decl_stmt

begin_function
name|int
name|thrash_rc
parameter_list|(
name|void
parameter_list|)
block|{
name|struct
name|stat
name|st
decl_stmt|;
name|string
name|word
decl_stmt|,
name|str
decl_stmt|;
name|longstring
name|cwd
decl_stmt|;
name|char
modifier|*
name|cp
decl_stmt|,
modifier|*
name|dp
decl_stmt|,
modifier|*
name|rc
decl_stmt|;
name|FILE
modifier|*
name|fp
decl_stmt|;
name|int
name|i
decl_stmt|;
operator|(
name|void
operator|)
name|get_cwd
argument_list|(
name|cwd
argument_list|,
sizeof|sizeof
argument_list|(
name|cwd
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|cwd
index|[
name|strlen
argument_list|(
name|cwd
argument_list|)
operator|-
literal|1
index|]
operator|!=
literal|'/'
condition|)
operator|(
name|void
operator|)
name|Strncat
argument_list|(
name|cwd
argument_list|,
literal|"/"
argument_list|)
expr_stmt|;
comment|/* Because some versions of regular ftp complain about ncftp's 	 * #set commands, FTPRC takes precedence over NETRC. 	 */
name|cp
operator|=
name|getenv
argument_list|(
literal|"DOTDIR"
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|2
condition|;
name|i
operator|++
control|)
block|{
name|rc
operator|=
operator|(
name|i
operator|==
literal|0
operator|)
condition|?
name|FTPRC
else|:
name|NETRC
expr_stmt|;
operator|(
name|void
operator|)
name|sprintf
argument_list|(
name|rcname
argument_list|,
literal|"%s%s"
argument_list|,
name|cwd
argument_list|,
name|rc
argument_list|)
expr_stmt|;
if|if
condition|(
name|stat
argument_list|(
name|rcname
argument_list|,
operator|&
name|st
argument_list|)
operator|==
literal|0
condition|)
goto|goto
name|foundrc
goto|;
operator|(
name|void
operator|)
name|sprintf
argument_list|(
name|rcname
argument_list|,
literal|"%s.%s"
argument_list|,
name|cwd
argument_list|,
name|rc
argument_list|)
expr_stmt|;
if|if
condition|(
name|stat
argument_list|(
name|rcname
argument_list|,
operator|&
name|st
argument_list|)
operator|==
literal|0
condition|)
goto|goto
name|foundrc
goto|;
if|if
condition|(
name|cp
operator|!=
name|NULL
condition|)
block|{
operator|(
name|void
operator|)
name|sprintf
argument_list|(
name|rcname
argument_list|,
literal|"%s/.%s"
argument_list|,
name|cp
argument_list|,
name|rc
argument_list|)
expr_stmt|;
if|if
condition|(
name|stat
argument_list|(
name|rcname
argument_list|,
operator|&
name|st
argument_list|)
operator|==
literal|0
condition|)
goto|goto
name|foundrc
goto|;
block|}
operator|(
name|void
operator|)
name|sprintf
argument_list|(
name|rcname
argument_list|,
literal|"%s/.%s"
argument_list|,
name|uinfo
operator|.
name|homedir
argument_list|,
name|rc
argument_list|)
expr_stmt|;
if|if
condition|(
name|stat
argument_list|(
name|rcname
argument_list|,
operator|&
name|st
argument_list|)
operator|==
literal|0
condition|)
goto|goto
name|foundrc
goto|;
block|}
return|return
operator|(
literal|0
operator|)
return|;
comment|/* it's OK not to have an rc. */
name|foundrc
label|:
if|if
condition|(
operator|(
name|st
operator|.
name|st_mode
operator|&
literal|077
operator|)
operator|!=
literal|0
condition|)
comment|/* rc must be unreadable by others. */
operator|(
name|void
operator|)
name|chmod
argument_list|(
name|rcname
argument_list|,
literal|0600
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|fp
operator|=
name|fopen
argument_list|(
name|rcname
argument_list|,
literal|"r"
argument_list|)
operator|)
operator|==
name|NULL
condition|)
block|{
name|PERROR
argument_list|(
literal|"thrash_rc"
argument_list|,
name|rcname
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|parsing_rc
operator|=
literal|1
expr_stmt|;
while|while
condition|(
operator|(
name|cp
operator|=
name|FGets
argument_list|(
name|str
argument_list|,
name|fp
argument_list|)
operator|)
operator|!=
literal|0
condition|)
block|{
while|while
condition|(
name|isspace
argument_list|(
operator|*
name|cp
argument_list|)
condition|)
operator|++
name|cp
expr_stmt|;
comment|/* skip leading space. */
if|if
condition|(
operator|*
name|cp
operator|==
literal|'#'
condition|)
block|{
if|if
condition|(
operator|(
name|strncmp
argument_list|(
literal|"set"
argument_list|,
operator|++
name|cp
argument_list|,
operator|(
name|size_t
operator|)
literal|3
argument_list|)
operator|==
literal|0
operator|)
operator|||
operator|(
name|strncmp
argument_list|(
literal|"unset"
argument_list|,
name|cp
argument_list|,
operator|(
name|size_t
operator|)
literal|5
argument_list|)
operator|==
literal|0
operator|)
condition|)
block|{
operator|(
name|void
operator|)
name|strcpy
argument_list|(
name|line
argument_list|,
name|cp
argument_list|)
expr_stmt|;
name|makeargv
argument_list|()
expr_stmt|;
operator|(
name|void
operator|)
name|set
argument_list|(
name|margc
argument_list|,
name|margv
argument_list|)
expr_stmt|;
comment|/* setting or unsetting a variable. */
block|}
comment|/* else a comment. */
block|}
else|else
block|{
if|if
condition|(
name|strncmp
argument_list|(
name|cp
argument_list|,
literal|"machine"
argument_list|,
operator|(
name|size_t
operator|)
literal|7
argument_list|)
operator|==
literal|0
condition|)
block|{
comment|/* We have a new machine record. */
name|cp
operator|+=
literal|7
expr_stmt|;
while|while
condition|(
name|isspace
argument_list|(
operator|*
name|cp
argument_list|)
condition|)
operator|++
name|cp
expr_stmt|;
comment|/* skip delimiting space. */
name|dp
operator|=
name|word
expr_stmt|;
while|while
condition|(
operator|*
name|cp
operator|&&
operator|!
name|isspace
argument_list|(
operator|*
name|cp
argument_list|)
condition|)
operator|*
name|dp
operator|++
operator|=
operator|*
name|cp
operator|++
expr_stmt|;
comment|/* copy the name. */
operator|*
name|dp
operator|=
literal|0
expr_stmt|;
name|AddNewSitePtr
argument_list|(
name|word
argument_list|)
expr_stmt|;
block|}
block|}
block|}
operator|(
name|void
operator|)
name|fclose
argument_list|(
name|fp
argument_list|)
expr_stmt|;
name|parsing_rc
operator|=
literal|0
expr_stmt|;
return|return
literal|1
return|;
block|}
end_function

begin_comment
comment|/* thrash_rc */
end_comment

begin_function
name|void
name|AddNewSitePtr
parameter_list|(
name|char
modifier|*
name|word
parameter_list|)
block|{
name|siteptr
name|s
decl_stmt|;
if|if
condition|(
operator|(
name|s
operator|=
operator|(
name|siteptr
operator|)
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
name|site
argument_list|)
argument_list|)
operator|)
operator|!=
literal|0
condition|)
block|{
name|s
operator|->
name|next
operator|=
name|NULL
expr_stmt|;
if|if
condition|(
operator|(
name|s
operator|->
name|name
operator|=
name|malloc
argument_list|(
name|strlen
argument_list|(
name|word
argument_list|)
operator|+
literal|1
argument_list|)
operator|)
operator|!=
literal|0
condition|)
block|{
operator|(
name|void
operator|)
name|strcpy
argument_list|(
name|s
operator|->
name|name
argument_list|,
name|word
argument_list|)
expr_stmt|;
if|if
condition|(
name|firstsite
operator|==
name|NULL
condition|)
name|firstsite
operator|=
name|lastsite
operator|=
name|s
expr_stmt|;
else|else
block|{
name|lastsite
operator|->
name|next
operator|=
name|s
expr_stmt|;
name|lastsite
operator|=
name|s
expr_stmt|;
block|}
operator|++
name|nSites
expr_stmt|;
block|}
else|else
block|{
name|Free
argument_list|(
name|s
argument_list|)
expr_stmt|;
block|}
block|}
block|}
end_function

begin_comment
comment|/* AddNewSitePtr */
end_comment

begin_function
specifier|static
name|int
name|RecentCmp
parameter_list|(
name|recentsite
modifier|*
name|a
parameter_list|,
name|recentsite
modifier|*
name|b
parameter_list|)
block|{
name|int
name|i
init|=
literal|1
decl_stmt|;
if|if
condition|(
name|a
operator|->
name|lastcall
operator|>
name|b
operator|->
name|lastcall
condition|)
name|i
operator|=
operator|-
literal|1
expr_stmt|;
elseif|else
if|if
condition|(
name|a
operator|->
name|lastcall
operator|==
name|b
operator|->
name|lastcall
condition|)
name|i
operator|=
literal|0
expr_stmt|;
return|return
name|i
return|;
block|}
end_function

begin_comment
comment|/* RecentCmp */
end_comment

begin_function
specifier|static
name|siteptr
name|FindNetrcSite
parameter_list|(
name|char
modifier|*
name|host
parameter_list|,
name|int
name|exact
parameter_list|)
block|{
specifier|register
name|siteptr
name|s
decl_stmt|,
name|s2
decl_stmt|;
name|string
name|str
decl_stmt|,
name|host2
decl_stmt|;
operator|(
name|void
operator|)
name|Strncpy
argument_list|(
name|host2
argument_list|,
name|host
argument_list|)
expr_stmt|;
name|StrLCase
argument_list|(
name|host2
argument_list|)
expr_stmt|;
comment|/* see if 'host' is in our list of favorite sites (in NETRC). */
for|for
control|(
name|s
operator|=
name|firstsite
init|;
name|s
operator|!=
name|NULL
condition|;
name|s2
operator|=
name|s
operator|->
name|next
operator|,
name|s
operator|=
name|s2
control|)
block|{
operator|(
name|void
operator|)
name|Strncpy
argument_list|(
name|str
argument_list|,
name|s
operator|->
name|name
argument_list|)
expr_stmt|;
name|StrLCase
argument_list|(
name|str
argument_list|)
expr_stmt|;
if|if
condition|(
name|exact
condition|)
block|{
if|if
condition|(
name|strcmp
argument_list|(
name|str
argument_list|,
name|host2
argument_list|)
operator|==
literal|0
condition|)
return|return
name|s
return|;
block|}
else|else
block|{
if|if
condition|(
name|strstr
argument_list|(
name|str
argument_list|,
name|host2
argument_list|)
operator|!=
name|NULL
condition|)
return|return
name|s
return|;
block|}
block|}
return|return
name|NULL
return|;
block|}
end_function

begin_comment
comment|/* FindNetrcSite */
end_comment

begin_function
specifier|static
name|recentsite
modifier|*
name|FindRecentSite
parameter_list|(
name|char
modifier|*
name|host
parameter_list|,
name|int
name|exact
parameter_list|)
block|{
specifier|register
name|recentsite
modifier|*
name|r
decl_stmt|;
specifier|register
name|int
name|i
decl_stmt|;
name|string
name|str
decl_stmt|,
name|host2
decl_stmt|;
operator|(
name|void
operator|)
name|Strncpy
argument_list|(
name|host2
argument_list|,
name|host
argument_list|)
expr_stmt|;
name|StrLCase
argument_list|(
name|host2
argument_list|)
expr_stmt|;
comment|/* see if 'host' is in our list of favorite sites (in recent-log). */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|nRecents
condition|;
name|i
operator|++
control|)
block|{
name|r
operator|=
operator|&
name|recents
index|[
name|i
index|]
expr_stmt|;
operator|(
name|void
operator|)
name|Strncpy
argument_list|(
name|str
argument_list|,
name|r
operator|->
name|name
argument_list|)
expr_stmt|;
name|StrLCase
argument_list|(
name|str
argument_list|)
expr_stmt|;
if|if
condition|(
name|exact
condition|)
block|{
if|if
condition|(
name|strcmp
argument_list|(
name|str
argument_list|,
name|host2
argument_list|)
operator|==
literal|0
condition|)
return|return
name|r
return|;
block|}
else|else
block|{
if|if
condition|(
name|strstr
argument_list|(
name|str
argument_list|,
name|host2
argument_list|)
operator|!=
name|NULL
condition|)
return|return
name|r
return|;
block|}
block|}
return|return
name|NULL
return|;
block|}
end_function

begin_comment
comment|/* FindRecentSite */
end_comment

begin_function
name|void
name|ReadRecentSitesFile
parameter_list|(
name|void
parameter_list|)
block|{
name|FILE
modifier|*
name|rfp
decl_stmt|;
name|recentsite
modifier|*
name|r
decl_stmt|;
name|char
name|name
index|[
literal|64
index|]
decl_stmt|;
name|int
name|offset
decl_stmt|;
name|longstring
name|str
decl_stmt|;
name|nRecents
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|recent_file
index|[
literal|0
index|]
operator|!=
literal|0
operator|&&
name|keep_recent
condition|)
block|{
name|rfp
operator|=
name|fopen
argument_list|(
name|recent_file
argument_list|,
literal|"r"
argument_list|)
expr_stmt|;
if|if
condition|(
name|rfp
operator|!=
name|NULL
condition|)
block|{
for|for
control|(
init|;
name|nRecents
operator|<
name|dMAXRECENTS
condition|;
control|)
block|{
name|r
operator|=
operator|&
name|recents
index|[
name|nRecents
index|]
expr_stmt|;
if|if
condition|(
name|FGets
argument_list|(
name|str
argument_list|,
name|rfp
argument_list|)
operator|==
name|NULL
condition|)
break|break;
operator|(
name|void
operator|)
name|RemoveTrailingNewline
argument_list|(
name|str
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|name
index|[
literal|0
index|]
operator|=
literal|0
expr_stmt|;
name|offset
operator|=
literal|45
expr_stmt|;
if|if
condition|(
name|sscanf
argument_list|(
name|str
argument_list|,
literal|"%s %lu %n"
argument_list|,
name|name
argument_list|,
operator|(
name|unsigned
name|long
operator|*
operator|)
operator|&
name|r
operator|->
name|lastcall
argument_list|,
operator|&
name|offset
argument_list|)
operator|>=
literal|2
condition|)
block|{
if|if
condition|(
operator|(
name|r
operator|->
name|name
operator|=
name|NewString
argument_list|(
name|name
argument_list|)
operator|)
operator|!=
name|NULL
condition|)
block|{
name|r
operator|->
name|dir
operator|=
name|NewString
argument_list|(
name|str
operator|+
name|offset
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
operator|->
name|dir
operator|!=
name|NULL
condition|)
name|nRecents
operator|++
expr_stmt|;
else|else
block|{
name|free
argument_list|(
name|r
operator|->
name|name
argument_list|)
expr_stmt|;
name|r
operator|->
name|name
operator|=
name|r
operator|->
name|dir
operator|=
name|NULL
expr_stmt|;
block|}
block|}
block|}
block|}
operator|(
name|void
operator|)
name|fclose
argument_list|(
name|rfp
argument_list|)
expr_stmt|;
block|}
block|}
block|}
end_function

begin_comment
comment|/* ReadRecentSitesFile */
end_comment

begin_function
specifier|static
name|void
name|SortRecentList
parameter_list|(
name|void
parameter_list|)
block|{
name|QSort
argument_list|(
name|recents
argument_list|,
name|nRecents
argument_list|,
sizeof|sizeof
argument_list|(
name|recentsite
argument_list|)
argument_list|,
name|RecentCmp
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* SortRecentList */
end_comment

begin_function
name|int
name|WriteRecentSitesFile
parameter_list|(
name|void
parameter_list|)
block|{
name|FILE
modifier|*
name|rfp
decl_stmt|;
name|recentsite
modifier|*
name|r
decl_stmt|;
name|int
name|i
decl_stmt|;
name|int
name|retcode
init|=
literal|0
decl_stmt|;
if|if
condition|(
operator|(
name|recent_file
index|[
literal|0
index|]
operator|!=
literal|0
operator|)
operator|&&
operator|(
name|nRecents
operator|>
literal|0
operator|)
operator|&&
operator|(
name|keep_recent
operator|)
condition|)
block|{
name|dbprintf
argument_list|(
literal|"Attempting to write %s...\n"
argument_list|,
name|recent_file
argument_list|)
expr_stmt|;
name|rfp
operator|=
name|fopen
argument_list|(
name|recent_file
argument_list|,
literal|"w"
argument_list|)
expr_stmt|;
if|if
condition|(
name|rfp
operator|!=
name|NULL
condition|)
block|{
name|SortRecentList
argument_list|()
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|nRecents
condition|;
name|i
operator|++
control|)
block|{
name|r
operator|=
operator|&
name|recents
index|[
name|i
index|]
expr_stmt|;
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|rfp
argument_list|,
literal|"%-32s %11lu %s\n"
argument_list|,
name|r
operator|->
name|name
argument_list|,
operator|(
name|unsigned
name|long
operator|)
name|r
operator|->
name|lastcall
argument_list|,
name|r
operator|->
name|dir
argument_list|)
expr_stmt|;
block|}
operator|(
name|void
operator|)
name|fclose
argument_list|(
name|rfp
argument_list|)
expr_stmt|;
name|dbprintf
argument_list|(
literal|"%s written successfully.\n"
argument_list|,
name|recent_file
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|chmod
argument_list|(
name|recent_file
argument_list|,
literal|0600
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|perror
argument_list|(
name|recent_file
argument_list|)
expr_stmt|;
operator|++
name|retcode
expr_stmt|;
block|}
block|}
return|return
name|retcode
return|;
block|}
end_function

begin_comment
comment|/* WriteRecentSitesFile */
end_comment

begin_function
name|void
name|AddRecentSite
parameter_list|(
name|char
modifier|*
name|host
parameter_list|,
name|char
modifier|*
name|lastdir
parameter_list|)
block|{
name|char
modifier|*
name|nhost
decl_stmt|,
modifier|*
name|ndir
decl_stmt|;
name|recentsite
modifier|*
name|r
decl_stmt|;
if|if
condition|(
name|keep_recent
condition|)
block|{
name|nhost
operator|=
name|NewString
argument_list|(
name|host
argument_list|)
expr_stmt|;
comment|/* Use '/' to denote that the current directory wasn't known, 		 * because we won't try to cd to the root directory. 		 */
name|ndir
operator|=
name|NewString
argument_list|(
operator|*
name|lastdir
condition|?
name|lastdir
else|:
literal|"/"
argument_list|)
expr_stmt|;
comment|/* Don't bother if we don't have the memory, or if it is already 		 * in our NETRC. 		 */
if|if
condition|(
operator|(
name|ndir
operator|!=
name|NULL
operator|)
operator|&&
operator|(
name|nhost
operator|!=
name|NULL
operator|)
operator|&&
operator|(
name|FindNetrcSite
argument_list|(
name|host
argument_list|,
literal|1
argument_list|)
operator|==
name|NULL
operator|)
condition|)
block|{
if|if
condition|(
name|nRecents
operator|==
name|dMAXRECENTS
condition|)
block|{
name|SortRecentList
argument_list|()
expr_stmt|;
name|r
operator|=
operator|&
name|recents
index|[
name|dMAXRECENTS
operator|-
literal|1
index|]
expr_stmt|;
if|if
condition|(
name|r
operator|->
name|name
operator|!=
name|NULL
condition|)
name|free
argument_list|(
name|r
operator|->
name|name
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
operator|->
name|dir
operator|!=
name|NULL
condition|)
name|free
argument_list|(
name|r
operator|->
name|dir
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|r
operator|=
operator|&
name|recents
index|[
name|nRecents
index|]
expr_stmt|;
name|nRecents
operator|++
expr_stmt|;
block|}
name|r
operator|->
name|name
operator|=
name|nhost
expr_stmt|;
name|r
operator|->
name|dir
operator|=
name|ndir
expr_stmt|;
operator|(
name|void
operator|)
name|time
argument_list|(
operator|&
name|r
operator|->
name|lastcall
argument_list|)
expr_stmt|;
name|SortRecentList
argument_list|()
expr_stmt|;
block|}
block|}
block|}
end_function

begin_comment
comment|/* AddRecentSite */
end_comment

begin_comment
comment|/*  * After you are done with a site (by closing it or quitting), we  * need to update the list of recent sites called.  */
end_comment

begin_function
name|void
name|UpdateRecentSitesList
parameter_list|(
name|char
modifier|*
name|host
parameter_list|,
name|char
modifier|*
name|lastdir
parameter_list|)
block|{
name|recentsite
modifier|*
name|r
decl_stmt|;
name|char
modifier|*
name|ndir
decl_stmt|;
if|if
condition|(
name|keep_recent
condition|)
block|{
name|r
operator|=
name|FindRecentSite
argument_list|(
name|host
argument_list|,
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
operator|==
name|NULL
condition|)
name|AddRecentSite
argument_list|(
name|host
argument_list|,
name|lastdir
argument_list|)
expr_stmt|;
else|else
block|{
comment|/* Update the last time connected, and the directory we left in. */
if|if
condition|(
operator|(
name|ndir
operator|=
name|NewString
argument_list|(
operator|*
name|lastdir
condition|?
name|lastdir
else|:
literal|"/"
argument_list|)
operator|)
operator|!=
name|NULL
condition|)
block|{
name|free
argument_list|(
name|r
operator|->
name|dir
argument_list|)
expr_stmt|;
name|r
operator|->
name|dir
operator|=
name|ndir
expr_stmt|;
block|}
operator|(
name|void
operator|)
name|time
argument_list|(
operator|&
name|r
operator|->
name|lastcall
argument_list|)
expr_stmt|;
block|}
block|}
block|}
end_function

begin_comment
comment|/* UpdateRecentSitesList */
end_comment

begin_comment
comment|/*  * Prints out the number of sites we know about, so the user can figure out  * an abbreviation or type it's number to open (setpeer).  */
end_comment

begin_function
name|void
name|PrintSiteList
parameter_list|(
name|void
parameter_list|)
block|{
name|int
name|i
decl_stmt|,
name|j
decl_stmt|;
name|siteptr
name|s
decl_stmt|,
name|s2
decl_stmt|;
name|FILE
modifier|*
name|pagerfp
decl_stmt|;
name|Sig_t
name|sigpipe
decl_stmt|;
if|if
condition|(
name|fromatty
condition|)
block|{
name|j
operator|=
literal|0
expr_stmt|;
name|i
operator|=
literal|1
expr_stmt|;
name|sigpipe
operator|=
name|Signal
argument_list|(
name|SIGPIPE
argument_list|,
name|SIG_IGN
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|pagerfp
operator|=
name|popen
argument_list|(
name|pager
operator|+
literal|1
argument_list|,
literal|"w"
argument_list|)
operator|)
operator|==
name|NULL
condition|)
name|pagerfp
operator|=
name|stdout
expr_stmt|;
if|if
condition|(
name|nRecents
operator|>
literal|0
condition|)
block|{
name|j
operator|++
expr_stmt|;
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|pagerfp
argument_list|,
literal|"\nRecently called sites:\n"
argument_list|)
expr_stmt|;
for|for
control|(
init|;
name|i
operator|<=
name|nRecents
condition|;
name|i
operator|++
control|)
block|{
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|pagerfp
argument_list|,
literal|"%4d. %-32s"
argument_list|,
name|i
argument_list|,
name|recents
index|[
name|i
operator|-
literal|1
index|]
operator|.
name|name
argument_list|)
expr_stmt|;
name|i
operator|++
expr_stmt|;
if|if
condition|(
name|i
operator|<=
name|nRecents
condition|)
block|{
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|pagerfp
argument_list|,
literal|"%5d. %-32s"
argument_list|,
name|i
argument_list|,
name|recents
index|[
name|i
operator|-
literal|1
index|]
operator|.
name|name
argument_list|)
expr_stmt|;
block|}
else|else
block|{
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|pagerfp
argument_list|,
literal|"\n"
argument_list|)
expr_stmt|;
break|break;
block|}
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|pagerfp
argument_list|,
literal|"\n"
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
name|nSites
operator|>
literal|0
condition|)
block|{
name|j
operator|++
expr_stmt|;
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|pagerfp
argument_list|,
literal|"Sites in your netrc (%s):\n"
argument_list|,
name|rcname
argument_list|)
expr_stmt|;
for|for
control|(
name|s
operator|=
name|firstsite
init|;
name|s
operator|!=
name|NULL
condition|;
name|s2
operator|=
name|s
operator|->
name|next
operator|,
name|s
operator|=
name|s2
operator|,
operator|++
name|i
control|)
block|{
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|pagerfp
argument_list|,
literal|"%4d. %-32s"
argument_list|,
name|i
argument_list|,
name|s
operator|->
name|name
argument_list|)
expr_stmt|;
name|s2
operator|=
name|s
operator|->
name|next
expr_stmt|;
name|s
operator|=
name|s2
expr_stmt|;
name|i
operator|++
expr_stmt|;
if|if
condition|(
name|s
operator|!=
name|NULL
condition|)
block|{
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|pagerfp
argument_list|,
literal|"%5d. %-32s"
argument_list|,
name|i
argument_list|,
name|s
operator|->
name|name
argument_list|)
expr_stmt|;
block|}
else|else
block|{
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|pagerfp
argument_list|,
literal|"\n"
argument_list|)
expr_stmt|;
break|break;
block|}
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|pagerfp
argument_list|,
literal|"\n"
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
name|j
operator|>
literal|0
condition|)
block|{
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|pagerfp
argument_list|,
literal|"\ Note that you can specify an abbreviation of any name, or #x, where x is the\n\ number of the site you want to connect to.\n\n"
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|pagerfp
operator|!=
name|stdout
condition|)
operator|(
name|void
operator|)
name|pclose
argument_list|(
name|pagerfp
argument_list|)
expr_stmt|;
name|Signal
argument_list|(
name|SIGPIPE
argument_list|,
name|sigpipe
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/* PrintRecentSiteList */
end_comment

begin_comment
comment|/*  * Given a sitename, check to see if the name was really an abbreviation  * of a site in the NETRC, or a site in our list of recently connected  * sites.  Also check if the name was in the format #x, where x which  * would mean to use recents[x].name as the site; if x was greater than  * the number of sites in the recent list, then index into the netrc  * site list.  */
end_comment

begin_include
include|#
directive|include
file|<netdb.h>
end_include

begin_function
name|void
name|GetFullSiteName
parameter_list|(
name|char
modifier|*
name|host
parameter_list|,
name|char
modifier|*
name|lastdir
parameter_list|)
block|{
specifier|register
name|siteptr
name|s
decl_stmt|,
name|s2
decl_stmt|;
specifier|register
name|recentsite
modifier|*
name|r
decl_stmt|;
name|char
modifier|*
name|ndir
decl_stmt|,
modifier|*
name|nhost
decl_stmt|,
modifier|*
name|cp
decl_stmt|;
name|int
name|x
decl_stmt|,
name|i
decl_stmt|,
name|isAllDigits
decl_stmt|,
name|exact
decl_stmt|;
name|struct
name|hostent
modifier|*
name|hostentp
decl_stmt|;
name|ndir
operator|=
name|nhost
operator|=
name|NULL
expr_stmt|;
name|x
operator|=
name|exact
operator|=
literal|0
expr_stmt|;
comment|/* First, see if the "abbreviation" is really just the name of 	 * a machine in the local domain, or if it was a full hostname 	 * already.  That way we can avoid problems associated with 	 * short names, such as having "ce" as a machine in the local 	 * domain, but having "faces.unl.edu", where we would most likely 	 * want to use ce instead of faces if the user said "open ce". 	 * This will also prevent problems when you have a host named 	 * xx.yy.unl.edu, and another host named yy.unl.edu.  If the user 	 * said "open yy.unl.edu" we should use yy.unl.edu, and not look 	 * for matches containing yy.unl.edu. 	 */
if|if
condition|(
operator|(
name|hostentp
operator|=
name|gethostbyname
argument_list|(
name|host
argument_list|)
operator|)
operator|!=
name|NULL
condition|)
block|{
name|strcpy
argument_list|(
name|host
argument_list|,
name|hostentp
operator|->
name|h_name
argument_list|)
expr_stmt|;
name|exact
operator|=
literal|1
expr_stmt|;
block|}
comment|/* Don't allow just numbers as abbreviations;  "open 2" could be 	 * confused between site numbers in the open 'menu,' like 	 * "2. unlinfo.unl.edu" and IP numbers "128.93.2.1" or even numbers 	 * in the site name like "simtel20.army.mil." 	 */
for|for
control|(
name|isAllDigits
operator|=
literal|1
operator|,
name|cp
operator|=
name|host
init|;
operator|*
name|cp
operator|!=
literal|0
condition|;
name|cp
operator|++
control|)
block|{
if|if
condition|(
operator|!
name|isdigit
argument_list|(
operator|*
name|cp
argument_list|)
condition|)
block|{
name|isAllDigits
operator|=
literal|0
expr_stmt|;
break|break;
block|}
block|}
if|if
condition|(
operator|!
name|isAllDigits
condition|)
block|{
if|if
condition|(
name|host
index|[
literal|0
index|]
operator|==
literal|'#'
condition|)
operator|(
name|void
operator|)
name|sscanf
argument_list|(
name|host
operator|+
literal|1
argument_list|,
literal|"%d"
argument_list|,
operator|&
name|x
argument_list|)
expr_stmt|;
comment|/* Try matching the abbreviation, since it isn't just a number. */
comment|/* see if 'host' is in our list of favorite sites (in NETRC). */
if|if
condition|(
name|x
operator|==
literal|0
condition|)
block|{
if|if
condition|(
operator|(
name|s
operator|=
name|FindNetrcSite
argument_list|(
name|host
argument_list|,
name|exact
argument_list|)
operator|)
operator|!=
name|NULL
condition|)
block|{
name|nhost
operator|=
name|s
operator|->
name|name
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|(
name|r
operator|=
name|FindRecentSite
argument_list|(
name|host
argument_list|,
name|exact
argument_list|)
operator|)
operator|!=
name|NULL
condition|)
block|{
name|nhost
operator|=
name|r
operator|->
name|name
expr_stmt|;
name|ndir
operator|=
name|r
operator|->
name|dir
expr_stmt|;
block|}
block|}
block|}
elseif|else
if|if
condition|(
name|sscanf
argument_list|(
name|host
argument_list|,
literal|"%d"
argument_list|,
operator|&
name|x
argument_list|)
operator|!=
literal|1
condition|)
block|{
name|x
operator|=
literal|0
expr_stmt|;
block|}
if|if
condition|(
operator|--
name|x
operator|>=
literal|0
condition|)
block|{
if|if
condition|(
name|x
operator|<
name|nRecents
condition|)
block|{
name|nhost
operator|=
name|recents
index|[
name|x
index|]
operator|.
name|name
expr_stmt|;
name|ndir
operator|=
name|recents
index|[
name|x
index|]
operator|.
name|dir
expr_stmt|;
block|}
else|else
block|{
name|x
operator|-=
name|nRecents
expr_stmt|;
if|if
condition|(
name|x
operator|<
name|nSites
condition|)
block|{
for|for
control|(
name|i
operator|=
literal|0
operator|,
name|s
operator|=
name|firstsite
init|;
name|i
operator|<
name|x
condition|;
name|s2
operator|=
name|s
operator|->
name|next
operator|,
name|s
operator|=
name|s2
control|)
operator|++
name|i
expr_stmt|;
name|nhost
operator|=
name|s
operator|->
name|name
expr_stmt|;
block|}
block|}
block|}
if|if
condition|(
name|nhost
operator|!=
name|NULL
condition|)
block|{
operator|(
name|void
operator|)
name|strcpy
argument_list|(
name|host
argument_list|,
name|nhost
argument_list|)
expr_stmt|;
if|if
condition|(
name|lastdir
operator|!=
name|NULL
condition|)
block|{
operator|*
name|lastdir
operator|=
literal|0
expr_stmt|;
comment|/* Don't cd if the dir is the root directory. */
if|if
condition|(
name|ndir
operator|!=
name|NULL
operator|&&
operator|(
name|strcmp
argument_list|(
literal|"/"
argument_list|,
name|ndir
argument_list|)
operator|!=
literal|0
operator|)
condition|)
operator|(
name|void
operator|)
name|strcpy
argument_list|(
name|lastdir
argument_list|,
name|ndir
argument_list|)
expr_stmt|;
block|}
block|}
block|}
end_function

begin_comment
comment|/* GetFullSiteName */
end_comment

begin_function
name|int
name|ruserpass2
parameter_list|(
name|char
modifier|*
name|host
parameter_list|,
name|char
modifier|*
modifier|*
name|username
parameter_list|,
name|char
modifier|*
modifier|*
name|pass
parameter_list|,
name|char
modifier|*
modifier|*
name|acct
parameter_list|)
block|{
name|FILE
modifier|*
name|fp
decl_stmt|;
name|char
modifier|*
name|cp
decl_stmt|,
modifier|*
name|dp
decl_stmt|,
modifier|*
name|dst
decl_stmt|,
modifier|*
name|ep
decl_stmt|;
name|str32
name|macname
decl_stmt|;
name|char
modifier|*
name|varname
decl_stmt|;
name|int
name|site_found
decl_stmt|;
name|string
name|str
decl_stmt|;
specifier|static
name|string
name|auser
decl_stmt|;
specifier|static
name|str32
name|apass
decl_stmt|,
name|aacct
decl_stmt|;
name|site_found
operator|=
literal|0
expr_stmt|;
if|if
condition|(
operator|(
name|fp
operator|=
name|fopen
argument_list|(
name|rcname
argument_list|,
literal|"r"
argument_list|)
operator|)
operator|!=
name|NULL
condition|)
block|{
name|parsing_rc
operator|=
literal|1
expr_stmt|;
while|while
condition|(
name|FGets
argument_list|(
name|str
argument_list|,
name|fp
argument_list|)
condition|)
block|{
if|if
condition|(
operator|(
name|cp
operator|=
name|strstr
argument_list|(
name|str
argument_list|,
literal|"machine"
argument_list|)
operator|)
operator|!=
literal|0
condition|)
block|{
comment|/* Look for the machine token. */
name|cp
operator|+=
literal|7
expr_stmt|;
while|while
condition|(
name|isspace
argument_list|(
operator|*
name|cp
argument_list|)
condition|)
name|cp
operator|++
expr_stmt|;
block|}
else|else
continue|continue;
if|if
condition|(
name|strncmp
argument_list|(
name|host
argument_list|,
name|cp
argument_list|,
name|strlen
argument_list|(
name|host
argument_list|)
argument_list|)
operator|==
literal|0
condition|)
block|{
name|site_found
operator|=
literal|1
expr_stmt|;
while|while
condition|(
operator|!
name|isspace
argument_list|(
operator|*
name|cp
argument_list|)
condition|)
operator|++
name|cp
expr_stmt|;
comment|/* skip the site name. */
do|do
block|{
comment|/* Skip any comments ahead of time. */
for|for
control|(
name|dp
operator|=
name|cp
init|;
operator|*
name|dp
condition|;
name|dp
operator|++
control|)
block|{
if|if
condition|(
operator|*
name|dp
operator|==
literal|'#'
condition|)
block|{
operator|*
name|dp
operator|=
literal|0
expr_stmt|;
break|break;
block|}
block|}
name|ep
operator|=
name|cp
expr_stmt|;
while|while
condition|(
literal|1
condition|)
block|{
name|varname
operator|=
name|strtok
argument_list|(
name|ep
argument_list|,
name|RC_DELIM
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|varname
condition|)
break|break;
name|dst
operator|=
name|ep
operator|=
name|NULL
expr_stmt|;
switch|switch
condition|(
operator|*
name|varname
condition|)
block|{
case|case
literal|'u'
case|:
comment|/* user */
operator|*
name|username
operator|=
name|dst
operator|=
name|auser
expr_stmt|;
break|break;
case|case
literal|'l'
case|:
comment|/* login */
operator|*
name|username
operator|=
name|dst
operator|=
name|auser
expr_stmt|;
break|break;
case|case
literal|'p'
case|:
comment|/* password */
operator|*
name|pass
operator|=
name|dst
operator|=
name|apass
expr_stmt|;
break|break;
case|case
literal|'a'
case|:
comment|/* account */
operator|*
name|acct
operator|=
name|dst
operator|=
name|aacct
expr_stmt|;
break|break;
comment|/*	case 'd':  /o default */
comment|/* unused -- use 'set anon_password.' */
case|case
literal|'m'
case|:
comment|/* macdef or machine */
if|if
condition|(
name|strcmp
argument_list|(
name|varname
argument_list|,
literal|"macdef"
argument_list|)
condition|)
goto|goto
name|done
goto|;
comment|/* new machine record... */
name|dst
operator|=
name|macname
expr_stmt|;
break|break;
default|default:
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Unknown .netrc keyword \"%s\"\n"
argument_list|,
name|varname
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|dst
condition|)
block|{
name|dp
operator|=
name|strtok
argument_list|(
name|ep
argument_list|,
name|RC_DELIM
argument_list|)
expr_stmt|;
if|if
condition|(
name|dp
condition|)
operator|(
name|void
operator|)
name|strcpy
argument_list|(
name|dst
argument_list|,
name|dp
argument_list|)
expr_stmt|;
if|if
condition|(
name|dst
operator|==
name|macname
condition|)
block|{
comment|/* 								 *	Read in the lines of the macro. 								 *	The macro's end is denoted by 								 *	a blank line. 								 */
operator|(
name|void
operator|)
name|make_macro
argument_list|(
name|macname
argument_list|,
name|fp
argument_list|)
expr_stmt|;
goto|goto
name|nextline
goto|;
block|}
block|}
block|}
name|nextline
label|:
empty_stmt|;
block|}
do|while
condition|(
operator|(
name|cp
operator|=
name|FGets
argument_list|(
name|str
argument_list|,
name|fp
argument_list|)
operator|)
operator|!=
literal|0
condition|)
do|;
break|break;
block|}
comment|/* end if we found the machine record. */
block|}
name|done
label|:
name|parsing_rc
operator|=
literal|0
expr_stmt|;
operator|(
name|void
operator|)
name|fclose
argument_list|(
name|fp
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|site_found
condition|)
block|{
comment|/* didn't find it in the rc. */
return|return
operator|(
literal|0
operator|)
return|;
block|}
return|return
operator|(
literal|1
operator|)
return|;
comment|/* found */
block|}
end_function

begin_comment
comment|/* ruserpass2 */
end_comment

begin_comment
comment|/* eof ftprc.c */
end_comment

end_unit


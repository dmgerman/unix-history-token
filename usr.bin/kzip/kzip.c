begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * ----------------------------------------------------------------------------  * "THE BEER-WARE LICENSE" (Revision 42):  *<phk@login.dknet.dk> wrote this file.  As long as you retain this notice you  * can do whatever you want with this stuff. If we meet some day, and you think  * this stuff is worth it, you can buy me a beer in return.   Poul-Henning Kamp  * ----------------------------------------------------------------------------  *  * Copyright (C) 1993  Hannu Savolainen  * Ported to 386bsd by Serge Vakulenko  * based on tools/build.c by Linus Torvalds  */
end_comment

begin_ifndef
ifndef|#
directive|ifndef
name|lint
end_ifndef

begin_decl_stmt
specifier|static
specifier|const
name|char
name|rcsid
index|[]
init|=
literal|"$FreeBSD$"
decl_stmt|;
end_decl_stmt

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* not lint */
end_comment

begin_include
include|#
directive|include
file|<err.h>
end_include

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_include
include|#
directive|include
file|<stdlib.h>
end_include

begin_include
include|#
directive|include
file|<unistd.h>
end_include

begin_include
include|#
directive|include
file|<sys/file.h>
end_include

begin_include
include|#
directive|include
file|<sys/types.h>
end_include

begin_include
include|#
directive|include
file|<sys/stat.h>
end_include

begin_include
include|#
directive|include
file|<sys/param.h>
end_include

begin_include
include|#
directive|include
file|<sys/wait.h>
end_include

begin_include
include|#
directive|include
file|<a.out.h>
end_include

begin_include
include|#
directive|include
file|<string.h>
end_include

begin_define
define|#
directive|define
name|MAXIMAGE
value|(2*1024*1024)
end_define

begin_comment
comment|/* This is the limit because a kzip'ed kernel loads at 3Mb and 	 * ends up at 1Mb 	 */
end_comment

begin_function
specifier|static
name|void
name|usage
parameter_list|()
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"usage: kzip [-v] [ -l loadaddr] kernel\n"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|int
name|main
parameter_list|(
name|int
name|argc
parameter_list|,
name|char
modifier|*
modifier|*
name|argv
parameter_list|)
block|{
name|pid_t
name|Pext
decl_stmt|,
name|Pgzip
decl_stmt|,
name|Ppiggy
decl_stmt|,
name|Pld
decl_stmt|;
name|int
name|pipe1
index|[
literal|2
index|]
decl_stmt|,
name|pipe2
index|[
literal|2
index|]
decl_stmt|;
name|int
name|status
decl_stmt|,
name|fdi
decl_stmt|,
name|fdo
decl_stmt|,
name|fdn
decl_stmt|,
name|c
decl_stmt|,
name|verbose
decl_stmt|;
name|int
name|size
decl_stmt|;
name|struct
name|exec
name|hdr
decl_stmt|;
name|int
name|zip_size
decl_stmt|,
name|offset
decl_stmt|;
name|struct
name|stat
name|st
decl_stmt|;
name|u_long
name|forceaddr
init|=
literal|0
decl_stmt|,
name|entry
decl_stmt|;
name|char
modifier|*
name|kernname
decl_stmt|;
name|char
name|obj
index|[
name|MAXPATHLEN
operator|+
literal|1
index|]
decl_stmt|;
name|char
name|out
index|[
name|MAXPATHLEN
operator|+
literal|1
index|]
decl_stmt|;
name|char
name|base
index|[
literal|32
index|]
decl_stmt|;
while|while
condition|(
operator|(
name|c
operator|=
name|getopt
argument_list|(
name|argc
argument_list|,
name|argv
argument_list|,
literal|"l:v"
argument_list|)
operator|)
operator|!=
operator|-
literal|1
condition|)
block|{
switch|switch
condition|(
name|c
condition|)
block|{
case|case
literal|'l'
case|:
name|forceaddr
operator|=
name|strtoul
argument_list|(
name|optarg
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|forceaddr
operator|==
literal|0
condition|)
name|errx
argument_list|(
literal|1
argument_list|,
literal|"invalid load address"
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'v'
case|:
name|verbose
operator|++
expr_stmt|;
break|break;
default|default:
name|usage
argument_list|()
expr_stmt|;
block|}
block|}
if|if
condition|(
operator|(
name|argc
operator|-
name|optind
operator|)
operator|!=
literal|1
condition|)
name|usage
argument_list|()
expr_stmt|;
name|argc
operator|-=
name|optind
expr_stmt|;
name|argv
operator|+=
name|optind
expr_stmt|;
name|kernname
operator|=
name|argv
index|[
literal|0
index|]
expr_stmt|;
if|if
condition|(
name|strlen
argument_list|(
name|kernname
argument_list|)
operator|>
name|MAXPATHLEN
operator|-
literal|3
condition|)
name|errx
argument_list|(
literal|1
argument_list|,
literal|"%s: File name too long"
argument_list|,
name|kernname
argument_list|)
expr_stmt|;
name|strcpy
argument_list|(
name|obj
argument_list|,
name|kernname
argument_list|)
expr_stmt|;
name|strcat
argument_list|(
name|obj
argument_list|,
literal|".o"
argument_list|)
expr_stmt|;
name|strcpy
argument_list|(
name|out
argument_list|,
name|kernname
argument_list|)
expr_stmt|;
name|strcat
argument_list|(
name|out
argument_list|,
literal|".kz"
argument_list|)
expr_stmt|;
name|fdi
operator|=
name|open
argument_list|(
name|kernname
argument_list|,
name|O_RDONLY
argument_list|)
expr_stmt|;
if|if
condition|(
name|fdi
operator|<
literal|0
condition|)
block|{
name|warn
argument_list|(
literal|"%s"
argument_list|,
name|kernname
argument_list|)
expr_stmt|;
return|return
literal|2
return|;
block|}
comment|/* figure out how big the uncompressed image will be */
if|if
condition|(
name|read
argument_list|(
name|fdi
argument_list|,
operator|(
name|char
operator|*
operator|)
operator|&
name|hdr
argument_list|,
sizeof|sizeof
argument_list|(
name|hdr
argument_list|)
argument_list|)
operator|!=
sizeof|sizeof
argument_list|(
name|hdr
argument_list|)
condition|)
name|err
argument_list|(
literal|2
argument_list|,
literal|"%s"
argument_list|,
name|argv
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
name|size
operator|=
name|hdr
operator|.
name|a_text
operator|+
name|hdr
operator|.
name|a_data
operator|+
name|hdr
operator|.
name|a_bss
expr_stmt|;
name|entry
operator|=
name|hdr
operator|.
name|a_entry
operator|&
literal|0x00FFFFFF
expr_stmt|;
name|lseek
argument_list|(
name|fdi
argument_list|,
literal|0
argument_list|,
name|SEEK_SET
argument_list|)
expr_stmt|;
if|if
condition|(
name|verbose
condition|)
block|{
name|printf
argument_list|(
literal|"real kernel start address will be: 0x%x\n"
argument_list|,
name|entry
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"real kernel end   address will be: 0x%x\n"
argument_list|,
name|entry
operator|+
name|size
argument_list|)
expr_stmt|;
block|}
name|fdo
operator|=
name|open
argument_list|(
name|obj
argument_list|,
name|O_WRONLY
operator||
name|O_TRUNC
operator||
name|O_CREAT
argument_list|,
literal|0666
argument_list|)
expr_stmt|;
if|if
condition|(
name|fdo
operator|<
literal|0
condition|)
block|{
name|warn
argument_list|(
literal|"%s"
argument_list|,
name|obj
argument_list|)
expr_stmt|;
return|return
literal|2
return|;
block|}
if|if
condition|(
name|pipe
argument_list|(
name|pipe1
argument_list|)
operator|<
literal|0
condition|)
block|{
name|perror
argument_list|(
literal|"pipe()"
argument_list|)
expr_stmt|;
return|return
literal|1
return|;
block|}
if|if
condition|(
name|pipe
argument_list|(
name|pipe2
argument_list|)
operator|<
literal|0
condition|)
block|{
name|perror
argument_list|(
literal|"pipe()"
argument_list|)
expr_stmt|;
return|return
literal|1
return|;
block|}
name|Pext
operator|=
name|fork
argument_list|()
expr_stmt|;
if|if
condition|(
name|Pext
operator|<
literal|0
condition|)
block|{
name|perror
argument_list|(
literal|"fork()"
argument_list|)
expr_stmt|;
return|return
literal|1
return|;
block|}
if|if
condition|(
operator|!
name|Pext
condition|)
block|{
name|dup2
argument_list|(
name|fdi
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|dup2
argument_list|(
name|pipe1
index|[
literal|1
index|]
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|close
argument_list|(
name|pipe1
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
name|close
argument_list|(
name|pipe1
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
name|close
argument_list|(
name|pipe2
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
name|close
argument_list|(
name|pipe2
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
name|close
argument_list|(
name|fdi
argument_list|)
expr_stmt|;
name|close
argument_list|(
name|fdo
argument_list|)
expr_stmt|;
name|extract
argument_list|(
name|kernname
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|0
argument_list|)
expr_stmt|;
block|}
name|Pgzip
operator|=
name|fork
argument_list|()
expr_stmt|;
if|if
condition|(
name|Pgzip
operator|<
literal|0
condition|)
block|{
name|perror
argument_list|(
literal|"fork()"
argument_list|)
expr_stmt|;
return|return
literal|1
return|;
block|}
if|if
condition|(
operator|!
name|Pgzip
condition|)
block|{
name|dup2
argument_list|(
name|pipe1
index|[
literal|0
index|]
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|dup2
argument_list|(
name|pipe2
index|[
literal|1
index|]
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|close
argument_list|(
name|pipe1
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
name|close
argument_list|(
name|pipe1
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
name|close
argument_list|(
name|pipe2
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
name|close
argument_list|(
name|pipe2
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
name|close
argument_list|(
name|fdi
argument_list|)
expr_stmt|;
name|close
argument_list|(
name|fdo
argument_list|)
expr_stmt|;
name|execlp
argument_list|(
literal|"gzip"
argument_list|,
literal|"gzip"
argument_list|,
literal|"-9"
argument_list|,
literal|"-n"
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|0
argument_list|)
expr_stmt|;
block|}
name|Ppiggy
operator|=
name|fork
argument_list|()
expr_stmt|;
if|if
condition|(
name|Ppiggy
operator|<
literal|0
condition|)
block|{
name|warn
argument_list|(
literal|"fork()"
argument_list|)
expr_stmt|;
return|return
literal|1
return|;
block|}
if|if
condition|(
operator|!
name|Ppiggy
condition|)
block|{
name|dup2
argument_list|(
name|pipe2
index|[
literal|0
index|]
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|dup2
argument_list|(
name|fdo
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|close
argument_list|(
name|pipe1
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
name|close
argument_list|(
name|pipe1
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
name|close
argument_list|(
name|pipe2
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
name|close
argument_list|(
name|pipe2
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
name|close
argument_list|(
name|fdi
argument_list|)
expr_stmt|;
name|close
argument_list|(
name|fdo
argument_list|)
expr_stmt|;
name|piggyback
argument_list|(
name|obj
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|0
argument_list|)
expr_stmt|;
block|}
name|close
argument_list|(
name|pipe1
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
name|close
argument_list|(
name|pipe1
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
name|close
argument_list|(
name|pipe2
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
name|close
argument_list|(
name|pipe2
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
name|close
argument_list|(
name|fdi
argument_list|)
expr_stmt|;
name|close
argument_list|(
name|fdo
argument_list|)
expr_stmt|;
if|if
condition|(
name|waitpid
argument_list|(
name|Pext
argument_list|,
operator|&
name|status
argument_list|,
literal|0
argument_list|)
operator|<
literal|0
condition|)
block|{
name|warn
argument_list|(
literal|"waitpid(Pextract)"
argument_list|)
expr_stmt|;
return|return
literal|1
return|;
block|}
if|if
condition|(
name|status
condition|)
block|{
name|warnx
argument_list|(
literal|"extract returned %x"
argument_list|,
name|status
argument_list|)
expr_stmt|;
return|return
literal|3
return|;
block|}
if|if
condition|(
name|waitpid
argument_list|(
name|Pgzip
argument_list|,
operator|&
name|status
argument_list|,
literal|0
argument_list|)
operator|<
literal|0
condition|)
block|{
name|perror
argument_list|(
literal|"waitpid(Pgzip)"
argument_list|)
expr_stmt|;
return|return
literal|1
return|;
block|}
if|if
condition|(
name|status
condition|)
block|{
name|warnx
argument_list|(
literal|"gzip returned %x"
argument_list|,
name|status
argument_list|)
expr_stmt|;
return|return
literal|3
return|;
block|}
if|if
condition|(
name|waitpid
argument_list|(
name|Ppiggy
argument_list|,
operator|&
name|status
argument_list|,
literal|0
argument_list|)
operator|<
literal|0
condition|)
block|{
name|warn
argument_list|(
literal|"waitpid(Ppiggy)"
argument_list|)
expr_stmt|;
return|return
literal|1
return|;
block|}
if|if
condition|(
name|status
condition|)
block|{
name|warnx
argument_list|(
literal|"piggyback returned %x"
argument_list|,
name|status
argument_list|)
expr_stmt|;
return|return
literal|3
return|;
block|}
if|if
condition|(
name|forceaddr
condition|)
name|offset
operator|=
name|forceaddr
expr_stmt|;
else|else
block|{
comment|/* a kludge to dynamically figure out where to start it */
if|if
condition|(
name|stat
argument_list|(
name|obj
argument_list|,
operator|&
name|st
argument_list|)
operator|<
literal|0
condition|)
block|{
name|warn
argument_list|(
literal|"cannot get size of compressed data"
argument_list|)
expr_stmt|;
return|return
literal|3
return|;
block|}
name|zip_size
operator|=
operator|(
name|int
operator|)
name|st
operator|.
name|st_size
expr_stmt|;
name|offset
operator|=
name|entry
operator|+
name|size
operator|-
name|zip_size
operator|+
literal|0x8000
expr_stmt|;
comment|/* fudge factor */
block|}
name|sprintf
argument_list|(
name|base
argument_list|,
literal|"0x%x"
argument_list|,
name|roundup
argument_list|(
name|offset
argument_list|,
literal|4096
argument_list|)
argument_list|)
expr_stmt|;
name|Pld
operator|=
name|fork
argument_list|()
expr_stmt|;
if|if
condition|(
name|Pld
operator|<
literal|0
condition|)
block|{
name|warn
argument_list|(
literal|"fork()"
argument_list|)
expr_stmt|;
return|return
literal|1
return|;
block|}
if|if
condition|(
operator|!
name|Pld
condition|)
block|{
name|execlp
argument_list|(
literal|"ld"
argument_list|,
literal|"ld"
argument_list|,
literal|"-aout"
argument_list|,
literal|"-Bstatic"
argument_list|,
literal|"-Z"
argument_list|,
literal|"-T"
argument_list|,
name|base
argument_list|,
literal|"-o"
argument_list|,
name|out
argument_list|,
literal|"/usr/lib/aout/kzhead.o"
argument_list|,
name|obj
argument_list|,
literal|"/usr/lib/aout/kztail.o"
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|2
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|waitpid
argument_list|(
name|Pld
argument_list|,
operator|&
name|status
argument_list|,
literal|0
argument_list|)
operator|<
literal|0
condition|)
block|{
name|warn
argument_list|(
literal|"waitpid(Pld)"
argument_list|)
expr_stmt|;
return|return
literal|1
return|;
block|}
if|if
condition|(
name|status
condition|)
block|{
name|warnx
argument_list|(
literal|"ld returned %x"
argument_list|,
name|status
argument_list|)
expr_stmt|;
return|return
literal|3
return|;
block|}
if|if
condition|(
name|verbose
condition|)
block|{
name|fdn
operator|=
name|open
argument_list|(
name|obj
argument_list|,
name|O_RDONLY
argument_list|)
expr_stmt|;
if|if
condition|(
name|fdn
operator|<
literal|0
condition|)
block|{
name|warn
argument_list|(
literal|"%s"
argument_list|,
name|obj
argument_list|)
expr_stmt|;
return|return
literal|3
return|;
block|}
comment|/* figure out how big the compressed image is */
if|if
condition|(
name|read
argument_list|(
name|fdn
argument_list|,
operator|(
name|char
operator|*
operator|)
operator|&
name|hdr
argument_list|,
sizeof|sizeof
argument_list|(
name|hdr
argument_list|)
argument_list|)
operator|!=
sizeof|sizeof
argument_list|(
name|hdr
argument_list|)
condition|)
block|{
name|warn
argument_list|(
literal|"%s"
argument_list|,
name|obj
argument_list|)
expr_stmt|;
return|return
literal|3
return|;
block|}
name|close
argument_list|(
name|fdn
argument_list|)
expr_stmt|;
name|size
operator|=
name|hdr
operator|.
name|a_text
operator|+
name|hdr
operator|.
name|a_data
operator|+
name|hdr
operator|.
name|a_bss
expr_stmt|;
name|printf
argument_list|(
literal|"kzip data   start address will be: 0x%x\n"
argument_list|,
name|offset
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"kzip data   end   address will be: 0x%x\n"
argument_list|,
name|offset
operator|+
name|size
argument_list|)
expr_stmt|;
block|}
name|unlink
argument_list|(
name|obj
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|0
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|int
name|extract
parameter_list|(
name|char
modifier|*
name|file
parameter_list|)
block|{
name|int
name|sz
decl_stmt|;
name|char
name|buf
index|[
name|BUFSIZ
index|]
decl_stmt|;
name|struct
name|exec
name|hdr
decl_stmt|;
if|if
condition|(
name|read
argument_list|(
literal|0
argument_list|,
operator|(
name|char
operator|*
operator|)
operator|&
name|hdr
argument_list|,
sizeof|sizeof
argument_list|(
name|hdr
argument_list|)
argument_list|)
operator|!=
sizeof|sizeof
argument_list|(
name|hdr
argument_list|)
condition|)
name|err
argument_list|(
literal|2
argument_list|,
literal|"%s"
argument_list|,
name|file
argument_list|)
expr_stmt|;
if|if
condition|(
name|hdr
operator|.
name|a_magic
operator|!=
name|ZMAGIC
condition|)
name|errx
argument_list|(
literal|2
argument_list|,
literal|"bad magic in file %s, probably not a kernel"
argument_list|,
name|file
argument_list|)
expr_stmt|;
if|if
condition|(
name|lseek
argument_list|(
literal|0
argument_list|,
name|N_TXTOFF
argument_list|(
name|hdr
argument_list|)
argument_list|,
literal|0
argument_list|)
operator|<
literal|0
condition|)
name|err
argument_list|(
literal|2
argument_list|,
literal|"%s"
argument_list|,
name|file
argument_list|)
expr_stmt|;
name|sz
operator|=
name|N_SYMOFF
argument_list|(
name|hdr
argument_list|)
operator|-
name|N_TXTOFF
argument_list|(
name|hdr
argument_list|)
expr_stmt|;
while|while
condition|(
name|sz
condition|)
block|{
name|int
name|l
decl_stmt|,
name|n
decl_stmt|;
name|l
operator|=
name|sz
expr_stmt|;
if|if
condition|(
name|l
operator|>
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
condition|)
name|l
operator|=
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
expr_stmt|;
name|n
operator|=
name|read
argument_list|(
literal|0
argument_list|,
name|buf
argument_list|,
name|l
argument_list|)
expr_stmt|;
if|if
condition|(
name|n
operator|!=
name|l
condition|)
block|{
if|if
condition|(
name|n
operator|==
operator|-
literal|1
condition|)
name|err
argument_list|(
literal|1
argument_list|,
literal|"%s"
argument_list|,
name|file
argument_list|)
expr_stmt|;
else|else
name|errx
argument_list|(
literal|1
argument_list|,
literal|"unexpected EOF"
argument_list|)
expr_stmt|;
block|}
name|write
argument_list|(
literal|1
argument_list|,
name|buf
argument_list|,
name|l
argument_list|)
expr_stmt|;
name|sz
operator|-=
name|l
expr_stmt|;
block|}
name|exit
argument_list|(
literal|0
argument_list|)
expr_stmt|;
block|}
end_function

begin_decl_stmt
name|char
name|string_names
index|[]
init|=
block|{
literal|"_input_data\0_input_len\0"
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|struct
name|nlist
name|var_names
index|[
literal|2
index|]
init|=
block|{
comment|/* Symbol table */
block|{
block|{
operator|(
name|char
operator|*
operator|)
literal|4
block|}
block|,
name|N_EXT
operator||
name|N_TEXT
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|}
block|,
comment|/* _input_data  */
block|{
block|{
operator|(
name|char
operator|*
operator|)
literal|16
block|}
block|,
name|N_EXT
operator||
name|N_TEXT
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|}
block|,
comment|/* _input_len */
block|}
decl_stmt|;
end_decl_stmt

begin_function
name|int
name|piggyback
parameter_list|(
name|char
modifier|*
name|file
parameter_list|)
block|{
name|int
name|n
decl_stmt|,
name|len
decl_stmt|;
name|struct
name|exec
name|hdr
decl_stmt|;
comment|/* object header */
name|char
name|image
index|[
name|MAXIMAGE
index|]
decl_stmt|;
comment|/* kernel image buffer */
name|len
operator|=
literal|0
expr_stmt|;
while|while
condition|(
operator|(
name|n
operator|=
name|read
argument_list|(
literal|0
argument_list|,
operator|&
name|image
index|[
name|len
index|]
argument_list|,
sizeof|sizeof
argument_list|(
name|image
argument_list|)
operator|-
name|len
operator|+
literal|1
argument_list|)
operator|)
operator|>
literal|0
condition|)
name|len
operator|+=
name|n
expr_stmt|;
if|if
condition|(
name|n
operator|<
literal|0
condition|)
name|err
argument_list|(
literal|1
argument_list|,
literal|"stdin"
argument_list|)
expr_stmt|;
if|if
condition|(
name|len
operator|>=
sizeof|sizeof
argument_list|(
name|image
argument_list|)
condition|)
name|errx
argument_list|(
literal|1
argument_list|,
literal|"input too large"
argument_list|)
expr_stmt|;
comment|/* 	 *      Output object header 	 */
name|memset
argument_list|(
operator|&
name|hdr
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
name|hdr
argument_list|)
expr_stmt|;
name|hdr
operator|.
name|a_magic
operator|=
name|OMAGIC
expr_stmt|;
name|hdr
operator|.
name|a_text
operator|=
name|len
operator|+
sizeof|sizeof
argument_list|(
name|long
argument_list|)
expr_stmt|;
name|hdr
operator|.
name|a_syms
operator|=
sizeof|sizeof
argument_list|(
name|var_names
argument_list|)
expr_stmt|;
name|write
argument_list|(
literal|1
argument_list|,
operator|(
name|char
operator|*
operator|)
operator|&
name|hdr
argument_list|,
sizeof|sizeof
argument_list|(
name|hdr
argument_list|)
argument_list|)
expr_stmt|;
comment|/* 	 *      Output text segment (compressed system& len) 	 */
name|write
argument_list|(
literal|1
argument_list|,
name|image
argument_list|,
name|len
argument_list|)
expr_stmt|;
name|write
argument_list|(
literal|1
argument_list|,
operator|(
name|char
operator|*
operator|)
operator|&
name|len
argument_list|,
sizeof|sizeof
argument_list|(
name|len
argument_list|)
argument_list|)
expr_stmt|;
comment|/* 	 *      Output symbol table 	 */
name|var_names
index|[
literal|1
index|]
operator|.
name|n_value
operator|=
name|len
expr_stmt|;
name|write
argument_list|(
literal|1
argument_list|,
operator|(
name|char
operator|*
operator|)
operator|&
name|var_names
argument_list|,
sizeof|sizeof
argument_list|(
name|var_names
argument_list|)
argument_list|)
expr_stmt|;
comment|/* 	 *      Output string table 	 */
name|len
operator|=
sizeof|sizeof
argument_list|(
name|string_names
argument_list|)
operator|+
sizeof|sizeof
argument_list|(
name|len
argument_list|)
expr_stmt|;
name|write
argument_list|(
literal|1
argument_list|,
operator|(
name|char
operator|*
operator|)
operator|&
name|len
argument_list|,
sizeof|sizeof
argument_list|(
name|len
argument_list|)
argument_list|)
expr_stmt|;
name|write
argument_list|(
literal|1
argument_list|,
name|string_names
argument_list|,
sizeof|sizeof
argument_list|(
name|string_names
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

end_unit


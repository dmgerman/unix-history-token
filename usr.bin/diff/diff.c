begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*	$OpenBSD: diff.c,v 1.65 2015/12/29 19:04:46 gsoares Exp $	*/
end_comment

begin_comment
comment|/*  * Copyright (c) 2003 Todd C. Miller<Todd.Miller@courtesan.com>  *  * Permission to use, copy, modify, and distribute this software for any  * purpose with or without fee is hereby granted, provided that the above  * copyright notice and this permission notice appear in all copies.  *  * THE SOFTWARE IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL WARRANTIES  * WITH REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF  * MERCHANTABILITY AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR  * ANY SPECIAL, DIRECT, INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES  * WHATSOEVER RESULTING FROM LOSS OF USE, DATA OR PROFITS, WHETHER IN AN  * ACTION OF CONTRACT, NEGLIGENCE OR OTHER TORTIOUS ACTION, ARISING OUT OF  * OR IN CONNECTION WITH THE USE OR PERFORMANCE OF THIS SOFTWARE.  *  * Sponsored in part by the Defense Advanced Research Projects  * Agency (DARPA) and Air Force Research Laboratory, Air Force  * Materiel Command, USAF, under agreement number F39502-99-1-0512.  */
end_comment

begin_include
include|#
directive|include
file|<sys/cdefs.h>
end_include

begin_expr_stmt
name|__FBSDID
argument_list|(
literal|"$FreeBSD$"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_include
include|#
directive|include
file|<sys/stat.h>
end_include

begin_include
include|#
directive|include
file|<ctype.h>
end_include

begin_include
include|#
directive|include
file|<err.h>
end_include

begin_include
include|#
directive|include
file|<errno.h>
end_include

begin_include
include|#
directive|include
file|<getopt.h>
end_include

begin_include
include|#
directive|include
file|<stdlib.h>
end_include

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_include
include|#
directive|include
file|<stdarg.h>
end_include

begin_include
include|#
directive|include
file|<string.h>
end_include

begin_include
include|#
directive|include
file|<unistd.h>
end_include

begin_include
include|#
directive|include
file|<limits.h>
end_include

begin_include
include|#
directive|include
file|"diff.h"
end_include

begin_include
include|#
directive|include
file|"xmalloc.h"
end_include

begin_decl_stmt
name|int
name|lflag
decl_stmt|,
name|Nflag
decl_stmt|,
name|Pflag
decl_stmt|,
name|rflag
decl_stmt|,
name|sflag
decl_stmt|,
name|Tflag
decl_stmt|,
name|cflag
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|diff_format
decl_stmt|,
name|diff_context
decl_stmt|,
name|status
decl_stmt|,
name|ignore_file_case
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|tabsize
init|=
literal|8
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|char
modifier|*
name|start
decl_stmt|,
modifier|*
name|ifdefname
decl_stmt|,
modifier|*
name|diffargs
decl_stmt|,
modifier|*
name|label
index|[
literal|2
index|]
decl_stmt|,
modifier|*
name|ignore_pats
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|struct
name|stat
name|stb1
decl_stmt|,
name|stb2
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|struct
name|excludes
modifier|*
name|excludes_list
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|regex_t
name|ignore_re
decl_stmt|;
end_decl_stmt

begin_define
define|#
directive|define
name|OPTIONS
value|"0123456789aBbC:cdD:efhI:iL:lnNPpqrS:sTtU:uwX:x:"
end_define

begin_enum
enum|enum
block|{
name|OPT_TSIZE
init|=
name|CHAR_MAX
operator|+
literal|1
block|,
name|OPT_STRIPCR
block|,
name|OPT_IGN_FN_CASE
block|,
name|OPT_NO_IGN_FN_CASE
block|,
name|OPT_NORMAL
block|,
name|OPT_HORIZON_LINES
block|, }
enum|;
end_enum

begin_decl_stmt
specifier|static
name|struct
name|option
name|longopts
index|[]
init|=
block|{
block|{
literal|"text"
block|,
name|no_argument
block|,
literal|0
block|,
literal|'a'
block|}
block|,
block|{
literal|"ignore-space-change"
block|,
name|no_argument
block|,
literal|0
block|,
literal|'b'
block|}
block|,
block|{
literal|"context"
block|,
name|optional_argument
block|,
literal|0
block|,
literal|'C'
block|}
block|,
block|{
literal|"ifdef"
block|,
name|required_argument
block|,
literal|0
block|,
literal|'D'
block|}
block|,
block|{
literal|"minimal"
block|,
name|no_argument
block|,
literal|0
block|,
literal|'d'
block|}
block|,
block|{
literal|"ed"
block|,
name|no_argument
block|,
literal|0
block|,
literal|'e'
block|}
block|,
block|{
literal|"forward-ed"
block|,
name|no_argument
block|,
literal|0
block|,
literal|'f'
block|}
block|,
block|{
literal|"ignore-matching-lines"
block|,
name|required_argument
block|,
literal|0
block|,
literal|'I'
block|}
block|,
block|{
literal|"ignore-case"
block|,
name|no_argument
block|,
literal|0
block|,
literal|'i'
block|}
block|,
block|{
literal|"paginate"
block|,
name|no_argument
block|,
name|NULL
block|,
literal|'l'
block|}
block|,
block|{
literal|"label"
block|,
name|required_argument
block|,
literal|0
block|,
literal|'L'
block|}
block|,
block|{
literal|"new-file"
block|,
name|no_argument
block|,
literal|0
block|,
literal|'N'
block|}
block|,
block|{
literal|"rcs"
block|,
name|no_argument
block|,
literal|0
block|,
literal|'n'
block|}
block|,
block|{
literal|"unidirectional-new-file"
block|,
name|no_argument
block|,
literal|0
block|,
literal|'P'
block|}
block|,
block|{
literal|"show-c-function"
block|,
name|no_argument
block|,
literal|0
block|,
literal|'p'
block|}
block|,
block|{
literal|"brief"
block|,
name|no_argument
block|,
literal|0
block|,
literal|'q'
block|}
block|,
block|{
literal|"recursive"
block|,
name|no_argument
block|,
literal|0
block|,
literal|'r'
block|}
block|,
block|{
literal|"report-identical-files"
block|,
name|no_argument
block|,
literal|0
block|,
literal|'s'
block|}
block|,
block|{
literal|"starting-file"
block|,
name|required_argument
block|,
literal|0
block|,
literal|'S'
block|}
block|,
block|{
literal|"expand-tabs"
block|,
name|no_argument
block|,
literal|0
block|,
literal|'t'
block|}
block|,
block|{
literal|"initial-tab"
block|,
name|no_argument
block|,
literal|0
block|,
literal|'T'
block|}
block|,
block|{
literal|"unified"
block|,
name|optional_argument
block|,
literal|0
block|,
literal|'U'
block|}
block|,
block|{
literal|"ignore-all-space"
block|,
name|no_argument
block|,
literal|0
block|,
literal|'w'
block|}
block|,
block|{
literal|"exclude"
block|,
name|required_argument
block|,
literal|0
block|,
literal|'x'
block|}
block|,
block|{
literal|"exclude-from"
block|,
name|required_argument
block|,
literal|0
block|,
literal|'X'
block|}
block|,
block|{
literal|"ignore-file-name-case"
block|,
name|no_argument
block|,
name|NULL
block|,
name|OPT_IGN_FN_CASE
block|}
block|,
block|{
literal|"horizon-lines"
block|,
name|required_argument
block|,
name|NULL
block|,
name|OPT_HORIZON_LINES
block|}
block|,
block|{
literal|"no-ignore-file-name-case"
block|,
name|no_argument
block|,
name|NULL
block|,
name|OPT_NO_IGN_FN_CASE
block|}
block|,
block|{
literal|"normal"
block|,
name|no_argument
block|,
name|NULL
block|,
name|OPT_NORMAL
block|}
block|,
block|{
literal|"strip-trailing-cr"
block|,
name|no_argument
block|,
name|NULL
block|,
name|OPT_STRIPCR
block|}
block|,
block|{
literal|"tabsize"
block|,
name|optional_argument
block|,
name|NULL
block|,
name|OPT_TSIZE
block|}
block|,
block|{
name|NULL
block|,
literal|0
block|,
literal|0
block|,
literal|'\0'
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|void
name|usage
argument_list|(
name|void
argument_list|)
name|__dead2
decl_stmt|;
end_decl_stmt

begin_function_decl
name|void
name|push_excludes
parameter_list|(
name|char
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|void
name|push_ignore_pats
parameter_list|(
name|char
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|void
name|read_excludes_file
parameter_list|(
name|char
modifier|*
name|file
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|void
name|set_argstr
parameter_list|(
name|char
modifier|*
modifier|*
parameter_list|,
name|char
modifier|*
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function
name|int
name|main
parameter_list|(
name|int
name|argc
parameter_list|,
name|char
modifier|*
modifier|*
name|argv
parameter_list|)
block|{
specifier|const
name|char
modifier|*
name|errstr
init|=
name|NULL
decl_stmt|;
name|char
modifier|*
name|ep
decl_stmt|,
modifier|*
modifier|*
name|oargv
decl_stmt|;
name|long
name|l
decl_stmt|;
name|int
name|ch
decl_stmt|,
name|dflags
decl_stmt|,
name|lastch
decl_stmt|,
name|gotstdin
decl_stmt|,
name|prevoptind
decl_stmt|,
name|newarg
decl_stmt|;
name|oargv
operator|=
name|argv
expr_stmt|;
name|gotstdin
operator|=
literal|0
expr_stmt|;
name|dflags
operator|=
literal|0
expr_stmt|;
name|lastch
operator|=
literal|'\0'
expr_stmt|;
name|prevoptind
operator|=
literal|1
expr_stmt|;
name|newarg
operator|=
literal|1
expr_stmt|;
name|diff_context
operator|=
literal|3
expr_stmt|;
name|diff_format
operator|=
literal|0
expr_stmt|;
while|while
condition|(
operator|(
name|ch
operator|=
name|getopt_long
argument_list|(
name|argc
argument_list|,
name|argv
argument_list|,
name|OPTIONS
argument_list|,
name|longopts
argument_list|,
name|NULL
argument_list|)
operator|)
operator|!=
operator|-
literal|1
condition|)
block|{
switch|switch
condition|(
name|ch
condition|)
block|{
case|case
literal|'0'
case|:
case|case
literal|'1'
case|:
case|case
literal|'2'
case|:
case|case
literal|'3'
case|:
case|case
literal|'4'
case|:
case|case
literal|'5'
case|:
case|case
literal|'6'
case|:
case|case
literal|'7'
case|:
case|case
literal|'8'
case|:
case|case
literal|'9'
case|:
if|if
condition|(
name|newarg
condition|)
name|usage
argument_list|()
expr_stmt|;
comment|/* disallow -[0-9]+ */
elseif|else
if|if
condition|(
name|lastch
operator|==
literal|'c'
operator|||
name|lastch
operator|==
literal|'u'
condition|)
name|diff_context
operator|=
literal|0
expr_stmt|;
elseif|else
if|if
condition|(
operator|!
name|isdigit
argument_list|(
name|lastch
argument_list|)
operator|||
name|diff_context
operator|>
name|INT_MAX
operator|/
literal|10
condition|)
name|usage
argument_list|()
expr_stmt|;
name|diff_context
operator|=
operator|(
name|diff_context
operator|*
literal|10
operator|)
operator|+
operator|(
name|ch
operator|-
literal|'0'
operator|)
expr_stmt|;
break|break;
case|case
literal|'a'
case|:
name|dflags
operator||=
name|D_FORCEASCII
expr_stmt|;
break|break;
case|case
literal|'b'
case|:
name|dflags
operator||=
name|D_FOLDBLANKS
expr_stmt|;
break|break;
case|case
literal|'C'
case|:
case|case
literal|'c'
case|:
name|cflag
operator|=
literal|1
expr_stmt|;
name|diff_format
operator|=
name|D_CONTEXT
expr_stmt|;
if|if
condition|(
name|optarg
operator|!=
name|NULL
condition|)
block|{
name|l
operator|=
name|strtol
argument_list|(
name|optarg
argument_list|,
operator|&
name|ep
argument_list|,
literal|10
argument_list|)
expr_stmt|;
if|if
condition|(
operator|*
name|ep
operator|!=
literal|'\0'
operator|||
name|l
operator|<
literal|0
operator|||
name|l
operator|>=
name|INT_MAX
condition|)
name|usage
argument_list|()
expr_stmt|;
name|diff_context
operator|=
operator|(
name|int
operator|)
name|l
expr_stmt|;
block|}
break|break;
case|case
literal|'d'
case|:
name|dflags
operator||=
name|D_MINIMAL
expr_stmt|;
break|break;
case|case
literal|'D'
case|:
name|diff_format
operator|=
name|D_IFDEF
expr_stmt|;
name|ifdefname
operator|=
name|optarg
expr_stmt|;
break|break;
case|case
literal|'e'
case|:
name|diff_format
operator|=
name|D_EDIT
expr_stmt|;
break|break;
case|case
literal|'f'
case|:
name|diff_format
operator|=
name|D_REVERSE
expr_stmt|;
break|break;
case|case
literal|'h'
case|:
comment|/* silently ignore for backwards compatibility */
break|break;
case|case
literal|'I'
case|:
name|push_ignore_pats
argument_list|(
name|optarg
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'i'
case|:
name|dflags
operator||=
name|D_IGNORECASE
expr_stmt|;
break|break;
case|case
literal|'L'
case|:
if|if
condition|(
name|label
index|[
literal|0
index|]
operator|==
name|NULL
condition|)
name|label
index|[
literal|0
index|]
operator|=
name|optarg
expr_stmt|;
elseif|else
if|if
condition|(
name|label
index|[
literal|1
index|]
operator|==
name|NULL
condition|)
name|label
index|[
literal|1
index|]
operator|=
name|optarg
expr_stmt|;
else|else
name|usage
argument_list|()
expr_stmt|;
break|break;
case|case
literal|'l'
case|:
name|lflag
operator|=
literal|1
expr_stmt|;
break|break;
case|case
literal|'N'
case|:
name|Nflag
operator|=
literal|1
expr_stmt|;
break|break;
case|case
literal|'n'
case|:
name|diff_format
operator|=
name|D_NREVERSE
expr_stmt|;
break|break;
case|case
literal|'p'
case|:
if|if
condition|(
name|diff_format
operator|==
literal|0
condition|)
name|diff_format
operator|=
name|D_CONTEXT
expr_stmt|;
name|dflags
operator||=
name|D_PROTOTYPE
expr_stmt|;
break|break;
case|case
literal|'P'
case|:
name|Pflag
operator|=
literal|1
expr_stmt|;
break|break;
case|case
literal|'r'
case|:
name|rflag
operator|=
literal|1
expr_stmt|;
break|break;
case|case
literal|'q'
case|:
name|diff_format
operator|=
name|D_BRIEF
expr_stmt|;
break|break;
case|case
literal|'S'
case|:
name|start
operator|=
name|optarg
expr_stmt|;
break|break;
case|case
literal|'s'
case|:
name|sflag
operator|=
literal|1
expr_stmt|;
break|break;
case|case
literal|'T'
case|:
name|Tflag
operator|=
literal|1
expr_stmt|;
break|break;
case|case
literal|'t'
case|:
name|dflags
operator||=
name|D_EXPANDTABS
expr_stmt|;
break|break;
case|case
literal|'U'
case|:
case|case
literal|'u'
case|:
name|diff_format
operator|=
name|D_UNIFIED
expr_stmt|;
if|if
condition|(
name|optarg
operator|!=
name|NULL
condition|)
block|{
name|l
operator|=
name|strtol
argument_list|(
name|optarg
argument_list|,
operator|&
name|ep
argument_list|,
literal|10
argument_list|)
expr_stmt|;
if|if
condition|(
operator|*
name|ep
operator|!=
literal|'\0'
operator|||
name|l
operator|<
literal|0
operator|||
name|l
operator|>=
name|INT_MAX
condition|)
name|usage
argument_list|()
expr_stmt|;
name|diff_context
operator|=
operator|(
name|int
operator|)
name|l
expr_stmt|;
block|}
break|break;
case|case
literal|'w'
case|:
name|dflags
operator||=
name|D_IGNOREBLANKS
expr_stmt|;
break|break;
case|case
literal|'X'
case|:
name|read_excludes_file
argument_list|(
name|optarg
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'x'
case|:
name|push_excludes
argument_list|(
name|optarg
argument_list|)
expr_stmt|;
break|break;
case|case
name|OPT_HORIZON_LINES
case|:
break|break;
comment|/* XXX TODO for compatibility with GNU diff3 */
case|case
name|OPT_IGN_FN_CASE
case|:
name|ignore_file_case
operator|=
literal|1
expr_stmt|;
break|break;
case|case
name|OPT_NO_IGN_FN_CASE
case|:
name|ignore_file_case
operator|=
literal|0
expr_stmt|;
break|break;
case|case
name|OPT_NORMAL
case|:
name|diff_format
operator|=
name|D_NORMAL
expr_stmt|;
break|break;
case|case
name|OPT_TSIZE
case|:
name|tabsize
operator|=
operator|(
name|int
operator|)
name|strtonum
argument_list|(
name|optarg
argument_list|,
literal|1
argument_list|,
name|INT_MAX
argument_list|,
operator|&
name|errstr
argument_list|)
expr_stmt|;
if|if
condition|(
name|errstr
condition|)
block|{
name|warnx
argument_list|(
literal|"Invalid argument for tabsize"
argument_list|)
expr_stmt|;
name|usage
argument_list|()
expr_stmt|;
block|}
break|break;
case|case
name|OPT_STRIPCR
case|:
name|dflags
operator||=
name|D_STRIPCR
expr_stmt|;
break|break;
default|default:
name|usage
argument_list|()
expr_stmt|;
break|break;
block|}
name|lastch
operator|=
name|ch
expr_stmt|;
name|newarg
operator|=
name|optind
operator|!=
name|prevoptind
expr_stmt|;
name|prevoptind
operator|=
name|optind
expr_stmt|;
block|}
name|argc
operator|-=
name|optind
expr_stmt|;
name|argv
operator|+=
name|optind
expr_stmt|;
ifdef|#
directive|ifdef
name|__OpenBSD__
if|if
condition|(
name|pledge
argument_list|(
literal|"stdio rpath tmppath"
argument_list|,
name|NULL
argument_list|)
operator|==
operator|-
literal|1
condition|)
name|err
argument_list|(
literal|2
argument_list|,
literal|"pledge"
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* 	 * Do sanity checks, fill in stb1 and stb2 and call the appropriate 	 * driver routine.  Both drivers use the contents of stb1 and stb2. 	 */
if|if
condition|(
name|argc
operator|!=
literal|2
condition|)
name|usage
argument_list|()
expr_stmt|;
if|if
condition|(
name|ignore_pats
operator|!=
name|NULL
condition|)
block|{
name|char
name|buf
index|[
name|BUFSIZ
index|]
decl_stmt|;
name|int
name|error
decl_stmt|;
if|if
condition|(
operator|(
name|error
operator|=
name|regcomp
argument_list|(
operator|&
name|ignore_re
argument_list|,
name|ignore_pats
argument_list|,
name|REG_NEWLINE
operator||
name|REG_EXTENDED
argument_list|)
operator|)
operator|!=
literal|0
condition|)
block|{
name|regerror
argument_list|(
name|error
argument_list|,
operator|&
name|ignore_re
argument_list|,
name|buf
argument_list|,
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|*
name|ignore_pats
operator|!=
literal|'\0'
condition|)
name|errx
argument_list|(
literal|2
argument_list|,
literal|"%s: %s"
argument_list|,
name|ignore_pats
argument_list|,
name|buf
argument_list|)
expr_stmt|;
else|else
name|errx
argument_list|(
literal|2
argument_list|,
literal|"%s"
argument_list|,
name|buf
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
name|strcmp
argument_list|(
name|argv
index|[
literal|0
index|]
argument_list|,
literal|"-"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|fstat
argument_list|(
name|STDIN_FILENO
argument_list|,
operator|&
name|stb1
argument_list|)
expr_stmt|;
name|gotstdin
operator|=
literal|1
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|stat
argument_list|(
name|argv
index|[
literal|0
index|]
argument_list|,
operator|&
name|stb1
argument_list|)
operator|!=
literal|0
condition|)
name|err
argument_list|(
literal|2
argument_list|,
literal|"%s"
argument_list|,
name|argv
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|strcmp
argument_list|(
name|argv
index|[
literal|1
index|]
argument_list|,
literal|"-"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|fstat
argument_list|(
name|STDIN_FILENO
argument_list|,
operator|&
name|stb2
argument_list|)
expr_stmt|;
name|gotstdin
operator|=
literal|1
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|stat
argument_list|(
name|argv
index|[
literal|1
index|]
argument_list|,
operator|&
name|stb2
argument_list|)
operator|!=
literal|0
condition|)
name|err
argument_list|(
literal|2
argument_list|,
literal|"%s"
argument_list|,
name|argv
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|gotstdin
operator|&&
operator|(
name|S_ISDIR
argument_list|(
name|stb1
operator|.
name|st_mode
argument_list|)
operator|||
name|S_ISDIR
argument_list|(
name|stb2
operator|.
name|st_mode
argument_list|)
operator|)
condition|)
name|errx
argument_list|(
literal|2
argument_list|,
literal|"can't compare - to a directory"
argument_list|)
expr_stmt|;
name|set_argstr
argument_list|(
name|oargv
argument_list|,
name|argv
argument_list|)
expr_stmt|;
if|if
condition|(
name|S_ISDIR
argument_list|(
name|stb1
operator|.
name|st_mode
argument_list|)
operator|&&
name|S_ISDIR
argument_list|(
name|stb2
operator|.
name|st_mode
argument_list|)
condition|)
block|{
if|if
condition|(
name|diff_format
operator|==
name|D_IFDEF
condition|)
name|errx
argument_list|(
literal|2
argument_list|,
literal|"-D option not supported with directories"
argument_list|)
expr_stmt|;
name|diffdir
argument_list|(
name|argv
index|[
literal|0
index|]
argument_list|,
name|argv
index|[
literal|1
index|]
argument_list|,
name|dflags
argument_list|)
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|S_ISDIR
argument_list|(
name|stb1
operator|.
name|st_mode
argument_list|)
condition|)
block|{
name|argv
index|[
literal|0
index|]
operator|=
name|splice
argument_list|(
name|argv
index|[
literal|0
index|]
argument_list|,
name|argv
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|stat
argument_list|(
name|argv
index|[
literal|0
index|]
argument_list|,
operator|&
name|stb1
argument_list|)
operator|<
literal|0
condition|)
name|err
argument_list|(
literal|2
argument_list|,
literal|"%s"
argument_list|,
name|argv
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|S_ISDIR
argument_list|(
name|stb2
operator|.
name|st_mode
argument_list|)
condition|)
block|{
name|argv
index|[
literal|1
index|]
operator|=
name|splice
argument_list|(
name|argv
index|[
literal|1
index|]
argument_list|,
name|argv
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|stat
argument_list|(
name|argv
index|[
literal|1
index|]
argument_list|,
operator|&
name|stb2
argument_list|)
operator|<
literal|0
condition|)
name|err
argument_list|(
literal|2
argument_list|,
literal|"%s"
argument_list|,
name|argv
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
block|}
name|print_status
argument_list|(
name|diffreg
argument_list|(
name|argv
index|[
literal|0
index|]
argument_list|,
name|argv
index|[
literal|1
index|]
argument_list|,
name|dflags
argument_list|,
literal|1
argument_list|)
argument_list|,
name|argv
index|[
literal|0
index|]
argument_list|,
name|argv
index|[
literal|1
index|]
argument_list|,
literal|""
argument_list|)
expr_stmt|;
block|}
name|exit
argument_list|(
name|status
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|set_argstr
parameter_list|(
name|char
modifier|*
modifier|*
name|av
parameter_list|,
name|char
modifier|*
modifier|*
name|ave
parameter_list|)
block|{
name|size_t
name|argsize
decl_stmt|;
name|char
modifier|*
modifier|*
name|ap
decl_stmt|;
name|argsize
operator|=
literal|4
operator|+
operator|*
name|ave
operator|-
operator|*
name|av
operator|+
literal|1
expr_stmt|;
name|diffargs
operator|=
name|xmalloc
argument_list|(
name|argsize
argument_list|)
expr_stmt|;
name|strlcpy
argument_list|(
name|diffargs
argument_list|,
literal|"diff"
argument_list|,
name|argsize
argument_list|)
expr_stmt|;
for|for
control|(
name|ap
operator|=
name|av
operator|+
literal|1
init|;
name|ap
operator|<
name|ave
condition|;
name|ap
operator|++
control|)
block|{
if|if
condition|(
name|strcmp
argument_list|(
operator|*
name|ap
argument_list|,
literal|"--"
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|strlcat
argument_list|(
name|diffargs
argument_list|,
literal|" "
argument_list|,
name|argsize
argument_list|)
expr_stmt|;
name|strlcat
argument_list|(
name|diffargs
argument_list|,
operator|*
name|ap
argument_list|,
name|argsize
argument_list|)
expr_stmt|;
block|}
block|}
block|}
end_function

begin_comment
comment|/*  * Read in an excludes file and push each line.  */
end_comment

begin_function
name|void
name|read_excludes_file
parameter_list|(
name|char
modifier|*
name|file
parameter_list|)
block|{
name|FILE
modifier|*
name|fp
decl_stmt|;
name|char
modifier|*
name|buf
decl_stmt|,
modifier|*
name|pattern
decl_stmt|;
name|size_t
name|len
decl_stmt|;
if|if
condition|(
name|strcmp
argument_list|(
name|file
argument_list|,
literal|"-"
argument_list|)
operator|==
literal|0
condition|)
name|fp
operator|=
name|stdin
expr_stmt|;
elseif|else
if|if
condition|(
operator|(
name|fp
operator|=
name|fopen
argument_list|(
name|file
argument_list|,
literal|"r"
argument_list|)
operator|)
operator|==
name|NULL
condition|)
name|err
argument_list|(
literal|2
argument_list|,
literal|"%s"
argument_list|,
name|file
argument_list|)
expr_stmt|;
while|while
condition|(
operator|(
name|buf
operator|=
name|fgetln
argument_list|(
name|fp
argument_list|,
operator|&
name|len
argument_list|)
operator|)
operator|!=
name|NULL
condition|)
block|{
if|if
condition|(
name|buf
index|[
name|len
operator|-
literal|1
index|]
operator|==
literal|'\n'
condition|)
name|len
operator|--
expr_stmt|;
if|if
condition|(
operator|(
name|pattern
operator|=
name|strndup
argument_list|(
name|buf
argument_list|,
name|len
argument_list|)
operator|)
operator|==
name|NULL
condition|)
name|err
argument_list|(
literal|2
argument_list|,
literal|"xstrndup"
argument_list|)
expr_stmt|;
name|push_excludes
argument_list|(
name|pattern
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|strcmp
argument_list|(
name|file
argument_list|,
literal|"-"
argument_list|)
operator|!=
literal|0
condition|)
name|fclose
argument_list|(
name|fp
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * Push a pattern onto the excludes list.  */
end_comment

begin_function
name|void
name|push_excludes
parameter_list|(
name|char
modifier|*
name|pattern
parameter_list|)
block|{
name|struct
name|excludes
modifier|*
name|entry
decl_stmt|;
name|entry
operator|=
name|xmalloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|entry
argument_list|)
argument_list|)
expr_stmt|;
name|entry
operator|->
name|pattern
operator|=
name|pattern
expr_stmt|;
name|entry
operator|->
name|next
operator|=
name|excludes_list
expr_stmt|;
name|excludes_list
operator|=
name|entry
expr_stmt|;
block|}
end_function

begin_function
name|void
name|push_ignore_pats
parameter_list|(
name|char
modifier|*
name|pattern
parameter_list|)
block|{
name|size_t
name|len
decl_stmt|;
if|if
condition|(
name|ignore_pats
operator|==
name|NULL
condition|)
name|ignore_pats
operator|=
name|xstrdup
argument_list|(
name|pattern
argument_list|)
expr_stmt|;
else|else
block|{
comment|/* old + "|" + new + NUL */
name|len
operator|=
name|strlen
argument_list|(
name|ignore_pats
argument_list|)
operator|+
name|strlen
argument_list|(
name|pattern
argument_list|)
operator|+
literal|2
expr_stmt|;
name|ignore_pats
operator|=
name|xreallocarray
argument_list|(
name|ignore_pats
argument_list|,
literal|1
argument_list|,
name|len
argument_list|)
expr_stmt|;
name|strlcat
argument_list|(
name|ignore_pats
argument_list|,
literal|"|"
argument_list|,
name|len
argument_list|)
expr_stmt|;
name|strlcat
argument_list|(
name|ignore_pats
argument_list|,
name|pattern
argument_list|,
name|len
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
name|void
name|print_only
parameter_list|(
specifier|const
name|char
modifier|*
name|path
parameter_list|,
name|size_t
name|dirlen
parameter_list|,
specifier|const
name|char
modifier|*
name|entry
parameter_list|)
block|{
if|if
condition|(
name|dirlen
operator|>
literal|1
condition|)
name|dirlen
operator|--
expr_stmt|;
name|printf
argument_list|(
literal|"Only in %.*s: %s\n"
argument_list|,
operator|(
name|int
operator|)
name|dirlen
argument_list|,
name|path
argument_list|,
name|entry
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|print_status
parameter_list|(
name|int
name|val
parameter_list|,
name|char
modifier|*
name|path1
parameter_list|,
name|char
modifier|*
name|path2
parameter_list|,
specifier|const
name|char
modifier|*
name|entry
parameter_list|)
block|{
switch|switch
condition|(
name|val
condition|)
block|{
case|case
name|D_BINARY
case|:
name|printf
argument_list|(
literal|"Binary files %s%s and %s%s differ\n"
argument_list|,
name|path1
argument_list|,
name|entry
argument_list|,
name|path2
argument_list|,
name|entry
argument_list|)
expr_stmt|;
break|break;
case|case
name|D_DIFFER
case|:
if|if
condition|(
name|diff_format
operator|==
name|D_BRIEF
condition|)
name|printf
argument_list|(
literal|"Files %s%s and %s%s differ\n"
argument_list|,
name|path1
argument_list|,
name|entry
argument_list|,
name|path2
argument_list|,
name|entry
argument_list|)
expr_stmt|;
break|break;
case|case
name|D_SAME
case|:
if|if
condition|(
name|sflag
condition|)
name|printf
argument_list|(
literal|"Files %s%s and %s%s are identical\n"
argument_list|,
name|path1
argument_list|,
name|entry
argument_list|,
name|path2
argument_list|,
name|entry
argument_list|)
expr_stmt|;
break|break;
case|case
name|D_MISMATCH1
case|:
name|printf
argument_list|(
literal|"File %s%s is a directory while file %s%s is a regular file\n"
argument_list|,
name|path1
argument_list|,
name|entry
argument_list|,
name|path2
argument_list|,
name|entry
argument_list|)
expr_stmt|;
break|break;
case|case
name|D_MISMATCH2
case|:
name|printf
argument_list|(
literal|"File %s%s is a regular file while file %s%s is a directory\n"
argument_list|,
name|path1
argument_list|,
name|entry
argument_list|,
name|path2
argument_list|,
name|entry
argument_list|)
expr_stmt|;
break|break;
case|case
name|D_SKIPPED1
case|:
name|printf
argument_list|(
literal|"File %s%s is not a regular file or directory and was skipped\n"
argument_list|,
name|path1
argument_list|,
name|entry
argument_list|)
expr_stmt|;
break|break;
case|case
name|D_SKIPPED2
case|:
name|printf
argument_list|(
literal|"File %s%s is not a regular file or directory and was skipped\n"
argument_list|,
name|path2
argument_list|,
name|entry
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
end_function

begin_function
name|void
name|usage
parameter_list|(
name|void
parameter_list|)
block|{
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"usage: diff [-abdilpTtw] [-c | -e | -f | -n | -q | -u] [--ignore-case]\n"
literal|"            [--no-ignore-case] [--normal] [--strip-trailing-cr] [--tabsize]\n"
literal|"            [-I pattern] [-L label] file1 file2\n"
literal|"       diff [-abdilpTtw] [-I pattern] [-L label] [--ignore-case]\n"
literal|"            [--no-ignore-case] [--normal] [--strip-trailing-cr] [--tabsize]\n"
literal|"            -C number file1 file2\n"
literal|"       diff [-abdiltw] [-I pattern] [--ignore-case] [--no-ignore-case]\n"
literal|"            [--normal] [--strip-trailing-cr] [--tabsize] -D string file1 file2\n"
literal|"       diff [-abdilpTtw] [-I pattern] [-L label] [--ignore-case]\n"
literal|"            [--no-ignore-case] [--normal] [--tabsize] [--strip-trailing-cr]\n"
literal|"            -U number file1 file2\n"
literal|"       diff [-abdilNPprsTtw] [-c | -e | -f | -n | -q | -u] [--ignore-case]\n"
literal|"            [--no-ignore-case] [--normal] [--tabsize] [-I pattern] [-L label]\n"
literal|"            [-S name] [-X file] [-x pattern] dir1 dir2\n"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|2
argument_list|)
expr_stmt|;
block|}
end_function

end_unit


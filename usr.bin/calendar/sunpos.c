begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*-  * Copyright (c) 2009-2010 Edwin Groothuis. All rights reserved.  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions  * are met:  * 1. Redistributions of source code must retain the above copyright  *    notice, this list of conditions and the following disclaimer.  * 2. Redistributions in binary form must reproduce the above copyright  *    notice, this list of conditions and the following disclaimer in the  *    documentation and/or other materials provided with the distribution.  *   * THIS SOFTWARE IS PROVIDED BY THE AUTHOR AND CONTRIBUTORS ``AS IS'' AND  * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE  * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE  * ARE DISCLAIMED.  IN NO EVENT SHALL THE AUTHOR OR CONTRIBUTORS BE LIABLE  * FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL  * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS  * OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)  * HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT  * LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY  * OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF  * SUCH DAMAGE.  *   */
end_comment

begin_include
include|#
directive|include
file|<sys/cdefs.h>
end_include

begin_expr_stmt
name|__FBSDID
argument_list|(
literal|"$FreeBSD$"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_comment
comment|/*  * This code is created to match the formulas available at:  * Formula and examples obtained from "How to Calculate alt/az: SAAO" at  * http://www.saao.ac.za/public-info/sun-moon-stars/sun-index/how-to-calculate-altaz/  */
end_comment

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_include
include|#
directive|include
file|<stdlib.h>
end_include

begin_include
include|#
directive|include
file|<limits.h>
end_include

begin_include
include|#
directive|include
file|<math.h>
end_include

begin_include
include|#
directive|include
file|<string.h>
end_include

begin_include
include|#
directive|include
file|<time.h>
end_include

begin_include
include|#
directive|include
file|"calendar.h"
end_include

begin_define
define|#
directive|define
name|D2R
parameter_list|(
name|m
parameter_list|)
value|((m) / 180 * M_PI)
end_define

begin_define
define|#
directive|define
name|R2D
parameter_list|(
name|m
parameter_list|)
value|((m) * 180 / M_PI)
end_define

begin_define
define|#
directive|define
name|SIN
parameter_list|(
name|x
parameter_list|)
value|(sin(D2R(x)))
end_define

begin_define
define|#
directive|define
name|COS
parameter_list|(
name|x
parameter_list|)
value|(cos(D2R(x)))
end_define

begin_define
define|#
directive|define
name|TAN
parameter_list|(
name|x
parameter_list|)
value|(tan(D2R(x)))
end_define

begin_define
define|#
directive|define
name|ASIN
parameter_list|(
name|x
parameter_list|)
value|(R2D(asin(x)))
end_define

begin_define
define|#
directive|define
name|ATAN
parameter_list|(
name|x
parameter_list|)
value|(R2D(atan(x)))
end_define

begin_ifdef
ifdef|#
directive|ifdef
name|NOTDEF
end_ifdef

begin_function
specifier|static
name|void
name|comp
parameter_list|(
name|char
modifier|*
name|s
parameter_list|,
name|double
name|v
parameter_list|,
name|double
name|c
parameter_list|)
block|{
name|printf
argument_list|(
literal|"%-*s %*g %*g %*g\n"
argument_list|,
literal|15
argument_list|,
name|s
argument_list|,
literal|15
argument_list|,
name|v
argument_list|,
literal|15
argument_list|,
name|c
argument_list|,
literal|15
argument_list|,
name|v
operator|-
name|c
argument_list|)
expr_stmt|;
block|}
end_function

begin_decl_stmt
name|int
name|expY
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|double
name|expZJ
init|=
literal|30.5
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|double
name|expUTHM
init|=
literal|8.5
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|double
name|expD
init|=
literal|34743.854
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|double
name|expT
init|=
literal|0.9512349
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|double
name|expL
init|=
literal|324.885
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|double
name|expM
init|=
literal|42.029
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|double
name|expepsilon
init|=
literal|23.4396
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|double
name|explambda
init|=
literal|326.186
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|double
name|expalpha
init|=
literal|328.428
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|double
name|expDEC
init|=
operator|-
literal|12.789
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|double
name|expeastlongitude
init|=
literal|17.10
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|double
name|explatitude
init|=
operator|-
literal|22.57
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|double
name|expHA
init|=
operator|-
literal|37.673
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|double
name|expALT
init|=
literal|49.822
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|double
name|expAZ
init|=
literal|67.49
decl_stmt|;
end_decl_stmt

begin_endif
endif|#
directive|endif
end_endif

begin_function
specifier|static
name|double
name|fixup
parameter_list|(
name|double
modifier|*
name|d
parameter_list|)
block|{
if|if
condition|(
operator|*
name|d
operator|<
literal|0
condition|)
block|{
while|while
condition|(
operator|*
name|d
operator|<
literal|0
condition|)
operator|*
name|d
operator|+=
literal|360
expr_stmt|;
block|}
else|else
block|{
while|while
condition|(
operator|*
name|d
operator|>
literal|360
condition|)
operator|*
name|d
operator|-=
literal|360
expr_stmt|;
block|}
return|return
operator|(
operator|*
name|d
operator|)
return|;
block|}
end_function

begin_decl_stmt
specifier|static
name|double
name|ZJtable
index|[]
init|=
block|{
literal|0
block|,
operator|-
literal|0.5
block|,
literal|30.5
block|,
literal|58.5
block|,
literal|89.5
block|,
literal|119.5
block|,
literal|150.5
block|,
literal|180.5
block|,
literal|211.5
block|,
literal|242.5
block|,
literal|272.5
block|,
literal|303.5
block|,
literal|333.5
block|}
decl_stmt|;
end_decl_stmt

begin_function
specifier|static
name|void
name|sunpos
parameter_list|(
name|int
name|inYY
parameter_list|,
name|int
name|inMM
parameter_list|,
name|int
name|inDD
parameter_list|,
name|double
name|UTCOFFSET
parameter_list|,
name|int
name|inHOUR
parameter_list|,
name|int
name|inMIN
parameter_list|,
name|int
name|inSEC
parameter_list|,
name|double
name|eastlongitude
parameter_list|,
name|double
name|latitude
parameter_list|,
name|double
modifier|*
name|L
parameter_list|,
name|double
modifier|*
name|DEC
parameter_list|)
block|{
name|int
name|Y
decl_stmt|;
name|double
name|ZJ
decl_stmt|,
name|D
decl_stmt|,
name|T
decl_stmt|,
name|M
decl_stmt|,
name|epsilon
decl_stmt|,
name|lambda
decl_stmt|,
name|alpha
decl_stmt|,
name|HA
decl_stmt|,
name|UTHM
decl_stmt|;
name|ZJ
operator|=
name|ZJtable
index|[
name|inMM
index|]
expr_stmt|;
if|if
condition|(
name|inMM
operator|<=
literal|2
operator|&&
name|isleap
argument_list|(
name|inYY
argument_list|)
condition|)
name|ZJ
operator|-=
literal|1.0
expr_stmt|;
name|UTHM
operator|=
name|inHOUR
operator|+
name|inMIN
operator|/
name|FMINSPERHOUR
operator|+
name|inSEC
operator|/
name|FSECSPERHOUR
operator|-
name|UTCOFFSET
expr_stmt|;
name|Y
operator|=
name|inYY
operator|-
literal|1900
expr_stmt|;
comment|/*  1 */
name|D
operator|=
name|floor
argument_list|(
literal|365.25
operator|*
name|Y
argument_list|)
operator|+
name|ZJ
operator|+
name|inDD
operator|+
name|UTHM
operator|/
name|FHOURSPERDAY
expr_stmt|;
comment|/*  3 */
name|T
operator|=
name|D
operator|/
literal|36525.0
expr_stmt|;
comment|/*  4 */
operator|*
name|L
operator|=
literal|279.697
operator|+
literal|36000.769
operator|*
name|T
expr_stmt|;
comment|/*  5 */
name|fixup
argument_list|(
name|L
argument_list|)
expr_stmt|;
name|M
operator|=
literal|358.476
operator|+
literal|35999.050
operator|*
name|T
expr_stmt|;
comment|/*  6 */
name|fixup
argument_list|(
operator|&
name|M
argument_list|)
expr_stmt|;
name|epsilon
operator|=
literal|23.452
operator|-
literal|0.013
operator|*
name|T
expr_stmt|;
comment|/*  7 */
name|fixup
argument_list|(
operator|&
name|epsilon
argument_list|)
expr_stmt|;
name|lambda
operator|=
operator|*
name|L
operator|+
operator|(
literal|1.919
operator|-
literal|0.005
operator|*
name|T
operator|)
operator|*
name|SIN
argument_list|(
name|M
argument_list|)
operator|+
literal|0.020
operator|*
name|SIN
argument_list|(
literal|2
operator|*
name|M
argument_list|)
expr_stmt|;
comment|/*  8 */
name|fixup
argument_list|(
operator|&
name|lambda
argument_list|)
expr_stmt|;
name|alpha
operator|=
name|ATAN
argument_list|(
name|TAN
argument_list|(
name|lambda
argument_list|)
operator|*
name|COS
argument_list|(
name|epsilon
argument_list|)
argument_list|)
expr_stmt|;
comment|/*  9 */
comment|/* Alpha should be in the same quadrant as lamba */
block|{
name|int
name|lssign
init|=
name|sin
argument_list|(
name|D2R
argument_list|(
name|lambda
argument_list|)
argument_list|)
operator|<
literal|0
condition|?
operator|-
literal|1
else|:
literal|1
decl_stmt|;
name|int
name|lcsign
init|=
name|cos
argument_list|(
name|D2R
argument_list|(
name|lambda
argument_list|)
argument_list|)
operator|<
literal|0
condition|?
operator|-
literal|1
else|:
literal|1
decl_stmt|;
while|while
condition|(
operator|(
operator|(
name|sin
argument_list|(
name|D2R
argument_list|(
name|alpha
argument_list|)
argument_list|)
operator|<
literal|0
operator|)
condition|?
operator|-
literal|1
else|:
literal|1
operator|)
operator|!=
name|lssign
operator|||
operator|(
operator|(
name|cos
argument_list|(
name|D2R
argument_list|(
name|alpha
argument_list|)
argument_list|)
operator|<
literal|0
operator|)
condition|?
operator|-
literal|1
else|:
literal|1
operator|)
operator|!=
name|lcsign
condition|)
name|alpha
operator|+=
literal|90.0
expr_stmt|;
block|}
name|fixup
argument_list|(
operator|&
name|alpha
argument_list|)
expr_stmt|;
operator|*
name|DEC
operator|=
name|ASIN
argument_list|(
name|SIN
argument_list|(
name|lambda
argument_list|)
operator|*
name|SIN
argument_list|(
name|epsilon
argument_list|)
argument_list|)
expr_stmt|;
comment|/* 10 */
name|fixup
argument_list|(
name|DEC
argument_list|)
expr_stmt|;
name|fixup
argument_list|(
operator|&
name|eastlongitude
argument_list|)
expr_stmt|;
name|HA
operator|=
operator|*
name|L
operator|-
name|alpha
operator|+
literal|180
operator|+
literal|15
operator|*
name|UTHM
operator|+
name|eastlongitude
expr_stmt|;
comment|/* 12 */
name|fixup
argument_list|(
operator|&
name|HA
argument_list|)
expr_stmt|;
name|fixup
argument_list|(
operator|&
name|latitude
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|NOTDEF
name|printf
argument_list|(
literal|"%02d/%02d %02d:%02d:%02d l:%g d:%g h:%g\n"
argument_list|,
name|inMM
argument_list|,
name|inDD
argument_list|,
name|inHOUR
argument_list|,
name|inMIN
argument_list|,
name|inSEC
argument_list|,
name|latitude
argument_list|,
operator|*
name|DEC
argument_list|,
name|HA
argument_list|)
expr_stmt|;
endif|#
directive|endif
return|return;
comment|/* 	 * The following calculations are not used, so to save time 	 * they are not calculated. 	 */
ifdef|#
directive|ifdef
name|NOTDEF
operator|*
name|ALT
operator|=
name|ASIN
argument_list|(
name|SIN
argument_list|(
name|latitude
argument_list|)
operator|*
name|SIN
argument_list|(
operator|*
name|DEC
argument_list|)
operator|+
name|COS
argument_list|(
name|latitude
argument_list|)
operator|*
name|COS
argument_list|(
operator|*
name|DEC
argument_list|)
operator|*
name|COS
argument_list|(
name|HA
argument_list|)
argument_list|)
expr_stmt|;
comment|/* 13 */
name|fixup
argument_list|(
name|ALT
argument_list|)
expr_stmt|;
operator|*
name|AZ
operator|=
name|ATAN
argument_list|(
name|SIN
argument_list|(
name|HA
argument_list|)
operator|/
operator|(
name|COS
argument_list|(
name|HA
argument_list|)
operator|*
name|SIN
argument_list|(
name|latitude
argument_list|)
operator|-
name|TAN
argument_list|(
operator|*
name|DEC
argument_list|)
operator|*
name|COS
argument_list|(
name|latitude
argument_list|)
operator|)
argument_list|)
expr_stmt|;
comment|/* 14 */
if|if
condition|(
operator|*
name|ALT
operator|>
literal|180
condition|)
operator|*
name|ALT
operator|-=
literal|360
expr_stmt|;
if|if
condition|(
operator|*
name|ALT
operator|<
operator|-
literal|180
condition|)
operator|*
name|ALT
operator|+=
literal|360
expr_stmt|;
name|printf
argument_list|(
literal|"a:%g a:%g\n"
argument_list|,
operator|*
name|ALT
argument_list|,
operator|*
name|AZ
argument_list|)
expr_stmt|;
endif|#
directive|endif
ifdef|#
directive|ifdef
name|NOTDEF
name|printf
argument_list|(
literal|"Y:\t\t\t     %d\t\t     %d\t\t      %d\n"
argument_list|,
name|Y
argument_list|,
name|expY
argument_list|,
name|Y
operator|-
name|expY
argument_list|)
expr_stmt|;
name|comp
argument_list|(
literal|"ZJ"
argument_list|,
name|ZJ
argument_list|,
name|expZJ
argument_list|)
expr_stmt|;
name|comp
argument_list|(
literal|"UTHM"
argument_list|,
name|UTHM
argument_list|,
name|expUTHM
argument_list|)
expr_stmt|;
name|comp
argument_list|(
literal|"D"
argument_list|,
name|D
argument_list|,
name|expD
argument_list|)
expr_stmt|;
name|comp
argument_list|(
literal|"T"
argument_list|,
name|T
argument_list|,
name|expT
argument_list|)
expr_stmt|;
name|comp
argument_list|(
literal|"L"
argument_list|,
name|L
argument_list|,
name|fixup
argument_list|(
operator|&
name|expL
argument_list|)
argument_list|)
expr_stmt|;
name|comp
argument_list|(
literal|"M"
argument_list|,
name|M
argument_list|,
name|fixup
argument_list|(
operator|&
name|expM
argument_list|)
argument_list|)
expr_stmt|;
name|comp
argument_list|(
literal|"epsilon"
argument_list|,
name|epsilon
argument_list|,
name|fixup
argument_list|(
operator|&
name|expepsilon
argument_list|)
argument_list|)
expr_stmt|;
name|comp
argument_list|(
literal|"lambda"
argument_list|,
name|lambda
argument_list|,
name|fixup
argument_list|(
operator|&
name|explambda
argument_list|)
argument_list|)
expr_stmt|;
name|comp
argument_list|(
literal|"alpha"
argument_list|,
name|alpha
argument_list|,
name|fixup
argument_list|(
operator|&
name|expalpha
argument_list|)
argument_list|)
expr_stmt|;
name|comp
argument_list|(
literal|"DEC"
argument_list|,
name|DEC
argument_list|,
name|fixup
argument_list|(
operator|&
name|expDEC
argument_list|)
argument_list|)
expr_stmt|;
name|comp
argument_list|(
literal|"eastlongitude"
argument_list|,
name|eastlongitude
argument_list|,
name|fixup
argument_list|(
operator|&
name|expeastlongitude
argument_list|)
argument_list|)
expr_stmt|;
name|comp
argument_list|(
literal|"latitude"
argument_list|,
name|latitude
argument_list|,
name|fixup
argument_list|(
operator|&
name|explatitude
argument_list|)
argument_list|)
expr_stmt|;
name|comp
argument_list|(
literal|"HA"
argument_list|,
name|HA
argument_list|,
name|fixup
argument_list|(
operator|&
name|expHA
argument_list|)
argument_list|)
expr_stmt|;
name|comp
argument_list|(
literal|"ALT"
argument_list|,
name|ALT
argument_list|,
name|fixup
argument_list|(
operator|&
name|expALT
argument_list|)
argument_list|)
expr_stmt|;
name|comp
argument_list|(
literal|"AZ"
argument_list|,
name|AZ
argument_list|,
name|fixup
argument_list|(
operator|&
name|expAZ
argument_list|)
argument_list|)
expr_stmt|;
endif|#
directive|endif
block|}
end_function

begin_define
define|#
directive|define
name|SIGN
parameter_list|(
name|a
parameter_list|)
value|(((a)> 180) ? -1 : 1)
end_define

begin_define
define|#
directive|define
name|ANGLE
parameter_list|(
name|a
parameter_list|,
name|b
parameter_list|)
value|(((a)< (b)) ? 1 : -1)
end_define

begin_define
define|#
directive|define
name|SHOUR
parameter_list|(
name|s
parameter_list|)
value|((s) / 3600)
end_define

begin_define
define|#
directive|define
name|SMIN
parameter_list|(
name|s
parameter_list|)
value|(((s) % 3600) / 60)
end_define

begin_define
define|#
directive|define
name|SSEC
parameter_list|(
name|s
parameter_list|)
value|((s) % 60)
end_define

begin_define
define|#
directive|define
name|HOUR
parameter_list|(
name|h
parameter_list|)
value|((h) / 4)
end_define

begin_define
define|#
directive|define
name|MIN
parameter_list|(
name|h
parameter_list|)
value|(15 * ((h) % 4))
end_define

begin_define
define|#
directive|define
name|SEC
parameter_list|(
name|h
parameter_list|)
value|0
end_define

begin_define
define|#
directive|define
name|DEBUG1
parameter_list|(
name|y
parameter_list|,
name|m
parameter_list|,
name|d
parameter_list|,
name|hh
parameter_list|,
name|mm
parameter_list|,
name|pdec
parameter_list|,
name|dec
parameter_list|)
define|\
value|printf("%4d-%02d-%02d %02d:%02d:00 - %7.7g -> %7.7g\n", \ 	    y, m, d, hh, mm, pdec, dec)
end_define

begin_define
define|#
directive|define
name|DEBUG2
parameter_list|(
name|y
parameter_list|,
name|m
parameter_list|,
name|d
parameter_list|,
name|hh
parameter_list|,
name|mm
parameter_list|,
name|pdec
parameter_list|,
name|dec
parameter_list|,
name|pang
parameter_list|,
name|ang
parameter_list|)
define|\
value|printf("%4d-%02d-%02d %02d:%02d:00 - %7.7g -> %7.7g - %d -> %d\n", \ 	    y, m, d, hh, mm, pdec, dec, pang, ang)
end_define

begin_function
name|void
name|equinoxsolstice
parameter_list|(
name|int
name|year
parameter_list|,
name|double
name|UTCoffset
parameter_list|,
name|int
modifier|*
name|equinoxdays
parameter_list|,
name|int
modifier|*
name|solsticedays
parameter_list|)
block|{
name|double
name|fe
index|[
literal|2
index|]
decl_stmt|,
name|fs
index|[
literal|2
index|]
decl_stmt|;
name|fequinoxsolstice
argument_list|(
name|year
argument_list|,
name|UTCoffset
argument_list|,
name|fe
argument_list|,
name|fs
argument_list|)
expr_stmt|;
name|equinoxdays
index|[
literal|0
index|]
operator|=
name|round
argument_list|(
name|fe
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
name|equinoxdays
index|[
literal|1
index|]
operator|=
name|round
argument_list|(
name|fe
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
name|solsticedays
index|[
literal|0
index|]
operator|=
name|round
argument_list|(
name|fs
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
name|solsticedays
index|[
literal|1
index|]
operator|=
name|round
argument_list|(
name|fs
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|fequinoxsolstice
parameter_list|(
name|int
name|year
parameter_list|,
name|double
name|UTCoffset
parameter_list|,
name|double
modifier|*
name|equinoxdays
parameter_list|,
name|double
modifier|*
name|solsticedays
parameter_list|)
block|{
name|double
name|dec
decl_stmt|,
name|prevdec
decl_stmt|,
name|L
decl_stmt|;
name|int
name|h
decl_stmt|,
name|d
decl_stmt|,
name|prevangle
decl_stmt|,
name|angle
decl_stmt|;
name|int
name|found
init|=
literal|0
decl_stmt|;
name|double
name|decleft
decl_stmt|,
name|decright
decl_stmt|,
name|decmiddle
decl_stmt|;
name|int
name|dial
decl_stmt|,
name|s
decl_stmt|;
name|int
modifier|*
name|cumdays
decl_stmt|;
name|cumdays
operator|=
name|cumdaytab
index|[
name|isleap
argument_list|(
name|year
argument_list|)
index|]
expr_stmt|;
comment|/* 	 * Find the first equinox, somewhere in March: 	 * It happens when the returned value "dec" goes from 	 * [350 ... 360> -> [0 ... 10] 	 */
name|found
operator|=
literal|0
expr_stmt|;
name|prevdec
operator|=
literal|350
expr_stmt|;
for|for
control|(
name|d
operator|=
literal|18
init|;
name|d
operator|<
literal|31
condition|;
name|d
operator|++
control|)
block|{
comment|//		printf("Comparing day %d to %d.\n", d, d+1);
name|sunpos
argument_list|(
name|year
argument_list|,
literal|3
argument_list|,
name|d
argument_list|,
name|UTCoffset
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|0.0
argument_list|,
literal|0.0
argument_list|,
operator|&
name|L
argument_list|,
operator|&
name|decleft
argument_list|)
expr_stmt|;
name|sunpos
argument_list|(
name|year
argument_list|,
literal|3
argument_list|,
name|d
operator|+
literal|1
argument_list|,
name|UTCoffset
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|0.0
argument_list|,
literal|0.0
argument_list|,
operator|&
name|L
argument_list|,
operator|&
name|decright
argument_list|)
expr_stmt|;
comment|//		printf("Found %g and %g.\n", decleft, decright);
if|if
condition|(
name|SIGN
argument_list|(
name|decleft
argument_list|)
operator|==
name|SIGN
argument_list|(
name|decright
argument_list|)
condition|)
continue|continue;
name|dial
operator|=
name|SECSPERDAY
expr_stmt|;
name|s
operator|=
name|SECSPERDAY
operator|/
literal|2
expr_stmt|;
while|while
condition|(
name|s
operator|>
literal|0
condition|)
block|{
comment|//			printf("Obtaining %d (%02d:%02d)\n",
comment|//			    dial, SHOUR(dial), SMIN(dial));
name|sunpos
argument_list|(
name|year
argument_list|,
literal|3
argument_list|,
name|d
argument_list|,
name|UTCoffset
argument_list|,
name|SHOUR
argument_list|(
name|dial
argument_list|)
argument_list|,
name|SMIN
argument_list|(
name|dial
argument_list|)
argument_list|,
name|SSEC
argument_list|(
name|dial
argument_list|)
argument_list|,
literal|0.0
argument_list|,
literal|0.0
argument_list|,
operator|&
name|L
argument_list|,
operator|&
name|decmiddle
argument_list|)
expr_stmt|;
comment|//			printf("Found %g\n", decmiddle);
if|if
condition|(
name|SIGN
argument_list|(
name|decleft
argument_list|)
operator|==
name|SIGN
argument_list|(
name|decmiddle
argument_list|)
condition|)
block|{
name|decleft
operator|=
name|decmiddle
expr_stmt|;
name|dial
operator|+=
name|s
expr_stmt|;
block|}
else|else
block|{
name|decright
operator|=
name|decmiddle
expr_stmt|;
name|dial
operator|-=
name|s
expr_stmt|;
block|}
comment|//			printf("New boundaries: %g - %g\n", decleft, decright);
name|s
operator|/=
literal|2
expr_stmt|;
block|}
name|equinoxdays
index|[
literal|0
index|]
operator|=
literal|1
operator|+
name|cumdays
index|[
literal|3
index|]
operator|+
name|d
operator|+
operator|(
name|dial
operator|/
name|FSECSPERDAY
operator|)
expr_stmt|;
break|break;
block|}
comment|/* Find the second equinox, somewhere in September: 	 * It happens when the returned value "dec" goes from 	 * [10 ... 0] -><360 ... 350] 	 */
name|found
operator|=
literal|0
expr_stmt|;
name|prevdec
operator|=
literal|10
expr_stmt|;
for|for
control|(
name|d
operator|=
literal|18
init|;
name|d
operator|<
literal|31
condition|;
name|d
operator|++
control|)
block|{
comment|//		printf("Comparing day %d to %d.\n", d, d+1);
name|sunpos
argument_list|(
name|year
argument_list|,
literal|9
argument_list|,
name|d
argument_list|,
name|UTCoffset
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|0.0
argument_list|,
literal|0.0
argument_list|,
operator|&
name|L
argument_list|,
operator|&
name|decleft
argument_list|)
expr_stmt|;
name|sunpos
argument_list|(
name|year
argument_list|,
literal|9
argument_list|,
name|d
operator|+
literal|1
argument_list|,
name|UTCoffset
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|0.0
argument_list|,
literal|0.0
argument_list|,
operator|&
name|L
argument_list|,
operator|&
name|decright
argument_list|)
expr_stmt|;
comment|//		printf("Found %g and %g.\n", decleft, decright);
if|if
condition|(
name|SIGN
argument_list|(
name|decleft
argument_list|)
operator|==
name|SIGN
argument_list|(
name|decright
argument_list|)
condition|)
continue|continue;
name|dial
operator|=
name|SECSPERDAY
expr_stmt|;
name|s
operator|=
name|SECSPERDAY
operator|/
literal|2
expr_stmt|;
while|while
condition|(
name|s
operator|>
literal|0
condition|)
block|{
comment|//			printf("Obtaining %d (%02d:%02d)\n",
comment|//			    dial, SHOUR(dial), SMIN(dial));
name|sunpos
argument_list|(
name|year
argument_list|,
literal|9
argument_list|,
name|d
argument_list|,
name|UTCoffset
argument_list|,
name|SHOUR
argument_list|(
name|dial
argument_list|)
argument_list|,
name|SMIN
argument_list|(
name|dial
argument_list|)
argument_list|,
name|SSEC
argument_list|(
name|dial
argument_list|)
argument_list|,
literal|0.0
argument_list|,
literal|0.0
argument_list|,
operator|&
name|L
argument_list|,
operator|&
name|decmiddle
argument_list|)
expr_stmt|;
comment|//			printf("Found %g\n", decmiddle);
if|if
condition|(
name|SIGN
argument_list|(
name|decleft
argument_list|)
operator|==
name|SIGN
argument_list|(
name|decmiddle
argument_list|)
condition|)
block|{
name|decleft
operator|=
name|decmiddle
expr_stmt|;
name|dial
operator|+=
name|s
expr_stmt|;
block|}
else|else
block|{
name|decright
operator|=
name|decmiddle
expr_stmt|;
name|dial
operator|-=
name|s
expr_stmt|;
block|}
comment|//			printf("New boundaries: %g - %g\n", decleft, decright);
name|s
operator|/=
literal|2
expr_stmt|;
block|}
name|equinoxdays
index|[
literal|1
index|]
operator|=
literal|1
operator|+
name|cumdays
index|[
literal|9
index|]
operator|+
name|d
operator|+
operator|(
name|dial
operator|/
name|FSECSPERDAY
operator|)
expr_stmt|;
break|break;
block|}
comment|/* 	 * Find the first solstice, somewhere in June: 	 * It happens when the returned value "dec" peaks 	 * [40 ... 45] -> [45 ... 40] 	 */
name|found
operator|=
literal|0
expr_stmt|;
name|prevdec
operator|=
literal|0
expr_stmt|;
name|prevangle
operator|=
literal|1
expr_stmt|;
for|for
control|(
name|d
operator|=
literal|18
init|;
name|d
operator|<
literal|31
condition|;
name|d
operator|++
control|)
block|{
for|for
control|(
name|h
operator|=
literal|0
init|;
name|h
operator|<
literal|4
operator|*
name|HOURSPERDAY
condition|;
name|h
operator|++
control|)
block|{
name|sunpos
argument_list|(
name|year
argument_list|,
literal|6
argument_list|,
name|d
argument_list|,
name|UTCoffset
argument_list|,
name|HOUR
argument_list|(
name|h
argument_list|)
argument_list|,
name|MIN
argument_list|(
name|h
argument_list|)
argument_list|,
name|SEC
argument_list|(
name|h
argument_list|)
argument_list|,
literal|0.0
argument_list|,
literal|0.0
argument_list|,
operator|&
name|L
argument_list|,
operator|&
name|dec
argument_list|)
expr_stmt|;
name|angle
operator|=
name|ANGLE
argument_list|(
name|prevdec
argument_list|,
name|dec
argument_list|)
expr_stmt|;
if|if
condition|(
name|prevangle
operator|!=
name|angle
condition|)
block|{
ifdef|#
directive|ifdef
name|NOTDEF
name|DEBUG2
argument_list|(
name|year
argument_list|,
literal|6
argument_list|,
name|d
argument_list|,
name|HOUR
argument_list|(
name|h
argument_list|)
argument_list|,
name|MIN
argument_list|(
name|h
argument_list|)
argument_list|,
name|prevdec
argument_list|,
name|dec
argument_list|,
name|prevangle
argument_list|,
name|angle
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|solsticedays
index|[
literal|0
index|]
operator|=
literal|1
operator|+
name|cumdays
index|[
literal|6
index|]
operator|+
name|d
operator|+
operator|(
operator|(
name|h
operator|/
literal|4.0
operator|)
operator|/
literal|24.0
operator|)
expr_stmt|;
name|found
operator|=
literal|1
expr_stmt|;
break|break;
block|}
name|prevdec
operator|=
name|dec
expr_stmt|;
name|prevangle
operator|=
name|angle
expr_stmt|;
block|}
if|if
condition|(
name|found
condition|)
break|break;
block|}
comment|/* 	 * Find the second solstice, somewhere in December: 	 * It happens when the returned value "dec" peaks 	 * [315 ... 310] -> [310 ... 315] 	 */
name|found
operator|=
literal|0
expr_stmt|;
name|prevdec
operator|=
literal|360
expr_stmt|;
name|prevangle
operator|=
operator|-
literal|1
expr_stmt|;
for|for
control|(
name|d
operator|=
literal|18
init|;
name|d
operator|<
literal|31
condition|;
name|d
operator|++
control|)
block|{
for|for
control|(
name|h
operator|=
literal|0
init|;
name|h
operator|<
literal|4
operator|*
name|HOURSPERDAY
condition|;
name|h
operator|++
control|)
block|{
name|sunpos
argument_list|(
name|year
argument_list|,
literal|12
argument_list|,
name|d
argument_list|,
name|UTCoffset
argument_list|,
name|HOUR
argument_list|(
name|h
argument_list|)
argument_list|,
name|MIN
argument_list|(
name|h
argument_list|)
argument_list|,
name|SEC
argument_list|(
name|h
argument_list|)
argument_list|,
literal|0.0
argument_list|,
literal|0.0
argument_list|,
operator|&
name|L
argument_list|,
operator|&
name|dec
argument_list|)
expr_stmt|;
name|angle
operator|=
name|ANGLE
argument_list|(
name|prevdec
argument_list|,
name|dec
argument_list|)
expr_stmt|;
if|if
condition|(
name|prevangle
operator|!=
name|angle
condition|)
block|{
ifdef|#
directive|ifdef
name|NOTDEF
name|DEBUG2
argument_list|(
name|year
argument_list|,
literal|12
argument_list|,
name|d
argument_list|,
name|HOUR
argument_list|(
name|h
argument_list|)
argument_list|,
name|MIN
argument_list|(
name|h
argument_list|)
argument_list|,
name|prevdec
argument_list|,
name|dec
argument_list|,
name|prevangle
argument_list|,
name|angle
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|solsticedays
index|[
literal|1
index|]
operator|=
literal|1
operator|+
name|cumdays
index|[
literal|12
index|]
operator|+
name|d
operator|+
operator|(
operator|(
name|h
operator|/
literal|4.0
operator|)
operator|/
literal|24.0
operator|)
expr_stmt|;
name|found
operator|=
literal|1
expr_stmt|;
break|break;
block|}
name|prevdec
operator|=
name|dec
expr_stmt|;
name|prevangle
operator|=
name|angle
expr_stmt|;
block|}
if|if
condition|(
name|found
condition|)
break|break;
block|}
return|return;
block|}
end_function

begin_function
name|int
name|calculatesunlongitude30
parameter_list|(
name|int
name|year
parameter_list|,
name|int
name|degreeGMToffset
parameter_list|,
name|int
modifier|*
name|ichinesemonths
parameter_list|)
block|{
name|int
name|m
decl_stmt|,
name|d
decl_stmt|,
name|h
decl_stmt|;
name|double
name|dec
decl_stmt|;
name|double
name|curL
decl_stmt|,
name|prevL
decl_stmt|;
name|int
modifier|*
name|pichinesemonths
decl_stmt|,
modifier|*
name|monthdays
decl_stmt|,
modifier|*
name|cumdays
decl_stmt|,
name|i
decl_stmt|;
name|int
name|firstmonth330
init|=
operator|-
literal|1
decl_stmt|;
name|cumdays
operator|=
name|cumdaytab
index|[
name|isleap
argument_list|(
name|year
argument_list|)
index|]
expr_stmt|;
name|monthdays
operator|=
name|mondaytab
index|[
name|isleap
argument_list|(
name|year
argument_list|)
index|]
expr_stmt|;
name|pichinesemonths
operator|=
name|ichinesemonths
expr_stmt|;
name|h
operator|=
literal|0
expr_stmt|;
name|sunpos
argument_list|(
name|year
operator|-
literal|1
argument_list|,
literal|12
argument_list|,
literal|31
argument_list|,
operator|-
literal|24
operator|*
operator|(
name|degreeGMToffset
operator|/
literal|360.0
operator|)
argument_list|,
name|HOUR
argument_list|(
name|h
argument_list|)
argument_list|,
name|MIN
argument_list|(
name|h
argument_list|)
argument_list|,
name|SEC
argument_list|(
name|h
argument_list|)
argument_list|,
literal|0.0
argument_list|,
literal|0.0
argument_list|,
operator|&
name|prevL
argument_list|,
operator|&
name|dec
argument_list|)
expr_stmt|;
for|for
control|(
name|m
operator|=
literal|1
init|;
name|m
operator|<=
literal|12
condition|;
name|m
operator|++
control|)
block|{
for|for
control|(
name|d
operator|=
literal|1
init|;
name|d
operator|<=
name|monthdays
index|[
name|m
index|]
condition|;
name|d
operator|++
control|)
block|{
for|for
control|(
name|h
operator|=
literal|0
init|;
name|h
operator|<
literal|4
operator|*
name|HOURSPERDAY
condition|;
name|h
operator|++
control|)
block|{
name|sunpos
argument_list|(
name|year
argument_list|,
name|m
argument_list|,
name|d
argument_list|,
operator|-
literal|24
operator|*
operator|(
name|degreeGMToffset
operator|/
literal|360.0
operator|)
argument_list|,
name|HOUR
argument_list|(
name|h
argument_list|)
argument_list|,
name|MIN
argument_list|(
name|h
argument_list|)
argument_list|,
name|SEC
argument_list|(
name|h
argument_list|)
argument_list|,
literal|0.0
argument_list|,
literal|0.0
argument_list|,
operator|&
name|curL
argument_list|,
operator|&
name|dec
argument_list|)
expr_stmt|;
if|if
condition|(
name|curL
operator|<
literal|180
operator|&&
name|prevL
operator|>
literal|180
condition|)
block|{
operator|*
name|pichinesemonths
operator|=
name|cumdays
index|[
name|m
index|]
operator|+
name|d
expr_stmt|;
ifdef|#
directive|ifdef
name|DEBUG
name|printf
argument_list|(
literal|"%04d-%02d-%02d %02d:%02d - %d %g\n"
argument_list|,
name|year
argument_list|,
name|m
argument_list|,
name|d
argument_list|,
name|HOUR
argument_list|(
name|h
argument_list|)
argument_list|,
name|MIN
argument_list|(
name|h
argument_list|)
argument_list|,
operator|*
name|pichinesemonths
argument_list|,
name|curL
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|pichinesemonths
operator|++
expr_stmt|;
block|}
else|else
block|{
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<=
literal|360
condition|;
name|i
operator|+=
literal|30
control|)
if|if
condition|(
name|curL
operator|>
name|i
operator|&&
name|prevL
operator|<
name|i
condition|)
block|{
operator|*
name|pichinesemonths
operator|=
name|cumdays
index|[
name|m
index|]
operator|+
name|d
expr_stmt|;
ifdef|#
directive|ifdef
name|DEBUG
name|printf
argument_list|(
literal|"%04d-%02d-%02d %02d:%02d - %d %g\n"
argument_list|,
name|year
argument_list|,
name|m
argument_list|,
name|d
argument_list|,
name|HOUR
argument_list|(
name|h
argument_list|)
argument_list|,
name|MIN
argument_list|(
name|h
argument_list|)
argument_list|,
operator|*
name|pichinesemonths
argument_list|,
name|curL
argument_list|)
expr_stmt|;
endif|#
directive|endif
if|if
condition|(
name|i
operator|==
literal|330
condition|)
name|firstmonth330
operator|=
operator|*
name|pichinesemonths
expr_stmt|;
name|pichinesemonths
operator|++
expr_stmt|;
block|}
block|}
name|prevL
operator|=
name|curL
expr_stmt|;
block|}
block|}
block|}
operator|*
name|pichinesemonths
operator|=
operator|-
literal|1
expr_stmt|;
return|return
operator|(
name|firstmonth330
operator|)
return|;
block|}
end_function

begin_ifdef
ifdef|#
directive|ifdef
name|NOTDEF
end_ifdef

begin_function
name|int
name|main
parameter_list|(
name|int
name|argc
parameter_list|,
name|char
modifier|*
modifier|*
name|argv
parameter_list|)
block|{
comment|/* 	year      Mar        June       Sept       Dec 	     day   time  day   time  day time  day time 	2004  20   06:49  21   00:57  22  16:30 21  12:42 	2005  20   12:33  21   06:46  22  22:23 21  18:35 	2006  20   18:26  21   12:26  23  04:03 22  00:22 	2007  21   00:07  21   18:06  23  09:51 22  06:08 	2008  20   05:48  20   23:59  22  15:44 21  12:04 	2009  20   11:44  21   05:45  22  21:18 21  17:47 	2010  20   17:32  21   11:28  23  03:09 21  23:38 	2011  20   23:21  21   17:16  23  09:04 22  05:30 	2012  20   05:14  20   23:09  22  14:49 21  11:11 	2013  20   11:02  21   05:04  22  20:44 21  17:11 	2014  20   16:57  21   10:51  23  02:29 21  23:03 	2015  20   22:45  21   16:38  23  08:20 22  04:48 	2016  20   04:30  20   22:34  22  14:21 21  10:44 	2017  20   10:28  21   04:24  22  20:02 21  16:28 */
name|int
name|eq
index|[
literal|2
index|]
decl_stmt|,
name|sol
index|[
literal|2
index|]
decl_stmt|;
name|equinoxsolstice
argument_list|(
name|strtol
argument_list|(
name|argv
index|[
literal|1
index|]
argument_list|,
name|NULL
argument_list|,
literal|10
argument_list|)
argument_list|,
literal|0.0
argument_list|,
name|eq
argument_list|,
name|sol
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"%d - %d - %d - %d\n"
argument_list|,
name|eq
index|[
literal|0
index|]
argument_list|,
name|sol
index|[
literal|0
index|]
argument_list|,
name|eq
index|[
literal|1
index|]
argument_list|,
name|sol
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

end_unit


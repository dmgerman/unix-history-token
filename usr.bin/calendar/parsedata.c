begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*-  * Copyright (c) 1992-2009 Edwin Groothuis<edwin@FreeBSD.org>.  * All rights reserved.  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions  * are met:  * 1. Redistributions of source code must retain the above copyright  *    notice, this list of conditions and the following disclaimer.  * 2. Redistributions in binary form must reproduce the above copyright  *    notice, this list of conditions and the following disclaimer in the  *    documentation and/or other materials provided with the distribution.  *  * THIS SOFTWARE IS PROVIDED BY THE AUTHOR AND CONTRIBUTORS ``AS IS'' AND  * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE  * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE  * ARE DISCLAIMED.  IN NO EVENT SHALL THE AUTHOR OR CONTRIBUTORS BE LIABLE  * FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL  * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS  * OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)  * HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT  * LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY  * OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF  * SUCH DAMAGE.  *  */
end_comment

begin_include
include|#
directive|include
file|<sys/cdefs.h>
end_include

begin_expr_stmt
name|__FBSDID
argument_list|(
literal|"$FreeBSD$"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_include
include|#
directive|include
file|<ctype.h>
end_include

begin_include
include|#
directive|include
file|<math.h>
end_include

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_include
include|#
directive|include
file|<stdlib.h>
end_include

begin_include
include|#
directive|include
file|<string.h>
end_include

begin_include
include|#
directive|include
file|<err.h>
end_include

begin_include
include|#
directive|include
file|"calendar.h"
end_include

begin_function_decl
specifier|static
name|char
modifier|*
name|showflags
parameter_list|(
name|int
name|flags
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|isonlydigits
parameter_list|(
name|char
modifier|*
name|s
parameter_list|,
name|int
name|nostar
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
specifier|const
name|char
modifier|*
name|getmonthname
parameter_list|(
name|int
name|i
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|checkmonth
parameter_list|(
name|char
modifier|*
name|s
parameter_list|,
name|size_t
modifier|*
name|len
parameter_list|,
name|size_t
modifier|*
name|offset
parameter_list|,
specifier|const
name|char
modifier|*
modifier|*
name|month
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
specifier|const
name|char
modifier|*
name|getdayofweekname
parameter_list|(
name|int
name|i
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|checkdayofweek
parameter_list|(
name|char
modifier|*
name|s
parameter_list|,
name|size_t
modifier|*
name|len
parameter_list|,
name|size_t
modifier|*
name|offset
parameter_list|,
specifier|const
name|char
modifier|*
modifier|*
name|dow
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|indextooffset
parameter_list|(
name|char
modifier|*
name|s
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|parseoffset
parameter_list|(
name|char
modifier|*
name|s
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|char
modifier|*
name|floattoday
parameter_list|(
name|int
name|year
parameter_list|,
name|double
name|f
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|char
modifier|*
name|floattotime
parameter_list|(
name|double
name|f
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|wdayom
parameter_list|(
name|int
name|day
parameter_list|,
name|int
name|offset
parameter_list|,
name|int
name|month
parameter_list|,
name|int
name|year
parameter_list|)
function_decl|;
end_function_decl

begin_comment
comment|/*  * Expected styles:  *  * Date			::=	Month . ' ' . DayOfMonth |  *				Month . ' ' . DayOfWeek . ModifierIndex |  *				Month . '/' . DayOfMonth |  *				Month . '/' . DayOfWeek . ModifierIndex |  *				DayOfMonth . ' ' . Month |  *				DayOfMonth . '/' . Month |  *				DayOfWeek . ModifierIndex . ' ' .Month |  *				DayOfWeek . ModifierIndex . '/' .Month |  *				DayOfWeek . ModifierIndex |  *				SpecialDay . ModifierOffset  *  * Month		::=	MonthName | MonthNumber | '*'  * MonthNumber		::=	'0' ... '9' | '00' ... '09' | '10' ... '12'  * MonthName		::=	MonthNameShort | MonthNameLong  * MonthNameLong	::=	'January' ... 'December'  * MonthNameShort	::=	'Jan' ... 'Dec' | 'Jan.' ... 'Dec.'  *  * DayOfWeek		::=	DayOfWeekShort | DayOfWeekLong  * DayOfWeekShort	::=	'Mon' .. 'Sun'  * DayOfWeekLong	::=	'Monday' .. 'Sunday'  * DayOfMonth		::=	'0' ... '9' | '00' ... '09' | '10' ... '29' |  *				'30' ... '31' | '*'  *  * ModifierOffset	::=	'' | '+' . ModifierNumber | '-' . ModifierNumber  * ModifierNumber	::=	'0' ... '9' | '00' ... '99' | '000' ... '299' |  *				'300' ... '359' | '360' ... '365'  * ModifierIndex	::=	'Second' | 'Third' | 'Fourth' | 'Fifth' |  *				'First' | 'Last'  *  * SpecialDay		::=	'Easter' | 'Paskha' | 'ChineseNewYear'  *  */
end_comment

begin_function
specifier|static
name|int
name|determinestyle
parameter_list|(
name|char
modifier|*
name|date
parameter_list|,
name|int
modifier|*
name|flags
parameter_list|,
name|char
modifier|*
name|month
parameter_list|,
name|int
modifier|*
name|imonth
parameter_list|,
name|char
modifier|*
name|dayofmonth
parameter_list|,
name|int
modifier|*
name|idayofmonth
parameter_list|,
name|char
modifier|*
name|dayofweek
parameter_list|,
name|int
modifier|*
name|idayofweek
parameter_list|,
name|char
modifier|*
name|modifieroffset
parameter_list|,
name|char
modifier|*
name|modifierindex
parameter_list|,
name|char
modifier|*
name|specialday
parameter_list|,
name|char
modifier|*
name|year
parameter_list|,
name|int
modifier|*
name|iyear
parameter_list|)
block|{
name|char
modifier|*
name|p
decl_stmt|,
modifier|*
name|p1
decl_stmt|,
modifier|*
name|p2
decl_stmt|,
modifier|*
name|py
decl_stmt|;
specifier|const
name|char
modifier|*
name|dow
decl_stmt|,
modifier|*
name|pmonth
decl_stmt|;
name|char
name|pold
decl_stmt|;
name|size_t
name|len
decl_stmt|,
name|offset
decl_stmt|;
operator|*
name|flags
operator|=
name|F_NONE
expr_stmt|;
operator|*
name|month
operator|=
literal|'\0'
expr_stmt|;
operator|*
name|imonth
operator|=
literal|0
expr_stmt|;
operator|*
name|year
operator|=
literal|'\0'
expr_stmt|;
operator|*
name|iyear
operator|=
literal|0
expr_stmt|;
operator|*
name|dayofmonth
operator|=
literal|'\0'
expr_stmt|;
operator|*
name|idayofmonth
operator|=
literal|0
expr_stmt|;
operator|*
name|dayofweek
operator|=
literal|'\0'
expr_stmt|;
operator|*
name|idayofweek
operator|=
literal|0
expr_stmt|;
operator|*
name|modifieroffset
operator|=
literal|'\0'
expr_stmt|;
operator|*
name|modifierindex
operator|=
literal|'\0'
expr_stmt|;
operator|*
name|specialday
operator|=
literal|'\0'
expr_stmt|;
define|#
directive|define
name|CHECKSPECIAL
parameter_list|(
name|s1
parameter_list|,
name|s2
parameter_list|,
name|lens2
parameter_list|,
name|type
parameter_list|)
define|\
value|if (s2 != NULL&& strncmp(s1, s2, lens2) == 0) {		\ 		*flags |= F_SPECIALDAY;					\ 		*flags |= type;						\ 		*flags |= F_VARIABLE;					\ 		if (strlen(s1) == lens2) {				\ 			strcpy(specialday, s1);				\ 			return (1);					\ 		}							\ 		strncpy(specialday, s1, lens2);				\ 		specialday[lens2] = '\0';				\ 		strcpy(modifieroffset, s1 + lens2);			\ 		*flags |= F_MODIFIEROFFSET;				\ 		return (1);						\ 	}
if|if
condition|(
operator|(
name|p
operator|=
name|strchr
argument_list|(
name|date
argument_list|,
literal|' '
argument_list|)
operator|)
operator|==
name|NULL
condition|)
block|{
if|if
condition|(
operator|(
name|p
operator|=
name|strchr
argument_list|(
name|date
argument_list|,
literal|'/'
argument_list|)
operator|)
operator|==
name|NULL
condition|)
block|{
name|CHECKSPECIAL
argument_list|(
name|date
argument_list|,
name|STRING_CNY
argument_list|,
name|strlen
argument_list|(
name|STRING_CNY
argument_list|)
argument_list|,
name|F_CNY
argument_list|)
expr_stmt|;
name|CHECKSPECIAL
argument_list|(
name|date
argument_list|,
name|ncny
operator|.
name|name
argument_list|,
name|ncny
operator|.
name|len
argument_list|,
name|F_CNY
argument_list|)
expr_stmt|;
name|CHECKSPECIAL
argument_list|(
name|date
argument_list|,
name|STRING_NEWMOON
argument_list|,
name|strlen
argument_list|(
name|STRING_NEWMOON
argument_list|)
argument_list|,
name|F_NEWMOON
argument_list|)
expr_stmt|;
name|CHECKSPECIAL
argument_list|(
name|date
argument_list|,
name|nnewmoon
operator|.
name|name
argument_list|,
name|nnewmoon
operator|.
name|len
argument_list|,
name|F_NEWMOON
argument_list|)
expr_stmt|;
name|CHECKSPECIAL
argument_list|(
name|date
argument_list|,
name|STRING_FULLMOON
argument_list|,
name|strlen
argument_list|(
name|STRING_FULLMOON
argument_list|)
argument_list|,
name|F_FULLMOON
argument_list|)
expr_stmt|;
name|CHECKSPECIAL
argument_list|(
name|date
argument_list|,
name|nfullmoon
operator|.
name|name
argument_list|,
name|nfullmoon
operator|.
name|len
argument_list|,
name|F_FULLMOON
argument_list|)
expr_stmt|;
name|CHECKSPECIAL
argument_list|(
name|date
argument_list|,
name|STRING_PASKHA
argument_list|,
name|strlen
argument_list|(
name|STRING_PASKHA
argument_list|)
argument_list|,
name|F_PASKHA
argument_list|)
expr_stmt|;
name|CHECKSPECIAL
argument_list|(
name|date
argument_list|,
name|npaskha
operator|.
name|name
argument_list|,
name|npaskha
operator|.
name|len
argument_list|,
name|F_PASKHA
argument_list|)
expr_stmt|;
name|CHECKSPECIAL
argument_list|(
name|date
argument_list|,
name|STRING_EASTER
argument_list|,
name|strlen
argument_list|(
name|STRING_EASTER
argument_list|)
argument_list|,
name|F_EASTER
argument_list|)
expr_stmt|;
name|CHECKSPECIAL
argument_list|(
name|date
argument_list|,
name|neaster
operator|.
name|name
argument_list|,
name|neaster
operator|.
name|len
argument_list|,
name|F_EASTER
argument_list|)
expr_stmt|;
name|CHECKSPECIAL
argument_list|(
name|date
argument_list|,
name|STRING_MAREQUINOX
argument_list|,
name|strlen
argument_list|(
name|STRING_MAREQUINOX
argument_list|)
argument_list|,
name|F_MAREQUINOX
argument_list|)
expr_stmt|;
name|CHECKSPECIAL
argument_list|(
name|date
argument_list|,
name|nmarequinox
operator|.
name|name
argument_list|,
name|nmarequinox
operator|.
name|len
argument_list|,
name|F_SEPEQUINOX
argument_list|)
expr_stmt|;
name|CHECKSPECIAL
argument_list|(
name|date
argument_list|,
name|STRING_SEPEQUINOX
argument_list|,
name|strlen
argument_list|(
name|STRING_SEPEQUINOX
argument_list|)
argument_list|,
name|F_SEPEQUINOX
argument_list|)
expr_stmt|;
name|CHECKSPECIAL
argument_list|(
name|date
argument_list|,
name|nsepequinox
operator|.
name|name
argument_list|,
name|nsepequinox
operator|.
name|len
argument_list|,
name|F_SEPEQUINOX
argument_list|)
expr_stmt|;
name|CHECKSPECIAL
argument_list|(
name|date
argument_list|,
name|STRING_JUNSOLSTICE
argument_list|,
name|strlen
argument_list|(
name|STRING_JUNSOLSTICE
argument_list|)
argument_list|,
name|F_JUNSOLSTICE
argument_list|)
expr_stmt|;
name|CHECKSPECIAL
argument_list|(
name|date
argument_list|,
name|njunsolstice
operator|.
name|name
argument_list|,
name|njunsolstice
operator|.
name|len
argument_list|,
name|F_JUNSOLSTICE
argument_list|)
expr_stmt|;
name|CHECKSPECIAL
argument_list|(
name|date
argument_list|,
name|STRING_DECSOLSTICE
argument_list|,
name|strlen
argument_list|(
name|STRING_DECSOLSTICE
argument_list|)
argument_list|,
name|F_DECSOLSTICE
argument_list|)
expr_stmt|;
name|CHECKSPECIAL
argument_list|(
name|date
argument_list|,
name|ndecsolstice
operator|.
name|name
argument_list|,
name|ndecsolstice
operator|.
name|len
argument_list|,
name|F_DECSOLSTICE
argument_list|)
expr_stmt|;
if|if
condition|(
name|checkdayofweek
argument_list|(
name|date
argument_list|,
operator|&
name|len
argument_list|,
operator|&
name|offset
argument_list|,
operator|&
name|dow
argument_list|)
operator|!=
literal|0
condition|)
block|{
operator|*
name|flags
operator||=
name|F_DAYOFWEEK
expr_stmt|;
operator|*
name|flags
operator||=
name|F_VARIABLE
expr_stmt|;
operator|*
name|idayofweek
operator|=
name|offset
expr_stmt|;
if|if
condition|(
name|strlen
argument_list|(
name|date
argument_list|)
operator|==
name|len
condition|)
block|{
name|strcpy
argument_list|(
name|dayofweek
argument_list|,
name|date
argument_list|)
expr_stmt|;
return|return
operator|(
literal|1
operator|)
return|;
block|}
name|strncpy
argument_list|(
name|dayofweek
argument_list|,
name|date
argument_list|,
name|len
argument_list|)
expr_stmt|;
name|dayofweek
index|[
name|len
index|]
operator|=
literal|'\0'
expr_stmt|;
name|strcpy
argument_list|(
name|modifierindex
argument_list|,
name|date
operator|+
name|len
argument_list|)
expr_stmt|;
operator|*
name|flags
operator||=
name|F_MODIFIERINDEX
expr_stmt|;
return|return
operator|(
literal|1
operator|)
return|;
block|}
if|if
condition|(
name|isonlydigits
argument_list|(
name|date
argument_list|,
literal|1
argument_list|)
condition|)
block|{
comment|/* Assume month number only */
operator|*
name|flags
operator||=
name|F_MONTH
expr_stmt|;
operator|*
name|imonth
operator|=
operator|(
name|int
operator|)
name|strtol
argument_list|(
name|date
argument_list|,
operator|(
name|char
operator|*
operator|*
operator|)
name|NULL
argument_list|,
literal|10
argument_list|)
expr_stmt|;
name|strcpy
argument_list|(
name|month
argument_list|,
name|getmonthname
argument_list|(
operator|*
name|imonth
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|(
literal|1
operator|)
return|;
block|}
return|return
operator|(
literal|0
operator|)
return|;
block|}
block|}
comment|/* 	 * After this, leave by goto-ing to "allfine" or "fail" to restore the 	 * original data in `date'. 	 */
name|pold
operator|=
operator|*
name|p
expr_stmt|;
operator|*
name|p
operator|=
literal|0
expr_stmt|;
name|p1
operator|=
name|date
expr_stmt|;
name|p2
operator|=
name|p
operator|+
literal|1
expr_stmt|;
comment|/* Now p2 points to the next field and p1 to the first field */
if|if
condition|(
operator|(
name|py
operator|=
name|strchr
argument_list|(
name|p2
argument_list|,
literal|'/'
argument_list|)
operator|)
operator|!=
name|NULL
condition|)
block|{
comment|/* We have a year in the string. Now this is getting tricky */
name|strcpy
argument_list|(
name|year
argument_list|,
name|p1
argument_list|)
expr_stmt|;
operator|*
name|iyear
operator|=
operator|(
name|int
operator|)
name|strtol
argument_list|(
name|year
argument_list|,
name|NULL
argument_list|,
literal|10
argument_list|)
expr_stmt|;
name|p1
operator|=
name|p2
expr_stmt|;
name|p2
operator|=
name|py
operator|+
literal|1
expr_stmt|;
operator|*
name|py
operator|=
literal|0
expr_stmt|;
operator|*
name|flags
operator||=
name|F_YEAR
expr_stmt|;
block|}
comment|/* Check if there is a month-string in the date */
if|if
condition|(
operator|(
name|checkmonth
argument_list|(
name|p1
argument_list|,
operator|&
name|len
argument_list|,
operator|&
name|offset
argument_list|,
operator|&
name|pmonth
argument_list|)
operator|!=
literal|0
operator|)
operator|||
operator|(
name|checkmonth
argument_list|(
name|p2
argument_list|,
operator|&
name|len
argument_list|,
operator|&
name|offset
argument_list|,
operator|&
name|pmonth
argument_list|)
operator|!=
literal|0
operator|&&
operator|(
name|p2
operator|=
name|p1
operator|)
operator|)
condition|)
block|{
comment|/* p2 is the non-month part */
operator|*
name|flags
operator||=
name|F_MONTH
expr_stmt|;
operator|*
name|imonth
operator|=
name|offset
expr_stmt|;
name|strcpy
argument_list|(
name|month
argument_list|,
name|getmonthname
argument_list|(
name|offset
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|isonlydigits
argument_list|(
name|p2
argument_list|,
literal|1
argument_list|)
condition|)
block|{
name|strcpy
argument_list|(
name|dayofmonth
argument_list|,
name|p2
argument_list|)
expr_stmt|;
operator|*
name|idayofmonth
operator|=
operator|(
name|int
operator|)
name|strtol
argument_list|(
name|p2
argument_list|,
operator|(
name|char
operator|*
operator|*
operator|)
name|NULL
argument_list|,
literal|10
argument_list|)
expr_stmt|;
operator|*
name|flags
operator||=
name|F_DAYOFMONTH
expr_stmt|;
goto|goto
name|allfine
goto|;
block|}
if|if
condition|(
name|strcmp
argument_list|(
name|p2
argument_list|,
literal|"*"
argument_list|)
operator|==
literal|0
condition|)
block|{
operator|*
name|flags
operator||=
name|F_ALLDAY
expr_stmt|;
goto|goto
name|allfine
goto|;
block|}
if|if
condition|(
name|checkdayofweek
argument_list|(
name|p2
argument_list|,
operator|&
name|len
argument_list|,
operator|&
name|offset
argument_list|,
operator|&
name|dow
argument_list|)
operator|!=
literal|0
condition|)
block|{
operator|*
name|flags
operator||=
name|F_DAYOFWEEK
expr_stmt|;
operator|*
name|flags
operator||=
name|F_VARIABLE
expr_stmt|;
operator|*
name|idayofweek
operator|=
name|offset
expr_stmt|;
name|strcpy
argument_list|(
name|dayofweek
argument_list|,
name|getdayofweekname
argument_list|(
name|offset
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|strlen
argument_list|(
name|p2
argument_list|)
operator|==
name|len
condition|)
goto|goto
name|allfine
goto|;
name|strcpy
argument_list|(
name|modifierindex
argument_list|,
name|p2
operator|+
name|len
argument_list|)
expr_stmt|;
operator|*
name|flags
operator||=
name|F_MODIFIERINDEX
expr_stmt|;
goto|goto
name|allfine
goto|;
block|}
goto|goto
name|fail
goto|;
block|}
comment|/* Check if there is an every-day or every-month in the string */
if|if
condition|(
operator|(
name|strcmp
argument_list|(
name|p1
argument_list|,
literal|"*"
argument_list|)
operator|==
literal|0
operator|&&
name|isonlydigits
argument_list|(
name|p2
argument_list|,
literal|1
argument_list|)
operator|)
operator|||
operator|(
name|strcmp
argument_list|(
name|p2
argument_list|,
literal|"*"
argument_list|)
operator|==
literal|0
operator|&&
name|isonlydigits
argument_list|(
name|p1
argument_list|,
literal|1
argument_list|)
operator|&&
operator|(
name|p2
operator|=
name|p1
operator|)
operator|)
condition|)
block|{
name|int
name|d
decl_stmt|;
operator|*
name|flags
operator||=
name|F_ALLMONTH
expr_stmt|;
operator|*
name|flags
operator||=
name|F_DAYOFMONTH
expr_stmt|;
name|d
operator|=
operator|(
name|int
operator|)
name|strtol
argument_list|(
name|p2
argument_list|,
operator|(
name|char
operator|*
operator|*
operator|)
name|NULL
argument_list|,
literal|10
argument_list|)
expr_stmt|;
operator|*
name|idayofmonth
operator|=
name|d
expr_stmt|;
name|sprintf
argument_list|(
name|dayofmonth
argument_list|,
literal|"%d"
argument_list|,
name|d
argument_list|)
expr_stmt|;
goto|goto
name|allfine
goto|;
block|}
comment|/* Month as a number, then a weekday */
if|if
condition|(
name|isonlydigits
argument_list|(
name|p1
argument_list|,
literal|1
argument_list|)
operator|&&
name|checkdayofweek
argument_list|(
name|p2
argument_list|,
operator|&
name|len
argument_list|,
operator|&
name|offset
argument_list|,
operator|&
name|dow
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|int
name|d
decl_stmt|;
operator|*
name|flags
operator||=
name|F_MONTH
expr_stmt|;
operator|*
name|flags
operator||=
name|F_DAYOFWEEK
expr_stmt|;
operator|*
name|flags
operator||=
name|F_VARIABLE
expr_stmt|;
operator|*
name|idayofweek
operator|=
name|offset
expr_stmt|;
name|d
operator|=
operator|(
name|int
operator|)
name|strtol
argument_list|(
name|p1
argument_list|,
operator|(
name|char
operator|*
operator|*
operator|)
name|NULL
argument_list|,
literal|10
argument_list|)
expr_stmt|;
operator|*
name|imonth
operator|=
name|d
expr_stmt|;
name|strcpy
argument_list|(
name|month
argument_list|,
name|getmonthname
argument_list|(
name|d
argument_list|)
argument_list|)
expr_stmt|;
name|strcpy
argument_list|(
name|dayofweek
argument_list|,
name|getdayofweekname
argument_list|(
name|offset
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|strlen
argument_list|(
name|p2
argument_list|)
operator|==
name|len
condition|)
goto|goto
name|allfine
goto|;
name|strcpy
argument_list|(
name|modifierindex
argument_list|,
name|p2
operator|+
name|len
argument_list|)
expr_stmt|;
operator|*
name|flags
operator||=
name|F_MODIFIERINDEX
expr_stmt|;
goto|goto
name|allfine
goto|;
block|}
comment|/* If both the month and date are specified as numbers */
if|if
condition|(
name|isonlydigits
argument_list|(
name|p1
argument_list|,
literal|1
argument_list|)
operator|&&
name|isonlydigits
argument_list|(
name|p2
argument_list|,
literal|0
argument_list|)
condition|)
block|{
comment|/* Now who wants to be this ambigious? :-( */
name|int
name|m
decl_stmt|,
name|d
decl_stmt|;
if|if
condition|(
name|strchr
argument_list|(
name|p2
argument_list|,
literal|'*'
argument_list|)
operator|!=
name|NULL
condition|)
operator|*
name|flags
operator||=
name|F_VARIABLE
expr_stmt|;
name|m
operator|=
operator|(
name|int
operator|)
name|strtol
argument_list|(
name|p1
argument_list|,
operator|(
name|char
operator|*
operator|*
operator|)
name|NULL
argument_list|,
literal|10
argument_list|)
expr_stmt|;
name|d
operator|=
operator|(
name|int
operator|)
name|strtol
argument_list|(
name|p2
argument_list|,
operator|(
name|char
operator|*
operator|*
operator|)
name|NULL
argument_list|,
literal|10
argument_list|)
expr_stmt|;
operator|*
name|flags
operator||=
name|F_MONTH
expr_stmt|;
operator|*
name|flags
operator||=
name|F_DAYOFMONTH
expr_stmt|;
if|if
condition|(
name|m
operator|>
literal|12
condition|)
block|{
operator|*
name|imonth
operator|=
name|d
expr_stmt|;
operator|*
name|idayofmonth
operator|=
name|m
expr_stmt|;
name|strcpy
argument_list|(
name|month
argument_list|,
name|getmonthname
argument_list|(
name|d
argument_list|)
argument_list|)
expr_stmt|;
name|sprintf
argument_list|(
name|dayofmonth
argument_list|,
literal|"%d"
argument_list|,
name|m
argument_list|)
expr_stmt|;
block|}
else|else
block|{
operator|*
name|imonth
operator|=
name|m
expr_stmt|;
operator|*
name|idayofmonth
operator|=
name|d
expr_stmt|;
name|strcpy
argument_list|(
name|month
argument_list|,
name|getmonthname
argument_list|(
name|m
argument_list|)
argument_list|)
expr_stmt|;
name|sprintf
argument_list|(
name|dayofmonth
argument_list|,
literal|"%d"
argument_list|,
name|d
argument_list|)
expr_stmt|;
block|}
goto|goto
name|allfine
goto|;
block|}
comment|/* FALLTHROUGH */
name|fail
label|:
operator|*
name|p
operator|=
name|pold
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
name|allfine
label|:
operator|*
name|p
operator|=
name|pold
expr_stmt|;
return|return
operator|(
literal|1
operator|)
return|;
block|}
end_function

begin_function_decl
name|void
name|remember
parameter_list|(
name|int
modifier|*
name|rememberindex
parameter_list|,
name|int
modifier|*
name|y
parameter_list|,
name|int
modifier|*
name|m
parameter_list|,
name|int
modifier|*
name|d
parameter_list|,
name|char
modifier|*
modifier|*
name|ed
parameter_list|,
name|int
name|yy
parameter_list|,
name|int
name|mm
parameter_list|,
name|int
name|dd
parameter_list|,
name|char
modifier|*
name|extra
parameter_list|)
function_decl|;
end_function_decl

begin_function
name|void
name|remember
parameter_list|(
name|int
modifier|*
name|rememberindex
parameter_list|,
name|int
modifier|*
name|y
parameter_list|,
name|int
modifier|*
name|m
parameter_list|,
name|int
modifier|*
name|d
parameter_list|,
name|char
modifier|*
modifier|*
name|ed
parameter_list|,
name|int
name|yy
parameter_list|,
name|int
name|mm
parameter_list|,
name|int
name|dd
parameter_list|,
name|char
modifier|*
name|extra
parameter_list|)
block|{
specifier|static
name|int
name|warned
init|=
literal|0
decl_stmt|;
if|if
condition|(
operator|*
name|rememberindex
operator|>=
name|MAXCOUNT
operator|-
literal|1
condition|)
block|{
if|if
condition|(
name|warned
operator|==
literal|0
condition|)
name|warnx
argument_list|(
literal|"Index> %d, ignored"
argument_list|,
name|MAXCOUNT
argument_list|)
expr_stmt|;
name|warned
operator|++
expr_stmt|;
return|return;
block|}
name|y
index|[
operator|*
name|rememberindex
index|]
operator|=
name|yy
expr_stmt|;
name|m
index|[
operator|*
name|rememberindex
index|]
operator|=
name|mm
expr_stmt|;
name|d
index|[
operator|*
name|rememberindex
index|]
operator|=
name|dd
expr_stmt|;
if|if
condition|(
name|extra
operator|!=
name|NULL
condition|)
name|strcpy
argument_list|(
name|ed
index|[
operator|*
name|rememberindex
index|]
argument_list|,
name|extra
argument_list|)
expr_stmt|;
else|else
name|ed
index|[
operator|*
name|rememberindex
index|]
index|[
literal|0
index|]
operator|=
literal|'\0'
expr_stmt|;
operator|*
name|rememberindex
operator|+=
literal|1
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|debug_determinestyle
parameter_list|(
name|int
name|dateonly
parameter_list|,
name|char
modifier|*
name|date
parameter_list|,
name|int
name|flags
parameter_list|,
name|char
modifier|*
name|month
parameter_list|,
name|int
name|imonth
parameter_list|,
name|char
modifier|*
name|dayofmonth
parameter_list|,
name|int
name|idayofmonth
parameter_list|,
name|char
modifier|*
name|dayofweek
parameter_list|,
name|int
name|idayofweek
parameter_list|,
name|char
modifier|*
name|modifieroffset
parameter_list|,
name|char
modifier|*
name|modifierindex
parameter_list|,
name|char
modifier|*
name|specialday
parameter_list|,
name|char
modifier|*
name|year
parameter_list|,
name|int
name|iyear
parameter_list|)
block|{
if|if
condition|(
name|dateonly
operator|!=
literal|0
condition|)
block|{
name|printf
argument_list|(
literal|"-------\ndate: |%s|\n"
argument_list|,
name|date
argument_list|)
expr_stmt|;
if|if
condition|(
name|dateonly
operator|==
literal|1
condition|)
return|return;
block|}
name|printf
argument_list|(
literal|"flags: %x - %s\n"
argument_list|,
name|flags
argument_list|,
name|showflags
argument_list|(
name|flags
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|modifieroffset
index|[
literal|0
index|]
operator|!=
literal|'\0'
condition|)
name|printf
argument_list|(
literal|"modifieroffset: |%s|\n"
argument_list|,
name|modifieroffset
argument_list|)
expr_stmt|;
if|if
condition|(
name|modifierindex
index|[
literal|0
index|]
operator|!=
literal|'\0'
condition|)
name|printf
argument_list|(
literal|"modifierindex: |%s|\n"
argument_list|,
name|modifierindex
argument_list|)
expr_stmt|;
if|if
condition|(
name|year
index|[
literal|0
index|]
operator|!=
literal|'\0'
condition|)
name|printf
argument_list|(
literal|"year: |%s| (%d)\n"
argument_list|,
name|year
argument_list|,
name|iyear
argument_list|)
expr_stmt|;
if|if
condition|(
name|month
index|[
literal|0
index|]
operator|!=
literal|'\0'
condition|)
name|printf
argument_list|(
literal|"month: |%s| (%d)\n"
argument_list|,
name|month
argument_list|,
name|imonth
argument_list|)
expr_stmt|;
if|if
condition|(
name|dayofmonth
index|[
literal|0
index|]
operator|!=
literal|'\0'
condition|)
name|printf
argument_list|(
literal|"dayofmonth: |%s| (%d)\n"
argument_list|,
name|dayofmonth
argument_list|,
name|idayofmonth
argument_list|)
expr_stmt|;
if|if
condition|(
name|dayofweek
index|[
literal|0
index|]
operator|!=
literal|'\0'
condition|)
name|printf
argument_list|(
literal|"dayofweek: |%s| (%d)\n"
argument_list|,
name|dayofweek
argument_list|,
name|idayofweek
argument_list|)
expr_stmt|;
if|if
condition|(
name|specialday
index|[
literal|0
index|]
operator|!=
literal|'\0'
condition|)
name|printf
argument_list|(
literal|"specialday: |%s|\n"
argument_list|,
name|specialday
argument_list|)
expr_stmt|;
block|}
end_function

begin_struct
specifier|static
struct|struct
name|yearinfo
block|{
name|int
name|year
decl_stmt|;
name|int
name|ieaster
decl_stmt|,
name|ipaskha
decl_stmt|,
name|firstcnyday
decl_stmt|;
name|double
name|ffullmoon
index|[
name|MAXMOONS
index|]
decl_stmt|,
name|fnewmoon
index|[
name|MAXMOONS
index|]
decl_stmt|;
name|double
name|ffullmooncny
index|[
name|MAXMOONS
index|]
decl_stmt|,
name|fnewmooncny
index|[
name|MAXMOONS
index|]
decl_stmt|;
name|int
name|ichinesemonths
index|[
name|MAXMOONS
index|]
decl_stmt|;
name|double
name|equinoxdays
index|[
literal|2
index|]
decl_stmt|,
name|solsticedays
index|[
literal|2
index|]
decl_stmt|;
name|int
modifier|*
name|monthdays
decl_stmt|;
name|struct
name|yearinfo
modifier|*
name|next
decl_stmt|;
block|}
modifier|*
name|years
struct|,
modifier|*
name|yearinfo
struct|;
end_struct

begin_comment
comment|/*  * Calculate dates with offset from weekdays, like Thurs-3, Wed+2, etc.  * day is the day of the week,  * offset the ordinal number of the weekday in the month.  */
end_comment

begin_function
specifier|static
name|int
name|wdayom
parameter_list|(
name|int
name|day
parameter_list|,
name|int
name|offset
parameter_list|,
name|int
name|month
parameter_list|,
name|int
name|year
parameter_list|)
block|{
comment|/* Weekday of first day in month */
name|int
name|wday1
decl_stmt|;
comment|/* first day of month */
comment|/* Weekday of last day in month */
name|int
name|wdayn
decl_stmt|;
name|int
name|d
decl_stmt|;
name|wday1
operator|=
name|first_dayofweek_of_month
argument_list|(
name|year
argument_list|,
name|month
argument_list|)
expr_stmt|;
if|if
condition|(
name|wday1
operator|<
literal|0
condition|)
comment|/* not set */
return|return
operator|(
name|wday1
operator|)
return|;
comment|/* 	 * Date of zeroth or first of our weekday in month, depending on the 	 * relationship with the first of the month.  The range is -6:6. 	 */
name|d
operator|=
operator|(
name|day
operator|-
name|wday1
operator|+
literal|1
operator|)
operator|%
literal|7
expr_stmt|;
comment|/* 	 * Which way are we counting?  Offset 0 is invalid, abs (offset)> 5 is 	 * meaningless, but that's OK.  Offset 5 may or may not be meaningless, 	 * so there's no point in complaining for complaining's sake. 	 */
if|if
condition|(
name|offset
operator|<
literal|0
condition|)
block|{
comment|/* back from end of month */
comment|/* FIXME */
name|wdayn
operator|=
name|d
expr_stmt|;
while|while
condition|(
name|wdayn
operator|<=
name|yearinfo
operator|->
name|monthdays
index|[
name|month
index|]
condition|)
name|wdayn
operator|+=
literal|7
expr_stmt|;
name|d
operator|=
name|offset
operator|*
literal|7
operator|+
name|wdayn
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|offset
operator|>
literal|0
condition|)
block|{
if|if
condition|(
name|d
operator|>
literal|0
condition|)
name|d
operator|+=
name|offset
operator|*
literal|7
operator|-
literal|7
expr_stmt|;
else|else
name|d
operator|+=
name|offset
operator|*
literal|7
expr_stmt|;
block|}
else|else
name|warnx
argument_list|(
literal|"Invalid offset 0"
argument_list|)
expr_stmt|;
return|return
operator|(
name|d
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Possible date formats include any combination of:  *	3-charmonth			(January, Jan, Jan)  *	3-charweekday			(Friday, Monday, mon.)  *	numeric month or day		(1, 2, 04)  *  * Any character may separate them, or they may not be separated.  Any line,  * following a line that is matched, that starts with "whitespace", is shown  * along with the matched line.  */
end_comment

begin_function
name|int
name|parsedaymonth
parameter_list|(
name|char
modifier|*
name|date
parameter_list|,
name|int
modifier|*
name|yearp
parameter_list|,
name|int
modifier|*
name|monthp
parameter_list|,
name|int
modifier|*
name|dayp
parameter_list|,
name|int
modifier|*
name|flags
parameter_list|,
name|char
modifier|*
modifier|*
name|edp
parameter_list|)
block|{
name|char
name|month
index|[
literal|100
index|]
decl_stmt|,
name|dayofmonth
index|[
literal|100
index|]
decl_stmt|,
name|dayofweek
index|[
literal|100
index|]
decl_stmt|,
name|modifieroffset
index|[
literal|100
index|]
decl_stmt|;
name|char
name|syear
index|[
literal|100
index|]
decl_stmt|;
name|char
name|modifierindex
index|[
literal|100
index|]
decl_stmt|,
name|specialday
index|[
literal|100
index|]
decl_stmt|;
name|int
name|idayofweek
init|=
operator|-
literal|1
decl_stmt|,
name|imonth
init|=
operator|-
literal|1
decl_stmt|,
name|idayofmonth
init|=
operator|-
literal|1
decl_stmt|,
name|iyear
init|=
operator|-
literal|1
decl_stmt|;
name|int
name|year
decl_stmt|,
name|remindex
decl_stmt|;
name|int
name|d
decl_stmt|,
name|m
decl_stmt|,
name|dow
decl_stmt|,
name|rm
decl_stmt|,
name|rd
decl_stmt|,
name|offset
decl_stmt|;
name|char
modifier|*
name|ed
decl_stmt|;
name|int
name|retvalsign
init|=
literal|1
decl_stmt|;
comment|/* 	 * CONVENTION 	 * 	 * Month:     1-12 	 * Monthname: Jan .. Dec 	 * Day:	      1-31 	 * Weekday:   Mon .. Sun 	 * 	 */
operator|*
name|flags
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|debug
condition|)
name|debug_determinestyle
argument_list|(
literal|1
argument_list|,
name|date
argument_list|,
operator|*
name|flags
argument_list|,
name|month
argument_list|,
name|imonth
argument_list|,
name|dayofmonth
argument_list|,
name|idayofmonth
argument_list|,
name|dayofweek
argument_list|,
name|idayofweek
argument_list|,
name|modifieroffset
argument_list|,
name|modifierindex
argument_list|,
name|specialday
argument_list|,
name|syear
argument_list|,
name|iyear
argument_list|)
expr_stmt|;
if|if
condition|(
name|determinestyle
argument_list|(
name|date
argument_list|,
name|flags
argument_list|,
name|month
argument_list|,
operator|&
name|imonth
argument_list|,
name|dayofmonth
argument_list|,
operator|&
name|idayofmonth
argument_list|,
name|dayofweek
argument_list|,
operator|&
name|idayofweek
argument_list|,
name|modifieroffset
argument_list|,
name|modifierindex
argument_list|,
name|specialday
argument_list|,
name|syear
argument_list|,
operator|&
name|iyear
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|debug
condition|)
name|printf
argument_list|(
literal|"Failed!\n"
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
if|if
condition|(
name|debug
condition|)
name|debug_determinestyle
argument_list|(
literal|0
argument_list|,
name|date
argument_list|,
operator|*
name|flags
argument_list|,
name|month
argument_list|,
name|imonth
argument_list|,
name|dayofmonth
argument_list|,
name|idayofmonth
argument_list|,
name|dayofweek
argument_list|,
name|idayofweek
argument_list|,
name|modifieroffset
argument_list|,
name|modifierindex
argument_list|,
name|specialday
argument_list|,
name|syear
argument_list|,
name|iyear
argument_list|)
expr_stmt|;
name|remindex
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|year
operator|=
name|year1
init|;
name|year
operator|<=
name|year2
condition|;
name|year
operator|++
control|)
block|{
name|int
name|lflags
init|=
operator|*
name|flags
decl_stmt|;
comment|/* If the year is specified, only do it if it is this year! */
if|if
condition|(
operator|(
name|lflags
operator|&
name|F_YEAR
operator|)
operator|!=
literal|0
condition|)
if|if
condition|(
name|iyear
operator|!=
name|year
condition|)
continue|continue;
name|lflags
operator|&=
operator|~
name|F_YEAR
expr_stmt|;
comment|/* Get important dates for this year */
name|yearinfo
operator|=
name|years
expr_stmt|;
while|while
condition|(
name|yearinfo
operator|!=
name|NULL
condition|)
block|{
if|if
condition|(
name|yearinfo
operator|->
name|year
operator|==
name|year
condition|)
break|break;
name|yearinfo
operator|=
name|yearinfo
operator|->
name|next
expr_stmt|;
block|}
if|if
condition|(
name|yearinfo
operator|==
name|NULL
condition|)
block|{
name|yearinfo
operator|=
operator|(
expr|struct
name|yearinfo
operator|*
operator|)
name|calloc
argument_list|(
literal|1
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|yearinfo
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|yearinfo
operator|==
name|NULL
condition|)
name|errx
argument_list|(
literal|1
argument_list|,
literal|"Unable to allocate more years"
argument_list|)
expr_stmt|;
name|yearinfo
operator|->
name|year
operator|=
name|year
expr_stmt|;
name|yearinfo
operator|->
name|next
operator|=
name|years
expr_stmt|;
name|years
operator|=
name|yearinfo
expr_stmt|;
name|yearinfo
operator|->
name|monthdays
operator|=
name|monthdaytab
index|[
name|isleap
argument_list|(
name|year
argument_list|)
index|]
expr_stmt|;
name|yearinfo
operator|->
name|ieaster
operator|=
name|easter
argument_list|(
name|year
argument_list|)
expr_stmt|;
name|yearinfo
operator|->
name|ipaskha
operator|=
name|paskha
argument_list|(
name|year
argument_list|)
expr_stmt|;
name|fpom
argument_list|(
name|year
argument_list|,
name|UTCOffset
argument_list|,
name|yearinfo
operator|->
name|ffullmoon
argument_list|,
name|yearinfo
operator|->
name|fnewmoon
argument_list|)
expr_stmt|;
name|fpom
argument_list|(
name|year
argument_list|,
name|UTCOFFSET_CNY
argument_list|,
name|yearinfo
operator|->
name|ffullmooncny
argument_list|,
name|yearinfo
operator|->
name|fnewmooncny
argument_list|)
expr_stmt|;
name|fequinoxsolstice
argument_list|(
name|year
argument_list|,
name|UTCOffset
argument_list|,
name|yearinfo
operator|->
name|equinoxdays
argument_list|,
name|yearinfo
operator|->
name|solsticedays
argument_list|)
expr_stmt|;
comment|/* 			 * CNY: Match day with sun longitude at 330` with new 			 * moon 			 */
name|yearinfo
operator|->
name|firstcnyday
operator|=
name|calculatesunlongitude30
argument_list|(
name|year
argument_list|,
name|UTCOFFSET_CNY
argument_list|,
name|yearinfo
operator|->
name|ichinesemonths
argument_list|)
expr_stmt|;
for|for
control|(
name|m
operator|=
literal|0
init|;
name|yearinfo
operator|->
name|fnewmooncny
index|[
name|m
index|]
operator|>=
literal|0
condition|;
name|m
operator|++
control|)
block|{
if|if
condition|(
name|yearinfo
operator|->
name|fnewmooncny
index|[
name|m
index|]
operator|>
name|yearinfo
operator|->
name|firstcnyday
condition|)
block|{
name|yearinfo
operator|->
name|firstcnyday
operator|=
name|floor
argument_list|(
name|yearinfo
operator|->
name|fnewmooncny
index|[
name|m
operator|-
literal|1
index|]
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
block|}
comment|/* Same day every year */
if|if
condition|(
name|lflags
operator|==
operator|(
name|F_MONTH
operator||
name|F_DAYOFMONTH
operator|)
condition|)
block|{
if|if
condition|(
operator|!
name|remember_ymd
argument_list|(
name|year
argument_list|,
name|imonth
argument_list|,
name|idayofmonth
argument_list|)
condition|)
continue|continue;
name|remember
argument_list|(
operator|&
name|remindex
argument_list|,
name|yearp
argument_list|,
name|monthp
argument_list|,
name|dayp
argument_list|,
name|edp
argument_list|,
name|year
argument_list|,
name|imonth
argument_list|,
name|idayofmonth
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
continue|continue;
block|}
comment|/* XXX Same day every year, but variable */
if|if
condition|(
name|lflags
operator|==
operator|(
name|F_MONTH
operator||
name|F_DAYOFMONTH
operator||
name|F_VARIABLE
operator|)
condition|)
block|{
if|if
condition|(
operator|!
name|remember_ymd
argument_list|(
name|year
argument_list|,
name|imonth
argument_list|,
name|idayofmonth
argument_list|)
condition|)
continue|continue;
name|remember
argument_list|(
operator|&
name|remindex
argument_list|,
name|yearp
argument_list|,
name|monthp
argument_list|,
name|dayp
argument_list|,
name|edp
argument_list|,
name|year
argument_list|,
name|imonth
argument_list|,
name|idayofmonth
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
continue|continue;
block|}
comment|/* Same day every month */
if|if
condition|(
name|lflags
operator|==
operator|(
name|F_ALLMONTH
operator||
name|F_DAYOFMONTH
operator|)
condition|)
block|{
for|for
control|(
name|m
operator|=
literal|1
init|;
name|m
operator|<=
literal|12
condition|;
name|m
operator|++
control|)
block|{
if|if
condition|(
operator|!
name|remember_ymd
argument_list|(
name|year
argument_list|,
name|m
argument_list|,
name|idayofmonth
argument_list|)
condition|)
continue|continue;
name|remember
argument_list|(
operator|&
name|remindex
argument_list|,
name|yearp
argument_list|,
name|monthp
argument_list|,
name|dayp
argument_list|,
name|edp
argument_list|,
name|year
argument_list|,
name|m
argument_list|,
name|idayofmonth
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
block|}
continue|continue;
block|}
comment|/* Every day of a month */
if|if
condition|(
name|lflags
operator|==
operator|(
name|F_ALLDAY
operator||
name|F_MONTH
operator|)
condition|)
block|{
for|for
control|(
name|d
operator|=
literal|1
init|;
name|d
operator|<=
name|yearinfo
operator|->
name|monthdays
index|[
name|imonth
index|]
condition|;
name|d
operator|++
control|)
block|{
if|if
condition|(
operator|!
name|remember_ymd
argument_list|(
name|year
argument_list|,
name|imonth
argument_list|,
name|d
argument_list|)
condition|)
continue|continue;
name|remember
argument_list|(
operator|&
name|remindex
argument_list|,
name|yearp
argument_list|,
name|monthp
argument_list|,
name|dayp
argument_list|,
name|edp
argument_list|,
name|year
argument_list|,
name|imonth
argument_list|,
name|d
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
block|}
continue|continue;
block|}
comment|/* One day of every month */
if|if
condition|(
name|lflags
operator|==
operator|(
name|F_ALLMONTH
operator||
name|F_DAYOFWEEK
operator|)
condition|)
block|{
for|for
control|(
name|m
operator|=
literal|1
init|;
name|m
operator|<=
literal|12
condition|;
name|m
operator|++
control|)
block|{
if|if
condition|(
operator|!
name|remember_ymd
argument_list|(
name|year
argument_list|,
name|m
argument_list|,
name|idayofmonth
argument_list|)
condition|)
continue|continue;
name|remember
argument_list|(
operator|&
name|remindex
argument_list|,
name|yearp
argument_list|,
name|monthp
argument_list|,
name|dayp
argument_list|,
name|edp
argument_list|,
name|year
argument_list|,
name|m
argument_list|,
name|idayofmonth
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
block|}
continue|continue;
block|}
comment|/* Every dayofweek of the year */
if|if
condition|(
name|lflags
operator|==
operator|(
name|F_DAYOFWEEK
operator||
name|F_VARIABLE
operator|)
condition|)
block|{
name|dow
operator|=
name|first_dayofweek_of_year
argument_list|(
name|year
argument_list|)
expr_stmt|;
name|d
operator|=
operator|(
name|idayofweek
operator|-
name|dow
operator|+
literal|8
operator|)
operator|%
literal|7
expr_stmt|;
while|while
condition|(
name|d
operator|<=
literal|366
condition|)
block|{
if|if
condition|(
name|remember_yd
argument_list|(
name|year
argument_list|,
name|d
argument_list|,
operator|&
name|rm
argument_list|,
operator|&
name|rd
argument_list|)
condition|)
name|remember
argument_list|(
operator|&
name|remindex
argument_list|,
name|yearp
argument_list|,
name|monthp
argument_list|,
name|dayp
argument_list|,
name|edp
argument_list|,
name|year
argument_list|,
name|rm
argument_list|,
name|rd
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|d
operator|+=
literal|7
expr_stmt|;
block|}
continue|continue;
block|}
comment|/* 	         * Every so-manied dayofweek of every month of the year: 	         * Thu-3 	         */
if|if
condition|(
name|lflags
operator|==
operator|(
name|F_DAYOFWEEK
operator||
name|F_MODIFIERINDEX
operator||
name|F_VARIABLE
operator|)
condition|)
block|{
name|offset
operator|=
name|indextooffset
argument_list|(
name|modifierindex
argument_list|)
expr_stmt|;
for|for
control|(
name|m
operator|=
literal|0
init|;
name|m
operator|<=
literal|12
condition|;
name|m
operator|++
control|)
block|{
name|d
operator|=
name|wdayom
argument_list|(
name|idayofweek
argument_list|,
name|offset
argument_list|,
name|m
argument_list|,
name|year
argument_list|)
expr_stmt|;
if|if
condition|(
name|remember_ymd
argument_list|(
name|year
argument_list|,
name|m
argument_list|,
name|d
argument_list|)
condition|)
block|{
name|remember
argument_list|(
operator|&
name|remindex
argument_list|,
name|yearp
argument_list|,
name|monthp
argument_list|,
name|dayp
argument_list|,
name|edp
argument_list|,
name|year
argument_list|,
name|m
argument_list|,
name|d
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
continue|continue;
block|}
block|}
continue|continue;
block|}
comment|/* 	         * A certain dayofweek of a month 	         * Jan/Thu-3 	         */
if|if
condition|(
name|lflags
operator|==
operator|(
name|F_MONTH
operator||
name|F_DAYOFWEEK
operator||
name|F_MODIFIERINDEX
operator||
name|F_VARIABLE
operator|)
condition|)
block|{
name|offset
operator|=
name|indextooffset
argument_list|(
name|modifierindex
argument_list|)
expr_stmt|;
name|dow
operator|=
name|first_dayofweek_of_month
argument_list|(
name|year
argument_list|,
name|imonth
argument_list|)
expr_stmt|;
name|d
operator|=
operator|(
name|idayofweek
operator|-
name|dow
operator|+
literal|8
operator|)
operator|%
literal|7
expr_stmt|;
if|if
condition|(
name|offset
operator|>
literal|0
condition|)
block|{
while|while
condition|(
name|d
operator|<=
name|yearinfo
operator|->
name|monthdays
index|[
name|imonth
index|]
condition|)
block|{
if|if
condition|(
operator|--
name|offset
operator|==
literal|0
operator|&&
name|remember_ymd
argument_list|(
name|year
argument_list|,
name|imonth
argument_list|,
name|d
argument_list|)
condition|)
block|{
name|remember
argument_list|(
operator|&
name|remindex
argument_list|,
name|yearp
argument_list|,
name|monthp
argument_list|,
name|dayp
argument_list|,
name|edp
argument_list|,
name|year
argument_list|,
name|imonth
argument_list|,
name|d
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
continue|continue;
block|}
name|d
operator|+=
literal|7
expr_stmt|;
block|}
continue|continue;
block|}
if|if
condition|(
name|offset
operator|<
literal|0
condition|)
block|{
while|while
condition|(
name|d
operator|<=
name|yearinfo
operator|->
name|monthdays
index|[
name|imonth
index|]
condition|)
name|d
operator|+=
literal|7
expr_stmt|;
while|while
condition|(
name|offset
operator|!=
literal|0
condition|)
block|{
name|offset
operator|++
expr_stmt|;
name|d
operator|-=
literal|7
expr_stmt|;
block|}
if|if
condition|(
name|remember_ymd
argument_list|(
name|year
argument_list|,
name|imonth
argument_list|,
name|d
argument_list|)
condition|)
name|remember
argument_list|(
operator|&
name|remindex
argument_list|,
name|yearp
argument_list|,
name|monthp
argument_list|,
name|dayp
argument_list|,
name|edp
argument_list|,
name|year
argument_list|,
name|imonth
argument_list|,
name|d
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
continue|continue;
block|}
continue|continue;
block|}
comment|/* Every dayofweek of the month */
if|if
condition|(
name|lflags
operator|==
operator|(
name|F_DAYOFWEEK
operator||
name|F_MONTH
operator||
name|F_VARIABLE
operator|)
condition|)
block|{
name|dow
operator|=
name|first_dayofweek_of_month
argument_list|(
name|year
argument_list|,
name|imonth
argument_list|)
expr_stmt|;
name|d
operator|=
operator|(
name|idayofweek
operator|-
name|dow
operator|+
literal|8
operator|)
operator|%
literal|7
expr_stmt|;
while|while
condition|(
name|d
operator|<=
name|yearinfo
operator|->
name|monthdays
index|[
name|imonth
index|]
condition|)
block|{
if|if
condition|(
name|remember_ymd
argument_list|(
name|year
argument_list|,
name|imonth
argument_list|,
name|d
argument_list|)
condition|)
name|remember
argument_list|(
operator|&
name|remindex
argument_list|,
name|yearp
argument_list|,
name|monthp
argument_list|,
name|dayp
argument_list|,
name|edp
argument_list|,
name|year
argument_list|,
name|imonth
argument_list|,
name|d
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|d
operator|+=
literal|7
expr_stmt|;
block|}
continue|continue;
block|}
comment|/* Easter */
if|if
condition|(
operator|(
name|lflags
operator|&
operator|~
name|F_MODIFIEROFFSET
operator|)
operator|==
operator|(
name|F_SPECIALDAY
operator||
name|F_VARIABLE
operator||
name|F_EASTER
operator|)
condition|)
block|{
name|offset
operator|=
literal|0
expr_stmt|;
if|if
condition|(
operator|(
name|lflags
operator|&
name|F_MODIFIEROFFSET
operator|)
operator|!=
literal|0
condition|)
name|offset
operator|=
name|parseoffset
argument_list|(
name|modifieroffset
argument_list|)
expr_stmt|;
if|if
condition|(
name|remember_yd
argument_list|(
name|year
argument_list|,
name|yearinfo
operator|->
name|ieaster
operator|+
name|offset
argument_list|,
operator|&
name|rm
argument_list|,
operator|&
name|rd
argument_list|)
condition|)
name|remember
argument_list|(
operator|&
name|remindex
argument_list|,
name|yearp
argument_list|,
name|monthp
argument_list|,
name|dayp
argument_list|,
name|edp
argument_list|,
name|year
argument_list|,
name|rm
argument_list|,
name|rd
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
continue|continue;
block|}
comment|/* Paskha */
if|if
condition|(
operator|(
name|lflags
operator|&
operator|~
name|F_MODIFIEROFFSET
operator|)
operator|==
operator|(
name|F_SPECIALDAY
operator||
name|F_VARIABLE
operator||
name|F_PASKHA
operator|)
condition|)
block|{
name|offset
operator|=
literal|0
expr_stmt|;
if|if
condition|(
operator|(
name|lflags
operator|&
name|F_MODIFIEROFFSET
operator|)
operator|!=
literal|0
condition|)
name|offset
operator|=
name|parseoffset
argument_list|(
name|modifieroffset
argument_list|)
expr_stmt|;
if|if
condition|(
name|remember_yd
argument_list|(
name|year
argument_list|,
name|yearinfo
operator|->
name|ipaskha
operator|+
name|offset
argument_list|,
operator|&
name|rm
argument_list|,
operator|&
name|rd
argument_list|)
condition|)
name|remember
argument_list|(
operator|&
name|remindex
argument_list|,
name|yearp
argument_list|,
name|monthp
argument_list|,
name|dayp
argument_list|,
name|edp
argument_list|,
name|year
argument_list|,
name|rm
argument_list|,
name|rd
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
continue|continue;
block|}
comment|/* Chinese New Year */
if|if
condition|(
operator|(
name|lflags
operator|&
operator|~
name|F_MODIFIEROFFSET
operator|)
operator|==
operator|(
name|F_SPECIALDAY
operator||
name|F_VARIABLE
operator||
name|F_CNY
operator|)
condition|)
block|{
name|offset
operator|=
literal|0
expr_stmt|;
if|if
condition|(
operator|(
name|lflags
operator|&
name|F_MODIFIEROFFSET
operator|)
operator|!=
literal|0
condition|)
name|offset
operator|=
name|parseoffset
argument_list|(
name|modifieroffset
argument_list|)
expr_stmt|;
if|if
condition|(
name|remember_yd
argument_list|(
name|year
argument_list|,
name|yearinfo
operator|->
name|firstcnyday
operator|+
name|offset
argument_list|,
operator|&
name|rm
argument_list|,
operator|&
name|rd
argument_list|)
condition|)
name|remember
argument_list|(
operator|&
name|remindex
argument_list|,
name|yearp
argument_list|,
name|monthp
argument_list|,
name|dayp
argument_list|,
name|edp
argument_list|,
name|year
argument_list|,
name|rm
argument_list|,
name|rd
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
continue|continue;
block|}
comment|/* FullMoon */
if|if
condition|(
operator|(
name|lflags
operator|&
operator|~
name|F_MODIFIEROFFSET
operator|)
operator|==
operator|(
name|F_SPECIALDAY
operator||
name|F_VARIABLE
operator||
name|F_FULLMOON
operator|)
condition|)
block|{
name|int
name|i
decl_stmt|;
name|offset
operator|=
literal|0
expr_stmt|;
if|if
condition|(
operator|(
name|lflags
operator|&
name|F_MODIFIEROFFSET
operator|)
operator|!=
literal|0
condition|)
name|offset
operator|=
name|parseoffset
argument_list|(
name|modifieroffset
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|yearinfo
operator|->
name|ffullmoon
index|[
name|i
index|]
operator|>
literal|0
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|remember_yd
argument_list|(
name|year
argument_list|,
name|floor
argument_list|(
name|yearinfo
operator|->
name|ffullmoon
index|[
name|i
index|]
argument_list|)
operator|+
name|offset
argument_list|,
operator|&
name|rm
argument_list|,
operator|&
name|rd
argument_list|)
condition|)
block|{
name|ed
operator|=
name|floattotime
argument_list|(
name|yearinfo
operator|->
name|ffullmoon
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|remember
argument_list|(
operator|&
name|remindex
argument_list|,
name|yearp
argument_list|,
name|monthp
argument_list|,
name|dayp
argument_list|,
name|edp
argument_list|,
name|year
argument_list|,
name|rm
argument_list|,
name|rd
argument_list|,
name|ed
argument_list|)
expr_stmt|;
block|}
block|}
continue|continue;
block|}
comment|/* NewMoon */
if|if
condition|(
operator|(
name|lflags
operator|&
operator|~
name|F_MODIFIEROFFSET
operator|)
operator|==
operator|(
name|F_SPECIALDAY
operator||
name|F_VARIABLE
operator||
name|F_NEWMOON
operator|)
condition|)
block|{
name|int
name|i
decl_stmt|;
name|offset
operator|=
literal|0
expr_stmt|;
if|if
condition|(
operator|(
name|lflags
operator|&
name|F_MODIFIEROFFSET
operator|)
operator|!=
literal|0
condition|)
name|offset
operator|=
name|parseoffset
argument_list|(
name|modifieroffset
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|yearinfo
operator|->
name|ffullmoon
index|[
name|i
index|]
operator|>
literal|0
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|remember_yd
argument_list|(
name|year
argument_list|,
name|floor
argument_list|(
name|yearinfo
operator|->
name|fnewmoon
index|[
name|i
index|]
argument_list|)
operator|+
name|offset
argument_list|,
operator|&
name|rm
argument_list|,
operator|&
name|rd
argument_list|)
condition|)
block|{
name|ed
operator|=
name|floattotime
argument_list|(
name|yearinfo
operator|->
name|fnewmoon
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|remember
argument_list|(
operator|&
name|remindex
argument_list|,
name|yearp
argument_list|,
name|monthp
argument_list|,
name|dayp
argument_list|,
name|edp
argument_list|,
name|year
argument_list|,
name|rm
argument_list|,
name|rd
argument_list|,
name|ed
argument_list|)
expr_stmt|;
block|}
block|}
continue|continue;
block|}
comment|/* (Mar|Sep)Equinox */
if|if
condition|(
operator|(
name|lflags
operator|&
operator|~
name|F_MODIFIEROFFSET
operator|)
operator|==
operator|(
name|F_SPECIALDAY
operator||
name|F_VARIABLE
operator||
name|F_MAREQUINOX
operator|)
condition|)
block|{
name|offset
operator|=
literal|0
expr_stmt|;
if|if
condition|(
operator|(
name|lflags
operator|&
name|F_MODIFIEROFFSET
operator|)
operator|!=
literal|0
condition|)
name|offset
operator|=
name|parseoffset
argument_list|(
name|modifieroffset
argument_list|)
expr_stmt|;
if|if
condition|(
name|remember_yd
argument_list|(
name|year
argument_list|,
name|yearinfo
operator|->
name|equinoxdays
index|[
literal|0
index|]
operator|+
name|offset
argument_list|,
operator|&
name|rm
argument_list|,
operator|&
name|rd
argument_list|)
condition|)
block|{
name|ed
operator|=
name|floattotime
argument_list|(
name|yearinfo
operator|->
name|equinoxdays
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
name|remember
argument_list|(
operator|&
name|remindex
argument_list|,
name|yearp
argument_list|,
name|monthp
argument_list|,
name|dayp
argument_list|,
name|edp
argument_list|,
name|year
argument_list|,
name|rm
argument_list|,
name|rd
argument_list|,
name|ed
argument_list|)
expr_stmt|;
block|}
continue|continue;
block|}
if|if
condition|(
operator|(
name|lflags
operator|&
operator|~
name|F_MODIFIEROFFSET
operator|)
operator|==
operator|(
name|F_SPECIALDAY
operator||
name|F_VARIABLE
operator||
name|F_SEPEQUINOX
operator|)
condition|)
block|{
name|offset
operator|=
literal|0
expr_stmt|;
if|if
condition|(
operator|(
name|lflags
operator|&
name|F_MODIFIEROFFSET
operator|)
operator|!=
literal|0
condition|)
name|offset
operator|=
name|parseoffset
argument_list|(
name|modifieroffset
argument_list|)
expr_stmt|;
if|if
condition|(
name|remember_yd
argument_list|(
name|year
argument_list|,
name|yearinfo
operator|->
name|equinoxdays
index|[
literal|1
index|]
operator|+
name|offset
argument_list|,
operator|&
name|rm
argument_list|,
operator|&
name|rd
argument_list|)
condition|)
block|{
name|ed
operator|=
name|floattotime
argument_list|(
name|yearinfo
operator|->
name|equinoxdays
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
name|remember
argument_list|(
operator|&
name|remindex
argument_list|,
name|yearp
argument_list|,
name|monthp
argument_list|,
name|dayp
argument_list|,
name|edp
argument_list|,
name|year
argument_list|,
name|rm
argument_list|,
name|rd
argument_list|,
name|ed
argument_list|)
expr_stmt|;
block|}
continue|continue;
block|}
comment|/* (Jun|Dec)Solstice */
if|if
condition|(
operator|(
name|lflags
operator|&
operator|~
name|F_MODIFIEROFFSET
operator|)
operator|==
operator|(
name|F_SPECIALDAY
operator||
name|F_VARIABLE
operator||
name|F_JUNSOLSTICE
operator|)
condition|)
block|{
name|offset
operator|=
literal|0
expr_stmt|;
if|if
condition|(
operator|(
name|lflags
operator|&
name|F_MODIFIEROFFSET
operator|)
operator|!=
literal|0
condition|)
name|offset
operator|=
name|parseoffset
argument_list|(
name|modifieroffset
argument_list|)
expr_stmt|;
if|if
condition|(
name|remember_yd
argument_list|(
name|year
argument_list|,
name|yearinfo
operator|->
name|solsticedays
index|[
literal|0
index|]
operator|+
name|offset
argument_list|,
operator|&
name|rm
argument_list|,
operator|&
name|rd
argument_list|)
condition|)
block|{
name|ed
operator|=
name|floattotime
argument_list|(
name|yearinfo
operator|->
name|solsticedays
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
name|remember
argument_list|(
operator|&
name|remindex
argument_list|,
name|yearp
argument_list|,
name|monthp
argument_list|,
name|dayp
argument_list|,
name|edp
argument_list|,
name|year
argument_list|,
name|rm
argument_list|,
name|rd
argument_list|,
name|ed
argument_list|)
expr_stmt|;
block|}
continue|continue;
block|}
if|if
condition|(
operator|(
name|lflags
operator|&
operator|~
name|F_MODIFIEROFFSET
operator|)
operator|==
operator|(
name|F_SPECIALDAY
operator||
name|F_VARIABLE
operator||
name|F_DECSOLSTICE
operator|)
condition|)
block|{
name|offset
operator|=
literal|0
expr_stmt|;
if|if
condition|(
operator|(
name|lflags
operator|&
name|F_MODIFIEROFFSET
operator|)
operator|!=
literal|0
condition|)
name|offset
operator|=
name|parseoffset
argument_list|(
name|modifieroffset
argument_list|)
expr_stmt|;
if|if
condition|(
name|remember_yd
argument_list|(
name|year
argument_list|,
name|yearinfo
operator|->
name|solsticedays
index|[
literal|1
index|]
operator|+
name|offset
argument_list|,
operator|&
name|rm
argument_list|,
operator|&
name|rd
argument_list|)
condition|)
block|{
name|ed
operator|=
name|floattotime
argument_list|(
name|yearinfo
operator|->
name|solsticedays
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
name|remember
argument_list|(
operator|&
name|remindex
argument_list|,
name|yearp
argument_list|,
name|monthp
argument_list|,
name|dayp
argument_list|,
name|edp
argument_list|,
name|year
argument_list|,
name|rm
argument_list|,
name|rd
argument_list|,
name|ed
argument_list|)
expr_stmt|;
block|}
continue|continue;
block|}
if|if
condition|(
name|debug
condition|)
block|{
name|printf
argument_list|(
literal|"Unprocessed:\n"
argument_list|)
expr_stmt|;
name|debug_determinestyle
argument_list|(
literal|2
argument_list|,
name|date
argument_list|,
name|lflags
argument_list|,
name|month
argument_list|,
name|imonth
argument_list|,
name|dayofmonth
argument_list|,
name|idayofmonth
argument_list|,
name|dayofweek
argument_list|,
name|idayofweek
argument_list|,
name|modifieroffset
argument_list|,
name|modifierindex
argument_list|,
name|specialday
argument_list|,
name|syear
argument_list|,
name|iyear
argument_list|)
expr_stmt|;
block|}
name|retvalsign
operator|=
operator|-
literal|1
expr_stmt|;
block|}
if|if
condition|(
name|retvalsign
operator|==
operator|-
literal|1
condition|)
return|return
operator|(
operator|-
name|remindex
operator|-
literal|1
operator|)
return|;
else|else
return|return
operator|(
name|remindex
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|char
modifier|*
name|showflags
parameter_list|(
name|int
name|flags
parameter_list|)
block|{
specifier|static
name|char
name|s
index|[
literal|1000
index|]
decl_stmt|;
name|s
index|[
literal|0
index|]
operator|=
literal|'\0'
expr_stmt|;
if|if
condition|(
operator|(
name|flags
operator|&
name|F_YEAR
operator|)
operator|!=
literal|0
condition|)
name|strcat
argument_list|(
name|s
argument_list|,
literal|"year "
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|flags
operator|&
name|F_MONTH
operator|)
operator|!=
literal|0
condition|)
name|strcat
argument_list|(
name|s
argument_list|,
literal|"month "
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|flags
operator|&
name|F_DAYOFWEEK
operator|)
operator|!=
literal|0
condition|)
name|strcat
argument_list|(
name|s
argument_list|,
literal|"dayofweek "
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|flags
operator|&
name|F_DAYOFMONTH
operator|)
operator|!=
literal|0
condition|)
name|strcat
argument_list|(
name|s
argument_list|,
literal|"dayofmonth "
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|flags
operator|&
name|F_MODIFIERINDEX
operator|)
operator|!=
literal|0
condition|)
name|strcat
argument_list|(
name|s
argument_list|,
literal|"modifierindex "
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|flags
operator|&
name|F_MODIFIEROFFSET
operator|)
operator|!=
literal|0
condition|)
name|strcat
argument_list|(
name|s
argument_list|,
literal|"modifieroffset "
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|flags
operator|&
name|F_SPECIALDAY
operator|)
operator|!=
literal|0
condition|)
name|strcat
argument_list|(
name|s
argument_list|,
literal|"specialday "
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|flags
operator|&
name|F_ALLMONTH
operator|)
operator|!=
literal|0
condition|)
name|strcat
argument_list|(
name|s
argument_list|,
literal|"allmonth "
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|flags
operator|&
name|F_ALLDAY
operator|)
operator|!=
literal|0
condition|)
name|strcat
argument_list|(
name|s
argument_list|,
literal|"allday "
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|flags
operator|&
name|F_VARIABLE
operator|)
operator|!=
literal|0
condition|)
name|strcat
argument_list|(
name|s
argument_list|,
literal|"variable "
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|flags
operator|&
name|F_CNY
operator|)
operator|!=
literal|0
condition|)
name|strcat
argument_list|(
name|s
argument_list|,
literal|"chinesenewyear "
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|flags
operator|&
name|F_PASKHA
operator|)
operator|!=
literal|0
condition|)
name|strcat
argument_list|(
name|s
argument_list|,
literal|"paskha "
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|flags
operator|&
name|F_EASTER
operator|)
operator|!=
literal|0
condition|)
name|strcat
argument_list|(
name|s
argument_list|,
literal|"easter "
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|flags
operator|&
name|F_FULLMOON
operator|)
operator|!=
literal|0
condition|)
name|strcat
argument_list|(
name|s
argument_list|,
literal|"fullmoon "
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|flags
operator|&
name|F_NEWMOON
operator|)
operator|!=
literal|0
condition|)
name|strcat
argument_list|(
name|s
argument_list|,
literal|"newmoon "
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|flags
operator|&
name|F_MAREQUINOX
operator|)
operator|!=
literal|0
condition|)
name|strcat
argument_list|(
name|s
argument_list|,
literal|"marequinox "
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|flags
operator|&
name|F_SEPEQUINOX
operator|)
operator|!=
literal|0
condition|)
name|strcat
argument_list|(
name|s
argument_list|,
literal|"sepequinox "
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|flags
operator|&
name|F_JUNSOLSTICE
operator|)
operator|!=
literal|0
condition|)
name|strcat
argument_list|(
name|s
argument_list|,
literal|"junsolstice "
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|flags
operator|&
name|F_DECSOLSTICE
operator|)
operator|!=
literal|0
condition|)
name|strcat
argument_list|(
name|s
argument_list|,
literal|"decsolstice "
argument_list|)
expr_stmt|;
return|return
name|s
return|;
block|}
end_function

begin_function
specifier|static
specifier|const
name|char
modifier|*
name|getmonthname
parameter_list|(
name|int
name|i
parameter_list|)
block|{
if|if
condition|(
name|i
operator|<=
literal|0
operator|||
name|i
operator|>
literal|12
condition|)
return|return
operator|(
literal|""
operator|)
return|;
if|if
condition|(
name|nmonths
index|[
name|i
operator|-
literal|1
index|]
operator|.
name|len
operator|!=
literal|0
operator|&&
name|nmonths
index|[
name|i
operator|-
literal|1
index|]
operator|.
name|name
operator|!=
name|NULL
condition|)
return|return
operator|(
name|nmonths
index|[
name|i
operator|-
literal|1
index|]
operator|.
name|name
operator|)
return|;
return|return
operator|(
name|months
index|[
name|i
operator|-
literal|1
index|]
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|checkmonth
parameter_list|(
name|char
modifier|*
name|s
parameter_list|,
name|size_t
modifier|*
name|len
parameter_list|,
name|size_t
modifier|*
name|offset
parameter_list|,
specifier|const
name|char
modifier|*
modifier|*
name|month
parameter_list|)
block|{
name|struct
name|fixs
modifier|*
name|n
decl_stmt|;
name|int
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|fnmonths
index|[
name|i
index|]
operator|.
name|name
operator|!=
name|NULL
condition|;
name|i
operator|++
control|)
block|{
name|n
operator|=
name|fnmonths
operator|+
name|i
expr_stmt|;
if|if
condition|(
name|strncasecmp
argument_list|(
name|s
argument_list|,
name|n
operator|->
name|name
argument_list|,
name|n
operator|->
name|len
argument_list|)
operator|==
literal|0
condition|)
block|{
operator|*
name|len
operator|=
name|n
operator|->
name|len
expr_stmt|;
operator|*
name|month
operator|=
name|n
operator|->
name|name
expr_stmt|;
operator|*
name|offset
operator|=
name|i
operator|+
literal|1
expr_stmt|;
return|return
operator|(
literal|1
operator|)
return|;
block|}
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|nmonths
index|[
name|i
index|]
operator|.
name|name
operator|!=
name|NULL
condition|;
name|i
operator|++
control|)
block|{
name|n
operator|=
name|nmonths
operator|+
name|i
expr_stmt|;
if|if
condition|(
name|strncasecmp
argument_list|(
name|s
argument_list|,
name|n
operator|->
name|name
argument_list|,
name|n
operator|->
name|len
argument_list|)
operator|==
literal|0
condition|)
block|{
operator|*
name|len
operator|=
name|n
operator|->
name|len
expr_stmt|;
operator|*
name|month
operator|=
name|n
operator|->
name|name
expr_stmt|;
operator|*
name|offset
operator|=
name|i
operator|+
literal|1
expr_stmt|;
return|return
operator|(
literal|1
operator|)
return|;
block|}
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|fmonths
index|[
name|i
index|]
operator|!=
name|NULL
condition|;
name|i
operator|++
control|)
block|{
operator|*
name|len
operator|=
name|strlen
argument_list|(
name|fmonths
index|[
name|i
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|strncasecmp
argument_list|(
name|s
argument_list|,
name|fmonths
index|[
name|i
index|]
argument_list|,
operator|*
name|len
argument_list|)
operator|==
literal|0
condition|)
block|{
operator|*
name|month
operator|=
name|fmonths
index|[
name|i
index|]
expr_stmt|;
operator|*
name|offset
operator|=
name|i
operator|+
literal|1
expr_stmt|;
return|return
operator|(
literal|1
operator|)
return|;
block|}
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|months
index|[
name|i
index|]
operator|!=
name|NULL
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|strncasecmp
argument_list|(
name|s
argument_list|,
name|months
index|[
name|i
index|]
argument_list|,
literal|3
argument_list|)
operator|==
literal|0
condition|)
block|{
operator|*
name|len
operator|=
literal|3
expr_stmt|;
operator|*
name|month
operator|=
name|months
index|[
name|i
index|]
expr_stmt|;
operator|*
name|offset
operator|=
name|i
operator|+
literal|1
expr_stmt|;
return|return
operator|(
literal|1
operator|)
return|;
block|}
block|}
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
specifier|const
name|char
modifier|*
name|getdayofweekname
parameter_list|(
name|int
name|i
parameter_list|)
block|{
if|if
condition|(
name|ndays
index|[
name|i
index|]
operator|.
name|len
operator|!=
literal|0
operator|&&
name|ndays
index|[
name|i
index|]
operator|.
name|name
operator|!=
name|NULL
condition|)
return|return
operator|(
name|ndays
index|[
name|i
index|]
operator|.
name|name
operator|)
return|;
return|return
operator|(
name|days
index|[
name|i
index|]
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|checkdayofweek
parameter_list|(
name|char
modifier|*
name|s
parameter_list|,
name|size_t
modifier|*
name|len
parameter_list|,
name|size_t
modifier|*
name|offset
parameter_list|,
specifier|const
name|char
modifier|*
modifier|*
name|dow
parameter_list|)
block|{
name|struct
name|fixs
modifier|*
name|n
decl_stmt|;
name|int
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|fndays
index|[
name|i
index|]
operator|.
name|name
operator|!=
name|NULL
condition|;
name|i
operator|++
control|)
block|{
name|n
operator|=
name|fndays
operator|+
name|i
expr_stmt|;
if|if
condition|(
name|strncasecmp
argument_list|(
name|s
argument_list|,
name|n
operator|->
name|name
argument_list|,
name|n
operator|->
name|len
argument_list|)
operator|==
literal|0
condition|)
block|{
operator|*
name|len
operator|=
name|n
operator|->
name|len
expr_stmt|;
operator|*
name|dow
operator|=
name|n
operator|->
name|name
expr_stmt|;
operator|*
name|offset
operator|=
name|i
expr_stmt|;
return|return
operator|(
literal|1
operator|)
return|;
block|}
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|ndays
index|[
name|i
index|]
operator|.
name|name
operator|!=
name|NULL
condition|;
name|i
operator|++
control|)
block|{
name|n
operator|=
name|ndays
operator|+
name|i
expr_stmt|;
if|if
condition|(
name|strncasecmp
argument_list|(
name|s
argument_list|,
name|n
operator|->
name|name
argument_list|,
name|n
operator|->
name|len
argument_list|)
operator|==
literal|0
condition|)
block|{
operator|*
name|len
operator|=
name|n
operator|->
name|len
expr_stmt|;
operator|*
name|dow
operator|=
name|n
operator|->
name|name
expr_stmt|;
operator|*
name|offset
operator|=
name|i
expr_stmt|;
return|return
operator|(
literal|1
operator|)
return|;
block|}
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|fdays
index|[
name|i
index|]
operator|!=
name|NULL
condition|;
name|i
operator|++
control|)
block|{
operator|*
name|len
operator|=
name|strlen
argument_list|(
name|fdays
index|[
name|i
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|strncasecmp
argument_list|(
name|s
argument_list|,
name|fdays
index|[
name|i
index|]
argument_list|,
operator|*
name|len
argument_list|)
operator|==
literal|0
condition|)
block|{
operator|*
name|dow
operator|=
name|fdays
index|[
name|i
index|]
expr_stmt|;
operator|*
name|offset
operator|=
name|i
expr_stmt|;
return|return
operator|(
literal|1
operator|)
return|;
block|}
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|days
index|[
name|i
index|]
operator|!=
name|NULL
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|strncasecmp
argument_list|(
name|s
argument_list|,
name|days
index|[
name|i
index|]
argument_list|,
literal|3
argument_list|)
operator|==
literal|0
condition|)
block|{
operator|*
name|len
operator|=
literal|3
expr_stmt|;
operator|*
name|dow
operator|=
name|days
index|[
name|i
index|]
expr_stmt|;
operator|*
name|offset
operator|=
name|i
expr_stmt|;
return|return
operator|(
literal|1
operator|)
return|;
block|}
block|}
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|isonlydigits
parameter_list|(
name|char
modifier|*
name|s
parameter_list|,
name|int
name|nostar
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|s
index|[
name|i
index|]
operator|!=
literal|'\0'
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|nostar
operator|==
literal|0
operator|&&
name|s
index|[
name|i
index|]
operator|==
literal|'*'
operator|&&
name|s
index|[
name|i
operator|+
literal|1
index|]
operator|==
literal|'\0'
condition|)
return|return
literal|1
return|;
if|if
condition|(
operator|!
name|isdigit
argument_list|(
operator|(
name|unsigned
name|char
operator|)
name|s
index|[
name|i
index|]
argument_list|)
condition|)
return|return
operator|(
literal|0
operator|)
return|;
block|}
return|return
operator|(
literal|1
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|indextooffset
parameter_list|(
name|char
modifier|*
name|s
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
name|struct
name|fixs
modifier|*
name|n
decl_stmt|;
name|char
modifier|*
name|es
decl_stmt|;
if|if
condition|(
name|s
index|[
literal|0
index|]
operator|==
literal|'+'
operator|||
name|s
index|[
literal|0
index|]
operator|==
literal|'-'
condition|)
block|{
name|i
operator|=
name|strtol
argument_list|(
name|s
argument_list|,
operator|&
name|es
argument_list|,
literal|10
argument_list|)
expr_stmt|;
if|if
condition|(
operator|*
name|es
operator|!=
literal|'\0'
condition|)
comment|/* trailing junk */
name|errx
argument_list|(
literal|1
argument_list|,
literal|"Invalid specifier format: %s\n"
argument_list|,
name|s
argument_list|)
expr_stmt|;
return|return
operator|(
name|i
operator|)
return|;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|6
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|strcasecmp
argument_list|(
name|s
argument_list|,
name|sequences
index|[
name|i
index|]
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|i
operator|==
literal|5
condition|)
return|return
operator|(
operator|-
literal|1
operator|)
return|;
return|return
operator|(
name|i
operator|+
literal|1
operator|)
return|;
block|}
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|6
condition|;
name|i
operator|++
control|)
block|{
name|n
operator|=
name|nsequences
operator|+
name|i
expr_stmt|;
if|if
condition|(
name|n
operator|->
name|len
operator|==
literal|0
condition|)
continue|continue;
if|if
condition|(
name|strncasecmp
argument_list|(
name|s
argument_list|,
name|n
operator|->
name|name
argument_list|,
name|n
operator|->
name|len
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|i
operator|==
literal|5
condition|)
return|return
operator|(
operator|-
literal|1
operator|)
return|;
return|return
operator|(
name|i
operator|+
literal|1
operator|)
return|;
block|}
block|}
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|parseoffset
parameter_list|(
name|char
modifier|*
name|s
parameter_list|)
block|{
return|return
name|strtol
argument_list|(
name|s
argument_list|,
name|NULL
argument_list|,
literal|10
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|char
modifier|*
name|floattotime
parameter_list|(
name|double
name|f
parameter_list|)
block|{
specifier|static
name|char
name|buf
index|[
literal|100
index|]
decl_stmt|;
name|int
name|hh
decl_stmt|,
name|mm
decl_stmt|,
name|ss
decl_stmt|,
name|i
decl_stmt|;
name|f
operator|-=
name|floor
argument_list|(
name|f
argument_list|)
expr_stmt|;
name|i
operator|=
name|f
operator|*
name|SECSPERDAY
expr_stmt|;
name|hh
operator|=
name|i
operator|/
name|SECSPERHOUR
expr_stmt|;
name|i
operator|%=
name|SECSPERHOUR
expr_stmt|;
name|mm
operator|=
name|i
operator|/
name|SECSPERMINUTE
expr_stmt|;
name|i
operator|%=
name|SECSPERMINUTE
expr_stmt|;
name|ss
operator|=
name|i
expr_stmt|;
name|sprintf
argument_list|(
name|buf
argument_list|,
literal|"%02d:%02d:%02d"
argument_list|,
name|hh
argument_list|,
name|mm
argument_list|,
name|ss
argument_list|)
expr_stmt|;
return|return
operator|(
name|buf
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|char
modifier|*
name|floattoday
parameter_list|(
name|int
name|year
parameter_list|,
name|double
name|f
parameter_list|)
block|{
specifier|static
name|char
name|buf
index|[
literal|100
index|]
decl_stmt|;
name|int
name|i
decl_stmt|,
name|m
decl_stmt|,
name|d
decl_stmt|,
name|hh
decl_stmt|,
name|mm
decl_stmt|,
name|ss
decl_stmt|;
name|int
modifier|*
name|cumdays
init|=
name|cumdaytab
index|[
name|isleap
argument_list|(
name|year
argument_list|)
index|]
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
literal|1
operator|+
name|cumdays
index|[
name|i
index|]
operator|<
name|f
condition|;
name|i
operator|++
control|)
empty_stmt|;
name|m
operator|=
operator|--
name|i
expr_stmt|;
name|d
operator|=
name|floor
argument_list|(
name|f
operator|-
literal|1
operator|-
name|cumdays
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|f
operator|-=
name|floor
argument_list|(
name|f
argument_list|)
expr_stmt|;
name|i
operator|=
name|f
operator|*
name|SECSPERDAY
expr_stmt|;
name|hh
operator|=
name|i
operator|/
name|SECSPERHOUR
expr_stmt|;
name|i
operator|%=
name|SECSPERHOUR
expr_stmt|;
name|mm
operator|=
name|i
operator|/
name|SECSPERMINUTE
expr_stmt|;
name|i
operator|%=
name|SECSPERMINUTE
expr_stmt|;
name|ss
operator|=
name|i
expr_stmt|;
name|sprintf
argument_list|(
name|buf
argument_list|,
literal|"%02d-%02d %02d:%02d:%02d"
argument_list|,
name|m
argument_list|,
name|d
argument_list|,
name|hh
argument_list|,
name|mm
argument_list|,
name|ss
argument_list|)
expr_stmt|;
return|return
operator|(
name|buf
operator|)
return|;
block|}
end_function

begin_function
name|void
name|dodebug
parameter_list|(
name|char
modifier|*
name|what
parameter_list|)
block|{
name|int
name|year
decl_stmt|;
name|printf
argument_list|(
literal|"UTCOffset: %g\n"
argument_list|,
name|UTCOffset
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"eastlongitude: %d\n"
argument_list|,
name|EastLongitude
argument_list|)
expr_stmt|;
if|if
condition|(
name|strcmp
argument_list|(
name|what
argument_list|,
literal|"moon"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|double
name|ffullmoon
index|[
name|MAXMOONS
index|]
decl_stmt|,
name|fnewmoon
index|[
name|MAXMOONS
index|]
decl_stmt|;
name|int
name|i
decl_stmt|;
for|for
control|(
name|year
operator|=
name|year1
init|;
name|year
operator|<=
name|year2
condition|;
name|year
operator|++
control|)
block|{
name|fpom
argument_list|(
name|year
argument_list|,
name|UTCOffset
argument_list|,
name|ffullmoon
argument_list|,
name|fnewmoon
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Full moon %d:\t"
argument_list|,
name|year
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|ffullmoon
index|[
name|i
index|]
operator|>=
literal|0
condition|;
name|i
operator|++
control|)
block|{
name|printf
argument_list|(
literal|"%g (%s) "
argument_list|,
name|ffullmoon
index|[
name|i
index|]
argument_list|,
name|floattoday
argument_list|(
name|year
argument_list|,
name|ffullmoon
index|[
name|i
index|]
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|printf
argument_list|(
literal|"\nNew moon %d:\t"
argument_list|,
name|year
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|fnewmoon
index|[
name|i
index|]
operator|>=
literal|0
condition|;
name|i
operator|++
control|)
block|{
name|printf
argument_list|(
literal|"%g (%s) "
argument_list|,
name|fnewmoon
index|[
name|i
index|]
argument_list|,
name|floattoday
argument_list|(
name|year
argument_list|,
name|fnewmoon
index|[
name|i
index|]
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
block|}
return|return;
block|}
if|if
condition|(
name|strcmp
argument_list|(
name|what
argument_list|,
literal|"sun"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|double
name|equinoxdays
index|[
literal|2
index|]
decl_stmt|,
name|solsticedays
index|[
literal|2
index|]
decl_stmt|;
for|for
control|(
name|year
operator|=
name|year1
init|;
name|year
operator|<=
name|year2
condition|;
name|year
operator|++
control|)
block|{
name|printf
argument_list|(
literal|"Sun in %d:\n"
argument_list|,
name|year
argument_list|)
expr_stmt|;
name|fequinoxsolstice
argument_list|(
name|year
argument_list|,
name|UTCOffset
argument_list|,
name|equinoxdays
argument_list|,
name|solsticedays
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"e[0] - %g (%s)\n"
argument_list|,
name|equinoxdays
index|[
literal|0
index|]
argument_list|,
name|floattoday
argument_list|(
name|year
argument_list|,
name|equinoxdays
index|[
literal|0
index|]
argument_list|)
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"e[1] - %g (%s)\n"
argument_list|,
name|equinoxdays
index|[
literal|1
index|]
argument_list|,
name|floattoday
argument_list|(
name|year
argument_list|,
name|equinoxdays
index|[
literal|1
index|]
argument_list|)
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"s[0] - %g (%s)\n"
argument_list|,
name|solsticedays
index|[
literal|0
index|]
argument_list|,
name|floattoday
argument_list|(
name|year
argument_list|,
name|solsticedays
index|[
literal|0
index|]
argument_list|)
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"s[1] - %g (%s)\n"
argument_list|,
name|solsticedays
index|[
literal|1
index|]
argument_list|,
name|floattoday
argument_list|(
name|year
argument_list|,
name|solsticedays
index|[
literal|1
index|]
argument_list|)
argument_list|)
expr_stmt|;
block|}
return|return;
block|}
block|}
end_function

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*-  * Copyright (c) 1988, 1993  *	The Regents of the University of California.  All rights reserved.  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions  * are met:  * 1. Redistributions of source code must retain the above copyright  *    notice, this list of conditions and the following disclaimer.  * 2. Redistributions in binary form must reproduce the above copyright  *    notice, this list of conditions and the following disclaimer in the  *    documentation and/or other materials provided with the distribution.  * 4. Neither the name of the University nor the names of its contributors  *    may be used to endorse or promote products derived from this software  *    without specific prior written permission.  *  * THIS SOFTWARE IS PROVIDED BY THE REGENTS AND CONTRIBUTORS ``AS IS'' AND  * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE  * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE  * ARE DISCLAIMED.  IN NO EVENT SHALL THE REGENTS OR CONTRIBUTORS BE LIABLE  * FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL  * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS  * OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)  * HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT  * LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY  * OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF  * SUCH DAMAGE.  */
end_comment

begin_ifndef
ifndef|#
directive|ifndef
name|lint
end_ifndef

begin_decl_stmt
specifier|static
specifier|const
name|char
name|copyright
index|[]
init|=
literal|"@(#) Copyright (c) 1988, 1993\n\ 	The Regents of the University of California.  All rights reserved.\n"
decl_stmt|;
end_decl_stmt

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* not lint */
end_comment

begin_ifndef
ifndef|#
directive|ifndef
name|lint
end_ifndef

begin_if
if|#
directive|if
literal|0
end_if

begin_endif
unit|static char sccsid[] = "@(#)kdump.c	8.1 (Berkeley) 6/6/93";
endif|#
directive|endif
end_endif

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* not lint */
end_comment

begin_include
include|#
directive|include
file|<sys/cdefs.h>
end_include

begin_expr_stmt
name|__FBSDID
argument_list|(
literal|"$FreeBSD$"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_define
define|#
directive|define
name|_WANT_KERNEL_ERRNO
end_define

begin_include
include|#
directive|include
file|<sys/param.h>
end_include

begin_include
include|#
directive|include
file|<sys/capsicum.h>
end_include

begin_include
include|#
directive|include
file|<sys/errno.h>
end_include

begin_include
include|#
directive|include
file|<sys/time.h>
end_include

begin_include
include|#
directive|include
file|<sys/uio.h>
end_include

begin_include
include|#
directive|include
file|<sys/ktrace.h>
end_include

begin_include
include|#
directive|include
file|<sys/ioctl.h>
end_include

begin_include
include|#
directive|include
file|<sys/socket.h>
end_include

begin_include
include|#
directive|include
file|<sys/stat.h>
end_include

begin_include
include|#
directive|include
file|<sys/sysent.h>
end_include

begin_include
include|#
directive|include
file|<sys/umtx.h>
end_include

begin_include
include|#
directive|include
file|<sys/un.h>
end_include

begin_include
include|#
directive|include
file|<sys/queue.h>
end_include

begin_include
include|#
directive|include
file|<sys/wait.h>
end_include

begin_ifdef
ifdef|#
directive|ifdef
name|HAVE_LIBCASPER
end_ifdef

begin_include
include|#
directive|include
file|<sys/nv.h>
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_include
include|#
directive|include
file|<arpa/inet.h>
end_include

begin_include
include|#
directive|include
file|<netinet/in.h>
end_include

begin_include
include|#
directive|include
file|<ctype.h>
end_include

begin_include
include|#
directive|include
file|<err.h>
end_include

begin_include
include|#
directive|include
file|<grp.h>
end_include

begin_include
include|#
directive|include
file|<inttypes.h>
end_include

begin_include
include|#
directive|include
file|<locale.h>
end_include

begin_include
include|#
directive|include
file|<netdb.h>
end_include

begin_include
include|#
directive|include
file|<nl_types.h>
end_include

begin_include
include|#
directive|include
file|<pwd.h>
end_include

begin_include
include|#
directive|include
file|<stddef.h>
end_include

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_include
include|#
directive|include
file|<stdlib.h>
end_include

begin_include
include|#
directive|include
file|<string.h>
end_include

begin_include
include|#
directive|include
file|<sysdecode.h>
end_include

begin_include
include|#
directive|include
file|<termios.h>
end_include

begin_include
include|#
directive|include
file|<time.h>
end_include

begin_include
include|#
directive|include
file|<unistd.h>
end_include

begin_include
include|#
directive|include
file|<vis.h>
end_include

begin_include
include|#
directive|include
file|"ktrace.h"
end_include

begin_ifdef
ifdef|#
directive|ifdef
name|HAVE_LIBCASPER
end_ifdef

begin_include
include|#
directive|include
file|<libcasper.h>
end_include

begin_include
include|#
directive|include
file|<casper/cap_grp.h>
end_include

begin_include
include|#
directive|include
file|<casper/cap_pwd.h>
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_function_decl
name|u_int
name|abidump
parameter_list|(
name|struct
name|ktr_header
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|int
name|fetchprocinfo
parameter_list|(
name|struct
name|ktr_header
modifier|*
parameter_list|,
name|u_int
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|int
name|fread_tail
parameter_list|(
name|void
modifier|*
parameter_list|,
name|int
parameter_list|,
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|void
name|dumpheader
parameter_list|(
name|struct
name|ktr_header
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|void
name|ktrsyscall
parameter_list|(
name|struct
name|ktr_syscall
modifier|*
parameter_list|,
name|u_int
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|void
name|ktrsysret
parameter_list|(
name|struct
name|ktr_sysret
modifier|*
parameter_list|,
name|u_int
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|void
name|ktrnamei
parameter_list|(
name|char
modifier|*
parameter_list|,
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|void
name|hexdump
parameter_list|(
name|char
modifier|*
parameter_list|,
name|int
parameter_list|,
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|void
name|visdump
parameter_list|(
name|char
modifier|*
parameter_list|,
name|int
parameter_list|,
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|void
name|ktrgenio
parameter_list|(
name|struct
name|ktr_genio
modifier|*
parameter_list|,
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|void
name|ktrpsig
parameter_list|(
name|struct
name|ktr_psig
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|void
name|ktrcsw
parameter_list|(
name|struct
name|ktr_csw
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|void
name|ktrcsw_old
parameter_list|(
name|struct
name|ktr_csw_old
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|void
name|ktruser
parameter_list|(
name|int
parameter_list|,
name|void
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|void
name|ktrcaprights
parameter_list|(
name|cap_rights_t
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|void
name|ktritimerval
parameter_list|(
name|struct
name|itimerval
modifier|*
name|it
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|void
name|ktrsockaddr
parameter_list|(
name|struct
name|sockaddr
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|void
name|ktrstat
parameter_list|(
name|struct
name|stat
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|void
name|ktrstruct
parameter_list|(
name|char
modifier|*
parameter_list|,
name|size_t
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|void
name|ktrcapfail
parameter_list|(
name|struct
name|ktr_cap_fail
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|void
name|ktrfault
parameter_list|(
name|struct
name|ktr_fault
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|void
name|ktrfaultend
parameter_list|(
name|struct
name|ktr_faultend
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|void
name|limitfd
parameter_list|(
name|int
name|fd
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|void
name|usage
parameter_list|(
name|void
parameter_list|)
function_decl|;
end_function_decl

begin_define
define|#
directive|define
name|TIMESTAMP_NONE
value|0x0
end_define

begin_define
define|#
directive|define
name|TIMESTAMP_ABSOLUTE
value|0x1
end_define

begin_define
define|#
directive|define
name|TIMESTAMP_ELAPSED
value|0x2
end_define

begin_define
define|#
directive|define
name|TIMESTAMP_RELATIVE
value|0x4
end_define

begin_decl_stmt
specifier|static
name|int
name|timestamp
decl_stmt|,
name|decimal
decl_stmt|,
name|fancy
init|=
literal|1
decl_stmt|,
name|suppressdata
decl_stmt|,
name|tail
decl_stmt|,
name|threads
decl_stmt|,
name|maxdata
decl_stmt|,
name|resolv
init|=
literal|0
decl_stmt|,
name|abiflag
init|=
literal|0
decl_stmt|,
name|syscallno
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
specifier|const
name|char
modifier|*
name|tracefile
init|=
name|DEF_TRACEFILE
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|struct
name|ktr_header
name|ktr_header
decl_stmt|;
end_decl_stmt

begin_define
define|#
directive|define
name|TIME_FORMAT
value|"%b %e %T %Y"
end_define

begin_define
define|#
directive|define
name|eqs
parameter_list|(
name|s1
parameter_list|,
name|s2
parameter_list|)
value|(strcmp((s1), (s2)) == 0)
end_define

begin_define
define|#
directive|define
name|print_number64
parameter_list|(
name|first
parameter_list|,
name|i
parameter_list|,
name|n
parameter_list|,
name|c
parameter_list|)
value|do {				\ 	uint64_t __v;							\ 									\ 	if (quad_align&& (((ptrdiff_t)((i) - (first)))& 1) == 1) {	\ 		(i)++;							\ 		(n)--;							\ 	}								\ 	if (quad_slots == 2)						\ 		__v = (uint64_t)(uint32_t)(i)[0] |			\ 		    ((uint64_t)(uint32_t)(i)[1])<< 32;			\ 	else								\ 		__v = (uint64_t)*(i);					\ 	if (decimal)							\ 		printf("%c%jd", (c), (intmax_t)__v);			\ 	else								\ 		printf("%c%#jx", (c), (uintmax_t)__v);			\ 	(i) += quad_slots;						\ 	(n) -= quad_slots;						\ 	(c) = ',';							\ } while (0)
end_define

begin_define
define|#
directive|define
name|print_number
parameter_list|(
name|i
parameter_list|,
name|n
parameter_list|,
name|c
parameter_list|)
value|do {					\ 	if (decimal)							\ 		printf("%c%jd", c, (intmax_t)*i);			\ 	else								\ 		printf("%c%#jx", c, (uintmax_t)(u_register_t)*i);	\ 	i++;								\ 	n--;								\ 	c = ',';							\ } while (0)
end_define

begin_struct
struct|struct
name|proc_info
block|{
name|TAILQ_ENTRY
argument_list|(
argument|proc_info
argument_list|)
name|info
expr_stmt|;
name|u_int
name|sv_flags
decl_stmt|;
name|pid_t
name|pid
decl_stmt|;
block|}
struct|;
end_struct

begin_expr_stmt
specifier|static
name|TAILQ_HEAD
argument_list|(
argument|trace_procs
argument_list|,
argument|proc_info
argument_list|)
name|trace_procs
expr_stmt|;
end_expr_stmt

begin_ifdef
ifdef|#
directive|ifdef
name|HAVE_LIBCASPER
end_ifdef

begin_decl_stmt
specifier|static
name|cap_channel_t
modifier|*
name|cappwd
decl_stmt|,
modifier|*
name|capgrp
decl_stmt|;
end_decl_stmt

begin_endif
endif|#
directive|endif
end_endif

begin_function
specifier|static
name|void
name|strerror_init
parameter_list|(
name|void
parameter_list|)
block|{
comment|/* 	 * Cache NLS data before entering capability mode. 	 * XXXPJD: There should be strerror_init() and strsignal_init() in libc. 	 */
operator|(
name|void
operator|)
name|catopen
argument_list|(
literal|"libc"
argument_list|,
name|NL_CAT_LOCALE
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|localtime_init
parameter_list|(
name|void
parameter_list|)
block|{
name|time_t
name|ltime
decl_stmt|;
comment|/* 	 * Allow localtime(3) to cache /etc/localtime content before entering 	 * capability mode. 	 * XXXPJD: There should be localtime_init() in libc. 	 */
operator|(
name|void
operator|)
name|time
argument_list|(
operator|&
name|ltime
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|localtime
argument_list|(
operator|&
name|ltime
argument_list|)
expr_stmt|;
block|}
end_function

begin_ifdef
ifdef|#
directive|ifdef
name|HAVE_LIBCASPER
end_ifdef

begin_function
specifier|static
name|int
name|cappwdgrp_setup
parameter_list|(
name|cap_channel_t
modifier|*
modifier|*
name|cappwdp
parameter_list|,
name|cap_channel_t
modifier|*
modifier|*
name|capgrpp
parameter_list|)
block|{
name|cap_channel_t
modifier|*
name|capcas
decl_stmt|,
modifier|*
name|cappwdloc
decl_stmt|,
modifier|*
name|capgrploc
decl_stmt|;
specifier|const
name|char
modifier|*
name|cmds
index|[
literal|1
index|]
decl_stmt|,
modifier|*
name|fields
index|[
literal|1
index|]
decl_stmt|;
name|capcas
operator|=
name|cap_init
argument_list|()
expr_stmt|;
if|if
condition|(
name|capcas
operator|==
name|NULL
condition|)
block|{
name|err
argument_list|(
literal|1
argument_list|,
literal|"unable to create casper process"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
name|cappwdloc
operator|=
name|cap_service_open
argument_list|(
name|capcas
argument_list|,
literal|"system.pwd"
argument_list|)
expr_stmt|;
name|capgrploc
operator|=
name|cap_service_open
argument_list|(
name|capcas
argument_list|,
literal|"system.grp"
argument_list|)
expr_stmt|;
comment|/* Casper capability no longer needed. */
name|cap_close
argument_list|(
name|capcas
argument_list|)
expr_stmt|;
if|if
condition|(
name|cappwdloc
operator|==
name|NULL
operator|||
name|capgrploc
operator|==
name|NULL
condition|)
block|{
if|if
condition|(
name|cappwdloc
operator|==
name|NULL
condition|)
name|warn
argument_list|(
literal|"unable to open system.pwd service"
argument_list|)
expr_stmt|;
if|if
condition|(
name|capgrploc
operator|==
name|NULL
condition|)
name|warn
argument_list|(
literal|"unable to open system.grp service"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
comment|/* Limit system.pwd to only getpwuid() function and pw_name field. */
name|cmds
index|[
literal|0
index|]
operator|=
literal|"getpwuid"
expr_stmt|;
if|if
condition|(
name|cap_pwd_limit_cmds
argument_list|(
name|cappwdloc
argument_list|,
name|cmds
argument_list|,
literal|1
argument_list|)
operator|<
literal|0
condition|)
name|err
argument_list|(
literal|1
argument_list|,
literal|"unable to limit system.pwd service"
argument_list|)
expr_stmt|;
name|fields
index|[
literal|0
index|]
operator|=
literal|"pw_name"
expr_stmt|;
if|if
condition|(
name|cap_pwd_limit_fields
argument_list|(
name|cappwdloc
argument_list|,
name|fields
argument_list|,
literal|1
argument_list|)
operator|<
literal|0
condition|)
name|err
argument_list|(
literal|1
argument_list|,
literal|"unable to limit system.pwd service"
argument_list|)
expr_stmt|;
comment|/* Limit system.grp to only getgrgid() function and gr_name field. */
name|cmds
index|[
literal|0
index|]
operator|=
literal|"getgrgid"
expr_stmt|;
if|if
condition|(
name|cap_grp_limit_cmds
argument_list|(
name|capgrploc
argument_list|,
name|cmds
argument_list|,
literal|1
argument_list|)
operator|<
literal|0
condition|)
name|err
argument_list|(
literal|1
argument_list|,
literal|"unable to limit system.grp service"
argument_list|)
expr_stmt|;
name|fields
index|[
literal|0
index|]
operator|=
literal|"gr_name"
expr_stmt|;
if|if
condition|(
name|cap_grp_limit_fields
argument_list|(
name|capgrploc
argument_list|,
name|fields
argument_list|,
literal|1
argument_list|)
operator|<
literal|0
condition|)
name|err
argument_list|(
literal|1
argument_list|,
literal|"unable to limit system.grp service"
argument_list|)
expr_stmt|;
operator|*
name|cappwdp
operator|=
name|cappwdloc
expr_stmt|;
operator|*
name|capgrpp
operator|=
name|capgrploc
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* HAVE_LIBCASPER */
end_comment

begin_function
specifier|static
name|void
name|print_integer_arg
parameter_list|(
specifier|const
name|char
modifier|*
function_decl|(
modifier|*
name|decoder
function_decl|)
parameter_list|(
name|int
parameter_list|)
parameter_list|,
name|int
name|value
parameter_list|)
block|{
specifier|const
name|char
modifier|*
name|str
decl_stmt|;
name|str
operator|=
name|decoder
argument_list|(
name|value
argument_list|)
expr_stmt|;
if|if
condition|(
name|str
operator|!=
name|NULL
condition|)
name|printf
argument_list|(
literal|"%s"
argument_list|,
name|str
argument_list|)
expr_stmt|;
else|else
block|{
if|if
condition|(
name|decimal
condition|)
name|printf
argument_list|(
literal|"<invalid=%d>"
argument_list|,
name|value
argument_list|)
expr_stmt|;
else|else
name|printf
argument_list|(
literal|"<invalid=%#x>"
argument_list|,
name|value
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/* Like print_integer_arg but unknown values are treated as valid. */
end_comment

begin_function
specifier|static
name|void
name|print_integer_arg_valid
parameter_list|(
specifier|const
name|char
modifier|*
function_decl|(
modifier|*
name|decoder
function_decl|)
parameter_list|(
name|int
parameter_list|)
parameter_list|,
name|int
name|value
parameter_list|)
block|{
specifier|const
name|char
modifier|*
name|str
decl_stmt|;
name|str
operator|=
name|decoder
argument_list|(
name|value
argument_list|)
expr_stmt|;
if|if
condition|(
name|str
operator|!=
name|NULL
condition|)
name|printf
argument_list|(
literal|"%s"
argument_list|,
name|str
argument_list|)
expr_stmt|;
else|else
block|{
if|if
condition|(
name|decimal
condition|)
name|printf
argument_list|(
literal|"%d"
argument_list|,
name|value
argument_list|)
expr_stmt|;
else|else
name|printf
argument_list|(
literal|"%#x"
argument_list|,
name|value
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|print_mask_arg
parameter_list|(
name|bool
function_decl|(
modifier|*
name|decoder
function_decl|)
parameter_list|(
name|FILE
modifier|*
parameter_list|,
name|int
parameter_list|,
name|int
modifier|*
parameter_list|)
parameter_list|,
name|int
name|value
parameter_list|)
block|{
name|bool
name|invalid
decl_stmt|;
name|int
name|rem
decl_stmt|;
name|printf
argument_list|(
literal|"%#x<"
argument_list|,
name|value
argument_list|)
expr_stmt|;
name|invalid
operator|=
operator|!
name|decoder
argument_list|(
name|stdout
argument_list|,
name|value
argument_list|,
operator|&
name|rem
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|">"
argument_list|)
expr_stmt|;
if|if
condition|(
name|invalid
condition|)
name|printf
argument_list|(
literal|"<invalid>%u"
argument_list|,
name|rem
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|print_mask_arg0
parameter_list|(
name|bool
function_decl|(
modifier|*
name|decoder
function_decl|)
parameter_list|(
name|FILE
modifier|*
parameter_list|,
name|int
parameter_list|,
name|int
modifier|*
parameter_list|)
parameter_list|,
name|int
name|value
parameter_list|)
block|{
name|bool
name|invalid
decl_stmt|;
name|int
name|rem
decl_stmt|;
if|if
condition|(
name|value
operator|==
literal|0
condition|)
block|{
name|printf
argument_list|(
literal|"0"
argument_list|)
expr_stmt|;
return|return;
block|}
name|printf
argument_list|(
literal|"%#x<"
argument_list|,
name|value
argument_list|)
expr_stmt|;
name|invalid
operator|=
operator|!
name|decoder
argument_list|(
name|stdout
argument_list|,
name|value
argument_list|,
operator|&
name|rem
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|">"
argument_list|)
expr_stmt|;
if|if
condition|(
name|invalid
condition|)
name|printf
argument_list|(
literal|"<invalid>%u"
argument_list|,
name|rem
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|decode_fileflags
parameter_list|(
name|fflags_t
name|value
parameter_list|)
block|{
name|bool
name|invalid
decl_stmt|;
name|fflags_t
name|rem
decl_stmt|;
if|if
condition|(
name|value
operator|==
literal|0
condition|)
block|{
name|printf
argument_list|(
literal|"0"
argument_list|)
expr_stmt|;
return|return;
block|}
name|printf
argument_list|(
literal|"%#x<"
argument_list|,
name|value
argument_list|)
expr_stmt|;
name|invalid
operator|=
operator|!
name|sysdecode_fileflags
argument_list|(
name|stdout
argument_list|,
name|value
argument_list|,
operator|&
name|rem
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|">"
argument_list|)
expr_stmt|;
if|if
condition|(
name|invalid
condition|)
name|printf
argument_list|(
literal|"<invalid>%u"
argument_list|,
name|rem
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|decode_filemode
parameter_list|(
name|int
name|value
parameter_list|)
block|{
name|bool
name|invalid
decl_stmt|;
name|int
name|rem
decl_stmt|;
if|if
condition|(
name|value
operator|==
literal|0
condition|)
block|{
name|printf
argument_list|(
literal|"0"
argument_list|)
expr_stmt|;
return|return;
block|}
name|printf
argument_list|(
literal|"%#o<"
argument_list|,
name|value
argument_list|)
expr_stmt|;
name|invalid
operator|=
operator|!
name|sysdecode_filemode
argument_list|(
name|stdout
argument_list|,
name|value
argument_list|,
operator|&
name|rem
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|">"
argument_list|)
expr_stmt|;
if|if
condition|(
name|invalid
condition|)
name|printf
argument_list|(
literal|"<invalid>%u"
argument_list|,
name|rem
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|print_mask_arg32
parameter_list|(
name|bool
function_decl|(
modifier|*
name|decoder
function_decl|)
parameter_list|(
name|FILE
modifier|*
parameter_list|,
name|uint32_t
parameter_list|,
name|uint32_t
modifier|*
parameter_list|)
parameter_list|,
name|uint32_t
name|value
parameter_list|)
block|{
name|bool
name|invalid
decl_stmt|;
name|uint32_t
name|rem
decl_stmt|;
name|printf
argument_list|(
literal|"%#x<"
argument_list|,
name|value
argument_list|)
expr_stmt|;
name|invalid
operator|=
operator|!
name|decoder
argument_list|(
name|stdout
argument_list|,
name|value
argument_list|,
operator|&
name|rem
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|">"
argument_list|)
expr_stmt|;
if|if
condition|(
name|invalid
condition|)
name|printf
argument_list|(
literal|"<invalid>%u"
argument_list|,
name|rem
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|print_mask_argul
parameter_list|(
name|bool
function_decl|(
modifier|*
name|decoder
function_decl|)
parameter_list|(
name|FILE
modifier|*
parameter_list|,
name|u_long
parameter_list|,
name|u_long
modifier|*
parameter_list|)
parameter_list|,
name|u_long
name|value
parameter_list|)
block|{
name|bool
name|invalid
decl_stmt|;
name|u_long
name|rem
decl_stmt|;
if|if
condition|(
name|value
operator|==
literal|0
condition|)
block|{
name|printf
argument_list|(
literal|"0"
argument_list|)
expr_stmt|;
return|return;
block|}
name|printf
argument_list|(
literal|"%#lx<"
argument_list|,
name|value
argument_list|)
expr_stmt|;
name|invalid
operator|=
operator|!
name|decoder
argument_list|(
name|stdout
argument_list|,
name|value
argument_list|,
operator|&
name|rem
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|">"
argument_list|)
expr_stmt|;
if|if
condition|(
name|invalid
condition|)
name|printf
argument_list|(
literal|"<invalid>%lu"
argument_list|,
name|rem
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|int
name|main
parameter_list|(
name|int
name|argc
parameter_list|,
name|char
modifier|*
name|argv
index|[]
parameter_list|)
block|{
name|int
name|ch
decl_stmt|,
name|ktrlen
decl_stmt|,
name|size
decl_stmt|;
name|void
modifier|*
name|m
decl_stmt|;
name|int
name|trpoints
init|=
name|ALL_POINTS
decl_stmt|;
name|int
name|drop_logged
decl_stmt|;
name|pid_t
name|pid
init|=
literal|0
decl_stmt|;
name|u_int
name|sv_flags
decl_stmt|;
name|setlocale
argument_list|(
name|LC_CTYPE
argument_list|,
literal|""
argument_list|)
expr_stmt|;
name|timestamp
operator|=
name|TIMESTAMP_NONE
expr_stmt|;
while|while
condition|(
operator|(
name|ch
operator|=
name|getopt
argument_list|(
name|argc
argument_list|,
name|argv
argument_list|,
literal|"f:dElm:np:AHRrSsTt:"
argument_list|)
operator|)
operator|!=
operator|-
literal|1
condition|)
switch|switch
condition|(
name|ch
condition|)
block|{
case|case
literal|'A'
case|:
name|abiflag
operator|=
literal|1
expr_stmt|;
break|break;
case|case
literal|'f'
case|:
name|tracefile
operator|=
name|optarg
expr_stmt|;
break|break;
case|case
literal|'d'
case|:
name|decimal
operator|=
literal|1
expr_stmt|;
break|break;
case|case
literal|'l'
case|:
name|tail
operator|=
literal|1
expr_stmt|;
break|break;
case|case
literal|'m'
case|:
name|maxdata
operator|=
name|atoi
argument_list|(
name|optarg
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'n'
case|:
name|fancy
operator|=
literal|0
expr_stmt|;
break|break;
case|case
literal|'p'
case|:
name|pid
operator|=
name|atoi
argument_list|(
name|optarg
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'r'
case|:
name|resolv
operator|=
literal|1
expr_stmt|;
break|break;
case|case
literal|'S'
case|:
name|syscallno
operator|=
literal|1
expr_stmt|;
break|break;
case|case
literal|'s'
case|:
name|suppressdata
operator|=
literal|1
expr_stmt|;
break|break;
case|case
literal|'E'
case|:
name|timestamp
operator||=
name|TIMESTAMP_ELAPSED
expr_stmt|;
break|break;
case|case
literal|'H'
case|:
name|threads
operator|=
literal|1
expr_stmt|;
break|break;
case|case
literal|'R'
case|:
name|timestamp
operator||=
name|TIMESTAMP_RELATIVE
expr_stmt|;
break|break;
case|case
literal|'T'
case|:
name|timestamp
operator||=
name|TIMESTAMP_ABSOLUTE
expr_stmt|;
break|break;
case|case
literal|'t'
case|:
name|trpoints
operator|=
name|getpoints
argument_list|(
name|optarg
argument_list|)
expr_stmt|;
if|if
condition|(
name|trpoints
operator|<
literal|0
condition|)
name|errx
argument_list|(
literal|1
argument_list|,
literal|"unknown trace point in %s"
argument_list|,
name|optarg
argument_list|)
expr_stmt|;
break|break;
default|default:
name|usage
argument_list|()
expr_stmt|;
block|}
if|if
condition|(
name|argc
operator|>
name|optind
condition|)
name|usage
argument_list|()
expr_stmt|;
name|m
operator|=
name|malloc
argument_list|(
name|size
operator|=
literal|1025
argument_list|)
expr_stmt|;
if|if
condition|(
name|m
operator|==
name|NULL
condition|)
name|errx
argument_list|(
literal|1
argument_list|,
literal|"%s"
argument_list|,
name|strerror
argument_list|(
name|ENOMEM
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|strcmp
argument_list|(
name|tracefile
argument_list|,
literal|"-"
argument_list|)
operator|!=
literal|0
condition|)
if|if
condition|(
operator|!
name|freopen
argument_list|(
name|tracefile
argument_list|,
literal|"r"
argument_list|,
name|stdin
argument_list|)
condition|)
name|err
argument_list|(
literal|1
argument_list|,
literal|"%s"
argument_list|,
name|tracefile
argument_list|)
expr_stmt|;
name|strerror_init
argument_list|()
expr_stmt|;
name|localtime_init
argument_list|()
expr_stmt|;
ifdef|#
directive|ifdef
name|HAVE_LIBCASPER
if|if
condition|(
name|resolv
operator|!=
literal|0
condition|)
block|{
if|if
condition|(
name|cappwdgrp_setup
argument_list|(
operator|&
name|cappwd
argument_list|,
operator|&
name|capgrp
argument_list|)
operator|<
literal|0
condition|)
block|{
name|cappwd
operator|=
name|NULL
expr_stmt|;
name|capgrp
operator|=
name|NULL
expr_stmt|;
block|}
block|}
if|if
condition|(
name|resolv
operator|==
literal|0
operator|||
operator|(
name|cappwd
operator|!=
name|NULL
operator|&&
name|capgrp
operator|!=
name|NULL
operator|)
condition|)
block|{
if|if
condition|(
name|cap_enter
argument_list|()
operator|<
literal|0
operator|&&
name|errno
operator|!=
name|ENOSYS
condition|)
name|err
argument_list|(
literal|1
argument_list|,
literal|"unable to enter capability mode"
argument_list|)
expr_stmt|;
block|}
else|#
directive|else
if|if
condition|(
name|resolv
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|cap_enter
argument_list|()
operator|<
literal|0
operator|&&
name|errno
operator|!=
name|ENOSYS
condition|)
name|err
argument_list|(
literal|1
argument_list|,
literal|"unable to enter capability mode"
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
name|limitfd
argument_list|(
name|STDIN_FILENO
argument_list|)
expr_stmt|;
name|limitfd
argument_list|(
name|STDOUT_FILENO
argument_list|)
expr_stmt|;
name|limitfd
argument_list|(
name|STDERR_FILENO
argument_list|)
expr_stmt|;
name|TAILQ_INIT
argument_list|(
operator|&
name|trace_procs
argument_list|)
expr_stmt|;
name|drop_logged
operator|=
literal|0
expr_stmt|;
while|while
condition|(
name|fread_tail
argument_list|(
operator|&
name|ktr_header
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|ktr_header
argument_list|)
argument_list|,
literal|1
argument_list|)
condition|)
block|{
if|if
condition|(
name|ktr_header
operator|.
name|ktr_type
operator|&
name|KTR_DROP
condition|)
block|{
name|ktr_header
operator|.
name|ktr_type
operator|&=
operator|~
name|KTR_DROP
expr_stmt|;
if|if
condition|(
operator|!
name|drop_logged
operator|&&
name|threads
condition|)
block|{
name|printf
argument_list|(
literal|"%6jd %6jd %-8.*s Events dropped.\n"
argument_list|,
operator|(
name|intmax_t
operator|)
name|ktr_header
operator|.
name|ktr_pid
argument_list|,
name|ktr_header
operator|.
name|ktr_tid
operator|>
literal|0
condition|?
operator|(
name|intmax_t
operator|)
name|ktr_header
operator|.
name|ktr_tid
else|:
literal|0
argument_list|,
name|MAXCOMLEN
argument_list|,
name|ktr_header
operator|.
name|ktr_comm
argument_list|)
expr_stmt|;
name|drop_logged
operator|=
literal|1
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|!
name|drop_logged
condition|)
block|{
name|printf
argument_list|(
literal|"%6jd %-8.*s Events dropped.\n"
argument_list|,
operator|(
name|intmax_t
operator|)
name|ktr_header
operator|.
name|ktr_pid
argument_list|,
name|MAXCOMLEN
argument_list|,
name|ktr_header
operator|.
name|ktr_comm
argument_list|)
expr_stmt|;
name|drop_logged
operator|=
literal|1
expr_stmt|;
block|}
block|}
if|if
condition|(
name|trpoints
operator|&
operator|(
literal|1
operator|<<
name|ktr_header
operator|.
name|ktr_type
operator|)
condition|)
if|if
condition|(
name|pid
operator|==
literal|0
operator|||
name|ktr_header
operator|.
name|ktr_pid
operator|==
name|pid
operator|||
name|ktr_header
operator|.
name|ktr_tid
operator|==
name|pid
condition|)
name|dumpheader
argument_list|(
operator|&
name|ktr_header
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|ktrlen
operator|=
name|ktr_header
operator|.
name|ktr_len
operator|)
operator|<
literal|0
condition|)
name|errx
argument_list|(
literal|1
argument_list|,
literal|"bogus length 0x%x"
argument_list|,
name|ktrlen
argument_list|)
expr_stmt|;
if|if
condition|(
name|ktrlen
operator|>
name|size
condition|)
block|{
name|m
operator|=
name|realloc
argument_list|(
name|m
argument_list|,
name|ktrlen
operator|+
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|m
operator|==
name|NULL
condition|)
name|errx
argument_list|(
literal|1
argument_list|,
literal|"%s"
argument_list|,
name|strerror
argument_list|(
name|ENOMEM
argument_list|)
argument_list|)
expr_stmt|;
name|size
operator|=
name|ktrlen
expr_stmt|;
block|}
if|if
condition|(
name|ktrlen
operator|&&
name|fread_tail
argument_list|(
name|m
argument_list|,
name|ktrlen
argument_list|,
literal|1
argument_list|)
operator|==
literal|0
condition|)
name|errx
argument_list|(
literal|1
argument_list|,
literal|"data too short"
argument_list|)
expr_stmt|;
if|if
condition|(
name|fetchprocinfo
argument_list|(
operator|&
name|ktr_header
argument_list|,
operator|(
name|u_int
operator|*
operator|)
name|m
argument_list|)
operator|!=
literal|0
condition|)
continue|continue;
name|sv_flags
operator|=
name|abidump
argument_list|(
operator|&
name|ktr_header
argument_list|)
expr_stmt|;
if|if
condition|(
name|pid
operator|&&
name|ktr_header
operator|.
name|ktr_pid
operator|!=
name|pid
operator|&&
name|ktr_header
operator|.
name|ktr_tid
operator|!=
name|pid
condition|)
continue|continue;
if|if
condition|(
operator|(
name|trpoints
operator|&
operator|(
literal|1
operator|<<
name|ktr_header
operator|.
name|ktr_type
operator|)
operator|)
operator|==
literal|0
condition|)
continue|continue;
name|drop_logged
operator|=
literal|0
expr_stmt|;
switch|switch
condition|(
name|ktr_header
operator|.
name|ktr_type
condition|)
block|{
case|case
name|KTR_SYSCALL
case|:
name|ktrsyscall
argument_list|(
operator|(
expr|struct
name|ktr_syscall
operator|*
operator|)
name|m
argument_list|,
name|sv_flags
argument_list|)
expr_stmt|;
break|break;
case|case
name|KTR_SYSRET
case|:
name|ktrsysret
argument_list|(
operator|(
expr|struct
name|ktr_sysret
operator|*
operator|)
name|m
argument_list|,
name|sv_flags
argument_list|)
expr_stmt|;
break|break;
case|case
name|KTR_NAMEI
case|:
case|case
name|KTR_SYSCTL
case|:
name|ktrnamei
argument_list|(
name|m
argument_list|,
name|ktrlen
argument_list|)
expr_stmt|;
break|break;
case|case
name|KTR_GENIO
case|:
name|ktrgenio
argument_list|(
operator|(
expr|struct
name|ktr_genio
operator|*
operator|)
name|m
argument_list|,
name|ktrlen
argument_list|)
expr_stmt|;
break|break;
case|case
name|KTR_PSIG
case|:
name|ktrpsig
argument_list|(
operator|(
expr|struct
name|ktr_psig
operator|*
operator|)
name|m
argument_list|)
expr_stmt|;
break|break;
case|case
name|KTR_CSW
case|:
if|if
condition|(
name|ktrlen
operator|==
sizeof|sizeof
argument_list|(
expr|struct
name|ktr_csw_old
argument_list|)
condition|)
name|ktrcsw_old
argument_list|(
operator|(
expr|struct
name|ktr_csw_old
operator|*
operator|)
name|m
argument_list|)
expr_stmt|;
else|else
name|ktrcsw
argument_list|(
operator|(
expr|struct
name|ktr_csw
operator|*
operator|)
name|m
argument_list|)
expr_stmt|;
break|break;
case|case
name|KTR_USER
case|:
name|ktruser
argument_list|(
name|ktrlen
argument_list|,
name|m
argument_list|)
expr_stmt|;
break|break;
case|case
name|KTR_STRUCT
case|:
name|ktrstruct
argument_list|(
name|m
argument_list|,
name|ktrlen
argument_list|)
expr_stmt|;
break|break;
case|case
name|KTR_CAPFAIL
case|:
name|ktrcapfail
argument_list|(
operator|(
expr|struct
name|ktr_cap_fail
operator|*
operator|)
name|m
argument_list|)
expr_stmt|;
break|break;
case|case
name|KTR_FAULT
case|:
name|ktrfault
argument_list|(
operator|(
expr|struct
name|ktr_fault
operator|*
operator|)
name|m
argument_list|)
expr_stmt|;
break|break;
case|case
name|KTR_FAULTEND
case|:
name|ktrfaultend
argument_list|(
operator|(
expr|struct
name|ktr_faultend
operator|*
operator|)
name|m
argument_list|)
expr_stmt|;
break|break;
default|default:
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|tail
condition|)
name|fflush
argument_list|(
name|stdout
argument_list|)
expr_stmt|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
name|void
name|limitfd
parameter_list|(
name|int
name|fd
parameter_list|)
block|{
name|cap_rights_t
name|rights
decl_stmt|;
name|unsigned
name|long
name|cmd
decl_stmt|;
name|cap_rights_init
argument_list|(
operator|&
name|rights
argument_list|,
name|CAP_FSTAT
argument_list|)
expr_stmt|;
name|cmd
operator|=
literal|0
expr_stmt|;
switch|switch
condition|(
name|fd
condition|)
block|{
case|case
name|STDIN_FILENO
case|:
name|cap_rights_set
argument_list|(
operator|&
name|rights
argument_list|,
name|CAP_READ
argument_list|)
expr_stmt|;
break|break;
case|case
name|STDOUT_FILENO
case|:
name|cap_rights_set
argument_list|(
operator|&
name|rights
argument_list|,
name|CAP_IOCTL
argument_list|,
name|CAP_WRITE
argument_list|)
expr_stmt|;
name|cmd
operator|=
name|TIOCGETA
expr_stmt|;
comment|/* required by isatty(3) in printf(3) */
break|break;
case|case
name|STDERR_FILENO
case|:
name|cap_rights_set
argument_list|(
operator|&
name|rights
argument_list|,
name|CAP_WRITE
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|suppressdata
condition|)
block|{
name|cap_rights_set
argument_list|(
operator|&
name|rights
argument_list|,
name|CAP_IOCTL
argument_list|)
expr_stmt|;
name|cmd
operator|=
name|TIOCGWINSZ
expr_stmt|;
block|}
break|break;
default|default:
name|abort
argument_list|()
expr_stmt|;
block|}
if|if
condition|(
name|cap_rights_limit
argument_list|(
name|fd
argument_list|,
operator|&
name|rights
argument_list|)
operator|<
literal|0
operator|&&
name|errno
operator|!=
name|ENOSYS
condition|)
name|err
argument_list|(
literal|1
argument_list|,
literal|"unable to limit rights for descriptor %d"
argument_list|,
name|fd
argument_list|)
expr_stmt|;
if|if
condition|(
name|cmd
operator|!=
literal|0
operator|&&
name|cap_ioctls_limit
argument_list|(
name|fd
argument_list|,
operator|&
name|cmd
argument_list|,
literal|1
argument_list|)
operator|<
literal|0
operator|&&
name|errno
operator|!=
name|ENOSYS
condition|)
name|err
argument_list|(
literal|1
argument_list|,
literal|"unable to limit ioctls for descriptor %d"
argument_list|,
name|fd
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|int
name|fread_tail
parameter_list|(
name|void
modifier|*
name|buf
parameter_list|,
name|int
name|size
parameter_list|,
name|int
name|num
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
while|while
condition|(
operator|(
name|i
operator|=
name|fread
argument_list|(
name|buf
argument_list|,
name|size
argument_list|,
name|num
argument_list|,
name|stdin
argument_list|)
operator|)
operator|==
literal|0
operator|&&
name|tail
condition|)
block|{
name|sleep
argument_list|(
literal|1
argument_list|)
expr_stmt|;
name|clearerr
argument_list|(
name|stdin
argument_list|)
expr_stmt|;
block|}
return|return
operator|(
name|i
operator|)
return|;
block|}
end_function

begin_function
name|int
name|fetchprocinfo
parameter_list|(
name|struct
name|ktr_header
modifier|*
name|kth
parameter_list|,
name|u_int
modifier|*
name|flags
parameter_list|)
block|{
name|struct
name|proc_info
modifier|*
name|pi
decl_stmt|;
switch|switch
condition|(
name|kth
operator|->
name|ktr_type
condition|)
block|{
case|case
name|KTR_PROCCTOR
case|:
name|TAILQ_FOREACH
argument_list|(
argument|pi
argument_list|,
argument|&trace_procs
argument_list|,
argument|info
argument_list|)
block|{
if|if
condition|(
name|pi
operator|->
name|pid
operator|==
name|kth
operator|->
name|ktr_pid
condition|)
block|{
name|TAILQ_REMOVE
argument_list|(
operator|&
name|trace_procs
argument_list|,
name|pi
argument_list|,
name|info
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
name|pi
operator|=
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
expr|struct
name|proc_info
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|pi
operator|==
name|NULL
condition|)
name|errx
argument_list|(
literal|1
argument_list|,
literal|"%s"
argument_list|,
name|strerror
argument_list|(
name|ENOMEM
argument_list|)
argument_list|)
expr_stmt|;
name|pi
operator|->
name|sv_flags
operator|=
operator|*
name|flags
expr_stmt|;
name|pi
operator|->
name|pid
operator|=
name|kth
operator|->
name|ktr_pid
expr_stmt|;
name|TAILQ_INSERT_TAIL
argument_list|(
operator|&
name|trace_procs
argument_list|,
name|pi
argument_list|,
name|info
argument_list|)
expr_stmt|;
return|return
operator|(
literal|1
operator|)
return|;
case|case
name|KTR_PROCDTOR
case|:
name|TAILQ_FOREACH
argument_list|(
argument|pi
argument_list|,
argument|&trace_procs
argument_list|,
argument|info
argument_list|)
block|{
if|if
condition|(
name|pi
operator|->
name|pid
operator|==
name|kth
operator|->
name|ktr_pid
condition|)
block|{
name|TAILQ_REMOVE
argument_list|(
operator|&
name|trace_procs
argument_list|,
name|pi
argument_list|,
name|info
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|pi
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
return|return
operator|(
literal|1
operator|)
return|;
block|}
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
name|u_int
name|abidump
parameter_list|(
name|struct
name|ktr_header
modifier|*
name|kth
parameter_list|)
block|{
name|struct
name|proc_info
modifier|*
name|pi
decl_stmt|;
specifier|const
name|char
modifier|*
name|abi
decl_stmt|;
specifier|const
name|char
modifier|*
name|arch
decl_stmt|;
name|u_int
name|flags
init|=
literal|0
decl_stmt|;
name|TAILQ_FOREACH
argument_list|(
argument|pi
argument_list|,
argument|&trace_procs
argument_list|,
argument|info
argument_list|)
block|{
if|if
condition|(
name|pi
operator|->
name|pid
operator|==
name|kth
operator|->
name|ktr_pid
condition|)
block|{
name|flags
operator|=
name|pi
operator|->
name|sv_flags
expr_stmt|;
break|break;
block|}
block|}
if|if
condition|(
name|abiflag
operator|==
literal|0
condition|)
return|return
operator|(
name|flags
operator|)
return|;
switch|switch
condition|(
name|flags
operator|&
name|SV_ABI_MASK
condition|)
block|{
case|case
name|SV_ABI_LINUX
case|:
name|abi
operator|=
literal|"L"
expr_stmt|;
break|break;
case|case
name|SV_ABI_FREEBSD
case|:
name|abi
operator|=
literal|"F"
expr_stmt|;
break|break;
case|case
name|SV_ABI_CLOUDABI
case|:
name|abi
operator|=
literal|"C"
expr_stmt|;
break|break;
default|default:
name|abi
operator|=
literal|"U"
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|flags
operator|&
name|SV_LP64
condition|)
name|arch
operator|=
literal|"64"
expr_stmt|;
elseif|else
if|if
condition|(
name|flags
operator|&
name|SV_ILP32
condition|)
name|arch
operator|=
literal|"32"
expr_stmt|;
else|else
name|arch
operator|=
literal|"00"
expr_stmt|;
name|printf
argument_list|(
literal|"%s%s  "
argument_list|,
name|abi
argument_list|,
name|arch
argument_list|)
expr_stmt|;
return|return
operator|(
name|flags
operator|)
return|;
block|}
end_function

begin_function
name|void
name|dumpheader
parameter_list|(
name|struct
name|ktr_header
modifier|*
name|kth
parameter_list|)
block|{
specifier|static
name|char
name|unknown
index|[
literal|64
index|]
decl_stmt|;
specifier|static
name|struct
name|timeval
name|prevtime
decl_stmt|,
name|prevtime_e
decl_stmt|;
name|struct
name|timeval
name|temp
decl_stmt|;
specifier|const
name|char
modifier|*
name|type
decl_stmt|;
specifier|const
name|char
modifier|*
name|sign
decl_stmt|;
switch|switch
condition|(
name|kth
operator|->
name|ktr_type
condition|)
block|{
case|case
name|KTR_SYSCALL
case|:
name|type
operator|=
literal|"CALL"
expr_stmt|;
break|break;
case|case
name|KTR_SYSRET
case|:
name|type
operator|=
literal|"RET "
expr_stmt|;
break|break;
case|case
name|KTR_NAMEI
case|:
name|type
operator|=
literal|"NAMI"
expr_stmt|;
break|break;
case|case
name|KTR_GENIO
case|:
name|type
operator|=
literal|"GIO "
expr_stmt|;
break|break;
case|case
name|KTR_PSIG
case|:
name|type
operator|=
literal|"PSIG"
expr_stmt|;
break|break;
case|case
name|KTR_CSW
case|:
name|type
operator|=
literal|"CSW "
expr_stmt|;
break|break;
case|case
name|KTR_USER
case|:
name|type
operator|=
literal|"USER"
expr_stmt|;
break|break;
case|case
name|KTR_STRUCT
case|:
name|type
operator|=
literal|"STRU"
expr_stmt|;
break|break;
case|case
name|KTR_SYSCTL
case|:
name|type
operator|=
literal|"SCTL"
expr_stmt|;
break|break;
case|case
name|KTR_PROCCTOR
case|:
comment|/* FALLTHROUGH */
case|case
name|KTR_PROCDTOR
case|:
return|return;
case|case
name|KTR_CAPFAIL
case|:
name|type
operator|=
literal|"CAP "
expr_stmt|;
break|break;
case|case
name|KTR_FAULT
case|:
name|type
operator|=
literal|"PFLT"
expr_stmt|;
break|break;
case|case
name|KTR_FAULTEND
case|:
name|type
operator|=
literal|"PRET"
expr_stmt|;
break|break;
default|default:
name|sprintf
argument_list|(
name|unknown
argument_list|,
literal|"UNKNOWN(%d)"
argument_list|,
name|kth
operator|->
name|ktr_type
argument_list|)
expr_stmt|;
name|type
operator|=
name|unknown
expr_stmt|;
block|}
comment|/* 	 * The ktr_tid field was previously the ktr_buffer field, which held 	 * the kernel pointer value for the buffer associated with data 	 * following the record header.  It now holds a threadid, but only 	 * for trace files after the change.  Older trace files still contain 	 * kernel pointers.  Detect this and suppress the results by printing 	 * negative tid's as 0. 	 */
if|if
condition|(
name|threads
condition|)
name|printf
argument_list|(
literal|"%6jd %6jd %-8.*s "
argument_list|,
operator|(
name|intmax_t
operator|)
name|kth
operator|->
name|ktr_pid
argument_list|,
name|kth
operator|->
name|ktr_tid
operator|>
literal|0
condition|?
operator|(
name|intmax_t
operator|)
name|kth
operator|->
name|ktr_tid
else|:
literal|0
argument_list|,
name|MAXCOMLEN
argument_list|,
name|kth
operator|->
name|ktr_comm
argument_list|)
expr_stmt|;
else|else
name|printf
argument_list|(
literal|"%6jd %-8.*s "
argument_list|,
operator|(
name|intmax_t
operator|)
name|kth
operator|->
name|ktr_pid
argument_list|,
name|MAXCOMLEN
argument_list|,
name|kth
operator|->
name|ktr_comm
argument_list|)
expr_stmt|;
if|if
condition|(
name|timestamp
condition|)
block|{
if|if
condition|(
name|timestamp
operator|&
name|TIMESTAMP_ABSOLUTE
condition|)
block|{
name|printf
argument_list|(
literal|"%jd.%06ld "
argument_list|,
operator|(
name|intmax_t
operator|)
name|kth
operator|->
name|ktr_time
operator|.
name|tv_sec
argument_list|,
name|kth
operator|->
name|ktr_time
operator|.
name|tv_usec
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|timestamp
operator|&
name|TIMESTAMP_ELAPSED
condition|)
block|{
if|if
condition|(
name|prevtime_e
operator|.
name|tv_sec
operator|==
literal|0
condition|)
name|prevtime_e
operator|=
name|kth
operator|->
name|ktr_time
expr_stmt|;
name|timersub
argument_list|(
operator|&
name|kth
operator|->
name|ktr_time
argument_list|,
operator|&
name|prevtime_e
argument_list|,
operator|&
name|temp
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"%jd.%06ld "
argument_list|,
operator|(
name|intmax_t
operator|)
name|temp
operator|.
name|tv_sec
argument_list|,
name|temp
operator|.
name|tv_usec
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|timestamp
operator|&
name|TIMESTAMP_RELATIVE
condition|)
block|{
if|if
condition|(
name|prevtime
operator|.
name|tv_sec
operator|==
literal|0
condition|)
name|prevtime
operator|=
name|kth
operator|->
name|ktr_time
expr_stmt|;
if|if
condition|(
name|timercmp
argument_list|(
operator|&
name|kth
operator|->
name|ktr_time
argument_list|,
operator|&
name|prevtime
argument_list|,
operator|<
argument_list|)
condition|)
block|{
name|timersub
argument_list|(
operator|&
name|prevtime
argument_list|,
operator|&
name|kth
operator|->
name|ktr_time
argument_list|,
operator|&
name|temp
argument_list|)
expr_stmt|;
name|sign
operator|=
literal|"-"
expr_stmt|;
block|}
else|else
block|{
name|timersub
argument_list|(
operator|&
name|kth
operator|->
name|ktr_time
argument_list|,
operator|&
name|prevtime
argument_list|,
operator|&
name|temp
argument_list|)
expr_stmt|;
name|sign
operator|=
literal|""
expr_stmt|;
block|}
name|prevtime
operator|=
name|kth
operator|->
name|ktr_time
expr_stmt|;
name|printf
argument_list|(
literal|"%s%jd.%06ld "
argument_list|,
name|sign
argument_list|,
operator|(
name|intmax_t
operator|)
name|temp
operator|.
name|tv_sec
argument_list|,
name|temp
operator|.
name|tv_usec
argument_list|)
expr_stmt|;
block|}
block|}
name|printf
argument_list|(
literal|"%s  "
argument_list|,
name|type
argument_list|)
expr_stmt|;
block|}
end_function

begin_include
include|#
directive|include
file|<sys/syscall.h>
end_include

begin_function
specifier|static
name|void
name|ioctlname
parameter_list|(
name|unsigned
name|long
name|val
parameter_list|)
block|{
specifier|const
name|char
modifier|*
name|str
decl_stmt|;
name|str
operator|=
name|sysdecode_ioctlname
argument_list|(
name|val
argument_list|)
expr_stmt|;
if|if
condition|(
name|str
operator|!=
name|NULL
condition|)
name|printf
argument_list|(
literal|"%s"
argument_list|,
name|str
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|decimal
condition|)
name|printf
argument_list|(
literal|"%lu"
argument_list|,
name|val
argument_list|)
expr_stmt|;
else|else
name|printf
argument_list|(
literal|"%#lx"
argument_list|,
name|val
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|enum
name|sysdecode_abi
name|syscallabi
parameter_list|(
name|u_int
name|sv_flags
parameter_list|)
block|{
if|if
condition|(
name|sv_flags
operator|==
literal|0
condition|)
return|return
operator|(
name|SYSDECODE_ABI_FREEBSD
operator|)
return|;
switch|switch
condition|(
name|sv_flags
operator|&
name|SV_ABI_MASK
condition|)
block|{
case|case
name|SV_ABI_FREEBSD
case|:
return|return
operator|(
name|SYSDECODE_ABI_FREEBSD
operator|)
return|;
if|#
directive|if
name|defined
argument_list|(
name|__amd64__
argument_list|)
operator|||
name|defined
argument_list|(
name|__i386__
argument_list|)
case|case
name|SV_ABI_LINUX
case|:
ifdef|#
directive|ifdef
name|__amd64__
if|if
condition|(
name|sv_flags
operator|&
name|SV_ILP32
condition|)
return|return
operator|(
name|SYSDECODE_ABI_LINUX32
operator|)
return|;
endif|#
directive|endif
return|return
operator|(
name|SYSDECODE_ABI_LINUX
operator|)
return|;
endif|#
directive|endif
if|#
directive|if
name|defined
argument_list|(
name|__aarch64__
argument_list|)
operator|||
name|defined
argument_list|(
name|__amd64__
argument_list|)
case|case
name|SV_ABI_CLOUDABI
case|:
return|return
operator|(
name|SYSDECODE_ABI_CLOUDABI64
operator|)
return|;
endif|#
directive|endif
default|default:
return|return
operator|(
name|SYSDECODE_ABI_UNKNOWN
operator|)
return|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|syscallname
parameter_list|(
name|u_int
name|code
parameter_list|,
name|u_int
name|sv_flags
parameter_list|)
block|{
specifier|const
name|char
modifier|*
name|name
decl_stmt|;
name|name
operator|=
name|sysdecode_syscallname
argument_list|(
name|syscallabi
argument_list|(
name|sv_flags
argument_list|)
argument_list|,
name|code
argument_list|)
expr_stmt|;
if|if
condition|(
name|name
operator|==
name|NULL
condition|)
name|printf
argument_list|(
literal|"[%d]"
argument_list|,
name|code
argument_list|)
expr_stmt|;
else|else
block|{
name|printf
argument_list|(
literal|"%s"
argument_list|,
name|name
argument_list|)
expr_stmt|;
if|if
condition|(
name|syscallno
condition|)
name|printf
argument_list|(
literal|"[%d]"
argument_list|,
name|code
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|print_signal
parameter_list|(
name|int
name|signo
parameter_list|)
block|{
specifier|const
name|char
modifier|*
name|signame
decl_stmt|;
name|signame
operator|=
name|sysdecode_signal
argument_list|(
name|signo
argument_list|)
expr_stmt|;
if|if
condition|(
name|signame
operator|!=
name|NULL
condition|)
name|printf
argument_list|(
literal|"%s"
argument_list|,
name|signame
argument_list|)
expr_stmt|;
else|else
name|printf
argument_list|(
literal|"SIG %d"
argument_list|,
name|signo
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|ktrsyscall
parameter_list|(
name|struct
name|ktr_syscall
modifier|*
name|ktr
parameter_list|,
name|u_int
name|sv_flags
parameter_list|)
block|{
name|int
name|narg
init|=
name|ktr
operator|->
name|ktr_narg
decl_stmt|;
name|register_t
modifier|*
name|ip
decl_stmt|,
modifier|*
name|first
decl_stmt|;
name|intmax_t
name|arg
decl_stmt|;
name|int
name|quad_align
decl_stmt|,
name|quad_slots
decl_stmt|;
name|syscallname
argument_list|(
name|ktr
operator|->
name|ktr_code
argument_list|,
name|sv_flags
argument_list|)
expr_stmt|;
name|ip
operator|=
name|first
operator|=
operator|&
name|ktr
operator|->
name|ktr_args
index|[
literal|0
index|]
expr_stmt|;
if|if
condition|(
name|narg
condition|)
block|{
name|char
name|c
init|=
literal|'('
decl_stmt|;
if|if
condition|(
name|fancy
operator|&&
operator|(
name|sv_flags
operator|==
literal|0
operator|||
operator|(
name|sv_flags
operator|&
name|SV_ABI_MASK
operator|)
operator|==
name|SV_ABI_FREEBSD
operator|)
condition|)
block|{
name|quad_align
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|sv_flags
operator|&
name|SV_ILP32
condition|)
block|{
ifdef|#
directive|ifdef
name|__powerpc__
name|quad_align
operator|=
literal|1
expr_stmt|;
endif|#
directive|endif
name|quad_slots
operator|=
literal|2
expr_stmt|;
block|}
else|else
name|quad_slots
operator|=
literal|1
expr_stmt|;
switch|switch
condition|(
name|ktr
operator|->
name|ktr_code
condition|)
block|{
case|case
name|SYS_bindat
case|:
case|case
name|SYS_chflagsat
case|:
case|case
name|SYS_connectat
case|:
case|case
name|SYS_faccessat
case|:
case|case
name|SYS_fchmodat
case|:
case|case
name|SYS_fchownat
case|:
case|case
name|SYS_fstatat
case|:
case|case
name|SYS_futimesat
case|:
case|case
name|SYS_linkat
case|:
case|case
name|SYS_mkdirat
case|:
case|case
name|SYS_mkfifoat
case|:
case|case
name|SYS_mknodat
case|:
case|case
name|SYS_openat
case|:
case|case
name|SYS_readlinkat
case|:
case|case
name|SYS_renameat
case|:
case|case
name|SYS_unlinkat
case|:
case|case
name|SYS_utimensat
case|:
name|putchar
argument_list|(
literal|'('
argument_list|)
expr_stmt|;
name|print_integer_arg_valid
argument_list|(
name|sysdecode_atfd
argument_list|,
operator|*
name|ip
argument_list|)
expr_stmt|;
name|c
operator|=
literal|','
expr_stmt|;
name|ip
operator|++
expr_stmt|;
name|narg
operator|--
expr_stmt|;
break|break;
block|}
switch|switch
condition|(
name|ktr
operator|->
name|ktr_code
condition|)
block|{
case|case
name|SYS_ioctl
case|:
block|{
name|print_number
argument_list|(
name|ip
argument_list|,
name|narg
argument_list|,
name|c
argument_list|)
expr_stmt|;
name|putchar
argument_list|(
name|c
argument_list|)
expr_stmt|;
name|ioctlname
argument_list|(
operator|*
name|ip
argument_list|)
expr_stmt|;
name|c
operator|=
literal|','
expr_stmt|;
name|ip
operator|++
expr_stmt|;
name|narg
operator|--
expr_stmt|;
break|break;
block|}
case|case
name|SYS_ptrace
case|:
name|putchar
argument_list|(
literal|'('
argument_list|)
expr_stmt|;
name|print_integer_arg
argument_list|(
name|sysdecode_ptrace_request
argument_list|,
operator|*
name|ip
argument_list|)
expr_stmt|;
name|c
operator|=
literal|','
expr_stmt|;
name|ip
operator|++
expr_stmt|;
name|narg
operator|--
expr_stmt|;
break|break;
case|case
name|SYS_access
case|:
case|case
name|SYS_eaccess
case|:
case|case
name|SYS_faccessat
case|:
name|print_number
argument_list|(
name|ip
argument_list|,
name|narg
argument_list|,
name|c
argument_list|)
expr_stmt|;
name|putchar
argument_list|(
literal|','
argument_list|)
expr_stmt|;
name|print_mask_arg
argument_list|(
name|sysdecode_access_mode
argument_list|,
operator|*
name|ip
argument_list|)
expr_stmt|;
name|ip
operator|++
expr_stmt|;
name|narg
operator|--
expr_stmt|;
break|break;
case|case
name|SYS_open
case|:
case|case
name|SYS_openat
case|:
name|print_number
argument_list|(
name|ip
argument_list|,
name|narg
argument_list|,
name|c
argument_list|)
expr_stmt|;
name|putchar
argument_list|(
literal|','
argument_list|)
expr_stmt|;
name|print_mask_arg
argument_list|(
name|sysdecode_open_flags
argument_list|,
name|ip
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|ip
index|[
literal|0
index|]
operator|&
name|O_CREAT
operator|)
operator|==
name|O_CREAT
condition|)
block|{
name|putchar
argument_list|(
literal|','
argument_list|)
expr_stmt|;
name|decode_filemode
argument_list|(
name|ip
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
block|}
name|ip
operator|+=
literal|2
expr_stmt|;
name|narg
operator|-=
literal|2
expr_stmt|;
break|break;
case|case
name|SYS_wait4
case|:
name|print_number
argument_list|(
name|ip
argument_list|,
name|narg
argument_list|,
name|c
argument_list|)
expr_stmt|;
name|print_number
argument_list|(
name|ip
argument_list|,
name|narg
argument_list|,
name|c
argument_list|)
expr_stmt|;
name|putchar
argument_list|(
literal|','
argument_list|)
expr_stmt|;
name|print_mask_arg0
argument_list|(
name|sysdecode_wait4_options
argument_list|,
operator|*
name|ip
argument_list|)
expr_stmt|;
name|ip
operator|++
expr_stmt|;
name|narg
operator|--
expr_stmt|;
break|break;
case|case
name|SYS_wait6
case|:
name|putchar
argument_list|(
literal|'('
argument_list|)
expr_stmt|;
name|print_integer_arg
argument_list|(
name|sysdecode_idtype
argument_list|,
operator|*
name|ip
argument_list|)
expr_stmt|;
name|c
operator|=
literal|','
expr_stmt|;
name|ip
operator|++
expr_stmt|;
name|narg
operator|--
expr_stmt|;
name|print_number64
argument_list|(
name|first
argument_list|,
name|ip
argument_list|,
name|narg
argument_list|,
name|c
argument_list|)
expr_stmt|;
name|print_number
argument_list|(
name|ip
argument_list|,
name|narg
argument_list|,
name|c
argument_list|)
expr_stmt|;
name|putchar
argument_list|(
literal|','
argument_list|)
expr_stmt|;
name|print_mask_arg
argument_list|(
name|sysdecode_wait6_options
argument_list|,
operator|*
name|ip
argument_list|)
expr_stmt|;
name|ip
operator|++
expr_stmt|;
name|narg
operator|--
expr_stmt|;
break|break;
case|case
name|SYS_chmod
case|:
case|case
name|SYS_fchmod
case|:
case|case
name|SYS_lchmod
case|:
case|case
name|SYS_fchmodat
case|:
name|print_number
argument_list|(
name|ip
argument_list|,
name|narg
argument_list|,
name|c
argument_list|)
expr_stmt|;
name|putchar
argument_list|(
literal|','
argument_list|)
expr_stmt|;
name|decode_filemode
argument_list|(
operator|*
name|ip
argument_list|)
expr_stmt|;
name|ip
operator|++
expr_stmt|;
name|narg
operator|--
expr_stmt|;
break|break;
case|case
name|SYS_mknod
case|:
case|case
name|SYS_mknodat
case|:
name|print_number
argument_list|(
name|ip
argument_list|,
name|narg
argument_list|,
name|c
argument_list|)
expr_stmt|;
name|putchar
argument_list|(
literal|','
argument_list|)
expr_stmt|;
name|decode_filemode
argument_list|(
operator|*
name|ip
argument_list|)
expr_stmt|;
name|ip
operator|++
expr_stmt|;
name|narg
operator|--
expr_stmt|;
break|break;
case|case
name|SYS_getfsstat
case|:
name|print_number
argument_list|(
name|ip
argument_list|,
name|narg
argument_list|,
name|c
argument_list|)
expr_stmt|;
name|print_number
argument_list|(
name|ip
argument_list|,
name|narg
argument_list|,
name|c
argument_list|)
expr_stmt|;
name|putchar
argument_list|(
literal|','
argument_list|)
expr_stmt|;
name|print_integer_arg
argument_list|(
name|sysdecode_getfsstat_mode
argument_list|,
operator|*
name|ip
argument_list|)
expr_stmt|;
name|ip
operator|++
expr_stmt|;
name|narg
operator|--
expr_stmt|;
break|break;
case|case
name|SYS_mount
case|:
name|print_number
argument_list|(
name|ip
argument_list|,
name|narg
argument_list|,
name|c
argument_list|)
expr_stmt|;
name|print_number
argument_list|(
name|ip
argument_list|,
name|narg
argument_list|,
name|c
argument_list|)
expr_stmt|;
name|putchar
argument_list|(
literal|','
argument_list|)
expr_stmt|;
name|print_mask_arg
argument_list|(
name|sysdecode_mount_flags
argument_list|,
operator|*
name|ip
argument_list|)
expr_stmt|;
name|ip
operator|++
expr_stmt|;
name|narg
operator|--
expr_stmt|;
break|break;
case|case
name|SYS_unmount
case|:
name|print_number
argument_list|(
name|ip
argument_list|,
name|narg
argument_list|,
name|c
argument_list|)
expr_stmt|;
name|putchar
argument_list|(
literal|','
argument_list|)
expr_stmt|;
name|print_mask_arg
argument_list|(
name|sysdecode_mount_flags
argument_list|,
operator|*
name|ip
argument_list|)
expr_stmt|;
name|ip
operator|++
expr_stmt|;
name|narg
operator|--
expr_stmt|;
break|break;
case|case
name|SYS_recvmsg
case|:
case|case
name|SYS_sendmsg
case|:
name|print_number
argument_list|(
name|ip
argument_list|,
name|narg
argument_list|,
name|c
argument_list|)
expr_stmt|;
name|print_number
argument_list|(
name|ip
argument_list|,
name|narg
argument_list|,
name|c
argument_list|)
expr_stmt|;
name|putchar
argument_list|(
literal|','
argument_list|)
expr_stmt|;
name|print_mask_arg0
argument_list|(
name|sysdecode_msg_flags
argument_list|,
operator|*
name|ip
argument_list|)
expr_stmt|;
name|ip
operator|++
expr_stmt|;
name|narg
operator|--
expr_stmt|;
break|break;
case|case
name|SYS_recvfrom
case|:
case|case
name|SYS_sendto
case|:
name|print_number
argument_list|(
name|ip
argument_list|,
name|narg
argument_list|,
name|c
argument_list|)
expr_stmt|;
name|print_number
argument_list|(
name|ip
argument_list|,
name|narg
argument_list|,
name|c
argument_list|)
expr_stmt|;
name|print_number
argument_list|(
name|ip
argument_list|,
name|narg
argument_list|,
name|c
argument_list|)
expr_stmt|;
name|putchar
argument_list|(
literal|','
argument_list|)
expr_stmt|;
name|print_mask_arg0
argument_list|(
name|sysdecode_msg_flags
argument_list|,
operator|*
name|ip
argument_list|)
expr_stmt|;
name|ip
operator|++
expr_stmt|;
name|narg
operator|--
expr_stmt|;
break|break;
case|case
name|SYS_chflags
case|:
case|case
name|SYS_chflagsat
case|:
case|case
name|SYS_fchflags
case|:
case|case
name|SYS_lchflags
case|:
name|print_number
argument_list|(
name|ip
argument_list|,
name|narg
argument_list|,
name|c
argument_list|)
expr_stmt|;
name|putchar
argument_list|(
literal|','
argument_list|)
expr_stmt|;
name|decode_fileflags
argument_list|(
operator|*
name|ip
argument_list|)
expr_stmt|;
name|ip
operator|++
expr_stmt|;
name|narg
operator|--
expr_stmt|;
break|break;
case|case
name|SYS_kill
case|:
name|print_number
argument_list|(
name|ip
argument_list|,
name|narg
argument_list|,
name|c
argument_list|)
expr_stmt|;
name|putchar
argument_list|(
literal|','
argument_list|)
expr_stmt|;
name|print_signal
argument_list|(
operator|*
name|ip
argument_list|)
expr_stmt|;
name|ip
operator|++
expr_stmt|;
name|narg
operator|--
expr_stmt|;
break|break;
case|case
name|SYS_reboot
case|:
name|putchar
argument_list|(
literal|'('
argument_list|)
expr_stmt|;
name|print_mask_arg
argument_list|(
name|sysdecode_reboot_howto
argument_list|,
operator|*
name|ip
argument_list|)
expr_stmt|;
name|ip
operator|++
expr_stmt|;
name|narg
operator|--
expr_stmt|;
break|break;
case|case
name|SYS_umask
case|:
name|putchar
argument_list|(
literal|'('
argument_list|)
expr_stmt|;
name|decode_filemode
argument_list|(
operator|*
name|ip
argument_list|)
expr_stmt|;
name|ip
operator|++
expr_stmt|;
name|narg
operator|--
expr_stmt|;
break|break;
case|case
name|SYS_msync
case|:
name|print_number
argument_list|(
name|ip
argument_list|,
name|narg
argument_list|,
name|c
argument_list|)
expr_stmt|;
name|print_number
argument_list|(
name|ip
argument_list|,
name|narg
argument_list|,
name|c
argument_list|)
expr_stmt|;
name|putchar
argument_list|(
literal|','
argument_list|)
expr_stmt|;
name|print_mask_arg
argument_list|(
name|sysdecode_msync_flags
argument_list|,
operator|*
name|ip
argument_list|)
expr_stmt|;
name|ip
operator|++
expr_stmt|;
name|narg
operator|--
expr_stmt|;
break|break;
ifdef|#
directive|ifdef
name|SYS_freebsd6_mmap
case|case
name|SYS_freebsd6_mmap
case|:
name|print_number
argument_list|(
name|ip
argument_list|,
name|narg
argument_list|,
name|c
argument_list|)
expr_stmt|;
name|print_number
argument_list|(
name|ip
argument_list|,
name|narg
argument_list|,
name|c
argument_list|)
expr_stmt|;
name|putchar
argument_list|(
literal|','
argument_list|)
expr_stmt|;
name|print_mask_arg
argument_list|(
name|sysdecode_mmap_prot
argument_list|,
operator|*
name|ip
argument_list|)
expr_stmt|;
name|putchar
argument_list|(
literal|','
argument_list|)
expr_stmt|;
name|ip
operator|++
expr_stmt|;
name|narg
operator|--
expr_stmt|;
name|print_mask_arg
argument_list|(
name|sysdecode_mmap_flags
argument_list|,
operator|*
name|ip
argument_list|)
expr_stmt|;
name|ip
operator|++
expr_stmt|;
name|narg
operator|--
expr_stmt|;
break|break;
endif|#
directive|endif
case|case
name|SYS_mmap
case|:
name|print_number
argument_list|(
name|ip
argument_list|,
name|narg
argument_list|,
name|c
argument_list|)
expr_stmt|;
name|print_number
argument_list|(
name|ip
argument_list|,
name|narg
argument_list|,
name|c
argument_list|)
expr_stmt|;
name|putchar
argument_list|(
literal|','
argument_list|)
expr_stmt|;
name|print_mask_arg
argument_list|(
name|sysdecode_mmap_prot
argument_list|,
operator|*
name|ip
argument_list|)
expr_stmt|;
name|putchar
argument_list|(
literal|','
argument_list|)
expr_stmt|;
name|ip
operator|++
expr_stmt|;
name|narg
operator|--
expr_stmt|;
name|print_mask_arg
argument_list|(
name|sysdecode_mmap_flags
argument_list|,
operator|*
name|ip
argument_list|)
expr_stmt|;
name|ip
operator|++
expr_stmt|;
name|narg
operator|--
expr_stmt|;
break|break;
case|case
name|SYS_mprotect
case|:
name|print_number
argument_list|(
name|ip
argument_list|,
name|narg
argument_list|,
name|c
argument_list|)
expr_stmt|;
name|print_number
argument_list|(
name|ip
argument_list|,
name|narg
argument_list|,
name|c
argument_list|)
expr_stmt|;
name|putchar
argument_list|(
literal|','
argument_list|)
expr_stmt|;
name|print_mask_arg
argument_list|(
name|sysdecode_mmap_prot
argument_list|,
operator|*
name|ip
argument_list|)
expr_stmt|;
name|ip
operator|++
expr_stmt|;
name|narg
operator|--
expr_stmt|;
break|break;
case|case
name|SYS_madvise
case|:
name|print_number
argument_list|(
name|ip
argument_list|,
name|narg
argument_list|,
name|c
argument_list|)
expr_stmt|;
name|print_number
argument_list|(
name|ip
argument_list|,
name|narg
argument_list|,
name|c
argument_list|)
expr_stmt|;
name|putchar
argument_list|(
literal|','
argument_list|)
expr_stmt|;
name|print_integer_arg
argument_list|(
name|sysdecode_madvice
argument_list|,
operator|*
name|ip
argument_list|)
expr_stmt|;
name|ip
operator|++
expr_stmt|;
name|narg
operator|--
expr_stmt|;
break|break;
case|case
name|SYS_setpriority
case|:
name|print_number
argument_list|(
name|ip
argument_list|,
name|narg
argument_list|,
name|c
argument_list|)
expr_stmt|;
name|print_number
argument_list|(
name|ip
argument_list|,
name|narg
argument_list|,
name|c
argument_list|)
expr_stmt|;
name|putchar
argument_list|(
literal|','
argument_list|)
expr_stmt|;
name|print_integer_arg
argument_list|(
name|sysdecode_prio_which
argument_list|,
operator|*
name|ip
argument_list|)
expr_stmt|;
name|ip
operator|++
expr_stmt|;
name|narg
operator|--
expr_stmt|;
break|break;
case|case
name|SYS_fcntl
case|:
name|print_number
argument_list|(
name|ip
argument_list|,
name|narg
argument_list|,
name|c
argument_list|)
expr_stmt|;
name|putchar
argument_list|(
literal|','
argument_list|)
expr_stmt|;
name|print_integer_arg
argument_list|(
name|sysdecode_fcntl_cmd
argument_list|,
name|ip
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|sysdecode_fcntl_arg_p
argument_list|(
name|ip
index|[
literal|0
index|]
argument_list|)
condition|)
block|{
name|putchar
argument_list|(
literal|','
argument_list|)
expr_stmt|;
if|if
condition|(
name|ip
index|[
literal|0
index|]
operator|==
name|F_SETFL
condition|)
name|print_mask_arg
argument_list|(
name|sysdecode_fcntl_fileflags
argument_list|,
name|ip
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
else|else
name|sysdecode_fcntl_arg
argument_list|(
name|stdout
argument_list|,
name|ip
index|[
literal|0
index|]
argument_list|,
name|ip
index|[
literal|1
index|]
argument_list|,
name|decimal
condition|?
literal|10
else|:
literal|16
argument_list|)
expr_stmt|;
block|}
name|ip
operator|+=
literal|2
expr_stmt|;
name|narg
operator|-=
literal|2
expr_stmt|;
break|break;
case|case
name|SYS_socket
case|:
block|{
name|int
name|sockdomain
decl_stmt|;
name|putchar
argument_list|(
literal|'('
argument_list|)
expr_stmt|;
name|sockdomain
operator|=
operator|*
name|ip
expr_stmt|;
name|print_integer_arg
argument_list|(
name|sysdecode_socketdomain
argument_list|,
name|sockdomain
argument_list|)
expr_stmt|;
name|ip
operator|++
expr_stmt|;
name|narg
operator|--
expr_stmt|;
name|putchar
argument_list|(
literal|','
argument_list|)
expr_stmt|;
name|print_mask_arg
argument_list|(
name|sysdecode_socket_type
argument_list|,
operator|*
name|ip
argument_list|)
expr_stmt|;
name|ip
operator|++
expr_stmt|;
name|narg
operator|--
expr_stmt|;
if|if
condition|(
name|sockdomain
operator|==
name|PF_INET
operator|||
name|sockdomain
operator|==
name|PF_INET6
condition|)
block|{
name|putchar
argument_list|(
literal|','
argument_list|)
expr_stmt|;
name|print_integer_arg
argument_list|(
name|sysdecode_ipproto
argument_list|,
operator|*
name|ip
argument_list|)
expr_stmt|;
name|ip
operator|++
expr_stmt|;
name|narg
operator|--
expr_stmt|;
block|}
name|c
operator|=
literal|','
expr_stmt|;
break|break;
block|}
case|case
name|SYS_setsockopt
case|:
case|case
name|SYS_getsockopt
case|:
block|{
specifier|const
name|char
modifier|*
name|str
decl_stmt|;
name|print_number
argument_list|(
name|ip
argument_list|,
name|narg
argument_list|,
name|c
argument_list|)
expr_stmt|;
name|putchar
argument_list|(
literal|','
argument_list|)
expr_stmt|;
name|print_integer_arg_valid
argument_list|(
name|sysdecode_sockopt_level
argument_list|,
operator|*
name|ip
argument_list|)
expr_stmt|;
name|str
operator|=
name|sysdecode_sockopt_name
argument_list|(
name|ip
index|[
literal|0
index|]
argument_list|,
name|ip
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|str
operator|!=
name|NULL
condition|)
block|{
name|printf
argument_list|(
literal|",%s"
argument_list|,
name|str
argument_list|)
expr_stmt|;
name|ip
operator|++
expr_stmt|;
name|narg
operator|--
expr_stmt|;
block|}
name|ip
operator|++
expr_stmt|;
name|narg
operator|--
expr_stmt|;
break|break;
block|}
ifdef|#
directive|ifdef
name|SYS_freebsd6_lseek
case|case
name|SYS_freebsd6_lseek
case|:
name|print_number
argument_list|(
name|ip
argument_list|,
name|narg
argument_list|,
name|c
argument_list|)
expr_stmt|;
comment|/* Hidden 'pad' argument, not in lseek(2) */
name|print_number
argument_list|(
name|ip
argument_list|,
name|narg
argument_list|,
name|c
argument_list|)
expr_stmt|;
name|print_number64
argument_list|(
name|first
argument_list|,
name|ip
argument_list|,
name|narg
argument_list|,
name|c
argument_list|)
expr_stmt|;
name|putchar
argument_list|(
literal|','
argument_list|)
expr_stmt|;
name|print_integer_arg
argument_list|(
name|sysdecode_whence
argument_list|,
operator|*
name|ip
argument_list|)
expr_stmt|;
name|ip
operator|++
expr_stmt|;
name|narg
operator|--
expr_stmt|;
break|break;
endif|#
directive|endif
case|case
name|SYS_lseek
case|:
name|print_number
argument_list|(
name|ip
argument_list|,
name|narg
argument_list|,
name|c
argument_list|)
expr_stmt|;
name|print_number64
argument_list|(
name|first
argument_list|,
name|ip
argument_list|,
name|narg
argument_list|,
name|c
argument_list|)
expr_stmt|;
name|putchar
argument_list|(
literal|','
argument_list|)
expr_stmt|;
name|print_integer_arg
argument_list|(
name|sysdecode_whence
argument_list|,
operator|*
name|ip
argument_list|)
expr_stmt|;
name|ip
operator|++
expr_stmt|;
name|narg
operator|--
expr_stmt|;
break|break;
case|case
name|SYS_flock
case|:
name|print_number
argument_list|(
name|ip
argument_list|,
name|narg
argument_list|,
name|c
argument_list|)
expr_stmt|;
name|putchar
argument_list|(
literal|','
argument_list|)
expr_stmt|;
name|print_mask_arg
argument_list|(
name|sysdecode_flock_operation
argument_list|,
operator|*
name|ip
argument_list|)
expr_stmt|;
name|ip
operator|++
expr_stmt|;
name|narg
operator|--
expr_stmt|;
break|break;
case|case
name|SYS_mkfifo
case|:
case|case
name|SYS_mkfifoat
case|:
case|case
name|SYS_mkdir
case|:
case|case
name|SYS_mkdirat
case|:
name|print_number
argument_list|(
name|ip
argument_list|,
name|narg
argument_list|,
name|c
argument_list|)
expr_stmt|;
name|putchar
argument_list|(
literal|','
argument_list|)
expr_stmt|;
name|decode_filemode
argument_list|(
operator|*
name|ip
argument_list|)
expr_stmt|;
name|ip
operator|++
expr_stmt|;
name|narg
operator|--
expr_stmt|;
break|break;
case|case
name|SYS_shutdown
case|:
name|print_number
argument_list|(
name|ip
argument_list|,
name|narg
argument_list|,
name|c
argument_list|)
expr_stmt|;
name|putchar
argument_list|(
literal|','
argument_list|)
expr_stmt|;
name|print_integer_arg
argument_list|(
name|sysdecode_shutdown_how
argument_list|,
operator|*
name|ip
argument_list|)
expr_stmt|;
name|ip
operator|++
expr_stmt|;
name|narg
operator|--
expr_stmt|;
break|break;
case|case
name|SYS_socketpair
case|:
name|putchar
argument_list|(
literal|'('
argument_list|)
expr_stmt|;
name|print_integer_arg
argument_list|(
name|sysdecode_socketdomain
argument_list|,
operator|*
name|ip
argument_list|)
expr_stmt|;
name|ip
operator|++
expr_stmt|;
name|narg
operator|--
expr_stmt|;
name|putchar
argument_list|(
literal|','
argument_list|)
expr_stmt|;
name|print_mask_arg
argument_list|(
name|sysdecode_socket_type
argument_list|,
operator|*
name|ip
argument_list|)
expr_stmt|;
name|ip
operator|++
expr_stmt|;
name|narg
operator|--
expr_stmt|;
name|c
operator|=
literal|','
expr_stmt|;
break|break;
case|case
name|SYS_getrlimit
case|:
case|case
name|SYS_setrlimit
case|:
name|putchar
argument_list|(
literal|'('
argument_list|)
expr_stmt|;
name|print_integer_arg
argument_list|(
name|sysdecode_rlimit
argument_list|,
operator|*
name|ip
argument_list|)
expr_stmt|;
name|ip
operator|++
expr_stmt|;
name|narg
operator|--
expr_stmt|;
name|c
operator|=
literal|','
expr_stmt|;
break|break;
case|case
name|SYS_quotactl
case|:
name|print_number
argument_list|(
name|ip
argument_list|,
name|narg
argument_list|,
name|c
argument_list|)
expr_stmt|;
name|putchar
argument_list|(
literal|','
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|sysdecode_quotactl_cmd
argument_list|(
name|stdout
argument_list|,
operator|*
name|ip
argument_list|)
condition|)
block|{
if|if
condition|(
name|decimal
condition|)
name|printf
argument_list|(
literal|"<invalid=%d>"
argument_list|,
operator|(
name|int
operator|)
operator|*
name|ip
argument_list|)
expr_stmt|;
else|else
name|printf
argument_list|(
literal|"<invalid=%#x>"
argument_list|,
operator|(
name|int
operator|)
operator|*
name|ip
argument_list|)
expr_stmt|;
block|}
name|ip
operator|++
expr_stmt|;
name|narg
operator|--
expr_stmt|;
name|c
operator|=
literal|','
expr_stmt|;
break|break;
case|case
name|SYS_nfssvc
case|:
name|putchar
argument_list|(
literal|'('
argument_list|)
expr_stmt|;
name|print_integer_arg
argument_list|(
name|sysdecode_nfssvc_flags
argument_list|,
operator|*
name|ip
argument_list|)
expr_stmt|;
name|ip
operator|++
expr_stmt|;
name|narg
operator|--
expr_stmt|;
name|c
operator|=
literal|','
expr_stmt|;
break|break;
case|case
name|SYS_rtprio
case|:
name|putchar
argument_list|(
literal|'('
argument_list|)
expr_stmt|;
name|print_integer_arg
argument_list|(
name|sysdecode_rtprio_function
argument_list|,
operator|*
name|ip
argument_list|)
expr_stmt|;
name|ip
operator|++
expr_stmt|;
name|narg
operator|--
expr_stmt|;
name|c
operator|=
literal|','
expr_stmt|;
break|break;
case|case
name|SYS___semctl
case|:
name|print_number
argument_list|(
name|ip
argument_list|,
name|narg
argument_list|,
name|c
argument_list|)
expr_stmt|;
name|print_number
argument_list|(
name|ip
argument_list|,
name|narg
argument_list|,
name|c
argument_list|)
expr_stmt|;
name|putchar
argument_list|(
literal|','
argument_list|)
expr_stmt|;
name|print_integer_arg
argument_list|(
name|sysdecode_semctl_cmd
argument_list|,
operator|*
name|ip
argument_list|)
expr_stmt|;
name|ip
operator|++
expr_stmt|;
name|narg
operator|--
expr_stmt|;
break|break;
case|case
name|SYS_semget
case|:
name|print_number
argument_list|(
name|ip
argument_list|,
name|narg
argument_list|,
name|c
argument_list|)
expr_stmt|;
name|print_number
argument_list|(
name|ip
argument_list|,
name|narg
argument_list|,
name|c
argument_list|)
expr_stmt|;
name|putchar
argument_list|(
literal|','
argument_list|)
expr_stmt|;
name|print_mask_arg
argument_list|(
name|sysdecode_semget_flags
argument_list|,
operator|*
name|ip
argument_list|)
expr_stmt|;
name|ip
operator|++
expr_stmt|;
name|narg
operator|--
expr_stmt|;
break|break;
case|case
name|SYS_msgctl
case|:
name|print_number
argument_list|(
name|ip
argument_list|,
name|narg
argument_list|,
name|c
argument_list|)
expr_stmt|;
name|putchar
argument_list|(
literal|','
argument_list|)
expr_stmt|;
name|print_integer_arg
argument_list|(
name|sysdecode_msgctl_cmd
argument_list|,
operator|*
name|ip
argument_list|)
expr_stmt|;
name|ip
operator|++
expr_stmt|;
name|narg
operator|--
expr_stmt|;
break|break;
case|case
name|SYS_shmat
case|:
name|print_number
argument_list|(
name|ip
argument_list|,
name|narg
argument_list|,
name|c
argument_list|)
expr_stmt|;
name|print_number
argument_list|(
name|ip
argument_list|,
name|narg
argument_list|,
name|c
argument_list|)
expr_stmt|;
name|putchar
argument_list|(
literal|','
argument_list|)
expr_stmt|;
name|print_mask_arg
argument_list|(
name|sysdecode_shmat_flags
argument_list|,
operator|*
name|ip
argument_list|)
expr_stmt|;
name|ip
operator|++
expr_stmt|;
name|narg
operator|--
expr_stmt|;
break|break;
case|case
name|SYS_shmctl
case|:
name|print_number
argument_list|(
name|ip
argument_list|,
name|narg
argument_list|,
name|c
argument_list|)
expr_stmt|;
name|putchar
argument_list|(
literal|','
argument_list|)
expr_stmt|;
name|print_integer_arg
argument_list|(
name|sysdecode_shmctl_cmd
argument_list|,
operator|*
name|ip
argument_list|)
expr_stmt|;
name|ip
operator|++
expr_stmt|;
name|narg
operator|--
expr_stmt|;
break|break;
case|case
name|SYS_shm_open
case|:
name|print_number
argument_list|(
name|ip
argument_list|,
name|narg
argument_list|,
name|c
argument_list|)
expr_stmt|;
name|putchar
argument_list|(
literal|','
argument_list|)
expr_stmt|;
name|print_mask_arg
argument_list|(
name|sysdecode_open_flags
argument_list|,
name|ip
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
name|putchar
argument_list|(
literal|','
argument_list|)
expr_stmt|;
name|decode_filemode
argument_list|(
name|ip
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
name|ip
operator|+=
literal|2
expr_stmt|;
name|narg
operator|-=
literal|2
expr_stmt|;
break|break;
case|case
name|SYS_minherit
case|:
name|print_number
argument_list|(
name|ip
argument_list|,
name|narg
argument_list|,
name|c
argument_list|)
expr_stmt|;
name|print_number
argument_list|(
name|ip
argument_list|,
name|narg
argument_list|,
name|c
argument_list|)
expr_stmt|;
name|putchar
argument_list|(
literal|','
argument_list|)
expr_stmt|;
name|print_integer_arg
argument_list|(
name|sysdecode_minherit_inherit
argument_list|,
operator|*
name|ip
argument_list|)
expr_stmt|;
name|ip
operator|++
expr_stmt|;
name|narg
operator|--
expr_stmt|;
break|break;
case|case
name|SYS_rfork
case|:
name|putchar
argument_list|(
literal|'('
argument_list|)
expr_stmt|;
name|print_mask_arg
argument_list|(
name|sysdecode_rfork_flags
argument_list|,
operator|*
name|ip
argument_list|)
expr_stmt|;
name|ip
operator|++
expr_stmt|;
name|narg
operator|--
expr_stmt|;
name|c
operator|=
literal|','
expr_stmt|;
break|break;
case|case
name|SYS_lio_listio
case|:
name|putchar
argument_list|(
literal|'('
argument_list|)
expr_stmt|;
name|print_integer_arg
argument_list|(
name|sysdecode_lio_listio_mode
argument_list|,
operator|*
name|ip
argument_list|)
expr_stmt|;
name|ip
operator|++
expr_stmt|;
name|narg
operator|--
expr_stmt|;
name|c
operator|=
literal|','
expr_stmt|;
break|break;
case|case
name|SYS_mlockall
case|:
name|putchar
argument_list|(
literal|'('
argument_list|)
expr_stmt|;
name|print_mask_arg
argument_list|(
name|sysdecode_mlockall_flags
argument_list|,
operator|*
name|ip
argument_list|)
expr_stmt|;
name|ip
operator|++
expr_stmt|;
name|narg
operator|--
expr_stmt|;
break|break;
case|case
name|SYS_sched_setscheduler
case|:
name|print_number
argument_list|(
name|ip
argument_list|,
name|narg
argument_list|,
name|c
argument_list|)
expr_stmt|;
name|putchar
argument_list|(
literal|','
argument_list|)
expr_stmt|;
name|print_integer_arg
argument_list|(
name|sysdecode_scheduler_policy
argument_list|,
operator|*
name|ip
argument_list|)
expr_stmt|;
name|ip
operator|++
expr_stmt|;
name|narg
operator|--
expr_stmt|;
break|break;
case|case
name|SYS_sched_get_priority_max
case|:
case|case
name|SYS_sched_get_priority_min
case|:
name|putchar
argument_list|(
literal|'('
argument_list|)
expr_stmt|;
name|print_integer_arg
argument_list|(
name|sysdecode_scheduler_policy
argument_list|,
operator|*
name|ip
argument_list|)
expr_stmt|;
name|ip
operator|++
expr_stmt|;
name|narg
operator|--
expr_stmt|;
break|break;
case|case
name|SYS_sendfile
case|:
name|print_number
argument_list|(
name|ip
argument_list|,
name|narg
argument_list|,
name|c
argument_list|)
expr_stmt|;
name|print_number
argument_list|(
name|ip
argument_list|,
name|narg
argument_list|,
name|c
argument_list|)
expr_stmt|;
name|print_number
argument_list|(
name|ip
argument_list|,
name|narg
argument_list|,
name|c
argument_list|)
expr_stmt|;
name|print_number
argument_list|(
name|ip
argument_list|,
name|narg
argument_list|,
name|c
argument_list|)
expr_stmt|;
name|print_number
argument_list|(
name|ip
argument_list|,
name|narg
argument_list|,
name|c
argument_list|)
expr_stmt|;
name|print_number
argument_list|(
name|ip
argument_list|,
name|narg
argument_list|,
name|c
argument_list|)
expr_stmt|;
name|putchar
argument_list|(
literal|','
argument_list|)
expr_stmt|;
name|print_mask_arg
argument_list|(
name|sysdecode_sendfile_flags
argument_list|,
operator|*
name|ip
argument_list|)
expr_stmt|;
name|ip
operator|++
expr_stmt|;
name|narg
operator|--
expr_stmt|;
break|break;
case|case
name|SYS_kldsym
case|:
name|print_number
argument_list|(
name|ip
argument_list|,
name|narg
argument_list|,
name|c
argument_list|)
expr_stmt|;
name|putchar
argument_list|(
literal|','
argument_list|)
expr_stmt|;
name|print_integer_arg
argument_list|(
name|sysdecode_kldsym_cmd
argument_list|,
operator|*
name|ip
argument_list|)
expr_stmt|;
name|ip
operator|++
expr_stmt|;
name|narg
operator|--
expr_stmt|;
break|break;
case|case
name|SYS_sigprocmask
case|:
name|putchar
argument_list|(
literal|'('
argument_list|)
expr_stmt|;
name|print_integer_arg
argument_list|(
name|sysdecode_sigprocmask_how
argument_list|,
operator|*
name|ip
argument_list|)
expr_stmt|;
name|ip
operator|++
expr_stmt|;
name|narg
operator|--
expr_stmt|;
name|c
operator|=
literal|','
expr_stmt|;
break|break;
case|case
name|SYS___acl_get_file
case|:
case|case
name|SYS___acl_set_file
case|:
case|case
name|SYS___acl_get_fd
case|:
case|case
name|SYS___acl_set_fd
case|:
case|case
name|SYS___acl_delete_file
case|:
case|case
name|SYS___acl_delete_fd
case|:
case|case
name|SYS___acl_aclcheck_file
case|:
case|case
name|SYS___acl_aclcheck_fd
case|:
case|case
name|SYS___acl_get_link
case|:
case|case
name|SYS___acl_set_link
case|:
case|case
name|SYS___acl_delete_link
case|:
case|case
name|SYS___acl_aclcheck_link
case|:
name|print_number
argument_list|(
name|ip
argument_list|,
name|narg
argument_list|,
name|c
argument_list|)
expr_stmt|;
name|putchar
argument_list|(
literal|','
argument_list|)
expr_stmt|;
name|print_integer_arg
argument_list|(
name|sysdecode_acltype
argument_list|,
operator|*
name|ip
argument_list|)
expr_stmt|;
name|ip
operator|++
expr_stmt|;
name|narg
operator|--
expr_stmt|;
break|break;
case|case
name|SYS_sigaction
case|:
name|putchar
argument_list|(
literal|'('
argument_list|)
expr_stmt|;
name|print_signal
argument_list|(
operator|*
name|ip
argument_list|)
expr_stmt|;
name|ip
operator|++
expr_stmt|;
name|narg
operator|--
expr_stmt|;
name|c
operator|=
literal|','
expr_stmt|;
break|break;
case|case
name|SYS_extattrctl
case|:
name|print_number
argument_list|(
name|ip
argument_list|,
name|narg
argument_list|,
name|c
argument_list|)
expr_stmt|;
name|putchar
argument_list|(
literal|','
argument_list|)
expr_stmt|;
name|print_integer_arg
argument_list|(
name|sysdecode_extattrnamespace
argument_list|,
operator|*
name|ip
argument_list|)
expr_stmt|;
name|ip
operator|++
expr_stmt|;
name|narg
operator|--
expr_stmt|;
break|break;
case|case
name|SYS_nmount
case|:
name|print_number
argument_list|(
name|ip
argument_list|,
name|narg
argument_list|,
name|c
argument_list|)
expr_stmt|;
name|print_number
argument_list|(
name|ip
argument_list|,
name|narg
argument_list|,
name|c
argument_list|)
expr_stmt|;
name|putchar
argument_list|(
literal|','
argument_list|)
expr_stmt|;
name|print_mask_arg
argument_list|(
name|sysdecode_mount_flags
argument_list|,
operator|*
name|ip
argument_list|)
expr_stmt|;
name|ip
operator|++
expr_stmt|;
name|narg
operator|--
expr_stmt|;
break|break;
case|case
name|SYS_thr_create
case|:
name|print_number
argument_list|(
name|ip
argument_list|,
name|narg
argument_list|,
name|c
argument_list|)
expr_stmt|;
name|print_number
argument_list|(
name|ip
argument_list|,
name|narg
argument_list|,
name|c
argument_list|)
expr_stmt|;
name|putchar
argument_list|(
literal|','
argument_list|)
expr_stmt|;
name|print_mask_arg
argument_list|(
name|sysdecode_thr_create_flags
argument_list|,
operator|*
name|ip
argument_list|)
expr_stmt|;
name|ip
operator|++
expr_stmt|;
name|narg
operator|--
expr_stmt|;
break|break;
case|case
name|SYS_thr_kill
case|:
name|print_number
argument_list|(
name|ip
argument_list|,
name|narg
argument_list|,
name|c
argument_list|)
expr_stmt|;
name|putchar
argument_list|(
literal|','
argument_list|)
expr_stmt|;
name|print_signal
argument_list|(
operator|*
name|ip
argument_list|)
expr_stmt|;
name|ip
operator|++
expr_stmt|;
name|narg
operator|--
expr_stmt|;
break|break;
case|case
name|SYS_kldunloadf
case|:
name|print_number
argument_list|(
name|ip
argument_list|,
name|narg
argument_list|,
name|c
argument_list|)
expr_stmt|;
name|putchar
argument_list|(
literal|','
argument_list|)
expr_stmt|;
name|print_integer_arg
argument_list|(
name|sysdecode_kldunload_flags
argument_list|,
operator|*
name|ip
argument_list|)
expr_stmt|;
name|ip
operator|++
expr_stmt|;
name|narg
operator|--
expr_stmt|;
break|break;
case|case
name|SYS_linkat
case|:
case|case
name|SYS_renameat
case|:
case|case
name|SYS_symlinkat
case|:
name|print_number
argument_list|(
name|ip
argument_list|,
name|narg
argument_list|,
name|c
argument_list|)
expr_stmt|;
name|putchar
argument_list|(
literal|','
argument_list|)
expr_stmt|;
name|print_integer_arg_valid
argument_list|(
name|sysdecode_atfd
argument_list|,
operator|*
name|ip
argument_list|)
expr_stmt|;
name|ip
operator|++
expr_stmt|;
name|narg
operator|--
expr_stmt|;
break|break;
case|case
name|SYS_cap_fcntls_limit
case|:
name|print_number
argument_list|(
name|ip
argument_list|,
name|narg
argument_list|,
name|c
argument_list|)
expr_stmt|;
name|putchar
argument_list|(
literal|','
argument_list|)
expr_stmt|;
name|arg
operator|=
operator|*
name|ip
expr_stmt|;
name|ip
operator|++
expr_stmt|;
name|narg
operator|--
expr_stmt|;
name|print_mask_arg32
argument_list|(
name|sysdecode_cap_fcntlrights
argument_list|,
name|arg
argument_list|)
expr_stmt|;
break|break;
case|case
name|SYS_posix_fadvise
case|:
name|print_number
argument_list|(
name|ip
argument_list|,
name|narg
argument_list|,
name|c
argument_list|)
expr_stmt|;
name|print_number
argument_list|(
name|ip
argument_list|,
name|narg
argument_list|,
name|c
argument_list|)
expr_stmt|;
name|print_number
argument_list|(
name|ip
argument_list|,
name|narg
argument_list|,
name|c
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|putchar
argument_list|(
literal|','
argument_list|)
expr_stmt|;
name|print_integer_arg
argument_list|(
name|sysdecode_fadvice
argument_list|,
operator|*
name|ip
argument_list|)
expr_stmt|;
name|ip
operator|++
expr_stmt|;
name|narg
operator|--
expr_stmt|;
break|break;
case|case
name|SYS_procctl
case|:
name|putchar
argument_list|(
literal|'('
argument_list|)
expr_stmt|;
name|print_integer_arg
argument_list|(
name|sysdecode_idtype
argument_list|,
operator|*
name|ip
argument_list|)
expr_stmt|;
name|c
operator|=
literal|','
expr_stmt|;
name|ip
operator|++
expr_stmt|;
name|narg
operator|--
expr_stmt|;
name|print_number64
argument_list|(
name|first
argument_list|,
name|ip
argument_list|,
name|narg
argument_list|,
name|c
argument_list|)
expr_stmt|;
name|putchar
argument_list|(
literal|','
argument_list|)
expr_stmt|;
name|print_integer_arg
argument_list|(
name|sysdecode_procctl_cmd
argument_list|,
operator|*
name|ip
argument_list|)
expr_stmt|;
name|ip
operator|++
expr_stmt|;
name|narg
operator|--
expr_stmt|;
break|break;
case|case
name|SYS__umtx_op
case|:
name|print_number
argument_list|(
name|ip
argument_list|,
name|narg
argument_list|,
name|c
argument_list|)
expr_stmt|;
name|putchar
argument_list|(
literal|','
argument_list|)
expr_stmt|;
name|print_integer_arg
argument_list|(
name|sysdecode_umtx_op
argument_list|,
operator|*
name|ip
argument_list|)
expr_stmt|;
switch|switch
condition|(
operator|*
name|ip
condition|)
block|{
case|case
name|UMTX_OP_CV_WAIT
case|:
name|ip
operator|++
expr_stmt|;
name|narg
operator|--
expr_stmt|;
name|putchar
argument_list|(
literal|','
argument_list|)
expr_stmt|;
name|print_mask_argul
argument_list|(
name|sysdecode_umtx_cvwait_flags
argument_list|,
operator|*
name|ip
argument_list|)
expr_stmt|;
break|break;
case|case
name|UMTX_OP_RW_RDLOCK
case|:
name|ip
operator|++
expr_stmt|;
name|narg
operator|--
expr_stmt|;
name|putchar
argument_list|(
literal|','
argument_list|)
expr_stmt|;
name|print_mask_argul
argument_list|(
name|sysdecode_umtx_rwlock_flags
argument_list|,
operator|*
name|ip
argument_list|)
expr_stmt|;
break|break;
block|}
name|ip
operator|++
expr_stmt|;
name|narg
operator|--
expr_stmt|;
break|break;
case|case
name|SYS_ftruncate
case|:
case|case
name|SYS_truncate
case|:
name|print_number
argument_list|(
name|ip
argument_list|,
name|narg
argument_list|,
name|c
argument_list|)
expr_stmt|;
name|print_number64
argument_list|(
name|first
argument_list|,
name|ip
argument_list|,
name|narg
argument_list|,
name|c
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
while|while
condition|(
name|narg
operator|>
literal|0
condition|)
block|{
name|print_number
argument_list|(
name|ip
argument_list|,
name|narg
argument_list|,
name|c
argument_list|)
expr_stmt|;
block|}
name|putchar
argument_list|(
literal|')'
argument_list|)
expr_stmt|;
block|}
name|putchar
argument_list|(
literal|'\n'
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|ktrsysret
parameter_list|(
name|struct
name|ktr_sysret
modifier|*
name|ktr
parameter_list|,
name|u_int
name|sv_flags
parameter_list|)
block|{
name|register_t
name|ret
init|=
name|ktr
operator|->
name|ktr_retval
decl_stmt|;
name|int
name|error
init|=
name|ktr
operator|->
name|ktr_error
decl_stmt|;
name|syscallname
argument_list|(
name|ktr
operator|->
name|ktr_code
argument_list|,
name|sv_flags
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|" "
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|fancy
condition|)
block|{
name|printf
argument_list|(
literal|"%ld"
argument_list|,
operator|(
name|long
operator|)
name|ret
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|<
literal|0
operator|||
name|ret
operator|>
literal|9
condition|)
name|printf
argument_list|(
literal|"/%#lx"
argument_list|,
operator|(
name|unsigned
name|long
operator|)
name|ret
argument_list|)
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|decimal
condition|)
name|printf
argument_list|(
literal|"%ld"
argument_list|,
operator|(
name|long
operator|)
name|ret
argument_list|)
expr_stmt|;
else|else
name|printf
argument_list|(
literal|"%#lx"
argument_list|,
operator|(
name|unsigned
name|long
operator|)
name|ret
argument_list|)
expr_stmt|;
block|}
block|}
elseif|else
if|if
condition|(
name|error
operator|==
name|ERESTART
condition|)
name|printf
argument_list|(
literal|"RESTART"
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|error
operator|==
name|EJUSTRETURN
condition|)
name|printf
argument_list|(
literal|"JUSTRETURN"
argument_list|)
expr_stmt|;
else|else
block|{
name|printf
argument_list|(
literal|"-1 errno %d"
argument_list|,
name|sysdecode_freebsd_to_abi_errno
argument_list|(
name|syscallabi
argument_list|(
name|sv_flags
argument_list|)
argument_list|,
name|error
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|fancy
condition|)
name|printf
argument_list|(
literal|" %s"
argument_list|,
name|strerror
argument_list|(
name|ktr
operator|->
name|ktr_error
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|putchar
argument_list|(
literal|'\n'
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|ktrnamei
parameter_list|(
name|char
modifier|*
name|cp
parameter_list|,
name|int
name|len
parameter_list|)
block|{
name|printf
argument_list|(
literal|"\"%.*s\"\n"
argument_list|,
name|len
argument_list|,
name|cp
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|hexdump
parameter_list|(
name|char
modifier|*
name|p
parameter_list|,
name|int
name|len
parameter_list|,
name|int
name|screenwidth
parameter_list|)
block|{
name|int
name|n
decl_stmt|,
name|i
decl_stmt|;
name|int
name|width
decl_stmt|;
name|width
operator|=
literal|0
expr_stmt|;
do|do
block|{
name|width
operator|+=
literal|2
expr_stmt|;
name|i
operator|=
literal|13
expr_stmt|;
comment|/* base offset */
name|i
operator|+=
operator|(
name|width
operator|/
literal|2
operator|)
operator|+
literal|1
expr_stmt|;
comment|/* spaces every second byte */
name|i
operator|+=
operator|(
name|width
operator|*
literal|2
operator|)
expr_stmt|;
comment|/* width of bytes */
name|i
operator|+=
literal|3
expr_stmt|;
comment|/* "  |" */
name|i
operator|+=
name|width
expr_stmt|;
comment|/* each byte */
name|i
operator|+=
literal|1
expr_stmt|;
comment|/* "|" */
block|}
do|while
condition|(
name|i
operator|<
name|screenwidth
condition|)
do|;
name|width
operator|-=
literal|2
expr_stmt|;
for|for
control|(
name|n
operator|=
literal|0
init|;
name|n
operator|<
name|len
condition|;
name|n
operator|+=
name|width
control|)
block|{
for|for
control|(
name|i
operator|=
name|n
init|;
name|i
operator|<
name|n
operator|+
name|width
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
operator|(
name|i
operator|%
name|width
operator|)
operator|==
literal|0
condition|)
block|{
comment|/* beginning of line */
name|printf
argument_list|(
literal|"       0x%04x"
argument_list|,
name|i
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|i
operator|%
literal|2
operator|)
operator|==
literal|0
condition|)
block|{
name|printf
argument_list|(
literal|" "
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|i
operator|<
name|len
condition|)
name|printf
argument_list|(
literal|"%02x"
argument_list|,
name|p
index|[
name|i
index|]
operator|&
literal|0xff
argument_list|)
expr_stmt|;
else|else
name|printf
argument_list|(
literal|"  "
argument_list|)
expr_stmt|;
block|}
name|printf
argument_list|(
literal|"  |"
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
name|n
init|;
name|i
operator|<
name|n
operator|+
name|width
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|i
operator|>=
name|len
condition|)
break|break;
if|if
condition|(
name|p
index|[
name|i
index|]
operator|>=
literal|' '
operator|&&
name|p
index|[
name|i
index|]
operator|<=
literal|'~'
condition|)
name|printf
argument_list|(
literal|"%c"
argument_list|,
name|p
index|[
name|i
index|]
argument_list|)
expr_stmt|;
else|else
name|printf
argument_list|(
literal|"."
argument_list|)
expr_stmt|;
block|}
name|printf
argument_list|(
literal|"|\n"
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|i
operator|%
name|width
operator|)
operator|!=
literal|0
condition|)
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|visdump
parameter_list|(
name|char
modifier|*
name|dp
parameter_list|,
name|int
name|datalen
parameter_list|,
name|int
name|screenwidth
parameter_list|)
block|{
name|int
name|col
init|=
literal|0
decl_stmt|;
name|char
modifier|*
name|cp
decl_stmt|;
name|int
name|width
decl_stmt|;
name|char
name|visbuf
index|[
literal|5
index|]
decl_stmt|;
name|printf
argument_list|(
literal|"       \""
argument_list|)
expr_stmt|;
name|col
operator|=
literal|8
expr_stmt|;
for|for
control|(
init|;
name|datalen
operator|>
literal|0
condition|;
name|datalen
operator|--
operator|,
name|dp
operator|++
control|)
block|{
name|vis
argument_list|(
name|visbuf
argument_list|,
operator|*
name|dp
argument_list|,
name|VIS_CSTYLE
argument_list|,
operator|*
operator|(
name|dp
operator|+
literal|1
operator|)
argument_list|)
expr_stmt|;
name|cp
operator|=
name|visbuf
expr_stmt|;
comment|/* 		 * Keep track of printables and 		 * space chars (like fold(1)). 		 */
if|if
condition|(
name|col
operator|==
literal|0
condition|)
block|{
name|putchar
argument_list|(
literal|'\t'
argument_list|)
expr_stmt|;
name|col
operator|=
literal|8
expr_stmt|;
block|}
switch|switch
condition|(
operator|*
name|cp
condition|)
block|{
case|case
literal|'\n'
case|:
name|col
operator|=
literal|0
expr_stmt|;
name|putchar
argument_list|(
literal|'\n'
argument_list|)
expr_stmt|;
continue|continue;
case|case
literal|'\t'
case|:
name|width
operator|=
literal|8
operator|-
operator|(
name|col
operator|&
literal|07
operator|)
expr_stmt|;
break|break;
default|default:
name|width
operator|=
name|strlen
argument_list|(
name|cp
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|col
operator|+
name|width
operator|>
operator|(
name|screenwidth
operator|-
literal|2
operator|)
condition|)
block|{
name|printf
argument_list|(
literal|"\\\n\t"
argument_list|)
expr_stmt|;
name|col
operator|=
literal|8
expr_stmt|;
block|}
name|col
operator|+=
name|width
expr_stmt|;
do|do
block|{
name|putchar
argument_list|(
operator|*
name|cp
operator|++
argument_list|)
expr_stmt|;
block|}
do|while
condition|(
operator|*
name|cp
condition|)
do|;
block|}
if|if
condition|(
name|col
operator|==
literal|0
condition|)
name|printf
argument_list|(
literal|"       "
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\"\n"
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|ktrgenio
parameter_list|(
name|struct
name|ktr_genio
modifier|*
name|ktr
parameter_list|,
name|int
name|len
parameter_list|)
block|{
name|int
name|datalen
init|=
name|len
operator|-
sizeof|sizeof
argument_list|(
expr|struct
name|ktr_genio
argument_list|)
decl_stmt|;
name|char
modifier|*
name|dp
init|=
operator|(
name|char
operator|*
operator|)
name|ktr
operator|+
sizeof|sizeof
argument_list|(
expr|struct
name|ktr_genio
argument_list|)
decl_stmt|;
specifier|static
name|int
name|screenwidth
init|=
literal|0
decl_stmt|;
name|int
name|i
decl_stmt|,
name|binary
decl_stmt|;
name|printf
argument_list|(
literal|"fd %d %s %d byte%s\n"
argument_list|,
name|ktr
operator|->
name|ktr_fd
argument_list|,
name|ktr
operator|->
name|ktr_rw
operator|==
name|UIO_READ
condition|?
literal|"read"
else|:
literal|"wrote"
argument_list|,
name|datalen
argument_list|,
name|datalen
operator|==
literal|1
condition|?
literal|""
else|:
literal|"s"
argument_list|)
expr_stmt|;
if|if
condition|(
name|suppressdata
condition|)
return|return;
if|if
condition|(
name|screenwidth
operator|==
literal|0
condition|)
block|{
name|struct
name|winsize
name|ws
decl_stmt|;
if|if
condition|(
name|fancy
operator|&&
name|ioctl
argument_list|(
name|fileno
argument_list|(
name|stderr
argument_list|)
argument_list|,
name|TIOCGWINSZ
argument_list|,
operator|&
name|ws
argument_list|)
operator|!=
operator|-
literal|1
operator|&&
name|ws
operator|.
name|ws_col
operator|>
literal|8
condition|)
name|screenwidth
operator|=
name|ws
operator|.
name|ws_col
expr_stmt|;
else|else
name|screenwidth
operator|=
literal|80
expr_stmt|;
block|}
if|if
condition|(
name|maxdata
operator|&&
name|datalen
operator|>
name|maxdata
condition|)
name|datalen
operator|=
name|maxdata
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
operator|,
name|binary
operator|=
literal|0
init|;
name|i
operator|<
name|datalen
operator|&&
name|binary
operator|==
literal|0
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|dp
index|[
name|i
index|]
operator|>=
literal|32
operator|&&
name|dp
index|[
name|i
index|]
operator|<
literal|127
condition|)
continue|continue;
if|if
condition|(
name|dp
index|[
name|i
index|]
operator|==
literal|10
operator|||
name|dp
index|[
name|i
index|]
operator|==
literal|13
operator|||
name|dp
index|[
name|i
index|]
operator|==
literal|0
operator|||
name|dp
index|[
name|i
index|]
operator|==
literal|9
condition|)
continue|continue;
name|binary
operator|=
literal|1
expr_stmt|;
block|}
if|if
condition|(
name|binary
condition|)
name|hexdump
argument_list|(
name|dp
argument_list|,
name|datalen
argument_list|,
name|screenwidth
argument_list|)
expr_stmt|;
else|else
name|visdump
argument_list|(
name|dp
argument_list|,
name|datalen
argument_list|,
name|screenwidth
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|ktrpsig
parameter_list|(
name|struct
name|ktr_psig
modifier|*
name|psig
parameter_list|)
block|{
specifier|const
name|char
modifier|*
name|str
decl_stmt|;
name|print_signal
argument_list|(
name|psig
operator|->
name|signo
argument_list|)
expr_stmt|;
if|if
condition|(
name|psig
operator|->
name|action
operator|==
name|SIG_DFL
condition|)
block|{
name|printf
argument_list|(
literal|" SIG_DFL"
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|printf
argument_list|(
literal|" caught handler=0x%lx mask=0x%x"
argument_list|,
operator|(
name|u_long
operator|)
name|psig
operator|->
name|action
argument_list|,
name|psig
operator|->
name|mask
operator|.
name|__bits
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
block|}
name|printf
argument_list|(
literal|" code="
argument_list|)
expr_stmt|;
name|str
operator|=
name|sysdecode_sigcode
argument_list|(
name|psig
operator|->
name|signo
argument_list|,
name|psig
operator|->
name|code
argument_list|)
expr_stmt|;
if|if
condition|(
name|str
operator|!=
name|NULL
condition|)
name|printf
argument_list|(
literal|"%s"
argument_list|,
name|str
argument_list|)
expr_stmt|;
else|else
name|printf
argument_list|(
literal|"<invalid=%#x>"
argument_list|,
name|psig
operator|->
name|code
argument_list|)
expr_stmt|;
name|putchar
argument_list|(
literal|'\n'
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|ktrcsw_old
parameter_list|(
name|struct
name|ktr_csw_old
modifier|*
name|cs
parameter_list|)
block|{
name|printf
argument_list|(
literal|"%s %s\n"
argument_list|,
name|cs
operator|->
name|out
condition|?
literal|"stop"
else|:
literal|"resume"
argument_list|,
name|cs
operator|->
name|user
condition|?
literal|"user"
else|:
literal|"kernel"
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|ktrcsw
parameter_list|(
name|struct
name|ktr_csw
modifier|*
name|cs
parameter_list|)
block|{
name|printf
argument_list|(
literal|"%s %s \"%s\"\n"
argument_list|,
name|cs
operator|->
name|out
condition|?
literal|"stop"
else|:
literal|"resume"
argument_list|,
name|cs
operator|->
name|user
condition|?
literal|"user"
else|:
literal|"kernel"
argument_list|,
name|cs
operator|->
name|wmesg
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|ktruser
parameter_list|(
name|int
name|len
parameter_list|,
name|void
modifier|*
name|p
parameter_list|)
block|{
name|unsigned
name|char
modifier|*
name|cp
decl_stmt|;
if|if
condition|(
name|sysdecode_utrace
argument_list|(
name|stdout
argument_list|,
name|p
argument_list|,
name|len
argument_list|)
condition|)
block|{
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
return|return;
block|}
name|printf
argument_list|(
literal|"%d "
argument_list|,
name|len
argument_list|)
expr_stmt|;
name|cp
operator|=
name|p
expr_stmt|;
while|while
condition|(
name|len
operator|--
condition|)
if|if
condition|(
name|decimal
condition|)
name|printf
argument_list|(
literal|" %d"
argument_list|,
operator|*
name|cp
operator|++
argument_list|)
expr_stmt|;
else|else
name|printf
argument_list|(
literal|" %02x"
argument_list|,
operator|*
name|cp
operator|++
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|ktrcaprights
parameter_list|(
name|cap_rights_t
modifier|*
name|rightsp
parameter_list|)
block|{
name|printf
argument_list|(
literal|"cap_rights_t "
argument_list|)
expr_stmt|;
name|sysdecode_cap_rights
argument_list|(
name|stdout
argument_list|,
name|rightsp
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|ktrtimeval
parameter_list|(
name|struct
name|timeval
modifier|*
name|tv
parameter_list|)
block|{
name|printf
argument_list|(
literal|"{%ld, %ld}"
argument_list|,
operator|(
name|long
operator|)
name|tv
operator|->
name|tv_sec
argument_list|,
name|tv
operator|->
name|tv_usec
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|ktritimerval
parameter_list|(
name|struct
name|itimerval
modifier|*
name|it
parameter_list|)
block|{
name|printf
argument_list|(
literal|"itimerval { .interval = "
argument_list|)
expr_stmt|;
name|ktrtimeval
argument_list|(
operator|&
name|it
operator|->
name|it_interval
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|", .value = "
argument_list|)
expr_stmt|;
name|ktrtimeval
argument_list|(
operator|&
name|it
operator|->
name|it_value
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|" }\n"
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|ktrsockaddr
parameter_list|(
name|struct
name|sockaddr
modifier|*
name|sa
parameter_list|)
block|{
comment|/*  TODO: Support additional address families 	#include<netnatm/natm.h> 	struct sockaddr_natm	*natm; 	#include<netsmb/netbios.h> 	struct sockaddr_nb	*nb; */
specifier|const
name|char
modifier|*
name|str
decl_stmt|;
name|char
name|addr
index|[
literal|64
index|]
decl_stmt|;
comment|/* 	 * note: ktrstruct() has already verified that sa points to a 	 * buffer at least sizeof(struct sockaddr) bytes long and exactly 	 * sa->sa_len bytes long. 	 */
name|printf
argument_list|(
literal|"struct sockaddr { "
argument_list|)
expr_stmt|;
name|str
operator|=
name|sysdecode_sockaddr_family
argument_list|(
name|sa
operator|->
name|sa_family
argument_list|)
expr_stmt|;
if|if
condition|(
name|str
operator|!=
name|NULL
condition|)
name|printf
argument_list|(
literal|"%s"
argument_list|,
name|str
argument_list|)
expr_stmt|;
else|else
name|printf
argument_list|(
literal|"<invalid=%d>"
argument_list|,
name|sa
operator|->
name|sa_family
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|", "
argument_list|)
expr_stmt|;
define|#
directive|define
name|check_sockaddr_len
parameter_list|(
name|n
parameter_list|)
define|\
value|if (sa_##n.s##n##_len< sizeof(struct sockaddr_##n)) {	\ 		printf("invalid");				\ 		break;						\ 	}
switch|switch
condition|(
name|sa
operator|->
name|sa_family
condition|)
block|{
case|case
name|AF_INET
case|:
block|{
name|struct
name|sockaddr_in
name|sa_in
decl_stmt|;
name|memset
argument_list|(
operator|&
name|sa_in
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|sa_in
argument_list|)
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
operator|&
name|sa_in
argument_list|,
name|sa
argument_list|,
name|sa
operator|->
name|sa_len
argument_list|)
expr_stmt|;
name|check_sockaddr_len
argument_list|(
name|in
argument_list|)
expr_stmt|;
name|inet_ntop
argument_list|(
name|AF_INET
argument_list|,
operator|&
name|sa_in
operator|.
name|sin_addr
argument_list|,
name|addr
argument_list|,
sizeof|sizeof
name|addr
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"%s:%u"
argument_list|,
name|addr
argument_list|,
name|ntohs
argument_list|(
name|sa_in
operator|.
name|sin_port
argument_list|)
argument_list|)
expr_stmt|;
break|break;
block|}
case|case
name|AF_INET6
case|:
block|{
name|struct
name|sockaddr_in6
name|sa_in6
decl_stmt|;
name|memset
argument_list|(
operator|&
name|sa_in6
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|sa_in6
argument_list|)
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
operator|&
name|sa_in6
argument_list|,
name|sa
argument_list|,
name|sa
operator|->
name|sa_len
argument_list|)
expr_stmt|;
name|check_sockaddr_len
argument_list|(
name|in6
argument_list|)
expr_stmt|;
name|getnameinfo
argument_list|(
operator|(
expr|struct
name|sockaddr
operator|*
operator|)
operator|&
name|sa_in6
argument_list|,
sizeof|sizeof
argument_list|(
name|sa_in6
argument_list|)
argument_list|,
name|addr
argument_list|,
sizeof|sizeof
argument_list|(
name|addr
argument_list|)
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|,
name|NI_NUMERICHOST
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"[%s]:%u"
argument_list|,
name|addr
argument_list|,
name|htons
argument_list|(
name|sa_in6
operator|.
name|sin6_port
argument_list|)
argument_list|)
expr_stmt|;
break|break;
block|}
case|case
name|AF_UNIX
case|:
block|{
name|struct
name|sockaddr_un
name|sa_un
decl_stmt|;
name|memset
argument_list|(
operator|&
name|sa_un
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|sa_un
argument_list|)
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
operator|&
name|sa_un
argument_list|,
name|sa
argument_list|,
name|sa
operator|->
name|sa_len
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"%.*s"
argument_list|,
operator|(
name|int
operator|)
sizeof|sizeof
argument_list|(
name|sa_un
operator|.
name|sun_path
argument_list|)
argument_list|,
name|sa_un
operator|.
name|sun_path
argument_list|)
expr_stmt|;
break|break;
block|}
default|default:
name|printf
argument_list|(
literal|"unknown address family"
argument_list|)
expr_stmt|;
block|}
name|printf
argument_list|(
literal|" }\n"
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|ktrstat
parameter_list|(
name|struct
name|stat
modifier|*
name|statp
parameter_list|)
block|{
name|char
name|mode
index|[
literal|12
index|]
decl_stmt|,
name|timestr
index|[
name|PATH_MAX
operator|+
literal|4
index|]
decl_stmt|;
name|struct
name|passwd
modifier|*
name|pwd
decl_stmt|;
name|struct
name|group
modifier|*
name|grp
decl_stmt|;
name|struct
name|tm
modifier|*
name|tm
decl_stmt|;
comment|/* 	 * note: ktrstruct() has already verified that statp points to a 	 * buffer exactly sizeof(struct stat) bytes long. 	 */
name|printf
argument_list|(
literal|"struct stat {"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"dev=%ju, ino=%ju, "
argument_list|,
operator|(
name|uintmax_t
operator|)
name|statp
operator|->
name|st_dev
argument_list|,
operator|(
name|uintmax_t
operator|)
name|statp
operator|->
name|st_ino
argument_list|)
expr_stmt|;
if|if
condition|(
name|resolv
operator|==
literal|0
condition|)
name|printf
argument_list|(
literal|"mode=0%jo, "
argument_list|,
operator|(
name|uintmax_t
operator|)
name|statp
operator|->
name|st_mode
argument_list|)
expr_stmt|;
else|else
block|{
name|strmode
argument_list|(
name|statp
operator|->
name|st_mode
argument_list|,
name|mode
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"mode=%s, "
argument_list|,
name|mode
argument_list|)
expr_stmt|;
block|}
name|printf
argument_list|(
literal|"nlink=%ju, "
argument_list|,
operator|(
name|uintmax_t
operator|)
name|statp
operator|->
name|st_nlink
argument_list|)
expr_stmt|;
if|if
condition|(
name|resolv
operator|==
literal|0
condition|)
block|{
name|pwd
operator|=
name|NULL
expr_stmt|;
block|}
else|else
block|{
ifdef|#
directive|ifdef
name|HAVE_LIBCASPER
if|if
condition|(
name|cappwd
operator|!=
name|NULL
condition|)
name|pwd
operator|=
name|cap_getpwuid
argument_list|(
name|cappwd
argument_list|,
name|statp
operator|->
name|st_uid
argument_list|)
expr_stmt|;
else|else
endif|#
directive|endif
name|pwd
operator|=
name|getpwuid
argument_list|(
name|statp
operator|->
name|st_uid
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|pwd
operator|==
name|NULL
condition|)
name|printf
argument_list|(
literal|"uid=%ju, "
argument_list|,
operator|(
name|uintmax_t
operator|)
name|statp
operator|->
name|st_uid
argument_list|)
expr_stmt|;
else|else
name|printf
argument_list|(
literal|"uid=\"%s\", "
argument_list|,
name|pwd
operator|->
name|pw_name
argument_list|)
expr_stmt|;
if|if
condition|(
name|resolv
operator|==
literal|0
condition|)
block|{
name|grp
operator|=
name|NULL
expr_stmt|;
block|}
else|else
block|{
ifdef|#
directive|ifdef
name|HAVE_LIBCASPER
if|if
condition|(
name|capgrp
operator|!=
name|NULL
condition|)
name|grp
operator|=
name|cap_getgrgid
argument_list|(
name|capgrp
argument_list|,
name|statp
operator|->
name|st_gid
argument_list|)
expr_stmt|;
else|else
endif|#
directive|endif
name|grp
operator|=
name|getgrgid
argument_list|(
name|statp
operator|->
name|st_gid
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|grp
operator|==
name|NULL
condition|)
name|printf
argument_list|(
literal|"gid=%ju, "
argument_list|,
operator|(
name|uintmax_t
operator|)
name|statp
operator|->
name|st_gid
argument_list|)
expr_stmt|;
else|else
name|printf
argument_list|(
literal|"gid=\"%s\", "
argument_list|,
name|grp
operator|->
name|gr_name
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"rdev=%ju, "
argument_list|,
operator|(
name|uintmax_t
operator|)
name|statp
operator|->
name|st_rdev
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"atime="
argument_list|)
expr_stmt|;
if|if
condition|(
name|resolv
operator|==
literal|0
condition|)
name|printf
argument_list|(
literal|"%jd"
argument_list|,
operator|(
name|intmax_t
operator|)
name|statp
operator|->
name|st_atim
operator|.
name|tv_sec
argument_list|)
expr_stmt|;
else|else
block|{
name|tm
operator|=
name|localtime
argument_list|(
operator|&
name|statp
operator|->
name|st_atim
operator|.
name|tv_sec
argument_list|)
expr_stmt|;
name|strftime
argument_list|(
name|timestr
argument_list|,
sizeof|sizeof
argument_list|(
name|timestr
argument_list|)
argument_list|,
name|TIME_FORMAT
argument_list|,
name|tm
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\"%s\""
argument_list|,
name|timestr
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|statp
operator|->
name|st_atim
operator|.
name|tv_nsec
operator|!=
literal|0
condition|)
name|printf
argument_list|(
literal|".%09ld, "
argument_list|,
name|statp
operator|->
name|st_atim
operator|.
name|tv_nsec
argument_list|)
expr_stmt|;
else|else
name|printf
argument_list|(
literal|", "
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"mtime="
argument_list|)
expr_stmt|;
if|if
condition|(
name|resolv
operator|==
literal|0
condition|)
name|printf
argument_list|(
literal|"%jd"
argument_list|,
operator|(
name|intmax_t
operator|)
name|statp
operator|->
name|st_mtim
operator|.
name|tv_sec
argument_list|)
expr_stmt|;
else|else
block|{
name|tm
operator|=
name|localtime
argument_list|(
operator|&
name|statp
operator|->
name|st_mtim
operator|.
name|tv_sec
argument_list|)
expr_stmt|;
name|strftime
argument_list|(
name|timestr
argument_list|,
sizeof|sizeof
argument_list|(
name|timestr
argument_list|)
argument_list|,
name|TIME_FORMAT
argument_list|,
name|tm
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\"%s\""
argument_list|,
name|timestr
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|statp
operator|->
name|st_mtim
operator|.
name|tv_nsec
operator|!=
literal|0
condition|)
name|printf
argument_list|(
literal|".%09ld, "
argument_list|,
name|statp
operator|->
name|st_mtim
operator|.
name|tv_nsec
argument_list|)
expr_stmt|;
else|else
name|printf
argument_list|(
literal|", "
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"ctime="
argument_list|)
expr_stmt|;
if|if
condition|(
name|resolv
operator|==
literal|0
condition|)
name|printf
argument_list|(
literal|"%jd"
argument_list|,
operator|(
name|intmax_t
operator|)
name|statp
operator|->
name|st_ctim
operator|.
name|tv_sec
argument_list|)
expr_stmt|;
else|else
block|{
name|tm
operator|=
name|localtime
argument_list|(
operator|&
name|statp
operator|->
name|st_ctim
operator|.
name|tv_sec
argument_list|)
expr_stmt|;
name|strftime
argument_list|(
name|timestr
argument_list|,
sizeof|sizeof
argument_list|(
name|timestr
argument_list|)
argument_list|,
name|TIME_FORMAT
argument_list|,
name|tm
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\"%s\""
argument_list|,
name|timestr
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|statp
operator|->
name|st_ctim
operator|.
name|tv_nsec
operator|!=
literal|0
condition|)
name|printf
argument_list|(
literal|".%09ld, "
argument_list|,
name|statp
operator|->
name|st_ctim
operator|.
name|tv_nsec
argument_list|)
expr_stmt|;
else|else
name|printf
argument_list|(
literal|", "
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"birthtime="
argument_list|)
expr_stmt|;
if|if
condition|(
name|resolv
operator|==
literal|0
condition|)
name|printf
argument_list|(
literal|"%jd"
argument_list|,
operator|(
name|intmax_t
operator|)
name|statp
operator|->
name|st_birthtim
operator|.
name|tv_sec
argument_list|)
expr_stmt|;
else|else
block|{
name|tm
operator|=
name|localtime
argument_list|(
operator|&
name|statp
operator|->
name|st_birthtim
operator|.
name|tv_sec
argument_list|)
expr_stmt|;
name|strftime
argument_list|(
name|timestr
argument_list|,
sizeof|sizeof
argument_list|(
name|timestr
argument_list|)
argument_list|,
name|TIME_FORMAT
argument_list|,
name|tm
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\"%s\""
argument_list|,
name|timestr
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|statp
operator|->
name|st_birthtim
operator|.
name|tv_nsec
operator|!=
literal|0
condition|)
name|printf
argument_list|(
literal|".%09ld, "
argument_list|,
name|statp
operator|->
name|st_birthtim
operator|.
name|tv_nsec
argument_list|)
expr_stmt|;
else|else
name|printf
argument_list|(
literal|", "
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"size=%jd, blksize=%ju, blocks=%jd, flags=0x%x"
argument_list|,
operator|(
name|uintmax_t
operator|)
name|statp
operator|->
name|st_size
argument_list|,
operator|(
name|uintmax_t
operator|)
name|statp
operator|->
name|st_blksize
argument_list|,
operator|(
name|intmax_t
operator|)
name|statp
operator|->
name|st_blocks
argument_list|,
name|statp
operator|->
name|st_flags
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|" }\n"
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|ktrstruct
parameter_list|(
name|char
modifier|*
name|buf
parameter_list|,
name|size_t
name|buflen
parameter_list|)
block|{
name|char
modifier|*
name|name
decl_stmt|,
modifier|*
name|data
decl_stmt|;
name|size_t
name|namelen
decl_stmt|,
name|datalen
decl_stmt|;
name|int
name|i
decl_stmt|;
name|cap_rights_t
name|rights
decl_stmt|;
name|struct
name|itimerval
name|it
decl_stmt|;
name|struct
name|stat
name|sb
decl_stmt|;
name|struct
name|sockaddr_storage
name|ss
decl_stmt|;
for|for
control|(
name|name
operator|=
name|buf
operator|,
name|namelen
operator|=
literal|0
init|;
name|namelen
operator|<
name|buflen
operator|&&
name|name
index|[
name|namelen
index|]
operator|!=
literal|'\0'
condition|;
operator|++
name|namelen
control|)
comment|/* nothing */
empty_stmt|;
if|if
condition|(
name|namelen
operator|==
name|buflen
condition|)
goto|goto
name|invalid
goto|;
if|if
condition|(
name|name
index|[
name|namelen
index|]
operator|!=
literal|'\0'
condition|)
goto|goto
name|invalid
goto|;
name|data
operator|=
name|buf
operator|+
name|namelen
operator|+
literal|1
expr_stmt|;
name|datalen
operator|=
name|buflen
operator|-
name|namelen
operator|-
literal|1
expr_stmt|;
if|if
condition|(
name|datalen
operator|==
literal|0
condition|)
goto|goto
name|invalid
goto|;
comment|/* sanity check */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
operator|(
name|int
operator|)
name|namelen
condition|;
operator|++
name|i
control|)
if|if
condition|(
operator|!
name|isalpha
argument_list|(
name|name
index|[
name|i
index|]
argument_list|)
condition|)
goto|goto
name|invalid
goto|;
if|if
condition|(
name|strcmp
argument_list|(
name|name
argument_list|,
literal|"caprights"
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|datalen
operator|!=
sizeof|sizeof
argument_list|(
name|cap_rights_t
argument_list|)
condition|)
goto|goto
name|invalid
goto|;
name|memcpy
argument_list|(
operator|&
name|rights
argument_list|,
name|data
argument_list|,
name|datalen
argument_list|)
expr_stmt|;
name|ktrcaprights
argument_list|(
operator|&
name|rights
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|name
argument_list|,
literal|"itimerval"
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|datalen
operator|!=
sizeof|sizeof
argument_list|(
expr|struct
name|itimerval
argument_list|)
condition|)
goto|goto
name|invalid
goto|;
name|memcpy
argument_list|(
operator|&
name|it
argument_list|,
name|data
argument_list|,
name|datalen
argument_list|)
expr_stmt|;
name|ktritimerval
argument_list|(
operator|&
name|it
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|name
argument_list|,
literal|"stat"
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|datalen
operator|!=
sizeof|sizeof
argument_list|(
expr|struct
name|stat
argument_list|)
condition|)
goto|goto
name|invalid
goto|;
name|memcpy
argument_list|(
operator|&
name|sb
argument_list|,
name|data
argument_list|,
name|datalen
argument_list|)
expr_stmt|;
name|ktrstat
argument_list|(
operator|&
name|sb
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|name
argument_list|,
literal|"sockaddr"
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|datalen
operator|>
sizeof|sizeof
argument_list|(
name|ss
argument_list|)
condition|)
goto|goto
name|invalid
goto|;
name|memcpy
argument_list|(
operator|&
name|ss
argument_list|,
name|data
argument_list|,
name|datalen
argument_list|)
expr_stmt|;
if|if
condition|(
name|datalen
operator|!=
name|ss
operator|.
name|ss_len
condition|)
goto|goto
name|invalid
goto|;
name|ktrsockaddr
argument_list|(
operator|(
expr|struct
name|sockaddr
operator|*
operator|)
operator|&
name|ss
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|printf
argument_list|(
literal|"unknown structure\n"
argument_list|)
expr_stmt|;
block|}
return|return;
name|invalid
label|:
name|printf
argument_list|(
literal|"invalid record\n"
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|ktrcapfail
parameter_list|(
name|struct
name|ktr_cap_fail
modifier|*
name|ktr
parameter_list|)
block|{
switch|switch
condition|(
name|ktr
operator|->
name|cap_type
condition|)
block|{
case|case
name|CAPFAIL_NOTCAPABLE
case|:
comment|/* operation on fd with insufficient capabilities */
name|printf
argument_list|(
literal|"operation requires "
argument_list|)
expr_stmt|;
name|sysdecode_cap_rights
argument_list|(
name|stdout
argument_list|,
operator|&
name|ktr
operator|->
name|cap_needed
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|", descriptor holds "
argument_list|)
expr_stmt|;
name|sysdecode_cap_rights
argument_list|(
name|stdout
argument_list|,
operator|&
name|ktr
operator|->
name|cap_held
argument_list|)
expr_stmt|;
break|break;
case|case
name|CAPFAIL_INCREASE
case|:
comment|/* requested more capabilities than fd already has */
name|printf
argument_list|(
literal|"attempt to increase capabilities from "
argument_list|)
expr_stmt|;
name|sysdecode_cap_rights
argument_list|(
name|stdout
argument_list|,
operator|&
name|ktr
operator|->
name|cap_held
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|" to "
argument_list|)
expr_stmt|;
name|sysdecode_cap_rights
argument_list|(
name|stdout
argument_list|,
operator|&
name|ktr
operator|->
name|cap_needed
argument_list|)
expr_stmt|;
break|break;
case|case
name|CAPFAIL_SYSCALL
case|:
comment|/* called restricted syscall */
name|printf
argument_list|(
literal|"disallowed system call"
argument_list|)
expr_stmt|;
break|break;
case|case
name|CAPFAIL_LOOKUP
case|:
comment|/* used ".." in strict-relative mode */
name|printf
argument_list|(
literal|"restricted VFS lookup"
argument_list|)
expr_stmt|;
break|break;
default|default:
name|printf
argument_list|(
literal|"unknown capability failure: "
argument_list|)
expr_stmt|;
name|sysdecode_cap_rights
argument_list|(
name|stdout
argument_list|,
operator|&
name|ktr
operator|->
name|cap_needed
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|" "
argument_list|)
expr_stmt|;
name|sysdecode_cap_rights
argument_list|(
name|stdout
argument_list|,
operator|&
name|ktr
operator|->
name|cap_held
argument_list|)
expr_stmt|;
break|break;
block|}
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|ktrfault
parameter_list|(
name|struct
name|ktr_fault
modifier|*
name|ktr
parameter_list|)
block|{
name|printf
argument_list|(
literal|"0x%jx "
argument_list|,
operator|(
name|uintmax_t
operator|)
name|ktr
operator|->
name|vaddr
argument_list|)
expr_stmt|;
name|print_mask_arg
argument_list|(
name|sysdecode_vmprot
argument_list|,
name|ktr
operator|->
name|type
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|ktrfaultend
parameter_list|(
name|struct
name|ktr_faultend
modifier|*
name|ktr
parameter_list|)
block|{
specifier|const
name|char
modifier|*
name|str
decl_stmt|;
name|str
operator|=
name|sysdecode_vmresult
argument_list|(
name|ktr
operator|->
name|result
argument_list|)
expr_stmt|;
if|if
condition|(
name|str
operator|!=
name|NULL
condition|)
name|printf
argument_list|(
literal|"%s"
argument_list|,
name|str
argument_list|)
expr_stmt|;
else|else
name|printf
argument_list|(
literal|"<invalid=%d>"
argument_list|,
name|ktr
operator|->
name|result
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|usage
parameter_list|(
name|void
parameter_list|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"usage: kdump [-dEnlHRrSsTA] [-f trfile] "
literal|"[-m maxdata] [-p pid] [-t trstr]\n"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
end_function

end_unit


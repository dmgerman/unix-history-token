begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*-  * Copyright (c) 1988, 1993  *	The Regents of the University of California.  All rights reserved.  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions  * are met:  * 1. Redistributions of source code must retain the above copyright  *    notice, this list of conditions and the following disclaimer.  * 2. Redistributions in binary form must reproduce the above copyright  *    notice, this list of conditions and the following disclaimer in the  *    documentation and/or other materials provided with the distribution.  * 3. All advertising materials mentioning features or use of this software  *    must display the following acknowledgement:  *	This product includes software developed by the University of  *	California, Berkeley and its contributors.  * 4. Neither the name of the University nor the names of its contributors  *    may be used to endorse or promote products derived from this software  *    without specific prior written permission.  *  * THIS SOFTWARE IS PROVIDED BY THE REGENTS AND CONTRIBUTORS ``AS IS'' AND  * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE  * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE  * ARE DISCLAIMED.  IN NO EVENT SHALL THE REGENTS OR CONTRIBUTORS BE LIABLE  * FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL  * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS  * OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)  * HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT  * LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY  * OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF  * SUCH DAMAGE.  */
end_comment

begin_ifndef
ifndef|#
directive|ifndef
name|lint
end_ifndef

begin_decl_stmt
specifier|static
specifier|const
name|char
name|copyright
index|[]
init|=
literal|"@(#) Copyright (c) 1988, 1993\n\ 	The Regents of the University of California.  All rights reserved.\n"
decl_stmt|;
end_decl_stmt

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* not lint */
end_comment

begin_ifndef
ifndef|#
directive|ifndef
name|lint
end_ifndef

begin_if
if|#
directive|if
literal|0
end_if

begin_endif
unit|static char sccsid[] = "@(#)kdump.c	8.1 (Berkeley) 6/6/93";
endif|#
directive|endif
end_endif

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* not lint */
end_comment

begin_include
include|#
directive|include
file|<sys/cdefs.h>
end_include

begin_expr_stmt
name|__FBSDID
argument_list|(
literal|"$FreeBSD$"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_define
define|#
directive|define
name|_KERNEL
end_define

begin_decl_stmt
specifier|extern
name|int
name|errno
decl_stmt|;
end_decl_stmt

begin_include
include|#
directive|include
file|<sys/errno.h>
end_include

begin_undef
undef|#
directive|undef
name|_KERNEL
end_undef

begin_include
include|#
directive|include
file|<sys/param.h>
end_include

begin_include
include|#
directive|include
file|<sys/errno.h>
end_include

begin_define
define|#
directive|define
name|_KERNEL
end_define

begin_include
include|#
directive|include
file|<sys/time.h>
end_include

begin_undef
undef|#
directive|undef
name|_KERNEL
end_undef

begin_include
include|#
directive|include
file|<sys/uio.h>
end_include

begin_include
include|#
directive|include
file|<sys/ktrace.h>
end_include

begin_include
include|#
directive|include
file|<sys/ioctl.h>
end_include

begin_include
include|#
directive|include
file|<sys/socket.h>
end_include

begin_include
include|#
directive|include
file|<dlfcn.h>
end_include

begin_include
include|#
directive|include
file|<err.h>
end_include

begin_include
include|#
directive|include
file|<locale.h>
end_include

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_include
include|#
directive|include
file|<stdlib.h>
end_include

begin_include
include|#
directive|include
file|<string.h>
end_include

begin_include
include|#
directive|include
file|<unistd.h>
end_include

begin_include
include|#
directive|include
file|<vis.h>
end_include

begin_include
include|#
directive|include
file|"ktrace.h"
end_include

begin_include
include|#
directive|include
file|"kdump_subr.h"
end_include

begin_function_decl
name|int
name|fread_tail
parameter_list|(
name|void
modifier|*
parameter_list|,
name|int
parameter_list|,
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|void
name|dumpheader
parameter_list|(
name|struct
name|ktr_header
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|void
name|ktrsyscall
parameter_list|(
name|struct
name|ktr_syscall
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|void
name|ktrsysret
parameter_list|(
name|struct
name|ktr_sysret
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|void
name|ktrnamei
parameter_list|(
name|char
modifier|*
parameter_list|,
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|void
name|hexdump
parameter_list|(
name|char
modifier|*
parameter_list|,
name|int
parameter_list|,
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|void
name|visdump
parameter_list|(
name|char
modifier|*
parameter_list|,
name|int
parameter_list|,
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|void
name|ktrgenio
parameter_list|(
name|struct
name|ktr_genio
modifier|*
parameter_list|,
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|void
name|ktrpsig
parameter_list|(
name|struct
name|ktr_psig
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|void
name|ktrcsw
parameter_list|(
name|struct
name|ktr_csw
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|void
name|ktruser
parameter_list|(
name|int
parameter_list|,
name|unsigned
name|char
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|void
name|usage
parameter_list|(
name|void
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|const
name|char
modifier|*
name|ioctlname
parameter_list|(
name|u_long
parameter_list|)
function_decl|;
end_function_decl

begin_decl_stmt
name|int
name|timestamp
decl_stmt|,
name|decimal
decl_stmt|,
name|fancy
init|=
literal|1
decl_stmt|,
name|suppressdata
decl_stmt|,
name|tail
decl_stmt|,
name|threads
decl_stmt|,
name|maxdata
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|const
name|char
modifier|*
name|tracefile
init|=
name|DEF_TRACEFILE
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|struct
name|ktr_header
name|ktr_header
decl_stmt|;
end_decl_stmt

begin_define
define|#
directive|define
name|eqs
parameter_list|(
name|s1
parameter_list|,
name|s2
parameter_list|)
value|(strcmp((s1), (s2)) == 0)
end_define

begin_function
name|int
name|main
parameter_list|(
name|int
name|argc
parameter_list|,
name|char
modifier|*
name|argv
index|[]
parameter_list|)
block|{
name|int
name|ch
decl_stmt|,
name|ktrlen
decl_stmt|,
name|size
decl_stmt|;
name|void
modifier|*
name|m
decl_stmt|;
name|int
name|trpoints
init|=
name|ALL_POINTS
decl_stmt|;
name|int
name|drop_logged
decl_stmt|;
name|pid_t
name|pid
init|=
literal|0
decl_stmt|;
operator|(
name|void
operator|)
name|setlocale
argument_list|(
name|LC_CTYPE
argument_list|,
literal|""
argument_list|)
expr_stmt|;
while|while
condition|(
operator|(
name|ch
operator|=
name|getopt
argument_list|(
name|argc
argument_list|,
name|argv
argument_list|,
literal|"f:dElm:np:HRsTt:"
argument_list|)
operator|)
operator|!=
operator|-
literal|1
condition|)
switch|switch
condition|(
operator|(
name|char
operator|)
name|ch
condition|)
block|{
case|case
literal|'f'
case|:
name|tracefile
operator|=
name|optarg
expr_stmt|;
break|break;
case|case
literal|'d'
case|:
name|decimal
operator|=
literal|1
expr_stmt|;
break|break;
case|case
literal|'l'
case|:
name|tail
operator|=
literal|1
expr_stmt|;
break|break;
case|case
literal|'m'
case|:
name|maxdata
operator|=
name|atoi
argument_list|(
name|optarg
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'n'
case|:
name|fancy
operator|=
literal|0
expr_stmt|;
break|break;
case|case
literal|'p'
case|:
name|pid
operator|=
name|atoi
argument_list|(
name|optarg
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'s'
case|:
name|suppressdata
operator|=
literal|1
expr_stmt|;
break|break;
case|case
literal|'E'
case|:
name|timestamp
operator|=
literal|3
expr_stmt|;
comment|/* elapsed timestamp */
break|break;
case|case
literal|'H'
case|:
name|threads
operator|=
literal|1
expr_stmt|;
break|break;
case|case
literal|'R'
case|:
name|timestamp
operator|=
literal|2
expr_stmt|;
comment|/* relative timestamp */
break|break;
case|case
literal|'T'
case|:
name|timestamp
operator|=
literal|1
expr_stmt|;
break|break;
case|case
literal|'t'
case|:
name|trpoints
operator|=
name|getpoints
argument_list|(
name|optarg
argument_list|)
expr_stmt|;
if|if
condition|(
name|trpoints
operator|<
literal|0
condition|)
name|errx
argument_list|(
literal|1
argument_list|,
literal|"unknown trace point in %s"
argument_list|,
name|optarg
argument_list|)
expr_stmt|;
break|break;
default|default:
name|usage
argument_list|()
expr_stmt|;
block|}
if|if
condition|(
name|argc
operator|>
name|optind
condition|)
name|usage
argument_list|()
expr_stmt|;
name|m
operator|=
operator|(
name|void
operator|*
operator|)
name|malloc
argument_list|(
name|size
operator|=
literal|1025
argument_list|)
expr_stmt|;
if|if
condition|(
name|m
operator|==
name|NULL
condition|)
name|errx
argument_list|(
literal|1
argument_list|,
literal|"%s"
argument_list|,
name|strerror
argument_list|(
name|ENOMEM
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|freopen
argument_list|(
name|tracefile
argument_list|,
literal|"r"
argument_list|,
name|stdin
argument_list|)
condition|)
name|err
argument_list|(
literal|1
argument_list|,
literal|"%s"
argument_list|,
name|tracefile
argument_list|)
expr_stmt|;
name|drop_logged
operator|=
literal|0
expr_stmt|;
while|while
condition|(
name|fread_tail
argument_list|(
operator|&
name|ktr_header
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|ktr_header
argument_list|)
argument_list|,
literal|1
argument_list|)
condition|)
block|{
if|if
condition|(
name|ktr_header
operator|.
name|ktr_type
operator|&
name|KTR_DROP
condition|)
block|{
name|ktr_header
operator|.
name|ktr_type
operator|&=
operator|~
name|KTR_DROP
expr_stmt|;
if|if
condition|(
operator|!
name|drop_logged
operator|&&
name|threads
condition|)
block|{
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"%6d %6d %-8.*s Events dropped.\n"
argument_list|,
name|ktr_header
operator|.
name|ktr_pid
argument_list|,
name|ktr_header
operator|.
name|ktr_tid
operator|>
literal|0
condition|?
name|ktr_header
operator|.
name|ktr_tid
else|:
literal|0
argument_list|,
name|MAXCOMLEN
argument_list|,
name|ktr_header
operator|.
name|ktr_comm
argument_list|)
expr_stmt|;
name|drop_logged
operator|=
literal|1
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|!
name|drop_logged
condition|)
block|{
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"%6d %-8.*s Events dropped.\n"
argument_list|,
name|ktr_header
operator|.
name|ktr_pid
argument_list|,
name|MAXCOMLEN
argument_list|,
name|ktr_header
operator|.
name|ktr_comm
argument_list|)
expr_stmt|;
name|drop_logged
operator|=
literal|1
expr_stmt|;
block|}
block|}
if|if
condition|(
name|trpoints
operator|&
operator|(
literal|1
operator|<<
name|ktr_header
operator|.
name|ktr_type
operator|)
condition|)
if|if
condition|(
name|pid
operator|==
literal|0
operator|||
name|ktr_header
operator|.
name|ktr_pid
operator|==
name|pid
condition|)
name|dumpheader
argument_list|(
operator|&
name|ktr_header
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|ktrlen
operator|=
name|ktr_header
operator|.
name|ktr_len
operator|)
operator|<
literal|0
condition|)
name|errx
argument_list|(
literal|1
argument_list|,
literal|"bogus length 0x%x"
argument_list|,
name|ktrlen
argument_list|)
expr_stmt|;
if|if
condition|(
name|ktrlen
operator|>
name|size
condition|)
block|{
name|m
operator|=
operator|(
name|void
operator|*
operator|)
name|realloc
argument_list|(
name|m
argument_list|,
name|ktrlen
operator|+
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|m
operator|==
name|NULL
condition|)
name|errx
argument_list|(
literal|1
argument_list|,
literal|"%s"
argument_list|,
name|strerror
argument_list|(
name|ENOMEM
argument_list|)
argument_list|)
expr_stmt|;
name|size
operator|=
name|ktrlen
expr_stmt|;
block|}
if|if
condition|(
name|ktrlen
operator|&&
name|fread_tail
argument_list|(
name|m
argument_list|,
name|ktrlen
argument_list|,
literal|1
argument_list|)
operator|==
literal|0
condition|)
name|errx
argument_list|(
literal|1
argument_list|,
literal|"data too short"
argument_list|)
expr_stmt|;
if|if
condition|(
name|pid
operator|&&
name|ktr_header
operator|.
name|ktr_pid
operator|!=
name|pid
condition|)
continue|continue;
if|if
condition|(
operator|(
name|trpoints
operator|&
operator|(
literal|1
operator|<<
name|ktr_header
operator|.
name|ktr_type
operator|)
operator|)
operator|==
literal|0
condition|)
continue|continue;
name|drop_logged
operator|=
literal|0
expr_stmt|;
switch|switch
condition|(
name|ktr_header
operator|.
name|ktr_type
condition|)
block|{
case|case
name|KTR_SYSCALL
case|:
name|ktrsyscall
argument_list|(
operator|(
expr|struct
name|ktr_syscall
operator|*
operator|)
name|m
argument_list|)
expr_stmt|;
break|break;
case|case
name|KTR_SYSRET
case|:
name|ktrsysret
argument_list|(
operator|(
expr|struct
name|ktr_sysret
operator|*
operator|)
name|m
argument_list|)
expr_stmt|;
break|break;
case|case
name|KTR_NAMEI
case|:
name|ktrnamei
argument_list|(
name|m
argument_list|,
name|ktrlen
argument_list|)
expr_stmt|;
break|break;
case|case
name|KTR_GENIO
case|:
name|ktrgenio
argument_list|(
operator|(
expr|struct
name|ktr_genio
operator|*
operator|)
name|m
argument_list|,
name|ktrlen
argument_list|)
expr_stmt|;
break|break;
case|case
name|KTR_PSIG
case|:
name|ktrpsig
argument_list|(
operator|(
expr|struct
name|ktr_psig
operator|*
operator|)
name|m
argument_list|)
expr_stmt|;
break|break;
case|case
name|KTR_CSW
case|:
name|ktrcsw
argument_list|(
operator|(
expr|struct
name|ktr_csw
operator|*
operator|)
name|m
argument_list|)
expr_stmt|;
break|break;
case|case
name|KTR_USER
case|:
name|ktruser
argument_list|(
name|ktrlen
argument_list|,
name|m
argument_list|)
expr_stmt|;
break|break;
default|default:
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|tail
condition|)
operator|(
name|void
operator|)
name|fflush
argument_list|(
name|stdout
argument_list|)
expr_stmt|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
name|int
name|fread_tail
parameter_list|(
name|void
modifier|*
name|buf
parameter_list|,
name|int
name|size
parameter_list|,
name|int
name|num
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
while|while
condition|(
operator|(
name|i
operator|=
name|fread
argument_list|(
name|buf
argument_list|,
name|size
argument_list|,
name|num
argument_list|,
name|stdin
argument_list|)
operator|)
operator|==
literal|0
operator|&&
name|tail
condition|)
block|{
operator|(
name|void
operator|)
name|sleep
argument_list|(
literal|1
argument_list|)
expr_stmt|;
name|clearerr
argument_list|(
name|stdin
argument_list|)
expr_stmt|;
block|}
return|return
operator|(
name|i
operator|)
return|;
block|}
end_function

begin_function
name|void
name|dumpheader
parameter_list|(
name|struct
name|ktr_header
modifier|*
name|kth
parameter_list|)
block|{
specifier|static
name|char
name|unknown
index|[
literal|64
index|]
decl_stmt|;
specifier|static
name|struct
name|timeval
name|prevtime
decl_stmt|,
name|temp
decl_stmt|;
specifier|const
name|char
modifier|*
name|type
decl_stmt|;
switch|switch
condition|(
name|kth
operator|->
name|ktr_type
condition|)
block|{
case|case
name|KTR_SYSCALL
case|:
name|type
operator|=
literal|"CALL"
expr_stmt|;
break|break;
case|case
name|KTR_SYSRET
case|:
name|type
operator|=
literal|"RET "
expr_stmt|;
break|break;
case|case
name|KTR_NAMEI
case|:
name|type
operator|=
literal|"NAMI"
expr_stmt|;
break|break;
case|case
name|KTR_GENIO
case|:
name|type
operator|=
literal|"GIO "
expr_stmt|;
break|break;
case|case
name|KTR_PSIG
case|:
name|type
operator|=
literal|"PSIG"
expr_stmt|;
break|break;
case|case
name|KTR_CSW
case|:
name|type
operator|=
literal|"CSW "
expr_stmt|;
break|break;
case|case
name|KTR_USER
case|:
name|type
operator|=
literal|"USER"
expr_stmt|;
break|break;
default|default:
operator|(
name|void
operator|)
name|sprintf
argument_list|(
name|unknown
argument_list|,
literal|"UNKNOWN(%d)"
argument_list|,
name|kth
operator|->
name|ktr_type
argument_list|)
expr_stmt|;
name|type
operator|=
name|unknown
expr_stmt|;
block|}
comment|/* 	 * The ktr_tid field was previously the ktr_buffer field, which held 	 * the kernel pointer value for the buffer associated with data 	 * following the record header.  It now holds a threadid, but only 	 * for trace files after the change.  Older trace files still contain 	 * kernel pointers.  Detect this and suppress the results by printing 	 * negative tid's as 0. 	 */
if|if
condition|(
name|threads
condition|)
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"%6d %6d %-8.*s "
argument_list|,
name|kth
operator|->
name|ktr_pid
argument_list|,
name|kth
operator|->
name|ktr_tid
operator|>
literal|0
condition|?
name|kth
operator|->
name|ktr_tid
else|:
literal|0
argument_list|,
name|MAXCOMLEN
argument_list|,
name|kth
operator|->
name|ktr_comm
argument_list|)
expr_stmt|;
else|else
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"%6d %-8.*s "
argument_list|,
name|kth
operator|->
name|ktr_pid
argument_list|,
name|MAXCOMLEN
argument_list|,
name|kth
operator|->
name|ktr_comm
argument_list|)
expr_stmt|;
if|if
condition|(
name|timestamp
condition|)
block|{
if|if
condition|(
name|timestamp
operator|==
literal|3
condition|)
block|{
if|if
condition|(
name|prevtime
operator|.
name|tv_sec
operator|==
literal|0
condition|)
name|prevtime
operator|=
name|kth
operator|->
name|ktr_time
expr_stmt|;
name|timevalsub
argument_list|(
operator|&
name|kth
operator|->
name|ktr_time
argument_list|,
operator|&
name|prevtime
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|timestamp
operator|==
literal|2
condition|)
block|{
name|temp
operator|=
name|kth
operator|->
name|ktr_time
expr_stmt|;
name|timevalsub
argument_list|(
operator|&
name|kth
operator|->
name|ktr_time
argument_list|,
operator|&
name|prevtime
argument_list|)
expr_stmt|;
name|prevtime
operator|=
name|temp
expr_stmt|;
block|}
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"%ld.%06ld "
argument_list|,
name|kth
operator|->
name|ktr_time
operator|.
name|tv_sec
argument_list|,
name|kth
operator|->
name|ktr_time
operator|.
name|tv_usec
argument_list|)
expr_stmt|;
block|}
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"%s  "
argument_list|,
name|type
argument_list|)
expr_stmt|;
block|}
end_function

begin_include
include|#
directive|include
file|<sys/syscall.h>
end_include

begin_define
define|#
directive|define
name|KTRACE
end_define

begin_include
include|#
directive|include
file|<sys/kern/syscalls.c>
end_include

begin_undef
undef|#
directive|undef
name|KTRACE
end_undef

begin_decl_stmt
name|int
name|nsyscalls
init|=
sizeof|sizeof
argument_list|(
name|syscallnames
argument_list|)
operator|/
sizeof|sizeof
argument_list|(
name|syscallnames
index|[
literal|0
index|]
argument_list|)
decl_stmt|;
end_decl_stmt

begin_function
name|void
name|ktrsyscall
parameter_list|(
name|struct
name|ktr_syscall
modifier|*
name|ktr
parameter_list|)
block|{
name|int
name|narg
init|=
name|ktr
operator|->
name|ktr_narg
decl_stmt|;
name|register_t
modifier|*
name|ip
decl_stmt|;
if|if
condition|(
name|ktr
operator|->
name|ktr_code
operator|>=
name|nsyscalls
operator|||
name|ktr
operator|->
name|ktr_code
operator|<
literal|0
condition|)
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"[%d]"
argument_list|,
name|ktr
operator|->
name|ktr_code
argument_list|)
expr_stmt|;
else|else
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"%s"
argument_list|,
name|syscallnames
index|[
name|ktr
operator|->
name|ktr_code
index|]
argument_list|)
expr_stmt|;
name|ip
operator|=
operator|&
name|ktr
operator|->
name|ktr_args
index|[
literal|0
index|]
expr_stmt|;
if|if
condition|(
name|narg
condition|)
block|{
name|char
name|c
init|=
literal|'('
decl_stmt|;
if|if
condition|(
name|fancy
condition|)
block|{
define|#
directive|define
name|print_number
parameter_list|(
name|i
parameter_list|,
name|n
parameter_list|,
name|c
parameter_list|)
value|do {                      \ 	if (decimal)                                  \ 		(void)printf("%c%ld", c, (long)*i);   \ 	else                                          \ 		(void)printf("%c%#lx", c, (long)*i);  \ 	i++;                                          \ 	n--;                                          \ 	c = ',';                                      \ 	} while (0);
if|if
condition|(
name|ktr
operator|->
name|ktr_code
operator|==
name|SYS_ioctl
condition|)
block|{
specifier|const
name|char
modifier|*
name|cp
decl_stmt|;
name|print_number
argument_list|(
name|ip
argument_list|,
name|narg
argument_list|,
name|c
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|cp
operator|=
name|ioctlname
argument_list|(
operator|*
name|ip
argument_list|)
operator|)
operator|!=
name|NULL
condition|)
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|",%s"
argument_list|,
name|cp
argument_list|)
expr_stmt|;
else|else
block|{
if|if
condition|(
name|decimal
condition|)
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|",%ld"
argument_list|,
operator|(
name|long
operator|)
operator|*
name|ip
argument_list|)
expr_stmt|;
else|else
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|",%#lx "
argument_list|,
operator|(
name|long
operator|)
operator|*
name|ip
argument_list|)
expr_stmt|;
block|}
name|c
operator|=
literal|','
expr_stmt|;
name|ip
operator|++
expr_stmt|;
name|narg
operator|--
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|ktr
operator|->
name|ktr_code
operator|==
name|SYS_ptrace
condition|)
block|{
operator|(
name|void
operator|)
name|putchar
argument_list|(
literal|'('
argument_list|)
expr_stmt|;
name|ptraceopname
argument_list|(
operator|(
name|int
operator|)
operator|*
name|ip
argument_list|)
expr_stmt|;
name|c
operator|=
literal|','
expr_stmt|;
name|ip
operator|++
expr_stmt|;
name|narg
operator|--
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|ktr
operator|->
name|ktr_code
operator|==
name|SYS_access
operator|||
name|ktr
operator|->
name|ktr_code
operator|==
name|SYS_eaccess
condition|)
block|{
name|print_number
argument_list|(
name|ip
argument_list|,
name|narg
argument_list|,
name|c
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|putchar
argument_list|(
literal|','
argument_list|)
expr_stmt|;
name|accessmodename
argument_list|(
operator|(
name|int
operator|)
operator|*
name|ip
argument_list|)
expr_stmt|;
name|ip
operator|++
expr_stmt|;
name|narg
operator|--
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|ktr
operator|->
name|ktr_code
operator|==
name|SYS_open
condition|)
block|{
name|int
name|flags
decl_stmt|;
name|int
name|mode
decl_stmt|;
name|print_number
argument_list|(
name|ip
argument_list|,
name|narg
argument_list|,
name|c
argument_list|)
expr_stmt|;
name|flags
operator|=
operator|*
name|ip
expr_stmt|;
name|mode
operator|=
operator|*
operator|++
name|ip
expr_stmt|;
operator|(
name|void
operator|)
name|putchar
argument_list|(
literal|','
argument_list|)
expr_stmt|;
name|flagsandmodename
argument_list|(
name|flags
argument_list|,
name|mode
argument_list|,
name|decimal
argument_list|)
expr_stmt|;
name|ip
operator|++
expr_stmt|;
name|narg
operator|-=
literal|2
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|ktr
operator|->
name|ktr_code
operator|==
name|SYS_wait4
condition|)
block|{
name|print_number
argument_list|(
name|ip
argument_list|,
name|narg
argument_list|,
name|c
argument_list|)
expr_stmt|;
name|print_number
argument_list|(
name|ip
argument_list|,
name|narg
argument_list|,
name|c
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|putchar
argument_list|(
literal|','
argument_list|)
expr_stmt|;
name|wait4optname
argument_list|(
operator|(
name|int
operator|)
operator|*
name|ip
argument_list|)
expr_stmt|;
name|ip
operator|++
expr_stmt|;
name|narg
operator|--
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|ktr
operator|->
name|ktr_code
operator|==
name|SYS_chmod
operator|||
name|ktr
operator|->
name|ktr_code
operator|==
name|SYS_fchmod
operator|||
name|ktr
operator|->
name|ktr_code
operator|==
name|SYS_lchmod
condition|)
block|{
name|print_number
argument_list|(
name|ip
argument_list|,
name|narg
argument_list|,
name|c
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|putchar
argument_list|(
literal|','
argument_list|)
expr_stmt|;
name|modename
argument_list|(
operator|(
name|int
operator|)
operator|*
name|ip
argument_list|)
expr_stmt|;
name|ip
operator|++
expr_stmt|;
name|narg
operator|--
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|ktr
operator|->
name|ktr_code
operator|==
name|SYS_mknod
condition|)
block|{
name|print_number
argument_list|(
name|ip
argument_list|,
name|narg
argument_list|,
name|c
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|putchar
argument_list|(
literal|','
argument_list|)
expr_stmt|;
name|modename
argument_list|(
operator|(
name|int
operator|)
operator|*
name|ip
argument_list|)
expr_stmt|;
name|ip
operator|++
expr_stmt|;
name|narg
operator|--
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|ktr
operator|->
name|ktr_code
operator|==
name|SYS_getfsstat
condition|)
block|{
name|print_number
argument_list|(
name|ip
argument_list|,
name|narg
argument_list|,
name|c
argument_list|)
expr_stmt|;
name|print_number
argument_list|(
name|ip
argument_list|,
name|narg
argument_list|,
name|c
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|putchar
argument_list|(
literal|','
argument_list|)
expr_stmt|;
name|getfsstatflagsname
argument_list|(
operator|(
name|int
operator|)
operator|*
name|ip
argument_list|)
expr_stmt|;
name|ip
operator|++
expr_stmt|;
name|narg
operator|--
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|ktr
operator|->
name|ktr_code
operator|==
name|SYS_mount
condition|)
block|{
name|print_number
argument_list|(
name|ip
argument_list|,
name|narg
argument_list|,
name|c
argument_list|)
expr_stmt|;
name|print_number
argument_list|(
name|ip
argument_list|,
name|narg
argument_list|,
name|c
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|putchar
argument_list|(
literal|','
argument_list|)
expr_stmt|;
name|mountflagsname
argument_list|(
operator|(
name|int
operator|)
operator|*
name|ip
argument_list|)
expr_stmt|;
name|ip
operator|++
expr_stmt|;
name|narg
operator|--
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|ktr
operator|->
name|ktr_code
operator|==
name|SYS_unmount
condition|)
block|{
name|print_number
argument_list|(
name|ip
argument_list|,
name|narg
argument_list|,
name|c
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|putchar
argument_list|(
literal|','
argument_list|)
expr_stmt|;
name|mountflagsname
argument_list|(
operator|(
name|int
operator|)
operator|*
name|ip
argument_list|)
expr_stmt|;
name|ip
operator|++
expr_stmt|;
name|narg
operator|--
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|ktr
operator|->
name|ktr_code
operator|==
name|SYS_recvmsg
operator|||
name|ktr
operator|->
name|ktr_code
operator|==
name|SYS_sendmsg
condition|)
block|{
name|print_number
argument_list|(
name|ip
argument_list|,
name|narg
argument_list|,
name|c
argument_list|)
expr_stmt|;
name|print_number
argument_list|(
name|ip
argument_list|,
name|narg
argument_list|,
name|c
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|putchar
argument_list|(
literal|','
argument_list|)
expr_stmt|;
name|sendrecvflagsname
argument_list|(
operator|(
name|int
operator|)
operator|*
name|ip
argument_list|)
expr_stmt|;
name|ip
operator|++
expr_stmt|;
name|narg
operator|--
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|ktr
operator|->
name|ktr_code
operator|==
name|SYS_recvfrom
operator|||
name|ktr
operator|->
name|ktr_code
operator|==
name|SYS_sendto
condition|)
block|{
name|print_number
argument_list|(
name|ip
argument_list|,
name|narg
argument_list|,
name|c
argument_list|)
expr_stmt|;
name|print_number
argument_list|(
name|ip
argument_list|,
name|narg
argument_list|,
name|c
argument_list|)
expr_stmt|;
name|print_number
argument_list|(
name|ip
argument_list|,
name|narg
argument_list|,
name|c
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|putchar
argument_list|(
literal|','
argument_list|)
expr_stmt|;
name|sendrecvflagsname
argument_list|(
operator|(
name|int
operator|)
operator|*
name|ip
argument_list|)
expr_stmt|;
name|ip
operator|++
expr_stmt|;
name|narg
operator|--
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|ktr
operator|->
name|ktr_code
operator|==
name|SYS_chflags
operator|||
name|ktr
operator|->
name|ktr_code
operator|==
name|SYS_fchflags
operator|||
name|ktr
operator|->
name|ktr_code
operator|==
name|SYS_lchflags
condition|)
block|{
name|print_number
argument_list|(
name|ip
argument_list|,
name|narg
argument_list|,
name|c
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|putchar
argument_list|(
literal|','
argument_list|)
expr_stmt|;
name|modename
argument_list|(
operator|(
name|int
operator|)
operator|*
name|ip
argument_list|)
expr_stmt|;
name|ip
operator|++
expr_stmt|;
name|narg
operator|--
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|ktr
operator|->
name|ktr_code
operator|==
name|SYS_kill
condition|)
block|{
name|print_number
argument_list|(
name|ip
argument_list|,
name|narg
argument_list|,
name|c
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|putchar
argument_list|(
literal|','
argument_list|)
expr_stmt|;
name|signame
argument_list|(
operator|(
name|int
operator|)
operator|*
name|ip
argument_list|)
expr_stmt|;
name|ip
operator|++
expr_stmt|;
name|narg
operator|--
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|ktr
operator|->
name|ktr_code
operator|==
name|SYS_reboot
condition|)
block|{
operator|(
name|void
operator|)
name|putchar
argument_list|(
literal|'('
argument_list|)
expr_stmt|;
name|rebootoptname
argument_list|(
operator|(
name|int
operator|)
operator|*
name|ip
argument_list|)
expr_stmt|;
name|ip
operator|++
expr_stmt|;
name|narg
operator|--
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|ktr
operator|->
name|ktr_code
operator|==
name|SYS_umask
condition|)
block|{
operator|(
name|void
operator|)
name|putchar
argument_list|(
literal|'('
argument_list|)
expr_stmt|;
name|modename
argument_list|(
operator|(
name|int
operator|)
operator|*
name|ip
argument_list|)
expr_stmt|;
name|ip
operator|++
expr_stmt|;
name|narg
operator|--
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|ktr
operator|->
name|ktr_code
operator|==
name|SYS_msync
condition|)
block|{
name|print_number
argument_list|(
name|ip
argument_list|,
name|narg
argument_list|,
name|c
argument_list|)
expr_stmt|;
name|print_number
argument_list|(
name|ip
argument_list|,
name|narg
argument_list|,
name|c
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|putchar
argument_list|(
literal|','
argument_list|)
expr_stmt|;
name|msyncflagsname
argument_list|(
operator|(
name|int
operator|)
operator|*
name|ip
argument_list|)
expr_stmt|;
name|ip
operator|++
expr_stmt|;
name|narg
operator|--
expr_stmt|;
ifdef|#
directive|ifdef
name|SYS_freebsd6_mmap
block|}
elseif|else
if|if
condition|(
name|ktr
operator|->
name|ktr_code
operator|==
name|SYS_freebsd6_mmap
condition|)
block|{
name|print_number
argument_list|(
name|ip
argument_list|,
name|narg
argument_list|,
name|c
argument_list|)
expr_stmt|;
name|print_number
argument_list|(
name|ip
argument_list|,
name|narg
argument_list|,
name|c
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|putchar
argument_list|(
literal|','
argument_list|)
expr_stmt|;
name|mmapprotname
argument_list|(
operator|(
name|int
operator|)
operator|*
name|ip
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|putchar
argument_list|(
literal|','
argument_list|)
expr_stmt|;
name|ip
operator|++
expr_stmt|;
name|narg
operator|--
expr_stmt|;
name|mmapflagsname
argument_list|(
operator|(
name|int
operator|)
operator|*
name|ip
argument_list|)
expr_stmt|;
name|ip
operator|++
expr_stmt|;
name|narg
operator|--
expr_stmt|;
endif|#
directive|endif
block|}
elseif|else
if|if
condition|(
name|ktr
operator|->
name|ktr_code
operator|==
name|SYS_mmap
condition|)
block|{
name|print_number
argument_list|(
name|ip
argument_list|,
name|narg
argument_list|,
name|c
argument_list|)
expr_stmt|;
name|print_number
argument_list|(
name|ip
argument_list|,
name|narg
argument_list|,
name|c
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|putchar
argument_list|(
literal|','
argument_list|)
expr_stmt|;
name|mmapprotname
argument_list|(
operator|(
name|int
operator|)
operator|*
name|ip
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|putchar
argument_list|(
literal|','
argument_list|)
expr_stmt|;
name|ip
operator|++
expr_stmt|;
name|narg
operator|--
expr_stmt|;
name|mmapflagsname
argument_list|(
operator|(
name|int
operator|)
operator|*
name|ip
argument_list|)
expr_stmt|;
name|ip
operator|++
expr_stmt|;
name|narg
operator|--
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|ktr
operator|->
name|ktr_code
operator|==
name|SYS_mprotect
condition|)
block|{
name|print_number
argument_list|(
name|ip
argument_list|,
name|narg
argument_list|,
name|c
argument_list|)
expr_stmt|;
name|print_number
argument_list|(
name|ip
argument_list|,
name|narg
argument_list|,
name|c
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|putchar
argument_list|(
literal|','
argument_list|)
expr_stmt|;
name|mmapprotname
argument_list|(
operator|(
name|int
operator|)
operator|*
name|ip
argument_list|)
expr_stmt|;
name|ip
operator|++
expr_stmt|;
name|narg
operator|--
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|ktr
operator|->
name|ktr_code
operator|==
name|SYS_madvise
condition|)
block|{
name|print_number
argument_list|(
name|ip
argument_list|,
name|narg
argument_list|,
name|c
argument_list|)
expr_stmt|;
name|print_number
argument_list|(
name|ip
argument_list|,
name|narg
argument_list|,
name|c
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|putchar
argument_list|(
literal|','
argument_list|)
expr_stmt|;
name|madvisebehavname
argument_list|(
operator|(
name|int
operator|)
operator|*
name|ip
argument_list|)
expr_stmt|;
name|ip
operator|++
expr_stmt|;
name|narg
operator|--
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|ktr
operator|->
name|ktr_code
operator|==
name|SYS_setpriority
condition|)
block|{
name|print_number
argument_list|(
name|ip
argument_list|,
name|narg
argument_list|,
name|c
argument_list|)
expr_stmt|;
name|print_number
argument_list|(
name|ip
argument_list|,
name|narg
argument_list|,
name|c
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|putchar
argument_list|(
literal|','
argument_list|)
expr_stmt|;
name|prioname
argument_list|(
operator|(
name|int
operator|)
operator|*
name|ip
argument_list|)
expr_stmt|;
name|ip
operator|++
expr_stmt|;
name|narg
operator|--
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|ktr
operator|->
name|ktr_code
operator|==
name|SYS_fcntl
condition|)
block|{
name|int
name|cmd
decl_stmt|;
name|int
name|arg
decl_stmt|;
name|print_number
argument_list|(
name|ip
argument_list|,
name|narg
argument_list|,
name|c
argument_list|)
expr_stmt|;
name|cmd
operator|=
operator|*
name|ip
expr_stmt|;
name|arg
operator|=
operator|*
operator|++
name|ip
expr_stmt|;
operator|(
name|void
operator|)
name|putchar
argument_list|(
literal|','
argument_list|)
expr_stmt|;
name|fcntlcmdname
argument_list|(
name|cmd
argument_list|,
name|arg
argument_list|,
name|decimal
argument_list|)
expr_stmt|;
name|ip
operator|++
expr_stmt|;
name|narg
operator|-=
literal|2
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|ktr
operator|->
name|ktr_code
operator|==
name|SYS_socket
condition|)
block|{
name|int
name|sockdomain
decl_stmt|;
operator|(
name|void
operator|)
name|putchar
argument_list|(
literal|'('
argument_list|)
expr_stmt|;
name|sockdomain
operator|=
operator|(
name|int
operator|)
operator|*
name|ip
expr_stmt|;
name|sockdomainname
argument_list|(
name|sockdomain
argument_list|)
expr_stmt|;
name|ip
operator|++
expr_stmt|;
name|narg
operator|--
expr_stmt|;
operator|(
name|void
operator|)
name|putchar
argument_list|(
literal|','
argument_list|)
expr_stmt|;
name|socktypename
argument_list|(
operator|(
name|int
operator|)
operator|*
name|ip
argument_list|)
expr_stmt|;
name|ip
operator|++
expr_stmt|;
name|narg
operator|--
expr_stmt|;
if|if
condition|(
name|sockdomain
operator|==
name|PF_INET
operator|||
name|sockdomain
operator|==
name|PF_INET6
condition|)
block|{
operator|(
name|void
operator|)
name|putchar
argument_list|(
literal|','
argument_list|)
expr_stmt|;
name|sockipprotoname
argument_list|(
operator|(
name|int
operator|)
operator|*
name|ip
argument_list|)
expr_stmt|;
name|ip
operator|++
expr_stmt|;
name|narg
operator|--
expr_stmt|;
block|}
name|c
operator|=
literal|','
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|ktr
operator|->
name|ktr_code
operator|==
name|SYS_setsockopt
operator|||
name|ktr
operator|->
name|ktr_code
operator|==
name|SYS_getsockopt
condition|)
block|{
name|print_number
argument_list|(
name|ip
argument_list|,
name|narg
argument_list|,
name|c
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|putchar
argument_list|(
literal|','
argument_list|)
expr_stmt|;
name|sockoptlevelname
argument_list|(
operator|(
name|int
operator|)
operator|*
name|ip
argument_list|,
name|decimal
argument_list|)
expr_stmt|;
name|ip
operator|++
expr_stmt|;
name|narg
operator|--
expr_stmt|;
operator|(
name|void
operator|)
name|putchar
argument_list|(
literal|','
argument_list|)
expr_stmt|;
name|sockoptname
argument_list|(
operator|(
name|int
operator|)
operator|*
name|ip
argument_list|)
expr_stmt|;
name|ip
operator|++
expr_stmt|;
name|narg
operator|--
expr_stmt|;
ifdef|#
directive|ifdef
name|SYS_freebsd6_lseek
block|}
elseif|else
if|if
condition|(
name|ktr
operator|->
name|ktr_code
operator|==
name|SYS_freebsd6_lseek
condition|)
block|{
name|print_number
argument_list|(
name|ip
argument_list|,
name|narg
argument_list|,
name|c
argument_list|)
expr_stmt|;
comment|/* Hidden 'pad' argument, not in lseek(2) */
name|print_number
argument_list|(
name|ip
argument_list|,
name|narg
argument_list|,
name|c
argument_list|)
expr_stmt|;
name|print_number
argument_list|(
name|ip
argument_list|,
name|narg
argument_list|,
name|c
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|putchar
argument_list|(
literal|','
argument_list|)
expr_stmt|;
name|whencename
argument_list|(
operator|(
name|int
operator|)
operator|*
name|ip
argument_list|)
expr_stmt|;
name|ip
operator|++
expr_stmt|;
name|narg
operator|--
expr_stmt|;
endif|#
directive|endif
block|}
elseif|else
if|if
condition|(
name|ktr
operator|->
name|ktr_code
operator|==
name|SYS_lseek
condition|)
block|{
name|print_number
argument_list|(
name|ip
argument_list|,
name|narg
argument_list|,
name|c
argument_list|)
expr_stmt|;
comment|/* Hidden 'pad' argument, not in lseek(2) */
name|print_number
argument_list|(
name|ip
argument_list|,
name|narg
argument_list|,
name|c
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|putchar
argument_list|(
literal|','
argument_list|)
expr_stmt|;
name|whencename
argument_list|(
operator|(
name|int
operator|)
operator|*
name|ip
argument_list|)
expr_stmt|;
name|ip
operator|++
expr_stmt|;
name|narg
operator|--
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|ktr
operator|->
name|ktr_code
operator|==
name|SYS_flock
condition|)
block|{
name|print_number
argument_list|(
name|ip
argument_list|,
name|narg
argument_list|,
name|c
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|putchar
argument_list|(
literal|','
argument_list|)
expr_stmt|;
name|flockname
argument_list|(
operator|(
name|int
operator|)
operator|*
name|ip
argument_list|)
expr_stmt|;
name|ip
operator|++
expr_stmt|;
name|narg
operator|--
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|ktr
operator|->
name|ktr_code
operator|==
name|SYS_mkfifo
operator|||
name|ktr
operator|->
name|ktr_code
operator|==
name|SYS_mkdir
condition|)
block|{
name|print_number
argument_list|(
name|ip
argument_list|,
name|narg
argument_list|,
name|c
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|putchar
argument_list|(
literal|','
argument_list|)
expr_stmt|;
name|modename
argument_list|(
operator|(
name|int
operator|)
operator|*
name|ip
argument_list|)
expr_stmt|;
name|ip
operator|++
expr_stmt|;
name|narg
operator|--
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|ktr
operator|->
name|ktr_code
operator|==
name|SYS_shutdown
condition|)
block|{
name|print_number
argument_list|(
name|ip
argument_list|,
name|narg
argument_list|,
name|c
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|putchar
argument_list|(
literal|','
argument_list|)
expr_stmt|;
name|shutdownhowname
argument_list|(
operator|(
name|int
operator|)
operator|*
name|ip
argument_list|)
expr_stmt|;
name|ip
operator|++
expr_stmt|;
name|narg
operator|--
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|ktr
operator|->
name|ktr_code
operator|==
name|SYS_socketpair
condition|)
block|{
operator|(
name|void
operator|)
name|putchar
argument_list|(
literal|'('
argument_list|)
expr_stmt|;
name|sockdomainname
argument_list|(
operator|(
name|int
operator|)
operator|*
name|ip
argument_list|)
expr_stmt|;
name|ip
operator|++
expr_stmt|;
name|narg
operator|--
expr_stmt|;
operator|(
name|void
operator|)
name|putchar
argument_list|(
literal|','
argument_list|)
expr_stmt|;
name|socktypename
argument_list|(
operator|(
name|int
operator|)
operator|*
name|ip
argument_list|)
expr_stmt|;
name|ip
operator|++
expr_stmt|;
name|narg
operator|--
expr_stmt|;
name|c
operator|=
literal|','
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|ktr
operator|->
name|ktr_code
operator|==
name|SYS_getrlimit
operator|||
name|ktr
operator|->
name|ktr_code
operator|==
name|SYS_setrlimit
condition|)
block|{
operator|(
name|void
operator|)
name|putchar
argument_list|(
literal|'('
argument_list|)
expr_stmt|;
name|rlimitname
argument_list|(
operator|(
name|int
operator|)
operator|*
name|ip
argument_list|)
expr_stmt|;
name|ip
operator|++
expr_stmt|;
name|narg
operator|--
expr_stmt|;
name|c
operator|=
literal|','
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|ktr
operator|->
name|ktr_code
operator|==
name|SYS_quotactl
condition|)
block|{
name|print_number
argument_list|(
name|ip
argument_list|,
name|narg
argument_list|,
name|c
argument_list|)
expr_stmt|;
name|quotactlname
argument_list|(
operator|(
name|int
operator|)
operator|*
name|ip
argument_list|)
expr_stmt|;
name|ip
operator|++
expr_stmt|;
name|narg
operator|--
expr_stmt|;
name|c
operator|=
literal|','
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|ktr
operator|->
name|ktr_code
operator|==
name|SYS_nfssvc
condition|)
block|{
operator|(
name|void
operator|)
name|putchar
argument_list|(
literal|'('
argument_list|)
expr_stmt|;
name|nfssvcname
argument_list|(
operator|(
name|int
operator|)
operator|*
name|ip
argument_list|)
expr_stmt|;
name|ip
operator|++
expr_stmt|;
name|narg
operator|--
expr_stmt|;
name|c
operator|=
literal|','
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|ktr
operator|->
name|ktr_code
operator|==
name|SYS_rtprio
condition|)
block|{
operator|(
name|void
operator|)
name|putchar
argument_list|(
literal|'('
argument_list|)
expr_stmt|;
name|rtprioname
argument_list|(
operator|(
name|int
operator|)
operator|*
name|ip
argument_list|)
expr_stmt|;
name|ip
operator|++
expr_stmt|;
name|narg
operator|--
expr_stmt|;
name|c
operator|=
literal|','
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|ktr
operator|->
name|ktr_code
operator|==
name|SYS___semctl
condition|)
block|{
name|print_number
argument_list|(
name|ip
argument_list|,
name|narg
argument_list|,
name|c
argument_list|)
expr_stmt|;
name|print_number
argument_list|(
name|ip
argument_list|,
name|narg
argument_list|,
name|c
argument_list|)
expr_stmt|;
name|semctlname
argument_list|(
operator|(
name|int
operator|)
operator|*
name|ip
argument_list|)
expr_stmt|;
name|ip
operator|++
expr_stmt|;
name|narg
operator|--
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|ktr
operator|->
name|ktr_code
operator|==
name|SYS_semget
condition|)
block|{
name|print_number
argument_list|(
name|ip
argument_list|,
name|narg
argument_list|,
name|c
argument_list|)
expr_stmt|;
name|print_number
argument_list|(
name|ip
argument_list|,
name|narg
argument_list|,
name|c
argument_list|)
expr_stmt|;
name|semgetname
argument_list|(
operator|(
name|int
operator|)
operator|*
name|ip
argument_list|)
expr_stmt|;
name|ip
operator|++
expr_stmt|;
name|narg
operator|--
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|ktr
operator|->
name|ktr_code
operator|==
name|SYS_msgctl
condition|)
block|{
name|print_number
argument_list|(
name|ip
argument_list|,
name|narg
argument_list|,
name|c
argument_list|)
expr_stmt|;
name|shmctlname
argument_list|(
operator|(
name|int
operator|)
operator|*
name|ip
argument_list|)
expr_stmt|;
name|ip
operator|++
expr_stmt|;
name|narg
operator|--
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|ktr
operator|->
name|ktr_code
operator|==
name|SYS_shmat
condition|)
block|{
name|print_number
argument_list|(
name|ip
argument_list|,
name|narg
argument_list|,
name|c
argument_list|)
expr_stmt|;
name|print_number
argument_list|(
name|ip
argument_list|,
name|narg
argument_list|,
name|c
argument_list|)
expr_stmt|;
name|shmatname
argument_list|(
operator|(
name|int
operator|)
operator|*
name|ip
argument_list|)
expr_stmt|;
name|ip
operator|++
expr_stmt|;
name|narg
operator|--
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|ktr
operator|->
name|ktr_code
operator|==
name|SYS_shmctl
condition|)
block|{
name|print_number
argument_list|(
name|ip
argument_list|,
name|narg
argument_list|,
name|c
argument_list|)
expr_stmt|;
name|shmctlname
argument_list|(
operator|(
name|int
operator|)
operator|*
name|ip
argument_list|)
expr_stmt|;
name|ip
operator|++
expr_stmt|;
name|narg
operator|--
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|ktr
operator|->
name|ktr_code
operator|==
name|SYS_minherit
condition|)
block|{
name|print_number
argument_list|(
name|ip
argument_list|,
name|narg
argument_list|,
name|c
argument_list|)
expr_stmt|;
name|print_number
argument_list|(
name|ip
argument_list|,
name|narg
argument_list|,
name|c
argument_list|)
expr_stmt|;
name|minheritname
argument_list|(
operator|(
name|int
operator|)
operator|*
name|ip
argument_list|)
expr_stmt|;
name|ip
operator|++
expr_stmt|;
name|narg
operator|--
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|ktr
operator|->
name|ktr_code
operator|==
name|SYS_rfork
condition|)
block|{
operator|(
name|void
operator|)
name|putchar
argument_list|(
literal|'('
argument_list|)
expr_stmt|;
name|rforkname
argument_list|(
operator|(
name|int
operator|)
operator|*
name|ip
argument_list|)
expr_stmt|;
name|ip
operator|++
expr_stmt|;
name|narg
operator|--
expr_stmt|;
name|c
operator|=
literal|','
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|ktr
operator|->
name|ktr_code
operator|==
name|SYS_lio_listio
condition|)
block|{
operator|(
name|void
operator|)
name|putchar
argument_list|(
literal|'('
argument_list|)
expr_stmt|;
name|lio_listioname
argument_list|(
operator|(
name|int
operator|)
operator|*
name|ip
argument_list|)
expr_stmt|;
name|ip
operator|++
expr_stmt|;
name|narg
operator|--
expr_stmt|;
name|c
operator|=
literal|','
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|ktr
operator|->
name|ktr_code
operator|==
name|SYS_mlockall
condition|)
block|{
operator|(
name|void
operator|)
name|putchar
argument_list|(
literal|'('
argument_list|)
expr_stmt|;
name|mlockallname
argument_list|(
operator|(
name|int
operator|)
operator|*
name|ip
argument_list|)
expr_stmt|;
name|ip
operator|++
expr_stmt|;
name|narg
operator|--
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|ktr
operator|->
name|ktr_code
operator|==
name|SYS_sched_setscheduler
condition|)
block|{
name|print_number
argument_list|(
name|ip
argument_list|,
name|narg
argument_list|,
name|c
argument_list|)
expr_stmt|;
name|schedpolicyname
argument_list|(
operator|(
name|int
operator|)
operator|*
name|ip
argument_list|)
expr_stmt|;
name|ip
operator|++
expr_stmt|;
name|narg
operator|--
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|ktr
operator|->
name|ktr_code
operator|==
name|SYS_sched_get_priority_max
operator|||
name|ktr
operator|->
name|ktr_code
operator|==
name|SYS_sched_get_priority_min
condition|)
block|{
operator|(
name|void
operator|)
name|putchar
argument_list|(
literal|'('
argument_list|)
expr_stmt|;
name|schedpolicyname
argument_list|(
operator|(
name|int
operator|)
operator|*
name|ip
argument_list|)
expr_stmt|;
name|ip
operator|++
expr_stmt|;
name|narg
operator|--
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|ktr
operator|->
name|ktr_code
operator|==
name|SYS_sendfile
condition|)
block|{
name|print_number
argument_list|(
name|ip
argument_list|,
name|narg
argument_list|,
name|c
argument_list|)
expr_stmt|;
name|print_number
argument_list|(
name|ip
argument_list|,
name|narg
argument_list|,
name|c
argument_list|)
expr_stmt|;
name|print_number
argument_list|(
name|ip
argument_list|,
name|narg
argument_list|,
name|c
argument_list|)
expr_stmt|;
name|print_number
argument_list|(
name|ip
argument_list|,
name|narg
argument_list|,
name|c
argument_list|)
expr_stmt|;
name|print_number
argument_list|(
name|ip
argument_list|,
name|narg
argument_list|,
name|c
argument_list|)
expr_stmt|;
name|print_number
argument_list|(
name|ip
argument_list|,
name|narg
argument_list|,
name|c
argument_list|)
expr_stmt|;
name|sendfileflagsname
argument_list|(
operator|(
name|int
operator|)
operator|*
name|ip
argument_list|)
expr_stmt|;
name|ip
operator|++
expr_stmt|;
name|narg
operator|--
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|ktr
operator|->
name|ktr_code
operator|==
name|SYS_kldsym
condition|)
block|{
name|print_number
argument_list|(
name|ip
argument_list|,
name|narg
argument_list|,
name|c
argument_list|)
expr_stmt|;
name|kldsymcmdname
argument_list|(
operator|(
name|int
operator|)
operator|*
name|ip
argument_list|)
expr_stmt|;
name|ip
operator|++
expr_stmt|;
name|narg
operator|--
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|ktr
operator|->
name|ktr_code
operator|==
name|SYS_sigprocmask
condition|)
block|{
operator|(
name|void
operator|)
name|putchar
argument_list|(
literal|'('
argument_list|)
expr_stmt|;
name|sigprocmaskhowname
argument_list|(
operator|(
name|int
operator|)
operator|*
name|ip
argument_list|)
expr_stmt|;
name|ip
operator|++
expr_stmt|;
name|narg
operator|--
expr_stmt|;
name|c
operator|=
literal|','
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|ktr
operator|->
name|ktr_code
operator|==
name|SYS___acl_get_file
operator|||
name|ktr
operator|->
name|ktr_code
operator|==
name|SYS___acl_set_file
operator|||
name|ktr
operator|->
name|ktr_code
operator|==
name|SYS___acl_get_fd
operator|||
name|ktr
operator|->
name|ktr_code
operator|==
name|SYS___acl_set_fd
operator|||
name|ktr
operator|->
name|ktr_code
operator|==
name|SYS___acl_delete_file
operator|||
name|ktr
operator|->
name|ktr_code
operator|==
name|SYS___acl_delete_fd
operator|||
name|ktr
operator|->
name|ktr_code
operator|==
name|SYS___acl_aclcheck_file
operator|||
name|ktr
operator|->
name|ktr_code
operator|==
name|SYS___acl_aclcheck_fd
operator|||
name|ktr
operator|->
name|ktr_code
operator|==
name|SYS___acl_get_link
operator|||
name|ktr
operator|->
name|ktr_code
operator|==
name|SYS___acl_set_link
operator|||
name|ktr
operator|->
name|ktr_code
operator|==
name|SYS___acl_delete_link
operator|||
name|ktr
operator|->
name|ktr_code
operator|==
name|SYS___acl_aclcheck_link
condition|)
block|{
name|print_number
argument_list|(
name|ip
argument_list|,
name|narg
argument_list|,
name|c
argument_list|)
expr_stmt|;
name|acltypename
argument_list|(
operator|(
name|int
operator|)
operator|*
name|ip
argument_list|)
expr_stmt|;
name|ip
operator|++
expr_stmt|;
name|narg
operator|--
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|ktr
operator|->
name|ktr_code
operator|==
name|SYS_sigaction
condition|)
block|{
operator|(
name|void
operator|)
name|putchar
argument_list|(
literal|'('
argument_list|)
expr_stmt|;
name|signame
argument_list|(
operator|(
name|int
operator|)
operator|*
name|ip
argument_list|)
expr_stmt|;
name|ip
operator|++
expr_stmt|;
name|narg
operator|--
expr_stmt|;
name|c
operator|=
literal|','
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|ktr
operator|->
name|ktr_code
operator|==
name|SYS_extattrctl
condition|)
block|{
name|print_number
argument_list|(
name|ip
argument_list|,
name|narg
argument_list|,
name|c
argument_list|)
expr_stmt|;
name|extattrctlname
argument_list|(
operator|(
name|int
operator|)
operator|*
name|ip
argument_list|)
expr_stmt|;
name|ip
operator|++
expr_stmt|;
name|narg
operator|--
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|ktr
operator|->
name|ktr_code
operator|==
name|SYS_nmount
condition|)
block|{
name|print_number
argument_list|(
name|ip
argument_list|,
name|narg
argument_list|,
name|c
argument_list|)
expr_stmt|;
name|print_number
argument_list|(
name|ip
argument_list|,
name|narg
argument_list|,
name|c
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|putchar
argument_list|(
literal|','
argument_list|)
expr_stmt|;
name|mountflagsname
argument_list|(
operator|(
name|int
operator|)
operator|*
name|ip
argument_list|)
expr_stmt|;
name|ip
operator|++
expr_stmt|;
name|narg
operator|--
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|ktr
operator|->
name|ktr_code
operator|==
name|SYS_kse_thr_interrupt
condition|)
block|{
name|print_number
argument_list|(
name|ip
argument_list|,
name|narg
argument_list|,
name|c
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|putchar
argument_list|(
literal|','
argument_list|)
expr_stmt|;
name|ksethrcmdname
argument_list|(
operator|(
name|int
operator|)
operator|*
name|ip
argument_list|)
expr_stmt|;
name|ip
operator|++
expr_stmt|;
name|narg
operator|--
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|ktr
operator|->
name|ktr_code
operator|==
name|SYS_thr_create
condition|)
block|{
name|print_number
argument_list|(
name|ip
argument_list|,
name|narg
argument_list|,
name|c
argument_list|)
expr_stmt|;
name|print_number
argument_list|(
name|ip
argument_list|,
name|narg
argument_list|,
name|c
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|putchar
argument_list|(
literal|','
argument_list|)
expr_stmt|;
name|thrcreateflagsname
argument_list|(
operator|(
name|int
operator|)
operator|*
name|ip
argument_list|)
expr_stmt|;
name|ip
operator|++
expr_stmt|;
name|narg
operator|--
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|ktr
operator|->
name|ktr_code
operator|==
name|SYS_thr_kill
condition|)
block|{
name|print_number
argument_list|(
name|ip
argument_list|,
name|narg
argument_list|,
name|c
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|putchar
argument_list|(
literal|','
argument_list|)
expr_stmt|;
name|signame
argument_list|(
operator|(
name|int
operator|)
operator|*
name|ip
argument_list|)
expr_stmt|;
name|ip
operator|++
expr_stmt|;
name|narg
operator|--
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|ktr
operator|->
name|ktr_code
operator|==
name|SYS_kldunloadf
condition|)
block|{
name|print_number
argument_list|(
name|ip
argument_list|,
name|narg
argument_list|,
name|c
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|putchar
argument_list|(
literal|','
argument_list|)
expr_stmt|;
name|kldunloadfflagsname
argument_list|(
operator|(
name|int
operator|)
operator|*
name|ip
argument_list|)
expr_stmt|;
name|ip
operator|++
expr_stmt|;
name|narg
operator|--
expr_stmt|;
block|}
block|}
while|while
condition|(
name|narg
condition|)
block|{
name|print_number
argument_list|(
name|ip
argument_list|,
name|narg
argument_list|,
name|c
argument_list|)
expr_stmt|;
block|}
operator|(
name|void
operator|)
name|putchar
argument_list|(
literal|')'
argument_list|)
expr_stmt|;
block|}
operator|(
name|void
operator|)
name|putchar
argument_list|(
literal|'\n'
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|ktrsysret
parameter_list|(
name|struct
name|ktr_sysret
modifier|*
name|ktr
parameter_list|)
block|{
name|register_t
name|ret
init|=
name|ktr
operator|->
name|ktr_retval
decl_stmt|;
name|int
name|error
init|=
name|ktr
operator|->
name|ktr_error
decl_stmt|;
name|int
name|code
init|=
name|ktr
operator|->
name|ktr_code
decl_stmt|;
if|if
condition|(
name|code
operator|>=
name|nsyscalls
operator|||
name|code
operator|<
literal|0
condition|)
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"[%d] "
argument_list|,
name|code
argument_list|)
expr_stmt|;
else|else
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"%s "
argument_list|,
name|syscallnames
index|[
name|code
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|fancy
condition|)
block|{
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"%d"
argument_list|,
name|ret
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|<
literal|0
operator|||
name|ret
operator|>
literal|9
condition|)
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"/%#lx"
argument_list|,
operator|(
name|long
operator|)
name|ret
argument_list|)
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|decimal
condition|)
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"%ld"
argument_list|,
operator|(
name|long
operator|)
name|ret
argument_list|)
expr_stmt|;
else|else
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"%#lx"
argument_list|,
operator|(
name|long
operator|)
name|ret
argument_list|)
expr_stmt|;
block|}
block|}
elseif|else
if|if
condition|(
name|error
operator|==
name|ERESTART
condition|)
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"RESTART"
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|error
operator|==
name|EJUSTRETURN
condition|)
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"JUSTRETURN"
argument_list|)
expr_stmt|;
else|else
block|{
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"-1 errno %d"
argument_list|,
name|ktr
operator|->
name|ktr_error
argument_list|)
expr_stmt|;
if|if
condition|(
name|fancy
condition|)
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|" %s"
argument_list|,
name|strerror
argument_list|(
name|ktr
operator|->
name|ktr_error
argument_list|)
argument_list|)
expr_stmt|;
block|}
operator|(
name|void
operator|)
name|putchar
argument_list|(
literal|'\n'
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|ktrnamei
parameter_list|(
name|char
modifier|*
name|cp
parameter_list|,
name|int
name|len
parameter_list|)
block|{
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"\"%.*s\"\n"
argument_list|,
name|len
argument_list|,
name|cp
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|hexdump
parameter_list|(
name|char
modifier|*
name|p
parameter_list|,
name|int
name|len
parameter_list|,
name|int
name|screenwidth
parameter_list|)
block|{
name|int
name|n
decl_stmt|,
name|i
decl_stmt|;
name|int
name|width
decl_stmt|;
name|width
operator|=
literal|0
expr_stmt|;
do|do
block|{
name|width
operator|+=
literal|2
expr_stmt|;
name|i
operator|=
literal|13
expr_stmt|;
comment|/* base offset */
name|i
operator|+=
operator|(
name|width
operator|/
literal|2
operator|)
operator|+
literal|1
expr_stmt|;
comment|/* spaces every second byte */
name|i
operator|+=
operator|(
name|width
operator|*
literal|2
operator|)
expr_stmt|;
comment|/* width of bytes */
name|i
operator|+=
literal|3
expr_stmt|;
comment|/* "  |" */
name|i
operator|+=
name|width
expr_stmt|;
comment|/* each byte */
name|i
operator|+=
literal|1
expr_stmt|;
comment|/* "|" */
block|}
do|while
condition|(
name|i
operator|<
name|screenwidth
condition|)
do|;
name|width
operator|-=
literal|2
expr_stmt|;
for|for
control|(
name|n
operator|=
literal|0
init|;
name|n
operator|<
name|len
condition|;
name|n
operator|+=
name|width
control|)
block|{
for|for
control|(
name|i
operator|=
name|n
init|;
name|i
operator|<
name|n
operator|+
name|width
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
operator|(
name|i
operator|%
name|width
operator|)
operator|==
literal|0
condition|)
block|{
comment|/* beginning of line */
name|printf
argument_list|(
literal|"       0x%04x"
argument_list|,
name|i
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|i
operator|%
literal|2
operator|)
operator|==
literal|0
condition|)
block|{
name|printf
argument_list|(
literal|" "
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|i
operator|<
name|len
condition|)
name|printf
argument_list|(
literal|"%02x"
argument_list|,
name|p
index|[
name|i
index|]
operator|&
literal|0xff
argument_list|)
expr_stmt|;
else|else
name|printf
argument_list|(
literal|"  "
argument_list|)
expr_stmt|;
block|}
name|printf
argument_list|(
literal|"  |"
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
name|n
init|;
name|i
operator|<
name|n
operator|+
name|width
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|i
operator|>=
name|len
condition|)
break|break;
if|if
condition|(
name|p
index|[
name|i
index|]
operator|>=
literal|' '
operator|&&
name|p
index|[
name|i
index|]
operator|<=
literal|'~'
condition|)
name|printf
argument_list|(
literal|"%c"
argument_list|,
name|p
index|[
name|i
index|]
argument_list|)
expr_stmt|;
else|else
name|printf
argument_list|(
literal|"."
argument_list|)
expr_stmt|;
block|}
name|printf
argument_list|(
literal|"|\n"
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|i
operator|%
name|width
operator|)
operator|!=
literal|0
condition|)
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|visdump
parameter_list|(
name|char
modifier|*
name|dp
parameter_list|,
name|int
name|datalen
parameter_list|,
name|int
name|screenwidth
parameter_list|)
block|{
name|int
name|col
init|=
literal|0
decl_stmt|;
name|char
modifier|*
name|cp
decl_stmt|;
name|int
name|width
decl_stmt|;
name|char
name|visbuf
index|[
literal|5
index|]
decl_stmt|;
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"       \""
argument_list|)
expr_stmt|;
name|col
operator|=
literal|8
expr_stmt|;
for|for
control|(
init|;
name|datalen
operator|>
literal|0
condition|;
name|datalen
operator|--
operator|,
name|dp
operator|++
control|)
block|{
operator|(
name|void
operator|)
name|vis
argument_list|(
name|visbuf
argument_list|,
operator|*
name|dp
argument_list|,
name|VIS_CSTYLE
argument_list|,
operator|*
operator|(
name|dp
operator|+
literal|1
operator|)
argument_list|)
expr_stmt|;
name|cp
operator|=
name|visbuf
expr_stmt|;
comment|/* 		 * Keep track of printables and 		 * space chars (like fold(1)). 		 */
if|if
condition|(
name|col
operator|==
literal|0
condition|)
block|{
operator|(
name|void
operator|)
name|putchar
argument_list|(
literal|'\t'
argument_list|)
expr_stmt|;
name|col
operator|=
literal|8
expr_stmt|;
block|}
switch|switch
condition|(
operator|*
name|cp
condition|)
block|{
case|case
literal|'\n'
case|:
name|col
operator|=
literal|0
expr_stmt|;
operator|(
name|void
operator|)
name|putchar
argument_list|(
literal|'\n'
argument_list|)
expr_stmt|;
continue|continue;
case|case
literal|'\t'
case|:
name|width
operator|=
literal|8
operator|-
operator|(
name|col
operator|&
literal|07
operator|)
expr_stmt|;
break|break;
default|default:
name|width
operator|=
name|strlen
argument_list|(
name|cp
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|col
operator|+
name|width
operator|>
operator|(
name|screenwidth
operator|-
literal|2
operator|)
condition|)
block|{
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"\\\n\t"
argument_list|)
expr_stmt|;
name|col
operator|=
literal|8
expr_stmt|;
block|}
name|col
operator|+=
name|width
expr_stmt|;
do|do
block|{
operator|(
name|void
operator|)
name|putchar
argument_list|(
operator|*
name|cp
operator|++
argument_list|)
expr_stmt|;
block|}
do|while
condition|(
operator|*
name|cp
condition|)
do|;
block|}
if|if
condition|(
name|col
operator|==
literal|0
condition|)
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"       "
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"\"\n"
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|ktrgenio
parameter_list|(
name|struct
name|ktr_genio
modifier|*
name|ktr
parameter_list|,
name|int
name|len
parameter_list|)
block|{
name|int
name|datalen
init|=
name|len
operator|-
sizeof|sizeof
argument_list|(
expr|struct
name|ktr_genio
argument_list|)
decl_stmt|;
name|char
modifier|*
name|dp
init|=
operator|(
name|char
operator|*
operator|)
name|ktr
operator|+
sizeof|sizeof
argument_list|(
expr|struct
name|ktr_genio
argument_list|)
decl_stmt|;
specifier|static
name|int
name|screenwidth
init|=
literal|0
decl_stmt|;
name|int
name|i
decl_stmt|,
name|binary
decl_stmt|;
if|if
condition|(
name|screenwidth
operator|==
literal|0
condition|)
block|{
name|struct
name|winsize
name|ws
decl_stmt|;
if|if
condition|(
name|fancy
operator|&&
name|ioctl
argument_list|(
name|fileno
argument_list|(
name|stderr
argument_list|)
argument_list|,
name|TIOCGWINSZ
argument_list|,
operator|&
name|ws
argument_list|)
operator|!=
operator|-
literal|1
operator|&&
name|ws
operator|.
name|ws_col
operator|>
literal|8
condition|)
name|screenwidth
operator|=
name|ws
operator|.
name|ws_col
expr_stmt|;
else|else
name|screenwidth
operator|=
literal|80
expr_stmt|;
block|}
name|printf
argument_list|(
literal|"fd %d %s %d byte%s\n"
argument_list|,
name|ktr
operator|->
name|ktr_fd
argument_list|,
name|ktr
operator|->
name|ktr_rw
operator|==
name|UIO_READ
condition|?
literal|"read"
else|:
literal|"wrote"
argument_list|,
name|datalen
argument_list|,
name|datalen
operator|==
literal|1
condition|?
literal|""
else|:
literal|"s"
argument_list|)
expr_stmt|;
if|if
condition|(
name|suppressdata
condition|)
return|return;
if|if
condition|(
name|maxdata
operator|&&
name|datalen
operator|>
name|maxdata
condition|)
name|datalen
operator|=
name|maxdata
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
operator|,
name|binary
operator|=
literal|0
init|;
name|i
operator|<
name|datalen
operator|&&
name|binary
operator|==
literal|0
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|dp
index|[
name|i
index|]
operator|>=
literal|32
operator|&&
name|dp
index|[
name|i
index|]
operator|<
literal|127
condition|)
continue|continue;
if|if
condition|(
name|dp
index|[
name|i
index|]
operator|==
literal|10
operator|||
name|dp
index|[
name|i
index|]
operator|==
literal|13
operator|||
name|dp
index|[
name|i
index|]
operator|==
literal|0
operator|||
name|dp
index|[
name|i
index|]
operator|==
literal|9
condition|)
continue|continue;
name|binary
operator|=
literal|1
expr_stmt|;
block|}
if|if
condition|(
name|binary
condition|)
name|hexdump
argument_list|(
name|dp
argument_list|,
name|datalen
argument_list|,
name|screenwidth
argument_list|)
expr_stmt|;
else|else
name|visdump
argument_list|(
name|dp
argument_list|,
name|datalen
argument_list|,
name|screenwidth
argument_list|)
expr_stmt|;
block|}
end_function

begin_decl_stmt
specifier|const
name|char
modifier|*
name|signames
index|[]
init|=
block|{
literal|"NULL"
block|,
literal|"HUP"
block|,
literal|"INT"
block|,
literal|"QUIT"
block|,
literal|"ILL"
block|,
literal|"TRAP"
block|,
literal|"IOT"
block|,
comment|/*  1 - 6  */
literal|"EMT"
block|,
literal|"FPE"
block|,
literal|"KILL"
block|,
literal|"BUS"
block|,
literal|"SEGV"
block|,
literal|"SYS"
block|,
comment|/*  7 - 12 */
literal|"PIPE"
block|,
literal|"ALRM"
block|,
literal|"TERM"
block|,
literal|"URG"
block|,
literal|"STOP"
block|,
literal|"TSTP"
block|,
comment|/* 13 - 18 */
literal|"CONT"
block|,
literal|"CHLD"
block|,
literal|"TTIN"
block|,
literal|"TTOU"
block|,
literal|"IO"
block|,
literal|"XCPU"
block|,
comment|/* 19 - 24 */
literal|"XFSZ"
block|,
literal|"VTALRM"
block|,
literal|"PROF"
block|,
literal|"WINCH"
block|,
literal|"29"
block|,
literal|"USR1"
block|,
comment|/* 25 - 30 */
literal|"USR2"
block|,
name|NULL
block|,
comment|/* 31 - 32 */
block|}
decl_stmt|;
end_decl_stmt

begin_function
name|void
name|ktrpsig
parameter_list|(
name|struct
name|ktr_psig
modifier|*
name|psig
parameter_list|)
block|{
if|if
condition|(
name|psig
operator|->
name|signo
operator|>
literal|0
operator|&&
name|psig
operator|->
name|signo
operator|<
name|NSIG
condition|)
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"SIG%s "
argument_list|,
name|signames
index|[
name|psig
operator|->
name|signo
index|]
argument_list|)
expr_stmt|;
else|else
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"SIG %d "
argument_list|,
name|psig
operator|->
name|signo
argument_list|)
expr_stmt|;
if|if
condition|(
name|psig
operator|->
name|action
operator|==
name|SIG_DFL
condition|)
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"SIG_DFL\n"
argument_list|)
expr_stmt|;
else|else
block|{
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"caught handler=0x%lx mask=0x%x code=0x%x\n"
argument_list|,
operator|(
name|u_long
operator|)
name|psig
operator|->
name|action
argument_list|,
name|psig
operator|->
name|mask
operator|.
name|__bits
index|[
literal|0
index|]
argument_list|,
name|psig
operator|->
name|code
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
name|void
name|ktrcsw
parameter_list|(
name|struct
name|ktr_csw
modifier|*
name|cs
parameter_list|)
block|{
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"%s %s\n"
argument_list|,
name|cs
operator|->
name|out
condition|?
literal|"stop"
else|:
literal|"resume"
argument_list|,
name|cs
operator|->
name|user
condition|?
literal|"user"
else|:
literal|"kernel"
argument_list|)
expr_stmt|;
block|}
end_function

begin_define
define|#
directive|define
name|UTRACE_DLOPEN_START
value|1
end_define

begin_define
define|#
directive|define
name|UTRACE_DLOPEN_STOP
value|2
end_define

begin_define
define|#
directive|define
name|UTRACE_DLCLOSE_START
value|3
end_define

begin_define
define|#
directive|define
name|UTRACE_DLCLOSE_STOP
value|4
end_define

begin_define
define|#
directive|define
name|UTRACE_LOAD_OBJECT
value|5
end_define

begin_define
define|#
directive|define
name|UTRACE_UNLOAD_OBJECT
value|6
end_define

begin_define
define|#
directive|define
name|UTRACE_ADD_RUNDEP
value|7
end_define

begin_define
define|#
directive|define
name|UTRACE_PRELOAD_FINISHED
value|8
end_define

begin_define
define|#
directive|define
name|UTRACE_INIT_CALL
value|9
end_define

begin_define
define|#
directive|define
name|UTRACE_FINI_CALL
value|10
end_define

begin_struct
struct|struct
name|utrace_rtld
block|{
name|char
name|sig
index|[
literal|4
index|]
decl_stmt|;
comment|/* 'RTLD' */
name|int
name|event
decl_stmt|;
name|void
modifier|*
name|handle
decl_stmt|;
name|void
modifier|*
name|mapbase
decl_stmt|;
name|size_t
name|mapsize
decl_stmt|;
name|int
name|refcnt
decl_stmt|;
name|char
name|name
index|[
name|MAXPATHLEN
index|]
decl_stmt|;
block|}
struct|;
end_struct

begin_function
name|void
name|ktruser_rtld
parameter_list|(
name|int
name|len
parameter_list|,
name|unsigned
name|char
modifier|*
name|p
parameter_list|)
block|{
name|struct
name|utrace_rtld
modifier|*
name|ut
init|=
operator|(
expr|struct
name|utrace_rtld
operator|*
operator|)
name|p
decl_stmt|;
name|void
modifier|*
name|parent
decl_stmt|;
name|int
name|mode
decl_stmt|;
switch|switch
condition|(
name|ut
operator|->
name|event
condition|)
block|{
case|case
name|UTRACE_DLOPEN_START
case|:
name|mode
operator|=
name|ut
operator|->
name|refcnt
expr_stmt|;
name|printf
argument_list|(
literal|"dlopen(%s, "
argument_list|,
name|ut
operator|->
name|name
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|mode
operator|&
name|RTLD_MODEMASK
condition|)
block|{
case|case
name|RTLD_NOW
case|:
name|printf
argument_list|(
literal|"RTLD_NOW"
argument_list|)
expr_stmt|;
break|break;
case|case
name|RTLD_LAZY
case|:
name|printf
argument_list|(
literal|"RTLD_LAZY"
argument_list|)
expr_stmt|;
break|break;
default|default:
name|printf
argument_list|(
literal|"%#x"
argument_list|,
name|mode
operator|&
name|RTLD_MODEMASK
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|mode
operator|&
name|RTLD_GLOBAL
condition|)
name|printf
argument_list|(
literal|" | RTLD_GLOBAL"
argument_list|)
expr_stmt|;
if|if
condition|(
name|mode
operator|&
name|RTLD_TRACE
condition|)
name|printf
argument_list|(
literal|" | RTLD_TRACE"
argument_list|)
expr_stmt|;
if|if
condition|(
name|mode
operator|&
operator|~
operator|(
name|RTLD_MODEMASK
operator||
name|RTLD_GLOBAL
operator||
name|RTLD_TRACE
operator|)
condition|)
name|printf
argument_list|(
literal|" | %#x"
argument_list|,
name|mode
operator|&
operator|~
operator|(
name|RTLD_MODEMASK
operator||
name|RTLD_GLOBAL
operator||
name|RTLD_TRACE
operator|)
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|")\n"
argument_list|)
expr_stmt|;
break|break;
case|case
name|UTRACE_DLOPEN_STOP
case|:
name|printf
argument_list|(
literal|"%p = dlopen(%s) ref %d\n"
argument_list|,
name|ut
operator|->
name|handle
argument_list|,
name|ut
operator|->
name|name
argument_list|,
name|ut
operator|->
name|refcnt
argument_list|)
expr_stmt|;
break|break;
case|case
name|UTRACE_DLCLOSE_START
case|:
name|printf
argument_list|(
literal|"dlclose(%p) (%s, %d)\n"
argument_list|,
name|ut
operator|->
name|handle
argument_list|,
name|ut
operator|->
name|name
argument_list|,
name|ut
operator|->
name|refcnt
argument_list|)
expr_stmt|;
break|break;
case|case
name|UTRACE_DLCLOSE_STOP
case|:
name|printf
argument_list|(
literal|"dlclose(%p) finished\n"
argument_list|,
name|ut
operator|->
name|handle
argument_list|)
expr_stmt|;
break|break;
case|case
name|UTRACE_LOAD_OBJECT
case|:
name|printf
argument_list|(
literal|"RTLD: loaded   %p @ %p - %p (%s)\n"
argument_list|,
name|ut
operator|->
name|handle
argument_list|,
name|ut
operator|->
name|mapbase
argument_list|,
operator|(
name|char
operator|*
operator|)
name|ut
operator|->
name|mapbase
operator|+
name|ut
operator|->
name|mapsize
operator|-
literal|1
argument_list|,
name|ut
operator|->
name|name
argument_list|)
expr_stmt|;
break|break;
case|case
name|UTRACE_UNLOAD_OBJECT
case|:
name|printf
argument_list|(
literal|"RTLD: unloaded %p @ %p - %p (%s)\n"
argument_list|,
name|ut
operator|->
name|handle
argument_list|,
name|ut
operator|->
name|mapbase
argument_list|,
operator|(
name|char
operator|*
operator|)
name|ut
operator|->
name|mapbase
operator|+
name|ut
operator|->
name|mapsize
operator|-
literal|1
argument_list|,
name|ut
operator|->
name|name
argument_list|)
expr_stmt|;
break|break;
case|case
name|UTRACE_ADD_RUNDEP
case|:
name|parent
operator|=
name|ut
operator|->
name|mapbase
expr_stmt|;
name|printf
argument_list|(
literal|"RTLD: %p now depends on %p (%s, %d)\n"
argument_list|,
name|parent
argument_list|,
name|ut
operator|->
name|handle
argument_list|,
name|ut
operator|->
name|name
argument_list|,
name|ut
operator|->
name|refcnt
argument_list|)
expr_stmt|;
break|break;
case|case
name|UTRACE_PRELOAD_FINISHED
case|:
name|printf
argument_list|(
literal|"RTLD: LD_PRELOAD finished\n"
argument_list|)
expr_stmt|;
break|break;
case|case
name|UTRACE_INIT_CALL
case|:
name|printf
argument_list|(
literal|"RTLD: init %p for %p (%s)\n"
argument_list|,
name|ut
operator|->
name|mapbase
argument_list|,
name|ut
operator|->
name|handle
argument_list|,
name|ut
operator|->
name|name
argument_list|)
expr_stmt|;
break|break;
case|case
name|UTRACE_FINI_CALL
case|:
name|printf
argument_list|(
literal|"RTLD: fini %p for %p (%s)\n"
argument_list|,
name|ut
operator|->
name|mapbase
argument_list|,
name|ut
operator|->
name|handle
argument_list|,
name|ut
operator|->
name|name
argument_list|)
expr_stmt|;
break|break;
default|default:
name|p
operator|+=
literal|4
expr_stmt|;
name|len
operator|-=
literal|4
expr_stmt|;
name|printf
argument_list|(
literal|"RTLD: %d "
argument_list|,
name|len
argument_list|)
expr_stmt|;
while|while
condition|(
name|len
operator|--
condition|)
if|if
condition|(
name|decimal
condition|)
name|printf
argument_list|(
literal|" %d"
argument_list|,
operator|*
name|p
operator|++
argument_list|)
expr_stmt|;
else|else
name|printf
argument_list|(
literal|" %02x"
argument_list|,
operator|*
name|p
operator|++
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_struct
struct|struct
name|utrace_malloc
block|{
name|void
modifier|*
name|p
decl_stmt|;
name|size_t
name|s
decl_stmt|;
name|void
modifier|*
name|r
decl_stmt|;
block|}
struct|;
end_struct

begin_function
name|void
name|ktruser_malloc
parameter_list|(
name|int
name|len
parameter_list|,
name|unsigned
name|char
modifier|*
name|p
parameter_list|)
block|{
name|struct
name|utrace_malloc
modifier|*
name|ut
init|=
operator|(
expr|struct
name|utrace_malloc
operator|*
operator|)
name|p
decl_stmt|;
if|if
condition|(
name|ut
operator|->
name|p
operator|==
name|NULL
condition|)
block|{
if|if
condition|(
name|ut
operator|->
name|s
operator|==
literal|0
operator|&&
name|ut
operator|->
name|r
operator|==
name|NULL
condition|)
name|printf
argument_list|(
literal|"malloc_init()\n"
argument_list|)
expr_stmt|;
else|else
name|printf
argument_list|(
literal|"%p = malloc(%zu)\n"
argument_list|,
name|ut
operator|->
name|r
argument_list|,
name|ut
operator|->
name|s
argument_list|)
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|ut
operator|->
name|s
operator|==
literal|0
condition|)
name|printf
argument_list|(
literal|"free(%p)\n"
argument_list|,
name|ut
operator|->
name|p
argument_list|)
expr_stmt|;
else|else
name|printf
argument_list|(
literal|"%p = realloc(%p, %zu)\n"
argument_list|,
name|ut
operator|->
name|r
argument_list|,
name|ut
operator|->
name|p
argument_list|,
name|ut
operator|->
name|s
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
name|void
name|ktruser
parameter_list|(
name|int
name|len
parameter_list|,
name|unsigned
name|char
modifier|*
name|p
parameter_list|)
block|{
if|if
condition|(
name|len
operator|>=
literal|8
operator|&&
name|bcmp
argument_list|(
name|p
argument_list|,
literal|"RTLD"
argument_list|,
literal|4
argument_list|)
operator|==
literal|0
condition|)
block|{
name|ktruser_rtld
argument_list|(
name|len
argument_list|,
name|p
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|len
operator|==
sizeof|sizeof
argument_list|(
expr|struct
name|utrace_malloc
argument_list|)
condition|)
block|{
name|ktruser_malloc
argument_list|(
name|len
argument_list|,
name|p
argument_list|)
expr_stmt|;
return|return;
block|}
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"%d "
argument_list|,
name|len
argument_list|)
expr_stmt|;
while|while
condition|(
name|len
operator|--
condition|)
if|if
condition|(
name|decimal
condition|)
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|" %d"
argument_list|,
operator|*
name|p
operator|++
argument_list|)
expr_stmt|;
else|else
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|" %02x"
argument_list|,
operator|*
name|p
operator|++
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|usage
parameter_list|(
name|void
parameter_list|)
block|{
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"usage: kdump [-dEnlHRsT] [-f trfile] [-m maxdata] [-p pid] [-t [cnisuw]]\n"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
end_function

end_unit


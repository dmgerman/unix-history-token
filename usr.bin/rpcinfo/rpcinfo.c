begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*	$NetBSD: rpcinfo.c,v 1.15 2000/10/04 20:09:05 mjl Exp $	*/
end_comment

begin_comment
comment|/*	$FreeBSD$ */
end_comment

begin_comment
comment|/*  * Sun RPC is a product of Sun Microsystems, Inc. and is provided for  * unrestricted use provided that this legend is included on all tape  * media and as a part of the software program in whole or part.  Users  * may copy or modify Sun RPC without charge, but are not authorized  * to license or distribute it to anyone else except as part of a product or  * program developed by the user.  *  * SUN RPC IS PROVIDED AS IS WITH NO WARRANTIES OF ANY KIND INCLUDING THE  * WARRANTIES OF DESIGN, MERCHANTIBILITY AND FITNESS FOR A PARTICULAR  * PURPOSE, OR ARISING FROM A COURSE OF DEALING, USAGE OR TRADE PRACTICE.  *  * Sun RPC is provided with no support and without any obligation on the  * part of Sun Microsystems, Inc. to assist in its use, correction,  * modification or enhancement.  *  * SUN MICROSYSTEMS, INC. SHALL HAVE NO LIABILITY WITH RESPECT TO THE  * INFRINGEMENT OF COPYRIGHTS, TRADE SECRETS OR ANY PATENTS BY SUN RPC  * OR ANY PART THEREOF.  *  * In no event will Sun Microsystems, Inc. be liable for any lost revenue  * or profits or other special, indirect and consequential damages, even if  * Sun has been advised of the possibility of such damages.  *  * Sun Microsystems, Inc.  * 2550 Garcia Avenue  * Mountain View, California  94043  */
end_comment

begin_comment
comment|/*  * Copyright (c) 1986 - 1991 by Sun Microsystems, Inc.  */
end_comment

begin_comment
comment|/* #ident	"@(#)rpcinfo.c	1.18	93/07/05 SMI" */
end_comment

begin_if
if|#
directive|if
literal|0
end_if

begin_ifndef
ifndef|#
directive|ifndef
name|lint
end_ifndef

begin_endif
unit|static char sccsid[] = "@(#)rpcinfo.c 1.16 89/04/05 Copyr 1986 Sun Micro";
endif|#
directive|endif
end_endif

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/*  * rpcinfo: ping a particular rpc program  * 	or dump the the registered programs on the remote machine.  */
end_comment

begin_comment
comment|/*  * We are for now defining PORTMAP here.  It doesnt even compile  * unless it is defined.  */
end_comment

begin_ifndef
ifndef|#
directive|ifndef
name|PORTMAP
end_ifndef

begin_define
define|#
directive|define
name|PORTMAP
end_define

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/*  * If PORTMAP is defined, rpcinfo will talk to both portmapper and  * rpcbind programs; else it talks only to rpcbind. In the latter case  * all the portmapper specific options such as -u, -t, -p become void.  */
end_comment

begin_include
include|#
directive|include
file|<sys/types.h>
end_include

begin_include
include|#
directive|include
file|<sys/param.h>
end_include

begin_include
include|#
directive|include
file|<sys/socket.h>
end_include

begin_include
include|#
directive|include
file|<sys/un.h>
end_include

begin_include
include|#
directive|include
file|<rpc/rpc.h>
end_include

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_include
include|#
directive|include
file|<rpc/rpcb_prot.h>
end_include

begin_include
include|#
directive|include
file|<rpc/rpcent.h>
end_include

begin_include
include|#
directive|include
file|<rpc/nettype.h>
end_include

begin_include
include|#
directive|include
file|<rpc/rpc_com.h>
end_include

begin_include
include|#
directive|include
file|<stdlib.h>
end_include

begin_include
include|#
directive|include
file|<string.h>
end_include

begin_include
include|#
directive|include
file|<unistd.h>
end_include

begin_include
include|#
directive|include
file|<err.h>
end_include

begin_include
include|#
directive|include
file|<ctype.h>
end_include

begin_ifdef
ifdef|#
directive|ifdef
name|PORTMAP
end_ifdef

begin_comment
comment|/* Support for version 2 portmapper */
end_comment

begin_include
include|#
directive|include
file|<netinet/in.h>
end_include

begin_include
include|#
directive|include
file|<netdb.h>
end_include

begin_include
include|#
directive|include
file|<arpa/inet.h>
end_include

begin_include
include|#
directive|include
file|<rpc/pmap_prot.h>
end_include

begin_include
include|#
directive|include
file|<rpc/pmap_clnt.h>
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_define
define|#
directive|define
name|MAXHOSTLEN
value|256
end_define

begin_define
define|#
directive|define
name|MIN_VERS
value|((u_long) 0)
end_define

begin_define
define|#
directive|define
name|MAX_VERS
value|((u_long) 4294967295UL)
end_define

begin_define
define|#
directive|define
name|UNKNOWN
value|"unknown"
end_define

begin_comment
comment|/*  * Functions to be performed.  */
end_comment

begin_define
define|#
directive|define
name|NONE
value|0
end_define

begin_comment
comment|/* no function */
end_comment

begin_define
define|#
directive|define
name|PMAPDUMP
value|1
end_define

begin_comment
comment|/* dump portmapper registrations */
end_comment

begin_define
define|#
directive|define
name|TCPPING
value|2
end_define

begin_comment
comment|/* ping TCP service */
end_comment

begin_define
define|#
directive|define
name|UDPPING
value|3
end_define

begin_comment
comment|/* ping UDP service */
end_comment

begin_define
define|#
directive|define
name|BROADCAST
value|4
end_define

begin_comment
comment|/* ping broadcast service */
end_comment

begin_define
define|#
directive|define
name|DELETES
value|5
end_define

begin_comment
comment|/* delete registration for the service */
end_comment

begin_define
define|#
directive|define
name|ADDRPING
value|6
end_define

begin_comment
comment|/* pings at the given address */
end_comment

begin_define
define|#
directive|define
name|PROGPING
value|7
end_define

begin_comment
comment|/* pings a program on a given host */
end_comment

begin_define
define|#
directive|define
name|RPCBDUMP
value|8
end_define

begin_comment
comment|/* dump rpcbind registrations */
end_comment

begin_define
define|#
directive|define
name|RPCBDUMP_SHORT
value|9
end_define

begin_comment
comment|/* dump rpcbind registrations - short version */
end_comment

begin_define
define|#
directive|define
name|RPCBADDRLIST
value|10
end_define

begin_comment
comment|/* dump addr list about one prog */
end_comment

begin_define
define|#
directive|define
name|RPCBGETSTAT
value|11
end_define

begin_comment
comment|/* Get statistics */
end_comment

begin_struct
struct|struct
name|netidlist
block|{
name|char
modifier|*
name|netid
decl_stmt|;
name|struct
name|netidlist
modifier|*
name|next
decl_stmt|;
block|}
struct|;
end_struct

begin_struct
struct|struct
name|verslist
block|{
name|int
name|vers
decl_stmt|;
name|struct
name|verslist
modifier|*
name|next
decl_stmt|;
block|}
struct|;
end_struct

begin_struct
struct|struct
name|rpcbdump_short
block|{
name|u_long
name|prog
decl_stmt|;
name|struct
name|verslist
modifier|*
name|vlist
decl_stmt|;
name|struct
name|netidlist
modifier|*
name|nlist
decl_stmt|;
name|struct
name|rpcbdump_short
modifier|*
name|next
decl_stmt|;
name|char
modifier|*
name|owner
decl_stmt|;
block|}
struct|;
end_struct

begin_ifdef
ifdef|#
directive|ifdef
name|PORTMAP
end_ifdef

begin_function_decl
specifier|static
name|void
name|ip_ping
parameter_list|(
name|u_short
parameter_list|,
name|char
modifier|*
parameter_list|,
name|int
parameter_list|,
name|char
modifier|*
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|CLIENT
modifier|*
name|clnt_com_create
parameter_list|(
name|struct
name|sockaddr_in
modifier|*
parameter_list|,
name|u_long
parameter_list|,
name|u_long
parameter_list|,
name|int
modifier|*
parameter_list|,
name|char
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|pmapdump
parameter_list|(
name|int
parameter_list|,
name|char
modifier|*
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|get_inet_address
parameter_list|(
name|struct
name|sockaddr_in
modifier|*
parameter_list|,
name|char
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_endif
endif|#
directive|endif
end_endif

begin_function_decl
specifier|static
name|bool_t
name|reply_proc
parameter_list|(
name|void
modifier|*
parameter_list|,
name|struct
name|netbuf
modifier|*
parameter_list|,
name|struct
name|netconfig
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|brdcst
parameter_list|(
name|int
parameter_list|,
name|char
modifier|*
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|addrping
parameter_list|(
name|char
modifier|*
parameter_list|,
name|char
modifier|*
parameter_list|,
name|int
parameter_list|,
name|char
modifier|*
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|progping
parameter_list|(
name|char
modifier|*
parameter_list|,
name|int
parameter_list|,
name|char
modifier|*
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|CLIENT
modifier|*
name|clnt_addr_create
parameter_list|(
name|char
modifier|*
parameter_list|,
name|struct
name|netconfig
modifier|*
parameter_list|,
name|u_long
parameter_list|,
name|u_long
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|CLIENT
modifier|*
name|clnt_rpcbind_create
parameter_list|(
name|char
modifier|*
parameter_list|,
name|int
parameter_list|,
name|struct
name|netbuf
modifier|*
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|CLIENT
modifier|*
name|getclnthandle
parameter_list|(
name|char
modifier|*
parameter_list|,
name|struct
name|netconfig
modifier|*
parameter_list|,
name|u_long
parameter_list|,
name|struct
name|netbuf
modifier|*
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|CLIENT
modifier|*
name|local_rpcb
parameter_list|(
name|u_long
parameter_list|,
name|u_long
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|pstatus
parameter_list|(
name|CLIENT
modifier|*
parameter_list|,
name|u_long
parameter_list|,
name|u_long
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|rpcbdump
parameter_list|(
name|int
parameter_list|,
name|char
modifier|*
parameter_list|,
name|int
parameter_list|,
name|char
modifier|*
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|rpcbgetstat
parameter_list|(
name|int
parameter_list|,
name|char
modifier|*
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|rpcbaddrlist
parameter_list|(
name|char
modifier|*
parameter_list|,
name|int
parameter_list|,
name|char
modifier|*
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|deletereg
parameter_list|(
name|char
modifier|*
parameter_list|,
name|int
parameter_list|,
name|char
modifier|*
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|print_rmtcallstat
parameter_list|(
name|int
parameter_list|,
name|rpcb_stat
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|print_getaddrstat
parameter_list|(
name|int
parameter_list|,
name|rpcb_stat
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|usage
parameter_list|(
name|void
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|u_long
name|getprognum
parameter_list|(
name|char
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|u_long
name|getvers
parameter_list|(
name|char
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|char
modifier|*
name|spaces
parameter_list|(
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|bool_t
name|add_version
parameter_list|(
name|struct
name|rpcbdump_short
modifier|*
parameter_list|,
name|u_long
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|bool_t
name|add_netid
parameter_list|(
name|struct
name|rpcbdump_short
modifier|*
parameter_list|,
name|char
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|int
name|main
parameter_list|(
name|int
name|argc
parameter_list|,
name|char
modifier|*
modifier|*
name|argv
parameter_list|)
function_decl|;
end_function_decl

begin_function
name|int
name|main
parameter_list|(
name|int
name|argc
parameter_list|,
name|char
modifier|*
modifier|*
name|argv
parameter_list|)
block|{
specifier|register
name|int
name|c
decl_stmt|;
name|int
name|errflg
decl_stmt|;
name|int
name|function
decl_stmt|;
name|char
modifier|*
name|netid
init|=
name|NULL
decl_stmt|;
name|char
modifier|*
name|address
init|=
name|NULL
decl_stmt|;
ifdef|#
directive|ifdef
name|PORTMAP
name|char
modifier|*
name|strptr
decl_stmt|;
name|u_short
name|portnum
init|=
literal|0
decl_stmt|;
endif|#
directive|endif
name|function
operator|=
name|NONE
expr_stmt|;
name|errflg
operator|=
literal|0
expr_stmt|;
ifdef|#
directive|ifdef
name|PORTMAP
while|while
condition|(
operator|(
name|c
operator|=
name|getopt
argument_list|(
name|argc
argument_list|,
name|argv
argument_list|,
literal|"a:bdlmn:pstT:u"
argument_list|)
operator|)
operator|!=
operator|-
literal|1
condition|)
block|{
else|#
directive|else
while|while
condition|(
operator|(
name|c
operator|=
name|getopt
argument_list|(
name|argc
argument_list|,
name|argv
argument_list|,
literal|"a:bdlmn:sT:"
argument_list|)
operator|)
operator|!=
operator|-
literal|1
condition|)
block|{
endif|#
directive|endif
switch|switch
condition|(
name|c
condition|)
block|{
ifdef|#
directive|ifdef
name|PORTMAP
case|case
literal|'p'
case|:
if|if
condition|(
name|function
operator|!=
name|NONE
condition|)
name|errflg
operator|=
literal|1
expr_stmt|;
else|else
name|function
operator|=
name|PMAPDUMP
expr_stmt|;
break|break;
case|case
literal|'t'
case|:
if|if
condition|(
name|function
operator|!=
name|NONE
condition|)
name|errflg
operator|=
literal|1
expr_stmt|;
else|else
name|function
operator|=
name|TCPPING
expr_stmt|;
break|break;
case|case
literal|'u'
case|:
if|if
condition|(
name|function
operator|!=
name|NONE
condition|)
name|errflg
operator|=
literal|1
expr_stmt|;
else|else
name|function
operator|=
name|UDPPING
expr_stmt|;
break|break;
case|case
literal|'n'
case|:
name|portnum
operator|=
operator|(
name|u_short
operator|)
name|strtol
argument_list|(
name|optarg
argument_list|,
operator|&
name|strptr
argument_list|,
literal|10
argument_list|)
expr_stmt|;
if|if
condition|(
name|strptr
operator|==
name|optarg
operator|||
operator|*
name|strptr
operator|!=
literal|'\0'
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"rpcinfo: %s is illegal port number\n"
argument_list|,
name|optarg
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
break|break;
endif|#
directive|endif
case|case
literal|'a'
case|:
name|address
operator|=
name|optarg
expr_stmt|;
if|if
condition|(
name|function
operator|!=
name|NONE
condition|)
name|errflg
operator|=
literal|1
expr_stmt|;
else|else
name|function
operator|=
name|ADDRPING
expr_stmt|;
break|break;
case|case
literal|'b'
case|:
if|if
condition|(
name|function
operator|!=
name|NONE
condition|)
name|errflg
operator|=
literal|1
expr_stmt|;
else|else
name|function
operator|=
name|BROADCAST
expr_stmt|;
break|break;
case|case
literal|'d'
case|:
if|if
condition|(
name|function
operator|!=
name|NONE
condition|)
name|errflg
operator|=
literal|1
expr_stmt|;
else|else
name|function
operator|=
name|DELETES
expr_stmt|;
break|break;
case|case
literal|'l'
case|:
if|if
condition|(
name|function
operator|!=
name|NONE
condition|)
name|errflg
operator|=
literal|1
expr_stmt|;
else|else
name|function
operator|=
name|RPCBADDRLIST
expr_stmt|;
break|break;
case|case
literal|'m'
case|:
if|if
condition|(
name|function
operator|!=
name|NONE
condition|)
name|errflg
operator|=
literal|1
expr_stmt|;
else|else
name|function
operator|=
name|RPCBGETSTAT
expr_stmt|;
break|break;
case|case
literal|'s'
case|:
if|if
condition|(
name|function
operator|!=
name|NONE
condition|)
name|errflg
operator|=
literal|1
expr_stmt|;
else|else
name|function
operator|=
name|RPCBDUMP_SHORT
expr_stmt|;
break|break;
case|case
literal|'T'
case|:
name|netid
operator|=
name|optarg
expr_stmt|;
break|break;
case|case
literal|'?'
case|:
name|errflg
operator|=
literal|1
expr_stmt|;
break|break;
block|}
block|}
if|if
condition|(
name|errflg
operator|||
operator|(
operator|(
name|function
operator|==
name|ADDRPING
operator|)
operator|&&
operator|!
name|netid
operator|)
condition|)
block|{
name|usage
argument_list|()
expr_stmt|;
return|return
operator|(
literal|1
operator|)
return|;
block|}
if|if
condition|(
name|function
operator|==
name|NONE
condition|)
block|{
if|if
condition|(
name|argc
operator|-
name|optind
operator|>
literal|1
condition|)
name|function
operator|=
name|PROGPING
expr_stmt|;
else|else
name|function
operator|=
name|RPCBDUMP
expr_stmt|;
block|}
switch|switch
condition|(
name|function
condition|)
block|{
ifdef|#
directive|ifdef
name|PORTMAP
case|case
name|PMAPDUMP
case|:
if|if
condition|(
name|portnum
operator|!=
literal|0
condition|)
block|{
name|usage
argument_list|()
expr_stmt|;
return|return
operator|(
literal|1
operator|)
return|;
block|}
name|pmapdump
argument_list|(
name|argc
operator|-
name|optind
argument_list|,
name|argv
operator|+
name|optind
argument_list|)
expr_stmt|;
break|break;
case|case
name|UDPPING
case|:
name|ip_ping
argument_list|(
name|portnum
argument_list|,
literal|"udp"
argument_list|,
name|argc
operator|-
name|optind
argument_list|,
name|argv
operator|+
name|optind
argument_list|)
expr_stmt|;
break|break;
case|case
name|TCPPING
case|:
name|ip_ping
argument_list|(
name|portnum
argument_list|,
literal|"tcp"
argument_list|,
name|argc
operator|-
name|optind
argument_list|,
name|argv
operator|+
name|optind
argument_list|)
expr_stmt|;
break|break;
endif|#
directive|endif
case|case
name|BROADCAST
case|:
name|brdcst
argument_list|(
name|argc
operator|-
name|optind
argument_list|,
name|argv
operator|+
name|optind
argument_list|)
expr_stmt|;
break|break;
case|case
name|DELETES
case|:
name|deletereg
argument_list|(
name|netid
argument_list|,
name|argc
operator|-
name|optind
argument_list|,
name|argv
operator|+
name|optind
argument_list|)
expr_stmt|;
break|break;
case|case
name|ADDRPING
case|:
name|addrping
argument_list|(
name|address
argument_list|,
name|netid
argument_list|,
name|argc
operator|-
name|optind
argument_list|,
name|argv
operator|+
name|optind
argument_list|)
expr_stmt|;
break|break;
case|case
name|PROGPING
case|:
name|progping
argument_list|(
name|netid
argument_list|,
name|argc
operator|-
name|optind
argument_list|,
name|argv
operator|+
name|optind
argument_list|)
expr_stmt|;
break|break;
case|case
name|RPCBDUMP
case|:
case|case
name|RPCBDUMP_SHORT
case|:
name|rpcbdump
argument_list|(
name|function
argument_list|,
name|netid
argument_list|,
name|argc
operator|-
name|optind
argument_list|,
name|argv
operator|+
name|optind
argument_list|)
expr_stmt|;
break|break;
case|case
name|RPCBGETSTAT
case|:
name|rpcbgetstat
argument_list|(
name|argc
operator|-
name|optind
argument_list|,
name|argv
operator|+
name|optind
argument_list|)
expr_stmt|;
break|break;
case|case
name|RPCBADDRLIST
case|:
name|rpcbaddrlist
argument_list|(
name|netid
argument_list|,
name|argc
operator|-
name|optind
argument_list|,
name|argv
operator|+
name|optind
argument_list|)
expr_stmt|;
break|break;
block|}
return|return
operator|(
literal|0
operator|)
return|;
block|}
specifier|static
name|CLIENT
modifier|*
name|local_rpcb
parameter_list|(
name|u_long
name|prog
parameter_list|,
name|u_long
name|vers
parameter_list|)
block|{
name|void
modifier|*
name|localhandle
decl_stmt|;
name|struct
name|netconfig
modifier|*
name|nconf
decl_stmt|;
name|CLIENT
modifier|*
name|clnt
decl_stmt|;
name|localhandle
operator|=
name|setnetconfig
argument_list|()
expr_stmt|;
while|while
condition|(
operator|(
name|nconf
operator|=
name|getnetconfig
argument_list|(
name|localhandle
argument_list|)
operator|)
operator|!=
name|NULL
condition|)
block|{
if|if
condition|(
name|nconf
operator|->
name|nc_protofmly
operator|!=
name|NULL
operator|&&
name|strcmp
argument_list|(
name|nconf
operator|->
name|nc_protofmly
argument_list|,
name|NC_LOOPBACK
argument_list|)
operator|==
literal|0
condition|)
break|break;
block|}
if|if
condition|(
name|nconf
operator|==
name|NULL
condition|)
block|{
name|warnx
argument_list|(
literal|"getnetconfig: %s"
argument_list|,
name|nc_sperror
argument_list|()
argument_list|)
expr_stmt|;
return|return
operator|(
name|NULL
operator|)
return|;
block|}
name|clnt
operator|=
name|clnt_tp_create
argument_list|(
name|NULL
argument_list|,
name|prog
argument_list|,
name|vers
argument_list|,
name|nconf
argument_list|)
expr_stmt|;
name|endnetconfig
argument_list|(
name|localhandle
argument_list|)
expr_stmt|;
return|return
name|clnt
return|;
block|}
ifdef|#
directive|ifdef
name|PORTMAP
specifier|static
name|CLIENT
modifier|*
name|clnt_com_create
parameter_list|(
name|struct
name|sockaddr_in
modifier|*
name|addr
parameter_list|,
name|u_long
name|prog
parameter_list|,
name|u_long
name|vers
parameter_list|,
name|int
modifier|*
name|fdp
parameter_list|,
name|char
modifier|*
name|trans
parameter_list|)
block|{
name|CLIENT
modifier|*
name|clnt
decl_stmt|;
if|if
condition|(
name|strcmp
argument_list|(
name|trans
argument_list|,
literal|"tcp"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|clnt
operator|=
name|clnttcp_create
argument_list|(
name|addr
argument_list|,
name|prog
argument_list|,
name|vers
argument_list|,
name|fdp
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|struct
name|timeval
name|to
decl_stmt|;
name|to
operator|.
name|tv_sec
operator|=
literal|5
expr_stmt|;
name|to
operator|.
name|tv_usec
operator|=
literal|0
expr_stmt|;
name|clnt
operator|=
name|clntudp_create
argument_list|(
name|addr
argument_list|,
name|prog
argument_list|,
name|vers
argument_list|,
name|to
argument_list|,
name|fdp
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|clnt
operator|==
operator|(
name|CLIENT
operator|*
operator|)
name|NULL
condition|)
block|{
name|clnt_pcreateerror
argument_list|(
literal|"rpcinfo"
argument_list|)
expr_stmt|;
if|if
condition|(
name|vers
operator|==
name|MIN_VERS
condition|)
name|printf
argument_list|(
literal|"program %lu is not available\n"
argument_list|,
name|prog
argument_list|)
expr_stmt|;
else|else
name|printf
argument_list|(
literal|"program %lu version %lu is not available\n"
argument_list|,
name|prog
argument_list|,
name|vers
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
return|return
operator|(
name|clnt
operator|)
return|;
block|}
comment|/*  * If portnum is 0, then go and get the address from portmapper, which happens  * transparently through clnt*_create(); If version number is not given, it  * tries to find out the version number by making a call to version 0 and if  * that fails, it obtains the high order and the low order version number. If  * version 0 calls succeeds, it tries for MAXVERS call and repeats the same.  */
specifier|static
name|void
name|ip_ping
parameter_list|(
name|u_short
name|portnum
parameter_list|,
name|char
modifier|*
name|trans
parameter_list|,
name|int
name|argc
parameter_list|,
name|char
modifier|*
modifier|*
name|argv
parameter_list|)
block|{
name|CLIENT
modifier|*
name|client
decl_stmt|;
name|int
name|fd
init|=
name|RPC_ANYFD
decl_stmt|;
name|struct
name|timeval
name|to
decl_stmt|;
name|struct
name|sockaddr_in
name|addr
decl_stmt|;
name|enum
name|clnt_stat
name|rpc_stat
decl_stmt|;
name|u_long
name|prognum
decl_stmt|,
name|vers
decl_stmt|,
name|minvers
decl_stmt|,
name|maxvers
decl_stmt|;
name|struct
name|rpc_err
name|rpcerr
decl_stmt|;
name|int
name|failure
init|=
literal|0
decl_stmt|;
if|if
condition|(
name|argc
operator|<
literal|2
operator|||
name|argc
operator|>
literal|3
condition|)
block|{
name|usage
argument_list|()
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
name|to
operator|.
name|tv_sec
operator|=
literal|10
expr_stmt|;
name|to
operator|.
name|tv_usec
operator|=
literal|0
expr_stmt|;
name|prognum
operator|=
name|getprognum
argument_list|(
name|argv
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
name|get_inet_address
argument_list|(
operator|&
name|addr
argument_list|,
name|argv
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|argc
operator|==
literal|2
condition|)
block|{
comment|/* Version number not known */
comment|/* 		 * A call to version 0 should fail with a program/version 		 * mismatch, and give us the range of versions supported. 		 */
name|vers
operator|=
name|MIN_VERS
expr_stmt|;
block|}
else|else
block|{
name|vers
operator|=
name|getvers
argument_list|(
name|argv
index|[
literal|2
index|]
argument_list|)
expr_stmt|;
block|}
name|addr
operator|.
name|sin_port
operator|=
name|htons
argument_list|(
name|portnum
argument_list|)
expr_stmt|;
name|client
operator|=
name|clnt_com_create
argument_list|(
operator|&
name|addr
argument_list|,
name|prognum
argument_list|,
name|vers
argument_list|,
operator|&
name|fd
argument_list|,
name|trans
argument_list|)
expr_stmt|;
name|rpc_stat
operator|=
name|CLNT_CALL
argument_list|(
name|client
argument_list|,
name|NULLPROC
argument_list|,
operator|(
name|xdrproc_t
operator|)
name|xdr_void
argument_list|,
operator|(
name|char
operator|*
operator|)
name|NULL
argument_list|,
operator|(
name|xdrproc_t
operator|)
name|xdr_void
argument_list|,
operator|(
name|char
operator|*
operator|)
name|NULL
argument_list|,
name|to
argument_list|)
expr_stmt|;
if|if
condition|(
name|argc
operator|!=
literal|2
condition|)
block|{
comment|/* Version number was known */
if|if
condition|(
name|pstatus
argument_list|(
name|client
argument_list|,
name|prognum
argument_list|,
name|vers
argument_list|)
operator|<
literal|0
condition|)
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|CLNT_DESTROY
argument_list|(
name|client
argument_list|)
expr_stmt|;
return|return;
block|}
comment|/* Version number not known */
operator|(
name|void
operator|)
name|CLNT_CONTROL
argument_list|(
name|client
argument_list|,
name|CLSET_FD_NCLOSE
argument_list|,
operator|(
name|char
operator|*
operator|)
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|rpc_stat
operator|==
name|RPC_PROGVERSMISMATCH
condition|)
block|{
name|clnt_geterr
argument_list|(
name|client
argument_list|,
operator|&
name|rpcerr
argument_list|)
expr_stmt|;
name|minvers
operator|=
name|rpcerr
operator|.
name|re_vers
operator|.
name|low
expr_stmt|;
name|maxvers
operator|=
name|rpcerr
operator|.
name|re_vers
operator|.
name|high
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|rpc_stat
operator|==
name|RPC_SUCCESS
condition|)
block|{
comment|/* 		 * Oh dear, it DOES support version 0. 		 * Let's try version MAX_VERS. 		 */
operator|(
name|void
operator|)
name|CLNT_DESTROY
argument_list|(
name|client
argument_list|)
expr_stmt|;
name|addr
operator|.
name|sin_port
operator|=
name|htons
argument_list|(
name|portnum
argument_list|)
expr_stmt|;
name|client
operator|=
name|clnt_com_create
argument_list|(
operator|&
name|addr
argument_list|,
name|prognum
argument_list|,
name|MAX_VERS
argument_list|,
operator|&
name|fd
argument_list|,
name|trans
argument_list|)
expr_stmt|;
name|rpc_stat
operator|=
name|CLNT_CALL
argument_list|(
name|client
argument_list|,
name|NULLPROC
argument_list|,
operator|(
name|xdrproc_t
operator|)
name|xdr_void
argument_list|,
operator|(
name|char
operator|*
operator|)
name|NULL
argument_list|,
operator|(
name|xdrproc_t
operator|)
name|xdr_void
argument_list|,
operator|(
name|char
operator|*
operator|)
name|NULL
argument_list|,
name|to
argument_list|)
expr_stmt|;
if|if
condition|(
name|rpc_stat
operator|==
name|RPC_PROGVERSMISMATCH
condition|)
block|{
name|clnt_geterr
argument_list|(
name|client
argument_list|,
operator|&
name|rpcerr
argument_list|)
expr_stmt|;
name|minvers
operator|=
name|rpcerr
operator|.
name|re_vers
operator|.
name|low
expr_stmt|;
name|maxvers
operator|=
name|rpcerr
operator|.
name|re_vers
operator|.
name|high
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|rpc_stat
operator|==
name|RPC_SUCCESS
condition|)
block|{
comment|/* 			 * It also supports version MAX_VERS. 			 * Looks like we have a wise guy. 			 * OK, we give them information on all 			 * 4 billion versions they support... 			 */
name|minvers
operator|=
literal|0
expr_stmt|;
name|maxvers
operator|=
name|MAX_VERS
expr_stmt|;
block|}
else|else
block|{
operator|(
name|void
operator|)
name|pstatus
argument_list|(
name|client
argument_list|,
name|prognum
argument_list|,
name|MAX_VERS
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
operator|(
name|void
operator|)
name|pstatus
argument_list|(
name|client
argument_list|,
name|prognum
argument_list|,
operator|(
name|u_long
operator|)
literal|0
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
operator|(
name|void
operator|)
name|CLNT_DESTROY
argument_list|(
name|client
argument_list|)
expr_stmt|;
for|for
control|(
name|vers
operator|=
name|minvers
init|;
name|vers
operator|<=
name|maxvers
condition|;
name|vers
operator|++
control|)
block|{
name|addr
operator|.
name|sin_port
operator|=
name|htons
argument_list|(
name|portnum
argument_list|)
expr_stmt|;
name|client
operator|=
name|clnt_com_create
argument_list|(
operator|&
name|addr
argument_list|,
name|prognum
argument_list|,
name|vers
argument_list|,
operator|&
name|fd
argument_list|,
name|trans
argument_list|)
expr_stmt|;
name|rpc_stat
operator|=
name|CLNT_CALL
argument_list|(
name|client
argument_list|,
name|NULLPROC
argument_list|,
operator|(
name|xdrproc_t
operator|)
name|xdr_void
argument_list|,
operator|(
name|char
operator|*
operator|)
name|NULL
argument_list|,
operator|(
name|xdrproc_t
operator|)
name|xdr_void
argument_list|,
operator|(
name|char
operator|*
operator|)
name|NULL
argument_list|,
name|to
argument_list|)
expr_stmt|;
if|if
condition|(
name|pstatus
argument_list|(
name|client
argument_list|,
name|prognum
argument_list|,
name|vers
argument_list|)
operator|<
literal|0
condition|)
name|failure
operator|=
literal|1
expr_stmt|;
operator|(
name|void
operator|)
name|CLNT_DESTROY
argument_list|(
name|client
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|failure
condition|)
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|close
argument_list|(
name|fd
argument_list|)
expr_stmt|;
return|return;
block|}
comment|/*  * Dump all the portmapper registerations  */
specifier|static
name|void
name|pmapdump
parameter_list|(
name|int
name|argc
parameter_list|,
name|char
modifier|*
modifier|*
name|argv
parameter_list|)
block|{
name|struct
name|sockaddr_in
name|server_addr
decl_stmt|;
name|struct
name|pmaplist
modifier|*
name|head
init|=
name|NULL
decl_stmt|;
name|int
name|socket
init|=
name|RPC_ANYSOCK
decl_stmt|;
name|struct
name|timeval
name|minutetimeout
decl_stmt|;
specifier|register
name|CLIENT
modifier|*
name|client
decl_stmt|;
name|struct
name|rpcent
modifier|*
name|rpc
decl_stmt|;
name|enum
name|clnt_stat
name|clnt_st
decl_stmt|;
name|struct
name|rpc_err
name|err
decl_stmt|;
name|char
modifier|*
name|host
decl_stmt|;
if|if
condition|(
name|argc
operator|>
literal|1
condition|)
block|{
name|usage
argument_list|()
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|argc
operator|==
literal|1
condition|)
block|{
name|host
operator|=
name|argv
index|[
literal|0
index|]
expr_stmt|;
name|get_inet_address
argument_list|(
operator|&
name|server_addr
argument_list|,
name|host
argument_list|)
expr_stmt|;
name|server_addr
operator|.
name|sin_port
operator|=
name|htons
argument_list|(
name|PMAPPORT
argument_list|)
expr_stmt|;
name|client
operator|=
name|clnttcp_create
argument_list|(
operator|&
name|server_addr
argument_list|,
name|PMAPPROG
argument_list|,
name|PMAPVERS
argument_list|,
operator|&
name|socket
argument_list|,
literal|50
argument_list|,
literal|500
argument_list|)
expr_stmt|;
block|}
else|else
name|client
operator|=
name|local_rpcb
argument_list|(
name|PMAPPROG
argument_list|,
name|PMAPVERS
argument_list|)
expr_stmt|;
if|if
condition|(
name|client
operator|==
name|NULL
condition|)
block|{
if|if
condition|(
name|rpc_createerr
operator|.
name|cf_stat
operator|==
name|RPC_TLIERROR
condition|)
block|{
comment|/* 			 * "Misc. TLI error" is not too helpful. Most likely 			 * the connection to the remote server timed out, so 			 * this error is at least less perplexing. 			 */
name|rpc_createerr
operator|.
name|cf_stat
operator|=
name|RPC_PMAPFAILURE
expr_stmt|;
name|rpc_createerr
operator|.
name|cf_error
operator|.
name|re_status
operator|=
name|RPC_FAILED
expr_stmt|;
block|}
name|clnt_pcreateerror
argument_list|(
literal|"rpcinfo: can't contact portmapper"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
name|minutetimeout
operator|.
name|tv_sec
operator|=
literal|60
expr_stmt|;
name|minutetimeout
operator|.
name|tv_usec
operator|=
literal|0
expr_stmt|;
name|clnt_st
operator|=
name|CLNT_CALL
argument_list|(
name|client
argument_list|,
name|PMAPPROC_DUMP
argument_list|,
operator|(
name|xdrproc_t
operator|)
name|xdr_void
argument_list|,
name|NULL
argument_list|,
operator|(
name|xdrproc_t
operator|)
name|xdr_pmaplist_ptr
argument_list|,
operator|(
name|char
operator|*
operator|)
operator|&
name|head
argument_list|,
name|minutetimeout
argument_list|)
expr_stmt|;
if|if
condition|(
name|clnt_st
operator|!=
name|RPC_SUCCESS
condition|)
block|{
if|if
condition|(
operator|(
name|clnt_st
operator|==
name|RPC_PROGVERSMISMATCH
operator|)
operator|||
operator|(
name|clnt_st
operator|==
name|RPC_PROGUNAVAIL
operator|)
condition|)
block|{
name|CLNT_GETERR
argument_list|(
name|client
argument_list|,
operator|&
name|err
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
operator|.
name|re_vers
operator|.
name|low
operator|>
name|PMAPVERS
condition|)
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"%s does not support portmapper.  Try rpcinfo %s instead\n"
argument_list|,
name|host
argument_list|,
name|host
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
name|clnt_perror
argument_list|(
name|client
argument_list|,
literal|"rpcinfo: can't contact portmapper"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|head
operator|==
name|NULL
condition|)
block|{
name|printf
argument_list|(
literal|"No remote programs registered.\n"
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|printf
argument_list|(
literal|"   program vers proto   port  service\n"
argument_list|)
expr_stmt|;
for|for
control|(
init|;
name|head
operator|!=
name|NULL
condition|;
name|head
operator|=
name|head
operator|->
name|pml_next
control|)
block|{
name|printf
argument_list|(
literal|"%10ld%5ld"
argument_list|,
name|head
operator|->
name|pml_map
operator|.
name|pm_prog
argument_list|,
name|head
operator|->
name|pml_map
operator|.
name|pm_vers
argument_list|)
expr_stmt|;
if|if
condition|(
name|head
operator|->
name|pml_map
operator|.
name|pm_prot
operator|==
name|IPPROTO_UDP
condition|)
name|printf
argument_list|(
literal|"%6s"
argument_list|,
literal|"udp"
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|head
operator|->
name|pml_map
operator|.
name|pm_prot
operator|==
name|IPPROTO_TCP
condition|)
name|printf
argument_list|(
literal|"%6s"
argument_list|,
literal|"tcp"
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|head
operator|->
name|pml_map
operator|.
name|pm_prot
operator|==
name|IPPROTO_ST
condition|)
name|printf
argument_list|(
literal|"%6s"
argument_list|,
literal|"unix"
argument_list|)
expr_stmt|;
else|else
name|printf
argument_list|(
literal|"%6ld"
argument_list|,
name|head
operator|->
name|pml_map
operator|.
name|pm_prot
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"%7ld"
argument_list|,
name|head
operator|->
name|pml_map
operator|.
name|pm_port
argument_list|)
expr_stmt|;
name|rpc
operator|=
name|getrpcbynumber
argument_list|(
name|head
operator|->
name|pml_map
operator|.
name|pm_prog
argument_list|)
expr_stmt|;
if|if
condition|(
name|rpc
condition|)
name|printf
argument_list|(
literal|"  %s\n"
argument_list|,
name|rpc
operator|->
name|r_name
argument_list|)
expr_stmt|;
else|else
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
block|}
block|}
block|}
specifier|static
name|void
name|get_inet_address
parameter_list|(
name|struct
name|sockaddr_in
modifier|*
name|addr
parameter_list|,
name|char
modifier|*
name|host
parameter_list|)
block|{
name|struct
name|netconfig
modifier|*
name|nconf
decl_stmt|;
name|struct
name|addrinfo
name|hints
decl_stmt|,
modifier|*
name|res
decl_stmt|;
name|int
name|error
decl_stmt|;
operator|(
name|void
operator|)
name|memset
argument_list|(
operator|(
name|char
operator|*
operator|)
name|addr
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|addr
argument_list|)
argument_list|)
expr_stmt|;
name|addr
operator|->
name|sin_addr
operator|.
name|s_addr
operator|=
name|inet_addr
argument_list|(
name|host
argument_list|)
expr_stmt|;
if|if
condition|(
name|addr
operator|->
name|sin_addr
operator|.
name|s_addr
operator|==
operator|-
literal|1
operator|||
name|addr
operator|->
name|sin_addr
operator|.
name|s_addr
operator|==
literal|0
condition|)
block|{
if|if
condition|(
operator|(
name|nconf
operator|=
name|__rpc_getconfip
argument_list|(
literal|"udp"
argument_list|)
operator|)
operator|==
name|NULL
operator|&&
operator|(
name|nconf
operator|=
name|__rpc_getconfip
argument_list|(
literal|"tcp"
argument_list|)
operator|)
operator|==
name|NULL
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"rpcinfo: couldn't find a suitable transport\n"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|memset
argument_list|(
operator|&
name|hints
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
name|hints
argument_list|)
expr_stmt|;
name|hints
operator|.
name|ai_family
operator|=
name|AF_INET
expr_stmt|;
if|if
condition|(
operator|(
name|error
operator|=
name|getaddrinfo
argument_list|(
name|host
argument_list|,
literal|"rpcbind"
argument_list|,
operator|&
name|hints
argument_list|,
operator|&
name|res
argument_list|)
operator|)
operator|!=
literal|0
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"rpcinfo: %s: %s\n"
argument_list|,
name|host
argument_list|,
name|gai_strerror
argument_list|(
name|error
argument_list|)
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|memcpy
argument_list|(
name|addr
argument_list|,
name|res
operator|->
name|ai_addr
argument_list|,
name|res
operator|->
name|ai_addrlen
argument_list|)
expr_stmt|;
name|freeaddrinfo
argument_list|(
name|res
argument_list|)
expr_stmt|;
block|}
operator|(
name|void
operator|)
name|freenetconfigent
argument_list|(
name|nconf
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
name|addr
operator|->
name|sin_family
operator|=
name|AF_INET
expr_stmt|;
block|}
block|}
endif|#
directive|endif
comment|/* PORTMAP */
comment|/*  * reply_proc collects replies from the broadcast.  * to get a unique list of responses the output of rpcinfo should  * be piped through sort(1) and then uniq(1).  */
comment|/*ARGSUSED*/
specifier|static
name|bool_t
name|reply_proc
parameter_list|(
name|void
modifier|*
name|res
parameter_list|,
name|struct
name|netbuf
modifier|*
name|who
parameter_list|,
name|struct
name|netconfig
modifier|*
name|nconf
parameter_list|)
comment|/* void *res;			Nothing comes back */
comment|/* struct netbuf *who;		Who sent us the reply */
comment|/* struct netconfig *nconf; 	On which transport the reply came */
block|{
name|char
modifier|*
name|uaddr
decl_stmt|;
name|char
name|hostbuf
index|[
name|NI_MAXHOST
index|]
decl_stmt|;
name|char
modifier|*
name|hostname
decl_stmt|;
name|struct
name|sockaddr
modifier|*
name|sa
init|=
operator|(
expr|struct
name|sockaddr
operator|*
operator|)
name|who
operator|->
name|buf
decl_stmt|;
if|if
condition|(
name|getnameinfo
argument_list|(
name|sa
argument_list|,
name|sa
operator|->
name|sa_len
argument_list|,
name|hostbuf
argument_list|,
name|NI_MAXHOST
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
condition|)
block|{
name|hostname
operator|=
name|UNKNOWN
expr_stmt|;
block|}
else|else
block|{
name|hostname
operator|=
name|hostbuf
expr_stmt|;
block|}
if|if
condition|(
operator|!
operator|(
name|uaddr
operator|=
name|taddr2uaddr
argument_list|(
name|nconf
argument_list|,
name|who
argument_list|)
operator|)
condition|)
block|{
name|uaddr
operator|=
name|UNKNOWN
expr_stmt|;
block|}
name|printf
argument_list|(
literal|"%s\t%s\n"
argument_list|,
name|uaddr
argument_list|,
name|hostname
argument_list|)
expr_stmt|;
if|if
condition|(
name|strcmp
argument_list|(
name|uaddr
argument_list|,
name|UNKNOWN
argument_list|)
condition|)
name|free
argument_list|(
operator|(
name|char
operator|*
operator|)
name|uaddr
argument_list|)
expr_stmt|;
return|return
operator|(
name|FALSE
operator|)
return|;
block|}
specifier|static
name|void
name|brdcst
parameter_list|(
name|int
name|argc
parameter_list|,
name|char
modifier|*
modifier|*
name|argv
parameter_list|)
block|{
name|enum
name|clnt_stat
name|rpc_stat
decl_stmt|;
name|u_long
name|prognum
decl_stmt|,
name|vers
decl_stmt|;
if|if
condition|(
name|argc
operator|!=
literal|2
condition|)
block|{
name|usage
argument_list|()
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
name|prognum
operator|=
name|getprognum
argument_list|(
name|argv
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
name|vers
operator|=
name|getvers
argument_list|(
name|argv
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
name|rpc_stat
operator|=
name|rpc_broadcast
argument_list|(
name|prognum
argument_list|,
name|vers
argument_list|,
name|NULLPROC
argument_list|,
operator|(
name|xdrproc_t
operator|)
name|xdr_void
argument_list|,
operator|(
name|char
operator|*
operator|)
name|NULL
argument_list|,
operator|(
name|xdrproc_t
operator|)
name|xdr_void
argument_list|,
operator|(
name|char
operator|*
operator|)
name|NULL
argument_list|,
operator|(
name|resultproc_t
operator|)
name|reply_proc
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|rpc_stat
operator|!=
name|RPC_SUCCESS
operator|)
operator|&&
operator|(
name|rpc_stat
operator|!=
name|RPC_TIMEDOUT
operator|)
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"rpcinfo: broadcast failed: %s\n"
argument_list|,
name|clnt_sperrno
argument_list|(
name|rpc_stat
argument_list|)
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
name|exit
argument_list|(
literal|0
argument_list|)
expr_stmt|;
block|}
specifier|static
name|bool_t
name|add_version
parameter_list|(
name|struct
name|rpcbdump_short
modifier|*
name|rs
parameter_list|,
name|u_long
name|vers
parameter_list|)
block|{
name|struct
name|verslist
modifier|*
name|vl
decl_stmt|;
for|for
control|(
name|vl
operator|=
name|rs
operator|->
name|vlist
init|;
name|vl
condition|;
name|vl
operator|=
name|vl
operator|->
name|next
control|)
if|if
condition|(
name|vl
operator|->
name|vers
operator|==
name|vers
condition|)
break|break;
if|if
condition|(
name|vl
condition|)
return|return
operator|(
name|TRUE
operator|)
return|;
name|vl
operator|=
operator|(
expr|struct
name|verslist
operator|*
operator|)
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
expr|struct
name|verslist
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|vl
operator|==
name|NULL
condition|)
return|return
operator|(
name|FALSE
operator|)
return|;
name|vl
operator|->
name|vers
operator|=
name|vers
expr_stmt|;
name|vl
operator|->
name|next
operator|=
name|rs
operator|->
name|vlist
expr_stmt|;
name|rs
operator|->
name|vlist
operator|=
name|vl
expr_stmt|;
return|return
operator|(
name|TRUE
operator|)
return|;
block|}
specifier|static
name|bool_t
name|add_netid
parameter_list|(
name|struct
name|rpcbdump_short
modifier|*
name|rs
parameter_list|,
name|char
modifier|*
name|netid
parameter_list|)
block|{
name|struct
name|netidlist
modifier|*
name|nl
decl_stmt|;
for|for
control|(
name|nl
operator|=
name|rs
operator|->
name|nlist
init|;
name|nl
condition|;
name|nl
operator|=
name|nl
operator|->
name|next
control|)
if|if
condition|(
name|strcmp
argument_list|(
name|nl
operator|->
name|netid
argument_list|,
name|netid
argument_list|)
operator|==
literal|0
condition|)
break|break;
if|if
condition|(
name|nl
condition|)
return|return
operator|(
name|TRUE
operator|)
return|;
name|nl
operator|=
operator|(
expr|struct
name|netidlist
operator|*
operator|)
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
expr|struct
name|netidlist
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|nl
operator|==
name|NULL
condition|)
return|return
operator|(
name|FALSE
operator|)
return|;
name|nl
operator|->
name|netid
operator|=
name|netid
expr_stmt|;
name|nl
operator|->
name|next
operator|=
name|rs
operator|->
name|nlist
expr_stmt|;
name|rs
operator|->
name|nlist
operator|=
name|nl
expr_stmt|;
return|return
operator|(
name|TRUE
operator|)
return|;
block|}
specifier|static
name|void
name|rpcbdump
parameter_list|(
name|int
name|dumptype
parameter_list|,
name|char
modifier|*
name|netid
parameter_list|,
name|int
name|argc
parameter_list|,
name|char
modifier|*
modifier|*
name|argv
parameter_list|)
block|{
name|rpcblist_ptr
name|head
init|=
name|NULL
decl_stmt|;
name|struct
name|timeval
name|minutetimeout
decl_stmt|;
specifier|register
name|CLIENT
modifier|*
name|client
decl_stmt|;
name|struct
name|rpcent
modifier|*
name|rpc
decl_stmt|;
name|char
modifier|*
name|host
decl_stmt|;
name|struct
name|netidlist
modifier|*
name|nl
decl_stmt|;
name|struct
name|verslist
modifier|*
name|vl
decl_stmt|;
name|struct
name|rpcbdump_short
modifier|*
name|rs
decl_stmt|,
modifier|*
name|rs_tail
decl_stmt|;
name|char
name|buf
index|[
literal|256
index|]
decl_stmt|;
name|enum
name|clnt_stat
name|clnt_st
decl_stmt|;
name|struct
name|rpc_err
name|err
decl_stmt|;
name|struct
name|rpcbdump_short
modifier|*
name|rs_head
init|=
name|NULL
decl_stmt|;
if|if
condition|(
name|argc
operator|>
literal|1
condition|)
block|{
name|usage
argument_list|()
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|argc
operator|==
literal|1
condition|)
block|{
name|host
operator|=
name|argv
index|[
literal|0
index|]
expr_stmt|;
if|if
condition|(
name|netid
operator|==
name|NULL
condition|)
block|{
name|client
operator|=
name|clnt_rpcbind_create
argument_list|(
name|host
argument_list|,
name|RPCBVERS
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|struct
name|netconfig
modifier|*
name|nconf
decl_stmt|;
name|nconf
operator|=
name|getnetconfigent
argument_list|(
name|netid
argument_list|)
expr_stmt|;
if|if
condition|(
name|nconf
operator|==
name|NULL
condition|)
block|{
name|nc_perror
argument_list|(
literal|"rpcinfo: invalid transport"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
name|client
operator|=
name|getclnthandle
argument_list|(
name|host
argument_list|,
name|nconf
argument_list|,
name|RPCBVERS
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|nconf
condition|)
operator|(
name|void
operator|)
name|freenetconfigent
argument_list|(
name|nconf
argument_list|)
expr_stmt|;
block|}
block|}
else|else
name|client
operator|=
name|local_rpcb
argument_list|(
name|PMAPPROG
argument_list|,
name|RPCBVERS
argument_list|)
expr_stmt|;
if|if
condition|(
name|client
operator|==
operator|(
name|CLIENT
operator|*
operator|)
name|NULL
condition|)
block|{
name|clnt_pcreateerror
argument_list|(
literal|"rpcinfo: can't contact rpcbind"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
name|minutetimeout
operator|.
name|tv_sec
operator|=
literal|60
expr_stmt|;
name|minutetimeout
operator|.
name|tv_usec
operator|=
literal|0
expr_stmt|;
name|clnt_st
operator|=
name|CLNT_CALL
argument_list|(
name|client
argument_list|,
name|RPCBPROC_DUMP
argument_list|,
operator|(
name|xdrproc_t
operator|)
name|xdr_void
argument_list|,
name|NULL
argument_list|,
operator|(
name|xdrproc_t
operator|)
name|xdr_rpcblist_ptr
argument_list|,
operator|(
name|char
operator|*
operator|)
operator|&
name|head
argument_list|,
name|minutetimeout
argument_list|)
expr_stmt|;
if|if
condition|(
name|clnt_st
operator|!=
name|RPC_SUCCESS
condition|)
block|{
if|if
condition|(
operator|(
name|clnt_st
operator|==
name|RPC_PROGVERSMISMATCH
operator|)
operator|||
operator|(
name|clnt_st
operator|==
name|RPC_PROGUNAVAIL
operator|)
condition|)
block|{
name|int
name|vers
decl_stmt|;
name|CLNT_GETERR
argument_list|(
name|client
argument_list|,
operator|&
name|err
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
operator|.
name|re_vers
operator|.
name|low
operator|==
name|RPCBVERS4
condition|)
block|{
name|vers
operator|=
name|RPCBVERS4
expr_stmt|;
name|clnt_control
argument_list|(
name|client
argument_list|,
name|CLSET_VERS
argument_list|,
operator|(
name|char
operator|*
operator|)
operator|&
name|vers
argument_list|)
expr_stmt|;
name|clnt_st
operator|=
name|CLNT_CALL
argument_list|(
name|client
argument_list|,
name|RPCBPROC_DUMP
argument_list|,
operator|(
name|xdrproc_t
operator|)
name|xdr_void
argument_list|,
name|NULL
argument_list|,
operator|(
name|xdrproc_t
operator|)
name|xdr_rpcblist_ptr
argument_list|,
operator|(
name|char
operator|*
operator|)
operator|&
name|head
argument_list|,
name|minutetimeout
argument_list|)
expr_stmt|;
if|if
condition|(
name|clnt_st
operator|!=
name|RPC_SUCCESS
condition|)
goto|goto
name|failed
goto|;
block|}
else|else
block|{
if|if
condition|(
name|err
operator|.
name|re_vers
operator|.
name|high
operator|==
name|PMAPVERS
condition|)
block|{
name|int
name|high
decl_stmt|,
name|low
decl_stmt|;
name|struct
name|pmaplist
modifier|*
name|pmaphead
init|=
name|NULL
decl_stmt|;
name|rpcblist_ptr
name|list
decl_stmt|,
name|prev
decl_stmt|;
name|vers
operator|=
name|PMAPVERS
expr_stmt|;
name|clnt_control
argument_list|(
name|client
argument_list|,
name|CLSET_VERS
argument_list|,
operator|(
name|char
operator|*
operator|)
operator|&
name|vers
argument_list|)
expr_stmt|;
name|clnt_st
operator|=
name|CLNT_CALL
argument_list|(
name|client
argument_list|,
name|PMAPPROC_DUMP
argument_list|,
operator|(
name|xdrproc_t
operator|)
name|xdr_void
argument_list|,
name|NULL
argument_list|,
operator|(
name|xdrproc_t
operator|)
name|xdr_pmaplist_ptr
argument_list|,
operator|(
name|char
operator|*
operator|)
operator|&
name|pmaphead
argument_list|,
name|minutetimeout
argument_list|)
expr_stmt|;
if|if
condition|(
name|clnt_st
operator|!=
name|RPC_SUCCESS
condition|)
goto|goto
name|failed
goto|;
comment|/* 			 * convert to rpcblist_ptr format 			 */
for|for
control|(
name|head
operator|=
name|NULL
init|;
name|pmaphead
operator|!=
name|NULL
condition|;
name|pmaphead
operator|=
name|pmaphead
operator|->
name|pml_next
control|)
block|{
name|list
operator|=
operator|(
name|rpcblist
operator|*
operator|)
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
name|rpcblist
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|list
operator|==
name|NULL
condition|)
goto|goto
name|error
goto|;
if|if
condition|(
name|head
operator|==
name|NULL
condition|)
name|head
operator|=
name|list
expr_stmt|;
else|else
name|prev
operator|->
name|rpcb_next
operator|=
operator|(
name|rpcblist_ptr
operator|)
name|list
expr_stmt|;
name|list
operator|->
name|rpcb_next
operator|=
name|NULL
expr_stmt|;
name|list
operator|->
name|rpcb_map
operator|.
name|r_prog
operator|=
name|pmaphead
operator|->
name|pml_map
operator|.
name|pm_prog
expr_stmt|;
name|list
operator|->
name|rpcb_map
operator|.
name|r_vers
operator|=
name|pmaphead
operator|->
name|pml_map
operator|.
name|pm_vers
expr_stmt|;
if|if
condition|(
name|pmaphead
operator|->
name|pml_map
operator|.
name|pm_prot
operator|==
name|IPPROTO_UDP
condition|)
name|list
operator|->
name|rpcb_map
operator|.
name|r_netid
operator|=
literal|"udp"
expr_stmt|;
elseif|else
if|if
condition|(
name|pmaphead
operator|->
name|pml_map
operator|.
name|pm_prot
operator|==
name|IPPROTO_TCP
condition|)
name|list
operator|->
name|rpcb_map
operator|.
name|r_netid
operator|=
literal|"tcp"
expr_stmt|;
else|else
block|{
define|#
directive|define
name|MAXLONG_AS_STRING
value|"2147483648"
name|list
operator|->
name|rpcb_map
operator|.
name|r_netid
operator|=
name|malloc
argument_list|(
name|strlen
argument_list|(
name|MAXLONG_AS_STRING
argument_list|)
operator|+
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|list
operator|->
name|rpcb_map
operator|.
name|r_netid
operator|==
name|NULL
condition|)
goto|goto
name|error
goto|;
name|sprintf
argument_list|(
name|list
operator|->
name|rpcb_map
operator|.
name|r_netid
argument_list|,
literal|"%6ld"
argument_list|,
name|pmaphead
operator|->
name|pml_map
operator|.
name|pm_prot
argument_list|)
expr_stmt|;
block|}
name|list
operator|->
name|rpcb_map
operator|.
name|r_owner
operator|=
name|UNKNOWN
expr_stmt|;
name|low
operator|=
name|pmaphead
operator|->
name|pml_map
operator|.
name|pm_port
operator|&
literal|0xff
expr_stmt|;
name|high
operator|=
operator|(
name|pmaphead
operator|->
name|pml_map
operator|.
name|pm_port
operator|>>
literal|8
operator|)
operator|&
literal|0xff
expr_stmt|;
name|list
operator|->
name|rpcb_map
operator|.
name|r_addr
operator|=
name|strdup
argument_list|(
literal|"0.0.0.0.XXX.XXX"
argument_list|)
expr_stmt|;
name|sprintf
argument_list|(
operator|&
name|list
operator|->
name|rpcb_map
operator|.
name|r_addr
index|[
literal|8
index|]
argument_list|,
literal|"%d.%d"
argument_list|,
name|high
argument_list|,
name|low
argument_list|)
expr_stmt|;
name|prev
operator|=
name|list
expr_stmt|;
block|}
block|}
block|}
block|}
else|else
block|{
comment|/* any other error */
name|failed
label|:
name|clnt_perror
argument_list|(
name|client
argument_list|,
literal|"rpcinfo: can't contact rpcbind: "
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
name|head
operator|==
name|NULL
condition|)
block|{
name|printf
argument_list|(
literal|"No remote programs registered.\n"
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|dumptype
operator|==
name|RPCBDUMP
condition|)
block|{
name|printf
argument_list|(
literal|"   program version netid     address                service    owner\n"
argument_list|)
expr_stmt|;
for|for
control|(
init|;
name|head
operator|!=
name|NULL
condition|;
name|head
operator|=
name|head
operator|->
name|rpcb_next
control|)
block|{
name|printf
argument_list|(
literal|"%10u%5u    "
argument_list|,
name|head
operator|->
name|rpcb_map
operator|.
name|r_prog
argument_list|,
name|head
operator|->
name|rpcb_map
operator|.
name|r_vers
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"%-9s "
argument_list|,
name|head
operator|->
name|rpcb_map
operator|.
name|r_netid
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"%-22s"
argument_list|,
name|head
operator|->
name|rpcb_map
operator|.
name|r_addr
argument_list|)
expr_stmt|;
name|rpc
operator|=
name|getrpcbynumber
argument_list|(
name|head
operator|->
name|rpcb_map
operator|.
name|r_prog
argument_list|)
expr_stmt|;
if|if
condition|(
name|rpc
condition|)
name|printf
argument_list|(
literal|" %-10s"
argument_list|,
name|rpc
operator|->
name|r_name
argument_list|)
expr_stmt|;
else|else
name|printf
argument_list|(
literal|" %-10s"
argument_list|,
literal|"-"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|" %s\n"
argument_list|,
name|head
operator|->
name|rpcb_map
operator|.
name|r_owner
argument_list|)
expr_stmt|;
block|}
block|}
elseif|else
if|if
condition|(
name|dumptype
operator|==
name|RPCBDUMP_SHORT
condition|)
block|{
for|for
control|(
init|;
name|head
operator|!=
name|NULL
condition|;
name|head
operator|=
name|head
operator|->
name|rpcb_next
control|)
block|{
for|for
control|(
name|rs
operator|=
name|rs_head
init|;
name|rs
condition|;
name|rs
operator|=
name|rs
operator|->
name|next
control|)
if|if
condition|(
name|head
operator|->
name|rpcb_map
operator|.
name|r_prog
operator|==
name|rs
operator|->
name|prog
condition|)
break|break;
if|if
condition|(
name|rs
operator|==
name|NULL
condition|)
block|{
name|rs
operator|=
operator|(
expr|struct
name|rpcbdump_short
operator|*
operator|)
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
expr|struct
name|rpcbdump_short
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|rs
operator|==
name|NULL
condition|)
goto|goto
name|error
goto|;
name|rs
operator|->
name|next
operator|=
name|NULL
expr_stmt|;
if|if
condition|(
name|rs_head
operator|==
name|NULL
condition|)
block|{
name|rs_head
operator|=
name|rs
expr_stmt|;
name|rs_tail
operator|=
name|rs
expr_stmt|;
block|}
else|else
block|{
name|rs_tail
operator|->
name|next
operator|=
name|rs
expr_stmt|;
name|rs_tail
operator|=
name|rs
expr_stmt|;
block|}
name|rs
operator|->
name|prog
operator|=
name|head
operator|->
name|rpcb_map
operator|.
name|r_prog
expr_stmt|;
name|rs
operator|->
name|owner
operator|=
name|head
operator|->
name|rpcb_map
operator|.
name|r_owner
expr_stmt|;
name|rs
operator|->
name|nlist
operator|=
name|NULL
expr_stmt|;
name|rs
operator|->
name|vlist
operator|=
name|NULL
expr_stmt|;
block|}
if|if
condition|(
name|add_version
argument_list|(
name|rs
argument_list|,
name|head
operator|->
name|rpcb_map
operator|.
name|r_vers
argument_list|)
operator|==
name|FALSE
condition|)
goto|goto
name|error
goto|;
if|if
condition|(
name|add_netid
argument_list|(
name|rs
argument_list|,
name|head
operator|->
name|rpcb_map
operator|.
name|r_netid
argument_list|)
operator|==
name|FALSE
condition|)
goto|goto
name|error
goto|;
block|}
name|printf
argument_list|(
literal|"   program version(s) netid(s)                         service     owner\n"
argument_list|)
expr_stmt|;
for|for
control|(
name|rs
operator|=
name|rs_head
init|;
name|rs
condition|;
name|rs
operator|=
name|rs
operator|->
name|next
control|)
block|{
name|char
modifier|*
name|p
init|=
name|buf
decl_stmt|;
name|printf
argument_list|(
literal|"%10ld  "
argument_list|,
name|rs
operator|->
name|prog
argument_list|)
expr_stmt|;
for|for
control|(
name|vl
operator|=
name|rs
operator|->
name|vlist
init|;
name|vl
condition|;
name|vl
operator|=
name|vl
operator|->
name|next
control|)
block|{
name|sprintf
argument_list|(
name|p
argument_list|,
literal|"%d"
argument_list|,
name|vl
operator|->
name|vers
argument_list|)
expr_stmt|;
name|p
operator|=
name|p
operator|+
name|strlen
argument_list|(
name|p
argument_list|)
expr_stmt|;
if|if
condition|(
name|vl
operator|->
name|next
condition|)
name|sprintf
argument_list|(
name|p
operator|++
argument_list|,
literal|","
argument_list|)
expr_stmt|;
block|}
name|printf
argument_list|(
literal|"%-10s"
argument_list|,
name|buf
argument_list|)
expr_stmt|;
name|buf
index|[
literal|0
index|]
operator|=
name|NULL
expr_stmt|;
for|for
control|(
name|nl
operator|=
name|rs
operator|->
name|nlist
init|;
name|nl
condition|;
name|nl
operator|=
name|nl
operator|->
name|next
control|)
block|{
name|strcat
argument_list|(
name|buf
argument_list|,
name|nl
operator|->
name|netid
argument_list|)
expr_stmt|;
if|if
condition|(
name|nl
operator|->
name|next
condition|)
name|strcat
argument_list|(
name|buf
argument_list|,
literal|","
argument_list|)
expr_stmt|;
block|}
name|printf
argument_list|(
literal|"%-32s"
argument_list|,
name|buf
argument_list|)
expr_stmt|;
name|rpc
operator|=
name|getrpcbynumber
argument_list|(
name|rs
operator|->
name|prog
argument_list|)
expr_stmt|;
if|if
condition|(
name|rpc
condition|)
name|printf
argument_list|(
literal|" %-11s"
argument_list|,
name|rpc
operator|->
name|r_name
argument_list|)
expr_stmt|;
else|else
name|printf
argument_list|(
literal|" %-11s"
argument_list|,
literal|"-"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|" %s\n"
argument_list|,
name|rs
operator|->
name|owner
argument_list|)
expr_stmt|;
block|}
block|}
name|clnt_destroy
argument_list|(
name|client
argument_list|)
expr_stmt|;
return|return;
name|error
label|:
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"rpcinfo: no memory\n"
argument_list|)
expr_stmt|;
return|return;
block|}
specifier|static
name|char
name|nullstring
index|[]
init|=
literal|"\000"
decl_stmt|;
specifier|static
name|void
name|rpcbaddrlist
parameter_list|(
name|char
modifier|*
name|netid
parameter_list|,
name|int
name|argc
parameter_list|,
name|char
modifier|*
modifier|*
name|argv
parameter_list|)
block|{
name|rpcb_entry_list_ptr
name|head
init|=
name|NULL
decl_stmt|;
name|struct
name|timeval
name|minutetimeout
decl_stmt|;
specifier|register
name|CLIENT
modifier|*
name|client
decl_stmt|;
name|struct
name|rpcent
modifier|*
name|rpc
decl_stmt|;
name|char
modifier|*
name|host
decl_stmt|;
name|RPCB
name|parms
decl_stmt|;
name|struct
name|netbuf
modifier|*
name|targaddr
decl_stmt|;
if|if
condition|(
name|argc
operator|!=
literal|3
condition|)
block|{
name|usage
argument_list|()
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
name|host
operator|=
name|argv
index|[
literal|0
index|]
expr_stmt|;
if|if
condition|(
name|netid
operator|==
name|NULL
condition|)
block|{
name|client
operator|=
name|clnt_rpcbind_create
argument_list|(
name|host
argument_list|,
name|RPCBVERS4
argument_list|,
operator|&
name|targaddr
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|struct
name|netconfig
modifier|*
name|nconf
decl_stmt|;
name|nconf
operator|=
name|getnetconfigent
argument_list|(
name|netid
argument_list|)
expr_stmt|;
if|if
condition|(
name|nconf
operator|==
name|NULL
condition|)
block|{
name|nc_perror
argument_list|(
literal|"rpcinfo: invalid transport"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
name|client
operator|=
name|getclnthandle
argument_list|(
name|host
argument_list|,
name|nconf
argument_list|,
name|RPCBVERS4
argument_list|,
operator|&
name|targaddr
argument_list|)
expr_stmt|;
if|if
condition|(
name|nconf
condition|)
operator|(
name|void
operator|)
name|freenetconfigent
argument_list|(
name|nconf
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|client
operator|==
operator|(
name|CLIENT
operator|*
operator|)
name|NULL
condition|)
block|{
name|clnt_pcreateerror
argument_list|(
literal|"rpcinfo: can't contact rpcbind"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
name|minutetimeout
operator|.
name|tv_sec
operator|=
literal|60
expr_stmt|;
name|minutetimeout
operator|.
name|tv_usec
operator|=
literal|0
expr_stmt|;
name|parms
operator|.
name|r_prog
operator|=
name|getprognum
argument_list|(
name|argv
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
name|parms
operator|.
name|r_vers
operator|=
name|getvers
argument_list|(
name|argv
index|[
literal|2
index|]
argument_list|)
expr_stmt|;
name|parms
operator|.
name|r_netid
operator|=
name|client
operator|->
name|cl_netid
expr_stmt|;
if|if
condition|(
name|targaddr
operator|==
name|NULL
condition|)
block|{
name|parms
operator|.
name|r_addr
operator|=
name|nullstring
expr_stmt|;
comment|/* for XDRing */
block|}
else|else
block|{
comment|/* 		 * We also send the remote system the address we 		 * used to contact it in case it can help it 		 * connect back with us 		 */
name|struct
name|netconfig
modifier|*
name|nconf
decl_stmt|;
name|nconf
operator|=
name|getnetconfigent
argument_list|(
name|client
operator|->
name|cl_netid
argument_list|)
expr_stmt|;
if|if
condition|(
name|nconf
operator|!=
name|NULL
condition|)
block|{
name|parms
operator|.
name|r_addr
operator|=
name|taddr2uaddr
argument_list|(
name|nconf
argument_list|,
name|targaddr
argument_list|)
expr_stmt|;
if|if
condition|(
name|parms
operator|.
name|r_addr
operator|==
name|NULL
condition|)
name|parms
operator|.
name|r_addr
operator|=
name|nullstring
expr_stmt|;
name|freenetconfigent
argument_list|(
name|nconf
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|parms
operator|.
name|r_addr
operator|=
name|nullstring
expr_stmt|;
comment|/* for XDRing */
block|}
name|free
argument_list|(
name|targaddr
operator|->
name|buf
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|targaddr
argument_list|)
expr_stmt|;
block|}
name|parms
operator|.
name|r_owner
operator|=
name|nullstring
expr_stmt|;
if|if
condition|(
name|CLNT_CALL
argument_list|(
name|client
argument_list|,
name|RPCBPROC_GETADDRLIST
argument_list|,
operator|(
name|xdrproc_t
operator|)
name|xdr_rpcb
argument_list|,
operator|(
name|char
operator|*
operator|)
operator|&
name|parms
argument_list|,
operator|(
name|xdrproc_t
operator|)
name|xdr_rpcb_entry_list_ptr
argument_list|,
operator|(
name|char
operator|*
operator|)
operator|&
name|head
argument_list|,
name|minutetimeout
argument_list|)
operator|!=
name|RPC_SUCCESS
condition|)
block|{
name|clnt_perror
argument_list|(
name|client
argument_list|,
literal|"rpcinfo: can't contact rpcbind: "
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|head
operator|==
name|NULL
condition|)
block|{
name|printf
argument_list|(
literal|"No remote programs registered.\n"
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|printf
argument_list|(
literal|"   program vers  tp_family/name/class    address\t\t  service\n"
argument_list|)
expr_stmt|;
for|for
control|(
init|;
name|head
operator|!=
name|NULL
condition|;
name|head
operator|=
name|head
operator|->
name|rpcb_entry_next
control|)
block|{
name|rpcb_entry
modifier|*
name|re
decl_stmt|;
name|char
name|buf
index|[
literal|128
index|]
decl_stmt|;
name|re
operator|=
operator|&
name|head
operator|->
name|rpcb_entry_map
expr_stmt|;
name|printf
argument_list|(
literal|"%10u%3u    "
argument_list|,
name|parms
operator|.
name|r_prog
argument_list|,
name|parms
operator|.
name|r_vers
argument_list|)
expr_stmt|;
name|sprintf
argument_list|(
name|buf
argument_list|,
literal|"%s/%s/%s "
argument_list|,
name|re
operator|->
name|r_nc_protofmly
argument_list|,
name|re
operator|->
name|r_nc_proto
argument_list|,
name|re
operator|->
name|r_nc_semantics
operator|==
name|NC_TPI_CLTS
condition|?
literal|"clts"
else|:
name|re
operator|->
name|r_nc_semantics
operator|==
name|NC_TPI_COTS
condition|?
literal|"cots"
else|:
literal|"cots_ord"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"%-24s"
argument_list|,
name|buf
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"%-24s"
argument_list|,
name|re
operator|->
name|r_maddr
argument_list|)
expr_stmt|;
name|rpc
operator|=
name|getrpcbynumber
argument_list|(
name|parms
operator|.
name|r_prog
argument_list|)
expr_stmt|;
if|if
condition|(
name|rpc
condition|)
name|printf
argument_list|(
literal|" %-13s"
argument_list|,
name|rpc
operator|->
name|r_name
argument_list|)
expr_stmt|;
else|else
name|printf
argument_list|(
literal|" %-13s"
argument_list|,
literal|"-"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
block|}
block|}
name|clnt_destroy
argument_list|(
name|client
argument_list|)
expr_stmt|;
return|return;
block|}
comment|/*  * monitor rpcbind  */
specifier|static
name|void
name|rpcbgetstat
parameter_list|(
name|int
name|argc
parameter_list|,
name|char
modifier|*
modifier|*
name|argv
parameter_list|)
block|{
name|rpcb_stat_byvers
name|inf
decl_stmt|;
name|struct
name|timeval
name|minutetimeout
decl_stmt|;
specifier|register
name|CLIENT
modifier|*
name|client
decl_stmt|;
name|char
modifier|*
name|host
decl_stmt|;
name|int
name|i
decl_stmt|,
name|j
decl_stmt|;
name|rpcbs_addrlist
modifier|*
name|pa
decl_stmt|;
name|rpcbs_rmtcalllist
modifier|*
name|pr
decl_stmt|;
name|int
name|cnt
decl_stmt|,
name|flen
decl_stmt|;
define|#
directive|define
name|MAXFIELD
value|64
name|char
name|fieldbuf
index|[
name|MAXFIELD
index|]
decl_stmt|;
define|#
directive|define
name|MAXLINE
value|256
name|char
name|linebuf
index|[
name|MAXLINE
index|]
decl_stmt|;
name|char
modifier|*
name|cp
decl_stmt|,
modifier|*
name|lp
decl_stmt|;
name|char
modifier|*
name|pmaphdr
index|[]
init|=
block|{
literal|"NULL"
block|,
literal|"SET"
block|,
literal|"UNSET"
block|,
literal|"GETPORT"
block|,
literal|"DUMP"
block|,
literal|"CALLIT"
block|}
decl_stmt|;
name|char
modifier|*
name|rpcb3hdr
index|[]
init|=
block|{
literal|"NULL"
block|,
literal|"SET"
block|,
literal|"UNSET"
block|,
literal|"GETADDR"
block|,
literal|"DUMP"
block|,
literal|"CALLIT"
block|,
literal|"TIME"
block|,
literal|"U2T"
block|,
literal|"T2U"
block|}
decl_stmt|;
name|char
modifier|*
name|rpcb4hdr
index|[]
init|=
block|{
literal|"NULL"
block|,
literal|"SET"
block|,
literal|"UNSET"
block|,
literal|"GETADDR"
block|,
literal|"DUMP"
block|,
literal|"CALLIT"
block|,
literal|"TIME"
block|,
literal|"U2T"
block|,
literal|"T2U"
block|,
literal|"VERADDR"
block|,
literal|"INDRECT"
block|,
literal|"GETLIST"
block|,
literal|"GETSTAT"
block|}
decl_stmt|;
define|#
directive|define
name|TABSTOP
value|8
if|if
condition|(
name|argc
operator|>=
literal|1
condition|)
block|{
name|host
operator|=
name|argv
index|[
literal|0
index|]
expr_stmt|;
name|client
operator|=
name|clnt_rpcbind_create
argument_list|(
name|host
argument_list|,
name|RPCBVERS4
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
block|}
else|else
name|client
operator|=
name|local_rpcb
argument_list|(
name|PMAPPROG
argument_list|,
name|RPCBVERS4
argument_list|)
expr_stmt|;
if|if
condition|(
name|client
operator|==
operator|(
name|CLIENT
operator|*
operator|)
name|NULL
condition|)
block|{
name|clnt_pcreateerror
argument_list|(
literal|"rpcinfo: can't contact rpcbind"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
name|minutetimeout
operator|.
name|tv_sec
operator|=
literal|60
expr_stmt|;
name|minutetimeout
operator|.
name|tv_usec
operator|=
literal|0
expr_stmt|;
name|memset
argument_list|(
operator|(
name|char
operator|*
operator|)
operator|&
name|inf
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|rpcb_stat_byvers
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|CLNT_CALL
argument_list|(
name|client
argument_list|,
name|RPCBPROC_GETSTAT
argument_list|,
operator|(
name|xdrproc_t
operator|)
name|xdr_void
argument_list|,
name|NULL
argument_list|,
operator|(
name|xdrproc_t
operator|)
name|xdr_rpcb_stat_byvers
argument_list|,
operator|(
name|char
operator|*
operator|)
operator|&
name|inf
argument_list|,
name|minutetimeout
argument_list|)
operator|!=
name|RPC_SUCCESS
condition|)
block|{
name|clnt_perror
argument_list|(
name|client
argument_list|,
literal|"rpcinfo: can't contact rpcbind: "
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
name|printf
argument_list|(
literal|"PORTMAP (version 2) statistics\n"
argument_list|)
expr_stmt|;
name|lp
operator|=
name|linebuf
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<=
name|rpcb_highproc_2
condition|;
name|i
operator|++
control|)
block|{
name|fieldbuf
index|[
literal|0
index|]
operator|=
literal|'\0'
expr_stmt|;
switch|switch
condition|(
name|i
condition|)
block|{
case|case
name|PMAPPROC_SET
case|:
name|sprintf
argument_list|(
name|fieldbuf
argument_list|,
literal|"%d/"
argument_list|,
name|inf
index|[
name|RPCBVERS_2_STAT
index|]
operator|.
name|setinfo
argument_list|)
expr_stmt|;
break|break;
case|case
name|PMAPPROC_UNSET
case|:
name|sprintf
argument_list|(
name|fieldbuf
argument_list|,
literal|"%d/"
argument_list|,
name|inf
index|[
name|RPCBVERS_2_STAT
index|]
operator|.
name|unsetinfo
argument_list|)
expr_stmt|;
break|break;
case|case
name|PMAPPROC_GETPORT
case|:
name|cnt
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|pa
operator|=
name|inf
index|[
name|RPCBVERS_2_STAT
index|]
operator|.
name|addrinfo
init|;
name|pa
condition|;
name|pa
operator|=
name|pa
operator|->
name|next
control|)
name|cnt
operator|+=
name|pa
operator|->
name|success
expr_stmt|;
name|sprintf
argument_list|(
name|fieldbuf
argument_list|,
literal|"%d/"
argument_list|,
name|cnt
argument_list|)
expr_stmt|;
break|break;
case|case
name|PMAPPROC_CALLIT
case|:
name|cnt
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|pr
operator|=
name|inf
index|[
name|RPCBVERS_2_STAT
index|]
operator|.
name|rmtinfo
init|;
name|pr
condition|;
name|pr
operator|=
name|pr
operator|->
name|next
control|)
name|cnt
operator|+=
name|pr
operator|->
name|success
expr_stmt|;
name|sprintf
argument_list|(
name|fieldbuf
argument_list|,
literal|"%d/"
argument_list|,
name|cnt
argument_list|)
expr_stmt|;
break|break;
default|default:
break|break;
comment|/* For the remaining ones */
block|}
name|cp
operator|=
operator|&
name|fieldbuf
index|[
literal|0
index|]
operator|+
name|strlen
argument_list|(
name|fieldbuf
argument_list|)
expr_stmt|;
name|sprintf
argument_list|(
name|cp
argument_list|,
literal|"%d"
argument_list|,
name|inf
index|[
name|RPCBVERS_2_STAT
index|]
operator|.
name|info
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|flen
operator|=
name|strlen
argument_list|(
name|fieldbuf
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"%s%s"
argument_list|,
name|pmaphdr
index|[
name|i
index|]
argument_list|,
name|spaces
argument_list|(
operator|(
name|TABSTOP
operator|*
operator|(
literal|1
operator|+
name|flen
operator|/
name|TABSTOP
operator|)
operator|)
operator|-
name|strlen
argument_list|(
name|pmaphdr
index|[
name|i
index|]
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
name|sprintf
argument_list|(
name|lp
argument_list|,
literal|"%s%s"
argument_list|,
name|fieldbuf
argument_list|,
name|spaces
argument_list|(
name|cnt
operator|=
operator|(
operator|(
name|TABSTOP
operator|*
operator|(
literal|1
operator|+
name|flen
operator|/
name|TABSTOP
operator|)
operator|)
operator|-
name|flen
operator|)
argument_list|)
argument_list|)
expr_stmt|;
name|lp
operator|+=
operator|(
name|flen
operator|+
name|cnt
operator|)
expr_stmt|;
block|}
name|printf
argument_list|(
literal|"\n%s\n\n"
argument_list|,
name|linebuf
argument_list|)
expr_stmt|;
if|if
condition|(
name|inf
index|[
name|RPCBVERS_2_STAT
index|]
operator|.
name|info
index|[
name|PMAPPROC_CALLIT
index|]
condition|)
block|{
name|printf
argument_list|(
literal|"PMAP_RMTCALL call statistics\n"
argument_list|)
expr_stmt|;
name|print_rmtcallstat
argument_list|(
name|RPCBVERS_2_STAT
argument_list|,
operator|&
name|inf
index|[
name|RPCBVERS_2_STAT
index|]
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|inf
index|[
name|RPCBVERS_2_STAT
index|]
operator|.
name|info
index|[
name|PMAPPROC_GETPORT
index|]
condition|)
block|{
name|printf
argument_list|(
literal|"PMAP_GETPORT call statistics\n"
argument_list|)
expr_stmt|;
name|print_getaddrstat
argument_list|(
name|RPCBVERS_2_STAT
argument_list|,
operator|&
name|inf
index|[
name|RPCBVERS_2_STAT
index|]
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
block|}
name|printf
argument_list|(
literal|"RPCBIND (version 3) statistics\n"
argument_list|)
expr_stmt|;
name|lp
operator|=
name|linebuf
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<=
name|rpcb_highproc_3
condition|;
name|i
operator|++
control|)
block|{
name|fieldbuf
index|[
literal|0
index|]
operator|=
literal|'\0'
expr_stmt|;
switch|switch
condition|(
name|i
condition|)
block|{
case|case
name|RPCBPROC_SET
case|:
name|sprintf
argument_list|(
name|fieldbuf
argument_list|,
literal|"%d/"
argument_list|,
name|inf
index|[
name|RPCBVERS_3_STAT
index|]
operator|.
name|setinfo
argument_list|)
expr_stmt|;
break|break;
case|case
name|RPCBPROC_UNSET
case|:
name|sprintf
argument_list|(
name|fieldbuf
argument_list|,
literal|"%d/"
argument_list|,
name|inf
index|[
name|RPCBVERS_3_STAT
index|]
operator|.
name|unsetinfo
argument_list|)
expr_stmt|;
break|break;
case|case
name|RPCBPROC_GETADDR
case|:
name|cnt
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|pa
operator|=
name|inf
index|[
name|RPCBVERS_3_STAT
index|]
operator|.
name|addrinfo
init|;
name|pa
condition|;
name|pa
operator|=
name|pa
operator|->
name|next
control|)
name|cnt
operator|+=
name|pa
operator|->
name|success
expr_stmt|;
name|sprintf
argument_list|(
name|fieldbuf
argument_list|,
literal|"%d/"
argument_list|,
name|cnt
argument_list|)
expr_stmt|;
break|break;
case|case
name|RPCBPROC_CALLIT
case|:
name|cnt
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|pr
operator|=
name|inf
index|[
name|RPCBVERS_3_STAT
index|]
operator|.
name|rmtinfo
init|;
name|pr
condition|;
name|pr
operator|=
name|pr
operator|->
name|next
control|)
name|cnt
operator|+=
name|pr
operator|->
name|success
expr_stmt|;
name|sprintf
argument_list|(
name|fieldbuf
argument_list|,
literal|"%d/"
argument_list|,
name|cnt
argument_list|)
expr_stmt|;
break|break;
default|default:
break|break;
comment|/* For the remaining ones */
block|}
name|cp
operator|=
operator|&
name|fieldbuf
index|[
literal|0
index|]
operator|+
name|strlen
argument_list|(
name|fieldbuf
argument_list|)
expr_stmt|;
name|sprintf
argument_list|(
name|cp
argument_list|,
literal|"%d"
argument_list|,
name|inf
index|[
name|RPCBVERS_3_STAT
index|]
operator|.
name|info
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|flen
operator|=
name|strlen
argument_list|(
name|fieldbuf
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"%s%s"
argument_list|,
name|rpcb3hdr
index|[
name|i
index|]
argument_list|,
name|spaces
argument_list|(
operator|(
name|TABSTOP
operator|*
operator|(
literal|1
operator|+
name|flen
operator|/
name|TABSTOP
operator|)
operator|)
operator|-
name|strlen
argument_list|(
name|rpcb3hdr
index|[
name|i
index|]
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
name|sprintf
argument_list|(
name|lp
argument_list|,
literal|"%s%s"
argument_list|,
name|fieldbuf
argument_list|,
name|spaces
argument_list|(
name|cnt
operator|=
operator|(
operator|(
name|TABSTOP
operator|*
operator|(
literal|1
operator|+
name|flen
operator|/
name|TABSTOP
operator|)
operator|)
operator|-
name|flen
operator|)
argument_list|)
argument_list|)
expr_stmt|;
name|lp
operator|+=
operator|(
name|flen
operator|+
name|cnt
operator|)
expr_stmt|;
block|}
name|printf
argument_list|(
literal|"\n%s\n\n"
argument_list|,
name|linebuf
argument_list|)
expr_stmt|;
if|if
condition|(
name|inf
index|[
name|RPCBVERS_3_STAT
index|]
operator|.
name|info
index|[
name|RPCBPROC_CALLIT
index|]
condition|)
block|{
name|printf
argument_list|(
literal|"RPCB_RMTCALL (version 3) call statistics\n"
argument_list|)
expr_stmt|;
name|print_rmtcallstat
argument_list|(
name|RPCBVERS_3_STAT
argument_list|,
operator|&
name|inf
index|[
name|RPCBVERS_3_STAT
index|]
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|inf
index|[
name|RPCBVERS_3_STAT
index|]
operator|.
name|info
index|[
name|RPCBPROC_GETADDR
index|]
condition|)
block|{
name|printf
argument_list|(
literal|"RPCB_GETADDR (version 3) call statistics\n"
argument_list|)
expr_stmt|;
name|print_getaddrstat
argument_list|(
name|RPCBVERS_3_STAT
argument_list|,
operator|&
name|inf
index|[
name|RPCBVERS_3_STAT
index|]
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
block|}
name|printf
argument_list|(
literal|"RPCBIND (version 4) statistics\n"
argument_list|)
expr_stmt|;
for|for
control|(
name|j
operator|=
literal|0
init|;
name|j
operator|<=
literal|9
condition|;
name|j
operator|+=
literal|9
control|)
block|{
comment|/* Just two iterations for printing */
name|lp
operator|=
name|linebuf
expr_stmt|;
for|for
control|(
name|i
operator|=
name|j
init|;
name|i
operator|<=
name|MAX
argument_list|(
literal|8
argument_list|,
name|rpcb_highproc_4
operator|-
literal|9
operator|+
name|j
argument_list|)
condition|;
name|i
operator|++
control|)
block|{
name|fieldbuf
index|[
literal|0
index|]
operator|=
literal|'\0'
expr_stmt|;
switch|switch
condition|(
name|i
condition|)
block|{
case|case
name|RPCBPROC_SET
case|:
name|sprintf
argument_list|(
name|fieldbuf
argument_list|,
literal|"%d/"
argument_list|,
name|inf
index|[
name|RPCBVERS_4_STAT
index|]
operator|.
name|setinfo
argument_list|)
expr_stmt|;
break|break;
case|case
name|RPCBPROC_UNSET
case|:
name|sprintf
argument_list|(
name|fieldbuf
argument_list|,
literal|"%d/"
argument_list|,
name|inf
index|[
name|RPCBVERS_4_STAT
index|]
operator|.
name|unsetinfo
argument_list|)
expr_stmt|;
break|break;
case|case
name|RPCBPROC_GETADDR
case|:
name|cnt
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|pa
operator|=
name|inf
index|[
name|RPCBVERS_4_STAT
index|]
operator|.
name|addrinfo
init|;
name|pa
condition|;
name|pa
operator|=
name|pa
operator|->
name|next
control|)
name|cnt
operator|+=
name|pa
operator|->
name|success
expr_stmt|;
name|sprintf
argument_list|(
name|fieldbuf
argument_list|,
literal|"%d/"
argument_list|,
name|cnt
argument_list|)
expr_stmt|;
break|break;
case|case
name|RPCBPROC_CALLIT
case|:
name|cnt
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|pr
operator|=
name|inf
index|[
name|RPCBVERS_4_STAT
index|]
operator|.
name|rmtinfo
init|;
name|pr
condition|;
name|pr
operator|=
name|pr
operator|->
name|next
control|)
name|cnt
operator|+=
name|pr
operator|->
name|success
expr_stmt|;
name|sprintf
argument_list|(
name|fieldbuf
argument_list|,
literal|"%d/"
argument_list|,
name|cnt
argument_list|)
expr_stmt|;
break|break;
default|default:
break|break;
comment|/* For the remaining ones */
block|}
name|cp
operator|=
operator|&
name|fieldbuf
index|[
literal|0
index|]
operator|+
name|strlen
argument_list|(
name|fieldbuf
argument_list|)
expr_stmt|;
comment|/* 			 * XXX: We also add RPCBPROC_GETADDRLIST queries to 			 * RPCB_GETADDR because rpcbind includes the 			 * RPCB_GETADDRLIST successes in RPCB_GETADDR. 			 */
if|if
condition|(
name|i
operator|!=
name|RPCBPROC_GETADDR
condition|)
name|sprintf
argument_list|(
name|cp
argument_list|,
literal|"%d"
argument_list|,
name|inf
index|[
name|RPCBVERS_4_STAT
index|]
operator|.
name|info
index|[
name|i
index|]
argument_list|)
expr_stmt|;
else|else
name|sprintf
argument_list|(
name|cp
argument_list|,
literal|"%d"
argument_list|,
name|inf
index|[
name|RPCBVERS_4_STAT
index|]
operator|.
name|info
index|[
name|i
index|]
operator|+
name|inf
index|[
name|RPCBVERS_4_STAT
index|]
operator|.
name|info
index|[
name|RPCBPROC_GETADDRLIST
index|]
argument_list|)
expr_stmt|;
name|flen
operator|=
name|strlen
argument_list|(
name|fieldbuf
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"%s%s"
argument_list|,
name|rpcb4hdr
index|[
name|i
index|]
argument_list|,
name|spaces
argument_list|(
operator|(
name|TABSTOP
operator|*
operator|(
literal|1
operator|+
name|flen
operator|/
name|TABSTOP
operator|)
operator|)
operator|-
name|strlen
argument_list|(
name|rpcb4hdr
index|[
name|i
index|]
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
name|sprintf
argument_list|(
name|lp
argument_list|,
literal|"%s%s"
argument_list|,
name|fieldbuf
argument_list|,
name|spaces
argument_list|(
name|cnt
operator|=
operator|(
operator|(
name|TABSTOP
operator|*
operator|(
literal|1
operator|+
name|flen
operator|/
name|TABSTOP
operator|)
operator|)
operator|-
name|flen
operator|)
argument_list|)
argument_list|)
expr_stmt|;
name|lp
operator|+=
operator|(
name|flen
operator|+
name|cnt
operator|)
expr_stmt|;
block|}
name|printf
argument_list|(
literal|"\n%s\n"
argument_list|,
name|linebuf
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|inf
index|[
name|RPCBVERS_4_STAT
index|]
operator|.
name|info
index|[
name|RPCBPROC_CALLIT
index|]
operator|||
name|inf
index|[
name|RPCBVERS_4_STAT
index|]
operator|.
name|info
index|[
name|RPCBPROC_INDIRECT
index|]
condition|)
block|{
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"RPCB_RMTCALL (version 4) call statistics\n"
argument_list|)
expr_stmt|;
name|print_rmtcallstat
argument_list|(
name|RPCBVERS_4_STAT
argument_list|,
operator|&
name|inf
index|[
name|RPCBVERS_4_STAT
index|]
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|inf
index|[
name|RPCBVERS_4_STAT
index|]
operator|.
name|info
index|[
name|RPCBPROC_GETADDR
index|]
condition|)
block|{
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"RPCB_GETADDR (version 4) call statistics\n"
argument_list|)
expr_stmt|;
name|print_getaddrstat
argument_list|(
name|RPCBVERS_4_STAT
argument_list|,
operator|&
name|inf
index|[
name|RPCBVERS_4_STAT
index|]
argument_list|)
expr_stmt|;
block|}
name|clnt_destroy
argument_list|(
name|client
argument_list|)
expr_stmt|;
block|}
comment|/*  * Delete registeration for this (prog, vers, netid)  */
specifier|static
name|void
name|deletereg
parameter_list|(
name|char
modifier|*
name|netid
parameter_list|,
name|int
name|argc
parameter_list|,
name|char
modifier|*
modifier|*
name|argv
parameter_list|)
block|{
name|struct
name|netconfig
modifier|*
name|nconf
init|=
name|NULL
decl_stmt|;
if|if
condition|(
name|argc
operator|!=
literal|2
condition|)
block|{
name|usage
argument_list|()
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|netid
condition|)
block|{
name|nconf
operator|=
name|getnetconfigent
argument_list|(
name|netid
argument_list|)
expr_stmt|;
if|if
condition|(
name|nconf
operator|==
name|NULL
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"rpcinfo: netid %s not supported\n"
argument_list|,
name|netid
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
operator|(
name|rpcb_unset
argument_list|(
name|getprognum
argument_list|(
name|argv
index|[
literal|0
index|]
argument_list|)
argument_list|,
name|getvers
argument_list|(
name|argv
index|[
literal|1
index|]
argument_list|)
argument_list|,
name|nconf
argument_list|)
operator|)
operator|==
literal|0
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"rpcinfo: Could not delete registration for prog %s version %s\n"
argument_list|,
name|argv
index|[
literal|0
index|]
argument_list|,
name|argv
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
block|}
comment|/*  * Create and return a handle for the given nconf.  * Exit if cannot create handle.  */
specifier|static
name|CLIENT
modifier|*
name|clnt_addr_create
parameter_list|(
name|char
modifier|*
name|address
parameter_list|,
name|struct
name|netconfig
modifier|*
name|nconf
parameter_list|,
name|u_long
name|prog
parameter_list|,
name|u_long
name|vers
parameter_list|)
block|{
name|CLIENT
modifier|*
name|client
decl_stmt|;
specifier|static
name|struct
name|netbuf
modifier|*
name|nbuf
decl_stmt|;
specifier|static
name|int
name|fd
init|=
name|RPC_ANYFD
decl_stmt|;
if|if
condition|(
name|fd
operator|==
name|RPC_ANYFD
condition|)
block|{
if|if
condition|(
operator|(
name|fd
operator|=
name|__rpc_nconf2fd
argument_list|(
name|nconf
argument_list|)
operator|)
operator|==
operator|-
literal|1
condition|)
block|{
name|rpc_createerr
operator|.
name|cf_stat
operator|=
name|RPC_TLIERROR
expr_stmt|;
name|clnt_pcreateerror
argument_list|(
literal|"rpcinfo"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
comment|/* Convert the uaddr to taddr */
name|nbuf
operator|=
name|uaddr2taddr
argument_list|(
name|nconf
argument_list|,
name|address
argument_list|)
expr_stmt|;
if|if
condition|(
name|nbuf
operator|==
name|NULL
condition|)
block|{
name|errx
argument_list|(
literal|1
argument_list|,
literal|"rpcinfo: no address for client handle"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
block|}
name|client
operator|=
name|clnt_tli_create
argument_list|(
name|fd
argument_list|,
name|nconf
argument_list|,
name|nbuf
argument_list|,
name|prog
argument_list|,
name|vers
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|client
operator|==
operator|(
name|CLIENT
operator|*
operator|)
name|NULL
condition|)
block|{
name|clnt_pcreateerror
argument_list|(
literal|"rpcinfo"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
return|return
operator|(
name|client
operator|)
return|;
block|}
comment|/*  * If the version number is given, ping that (prog, vers); else try to find  * the version numbers supported for that prog and ping all the versions.  * Remote rpcbind is not contacted for this service. The requests are  * sent directly to the services themselves.  */
specifier|static
name|void
name|addrping
parameter_list|(
name|char
modifier|*
name|address
parameter_list|,
name|char
modifier|*
name|netid
parameter_list|,
name|int
name|argc
parameter_list|,
name|char
modifier|*
modifier|*
name|argv
parameter_list|)
block|{
name|CLIENT
modifier|*
name|client
decl_stmt|;
name|struct
name|timeval
name|to
decl_stmt|;
name|enum
name|clnt_stat
name|rpc_stat
decl_stmt|;
name|u_long
name|prognum
decl_stmt|,
name|versnum
decl_stmt|,
name|minvers
decl_stmt|,
name|maxvers
decl_stmt|;
name|struct
name|rpc_err
name|rpcerr
decl_stmt|;
name|int
name|failure
init|=
literal|0
decl_stmt|;
name|struct
name|netconfig
modifier|*
name|nconf
decl_stmt|;
name|int
name|fd
decl_stmt|;
if|if
condition|(
name|argc
operator|<
literal|1
operator|||
name|argc
operator|>
literal|2
operator|||
operator|(
name|netid
operator|==
name|NULL
operator|)
condition|)
block|{
name|usage
argument_list|()
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
name|nconf
operator|=
name|getnetconfigent
argument_list|(
name|netid
argument_list|)
expr_stmt|;
if|if
condition|(
name|nconf
operator|==
operator|(
expr|struct
name|netconfig
operator|*
operator|)
name|NULL
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"rpcinfo: Could not find %s\n"
argument_list|,
name|netid
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
name|to
operator|.
name|tv_sec
operator|=
literal|10
expr_stmt|;
name|to
operator|.
name|tv_usec
operator|=
literal|0
expr_stmt|;
name|prognum
operator|=
name|getprognum
argument_list|(
name|argv
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|argc
operator|==
literal|1
condition|)
block|{
comment|/* Version number not known */
comment|/* 		 * A call to version 0 should fail with a program/version 		 * mismatch, and give us the range of versions supported. 		 */
name|versnum
operator|=
name|MIN_VERS
expr_stmt|;
block|}
else|else
block|{
name|versnum
operator|=
name|getvers
argument_list|(
name|argv
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
block|}
name|client
operator|=
name|clnt_addr_create
argument_list|(
name|address
argument_list|,
name|nconf
argument_list|,
name|prognum
argument_list|,
name|versnum
argument_list|)
expr_stmt|;
name|rpc_stat
operator|=
name|CLNT_CALL
argument_list|(
name|client
argument_list|,
name|NULLPROC
argument_list|,
operator|(
name|xdrproc_t
operator|)
name|xdr_void
argument_list|,
operator|(
name|char
operator|*
operator|)
name|NULL
argument_list|,
operator|(
name|xdrproc_t
operator|)
name|xdr_void
argument_list|,
operator|(
name|char
operator|*
operator|)
name|NULL
argument_list|,
name|to
argument_list|)
expr_stmt|;
if|if
condition|(
name|argc
operator|==
literal|2
condition|)
block|{
comment|/* Version number was known */
if|if
condition|(
name|pstatus
argument_list|(
name|client
argument_list|,
name|prognum
argument_list|,
name|versnum
argument_list|)
operator|<
literal|0
condition|)
name|failure
operator|=
literal|1
expr_stmt|;
operator|(
name|void
operator|)
name|CLNT_DESTROY
argument_list|(
name|client
argument_list|)
expr_stmt|;
if|if
condition|(
name|failure
condition|)
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
return|return;
block|}
comment|/* Version number not known */
operator|(
name|void
operator|)
name|CLNT_CONTROL
argument_list|(
name|client
argument_list|,
name|CLSET_FD_NCLOSE
argument_list|,
operator|(
name|char
operator|*
operator|)
name|NULL
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|CLNT_CONTROL
argument_list|(
name|client
argument_list|,
name|CLGET_FD
argument_list|,
operator|(
name|char
operator|*
operator|)
operator|&
name|fd
argument_list|)
expr_stmt|;
if|if
condition|(
name|rpc_stat
operator|==
name|RPC_PROGVERSMISMATCH
condition|)
block|{
name|clnt_geterr
argument_list|(
name|client
argument_list|,
operator|&
name|rpcerr
argument_list|)
expr_stmt|;
name|minvers
operator|=
name|rpcerr
operator|.
name|re_vers
operator|.
name|low
expr_stmt|;
name|maxvers
operator|=
name|rpcerr
operator|.
name|re_vers
operator|.
name|high
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|rpc_stat
operator|==
name|RPC_SUCCESS
condition|)
block|{
comment|/* 		 * Oh dear, it DOES support version 0. 		 * Let's try version MAX_VERS. 		 */
operator|(
name|void
operator|)
name|CLNT_DESTROY
argument_list|(
name|client
argument_list|)
expr_stmt|;
name|client
operator|=
name|clnt_addr_create
argument_list|(
name|address
argument_list|,
name|nconf
argument_list|,
name|prognum
argument_list|,
name|MAX_VERS
argument_list|)
expr_stmt|;
name|rpc_stat
operator|=
name|CLNT_CALL
argument_list|(
name|client
argument_list|,
name|NULLPROC
argument_list|,
operator|(
name|xdrproc_t
operator|)
name|xdr_void
argument_list|,
operator|(
name|char
operator|*
operator|)
name|NULL
argument_list|,
operator|(
name|xdrproc_t
operator|)
name|xdr_void
argument_list|,
operator|(
name|char
operator|*
operator|)
name|NULL
argument_list|,
name|to
argument_list|)
expr_stmt|;
if|if
condition|(
name|rpc_stat
operator|==
name|RPC_PROGVERSMISMATCH
condition|)
block|{
name|clnt_geterr
argument_list|(
name|client
argument_list|,
operator|&
name|rpcerr
argument_list|)
expr_stmt|;
name|minvers
operator|=
name|rpcerr
operator|.
name|re_vers
operator|.
name|low
expr_stmt|;
name|maxvers
operator|=
name|rpcerr
operator|.
name|re_vers
operator|.
name|high
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|rpc_stat
operator|==
name|RPC_SUCCESS
condition|)
block|{
comment|/* 			 * It also supports version MAX_VERS. 			 * Looks like we have a wise guy. 			 * OK, we give them information on all 			 * 4 billion versions they support... 			 */
name|minvers
operator|=
literal|0
expr_stmt|;
name|maxvers
operator|=
name|MAX_VERS
expr_stmt|;
block|}
else|else
block|{
operator|(
name|void
operator|)
name|pstatus
argument_list|(
name|client
argument_list|,
name|prognum
argument_list|,
name|MAX_VERS
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
operator|(
name|void
operator|)
name|pstatus
argument_list|(
name|client
argument_list|,
name|prognum
argument_list|,
operator|(
name|u_long
operator|)
literal|0
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
operator|(
name|void
operator|)
name|CLNT_DESTROY
argument_list|(
name|client
argument_list|)
expr_stmt|;
for|for
control|(
name|versnum
operator|=
name|minvers
init|;
name|versnum
operator|<=
name|maxvers
condition|;
name|versnum
operator|++
control|)
block|{
name|client
operator|=
name|clnt_addr_create
argument_list|(
name|address
argument_list|,
name|nconf
argument_list|,
name|prognum
argument_list|,
name|versnum
argument_list|)
expr_stmt|;
name|rpc_stat
operator|=
name|CLNT_CALL
argument_list|(
name|client
argument_list|,
name|NULLPROC
argument_list|,
operator|(
name|xdrproc_t
operator|)
name|xdr_void
argument_list|,
operator|(
name|char
operator|*
operator|)
name|NULL
argument_list|,
operator|(
name|xdrproc_t
operator|)
name|xdr_void
argument_list|,
operator|(
name|char
operator|*
operator|)
name|NULL
argument_list|,
name|to
argument_list|)
expr_stmt|;
if|if
condition|(
name|pstatus
argument_list|(
name|client
argument_list|,
name|prognum
argument_list|,
name|versnum
argument_list|)
operator|<
literal|0
condition|)
name|failure
operator|=
literal|1
expr_stmt|;
operator|(
name|void
operator|)
name|CLNT_DESTROY
argument_list|(
name|client
argument_list|)
expr_stmt|;
block|}
operator|(
name|void
operator|)
name|close
argument_list|(
name|fd
argument_list|)
expr_stmt|;
if|if
condition|(
name|failure
condition|)
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
return|return;
block|}
comment|/*  * If the version number is given, ping that (prog, vers); else try to find  * the version numbers supported for that prog and ping all the versions.  * Remote rpcbind is *contacted* for this service. The requests are  * then sent directly to the services themselves.  */
specifier|static
name|void
name|progping
parameter_list|(
name|char
modifier|*
name|netid
parameter_list|,
name|int
name|argc
parameter_list|,
name|char
modifier|*
modifier|*
name|argv
parameter_list|)
block|{
name|CLIENT
modifier|*
name|client
decl_stmt|;
name|struct
name|timeval
name|to
decl_stmt|;
name|enum
name|clnt_stat
name|rpc_stat
decl_stmt|;
name|u_long
name|prognum
decl_stmt|,
name|versnum
decl_stmt|,
name|minvers
decl_stmt|,
name|maxvers
decl_stmt|;
name|struct
name|rpc_err
name|rpcerr
decl_stmt|;
name|int
name|failure
init|=
literal|0
decl_stmt|;
name|struct
name|netconfig
modifier|*
name|nconf
decl_stmt|;
if|if
condition|(
name|argc
operator|<
literal|2
operator|||
name|argc
operator|>
literal|3
operator|||
operator|(
name|netid
operator|==
name|NULL
operator|)
condition|)
block|{
name|usage
argument_list|()
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
name|prognum
operator|=
name|getprognum
argument_list|(
name|argv
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|argc
operator|==
literal|2
condition|)
block|{
comment|/* Version number not known */
comment|/* 		 * A call to version 0 should fail with a program/version 		 * mismatch, and give us the range of versions supported. 		 */
name|versnum
operator|=
name|MIN_VERS
expr_stmt|;
block|}
else|else
block|{
name|versnum
operator|=
name|getvers
argument_list|(
name|argv
index|[
literal|2
index|]
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|netid
condition|)
block|{
name|nconf
operator|=
name|getnetconfigent
argument_list|(
name|netid
argument_list|)
expr_stmt|;
if|if
condition|(
name|nconf
operator|==
operator|(
expr|struct
name|netconfig
operator|*
operator|)
name|NULL
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"rpcinfo: Could not find %s\n"
argument_list|,
name|netid
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
name|client
operator|=
name|clnt_tp_create
argument_list|(
name|argv
index|[
literal|0
index|]
argument_list|,
name|prognum
argument_list|,
name|versnum
argument_list|,
name|nconf
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|client
operator|=
name|clnt_create
argument_list|(
name|argv
index|[
literal|0
index|]
argument_list|,
name|prognum
argument_list|,
name|versnum
argument_list|,
literal|"NETPATH"
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|client
operator|==
operator|(
name|CLIENT
operator|*
operator|)
name|NULL
condition|)
block|{
name|clnt_pcreateerror
argument_list|(
literal|"rpcinfo"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
name|to
operator|.
name|tv_sec
operator|=
literal|10
expr_stmt|;
name|to
operator|.
name|tv_usec
operator|=
literal|0
expr_stmt|;
name|rpc_stat
operator|=
name|CLNT_CALL
argument_list|(
name|client
argument_list|,
name|NULLPROC
argument_list|,
operator|(
name|xdrproc_t
operator|)
name|xdr_void
argument_list|,
operator|(
name|char
operator|*
operator|)
name|NULL
argument_list|,
operator|(
name|xdrproc_t
operator|)
name|xdr_void
argument_list|,
operator|(
name|char
operator|*
operator|)
name|NULL
argument_list|,
name|to
argument_list|)
expr_stmt|;
if|if
condition|(
name|argc
operator|==
literal|3
condition|)
block|{
comment|/* Version number was known */
if|if
condition|(
name|pstatus
argument_list|(
name|client
argument_list|,
name|prognum
argument_list|,
name|versnum
argument_list|)
operator|<
literal|0
condition|)
name|failure
operator|=
literal|1
expr_stmt|;
operator|(
name|void
operator|)
name|CLNT_DESTROY
argument_list|(
name|client
argument_list|)
expr_stmt|;
if|if
condition|(
name|failure
condition|)
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
return|return;
block|}
comment|/* Version number not known */
if|if
condition|(
name|rpc_stat
operator|==
name|RPC_PROGVERSMISMATCH
condition|)
block|{
name|clnt_geterr
argument_list|(
name|client
argument_list|,
operator|&
name|rpcerr
argument_list|)
expr_stmt|;
name|minvers
operator|=
name|rpcerr
operator|.
name|re_vers
operator|.
name|low
expr_stmt|;
name|maxvers
operator|=
name|rpcerr
operator|.
name|re_vers
operator|.
name|high
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|rpc_stat
operator|==
name|RPC_SUCCESS
condition|)
block|{
comment|/* 		 * Oh dear, it DOES support version 0. 		 * Let's try version MAX_VERS. 		 */
name|versnum
operator|=
name|MAX_VERS
expr_stmt|;
operator|(
name|void
operator|)
name|CLNT_CONTROL
argument_list|(
name|client
argument_list|,
name|CLSET_VERS
argument_list|,
operator|(
name|char
operator|*
operator|)
operator|&
name|versnum
argument_list|)
expr_stmt|;
name|rpc_stat
operator|=
name|CLNT_CALL
argument_list|(
name|client
argument_list|,
name|NULLPROC
argument_list|,
operator|(
name|xdrproc_t
operator|)
name|xdr_void
argument_list|,
operator|(
name|char
operator|*
operator|)
name|NULL
argument_list|,
operator|(
name|xdrproc_t
operator|)
name|xdr_void
argument_list|,
operator|(
name|char
operator|*
operator|)
name|NULL
argument_list|,
name|to
argument_list|)
expr_stmt|;
if|if
condition|(
name|rpc_stat
operator|==
name|RPC_PROGVERSMISMATCH
condition|)
block|{
name|clnt_geterr
argument_list|(
name|client
argument_list|,
operator|&
name|rpcerr
argument_list|)
expr_stmt|;
name|minvers
operator|=
name|rpcerr
operator|.
name|re_vers
operator|.
name|low
expr_stmt|;
name|maxvers
operator|=
name|rpcerr
operator|.
name|re_vers
operator|.
name|high
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|rpc_stat
operator|==
name|RPC_SUCCESS
condition|)
block|{
comment|/* 			 * It also supports version MAX_VERS. 			 * Looks like we have a wise guy. 			 * OK, we give them information on all 			 * 4 billion versions they support... 			 */
name|minvers
operator|=
literal|0
expr_stmt|;
name|maxvers
operator|=
name|MAX_VERS
expr_stmt|;
block|}
else|else
block|{
operator|(
name|void
operator|)
name|pstatus
argument_list|(
name|client
argument_list|,
name|prognum
argument_list|,
name|MAX_VERS
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
operator|(
name|void
operator|)
name|pstatus
argument_list|(
name|client
argument_list|,
name|prognum
argument_list|,
operator|(
name|u_long
operator|)
literal|0
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
for|for
control|(
name|versnum
operator|=
name|minvers
init|;
name|versnum
operator|<=
name|maxvers
condition|;
name|versnum
operator|++
control|)
block|{
operator|(
name|void
operator|)
name|CLNT_CONTROL
argument_list|(
name|client
argument_list|,
name|CLSET_VERS
argument_list|,
operator|(
name|char
operator|*
operator|)
operator|&
name|versnum
argument_list|)
expr_stmt|;
name|rpc_stat
operator|=
name|CLNT_CALL
argument_list|(
name|client
argument_list|,
name|NULLPROC
argument_list|,
operator|(
name|xdrproc_t
operator|)
name|xdr_void
argument_list|,
operator|(
name|char
operator|*
operator|)
name|NULL
argument_list|,
operator|(
name|xdrproc_t
operator|)
name|xdr_void
argument_list|,
operator|(
name|char
operator|*
operator|)
name|NULL
argument_list|,
name|to
argument_list|)
expr_stmt|;
if|if
condition|(
name|pstatus
argument_list|(
name|client
argument_list|,
name|prognum
argument_list|,
name|versnum
argument_list|)
operator|<
literal|0
condition|)
name|failure
operator|=
literal|1
expr_stmt|;
block|}
operator|(
name|void
operator|)
name|CLNT_DESTROY
argument_list|(
name|client
argument_list|)
expr_stmt|;
if|if
condition|(
name|failure
condition|)
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
return|return;
block|}
specifier|static
name|void
name|usage
parameter_list|()
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Usage: rpcinfo [-m | -s] [host]\n"
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|PORTMAP
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"       rpcinfo -p [host]\n"
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"       rpcinfo -T netid host prognum [versnum]\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"       rpcinfo -l host prognum versnum\n"
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|PORTMAP
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"       rpcinfo [-n portnum] -u | -t host prognum [versnum]\n"
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"       rpcinfo -a serv_address -T netid prognum [version]\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"       rpcinfo -b prognum versnum\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"       rpcinfo -d [-T netid] prognum versnum\n"
argument_list|)
expr_stmt|;
block|}
specifier|static
name|u_long
name|getprognum
parameter_list|(
name|char
modifier|*
name|arg
parameter_list|)
block|{
name|char
modifier|*
name|strptr
decl_stmt|;
specifier|register
name|struct
name|rpcent
modifier|*
name|rpc
decl_stmt|;
specifier|register
name|u_long
name|prognum
decl_stmt|;
name|char
modifier|*
name|tptr
init|=
name|arg
decl_stmt|;
while|while
condition|(
operator|*
name|tptr
operator|&&
name|isdigit
argument_list|(
operator|*
name|tptr
operator|++
argument_list|)
condition|)
empty_stmt|;
if|if
condition|(
operator|*
name|tptr
operator|||
name|isalpha
argument_list|(
operator|*
operator|(
name|tptr
operator|-
literal|1
operator|)
argument_list|)
condition|)
block|{
name|rpc
operator|=
name|getrpcbyname
argument_list|(
name|arg
argument_list|)
expr_stmt|;
if|if
condition|(
name|rpc
operator|==
name|NULL
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"rpcinfo: %s is unknown service\n"
argument_list|,
name|arg
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
name|prognum
operator|=
name|rpc
operator|->
name|r_number
expr_stmt|;
block|}
else|else
block|{
name|prognum
operator|=
name|strtol
argument_list|(
name|arg
argument_list|,
operator|&
name|strptr
argument_list|,
literal|10
argument_list|)
expr_stmt|;
if|if
condition|(
name|strptr
operator|==
name|arg
operator|||
operator|*
name|strptr
operator|!=
literal|'\0'
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"rpcinfo: %s is illegal program number\n"
argument_list|,
name|arg
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
block|}
return|return
operator|(
name|prognum
operator|)
return|;
block|}
specifier|static
name|u_long
name|getvers
parameter_list|(
name|char
modifier|*
name|arg
parameter_list|)
block|{
name|char
modifier|*
name|strptr
decl_stmt|;
specifier|register
name|u_long
name|vers
decl_stmt|;
name|vers
operator|=
operator|(
name|int
operator|)
name|strtol
argument_list|(
name|arg
argument_list|,
operator|&
name|strptr
argument_list|,
literal|10
argument_list|)
expr_stmt|;
if|if
condition|(
name|strptr
operator|==
name|arg
operator|||
operator|*
name|strptr
operator|!=
literal|'\0'
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"rpcinfo: %s is illegal version number\n"
argument_list|,
name|arg
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
return|return
operator|(
name|vers
operator|)
return|;
block|}
comment|/*  * This routine should take a pointer to an "rpc_err" structure, rather than  * a pointer to a CLIENT structure, but "clnt_perror" takes a pointer to  * a CLIENT structure rather than a pointer to an "rpc_err" structure.  * As such, we have to keep the CLIENT structure around in order to print  * a good error message.  */
specifier|static
name|int
name|pstatus
parameter_list|(
specifier|register
name|CLIENT
modifier|*
name|client
parameter_list|,
name|u_long
name|prog
parameter_list|,
name|u_long
name|vers
parameter_list|)
block|{
name|struct
name|rpc_err
name|rpcerr
decl_stmt|;
name|clnt_geterr
argument_list|(
name|client
argument_list|,
operator|&
name|rpcerr
argument_list|)
expr_stmt|;
if|if
condition|(
name|rpcerr
operator|.
name|re_status
operator|!=
name|RPC_SUCCESS
condition|)
block|{
name|clnt_perror
argument_list|(
name|client
argument_list|,
literal|"rpcinfo"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"program %lu version %lu is not available\n"
argument_list|,
name|prog
argument_list|,
name|vers
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
else|else
block|{
name|printf
argument_list|(
literal|"program %lu version %lu ready and waiting\n"
argument_list|,
name|prog
argument_list|,
name|vers
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
block|}
specifier|static
name|CLIENT
modifier|*
name|clnt_rpcbind_create
parameter_list|(
name|char
modifier|*
name|host
parameter_list|,
name|int
name|rpcbversnum
parameter_list|,
name|struct
name|netbuf
modifier|*
modifier|*
name|targaddr
parameter_list|)
block|{
specifier|static
name|char
modifier|*
name|tlist
index|[
literal|3
index|]
init|=
block|{
literal|"circuit_n"
block|,
literal|"circuit_v"
block|,
literal|"datagram_v"
block|}
decl_stmt|;
name|int
name|i
decl_stmt|;
name|struct
name|netconfig
modifier|*
name|nconf
decl_stmt|;
name|CLIENT
modifier|*
name|clnt
init|=
name|NULL
decl_stmt|;
name|void
modifier|*
name|handle
decl_stmt|;
name|rpc_createerr
operator|.
name|cf_stat
operator|=
name|RPC_SUCCESS
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|3
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
operator|(
name|handle
operator|=
name|__rpc_setconf
argument_list|(
name|tlist
index|[
name|i
index|]
argument_list|)
operator|)
operator|==
name|NULL
condition|)
continue|continue;
while|while
condition|(
name|clnt
operator|==
operator|(
name|CLIENT
operator|*
operator|)
name|NULL
condition|)
block|{
if|if
condition|(
operator|(
name|nconf
operator|=
name|__rpc_getconf
argument_list|(
name|handle
argument_list|)
operator|)
operator|==
name|NULL
condition|)
block|{
if|if
condition|(
name|rpc_createerr
operator|.
name|cf_stat
operator|==
name|RPC_SUCCESS
condition|)
name|rpc_createerr
operator|.
name|cf_stat
operator|=
name|RPC_UNKNOWNPROTO
expr_stmt|;
break|break;
block|}
name|clnt
operator|=
name|getclnthandle
argument_list|(
name|host
argument_list|,
name|nconf
argument_list|,
name|rpcbversnum
argument_list|,
name|targaddr
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|clnt
condition|)
break|break;
name|__rpc_endconf
argument_list|(
name|handle
argument_list|)
expr_stmt|;
block|}
return|return
operator|(
name|clnt
operator|)
return|;
block|}
specifier|static
name|CLIENT
modifier|*
name|getclnthandle
parameter_list|(
name|char
modifier|*
name|host
parameter_list|,
name|struct
name|netconfig
modifier|*
name|nconf
parameter_list|,
name|u_long
name|rpcbversnum
parameter_list|,
name|struct
name|netbuf
modifier|*
modifier|*
name|targaddr
parameter_list|)
block|{
name|struct
name|netbuf
name|addr
decl_stmt|;
name|struct
name|addrinfo
name|hints
decl_stmt|,
modifier|*
name|res
decl_stmt|;
name|CLIENT
modifier|*
name|client
init|=
name|NULL
decl_stmt|;
comment|/* Get the address of the rpcbind */
name|memset
argument_list|(
operator|&
name|hints
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
name|hints
argument_list|)
expr_stmt|;
if|if
condition|(
name|getaddrinfo
argument_list|(
name|host
argument_list|,
literal|"rpcbind"
argument_list|,
operator|&
name|hints
argument_list|,
operator|&
name|res
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|rpc_createerr
operator|.
name|cf_stat
operator|=
name|RPC_N2AXLATEFAILURE
expr_stmt|;
return|return
operator|(
name|NULL
operator|)
return|;
block|}
name|addr
operator|.
name|len
operator|=
name|addr
operator|.
name|maxlen
operator|=
name|res
operator|->
name|ai_addrlen
expr_stmt|;
name|addr
operator|.
name|buf
operator|=
name|res
operator|->
name|ai_addr
expr_stmt|;
name|client
operator|=
name|clnt_tli_create
argument_list|(
name|RPC_ANYFD
argument_list|,
name|nconf
argument_list|,
operator|&
name|addr
argument_list|,
name|RPCBPROG
argument_list|,
name|rpcbversnum
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|client
condition|)
block|{
if|if
condition|(
name|targaddr
operator|!=
name|NULL
condition|)
block|{
operator|*
name|targaddr
operator|=
operator|(
expr|struct
name|netbuf
operator|*
operator|)
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
expr|struct
name|netbuf
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|*
name|targaddr
operator|!=
name|NULL
condition|)
block|{
operator|(
operator|*
name|targaddr
operator|)
operator|->
name|maxlen
operator|=
name|addr
operator|.
name|maxlen
expr_stmt|;
operator|(
operator|*
name|targaddr
operator|)
operator|->
name|len
operator|=
name|addr
operator|.
name|len
expr_stmt|;
operator|(
operator|*
name|targaddr
operator|)
operator|->
name|buf
operator|=
operator|(
name|char
operator|*
operator|)
name|malloc
argument_list|(
name|addr
operator|.
name|len
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
operator|*
name|targaddr
operator|)
operator|->
name|buf
operator|!=
name|NULL
condition|)
block|{
name|memcpy
argument_list|(
operator|(
operator|*
name|targaddr
operator|)
operator|->
name|buf
argument_list|,
name|addr
operator|.
name|buf
argument_list|,
name|addr
operator|.
name|len
argument_list|)
expr_stmt|;
block|}
block|}
block|}
block|}
else|else
block|{
if|if
condition|(
name|rpc_createerr
operator|.
name|cf_stat
operator|==
name|RPC_TLIERROR
condition|)
block|{
comment|/* 			 * Assume that the other system is dead; this is a 			 * better error to display to the user. 			 */
name|rpc_createerr
operator|.
name|cf_stat
operator|=
name|RPC_RPCBFAILURE
expr_stmt|;
name|rpc_createerr
operator|.
name|cf_error
operator|.
name|re_status
operator|=
name|RPC_FAILED
expr_stmt|;
block|}
block|}
name|freeaddrinfo
argument_list|(
name|res
argument_list|)
expr_stmt|;
return|return
operator|(
name|client
operator|)
return|;
block|}
specifier|static
name|void
name|print_rmtcallstat
parameter_list|(
name|int
name|rtype
parameter_list|,
name|rpcb_stat
modifier|*
name|infp
parameter_list|)
block|{
specifier|register
name|rpcbs_rmtcalllist_ptr
name|pr
decl_stmt|;
name|struct
name|rpcent
modifier|*
name|rpc
decl_stmt|;
if|if
condition|(
name|rtype
operator|==
name|RPCBVERS_4_STAT
condition|)
name|printf
argument_list|(
literal|"prog\t\tvers\tproc\tnetid\tindirect success failure\n"
argument_list|)
expr_stmt|;
else|else
name|printf
argument_list|(
literal|"prog\t\tvers\tproc\tnetid\tsuccess\tfailure\n"
argument_list|)
expr_stmt|;
for|for
control|(
name|pr
operator|=
name|infp
operator|->
name|rmtinfo
init|;
name|pr
condition|;
name|pr
operator|=
name|pr
operator|->
name|next
control|)
block|{
name|rpc
operator|=
name|getrpcbynumber
argument_list|(
name|pr
operator|->
name|prog
argument_list|)
expr_stmt|;
if|if
condition|(
name|rpc
condition|)
name|printf
argument_list|(
literal|"%-16s"
argument_list|,
name|rpc
operator|->
name|r_name
argument_list|)
expr_stmt|;
else|else
name|printf
argument_list|(
literal|"%-16d"
argument_list|,
name|pr
operator|->
name|prog
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"%d\t%d\t%s\t"
argument_list|,
name|pr
operator|->
name|vers
argument_list|,
name|pr
operator|->
name|proc
argument_list|,
name|pr
operator|->
name|netid
argument_list|)
expr_stmt|;
if|if
condition|(
name|rtype
operator|==
name|RPCBVERS_4_STAT
condition|)
name|printf
argument_list|(
literal|"%d\t "
argument_list|,
name|pr
operator|->
name|indirect
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"%d\t%d\n"
argument_list|,
name|pr
operator|->
name|success
argument_list|,
name|pr
operator|->
name|failure
argument_list|)
expr_stmt|;
block|}
block|}
specifier|static
name|void
name|print_getaddrstat
parameter_list|(
name|int
name|rtype
parameter_list|,
name|rpcb_stat
modifier|*
name|infp
parameter_list|)
block|{
name|rpcbs_addrlist_ptr
name|al
decl_stmt|;
specifier|register
name|struct
name|rpcent
modifier|*
name|rpc
decl_stmt|;
name|printf
argument_list|(
literal|"prog\t\tvers\tnetid\t  success\tfailure\n"
argument_list|)
expr_stmt|;
for|for
control|(
name|al
operator|=
name|infp
operator|->
name|addrinfo
init|;
name|al
condition|;
name|al
operator|=
name|al
operator|->
name|next
control|)
block|{
name|rpc
operator|=
name|getrpcbynumber
argument_list|(
name|al
operator|->
name|prog
argument_list|)
expr_stmt|;
if|if
condition|(
name|rpc
condition|)
name|printf
argument_list|(
literal|"%-16s"
argument_list|,
name|rpc
operator|->
name|r_name
argument_list|)
expr_stmt|;
else|else
name|printf
argument_list|(
literal|"%-16d"
argument_list|,
name|al
operator|->
name|prog
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"%d\t%s\t  %-12d\t%d\n"
argument_list|,
name|al
operator|->
name|vers
argument_list|,
name|al
operator|->
name|netid
argument_list|,
name|al
operator|->
name|success
argument_list|,
name|al
operator|->
name|failure
argument_list|)
expr_stmt|;
block|}
block|}
specifier|static
name|char
modifier|*
name|spaces
parameter_list|(
name|int
name|howmany
parameter_list|)
block|{
specifier|static
name|char
name|space_array
index|[]
init|=
comment|/* 64 spaces */
literal|"                                                                "
decl_stmt|;
if|if
condition|(
name|howmany
operator|<=
literal|0
operator|||
name|howmany
operator|>
sizeof|sizeof
argument_list|(
name|space_array
argument_list|)
condition|)
block|{
return|return
operator|(
literal|""
operator|)
return|;
block|}
return|return
operator|(
operator|&
name|space_array
index|[
sizeof|sizeof
argument_list|(
name|space_array
argument_list|)
operator|-
name|howmany
operator|-
literal|1
index|]
operator|)
return|;
block|}
end_function

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/* Portions taken from the skey distribution on Oct 21 1993 */
end_comment

begin_ifdef
ifdef|#
directive|ifdef
name|SKEY
end_ifdef

begin_include
include|#
directive|include
file|<sys/types.h>
end_include

begin_include
include|#
directive|include
file|<netinet/in.h>
end_include

begin_include
include|#
directive|include
file|<string.h>
end_include

begin_include
include|#
directive|include
file|<netdb.h>
end_include

begin_include
include|#
directive|include
file|<arpa/inet.h>
end_include

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_include
include|#
directive|include
file|<termios.h>
end_include

begin_include
include|#
directive|include
file|<pwd.h>
end_include

begin_include
include|#
directive|include
file|<syslog.h>
end_include

begin_include
include|#
directive|include
file|<skey.h>
end_include

begin_comment
comment|/* skey_getpass - read regular or s/key password */
end_comment

begin_function
name|char
modifier|*
name|skey_getpass
parameter_list|(
name|prompt
parameter_list|,
name|pwd
parameter_list|,
name|pwok
parameter_list|)
name|char
modifier|*
name|prompt
decl_stmt|;
name|struct
name|passwd
modifier|*
name|pwd
decl_stmt|;
name|int
name|pwok
decl_stmt|;
block|{
specifier|static
name|char
name|buf
index|[
literal|128
index|]
decl_stmt|;
name|struct
name|skey
name|skey
decl_stmt|;
name|char
modifier|*
name|cp
decl_stmt|;
name|void
name|rip
parameter_list|()
function_decl|;
name|struct
name|termios
name|saved_ttymode
decl_stmt|;
name|struct
name|termios
name|noecho_ttymode
decl_stmt|;
name|char
modifier|*
name|username
init|=
name|pwd
condition|?
name|pwd
operator|->
name|pw_name
else|:
literal|"nope"
decl_stmt|;
name|int
name|sflag
decl_stmt|;
comment|/* Attempt an s/key challenge. */
if|if
condition|(
operator|(
name|sflag
operator|=
name|skeychallenge
argument_list|(
operator|&
name|skey
argument_list|,
name|username
argument_list|,
name|buf
argument_list|)
operator|)
operator|==
literal|0
condition|)
block|{
name|printf
argument_list|(
literal|"%s\n"
argument_list|,
name|buf
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|pwok
condition|)
block|{
name|printf
argument_list|(
literal|"(s/key required)\n"
argument_list|)
expr_stmt|;
block|}
name|fputs
argument_list|(
name|prompt
argument_list|,
name|stdout
argument_list|)
expr_stmt|;
name|fflush
argument_list|(
name|stdout
argument_list|)
expr_stmt|;
comment|/* Save current input modes and turn echo off. */
name|tcgetattr
argument_list|(
literal|0
argument_list|,
operator|&
name|saved_ttymode
argument_list|)
expr_stmt|;
name|tcgetattr
argument_list|(
literal|0
argument_list|,
operator|&
name|noecho_ttymode
argument_list|)
expr_stmt|;
name|noecho_ttymode
operator|.
name|c_lflag
operator|&=
operator|~
name|ECHO
expr_stmt|;
name|tcsetattr
argument_list|(
literal|0
argument_list|,
name|TCSANOW
argument_list|,
operator|&
name|noecho_ttymode
argument_list|)
expr_stmt|;
comment|/* Read password. */
name|buf
index|[
literal|0
index|]
operator|=
literal|0
expr_stmt|;
name|fgets
argument_list|(
name|buf
argument_list|,
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
argument_list|,
name|stdin
argument_list|)
expr_stmt|;
name|rip
argument_list|(
name|buf
argument_list|)
expr_stmt|;
comment|/* Restore previous input modes. */
name|tcsetattr
argument_list|(
literal|0
argument_list|,
name|TCSANOW
argument_list|,
operator|&
name|saved_ttymode
argument_list|)
expr_stmt|;
comment|/* Give S/Key users a chance to do it with echo on. */
if|if
condition|(
name|sflag
operator|==
literal|0
operator|&&
name|feof
argument_list|(
name|stdin
argument_list|)
operator|==
literal|0
operator|&&
name|buf
index|[
literal|0
index|]
operator|==
literal|0
condition|)
block|{
name|fputs
argument_list|(
literal|" (turning echo on)\n"
argument_list|,
name|stdout
argument_list|)
expr_stmt|;
name|fputs
argument_list|(
name|prompt
argument_list|,
name|stdout
argument_list|)
expr_stmt|;
name|fflush
argument_list|(
name|stdout
argument_list|)
expr_stmt|;
name|fgets
argument_list|(
name|buf
argument_list|,
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
argument_list|,
name|stdin
argument_list|)
expr_stmt|;
name|rip
argument_list|(
name|buf
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|putchar
argument_list|(
literal|'\n'
argument_list|)
expr_stmt|;
block|}
return|return
operator|(
name|buf
operator|)
return|;
block|}
end_function

begin_comment
comment|/* skey_crypt - return encrypted UNIX passwd if s/key or regular password ok */
end_comment

begin_function
name|char
modifier|*
name|skey_crypt
parameter_list|(
name|pp
parameter_list|,
name|salt
parameter_list|,
name|pwd
parameter_list|,
name|pwok
parameter_list|)
name|char
modifier|*
name|pp
decl_stmt|;
name|char
modifier|*
name|salt
decl_stmt|;
name|struct
name|passwd
modifier|*
name|pwd
decl_stmt|;
name|int
name|pwok
decl_stmt|;
block|{
name|struct
name|skey
name|skey
decl_stmt|;
name|char
modifier|*
name|p
decl_stmt|;
name|char
modifier|*
name|crypt
parameter_list|()
function_decl|;
comment|/* Try s/key authentication even when the UNIX password is permitted. */
if|if
condition|(
name|pwd
operator|!=
literal|0
operator|&&
name|skeylookup
argument_list|(
operator|&
name|skey
argument_list|,
name|pwd
operator|->
name|pw_name
argument_list|)
operator|==
literal|0
operator|&&
name|skeyverify
argument_list|(
operator|&
name|skey
argument_list|,
name|pp
argument_list|)
operator|==
literal|0
condition|)
block|{
comment|/* s/key authentication succeeded */
if|if
condition|(
name|skey
operator|.
name|n
operator|<
literal|5
condition|)
name|printf
argument_list|(
literal|"Warning! Change s/key password soon\n"
argument_list|)
expr_stmt|;
return|return
operator|(
name|pwd
operator|->
name|pw_passwd
operator|)
return|;
block|}
comment|/* When s/key authentication does not work, always invoke crypt(). */
name|p
operator|=
name|crypt
argument_list|(
name|pp
argument_list|,
name|salt
argument_list|)
expr_stmt|;
if|if
condition|(
name|pwok
operator|&&
name|pwd
operator|!=
literal|0
operator|&&
name|strcmp
argument_list|(
name|p
argument_list|,
name|pwd
operator|->
name|pw_passwd
argument_list|)
operator|==
literal|0
condition|)
return|return
operator|(
name|pwd
operator|->
name|pw_passwd
operator|)
return|;
comment|/* The user does not exist or entered bad input. */
return|return
operator|(
literal|":"
operator|)
return|;
block|}
end_function

begin_endif
endif|#
directive|endif
endif|SKEY
end_endif

end_unit


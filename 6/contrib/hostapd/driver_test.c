begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Host AP (software wireless LAN access point) user space daemon for  * Host AP kernel driver / Driver interface for development testing  * Copyright (c) 2004-2005, Jouni Malinen<jkmaline@cc.hut.fi>  *  * This program is free software; you can redistribute it and/or modify  * it under the terms of the GNU General Public License version 2 as  * published by the Free Software Foundation.  *  * Alternatively, this software may be distributed under the terms of BSD  * license.  *  * See README and COPYING for more details.  */
end_comment

begin_include
include|#
directive|include
file|<stdlib.h>
end_include

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_include
include|#
directive|include
file|<string.h>
end_include

begin_include
include|#
directive|include
file|<unistd.h>
end_include

begin_include
include|#
directive|include
file|<errno.h>
end_include

begin_include
include|#
directive|include
file|<sys/ioctl.h>
end_include

begin_include
include|#
directive|include
file|<netinet/in.h>
end_include

begin_include
include|#
directive|include
file|<signal.h>
end_include

begin_include
include|#
directive|include
file|<sys/types.h>
end_include

begin_include
include|#
directive|include
file|<sys/socket.h>
end_include

begin_include
include|#
directive|include
file|<sys/un.h>
end_include

begin_include
include|#
directive|include
file|<sys/uio.h>
end_include

begin_include
include|#
directive|include
file|"hostapd.h"
end_include

begin_include
include|#
directive|include
file|"driver.h"
end_include

begin_include
include|#
directive|include
file|"sha1.h"
end_include

begin_include
include|#
directive|include
file|"eloop.h"
end_include

begin_include
include|#
directive|include
file|"ieee802_1x.h"
end_include

begin_include
include|#
directive|include
file|"sta_info.h"
end_include

begin_include
include|#
directive|include
file|"eapol_sm.h"
end_include

begin_include
include|#
directive|include
file|"wpa.h"
end_include

begin_include
include|#
directive|include
file|"accounting.h"
end_include

begin_include
include|#
directive|include
file|"radius.h"
end_include

begin_include
include|#
directive|include
file|"l2_packet.h"
end_include

begin_include
include|#
directive|include
file|"hostap_common.h"
end_include

begin_struct
struct|struct
name|test_client_socket
block|{
name|struct
name|test_client_socket
modifier|*
name|next
decl_stmt|;
name|u8
name|addr
index|[
name|ETH_ALEN
index|]
decl_stmt|;
name|struct
name|sockaddr_un
name|un
decl_stmt|;
name|socklen_t
name|unlen
decl_stmt|;
block|}
struct|;
end_struct

begin_struct
struct|struct
name|test_driver_data
block|{
name|struct
name|driver_ops
name|ops
decl_stmt|;
name|struct
name|hostapd_data
modifier|*
name|hapd
decl_stmt|;
name|struct
name|test_client_socket
modifier|*
name|cli
decl_stmt|;
name|int
name|test_socket
decl_stmt|;
name|u8
modifier|*
name|ie
decl_stmt|;
name|size_t
name|ielen
decl_stmt|;
block|}
struct|;
end_struct

begin_decl_stmt
specifier|static
specifier|const
name|struct
name|driver_ops
name|test_driver_ops
decl_stmt|;
end_decl_stmt

begin_function
specifier|static
name|struct
name|test_client_socket
modifier|*
name|test_driver_get_cli
parameter_list|(
name|struct
name|test_driver_data
modifier|*
name|drv
parameter_list|,
name|struct
name|sockaddr_un
modifier|*
name|from
parameter_list|,
name|socklen_t
name|fromlen
parameter_list|)
block|{
name|struct
name|test_client_socket
modifier|*
name|cli
init|=
name|drv
operator|->
name|cli
decl_stmt|;
while|while
condition|(
name|cli
condition|)
block|{
if|if
condition|(
name|cli
operator|->
name|unlen
operator|==
name|fromlen
operator|&&
name|strncmp
argument_list|(
name|cli
operator|->
name|un
operator|.
name|sun_path
argument_list|,
name|from
operator|->
name|sun_path
argument_list|,
name|fromlen
argument_list|)
operator|==
literal|0
condition|)
return|return
name|cli
return|;
name|cli
operator|=
name|cli
operator|->
name|next
expr_stmt|;
block|}
return|return
name|NULL
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|test_driver_send_eapol
parameter_list|(
name|void
modifier|*
name|priv
parameter_list|,
name|u8
modifier|*
name|addr
parameter_list|,
name|u8
modifier|*
name|data
parameter_list|,
name|size_t
name|data_len
parameter_list|,
name|int
name|encrypt
parameter_list|)
block|{
name|struct
name|test_driver_data
modifier|*
name|drv
init|=
name|priv
decl_stmt|;
name|struct
name|test_client_socket
modifier|*
name|cli
decl_stmt|;
name|struct
name|msghdr
name|msg
decl_stmt|;
name|struct
name|iovec
name|io
index|[
literal|3
index|]
decl_stmt|;
name|struct
name|l2_ethhdr
name|eth
decl_stmt|;
if|if
condition|(
name|drv
operator|->
name|test_socket
operator|<
literal|0
condition|)
return|return
operator|-
literal|1
return|;
name|cli
operator|=
name|drv
operator|->
name|cli
expr_stmt|;
while|while
condition|(
name|cli
condition|)
block|{
if|if
condition|(
name|memcmp
argument_list|(
name|cli
operator|->
name|addr
argument_list|,
name|addr
argument_list|,
name|ETH_ALEN
argument_list|)
operator|==
literal|0
condition|)
break|break;
name|cli
operator|=
name|cli
operator|->
name|next
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|cli
condition|)
return|return
operator|-
literal|1
return|;
name|memcpy
argument_list|(
name|eth
operator|.
name|h_dest
argument_list|,
name|addr
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
name|eth
operator|.
name|h_source
argument_list|,
name|drv
operator|->
name|hapd
operator|->
name|own_addr
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
name|eth
operator|.
name|h_proto
operator|=
name|htons
argument_list|(
name|ETH_P_EAPOL
argument_list|)
expr_stmt|;
name|io
index|[
literal|0
index|]
operator|.
name|iov_base
operator|=
literal|"EAPOL "
expr_stmt|;
name|io
index|[
literal|0
index|]
operator|.
name|iov_len
operator|=
literal|6
expr_stmt|;
name|io
index|[
literal|1
index|]
operator|.
name|iov_base
operator|=
operator|&
name|eth
expr_stmt|;
name|io
index|[
literal|1
index|]
operator|.
name|iov_len
operator|=
sizeof|sizeof
argument_list|(
name|eth
argument_list|)
expr_stmt|;
name|io
index|[
literal|2
index|]
operator|.
name|iov_base
operator|=
name|data
expr_stmt|;
name|io
index|[
literal|2
index|]
operator|.
name|iov_len
operator|=
name|data_len
expr_stmt|;
name|memset
argument_list|(
operator|&
name|msg
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|msg
argument_list|)
argument_list|)
expr_stmt|;
name|msg
operator|.
name|msg_iov
operator|=
name|io
expr_stmt|;
name|msg
operator|.
name|msg_iovlen
operator|=
literal|3
expr_stmt|;
name|msg
operator|.
name|msg_name
operator|=
operator|&
name|cli
operator|->
name|un
expr_stmt|;
name|msg
operator|.
name|msg_namelen
operator|=
name|cli
operator|->
name|unlen
expr_stmt|;
return|return
name|sendmsg
argument_list|(
name|drv
operator|->
name|test_socket
argument_list|,
operator|&
name|msg
argument_list|,
literal|0
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|test_driver_scan
parameter_list|(
name|struct
name|test_driver_data
modifier|*
name|drv
parameter_list|,
name|struct
name|sockaddr_un
modifier|*
name|from
parameter_list|,
name|socklen_t
name|fromlen
parameter_list|)
block|{
name|char
name|buf
index|[
literal|512
index|]
decl_stmt|,
modifier|*
name|pos
decl_stmt|,
modifier|*
name|end
decl_stmt|;
name|int
name|i
decl_stmt|;
name|pos
operator|=
name|buf
expr_stmt|;
name|end
operator|=
name|buf
operator|+
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"test_driver: SCAN"
argument_list|)
expr_stmt|;
comment|/* reply: SCANRESP BSSID SSID IEs */
name|pos
operator|+=
name|snprintf
argument_list|(
name|pos
argument_list|,
name|end
operator|-
name|pos
argument_list|,
literal|"SCANRESP "
name|MACSTR
literal|" "
argument_list|,
name|MAC2STR
argument_list|(
name|drv
operator|->
name|hapd
operator|->
name|own_addr
argument_list|)
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|drv
operator|->
name|hapd
operator|->
name|conf
operator|->
name|ssid_len
condition|;
name|i
operator|++
control|)
block|{
name|pos
operator|+=
name|snprintf
argument_list|(
name|pos
argument_list|,
name|end
operator|-
name|pos
argument_list|,
literal|"%02x"
argument_list|,
name|drv
operator|->
name|hapd
operator|->
name|conf
operator|->
name|ssid
index|[
name|i
index|]
argument_list|)
expr_stmt|;
block|}
name|pos
operator|+=
name|snprintf
argument_list|(
name|pos
argument_list|,
name|end
operator|-
name|pos
argument_list|,
literal|" "
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|drv
operator|->
name|ielen
condition|;
name|i
operator|++
control|)
block|{
name|pos
operator|+=
name|snprintf
argument_list|(
name|pos
argument_list|,
name|end
operator|-
name|pos
argument_list|,
literal|"%02x"
argument_list|,
name|drv
operator|->
name|ie
index|[
name|i
index|]
argument_list|)
expr_stmt|;
block|}
name|sendto
argument_list|(
name|drv
operator|->
name|test_socket
argument_list|,
name|buf
argument_list|,
name|pos
operator|-
name|buf
argument_list|,
literal|0
argument_list|,
operator|(
expr|struct
name|sockaddr
operator|*
operator|)
name|from
argument_list|,
name|fromlen
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|test_driver_new_sta
parameter_list|(
name|struct
name|test_driver_data
modifier|*
name|drv
parameter_list|,
specifier|const
name|u8
modifier|*
name|addr
parameter_list|,
specifier|const
name|u8
modifier|*
name|ie
parameter_list|,
name|size_t
name|ielen
parameter_list|)
block|{
name|struct
name|hostapd_data
modifier|*
name|hapd
init|=
name|drv
operator|->
name|hapd
decl_stmt|;
name|struct
name|sta_info
modifier|*
name|sta
decl_stmt|;
name|int
name|new_assoc
decl_stmt|,
name|res
decl_stmt|;
name|hostapd_logger
argument_list|(
name|hapd
argument_list|,
name|addr
argument_list|,
name|HOSTAPD_MODULE_IEEE80211
argument_list|,
name|HOSTAPD_LEVEL_INFO
argument_list|,
literal|"associated"
argument_list|)
expr_stmt|;
name|sta
operator|=
name|ap_get_sta
argument_list|(
name|hapd
argument_list|,
name|addr
argument_list|)
expr_stmt|;
if|if
condition|(
name|sta
condition|)
block|{
name|accounting_sta_stop
argument_list|(
name|hapd
argument_list|,
name|sta
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|sta
operator|=
name|ap_sta_add
argument_list|(
name|hapd
argument_list|,
name|addr
argument_list|)
expr_stmt|;
if|if
condition|(
name|sta
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
block|}
name|accounting_sta_get_id
argument_list|(
name|hapd
argument_list|,
name|sta
argument_list|)
expr_stmt|;
if|if
condition|(
name|hapd
operator|->
name|conf
operator|->
name|wpa
condition|)
block|{
if|if
condition|(
name|ie
operator|==
name|NULL
operator|||
name|ielen
operator|==
literal|0
condition|)
block|{
name|printf
argument_list|(
literal|"test_driver: no IE from STA\n"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|res
operator|=
name|wpa_validate_wpa_ie
argument_list|(
name|hapd
argument_list|,
name|sta
argument_list|,
name|ie
argument_list|,
name|ielen
argument_list|,
name|ie
index|[
literal|0
index|]
operator|==
name|WLAN_EID_RSN
condition|?
name|HOSTAPD_WPA_VERSION_WPA2
else|:
name|HOSTAPD_WPA_VERSION_WPA
argument_list|)
expr_stmt|;
if|if
condition|(
name|res
operator|!=
name|WPA_IE_OK
condition|)
block|{
name|printf
argument_list|(
literal|"WPA/RSN information element rejected? "
literal|"(res %u)\n"
argument_list|,
name|res
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|free
argument_list|(
name|sta
operator|->
name|wpa_ie
argument_list|)
expr_stmt|;
name|sta
operator|->
name|wpa_ie
operator|=
name|malloc
argument_list|(
name|ielen
argument_list|)
expr_stmt|;
if|if
condition|(
name|sta
operator|->
name|wpa_ie
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
name|memcpy
argument_list|(
name|sta
operator|->
name|wpa_ie
argument_list|,
name|ie
argument_list|,
name|ielen
argument_list|)
expr_stmt|;
name|sta
operator|->
name|wpa_ie_len
operator|=
name|ielen
expr_stmt|;
block|}
else|else
block|{
name|free
argument_list|(
name|sta
operator|->
name|wpa_ie
argument_list|)
expr_stmt|;
name|sta
operator|->
name|wpa_ie
operator|=
name|NULL
expr_stmt|;
name|sta
operator|->
name|wpa_ie_len
operator|=
literal|0
expr_stmt|;
block|}
name|new_assoc
operator|=
operator|(
name|sta
operator|->
name|flags
operator|&
name|WLAN_STA_ASSOC
operator|)
operator|==
literal|0
expr_stmt|;
name|sta
operator|->
name|flags
operator||=
name|WLAN_STA_ASSOC
expr_stmt|;
name|wpa_sm_event
argument_list|(
name|hapd
argument_list|,
name|sta
argument_list|,
name|WPA_ASSOC
argument_list|)
expr_stmt|;
name|hostapd_new_assoc_sta
argument_list|(
name|hapd
argument_list|,
name|sta
argument_list|,
operator|!
name|new_assoc
argument_list|)
expr_stmt|;
name|ieee802_1x_notify_port_enabled
argument_list|(
name|sta
operator|->
name|eapol_sm
argument_list|,
literal|1
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|test_driver_assoc
parameter_list|(
name|struct
name|test_driver_data
modifier|*
name|drv
parameter_list|,
name|struct
name|sockaddr_un
modifier|*
name|from
parameter_list|,
name|socklen_t
name|fromlen
parameter_list|,
name|char
modifier|*
name|data
parameter_list|)
block|{
name|struct
name|test_client_socket
modifier|*
name|cli
decl_stmt|;
name|u8
name|ie
index|[
literal|256
index|]
decl_stmt|;
name|size_t
name|ielen
decl_stmt|;
name|char
modifier|*
name|pos
decl_stmt|,
modifier|*
name|pos2
decl_stmt|,
name|cmd
index|[
literal|50
index|]
decl_stmt|;
comment|/* data: STA-addr SSID(hex) IEs(hex) */
name|cli
operator|=
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|cli
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|cli
operator|==
name|NULL
condition|)
return|return;
name|memset
argument_list|(
name|cli
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|cli
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|hwaddr_aton
argument_list|(
name|data
argument_list|,
name|cli
operator|->
name|addr
argument_list|)
condition|)
block|{
name|printf
argument_list|(
literal|"test_socket: Invalid MAC address '%s' in ASSOC\n"
argument_list|,
name|data
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|cli
argument_list|)
expr_stmt|;
return|return;
block|}
name|pos
operator|=
name|data
operator|+
literal|17
expr_stmt|;
while|while
condition|(
operator|*
name|pos
operator|==
literal|' '
condition|)
name|pos
operator|++
expr_stmt|;
name|pos2
operator|=
name|strchr
argument_list|(
name|pos
argument_list|,
literal|' '
argument_list|)
expr_stmt|;
name|ielen
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|pos2
condition|)
block|{
comment|/* TODO: verify SSID */
name|pos
operator|=
name|pos2
operator|+
literal|1
expr_stmt|;
name|ielen
operator|=
name|strlen
argument_list|(
name|pos
argument_list|)
operator|/
literal|2
expr_stmt|;
if|if
condition|(
name|ielen
operator|>
sizeof|sizeof
argument_list|(
name|ie
argument_list|)
condition|)
name|ielen
operator|=
sizeof|sizeof
argument_list|(
name|ie
argument_list|)
expr_stmt|;
if|if
condition|(
name|hexstr2bin
argument_list|(
name|pos
argument_list|,
name|ie
argument_list|,
name|ielen
argument_list|)
operator|<
literal|0
condition|)
name|ielen
operator|=
literal|0
expr_stmt|;
block|}
name|memcpy
argument_list|(
operator|&
name|cli
operator|->
name|un
argument_list|,
name|from
argument_list|,
sizeof|sizeof
argument_list|(
name|cli
operator|->
name|un
argument_list|)
argument_list|)
expr_stmt|;
name|cli
operator|->
name|unlen
operator|=
name|fromlen
expr_stmt|;
name|cli
operator|->
name|next
operator|=
name|drv
operator|->
name|cli
expr_stmt|;
name|drv
operator|->
name|cli
operator|=
name|cli
expr_stmt|;
name|wpa_hexdump_ascii
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"test_socket: ASSOC sun_path"
argument_list|,
name|cli
operator|->
name|un
operator|.
name|sun_path
argument_list|,
name|cli
operator|->
name|unlen
argument_list|)
expr_stmt|;
name|snprintf
argument_list|(
name|cmd
argument_list|,
sizeof|sizeof
argument_list|(
name|cmd
argument_list|)
argument_list|,
literal|"ASSOCRESP "
name|MACSTR
literal|" 0"
argument_list|,
name|MAC2STR
argument_list|(
name|drv
operator|->
name|hapd
operator|->
name|own_addr
argument_list|)
argument_list|)
expr_stmt|;
name|sendto
argument_list|(
name|drv
operator|->
name|test_socket
argument_list|,
name|cmd
argument_list|,
name|strlen
argument_list|(
name|cmd
argument_list|)
argument_list|,
literal|0
argument_list|,
operator|(
expr|struct
name|sockaddr
operator|*
operator|)
name|from
argument_list|,
name|fromlen
argument_list|)
expr_stmt|;
if|if
condition|(
name|test_driver_new_sta
argument_list|(
name|drv
argument_list|,
name|cli
operator|->
name|addr
argument_list|,
name|ie
argument_list|,
name|ielen
argument_list|)
operator|<
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"test_driver: failed to add new STA"
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|test_driver_disassoc
parameter_list|(
name|struct
name|test_driver_data
modifier|*
name|drv
parameter_list|,
name|struct
name|sockaddr_un
modifier|*
name|from
parameter_list|,
name|socklen_t
name|fromlen
parameter_list|)
block|{
name|struct
name|test_client_socket
modifier|*
name|cli
decl_stmt|;
name|struct
name|sta_info
modifier|*
name|sta
decl_stmt|;
name|cli
operator|=
name|test_driver_get_cli
argument_list|(
name|drv
argument_list|,
name|from
argument_list|,
name|fromlen
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|cli
condition|)
return|return;
name|hostapd_logger
argument_list|(
name|drv
operator|->
name|hapd
argument_list|,
name|cli
operator|->
name|addr
argument_list|,
name|HOSTAPD_MODULE_IEEE80211
argument_list|,
name|HOSTAPD_LEVEL_INFO
argument_list|,
literal|"disassociated"
argument_list|)
expr_stmt|;
name|sta
operator|=
name|ap_get_sta
argument_list|(
name|drv
operator|->
name|hapd
argument_list|,
name|cli
operator|->
name|addr
argument_list|)
expr_stmt|;
if|if
condition|(
name|sta
operator|!=
name|NULL
condition|)
block|{
name|sta
operator|->
name|flags
operator|&=
operator|~
name|WLAN_STA_ASSOC
expr_stmt|;
name|wpa_sm_event
argument_list|(
name|drv
operator|->
name|hapd
argument_list|,
name|sta
argument_list|,
name|WPA_DISASSOC
argument_list|)
expr_stmt|;
name|sta
operator|->
name|acct_terminate_cause
operator|=
name|RADIUS_ACCT_TERMINATE_CAUSE_USER_REQUEST
expr_stmt|;
name|ieee802_1x_set_port_enabled
argument_list|(
name|drv
operator|->
name|hapd
argument_list|,
name|sta
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|ap_free_sta
argument_list|(
name|drv
operator|->
name|hapd
argument_list|,
name|sta
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|test_driver_eapol
parameter_list|(
name|struct
name|test_driver_data
modifier|*
name|drv
parameter_list|,
name|struct
name|sockaddr_un
modifier|*
name|from
parameter_list|,
name|socklen_t
name|fromlen
parameter_list|,
name|u8
modifier|*
name|data
parameter_list|,
name|size_t
name|datalen
parameter_list|)
block|{
name|struct
name|test_client_socket
modifier|*
name|cli
decl_stmt|;
if|if
condition|(
name|datalen
operator|>
literal|14
condition|)
block|{
comment|/* Skip Ethernet header */
name|data
operator|+=
literal|14
expr_stmt|;
name|datalen
operator|-=
literal|14
expr_stmt|;
block|}
name|cli
operator|=
name|test_driver_get_cli
argument_list|(
name|drv
argument_list|,
name|from
argument_list|,
name|fromlen
argument_list|)
expr_stmt|;
if|if
condition|(
name|cli
condition|)
name|ieee802_1x_receive
argument_list|(
name|drv
operator|->
name|hapd
argument_list|,
name|cli
operator|->
name|addr
argument_list|,
name|data
argument_list|,
name|datalen
argument_list|)
expr_stmt|;
else|else
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"test_socket: EAPOL from unknown "
literal|"client"
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|test_driver_receive_unix
parameter_list|(
name|int
name|sock
parameter_list|,
name|void
modifier|*
name|eloop_ctx
parameter_list|,
name|void
modifier|*
name|sock_ctx
parameter_list|)
block|{
name|struct
name|test_driver_data
modifier|*
name|drv
init|=
name|eloop_ctx
decl_stmt|;
name|char
name|buf
index|[
literal|2000
index|]
decl_stmt|;
name|int
name|res
decl_stmt|;
name|struct
name|sockaddr_un
name|from
decl_stmt|;
name|socklen_t
name|fromlen
init|=
sizeof|sizeof
argument_list|(
name|from
argument_list|)
decl_stmt|;
name|res
operator|=
name|recvfrom
argument_list|(
name|sock
argument_list|,
name|buf
argument_list|,
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
operator|-
literal|1
argument_list|,
literal|0
argument_list|,
operator|(
expr|struct
name|sockaddr
operator|*
operator|)
operator|&
name|from
argument_list|,
operator|&
name|fromlen
argument_list|)
expr_stmt|;
if|if
condition|(
name|res
operator|<
literal|0
condition|)
block|{
name|perror
argument_list|(
literal|"recvfrom(test_socket)"
argument_list|)
expr_stmt|;
return|return;
block|}
name|buf
index|[
name|res
index|]
operator|=
literal|'\0'
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"test_driver: received %u bytes"
argument_list|,
name|res
argument_list|)
expr_stmt|;
if|if
condition|(
name|strcmp
argument_list|(
name|buf
argument_list|,
literal|"SCAN"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|test_driver_scan
argument_list|(
name|drv
argument_list|,
operator|&
name|from
argument_list|,
name|fromlen
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strncmp
argument_list|(
name|buf
argument_list|,
literal|"ASSOC "
argument_list|,
literal|6
argument_list|)
operator|==
literal|0
condition|)
block|{
name|test_driver_assoc
argument_list|(
name|drv
argument_list|,
operator|&
name|from
argument_list|,
name|fromlen
argument_list|,
name|buf
operator|+
literal|6
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|buf
argument_list|,
literal|"DISASSOC"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|test_driver_disassoc
argument_list|(
name|drv
argument_list|,
operator|&
name|from
argument_list|,
name|fromlen
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strncmp
argument_list|(
name|buf
argument_list|,
literal|"EAPOL "
argument_list|,
literal|6
argument_list|)
operator|==
literal|0
condition|)
block|{
name|test_driver_eapol
argument_list|(
name|drv
argument_list|,
operator|&
name|from
argument_list|,
name|fromlen
argument_list|,
name|buf
operator|+
literal|6
argument_list|,
name|res
operator|-
literal|6
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|wpa_hexdump_ascii
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"Unknown test_socket command"
argument_list|,
operator|(
name|u8
operator|*
operator|)
name|buf
argument_list|,
name|res
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|int
name|test_driver_set_generic_elem
parameter_list|(
name|void
modifier|*
name|priv
parameter_list|,
specifier|const
name|u8
modifier|*
name|elem
parameter_list|,
name|size_t
name|elem_len
parameter_list|)
block|{
name|struct
name|test_driver_data
modifier|*
name|drv
init|=
name|priv
decl_stmt|;
name|free
argument_list|(
name|drv
operator|->
name|ie
argument_list|)
expr_stmt|;
name|drv
operator|->
name|ie
operator|=
name|malloc
argument_list|(
name|elem_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|drv
operator|->
name|ie
condition|)
block|{
name|memcpy
argument_list|(
name|drv
operator|->
name|ie
argument_list|,
name|elem
argument_list|,
name|elem_len
argument_list|)
expr_stmt|;
name|drv
operator|->
name|ielen
operator|=
name|elem_len
expr_stmt|;
return|return
literal|0
return|;
block|}
else|else
block|{
name|drv
operator|->
name|ielen
operator|=
literal|0
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
block|}
end_function

begin_function
specifier|static
name|int
name|test_driver_sta_deauth
parameter_list|(
name|void
modifier|*
name|priv
parameter_list|,
name|u8
modifier|*
name|addr
parameter_list|,
name|int
name|reason
parameter_list|)
block|{
name|struct
name|test_driver_data
modifier|*
name|drv
init|=
name|priv
decl_stmt|;
name|struct
name|test_client_socket
modifier|*
name|cli
decl_stmt|;
if|if
condition|(
name|drv
operator|->
name|test_socket
operator|<
literal|0
condition|)
return|return
operator|-
literal|1
return|;
name|cli
operator|=
name|drv
operator|->
name|cli
expr_stmt|;
while|while
condition|(
name|cli
condition|)
block|{
if|if
condition|(
name|memcmp
argument_list|(
name|cli
operator|->
name|addr
argument_list|,
name|addr
argument_list|,
name|ETH_ALEN
argument_list|)
operator|==
literal|0
condition|)
break|break;
name|cli
operator|=
name|cli
operator|->
name|next
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|cli
condition|)
return|return
operator|-
literal|1
return|;
return|return
name|sendto
argument_list|(
name|drv
operator|->
name|test_socket
argument_list|,
literal|"DEAUTH"
argument_list|,
literal|6
argument_list|,
literal|0
argument_list|,
operator|(
expr|struct
name|sockaddr
operator|*
operator|)
operator|&
name|cli
operator|->
name|un
argument_list|,
name|cli
operator|->
name|unlen
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|test_driver_sta_disassoc
parameter_list|(
name|void
modifier|*
name|priv
parameter_list|,
name|u8
modifier|*
name|addr
parameter_list|,
name|int
name|reason
parameter_list|)
block|{
name|struct
name|test_driver_data
modifier|*
name|drv
init|=
name|priv
decl_stmt|;
name|struct
name|test_client_socket
modifier|*
name|cli
decl_stmt|;
if|if
condition|(
name|drv
operator|->
name|test_socket
operator|<
literal|0
condition|)
return|return
operator|-
literal|1
return|;
name|cli
operator|=
name|drv
operator|->
name|cli
expr_stmt|;
while|while
condition|(
name|cli
condition|)
block|{
if|if
condition|(
name|memcmp
argument_list|(
name|cli
operator|->
name|addr
argument_list|,
name|addr
argument_list|,
name|ETH_ALEN
argument_list|)
operator|==
literal|0
condition|)
break|break;
name|cli
operator|=
name|cli
operator|->
name|next
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|cli
condition|)
return|return
operator|-
literal|1
return|;
return|return
name|sendto
argument_list|(
name|drv
operator|->
name|test_socket
argument_list|,
literal|"DISASSOC"
argument_list|,
literal|8
argument_list|,
literal|0
argument_list|,
operator|(
expr|struct
name|sockaddr
operator|*
operator|)
operator|&
name|cli
operator|->
name|un
argument_list|,
name|cli
operator|->
name|unlen
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|test_driver_init
parameter_list|(
name|struct
name|hostapd_data
modifier|*
name|hapd
parameter_list|)
block|{
name|struct
name|test_driver_data
modifier|*
name|drv
decl_stmt|;
name|struct
name|sockaddr_un
name|addr
decl_stmt|;
name|drv
operator|=
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
expr|struct
name|test_driver_data
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|drv
operator|==
name|NULL
condition|)
block|{
name|printf
argument_list|(
literal|"Could not allocate memory for test driver data\n"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|memset
argument_list|(
name|drv
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|drv
argument_list|)
argument_list|)
expr_stmt|;
name|drv
operator|->
name|ops
operator|=
name|test_driver_ops
expr_stmt|;
name|drv
operator|->
name|hapd
operator|=
name|hapd
expr_stmt|;
comment|/* Generate a MAC address to help testing with multiple APs */
name|hapd
operator|->
name|own_addr
index|[
literal|0
index|]
operator|=
literal|0x02
expr_stmt|;
comment|/* locally administered */
name|sha1_prf
argument_list|(
name|hapd
operator|->
name|conf
operator|->
name|iface
argument_list|,
name|strlen
argument_list|(
name|hapd
operator|->
name|conf
operator|->
name|iface
argument_list|)
argument_list|,
literal|"hostapd test bssid generation"
argument_list|,
name|hapd
operator|->
name|conf
operator|->
name|ssid
argument_list|,
name|hapd
operator|->
name|conf
operator|->
name|ssid_len
argument_list|,
name|hapd
operator|->
name|own_addr
operator|+
literal|1
argument_list|,
name|ETH_ALEN
operator|-
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|hapd
operator|->
name|conf
operator|->
name|test_socket
condition|)
block|{
if|if
condition|(
name|strlen
argument_list|(
name|hapd
operator|->
name|conf
operator|->
name|test_socket
argument_list|)
operator|>=
sizeof|sizeof
argument_list|(
name|addr
operator|.
name|sun_path
argument_list|)
condition|)
block|{
name|printf
argument_list|(
literal|"Too long test_socket path\n"
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|drv
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|drv
operator|->
name|test_socket
operator|=
name|socket
argument_list|(
name|PF_UNIX
argument_list|,
name|SOCK_DGRAM
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|drv
operator|->
name|test_socket
operator|<
literal|0
condition|)
block|{
name|perror
argument_list|(
literal|"socket(PF_UNIX)"
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|drv
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|memset
argument_list|(
operator|&
name|addr
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|addr
argument_list|)
argument_list|)
expr_stmt|;
name|addr
operator|.
name|sun_family
operator|=
name|AF_UNIX
expr_stmt|;
name|strncpy
argument_list|(
name|addr
operator|.
name|sun_path
argument_list|,
name|hapd
operator|->
name|conf
operator|->
name|test_socket
argument_list|,
sizeof|sizeof
argument_list|(
name|addr
operator|.
name|sun_path
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|bind
argument_list|(
name|drv
operator|->
name|test_socket
argument_list|,
operator|(
expr|struct
name|sockaddr
operator|*
operator|)
operator|&
name|addr
argument_list|,
sizeof|sizeof
argument_list|(
name|addr
argument_list|)
argument_list|)
operator|<
literal|0
condition|)
block|{
name|perror
argument_list|(
literal|"bind(PF_UNIX)"
argument_list|)
expr_stmt|;
name|close
argument_list|(
name|drv
operator|->
name|test_socket
argument_list|)
expr_stmt|;
name|unlink
argument_list|(
name|hapd
operator|->
name|conf
operator|->
name|test_socket
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|drv
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|eloop_register_read_sock
argument_list|(
name|drv
operator|->
name|test_socket
argument_list|,
name|test_driver_receive_unix
argument_list|,
name|drv
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
block|}
else|else
name|drv
operator|->
name|test_socket
operator|=
operator|-
literal|1
expr_stmt|;
name|hapd
operator|->
name|driver
operator|=
operator|&
name|drv
operator|->
name|ops
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|test_driver_deinit
parameter_list|(
name|void
modifier|*
name|priv
parameter_list|)
block|{
name|struct
name|test_driver_data
modifier|*
name|drv
init|=
name|priv
decl_stmt|;
name|struct
name|test_client_socket
modifier|*
name|cli
decl_stmt|,
modifier|*
name|prev
decl_stmt|;
name|cli
operator|=
name|drv
operator|->
name|cli
expr_stmt|;
while|while
condition|(
name|cli
condition|)
block|{
name|prev
operator|=
name|cli
expr_stmt|;
name|cli
operator|=
name|cli
operator|->
name|next
expr_stmt|;
name|free
argument_list|(
name|prev
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|drv
operator|->
name|test_socket
operator|>=
literal|0
condition|)
block|{
name|eloop_unregister_read_sock
argument_list|(
name|drv
operator|->
name|test_socket
argument_list|)
expr_stmt|;
name|close
argument_list|(
name|drv
operator|->
name|test_socket
argument_list|)
expr_stmt|;
name|unlink
argument_list|(
name|drv
operator|->
name|hapd
operator|->
name|conf
operator|->
name|test_socket
argument_list|)
expr_stmt|;
block|}
name|drv
operator|->
name|hapd
operator|->
name|driver
operator|=
name|NULL
expr_stmt|;
name|free
argument_list|(
name|drv
operator|->
name|ie
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|drv
argument_list|)
expr_stmt|;
block|}
end_function

begin_decl_stmt
specifier|static
specifier|const
name|struct
name|driver_ops
name|test_driver_ops
init|=
block|{
operator|.
name|name
operator|=
literal|"test"
block|,
operator|.
name|init
operator|=
name|test_driver_init
block|,
operator|.
name|deinit
operator|=
name|test_driver_deinit
block|,
operator|.
name|send_eapol
operator|=
name|test_driver_send_eapol
block|,
operator|.
name|set_generic_elem
operator|=
name|test_driver_set_generic_elem
block|,
operator|.
name|sta_deauth
operator|=
name|test_driver_sta_deauth
block|,
operator|.
name|sta_disassoc
operator|=
name|test_driver_sta_disassoc
block|, }
decl_stmt|;
end_decl_stmt

begin_function
name|void
name|test_driver_register
parameter_list|(
name|void
parameter_list|)
block|{
name|driver_register
argument_list|(
name|test_driver_ops
operator|.
name|name
argument_list|,
operator|&
name|test_driver_ops
argument_list|)
expr_stmt|;
block|}
end_function

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * hostapd / EAP-SIM (draft-haverinen-pppext-eap-sim-15.txt)  * Copyright (c) 2005, Jouni Malinen<jkmaline@cc.hut.fi>  *  * This program is free software; you can redistribute it and/or modify  * it under the terms of the GNU General Public License version 2 as  * published by the Free Software Foundation.  *  * Alternatively, this software may be distributed under the terms of BSD  * license.  *  * See README and COPYING for more details.  */
end_comment

begin_include
include|#
directive|include
file|<stdlib.h>
end_include

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_include
include|#
directive|include
file|<string.h>
end_include

begin_include
include|#
directive|include
file|<netinet/in.h>
end_include

begin_include
include|#
directive|include
file|"hostapd.h"
end_include

begin_include
include|#
directive|include
file|"common.h"
end_include

begin_include
include|#
directive|include
file|"crypto.h"
end_include

begin_include
include|#
directive|include
file|"eap_i.h"
end_include

begin_include
include|#
directive|include
file|"eap_sim_common.h"
end_include

begin_include
include|#
directive|include
file|"eap_sim_db.h"
end_include

begin_define
define|#
directive|define
name|EAP_SIM_VERSION
value|1
end_define

begin_comment
comment|/* EAP-SIM Subtypes */
end_comment

begin_define
define|#
directive|define
name|EAP_SIM_SUBTYPE_START
value|10
end_define

begin_define
define|#
directive|define
name|EAP_SIM_SUBTYPE_CHALLENGE
value|11
end_define

begin_define
define|#
directive|define
name|EAP_SIM_SUBTYPE_NOTIFICATION
value|12
end_define

begin_define
define|#
directive|define
name|EAP_SIM_SUBTYPE_REAUTHENTICATION
value|13
end_define

begin_define
define|#
directive|define
name|EAP_SIM_SUBTYPE_CLIENT_ERROR
value|14
end_define

begin_comment
comment|/* AT_CLIENT_ERROR_CODE error codes */
end_comment

begin_define
define|#
directive|define
name|EAP_SIM_UNABLE_TO_PROCESS_PACKET
value|0
end_define

begin_define
define|#
directive|define
name|EAP_SIM_UNSUPPORTED_VERSION
value|1
end_define

begin_define
define|#
directive|define
name|EAP_SIM_INSUFFICIENT_NUM_OF_CHAL
value|2
end_define

begin_define
define|#
directive|define
name|EAP_SIM_RAND_NOT_FRESH
value|3
end_define

begin_define
define|#
directive|define
name|KC_LEN
value|8
end_define

begin_define
define|#
directive|define
name|SRES_LEN
value|4
end_define

begin_define
define|#
directive|define
name|EAP_SIM_MAX_FAST_REAUTHS
value|1000
end_define

begin_define
define|#
directive|define
name|EAP_SIM_MAX_CHAL
value|3
end_define

begin_struct
struct|struct
name|eap_sim_data
block|{
name|u8
name|mk
index|[
name|EAP_SIM_MK_LEN
index|]
decl_stmt|;
name|u8
name|nonce_mt
index|[
name|EAP_SIM_NONCE_MT_LEN
index|]
decl_stmt|;
name|u8
name|k_aut
index|[
name|EAP_SIM_K_AUT_LEN
index|]
decl_stmt|;
name|u8
name|k_encr
index|[
name|EAP_SIM_K_ENCR_LEN
index|]
decl_stmt|;
name|u8
name|msk
index|[
name|EAP_SIM_KEYING_DATA_LEN
index|]
decl_stmt|;
name|u8
name|kc
index|[
name|EAP_SIM_MAX_CHAL
index|]
index|[
name|KC_LEN
index|]
decl_stmt|;
name|u8
name|sres
index|[
name|EAP_SIM_MAX_CHAL
index|]
index|[
name|SRES_LEN
index|]
decl_stmt|;
name|u8
name|rand
index|[
name|EAP_SIM_MAX_CHAL
index|]
index|[
name|GSM_RAND_LEN
index|]
decl_stmt|;
name|int
name|num_chal
decl_stmt|;
enum|enum
block|{
name|START
block|,
name|CHALLENGE
block|,
name|SUCCESS
block|,
name|FAILURE
block|}
name|state
enum|;
block|}
struct|;
end_struct

begin_function
specifier|static
specifier|const
name|char
modifier|*
name|eap_sim_state_txt
parameter_list|(
name|int
name|state
parameter_list|)
block|{
switch|switch
condition|(
name|state
condition|)
block|{
case|case
name|START
case|:
return|return
literal|"START"
return|;
case|case
name|CHALLENGE
case|:
return|return
literal|"CHALLENGE"
return|;
case|case
name|SUCCESS
case|:
return|return
literal|"SUCCESS"
return|;
case|case
name|FAILURE
case|:
return|return
literal|"FAILURE"
return|;
default|default:
return|return
literal|"Unknown?!"
return|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|eap_sim_state
parameter_list|(
name|struct
name|eap_sim_data
modifier|*
name|data
parameter_list|,
name|int
name|state
parameter_list|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"EAP-SIM %s -> %s"
argument_list|,
name|eap_sim_state_txt
argument_list|(
name|data
operator|->
name|state
argument_list|)
argument_list|,
name|eap_sim_state_txt
argument_list|(
name|state
argument_list|)
argument_list|)
expr_stmt|;
name|data
operator|->
name|state
operator|=
name|state
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
modifier|*
name|eap_sim_init
parameter_list|(
name|struct
name|eap_sm
modifier|*
name|sm
parameter_list|)
block|{
name|struct
name|eap_sim_data
modifier|*
name|data
decl_stmt|;
if|if
condition|(
name|sm
operator|->
name|eap_sim_db_priv
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_WARNING
argument_list|,
literal|"EAP-SIM: eap_sim_db not configured"
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|data
operator|=
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|data
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|data
operator|==
name|NULL
condition|)
return|return
name|data
return|;
name|memset
argument_list|(
name|data
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|data
argument_list|)
argument_list|)
expr_stmt|;
name|data
operator|->
name|state
operator|=
name|START
expr_stmt|;
return|return
name|data
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|eap_sim_reset
parameter_list|(
name|struct
name|eap_sm
modifier|*
name|sm
parameter_list|,
name|void
modifier|*
name|priv
parameter_list|)
block|{
name|struct
name|eap_sim_data
modifier|*
name|data
init|=
name|priv
decl_stmt|;
name|free
argument_list|(
name|data
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|u8
modifier|*
name|eap_sim_build_start
parameter_list|(
name|struct
name|eap_sm
modifier|*
name|sm
parameter_list|,
name|struct
name|eap_sim_data
modifier|*
name|data
parameter_list|,
name|int
name|id
parameter_list|,
name|size_t
modifier|*
name|reqDataLen
parameter_list|)
block|{
name|struct
name|eap_sim_msg
modifier|*
name|msg
decl_stmt|;
name|u8
name|ver
index|[
literal|2
index|]
decl_stmt|;
name|msg
operator|=
name|eap_sim_msg_init
argument_list|(
name|EAP_CODE_REQUEST
argument_list|,
name|id
argument_list|,
name|EAP_TYPE_SIM
argument_list|,
name|EAP_SIM_SUBTYPE_START
argument_list|)
expr_stmt|;
if|if
condition|(
name|eap_sim_db_identity_known
argument_list|(
name|sm
operator|->
name|eap_sim_db_priv
argument_list|,
name|sm
operator|->
name|identity
argument_list|,
name|sm
operator|->
name|identity_len
argument_list|)
condition|)
block|{
name|eap_sim_msg_add
argument_list|(
name|msg
argument_list|,
name|EAP_SIM_AT_PERMANENT_ID_REQ
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
name|ver
index|[
literal|0
index|]
operator|=
literal|0
expr_stmt|;
name|ver
index|[
literal|1
index|]
operator|=
name|EAP_SIM_VERSION
expr_stmt|;
name|eap_sim_msg_add
argument_list|(
name|msg
argument_list|,
name|EAP_SIM_AT_VERSION_LIST
argument_list|,
sizeof|sizeof
argument_list|(
name|ver
argument_list|)
argument_list|,
name|ver
argument_list|,
sizeof|sizeof
argument_list|(
name|ver
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|eap_sim_msg_finish
argument_list|(
name|msg
argument_list|,
name|reqDataLen
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|u8
modifier|*
name|eap_sim_build_challenge
parameter_list|(
name|struct
name|eap_sm
modifier|*
name|sm
parameter_list|,
name|struct
name|eap_sim_data
modifier|*
name|data
parameter_list|,
name|int
name|id
parameter_list|,
name|size_t
modifier|*
name|reqDataLen
parameter_list|)
block|{
name|struct
name|eap_sim_msg
modifier|*
name|msg
decl_stmt|;
name|msg
operator|=
name|eap_sim_msg_init
argument_list|(
name|EAP_CODE_REQUEST
argument_list|,
name|id
argument_list|,
name|EAP_TYPE_SIM
argument_list|,
name|EAP_SIM_SUBTYPE_CHALLENGE
argument_list|)
expr_stmt|;
name|eap_sim_msg_add
argument_list|(
name|msg
argument_list|,
name|EAP_SIM_AT_RAND
argument_list|,
literal|0
argument_list|,
operator|(
name|u8
operator|*
operator|)
name|data
operator|->
name|rand
argument_list|,
name|data
operator|->
name|num_chal
operator|*
name|GSM_RAND_LEN
argument_list|)
expr_stmt|;
name|eap_sim_msg_add_mac
argument_list|(
name|msg
argument_list|,
name|EAP_SIM_AT_MAC
argument_list|)
expr_stmt|;
return|return
name|eap_sim_msg_finish
argument_list|(
name|msg
argument_list|,
name|reqDataLen
argument_list|,
name|data
operator|->
name|k_aut
argument_list|,
name|data
operator|->
name|nonce_mt
argument_list|,
name|EAP_SIM_NONCE_MT_LEN
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|u8
modifier|*
name|eap_sim_buildReq
parameter_list|(
name|struct
name|eap_sm
modifier|*
name|sm
parameter_list|,
name|void
modifier|*
name|priv
parameter_list|,
name|int
name|id
parameter_list|,
name|size_t
modifier|*
name|reqDataLen
parameter_list|)
block|{
name|struct
name|eap_sim_data
modifier|*
name|data
init|=
name|priv
decl_stmt|;
switch|switch
condition|(
name|data
operator|->
name|state
condition|)
block|{
case|case
name|START
case|:
return|return
name|eap_sim_build_start
argument_list|(
name|sm
argument_list|,
name|data
argument_list|,
name|id
argument_list|,
name|reqDataLen
argument_list|)
return|;
case|case
name|CHALLENGE
case|:
return|return
name|eap_sim_build_challenge
argument_list|(
name|sm
argument_list|,
name|data
argument_list|,
name|id
argument_list|,
name|reqDataLen
argument_list|)
return|;
default|default:
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"EAP-SIM: Unknown state %d in "
literal|"buildReq"
argument_list|,
name|data
operator|->
name|state
argument_list|)
expr_stmt|;
break|break;
block|}
return|return
name|NULL
return|;
block|}
end_function

begin_function
specifier|static
name|Boolean
name|eap_sim_check
parameter_list|(
name|struct
name|eap_sm
modifier|*
name|sm
parameter_list|,
name|void
modifier|*
name|priv
parameter_list|,
name|u8
modifier|*
name|respData
parameter_list|,
name|size_t
name|respDataLen
parameter_list|)
block|{
name|struct
name|eap_sim_data
modifier|*
name|data
init|=
name|priv
decl_stmt|;
name|struct
name|eap_hdr
modifier|*
name|resp
decl_stmt|;
name|u8
modifier|*
name|pos
decl_stmt|,
name|subtype
decl_stmt|;
name|size_t
name|len
decl_stmt|;
name|resp
operator|=
operator|(
expr|struct
name|eap_hdr
operator|*
operator|)
name|respData
expr_stmt|;
name|pos
operator|=
operator|(
name|u8
operator|*
operator|)
operator|(
name|resp
operator|+
literal|1
operator|)
expr_stmt|;
if|if
condition|(
name|respDataLen
operator|<
sizeof|sizeof
argument_list|(
operator|*
name|resp
argument_list|)
operator|+
literal|4
operator|||
operator|*
name|pos
operator|!=
name|EAP_TYPE_SIM
operator|||
operator|(
name|len
operator|=
name|ntohs
argument_list|(
name|resp
operator|->
name|length
argument_list|)
operator|)
operator|>
name|respDataLen
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"EAP-SIM: Invalid frame"
argument_list|)
expr_stmt|;
return|return
name|TRUE
return|;
block|}
name|subtype
operator|=
name|pos
index|[
literal|1
index|]
expr_stmt|;
if|if
condition|(
name|subtype
operator|==
name|EAP_SIM_SUBTYPE_CLIENT_ERROR
condition|)
return|return
name|FALSE
return|;
switch|switch
condition|(
name|data
operator|->
name|state
condition|)
block|{
case|case
name|START
case|:
if|if
condition|(
name|subtype
operator|!=
name|EAP_SIM_SUBTYPE_START
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"EAP-SIM: Unexpected response "
literal|"subtype %d"
argument_list|,
name|subtype
argument_list|)
expr_stmt|;
return|return
name|TRUE
return|;
block|}
break|break;
case|case
name|CHALLENGE
case|:
if|if
condition|(
name|subtype
operator|!=
name|EAP_SIM_SUBTYPE_CHALLENGE
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"EAP-SIM: Unexpected response "
literal|"subtype %d"
argument_list|,
name|subtype
argument_list|)
expr_stmt|;
return|return
name|TRUE
return|;
block|}
break|break;
default|default:
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"EAP-SIM: Unexpected state (%d) for "
literal|"processing a response"
argument_list|,
name|data
operator|->
name|state
argument_list|)
expr_stmt|;
return|return
name|TRUE
return|;
block|}
return|return
name|FALSE
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|eap_sim_supported_ver
parameter_list|(
name|struct
name|eap_sim_data
modifier|*
name|data
parameter_list|,
name|int
name|version
parameter_list|)
block|{
return|return
name|version
operator|==
name|EAP_SIM_VERSION
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|eap_sim_derive_mk
parameter_list|(
name|struct
name|eap_sim_data
modifier|*
name|data
parameter_list|,
specifier|const
name|u8
modifier|*
name|identity
parameter_list|,
name|size_t
name|identity_len
parameter_list|,
specifier|const
name|u8
modifier|*
name|nonce_mt
parameter_list|,
name|int
name|selected_version
parameter_list|,
name|int
name|num_chal
parameter_list|,
specifier|const
name|u8
modifier|*
name|kc
parameter_list|)
block|{
name|u8
name|sel_ver
index|[
literal|2
index|]
decl_stmt|,
name|ver_list
index|[
literal|2
index|]
decl_stmt|;
specifier|const
name|unsigned
name|char
modifier|*
name|addr
index|[
literal|5
index|]
decl_stmt|;
name|size_t
name|len
index|[
literal|5
index|]
decl_stmt|;
name|addr
index|[
literal|0
index|]
operator|=
name|identity
expr_stmt|;
name|addr
index|[
literal|1
index|]
operator|=
name|kc
expr_stmt|;
name|addr
index|[
literal|2
index|]
operator|=
name|nonce_mt
expr_stmt|;
name|addr
index|[
literal|3
index|]
operator|=
name|ver_list
expr_stmt|;
name|addr
index|[
literal|4
index|]
operator|=
name|sel_ver
expr_stmt|;
name|len
index|[
literal|0
index|]
operator|=
name|identity_len
expr_stmt|;
name|len
index|[
literal|1
index|]
operator|=
name|num_chal
operator|*
name|KC_LEN
expr_stmt|;
name|len
index|[
literal|2
index|]
operator|=
name|EAP_SIM_NONCE_MT_LEN
expr_stmt|;
name|len
index|[
literal|3
index|]
operator|=
sizeof|sizeof
argument_list|(
name|ver_list
argument_list|)
expr_stmt|;
name|len
index|[
literal|4
index|]
operator|=
sizeof|sizeof
argument_list|(
name|sel_ver
argument_list|)
expr_stmt|;
name|ver_list
index|[
literal|0
index|]
operator|=
literal|0
expr_stmt|;
name|ver_list
index|[
literal|1
index|]
operator|=
name|EAP_SIM_VERSION
expr_stmt|;
name|sel_ver
index|[
literal|0
index|]
operator|=
name|selected_version
operator|>>
literal|8
expr_stmt|;
name|sel_ver
index|[
literal|1
index|]
operator|=
name|selected_version
operator|&
literal|0xff
expr_stmt|;
comment|/* MK = SHA1(Identity|n*Kc|NONCE_MT|Version List|Selected Version) */
name|sha1_vector
argument_list|(
literal|5
argument_list|,
name|addr
argument_list|,
name|len
argument_list|,
name|data
operator|->
name|mk
argument_list|)
expr_stmt|;
name|wpa_hexdump_key
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"EAP-SIM: MK"
argument_list|,
name|data
operator|->
name|mk
argument_list|,
name|EAP_SIM_MK_LEN
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|eap_sim_process_start
parameter_list|(
name|struct
name|eap_sm
modifier|*
name|sm
parameter_list|,
name|struct
name|eap_sim_data
modifier|*
name|data
parameter_list|,
name|u8
modifier|*
name|respData
parameter_list|,
name|size_t
name|respDataLen
parameter_list|,
name|struct
name|eap_sim_attrs
modifier|*
name|attr
parameter_list|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"EAP-SIM: Receive start response"
argument_list|)
expr_stmt|;
if|if
condition|(
name|attr
operator|->
name|nonce_mt
operator|==
name|NULL
operator|||
name|attr
operator|->
name|selected_version
operator|<
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"EAP-SIM: Start/Response missing "
literal|"required attributes"
argument_list|)
expr_stmt|;
name|eap_sim_state
argument_list|(
name|data
argument_list|,
name|FAILURE
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
operator|!
name|eap_sim_supported_ver
argument_list|(
name|data
argument_list|,
name|attr
operator|->
name|selected_version
argument_list|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"EAP-SIM: Peer selected unsupported "
literal|"version %d"
argument_list|,
name|attr
operator|->
name|selected_version
argument_list|)
expr_stmt|;
name|eap_sim_state
argument_list|(
name|data
argument_list|,
name|FAILURE
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|attr
operator|->
name|identity
condition|)
block|{
name|free
argument_list|(
name|sm
operator|->
name|identity
argument_list|)
expr_stmt|;
name|sm
operator|->
name|identity
operator|=
name|malloc
argument_list|(
name|attr
operator|->
name|identity_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|sm
operator|->
name|identity
condition|)
block|{
name|memcpy
argument_list|(
name|sm
operator|->
name|identity
argument_list|,
name|attr
operator|->
name|identity
argument_list|,
name|attr
operator|->
name|identity_len
argument_list|)
expr_stmt|;
name|sm
operator|->
name|identity_len
operator|=
name|attr
operator|->
name|identity_len
expr_stmt|;
block|}
block|}
if|if
condition|(
name|sm
operator|->
name|identity
operator|==
name|NULL
operator|||
name|sm
operator|->
name|identity_len
operator|<
literal|1
operator|||
name|sm
operator|->
name|identity
index|[
literal|0
index|]
operator|!=
literal|'1'
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"EAP-SIM: Could not get proper permanent"
literal|" user name"
argument_list|)
expr_stmt|;
name|eap_sim_state
argument_list|(
name|data
argument_list|,
name|FAILURE
argument_list|)
expr_stmt|;
return|return;
block|}
name|wpa_hexdump_ascii
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"EAP-SIM: Identity"
argument_list|,
name|sm
operator|->
name|identity
argument_list|,
name|sm
operator|->
name|identity_len
argument_list|)
expr_stmt|;
name|data
operator|->
name|num_chal
operator|=
name|eap_sim_db_get_gsm_triplets
argument_list|(
name|sm
operator|->
name|eap_sim_db_priv
argument_list|,
name|sm
operator|->
name|identity
argument_list|,
name|sm
operator|->
name|identity_len
argument_list|,
name|EAP_SIM_MAX_CHAL
argument_list|,
operator|(
name|u8
operator|*
operator|)
name|data
operator|->
name|rand
argument_list|,
operator|(
name|u8
operator|*
operator|)
name|data
operator|->
name|kc
argument_list|,
operator|(
name|u8
operator|*
operator|)
name|data
operator|->
name|sres
argument_list|)
expr_stmt|;
if|if
condition|(
name|data
operator|->
name|num_chal
operator|<
literal|2
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"EAP-SIM: Failed to get GSM "
literal|"authentication triplets for the peer"
argument_list|)
expr_stmt|;
name|eap_sim_state
argument_list|(
name|data
argument_list|,
name|FAILURE
argument_list|)
expr_stmt|;
return|return;
block|}
name|memcpy
argument_list|(
name|data
operator|->
name|nonce_mt
argument_list|,
name|attr
operator|->
name|nonce_mt
argument_list|,
name|EAP_SIM_NONCE_MT_LEN
argument_list|)
expr_stmt|;
name|eap_sim_derive_mk
argument_list|(
name|data
argument_list|,
name|sm
operator|->
name|identity
argument_list|,
name|sm
operator|->
name|identity_len
argument_list|,
name|attr
operator|->
name|nonce_mt
argument_list|,
name|attr
operator|->
name|selected_version
argument_list|,
name|data
operator|->
name|num_chal
argument_list|,
operator|(
name|u8
operator|*
operator|)
name|data
operator|->
name|kc
argument_list|)
expr_stmt|;
name|eap_sim_derive_keys
argument_list|(
name|data
operator|->
name|mk
argument_list|,
name|data
operator|->
name|k_encr
argument_list|,
name|data
operator|->
name|k_aut
argument_list|,
name|data
operator|->
name|msk
argument_list|)
expr_stmt|;
name|eap_sim_state
argument_list|(
name|data
argument_list|,
name|CHALLENGE
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|eap_sim_process_challenge
parameter_list|(
name|struct
name|eap_sm
modifier|*
name|sm
parameter_list|,
name|struct
name|eap_sim_data
modifier|*
name|data
parameter_list|,
name|u8
modifier|*
name|respData
parameter_list|,
name|size_t
name|respDataLen
parameter_list|,
name|struct
name|eap_sim_attrs
modifier|*
name|attr
parameter_list|)
block|{
if|if
condition|(
name|attr
operator|->
name|mac
operator|==
name|NULL
operator|||
name|eap_sim_verify_mac
argument_list|(
name|data
operator|->
name|k_aut
argument_list|,
name|respData
argument_list|,
name|respDataLen
argument_list|,
name|attr
operator|->
name|mac
argument_list|,
operator|(
name|u8
operator|*
operator|)
name|data
operator|->
name|sres
argument_list|,
name|data
operator|->
name|num_chal
operator|*
name|SRES_LEN
argument_list|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_WARNING
argument_list|,
literal|"EAP-SIM: Challenge message "
literal|"did not include valid AT_MAC"
argument_list|)
expr_stmt|;
name|eap_sim_state
argument_list|(
name|data
argument_list|,
name|FAILURE
argument_list|)
expr_stmt|;
return|return;
block|}
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"EAP-SIM: Challenge response includes the "
literal|"correct AT_MAC"
argument_list|)
expr_stmt|;
name|eap_sim_state
argument_list|(
name|data
argument_list|,
name|SUCCESS
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|eap_sim_process_client_error
parameter_list|(
name|struct
name|eap_sm
modifier|*
name|sm
parameter_list|,
name|struct
name|eap_sim_data
modifier|*
name|data
parameter_list|,
name|u8
modifier|*
name|respData
parameter_list|,
name|size_t
name|respDataLen
parameter_list|,
name|struct
name|eap_sim_attrs
modifier|*
name|attr
parameter_list|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"EAP-SIM: Client reported error %d"
argument_list|,
name|attr
operator|->
name|client_error_code
argument_list|)
expr_stmt|;
name|eap_sim_state
argument_list|(
name|data
argument_list|,
name|FAILURE
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|eap_sim_process
parameter_list|(
name|struct
name|eap_sm
modifier|*
name|sm
parameter_list|,
name|void
modifier|*
name|priv
parameter_list|,
name|u8
modifier|*
name|respData
parameter_list|,
name|size_t
name|respDataLen
parameter_list|)
block|{
name|struct
name|eap_sim_data
modifier|*
name|data
init|=
name|priv
decl_stmt|;
name|struct
name|eap_hdr
modifier|*
name|resp
decl_stmt|;
name|u8
modifier|*
name|pos
decl_stmt|,
name|subtype
decl_stmt|;
name|size_t
name|len
decl_stmt|;
name|struct
name|eap_sim_attrs
name|attr
decl_stmt|;
name|resp
operator|=
operator|(
expr|struct
name|eap_hdr
operator|*
operator|)
name|respData
expr_stmt|;
name|pos
operator|=
operator|(
name|u8
operator|*
operator|)
operator|(
name|resp
operator|+
literal|1
operator|)
expr_stmt|;
name|subtype
operator|=
name|pos
index|[
literal|1
index|]
expr_stmt|;
name|len
operator|=
name|ntohs
argument_list|(
name|resp
operator|->
name|length
argument_list|)
expr_stmt|;
name|pos
operator|+=
literal|4
expr_stmt|;
if|if
condition|(
name|eap_sim_parse_attr
argument_list|(
name|pos
argument_list|,
name|respData
operator|+
name|len
argument_list|,
operator|&
name|attr
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"EAP-SIM: Failed to parse attributes"
argument_list|)
expr_stmt|;
name|eap_sim_state
argument_list|(
name|data
argument_list|,
name|FAILURE
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|subtype
operator|==
name|EAP_SIM_SUBTYPE_CLIENT_ERROR
condition|)
block|{
name|eap_sim_process_client_error
argument_list|(
name|sm
argument_list|,
name|data
argument_list|,
name|respData
argument_list|,
name|len
argument_list|,
operator|&
name|attr
argument_list|)
expr_stmt|;
return|return;
block|}
switch|switch
condition|(
name|data
operator|->
name|state
condition|)
block|{
case|case
name|START
case|:
name|eap_sim_process_start
argument_list|(
name|sm
argument_list|,
name|data
argument_list|,
name|respData
argument_list|,
name|len
argument_list|,
operator|&
name|attr
argument_list|)
expr_stmt|;
break|break;
case|case
name|CHALLENGE
case|:
name|eap_sim_process_challenge
argument_list|(
name|sm
argument_list|,
name|data
argument_list|,
name|respData
argument_list|,
name|len
argument_list|,
operator|&
name|attr
argument_list|)
expr_stmt|;
break|break;
default|default:
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"EAP-SIM: Unknown state %d in "
literal|"process"
argument_list|,
name|data
operator|->
name|state
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
end_function

begin_function
specifier|static
name|Boolean
name|eap_sim_isDone
parameter_list|(
name|struct
name|eap_sm
modifier|*
name|sm
parameter_list|,
name|void
modifier|*
name|priv
parameter_list|)
block|{
name|struct
name|eap_sim_data
modifier|*
name|data
init|=
name|priv
decl_stmt|;
return|return
name|data
operator|->
name|state
operator|==
name|SUCCESS
operator|||
name|data
operator|->
name|state
operator|==
name|FAILURE
return|;
block|}
end_function

begin_function
specifier|static
name|u8
modifier|*
name|eap_sim_getKey
parameter_list|(
name|struct
name|eap_sm
modifier|*
name|sm
parameter_list|,
name|void
modifier|*
name|priv
parameter_list|,
name|size_t
modifier|*
name|len
parameter_list|)
block|{
name|struct
name|eap_sim_data
modifier|*
name|data
init|=
name|priv
decl_stmt|;
name|u8
modifier|*
name|key
decl_stmt|;
if|if
condition|(
name|data
operator|->
name|state
operator|!=
name|SUCCESS
condition|)
return|return
name|NULL
return|;
name|key
operator|=
name|malloc
argument_list|(
name|EAP_SIM_KEYING_DATA_LEN
argument_list|)
expr_stmt|;
if|if
condition|(
name|key
operator|==
name|NULL
condition|)
return|return
name|NULL
return|;
name|memcpy
argument_list|(
name|key
argument_list|,
name|data
operator|->
name|msk
argument_list|,
name|EAP_SIM_KEYING_DATA_LEN
argument_list|)
expr_stmt|;
operator|*
name|len
operator|=
name|EAP_SIM_KEYING_DATA_LEN
expr_stmt|;
return|return
name|key
return|;
block|}
end_function

begin_function
specifier|static
name|Boolean
name|eap_sim_isSuccess
parameter_list|(
name|struct
name|eap_sm
modifier|*
name|sm
parameter_list|,
name|void
modifier|*
name|priv
parameter_list|)
block|{
name|struct
name|eap_sim_data
modifier|*
name|data
init|=
name|priv
decl_stmt|;
return|return
name|data
operator|->
name|state
operator|==
name|SUCCESS
return|;
block|}
end_function

begin_decl_stmt
specifier|const
name|struct
name|eap_method
name|eap_method_sim
init|=
block|{
operator|.
name|method
operator|=
name|EAP_TYPE_SIM
block|,
operator|.
name|name
operator|=
literal|"SIM"
block|,
operator|.
name|init
operator|=
name|eap_sim_init
block|,
operator|.
name|reset
operator|=
name|eap_sim_reset
block|,
operator|.
name|buildReq
operator|=
name|eap_sim_buildReq
block|,
operator|.
name|check
operator|=
name|eap_sim_check
block|,
operator|.
name|process
operator|=
name|eap_sim_process
block|,
operator|.
name|isDone
operator|=
name|eap_sim_isDone
block|,
operator|.
name|getKey
operator|=
name|eap_sim_getKey
block|,
operator|.
name|isSuccess
operator|=
name|eap_sim_isSuccess
block|, }
decl_stmt|;
end_decl_stmt

end_unit


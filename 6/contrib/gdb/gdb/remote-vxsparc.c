begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/* SPARC-specific portions of the RPC protocol for VxWorks.     Contributed by Wind River Systems.     This file is part of GDB.     This program is free software; you can redistribute it and/or modify    it under the terms of the GNU General Public License as published by    the Free Software Foundation; either version 2 of the License, or    (at your option) any later version.     This program is distributed in the hope that it will be useful,    but WITHOUT ANY WARRANTY; without even the implied warranty of    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the    GNU General Public License for more details.     You should have received a copy of the GNU General Public License    along with this program; if not, write to the Free Software    Foundation, Inc., 59 Temple Place - Suite 330,    Boston, MA 02111-1307, USA.  */
end_comment

begin_include
include|#
directive|include
file|"defs.h"
end_include

begin_include
include|#
directive|include
file|"regcache.h"
end_include

begin_include
include|#
directive|include
file|"gdb_string.h"
end_include

begin_include
include|#
directive|include
file|"sparc-tdep.h"
end_include

begin_include
include|#
directive|include
file|"vx-share/ptrace.h"
end_include

begin_include
include|#
directive|include
file|"vx-share/regPacket.h"
end_include

begin_define
define|#
directive|define
name|SPARC_R_G1
value|(SPARC_R_G0 + SPARC_GREG_SIZE)
end_define

begin_decl_stmt
specifier|const
name|struct
name|sparc_gregset
name|vxsparc_gregset
init|=
block|{
name|SPARC_R_PSR
block|,
comment|/* %psr */
name|SPARC_R_PC
block|,
comment|/* %pc */
name|SPARC_R_NPC
block|,
comment|/* %npc */
name|SPARC_R_Y
block|,
comment|/* %y */
name|SPARC_R_WIM
block|,
comment|/* %wim */
name|SPARC_R_TBR
block|,
comment|/* %tbr */
name|SPARC_R_G1
block|,
comment|/* %g1 */
name|SPARC_R_I0
comment|/* %l0 */
block|}
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* Flag set if target has an FPU.  */
end_comment

begin_decl_stmt
specifier|extern
name|int
name|target_has_fp
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* Generic register read/write routines in remote-vx.c.  */
end_comment

begin_function_decl
specifier|extern
name|void
name|net_read_registers
parameter_list|()
function_decl|;
end_function_decl

begin_function_decl
specifier|extern
name|void
name|net_write_registers
parameter_list|()
function_decl|;
end_function_decl

begin_comment
comment|/* Read a register or registers from the VxWorks target.  REGNUM is    the register to read, or -1 for all; currently, it is ignored.    FIXME: Look at REGNUM to improve efficiency.  */
end_comment

begin_function
name|void
name|vx_read_register
parameter_list|(
name|int
name|regnum
parameter_list|)
block|{
name|struct
name|regcache
modifier|*
name|regcache
init|=
name|current_regcache
decl_stmt|;
name|char
name|gregs
index|[
name|SPARC_GREG_PLEN
index|]
decl_stmt|;
name|char
name|fpregs
index|[
name|SPARC_FPREG_PLEN
index|]
decl_stmt|;
name|CORE_ADDR
name|sp
decl_stmt|;
comment|/* Get the general-purpose registers.  */
name|net_read_registers
argument_list|(
name|gregs
argument_list|,
name|SPARC_GREG_PLEN
argument_list|,
name|PTRACE_GETREGS
argument_list|)
expr_stmt|;
name|sparc32_supply_gregset
argument_list|(
operator|&
name|vxsparc_gregset
argument_list|,
name|regcache
argument_list|,
operator|-
literal|1
argument_list|,
name|gregs
argument_list|)
expr_stmt|;
comment|/* If the target has floating-point registers, fetch them.      Otherwise, zero the floating-point register values in GDB's      register cache for good measure, even though we might not need      to.  */
if|if
condition|(
name|target_has_fp
condition|)
name|net_read_registers
argument_list|(
name|fpregs
argument_list|,
name|SPARC_FPREG_PLEN
argument_list|,
name|PTRACE_GETFPREGS
argument_list|)
expr_stmt|;
else|else
name|memset
argument_list|(
name|fpregs
argument_list|,
literal|0
argument_list|,
name|SPARC_FPREG_PLEN
argument_list|)
expr_stmt|;
name|sparc32_supply_fpregset
argument_list|(
name|regcache
argument_list|,
operator|-
literal|1
argument_list|,
name|fpregs
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* Store a register or registers into the VxWorks target.  REGNUM is    the register to store, or -1 for all; currently, it is ignored.    FIXME: Look at REGNUM to improve efficiency.  */
end_comment

begin_function
name|void
name|vx_write_register
parameter_list|(
name|int
name|regnum
parameter_list|)
block|{
name|struct
name|regcache
modifier|*
name|regcache
init|=
name|current_regcache
decl_stmt|;
name|char
name|gregs
index|[
name|SPARC_GREG_PLEN
index|]
decl_stmt|;
name|char
name|fpregs
index|[
name|SPARC_FPREG_PLEN
index|]
decl_stmt|;
name|int
name|gregs_p
init|=
literal|1
decl_stmt|;
name|int
name|fpregs_p
init|=
literal|1
decl_stmt|;
name|CORE_ADDR
name|sp
decl_stmt|;
if|if
condition|(
name|regnum
operator|!=
operator|-
literal|1
condition|)
block|{
if|if
condition|(
operator|(
name|SPARC_G0_REGNUM
operator|<=
name|regnum
operator|&&
name|regnum
operator|<=
name|SPARC_I7_REGNUM
operator|)
operator|||
operator|(
name|SPARC32_Y_REGNUM
operator|<=
name|regnum
operator|&&
name|regnum
operator|<=
name|SPARC32_NPC_REGNUM
operator|)
condition|)
name|fpregs_p
operator|=
literal|0
expr_stmt|;
else|else
name|gregs_p
operator|=
literal|0
expr_stmt|;
block|}
comment|/* Store the general-purpose registers.  */
if|if
condition|(
name|gregs_p
condition|)
block|{
name|sparc32_collect_gregset
argument_list|(
operator|&
name|vxsparc_gregset
argument_list|,
name|regcache
argument_list|,
operator|-
literal|1
argument_list|,
name|gregs
argument_list|)
expr_stmt|;
name|net_write_registers
argument_list|(
name|gregs
argument_list|,
name|SPARC_GREG_PLEN
argument_list|,
name|PTRACE_SETREGS
argument_list|)
expr_stmt|;
comment|/* Deal with the stack regs.  */
if|if
condition|(
name|regnum
operator|==
operator|-
literal|1
operator|||
name|regnum
operator|==
name|SPARC_SP_REGNUM
operator|||
operator|(
name|regnum
operator|>=
name|SPARC_L0_REGNUM
operator|&&
name|regnum
operator|<=
name|SPARC_I7_REGNUM
operator|)
condition|)
block|{
name|ULONGEST
name|sp
decl_stmt|;
name|regcache_cooked_read_unsigned
argument_list|(
name|regcache
argument_list|,
name|SPARC_SP_REGNUM
argument_list|,
operator|&
name|sp
argument_list|)
expr_stmt|;
name|sparc_collect_rwindow
argument_list|(
name|regcache
argument_list|,
name|sp
argument_list|,
name|regnum
argument_list|)
expr_stmt|;
block|}
block|}
comment|/* Store the floating-point registers if the target has them.  */
if|if
condition|(
name|fpregs_p
operator|&&
name|target_has_fp
condition|)
block|{
name|sparc32_collect_fpregset
argument_list|(
name|regcache
argument_list|,
operator|-
literal|1
argument_list|,
name|fpregs
argument_list|)
expr_stmt|;
name|net_write_registers
argument_list|(
name|fpregs
argument_list|,
name|SPARC_FPREG_PLEN
argument_list|,
name|PTRACE_SETFPREGS
argument_list|)
expr_stmt|;
block|}
block|}
end_function

end_unit


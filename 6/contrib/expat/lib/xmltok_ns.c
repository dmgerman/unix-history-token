begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_function
specifier|const
name|ENCODING
modifier|*
name|NS
function|(
name|XmlGetUtf8InternalEncoding
function|)
parameter_list|(
name|void
parameter_list|)
block|{
return|return
operator|&
name|ns
argument_list|(
name|internal_utf8_encoding
argument_list|)
operator|.
name|enc
return|;
block|}
end_function

begin_function
specifier|const
name|ENCODING
modifier|*
name|NS
function|(
name|XmlGetUtf16InternalEncoding
function|)
parameter_list|(
name|void
parameter_list|)
block|{
if|#
directive|if
name|BYTEORDER
operator|==
literal|1234
return|return
operator|&
name|ns
argument_list|(
name|internal_little2_encoding
argument_list|)
operator|.
name|enc
return|;
elif|#
directive|elif
name|BYTEORDER
operator|==
literal|4321
return|return
operator|&
name|ns
argument_list|(
name|internal_big2_encoding
argument_list|)
operator|.
name|enc
return|;
else|#
directive|else
specifier|const
name|short
name|n
init|=
literal|1
decl_stmt|;
return|return
operator|(
operator|*
operator|(
specifier|const
name|char
operator|*
operator|)
operator|&
name|n
condition|?
operator|&
name|ns
argument_list|(
name|internal_little2_encoding
argument_list|)
operator|.
name|enc
else|:
operator|&
name|ns
argument_list|(
name|internal_big2_encoding
argument_list|)
operator|.
name|enc
operator|)
return|;
endif|#
directive|endif
block|}
end_function

begin_decl_stmt
specifier|static
specifier|const
name|ENCODING
modifier|*
name|NS
argument_list|(
name|encodings
argument_list|)
decl|[]
init|=
block|{
operator|&
name|ns
argument_list|(
name|latin1_encoding
argument_list|)
operator|.
name|enc
block|,
operator|&
name|ns
argument_list|(
name|ascii_encoding
argument_list|)
operator|.
name|enc
block|,
operator|&
name|ns
argument_list|(
name|utf8_encoding
argument_list|)
operator|.
name|enc
block|,
operator|&
name|ns
argument_list|(
name|big2_encoding
argument_list|)
operator|.
name|enc
block|,
operator|&
name|ns
argument_list|(
name|big2_encoding
argument_list|)
operator|.
name|enc
block|,
operator|&
name|ns
argument_list|(
name|little2_encoding
argument_list|)
operator|.
name|enc
block|,
operator|&
name|ns
argument_list|(
name|utf8_encoding
argument_list|)
operator|.
name|enc
comment|/* NO_ENC */
block|}
decl_stmt|;
end_decl_stmt

begin_function
specifier|static
name|int
name|FASTCALL
name|NS
function|(
name|initScanProlog
function|)
parameter_list|(
specifier|const
name|ENCODING
modifier|*
name|enc
parameter_list|,
specifier|const
name|char
modifier|*
name|ptr
parameter_list|,
specifier|const
name|char
modifier|*
name|end
parameter_list|,
specifier|const
name|char
modifier|*
modifier|*
name|nextTokPtr
parameter_list|)
block|{
return|return
name|initScan
argument_list|(
name|NS
argument_list|(
name|encodings
argument_list|)
argument_list|,
operator|(
specifier|const
name|INIT_ENCODING
operator|*
operator|)
name|enc
argument_list|,
name|XML_PROLOG_STATE
argument_list|,
name|ptr
argument_list|,
name|end
argument_list|,
name|nextTokPtr
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|FASTCALL
name|NS
function|(
name|initScanContent
function|)
parameter_list|(
specifier|const
name|ENCODING
modifier|*
name|enc
parameter_list|,
specifier|const
name|char
modifier|*
name|ptr
parameter_list|,
specifier|const
name|char
modifier|*
name|end
parameter_list|,
specifier|const
name|char
modifier|*
modifier|*
name|nextTokPtr
parameter_list|)
block|{
return|return
name|initScan
argument_list|(
name|NS
argument_list|(
name|encodings
argument_list|)
argument_list|,
operator|(
specifier|const
name|INIT_ENCODING
operator|*
operator|)
name|enc
argument_list|,
name|XML_CONTENT_STATE
argument_list|,
name|ptr
argument_list|,
name|end
argument_list|,
name|nextTokPtr
argument_list|)
return|;
block|}
end_function

begin_function
name|int
name|NS
function|(
name|XmlInitEncoding
function|)
parameter_list|(
name|INIT_ENCODING
modifier|*
name|p
parameter_list|,
specifier|const
name|ENCODING
modifier|*
modifier|*
name|encPtr
parameter_list|,
specifier|const
name|char
modifier|*
name|name
parameter_list|)
block|{
name|int
name|i
init|=
name|getEncodingIndex
argument_list|(
name|name
argument_list|)
decl_stmt|;
if|if
condition|(
name|i
operator|==
name|UNKNOWN_ENC
condition|)
return|return
literal|0
return|;
name|SET_INIT_ENC_INDEX
argument_list|(
name|p
argument_list|,
name|i
argument_list|)
expr_stmt|;
name|p
operator|->
name|initEnc
operator|.
name|scanners
index|[
name|XML_PROLOG_STATE
index|]
operator|=
name|NS
argument_list|(
name|initScanProlog
argument_list|)
expr_stmt|;
name|p
operator|->
name|initEnc
operator|.
name|scanners
index|[
name|XML_CONTENT_STATE
index|]
operator|=
name|NS
argument_list|(
name|initScanContent
argument_list|)
expr_stmt|;
name|p
operator|->
name|initEnc
operator|.
name|updatePosition
operator|=
name|initUpdatePosition
expr_stmt|;
name|p
operator|->
name|encPtr
operator|=
name|encPtr
expr_stmt|;
operator|*
name|encPtr
operator|=
operator|&
operator|(
name|p
operator|->
name|initEnc
operator|)
expr_stmt|;
return|return
literal|1
return|;
block|}
end_function

begin_function
specifier|static
specifier|const
name|ENCODING
modifier|*
name|NS
function|(
name|findEncoding
function|)
parameter_list|(
specifier|const
name|ENCODING
modifier|*
name|enc
parameter_list|,
specifier|const
name|char
modifier|*
name|ptr
parameter_list|,
specifier|const
name|char
modifier|*
name|end
parameter_list|)
block|{
define|#
directive|define
name|ENCODING_MAX
value|128
name|char
name|buf
index|[
name|ENCODING_MAX
index|]
decl_stmt|;
name|char
modifier|*
name|p
init|=
name|buf
decl_stmt|;
name|int
name|i
decl_stmt|;
name|XmlUtf8Convert
argument_list|(
name|enc
argument_list|,
operator|&
name|ptr
argument_list|,
name|end
argument_list|,
operator|&
name|p
argument_list|,
name|p
operator|+
name|ENCODING_MAX
operator|-
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|ptr
operator|!=
name|end
condition|)
return|return
literal|0
return|;
operator|*
name|p
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|streqci
argument_list|(
name|buf
argument_list|,
name|KW_UTF_16
argument_list|)
operator|&&
name|enc
operator|->
name|minBytesPerChar
operator|==
literal|2
condition|)
return|return
name|enc
return|;
name|i
operator|=
name|getEncodingIndex
argument_list|(
name|buf
argument_list|)
expr_stmt|;
if|if
condition|(
name|i
operator|==
name|UNKNOWN_ENC
condition|)
return|return
literal|0
return|;
return|return
name|NS
argument_list|(
name|encodings
argument_list|)
index|[
name|i
index|]
return|;
block|}
end_function

begin_function
name|int
name|NS
function|(
name|XmlParseXmlDecl
function|)
parameter_list|(
name|int
name|isGeneralTextEntity
parameter_list|,
specifier|const
name|ENCODING
modifier|*
name|enc
parameter_list|,
specifier|const
name|char
modifier|*
name|ptr
parameter_list|,
specifier|const
name|char
modifier|*
name|end
parameter_list|,
specifier|const
name|char
modifier|*
modifier|*
name|badPtr
parameter_list|,
specifier|const
name|char
modifier|*
modifier|*
name|versionPtr
parameter_list|,
specifier|const
name|char
modifier|*
modifier|*
name|versionEndPtr
parameter_list|,
specifier|const
name|char
modifier|*
modifier|*
name|encodingName
parameter_list|,
specifier|const
name|ENCODING
modifier|*
modifier|*
name|encoding
parameter_list|,
name|int
modifier|*
name|standalone
parameter_list|)
block|{
return|return
name|doParseXmlDecl
argument_list|(
name|NS
argument_list|(
name|findEncoding
argument_list|)
argument_list|,
name|isGeneralTextEntity
argument_list|,
name|enc
argument_list|,
name|ptr
argument_list|,
name|end
argument_list|,
name|badPtr
argument_list|,
name|versionPtr
argument_list|,
name|versionEndPtr
argument_list|,
name|encodingName
argument_list|,
name|encoding
argument_list|,
name|standalone
argument_list|)
return|;
block|}
end_function

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * WPA Supplicant / EAP-FAST (draft-cam-winget-eap-fast-00.txt)  * Copyright (c) 2004-2005, Jouni Malinen<jkmaline@cc.hut.fi>  *  * This program is free software; you can redistribute it and/or modify  * it under the terms of the GNU General Public License version 2 as  * published by the Free Software Foundation.  *  * Alternatively, this software may be distributed under the terms of BSD  * license.  *  * See README and COPYING for more details.  */
end_comment

begin_include
include|#
directive|include
file|<stdlib.h>
end_include

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_include
include|#
directive|include
file|<string.h>
end_include

begin_include
include|#
directive|include
file|"common.h"
end_include

begin_include
include|#
directive|include
file|"eap_i.h"
end_include

begin_include
include|#
directive|include
file|"eap_tls_common.h"
end_include

begin_include
include|#
directive|include
file|"wpa_supplicant.h"
end_include

begin_include
include|#
directive|include
file|"config_ssid.h"
end_include

begin_include
include|#
directive|include
file|"tls.h"
end_include

begin_include
include|#
directive|include
file|"eap_tlv.h"
end_include

begin_include
include|#
directive|include
file|"sha1.h"
end_include

begin_include
include|#
directive|include
file|"config.h"
end_include

begin_comment
comment|/* TODO:  * - encrypt PAC-Key in the PAC file  * - test session resumption and enable it if it interoperates  * - password change (pending mschapv2 packet; replay decrypted packet)  */
end_comment

begin_define
define|#
directive|define
name|EAP_FAST_VERSION
value|1
end_define

begin_define
define|#
directive|define
name|EAP_FAST_KEY_LEN
value|64
end_define

begin_define
define|#
directive|define
name|EAP_FAST_PAC_KEY_LEN
value|32
end_define

begin_define
define|#
directive|define
name|TLS_EXT_PAC_OPAQUE
value|35
end_define

begin_decl_stmt
specifier|static
specifier|const
name|char
modifier|*
name|pac_file_hdr
init|=
literal|"wpa_supplicant EAP-FAST PAC file - version 1"
decl_stmt|;
end_decl_stmt

begin_function_decl
specifier|static
name|void
name|eap_fast_deinit
parameter_list|(
name|struct
name|eap_sm
modifier|*
name|sm
parameter_list|,
name|void
modifier|*
name|priv
parameter_list|)
function_decl|;
end_function_decl

begin_define
define|#
directive|define
name|PAC_TYPE_PAC_KEY
value|1
end_define

begin_define
define|#
directive|define
name|PAC_TYPE_PAC_OPAQUE
value|2
end_define

begin_define
define|#
directive|define
name|PAC_TYPE_CRED_LIFETIME
value|3
end_define

begin_define
define|#
directive|define
name|PAC_TYPE_A_ID
value|4
end_define

begin_define
define|#
directive|define
name|PAC_TYPE_I_ID
value|5
end_define

begin_define
define|#
directive|define
name|PAC_TYPE_SERVER_PROTECTED_DATA
value|6
end_define

begin_define
define|#
directive|define
name|PAC_TYPE_A_ID_INFO
value|7
end_define

begin_define
define|#
directive|define
name|PAC_TYPE_PAC_ACKNOWLEDGEMENT
value|8
end_define

begin_define
define|#
directive|define
name|PAC_TYPE_PAC_INFO
value|9
end_define

begin_struct
struct|struct
name|pac_tlv_hdr
block|{
name|u16
name|type
decl_stmt|;
name|u16
name|len
decl_stmt|;
block|}
struct|;
end_struct

begin_comment
comment|/* draft-cam-winget-eap-fast-02.txt:  * 6.2 EAP-FAST Authentication Phase 1: Key Derivations */
end_comment

begin_struct
struct|struct
name|eap_fast_key_block_auth
block|{
comment|/* Extra key material after TLS key_block */
name|u8
name|session_key_seed
index|[
literal|40
index|]
decl_stmt|;
block|}
struct|;
end_struct

begin_comment
comment|/* draft-cam-winget-eap-fast-provisioning-01.txt:  * 3.4 Key Derivations Used in the EAP-FAST Provisioning Exchange */
end_comment

begin_struct
struct|struct
name|eap_fast_key_block_provisioning
block|{
comment|/* Extra key material after TLS key_block */
name|u8
name|session_key_seed
index|[
literal|40
index|]
decl_stmt|;
name|u8
name|server_challenge
index|[
literal|16
index|]
decl_stmt|;
name|u8
name|client_challenge
index|[
literal|16
index|]
decl_stmt|;
block|}
struct|;
end_struct

begin_struct
struct|struct
name|eap_fast_pac
block|{
name|struct
name|eap_fast_pac
modifier|*
name|next
decl_stmt|;
name|u8
name|pac_key
index|[
name|EAP_FAST_PAC_KEY_LEN
index|]
decl_stmt|;
name|u8
modifier|*
name|pac_opaque
decl_stmt|;
name|size_t
name|pac_opaque_len
decl_stmt|;
name|u8
modifier|*
name|pac_info
decl_stmt|;
name|size_t
name|pac_info_len
decl_stmt|;
name|u8
modifier|*
name|a_id
decl_stmt|;
name|size_t
name|a_id_len
decl_stmt|;
name|u8
modifier|*
name|i_id
decl_stmt|;
name|size_t
name|i_id_len
decl_stmt|;
name|u8
modifier|*
name|a_id_info
decl_stmt|;
name|size_t
name|a_id_info_len
decl_stmt|;
block|}
struct|;
end_struct

begin_struct
struct|struct
name|eap_fast_data
block|{
name|struct
name|eap_ssl_data
name|ssl
decl_stmt|;
name|int
name|fast_version
decl_stmt|;
specifier|const
name|struct
name|eap_method
modifier|*
name|phase2_method
decl_stmt|;
name|void
modifier|*
name|phase2_priv
decl_stmt|;
name|int
name|phase2_success
decl_stmt|;
name|u8
name|phase2_type
decl_stmt|;
name|u8
modifier|*
name|phase2_types
decl_stmt|;
name|size_t
name|num_phase2_types
decl_stmt|;
name|int
name|resuming
decl_stmt|;
comment|/* starting a resumed session */
name|struct
name|eap_fast_key_block_auth
modifier|*
name|key_block_a
decl_stmt|;
name|struct
name|eap_fast_key_block_provisioning
modifier|*
name|key_block_p
decl_stmt|;
name|int
name|provisioning_allowed
decl_stmt|;
comment|/* is PAC provisioning allowed */
name|int
name|provisioning
decl_stmt|;
comment|/* doing PAC provisioning (not the normal auth) */
name|u8
name|key_data
index|[
name|EAP_FAST_KEY_LEN
index|]
decl_stmt|;
name|int
name|success
decl_stmt|;
name|struct
name|eap_fast_pac
modifier|*
name|pac
decl_stmt|;
name|struct
name|eap_fast_pac
modifier|*
name|current_pac
decl_stmt|;
name|int
name|tls_master_secret_set
decl_stmt|;
block|}
struct|;
end_struct

begin_function
specifier|static
name|void
name|eap_fast_free_pac
parameter_list|(
name|struct
name|eap_fast_pac
modifier|*
name|pac
parameter_list|)
block|{
name|free
argument_list|(
name|pac
operator|->
name|pac_opaque
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|pac
operator|->
name|pac_info
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|pac
operator|->
name|a_id
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|pac
operator|->
name|i_id
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|pac
operator|->
name|a_id_info
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|pac
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|struct
name|eap_fast_pac
modifier|*
name|eap_fast_get_pac
parameter_list|(
name|struct
name|eap_fast_data
modifier|*
name|data
parameter_list|,
specifier|const
name|u8
modifier|*
name|a_id
parameter_list|,
name|size_t
name|a_id_len
parameter_list|)
block|{
name|struct
name|eap_fast_pac
modifier|*
name|pac
init|=
name|data
operator|->
name|pac
decl_stmt|;
while|while
condition|(
name|pac
condition|)
block|{
if|if
condition|(
name|pac
operator|->
name|a_id_len
operator|==
name|a_id_len
operator|&&
name|memcmp
argument_list|(
name|pac
operator|->
name|a_id
argument_list|,
name|a_id
argument_list|,
name|a_id_len
argument_list|)
operator|==
literal|0
condition|)
block|{
return|return
name|pac
return|;
block|}
name|pac
operator|=
name|pac
operator|->
name|next
expr_stmt|;
block|}
return|return
name|NULL
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|eap_fast_add_pac
parameter_list|(
name|struct
name|eap_fast_data
modifier|*
name|data
parameter_list|,
name|struct
name|eap_fast_pac
modifier|*
name|entry
parameter_list|)
block|{
name|struct
name|eap_fast_pac
modifier|*
name|pac
decl_stmt|,
modifier|*
name|prev
decl_stmt|;
if|if
condition|(
name|entry
operator|==
name|NULL
operator|||
name|entry
operator|->
name|a_id
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
comment|/* Remove a possible old entry for the matching A-ID. */
name|pac
operator|=
name|data
operator|->
name|pac
expr_stmt|;
name|prev
operator|=
name|NULL
expr_stmt|;
while|while
condition|(
name|pac
condition|)
block|{
if|if
condition|(
name|pac
operator|->
name|a_id_len
operator|==
name|entry
operator|->
name|a_id_len
operator|&&
name|memcmp
argument_list|(
name|pac
operator|->
name|a_id
argument_list|,
name|entry
operator|->
name|a_id
argument_list|,
name|pac
operator|->
name|a_id_len
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|prev
operator|==
name|NULL
condition|)
block|{
name|data
operator|->
name|pac
operator|=
name|pac
operator|->
name|next
expr_stmt|;
block|}
else|else
block|{
name|prev
operator|->
name|next
operator|=
name|pac
operator|->
name|next
expr_stmt|;
block|}
if|if
condition|(
name|data
operator|->
name|current_pac
operator|==
name|pac
condition|)
name|data
operator|->
name|current_pac
operator|=
name|NULL
expr_stmt|;
name|eap_fast_free_pac
argument_list|(
name|pac
argument_list|)
expr_stmt|;
break|break;
block|}
name|prev
operator|=
name|pac
expr_stmt|;
name|pac
operator|=
name|pac
operator|->
name|next
expr_stmt|;
block|}
comment|/* Allocate a new entry and add it to the list of PACs. */
name|pac
operator|=
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|pac
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|pac
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
name|memset
argument_list|(
name|pac
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|pac
argument_list|)
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
name|pac
operator|->
name|pac_key
argument_list|,
name|entry
operator|->
name|pac_key
argument_list|,
name|EAP_FAST_PAC_KEY_LEN
argument_list|)
expr_stmt|;
if|if
condition|(
name|entry
operator|->
name|pac_opaque
condition|)
block|{
name|pac
operator|->
name|pac_opaque
operator|=
name|malloc
argument_list|(
name|entry
operator|->
name|pac_opaque_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|pac
operator|->
name|pac_opaque
operator|==
name|NULL
condition|)
block|{
name|eap_fast_free_pac
argument_list|(
name|pac
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|memcpy
argument_list|(
name|pac
operator|->
name|pac_opaque
argument_list|,
name|entry
operator|->
name|pac_opaque
argument_list|,
name|entry
operator|->
name|pac_opaque_len
argument_list|)
expr_stmt|;
name|pac
operator|->
name|pac_opaque_len
operator|=
name|entry
operator|->
name|pac_opaque_len
expr_stmt|;
block|}
if|if
condition|(
name|entry
operator|->
name|pac_info
condition|)
block|{
name|pac
operator|->
name|pac_info
operator|=
name|malloc
argument_list|(
name|entry
operator|->
name|pac_info_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|pac
operator|->
name|pac_info
operator|==
name|NULL
condition|)
block|{
name|eap_fast_free_pac
argument_list|(
name|pac
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|memcpy
argument_list|(
name|pac
operator|->
name|pac_info
argument_list|,
name|entry
operator|->
name|pac_info
argument_list|,
name|entry
operator|->
name|pac_info_len
argument_list|)
expr_stmt|;
name|pac
operator|->
name|pac_info_len
operator|=
name|entry
operator|->
name|pac_info_len
expr_stmt|;
block|}
if|if
condition|(
name|entry
operator|->
name|a_id
condition|)
block|{
name|pac
operator|->
name|a_id
operator|=
name|malloc
argument_list|(
name|entry
operator|->
name|a_id_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|pac
operator|->
name|a_id
operator|==
name|NULL
condition|)
block|{
name|eap_fast_free_pac
argument_list|(
name|pac
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|memcpy
argument_list|(
name|pac
operator|->
name|a_id
argument_list|,
name|entry
operator|->
name|a_id
argument_list|,
name|entry
operator|->
name|a_id_len
argument_list|)
expr_stmt|;
name|pac
operator|->
name|a_id_len
operator|=
name|entry
operator|->
name|a_id_len
expr_stmt|;
block|}
if|if
condition|(
name|entry
operator|->
name|i_id
condition|)
block|{
name|pac
operator|->
name|i_id
operator|=
name|malloc
argument_list|(
name|entry
operator|->
name|i_id_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|pac
operator|->
name|i_id
operator|==
name|NULL
condition|)
block|{
name|eap_fast_free_pac
argument_list|(
name|pac
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|memcpy
argument_list|(
name|pac
operator|->
name|i_id
argument_list|,
name|entry
operator|->
name|i_id
argument_list|,
name|entry
operator|->
name|i_id_len
argument_list|)
expr_stmt|;
name|pac
operator|->
name|i_id_len
operator|=
name|entry
operator|->
name|i_id_len
expr_stmt|;
block|}
if|if
condition|(
name|entry
operator|->
name|a_id_info
condition|)
block|{
name|pac
operator|->
name|a_id_info
operator|=
name|malloc
argument_list|(
name|entry
operator|->
name|a_id_info_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|pac
operator|->
name|a_id_info
operator|==
name|NULL
condition|)
block|{
name|eap_fast_free_pac
argument_list|(
name|pac
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|memcpy
argument_list|(
name|pac
operator|->
name|a_id_info
argument_list|,
name|entry
operator|->
name|a_id_info
argument_list|,
name|entry
operator|->
name|a_id_info_len
argument_list|)
expr_stmt|;
name|pac
operator|->
name|a_id_info_len
operator|=
name|entry
operator|->
name|a_id_info_len
expr_stmt|;
block|}
name|pac
operator|->
name|next
operator|=
name|data
operator|->
name|pac
expr_stmt|;
name|data
operator|->
name|pac
operator|=
name|pac
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_struct
struct|struct
name|eap_fast_read_ctx
block|{
name|FILE
modifier|*
name|f
decl_stmt|;
specifier|const
name|char
modifier|*
name|pos
decl_stmt|;
specifier|const
name|char
modifier|*
name|end
decl_stmt|;
block|}
struct|;
end_struct

begin_function
specifier|static
name|int
name|eap_fast_read_line
parameter_list|(
name|struct
name|eap_fast_read_ctx
modifier|*
name|rc
parameter_list|,
name|char
modifier|*
name|buf
parameter_list|,
name|size_t
name|buf_len
parameter_list|)
block|{
name|char
modifier|*
name|pos
decl_stmt|;
if|if
condition|(
name|rc
operator|->
name|f
condition|)
block|{
if|if
condition|(
name|fgets
argument_list|(
name|buf
argument_list|,
name|buf_len
argument_list|,
name|rc
operator|->
name|f
argument_list|)
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
block|}
else|else
block|{
specifier|const
name|char
modifier|*
name|l_end
decl_stmt|;
name|size_t
name|len
decl_stmt|;
if|if
condition|(
name|rc
operator|->
name|pos
operator|>=
name|rc
operator|->
name|end
condition|)
return|return
operator|-
literal|1
return|;
name|l_end
operator|=
name|rc
operator|->
name|pos
expr_stmt|;
while|while
condition|(
name|l_end
operator|<
name|rc
operator|->
name|end
operator|&&
operator|*
name|l_end
operator|!=
literal|'\n'
condition|)
name|l_end
operator|++
expr_stmt|;
name|len
operator|=
name|l_end
operator|-
name|rc
operator|->
name|pos
expr_stmt|;
if|if
condition|(
name|len
operator|>=
name|buf_len
condition|)
name|len
operator|=
name|buf_len
operator|-
literal|1
expr_stmt|;
name|memcpy
argument_list|(
name|buf
argument_list|,
name|rc
operator|->
name|pos
argument_list|,
name|len
argument_list|)
expr_stmt|;
name|buf
index|[
name|len
index|]
operator|=
literal|'\0'
expr_stmt|;
name|rc
operator|->
name|pos
operator|=
name|l_end
operator|+
literal|1
expr_stmt|;
block|}
name|buf
index|[
name|buf_len
operator|-
literal|1
index|]
operator|=
literal|'\0'
expr_stmt|;
name|pos
operator|=
name|buf
expr_stmt|;
while|while
condition|(
operator|*
name|pos
operator|!=
literal|'\0'
condition|)
block|{
if|if
condition|(
operator|*
name|pos
operator|==
literal|'\n'
operator|||
operator|*
name|pos
operator|==
literal|'\r'
condition|)
block|{
operator|*
name|pos
operator|=
literal|'\0'
expr_stmt|;
break|break;
block|}
name|pos
operator|++
expr_stmt|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|u8
modifier|*
name|eap_fast_parse_hex
parameter_list|(
specifier|const
name|char
modifier|*
name|value
parameter_list|,
name|size_t
modifier|*
name|len
parameter_list|)
block|{
name|int
name|hlen
decl_stmt|;
name|u8
modifier|*
name|buf
decl_stmt|;
if|if
condition|(
name|value
operator|==
name|NULL
condition|)
return|return
name|NULL
return|;
name|hlen
operator|=
name|strlen
argument_list|(
name|value
argument_list|)
expr_stmt|;
if|if
condition|(
name|hlen
operator|&
literal|1
condition|)
return|return
name|NULL
return|;
operator|*
name|len
operator|=
name|hlen
operator|/
literal|2
expr_stmt|;
name|buf
operator|=
name|malloc
argument_list|(
operator|*
name|len
argument_list|)
expr_stmt|;
if|if
condition|(
name|buf
operator|==
name|NULL
condition|)
return|return
name|NULL
return|;
if|if
condition|(
name|hexstr2bin
argument_list|(
name|value
argument_list|,
name|buf
argument_list|,
operator|*
name|len
argument_list|)
condition|)
block|{
name|free
argument_list|(
name|buf
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
return|return
name|buf
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|eap_fast_load_pac
parameter_list|(
name|struct
name|eap_sm
modifier|*
name|sm
parameter_list|,
name|struct
name|eap_fast_data
modifier|*
name|data
parameter_list|,
specifier|const
name|char
modifier|*
name|pac_file
parameter_list|)
block|{
name|struct
name|eap_fast_read_ctx
name|rc
decl_stmt|;
name|struct
name|eap_fast_pac
modifier|*
name|pac
init|=
name|NULL
decl_stmt|;
name|int
name|count
init|=
literal|0
decl_stmt|;
name|char
modifier|*
name|buf
decl_stmt|,
modifier|*
name|pos
decl_stmt|;
specifier|const
name|int
name|buf_len
init|=
literal|2048
decl_stmt|;
name|int
name|ret
init|=
literal|0
decl_stmt|,
name|line
init|=
literal|0
decl_stmt|;
if|if
condition|(
name|pac_file
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
name|memset
argument_list|(
operator|&
name|rc
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|rc
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|strncmp
argument_list|(
name|pac_file
argument_list|,
literal|"blob://"
argument_list|,
literal|7
argument_list|)
operator|==
literal|0
condition|)
block|{
specifier|const
name|struct
name|wpa_config_blob
modifier|*
name|blob
decl_stmt|;
name|blob
operator|=
name|eap_get_config_blob
argument_list|(
name|sm
argument_list|,
name|pac_file
operator|+
literal|7
argument_list|)
expr_stmt|;
if|if
condition|(
name|blob
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"EAP-FAST: No PAC blob '%s' - "
literal|"assume no PAC entries have been "
literal|"provisioned"
argument_list|,
name|pac_file
operator|+
literal|7
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
name|rc
operator|.
name|pos
operator|=
operator|(
name|char
operator|*
operator|)
name|blob
operator|->
name|data
expr_stmt|;
name|rc
operator|.
name|end
operator|=
operator|(
name|char
operator|*
operator|)
name|blob
operator|->
name|data
operator|+
name|blob
operator|->
name|len
expr_stmt|;
block|}
else|else
block|{
name|rc
operator|.
name|f
operator|=
name|fopen
argument_list|(
name|pac_file
argument_list|,
literal|"r"
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
operator|.
name|f
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"EAP-FAST: No PAC file '%s' - "
literal|"assume no PAC entries have been "
literal|"provisioned"
argument_list|,
name|pac_file
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
block|}
name|buf
operator|=
name|malloc
argument_list|(
name|buf_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|buf
operator|==
name|NULL
condition|)
block|{
return|return
operator|-
literal|1
return|;
block|}
name|line
operator|++
expr_stmt|;
if|if
condition|(
name|eap_fast_read_line
argument_list|(
operator|&
name|rc
argument_list|,
name|buf
argument_list|,
name|buf_len
argument_list|)
operator|<
literal|0
operator|||
name|strcmp
argument_list|(
name|pac_file_hdr
argument_list|,
name|buf
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"EAP-FAST: Unrecognized header line in "
literal|"PAC file '%s'"
argument_list|,
name|pac_file
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|buf
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
operator|.
name|f
condition|)
name|fclose
argument_list|(
name|rc
operator|.
name|f
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
while|while
condition|(
name|eap_fast_read_line
argument_list|(
operator|&
name|rc
argument_list|,
name|buf
argument_list|,
name|buf_len
argument_list|)
operator|==
literal|0
condition|)
block|{
name|line
operator|++
expr_stmt|;
name|pos
operator|=
name|strchr
argument_list|(
name|buf
argument_list|,
literal|'='
argument_list|)
expr_stmt|;
if|if
condition|(
name|pos
condition|)
block|{
operator|*
name|pos
operator|++
operator|=
literal|'\0'
expr_stmt|;
block|}
if|if
condition|(
name|strcmp
argument_list|(
name|buf
argument_list|,
literal|"START"
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|pac
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"EAP-FAST: START line "
literal|"without END in '%s:%d'"
argument_list|,
name|pac_file
argument_list|,
name|line
argument_list|)
expr_stmt|;
name|ret
operator|=
operator|-
literal|1
expr_stmt|;
break|break;
block|}
name|pac
operator|=
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|pac
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|pac
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"EAP-FAST: No memory for "
literal|"PAC entry"
argument_list|)
expr_stmt|;
name|ret
operator|=
operator|-
literal|1
expr_stmt|;
break|break;
block|}
name|memset
argument_list|(
name|pac
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|pac
argument_list|)
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|buf
argument_list|,
literal|"END"
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|pac
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"EAP-FAST: END line "
literal|"without START in '%s:%d'"
argument_list|,
name|pac_file
argument_list|,
name|line
argument_list|)
expr_stmt|;
name|ret
operator|=
operator|-
literal|1
expr_stmt|;
break|break;
block|}
name|pac
operator|->
name|next
operator|=
name|data
operator|->
name|pac
expr_stmt|;
name|data
operator|->
name|pac
operator|=
name|pac
expr_stmt|;
name|pac
operator|=
name|NULL
expr_stmt|;
name|count
operator|++
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|pac
operator|&&
name|strcmp
argument_list|(
name|buf
argument_list|,
literal|"PAC-Key"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|u8
modifier|*
name|key
decl_stmt|;
name|size_t
name|key_len
decl_stmt|;
name|key
operator|=
name|eap_fast_parse_hex
argument_list|(
name|pos
argument_list|,
operator|&
name|key_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|key
operator|==
name|NULL
operator|||
name|key_len
operator|!=
name|EAP_FAST_PAC_KEY_LEN
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"EAP-FAST: Invalid "
literal|"PAC-Key '%s:%d'"
argument_list|,
name|pac_file
argument_list|,
name|line
argument_list|)
expr_stmt|;
name|ret
operator|=
operator|-
literal|1
expr_stmt|;
name|free
argument_list|(
name|key
argument_list|)
expr_stmt|;
break|break;
block|}
name|memcpy
argument_list|(
name|pac
operator|->
name|pac_key
argument_list|,
name|key
argument_list|,
name|EAP_FAST_PAC_KEY_LEN
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|key
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|pac
operator|&&
name|strcmp
argument_list|(
name|buf
argument_list|,
literal|"PAC-Opaque"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|pac
operator|->
name|pac_opaque
operator|=
name|eap_fast_parse_hex
argument_list|(
name|pos
argument_list|,
operator|&
name|pac
operator|->
name|pac_opaque_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|pac
operator|->
name|pac_opaque
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"EAP-FAST: Invalid "
literal|"PAC-Opaque '%s:%d'"
argument_list|,
name|pac_file
argument_list|,
name|line
argument_list|)
expr_stmt|;
name|ret
operator|=
operator|-
literal|1
expr_stmt|;
break|break;
block|}
block|}
elseif|else
if|if
condition|(
name|pac
operator|&&
name|strcmp
argument_list|(
name|buf
argument_list|,
literal|"A-ID"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|pac
operator|->
name|a_id
operator|=
name|eap_fast_parse_hex
argument_list|(
name|pos
argument_list|,
operator|&
name|pac
operator|->
name|a_id_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|pac
operator|->
name|a_id
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"EAP-FAST: Invalid "
literal|"A-ID '%s:%d'"
argument_list|,
name|pac_file
argument_list|,
name|line
argument_list|)
expr_stmt|;
name|ret
operator|=
operator|-
literal|1
expr_stmt|;
break|break;
block|}
block|}
elseif|else
if|if
condition|(
name|pac
operator|&&
name|strcmp
argument_list|(
name|buf
argument_list|,
literal|"I-ID"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|pac
operator|->
name|i_id
operator|=
name|eap_fast_parse_hex
argument_list|(
name|pos
argument_list|,
operator|&
name|pac
operator|->
name|i_id_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|pac
operator|->
name|i_id
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"EAP-FAST: Invalid "
literal|"I-ID '%s:%d'"
argument_list|,
name|pac_file
argument_list|,
name|line
argument_list|)
expr_stmt|;
name|ret
operator|=
operator|-
literal|1
expr_stmt|;
break|break;
block|}
block|}
elseif|else
if|if
condition|(
name|pac
operator|&&
name|strcmp
argument_list|(
name|buf
argument_list|,
literal|"A-ID-Info"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|pac
operator|->
name|a_id_info
operator|=
name|eap_fast_parse_hex
argument_list|(
name|pos
argument_list|,
operator|&
name|pac
operator|->
name|a_id_info_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|pac
operator|->
name|a_id_info
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"EAP-FAST: Invalid "
literal|"A-ID-Info '%s:%d'"
argument_list|,
name|pac_file
argument_list|,
name|line
argument_list|)
expr_stmt|;
name|ret
operator|=
operator|-
literal|1
expr_stmt|;
break|break;
block|}
block|}
block|}
if|if
condition|(
name|pac
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"EAP-FAST: PAC block not terminated with "
literal|"END in '%s'"
argument_list|,
name|pac_file
argument_list|)
expr_stmt|;
name|eap_fast_free_pac
argument_list|(
name|pac
argument_list|)
expr_stmt|;
name|ret
operator|=
operator|-
literal|1
expr_stmt|;
block|}
name|free
argument_list|(
name|buf
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
operator|.
name|f
condition|)
name|fclose
argument_list|(
name|rc
operator|.
name|f
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|==
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"EAP-FAST: read %d PAC entries from "
literal|"'%s'"
argument_list|,
name|count
argument_list|,
name|pac_file
argument_list|)
expr_stmt|;
block|}
return|return
name|ret
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|eap_fast_write
parameter_list|(
name|char
modifier|*
modifier|*
name|buf
parameter_list|,
name|char
modifier|*
modifier|*
name|pos
parameter_list|,
name|size_t
modifier|*
name|buf_len
parameter_list|,
specifier|const
name|char
modifier|*
name|field
parameter_list|,
specifier|const
name|u8
modifier|*
name|data
parameter_list|,
name|size_t
name|len
parameter_list|,
name|int
name|txt
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
name|size_t
name|need
decl_stmt|;
if|if
condition|(
name|data
operator|==
name|NULL
operator|||
operator|*
name|buf
operator|==
name|NULL
condition|)
return|return;
name|need
operator|=
name|strlen
argument_list|(
name|field
argument_list|)
operator|+
name|len
operator|*
literal|2
operator|+
literal|30
expr_stmt|;
if|if
condition|(
name|txt
condition|)
name|need
operator|+=
name|strlen
argument_list|(
name|field
argument_list|)
operator|+
name|len
operator|+
literal|20
expr_stmt|;
if|if
condition|(
operator|*
name|pos
operator|-
operator|*
name|buf
operator|+
name|need
operator|>
operator|*
name|buf_len
condition|)
block|{
name|char
modifier|*
name|nbuf
init|=
name|realloc
argument_list|(
operator|*
name|buf
argument_list|,
operator|*
name|buf_len
operator|+
name|need
argument_list|)
decl_stmt|;
if|if
condition|(
name|nbuf
operator|==
name|NULL
condition|)
block|{
name|free
argument_list|(
operator|*
name|buf
argument_list|)
expr_stmt|;
operator|*
name|buf
operator|=
name|NULL
expr_stmt|;
return|return;
block|}
operator|*
name|buf
operator|=
name|nbuf
expr_stmt|;
operator|*
name|buf_len
operator|+=
name|need
expr_stmt|;
block|}
operator|*
name|pos
operator|+=
name|snprintf
argument_list|(
operator|*
name|pos
argument_list|,
operator|*
name|buf
operator|+
operator|*
name|buf_len
operator|-
operator|*
name|pos
argument_list|,
literal|"%s="
argument_list|,
name|field
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|len
condition|;
name|i
operator|++
control|)
block|{
operator|*
name|pos
operator|+=
name|snprintf
argument_list|(
operator|*
name|pos
argument_list|,
operator|*
name|buf
operator|+
operator|*
name|buf_len
operator|-
operator|*
name|pos
argument_list|,
literal|"%02x"
argument_list|,
name|data
index|[
name|i
index|]
argument_list|)
expr_stmt|;
block|}
operator|*
name|pos
operator|+=
name|snprintf
argument_list|(
operator|*
name|pos
argument_list|,
operator|*
name|buf
operator|+
operator|*
name|buf_len
operator|-
operator|*
name|pos
argument_list|,
literal|"\n"
argument_list|)
expr_stmt|;
if|if
condition|(
name|txt
condition|)
block|{
operator|*
name|pos
operator|+=
name|snprintf
argument_list|(
operator|*
name|pos
argument_list|,
operator|*
name|buf
operator|+
operator|*
name|buf_len
operator|-
operator|*
name|pos
argument_list|,
literal|"%s-txt="
argument_list|,
name|field
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|len
condition|;
name|i
operator|++
control|)
block|{
operator|*
name|pos
operator|+=
name|snprintf
argument_list|(
operator|*
name|pos
argument_list|,
operator|*
name|buf
operator|+
operator|*
name|buf_len
operator|-
operator|*
name|pos
argument_list|,
literal|"%c"
argument_list|,
name|data
index|[
name|i
index|]
argument_list|)
expr_stmt|;
block|}
operator|*
name|pos
operator|+=
name|snprintf
argument_list|(
operator|*
name|pos
argument_list|,
operator|*
name|buf
operator|+
operator|*
name|buf_len
operator|-
operator|*
name|pos
argument_list|,
literal|"\n"
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|int
name|eap_fast_save_pac
parameter_list|(
name|struct
name|eap_sm
modifier|*
name|sm
parameter_list|,
name|struct
name|eap_fast_data
modifier|*
name|data
parameter_list|,
specifier|const
name|char
modifier|*
name|pac_file
parameter_list|)
block|{
name|FILE
modifier|*
name|f
decl_stmt|;
name|struct
name|eap_fast_pac
modifier|*
name|pac
decl_stmt|;
name|int
name|count
init|=
literal|0
decl_stmt|;
name|char
modifier|*
name|buf
decl_stmt|,
modifier|*
name|pos
decl_stmt|;
name|size_t
name|buf_len
decl_stmt|;
if|if
condition|(
name|pac_file
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
name|buf_len
operator|=
literal|1024
expr_stmt|;
name|pos
operator|=
name|buf
operator|=
name|malloc
argument_list|(
name|buf_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|buf
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
name|pos
operator|+=
name|snprintf
argument_list|(
name|pos
argument_list|,
name|buf
operator|+
name|buf_len
operator|-
name|pos
argument_list|,
literal|"%s\n"
argument_list|,
name|pac_file_hdr
argument_list|)
expr_stmt|;
name|pac
operator|=
name|data
operator|->
name|pac
expr_stmt|;
while|while
condition|(
name|pac
condition|)
block|{
name|pos
operator|+=
name|snprintf
argument_list|(
name|pos
argument_list|,
name|buf
operator|+
name|buf_len
operator|-
name|pos
argument_list|,
literal|"START\n"
argument_list|)
expr_stmt|;
name|eap_fast_write
argument_list|(
operator|&
name|buf
argument_list|,
operator|&
name|pos
argument_list|,
operator|&
name|buf_len
argument_list|,
literal|"PAC-Key"
argument_list|,
name|pac
operator|->
name|pac_key
argument_list|,
name|EAP_FAST_PAC_KEY_LEN
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|eap_fast_write
argument_list|(
operator|&
name|buf
argument_list|,
operator|&
name|pos
argument_list|,
operator|&
name|buf_len
argument_list|,
literal|"PAC-Opaque"
argument_list|,
name|pac
operator|->
name|pac_opaque
argument_list|,
name|pac
operator|->
name|pac_opaque_len
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|eap_fast_write
argument_list|(
operator|&
name|buf
argument_list|,
operator|&
name|pos
argument_list|,
operator|&
name|buf_len
argument_list|,
literal|"PAC-Info"
argument_list|,
name|pac
operator|->
name|pac_info
argument_list|,
name|pac
operator|->
name|pac_info_len
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|eap_fast_write
argument_list|(
operator|&
name|buf
argument_list|,
operator|&
name|pos
argument_list|,
operator|&
name|buf_len
argument_list|,
literal|"A-ID"
argument_list|,
name|pac
operator|->
name|a_id
argument_list|,
name|pac
operator|->
name|a_id_len
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|eap_fast_write
argument_list|(
operator|&
name|buf
argument_list|,
operator|&
name|pos
argument_list|,
operator|&
name|buf_len
argument_list|,
literal|"I-ID"
argument_list|,
name|pac
operator|->
name|i_id
argument_list|,
name|pac
operator|->
name|i_id_len
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|eap_fast_write
argument_list|(
operator|&
name|buf
argument_list|,
operator|&
name|pos
argument_list|,
operator|&
name|buf_len
argument_list|,
literal|"A-ID-Info"
argument_list|,
name|pac
operator|->
name|a_id_info
argument_list|,
name|pac
operator|->
name|a_id_info_len
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|pos
operator|+=
name|snprintf
argument_list|(
name|pos
argument_list|,
name|buf
operator|+
name|buf_len
operator|-
name|pos
argument_list|,
literal|"END\n"
argument_list|)
expr_stmt|;
name|count
operator|++
expr_stmt|;
name|pac
operator|=
name|pac
operator|->
name|next
expr_stmt|;
if|if
condition|(
name|buf
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"EAP-FAST: No memory for PAC "
literal|"data"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
block|}
if|if
condition|(
name|strncmp
argument_list|(
name|pac_file
argument_list|,
literal|"blob://"
argument_list|,
literal|7
argument_list|)
operator|==
literal|0
condition|)
block|{
name|struct
name|wpa_config_blob
modifier|*
name|blob
decl_stmt|;
name|blob
operator|=
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|blob
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|blob
operator|==
name|NULL
condition|)
block|{
name|free
argument_list|(
name|buf
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|memset
argument_list|(
name|blob
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|blob
argument_list|)
argument_list|)
expr_stmt|;
name|blob
operator|->
name|data
operator|=
operator|(
name|u8
operator|*
operator|)
name|buf
expr_stmt|;
name|blob
operator|->
name|len
operator|=
name|pos
operator|-
name|buf
expr_stmt|;
name|buf
operator|=
name|NULL
expr_stmt|;
name|blob
operator|->
name|name
operator|=
name|strdup
argument_list|(
name|pac_file
operator|+
literal|7
argument_list|)
expr_stmt|;
if|if
condition|(
name|blob
operator|->
name|name
operator|==
name|NULL
condition|)
block|{
name|wpa_config_free_blob
argument_list|(
name|blob
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|eap_set_config_blob
argument_list|(
name|sm
argument_list|,
name|blob
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|f
operator|=
name|fopen
argument_list|(
name|pac_file
argument_list|,
literal|"w"
argument_list|)
expr_stmt|;
if|if
condition|(
name|f
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"EAP-FAST: Failed to open PAC "
literal|"file '%s' for writing"
argument_list|,
name|pac_file
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|buf
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|fprintf
argument_list|(
name|f
argument_list|,
literal|"%s"
argument_list|,
name|buf
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|buf
argument_list|)
expr_stmt|;
name|fclose
argument_list|(
name|f
argument_list|)
expr_stmt|;
block|}
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"EAP-FAST: wrote %d PAC entries into '%s'"
argument_list|,
name|count
argument_list|,
name|pac_file
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|void
modifier|*
name|eap_fast_init
parameter_list|(
name|struct
name|eap_sm
modifier|*
name|sm
parameter_list|)
block|{
name|struct
name|eap_fast_data
modifier|*
name|data
decl_stmt|;
name|struct
name|wpa_ssid
modifier|*
name|config
init|=
name|eap_get_config
argument_list|(
name|sm
argument_list|)
decl_stmt|;
name|data
operator|=
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|data
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|data
operator|==
name|NULL
condition|)
return|return
name|NULL
return|;
name|memset
argument_list|(
name|data
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|data
argument_list|)
argument_list|)
expr_stmt|;
name|data
operator|->
name|fast_version
operator|=
name|EAP_FAST_VERSION
expr_stmt|;
if|if
condition|(
name|config
operator|&&
name|config
operator|->
name|phase1
condition|)
block|{
if|if
condition|(
name|strstr
argument_list|(
name|config
operator|->
name|phase1
argument_list|,
literal|"fast_provisioning=1"
argument_list|)
condition|)
block|{
name|data
operator|->
name|provisioning_allowed
operator|=
literal|1
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"EAP-FAST: Automatic PAC "
literal|"provisioning is allowed"
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
name|config
operator|&&
name|config
operator|->
name|phase2
condition|)
block|{
name|char
modifier|*
name|start
decl_stmt|,
modifier|*
name|pos
decl_stmt|,
modifier|*
name|buf
decl_stmt|;
name|u8
name|method
decl_stmt|,
modifier|*
name|methods
init|=
name|NULL
decl_stmt|,
modifier|*
name|_methods
decl_stmt|;
name|size_t
name|num_methods
init|=
literal|0
decl_stmt|;
name|start
operator|=
name|buf
operator|=
name|strdup
argument_list|(
name|config
operator|->
name|phase2
argument_list|)
expr_stmt|;
if|if
condition|(
name|buf
operator|==
name|NULL
condition|)
block|{
name|eap_fast_deinit
argument_list|(
name|sm
argument_list|,
name|data
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
while|while
condition|(
name|start
operator|&&
operator|*
name|start
operator|!=
literal|'\0'
condition|)
block|{
name|pos
operator|=
name|strstr
argument_list|(
name|start
argument_list|,
literal|"auth="
argument_list|)
expr_stmt|;
if|if
condition|(
name|pos
operator|==
name|NULL
condition|)
break|break;
if|if
condition|(
name|start
operator|!=
name|pos
operator|&&
operator|*
operator|(
name|pos
operator|-
literal|1
operator|)
operator|!=
literal|' '
condition|)
block|{
name|start
operator|=
name|pos
operator|+
literal|5
expr_stmt|;
continue|continue;
block|}
name|start
operator|=
name|pos
operator|+
literal|5
expr_stmt|;
name|pos
operator|=
name|strchr
argument_list|(
name|start
argument_list|,
literal|' '
argument_list|)
expr_stmt|;
if|if
condition|(
name|pos
condition|)
operator|*
name|pos
operator|++
operator|=
literal|'\0'
expr_stmt|;
name|method
operator|=
name|eap_get_phase2_type
argument_list|(
name|start
argument_list|)
expr_stmt|;
if|if
condition|(
name|method
operator|==
name|EAP_TYPE_NONE
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"EAP-FAST: Unsupported "
literal|"Phase2 method '%s'"
argument_list|,
name|start
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|num_methods
operator|++
expr_stmt|;
name|_methods
operator|=
name|realloc
argument_list|(
name|methods
argument_list|,
name|num_methods
argument_list|)
expr_stmt|;
if|if
condition|(
name|_methods
operator|==
name|NULL
condition|)
block|{
name|free
argument_list|(
name|methods
argument_list|)
expr_stmt|;
name|eap_fast_deinit
argument_list|(
name|sm
argument_list|,
name|data
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|methods
operator|=
name|_methods
expr_stmt|;
name|methods
index|[
name|num_methods
operator|-
literal|1
index|]
operator|=
name|method
expr_stmt|;
block|}
name|start
operator|=
name|pos
expr_stmt|;
block|}
name|free
argument_list|(
name|buf
argument_list|)
expr_stmt|;
name|data
operator|->
name|phase2_types
operator|=
name|methods
expr_stmt|;
name|data
operator|->
name|num_phase2_types
operator|=
name|num_methods
expr_stmt|;
block|}
if|if
condition|(
name|data
operator|->
name|phase2_types
operator|==
name|NULL
condition|)
block|{
name|data
operator|->
name|phase2_types
operator|=
name|eap_get_phase2_types
argument_list|(
name|config
argument_list|,
operator|&
name|data
operator|->
name|num_phase2_types
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|data
operator|->
name|phase2_types
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"EAP-FAST: No Phase2 method available"
argument_list|)
expr_stmt|;
name|eap_fast_deinit
argument_list|(
name|sm
argument_list|,
name|data
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|wpa_hexdump
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"EAP-FAST: Phase2 EAP types"
argument_list|,
name|data
operator|->
name|phase2_types
argument_list|,
name|data
operator|->
name|num_phase2_types
argument_list|)
expr_stmt|;
name|data
operator|->
name|phase2_type
operator|=
name|EAP_TYPE_NONE
expr_stmt|;
if|if
condition|(
name|eap_tls_ssl_init
argument_list|(
name|sm
argument_list|,
operator|&
name|data
operator|->
name|ssl
argument_list|,
name|config
argument_list|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"EAP-FAST: Failed to initialize SSL."
argument_list|)
expr_stmt|;
name|eap_fast_deinit
argument_list|(
name|sm
argument_list|,
name|data
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
comment|/* The local RADIUS server in a Cisco AP does not seem to like empty 	 * fragments before data, so disable that workaround for CBC. 	 * TODO: consider making this configurable */
name|tls_connection_enable_workaround
argument_list|(
name|sm
operator|->
name|ssl_ctx
argument_list|,
name|data
operator|->
name|ssl
operator|.
name|conn
argument_list|)
expr_stmt|;
if|if
condition|(
name|eap_fast_load_pac
argument_list|(
name|sm
argument_list|,
name|data
argument_list|,
name|config
operator|->
name|pac_file
argument_list|)
operator|<
literal|0
condition|)
block|{
name|eap_fast_deinit
argument_list|(
name|sm
argument_list|,
name|data
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
if|if
condition|(
name|data
operator|->
name|pac
operator|==
name|NULL
operator|&&
operator|!
name|data
operator|->
name|provisioning_allowed
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"EAP-FAST: No PAC configured and "
literal|"provisioning disabled"
argument_list|)
expr_stmt|;
name|eap_fast_deinit
argument_list|(
name|sm
argument_list|,
name|data
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
return|return
name|data
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|eap_fast_deinit
parameter_list|(
name|struct
name|eap_sm
modifier|*
name|sm
parameter_list|,
name|void
modifier|*
name|priv
parameter_list|)
block|{
name|struct
name|eap_fast_data
modifier|*
name|data
init|=
name|priv
decl_stmt|;
name|struct
name|eap_fast_pac
modifier|*
name|pac
decl_stmt|,
modifier|*
name|prev
decl_stmt|;
if|if
condition|(
name|data
operator|==
name|NULL
condition|)
return|return;
if|if
condition|(
name|data
operator|->
name|phase2_priv
operator|&&
name|data
operator|->
name|phase2_method
condition|)
name|data
operator|->
name|phase2_method
operator|->
name|deinit
argument_list|(
name|sm
argument_list|,
name|data
operator|->
name|phase2_priv
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|data
operator|->
name|phase2_types
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|data
operator|->
name|key_block_a
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|data
operator|->
name|key_block_p
argument_list|)
expr_stmt|;
name|eap_tls_ssl_deinit
argument_list|(
name|sm
argument_list|,
operator|&
name|data
operator|->
name|ssl
argument_list|)
expr_stmt|;
name|pac
operator|=
name|data
operator|->
name|pac
expr_stmt|;
name|prev
operator|=
name|NULL
expr_stmt|;
while|while
condition|(
name|pac
condition|)
block|{
name|prev
operator|=
name|pac
expr_stmt|;
name|pac
operator|=
name|pac
operator|->
name|next
expr_stmt|;
name|eap_fast_free_pac
argument_list|(
name|prev
argument_list|)
expr_stmt|;
block|}
name|free
argument_list|(
name|data
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|eap_fast_encrypt
parameter_list|(
name|struct
name|eap_sm
modifier|*
name|sm
parameter_list|,
name|struct
name|eap_fast_data
modifier|*
name|data
parameter_list|,
name|int
name|id
parameter_list|,
specifier|const
name|u8
modifier|*
name|plain
parameter_list|,
name|size_t
name|plain_len
parameter_list|,
name|u8
modifier|*
modifier|*
name|out_data
parameter_list|,
name|size_t
modifier|*
name|out_len
parameter_list|)
block|{
name|int
name|res
decl_stmt|;
name|u8
modifier|*
name|pos
decl_stmt|;
name|struct
name|eap_hdr
modifier|*
name|resp
decl_stmt|;
comment|/* TODO: add support for fragmentation, if needed. This will need to 	 * add TLS Message Length field, if the frame is fragmented. */
name|resp
operator|=
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
expr|struct
name|eap_hdr
argument_list|)
operator|+
literal|2
operator|+
name|data
operator|->
name|ssl
operator|.
name|tls_out_limit
argument_list|)
expr_stmt|;
if|if
condition|(
name|resp
operator|==
name|NULL
condition|)
return|return
literal|0
return|;
name|resp
operator|->
name|code
operator|=
name|EAP_CODE_RESPONSE
expr_stmt|;
name|resp
operator|->
name|identifier
operator|=
name|id
expr_stmt|;
name|pos
operator|=
operator|(
name|u8
operator|*
operator|)
operator|(
name|resp
operator|+
literal|1
operator|)
expr_stmt|;
operator|*
name|pos
operator|++
operator|=
name|EAP_TYPE_FAST
expr_stmt|;
operator|*
name|pos
operator|++
operator|=
name|data
operator|->
name|fast_version
expr_stmt|;
name|res
operator|=
name|tls_connection_encrypt
argument_list|(
name|sm
operator|->
name|ssl_ctx
argument_list|,
name|data
operator|->
name|ssl
operator|.
name|conn
argument_list|,
name|plain
argument_list|,
name|plain_len
argument_list|,
name|pos
argument_list|,
name|data
operator|->
name|ssl
operator|.
name|tls_out_limit
argument_list|)
expr_stmt|;
if|if
condition|(
name|res
operator|<
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"EAP-FAST: Failed to encrypt Phase 2 "
literal|"data"
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|resp
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
operator|*
name|out_len
operator|=
sizeof|sizeof
argument_list|(
expr|struct
name|eap_hdr
argument_list|)
operator|+
literal|2
operator|+
name|res
expr_stmt|;
name|resp
operator|->
name|length
operator|=
name|host_to_be16
argument_list|(
operator|*
name|out_len
argument_list|)
expr_stmt|;
operator|*
name|out_data
operator|=
operator|(
name|u8
operator|*
operator|)
name|resp
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|eap_fast_phase2_nak
parameter_list|(
name|struct
name|eap_sm
modifier|*
name|sm
parameter_list|,
name|struct
name|eap_fast_data
modifier|*
name|data
parameter_list|,
name|struct
name|eap_hdr
modifier|*
name|hdr
parameter_list|,
name|u8
modifier|*
modifier|*
name|resp
parameter_list|,
name|size_t
modifier|*
name|resp_len
parameter_list|)
block|{
name|struct
name|eap_hdr
modifier|*
name|resp_hdr
decl_stmt|;
name|u8
modifier|*
name|pos
init|=
operator|(
name|u8
operator|*
operator|)
operator|(
name|hdr
operator|+
literal|1
operator|)
decl_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"EAP-FAST: Phase 2 Request: Nak type=%d"
argument_list|,
operator|*
name|pos
argument_list|)
expr_stmt|;
name|wpa_hexdump
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"EAP-FAST: Allowed Phase2 EAP types"
argument_list|,
name|data
operator|->
name|phase2_types
argument_list|,
name|data
operator|->
name|num_phase2_types
argument_list|)
expr_stmt|;
operator|*
name|resp_len
operator|=
sizeof|sizeof
argument_list|(
expr|struct
name|eap_hdr
argument_list|)
operator|+
literal|1
operator|+
name|data
operator|->
name|num_phase2_types
expr_stmt|;
operator|*
name|resp
operator|=
name|malloc
argument_list|(
operator|*
name|resp_len
argument_list|)
expr_stmt|;
if|if
condition|(
operator|*
name|resp
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
name|resp_hdr
operator|=
operator|(
expr|struct
name|eap_hdr
operator|*
operator|)
operator|(
operator|*
name|resp
operator|)
expr_stmt|;
name|resp_hdr
operator|->
name|code
operator|=
name|EAP_CODE_RESPONSE
expr_stmt|;
name|resp_hdr
operator|->
name|identifier
operator|=
name|hdr
operator|->
name|identifier
expr_stmt|;
name|resp_hdr
operator|->
name|length
operator|=
name|host_to_be16
argument_list|(
operator|*
name|resp_len
argument_list|)
expr_stmt|;
name|pos
operator|=
operator|(
name|u8
operator|*
operator|)
operator|(
name|resp_hdr
operator|+
literal|1
operator|)
expr_stmt|;
operator|*
name|pos
operator|++
operator|=
name|EAP_TYPE_NAK
expr_stmt|;
name|memcpy
argument_list|(
name|pos
argument_list|,
name|data
operator|->
name|phase2_types
argument_list|,
name|data
operator|->
name|num_phase2_types
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|eap_fast_derive_msk
parameter_list|(
name|struct
name|eap_sm
modifier|*
name|sm
parameter_list|,
name|struct
name|eap_fast_data
modifier|*
name|data
parameter_list|)
block|{
name|u8
name|isk
index|[
literal|32
index|]
decl_stmt|;
name|u8
name|imck
index|[
literal|60
index|]
decl_stmt|;
if|if
condition|(
name|data
operator|->
name|key_block_a
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
name|memset
argument_list|(
name|isk
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|isk
argument_list|)
argument_list|)
expr_stmt|;
name|sha1_t_prf
argument_list|(
name|data
operator|->
name|key_block_a
operator|->
name|session_key_seed
argument_list|,
sizeof|sizeof
argument_list|(
name|data
operator|->
name|key_block_a
operator|->
name|session_key_seed
argument_list|)
argument_list|,
literal|"Inner Methods Compound Keys"
argument_list|,
name|isk
argument_list|,
sizeof|sizeof
argument_list|(
name|isk
argument_list|)
argument_list|,
name|imck
argument_list|,
sizeof|sizeof
argument_list|(
name|imck
argument_list|)
argument_list|)
expr_stmt|;
name|sha1_t_prf
argument_list|(
name|imck
argument_list|,
literal|40
argument_list|,
literal|"Session Key Generating Function"
argument_list|,
operator|(
name|u8
operator|*
operator|)
literal|""
argument_list|,
literal|0
argument_list|,
name|data
operator|->
name|key_data
argument_list|,
name|EAP_FAST_KEY_LEN
argument_list|)
expr_stmt|;
name|wpa_hexdump_key
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"EAP-FAST: Derived key (MSK)"
argument_list|,
name|data
operator|->
name|key_data
argument_list|,
name|EAP_FAST_KEY_LEN
argument_list|)
expr_stmt|;
name|data
operator|->
name|success
operator|=
literal|1
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|eap_fast_set_tls_master_secret
parameter_list|(
name|struct
name|eap_sm
modifier|*
name|sm
parameter_list|,
name|struct
name|eap_fast_data
modifier|*
name|data
parameter_list|,
specifier|const
name|u8
modifier|*
name|tls
parameter_list|,
name|size_t
name|tls_len
parameter_list|)
block|{
name|struct
name|tls_keys
name|keys
decl_stmt|;
name|u8
name|master_secret
index|[
literal|48
index|]
decl_stmt|,
modifier|*
name|seed
decl_stmt|;
specifier|const
name|u8
modifier|*
name|server_random
decl_stmt|;
name|size_t
name|seed_len
decl_stmt|,
name|server_random_len
decl_stmt|;
if|if
condition|(
name|data
operator|->
name|tls_master_secret_set
operator|||
operator|!
name|data
operator|->
name|current_pac
operator|||
name|tls_connection_get_keys
argument_list|(
name|sm
operator|->
name|ssl_ctx
argument_list|,
name|data
operator|->
name|ssl
operator|.
name|conn
argument_list|,
operator|&
name|keys
argument_list|)
condition|)
block|{
return|return
literal|0
return|;
block|}
name|wpa_hexdump
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"EAP-FAST: client_random"
argument_list|,
name|keys
operator|.
name|client_random
argument_list|,
name|keys
operator|.
name|client_random_len
argument_list|)
expr_stmt|;
comment|/* TLS master secret is needed before TLS library has processed this 	 * message which includes both ServerHello and an encrypted handshake 	 * message, so we need to parse server_random from this message before 	 * passing it to TLS library. 	 * 	 * Example TLS packet header: 	 * (16 03 01 00 2a 02 00 00 26 03 01<32 bytes server_random>) 	 * Content Type: Handshake: 0x16 	 * Version: TLS 1.0 (0x0301) 	 * Lenghth: 42 (0x002a) 	 * Handshake Type: Server Hello: 0x02 	 * Length: 38 (0x000026) 	 * Version TLS 1.0 (0x0301) 	 * Random: 32 bytes 	 */
if|if
condition|(
name|tls_len
operator|<
literal|43
operator|||
name|tls
index|[
literal|0
index|]
operator|!=
literal|0x16
operator|||
name|tls
index|[
literal|1
index|]
operator|!=
literal|0x03
operator|||
name|tls
index|[
literal|2
index|]
operator|!=
literal|0x01
operator|||
name|tls
index|[
literal|5
index|]
operator|!=
literal|0x02
operator|||
name|tls
index|[
literal|9
index|]
operator|!=
literal|0x03
operator|||
name|tls
index|[
literal|10
index|]
operator|!=
literal|0x01
condition|)
block|{
name|wpa_hexdump
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"EAP-FAST: unrecognized TLS "
literal|"ServerHello"
argument_list|,
name|tls
argument_list|,
name|tls_len
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|server_random
operator|=
name|tls
operator|+
literal|11
expr_stmt|;
name|server_random_len
operator|=
literal|32
expr_stmt|;
name|wpa_hexdump
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"EAP-FAST: server_random"
argument_list|,
name|server_random
argument_list|,
name|server_random_len
argument_list|)
expr_stmt|;
name|seed_len
operator|=
name|keys
operator|.
name|client_random_len
operator|+
name|server_random_len
expr_stmt|;
name|seed
operator|=
name|malloc
argument_list|(
name|seed_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|seed
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
name|memcpy
argument_list|(
name|seed
argument_list|,
name|server_random
argument_list|,
name|server_random_len
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
name|seed
operator|+
name|server_random_len
argument_list|,
name|keys
operator|.
name|client_random
argument_list|,
name|keys
operator|.
name|client_random_len
argument_list|)
expr_stmt|;
name|wpa_hexdump
argument_list|(
name|MSG_MSGDUMP
argument_list|,
literal|"EAP-FAST: T-PRF seed"
argument_list|,
name|seed
argument_list|,
name|seed_len
argument_list|)
expr_stmt|;
name|wpa_hexdump_key
argument_list|(
name|MSG_MSGDUMP
argument_list|,
literal|"EAP-FAST: PAC-Key"
argument_list|,
name|data
operator|->
name|current_pac
operator|->
name|pac_key
argument_list|,
name|EAP_FAST_PAC_KEY_LEN
argument_list|)
expr_stmt|;
comment|/* master_secret = T-PRF(PAC-Key, "PAC to master secret label hash",  	 * server_random + client_random, 48) */
name|sha1_t_prf
argument_list|(
name|data
operator|->
name|current_pac
operator|->
name|pac_key
argument_list|,
name|EAP_FAST_PAC_KEY_LEN
argument_list|,
literal|"PAC to master secret label hash"
argument_list|,
name|seed
argument_list|,
name|seed_len
argument_list|,
name|master_secret
argument_list|,
sizeof|sizeof
argument_list|(
name|master_secret
argument_list|)
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|seed
argument_list|)
expr_stmt|;
name|wpa_hexdump_key
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"EAP-FAST: TLS pre-master-secret"
argument_list|,
name|master_secret
argument_list|,
sizeof|sizeof
argument_list|(
name|master_secret
argument_list|)
argument_list|)
expr_stmt|;
name|data
operator|->
name|tls_master_secret_set
operator|=
literal|1
expr_stmt|;
return|return
name|tls_connection_set_master_key
argument_list|(
name|sm
operator|->
name|ssl_ctx
argument_list|,
name|data
operator|->
name|ssl
operator|.
name|conn
argument_list|,
name|master_secret
argument_list|,
sizeof|sizeof
argument_list|(
name|master_secret
argument_list|)
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|u8
modifier|*
name|eap_fast_derive_key
parameter_list|(
name|struct
name|eap_sm
modifier|*
name|sm
parameter_list|,
name|struct
name|eap_ssl_data
modifier|*
name|data
parameter_list|,
name|char
modifier|*
name|label
parameter_list|,
name|size_t
name|len
parameter_list|)
block|{
name|struct
name|tls_keys
name|keys
decl_stmt|;
name|u8
modifier|*
name|rnd
decl_stmt|;
name|u8
modifier|*
name|out
decl_stmt|;
name|int
name|block_size
decl_stmt|;
if|if
condition|(
name|tls_connection_get_keys
argument_list|(
name|sm
operator|->
name|ssl_ctx
argument_list|,
name|data
operator|->
name|conn
argument_list|,
operator|&
name|keys
argument_list|)
condition|)
return|return
name|NULL
return|;
name|block_size
operator|=
name|tls_connection_get_keyblock_size
argument_list|(
name|sm
operator|->
name|ssl_ctx
argument_list|,
name|data
operator|->
name|conn
argument_list|)
expr_stmt|;
if|if
condition|(
name|block_size
operator|<
literal|0
condition|)
return|return
name|NULL
return|;
name|out
operator|=
name|malloc
argument_list|(
name|block_size
operator|+
name|len
argument_list|)
expr_stmt|;
name|rnd
operator|=
name|malloc
argument_list|(
name|keys
operator|.
name|client_random_len
operator|+
name|keys
operator|.
name|server_random_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|out
operator|==
name|NULL
operator|||
name|rnd
operator|==
name|NULL
condition|)
block|{
name|free
argument_list|(
name|out
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|rnd
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|memcpy
argument_list|(
name|rnd
argument_list|,
name|keys
operator|.
name|server_random
argument_list|,
name|keys
operator|.
name|server_random_len
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
name|rnd
operator|+
name|keys
operator|.
name|server_random_len
argument_list|,
name|keys
operator|.
name|client_random
argument_list|,
name|keys
operator|.
name|client_random_len
argument_list|)
expr_stmt|;
name|wpa_hexdump_key
argument_list|(
name|MSG_MSGDUMP
argument_list|,
literal|"EAP-FAST: master_secret for key "
literal|"expansion"
argument_list|,
name|keys
operator|.
name|master_key
argument_list|,
name|keys
operator|.
name|master_key_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|tls_prf
argument_list|(
name|keys
operator|.
name|master_key
argument_list|,
name|keys
operator|.
name|master_key_len
argument_list|,
name|label
argument_list|,
name|rnd
argument_list|,
name|keys
operator|.
name|client_random_len
operator|+
name|keys
operator|.
name|server_random_len
argument_list|,
name|out
argument_list|,
name|block_size
operator|+
name|len
argument_list|)
condition|)
block|{
name|free
argument_list|(
name|rnd
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|out
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|free
argument_list|(
name|rnd
argument_list|)
expr_stmt|;
name|memmove
argument_list|(
name|out
argument_list|,
name|out
operator|+
name|block_size
argument_list|,
name|len
argument_list|)
expr_stmt|;
return|return
name|out
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|eap_fast_derive_key_auth
parameter_list|(
name|struct
name|eap_sm
modifier|*
name|sm
parameter_list|,
name|struct
name|eap_fast_data
modifier|*
name|data
parameter_list|)
block|{
name|free
argument_list|(
name|data
operator|->
name|key_block_a
argument_list|)
expr_stmt|;
name|data
operator|->
name|key_block_a
operator|=
operator|(
expr|struct
name|eap_fast_key_block_auth
operator|*
operator|)
name|eap_fast_derive_key
argument_list|(
name|sm
argument_list|,
operator|&
name|data
operator|->
name|ssl
argument_list|,
literal|"key expansion"
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|data
operator|->
name|key_block_a
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|data
operator|->
name|key_block_a
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"EAP-FAST: Failed to derive "
literal|"session_key_seed"
argument_list|)
expr_stmt|;
return|return;
block|}
name|wpa_hexdump_key
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"EAP-FAST: session_key_seed"
argument_list|,
name|data
operator|->
name|key_block_a
operator|->
name|session_key_seed
argument_list|,
sizeof|sizeof
argument_list|(
name|data
operator|->
name|key_block_a
operator|->
name|session_key_seed
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|eap_fast_derive_key_provisioning
parameter_list|(
name|struct
name|eap_sm
modifier|*
name|sm
parameter_list|,
name|struct
name|eap_fast_data
modifier|*
name|data
parameter_list|)
block|{
name|free
argument_list|(
name|data
operator|->
name|key_block_p
argument_list|)
expr_stmt|;
name|data
operator|->
name|key_block_p
operator|=
operator|(
expr|struct
name|eap_fast_key_block_provisioning
operator|*
operator|)
name|eap_fast_derive_key
argument_list|(
name|sm
argument_list|,
operator|&
name|data
operator|->
name|ssl
argument_list|,
literal|"key expansion"
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|data
operator|->
name|key_block_p
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|data
operator|->
name|key_block_p
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"EAP-FAST: Failed to derive key block"
argument_list|)
expr_stmt|;
return|return;
block|}
name|wpa_hexdump_key
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"EAP-FAST: session_key_seed"
argument_list|,
name|data
operator|->
name|key_block_p
operator|->
name|session_key_seed
argument_list|,
sizeof|sizeof
argument_list|(
name|data
operator|->
name|key_block_p
operator|->
name|session_key_seed
argument_list|)
argument_list|)
expr_stmt|;
name|wpa_hexdump_key
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"EAP-FAST: server_challenge"
argument_list|,
name|data
operator|->
name|key_block_p
operator|->
name|server_challenge
argument_list|,
sizeof|sizeof
argument_list|(
name|data
operator|->
name|key_block_p
operator|->
name|server_challenge
argument_list|)
argument_list|)
expr_stmt|;
name|wpa_hexdump_key
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"EAP-FAST: client_challenge"
argument_list|,
name|data
operator|->
name|key_block_p
operator|->
name|client_challenge
argument_list|,
sizeof|sizeof
argument_list|(
name|data
operator|->
name|key_block_p
operator|->
name|client_challenge
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|eap_fast_derive_keys
parameter_list|(
name|struct
name|eap_sm
modifier|*
name|sm
parameter_list|,
name|struct
name|eap_fast_data
modifier|*
name|data
parameter_list|)
block|{
if|if
condition|(
name|data
operator|->
name|current_pac
condition|)
block|{
name|eap_fast_derive_key_auth
argument_list|(
name|sm
argument_list|,
name|data
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|eap_fast_derive_key_provisioning
argument_list|(
name|sm
argument_list|,
name|data
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|int
name|eap_fast_phase2_request
parameter_list|(
name|struct
name|eap_sm
modifier|*
name|sm
parameter_list|,
name|struct
name|eap_fast_data
modifier|*
name|data
parameter_list|,
name|struct
name|eap_method_ret
modifier|*
name|ret
parameter_list|,
specifier|const
name|struct
name|eap_hdr
modifier|*
name|req
parameter_list|,
name|struct
name|eap_hdr
modifier|*
name|hdr
parameter_list|,
name|u8
modifier|*
modifier|*
name|resp
parameter_list|,
name|size_t
modifier|*
name|resp_len
parameter_list|)
block|{
name|size_t
name|len
init|=
name|be_to_host16
argument_list|(
name|hdr
operator|->
name|length
argument_list|)
decl_stmt|;
name|u8
modifier|*
name|pos
decl_stmt|;
name|struct
name|eap_method_ret
name|iret
decl_stmt|;
if|if
condition|(
name|len
operator|<=
sizeof|sizeof
argument_list|(
expr|struct
name|eap_hdr
argument_list|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"EAP-FAST: too short "
literal|"Phase 2 request (len=%lu)"
argument_list|,
operator|(
name|unsigned
name|long
operator|)
name|len
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|pos
operator|=
operator|(
name|u8
operator|*
operator|)
operator|(
name|hdr
operator|+
literal|1
operator|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"EAP-FAST: Phase 2 Request: type=%d"
argument_list|,
operator|*
name|pos
argument_list|)
expr_stmt|;
switch|switch
condition|(
operator|*
name|pos
condition|)
block|{
case|case
name|EAP_TYPE_IDENTITY
case|:
operator|*
name|resp
operator|=
name|eap_sm_buildIdentity
argument_list|(
name|sm
argument_list|,
name|req
operator|->
name|identifier
argument_list|,
name|resp_len
argument_list|,
literal|1
argument_list|)
expr_stmt|;
break|break;
default|default:
if|if
condition|(
name|data
operator|->
name|phase2_type
operator|==
name|EAP_TYPE_NONE
condition|)
block|{
name|int
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|data
operator|->
name|num_phase2_types
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|data
operator|->
name|phase2_types
index|[
name|i
index|]
operator|!=
operator|*
name|pos
condition|)
continue|continue;
name|data
operator|->
name|phase2_type
operator|=
operator|*
name|pos
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"EAP-FAST: Selected "
literal|"Phase 2 EAP method %d"
argument_list|,
name|data
operator|->
name|phase2_type
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
if|if
condition|(
operator|*
name|pos
operator|!=
name|data
operator|->
name|phase2_type
operator|||
operator|*
name|pos
operator|==
name|EAP_TYPE_NONE
condition|)
block|{
if|if
condition|(
name|eap_fast_phase2_nak
argument_list|(
name|sm
argument_list|,
name|data
argument_list|,
name|hdr
argument_list|,
name|resp
argument_list|,
name|resp_len
argument_list|)
condition|)
return|return
operator|-
literal|1
return|;
return|return
literal|0
return|;
block|}
if|if
condition|(
name|data
operator|->
name|phase2_priv
operator|==
name|NULL
condition|)
block|{
name|data
operator|->
name|phase2_method
operator|=
name|eap_sm_get_eap_methods
argument_list|(
operator|*
name|pos
argument_list|)
expr_stmt|;
if|if
condition|(
name|data
operator|->
name|phase2_method
condition|)
block|{
if|if
condition|(
name|data
operator|->
name|key_block_p
condition|)
block|{
name|sm
operator|->
name|auth_challenge
operator|=
name|data
operator|->
name|key_block_p
operator|->
name|server_challenge
expr_stmt|;
name|sm
operator|->
name|peer_challenge
operator|=
name|data
operator|->
name|key_block_p
operator|->
name|client_challenge
expr_stmt|;
block|}
name|sm
operator|->
name|init_phase2
operator|=
literal|1
expr_stmt|;
name|data
operator|->
name|phase2_priv
operator|=
name|data
operator|->
name|phase2_method
operator|->
name|init
argument_list|(
name|sm
argument_list|)
expr_stmt|;
name|sm
operator|->
name|init_phase2
operator|=
literal|0
expr_stmt|;
name|sm
operator|->
name|auth_challenge
operator|=
name|NULL
expr_stmt|;
name|sm
operator|->
name|peer_challenge
operator|=
name|NULL
expr_stmt|;
block|}
block|}
if|if
condition|(
name|data
operator|->
name|phase2_priv
operator|==
name|NULL
operator|||
name|data
operator|->
name|phase2_method
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"EAP-FAST: failed to initialize "
literal|"Phase 2 EAP method %d"
argument_list|,
operator|*
name|pos
argument_list|)
expr_stmt|;
name|ret
operator|->
name|methodState
operator|=
name|METHOD_DONE
expr_stmt|;
name|ret
operator|->
name|decision
operator|=
name|DECISION_FAIL
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|memset
argument_list|(
operator|&
name|iret
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|iret
argument_list|)
argument_list|)
expr_stmt|;
operator|*
name|resp
operator|=
name|data
operator|->
name|phase2_method
operator|->
name|process
argument_list|(
name|sm
argument_list|,
name|data
operator|->
name|phase2_priv
argument_list|,
operator|&
name|iret
argument_list|,
operator|(
name|u8
operator|*
operator|)
name|hdr
argument_list|,
name|len
argument_list|,
name|resp_len
argument_list|)
expr_stmt|;
if|if
condition|(
operator|*
name|resp
operator|==
name|NULL
operator|||
operator|(
name|iret
operator|.
name|methodState
operator|==
name|METHOD_DONE
operator|&&
name|iret
operator|.
name|decision
operator|==
name|DECISION_FAIL
operator|)
condition|)
block|{
name|ret
operator|->
name|methodState
operator|=
name|METHOD_DONE
expr_stmt|;
name|ret
operator|->
name|decision
operator|=
name|DECISION_FAIL
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|(
name|iret
operator|.
name|methodState
operator|==
name|METHOD_DONE
operator|||
name|iret
operator|.
name|methodState
operator|==
name|METHOD_MAY_CONT
operator|)
operator|&&
operator|(
name|iret
operator|.
name|decision
operator|==
name|DECISION_UNCOND_SUCC
operator|||
name|iret
operator|.
name|decision
operator|==
name|DECISION_COND_SUCC
operator|)
condition|)
block|{
name|data
operator|->
name|phase2_success
operator|=
literal|1
expr_stmt|;
block|}
if|if
condition|(
operator|*
name|resp
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
break|break;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|u8
modifier|*
name|eap_fast_tlv_nak
parameter_list|(
name|int
name|vendor_id
parameter_list|,
name|int
name|tlv_type
parameter_list|,
name|size_t
modifier|*
name|len
parameter_list|)
block|{
name|struct
name|eap_tlv_nak_tlv
modifier|*
name|nak
decl_stmt|;
operator|*
name|len
operator|=
sizeof|sizeof
argument_list|(
operator|*
name|nak
argument_list|)
expr_stmt|;
name|nak
operator|=
name|malloc
argument_list|(
operator|*
name|len
argument_list|)
expr_stmt|;
if|if
condition|(
name|nak
operator|==
name|NULL
condition|)
return|return
name|NULL
return|;
name|nak
operator|->
name|tlv_type
operator|=
name|host_to_be16
argument_list|(
name|EAP_TLV_TYPE_MANDATORY
operator||
name|EAP_TLV_NAK_TLV
argument_list|)
expr_stmt|;
name|nak
operator|->
name|length
operator|=
name|host_to_be16
argument_list|(
literal|6
argument_list|)
expr_stmt|;
name|nak
operator|->
name|vendor_id
operator|=
name|host_to_be32
argument_list|(
name|vendor_id
argument_list|)
expr_stmt|;
name|nak
operator|->
name|nak_type
operator|=
name|host_to_be16
argument_list|(
name|tlv_type
argument_list|)
expr_stmt|;
return|return
operator|(
name|u8
operator|*
operator|)
name|nak
return|;
block|}
end_function

begin_function
specifier|static
name|u8
modifier|*
name|eap_fast_tlv_result
parameter_list|(
name|int
name|status
parameter_list|,
name|int
name|intermediate
parameter_list|,
name|size_t
modifier|*
name|len
parameter_list|)
block|{
name|struct
name|eap_tlv_intermediate_result_tlv
modifier|*
name|result
decl_stmt|;
operator|*
name|len
operator|=
sizeof|sizeof
argument_list|(
operator|*
name|result
argument_list|)
expr_stmt|;
name|result
operator|=
name|malloc
argument_list|(
operator|*
name|len
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|==
name|NULL
condition|)
return|return
name|NULL
return|;
name|result
operator|->
name|tlv_type
operator|=
name|host_to_be16
argument_list|(
name|EAP_TLV_TYPE_MANDATORY
operator||
operator|(
name|intermediate
condition|?
name|EAP_TLV_INTERMEDIATE_RESULT_TLV
else|:
name|EAP_TLV_RESULT_TLV
operator|)
argument_list|)
expr_stmt|;
name|result
operator|->
name|length
operator|=
name|host_to_be16
argument_list|(
literal|2
argument_list|)
expr_stmt|;
name|result
operator|->
name|status
operator|=
name|host_to_be16
argument_list|(
name|status
argument_list|)
expr_stmt|;
return|return
operator|(
name|u8
operator|*
operator|)
name|result
return|;
block|}
end_function

begin_function
specifier|static
name|u8
modifier|*
name|eap_fast_tlv_pac_ack
parameter_list|(
name|size_t
modifier|*
name|len
parameter_list|)
block|{
name|struct
name|eap_tlv_result_tlv
modifier|*
name|res
decl_stmt|;
name|struct
name|eap_tlv_pac_ack_tlv
modifier|*
name|ack
decl_stmt|;
operator|*
name|len
operator|=
sizeof|sizeof
argument_list|(
operator|*
name|res
argument_list|)
operator|+
sizeof|sizeof
argument_list|(
operator|*
name|ack
argument_list|)
expr_stmt|;
name|res
operator|=
name|malloc
argument_list|(
operator|*
name|len
argument_list|)
expr_stmt|;
if|if
condition|(
name|res
operator|==
name|NULL
condition|)
return|return
name|NULL
return|;
name|memset
argument_list|(
name|res
argument_list|,
literal|0
argument_list|,
operator|*
name|len
argument_list|)
expr_stmt|;
name|res
operator|->
name|tlv_type
operator|=
name|host_to_be16
argument_list|(
name|EAP_TLV_RESULT_TLV
operator||
name|EAP_TLV_TYPE_MANDATORY
argument_list|)
expr_stmt|;
name|res
operator|->
name|length
operator|=
name|host_to_be16
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|res
argument_list|)
operator|-
sizeof|sizeof
argument_list|(
expr|struct
name|eap_tlv_hdr
argument_list|)
argument_list|)
expr_stmt|;
name|res
operator|->
name|status
operator|=
name|host_to_be16
argument_list|(
name|EAP_TLV_RESULT_SUCCESS
argument_list|)
expr_stmt|;
name|ack
operator|=
operator|(
expr|struct
name|eap_tlv_pac_ack_tlv
operator|*
operator|)
operator|(
name|res
operator|+
literal|1
operator|)
expr_stmt|;
name|ack
operator|->
name|tlv_type
operator|=
name|host_to_be16
argument_list|(
name|EAP_TLV_PAC_TLV
operator||
name|EAP_TLV_TYPE_MANDATORY
argument_list|)
expr_stmt|;
name|ack
operator|->
name|length
operator|=
name|host_to_be16
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|ack
argument_list|)
operator|-
sizeof|sizeof
argument_list|(
expr|struct
name|eap_tlv_hdr
argument_list|)
argument_list|)
expr_stmt|;
name|ack
operator|->
name|pac_type
operator|=
name|host_to_be16
argument_list|(
name|PAC_TYPE_PAC_ACKNOWLEDGEMENT
argument_list|)
expr_stmt|;
name|ack
operator|->
name|pac_len
operator|=
name|host_to_be16
argument_list|(
literal|2
argument_list|)
expr_stmt|;
name|ack
operator|->
name|result
operator|=
name|host_to_be16
argument_list|(
name|EAP_TLV_RESULT_SUCCESS
argument_list|)
expr_stmt|;
return|return
operator|(
name|u8
operator|*
operator|)
name|res
return|;
block|}
end_function

begin_function
specifier|static
name|u8
modifier|*
name|eap_fast_tlv_eap_payload
parameter_list|(
name|u8
modifier|*
name|buf
parameter_list|,
name|size_t
modifier|*
name|len
parameter_list|)
block|{
name|struct
name|eap_tlv_hdr
modifier|*
name|tlv
decl_stmt|;
comment|/* Encapsulate EAP packet in EAP Payload TLV */
name|tlv
operator|=
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|tlv
argument_list|)
operator|+
operator|*
name|len
argument_list|)
expr_stmt|;
if|if
condition|(
name|tlv
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"EAP-FAST: Failed to "
literal|"allocate memory for TLV "
literal|"encapsulation"
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|buf
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|tlv
operator|->
name|tlv_type
operator|=
name|host_to_be16
argument_list|(
name|EAP_TLV_TYPE_MANDATORY
operator||
name|EAP_TLV_EAP_PAYLOAD_TLV
argument_list|)
expr_stmt|;
name|tlv
operator|->
name|length
operator|=
name|host_to_be16
argument_list|(
operator|*
name|len
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
name|tlv
operator|+
literal|1
argument_list|,
name|buf
argument_list|,
operator|*
name|len
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|buf
argument_list|)
expr_stmt|;
operator|*
name|len
operator|+=
sizeof|sizeof
argument_list|(
operator|*
name|tlv
argument_list|)
expr_stmt|;
return|return
operator|(
name|u8
operator|*
operator|)
name|tlv
return|;
block|}
end_function

begin_function
specifier|static
name|u8
modifier|*
name|eap_fast_process_crypto_binding
parameter_list|(
name|struct
name|eap_sm
modifier|*
name|sm
parameter_list|,
name|struct
name|eap_fast_data
modifier|*
name|data
parameter_list|,
name|struct
name|eap_method_ret
modifier|*
name|ret
parameter_list|,
name|struct
name|eap_tlv_crypto_binding__tlv
modifier|*
name|bind
parameter_list|,
name|size_t
name|bind_len
parameter_list|,
name|size_t
modifier|*
name|resp_len
parameter_list|,
name|int
name|final
parameter_list|)
block|{
name|u8
modifier|*
name|resp
decl_stmt|,
modifier|*
name|sks
init|=
name|NULL
decl_stmt|;
name|struct
name|eap_tlv_intermediate_result_tlv
modifier|*
name|rresult
decl_stmt|;
name|struct
name|eap_tlv_crypto_binding__tlv
modifier|*
name|rbind
decl_stmt|;
name|u8
name|isk
index|[
literal|32
index|]
decl_stmt|,
name|imck
index|[
literal|60
index|]
decl_stmt|,
modifier|*
name|cmk
decl_stmt|,
name|cmac
index|[
literal|20
index|]
decl_stmt|,
modifier|*
name|key
decl_stmt|;
name|size_t
name|key_len
decl_stmt|;
name|int
name|res
decl_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"EAP-FAST: Crypto-Binding TLV: Version %d "
literal|"Received Version %d SubType %d"
argument_list|,
name|bind
operator|->
name|version
argument_list|,
name|bind
operator|->
name|received_version
argument_list|,
name|bind
operator|->
name|subtype
argument_list|)
expr_stmt|;
name|wpa_hexdump
argument_list|(
name|MSG_MSGDUMP
argument_list|,
literal|"EAP-FAST: NONCE"
argument_list|,
name|bind
operator|->
name|nonce
argument_list|,
sizeof|sizeof
argument_list|(
name|bind
operator|->
name|nonce
argument_list|)
argument_list|)
expr_stmt|;
name|wpa_hexdump
argument_list|(
name|MSG_MSGDUMP
argument_list|,
literal|"EAP-FAST: Compound MAC"
argument_list|,
name|bind
operator|->
name|compound_mac
argument_list|,
sizeof|sizeof
argument_list|(
name|bind
operator|->
name|compound_mac
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|bind
operator|->
name|version
operator|!=
name|EAP_FAST_VERSION
operator|||
name|bind
operator|->
name|received_version
operator|!=
name|EAP_FAST_VERSION
operator|||
name|bind
operator|->
name|subtype
operator|!=
name|EAP_TLV_CRYPTO_BINDING_SUBTYPE_REQUEST
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"EAP-FAST: Invalid version/subtype in "
literal|"Crypto-Binding TLV: Version %d "
literal|"Received Version %d SubType %d"
argument_list|,
name|bind
operator|->
name|version
argument_list|,
name|bind
operator|->
name|received_version
argument_list|,
name|bind
operator|->
name|subtype
argument_list|)
expr_stmt|;
name|resp
operator|=
name|eap_fast_tlv_result
argument_list|(
name|EAP_TLV_RESULT_FAILURE
argument_list|,
literal|1
argument_list|,
name|resp_len
argument_list|)
expr_stmt|;
return|return
name|resp
return|;
block|}
if|if
condition|(
name|data
operator|->
name|provisioning
condition|)
block|{
if|if
condition|(
name|data
operator|->
name|key_block_p
condition|)
block|{
name|sks
operator|=
name|data
operator|->
name|key_block_p
operator|->
name|session_key_seed
expr_stmt|;
block|}
block|}
else|else
block|{
if|if
condition|(
name|data
operator|->
name|key_block_a
condition|)
block|{
name|sks
operator|=
name|data
operator|->
name|key_block_a
operator|->
name|session_key_seed
expr_stmt|;
block|}
block|}
if|if
condition|(
name|sks
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"EAP-FAST: No Session Key Seed available "
literal|"for processing Crypto-Binding TLV"
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"EAP-FAST: Determining CMK for Compound MIC "
literal|"calculation"
argument_list|)
expr_stmt|;
name|wpa_hexdump_key
argument_list|(
name|MSG_MSGDUMP
argument_list|,
literal|"EAP-FAST: S-IMCK[0] = SKS"
argument_list|,
name|sks
argument_list|,
literal|40
argument_list|)
expr_stmt|;
name|memset
argument_list|(
name|isk
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|isk
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|data
operator|->
name|phase2_method
operator|==
name|NULL
operator|||
name|data
operator|->
name|phase2_priv
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"EAP-FAST: Phase 2 method not "
literal|"available"
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
if|if
condition|(
name|data
operator|->
name|phase2_method
operator|->
name|isKeyAvailable
operator|&&
name|data
operator|->
name|phase2_method
operator|->
name|getKey
condition|)
block|{
if|if
condition|(
operator|!
name|data
operator|->
name|phase2_method
operator|->
name|isKeyAvailable
argument_list|(
name|sm
argument_list|,
name|data
operator|->
name|phase2_priv
argument_list|)
operator|||
operator|(
name|key
operator|=
name|data
operator|->
name|phase2_method
operator|->
name|getKey
argument_list|(
name|sm
argument_list|,
name|data
operator|->
name|phase2_priv
argument_list|,
operator|&
name|key_len
argument_list|)
operator|)
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"EAP-FAST: Could not get key "
literal|"material from Phase 2"
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
if|if
condition|(
name|key_len
operator|>
sizeof|sizeof
argument_list|(
name|isk
argument_list|)
condition|)
name|key_len
operator|=
sizeof|sizeof
argument_list|(
name|isk
argument_list|)
expr_stmt|;
comment|/* FIX: which end is being padded? */
if|#
directive|if
literal|0
block|memcpy(isk + (sizeof(isk) - key_len), key, key_len);
else|#
directive|else
name|memcpy
argument_list|(
name|isk
argument_list|,
name|key
argument_list|,
name|key_len
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|free
argument_list|(
name|key
argument_list|)
expr_stmt|;
block|}
name|wpa_hexdump_key
argument_list|(
name|MSG_MSGDUMP
argument_list|,
literal|"EAP-FAST: ISK[0]"
argument_list|,
name|isk
argument_list|,
sizeof|sizeof
argument_list|(
name|isk
argument_list|)
argument_list|)
expr_stmt|;
name|sha1_t_prf
argument_list|(
name|sks
argument_list|,
literal|40
argument_list|,
literal|"Inner Methods Compound Keys"
argument_list|,
name|isk
argument_list|,
sizeof|sizeof
argument_list|(
name|isk
argument_list|)
argument_list|,
name|imck
argument_list|,
sizeof|sizeof
argument_list|(
name|imck
argument_list|)
argument_list|)
expr_stmt|;
comment|/* S-IMCK[1] = imkc[0..39] */
name|wpa_hexdump_key
argument_list|(
name|MSG_MSGDUMP
argument_list|,
literal|"EAP-FAST: S-IMCK[1]"
argument_list|,
name|imck
argument_list|,
literal|40
argument_list|)
expr_stmt|;
name|cmk
operator|=
name|imck
operator|+
literal|40
expr_stmt|;
name|wpa_hexdump_key
argument_list|(
name|MSG_MSGDUMP
argument_list|,
literal|"EAP-FAST: CMK"
argument_list|,
name|cmk
argument_list|,
literal|20
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
name|cmac
argument_list|,
name|bind
operator|->
name|compound_mac
argument_list|,
sizeof|sizeof
argument_list|(
name|cmac
argument_list|)
argument_list|)
expr_stmt|;
name|memset
argument_list|(
name|bind
operator|->
name|compound_mac
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|cmac
argument_list|)
argument_list|)
expr_stmt|;
name|wpa_hexdump
argument_list|(
name|MSG_MSGDUMP
argument_list|,
literal|"EAP-FAST: Crypto-Binding TLV for Compound "
literal|"MAC calculation"
argument_list|,
operator|(
name|u8
operator|*
operator|)
name|bind
argument_list|,
name|bind_len
argument_list|)
expr_stmt|;
name|hmac_sha1
argument_list|(
name|cmk
argument_list|,
literal|20
argument_list|,
operator|(
name|u8
operator|*
operator|)
name|bind
argument_list|,
name|bind_len
argument_list|,
name|bind
operator|->
name|compound_mac
argument_list|)
expr_stmt|;
name|res
operator|=
name|memcmp
argument_list|(
name|cmac
argument_list|,
name|bind
operator|->
name|compound_mac
argument_list|,
sizeof|sizeof
argument_list|(
name|cmac
argument_list|)
argument_list|)
expr_stmt|;
name|wpa_hexdump
argument_list|(
name|MSG_MSGDUMP
argument_list|,
literal|"EAP-FAST: Received Compound MAC"
argument_list|,
name|cmac
argument_list|,
sizeof|sizeof
argument_list|(
name|cmac
argument_list|)
argument_list|)
expr_stmt|;
name|wpa_hexdump
argument_list|(
name|MSG_MSGDUMP
argument_list|,
literal|"EAP-FAST: Calculated Compound MAC"
argument_list|,
name|bind
operator|->
name|compound_mac
argument_list|,
sizeof|sizeof
argument_list|(
name|cmac
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|res
operator|!=
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"EAP-FAST: Compound MAC did not match"
argument_list|)
expr_stmt|;
name|resp
operator|=
name|eap_fast_tlv_result
argument_list|(
name|EAP_TLV_RESULT_FAILURE
argument_list|,
literal|1
argument_list|,
name|resp_len
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
name|bind
operator|->
name|compound_mac
argument_list|,
name|cmac
argument_list|,
sizeof|sizeof
argument_list|(
name|cmac
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|resp
return|;
block|}
operator|*
name|resp_len
operator|=
sizeof|sizeof
argument_list|(
operator|*
name|rresult
argument_list|)
operator|+
sizeof|sizeof
argument_list|(
operator|*
name|rbind
argument_list|)
expr_stmt|;
name|resp
operator|=
name|malloc
argument_list|(
operator|*
name|resp_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|resp
operator|==
name|NULL
condition|)
return|return
name|NULL
return|;
name|memset
argument_list|(
name|resp
argument_list|,
literal|0
argument_list|,
operator|*
name|resp_len
argument_list|)
expr_stmt|;
comment|/* Both intermediate and final Result TLVs are identical, so ok to use 	 * the same structure definition for them. */
name|rresult
operator|=
operator|(
expr|struct
name|eap_tlv_intermediate_result_tlv
operator|*
operator|)
name|resp
expr_stmt|;
name|rresult
operator|->
name|tlv_type
operator|=
name|host_to_be16
argument_list|(
name|EAP_TLV_TYPE_MANDATORY
operator||
operator|(
name|final
condition|?
name|EAP_TLV_RESULT_TLV
else|:
name|EAP_TLV_INTERMEDIATE_RESULT_TLV
operator|)
argument_list|)
expr_stmt|;
name|rresult
operator|->
name|length
operator|=
name|host_to_be16
argument_list|(
literal|2
argument_list|)
expr_stmt|;
name|rresult
operator|->
name|status
operator|=
name|host_to_be16
argument_list|(
name|EAP_TLV_RESULT_SUCCESS
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|data
operator|->
name|provisioning
operator|&&
name|data
operator|->
name|phase2_success
operator|&&
name|eap_fast_derive_msk
argument_list|(
name|sm
argument_list|,
name|data
argument_list|)
operator|<
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"EAP-FAST: Failed to generate MSK"
argument_list|)
expr_stmt|;
name|ret
operator|->
name|methodState
operator|=
name|METHOD_DONE
expr_stmt|;
name|ret
operator|->
name|decision
operator|=
name|DECISION_FAIL
expr_stmt|;
name|rresult
operator|->
name|status
operator|=
name|host_to_be16
argument_list|(
name|EAP_TLV_RESULT_FAILURE
argument_list|)
expr_stmt|;
name|data
operator|->
name|phase2_success
operator|=
literal|0
expr_stmt|;
block|}
name|rbind
operator|=
operator|(
expr|struct
name|eap_tlv_crypto_binding__tlv
operator|*
operator|)
operator|(
name|rresult
operator|+
literal|1
operator|)
expr_stmt|;
name|rbind
operator|->
name|tlv_type
operator|=
name|host_to_be16
argument_list|(
name|EAP_TLV_TYPE_MANDATORY
operator||
name|EAP_TLV_CRYPTO_BINDING_TLV_
argument_list|)
expr_stmt|;
name|rbind
operator|->
name|length
operator|=
name|host_to_be16
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|rbind
argument_list|)
operator|-
sizeof|sizeof
argument_list|(
expr|struct
name|eap_tlv_hdr
argument_list|)
argument_list|)
expr_stmt|;
name|rbind
operator|->
name|version
operator|=
name|EAP_FAST_VERSION
expr_stmt|;
name|rbind
operator|->
name|received_version
operator|=
name|bind
operator|->
name|version
expr_stmt|;
name|rbind
operator|->
name|subtype
operator|=
name|EAP_TLV_CRYPTO_BINDING_SUBTYPE_RESPONSE
expr_stmt|;
name|memcpy
argument_list|(
name|rbind
operator|->
name|nonce
argument_list|,
name|bind
operator|->
name|nonce
argument_list|,
sizeof|sizeof
argument_list|(
name|bind
operator|->
name|nonce
argument_list|)
argument_list|)
expr_stmt|;
name|inc_byte_array
argument_list|(
name|rbind
operator|->
name|nonce
argument_list|,
sizeof|sizeof
argument_list|(
name|bind
operator|->
name|nonce
argument_list|)
argument_list|)
expr_stmt|;
name|hmac_sha1
argument_list|(
name|cmk
argument_list|,
literal|20
argument_list|,
operator|(
name|u8
operator|*
operator|)
name|rbind
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|rbind
argument_list|)
argument_list|,
name|rbind
operator|->
name|compound_mac
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"EAP-FAST: Reply Crypto-Binding TLV: Version %d "
literal|"Received Version %d SubType %d"
argument_list|,
name|rbind
operator|->
name|version
argument_list|,
name|rbind
operator|->
name|received_version
argument_list|,
name|rbind
operator|->
name|subtype
argument_list|)
expr_stmt|;
name|wpa_hexdump
argument_list|(
name|MSG_MSGDUMP
argument_list|,
literal|"EAP-FAST: NONCE"
argument_list|,
name|rbind
operator|->
name|nonce
argument_list|,
sizeof|sizeof
argument_list|(
name|rbind
operator|->
name|nonce
argument_list|)
argument_list|)
expr_stmt|;
name|wpa_hexdump
argument_list|(
name|MSG_MSGDUMP
argument_list|,
literal|"EAP-FAST: Compound MAC"
argument_list|,
name|rbind
operator|->
name|compound_mac
argument_list|,
sizeof|sizeof
argument_list|(
name|rbind
operator|->
name|compound_mac
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|final
operator|&&
name|data
operator|->
name|phase2_success
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"EAP-FAST: Authentication completed "
literal|"successfully."
argument_list|)
expr_stmt|;
name|ret
operator|->
name|methodState
operator|=
name|METHOD_DONE
expr_stmt|;
name|ret
operator|->
name|decision
operator|=
name|DECISION_UNCOND_SUCC
expr_stmt|;
block|}
return|return
name|resp
return|;
block|}
end_function

begin_function
specifier|static
name|u8
modifier|*
name|eap_fast_process_pac
parameter_list|(
name|struct
name|eap_sm
modifier|*
name|sm
parameter_list|,
name|struct
name|eap_fast_data
modifier|*
name|data
parameter_list|,
name|struct
name|eap_method_ret
modifier|*
name|ret
parameter_list|,
name|u8
modifier|*
name|pac
parameter_list|,
name|size_t
name|pac_len
parameter_list|,
name|size_t
modifier|*
name|resp_len
parameter_list|)
block|{
name|struct
name|wpa_ssid
modifier|*
name|config
init|=
name|eap_get_config
argument_list|(
name|sm
argument_list|)
decl_stmt|;
name|struct
name|pac_tlv_hdr
modifier|*
name|hdr
decl_stmt|;
name|u8
modifier|*
name|pos
decl_stmt|;
name|size_t
name|left
decl_stmt|,
name|len
decl_stmt|;
name|int
name|type
decl_stmt|,
name|pac_key_found
init|=
literal|0
decl_stmt|;
name|struct
name|eap_fast_pac
name|entry
decl_stmt|;
name|memset
argument_list|(
operator|&
name|entry
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|entry
argument_list|)
argument_list|)
expr_stmt|;
name|pos
operator|=
name|pac
expr_stmt|;
name|left
operator|=
name|pac_len
expr_stmt|;
while|while
condition|(
name|left
operator|>
sizeof|sizeof
argument_list|(
operator|*
name|hdr
argument_list|)
condition|)
block|{
name|hdr
operator|=
operator|(
expr|struct
name|pac_tlv_hdr
operator|*
operator|)
name|pos
expr_stmt|;
name|type
operator|=
name|be_to_host16
argument_list|(
name|hdr
operator|->
name|type
argument_list|)
expr_stmt|;
name|len
operator|=
name|be_to_host16
argument_list|(
name|hdr
operator|->
name|len
argument_list|)
expr_stmt|;
name|pos
operator|+=
sizeof|sizeof
argument_list|(
operator|*
name|hdr
argument_list|)
expr_stmt|;
name|left
operator|-=
sizeof|sizeof
argument_list|(
operator|*
name|hdr
argument_list|)
expr_stmt|;
if|if
condition|(
name|len
operator|>
name|left
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"EAP-FAST: PAC TLV overrun "
literal|"(type=%d len=%lu left=%lu)"
argument_list|,
name|type
argument_list|,
operator|(
name|unsigned
name|long
operator|)
name|len
argument_list|,
operator|(
name|unsigned
name|long
operator|)
name|left
argument_list|)
expr_stmt|;
return|return
name|eap_fast_tlv_result
argument_list|(
name|EAP_TLV_RESULT_FAILURE
argument_list|,
literal|0
argument_list|,
name|resp_len
argument_list|)
return|;
block|}
switch|switch
condition|(
name|type
condition|)
block|{
case|case
name|PAC_TYPE_PAC_KEY
case|:
name|wpa_hexdump_key
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"EAP-FAST: PAC-Key"
argument_list|,
name|pos
argument_list|,
name|len
argument_list|)
expr_stmt|;
if|if
condition|(
name|len
operator|!=
name|EAP_FAST_PAC_KEY_LEN
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"EAP-FAST: Invalid "
literal|"PAC-Key length %lu"
argument_list|,
operator|(
name|unsigned
name|long
operator|)
name|len
argument_list|)
expr_stmt|;
break|break;
block|}
name|pac_key_found
operator|=
literal|1
expr_stmt|;
name|memcpy
argument_list|(
name|entry
operator|.
name|pac_key
argument_list|,
name|pos
argument_list|,
name|len
argument_list|)
expr_stmt|;
break|break;
case|case
name|PAC_TYPE_PAC_OPAQUE
case|:
name|wpa_hexdump
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"EAP-FAST: PAC-Opaque"
argument_list|,
name|pos
argument_list|,
name|len
argument_list|)
expr_stmt|;
name|entry
operator|.
name|pac_opaque
operator|=
name|pos
expr_stmt|;
name|entry
operator|.
name|pac_opaque_len
operator|=
name|len
expr_stmt|;
break|break;
case|case
name|PAC_TYPE_PAC_INFO
case|:
name|wpa_hexdump
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"EAP-FAST: PAC-Info"
argument_list|,
name|pos
argument_list|,
name|len
argument_list|)
expr_stmt|;
name|entry
operator|.
name|pac_info
operator|=
name|pos
expr_stmt|;
name|entry
operator|.
name|pac_info_len
operator|=
name|len
expr_stmt|;
break|break;
default|default:
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"EAP-FAST: Ignored unknown PAC "
literal|"type %d"
argument_list|,
name|type
argument_list|)
expr_stmt|;
break|break;
block|}
name|pos
operator|+=
name|len
expr_stmt|;
name|left
operator|-=
name|len
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|pac_key_found
operator|||
operator|!
name|entry
operator|.
name|pac_opaque
operator|||
operator|!
name|entry
operator|.
name|pac_info
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"EAP-FAST: PAC TLV does not include "
literal|"all the required fields"
argument_list|)
expr_stmt|;
return|return
name|eap_fast_tlv_result
argument_list|(
name|EAP_TLV_RESULT_FAILURE
argument_list|,
literal|0
argument_list|,
name|resp_len
argument_list|)
return|;
block|}
name|pos
operator|=
name|entry
operator|.
name|pac_info
expr_stmt|;
name|left
operator|=
name|entry
operator|.
name|pac_info_len
expr_stmt|;
while|while
condition|(
name|left
operator|>
sizeof|sizeof
argument_list|(
operator|*
name|hdr
argument_list|)
condition|)
block|{
name|hdr
operator|=
operator|(
expr|struct
name|pac_tlv_hdr
operator|*
operator|)
name|pos
expr_stmt|;
name|type
operator|=
name|be_to_host16
argument_list|(
name|hdr
operator|->
name|type
argument_list|)
expr_stmt|;
name|len
operator|=
name|be_to_host16
argument_list|(
name|hdr
operator|->
name|len
argument_list|)
expr_stmt|;
name|pos
operator|+=
sizeof|sizeof
argument_list|(
operator|*
name|hdr
argument_list|)
expr_stmt|;
name|left
operator|-=
sizeof|sizeof
argument_list|(
operator|*
name|hdr
argument_list|)
expr_stmt|;
if|if
condition|(
name|len
operator|>
name|left
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"EAP-FAST: PAC-Info overrun "
literal|"(type=%d len=%lu left=%lu)"
argument_list|,
name|type
argument_list|,
operator|(
name|unsigned
name|long
operator|)
name|len
argument_list|,
operator|(
name|unsigned
name|long
operator|)
name|left
argument_list|)
expr_stmt|;
return|return
name|eap_fast_tlv_result
argument_list|(
name|EAP_TLV_RESULT_FAILURE
argument_list|,
literal|0
argument_list|,
name|resp_len
argument_list|)
return|;
block|}
switch|switch
condition|(
name|type
condition|)
block|{
case|case
name|PAC_TYPE_A_ID
case|:
name|wpa_hexdump_ascii
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"EAP-FAST: PAC-Info - "
literal|"A-ID"
argument_list|,
name|pos
argument_list|,
name|len
argument_list|)
expr_stmt|;
name|entry
operator|.
name|a_id
operator|=
name|pos
expr_stmt|;
name|entry
operator|.
name|a_id_len
operator|=
name|len
expr_stmt|;
break|break;
case|case
name|PAC_TYPE_I_ID
case|:
name|wpa_hexdump_ascii
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"EAP-FAST: PAC-Info - "
literal|"I-ID"
argument_list|,
name|pos
argument_list|,
name|len
argument_list|)
expr_stmt|;
name|entry
operator|.
name|i_id
operator|=
name|pos
expr_stmt|;
name|entry
operator|.
name|i_id_len
operator|=
name|len
expr_stmt|;
break|break;
case|case
name|PAC_TYPE_A_ID_INFO
case|:
name|wpa_hexdump_ascii
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"EAP-FAST: PAC-Info - "
literal|"A-ID-Info"
argument_list|,
name|pos
argument_list|,
name|len
argument_list|)
expr_stmt|;
name|entry
operator|.
name|a_id_info
operator|=
name|pos
expr_stmt|;
name|entry
operator|.
name|a_id_info_len
operator|=
name|len
expr_stmt|;
break|break;
default|default:
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"EAP-FAST: Ignored unknown "
literal|"PAC-Info type %d"
argument_list|,
name|type
argument_list|)
expr_stmt|;
break|break;
block|}
name|pos
operator|+=
name|len
expr_stmt|;
name|left
operator|-=
name|len
expr_stmt|;
block|}
if|if
condition|(
name|entry
operator|.
name|a_id
operator|==
name|NULL
operator|||
name|entry
operator|.
name|a_id_info
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"EAP-FAST: PAC-Info does not include "
literal|"all the required fields"
argument_list|)
expr_stmt|;
return|return
name|eap_fast_tlv_result
argument_list|(
name|EAP_TLV_RESULT_FAILURE
argument_list|,
literal|0
argument_list|,
name|resp_len
argument_list|)
return|;
block|}
name|eap_fast_add_pac
argument_list|(
name|data
argument_list|,
operator|&
name|entry
argument_list|)
expr_stmt|;
name|eap_fast_save_pac
argument_list|(
name|sm
argument_list|,
name|data
argument_list|,
name|config
operator|->
name|pac_file
argument_list|)
expr_stmt|;
if|if
condition|(
name|data
operator|->
name|provisioning
condition|)
block|{
comment|/* EAP-FAST provisioning does not provide keying material and 		 * must end with an EAP-Failure. Authentication will be done 		 * separately after this. */
name|data
operator|->
name|success
operator|=
literal|0
expr_stmt|;
name|ret
operator|->
name|decision
operator|=
name|DECISION_FAIL
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"EAP-FAST: Send PAC-Acknowledgement TLV "
literal|"- Provisioning completed successfully"
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|/* This is PAC refreshing, i.e., normal authentication that is 		 * expected to be completed with an EAP-Success. */
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"EAP-FAST: Send PAC-Acknowledgement TLV "
literal|"- PAC refreshing completed successfully"
argument_list|)
expr_stmt|;
name|ret
operator|->
name|decision
operator|=
name|DECISION_UNCOND_SUCC
expr_stmt|;
block|}
name|ret
operator|->
name|methodState
operator|=
name|METHOD_DONE
expr_stmt|;
return|return
name|eap_fast_tlv_pac_ack
argument_list|(
name|resp_len
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|eap_fast_decrypt
parameter_list|(
name|struct
name|eap_sm
modifier|*
name|sm
parameter_list|,
name|struct
name|eap_fast_data
modifier|*
name|data
parameter_list|,
name|struct
name|eap_method_ret
modifier|*
name|ret
parameter_list|,
specifier|const
name|struct
name|eap_hdr
modifier|*
name|req
parameter_list|,
specifier|const
name|u8
modifier|*
name|in_data
parameter_list|,
name|size_t
name|in_len
parameter_list|,
name|u8
modifier|*
modifier|*
name|out_data
parameter_list|,
name|size_t
modifier|*
name|out_len
parameter_list|)
block|{
name|u8
modifier|*
name|in_decrypted
decl_stmt|,
modifier|*
name|pos
decl_stmt|,
modifier|*
name|end
decl_stmt|;
name|int
name|buf_len
decl_stmt|,
name|len_decrypted
decl_stmt|,
name|len
decl_stmt|;
name|struct
name|eap_hdr
modifier|*
name|hdr
decl_stmt|;
name|u8
modifier|*
name|resp
init|=
name|NULL
decl_stmt|;
name|size_t
name|resp_len
decl_stmt|;
name|int
name|mandatory
decl_stmt|,
name|tlv_type
decl_stmt|;
name|u8
modifier|*
name|eap_payload_tlv
init|=
name|NULL
decl_stmt|,
modifier|*
name|pac
init|=
name|NULL
decl_stmt|;
name|size_t
name|eap_payload_tlv_len
init|=
literal|0
decl_stmt|,
name|pac_len
init|=
literal|0
decl_stmt|;
name|int
name|iresult
init|=
literal|0
decl_stmt|,
name|result
init|=
literal|0
decl_stmt|;
name|struct
name|eap_tlv_crypto_binding__tlv
modifier|*
name|crypto_binding
init|=
name|NULL
decl_stmt|;
name|size_t
name|crypto_binding_len
init|=
literal|0
decl_stmt|;
specifier|const
name|u8
modifier|*
name|msg
decl_stmt|;
name|size_t
name|msg_len
decl_stmt|;
name|int
name|need_more_input
decl_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"EAP-FAST: received %lu bytes encrypted data for"
literal|" Phase 2"
argument_list|,
operator|(
name|unsigned
name|long
operator|)
name|in_len
argument_list|)
expr_stmt|;
name|msg
operator|=
name|eap_tls_data_reassemble
argument_list|(
name|sm
argument_list|,
operator|&
name|data
operator|->
name|ssl
argument_list|,
name|in_data
argument_list|,
name|in_len
argument_list|,
operator|&
name|msg_len
argument_list|,
operator|&
name|need_more_input
argument_list|)
expr_stmt|;
if|if
condition|(
name|msg
operator|==
name|NULL
condition|)
return|return
name|need_more_input
condition|?
literal|1
else|:
operator|-
literal|1
return|;
name|buf_len
operator|=
name|in_len
expr_stmt|;
if|if
condition|(
name|data
operator|->
name|ssl
operator|.
name|tls_in_total
operator|>
name|buf_len
condition|)
name|buf_len
operator|=
name|data
operator|->
name|ssl
operator|.
name|tls_in_total
expr_stmt|;
name|in_decrypted
operator|=
name|malloc
argument_list|(
name|buf_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|in_decrypted
operator|==
name|NULL
condition|)
block|{
name|free
argument_list|(
name|data
operator|->
name|ssl
operator|.
name|tls_in
argument_list|)
expr_stmt|;
name|data
operator|->
name|ssl
operator|.
name|tls_in
operator|=
name|NULL
expr_stmt|;
name|data
operator|->
name|ssl
operator|.
name|tls_in_len
operator|=
literal|0
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_WARNING
argument_list|,
literal|"EAP-FAST: failed to allocate memory "
literal|"for decryption"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|len_decrypted
operator|=
name|tls_connection_decrypt
argument_list|(
name|sm
operator|->
name|ssl_ctx
argument_list|,
name|data
operator|->
name|ssl
operator|.
name|conn
argument_list|,
name|msg
argument_list|,
name|msg_len
argument_list|,
name|in_decrypted
argument_list|,
name|buf_len
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|data
operator|->
name|ssl
operator|.
name|tls_in
argument_list|)
expr_stmt|;
name|data
operator|->
name|ssl
operator|.
name|tls_in
operator|=
name|NULL
expr_stmt|;
name|data
operator|->
name|ssl
operator|.
name|tls_in_len
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|len_decrypted
operator|<
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"EAP-FAST: Failed to decrypt Phase 2 "
literal|"data"
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|in_decrypted
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|wpa_hexdump
argument_list|(
name|MSG_MSGDUMP
argument_list|,
literal|"EAP-FAST: Decrypted Phase 2 TLV(s)"
argument_list|,
name|in_decrypted
argument_list|,
name|len_decrypted
argument_list|)
expr_stmt|;
if|if
condition|(
name|len_decrypted
operator|<
literal|4
condition|)
block|{
name|free
argument_list|(
name|in_decrypted
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"EAP-FAST: Too short Phase 2 "
literal|"TLV frame (len=%d)"
argument_list|,
name|len_decrypted
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|pos
operator|=
name|in_decrypted
expr_stmt|;
name|end
operator|=
name|in_decrypted
operator|+
name|len_decrypted
expr_stmt|;
while|while
condition|(
name|pos
operator|+
literal|4
operator|<
name|end
condition|)
block|{
name|mandatory
operator|=
name|pos
index|[
literal|0
index|]
operator|&
literal|0x80
expr_stmt|;
name|tlv_type
operator|=
name|WPA_GET_BE16
argument_list|(
name|pos
argument_list|)
operator|&
literal|0x3fff
expr_stmt|;
name|pos
operator|+=
literal|2
expr_stmt|;
name|len
operator|=
name|WPA_GET_BE16
argument_list|(
name|pos
argument_list|)
expr_stmt|;
name|pos
operator|+=
literal|2
expr_stmt|;
if|if
condition|(
name|pos
operator|+
name|len
operator|>
name|end
condition|)
block|{
name|free
argument_list|(
name|in_decrypted
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"EAP-FAST: TLV overflow"
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"EAP-FAST: received Phase 2: "
literal|"TLV type %d length %d%s"
argument_list|,
name|tlv_type
argument_list|,
name|len
argument_list|,
name|mandatory
condition|?
literal|" (mandatory)"
else|:
literal|""
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|tlv_type
condition|)
block|{
case|case
name|EAP_TLV_EAP_PAYLOAD_TLV
case|:
name|wpa_hexdump
argument_list|(
name|MSG_MSGDUMP
argument_list|,
literal|"EAP-FAST: EAP Payload TLV"
argument_list|,
name|pos
argument_list|,
name|len
argument_list|)
expr_stmt|;
name|eap_payload_tlv
operator|=
name|pos
expr_stmt|;
name|eap_payload_tlv_len
operator|=
name|len
expr_stmt|;
break|break;
case|case
name|EAP_TLV_RESULT_TLV
case|:
name|wpa_hexdump
argument_list|(
name|MSG_MSGDUMP
argument_list|,
literal|"EAP-FAST: Result TLV"
argument_list|,
name|pos
argument_list|,
name|len
argument_list|)
expr_stmt|;
if|if
condition|(
name|len
operator|<
literal|2
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"EAP-FAST: Too short "
literal|"Result TLV"
argument_list|)
expr_stmt|;
name|result
operator|=
name|EAP_TLV_RESULT_FAILURE
expr_stmt|;
break|break;
block|}
name|result
operator|=
name|WPA_GET_BE16
argument_list|(
name|pos
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|EAP_TLV_RESULT_SUCCESS
operator|&&
name|result
operator|!=
name|EAP_TLV_RESULT_FAILURE
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"EAP-FAST: Unknown "
literal|"Result %d"
argument_list|,
name|result
argument_list|)
expr_stmt|;
name|result
operator|=
name|EAP_TLV_RESULT_FAILURE
expr_stmt|;
block|}
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"EAP-FAST: Result: %s"
argument_list|,
name|result
operator|==
name|EAP_TLV_RESULT_SUCCESS
condition|?
literal|"Success"
else|:
literal|"Failure"
argument_list|)
expr_stmt|;
break|break;
case|case
name|EAP_TLV_INTERMEDIATE_RESULT_TLV
case|:
name|wpa_hexdump
argument_list|(
name|MSG_MSGDUMP
argument_list|,
literal|"EAP-FAST: Intermediate "
literal|"Result TLV"
argument_list|,
name|pos
argument_list|,
name|len
argument_list|)
expr_stmt|;
if|if
condition|(
name|len
operator|<
literal|2
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"EAP-FAST: Too short "
literal|"Intermediate Result TLV"
argument_list|)
expr_stmt|;
name|iresult
operator|=
name|EAP_TLV_RESULT_FAILURE
expr_stmt|;
break|break;
block|}
name|iresult
operator|=
name|WPA_GET_BE16
argument_list|(
name|pos
argument_list|)
expr_stmt|;
if|if
condition|(
name|iresult
operator|!=
name|EAP_TLV_RESULT_SUCCESS
operator|&&
name|iresult
operator|!=
name|EAP_TLV_RESULT_FAILURE
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"EAP-FAST: Unknown "
literal|"Intermediate Result %d"
argument_list|,
name|iresult
argument_list|)
expr_stmt|;
name|iresult
operator|=
name|EAP_TLV_RESULT_FAILURE
expr_stmt|;
block|}
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"EAP-FAST: Intermediate Result: %s"
argument_list|,
name|iresult
operator|==
name|EAP_TLV_RESULT_SUCCESS
condition|?
literal|"Success"
else|:
literal|"Failure"
argument_list|)
expr_stmt|;
break|break;
case|case
name|EAP_TLV_CRYPTO_BINDING_TLV_
case|:
name|wpa_hexdump
argument_list|(
name|MSG_MSGDUMP
argument_list|,
literal|"EAP-FAST: Crypto-Binding "
literal|"TLV"
argument_list|,
name|pos
argument_list|,
name|len
argument_list|)
expr_stmt|;
name|crypto_binding_len
operator|=
sizeof|sizeof
argument_list|(
expr|struct
name|eap_tlv_hdr
argument_list|)
operator|+
name|len
expr_stmt|;
if|if
condition|(
name|crypto_binding_len
operator|<
sizeof|sizeof
argument_list|(
operator|*
name|crypto_binding
argument_list|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"EAP-FAST: Too short "
literal|"Crypto-Binding TLV"
argument_list|)
expr_stmt|;
name|iresult
operator|=
name|EAP_TLV_RESULT_FAILURE
expr_stmt|;
name|pos
operator|=
name|end
expr_stmt|;
break|break;
block|}
name|crypto_binding
operator|=
operator|(
expr|struct
name|eap_tlv_crypto_binding__tlv
operator|*
operator|)
operator|(
name|pos
operator|-
sizeof|sizeof
argument_list|(
expr|struct
name|eap_tlv_hdr
argument_list|)
operator|)
expr_stmt|;
break|break;
case|case
name|EAP_TLV_PAC_TLV
case|:
name|wpa_hexdump
argument_list|(
name|MSG_MSGDUMP
argument_list|,
literal|"EAP-FAST: PAC TLV"
argument_list|,
name|pos
argument_list|,
name|len
argument_list|)
expr_stmt|;
name|pac
operator|=
name|pos
expr_stmt|;
name|pac_len
operator|=
name|len
expr_stmt|;
break|break;
default|default:
if|if
condition|(
name|mandatory
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"EAP-FAST: Nak unknown "
literal|"mandatory TLV type %d"
argument_list|,
name|tlv_type
argument_list|)
expr_stmt|;
name|resp
operator|=
name|eap_fast_tlv_nak
argument_list|(
literal|0
argument_list|,
name|tlv_type
argument_list|,
operator|&
name|resp_len
argument_list|)
expr_stmt|;
name|pos
operator|=
name|end
expr_stmt|;
block|}
else|else
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"EAP-FAST: ignored "
literal|"unknown optional TLV type %d"
argument_list|,
name|tlv_type
argument_list|)
expr_stmt|;
block|}
break|break;
block|}
name|pos
operator|+=
name|len
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|resp
operator|&&
name|result
operator|==
name|EAP_TLV_RESULT_FAILURE
condition|)
block|{
name|resp
operator|=
name|eap_fast_tlv_result
argument_list|(
name|EAP_TLV_RESULT_FAILURE
argument_list|,
literal|0
argument_list|,
operator|&
name|resp_len
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|resp
condition|)
block|{
name|free
argument_list|(
name|in_decrypted
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
block|}
if|if
condition|(
operator|!
name|resp
operator|&&
name|iresult
operator|==
name|EAP_TLV_RESULT_FAILURE
condition|)
block|{
name|resp
operator|=
name|eap_fast_tlv_result
argument_list|(
name|EAP_TLV_RESULT_FAILURE
argument_list|,
literal|1
argument_list|,
operator|&
name|resp_len
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|resp
condition|)
block|{
name|free
argument_list|(
name|in_decrypted
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
block|}
if|if
condition|(
operator|!
name|resp
operator|&&
name|eap_payload_tlv
condition|)
block|{
if|if
condition|(
name|eap_payload_tlv_len
operator|<
sizeof|sizeof
argument_list|(
operator|*
name|hdr
argument_list|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"EAP-FAST: too short EAP "
literal|"Payload TLV (len=%lu)"
argument_list|,
operator|(
name|unsigned
name|long
operator|)
name|eap_payload_tlv_len
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|in_decrypted
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
name|hdr
operator|=
operator|(
expr|struct
name|eap_hdr
operator|*
operator|)
name|eap_payload_tlv
expr_stmt|;
if|if
condition|(
name|be_to_host16
argument_list|(
name|hdr
operator|->
name|length
argument_list|)
operator|>
name|eap_payload_tlv_len
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"EAP-FAST: EAP packet overflow "
literal|"in EAP Payload TLV"
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|hdr
operator|->
name|code
operator|==
name|EAP_CODE_REQUEST
condition|)
block|{
if|if
condition|(
name|eap_fast_phase2_request
argument_list|(
name|sm
argument_list|,
name|data
argument_list|,
name|ret
argument_list|,
name|req
argument_list|,
name|hdr
argument_list|,
operator|&
name|resp
argument_list|,
operator|&
name|resp_len
argument_list|)
condition|)
block|{
name|free
argument_list|(
name|in_decrypted
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"EAP-FAST: Phase2 "
literal|"Request processing failed"
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
name|resp
operator|=
name|eap_fast_tlv_eap_payload
argument_list|(
name|resp
argument_list|,
operator|&
name|resp_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|resp
operator|==
name|NULL
condition|)
block|{
name|free
argument_list|(
name|in_decrypted
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
block|}
else|else
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"EAP-FAST: Unexpected code=%d in "
literal|"Phase 2 EAP header"
argument_list|,
name|hdr
operator|->
name|code
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|in_decrypted
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
block|}
if|if
condition|(
operator|!
name|resp
operator|&&
name|crypto_binding
condition|)
block|{
name|int
name|final
init|=
name|result
operator|==
name|EAP_TLV_RESULT_SUCCESS
decl_stmt|;
name|resp
operator|=
name|eap_fast_process_crypto_binding
argument_list|(
name|sm
argument_list|,
name|data
argument_list|,
name|ret
argument_list|,
name|crypto_binding
argument_list|,
name|crypto_binding_len
argument_list|,
operator|&
name|resp_len
argument_list|,
name|final
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|resp
condition|)
block|{
name|free
argument_list|(
name|in_decrypted
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
block|}
if|if
condition|(
operator|!
name|resp
operator|&&
name|pac
operator|&&
name|result
operator|!=
name|EAP_TLV_RESULT_SUCCESS
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"EAP-FAST: PAC TLV without Result TLV "
literal|"acknowledging success"
argument_list|)
expr_stmt|;
name|resp
operator|=
name|eap_fast_tlv_result
argument_list|(
name|EAP_TLV_RESULT_FAILURE
argument_list|,
literal|0
argument_list|,
operator|&
name|resp_len
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|resp
condition|)
block|{
name|free
argument_list|(
name|in_decrypted
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
block|}
if|if
condition|(
operator|!
name|resp
operator|&&
name|pac
operator|&&
name|result
operator|==
name|EAP_TLV_RESULT_SUCCESS
condition|)
block|{
name|resp
operator|=
name|eap_fast_process_pac
argument_list|(
name|sm
argument_list|,
name|data
argument_list|,
name|ret
argument_list|,
name|pac
argument_list|,
name|pac_len
argument_list|,
operator|&
name|resp_len
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|resp
condition|)
block|{
name|free
argument_list|(
name|in_decrypted
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
block|}
name|free
argument_list|(
name|in_decrypted
argument_list|)
expr_stmt|;
if|if
condition|(
name|resp
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"EAP-FAST: No recognized TLVs - send "
literal|"empty response packet"
argument_list|)
expr_stmt|;
name|resp
operator|=
name|malloc
argument_list|(
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|resp
operator|==
name|NULL
condition|)
return|return
literal|0
return|;
name|resp_len
operator|=
literal|0
expr_stmt|;
block|}
name|wpa_hexdump
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"EAP-FAST: Encrypting Phase 2 data"
argument_list|,
name|resp
argument_list|,
name|resp_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|eap_fast_encrypt
argument_list|(
name|sm
argument_list|,
name|data
argument_list|,
name|req
operator|->
name|identifier
argument_list|,
name|resp
argument_list|,
name|resp_len
argument_list|,
name|out_data
argument_list|,
name|out_len
argument_list|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"EAP-FAST: Failed to encrypt a Phase 2 "
literal|"frame"
argument_list|)
expr_stmt|;
block|}
name|free
argument_list|(
name|resp
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|u8
modifier|*
name|eap_fast_process
parameter_list|(
name|struct
name|eap_sm
modifier|*
name|sm
parameter_list|,
name|void
modifier|*
name|priv
parameter_list|,
name|struct
name|eap_method_ret
modifier|*
name|ret
parameter_list|,
specifier|const
name|u8
modifier|*
name|reqData
parameter_list|,
name|size_t
name|reqDataLen
parameter_list|,
name|size_t
modifier|*
name|respDataLen
parameter_list|)
block|{
specifier|const
name|struct
name|eap_hdr
modifier|*
name|req
decl_stmt|;
name|size_t
name|left
decl_stmt|;
name|int
name|res
decl_stmt|;
name|u8
name|flags
decl_stmt|,
modifier|*
name|resp
decl_stmt|,
name|id
decl_stmt|;
specifier|const
name|u8
modifier|*
name|pos
decl_stmt|;
name|struct
name|eap_fast_data
modifier|*
name|data
init|=
name|priv
decl_stmt|;
name|pos
operator|=
name|eap_tls_process_init
argument_list|(
name|sm
argument_list|,
operator|&
name|data
operator|->
name|ssl
argument_list|,
name|EAP_TYPE_FAST
argument_list|,
name|ret
argument_list|,
name|reqData
argument_list|,
name|reqDataLen
argument_list|,
operator|&
name|left
argument_list|,
operator|&
name|flags
argument_list|)
expr_stmt|;
if|if
condition|(
name|pos
operator|==
name|NULL
condition|)
return|return
name|NULL
return|;
name|req
operator|=
operator|(
specifier|const
expr|struct
name|eap_hdr
operator|*
operator|)
name|reqData
expr_stmt|;
name|id
operator|=
name|req
operator|->
name|identifier
expr_stmt|;
if|if
condition|(
name|flags
operator|&
name|EAP_TLS_FLAGS_START
condition|)
block|{
specifier|const
name|u8
modifier|*
name|a_id
decl_stmt|;
name|size_t
name|a_id_len
decl_stmt|;
name|struct
name|pac_tlv_hdr
modifier|*
name|hdr
decl_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"EAP-FAST: Start (server ver=%d, own "
literal|"ver=%d)"
argument_list|,
name|flags
operator|&
name|EAP_PEAP_VERSION_MASK
argument_list|,
name|data
operator|->
name|fast_version
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|flags
operator|&
name|EAP_PEAP_VERSION_MASK
operator|)
operator|<
name|data
operator|->
name|fast_version
condition|)
name|data
operator|->
name|fast_version
operator|=
name|flags
operator|&
name|EAP_PEAP_VERSION_MASK
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"EAP-FAST: Using FAST version %d"
argument_list|,
name|data
operator|->
name|fast_version
argument_list|)
expr_stmt|;
name|a_id
operator|=
name|pos
expr_stmt|;
name|a_id_len
operator|=
name|left
expr_stmt|;
if|if
condition|(
name|left
operator|>
sizeof|sizeof
argument_list|(
operator|*
name|hdr
argument_list|)
condition|)
block|{
name|int
name|tlen
decl_stmt|;
name|hdr
operator|=
operator|(
expr|struct
name|pac_tlv_hdr
operator|*
operator|)
name|pos
expr_stmt|;
name|tlen
operator|=
name|be_to_host16
argument_list|(
name|hdr
operator|->
name|len
argument_list|)
expr_stmt|;
if|if
condition|(
name|be_to_host16
argument_list|(
name|hdr
operator|->
name|type
argument_list|)
operator|==
name|PAC_TYPE_A_ID
operator|&&
sizeof|sizeof
argument_list|(
operator|*
name|hdr
argument_list|)
operator|+
name|tlen
operator|<=
name|left
condition|)
block|{
name|a_id
operator|=
operator|(
name|u8
operator|*
operator|)
operator|(
name|hdr
operator|+
literal|1
operator|)
expr_stmt|;
name|a_id_len
operator|=
name|tlen
expr_stmt|;
block|}
block|}
name|wpa_hexdump_ascii
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"EAP-FAST: A-ID"
argument_list|,
name|a_id
argument_list|,
name|a_id_len
argument_list|)
expr_stmt|;
name|data
operator|->
name|current_pac
operator|=
name|eap_fast_get_pac
argument_list|(
name|data
argument_list|,
name|a_id
argument_list|,
name|a_id_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|data
operator|->
name|current_pac
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"EAP-FAST: PAC found for this "
literal|"A-ID"
argument_list|)
expr_stmt|;
name|wpa_hexdump_ascii
argument_list|(
name|MSG_MSGDUMP
argument_list|,
literal|"EAP-FAST: A-ID-Info"
argument_list|,
name|data
operator|->
name|current_pac
operator|->
name|a_id_info
argument_list|,
name|data
operator|->
name|current_pac
operator|->
name|a_id_info_len
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|data
operator|->
name|resuming
operator|&&
name|data
operator|->
name|current_pac
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"EAP-FAST: Trying to resume "
literal|"session - do not add PAC-Opaque to TLS "
literal|"ClientHello"
argument_list|)
expr_stmt|;
if|if
condition|(
name|tls_connection_client_hello_ext
argument_list|(
name|sm
operator|->
name|ssl_ctx
argument_list|,
name|data
operator|->
name|ssl
operator|.
name|conn
argument_list|,
name|TLS_EXT_PAC_OPAQUE
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
operator|<
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"EAP-FAST: Failed to "
literal|"remove PAC-Opaque TLS extension"
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
block|}
elseif|else
if|if
condition|(
name|data
operator|->
name|current_pac
condition|)
block|{
name|u8
modifier|*
name|tlv
decl_stmt|;
name|size_t
name|tlv_len
decl_stmt|,
name|olen
decl_stmt|;
name|struct
name|eap_tlv_hdr
modifier|*
name|hdr
decl_stmt|;
name|olen
operator|=
name|data
operator|->
name|current_pac
operator|->
name|pac_opaque_len
expr_stmt|;
name|tlv_len
operator|=
sizeof|sizeof
argument_list|(
operator|*
name|hdr
argument_list|)
operator|+
name|olen
expr_stmt|;
name|tlv
operator|=
name|malloc
argument_list|(
name|tlv_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|tlv
condition|)
block|{
name|hdr
operator|=
operator|(
expr|struct
name|eap_tlv_hdr
operator|*
operator|)
name|tlv
expr_stmt|;
name|hdr
operator|->
name|tlv_type
operator|=
name|host_to_be16
argument_list|(
name|PAC_TYPE_PAC_OPAQUE
argument_list|)
expr_stmt|;
name|hdr
operator|->
name|length
operator|=
name|host_to_be16
argument_list|(
name|olen
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
name|hdr
operator|+
literal|1
argument_list|,
name|data
operator|->
name|current_pac
operator|->
name|pac_opaque
argument_list|,
name|olen
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|tlv
operator|==
name|NULL
operator|||
name|tls_connection_client_hello_ext
argument_list|(
name|sm
operator|->
name|ssl_ctx
argument_list|,
name|data
operator|->
name|ssl
operator|.
name|conn
argument_list|,
name|TLS_EXT_PAC_OPAQUE
argument_list|,
name|tlv
argument_list|,
name|tlv_len
argument_list|)
operator|<
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"EAP-FAST: Failed to "
literal|"add PAC-Opaque TLS extension"
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|tlv
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|free
argument_list|(
name|tlv
argument_list|)
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
operator|!
name|data
operator|->
name|provisioning_allowed
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"EAP-FAST: No PAC found "
literal|"and provisioning disabled"
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"EAP-FAST: No PAC found - "
literal|"starting provisioning"
argument_list|)
expr_stmt|;
if|if
condition|(
name|tls_connection_set_anon_dh
argument_list|(
name|sm
operator|->
name|ssl_ctx
argument_list|,
name|data
operator|->
name|ssl
operator|.
name|conn
argument_list|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"EAP-FAST: Could not "
literal|"configure anonymous DH for TLS "
literal|"connection"
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
if|if
condition|(
name|tls_connection_client_hello_ext
argument_list|(
name|sm
operator|->
name|ssl_ctx
argument_list|,
name|data
operator|->
name|ssl
operator|.
name|conn
argument_list|,
name|TLS_EXT_PAC_OPAQUE
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
operator|<
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"EAP-FAST: Failed to "
literal|"remove PAC-Opaque TLS extension"
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|data
operator|->
name|provisioning
operator|=
literal|1
expr_stmt|;
block|}
name|left
operator|=
literal|0
expr_stmt|;
comment|/* A-ID is not used in further packet processing */
block|}
name|resp
operator|=
name|NULL
expr_stmt|;
if|if
condition|(
name|tls_connection_established
argument_list|(
name|sm
operator|->
name|ssl_ctx
argument_list|,
name|data
operator|->
name|ssl
operator|.
name|conn
argument_list|)
operator|&&
operator|!
name|data
operator|->
name|resuming
condition|)
block|{
name|res
operator|=
name|eap_fast_decrypt
argument_list|(
name|sm
argument_list|,
name|data
argument_list|,
name|ret
argument_list|,
name|req
argument_list|,
name|pos
argument_list|,
name|left
argument_list|,
operator|&
name|resp
argument_list|,
name|respDataLen
argument_list|)
expr_stmt|;
if|if
condition|(
name|res
operator|<
literal|0
condition|)
block|{
name|ret
operator|->
name|methodState
operator|=
name|METHOD_DONE
expr_stmt|;
name|ret
operator|->
name|decision
operator|=
name|DECISION_FAIL
expr_stmt|;
comment|/* Ack possible Alert that may have caused failure in 			 * decryption */
name|res
operator|=
literal|1
expr_stmt|;
block|}
block|}
else|else
block|{
if|if
condition|(
name|eap_fast_set_tls_master_secret
argument_list|(
name|sm
argument_list|,
name|data
argument_list|,
name|pos
argument_list|,
name|left
argument_list|)
operator|<
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"EAP-FAST: Failed to configure "
literal|"TLS master secret"
argument_list|)
expr_stmt|;
name|ret
operator|->
name|methodState
operator|=
name|METHOD_DONE
expr_stmt|;
name|ret
operator|->
name|decision
operator|=
name|DECISION_FAIL
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|res
operator|=
name|eap_tls_process_helper
argument_list|(
name|sm
argument_list|,
operator|&
name|data
operator|->
name|ssl
argument_list|,
name|EAP_TYPE_FAST
argument_list|,
name|data
operator|->
name|fast_version
argument_list|,
name|id
argument_list|,
name|pos
argument_list|,
name|left
argument_list|,
operator|&
name|resp
argument_list|,
name|respDataLen
argument_list|)
expr_stmt|;
if|if
condition|(
name|tls_connection_established
argument_list|(
name|sm
operator|->
name|ssl_ctx
argument_list|,
name|data
operator|->
name|ssl
operator|.
name|conn
argument_list|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"EAP-FAST: TLS done, proceed to Phase 2"
argument_list|)
expr_stmt|;
name|data
operator|->
name|resuming
operator|=
literal|0
expr_stmt|;
name|eap_fast_derive_keys
argument_list|(
name|sm
argument_list|,
name|data
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
name|res
operator|==
literal|1
condition|)
return|return
name|eap_tls_build_ack
argument_list|(
operator|&
name|data
operator|->
name|ssl
argument_list|,
name|respDataLen
argument_list|,
name|id
argument_list|,
name|EAP_TYPE_FAST
argument_list|,
name|data
operator|->
name|fast_version
argument_list|)
return|;
return|return
name|resp
return|;
block|}
end_function

begin_if
if|#
directive|if
literal|0
end_if

begin_comment
comment|/* FIX */
end_comment

begin_endif
unit|static Boolean eap_fast_has_reauth_data(struct eap_sm *sm, void *priv) { 	struct eap_fast_data *data = priv; 	return tls_connection_established(sm->ssl_ctx, data->ssl.conn); }   static void eap_fast_deinit_for_reauth(struct eap_sm *sm, void *priv) { }   static void * eap_fast_init_for_reauth(struct eap_sm *sm, void *priv) { 	struct eap_fast_data *data = priv; 	if (eap_tls_reauth_init(sm,&data->ssl)) { 		free(data); 		return NULL; 	} 	data->phase2_success = 0; 	data->resuming = 1; 	data->provisioning = 0; 	return priv; }
endif|#
directive|endif
end_endif

begin_function
specifier|static
name|int
name|eap_fast_get_status
parameter_list|(
name|struct
name|eap_sm
modifier|*
name|sm
parameter_list|,
name|void
modifier|*
name|priv
parameter_list|,
name|char
modifier|*
name|buf
parameter_list|,
name|size_t
name|buflen
parameter_list|,
name|int
name|verbose
parameter_list|)
block|{
name|struct
name|eap_fast_data
modifier|*
name|data
init|=
name|priv
decl_stmt|;
return|return
name|eap_tls_status
argument_list|(
name|sm
argument_list|,
operator|&
name|data
operator|->
name|ssl
argument_list|,
name|buf
argument_list|,
name|buflen
argument_list|,
name|verbose
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|Boolean
name|eap_fast_isKeyAvailable
parameter_list|(
name|struct
name|eap_sm
modifier|*
name|sm
parameter_list|,
name|void
modifier|*
name|priv
parameter_list|)
block|{
name|struct
name|eap_fast_data
modifier|*
name|data
init|=
name|priv
decl_stmt|;
return|return
name|data
operator|->
name|success
return|;
block|}
end_function

begin_function
specifier|static
name|u8
modifier|*
name|eap_fast_getKey
parameter_list|(
name|struct
name|eap_sm
modifier|*
name|sm
parameter_list|,
name|void
modifier|*
name|priv
parameter_list|,
name|size_t
modifier|*
name|len
parameter_list|)
block|{
name|struct
name|eap_fast_data
modifier|*
name|data
init|=
name|priv
decl_stmt|;
name|u8
modifier|*
name|key
decl_stmt|;
if|if
condition|(
operator|!
name|data
operator|->
name|success
condition|)
return|return
name|NULL
return|;
name|key
operator|=
name|malloc
argument_list|(
name|EAP_FAST_KEY_LEN
argument_list|)
expr_stmt|;
if|if
condition|(
name|key
operator|==
name|NULL
condition|)
return|return
name|NULL
return|;
operator|*
name|len
operator|=
name|EAP_FAST_KEY_LEN
expr_stmt|;
name|memcpy
argument_list|(
name|key
argument_list|,
name|data
operator|->
name|key_data
argument_list|,
name|EAP_FAST_KEY_LEN
argument_list|)
expr_stmt|;
return|return
name|key
return|;
block|}
end_function

begin_decl_stmt
specifier|const
name|struct
name|eap_method
name|eap_method_fast
init|=
block|{
operator|.
name|method
operator|=
name|EAP_TYPE_FAST
block|,
operator|.
name|name
operator|=
literal|"FAST"
block|,
operator|.
name|init
operator|=
name|eap_fast_init
block|,
operator|.
name|deinit
operator|=
name|eap_fast_deinit
block|,
operator|.
name|process
operator|=
name|eap_fast_process
block|,
operator|.
name|isKeyAvailable
operator|=
name|eap_fast_isKeyAvailable
block|,
operator|.
name|getKey
operator|=
name|eap_fast_getKey
block|,
operator|.
name|get_status
operator|=
name|eap_fast_get_status
block|,
if|#
directive|if
literal|0
block|.has_reauth_data = eap_fast_has_reauth_data, 	.deinit_for_reauth = eap_fast_deinit_for_reauth, 	.init_for_reauth = eap_fast_init_for_reauth,
endif|#
directive|endif
block|}
decl_stmt|;
end_decl_stmt

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * WPA Supplicant - Windows/NDIS driver interface  * Copyright (c) 2004-2005, Jouni Malinen<jkmaline@cc.hut.fi>  *  * This program is free software; you can redistribute it and/or modify  * it under the terms of the GNU General Public License version 2 as  * published by the Free Software Foundation.  *  * Alternatively, this software may be distributed under the terms of BSD  * license.  *  * See README and COPYING for more details.  */
end_comment

begin_include
include|#
directive|include
file|<stdlib.h>
end_include

begin_include
include|#
directive|include
file|<Packet32.h>
end_include

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_include
include|#
directive|include
file|<string.h>
end_include

begin_include
include|#
directive|include
file|<sys/unistd.h>
end_include

begin_include
include|#
directive|include
file|<ntddndis.h>
end_include

begin_include
include|#
directive|include
file|"common.h"
end_include

begin_include
include|#
directive|include
file|"driver.h"
end_include

begin_include
include|#
directive|include
file|"wpa_supplicant.h"
end_include

begin_include
include|#
directive|include
file|"l2_packet.h"
end_include

begin_include
include|#
directive|include
file|"eloop.h"
end_include

begin_include
include|#
directive|include
file|"wpa.h"
end_include

begin_include
include|#
directive|include
file|"driver_ndis.h"
end_include

begin_function_decl
name|int
name|wpa_driver_register_event_cb
parameter_list|(
name|struct
name|wpa_driver_ndis_data
modifier|*
name|drv
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|wpa_driver_ndis_poll
parameter_list|(
name|void
modifier|*
name|drv
parameter_list|)
function_decl|;
end_function_decl

begin_comment
comment|/* FIX: to be removed once this can be compiled with the complete NDIS  * header files */
end_comment

begin_ifndef
ifndef|#
directive|ifndef
name|OID_802_11_BSSID
end_ifndef

begin_define
define|#
directive|define
name|OID_802_11_BSSID
value|0x0d010101
end_define

begin_define
define|#
directive|define
name|OID_802_11_SSID
value|0x0d010102
end_define

begin_define
define|#
directive|define
name|OID_802_11_INFRASTRUCTURE_MODE
value|0x0d010108
end_define

begin_define
define|#
directive|define
name|OID_802_11_ADD_WEP
value|0x0D010113
end_define

begin_define
define|#
directive|define
name|OID_802_11_REMOVE_WEP
value|0x0D010114
end_define

begin_define
define|#
directive|define
name|OID_802_11_DISASSOCIATE
value|0x0D010115
end_define

begin_define
define|#
directive|define
name|OID_802_11_BSSID_LIST
value|0x0d010217
end_define

begin_define
define|#
directive|define
name|OID_802_11_AUTHENTICATION_MODE
value|0x0d010118
end_define

begin_define
define|#
directive|define
name|OID_802_11_PRIVACY_FILTER
value|0x0d010119
end_define

begin_define
define|#
directive|define
name|OID_802_11_BSSID_LIST_SCAN
value|0x0d01011A
end_define

begin_define
define|#
directive|define
name|OID_802_11_WEP_STATUS
value|0x0d01011B
end_define

begin_define
define|#
directive|define
name|OID_802_11_ENCRYPTION_STATUS
value|OID_802_11_WEP_STATUS
end_define

begin_define
define|#
directive|define
name|OID_802_11_ADD_KEY
value|0x0d01011D
end_define

begin_define
define|#
directive|define
name|OID_802_11_REMOVE_KEY
value|0x0d01011E
end_define

begin_define
define|#
directive|define
name|OID_802_11_ASSOCIATION_INFORMATION
value|0x0d01011F
end_define

begin_define
define|#
directive|define
name|OID_802_11_TEST
value|0x0d010120
end_define

begin_define
define|#
directive|define
name|OID_802_11_CAPABILITY
value|0x0d010122
end_define

begin_define
define|#
directive|define
name|OID_802_11_PMKID
value|0x0d010123
end_define

begin_define
define|#
directive|define
name|NDIS_802_11_LENGTH_SSID
value|32
end_define

begin_define
define|#
directive|define
name|NDIS_802_11_LENGTH_RATES
value|8
end_define

begin_define
define|#
directive|define
name|NDIS_802_11_LENGTH_RATES_EX
value|16
end_define

begin_typedef
typedef|typedef
name|UCHAR
name|NDIS_802_11_MAC_ADDRESS
index|[
literal|6
index|]
typedef|;
end_typedef

begin_typedef
typedef|typedef
struct|struct
name|NDIS_802_11_SSID
block|{
name|ULONG
name|SsidLength
decl_stmt|;
name|UCHAR
name|Ssid
index|[
name|NDIS_802_11_LENGTH_SSID
index|]
decl_stmt|;
block|}
name|NDIS_802_11_SSID
typedef|;
end_typedef

begin_typedef
typedef|typedef
name|LONG
name|NDIS_802_11_RSSI
typedef|;
end_typedef

begin_typedef
typedef|typedef
enum|enum
name|NDIS_802_11_NETWORK_TYPE
block|{
name|Ndis802_11FH
block|,
name|Ndis802_11DS
block|,
name|Ndis802_11OFDM5
block|,
name|Ndis802_11OFDM24
block|,
name|Ndis802_11NetworkTypeMax
block|}
name|NDIS_802_11_NETWORK_TYPE
typedef|;
end_typedef

begin_typedef
typedef|typedef
struct|struct
name|NDIS_802_11_CONFIGURATION_FH
block|{
name|ULONG
name|Length
decl_stmt|;
name|ULONG
name|HopPattern
decl_stmt|;
name|ULONG
name|HopSet
decl_stmt|;
name|ULONG
name|DwellTime
decl_stmt|;
block|}
name|NDIS_802_11_CONFIGURATION_FH
typedef|;
end_typedef

begin_typedef
typedef|typedef
struct|struct
name|NDIS_802_11_CONFIGURATION
block|{
name|ULONG
name|Length
decl_stmt|;
name|ULONG
name|BeaconPeriod
decl_stmt|;
name|ULONG
name|ATIMWindow
decl_stmt|;
name|ULONG
name|DSConfig
decl_stmt|;
name|NDIS_802_11_CONFIGURATION_FH
name|FHConfig
decl_stmt|;
block|}
name|NDIS_802_11_CONFIGURATION
typedef|;
end_typedef

begin_typedef
typedef|typedef
enum|enum
name|NDIS_802_11_NETWORK_INFRASTRUCTURE
block|{
name|Ndis802_11IBSS
block|,
name|Ndis802_11Infrastructure
block|,
name|Ndis802_11AutoUnknown
block|,
name|Ndis802_11InfrastructureMax
block|}
name|NDIS_802_11_NETWORK_INFRASTRUCTURE
typedef|;
end_typedef

begin_typedef
typedef|typedef
enum|enum
name|NDIS_802_11_AUTHENTICATION_MODE
block|{
name|Ndis802_11AuthModeOpen
block|,
name|Ndis802_11AuthModeShared
block|,
name|Ndis802_11AuthModeAutoSwitch
block|,
name|Ndis802_11AuthModeWPA
block|,
name|Ndis802_11AuthModeWPAPSK
block|,
name|Ndis802_11AuthModeWPANone
block|,
name|Ndis802_11AuthModeWPA2
block|,
name|Ndis802_11AuthModeWPA2PSK
block|,
name|Ndis802_11AuthModeMax
block|}
name|NDIS_802_11_AUTHENTICATION_MODE
typedef|;
end_typedef

begin_typedef
typedef|typedef
enum|enum
name|NDIS_802_11_WEP_STATUS
block|{
name|Ndis802_11WEPEnabled
block|,
name|Ndis802_11Encryption1Enabled
init|=
name|Ndis802_11WEPEnabled
block|,
name|Ndis802_11WEPDisabled
block|,
name|Ndis802_11EncryptionDisabled
init|=
name|Ndis802_11WEPDisabled
block|,
name|Ndis802_11WEPKeyAbsent
block|,
name|Ndis802_11Encryption1KeyAbsent
init|=
name|Ndis802_11WEPKeyAbsent
block|,
name|Ndis802_11WEPNotSupported
block|,
name|Ndis802_11EncryptionNotSupported
init|=
name|Ndis802_11WEPNotSupported
block|,
name|Ndis802_11Encryption2Enabled
block|,
name|Ndis802_11Encryption2KeyAbsent
block|,
name|Ndis802_11Encryption3Enabled
block|,
name|Ndis802_11Encryption3KeyAbsent
block|}
name|NDIS_802_11_WEP_STATUS
operator|,
name|NDIS_802_11_ENCRYPTION_STATUS
typedef|;
end_typedef

begin_typedef
typedef|typedef
enum|enum
name|NDIS_802_11_PRIVACY_FILTER
block|{
name|Ndis802_11PrivFilterAcceptAll
block|,
name|Ndis802_11PrivFilter8021xWEP
block|}
name|NDIS_802_11_PRIVACY_FILTER
typedef|;
end_typedef

begin_typedef
typedef|typedef
name|UCHAR
name|NDIS_802_11_RATES
index|[
name|NDIS_802_11_LENGTH_RATES
index|]
typedef|;
end_typedef

begin_typedef
typedef|typedef
name|UCHAR
name|NDIS_802_11_RATES_EX
index|[
name|NDIS_802_11_LENGTH_RATES_EX
index|]
typedef|;
end_typedef

begin_typedef
typedef|typedef
struct|struct
name|NDIS_WLAN_BSSID_EX
block|{
name|ULONG
name|Length
decl_stmt|;
name|NDIS_802_11_MAC_ADDRESS
name|MacAddress
decl_stmt|;
comment|/* BSSID */
name|UCHAR
name|Reserved
index|[
literal|2
index|]
decl_stmt|;
name|NDIS_802_11_SSID
name|Ssid
decl_stmt|;
name|ULONG
name|Privacy
decl_stmt|;
name|NDIS_802_11_RSSI
name|Rssi
decl_stmt|;
name|NDIS_802_11_NETWORK_TYPE
name|NetworkTypeInUse
decl_stmt|;
name|NDIS_802_11_CONFIGURATION
name|Configuration
decl_stmt|;
name|NDIS_802_11_NETWORK_INFRASTRUCTURE
name|InfrastructureMode
decl_stmt|;
name|NDIS_802_11_RATES_EX
name|SupportedRates
decl_stmt|;
name|ULONG
name|IELength
decl_stmt|;
name|UCHAR
name|IEs
index|[
literal|1
index|]
decl_stmt|;
block|}
name|NDIS_WLAN_BSSID_EX
typedef|;
end_typedef

begin_typedef
typedef|typedef
struct|struct
name|NDIS_802_11_BSSID_LIST_EX
block|{
name|ULONG
name|NumberOfItems
decl_stmt|;
name|NDIS_WLAN_BSSID_EX
name|Bssid
index|[
literal|1
index|]
decl_stmt|;
block|}
name|NDIS_802_11_BSSID_LIST_EX
typedef|;
end_typedef

begin_typedef
typedef|typedef
struct|struct
name|NDIS_802_11_FIXED_IEs
block|{
name|UCHAR
name|Timestamp
index|[
literal|8
index|]
decl_stmt|;
name|USHORT
name|BeaconInterval
decl_stmt|;
name|USHORT
name|Capabilities
decl_stmt|;
block|}
name|NDIS_802_11_FIXED_IEs
typedef|;
end_typedef

begin_typedef
typedef|typedef
struct|struct
name|NDIS_802_11_WEP
block|{
name|ULONG
name|Length
decl_stmt|;
name|ULONG
name|KeyIndex
decl_stmt|;
name|ULONG
name|KeyLength
decl_stmt|;
name|UCHAR
name|KeyMaterial
index|[
literal|1
index|]
decl_stmt|;
block|}
name|NDIS_802_11_WEP
typedef|;
end_typedef

begin_typedef
typedef|typedef
name|ULONG
name|NDIS_802_11_KEY_INDEX
typedef|;
end_typedef

begin_typedef
typedef|typedef
name|ULONGLONG
name|NDIS_802_11_KEY_RSC
typedef|;
end_typedef

begin_typedef
typedef|typedef
struct|struct
name|NDIS_802_11_KEY
block|{
name|ULONG
name|Length
decl_stmt|;
name|ULONG
name|KeyIndex
decl_stmt|;
name|ULONG
name|KeyLength
decl_stmt|;
name|NDIS_802_11_MAC_ADDRESS
name|BSSID
decl_stmt|;
name|NDIS_802_11_KEY_RSC
name|KeyRSC
decl_stmt|;
name|UCHAR
name|KeyMaterial
index|[
literal|1
index|]
decl_stmt|;
block|}
name|NDIS_802_11_KEY
typedef|;
end_typedef

begin_typedef
typedef|typedef
struct|struct
name|NDIS_802_11_REMOVE_KEY
block|{
name|ULONG
name|Length
decl_stmt|;
name|ULONG
name|KeyIndex
decl_stmt|;
name|NDIS_802_11_MAC_ADDRESS
name|BSSID
decl_stmt|;
block|}
name|NDIS_802_11_REMOVE_KEY
typedef|;
end_typedef

begin_typedef
typedef|typedef
struct|struct
name|NDIS_802_11_AI_REQFI
block|{
name|USHORT
name|Capabilities
decl_stmt|;
name|USHORT
name|ListenInterval
decl_stmt|;
name|NDIS_802_11_MAC_ADDRESS
name|CurrentAPAddress
decl_stmt|;
block|}
name|NDIS_802_11_AI_REQFI
typedef|;
end_typedef

begin_typedef
typedef|typedef
struct|struct
name|NDIS_802_11_AI_RESFI
block|{
name|USHORT
name|Capabilities
decl_stmt|;
name|USHORT
name|StatusCode
decl_stmt|;
name|USHORT
name|AssociationId
decl_stmt|;
block|}
name|NDIS_802_11_AI_RESFI
typedef|;
end_typedef

begin_typedef
typedef|typedef
struct|struct
name|NDIS_802_11_ASSOCIATION_INFORMATION
block|{
name|ULONG
name|Length
decl_stmt|;
name|USHORT
name|AvailableRequestFixedIEs
decl_stmt|;
name|NDIS_802_11_AI_REQFI
name|RequestFixedIEs
decl_stmt|;
name|ULONG
name|RequestIELength
decl_stmt|;
name|ULONG
name|OffsetRequestIEs
decl_stmt|;
name|USHORT
name|AvailableResponseFixedIEs
decl_stmt|;
name|NDIS_802_11_AI_RESFI
name|ResponseFixedIEs
decl_stmt|;
name|ULONG
name|ResponseIELength
decl_stmt|;
name|ULONG
name|OffsetResponseIEs
decl_stmt|;
block|}
name|NDIS_802_11_ASSOCIATION_INFORMATION
typedef|;
end_typedef

begin_typedef
typedef|typedef
struct|struct
name|NDIS_802_11_AUTHENTICATION_ENCRYPTION
block|{
name|NDIS_802_11_AUTHENTICATION_MODE
name|AuthModeSupported
decl_stmt|;
name|NDIS_802_11_ENCRYPTION_STATUS
name|EncryptStatusSupported
decl_stmt|;
block|}
name|NDIS_802_11_AUTHENTICATION_ENCRYPTION
typedef|;
end_typedef

begin_typedef
typedef|typedef
struct|struct
name|NDIS_802_11_CAPABILITY
block|{
name|ULONG
name|Length
decl_stmt|;
name|ULONG
name|Version
decl_stmt|;
name|ULONG
name|NoOfPMKIDs
decl_stmt|;
name|ULONG
name|NoOfAuthEncryptPairSupported
decl_stmt|;
name|NDIS_802_11_AUTHENTICATION_ENCRYPTION
name|AuthenticationEncryptionSupported
index|[
literal|1
index|]
decl_stmt|;
block|}
name|NDIS_802_11_CAPABILITY
typedef|;
end_typedef

begin_typedef
typedef|typedef
name|UCHAR
name|NDIS_802_11_PMKID_VALUE
index|[
literal|16
index|]
typedef|;
end_typedef

begin_typedef
typedef|typedef
struct|struct
name|BSSID_INFO
block|{
name|NDIS_802_11_MAC_ADDRESS
name|BSSID
decl_stmt|;
name|NDIS_802_11_PMKID_VALUE
name|PMKID
decl_stmt|;
block|}
name|BSSID_INFO
typedef|;
end_typedef

begin_typedef
typedef|typedef
struct|struct
name|NDIS_802_11_PMKID
block|{
name|ULONG
name|Length
decl_stmt|;
name|ULONG
name|BSSIDInfoCount
decl_stmt|;
name|BSSID_INFO
name|BSSIDInfo
index|[
literal|1
index|]
decl_stmt|;
block|}
name|NDIS_802_11_PMKID
typedef|;
end_typedef

begin_typedef
typedef|typedef
enum|enum
name|NDIS_802_11_STATUS_TYPE
block|{
name|Ndis802_11StatusType_Authentication
block|,
name|Ndis802_11StatusType_PMKID_CandidateList
init|=
literal|2
block|,
name|Ndis802_11StatusTypeMax
block|}
name|NDIS_802_11_STATUS_TYPE
typedef|;
end_typedef

begin_typedef
typedef|typedef
struct|struct
name|NDIS_802_11_STATUS_INDICATION
block|{
name|NDIS_802_11_STATUS_TYPE
name|StatusType
decl_stmt|;
block|}
name|NDIS_802_11_STATUS_INDICATION
typedef|;
end_typedef

begin_typedef
typedef|typedef
struct|struct
name|PMKID_CANDIDATE
block|{
name|NDIS_802_11_MAC_ADDRESS
name|BSSID
decl_stmt|;
name|ULONG
name|Flags
decl_stmt|;
block|}
name|PMKID_CANDIDATE
typedef|;
end_typedef

begin_define
define|#
directive|define
name|NDIS_802_11_PMKID_CANDIDATE_PREAUTH_ENABLED
value|0x01
end_define

begin_typedef
typedef|typedef
struct|struct
name|NDIS_802_11_PMKID_CANDIDATE_LIST
block|{
name|ULONG
name|Version
decl_stmt|;
name|ULONG
name|NumCandidates
decl_stmt|;
name|PMKID_CANDIDATE
name|CandidateList
index|[
literal|1
index|]
decl_stmt|;
block|}
name|NDIS_802_11_PMKID_CANDIDATE_LIST
typedef|;
end_typedef

begin_typedef
typedef|typedef
struct|struct
name|NDIS_802_11_AUTHENTICATION_REQUEST
block|{
name|ULONG
name|Length
decl_stmt|;
name|NDIS_802_11_MAC_ADDRESS
name|Bssid
decl_stmt|;
name|ULONG
name|Flags
decl_stmt|;
block|}
name|NDIS_802_11_AUTHENTICATION_REQUEST
typedef|;
end_typedef

begin_define
define|#
directive|define
name|NDIS_802_11_AUTH_REQUEST_REAUTH
value|0x01
end_define

begin_define
define|#
directive|define
name|NDIS_802_11_AUTH_REQUEST_KEYUPDATE
value|0x02
end_define

begin_define
define|#
directive|define
name|NDIS_802_11_AUTH_REQUEST_PAIRWISE_ERROR
value|0x06
end_define

begin_define
define|#
directive|define
name|NDIS_802_11_AUTH_REQUEST_GROUP_ERROR
value|0x0E
end_define

begin_endif
endif|#
directive|endif
end_endif

begin_function
specifier|static
name|int
name|ndis_get_oid
parameter_list|(
name|struct
name|wpa_driver_ndis_data
modifier|*
name|drv
parameter_list|,
name|unsigned
name|int
name|oid
parameter_list|,
name|char
modifier|*
name|data
parameter_list|,
name|int
name|len
parameter_list|)
block|{
name|char
modifier|*
name|buf
decl_stmt|;
name|PACKET_OID_DATA
modifier|*
name|o
decl_stmt|;
name|int
name|ret
decl_stmt|;
name|buf
operator|=
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|o
argument_list|)
operator|+
name|len
argument_list|)
expr_stmt|;
if|if
condition|(
name|buf
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
name|memset
argument_list|(
name|buf
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|o
argument_list|)
operator|+
name|len
argument_list|)
expr_stmt|;
name|o
operator|=
operator|(
name|PACKET_OID_DATA
operator|*
operator|)
name|buf
expr_stmt|;
name|o
operator|->
name|Oid
operator|=
name|oid
expr_stmt|;
name|o
operator|->
name|Length
operator|=
name|len
expr_stmt|;
if|if
condition|(
operator|!
name|PacketRequest
argument_list|(
name|drv
operator|->
name|adapter
argument_list|,
name|FALSE
argument_list|,
name|o
argument_list|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"%s: oid=0x%x len (%d) failed"
argument_list|,
name|__func__
argument_list|,
name|oid
argument_list|,
name|len
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|buf
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
if|if
condition|(
name|o
operator|->
name|Length
operator|>
name|len
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"%s: oid=0x%x Length (%d)> len (%d)"
argument_list|,
name|__func__
argument_list|,
name|oid
argument_list|,
operator|(
name|unsigned
name|int
operator|)
name|o
operator|->
name|Length
argument_list|,
name|len
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|buf
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|memcpy
argument_list|(
name|data
argument_list|,
name|o
operator|->
name|Data
argument_list|,
name|o
operator|->
name|Length
argument_list|)
expr_stmt|;
name|ret
operator|=
name|o
operator|->
name|Length
expr_stmt|;
name|free
argument_list|(
name|buf
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|ndis_set_oid
parameter_list|(
name|struct
name|wpa_driver_ndis_data
modifier|*
name|drv
parameter_list|,
name|unsigned
name|int
name|oid
parameter_list|,
name|char
modifier|*
name|data
parameter_list|,
name|int
name|len
parameter_list|)
block|{
name|char
modifier|*
name|buf
decl_stmt|;
name|PACKET_OID_DATA
modifier|*
name|o
decl_stmt|;
name|buf
operator|=
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|o
argument_list|)
operator|+
name|len
argument_list|)
expr_stmt|;
if|if
condition|(
name|buf
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
name|memset
argument_list|(
name|buf
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|o
argument_list|)
operator|+
name|len
argument_list|)
expr_stmt|;
name|o
operator|=
operator|(
name|PACKET_OID_DATA
operator|*
operator|)
name|buf
expr_stmt|;
name|o
operator|->
name|Oid
operator|=
name|oid
expr_stmt|;
name|o
operator|->
name|Length
operator|=
name|len
expr_stmt|;
if|if
condition|(
name|data
condition|)
name|memcpy
argument_list|(
name|o
operator|->
name|Data
argument_list|,
name|data
argument_list|,
name|len
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|PacketRequest
argument_list|(
name|drv
operator|->
name|adapter
argument_list|,
name|TRUE
argument_list|,
name|o
argument_list|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"%s: oid=0x%x len (%d) failed"
argument_list|,
name|__func__
argument_list|,
name|oid
argument_list|,
name|len
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|buf
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|free
argument_list|(
name|buf
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|ndis_set_auth_mode
parameter_list|(
name|struct
name|wpa_driver_ndis_data
modifier|*
name|drv
parameter_list|,
name|int
name|mode
parameter_list|)
block|{
name|u32
name|auth_mode
init|=
name|mode
decl_stmt|;
if|if
condition|(
name|ndis_set_oid
argument_list|(
name|drv
argument_list|,
name|OID_802_11_AUTHENTICATION_MODE
argument_list|,
operator|(
name|char
operator|*
operator|)
operator|&
name|auth_mode
argument_list|,
sizeof|sizeof
argument_list|(
name|auth_mode
argument_list|)
argument_list|)
operator|<
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"NDIS: Failed to set "
literal|"OID_802_11_AUTHENTICATION_MODE (%d)"
argument_list|,
operator|(
name|int
operator|)
name|auth_mode
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|ndis_get_auth_mode
parameter_list|(
name|struct
name|wpa_driver_ndis_data
modifier|*
name|drv
parameter_list|)
block|{
name|u32
name|auth_mode
decl_stmt|;
name|int
name|res
decl_stmt|;
name|res
operator|=
name|ndis_get_oid
argument_list|(
name|drv
argument_list|,
name|OID_802_11_AUTHENTICATION_MODE
argument_list|,
operator|(
name|char
operator|*
operator|)
operator|&
name|auth_mode
argument_list|,
sizeof|sizeof
argument_list|(
name|auth_mode
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|res
operator|!=
sizeof|sizeof
argument_list|(
name|auth_mode
argument_list|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"NDIS: Failed to get "
literal|"OID_802_11_AUTHENTICATION_MODE"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
return|return
name|auth_mode
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|ndis_set_encr_status
parameter_list|(
name|struct
name|wpa_driver_ndis_data
modifier|*
name|drv
parameter_list|,
name|int
name|encr
parameter_list|)
block|{
name|u32
name|encr_status
init|=
name|encr
decl_stmt|;
if|if
condition|(
name|ndis_set_oid
argument_list|(
name|drv
argument_list|,
name|OID_802_11_ENCRYPTION_STATUS
argument_list|,
operator|(
name|char
operator|*
operator|)
operator|&
name|encr_status
argument_list|,
sizeof|sizeof
argument_list|(
name|encr_status
argument_list|)
argument_list|)
operator|<
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"NDIS: Failed to set "
literal|"OID_802_11_ENCRYPTION_STATUS (%d)"
argument_list|,
name|encr
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|ndis_get_encr_status
parameter_list|(
name|struct
name|wpa_driver_ndis_data
modifier|*
name|drv
parameter_list|)
block|{
name|u32
name|encr
decl_stmt|;
name|int
name|res
decl_stmt|;
name|res
operator|=
name|ndis_get_oid
argument_list|(
name|drv
argument_list|,
name|OID_802_11_ENCRYPTION_STATUS
argument_list|,
operator|(
name|char
operator|*
operator|)
operator|&
name|encr
argument_list|,
sizeof|sizeof
argument_list|(
name|encr
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|res
operator|!=
sizeof|sizeof
argument_list|(
name|encr
argument_list|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"NDIS: Failed to get "
literal|"OID_802_11_ENCRYPTION_STATUS"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
return|return
name|encr
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|wpa_driver_ndis_get_bssid
parameter_list|(
name|void
modifier|*
name|priv
parameter_list|,
name|u8
modifier|*
name|bssid
parameter_list|)
block|{
name|struct
name|wpa_driver_ndis_data
modifier|*
name|drv
init|=
name|priv
decl_stmt|;
if|if
condition|(
name|drv
operator|->
name|wired
condition|)
block|{
comment|/* 		 * Report PAE group address as the "BSSID" for wired 		 * connection. 		 */
name|bssid
index|[
literal|0
index|]
operator|=
literal|0x01
expr_stmt|;
name|bssid
index|[
literal|1
index|]
operator|=
literal|0x80
expr_stmt|;
name|bssid
index|[
literal|2
index|]
operator|=
literal|0xc2
expr_stmt|;
name|bssid
index|[
literal|3
index|]
operator|=
literal|0x00
expr_stmt|;
name|bssid
index|[
literal|4
index|]
operator|=
literal|0x00
expr_stmt|;
name|bssid
index|[
literal|5
index|]
operator|=
literal|0x03
expr_stmt|;
return|return
literal|0
return|;
block|}
return|return
name|ndis_get_oid
argument_list|(
name|drv
argument_list|,
name|OID_802_11_BSSID
argument_list|,
name|bssid
argument_list|,
name|ETH_ALEN
argument_list|)
operator|<
literal|0
condition|?
operator|-
literal|1
else|:
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|wpa_driver_ndis_get_ssid
parameter_list|(
name|void
modifier|*
name|priv
parameter_list|,
name|u8
modifier|*
name|ssid
parameter_list|)
block|{
name|struct
name|wpa_driver_ndis_data
modifier|*
name|drv
init|=
name|priv
decl_stmt|;
name|NDIS_802_11_SSID
name|buf
decl_stmt|;
name|int
name|res
decl_stmt|;
name|res
operator|=
name|ndis_get_oid
argument_list|(
name|drv
argument_list|,
name|OID_802_11_SSID
argument_list|,
operator|(
name|char
operator|*
operator|)
operator|&
name|buf
argument_list|,
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|res
operator|<
literal|4
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"NDIS: Failed to get SSID"
argument_list|)
expr_stmt|;
if|if
condition|(
name|drv
operator|->
name|wired
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"NDIS: Allow get_ssid failure "
literal|"with a wired interface"
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
return|return
operator|-
literal|1
return|;
block|}
name|memcpy
argument_list|(
name|ssid
argument_list|,
name|buf
operator|.
name|Ssid
argument_list|,
name|buf
operator|.
name|SsidLength
argument_list|)
expr_stmt|;
return|return
name|buf
operator|.
name|SsidLength
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|wpa_driver_ndis_set_ssid
parameter_list|(
name|struct
name|wpa_driver_ndis_data
modifier|*
name|drv
parameter_list|,
specifier|const
name|u8
modifier|*
name|ssid
parameter_list|,
name|size_t
name|ssid_len
parameter_list|)
block|{
name|NDIS_802_11_SSID
name|buf
decl_stmt|;
name|memset
argument_list|(
operator|&
name|buf
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
argument_list|)
expr_stmt|;
name|buf
operator|.
name|SsidLength
operator|=
name|ssid_len
expr_stmt|;
name|memcpy
argument_list|(
name|buf
operator|.
name|Ssid
argument_list|,
name|ssid
argument_list|,
name|ssid_len
argument_list|)
expr_stmt|;
comment|/* 	 * Make sure radio is marked enabled here so that scan request will not 	 * force SSID to be changed to a random one in order to enable radio at 	 * that point. 	 */
name|drv
operator|->
name|radio_enabled
operator|=
literal|1
expr_stmt|;
return|return
name|ndis_set_oid
argument_list|(
name|drv
argument_list|,
name|OID_802_11_SSID
argument_list|,
operator|(
name|char
operator|*
operator|)
operator|&
name|buf
argument_list|,
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/* Disconnect using OID_802_11_DISASSOCIATE. This will also turn the radio off.  */
end_comment

begin_function
specifier|static
name|int
name|wpa_driver_ndis_radio_off
parameter_list|(
name|struct
name|wpa_driver_ndis_data
modifier|*
name|drv
parameter_list|)
block|{
name|drv
operator|->
name|radio_enabled
operator|=
literal|0
expr_stmt|;
return|return
name|ndis_set_oid
argument_list|(
name|drv
argument_list|,
name|OID_802_11_DISASSOCIATE
argument_list|,
literal|"    "
argument_list|,
literal|4
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/* Disconnect by setting SSID to random (i.e., likely not used). */
end_comment

begin_function
specifier|static
name|int
name|wpa_driver_ndis_disconnect
parameter_list|(
name|struct
name|wpa_driver_ndis_data
modifier|*
name|drv
parameter_list|)
block|{
name|char
name|ssid
index|[
literal|32
index|]
decl_stmt|;
name|int
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|32
condition|;
name|i
operator|++
control|)
name|ssid
index|[
name|i
index|]
operator|=
name|rand
argument_list|()
operator|&
literal|0xff
expr_stmt|;
return|return
name|wpa_driver_ndis_set_ssid
argument_list|(
name|drv
argument_list|,
name|ssid
argument_list|,
literal|32
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|wpa_driver_ndis_deauthenticate
parameter_list|(
name|void
modifier|*
name|priv
parameter_list|,
specifier|const
name|u8
modifier|*
name|addr
parameter_list|,
name|int
name|reason_code
parameter_list|)
block|{
name|struct
name|wpa_driver_ndis_data
modifier|*
name|drv
init|=
name|priv
decl_stmt|;
return|return
name|wpa_driver_ndis_disconnect
argument_list|(
name|drv
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|wpa_driver_ndis_disassociate
parameter_list|(
name|void
modifier|*
name|priv
parameter_list|,
specifier|const
name|u8
modifier|*
name|addr
parameter_list|,
name|int
name|reason_code
parameter_list|)
block|{
name|struct
name|wpa_driver_ndis_data
modifier|*
name|drv
init|=
name|priv
decl_stmt|;
return|return
name|wpa_driver_ndis_disconnect
argument_list|(
name|drv
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|wpa_driver_ndis_set_wpa
parameter_list|(
name|void
modifier|*
name|priv
parameter_list|,
name|int
name|enabled
parameter_list|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"%s: enabled=%d"
argument_list|,
name|__func__
argument_list|,
name|enabled
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|wpa_driver_ndis_scan_timeout
parameter_list|(
name|void
modifier|*
name|eloop_ctx
parameter_list|,
name|void
modifier|*
name|timeout_ctx
parameter_list|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"Scan timeout - try to get results"
argument_list|)
expr_stmt|;
name|wpa_supplicant_event
argument_list|(
name|timeout_ctx
argument_list|,
name|EVENT_SCAN_RESULTS
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|wpa_driver_ndis_scan
parameter_list|(
name|void
modifier|*
name|priv
parameter_list|,
specifier|const
name|u8
modifier|*
name|ssid
parameter_list|,
name|size_t
name|ssid_len
parameter_list|)
block|{
name|struct
name|wpa_driver_ndis_data
modifier|*
name|drv
init|=
name|priv
decl_stmt|;
name|int
name|res
decl_stmt|;
if|if
condition|(
operator|!
name|drv
operator|->
name|radio_enabled
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"NDIS: turning radio on before the first"
literal|" scan"
argument_list|)
expr_stmt|;
if|if
condition|(
name|wpa_driver_ndis_disconnect
argument_list|(
name|drv
argument_list|)
operator|<
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"NDIS: failed to enable radio"
argument_list|)
expr_stmt|;
block|}
name|drv
operator|->
name|radio_enabled
operator|=
literal|1
expr_stmt|;
block|}
name|res
operator|=
name|ndis_set_oid
argument_list|(
name|drv
argument_list|,
name|OID_802_11_BSSID_LIST_SCAN
argument_list|,
literal|"    "
argument_list|,
literal|4
argument_list|)
expr_stmt|;
name|eloop_register_timeout
argument_list|(
literal|3
argument_list|,
literal|0
argument_list|,
name|wpa_driver_ndis_scan_timeout
argument_list|,
name|drv
argument_list|,
name|drv
operator|->
name|ctx
argument_list|)
expr_stmt|;
return|return
name|res
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|wpa_driver_ndis_get_ies
parameter_list|(
name|struct
name|wpa_scan_result
modifier|*
name|res
parameter_list|,
name|u8
modifier|*
name|ie
parameter_list|,
name|size_t
name|ie_len
parameter_list|)
block|{
name|u8
modifier|*
name|pos
init|=
name|ie
decl_stmt|;
name|u8
modifier|*
name|end
init|=
name|ie
operator|+
name|ie_len
decl_stmt|;
if|if
condition|(
name|ie_len
operator|<
sizeof|sizeof
argument_list|(
name|NDIS_802_11_FIXED_IEs
argument_list|)
condition|)
return|return;
name|pos
operator|+=
sizeof|sizeof
argument_list|(
name|NDIS_802_11_FIXED_IEs
argument_list|)
expr_stmt|;
comment|/* wpa_hexdump(MSG_MSGDUMP, "IEs", pos, end - pos); */
while|while
condition|(
name|pos
operator|+
literal|1
operator|<
name|end
operator|&&
name|pos
operator|+
literal|2
operator|+
name|pos
index|[
literal|1
index|]
operator|<=
name|end
condition|)
block|{
name|u8
name|ielen
init|=
literal|2
operator|+
name|pos
index|[
literal|1
index|]
decl_stmt|;
if|if
condition|(
name|ielen
operator|>
name|SSID_MAX_WPA_IE_LEN
condition|)
block|{
name|pos
operator|+=
name|ielen
expr_stmt|;
continue|continue;
block|}
if|if
condition|(
name|pos
index|[
literal|0
index|]
operator|==
name|GENERIC_INFO_ELEM
operator|&&
name|pos
index|[
literal|1
index|]
operator|>=
literal|4
operator|&&
name|memcmp
argument_list|(
name|pos
operator|+
literal|2
argument_list|,
literal|"\x00\x50\xf2\x01"
argument_list|,
literal|4
argument_list|)
operator|==
literal|0
condition|)
block|{
name|memcpy
argument_list|(
name|res
operator|->
name|wpa_ie
argument_list|,
name|pos
argument_list|,
name|ielen
argument_list|)
expr_stmt|;
name|res
operator|->
name|wpa_ie_len
operator|=
name|ielen
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|pos
index|[
literal|0
index|]
operator|==
name|RSN_INFO_ELEM
condition|)
block|{
name|memcpy
argument_list|(
name|res
operator|->
name|rsn_ie
argument_list|,
name|pos
argument_list|,
name|ielen
argument_list|)
expr_stmt|;
name|res
operator|->
name|rsn_ie_len
operator|=
name|ielen
expr_stmt|;
block|}
name|pos
operator|+=
name|ielen
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|int
name|wpa_driver_ndis_get_scan_results
parameter_list|(
name|void
modifier|*
name|priv
parameter_list|,
name|struct
name|wpa_scan_result
modifier|*
name|results
parameter_list|,
name|size_t
name|max_size
parameter_list|)
block|{
name|struct
name|wpa_driver_ndis_data
modifier|*
name|drv
init|=
name|priv
decl_stmt|;
name|NDIS_802_11_BSSID_LIST_EX
modifier|*
name|b
decl_stmt|;
name|size_t
name|blen
decl_stmt|;
name|int
name|len
decl_stmt|,
name|count
decl_stmt|,
name|i
decl_stmt|,
name|j
decl_stmt|;
name|char
modifier|*
name|pos
decl_stmt|;
name|blen
operator|=
literal|65535
expr_stmt|;
name|b
operator|=
name|malloc
argument_list|(
name|blen
argument_list|)
expr_stmt|;
if|if
condition|(
name|b
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
name|memset
argument_list|(
name|b
argument_list|,
literal|0
argument_list|,
name|blen
argument_list|)
expr_stmt|;
name|len
operator|=
name|ndis_get_oid
argument_list|(
name|drv
argument_list|,
name|OID_802_11_BSSID_LIST
argument_list|,
operator|(
name|char
operator|*
operator|)
name|b
argument_list|,
name|blen
argument_list|)
expr_stmt|;
if|if
condition|(
name|len
operator|<
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"NDIS: failed to get scan results"
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|b
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|count
operator|=
name|b
operator|->
name|NumberOfItems
expr_stmt|;
if|if
condition|(
name|count
operator|>
name|max_size
condition|)
name|count
operator|=
name|max_size
expr_stmt|;
name|memset
argument_list|(
name|results
argument_list|,
literal|0
argument_list|,
name|max_size
operator|*
sizeof|sizeof
argument_list|(
expr|struct
name|wpa_scan_result
argument_list|)
argument_list|)
expr_stmt|;
name|pos
operator|=
operator|(
name|char
operator|*
operator|)
operator|&
name|b
operator|->
name|Bssid
index|[
literal|0
index|]
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|count
condition|;
name|i
operator|++
control|)
block|{
name|NDIS_WLAN_BSSID_EX
modifier|*
name|bss
init|=
operator|(
name|NDIS_WLAN_BSSID_EX
operator|*
operator|)
name|pos
decl_stmt|;
name|memcpy
argument_list|(
name|results
index|[
name|i
index|]
operator|.
name|bssid
argument_list|,
name|bss
operator|->
name|MacAddress
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
name|results
index|[
name|i
index|]
operator|.
name|ssid
argument_list|,
name|bss
operator|->
name|Ssid
operator|.
name|Ssid
argument_list|,
name|bss
operator|->
name|Ssid
operator|.
name|SsidLength
argument_list|)
expr_stmt|;
name|results
index|[
name|i
index|]
operator|.
name|ssid_len
operator|=
name|bss
operator|->
name|Ssid
operator|.
name|SsidLength
expr_stmt|;
if|if
condition|(
name|bss
operator|->
name|Privacy
condition|)
name|results
index|[
name|i
index|]
operator|.
name|caps
operator||=
name|IEEE80211_CAP_PRIVACY
expr_stmt|;
name|results
index|[
name|i
index|]
operator|.
name|level
operator|=
operator|(
name|int
operator|)
name|bss
operator|->
name|Rssi
expr_stmt|;
name|results
index|[
name|i
index|]
operator|.
name|freq
operator|=
name|bss
operator|->
name|Configuration
operator|.
name|DSConfig
operator|/
literal|1000
expr_stmt|;
for|for
control|(
name|j
operator|=
literal|0
init|;
name|j
operator|<
sizeof|sizeof
argument_list|(
name|bss
operator|->
name|SupportedRates
argument_list|)
condition|;
name|j
operator|++
control|)
block|{
if|if
condition|(
operator|(
name|bss
operator|->
name|SupportedRates
index|[
name|j
index|]
operator|&
literal|0x7f
operator|)
operator|>
name|results
index|[
name|i
index|]
operator|.
name|maxrate
condition|)
block|{
name|results
index|[
name|i
index|]
operator|.
name|maxrate
operator|=
name|bss
operator|->
name|SupportedRates
index|[
name|j
index|]
operator|&
literal|0x7f
expr_stmt|;
block|}
block|}
name|wpa_driver_ndis_get_ies
argument_list|(
operator|&
name|results
index|[
name|i
index|]
argument_list|,
name|bss
operator|->
name|IEs
argument_list|,
name|bss
operator|->
name|IELength
argument_list|)
expr_stmt|;
name|pos
operator|+=
name|bss
operator|->
name|Length
expr_stmt|;
if|if
condition|(
name|pos
operator|>
operator|(
name|char
operator|*
operator|)
name|b
operator|+
name|blen
condition|)
break|break;
block|}
name|free
argument_list|(
name|b
argument_list|)
expr_stmt|;
return|return
name|count
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|wpa_driver_ndis_remove_key
parameter_list|(
name|struct
name|wpa_driver_ndis_data
modifier|*
name|drv
parameter_list|,
name|int
name|key_idx
parameter_list|,
specifier|const
name|u8
modifier|*
name|addr
parameter_list|,
specifier|const
name|u8
modifier|*
name|bssid
parameter_list|,
name|int
name|pairwise
parameter_list|)
block|{
name|NDIS_802_11_REMOVE_KEY
name|rkey
decl_stmt|;
name|NDIS_802_11_KEY_INDEX
name|index
decl_stmt|;
name|int
name|res
decl_stmt|,
name|res2
decl_stmt|;
name|memset
argument_list|(
operator|&
name|rkey
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|rkey
argument_list|)
argument_list|)
expr_stmt|;
name|rkey
operator|.
name|Length
operator|=
sizeof|sizeof
argument_list|(
name|rkey
argument_list|)
expr_stmt|;
name|rkey
operator|.
name|KeyIndex
operator|=
name|key_idx
expr_stmt|;
if|if
condition|(
name|pairwise
condition|)
name|rkey
operator|.
name|KeyIndex
operator||=
literal|1
operator|<<
literal|30
expr_stmt|;
name|memcpy
argument_list|(
name|rkey
operator|.
name|BSSID
argument_list|,
name|bssid
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
name|res
operator|=
name|ndis_set_oid
argument_list|(
name|drv
argument_list|,
name|OID_802_11_REMOVE_KEY
argument_list|,
operator|(
name|char
operator|*
operator|)
operator|&
name|rkey
argument_list|,
sizeof|sizeof
argument_list|(
name|rkey
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|pairwise
condition|)
block|{
name|res2
operator|=
name|ndis_set_oid
argument_list|(
name|drv
argument_list|,
name|OID_802_11_REMOVE_WEP
argument_list|,
operator|(
name|char
operator|*
operator|)
operator|&
name|index
argument_list|,
sizeof|sizeof
argument_list|(
name|index
argument_list|)
argument_list|)
expr_stmt|;
block|}
else|else
name|res2
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|res
operator|<
literal|0
operator|&&
name|res2
operator|<
literal|0
condition|)
return|return
name|res
return|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|wpa_driver_ndis_add_wep
parameter_list|(
name|struct
name|wpa_driver_ndis_data
modifier|*
name|drv
parameter_list|,
name|int
name|pairwise
parameter_list|,
name|int
name|key_idx
parameter_list|,
name|int
name|set_tx
parameter_list|,
specifier|const
name|u8
modifier|*
name|key
parameter_list|,
name|size_t
name|key_len
parameter_list|)
block|{
name|NDIS_802_11_WEP
modifier|*
name|wep
decl_stmt|;
name|size_t
name|len
decl_stmt|;
name|int
name|res
decl_stmt|;
name|len
operator|=
literal|12
operator|+
name|key_len
expr_stmt|;
name|wep
operator|=
name|malloc
argument_list|(
name|len
argument_list|)
expr_stmt|;
if|if
condition|(
name|wep
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
name|memset
argument_list|(
name|wep
argument_list|,
literal|0
argument_list|,
name|len
argument_list|)
expr_stmt|;
name|wep
operator|->
name|Length
operator|=
name|len
expr_stmt|;
name|wep
operator|->
name|KeyIndex
operator|=
name|key_idx
expr_stmt|;
if|if
condition|(
name|set_tx
condition|)
name|wep
operator|->
name|KeyIndex
operator||=
literal|1
operator|<<
literal|31
expr_stmt|;
if|#
directive|if
literal|0
comment|/* Setting bit30 does not seem to work with some NDIS drivers */
block|if (pairwise) 		wep->KeyIndex |= 1<< 30;
endif|#
directive|endif
name|wep
operator|->
name|KeyLength
operator|=
name|key_len
expr_stmt|;
name|memcpy
argument_list|(
name|wep
operator|->
name|KeyMaterial
argument_list|,
name|key
argument_list|,
name|key_len
argument_list|)
expr_stmt|;
name|wpa_hexdump_key
argument_list|(
name|MSG_MSGDUMP
argument_list|,
literal|"NDIS: OIS_802_11_ADD_WEP"
argument_list|,
operator|(
name|char
operator|*
operator|)
name|wep
argument_list|,
name|len
argument_list|)
expr_stmt|;
name|res
operator|=
name|ndis_set_oid
argument_list|(
name|drv
argument_list|,
name|OID_802_11_ADD_WEP
argument_list|,
operator|(
name|char
operator|*
operator|)
name|wep
argument_list|,
name|len
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|wep
argument_list|)
expr_stmt|;
return|return
name|res
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|wpa_driver_ndis_set_key
parameter_list|(
name|void
modifier|*
name|priv
parameter_list|,
name|wpa_alg
name|alg
parameter_list|,
specifier|const
name|u8
modifier|*
name|addr
parameter_list|,
name|int
name|key_idx
parameter_list|,
name|int
name|set_tx
parameter_list|,
specifier|const
name|u8
modifier|*
name|seq
parameter_list|,
name|size_t
name|seq_len
parameter_list|,
specifier|const
name|u8
modifier|*
name|key
parameter_list|,
name|size_t
name|key_len
parameter_list|)
block|{
name|struct
name|wpa_driver_ndis_data
modifier|*
name|drv
init|=
name|priv
decl_stmt|;
name|size_t
name|len
decl_stmt|;
name|NDIS_802_11_KEY
modifier|*
name|nkey
decl_stmt|;
name|int
name|i
decl_stmt|,
name|res
decl_stmt|,
name|pairwise
decl_stmt|;
name|u8
name|bssid
index|[
name|ETH_ALEN
index|]
decl_stmt|;
if|if
condition|(
name|addr
operator|==
name|NULL
operator|||
name|memcmp
argument_list|(
name|addr
argument_list|,
literal|"\xff\xff\xff\xff\xff\xff"
argument_list|,
name|ETH_ALEN
argument_list|)
operator|==
literal|0
condition|)
block|{
comment|/* Group Key */
name|pairwise
operator|=
literal|0
expr_stmt|;
name|wpa_driver_ndis_get_bssid
argument_list|(
name|drv
argument_list|,
name|bssid
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|/* Pairwise Key */
name|pairwise
operator|=
literal|1
expr_stmt|;
name|memcpy
argument_list|(
name|bssid
argument_list|,
name|addr
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|alg
operator|==
name|WPA_ALG_NONE
operator|||
name|key_len
operator|==
literal|0
condition|)
block|{
return|return
name|wpa_driver_ndis_remove_key
argument_list|(
name|drv
argument_list|,
name|key_idx
argument_list|,
name|addr
argument_list|,
name|bssid
argument_list|,
name|pairwise
argument_list|)
return|;
block|}
if|if
condition|(
name|alg
operator|==
name|WPA_ALG_WEP
condition|)
block|{
return|return
name|wpa_driver_ndis_add_wep
argument_list|(
name|drv
argument_list|,
name|pairwise
argument_list|,
name|key_idx
argument_list|,
name|set_tx
argument_list|,
name|key
argument_list|,
name|key_len
argument_list|)
return|;
block|}
name|len
operator|=
literal|12
operator|+
literal|6
operator|+
literal|6
operator|+
literal|8
operator|+
name|key_len
expr_stmt|;
name|nkey
operator|=
name|malloc
argument_list|(
name|len
argument_list|)
expr_stmt|;
if|if
condition|(
name|nkey
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
name|memset
argument_list|(
name|nkey
argument_list|,
literal|0
argument_list|,
name|len
argument_list|)
expr_stmt|;
name|nkey
operator|->
name|Length
operator|=
name|len
expr_stmt|;
name|nkey
operator|->
name|KeyIndex
operator|=
name|key_idx
expr_stmt|;
if|if
condition|(
name|set_tx
condition|)
name|nkey
operator|->
name|KeyIndex
operator||=
literal|1
operator|<<
literal|31
expr_stmt|;
if|if
condition|(
name|pairwise
condition|)
name|nkey
operator|->
name|KeyIndex
operator||=
literal|1
operator|<<
literal|30
expr_stmt|;
if|if
condition|(
name|seq
operator|&&
name|seq_len
condition|)
name|nkey
operator|->
name|KeyIndex
operator||=
literal|1
operator|<<
literal|29
expr_stmt|;
name|nkey
operator|->
name|KeyLength
operator|=
name|key_len
expr_stmt|;
name|memcpy
argument_list|(
name|nkey
operator|->
name|BSSID
argument_list|,
name|bssid
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
if|if
condition|(
name|seq
operator|&&
name|seq_len
condition|)
block|{
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|seq_len
condition|;
name|i
operator|++
control|)
name|nkey
operator|->
name|KeyRSC
operator||=
name|seq
index|[
name|i
index|]
operator|<<
operator|(
name|i
operator|*
literal|8
operator|)
expr_stmt|;
block|}
if|if
condition|(
name|alg
operator|==
name|WPA_ALG_TKIP
operator|&&
name|key_len
operator|==
literal|32
condition|)
block|{
name|memcpy
argument_list|(
name|nkey
operator|->
name|KeyMaterial
argument_list|,
name|key
argument_list|,
literal|16
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
name|nkey
operator|->
name|KeyMaterial
operator|+
literal|16
argument_list|,
name|key
operator|+
literal|24
argument_list|,
literal|8
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
name|nkey
operator|->
name|KeyMaterial
operator|+
literal|24
argument_list|,
name|key
operator|+
literal|16
argument_list|,
literal|8
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|memcpy
argument_list|(
name|nkey
operator|->
name|KeyMaterial
argument_list|,
name|key
argument_list|,
name|key_len
argument_list|)
expr_stmt|;
block|}
name|wpa_hexdump_key
argument_list|(
name|MSG_MSGDUMP
argument_list|,
literal|"NDIS: OIS_802_11_ADD_KEY"
argument_list|,
operator|(
name|char
operator|*
operator|)
name|nkey
argument_list|,
name|len
argument_list|)
expr_stmt|;
name|res
operator|=
name|ndis_set_oid
argument_list|(
name|drv
argument_list|,
name|OID_802_11_ADD_KEY
argument_list|,
operator|(
name|char
operator|*
operator|)
name|nkey
argument_list|,
name|len
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|nkey
argument_list|)
expr_stmt|;
return|return
name|res
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|wpa_driver_ndis_associate
parameter_list|(
name|void
modifier|*
name|priv
parameter_list|,
name|struct
name|wpa_driver_associate_params
modifier|*
name|params
parameter_list|)
block|{
name|struct
name|wpa_driver_ndis_data
modifier|*
name|drv
init|=
name|priv
decl_stmt|;
name|u32
name|auth_mode
decl_stmt|,
name|encr
decl_stmt|,
name|priv_mode
decl_stmt|,
name|mode
decl_stmt|;
comment|/* Note: Setting OID_802_11_INFRASTRUCTURE_MODE clears current keys, 	 * so static WEP keys needs to be set again after this. */
if|if
condition|(
name|params
operator|->
name|mode
operator|==
name|IEEE80211_MODE_IBSS
condition|)
name|mode
operator|=
name|Ndis802_11IBSS
expr_stmt|;
else|else
name|mode
operator|=
name|Ndis802_11Infrastructure
expr_stmt|;
if|if
condition|(
name|ndis_set_oid
argument_list|(
name|drv
argument_list|,
name|OID_802_11_INFRASTRUCTURE_MODE
argument_list|,
operator|(
name|char
operator|*
operator|)
operator|&
name|mode
argument_list|,
sizeof|sizeof
argument_list|(
name|mode
argument_list|)
argument_list|)
operator|<
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"NDIS: Failed to set "
literal|"OID_802_11_INFRASTRUCTURE_MODE (%d)"
argument_list|,
operator|(
name|int
operator|)
name|mode
argument_list|)
expr_stmt|;
comment|/* Try to continue anyway */
block|}
if|if
condition|(
name|params
operator|->
name|wpa_ie
operator|==
name|NULL
operator|||
name|params
operator|->
name|wpa_ie_len
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|params
operator|->
name|auth_alg
operator|&
name|AUTH_ALG_SHARED_KEY
condition|)
block|{
if|if
condition|(
name|params
operator|->
name|auth_alg
operator|&
name|AUTH_ALG_OPEN_SYSTEM
condition|)
name|auth_mode
operator|=
name|Ndis802_11AuthModeAutoSwitch
expr_stmt|;
else|else
name|auth_mode
operator|=
name|Ndis802_11AuthModeShared
expr_stmt|;
block|}
else|else
name|auth_mode
operator|=
name|Ndis802_11AuthModeOpen
expr_stmt|;
name|priv_mode
operator|=
name|Ndis802_11PrivFilterAcceptAll
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|params
operator|->
name|wpa_ie
index|[
literal|0
index|]
operator|==
name|RSN_INFO_ELEM
condition|)
block|{
name|priv_mode
operator|=
name|Ndis802_11PrivFilter8021xWEP
expr_stmt|;
if|if
condition|(
name|params
operator|->
name|key_mgmt_suite
operator|==
name|KEY_MGMT_PSK
condition|)
name|auth_mode
operator|=
name|Ndis802_11AuthModeWPA2PSK
expr_stmt|;
else|else
name|auth_mode
operator|=
name|Ndis802_11AuthModeWPA2
expr_stmt|;
block|}
else|else
block|{
name|priv_mode
operator|=
name|Ndis802_11PrivFilter8021xWEP
expr_stmt|;
if|if
condition|(
name|params
operator|->
name|key_mgmt_suite
operator|==
name|KEY_MGMT_WPA_NONE
condition|)
name|auth_mode
operator|=
name|Ndis802_11AuthModeWPANone
expr_stmt|;
elseif|else
if|if
condition|(
name|params
operator|->
name|key_mgmt_suite
operator|==
name|KEY_MGMT_PSK
condition|)
name|auth_mode
operator|=
name|Ndis802_11AuthModeWPAPSK
expr_stmt|;
else|else
name|auth_mode
operator|=
name|Ndis802_11AuthModeWPA
expr_stmt|;
block|}
switch|switch
condition|(
name|params
operator|->
name|pairwise_suite
condition|)
block|{
case|case
name|CIPHER_CCMP
case|:
name|encr
operator|=
name|Ndis802_11Encryption3Enabled
expr_stmt|;
break|break;
case|case
name|CIPHER_TKIP
case|:
name|encr
operator|=
name|Ndis802_11Encryption2Enabled
expr_stmt|;
break|break;
case|case
name|CIPHER_WEP40
case|:
case|case
name|CIPHER_WEP104
case|:
name|encr
operator|=
name|Ndis802_11Encryption1Enabled
expr_stmt|;
break|break;
case|case
name|CIPHER_NONE
case|:
if|if
condition|(
name|params
operator|->
name|group_suite
operator|==
name|CIPHER_CCMP
condition|)
name|encr
operator|=
name|Ndis802_11Encryption3Enabled
expr_stmt|;
else|else
name|encr
operator|=
name|Ndis802_11Encryption2Enabled
expr_stmt|;
break|break;
default|default:
name|encr
operator|=
name|Ndis802_11EncryptionDisabled
expr_stmt|;
block|}
empty_stmt|;
if|if
condition|(
name|ndis_set_oid
argument_list|(
name|drv
argument_list|,
name|OID_802_11_PRIVACY_FILTER
argument_list|,
operator|(
name|char
operator|*
operator|)
operator|&
name|priv_mode
argument_list|,
sizeof|sizeof
argument_list|(
name|priv_mode
argument_list|)
argument_list|)
operator|<
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"NDIS: Failed to set "
literal|"OID_802_11_PRIVACY_FILTER (%d)"
argument_list|,
operator|(
name|int
operator|)
name|priv_mode
argument_list|)
expr_stmt|;
comment|/* Try to continue anyway */
block|}
name|ndis_set_auth_mode
argument_list|(
name|drv
argument_list|,
name|auth_mode
argument_list|)
expr_stmt|;
name|ndis_set_encr_status
argument_list|(
name|drv
argument_list|,
name|encr
argument_list|)
expr_stmt|;
return|return
name|wpa_driver_ndis_set_ssid
argument_list|(
name|drv
argument_list|,
name|params
operator|->
name|ssid
argument_list|,
name|params
operator|->
name|ssid_len
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|wpa_driver_ndis_set_pmkid
parameter_list|(
name|struct
name|wpa_driver_ndis_data
modifier|*
name|drv
parameter_list|)
block|{
name|int
name|len
decl_stmt|,
name|count
decl_stmt|,
name|i
decl_stmt|,
name|ret
decl_stmt|;
name|struct
name|ndis_pmkid_entry
modifier|*
name|entry
decl_stmt|;
name|NDIS_802_11_PMKID
modifier|*
name|p
decl_stmt|;
name|count
operator|=
literal|0
expr_stmt|;
name|entry
operator|=
name|drv
operator|->
name|pmkid
expr_stmt|;
while|while
condition|(
name|entry
condition|)
block|{
name|count
operator|++
expr_stmt|;
if|if
condition|(
name|count
operator|>=
name|drv
operator|->
name|no_of_pmkid
condition|)
break|break;
name|entry
operator|=
name|entry
operator|->
name|next
expr_stmt|;
block|}
name|len
operator|=
literal|8
operator|+
name|count
operator|*
sizeof|sizeof
argument_list|(
name|BSSID_INFO
argument_list|)
expr_stmt|;
name|p
operator|=
name|malloc
argument_list|(
name|len
argument_list|)
expr_stmt|;
if|if
condition|(
name|p
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
name|memset
argument_list|(
name|p
argument_list|,
literal|0
argument_list|,
name|len
argument_list|)
expr_stmt|;
name|p
operator|->
name|Length
operator|=
name|len
expr_stmt|;
name|p
operator|->
name|BSSIDInfoCount
operator|=
name|count
expr_stmt|;
name|entry
operator|=
name|drv
operator|->
name|pmkid
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|count
condition|;
name|i
operator|++
control|)
block|{
name|memcpy
argument_list|(
operator|&
name|p
operator|->
name|BSSIDInfo
index|[
name|i
index|]
operator|.
name|BSSID
argument_list|,
name|entry
operator|->
name|bssid
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
operator|&
name|p
operator|->
name|BSSIDInfo
index|[
name|i
index|]
operator|.
name|PMKID
argument_list|,
name|entry
operator|->
name|pmkid
argument_list|,
literal|16
argument_list|)
expr_stmt|;
name|entry
operator|=
name|entry
operator|->
name|next
expr_stmt|;
block|}
name|wpa_hexdump
argument_list|(
name|MSG_MSGDUMP
argument_list|,
literal|"NDIS: OID_802_11_PMKID"
argument_list|,
operator|(
name|char
operator|*
operator|)
name|p
argument_list|,
name|len
argument_list|)
expr_stmt|;
name|ret
operator|=
name|ndis_set_oid
argument_list|(
name|drv
argument_list|,
name|OID_802_11_PMKID
argument_list|,
operator|(
name|char
operator|*
operator|)
name|p
argument_list|,
name|len
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|p
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|wpa_driver_ndis_add_pmkid
parameter_list|(
name|void
modifier|*
name|priv
parameter_list|,
specifier|const
name|u8
modifier|*
name|bssid
parameter_list|,
specifier|const
name|u8
modifier|*
name|pmkid
parameter_list|)
block|{
name|struct
name|wpa_driver_ndis_data
modifier|*
name|drv
init|=
name|priv
decl_stmt|;
name|struct
name|ndis_pmkid_entry
modifier|*
name|entry
decl_stmt|,
modifier|*
name|prev
decl_stmt|;
if|if
condition|(
name|drv
operator|->
name|no_of_pmkid
operator|==
literal|0
condition|)
return|return
literal|0
return|;
name|prev
operator|=
name|NULL
expr_stmt|;
name|entry
operator|=
name|drv
operator|->
name|pmkid
expr_stmt|;
while|while
condition|(
name|entry
condition|)
block|{
if|if
condition|(
name|memcmp
argument_list|(
name|entry
operator|->
name|bssid
argument_list|,
name|bssid
argument_list|,
name|ETH_ALEN
argument_list|)
operator|==
literal|0
condition|)
break|break;
name|prev
operator|=
name|entry
expr_stmt|;
name|entry
operator|=
name|entry
operator|->
name|next
expr_stmt|;
block|}
if|if
condition|(
name|entry
condition|)
block|{
comment|/* Replace existing entry for this BSSID and move it into the 		 * beginning of the list. */
name|memcpy
argument_list|(
name|entry
operator|->
name|pmkid
argument_list|,
name|pmkid
argument_list|,
literal|16
argument_list|)
expr_stmt|;
if|if
condition|(
name|prev
condition|)
block|{
name|prev
operator|->
name|next
operator|=
name|entry
operator|->
name|next
expr_stmt|;
name|entry
operator|->
name|next
operator|=
name|drv
operator|->
name|pmkid
expr_stmt|;
name|drv
operator|->
name|pmkid
operator|=
name|entry
expr_stmt|;
block|}
block|}
else|else
block|{
name|entry
operator|=
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|entry
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|entry
condition|)
block|{
name|memcpy
argument_list|(
name|entry
operator|->
name|bssid
argument_list|,
name|bssid
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
name|entry
operator|->
name|pmkid
argument_list|,
name|pmkid
argument_list|,
literal|16
argument_list|)
expr_stmt|;
name|entry
operator|->
name|next
operator|=
name|drv
operator|->
name|pmkid
expr_stmt|;
name|drv
operator|->
name|pmkid
operator|=
name|entry
expr_stmt|;
block|}
block|}
return|return
name|wpa_driver_ndis_set_pmkid
argument_list|(
name|drv
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|wpa_driver_ndis_remove_pmkid
parameter_list|(
name|void
modifier|*
name|priv
parameter_list|,
specifier|const
name|u8
modifier|*
name|bssid
parameter_list|,
specifier|const
name|u8
modifier|*
name|pmkid
parameter_list|)
block|{
name|struct
name|wpa_driver_ndis_data
modifier|*
name|drv
init|=
name|priv
decl_stmt|;
name|struct
name|ndis_pmkid_entry
modifier|*
name|entry
decl_stmt|,
modifier|*
name|prev
decl_stmt|;
if|if
condition|(
name|drv
operator|->
name|no_of_pmkid
operator|==
literal|0
condition|)
return|return
literal|0
return|;
name|entry
operator|=
name|drv
operator|->
name|pmkid
expr_stmt|;
name|prev
operator|=
name|NULL
expr_stmt|;
name|drv
operator|->
name|pmkid
operator|=
name|NULL
expr_stmt|;
while|while
condition|(
name|entry
condition|)
block|{
if|if
condition|(
name|memcmp
argument_list|(
name|entry
operator|->
name|bssid
argument_list|,
name|bssid
argument_list|,
name|ETH_ALEN
argument_list|)
operator|==
literal|0
operator|&&
name|memcmp
argument_list|(
name|entry
operator|->
name|pmkid
argument_list|,
name|pmkid
argument_list|,
literal|16
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|prev
condition|)
name|prev
operator|->
name|next
operator|=
name|entry
operator|->
name|next
expr_stmt|;
else|else
name|drv
operator|->
name|pmkid
operator|=
name|entry
operator|->
name|next
expr_stmt|;
name|free
argument_list|(
name|entry
argument_list|)
expr_stmt|;
break|break;
block|}
name|prev
operator|=
name|entry
expr_stmt|;
name|entry
operator|=
name|entry
operator|->
name|next
expr_stmt|;
block|}
return|return
name|wpa_driver_ndis_set_pmkid
argument_list|(
name|drv
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|wpa_driver_ndis_flush_pmkid
parameter_list|(
name|void
modifier|*
name|priv
parameter_list|)
block|{
name|struct
name|wpa_driver_ndis_data
modifier|*
name|drv
init|=
name|priv
decl_stmt|;
name|NDIS_802_11_PMKID
name|p
decl_stmt|;
name|struct
name|ndis_pmkid_entry
modifier|*
name|pmkid
decl_stmt|,
modifier|*
name|prev
decl_stmt|;
if|if
condition|(
name|drv
operator|->
name|no_of_pmkid
operator|==
literal|0
condition|)
return|return
literal|0
return|;
name|pmkid
operator|=
name|drv
operator|->
name|pmkid
expr_stmt|;
name|drv
operator|->
name|pmkid
operator|=
name|NULL
expr_stmt|;
while|while
condition|(
name|pmkid
condition|)
block|{
name|prev
operator|=
name|pmkid
expr_stmt|;
name|pmkid
operator|=
name|pmkid
operator|->
name|next
expr_stmt|;
name|free
argument_list|(
name|prev
argument_list|)
expr_stmt|;
block|}
name|memset
argument_list|(
operator|&
name|p
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|p
argument_list|)
argument_list|)
expr_stmt|;
name|p
operator|.
name|Length
operator|=
literal|8
expr_stmt|;
name|p
operator|.
name|BSSIDInfoCount
operator|=
literal|0
expr_stmt|;
name|wpa_hexdump
argument_list|(
name|MSG_MSGDUMP
argument_list|,
literal|"NDIS: OID_802_11_PMKID (flush)"
argument_list|,
operator|(
name|char
operator|*
operator|)
operator|&
name|p
argument_list|,
literal|8
argument_list|)
expr_stmt|;
return|return
name|ndis_set_oid
argument_list|(
name|drv
argument_list|,
name|OID_802_11_PMKID
argument_list|,
operator|(
name|char
operator|*
operator|)
operator|&
name|p
argument_list|,
literal|8
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|wpa_driver_ndis_get_associnfo
parameter_list|(
name|struct
name|wpa_driver_ndis_data
modifier|*
name|drv
parameter_list|)
block|{
name|char
name|buf
index|[
literal|512
index|]
decl_stmt|,
modifier|*
name|pos
decl_stmt|;
name|NDIS_802_11_ASSOCIATION_INFORMATION
modifier|*
name|ai
decl_stmt|;
name|int
name|len
decl_stmt|,
name|i
decl_stmt|;
name|union
name|wpa_event_data
name|data
decl_stmt|;
name|NDIS_802_11_BSSID_LIST_EX
modifier|*
name|b
decl_stmt|;
name|size_t
name|blen
decl_stmt|;
name|len
operator|=
name|ndis_get_oid
argument_list|(
name|drv
argument_list|,
name|OID_802_11_ASSOCIATION_INFORMATION
argument_list|,
name|buf
argument_list|,
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|len
operator|<
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"NDIS: failed to get association "
literal|"information"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
if|if
condition|(
name|len
operator|>
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
condition|)
block|{
comment|/* Some drivers seem to be producing incorrect length for this 		 * data. Limit the length to the current buffer size to avoid 		 * crashing in hexdump. The data seems to be otherwise valid, 		 * so better try to use it. */
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"NDIS: ignored bogus association "
literal|"information length %d"
argument_list|,
name|len
argument_list|)
expr_stmt|;
name|len
operator|=
name|ndis_get_oid
argument_list|(
name|drv
argument_list|,
name|OID_802_11_ASSOCIATION_INFORMATION
argument_list|,
name|buf
argument_list|,
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|len
operator|<
operator|-
literal|1
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"NDIS: re-reading association "
literal|"information failed"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
if|if
condition|(
name|len
operator|>
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"NDIS: ignored bogus association"
literal|" information length %d (re-read)"
argument_list|,
name|len
argument_list|)
expr_stmt|;
name|len
operator|=
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
expr_stmt|;
block|}
block|}
name|wpa_hexdump
argument_list|(
name|MSG_MSGDUMP
argument_list|,
literal|"NDIS: association information"
argument_list|,
name|buf
argument_list|,
name|len
argument_list|)
expr_stmt|;
if|if
condition|(
name|len
operator|<
sizeof|sizeof
argument_list|(
operator|*
name|ai
argument_list|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"NDIS: too short association "
literal|"information"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|ai
operator|=
operator|(
name|NDIS_802_11_ASSOCIATION_INFORMATION
operator|*
operator|)
name|buf
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"NDIS: ReqFixed=0x%x RespFixed=0x%x off_req=%d "
literal|"off_resp=%d len_req=%d len_resp=%d"
argument_list|,
name|ai
operator|->
name|AvailableRequestFixedIEs
argument_list|,
name|ai
operator|->
name|AvailableResponseFixedIEs
argument_list|,
operator|(
name|int
operator|)
name|ai
operator|->
name|OffsetRequestIEs
argument_list|,
operator|(
name|int
operator|)
name|ai
operator|->
name|OffsetResponseIEs
argument_list|,
operator|(
name|int
operator|)
name|ai
operator|->
name|RequestIELength
argument_list|,
operator|(
name|int
operator|)
name|ai
operator|->
name|ResponseIELength
argument_list|)
expr_stmt|;
if|if
condition|(
name|ai
operator|->
name|OffsetRequestIEs
operator|+
name|ai
operator|->
name|RequestIELength
operator|>
name|len
operator|||
name|ai
operator|->
name|OffsetResponseIEs
operator|+
name|ai
operator|->
name|ResponseIELength
operator|>
name|len
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"NDIS: association information - "
literal|"IE overflow"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|wpa_hexdump
argument_list|(
name|MSG_MSGDUMP
argument_list|,
literal|"NDIS: Request IEs"
argument_list|,
name|buf
operator|+
name|ai
operator|->
name|OffsetRequestIEs
argument_list|,
name|ai
operator|->
name|RequestIELength
argument_list|)
expr_stmt|;
name|wpa_hexdump
argument_list|(
name|MSG_MSGDUMP
argument_list|,
literal|"NDIS: Response IEs"
argument_list|,
name|buf
operator|+
name|ai
operator|->
name|OffsetResponseIEs
argument_list|,
name|ai
operator|->
name|ResponseIELength
argument_list|)
expr_stmt|;
name|memset
argument_list|(
operator|&
name|data
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|data
argument_list|)
argument_list|)
expr_stmt|;
name|data
operator|.
name|assoc_info
operator|.
name|req_ies
operator|=
name|buf
operator|+
name|ai
operator|->
name|OffsetRequestIEs
expr_stmt|;
name|data
operator|.
name|assoc_info
operator|.
name|req_ies_len
operator|=
name|ai
operator|->
name|RequestIELength
expr_stmt|;
name|data
operator|.
name|assoc_info
operator|.
name|resp_ies
operator|=
name|buf
operator|+
name|ai
operator|->
name|OffsetResponseIEs
expr_stmt|;
name|data
operator|.
name|assoc_info
operator|.
name|resp_ies_len
operator|=
name|ai
operator|->
name|ResponseIELength
expr_stmt|;
name|blen
operator|=
literal|65535
expr_stmt|;
name|b
operator|=
name|malloc
argument_list|(
name|blen
argument_list|)
expr_stmt|;
if|if
condition|(
name|b
operator|==
name|NULL
condition|)
goto|goto
name|skip_scan_results
goto|;
name|memset
argument_list|(
name|b
argument_list|,
literal|0
argument_list|,
name|blen
argument_list|)
expr_stmt|;
name|len
operator|=
name|ndis_get_oid
argument_list|(
name|drv
argument_list|,
name|OID_802_11_BSSID_LIST
argument_list|,
operator|(
name|char
operator|*
operator|)
name|b
argument_list|,
name|blen
argument_list|)
expr_stmt|;
if|if
condition|(
name|len
operator|<
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"NDIS: failed to get scan results"
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|b
argument_list|)
expr_stmt|;
name|b
operator|=
name|NULL
expr_stmt|;
goto|goto
name|skip_scan_results
goto|;
block|}
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"NDIS: %d BSSID items to process for AssocInfo"
argument_list|,
operator|(
name|unsigned
name|int
operator|)
name|b
operator|->
name|NumberOfItems
argument_list|)
expr_stmt|;
name|pos
operator|=
operator|(
name|char
operator|*
operator|)
operator|&
name|b
operator|->
name|Bssid
index|[
literal|0
index|]
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|b
operator|->
name|NumberOfItems
condition|;
name|i
operator|++
control|)
block|{
name|NDIS_WLAN_BSSID_EX
modifier|*
name|bss
init|=
operator|(
name|NDIS_WLAN_BSSID_EX
operator|*
operator|)
name|pos
decl_stmt|;
if|if
condition|(
name|memcmp
argument_list|(
name|drv
operator|->
name|bssid
argument_list|,
name|bss
operator|->
name|MacAddress
argument_list|,
name|ETH_ALEN
argument_list|)
operator|==
literal|0
operator|&&
name|bss
operator|->
name|IELength
operator|>
sizeof|sizeof
argument_list|(
name|NDIS_802_11_FIXED_IEs
argument_list|)
condition|)
block|{
name|data
operator|.
name|assoc_info
operator|.
name|beacon_ies
operator|=
operator|(
operator|(
name|u8
operator|*
operator|)
name|bss
operator|->
name|IEs
operator|)
operator|+
sizeof|sizeof
argument_list|(
name|NDIS_802_11_FIXED_IEs
argument_list|)
expr_stmt|;
name|data
operator|.
name|assoc_info
operator|.
name|beacon_ies_len
operator|=
name|bss
operator|->
name|IELength
operator|-
sizeof|sizeof
argument_list|(
name|NDIS_802_11_FIXED_IEs
argument_list|)
expr_stmt|;
name|wpa_hexdump
argument_list|(
name|MSG_MSGDUMP
argument_list|,
literal|"NDIS: Beacon IEs"
argument_list|,
name|data
operator|.
name|assoc_info
operator|.
name|beacon_ies
argument_list|,
name|data
operator|.
name|assoc_info
operator|.
name|beacon_ies_len
argument_list|)
expr_stmt|;
break|break;
block|}
name|pos
operator|+=
name|bss
operator|->
name|Length
expr_stmt|;
if|if
condition|(
name|pos
operator|>
operator|(
name|char
operator|*
operator|)
name|b
operator|+
name|blen
condition|)
break|break;
block|}
name|skip_scan_results
label|:
name|wpa_supplicant_event
argument_list|(
name|drv
operator|->
name|ctx
argument_list|,
name|EVENT_ASSOCINFO
argument_list|,
operator|&
name|data
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|b
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|wpa_driver_ndis_poll_timeout
parameter_list|(
name|void
modifier|*
name|eloop_ctx
parameter_list|,
name|void
modifier|*
name|timeout_ctx
parameter_list|)
block|{
name|struct
name|wpa_driver_ndis_data
modifier|*
name|drv
init|=
name|eloop_ctx
decl_stmt|;
name|u8
name|bssid
index|[
name|ETH_ALEN
index|]
decl_stmt|;
if|if
condition|(
name|drv
operator|->
name|wired
condition|)
return|return;
if|if
condition|(
name|wpa_driver_ndis_get_bssid
argument_list|(
name|drv
argument_list|,
name|bssid
argument_list|)
condition|)
block|{
comment|/* Disconnected */
if|if
condition|(
name|memcmp
argument_list|(
name|drv
operator|->
name|bssid
argument_list|,
literal|"\x00\x00\x00\x00\x00\x00"
argument_list|,
name|ETH_ALEN
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|memset
argument_list|(
name|drv
operator|->
name|bssid
argument_list|,
literal|0
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
name|wpa_supplicant_event
argument_list|(
name|drv
operator|->
name|ctx
argument_list|,
name|EVENT_DISASSOC
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
comment|/* Connected */
if|if
condition|(
name|memcmp
argument_list|(
name|drv
operator|->
name|bssid
argument_list|,
name|bssid
argument_list|,
name|ETH_ALEN
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|memcpy
argument_list|(
name|drv
operator|->
name|bssid
argument_list|,
name|bssid
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
name|wpa_driver_ndis_get_associnfo
argument_list|(
name|drv
argument_list|)
expr_stmt|;
name|wpa_supplicant_event
argument_list|(
name|drv
operator|->
name|ctx
argument_list|,
name|EVENT_ASSOC
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
block|}
block|}
name|eloop_register_timeout
argument_list|(
literal|1
argument_list|,
literal|0
argument_list|,
name|wpa_driver_ndis_poll_timeout
argument_list|,
name|drv
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|wpa_driver_ndis_poll
parameter_list|(
name|void
modifier|*
name|priv
parameter_list|)
block|{
name|struct
name|wpa_driver_ndis_data
modifier|*
name|drv
init|=
name|priv
decl_stmt|;
name|eloop_cancel_timeout
argument_list|(
name|wpa_driver_ndis_poll_timeout
argument_list|,
name|drv
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|wpa_driver_ndis_poll_timeout
argument_list|(
name|drv
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* Called when driver generates Media Connect Event by calling  * NdisMIndicateStatus() with NDIS_STATUS_MEDIA_CONNECT */
end_comment

begin_function
name|void
name|wpa_driver_ndis_event_connect
parameter_list|(
name|struct
name|wpa_driver_ndis_data
modifier|*
name|drv
parameter_list|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"NDIS: Media Connect Event"
argument_list|)
expr_stmt|;
if|if
condition|(
name|wpa_driver_ndis_get_bssid
argument_list|(
name|drv
argument_list|,
name|drv
operator|->
name|bssid
argument_list|)
operator|==
literal|0
condition|)
block|{
name|wpa_driver_ndis_get_associnfo
argument_list|(
name|drv
argument_list|)
expr_stmt|;
name|wpa_supplicant_event
argument_list|(
name|drv
operator|->
name|ctx
argument_list|,
name|EVENT_ASSOC
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/* Called when driver generates Media Disconnect Event by calling  * NdisMIndicateStatus() with NDIS_STATUS_MEDIA_DISCONNECT */
end_comment

begin_function
name|void
name|wpa_driver_ndis_event_disconnect
parameter_list|(
name|struct
name|wpa_driver_ndis_data
modifier|*
name|drv
parameter_list|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"NDIS: Media Disconnect Event"
argument_list|)
expr_stmt|;
name|memset
argument_list|(
name|drv
operator|->
name|bssid
argument_list|,
literal|0
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
name|wpa_supplicant_event
argument_list|(
name|drv
operator|->
name|ctx
argument_list|,
name|EVENT_DISASSOC
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|wpa_driver_ndis_event_auth
parameter_list|(
name|struct
name|wpa_driver_ndis_data
modifier|*
name|drv
parameter_list|,
specifier|const
name|u8
modifier|*
name|data
parameter_list|,
name|size_t
name|data_len
parameter_list|)
block|{
name|NDIS_802_11_AUTHENTICATION_REQUEST
modifier|*
name|req
decl_stmt|;
name|int
name|pairwise
init|=
literal|0
decl_stmt|,
name|group
init|=
literal|0
decl_stmt|;
name|union
name|wpa_event_data
name|event
decl_stmt|;
if|if
condition|(
name|data_len
operator|<
sizeof|sizeof
argument_list|(
operator|*
name|req
argument_list|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"NDIS: Too short Authentication Request "
literal|"Event (len=%d)"
argument_list|,
name|data_len
argument_list|)
expr_stmt|;
return|return;
block|}
name|req
operator|=
operator|(
name|NDIS_802_11_AUTHENTICATION_REQUEST
operator|*
operator|)
name|data
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"NDIS: Authentication Request Event: "
literal|"Bssid "
name|MACSTR
literal|" Flags 0x%x"
argument_list|,
name|MAC2STR
argument_list|(
name|req
operator|->
name|Bssid
argument_list|)
argument_list|,
operator|(
name|int
operator|)
name|req
operator|->
name|Flags
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|req
operator|->
name|Flags
operator|&
name|NDIS_802_11_AUTH_REQUEST_PAIRWISE_ERROR
operator|)
operator|==
name|NDIS_802_11_AUTH_REQUEST_PAIRWISE_ERROR
condition|)
name|pairwise
operator|=
literal|1
expr_stmt|;
elseif|else
if|if
condition|(
operator|(
name|req
operator|->
name|Flags
operator|&
name|NDIS_802_11_AUTH_REQUEST_GROUP_ERROR
operator|)
operator|==
name|NDIS_802_11_AUTH_REQUEST_GROUP_ERROR
condition|)
name|group
operator|=
literal|1
expr_stmt|;
if|if
condition|(
name|pairwise
operator|||
name|group
condition|)
block|{
name|memset
argument_list|(
operator|&
name|event
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|event
argument_list|)
argument_list|)
expr_stmt|;
name|event
operator|.
name|michael_mic_failure
operator|.
name|unicast
operator|=
name|pairwise
expr_stmt|;
name|wpa_supplicant_event
argument_list|(
name|drv
operator|->
name|ctx
argument_list|,
name|EVENT_MICHAEL_MIC_FAILURE
argument_list|,
operator|&
name|event
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|wpa_driver_ndis_event_pmkid
parameter_list|(
name|struct
name|wpa_driver_ndis_data
modifier|*
name|drv
parameter_list|,
specifier|const
name|u8
modifier|*
name|data
parameter_list|,
name|size_t
name|data_len
parameter_list|)
block|{
name|NDIS_802_11_PMKID_CANDIDATE_LIST
modifier|*
name|pmkid
decl_stmt|;
name|int
name|i
decl_stmt|;
name|union
name|wpa_event_data
name|event
decl_stmt|;
if|if
condition|(
name|data_len
operator|<
literal|8
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"NDIS: Too short PMKID Candidate List "
literal|"Event (len=%d)"
argument_list|,
name|data_len
argument_list|)
expr_stmt|;
return|return;
block|}
name|pmkid
operator|=
operator|(
name|NDIS_802_11_PMKID_CANDIDATE_LIST
operator|*
operator|)
name|data
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"NDIS: PMKID Candidate List Event - Version %d "
literal|"NumCandidates %d"
argument_list|,
operator|(
name|int
operator|)
name|pmkid
operator|->
name|Version
argument_list|,
operator|(
name|int
operator|)
name|pmkid
operator|->
name|NumCandidates
argument_list|)
expr_stmt|;
if|if
condition|(
name|pmkid
operator|->
name|Version
operator|!=
literal|1
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"NDIS: Unsupported PMKID Candidate List "
literal|"Version %d"
argument_list|,
operator|(
name|int
operator|)
name|pmkid
operator|->
name|Version
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|data_len
operator|<
literal|8
operator|+
name|pmkid
operator|->
name|NumCandidates
operator|*
sizeof|sizeof
argument_list|(
name|PMKID_CANDIDATE
argument_list|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"NDIS: PMKID Candidate List underflow"
argument_list|)
expr_stmt|;
return|return;
block|}
name|memset
argument_list|(
operator|&
name|event
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|event
argument_list|)
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|pmkid
operator|->
name|NumCandidates
condition|;
name|i
operator|++
control|)
block|{
name|PMKID_CANDIDATE
modifier|*
name|p
init|=
operator|&
name|pmkid
operator|->
name|CandidateList
index|[
name|i
index|]
decl_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"NDIS: %d: "
name|MACSTR
literal|" Flags 0x%x"
argument_list|,
name|i
argument_list|,
name|MAC2STR
argument_list|(
name|p
operator|->
name|BSSID
argument_list|)
argument_list|,
operator|(
name|int
operator|)
name|p
operator|->
name|Flags
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
name|event
operator|.
name|pmkid_candidate
operator|.
name|bssid
argument_list|,
name|p
operator|->
name|BSSID
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
name|event
operator|.
name|pmkid_candidate
operator|.
name|index
operator|=
name|i
expr_stmt|;
name|event
operator|.
name|pmkid_candidate
operator|.
name|preauth
operator|=
name|p
operator|->
name|Flags
operator|&
name|NDIS_802_11_PMKID_CANDIDATE_PREAUTH_ENABLED
expr_stmt|;
name|wpa_supplicant_event
argument_list|(
name|drv
operator|->
name|ctx
argument_list|,
name|EVENT_PMKID_CANDIDATE
argument_list|,
operator|&
name|event
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/* Called when driver calls NdisMIndicateStatus() with  * NDIS_STATUS_MEDIA_SPECIFIC_INDICATION */
end_comment

begin_function
name|void
name|wpa_driver_ndis_event_media_specific
parameter_list|(
name|struct
name|wpa_driver_ndis_data
modifier|*
name|drv
parameter_list|,
specifier|const
name|u8
modifier|*
name|data
parameter_list|,
name|size_t
name|data_len
parameter_list|)
block|{
name|NDIS_802_11_STATUS_INDICATION
modifier|*
name|status
decl_stmt|;
if|if
condition|(
name|data
operator|==
name|NULL
operator|||
name|data_len
operator|<
sizeof|sizeof
argument_list|(
operator|*
name|status
argument_list|)
condition|)
return|return;
name|wpa_hexdump
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"NDIS: Media Specific Indication"
argument_list|,
name|data
argument_list|,
name|data_len
argument_list|)
expr_stmt|;
name|status
operator|=
operator|(
name|NDIS_802_11_STATUS_INDICATION
operator|*
operator|)
name|data
expr_stmt|;
name|data
operator|+=
sizeof|sizeof
argument_list|(
name|status
argument_list|)
expr_stmt|;
name|data_len
operator|-=
sizeof|sizeof
argument_list|(
name|status
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|status
operator|->
name|StatusType
condition|)
block|{
case|case
name|Ndis802_11StatusType_Authentication
case|:
name|wpa_driver_ndis_event_auth
argument_list|(
name|drv
argument_list|,
name|data
argument_list|,
name|data_len
argument_list|)
expr_stmt|;
break|break;
case|case
name|Ndis802_11StatusType_PMKID_CandidateList
case|:
name|wpa_driver_ndis_event_pmkid
argument_list|(
name|drv
argument_list|,
name|data
argument_list|,
name|data_len
argument_list|)
expr_stmt|;
break|break;
default|default:
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"NDIS: Unknown StatusType %d"
argument_list|,
operator|(
name|int
operator|)
name|status
operator|->
name|StatusType
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|wpa_driver_ndis_get_wpa_capability
parameter_list|(
name|struct
name|wpa_driver_ndis_data
modifier|*
name|drv
parameter_list|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"NDIS: verifying driver WPA capability"
argument_list|)
expr_stmt|;
if|if
condition|(
name|ndis_set_auth_mode
argument_list|(
name|drv
argument_list|,
name|Ndis802_11AuthModeWPA
argument_list|)
operator|==
literal|0
operator|&&
name|ndis_get_auth_mode
argument_list|(
name|drv
argument_list|)
operator|==
name|Ndis802_11AuthModeWPA
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"NDIS: WPA key management supported"
argument_list|)
expr_stmt|;
name|drv
operator|->
name|capa
operator|.
name|key_mgmt
operator||=
name|WPA_DRIVER_CAPA_KEY_MGMT_WPA
expr_stmt|;
block|}
if|if
condition|(
name|ndis_set_auth_mode
argument_list|(
name|drv
argument_list|,
name|Ndis802_11AuthModeWPAPSK
argument_list|)
operator|==
literal|0
operator|&&
name|ndis_get_auth_mode
argument_list|(
name|drv
argument_list|)
operator|==
name|Ndis802_11AuthModeWPAPSK
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"NDIS: WPA-PSK key management "
literal|"supported"
argument_list|)
expr_stmt|;
name|drv
operator|->
name|capa
operator|.
name|key_mgmt
operator||=
name|WPA_DRIVER_CAPA_KEY_MGMT_WPA_PSK
expr_stmt|;
block|}
if|if
condition|(
name|ndis_set_encr_status
argument_list|(
name|drv
argument_list|,
name|Ndis802_11Encryption3Enabled
argument_list|)
operator|==
literal|0
operator|&&
name|ndis_get_encr_status
argument_list|(
name|drv
argument_list|)
operator|==
name|Ndis802_11Encryption3KeyAbsent
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"NDIS: CCMP encryption supported"
argument_list|)
expr_stmt|;
name|drv
operator|->
name|capa
operator|.
name|enc
operator||=
name|WPA_DRIVER_CAPA_ENC_CCMP
expr_stmt|;
block|}
if|if
condition|(
name|ndis_set_encr_status
argument_list|(
name|drv
argument_list|,
name|Ndis802_11Encryption2Enabled
argument_list|)
operator|==
literal|0
operator|&&
name|ndis_get_encr_status
argument_list|(
name|drv
argument_list|)
operator|==
name|Ndis802_11Encryption2KeyAbsent
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"NDIS: TKIP encryption supported"
argument_list|)
expr_stmt|;
name|drv
operator|->
name|capa
operator|.
name|enc
operator||=
name|WPA_DRIVER_CAPA_ENC_TKIP
expr_stmt|;
block|}
if|if
condition|(
name|ndis_set_encr_status
argument_list|(
name|drv
argument_list|,
name|Ndis802_11Encryption1Enabled
argument_list|)
operator|==
literal|0
operator|&&
name|ndis_get_encr_status
argument_list|(
name|drv
argument_list|)
operator|==
name|Ndis802_11Encryption1KeyAbsent
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"NDIS: WEP encryption supported"
argument_list|)
expr_stmt|;
name|drv
operator|->
name|capa
operator|.
name|enc
operator||=
name|WPA_DRIVER_CAPA_ENC_WEP40
operator||
name|WPA_DRIVER_CAPA_ENC_WEP104
expr_stmt|;
block|}
if|if
condition|(
name|ndis_set_auth_mode
argument_list|(
name|drv
argument_list|,
name|Ndis802_11AuthModeShared
argument_list|)
operator|==
literal|0
operator|&&
name|ndis_get_auth_mode
argument_list|(
name|drv
argument_list|)
operator|==
name|Ndis802_11AuthModeShared
condition|)
block|{
name|drv
operator|->
name|capa
operator|.
name|auth
operator||=
name|WPA_DRIVER_AUTH_SHARED
expr_stmt|;
block|}
if|if
condition|(
name|ndis_set_auth_mode
argument_list|(
name|drv
argument_list|,
name|Ndis802_11AuthModeOpen
argument_list|)
operator|==
literal|0
operator|&&
name|ndis_get_auth_mode
argument_list|(
name|drv
argument_list|)
operator|==
name|Ndis802_11AuthModeOpen
condition|)
block|{
name|drv
operator|->
name|capa
operator|.
name|auth
operator||=
name|WPA_DRIVER_AUTH_OPEN
expr_stmt|;
block|}
name|ndis_set_encr_status
argument_list|(
name|drv
argument_list|,
name|Ndis802_11EncryptionDisabled
argument_list|)
expr_stmt|;
comment|/* Could also verify OID_802_11_ADD_KEY error reporting and 	 * support for OID_802_11_ASSOCIATION_INFORMATION. */
if|if
condition|(
name|drv
operator|->
name|capa
operator|.
name|key_mgmt
operator|&
name|WPA_DRIVER_CAPA_KEY_MGMT_WPA
operator|&&
name|drv
operator|->
name|capa
operator|.
name|enc
operator|&
operator|(
name|WPA_DRIVER_CAPA_ENC_TKIP
operator||
name|WPA_DRIVER_CAPA_ENC_CCMP
operator|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"NDIS: driver supports WPA"
argument_list|)
expr_stmt|;
name|drv
operator|->
name|has_capability
operator|=
literal|1
expr_stmt|;
block|}
else|else
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"NDIS: no WPA support found"
argument_list|)
expr_stmt|;
block|}
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"NDIS: driver capabilities: key_mgmt 0x%x "
literal|"enc 0x%x auth 0x%x"
argument_list|,
name|drv
operator|->
name|capa
operator|.
name|key_mgmt
argument_list|,
name|drv
operator|->
name|capa
operator|.
name|enc
argument_list|,
name|drv
operator|->
name|capa
operator|.
name|auth
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|wpa_driver_ndis_get_capability
parameter_list|(
name|struct
name|wpa_driver_ndis_data
modifier|*
name|drv
parameter_list|)
block|{
name|char
name|buf
index|[
literal|512
index|]
decl_stmt|;
name|int
name|len
decl_stmt|,
name|i
decl_stmt|;
name|NDIS_802_11_CAPABILITY
modifier|*
name|c
decl_stmt|;
name|drv
operator|->
name|capa
operator|.
name|flags
operator|=
name|WPA_DRIVER_FLAGS_DRIVER_IE
operator||
name|WPA_DRIVER_FLAGS_SET_KEYS_AFTER_ASSOC
expr_stmt|;
name|len
operator|=
name|ndis_get_oid
argument_list|(
name|drv
argument_list|,
name|OID_802_11_CAPABILITY
argument_list|,
name|buf
argument_list|,
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|len
operator|<
literal|0
condition|)
block|{
name|wpa_driver_ndis_get_wpa_capability
argument_list|(
name|drv
argument_list|)
expr_stmt|;
return|return;
block|}
name|wpa_hexdump
argument_list|(
name|MSG_MSGDUMP
argument_list|,
literal|"OID_802_11_CAPABILITY"
argument_list|,
name|buf
argument_list|,
name|len
argument_list|)
expr_stmt|;
name|c
operator|=
operator|(
name|NDIS_802_11_CAPABILITY
operator|*
operator|)
name|buf
expr_stmt|;
if|if
condition|(
name|len
operator|<
sizeof|sizeof
argument_list|(
operator|*
name|c
argument_list|)
operator|||
name|c
operator|->
name|Version
operator|!=
literal|2
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"NDIS: unsupported "
literal|"OID_802_11_CAPABILITY data"
argument_list|)
expr_stmt|;
return|return;
block|}
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"NDIS: Driver supports OID_802_11_CAPABILITY - "
literal|"NoOfPMKIDs %d NoOfAuthEncrPairs %d"
argument_list|,
operator|(
name|int
operator|)
name|c
operator|->
name|NoOfPMKIDs
argument_list|,
operator|(
name|int
operator|)
name|c
operator|->
name|NoOfAuthEncryptPairSupported
argument_list|)
expr_stmt|;
name|drv
operator|->
name|has_capability
operator|=
literal|1
expr_stmt|;
name|drv
operator|->
name|no_of_pmkid
operator|=
name|c
operator|->
name|NoOfPMKIDs
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|c
operator|->
name|NoOfAuthEncryptPairSupported
condition|;
name|i
operator|++
control|)
block|{
name|NDIS_802_11_AUTHENTICATION_ENCRYPTION
modifier|*
name|ae
decl_stmt|;
name|ae
operator|=
operator|&
name|c
operator|->
name|AuthenticationEncryptionSupported
index|[
name|i
index|]
expr_stmt|;
if|if
condition|(
operator|(
name|char
operator|*
operator|)
operator|(
name|ae
operator|+
literal|1
operator|)
operator|>
name|buf
operator|+
name|len
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"NDIS: auth/encr pair list "
literal|"overflow"
argument_list|)
expr_stmt|;
break|break;
block|}
name|wpa_printf
argument_list|(
name|MSG_MSGDUMP
argument_list|,
literal|"NDIS: %d - auth %d encr %d"
argument_list|,
name|i
argument_list|,
operator|(
name|int
operator|)
name|ae
operator|->
name|AuthModeSupported
argument_list|,
operator|(
name|int
operator|)
name|ae
operator|->
name|EncryptStatusSupported
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|ae
operator|->
name|AuthModeSupported
condition|)
block|{
case|case
name|Ndis802_11AuthModeOpen
case|:
name|drv
operator|->
name|capa
operator|.
name|auth
operator||=
name|WPA_DRIVER_AUTH_OPEN
expr_stmt|;
break|break;
case|case
name|Ndis802_11AuthModeShared
case|:
name|drv
operator|->
name|capa
operator|.
name|auth
operator||=
name|WPA_DRIVER_AUTH_SHARED
expr_stmt|;
break|break;
case|case
name|Ndis802_11AuthModeWPA
case|:
name|drv
operator|->
name|capa
operator|.
name|key_mgmt
operator||=
name|WPA_DRIVER_CAPA_KEY_MGMT_WPA
expr_stmt|;
break|break;
case|case
name|Ndis802_11AuthModeWPAPSK
case|:
name|drv
operator|->
name|capa
operator|.
name|key_mgmt
operator||=
name|WPA_DRIVER_CAPA_KEY_MGMT_WPA_PSK
expr_stmt|;
break|break;
case|case
name|Ndis802_11AuthModeWPA2
case|:
name|drv
operator|->
name|capa
operator|.
name|key_mgmt
operator||=
name|WPA_DRIVER_CAPA_KEY_MGMT_WPA2
expr_stmt|;
break|break;
case|case
name|Ndis802_11AuthModeWPA2PSK
case|:
name|drv
operator|->
name|capa
operator|.
name|key_mgmt
operator||=
name|WPA_DRIVER_CAPA_KEY_MGMT_WPA2_PSK
expr_stmt|;
break|break;
case|case
name|Ndis802_11AuthModeWPANone
case|:
name|drv
operator|->
name|capa
operator|.
name|key_mgmt
operator||=
name|WPA_DRIVER_CAPA_KEY_MGMT_WPA_NONE
expr_stmt|;
break|break;
default|default:
break|break;
block|}
switch|switch
condition|(
name|ae
operator|->
name|EncryptStatusSupported
condition|)
block|{
case|case
name|Ndis802_11Encryption1Enabled
case|:
name|drv
operator|->
name|capa
operator|.
name|enc
operator||=
name|WPA_DRIVER_CAPA_ENC_WEP40
expr_stmt|;
name|drv
operator|->
name|capa
operator|.
name|enc
operator||=
name|WPA_DRIVER_CAPA_ENC_WEP104
expr_stmt|;
break|break;
case|case
name|Ndis802_11Encryption2Enabled
case|:
name|drv
operator|->
name|capa
operator|.
name|enc
operator||=
name|WPA_DRIVER_CAPA_ENC_TKIP
expr_stmt|;
break|break;
case|case
name|Ndis802_11Encryption3Enabled
case|:
name|drv
operator|->
name|capa
operator|.
name|enc
operator||=
name|WPA_DRIVER_CAPA_ENC_CCMP
expr_stmt|;
break|break;
default|default:
break|break;
block|}
block|}
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"NDIS: driver capabilities: key_mgmt 0x%x "
literal|"enc 0x%x auth 0x%x"
argument_list|,
name|drv
operator|->
name|capa
operator|.
name|key_mgmt
argument_list|,
name|drv
operator|->
name|capa
operator|.
name|enc
argument_list|,
name|drv
operator|->
name|capa
operator|.
name|auth
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|wpa_driver_ndis_get_capa
parameter_list|(
name|void
modifier|*
name|priv
parameter_list|,
name|struct
name|wpa_driver_capa
modifier|*
name|capa
parameter_list|)
block|{
name|struct
name|wpa_driver_ndis_data
modifier|*
name|drv
init|=
name|priv
decl_stmt|;
if|if
condition|(
operator|!
name|drv
operator|->
name|has_capability
condition|)
return|return
operator|-
literal|1
return|;
name|memcpy
argument_list|(
name|capa
argument_list|,
operator|&
name|drv
operator|->
name|capa
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|capa
argument_list|)
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
specifier|const
name|char
modifier|*
name|wpa_driver_ndis_get_ifname
parameter_list|(
name|void
modifier|*
name|priv
parameter_list|)
block|{
name|struct
name|wpa_driver_ndis_data
modifier|*
name|drv
init|=
name|priv
decl_stmt|;
return|return
name|drv
operator|->
name|ifname
return|;
block|}
end_function

begin_function
specifier|static
specifier|const
name|u8
modifier|*
name|wpa_driver_ndis_get_mac_addr
parameter_list|(
name|void
modifier|*
name|priv
parameter_list|)
block|{
name|struct
name|wpa_driver_ndis_data
modifier|*
name|drv
init|=
name|priv
decl_stmt|;
return|return
name|drv
operator|->
name|own_addr
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|wpa_driver_ndis_get_names
parameter_list|(
name|struct
name|wpa_driver_ndis_data
modifier|*
name|drv
parameter_list|)
block|{
name|PTSTR
name|names
decl_stmt|,
name|pos
decl_stmt|,
name|pos2
decl_stmt|;
name|ULONG
name|len
decl_stmt|;
name|BOOLEAN
name|res
decl_stmt|;
specifier|const
name|int
name|MAX_ADAPTERS
init|=
literal|32
decl_stmt|;
name|char
modifier|*
name|name
index|[
name|MAX_ADAPTERS
index|]
decl_stmt|;
name|char
modifier|*
name|desc
index|[
name|MAX_ADAPTERS
index|]
decl_stmt|;
name|int
name|num_name
decl_stmt|,
name|num_desc
decl_stmt|,
name|i
decl_stmt|,
name|found_name
decl_stmt|,
name|found_desc
decl_stmt|;
name|size_t
name|dlen
decl_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"NDIS: Packet.dll version: %s"
argument_list|,
name|PacketGetVersion
argument_list|()
argument_list|)
expr_stmt|;
name|len
operator|=
literal|8192
expr_stmt|;
name|names
operator|=
name|malloc
argument_list|(
name|len
argument_list|)
expr_stmt|;
if|if
condition|(
name|names
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
name|memset
argument_list|(
name|names
argument_list|,
literal|0
argument_list|,
name|len
argument_list|)
expr_stmt|;
name|res
operator|=
name|PacketGetAdapterNames
argument_list|(
name|names
argument_list|,
operator|&
name|len
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|res
operator|&&
name|len
operator|>
literal|8192
condition|)
block|{
name|free
argument_list|(
name|names
argument_list|)
expr_stmt|;
name|names
operator|=
name|malloc
argument_list|(
name|len
argument_list|)
expr_stmt|;
if|if
condition|(
name|names
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
name|memset
argument_list|(
name|names
argument_list|,
literal|0
argument_list|,
name|len
argument_list|)
expr_stmt|;
name|res
operator|=
name|PacketGetAdapterNames
argument_list|(
name|names
argument_list|,
operator|&
name|len
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|res
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"NDIS: Failed to get adapter list "
literal|"(PacketGetAdapterNames)"
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|names
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
comment|/* wpa_hexdump_ascii(MSG_DEBUG, "NDIS: AdapterNames", names, len); */
if|if
condition|(
name|names
index|[
literal|0
index|]
operator|&&
name|names
index|[
literal|1
index|]
operator|==
literal|'\0'
operator|&&
name|names
index|[
literal|2
index|]
operator|&&
name|names
index|[
literal|3
index|]
operator|==
literal|'\0'
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"NDIS: Looks like adapter names are in "
literal|"UNICODE"
argument_list|)
expr_stmt|;
comment|/* Convert to ASCII */
name|pos2
operator|=
name|pos
operator|=
name|names
expr_stmt|;
while|while
condition|(
name|pos2
operator|<
name|names
operator|+
name|len
condition|)
block|{
if|if
condition|(
name|pos2
index|[
literal|0
index|]
operator|==
literal|'\0'
operator|&&
name|pos2
index|[
literal|1
index|]
operator|==
literal|'\0'
operator|&&
name|pos2
index|[
literal|2
index|]
operator|==
literal|'\0'
operator|&&
name|pos2
index|[
literal|3
index|]
operator|==
literal|'\0'
condition|)
block|{
name|pos2
operator|+=
literal|4
expr_stmt|;
break|break;
block|}
operator|*
name|pos
operator|++
operator|=
name|pos2
index|[
literal|0
index|]
expr_stmt|;
name|pos2
operator|+=
literal|2
expr_stmt|;
block|}
name|memcpy
argument_list|(
name|pos
operator|+
literal|2
argument_list|,
name|names
argument_list|,
name|pos
operator|-
name|names
argument_list|)
expr_stmt|;
name|pos
operator|+=
literal|2
expr_stmt|;
block|}
else|else
name|pos
operator|=
name|names
expr_stmt|;
name|num_name
operator|=
literal|0
expr_stmt|;
while|while
condition|(
name|pos
operator|<
name|names
operator|+
name|len
condition|)
block|{
name|name
index|[
name|num_name
index|]
operator|=
name|pos
expr_stmt|;
while|while
condition|(
operator|*
name|pos
operator|&&
name|pos
operator|<
name|names
operator|+
name|len
condition|)
name|pos
operator|++
expr_stmt|;
if|if
condition|(
name|pos
operator|+
literal|1
operator|>=
name|names
operator|+
name|len
condition|)
block|{
name|free
argument_list|(
name|names
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|pos
operator|++
expr_stmt|;
name|num_name
operator|++
expr_stmt|;
if|if
condition|(
name|num_name
operator|>=
name|MAX_ADAPTERS
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"NDIS: Too many adapters"
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|names
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
if|if
condition|(
operator|*
name|pos
operator|==
literal|'\0'
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"NDIS: %d adapter names found"
argument_list|,
name|num_name
argument_list|)
expr_stmt|;
name|pos
operator|++
expr_stmt|;
break|break;
block|}
block|}
name|num_desc
operator|=
literal|0
expr_stmt|;
while|while
condition|(
name|pos
operator|<
name|names
operator|+
name|len
condition|)
block|{
name|desc
index|[
name|num_desc
index|]
operator|=
name|pos
expr_stmt|;
while|while
condition|(
operator|*
name|pos
operator|&&
name|pos
operator|<
name|names
operator|+
name|len
condition|)
name|pos
operator|++
expr_stmt|;
if|if
condition|(
name|pos
operator|+
literal|1
operator|>=
name|names
operator|+
name|len
condition|)
block|{
name|free
argument_list|(
name|names
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|pos
operator|++
expr_stmt|;
name|num_desc
operator|++
expr_stmt|;
if|if
condition|(
name|num_desc
operator|>=
name|MAX_ADAPTERS
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"NDIS: Too many adapter "
literal|"descriptions"
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|names
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
if|if
condition|(
operator|*
name|pos
operator|==
literal|'\0'
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"NDIS: %d adapter descriptions "
literal|"found"
argument_list|,
name|num_name
argument_list|)
expr_stmt|;
name|pos
operator|++
expr_stmt|;
break|break;
block|}
block|}
comment|/* 	 * Windows 98 with Packet.dll 3.0 alpha3 does not include adapter 	 * descriptions. Fill in dummy descriptors to work around this. 	 */
while|while
condition|(
name|num_desc
operator|<
name|num_name
condition|)
name|desc
index|[
name|num_desc
operator|++
index|]
operator|=
literal|"dummy description"
expr_stmt|;
if|if
condition|(
name|num_name
operator|!=
name|num_desc
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"NDIS: mismatch in adapter name and "
literal|"description counts (%d != %d)"
argument_list|,
name|num_name
argument_list|,
name|num_desc
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|names
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|found_name
operator|=
name|found_desc
operator|=
operator|-
literal|1
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|num_name
condition|;
name|i
operator|++
control|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"NDIS: %d - %s - %s"
argument_list|,
name|i
argument_list|,
name|name
index|[
name|i
index|]
argument_list|,
name|desc
index|[
name|i
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|found_name
operator|==
operator|-
literal|1
operator|&&
name|strcmp
argument_list|(
name|name
index|[
name|i
index|]
argument_list|,
name|drv
operator|->
name|ifname
argument_list|)
operator|==
literal|0
condition|)
block|{
name|found_name
operator|=
name|i
expr_stmt|;
block|}
if|if
condition|(
name|found_desc
operator|==
operator|-
literal|1
operator|&&
name|strncmp
argument_list|(
name|desc
index|[
name|i
index|]
argument_list|,
name|drv
operator|->
name|ifname
argument_list|,
name|strlen
argument_list|(
name|drv
operator|->
name|ifname
argument_list|)
argument_list|)
operator|==
literal|0
condition|)
block|{
name|found_desc
operator|=
name|i
expr_stmt|;
block|}
block|}
if|if
condition|(
name|found_name
operator|<
literal|0
operator|&&
name|found_desc
operator|>=
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"NDIS: Matched interface '%s' based on "
literal|"description '%s'"
argument_list|,
name|name
index|[
name|found_desc
index|]
argument_list|,
name|desc
index|[
name|found_desc
index|]
argument_list|)
expr_stmt|;
name|found_name
operator|=
name|found_desc
expr_stmt|;
name|strncpy
argument_list|(
name|drv
operator|->
name|ifname
argument_list|,
name|name
index|[
name|found_desc
index|]
argument_list|,
sizeof|sizeof
argument_list|(
name|drv
operator|->
name|ifname
argument_list|)
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|found_name
operator|<
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"NDIS: Could not find interface '%s'"
argument_list|,
name|drv
operator|->
name|ifname
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|names
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|i
operator|=
name|found_name
expr_stmt|;
name|pos
operator|=
name|strchr
argument_list|(
name|desc
index|[
name|i
index|]
argument_list|,
literal|'('
argument_list|)
expr_stmt|;
if|if
condition|(
name|pos
condition|)
block|{
name|dlen
operator|=
name|pos
operator|-
name|desc
index|[
name|i
index|]
expr_stmt|;
name|pos
operator|--
expr_stmt|;
if|if
condition|(
name|pos
operator|>
name|desc
index|[
name|i
index|]
operator|&&
operator|*
name|pos
operator|==
literal|' '
condition|)
name|dlen
operator|--
expr_stmt|;
block|}
else|else
block|{
name|dlen
operator|=
name|strlen
argument_list|(
name|desc
index|[
name|i
index|]
argument_list|)
expr_stmt|;
block|}
name|drv
operator|->
name|adapter_desc
operator|=
name|malloc
argument_list|(
name|dlen
operator|+
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|drv
operator|->
name|adapter_desc
condition|)
block|{
name|memcpy
argument_list|(
name|drv
operator|->
name|adapter_desc
argument_list|,
name|desc
index|[
name|i
index|]
argument_list|,
name|dlen
argument_list|)
expr_stmt|;
name|drv
operator|->
name|adapter_desc
index|[
name|dlen
index|]
operator|=
literal|'\0'
expr_stmt|;
block|}
name|free
argument_list|(
name|names
argument_list|)
expr_stmt|;
if|if
condition|(
name|drv
operator|->
name|adapter_desc
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"NDIS: Adapter description prefix '%s'"
argument_list|,
name|drv
operator|->
name|adapter_desc
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|void
modifier|*
name|wpa_driver_ndis_init
parameter_list|(
name|void
modifier|*
name|ctx
parameter_list|,
specifier|const
name|char
modifier|*
name|ifname
parameter_list|)
block|{
name|struct
name|wpa_driver_ndis_data
modifier|*
name|drv
decl_stmt|;
name|u32
name|mode
decl_stmt|;
name|drv
operator|=
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|drv
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|drv
operator|==
name|NULL
condition|)
return|return
name|NULL
return|;
name|memset
argument_list|(
name|drv
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|drv
argument_list|)
argument_list|)
expr_stmt|;
name|drv
operator|->
name|ctx
operator|=
name|ctx
expr_stmt|;
name|strncpy
argument_list|(
name|drv
operator|->
name|ifname
argument_list|,
name|ifname
argument_list|,
sizeof|sizeof
argument_list|(
name|drv
operator|->
name|ifname
argument_list|)
argument_list|)
expr_stmt|;
name|drv
operator|->
name|event_sock
operator|=
operator|-
literal|1
expr_stmt|;
if|if
condition|(
name|wpa_driver_ndis_get_names
argument_list|(
name|drv
argument_list|)
operator|<
literal|0
condition|)
block|{
name|free
argument_list|(
name|drv
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|drv
operator|->
name|adapter
operator|=
name|PacketOpenAdapter
argument_list|(
name|drv
operator|->
name|ifname
argument_list|)
expr_stmt|;
if|if
condition|(
name|drv
operator|->
name|adapter
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"NDIS: PacketOpenAdapter failed for "
literal|"'%s'"
argument_list|,
name|drv
operator|->
name|ifname
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|drv
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
if|if
condition|(
name|ndis_get_oid
argument_list|(
name|drv
argument_list|,
name|OID_802_3_CURRENT_ADDRESS
argument_list|,
name|drv
operator|->
name|own_addr
argument_list|,
name|ETH_ALEN
argument_list|)
operator|<
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"NDIS: Get OID_802_3_CURRENT_ADDRESS "
literal|"failed"
argument_list|)
expr_stmt|;
name|PacketCloseAdapter
argument_list|(
name|drv
operator|->
name|adapter
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|drv
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|wpa_driver_ndis_get_capability
argument_list|(
name|drv
argument_list|)
expr_stmt|;
comment|/* Make sure that the driver does not have any obsolete PMKID entries. 	 */
name|wpa_driver_ndis_flush_pmkid
argument_list|(
name|drv
argument_list|)
expr_stmt|;
name|eloop_register_timeout
argument_list|(
literal|1
argument_list|,
literal|0
argument_list|,
name|wpa_driver_ndis_poll_timeout
argument_list|,
name|drv
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|wpa_driver_register_event_cb
argument_list|(
name|drv
argument_list|)
expr_stmt|;
comment|/* Set mode here in case card was configured for ad-hoc mode 	 * previously. */
name|mode
operator|=
name|Ndis802_11Infrastructure
expr_stmt|;
if|if
condition|(
name|ndis_set_oid
argument_list|(
name|drv
argument_list|,
name|OID_802_11_INFRASTRUCTURE_MODE
argument_list|,
operator|(
name|char
operator|*
operator|)
operator|&
name|mode
argument_list|,
sizeof|sizeof
argument_list|(
name|mode
argument_list|)
argument_list|)
operator|<
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"NDIS: Failed to set "
literal|"OID_802_11_INFRASTRUCTURE_MODE (%d)"
argument_list|,
operator|(
name|int
operator|)
name|mode
argument_list|)
expr_stmt|;
comment|/* Try to continue anyway */
if|if
condition|(
operator|!
name|drv
operator|->
name|has_capability
operator|&&
name|drv
operator|->
name|capa
operator|.
name|enc
operator|==
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"NDIS: Driver did not provide "
literal|"any wireless capabilities - assume it is "
literal|"a wired interface"
argument_list|)
expr_stmt|;
name|drv
operator|->
name|wired
operator|=
literal|1
expr_stmt|;
block|}
block|}
return|return
name|drv
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|wpa_driver_ndis_deinit
parameter_list|(
name|void
modifier|*
name|priv
parameter_list|)
block|{
name|struct
name|wpa_driver_ndis_data
modifier|*
name|drv
init|=
name|priv
decl_stmt|;
name|eloop_cancel_timeout
argument_list|(
name|wpa_driver_ndis_poll_timeout
argument_list|,
name|drv
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|wpa_driver_ndis_flush_pmkid
argument_list|(
name|drv
argument_list|)
expr_stmt|;
name|wpa_driver_ndis_disconnect
argument_list|(
name|drv
argument_list|)
expr_stmt|;
if|if
condition|(
name|wpa_driver_ndis_radio_off
argument_list|(
name|drv
argument_list|)
operator|<
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"NDIS: failed to disassociate and turn "
literal|"radio off"
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|drv
operator|->
name|event_sock
operator|>=
literal|0
condition|)
block|{
name|eloop_unregister_read_sock
argument_list|(
name|drv
operator|->
name|event_sock
argument_list|)
expr_stmt|;
name|close
argument_list|(
name|drv
operator|->
name|event_sock
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|drv
operator|->
name|adapter
condition|)
name|PacketCloseAdapter
argument_list|(
name|drv
operator|->
name|adapter
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|drv
operator|->
name|adapter_desc
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|drv
argument_list|)
expr_stmt|;
block|}
end_function

begin_decl_stmt
specifier|const
name|struct
name|wpa_driver_ops
name|wpa_driver_ndis_ops
init|=
block|{
operator|.
name|name
operator|=
literal|"ndis"
block|,
operator|.
name|desc
operator|=
literal|"Windows NDIS driver"
block|,
operator|.
name|init
operator|=
name|wpa_driver_ndis_init
block|,
operator|.
name|deinit
operator|=
name|wpa_driver_ndis_deinit
block|,
operator|.
name|set_wpa
operator|=
name|wpa_driver_ndis_set_wpa
block|,
operator|.
name|scan
operator|=
name|wpa_driver_ndis_scan
block|,
operator|.
name|get_scan_results
operator|=
name|wpa_driver_ndis_get_scan_results
block|,
operator|.
name|get_bssid
operator|=
name|wpa_driver_ndis_get_bssid
block|,
operator|.
name|get_ssid
operator|=
name|wpa_driver_ndis_get_ssid
block|,
operator|.
name|set_key
operator|=
name|wpa_driver_ndis_set_key
block|,
operator|.
name|associate
operator|=
name|wpa_driver_ndis_associate
block|,
operator|.
name|deauthenticate
operator|=
name|wpa_driver_ndis_deauthenticate
block|,
operator|.
name|disassociate
operator|=
name|wpa_driver_ndis_disassociate
block|,
operator|.
name|poll
operator|=
name|wpa_driver_ndis_poll
block|,
operator|.
name|add_pmkid
operator|=
name|wpa_driver_ndis_add_pmkid
block|,
operator|.
name|remove_pmkid
operator|=
name|wpa_driver_ndis_remove_pmkid
block|,
operator|.
name|flush_pmkid
operator|=
name|wpa_driver_ndis_flush_pmkid
block|,
operator|.
name|get_capa
operator|=
name|wpa_driver_ndis_get_capa
block|,
operator|.
name|get_ifname
operator|=
name|wpa_driver_ndis_get_ifname
block|,
operator|.
name|get_mac_addr
operator|=
name|wpa_driver_ndis_get_mac_addr
block|, }
decl_stmt|;
end_decl_stmt

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Copyright (C) 2004, 2006  Internet Systems Consortium, Inc. ("ISC")  * Copyright (C) 1999-2003  Internet Software Consortium.  *  * Permission to use, copy, modify, and distribute this software for any  * purpose with or without fee is hereby granted, provided that the above  * copyright notice and this permission notice appear in all copies.  *  * THE SOFTWARE IS PROVIDED "AS IS" AND ISC DISCLAIMS ALL WARRANTIES WITH  * REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF MERCHANTABILITY  * AND FITNESS.  IN NO EVENT SHALL ISC BE LIABLE FOR ANY SPECIAL, DIRECT,  * INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM  * LOSS OF USE, DATA OR PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE  * OR OTHER TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR  * PERFORMANCE OF THIS SOFTWARE.  */
end_comment

begin_comment
comment|/* $Id: rdataset.c,v 1.58.2.2.2.12 2006/03/02 00:37:20 marka Exp $ */
end_comment

begin_include
include|#
directive|include
file|<config.h>
end_include

begin_include
include|#
directive|include
file|<stdlib.h>
end_include

begin_include
include|#
directive|include
file|<isc/buffer.h>
end_include

begin_include
include|#
directive|include
file|<isc/mem.h>
end_include

begin_include
include|#
directive|include
file|<isc/random.h>
end_include

begin_include
include|#
directive|include
file|<isc/util.h>
end_include

begin_include
include|#
directive|include
file|<dns/name.h>
end_include

begin_include
include|#
directive|include
file|<dns/ncache.h>
end_include

begin_include
include|#
directive|include
file|<dns/rdata.h>
end_include

begin_include
include|#
directive|include
file|<dns/rdataset.h>
end_include

begin_include
include|#
directive|include
file|<dns/compress.h>
end_include

begin_function
name|void
name|dns_rdataset_init
parameter_list|(
name|dns_rdataset_t
modifier|*
name|rdataset
parameter_list|)
block|{
comment|/* 	 * Make 'rdataset' a valid, disassociated rdataset. 	 */
name|REQUIRE
argument_list|(
name|rdataset
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|rdataset
operator|->
name|magic
operator|=
name|DNS_RDATASET_MAGIC
expr_stmt|;
name|rdataset
operator|->
name|methods
operator|=
name|NULL
expr_stmt|;
name|ISC_LINK_INIT
argument_list|(
name|rdataset
argument_list|,
name|link
argument_list|)
expr_stmt|;
name|rdataset
operator|->
name|rdclass
operator|=
literal|0
expr_stmt|;
name|rdataset
operator|->
name|type
operator|=
literal|0
expr_stmt|;
name|rdataset
operator|->
name|ttl
operator|=
literal|0
expr_stmt|;
name|rdataset
operator|->
name|trust
operator|=
literal|0
expr_stmt|;
name|rdataset
operator|->
name|covers
operator|=
literal|0
expr_stmt|;
name|rdataset
operator|->
name|attributes
operator|=
literal|0
expr_stmt|;
name|rdataset
operator|->
name|count
operator|=
name|ISC_UINT32_MAX
expr_stmt|;
name|rdataset
operator|->
name|private1
operator|=
name|NULL
expr_stmt|;
name|rdataset
operator|->
name|private2
operator|=
name|NULL
expr_stmt|;
name|rdataset
operator|->
name|private3
operator|=
name|NULL
expr_stmt|;
name|rdataset
operator|->
name|privateuint4
operator|=
literal|0
expr_stmt|;
name|rdataset
operator|->
name|private5
operator|=
name|NULL
expr_stmt|;
name|rdataset
operator|->
name|private6
operator|=
name|NULL
expr_stmt|;
block|}
end_function

begin_function
name|void
name|dns_rdataset_invalidate
parameter_list|(
name|dns_rdataset_t
modifier|*
name|rdataset
parameter_list|)
block|{
comment|/* 	 * Invalidate 'rdataset'. 	 */
name|REQUIRE
argument_list|(
name|DNS_RDATASET_VALID
argument_list|(
name|rdataset
argument_list|)
argument_list|)
expr_stmt|;
name|REQUIRE
argument_list|(
name|rdataset
operator|->
name|methods
operator|==
name|NULL
argument_list|)
expr_stmt|;
name|rdataset
operator|->
name|magic
operator|=
literal|0
expr_stmt|;
name|ISC_LINK_INIT
argument_list|(
name|rdataset
argument_list|,
name|link
argument_list|)
expr_stmt|;
name|rdataset
operator|->
name|rdclass
operator|=
literal|0
expr_stmt|;
name|rdataset
operator|->
name|type
operator|=
literal|0
expr_stmt|;
name|rdataset
operator|->
name|ttl
operator|=
literal|0
expr_stmt|;
name|rdataset
operator|->
name|trust
operator|=
literal|0
expr_stmt|;
name|rdataset
operator|->
name|covers
operator|=
literal|0
expr_stmt|;
name|rdataset
operator|->
name|attributes
operator|=
literal|0
expr_stmt|;
name|rdataset
operator|->
name|count
operator|=
name|ISC_UINT32_MAX
expr_stmt|;
name|rdataset
operator|->
name|private1
operator|=
name|NULL
expr_stmt|;
name|rdataset
operator|->
name|private2
operator|=
name|NULL
expr_stmt|;
name|rdataset
operator|->
name|private3
operator|=
name|NULL
expr_stmt|;
name|rdataset
operator|->
name|privateuint4
operator|=
literal|0
expr_stmt|;
name|rdataset
operator|->
name|private5
operator|=
name|NULL
expr_stmt|;
block|}
end_function

begin_function
name|void
name|dns_rdataset_disassociate
parameter_list|(
name|dns_rdataset_t
modifier|*
name|rdataset
parameter_list|)
block|{
comment|/* 	 * Disassociate 'rdataset' from its rdata, allowing it to be reused. 	 */
name|REQUIRE
argument_list|(
name|DNS_RDATASET_VALID
argument_list|(
name|rdataset
argument_list|)
argument_list|)
expr_stmt|;
name|REQUIRE
argument_list|(
name|rdataset
operator|->
name|methods
operator|!=
name|NULL
argument_list|)
expr_stmt|;
call|(
name|rdataset
operator|->
name|methods
operator|->
name|disassociate
call|)
argument_list|(
name|rdataset
argument_list|)
expr_stmt|;
name|rdataset
operator|->
name|methods
operator|=
name|NULL
expr_stmt|;
name|ISC_LINK_INIT
argument_list|(
name|rdataset
argument_list|,
name|link
argument_list|)
expr_stmt|;
name|rdataset
operator|->
name|rdclass
operator|=
literal|0
expr_stmt|;
name|rdataset
operator|->
name|type
operator|=
literal|0
expr_stmt|;
name|rdataset
operator|->
name|ttl
operator|=
literal|0
expr_stmt|;
name|rdataset
operator|->
name|trust
operator|=
literal|0
expr_stmt|;
name|rdataset
operator|->
name|covers
operator|=
literal|0
expr_stmt|;
name|rdataset
operator|->
name|attributes
operator|=
literal|0
expr_stmt|;
name|rdataset
operator|->
name|count
operator|=
name|ISC_UINT32_MAX
expr_stmt|;
name|rdataset
operator|->
name|private1
operator|=
name|NULL
expr_stmt|;
name|rdataset
operator|->
name|private2
operator|=
name|NULL
expr_stmt|;
name|rdataset
operator|->
name|private3
operator|=
name|NULL
expr_stmt|;
name|rdataset
operator|->
name|privateuint4
operator|=
literal|0
expr_stmt|;
name|rdataset
operator|->
name|private5
operator|=
name|NULL
expr_stmt|;
name|rdataset
operator|->
name|private6
operator|=
name|NULL
expr_stmt|;
block|}
end_function

begin_function
name|isc_boolean_t
name|dns_rdataset_isassociated
parameter_list|(
name|dns_rdataset_t
modifier|*
name|rdataset
parameter_list|)
block|{
comment|/* 	 * Is 'rdataset' associated? 	 */
name|REQUIRE
argument_list|(
name|DNS_RDATASET_VALID
argument_list|(
name|rdataset
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|rdataset
operator|->
name|methods
operator|!=
name|NULL
condition|)
return|return
operator|(
name|ISC_TRUE
operator|)
return|;
return|return
operator|(
name|ISC_FALSE
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|question_disassociate
parameter_list|(
name|dns_rdataset_t
modifier|*
name|rdataset
parameter_list|)
block|{
name|UNUSED
argument_list|(
name|rdataset
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|isc_result_t
name|question_cursor
parameter_list|(
name|dns_rdataset_t
modifier|*
name|rdataset
parameter_list|)
block|{
name|UNUSED
argument_list|(
name|rdataset
argument_list|)
expr_stmt|;
return|return
operator|(
name|ISC_R_NOMORE
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|question_current
parameter_list|(
name|dns_rdataset_t
modifier|*
name|rdataset
parameter_list|,
name|dns_rdata_t
modifier|*
name|rdata
parameter_list|)
block|{
comment|/* 	 * This routine should never be called. 	 */
name|UNUSED
argument_list|(
name|rdataset
argument_list|)
expr_stmt|;
name|UNUSED
argument_list|(
name|rdata
argument_list|)
expr_stmt|;
name|REQUIRE
argument_list|(
literal|0
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|question_clone
parameter_list|(
name|dns_rdataset_t
modifier|*
name|source
parameter_list|,
name|dns_rdataset_t
modifier|*
name|target
parameter_list|)
block|{
operator|*
name|target
operator|=
operator|*
name|source
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|unsigned
name|int
name|question_count
parameter_list|(
name|dns_rdataset_t
modifier|*
name|rdataset
parameter_list|)
block|{
comment|/* 	 * This routine should never be called. 	 */
name|UNUSED
argument_list|(
name|rdataset
argument_list|)
expr_stmt|;
name|REQUIRE
argument_list|(
literal|0
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_decl_stmt
specifier|static
name|dns_rdatasetmethods_t
name|question_methods
init|=
block|{
name|question_disassociate
block|,
name|question_cursor
block|,
name|question_cursor
block|,
name|question_current
block|,
name|question_clone
block|,
name|question_count
block|,
name|NULL
block|,
name|NULL
block|}
decl_stmt|;
end_decl_stmt

begin_function
name|void
name|dns_rdataset_makequestion
parameter_list|(
name|dns_rdataset_t
modifier|*
name|rdataset
parameter_list|,
name|dns_rdataclass_t
name|rdclass
parameter_list|,
name|dns_rdatatype_t
name|type
parameter_list|)
block|{
comment|/* 	 * Make 'rdataset' a valid, associated, question rdataset, with a 	 * question class of 'rdclass' and type 'type'. 	 */
name|REQUIRE
argument_list|(
name|DNS_RDATASET_VALID
argument_list|(
name|rdataset
argument_list|)
argument_list|)
expr_stmt|;
name|REQUIRE
argument_list|(
name|rdataset
operator|->
name|methods
operator|==
name|NULL
argument_list|)
expr_stmt|;
name|rdataset
operator|->
name|methods
operator|=
operator|&
name|question_methods
expr_stmt|;
name|rdataset
operator|->
name|rdclass
operator|=
name|rdclass
expr_stmt|;
name|rdataset
operator|->
name|type
operator|=
name|type
expr_stmt|;
name|rdataset
operator|->
name|attributes
operator||=
name|DNS_RDATASETATTR_QUESTION
expr_stmt|;
block|}
end_function

begin_function
name|unsigned
name|int
name|dns_rdataset_count
parameter_list|(
name|dns_rdataset_t
modifier|*
name|rdataset
parameter_list|)
block|{
comment|/* 	 * Return the number of records in 'rdataset'. 	 */
name|REQUIRE
argument_list|(
name|DNS_RDATASET_VALID
argument_list|(
name|rdataset
argument_list|)
argument_list|)
expr_stmt|;
name|REQUIRE
argument_list|(
name|rdataset
operator|->
name|methods
operator|!=
name|NULL
argument_list|)
expr_stmt|;
return|return
operator|(
call|(
name|rdataset
operator|->
name|methods
operator|->
name|count
call|)
argument_list|(
name|rdataset
argument_list|)
operator|)
return|;
block|}
end_function

begin_function
name|void
name|dns_rdataset_clone
parameter_list|(
name|dns_rdataset_t
modifier|*
name|source
parameter_list|,
name|dns_rdataset_t
modifier|*
name|target
parameter_list|)
block|{
comment|/* 	 * Make 'target' refer to the same rdataset as 'source'. 	 */
name|REQUIRE
argument_list|(
name|DNS_RDATASET_VALID
argument_list|(
name|source
argument_list|)
argument_list|)
expr_stmt|;
name|REQUIRE
argument_list|(
name|source
operator|->
name|methods
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|REQUIRE
argument_list|(
name|DNS_RDATASET_VALID
argument_list|(
name|target
argument_list|)
argument_list|)
expr_stmt|;
name|REQUIRE
argument_list|(
name|target
operator|->
name|methods
operator|==
name|NULL
argument_list|)
expr_stmt|;
call|(
name|source
operator|->
name|methods
operator|->
name|clone
call|)
argument_list|(
name|source
argument_list|,
name|target
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|isc_result_t
name|dns_rdataset_first
parameter_list|(
name|dns_rdataset_t
modifier|*
name|rdataset
parameter_list|)
block|{
comment|/* 	 * Move the rdata cursor to the first rdata in the rdataset (if any). 	 */
name|REQUIRE
argument_list|(
name|DNS_RDATASET_VALID
argument_list|(
name|rdataset
argument_list|)
argument_list|)
expr_stmt|;
name|REQUIRE
argument_list|(
name|rdataset
operator|->
name|methods
operator|!=
name|NULL
argument_list|)
expr_stmt|;
return|return
operator|(
call|(
name|rdataset
operator|->
name|methods
operator|->
name|first
call|)
argument_list|(
name|rdataset
argument_list|)
operator|)
return|;
block|}
end_function

begin_function
name|isc_result_t
name|dns_rdataset_next
parameter_list|(
name|dns_rdataset_t
modifier|*
name|rdataset
parameter_list|)
block|{
comment|/* 	 * Move the rdata cursor to the next rdata in the rdataset (if any). 	 */
name|REQUIRE
argument_list|(
name|DNS_RDATASET_VALID
argument_list|(
name|rdataset
argument_list|)
argument_list|)
expr_stmt|;
name|REQUIRE
argument_list|(
name|rdataset
operator|->
name|methods
operator|!=
name|NULL
argument_list|)
expr_stmt|;
return|return
operator|(
call|(
name|rdataset
operator|->
name|methods
operator|->
name|next
call|)
argument_list|(
name|rdataset
argument_list|)
operator|)
return|;
block|}
end_function

begin_function
name|void
name|dns_rdataset_current
parameter_list|(
name|dns_rdataset_t
modifier|*
name|rdataset
parameter_list|,
name|dns_rdata_t
modifier|*
name|rdata
parameter_list|)
block|{
comment|/* 	 * Make 'rdata' refer to the current rdata. 	 */
name|REQUIRE
argument_list|(
name|DNS_RDATASET_VALID
argument_list|(
name|rdataset
argument_list|)
argument_list|)
expr_stmt|;
name|REQUIRE
argument_list|(
name|rdataset
operator|->
name|methods
operator|!=
name|NULL
argument_list|)
expr_stmt|;
call|(
name|rdataset
operator|->
name|methods
operator|->
name|current
call|)
argument_list|(
name|rdataset
argument_list|,
name|rdata
argument_list|)
expr_stmt|;
block|}
end_function

begin_define
define|#
directive|define
name|MAX_SHUFFLE
value|32
end_define

begin_define
define|#
directive|define
name|WANT_FIXED
parameter_list|(
name|r
parameter_list|)
value|(((r)->attributes& DNS_RDATASETATTR_FIXEDORDER) != 0)
end_define

begin_define
define|#
directive|define
name|WANT_RANDOM
parameter_list|(
name|r
parameter_list|)
value|(((r)->attributes& DNS_RDATASETATTR_RANDOMIZE) != 0)
end_define

begin_struct
struct|struct
name|towire_sort
block|{
name|int
name|key
decl_stmt|;
name|dns_rdata_t
modifier|*
name|rdata
decl_stmt|;
block|}
struct|;
end_struct

begin_function
specifier|static
name|int
name|towire_compare
parameter_list|(
specifier|const
name|void
modifier|*
name|av
parameter_list|,
specifier|const
name|void
modifier|*
name|bv
parameter_list|)
block|{
specifier|const
name|struct
name|towire_sort
modifier|*
name|a
init|=
operator|(
specifier|const
expr|struct
name|towire_sort
operator|*
operator|)
name|av
decl_stmt|;
specifier|const
name|struct
name|towire_sort
modifier|*
name|b
init|=
operator|(
specifier|const
expr|struct
name|towire_sort
operator|*
operator|)
name|bv
decl_stmt|;
return|return
operator|(
name|a
operator|->
name|key
operator|-
name|b
operator|->
name|key
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|isc_result_t
name|towiresorted
parameter_list|(
name|dns_rdataset_t
modifier|*
name|rdataset
parameter_list|,
specifier|const
name|dns_name_t
modifier|*
name|owner_name
parameter_list|,
name|dns_compress_t
modifier|*
name|cctx
parameter_list|,
name|isc_buffer_t
modifier|*
name|target
parameter_list|,
name|dns_rdatasetorderfunc_t
name|order
parameter_list|,
specifier|const
name|void
modifier|*
name|order_arg
parameter_list|,
name|isc_boolean_t
name|partial
parameter_list|,
name|unsigned
name|int
name|options
parameter_list|,
name|unsigned
name|int
modifier|*
name|countp
parameter_list|,
name|void
modifier|*
modifier|*
name|state
parameter_list|)
block|{
name|dns_rdata_t
name|rdata
init|=
name|DNS_RDATA_INIT
decl_stmt|;
name|isc_region_t
name|r
decl_stmt|;
name|isc_result_t
name|result
decl_stmt|;
name|unsigned
name|int
name|i
decl_stmt|,
name|count
decl_stmt|,
name|added
decl_stmt|,
name|choice
decl_stmt|;
name|isc_buffer_t
name|savedbuffer
decl_stmt|,
name|rdlen
decl_stmt|,
name|rrbuffer
decl_stmt|;
name|unsigned
name|int
name|headlen
decl_stmt|;
name|isc_boolean_t
name|question
init|=
name|ISC_FALSE
decl_stmt|;
name|isc_boolean_t
name|shuffle
init|=
name|ISC_FALSE
decl_stmt|;
name|dns_rdata_t
modifier|*
name|shuffled
init|=
name|NULL
decl_stmt|,
name|shuffled_fixed
index|[
name|MAX_SHUFFLE
index|]
decl_stmt|;
name|struct
name|towire_sort
modifier|*
name|sorted
init|=
name|NULL
decl_stmt|,
name|sorted_fixed
index|[
name|MAX_SHUFFLE
index|]
decl_stmt|;
name|UNUSED
argument_list|(
name|state
argument_list|)
expr_stmt|;
comment|/* 	 * Convert 'rdataset' to wire format, compressing names as specified 	 * in cctx, and storing the result in 'target'. 	 */
name|REQUIRE
argument_list|(
name|DNS_RDATASET_VALID
argument_list|(
name|rdataset
argument_list|)
argument_list|)
expr_stmt|;
name|REQUIRE
argument_list|(
name|countp
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|REQUIRE
argument_list|(
operator|(
name|order
operator|==
name|NULL
operator|)
operator|==
operator|(
name|order_arg
operator|==
name|NULL
operator|)
argument_list|)
expr_stmt|;
name|REQUIRE
argument_list|(
name|cctx
operator|!=
name|NULL
operator|&&
name|cctx
operator|->
name|mctx
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|count
operator|=
literal|0
expr_stmt|;
if|if
condition|(
operator|(
name|rdataset
operator|->
name|attributes
operator|&
name|DNS_RDATASETATTR_QUESTION
operator|)
operator|!=
literal|0
condition|)
block|{
name|question
operator|=
name|ISC_TRUE
expr_stmt|;
name|count
operator|=
literal|1
expr_stmt|;
name|result
operator|=
name|dns_rdataset_first
argument_list|(
name|rdataset
argument_list|)
expr_stmt|;
name|INSIST
argument_list|(
name|result
operator|==
name|ISC_R_NOMORE
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|rdataset
operator|->
name|type
operator|==
literal|0
condition|)
block|{
comment|/* 		 * This is a negative caching rdataset. 		 */
name|unsigned
name|int
name|ncache_opts
init|=
literal|0
decl_stmt|;
if|if
condition|(
operator|(
name|options
operator|&
name|DNS_RDATASETTOWIRE_OMITDNSSEC
operator|)
operator|!=
literal|0
condition|)
name|ncache_opts
operator||=
name|DNS_NCACHETOWIRE_OMITDNSSEC
expr_stmt|;
return|return
operator|(
name|dns_ncache_towire
argument_list|(
name|rdataset
argument_list|,
name|cctx
argument_list|,
name|target
argument_list|,
name|ncache_opts
argument_list|,
name|countp
argument_list|)
operator|)
return|;
block|}
else|else
block|{
name|count
operator|=
call|(
name|rdataset
operator|->
name|methods
operator|->
name|count
call|)
argument_list|(
name|rdataset
argument_list|)
expr_stmt|;
name|result
operator|=
name|dns_rdataset_first
argument_list|(
name|rdataset
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|==
name|ISC_R_NOMORE
condition|)
return|return
operator|(
name|ISC_R_SUCCESS
operator|)
return|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
return|return
operator|(
name|result
operator|)
return|;
block|}
comment|/* 	 * Do we want to shuffle this anwer? 	 */
if|if
condition|(
operator|!
name|question
operator|&&
name|count
operator|>
literal|1
operator|&&
operator|(
operator|!
name|WANT_FIXED
argument_list|(
name|rdataset
argument_list|)
operator|||
name|order
operator|!=
name|NULL
operator|)
operator|&&
name|rdataset
operator|->
name|type
operator|!=
name|dns_rdatatype_rrsig
condition|)
name|shuffle
operator|=
name|ISC_TRUE
expr_stmt|;
if|if
condition|(
name|shuffle
operator|&&
name|count
operator|>
name|MAX_SHUFFLE
condition|)
block|{
name|shuffled
operator|=
name|isc_mem_get
argument_list|(
name|cctx
operator|->
name|mctx
argument_list|,
name|count
operator|*
sizeof|sizeof
argument_list|(
operator|*
name|shuffled
argument_list|)
argument_list|)
expr_stmt|;
name|sorted
operator|=
name|isc_mem_get
argument_list|(
name|cctx
operator|->
name|mctx
argument_list|,
name|count
operator|*
sizeof|sizeof
argument_list|(
operator|*
name|sorted
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|shuffled
operator|==
name|NULL
operator|||
name|sorted
operator|==
name|NULL
condition|)
name|shuffle
operator|=
name|ISC_FALSE
expr_stmt|;
block|}
else|else
block|{
name|shuffled
operator|=
name|shuffled_fixed
expr_stmt|;
name|sorted
operator|=
name|sorted_fixed
expr_stmt|;
block|}
if|if
condition|(
name|shuffle
condition|)
block|{
comment|/* 		 * First we get handles to all of the rdata. 		 */
name|i
operator|=
literal|0
expr_stmt|;
do|do
block|{
name|INSIST
argument_list|(
name|i
operator|<
name|count
argument_list|)
expr_stmt|;
name|dns_rdata_init
argument_list|(
operator|&
name|shuffled
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|dns_rdataset_current
argument_list|(
name|rdataset
argument_list|,
operator|&
name|shuffled
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|i
operator|++
expr_stmt|;
name|result
operator|=
name|dns_rdataset_next
argument_list|(
name|rdataset
argument_list|)
expr_stmt|;
block|}
do|while
condition|(
name|result
operator|==
name|ISC_R_SUCCESS
condition|)
do|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_NOMORE
condition|)
goto|goto
name|cleanup
goto|;
name|INSIST
argument_list|(
name|i
operator|==
name|count
argument_list|)
expr_stmt|;
comment|/* 		 * Now we shuffle. 		 */
if|if
condition|(
name|WANT_FIXED
argument_list|(
name|rdataset
argument_list|)
condition|)
block|{
comment|/* 			 * 'Fixed' order. 			 */
name|INSIST
argument_list|(
name|order
operator|!=
name|NULL
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|count
condition|;
name|i
operator|++
control|)
block|{
name|sorted
index|[
name|i
index|]
operator|.
name|key
operator|=
call|(
modifier|*
name|order
call|)
argument_list|(
operator|&
name|shuffled
index|[
name|i
index|]
argument_list|,
name|order_arg
argument_list|)
expr_stmt|;
name|sorted
index|[
name|i
index|]
operator|.
name|rdata
operator|=
operator|&
name|shuffled
index|[
name|i
index|]
expr_stmt|;
block|}
block|}
elseif|else
if|if
condition|(
name|WANT_RANDOM
argument_list|(
name|rdataset
argument_list|)
condition|)
block|{
comment|/* 			 * 'Random' order. 			 */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|count
condition|;
name|i
operator|++
control|)
block|{
name|dns_rdata_t
name|rdata
decl_stmt|;
name|isc_uint32_t
name|val
decl_stmt|;
name|isc_random_get
argument_list|(
operator|&
name|val
argument_list|)
expr_stmt|;
name|choice
operator|=
name|i
operator|+
operator|(
name|val
operator|%
operator|(
name|count
operator|-
name|i
operator|)
operator|)
expr_stmt|;
name|rdata
operator|=
name|shuffled
index|[
name|i
index|]
expr_stmt|;
name|shuffled
index|[
name|i
index|]
operator|=
name|shuffled
index|[
name|choice
index|]
expr_stmt|;
name|shuffled
index|[
name|choice
index|]
operator|=
name|rdata
expr_stmt|;
if|if
condition|(
name|order
operator|!=
name|NULL
condition|)
name|sorted
index|[
name|i
index|]
operator|.
name|key
operator|=
call|(
modifier|*
name|order
call|)
argument_list|(
operator|&
name|shuffled
index|[
name|i
index|]
argument_list|,
name|order_arg
argument_list|)
expr_stmt|;
else|else
name|sorted
index|[
name|i
index|]
operator|.
name|key
operator|=
literal|0
expr_stmt|;
comment|/* Unused */
name|sorted
index|[
name|i
index|]
operator|.
name|rdata
operator|=
operator|&
name|shuffled
index|[
name|i
index|]
expr_stmt|;
block|}
block|}
else|else
block|{
comment|/* 			 * "Cyclic" order. 			 */
name|isc_uint32_t
name|val
decl_stmt|;
name|unsigned
name|int
name|j
decl_stmt|;
name|val
operator|=
name|rdataset
operator|->
name|count
expr_stmt|;
if|if
condition|(
name|val
operator|==
name|ISC_UINT32_MAX
condition|)
name|isc_random_get
argument_list|(
operator|&
name|val
argument_list|)
expr_stmt|;
name|j
operator|=
name|val
operator|%
name|count
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|count
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|order
operator|!=
name|NULL
condition|)
name|sorted
index|[
name|j
index|]
operator|.
name|key
operator|=
call|(
modifier|*
name|order
call|)
argument_list|(
operator|&
name|shuffled
index|[
name|i
index|]
argument_list|,
name|order_arg
argument_list|)
expr_stmt|;
else|else
name|sorted
index|[
name|j
index|]
operator|.
name|key
operator|=
literal|0
expr_stmt|;
comment|/* Unused */
name|sorted
index|[
name|j
index|]
operator|.
name|rdata
operator|=
operator|&
name|shuffled
index|[
name|i
index|]
expr_stmt|;
name|j
operator|++
expr_stmt|;
if|if
condition|(
name|j
operator|==
name|count
condition|)
name|j
operator|=
literal|0
expr_stmt|;
comment|/* Wrap around. */
block|}
block|}
comment|/* 		 * Sorted order. 		 */
if|if
condition|(
name|order
operator|!=
name|NULL
condition|)
name|qsort
argument_list|(
name|sorted
argument_list|,
name|count
argument_list|,
sizeof|sizeof
argument_list|(
name|sorted
index|[
literal|0
index|]
argument_list|)
argument_list|,
name|towire_compare
argument_list|)
expr_stmt|;
block|}
name|savedbuffer
operator|=
operator|*
name|target
expr_stmt|;
name|i
operator|=
literal|0
expr_stmt|;
name|added
operator|=
literal|0
expr_stmt|;
do|do
block|{
comment|/* 		 * Copy out the name, type, class, ttl. 		 */
name|rrbuffer
operator|=
operator|*
name|target
expr_stmt|;
name|dns_compress_setmethods
argument_list|(
name|cctx
argument_list|,
name|DNS_COMPRESS_GLOBAL14
argument_list|)
expr_stmt|;
name|result
operator|=
name|dns_name_towire
argument_list|(
name|owner_name
argument_list|,
name|cctx
argument_list|,
name|target
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
goto|goto
name|rollback
goto|;
name|headlen
operator|=
sizeof|sizeof
argument_list|(
name|dns_rdataclass_t
argument_list|)
operator|+
sizeof|sizeof
argument_list|(
name|dns_rdatatype_t
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|question
condition|)
name|headlen
operator|+=
sizeof|sizeof
argument_list|(
name|dns_ttl_t
argument_list|)
operator|+
literal|2
expr_stmt|;
comment|/* XXX 2 for rdata len */
name|isc_buffer_availableregion
argument_list|(
name|target
argument_list|,
operator|&
name|r
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
operator|.
name|length
operator|<
name|headlen
condition|)
block|{
name|result
operator|=
name|ISC_R_NOSPACE
expr_stmt|;
goto|goto
name|rollback
goto|;
block|}
name|isc_buffer_putuint16
argument_list|(
name|target
argument_list|,
name|rdataset
operator|->
name|type
argument_list|)
expr_stmt|;
name|isc_buffer_putuint16
argument_list|(
name|target
argument_list|,
name|rdataset
operator|->
name|rdclass
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|question
condition|)
block|{
name|isc_buffer_putuint32
argument_list|(
name|target
argument_list|,
name|rdataset
operator|->
name|ttl
argument_list|)
expr_stmt|;
comment|/* 			 * Save space for rdlen. 			 */
name|rdlen
operator|=
operator|*
name|target
expr_stmt|;
name|isc_buffer_add
argument_list|(
name|target
argument_list|,
literal|2
argument_list|)
expr_stmt|;
comment|/* 			 * Copy out the rdata 			 */
if|if
condition|(
name|shuffle
condition|)
name|rdata
operator|=
operator|*
operator|(
name|sorted
index|[
name|i
index|]
operator|.
name|rdata
operator|)
expr_stmt|;
else|else
block|{
name|dns_rdata_reset
argument_list|(
operator|&
name|rdata
argument_list|)
expr_stmt|;
name|dns_rdataset_current
argument_list|(
name|rdataset
argument_list|,
operator|&
name|rdata
argument_list|)
expr_stmt|;
block|}
name|result
operator|=
name|dns_rdata_towire
argument_list|(
operator|&
name|rdata
argument_list|,
name|cctx
argument_list|,
name|target
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
goto|goto
name|rollback
goto|;
name|INSIST
argument_list|(
operator|(
name|target
operator|->
name|used
operator|>=
name|rdlen
operator|.
name|used
operator|+
literal|2
operator|)
operator|&&
operator|(
name|target
operator|->
name|used
operator|-
name|rdlen
operator|.
name|used
operator|-
literal|2
operator|<
literal|65536
operator|)
argument_list|)
expr_stmt|;
name|isc_buffer_putuint16
argument_list|(
operator|&
name|rdlen
argument_list|,
call|(
name|isc_uint16_t
call|)
argument_list|(
name|target
operator|->
name|used
operator|-
name|rdlen
operator|.
name|used
operator|-
literal|2
argument_list|)
argument_list|)
expr_stmt|;
name|added
operator|++
expr_stmt|;
block|}
if|if
condition|(
name|shuffle
condition|)
block|{
name|i
operator|++
expr_stmt|;
if|if
condition|(
name|i
operator|==
name|count
condition|)
name|result
operator|=
name|ISC_R_NOMORE
expr_stmt|;
else|else
name|result
operator|=
name|ISC_R_SUCCESS
expr_stmt|;
block|}
else|else
block|{
name|result
operator|=
name|dns_rdataset_next
argument_list|(
name|rdataset
argument_list|)
expr_stmt|;
block|}
block|}
do|while
condition|(
name|result
operator|==
name|ISC_R_SUCCESS
condition|)
do|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_NOMORE
condition|)
goto|goto
name|rollback
goto|;
operator|*
name|countp
operator|+=
name|count
expr_stmt|;
name|result
operator|=
name|ISC_R_SUCCESS
expr_stmt|;
goto|goto
name|cleanup
goto|;
name|rollback
label|:
if|if
condition|(
name|partial
operator|&&
name|result
operator|==
name|ISC_R_NOSPACE
condition|)
block|{
name|INSIST
argument_list|(
name|rrbuffer
operator|.
name|used
operator|<
literal|65536
argument_list|)
expr_stmt|;
name|dns_compress_rollback
argument_list|(
name|cctx
argument_list|,
operator|(
name|isc_uint16_t
operator|)
name|rrbuffer
operator|.
name|used
argument_list|)
expr_stmt|;
operator|*
name|countp
operator|+=
name|added
expr_stmt|;
operator|*
name|target
operator|=
name|rrbuffer
expr_stmt|;
goto|goto
name|cleanup
goto|;
block|}
name|INSIST
argument_list|(
name|savedbuffer
operator|.
name|used
operator|<
literal|65536
argument_list|)
expr_stmt|;
name|dns_compress_rollback
argument_list|(
name|cctx
argument_list|,
operator|(
name|isc_uint16_t
operator|)
name|savedbuffer
operator|.
name|used
argument_list|)
expr_stmt|;
operator|*
name|countp
operator|=
literal|0
expr_stmt|;
operator|*
name|target
operator|=
name|savedbuffer
expr_stmt|;
name|cleanup
label|:
if|if
condition|(
name|sorted
operator|!=
name|NULL
operator|&&
name|sorted
operator|!=
name|sorted_fixed
condition|)
name|isc_mem_put
argument_list|(
name|cctx
operator|->
name|mctx
argument_list|,
name|sorted
argument_list|,
name|count
operator|*
sizeof|sizeof
argument_list|(
operator|*
name|sorted
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|shuffled
operator|!=
name|NULL
operator|&&
name|shuffled
operator|!=
name|shuffled_fixed
condition|)
name|isc_mem_put
argument_list|(
name|cctx
operator|->
name|mctx
argument_list|,
name|shuffled
argument_list|,
name|count
operator|*
sizeof|sizeof
argument_list|(
operator|*
name|shuffled
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|(
name|result
operator|)
return|;
block|}
end_function

begin_function
name|isc_result_t
name|dns_rdataset_towiresorted
parameter_list|(
name|dns_rdataset_t
modifier|*
name|rdataset
parameter_list|,
specifier|const
name|dns_name_t
modifier|*
name|owner_name
parameter_list|,
name|dns_compress_t
modifier|*
name|cctx
parameter_list|,
name|isc_buffer_t
modifier|*
name|target
parameter_list|,
name|dns_rdatasetorderfunc_t
name|order
parameter_list|,
specifier|const
name|void
modifier|*
name|order_arg
parameter_list|,
name|unsigned
name|int
name|options
parameter_list|,
name|unsigned
name|int
modifier|*
name|countp
parameter_list|)
block|{
return|return
operator|(
name|towiresorted
argument_list|(
name|rdataset
argument_list|,
name|owner_name
argument_list|,
name|cctx
argument_list|,
name|target
argument_list|,
name|order
argument_list|,
name|order_arg
argument_list|,
name|ISC_FALSE
argument_list|,
name|options
argument_list|,
name|countp
argument_list|,
name|NULL
argument_list|)
operator|)
return|;
block|}
end_function

begin_function
name|isc_result_t
name|dns_rdataset_towirepartial
parameter_list|(
name|dns_rdataset_t
modifier|*
name|rdataset
parameter_list|,
specifier|const
name|dns_name_t
modifier|*
name|owner_name
parameter_list|,
name|dns_compress_t
modifier|*
name|cctx
parameter_list|,
name|isc_buffer_t
modifier|*
name|target
parameter_list|,
name|dns_rdatasetorderfunc_t
name|order
parameter_list|,
specifier|const
name|void
modifier|*
name|order_arg
parameter_list|,
name|unsigned
name|int
name|options
parameter_list|,
name|unsigned
name|int
modifier|*
name|countp
parameter_list|,
name|void
modifier|*
modifier|*
name|state
parameter_list|)
block|{
name|REQUIRE
argument_list|(
name|state
operator|==
name|NULL
argument_list|)
expr_stmt|;
comment|/* XXX remove when implemented */
return|return
operator|(
name|towiresorted
argument_list|(
name|rdataset
argument_list|,
name|owner_name
argument_list|,
name|cctx
argument_list|,
name|target
argument_list|,
name|order
argument_list|,
name|order_arg
argument_list|,
name|ISC_TRUE
argument_list|,
name|options
argument_list|,
name|countp
argument_list|,
name|state
argument_list|)
operator|)
return|;
block|}
end_function

begin_function
name|isc_result_t
name|dns_rdataset_towire
parameter_list|(
name|dns_rdataset_t
modifier|*
name|rdataset
parameter_list|,
name|dns_name_t
modifier|*
name|owner_name
parameter_list|,
name|dns_compress_t
modifier|*
name|cctx
parameter_list|,
name|isc_buffer_t
modifier|*
name|target
parameter_list|,
name|unsigned
name|int
name|options
parameter_list|,
name|unsigned
name|int
modifier|*
name|countp
parameter_list|)
block|{
return|return
operator|(
name|towiresorted
argument_list|(
name|rdataset
argument_list|,
name|owner_name
argument_list|,
name|cctx
argument_list|,
name|target
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|ISC_FALSE
argument_list|,
name|options
argument_list|,
name|countp
argument_list|,
name|NULL
argument_list|)
operator|)
return|;
block|}
end_function

begin_function
name|isc_result_t
name|dns_rdataset_additionaldata
parameter_list|(
name|dns_rdataset_t
modifier|*
name|rdataset
parameter_list|,
name|dns_additionaldatafunc_t
name|add
parameter_list|,
name|void
modifier|*
name|arg
parameter_list|)
block|{
name|dns_rdata_t
name|rdata
init|=
name|DNS_RDATA_INIT
decl_stmt|;
name|isc_result_t
name|result
decl_stmt|;
comment|/* 	 * For each rdata in rdataset, call 'add' for each name and type in the 	 * rdata which is subject to additional section processing. 	 */
name|REQUIRE
argument_list|(
name|DNS_RDATASET_VALID
argument_list|(
name|rdataset
argument_list|)
argument_list|)
expr_stmt|;
name|REQUIRE
argument_list|(
operator|(
name|rdataset
operator|->
name|attributes
operator|&
name|DNS_RDATASETATTR_QUESTION
operator|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|result
operator|=
name|dns_rdataset_first
argument_list|(
name|rdataset
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
return|return
operator|(
name|result
operator|)
return|;
do|do
block|{
name|dns_rdataset_current
argument_list|(
name|rdataset
argument_list|,
operator|&
name|rdata
argument_list|)
expr_stmt|;
name|result
operator|=
name|dns_rdata_additionaldata
argument_list|(
operator|&
name|rdata
argument_list|,
name|add
argument_list|,
name|arg
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|==
name|ISC_R_SUCCESS
condition|)
name|result
operator|=
name|dns_rdataset_next
argument_list|(
name|rdataset
argument_list|)
expr_stmt|;
name|dns_rdata_reset
argument_list|(
operator|&
name|rdata
argument_list|)
expr_stmt|;
block|}
do|while
condition|(
name|result
operator|==
name|ISC_R_SUCCESS
condition|)
do|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_NOMORE
condition|)
return|return
operator|(
name|result
operator|)
return|;
return|return
operator|(
name|ISC_R_SUCCESS
operator|)
return|;
block|}
end_function

begin_function
name|isc_result_t
name|dns_rdataset_addnoqname
parameter_list|(
name|dns_rdataset_t
modifier|*
name|rdataset
parameter_list|,
name|dns_name_t
modifier|*
name|name
parameter_list|)
block|{
name|REQUIRE
argument_list|(
name|DNS_RDATASET_VALID
argument_list|(
name|rdataset
argument_list|)
argument_list|)
expr_stmt|;
name|REQUIRE
argument_list|(
name|rdataset
operator|->
name|methods
operator|!=
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|rdataset
operator|->
name|methods
operator|->
name|addnoqname
operator|==
name|NULL
condition|)
return|return
operator|(
name|ISC_R_NOTIMPLEMENTED
operator|)
return|;
return|return
operator|(
call|(
name|rdataset
operator|->
name|methods
operator|->
name|addnoqname
call|)
argument_list|(
name|rdataset
argument_list|,
name|name
argument_list|)
operator|)
return|;
block|}
end_function

begin_function
name|isc_result_t
name|dns_rdataset_getnoqname
parameter_list|(
name|dns_rdataset_t
modifier|*
name|rdataset
parameter_list|,
name|dns_name_t
modifier|*
name|name
parameter_list|,
name|dns_rdataset_t
modifier|*
name|nsec
parameter_list|,
name|dns_rdataset_t
modifier|*
name|nsecsig
parameter_list|)
block|{
name|REQUIRE
argument_list|(
name|DNS_RDATASET_VALID
argument_list|(
name|rdataset
argument_list|)
argument_list|)
expr_stmt|;
name|REQUIRE
argument_list|(
name|rdataset
operator|->
name|methods
operator|!=
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|rdataset
operator|->
name|methods
operator|->
name|getnoqname
operator|==
name|NULL
condition|)
return|return
operator|(
name|ISC_R_NOTIMPLEMENTED
operator|)
return|;
return|return
operator|(
call|(
name|rdataset
operator|->
name|methods
operator|->
name|getnoqname
call|)
argument_list|(
name|rdataset
argument_list|,
name|name
argument_list|,
name|nsec
argument_list|,
name|nsecsig
argument_list|)
operator|)
return|;
block|}
end_function

end_unit


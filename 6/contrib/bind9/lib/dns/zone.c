begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Copyright (C) 2004-2007  Internet Systems Consortium, Inc. ("ISC")  * Copyright (C) 1999-2003  Internet Software Consortium.  *  * Permission to use, copy, modify, and/or distribute this software for any  * purpose with or without fee is hereby granted, provided that the above  * copyright notice and this permission notice appear in all copies.  *  * THE SOFTWARE IS PROVIDED "AS IS" AND ISC DISCLAIMS ALL WARRANTIES WITH  * REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF MERCHANTABILITY  * AND FITNESS.  IN NO EVENT SHALL ISC BE LIABLE FOR ANY SPECIAL, DIRECT,  * INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM  * LOSS OF USE, DATA OR PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE  * OR OTHER TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR  * PERFORMANCE OF THIS SOFTWARE.  */
end_comment

begin_comment
comment|/* $Id: zone.c,v 1.333.2.23.2.73 2007/12/02 22:31:33 marka Exp $ */
end_comment

begin_include
include|#
directive|include
file|<config.h>
end_include

begin_include
include|#
directive|include
file|<isc/file.h>
end_include

begin_include
include|#
directive|include
file|<isc/mutex.h>
end_include

begin_include
include|#
directive|include
file|<isc/print.h>
end_include

begin_include
include|#
directive|include
file|<isc/random.h>
end_include

begin_include
include|#
directive|include
file|<isc/ratelimiter.h>
end_include

begin_include
include|#
directive|include
file|<isc/refcount.h>
end_include

begin_include
include|#
directive|include
file|<isc/serial.h>
end_include

begin_include
include|#
directive|include
file|<isc/string.h>
end_include

begin_include
include|#
directive|include
file|<isc/taskpool.h>
end_include

begin_include
include|#
directive|include
file|<isc/timer.h>
end_include

begin_include
include|#
directive|include
file|<isc/util.h>
end_include

begin_include
include|#
directive|include
file|<dns/acl.h>
end_include

begin_include
include|#
directive|include
file|<dns/adb.h>
end_include

begin_include
include|#
directive|include
file|<dns/callbacks.h>
end_include

begin_include
include|#
directive|include
file|<dns/db.h>
end_include

begin_include
include|#
directive|include
file|<dns/events.h>
end_include

begin_include
include|#
directive|include
file|<dns/journal.h>
end_include

begin_include
include|#
directive|include
file|<dns/log.h>
end_include

begin_include
include|#
directive|include
file|<dns/master.h>
end_include

begin_include
include|#
directive|include
file|<dns/masterdump.h>
end_include

begin_include
include|#
directive|include
file|<dns/message.h>
end_include

begin_include
include|#
directive|include
file|<dns/name.h>
end_include

begin_include
include|#
directive|include
file|<dns/peer.h>
end_include

begin_include
include|#
directive|include
file|<dns/rcode.h>
end_include

begin_include
include|#
directive|include
file|<dns/rdataclass.h>
end_include

begin_include
include|#
directive|include
file|<dns/rdatalist.h>
end_include

begin_include
include|#
directive|include
file|<dns/rdataset.h>
end_include

begin_include
include|#
directive|include
file|<dns/rdatastruct.h>
end_include

begin_include
include|#
directive|include
file|<dns/rdatatype.h>
end_include

begin_include
include|#
directive|include
file|<dns/request.h>
end_include

begin_include
include|#
directive|include
file|<dns/resolver.h>
end_include

begin_include
include|#
directive|include
file|<dns/result.h>
end_include

begin_include
include|#
directive|include
file|<dns/stats.h>
end_include

begin_include
include|#
directive|include
file|<dns/ssu.h>
end_include

begin_include
include|#
directive|include
file|<dns/tsig.h>
end_include

begin_include
include|#
directive|include
file|<dns/xfrin.h>
end_include

begin_include
include|#
directive|include
file|<dns/zone.h>
end_include

begin_define
define|#
directive|define
name|ZONE_MAGIC
value|ISC_MAGIC('Z', 'O', 'N', 'E')
end_define

begin_define
define|#
directive|define
name|DNS_ZONE_VALID
parameter_list|(
name|zone
parameter_list|)
value|ISC_MAGIC_VALID(zone, ZONE_MAGIC)
end_define

begin_define
define|#
directive|define
name|NOTIFY_MAGIC
value|ISC_MAGIC('N', 't', 'f', 'y')
end_define

begin_define
define|#
directive|define
name|DNS_NOTIFY_VALID
parameter_list|(
name|notify
parameter_list|)
value|ISC_MAGIC_VALID(notify, NOTIFY_MAGIC)
end_define

begin_define
define|#
directive|define
name|STUB_MAGIC
value|ISC_MAGIC('S', 't', 'u', 'b')
end_define

begin_define
define|#
directive|define
name|DNS_STUB_VALID
parameter_list|(
name|stub
parameter_list|)
value|ISC_MAGIC_VALID(stub, STUB_MAGIC)
end_define

begin_define
define|#
directive|define
name|ZONEMGR_MAGIC
value|ISC_MAGIC('Z', 'm', 'g', 'r')
end_define

begin_define
define|#
directive|define
name|DNS_ZONEMGR_VALID
parameter_list|(
name|stub
parameter_list|)
value|ISC_MAGIC_VALID(stub, ZONEMGR_MAGIC)
end_define

begin_define
define|#
directive|define
name|LOAD_MAGIC
value|ISC_MAGIC('L', 'o', 'a', 'd')
end_define

begin_define
define|#
directive|define
name|DNS_LOAD_VALID
parameter_list|(
name|load
parameter_list|)
value|ISC_MAGIC_VALID(load, LOAD_MAGIC)
end_define

begin_define
define|#
directive|define
name|FORWARD_MAGIC
value|ISC_MAGIC('F', 'o', 'r', 'w')
end_define

begin_define
define|#
directive|define
name|DNS_FORWARD_VALID
parameter_list|(
name|load
parameter_list|)
value|ISC_MAGIC_VALID(load, FORWARD_MAGIC)
end_define

begin_define
define|#
directive|define
name|IO_MAGIC
value|ISC_MAGIC('Z', 'm', 'I', 'O')
end_define

begin_define
define|#
directive|define
name|DNS_IO_VALID
parameter_list|(
name|load
parameter_list|)
value|ISC_MAGIC_VALID(load, IO_MAGIC)
end_define

begin_comment
comment|/*  * Ensure 'a' is at least 'min' but not more than 'max'.  */
end_comment

begin_define
define|#
directive|define
name|RANGE
parameter_list|(
name|a
parameter_list|,
name|min
parameter_list|,
name|max
parameter_list|)
define|\
value|(((a)< (min)) ? (min) : ((a)< (max) ? (a) : (max)))
end_define

begin_comment
comment|/*  * Default values.  */
end_comment

begin_define
define|#
directive|define
name|DNS_DEFAULT_IDLEIN
value|3600
end_define

begin_comment
comment|/* 1 hour */
end_comment

begin_define
define|#
directive|define
name|DNS_DEFAULT_IDLEOUT
value|3600
end_define

begin_comment
comment|/* 1 hour */
end_comment

begin_define
define|#
directive|define
name|MAX_XFER_TIME
value|(2*3600)
end_define

begin_comment
comment|/* Documented default is 2 hours */
end_comment

begin_ifndef
ifndef|#
directive|ifndef
name|DNS_MAX_EXPIRE
end_ifndef

begin_define
define|#
directive|define
name|DNS_MAX_EXPIRE
value|14515200
end_define

begin_comment
comment|/* 24 weeks */
end_comment

begin_endif
endif|#
directive|endif
end_endif

begin_ifndef
ifndef|#
directive|ifndef
name|DNS_DUMP_DELAY
end_ifndef

begin_define
define|#
directive|define
name|DNS_DUMP_DELAY
value|900
end_define

begin_comment
comment|/* 15 minutes */
end_comment

begin_endif
endif|#
directive|endif
end_endif

begin_typedef
typedef|typedef
name|struct
name|dns_notify
name|dns_notify_t
typedef|;
end_typedef

begin_typedef
typedef|typedef
name|struct
name|dns_stub
name|dns_stub_t
typedef|;
end_typedef

begin_typedef
typedef|typedef
name|struct
name|dns_load
name|dns_load_t
typedef|;
end_typedef

begin_typedef
typedef|typedef
name|struct
name|dns_forward
name|dns_forward_t
typedef|;
end_typedef

begin_typedef
typedef|typedef
name|struct
name|dns_io
name|dns_io_t
typedef|;
end_typedef

begin_typedef
typedef|typedef
name|ISC_LIST
argument_list|(
argument|dns_io_t
argument_list|)
name|dns_iolist_t
expr_stmt|;
end_typedef

begin_define
define|#
directive|define
name|DNS_ZONE_CHECKLOCK
end_define

begin_ifdef
ifdef|#
directive|ifdef
name|DNS_ZONE_CHECKLOCK
end_ifdef

begin_define
define|#
directive|define
name|LOCK_ZONE
parameter_list|(
name|z
parameter_list|)
define|\
value|do { LOCK(&(z)->lock); \ 	      INSIST((z)->locked == ISC_FALSE); \ 	     (z)->locked = ISC_TRUE; \ 		} while (0)
end_define

begin_define
define|#
directive|define
name|UNLOCK_ZONE
parameter_list|(
name|z
parameter_list|)
define|\
value|do { (z)->locked = ISC_FALSE; UNLOCK(&(z)->lock); } while (0)
end_define

begin_define
define|#
directive|define
name|LOCKED_ZONE
parameter_list|(
name|z
parameter_list|)
value|((z)->locked)
end_define

begin_else
else|#
directive|else
end_else

begin_define
define|#
directive|define
name|LOCK_ZONE
parameter_list|(
name|z
parameter_list|)
value|LOCK(&(z)->lock)
end_define

begin_define
define|#
directive|define
name|UNLOCK_ZONE
parameter_list|(
name|z
parameter_list|)
value|UNLOCK(&(z)->lock)
end_define

begin_define
define|#
directive|define
name|LOCKED_ZONE
parameter_list|(
name|z
parameter_list|)
value|ISC_TRUE
end_define

begin_endif
endif|#
directive|endif
end_endif

begin_struct
struct|struct
name|dns_zone
block|{
comment|/* Unlocked */
name|unsigned
name|int
name|magic
decl_stmt|;
name|isc_mutex_t
name|lock
decl_stmt|;
ifdef|#
directive|ifdef
name|DNS_ZONE_CHECKLOCK
name|isc_boolean_t
name|locked
decl_stmt|;
endif|#
directive|endif
name|isc_mem_t
modifier|*
name|mctx
decl_stmt|;
name|isc_refcount_t
name|erefs
decl_stmt|;
comment|/* Locked */
name|dns_db_t
modifier|*
name|db
decl_stmt|;
name|dns_zonemgr_t
modifier|*
name|zmgr
decl_stmt|;
name|ISC_LINK
argument_list|(
argument|dns_zone_t
argument_list|)
name|link
expr_stmt|;
comment|/* Used by zmgr. */
name|isc_timer_t
modifier|*
name|timer
decl_stmt|;
name|unsigned
name|int
name|irefs
decl_stmt|;
name|dns_name_t
name|origin
decl_stmt|;
name|char
modifier|*
name|masterfile
decl_stmt|;
name|char
modifier|*
name|journal
decl_stmt|;
name|isc_int32_t
name|journalsize
decl_stmt|;
name|dns_rdataclass_t
name|rdclass
decl_stmt|;
name|dns_zonetype_t
name|type
decl_stmt|;
name|unsigned
name|int
name|flags
decl_stmt|;
name|unsigned
name|int
name|options
decl_stmt|;
name|unsigned
name|int
name|db_argc
decl_stmt|;
name|char
modifier|*
modifier|*
name|db_argv
decl_stmt|;
name|isc_time_t
name|expiretime
decl_stmt|;
name|isc_time_t
name|refreshtime
decl_stmt|;
name|isc_time_t
name|dumptime
decl_stmt|;
name|isc_time_t
name|loadtime
decl_stmt|;
name|isc_uint32_t
name|serial
decl_stmt|;
name|isc_uint32_t
name|refresh
decl_stmt|;
name|isc_uint32_t
name|retry
decl_stmt|;
name|isc_uint32_t
name|expire
decl_stmt|;
name|isc_uint32_t
name|minimum
decl_stmt|;
name|char
modifier|*
name|keydirectory
decl_stmt|;
name|isc_uint32_t
name|maxrefresh
decl_stmt|;
name|isc_uint32_t
name|minrefresh
decl_stmt|;
name|isc_uint32_t
name|maxretry
decl_stmt|;
name|isc_uint32_t
name|minretry
decl_stmt|;
name|isc_sockaddr_t
modifier|*
name|masters
decl_stmt|;
name|dns_name_t
modifier|*
modifier|*
name|masterkeynames
decl_stmt|;
name|isc_boolean_t
modifier|*
name|mastersok
decl_stmt|;
name|unsigned
name|int
name|masterscnt
decl_stmt|;
name|unsigned
name|int
name|curmaster
decl_stmt|;
name|isc_sockaddr_t
name|masteraddr
decl_stmt|;
name|dns_notifytype_t
name|notifytype
decl_stmt|;
name|isc_sockaddr_t
modifier|*
name|notify
decl_stmt|;
name|unsigned
name|int
name|notifycnt
decl_stmt|;
name|isc_sockaddr_t
name|notifyfrom
decl_stmt|;
name|isc_task_t
modifier|*
name|task
decl_stmt|;
name|isc_sockaddr_t
name|notifysrc4
decl_stmt|;
name|isc_sockaddr_t
name|notifysrc6
decl_stmt|;
name|isc_sockaddr_t
name|xfrsource4
decl_stmt|;
name|isc_sockaddr_t
name|xfrsource6
decl_stmt|;
name|isc_sockaddr_t
name|altxfrsource4
decl_stmt|;
name|isc_sockaddr_t
name|altxfrsource6
decl_stmt|;
name|isc_sockaddr_t
name|sourceaddr
decl_stmt|;
name|dns_xfrin_ctx_t
modifier|*
name|xfr
decl_stmt|;
comment|/* task locked */
name|dns_tsigkey_t
modifier|*
name|tsigkey
decl_stmt|;
comment|/* key used for xfr */
comment|/* Access Control Lists */
name|dns_acl_t
modifier|*
name|update_acl
decl_stmt|;
name|dns_acl_t
modifier|*
name|forward_acl
decl_stmt|;
name|dns_acl_t
modifier|*
name|notify_acl
decl_stmt|;
name|dns_acl_t
modifier|*
name|query_acl
decl_stmt|;
name|dns_acl_t
modifier|*
name|xfr_acl
decl_stmt|;
name|isc_boolean_t
name|update_disabled
decl_stmt|;
name|dns_severity_t
name|check_names
decl_stmt|;
name|ISC_LIST
argument_list|(
argument|dns_notify_t
argument_list|)
name|notifies
expr_stmt|;
name|dns_request_t
modifier|*
name|request
decl_stmt|;
name|dns_loadctx_t
modifier|*
name|lctx
decl_stmt|;
name|dns_io_t
modifier|*
name|readio
decl_stmt|;
name|dns_dumpctx_t
modifier|*
name|dctx
decl_stmt|;
name|dns_io_t
modifier|*
name|writeio
decl_stmt|;
name|isc_uint32_t
name|maxxfrin
decl_stmt|;
name|isc_uint32_t
name|maxxfrout
decl_stmt|;
name|isc_uint32_t
name|idlein
decl_stmt|;
name|isc_uint32_t
name|idleout
decl_stmt|;
name|isc_event_t
name|ctlevent
decl_stmt|;
name|dns_ssutable_t
modifier|*
name|ssutable
decl_stmt|;
name|isc_uint32_t
name|sigvalidityinterval
decl_stmt|;
name|dns_view_t
modifier|*
name|view
decl_stmt|;
comment|/* 	 * Zones in certain states such as "waiting for zone transfer" 	 * or "zone transfer in progress" are kept on per-state linked lists 	 * in the zone manager using the 'statelink' field.  The 'statelist' 	 * field points at the list the zone is currently on.  It the zone 	 * is not on any such list, statelist is NULL. 	 */
name|ISC_LINK
argument_list|(
argument|dns_zone_t
argument_list|)
name|statelink
expr_stmt|;
name|dns_zonelist_t
modifier|*
name|statelist
decl_stmt|;
comment|/* 	 * Optional per-zone statistics counters (NULL if not present). 	 */
name|isc_uint64_t
modifier|*
name|counters
decl_stmt|;
comment|/*% 	 * Serial number for deferred journal compaction. 	 */
name|isc_uint32_t
name|compact_serial
decl_stmt|;
block|}
struct|;
end_struct

begin_define
define|#
directive|define
name|DNS_ZONE_FLAG
parameter_list|(
name|z
parameter_list|,
name|f
parameter_list|)
value|(ISC_TF(((z)->flags& (f)) != 0))
end_define

begin_define
define|#
directive|define
name|DNS_ZONE_SETFLAG
parameter_list|(
name|z
parameter_list|,
name|f
parameter_list|)
value|do { \ 		INSIST(LOCKED_ZONE(z)); \ 		(z)->flags |= (f); \ 		} while (0)
end_define

begin_define
define|#
directive|define
name|DNS_ZONE_CLRFLAG
parameter_list|(
name|z
parameter_list|,
name|f
parameter_list|)
value|do { \ 		INSIST(LOCKED_ZONE(z)); \ 		(z)->flags&= ~(f); \ 		} while (0)
end_define

begin_comment
comment|/* XXX MPA these may need to go back into zone.h */
end_comment

begin_define
define|#
directive|define
name|DNS_ZONEFLG_REFRESH
value|0x00000001U
end_define

begin_comment
comment|/* refresh check in progress */
end_comment

begin_define
define|#
directive|define
name|DNS_ZONEFLG_NEEDDUMP
value|0x00000002U
end_define

begin_comment
comment|/* zone need consolidation */
end_comment

begin_define
define|#
directive|define
name|DNS_ZONEFLG_USEVC
value|0x00000004U
end_define

begin_comment
comment|/* use tcp for refresh query */
end_comment

begin_define
define|#
directive|define
name|DNS_ZONEFLG_DUMPING
value|0x00000008U
end_define

begin_comment
comment|/* a dump is in progress */
end_comment

begin_define
define|#
directive|define
name|DNS_ZONEFLG_HASINCLUDE
value|0x00000010U
end_define

begin_comment
comment|/* $INCLUDE in zone file */
end_comment

begin_define
define|#
directive|define
name|DNS_ZONEFLG_LOADED
value|0x00000020U
end_define

begin_comment
comment|/* database has loaded */
end_comment

begin_define
define|#
directive|define
name|DNS_ZONEFLG_EXITING
value|0x00000040U
end_define

begin_comment
comment|/* zone is being destroyed */
end_comment

begin_define
define|#
directive|define
name|DNS_ZONEFLG_EXPIRED
value|0x00000080U
end_define

begin_comment
comment|/* zone has expired */
end_comment

begin_define
define|#
directive|define
name|DNS_ZONEFLG_NEEDREFRESH
value|0x00000100U
end_define

begin_comment
comment|/* refresh check needed */
end_comment

begin_define
define|#
directive|define
name|DNS_ZONEFLG_UPTODATE
value|0x00000200U
end_define

begin_comment
comment|/* zone contents are 						 * uptodate */
end_comment

begin_define
define|#
directive|define
name|DNS_ZONEFLG_NEEDNOTIFY
value|0x00000400U
end_define

begin_comment
comment|/* need to send out notify 						 * messages */
end_comment

begin_define
define|#
directive|define
name|DNS_ZONEFLG_DIFFONRELOAD
value|0x00000800U
end_define

begin_comment
comment|/* generate a journal diff on 						 * reload */
end_comment

begin_define
define|#
directive|define
name|DNS_ZONEFLG_NOMASTERS
value|0x00001000U
end_define

begin_comment
comment|/* an attempt to refresh a 						 * zone with no masters 						 * occured */
end_comment

begin_define
define|#
directive|define
name|DNS_ZONEFLG_LOADING
value|0x00002000U
end_define

begin_comment
comment|/* load from disk in progress*/
end_comment

begin_define
define|#
directive|define
name|DNS_ZONEFLG_HAVETIMERS
value|0x00004000U
end_define

begin_comment
comment|/* timer values have been set 						 * from SOA (if not set, we 						 * are still using 						 * default timer values) */
end_comment

begin_define
define|#
directive|define
name|DNS_ZONEFLG_FORCEXFER
value|0x00008000U
end_define

begin_comment
comment|/* Force a zone xfer */
end_comment

begin_define
define|#
directive|define
name|DNS_ZONEFLG_NOREFRESH
value|0x00010000U
end_define

begin_define
define|#
directive|define
name|DNS_ZONEFLG_DIALNOTIFY
value|0x00020000U
end_define

begin_define
define|#
directive|define
name|DNS_ZONEFLG_DIALREFRESH
value|0x00040000U
end_define

begin_define
define|#
directive|define
name|DNS_ZONEFLG_SHUTDOWN
value|0x00080000U
end_define

begin_define
define|#
directive|define
name|DNS_ZONEFLAG_NOIXFR
value|0x00100000U
end_define

begin_comment
comment|/* IXFR failed, force AXFR */
end_comment

begin_define
define|#
directive|define
name|DNS_ZONEFLG_FLUSH
value|0x00200000U
end_define

begin_define
define|#
directive|define
name|DNS_ZONEFLG_NOEDNS
value|0x00400000U
end_define

begin_define
define|#
directive|define
name|DNS_ZONEFLG_USEALTXFRSRC
value|0x00800000U
end_define

begin_define
define|#
directive|define
name|DNS_ZONEFLG_SOABEFOREAXFR
value|0x01000000U
end_define

begin_define
define|#
directive|define
name|DNS_ZONEFLG_NEEDCOMPACT
value|0x02000000U
end_define

begin_define
define|#
directive|define
name|DNS_ZONE_OPTION
parameter_list|(
name|z
parameter_list|,
name|o
parameter_list|)
value|(((z)->options& (o)) != 0)
end_define

begin_comment
comment|/* Flags for zone_load() */
end_comment

begin_define
define|#
directive|define
name|DNS_ZONELOADFLAG_NOSTAT
value|0x00000001U
end_define

begin_comment
comment|/* Do not stat() master files */
end_comment

begin_struct
struct|struct
name|dns_zonemgr
block|{
name|unsigned
name|int
name|magic
decl_stmt|;
name|isc_mem_t
modifier|*
name|mctx
decl_stmt|;
name|int
name|refs
decl_stmt|;
comment|/* Locked by rwlock */
name|isc_taskmgr_t
modifier|*
name|taskmgr
decl_stmt|;
name|isc_timermgr_t
modifier|*
name|timermgr
decl_stmt|;
name|isc_socketmgr_t
modifier|*
name|socketmgr
decl_stmt|;
name|isc_taskpool_t
modifier|*
name|zonetasks
decl_stmt|;
name|isc_task_t
modifier|*
name|task
decl_stmt|;
name|isc_ratelimiter_t
modifier|*
name|rl
decl_stmt|;
name|isc_rwlock_t
name|rwlock
decl_stmt|;
name|isc_mutex_t
name|iolock
decl_stmt|;
comment|/* Locked by rwlock. */
name|dns_zonelist_t
name|zones
decl_stmt|;
name|dns_zonelist_t
name|waiting_for_xfrin
decl_stmt|;
name|dns_zonelist_t
name|xfrin_in_progress
decl_stmt|;
comment|/* Configuration data. */
name|isc_uint32_t
name|transfersin
decl_stmt|;
name|isc_uint32_t
name|transfersperns
decl_stmt|;
name|unsigned
name|int
name|serialqueryrate
decl_stmt|;
comment|/* Locked by iolock */
name|isc_uint32_t
name|iolimit
decl_stmt|;
name|isc_uint32_t
name|ioactive
decl_stmt|;
name|dns_iolist_t
name|high
decl_stmt|;
name|dns_iolist_t
name|low
decl_stmt|;
block|}
struct|;
end_struct

begin_comment
comment|/*  * Hold notify state.  */
end_comment

begin_struct
struct|struct
name|dns_notify
block|{
name|unsigned
name|int
name|magic
decl_stmt|;
name|unsigned
name|int
name|flags
decl_stmt|;
name|isc_mem_t
modifier|*
name|mctx
decl_stmt|;
name|dns_zone_t
modifier|*
name|zone
decl_stmt|;
name|dns_adbfind_t
modifier|*
name|find
decl_stmt|;
name|dns_request_t
modifier|*
name|request
decl_stmt|;
name|dns_name_t
name|ns
decl_stmt|;
name|isc_sockaddr_t
name|dst
decl_stmt|;
name|ISC_LINK
argument_list|(
argument|dns_notify_t
argument_list|)
name|link
expr_stmt|;
block|}
struct|;
end_struct

begin_define
define|#
directive|define
name|DNS_NOTIFY_NOSOA
value|0x0001U
end_define

begin_comment
comment|/*  *	dns_stub holds state while performing a 'stub' transfer.  *	'db' is the zone's 'db' or a new one if this is the initial  *	transfer.  */
end_comment

begin_struct
struct|struct
name|dns_stub
block|{
name|unsigned
name|int
name|magic
decl_stmt|;
name|isc_mem_t
modifier|*
name|mctx
decl_stmt|;
name|dns_zone_t
modifier|*
name|zone
decl_stmt|;
name|dns_db_t
modifier|*
name|db
decl_stmt|;
name|dns_dbversion_t
modifier|*
name|version
decl_stmt|;
block|}
struct|;
end_struct

begin_comment
comment|/*  *	Hold load state.  */
end_comment

begin_struct
struct|struct
name|dns_load
block|{
name|unsigned
name|int
name|magic
decl_stmt|;
name|isc_mem_t
modifier|*
name|mctx
decl_stmt|;
name|dns_zone_t
modifier|*
name|zone
decl_stmt|;
name|dns_db_t
modifier|*
name|db
decl_stmt|;
name|isc_time_t
name|loadtime
decl_stmt|;
name|dns_rdatacallbacks_t
name|callbacks
decl_stmt|;
block|}
struct|;
end_struct

begin_comment
comment|/*  *	Hold forward state.  */
end_comment

begin_struct
struct|struct
name|dns_forward
block|{
name|unsigned
name|int
name|magic
decl_stmt|;
name|isc_mem_t
modifier|*
name|mctx
decl_stmt|;
name|dns_zone_t
modifier|*
name|zone
decl_stmt|;
name|isc_buffer_t
modifier|*
name|msgbuf
decl_stmt|;
name|dns_request_t
modifier|*
name|request
decl_stmt|;
name|isc_uint32_t
name|which
decl_stmt|;
name|isc_sockaddr_t
name|addr
decl_stmt|;
name|dns_updatecallback_t
name|callback
decl_stmt|;
name|void
modifier|*
name|callback_arg
decl_stmt|;
block|}
struct|;
end_struct

begin_comment
comment|/*  *	Hold IO request state.  */
end_comment

begin_struct
struct|struct
name|dns_io
block|{
name|unsigned
name|int
name|magic
decl_stmt|;
name|dns_zonemgr_t
modifier|*
name|zmgr
decl_stmt|;
name|isc_boolean_t
name|high
decl_stmt|;
name|isc_task_t
modifier|*
name|task
decl_stmt|;
name|ISC_LINK
argument_list|(
argument|dns_io_t
argument_list|)
name|link
expr_stmt|;
name|isc_event_t
modifier|*
name|event
decl_stmt|;
block|}
struct|;
end_struct

begin_define
define|#
directive|define
name|SEND_BUFFER_SIZE
value|2048
end_define

begin_function_decl
specifier|static
name|void
name|zone_settimer
parameter_list|(
name|dns_zone_t
modifier|*
parameter_list|,
name|isc_time_t
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|cancel_refresh
parameter_list|(
name|dns_zone_t
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|zone_debuglog
parameter_list|(
name|dns_zone_t
modifier|*
name|zone
parameter_list|,
specifier|const
name|char
modifier|*
parameter_list|,
name|int
name|debuglevel
parameter_list|,
specifier|const
name|char
modifier|*
name|msg
parameter_list|,
modifier|...
parameter_list|)
function_decl|ISC_FORMAT_PRINTF
parameter_list|(
function_decl|4
operator|,
function_decl|5
end_function_decl

begin_empty_stmt
unit|)
empty_stmt|;
end_empty_stmt

begin_function_decl
specifier|static
name|void
name|notify_log
parameter_list|(
name|dns_zone_t
modifier|*
name|zone
parameter_list|,
name|int
name|level
parameter_list|,
specifier|const
name|char
modifier|*
name|fmt
parameter_list|,
modifier|...
parameter_list|)
function_decl|ISC_FORMAT_PRINTF
parameter_list|(
function_decl|3
operator|,
function_decl|4
end_function_decl

begin_empty_stmt
unit|)
empty_stmt|;
end_empty_stmt

begin_function_decl
specifier|static
name|void
name|queue_xfrin
parameter_list|(
name|dns_zone_t
modifier|*
name|zone
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|zone_unload
parameter_list|(
name|dns_zone_t
modifier|*
name|zone
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|zone_expire
parameter_list|(
name|dns_zone_t
modifier|*
name|zone
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|zone_iattach
parameter_list|(
name|dns_zone_t
modifier|*
name|source
parameter_list|,
name|dns_zone_t
modifier|*
modifier|*
name|target
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|zone_idetach
parameter_list|(
name|dns_zone_t
modifier|*
modifier|*
name|zonep
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|isc_result_t
name|zone_replacedb
parameter_list|(
name|dns_zone_t
modifier|*
name|zone
parameter_list|,
name|dns_db_t
modifier|*
name|db
parameter_list|,
name|isc_boolean_t
name|dump
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|isc_result_t
name|default_journal
parameter_list|(
name|dns_zone_t
modifier|*
name|zone
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|zone_xfrdone
parameter_list|(
name|dns_zone_t
modifier|*
name|zone
parameter_list|,
name|isc_result_t
name|result
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|isc_result_t
name|zone_postload
parameter_list|(
name|dns_zone_t
modifier|*
name|zone
parameter_list|,
name|dns_db_t
modifier|*
name|db
parameter_list|,
name|isc_time_t
name|loadtime
parameter_list|,
name|isc_result_t
name|result
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|zone_needdump
parameter_list|(
name|dns_zone_t
modifier|*
name|zone
parameter_list|,
name|unsigned
name|int
name|delay
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|zone_shutdown
parameter_list|(
name|isc_task_t
modifier|*
parameter_list|,
name|isc_event_t
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|zone_loaddone
parameter_list|(
name|void
modifier|*
name|arg
parameter_list|,
name|isc_result_t
name|result
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|isc_result_t
name|zone_startload
parameter_list|(
name|dns_db_t
modifier|*
name|db
parameter_list|,
name|dns_zone_t
modifier|*
name|zone
parameter_list|,
name|isc_time_t
name|loadtime
parameter_list|)
function_decl|;
end_function_decl

begin_if
if|#
directive|if
literal|0
end_if

begin_comment
comment|/* ondestroy example */
end_comment

begin_endif
unit|static void dns_zonemgr_dbdestroyed(isc_task_t *task, isc_event_t *event);
endif|#
directive|endif
end_endif

begin_function_decl
specifier|static
name|void
name|refresh_callback
parameter_list|(
name|isc_task_t
modifier|*
parameter_list|,
name|isc_event_t
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|stub_callback
parameter_list|(
name|isc_task_t
modifier|*
parameter_list|,
name|isc_event_t
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|queue_soa_query
parameter_list|(
name|dns_zone_t
modifier|*
name|zone
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|soa_query
parameter_list|(
name|isc_task_t
modifier|*
parameter_list|,
name|isc_event_t
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|ns_query
parameter_list|(
name|dns_zone_t
modifier|*
name|zone
parameter_list|,
name|dns_rdataset_t
modifier|*
name|soardataset
parameter_list|,
name|dns_stub_t
modifier|*
name|stub
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|message_count
parameter_list|(
name|dns_message_t
modifier|*
name|msg
parameter_list|,
name|dns_section_t
name|section
parameter_list|,
name|dns_rdatatype_t
name|type
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|notify_cancel
parameter_list|(
name|dns_zone_t
modifier|*
name|zone
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|notify_find_address
parameter_list|(
name|dns_notify_t
modifier|*
name|notify
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|notify_send
parameter_list|(
name|dns_notify_t
modifier|*
name|notify
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|isc_result_t
name|notify_createmessage
parameter_list|(
name|dns_zone_t
modifier|*
name|zone
parameter_list|,
name|unsigned
name|int
name|flags
parameter_list|,
name|dns_message_t
modifier|*
modifier|*
name|messagep
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|notify_done
parameter_list|(
name|isc_task_t
modifier|*
name|task
parameter_list|,
name|isc_event_t
modifier|*
name|event
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|notify_send_toaddr
parameter_list|(
name|isc_task_t
modifier|*
name|task
parameter_list|,
name|isc_event_t
modifier|*
name|event
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|isc_result_t
name|zone_dump
parameter_list|(
name|dns_zone_t
modifier|*
parameter_list|,
name|isc_boolean_t
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|got_transfer_quota
parameter_list|(
name|isc_task_t
modifier|*
name|task
parameter_list|,
name|isc_event_t
modifier|*
name|event
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|isc_result_t
name|zmgr_start_xfrin_ifquota
parameter_list|(
name|dns_zonemgr_t
modifier|*
name|zmgr
parameter_list|,
name|dns_zone_t
modifier|*
name|zone
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|zmgr_resume_xfrs
parameter_list|(
name|dns_zonemgr_t
modifier|*
name|zmgr
parameter_list|,
name|isc_boolean_t
name|multi
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|zonemgr_free
parameter_list|(
name|dns_zonemgr_t
modifier|*
name|zmgr
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|isc_result_t
name|zonemgr_getio
parameter_list|(
name|dns_zonemgr_t
modifier|*
name|zmgr
parameter_list|,
name|isc_boolean_t
name|high
parameter_list|,
name|isc_task_t
modifier|*
name|task
parameter_list|,
name|isc_taskaction_t
name|action
parameter_list|,
name|void
modifier|*
name|arg
parameter_list|,
name|dns_io_t
modifier|*
modifier|*
name|iop
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|zonemgr_putio
parameter_list|(
name|dns_io_t
modifier|*
modifier|*
name|iop
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|zonemgr_cancelio
parameter_list|(
name|dns_io_t
modifier|*
name|io
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|isc_result_t
name|zone_get_from_db
parameter_list|(
name|dns_db_t
modifier|*
name|db
parameter_list|,
name|dns_name_t
modifier|*
name|origin
parameter_list|,
name|unsigned
name|int
modifier|*
name|nscount
parameter_list|,
name|unsigned
name|int
modifier|*
name|soacount
parameter_list|,
name|isc_uint32_t
modifier|*
name|serial
parameter_list|,
name|isc_uint32_t
modifier|*
name|refresh
parameter_list|,
name|isc_uint32_t
modifier|*
name|retry
parameter_list|,
name|isc_uint32_t
modifier|*
name|expire
parameter_list|,
name|isc_uint32_t
modifier|*
name|minimum
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|zone_freedbargs
parameter_list|(
name|dns_zone_t
modifier|*
name|zone
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|forward_callback
parameter_list|(
name|isc_task_t
modifier|*
name|task
parameter_list|,
name|isc_event_t
modifier|*
name|event
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|zone_saveunique
parameter_list|(
name|dns_zone_t
modifier|*
name|zone
parameter_list|,
specifier|const
name|char
modifier|*
name|path
parameter_list|,
specifier|const
name|char
modifier|*
name|templat
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|zone_maintenance
parameter_list|(
name|dns_zone_t
modifier|*
name|zone
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|zone_notify
parameter_list|(
name|dns_zone_t
modifier|*
name|zone
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|dump_done
parameter_list|(
name|void
modifier|*
name|arg
parameter_list|,
name|isc_result_t
name|result
parameter_list|)
function_decl|;
end_function_decl

begin_define
define|#
directive|define
name|ENTER
value|zone_debuglog(zone, me, 1, "enter")
end_define

begin_decl_stmt
specifier|static
specifier|const
name|unsigned
name|int
name|dbargc_default
init|=
literal|1
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
specifier|const
name|char
modifier|*
name|dbargv_default
index|[]
init|=
block|{
literal|"rbt"
block|}
decl_stmt|;
end_decl_stmt

begin_define
define|#
directive|define
name|DNS_ZONE_JITTER_ADD
parameter_list|(
name|a
parameter_list|,
name|b
parameter_list|,
name|c
parameter_list|)
define|\
value|do { \ 		isc_interval_t _i; \ 		isc_uint32_t _j; \ 		_j = isc_random_jitter((b), (b)/4); \ 		isc_interval_set(&_i, _j, 0); \ 		if (isc_time_add((a),&_i, (c)) != ISC_R_SUCCESS) { \ 			dns_zone_log(zone, ISC_LOG_WARNING, \ 				     "epoch approaching: upgrade required: " \ 				     "now + %s failed", #b); \ 			isc_interval_set(&_i, _j/2, 0); \ 			(void)isc_time_add((a),&_i, (c)); \ 		} \ 	} while (0)
end_define

begin_define
define|#
directive|define
name|DNS_ZONE_TIME_ADD
parameter_list|(
name|a
parameter_list|,
name|b
parameter_list|,
name|c
parameter_list|)
define|\
value|do { \ 		isc_interval_t _i; \ 		isc_interval_set(&_i, (b), 0); \ 		if (isc_time_add((a),&_i, (c)) != ISC_R_SUCCESS) { \ 			dns_zone_log(zone, ISC_LOG_WARNING, \ 				     "epoch approaching: upgrade required: " \ 				     "now + %s failed", #b); \ 			isc_interval_set(&_i, (b)/2, 0); \ 			(void)isc_time_add((a),&_i, (c)); \ 		} \ 	} while (0)
end_define

begin_comment
comment|/***  ***	Public functions.  ***/
end_comment

begin_function
name|isc_result_t
name|dns_zone_create
parameter_list|(
name|dns_zone_t
modifier|*
modifier|*
name|zonep
parameter_list|,
name|isc_mem_t
modifier|*
name|mctx
parameter_list|)
block|{
name|isc_result_t
name|result
decl_stmt|;
name|dns_zone_t
modifier|*
name|zone
decl_stmt|;
name|REQUIRE
argument_list|(
name|zonep
operator|!=
name|NULL
operator|&&
operator|*
name|zonep
operator|==
name|NULL
argument_list|)
expr_stmt|;
name|REQUIRE
argument_list|(
name|mctx
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|zone
operator|=
name|isc_mem_get
argument_list|(
name|mctx
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|zone
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|zone
operator|==
name|NULL
condition|)
return|return
operator|(
name|ISC_R_NOMEMORY
operator|)
return|;
name|result
operator|=
name|isc_mutex_init
argument_list|(
operator|&
name|zone
operator|->
name|lock
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
block|{
name|isc_mem_put
argument_list|(
name|mctx
argument_list|,
name|zone
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|zone
argument_list|)
argument_list|)
expr_stmt|;
name|UNEXPECTED_ERROR
argument_list|(
name|__FILE__
argument_list|,
name|__LINE__
argument_list|,
literal|"isc_mutex_init() failed: %s"
argument_list|,
name|isc_result_totext
argument_list|(
name|result
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|(
name|ISC_R_UNEXPECTED
operator|)
return|;
block|}
comment|/* XXX MPA check that all elements are initialised */
name|zone
operator|->
name|mctx
operator|=
name|NULL
expr_stmt|;
ifdef|#
directive|ifdef
name|DNS_ZONE_CHECKLOCK
name|zone
operator|->
name|locked
operator|=
name|ISC_FALSE
expr_stmt|;
endif|#
directive|endif
name|isc_mem_attach
argument_list|(
name|mctx
argument_list|,
operator|&
name|zone
operator|->
name|mctx
argument_list|)
expr_stmt|;
name|zone
operator|->
name|db
operator|=
name|NULL
expr_stmt|;
name|zone
operator|->
name|zmgr
operator|=
name|NULL
expr_stmt|;
name|ISC_LINK_INIT
argument_list|(
name|zone
argument_list|,
name|link
argument_list|)
expr_stmt|;
name|isc_refcount_init
argument_list|(
operator|&
name|zone
operator|->
name|erefs
argument_list|,
literal|1
argument_list|)
expr_stmt|;
comment|/* Implicit attach. */
name|zone
operator|->
name|irefs
operator|=
literal|0
expr_stmt|;
name|dns_name_init
argument_list|(
operator|&
name|zone
operator|->
name|origin
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|zone
operator|->
name|masterfile
operator|=
name|NULL
expr_stmt|;
name|zone
operator|->
name|keydirectory
operator|=
name|NULL
expr_stmt|;
name|zone
operator|->
name|journalsize
operator|=
operator|-
literal|1
expr_stmt|;
name|zone
operator|->
name|journal
operator|=
name|NULL
expr_stmt|;
name|zone
operator|->
name|rdclass
operator|=
name|dns_rdataclass_none
expr_stmt|;
name|zone
operator|->
name|type
operator|=
name|dns_zone_none
expr_stmt|;
name|zone
operator|->
name|flags
operator|=
literal|0
expr_stmt|;
name|zone
operator|->
name|options
operator|=
literal|0
expr_stmt|;
name|zone
operator|->
name|db_argc
operator|=
literal|0
expr_stmt|;
name|zone
operator|->
name|db_argv
operator|=
name|NULL
expr_stmt|;
name|isc_time_settoepoch
argument_list|(
operator|&
name|zone
operator|->
name|expiretime
argument_list|)
expr_stmt|;
name|isc_time_settoepoch
argument_list|(
operator|&
name|zone
operator|->
name|refreshtime
argument_list|)
expr_stmt|;
name|isc_time_settoepoch
argument_list|(
operator|&
name|zone
operator|->
name|dumptime
argument_list|)
expr_stmt|;
name|isc_time_settoepoch
argument_list|(
operator|&
name|zone
operator|->
name|loadtime
argument_list|)
expr_stmt|;
name|zone
operator|->
name|serial
operator|=
literal|0
expr_stmt|;
name|zone
operator|->
name|refresh
operator|=
name|DNS_ZONE_DEFAULTREFRESH
expr_stmt|;
name|zone
operator|->
name|retry
operator|=
name|DNS_ZONE_DEFAULTRETRY
expr_stmt|;
name|zone
operator|->
name|expire
operator|=
literal|0
expr_stmt|;
name|zone
operator|->
name|minimum
operator|=
literal|0
expr_stmt|;
name|zone
operator|->
name|maxrefresh
operator|=
name|DNS_ZONE_MAXREFRESH
expr_stmt|;
name|zone
operator|->
name|minrefresh
operator|=
name|DNS_ZONE_MINREFRESH
expr_stmt|;
name|zone
operator|->
name|maxretry
operator|=
name|DNS_ZONE_MAXRETRY
expr_stmt|;
name|zone
operator|->
name|minretry
operator|=
name|DNS_ZONE_MINRETRY
expr_stmt|;
name|zone
operator|->
name|masters
operator|=
name|NULL
expr_stmt|;
name|zone
operator|->
name|masterkeynames
operator|=
name|NULL
expr_stmt|;
name|zone
operator|->
name|mastersok
operator|=
name|NULL
expr_stmt|;
name|zone
operator|->
name|masterscnt
operator|=
literal|0
expr_stmt|;
name|zone
operator|->
name|curmaster
operator|=
literal|0
expr_stmt|;
name|zone
operator|->
name|notify
operator|=
name|NULL
expr_stmt|;
name|zone
operator|->
name|notifytype
operator|=
name|dns_notifytype_yes
expr_stmt|;
name|zone
operator|->
name|notifycnt
operator|=
literal|0
expr_stmt|;
name|zone
operator|->
name|task
operator|=
name|NULL
expr_stmt|;
name|zone
operator|->
name|update_acl
operator|=
name|NULL
expr_stmt|;
name|zone
operator|->
name|forward_acl
operator|=
name|NULL
expr_stmt|;
name|zone
operator|->
name|notify_acl
operator|=
name|NULL
expr_stmt|;
name|zone
operator|->
name|query_acl
operator|=
name|NULL
expr_stmt|;
name|zone
operator|->
name|xfr_acl
operator|=
name|NULL
expr_stmt|;
name|zone
operator|->
name|update_disabled
operator|=
name|ISC_FALSE
expr_stmt|;
name|zone
operator|->
name|check_names
operator|=
name|dns_severity_ignore
expr_stmt|;
name|zone
operator|->
name|request
operator|=
name|NULL
expr_stmt|;
name|zone
operator|->
name|lctx
operator|=
name|NULL
expr_stmt|;
name|zone
operator|->
name|readio
operator|=
name|NULL
expr_stmt|;
name|zone
operator|->
name|dctx
operator|=
name|NULL
expr_stmt|;
name|zone
operator|->
name|writeio
operator|=
name|NULL
expr_stmt|;
name|zone
operator|->
name|timer
operator|=
name|NULL
expr_stmt|;
name|zone
operator|->
name|idlein
operator|=
name|DNS_DEFAULT_IDLEIN
expr_stmt|;
name|zone
operator|->
name|idleout
operator|=
name|DNS_DEFAULT_IDLEOUT
expr_stmt|;
name|ISC_LIST_INIT
argument_list|(
name|zone
operator|->
name|notifies
argument_list|)
expr_stmt|;
name|isc_sockaddr_any
argument_list|(
operator|&
name|zone
operator|->
name|notifysrc4
argument_list|)
expr_stmt|;
name|isc_sockaddr_any6
argument_list|(
operator|&
name|zone
operator|->
name|notifysrc6
argument_list|)
expr_stmt|;
name|isc_sockaddr_any
argument_list|(
operator|&
name|zone
operator|->
name|xfrsource4
argument_list|)
expr_stmt|;
name|isc_sockaddr_any6
argument_list|(
operator|&
name|zone
operator|->
name|xfrsource6
argument_list|)
expr_stmt|;
name|isc_sockaddr_any
argument_list|(
operator|&
name|zone
operator|->
name|altxfrsource4
argument_list|)
expr_stmt|;
name|isc_sockaddr_any6
argument_list|(
operator|&
name|zone
operator|->
name|altxfrsource6
argument_list|)
expr_stmt|;
name|zone
operator|->
name|xfr
operator|=
name|NULL
expr_stmt|;
name|zone
operator|->
name|tsigkey
operator|=
name|NULL
expr_stmt|;
name|zone
operator|->
name|maxxfrin
operator|=
name|MAX_XFER_TIME
expr_stmt|;
name|zone
operator|->
name|maxxfrout
operator|=
name|MAX_XFER_TIME
expr_stmt|;
name|zone
operator|->
name|ssutable
operator|=
name|NULL
expr_stmt|;
name|zone
operator|->
name|sigvalidityinterval
operator|=
literal|30
operator|*
literal|24
operator|*
literal|3600
expr_stmt|;
name|zone
operator|->
name|view
operator|=
name|NULL
expr_stmt|;
name|ISC_LINK_INIT
argument_list|(
name|zone
argument_list|,
name|statelink
argument_list|)
expr_stmt|;
name|zone
operator|->
name|statelist
operator|=
name|NULL
expr_stmt|;
name|zone
operator|->
name|counters
operator|=
name|NULL
expr_stmt|;
name|zone
operator|->
name|magic
operator|=
name|ZONE_MAGIC
expr_stmt|;
comment|/* Must be after magic is set. */
name|result
operator|=
name|dns_zone_setdbtype
argument_list|(
name|zone
argument_list|,
name|dbargc_default
argument_list|,
name|dbargv_default
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
goto|goto
name|free_mutex
goto|;
name|ISC_EVENT_INIT
argument_list|(
operator|&
name|zone
operator|->
name|ctlevent
argument_list|,
sizeof|sizeof
argument_list|(
name|zone
operator|->
name|ctlevent
argument_list|)
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|,
name|DNS_EVENT_ZONECONTROL
argument_list|,
name|zone_shutdown
argument_list|,
name|zone
argument_list|,
name|zone
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
operator|*
name|zonep
operator|=
name|zone
expr_stmt|;
return|return
operator|(
name|ISC_R_SUCCESS
operator|)
return|;
name|free_mutex
label|:
name|DESTROYLOCK
argument_list|(
operator|&
name|zone
operator|->
name|lock
argument_list|)
expr_stmt|;
name|isc_mem_putanddetach
argument_list|(
operator|&
name|zone
operator|->
name|mctx
argument_list|,
name|zone
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|zone
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|(
name|result
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Free a zone.  Because we require that there be no more  * outstanding events or references, no locking is necessary.  */
end_comment

begin_function
specifier|static
name|void
name|zone_free
parameter_list|(
name|dns_zone_t
modifier|*
name|zone
parameter_list|)
block|{
name|isc_mem_t
modifier|*
name|mctx
init|=
name|NULL
decl_stmt|;
name|REQUIRE
argument_list|(
name|DNS_ZONE_VALID
argument_list|(
name|zone
argument_list|)
argument_list|)
expr_stmt|;
name|REQUIRE
argument_list|(
name|isc_refcount_current
argument_list|(
operator|&
name|zone
operator|->
name|erefs
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|REQUIRE
argument_list|(
name|zone
operator|->
name|irefs
operator|==
literal|0
argument_list|)
expr_stmt|;
name|REQUIRE
argument_list|(
operator|!
name|LOCKED_ZONE
argument_list|(
name|zone
argument_list|)
argument_list|)
expr_stmt|;
name|REQUIRE
argument_list|(
name|zone
operator|->
name|timer
operator|==
name|NULL
argument_list|)
expr_stmt|;
comment|/* 	 * Managed objects.  Order is important. 	 */
if|if
condition|(
name|zone
operator|->
name|request
operator|!=
name|NULL
condition|)
name|dns_request_destroy
argument_list|(
operator|&
name|zone
operator|->
name|request
argument_list|)
expr_stmt|;
comment|/* XXXMPA */
name|INSIST
argument_list|(
name|zone
operator|->
name|readio
operator|==
name|NULL
argument_list|)
expr_stmt|;
name|INSIST
argument_list|(
name|zone
operator|->
name|statelist
operator|==
name|NULL
argument_list|)
expr_stmt|;
name|INSIST
argument_list|(
name|zone
operator|->
name|writeio
operator|==
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|zone
operator|->
name|task
operator|!=
name|NULL
condition|)
name|isc_task_detach
argument_list|(
operator|&
name|zone
operator|->
name|task
argument_list|)
expr_stmt|;
if|if
condition|(
name|zone
operator|->
name|zmgr
condition|)
name|dns_zonemgr_releasezone
argument_list|(
name|zone
operator|->
name|zmgr
argument_list|,
name|zone
argument_list|)
expr_stmt|;
comment|/* Unmanaged objects */
if|if
condition|(
name|zone
operator|->
name|masterfile
operator|!=
name|NULL
condition|)
name|isc_mem_free
argument_list|(
name|zone
operator|->
name|mctx
argument_list|,
name|zone
operator|->
name|masterfile
argument_list|)
expr_stmt|;
name|zone
operator|->
name|masterfile
operator|=
name|NULL
expr_stmt|;
if|if
condition|(
name|zone
operator|->
name|keydirectory
operator|!=
name|NULL
condition|)
name|isc_mem_free
argument_list|(
name|zone
operator|->
name|mctx
argument_list|,
name|zone
operator|->
name|keydirectory
argument_list|)
expr_stmt|;
name|zone
operator|->
name|keydirectory
operator|=
name|NULL
expr_stmt|;
name|zone
operator|->
name|journalsize
operator|=
operator|-
literal|1
expr_stmt|;
if|if
condition|(
name|zone
operator|->
name|journal
operator|!=
name|NULL
condition|)
name|isc_mem_free
argument_list|(
name|zone
operator|->
name|mctx
argument_list|,
name|zone
operator|->
name|journal
argument_list|)
expr_stmt|;
name|zone
operator|->
name|journal
operator|=
name|NULL
expr_stmt|;
if|if
condition|(
name|zone
operator|->
name|counters
operator|!=
name|NULL
condition|)
name|dns_stats_freecounters
argument_list|(
name|zone
operator|->
name|mctx
argument_list|,
operator|&
name|zone
operator|->
name|counters
argument_list|)
expr_stmt|;
if|if
condition|(
name|zone
operator|->
name|db
operator|!=
name|NULL
condition|)
name|dns_db_detach
argument_list|(
operator|&
name|zone
operator|->
name|db
argument_list|)
expr_stmt|;
name|zone_freedbargs
argument_list|(
name|zone
argument_list|)
expr_stmt|;
name|RUNTIME_CHECK
argument_list|(
name|dns_zone_setmasterswithkeys
argument_list|(
name|zone
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
operator|==
name|ISC_R_SUCCESS
argument_list|)
expr_stmt|;
name|RUNTIME_CHECK
argument_list|(
name|dns_zone_setalsonotify
argument_list|(
name|zone
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
operator|==
name|ISC_R_SUCCESS
argument_list|)
expr_stmt|;
name|zone
operator|->
name|check_names
operator|=
name|dns_severity_ignore
expr_stmt|;
if|if
condition|(
name|zone
operator|->
name|update_acl
operator|!=
name|NULL
condition|)
name|dns_acl_detach
argument_list|(
operator|&
name|zone
operator|->
name|update_acl
argument_list|)
expr_stmt|;
if|if
condition|(
name|zone
operator|->
name|forward_acl
operator|!=
name|NULL
condition|)
name|dns_acl_detach
argument_list|(
operator|&
name|zone
operator|->
name|forward_acl
argument_list|)
expr_stmt|;
if|if
condition|(
name|zone
operator|->
name|notify_acl
operator|!=
name|NULL
condition|)
name|dns_acl_detach
argument_list|(
operator|&
name|zone
operator|->
name|notify_acl
argument_list|)
expr_stmt|;
if|if
condition|(
name|zone
operator|->
name|query_acl
operator|!=
name|NULL
condition|)
name|dns_acl_detach
argument_list|(
operator|&
name|zone
operator|->
name|query_acl
argument_list|)
expr_stmt|;
if|if
condition|(
name|zone
operator|->
name|xfr_acl
operator|!=
name|NULL
condition|)
name|dns_acl_detach
argument_list|(
operator|&
name|zone
operator|->
name|xfr_acl
argument_list|)
expr_stmt|;
if|if
condition|(
name|dns_name_dynamic
argument_list|(
operator|&
name|zone
operator|->
name|origin
argument_list|)
condition|)
name|dns_name_free
argument_list|(
operator|&
name|zone
operator|->
name|origin
argument_list|,
name|zone
operator|->
name|mctx
argument_list|)
expr_stmt|;
if|if
condition|(
name|zone
operator|->
name|ssutable
operator|!=
name|NULL
condition|)
name|dns_ssutable_detach
argument_list|(
operator|&
name|zone
operator|->
name|ssutable
argument_list|)
expr_stmt|;
comment|/* last stuff */
name|DESTROYLOCK
argument_list|(
operator|&
name|zone
operator|->
name|lock
argument_list|)
expr_stmt|;
name|isc_refcount_destroy
argument_list|(
operator|&
name|zone
operator|->
name|erefs
argument_list|)
expr_stmt|;
name|zone
operator|->
name|magic
operator|=
literal|0
expr_stmt|;
name|mctx
operator|=
name|zone
operator|->
name|mctx
expr_stmt|;
name|isc_mem_put
argument_list|(
name|mctx
argument_list|,
name|zone
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|zone
argument_list|)
argument_list|)
expr_stmt|;
name|isc_mem_detach
argument_list|(
operator|&
name|mctx
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  *	Single shot.  */
end_comment

begin_function
name|void
name|dns_zone_setclass
parameter_list|(
name|dns_zone_t
modifier|*
name|zone
parameter_list|,
name|dns_rdataclass_t
name|rdclass
parameter_list|)
block|{
name|REQUIRE
argument_list|(
name|DNS_ZONE_VALID
argument_list|(
name|zone
argument_list|)
argument_list|)
expr_stmt|;
name|REQUIRE
argument_list|(
name|rdclass
operator|!=
name|dns_rdataclass_none
argument_list|)
expr_stmt|;
comment|/* 	 * Test and set. 	 */
name|LOCK_ZONE
argument_list|(
name|zone
argument_list|)
expr_stmt|;
name|REQUIRE
argument_list|(
name|zone
operator|->
name|rdclass
operator|==
name|dns_rdataclass_none
operator|||
name|zone
operator|->
name|rdclass
operator|==
name|rdclass
argument_list|)
expr_stmt|;
name|zone
operator|->
name|rdclass
operator|=
name|rdclass
expr_stmt|;
name|UNLOCK_ZONE
argument_list|(
name|zone
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|dns_rdataclass_t
name|dns_zone_getclass
parameter_list|(
name|dns_zone_t
modifier|*
name|zone
parameter_list|)
block|{
name|REQUIRE
argument_list|(
name|DNS_ZONE_VALID
argument_list|(
name|zone
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|(
name|zone
operator|->
name|rdclass
operator|)
return|;
block|}
end_function

begin_function
name|void
name|dns_zone_setnotifytype
parameter_list|(
name|dns_zone_t
modifier|*
name|zone
parameter_list|,
name|dns_notifytype_t
name|notifytype
parameter_list|)
block|{
name|REQUIRE
argument_list|(
name|DNS_ZONE_VALID
argument_list|(
name|zone
argument_list|)
argument_list|)
expr_stmt|;
name|LOCK_ZONE
argument_list|(
name|zone
argument_list|)
expr_stmt|;
name|zone
operator|->
name|notifytype
operator|=
name|notifytype
expr_stmt|;
name|UNLOCK_ZONE
argument_list|(
name|zone
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  *	Single shot.  */
end_comment

begin_function
name|void
name|dns_zone_settype
parameter_list|(
name|dns_zone_t
modifier|*
name|zone
parameter_list|,
name|dns_zonetype_t
name|type
parameter_list|)
block|{
name|REQUIRE
argument_list|(
name|DNS_ZONE_VALID
argument_list|(
name|zone
argument_list|)
argument_list|)
expr_stmt|;
name|REQUIRE
argument_list|(
name|type
operator|!=
name|dns_zone_none
argument_list|)
expr_stmt|;
comment|/* 	 * Test and set. 	 */
name|LOCK_ZONE
argument_list|(
name|zone
argument_list|)
expr_stmt|;
name|REQUIRE
argument_list|(
name|zone
operator|->
name|type
operator|==
name|dns_zone_none
operator|||
name|zone
operator|->
name|type
operator|==
name|type
argument_list|)
expr_stmt|;
name|zone
operator|->
name|type
operator|=
name|type
expr_stmt|;
name|UNLOCK_ZONE
argument_list|(
name|zone
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|zone_freedbargs
parameter_list|(
name|dns_zone_t
modifier|*
name|zone
parameter_list|)
block|{
name|unsigned
name|int
name|i
decl_stmt|;
comment|/* Free the old database argument list. */
if|if
condition|(
name|zone
operator|->
name|db_argv
operator|!=
name|NULL
condition|)
block|{
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|zone
operator|->
name|db_argc
condition|;
name|i
operator|++
control|)
name|isc_mem_free
argument_list|(
name|zone
operator|->
name|mctx
argument_list|,
name|zone
operator|->
name|db_argv
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|isc_mem_put
argument_list|(
name|zone
operator|->
name|mctx
argument_list|,
name|zone
operator|->
name|db_argv
argument_list|,
name|zone
operator|->
name|db_argc
operator|*
sizeof|sizeof
argument_list|(
operator|*
name|zone
operator|->
name|db_argv
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|zone
operator|->
name|db_argc
operator|=
literal|0
expr_stmt|;
name|zone
operator|->
name|db_argv
operator|=
name|NULL
expr_stmt|;
block|}
end_function

begin_function
name|isc_result_t
name|dns_zone_setdbtype
parameter_list|(
name|dns_zone_t
modifier|*
name|zone
parameter_list|,
name|unsigned
name|int
name|dbargc
parameter_list|,
specifier|const
name|char
modifier|*
specifier|const
modifier|*
name|dbargv
parameter_list|)
block|{
name|isc_result_t
name|result
init|=
name|ISC_R_SUCCESS
decl_stmt|;
name|char
modifier|*
modifier|*
name|new
init|=
name|NULL
decl_stmt|;
name|unsigned
name|int
name|i
decl_stmt|;
name|REQUIRE
argument_list|(
name|DNS_ZONE_VALID
argument_list|(
name|zone
argument_list|)
argument_list|)
expr_stmt|;
name|REQUIRE
argument_list|(
name|dbargc
operator|>=
literal|1
argument_list|)
expr_stmt|;
name|REQUIRE
argument_list|(
name|dbargv
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|LOCK_ZONE
argument_list|(
name|zone
argument_list|)
expr_stmt|;
comment|/* Set up a new database argument list. */
name|new
operator|=
name|isc_mem_get
argument_list|(
name|zone
operator|->
name|mctx
argument_list|,
name|dbargc
operator|*
sizeof|sizeof
argument_list|(
operator|*
name|new
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|new
operator|==
name|NULL
condition|)
goto|goto
name|nomem
goto|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|dbargc
condition|;
name|i
operator|++
control|)
name|new
index|[
name|i
index|]
operator|=
name|NULL
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|dbargc
condition|;
name|i
operator|++
control|)
block|{
name|new
index|[
name|i
index|]
operator|=
name|isc_mem_strdup
argument_list|(
name|zone
operator|->
name|mctx
argument_list|,
name|dbargv
index|[
name|i
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|new
index|[
name|i
index|]
operator|==
name|NULL
condition|)
goto|goto
name|nomem
goto|;
block|}
comment|/* Free the old list. */
name|zone_freedbargs
argument_list|(
name|zone
argument_list|)
expr_stmt|;
name|zone
operator|->
name|db_argc
operator|=
name|dbargc
expr_stmt|;
name|zone
operator|->
name|db_argv
operator|=
name|new
expr_stmt|;
name|result
operator|=
name|ISC_R_SUCCESS
expr_stmt|;
goto|goto
name|unlock
goto|;
name|nomem
label|:
if|if
condition|(
name|new
operator|!=
name|NULL
condition|)
block|{
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|dbargc
condition|;
name|i
operator|++
control|)
if|if
condition|(
name|new
index|[
name|i
index|]
operator|!=
name|NULL
condition|)
name|isc_mem_free
argument_list|(
name|zone
operator|->
name|mctx
argument_list|,
name|new
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|isc_mem_put
argument_list|(
name|zone
operator|->
name|mctx
argument_list|,
name|new
argument_list|,
name|dbargc
operator|*
sizeof|sizeof
argument_list|(
operator|*
name|new
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|result
operator|=
name|ISC_R_NOMEMORY
expr_stmt|;
name|unlock
label|:
name|UNLOCK_ZONE
argument_list|(
name|zone
argument_list|)
expr_stmt|;
return|return
operator|(
name|result
operator|)
return|;
block|}
end_function

begin_function
name|void
name|dns_zone_setview
parameter_list|(
name|dns_zone_t
modifier|*
name|zone
parameter_list|,
name|dns_view_t
modifier|*
name|view
parameter_list|)
block|{
name|REQUIRE
argument_list|(
name|DNS_ZONE_VALID
argument_list|(
name|zone
argument_list|)
argument_list|)
expr_stmt|;
name|LOCK_ZONE
argument_list|(
name|zone
argument_list|)
expr_stmt|;
if|if
condition|(
name|zone
operator|->
name|view
operator|!=
name|NULL
condition|)
name|dns_view_weakdetach
argument_list|(
operator|&
name|zone
operator|->
name|view
argument_list|)
expr_stmt|;
name|dns_view_weakattach
argument_list|(
name|view
argument_list|,
operator|&
name|zone
operator|->
name|view
argument_list|)
expr_stmt|;
name|UNLOCK_ZONE
argument_list|(
name|zone
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|dns_view_t
modifier|*
name|dns_zone_getview
parameter_list|(
name|dns_zone_t
modifier|*
name|zone
parameter_list|)
block|{
name|REQUIRE
argument_list|(
name|DNS_ZONE_VALID
argument_list|(
name|zone
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|(
name|zone
operator|->
name|view
operator|)
return|;
block|}
end_function

begin_function
name|isc_result_t
name|dns_zone_setorigin
parameter_list|(
name|dns_zone_t
modifier|*
name|zone
parameter_list|,
specifier|const
name|dns_name_t
modifier|*
name|origin
parameter_list|)
block|{
name|isc_result_t
name|result
decl_stmt|;
name|REQUIRE
argument_list|(
name|DNS_ZONE_VALID
argument_list|(
name|zone
argument_list|)
argument_list|)
expr_stmt|;
name|REQUIRE
argument_list|(
name|origin
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|LOCK_ZONE
argument_list|(
name|zone
argument_list|)
expr_stmt|;
if|if
condition|(
name|dns_name_dynamic
argument_list|(
operator|&
name|zone
operator|->
name|origin
argument_list|)
condition|)
block|{
name|dns_name_free
argument_list|(
operator|&
name|zone
operator|->
name|origin
argument_list|,
name|zone
operator|->
name|mctx
argument_list|)
expr_stmt|;
name|dns_name_init
argument_list|(
operator|&
name|zone
operator|->
name|origin
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
block|}
name|result
operator|=
name|dns_name_dup
argument_list|(
name|origin
argument_list|,
name|zone
operator|->
name|mctx
argument_list|,
operator|&
name|zone
operator|->
name|origin
argument_list|)
expr_stmt|;
name|UNLOCK_ZONE
argument_list|(
name|zone
argument_list|)
expr_stmt|;
return|return
operator|(
name|result
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|isc_result_t
name|dns_zone_setstring
parameter_list|(
name|dns_zone_t
modifier|*
name|zone
parameter_list|,
name|char
modifier|*
modifier|*
name|field
parameter_list|,
specifier|const
name|char
modifier|*
name|value
parameter_list|)
block|{
name|char
modifier|*
name|copy
decl_stmt|;
if|if
condition|(
name|value
operator|!=
name|NULL
condition|)
block|{
name|copy
operator|=
name|isc_mem_strdup
argument_list|(
name|zone
operator|->
name|mctx
argument_list|,
name|value
argument_list|)
expr_stmt|;
if|if
condition|(
name|copy
operator|==
name|NULL
condition|)
return|return
operator|(
name|ISC_R_NOMEMORY
operator|)
return|;
block|}
else|else
block|{
name|copy
operator|=
name|NULL
expr_stmt|;
block|}
if|if
condition|(
operator|*
name|field
operator|!=
name|NULL
condition|)
name|isc_mem_free
argument_list|(
name|zone
operator|->
name|mctx
argument_list|,
operator|*
name|field
argument_list|)
expr_stmt|;
operator|*
name|field
operator|=
name|copy
expr_stmt|;
return|return
operator|(
name|ISC_R_SUCCESS
operator|)
return|;
block|}
end_function

begin_function
name|isc_result_t
name|dns_zone_setfile
parameter_list|(
name|dns_zone_t
modifier|*
name|zone
parameter_list|,
specifier|const
name|char
modifier|*
name|file
parameter_list|)
block|{
name|isc_result_t
name|result
init|=
name|ISC_R_SUCCESS
decl_stmt|;
name|REQUIRE
argument_list|(
name|DNS_ZONE_VALID
argument_list|(
name|zone
argument_list|)
argument_list|)
expr_stmt|;
name|LOCK_ZONE
argument_list|(
name|zone
argument_list|)
expr_stmt|;
name|result
operator|=
name|dns_zone_setstring
argument_list|(
name|zone
argument_list|,
operator|&
name|zone
operator|->
name|masterfile
argument_list|,
name|file
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|==
name|ISC_R_SUCCESS
condition|)
name|result
operator|=
name|default_journal
argument_list|(
name|zone
argument_list|)
expr_stmt|;
name|UNLOCK_ZONE
argument_list|(
name|zone
argument_list|)
expr_stmt|;
return|return
operator|(
name|result
operator|)
return|;
block|}
end_function

begin_function
specifier|const
name|char
modifier|*
name|dns_zone_getfile
parameter_list|(
name|dns_zone_t
modifier|*
name|zone
parameter_list|)
block|{
name|REQUIRE
argument_list|(
name|DNS_ZONE_VALID
argument_list|(
name|zone
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|(
name|zone
operator|->
name|masterfile
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|isc_result_t
name|default_journal
parameter_list|(
name|dns_zone_t
modifier|*
name|zone
parameter_list|)
block|{
name|isc_result_t
name|result
decl_stmt|;
name|char
modifier|*
name|journal
decl_stmt|;
name|REQUIRE
argument_list|(
name|DNS_ZONE_VALID
argument_list|(
name|zone
argument_list|)
argument_list|)
expr_stmt|;
name|REQUIRE
argument_list|(
name|LOCKED_ZONE
argument_list|(
name|zone
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|zone
operator|->
name|masterfile
operator|!=
name|NULL
condition|)
block|{
comment|/* Calculate string length including '\0'. */
name|int
name|len
init|=
name|strlen
argument_list|(
name|zone
operator|->
name|masterfile
argument_list|)
operator|+
sizeof|sizeof
argument_list|(
literal|".jnl"
argument_list|)
decl_stmt|;
name|journal
operator|=
name|isc_mem_allocate
argument_list|(
name|zone
operator|->
name|mctx
argument_list|,
name|len
argument_list|)
expr_stmt|;
if|if
condition|(
name|journal
operator|==
name|NULL
condition|)
return|return
operator|(
name|ISC_R_NOMEMORY
operator|)
return|;
name|strcpy
argument_list|(
name|journal
argument_list|,
name|zone
operator|->
name|masterfile
argument_list|)
expr_stmt|;
name|strcat
argument_list|(
name|journal
argument_list|,
literal|".jnl"
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|journal
operator|=
name|NULL
expr_stmt|;
block|}
name|result
operator|=
name|dns_zone_setstring
argument_list|(
name|zone
argument_list|,
operator|&
name|zone
operator|->
name|journal
argument_list|,
name|journal
argument_list|)
expr_stmt|;
if|if
condition|(
name|journal
operator|!=
name|NULL
condition|)
name|isc_mem_free
argument_list|(
name|zone
operator|->
name|mctx
argument_list|,
name|journal
argument_list|)
expr_stmt|;
return|return
operator|(
name|result
operator|)
return|;
block|}
end_function

begin_function
name|isc_result_t
name|dns_zone_setjournal
parameter_list|(
name|dns_zone_t
modifier|*
name|zone
parameter_list|,
specifier|const
name|char
modifier|*
name|journal
parameter_list|)
block|{
name|isc_result_t
name|result
init|=
name|ISC_R_SUCCESS
decl_stmt|;
name|REQUIRE
argument_list|(
name|DNS_ZONE_VALID
argument_list|(
name|zone
argument_list|)
argument_list|)
expr_stmt|;
name|LOCK_ZONE
argument_list|(
name|zone
argument_list|)
expr_stmt|;
name|result
operator|=
name|dns_zone_setstring
argument_list|(
name|zone
argument_list|,
operator|&
name|zone
operator|->
name|journal
argument_list|,
name|journal
argument_list|)
expr_stmt|;
name|UNLOCK_ZONE
argument_list|(
name|zone
argument_list|)
expr_stmt|;
return|return
operator|(
name|result
operator|)
return|;
block|}
end_function

begin_function
name|char
modifier|*
name|dns_zone_getjournal
parameter_list|(
name|dns_zone_t
modifier|*
name|zone
parameter_list|)
block|{
name|REQUIRE
argument_list|(
name|DNS_ZONE_VALID
argument_list|(
name|zone
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|(
name|zone
operator|->
name|journal
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Return true iff the zone is "dynamic", in the sense that the zone's  * master file (if any) is written by the server, rather than being  * updated manually and read by the server.  *  * This is true for slave zones, stub zones, and zones that allow  * dynamic updates either by having an update policy ("ssutable")  * or an "allow-update" ACL with a value other than exactly "{ none; }".  */
end_comment

begin_function
specifier|static
name|isc_boolean_t
name|zone_isdynamic
parameter_list|(
name|dns_zone_t
modifier|*
name|zone
parameter_list|)
block|{
name|REQUIRE
argument_list|(
name|DNS_ZONE_VALID
argument_list|(
name|zone
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|(
name|ISC_TF
argument_list|(
name|zone
operator|->
name|type
operator|==
name|dns_zone_slave
operator|||
name|zone
operator|->
name|type
operator|==
name|dns_zone_stub
operator|||
operator|(
operator|!
name|zone
operator|->
name|update_disabled
operator|&&
name|zone
operator|->
name|ssutable
operator|!=
name|NULL
operator|)
operator|||
operator|(
operator|!
name|zone
operator|->
name|update_disabled
operator|&&
name|zone
operator|->
name|update_acl
operator|!=
name|NULL
operator|&&
operator|!
operator|(
name|zone
operator|->
name|update_acl
operator|->
name|length
operator|==
literal|1
operator|&&
name|zone
operator|->
name|update_acl
operator|->
name|elements
index|[
literal|0
index|]
operator|.
name|negative
operator|==
name|ISC_TRUE
operator|&&
name|zone
operator|->
name|update_acl
operator|->
name|elements
index|[
literal|0
index|]
operator|.
name|type
operator|==
name|dns_aclelementtype_any
operator|)
operator|)
argument_list|)
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|isc_result_t
name|zone_load
parameter_list|(
name|dns_zone_t
modifier|*
name|zone
parameter_list|,
name|unsigned
name|int
name|flags
parameter_list|)
block|{
name|isc_result_t
name|result
decl_stmt|;
name|isc_time_t
name|now
decl_stmt|;
name|isc_time_t
name|loadtime
decl_stmt|,
name|filetime
decl_stmt|;
name|dns_db_t
modifier|*
name|db
init|=
name|NULL
decl_stmt|;
name|REQUIRE
argument_list|(
name|DNS_ZONE_VALID
argument_list|(
name|zone
argument_list|)
argument_list|)
expr_stmt|;
name|LOCK_ZONE
argument_list|(
name|zone
argument_list|)
expr_stmt|;
name|TIME_NOW
argument_list|(
operator|&
name|now
argument_list|)
expr_stmt|;
name|INSIST
argument_list|(
name|zone
operator|->
name|type
operator|!=
name|dns_zone_none
argument_list|)
expr_stmt|;
if|if
condition|(
name|DNS_ZONE_FLAG
argument_list|(
name|zone
argument_list|,
name|DNS_ZONEFLG_LOADING
argument_list|)
condition|)
block|{
name|result
operator|=
name|ISC_R_SUCCESS
expr_stmt|;
goto|goto
name|cleanup
goto|;
block|}
if|if
condition|(
name|zone
operator|->
name|db
operator|!=
name|NULL
operator|&&
name|zone
operator|->
name|masterfile
operator|==
name|NULL
condition|)
block|{
comment|/* 		 * The zone has no master file configured, but it already 		 * has a database.  It could be the built-in 		 * version.bind. CH zone, a zone with a persistent 		 * database being reloaded, or maybe a zone that 		 * used to have a master file but whose configuration 		 * was changed so that it no longer has one.  Do nothing. 		 */
name|result
operator|=
name|ISC_R_SUCCESS
expr_stmt|;
goto|goto
name|cleanup
goto|;
block|}
if|if
condition|(
name|zone
operator|->
name|db
operator|!=
name|NULL
operator|&&
name|zone_isdynamic
argument_list|(
name|zone
argument_list|)
condition|)
block|{
comment|/* 		 * This is a slave, stub, or dynamically updated 		 * zone being reloaded.  Do nothing - the database 		 * we already have is guaranteed to be up-to-date. 		 */
if|if
condition|(
name|zone
operator|->
name|type
operator|==
name|dns_zone_master
condition|)
name|result
operator|=
name|DNS_R_DYNAMIC
expr_stmt|;
else|else
name|result
operator|=
name|ISC_R_SUCCESS
expr_stmt|;
goto|goto
name|cleanup
goto|;
block|}
comment|/* 	 * Don't do the load if the file that stores the zone is older 	 * than the last time the zone was loaded.  If the zone has not 	 * been loaded yet, zone->loadtime will be the epoch. 	 */
if|if
condition|(
name|zone
operator|->
name|masterfile
operator|!=
name|NULL
operator|&&
operator|!
name|isc_time_isepoch
argument_list|(
operator|&
name|zone
operator|->
name|loadtime
argument_list|)
condition|)
block|{
comment|/* 		 * The file is already loaded.  If we are just doing a 		 * "rndc reconfig", we are done. 		 */
if|if
condition|(
operator|(
name|flags
operator|&
name|DNS_ZONELOADFLAG_NOSTAT
operator|)
operator|!=
literal|0
condition|)
block|{
name|result
operator|=
name|ISC_R_SUCCESS
expr_stmt|;
goto|goto
name|cleanup
goto|;
block|}
if|if
condition|(
operator|!
name|DNS_ZONE_FLAG
argument_list|(
name|zone
argument_list|,
name|DNS_ZONEFLG_HASINCLUDE
argument_list|)
condition|)
block|{
name|result
operator|=
name|isc_file_getmodtime
argument_list|(
name|zone
operator|->
name|masterfile
argument_list|,
operator|&
name|filetime
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|==
name|ISC_R_SUCCESS
operator|&&
name|DNS_ZONE_FLAG
argument_list|(
name|zone
argument_list|,
name|DNS_ZONEFLG_LOADED
argument_list|)
operator|&&
name|isc_time_compare
argument_list|(
operator|&
name|filetime
argument_list|,
operator|&
name|zone
operator|->
name|loadtime
argument_list|)
operator|<=
literal|0
condition|)
block|{
name|dns_zone_log
argument_list|(
name|zone
argument_list|,
name|ISC_LOG_DEBUG
argument_list|(
literal|1
argument_list|)
argument_list|,
literal|"skipping load: master file older "
literal|"than last load"
argument_list|)
expr_stmt|;
name|result
operator|=
name|DNS_R_UPTODATE
expr_stmt|;
goto|goto
name|cleanup
goto|;
block|}
block|}
block|}
name|INSIST
argument_list|(
name|zone
operator|->
name|db_argc
operator|>=
literal|1
argument_list|)
expr_stmt|;
comment|/* 	 * Built in zones don't need to be reloaded. 	 */
if|if
condition|(
name|zone
operator|->
name|type
operator|==
name|dns_zone_master
operator|&&
name|strcmp
argument_list|(
name|zone
operator|->
name|db_argv
index|[
literal|0
index|]
argument_list|,
literal|"_builtin"
argument_list|)
operator|==
literal|0
operator|&&
name|DNS_ZONE_FLAG
argument_list|(
name|zone
argument_list|,
name|DNS_ZONEFLG_LOADED
argument_list|)
condition|)
block|{
name|result
operator|=
name|ISC_R_SUCCESS
expr_stmt|;
goto|goto
name|cleanup
goto|;
block|}
if|if
condition|(
operator|(
name|zone
operator|->
name|type
operator|==
name|dns_zone_slave
operator|||
name|zone
operator|->
name|type
operator|==
name|dns_zone_stub
operator|)
operator|&&
operator|(
name|strcmp
argument_list|(
name|zone
operator|->
name|db_argv
index|[
literal|0
index|]
argument_list|,
literal|"rbt"
argument_list|)
operator|==
literal|0
operator|||
name|strcmp
argument_list|(
name|zone
operator|->
name|db_argv
index|[
literal|0
index|]
argument_list|,
literal|"rbt64"
argument_list|)
operator|==
literal|0
operator|)
condition|)
block|{
if|if
condition|(
name|zone
operator|->
name|masterfile
operator|==
name|NULL
operator|||
operator|!
name|isc_file_exists
argument_list|(
name|zone
operator|->
name|masterfile
argument_list|)
condition|)
block|{
if|if
condition|(
name|zone
operator|->
name|masterfile
operator|!=
name|NULL
condition|)
name|dns_zone_log
argument_list|(
name|zone
argument_list|,
name|ISC_LOG_DEBUG
argument_list|(
literal|1
argument_list|)
argument_list|,
literal|"no master file"
argument_list|)
expr_stmt|;
name|zone
operator|->
name|refreshtime
operator|=
name|now
expr_stmt|;
if|if
condition|(
name|zone
operator|->
name|task
operator|!=
name|NULL
condition|)
name|zone_settimer
argument_list|(
name|zone
argument_list|,
operator|&
name|now
argument_list|)
expr_stmt|;
name|result
operator|=
name|ISC_R_SUCCESS
expr_stmt|;
goto|goto
name|cleanup
goto|;
block|}
block|}
name|dns_zone_log
argument_list|(
name|zone
argument_list|,
name|ISC_LOG_DEBUG
argument_list|(
literal|1
argument_list|)
argument_list|,
literal|"starting load"
argument_list|)
expr_stmt|;
comment|/* 	 * Store the current time before the zone is loaded, so that if the 	 * file changes between the time of the load and the time that 	 * zone->loadtime is set, then the file will still be reloaded 	 * the next time dns_zone_load is called. 	 */
name|TIME_NOW
argument_list|(
operator|&
name|loadtime
argument_list|)
expr_stmt|;
name|result
operator|=
name|dns_db_create
argument_list|(
name|zone
operator|->
name|mctx
argument_list|,
name|zone
operator|->
name|db_argv
index|[
literal|0
index|]
argument_list|,
operator|&
name|zone
operator|->
name|origin
argument_list|,
operator|(
name|zone
operator|->
name|type
operator|==
name|dns_zone_stub
operator|)
condition|?
name|dns_dbtype_stub
else|:
name|dns_dbtype_zone
argument_list|,
name|zone
operator|->
name|rdclass
argument_list|,
name|zone
operator|->
name|db_argc
operator|-
literal|1
argument_list|,
name|zone
operator|->
name|db_argv
operator|+
literal|1
argument_list|,
operator|&
name|db
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
block|{
name|dns_zone_log
argument_list|(
name|zone
argument_list|,
name|ISC_LOG_ERROR
argument_list|,
literal|"loading zone: creating database: %s"
argument_list|,
name|isc_result_totext
argument_list|(
name|result
argument_list|)
argument_list|)
expr_stmt|;
goto|goto
name|cleanup
goto|;
block|}
name|dns_db_settask
argument_list|(
name|db
argument_list|,
name|zone
operator|->
name|task
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|dns_db_ispersistent
argument_list|(
name|db
argument_list|)
condition|)
block|{
if|if
condition|(
name|zone
operator|->
name|masterfile
operator|!=
name|NULL
condition|)
block|{
name|result
operator|=
name|zone_startload
argument_list|(
name|db
argument_list|,
name|zone
argument_list|,
name|loadtime
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|result
operator|=
name|DNS_R_NOMASTERFILE
expr_stmt|;
if|if
condition|(
name|zone
operator|->
name|type
operator|==
name|dns_zone_master
condition|)
block|{
name|dns_zone_log
argument_list|(
name|zone
argument_list|,
name|ISC_LOG_ERROR
argument_list|,
literal|"loading zone: "
literal|"no master file configured"
argument_list|)
expr_stmt|;
goto|goto
name|cleanup
goto|;
block|}
name|dns_zone_log
argument_list|(
name|zone
argument_list|,
name|ISC_LOG_INFO
argument_list|,
literal|"loading zone: "
literal|"no master file configured: continuing"
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
name|result
operator|==
name|DNS_R_CONTINUE
condition|)
block|{
name|DNS_ZONE_SETFLAG
argument_list|(
name|zone
argument_list|,
name|DNS_ZONEFLG_LOADING
argument_list|)
expr_stmt|;
goto|goto
name|cleanup
goto|;
block|}
name|result
operator|=
name|zone_postload
argument_list|(
name|zone
argument_list|,
name|db
argument_list|,
name|loadtime
argument_list|,
name|result
argument_list|)
expr_stmt|;
name|cleanup
label|:
name|UNLOCK_ZONE
argument_list|(
name|zone
argument_list|)
expr_stmt|;
if|if
condition|(
name|db
operator|!=
name|NULL
condition|)
name|dns_db_detach
argument_list|(
operator|&
name|db
argument_list|)
expr_stmt|;
return|return
operator|(
name|result
operator|)
return|;
block|}
end_function

begin_function
name|isc_result_t
name|dns_zone_load
parameter_list|(
name|dns_zone_t
modifier|*
name|zone
parameter_list|)
block|{
return|return
operator|(
name|zone_load
argument_list|(
name|zone
argument_list|,
literal|0
argument_list|)
operator|)
return|;
block|}
end_function

begin_function
name|isc_result_t
name|dns_zone_loadnew
parameter_list|(
name|dns_zone_t
modifier|*
name|zone
parameter_list|)
block|{
return|return
operator|(
name|zone_load
argument_list|(
name|zone
argument_list|,
name|DNS_ZONELOADFLAG_NOSTAT
argument_list|)
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|zone_gotreadhandle
parameter_list|(
name|isc_task_t
modifier|*
name|task
parameter_list|,
name|isc_event_t
modifier|*
name|event
parameter_list|)
block|{
name|dns_load_t
modifier|*
name|load
init|=
name|event
operator|->
name|ev_arg
decl_stmt|;
name|isc_result_t
name|result
init|=
name|ISC_R_SUCCESS
decl_stmt|;
name|unsigned
name|int
name|options
decl_stmt|;
name|REQUIRE
argument_list|(
name|DNS_LOAD_VALID
argument_list|(
name|load
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|event
operator|->
name|ev_attributes
operator|&
name|ISC_EVENTATTR_CANCELED
operator|)
operator|!=
literal|0
condition|)
name|result
operator|=
name|ISC_R_CANCELED
expr_stmt|;
name|isc_event_free
argument_list|(
operator|&
name|event
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|==
name|ISC_R_CANCELED
condition|)
goto|goto
name|fail
goto|;
name|options
operator|=
name|DNS_MASTER_ZONE
expr_stmt|;
if|if
condition|(
name|load
operator|->
name|zone
operator|->
name|type
operator|==
name|dns_zone_slave
condition|)
name|options
operator||=
name|DNS_MASTER_SLAVE
expr_stmt|;
if|if
condition|(
name|DNS_ZONE_OPTION
argument_list|(
name|load
operator|->
name|zone
argument_list|,
name|DNS_ZONEOPT_CHECKNS
argument_list|)
condition|)
name|options
operator||=
name|DNS_MASTER_CHECKNS
expr_stmt|;
if|if
condition|(
name|DNS_ZONE_OPTION
argument_list|(
name|load
operator|->
name|zone
argument_list|,
name|DNS_ZONEOPT_FATALNS
argument_list|)
condition|)
name|options
operator||=
name|DNS_MASTER_FATALNS
expr_stmt|;
if|if
condition|(
name|DNS_ZONE_OPTION
argument_list|(
name|load
operator|->
name|zone
argument_list|,
name|DNS_ZONEOPT_CHECKNAMES
argument_list|)
condition|)
name|options
operator||=
name|DNS_MASTER_CHECKNAMES
expr_stmt|;
if|if
condition|(
name|DNS_ZONE_OPTION
argument_list|(
name|load
operator|->
name|zone
argument_list|,
name|DNS_ZONEOPT_CHECKNAMESFAIL
argument_list|)
condition|)
name|options
operator||=
name|DNS_MASTER_CHECKNAMESFAIL
expr_stmt|;
name|result
operator|=
name|dns_master_loadfileinc
argument_list|(
name|load
operator|->
name|zone
operator|->
name|masterfile
argument_list|,
name|dns_db_origin
argument_list|(
name|load
operator|->
name|db
argument_list|)
argument_list|,
name|dns_db_origin
argument_list|(
name|load
operator|->
name|db
argument_list|)
argument_list|,
name|load
operator|->
name|zone
operator|->
name|rdclass
argument_list|,
name|options
argument_list|,
operator|&
name|load
operator|->
name|callbacks
argument_list|,
name|task
argument_list|,
name|zone_loaddone
argument_list|,
name|load
argument_list|,
operator|&
name|load
operator|->
name|zone
operator|->
name|lctx
argument_list|,
name|load
operator|->
name|zone
operator|->
name|mctx
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
operator|&&
name|result
operator|!=
name|DNS_R_CONTINUE
operator|&&
name|result
operator|!=
name|DNS_R_SEENINCLUDE
condition|)
goto|goto
name|fail
goto|;
return|return;
name|fail
label|:
name|zone_loaddone
argument_list|(
name|load
argument_list|,
name|result
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|zone_gotwritehandle
parameter_list|(
name|isc_task_t
modifier|*
name|task
parameter_list|,
name|isc_event_t
modifier|*
name|event
parameter_list|)
block|{
specifier|const
name|char
name|me
index|[]
init|=
literal|"zone_gotwritehandle"
decl_stmt|;
name|dns_zone_t
modifier|*
name|zone
init|=
name|event
operator|->
name|ev_arg
decl_stmt|;
name|isc_result_t
name|result
init|=
name|ISC_R_SUCCESS
decl_stmt|;
name|dns_dbversion_t
modifier|*
name|version
init|=
name|NULL
decl_stmt|;
name|REQUIRE
argument_list|(
name|DNS_ZONE_VALID
argument_list|(
name|zone
argument_list|)
argument_list|)
expr_stmt|;
name|INSIST
argument_list|(
name|task
operator|==
name|zone
operator|->
name|task
argument_list|)
expr_stmt|;
name|ENTER
expr_stmt|;
if|if
condition|(
operator|(
name|event
operator|->
name|ev_attributes
operator|&
name|ISC_EVENTATTR_CANCELED
operator|)
operator|!=
literal|0
condition|)
name|result
operator|=
name|ISC_R_CANCELED
expr_stmt|;
name|isc_event_free
argument_list|(
operator|&
name|event
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|==
name|ISC_R_CANCELED
condition|)
goto|goto
name|fail
goto|;
name|LOCK_ZONE
argument_list|(
name|zone
argument_list|)
expr_stmt|;
name|dns_db_currentversion
argument_list|(
name|zone
operator|->
name|db
argument_list|,
operator|&
name|version
argument_list|)
expr_stmt|;
name|result
operator|=
name|dns_master_dumpinc
argument_list|(
name|zone
operator|->
name|mctx
argument_list|,
name|zone
operator|->
name|db
argument_list|,
name|version
argument_list|,
operator|&
name|dns_master_style_default
argument_list|,
name|zone
operator|->
name|masterfile
argument_list|,
name|zone
operator|->
name|task
argument_list|,
name|dump_done
argument_list|,
name|zone
argument_list|,
operator|&
name|zone
operator|->
name|dctx
argument_list|)
expr_stmt|;
name|dns_db_closeversion
argument_list|(
name|zone
operator|->
name|db
argument_list|,
operator|&
name|version
argument_list|,
name|ISC_FALSE
argument_list|)
expr_stmt|;
name|UNLOCK_ZONE
argument_list|(
name|zone
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|DNS_R_CONTINUE
condition|)
goto|goto
name|fail
goto|;
return|return;
name|fail
label|:
name|dump_done
argument_list|(
name|zone
argument_list|,
name|result
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|isc_result_t
name|zone_startload
parameter_list|(
name|dns_db_t
modifier|*
name|db
parameter_list|,
name|dns_zone_t
modifier|*
name|zone
parameter_list|,
name|isc_time_t
name|loadtime
parameter_list|)
block|{
name|dns_load_t
modifier|*
name|load
decl_stmt|;
name|isc_result_t
name|result
decl_stmt|;
name|isc_result_t
name|tresult
decl_stmt|;
name|unsigned
name|int
name|options
decl_stmt|;
name|options
operator|=
name|DNS_MASTER_ZONE
expr_stmt|;
if|if
condition|(
name|DNS_ZONE_OPTION
argument_list|(
name|zone
argument_list|,
name|DNS_ZONEOPT_MANYERRORS
argument_list|)
condition|)
name|options
operator||=
name|DNS_MASTER_MANYERRORS
expr_stmt|;
if|if
condition|(
name|DNS_ZONE_OPTION
argument_list|(
name|zone
argument_list|,
name|DNS_ZONEOPT_CHECKNS
argument_list|)
condition|)
name|options
operator||=
name|DNS_MASTER_CHECKNS
expr_stmt|;
if|if
condition|(
name|DNS_ZONE_OPTION
argument_list|(
name|zone
argument_list|,
name|DNS_ZONEOPT_FATALNS
argument_list|)
condition|)
name|options
operator||=
name|DNS_MASTER_FATALNS
expr_stmt|;
if|if
condition|(
name|zone
operator|->
name|type
operator|==
name|dns_zone_slave
condition|)
name|options
operator||=
name|DNS_MASTER_SLAVE
expr_stmt|;
if|if
condition|(
name|DNS_ZONE_OPTION
argument_list|(
name|zone
argument_list|,
name|DNS_ZONEOPT_CHECKNAMES
argument_list|)
condition|)
name|options
operator||=
name|DNS_MASTER_CHECKNAMES
expr_stmt|;
if|if
condition|(
name|DNS_ZONE_OPTION
argument_list|(
name|zone
argument_list|,
name|DNS_ZONEOPT_CHECKNAMESFAIL
argument_list|)
condition|)
name|options
operator||=
name|DNS_MASTER_CHECKNAMESFAIL
expr_stmt|;
if|if
condition|(
name|zone
operator|->
name|zmgr
operator|!=
name|NULL
operator|&&
name|zone
operator|->
name|db
operator|!=
name|NULL
operator|&&
name|zone
operator|->
name|task
operator|!=
name|NULL
condition|)
block|{
name|load
operator|=
name|isc_mem_get
argument_list|(
name|zone
operator|->
name|mctx
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|load
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|load
operator|==
name|NULL
condition|)
return|return
operator|(
name|ISC_R_NOMEMORY
operator|)
return|;
name|load
operator|->
name|mctx
operator|=
name|NULL
expr_stmt|;
name|load
operator|->
name|zone
operator|=
name|NULL
expr_stmt|;
name|load
operator|->
name|db
operator|=
name|NULL
expr_stmt|;
name|load
operator|->
name|loadtime
operator|=
name|loadtime
expr_stmt|;
name|load
operator|->
name|magic
operator|=
name|LOAD_MAGIC
expr_stmt|;
name|isc_mem_attach
argument_list|(
name|zone
operator|->
name|mctx
argument_list|,
operator|&
name|load
operator|->
name|mctx
argument_list|)
expr_stmt|;
name|zone_iattach
argument_list|(
name|zone
argument_list|,
operator|&
name|load
operator|->
name|zone
argument_list|)
expr_stmt|;
name|dns_db_attach
argument_list|(
name|db
argument_list|,
operator|&
name|load
operator|->
name|db
argument_list|)
expr_stmt|;
name|dns_rdatacallbacks_init
argument_list|(
operator|&
name|load
operator|->
name|callbacks
argument_list|)
expr_stmt|;
name|result
operator|=
name|dns_db_beginload
argument_list|(
name|db
argument_list|,
operator|&
name|load
operator|->
name|callbacks
operator|.
name|add
argument_list|,
operator|&
name|load
operator|->
name|callbacks
operator|.
name|add_private
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
goto|goto
name|cleanup
goto|;
name|result
operator|=
name|zonemgr_getio
argument_list|(
name|zone
operator|->
name|zmgr
argument_list|,
name|ISC_TRUE
argument_list|,
name|zone
operator|->
name|task
argument_list|,
name|zone_gotreadhandle
argument_list|,
name|load
argument_list|,
operator|&
name|zone
operator|->
name|readio
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
block|{
comment|/* 			 * We can't report multiple errors so ignore 			 * the result of dns_db_endload(). 			 */
operator|(
name|void
operator|)
name|dns_db_endload
argument_list|(
name|load
operator|->
name|db
argument_list|,
operator|&
name|load
operator|->
name|callbacks
operator|.
name|add_private
argument_list|)
expr_stmt|;
goto|goto
name|cleanup
goto|;
block|}
else|else
name|result
operator|=
name|DNS_R_CONTINUE
expr_stmt|;
block|}
else|else
block|{
name|dns_rdatacallbacks_t
name|callbacks
decl_stmt|;
name|dns_rdatacallbacks_init
argument_list|(
operator|&
name|callbacks
argument_list|)
expr_stmt|;
name|result
operator|=
name|dns_db_beginload
argument_list|(
name|db
argument_list|,
operator|&
name|callbacks
operator|.
name|add
argument_list|,
operator|&
name|callbacks
operator|.
name|add_private
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
return|return
operator|(
name|result
operator|)
return|;
name|result
operator|=
name|dns_master_loadfile
argument_list|(
name|zone
operator|->
name|masterfile
argument_list|,
operator|&
name|zone
operator|->
name|origin
argument_list|,
operator|&
name|zone
operator|->
name|origin
argument_list|,
name|zone
operator|->
name|rdclass
argument_list|,
name|options
argument_list|,
operator|&
name|callbacks
argument_list|,
name|zone
operator|->
name|mctx
argument_list|)
expr_stmt|;
name|tresult
operator|=
name|dns_db_endload
argument_list|(
name|db
argument_list|,
operator|&
name|callbacks
operator|.
name|add_private
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|==
name|ISC_R_SUCCESS
condition|)
name|result
operator|=
name|tresult
expr_stmt|;
block|}
return|return
operator|(
name|result
operator|)
return|;
name|cleanup
label|:
name|load
operator|->
name|magic
operator|=
literal|0
expr_stmt|;
name|dns_db_detach
argument_list|(
operator|&
name|load
operator|->
name|db
argument_list|)
expr_stmt|;
name|zone_idetach
argument_list|(
operator|&
name|load
operator|->
name|zone
argument_list|)
expr_stmt|;
name|isc_mem_detach
argument_list|(
operator|&
name|load
operator|->
name|mctx
argument_list|)
expr_stmt|;
name|isc_mem_put
argument_list|(
name|zone
operator|->
name|mctx
argument_list|,
name|load
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|load
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|(
name|result
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * OpenSSL verification of RSA keys with exponent 3 is known to be  * broken prior OpenSSL 0.9.8c/0.9.7k.  Look for such keys and warn  * if they are in use.  */
end_comment

begin_function
specifier|static
name|void
name|zone_check_dnskeys
parameter_list|(
name|dns_zone_t
modifier|*
name|zone
parameter_list|,
name|dns_db_t
modifier|*
name|db
parameter_list|)
block|{
name|dns_dbnode_t
modifier|*
name|node
init|=
name|NULL
decl_stmt|;
name|dns_dbversion_t
modifier|*
name|version
init|=
name|NULL
decl_stmt|;
name|dns_rdata_dnskey_t
name|dnskey
decl_stmt|;
name|dns_rdata_t
name|rdata
init|=
name|DNS_RDATA_INIT
decl_stmt|;
name|dns_rdataset_t
name|rdataset
decl_stmt|;
name|isc_result_t
name|result
decl_stmt|;
name|isc_boolean_t
name|logit
decl_stmt|,
name|foundrsa
init|=
name|ISC_FALSE
decl_stmt|,
name|foundmd5
init|=
name|ISC_FALSE
decl_stmt|;
specifier|const
name|char
modifier|*
name|algorithm
decl_stmt|;
name|result
operator|=
name|dns_db_findnode
argument_list|(
name|db
argument_list|,
operator|&
name|zone
operator|->
name|origin
argument_list|,
name|ISC_FALSE
argument_list|,
operator|&
name|node
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
goto|goto
name|cleanup
goto|;
name|dns_db_currentversion
argument_list|(
name|db
argument_list|,
operator|&
name|version
argument_list|)
expr_stmt|;
name|dns_rdataset_init
argument_list|(
operator|&
name|rdataset
argument_list|)
expr_stmt|;
name|result
operator|=
name|dns_db_findrdataset
argument_list|(
name|db
argument_list|,
name|node
argument_list|,
name|version
argument_list|,
name|dns_rdatatype_dnskey
argument_list|,
name|dns_rdatatype_none
argument_list|,
literal|0
argument_list|,
operator|&
name|rdataset
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
goto|goto
name|cleanup
goto|;
for|for
control|(
name|result
operator|=
name|dns_rdataset_first
argument_list|(
operator|&
name|rdataset
argument_list|)
init|;
name|result
operator|==
name|ISC_R_SUCCESS
condition|;
name|result
operator|=
name|dns_rdataset_next
argument_list|(
operator|&
name|rdataset
argument_list|)
control|)
block|{
name|dns_rdataset_current
argument_list|(
operator|&
name|rdataset
argument_list|,
operator|&
name|rdata
argument_list|)
expr_stmt|;
name|result
operator|=
name|dns_rdata_tostruct
argument_list|(
operator|&
name|rdata
argument_list|,
operator|&
name|dnskey
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|INSIST
argument_list|(
name|result
operator|==
name|ISC_R_SUCCESS
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|dnskey
operator|.
name|algorithm
operator|==
name|DST_ALG_RSASHA1
operator|||
name|dnskey
operator|.
name|algorithm
operator|==
name|DST_ALG_RSAMD5
operator|)
operator|&&
name|dnskey
operator|.
name|datalen
operator|>
literal|1
operator|&&
name|dnskey
operator|.
name|data
index|[
literal|0
index|]
operator|==
literal|1
operator|&&
name|dnskey
operator|.
name|data
index|[
literal|1
index|]
operator|==
literal|3
condition|)
block|{
if|if
condition|(
name|dnskey
operator|.
name|algorithm
operator|==
name|DST_ALG_RSASHA1
condition|)
block|{
name|logit
operator|=
operator|!
name|foundrsa
expr_stmt|;
name|foundrsa
operator|=
name|ISC_TRUE
expr_stmt|;
name|algorithm
operator|=
literal|"RSASHA1"
expr_stmt|;
block|}
else|else
block|{
name|logit
operator|=
operator|!
name|foundmd5
expr_stmt|;
name|foundmd5
operator|=
name|ISC_TRUE
expr_stmt|;
name|algorithm
operator|=
literal|"RSAMD5"
expr_stmt|;
block|}
if|if
condition|(
name|logit
condition|)
name|dns_zone_log
argument_list|(
name|zone
argument_list|,
name|ISC_LOG_WARNING
argument_list|,
literal|"weak %s (%u) key found "
literal|"(exponent=3)"
argument_list|,
name|algorithm
argument_list|,
name|dnskey
operator|.
name|algorithm
argument_list|)
expr_stmt|;
if|if
condition|(
name|foundrsa
operator|&&
name|foundmd5
condition|)
break|break;
block|}
name|dns_rdata_reset
argument_list|(
operator|&
name|rdata
argument_list|)
expr_stmt|;
block|}
name|dns_rdataset_disassociate
argument_list|(
operator|&
name|rdataset
argument_list|)
expr_stmt|;
name|cleanup
label|:
if|if
condition|(
name|node
operator|!=
name|NULL
condition|)
name|dns_db_detachnode
argument_list|(
name|db
argument_list|,
operator|&
name|node
argument_list|)
expr_stmt|;
if|if
condition|(
name|version
operator|!=
name|NULL
condition|)
name|dns_db_closeversion
argument_list|(
name|db
argument_list|,
operator|&
name|version
argument_list|,
name|ISC_FALSE
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|isc_result_t
name|zone_postload
parameter_list|(
name|dns_zone_t
modifier|*
name|zone
parameter_list|,
name|dns_db_t
modifier|*
name|db
parameter_list|,
name|isc_time_t
name|loadtime
parameter_list|,
name|isc_result_t
name|result
parameter_list|)
block|{
name|unsigned
name|int
name|soacount
init|=
literal|0
decl_stmt|;
name|unsigned
name|int
name|nscount
init|=
literal|0
decl_stmt|;
name|isc_uint32_t
name|serial
decl_stmt|,
name|refresh
decl_stmt|,
name|retry
decl_stmt|,
name|expire
decl_stmt|,
name|minimum
decl_stmt|;
name|isc_time_t
name|now
decl_stmt|;
name|isc_boolean_t
name|needdump
init|=
name|ISC_FALSE
decl_stmt|;
name|isc_boolean_t
name|hasinclude
init|=
name|DNS_ZONE_FLAG
argument_list|(
name|zone
argument_list|,
name|DNS_ZONEFLG_HASINCLUDE
argument_list|)
decl_stmt|;
name|TIME_NOW
argument_list|(
operator|&
name|now
argument_list|)
expr_stmt|;
comment|/* 	 * Initiate zone transfer?  We may need a error code that 	 * indicates that the "permanent" form does not exist. 	 * XXX better error feedback to log. 	 */
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
operator|&&
name|result
operator|!=
name|DNS_R_SEENINCLUDE
condition|)
block|{
if|if
condition|(
name|zone
operator|->
name|type
operator|==
name|dns_zone_slave
operator|||
name|zone
operator|->
name|type
operator|==
name|dns_zone_stub
condition|)
block|{
if|if
condition|(
name|result
operator|==
name|ISC_R_FILENOTFOUND
condition|)
name|dns_zone_log
argument_list|(
name|zone
argument_list|,
name|ISC_LOG_DEBUG
argument_list|(
literal|1
argument_list|)
argument_list|,
literal|"no master file"
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|result
operator|!=
name|DNS_R_NOMASTERFILE
condition|)
name|dns_zone_log
argument_list|(
name|zone
argument_list|,
name|ISC_LOG_ERROR
argument_list|,
literal|"loading master file %s: %s"
argument_list|,
name|zone
operator|->
name|masterfile
argument_list|,
name|dns_result_totext
argument_list|(
name|result
argument_list|)
argument_list|)
expr_stmt|;
block|}
else|else
name|dns_zone_log
argument_list|(
name|zone
argument_list|,
name|ISC_LOG_ERROR
argument_list|,
literal|"loading master file %s: %s"
argument_list|,
name|zone
operator|->
name|masterfile
argument_list|,
name|dns_result_totext
argument_list|(
name|result
argument_list|)
argument_list|)
expr_stmt|;
goto|goto
name|cleanup
goto|;
block|}
name|dns_zone_log
argument_list|(
name|zone
argument_list|,
name|ISC_LOG_DEBUG
argument_list|(
literal|2
argument_list|)
argument_list|,
literal|"number of nodes in database: %u"
argument_list|,
name|dns_db_nodecount
argument_list|(
name|db
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|==
name|DNS_R_SEENINCLUDE
condition|)
name|DNS_ZONE_SETFLAG
argument_list|(
name|zone
argument_list|,
name|DNS_ZONEFLG_HASINCLUDE
argument_list|)
expr_stmt|;
else|else
name|DNS_ZONE_CLRFLAG
argument_list|(
name|zone
argument_list|,
name|DNS_ZONEFLG_HASINCLUDE
argument_list|)
expr_stmt|;
comment|/* 	 * Apply update log, if any, on initial load. 	 */
if|if
condition|(
name|zone
operator|->
name|journal
operator|!=
name|NULL
operator|&&
operator|!
name|DNS_ZONE_OPTION
argument_list|(
name|zone
argument_list|,
name|DNS_ZONEOPT_NOMERGE
argument_list|)
operator|&&
operator|!
name|DNS_ZONE_FLAG
argument_list|(
name|zone
argument_list|,
name|DNS_ZONEFLG_LOADED
argument_list|)
condition|)
block|{
name|result
operator|=
name|dns_journal_rollforward
argument_list|(
name|zone
operator|->
name|mctx
argument_list|,
name|db
argument_list|,
name|zone
operator|->
name|journal
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
operator|&&
name|result
operator|!=
name|ISC_R_NOTFOUND
operator|&&
name|result
operator|!=
name|DNS_R_UPTODATE
operator|&&
name|result
operator|!=
name|DNS_R_NOJOURNAL
operator|&&
name|result
operator|!=
name|ISC_R_RANGE
condition|)
block|{
name|dns_zone_log
argument_list|(
name|zone
argument_list|,
name|ISC_LOG_ERROR
argument_list|,
literal|"journal rollforward failed: %s"
argument_list|,
name|dns_result_totext
argument_list|(
name|result
argument_list|)
argument_list|)
expr_stmt|;
goto|goto
name|cleanup
goto|;
block|}
if|if
condition|(
name|result
operator|==
name|ISC_R_NOTFOUND
operator|||
name|result
operator|==
name|ISC_R_RANGE
condition|)
block|{
name|dns_zone_log
argument_list|(
name|zone
argument_list|,
name|ISC_LOG_ERROR
argument_list|,
literal|"journal rollforward failed: "
literal|"journal out of sync with zone"
argument_list|)
expr_stmt|;
goto|goto
name|cleanup
goto|;
block|}
name|dns_zone_log
argument_list|(
name|zone
argument_list|,
name|ISC_LOG_DEBUG
argument_list|(
literal|1
argument_list|)
argument_list|,
literal|"journal rollforward completed "
literal|"successfully: %s"
argument_list|,
name|dns_result_totext
argument_list|(
name|result
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|==
name|ISC_R_SUCCESS
condition|)
name|needdump
operator|=
name|ISC_TRUE
expr_stmt|;
block|}
name|zone
operator|->
name|loadtime
operator|=
name|loadtime
expr_stmt|;
name|dns_zone_log
argument_list|(
name|zone
argument_list|,
name|ISC_LOG_DEBUG
argument_list|(
literal|1
argument_list|)
argument_list|,
literal|"loaded"
argument_list|)
expr_stmt|;
comment|/* 	 * Obtain ns and soa counts for top of zone. 	 */
name|nscount
operator|=
literal|0
expr_stmt|;
name|soacount
operator|=
literal|0
expr_stmt|;
name|INSIST
argument_list|(
name|db
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|result
operator|=
name|zone_get_from_db
argument_list|(
name|db
argument_list|,
operator|&
name|zone
operator|->
name|origin
argument_list|,
operator|&
name|nscount
argument_list|,
operator|&
name|soacount
argument_list|,
operator|&
name|serial
argument_list|,
operator|&
name|refresh
argument_list|,
operator|&
name|retry
argument_list|,
operator|&
name|expire
argument_list|,
operator|&
name|minimum
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
block|{
name|dns_zone_log
argument_list|(
name|zone
argument_list|,
name|ISC_LOG_ERROR
argument_list|,
literal|"could not find NS and/or SOA records"
argument_list|)
expr_stmt|;
block|}
comment|/* 	 * Master / Slave / Stub zones require both NS and SOA records at 	 * the top of the zone. 	 */
switch|switch
condition|(
name|zone
operator|->
name|type
condition|)
block|{
case|case
name|dns_zone_master
case|:
case|case
name|dns_zone_slave
case|:
case|case
name|dns_zone_stub
case|:
if|if
condition|(
name|soacount
operator|!=
literal|1
condition|)
block|{
name|dns_zone_log
argument_list|(
name|zone
argument_list|,
name|ISC_LOG_ERROR
argument_list|,
literal|"has %d SOA records"
argument_list|,
name|soacount
argument_list|)
expr_stmt|;
name|result
operator|=
name|DNS_R_BADZONE
expr_stmt|;
block|}
if|if
condition|(
name|nscount
operator|==
literal|0
condition|)
block|{
name|dns_zone_log
argument_list|(
name|zone
argument_list|,
name|ISC_LOG_ERROR
argument_list|,
literal|"has no NS records"
argument_list|)
expr_stmt|;
name|result
operator|=
name|DNS_R_BADZONE
expr_stmt|;
block|}
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
goto|goto
name|cleanup
goto|;
if|if
condition|(
name|zone
operator|->
name|db
operator|!=
name|NULL
condition|)
block|{
comment|/* 			 * This is checked in zone_replacedb() for slave zones 			 * as they don't reload from disk. 			 */
if|if
condition|(
name|DNS_ZONE_OPTION
argument_list|(
name|zone
argument_list|,
name|DNS_ZONEOPT_IXFRFROMDIFFS
argument_list|)
operator|&&
operator|!
name|isc_serial_gt
argument_list|(
name|serial
argument_list|,
name|zone
operator|->
name|serial
argument_list|)
condition|)
block|{
name|isc_uint32_t
name|serialmin
decl_stmt|,
name|serialmax
decl_stmt|;
name|INSIST
argument_list|(
name|zone
operator|->
name|type
operator|==
name|dns_zone_master
argument_list|)
expr_stmt|;
name|serialmin
operator|=
operator|(
name|zone
operator|->
name|serial
operator|+
literal|1
operator|)
operator|&
literal|0xffffffffU
expr_stmt|;
name|serialmax
operator|=
operator|(
name|zone
operator|->
name|serial
operator|+
literal|0x7fffffffU
operator|)
operator|&
literal|0xffffffffU
expr_stmt|;
name|dns_zone_log
argument_list|(
name|zone
argument_list|,
name|ISC_LOG_ERROR
argument_list|,
literal|"ixfr-from-differences: "
literal|"new serial (%u) out of range "
literal|"[%u - %u]"
argument_list|,
name|serial
argument_list|,
name|serialmin
argument_list|,
name|serialmax
argument_list|)
expr_stmt|;
name|result
operator|=
name|DNS_R_BADZONE
expr_stmt|;
goto|goto
name|cleanup
goto|;
block|}
elseif|else
if|if
condition|(
operator|!
name|isc_serial_ge
argument_list|(
name|serial
argument_list|,
name|zone
operator|->
name|serial
argument_list|)
condition|)
name|dns_zone_log
argument_list|(
name|zone
argument_list|,
name|ISC_LOG_ERROR
argument_list|,
literal|"zone serial has gone backwards"
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|serial
operator|==
name|zone
operator|->
name|serial
operator|&&
operator|!
name|hasinclude
condition|)
name|dns_zone_log
argument_list|(
name|zone
argument_list|,
name|ISC_LOG_ERROR
argument_list|,
literal|"zone serial unchanged"
argument_list|)
expr_stmt|;
block|}
name|zone
operator|->
name|serial
operator|=
name|serial
expr_stmt|;
name|zone
operator|->
name|refresh
operator|=
name|RANGE
argument_list|(
name|refresh
argument_list|,
name|zone
operator|->
name|minrefresh
argument_list|,
name|zone
operator|->
name|maxrefresh
argument_list|)
expr_stmt|;
name|zone
operator|->
name|retry
operator|=
name|RANGE
argument_list|(
name|retry
argument_list|,
name|zone
operator|->
name|minretry
argument_list|,
name|zone
operator|->
name|maxretry
argument_list|)
expr_stmt|;
name|zone
operator|->
name|expire
operator|=
name|RANGE
argument_list|(
name|expire
argument_list|,
name|zone
operator|->
name|refresh
operator|+
name|zone
operator|->
name|retry
argument_list|,
name|DNS_MAX_EXPIRE
argument_list|)
expr_stmt|;
name|zone
operator|->
name|minimum
operator|=
name|minimum
expr_stmt|;
name|DNS_ZONE_SETFLAG
argument_list|(
name|zone
argument_list|,
name|DNS_ZONEFLG_HAVETIMERS
argument_list|)
expr_stmt|;
if|if
condition|(
name|zone
operator|->
name|type
operator|==
name|dns_zone_slave
operator|||
name|zone
operator|->
name|type
operator|==
name|dns_zone_stub
condition|)
block|{
name|isc_time_t
name|t
decl_stmt|;
name|isc_uint32_t
name|delay
decl_stmt|;
name|result
operator|=
name|isc_file_getmodtime
argument_list|(
name|zone
operator|->
name|journal
argument_list|,
operator|&
name|t
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
name|result
operator|=
name|isc_file_getmodtime
argument_list|(
name|zone
operator|->
name|masterfile
argument_list|,
operator|&
name|t
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|==
name|ISC_R_SUCCESS
condition|)
name|DNS_ZONE_TIME_ADD
argument_list|(
operator|&
name|t
argument_list|,
name|zone
operator|->
name|expire
argument_list|,
operator|&
name|zone
operator|->
name|expiretime
argument_list|)
expr_stmt|;
else|else
name|DNS_ZONE_TIME_ADD
argument_list|(
operator|&
name|now
argument_list|,
name|zone
operator|->
name|retry
argument_list|,
operator|&
name|zone
operator|->
name|expiretime
argument_list|)
expr_stmt|;
name|delay
operator|=
name|isc_random_jitter
argument_list|(
name|zone
operator|->
name|retry
argument_list|,
operator|(
name|zone
operator|->
name|retry
operator|*
literal|3
operator|)
operator|/
literal|4
argument_list|)
expr_stmt|;
name|DNS_ZONE_TIME_ADD
argument_list|(
operator|&
name|now
argument_list|,
name|delay
argument_list|,
operator|&
name|zone
operator|->
name|refreshtime
argument_list|)
expr_stmt|;
if|if
condition|(
name|isc_time_compare
argument_list|(
operator|&
name|zone
operator|->
name|refreshtime
argument_list|,
operator|&
name|zone
operator|->
name|expiretime
argument_list|)
operator|>=
literal|0
condition|)
name|zone
operator|->
name|refreshtime
operator|=
name|now
expr_stmt|;
block|}
break|break;
default|default:
name|UNEXPECTED_ERROR
argument_list|(
name|__FILE__
argument_list|,
name|__LINE__
argument_list|,
literal|"unexpected zone type %d"
argument_list|,
name|zone
operator|->
name|type
argument_list|)
expr_stmt|;
name|result
operator|=
name|ISC_R_UNEXPECTED
expr_stmt|;
goto|goto
name|cleanup
goto|;
block|}
comment|/* 	 * Check for weak DNSKEY's. 	 */
if|if
condition|(
name|zone
operator|->
name|type
operator|==
name|dns_zone_master
condition|)
name|zone_check_dnskeys
argument_list|(
name|zone
argument_list|,
name|db
argument_list|)
expr_stmt|;
if|#
directive|if
literal|0
comment|/* destroy notification example. */
block|{ 		isc_event_t *e = isc_event_allocate(zone->mctx, NULL, 						    DNS_EVENT_DBDESTROYED, 						    dns_zonemgr_dbdestroyed, 						    zone, 						    sizeof(isc_event_t)); 		dns_db_ondestroy(db, zone->task,&e); 	}
endif|#
directive|endif
if|if
condition|(
name|zone
operator|->
name|db
operator|!=
name|NULL
condition|)
block|{
name|result
operator|=
name|zone_replacedb
argument_list|(
name|zone
argument_list|,
name|db
argument_list|,
name|ISC_FALSE
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
goto|goto
name|cleanup
goto|;
block|}
else|else
block|{
name|dns_db_attach
argument_list|(
name|db
argument_list|,
operator|&
name|zone
operator|->
name|db
argument_list|)
expr_stmt|;
name|DNS_ZONE_SETFLAG
argument_list|(
name|zone
argument_list|,
name|DNS_ZONEFLG_LOADED
operator||
name|DNS_ZONEFLG_NEEDNOTIFY
argument_list|)
expr_stmt|;
block|}
name|result
operator|=
name|ISC_R_SUCCESS
expr_stmt|;
if|if
condition|(
name|needdump
condition|)
name|zone_needdump
argument_list|(
name|zone
argument_list|,
name|DNS_DUMP_DELAY
argument_list|)
expr_stmt|;
if|if
condition|(
name|zone
operator|->
name|task
operator|!=
name|NULL
condition|)
name|zone_settimer
argument_list|(
name|zone
argument_list|,
operator|&
name|now
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|dns_db_ispersistent
argument_list|(
name|db
argument_list|)
condition|)
name|dns_zone_log
argument_list|(
name|zone
argument_list|,
name|ISC_LOG_INFO
argument_list|,
literal|"loaded serial %u%s"
argument_list|,
name|zone
operator|->
name|serial
argument_list|,
name|dns_db_issecure
argument_list|(
name|db
argument_list|)
condition|?
literal|" (signed)"
else|:
literal|""
argument_list|)
expr_stmt|;
return|return
operator|(
name|result
operator|)
return|;
name|cleanup
label|:
if|if
condition|(
name|zone
operator|->
name|type
operator|==
name|dns_zone_slave
operator|||
name|zone
operator|->
name|type
operator|==
name|dns_zone_stub
condition|)
block|{
if|if
condition|(
name|zone
operator|->
name|journal
operator|!=
name|NULL
condition|)
name|zone_saveunique
argument_list|(
name|zone
argument_list|,
name|zone
operator|->
name|journal
argument_list|,
literal|"jn-XXXXXXXX"
argument_list|)
expr_stmt|;
if|if
condition|(
name|zone
operator|->
name|masterfile
operator|!=
name|NULL
condition|)
name|zone_saveunique
argument_list|(
name|zone
argument_list|,
name|zone
operator|->
name|masterfile
argument_list|,
literal|"db-XXXXXXXX"
argument_list|)
expr_stmt|;
comment|/* Mark the zone for immediate refresh. */
name|zone
operator|->
name|refreshtime
operator|=
name|now
expr_stmt|;
if|if
condition|(
name|zone
operator|->
name|task
operator|!=
name|NULL
condition|)
name|zone_settimer
argument_list|(
name|zone
argument_list|,
operator|&
name|now
argument_list|)
expr_stmt|;
name|result
operator|=
name|ISC_R_SUCCESS
expr_stmt|;
block|}
return|return
operator|(
name|result
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|isc_boolean_t
name|exit_check
parameter_list|(
name|dns_zone_t
modifier|*
name|zone
parameter_list|)
block|{
name|REQUIRE
argument_list|(
name|LOCKED_ZONE
argument_list|(
name|zone
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|DNS_ZONE_FLAG
argument_list|(
name|zone
argument_list|,
name|DNS_ZONEFLG_SHUTDOWN
argument_list|)
operator|&&
name|zone
operator|->
name|irefs
operator|==
literal|0
condition|)
block|{
comment|/* 		 * DNS_ZONEFLG_SHUTDOWN can only be set if erefs == 0. 		 */
name|INSIST
argument_list|(
name|isc_refcount_current
argument_list|(
operator|&
name|zone
operator|->
name|erefs
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
return|return
operator|(
name|ISC_TRUE
operator|)
return|;
block|}
return|return
operator|(
name|ISC_FALSE
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|isc_result_t
name|zone_count_ns_rr
parameter_list|(
name|dns_db_t
modifier|*
name|db
parameter_list|,
name|dns_dbnode_t
modifier|*
name|node
parameter_list|,
name|dns_dbversion_t
modifier|*
name|version
parameter_list|,
name|unsigned
name|int
modifier|*
name|nscount
parameter_list|)
block|{
name|isc_result_t
name|result
decl_stmt|;
name|unsigned
name|int
name|count
decl_stmt|;
name|dns_rdataset_t
name|rdataset
decl_stmt|;
name|REQUIRE
argument_list|(
name|nscount
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|dns_rdataset_init
argument_list|(
operator|&
name|rdataset
argument_list|)
expr_stmt|;
name|result
operator|=
name|dns_db_findrdataset
argument_list|(
name|db
argument_list|,
name|node
argument_list|,
name|version
argument_list|,
name|dns_rdatatype_ns
argument_list|,
name|dns_rdatatype_none
argument_list|,
literal|0
argument_list|,
operator|&
name|rdataset
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|==
name|ISC_R_NOTFOUND
condition|)
block|{
operator|*
name|nscount
operator|=
literal|0
expr_stmt|;
name|result
operator|=
name|ISC_R_SUCCESS
expr_stmt|;
goto|goto
name|invalidate_rdataset
goto|;
block|}
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
goto|goto
name|invalidate_rdataset
goto|;
name|count
operator|=
literal|0
expr_stmt|;
name|result
operator|=
name|dns_rdataset_first
argument_list|(
operator|&
name|rdataset
argument_list|)
expr_stmt|;
while|while
condition|(
name|result
operator|==
name|ISC_R_SUCCESS
condition|)
block|{
name|count
operator|++
expr_stmt|;
name|result
operator|=
name|dns_rdataset_next
argument_list|(
operator|&
name|rdataset
argument_list|)
expr_stmt|;
block|}
name|dns_rdataset_disassociate
argument_list|(
operator|&
name|rdataset
argument_list|)
expr_stmt|;
operator|*
name|nscount
operator|=
name|count
expr_stmt|;
name|result
operator|=
name|ISC_R_SUCCESS
expr_stmt|;
name|invalidate_rdataset
label|:
name|dns_rdataset_invalidate
argument_list|(
operator|&
name|rdataset
argument_list|)
expr_stmt|;
return|return
operator|(
name|result
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|isc_result_t
name|zone_load_soa_rr
parameter_list|(
name|dns_db_t
modifier|*
name|db
parameter_list|,
name|dns_dbnode_t
modifier|*
name|node
parameter_list|,
name|dns_dbversion_t
modifier|*
name|version
parameter_list|,
name|unsigned
name|int
modifier|*
name|soacount
parameter_list|,
name|isc_uint32_t
modifier|*
name|serial
parameter_list|,
name|isc_uint32_t
modifier|*
name|refresh
parameter_list|,
name|isc_uint32_t
modifier|*
name|retry
parameter_list|,
name|isc_uint32_t
modifier|*
name|expire
parameter_list|,
name|isc_uint32_t
modifier|*
name|minimum
parameter_list|)
block|{
name|isc_result_t
name|result
decl_stmt|;
name|unsigned
name|int
name|count
decl_stmt|;
name|dns_rdataset_t
name|rdataset
decl_stmt|;
name|dns_rdata_t
name|rdata
init|=
name|DNS_RDATA_INIT
decl_stmt|;
name|dns_rdata_soa_t
name|soa
decl_stmt|;
name|dns_rdataset_init
argument_list|(
operator|&
name|rdataset
argument_list|)
expr_stmt|;
name|result
operator|=
name|dns_db_findrdataset
argument_list|(
name|db
argument_list|,
name|node
argument_list|,
name|version
argument_list|,
name|dns_rdatatype_soa
argument_list|,
name|dns_rdatatype_none
argument_list|,
literal|0
argument_list|,
operator|&
name|rdataset
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|==
name|ISC_R_NOTFOUND
condition|)
block|{
if|if
condition|(
name|soacount
operator|!=
name|NULL
condition|)
operator|*
name|soacount
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|serial
operator|!=
name|NULL
condition|)
operator|*
name|serial
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|refresh
operator|!=
name|NULL
condition|)
operator|*
name|refresh
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|retry
operator|!=
name|NULL
condition|)
operator|*
name|retry
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|expire
operator|!=
name|NULL
condition|)
operator|*
name|expire
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|minimum
operator|!=
name|NULL
condition|)
operator|*
name|minimum
operator|=
literal|0
expr_stmt|;
name|result
operator|=
name|ISC_R_SUCCESS
expr_stmt|;
goto|goto
name|invalidate_rdataset
goto|;
block|}
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
goto|goto
name|invalidate_rdataset
goto|;
name|count
operator|=
literal|0
expr_stmt|;
name|result
operator|=
name|dns_rdataset_first
argument_list|(
operator|&
name|rdataset
argument_list|)
expr_stmt|;
while|while
condition|(
name|result
operator|==
name|ISC_R_SUCCESS
condition|)
block|{
name|dns_rdata_init
argument_list|(
operator|&
name|rdata
argument_list|)
expr_stmt|;
name|dns_rdataset_current
argument_list|(
operator|&
name|rdataset
argument_list|,
operator|&
name|rdata
argument_list|)
expr_stmt|;
name|count
operator|++
expr_stmt|;
if|if
condition|(
name|count
operator|==
literal|1
condition|)
block|{
name|result
operator|=
name|dns_rdata_tostruct
argument_list|(
operator|&
name|rdata
argument_list|,
operator|&
name|soa
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|RUNTIME_CHECK
argument_list|(
name|result
operator|==
name|ISC_R_SUCCESS
argument_list|)
expr_stmt|;
block|}
name|result
operator|=
name|dns_rdataset_next
argument_list|(
operator|&
name|rdataset
argument_list|)
expr_stmt|;
name|dns_rdata_reset
argument_list|(
operator|&
name|rdata
argument_list|)
expr_stmt|;
block|}
name|dns_rdataset_disassociate
argument_list|(
operator|&
name|rdataset
argument_list|)
expr_stmt|;
if|if
condition|(
name|soacount
operator|!=
name|NULL
condition|)
operator|*
name|soacount
operator|=
name|count
expr_stmt|;
if|if
condition|(
name|count
operator|>
literal|0
condition|)
block|{
if|if
condition|(
name|serial
operator|!=
name|NULL
condition|)
operator|*
name|serial
operator|=
name|soa
operator|.
name|serial
expr_stmt|;
if|if
condition|(
name|refresh
operator|!=
name|NULL
condition|)
operator|*
name|refresh
operator|=
name|soa
operator|.
name|refresh
expr_stmt|;
if|if
condition|(
name|retry
operator|!=
name|NULL
condition|)
operator|*
name|retry
operator|=
name|soa
operator|.
name|retry
expr_stmt|;
if|if
condition|(
name|expire
operator|!=
name|NULL
condition|)
operator|*
name|expire
operator|=
name|soa
operator|.
name|expire
expr_stmt|;
if|if
condition|(
name|minimum
operator|!=
name|NULL
condition|)
operator|*
name|minimum
operator|=
name|soa
operator|.
name|minimum
expr_stmt|;
block|}
name|result
operator|=
name|ISC_R_SUCCESS
expr_stmt|;
name|invalidate_rdataset
label|:
name|dns_rdataset_invalidate
argument_list|(
operator|&
name|rdataset
argument_list|)
expr_stmt|;
return|return
operator|(
name|result
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * zone must be locked.  */
end_comment

begin_function
specifier|static
name|isc_result_t
name|zone_get_from_db
parameter_list|(
name|dns_db_t
modifier|*
name|db
parameter_list|,
name|dns_name_t
modifier|*
name|origin
parameter_list|,
name|unsigned
name|int
modifier|*
name|nscount
parameter_list|,
name|unsigned
name|int
modifier|*
name|soacount
parameter_list|,
name|isc_uint32_t
modifier|*
name|serial
parameter_list|,
name|isc_uint32_t
modifier|*
name|refresh
parameter_list|,
name|isc_uint32_t
modifier|*
name|retry
parameter_list|,
name|isc_uint32_t
modifier|*
name|expire
parameter_list|,
name|isc_uint32_t
modifier|*
name|minimum
parameter_list|)
block|{
name|dns_dbversion_t
modifier|*
name|version
decl_stmt|;
name|isc_result_t
name|result
decl_stmt|;
name|isc_result_t
name|answer
init|=
name|ISC_R_SUCCESS
decl_stmt|;
name|dns_dbnode_t
modifier|*
name|node
decl_stmt|;
name|REQUIRE
argument_list|(
name|db
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|REQUIRE
argument_list|(
name|origin
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|version
operator|=
name|NULL
expr_stmt|;
name|dns_db_currentversion
argument_list|(
name|db
argument_list|,
operator|&
name|version
argument_list|)
expr_stmt|;
name|node
operator|=
name|NULL
expr_stmt|;
name|result
operator|=
name|dns_db_findnode
argument_list|(
name|db
argument_list|,
name|origin
argument_list|,
name|ISC_FALSE
argument_list|,
operator|&
name|node
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
block|{
name|answer
operator|=
name|result
expr_stmt|;
goto|goto
name|closeversion
goto|;
block|}
if|if
condition|(
name|nscount
operator|!=
name|NULL
condition|)
block|{
name|result
operator|=
name|zone_count_ns_rr
argument_list|(
name|db
argument_list|,
name|node
argument_list|,
name|version
argument_list|,
name|nscount
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
name|answer
operator|=
name|result
expr_stmt|;
block|}
if|if
condition|(
name|soacount
operator|!=
name|NULL
operator|||
name|serial
operator|!=
name|NULL
operator|||
name|refresh
operator|!=
name|NULL
operator|||
name|retry
operator|!=
name|NULL
operator|||
name|expire
operator|!=
name|NULL
operator|||
name|minimum
operator|!=
name|NULL
condition|)
block|{
name|result
operator|=
name|zone_load_soa_rr
argument_list|(
name|db
argument_list|,
name|node
argument_list|,
name|version
argument_list|,
name|soacount
argument_list|,
name|serial
argument_list|,
name|refresh
argument_list|,
name|retry
argument_list|,
name|expire
argument_list|,
name|minimum
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
name|answer
operator|=
name|result
expr_stmt|;
block|}
name|dns_db_detachnode
argument_list|(
name|db
argument_list|,
operator|&
name|node
argument_list|)
expr_stmt|;
name|closeversion
label|:
name|dns_db_closeversion
argument_list|(
name|db
argument_list|,
operator|&
name|version
argument_list|,
name|ISC_FALSE
argument_list|)
expr_stmt|;
return|return
operator|(
name|answer
operator|)
return|;
block|}
end_function

begin_function
name|void
name|dns_zone_attach
parameter_list|(
name|dns_zone_t
modifier|*
name|source
parameter_list|,
name|dns_zone_t
modifier|*
modifier|*
name|target
parameter_list|)
block|{
name|REQUIRE
argument_list|(
name|DNS_ZONE_VALID
argument_list|(
name|source
argument_list|)
argument_list|)
expr_stmt|;
name|REQUIRE
argument_list|(
name|target
operator|!=
name|NULL
operator|&&
operator|*
name|target
operator|==
name|NULL
argument_list|)
expr_stmt|;
name|isc_refcount_increment
argument_list|(
operator|&
name|source
operator|->
name|erefs
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
operator|*
name|target
operator|=
name|source
expr_stmt|;
block|}
end_function

begin_function
name|void
name|dns_zone_detach
parameter_list|(
name|dns_zone_t
modifier|*
modifier|*
name|zonep
parameter_list|)
block|{
name|dns_zone_t
modifier|*
name|zone
decl_stmt|;
name|unsigned
name|int
name|refs
decl_stmt|;
name|isc_boolean_t
name|free_now
init|=
name|ISC_FALSE
decl_stmt|;
name|REQUIRE
argument_list|(
name|zonep
operator|!=
name|NULL
operator|&&
name|DNS_ZONE_VALID
argument_list|(
operator|*
name|zonep
argument_list|)
argument_list|)
expr_stmt|;
name|zone
operator|=
operator|*
name|zonep
expr_stmt|;
name|isc_refcount_decrement
argument_list|(
operator|&
name|zone
operator|->
name|erefs
argument_list|,
operator|&
name|refs
argument_list|)
expr_stmt|;
if|if
condition|(
name|refs
operator|==
literal|0
condition|)
block|{
name|LOCK_ZONE
argument_list|(
name|zone
argument_list|)
expr_stmt|;
comment|/* 		 * We just detached the last external reference. 		 */
if|if
condition|(
name|zone
operator|->
name|task
operator|!=
name|NULL
condition|)
block|{
comment|/* 			 * This zone is being managed.  Post 			 * its control event and let it clean 			 * up synchronously in the context of 			 * its task. 			 */
name|isc_event_t
modifier|*
name|ev
init|=
operator|&
name|zone
operator|->
name|ctlevent
decl_stmt|;
name|isc_task_send
argument_list|(
name|zone
operator|->
name|task
argument_list|,
operator|&
name|ev
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|/* 			 * This zone is not being managed; it has 			 * no task and can have no outstanding 			 * events.  Free it immediately. 			 */
comment|/* 			 * Unmanaged zones should not have non-null views; 			 * we have no way of detaching from the view here 			 * without causing deadlock because this code is called 			 * with the view already locked. 			 */
name|INSIST
argument_list|(
name|zone
operator|->
name|view
operator|==
name|NULL
argument_list|)
expr_stmt|;
name|free_now
operator|=
name|ISC_TRUE
expr_stmt|;
block|}
name|UNLOCK_ZONE
argument_list|(
name|zone
argument_list|)
expr_stmt|;
block|}
operator|*
name|zonep
operator|=
name|NULL
expr_stmt|;
if|if
condition|(
name|free_now
condition|)
name|zone_free
argument_list|(
name|zone
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|dns_zone_iattach
parameter_list|(
name|dns_zone_t
modifier|*
name|source
parameter_list|,
name|dns_zone_t
modifier|*
modifier|*
name|target
parameter_list|)
block|{
name|REQUIRE
argument_list|(
name|DNS_ZONE_VALID
argument_list|(
name|source
argument_list|)
argument_list|)
expr_stmt|;
name|REQUIRE
argument_list|(
name|target
operator|!=
name|NULL
operator|&&
operator|*
name|target
operator|==
name|NULL
argument_list|)
expr_stmt|;
name|LOCK_ZONE
argument_list|(
name|source
argument_list|)
expr_stmt|;
name|zone_iattach
argument_list|(
name|source
argument_list|,
name|target
argument_list|)
expr_stmt|;
name|UNLOCK_ZONE
argument_list|(
name|source
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|zone_iattach
parameter_list|(
name|dns_zone_t
modifier|*
name|source
parameter_list|,
name|dns_zone_t
modifier|*
modifier|*
name|target
parameter_list|)
block|{
comment|/* 	 * 'source' locked by caller. 	 */
name|REQUIRE
argument_list|(
name|LOCKED_ZONE
argument_list|(
name|source
argument_list|)
argument_list|)
expr_stmt|;
name|REQUIRE
argument_list|(
name|DNS_ZONE_VALID
argument_list|(
name|source
argument_list|)
argument_list|)
expr_stmt|;
name|REQUIRE
argument_list|(
name|target
operator|!=
name|NULL
operator|&&
operator|*
name|target
operator|==
name|NULL
argument_list|)
expr_stmt|;
name|INSIST
argument_list|(
name|source
operator|->
name|irefs
operator|+
name|isc_refcount_current
argument_list|(
operator|&
name|source
operator|->
name|erefs
argument_list|)
operator|>
literal|0
argument_list|)
expr_stmt|;
name|source
operator|->
name|irefs
operator|++
expr_stmt|;
name|INSIST
argument_list|(
name|source
operator|->
name|irefs
operator|!=
literal|0
argument_list|)
expr_stmt|;
operator|*
name|target
operator|=
name|source
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|zone_idetach
parameter_list|(
name|dns_zone_t
modifier|*
modifier|*
name|zonep
parameter_list|)
block|{
name|dns_zone_t
modifier|*
name|zone
decl_stmt|;
comment|/* 	 * 'zone' locked by caller. 	 */
name|REQUIRE
argument_list|(
name|zonep
operator|!=
name|NULL
operator|&&
name|DNS_ZONE_VALID
argument_list|(
operator|*
name|zonep
argument_list|)
argument_list|)
expr_stmt|;
name|zone
operator|=
operator|*
name|zonep
expr_stmt|;
name|REQUIRE
argument_list|(
name|LOCKED_ZONE
argument_list|(
operator|*
name|zonep
argument_list|)
argument_list|)
expr_stmt|;
operator|*
name|zonep
operator|=
name|NULL
expr_stmt|;
name|INSIST
argument_list|(
name|zone
operator|->
name|irefs
operator|>
literal|0
argument_list|)
expr_stmt|;
name|zone
operator|->
name|irefs
operator|--
expr_stmt|;
name|INSIST
argument_list|(
name|zone
operator|->
name|irefs
operator|+
name|isc_refcount_current
argument_list|(
operator|&
name|zone
operator|->
name|erefs
argument_list|)
operator|>
literal|0
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|dns_zone_idetach
parameter_list|(
name|dns_zone_t
modifier|*
modifier|*
name|zonep
parameter_list|)
block|{
name|dns_zone_t
modifier|*
name|zone
decl_stmt|;
name|isc_boolean_t
name|free_needed
decl_stmt|;
name|REQUIRE
argument_list|(
name|zonep
operator|!=
name|NULL
operator|&&
name|DNS_ZONE_VALID
argument_list|(
operator|*
name|zonep
argument_list|)
argument_list|)
expr_stmt|;
name|zone
operator|=
operator|*
name|zonep
expr_stmt|;
operator|*
name|zonep
operator|=
name|NULL
expr_stmt|;
name|LOCK_ZONE
argument_list|(
name|zone
argument_list|)
expr_stmt|;
name|INSIST
argument_list|(
name|zone
operator|->
name|irefs
operator|>
literal|0
argument_list|)
expr_stmt|;
name|zone
operator|->
name|irefs
operator|--
expr_stmt|;
name|free_needed
operator|=
name|exit_check
argument_list|(
name|zone
argument_list|)
expr_stmt|;
name|UNLOCK_ZONE
argument_list|(
name|zone
argument_list|)
expr_stmt|;
if|if
condition|(
name|free_needed
condition|)
name|zone_free
argument_list|(
name|zone
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|isc_mem_t
modifier|*
name|dns_zone_getmctx
parameter_list|(
name|dns_zone_t
modifier|*
name|zone
parameter_list|)
block|{
name|REQUIRE
argument_list|(
name|DNS_ZONE_VALID
argument_list|(
name|zone
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|(
name|zone
operator|->
name|mctx
operator|)
return|;
block|}
end_function

begin_function
name|dns_zonemgr_t
modifier|*
name|dns_zone_getmgr
parameter_list|(
name|dns_zone_t
modifier|*
name|zone
parameter_list|)
block|{
name|REQUIRE
argument_list|(
name|DNS_ZONE_VALID
argument_list|(
name|zone
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|(
name|zone
operator|->
name|zmgr
operator|)
return|;
block|}
end_function

begin_function
name|void
name|dns_zone_setflag
parameter_list|(
name|dns_zone_t
modifier|*
name|zone
parameter_list|,
name|unsigned
name|int
name|flags
parameter_list|,
name|isc_boolean_t
name|value
parameter_list|)
block|{
name|REQUIRE
argument_list|(
name|DNS_ZONE_VALID
argument_list|(
name|zone
argument_list|)
argument_list|)
expr_stmt|;
name|LOCK_ZONE
argument_list|(
name|zone
argument_list|)
expr_stmt|;
if|if
condition|(
name|value
condition|)
name|DNS_ZONE_SETFLAG
argument_list|(
name|zone
argument_list|,
name|flags
argument_list|)
expr_stmt|;
else|else
name|DNS_ZONE_CLRFLAG
argument_list|(
name|zone
argument_list|,
name|flags
argument_list|)
expr_stmt|;
name|UNLOCK_ZONE
argument_list|(
name|zone
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|dns_zone_setoption
parameter_list|(
name|dns_zone_t
modifier|*
name|zone
parameter_list|,
name|unsigned
name|int
name|option
parameter_list|,
name|isc_boolean_t
name|value
parameter_list|)
block|{
name|REQUIRE
argument_list|(
name|DNS_ZONE_VALID
argument_list|(
name|zone
argument_list|)
argument_list|)
expr_stmt|;
name|LOCK_ZONE
argument_list|(
name|zone
argument_list|)
expr_stmt|;
if|if
condition|(
name|value
condition|)
name|zone
operator|->
name|options
operator||=
name|option
expr_stmt|;
else|else
name|zone
operator|->
name|options
operator|&=
operator|~
name|option
expr_stmt|;
name|UNLOCK_ZONE
argument_list|(
name|zone
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|unsigned
name|int
name|dns_zone_getoptions
parameter_list|(
name|dns_zone_t
modifier|*
name|zone
parameter_list|)
block|{
name|REQUIRE
argument_list|(
name|DNS_ZONE_VALID
argument_list|(
name|zone
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|(
name|zone
operator|->
name|options
operator|)
return|;
block|}
end_function

begin_function
name|isc_result_t
name|dns_zone_setxfrsource4
parameter_list|(
name|dns_zone_t
modifier|*
name|zone
parameter_list|,
specifier|const
name|isc_sockaddr_t
modifier|*
name|xfrsource
parameter_list|)
block|{
name|REQUIRE
argument_list|(
name|DNS_ZONE_VALID
argument_list|(
name|zone
argument_list|)
argument_list|)
expr_stmt|;
name|LOCK_ZONE
argument_list|(
name|zone
argument_list|)
expr_stmt|;
name|zone
operator|->
name|xfrsource4
operator|=
operator|*
name|xfrsource
expr_stmt|;
name|UNLOCK_ZONE
argument_list|(
name|zone
argument_list|)
expr_stmt|;
return|return
operator|(
name|ISC_R_SUCCESS
operator|)
return|;
block|}
end_function

begin_function
name|isc_sockaddr_t
modifier|*
name|dns_zone_getxfrsource4
parameter_list|(
name|dns_zone_t
modifier|*
name|zone
parameter_list|)
block|{
name|REQUIRE
argument_list|(
name|DNS_ZONE_VALID
argument_list|(
name|zone
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|(
operator|&
name|zone
operator|->
name|xfrsource4
operator|)
return|;
block|}
end_function

begin_function
name|isc_result_t
name|dns_zone_setxfrsource6
parameter_list|(
name|dns_zone_t
modifier|*
name|zone
parameter_list|,
specifier|const
name|isc_sockaddr_t
modifier|*
name|xfrsource
parameter_list|)
block|{
name|REQUIRE
argument_list|(
name|DNS_ZONE_VALID
argument_list|(
name|zone
argument_list|)
argument_list|)
expr_stmt|;
name|LOCK_ZONE
argument_list|(
name|zone
argument_list|)
expr_stmt|;
name|zone
operator|->
name|xfrsource6
operator|=
operator|*
name|xfrsource
expr_stmt|;
name|UNLOCK_ZONE
argument_list|(
name|zone
argument_list|)
expr_stmt|;
return|return
operator|(
name|ISC_R_SUCCESS
operator|)
return|;
block|}
end_function

begin_function
name|isc_sockaddr_t
modifier|*
name|dns_zone_getxfrsource6
parameter_list|(
name|dns_zone_t
modifier|*
name|zone
parameter_list|)
block|{
name|REQUIRE
argument_list|(
name|DNS_ZONE_VALID
argument_list|(
name|zone
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|(
operator|&
name|zone
operator|->
name|xfrsource6
operator|)
return|;
block|}
end_function

begin_function
name|isc_result_t
name|dns_zone_setaltxfrsource4
parameter_list|(
name|dns_zone_t
modifier|*
name|zone
parameter_list|,
specifier|const
name|isc_sockaddr_t
modifier|*
name|altxfrsource
parameter_list|)
block|{
name|REQUIRE
argument_list|(
name|DNS_ZONE_VALID
argument_list|(
name|zone
argument_list|)
argument_list|)
expr_stmt|;
name|LOCK_ZONE
argument_list|(
name|zone
argument_list|)
expr_stmt|;
name|zone
operator|->
name|altxfrsource4
operator|=
operator|*
name|altxfrsource
expr_stmt|;
name|UNLOCK_ZONE
argument_list|(
name|zone
argument_list|)
expr_stmt|;
return|return
operator|(
name|ISC_R_SUCCESS
operator|)
return|;
block|}
end_function

begin_function
name|isc_sockaddr_t
modifier|*
name|dns_zone_getaltxfrsource4
parameter_list|(
name|dns_zone_t
modifier|*
name|zone
parameter_list|)
block|{
name|REQUIRE
argument_list|(
name|DNS_ZONE_VALID
argument_list|(
name|zone
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|(
operator|&
name|zone
operator|->
name|altxfrsource4
operator|)
return|;
block|}
end_function

begin_function
name|isc_result_t
name|dns_zone_setaltxfrsource6
parameter_list|(
name|dns_zone_t
modifier|*
name|zone
parameter_list|,
specifier|const
name|isc_sockaddr_t
modifier|*
name|altxfrsource
parameter_list|)
block|{
name|REQUIRE
argument_list|(
name|DNS_ZONE_VALID
argument_list|(
name|zone
argument_list|)
argument_list|)
expr_stmt|;
name|LOCK_ZONE
argument_list|(
name|zone
argument_list|)
expr_stmt|;
name|zone
operator|->
name|altxfrsource6
operator|=
operator|*
name|altxfrsource
expr_stmt|;
name|UNLOCK_ZONE
argument_list|(
name|zone
argument_list|)
expr_stmt|;
return|return
operator|(
name|ISC_R_SUCCESS
operator|)
return|;
block|}
end_function

begin_function
name|isc_sockaddr_t
modifier|*
name|dns_zone_getaltxfrsource6
parameter_list|(
name|dns_zone_t
modifier|*
name|zone
parameter_list|)
block|{
name|REQUIRE
argument_list|(
name|DNS_ZONE_VALID
argument_list|(
name|zone
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|(
operator|&
name|zone
operator|->
name|altxfrsource6
operator|)
return|;
block|}
end_function

begin_function
name|isc_result_t
name|dns_zone_setnotifysrc4
parameter_list|(
name|dns_zone_t
modifier|*
name|zone
parameter_list|,
specifier|const
name|isc_sockaddr_t
modifier|*
name|notifysrc
parameter_list|)
block|{
name|REQUIRE
argument_list|(
name|DNS_ZONE_VALID
argument_list|(
name|zone
argument_list|)
argument_list|)
expr_stmt|;
name|LOCK_ZONE
argument_list|(
name|zone
argument_list|)
expr_stmt|;
name|zone
operator|->
name|notifysrc4
operator|=
operator|*
name|notifysrc
expr_stmt|;
name|UNLOCK_ZONE
argument_list|(
name|zone
argument_list|)
expr_stmt|;
return|return
operator|(
name|ISC_R_SUCCESS
operator|)
return|;
block|}
end_function

begin_function
name|isc_sockaddr_t
modifier|*
name|dns_zone_getnotifysrc4
parameter_list|(
name|dns_zone_t
modifier|*
name|zone
parameter_list|)
block|{
name|REQUIRE
argument_list|(
name|DNS_ZONE_VALID
argument_list|(
name|zone
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|(
operator|&
name|zone
operator|->
name|notifysrc4
operator|)
return|;
block|}
end_function

begin_function
name|isc_result_t
name|dns_zone_setnotifysrc6
parameter_list|(
name|dns_zone_t
modifier|*
name|zone
parameter_list|,
specifier|const
name|isc_sockaddr_t
modifier|*
name|notifysrc
parameter_list|)
block|{
name|REQUIRE
argument_list|(
name|DNS_ZONE_VALID
argument_list|(
name|zone
argument_list|)
argument_list|)
expr_stmt|;
name|LOCK_ZONE
argument_list|(
name|zone
argument_list|)
expr_stmt|;
name|zone
operator|->
name|notifysrc6
operator|=
operator|*
name|notifysrc
expr_stmt|;
name|UNLOCK_ZONE
argument_list|(
name|zone
argument_list|)
expr_stmt|;
return|return
operator|(
name|ISC_R_SUCCESS
operator|)
return|;
block|}
end_function

begin_function
name|isc_sockaddr_t
modifier|*
name|dns_zone_getnotifysrc6
parameter_list|(
name|dns_zone_t
modifier|*
name|zone
parameter_list|)
block|{
name|REQUIRE
argument_list|(
name|DNS_ZONE_VALID
argument_list|(
name|zone
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|(
operator|&
name|zone
operator|->
name|notifysrc6
operator|)
return|;
block|}
end_function

begin_function
name|isc_result_t
name|dns_zone_setalsonotify
parameter_list|(
name|dns_zone_t
modifier|*
name|zone
parameter_list|,
specifier|const
name|isc_sockaddr_t
modifier|*
name|notify
parameter_list|,
name|isc_uint32_t
name|count
parameter_list|)
block|{
name|isc_sockaddr_t
modifier|*
name|new
decl_stmt|;
name|REQUIRE
argument_list|(
name|DNS_ZONE_VALID
argument_list|(
name|zone
argument_list|)
argument_list|)
expr_stmt|;
name|REQUIRE
argument_list|(
name|count
operator|==
literal|0
operator|||
name|notify
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|LOCK_ZONE
argument_list|(
name|zone
argument_list|)
expr_stmt|;
if|if
condition|(
name|zone
operator|->
name|notify
operator|!=
name|NULL
condition|)
block|{
name|isc_mem_put
argument_list|(
name|zone
operator|->
name|mctx
argument_list|,
name|zone
operator|->
name|notify
argument_list|,
name|zone
operator|->
name|notifycnt
operator|*
sizeof|sizeof
argument_list|(
operator|*
name|new
argument_list|)
argument_list|)
expr_stmt|;
name|zone
operator|->
name|notify
operator|=
name|NULL
expr_stmt|;
name|zone
operator|->
name|notifycnt
operator|=
literal|0
expr_stmt|;
block|}
if|if
condition|(
name|count
operator|!=
literal|0
condition|)
block|{
name|new
operator|=
name|isc_mem_get
argument_list|(
name|zone
operator|->
name|mctx
argument_list|,
name|count
operator|*
sizeof|sizeof
argument_list|(
operator|*
name|new
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|new
operator|==
name|NULL
condition|)
block|{
name|UNLOCK_ZONE
argument_list|(
name|zone
argument_list|)
expr_stmt|;
return|return
operator|(
name|ISC_R_NOMEMORY
operator|)
return|;
block|}
name|memcpy
argument_list|(
name|new
argument_list|,
name|notify
argument_list|,
name|count
operator|*
sizeof|sizeof
argument_list|(
operator|*
name|new
argument_list|)
argument_list|)
expr_stmt|;
name|zone
operator|->
name|notify
operator|=
name|new
expr_stmt|;
name|zone
operator|->
name|notifycnt
operator|=
name|count
expr_stmt|;
block|}
name|UNLOCK_ZONE
argument_list|(
name|zone
argument_list|)
expr_stmt|;
return|return
operator|(
name|ISC_R_SUCCESS
operator|)
return|;
block|}
end_function

begin_function
name|isc_result_t
name|dns_zone_setmasters
parameter_list|(
name|dns_zone_t
modifier|*
name|zone
parameter_list|,
specifier|const
name|isc_sockaddr_t
modifier|*
name|masters
parameter_list|,
name|isc_uint32_t
name|count
parameter_list|)
block|{
name|isc_result_t
name|result
decl_stmt|;
name|result
operator|=
name|dns_zone_setmasterswithkeys
argument_list|(
name|zone
argument_list|,
name|masters
argument_list|,
name|NULL
argument_list|,
name|count
argument_list|)
expr_stmt|;
return|return
operator|(
name|result
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|isc_boolean_t
name|same_masters
parameter_list|(
specifier|const
name|isc_sockaddr_t
modifier|*
name|old
parameter_list|,
specifier|const
name|isc_sockaddr_t
modifier|*
name|new
parameter_list|,
name|isc_uint32_t
name|count
parameter_list|)
block|{
name|unsigned
name|int
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|count
condition|;
name|i
operator|++
control|)
if|if
condition|(
operator|!
name|isc_sockaddr_equal
argument_list|(
operator|&
name|old
index|[
name|i
index|]
argument_list|,
operator|&
name|new
index|[
name|i
index|]
argument_list|)
condition|)
return|return
operator|(
name|ISC_FALSE
operator|)
return|;
return|return
operator|(
name|ISC_TRUE
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|isc_boolean_t
name|same_keynames
parameter_list|(
name|dns_name_t
modifier|*
modifier|*
name|old
parameter_list|,
name|dns_name_t
modifier|*
modifier|*
name|new
parameter_list|,
name|isc_uint32_t
name|count
parameter_list|)
block|{
name|unsigned
name|int
name|i
decl_stmt|;
if|if
condition|(
name|old
operator|==
name|NULL
operator|&&
name|new
operator|==
name|NULL
condition|)
return|return
operator|(
name|ISC_TRUE
operator|)
return|;
if|if
condition|(
name|old
operator|==
name|NULL
operator|||
name|new
operator|==
name|NULL
condition|)
return|return
operator|(
name|ISC_FALSE
operator|)
return|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|count
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|old
index|[
name|i
index|]
operator|==
name|NULL
operator|&&
name|new
index|[
name|i
index|]
operator|==
name|NULL
condition|)
continue|continue;
if|if
condition|(
name|old
index|[
name|i
index|]
operator|==
name|NULL
operator|||
name|new
index|[
name|i
index|]
operator|==
name|NULL
operator|||
operator|!
name|dns_name_equal
argument_list|(
name|old
index|[
name|i
index|]
argument_list|,
name|new
index|[
name|i
index|]
argument_list|)
condition|)
return|return
operator|(
name|ISC_FALSE
operator|)
return|;
block|}
return|return
operator|(
name|ISC_TRUE
operator|)
return|;
block|}
end_function

begin_function
name|isc_result_t
name|dns_zone_setmasterswithkeys
parameter_list|(
name|dns_zone_t
modifier|*
name|zone
parameter_list|,
specifier|const
name|isc_sockaddr_t
modifier|*
name|masters
parameter_list|,
name|dns_name_t
modifier|*
modifier|*
name|keynames
parameter_list|,
name|isc_uint32_t
name|count
parameter_list|)
block|{
name|isc_sockaddr_t
modifier|*
name|new
decl_stmt|;
name|isc_result_t
name|result
init|=
name|ISC_R_SUCCESS
decl_stmt|;
name|dns_name_t
modifier|*
modifier|*
name|newname
decl_stmt|;
name|isc_boolean_t
modifier|*
name|newok
decl_stmt|;
name|unsigned
name|int
name|i
decl_stmt|;
name|REQUIRE
argument_list|(
name|DNS_ZONE_VALID
argument_list|(
name|zone
argument_list|)
argument_list|)
expr_stmt|;
name|REQUIRE
argument_list|(
name|count
operator|==
literal|0
operator|||
name|masters
operator|!=
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|keynames
operator|!=
name|NULL
condition|)
block|{
name|REQUIRE
argument_list|(
name|count
operator|!=
literal|0
argument_list|)
expr_stmt|;
block|}
name|LOCK_ZONE
argument_list|(
name|zone
argument_list|)
expr_stmt|;
comment|/*  	 * The refresh code assumes that 'masters' wouldn't change under it. 	 * If it will change then kill off any current refresh in progress 	 * and update the masters info.  If it won't change then we can just 	 * unlock and exit. 	 */
if|if
condition|(
name|count
operator|!=
name|zone
operator|->
name|masterscnt
operator|||
operator|!
name|same_masters
argument_list|(
name|zone
operator|->
name|masters
argument_list|,
name|masters
argument_list|,
name|count
argument_list|)
operator|||
operator|!
name|same_keynames
argument_list|(
name|zone
operator|->
name|masterkeynames
argument_list|,
name|keynames
argument_list|,
name|count
argument_list|)
condition|)
block|{
if|if
condition|(
name|zone
operator|->
name|request
operator|!=
name|NULL
condition|)
name|dns_request_cancel
argument_list|(
name|zone
operator|->
name|request
argument_list|)
expr_stmt|;
block|}
else|else
goto|goto
name|unlock
goto|;
if|if
condition|(
name|zone
operator|->
name|masters
operator|!=
name|NULL
condition|)
block|{
name|isc_mem_put
argument_list|(
name|zone
operator|->
name|mctx
argument_list|,
name|zone
operator|->
name|masters
argument_list|,
name|zone
operator|->
name|masterscnt
operator|*
sizeof|sizeof
argument_list|(
operator|*
name|new
argument_list|)
argument_list|)
expr_stmt|;
name|zone
operator|->
name|masters
operator|=
name|NULL
expr_stmt|;
block|}
if|if
condition|(
name|zone
operator|->
name|masterkeynames
operator|!=
name|NULL
condition|)
block|{
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|zone
operator|->
name|masterscnt
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|zone
operator|->
name|masterkeynames
index|[
name|i
index|]
operator|!=
name|NULL
condition|)
block|{
name|dns_name_free
argument_list|(
name|zone
operator|->
name|masterkeynames
index|[
name|i
index|]
argument_list|,
name|zone
operator|->
name|mctx
argument_list|)
expr_stmt|;
name|isc_mem_put
argument_list|(
name|zone
operator|->
name|mctx
argument_list|,
name|zone
operator|->
name|masterkeynames
index|[
name|i
index|]
argument_list|,
sizeof|sizeof
argument_list|(
name|dns_name_t
argument_list|)
argument_list|)
expr_stmt|;
name|zone
operator|->
name|masterkeynames
index|[
name|i
index|]
operator|=
name|NULL
expr_stmt|;
block|}
block|}
name|isc_mem_put
argument_list|(
name|zone
operator|->
name|mctx
argument_list|,
name|zone
operator|->
name|masterkeynames
argument_list|,
name|zone
operator|->
name|masterscnt
operator|*
sizeof|sizeof
argument_list|(
name|dns_name_t
operator|*
argument_list|)
argument_list|)
expr_stmt|;
name|zone
operator|->
name|masterkeynames
operator|=
name|NULL
expr_stmt|;
block|}
if|if
condition|(
name|zone
operator|->
name|mastersok
operator|!=
name|NULL
condition|)
block|{
name|isc_mem_put
argument_list|(
name|zone
operator|->
name|mctx
argument_list|,
name|zone
operator|->
name|mastersok
argument_list|,
name|zone
operator|->
name|masterscnt
operator|*
sizeof|sizeof
argument_list|(
name|isc_boolean_t
argument_list|)
argument_list|)
expr_stmt|;
name|zone
operator|->
name|mastersok
operator|=
name|NULL
expr_stmt|;
block|}
name|zone
operator|->
name|masterscnt
operator|=
literal|0
expr_stmt|;
comment|/* 	 * If count == 0, don't allocate any space for masters, mastersok or 	 * keynames so internally, those pointers are NULL if count == 0 	 */
if|if
condition|(
name|count
operator|==
literal|0
condition|)
goto|goto
name|unlock
goto|;
comment|/* 	 * masters must countain count elements! 	 */
name|new
operator|=
name|isc_mem_get
argument_list|(
name|zone
operator|->
name|mctx
argument_list|,
name|count
operator|*
sizeof|sizeof
argument_list|(
operator|*
name|new
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|new
operator|==
name|NULL
condition|)
block|{
name|result
operator|=
name|ISC_R_NOMEMORY
expr_stmt|;
goto|goto
name|unlock
goto|;
block|}
name|memcpy
argument_list|(
name|new
argument_list|,
name|masters
argument_list|,
name|count
operator|*
sizeof|sizeof
argument_list|(
operator|*
name|new
argument_list|)
argument_list|)
expr_stmt|;
comment|/* 	 * Similarly for mastersok. 	 */
name|newok
operator|=
name|isc_mem_get
argument_list|(
name|zone
operator|->
name|mctx
argument_list|,
name|count
operator|*
sizeof|sizeof
argument_list|(
operator|*
name|newok
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|newok
operator|==
name|NULL
condition|)
block|{
name|result
operator|=
name|ISC_R_NOMEMORY
expr_stmt|;
name|isc_mem_put
argument_list|(
name|zone
operator|->
name|mctx
argument_list|,
name|new
argument_list|,
name|count
operator|*
sizeof|sizeof
argument_list|(
operator|*
name|new
argument_list|)
argument_list|)
expr_stmt|;
goto|goto
name|unlock
goto|;
block|}
empty_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|count
condition|;
name|i
operator|++
control|)
name|newok
index|[
name|i
index|]
operator|=
name|ISC_FALSE
expr_stmt|;
comment|/* 	 * if keynames is non-NULL, it must contain count elements! 	 */
name|newname
operator|=
name|NULL
expr_stmt|;
if|if
condition|(
name|keynames
operator|!=
name|NULL
condition|)
block|{
name|newname
operator|=
name|isc_mem_get
argument_list|(
name|zone
operator|->
name|mctx
argument_list|,
name|count
operator|*
sizeof|sizeof
argument_list|(
operator|*
name|newname
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|newname
operator|==
name|NULL
condition|)
block|{
name|result
operator|=
name|ISC_R_NOMEMORY
expr_stmt|;
name|isc_mem_put
argument_list|(
name|zone
operator|->
name|mctx
argument_list|,
name|new
argument_list|,
name|count
operator|*
sizeof|sizeof
argument_list|(
operator|*
name|new
argument_list|)
argument_list|)
expr_stmt|;
name|isc_mem_put
argument_list|(
name|zone
operator|->
name|mctx
argument_list|,
name|newok
argument_list|,
name|count
operator|*
sizeof|sizeof
argument_list|(
operator|*
name|newok
argument_list|)
argument_list|)
expr_stmt|;
goto|goto
name|unlock
goto|;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|count
condition|;
name|i
operator|++
control|)
name|newname
index|[
name|i
index|]
operator|=
name|NULL
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|count
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|keynames
index|[
name|i
index|]
operator|!=
name|NULL
condition|)
block|{
name|newname
index|[
name|i
index|]
operator|=
name|isc_mem_get
argument_list|(
name|zone
operator|->
name|mctx
argument_list|,
sizeof|sizeof
argument_list|(
name|dns_name_t
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|newname
index|[
name|i
index|]
operator|==
name|NULL
condition|)
goto|goto
name|allocfail
goto|;
name|dns_name_init
argument_list|(
name|newname
index|[
name|i
index|]
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|result
operator|=
name|dns_name_dup
argument_list|(
name|keynames
index|[
name|i
index|]
argument_list|,
name|zone
operator|->
name|mctx
argument_list|,
name|newname
index|[
name|i
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
block|{
name|allocfail
label|:
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|count
condition|;
name|i
operator|++
control|)
if|if
condition|(
name|newname
index|[
name|i
index|]
operator|!=
name|NULL
condition|)
name|dns_name_free
argument_list|(
name|newname
index|[
name|i
index|]
argument_list|,
name|zone
operator|->
name|mctx
argument_list|)
expr_stmt|;
name|isc_mem_put
argument_list|(
name|zone
operator|->
name|mctx
argument_list|,
name|new
argument_list|,
name|count
operator|*
sizeof|sizeof
argument_list|(
operator|*
name|new
argument_list|)
argument_list|)
expr_stmt|;
name|isc_mem_put
argument_list|(
name|zone
operator|->
name|mctx
argument_list|,
name|newok
argument_list|,
name|count
operator|*
sizeof|sizeof
argument_list|(
operator|*
name|newok
argument_list|)
argument_list|)
expr_stmt|;
name|isc_mem_put
argument_list|(
name|zone
operator|->
name|mctx
argument_list|,
name|newname
argument_list|,
name|count
operator|*
sizeof|sizeof
argument_list|(
operator|*
name|newname
argument_list|)
argument_list|)
expr_stmt|;
goto|goto
name|unlock
goto|;
block|}
block|}
block|}
block|}
comment|/* 	 * Everything is ok so attach to the zone. 	 */
name|zone
operator|->
name|masters
operator|=
name|new
expr_stmt|;
name|zone
operator|->
name|mastersok
operator|=
name|newok
expr_stmt|;
name|zone
operator|->
name|masterkeynames
operator|=
name|newname
expr_stmt|;
name|zone
operator|->
name|masterscnt
operator|=
name|count
expr_stmt|;
name|DNS_ZONE_CLRFLAG
argument_list|(
name|zone
argument_list|,
name|DNS_ZONEFLG_NOMASTERS
argument_list|)
expr_stmt|;
name|unlock
label|:
name|UNLOCK_ZONE
argument_list|(
name|zone
argument_list|)
expr_stmt|;
return|return
operator|(
name|result
operator|)
return|;
block|}
end_function

begin_function
name|isc_result_t
name|dns_zone_getdb
parameter_list|(
name|dns_zone_t
modifier|*
name|zone
parameter_list|,
name|dns_db_t
modifier|*
modifier|*
name|dpb
parameter_list|)
block|{
name|isc_result_t
name|result
init|=
name|ISC_R_SUCCESS
decl_stmt|;
name|REQUIRE
argument_list|(
name|DNS_ZONE_VALID
argument_list|(
name|zone
argument_list|)
argument_list|)
expr_stmt|;
name|LOCK_ZONE
argument_list|(
name|zone
argument_list|)
expr_stmt|;
if|if
condition|(
name|zone
operator|->
name|db
operator|==
name|NULL
condition|)
name|result
operator|=
name|DNS_R_NOTLOADED
expr_stmt|;
else|else
name|dns_db_attach
argument_list|(
name|zone
operator|->
name|db
argument_list|,
name|dpb
argument_list|)
expr_stmt|;
name|UNLOCK_ZONE
argument_list|(
name|zone
argument_list|)
expr_stmt|;
return|return
operator|(
name|result
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Co-ordinates the starting of routine jobs.  */
end_comment

begin_function
name|void
name|dns_zone_maintenance
parameter_list|(
name|dns_zone_t
modifier|*
name|zone
parameter_list|)
block|{
specifier|const
name|char
name|me
index|[]
init|=
literal|"dns_zone_maintenance"
decl_stmt|;
name|isc_time_t
name|now
decl_stmt|;
name|REQUIRE
argument_list|(
name|DNS_ZONE_VALID
argument_list|(
name|zone
argument_list|)
argument_list|)
expr_stmt|;
name|ENTER
expr_stmt|;
name|LOCK_ZONE
argument_list|(
name|zone
argument_list|)
expr_stmt|;
name|TIME_NOW
argument_list|(
operator|&
name|now
argument_list|)
expr_stmt|;
name|zone_settimer
argument_list|(
name|zone
argument_list|,
operator|&
name|now
argument_list|)
expr_stmt|;
name|UNLOCK_ZONE
argument_list|(
name|zone
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
specifier|inline
name|isc_boolean_t
name|was_dumping
parameter_list|(
name|dns_zone_t
modifier|*
name|zone
parameter_list|)
block|{
name|isc_boolean_t
name|dumping
decl_stmt|;
name|REQUIRE
argument_list|(
name|LOCKED_ZONE
argument_list|(
name|zone
argument_list|)
argument_list|)
expr_stmt|;
name|dumping
operator|=
name|DNS_ZONE_FLAG
argument_list|(
name|zone
argument_list|,
name|DNS_ZONEFLG_DUMPING
argument_list|)
expr_stmt|;
name|DNS_ZONE_SETFLAG
argument_list|(
name|zone
argument_list|,
name|DNS_ZONEFLG_DUMPING
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|dumping
condition|)
block|{
name|DNS_ZONE_CLRFLAG
argument_list|(
name|zone
argument_list|,
name|DNS_ZONEFLG_NEEDDUMP
argument_list|)
expr_stmt|;
name|isc_time_settoepoch
argument_list|(
operator|&
name|zone
operator|->
name|dumptime
argument_list|)
expr_stmt|;
block|}
return|return
operator|(
name|dumping
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|zone_maintenance
parameter_list|(
name|dns_zone_t
modifier|*
name|zone
parameter_list|)
block|{
specifier|const
name|char
name|me
index|[]
init|=
literal|"zone_maintenance"
decl_stmt|;
name|isc_time_t
name|now
decl_stmt|;
name|isc_result_t
name|result
decl_stmt|;
name|isc_boolean_t
name|dumping
decl_stmt|;
name|REQUIRE
argument_list|(
name|DNS_ZONE_VALID
argument_list|(
name|zone
argument_list|)
argument_list|)
expr_stmt|;
name|ENTER
expr_stmt|;
comment|/* 	 * Configuring the view of this zone may have 	 * failed, for example because the config file 	 * had a syntax error.  In that case, the view 	 * adb or resolver, and we had better not try 	 * to do maintenance on it. 	 */
if|if
condition|(
name|zone
operator|->
name|view
operator|==
name|NULL
operator|||
name|zone
operator|->
name|view
operator|->
name|adb
operator|==
name|NULL
condition|)
return|return;
name|TIME_NOW
argument_list|(
operator|&
name|now
argument_list|)
expr_stmt|;
comment|/* 	 * Expire check. 	 */
switch|switch
condition|(
name|zone
operator|->
name|type
condition|)
block|{
case|case
name|dns_zone_slave
case|:
case|case
name|dns_zone_stub
case|:
name|LOCK_ZONE
argument_list|(
name|zone
argument_list|)
expr_stmt|;
if|if
condition|(
name|isc_time_compare
argument_list|(
operator|&
name|now
argument_list|,
operator|&
name|zone
operator|->
name|expiretime
argument_list|)
operator|>=
literal|0
operator|&&
name|DNS_ZONE_FLAG
argument_list|(
name|zone
argument_list|,
name|DNS_ZONEFLG_LOADED
argument_list|)
condition|)
block|{
name|zone_expire
argument_list|(
name|zone
argument_list|)
expr_stmt|;
name|zone
operator|->
name|refreshtime
operator|=
name|now
expr_stmt|;
block|}
name|UNLOCK_ZONE
argument_list|(
name|zone
argument_list|)
expr_stmt|;
break|break;
default|default:
break|break;
block|}
comment|/* 	 * Up to date check. 	 */
switch|switch
condition|(
name|zone
operator|->
name|type
condition|)
block|{
case|case
name|dns_zone_slave
case|:
case|case
name|dns_zone_stub
case|:
if|if
condition|(
operator|!
name|DNS_ZONE_FLAG
argument_list|(
name|zone
argument_list|,
name|DNS_ZONEFLG_DIALREFRESH
argument_list|)
operator|&&
name|isc_time_compare
argument_list|(
operator|&
name|now
argument_list|,
operator|&
name|zone
operator|->
name|refreshtime
argument_list|)
operator|>=
literal|0
condition|)
name|dns_zone_refresh
argument_list|(
name|zone
argument_list|)
expr_stmt|;
break|break;
default|default:
break|break;
block|}
comment|/* 	 * Do we need to consolidate the backing store? 	 */
switch|switch
condition|(
name|zone
operator|->
name|type
condition|)
block|{
case|case
name|dns_zone_master
case|:
case|case
name|dns_zone_slave
case|:
name|LOCK_ZONE
argument_list|(
name|zone
argument_list|)
expr_stmt|;
if|if
condition|(
name|zone
operator|->
name|masterfile
operator|!=
name|NULL
operator|&&
name|isc_time_compare
argument_list|(
operator|&
name|now
argument_list|,
operator|&
name|zone
operator|->
name|dumptime
argument_list|)
operator|>=
literal|0
operator|&&
name|DNS_ZONE_FLAG
argument_list|(
name|zone
argument_list|,
name|DNS_ZONEFLG_LOADED
argument_list|)
operator|&&
name|DNS_ZONE_FLAG
argument_list|(
name|zone
argument_list|,
name|DNS_ZONEFLG_NEEDDUMP
argument_list|)
condition|)
block|{
name|dumping
operator|=
name|was_dumping
argument_list|(
name|zone
argument_list|)
expr_stmt|;
block|}
else|else
name|dumping
operator|=
name|ISC_TRUE
expr_stmt|;
name|UNLOCK_ZONE
argument_list|(
name|zone
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|dumping
condition|)
block|{
name|result
operator|=
name|zone_dump
argument_list|(
name|zone
argument_list|,
name|ISC_TRUE
argument_list|)
expr_stmt|;
comment|/* task locked */
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
name|dns_zone_log
argument_list|(
name|zone
argument_list|,
name|ISC_LOG_WARNING
argument_list|,
literal|"dump failed: %s"
argument_list|,
name|dns_result_totext
argument_list|(
name|result
argument_list|)
argument_list|)
expr_stmt|;
block|}
break|break;
default|default:
break|break;
block|}
comment|/* 	 * Do we need to send out notify messages? 	 */
switch|switch
condition|(
name|zone
operator|->
name|type
condition|)
block|{
case|case
name|dns_zone_master
case|:
case|case
name|dns_zone_slave
case|:
if|if
condition|(
name|DNS_ZONE_FLAG
argument_list|(
name|zone
argument_list|,
name|DNS_ZONEFLG_NEEDNOTIFY
argument_list|)
condition|)
name|zone_notify
argument_list|(
name|zone
argument_list|)
expr_stmt|;
break|break;
default|default:
break|break;
block|}
name|zone_settimer
argument_list|(
name|zone
argument_list|,
operator|&
name|now
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|dns_zone_markdirty
parameter_list|(
name|dns_zone_t
modifier|*
name|zone
parameter_list|)
block|{
name|LOCK_ZONE
argument_list|(
name|zone
argument_list|)
expr_stmt|;
name|zone_needdump
argument_list|(
name|zone
argument_list|,
name|DNS_DUMP_DELAY
argument_list|)
expr_stmt|;
name|UNLOCK_ZONE
argument_list|(
name|zone
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|dns_zone_expire
parameter_list|(
name|dns_zone_t
modifier|*
name|zone
parameter_list|)
block|{
name|REQUIRE
argument_list|(
name|DNS_ZONE_VALID
argument_list|(
name|zone
argument_list|)
argument_list|)
expr_stmt|;
name|LOCK_ZONE
argument_list|(
name|zone
argument_list|)
expr_stmt|;
name|zone_expire
argument_list|(
name|zone
argument_list|)
expr_stmt|;
name|UNLOCK_ZONE
argument_list|(
name|zone
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|zone_expire
parameter_list|(
name|dns_zone_t
modifier|*
name|zone
parameter_list|)
block|{
comment|/* 	 * 'zone' locked by caller. 	 */
name|REQUIRE
argument_list|(
name|LOCKED_ZONE
argument_list|(
name|zone
argument_list|)
argument_list|)
expr_stmt|;
name|dns_zone_log
argument_list|(
name|zone
argument_list|,
name|ISC_LOG_WARNING
argument_list|,
literal|"expired"
argument_list|)
expr_stmt|;
name|DNS_ZONE_SETFLAG
argument_list|(
name|zone
argument_list|,
name|DNS_ZONEFLG_EXPIRED
argument_list|)
expr_stmt|;
name|zone
operator|->
name|refresh
operator|=
name|DNS_ZONE_DEFAULTREFRESH
expr_stmt|;
name|zone
operator|->
name|retry
operator|=
name|DNS_ZONE_DEFAULTRETRY
expr_stmt|;
name|DNS_ZONE_CLRFLAG
argument_list|(
name|zone
argument_list|,
name|DNS_ZONEFLG_HAVETIMERS
argument_list|)
expr_stmt|;
name|zone_unload
argument_list|(
name|zone
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|dns_zone_refresh
parameter_list|(
name|dns_zone_t
modifier|*
name|zone
parameter_list|)
block|{
name|isc_interval_t
name|i
decl_stmt|;
name|isc_uint32_t
name|oldflags
decl_stmt|;
name|unsigned
name|int
name|j
decl_stmt|;
name|isc_result_t
name|result
decl_stmt|;
name|REQUIRE
argument_list|(
name|DNS_ZONE_VALID
argument_list|(
name|zone
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|DNS_ZONE_FLAG
argument_list|(
name|zone
argument_list|,
name|DNS_ZONEFLG_EXITING
argument_list|)
condition|)
return|return;
comment|/* 	 * Set DNS_ZONEFLG_REFRESH so that there is only one refresh operation 	 * in progress at a time. 	 */
name|LOCK_ZONE
argument_list|(
name|zone
argument_list|)
expr_stmt|;
name|oldflags
operator|=
name|zone
operator|->
name|flags
expr_stmt|;
if|if
condition|(
name|zone
operator|->
name|masterscnt
operator|==
literal|0
condition|)
block|{
name|DNS_ZONE_SETFLAG
argument_list|(
name|zone
argument_list|,
name|DNS_ZONEFLG_NOMASTERS
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|oldflags
operator|&
name|DNS_ZONEFLG_NOMASTERS
operator|)
operator|==
literal|0
condition|)
name|dns_zone_log
argument_list|(
name|zone
argument_list|,
name|ISC_LOG_ERROR
argument_list|,
literal|"cannot refresh: no masters"
argument_list|)
expr_stmt|;
goto|goto
name|unlock
goto|;
block|}
name|DNS_ZONE_SETFLAG
argument_list|(
name|zone
argument_list|,
name|DNS_ZONEFLG_REFRESH
argument_list|)
expr_stmt|;
name|DNS_ZONE_CLRFLAG
argument_list|(
name|zone
argument_list|,
name|DNS_ZONEFLG_NOEDNS
argument_list|)
expr_stmt|;
name|DNS_ZONE_CLRFLAG
argument_list|(
name|zone
argument_list|,
name|DNS_ZONEFLG_USEALTXFRSRC
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|oldflags
operator|&
operator|(
name|DNS_ZONEFLG_REFRESH
operator||
name|DNS_ZONEFLG_LOADING
operator|)
operator|)
operator|!=
literal|0
condition|)
goto|goto
name|unlock
goto|;
comment|/* 	 * Set the next refresh time as if refresh check has failed. 	 * Setting this to the retry time will do that.  XXXMLG 	 * If we are successful it will be reset using zone->refresh. 	 */
name|isc_interval_set
argument_list|(
operator|&
name|i
argument_list|,
name|isc_random_jitter
argument_list|(
name|zone
operator|->
name|retry
argument_list|,
name|zone
operator|->
name|retry
operator|/
literal|4
argument_list|)
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|result
operator|=
name|isc_time_nowplusinterval
argument_list|(
operator|&
name|zone
operator|->
name|refreshtime
argument_list|,
operator|&
name|i
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator||=
name|ISC_R_SUCCESS
condition|)
name|dns_zone_log
argument_list|(
name|zone
argument_list|,
name|ISC_LOG_WARNING
argument_list|,
literal|"isc_time_nowplusinterval() failed: %s"
argument_list|,
name|dns_result_totext
argument_list|(
name|result
argument_list|)
argument_list|)
expr_stmt|;
comment|/* 	 * When lacking user-specified timer values from the SOA, 	 * do exponential backoff of the retry time up to a 	 * maximum of six hours. 	 */
if|if
condition|(
operator|!
name|DNS_ZONE_FLAG
argument_list|(
name|zone
argument_list|,
name|DNS_ZONEFLG_HAVETIMERS
argument_list|)
condition|)
name|zone
operator|->
name|retry
operator|=
name|ISC_MIN
argument_list|(
name|zone
operator|->
name|retry
operator|*
literal|2
argument_list|,
literal|6
operator|*
literal|3600
argument_list|)
expr_stmt|;
name|zone
operator|->
name|curmaster
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|j
operator|=
literal|0
init|;
name|j
operator|<
name|zone
operator|->
name|masterscnt
condition|;
name|j
operator|++
control|)
name|zone
operator|->
name|mastersok
index|[
name|j
index|]
operator|=
name|ISC_FALSE
expr_stmt|;
comment|/* initiate soa query */
name|queue_soa_query
argument_list|(
name|zone
argument_list|)
expr_stmt|;
name|unlock
label|:
name|UNLOCK_ZONE
argument_list|(
name|zone
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|isc_result_t
name|dns_zone_flush
parameter_list|(
name|dns_zone_t
modifier|*
name|zone
parameter_list|)
block|{
name|isc_result_t
name|result
init|=
name|ISC_R_SUCCESS
decl_stmt|;
name|isc_boolean_t
name|dumping
decl_stmt|;
name|REQUIRE
argument_list|(
name|DNS_ZONE_VALID
argument_list|(
name|zone
argument_list|)
argument_list|)
expr_stmt|;
name|LOCK_ZONE
argument_list|(
name|zone
argument_list|)
expr_stmt|;
name|DNS_ZONE_SETFLAG
argument_list|(
name|zone
argument_list|,
name|DNS_ZONEFLG_FLUSH
argument_list|)
expr_stmt|;
if|if
condition|(
name|DNS_ZONE_FLAG
argument_list|(
name|zone
argument_list|,
name|DNS_ZONEFLG_NEEDDUMP
argument_list|)
operator|&&
name|zone
operator|->
name|masterfile
operator|!=
name|NULL
condition|)
block|{
name|result
operator|=
name|ISC_R_ALREADYRUNNING
expr_stmt|;
name|dumping
operator|=
name|was_dumping
argument_list|(
name|zone
argument_list|)
expr_stmt|;
block|}
else|else
name|dumping
operator|=
name|ISC_TRUE
expr_stmt|;
name|UNLOCK_ZONE
argument_list|(
name|zone
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|dumping
condition|)
name|result
operator|=
name|zone_dump
argument_list|(
name|zone
argument_list|,
name|ISC_FALSE
argument_list|)
expr_stmt|;
comment|/* Unknown task. */
return|return
operator|(
name|result
operator|)
return|;
block|}
end_function

begin_function
name|isc_result_t
name|dns_zone_dump
parameter_list|(
name|dns_zone_t
modifier|*
name|zone
parameter_list|)
block|{
name|isc_result_t
name|result
init|=
name|ISC_R_ALREADYRUNNING
decl_stmt|;
name|isc_boolean_t
name|dumping
decl_stmt|;
name|REQUIRE
argument_list|(
name|DNS_ZONE_VALID
argument_list|(
name|zone
argument_list|)
argument_list|)
expr_stmt|;
name|LOCK_ZONE
argument_list|(
name|zone
argument_list|)
expr_stmt|;
name|dumping
operator|=
name|was_dumping
argument_list|(
name|zone
argument_list|)
expr_stmt|;
name|UNLOCK_ZONE
argument_list|(
name|zone
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|dumping
condition|)
name|result
operator|=
name|zone_dump
argument_list|(
name|zone
argument_list|,
name|ISC_FALSE
argument_list|)
expr_stmt|;
comment|/* Unknown task. */
return|return
operator|(
name|result
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|zone_needdump
parameter_list|(
name|dns_zone_t
modifier|*
name|zone
parameter_list|,
name|unsigned
name|int
name|delay
parameter_list|)
block|{
name|isc_time_t
name|dumptime
decl_stmt|;
name|isc_time_t
name|now
decl_stmt|;
comment|/* 	 * 'zone' locked by caller 	 */
name|REQUIRE
argument_list|(
name|DNS_ZONE_VALID
argument_list|(
name|zone
argument_list|)
argument_list|)
expr_stmt|;
name|REQUIRE
argument_list|(
name|LOCKED_ZONE
argument_list|(
name|zone
argument_list|)
argument_list|)
expr_stmt|;
comment|/* 	 * Do we have a place to dump to and are we loaded? 	 */
if|if
condition|(
name|zone
operator|->
name|masterfile
operator|==
name|NULL
operator|||
name|DNS_ZONE_FLAG
argument_list|(
name|zone
argument_list|,
name|DNS_ZONEFLG_LOADED
argument_list|)
operator|==
literal|0
condition|)
return|return;
name|TIME_NOW
argument_list|(
operator|&
name|now
argument_list|)
expr_stmt|;
comment|/* add some noise */
name|DNS_ZONE_JITTER_ADD
argument_list|(
operator|&
name|now
argument_list|,
name|delay
argument_list|,
operator|&
name|dumptime
argument_list|)
expr_stmt|;
name|DNS_ZONE_SETFLAG
argument_list|(
name|zone
argument_list|,
name|DNS_ZONEFLG_NEEDDUMP
argument_list|)
expr_stmt|;
if|if
condition|(
name|isc_time_isepoch
argument_list|(
operator|&
name|zone
operator|->
name|dumptime
argument_list|)
operator|||
name|isc_time_compare
argument_list|(
operator|&
name|zone
operator|->
name|dumptime
argument_list|,
operator|&
name|dumptime
argument_list|)
operator|>
literal|0
condition|)
name|zone
operator|->
name|dumptime
operator|=
name|dumptime
expr_stmt|;
if|if
condition|(
name|zone
operator|->
name|task
operator|!=
name|NULL
condition|)
name|zone_settimer
argument_list|(
name|zone
argument_list|,
operator|&
name|now
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|dump_done
parameter_list|(
name|void
modifier|*
name|arg
parameter_list|,
name|isc_result_t
name|result
parameter_list|)
block|{
specifier|const
name|char
name|me
index|[]
init|=
literal|"dump_done"
decl_stmt|;
name|dns_zone_t
modifier|*
name|zone
init|=
name|arg
decl_stmt|;
name|dns_db_t
modifier|*
name|db
decl_stmt|;
name|dns_dbversion_t
modifier|*
name|version
decl_stmt|;
name|isc_boolean_t
name|again
init|=
name|ISC_FALSE
decl_stmt|;
name|isc_boolean_t
name|compact
init|=
name|ISC_FALSE
decl_stmt|;
name|isc_uint32_t
name|serial
decl_stmt|;
name|isc_result_t
name|tresult
decl_stmt|;
name|REQUIRE
argument_list|(
name|DNS_ZONE_VALID
argument_list|(
name|zone
argument_list|)
argument_list|)
expr_stmt|;
name|ENTER
expr_stmt|;
if|if
condition|(
name|result
operator|==
name|ISC_R_SUCCESS
operator|&&
name|zone
operator|->
name|journal
operator|!=
name|NULL
operator|&&
name|zone
operator|->
name|journalsize
operator|!=
operator|-
literal|1
condition|)
block|{
comment|/* 		 * We don't own these, zone->dctx must stay valid. 		 */
name|db
operator|=
name|dns_dumpctx_db
argument_list|(
name|zone
operator|->
name|dctx
argument_list|)
expr_stmt|;
name|version
operator|=
name|dns_dumpctx_version
argument_list|(
name|zone
operator|->
name|dctx
argument_list|)
expr_stmt|;
name|tresult
operator|=
name|dns_db_getsoaserial
argument_list|(
name|db
argument_list|,
name|version
argument_list|,
operator|&
name|serial
argument_list|)
expr_stmt|;
comment|/* 		 * Note: we are task locked here so we can test 		 * zone->xfr safely. 		 */
if|if
condition|(
name|tresult
operator|==
name|ISC_R_SUCCESS
operator|&&
name|zone
operator|->
name|xfr
operator|==
name|NULL
condition|)
block|{
name|tresult
operator|=
name|dns_journal_compact
argument_list|(
name|zone
operator|->
name|mctx
argument_list|,
name|zone
operator|->
name|journal
argument_list|,
name|serial
argument_list|,
name|zone
operator|->
name|journalsize
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|tresult
condition|)
block|{
case|case
name|ISC_R_SUCCESS
case|:
case|case
name|ISC_R_NOSPACE
case|:
case|case
name|ISC_R_NOTFOUND
case|:
name|dns_zone_log
argument_list|(
name|zone
argument_list|,
name|ISC_LOG_DEBUG
argument_list|(
literal|3
argument_list|)
argument_list|,
literal|"dns_journal_compact: %s"
argument_list|,
name|dns_result_totext
argument_list|(
name|tresult
argument_list|)
argument_list|)
expr_stmt|;
break|break;
default|default:
name|dns_zone_log
argument_list|(
name|zone
argument_list|,
name|ISC_LOG_ERROR
argument_list|,
literal|"dns_journal_compact failed: %s"
argument_list|,
name|dns_result_totext
argument_list|(
name|tresult
argument_list|)
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
elseif|else
if|if
condition|(
name|tresult
operator|==
name|ISC_R_SUCCESS
condition|)
block|{
name|compact
operator|=
name|ISC_TRUE
expr_stmt|;
name|zone
operator|->
name|compact_serial
operator|=
name|serial
expr_stmt|;
block|}
block|}
name|LOCK_ZONE
argument_list|(
name|zone
argument_list|)
expr_stmt|;
name|DNS_ZONE_CLRFLAG
argument_list|(
name|zone
argument_list|,
name|DNS_ZONEFLG_DUMPING
argument_list|)
expr_stmt|;
if|if
condition|(
name|compact
condition|)
name|DNS_ZONE_SETFLAG
argument_list|(
name|zone
argument_list|,
name|DNS_ZONEFLG_NEEDCOMPACT
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
operator|&&
name|result
operator|!=
name|ISC_R_CANCELED
condition|)
block|{
comment|/* 		 * Try again in a short while. 		 */
name|zone_needdump
argument_list|(
name|zone
argument_list|,
name|DNS_DUMP_DELAY
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|result
operator|==
name|ISC_R_SUCCESS
operator|&&
name|DNS_ZONE_FLAG
argument_list|(
name|zone
argument_list|,
name|DNS_ZONEFLG_FLUSH
argument_list|)
operator|&&
name|DNS_ZONE_FLAG
argument_list|(
name|zone
argument_list|,
name|DNS_ZONEFLG_NEEDDUMP
argument_list|)
operator|&&
name|DNS_ZONE_FLAG
argument_list|(
name|zone
argument_list|,
name|DNS_ZONEFLG_LOADED
argument_list|)
condition|)
block|{
name|DNS_ZONE_CLRFLAG
argument_list|(
name|zone
argument_list|,
name|DNS_ZONEFLG_NEEDDUMP
argument_list|)
expr_stmt|;
name|DNS_ZONE_SETFLAG
argument_list|(
name|zone
argument_list|,
name|DNS_ZONEFLG_DUMPING
argument_list|)
expr_stmt|;
name|isc_time_settoepoch
argument_list|(
operator|&
name|zone
operator|->
name|dumptime
argument_list|)
expr_stmt|;
name|again
operator|=
name|ISC_TRUE
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|result
operator|==
name|ISC_R_SUCCESS
condition|)
name|DNS_ZONE_CLRFLAG
argument_list|(
name|zone
argument_list|,
name|DNS_ZONEFLG_FLUSH
argument_list|)
expr_stmt|;
if|if
condition|(
name|zone
operator|->
name|dctx
operator|!=
name|NULL
condition|)
name|dns_dumpctx_detach
argument_list|(
operator|&
name|zone
operator|->
name|dctx
argument_list|)
expr_stmt|;
name|zonemgr_putio
argument_list|(
operator|&
name|zone
operator|->
name|writeio
argument_list|)
expr_stmt|;
name|UNLOCK_ZONE
argument_list|(
name|zone
argument_list|)
expr_stmt|;
if|if
condition|(
name|again
condition|)
operator|(
name|void
operator|)
name|zone_dump
argument_list|(
name|zone
argument_list|,
name|ISC_FALSE
argument_list|)
expr_stmt|;
name|dns_zone_idetach
argument_list|(
operator|&
name|zone
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|isc_result_t
name|zone_dump
parameter_list|(
name|dns_zone_t
modifier|*
name|zone
parameter_list|,
name|isc_boolean_t
name|compact
parameter_list|)
block|{
specifier|const
name|char
name|me
index|[]
init|=
literal|"zone_dump"
decl_stmt|;
name|isc_result_t
name|result
decl_stmt|;
name|dns_dbversion_t
modifier|*
name|version
init|=
name|NULL
decl_stmt|;
name|isc_boolean_t
name|again
decl_stmt|;
name|dns_db_t
modifier|*
name|db
init|=
name|NULL
decl_stmt|;
name|char
modifier|*
name|masterfile
init|=
name|NULL
decl_stmt|;
comment|/*  * 'compact' MUST only be set if we are task locked.  */
name|REQUIRE
argument_list|(
name|DNS_ZONE_VALID
argument_list|(
name|zone
argument_list|)
argument_list|)
expr_stmt|;
name|ENTER
expr_stmt|;
name|redo
label|:
name|LOCK_ZONE
argument_list|(
name|zone
argument_list|)
expr_stmt|;
if|if
condition|(
name|zone
operator|->
name|db
operator|!=
name|NULL
condition|)
name|dns_db_attach
argument_list|(
name|zone
operator|->
name|db
argument_list|,
operator|&
name|db
argument_list|)
expr_stmt|;
if|if
condition|(
name|zone
operator|->
name|masterfile
operator|!=
name|NULL
condition|)
name|masterfile
operator|=
name|isc_mem_strdup
argument_list|(
name|zone
operator|->
name|mctx
argument_list|,
name|zone
operator|->
name|masterfile
argument_list|)
expr_stmt|;
name|UNLOCK_ZONE
argument_list|(
name|zone
argument_list|)
expr_stmt|;
if|if
condition|(
name|db
operator|==
name|NULL
condition|)
block|{
name|result
operator|=
name|DNS_R_NOTLOADED
expr_stmt|;
goto|goto
name|fail
goto|;
block|}
if|if
condition|(
name|masterfile
operator|==
name|NULL
condition|)
block|{
name|result
operator|=
name|DNS_R_NOMASTERFILE
expr_stmt|;
goto|goto
name|fail
goto|;
block|}
if|if
condition|(
name|compact
condition|)
block|{
name|dns_zone_t
modifier|*
name|dummy
init|=
name|NULL
decl_stmt|;
name|LOCK_ZONE
argument_list|(
name|zone
argument_list|)
expr_stmt|;
name|zone_iattach
argument_list|(
name|zone
argument_list|,
operator|&
name|dummy
argument_list|)
expr_stmt|;
name|result
operator|=
name|zonemgr_getio
argument_list|(
name|zone
operator|->
name|zmgr
argument_list|,
name|ISC_FALSE
argument_list|,
name|zone
operator|->
name|task
argument_list|,
name|zone_gotwritehandle
argument_list|,
name|zone
argument_list|,
operator|&
name|zone
operator|->
name|writeio
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
name|zone_idetach
argument_list|(
operator|&
name|dummy
argument_list|)
expr_stmt|;
else|else
name|result
operator|=
name|DNS_R_CONTINUE
expr_stmt|;
name|UNLOCK_ZONE
argument_list|(
name|zone
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|dns_db_currentversion
argument_list|(
name|db
argument_list|,
operator|&
name|version
argument_list|)
expr_stmt|;
name|result
operator|=
name|dns_master_dump
argument_list|(
name|zone
operator|->
name|mctx
argument_list|,
name|db
argument_list|,
name|version
argument_list|,
operator|&
name|dns_master_style_default
argument_list|,
name|masterfile
argument_list|)
expr_stmt|;
name|dns_db_closeversion
argument_list|(
name|db
argument_list|,
operator|&
name|version
argument_list|,
name|ISC_FALSE
argument_list|)
expr_stmt|;
block|}
name|fail
label|:
if|if
condition|(
name|db
operator|!=
name|NULL
condition|)
name|dns_db_detach
argument_list|(
operator|&
name|db
argument_list|)
expr_stmt|;
if|if
condition|(
name|masterfile
operator|!=
name|NULL
condition|)
name|isc_mem_free
argument_list|(
name|zone
operator|->
name|mctx
argument_list|,
name|masterfile
argument_list|)
expr_stmt|;
name|masterfile
operator|=
name|NULL
expr_stmt|;
if|if
condition|(
name|result
operator|==
name|DNS_R_CONTINUE
condition|)
return|return
operator|(
name|ISC_R_SUCCESS
operator|)
return|;
comment|/* XXXMPA */
name|again
operator|=
name|ISC_FALSE
expr_stmt|;
name|LOCK_ZONE
argument_list|(
name|zone
argument_list|)
expr_stmt|;
name|DNS_ZONE_CLRFLAG
argument_list|(
name|zone
argument_list|,
name|DNS_ZONEFLG_DUMPING
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
block|{
comment|/* 		 * Try again in a short while. 		 */
name|zone_needdump
argument_list|(
name|zone
argument_list|,
name|DNS_DUMP_DELAY
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|DNS_ZONE_FLAG
argument_list|(
name|zone
argument_list|,
name|DNS_ZONEFLG_FLUSH
argument_list|)
operator|&&
name|DNS_ZONE_FLAG
argument_list|(
name|zone
argument_list|,
name|DNS_ZONEFLG_NEEDDUMP
argument_list|)
operator|&&
name|DNS_ZONE_FLAG
argument_list|(
name|zone
argument_list|,
name|DNS_ZONEFLG_LOADED
argument_list|)
condition|)
block|{
name|DNS_ZONE_CLRFLAG
argument_list|(
name|zone
argument_list|,
name|DNS_ZONEFLG_NEEDDUMP
argument_list|)
expr_stmt|;
name|DNS_ZONE_SETFLAG
argument_list|(
name|zone
argument_list|,
name|DNS_ZONEFLG_DUMPING
argument_list|)
expr_stmt|;
name|isc_time_settoepoch
argument_list|(
operator|&
name|zone
operator|->
name|dumptime
argument_list|)
expr_stmt|;
name|again
operator|=
name|ISC_TRUE
expr_stmt|;
block|}
else|else
name|DNS_ZONE_CLRFLAG
argument_list|(
name|zone
argument_list|,
name|DNS_ZONEFLG_FLUSH
argument_list|)
expr_stmt|;
name|UNLOCK_ZONE
argument_list|(
name|zone
argument_list|)
expr_stmt|;
if|if
condition|(
name|again
condition|)
goto|goto
name|redo
goto|;
return|return
operator|(
name|result
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|isc_result_t
name|dumptostream
parameter_list|(
name|dns_zone_t
modifier|*
name|zone
parameter_list|,
name|FILE
modifier|*
name|fd
parameter_list|,
specifier|const
name|dns_master_style_t
modifier|*
name|style
parameter_list|)
block|{
name|isc_result_t
name|result
decl_stmt|;
name|dns_dbversion_t
modifier|*
name|version
init|=
name|NULL
decl_stmt|;
name|dns_db_t
modifier|*
name|db
init|=
name|NULL
decl_stmt|;
name|REQUIRE
argument_list|(
name|DNS_ZONE_VALID
argument_list|(
name|zone
argument_list|)
argument_list|)
expr_stmt|;
name|LOCK_ZONE
argument_list|(
name|zone
argument_list|)
expr_stmt|;
if|if
condition|(
name|zone
operator|->
name|db
operator|!=
name|NULL
condition|)
name|dns_db_attach
argument_list|(
name|zone
operator|->
name|db
argument_list|,
operator|&
name|db
argument_list|)
expr_stmt|;
name|UNLOCK_ZONE
argument_list|(
name|zone
argument_list|)
expr_stmt|;
if|if
condition|(
name|db
operator|==
name|NULL
condition|)
return|return
operator|(
name|DNS_R_NOTLOADED
operator|)
return|;
name|dns_db_currentversion
argument_list|(
name|db
argument_list|,
operator|&
name|version
argument_list|)
expr_stmt|;
name|result
operator|=
name|dns_master_dumptostream
argument_list|(
name|zone
operator|->
name|mctx
argument_list|,
name|db
argument_list|,
name|version
argument_list|,
name|style
argument_list|,
name|fd
argument_list|)
expr_stmt|;
name|dns_db_closeversion
argument_list|(
name|db
argument_list|,
operator|&
name|version
argument_list|,
name|ISC_FALSE
argument_list|)
expr_stmt|;
name|dns_db_detach
argument_list|(
operator|&
name|db
argument_list|)
expr_stmt|;
return|return
operator|(
name|result
operator|)
return|;
block|}
end_function

begin_function
name|isc_result_t
name|dns_zone_dumptostream
parameter_list|(
name|dns_zone_t
modifier|*
name|zone
parameter_list|,
name|FILE
modifier|*
name|fd
parameter_list|)
block|{
return|return
name|dumptostream
argument_list|(
name|zone
argument_list|,
name|fd
argument_list|,
operator|&
name|dns_master_style_default
argument_list|)
return|;
block|}
end_function

begin_function
name|isc_result_t
name|dns_zone_fulldumptostream
parameter_list|(
name|dns_zone_t
modifier|*
name|zone
parameter_list|,
name|FILE
modifier|*
name|fd
parameter_list|)
block|{
return|return
name|dumptostream
argument_list|(
name|zone
argument_list|,
name|fd
argument_list|,
operator|&
name|dns_master_style_full
argument_list|)
return|;
block|}
end_function

begin_function
name|void
name|dns_zone_unload
parameter_list|(
name|dns_zone_t
modifier|*
name|zone
parameter_list|)
block|{
name|REQUIRE
argument_list|(
name|DNS_ZONE_VALID
argument_list|(
name|zone
argument_list|)
argument_list|)
expr_stmt|;
name|LOCK_ZONE
argument_list|(
name|zone
argument_list|)
expr_stmt|;
name|zone_unload
argument_list|(
name|zone
argument_list|)
expr_stmt|;
name|UNLOCK_ZONE
argument_list|(
name|zone
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|notify_cancel
parameter_list|(
name|dns_zone_t
modifier|*
name|zone
parameter_list|)
block|{
name|dns_notify_t
modifier|*
name|notify
decl_stmt|;
comment|/* 	 * 'zone' locked by caller. 	 */
name|REQUIRE
argument_list|(
name|LOCKED_ZONE
argument_list|(
name|zone
argument_list|)
argument_list|)
expr_stmt|;
for|for
control|(
name|notify
operator|=
name|ISC_LIST_HEAD
argument_list|(
name|zone
operator|->
name|notifies
argument_list|)
init|;
name|notify
operator|!=
name|NULL
condition|;
name|notify
operator|=
name|ISC_LIST_NEXT
argument_list|(
name|notify
argument_list|,
name|link
argument_list|)
control|)
block|{
if|if
condition|(
name|notify
operator|->
name|find
operator|!=
name|NULL
condition|)
name|dns_adb_cancelfind
argument_list|(
name|notify
operator|->
name|find
argument_list|)
expr_stmt|;
if|if
condition|(
name|notify
operator|->
name|request
operator|!=
name|NULL
condition|)
name|dns_request_cancel
argument_list|(
name|notify
operator|->
name|request
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|zone_unload
parameter_list|(
name|dns_zone_t
modifier|*
name|zone
parameter_list|)
block|{
comment|/* 	 * 'zone' locked by caller. 	 */
name|REQUIRE
argument_list|(
name|LOCKED_ZONE
argument_list|(
name|zone
argument_list|)
argument_list|)
expr_stmt|;
name|dns_db_detach
argument_list|(
operator|&
name|zone
operator|->
name|db
argument_list|)
expr_stmt|;
name|DNS_ZONE_CLRFLAG
argument_list|(
name|zone
argument_list|,
name|DNS_ZONEFLG_LOADED
argument_list|)
expr_stmt|;
name|DNS_ZONE_CLRFLAG
argument_list|(
name|zone
argument_list|,
name|DNS_ZONEFLG_NEEDDUMP
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|dns_zone_setminrefreshtime
parameter_list|(
name|dns_zone_t
modifier|*
name|zone
parameter_list|,
name|isc_uint32_t
name|val
parameter_list|)
block|{
name|REQUIRE
argument_list|(
name|DNS_ZONE_VALID
argument_list|(
name|zone
argument_list|)
argument_list|)
expr_stmt|;
name|REQUIRE
argument_list|(
name|val
operator|>
literal|0
argument_list|)
expr_stmt|;
name|zone
operator|->
name|minrefresh
operator|=
name|val
expr_stmt|;
block|}
end_function

begin_function
name|void
name|dns_zone_setmaxrefreshtime
parameter_list|(
name|dns_zone_t
modifier|*
name|zone
parameter_list|,
name|isc_uint32_t
name|val
parameter_list|)
block|{
name|REQUIRE
argument_list|(
name|DNS_ZONE_VALID
argument_list|(
name|zone
argument_list|)
argument_list|)
expr_stmt|;
name|REQUIRE
argument_list|(
name|val
operator|>
literal|0
argument_list|)
expr_stmt|;
name|zone
operator|->
name|maxrefresh
operator|=
name|val
expr_stmt|;
block|}
end_function

begin_function
name|void
name|dns_zone_setminretrytime
parameter_list|(
name|dns_zone_t
modifier|*
name|zone
parameter_list|,
name|isc_uint32_t
name|val
parameter_list|)
block|{
name|REQUIRE
argument_list|(
name|DNS_ZONE_VALID
argument_list|(
name|zone
argument_list|)
argument_list|)
expr_stmt|;
name|REQUIRE
argument_list|(
name|val
operator|>
literal|0
argument_list|)
expr_stmt|;
name|zone
operator|->
name|minretry
operator|=
name|val
expr_stmt|;
block|}
end_function

begin_function
name|void
name|dns_zone_setmaxretrytime
parameter_list|(
name|dns_zone_t
modifier|*
name|zone
parameter_list|,
name|isc_uint32_t
name|val
parameter_list|)
block|{
name|REQUIRE
argument_list|(
name|DNS_ZONE_VALID
argument_list|(
name|zone
argument_list|)
argument_list|)
expr_stmt|;
name|REQUIRE
argument_list|(
name|val
operator|>
literal|0
argument_list|)
expr_stmt|;
name|zone
operator|->
name|maxretry
operator|=
name|val
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|isc_boolean_t
name|notify_isqueued
parameter_list|(
name|dns_zone_t
modifier|*
name|zone
parameter_list|,
name|dns_name_t
modifier|*
name|name
parameter_list|,
name|isc_sockaddr_t
modifier|*
name|addr
parameter_list|)
block|{
name|dns_notify_t
modifier|*
name|notify
decl_stmt|;
for|for
control|(
name|notify
operator|=
name|ISC_LIST_HEAD
argument_list|(
name|zone
operator|->
name|notifies
argument_list|)
init|;
name|notify
operator|!=
name|NULL
condition|;
name|notify
operator|=
name|ISC_LIST_NEXT
argument_list|(
name|notify
argument_list|,
name|link
argument_list|)
control|)
block|{
if|if
condition|(
name|notify
operator|->
name|request
operator|!=
name|NULL
condition|)
continue|continue;
if|if
condition|(
name|name
operator|!=
name|NULL
operator|&&
name|dns_name_dynamic
argument_list|(
operator|&
name|notify
operator|->
name|ns
argument_list|)
operator|&&
name|dns_name_equal
argument_list|(
name|name
argument_list|,
operator|&
name|notify
operator|->
name|ns
argument_list|)
condition|)
return|return
operator|(
name|ISC_TRUE
operator|)
return|;
if|if
condition|(
name|addr
operator|!=
name|NULL
operator|&&
name|isc_sockaddr_equal
argument_list|(
name|addr
argument_list|,
operator|&
name|notify
operator|->
name|dst
argument_list|)
condition|)
return|return
operator|(
name|ISC_TRUE
operator|)
return|;
block|}
return|return
operator|(
name|ISC_FALSE
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|notify_destroy
parameter_list|(
name|dns_notify_t
modifier|*
name|notify
parameter_list|,
name|isc_boolean_t
name|locked
parameter_list|)
block|{
name|isc_mem_t
modifier|*
name|mctx
decl_stmt|;
comment|/* 	 * Caller holds zone lock. 	 */
name|REQUIRE
argument_list|(
name|DNS_NOTIFY_VALID
argument_list|(
name|notify
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|notify
operator|->
name|zone
operator|!=
name|NULL
condition|)
block|{
if|if
condition|(
operator|!
name|locked
condition|)
name|LOCK_ZONE
argument_list|(
name|notify
operator|->
name|zone
argument_list|)
expr_stmt|;
name|REQUIRE
argument_list|(
name|LOCKED_ZONE
argument_list|(
name|notify
operator|->
name|zone
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|ISC_LINK_LINKED
argument_list|(
name|notify
argument_list|,
name|link
argument_list|)
condition|)
name|ISC_LIST_UNLINK
argument_list|(
name|notify
operator|->
name|zone
operator|->
name|notifies
argument_list|,
name|notify
argument_list|,
name|link
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|locked
condition|)
name|UNLOCK_ZONE
argument_list|(
name|notify
operator|->
name|zone
argument_list|)
expr_stmt|;
if|if
condition|(
name|locked
condition|)
name|zone_idetach
argument_list|(
operator|&
name|notify
operator|->
name|zone
argument_list|)
expr_stmt|;
else|else
name|dns_zone_idetach
argument_list|(
operator|&
name|notify
operator|->
name|zone
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|notify
operator|->
name|find
operator|!=
name|NULL
condition|)
name|dns_adb_destroyfind
argument_list|(
operator|&
name|notify
operator|->
name|find
argument_list|)
expr_stmt|;
if|if
condition|(
name|notify
operator|->
name|request
operator|!=
name|NULL
condition|)
name|dns_request_destroy
argument_list|(
operator|&
name|notify
operator|->
name|request
argument_list|)
expr_stmt|;
if|if
condition|(
name|dns_name_dynamic
argument_list|(
operator|&
name|notify
operator|->
name|ns
argument_list|)
condition|)
name|dns_name_free
argument_list|(
operator|&
name|notify
operator|->
name|ns
argument_list|,
name|notify
operator|->
name|mctx
argument_list|)
expr_stmt|;
name|mctx
operator|=
name|notify
operator|->
name|mctx
expr_stmt|;
name|isc_mem_put
argument_list|(
name|notify
operator|->
name|mctx
argument_list|,
name|notify
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|notify
argument_list|)
argument_list|)
expr_stmt|;
name|isc_mem_detach
argument_list|(
operator|&
name|mctx
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|isc_result_t
name|notify_create
parameter_list|(
name|isc_mem_t
modifier|*
name|mctx
parameter_list|,
name|unsigned
name|int
name|flags
parameter_list|,
name|dns_notify_t
modifier|*
modifier|*
name|notifyp
parameter_list|)
block|{
name|dns_notify_t
modifier|*
name|notify
decl_stmt|;
name|REQUIRE
argument_list|(
name|notifyp
operator|!=
name|NULL
operator|&&
operator|*
name|notifyp
operator|==
name|NULL
argument_list|)
expr_stmt|;
name|notify
operator|=
name|isc_mem_get
argument_list|(
name|mctx
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|notify
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|notify
operator|==
name|NULL
condition|)
return|return
operator|(
name|ISC_R_NOMEMORY
operator|)
return|;
name|notify
operator|->
name|mctx
operator|=
name|NULL
expr_stmt|;
name|isc_mem_attach
argument_list|(
name|mctx
argument_list|,
operator|&
name|notify
operator|->
name|mctx
argument_list|)
expr_stmt|;
name|notify
operator|->
name|flags
operator|=
name|flags
expr_stmt|;
name|notify
operator|->
name|zone
operator|=
name|NULL
expr_stmt|;
name|notify
operator|->
name|find
operator|=
name|NULL
expr_stmt|;
name|notify
operator|->
name|request
operator|=
name|NULL
expr_stmt|;
name|isc_sockaddr_any
argument_list|(
operator|&
name|notify
operator|->
name|dst
argument_list|)
expr_stmt|;
name|dns_name_init
argument_list|(
operator|&
name|notify
operator|->
name|ns
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|ISC_LINK_INIT
argument_list|(
name|notify
argument_list|,
name|link
argument_list|)
expr_stmt|;
name|notify
operator|->
name|magic
operator|=
name|NOTIFY_MAGIC
expr_stmt|;
operator|*
name|notifyp
operator|=
name|notify
expr_stmt|;
return|return
operator|(
name|ISC_R_SUCCESS
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * XXXAG should check for DNS_ZONEFLG_EXITING  */
end_comment

begin_function
specifier|static
name|void
name|process_adb_event
parameter_list|(
name|isc_task_t
modifier|*
name|task
parameter_list|,
name|isc_event_t
modifier|*
name|ev
parameter_list|)
block|{
name|dns_notify_t
modifier|*
name|notify
decl_stmt|;
name|isc_eventtype_t
name|result
decl_stmt|;
name|UNUSED
argument_list|(
name|task
argument_list|)
expr_stmt|;
name|notify
operator|=
name|ev
operator|->
name|ev_arg
expr_stmt|;
name|REQUIRE
argument_list|(
name|DNS_NOTIFY_VALID
argument_list|(
name|notify
argument_list|)
argument_list|)
expr_stmt|;
name|INSIST
argument_list|(
name|task
operator|==
name|notify
operator|->
name|zone
operator|->
name|task
argument_list|)
expr_stmt|;
name|result
operator|=
name|ev
operator|->
name|ev_type
expr_stmt|;
name|isc_event_free
argument_list|(
operator|&
name|ev
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|==
name|DNS_EVENT_ADBMOREADDRESSES
condition|)
block|{
name|dns_adb_destroyfind
argument_list|(
operator|&
name|notify
operator|->
name|find
argument_list|)
expr_stmt|;
name|notify_find_address
argument_list|(
name|notify
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|result
operator|==
name|DNS_EVENT_ADBNOMOREADDRESSES
condition|)
block|{
name|LOCK_ZONE
argument_list|(
name|notify
operator|->
name|zone
argument_list|)
expr_stmt|;
name|notify_send
argument_list|(
name|notify
argument_list|)
expr_stmt|;
name|UNLOCK_ZONE
argument_list|(
name|notify
operator|->
name|zone
argument_list|)
expr_stmt|;
block|}
name|notify_destroy
argument_list|(
name|notify
argument_list|,
name|ISC_FALSE
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|notify_find_address
parameter_list|(
name|dns_notify_t
modifier|*
name|notify
parameter_list|)
block|{
name|isc_result_t
name|result
decl_stmt|;
name|unsigned
name|int
name|options
decl_stmt|;
name|REQUIRE
argument_list|(
name|DNS_NOTIFY_VALID
argument_list|(
name|notify
argument_list|)
argument_list|)
expr_stmt|;
name|options
operator|=
name|DNS_ADBFIND_WANTEVENT
operator||
name|DNS_ADBFIND_INET
operator||
name|DNS_ADBFIND_INET6
operator||
name|DNS_ADBFIND_RETURNLAME
expr_stmt|;
if|if
condition|(
name|notify
operator|->
name|zone
operator|->
name|view
operator|->
name|adb
operator|==
name|NULL
condition|)
goto|goto
name|destroy
goto|;
name|result
operator|=
name|dns_adb_createfind
argument_list|(
name|notify
operator|->
name|zone
operator|->
name|view
operator|->
name|adb
argument_list|,
name|notify
operator|->
name|zone
operator|->
name|task
argument_list|,
name|process_adb_event
argument_list|,
name|notify
argument_list|,
operator|&
name|notify
operator|->
name|ns
argument_list|,
name|dns_rootname
argument_list|,
name|options
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|,
name|notify
operator|->
name|zone
operator|->
name|view
operator|->
name|dstport
argument_list|,
operator|&
name|notify
operator|->
name|find
argument_list|)
expr_stmt|;
comment|/* Something failed? */
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
goto|goto
name|destroy
goto|;
comment|/* More addresses pending? */
if|if
condition|(
operator|(
name|notify
operator|->
name|find
operator|->
name|options
operator|&
name|DNS_ADBFIND_WANTEVENT
operator|)
operator|!=
literal|0
condition|)
return|return;
comment|/* We have as many addresses as we can get. */
name|LOCK_ZONE
argument_list|(
name|notify
operator|->
name|zone
argument_list|)
expr_stmt|;
name|notify_send
argument_list|(
name|notify
argument_list|)
expr_stmt|;
name|UNLOCK_ZONE
argument_list|(
name|notify
operator|->
name|zone
argument_list|)
expr_stmt|;
name|destroy
label|:
name|notify_destroy
argument_list|(
name|notify
argument_list|,
name|ISC_FALSE
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|isc_result_t
name|notify_send_queue
parameter_list|(
name|dns_notify_t
modifier|*
name|notify
parameter_list|)
block|{
name|isc_event_t
modifier|*
name|e
decl_stmt|;
name|isc_result_t
name|result
decl_stmt|;
name|e
operator|=
name|isc_event_allocate
argument_list|(
name|notify
operator|->
name|mctx
argument_list|,
name|NULL
argument_list|,
name|DNS_EVENT_NOTIFYSENDTOADDR
argument_list|,
name|notify_send_toaddr
argument_list|,
name|notify
argument_list|,
sizeof|sizeof
argument_list|(
name|isc_event_t
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|e
operator|==
name|NULL
condition|)
return|return
operator|(
name|ISC_R_NOMEMORY
operator|)
return|;
name|e
operator|->
name|ev_arg
operator|=
name|notify
expr_stmt|;
name|e
operator|->
name|ev_sender
operator|=
name|NULL
expr_stmt|;
name|result
operator|=
name|isc_ratelimiter_enqueue
argument_list|(
name|notify
operator|->
name|zone
operator|->
name|zmgr
operator|->
name|rl
argument_list|,
name|notify
operator|->
name|zone
operator|->
name|task
argument_list|,
operator|&
name|e
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
name|isc_event_free
argument_list|(
operator|&
name|e
argument_list|)
expr_stmt|;
return|return
operator|(
name|result
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|notify_send_toaddr
parameter_list|(
name|isc_task_t
modifier|*
name|task
parameter_list|,
name|isc_event_t
modifier|*
name|event
parameter_list|)
block|{
name|dns_notify_t
modifier|*
name|notify
decl_stmt|;
name|isc_result_t
name|result
decl_stmt|;
name|dns_message_t
modifier|*
name|message
init|=
name|NULL
decl_stmt|;
name|isc_netaddr_t
name|dstip
decl_stmt|;
name|dns_tsigkey_t
modifier|*
name|key
init|=
name|NULL
decl_stmt|;
name|char
name|addrbuf
index|[
name|ISC_SOCKADDR_FORMATSIZE
index|]
decl_stmt|;
name|isc_sockaddr_t
name|src
decl_stmt|;
name|int
name|timeout
decl_stmt|;
name|notify
operator|=
name|event
operator|->
name|ev_arg
expr_stmt|;
name|REQUIRE
argument_list|(
name|DNS_NOTIFY_VALID
argument_list|(
name|notify
argument_list|)
argument_list|)
expr_stmt|;
name|UNUSED
argument_list|(
name|task
argument_list|)
expr_stmt|;
name|LOCK_ZONE
argument_list|(
name|notify
operator|->
name|zone
argument_list|)
expr_stmt|;
if|if
condition|(
name|DNS_ZONE_FLAG
argument_list|(
name|notify
operator|->
name|zone
argument_list|,
name|DNS_ZONEFLG_LOADED
argument_list|)
operator|==
literal|0
condition|)
block|{
name|result
operator|=
name|ISC_R_CANCELED
expr_stmt|;
goto|goto
name|cleanup
goto|;
block|}
if|if
condition|(
operator|(
name|event
operator|->
name|ev_attributes
operator|&
name|ISC_EVENTATTR_CANCELED
operator|)
operator|!=
literal|0
operator|||
name|DNS_ZONE_FLAG
argument_list|(
name|notify
operator|->
name|zone
argument_list|,
name|DNS_ZONEFLG_EXITING
argument_list|)
operator|||
name|notify
operator|->
name|zone
operator|->
name|view
operator|->
name|requestmgr
operator|==
name|NULL
operator|||
name|notify
operator|->
name|zone
operator|->
name|db
operator|==
name|NULL
condition|)
block|{
name|result
operator|=
name|ISC_R_CANCELED
expr_stmt|;
goto|goto
name|cleanup
goto|;
block|}
comment|/* 	 * The raw IPv4 address should also exist.  Don't send to the 	 * mapped form. 	 */
if|if
condition|(
name|isc_sockaddr_pf
argument_list|(
operator|&
name|notify
operator|->
name|dst
argument_list|)
operator|==
name|PF_INET6
operator|&&
name|IN6_IS_ADDR_V4MAPPED
argument_list|(
operator|&
name|notify
operator|->
name|dst
operator|.
name|type
operator|.
name|sin6
operator|.
name|sin6_addr
argument_list|)
condition|)
block|{
name|isc_sockaddr_format
argument_list|(
operator|&
name|notify
operator|->
name|dst
argument_list|,
name|addrbuf
argument_list|,
sizeof|sizeof
argument_list|(
name|addrbuf
argument_list|)
argument_list|)
expr_stmt|;
name|notify_log
argument_list|(
name|notify
operator|->
name|zone
argument_list|,
name|ISC_LOG_DEBUG
argument_list|(
literal|3
argument_list|)
argument_list|,
literal|"notify: ignoring IPv6 mapped IPV4 address: %s"
argument_list|,
name|addrbuf
argument_list|)
expr_stmt|;
name|result
operator|=
name|ISC_R_CANCELED
expr_stmt|;
goto|goto
name|cleanup
goto|;
block|}
name|result
operator|=
name|notify_createmessage
argument_list|(
name|notify
operator|->
name|zone
argument_list|,
name|notify
operator|->
name|flags
argument_list|,
operator|&
name|message
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
goto|goto
name|cleanup
goto|;
name|isc_netaddr_fromsockaddr
argument_list|(
operator|&
name|dstip
argument_list|,
operator|&
name|notify
operator|->
name|dst
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|dns_view_getpeertsig
argument_list|(
name|notify
operator|->
name|zone
operator|->
name|view
argument_list|,
operator|&
name|dstip
argument_list|,
operator|&
name|key
argument_list|)
expr_stmt|;
name|isc_sockaddr_format
argument_list|(
operator|&
name|notify
operator|->
name|dst
argument_list|,
name|addrbuf
argument_list|,
sizeof|sizeof
argument_list|(
name|addrbuf
argument_list|)
argument_list|)
expr_stmt|;
name|notify_log
argument_list|(
name|notify
operator|->
name|zone
argument_list|,
name|ISC_LOG_DEBUG
argument_list|(
literal|3
argument_list|)
argument_list|,
literal|"sending notify to %s"
argument_list|,
name|addrbuf
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|isc_sockaddr_pf
argument_list|(
operator|&
name|notify
operator|->
name|dst
argument_list|)
condition|)
block|{
case|case
name|PF_INET
case|:
name|src
operator|=
name|notify
operator|->
name|zone
operator|->
name|notifysrc4
expr_stmt|;
break|break;
case|case
name|PF_INET6
case|:
name|src
operator|=
name|notify
operator|->
name|zone
operator|->
name|notifysrc6
expr_stmt|;
break|break;
default|default:
name|result
operator|=
name|ISC_R_NOTIMPLEMENTED
expr_stmt|;
goto|goto
name|cleanup_key
goto|;
block|}
name|timeout
operator|=
literal|15
expr_stmt|;
if|if
condition|(
name|DNS_ZONE_FLAG
argument_list|(
name|notify
operator|->
name|zone
argument_list|,
name|DNS_ZONEFLG_DIALNOTIFY
argument_list|)
condition|)
name|timeout
operator|=
literal|30
expr_stmt|;
name|result
operator|=
name|dns_request_createvia2
argument_list|(
name|notify
operator|->
name|zone
operator|->
name|view
operator|->
name|requestmgr
argument_list|,
name|message
argument_list|,
operator|&
name|src
argument_list|,
operator|&
name|notify
operator|->
name|dst
argument_list|,
literal|0
argument_list|,
name|key
argument_list|,
name|timeout
operator|*
literal|3
argument_list|,
name|timeout
argument_list|,
name|notify
operator|->
name|zone
operator|->
name|task
argument_list|,
name|notify_done
argument_list|,
name|notify
argument_list|,
operator|&
name|notify
operator|->
name|request
argument_list|)
expr_stmt|;
name|cleanup_key
label|:
if|if
condition|(
name|key
operator|!=
name|NULL
condition|)
name|dns_tsigkey_detach
argument_list|(
operator|&
name|key
argument_list|)
expr_stmt|;
name|dns_message_destroy
argument_list|(
operator|&
name|message
argument_list|)
expr_stmt|;
name|cleanup
label|:
name|UNLOCK_ZONE
argument_list|(
name|notify
operator|->
name|zone
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
name|notify_destroy
argument_list|(
name|notify
argument_list|,
name|ISC_FALSE
argument_list|)
expr_stmt|;
name|isc_event_free
argument_list|(
operator|&
name|event
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|notify_send
parameter_list|(
name|dns_notify_t
modifier|*
name|notify
parameter_list|)
block|{
name|dns_adbaddrinfo_t
modifier|*
name|ai
decl_stmt|;
name|isc_sockaddr_t
name|dst
decl_stmt|;
name|isc_result_t
name|result
decl_stmt|;
name|dns_notify_t
modifier|*
name|new
init|=
name|NULL
decl_stmt|;
comment|/* 	 * Zone lock held by caller. 	 */
name|REQUIRE
argument_list|(
name|DNS_NOTIFY_VALID
argument_list|(
name|notify
argument_list|)
argument_list|)
expr_stmt|;
name|REQUIRE
argument_list|(
name|LOCKED_ZONE
argument_list|(
name|notify
operator|->
name|zone
argument_list|)
argument_list|)
expr_stmt|;
for|for
control|(
name|ai
operator|=
name|ISC_LIST_HEAD
argument_list|(
name|notify
operator|->
name|find
operator|->
name|list
argument_list|)
init|;
name|ai
operator|!=
name|NULL
condition|;
name|ai
operator|=
name|ISC_LIST_NEXT
argument_list|(
name|ai
argument_list|,
name|publink
argument_list|)
control|)
block|{
name|dst
operator|=
name|ai
operator|->
name|sockaddr
expr_stmt|;
if|if
condition|(
name|notify_isqueued
argument_list|(
name|notify
operator|->
name|zone
argument_list|,
name|NULL
argument_list|,
operator|&
name|dst
argument_list|)
condition|)
continue|continue;
name|new
operator|=
name|NULL
expr_stmt|;
name|result
operator|=
name|notify_create
argument_list|(
name|notify
operator|->
name|mctx
argument_list|,
operator|(
name|notify
operator|->
name|flags
operator|&
name|DNS_NOTIFY_NOSOA
operator|)
argument_list|,
operator|&
name|new
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
goto|goto
name|cleanup
goto|;
name|zone_iattach
argument_list|(
name|notify
operator|->
name|zone
argument_list|,
operator|&
name|new
operator|->
name|zone
argument_list|)
expr_stmt|;
name|ISC_LIST_APPEND
argument_list|(
name|new
operator|->
name|zone
operator|->
name|notifies
argument_list|,
name|new
argument_list|,
name|link
argument_list|)
expr_stmt|;
name|new
operator|->
name|dst
operator|=
name|dst
expr_stmt|;
name|result
operator|=
name|notify_send_queue
argument_list|(
name|new
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
goto|goto
name|cleanup
goto|;
name|new
operator|=
name|NULL
expr_stmt|;
block|}
name|cleanup
label|:
if|if
condition|(
name|new
operator|!=
name|NULL
condition|)
name|notify_destroy
argument_list|(
name|new
argument_list|,
name|ISC_TRUE
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|dns_zone_notify
parameter_list|(
name|dns_zone_t
modifier|*
name|zone
parameter_list|)
block|{
name|isc_time_t
name|now
decl_stmt|;
name|REQUIRE
argument_list|(
name|DNS_ZONE_VALID
argument_list|(
name|zone
argument_list|)
argument_list|)
expr_stmt|;
name|LOCK_ZONE
argument_list|(
name|zone
argument_list|)
expr_stmt|;
name|DNS_ZONE_SETFLAG
argument_list|(
name|zone
argument_list|,
name|DNS_ZONEFLG_NEEDNOTIFY
argument_list|)
expr_stmt|;
name|TIME_NOW
argument_list|(
operator|&
name|now
argument_list|)
expr_stmt|;
name|zone_settimer
argument_list|(
name|zone
argument_list|,
operator|&
name|now
argument_list|)
expr_stmt|;
name|UNLOCK_ZONE
argument_list|(
name|zone
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|zone_notify
parameter_list|(
name|dns_zone_t
modifier|*
name|zone
parameter_list|)
block|{
name|dns_dbnode_t
modifier|*
name|node
init|=
name|NULL
decl_stmt|;
name|dns_dbversion_t
modifier|*
name|version
init|=
name|NULL
decl_stmt|;
name|dns_name_t
modifier|*
name|origin
init|=
name|NULL
decl_stmt|;
name|dns_name_t
name|master
decl_stmt|;
name|dns_rdata_ns_t
name|ns
decl_stmt|;
name|dns_rdata_soa_t
name|soa
decl_stmt|;
name|isc_uint32_t
name|serial
decl_stmt|;
name|dns_rdata_t
name|rdata
init|=
name|DNS_RDATA_INIT
decl_stmt|;
name|dns_rdataset_t
name|nsrdset
decl_stmt|;
name|dns_rdataset_t
name|soardset
decl_stmt|;
name|isc_result_t
name|result
decl_stmt|;
name|dns_notify_t
modifier|*
name|notify
init|=
name|NULL
decl_stmt|;
name|unsigned
name|int
name|i
decl_stmt|;
name|isc_sockaddr_t
name|dst
decl_stmt|;
name|isc_boolean_t
name|isqueued
decl_stmt|;
name|dns_notifytype_t
name|notifytype
decl_stmt|;
name|unsigned
name|int
name|flags
init|=
literal|0
decl_stmt|;
name|isc_boolean_t
name|loggednotify
init|=
name|ISC_FALSE
decl_stmt|;
name|dns_db_t
modifier|*
name|db
init|=
name|NULL
decl_stmt|;
name|REQUIRE
argument_list|(
name|DNS_ZONE_VALID
argument_list|(
name|zone
argument_list|)
argument_list|)
expr_stmt|;
name|LOCK_ZONE
argument_list|(
name|zone
argument_list|)
expr_stmt|;
name|DNS_ZONE_CLRFLAG
argument_list|(
name|zone
argument_list|,
name|DNS_ZONEFLG_NEEDNOTIFY
argument_list|)
expr_stmt|;
name|notifytype
operator|=
name|zone
operator|->
name|notifytype
expr_stmt|;
name|UNLOCK_ZONE
argument_list|(
name|zone
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|DNS_ZONE_FLAG
argument_list|(
name|zone
argument_list|,
name|DNS_ZONEFLG_LOADED
argument_list|)
condition|)
return|return;
if|if
condition|(
name|notifytype
operator|==
name|dns_notifytype_no
condition|)
return|return;
name|LOCK_ZONE
argument_list|(
name|zone
argument_list|)
expr_stmt|;
if|if
condition|(
name|zone
operator|->
name|db
operator|!=
name|NULL
condition|)
name|dns_db_attach
argument_list|(
name|zone
operator|->
name|db
argument_list|,
operator|&
name|db
argument_list|)
expr_stmt|;
name|UNLOCK_ZONE
argument_list|(
name|zone
argument_list|)
expr_stmt|;
if|if
condition|(
name|db
operator|==
name|NULL
condition|)
return|return;
name|origin
operator|=
operator|&
name|zone
operator|->
name|origin
expr_stmt|;
comment|/* 	 * If the zone is dialup we are done as we don't want to send 	 * the current soa so as to force a refresh query. 	 */
if|if
condition|(
name|DNS_ZONE_FLAG
argument_list|(
name|zone
argument_list|,
name|DNS_ZONEFLG_DIALNOTIFY
argument_list|)
condition|)
name|flags
operator||=
name|DNS_NOTIFY_NOSOA
expr_stmt|;
comment|/* 	 * Get SOA RRset. 	 */
name|dns_db_currentversion
argument_list|(
name|db
argument_list|,
operator|&
name|version
argument_list|)
expr_stmt|;
name|result
operator|=
name|dns_db_findnode
argument_list|(
name|db
argument_list|,
name|origin
argument_list|,
name|ISC_FALSE
argument_list|,
operator|&
name|node
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
goto|goto
name|cleanup1
goto|;
name|dns_rdataset_init
argument_list|(
operator|&
name|soardset
argument_list|)
expr_stmt|;
name|result
operator|=
name|dns_db_findrdataset
argument_list|(
name|db
argument_list|,
name|node
argument_list|,
name|version
argument_list|,
name|dns_rdatatype_soa
argument_list|,
name|dns_rdatatype_none
argument_list|,
literal|0
argument_list|,
operator|&
name|soardset
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
goto|goto
name|cleanup2
goto|;
comment|/* 	 * Find serial and master server's name. 	 */
name|dns_name_init
argument_list|(
operator|&
name|master
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|result
operator|=
name|dns_rdataset_first
argument_list|(
operator|&
name|soardset
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
goto|goto
name|cleanup3
goto|;
name|dns_rdataset_current
argument_list|(
operator|&
name|soardset
argument_list|,
operator|&
name|rdata
argument_list|)
expr_stmt|;
name|result
operator|=
name|dns_rdata_tostruct
argument_list|(
operator|&
name|rdata
argument_list|,
operator|&
name|soa
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|RUNTIME_CHECK
argument_list|(
name|result
operator|==
name|ISC_R_SUCCESS
argument_list|)
expr_stmt|;
name|dns_rdata_reset
argument_list|(
operator|&
name|rdata
argument_list|)
expr_stmt|;
name|result
operator|=
name|dns_name_dup
argument_list|(
operator|&
name|soa
operator|.
name|origin
argument_list|,
name|zone
operator|->
name|mctx
argument_list|,
operator|&
name|master
argument_list|)
expr_stmt|;
name|serial
operator|=
name|soa
operator|.
name|serial
expr_stmt|;
name|dns_rdataset_disassociate
argument_list|(
operator|&
name|soardset
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
goto|goto
name|cleanup3
goto|;
comment|/* 	 * Enqueue notify requests for 'also-notify' servers. 	 */
name|LOCK_ZONE
argument_list|(
name|zone
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|zone
operator|->
name|notifycnt
condition|;
name|i
operator|++
control|)
block|{
name|dst
operator|=
name|zone
operator|->
name|notify
index|[
name|i
index|]
expr_stmt|;
if|if
condition|(
name|notify_isqueued
argument_list|(
name|zone
argument_list|,
name|NULL
argument_list|,
operator|&
name|dst
argument_list|)
condition|)
continue|continue;
name|result
operator|=
name|notify_create
argument_list|(
name|zone
operator|->
name|mctx
argument_list|,
name|flags
argument_list|,
operator|&
name|notify
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
continue|continue;
name|zone_iattach
argument_list|(
name|zone
argument_list|,
operator|&
name|notify
operator|->
name|zone
argument_list|)
expr_stmt|;
name|notify
operator|->
name|dst
operator|=
name|dst
expr_stmt|;
name|ISC_LIST_APPEND
argument_list|(
name|zone
operator|->
name|notifies
argument_list|,
name|notify
argument_list|,
name|link
argument_list|)
expr_stmt|;
name|result
operator|=
name|notify_send_queue
argument_list|(
name|notify
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
name|notify_destroy
argument_list|(
name|notify
argument_list|,
name|ISC_TRUE
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|loggednotify
condition|)
block|{
name|notify_log
argument_list|(
name|zone
argument_list|,
name|ISC_LOG_INFO
argument_list|,
literal|"sending notifies (serial %u)"
argument_list|,
name|serial
argument_list|)
expr_stmt|;
name|loggednotify
operator|=
name|ISC_TRUE
expr_stmt|;
block|}
name|notify
operator|=
name|NULL
expr_stmt|;
block|}
name|UNLOCK_ZONE
argument_list|(
name|zone
argument_list|)
expr_stmt|;
if|if
condition|(
name|notifytype
operator|==
name|dns_notifytype_explicit
condition|)
goto|goto
name|cleanup3
goto|;
comment|/* 	 * Process NS RRset to generate notifies. 	 */
name|dns_rdataset_init
argument_list|(
operator|&
name|nsrdset
argument_list|)
expr_stmt|;
name|result
operator|=
name|dns_db_findrdataset
argument_list|(
name|db
argument_list|,
name|node
argument_list|,
name|version
argument_list|,
name|dns_rdatatype_ns
argument_list|,
name|dns_rdatatype_none
argument_list|,
literal|0
argument_list|,
operator|&
name|nsrdset
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
goto|goto
name|cleanup3
goto|;
name|result
operator|=
name|dns_rdataset_first
argument_list|(
operator|&
name|nsrdset
argument_list|)
expr_stmt|;
while|while
condition|(
name|result
operator|==
name|ISC_R_SUCCESS
condition|)
block|{
name|dns_rdataset_current
argument_list|(
operator|&
name|nsrdset
argument_list|,
operator|&
name|rdata
argument_list|)
expr_stmt|;
name|result
operator|=
name|dns_rdata_tostruct
argument_list|(
operator|&
name|rdata
argument_list|,
operator|&
name|ns
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|RUNTIME_CHECK
argument_list|(
name|result
operator|==
name|ISC_R_SUCCESS
argument_list|)
expr_stmt|;
name|dns_rdata_reset
argument_list|(
operator|&
name|rdata
argument_list|)
expr_stmt|;
comment|/* 		 * don't notify the master server. 		 */
if|if
condition|(
name|dns_name_compare
argument_list|(
operator|&
name|master
argument_list|,
operator|&
name|ns
operator|.
name|name
argument_list|)
operator|==
literal|0
condition|)
block|{
name|result
operator|=
name|dns_rdataset_next
argument_list|(
operator|&
name|nsrdset
argument_list|)
expr_stmt|;
continue|continue;
block|}
if|if
condition|(
operator|!
name|loggednotify
condition|)
block|{
name|notify_log
argument_list|(
name|zone
argument_list|,
name|ISC_LOG_INFO
argument_list|,
literal|"sending notifies (serial %u)"
argument_list|,
name|serial
argument_list|)
expr_stmt|;
name|loggednotify
operator|=
name|ISC_TRUE
expr_stmt|;
block|}
name|LOCK_ZONE
argument_list|(
name|zone
argument_list|)
expr_stmt|;
name|isqueued
operator|=
name|notify_isqueued
argument_list|(
name|zone
argument_list|,
operator|&
name|ns
operator|.
name|name
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|UNLOCK_ZONE
argument_list|(
name|zone
argument_list|)
expr_stmt|;
if|if
condition|(
name|isqueued
condition|)
block|{
name|result
operator|=
name|dns_rdataset_next
argument_list|(
operator|&
name|nsrdset
argument_list|)
expr_stmt|;
continue|continue;
block|}
name|result
operator|=
name|notify_create
argument_list|(
name|zone
operator|->
name|mctx
argument_list|,
name|flags
argument_list|,
operator|&
name|notify
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
continue|continue;
name|dns_zone_iattach
argument_list|(
name|zone
argument_list|,
operator|&
name|notify
operator|->
name|zone
argument_list|)
expr_stmt|;
name|result
operator|=
name|dns_name_dup
argument_list|(
operator|&
name|ns
operator|.
name|name
argument_list|,
name|zone
operator|->
name|mctx
argument_list|,
operator|&
name|notify
operator|->
name|ns
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
block|{
name|LOCK_ZONE
argument_list|(
name|zone
argument_list|)
expr_stmt|;
name|notify_destroy
argument_list|(
name|notify
argument_list|,
name|ISC_TRUE
argument_list|)
expr_stmt|;
name|UNLOCK_ZONE
argument_list|(
name|zone
argument_list|)
expr_stmt|;
continue|continue;
block|}
name|LOCK_ZONE
argument_list|(
name|zone
argument_list|)
expr_stmt|;
name|ISC_LIST_APPEND
argument_list|(
name|zone
operator|->
name|notifies
argument_list|,
name|notify
argument_list|,
name|link
argument_list|)
expr_stmt|;
name|UNLOCK_ZONE
argument_list|(
name|zone
argument_list|)
expr_stmt|;
name|notify_find_address
argument_list|(
name|notify
argument_list|)
expr_stmt|;
name|notify
operator|=
name|NULL
expr_stmt|;
name|result
operator|=
name|dns_rdataset_next
argument_list|(
operator|&
name|nsrdset
argument_list|)
expr_stmt|;
block|}
name|dns_rdataset_disassociate
argument_list|(
operator|&
name|nsrdset
argument_list|)
expr_stmt|;
name|cleanup3
label|:
if|if
condition|(
name|dns_name_dynamic
argument_list|(
operator|&
name|master
argument_list|)
condition|)
name|dns_name_free
argument_list|(
operator|&
name|master
argument_list|,
name|zone
operator|->
name|mctx
argument_list|)
expr_stmt|;
name|cleanup2
label|:
name|dns_db_detachnode
argument_list|(
name|db
argument_list|,
operator|&
name|node
argument_list|)
expr_stmt|;
name|cleanup1
label|:
name|dns_db_closeversion
argument_list|(
name|db
argument_list|,
operator|&
name|version
argument_list|,
name|ISC_FALSE
argument_list|)
expr_stmt|;
name|dns_db_detach
argument_list|(
operator|&
name|db
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/***  *** Private  ***/
end_comment

begin_function
specifier|static
specifier|inline
name|isc_result_t
name|save_nsrrset
parameter_list|(
name|dns_message_t
modifier|*
name|message
parameter_list|,
name|dns_name_t
modifier|*
name|name
parameter_list|,
name|dns_db_t
modifier|*
name|db
parameter_list|,
name|dns_dbversion_t
modifier|*
name|version
parameter_list|)
block|{
name|dns_rdataset_t
modifier|*
name|nsrdataset
init|=
name|NULL
decl_stmt|;
name|dns_rdataset_t
modifier|*
name|rdataset
init|=
name|NULL
decl_stmt|;
name|dns_dbnode_t
modifier|*
name|node
init|=
name|NULL
decl_stmt|;
name|dns_rdata_ns_t
name|ns
decl_stmt|;
name|isc_result_t
name|result
decl_stmt|;
name|dns_rdata_t
name|rdata
init|=
name|DNS_RDATA_INIT
decl_stmt|;
comment|/* 	 * Extract NS RRset from message. 	 */
name|result
operator|=
name|dns_message_findname
argument_list|(
name|message
argument_list|,
name|DNS_SECTION_ANSWER
argument_list|,
name|name
argument_list|,
name|dns_rdatatype_ns
argument_list|,
name|dns_rdatatype_none
argument_list|,
name|NULL
argument_list|,
operator|&
name|nsrdataset
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
goto|goto
name|fail
goto|;
comment|/* 	 * Add NS rdataset. 	 */
name|result
operator|=
name|dns_db_findnode
argument_list|(
name|db
argument_list|,
name|name
argument_list|,
name|ISC_TRUE
argument_list|,
operator|&
name|node
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
goto|goto
name|fail
goto|;
name|result
operator|=
name|dns_db_addrdataset
argument_list|(
name|db
argument_list|,
name|node
argument_list|,
name|version
argument_list|,
literal|0
argument_list|,
name|nsrdataset
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|dns_db_detachnode
argument_list|(
name|db
argument_list|,
operator|&
name|node
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
goto|goto
name|fail
goto|;
comment|/* 	 * Add glue rdatasets. 	 */
for|for
control|(
name|result
operator|=
name|dns_rdataset_first
argument_list|(
name|nsrdataset
argument_list|)
init|;
name|result
operator|==
name|ISC_R_SUCCESS
condition|;
name|result
operator|=
name|dns_rdataset_next
argument_list|(
name|nsrdataset
argument_list|)
control|)
block|{
name|dns_rdataset_current
argument_list|(
name|nsrdataset
argument_list|,
operator|&
name|rdata
argument_list|)
expr_stmt|;
name|result
operator|=
name|dns_rdata_tostruct
argument_list|(
operator|&
name|rdata
argument_list|,
operator|&
name|ns
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|RUNTIME_CHECK
argument_list|(
name|result
operator|==
name|ISC_R_SUCCESS
argument_list|)
expr_stmt|;
name|dns_rdata_reset
argument_list|(
operator|&
name|rdata
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|dns_name_issubdomain
argument_list|(
operator|&
name|ns
operator|.
name|name
argument_list|,
name|name
argument_list|)
condition|)
continue|continue;
name|rdataset
operator|=
name|NULL
expr_stmt|;
name|result
operator|=
name|dns_message_findname
argument_list|(
name|message
argument_list|,
name|DNS_SECTION_ADDITIONAL
argument_list|,
operator|&
name|ns
operator|.
name|name
argument_list|,
name|dns_rdatatype_aaaa
argument_list|,
name|dns_rdatatype_none
argument_list|,
name|NULL
argument_list|,
operator|&
name|rdataset
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|==
name|ISC_R_SUCCESS
condition|)
block|{
name|result
operator|=
name|dns_db_findnode
argument_list|(
name|db
argument_list|,
operator|&
name|ns
operator|.
name|name
argument_list|,
name|ISC_TRUE
argument_list|,
operator|&
name|node
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
goto|goto
name|fail
goto|;
name|result
operator|=
name|dns_db_addrdataset
argument_list|(
name|db
argument_list|,
name|node
argument_list|,
name|version
argument_list|,
literal|0
argument_list|,
name|rdataset
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|dns_db_detachnode
argument_list|(
name|db
argument_list|,
operator|&
name|node
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
goto|goto
name|fail
goto|;
block|}
name|rdataset
operator|=
name|NULL
expr_stmt|;
name|result
operator|=
name|dns_message_findname
argument_list|(
name|message
argument_list|,
name|DNS_SECTION_ADDITIONAL
argument_list|,
operator|&
name|ns
operator|.
name|name
argument_list|,
name|dns_rdatatype_a
argument_list|,
name|dns_rdatatype_none
argument_list|,
name|NULL
argument_list|,
operator|&
name|rdataset
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|==
name|ISC_R_SUCCESS
condition|)
block|{
name|result
operator|=
name|dns_db_findnode
argument_list|(
name|db
argument_list|,
operator|&
name|ns
operator|.
name|name
argument_list|,
name|ISC_TRUE
argument_list|,
operator|&
name|node
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
goto|goto
name|fail
goto|;
name|result
operator|=
name|dns_db_addrdataset
argument_list|(
name|db
argument_list|,
name|node
argument_list|,
name|version
argument_list|,
literal|0
argument_list|,
name|rdataset
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|dns_db_detachnode
argument_list|(
name|db
argument_list|,
operator|&
name|node
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
goto|goto
name|fail
goto|;
block|}
block|}
if|if
condition|(
name|result
operator|!=
name|ISC_R_NOMORE
condition|)
goto|goto
name|fail
goto|;
return|return
operator|(
name|ISC_R_SUCCESS
operator|)
return|;
name|fail
label|:
return|return
operator|(
name|result
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|stub_callback
parameter_list|(
name|isc_task_t
modifier|*
name|task
parameter_list|,
name|isc_event_t
modifier|*
name|event
parameter_list|)
block|{
specifier|const
name|char
name|me
index|[]
init|=
literal|"stub_callback"
decl_stmt|;
name|dns_requestevent_t
modifier|*
name|revent
init|=
operator|(
name|dns_requestevent_t
operator|*
operator|)
name|event
decl_stmt|;
name|dns_stub_t
modifier|*
name|stub
init|=
name|NULL
decl_stmt|;
name|dns_message_t
modifier|*
name|msg
init|=
name|NULL
decl_stmt|;
name|dns_zone_t
modifier|*
name|zone
init|=
name|NULL
decl_stmt|;
name|char
name|master
index|[
name|ISC_SOCKADDR_FORMATSIZE
index|]
decl_stmt|;
name|char
name|source
index|[
name|ISC_SOCKADDR_FORMATSIZE
index|]
decl_stmt|;
name|isc_uint32_t
name|nscnt
decl_stmt|,
name|cnamecnt
decl_stmt|;
name|isc_result_t
name|result
decl_stmt|;
name|isc_time_t
name|now
decl_stmt|;
name|isc_boolean_t
name|exiting
init|=
name|ISC_FALSE
decl_stmt|;
name|isc_interval_t
name|i
decl_stmt|;
name|unsigned
name|int
name|j
decl_stmt|;
name|stub
operator|=
name|revent
operator|->
name|ev_arg
expr_stmt|;
name|INSIST
argument_list|(
name|DNS_STUB_VALID
argument_list|(
name|stub
argument_list|)
argument_list|)
expr_stmt|;
name|UNUSED
argument_list|(
name|task
argument_list|)
expr_stmt|;
name|zone
operator|=
name|stub
operator|->
name|zone
expr_stmt|;
name|ENTER
expr_stmt|;
name|TIME_NOW
argument_list|(
operator|&
name|now
argument_list|)
expr_stmt|;
if|if
condition|(
name|DNS_ZONE_FLAG
argument_list|(
name|zone
argument_list|,
name|DNS_ZONEFLG_EXITING
argument_list|)
condition|)
block|{
name|zone_debuglog
argument_list|(
name|zone
argument_list|,
name|me
argument_list|,
literal|1
argument_list|,
literal|"exiting"
argument_list|)
expr_stmt|;
name|exiting
operator|=
name|ISC_TRUE
expr_stmt|;
goto|goto
name|next_master
goto|;
block|}
name|isc_sockaddr_format
argument_list|(
operator|&
name|zone
operator|->
name|masteraddr
argument_list|,
name|master
argument_list|,
sizeof|sizeof
argument_list|(
name|master
argument_list|)
argument_list|)
expr_stmt|;
name|isc_sockaddr_format
argument_list|(
operator|&
name|zone
operator|->
name|sourceaddr
argument_list|,
name|source
argument_list|,
sizeof|sizeof
argument_list|(
name|source
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|revent
operator|->
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
block|{
if|if
condition|(
name|revent
operator|->
name|result
operator|==
name|ISC_R_TIMEDOUT
operator|&&
operator|!
name|DNS_ZONE_FLAG
argument_list|(
name|zone
argument_list|,
name|DNS_ZONEFLG_NOEDNS
argument_list|)
condition|)
block|{
name|LOCK_ZONE
argument_list|(
name|zone
argument_list|)
expr_stmt|;
name|DNS_ZONE_SETFLAG
argument_list|(
name|zone
argument_list|,
name|DNS_ZONEFLG_NOEDNS
argument_list|)
expr_stmt|;
name|UNLOCK_ZONE
argument_list|(
name|zone
argument_list|)
expr_stmt|;
name|dns_zone_log
argument_list|(
name|zone
argument_list|,
name|ISC_LOG_DEBUG
argument_list|(
literal|1
argument_list|)
argument_list|,
literal|"refreshing stub: timeout retrying "
literal|" without EDNS master %s (source %s)"
argument_list|,
name|master
argument_list|,
name|source
argument_list|)
expr_stmt|;
goto|goto
name|same_master
goto|;
block|}
name|dns_zone_log
argument_list|(
name|zone
argument_list|,
name|ISC_LOG_INFO
argument_list|,
literal|"could not refresh stub from master %s"
literal|" (source %s): %s"
argument_list|,
name|master
argument_list|,
name|source
argument_list|,
name|dns_result_totext
argument_list|(
name|revent
operator|->
name|result
argument_list|)
argument_list|)
expr_stmt|;
goto|goto
name|next_master
goto|;
block|}
name|result
operator|=
name|dns_message_create
argument_list|(
name|zone
operator|->
name|mctx
argument_list|,
name|DNS_MESSAGE_INTENTPARSE
argument_list|,
operator|&
name|msg
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
goto|goto
name|next_master
goto|;
name|result
operator|=
name|dns_request_getresponse
argument_list|(
name|revent
operator|->
name|request
argument_list|,
name|msg
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
goto|goto
name|next_master
goto|;
comment|/* 	 * Unexpected rcode. 	 */
if|if
condition|(
name|msg
operator|->
name|rcode
operator|!=
name|dns_rcode_noerror
condition|)
block|{
name|char
name|rcode
index|[
literal|128
index|]
decl_stmt|;
name|isc_buffer_t
name|rb
decl_stmt|;
name|isc_buffer_init
argument_list|(
operator|&
name|rb
argument_list|,
name|rcode
argument_list|,
sizeof|sizeof
argument_list|(
name|rcode
argument_list|)
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|dns_rcode_totext
argument_list|(
name|msg
operator|->
name|rcode
argument_list|,
operator|&
name|rb
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|DNS_ZONE_FLAG
argument_list|(
name|zone
argument_list|,
name|DNS_ZONEFLG_NOEDNS
argument_list|)
operator|&&
operator|(
name|msg
operator|->
name|rcode
operator|==
name|dns_rcode_servfail
operator|||
name|msg
operator|->
name|rcode
operator|==
name|dns_rcode_notimp
operator|||
name|msg
operator|->
name|rcode
operator|==
name|dns_rcode_formerr
operator|)
condition|)
block|{
name|dns_zone_log
argument_list|(
name|zone
argument_list|,
name|ISC_LOG_DEBUG
argument_list|(
literal|1
argument_list|)
argument_list|,
literal|"refreshing stub: rcode (%.*s) retrying "
literal|"without EDNS master %s (source %s)"
argument_list|,
operator|(
name|int
operator|)
name|rb
operator|.
name|used
argument_list|,
name|rcode
argument_list|,
name|master
argument_list|,
name|source
argument_list|)
expr_stmt|;
name|LOCK_ZONE
argument_list|(
name|zone
argument_list|)
expr_stmt|;
name|DNS_ZONE_SETFLAG
argument_list|(
name|zone
argument_list|,
name|DNS_ZONEFLG_NOEDNS
argument_list|)
expr_stmt|;
name|UNLOCK_ZONE
argument_list|(
name|zone
argument_list|)
expr_stmt|;
goto|goto
name|same_master
goto|;
block|}
name|dns_zone_log
argument_list|(
name|zone
argument_list|,
name|ISC_LOG_INFO
argument_list|,
literal|"refreshing stub: "
literal|"unexpected rcode (%.*s) from %s (source %s)"
argument_list|,
operator|(
name|int
operator|)
name|rb
operator|.
name|used
argument_list|,
name|rcode
argument_list|,
name|master
argument_list|,
name|source
argument_list|)
expr_stmt|;
goto|goto
name|next_master
goto|;
block|}
comment|/* 	 * We need complete messages. 	 */
if|if
condition|(
operator|(
name|msg
operator|->
name|flags
operator|&
name|DNS_MESSAGEFLAG_TC
operator|)
operator|!=
literal|0
condition|)
block|{
if|if
condition|(
name|dns_request_usedtcp
argument_list|(
name|revent
operator|->
name|request
argument_list|)
condition|)
block|{
name|dns_zone_log
argument_list|(
name|zone
argument_list|,
name|ISC_LOG_INFO
argument_list|,
literal|"refreshing stub: truncated TCP "
literal|"response from master %s (source %s)"
argument_list|,
name|master
argument_list|,
name|source
argument_list|)
expr_stmt|;
goto|goto
name|next_master
goto|;
block|}
name|LOCK_ZONE
argument_list|(
name|zone
argument_list|)
expr_stmt|;
name|DNS_ZONE_SETFLAG
argument_list|(
name|zone
argument_list|,
name|DNS_ZONEFLG_USEVC
argument_list|)
expr_stmt|;
name|UNLOCK_ZONE
argument_list|(
name|zone
argument_list|)
expr_stmt|;
goto|goto
name|same_master
goto|;
block|}
comment|/* 	 * If non-auth log and next master. 	 */
if|if
condition|(
operator|(
name|msg
operator|->
name|flags
operator|&
name|DNS_MESSAGEFLAG_AA
operator|)
operator|==
literal|0
condition|)
block|{
name|dns_zone_log
argument_list|(
name|zone
argument_list|,
name|ISC_LOG_INFO
argument_list|,
literal|"refreshing stub: "
literal|"non-authoritative answer from "
literal|"master %s (source %s)"
argument_list|,
name|master
argument_list|,
name|source
argument_list|)
expr_stmt|;
goto|goto
name|next_master
goto|;
block|}
comment|/* 	 * Sanity checks. 	 */
name|cnamecnt
operator|=
name|message_count
argument_list|(
name|msg
argument_list|,
name|DNS_SECTION_ANSWER
argument_list|,
name|dns_rdatatype_cname
argument_list|)
expr_stmt|;
name|nscnt
operator|=
name|message_count
argument_list|(
name|msg
argument_list|,
name|DNS_SECTION_ANSWER
argument_list|,
name|dns_rdatatype_ns
argument_list|)
expr_stmt|;
if|if
condition|(
name|cnamecnt
operator|!=
literal|0
condition|)
block|{
name|dns_zone_log
argument_list|(
name|zone
argument_list|,
name|ISC_LOG_INFO
argument_list|,
literal|"refreshing stub: unexpected CNAME response "
literal|"from master %s (source %s)"
argument_list|,
name|master
argument_list|,
name|source
argument_list|)
expr_stmt|;
goto|goto
name|next_master
goto|;
block|}
if|if
condition|(
name|nscnt
operator|==
literal|0
condition|)
block|{
name|dns_zone_log
argument_list|(
name|zone
argument_list|,
name|ISC_LOG_INFO
argument_list|,
literal|"refreshing stub: no NS records in response "
literal|"from master %s (source %s)"
argument_list|,
name|master
argument_list|,
name|source
argument_list|)
expr_stmt|;
goto|goto
name|next_master
goto|;
block|}
comment|/* 	 * Save answer. 	 */
name|result
operator|=
name|save_nsrrset
argument_list|(
name|msg
argument_list|,
operator|&
name|zone
operator|->
name|origin
argument_list|,
name|stub
operator|->
name|db
argument_list|,
name|stub
operator|->
name|version
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
block|{
name|dns_zone_log
argument_list|(
name|zone
argument_list|,
name|ISC_LOG_INFO
argument_list|,
literal|"refreshing stub: unable to save NS records "
literal|"from master %s (source %s)"
argument_list|,
name|master
argument_list|,
name|source
argument_list|)
expr_stmt|;
goto|goto
name|next_master
goto|;
block|}
comment|/* 	 * Tidy up. 	 */
name|dns_db_closeversion
argument_list|(
name|stub
operator|->
name|db
argument_list|,
operator|&
name|stub
operator|->
name|version
argument_list|,
name|ISC_TRUE
argument_list|)
expr_stmt|;
name|LOCK_ZONE
argument_list|(
name|zone
argument_list|)
expr_stmt|;
if|if
condition|(
name|zone
operator|->
name|db
operator|==
name|NULL
condition|)
name|dns_db_attach
argument_list|(
name|stub
operator|->
name|db
argument_list|,
operator|&
name|zone
operator|->
name|db
argument_list|)
expr_stmt|;
name|UNLOCK_ZONE
argument_list|(
name|zone
argument_list|)
expr_stmt|;
name|dns_db_detach
argument_list|(
operator|&
name|stub
operator|->
name|db
argument_list|)
expr_stmt|;
if|if
condition|(
name|zone
operator|->
name|masterfile
operator|!=
name|NULL
condition|)
block|{
name|dns_zone_dump
argument_list|(
name|zone
argument_list|)
expr_stmt|;
name|TIME_NOW
argument_list|(
operator|&
name|zone
operator|->
name|loadtime
argument_list|)
expr_stmt|;
block|}
name|dns_message_destroy
argument_list|(
operator|&
name|msg
argument_list|)
expr_stmt|;
name|isc_event_free
argument_list|(
operator|&
name|event
argument_list|)
expr_stmt|;
name|LOCK_ZONE
argument_list|(
name|zone
argument_list|)
expr_stmt|;
name|dns_request_destroy
argument_list|(
operator|&
name|zone
operator|->
name|request
argument_list|)
expr_stmt|;
name|DNS_ZONE_CLRFLAG
argument_list|(
name|zone
argument_list|,
name|DNS_ZONEFLG_REFRESH
argument_list|)
expr_stmt|;
name|DNS_ZONE_JITTER_ADD
argument_list|(
operator|&
name|now
argument_list|,
name|zone
operator|->
name|refresh
argument_list|,
operator|&
name|zone
operator|->
name|refreshtime
argument_list|)
expr_stmt|;
name|isc_interval_set
argument_list|(
operator|&
name|i
argument_list|,
name|zone
operator|->
name|expire
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|DNS_ZONE_TIME_ADD
argument_list|(
operator|&
name|now
argument_list|,
name|zone
operator|->
name|expire
argument_list|,
operator|&
name|zone
operator|->
name|expiretime
argument_list|)
expr_stmt|;
name|zone_settimer
argument_list|(
name|zone
argument_list|,
operator|&
name|now
argument_list|)
expr_stmt|;
name|UNLOCK_ZONE
argument_list|(
name|zone
argument_list|)
expr_stmt|;
goto|goto
name|free_stub
goto|;
name|next_master
label|:
if|if
condition|(
name|stub
operator|->
name|version
operator|!=
name|NULL
condition|)
name|dns_db_closeversion
argument_list|(
name|stub
operator|->
name|db
argument_list|,
operator|&
name|stub
operator|->
name|version
argument_list|,
name|ISC_FALSE
argument_list|)
expr_stmt|;
if|if
condition|(
name|stub
operator|->
name|db
operator|!=
name|NULL
condition|)
name|dns_db_detach
argument_list|(
operator|&
name|stub
operator|->
name|db
argument_list|)
expr_stmt|;
if|if
condition|(
name|msg
operator|!=
name|NULL
condition|)
name|dns_message_destroy
argument_list|(
operator|&
name|msg
argument_list|)
expr_stmt|;
name|isc_event_free
argument_list|(
operator|&
name|event
argument_list|)
expr_stmt|;
name|LOCK_ZONE
argument_list|(
name|zone
argument_list|)
expr_stmt|;
name|dns_request_destroy
argument_list|(
operator|&
name|zone
operator|->
name|request
argument_list|)
expr_stmt|;
comment|/* 	 * Skip to next failed / untried master. 	 */
do|do
block|{
name|zone
operator|->
name|curmaster
operator|++
expr_stmt|;
block|}
do|while
condition|(
name|zone
operator|->
name|curmaster
operator|<
name|zone
operator|->
name|masterscnt
operator|&&
name|zone
operator|->
name|mastersok
index|[
name|zone
operator|->
name|curmaster
index|]
condition|)
do|;
name|DNS_ZONE_CLRFLAG
argument_list|(
name|zone
argument_list|,
name|DNS_ZONEFLG_NOEDNS
argument_list|)
expr_stmt|;
if|if
condition|(
name|exiting
operator|||
name|zone
operator|->
name|curmaster
operator|>=
name|zone
operator|->
name|masterscnt
condition|)
block|{
name|isc_boolean_t
name|done
init|=
name|ISC_TRUE
decl_stmt|;
if|if
condition|(
operator|!
name|exiting
operator|&&
name|DNS_ZONE_OPTION
argument_list|(
name|zone
argument_list|,
name|DNS_ZONEOPT_USEALTXFRSRC
argument_list|)
operator|&&
operator|!
name|DNS_ZONE_FLAG
argument_list|(
name|zone
argument_list|,
name|DNS_ZONEFLG_USEALTXFRSRC
argument_list|)
condition|)
block|{
comment|/* 			 * Did we get a good answer from all the masters? 			 */
for|for
control|(
name|j
operator|=
literal|0
init|;
name|j
operator|<
name|zone
operator|->
name|masterscnt
condition|;
name|j
operator|++
control|)
if|if
condition|(
name|zone
operator|->
name|mastersok
index|[
name|j
index|]
operator|==
name|ISC_FALSE
condition|)
block|{
name|done
operator|=
name|ISC_FALSE
expr_stmt|;
break|break;
block|}
block|}
else|else
name|done
operator|=
name|ISC_TRUE
expr_stmt|;
if|if
condition|(
operator|!
name|done
condition|)
block|{
name|zone
operator|->
name|curmaster
operator|=
literal|0
expr_stmt|;
comment|/* 			 * Find the next failed master. 			 */
while|while
condition|(
name|zone
operator|->
name|curmaster
operator|<
name|zone
operator|->
name|masterscnt
operator|&&
name|zone
operator|->
name|mastersok
index|[
name|zone
operator|->
name|curmaster
index|]
condition|)
name|zone
operator|->
name|curmaster
operator|++
expr_stmt|;
name|DNS_ZONE_SETFLAG
argument_list|(
name|zone
argument_list|,
name|DNS_ZONEFLG_USEALTXFRSRC
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|DNS_ZONE_CLRFLAG
argument_list|(
name|zone
argument_list|,
name|DNS_ZONEFLG_REFRESH
argument_list|)
expr_stmt|;
name|zone_settimer
argument_list|(
name|zone
argument_list|,
operator|&
name|now
argument_list|)
expr_stmt|;
name|UNLOCK_ZONE
argument_list|(
name|zone
argument_list|)
expr_stmt|;
goto|goto
name|free_stub
goto|;
block|}
block|}
name|queue_soa_query
argument_list|(
name|zone
argument_list|)
expr_stmt|;
name|UNLOCK_ZONE
argument_list|(
name|zone
argument_list|)
expr_stmt|;
goto|goto
name|free_stub
goto|;
name|same_master
label|:
if|if
condition|(
name|msg
operator|!=
name|NULL
condition|)
name|dns_message_destroy
argument_list|(
operator|&
name|msg
argument_list|)
expr_stmt|;
name|isc_event_free
argument_list|(
operator|&
name|event
argument_list|)
expr_stmt|;
name|LOCK_ZONE
argument_list|(
name|zone
argument_list|)
expr_stmt|;
name|dns_request_destroy
argument_list|(
operator|&
name|zone
operator|->
name|request
argument_list|)
expr_stmt|;
name|UNLOCK_ZONE
argument_list|(
name|zone
argument_list|)
expr_stmt|;
name|ns_query
argument_list|(
name|zone
argument_list|,
name|NULL
argument_list|,
name|stub
argument_list|)
expr_stmt|;
goto|goto
name|done
goto|;
name|free_stub
label|:
name|stub
operator|->
name|magic
operator|=
literal|0
expr_stmt|;
name|dns_zone_idetach
argument_list|(
operator|&
name|stub
operator|->
name|zone
argument_list|)
expr_stmt|;
name|INSIST
argument_list|(
name|stub
operator|->
name|db
operator|==
name|NULL
argument_list|)
expr_stmt|;
name|INSIST
argument_list|(
name|stub
operator|->
name|version
operator|==
name|NULL
argument_list|)
expr_stmt|;
name|isc_mem_put
argument_list|(
name|stub
operator|->
name|mctx
argument_list|,
name|stub
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|stub
argument_list|)
argument_list|)
expr_stmt|;
name|done
label|:
name|INSIST
argument_list|(
name|event
operator|==
name|NULL
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_comment
comment|/*  * An SOA query has finished (successfully or not).  */
end_comment

begin_function
specifier|static
name|void
name|refresh_callback
parameter_list|(
name|isc_task_t
modifier|*
name|task
parameter_list|,
name|isc_event_t
modifier|*
name|event
parameter_list|)
block|{
specifier|const
name|char
name|me
index|[]
init|=
literal|"refresh_callback"
decl_stmt|;
name|dns_requestevent_t
modifier|*
name|revent
init|=
operator|(
name|dns_requestevent_t
operator|*
operator|)
name|event
decl_stmt|;
name|dns_zone_t
modifier|*
name|zone
decl_stmt|;
name|dns_message_t
modifier|*
name|msg
init|=
name|NULL
decl_stmt|;
name|isc_uint32_t
name|soacnt
decl_stmt|,
name|cnamecnt
decl_stmt|,
name|soacount
decl_stmt|,
name|nscount
decl_stmt|;
name|isc_time_t
name|now
decl_stmt|;
name|char
name|master
index|[
name|ISC_SOCKADDR_FORMATSIZE
index|]
decl_stmt|;
name|char
name|source
index|[
name|ISC_SOCKADDR_FORMATSIZE
index|]
decl_stmt|;
name|dns_rdataset_t
modifier|*
name|rdataset
init|=
name|NULL
decl_stmt|;
name|dns_rdata_t
name|rdata
init|=
name|DNS_RDATA_INIT
decl_stmt|;
name|dns_rdata_soa_t
name|soa
decl_stmt|;
name|isc_result_t
name|result
decl_stmt|;
name|isc_uint32_t
name|serial
decl_stmt|;
name|unsigned
name|int
name|j
decl_stmt|;
name|zone
operator|=
name|revent
operator|->
name|ev_arg
expr_stmt|;
name|INSIST
argument_list|(
name|DNS_ZONE_VALID
argument_list|(
name|zone
argument_list|)
argument_list|)
expr_stmt|;
name|UNUSED
argument_list|(
name|task
argument_list|)
expr_stmt|;
name|ENTER
expr_stmt|;
comment|/* 	 * if timeout log and next master; 	 */
name|isc_sockaddr_format
argument_list|(
operator|&
name|zone
operator|->
name|masteraddr
argument_list|,
name|master
argument_list|,
sizeof|sizeof
argument_list|(
name|master
argument_list|)
argument_list|)
expr_stmt|;
name|isc_sockaddr_format
argument_list|(
operator|&
name|zone
operator|->
name|sourceaddr
argument_list|,
name|source
argument_list|,
sizeof|sizeof
argument_list|(
name|source
argument_list|)
argument_list|)
expr_stmt|;
name|TIME_NOW
argument_list|(
operator|&
name|now
argument_list|)
expr_stmt|;
if|if
condition|(
name|revent
operator|->
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
block|{
if|if
condition|(
name|revent
operator|->
name|result
operator|==
name|ISC_R_TIMEDOUT
operator|&&
operator|!
name|DNS_ZONE_FLAG
argument_list|(
name|zone
argument_list|,
name|DNS_ZONEFLG_NOEDNS
argument_list|)
condition|)
block|{
name|LOCK_ZONE
argument_list|(
name|zone
argument_list|)
expr_stmt|;
name|DNS_ZONE_SETFLAG
argument_list|(
name|zone
argument_list|,
name|DNS_ZONEFLG_NOEDNS
argument_list|)
expr_stmt|;
name|UNLOCK_ZONE
argument_list|(
name|zone
argument_list|)
expr_stmt|;
name|dns_zone_log
argument_list|(
name|zone
argument_list|,
name|ISC_LOG_DEBUG
argument_list|(
literal|1
argument_list|)
argument_list|,
literal|"refresh: timeout retrying without EDNS "
literal|"master %s (source %s)"
argument_list|,
name|master
argument_list|,
name|source
argument_list|)
expr_stmt|;
goto|goto
name|same_master
goto|;
block|}
if|if
condition|(
name|revent
operator|->
name|result
operator|==
name|ISC_R_TIMEDOUT
operator|&&
operator|!
name|dns_request_usedtcp
argument_list|(
name|revent
operator|->
name|request
argument_list|)
condition|)
block|{
name|dns_zone_log
argument_list|(
name|zone
argument_list|,
name|ISC_LOG_INFO
argument_list|,
literal|"refresh: retry limit for "
literal|"master %s exceeded (source %s)"
argument_list|,
name|master
argument_list|,
name|source
argument_list|)
expr_stmt|;
comment|/* Try with slave with TCP. */
if|if
condition|(
name|zone
operator|->
name|type
operator|==
name|dns_zone_slave
condition|)
block|{
name|LOCK_ZONE
argument_list|(
name|zone
argument_list|)
expr_stmt|;
name|DNS_ZONE_SETFLAG
argument_list|(
name|zone
argument_list|,
name|DNS_ZONEFLG_SOABEFOREAXFR
argument_list|)
expr_stmt|;
name|UNLOCK_ZONE
argument_list|(
name|zone
argument_list|)
expr_stmt|;
goto|goto
name|tcp_transfer
goto|;
block|}
block|}
else|else
name|dns_zone_log
argument_list|(
name|zone
argument_list|,
name|ISC_LOG_INFO
argument_list|,
literal|"refresh: failure trying master "
literal|"%s (source %s): %s"
argument_list|,
name|master
argument_list|,
name|source
argument_list|,
name|dns_result_totext
argument_list|(
name|revent
operator|->
name|result
argument_list|)
argument_list|)
expr_stmt|;
goto|goto
name|next_master
goto|;
block|}
name|result
operator|=
name|dns_message_create
argument_list|(
name|zone
operator|->
name|mctx
argument_list|,
name|DNS_MESSAGE_INTENTPARSE
argument_list|,
operator|&
name|msg
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
goto|goto
name|next_master
goto|;
name|result
operator|=
name|dns_request_getresponse
argument_list|(
name|revent
operator|->
name|request
argument_list|,
name|msg
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
block|{
name|dns_zone_log
argument_list|(
name|zone
argument_list|,
name|ISC_LOG_INFO
argument_list|,
literal|"refresh: failure trying master "
literal|"%s (source %s): %s"
argument_list|,
name|master
argument_list|,
name|source
argument_list|,
name|dns_result_totext
argument_list|(
name|result
argument_list|)
argument_list|)
expr_stmt|;
goto|goto
name|next_master
goto|;
block|}
comment|/* 	 * Unexpected rcode. 	 */
if|if
condition|(
name|msg
operator|->
name|rcode
operator|!=
name|dns_rcode_noerror
condition|)
block|{
name|char
name|rcode
index|[
literal|128
index|]
decl_stmt|;
name|isc_buffer_t
name|rb
decl_stmt|;
name|isc_buffer_init
argument_list|(
operator|&
name|rb
argument_list|,
name|rcode
argument_list|,
sizeof|sizeof
argument_list|(
name|rcode
argument_list|)
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|dns_rcode_totext
argument_list|(
name|msg
operator|->
name|rcode
argument_list|,
operator|&
name|rb
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|DNS_ZONE_FLAG
argument_list|(
name|zone
argument_list|,
name|DNS_ZONEFLG_NOEDNS
argument_list|)
operator|&&
operator|(
name|msg
operator|->
name|rcode
operator|==
name|dns_rcode_servfail
operator|||
name|msg
operator|->
name|rcode
operator|==
name|dns_rcode_notimp
operator|||
name|msg
operator|->
name|rcode
operator|==
name|dns_rcode_formerr
operator|)
condition|)
block|{
name|dns_zone_log
argument_list|(
name|zone
argument_list|,
name|ISC_LOG_DEBUG
argument_list|(
literal|1
argument_list|)
argument_list|,
literal|"refresh: rcode (%.*s) retrying without "
literal|"EDNS master %s (source %s)"
argument_list|,
operator|(
name|int
operator|)
name|rb
operator|.
name|used
argument_list|,
name|rcode
argument_list|,
name|master
argument_list|,
name|source
argument_list|)
expr_stmt|;
name|LOCK_ZONE
argument_list|(
name|zone
argument_list|)
expr_stmt|;
name|DNS_ZONE_SETFLAG
argument_list|(
name|zone
argument_list|,
name|DNS_ZONEFLG_NOEDNS
argument_list|)
expr_stmt|;
name|UNLOCK_ZONE
argument_list|(
name|zone
argument_list|)
expr_stmt|;
goto|goto
name|same_master
goto|;
block|}
name|dns_zone_log
argument_list|(
name|zone
argument_list|,
name|ISC_LOG_INFO
argument_list|,
literal|"refresh: unexpected rcode (%.*s) from "
literal|"master %s (source %s)"
argument_list|,
operator|(
name|int
operator|)
name|rb
operator|.
name|used
argument_list|,
name|rcode
argument_list|,
name|master
argument_list|,
name|source
argument_list|)
expr_stmt|;
comment|/* 		 * Perhaps AXFR/IXFR is allowed even if SOA queries arn't. 		 */
if|if
condition|(
name|msg
operator|->
name|rcode
operator|==
name|dns_rcode_refused
operator|&&
name|zone
operator|->
name|type
operator|==
name|dns_zone_slave
condition|)
goto|goto
name|tcp_transfer
goto|;
goto|goto
name|next_master
goto|;
block|}
comment|/* 	 * If truncated punt to zone transfer which will query again. 	 */
if|if
condition|(
operator|(
name|msg
operator|->
name|flags
operator|&
name|DNS_MESSAGEFLAG_TC
operator|)
operator|!=
literal|0
condition|)
block|{
if|if
condition|(
name|zone
operator|->
name|type
operator|==
name|dns_zone_slave
condition|)
block|{
name|dns_zone_log
argument_list|(
name|zone
argument_list|,
name|ISC_LOG_INFO
argument_list|,
literal|"refresh: truncated UDP answer, "
literal|"initiating TCP zone xfer "
literal|"for master %s (source %s)"
argument_list|,
name|master
argument_list|,
name|source
argument_list|)
expr_stmt|;
name|LOCK_ZONE
argument_list|(
name|zone
argument_list|)
expr_stmt|;
name|DNS_ZONE_SETFLAG
argument_list|(
name|zone
argument_list|,
name|DNS_ZONEFLG_SOABEFOREAXFR
argument_list|)
expr_stmt|;
name|UNLOCK_ZONE
argument_list|(
name|zone
argument_list|)
expr_stmt|;
goto|goto
name|tcp_transfer
goto|;
block|}
else|else
block|{
name|INSIST
argument_list|(
name|zone
operator|->
name|type
operator|==
name|dns_zone_stub
argument_list|)
expr_stmt|;
if|if
condition|(
name|dns_request_usedtcp
argument_list|(
name|revent
operator|->
name|request
argument_list|)
condition|)
block|{
name|dns_zone_log
argument_list|(
name|zone
argument_list|,
name|ISC_LOG_INFO
argument_list|,
literal|"refresh: truncated TCP response "
literal|"from master %s (source %s)"
argument_list|,
name|master
argument_list|,
name|source
argument_list|)
expr_stmt|;
goto|goto
name|next_master
goto|;
block|}
name|LOCK_ZONE
argument_list|(
name|zone
argument_list|)
expr_stmt|;
name|DNS_ZONE_SETFLAG
argument_list|(
name|zone
argument_list|,
name|DNS_ZONEFLG_USEVC
argument_list|)
expr_stmt|;
name|UNLOCK_ZONE
argument_list|(
name|zone
argument_list|)
expr_stmt|;
goto|goto
name|same_master
goto|;
block|}
block|}
comment|/* 	 * if non-auth log and next master; 	 */
if|if
condition|(
operator|(
name|msg
operator|->
name|flags
operator|&
name|DNS_MESSAGEFLAG_AA
operator|)
operator|==
literal|0
condition|)
block|{
name|dns_zone_log
argument_list|(
name|zone
argument_list|,
name|ISC_LOG_INFO
argument_list|,
literal|"refresh: non-authoritative answer from "
literal|"master %s (source %s)"
argument_list|,
name|master
argument_list|,
name|source
argument_list|)
expr_stmt|;
goto|goto
name|next_master
goto|;
block|}
name|cnamecnt
operator|=
name|message_count
argument_list|(
name|msg
argument_list|,
name|DNS_SECTION_ANSWER
argument_list|,
name|dns_rdatatype_cname
argument_list|)
expr_stmt|;
name|soacnt
operator|=
name|message_count
argument_list|(
name|msg
argument_list|,
name|DNS_SECTION_ANSWER
argument_list|,
name|dns_rdatatype_soa
argument_list|)
expr_stmt|;
name|nscount
operator|=
name|message_count
argument_list|(
name|msg
argument_list|,
name|DNS_SECTION_AUTHORITY
argument_list|,
name|dns_rdatatype_ns
argument_list|)
expr_stmt|;
name|soacount
operator|=
name|message_count
argument_list|(
name|msg
argument_list|,
name|DNS_SECTION_AUTHORITY
argument_list|,
name|dns_rdatatype_soa
argument_list|)
expr_stmt|;
comment|/* 	 * There should not be a CNAME record at top of zone. 	 */
if|if
condition|(
name|cnamecnt
operator|!=
literal|0
condition|)
block|{
name|dns_zone_log
argument_list|(
name|zone
argument_list|,
name|ISC_LOG_INFO
argument_list|,
literal|"refresh: CNAME at top of zone "
literal|"in master %s (source %s)"
argument_list|,
name|master
argument_list|,
name|source
argument_list|)
expr_stmt|;
goto|goto
name|next_master
goto|;
block|}
comment|/* 	 * if referral log and next master; 	 */
if|if
condition|(
name|soacnt
operator|==
literal|0
operator|&&
name|soacount
operator|==
literal|0
operator|&&
name|nscount
operator|!=
literal|0
condition|)
block|{
name|dns_zone_log
argument_list|(
name|zone
argument_list|,
name|ISC_LOG_INFO
argument_list|,
literal|"refresh: referral response "
literal|"from master %s (source %s)"
argument_list|,
name|master
argument_list|,
name|source
argument_list|)
expr_stmt|;
goto|goto
name|next_master
goto|;
block|}
comment|/* 	 * if nodata log and next master; 	 */
if|if
condition|(
name|soacnt
operator|==
literal|0
operator|&&
operator|(
name|nscount
operator|==
literal|0
operator|||
name|soacount
operator|!=
literal|0
operator|)
condition|)
block|{
name|dns_zone_log
argument_list|(
name|zone
argument_list|,
name|ISC_LOG_INFO
argument_list|,
literal|"refresh: NODATA response "
literal|"from master %s (source %s)"
argument_list|,
name|master
argument_list|,
name|source
argument_list|)
expr_stmt|;
goto|goto
name|next_master
goto|;
block|}
comment|/* 	 * Only one soa at top of zone. 	 */
if|if
condition|(
name|soacnt
operator|!=
literal|1
condition|)
block|{
name|dns_zone_log
argument_list|(
name|zone
argument_list|,
name|ISC_LOG_INFO
argument_list|,
literal|"refresh: answer SOA count (%d) != 1 "
literal|"from master %s (source %s)"
argument_list|,
name|soacnt
argument_list|,
name|master
argument_list|,
name|source
argument_list|)
expr_stmt|;
goto|goto
name|next_master
goto|;
block|}
comment|/* 	 * Extract serial 	 */
name|rdataset
operator|=
name|NULL
expr_stmt|;
name|result
operator|=
name|dns_message_findname
argument_list|(
name|msg
argument_list|,
name|DNS_SECTION_ANSWER
argument_list|,
operator|&
name|zone
operator|->
name|origin
argument_list|,
name|dns_rdatatype_soa
argument_list|,
name|dns_rdatatype_none
argument_list|,
name|NULL
argument_list|,
operator|&
name|rdataset
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
block|{
name|dns_zone_log
argument_list|(
name|zone
argument_list|,
name|ISC_LOG_INFO
argument_list|,
literal|"refresh: unable to get SOA record "
literal|"from master %s (source %s)"
argument_list|,
name|master
argument_list|,
name|source
argument_list|)
expr_stmt|;
goto|goto
name|next_master
goto|;
block|}
name|result
operator|=
name|dns_rdataset_first
argument_list|(
name|rdataset
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
block|{
name|dns_zone_log
argument_list|(
name|zone
argument_list|,
name|ISC_LOG_INFO
argument_list|,
literal|"refresh: dns_rdataset_first() failed"
argument_list|)
expr_stmt|;
goto|goto
name|next_master
goto|;
block|}
name|dns_rdataset_current
argument_list|(
name|rdataset
argument_list|,
operator|&
name|rdata
argument_list|)
expr_stmt|;
name|result
operator|=
name|dns_rdata_tostruct
argument_list|(
operator|&
name|rdata
argument_list|,
operator|&
name|soa
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|RUNTIME_CHECK
argument_list|(
name|result
operator|==
name|ISC_R_SUCCESS
argument_list|)
expr_stmt|;
name|serial
operator|=
name|soa
operator|.
name|serial
expr_stmt|;
name|zone_debuglog
argument_list|(
name|zone
argument_list|,
name|me
argument_list|,
literal|1
argument_list|,
literal|"serial: new %u, old %u"
argument_list|,
name|serial
argument_list|,
name|zone
operator|->
name|serial
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|DNS_ZONE_FLAG
argument_list|(
name|zone
argument_list|,
name|DNS_ZONEFLG_LOADED
argument_list|)
operator|||
name|DNS_ZONE_FLAG
argument_list|(
name|zone
argument_list|,
name|DNS_ZONEFLG_FORCEXFER
argument_list|)
operator|||
name|isc_serial_gt
argument_list|(
name|serial
argument_list|,
name|zone
operator|->
name|serial
argument_list|)
condition|)
block|{
name|tcp_transfer
label|:
name|isc_event_free
argument_list|(
operator|&
name|event
argument_list|)
expr_stmt|;
name|LOCK_ZONE
argument_list|(
name|zone
argument_list|)
expr_stmt|;
name|dns_request_destroy
argument_list|(
operator|&
name|zone
operator|->
name|request
argument_list|)
expr_stmt|;
name|UNLOCK_ZONE
argument_list|(
name|zone
argument_list|)
expr_stmt|;
if|if
condition|(
name|zone
operator|->
name|type
operator|==
name|dns_zone_slave
condition|)
block|{
name|queue_xfrin
argument_list|(
name|zone
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|INSIST
argument_list|(
name|zone
operator|->
name|type
operator|==
name|dns_zone_stub
argument_list|)
expr_stmt|;
name|ns_query
argument_list|(
name|zone
argument_list|,
name|rdataset
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|msg
operator|!=
name|NULL
condition|)
name|dns_message_destroy
argument_list|(
operator|&
name|msg
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|isc_serial_eq
argument_list|(
name|soa
operator|.
name|serial
argument_list|,
name|zone
operator|->
name|serial
argument_list|)
condition|)
block|{
if|if
condition|(
name|zone
operator|->
name|masterfile
operator|!=
name|NULL
condition|)
block|{
name|result
operator|=
name|ISC_R_FAILURE
expr_stmt|;
if|if
condition|(
name|zone
operator|->
name|journal
operator|!=
name|NULL
condition|)
name|result
operator|=
name|isc_file_settime
argument_list|(
name|zone
operator|->
name|journal
argument_list|,
operator|&
name|now
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|==
name|ISC_R_SUCCESS
operator|&&
operator|!
name|DNS_ZONE_FLAG
argument_list|(
name|zone
argument_list|,
name|DNS_ZONEFLG_NEEDDUMP
argument_list|)
operator|&&
operator|!
name|DNS_ZONE_FLAG
argument_list|(
name|zone
argument_list|,
name|DNS_ZONEFLG_DUMPING
argument_list|)
condition|)
block|{
name|result
operator|=
name|isc_file_settime
argument_list|(
name|zone
operator|->
name|masterfile
argument_list|,
operator|&
name|now
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
name|result
operator|=
name|isc_file_settime
argument_list|(
name|zone
operator|->
name|masterfile
argument_list|,
operator|&
name|now
argument_list|)
expr_stmt|;
comment|/* Someone removed the file from underneath us! */
if|if
condition|(
name|result
operator|==
name|ISC_R_FILENOTFOUND
condition|)
block|{
name|LOCK_ZONE
argument_list|(
name|zone
argument_list|)
expr_stmt|;
name|zone_needdump
argument_list|(
name|zone
argument_list|,
name|DNS_DUMP_DELAY
argument_list|)
expr_stmt|;
name|UNLOCK_ZONE
argument_list|(
name|zone
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
name|dns_zone_log
argument_list|(
name|zone
argument_list|,
name|ISC_LOG_ERROR
argument_list|,
literal|"refresh: could not set file "
literal|"modification time of '%s': %s"
argument_list|,
name|zone
operator|->
name|masterfile
argument_list|,
name|dns_result_totext
argument_list|(
name|result
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|DNS_ZONE_JITTER_ADD
argument_list|(
operator|&
name|now
argument_list|,
name|zone
operator|->
name|refresh
argument_list|,
operator|&
name|zone
operator|->
name|refreshtime
argument_list|)
expr_stmt|;
name|DNS_ZONE_TIME_ADD
argument_list|(
operator|&
name|now
argument_list|,
name|zone
operator|->
name|expire
argument_list|,
operator|&
name|zone
operator|->
name|expiretime
argument_list|)
expr_stmt|;
name|zone
operator|->
name|mastersok
index|[
name|zone
operator|->
name|curmaster
index|]
operator|=
name|ISC_TRUE
expr_stmt|;
goto|goto
name|next_master
goto|;
block|}
else|else
block|{
if|if
condition|(
operator|!
name|DNS_ZONE_OPTION
argument_list|(
name|zone
argument_list|,
name|DNS_ZONEOPT_MULTIMASTER
argument_list|)
condition|)
name|dns_zone_log
argument_list|(
name|zone
argument_list|,
name|ISC_LOG_INFO
argument_list|,
literal|"serial number (%u) "
literal|"received from master %s< ours (%u)"
argument_list|,
name|soa
operator|.
name|serial
argument_list|,
name|master
argument_list|,
name|zone
operator|->
name|serial
argument_list|)
expr_stmt|;
else|else
name|zone_debuglog
argument_list|(
name|zone
argument_list|,
name|me
argument_list|,
literal|1
argument_list|,
literal|"ahead"
argument_list|)
expr_stmt|;
name|zone
operator|->
name|mastersok
index|[
name|zone
operator|->
name|curmaster
index|]
operator|=
name|ISC_TRUE
expr_stmt|;
goto|goto
name|next_master
goto|;
block|}
if|if
condition|(
name|msg
operator|!=
name|NULL
condition|)
name|dns_message_destroy
argument_list|(
operator|&
name|msg
argument_list|)
expr_stmt|;
goto|goto
name|detach
goto|;
name|next_master
label|:
if|if
condition|(
name|msg
operator|!=
name|NULL
condition|)
name|dns_message_destroy
argument_list|(
operator|&
name|msg
argument_list|)
expr_stmt|;
name|isc_event_free
argument_list|(
operator|&
name|event
argument_list|)
expr_stmt|;
name|LOCK_ZONE
argument_list|(
name|zone
argument_list|)
expr_stmt|;
name|dns_request_destroy
argument_list|(
operator|&
name|zone
operator|->
name|request
argument_list|)
expr_stmt|;
comment|/* 	 * Skip to next failed / untried master. 	 */
do|do
block|{
name|zone
operator|->
name|curmaster
operator|++
expr_stmt|;
block|}
do|while
condition|(
name|zone
operator|->
name|curmaster
operator|<
name|zone
operator|->
name|masterscnt
operator|&&
name|zone
operator|->
name|mastersok
index|[
name|zone
operator|->
name|curmaster
index|]
condition|)
do|;
name|DNS_ZONE_CLRFLAG
argument_list|(
name|zone
argument_list|,
name|DNS_ZONEFLG_NOEDNS
argument_list|)
expr_stmt|;
if|if
condition|(
name|zone
operator|->
name|curmaster
operator|>=
name|zone
operator|->
name|masterscnt
condition|)
block|{
name|isc_boolean_t
name|done
init|=
name|ISC_TRUE
decl_stmt|;
if|if
condition|(
name|DNS_ZONE_OPTION
argument_list|(
name|zone
argument_list|,
name|DNS_ZONEOPT_USEALTXFRSRC
argument_list|)
operator|&&
operator|!
name|DNS_ZONE_FLAG
argument_list|(
name|zone
argument_list|,
name|DNS_ZONEFLG_USEALTXFRSRC
argument_list|)
condition|)
block|{
comment|/* 			 * Did we get a good answer from all the masters? 			 */
for|for
control|(
name|j
operator|=
literal|0
init|;
name|j
operator|<
name|zone
operator|->
name|masterscnt
condition|;
name|j
operator|++
control|)
if|if
condition|(
name|zone
operator|->
name|mastersok
index|[
name|j
index|]
operator|==
name|ISC_FALSE
condition|)
block|{
name|done
operator|=
name|ISC_FALSE
expr_stmt|;
break|break;
block|}
block|}
else|else
name|done
operator|=
name|ISC_TRUE
expr_stmt|;
if|if
condition|(
operator|!
name|done
condition|)
block|{
name|DNS_ZONE_SETFLAG
argument_list|(
name|zone
argument_list|,
name|DNS_ZONEFLG_USEALTXFRSRC
argument_list|)
expr_stmt|;
name|zone
operator|->
name|curmaster
operator|=
literal|0
expr_stmt|;
comment|/* 			 * Find the next failed master. 			 */
while|while
condition|(
name|zone
operator|->
name|curmaster
operator|<
name|zone
operator|->
name|masterscnt
operator|&&
name|zone
operator|->
name|mastersok
index|[
name|zone
operator|->
name|curmaster
index|]
condition|)
name|zone
operator|->
name|curmaster
operator|++
expr_stmt|;
goto|goto
name|requeue
goto|;
block|}
name|DNS_ZONE_CLRFLAG
argument_list|(
name|zone
argument_list|,
name|DNS_ZONEFLG_REFRESH
argument_list|)
expr_stmt|;
if|if
condition|(
name|DNS_ZONE_FLAG
argument_list|(
name|zone
argument_list|,
name|DNS_ZONEFLG_NEEDREFRESH
argument_list|)
condition|)
block|{
name|DNS_ZONE_CLRFLAG
argument_list|(
name|zone
argument_list|,
name|DNS_ZONEFLG_NEEDREFRESH
argument_list|)
expr_stmt|;
name|zone
operator|->
name|refreshtime
operator|=
name|now
expr_stmt|;
block|}
name|DNS_ZONE_CLRFLAG
argument_list|(
name|zone
argument_list|,
name|DNS_ZONEFLG_USEALTXFRSRC
argument_list|)
expr_stmt|;
name|zone_settimer
argument_list|(
name|zone
argument_list|,
operator|&
name|now
argument_list|)
expr_stmt|;
name|UNLOCK_ZONE
argument_list|(
name|zone
argument_list|)
expr_stmt|;
goto|goto
name|detach
goto|;
block|}
name|requeue
label|:
name|queue_soa_query
argument_list|(
name|zone
argument_list|)
expr_stmt|;
name|UNLOCK_ZONE
argument_list|(
name|zone
argument_list|)
expr_stmt|;
goto|goto
name|detach
goto|;
name|same_master
label|:
if|if
condition|(
name|msg
operator|!=
name|NULL
condition|)
name|dns_message_destroy
argument_list|(
operator|&
name|msg
argument_list|)
expr_stmt|;
name|isc_event_free
argument_list|(
operator|&
name|event
argument_list|)
expr_stmt|;
name|LOCK_ZONE
argument_list|(
name|zone
argument_list|)
expr_stmt|;
name|dns_request_destroy
argument_list|(
operator|&
name|zone
operator|->
name|request
argument_list|)
expr_stmt|;
name|queue_soa_query
argument_list|(
name|zone
argument_list|)
expr_stmt|;
name|UNLOCK_ZONE
argument_list|(
name|zone
argument_list|)
expr_stmt|;
name|detach
label|:
name|dns_zone_idetach
argument_list|(
operator|&
name|zone
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_function
specifier|static
name|void
name|queue_soa_query
parameter_list|(
name|dns_zone_t
modifier|*
name|zone
parameter_list|)
block|{
specifier|const
name|char
name|me
index|[]
init|=
literal|"queue_soa_query"
decl_stmt|;
name|isc_event_t
modifier|*
name|e
decl_stmt|;
name|dns_zone_t
modifier|*
name|dummy
init|=
name|NULL
decl_stmt|;
name|isc_result_t
name|result
decl_stmt|;
name|ENTER
expr_stmt|;
comment|/* 	 * Locked by caller 	 */
name|REQUIRE
argument_list|(
name|LOCKED_ZONE
argument_list|(
name|zone
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|DNS_ZONE_FLAG
argument_list|(
name|zone
argument_list|,
name|DNS_ZONEFLG_EXITING
argument_list|)
condition|)
block|{
name|cancel_refresh
argument_list|(
name|zone
argument_list|)
expr_stmt|;
return|return;
block|}
name|e
operator|=
name|isc_event_allocate
argument_list|(
name|zone
operator|->
name|mctx
argument_list|,
name|NULL
argument_list|,
name|DNS_EVENT_ZONE
argument_list|,
name|soa_query
argument_list|,
name|zone
argument_list|,
sizeof|sizeof
argument_list|(
name|isc_event_t
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|e
operator|==
name|NULL
condition|)
block|{
name|cancel_refresh
argument_list|(
name|zone
argument_list|)
expr_stmt|;
return|return;
block|}
comment|/* 	 * Attach so that we won't clean up 	 * until the event is delivered. 	 */
name|zone_iattach
argument_list|(
name|zone
argument_list|,
operator|&
name|dummy
argument_list|)
expr_stmt|;
name|e
operator|->
name|ev_arg
operator|=
name|zone
expr_stmt|;
name|e
operator|->
name|ev_sender
operator|=
name|NULL
expr_stmt|;
name|result
operator|=
name|isc_ratelimiter_enqueue
argument_list|(
name|zone
operator|->
name|zmgr
operator|->
name|rl
argument_list|,
name|zone
operator|->
name|task
argument_list|,
operator|&
name|e
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
block|{
name|zone_idetach
argument_list|(
operator|&
name|dummy
argument_list|)
expr_stmt|;
name|isc_event_free
argument_list|(
operator|&
name|e
argument_list|)
expr_stmt|;
name|cancel_refresh
argument_list|(
name|zone
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
specifier|inline
name|isc_result_t
name|create_query
parameter_list|(
name|dns_zone_t
modifier|*
name|zone
parameter_list|,
name|dns_rdatatype_t
name|rdtype
parameter_list|,
name|dns_message_t
modifier|*
modifier|*
name|messagep
parameter_list|)
block|{
name|dns_message_t
modifier|*
name|message
init|=
name|NULL
decl_stmt|;
name|dns_name_t
modifier|*
name|qname
init|=
name|NULL
decl_stmt|;
name|dns_rdataset_t
modifier|*
name|qrdataset
init|=
name|NULL
decl_stmt|;
name|isc_result_t
name|result
decl_stmt|;
name|result
operator|=
name|dns_message_create
argument_list|(
name|zone
operator|->
name|mctx
argument_list|,
name|DNS_MESSAGE_INTENTRENDER
argument_list|,
operator|&
name|message
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
goto|goto
name|cleanup
goto|;
name|message
operator|->
name|opcode
operator|=
name|dns_opcode_query
expr_stmt|;
name|message
operator|->
name|rdclass
operator|=
name|zone
operator|->
name|rdclass
expr_stmt|;
name|result
operator|=
name|dns_message_gettempname
argument_list|(
name|message
argument_list|,
operator|&
name|qname
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
goto|goto
name|cleanup
goto|;
name|result
operator|=
name|dns_message_gettemprdataset
argument_list|(
name|message
argument_list|,
operator|&
name|qrdataset
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
goto|goto
name|cleanup
goto|;
comment|/* 	 * Make question. 	 */
name|dns_name_init
argument_list|(
name|qname
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|dns_name_clone
argument_list|(
operator|&
name|zone
operator|->
name|origin
argument_list|,
name|qname
argument_list|)
expr_stmt|;
name|dns_rdataset_init
argument_list|(
name|qrdataset
argument_list|)
expr_stmt|;
name|dns_rdataset_makequestion
argument_list|(
name|qrdataset
argument_list|,
name|zone
operator|->
name|rdclass
argument_list|,
name|rdtype
argument_list|)
expr_stmt|;
name|ISC_LIST_APPEND
argument_list|(
name|qname
operator|->
name|list
argument_list|,
name|qrdataset
argument_list|,
name|link
argument_list|)
expr_stmt|;
name|dns_message_addname
argument_list|(
name|message
argument_list|,
name|qname
argument_list|,
name|DNS_SECTION_QUESTION
argument_list|)
expr_stmt|;
operator|*
name|messagep
operator|=
name|message
expr_stmt|;
return|return
operator|(
name|ISC_R_SUCCESS
operator|)
return|;
name|cleanup
label|:
if|if
condition|(
name|qname
operator|!=
name|NULL
condition|)
name|dns_message_puttempname
argument_list|(
name|message
argument_list|,
operator|&
name|qname
argument_list|)
expr_stmt|;
if|if
condition|(
name|qrdataset
operator|!=
name|NULL
condition|)
name|dns_message_puttemprdataset
argument_list|(
name|message
argument_list|,
operator|&
name|qrdataset
argument_list|)
expr_stmt|;
if|if
condition|(
name|message
operator|!=
name|NULL
condition|)
name|dns_message_destroy
argument_list|(
operator|&
name|message
argument_list|)
expr_stmt|;
return|return
operator|(
name|result
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|isc_result_t
name|add_opt
parameter_list|(
name|dns_message_t
modifier|*
name|message
parameter_list|)
block|{
name|dns_rdataset_t
modifier|*
name|rdataset
init|=
name|NULL
decl_stmt|;
name|dns_rdatalist_t
modifier|*
name|rdatalist
init|=
name|NULL
decl_stmt|;
name|dns_rdata_t
modifier|*
name|rdata
init|=
name|NULL
decl_stmt|;
name|isc_result_t
name|result
decl_stmt|;
name|result
operator|=
name|dns_message_gettemprdatalist
argument_list|(
name|message
argument_list|,
operator|&
name|rdatalist
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
goto|goto
name|cleanup
goto|;
name|result
operator|=
name|dns_message_gettemprdata
argument_list|(
name|message
argument_list|,
operator|&
name|rdata
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
goto|goto
name|cleanup
goto|;
name|result
operator|=
name|dns_message_gettemprdataset
argument_list|(
name|message
argument_list|,
operator|&
name|rdataset
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
goto|goto
name|cleanup
goto|;
name|dns_rdataset_init
argument_list|(
name|rdataset
argument_list|)
expr_stmt|;
name|rdatalist
operator|->
name|type
operator|=
name|dns_rdatatype_opt
expr_stmt|;
name|rdatalist
operator|->
name|covers
operator|=
literal|0
expr_stmt|;
comment|/* 	 * Set Maximum UDP buffer size. 	 */
name|rdatalist
operator|->
name|rdclass
operator|=
name|SEND_BUFFER_SIZE
expr_stmt|;
comment|/* 	 * Set EXTENDED-RCODE, VERSION, DO and Z to 0. 	 */
name|rdatalist
operator|->
name|ttl
operator|=
literal|0
expr_stmt|;
comment|/* 	 * No EDNS options. 	 */
name|rdata
operator|->
name|data
operator|=
name|NULL
expr_stmt|;
name|rdata
operator|->
name|length
operator|=
literal|0
expr_stmt|;
name|rdata
operator|->
name|rdclass
operator|=
name|rdatalist
operator|->
name|rdclass
expr_stmt|;
name|rdata
operator|->
name|type
operator|=
name|rdatalist
operator|->
name|type
expr_stmt|;
name|rdata
operator|->
name|flags
operator|=
literal|0
expr_stmt|;
name|ISC_LIST_INIT
argument_list|(
name|rdatalist
operator|->
name|rdata
argument_list|)
expr_stmt|;
name|ISC_LIST_APPEND
argument_list|(
name|rdatalist
operator|->
name|rdata
argument_list|,
name|rdata
argument_list|,
name|link
argument_list|)
expr_stmt|;
name|RUNTIME_CHECK
argument_list|(
name|dns_rdatalist_tordataset
argument_list|(
name|rdatalist
argument_list|,
name|rdataset
argument_list|)
operator|==
name|ISC_R_SUCCESS
argument_list|)
expr_stmt|;
return|return
operator|(
name|dns_message_setopt
argument_list|(
name|message
argument_list|,
name|rdataset
argument_list|)
operator|)
return|;
name|cleanup
label|:
if|if
condition|(
name|rdatalist
operator|!=
name|NULL
condition|)
name|dns_message_puttemprdatalist
argument_list|(
name|message
argument_list|,
operator|&
name|rdatalist
argument_list|)
expr_stmt|;
if|if
condition|(
name|rdataset
operator|!=
name|NULL
condition|)
name|dns_message_puttemprdataset
argument_list|(
name|message
argument_list|,
operator|&
name|rdataset
argument_list|)
expr_stmt|;
if|if
condition|(
name|rdata
operator|!=
name|NULL
condition|)
name|dns_message_puttemprdata
argument_list|(
name|message
argument_list|,
operator|&
name|rdata
argument_list|)
expr_stmt|;
return|return
operator|(
name|result
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|soa_query
parameter_list|(
name|isc_task_t
modifier|*
name|task
parameter_list|,
name|isc_event_t
modifier|*
name|event
parameter_list|)
block|{
specifier|const
name|char
name|me
index|[]
init|=
literal|"soa_query"
decl_stmt|;
name|isc_result_t
name|result
init|=
name|ISC_R_FAILURE
decl_stmt|;
name|dns_message_t
modifier|*
name|message
init|=
name|NULL
decl_stmt|;
name|dns_zone_t
modifier|*
name|zone
init|=
name|event
operator|->
name|ev_arg
decl_stmt|;
name|dns_zone_t
modifier|*
name|dummy
init|=
name|NULL
decl_stmt|;
name|isc_netaddr_t
name|masterip
decl_stmt|;
name|dns_tsigkey_t
modifier|*
name|key
init|=
name|NULL
decl_stmt|;
name|isc_uint32_t
name|options
decl_stmt|;
name|isc_boolean_t
name|cancel
init|=
name|ISC_TRUE
decl_stmt|;
name|int
name|timeout
decl_stmt|;
name|isc_boolean_t
name|have_xfrsource
decl_stmt|;
name|REQUIRE
argument_list|(
name|DNS_ZONE_VALID
argument_list|(
name|zone
argument_list|)
argument_list|)
expr_stmt|;
name|UNUSED
argument_list|(
name|task
argument_list|)
expr_stmt|;
name|ENTER
expr_stmt|;
name|LOCK_ZONE
argument_list|(
name|zone
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
operator|(
name|event
operator|->
name|ev_attributes
operator|&
name|ISC_EVENTATTR_CANCELED
operator|)
operator|!=
literal|0
operator|)
operator|||
name|DNS_ZONE_FLAG
argument_list|(
name|zone
argument_list|,
name|DNS_ZONEFLG_EXITING
argument_list|)
operator|||
name|zone
operator|->
name|view
operator|->
name|requestmgr
operator|==
name|NULL
condition|)
block|{
if|if
condition|(
name|DNS_ZONE_FLAG
argument_list|(
name|zone
argument_list|,
name|DNS_ZONEFLG_EXITING
argument_list|)
condition|)
name|cancel
operator|=
name|ISC_FALSE
expr_stmt|;
goto|goto
name|cleanup
goto|;
block|}
comment|/* 	 * XXX Optimisation: Create message when zone is setup and reuse. 	 */
name|result
operator|=
name|create_query
argument_list|(
name|zone
argument_list|,
name|dns_rdatatype_soa
argument_list|,
operator|&
name|message
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
goto|goto
name|cleanup
goto|;
name|again
label|:
name|INSIST
argument_list|(
name|zone
operator|->
name|masterscnt
operator|>
literal|0
argument_list|)
expr_stmt|;
name|INSIST
argument_list|(
name|zone
operator|->
name|curmaster
operator|<
name|zone
operator|->
name|masterscnt
argument_list|)
expr_stmt|;
name|zone
operator|->
name|masteraddr
operator|=
name|zone
operator|->
name|masters
index|[
name|zone
operator|->
name|curmaster
index|]
expr_stmt|;
name|isc_netaddr_fromsockaddr
argument_list|(
operator|&
name|masterip
argument_list|,
operator|&
name|zone
operator|->
name|masteraddr
argument_list|)
expr_stmt|;
comment|/* 	 * First, look for a tsig key in the master statement, then 	 * try for a server key. 	 */
if|if
condition|(
operator|(
name|zone
operator|->
name|masterkeynames
operator|!=
name|NULL
operator|)
operator|&&
operator|(
name|zone
operator|->
name|masterkeynames
index|[
name|zone
operator|->
name|curmaster
index|]
operator|!=
name|NULL
operator|)
condition|)
block|{
name|dns_view_t
modifier|*
name|view
init|=
name|dns_zone_getview
argument_list|(
name|zone
argument_list|)
decl_stmt|;
name|dns_name_t
modifier|*
name|keyname
init|=
name|zone
operator|->
name|masterkeynames
index|[
name|zone
operator|->
name|curmaster
index|]
decl_stmt|;
name|result
operator|=
name|dns_view_gettsig
argument_list|(
name|view
argument_list|,
name|keyname
argument_list|,
operator|&
name|key
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
block|{
name|char
name|namebuf
index|[
name|DNS_NAME_FORMATSIZE
index|]
decl_stmt|;
name|dns_name_format
argument_list|(
name|keyname
argument_list|,
name|namebuf
argument_list|,
sizeof|sizeof
argument_list|(
name|namebuf
argument_list|)
argument_list|)
expr_stmt|;
name|dns_zone_log
argument_list|(
name|zone
argument_list|,
name|ISC_LOG_ERROR
argument_list|,
literal|"unable to find key: %s"
argument_list|,
name|namebuf
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
name|key
operator|==
name|NULL
condition|)
operator|(
name|void
operator|)
name|dns_view_getpeertsig
argument_list|(
name|zone
operator|->
name|view
argument_list|,
operator|&
name|masterip
argument_list|,
operator|&
name|key
argument_list|)
expr_stmt|;
name|have_xfrsource
operator|=
name|ISC_FALSE
expr_stmt|;
if|if
condition|(
name|zone
operator|->
name|view
operator|->
name|peers
operator|!=
name|NULL
condition|)
block|{
name|dns_peer_t
modifier|*
name|peer
init|=
name|NULL
decl_stmt|;
name|isc_boolean_t
name|edns
decl_stmt|;
name|result
operator|=
name|dns_peerlist_peerbyaddr
argument_list|(
name|zone
operator|->
name|view
operator|->
name|peers
argument_list|,
operator|&
name|masterip
argument_list|,
operator|&
name|peer
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|==
name|ISC_R_SUCCESS
condition|)
block|{
name|result
operator|=
name|dns_peer_getsupportedns
argument_list|(
name|peer
argument_list|,
operator|&
name|edns
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|==
name|ISC_R_SUCCESS
operator|&&
operator|!
name|edns
condition|)
name|DNS_ZONE_SETFLAG
argument_list|(
name|zone
argument_list|,
name|DNS_ZONEFLG_NOEDNS
argument_list|)
expr_stmt|;
name|result
operator|=
name|dns_peer_gettransfersource
argument_list|(
name|peer
argument_list|,
operator|&
name|zone
operator|->
name|sourceaddr
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|==
name|ISC_R_SUCCESS
condition|)
name|have_xfrsource
operator|=
name|ISC_TRUE
expr_stmt|;
block|}
block|}
switch|switch
condition|(
name|isc_sockaddr_pf
argument_list|(
operator|&
name|zone
operator|->
name|masteraddr
argument_list|)
condition|)
block|{
case|case
name|PF_INET
case|:
if|if
condition|(
name|DNS_ZONE_FLAG
argument_list|(
name|zone
argument_list|,
name|DNS_ZONEFLG_USEALTXFRSRC
argument_list|)
condition|)
block|{
if|if
condition|(
name|isc_sockaddr_equal
argument_list|(
operator|&
name|zone
operator|->
name|altxfrsource4
argument_list|,
operator|&
name|zone
operator|->
name|xfrsource4
argument_list|)
condition|)
goto|goto
name|skip_master
goto|;
name|zone
operator|->
name|sourceaddr
operator|=
name|zone
operator|->
name|altxfrsource4
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|!
name|have_xfrsource
condition|)
name|zone
operator|->
name|sourceaddr
operator|=
name|zone
operator|->
name|xfrsource4
expr_stmt|;
break|break;
case|case
name|PF_INET6
case|:
if|if
condition|(
name|DNS_ZONE_FLAG
argument_list|(
name|zone
argument_list|,
name|DNS_ZONEFLG_USEALTXFRSRC
argument_list|)
condition|)
block|{
if|if
condition|(
name|isc_sockaddr_equal
argument_list|(
operator|&
name|zone
operator|->
name|altxfrsource6
argument_list|,
operator|&
name|zone
operator|->
name|xfrsource6
argument_list|)
condition|)
goto|goto
name|skip_master
goto|;
name|zone
operator|->
name|sourceaddr
operator|=
name|zone
operator|->
name|altxfrsource6
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|!
name|have_xfrsource
condition|)
name|zone
operator|->
name|sourceaddr
operator|=
name|zone
operator|->
name|xfrsource6
expr_stmt|;
break|break;
default|default:
name|result
operator|=
name|ISC_R_NOTIMPLEMENTED
expr_stmt|;
goto|goto
name|cleanup
goto|;
block|}
name|options
operator|=
name|DNS_ZONE_FLAG
argument_list|(
name|zone
argument_list|,
name|DNS_ZONEFLG_USEVC
argument_list|)
condition|?
name|DNS_REQUESTOPT_TCP
else|:
literal|0
expr_stmt|;
if|if
condition|(
operator|!
name|DNS_ZONE_FLAG
argument_list|(
name|zone
argument_list|,
name|DNS_ZONEFLG_NOEDNS
argument_list|)
condition|)
block|{
name|result
operator|=
name|add_opt
argument_list|(
name|message
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
name|zone_debuglog
argument_list|(
name|zone
argument_list|,
name|me
argument_list|,
literal|1
argument_list|,
literal|"unable to add opt record: %s"
argument_list|,
name|dns_result_totext
argument_list|(
name|result
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|zone_iattach
argument_list|(
name|zone
argument_list|,
operator|&
name|dummy
argument_list|)
expr_stmt|;
name|timeout
operator|=
literal|15
expr_stmt|;
if|if
condition|(
name|DNS_ZONE_FLAG
argument_list|(
name|zone
argument_list|,
name|DNS_ZONEFLG_DIALREFRESH
argument_list|)
condition|)
name|timeout
operator|=
literal|30
expr_stmt|;
name|result
operator|=
name|dns_request_createvia2
argument_list|(
name|zone
operator|->
name|view
operator|->
name|requestmgr
argument_list|,
name|message
argument_list|,
operator|&
name|zone
operator|->
name|sourceaddr
argument_list|,
operator|&
name|zone
operator|->
name|masteraddr
argument_list|,
name|options
argument_list|,
name|key
argument_list|,
name|timeout
operator|*
literal|3
argument_list|,
name|timeout
argument_list|,
name|zone
operator|->
name|task
argument_list|,
name|refresh_callback
argument_list|,
name|zone
argument_list|,
operator|&
name|zone
operator|->
name|request
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
block|{
name|zone_idetach
argument_list|(
operator|&
name|dummy
argument_list|)
expr_stmt|;
name|zone_debuglog
argument_list|(
name|zone
argument_list|,
name|me
argument_list|,
literal|1
argument_list|,
literal|"dns_request_createvia2() failed: %s"
argument_list|,
name|dns_result_totext
argument_list|(
name|result
argument_list|)
argument_list|)
expr_stmt|;
goto|goto
name|cleanup
goto|;
block|}
name|cancel
operator|=
name|ISC_FALSE
expr_stmt|;
name|cleanup
label|:
if|if
condition|(
name|key
operator|!=
name|NULL
condition|)
name|dns_tsigkey_detach
argument_list|(
operator|&
name|key
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
name|DNS_ZONE_CLRFLAG
argument_list|(
name|zone
argument_list|,
name|DNS_ZONEFLG_REFRESH
argument_list|)
expr_stmt|;
if|if
condition|(
name|message
operator|!=
name|NULL
condition|)
name|dns_message_destroy
argument_list|(
operator|&
name|message
argument_list|)
expr_stmt|;
if|if
condition|(
name|cancel
condition|)
name|cancel_refresh
argument_list|(
name|zone
argument_list|)
expr_stmt|;
name|isc_event_free
argument_list|(
operator|&
name|event
argument_list|)
expr_stmt|;
name|UNLOCK_ZONE
argument_list|(
name|zone
argument_list|)
expr_stmt|;
name|dns_zone_idetach
argument_list|(
operator|&
name|zone
argument_list|)
expr_stmt|;
return|return;
name|skip_master
label|:
if|if
condition|(
name|key
operator|!=
name|NULL
condition|)
name|dns_tsigkey_detach
argument_list|(
operator|&
name|key
argument_list|)
expr_stmt|;
comment|/* 	 * Skip to next failed / untried master. 	 */
do|do
block|{
name|zone
operator|->
name|curmaster
operator|++
expr_stmt|;
block|}
do|while
condition|(
name|zone
operator|->
name|curmaster
operator|<
name|zone
operator|->
name|masterscnt
operator|&&
name|zone
operator|->
name|mastersok
index|[
name|zone
operator|->
name|curmaster
index|]
condition|)
do|;
if|if
condition|(
name|zone
operator|->
name|curmaster
operator|<
name|zone
operator|->
name|masterscnt
condition|)
goto|goto
name|again
goto|;
name|zone
operator|->
name|curmaster
operator|=
literal|0
expr_stmt|;
goto|goto
name|cleanup
goto|;
block|}
end_function

begin_function
specifier|static
name|void
name|ns_query
parameter_list|(
name|dns_zone_t
modifier|*
name|zone
parameter_list|,
name|dns_rdataset_t
modifier|*
name|soardataset
parameter_list|,
name|dns_stub_t
modifier|*
name|stub
parameter_list|)
block|{
specifier|const
name|char
name|me
index|[]
init|=
literal|"ns_query"
decl_stmt|;
name|isc_result_t
name|result
decl_stmt|;
name|dns_message_t
modifier|*
name|message
init|=
name|NULL
decl_stmt|;
name|isc_netaddr_t
name|masterip
decl_stmt|;
name|dns_tsigkey_t
modifier|*
name|key
init|=
name|NULL
decl_stmt|;
name|dns_dbnode_t
modifier|*
name|node
init|=
name|NULL
decl_stmt|;
name|int
name|timeout
decl_stmt|;
name|isc_boolean_t
name|have_xfrsource
init|=
name|ISC_FALSE
decl_stmt|;
name|REQUIRE
argument_list|(
name|DNS_ZONE_VALID
argument_list|(
name|zone
argument_list|)
argument_list|)
expr_stmt|;
name|REQUIRE
argument_list|(
operator|(
name|soardataset
operator|!=
name|NULL
operator|&&
name|stub
operator|==
name|NULL
operator|)
operator|||
operator|(
name|soardataset
operator|==
name|NULL
operator|&&
name|stub
operator|!=
name|NULL
operator|)
argument_list|)
expr_stmt|;
name|REQUIRE
argument_list|(
name|stub
operator|==
name|NULL
operator|||
name|DNS_STUB_VALID
argument_list|(
name|stub
argument_list|)
argument_list|)
expr_stmt|;
name|ENTER
expr_stmt|;
name|LOCK_ZONE
argument_list|(
name|zone
argument_list|)
expr_stmt|;
if|if
condition|(
name|stub
operator|==
name|NULL
condition|)
block|{
name|stub
operator|=
name|isc_mem_get
argument_list|(
name|zone
operator|->
name|mctx
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|stub
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|stub
operator|==
name|NULL
condition|)
goto|goto
name|cleanup
goto|;
name|stub
operator|->
name|magic
operator|=
name|STUB_MAGIC
expr_stmt|;
name|stub
operator|->
name|mctx
operator|=
name|zone
operator|->
name|mctx
expr_stmt|;
name|stub
operator|->
name|zone
operator|=
name|NULL
expr_stmt|;
name|stub
operator|->
name|db
operator|=
name|NULL
expr_stmt|;
name|stub
operator|->
name|version
operator|=
name|NULL
expr_stmt|;
comment|/* 		 * Attach so that the zone won't disappear from under us. 		 */
name|zone_iattach
argument_list|(
name|zone
argument_list|,
operator|&
name|stub
operator|->
name|zone
argument_list|)
expr_stmt|;
comment|/* 		 * If a db exists we will update it, otherwise we create a 		 * new one and attach it to the zone once we have the NS 		 * RRset and glue. 		 */
if|if
condition|(
name|zone
operator|->
name|db
operator|!=
name|NULL
condition|)
name|dns_db_attach
argument_list|(
name|zone
operator|->
name|db
argument_list|,
operator|&
name|stub
operator|->
name|db
argument_list|)
expr_stmt|;
else|else
block|{
name|INSIST
argument_list|(
name|zone
operator|->
name|db_argc
operator|>=
literal|1
argument_list|)
expr_stmt|;
name|result
operator|=
name|dns_db_create
argument_list|(
name|zone
operator|->
name|mctx
argument_list|,
name|zone
operator|->
name|db_argv
index|[
literal|0
index|]
argument_list|,
operator|&
name|zone
operator|->
name|origin
argument_list|,
name|dns_dbtype_stub
argument_list|,
name|zone
operator|->
name|rdclass
argument_list|,
name|zone
operator|->
name|db_argc
operator|-
literal|1
argument_list|,
name|zone
operator|->
name|db_argv
operator|+
literal|1
argument_list|,
operator|&
name|stub
operator|->
name|db
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
block|{
name|dns_zone_log
argument_list|(
name|zone
argument_list|,
name|ISC_LOG_ERROR
argument_list|,
literal|"refreshing stub: "
literal|"could not create "
literal|"database: %s"
argument_list|,
name|dns_result_totext
argument_list|(
name|result
argument_list|)
argument_list|)
expr_stmt|;
goto|goto
name|cleanup
goto|;
block|}
name|dns_db_settask
argument_list|(
name|stub
operator|->
name|db
argument_list|,
name|zone
operator|->
name|task
argument_list|)
expr_stmt|;
block|}
name|dns_db_newversion
argument_list|(
name|stub
operator|->
name|db
argument_list|,
operator|&
name|stub
operator|->
name|version
argument_list|)
expr_stmt|;
comment|/* 		 * Update SOA record. 		 */
name|result
operator|=
name|dns_db_findnode
argument_list|(
name|stub
operator|->
name|db
argument_list|,
operator|&
name|zone
operator|->
name|origin
argument_list|,
name|ISC_TRUE
argument_list|,
operator|&
name|node
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
block|{
name|dns_zone_log
argument_list|(
name|zone
argument_list|,
name|ISC_LOG_INFO
argument_list|,
literal|"refreshing stub: "
literal|"dns_db_findnode() failed: %s"
argument_list|,
name|dns_result_totext
argument_list|(
name|result
argument_list|)
argument_list|)
expr_stmt|;
goto|goto
name|cleanup
goto|;
block|}
name|result
operator|=
name|dns_db_addrdataset
argument_list|(
name|stub
operator|->
name|db
argument_list|,
name|node
argument_list|,
name|stub
operator|->
name|version
argument_list|,
literal|0
argument_list|,
name|soardataset
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|dns_db_detachnode
argument_list|(
name|stub
operator|->
name|db
argument_list|,
operator|&
name|node
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
block|{
name|dns_zone_log
argument_list|(
name|zone
argument_list|,
name|ISC_LOG_INFO
argument_list|,
literal|"refreshing stub: "
literal|"dns_db_addrdataset() failed: %s"
argument_list|,
name|dns_result_totext
argument_list|(
name|result
argument_list|)
argument_list|)
expr_stmt|;
goto|goto
name|cleanup
goto|;
block|}
block|}
comment|/* 	 * XXX Optimisation: Create message when zone is setup and reuse. 	 */
name|result
operator|=
name|create_query
argument_list|(
name|zone
argument_list|,
name|dns_rdatatype_ns
argument_list|,
operator|&
name|message
argument_list|)
expr_stmt|;
name|INSIST
argument_list|(
name|zone
operator|->
name|masterscnt
operator|>
literal|0
argument_list|)
expr_stmt|;
name|INSIST
argument_list|(
name|zone
operator|->
name|curmaster
operator|<
name|zone
operator|->
name|masterscnt
argument_list|)
expr_stmt|;
name|zone
operator|->
name|masteraddr
operator|=
name|zone
operator|->
name|masters
index|[
name|zone
operator|->
name|curmaster
index|]
expr_stmt|;
name|isc_netaddr_fromsockaddr
argument_list|(
operator|&
name|masterip
argument_list|,
operator|&
name|zone
operator|->
name|masteraddr
argument_list|)
expr_stmt|;
comment|/* 	 * First, look for a tsig key in the master statement, then 	 * try for a server key. 	 */
if|if
condition|(
operator|(
name|zone
operator|->
name|masterkeynames
operator|!=
name|NULL
operator|)
operator|&&
operator|(
name|zone
operator|->
name|masterkeynames
index|[
name|zone
operator|->
name|curmaster
index|]
operator|!=
name|NULL
operator|)
condition|)
block|{
name|dns_view_t
modifier|*
name|view
init|=
name|dns_zone_getview
argument_list|(
name|zone
argument_list|)
decl_stmt|;
name|dns_name_t
modifier|*
name|keyname
init|=
name|zone
operator|->
name|masterkeynames
index|[
name|zone
operator|->
name|curmaster
index|]
decl_stmt|;
name|result
operator|=
name|dns_view_gettsig
argument_list|(
name|view
argument_list|,
name|keyname
argument_list|,
operator|&
name|key
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
block|{
name|char
name|namebuf
index|[
name|DNS_NAME_FORMATSIZE
index|]
decl_stmt|;
name|dns_name_format
argument_list|(
name|keyname
argument_list|,
name|namebuf
argument_list|,
sizeof|sizeof
argument_list|(
name|namebuf
argument_list|)
argument_list|)
expr_stmt|;
name|dns_zone_log
argument_list|(
name|zone
argument_list|,
name|ISC_LOG_ERROR
argument_list|,
literal|"unable to find key: %s"
argument_list|,
name|namebuf
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
name|key
operator|==
name|NULL
condition|)
operator|(
name|void
operator|)
name|dns_view_getpeertsig
argument_list|(
name|zone
operator|->
name|view
argument_list|,
operator|&
name|masterip
argument_list|,
operator|&
name|key
argument_list|)
expr_stmt|;
if|if
condition|(
name|zone
operator|->
name|view
operator|->
name|peers
operator|!=
name|NULL
condition|)
block|{
name|dns_peer_t
modifier|*
name|peer
init|=
name|NULL
decl_stmt|;
name|isc_boolean_t
name|edns
decl_stmt|;
name|result
operator|=
name|dns_peerlist_peerbyaddr
argument_list|(
name|zone
operator|->
name|view
operator|->
name|peers
argument_list|,
operator|&
name|masterip
argument_list|,
operator|&
name|peer
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|==
name|ISC_R_SUCCESS
condition|)
block|{
name|result
operator|=
name|dns_peer_getsupportedns
argument_list|(
name|peer
argument_list|,
operator|&
name|edns
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|==
name|ISC_R_SUCCESS
operator|&&
operator|!
name|edns
condition|)
name|DNS_ZONE_SETFLAG
argument_list|(
name|zone
argument_list|,
name|DNS_ZONEFLG_NOEDNS
argument_list|)
expr_stmt|;
name|result
operator|=
name|dns_peer_gettransfersource
argument_list|(
name|peer
argument_list|,
operator|&
name|zone
operator|->
name|sourceaddr
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|==
name|ISC_R_SUCCESS
condition|)
name|have_xfrsource
operator|=
name|ISC_TRUE
expr_stmt|;
block|}
block|}
if|if
condition|(
operator|!
name|DNS_ZONE_FLAG
argument_list|(
name|zone
argument_list|,
name|DNS_ZONEFLG_NOEDNS
argument_list|)
condition|)
block|{
name|result
operator|=
name|add_opt
argument_list|(
name|message
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
name|zone_debuglog
argument_list|(
name|zone
argument_list|,
name|me
argument_list|,
literal|1
argument_list|,
literal|"unable to add opt record: %s"
argument_list|,
name|dns_result_totext
argument_list|(
name|result
argument_list|)
argument_list|)
expr_stmt|;
block|}
comment|/* 	 * Always use TCP so that we shouldn't truncate in additional section. 	 */
switch|switch
condition|(
name|isc_sockaddr_pf
argument_list|(
operator|&
name|zone
operator|->
name|masteraddr
argument_list|)
condition|)
block|{
case|case
name|PF_INET
case|:
if|if
condition|(
name|DNS_ZONE_FLAG
argument_list|(
name|zone
argument_list|,
name|DNS_ZONEFLG_USEALTXFRSRC
argument_list|)
condition|)
name|zone
operator|->
name|sourceaddr
operator|=
name|zone
operator|->
name|altxfrsource4
expr_stmt|;
elseif|else
if|if
condition|(
operator|!
name|have_xfrsource
condition|)
name|zone
operator|->
name|sourceaddr
operator|=
name|zone
operator|->
name|xfrsource4
expr_stmt|;
break|break;
case|case
name|PF_INET6
case|:
if|if
condition|(
name|DNS_ZONE_FLAG
argument_list|(
name|zone
argument_list|,
name|DNS_ZONEFLG_USEALTXFRSRC
argument_list|)
condition|)
name|zone
operator|->
name|sourceaddr
operator|=
name|zone
operator|->
name|altxfrsource6
expr_stmt|;
elseif|else
if|if
condition|(
operator|!
name|have_xfrsource
condition|)
name|zone
operator|->
name|sourceaddr
operator|=
name|zone
operator|->
name|xfrsource6
expr_stmt|;
break|break;
default|default:
name|result
operator|=
name|ISC_R_NOTIMPLEMENTED
expr_stmt|;
goto|goto
name|cleanup
goto|;
block|}
name|timeout
operator|=
literal|15
expr_stmt|;
if|if
condition|(
name|DNS_ZONE_FLAG
argument_list|(
name|zone
argument_list|,
name|DNS_ZONEFLG_DIALREFRESH
argument_list|)
condition|)
name|timeout
operator|=
literal|30
expr_stmt|;
name|result
operator|=
name|dns_request_createvia2
argument_list|(
name|zone
operator|->
name|view
operator|->
name|requestmgr
argument_list|,
name|message
argument_list|,
operator|&
name|zone
operator|->
name|sourceaddr
argument_list|,
operator|&
name|zone
operator|->
name|masteraddr
argument_list|,
name|DNS_REQUESTOPT_TCP
argument_list|,
name|key
argument_list|,
name|timeout
operator|*
literal|3
argument_list|,
name|timeout
argument_list|,
name|zone
operator|->
name|task
argument_list|,
name|stub_callback
argument_list|,
name|stub
argument_list|,
operator|&
name|zone
operator|->
name|request
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
block|{
name|zone_debuglog
argument_list|(
name|zone
argument_list|,
name|me
argument_list|,
literal|1
argument_list|,
literal|"dns_request_createvia() failed: %s"
argument_list|,
name|dns_result_totext
argument_list|(
name|result
argument_list|)
argument_list|)
expr_stmt|;
goto|goto
name|cleanup
goto|;
block|}
name|dns_message_destroy
argument_list|(
operator|&
name|message
argument_list|)
expr_stmt|;
goto|goto
name|unlock
goto|;
name|cleanup
label|:
name|cancel_refresh
argument_list|(
name|zone
argument_list|)
expr_stmt|;
if|if
condition|(
name|stub
operator|!=
name|NULL
condition|)
block|{
name|stub
operator|->
name|magic
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|stub
operator|->
name|version
operator|!=
name|NULL
condition|)
name|dns_db_closeversion
argument_list|(
name|stub
operator|->
name|db
argument_list|,
operator|&
name|stub
operator|->
name|version
argument_list|,
name|ISC_FALSE
argument_list|)
expr_stmt|;
if|if
condition|(
name|stub
operator|->
name|db
operator|!=
name|NULL
condition|)
name|dns_db_detach
argument_list|(
operator|&
name|stub
operator|->
name|db
argument_list|)
expr_stmt|;
if|if
condition|(
name|stub
operator|->
name|zone
operator|!=
name|NULL
condition|)
name|zone_idetach
argument_list|(
operator|&
name|stub
operator|->
name|zone
argument_list|)
expr_stmt|;
name|isc_mem_put
argument_list|(
name|stub
operator|->
name|mctx
argument_list|,
name|stub
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|stub
argument_list|)
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|message
operator|!=
name|NULL
condition|)
name|dns_message_destroy
argument_list|(
operator|&
name|message
argument_list|)
expr_stmt|;
name|unlock
label|:
if|if
condition|(
name|key
operator|!=
name|NULL
condition|)
name|dns_tsigkey_detach
argument_list|(
operator|&
name|key
argument_list|)
expr_stmt|;
name|UNLOCK_ZONE
argument_list|(
name|zone
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_comment
comment|/*  * Handle the control event.  Note that although this event causes the zone  * to shut down, it is not a shutdown event in the sense of the task library.  */
end_comment

begin_function
specifier|static
name|void
name|zone_shutdown
parameter_list|(
name|isc_task_t
modifier|*
name|task
parameter_list|,
name|isc_event_t
modifier|*
name|event
parameter_list|)
block|{
name|dns_zone_t
modifier|*
name|zone
init|=
operator|(
name|dns_zone_t
operator|*
operator|)
name|event
operator|->
name|ev_arg
decl_stmt|;
name|isc_boolean_t
name|free_needed
decl_stmt|,
name|linked
init|=
name|ISC_FALSE
decl_stmt|;
name|UNUSED
argument_list|(
name|task
argument_list|)
expr_stmt|;
name|REQUIRE
argument_list|(
name|DNS_ZONE_VALID
argument_list|(
name|zone
argument_list|)
argument_list|)
expr_stmt|;
name|INSIST
argument_list|(
name|event
operator|->
name|ev_type
operator|==
name|DNS_EVENT_ZONECONTROL
argument_list|)
expr_stmt|;
name|INSIST
argument_list|(
name|isc_refcount_current
argument_list|(
operator|&
name|zone
operator|->
name|erefs
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|zone_debuglog
argument_list|(
name|zone
argument_list|,
literal|"zone_shutdown"
argument_list|,
literal|3
argument_list|,
literal|"shutting down"
argument_list|)
expr_stmt|;
comment|/* 	 * Stop things being restarted after we cancel them below. 	 */
name|LOCK_ZONE
argument_list|(
name|zone
argument_list|)
expr_stmt|;
name|DNS_ZONE_SETFLAG
argument_list|(
name|zone
argument_list|,
name|DNS_ZONEFLG_EXITING
argument_list|)
expr_stmt|;
name|UNLOCK_ZONE
argument_list|(
name|zone
argument_list|)
expr_stmt|;
comment|/* 	 * If we were waiting for xfrin quota, step out of 	 * the queue. 	 * If there's no zone manager, we can't be waiting for the 	 * xfrin quota 	 */
if|if
condition|(
name|zone
operator|->
name|zmgr
operator|!=
name|NULL
condition|)
block|{
name|RWLOCK
argument_list|(
operator|&
name|zone
operator|->
name|zmgr
operator|->
name|rwlock
argument_list|,
name|isc_rwlocktype_write
argument_list|)
expr_stmt|;
if|if
condition|(
name|zone
operator|->
name|statelist
operator|==
operator|&
name|zone
operator|->
name|zmgr
operator|->
name|waiting_for_xfrin
condition|)
block|{
name|ISC_LIST_UNLINK
argument_list|(
name|zone
operator|->
name|zmgr
operator|->
name|waiting_for_xfrin
argument_list|,
name|zone
argument_list|,
name|statelink
argument_list|)
expr_stmt|;
name|linked
operator|=
name|ISC_TRUE
expr_stmt|;
name|zone
operator|->
name|statelist
operator|=
name|NULL
expr_stmt|;
block|}
name|RWUNLOCK
argument_list|(
operator|&
name|zone
operator|->
name|zmgr
operator|->
name|rwlock
argument_list|,
name|isc_rwlocktype_write
argument_list|)
expr_stmt|;
block|}
comment|/* 	 * In task context, no locking required.  See zone_xfrdone(). 	 */
if|if
condition|(
name|zone
operator|->
name|xfr
operator|!=
name|NULL
condition|)
name|dns_xfrin_shutdown
argument_list|(
name|zone
operator|->
name|xfr
argument_list|)
expr_stmt|;
name|LOCK_ZONE
argument_list|(
name|zone
argument_list|)
expr_stmt|;
if|if
condition|(
name|linked
condition|)
block|{
name|INSIST
argument_list|(
name|zone
operator|->
name|irefs
operator|>
literal|0
argument_list|)
expr_stmt|;
name|zone
operator|->
name|irefs
operator|--
expr_stmt|;
block|}
if|if
condition|(
name|zone
operator|->
name|request
operator|!=
name|NULL
condition|)
block|{
name|dns_request_cancel
argument_list|(
name|zone
operator|->
name|request
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|zone
operator|->
name|readio
operator|!=
name|NULL
condition|)
name|zonemgr_cancelio
argument_list|(
name|zone
operator|->
name|readio
argument_list|)
expr_stmt|;
if|if
condition|(
name|zone
operator|->
name|lctx
operator|!=
name|NULL
condition|)
name|dns_loadctx_cancel
argument_list|(
name|zone
operator|->
name|lctx
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|DNS_ZONE_FLAG
argument_list|(
name|zone
argument_list|,
name|DNS_ZONEFLG_FLUSH
argument_list|)
operator|||
operator|!
name|DNS_ZONE_FLAG
argument_list|(
name|zone
argument_list|,
name|DNS_ZONEFLG_DUMPING
argument_list|)
condition|)
block|{
if|if
condition|(
name|zone
operator|->
name|writeio
operator|!=
name|NULL
condition|)
name|zonemgr_cancelio
argument_list|(
name|zone
operator|->
name|writeio
argument_list|)
expr_stmt|;
if|if
condition|(
name|zone
operator|->
name|dctx
operator|!=
name|NULL
condition|)
name|dns_dumpctx_cancel
argument_list|(
name|zone
operator|->
name|dctx
argument_list|)
expr_stmt|;
block|}
name|notify_cancel
argument_list|(
name|zone
argument_list|)
expr_stmt|;
if|if
condition|(
name|zone
operator|->
name|timer
operator|!=
name|NULL
condition|)
block|{
name|isc_timer_detach
argument_list|(
operator|&
name|zone
operator|->
name|timer
argument_list|)
expr_stmt|;
name|INSIST
argument_list|(
name|zone
operator|->
name|irefs
operator|>
literal|0
argument_list|)
expr_stmt|;
name|zone
operator|->
name|irefs
operator|--
expr_stmt|;
block|}
if|if
condition|(
name|zone
operator|->
name|view
operator|!=
name|NULL
condition|)
name|dns_view_weakdetach
argument_list|(
operator|&
name|zone
operator|->
name|view
argument_list|)
expr_stmt|;
comment|/* 	 * We have now canceled everything set the flag to allow exit_check() 	 * to succeed.  We must not unlock between setting this flag and 	 * calling exit_check(). 	 */
name|DNS_ZONE_SETFLAG
argument_list|(
name|zone
argument_list|,
name|DNS_ZONEFLG_SHUTDOWN
argument_list|)
expr_stmt|;
name|free_needed
operator|=
name|exit_check
argument_list|(
name|zone
argument_list|)
expr_stmt|;
name|UNLOCK_ZONE
argument_list|(
name|zone
argument_list|)
expr_stmt|;
if|if
condition|(
name|free_needed
condition|)
name|zone_free
argument_list|(
name|zone
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|zone_timer
parameter_list|(
name|isc_task_t
modifier|*
name|task
parameter_list|,
name|isc_event_t
modifier|*
name|event
parameter_list|)
block|{
specifier|const
name|char
name|me
index|[]
init|=
literal|"zone_timer"
decl_stmt|;
name|dns_zone_t
modifier|*
name|zone
init|=
operator|(
name|dns_zone_t
operator|*
operator|)
name|event
operator|->
name|ev_arg
decl_stmt|;
name|UNUSED
argument_list|(
name|task
argument_list|)
expr_stmt|;
name|REQUIRE
argument_list|(
name|DNS_ZONE_VALID
argument_list|(
name|zone
argument_list|)
argument_list|)
expr_stmt|;
name|ENTER
expr_stmt|;
name|zone_maintenance
argument_list|(
name|zone
argument_list|)
expr_stmt|;
name|isc_event_free
argument_list|(
operator|&
name|event
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|zone_settimer
parameter_list|(
name|dns_zone_t
modifier|*
name|zone
parameter_list|,
name|isc_time_t
modifier|*
name|now
parameter_list|)
block|{
specifier|const
name|char
name|me
index|[]
init|=
literal|"zone_settimer"
decl_stmt|;
name|isc_time_t
name|next
decl_stmt|;
name|isc_result_t
name|result
decl_stmt|;
name|REQUIRE
argument_list|(
name|DNS_ZONE_VALID
argument_list|(
name|zone
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|DNS_ZONE_FLAG
argument_list|(
name|zone
argument_list|,
name|DNS_ZONEFLG_EXITING
argument_list|)
condition|)
return|return;
name|isc_time_settoepoch
argument_list|(
operator|&
name|next
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|zone
operator|->
name|type
condition|)
block|{
case|case
name|dns_zone_master
case|:
if|if
condition|(
name|DNS_ZONE_FLAG
argument_list|(
name|zone
argument_list|,
name|DNS_ZONEFLG_NEEDNOTIFY
argument_list|)
condition|)
name|next
operator|=
operator|*
name|now
expr_stmt|;
if|if
condition|(
name|DNS_ZONE_FLAG
argument_list|(
name|zone
argument_list|,
name|DNS_ZONEFLG_NEEDDUMP
argument_list|)
operator|&&
operator|!
name|DNS_ZONE_FLAG
argument_list|(
name|zone
argument_list|,
name|DNS_ZONEFLG_DUMPING
argument_list|)
condition|)
block|{
name|INSIST
argument_list|(
operator|!
name|isc_time_isepoch
argument_list|(
operator|&
name|zone
operator|->
name|dumptime
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|isc_time_isepoch
argument_list|(
operator|&
name|next
argument_list|)
operator|||
name|isc_time_compare
argument_list|(
operator|&
name|zone
operator|->
name|dumptime
argument_list|,
operator|&
name|next
argument_list|)
operator|<
literal|0
condition|)
name|next
operator|=
name|zone
operator|->
name|dumptime
expr_stmt|;
block|}
break|break;
case|case
name|dns_zone_slave
case|:
if|if
condition|(
name|DNS_ZONE_FLAG
argument_list|(
name|zone
argument_list|,
name|DNS_ZONEFLG_NEEDNOTIFY
argument_list|)
condition|)
name|next
operator|=
operator|*
name|now
expr_stmt|;
comment|/*FALLTHROUGH*/
case|case
name|dns_zone_stub
case|:
if|if
condition|(
operator|!
name|DNS_ZONE_FLAG
argument_list|(
name|zone
argument_list|,
name|DNS_ZONEFLG_REFRESH
argument_list|)
operator|&&
operator|!
name|DNS_ZONE_FLAG
argument_list|(
name|zone
argument_list|,
name|DNS_ZONEFLG_NOMASTERS
argument_list|)
operator|&&
operator|!
name|DNS_ZONE_FLAG
argument_list|(
name|zone
argument_list|,
name|DNS_ZONEFLG_NOREFRESH
argument_list|)
operator|&&
operator|!
name|DNS_ZONE_FLAG
argument_list|(
name|zone
argument_list|,
name|DNS_ZONEFLG_LOADING
argument_list|)
condition|)
block|{
name|INSIST
argument_list|(
operator|!
name|isc_time_isepoch
argument_list|(
operator|&
name|zone
operator|->
name|refreshtime
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|isc_time_isepoch
argument_list|(
operator|&
name|next
argument_list|)
operator|||
name|isc_time_compare
argument_list|(
operator|&
name|zone
operator|->
name|refreshtime
argument_list|,
operator|&
name|next
argument_list|)
operator|<
literal|0
condition|)
name|next
operator|=
name|zone
operator|->
name|refreshtime
expr_stmt|;
block|}
if|if
condition|(
name|DNS_ZONE_FLAG
argument_list|(
name|zone
argument_list|,
name|DNS_ZONEFLG_LOADED
argument_list|)
condition|)
block|{
name|INSIST
argument_list|(
operator|!
name|isc_time_isepoch
argument_list|(
operator|&
name|zone
operator|->
name|expiretime
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|isc_time_isepoch
argument_list|(
operator|&
name|next
argument_list|)
operator|||
name|isc_time_compare
argument_list|(
operator|&
name|zone
operator|->
name|expiretime
argument_list|,
operator|&
name|next
argument_list|)
operator|<
literal|0
condition|)
name|next
operator|=
name|zone
operator|->
name|expiretime
expr_stmt|;
block|}
if|if
condition|(
name|DNS_ZONE_FLAG
argument_list|(
name|zone
argument_list|,
name|DNS_ZONEFLG_NEEDDUMP
argument_list|)
operator|&&
operator|!
name|DNS_ZONE_FLAG
argument_list|(
name|zone
argument_list|,
name|DNS_ZONEFLG_DUMPING
argument_list|)
condition|)
block|{
name|INSIST
argument_list|(
operator|!
name|isc_time_isepoch
argument_list|(
operator|&
name|zone
operator|->
name|dumptime
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|isc_time_isepoch
argument_list|(
operator|&
name|next
argument_list|)
operator|||
name|isc_time_compare
argument_list|(
operator|&
name|zone
operator|->
name|dumptime
argument_list|,
operator|&
name|next
argument_list|)
operator|<
literal|0
condition|)
name|next
operator|=
name|zone
operator|->
name|dumptime
expr_stmt|;
block|}
break|break;
default|default:
break|break;
block|}
if|if
condition|(
name|isc_time_isepoch
argument_list|(
operator|&
name|next
argument_list|)
condition|)
block|{
name|zone_debuglog
argument_list|(
name|zone
argument_list|,
name|me
argument_list|,
literal|10
argument_list|,
literal|"settimer inactive"
argument_list|)
expr_stmt|;
name|result
operator|=
name|isc_timer_reset
argument_list|(
name|zone
operator|->
name|timer
argument_list|,
name|isc_timertype_inactive
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|ISC_TRUE
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
name|dns_zone_log
argument_list|(
name|zone
argument_list|,
name|ISC_LOG_ERROR
argument_list|,
literal|"could not deactivate zone timer: %s"
argument_list|,
name|isc_result_totext
argument_list|(
name|result
argument_list|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|isc_time_compare
argument_list|(
operator|&
name|next
argument_list|,
name|now
argument_list|)
operator|<=
literal|0
condition|)
name|next
operator|=
operator|*
name|now
expr_stmt|;
name|result
operator|=
name|isc_timer_reset
argument_list|(
name|zone
operator|->
name|timer
argument_list|,
name|isc_timertype_once
argument_list|,
operator|&
name|next
argument_list|,
name|NULL
argument_list|,
name|ISC_TRUE
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
name|dns_zone_log
argument_list|(
name|zone
argument_list|,
name|ISC_LOG_ERROR
argument_list|,
literal|"could not reset zone timer: %s"
argument_list|,
name|isc_result_totext
argument_list|(
name|result
argument_list|)
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|cancel_refresh
parameter_list|(
name|dns_zone_t
modifier|*
name|zone
parameter_list|)
block|{
specifier|const
name|char
name|me
index|[]
init|=
literal|"cancel_refresh"
decl_stmt|;
name|isc_time_t
name|now
decl_stmt|;
comment|/* 	 * 'zone' locked by caller. 	 */
name|REQUIRE
argument_list|(
name|DNS_ZONE_VALID
argument_list|(
name|zone
argument_list|)
argument_list|)
expr_stmt|;
name|REQUIRE
argument_list|(
name|LOCKED_ZONE
argument_list|(
name|zone
argument_list|)
argument_list|)
expr_stmt|;
name|ENTER
expr_stmt|;
name|DNS_ZONE_CLRFLAG
argument_list|(
name|zone
argument_list|,
name|DNS_ZONEFLG_REFRESH
argument_list|)
expr_stmt|;
name|TIME_NOW
argument_list|(
operator|&
name|now
argument_list|)
expr_stmt|;
name|zone_settimer
argument_list|(
name|zone
argument_list|,
operator|&
name|now
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|isc_result_t
name|notify_createmessage
parameter_list|(
name|dns_zone_t
modifier|*
name|zone
parameter_list|,
name|unsigned
name|int
name|flags
parameter_list|,
name|dns_message_t
modifier|*
modifier|*
name|messagep
parameter_list|)
block|{
name|dns_dbnode_t
modifier|*
name|node
init|=
name|NULL
decl_stmt|;
name|dns_dbversion_t
modifier|*
name|version
init|=
name|NULL
decl_stmt|;
name|dns_message_t
modifier|*
name|message
init|=
name|NULL
decl_stmt|;
name|dns_rdataset_t
name|rdataset
decl_stmt|;
name|dns_rdata_t
name|rdata
init|=
name|DNS_RDATA_INIT
decl_stmt|;
name|dns_name_t
modifier|*
name|tempname
init|=
name|NULL
decl_stmt|;
name|dns_rdata_t
modifier|*
name|temprdata
init|=
name|NULL
decl_stmt|;
name|dns_rdatalist_t
modifier|*
name|temprdatalist
init|=
name|NULL
decl_stmt|;
name|dns_rdataset_t
modifier|*
name|temprdataset
init|=
name|NULL
decl_stmt|;
name|isc_result_t
name|result
decl_stmt|;
name|isc_region_t
name|r
decl_stmt|;
name|isc_buffer_t
modifier|*
name|b
init|=
name|NULL
decl_stmt|;
name|REQUIRE
argument_list|(
name|DNS_ZONE_VALID
argument_list|(
name|zone
argument_list|)
argument_list|)
expr_stmt|;
name|REQUIRE
argument_list|(
name|messagep
operator|!=
name|NULL
operator|&&
operator|*
name|messagep
operator|==
name|NULL
argument_list|)
expr_stmt|;
name|result
operator|=
name|dns_message_create
argument_list|(
name|zone
operator|->
name|mctx
argument_list|,
name|DNS_MESSAGE_INTENTRENDER
argument_list|,
operator|&
name|message
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
return|return
operator|(
name|result
operator|)
return|;
name|message
operator|->
name|opcode
operator|=
name|dns_opcode_notify
expr_stmt|;
name|message
operator|->
name|flags
operator||=
name|DNS_MESSAGEFLAG_AA
expr_stmt|;
name|message
operator|->
name|rdclass
operator|=
name|zone
operator|->
name|rdclass
expr_stmt|;
name|result
operator|=
name|dns_message_gettempname
argument_list|(
name|message
argument_list|,
operator|&
name|tempname
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
goto|goto
name|cleanup
goto|;
name|result
operator|=
name|dns_message_gettemprdataset
argument_list|(
name|message
argument_list|,
operator|&
name|temprdataset
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
goto|goto
name|cleanup
goto|;
comment|/* 	 * Make question. 	 */
name|dns_name_init
argument_list|(
name|tempname
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|dns_name_clone
argument_list|(
operator|&
name|zone
operator|->
name|origin
argument_list|,
name|tempname
argument_list|)
expr_stmt|;
name|dns_rdataset_init
argument_list|(
name|temprdataset
argument_list|)
expr_stmt|;
name|dns_rdataset_makequestion
argument_list|(
name|temprdataset
argument_list|,
name|zone
operator|->
name|rdclass
argument_list|,
name|dns_rdatatype_soa
argument_list|)
expr_stmt|;
name|ISC_LIST_APPEND
argument_list|(
name|tempname
operator|->
name|list
argument_list|,
name|temprdataset
argument_list|,
name|link
argument_list|)
expr_stmt|;
name|dns_message_addname
argument_list|(
name|message
argument_list|,
name|tempname
argument_list|,
name|DNS_SECTION_QUESTION
argument_list|)
expr_stmt|;
name|tempname
operator|=
name|NULL
expr_stmt|;
name|temprdataset
operator|=
name|NULL
expr_stmt|;
if|if
condition|(
operator|(
name|flags
operator|&
name|DNS_NOTIFY_NOSOA
operator|)
operator|!=
literal|0
condition|)
goto|goto
name|done
goto|;
name|result
operator|=
name|dns_message_gettempname
argument_list|(
name|message
argument_list|,
operator|&
name|tempname
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
goto|goto
name|soa_cleanup
goto|;
name|result
operator|=
name|dns_message_gettemprdata
argument_list|(
name|message
argument_list|,
operator|&
name|temprdata
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
goto|goto
name|soa_cleanup
goto|;
name|result
operator|=
name|dns_message_gettemprdataset
argument_list|(
name|message
argument_list|,
operator|&
name|temprdataset
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
goto|goto
name|soa_cleanup
goto|;
name|result
operator|=
name|dns_message_gettemprdatalist
argument_list|(
name|message
argument_list|,
operator|&
name|temprdatalist
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
goto|goto
name|soa_cleanup
goto|;
name|dns_name_init
argument_list|(
name|tempname
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|dns_name_clone
argument_list|(
operator|&
name|zone
operator|->
name|origin
argument_list|,
name|tempname
argument_list|)
expr_stmt|;
name|dns_db_currentversion
argument_list|(
name|zone
operator|->
name|db
argument_list|,
operator|&
name|version
argument_list|)
expr_stmt|;
name|result
operator|=
name|dns_db_findnode
argument_list|(
name|zone
operator|->
name|db
argument_list|,
name|tempname
argument_list|,
name|ISC_FALSE
argument_list|,
operator|&
name|node
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
goto|goto
name|soa_cleanup
goto|;
name|dns_rdataset_init
argument_list|(
operator|&
name|rdataset
argument_list|)
expr_stmt|;
name|result
operator|=
name|dns_db_findrdataset
argument_list|(
name|zone
operator|->
name|db
argument_list|,
name|node
argument_list|,
name|version
argument_list|,
name|dns_rdatatype_soa
argument_list|,
name|dns_rdatatype_none
argument_list|,
literal|0
argument_list|,
operator|&
name|rdataset
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
goto|goto
name|soa_cleanup
goto|;
name|result
operator|=
name|dns_rdataset_first
argument_list|(
operator|&
name|rdataset
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
goto|goto
name|soa_cleanup
goto|;
name|dns_rdataset_current
argument_list|(
operator|&
name|rdataset
argument_list|,
operator|&
name|rdata
argument_list|)
expr_stmt|;
name|dns_rdata_toregion
argument_list|(
operator|&
name|rdata
argument_list|,
operator|&
name|r
argument_list|)
expr_stmt|;
name|result
operator|=
name|isc_buffer_allocate
argument_list|(
name|zone
operator|->
name|mctx
argument_list|,
operator|&
name|b
argument_list|,
name|r
operator|.
name|length
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
goto|goto
name|soa_cleanup
goto|;
name|isc_buffer_putmem
argument_list|(
name|b
argument_list|,
name|r
operator|.
name|base
argument_list|,
name|r
operator|.
name|length
argument_list|)
expr_stmt|;
name|isc_buffer_usedregion
argument_list|(
name|b
argument_list|,
operator|&
name|r
argument_list|)
expr_stmt|;
name|dns_rdata_init
argument_list|(
name|temprdata
argument_list|)
expr_stmt|;
name|dns_rdata_fromregion
argument_list|(
name|temprdata
argument_list|,
name|rdata
operator|.
name|rdclass
argument_list|,
name|rdata
operator|.
name|type
argument_list|,
operator|&
name|r
argument_list|)
expr_stmt|;
name|dns_message_takebuffer
argument_list|(
name|message
argument_list|,
operator|&
name|b
argument_list|)
expr_stmt|;
name|result
operator|=
name|dns_rdataset_next
argument_list|(
operator|&
name|rdataset
argument_list|)
expr_stmt|;
name|dns_rdataset_disassociate
argument_list|(
operator|&
name|rdataset
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_NOMORE
condition|)
goto|goto
name|soa_cleanup
goto|;
name|temprdatalist
operator|->
name|rdclass
operator|=
name|rdata
operator|.
name|rdclass
expr_stmt|;
name|temprdatalist
operator|->
name|type
operator|=
name|rdata
operator|.
name|type
expr_stmt|;
name|temprdatalist
operator|->
name|covers
operator|=
literal|0
expr_stmt|;
name|temprdatalist
operator|->
name|ttl
operator|=
name|rdataset
operator|.
name|ttl
expr_stmt|;
name|ISC_LIST_INIT
argument_list|(
name|temprdatalist
operator|->
name|rdata
argument_list|)
expr_stmt|;
name|ISC_LIST_APPEND
argument_list|(
name|temprdatalist
operator|->
name|rdata
argument_list|,
name|temprdata
argument_list|,
name|link
argument_list|)
expr_stmt|;
name|dns_rdataset_init
argument_list|(
name|temprdataset
argument_list|)
expr_stmt|;
name|result
operator|=
name|dns_rdatalist_tordataset
argument_list|(
name|temprdatalist
argument_list|,
name|temprdataset
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
goto|goto
name|soa_cleanup
goto|;
name|ISC_LIST_APPEND
argument_list|(
name|tempname
operator|->
name|list
argument_list|,
name|temprdataset
argument_list|,
name|link
argument_list|)
expr_stmt|;
name|dns_message_addname
argument_list|(
name|message
argument_list|,
name|tempname
argument_list|,
name|DNS_SECTION_ANSWER
argument_list|)
expr_stmt|;
name|temprdatalist
operator|=
name|NULL
expr_stmt|;
name|temprdataset
operator|=
name|NULL
expr_stmt|;
name|temprdata
operator|=
name|NULL
expr_stmt|;
name|tempname
operator|=
name|NULL
expr_stmt|;
name|soa_cleanup
label|:
if|if
condition|(
name|node
operator|!=
name|NULL
condition|)
name|dns_db_detachnode
argument_list|(
name|zone
operator|->
name|db
argument_list|,
operator|&
name|node
argument_list|)
expr_stmt|;
if|if
condition|(
name|version
operator|!=
name|NULL
condition|)
name|dns_db_closeversion
argument_list|(
name|zone
operator|->
name|db
argument_list|,
operator|&
name|version
argument_list|,
name|ISC_FALSE
argument_list|)
expr_stmt|;
if|if
condition|(
name|tempname
operator|!=
name|NULL
condition|)
name|dns_message_puttempname
argument_list|(
name|message
argument_list|,
operator|&
name|tempname
argument_list|)
expr_stmt|;
if|if
condition|(
name|temprdata
operator|!=
name|NULL
condition|)
name|dns_message_puttemprdata
argument_list|(
name|message
argument_list|,
operator|&
name|temprdata
argument_list|)
expr_stmt|;
if|if
condition|(
name|temprdataset
operator|!=
name|NULL
condition|)
name|dns_message_puttemprdataset
argument_list|(
name|message
argument_list|,
operator|&
name|temprdataset
argument_list|)
expr_stmt|;
if|if
condition|(
name|temprdatalist
operator|!=
name|NULL
condition|)
name|dns_message_puttemprdatalist
argument_list|(
name|message
argument_list|,
operator|&
name|temprdatalist
argument_list|)
expr_stmt|;
name|done
label|:
operator|*
name|messagep
operator|=
name|message
expr_stmt|;
return|return
operator|(
name|ISC_R_SUCCESS
operator|)
return|;
name|cleanup
label|:
if|if
condition|(
name|tempname
operator|!=
name|NULL
condition|)
name|dns_message_puttempname
argument_list|(
name|message
argument_list|,
operator|&
name|tempname
argument_list|)
expr_stmt|;
if|if
condition|(
name|temprdataset
operator|!=
name|NULL
condition|)
name|dns_message_puttemprdataset
argument_list|(
name|message
argument_list|,
operator|&
name|temprdataset
argument_list|)
expr_stmt|;
name|dns_message_destroy
argument_list|(
operator|&
name|message
argument_list|)
expr_stmt|;
return|return
operator|(
name|result
operator|)
return|;
block|}
end_function

begin_function
name|isc_result_t
name|dns_zone_notifyreceive
parameter_list|(
name|dns_zone_t
modifier|*
name|zone
parameter_list|,
name|isc_sockaddr_t
modifier|*
name|from
parameter_list|,
name|dns_message_t
modifier|*
name|msg
parameter_list|)
block|{
name|unsigned
name|int
name|i
decl_stmt|;
name|dns_rdata_soa_t
name|soa
decl_stmt|;
name|dns_rdataset_t
modifier|*
name|rdataset
init|=
name|NULL
decl_stmt|;
name|dns_rdata_t
name|rdata
init|=
name|DNS_RDATA_INIT
decl_stmt|;
name|isc_result_t
name|result
decl_stmt|;
name|char
name|fromtext
index|[
name|ISC_SOCKADDR_FORMATSIZE
index|]
decl_stmt|;
name|int
name|match
init|=
literal|0
decl_stmt|;
name|isc_netaddr_t
name|netaddr
decl_stmt|;
name|REQUIRE
argument_list|(
name|DNS_ZONE_VALID
argument_list|(
name|zone
argument_list|)
argument_list|)
expr_stmt|;
comment|/* 	 * If type != T_SOA return DNS_R_REFUSED.  We don't yet support 	 * ROLLOVER. 	 * 	 * SOA:	RFC 1996 	 * Check that 'from' is a valid notify source, (zone->masters). 	 *	Return DNS_R_REFUSED if not. 	 * 	 * If the notify message contains a serial number check it 	 * against the zones serial and return if<= current serial 	 * 	 * If a refresh check is progress, if so just record the 	 * fact we received a NOTIFY and from where and return. 	 * We will perform a new refresh check when the current one 	 * completes. Return ISC_R_SUCCESS. 	 * 	 * Otherwise initiate a refresh check using 'from' as the 	 * first address to check.  Return ISC_R_SUCCESS. 	 */
name|isc_sockaddr_format
argument_list|(
name|from
argument_list|,
name|fromtext
argument_list|,
sizeof|sizeof
argument_list|(
name|fromtext
argument_list|)
argument_list|)
expr_stmt|;
comment|/* 	 *  We only handle NOTIFY (SOA) at the present. 	 */
name|LOCK_ZONE
argument_list|(
name|zone
argument_list|)
expr_stmt|;
if|if
condition|(
name|msg
operator|->
name|counts
index|[
name|DNS_SECTION_QUESTION
index|]
operator|==
literal|0
operator|||
name|dns_message_findname
argument_list|(
name|msg
argument_list|,
name|DNS_SECTION_QUESTION
argument_list|,
operator|&
name|zone
operator|->
name|origin
argument_list|,
name|dns_rdatatype_soa
argument_list|,
name|dns_rdatatype_none
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
operator|!=
name|ISC_R_SUCCESS
condition|)
block|{
name|UNLOCK_ZONE
argument_list|(
name|zone
argument_list|)
expr_stmt|;
if|if
condition|(
name|msg
operator|->
name|counts
index|[
name|DNS_SECTION_QUESTION
index|]
operator|==
literal|0
condition|)
block|{
name|dns_zone_log
argument_list|(
name|zone
argument_list|,
name|ISC_LOG_NOTICE
argument_list|,
literal|"NOTIFY with no "
literal|"question section from: %s"
argument_list|,
name|fromtext
argument_list|)
expr_stmt|;
return|return
operator|(
name|DNS_R_FORMERR
operator|)
return|;
block|}
name|dns_zone_log
argument_list|(
name|zone
argument_list|,
name|ISC_LOG_NOTICE
argument_list|,
literal|"NOTIFY zone does not match"
argument_list|)
expr_stmt|;
return|return
operator|(
name|DNS_R_NOTIMP
operator|)
return|;
block|}
comment|/* 	 * If we are a master zone just succeed. 	 */
if|if
condition|(
name|zone
operator|->
name|type
operator|==
name|dns_zone_master
condition|)
block|{
name|UNLOCK_ZONE
argument_list|(
name|zone
argument_list|)
expr_stmt|;
return|return
operator|(
name|ISC_R_SUCCESS
operator|)
return|;
block|}
name|isc_netaddr_fromsockaddr
argument_list|(
operator|&
name|netaddr
argument_list|,
name|from
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|zone
operator|->
name|masterscnt
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|isc_sockaddr_eqaddr
argument_list|(
name|from
argument_list|,
operator|&
name|zone
operator|->
name|masters
index|[
name|i
index|]
argument_list|)
condition|)
break|break;
if|if
condition|(
name|zone
operator|->
name|view
operator|->
name|aclenv
operator|.
name|match_mapped
operator|&&
name|IN6_IS_ADDR_V4MAPPED
argument_list|(
operator|&
name|from
operator|->
name|type
operator|.
name|sin6
operator|.
name|sin6_addr
argument_list|)
operator|&&
name|isc_sockaddr_pf
argument_list|(
operator|&
name|zone
operator|->
name|masters
index|[
name|i
index|]
argument_list|)
operator|==
name|AF_INET
condition|)
block|{
name|isc_netaddr_t
name|na1
decl_stmt|,
name|na2
decl_stmt|;
name|isc_netaddr_fromv4mapped
argument_list|(
operator|&
name|na1
argument_list|,
operator|&
name|netaddr
argument_list|)
expr_stmt|;
name|isc_netaddr_fromsockaddr
argument_list|(
operator|&
name|na2
argument_list|,
operator|&
name|zone
operator|->
name|masters
index|[
name|i
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|isc_netaddr_equal
argument_list|(
operator|&
name|na1
argument_list|,
operator|&
name|na2
argument_list|)
condition|)
break|break;
block|}
block|}
comment|/* 	 * Accept notify requests from non masters if they are on 	 * 'zone->notify_acl'. 	 */
if|if
condition|(
name|i
operator|>=
name|zone
operator|->
name|masterscnt
operator|&&
name|zone
operator|->
name|notify_acl
operator|!=
name|NULL
operator|&&
name|dns_acl_match
argument_list|(
operator|&
name|netaddr
argument_list|,
name|NULL
argument_list|,
name|zone
operator|->
name|notify_acl
argument_list|,
operator|&
name|zone
operator|->
name|view
operator|->
name|aclenv
argument_list|,
operator|&
name|match
argument_list|,
name|NULL
argument_list|)
operator|==
name|ISC_R_SUCCESS
operator|&&
name|match
operator|>
literal|0
condition|)
block|{
comment|/* Accept notify. */
block|}
elseif|else
if|if
condition|(
name|i
operator|>=
name|zone
operator|->
name|masterscnt
condition|)
block|{
name|UNLOCK_ZONE
argument_list|(
name|zone
argument_list|)
expr_stmt|;
name|dns_zone_log
argument_list|(
name|zone
argument_list|,
name|ISC_LOG_INFO
argument_list|,
literal|"refused notify from non-master: %s"
argument_list|,
name|fromtext
argument_list|)
expr_stmt|;
return|return
operator|(
name|DNS_R_REFUSED
operator|)
return|;
block|}
comment|/* 	 * If the zone is loaded and there are answers check the serial 	 * to see if we need to do a refresh.  Do not worry about this 	 * check if we are a dialup zone as we use the notify request 	 * to trigger a refresh check. 	 */
if|if
condition|(
name|msg
operator|->
name|counts
index|[
name|DNS_SECTION_ANSWER
index|]
operator|>
literal|0
operator|&&
name|DNS_ZONE_FLAG
argument_list|(
name|zone
argument_list|,
name|DNS_ZONEFLG_LOADED
argument_list|)
operator|&&
operator|!
name|DNS_ZONE_FLAG
argument_list|(
name|zone
argument_list|,
name|DNS_ZONEFLG_NOREFRESH
argument_list|)
condition|)
block|{
name|result
operator|=
name|dns_message_findname
argument_list|(
name|msg
argument_list|,
name|DNS_SECTION_ANSWER
argument_list|,
operator|&
name|zone
operator|->
name|origin
argument_list|,
name|dns_rdatatype_soa
argument_list|,
name|dns_rdatatype_none
argument_list|,
name|NULL
argument_list|,
operator|&
name|rdataset
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|==
name|ISC_R_SUCCESS
condition|)
name|result
operator|=
name|dns_rdataset_first
argument_list|(
name|rdataset
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|==
name|ISC_R_SUCCESS
condition|)
block|{
name|isc_uint32_t
name|serial
init|=
literal|0
decl_stmt|;
name|dns_rdataset_current
argument_list|(
name|rdataset
argument_list|,
operator|&
name|rdata
argument_list|)
expr_stmt|;
name|result
operator|=
name|dns_rdata_tostruct
argument_list|(
operator|&
name|rdata
argument_list|,
operator|&
name|soa
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|RUNTIME_CHECK
argument_list|(
name|result
operator|==
name|ISC_R_SUCCESS
argument_list|)
expr_stmt|;
name|serial
operator|=
name|soa
operator|.
name|serial
expr_stmt|;
if|if
condition|(
name|isc_serial_le
argument_list|(
name|serial
argument_list|,
name|zone
operator|->
name|serial
argument_list|)
condition|)
block|{
name|dns_zone_log
argument_list|(
name|zone
argument_list|,
name|ISC_LOG_INFO
argument_list|,
literal|"notify from %s: "
literal|"zone is up to date"
argument_list|,
name|fromtext
argument_list|)
expr_stmt|;
name|UNLOCK_ZONE
argument_list|(
name|zone
argument_list|)
expr_stmt|;
return|return
operator|(
name|ISC_R_SUCCESS
operator|)
return|;
block|}
block|}
block|}
comment|/* 	 * If we got this far and there was a refresh in progress just 	 * let it complete.  Record where we got the notify from so we 	 * can perform a refresh check when the current one completes 	 */
if|if
condition|(
name|DNS_ZONE_FLAG
argument_list|(
name|zone
argument_list|,
name|DNS_ZONEFLG_REFRESH
argument_list|)
condition|)
block|{
name|DNS_ZONE_SETFLAG
argument_list|(
name|zone
argument_list|,
name|DNS_ZONEFLG_NEEDREFRESH
argument_list|)
expr_stmt|;
name|zone
operator|->
name|notifyfrom
operator|=
operator|*
name|from
expr_stmt|;
name|UNLOCK_ZONE
argument_list|(
name|zone
argument_list|)
expr_stmt|;
name|dns_zone_log
argument_list|(
name|zone
argument_list|,
name|ISC_LOG_INFO
argument_list|,
literal|"notify from %s: refresh in progress, "
literal|"refresh check queued"
argument_list|,
name|fromtext
argument_list|)
expr_stmt|;
return|return
operator|(
name|ISC_R_SUCCESS
operator|)
return|;
block|}
name|zone
operator|->
name|notifyfrom
operator|=
operator|*
name|from
expr_stmt|;
name|UNLOCK_ZONE
argument_list|(
name|zone
argument_list|)
expr_stmt|;
name|dns_zone_refresh
argument_list|(
name|zone
argument_list|)
expr_stmt|;
return|return
operator|(
name|ISC_R_SUCCESS
operator|)
return|;
block|}
end_function

begin_function
name|void
name|dns_zone_setnotifyacl
parameter_list|(
name|dns_zone_t
modifier|*
name|zone
parameter_list|,
name|dns_acl_t
modifier|*
name|acl
parameter_list|)
block|{
name|REQUIRE
argument_list|(
name|DNS_ZONE_VALID
argument_list|(
name|zone
argument_list|)
argument_list|)
expr_stmt|;
name|LOCK_ZONE
argument_list|(
name|zone
argument_list|)
expr_stmt|;
if|if
condition|(
name|zone
operator|->
name|notify_acl
operator|!=
name|NULL
condition|)
name|dns_acl_detach
argument_list|(
operator|&
name|zone
operator|->
name|notify_acl
argument_list|)
expr_stmt|;
name|dns_acl_attach
argument_list|(
name|acl
argument_list|,
operator|&
name|zone
operator|->
name|notify_acl
argument_list|)
expr_stmt|;
name|UNLOCK_ZONE
argument_list|(
name|zone
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|dns_zone_setqueryacl
parameter_list|(
name|dns_zone_t
modifier|*
name|zone
parameter_list|,
name|dns_acl_t
modifier|*
name|acl
parameter_list|)
block|{
name|REQUIRE
argument_list|(
name|DNS_ZONE_VALID
argument_list|(
name|zone
argument_list|)
argument_list|)
expr_stmt|;
name|LOCK_ZONE
argument_list|(
name|zone
argument_list|)
expr_stmt|;
if|if
condition|(
name|zone
operator|->
name|query_acl
operator|!=
name|NULL
condition|)
name|dns_acl_detach
argument_list|(
operator|&
name|zone
operator|->
name|query_acl
argument_list|)
expr_stmt|;
name|dns_acl_attach
argument_list|(
name|acl
argument_list|,
operator|&
name|zone
operator|->
name|query_acl
argument_list|)
expr_stmt|;
name|UNLOCK_ZONE
argument_list|(
name|zone
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|dns_zone_setupdateacl
parameter_list|(
name|dns_zone_t
modifier|*
name|zone
parameter_list|,
name|dns_acl_t
modifier|*
name|acl
parameter_list|)
block|{
name|REQUIRE
argument_list|(
name|DNS_ZONE_VALID
argument_list|(
name|zone
argument_list|)
argument_list|)
expr_stmt|;
name|LOCK_ZONE
argument_list|(
name|zone
argument_list|)
expr_stmt|;
if|if
condition|(
name|zone
operator|->
name|update_acl
operator|!=
name|NULL
condition|)
name|dns_acl_detach
argument_list|(
operator|&
name|zone
operator|->
name|update_acl
argument_list|)
expr_stmt|;
name|dns_acl_attach
argument_list|(
name|acl
argument_list|,
operator|&
name|zone
operator|->
name|update_acl
argument_list|)
expr_stmt|;
name|UNLOCK_ZONE
argument_list|(
name|zone
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|dns_zone_setforwardacl
parameter_list|(
name|dns_zone_t
modifier|*
name|zone
parameter_list|,
name|dns_acl_t
modifier|*
name|acl
parameter_list|)
block|{
name|REQUIRE
argument_list|(
name|DNS_ZONE_VALID
argument_list|(
name|zone
argument_list|)
argument_list|)
expr_stmt|;
name|LOCK_ZONE
argument_list|(
name|zone
argument_list|)
expr_stmt|;
if|if
condition|(
name|zone
operator|->
name|forward_acl
operator|!=
name|NULL
condition|)
name|dns_acl_detach
argument_list|(
operator|&
name|zone
operator|->
name|forward_acl
argument_list|)
expr_stmt|;
name|dns_acl_attach
argument_list|(
name|acl
argument_list|,
operator|&
name|zone
operator|->
name|forward_acl
argument_list|)
expr_stmt|;
name|UNLOCK_ZONE
argument_list|(
name|zone
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|dns_zone_setxfracl
parameter_list|(
name|dns_zone_t
modifier|*
name|zone
parameter_list|,
name|dns_acl_t
modifier|*
name|acl
parameter_list|)
block|{
name|REQUIRE
argument_list|(
name|DNS_ZONE_VALID
argument_list|(
name|zone
argument_list|)
argument_list|)
expr_stmt|;
name|LOCK_ZONE
argument_list|(
name|zone
argument_list|)
expr_stmt|;
if|if
condition|(
name|zone
operator|->
name|xfr_acl
operator|!=
name|NULL
condition|)
name|dns_acl_detach
argument_list|(
operator|&
name|zone
operator|->
name|xfr_acl
argument_list|)
expr_stmt|;
name|dns_acl_attach
argument_list|(
name|acl
argument_list|,
operator|&
name|zone
operator|->
name|xfr_acl
argument_list|)
expr_stmt|;
name|UNLOCK_ZONE
argument_list|(
name|zone
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|dns_acl_t
modifier|*
name|dns_zone_getnotifyacl
parameter_list|(
name|dns_zone_t
modifier|*
name|zone
parameter_list|)
block|{
name|REQUIRE
argument_list|(
name|DNS_ZONE_VALID
argument_list|(
name|zone
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|(
name|zone
operator|->
name|notify_acl
operator|)
return|;
block|}
end_function

begin_function
name|dns_acl_t
modifier|*
name|dns_zone_getqueryacl
parameter_list|(
name|dns_zone_t
modifier|*
name|zone
parameter_list|)
block|{
name|REQUIRE
argument_list|(
name|DNS_ZONE_VALID
argument_list|(
name|zone
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|(
name|zone
operator|->
name|query_acl
operator|)
return|;
block|}
end_function

begin_function
name|dns_acl_t
modifier|*
name|dns_zone_getupdateacl
parameter_list|(
name|dns_zone_t
modifier|*
name|zone
parameter_list|)
block|{
name|REQUIRE
argument_list|(
name|DNS_ZONE_VALID
argument_list|(
name|zone
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|(
name|zone
operator|->
name|update_acl
operator|)
return|;
block|}
end_function

begin_function
name|dns_acl_t
modifier|*
name|dns_zone_getforwardacl
parameter_list|(
name|dns_zone_t
modifier|*
name|zone
parameter_list|)
block|{
name|REQUIRE
argument_list|(
name|DNS_ZONE_VALID
argument_list|(
name|zone
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|(
name|zone
operator|->
name|forward_acl
operator|)
return|;
block|}
end_function

begin_function
name|dns_acl_t
modifier|*
name|dns_zone_getxfracl
parameter_list|(
name|dns_zone_t
modifier|*
name|zone
parameter_list|)
block|{
name|REQUIRE
argument_list|(
name|DNS_ZONE_VALID
argument_list|(
name|zone
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|(
name|zone
operator|->
name|xfr_acl
operator|)
return|;
block|}
end_function

begin_function
name|void
name|dns_zone_clearupdateacl
parameter_list|(
name|dns_zone_t
modifier|*
name|zone
parameter_list|)
block|{
name|REQUIRE
argument_list|(
name|DNS_ZONE_VALID
argument_list|(
name|zone
argument_list|)
argument_list|)
expr_stmt|;
name|LOCK_ZONE
argument_list|(
name|zone
argument_list|)
expr_stmt|;
if|if
condition|(
name|zone
operator|->
name|update_acl
operator|!=
name|NULL
condition|)
name|dns_acl_detach
argument_list|(
operator|&
name|zone
operator|->
name|update_acl
argument_list|)
expr_stmt|;
name|UNLOCK_ZONE
argument_list|(
name|zone
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|dns_zone_clearforwardacl
parameter_list|(
name|dns_zone_t
modifier|*
name|zone
parameter_list|)
block|{
name|REQUIRE
argument_list|(
name|DNS_ZONE_VALID
argument_list|(
name|zone
argument_list|)
argument_list|)
expr_stmt|;
name|LOCK_ZONE
argument_list|(
name|zone
argument_list|)
expr_stmt|;
if|if
condition|(
name|zone
operator|->
name|forward_acl
operator|!=
name|NULL
condition|)
name|dns_acl_detach
argument_list|(
operator|&
name|zone
operator|->
name|forward_acl
argument_list|)
expr_stmt|;
name|UNLOCK_ZONE
argument_list|(
name|zone
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|dns_zone_clearnotifyacl
parameter_list|(
name|dns_zone_t
modifier|*
name|zone
parameter_list|)
block|{
name|REQUIRE
argument_list|(
name|DNS_ZONE_VALID
argument_list|(
name|zone
argument_list|)
argument_list|)
expr_stmt|;
name|LOCK_ZONE
argument_list|(
name|zone
argument_list|)
expr_stmt|;
if|if
condition|(
name|zone
operator|->
name|notify_acl
operator|!=
name|NULL
condition|)
name|dns_acl_detach
argument_list|(
operator|&
name|zone
operator|->
name|notify_acl
argument_list|)
expr_stmt|;
name|UNLOCK_ZONE
argument_list|(
name|zone
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|dns_zone_clearqueryacl
parameter_list|(
name|dns_zone_t
modifier|*
name|zone
parameter_list|)
block|{
name|REQUIRE
argument_list|(
name|DNS_ZONE_VALID
argument_list|(
name|zone
argument_list|)
argument_list|)
expr_stmt|;
name|LOCK_ZONE
argument_list|(
name|zone
argument_list|)
expr_stmt|;
if|if
condition|(
name|zone
operator|->
name|query_acl
operator|!=
name|NULL
condition|)
name|dns_acl_detach
argument_list|(
operator|&
name|zone
operator|->
name|query_acl
argument_list|)
expr_stmt|;
name|UNLOCK_ZONE
argument_list|(
name|zone
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|dns_zone_clearxfracl
parameter_list|(
name|dns_zone_t
modifier|*
name|zone
parameter_list|)
block|{
name|REQUIRE
argument_list|(
name|DNS_ZONE_VALID
argument_list|(
name|zone
argument_list|)
argument_list|)
expr_stmt|;
name|LOCK_ZONE
argument_list|(
name|zone
argument_list|)
expr_stmt|;
if|if
condition|(
name|zone
operator|->
name|xfr_acl
operator|!=
name|NULL
condition|)
name|dns_acl_detach
argument_list|(
operator|&
name|zone
operator|->
name|xfr_acl
argument_list|)
expr_stmt|;
name|UNLOCK_ZONE
argument_list|(
name|zone
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|isc_boolean_t
name|dns_zone_getupdatedisabled
parameter_list|(
name|dns_zone_t
modifier|*
name|zone
parameter_list|)
block|{
name|REQUIRE
argument_list|(
name|DNS_ZONE_VALID
argument_list|(
name|zone
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|(
name|zone
operator|->
name|update_disabled
operator|)
return|;
block|}
end_function

begin_function
name|void
name|dns_zone_setupdatedisabled
parameter_list|(
name|dns_zone_t
modifier|*
name|zone
parameter_list|,
name|isc_boolean_t
name|state
parameter_list|)
block|{
name|REQUIRE
argument_list|(
name|DNS_ZONE_VALID
argument_list|(
name|zone
argument_list|)
argument_list|)
expr_stmt|;
name|zone
operator|->
name|update_disabled
operator|=
name|state
expr_stmt|;
block|}
end_function

begin_function
name|void
name|dns_zone_setchecknames
parameter_list|(
name|dns_zone_t
modifier|*
name|zone
parameter_list|,
name|dns_severity_t
name|severity
parameter_list|)
block|{
name|REQUIRE
argument_list|(
name|DNS_ZONE_VALID
argument_list|(
name|zone
argument_list|)
argument_list|)
expr_stmt|;
name|zone
operator|->
name|check_names
operator|=
name|severity
expr_stmt|;
block|}
end_function

begin_function
name|dns_severity_t
name|dns_zone_getchecknames
parameter_list|(
name|dns_zone_t
modifier|*
name|zone
parameter_list|)
block|{
name|REQUIRE
argument_list|(
name|DNS_ZONE_VALID
argument_list|(
name|zone
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|(
name|zone
operator|->
name|check_names
operator|)
return|;
block|}
end_function

begin_function
name|void
name|dns_zone_setjournalsize
parameter_list|(
name|dns_zone_t
modifier|*
name|zone
parameter_list|,
name|isc_int32_t
name|size
parameter_list|)
block|{
name|REQUIRE
argument_list|(
name|DNS_ZONE_VALID
argument_list|(
name|zone
argument_list|)
argument_list|)
expr_stmt|;
name|zone
operator|->
name|journalsize
operator|=
name|size
expr_stmt|;
block|}
end_function

begin_function
name|isc_int32_t
name|dns_zone_getjournalsize
parameter_list|(
name|dns_zone_t
modifier|*
name|zone
parameter_list|)
block|{
name|REQUIRE
argument_list|(
name|DNS_ZONE_VALID
argument_list|(
name|zone
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|(
name|zone
operator|->
name|journalsize
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|zone_tostr
parameter_list|(
name|dns_zone_t
modifier|*
name|zone
parameter_list|,
name|char
modifier|*
name|buf
parameter_list|,
name|size_t
name|length
parameter_list|)
block|{
name|isc_result_t
name|result
init|=
name|ISC_R_FAILURE
decl_stmt|;
name|isc_buffer_t
name|buffer
decl_stmt|;
name|REQUIRE
argument_list|(
name|buf
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|REQUIRE
argument_list|(
name|length
operator|>
literal|1U
argument_list|)
expr_stmt|;
comment|/* 	 * Leave space for terminating '\0'. 	 */
name|isc_buffer_init
argument_list|(
operator|&
name|buffer
argument_list|,
name|buf
argument_list|,
name|length
operator|-
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|dns_name_dynamic
argument_list|(
operator|&
name|zone
operator|->
name|origin
argument_list|)
condition|)
name|result
operator|=
name|dns_name_totext
argument_list|(
operator|&
name|zone
operator|->
name|origin
argument_list|,
name|ISC_TRUE
argument_list|,
operator|&
name|buffer
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
operator|&&
name|isc_buffer_availablelength
argument_list|(
operator|&
name|buffer
argument_list|)
operator|>=
operator|(
sizeof|sizeof
argument_list|(
literal|"<UNKNOWN>"
argument_list|)
operator|-
literal|1
operator|)
condition|)
name|isc_buffer_putstr
argument_list|(
operator|&
name|buffer
argument_list|,
literal|"<UNKNOWN>"
argument_list|)
expr_stmt|;
if|if
condition|(
name|isc_buffer_availablelength
argument_list|(
operator|&
name|buffer
argument_list|)
operator|>
literal|0
condition|)
name|isc_buffer_putstr
argument_list|(
operator|&
name|buffer
argument_list|,
literal|"/"
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|dns_rdataclass_totext
argument_list|(
name|zone
operator|->
name|rdclass
argument_list|,
operator|&
name|buffer
argument_list|)
expr_stmt|;
if|if
condition|(
name|zone
operator|->
name|view
operator|!=
name|NULL
operator|&&
name|strcmp
argument_list|(
name|zone
operator|->
name|view
operator|->
name|name
argument_list|,
literal|"_bind"
argument_list|)
operator|!=
literal|0
operator|&&
name|strcmp
argument_list|(
name|zone
operator|->
name|view
operator|->
name|name
argument_list|,
literal|"_default"
argument_list|)
operator|!=
literal|0
operator|&&
name|strlen
argument_list|(
name|zone
operator|->
name|view
operator|->
name|name
argument_list|)
operator|<
name|isc_buffer_availablelength
argument_list|(
operator|&
name|buffer
argument_list|)
condition|)
block|{
name|isc_buffer_putstr
argument_list|(
operator|&
name|buffer
argument_list|,
literal|"/"
argument_list|)
expr_stmt|;
name|isc_buffer_putstr
argument_list|(
operator|&
name|buffer
argument_list|,
name|zone
operator|->
name|view
operator|->
name|name
argument_list|)
expr_stmt|;
block|}
name|buf
index|[
name|isc_buffer_usedlength
argument_list|(
operator|&
name|buffer
argument_list|)
index|]
operator|=
literal|'\0'
expr_stmt|;
block|}
end_function

begin_function
name|void
name|dns_zone_name
parameter_list|(
name|dns_zone_t
modifier|*
name|zone
parameter_list|,
name|char
modifier|*
name|buf
parameter_list|,
name|size_t
name|length
parameter_list|)
block|{
name|REQUIRE
argument_list|(
name|DNS_ZONE_VALID
argument_list|(
name|zone
argument_list|)
argument_list|)
expr_stmt|;
name|REQUIRE
argument_list|(
name|buf
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|zone_tostr
argument_list|(
name|zone
argument_list|,
name|buf
argument_list|,
name|length
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|notify_log
parameter_list|(
name|dns_zone_t
modifier|*
name|zone
parameter_list|,
name|int
name|level
parameter_list|,
specifier|const
name|char
modifier|*
name|fmt
parameter_list|,
modifier|...
parameter_list|)
block|{
name|va_list
name|ap
decl_stmt|;
name|char
name|message
index|[
literal|4096
index|]
decl_stmt|;
name|char
name|namebuf
index|[
literal|1024
operator|+
literal|32
index|]
decl_stmt|;
if|if
condition|(
name|isc_log_wouldlog
argument_list|(
name|dns_lctx
argument_list|,
name|level
argument_list|)
operator|==
name|ISC_FALSE
condition|)
return|return;
name|zone_tostr
argument_list|(
name|zone
argument_list|,
name|namebuf
argument_list|,
sizeof|sizeof
argument_list|(
name|namebuf
argument_list|)
argument_list|)
expr_stmt|;
name|va_start
argument_list|(
name|ap
argument_list|,
name|fmt
argument_list|)
expr_stmt|;
name|vsnprintf
argument_list|(
name|message
argument_list|,
sizeof|sizeof
argument_list|(
name|message
argument_list|)
argument_list|,
name|fmt
argument_list|,
name|ap
argument_list|)
expr_stmt|;
name|va_end
argument_list|(
name|ap
argument_list|)
expr_stmt|;
name|isc_log_write
argument_list|(
name|dns_lctx
argument_list|,
name|DNS_LOGCATEGORY_NOTIFY
argument_list|,
name|DNS_LOGMODULE_ZONE
argument_list|,
name|level
argument_list|,
literal|"zone %s: %s"
argument_list|,
name|namebuf
argument_list|,
name|message
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|dns_zone_logc
parameter_list|(
name|dns_zone_t
modifier|*
name|zone
parameter_list|,
name|isc_logcategory_t
modifier|*
name|category
parameter_list|,
name|int
name|level
parameter_list|,
specifier|const
name|char
modifier|*
name|fmt
parameter_list|,
modifier|...
parameter_list|)
block|{
name|va_list
name|ap
decl_stmt|;
name|char
name|message
index|[
literal|4096
index|]
decl_stmt|;
name|char
name|namebuf
index|[
literal|1024
operator|+
literal|32
index|]
decl_stmt|;
if|if
condition|(
name|isc_log_wouldlog
argument_list|(
name|dns_lctx
argument_list|,
name|level
argument_list|)
operator|==
name|ISC_FALSE
condition|)
return|return;
name|zone_tostr
argument_list|(
name|zone
argument_list|,
name|namebuf
argument_list|,
sizeof|sizeof
argument_list|(
name|namebuf
argument_list|)
argument_list|)
expr_stmt|;
name|va_start
argument_list|(
name|ap
argument_list|,
name|fmt
argument_list|)
expr_stmt|;
name|vsnprintf
argument_list|(
name|message
argument_list|,
sizeof|sizeof
argument_list|(
name|message
argument_list|)
argument_list|,
name|fmt
argument_list|,
name|ap
argument_list|)
expr_stmt|;
name|va_end
argument_list|(
name|ap
argument_list|)
expr_stmt|;
name|isc_log_write
argument_list|(
name|dns_lctx
argument_list|,
name|category
argument_list|,
name|DNS_LOGMODULE_ZONE
argument_list|,
name|level
argument_list|,
literal|"zone %s: %s"
argument_list|,
name|namebuf
argument_list|,
name|message
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|dns_zone_log
parameter_list|(
name|dns_zone_t
modifier|*
name|zone
parameter_list|,
name|int
name|level
parameter_list|,
specifier|const
name|char
modifier|*
name|fmt
parameter_list|,
modifier|...
parameter_list|)
block|{
name|va_list
name|ap
decl_stmt|;
name|char
name|message
index|[
literal|4096
index|]
decl_stmt|;
name|char
name|namebuf
index|[
literal|1024
operator|+
literal|32
index|]
decl_stmt|;
if|if
condition|(
name|isc_log_wouldlog
argument_list|(
name|dns_lctx
argument_list|,
name|level
argument_list|)
operator|==
name|ISC_FALSE
condition|)
return|return;
name|zone_tostr
argument_list|(
name|zone
argument_list|,
name|namebuf
argument_list|,
sizeof|sizeof
argument_list|(
name|namebuf
argument_list|)
argument_list|)
expr_stmt|;
name|va_start
argument_list|(
name|ap
argument_list|,
name|fmt
argument_list|)
expr_stmt|;
name|vsnprintf
argument_list|(
name|message
argument_list|,
sizeof|sizeof
argument_list|(
name|message
argument_list|)
argument_list|,
name|fmt
argument_list|,
name|ap
argument_list|)
expr_stmt|;
name|va_end
argument_list|(
name|ap
argument_list|)
expr_stmt|;
name|isc_log_write
argument_list|(
name|dns_lctx
argument_list|,
name|DNS_LOGCATEGORY_GENERAL
argument_list|,
name|DNS_LOGMODULE_ZONE
argument_list|,
name|level
argument_list|,
literal|"zone %s: %s"
argument_list|,
name|namebuf
argument_list|,
name|message
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|zone_debuglog
parameter_list|(
name|dns_zone_t
modifier|*
name|zone
parameter_list|,
specifier|const
name|char
modifier|*
name|me
parameter_list|,
name|int
name|debuglevel
parameter_list|,
specifier|const
name|char
modifier|*
name|fmt
parameter_list|,
modifier|...
parameter_list|)
block|{
name|va_list
name|ap
decl_stmt|;
name|char
name|message
index|[
literal|4096
index|]
decl_stmt|;
name|char
name|namebuf
index|[
literal|1024
operator|+
literal|32
index|]
decl_stmt|;
name|int
name|level
init|=
name|ISC_LOG_DEBUG
argument_list|(
name|debuglevel
argument_list|)
decl_stmt|;
if|if
condition|(
name|isc_log_wouldlog
argument_list|(
name|dns_lctx
argument_list|,
name|level
argument_list|)
operator|==
name|ISC_FALSE
condition|)
return|return;
name|zone_tostr
argument_list|(
name|zone
argument_list|,
name|namebuf
argument_list|,
sizeof|sizeof
argument_list|(
name|namebuf
argument_list|)
argument_list|)
expr_stmt|;
name|va_start
argument_list|(
name|ap
argument_list|,
name|fmt
argument_list|)
expr_stmt|;
name|vsnprintf
argument_list|(
name|message
argument_list|,
sizeof|sizeof
argument_list|(
name|message
argument_list|)
argument_list|,
name|fmt
argument_list|,
name|ap
argument_list|)
expr_stmt|;
name|va_end
argument_list|(
name|ap
argument_list|)
expr_stmt|;
name|isc_log_write
argument_list|(
name|dns_lctx
argument_list|,
name|DNS_LOGCATEGORY_GENERAL
argument_list|,
name|DNS_LOGMODULE_ZONE
argument_list|,
name|level
argument_list|,
literal|"%s: zone %s: %s"
argument_list|,
name|me
argument_list|,
name|namebuf
argument_list|,
name|message
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|message_count
parameter_list|(
name|dns_message_t
modifier|*
name|msg
parameter_list|,
name|dns_section_t
name|section
parameter_list|,
name|dns_rdatatype_t
name|type
parameter_list|)
block|{
name|isc_result_t
name|result
decl_stmt|;
name|dns_name_t
modifier|*
name|name
decl_stmt|;
name|dns_rdataset_t
modifier|*
name|curr
decl_stmt|;
name|int
name|count
init|=
literal|0
decl_stmt|;
name|result
operator|=
name|dns_message_firstname
argument_list|(
name|msg
argument_list|,
name|section
argument_list|)
expr_stmt|;
while|while
condition|(
name|result
operator|==
name|ISC_R_SUCCESS
condition|)
block|{
name|name
operator|=
name|NULL
expr_stmt|;
name|dns_message_currentname
argument_list|(
name|msg
argument_list|,
name|section
argument_list|,
operator|&
name|name
argument_list|)
expr_stmt|;
for|for
control|(
name|curr
operator|=
name|ISC_LIST_TAIL
argument_list|(
name|name
operator|->
name|list
argument_list|)
init|;
name|curr
operator|!=
name|NULL
condition|;
name|curr
operator|=
name|ISC_LIST_PREV
argument_list|(
name|curr
argument_list|,
name|link
argument_list|)
control|)
block|{
if|if
condition|(
name|curr
operator|->
name|type
operator|==
name|type
condition|)
name|count
operator|++
expr_stmt|;
block|}
name|result
operator|=
name|dns_message_nextname
argument_list|(
name|msg
argument_list|,
name|section
argument_list|)
expr_stmt|;
block|}
return|return
operator|(
name|count
operator|)
return|;
block|}
end_function

begin_function
name|void
name|dns_zone_setmaxxfrin
parameter_list|(
name|dns_zone_t
modifier|*
name|zone
parameter_list|,
name|isc_uint32_t
name|maxxfrin
parameter_list|)
block|{
name|REQUIRE
argument_list|(
name|DNS_ZONE_VALID
argument_list|(
name|zone
argument_list|)
argument_list|)
expr_stmt|;
name|zone
operator|->
name|maxxfrin
operator|=
name|maxxfrin
expr_stmt|;
block|}
end_function

begin_function
name|isc_uint32_t
name|dns_zone_getmaxxfrin
parameter_list|(
name|dns_zone_t
modifier|*
name|zone
parameter_list|)
block|{
name|REQUIRE
argument_list|(
name|DNS_ZONE_VALID
argument_list|(
name|zone
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|(
name|zone
operator|->
name|maxxfrin
operator|)
return|;
block|}
end_function

begin_function
name|void
name|dns_zone_setmaxxfrout
parameter_list|(
name|dns_zone_t
modifier|*
name|zone
parameter_list|,
name|isc_uint32_t
name|maxxfrout
parameter_list|)
block|{
name|REQUIRE
argument_list|(
name|DNS_ZONE_VALID
argument_list|(
name|zone
argument_list|)
argument_list|)
expr_stmt|;
name|zone
operator|->
name|maxxfrout
operator|=
name|maxxfrout
expr_stmt|;
block|}
end_function

begin_function
name|isc_uint32_t
name|dns_zone_getmaxxfrout
parameter_list|(
name|dns_zone_t
modifier|*
name|zone
parameter_list|)
block|{
name|REQUIRE
argument_list|(
name|DNS_ZONE_VALID
argument_list|(
name|zone
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|(
name|zone
operator|->
name|maxxfrout
operator|)
return|;
block|}
end_function

begin_function
name|dns_zonetype_t
name|dns_zone_gettype
parameter_list|(
name|dns_zone_t
modifier|*
name|zone
parameter_list|)
block|{
name|REQUIRE
argument_list|(
name|DNS_ZONE_VALID
argument_list|(
name|zone
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|(
name|zone
operator|->
name|type
operator|)
return|;
block|}
end_function

begin_function
name|dns_name_t
modifier|*
name|dns_zone_getorigin
parameter_list|(
name|dns_zone_t
modifier|*
name|zone
parameter_list|)
block|{
name|REQUIRE
argument_list|(
name|DNS_ZONE_VALID
argument_list|(
name|zone
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|(
operator|&
name|zone
operator|->
name|origin
operator|)
return|;
block|}
end_function

begin_function
name|void
name|dns_zone_settask
parameter_list|(
name|dns_zone_t
modifier|*
name|zone
parameter_list|,
name|isc_task_t
modifier|*
name|task
parameter_list|)
block|{
name|REQUIRE
argument_list|(
name|DNS_ZONE_VALID
argument_list|(
name|zone
argument_list|)
argument_list|)
expr_stmt|;
name|LOCK_ZONE
argument_list|(
name|zone
argument_list|)
expr_stmt|;
if|if
condition|(
name|zone
operator|->
name|task
operator|!=
name|NULL
condition|)
name|isc_task_detach
argument_list|(
operator|&
name|zone
operator|->
name|task
argument_list|)
expr_stmt|;
name|isc_task_attach
argument_list|(
name|task
argument_list|,
operator|&
name|zone
operator|->
name|task
argument_list|)
expr_stmt|;
if|if
condition|(
name|zone
operator|->
name|db
operator|!=
name|NULL
condition|)
name|dns_db_settask
argument_list|(
name|zone
operator|->
name|db
argument_list|,
name|zone
operator|->
name|task
argument_list|)
expr_stmt|;
name|UNLOCK_ZONE
argument_list|(
name|zone
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|dns_zone_gettask
parameter_list|(
name|dns_zone_t
modifier|*
name|zone
parameter_list|,
name|isc_task_t
modifier|*
modifier|*
name|target
parameter_list|)
block|{
name|REQUIRE
argument_list|(
name|DNS_ZONE_VALID
argument_list|(
name|zone
argument_list|)
argument_list|)
expr_stmt|;
name|isc_task_attach
argument_list|(
name|zone
operator|->
name|task
argument_list|,
name|target
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|dns_zone_setidlein
parameter_list|(
name|dns_zone_t
modifier|*
name|zone
parameter_list|,
name|isc_uint32_t
name|idlein
parameter_list|)
block|{
name|REQUIRE
argument_list|(
name|DNS_ZONE_VALID
argument_list|(
name|zone
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|idlein
operator|==
literal|0
condition|)
name|idlein
operator|=
name|DNS_DEFAULT_IDLEIN
expr_stmt|;
name|zone
operator|->
name|idlein
operator|=
name|idlein
expr_stmt|;
block|}
end_function

begin_function
name|isc_uint32_t
name|dns_zone_getidlein
parameter_list|(
name|dns_zone_t
modifier|*
name|zone
parameter_list|)
block|{
name|REQUIRE
argument_list|(
name|DNS_ZONE_VALID
argument_list|(
name|zone
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|(
name|zone
operator|->
name|idlein
operator|)
return|;
block|}
end_function

begin_function
name|void
name|dns_zone_setidleout
parameter_list|(
name|dns_zone_t
modifier|*
name|zone
parameter_list|,
name|isc_uint32_t
name|idleout
parameter_list|)
block|{
name|REQUIRE
argument_list|(
name|DNS_ZONE_VALID
argument_list|(
name|zone
argument_list|)
argument_list|)
expr_stmt|;
name|zone
operator|->
name|idleout
operator|=
name|idleout
expr_stmt|;
block|}
end_function

begin_function
name|isc_uint32_t
name|dns_zone_getidleout
parameter_list|(
name|dns_zone_t
modifier|*
name|zone
parameter_list|)
block|{
name|REQUIRE
argument_list|(
name|DNS_ZONE_VALID
argument_list|(
name|zone
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|(
name|zone
operator|->
name|idleout
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|notify_done
parameter_list|(
name|isc_task_t
modifier|*
name|task
parameter_list|,
name|isc_event_t
modifier|*
name|event
parameter_list|)
block|{
name|dns_requestevent_t
modifier|*
name|revent
init|=
operator|(
name|dns_requestevent_t
operator|*
operator|)
name|event
decl_stmt|;
name|dns_notify_t
modifier|*
name|notify
decl_stmt|;
name|isc_result_t
name|result
decl_stmt|;
name|dns_message_t
modifier|*
name|message
init|=
name|NULL
decl_stmt|;
name|isc_buffer_t
name|buf
decl_stmt|;
name|char
name|rcode
index|[
literal|128
index|]
decl_stmt|;
name|char
name|addrbuf
index|[
name|ISC_SOCKADDR_FORMATSIZE
index|]
decl_stmt|;
name|UNUSED
argument_list|(
name|task
argument_list|)
expr_stmt|;
name|notify
operator|=
name|event
operator|->
name|ev_arg
expr_stmt|;
name|REQUIRE
argument_list|(
name|DNS_NOTIFY_VALID
argument_list|(
name|notify
argument_list|)
argument_list|)
expr_stmt|;
name|INSIST
argument_list|(
name|task
operator|==
name|notify
operator|->
name|zone
operator|->
name|task
argument_list|)
expr_stmt|;
name|isc_buffer_init
argument_list|(
operator|&
name|buf
argument_list|,
name|rcode
argument_list|,
sizeof|sizeof
argument_list|(
name|rcode
argument_list|)
argument_list|)
expr_stmt|;
name|isc_sockaddr_format
argument_list|(
operator|&
name|notify
operator|->
name|dst
argument_list|,
name|addrbuf
argument_list|,
sizeof|sizeof
argument_list|(
name|addrbuf
argument_list|)
argument_list|)
expr_stmt|;
name|result
operator|=
name|revent
operator|->
name|result
expr_stmt|;
if|if
condition|(
name|result
operator|==
name|ISC_R_SUCCESS
condition|)
name|result
operator|=
name|dns_message_create
argument_list|(
name|notify
operator|->
name|zone
operator|->
name|mctx
argument_list|,
name|DNS_MESSAGE_INTENTPARSE
argument_list|,
operator|&
name|message
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|==
name|ISC_R_SUCCESS
condition|)
name|result
operator|=
name|dns_request_getresponse
argument_list|(
name|revent
operator|->
name|request
argument_list|,
name|message
argument_list|,
name|DNS_MESSAGEPARSE_PRESERVEORDER
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|==
name|ISC_R_SUCCESS
condition|)
name|result
operator|=
name|dns_rcode_totext
argument_list|(
name|message
operator|->
name|rcode
argument_list|,
operator|&
name|buf
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|==
name|ISC_R_SUCCESS
condition|)
name|notify_log
argument_list|(
name|notify
operator|->
name|zone
argument_list|,
name|ISC_LOG_DEBUG
argument_list|(
literal|3
argument_list|)
argument_list|,
literal|"notify response from %s: %.*s"
argument_list|,
name|addrbuf
argument_list|,
operator|(
name|int
operator|)
name|buf
operator|.
name|used
argument_list|,
name|rcode
argument_list|)
expr_stmt|;
else|else
name|notify_log
argument_list|(
name|notify
operator|->
name|zone
argument_list|,
name|ISC_LOG_DEBUG
argument_list|(
literal|2
argument_list|)
argument_list|,
literal|"notify to %s failed: %s"
argument_list|,
name|addrbuf
argument_list|,
name|dns_result_totext
argument_list|(
name|result
argument_list|)
argument_list|)
expr_stmt|;
comment|/* 	 * Old bind's return formerr if they see a soa record.  Retry w/o 	 * the soa if we see a formerr and had sent a SOA. 	 */
name|isc_event_free
argument_list|(
operator|&
name|event
argument_list|)
expr_stmt|;
if|if
condition|(
name|message
operator|!=
name|NULL
operator|&&
name|message
operator|->
name|rcode
operator|==
name|dns_rcode_formerr
operator|&&
operator|(
name|notify
operator|->
name|flags
operator|&
name|DNS_NOTIFY_NOSOA
operator|)
operator|==
literal|0
condition|)
block|{
name|notify
operator|->
name|flags
operator||=
name|DNS_NOTIFY_NOSOA
expr_stmt|;
name|dns_request_destroy
argument_list|(
operator|&
name|notify
operator|->
name|request
argument_list|)
expr_stmt|;
name|result
operator|=
name|notify_send_queue
argument_list|(
name|notify
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
name|notify_destroy
argument_list|(
name|notify
argument_list|,
name|ISC_FALSE
argument_list|)
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|result
operator|==
name|ISC_R_TIMEDOUT
condition|)
name|notify_log
argument_list|(
name|notify
operator|->
name|zone
argument_list|,
name|ISC_LOG_DEBUG
argument_list|(
literal|1
argument_list|)
argument_list|,
literal|"notify to %s: retries exceeded"
argument_list|,
name|addrbuf
argument_list|)
expr_stmt|;
name|notify_destroy
argument_list|(
name|notify
argument_list|,
name|ISC_FALSE
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|message
operator|!=
name|NULL
condition|)
name|dns_message_destroy
argument_list|(
operator|&
name|message
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|isc_result_t
name|dns_zone_replacedb
parameter_list|(
name|dns_zone_t
modifier|*
name|zone
parameter_list|,
name|dns_db_t
modifier|*
name|db
parameter_list|,
name|isc_boolean_t
name|dump
parameter_list|)
block|{
name|isc_result_t
name|result
decl_stmt|;
name|REQUIRE
argument_list|(
name|DNS_ZONE_VALID
argument_list|(
name|zone
argument_list|)
argument_list|)
expr_stmt|;
name|LOCK_ZONE
argument_list|(
name|zone
argument_list|)
expr_stmt|;
name|result
operator|=
name|zone_replacedb
argument_list|(
name|zone
argument_list|,
name|db
argument_list|,
name|dump
argument_list|)
expr_stmt|;
name|UNLOCK_ZONE
argument_list|(
name|zone
argument_list|)
expr_stmt|;
return|return
operator|(
name|result
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|isc_result_t
name|zone_replacedb
parameter_list|(
name|dns_zone_t
modifier|*
name|zone
parameter_list|,
name|dns_db_t
modifier|*
name|db
parameter_list|,
name|isc_boolean_t
name|dump
parameter_list|)
block|{
name|dns_dbversion_t
modifier|*
name|ver
decl_stmt|;
name|isc_result_t
name|result
decl_stmt|;
name|unsigned
name|int
name|soacount
init|=
literal|0
decl_stmt|;
name|unsigned
name|int
name|nscount
init|=
literal|0
decl_stmt|;
comment|/* 	 * 'zone' locked by caller. 	 */
name|REQUIRE
argument_list|(
name|DNS_ZONE_VALID
argument_list|(
name|zone
argument_list|)
argument_list|)
expr_stmt|;
name|REQUIRE
argument_list|(
name|LOCKED_ZONE
argument_list|(
name|zone
argument_list|)
argument_list|)
expr_stmt|;
name|result
operator|=
name|zone_get_from_db
argument_list|(
name|db
argument_list|,
operator|&
name|zone
operator|->
name|origin
argument_list|,
operator|&
name|nscount
argument_list|,
operator|&
name|soacount
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|==
name|ISC_R_SUCCESS
condition|)
block|{
if|if
condition|(
name|soacount
operator|!=
literal|1
condition|)
block|{
name|dns_zone_log
argument_list|(
name|zone
argument_list|,
name|ISC_LOG_ERROR
argument_list|,
literal|"has %d SOA records"
argument_list|,
name|soacount
argument_list|)
expr_stmt|;
name|result
operator|=
name|DNS_R_BADZONE
expr_stmt|;
block|}
if|if
condition|(
name|nscount
operator|==
literal|0
condition|)
block|{
name|dns_zone_log
argument_list|(
name|zone
argument_list|,
name|ISC_LOG_ERROR
argument_list|,
literal|"has no NS records"
argument_list|)
expr_stmt|;
name|result
operator|=
name|DNS_R_BADZONE
expr_stmt|;
block|}
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
return|return
operator|(
name|result
operator|)
return|;
block|}
else|else
block|{
name|dns_zone_log
argument_list|(
name|zone
argument_list|,
name|ISC_LOG_ERROR
argument_list|,
literal|"retrieving SOA and NS records failed: %s"
argument_list|,
name|dns_result_totext
argument_list|(
name|result
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|(
name|result
operator|)
return|;
block|}
name|ver
operator|=
name|NULL
expr_stmt|;
name|dns_db_currentversion
argument_list|(
name|db
argument_list|,
operator|&
name|ver
argument_list|)
expr_stmt|;
comment|/* 	 * The initial version of a slave zone is always dumped; 	 * subsequent versions may be journalled instead if this 	 * is enabled in the configuration. 	 */
if|if
condition|(
name|zone
operator|->
name|db
operator|!=
name|NULL
operator|&&
name|zone
operator|->
name|journal
operator|!=
name|NULL
operator|&&
name|DNS_ZONE_OPTION
argument_list|(
name|zone
argument_list|,
name|DNS_ZONEOPT_IXFRFROMDIFFS
argument_list|)
operator|&&
operator|!
name|DNS_ZONE_FLAG
argument_list|(
name|zone
argument_list|,
name|DNS_ZONEFLG_FORCEXFER
argument_list|)
condition|)
block|{
name|isc_uint32_t
name|serial
decl_stmt|;
name|dns_zone_log
argument_list|(
name|zone
argument_list|,
name|ISC_LOG_DEBUG
argument_list|(
literal|3
argument_list|)
argument_list|,
literal|"generating diffs"
argument_list|)
expr_stmt|;
name|result
operator|=
name|dns_db_getsoaserial
argument_list|(
name|db
argument_list|,
name|ver
argument_list|,
operator|&
name|serial
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
block|{
name|dns_zone_log
argument_list|(
name|zone
argument_list|,
name|ISC_LOG_ERROR
argument_list|,
literal|"ixfr-from-differences: unable to get "
literal|"new serial"
argument_list|)
expr_stmt|;
goto|goto
name|fail
goto|;
block|}
comment|/* 		 * This is checked in zone_postload() for master zones. 		 */
if|if
condition|(
name|zone
operator|->
name|type
operator|==
name|dns_zone_slave
operator|&&
operator|!
name|isc_serial_gt
argument_list|(
name|serial
argument_list|,
name|zone
operator|->
name|serial
argument_list|)
condition|)
block|{
name|isc_uint32_t
name|serialmin
decl_stmt|,
name|serialmax
decl_stmt|;
name|serialmin
operator|=
operator|(
name|zone
operator|->
name|serial
operator|+
literal|1
operator|)
operator|&
literal|0xffffffffU
expr_stmt|;
name|serialmax
operator|=
operator|(
name|zone
operator|->
name|serial
operator|+
literal|0x7fffffffU
operator|)
operator|&
literal|0xffffffffU
expr_stmt|;
name|dns_zone_log
argument_list|(
name|zone
argument_list|,
name|ISC_LOG_ERROR
argument_list|,
literal|"ixfr-from-differences: failed: "
literal|"new serial (%u) out of range [%u - %u]"
argument_list|,
name|serial
argument_list|,
name|serialmin
argument_list|,
name|serialmax
argument_list|)
expr_stmt|;
name|result
operator|=
name|ISC_R_RANGE
expr_stmt|;
goto|goto
name|fail
goto|;
block|}
name|result
operator|=
name|dns_db_diff
argument_list|(
name|zone
operator|->
name|mctx
argument_list|,
name|db
argument_list|,
name|ver
argument_list|,
name|zone
operator|->
name|db
argument_list|,
name|NULL
argument_list|,
name|zone
operator|->
name|journal
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
goto|goto
name|fail
goto|;
if|if
condition|(
name|dump
condition|)
name|zone_needdump
argument_list|(
name|zone
argument_list|,
name|DNS_DUMP_DELAY
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|zone
operator|->
name|journalsize
operator|!=
operator|-
literal|1
condition|)
block|{
name|result
operator|=
name|dns_journal_compact
argument_list|(
name|zone
operator|->
name|mctx
argument_list|,
name|zone
operator|->
name|journal
argument_list|,
name|serial
argument_list|,
name|zone
operator|->
name|journalsize
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|result
condition|)
block|{
case|case
name|ISC_R_SUCCESS
case|:
case|case
name|ISC_R_NOSPACE
case|:
case|case
name|ISC_R_NOTFOUND
case|:
name|dns_zone_log
argument_list|(
name|zone
argument_list|,
name|ISC_LOG_DEBUG
argument_list|(
literal|3
argument_list|)
argument_list|,
literal|"dns_journal_compact: %s"
argument_list|,
name|dns_result_totext
argument_list|(
name|result
argument_list|)
argument_list|)
expr_stmt|;
break|break;
default|default:
name|dns_zone_log
argument_list|(
name|zone
argument_list|,
name|ISC_LOG_ERROR
argument_list|,
literal|"dns_journal_compact failed: %s"
argument_list|,
name|dns_result_totext
argument_list|(
name|result
argument_list|)
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
block|}
else|else
block|{
if|if
condition|(
name|dump
operator|&&
name|zone
operator|->
name|masterfile
operator|!=
name|NULL
condition|)
block|{
name|isc_log_write
argument_list|(
name|dns_lctx
argument_list|,
name|DNS_LOGCATEGORY_GENERAL
argument_list|,
name|DNS_LOGMODULE_ZONE
argument_list|,
name|ISC_LOG_DEBUG
argument_list|(
literal|3
argument_list|)
argument_list|,
literal|"dumping new zone version"
argument_list|)
expr_stmt|;
name|result
operator|=
name|dns_db_dump
argument_list|(
name|db
argument_list|,
name|ver
argument_list|,
name|zone
operator|->
name|masterfile
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
goto|goto
name|fail
goto|;
comment|/* 			 * Update the time the zone was updated, so 			 * dns_zone_load can avoid loading it when 			 * the server is reloaded.  If isc_time_now 			 * fails for some reason, all that happens is 			 * the timestamp is not updated. 			 */
name|TIME_NOW
argument_list|(
operator|&
name|zone
operator|->
name|loadtime
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|dump
operator|&&
name|zone
operator|->
name|journal
operator|!=
name|NULL
condition|)
block|{
comment|/* 			 * The in-memory database just changed, and 			 * because 'dump' is set, it didn't change by 			 * being loaded from disk.  Also, we have not 			 * journalled diffs for this change. 			 * Therefore, the on-disk journal is missing 			 * the deltas for this change.  Since it can 			 * no longer be used to bring the zone 			 * up-to-date, it is useless and should be 			 * removed. 			 */
name|isc_log_write
argument_list|(
name|dns_lctx
argument_list|,
name|DNS_LOGCATEGORY_GENERAL
argument_list|,
name|DNS_LOGMODULE_ZONE
argument_list|,
name|ISC_LOG_DEBUG
argument_list|(
literal|3
argument_list|)
argument_list|,
literal|"removing journal file"
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|remove
argument_list|(
name|zone
operator|->
name|journal
argument_list|)
expr_stmt|;
block|}
block|}
name|dns_db_closeversion
argument_list|(
name|db
argument_list|,
operator|&
name|ver
argument_list|,
name|ISC_FALSE
argument_list|)
expr_stmt|;
name|isc_log_write
argument_list|(
name|dns_lctx
argument_list|,
name|DNS_LOGCATEGORY_GENERAL
argument_list|,
name|DNS_LOGMODULE_ZONE
argument_list|,
name|ISC_LOG_DEBUG
argument_list|(
literal|3
argument_list|)
argument_list|,
literal|"replacing zone database"
argument_list|)
expr_stmt|;
if|if
condition|(
name|zone
operator|->
name|db
operator|!=
name|NULL
condition|)
name|dns_db_detach
argument_list|(
operator|&
name|zone
operator|->
name|db
argument_list|)
expr_stmt|;
name|dns_db_attach
argument_list|(
name|db
argument_list|,
operator|&
name|zone
operator|->
name|db
argument_list|)
expr_stmt|;
name|dns_db_settask
argument_list|(
name|zone
operator|->
name|db
argument_list|,
name|zone
operator|->
name|task
argument_list|)
expr_stmt|;
name|DNS_ZONE_SETFLAG
argument_list|(
name|zone
argument_list|,
name|DNS_ZONEFLG_LOADED
operator||
name|DNS_ZONEFLG_NEEDNOTIFY
argument_list|)
expr_stmt|;
return|return
operator|(
name|ISC_R_SUCCESS
operator|)
return|;
name|fail
label|:
name|dns_db_closeversion
argument_list|(
name|db
argument_list|,
operator|&
name|ver
argument_list|,
name|ISC_FALSE
argument_list|)
expr_stmt|;
return|return
operator|(
name|result
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|zone_xfrdone
parameter_list|(
name|dns_zone_t
modifier|*
name|zone
parameter_list|,
name|isc_result_t
name|result
parameter_list|)
block|{
name|isc_time_t
name|now
decl_stmt|;
name|isc_boolean_t
name|again
init|=
name|ISC_FALSE
decl_stmt|;
name|unsigned
name|int
name|soacount
decl_stmt|;
name|unsigned
name|int
name|nscount
decl_stmt|;
name|isc_uint32_t
name|serial
decl_stmt|,
name|refresh
decl_stmt|,
name|retry
decl_stmt|,
name|expire
decl_stmt|,
name|minimum
decl_stmt|;
name|isc_result_t
name|xfrresult
init|=
name|result
decl_stmt|;
name|isc_boolean_t
name|free_needed
decl_stmt|;
name|REQUIRE
argument_list|(
name|DNS_ZONE_VALID
argument_list|(
name|zone
argument_list|)
argument_list|)
expr_stmt|;
name|dns_zone_log
argument_list|(
name|zone
argument_list|,
name|ISC_LOG_DEBUG
argument_list|(
literal|1
argument_list|)
argument_list|,
literal|"zone transfer finished: %s"
argument_list|,
name|dns_result_totext
argument_list|(
name|result
argument_list|)
argument_list|)
expr_stmt|;
name|LOCK_ZONE
argument_list|(
name|zone
argument_list|)
expr_stmt|;
name|INSIST
argument_list|(
operator|(
name|zone
operator|->
name|flags
operator|&
name|DNS_ZONEFLG_REFRESH
operator|)
operator|!=
literal|0
argument_list|)
expr_stmt|;
name|DNS_ZONE_CLRFLAG
argument_list|(
name|zone
argument_list|,
name|DNS_ZONEFLG_REFRESH
argument_list|)
expr_stmt|;
name|DNS_ZONE_CLRFLAG
argument_list|(
name|zone
argument_list|,
name|DNS_ZONEFLG_SOABEFOREAXFR
argument_list|)
expr_stmt|;
name|TIME_NOW
argument_list|(
operator|&
name|now
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|result
condition|)
block|{
case|case
name|ISC_R_SUCCESS
case|:
name|DNS_ZONE_SETFLAG
argument_list|(
name|zone
argument_list|,
name|DNS_ZONEFLG_NEEDNOTIFY
argument_list|)
expr_stmt|;
comment|/*FALLTHROUGH*/
case|case
name|DNS_R_UPTODATE
case|:
name|DNS_ZONE_CLRFLAG
argument_list|(
name|zone
argument_list|,
name|DNS_ZONEFLG_FORCEXFER
argument_list|)
expr_stmt|;
comment|/* 		 * Has the zone expired underneath us? 		 */
if|if
condition|(
name|zone
operator|->
name|db
operator|==
name|NULL
condition|)
goto|goto
name|same_master
goto|;
comment|/* 		 * Update the zone structure's data from the actual 		 * SOA received. 		 */
name|nscount
operator|=
literal|0
expr_stmt|;
name|soacount
operator|=
literal|0
expr_stmt|;
name|INSIST
argument_list|(
name|zone
operator|->
name|db
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|result
operator|=
name|zone_get_from_db
argument_list|(
name|zone
operator|->
name|db
argument_list|,
operator|&
name|zone
operator|->
name|origin
argument_list|,
operator|&
name|nscount
argument_list|,
operator|&
name|soacount
argument_list|,
operator|&
name|serial
argument_list|,
operator|&
name|refresh
argument_list|,
operator|&
name|retry
argument_list|,
operator|&
name|expire
argument_list|,
operator|&
name|minimum
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|==
name|ISC_R_SUCCESS
condition|)
block|{
if|if
condition|(
name|soacount
operator|!=
literal|1
condition|)
name|dns_zone_log
argument_list|(
name|zone
argument_list|,
name|ISC_LOG_ERROR
argument_list|,
literal|"transferred zone "
literal|"has %d SOA record%s"
argument_list|,
name|soacount
argument_list|,
operator|(
name|soacount
operator|!=
literal|0
operator|)
condition|?
literal|"s"
else|:
literal|""
argument_list|)
expr_stmt|;
if|if
condition|(
name|nscount
operator|==
literal|0
condition|)
block|{
name|dns_zone_log
argument_list|(
name|zone
argument_list|,
name|ISC_LOG_ERROR
argument_list|,
literal|"transferred zone "
literal|"has no NS records"
argument_list|)
expr_stmt|;
if|if
condition|(
name|DNS_ZONE_FLAG
argument_list|(
name|zone
argument_list|,
name|DNS_ZONEFLG_HAVETIMERS
argument_list|)
condition|)
block|{
name|zone
operator|->
name|refresh
operator|=
name|DNS_ZONE_DEFAULTREFRESH
expr_stmt|;
name|zone
operator|->
name|retry
operator|=
name|DNS_ZONE_DEFAULTRETRY
expr_stmt|;
block|}
name|DNS_ZONE_CLRFLAG
argument_list|(
name|zone
argument_list|,
name|DNS_ZONEFLG_HAVETIMERS
argument_list|)
expr_stmt|;
name|zone_unload
argument_list|(
name|zone
argument_list|)
expr_stmt|;
goto|goto
name|next_master
goto|;
block|}
name|zone
operator|->
name|serial
operator|=
name|serial
expr_stmt|;
name|zone
operator|->
name|refresh
operator|=
name|RANGE
argument_list|(
name|refresh
argument_list|,
name|zone
operator|->
name|minrefresh
argument_list|,
name|zone
operator|->
name|maxrefresh
argument_list|)
expr_stmt|;
name|zone
operator|->
name|retry
operator|=
name|RANGE
argument_list|(
name|retry
argument_list|,
name|zone
operator|->
name|minretry
argument_list|,
name|zone
operator|->
name|maxretry
argument_list|)
expr_stmt|;
name|zone
operator|->
name|expire
operator|=
name|RANGE
argument_list|(
name|expire
argument_list|,
name|zone
operator|->
name|refresh
operator|+
name|zone
operator|->
name|retry
argument_list|,
name|DNS_MAX_EXPIRE
argument_list|)
expr_stmt|;
name|zone
operator|->
name|minimum
operator|=
name|minimum
expr_stmt|;
name|DNS_ZONE_SETFLAG
argument_list|(
name|zone
argument_list|,
name|DNS_ZONEFLG_HAVETIMERS
argument_list|)
expr_stmt|;
block|}
comment|/* 		 * Set our next update/expire times. 		 */
if|if
condition|(
name|DNS_ZONE_FLAG
argument_list|(
name|zone
argument_list|,
name|DNS_ZONEFLG_NEEDREFRESH
argument_list|)
condition|)
block|{
name|DNS_ZONE_CLRFLAG
argument_list|(
name|zone
argument_list|,
name|DNS_ZONEFLG_NEEDREFRESH
argument_list|)
expr_stmt|;
name|zone
operator|->
name|refreshtime
operator|=
name|now
expr_stmt|;
name|DNS_ZONE_TIME_ADD
argument_list|(
operator|&
name|now
argument_list|,
name|zone
operator|->
name|expire
argument_list|,
operator|&
name|zone
operator|->
name|expiretime
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|DNS_ZONE_JITTER_ADD
argument_list|(
operator|&
name|now
argument_list|,
name|zone
operator|->
name|refresh
argument_list|,
operator|&
name|zone
operator|->
name|refreshtime
argument_list|)
expr_stmt|;
name|DNS_ZONE_TIME_ADD
argument_list|(
operator|&
name|now
argument_list|,
name|zone
operator|->
name|expire
argument_list|,
operator|&
name|zone
operator|->
name|expiretime
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|result
operator|==
name|ISC_R_SUCCESS
operator|&&
name|xfrresult
operator|==
name|ISC_R_SUCCESS
condition|)
block|{
name|char
name|buf
index|[
name|DNS_NAME_FORMATSIZE
operator|+
sizeof|sizeof
argument_list|(
literal|": TSIG ''"
argument_list|)
index|]
decl_stmt|;
if|if
condition|(
name|zone
operator|->
name|tsigkey
operator|!=
name|NULL
condition|)
block|{
name|char
name|namebuf
index|[
name|DNS_NAME_FORMATSIZE
index|]
decl_stmt|;
name|dns_name_format
argument_list|(
operator|&
name|zone
operator|->
name|tsigkey
operator|->
name|name
argument_list|,
name|namebuf
argument_list|,
sizeof|sizeof
argument_list|(
name|namebuf
argument_list|)
argument_list|)
expr_stmt|;
name|snprintf
argument_list|(
name|buf
argument_list|,
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
argument_list|,
literal|": TSIG '%s'"
argument_list|,
name|namebuf
argument_list|)
expr_stmt|;
block|}
else|else
name|buf
index|[
literal|0
index|]
operator|=
literal|'\0'
expr_stmt|;
name|dns_zone_log
argument_list|(
name|zone
argument_list|,
name|ISC_LOG_INFO
argument_list|,
literal|"transferred serial %u%s"
argument_list|,
name|zone
operator|->
name|serial
argument_list|,
name|buf
argument_list|)
expr_stmt|;
block|}
comment|/* 		 * This is not neccessary if we just performed a AXFR 		 * however it is necessary for an IXFR / UPTODATE and 		 * won't hurt with an AXFR. 		 */
if|if
condition|(
name|zone
operator|->
name|masterfile
operator|!=
name|NULL
operator|||
name|zone
operator|->
name|journal
operator|!=
name|NULL
condition|)
block|{
name|result
operator|=
name|ISC_R_FAILURE
expr_stmt|;
if|if
condition|(
name|zone
operator|->
name|journal
operator|!=
name|NULL
condition|)
name|result
operator|=
name|isc_file_settime
argument_list|(
name|zone
operator|->
name|journal
argument_list|,
operator|&
name|now
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
operator|&&
name|zone
operator|->
name|masterfile
operator|!=
name|NULL
condition|)
name|result
operator|=
name|isc_file_settime
argument_list|(
name|zone
operator|->
name|masterfile
argument_list|,
operator|&
name|now
argument_list|)
expr_stmt|;
comment|/* Someone removed the file from underneath us! */
if|if
condition|(
name|result
operator|==
name|ISC_R_FILENOTFOUND
operator|&&
name|zone
operator|->
name|masterfile
operator|!=
name|NULL
condition|)
name|zone_needdump
argument_list|(
name|zone
argument_list|,
name|DNS_DUMP_DELAY
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
name|dns_zone_log
argument_list|(
name|zone
argument_list|,
name|ISC_LOG_ERROR
argument_list|,
literal|"transfer: could not set file "
literal|"modification time of '%s': %s"
argument_list|,
name|zone
operator|->
name|masterfile
argument_list|,
name|dns_result_totext
argument_list|(
name|result
argument_list|)
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
name|DNS_R_BADIXFR
case|:
comment|/* Force retry with AXFR. */
name|DNS_ZONE_SETFLAG
argument_list|(
name|zone
argument_list|,
name|DNS_ZONEFLAG_NOIXFR
argument_list|)
expr_stmt|;
goto|goto
name|same_master
goto|;
default|default:
name|next_master
label|:
comment|/* 		 * Skip to next failed / untried master. 		 */
do|do
block|{
name|zone
operator|->
name|curmaster
operator|++
expr_stmt|;
block|}
do|while
condition|(
name|zone
operator|->
name|curmaster
operator|<
name|zone
operator|->
name|masterscnt
operator|&&
name|zone
operator|->
name|mastersok
index|[
name|zone
operator|->
name|curmaster
index|]
condition|)
do|;
comment|/* FALLTHROUGH */
name|same_master
label|:
if|if
condition|(
name|zone
operator|->
name|curmaster
operator|>=
name|zone
operator|->
name|masterscnt
condition|)
block|{
name|zone
operator|->
name|curmaster
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|DNS_ZONE_OPTION
argument_list|(
name|zone
argument_list|,
name|DNS_ZONEOPT_USEALTXFRSRC
argument_list|)
operator|&&
operator|!
name|DNS_ZONE_FLAG
argument_list|(
name|zone
argument_list|,
name|DNS_ZONEFLG_USEALTXFRSRC
argument_list|)
condition|)
block|{
name|DNS_ZONE_SETFLAG
argument_list|(
name|zone
argument_list|,
name|DNS_ZONEFLG_REFRESH
argument_list|)
expr_stmt|;
name|DNS_ZONE_SETFLAG
argument_list|(
name|zone
argument_list|,
name|DNS_ZONEFLG_USEALTXFRSRC
argument_list|)
expr_stmt|;
while|while
condition|(
name|zone
operator|->
name|curmaster
operator|<
name|zone
operator|->
name|masterscnt
operator|&&
name|zone
operator|->
name|mastersok
index|[
name|zone
operator|->
name|curmaster
index|]
condition|)
name|zone
operator|->
name|curmaster
operator|++
expr_stmt|;
name|again
operator|=
name|ISC_TRUE
expr_stmt|;
block|}
else|else
name|DNS_ZONE_CLRFLAG
argument_list|(
name|zone
argument_list|,
name|DNS_ZONEFLG_USEALTXFRSRC
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|DNS_ZONE_SETFLAG
argument_list|(
name|zone
argument_list|,
name|DNS_ZONEFLG_REFRESH
argument_list|)
expr_stmt|;
name|again
operator|=
name|ISC_TRUE
expr_stmt|;
block|}
break|break;
block|}
name|zone_settimer
argument_list|(
name|zone
argument_list|,
operator|&
name|now
argument_list|)
expr_stmt|;
comment|/* 	 * If creating the transfer object failed, zone->xfr is NULL. 	 * Otherwise, we are called as the done callback of a zone 	 * transfer object that just entered its shutting-down 	 * state.  Since we are no longer responsible for shutting 	 * it down, we can detach our reference. 	 */
if|if
condition|(
name|zone
operator|->
name|xfr
operator|!=
name|NULL
condition|)
name|dns_xfrin_detach
argument_list|(
operator|&
name|zone
operator|->
name|xfr
argument_list|)
expr_stmt|;
if|if
condition|(
name|zone
operator|->
name|tsigkey
operator|!=
name|NULL
condition|)
name|dns_tsigkey_detach
argument_list|(
operator|&
name|zone
operator|->
name|tsigkey
argument_list|)
expr_stmt|;
comment|/* 	 * Handle any deferred journal compaction. 	 */
if|if
condition|(
name|DNS_ZONE_FLAG
argument_list|(
name|zone
argument_list|,
name|DNS_ZONEFLG_NEEDCOMPACT
argument_list|)
condition|)
block|{
name|result
operator|=
name|dns_journal_compact
argument_list|(
name|zone
operator|->
name|mctx
argument_list|,
name|zone
operator|->
name|journal
argument_list|,
name|zone
operator|->
name|compact_serial
argument_list|,
name|zone
operator|->
name|journalsize
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|result
condition|)
block|{
case|case
name|ISC_R_SUCCESS
case|:
case|case
name|ISC_R_NOSPACE
case|:
case|case
name|ISC_R_NOTFOUND
case|:
name|dns_zone_log
argument_list|(
name|zone
argument_list|,
name|ISC_LOG_DEBUG
argument_list|(
literal|3
argument_list|)
argument_list|,
literal|"dns_journal_compact: %s"
argument_list|,
name|dns_result_totext
argument_list|(
name|result
argument_list|)
argument_list|)
expr_stmt|;
break|break;
default|default:
name|dns_zone_log
argument_list|(
name|zone
argument_list|,
name|ISC_LOG_ERROR
argument_list|,
literal|"dns_journal_compact failed: %s"
argument_list|,
name|dns_result_totext
argument_list|(
name|result
argument_list|)
argument_list|)
expr_stmt|;
break|break;
block|}
name|DNS_ZONE_CLRFLAG
argument_list|(
name|zone
argument_list|,
name|DNS_ZONEFLG_NEEDCOMPACT
argument_list|)
expr_stmt|;
block|}
comment|/* 	 * This transfer finishing freed up a transfer quota slot. 	 * Let any other zones waiting for quota have it. 	 */
name|RWLOCK
argument_list|(
operator|&
name|zone
operator|->
name|zmgr
operator|->
name|rwlock
argument_list|,
name|isc_rwlocktype_write
argument_list|)
expr_stmt|;
name|ISC_LIST_UNLINK
argument_list|(
name|zone
operator|->
name|zmgr
operator|->
name|xfrin_in_progress
argument_list|,
name|zone
argument_list|,
name|statelink
argument_list|)
expr_stmt|;
name|zone
operator|->
name|statelist
operator|=
name|NULL
expr_stmt|;
name|zmgr_resume_xfrs
argument_list|(
name|zone
operator|->
name|zmgr
argument_list|,
name|ISC_FALSE
argument_list|)
expr_stmt|;
name|RWUNLOCK
argument_list|(
operator|&
name|zone
operator|->
name|zmgr
operator|->
name|rwlock
argument_list|,
name|isc_rwlocktype_write
argument_list|)
expr_stmt|;
comment|/* 	 * Retry with a different server if necessary. 	 */
if|if
condition|(
name|again
operator|&&
operator|!
name|DNS_ZONE_FLAG
argument_list|(
name|zone
argument_list|,
name|DNS_ZONEFLG_EXITING
argument_list|)
condition|)
name|queue_soa_query
argument_list|(
name|zone
argument_list|)
expr_stmt|;
name|INSIST
argument_list|(
name|zone
operator|->
name|irefs
operator|>
literal|0
argument_list|)
expr_stmt|;
name|zone
operator|->
name|irefs
operator|--
expr_stmt|;
name|free_needed
operator|=
name|exit_check
argument_list|(
name|zone
argument_list|)
expr_stmt|;
name|UNLOCK_ZONE
argument_list|(
name|zone
argument_list|)
expr_stmt|;
if|if
condition|(
name|free_needed
condition|)
name|zone_free
argument_list|(
name|zone
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|zone_loaddone
parameter_list|(
name|void
modifier|*
name|arg
parameter_list|,
name|isc_result_t
name|result
parameter_list|)
block|{
specifier|static
name|char
name|me
index|[]
init|=
literal|"zone_loaddone"
decl_stmt|;
name|dns_load_t
modifier|*
name|load
init|=
name|arg
decl_stmt|;
name|dns_zone_t
modifier|*
name|zone
decl_stmt|;
name|isc_result_t
name|tresult
decl_stmt|;
name|REQUIRE
argument_list|(
name|DNS_LOAD_VALID
argument_list|(
name|load
argument_list|)
argument_list|)
expr_stmt|;
name|zone
operator|=
name|load
operator|->
name|zone
expr_stmt|;
name|ENTER
expr_stmt|;
name|tresult
operator|=
name|dns_db_endload
argument_list|(
name|load
operator|->
name|db
argument_list|,
operator|&
name|load
operator|->
name|callbacks
operator|.
name|add_private
argument_list|)
expr_stmt|;
if|if
condition|(
name|tresult
operator|!=
name|ISC_R_SUCCESS
operator|&&
operator|(
name|result
operator|==
name|ISC_R_SUCCESS
operator|||
name|result
operator|==
name|DNS_R_SEENINCLUDE
operator|)
condition|)
name|result
operator|=
name|tresult
expr_stmt|;
name|LOCK_ZONE
argument_list|(
name|load
operator|->
name|zone
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|zone_postload
argument_list|(
name|load
operator|->
name|zone
argument_list|,
name|load
operator|->
name|db
argument_list|,
name|load
operator|->
name|loadtime
argument_list|,
name|result
argument_list|)
expr_stmt|;
name|zonemgr_putio
argument_list|(
operator|&
name|load
operator|->
name|zone
operator|->
name|readio
argument_list|)
expr_stmt|;
name|DNS_ZONE_CLRFLAG
argument_list|(
name|load
operator|->
name|zone
argument_list|,
name|DNS_ZONEFLG_LOADING
argument_list|)
expr_stmt|;
name|UNLOCK_ZONE
argument_list|(
name|load
operator|->
name|zone
argument_list|)
expr_stmt|;
name|load
operator|->
name|magic
operator|=
literal|0
expr_stmt|;
name|dns_db_detach
argument_list|(
operator|&
name|load
operator|->
name|db
argument_list|)
expr_stmt|;
if|if
condition|(
name|load
operator|->
name|zone
operator|->
name|lctx
operator|!=
name|NULL
condition|)
name|dns_loadctx_detach
argument_list|(
operator|&
name|load
operator|->
name|zone
operator|->
name|lctx
argument_list|)
expr_stmt|;
name|dns_zone_idetach
argument_list|(
operator|&
name|load
operator|->
name|zone
argument_list|)
expr_stmt|;
name|isc_mem_putanddetach
argument_list|(
operator|&
name|load
operator|->
name|mctx
argument_list|,
name|load
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|load
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|dns_zone_getssutable
parameter_list|(
name|dns_zone_t
modifier|*
name|zone
parameter_list|,
name|dns_ssutable_t
modifier|*
modifier|*
name|table
parameter_list|)
block|{
name|REQUIRE
argument_list|(
name|DNS_ZONE_VALID
argument_list|(
name|zone
argument_list|)
argument_list|)
expr_stmt|;
name|REQUIRE
argument_list|(
name|table
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|REQUIRE
argument_list|(
operator|*
name|table
operator|==
name|NULL
argument_list|)
expr_stmt|;
name|LOCK_ZONE
argument_list|(
name|zone
argument_list|)
expr_stmt|;
if|if
condition|(
name|zone
operator|->
name|ssutable
operator|!=
name|NULL
condition|)
name|dns_ssutable_attach
argument_list|(
name|zone
operator|->
name|ssutable
argument_list|,
name|table
argument_list|)
expr_stmt|;
name|UNLOCK_ZONE
argument_list|(
name|zone
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|dns_zone_setssutable
parameter_list|(
name|dns_zone_t
modifier|*
name|zone
parameter_list|,
name|dns_ssutable_t
modifier|*
name|table
parameter_list|)
block|{
name|REQUIRE
argument_list|(
name|DNS_ZONE_VALID
argument_list|(
name|zone
argument_list|)
argument_list|)
expr_stmt|;
name|LOCK_ZONE
argument_list|(
name|zone
argument_list|)
expr_stmt|;
if|if
condition|(
name|zone
operator|->
name|ssutable
operator|!=
name|NULL
condition|)
name|dns_ssutable_detach
argument_list|(
operator|&
name|zone
operator|->
name|ssutable
argument_list|)
expr_stmt|;
if|if
condition|(
name|table
operator|!=
name|NULL
condition|)
name|dns_ssutable_attach
argument_list|(
name|table
argument_list|,
operator|&
name|zone
operator|->
name|ssutable
argument_list|)
expr_stmt|;
name|UNLOCK_ZONE
argument_list|(
name|zone
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|dns_zone_setsigvalidityinterval
parameter_list|(
name|dns_zone_t
modifier|*
name|zone
parameter_list|,
name|isc_uint32_t
name|interval
parameter_list|)
block|{
name|REQUIRE
argument_list|(
name|DNS_ZONE_VALID
argument_list|(
name|zone
argument_list|)
argument_list|)
expr_stmt|;
name|zone
operator|->
name|sigvalidityinterval
operator|=
name|interval
expr_stmt|;
block|}
end_function

begin_function
name|isc_uint32_t
name|dns_zone_getsigvalidityinterval
parameter_list|(
name|dns_zone_t
modifier|*
name|zone
parameter_list|)
block|{
name|REQUIRE
argument_list|(
name|DNS_ZONE_VALID
argument_list|(
name|zone
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|(
name|zone
operator|->
name|sigvalidityinterval
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|queue_xfrin
parameter_list|(
name|dns_zone_t
modifier|*
name|zone
parameter_list|)
block|{
specifier|const
name|char
name|me
index|[]
init|=
literal|"queue_xfrin"
decl_stmt|;
name|isc_result_t
name|result
decl_stmt|;
name|dns_zonemgr_t
modifier|*
name|zmgr
init|=
name|zone
operator|->
name|zmgr
decl_stmt|;
name|ENTER
expr_stmt|;
name|INSIST
argument_list|(
name|zone
operator|->
name|statelist
operator|==
name|NULL
argument_list|)
expr_stmt|;
name|RWLOCK
argument_list|(
operator|&
name|zmgr
operator|->
name|rwlock
argument_list|,
name|isc_rwlocktype_write
argument_list|)
expr_stmt|;
name|ISC_LIST_APPEND
argument_list|(
name|zmgr
operator|->
name|waiting_for_xfrin
argument_list|,
name|zone
argument_list|,
name|statelink
argument_list|)
expr_stmt|;
name|LOCK_ZONE
argument_list|(
name|zone
argument_list|)
expr_stmt|;
name|zone
operator|->
name|irefs
operator|++
expr_stmt|;
name|UNLOCK_ZONE
argument_list|(
name|zone
argument_list|)
expr_stmt|;
name|zone
operator|->
name|statelist
operator|=
operator|&
name|zmgr
operator|->
name|waiting_for_xfrin
expr_stmt|;
name|result
operator|=
name|zmgr_start_xfrin_ifquota
argument_list|(
name|zmgr
argument_list|,
name|zone
argument_list|)
expr_stmt|;
name|RWUNLOCK
argument_list|(
operator|&
name|zmgr
operator|->
name|rwlock
argument_list|,
name|isc_rwlocktype_write
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|==
name|ISC_R_QUOTA
condition|)
block|{
name|dns_zone_logc
argument_list|(
name|zone
argument_list|,
name|DNS_LOGCATEGORY_XFER_IN
argument_list|,
name|ISC_LOG_INFO
argument_list|,
literal|"zone transfer deferred due to quota"
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
block|{
name|dns_zone_logc
argument_list|(
name|zone
argument_list|,
name|DNS_LOGCATEGORY_XFER_IN
argument_list|,
name|ISC_LOG_ERROR
argument_list|,
literal|"starting zone transfer: %s"
argument_list|,
name|isc_result_totext
argument_list|(
name|result
argument_list|)
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/*  * This event callback is called when a zone has received  * any necessary zone transfer quota.  This is the time  * to go ahead and start the transfer.  */
end_comment

begin_function
specifier|static
name|void
name|got_transfer_quota
parameter_list|(
name|isc_task_t
modifier|*
name|task
parameter_list|,
name|isc_event_t
modifier|*
name|event
parameter_list|)
block|{
name|isc_result_t
name|result
decl_stmt|;
name|dns_peer_t
modifier|*
name|peer
init|=
name|NULL
decl_stmt|;
name|char
name|mastertext
index|[
literal|256
index|]
decl_stmt|;
name|dns_rdatatype_t
name|xfrtype
decl_stmt|;
name|dns_zone_t
modifier|*
name|zone
init|=
name|event
operator|->
name|ev_arg
decl_stmt|;
name|isc_netaddr_t
name|masterip
decl_stmt|;
name|isc_sockaddr_t
name|sourceaddr
decl_stmt|;
name|isc_sockaddr_t
name|masteraddr
decl_stmt|;
name|UNUSED
argument_list|(
name|task
argument_list|)
expr_stmt|;
name|INSIST
argument_list|(
name|task
operator|==
name|zone
operator|->
name|task
argument_list|)
expr_stmt|;
if|if
condition|(
name|DNS_ZONE_FLAG
argument_list|(
name|zone
argument_list|,
name|DNS_ZONEFLG_EXITING
argument_list|)
condition|)
block|{
name|result
operator|=
name|ISC_R_CANCELED
expr_stmt|;
goto|goto
name|cleanup
goto|;
block|}
name|isc_sockaddr_format
argument_list|(
operator|&
name|zone
operator|->
name|masteraddr
argument_list|,
name|mastertext
argument_list|,
sizeof|sizeof
argument_list|(
name|mastertext
argument_list|)
argument_list|)
expr_stmt|;
name|isc_netaddr_fromsockaddr
argument_list|(
operator|&
name|masterip
argument_list|,
operator|&
name|zone
operator|->
name|masteraddr
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|dns_peerlist_peerbyaddr
argument_list|(
name|zone
operator|->
name|view
operator|->
name|peers
argument_list|,
operator|&
name|masterip
argument_list|,
operator|&
name|peer
argument_list|)
expr_stmt|;
comment|/* 	 * Decide whether we should request IXFR or AXFR. 	 */
if|if
condition|(
name|zone
operator|->
name|db
operator|==
name|NULL
condition|)
block|{
name|dns_zone_log
argument_list|(
name|zone
argument_list|,
name|ISC_LOG_DEBUG
argument_list|(
literal|1
argument_list|)
argument_list|,
literal|"no database exists yet, "
literal|"requesting AXFR of "
literal|"initial version from %s"
argument_list|,
name|mastertext
argument_list|)
expr_stmt|;
name|xfrtype
operator|=
name|dns_rdatatype_axfr
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|DNS_ZONE_OPTION
argument_list|(
name|zone
argument_list|,
name|DNS_ZONEOPT_IXFRFROMDIFFS
argument_list|)
condition|)
block|{
name|dns_zone_log
argument_list|(
name|zone
argument_list|,
name|ISC_LOG_DEBUG
argument_list|(
literal|1
argument_list|)
argument_list|,
literal|"ixfr-from-differences "
literal|"set, requesting AXFR from %s"
argument_list|,
name|mastertext
argument_list|)
expr_stmt|;
name|xfrtype
operator|=
name|dns_rdatatype_axfr
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|DNS_ZONE_FLAG
argument_list|(
name|zone
argument_list|,
name|DNS_ZONEFLG_FORCEXFER
argument_list|)
condition|)
block|{
name|dns_zone_log
argument_list|(
name|zone
argument_list|,
name|ISC_LOG_DEBUG
argument_list|(
literal|1
argument_list|)
argument_list|,
literal|"forced reload, requesting AXFR of "
literal|"initial version from %s"
argument_list|,
name|mastertext
argument_list|)
expr_stmt|;
name|xfrtype
operator|=
name|dns_rdatatype_axfr
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|DNS_ZONE_FLAG
argument_list|(
name|zone
argument_list|,
name|DNS_ZONEFLAG_NOIXFR
argument_list|)
condition|)
block|{
name|dns_zone_log
argument_list|(
name|zone
argument_list|,
name|ISC_LOG_DEBUG
argument_list|(
literal|1
argument_list|)
argument_list|,
literal|"retrying with AXFR from %s due to "
literal|"previous IXFR failure"
argument_list|,
name|mastertext
argument_list|)
expr_stmt|;
name|xfrtype
operator|=
name|dns_rdatatype_axfr
expr_stmt|;
name|LOCK_ZONE
argument_list|(
name|zone
argument_list|)
expr_stmt|;
name|DNS_ZONE_CLRFLAG
argument_list|(
name|zone
argument_list|,
name|DNS_ZONEFLAG_NOIXFR
argument_list|)
expr_stmt|;
name|UNLOCK_ZONE
argument_list|(
name|zone
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|isc_boolean_t
name|use_ixfr
init|=
name|ISC_TRUE
decl_stmt|;
if|if
condition|(
name|peer
operator|!=
name|NULL
operator|&&
name|dns_peer_getrequestixfr
argument_list|(
name|peer
argument_list|,
operator|&
name|use_ixfr
argument_list|)
operator|==
name|ISC_R_SUCCESS
condition|)
block|{
empty_stmt|;
comment|/* Using peer setting */
block|}
else|else
block|{
name|use_ixfr
operator|=
name|zone
operator|->
name|view
operator|->
name|requestixfr
expr_stmt|;
block|}
if|if
condition|(
name|use_ixfr
operator|==
name|ISC_FALSE
condition|)
block|{
name|dns_zone_log
argument_list|(
name|zone
argument_list|,
name|ISC_LOG_DEBUG
argument_list|(
literal|1
argument_list|)
argument_list|,
literal|"IXFR disabled, "
literal|"requesting AXFR from %s"
argument_list|,
name|mastertext
argument_list|)
expr_stmt|;
if|if
condition|(
name|DNS_ZONE_FLAG
argument_list|(
name|zone
argument_list|,
name|DNS_ZONEFLG_SOABEFOREAXFR
argument_list|)
condition|)
name|xfrtype
operator|=
name|dns_rdatatype_soa
expr_stmt|;
else|else
name|xfrtype
operator|=
name|dns_rdatatype_axfr
expr_stmt|;
block|}
else|else
block|{
name|dns_zone_log
argument_list|(
name|zone
argument_list|,
name|ISC_LOG_DEBUG
argument_list|(
literal|1
argument_list|)
argument_list|,
literal|"requesting IXFR from %s"
argument_list|,
name|mastertext
argument_list|)
expr_stmt|;
name|xfrtype
operator|=
name|dns_rdatatype_ixfr
expr_stmt|;
block|}
block|}
comment|/* 	 * Determine if we should attempt to sign the request with TSIG. 	 */
name|result
operator|=
name|ISC_R_NOTFOUND
expr_stmt|;
comment|/* 	 * First, look for a tsig key in the master statement, then 	 * try for a server key. 	 */
if|if
condition|(
operator|(
name|zone
operator|->
name|masterkeynames
operator|!=
name|NULL
operator|)
operator|&&
operator|(
name|zone
operator|->
name|masterkeynames
index|[
name|zone
operator|->
name|curmaster
index|]
operator|!=
name|NULL
operator|)
condition|)
block|{
name|dns_view_t
modifier|*
name|view
init|=
name|dns_zone_getview
argument_list|(
name|zone
argument_list|)
decl_stmt|;
name|dns_name_t
modifier|*
name|keyname
init|=
name|zone
operator|->
name|masterkeynames
index|[
name|zone
operator|->
name|curmaster
index|]
decl_stmt|;
name|result
operator|=
name|dns_view_gettsig
argument_list|(
name|view
argument_list|,
name|keyname
argument_list|,
operator|&
name|zone
operator|->
name|tsigkey
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|zone
operator|->
name|tsigkey
operator|==
name|NULL
condition|)
name|result
operator|=
name|dns_view_getpeertsig
argument_list|(
name|zone
operator|->
name|view
argument_list|,
operator|&
name|masterip
argument_list|,
operator|&
name|zone
operator|->
name|tsigkey
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
operator|&&
name|result
operator|!=
name|ISC_R_NOTFOUND
condition|)
block|{
name|dns_zone_log
argument_list|(
name|zone
argument_list|,
name|ISC_LOG_ERROR
argument_list|,
literal|"could not get TSIG key "
literal|"for zone transfer: %s"
argument_list|,
name|isc_result_totext
argument_list|(
name|result
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|LOCK_ZONE
argument_list|(
name|zone
argument_list|)
expr_stmt|;
name|masteraddr
operator|=
name|zone
operator|->
name|masteraddr
expr_stmt|;
name|sourceaddr
operator|=
name|zone
operator|->
name|sourceaddr
expr_stmt|;
name|UNLOCK_ZONE
argument_list|(
name|zone
argument_list|)
expr_stmt|;
name|INSIST
argument_list|(
name|isc_sockaddr_pf
argument_list|(
operator|&
name|masteraddr
argument_list|)
operator|==
name|isc_sockaddr_pf
argument_list|(
operator|&
name|sourceaddr
argument_list|)
argument_list|)
expr_stmt|;
name|result
operator|=
name|dns_xfrin_create2
argument_list|(
name|zone
argument_list|,
name|xfrtype
argument_list|,
operator|&
name|masteraddr
argument_list|,
operator|&
name|sourceaddr
argument_list|,
name|zone
operator|->
name|tsigkey
argument_list|,
name|zone
operator|->
name|mctx
argument_list|,
name|zone
operator|->
name|zmgr
operator|->
name|timermgr
argument_list|,
name|zone
operator|->
name|zmgr
operator|->
name|socketmgr
argument_list|,
name|zone
operator|->
name|task
argument_list|,
name|zone_xfrdone
argument_list|,
operator|&
name|zone
operator|->
name|xfr
argument_list|)
expr_stmt|;
name|cleanup
label|:
comment|/* 	 * Any failure in this function is handled like a failed 	 * zone transfer.  This ensures that we get removed from 	 * zmgr->xfrin_in_progress. 	 */
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
name|zone_xfrdone
argument_list|(
name|zone
argument_list|,
name|result
argument_list|)
expr_stmt|;
name|isc_event_free
argument_list|(
operator|&
name|event
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * Update forwarding support.  */
end_comment

begin_function
specifier|static
name|void
name|forward_destroy
parameter_list|(
name|dns_forward_t
modifier|*
name|forward
parameter_list|)
block|{
name|forward
operator|->
name|magic
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|forward
operator|->
name|request
operator|!=
name|NULL
condition|)
name|dns_request_destroy
argument_list|(
operator|&
name|forward
operator|->
name|request
argument_list|)
expr_stmt|;
if|if
condition|(
name|forward
operator|->
name|msgbuf
operator|!=
name|NULL
condition|)
name|isc_buffer_free
argument_list|(
operator|&
name|forward
operator|->
name|msgbuf
argument_list|)
expr_stmt|;
if|if
condition|(
name|forward
operator|->
name|zone
operator|!=
name|NULL
condition|)
name|dns_zone_idetach
argument_list|(
operator|&
name|forward
operator|->
name|zone
argument_list|)
expr_stmt|;
name|isc_mem_putanddetach
argument_list|(
operator|&
name|forward
operator|->
name|mctx
argument_list|,
name|forward
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|forward
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|isc_result_t
name|sendtomaster
parameter_list|(
name|dns_forward_t
modifier|*
name|forward
parameter_list|)
block|{
name|isc_result_t
name|result
decl_stmt|;
name|isc_sockaddr_t
name|src
decl_stmt|;
name|LOCK_ZONE
argument_list|(
name|forward
operator|->
name|zone
argument_list|)
expr_stmt|;
if|if
condition|(
name|forward
operator|->
name|which
operator|>=
name|forward
operator|->
name|zone
operator|->
name|masterscnt
condition|)
block|{
name|UNLOCK_ZONE
argument_list|(
name|forward
operator|->
name|zone
argument_list|)
expr_stmt|;
return|return
operator|(
name|ISC_R_NOMORE
operator|)
return|;
block|}
name|forward
operator|->
name|addr
operator|=
name|forward
operator|->
name|zone
operator|->
name|masters
index|[
name|forward
operator|->
name|which
index|]
expr_stmt|;
comment|/* 	 * Always use TCP regardless of whether the original update 	 * used TCP. 	 * XXX The timeout may but a bit small if we are far down a 	 * transfer graph and the master has to try several masters. 	 */
switch|switch
condition|(
name|isc_sockaddr_pf
argument_list|(
operator|&
name|forward
operator|->
name|addr
argument_list|)
condition|)
block|{
case|case
name|PF_INET
case|:
name|src
operator|=
name|forward
operator|->
name|zone
operator|->
name|xfrsource4
expr_stmt|;
break|break;
case|case
name|PF_INET6
case|:
name|src
operator|=
name|forward
operator|->
name|zone
operator|->
name|xfrsource6
expr_stmt|;
break|break;
default|default:
name|result
operator|=
name|ISC_R_NOTIMPLEMENTED
expr_stmt|;
goto|goto
name|unlock
goto|;
block|}
name|result
operator|=
name|dns_request_createraw
argument_list|(
name|forward
operator|->
name|zone
operator|->
name|view
operator|->
name|requestmgr
argument_list|,
name|forward
operator|->
name|msgbuf
argument_list|,
operator|&
name|src
argument_list|,
operator|&
name|forward
operator|->
name|addr
argument_list|,
name|DNS_REQUESTOPT_TCP
argument_list|,
literal|15
comment|/* XXX */
argument_list|,
name|forward
operator|->
name|zone
operator|->
name|task
argument_list|,
name|forward_callback
argument_list|,
name|forward
argument_list|,
operator|&
name|forward
operator|->
name|request
argument_list|)
expr_stmt|;
name|unlock
label|:
name|UNLOCK_ZONE
argument_list|(
name|forward
operator|->
name|zone
argument_list|)
expr_stmt|;
return|return
operator|(
name|result
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|forward_callback
parameter_list|(
name|isc_task_t
modifier|*
name|task
parameter_list|,
name|isc_event_t
modifier|*
name|event
parameter_list|)
block|{
specifier|const
name|char
name|me
index|[]
init|=
literal|"forward_callback"
decl_stmt|;
name|dns_requestevent_t
modifier|*
name|revent
init|=
operator|(
name|dns_requestevent_t
operator|*
operator|)
name|event
decl_stmt|;
name|dns_message_t
modifier|*
name|msg
init|=
name|NULL
decl_stmt|;
name|char
name|master
index|[
name|ISC_SOCKADDR_FORMATSIZE
index|]
decl_stmt|;
name|isc_result_t
name|result
decl_stmt|;
name|dns_forward_t
modifier|*
name|forward
decl_stmt|;
name|dns_zone_t
modifier|*
name|zone
decl_stmt|;
name|UNUSED
argument_list|(
name|task
argument_list|)
expr_stmt|;
name|forward
operator|=
name|revent
operator|->
name|ev_arg
expr_stmt|;
name|INSIST
argument_list|(
name|DNS_FORWARD_VALID
argument_list|(
name|forward
argument_list|)
argument_list|)
expr_stmt|;
name|zone
operator|=
name|forward
operator|->
name|zone
expr_stmt|;
name|INSIST
argument_list|(
name|DNS_ZONE_VALID
argument_list|(
name|zone
argument_list|)
argument_list|)
expr_stmt|;
name|ENTER
expr_stmt|;
name|isc_sockaddr_format
argument_list|(
operator|&
name|forward
operator|->
name|addr
argument_list|,
name|master
argument_list|,
sizeof|sizeof
argument_list|(
name|master
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|revent
operator|->
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
block|{
name|dns_zone_log
argument_list|(
name|zone
argument_list|,
name|ISC_LOG_INFO
argument_list|,
literal|"could not forward dynamic update to %s: %s"
argument_list|,
name|master
argument_list|,
name|dns_result_totext
argument_list|(
name|revent
operator|->
name|result
argument_list|)
argument_list|)
expr_stmt|;
goto|goto
name|next_master
goto|;
block|}
name|result
operator|=
name|dns_message_create
argument_list|(
name|zone
operator|->
name|mctx
argument_list|,
name|DNS_MESSAGE_INTENTPARSE
argument_list|,
operator|&
name|msg
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
goto|goto
name|next_master
goto|;
name|result
operator|=
name|dns_request_getresponse
argument_list|(
name|revent
operator|->
name|request
argument_list|,
name|msg
argument_list|,
name|DNS_MESSAGEPARSE_PRESERVEORDER
operator||
name|DNS_MESSAGEPARSE_CLONEBUFFER
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
goto|goto
name|next_master
goto|;
switch|switch
condition|(
name|msg
operator|->
name|rcode
condition|)
block|{
comment|/* 	 * Pass these rcodes back to client. 	 */
case|case
name|dns_rcode_noerror
case|:
case|case
name|dns_rcode_yxdomain
case|:
case|case
name|dns_rcode_yxrrset
case|:
case|case
name|dns_rcode_nxrrset
case|:
case|case
name|dns_rcode_refused
case|:
case|case
name|dns_rcode_nxdomain
case|:
break|break;
comment|/* These should not occur if the masters/zone are valid. */
case|case
name|dns_rcode_notzone
case|:
case|case
name|dns_rcode_notauth
case|:
block|{
name|char
name|rcode
index|[
literal|128
index|]
decl_stmt|;
name|isc_buffer_t
name|rb
decl_stmt|;
name|isc_buffer_init
argument_list|(
operator|&
name|rb
argument_list|,
name|rcode
argument_list|,
sizeof|sizeof
argument_list|(
name|rcode
argument_list|)
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|dns_rcode_totext
argument_list|(
name|msg
operator|->
name|rcode
argument_list|,
operator|&
name|rb
argument_list|)
expr_stmt|;
name|dns_zone_log
argument_list|(
name|zone
argument_list|,
name|ISC_LOG_WARNING
argument_list|,
literal|"forwarding dynamic update: "
literal|"unexpected response: master %s returned: %.*s"
argument_list|,
name|master
argument_list|,
operator|(
name|int
operator|)
name|rb
operator|.
name|used
argument_list|,
name|rcode
argument_list|)
expr_stmt|;
goto|goto
name|next_master
goto|;
block|}
comment|/* Try another server for these rcodes. */
case|case
name|dns_rcode_formerr
case|:
case|case
name|dns_rcode_servfail
case|:
case|case
name|dns_rcode_notimp
case|:
case|case
name|dns_rcode_badvers
case|:
default|default:
goto|goto
name|next_master
goto|;
block|}
comment|/* call callback */
call|(
name|forward
operator|->
name|callback
call|)
argument_list|(
name|forward
operator|->
name|callback_arg
argument_list|,
name|ISC_R_SUCCESS
argument_list|,
name|msg
argument_list|)
expr_stmt|;
name|msg
operator|=
name|NULL
expr_stmt|;
name|dns_request_destroy
argument_list|(
operator|&
name|forward
operator|->
name|request
argument_list|)
expr_stmt|;
name|forward_destroy
argument_list|(
name|forward
argument_list|)
expr_stmt|;
name|isc_event_free
argument_list|(
operator|&
name|event
argument_list|)
expr_stmt|;
return|return;
name|next_master
label|:
if|if
condition|(
name|msg
operator|!=
name|NULL
condition|)
name|dns_message_destroy
argument_list|(
operator|&
name|msg
argument_list|)
expr_stmt|;
name|isc_event_free
argument_list|(
operator|&
name|event
argument_list|)
expr_stmt|;
name|forward
operator|->
name|which
operator|++
expr_stmt|;
name|dns_request_destroy
argument_list|(
operator|&
name|forward
operator|->
name|request
argument_list|)
expr_stmt|;
name|result
operator|=
name|sendtomaster
argument_list|(
name|forward
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
block|{
comment|/* call callback */
name|dns_zone_log
argument_list|(
name|zone
argument_list|,
name|ISC_LOG_DEBUG
argument_list|(
literal|3
argument_list|)
argument_list|,
literal|"exhausted dynamic update forwarder list"
argument_list|)
expr_stmt|;
call|(
name|forward
operator|->
name|callback
call|)
argument_list|(
name|forward
operator|->
name|callback_arg
argument_list|,
name|result
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|forward_destroy
argument_list|(
name|forward
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
name|isc_result_t
name|dns_zone_forwardupdate
parameter_list|(
name|dns_zone_t
modifier|*
name|zone
parameter_list|,
name|dns_message_t
modifier|*
name|msg
parameter_list|,
name|dns_updatecallback_t
name|callback
parameter_list|,
name|void
modifier|*
name|callback_arg
parameter_list|)
block|{
name|dns_forward_t
modifier|*
name|forward
decl_stmt|;
name|isc_result_t
name|result
decl_stmt|;
name|isc_region_t
modifier|*
name|mr
decl_stmt|;
name|REQUIRE
argument_list|(
name|DNS_ZONE_VALID
argument_list|(
name|zone
argument_list|)
argument_list|)
expr_stmt|;
name|REQUIRE
argument_list|(
name|msg
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|REQUIRE
argument_list|(
name|callback
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|forward
operator|=
name|isc_mem_get
argument_list|(
name|zone
operator|->
name|mctx
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|forward
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|forward
operator|==
name|NULL
condition|)
return|return
operator|(
name|ISC_R_NOMEMORY
operator|)
return|;
name|forward
operator|->
name|request
operator|=
name|NULL
expr_stmt|;
name|forward
operator|->
name|zone
operator|=
name|NULL
expr_stmt|;
name|forward
operator|->
name|msgbuf
operator|=
name|NULL
expr_stmt|;
name|forward
operator|->
name|which
operator|=
literal|0
expr_stmt|;
name|forward
operator|->
name|mctx
operator|=
literal|0
expr_stmt|;
name|forward
operator|->
name|callback
operator|=
name|callback
expr_stmt|;
name|forward
operator|->
name|callback_arg
operator|=
name|callback_arg
expr_stmt|;
name|forward
operator|->
name|magic
operator|=
name|FORWARD_MAGIC
expr_stmt|;
name|mr
operator|=
name|dns_message_getrawmessage
argument_list|(
name|msg
argument_list|)
expr_stmt|;
if|if
condition|(
name|mr
operator|==
name|NULL
condition|)
block|{
name|result
operator|=
name|ISC_R_UNEXPECTEDEND
expr_stmt|;
goto|goto
name|cleanup
goto|;
block|}
name|result
operator|=
name|isc_buffer_allocate
argument_list|(
name|zone
operator|->
name|mctx
argument_list|,
operator|&
name|forward
operator|->
name|msgbuf
argument_list|,
name|mr
operator|->
name|length
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
goto|goto
name|cleanup
goto|;
name|result
operator|=
name|isc_buffer_copyregion
argument_list|(
name|forward
operator|->
name|msgbuf
argument_list|,
name|mr
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
goto|goto
name|cleanup
goto|;
name|isc_mem_attach
argument_list|(
name|zone
operator|->
name|mctx
argument_list|,
operator|&
name|forward
operator|->
name|mctx
argument_list|)
expr_stmt|;
name|dns_zone_iattach
argument_list|(
name|zone
argument_list|,
operator|&
name|forward
operator|->
name|zone
argument_list|)
expr_stmt|;
name|result
operator|=
name|sendtomaster
argument_list|(
name|forward
argument_list|)
expr_stmt|;
name|cleanup
label|:
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
block|{
name|forward_destroy
argument_list|(
name|forward
argument_list|)
expr_stmt|;
block|}
return|return
operator|(
name|result
operator|)
return|;
block|}
end_function

begin_function
name|isc_result_t
name|dns_zone_next
parameter_list|(
name|dns_zone_t
modifier|*
name|zone
parameter_list|,
name|dns_zone_t
modifier|*
modifier|*
name|next
parameter_list|)
block|{
name|REQUIRE
argument_list|(
name|DNS_ZONE_VALID
argument_list|(
name|zone
argument_list|)
argument_list|)
expr_stmt|;
name|REQUIRE
argument_list|(
name|next
operator|!=
name|NULL
operator|&&
operator|*
name|next
operator|==
name|NULL
argument_list|)
expr_stmt|;
operator|*
name|next
operator|=
name|ISC_LIST_NEXT
argument_list|(
name|zone
argument_list|,
name|link
argument_list|)
expr_stmt|;
if|if
condition|(
operator|*
name|next
operator|==
name|NULL
condition|)
return|return
operator|(
name|ISC_R_NOMORE
operator|)
return|;
else|else
return|return
operator|(
name|ISC_R_SUCCESS
operator|)
return|;
block|}
end_function

begin_function
name|isc_result_t
name|dns_zone_first
parameter_list|(
name|dns_zonemgr_t
modifier|*
name|zmgr
parameter_list|,
name|dns_zone_t
modifier|*
modifier|*
name|first
parameter_list|)
block|{
name|REQUIRE
argument_list|(
name|DNS_ZONEMGR_VALID
argument_list|(
name|zmgr
argument_list|)
argument_list|)
expr_stmt|;
name|REQUIRE
argument_list|(
name|first
operator|!=
name|NULL
operator|&&
operator|*
name|first
operator|==
name|NULL
argument_list|)
expr_stmt|;
operator|*
name|first
operator|=
name|ISC_LIST_HEAD
argument_list|(
name|zmgr
operator|->
name|zones
argument_list|)
expr_stmt|;
if|if
condition|(
operator|*
name|first
operator|==
name|NULL
condition|)
return|return
operator|(
name|ISC_R_NOMORE
operator|)
return|;
else|else
return|return
operator|(
name|ISC_R_SUCCESS
operator|)
return|;
block|}
end_function

begin_comment
comment|/***  ***	Zone manager.  ***/
end_comment

begin_function
name|isc_result_t
name|dns_zonemgr_create
parameter_list|(
name|isc_mem_t
modifier|*
name|mctx
parameter_list|,
name|isc_taskmgr_t
modifier|*
name|taskmgr
parameter_list|,
name|isc_timermgr_t
modifier|*
name|timermgr
parameter_list|,
name|isc_socketmgr_t
modifier|*
name|socketmgr
parameter_list|,
name|dns_zonemgr_t
modifier|*
modifier|*
name|zmgrp
parameter_list|)
block|{
name|dns_zonemgr_t
modifier|*
name|zmgr
decl_stmt|;
name|isc_result_t
name|result
decl_stmt|;
name|isc_interval_t
name|interval
decl_stmt|;
name|zmgr
operator|=
name|isc_mem_get
argument_list|(
name|mctx
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|zmgr
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|zmgr
operator|==
name|NULL
condition|)
return|return
operator|(
name|ISC_R_NOMEMORY
operator|)
return|;
name|zmgr
operator|->
name|mctx
operator|=
name|NULL
expr_stmt|;
name|zmgr
operator|->
name|refs
operator|=
literal|1
expr_stmt|;
name|isc_mem_attach
argument_list|(
name|mctx
argument_list|,
operator|&
name|zmgr
operator|->
name|mctx
argument_list|)
expr_stmt|;
name|zmgr
operator|->
name|taskmgr
operator|=
name|taskmgr
expr_stmt|;
name|zmgr
operator|->
name|timermgr
operator|=
name|timermgr
expr_stmt|;
name|zmgr
operator|->
name|socketmgr
operator|=
name|socketmgr
expr_stmt|;
name|zmgr
operator|->
name|zonetasks
operator|=
name|NULL
expr_stmt|;
name|zmgr
operator|->
name|task
operator|=
name|NULL
expr_stmt|;
name|zmgr
operator|->
name|rl
operator|=
name|NULL
expr_stmt|;
name|ISC_LIST_INIT
argument_list|(
name|zmgr
operator|->
name|zones
argument_list|)
expr_stmt|;
name|ISC_LIST_INIT
argument_list|(
name|zmgr
operator|->
name|waiting_for_xfrin
argument_list|)
expr_stmt|;
name|ISC_LIST_INIT
argument_list|(
name|zmgr
operator|->
name|xfrin_in_progress
argument_list|)
expr_stmt|;
name|result
operator|=
name|isc_rwlock_init
argument_list|(
operator|&
name|zmgr
operator|->
name|rwlock
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
block|{
name|UNEXPECTED_ERROR
argument_list|(
name|__FILE__
argument_list|,
name|__LINE__
argument_list|,
literal|"isc_rwlock_init() failed: %s"
argument_list|,
name|isc_result_totext
argument_list|(
name|result
argument_list|)
argument_list|)
expr_stmt|;
name|result
operator|=
name|ISC_R_UNEXPECTED
expr_stmt|;
goto|goto
name|free_mem
goto|;
block|}
name|zmgr
operator|->
name|transfersin
operator|=
literal|10
expr_stmt|;
name|zmgr
operator|->
name|transfersperns
operator|=
literal|2
expr_stmt|;
comment|/* Create the zone task pool. */
name|result
operator|=
name|isc_taskpool_create
argument_list|(
name|taskmgr
argument_list|,
name|mctx
argument_list|,
literal|8
comment|/* XXX */
argument_list|,
literal|2
argument_list|,
operator|&
name|zmgr
operator|->
name|zonetasks
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
goto|goto
name|free_rwlock
goto|;
comment|/* Create a single task for queueing of SOA queries. */
name|result
operator|=
name|isc_task_create
argument_list|(
name|taskmgr
argument_list|,
literal|1
argument_list|,
operator|&
name|zmgr
operator|->
name|task
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
goto|goto
name|free_taskpool
goto|;
name|isc_task_setname
argument_list|(
name|zmgr
operator|->
name|task
argument_list|,
literal|"zmgr"
argument_list|,
name|zmgr
argument_list|)
expr_stmt|;
name|result
operator|=
name|isc_ratelimiter_create
argument_list|(
name|mctx
argument_list|,
name|timermgr
argument_list|,
name|zmgr
operator|->
name|task
argument_list|,
operator|&
name|zmgr
operator|->
name|rl
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
goto|goto
name|free_task
goto|;
comment|/* default to 20 refresh queries / notifies per second. */
name|isc_interval_set
argument_list|(
operator|&
name|interval
argument_list|,
literal|0
argument_list|,
literal|1000000000
operator|/
literal|2
argument_list|)
expr_stmt|;
name|result
operator|=
name|isc_ratelimiter_setinterval
argument_list|(
name|zmgr
operator|->
name|rl
argument_list|,
operator|&
name|interval
argument_list|)
expr_stmt|;
name|RUNTIME_CHECK
argument_list|(
name|result
operator|==
name|ISC_R_SUCCESS
argument_list|)
expr_stmt|;
name|isc_ratelimiter_setpertic
argument_list|(
name|zmgr
operator|->
name|rl
argument_list|,
literal|10
argument_list|)
expr_stmt|;
name|zmgr
operator|->
name|iolimit
operator|=
literal|1
expr_stmt|;
name|zmgr
operator|->
name|ioactive
operator|=
literal|0
expr_stmt|;
name|ISC_LIST_INIT
argument_list|(
name|zmgr
operator|->
name|high
argument_list|)
expr_stmt|;
name|ISC_LIST_INIT
argument_list|(
name|zmgr
operator|->
name|low
argument_list|)
expr_stmt|;
name|result
operator|=
name|isc_mutex_init
argument_list|(
operator|&
name|zmgr
operator|->
name|iolock
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
block|{
name|UNEXPECTED_ERROR
argument_list|(
name|__FILE__
argument_list|,
name|__LINE__
argument_list|,
literal|"isc_mutex_init() failed: %s"
argument_list|,
name|isc_result_totext
argument_list|(
name|result
argument_list|)
argument_list|)
expr_stmt|;
goto|goto
name|free_rl
goto|;
block|}
name|zmgr
operator|->
name|magic
operator|=
name|ZONEMGR_MAGIC
expr_stmt|;
operator|*
name|zmgrp
operator|=
name|zmgr
expr_stmt|;
return|return
operator|(
name|ISC_R_SUCCESS
operator|)
return|;
if|#
directive|if
literal|0
block|free_iolock: 	DESTROYLOCK(&zmgr->iolock);
endif|#
directive|endif
name|free_rl
label|:
name|isc_ratelimiter_detach
argument_list|(
operator|&
name|zmgr
operator|->
name|rl
argument_list|)
expr_stmt|;
name|free_task
label|:
name|isc_task_detach
argument_list|(
operator|&
name|zmgr
operator|->
name|task
argument_list|)
expr_stmt|;
name|free_taskpool
label|:
name|isc_taskpool_destroy
argument_list|(
operator|&
name|zmgr
operator|->
name|zonetasks
argument_list|)
expr_stmt|;
name|free_rwlock
label|:
name|isc_rwlock_destroy
argument_list|(
operator|&
name|zmgr
operator|->
name|rwlock
argument_list|)
expr_stmt|;
name|free_mem
label|:
name|isc_mem_put
argument_list|(
name|zmgr
operator|->
name|mctx
argument_list|,
name|zmgr
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|zmgr
argument_list|)
argument_list|)
expr_stmt|;
name|isc_mem_detach
argument_list|(
operator|&
name|mctx
argument_list|)
expr_stmt|;
return|return
operator|(
name|result
operator|)
return|;
block|}
end_function

begin_function
name|isc_result_t
name|dns_zonemgr_managezone
parameter_list|(
name|dns_zonemgr_t
modifier|*
name|zmgr
parameter_list|,
name|dns_zone_t
modifier|*
name|zone
parameter_list|)
block|{
name|isc_result_t
name|result
decl_stmt|;
name|REQUIRE
argument_list|(
name|DNS_ZONE_VALID
argument_list|(
name|zone
argument_list|)
argument_list|)
expr_stmt|;
name|REQUIRE
argument_list|(
name|DNS_ZONEMGR_VALID
argument_list|(
name|zmgr
argument_list|)
argument_list|)
expr_stmt|;
name|RWLOCK
argument_list|(
operator|&
name|zmgr
operator|->
name|rwlock
argument_list|,
name|isc_rwlocktype_write
argument_list|)
expr_stmt|;
name|LOCK_ZONE
argument_list|(
name|zone
argument_list|)
expr_stmt|;
name|REQUIRE
argument_list|(
name|zone
operator|->
name|task
operator|==
name|NULL
argument_list|)
expr_stmt|;
name|REQUIRE
argument_list|(
name|zone
operator|->
name|timer
operator|==
name|NULL
argument_list|)
expr_stmt|;
name|REQUIRE
argument_list|(
name|zone
operator|->
name|zmgr
operator|==
name|NULL
argument_list|)
expr_stmt|;
name|isc_taskpool_gettask
argument_list|(
name|zmgr
operator|->
name|zonetasks
argument_list|,
name|dns_name_hash
argument_list|(
name|dns_zone_getorigin
argument_list|(
name|zone
argument_list|)
argument_list|,
name|ISC_FALSE
argument_list|)
argument_list|,
operator|&
name|zone
operator|->
name|task
argument_list|)
expr_stmt|;
comment|/* 	 * Set the task name.  The tag will arbitrarily point to one 	 * of the zones sharing the task (in practice, the one 	 * to be managed last). 	 */
name|isc_task_setname
argument_list|(
name|zone
operator|->
name|task
argument_list|,
literal|"zone"
argument_list|,
name|zone
argument_list|)
expr_stmt|;
name|result
operator|=
name|isc_timer_create
argument_list|(
name|zmgr
operator|->
name|timermgr
argument_list|,
name|isc_timertype_inactive
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|zone
operator|->
name|task
argument_list|,
name|zone_timer
argument_list|,
name|zone
argument_list|,
operator|&
name|zone
operator|->
name|timer
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
goto|goto
name|cleanup_task
goto|;
comment|/* 	 * The timer "holds" a iref. 	 */
name|zone
operator|->
name|irefs
operator|++
expr_stmt|;
name|INSIST
argument_list|(
name|zone
operator|->
name|irefs
operator|!=
literal|0
argument_list|)
expr_stmt|;
name|ISC_LIST_APPEND
argument_list|(
name|zmgr
operator|->
name|zones
argument_list|,
name|zone
argument_list|,
name|link
argument_list|)
expr_stmt|;
name|zone
operator|->
name|zmgr
operator|=
name|zmgr
expr_stmt|;
name|zmgr
operator|->
name|refs
operator|++
expr_stmt|;
goto|goto
name|unlock
goto|;
name|cleanup_task
label|:
name|isc_task_detach
argument_list|(
operator|&
name|zone
operator|->
name|task
argument_list|)
expr_stmt|;
name|unlock
label|:
name|UNLOCK_ZONE
argument_list|(
name|zone
argument_list|)
expr_stmt|;
name|RWUNLOCK
argument_list|(
operator|&
name|zmgr
operator|->
name|rwlock
argument_list|,
name|isc_rwlocktype_write
argument_list|)
expr_stmt|;
return|return
operator|(
name|result
operator|)
return|;
block|}
end_function

begin_function
name|void
name|dns_zonemgr_releasezone
parameter_list|(
name|dns_zonemgr_t
modifier|*
name|zmgr
parameter_list|,
name|dns_zone_t
modifier|*
name|zone
parameter_list|)
block|{
name|isc_boolean_t
name|free_now
init|=
name|ISC_FALSE
decl_stmt|;
name|REQUIRE
argument_list|(
name|DNS_ZONE_VALID
argument_list|(
name|zone
argument_list|)
argument_list|)
expr_stmt|;
name|REQUIRE
argument_list|(
name|DNS_ZONEMGR_VALID
argument_list|(
name|zmgr
argument_list|)
argument_list|)
expr_stmt|;
name|REQUIRE
argument_list|(
name|zone
operator|->
name|zmgr
operator|==
name|zmgr
argument_list|)
expr_stmt|;
name|RWLOCK
argument_list|(
operator|&
name|zmgr
operator|->
name|rwlock
argument_list|,
name|isc_rwlocktype_write
argument_list|)
expr_stmt|;
name|LOCK_ZONE
argument_list|(
name|zone
argument_list|)
expr_stmt|;
name|ISC_LIST_UNLINK
argument_list|(
name|zmgr
operator|->
name|zones
argument_list|,
name|zone
argument_list|,
name|link
argument_list|)
expr_stmt|;
name|zone
operator|->
name|zmgr
operator|=
name|NULL
expr_stmt|;
name|zmgr
operator|->
name|refs
operator|--
expr_stmt|;
if|if
condition|(
name|zmgr
operator|->
name|refs
operator|==
literal|0
condition|)
name|free_now
operator|=
name|ISC_TRUE
expr_stmt|;
name|UNLOCK_ZONE
argument_list|(
name|zone
argument_list|)
expr_stmt|;
name|RWUNLOCK
argument_list|(
operator|&
name|zmgr
operator|->
name|rwlock
argument_list|,
name|isc_rwlocktype_write
argument_list|)
expr_stmt|;
if|if
condition|(
name|free_now
condition|)
name|zonemgr_free
argument_list|(
name|zmgr
argument_list|)
expr_stmt|;
name|ENSURE
argument_list|(
name|zone
operator|->
name|zmgr
operator|==
name|NULL
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|dns_zonemgr_attach
parameter_list|(
name|dns_zonemgr_t
modifier|*
name|source
parameter_list|,
name|dns_zonemgr_t
modifier|*
modifier|*
name|target
parameter_list|)
block|{
name|REQUIRE
argument_list|(
name|DNS_ZONEMGR_VALID
argument_list|(
name|source
argument_list|)
argument_list|)
expr_stmt|;
name|REQUIRE
argument_list|(
name|target
operator|!=
name|NULL
operator|&&
operator|*
name|target
operator|==
name|NULL
argument_list|)
expr_stmt|;
name|RWLOCK
argument_list|(
operator|&
name|source
operator|->
name|rwlock
argument_list|,
name|isc_rwlocktype_write
argument_list|)
expr_stmt|;
name|REQUIRE
argument_list|(
name|source
operator|->
name|refs
operator|>
literal|0
argument_list|)
expr_stmt|;
name|source
operator|->
name|refs
operator|++
expr_stmt|;
name|INSIST
argument_list|(
name|source
operator|->
name|refs
operator|>
literal|0
argument_list|)
expr_stmt|;
name|RWUNLOCK
argument_list|(
operator|&
name|source
operator|->
name|rwlock
argument_list|,
name|isc_rwlocktype_write
argument_list|)
expr_stmt|;
operator|*
name|target
operator|=
name|source
expr_stmt|;
block|}
end_function

begin_function
name|void
name|dns_zonemgr_detach
parameter_list|(
name|dns_zonemgr_t
modifier|*
modifier|*
name|zmgrp
parameter_list|)
block|{
name|dns_zonemgr_t
modifier|*
name|zmgr
decl_stmt|;
name|isc_boolean_t
name|free_now
init|=
name|ISC_FALSE
decl_stmt|;
name|REQUIRE
argument_list|(
name|zmgrp
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|zmgr
operator|=
operator|*
name|zmgrp
expr_stmt|;
name|REQUIRE
argument_list|(
name|DNS_ZONEMGR_VALID
argument_list|(
name|zmgr
argument_list|)
argument_list|)
expr_stmt|;
name|RWLOCK
argument_list|(
operator|&
name|zmgr
operator|->
name|rwlock
argument_list|,
name|isc_rwlocktype_write
argument_list|)
expr_stmt|;
name|zmgr
operator|->
name|refs
operator|--
expr_stmt|;
if|if
condition|(
name|zmgr
operator|->
name|refs
operator|==
literal|0
condition|)
name|free_now
operator|=
name|ISC_TRUE
expr_stmt|;
name|RWUNLOCK
argument_list|(
operator|&
name|zmgr
operator|->
name|rwlock
argument_list|,
name|isc_rwlocktype_write
argument_list|)
expr_stmt|;
if|if
condition|(
name|free_now
condition|)
name|zonemgr_free
argument_list|(
name|zmgr
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|isc_result_t
name|dns_zonemgr_forcemaint
parameter_list|(
name|dns_zonemgr_t
modifier|*
name|zmgr
parameter_list|)
block|{
name|dns_zone_t
modifier|*
name|p
decl_stmt|;
name|REQUIRE
argument_list|(
name|DNS_ZONEMGR_VALID
argument_list|(
name|zmgr
argument_list|)
argument_list|)
expr_stmt|;
name|RWLOCK
argument_list|(
operator|&
name|zmgr
operator|->
name|rwlock
argument_list|,
name|isc_rwlocktype_read
argument_list|)
expr_stmt|;
for|for
control|(
name|p
operator|=
name|ISC_LIST_HEAD
argument_list|(
name|zmgr
operator|->
name|zones
argument_list|)
init|;
name|p
operator|!=
name|NULL
condition|;
name|p
operator|=
name|ISC_LIST_NEXT
argument_list|(
name|p
argument_list|,
name|link
argument_list|)
control|)
block|{
name|dns_zone_maintenance
argument_list|(
name|p
argument_list|)
expr_stmt|;
block|}
name|RWUNLOCK
argument_list|(
operator|&
name|zmgr
operator|->
name|rwlock
argument_list|,
name|isc_rwlocktype_read
argument_list|)
expr_stmt|;
comment|/* 	 * Recent configuration changes may have increased the 	 * amount of available transfers quota.  Make sure any 	 * transfers currently blocked on quota get started if 	 * possible. 	 */
name|RWLOCK
argument_list|(
operator|&
name|zmgr
operator|->
name|rwlock
argument_list|,
name|isc_rwlocktype_write
argument_list|)
expr_stmt|;
name|zmgr_resume_xfrs
argument_list|(
name|zmgr
argument_list|,
name|ISC_TRUE
argument_list|)
expr_stmt|;
name|RWUNLOCK
argument_list|(
operator|&
name|zmgr
operator|->
name|rwlock
argument_list|,
name|isc_rwlocktype_write
argument_list|)
expr_stmt|;
return|return
operator|(
name|ISC_R_SUCCESS
operator|)
return|;
block|}
end_function

begin_function
name|void
name|dns_zonemgr_resumexfrs
parameter_list|(
name|dns_zonemgr_t
modifier|*
name|zmgr
parameter_list|)
block|{
name|REQUIRE
argument_list|(
name|DNS_ZONEMGR_VALID
argument_list|(
name|zmgr
argument_list|)
argument_list|)
expr_stmt|;
name|RWLOCK
argument_list|(
operator|&
name|zmgr
operator|->
name|rwlock
argument_list|,
name|isc_rwlocktype_write
argument_list|)
expr_stmt|;
name|zmgr_resume_xfrs
argument_list|(
name|zmgr
argument_list|,
name|ISC_TRUE
argument_list|)
expr_stmt|;
name|RWUNLOCK
argument_list|(
operator|&
name|zmgr
operator|->
name|rwlock
argument_list|,
name|isc_rwlocktype_write
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|dns_zonemgr_shutdown
parameter_list|(
name|dns_zonemgr_t
modifier|*
name|zmgr
parameter_list|)
block|{
name|REQUIRE
argument_list|(
name|DNS_ZONEMGR_VALID
argument_list|(
name|zmgr
argument_list|)
argument_list|)
expr_stmt|;
name|isc_ratelimiter_shutdown
argument_list|(
name|zmgr
operator|->
name|rl
argument_list|)
expr_stmt|;
if|if
condition|(
name|zmgr
operator|->
name|task
operator|!=
name|NULL
condition|)
name|isc_task_destroy
argument_list|(
operator|&
name|zmgr
operator|->
name|task
argument_list|)
expr_stmt|;
if|if
condition|(
name|zmgr
operator|->
name|zonetasks
operator|!=
name|NULL
condition|)
name|isc_taskpool_destroy
argument_list|(
operator|&
name|zmgr
operator|->
name|zonetasks
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|zonemgr_free
parameter_list|(
name|dns_zonemgr_t
modifier|*
name|zmgr
parameter_list|)
block|{
name|isc_mem_t
modifier|*
name|mctx
decl_stmt|;
name|INSIST
argument_list|(
name|zmgr
operator|->
name|refs
operator|==
literal|0
argument_list|)
expr_stmt|;
name|INSIST
argument_list|(
name|ISC_LIST_EMPTY
argument_list|(
name|zmgr
operator|->
name|zones
argument_list|)
argument_list|)
expr_stmt|;
name|zmgr
operator|->
name|magic
operator|=
literal|0
expr_stmt|;
name|DESTROYLOCK
argument_list|(
operator|&
name|zmgr
operator|->
name|iolock
argument_list|)
expr_stmt|;
name|isc_ratelimiter_detach
argument_list|(
operator|&
name|zmgr
operator|->
name|rl
argument_list|)
expr_stmt|;
name|isc_rwlock_destroy
argument_list|(
operator|&
name|zmgr
operator|->
name|rwlock
argument_list|)
expr_stmt|;
name|mctx
operator|=
name|zmgr
operator|->
name|mctx
expr_stmt|;
name|isc_mem_put
argument_list|(
name|zmgr
operator|->
name|mctx
argument_list|,
name|zmgr
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|zmgr
argument_list|)
argument_list|)
expr_stmt|;
name|isc_mem_detach
argument_list|(
operator|&
name|mctx
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|dns_zonemgr_settransfersin
parameter_list|(
name|dns_zonemgr_t
modifier|*
name|zmgr
parameter_list|,
name|isc_uint32_t
name|value
parameter_list|)
block|{
name|REQUIRE
argument_list|(
name|DNS_ZONEMGR_VALID
argument_list|(
name|zmgr
argument_list|)
argument_list|)
expr_stmt|;
name|zmgr
operator|->
name|transfersin
operator|=
name|value
expr_stmt|;
block|}
end_function

begin_function
name|isc_uint32_t
name|dns_zonemgr_getttransfersin
parameter_list|(
name|dns_zonemgr_t
modifier|*
name|zmgr
parameter_list|)
block|{
name|REQUIRE
argument_list|(
name|DNS_ZONEMGR_VALID
argument_list|(
name|zmgr
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|(
name|zmgr
operator|->
name|transfersin
operator|)
return|;
block|}
end_function

begin_function
name|void
name|dns_zonemgr_settransfersperns
parameter_list|(
name|dns_zonemgr_t
modifier|*
name|zmgr
parameter_list|,
name|isc_uint32_t
name|value
parameter_list|)
block|{
name|REQUIRE
argument_list|(
name|DNS_ZONEMGR_VALID
argument_list|(
name|zmgr
argument_list|)
argument_list|)
expr_stmt|;
name|zmgr
operator|->
name|transfersperns
operator|=
name|value
expr_stmt|;
block|}
end_function

begin_function
name|isc_uint32_t
name|dns_zonemgr_getttransfersperns
parameter_list|(
name|dns_zonemgr_t
modifier|*
name|zmgr
parameter_list|)
block|{
name|REQUIRE
argument_list|(
name|DNS_ZONEMGR_VALID
argument_list|(
name|zmgr
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|(
name|zmgr
operator|->
name|transfersperns
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Try to start a new incoming zone transfer to fill a quota  * slot that was just vacated.  *  * Requires:  *	The zone manager is locked by the caller.  */
end_comment

begin_function
specifier|static
name|void
name|zmgr_resume_xfrs
parameter_list|(
name|dns_zonemgr_t
modifier|*
name|zmgr
parameter_list|,
name|isc_boolean_t
name|multi
parameter_list|)
block|{
name|dns_zone_t
modifier|*
name|zone
decl_stmt|;
name|dns_zone_t
modifier|*
name|next
decl_stmt|;
for|for
control|(
name|zone
operator|=
name|ISC_LIST_HEAD
argument_list|(
name|zmgr
operator|->
name|waiting_for_xfrin
argument_list|)
init|;
name|zone
operator|!=
name|NULL
condition|;
name|zone
operator|=
name|next
control|)
block|{
name|isc_result_t
name|result
decl_stmt|;
name|next
operator|=
name|ISC_LIST_NEXT
argument_list|(
name|zone
argument_list|,
name|statelink
argument_list|)
expr_stmt|;
name|result
operator|=
name|zmgr_start_xfrin_ifquota
argument_list|(
name|zmgr
argument_list|,
name|zone
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|==
name|ISC_R_SUCCESS
condition|)
block|{
if|if
condition|(
name|multi
condition|)
continue|continue;
comment|/* 			 * We successfully filled the slot.  We're done. 			 */
break|break;
block|}
elseif|else
if|if
condition|(
name|result
operator|==
name|ISC_R_QUOTA
condition|)
block|{
comment|/* 			 * Not enough quota.  This is probably the per-server 			 * quota, because we usually get called when a unit of 			 * global quota has just been freed.  Try the next 			 * zone, it may succeed if it uses another master. 			 */
continue|continue;
block|}
else|else
block|{
name|dns_zone_log
argument_list|(
name|zone
argument_list|,
name|ISC_LOG_DEBUG
argument_list|(
literal|1
argument_list|)
argument_list|,
literal|"starting zone transfer: %s"
argument_list|,
name|isc_result_totext
argument_list|(
name|result
argument_list|)
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
block|}
end_function

begin_comment
comment|/*  * Try to start an incoming zone transfer for 'zone', quota permitting.  *  * Requires:  *	The zone manager is locked by the caller.  *  * Returns:  *	ISC_R_SUCCESS	There was enough quota and we attempted to  *			start a transfer.  zone_xfrdone() has been or will  *			be called.  *	ISC_R_QUOTA	Not enough quota.  *	Others		Failure.  */
end_comment

begin_function
specifier|static
name|isc_result_t
name|zmgr_start_xfrin_ifquota
parameter_list|(
name|dns_zonemgr_t
modifier|*
name|zmgr
parameter_list|,
name|dns_zone_t
modifier|*
name|zone
parameter_list|)
block|{
name|dns_peer_t
modifier|*
name|peer
init|=
name|NULL
decl_stmt|;
name|isc_netaddr_t
name|masterip
decl_stmt|;
name|isc_uint32_t
name|nxfrsin
decl_stmt|,
name|nxfrsperns
decl_stmt|;
name|dns_zone_t
modifier|*
name|x
decl_stmt|;
name|isc_uint32_t
name|maxtransfersin
decl_stmt|,
name|maxtransfersperns
decl_stmt|;
name|isc_event_t
modifier|*
name|e
decl_stmt|;
comment|/* 	 * Find any configured information about the server we'd 	 * like to transfer this zone from. 	 */
name|isc_netaddr_fromsockaddr
argument_list|(
operator|&
name|masterip
argument_list|,
operator|&
name|zone
operator|->
name|masteraddr
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|dns_peerlist_peerbyaddr
argument_list|(
name|zone
operator|->
name|view
operator|->
name|peers
argument_list|,
operator|&
name|masterip
argument_list|,
operator|&
name|peer
argument_list|)
expr_stmt|;
comment|/* 	 * Determine the total maximum number of simultaneous 	 * transfers allowed, and the maximum for this specific 	 * master. 	 */
name|maxtransfersin
operator|=
name|zmgr
operator|->
name|transfersin
expr_stmt|;
name|maxtransfersperns
operator|=
name|zmgr
operator|->
name|transfersperns
expr_stmt|;
if|if
condition|(
name|peer
operator|!=
name|NULL
condition|)
operator|(
name|void
operator|)
name|dns_peer_gettransfers
argument_list|(
name|peer
argument_list|,
operator|&
name|maxtransfersperns
argument_list|)
expr_stmt|;
comment|/* 	 * Count the total number of transfers that are in progress, 	 * and the number of transfers in progress from this master. 	 * We linearly scan a list of all transfers; if this turns 	 * out to be too slow, we could hash on the master address. 	 */
name|nxfrsin
operator|=
name|nxfrsperns
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|x
operator|=
name|ISC_LIST_HEAD
argument_list|(
name|zmgr
operator|->
name|xfrin_in_progress
argument_list|)
init|;
name|x
operator|!=
name|NULL
condition|;
name|x
operator|=
name|ISC_LIST_NEXT
argument_list|(
name|x
argument_list|,
name|statelink
argument_list|)
control|)
block|{
name|isc_netaddr_t
name|xip
decl_stmt|;
name|isc_netaddr_fromsockaddr
argument_list|(
operator|&
name|xip
argument_list|,
operator|&
name|x
operator|->
name|masteraddr
argument_list|)
expr_stmt|;
name|nxfrsin
operator|++
expr_stmt|;
if|if
condition|(
name|isc_netaddr_equal
argument_list|(
operator|&
name|xip
argument_list|,
operator|&
name|masterip
argument_list|)
condition|)
name|nxfrsperns
operator|++
expr_stmt|;
block|}
comment|/* Enforce quota. */
if|if
condition|(
name|nxfrsin
operator|>=
name|maxtransfersin
condition|)
return|return
operator|(
name|ISC_R_QUOTA
operator|)
return|;
if|if
condition|(
name|nxfrsperns
operator|>=
name|maxtransfersperns
condition|)
return|return
operator|(
name|ISC_R_QUOTA
operator|)
return|;
comment|/* 	 * We have sufficient quota.  Move the zone to the "xfrin_in_progress" 	 * list and send it an event to let it start the actual transfer in the 	 * context of its own task. 	 */
name|e
operator|=
name|isc_event_allocate
argument_list|(
name|zmgr
operator|->
name|mctx
argument_list|,
name|zmgr
argument_list|,
name|DNS_EVENT_ZONESTARTXFRIN
argument_list|,
name|got_transfer_quota
argument_list|,
name|zone
argument_list|,
sizeof|sizeof
argument_list|(
name|isc_event_t
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|e
operator|==
name|NULL
condition|)
return|return
operator|(
name|ISC_R_NOMEMORY
operator|)
return|;
name|LOCK_ZONE
argument_list|(
name|zone
argument_list|)
expr_stmt|;
name|INSIST
argument_list|(
name|zone
operator|->
name|statelist
operator|==
operator|&
name|zmgr
operator|->
name|waiting_for_xfrin
argument_list|)
expr_stmt|;
name|ISC_LIST_UNLINK
argument_list|(
name|zmgr
operator|->
name|waiting_for_xfrin
argument_list|,
name|zone
argument_list|,
name|statelink
argument_list|)
expr_stmt|;
name|ISC_LIST_APPEND
argument_list|(
name|zmgr
operator|->
name|xfrin_in_progress
argument_list|,
name|zone
argument_list|,
name|statelink
argument_list|)
expr_stmt|;
name|zone
operator|->
name|statelist
operator|=
operator|&
name|zmgr
operator|->
name|xfrin_in_progress
expr_stmt|;
name|isc_task_send
argument_list|(
name|zone
operator|->
name|task
argument_list|,
operator|&
name|e
argument_list|)
expr_stmt|;
name|dns_zone_log
argument_list|(
name|zone
argument_list|,
name|ISC_LOG_INFO
argument_list|,
literal|"Transfer started."
argument_list|)
expr_stmt|;
name|UNLOCK_ZONE
argument_list|(
name|zone
argument_list|)
expr_stmt|;
return|return
operator|(
name|ISC_R_SUCCESS
operator|)
return|;
block|}
end_function

begin_function
name|void
name|dns_zonemgr_setiolimit
parameter_list|(
name|dns_zonemgr_t
modifier|*
name|zmgr
parameter_list|,
name|isc_uint32_t
name|iolimit
parameter_list|)
block|{
name|REQUIRE
argument_list|(
name|DNS_ZONEMGR_VALID
argument_list|(
name|zmgr
argument_list|)
argument_list|)
expr_stmt|;
name|REQUIRE
argument_list|(
name|iolimit
operator|>
literal|0
argument_list|)
expr_stmt|;
name|zmgr
operator|->
name|iolimit
operator|=
name|iolimit
expr_stmt|;
block|}
end_function

begin_function
name|isc_uint32_t
name|dns_zonemgr_getiolimit
parameter_list|(
name|dns_zonemgr_t
modifier|*
name|zmgr
parameter_list|)
block|{
name|REQUIRE
argument_list|(
name|DNS_ZONEMGR_VALID
argument_list|(
name|zmgr
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|(
name|zmgr
operator|->
name|iolimit
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Get permission to request a file handle from the OS.  * An event will be sent to action when one is available.  * There are two queues available (high and low), the high  * queue will be serviced before the low one.  *  * zonemgr_putio() must be called after the event is delivered to  * 'action'.  */
end_comment

begin_function
specifier|static
name|isc_result_t
name|zonemgr_getio
parameter_list|(
name|dns_zonemgr_t
modifier|*
name|zmgr
parameter_list|,
name|isc_boolean_t
name|high
parameter_list|,
name|isc_task_t
modifier|*
name|task
parameter_list|,
name|isc_taskaction_t
name|action
parameter_list|,
name|void
modifier|*
name|arg
parameter_list|,
name|dns_io_t
modifier|*
modifier|*
name|iop
parameter_list|)
block|{
name|dns_io_t
modifier|*
name|io
decl_stmt|;
name|isc_boolean_t
name|queue
decl_stmt|;
name|REQUIRE
argument_list|(
name|DNS_ZONEMGR_VALID
argument_list|(
name|zmgr
argument_list|)
argument_list|)
expr_stmt|;
name|REQUIRE
argument_list|(
name|iop
operator|!=
name|NULL
operator|&&
operator|*
name|iop
operator|==
name|NULL
argument_list|)
expr_stmt|;
name|io
operator|=
name|isc_mem_get
argument_list|(
name|zmgr
operator|->
name|mctx
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|io
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|io
operator|==
name|NULL
condition|)
return|return
operator|(
name|ISC_R_NOMEMORY
operator|)
return|;
name|io
operator|->
name|event
operator|=
name|isc_event_allocate
argument_list|(
name|zmgr
operator|->
name|mctx
argument_list|,
name|task
argument_list|,
name|DNS_EVENT_IOREADY
argument_list|,
name|action
argument_list|,
name|arg
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|io
operator|->
name|event
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|io
operator|->
name|event
operator|==
name|NULL
condition|)
block|{
name|isc_mem_put
argument_list|(
name|zmgr
operator|->
name|mctx
argument_list|,
name|io
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|io
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|(
name|ISC_R_NOMEMORY
operator|)
return|;
block|}
name|io
operator|->
name|zmgr
operator|=
name|zmgr
expr_stmt|;
name|io
operator|->
name|high
operator|=
name|high
expr_stmt|;
name|io
operator|->
name|task
operator|=
name|NULL
expr_stmt|;
name|isc_task_attach
argument_list|(
name|task
argument_list|,
operator|&
name|io
operator|->
name|task
argument_list|)
expr_stmt|;
name|ISC_LINK_INIT
argument_list|(
name|io
argument_list|,
name|link
argument_list|)
expr_stmt|;
name|io
operator|->
name|magic
operator|=
name|IO_MAGIC
expr_stmt|;
name|LOCK
argument_list|(
operator|&
name|zmgr
operator|->
name|iolock
argument_list|)
expr_stmt|;
name|zmgr
operator|->
name|ioactive
operator|++
expr_stmt|;
name|queue
operator|=
name|ISC_TF
argument_list|(
name|zmgr
operator|->
name|ioactive
operator|>
name|zmgr
operator|->
name|iolimit
argument_list|)
expr_stmt|;
if|if
condition|(
name|queue
condition|)
block|{
if|if
condition|(
name|io
operator|->
name|high
condition|)
name|ISC_LIST_APPEND
argument_list|(
name|zmgr
operator|->
name|high
argument_list|,
name|io
argument_list|,
name|link
argument_list|)
expr_stmt|;
else|else
name|ISC_LIST_APPEND
argument_list|(
name|zmgr
operator|->
name|low
argument_list|,
name|io
argument_list|,
name|link
argument_list|)
expr_stmt|;
block|}
name|UNLOCK
argument_list|(
operator|&
name|zmgr
operator|->
name|iolock
argument_list|)
expr_stmt|;
operator|*
name|iop
operator|=
name|io
expr_stmt|;
if|if
condition|(
operator|!
name|queue
condition|)
block|{
name|isc_task_send
argument_list|(
name|io
operator|->
name|task
argument_list|,
operator|&
name|io
operator|->
name|event
argument_list|)
expr_stmt|;
block|}
return|return
operator|(
name|ISC_R_SUCCESS
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|zonemgr_putio
parameter_list|(
name|dns_io_t
modifier|*
modifier|*
name|iop
parameter_list|)
block|{
name|dns_io_t
modifier|*
name|io
decl_stmt|;
name|dns_io_t
modifier|*
name|next
decl_stmt|;
name|dns_zonemgr_t
modifier|*
name|zmgr
decl_stmt|;
name|REQUIRE
argument_list|(
name|iop
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|io
operator|=
operator|*
name|iop
expr_stmt|;
name|REQUIRE
argument_list|(
name|DNS_IO_VALID
argument_list|(
name|io
argument_list|)
argument_list|)
expr_stmt|;
operator|*
name|iop
operator|=
name|NULL
expr_stmt|;
name|INSIST
argument_list|(
operator|!
name|ISC_LINK_LINKED
argument_list|(
name|io
argument_list|,
name|link
argument_list|)
argument_list|)
expr_stmt|;
name|INSIST
argument_list|(
name|io
operator|->
name|event
operator|==
name|NULL
argument_list|)
expr_stmt|;
name|zmgr
operator|=
name|io
operator|->
name|zmgr
expr_stmt|;
name|isc_task_detach
argument_list|(
operator|&
name|io
operator|->
name|task
argument_list|)
expr_stmt|;
name|io
operator|->
name|magic
operator|=
literal|0
expr_stmt|;
name|isc_mem_put
argument_list|(
name|zmgr
operator|->
name|mctx
argument_list|,
name|io
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|io
argument_list|)
argument_list|)
expr_stmt|;
name|LOCK
argument_list|(
operator|&
name|zmgr
operator|->
name|iolock
argument_list|)
expr_stmt|;
name|INSIST
argument_list|(
name|zmgr
operator|->
name|ioactive
operator|>
literal|0
argument_list|)
expr_stmt|;
name|zmgr
operator|->
name|ioactive
operator|--
expr_stmt|;
name|next
operator|=
name|HEAD
argument_list|(
name|zmgr
operator|->
name|high
argument_list|)
expr_stmt|;
if|if
condition|(
name|next
operator|==
name|NULL
condition|)
name|next
operator|=
name|HEAD
argument_list|(
name|zmgr
operator|->
name|low
argument_list|)
expr_stmt|;
if|if
condition|(
name|next
operator|!=
name|NULL
condition|)
block|{
if|if
condition|(
name|next
operator|->
name|high
condition|)
name|ISC_LIST_UNLINK
argument_list|(
name|zmgr
operator|->
name|high
argument_list|,
name|next
argument_list|,
name|link
argument_list|)
expr_stmt|;
else|else
name|ISC_LIST_UNLINK
argument_list|(
name|zmgr
operator|->
name|low
argument_list|,
name|next
argument_list|,
name|link
argument_list|)
expr_stmt|;
name|INSIST
argument_list|(
name|next
operator|->
name|event
operator|!=
name|NULL
argument_list|)
expr_stmt|;
block|}
name|UNLOCK
argument_list|(
operator|&
name|zmgr
operator|->
name|iolock
argument_list|)
expr_stmt|;
if|if
condition|(
name|next
operator|!=
name|NULL
condition|)
name|isc_task_send
argument_list|(
name|next
operator|->
name|task
argument_list|,
operator|&
name|next
operator|->
name|event
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|zonemgr_cancelio
parameter_list|(
name|dns_io_t
modifier|*
name|io
parameter_list|)
block|{
name|isc_boolean_t
name|send_event
init|=
name|ISC_FALSE
decl_stmt|;
name|REQUIRE
argument_list|(
name|DNS_IO_VALID
argument_list|(
name|io
argument_list|)
argument_list|)
expr_stmt|;
comment|/* 	 * If we are queued to be run then dequeue. 	 */
name|LOCK
argument_list|(
operator|&
name|io
operator|->
name|zmgr
operator|->
name|iolock
argument_list|)
expr_stmt|;
if|if
condition|(
name|ISC_LINK_LINKED
argument_list|(
name|io
argument_list|,
name|link
argument_list|)
condition|)
block|{
if|if
condition|(
name|io
operator|->
name|high
condition|)
name|ISC_LIST_UNLINK
argument_list|(
name|io
operator|->
name|zmgr
operator|->
name|high
argument_list|,
name|io
argument_list|,
name|link
argument_list|)
expr_stmt|;
else|else
name|ISC_LIST_UNLINK
argument_list|(
name|io
operator|->
name|zmgr
operator|->
name|low
argument_list|,
name|io
argument_list|,
name|link
argument_list|)
expr_stmt|;
name|send_event
operator|=
name|ISC_TRUE
expr_stmt|;
name|INSIST
argument_list|(
name|io
operator|->
name|event
operator|!=
name|NULL
argument_list|)
expr_stmt|;
block|}
name|UNLOCK
argument_list|(
operator|&
name|io
operator|->
name|zmgr
operator|->
name|iolock
argument_list|)
expr_stmt|;
if|if
condition|(
name|send_event
condition|)
block|{
name|io
operator|->
name|event
operator|->
name|ev_attributes
operator||=
name|ISC_EVENTATTR_CANCELED
expr_stmt|;
name|isc_task_send
argument_list|(
name|io
operator|->
name|task
argument_list|,
operator|&
name|io
operator|->
name|event
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|zone_saveunique
parameter_list|(
name|dns_zone_t
modifier|*
name|zone
parameter_list|,
specifier|const
name|char
modifier|*
name|path
parameter_list|,
specifier|const
name|char
modifier|*
name|templat
parameter_list|)
block|{
name|char
modifier|*
name|buf
decl_stmt|;
name|int
name|buflen
decl_stmt|;
name|isc_result_t
name|result
decl_stmt|;
name|buflen
operator|=
name|strlen
argument_list|(
name|path
argument_list|)
operator|+
name|strlen
argument_list|(
name|templat
argument_list|)
operator|+
literal|2
expr_stmt|;
name|buf
operator|=
name|isc_mem_get
argument_list|(
name|zone
operator|->
name|mctx
argument_list|,
name|buflen
argument_list|)
expr_stmt|;
if|if
condition|(
name|buf
operator|==
name|NULL
condition|)
return|return;
name|result
operator|=
name|isc_file_template
argument_list|(
name|path
argument_list|,
name|templat
argument_list|,
name|buf
argument_list|,
name|buflen
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
goto|goto
name|cleanup
goto|;
name|result
operator|=
name|isc_file_renameunique
argument_list|(
name|path
argument_list|,
name|buf
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
goto|goto
name|cleanup
goto|;
name|dns_zone_log
argument_list|(
name|zone
argument_list|,
name|ISC_LOG_WARNING
argument_list|,
literal|"saved '%s' as '%s'"
argument_list|,
name|path
argument_list|,
name|buf
argument_list|)
expr_stmt|;
name|cleanup
label|:
name|isc_mem_put
argument_list|(
name|zone
operator|->
name|mctx
argument_list|,
name|buf
argument_list|,
name|buflen
argument_list|)
expr_stmt|;
block|}
end_function

begin_if
if|#
directive|if
literal|0
end_if

begin_comment
comment|/* Hook for ondestroy notifcation from a database. */
end_comment

begin_endif
unit|static void dns_zonemgr_dbdestroyed(isc_task_t *task, isc_event_t *event) { 	dns_db_t *db = event->sender; 	UNUSED(task);  	isc_event_free(&event);  	isc_log_write(dns_lctx, DNS_LOGCATEGORY_GENERAL, 		      DNS_LOGMODULE_ZONE, ISC_LOG_DEBUG(3), 		      "database (%p) destroyed", (void*) db); }
endif|#
directive|endif
end_endif

begin_function
name|void
name|dns_zonemgr_setserialqueryrate
parameter_list|(
name|dns_zonemgr_t
modifier|*
name|zmgr
parameter_list|,
name|unsigned
name|int
name|value
parameter_list|)
block|{
name|isc_interval_t
name|interval
decl_stmt|;
name|isc_uint32_t
name|s
decl_stmt|,
name|ns
decl_stmt|;
name|isc_uint32_t
name|pertic
decl_stmt|;
name|isc_result_t
name|result
decl_stmt|;
name|REQUIRE
argument_list|(
name|DNS_ZONEMGR_VALID
argument_list|(
name|zmgr
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|value
operator|==
literal|0
condition|)
name|value
operator|=
literal|1
expr_stmt|;
if|if
condition|(
name|value
operator|==
literal|1
condition|)
block|{
name|s
operator|=
literal|1
expr_stmt|;
name|ns
operator|=
literal|0
expr_stmt|;
name|pertic
operator|=
literal|1
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|value
operator|<=
literal|10
condition|)
block|{
name|s
operator|=
literal|0
expr_stmt|;
name|ns
operator|=
literal|1000000000
operator|/
name|value
expr_stmt|;
name|pertic
operator|=
literal|1
expr_stmt|;
block|}
else|else
block|{
name|s
operator|=
literal|0
expr_stmt|;
name|ns
operator|=
operator|(
literal|1000000000
operator|/
name|value
operator|)
operator|*
literal|10
expr_stmt|;
name|pertic
operator|=
literal|10
expr_stmt|;
block|}
name|isc_interval_set
argument_list|(
operator|&
name|interval
argument_list|,
name|s
argument_list|,
name|ns
argument_list|)
expr_stmt|;
name|result
operator|=
name|isc_ratelimiter_setinterval
argument_list|(
name|zmgr
operator|->
name|rl
argument_list|,
operator|&
name|interval
argument_list|)
expr_stmt|;
name|RUNTIME_CHECK
argument_list|(
name|result
operator|==
name|ISC_R_SUCCESS
argument_list|)
expr_stmt|;
name|isc_ratelimiter_setpertic
argument_list|(
name|zmgr
operator|->
name|rl
argument_list|,
name|pertic
argument_list|)
expr_stmt|;
name|zmgr
operator|->
name|serialqueryrate
operator|=
name|value
expr_stmt|;
block|}
end_function

begin_function
name|unsigned
name|int
name|dns_zonemgr_getserialqueryrate
parameter_list|(
name|dns_zonemgr_t
modifier|*
name|zmgr
parameter_list|)
block|{
name|REQUIRE
argument_list|(
name|DNS_ZONEMGR_VALID
argument_list|(
name|zmgr
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|(
name|zmgr
operator|->
name|serialqueryrate
operator|)
return|;
block|}
end_function

begin_function
name|void
name|dns_zone_forcereload
parameter_list|(
name|dns_zone_t
modifier|*
name|zone
parameter_list|)
block|{
name|REQUIRE
argument_list|(
name|DNS_ZONE_VALID
argument_list|(
name|zone
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|zone
operator|->
name|type
operator|==
name|dns_zone_master
condition|)
return|return;
name|LOCK_ZONE
argument_list|(
name|zone
argument_list|)
expr_stmt|;
name|DNS_ZONE_SETFLAG
argument_list|(
name|zone
argument_list|,
name|DNS_ZONEFLG_FORCEXFER
argument_list|)
expr_stmt|;
name|UNLOCK_ZONE
argument_list|(
name|zone
argument_list|)
expr_stmt|;
name|dns_zone_refresh
argument_list|(
name|zone
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|isc_boolean_t
name|dns_zone_isforced
parameter_list|(
name|dns_zone_t
modifier|*
name|zone
parameter_list|)
block|{
name|REQUIRE
argument_list|(
name|DNS_ZONE_VALID
argument_list|(
name|zone
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|(
name|DNS_ZONE_FLAG
argument_list|(
name|zone
argument_list|,
name|DNS_ZONEFLG_FORCEXFER
argument_list|)
operator|)
return|;
block|}
end_function

begin_function
name|isc_result_t
name|dns_zone_setstatistics
parameter_list|(
name|dns_zone_t
modifier|*
name|zone
parameter_list|,
name|isc_boolean_t
name|on
parameter_list|)
block|{
name|isc_result_t
name|result
init|=
name|ISC_R_SUCCESS
decl_stmt|;
name|LOCK_ZONE
argument_list|(
name|zone
argument_list|)
expr_stmt|;
if|if
condition|(
name|on
condition|)
block|{
if|if
condition|(
name|zone
operator|->
name|counters
operator|!=
name|NULL
condition|)
goto|goto
name|done
goto|;
name|result
operator|=
name|dns_stats_alloccounters
argument_list|(
name|zone
operator|->
name|mctx
argument_list|,
operator|&
name|zone
operator|->
name|counters
argument_list|)
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|zone
operator|->
name|counters
operator|==
name|NULL
condition|)
goto|goto
name|done
goto|;
name|dns_stats_freecounters
argument_list|(
name|zone
operator|->
name|mctx
argument_list|,
operator|&
name|zone
operator|->
name|counters
argument_list|)
expr_stmt|;
block|}
name|done
label|:
name|UNLOCK_ZONE
argument_list|(
name|zone
argument_list|)
expr_stmt|;
return|return
operator|(
name|result
operator|)
return|;
block|}
end_function

begin_function
name|isc_uint64_t
modifier|*
name|dns_zone_getstatscounters
parameter_list|(
name|dns_zone_t
modifier|*
name|zone
parameter_list|)
block|{
return|return
operator|(
name|zone
operator|->
name|counters
operator|)
return|;
block|}
end_function

begin_function
name|void
name|dns_zone_dialup
parameter_list|(
name|dns_zone_t
modifier|*
name|zone
parameter_list|)
block|{
name|REQUIRE
argument_list|(
name|DNS_ZONE_VALID
argument_list|(
name|zone
argument_list|)
argument_list|)
expr_stmt|;
name|zone_debuglog
argument_list|(
name|zone
argument_list|,
literal|"dns_zone_dialup"
argument_list|,
literal|3
argument_list|,
literal|"notify = %d, refresh = %d"
argument_list|,
name|DNS_ZONE_FLAG
argument_list|(
name|zone
argument_list|,
name|DNS_ZONEFLG_DIALNOTIFY
argument_list|)
argument_list|,
name|DNS_ZONE_FLAG
argument_list|(
name|zone
argument_list|,
name|DNS_ZONEFLG_DIALREFRESH
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|DNS_ZONE_FLAG
argument_list|(
name|zone
argument_list|,
name|DNS_ZONEFLG_DIALNOTIFY
argument_list|)
condition|)
name|dns_zone_notify
argument_list|(
name|zone
argument_list|)
expr_stmt|;
if|if
condition|(
name|zone
operator|->
name|type
operator|!=
name|dns_zone_master
operator|&&
name|DNS_ZONE_FLAG
argument_list|(
name|zone
argument_list|,
name|DNS_ZONEFLG_DIALREFRESH
argument_list|)
condition|)
name|dns_zone_refresh
argument_list|(
name|zone
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|dns_zone_setdialup
parameter_list|(
name|dns_zone_t
modifier|*
name|zone
parameter_list|,
name|dns_dialuptype_t
name|dialup
parameter_list|)
block|{
name|REQUIRE
argument_list|(
name|DNS_ZONE_VALID
argument_list|(
name|zone
argument_list|)
argument_list|)
expr_stmt|;
name|LOCK_ZONE
argument_list|(
name|zone
argument_list|)
expr_stmt|;
name|DNS_ZONE_CLRFLAG
argument_list|(
name|zone
argument_list|,
name|DNS_ZONEFLG_DIALNOTIFY
operator||
name|DNS_ZONEFLG_DIALREFRESH
operator||
name|DNS_ZONEFLG_NOREFRESH
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|dialup
condition|)
block|{
case|case
name|dns_dialuptype_no
case|:
break|break;
case|case
name|dns_dialuptype_yes
case|:
name|DNS_ZONE_SETFLAG
argument_list|(
name|zone
argument_list|,
operator|(
name|DNS_ZONEFLG_DIALNOTIFY
operator||
name|DNS_ZONEFLG_DIALREFRESH
operator||
name|DNS_ZONEFLG_NOREFRESH
operator|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|dns_dialuptype_notify
case|:
name|DNS_ZONE_SETFLAG
argument_list|(
name|zone
argument_list|,
name|DNS_ZONEFLG_DIALNOTIFY
argument_list|)
expr_stmt|;
break|break;
case|case
name|dns_dialuptype_notifypassive
case|:
name|DNS_ZONE_SETFLAG
argument_list|(
name|zone
argument_list|,
name|DNS_ZONEFLG_DIALNOTIFY
argument_list|)
expr_stmt|;
name|DNS_ZONE_SETFLAG
argument_list|(
name|zone
argument_list|,
name|DNS_ZONEFLG_NOREFRESH
argument_list|)
expr_stmt|;
break|break;
case|case
name|dns_dialuptype_refresh
case|:
name|DNS_ZONE_SETFLAG
argument_list|(
name|zone
argument_list|,
name|DNS_ZONEFLG_DIALREFRESH
argument_list|)
expr_stmt|;
name|DNS_ZONE_SETFLAG
argument_list|(
name|zone
argument_list|,
name|DNS_ZONEFLG_NOREFRESH
argument_list|)
expr_stmt|;
break|break;
case|case
name|dns_dialuptype_passive
case|:
name|DNS_ZONE_SETFLAG
argument_list|(
name|zone
argument_list|,
name|DNS_ZONEFLG_NOREFRESH
argument_list|)
expr_stmt|;
break|break;
default|default:
name|INSIST
argument_list|(
literal|0
argument_list|)
expr_stmt|;
block|}
name|UNLOCK_ZONE
argument_list|(
name|zone
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|isc_result_t
name|dns_zone_setkeydirectory
parameter_list|(
name|dns_zone_t
modifier|*
name|zone
parameter_list|,
specifier|const
name|char
modifier|*
name|directory
parameter_list|)
block|{
name|isc_result_t
name|result
init|=
name|ISC_R_SUCCESS
decl_stmt|;
name|REQUIRE
argument_list|(
name|DNS_ZONE_VALID
argument_list|(
name|zone
argument_list|)
argument_list|)
expr_stmt|;
name|LOCK_ZONE
argument_list|(
name|zone
argument_list|)
expr_stmt|;
name|result
operator|=
name|dns_zone_setstring
argument_list|(
name|zone
argument_list|,
operator|&
name|zone
operator|->
name|keydirectory
argument_list|,
name|directory
argument_list|)
expr_stmt|;
name|UNLOCK_ZONE
argument_list|(
name|zone
argument_list|)
expr_stmt|;
return|return
operator|(
name|result
operator|)
return|;
block|}
end_function

begin_function
specifier|const
name|char
modifier|*
name|dns_zone_getkeydirectory
parameter_list|(
name|dns_zone_t
modifier|*
name|zone
parameter_list|)
block|{
name|REQUIRE
argument_list|(
name|DNS_ZONE_VALID
argument_list|(
name|zone
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|(
name|zone
operator|->
name|keydirectory
operator|)
return|;
block|}
end_function

begin_function
name|unsigned
name|int
name|dns_zonemgr_getcount
parameter_list|(
name|dns_zonemgr_t
modifier|*
name|zmgr
parameter_list|,
name|int
name|state
parameter_list|)
block|{
name|dns_zone_t
modifier|*
name|zone
decl_stmt|;
name|unsigned
name|int
name|count
init|=
literal|0
decl_stmt|;
name|REQUIRE
argument_list|(
name|DNS_ZONEMGR_VALID
argument_list|(
name|zmgr
argument_list|)
argument_list|)
expr_stmt|;
name|RWLOCK
argument_list|(
operator|&
name|zmgr
operator|->
name|rwlock
argument_list|,
name|isc_rwlocktype_read
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|state
condition|)
block|{
case|case
name|DNS_ZONESTATE_XFERRUNNING
case|:
for|for
control|(
name|zone
operator|=
name|ISC_LIST_HEAD
argument_list|(
name|zmgr
operator|->
name|xfrin_in_progress
argument_list|)
init|;
name|zone
operator|!=
name|NULL
condition|;
name|zone
operator|=
name|ISC_LIST_NEXT
argument_list|(
name|zone
argument_list|,
name|statelink
argument_list|)
control|)
name|count
operator|++
expr_stmt|;
break|break;
case|case
name|DNS_ZONESTATE_XFERDEFERRED
case|:
for|for
control|(
name|zone
operator|=
name|ISC_LIST_HEAD
argument_list|(
name|zmgr
operator|->
name|waiting_for_xfrin
argument_list|)
init|;
name|zone
operator|!=
name|NULL
condition|;
name|zone
operator|=
name|ISC_LIST_NEXT
argument_list|(
name|zone
argument_list|,
name|statelink
argument_list|)
control|)
name|count
operator|++
expr_stmt|;
break|break;
case|case
name|DNS_ZONESTATE_SOAQUERY
case|:
for|for
control|(
name|zone
operator|=
name|ISC_LIST_HEAD
argument_list|(
name|zmgr
operator|->
name|zones
argument_list|)
init|;
name|zone
operator|!=
name|NULL
condition|;
name|zone
operator|=
name|ISC_LIST_NEXT
argument_list|(
name|zone
argument_list|,
name|link
argument_list|)
control|)
if|if
condition|(
name|DNS_ZONE_FLAG
argument_list|(
name|zone
argument_list|,
name|DNS_ZONEFLG_REFRESH
argument_list|)
condition|)
name|count
operator|++
expr_stmt|;
break|break;
case|case
name|DNS_ZONESTATE_ANY
case|:
for|for
control|(
name|zone
operator|=
name|ISC_LIST_HEAD
argument_list|(
name|zmgr
operator|->
name|zones
argument_list|)
init|;
name|zone
operator|!=
name|NULL
condition|;
name|zone
operator|=
name|ISC_LIST_NEXT
argument_list|(
name|zone
argument_list|,
name|link
argument_list|)
control|)
block|{
name|dns_view_t
modifier|*
name|view
init|=
name|zone
operator|->
name|view
decl_stmt|;
if|if
condition|(
name|view
operator|!=
name|NULL
operator|&&
name|strcmp
argument_list|(
name|view
operator|->
name|name
argument_list|,
literal|"_bind"
argument_list|)
operator|==
literal|0
condition|)
continue|continue;
name|count
operator|++
expr_stmt|;
block|}
break|break;
default|default:
name|INSIST
argument_list|(
literal|0
argument_list|)
expr_stmt|;
block|}
name|RWUNLOCK
argument_list|(
operator|&
name|zmgr
operator|->
name|rwlock
argument_list|,
name|isc_rwlocktype_read
argument_list|)
expr_stmt|;
return|return
operator|(
name|count
operator|)
return|;
block|}
end_function

begin_function
name|isc_result_t
name|dns_zone_checknames
parameter_list|(
name|dns_zone_t
modifier|*
name|zone
parameter_list|,
name|dns_name_t
modifier|*
name|name
parameter_list|,
name|dns_rdata_t
modifier|*
name|rdata
parameter_list|)
block|{
name|isc_boolean_t
name|ok
init|=
name|ISC_TRUE
decl_stmt|;
name|isc_boolean_t
name|fail
init|=
name|ISC_FALSE
decl_stmt|;
name|char
name|namebuf
index|[
name|DNS_NAME_FORMATSIZE
index|]
decl_stmt|;
name|char
name|namebuf2
index|[
name|DNS_NAME_FORMATSIZE
index|]
decl_stmt|;
name|char
name|typebuf
index|[
name|DNS_RDATATYPE_FORMATSIZE
index|]
decl_stmt|;
name|int
name|level
init|=
name|ISC_LOG_WARNING
decl_stmt|;
name|dns_name_t
name|bad
decl_stmt|;
name|REQUIRE
argument_list|(
name|DNS_ZONE_VALID
argument_list|(
name|zone
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|DNS_ZONE_OPTION
argument_list|(
name|zone
argument_list|,
name|DNS_ZONEOPT_CHECKNAMES
argument_list|)
condition|)
return|return
operator|(
name|ISC_R_SUCCESS
operator|)
return|;
if|if
condition|(
name|DNS_ZONE_OPTION
argument_list|(
name|zone
argument_list|,
name|DNS_ZONEOPT_CHECKNAMESFAIL
argument_list|)
condition|)
block|{
name|level
operator|=
name|ISC_LOG_ERROR
expr_stmt|;
name|fail
operator|=
name|ISC_TRUE
expr_stmt|;
block|}
name|ok
operator|=
name|dns_rdata_checkowner
argument_list|(
name|name
argument_list|,
name|rdata
operator|->
name|rdclass
argument_list|,
name|rdata
operator|->
name|type
argument_list|,
name|ISC_TRUE
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|ok
condition|)
block|{
name|dns_name_format
argument_list|(
name|name
argument_list|,
name|namebuf
argument_list|,
sizeof|sizeof
argument_list|(
name|namebuf
argument_list|)
argument_list|)
expr_stmt|;
name|dns_rdatatype_format
argument_list|(
name|rdata
operator|->
name|type
argument_list|,
name|typebuf
argument_list|,
sizeof|sizeof
argument_list|(
name|typebuf
argument_list|)
argument_list|)
expr_stmt|;
name|dns_zone_log
argument_list|(
name|zone
argument_list|,
name|level
argument_list|,
literal|"%s/%s: %s"
argument_list|,
name|namebuf
argument_list|,
name|typebuf
argument_list|,
name|dns_result_totext
argument_list|(
name|DNS_R_BADOWNERNAME
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|fail
condition|)
return|return
operator|(
name|DNS_R_BADOWNERNAME
operator|)
return|;
block|}
name|dns_name_init
argument_list|(
operator|&
name|bad
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|ok
operator|=
name|dns_rdata_checknames
argument_list|(
name|rdata
argument_list|,
name|name
argument_list|,
operator|&
name|bad
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|ok
condition|)
block|{
name|dns_name_format
argument_list|(
name|name
argument_list|,
name|namebuf
argument_list|,
sizeof|sizeof
argument_list|(
name|namebuf
argument_list|)
argument_list|)
expr_stmt|;
name|dns_name_format
argument_list|(
operator|&
name|bad
argument_list|,
name|namebuf2
argument_list|,
sizeof|sizeof
argument_list|(
name|namebuf2
argument_list|)
argument_list|)
expr_stmt|;
name|dns_rdatatype_format
argument_list|(
name|rdata
operator|->
name|type
argument_list|,
name|typebuf
argument_list|,
sizeof|sizeof
argument_list|(
name|typebuf
argument_list|)
argument_list|)
expr_stmt|;
name|dns_zone_log
argument_list|(
name|zone
argument_list|,
name|level
argument_list|,
literal|"%s/%s: %s: %s "
argument_list|,
name|namebuf
argument_list|,
name|typebuf
argument_list|,
name|namebuf2
argument_list|,
name|dns_result_totext
argument_list|(
name|DNS_R_BADNAME
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|fail
condition|)
return|return
operator|(
name|DNS_R_BADNAME
operator|)
return|;
block|}
return|return
operator|(
name|ISC_R_SUCCESS
operator|)
return|;
block|}
end_function

end_unit


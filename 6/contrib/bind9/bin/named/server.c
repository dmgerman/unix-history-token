begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Copyright (C) 2004-2008  Internet Systems Consortium, Inc. ("ISC")  * Copyright (C) 1999-2003  Internet Software Consortium.  *  * Permission to use, copy, modify, and/or distribute this software for any  * purpose with or without fee is hereby granted, provided that the above  * copyright notice and this permission notice appear in all copies.  *  * THE SOFTWARE IS PROVIDED "AS IS" AND ISC DISCLAIMS ALL WARRANTIES WITH  * REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF MERCHANTABILITY  * AND FITNESS.  IN NO EVENT SHALL ISC BE LIABLE FOR ANY SPECIAL, DIRECT,  * INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM  * LOSS OF USE, DATA OR PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE  * OR OTHER TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR  * PERFORMANCE OF THIS SOFTWARE.  */
end_comment

begin_comment
comment|/* $Id: server.c,v 1.339.2.15.2.78.4.3 2008/07/23 23:47:49 tbox Exp $ */
end_comment

begin_include
include|#
directive|include
file|<config.h>
end_include

begin_include
include|#
directive|include
file|<stdlib.h>
end_include

begin_include
include|#
directive|include
file|<unistd.h>
end_include

begin_include
include|#
directive|include
file|<isc/app.h>
end_include

begin_include
include|#
directive|include
file|<isc/base64.h>
end_include

begin_include
include|#
directive|include
file|<isc/dir.h>
end_include

begin_include
include|#
directive|include
file|<isc/entropy.h>
end_include

begin_include
include|#
directive|include
file|<isc/file.h>
end_include

begin_include
include|#
directive|include
file|<isc/hash.h>
end_include

begin_include
include|#
directive|include
file|<isc/lex.h>
end_include

begin_include
include|#
directive|include
file|<isc/parseint.h>
end_include

begin_include
include|#
directive|include
file|<isc/print.h>
end_include

begin_include
include|#
directive|include
file|<isc/resource.h>
end_include

begin_include
include|#
directive|include
file|<isc/stdio.h>
end_include

begin_include
include|#
directive|include
file|<isc/string.h>
end_include

begin_include
include|#
directive|include
file|<isc/task.h>
end_include

begin_include
include|#
directive|include
file|<isc/timer.h>
end_include

begin_include
include|#
directive|include
file|<isc/util.h>
end_include

begin_include
include|#
directive|include
file|<isccfg/namedconf.h>
end_include

begin_include
include|#
directive|include
file|<bind9/check.h>
end_include

begin_include
include|#
directive|include
file|<dns/adb.h>
end_include

begin_include
include|#
directive|include
file|<dns/cache.h>
end_include

begin_include
include|#
directive|include
file|<dns/db.h>
end_include

begin_include
include|#
directive|include
file|<dns/dispatch.h>
end_include

begin_include
include|#
directive|include
file|<dns/forward.h>
end_include

begin_include
include|#
directive|include
file|<dns/journal.h>
end_include

begin_include
include|#
directive|include
file|<dns/keytable.h>
end_include

begin_include
include|#
directive|include
file|<dns/master.h>
end_include

begin_include
include|#
directive|include
file|<dns/masterdump.h>
end_include

begin_include
include|#
directive|include
file|<dns/order.h>
end_include

begin_include
include|#
directive|include
file|<dns/peer.h>
end_include

begin_include
include|#
directive|include
file|<dns/portlist.h>
end_include

begin_include
include|#
directive|include
file|<dns/rdataclass.h>
end_include

begin_include
include|#
directive|include
file|<dns/rdataset.h>
end_include

begin_include
include|#
directive|include
file|<dns/rdatastruct.h>
end_include

begin_include
include|#
directive|include
file|<dns/resolver.h>
end_include

begin_include
include|#
directive|include
file|<dns/rootns.h>
end_include

begin_include
include|#
directive|include
file|<dns/secalg.h>
end_include

begin_include
include|#
directive|include
file|<dns/stats.h>
end_include

begin_include
include|#
directive|include
file|<dns/tkey.h>
end_include

begin_include
include|#
directive|include
file|<dns/view.h>
end_include

begin_include
include|#
directive|include
file|<dns/zone.h>
end_include

begin_include
include|#
directive|include
file|<dns/zt.h>
end_include

begin_include
include|#
directive|include
file|<dst/dst.h>
end_include

begin_include
include|#
directive|include
file|<dst/result.h>
end_include

begin_include
include|#
directive|include
file|<named/client.h>
end_include

begin_include
include|#
directive|include
file|<named/config.h>
end_include

begin_include
include|#
directive|include
file|<named/control.h>
end_include

begin_include
include|#
directive|include
file|<named/interfacemgr.h>
end_include

begin_include
include|#
directive|include
file|<named/log.h>
end_include

begin_include
include|#
directive|include
file|<named/logconf.h>
end_include

begin_include
include|#
directive|include
file|<named/lwresd.h>
end_include

begin_include
include|#
directive|include
file|<named/main.h>
end_include

begin_include
include|#
directive|include
file|<named/os.h>
end_include

begin_include
include|#
directive|include
file|<named/server.h>
end_include

begin_include
include|#
directive|include
file|<named/tkeyconf.h>
end_include

begin_include
include|#
directive|include
file|<named/tsigconf.h>
end_include

begin_include
include|#
directive|include
file|<named/zoneconf.h>
end_include

begin_ifdef
ifdef|#
directive|ifdef
name|HAVE_LIBSCF
end_ifdef

begin_include
include|#
directive|include
file|<named/ns_smf_globals.h>
end_include

begin_include
include|#
directive|include
file|<stdlib.h>
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/*  * Check an operation for failure.  Assumes that the function  * using it has a 'result' variable and a 'cleanup' label.  */
end_comment

begin_define
define|#
directive|define
name|CHECK
parameter_list|(
name|op
parameter_list|)
define|\
value|do { result = (op); 				  	 \ 	       if (result != ISC_R_SUCCESS) goto cleanup; 	 \ 	} while (0)
end_define

begin_define
define|#
directive|define
name|CHECKM
parameter_list|(
name|op
parameter_list|,
name|msg
parameter_list|)
define|\
value|do { result = (op); 				  	  \ 	       if (result != ISC_R_SUCCESS) {			  \ 			isc_log_write(ns_g_lctx,		  \ 				      NS_LOGCATEGORY_GENERAL,	  \ 				      NS_LOGMODULE_SERVER,	  \ 				      ISC_LOG_ERROR,		  \ 				      "%s: %s", msg,		  \ 				      isc_result_totext(result)); \ 			goto cleanup;				  \ 		}						  \ 	} while (0)						  \  #define CHECKMF(op, msg, file) \ 	do { result = (op); 				  	  \ 	       if (result != ISC_R_SUCCESS) {			  \ 			isc_log_write(ns_g_lctx,		  \ 				      NS_LOGCATEGORY_GENERAL,	  \ 				      NS_LOGMODULE_SERVER,	  \ 				      ISC_LOG_ERROR,		  \ 				      "%s '%s': %s", msg, file,	  \ 				      isc_result_totext(result)); \ 			goto cleanup;				  \ 		}						  \ 	} while (0)						  \  #define CHECKFATAL(op, msg) \ 	do { result = (op); 				  	  \ 	       if (result != ISC_R_SUCCESS)			  \ 			fatal(msg, result);			  \ 	} while (0)						  \  struct ns_dispatch {
end_define

begin_decl_stmt
name|isc_sockaddr_t
name|addr
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|unsigned
name|int
name|dispatchgen
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|dns_dispatch_t
modifier|*
name|dispatch
decl_stmt|;
end_decl_stmt

begin_macro
name|ISC_LINK
argument_list|(
argument|struct ns_dispatch
argument_list|)
end_macro

begin_expr_stmt
name|link
expr_stmt|;
end_expr_stmt

begin_struct
unit|};
struct|struct
name|dumpcontext
block|{
name|isc_mem_t
modifier|*
name|mctx
decl_stmt|;
name|isc_boolean_t
name|dumpcache
decl_stmt|;
name|isc_boolean_t
name|dumpzones
decl_stmt|;
name|FILE
modifier|*
name|fp
decl_stmt|;
name|ISC_LIST
argument_list|(
argument|struct viewlistentry
argument_list|)
name|viewlist
expr_stmt|;
name|struct
name|viewlistentry
modifier|*
name|view
decl_stmt|;
name|struct
name|zonelistentry
modifier|*
name|zone
decl_stmt|;
name|dns_dumpctx_t
modifier|*
name|mdctx
decl_stmt|;
name|dns_db_t
modifier|*
name|db
decl_stmt|;
name|dns_db_t
modifier|*
name|cache
decl_stmt|;
name|isc_task_t
modifier|*
name|task
decl_stmt|;
name|dns_dbversion_t
modifier|*
name|version
decl_stmt|;
block|}
struct|;
end_struct

begin_struct
struct|struct
name|viewlistentry
block|{
name|dns_view_t
modifier|*
name|view
decl_stmt|;
name|ISC_LINK
argument_list|(
argument|struct viewlistentry
argument_list|)
name|link
expr_stmt|;
name|ISC_LIST
argument_list|(
argument|struct zonelistentry
argument_list|)
name|zonelist
expr_stmt|;
block|}
struct|;
end_struct

begin_struct
struct|struct
name|zonelistentry
block|{
name|dns_zone_t
modifier|*
name|zone
decl_stmt|;
name|ISC_LINK
argument_list|(
argument|struct zonelistentry
argument_list|)
name|link
expr_stmt|;
block|}
struct|;
end_struct

begin_function_decl
specifier|static
name|void
name|fatal
parameter_list|(
specifier|const
name|char
modifier|*
name|msg
parameter_list|,
name|isc_result_t
name|result
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|ns_server_reload
parameter_list|(
name|isc_task_t
modifier|*
name|task
parameter_list|,
name|isc_event_t
modifier|*
name|event
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|isc_result_t
name|ns_listenelt_fromconfig
parameter_list|(
specifier|const
name|cfg_obj_t
modifier|*
name|listener
parameter_list|,
specifier|const
name|cfg_obj_t
modifier|*
name|config
parameter_list|,
name|ns_aclconfctx_t
modifier|*
name|actx
parameter_list|,
name|isc_mem_t
modifier|*
name|mctx
parameter_list|,
name|ns_listenelt_t
modifier|*
modifier|*
name|target
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|isc_result_t
name|ns_listenlist_fromconfig
parameter_list|(
specifier|const
name|cfg_obj_t
modifier|*
name|listenlist
parameter_list|,
specifier|const
name|cfg_obj_t
modifier|*
name|config
parameter_list|,
name|ns_aclconfctx_t
modifier|*
name|actx
parameter_list|,
name|isc_mem_t
modifier|*
name|mctx
parameter_list|,
name|ns_listenlist_t
modifier|*
modifier|*
name|target
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|isc_result_t
name|configure_forward
parameter_list|(
specifier|const
name|cfg_obj_t
modifier|*
name|config
parameter_list|,
name|dns_view_t
modifier|*
name|view
parameter_list|,
name|dns_name_t
modifier|*
name|origin
parameter_list|,
specifier|const
name|cfg_obj_t
modifier|*
name|forwarders
parameter_list|,
specifier|const
name|cfg_obj_t
modifier|*
name|forwardtype
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|isc_result_t
name|configure_alternates
parameter_list|(
specifier|const
name|cfg_obj_t
modifier|*
name|config
parameter_list|,
name|dns_view_t
modifier|*
name|view
parameter_list|,
specifier|const
name|cfg_obj_t
modifier|*
name|alternates
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|isc_result_t
name|configure_zone
parameter_list|(
specifier|const
name|cfg_obj_t
modifier|*
name|config
parameter_list|,
specifier|const
name|cfg_obj_t
modifier|*
name|zconfig
parameter_list|,
specifier|const
name|cfg_obj_t
modifier|*
name|vconfig
parameter_list|,
name|isc_mem_t
modifier|*
name|mctx
parameter_list|,
name|dns_view_t
modifier|*
name|view
parameter_list|,
name|ns_aclconfctx_t
modifier|*
name|aclconf
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|end_reserved_dispatches
parameter_list|(
name|ns_server_t
modifier|*
name|server
parameter_list|,
name|isc_boolean_t
name|all
parameter_list|)
function_decl|;
end_function_decl

begin_comment
comment|/*  * Configure a single view ACL at '*aclp'.  Get its configuration by  * calling 'getvcacl' (for per-view configuration) and maybe 'getscacl'  * (for a global default).  */
end_comment

begin_function
specifier|static
name|isc_result_t
name|configure_view_acl
parameter_list|(
specifier|const
name|cfg_obj_t
modifier|*
name|vconfig
parameter_list|,
specifier|const
name|cfg_obj_t
modifier|*
name|config
parameter_list|,
specifier|const
name|char
modifier|*
name|aclname
parameter_list|,
name|ns_aclconfctx_t
modifier|*
name|actx
parameter_list|,
name|isc_mem_t
modifier|*
name|mctx
parameter_list|,
name|dns_acl_t
modifier|*
modifier|*
name|aclp
parameter_list|)
block|{
name|isc_result_t
name|result
decl_stmt|;
specifier|const
name|cfg_obj_t
modifier|*
name|maps
index|[
literal|3
index|]
decl_stmt|;
specifier|const
name|cfg_obj_t
modifier|*
name|aclobj
init|=
name|NULL
decl_stmt|;
name|int
name|i
init|=
literal|0
decl_stmt|;
if|if
condition|(
operator|*
name|aclp
operator|!=
name|NULL
condition|)
name|dns_acl_detach
argument_list|(
name|aclp
argument_list|)
expr_stmt|;
if|if
condition|(
name|vconfig
operator|!=
name|NULL
condition|)
name|maps
index|[
name|i
operator|++
index|]
operator|=
name|cfg_tuple_get
argument_list|(
name|vconfig
argument_list|,
literal|"options"
argument_list|)
expr_stmt|;
if|if
condition|(
name|config
operator|!=
name|NULL
condition|)
block|{
specifier|const
name|cfg_obj_t
modifier|*
name|options
init|=
name|NULL
decl_stmt|;
operator|(
name|void
operator|)
name|cfg_map_get
argument_list|(
name|config
argument_list|,
literal|"options"
argument_list|,
operator|&
name|options
argument_list|)
expr_stmt|;
if|if
condition|(
name|options
operator|!=
name|NULL
condition|)
name|maps
index|[
name|i
operator|++
index|]
operator|=
name|options
expr_stmt|;
block|}
name|maps
index|[
name|i
index|]
operator|=
name|NULL
expr_stmt|;
operator|(
name|void
operator|)
name|ns_config_get
argument_list|(
name|maps
argument_list|,
name|aclname
argument_list|,
operator|&
name|aclobj
argument_list|)
expr_stmt|;
if|if
condition|(
name|aclobj
operator|==
name|NULL
condition|)
comment|/* 		 * No value available.  *aclp == NULL. 		 */
return|return
operator|(
name|ISC_R_SUCCESS
operator|)
return|;
name|result
operator|=
name|ns_acl_fromconfig
argument_list|(
name|aclobj
argument_list|,
name|config
argument_list|,
name|actx
argument_list|,
name|mctx
argument_list|,
name|aclp
argument_list|)
expr_stmt|;
return|return
operator|(
name|result
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|isc_result_t
name|configure_view_dnsseckey
parameter_list|(
specifier|const
name|cfg_obj_t
modifier|*
name|vconfig
parameter_list|,
specifier|const
name|cfg_obj_t
modifier|*
name|key
parameter_list|,
name|dns_keytable_t
modifier|*
name|keytable
parameter_list|,
name|isc_mem_t
modifier|*
name|mctx
parameter_list|)
block|{
name|dns_rdataclass_t
name|viewclass
decl_stmt|;
name|dns_rdata_dnskey_t
name|keystruct
decl_stmt|;
name|isc_uint32_t
name|flags
decl_stmt|,
name|proto
decl_stmt|,
name|alg
decl_stmt|;
specifier|const
name|char
modifier|*
name|keystr
decl_stmt|,
modifier|*
name|keynamestr
decl_stmt|;
name|unsigned
name|char
name|keydata
index|[
literal|4096
index|]
decl_stmt|;
name|isc_buffer_t
name|keydatabuf
decl_stmt|;
name|unsigned
name|char
name|rrdata
index|[
literal|4096
index|]
decl_stmt|;
name|isc_buffer_t
name|rrdatabuf
decl_stmt|;
name|isc_region_t
name|r
decl_stmt|;
name|dns_fixedname_t
name|fkeyname
decl_stmt|;
name|dns_name_t
modifier|*
name|keyname
decl_stmt|;
name|isc_buffer_t
name|namebuf
decl_stmt|;
name|isc_result_t
name|result
decl_stmt|;
name|dst_key_t
modifier|*
name|dstkey
init|=
name|NULL
decl_stmt|;
name|flags
operator|=
name|cfg_obj_asuint32
argument_list|(
name|cfg_tuple_get
argument_list|(
name|key
argument_list|,
literal|"flags"
argument_list|)
argument_list|)
expr_stmt|;
name|proto
operator|=
name|cfg_obj_asuint32
argument_list|(
name|cfg_tuple_get
argument_list|(
name|key
argument_list|,
literal|"protocol"
argument_list|)
argument_list|)
expr_stmt|;
name|alg
operator|=
name|cfg_obj_asuint32
argument_list|(
name|cfg_tuple_get
argument_list|(
name|key
argument_list|,
literal|"algorithm"
argument_list|)
argument_list|)
expr_stmt|;
name|keyname
operator|=
name|dns_fixedname_name
argument_list|(
operator|&
name|fkeyname
argument_list|)
expr_stmt|;
name|keynamestr
operator|=
name|cfg_obj_asstring
argument_list|(
name|cfg_tuple_get
argument_list|(
name|key
argument_list|,
literal|"name"
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|vconfig
operator|==
name|NULL
condition|)
name|viewclass
operator|=
name|dns_rdataclass_in
expr_stmt|;
else|else
block|{
specifier|const
name|cfg_obj_t
modifier|*
name|classobj
init|=
name|cfg_tuple_get
argument_list|(
name|vconfig
argument_list|,
literal|"class"
argument_list|)
decl_stmt|;
name|CHECK
argument_list|(
name|ns_config_getclass
argument_list|(
name|classobj
argument_list|,
name|dns_rdataclass_in
argument_list|,
operator|&
name|viewclass
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|keystruct
operator|.
name|common
operator|.
name|rdclass
operator|=
name|viewclass
expr_stmt|;
name|keystruct
operator|.
name|common
operator|.
name|rdtype
operator|=
name|dns_rdatatype_dnskey
expr_stmt|;
comment|/* 	 * The key data in keystruct is not dynamically allocated. 	 */
name|keystruct
operator|.
name|mctx
operator|=
name|NULL
expr_stmt|;
name|ISC_LINK_INIT
argument_list|(
operator|&
name|keystruct
operator|.
name|common
argument_list|,
name|link
argument_list|)
expr_stmt|;
if|if
condition|(
name|flags
operator|>
literal|0xffff
condition|)
name|CHECKM
argument_list|(
name|ISC_R_RANGE
argument_list|,
literal|"key flags"
argument_list|)
expr_stmt|;
if|if
condition|(
name|proto
operator|>
literal|0xff
condition|)
name|CHECKM
argument_list|(
name|ISC_R_RANGE
argument_list|,
literal|"key protocol"
argument_list|)
expr_stmt|;
if|if
condition|(
name|alg
operator|>
literal|0xff
condition|)
name|CHECKM
argument_list|(
name|ISC_R_RANGE
argument_list|,
literal|"key algorithm"
argument_list|)
expr_stmt|;
name|keystruct
operator|.
name|flags
operator|=
operator|(
name|isc_uint16_t
operator|)
name|flags
expr_stmt|;
name|keystruct
operator|.
name|protocol
operator|=
operator|(
name|isc_uint8_t
operator|)
name|proto
expr_stmt|;
name|keystruct
operator|.
name|algorithm
operator|=
operator|(
name|isc_uint8_t
operator|)
name|alg
expr_stmt|;
name|isc_buffer_init
argument_list|(
operator|&
name|keydatabuf
argument_list|,
name|keydata
argument_list|,
sizeof|sizeof
argument_list|(
name|keydata
argument_list|)
argument_list|)
expr_stmt|;
name|isc_buffer_init
argument_list|(
operator|&
name|rrdatabuf
argument_list|,
name|rrdata
argument_list|,
sizeof|sizeof
argument_list|(
name|rrdata
argument_list|)
argument_list|)
expr_stmt|;
name|keystr
operator|=
name|cfg_obj_asstring
argument_list|(
name|cfg_tuple_get
argument_list|(
name|key
argument_list|,
literal|"key"
argument_list|)
argument_list|)
expr_stmt|;
name|CHECK
argument_list|(
name|isc_base64_decodestring
argument_list|(
name|keystr
argument_list|,
operator|&
name|keydatabuf
argument_list|)
argument_list|)
expr_stmt|;
name|isc_buffer_usedregion
argument_list|(
operator|&
name|keydatabuf
argument_list|,
operator|&
name|r
argument_list|)
expr_stmt|;
name|keystruct
operator|.
name|datalen
operator|=
name|r
operator|.
name|length
expr_stmt|;
name|keystruct
operator|.
name|data
operator|=
name|r
operator|.
name|base
expr_stmt|;
if|if
condition|(
operator|(
name|keystruct
operator|.
name|algorithm
operator|==
name|DST_ALG_RSASHA1
operator|||
name|keystruct
operator|.
name|algorithm
operator|==
name|DST_ALG_RSAMD5
operator|)
operator|&&
name|r
operator|.
name|length
operator|>
literal|1
operator|&&
name|r
operator|.
name|base
index|[
literal|0
index|]
operator|==
literal|1
operator|&&
name|r
operator|.
name|base
index|[
literal|1
index|]
operator|==
literal|3
condition|)
name|cfg_obj_log
argument_list|(
name|key
argument_list|,
name|ns_g_lctx
argument_list|,
name|ISC_LOG_WARNING
argument_list|,
literal|"trusted key '%s' has a weak exponent"
argument_list|,
name|keynamestr
argument_list|)
expr_stmt|;
name|CHECK
argument_list|(
name|dns_rdata_fromstruct
argument_list|(
name|NULL
argument_list|,
name|keystruct
operator|.
name|common
operator|.
name|rdclass
argument_list|,
name|keystruct
operator|.
name|common
operator|.
name|rdtype
argument_list|,
operator|&
name|keystruct
argument_list|,
operator|&
name|rrdatabuf
argument_list|)
argument_list|)
expr_stmt|;
name|dns_fixedname_init
argument_list|(
operator|&
name|fkeyname
argument_list|)
expr_stmt|;
name|isc_buffer_init
argument_list|(
operator|&
name|namebuf
argument_list|,
name|keynamestr
argument_list|,
name|strlen
argument_list|(
name|keynamestr
argument_list|)
argument_list|)
expr_stmt|;
name|isc_buffer_add
argument_list|(
operator|&
name|namebuf
argument_list|,
name|strlen
argument_list|(
name|keynamestr
argument_list|)
argument_list|)
expr_stmt|;
name|CHECK
argument_list|(
name|dns_name_fromtext
argument_list|(
name|keyname
argument_list|,
operator|&
name|namebuf
argument_list|,
name|dns_rootname
argument_list|,
name|ISC_FALSE
argument_list|,
name|NULL
argument_list|)
argument_list|)
expr_stmt|;
name|CHECK
argument_list|(
name|dst_key_fromdns
argument_list|(
name|keyname
argument_list|,
name|viewclass
argument_list|,
operator|&
name|rrdatabuf
argument_list|,
name|mctx
argument_list|,
operator|&
name|dstkey
argument_list|)
argument_list|)
expr_stmt|;
name|CHECK
argument_list|(
name|dns_keytable_add
argument_list|(
name|keytable
argument_list|,
operator|&
name|dstkey
argument_list|)
argument_list|)
expr_stmt|;
name|INSIST
argument_list|(
name|dstkey
operator|==
name|NULL
argument_list|)
expr_stmt|;
return|return
operator|(
name|ISC_R_SUCCESS
operator|)
return|;
name|cleanup
label|:
if|if
condition|(
name|result
operator|==
name|DST_R_NOCRYPTO
condition|)
block|{
name|cfg_obj_log
argument_list|(
name|key
argument_list|,
name|ns_g_lctx
argument_list|,
name|ISC_LOG_ERROR
argument_list|,
literal|"ignoring trusted key for '%s': no crypto support"
argument_list|,
name|keynamestr
argument_list|)
expr_stmt|;
name|result
operator|=
name|ISC_R_SUCCESS
expr_stmt|;
block|}
else|else
block|{
name|cfg_obj_log
argument_list|(
name|key
argument_list|,
name|ns_g_lctx
argument_list|,
name|ISC_LOG_ERROR
argument_list|,
literal|"configuring trusted key for '%s': %s"
argument_list|,
name|keynamestr
argument_list|,
name|isc_result_totext
argument_list|(
name|result
argument_list|)
argument_list|)
expr_stmt|;
name|result
operator|=
name|ISC_R_FAILURE
expr_stmt|;
block|}
if|if
condition|(
name|dstkey
operator|!=
name|NULL
condition|)
name|dst_key_free
argument_list|(
operator|&
name|dstkey
argument_list|)
expr_stmt|;
return|return
operator|(
name|result
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Configure DNSSEC keys for a view.  Currently used only for  * the security roots.  *  * The per-view configuration values and the server-global defaults are read  * from 'vconfig' and 'config'.  The variable to be configured is '*target'.  */
end_comment

begin_function
specifier|static
name|isc_result_t
name|configure_view_dnsseckeys
parameter_list|(
specifier|const
name|cfg_obj_t
modifier|*
name|vconfig
parameter_list|,
specifier|const
name|cfg_obj_t
modifier|*
name|config
parameter_list|,
name|isc_mem_t
modifier|*
name|mctx
parameter_list|,
name|dns_keytable_t
modifier|*
modifier|*
name|target
parameter_list|)
block|{
name|isc_result_t
name|result
decl_stmt|;
specifier|const
name|cfg_obj_t
modifier|*
name|keys
init|=
name|NULL
decl_stmt|;
specifier|const
name|cfg_obj_t
modifier|*
name|voptions
init|=
name|NULL
decl_stmt|;
specifier|const
name|cfg_listelt_t
modifier|*
name|element
decl_stmt|,
modifier|*
name|element2
decl_stmt|;
specifier|const
name|cfg_obj_t
modifier|*
name|keylist
decl_stmt|;
specifier|const
name|cfg_obj_t
modifier|*
name|key
decl_stmt|;
name|dns_keytable_t
modifier|*
name|keytable
init|=
name|NULL
decl_stmt|;
name|CHECK
argument_list|(
name|dns_keytable_create
argument_list|(
name|mctx
argument_list|,
operator|&
name|keytable
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|vconfig
operator|!=
name|NULL
condition|)
name|voptions
operator|=
name|cfg_tuple_get
argument_list|(
name|vconfig
argument_list|,
literal|"options"
argument_list|)
expr_stmt|;
name|keys
operator|=
name|NULL
expr_stmt|;
if|if
condition|(
name|voptions
operator|!=
name|NULL
condition|)
operator|(
name|void
operator|)
name|cfg_map_get
argument_list|(
name|voptions
argument_list|,
literal|"trusted-keys"
argument_list|,
operator|&
name|keys
argument_list|)
expr_stmt|;
if|if
condition|(
name|keys
operator|==
name|NULL
condition|)
operator|(
name|void
operator|)
name|cfg_map_get
argument_list|(
name|config
argument_list|,
literal|"trusted-keys"
argument_list|,
operator|&
name|keys
argument_list|)
expr_stmt|;
for|for
control|(
name|element
operator|=
name|cfg_list_first
argument_list|(
name|keys
argument_list|)
init|;
name|element
operator|!=
name|NULL
condition|;
name|element
operator|=
name|cfg_list_next
argument_list|(
name|element
argument_list|)
control|)
block|{
name|keylist
operator|=
name|cfg_listelt_value
argument_list|(
name|element
argument_list|)
expr_stmt|;
for|for
control|(
name|element2
operator|=
name|cfg_list_first
argument_list|(
name|keylist
argument_list|)
init|;
name|element2
operator|!=
name|NULL
condition|;
name|element2
operator|=
name|cfg_list_next
argument_list|(
name|element2
argument_list|)
control|)
block|{
name|key
operator|=
name|cfg_listelt_value
argument_list|(
name|element2
argument_list|)
expr_stmt|;
name|CHECK
argument_list|(
name|configure_view_dnsseckey
argument_list|(
name|vconfig
argument_list|,
name|key
argument_list|,
name|keytable
argument_list|,
name|mctx
argument_list|)
argument_list|)
expr_stmt|;
block|}
block|}
name|dns_keytable_detach
argument_list|(
name|target
argument_list|)
expr_stmt|;
operator|*
name|target
operator|=
name|keytable
expr_stmt|;
comment|/* Transfer ownership. */
name|keytable
operator|=
name|NULL
expr_stmt|;
name|result
operator|=
name|ISC_R_SUCCESS
expr_stmt|;
name|cleanup
label|:
return|return
operator|(
name|result
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|isc_result_t
name|mustbesecure
parameter_list|(
specifier|const
name|cfg_obj_t
modifier|*
name|mbs
parameter_list|,
name|dns_resolver_t
modifier|*
name|resolver
parameter_list|)
block|{
specifier|const
name|cfg_listelt_t
modifier|*
name|element
decl_stmt|;
specifier|const
name|cfg_obj_t
modifier|*
name|obj
decl_stmt|;
specifier|const
name|char
modifier|*
name|str
decl_stmt|;
name|dns_fixedname_t
name|fixed
decl_stmt|;
name|dns_name_t
modifier|*
name|name
decl_stmt|;
name|isc_boolean_t
name|value
decl_stmt|;
name|isc_result_t
name|result
decl_stmt|;
name|isc_buffer_t
name|b
decl_stmt|;
name|dns_fixedname_init
argument_list|(
operator|&
name|fixed
argument_list|)
expr_stmt|;
name|name
operator|=
name|dns_fixedname_name
argument_list|(
operator|&
name|fixed
argument_list|)
expr_stmt|;
for|for
control|(
name|element
operator|=
name|cfg_list_first
argument_list|(
name|mbs
argument_list|)
init|;
name|element
operator|!=
name|NULL
condition|;
name|element
operator|=
name|cfg_list_next
argument_list|(
name|element
argument_list|)
control|)
block|{
name|obj
operator|=
name|cfg_listelt_value
argument_list|(
name|element
argument_list|)
expr_stmt|;
name|str
operator|=
name|cfg_obj_asstring
argument_list|(
name|cfg_tuple_get
argument_list|(
name|obj
argument_list|,
literal|"name"
argument_list|)
argument_list|)
expr_stmt|;
name|isc_buffer_init
argument_list|(
operator|&
name|b
argument_list|,
name|str
argument_list|,
name|strlen
argument_list|(
name|str
argument_list|)
argument_list|)
expr_stmt|;
name|isc_buffer_add
argument_list|(
operator|&
name|b
argument_list|,
name|strlen
argument_list|(
name|str
argument_list|)
argument_list|)
expr_stmt|;
name|CHECK
argument_list|(
name|dns_name_fromtext
argument_list|(
name|name
argument_list|,
operator|&
name|b
argument_list|,
name|dns_rootname
argument_list|,
name|ISC_FALSE
argument_list|,
name|NULL
argument_list|)
argument_list|)
expr_stmt|;
name|value
operator|=
name|cfg_obj_asboolean
argument_list|(
name|cfg_tuple_get
argument_list|(
name|obj
argument_list|,
literal|"value"
argument_list|)
argument_list|)
expr_stmt|;
name|CHECK
argument_list|(
name|dns_resolver_setmustbesecure
argument_list|(
name|resolver
argument_list|,
name|name
argument_list|,
name|value
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|result
operator|=
name|ISC_R_SUCCESS
expr_stmt|;
name|cleanup
label|:
return|return
operator|(
name|result
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Get a dispatch appropriate for the resolver of a given view.  */
end_comment

begin_function
specifier|static
name|isc_result_t
name|get_view_querysource_dispatch
parameter_list|(
specifier|const
name|cfg_obj_t
modifier|*
modifier|*
name|maps
parameter_list|,
name|int
name|af
parameter_list|,
name|dns_dispatch_t
modifier|*
modifier|*
name|dispatchp
parameter_list|)
block|{
name|isc_result_t
name|result
decl_stmt|;
name|dns_dispatch_t
modifier|*
name|disp
decl_stmt|;
name|isc_sockaddr_t
name|sa
decl_stmt|;
name|unsigned
name|int
name|attrs
decl_stmt|,
name|attrmask
decl_stmt|;
specifier|const
name|cfg_obj_t
modifier|*
name|obj
init|=
name|NULL
decl_stmt|;
comment|/* 	 * Make compiler happy. 	 */
name|result
operator|=
name|ISC_R_FAILURE
expr_stmt|;
switch|switch
condition|(
name|af
condition|)
block|{
case|case
name|AF_INET
case|:
name|result
operator|=
name|ns_config_get
argument_list|(
name|maps
argument_list|,
literal|"query-source"
argument_list|,
operator|&
name|obj
argument_list|)
expr_stmt|;
name|INSIST
argument_list|(
name|result
operator|==
name|ISC_R_SUCCESS
argument_list|)
expr_stmt|;
break|break;
case|case
name|AF_INET6
case|:
name|result
operator|=
name|ns_config_get
argument_list|(
name|maps
argument_list|,
literal|"query-source-v6"
argument_list|,
operator|&
name|obj
argument_list|)
expr_stmt|;
name|INSIST
argument_list|(
name|result
operator|==
name|ISC_R_SUCCESS
argument_list|)
expr_stmt|;
break|break;
default|default:
name|INSIST
argument_list|(
literal|0
argument_list|)
expr_stmt|;
block|}
name|sa
operator|=
operator|*
operator|(
name|cfg_obj_assockaddr
argument_list|(
name|obj
argument_list|)
operator|)
expr_stmt|;
name|INSIST
argument_list|(
name|isc_sockaddr_pf
argument_list|(
operator|&
name|sa
argument_list|)
operator|==
name|af
argument_list|)
expr_stmt|;
comment|/* 	 * If we don't support this address family, we're done! 	 */
switch|switch
condition|(
name|af
condition|)
block|{
case|case
name|AF_INET
case|:
name|result
operator|=
name|isc_net_probeipv4
argument_list|()
expr_stmt|;
break|break;
case|case
name|AF_INET6
case|:
name|result
operator|=
name|isc_net_probeipv6
argument_list|()
expr_stmt|;
break|break;
default|default:
name|INSIST
argument_list|(
literal|0
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
return|return
operator|(
name|ISC_R_SUCCESS
operator|)
return|;
comment|/* 	 * Try to find a dispatcher that we can share. 	 */
name|attrs
operator|=
literal|0
expr_stmt|;
name|attrs
operator||=
name|DNS_DISPATCHATTR_UDP
expr_stmt|;
switch|switch
condition|(
name|af
condition|)
block|{
case|case
name|AF_INET
case|:
name|attrs
operator||=
name|DNS_DISPATCHATTR_IPV4
expr_stmt|;
break|break;
case|case
name|AF_INET6
case|:
name|attrs
operator||=
name|DNS_DISPATCHATTR_IPV6
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|isc_sockaddr_getport
argument_list|(
operator|&
name|sa
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|INSIST
argument_list|(
name|obj
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|cfg_obj_log
argument_list|(
name|obj
argument_list|,
name|ns_g_lctx
argument_list|,
name|ISC_LOG_INFO
argument_list|,
literal|"using specific query-source port suppresses port "
literal|"randomization and can be insecure."
argument_list|)
expr_stmt|;
block|}
name|attrmask
operator|=
literal|0
expr_stmt|;
name|attrmask
operator||=
name|DNS_DISPATCHATTR_UDP
expr_stmt|;
name|attrmask
operator||=
name|DNS_DISPATCHATTR_TCP
expr_stmt|;
name|attrmask
operator||=
name|DNS_DISPATCHATTR_IPV4
expr_stmt|;
name|attrmask
operator||=
name|DNS_DISPATCHATTR_IPV6
expr_stmt|;
name|disp
operator|=
name|NULL
expr_stmt|;
name|result
operator|=
name|dns_dispatch_getudp
argument_list|(
name|ns_g_dispatchmgr
argument_list|,
name|ns_g_socketmgr
argument_list|,
name|ns_g_taskmgr
argument_list|,
operator|&
name|sa
argument_list|,
literal|4096
argument_list|,
literal|1024
argument_list|,
literal|32768
argument_list|,
literal|16411
argument_list|,
literal|16433
argument_list|,
name|attrs
argument_list|,
name|attrmask
argument_list|,
operator|&
name|disp
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
block|{
name|isc_sockaddr_t
name|any
decl_stmt|;
name|char
name|buf
index|[
name|ISC_SOCKADDR_FORMATSIZE
index|]
decl_stmt|;
switch|switch
condition|(
name|af
condition|)
block|{
case|case
name|AF_INET
case|:
name|isc_sockaddr_any
argument_list|(
operator|&
name|any
argument_list|)
expr_stmt|;
break|break;
case|case
name|AF_INET6
case|:
name|isc_sockaddr_any6
argument_list|(
operator|&
name|any
argument_list|)
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|isc_sockaddr_equal
argument_list|(
operator|&
name|sa
argument_list|,
operator|&
name|any
argument_list|)
condition|)
return|return
operator|(
name|ISC_R_SUCCESS
operator|)
return|;
name|isc_sockaddr_format
argument_list|(
operator|&
name|sa
argument_list|,
name|buf
argument_list|,
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
argument_list|)
expr_stmt|;
name|isc_log_write
argument_list|(
name|ns_g_lctx
argument_list|,
name|NS_LOGCATEGORY_GENERAL
argument_list|,
name|NS_LOGMODULE_SERVER
argument_list|,
name|ISC_LOG_ERROR
argument_list|,
literal|"could not get query source dispatcher (%s)"
argument_list|,
name|buf
argument_list|)
expr_stmt|;
return|return
operator|(
name|result
operator|)
return|;
block|}
operator|*
name|dispatchp
operator|=
name|disp
expr_stmt|;
return|return
operator|(
name|ISC_R_SUCCESS
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|isc_result_t
name|configure_order
parameter_list|(
name|dns_order_t
modifier|*
name|order
parameter_list|,
specifier|const
name|cfg_obj_t
modifier|*
name|ent
parameter_list|)
block|{
name|dns_rdataclass_t
name|rdclass
decl_stmt|;
name|dns_rdatatype_t
name|rdtype
decl_stmt|;
specifier|const
name|cfg_obj_t
modifier|*
name|obj
decl_stmt|;
name|dns_fixedname_t
name|fixed
decl_stmt|;
name|unsigned
name|int
name|mode
init|=
literal|0
decl_stmt|;
specifier|const
name|char
modifier|*
name|str
decl_stmt|;
name|isc_buffer_t
name|b
decl_stmt|;
name|isc_result_t
name|result
decl_stmt|;
name|isc_boolean_t
name|addroot
decl_stmt|;
name|result
operator|=
name|ns_config_getclass
argument_list|(
name|cfg_tuple_get
argument_list|(
name|ent
argument_list|,
literal|"class"
argument_list|)
argument_list|,
name|dns_rdataclass_any
argument_list|,
operator|&
name|rdclass
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
return|return
operator|(
name|result
operator|)
return|;
name|result
operator|=
name|ns_config_gettype
argument_list|(
name|cfg_tuple_get
argument_list|(
name|ent
argument_list|,
literal|"type"
argument_list|)
argument_list|,
name|dns_rdatatype_any
argument_list|,
operator|&
name|rdtype
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
return|return
operator|(
name|result
operator|)
return|;
name|obj
operator|=
name|cfg_tuple_get
argument_list|(
name|ent
argument_list|,
literal|"name"
argument_list|)
expr_stmt|;
if|if
condition|(
name|cfg_obj_isstring
argument_list|(
name|obj
argument_list|)
condition|)
name|str
operator|=
name|cfg_obj_asstring
argument_list|(
name|obj
argument_list|)
expr_stmt|;
else|else
name|str
operator|=
literal|"*"
expr_stmt|;
name|addroot
operator|=
name|ISC_TF
argument_list|(
name|strcmp
argument_list|(
name|str
argument_list|,
literal|"*"
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|isc_buffer_init
argument_list|(
operator|&
name|b
argument_list|,
name|str
argument_list|,
name|strlen
argument_list|(
name|str
argument_list|)
argument_list|)
expr_stmt|;
name|isc_buffer_add
argument_list|(
operator|&
name|b
argument_list|,
name|strlen
argument_list|(
name|str
argument_list|)
argument_list|)
expr_stmt|;
name|dns_fixedname_init
argument_list|(
operator|&
name|fixed
argument_list|)
expr_stmt|;
name|result
operator|=
name|dns_name_fromtext
argument_list|(
name|dns_fixedname_name
argument_list|(
operator|&
name|fixed
argument_list|)
argument_list|,
operator|&
name|b
argument_list|,
name|dns_rootname
argument_list|,
name|ISC_FALSE
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
return|return
operator|(
name|result
operator|)
return|;
name|obj
operator|=
name|cfg_tuple_get
argument_list|(
name|ent
argument_list|,
literal|"ordering"
argument_list|)
expr_stmt|;
name|INSIST
argument_list|(
name|cfg_obj_isstring
argument_list|(
name|obj
argument_list|)
argument_list|)
expr_stmt|;
name|str
operator|=
name|cfg_obj_asstring
argument_list|(
name|obj
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|strcasecmp
argument_list|(
name|str
argument_list|,
literal|"fixed"
argument_list|)
condition|)
name|mode
operator|=
name|DNS_RDATASETATTR_FIXEDORDER
expr_stmt|;
elseif|else
if|if
condition|(
operator|!
name|strcasecmp
argument_list|(
name|str
argument_list|,
literal|"random"
argument_list|)
condition|)
name|mode
operator|=
name|DNS_RDATASETATTR_RANDOMIZE
expr_stmt|;
elseif|else
if|if
condition|(
operator|!
name|strcasecmp
argument_list|(
name|str
argument_list|,
literal|"cyclic"
argument_list|)
condition|)
name|mode
operator|=
literal|0
expr_stmt|;
else|else
name|INSIST
argument_list|(
literal|0
argument_list|)
expr_stmt|;
comment|/* 	 * "*" should match everything including the root (BIND 8 compat). 	 * As dns_name_matcheswildcard(".", "*.") returns FALSE add a 	 * explicit entry for "." when the name is "*". 	 */
if|if
condition|(
name|addroot
condition|)
block|{
name|result
operator|=
name|dns_order_add
argument_list|(
name|order
argument_list|,
name|dns_rootname
argument_list|,
name|rdtype
argument_list|,
name|rdclass
argument_list|,
name|mode
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
return|return
operator|(
name|result
operator|)
return|;
block|}
return|return
operator|(
name|dns_order_add
argument_list|(
name|order
argument_list|,
name|dns_fixedname_name
argument_list|(
operator|&
name|fixed
argument_list|)
argument_list|,
name|rdtype
argument_list|,
name|rdclass
argument_list|,
name|mode
argument_list|)
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|isc_result_t
name|configure_peer
parameter_list|(
specifier|const
name|cfg_obj_t
modifier|*
name|cpeer
parameter_list|,
name|isc_mem_t
modifier|*
name|mctx
parameter_list|,
name|dns_peer_t
modifier|*
modifier|*
name|peerp
parameter_list|)
block|{
specifier|const
name|isc_sockaddr_t
modifier|*
name|sa
decl_stmt|;
name|isc_netaddr_t
name|na
decl_stmt|;
name|dns_peer_t
modifier|*
name|peer
decl_stmt|;
specifier|const
name|cfg_obj_t
modifier|*
name|obj
decl_stmt|;
specifier|const
name|char
modifier|*
name|str
decl_stmt|;
name|isc_result_t
name|result
decl_stmt|;
name|sa
operator|=
name|cfg_obj_assockaddr
argument_list|(
name|cfg_map_getname
argument_list|(
name|cpeer
argument_list|)
argument_list|)
expr_stmt|;
name|isc_netaddr_fromsockaddr
argument_list|(
operator|&
name|na
argument_list|,
name|sa
argument_list|)
expr_stmt|;
name|peer
operator|=
name|NULL
expr_stmt|;
name|result
operator|=
name|dns_peer_new
argument_list|(
name|mctx
argument_list|,
operator|&
name|na
argument_list|,
operator|&
name|peer
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
return|return
operator|(
name|result
operator|)
return|;
name|obj
operator|=
name|NULL
expr_stmt|;
operator|(
name|void
operator|)
name|cfg_map_get
argument_list|(
name|cpeer
argument_list|,
literal|"bogus"
argument_list|,
operator|&
name|obj
argument_list|)
expr_stmt|;
if|if
condition|(
name|obj
operator|!=
name|NULL
condition|)
name|CHECK
argument_list|(
name|dns_peer_setbogus
argument_list|(
name|peer
argument_list|,
name|cfg_obj_asboolean
argument_list|(
name|obj
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
name|obj
operator|=
name|NULL
expr_stmt|;
operator|(
name|void
operator|)
name|cfg_map_get
argument_list|(
name|cpeer
argument_list|,
literal|"provide-ixfr"
argument_list|,
operator|&
name|obj
argument_list|)
expr_stmt|;
if|if
condition|(
name|obj
operator|!=
name|NULL
condition|)
name|CHECK
argument_list|(
name|dns_peer_setprovideixfr
argument_list|(
name|peer
argument_list|,
name|cfg_obj_asboolean
argument_list|(
name|obj
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
name|obj
operator|=
name|NULL
expr_stmt|;
operator|(
name|void
operator|)
name|cfg_map_get
argument_list|(
name|cpeer
argument_list|,
literal|"request-ixfr"
argument_list|,
operator|&
name|obj
argument_list|)
expr_stmt|;
if|if
condition|(
name|obj
operator|!=
name|NULL
condition|)
name|CHECK
argument_list|(
name|dns_peer_setrequestixfr
argument_list|(
name|peer
argument_list|,
name|cfg_obj_asboolean
argument_list|(
name|obj
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
name|obj
operator|=
name|NULL
expr_stmt|;
operator|(
name|void
operator|)
name|cfg_map_get
argument_list|(
name|cpeer
argument_list|,
literal|"edns"
argument_list|,
operator|&
name|obj
argument_list|)
expr_stmt|;
if|if
condition|(
name|obj
operator|!=
name|NULL
condition|)
name|CHECK
argument_list|(
name|dns_peer_setsupportedns
argument_list|(
name|peer
argument_list|,
name|cfg_obj_asboolean
argument_list|(
name|obj
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
name|obj
operator|=
name|NULL
expr_stmt|;
operator|(
name|void
operator|)
name|cfg_map_get
argument_list|(
name|cpeer
argument_list|,
literal|"transfers"
argument_list|,
operator|&
name|obj
argument_list|)
expr_stmt|;
if|if
condition|(
name|obj
operator|!=
name|NULL
condition|)
name|CHECK
argument_list|(
name|dns_peer_settransfers
argument_list|(
name|peer
argument_list|,
name|cfg_obj_asuint32
argument_list|(
name|obj
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
name|obj
operator|=
name|NULL
expr_stmt|;
operator|(
name|void
operator|)
name|cfg_map_get
argument_list|(
name|cpeer
argument_list|,
literal|"transfer-format"
argument_list|,
operator|&
name|obj
argument_list|)
expr_stmt|;
if|if
condition|(
name|obj
operator|!=
name|NULL
condition|)
block|{
name|str
operator|=
name|cfg_obj_asstring
argument_list|(
name|obj
argument_list|)
expr_stmt|;
if|if
condition|(
name|strcasecmp
argument_list|(
name|str
argument_list|,
literal|"many-answers"
argument_list|)
operator|==
literal|0
condition|)
name|CHECK
argument_list|(
name|dns_peer_settransferformat
argument_list|(
name|peer
argument_list|,
name|dns_many_answers
argument_list|)
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|strcasecmp
argument_list|(
name|str
argument_list|,
literal|"one-answer"
argument_list|)
operator|==
literal|0
condition|)
name|CHECK
argument_list|(
name|dns_peer_settransferformat
argument_list|(
name|peer
argument_list|,
name|dns_one_answer
argument_list|)
argument_list|)
expr_stmt|;
else|else
name|INSIST
argument_list|(
literal|0
argument_list|)
expr_stmt|;
block|}
name|obj
operator|=
name|NULL
expr_stmt|;
operator|(
name|void
operator|)
name|cfg_map_get
argument_list|(
name|cpeer
argument_list|,
literal|"keys"
argument_list|,
operator|&
name|obj
argument_list|)
expr_stmt|;
if|if
condition|(
name|obj
operator|!=
name|NULL
condition|)
block|{
name|result
operator|=
name|dns_peer_setkeybycharp
argument_list|(
name|peer
argument_list|,
name|cfg_obj_asstring
argument_list|(
name|obj
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
goto|goto
name|cleanup
goto|;
block|}
name|obj
operator|=
name|NULL
expr_stmt|;
if|if
condition|(
name|isc_sockaddr_pf
argument_list|(
name|sa
argument_list|)
operator|==
name|AF_INET
condition|)
operator|(
name|void
operator|)
name|cfg_map_get
argument_list|(
name|cpeer
argument_list|,
literal|"transfer-source"
argument_list|,
operator|&
name|obj
argument_list|)
expr_stmt|;
else|else
operator|(
name|void
operator|)
name|cfg_map_get
argument_list|(
name|cpeer
argument_list|,
literal|"transfer-source-v6"
argument_list|,
operator|&
name|obj
argument_list|)
expr_stmt|;
if|if
condition|(
name|obj
operator|!=
name|NULL
condition|)
block|{
name|result
operator|=
name|dns_peer_settransfersource
argument_list|(
name|peer
argument_list|,
name|cfg_obj_assockaddr
argument_list|(
name|obj
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
goto|goto
name|cleanup
goto|;
block|}
operator|*
name|peerp
operator|=
name|peer
expr_stmt|;
return|return
operator|(
name|ISC_R_SUCCESS
operator|)
return|;
name|cleanup
label|:
name|dns_peer_detach
argument_list|(
operator|&
name|peer
argument_list|)
expr_stmt|;
return|return
operator|(
name|result
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|isc_result_t
name|disable_algorithms
parameter_list|(
specifier|const
name|cfg_obj_t
modifier|*
name|disabled
parameter_list|,
name|dns_resolver_t
modifier|*
name|resolver
parameter_list|)
block|{
name|isc_result_t
name|result
decl_stmt|;
specifier|const
name|cfg_obj_t
modifier|*
name|algorithms
decl_stmt|;
specifier|const
name|cfg_listelt_t
modifier|*
name|element
decl_stmt|;
specifier|const
name|char
modifier|*
name|str
decl_stmt|;
name|dns_fixedname_t
name|fixed
decl_stmt|;
name|dns_name_t
modifier|*
name|name
decl_stmt|;
name|isc_buffer_t
name|b
decl_stmt|;
name|dns_fixedname_init
argument_list|(
operator|&
name|fixed
argument_list|)
expr_stmt|;
name|name
operator|=
name|dns_fixedname_name
argument_list|(
operator|&
name|fixed
argument_list|)
expr_stmt|;
name|str
operator|=
name|cfg_obj_asstring
argument_list|(
name|cfg_tuple_get
argument_list|(
name|disabled
argument_list|,
literal|"name"
argument_list|)
argument_list|)
expr_stmt|;
name|isc_buffer_init
argument_list|(
operator|&
name|b
argument_list|,
name|str
argument_list|,
name|strlen
argument_list|(
name|str
argument_list|)
argument_list|)
expr_stmt|;
name|isc_buffer_add
argument_list|(
operator|&
name|b
argument_list|,
name|strlen
argument_list|(
name|str
argument_list|)
argument_list|)
expr_stmt|;
name|CHECK
argument_list|(
name|dns_name_fromtext
argument_list|(
name|name
argument_list|,
operator|&
name|b
argument_list|,
name|dns_rootname
argument_list|,
name|ISC_FALSE
argument_list|,
name|NULL
argument_list|)
argument_list|)
expr_stmt|;
name|algorithms
operator|=
name|cfg_tuple_get
argument_list|(
name|disabled
argument_list|,
literal|"algorithms"
argument_list|)
expr_stmt|;
for|for
control|(
name|element
operator|=
name|cfg_list_first
argument_list|(
name|algorithms
argument_list|)
init|;
name|element
operator|!=
name|NULL
condition|;
name|element
operator|=
name|cfg_list_next
argument_list|(
name|element
argument_list|)
control|)
block|{
name|isc_textregion_t
name|r
decl_stmt|;
name|dns_secalg_t
name|alg
decl_stmt|;
name|DE_CONST
argument_list|(
name|cfg_obj_asstring
argument_list|(
name|cfg_listelt_value
argument_list|(
name|element
argument_list|)
argument_list|)
argument_list|,
name|r
operator|.
name|base
argument_list|)
expr_stmt|;
name|r
operator|.
name|length
operator|=
name|strlen
argument_list|(
name|r
operator|.
name|base
argument_list|)
expr_stmt|;
name|result
operator|=
name|dns_secalg_fromtext
argument_list|(
operator|&
name|alg
argument_list|,
operator|&
name|r
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
block|{
name|isc_uint8_t
name|ui
decl_stmt|;
name|result
operator|=
name|isc_parse_uint8
argument_list|(
operator|&
name|ui
argument_list|,
name|r
operator|.
name|base
argument_list|,
literal|10
argument_list|)
expr_stmt|;
name|alg
operator|=
name|ui
expr_stmt|;
block|}
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
block|{
name|cfg_obj_log
argument_list|(
name|cfg_listelt_value
argument_list|(
name|element
argument_list|)
argument_list|,
name|ns_g_lctx
argument_list|,
name|ISC_LOG_ERROR
argument_list|,
literal|"invalid algorithm"
argument_list|)
expr_stmt|;
name|CHECK
argument_list|(
name|result
argument_list|)
expr_stmt|;
block|}
name|CHECK
argument_list|(
name|dns_resolver_disable_algorithm
argument_list|(
name|resolver
argument_list|,
name|name
argument_list|,
name|alg
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|cleanup
label|:
return|return
operator|(
name|result
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Configure 'view' according to 'vconfig', taking defaults from 'config'  * where values are missing in 'vconfig'.  *  * When configuring the default view, 'vconfig' will be NULL and the  * global defaults in 'config' used exclusively.  */
end_comment

begin_function
specifier|static
name|isc_result_t
name|configure_view
parameter_list|(
name|dns_view_t
modifier|*
name|view
parameter_list|,
specifier|const
name|cfg_obj_t
modifier|*
name|config
parameter_list|,
specifier|const
name|cfg_obj_t
modifier|*
name|vconfig
parameter_list|,
name|isc_mem_t
modifier|*
name|mctx
parameter_list|,
name|ns_aclconfctx_t
modifier|*
name|actx
parameter_list|,
name|isc_boolean_t
name|need_hints
parameter_list|)
block|{
specifier|const
name|cfg_obj_t
modifier|*
name|maps
index|[
literal|4
index|]
decl_stmt|;
specifier|const
name|cfg_obj_t
modifier|*
name|cfgmaps
index|[
literal|3
index|]
decl_stmt|;
specifier|const
name|cfg_obj_t
modifier|*
name|options
init|=
name|NULL
decl_stmt|;
specifier|const
name|cfg_obj_t
modifier|*
name|voptions
init|=
name|NULL
decl_stmt|;
specifier|const
name|cfg_obj_t
modifier|*
name|forwardtype
decl_stmt|;
specifier|const
name|cfg_obj_t
modifier|*
name|forwarders
decl_stmt|;
specifier|const
name|cfg_obj_t
modifier|*
name|alternates
decl_stmt|;
specifier|const
name|cfg_obj_t
modifier|*
name|zonelist
decl_stmt|;
specifier|const
name|cfg_obj_t
modifier|*
name|disabled
decl_stmt|;
specifier|const
name|cfg_obj_t
modifier|*
name|obj
decl_stmt|;
specifier|const
name|cfg_listelt_t
modifier|*
name|element
decl_stmt|;
name|in_port_t
name|port
decl_stmt|;
name|dns_cache_t
modifier|*
name|cache
init|=
name|NULL
decl_stmt|;
name|isc_result_t
name|result
decl_stmt|;
name|isc_uint32_t
name|max_adb_size
decl_stmt|;
name|isc_uint32_t
name|max_cache_size
decl_stmt|;
name|isc_uint32_t
name|lame_ttl
decl_stmt|;
name|dns_tsig_keyring_t
modifier|*
name|ring
decl_stmt|;
name|dns_view_t
modifier|*
name|pview
init|=
name|NULL
decl_stmt|;
comment|/* Production view */
name|isc_mem_t
modifier|*
name|cmctx
decl_stmt|;
name|dns_dispatch_t
modifier|*
name|dispatch4
init|=
name|NULL
decl_stmt|;
name|dns_dispatch_t
modifier|*
name|dispatch6
init|=
name|NULL
decl_stmt|;
name|isc_boolean_t
name|reused_cache
init|=
name|ISC_FALSE
decl_stmt|;
name|int
name|i
decl_stmt|;
specifier|const
name|char
modifier|*
name|str
decl_stmt|;
name|dns_order_t
modifier|*
name|order
init|=
name|NULL
decl_stmt|;
name|isc_uint32_t
name|udpsize
decl_stmt|;
name|unsigned
name|int
name|check
init|=
literal|0
decl_stmt|;
name|REQUIRE
argument_list|(
name|DNS_VIEW_VALID
argument_list|(
name|view
argument_list|)
argument_list|)
expr_stmt|;
name|cmctx
operator|=
name|NULL
expr_stmt|;
if|if
condition|(
name|config
operator|!=
name|NULL
condition|)
operator|(
name|void
operator|)
name|cfg_map_get
argument_list|(
name|config
argument_list|,
literal|"options"
argument_list|,
operator|&
name|options
argument_list|)
expr_stmt|;
name|i
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|vconfig
operator|!=
name|NULL
condition|)
block|{
name|voptions
operator|=
name|cfg_tuple_get
argument_list|(
name|vconfig
argument_list|,
literal|"options"
argument_list|)
expr_stmt|;
name|maps
index|[
name|i
operator|++
index|]
operator|=
name|voptions
expr_stmt|;
block|}
if|if
condition|(
name|options
operator|!=
name|NULL
condition|)
name|maps
index|[
name|i
operator|++
index|]
operator|=
name|options
expr_stmt|;
name|maps
index|[
name|i
operator|++
index|]
operator|=
name|ns_g_defaults
expr_stmt|;
name|maps
index|[
name|i
index|]
operator|=
name|NULL
expr_stmt|;
name|i
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|voptions
operator|!=
name|NULL
condition|)
name|cfgmaps
index|[
name|i
operator|++
index|]
operator|=
name|voptions
expr_stmt|;
if|if
condition|(
name|config
operator|!=
name|NULL
condition|)
name|cfgmaps
index|[
name|i
operator|++
index|]
operator|=
name|config
expr_stmt|;
name|cfgmaps
index|[
name|i
index|]
operator|=
name|NULL
expr_stmt|;
comment|/* 	 * Set the view's port number for outgoing queries. 	 */
name|CHECKM
argument_list|(
name|ns_config_getport
argument_list|(
name|config
argument_list|,
operator|&
name|port
argument_list|)
argument_list|,
literal|"port"
argument_list|)
expr_stmt|;
name|dns_view_setdstport
argument_list|(
name|view
argument_list|,
name|port
argument_list|)
expr_stmt|;
comment|/* 	 * Configure the zones. 	 */
name|zonelist
operator|=
name|NULL
expr_stmt|;
if|if
condition|(
name|voptions
operator|!=
name|NULL
condition|)
operator|(
name|void
operator|)
name|cfg_map_get
argument_list|(
name|voptions
argument_list|,
literal|"zone"
argument_list|,
operator|&
name|zonelist
argument_list|)
expr_stmt|;
else|else
operator|(
name|void
operator|)
name|cfg_map_get
argument_list|(
name|config
argument_list|,
literal|"zone"
argument_list|,
operator|&
name|zonelist
argument_list|)
expr_stmt|;
for|for
control|(
name|element
operator|=
name|cfg_list_first
argument_list|(
name|zonelist
argument_list|)
init|;
name|element
operator|!=
name|NULL
condition|;
name|element
operator|=
name|cfg_list_next
argument_list|(
name|element
argument_list|)
control|)
block|{
specifier|const
name|cfg_obj_t
modifier|*
name|zconfig
init|=
name|cfg_listelt_value
argument_list|(
name|element
argument_list|)
decl_stmt|;
name|CHECK
argument_list|(
name|configure_zone
argument_list|(
name|config
argument_list|,
name|zconfig
argument_list|,
name|vconfig
argument_list|,
name|mctx
argument_list|,
name|view
argument_list|,
name|actx
argument_list|)
argument_list|)
expr_stmt|;
block|}
comment|/* 	 * Configure the view's cache.  Try to reuse an existing 	 * cache if possible, otherwise create a new cache. 	 * Note that the ADB is not preserved in either case. 	 * 	 * XXX Determining when it is safe to reuse a cache is 	 * tricky.  When the view's configuration changes, the cached 	 * data may become invalid because it reflects our old 	 * view of the world.  As more view attributes become 	 * configurable, we will have to add code here to check 	 * whether they have changed in ways that could 	 * invalidate the cache. 	 */
name|result
operator|=
name|dns_viewlist_find
argument_list|(
operator|&
name|ns_g_server
operator|->
name|viewlist
argument_list|,
name|view
operator|->
name|name
argument_list|,
name|view
operator|->
name|rdclass
argument_list|,
operator|&
name|pview
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_NOTFOUND
operator|&&
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
goto|goto
name|cleanup
goto|;
if|if
condition|(
name|pview
operator|!=
name|NULL
condition|)
block|{
name|INSIST
argument_list|(
name|pview
operator|->
name|cache
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|isc_log_write
argument_list|(
name|ns_g_lctx
argument_list|,
name|NS_LOGCATEGORY_GENERAL
argument_list|,
name|NS_LOGMODULE_SERVER
argument_list|,
name|ISC_LOG_DEBUG
argument_list|(
literal|3
argument_list|)
argument_list|,
literal|"reusing existing cache"
argument_list|)
expr_stmt|;
name|reused_cache
operator|=
name|ISC_TRUE
expr_stmt|;
name|dns_cache_attach
argument_list|(
name|pview
operator|->
name|cache
argument_list|,
operator|&
name|cache
argument_list|)
expr_stmt|;
name|dns_view_detach
argument_list|(
operator|&
name|pview
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|CHECK
argument_list|(
name|isc_mem_create
argument_list|(
literal|0
argument_list|,
literal|0
argument_list|,
operator|&
name|cmctx
argument_list|)
argument_list|)
expr_stmt|;
name|CHECK
argument_list|(
name|dns_cache_create
argument_list|(
name|cmctx
argument_list|,
name|ns_g_taskmgr
argument_list|,
name|ns_g_timermgr
argument_list|,
name|view
operator|->
name|rdclass
argument_list|,
literal|"rbt"
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|,
operator|&
name|cache
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|dns_view_setcache
argument_list|(
name|view
argument_list|,
name|cache
argument_list|)
expr_stmt|;
comment|/* 	 * cache-file cannot be inherited if views are present, but this 	 * should be caught by the configuration checking stage. 	 */
name|obj
operator|=
name|NULL
expr_stmt|;
name|result
operator|=
name|ns_config_get
argument_list|(
name|maps
argument_list|,
literal|"cache-file"
argument_list|,
operator|&
name|obj
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|==
name|ISC_R_SUCCESS
operator|&&
name|strcmp
argument_list|(
name|view
operator|->
name|name
argument_list|,
literal|"_bind"
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|CHECK
argument_list|(
name|dns_cache_setfilename
argument_list|(
name|cache
argument_list|,
name|cfg_obj_asstring
argument_list|(
name|obj
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|reused_cache
condition|)
name|CHECK
argument_list|(
name|dns_cache_load
argument_list|(
name|cache
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|obj
operator|=
name|NULL
expr_stmt|;
name|result
operator|=
name|ns_config_get
argument_list|(
name|maps
argument_list|,
literal|"cleaning-interval"
argument_list|,
operator|&
name|obj
argument_list|)
expr_stmt|;
name|INSIST
argument_list|(
name|result
operator|==
name|ISC_R_SUCCESS
argument_list|)
expr_stmt|;
name|dns_cache_setcleaninginterval
argument_list|(
name|cache
argument_list|,
name|cfg_obj_asuint32
argument_list|(
name|obj
argument_list|)
operator|*
literal|60
argument_list|)
expr_stmt|;
name|obj
operator|=
name|NULL
expr_stmt|;
name|result
operator|=
name|ns_config_get
argument_list|(
name|maps
argument_list|,
literal|"max-cache-size"
argument_list|,
operator|&
name|obj
argument_list|)
expr_stmt|;
name|INSIST
argument_list|(
name|result
operator|==
name|ISC_R_SUCCESS
argument_list|)
expr_stmt|;
if|if
condition|(
name|cfg_obj_isstring
argument_list|(
name|obj
argument_list|)
condition|)
block|{
name|str
operator|=
name|cfg_obj_asstring
argument_list|(
name|obj
argument_list|)
expr_stmt|;
name|INSIST
argument_list|(
name|strcasecmp
argument_list|(
name|str
argument_list|,
literal|"unlimited"
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|max_cache_size
operator|=
name|ISC_UINT32_MAX
expr_stmt|;
block|}
else|else
block|{
name|isc_resourcevalue_t
name|value
decl_stmt|;
name|value
operator|=
name|cfg_obj_asuint64
argument_list|(
name|obj
argument_list|)
expr_stmt|;
if|if
condition|(
name|value
operator|>
name|ISC_UINT32_MAX
condition|)
block|{
name|cfg_obj_log
argument_list|(
name|obj
argument_list|,
name|ns_g_lctx
argument_list|,
name|ISC_LOG_ERROR
argument_list|,
literal|"'max-cache-size "
literal|"%"
name|ISC_PRINT_QUADFORMAT
literal|"d' is too large"
argument_list|,
name|value
argument_list|)
expr_stmt|;
name|result
operator|=
name|ISC_R_RANGE
expr_stmt|;
goto|goto
name|cleanup
goto|;
block|}
name|max_cache_size
operator|=
operator|(
name|isc_uint32_t
operator|)
name|value
expr_stmt|;
block|}
name|dns_cache_setcachesize
argument_list|(
name|cache
argument_list|,
name|max_cache_size
argument_list|)
expr_stmt|;
name|dns_cache_detach
argument_list|(
operator|&
name|cache
argument_list|)
expr_stmt|;
comment|/* 	 * Check-names. 	 */
name|obj
operator|=
name|NULL
expr_stmt|;
name|result
operator|=
name|ns_checknames_get
argument_list|(
name|maps
argument_list|,
literal|"response"
argument_list|,
operator|&
name|obj
argument_list|)
expr_stmt|;
name|INSIST
argument_list|(
name|result
operator|==
name|ISC_R_SUCCESS
argument_list|)
expr_stmt|;
name|str
operator|=
name|cfg_obj_asstring
argument_list|(
name|obj
argument_list|)
expr_stmt|;
if|if
condition|(
name|strcasecmp
argument_list|(
name|str
argument_list|,
literal|"fail"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|check
operator|=
name|DNS_RESOLVER_CHECKNAMES
operator||
name|DNS_RESOLVER_CHECKNAMESFAIL
expr_stmt|;
name|view
operator|->
name|checknames
operator|=
name|ISC_TRUE
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcasecmp
argument_list|(
name|str
argument_list|,
literal|"warn"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|check
operator|=
name|DNS_RESOLVER_CHECKNAMES
expr_stmt|;
name|view
operator|->
name|checknames
operator|=
name|ISC_FALSE
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcasecmp
argument_list|(
name|str
argument_list|,
literal|"ignore"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|check
operator|=
literal|0
expr_stmt|;
name|view
operator|->
name|checknames
operator|=
name|ISC_FALSE
expr_stmt|;
block|}
else|else
name|INSIST
argument_list|(
literal|0
argument_list|)
expr_stmt|;
comment|/* 	 * Resolver. 	 * 	 * XXXRTH  Hardwired number of tasks. 	 */
name|CHECK
argument_list|(
name|get_view_querysource_dispatch
argument_list|(
name|maps
argument_list|,
name|AF_INET
argument_list|,
operator|&
name|dispatch4
argument_list|)
argument_list|)
expr_stmt|;
name|CHECK
argument_list|(
name|get_view_querysource_dispatch
argument_list|(
name|maps
argument_list|,
name|AF_INET6
argument_list|,
operator|&
name|dispatch6
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|dispatch4
operator|==
name|NULL
operator|&&
name|dispatch6
operator|==
name|NULL
condition|)
block|{
name|UNEXPECTED_ERROR
argument_list|(
name|__FILE__
argument_list|,
name|__LINE__
argument_list|,
literal|"unable to obtain neither an IPv4 nor"
literal|" an IPv6 dispatch"
argument_list|)
expr_stmt|;
name|result
operator|=
name|ISC_R_UNEXPECTED
expr_stmt|;
goto|goto
name|cleanup
goto|;
block|}
name|CHECK
argument_list|(
name|dns_view_createresolver
argument_list|(
name|view
argument_list|,
name|ns_g_taskmgr
argument_list|,
literal|31
argument_list|,
name|ns_g_socketmgr
argument_list|,
name|ns_g_timermgr
argument_list|,
name|check
argument_list|,
name|ns_g_dispatchmgr
argument_list|,
name|dispatch4
argument_list|,
name|dispatch6
argument_list|)
argument_list|)
expr_stmt|;
comment|/* 	 * Set the ADB cache size to 1/8th of the max-cache-size. 	 */
name|max_adb_size
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|max_cache_size
operator|!=
literal|0
condition|)
block|{
name|max_adb_size
operator|=
name|max_cache_size
operator|/
literal|8
expr_stmt|;
if|if
condition|(
name|max_adb_size
operator|==
literal|0
condition|)
name|max_adb_size
operator|=
literal|1
expr_stmt|;
comment|/* Force minimum. */
block|}
name|dns_adb_setadbsize
argument_list|(
name|view
operator|->
name|adb
argument_list|,
name|max_adb_size
argument_list|)
expr_stmt|;
comment|/* 	 * Set resolver's lame-ttl. 	 */
name|obj
operator|=
name|NULL
expr_stmt|;
name|result
operator|=
name|ns_config_get
argument_list|(
name|maps
argument_list|,
literal|"lame-ttl"
argument_list|,
operator|&
name|obj
argument_list|)
expr_stmt|;
name|INSIST
argument_list|(
name|result
operator|==
name|ISC_R_SUCCESS
argument_list|)
expr_stmt|;
name|lame_ttl
operator|=
name|cfg_obj_asuint32
argument_list|(
name|obj
argument_list|)
expr_stmt|;
if|if
condition|(
name|lame_ttl
operator|>
literal|1800
condition|)
name|lame_ttl
operator|=
literal|1800
expr_stmt|;
name|dns_resolver_setlamettl
argument_list|(
name|view
operator|->
name|resolver
argument_list|,
name|lame_ttl
argument_list|)
expr_stmt|;
comment|/* 	 * Set the resolver's EDNS UDP size. 	 */
name|obj
operator|=
name|NULL
expr_stmt|;
name|result
operator|=
name|ns_config_get
argument_list|(
name|maps
argument_list|,
literal|"edns-udp-size"
argument_list|,
operator|&
name|obj
argument_list|)
expr_stmt|;
name|INSIST
argument_list|(
name|result
operator|==
name|ISC_R_SUCCESS
argument_list|)
expr_stmt|;
name|udpsize
operator|=
name|cfg_obj_asuint32
argument_list|(
name|obj
argument_list|)
expr_stmt|;
if|if
condition|(
name|udpsize
operator|<
literal|512
condition|)
name|udpsize
operator|=
literal|512
expr_stmt|;
if|if
condition|(
name|udpsize
operator|>
literal|4096
condition|)
name|udpsize
operator|=
literal|4096
expr_stmt|;
name|dns_resolver_setudpsize
argument_list|(
name|view
operator|->
name|resolver
argument_list|,
operator|(
name|isc_uint16_t
operator|)
name|udpsize
argument_list|)
expr_stmt|;
comment|/* 	 * Set supported DNSSEC algorithms. 	 */
name|dns_resolver_reset_algorithms
argument_list|(
name|view
operator|->
name|resolver
argument_list|)
expr_stmt|;
name|disabled
operator|=
name|NULL
expr_stmt|;
operator|(
name|void
operator|)
name|ns_config_get
argument_list|(
name|maps
argument_list|,
literal|"disable-algorithms"
argument_list|,
operator|&
name|disabled
argument_list|)
expr_stmt|;
if|if
condition|(
name|disabled
operator|!=
name|NULL
condition|)
block|{
for|for
control|(
name|element
operator|=
name|cfg_list_first
argument_list|(
name|disabled
argument_list|)
init|;
name|element
operator|!=
name|NULL
condition|;
name|element
operator|=
name|cfg_list_next
argument_list|(
name|element
argument_list|)
control|)
name|CHECK
argument_list|(
name|disable_algorithms
argument_list|(
name|cfg_listelt_value
argument_list|(
name|element
argument_list|)
argument_list|,
name|view
operator|->
name|resolver
argument_list|)
argument_list|)
expr_stmt|;
block|}
comment|/* 	 * A global or view "forwarders" option, if present, 	 * creates an entry for "." in the forwarding table. 	 */
name|forwardtype
operator|=
name|NULL
expr_stmt|;
name|forwarders
operator|=
name|NULL
expr_stmt|;
operator|(
name|void
operator|)
name|ns_config_get
argument_list|(
name|maps
argument_list|,
literal|"forward"
argument_list|,
operator|&
name|forwardtype
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|ns_config_get
argument_list|(
name|maps
argument_list|,
literal|"forwarders"
argument_list|,
operator|&
name|forwarders
argument_list|)
expr_stmt|;
if|if
condition|(
name|forwarders
operator|!=
name|NULL
condition|)
name|CHECK
argument_list|(
name|configure_forward
argument_list|(
name|config
argument_list|,
name|view
argument_list|,
name|dns_rootname
argument_list|,
name|forwarders
argument_list|,
name|forwardtype
argument_list|)
argument_list|)
expr_stmt|;
comment|/* 	 * Dual Stack Servers. 	 */
name|alternates
operator|=
name|NULL
expr_stmt|;
operator|(
name|void
operator|)
name|ns_config_get
argument_list|(
name|maps
argument_list|,
literal|"dual-stack-servers"
argument_list|,
operator|&
name|alternates
argument_list|)
expr_stmt|;
if|if
condition|(
name|alternates
operator|!=
name|NULL
condition|)
name|CHECK
argument_list|(
name|configure_alternates
argument_list|(
name|config
argument_list|,
name|view
argument_list|,
name|alternates
argument_list|)
argument_list|)
expr_stmt|;
comment|/* 	 * We have default hints for class IN if we need them. 	 */
if|if
condition|(
name|view
operator|->
name|rdclass
operator|==
name|dns_rdataclass_in
operator|&&
name|view
operator|->
name|hints
operator|==
name|NULL
condition|)
name|dns_view_sethints
argument_list|(
name|view
argument_list|,
name|ns_g_server
operator|->
name|in_roothints
argument_list|)
expr_stmt|;
comment|/* 	 * If we still have no hints, this is a non-IN view with no 	 * "hints zone" configured.  Issue a warning, except if this 	 * is a root server.  Root servers never need to consult 	 * their hints, so it's no point requiring users to configure 	 * them. 	 */
if|if
condition|(
name|view
operator|->
name|hints
operator|==
name|NULL
condition|)
block|{
name|dns_zone_t
modifier|*
name|rootzone
init|=
name|NULL
decl_stmt|;
operator|(
name|void
operator|)
name|dns_view_findzone
argument_list|(
name|view
argument_list|,
name|dns_rootname
argument_list|,
operator|&
name|rootzone
argument_list|)
expr_stmt|;
if|if
condition|(
name|rootzone
operator|!=
name|NULL
condition|)
block|{
name|dns_zone_detach
argument_list|(
operator|&
name|rootzone
argument_list|)
expr_stmt|;
name|need_hints
operator|=
name|ISC_FALSE
expr_stmt|;
block|}
if|if
condition|(
name|need_hints
condition|)
name|isc_log_write
argument_list|(
name|ns_g_lctx
argument_list|,
name|NS_LOGCATEGORY_GENERAL
argument_list|,
name|NS_LOGMODULE_SERVER
argument_list|,
name|ISC_LOG_WARNING
argument_list|,
literal|"no root hints for view '%s'"
argument_list|,
name|view
operator|->
name|name
argument_list|)
expr_stmt|;
block|}
comment|/* 	 * Configure the view's TSIG keys. 	 */
name|ring
operator|=
name|NULL
expr_stmt|;
name|CHECK
argument_list|(
name|ns_tsigkeyring_fromconfig
argument_list|(
name|config
argument_list|,
name|vconfig
argument_list|,
name|view
operator|->
name|mctx
argument_list|,
operator|&
name|ring
argument_list|)
argument_list|)
expr_stmt|;
name|dns_view_setkeyring
argument_list|(
name|view
argument_list|,
name|ring
argument_list|)
expr_stmt|;
comment|/* 	 * Configure the view's peer list. 	 */
block|{
specifier|const
name|cfg_obj_t
modifier|*
name|peers
init|=
name|NULL
decl_stmt|;
specifier|const
name|cfg_listelt_t
modifier|*
name|element
decl_stmt|;
name|dns_peerlist_t
modifier|*
name|newpeers
init|=
name|NULL
decl_stmt|;
operator|(
name|void
operator|)
name|ns_config_get
argument_list|(
name|cfgmaps
argument_list|,
literal|"server"
argument_list|,
operator|&
name|peers
argument_list|)
expr_stmt|;
name|CHECK
argument_list|(
name|dns_peerlist_new
argument_list|(
name|mctx
argument_list|,
operator|&
name|newpeers
argument_list|)
argument_list|)
expr_stmt|;
for|for
control|(
name|element
operator|=
name|cfg_list_first
argument_list|(
name|peers
argument_list|)
init|;
name|element
operator|!=
name|NULL
condition|;
name|element
operator|=
name|cfg_list_next
argument_list|(
name|element
argument_list|)
control|)
block|{
specifier|const
name|cfg_obj_t
modifier|*
name|cpeer
init|=
name|cfg_listelt_value
argument_list|(
name|element
argument_list|)
decl_stmt|;
name|dns_peer_t
modifier|*
name|peer
decl_stmt|;
name|CHECK
argument_list|(
name|configure_peer
argument_list|(
name|cpeer
argument_list|,
name|mctx
argument_list|,
operator|&
name|peer
argument_list|)
argument_list|)
expr_stmt|;
name|dns_peerlist_addpeer
argument_list|(
name|newpeers
argument_list|,
name|peer
argument_list|)
expr_stmt|;
name|dns_peer_detach
argument_list|(
operator|&
name|peer
argument_list|)
expr_stmt|;
block|}
name|dns_peerlist_detach
argument_list|(
operator|&
name|view
operator|->
name|peers
argument_list|)
expr_stmt|;
name|view
operator|->
name|peers
operator|=
name|newpeers
expr_stmt|;
comment|/* Transfer ownership. */
block|}
comment|/* 	 *	Configure the views rrset-order. 	 */
block|{
specifier|const
name|cfg_obj_t
modifier|*
name|rrsetorder
init|=
name|NULL
decl_stmt|;
specifier|const
name|cfg_listelt_t
modifier|*
name|element
decl_stmt|;
operator|(
name|void
operator|)
name|ns_config_get
argument_list|(
name|maps
argument_list|,
literal|"rrset-order"
argument_list|,
operator|&
name|rrsetorder
argument_list|)
expr_stmt|;
name|CHECK
argument_list|(
name|dns_order_create
argument_list|(
name|mctx
argument_list|,
operator|&
name|order
argument_list|)
argument_list|)
expr_stmt|;
for|for
control|(
name|element
operator|=
name|cfg_list_first
argument_list|(
name|rrsetorder
argument_list|)
init|;
name|element
operator|!=
name|NULL
condition|;
name|element
operator|=
name|cfg_list_next
argument_list|(
name|element
argument_list|)
control|)
block|{
specifier|const
name|cfg_obj_t
modifier|*
name|ent
init|=
name|cfg_listelt_value
argument_list|(
name|element
argument_list|)
decl_stmt|;
name|CHECK
argument_list|(
name|configure_order
argument_list|(
name|order
argument_list|,
name|ent
argument_list|)
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|view
operator|->
name|order
operator|!=
name|NULL
condition|)
name|dns_order_detach
argument_list|(
operator|&
name|view
operator|->
name|order
argument_list|)
expr_stmt|;
name|dns_order_attach
argument_list|(
name|order
argument_list|,
operator|&
name|view
operator|->
name|order
argument_list|)
expr_stmt|;
name|dns_order_detach
argument_list|(
operator|&
name|order
argument_list|)
expr_stmt|;
block|}
comment|/* 	 * Copy the aclenv object. 	 */
name|dns_aclenv_copy
argument_list|(
operator|&
name|view
operator|->
name|aclenv
argument_list|,
operator|&
name|ns_g_server
operator|->
name|aclenv
argument_list|)
expr_stmt|;
comment|/* 	 * Configure the "match-clients" and "match-destinations" ACL. 	 */
name|CHECK
argument_list|(
name|configure_view_acl
argument_list|(
name|vconfig
argument_list|,
name|config
argument_list|,
literal|"match-clients"
argument_list|,
name|actx
argument_list|,
name|ns_g_mctx
argument_list|,
operator|&
name|view
operator|->
name|matchclients
argument_list|)
argument_list|)
expr_stmt|;
name|CHECK
argument_list|(
name|configure_view_acl
argument_list|(
name|vconfig
argument_list|,
name|config
argument_list|,
literal|"match-destinations"
argument_list|,
name|actx
argument_list|,
name|ns_g_mctx
argument_list|,
operator|&
name|view
operator|->
name|matchdestinations
argument_list|)
argument_list|)
expr_stmt|;
comment|/* 	 * Configure the "match-recursive-only" option. 	 */
name|obj
operator|=
name|NULL
expr_stmt|;
operator|(
name|void
operator|)
name|ns_config_get
argument_list|(
name|maps
argument_list|,
literal|"match-recursive-only"
argument_list|,
operator|&
name|obj
argument_list|)
expr_stmt|;
if|if
condition|(
name|obj
operator|!=
name|NULL
operator|&&
name|cfg_obj_asboolean
argument_list|(
name|obj
argument_list|)
condition|)
name|view
operator|->
name|matchrecursiveonly
operator|=
name|ISC_TRUE
expr_stmt|;
else|else
name|view
operator|->
name|matchrecursiveonly
operator|=
name|ISC_FALSE
expr_stmt|;
comment|/* 	 * Configure other configurable data. 	 */
name|obj
operator|=
name|NULL
expr_stmt|;
name|result
operator|=
name|ns_config_get
argument_list|(
name|maps
argument_list|,
literal|"recursion"
argument_list|,
operator|&
name|obj
argument_list|)
expr_stmt|;
name|INSIST
argument_list|(
name|result
operator|==
name|ISC_R_SUCCESS
argument_list|)
expr_stmt|;
name|view
operator|->
name|recursion
operator|=
name|cfg_obj_asboolean
argument_list|(
name|obj
argument_list|)
expr_stmt|;
name|obj
operator|=
name|NULL
expr_stmt|;
name|result
operator|=
name|ns_config_get
argument_list|(
name|maps
argument_list|,
literal|"auth-nxdomain"
argument_list|,
operator|&
name|obj
argument_list|)
expr_stmt|;
name|INSIST
argument_list|(
name|result
operator|==
name|ISC_R_SUCCESS
argument_list|)
expr_stmt|;
name|view
operator|->
name|auth_nxdomain
operator|=
name|cfg_obj_asboolean
argument_list|(
name|obj
argument_list|)
expr_stmt|;
name|obj
operator|=
name|NULL
expr_stmt|;
name|result
operator|=
name|ns_config_get
argument_list|(
name|maps
argument_list|,
literal|"minimal-responses"
argument_list|,
operator|&
name|obj
argument_list|)
expr_stmt|;
name|INSIST
argument_list|(
name|result
operator|==
name|ISC_R_SUCCESS
argument_list|)
expr_stmt|;
name|view
operator|->
name|minimalresponses
operator|=
name|cfg_obj_asboolean
argument_list|(
name|obj
argument_list|)
expr_stmt|;
name|obj
operator|=
name|NULL
expr_stmt|;
name|result
operator|=
name|ns_config_get
argument_list|(
name|maps
argument_list|,
literal|"transfer-format"
argument_list|,
operator|&
name|obj
argument_list|)
expr_stmt|;
name|INSIST
argument_list|(
name|result
operator|==
name|ISC_R_SUCCESS
argument_list|)
expr_stmt|;
name|str
operator|=
name|cfg_obj_asstring
argument_list|(
name|obj
argument_list|)
expr_stmt|;
if|if
condition|(
name|strcasecmp
argument_list|(
name|str
argument_list|,
literal|"many-answers"
argument_list|)
operator|==
literal|0
condition|)
name|view
operator|->
name|transfer_format
operator|=
name|dns_many_answers
expr_stmt|;
elseif|else
if|if
condition|(
name|strcasecmp
argument_list|(
name|str
argument_list|,
literal|"one-answer"
argument_list|)
operator|==
literal|0
condition|)
name|view
operator|->
name|transfer_format
operator|=
name|dns_one_answer
expr_stmt|;
else|else
name|INSIST
argument_list|(
literal|0
argument_list|)
expr_stmt|;
comment|/* 	 * Set sources where additional data and CNAME/DNAME 	 * targets for authoritative answers may be found. 	 */
name|obj
operator|=
name|NULL
expr_stmt|;
name|result
operator|=
name|ns_config_get
argument_list|(
name|maps
argument_list|,
literal|"additional-from-auth"
argument_list|,
operator|&
name|obj
argument_list|)
expr_stmt|;
name|INSIST
argument_list|(
name|result
operator|==
name|ISC_R_SUCCESS
argument_list|)
expr_stmt|;
name|view
operator|->
name|additionalfromauth
operator|=
name|cfg_obj_asboolean
argument_list|(
name|obj
argument_list|)
expr_stmt|;
if|if
condition|(
name|view
operator|->
name|recursion
operator|&&
operator|!
name|view
operator|->
name|additionalfromauth
condition|)
block|{
name|cfg_obj_log
argument_list|(
name|obj
argument_list|,
name|ns_g_lctx
argument_list|,
name|ISC_LOG_WARNING
argument_list|,
literal|"'additional-from-auth no' is only supported "
literal|"with 'recursion no'"
argument_list|)
expr_stmt|;
name|view
operator|->
name|additionalfromauth
operator|=
name|ISC_TRUE
expr_stmt|;
block|}
name|obj
operator|=
name|NULL
expr_stmt|;
name|result
operator|=
name|ns_config_get
argument_list|(
name|maps
argument_list|,
literal|"additional-from-cache"
argument_list|,
operator|&
name|obj
argument_list|)
expr_stmt|;
name|INSIST
argument_list|(
name|result
operator|==
name|ISC_R_SUCCESS
argument_list|)
expr_stmt|;
name|view
operator|->
name|additionalfromcache
operator|=
name|cfg_obj_asboolean
argument_list|(
name|obj
argument_list|)
expr_stmt|;
if|if
condition|(
name|view
operator|->
name|recursion
operator|&&
operator|!
name|view
operator|->
name|additionalfromcache
condition|)
block|{
name|cfg_obj_log
argument_list|(
name|obj
argument_list|,
name|ns_g_lctx
argument_list|,
name|ISC_LOG_WARNING
argument_list|,
literal|"'additional-from-cache no' is only supported "
literal|"with 'recursion no'"
argument_list|)
expr_stmt|;
name|view
operator|->
name|additionalfromcache
operator|=
name|ISC_TRUE
expr_stmt|;
block|}
name|CHECK
argument_list|(
name|configure_view_acl
argument_list|(
name|vconfig
argument_list|,
name|config
argument_list|,
literal|"allow-query"
argument_list|,
name|actx
argument_list|,
name|ns_g_mctx
argument_list|,
operator|&
name|view
operator|->
name|queryacl
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|strcmp
argument_list|(
name|view
operator|->
name|name
argument_list|,
literal|"_bind"
argument_list|)
operator|!=
literal|0
condition|)
name|CHECK
argument_list|(
name|configure_view_acl
argument_list|(
name|vconfig
argument_list|,
name|config
argument_list|,
literal|"allow-recursion"
argument_list|,
name|actx
argument_list|,
name|ns_g_mctx
argument_list|,
operator|&
name|view
operator|->
name|recursionacl
argument_list|)
argument_list|)
expr_stmt|;
comment|/* 	 * Warning if both "recursion no;" and allow-recursion are active 	 * except for "allow-recursion { none; };". 	 */
if|if
condition|(
operator|!
name|view
operator|->
name|recursion
operator|&&
name|view
operator|->
name|recursionacl
operator|!=
name|NULL
operator|&&
operator|(
name|view
operator|->
name|recursionacl
operator|->
name|length
operator|!=
literal|1
operator|||
name|view
operator|->
name|recursionacl
operator|->
name|elements
index|[
literal|0
index|]
operator|.
name|type
operator|!=
name|dns_aclelementtype_any
operator|||
name|view
operator|->
name|recursionacl
operator|->
name|elements
index|[
literal|0
index|]
operator|.
name|negative
operator|!=
name|ISC_TRUE
operator|)
condition|)
block|{
specifier|const
name|char
modifier|*
name|forview
init|=
literal|" for view "
decl_stmt|;
specifier|const
name|char
modifier|*
name|viewname
init|=
name|view
operator|->
name|name
decl_stmt|;
if|if
condition|(
operator|!
name|strcmp
argument_list|(
name|view
operator|->
name|name
argument_list|,
literal|"_bind"
argument_list|)
operator|||
operator|!
name|strcmp
argument_list|(
name|view
operator|->
name|name
argument_list|,
literal|"_default"
argument_list|)
condition|)
block|{
name|forview
operator|=
literal|""
expr_stmt|;
name|viewname
operator|=
literal|""
expr_stmt|;
block|}
name|isc_log_write
argument_list|(
name|ns_g_lctx
argument_list|,
name|NS_LOGCATEGORY_GENERAL
argument_list|,
name|NS_LOGMODULE_SERVER
argument_list|,
name|ISC_LOG_WARNING
argument_list|,
literal|"both \"recursion no;\" and \"allow-recursion\" "
literal|"active%s%s"
argument_list|,
name|forview
argument_list|,
name|viewname
argument_list|)
expr_stmt|;
block|}
name|CHECK
argument_list|(
name|configure_view_acl
argument_list|(
name|vconfig
argument_list|,
name|config
argument_list|,
literal|"sortlist"
argument_list|,
name|actx
argument_list|,
name|ns_g_mctx
argument_list|,
operator|&
name|view
operator|->
name|sortlist
argument_list|)
argument_list|)
expr_stmt|;
name|obj
operator|=
name|NULL
expr_stmt|;
name|result
operator|=
name|ns_config_get
argument_list|(
name|maps
argument_list|,
literal|"request-ixfr"
argument_list|,
operator|&
name|obj
argument_list|)
expr_stmt|;
name|INSIST
argument_list|(
name|result
operator|==
name|ISC_R_SUCCESS
argument_list|)
expr_stmt|;
name|view
operator|->
name|requestixfr
operator|=
name|cfg_obj_asboolean
argument_list|(
name|obj
argument_list|)
expr_stmt|;
name|obj
operator|=
name|NULL
expr_stmt|;
name|result
operator|=
name|ns_config_get
argument_list|(
name|maps
argument_list|,
literal|"provide-ixfr"
argument_list|,
operator|&
name|obj
argument_list|)
expr_stmt|;
name|INSIST
argument_list|(
name|result
operator|==
name|ISC_R_SUCCESS
argument_list|)
expr_stmt|;
name|view
operator|->
name|provideixfr
operator|=
name|cfg_obj_asboolean
argument_list|(
name|obj
argument_list|)
expr_stmt|;
name|obj
operator|=
name|NULL
expr_stmt|;
name|result
operator|=
name|ns_config_get
argument_list|(
name|maps
argument_list|,
literal|"dnssec-enable"
argument_list|,
operator|&
name|obj
argument_list|)
expr_stmt|;
name|INSIST
argument_list|(
name|result
operator|==
name|ISC_R_SUCCESS
argument_list|)
expr_stmt|;
name|view
operator|->
name|enablednssec
operator|=
name|cfg_obj_asboolean
argument_list|(
name|obj
argument_list|)
expr_stmt|;
name|obj
operator|=
name|NULL
expr_stmt|;
name|result
operator|=
name|ns_config_get
argument_list|(
name|maps
argument_list|,
literal|"dnssec-lookaside"
argument_list|,
operator|&
name|obj
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|==
name|ISC_R_SUCCESS
condition|)
block|{
for|for
control|(
name|element
operator|=
name|cfg_list_first
argument_list|(
name|obj
argument_list|)
init|;
name|element
operator|!=
name|NULL
condition|;
name|element
operator|=
name|cfg_list_next
argument_list|(
name|element
argument_list|)
control|)
block|{
specifier|const
name|char
modifier|*
name|str
decl_stmt|;
name|isc_buffer_t
name|b
decl_stmt|;
name|dns_name_t
modifier|*
name|dlv
decl_stmt|;
name|obj
operator|=
name|cfg_listelt_value
argument_list|(
name|element
argument_list|)
expr_stmt|;
if|#
directive|if
literal|0
block|dns_fixedname_t fixed; 			dns_name_t *name;
comment|/* 			 * When we support multiple dnssec-lookaside 			 * entries this is how to find the domain to be 			 * checked. XXXMPA 			 */
block|dns_fixedname_init(&fixed); 			name = dns_fixedname_name(&fixed); 			str = cfg_obj_asstring(cfg_tuple_get(obj, 							     "domain")); 			isc_buffer_init(&b, str, strlen(str)); 			isc_buffer_add(&b, strlen(str)); 			CHECK(dns_name_fromtext(name,&b, dns_rootname, 						ISC_TRUE, NULL));
endif|#
directive|endif
name|str
operator|=
name|cfg_obj_asstring
argument_list|(
name|cfg_tuple_get
argument_list|(
name|obj
argument_list|,
literal|"trust-anchor"
argument_list|)
argument_list|)
expr_stmt|;
name|isc_buffer_init
argument_list|(
operator|&
name|b
argument_list|,
name|str
argument_list|,
name|strlen
argument_list|(
name|str
argument_list|)
argument_list|)
expr_stmt|;
name|isc_buffer_add
argument_list|(
operator|&
name|b
argument_list|,
name|strlen
argument_list|(
name|str
argument_list|)
argument_list|)
expr_stmt|;
name|dlv
operator|=
name|dns_fixedname_name
argument_list|(
operator|&
name|view
operator|->
name|dlv_fixed
argument_list|)
expr_stmt|;
name|CHECK
argument_list|(
name|dns_name_fromtext
argument_list|(
name|dlv
argument_list|,
operator|&
name|b
argument_list|,
name|dns_rootname
argument_list|,
name|ISC_TRUE
argument_list|,
name|NULL
argument_list|)
argument_list|)
expr_stmt|;
name|view
operator|->
name|dlv
operator|=
name|dns_fixedname_name
argument_list|(
operator|&
name|view
operator|->
name|dlv_fixed
argument_list|)
expr_stmt|;
block|}
block|}
else|else
name|view
operator|->
name|dlv
operator|=
name|NULL
expr_stmt|;
comment|/* 	 * For now, there is only one kind of trusted keys, the 	 * "security roots". 	 */
if|if
condition|(
name|view
operator|->
name|enablednssec
condition|)
block|{
name|CHECK
argument_list|(
name|configure_view_dnsseckeys
argument_list|(
name|vconfig
argument_list|,
name|config
argument_list|,
name|mctx
argument_list|,
operator|&
name|view
operator|->
name|secroots
argument_list|)
argument_list|)
expr_stmt|;
name|dns_resolver_resetmustbesecure
argument_list|(
name|view
operator|->
name|resolver
argument_list|)
expr_stmt|;
name|obj
operator|=
name|NULL
expr_stmt|;
name|result
operator|=
name|ns_config_get
argument_list|(
name|maps
argument_list|,
literal|"dnssec-must-be-secure"
argument_list|,
operator|&
name|obj
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|==
name|ISC_R_SUCCESS
condition|)
name|CHECK
argument_list|(
name|mustbesecure
argument_list|(
name|obj
argument_list|,
name|view
operator|->
name|resolver
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|obj
operator|=
name|NULL
expr_stmt|;
name|result
operator|=
name|ns_config_get
argument_list|(
name|maps
argument_list|,
literal|"max-cache-ttl"
argument_list|,
operator|&
name|obj
argument_list|)
expr_stmt|;
name|INSIST
argument_list|(
name|result
operator|==
name|ISC_R_SUCCESS
argument_list|)
expr_stmt|;
name|view
operator|->
name|maxcachettl
operator|=
name|cfg_obj_asuint32
argument_list|(
name|obj
argument_list|)
expr_stmt|;
name|obj
operator|=
name|NULL
expr_stmt|;
name|result
operator|=
name|ns_config_get
argument_list|(
name|maps
argument_list|,
literal|"max-ncache-ttl"
argument_list|,
operator|&
name|obj
argument_list|)
expr_stmt|;
name|INSIST
argument_list|(
name|result
operator|==
name|ISC_R_SUCCESS
argument_list|)
expr_stmt|;
name|view
operator|->
name|maxncachettl
operator|=
name|cfg_obj_asuint32
argument_list|(
name|obj
argument_list|)
expr_stmt|;
if|if
condition|(
name|view
operator|->
name|maxncachettl
operator|>
literal|7
operator|*
literal|24
operator|*
literal|3600
condition|)
name|view
operator|->
name|maxncachettl
operator|=
literal|7
operator|*
literal|24
operator|*
literal|3600
expr_stmt|;
name|obj
operator|=
name|NULL
expr_stmt|;
name|result
operator|=
name|ns_config_get
argument_list|(
name|maps
argument_list|,
literal|"preferred-glue"
argument_list|,
operator|&
name|obj
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|==
name|ISC_R_SUCCESS
condition|)
block|{
name|str
operator|=
name|cfg_obj_asstring
argument_list|(
name|obj
argument_list|)
expr_stmt|;
if|if
condition|(
name|strcasecmp
argument_list|(
name|str
argument_list|,
literal|"a"
argument_list|)
operator|==
literal|0
condition|)
name|view
operator|->
name|preferred_glue
operator|=
name|dns_rdatatype_a
expr_stmt|;
elseif|else
if|if
condition|(
name|strcasecmp
argument_list|(
name|str
argument_list|,
literal|"aaaa"
argument_list|)
operator|==
literal|0
condition|)
name|view
operator|->
name|preferred_glue
operator|=
name|dns_rdatatype_aaaa
expr_stmt|;
else|else
name|view
operator|->
name|preferred_glue
operator|=
literal|0
expr_stmt|;
block|}
else|else
name|view
operator|->
name|preferred_glue
operator|=
literal|0
expr_stmt|;
name|obj
operator|=
name|NULL
expr_stmt|;
name|result
operator|=
name|ns_config_get
argument_list|(
name|maps
argument_list|,
literal|"root-delegation-only"
argument_list|,
operator|&
name|obj
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|==
name|ISC_R_SUCCESS
condition|)
block|{
name|dns_view_setrootdelonly
argument_list|(
name|view
argument_list|,
name|ISC_TRUE
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|cfg_obj_isvoid
argument_list|(
name|obj
argument_list|)
condition|)
block|{
name|dns_fixedname_t
name|fixed
decl_stmt|;
name|dns_name_t
modifier|*
name|name
decl_stmt|;
name|isc_buffer_t
name|b
decl_stmt|;
specifier|const
name|char
modifier|*
name|str
decl_stmt|;
specifier|const
name|cfg_obj_t
modifier|*
name|exclude
decl_stmt|;
name|dns_fixedname_init
argument_list|(
operator|&
name|fixed
argument_list|)
expr_stmt|;
name|name
operator|=
name|dns_fixedname_name
argument_list|(
operator|&
name|fixed
argument_list|)
expr_stmt|;
for|for
control|(
name|element
operator|=
name|cfg_list_first
argument_list|(
name|obj
argument_list|)
init|;
name|element
operator|!=
name|NULL
condition|;
name|element
operator|=
name|cfg_list_next
argument_list|(
name|element
argument_list|)
control|)
block|{
name|exclude
operator|=
name|cfg_listelt_value
argument_list|(
name|element
argument_list|)
expr_stmt|;
name|str
operator|=
name|cfg_obj_asstring
argument_list|(
name|exclude
argument_list|)
expr_stmt|;
name|isc_buffer_init
argument_list|(
operator|&
name|b
argument_list|,
name|str
argument_list|,
name|strlen
argument_list|(
name|str
argument_list|)
argument_list|)
expr_stmt|;
name|isc_buffer_add
argument_list|(
operator|&
name|b
argument_list|,
name|strlen
argument_list|(
name|str
argument_list|)
argument_list|)
expr_stmt|;
name|CHECK
argument_list|(
name|dns_name_fromtext
argument_list|(
name|name
argument_list|,
operator|&
name|b
argument_list|,
name|dns_rootname
argument_list|,
name|ISC_FALSE
argument_list|,
name|NULL
argument_list|)
argument_list|)
expr_stmt|;
name|CHECK
argument_list|(
name|dns_view_excludedelegationonly
argument_list|(
name|view
argument_list|,
name|name
argument_list|)
argument_list|)
expr_stmt|;
block|}
block|}
block|}
else|else
name|dns_view_setrootdelonly
argument_list|(
name|view
argument_list|,
name|ISC_FALSE
argument_list|)
expr_stmt|;
name|result
operator|=
name|ISC_R_SUCCESS
expr_stmt|;
name|cleanup
label|:
if|if
condition|(
name|dispatch4
operator|!=
name|NULL
condition|)
name|dns_dispatch_detach
argument_list|(
operator|&
name|dispatch4
argument_list|)
expr_stmt|;
if|if
condition|(
name|dispatch6
operator|!=
name|NULL
condition|)
name|dns_dispatch_detach
argument_list|(
operator|&
name|dispatch6
argument_list|)
expr_stmt|;
if|if
condition|(
name|order
operator|!=
name|NULL
condition|)
name|dns_order_detach
argument_list|(
operator|&
name|order
argument_list|)
expr_stmt|;
if|if
condition|(
name|cmctx
operator|!=
name|NULL
condition|)
name|isc_mem_detach
argument_list|(
operator|&
name|cmctx
argument_list|)
expr_stmt|;
if|if
condition|(
name|cache
operator|!=
name|NULL
condition|)
name|dns_cache_detach
argument_list|(
operator|&
name|cache
argument_list|)
expr_stmt|;
return|return
operator|(
name|result
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|isc_result_t
name|configure_hints
parameter_list|(
name|dns_view_t
modifier|*
name|view
parameter_list|,
specifier|const
name|char
modifier|*
name|filename
parameter_list|)
block|{
name|isc_result_t
name|result
decl_stmt|;
name|dns_db_t
modifier|*
name|db
decl_stmt|;
name|db
operator|=
name|NULL
expr_stmt|;
name|result
operator|=
name|dns_rootns_create
argument_list|(
name|view
operator|->
name|mctx
argument_list|,
name|view
operator|->
name|rdclass
argument_list|,
name|filename
argument_list|,
operator|&
name|db
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|==
name|ISC_R_SUCCESS
condition|)
block|{
name|dns_view_sethints
argument_list|(
name|view
argument_list|,
name|db
argument_list|)
expr_stmt|;
name|dns_db_detach
argument_list|(
operator|&
name|db
argument_list|)
expr_stmt|;
block|}
return|return
operator|(
name|result
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|isc_result_t
name|configure_alternates
parameter_list|(
specifier|const
name|cfg_obj_t
modifier|*
name|config
parameter_list|,
name|dns_view_t
modifier|*
name|view
parameter_list|,
specifier|const
name|cfg_obj_t
modifier|*
name|alternates
parameter_list|)
block|{
specifier|const
name|cfg_obj_t
modifier|*
name|portobj
decl_stmt|;
specifier|const
name|cfg_obj_t
modifier|*
name|addresses
decl_stmt|;
specifier|const
name|cfg_listelt_t
modifier|*
name|element
decl_stmt|;
name|isc_result_t
name|result
init|=
name|ISC_R_SUCCESS
decl_stmt|;
name|in_port_t
name|port
decl_stmt|;
comment|/* 	 * Determine which port to send requests to. 	 */
if|if
condition|(
name|ns_g_lwresdonly
operator|&&
name|ns_g_port
operator|!=
literal|0
condition|)
name|port
operator|=
name|ns_g_port
expr_stmt|;
else|else
name|CHECKM
argument_list|(
name|ns_config_getport
argument_list|(
name|config
argument_list|,
operator|&
name|port
argument_list|)
argument_list|,
literal|"port"
argument_list|)
expr_stmt|;
if|if
condition|(
name|alternates
operator|!=
name|NULL
condition|)
block|{
name|portobj
operator|=
name|cfg_tuple_get
argument_list|(
name|alternates
argument_list|,
literal|"port"
argument_list|)
expr_stmt|;
if|if
condition|(
name|cfg_obj_isuint32
argument_list|(
name|portobj
argument_list|)
condition|)
block|{
name|isc_uint32_t
name|val
init|=
name|cfg_obj_asuint32
argument_list|(
name|portobj
argument_list|)
decl_stmt|;
if|if
condition|(
name|val
operator|>
name|ISC_UINT16_MAX
condition|)
block|{
name|cfg_obj_log
argument_list|(
name|portobj
argument_list|,
name|ns_g_lctx
argument_list|,
name|ISC_LOG_ERROR
argument_list|,
literal|"port '%u' out of range"
argument_list|,
name|val
argument_list|)
expr_stmt|;
return|return
operator|(
name|ISC_R_RANGE
operator|)
return|;
block|}
name|port
operator|=
operator|(
name|in_port_t
operator|)
name|val
expr_stmt|;
block|}
block|}
name|addresses
operator|=
name|NULL
expr_stmt|;
if|if
condition|(
name|alternates
operator|!=
name|NULL
condition|)
name|addresses
operator|=
name|cfg_tuple_get
argument_list|(
name|alternates
argument_list|,
literal|"addresses"
argument_list|)
expr_stmt|;
for|for
control|(
name|element
operator|=
name|cfg_list_first
argument_list|(
name|addresses
argument_list|)
init|;
name|element
operator|!=
name|NULL
condition|;
name|element
operator|=
name|cfg_list_next
argument_list|(
name|element
argument_list|)
control|)
block|{
specifier|const
name|cfg_obj_t
modifier|*
name|alternate
init|=
name|cfg_listelt_value
argument_list|(
name|element
argument_list|)
decl_stmt|;
name|isc_sockaddr_t
name|sa
decl_stmt|;
if|if
condition|(
operator|!
name|cfg_obj_issockaddr
argument_list|(
name|alternate
argument_list|)
condition|)
block|{
name|dns_fixedname_t
name|fixed
decl_stmt|;
name|dns_name_t
modifier|*
name|name
decl_stmt|;
specifier|const
name|char
modifier|*
name|str
init|=
name|cfg_obj_asstring
argument_list|(
name|cfg_tuple_get
argument_list|(
name|alternate
argument_list|,
literal|"name"
argument_list|)
argument_list|)
decl_stmt|;
name|isc_buffer_t
name|buffer
decl_stmt|;
name|in_port_t
name|myport
init|=
name|port
decl_stmt|;
name|isc_buffer_init
argument_list|(
operator|&
name|buffer
argument_list|,
name|str
argument_list|,
name|strlen
argument_list|(
name|str
argument_list|)
argument_list|)
expr_stmt|;
name|isc_buffer_add
argument_list|(
operator|&
name|buffer
argument_list|,
name|strlen
argument_list|(
name|str
argument_list|)
argument_list|)
expr_stmt|;
name|dns_fixedname_init
argument_list|(
operator|&
name|fixed
argument_list|)
expr_stmt|;
name|name
operator|=
name|dns_fixedname_name
argument_list|(
operator|&
name|fixed
argument_list|)
expr_stmt|;
name|CHECK
argument_list|(
name|dns_name_fromtext
argument_list|(
name|name
argument_list|,
operator|&
name|buffer
argument_list|,
name|dns_rootname
argument_list|,
name|ISC_FALSE
argument_list|,
name|NULL
argument_list|)
argument_list|)
expr_stmt|;
name|portobj
operator|=
name|cfg_tuple_get
argument_list|(
name|alternate
argument_list|,
literal|"port"
argument_list|)
expr_stmt|;
if|if
condition|(
name|cfg_obj_isuint32
argument_list|(
name|portobj
argument_list|)
condition|)
block|{
name|isc_uint32_t
name|val
init|=
name|cfg_obj_asuint32
argument_list|(
name|portobj
argument_list|)
decl_stmt|;
if|if
condition|(
name|val
operator|>
name|ISC_UINT16_MAX
condition|)
block|{
name|cfg_obj_log
argument_list|(
name|portobj
argument_list|,
name|ns_g_lctx
argument_list|,
name|ISC_LOG_ERROR
argument_list|,
literal|"port '%u' out of range"
argument_list|,
name|val
argument_list|)
expr_stmt|;
return|return
operator|(
name|ISC_R_RANGE
operator|)
return|;
block|}
name|myport
operator|=
operator|(
name|in_port_t
operator|)
name|val
expr_stmt|;
block|}
name|CHECK
argument_list|(
name|dns_resolver_addalternate
argument_list|(
name|view
operator|->
name|resolver
argument_list|,
name|NULL
argument_list|,
name|name
argument_list|,
name|myport
argument_list|)
argument_list|)
expr_stmt|;
continue|continue;
block|}
name|sa
operator|=
operator|*
name|cfg_obj_assockaddr
argument_list|(
name|alternate
argument_list|)
expr_stmt|;
if|if
condition|(
name|isc_sockaddr_getport
argument_list|(
operator|&
name|sa
argument_list|)
operator|==
literal|0
condition|)
name|isc_sockaddr_setport
argument_list|(
operator|&
name|sa
argument_list|,
name|port
argument_list|)
expr_stmt|;
name|CHECK
argument_list|(
name|dns_resolver_addalternate
argument_list|(
name|view
operator|->
name|resolver
argument_list|,
operator|&
name|sa
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|cleanup
label|:
return|return
operator|(
name|result
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|isc_result_t
name|configure_forward
parameter_list|(
specifier|const
name|cfg_obj_t
modifier|*
name|config
parameter_list|,
name|dns_view_t
modifier|*
name|view
parameter_list|,
name|dns_name_t
modifier|*
name|origin
parameter_list|,
specifier|const
name|cfg_obj_t
modifier|*
name|forwarders
parameter_list|,
specifier|const
name|cfg_obj_t
modifier|*
name|forwardtype
parameter_list|)
block|{
specifier|const
name|cfg_obj_t
modifier|*
name|portobj
decl_stmt|;
specifier|const
name|cfg_obj_t
modifier|*
name|faddresses
decl_stmt|;
specifier|const
name|cfg_listelt_t
modifier|*
name|element
decl_stmt|;
name|dns_fwdpolicy_t
name|fwdpolicy
init|=
name|dns_fwdpolicy_none
decl_stmt|;
name|isc_sockaddrlist_t
name|addresses
decl_stmt|;
name|isc_sockaddr_t
modifier|*
name|sa
decl_stmt|;
name|isc_result_t
name|result
decl_stmt|;
name|in_port_t
name|port
decl_stmt|;
comment|/* 	 * Determine which port to send forwarded requests to. 	 */
if|if
condition|(
name|ns_g_lwresdonly
operator|&&
name|ns_g_port
operator|!=
literal|0
condition|)
name|port
operator|=
name|ns_g_port
expr_stmt|;
else|else
name|CHECKM
argument_list|(
name|ns_config_getport
argument_list|(
name|config
argument_list|,
operator|&
name|port
argument_list|)
argument_list|,
literal|"port"
argument_list|)
expr_stmt|;
if|if
condition|(
name|forwarders
operator|!=
name|NULL
condition|)
block|{
name|portobj
operator|=
name|cfg_tuple_get
argument_list|(
name|forwarders
argument_list|,
literal|"port"
argument_list|)
expr_stmt|;
if|if
condition|(
name|cfg_obj_isuint32
argument_list|(
name|portobj
argument_list|)
condition|)
block|{
name|isc_uint32_t
name|val
init|=
name|cfg_obj_asuint32
argument_list|(
name|portobj
argument_list|)
decl_stmt|;
if|if
condition|(
name|val
operator|>
name|ISC_UINT16_MAX
condition|)
block|{
name|cfg_obj_log
argument_list|(
name|portobj
argument_list|,
name|ns_g_lctx
argument_list|,
name|ISC_LOG_ERROR
argument_list|,
literal|"port '%u' out of range"
argument_list|,
name|val
argument_list|)
expr_stmt|;
return|return
operator|(
name|ISC_R_RANGE
operator|)
return|;
block|}
name|port
operator|=
operator|(
name|in_port_t
operator|)
name|val
expr_stmt|;
block|}
block|}
name|faddresses
operator|=
name|NULL
expr_stmt|;
if|if
condition|(
name|forwarders
operator|!=
name|NULL
condition|)
name|faddresses
operator|=
name|cfg_tuple_get
argument_list|(
name|forwarders
argument_list|,
literal|"addresses"
argument_list|)
expr_stmt|;
name|ISC_LIST_INIT
argument_list|(
name|addresses
argument_list|)
expr_stmt|;
for|for
control|(
name|element
operator|=
name|cfg_list_first
argument_list|(
name|faddresses
argument_list|)
init|;
name|element
operator|!=
name|NULL
condition|;
name|element
operator|=
name|cfg_list_next
argument_list|(
name|element
argument_list|)
control|)
block|{
specifier|const
name|cfg_obj_t
modifier|*
name|forwarder
init|=
name|cfg_listelt_value
argument_list|(
name|element
argument_list|)
decl_stmt|;
name|sa
operator|=
name|isc_mem_get
argument_list|(
name|view
operator|->
name|mctx
argument_list|,
sizeof|sizeof
argument_list|(
name|isc_sockaddr_t
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|sa
operator|==
name|NULL
condition|)
block|{
name|result
operator|=
name|ISC_R_NOMEMORY
expr_stmt|;
goto|goto
name|cleanup
goto|;
block|}
operator|*
name|sa
operator|=
operator|*
name|cfg_obj_assockaddr
argument_list|(
name|forwarder
argument_list|)
expr_stmt|;
if|if
condition|(
name|isc_sockaddr_getport
argument_list|(
name|sa
argument_list|)
operator|==
literal|0
condition|)
name|isc_sockaddr_setport
argument_list|(
name|sa
argument_list|,
name|port
argument_list|)
expr_stmt|;
name|ISC_LINK_INIT
argument_list|(
name|sa
argument_list|,
name|link
argument_list|)
expr_stmt|;
name|ISC_LIST_APPEND
argument_list|(
name|addresses
argument_list|,
name|sa
argument_list|,
name|link
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|ISC_LIST_EMPTY
argument_list|(
name|addresses
argument_list|)
condition|)
block|{
if|if
condition|(
name|forwardtype
operator|!=
name|NULL
condition|)
name|cfg_obj_log
argument_list|(
name|forwarders
argument_list|,
name|ns_g_lctx
argument_list|,
name|ISC_LOG_WARNING
argument_list|,
literal|"no forwarders seen; disabling "
literal|"forwarding"
argument_list|)
expr_stmt|;
name|fwdpolicy
operator|=
name|dns_fwdpolicy_none
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|forwardtype
operator|==
name|NULL
condition|)
name|fwdpolicy
operator|=
name|dns_fwdpolicy_first
expr_stmt|;
else|else
block|{
specifier|const
name|char
modifier|*
name|forwardstr
init|=
name|cfg_obj_asstring
argument_list|(
name|forwardtype
argument_list|)
decl_stmt|;
if|if
condition|(
name|strcasecmp
argument_list|(
name|forwardstr
argument_list|,
literal|"first"
argument_list|)
operator|==
literal|0
condition|)
name|fwdpolicy
operator|=
name|dns_fwdpolicy_first
expr_stmt|;
elseif|else
if|if
condition|(
name|strcasecmp
argument_list|(
name|forwardstr
argument_list|,
literal|"only"
argument_list|)
operator|==
literal|0
condition|)
name|fwdpolicy
operator|=
name|dns_fwdpolicy_only
expr_stmt|;
else|else
name|INSIST
argument_list|(
literal|0
argument_list|)
expr_stmt|;
block|}
block|}
name|result
operator|=
name|dns_fwdtable_add
argument_list|(
name|view
operator|->
name|fwdtable
argument_list|,
name|origin
argument_list|,
operator|&
name|addresses
argument_list|,
name|fwdpolicy
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
block|{
name|char
name|namebuf
index|[
name|DNS_NAME_FORMATSIZE
index|]
decl_stmt|;
name|dns_name_format
argument_list|(
name|origin
argument_list|,
name|namebuf
argument_list|,
sizeof|sizeof
argument_list|(
name|namebuf
argument_list|)
argument_list|)
expr_stmt|;
name|cfg_obj_log
argument_list|(
name|forwarders
argument_list|,
name|ns_g_lctx
argument_list|,
name|ISC_LOG_WARNING
argument_list|,
literal|"could not set up forwarding for domain '%s': %s"
argument_list|,
name|namebuf
argument_list|,
name|isc_result_totext
argument_list|(
name|result
argument_list|)
argument_list|)
expr_stmt|;
goto|goto
name|cleanup
goto|;
block|}
name|result
operator|=
name|ISC_R_SUCCESS
expr_stmt|;
name|cleanup
label|:
while|while
condition|(
operator|!
name|ISC_LIST_EMPTY
argument_list|(
name|addresses
argument_list|)
condition|)
block|{
name|sa
operator|=
name|ISC_LIST_HEAD
argument_list|(
name|addresses
argument_list|)
expr_stmt|;
name|ISC_LIST_UNLINK
argument_list|(
name|addresses
argument_list|,
name|sa
argument_list|,
name|link
argument_list|)
expr_stmt|;
name|isc_mem_put
argument_list|(
name|view
operator|->
name|mctx
argument_list|,
name|sa
argument_list|,
sizeof|sizeof
argument_list|(
name|isc_sockaddr_t
argument_list|)
argument_list|)
expr_stmt|;
block|}
return|return
operator|(
name|result
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Create a new view and add it to the list.  *  * If 'vconfig' is NULL, create the default view.  *  * The view created is attached to '*viewp'.  */
end_comment

begin_function
specifier|static
name|isc_result_t
name|create_view
parameter_list|(
specifier|const
name|cfg_obj_t
modifier|*
name|vconfig
parameter_list|,
name|dns_viewlist_t
modifier|*
name|viewlist
parameter_list|,
name|dns_view_t
modifier|*
modifier|*
name|viewp
parameter_list|)
block|{
name|isc_result_t
name|result
decl_stmt|;
specifier|const
name|char
modifier|*
name|viewname
decl_stmt|;
name|dns_rdataclass_t
name|viewclass
decl_stmt|;
name|dns_view_t
modifier|*
name|view
init|=
name|NULL
decl_stmt|;
if|if
condition|(
name|vconfig
operator|!=
name|NULL
condition|)
block|{
specifier|const
name|cfg_obj_t
modifier|*
name|classobj
init|=
name|NULL
decl_stmt|;
name|viewname
operator|=
name|cfg_obj_asstring
argument_list|(
name|cfg_tuple_get
argument_list|(
name|vconfig
argument_list|,
literal|"name"
argument_list|)
argument_list|)
expr_stmt|;
name|classobj
operator|=
name|cfg_tuple_get
argument_list|(
name|vconfig
argument_list|,
literal|"class"
argument_list|)
expr_stmt|;
name|result
operator|=
name|ns_config_getclass
argument_list|(
name|classobj
argument_list|,
name|dns_rdataclass_in
argument_list|,
operator|&
name|viewclass
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|viewname
operator|=
literal|"_default"
expr_stmt|;
name|viewclass
operator|=
name|dns_rdataclass_in
expr_stmt|;
block|}
name|result
operator|=
name|dns_viewlist_find
argument_list|(
name|viewlist
argument_list|,
name|viewname
argument_list|,
name|viewclass
argument_list|,
operator|&
name|view
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|==
name|ISC_R_SUCCESS
condition|)
return|return
operator|(
name|ISC_R_EXISTS
operator|)
return|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_NOTFOUND
condition|)
return|return
operator|(
name|result
operator|)
return|;
name|INSIST
argument_list|(
name|view
operator|==
name|NULL
argument_list|)
expr_stmt|;
name|result
operator|=
name|dns_view_create
argument_list|(
name|ns_g_mctx
argument_list|,
name|viewclass
argument_list|,
name|viewname
argument_list|,
operator|&
name|view
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
return|return
operator|(
name|result
operator|)
return|;
name|ISC_LIST_APPEND
argument_list|(
operator|*
name|viewlist
argument_list|,
name|view
argument_list|,
name|link
argument_list|)
expr_stmt|;
name|dns_view_attach
argument_list|(
name|view
argument_list|,
name|viewp
argument_list|)
expr_stmt|;
return|return
operator|(
name|ISC_R_SUCCESS
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Configure or reconfigure a zone.  */
end_comment

begin_function
specifier|static
name|isc_result_t
name|configure_zone
parameter_list|(
specifier|const
name|cfg_obj_t
modifier|*
name|config
parameter_list|,
specifier|const
name|cfg_obj_t
modifier|*
name|zconfig
parameter_list|,
specifier|const
name|cfg_obj_t
modifier|*
name|vconfig
parameter_list|,
name|isc_mem_t
modifier|*
name|mctx
parameter_list|,
name|dns_view_t
modifier|*
name|view
parameter_list|,
name|ns_aclconfctx_t
modifier|*
name|aclconf
parameter_list|)
block|{
name|dns_view_t
modifier|*
name|pview
init|=
name|NULL
decl_stmt|;
comment|/* Production view */
name|dns_zone_t
modifier|*
name|zone
init|=
name|NULL
decl_stmt|;
comment|/* New or reused zone */
name|dns_zone_t
modifier|*
name|dupzone
init|=
name|NULL
decl_stmt|;
specifier|const
name|cfg_obj_t
modifier|*
name|options
init|=
name|NULL
decl_stmt|;
specifier|const
name|cfg_obj_t
modifier|*
name|zoptions
init|=
name|NULL
decl_stmt|;
specifier|const
name|cfg_obj_t
modifier|*
name|typeobj
init|=
name|NULL
decl_stmt|;
specifier|const
name|cfg_obj_t
modifier|*
name|forwarders
init|=
name|NULL
decl_stmt|;
specifier|const
name|cfg_obj_t
modifier|*
name|forwardtype
init|=
name|NULL
decl_stmt|;
specifier|const
name|cfg_obj_t
modifier|*
name|only
init|=
name|NULL
decl_stmt|;
name|isc_result_t
name|result
decl_stmt|;
name|isc_result_t
name|tresult
decl_stmt|;
name|isc_buffer_t
name|buffer
decl_stmt|;
name|dns_fixedname_t
name|fixorigin
decl_stmt|;
name|dns_name_t
modifier|*
name|origin
decl_stmt|;
specifier|const
name|char
modifier|*
name|zname
decl_stmt|;
name|dns_rdataclass_t
name|zclass
decl_stmt|;
specifier|const
name|char
modifier|*
name|ztypestr
decl_stmt|;
name|options
operator|=
name|NULL
expr_stmt|;
operator|(
name|void
operator|)
name|cfg_map_get
argument_list|(
name|config
argument_list|,
literal|"options"
argument_list|,
operator|&
name|options
argument_list|)
expr_stmt|;
name|zoptions
operator|=
name|cfg_tuple_get
argument_list|(
name|zconfig
argument_list|,
literal|"options"
argument_list|)
expr_stmt|;
comment|/* 	 * Get the zone origin as a dns_name_t. 	 */
name|zname
operator|=
name|cfg_obj_asstring
argument_list|(
name|cfg_tuple_get
argument_list|(
name|zconfig
argument_list|,
literal|"name"
argument_list|)
argument_list|)
expr_stmt|;
name|isc_buffer_init
argument_list|(
operator|&
name|buffer
argument_list|,
name|zname
argument_list|,
name|strlen
argument_list|(
name|zname
argument_list|)
argument_list|)
expr_stmt|;
name|isc_buffer_add
argument_list|(
operator|&
name|buffer
argument_list|,
name|strlen
argument_list|(
name|zname
argument_list|)
argument_list|)
expr_stmt|;
name|dns_fixedname_init
argument_list|(
operator|&
name|fixorigin
argument_list|)
expr_stmt|;
name|CHECK
argument_list|(
name|dns_name_fromtext
argument_list|(
name|dns_fixedname_name
argument_list|(
operator|&
name|fixorigin
argument_list|)
argument_list|,
operator|&
name|buffer
argument_list|,
name|dns_rootname
argument_list|,
name|ISC_FALSE
argument_list|,
name|NULL
argument_list|)
argument_list|)
expr_stmt|;
name|origin
operator|=
name|dns_fixedname_name
argument_list|(
operator|&
name|fixorigin
argument_list|)
expr_stmt|;
name|CHECK
argument_list|(
name|ns_config_getclass
argument_list|(
name|cfg_tuple_get
argument_list|(
name|zconfig
argument_list|,
literal|"class"
argument_list|)
argument_list|,
name|view
operator|->
name|rdclass
argument_list|,
operator|&
name|zclass
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|zclass
operator|!=
name|view
operator|->
name|rdclass
condition|)
block|{
specifier|const
name|char
modifier|*
name|vname
init|=
name|NULL
decl_stmt|;
if|if
condition|(
name|vconfig
operator|!=
name|NULL
condition|)
name|vname
operator|=
name|cfg_obj_asstring
argument_list|(
name|cfg_tuple_get
argument_list|(
name|vconfig
argument_list|,
literal|"name"
argument_list|)
argument_list|)
expr_stmt|;
else|else
name|vname
operator|=
literal|"<default view>"
expr_stmt|;
name|isc_log_write
argument_list|(
name|ns_g_lctx
argument_list|,
name|NS_LOGCATEGORY_GENERAL
argument_list|,
name|NS_LOGMODULE_SERVER
argument_list|,
name|ISC_LOG_ERROR
argument_list|,
literal|"zone '%s': wrong class for view '%s'"
argument_list|,
name|zname
argument_list|,
name|vname
argument_list|)
expr_stmt|;
name|result
operator|=
name|ISC_R_FAILURE
expr_stmt|;
goto|goto
name|cleanup
goto|;
block|}
operator|(
name|void
operator|)
name|cfg_map_get
argument_list|(
name|zoptions
argument_list|,
literal|"type"
argument_list|,
operator|&
name|typeobj
argument_list|)
expr_stmt|;
if|if
condition|(
name|typeobj
operator|==
name|NULL
condition|)
block|{
name|cfg_obj_log
argument_list|(
name|zconfig
argument_list|,
name|ns_g_lctx
argument_list|,
name|ISC_LOG_ERROR
argument_list|,
literal|"zone '%s' 'type' not specified"
argument_list|,
name|zname
argument_list|)
expr_stmt|;
return|return
operator|(
name|ISC_R_FAILURE
operator|)
return|;
block|}
name|ztypestr
operator|=
name|cfg_obj_asstring
argument_list|(
name|typeobj
argument_list|)
expr_stmt|;
comment|/* 	 * "hints zones" aren't zones.  If we've got one, 	 * configure it and return. 	 */
if|if
condition|(
name|strcasecmp
argument_list|(
name|ztypestr
argument_list|,
literal|"hint"
argument_list|)
operator|==
literal|0
condition|)
block|{
specifier|const
name|cfg_obj_t
modifier|*
name|fileobj
init|=
name|NULL
decl_stmt|;
if|if
condition|(
name|cfg_map_get
argument_list|(
name|zoptions
argument_list|,
literal|"file"
argument_list|,
operator|&
name|fileobj
argument_list|)
operator|!=
name|ISC_R_SUCCESS
condition|)
block|{
name|isc_log_write
argument_list|(
name|ns_g_lctx
argument_list|,
name|NS_LOGCATEGORY_GENERAL
argument_list|,
name|NS_LOGMODULE_SERVER
argument_list|,
name|ISC_LOG_ERROR
argument_list|,
literal|"zone '%s': 'file' not specified"
argument_list|,
name|zname
argument_list|)
expr_stmt|;
name|result
operator|=
name|ISC_R_FAILURE
expr_stmt|;
goto|goto
name|cleanup
goto|;
block|}
if|if
condition|(
name|dns_name_equal
argument_list|(
name|origin
argument_list|,
name|dns_rootname
argument_list|)
condition|)
block|{
specifier|const
name|char
modifier|*
name|hintsfile
init|=
name|cfg_obj_asstring
argument_list|(
name|fileobj
argument_list|)
decl_stmt|;
name|result
operator|=
name|configure_hints
argument_list|(
name|view
argument_list|,
name|hintsfile
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
block|{
name|isc_log_write
argument_list|(
name|ns_g_lctx
argument_list|,
name|NS_LOGCATEGORY_GENERAL
argument_list|,
name|NS_LOGMODULE_SERVER
argument_list|,
name|ISC_LOG_ERROR
argument_list|,
literal|"could not configure root hints "
literal|"from '%s': %s"
argument_list|,
name|hintsfile
argument_list|,
name|isc_result_totext
argument_list|(
name|result
argument_list|)
argument_list|)
expr_stmt|;
goto|goto
name|cleanup
goto|;
block|}
comment|/* 			 * Hint zones may also refer to delegation only points. 			 */
name|only
operator|=
name|NULL
expr_stmt|;
name|tresult
operator|=
name|cfg_map_get
argument_list|(
name|zoptions
argument_list|,
literal|"delegation-only"
argument_list|,
operator|&
name|only
argument_list|)
expr_stmt|;
if|if
condition|(
name|tresult
operator|==
name|ISC_R_SUCCESS
operator|&&
name|cfg_obj_asboolean
argument_list|(
name|only
argument_list|)
condition|)
name|CHECK
argument_list|(
name|dns_view_adddelegationonly
argument_list|(
name|view
argument_list|,
name|origin
argument_list|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|isc_log_write
argument_list|(
name|ns_g_lctx
argument_list|,
name|NS_LOGCATEGORY_GENERAL
argument_list|,
name|NS_LOGMODULE_SERVER
argument_list|,
name|ISC_LOG_WARNING
argument_list|,
literal|"ignoring non-root hint zone '%s'"
argument_list|,
name|zname
argument_list|)
expr_stmt|;
name|result
operator|=
name|ISC_R_SUCCESS
expr_stmt|;
block|}
comment|/* Skip ordinary zone processing. */
goto|goto
name|cleanup
goto|;
block|}
comment|/* 	 * "forward zones" aren't zones either.  Translate this syntax into 	 * the appropriate selective forwarding configuration and return. 	 */
if|if
condition|(
name|strcasecmp
argument_list|(
name|ztypestr
argument_list|,
literal|"forward"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|forwardtype
operator|=
name|NULL
expr_stmt|;
name|forwarders
operator|=
name|NULL
expr_stmt|;
operator|(
name|void
operator|)
name|cfg_map_get
argument_list|(
name|zoptions
argument_list|,
literal|"forward"
argument_list|,
operator|&
name|forwardtype
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|cfg_map_get
argument_list|(
name|zoptions
argument_list|,
literal|"forwarders"
argument_list|,
operator|&
name|forwarders
argument_list|)
expr_stmt|;
name|result
operator|=
name|configure_forward
argument_list|(
name|config
argument_list|,
name|view
argument_list|,
name|origin
argument_list|,
name|forwarders
argument_list|,
name|forwardtype
argument_list|)
expr_stmt|;
goto|goto
name|cleanup
goto|;
block|}
comment|/* 	 * "delegation-only zones" aren't zones either. 	 */
if|if
condition|(
name|strcasecmp
argument_list|(
name|ztypestr
argument_list|,
literal|"delegation-only"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|result
operator|=
name|dns_view_adddelegationonly
argument_list|(
name|view
argument_list|,
name|origin
argument_list|)
expr_stmt|;
goto|goto
name|cleanup
goto|;
block|}
comment|/* 	 * Check for duplicates in the new zone table. 	 */
name|result
operator|=
name|dns_view_findzone
argument_list|(
name|view
argument_list|,
name|origin
argument_list|,
operator|&
name|dupzone
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|==
name|ISC_R_SUCCESS
condition|)
block|{
comment|/* 		 * We already have this zone! 		 */
name|cfg_obj_log
argument_list|(
name|zconfig
argument_list|,
name|ns_g_lctx
argument_list|,
name|ISC_LOG_ERROR
argument_list|,
literal|"zone '%s' already exists"
argument_list|,
name|zname
argument_list|)
expr_stmt|;
name|dns_zone_detach
argument_list|(
operator|&
name|dupzone
argument_list|)
expr_stmt|;
name|result
operator|=
name|ISC_R_EXISTS
expr_stmt|;
goto|goto
name|cleanup
goto|;
block|}
name|INSIST
argument_list|(
name|dupzone
operator|==
name|NULL
argument_list|)
expr_stmt|;
comment|/* 	 * See if we can reuse an existing zone.  This is 	 * only possible if all of these are true: 	 *   - The zone's view exists 	 *   - A zone with the right name exists in the view 	 *   - The zone is compatible with the config 	 *     options (e.g., an existing master zone cannot 	 *     be reused if the options specify a slave zone) 	 */
name|result
operator|=
name|dns_viewlist_find
argument_list|(
operator|&
name|ns_g_server
operator|->
name|viewlist
argument_list|,
name|view
operator|->
name|name
argument_list|,
name|view
operator|->
name|rdclass
argument_list|,
operator|&
name|pview
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_NOTFOUND
operator|&&
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
goto|goto
name|cleanup
goto|;
if|if
condition|(
name|pview
operator|!=
name|NULL
condition|)
name|result
operator|=
name|dns_view_findzone
argument_list|(
name|pview
argument_list|,
name|origin
argument_list|,
operator|&
name|zone
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_NOTFOUND
operator|&&
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
goto|goto
name|cleanup
goto|;
if|if
condition|(
name|zone
operator|!=
name|NULL
condition|)
block|{
if|if
condition|(
operator|!
name|ns_zone_reusable
argument_list|(
name|zone
argument_list|,
name|zconfig
argument_list|)
condition|)
name|dns_zone_detach
argument_list|(
operator|&
name|zone
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|zone
operator|!=
name|NULL
condition|)
block|{
comment|/* 		 * We found a reusable zone.  Make it use the 		 * new view. 		 */
name|dns_zone_setview
argument_list|(
name|zone
argument_list|,
name|view
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|/* 		 * We cannot reuse an existing zone, we have 		 * to create a new one. 		 */
name|CHECK
argument_list|(
name|dns_zone_create
argument_list|(
operator|&
name|zone
argument_list|,
name|mctx
argument_list|)
argument_list|)
expr_stmt|;
name|CHECK
argument_list|(
name|dns_zone_setorigin
argument_list|(
name|zone
argument_list|,
name|origin
argument_list|)
argument_list|)
expr_stmt|;
name|dns_zone_setview
argument_list|(
name|zone
argument_list|,
name|view
argument_list|)
expr_stmt|;
name|CHECK
argument_list|(
name|dns_zonemgr_managezone
argument_list|(
name|ns_g_server
operator|->
name|zonemgr
argument_list|,
name|zone
argument_list|)
argument_list|)
expr_stmt|;
block|}
comment|/* 	 * If the zone contains a 'forwarders' statement, configure 	 * selective forwarding. 	 */
name|forwarders
operator|=
name|NULL
expr_stmt|;
if|if
condition|(
name|cfg_map_get
argument_list|(
name|zoptions
argument_list|,
literal|"forwarders"
argument_list|,
operator|&
name|forwarders
argument_list|)
operator|==
name|ISC_R_SUCCESS
condition|)
block|{
name|forwardtype
operator|=
name|NULL
expr_stmt|;
operator|(
name|void
operator|)
name|cfg_map_get
argument_list|(
name|zoptions
argument_list|,
literal|"forward"
argument_list|,
operator|&
name|forwardtype
argument_list|)
expr_stmt|;
name|CHECK
argument_list|(
name|configure_forward
argument_list|(
name|config
argument_list|,
name|view
argument_list|,
name|origin
argument_list|,
name|forwarders
argument_list|,
name|forwardtype
argument_list|)
argument_list|)
expr_stmt|;
block|}
comment|/* 	 * Stub and forward zones may also refer to delegation only points. 	 */
name|only
operator|=
name|NULL
expr_stmt|;
if|if
condition|(
name|cfg_map_get
argument_list|(
name|zoptions
argument_list|,
literal|"delegation-only"
argument_list|,
operator|&
name|only
argument_list|)
operator|==
name|ISC_R_SUCCESS
condition|)
block|{
if|if
condition|(
name|cfg_obj_asboolean
argument_list|(
name|only
argument_list|)
condition|)
name|CHECK
argument_list|(
name|dns_view_adddelegationonly
argument_list|(
name|view
argument_list|,
name|origin
argument_list|)
argument_list|)
expr_stmt|;
block|}
comment|/* 	 * Configure the zone. 	 */
name|CHECK
argument_list|(
name|ns_zone_configure
argument_list|(
name|config
argument_list|,
name|vconfig
argument_list|,
name|zconfig
argument_list|,
name|aclconf
argument_list|,
name|zone
argument_list|)
argument_list|)
expr_stmt|;
comment|/* 	 * Add the zone to its view in the new view list. 	 */
name|CHECK
argument_list|(
name|dns_view_addzone
argument_list|(
name|view
argument_list|,
name|zone
argument_list|)
argument_list|)
expr_stmt|;
name|cleanup
label|:
if|if
condition|(
name|zone
operator|!=
name|NULL
condition|)
name|dns_zone_detach
argument_list|(
operator|&
name|zone
argument_list|)
expr_stmt|;
if|if
condition|(
name|pview
operator|!=
name|NULL
condition|)
name|dns_view_detach
argument_list|(
operator|&
name|pview
argument_list|)
expr_stmt|;
return|return
operator|(
name|result
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Configure a single server quota.  */
end_comment

begin_function
specifier|static
name|void
name|configure_server_quota
parameter_list|(
specifier|const
name|cfg_obj_t
modifier|*
modifier|*
name|maps
parameter_list|,
specifier|const
name|char
modifier|*
name|name
parameter_list|,
name|isc_quota_t
modifier|*
name|quota
parameter_list|)
block|{
specifier|const
name|cfg_obj_t
modifier|*
name|obj
init|=
name|NULL
decl_stmt|;
name|isc_result_t
name|result
decl_stmt|;
name|result
operator|=
name|ns_config_get
argument_list|(
name|maps
argument_list|,
name|name
argument_list|,
operator|&
name|obj
argument_list|)
expr_stmt|;
name|INSIST
argument_list|(
name|result
operator|==
name|ISC_R_SUCCESS
argument_list|)
expr_stmt|;
name|isc_quota_max
argument_list|(
name|quota
argument_list|,
name|cfg_obj_asuint32
argument_list|(
name|obj
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * This function is called as soon as the 'directory' statement has been  * parsed.  This can be extended to support other options if necessary.  */
end_comment

begin_function
specifier|static
name|isc_result_t
name|directory_callback
parameter_list|(
specifier|const
name|char
modifier|*
name|clausename
parameter_list|,
specifier|const
name|cfg_obj_t
modifier|*
name|obj
parameter_list|,
name|void
modifier|*
name|arg
parameter_list|)
block|{
name|isc_result_t
name|result
decl_stmt|;
specifier|const
name|char
modifier|*
name|directory
decl_stmt|;
name|REQUIRE
argument_list|(
name|strcasecmp
argument_list|(
literal|"directory"
argument_list|,
name|clausename
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|UNUSED
argument_list|(
name|arg
argument_list|)
expr_stmt|;
name|UNUSED
argument_list|(
name|clausename
argument_list|)
expr_stmt|;
comment|/* 	 * Change directory. 	 */
name|directory
operator|=
name|cfg_obj_asstring
argument_list|(
name|obj
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|isc_file_ischdiridempotent
argument_list|(
name|directory
argument_list|)
condition|)
name|cfg_obj_log
argument_list|(
name|obj
argument_list|,
name|ns_g_lctx
argument_list|,
name|ISC_LOG_WARNING
argument_list|,
literal|"option 'directory' contains relative path '%s'"
argument_list|,
name|directory
argument_list|)
expr_stmt|;
name|result
operator|=
name|isc_dir_chdir
argument_list|(
name|directory
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
block|{
name|cfg_obj_log
argument_list|(
name|obj
argument_list|,
name|ns_g_lctx
argument_list|,
name|ISC_LOG_ERROR
argument_list|,
literal|"change directory to '%s' failed: %s"
argument_list|,
name|directory
argument_list|,
name|isc_result_totext
argument_list|(
name|result
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|(
name|result
operator|)
return|;
block|}
return|return
operator|(
name|ISC_R_SUCCESS
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|scan_interfaces
parameter_list|(
name|ns_server_t
modifier|*
name|server
parameter_list|,
name|isc_boolean_t
name|verbose
parameter_list|)
block|{
name|isc_boolean_t
name|match_mapped
init|=
name|server
operator|->
name|aclenv
operator|.
name|match_mapped
decl_stmt|;
name|ns_interfacemgr_scan
argument_list|(
name|server
operator|->
name|interfacemgr
argument_list|,
name|verbose
argument_list|)
expr_stmt|;
comment|/* 	 * Update the "localhost" and "localnets" ACLs to match the 	 * current set of network interfaces. 	 */
name|dns_aclenv_copy
argument_list|(
operator|&
name|server
operator|->
name|aclenv
argument_list|,
name|ns_interfacemgr_getaclenv
argument_list|(
name|server
operator|->
name|interfacemgr
argument_list|)
argument_list|)
expr_stmt|;
name|server
operator|->
name|aclenv
operator|.
name|match_mapped
operator|=
name|match_mapped
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|isc_result_t
name|add_listenelt
parameter_list|(
name|isc_mem_t
modifier|*
name|mctx
parameter_list|,
name|ns_listenlist_t
modifier|*
name|list
parameter_list|,
name|isc_sockaddr_t
modifier|*
name|addr
parameter_list|,
name|isc_boolean_t
name|wcardport_ok
parameter_list|)
block|{
name|ns_listenelt_t
modifier|*
name|lelt
init|=
name|NULL
decl_stmt|;
name|dns_acl_t
modifier|*
name|src_acl
init|=
name|NULL
decl_stmt|;
name|dns_aclelement_t
name|aelt
decl_stmt|;
name|isc_result_t
name|result
decl_stmt|;
name|isc_sockaddr_t
name|any_sa6
decl_stmt|;
name|REQUIRE
argument_list|(
name|isc_sockaddr_pf
argument_list|(
name|addr
argument_list|)
operator|==
name|AF_INET6
argument_list|)
expr_stmt|;
name|isc_sockaddr_any6
argument_list|(
operator|&
name|any_sa6
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|isc_sockaddr_equal
argument_list|(
operator|&
name|any_sa6
argument_list|,
name|addr
argument_list|)
operator|&&
operator|(
name|wcardport_ok
operator|||
name|isc_sockaddr_getport
argument_list|(
name|addr
argument_list|)
operator|!=
literal|0
operator|)
condition|)
block|{
name|aelt
operator|.
name|type
operator|=
name|dns_aclelementtype_ipprefix
expr_stmt|;
name|aelt
operator|.
name|negative
operator|=
name|ISC_FALSE
expr_stmt|;
name|aelt
operator|.
name|u
operator|.
name|ip_prefix
operator|.
name|prefixlen
operator|=
literal|128
expr_stmt|;
name|isc_netaddr_fromin6
argument_list|(
operator|&
name|aelt
operator|.
name|u
operator|.
name|ip_prefix
operator|.
name|address
argument_list|,
operator|&
name|addr
operator|->
name|type
operator|.
name|sin6
operator|.
name|sin6_addr
argument_list|)
expr_stmt|;
name|result
operator|=
name|dns_acl_create
argument_list|(
name|mctx
argument_list|,
literal|1
argument_list|,
operator|&
name|src_acl
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
return|return
operator|(
name|result
operator|)
return|;
name|result
operator|=
name|dns_acl_appendelement
argument_list|(
name|src_acl
argument_list|,
operator|&
name|aelt
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
goto|goto
name|clean
goto|;
name|result
operator|=
name|ns_listenelt_create
argument_list|(
name|mctx
argument_list|,
name|isc_sockaddr_getport
argument_list|(
name|addr
argument_list|)
argument_list|,
name|src_acl
argument_list|,
operator|&
name|lelt
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
goto|goto
name|clean
goto|;
name|ISC_LIST_APPEND
argument_list|(
name|list
operator|->
name|elts
argument_list|,
name|lelt
argument_list|,
name|link
argument_list|)
expr_stmt|;
block|}
return|return
operator|(
name|ISC_R_SUCCESS
operator|)
return|;
name|clean
label|:
name|INSIST
argument_list|(
name|lelt
operator|==
name|NULL
argument_list|)
expr_stmt|;
name|dns_acl_detach
argument_list|(
operator|&
name|src_acl
argument_list|)
expr_stmt|;
return|return
operator|(
name|result
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Make a list of xxx-source addresses and call ns_interfacemgr_adjust()  * to update the listening interfaces accordingly.  * We currently only consider IPv6, because this only affects IPv6 wildcard  * sockets.  */
end_comment

begin_function
specifier|static
name|void
name|adjust_interfaces
parameter_list|(
name|ns_server_t
modifier|*
name|server
parameter_list|,
name|isc_mem_t
modifier|*
name|mctx
parameter_list|)
block|{
name|isc_result_t
name|result
decl_stmt|;
name|ns_listenlist_t
modifier|*
name|list
init|=
name|NULL
decl_stmt|;
name|dns_view_t
modifier|*
name|view
decl_stmt|;
name|dns_zone_t
modifier|*
name|zone
decl_stmt|,
modifier|*
name|next
decl_stmt|;
name|isc_sockaddr_t
name|addr
decl_stmt|,
modifier|*
name|addrp
decl_stmt|;
name|result
operator|=
name|ns_listenlist_create
argument_list|(
name|mctx
argument_list|,
operator|&
name|list
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
return|return;
for|for
control|(
name|view
operator|=
name|ISC_LIST_HEAD
argument_list|(
name|server
operator|->
name|viewlist
argument_list|)
init|;
name|view
operator|!=
name|NULL
condition|;
name|view
operator|=
name|ISC_LIST_NEXT
argument_list|(
name|view
argument_list|,
name|link
argument_list|)
control|)
block|{
name|dns_dispatch_t
modifier|*
name|dispatch6
decl_stmt|;
name|dispatch6
operator|=
name|dns_resolver_dispatchv6
argument_list|(
name|view
operator|->
name|resolver
argument_list|)
expr_stmt|;
if|if
condition|(
name|dispatch6
operator|==
name|NULL
condition|)
continue|continue;
name|result
operator|=
name|dns_dispatch_getlocaladdress
argument_list|(
name|dispatch6
argument_list|,
operator|&
name|addr
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
goto|goto
name|fail
goto|;
comment|/* 		 * We always add non-wildcard address regardless of whether 		 * the port is 'any' (the fourth arg is TRUE): if the port is 		 * specific, we need to add it since it may conflict with a 		 * listening interface; if it's zero, we'll dynamically open 		 * query ports, and some of them may override an existing 		 * wildcard IPv6 port. 		 */
name|result
operator|=
name|add_listenelt
argument_list|(
name|mctx
argument_list|,
name|list
argument_list|,
operator|&
name|addr
argument_list|,
name|ISC_TRUE
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
goto|goto
name|fail
goto|;
block|}
name|zone
operator|=
name|NULL
expr_stmt|;
for|for
control|(
name|result
operator|=
name|dns_zone_first
argument_list|(
name|server
operator|->
name|zonemgr
argument_list|,
operator|&
name|zone
argument_list|)
init|;
name|result
operator|==
name|ISC_R_SUCCESS
condition|;
name|next
operator|=
name|NULL
operator|,
name|result
operator|=
name|dns_zone_next
argument_list|(
name|zone
argument_list|,
operator|&
name|next
argument_list|)
operator|,
name|zone
operator|=
name|next
control|)
block|{
name|dns_view_t
modifier|*
name|zoneview
decl_stmt|;
comment|/* 		 * At this point the zone list may contain a stale zone 		 * just removed from the configuration.  To see the validity, 		 * check if the corresponding view is in our current view list. 		 * There may also be old zones that are still in the process 		 * of shutting down and have detached from their old view 		 * (zoneview == NULL). 		 */
name|zoneview
operator|=
name|dns_zone_getview
argument_list|(
name|zone
argument_list|)
expr_stmt|;
if|if
condition|(
name|zoneview
operator|==
name|NULL
condition|)
continue|continue;
for|for
control|(
name|view
operator|=
name|ISC_LIST_HEAD
argument_list|(
name|server
operator|->
name|viewlist
argument_list|)
init|;
name|view
operator|!=
name|NULL
operator|&&
name|view
operator|!=
name|zoneview
condition|;
name|view
operator|=
name|ISC_LIST_NEXT
argument_list|(
name|view
argument_list|,
name|link
argument_list|)
control|)
empty_stmt|;
if|if
condition|(
name|view
operator|==
name|NULL
condition|)
continue|continue;
name|addrp
operator|=
name|dns_zone_getnotifysrc6
argument_list|(
name|zone
argument_list|)
expr_stmt|;
name|result
operator|=
name|add_listenelt
argument_list|(
name|mctx
argument_list|,
name|list
argument_list|,
name|addrp
argument_list|,
name|ISC_FALSE
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
goto|goto
name|fail
goto|;
name|addrp
operator|=
name|dns_zone_getxfrsource6
argument_list|(
name|zone
argument_list|)
expr_stmt|;
name|result
operator|=
name|add_listenelt
argument_list|(
name|mctx
argument_list|,
name|list
argument_list|,
name|addrp
argument_list|,
name|ISC_FALSE
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
goto|goto
name|fail
goto|;
block|}
name|ns_interfacemgr_adjust
argument_list|(
name|server
operator|->
name|interfacemgr
argument_list|,
name|list
argument_list|,
name|ISC_TRUE
argument_list|)
expr_stmt|;
name|clean
label|:
name|ns_listenlist_detach
argument_list|(
operator|&
name|list
argument_list|)
expr_stmt|;
return|return;
name|fail
label|:
comment|/* 	 * Even when we failed the procedure, most of other interfaces 	 * should work correctly.  We therefore just warn it. 	 */
name|isc_log_write
argument_list|(
name|ns_g_lctx
argument_list|,
name|NS_LOGCATEGORY_GENERAL
argument_list|,
name|NS_LOGMODULE_SERVER
argument_list|,
name|ISC_LOG_WARNING
argument_list|,
literal|"could not adjust the listen-on list; "
literal|"some interfaces may not work"
argument_list|)
expr_stmt|;
goto|goto
name|clean
goto|;
block|}
end_function

begin_comment
comment|/*  * This event callback is invoked to do periodic network  * interface scanning.  */
end_comment

begin_function
specifier|static
name|void
name|interface_timer_tick
parameter_list|(
name|isc_task_t
modifier|*
name|task
parameter_list|,
name|isc_event_t
modifier|*
name|event
parameter_list|)
block|{
name|isc_result_t
name|result
decl_stmt|;
name|ns_server_t
modifier|*
name|server
init|=
operator|(
name|ns_server_t
operator|*
operator|)
name|event
operator|->
name|ev_arg
decl_stmt|;
name|INSIST
argument_list|(
name|task
operator|==
name|server
operator|->
name|task
argument_list|)
expr_stmt|;
name|UNUSED
argument_list|(
name|task
argument_list|)
expr_stmt|;
name|isc_event_free
argument_list|(
operator|&
name|event
argument_list|)
expr_stmt|;
comment|/* 	 * XXX should scan interfaces unlocked and get exclusive access 	 * only to replace ACLs. 	 */
name|result
operator|=
name|isc_task_beginexclusive
argument_list|(
name|server
operator|->
name|task
argument_list|)
expr_stmt|;
name|RUNTIME_CHECK
argument_list|(
name|result
operator|==
name|ISC_R_SUCCESS
argument_list|)
expr_stmt|;
name|scan_interfaces
argument_list|(
name|server
argument_list|,
name|ISC_FALSE
argument_list|)
expr_stmt|;
name|isc_task_endexclusive
argument_list|(
name|server
operator|->
name|task
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|heartbeat_timer_tick
parameter_list|(
name|isc_task_t
modifier|*
name|task
parameter_list|,
name|isc_event_t
modifier|*
name|event
parameter_list|)
block|{
name|ns_server_t
modifier|*
name|server
init|=
operator|(
name|ns_server_t
operator|*
operator|)
name|event
operator|->
name|ev_arg
decl_stmt|;
name|dns_view_t
modifier|*
name|view
decl_stmt|;
name|UNUSED
argument_list|(
name|task
argument_list|)
expr_stmt|;
name|isc_event_free
argument_list|(
operator|&
name|event
argument_list|)
expr_stmt|;
name|view
operator|=
name|ISC_LIST_HEAD
argument_list|(
name|server
operator|->
name|viewlist
argument_list|)
expr_stmt|;
while|while
condition|(
name|view
operator|!=
name|NULL
condition|)
block|{
name|dns_view_dialup
argument_list|(
name|view
argument_list|)
expr_stmt|;
name|view
operator|=
name|ISC_LIST_NEXT
argument_list|(
name|view
argument_list|,
name|link
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/*  * Replace the current value of '*field', a dynamically allocated  * string or NULL, with a dynamically allocated copy of the  * null-terminated string pointed to by 'value', or NULL.  */
end_comment

begin_function
specifier|static
name|isc_result_t
name|setstring
parameter_list|(
name|ns_server_t
modifier|*
name|server
parameter_list|,
name|char
modifier|*
modifier|*
name|field
parameter_list|,
specifier|const
name|char
modifier|*
name|value
parameter_list|)
block|{
name|char
modifier|*
name|copy
decl_stmt|;
if|if
condition|(
name|value
operator|!=
name|NULL
condition|)
block|{
name|copy
operator|=
name|isc_mem_strdup
argument_list|(
name|server
operator|->
name|mctx
argument_list|,
name|value
argument_list|)
expr_stmt|;
if|if
condition|(
name|copy
operator|==
name|NULL
condition|)
return|return
operator|(
name|ISC_R_NOMEMORY
operator|)
return|;
block|}
else|else
block|{
name|copy
operator|=
name|NULL
expr_stmt|;
block|}
if|if
condition|(
operator|*
name|field
operator|!=
name|NULL
condition|)
name|isc_mem_free
argument_list|(
name|server
operator|->
name|mctx
argument_list|,
operator|*
name|field
argument_list|)
expr_stmt|;
operator|*
name|field
operator|=
name|copy
expr_stmt|;
return|return
operator|(
name|ISC_R_SUCCESS
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Replace the current value of '*field', a dynamically allocated  * string or NULL, with another dynamically allocated string  * or NULL if whether 'obj' is a string or void value, respectively.  */
end_comment

begin_function
specifier|static
name|isc_result_t
name|setoptstring
parameter_list|(
name|ns_server_t
modifier|*
name|server
parameter_list|,
name|char
modifier|*
modifier|*
name|field
parameter_list|,
specifier|const
name|cfg_obj_t
modifier|*
name|obj
parameter_list|)
block|{
if|if
condition|(
name|cfg_obj_isvoid
argument_list|(
name|obj
argument_list|)
condition|)
return|return
operator|(
name|setstring
argument_list|(
name|server
argument_list|,
name|field
argument_list|,
name|NULL
argument_list|)
operator|)
return|;
else|else
return|return
operator|(
name|setstring
argument_list|(
name|server
argument_list|,
name|field
argument_list|,
name|cfg_obj_asstring
argument_list|(
name|obj
argument_list|)
argument_list|)
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|set_limit
parameter_list|(
specifier|const
name|cfg_obj_t
modifier|*
modifier|*
name|maps
parameter_list|,
specifier|const
name|char
modifier|*
name|configname
parameter_list|,
specifier|const
name|char
modifier|*
name|description
parameter_list|,
name|isc_resource_t
name|resourceid
parameter_list|,
name|isc_resourcevalue_t
name|defaultvalue
parameter_list|)
block|{
specifier|const
name|cfg_obj_t
modifier|*
name|obj
init|=
name|NULL
decl_stmt|;
specifier|const
name|char
modifier|*
name|resource
decl_stmt|;
name|isc_resourcevalue_t
name|value
decl_stmt|;
name|isc_result_t
name|result
decl_stmt|;
if|if
condition|(
name|ns_config_get
argument_list|(
name|maps
argument_list|,
name|configname
argument_list|,
operator|&
name|obj
argument_list|)
operator|!=
name|ISC_R_SUCCESS
condition|)
return|return;
if|if
condition|(
name|cfg_obj_isstring
argument_list|(
name|obj
argument_list|)
condition|)
block|{
name|resource
operator|=
name|cfg_obj_asstring
argument_list|(
name|obj
argument_list|)
expr_stmt|;
if|if
condition|(
name|strcasecmp
argument_list|(
name|resource
argument_list|,
literal|"unlimited"
argument_list|)
operator|==
literal|0
condition|)
name|value
operator|=
name|ISC_RESOURCE_UNLIMITED
expr_stmt|;
else|else
block|{
name|INSIST
argument_list|(
name|strcasecmp
argument_list|(
name|resource
argument_list|,
literal|"default"
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|value
operator|=
name|defaultvalue
expr_stmt|;
block|}
block|}
else|else
name|value
operator|=
name|cfg_obj_asuint64
argument_list|(
name|obj
argument_list|)
expr_stmt|;
name|result
operator|=
name|isc_resource_setlimit
argument_list|(
name|resourceid
argument_list|,
name|value
argument_list|)
expr_stmt|;
name|isc_log_write
argument_list|(
name|ns_g_lctx
argument_list|,
name|NS_LOGCATEGORY_GENERAL
argument_list|,
name|NS_LOGMODULE_SERVER
argument_list|,
name|result
operator|==
name|ISC_R_SUCCESS
condition|?
name|ISC_LOG_DEBUG
argument_list|(
literal|3
argument_list|)
else|:
name|ISC_LOG_WARNING
argument_list|,
literal|"set maximum %s to %"
name|ISC_PRINT_QUADFORMAT
literal|"d: %s"
argument_list|,
name|description
argument_list|,
name|value
argument_list|,
name|isc_result_totext
argument_list|(
name|result
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_define
define|#
directive|define
name|SETLIMIT
parameter_list|(
name|cfgvar
parameter_list|,
name|resource
parameter_list|,
name|description
parameter_list|)
define|\
value|set_limit(maps, cfgvar, description, isc_resource_ ## resource, \ 		  ns_g_init ## resource)
end_define

begin_function
specifier|static
name|void
name|set_limits
parameter_list|(
specifier|const
name|cfg_obj_t
modifier|*
modifier|*
name|maps
parameter_list|)
block|{
name|SETLIMIT
argument_list|(
literal|"stacksize"
argument_list|,
name|stacksize
argument_list|,
literal|"stack size"
argument_list|)
expr_stmt|;
name|SETLIMIT
argument_list|(
literal|"datasize"
argument_list|,
name|datasize
argument_list|,
literal|"data size"
argument_list|)
expr_stmt|;
name|SETLIMIT
argument_list|(
literal|"coresize"
argument_list|,
name|coresize
argument_list|,
literal|"core size"
argument_list|)
expr_stmt|;
name|SETLIMIT
argument_list|(
literal|"files"
argument_list|,
name|openfiles
argument_list|,
literal|"open files"
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|isc_result_t
name|portlist_fromconf
parameter_list|(
name|dns_portlist_t
modifier|*
name|portlist
parameter_list|,
name|unsigned
name|int
name|family
parameter_list|,
specifier|const
name|cfg_obj_t
modifier|*
name|ports
parameter_list|)
block|{
specifier|const
name|cfg_listelt_t
modifier|*
name|element
decl_stmt|;
name|isc_result_t
name|result
init|=
name|ISC_R_SUCCESS
decl_stmt|;
for|for
control|(
name|element
operator|=
name|cfg_list_first
argument_list|(
name|ports
argument_list|)
init|;
name|element
operator|!=
name|NULL
condition|;
name|element
operator|=
name|cfg_list_next
argument_list|(
name|element
argument_list|)
control|)
block|{
specifier|const
name|cfg_obj_t
modifier|*
name|obj
init|=
name|cfg_listelt_value
argument_list|(
name|element
argument_list|)
decl_stmt|;
name|in_port_t
name|port
init|=
operator|(
name|in_port_t
operator|)
name|cfg_obj_asuint32
argument_list|(
name|obj
argument_list|)
decl_stmt|;
name|result
operator|=
name|dns_portlist_add
argument_list|(
name|portlist
argument_list|,
name|family
argument_list|,
name|port
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
break|break;
block|}
return|return
operator|(
name|result
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|isc_result_t
name|load_configuration
parameter_list|(
specifier|const
name|char
modifier|*
name|filename
parameter_list|,
name|ns_server_t
modifier|*
name|server
parameter_list|,
name|isc_boolean_t
name|first_time
parameter_list|)
block|{
name|cfg_obj_t
modifier|*
name|config
decl_stmt|;
name|cfg_parser_t
modifier|*
name|parser
init|=
name|NULL
decl_stmt|;
specifier|const
name|cfg_listelt_t
modifier|*
name|element
decl_stmt|;
specifier|const
name|cfg_obj_t
modifier|*
name|builtin_views
decl_stmt|;
specifier|const
name|cfg_obj_t
modifier|*
name|maps
index|[
literal|3
index|]
decl_stmt|;
specifier|const
name|cfg_obj_t
modifier|*
name|obj
decl_stmt|;
specifier|const
name|cfg_obj_t
modifier|*
name|options
decl_stmt|;
specifier|const
name|cfg_obj_t
modifier|*
name|v4ports
decl_stmt|,
modifier|*
name|v6ports
decl_stmt|;
specifier|const
name|cfg_obj_t
modifier|*
name|views
decl_stmt|;
name|dns_view_t
modifier|*
name|view
init|=
name|NULL
decl_stmt|;
name|dns_view_t
modifier|*
name|view_next
decl_stmt|;
name|dns_viewlist_t
name|tmpviewlist
decl_stmt|;
name|dns_viewlist_t
name|viewlist
decl_stmt|;
name|in_port_t
name|listen_port
decl_stmt|;
name|int
name|i
decl_stmt|;
name|isc_resourcevalue_t
name|files
decl_stmt|;
name|isc_result_t
name|result
decl_stmt|;
name|isc_uint32_t
name|heartbeat_interval
decl_stmt|;
name|isc_uint32_t
name|interface_interval
decl_stmt|;
name|isc_uint32_t
name|reserved
decl_stmt|;
name|isc_uint32_t
name|udpsize
decl_stmt|;
name|ns_aclconfctx_t
name|aclconfctx
decl_stmt|;
name|ns_aclconfctx_init
argument_list|(
operator|&
name|aclconfctx
argument_list|)
expr_stmt|;
name|ISC_LIST_INIT
argument_list|(
name|viewlist
argument_list|)
expr_stmt|;
comment|/* Ensure exclusive access to configuration data. */
name|result
operator|=
name|isc_task_beginexclusive
argument_list|(
name|server
operator|->
name|task
argument_list|)
expr_stmt|;
name|RUNTIME_CHECK
argument_list|(
name|result
operator|==
name|ISC_R_SUCCESS
argument_list|)
expr_stmt|;
comment|/* 	 * Parse the global default pseudo-config file. 	 */
if|if
condition|(
name|first_time
condition|)
block|{
name|CHECK
argument_list|(
name|ns_config_parsedefaults
argument_list|(
name|ns_g_parser
argument_list|,
operator|&
name|ns_g_config
argument_list|)
argument_list|)
expr_stmt|;
name|RUNTIME_CHECK
argument_list|(
name|cfg_map_get
argument_list|(
name|ns_g_config
argument_list|,
literal|"options"
argument_list|,
operator|&
name|ns_g_defaults
argument_list|)
operator|==
name|ISC_R_SUCCESS
argument_list|)
expr_stmt|;
block|}
comment|/* 	 * Parse the configuration file using the new config code. 	 */
name|result
operator|=
name|ISC_R_FAILURE
expr_stmt|;
name|config
operator|=
name|NULL
expr_stmt|;
comment|/* 	 * Unless this is lwresd with the -C option, parse the config file. 	 */
if|if
condition|(
operator|!
operator|(
name|ns_g_lwresdonly
operator|&&
name|lwresd_g_useresolvconf
operator|)
condition|)
block|{
name|isc_log_write
argument_list|(
name|ns_g_lctx
argument_list|,
name|NS_LOGCATEGORY_GENERAL
argument_list|,
name|NS_LOGMODULE_SERVER
argument_list|,
name|ISC_LOG_INFO
argument_list|,
literal|"loading configuration from '%s'"
argument_list|,
name|filename
argument_list|)
expr_stmt|;
name|CHECK
argument_list|(
name|cfg_parser_create
argument_list|(
name|ns_g_mctx
argument_list|,
name|ns_g_lctx
argument_list|,
operator|&
name|parser
argument_list|)
argument_list|)
expr_stmt|;
name|cfg_parser_setcallback
argument_list|(
name|parser
argument_list|,
name|directory_callback
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|result
operator|=
name|cfg_parse_file
argument_list|(
name|parser
argument_list|,
name|filename
argument_list|,
operator|&
name|cfg_type_namedconf
argument_list|,
operator|&
name|config
argument_list|)
expr_stmt|;
block|}
comment|/* 	 * If this is lwresd with the -C option, or lwresd with no -C or -c 	 * option where the above parsing failed, parse resolv.conf. 	 */
if|if
condition|(
name|ns_g_lwresdonly
operator|&&
operator|(
name|lwresd_g_useresolvconf
operator|||
operator|(
operator|!
name|ns_g_conffileset
operator|&&
name|result
operator|==
name|ISC_R_FILENOTFOUND
operator|)
operator|)
condition|)
block|{
name|isc_log_write
argument_list|(
name|ns_g_lctx
argument_list|,
name|NS_LOGCATEGORY_GENERAL
argument_list|,
name|NS_LOGMODULE_SERVER
argument_list|,
name|ISC_LOG_INFO
argument_list|,
literal|"loading configuration from '%s'"
argument_list|,
name|lwresd_g_resolvconffile
argument_list|)
expr_stmt|;
if|if
condition|(
name|parser
operator|!=
name|NULL
condition|)
name|cfg_parser_destroy
argument_list|(
operator|&
name|parser
argument_list|)
expr_stmt|;
name|CHECK
argument_list|(
name|cfg_parser_create
argument_list|(
name|ns_g_mctx
argument_list|,
name|ns_g_lctx
argument_list|,
operator|&
name|parser
argument_list|)
argument_list|)
expr_stmt|;
name|result
operator|=
name|ns_lwresd_parseeresolvconf
argument_list|(
name|ns_g_mctx
argument_list|,
name|parser
argument_list|,
operator|&
name|config
argument_list|)
expr_stmt|;
block|}
name|CHECK
argument_list|(
name|result
argument_list|)
expr_stmt|;
comment|/* 	 * Check that the working directory is writable. 	 */
if|if
condition|(
name|access
argument_list|(
literal|"."
argument_list|,
name|W_OK
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|isc_log_write
argument_list|(
name|ns_g_lctx
argument_list|,
name|NS_LOGCATEGORY_GENERAL
argument_list|,
name|NS_LOGMODULE_SERVER
argument_list|,
name|ISC_LOG_ERROR
argument_list|,
literal|"the working directory is not writable"
argument_list|)
expr_stmt|;
block|}
comment|/* 	 * Check the validity of the configuration. 	 */
name|CHECK
argument_list|(
name|bind9_check_namedconf
argument_list|(
name|config
argument_list|,
name|ns_g_lctx
argument_list|,
name|ns_g_mctx
argument_list|)
argument_list|)
expr_stmt|;
comment|/* 	 * Fill in the maps array, used for resolving defaults. 	 */
name|i
operator|=
literal|0
expr_stmt|;
name|options
operator|=
name|NULL
expr_stmt|;
name|result
operator|=
name|cfg_map_get
argument_list|(
name|config
argument_list|,
literal|"options"
argument_list|,
operator|&
name|options
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|==
name|ISC_R_SUCCESS
condition|)
name|maps
index|[
name|i
operator|++
index|]
operator|=
name|options
expr_stmt|;
name|maps
index|[
name|i
operator|++
index|]
operator|=
name|ns_g_defaults
expr_stmt|;
name|maps
index|[
name|i
operator|++
index|]
operator|=
name|NULL
expr_stmt|;
comment|/* 	 * Set process limits, which (usually) needs to be done as root. 	 */
name|set_limits
argument_list|(
name|maps
argument_list|)
expr_stmt|;
comment|/* 	 * Sanity check on "files" limit. 	 */
name|result
operator|=
name|isc_resource_curlimit
argument_list|(
name|isc_resource_openfiles
argument_list|,
operator|&
name|files
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|==
name|ISC_R_SUCCESS
operator|&&
name|files
operator|<
name|FD_SETSIZE
condition|)
block|{
name|isc_log_write
argument_list|(
name|ns_g_lctx
argument_list|,
name|NS_LOGCATEGORY_GENERAL
argument_list|,
name|NS_LOGMODULE_SERVER
argument_list|,
name|ISC_LOG_WARNING
argument_list|,
literal|"the 'files' limit (%"
name|ISC_PRINT_QUADFORMAT
literal|"u) "
literal|"is less than FD_SETSIZE (%d), increase "
literal|"'files' in named.conf or recompile with a "
literal|"smaller FD_SETSIZE."
argument_list|,
name|files
argument_list|,
name|FD_SETSIZE
argument_list|)
expr_stmt|;
if|if
condition|(
name|files
operator|>
name|FD_SETSIZE
condition|)
name|files
operator|=
name|FD_SETSIZE
expr_stmt|;
block|}
else|else
name|files
operator|=
name|FD_SETSIZE
expr_stmt|;
comment|/* 	 * Set the number of socket reserved for TCP, stdio etc. 	 */
name|obj
operator|=
name|NULL
expr_stmt|;
name|result
operator|=
name|ns_config_get
argument_list|(
name|maps
argument_list|,
literal|"reserved-sockets"
argument_list|,
operator|&
name|obj
argument_list|)
expr_stmt|;
name|INSIST
argument_list|(
name|result
operator|==
name|ISC_R_SUCCESS
argument_list|)
expr_stmt|;
name|reserved
operator|=
name|cfg_obj_asuint32
argument_list|(
name|obj
argument_list|)
expr_stmt|;
if|if
condition|(
name|files
operator|<
literal|128U
condition|)
comment|/* Prevent underflow. */
name|reserved
operator|=
literal|0
expr_stmt|;
elseif|else
if|if
condition|(
name|reserved
operator|>
name|files
operator|-
literal|128U
condition|)
comment|/* Mimimum UDP space. */
name|reserved
operator|=
name|files
operator|-
literal|128
expr_stmt|;
if|if
condition|(
name|reserved
operator|<
literal|128U
condition|)
comment|/* Mimimum TCP/stdio space. */
name|reserved
operator|=
literal|128
expr_stmt|;
if|if
condition|(
name|reserved
operator|+
literal|128U
operator|>
name|files
condition|)
block|{
name|isc_log_write
argument_list|(
name|ns_g_lctx
argument_list|,
name|NS_LOGCATEGORY_GENERAL
argument_list|,
name|NS_LOGMODULE_SERVER
argument_list|,
name|ISC_LOG_WARNING
argument_list|,
literal|"less than 128 UDP sockets available after "
literal|"applying 'reserved-sockets' and 'files'"
argument_list|)
expr_stmt|;
block|}
name|isc__socketmgr_setreserved
argument_list|(
name|ns_g_socketmgr
argument_list|,
name|reserved
argument_list|)
expr_stmt|;
comment|/* 	 * Configure various server options. 	 */
name|configure_server_quota
argument_list|(
name|maps
argument_list|,
literal|"transfers-out"
argument_list|,
operator|&
name|server
operator|->
name|xfroutquota
argument_list|)
expr_stmt|;
name|configure_server_quota
argument_list|(
name|maps
argument_list|,
literal|"tcp-clients"
argument_list|,
operator|&
name|server
operator|->
name|tcpquota
argument_list|)
expr_stmt|;
name|configure_server_quota
argument_list|(
name|maps
argument_list|,
literal|"recursive-clients"
argument_list|,
operator|&
name|server
operator|->
name|recursionquota
argument_list|)
expr_stmt|;
if|if
condition|(
name|server
operator|->
name|recursionquota
operator|.
name|max
operator|>
literal|1000
condition|)
name|isc_quota_soft
argument_list|(
operator|&
name|server
operator|->
name|recursionquota
argument_list|,
name|server
operator|->
name|recursionquota
operator|.
name|max
operator|-
literal|100
argument_list|)
expr_stmt|;
else|else
name|isc_quota_soft
argument_list|(
operator|&
name|server
operator|->
name|recursionquota
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|CHECK
argument_list|(
name|configure_view_acl
argument_list|(
name|NULL
argument_list|,
name|config
argument_list|,
literal|"blackhole"
argument_list|,
operator|&
name|aclconfctx
argument_list|,
name|ns_g_mctx
argument_list|,
operator|&
name|server
operator|->
name|blackholeacl
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|server
operator|->
name|blackholeacl
operator|!=
name|NULL
condition|)
name|dns_dispatchmgr_setblackhole
argument_list|(
name|ns_g_dispatchmgr
argument_list|,
name|server
operator|->
name|blackholeacl
argument_list|)
expr_stmt|;
name|obj
operator|=
name|NULL
expr_stmt|;
name|result
operator|=
name|ns_config_get
argument_list|(
name|maps
argument_list|,
literal|"match-mapped-addresses"
argument_list|,
operator|&
name|obj
argument_list|)
expr_stmt|;
name|INSIST
argument_list|(
name|result
operator|==
name|ISC_R_SUCCESS
argument_list|)
expr_stmt|;
name|server
operator|->
name|aclenv
operator|.
name|match_mapped
operator|=
name|cfg_obj_asboolean
argument_list|(
name|obj
argument_list|)
expr_stmt|;
name|v4ports
operator|=
name|NULL
expr_stmt|;
name|v6ports
operator|=
name|NULL
expr_stmt|;
operator|(
name|void
operator|)
name|ns_config_get
argument_list|(
name|maps
argument_list|,
literal|"avoid-v4-udp-ports"
argument_list|,
operator|&
name|v4ports
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|ns_config_get
argument_list|(
name|maps
argument_list|,
literal|"avoid-v6-udp-ports"
argument_list|,
operator|&
name|v6ports
argument_list|)
expr_stmt|;
if|if
condition|(
name|v4ports
operator|!=
name|NULL
operator|||
name|v6ports
operator|!=
name|NULL
condition|)
block|{
name|dns_portlist_t
modifier|*
name|portlist
init|=
name|NULL
decl_stmt|;
name|result
operator|=
name|dns_portlist_create
argument_list|(
name|ns_g_mctx
argument_list|,
operator|&
name|portlist
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|==
name|ISC_R_SUCCESS
operator|&&
name|v4ports
operator|!=
name|NULL
condition|)
name|result
operator|=
name|portlist_fromconf
argument_list|(
name|portlist
argument_list|,
name|AF_INET
argument_list|,
name|v4ports
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|==
name|ISC_R_SUCCESS
operator|&&
name|v6ports
operator|!=
name|NULL
condition|)
name|portlist_fromconf
argument_list|(
name|portlist
argument_list|,
name|AF_INET6
argument_list|,
name|v6ports
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|==
name|ISC_R_SUCCESS
condition|)
name|dns_dispatchmgr_setblackportlist
argument_list|(
name|ns_g_dispatchmgr
argument_list|,
name|portlist
argument_list|)
expr_stmt|;
if|if
condition|(
name|portlist
operator|!=
name|NULL
condition|)
name|dns_portlist_detach
argument_list|(
operator|&
name|portlist
argument_list|)
expr_stmt|;
name|CHECK
argument_list|(
name|result
argument_list|)
expr_stmt|;
block|}
else|else
name|dns_dispatchmgr_setblackportlist
argument_list|(
name|ns_g_dispatchmgr
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
comment|/* 	 * Set the EDNS UDP size when we don't match a view. 	 */
name|obj
operator|=
name|NULL
expr_stmt|;
name|result
operator|=
name|ns_config_get
argument_list|(
name|maps
argument_list|,
literal|"edns-udp-size"
argument_list|,
operator|&
name|obj
argument_list|)
expr_stmt|;
name|INSIST
argument_list|(
name|result
operator|==
name|ISC_R_SUCCESS
argument_list|)
expr_stmt|;
name|udpsize
operator|=
name|cfg_obj_asuint32
argument_list|(
name|obj
argument_list|)
expr_stmt|;
if|if
condition|(
name|udpsize
operator|<
literal|512
condition|)
name|udpsize
operator|=
literal|512
expr_stmt|;
if|if
condition|(
name|udpsize
operator|>
literal|4096
condition|)
name|udpsize
operator|=
literal|4096
expr_stmt|;
name|ns_g_udpsize
operator|=
operator|(
name|isc_uint16_t
operator|)
name|udpsize
expr_stmt|;
comment|/* 	 * Configure the zone manager. 	 */
name|obj
operator|=
name|NULL
expr_stmt|;
name|result
operator|=
name|ns_config_get
argument_list|(
name|maps
argument_list|,
literal|"transfers-in"
argument_list|,
operator|&
name|obj
argument_list|)
expr_stmt|;
name|INSIST
argument_list|(
name|result
operator|==
name|ISC_R_SUCCESS
argument_list|)
expr_stmt|;
name|dns_zonemgr_settransfersin
argument_list|(
name|server
operator|->
name|zonemgr
argument_list|,
name|cfg_obj_asuint32
argument_list|(
name|obj
argument_list|)
argument_list|)
expr_stmt|;
name|obj
operator|=
name|NULL
expr_stmt|;
name|result
operator|=
name|ns_config_get
argument_list|(
name|maps
argument_list|,
literal|"transfers-per-ns"
argument_list|,
operator|&
name|obj
argument_list|)
expr_stmt|;
name|INSIST
argument_list|(
name|result
operator|==
name|ISC_R_SUCCESS
argument_list|)
expr_stmt|;
name|dns_zonemgr_settransfersperns
argument_list|(
name|server
operator|->
name|zonemgr
argument_list|,
name|cfg_obj_asuint32
argument_list|(
name|obj
argument_list|)
argument_list|)
expr_stmt|;
name|obj
operator|=
name|NULL
expr_stmt|;
name|result
operator|=
name|ns_config_get
argument_list|(
name|maps
argument_list|,
literal|"serial-query-rate"
argument_list|,
operator|&
name|obj
argument_list|)
expr_stmt|;
name|INSIST
argument_list|(
name|result
operator|==
name|ISC_R_SUCCESS
argument_list|)
expr_stmt|;
name|dns_zonemgr_setserialqueryrate
argument_list|(
name|server
operator|->
name|zonemgr
argument_list|,
name|cfg_obj_asuint32
argument_list|(
name|obj
argument_list|)
argument_list|)
expr_stmt|;
comment|/* 	 * Determine which port to use for listening for incoming connections. 	 */
if|if
condition|(
name|ns_g_port
operator|!=
literal|0
condition|)
name|listen_port
operator|=
name|ns_g_port
expr_stmt|;
else|else
name|CHECKM
argument_list|(
name|ns_config_getport
argument_list|(
name|config
argument_list|,
operator|&
name|listen_port
argument_list|)
argument_list|,
literal|"port"
argument_list|)
expr_stmt|;
comment|/* 	 * Find the listen queue depth. 	 */
name|obj
operator|=
name|NULL
expr_stmt|;
name|result
operator|=
name|ns_config_get
argument_list|(
name|maps
argument_list|,
literal|"tcp-listen-queue"
argument_list|,
operator|&
name|obj
argument_list|)
expr_stmt|;
name|INSIST
argument_list|(
name|result
operator|==
name|ISC_R_SUCCESS
argument_list|)
expr_stmt|;
name|ns_g_listen
operator|=
name|cfg_obj_asuint32
argument_list|(
name|obj
argument_list|)
expr_stmt|;
if|if
condition|(
name|ns_g_listen
operator|<
literal|3
condition|)
name|ns_g_listen
operator|=
literal|3
expr_stmt|;
comment|/* 	 * Configure the interface manager according to the "listen-on" 	 * statement. 	 */
block|{
specifier|const
name|cfg_obj_t
modifier|*
name|clistenon
init|=
name|NULL
decl_stmt|;
name|ns_listenlist_t
modifier|*
name|listenon
init|=
name|NULL
decl_stmt|;
name|clistenon
operator|=
name|NULL
expr_stmt|;
comment|/* 		 * Even though listen-on is present in the default 		 * configuration, we can't use it here, since it isn't 		 * used if we're in lwresd mode.  This way is easier. 		 */
if|if
condition|(
name|options
operator|!=
name|NULL
condition|)
operator|(
name|void
operator|)
name|cfg_map_get
argument_list|(
name|options
argument_list|,
literal|"listen-on"
argument_list|,
operator|&
name|clistenon
argument_list|)
expr_stmt|;
if|if
condition|(
name|clistenon
operator|!=
name|NULL
condition|)
block|{
name|result
operator|=
name|ns_listenlist_fromconfig
argument_list|(
name|clistenon
argument_list|,
name|config
argument_list|,
operator|&
name|aclconfctx
argument_list|,
name|ns_g_mctx
argument_list|,
operator|&
name|listenon
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|!
name|ns_g_lwresdonly
condition|)
block|{
comment|/* 			 * Not specified, use default. 			 */
name|CHECK
argument_list|(
name|ns_listenlist_default
argument_list|(
name|ns_g_mctx
argument_list|,
name|listen_port
argument_list|,
name|ISC_TRUE
argument_list|,
operator|&
name|listenon
argument_list|)
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|listenon
operator|!=
name|NULL
condition|)
block|{
name|ns_interfacemgr_setlistenon4
argument_list|(
name|server
operator|->
name|interfacemgr
argument_list|,
name|listenon
argument_list|)
expr_stmt|;
name|ns_listenlist_detach
argument_list|(
operator|&
name|listenon
argument_list|)
expr_stmt|;
block|}
block|}
comment|/* 	 * Ditto for IPv6. 	 */
block|{
specifier|const
name|cfg_obj_t
modifier|*
name|clistenon
init|=
name|NULL
decl_stmt|;
name|ns_listenlist_t
modifier|*
name|listenon
init|=
name|NULL
decl_stmt|;
if|if
condition|(
name|options
operator|!=
name|NULL
condition|)
operator|(
name|void
operator|)
name|cfg_map_get
argument_list|(
name|options
argument_list|,
literal|"listen-on-v6"
argument_list|,
operator|&
name|clistenon
argument_list|)
expr_stmt|;
if|if
condition|(
name|clistenon
operator|!=
name|NULL
condition|)
block|{
name|result
operator|=
name|ns_listenlist_fromconfig
argument_list|(
name|clistenon
argument_list|,
name|config
argument_list|,
operator|&
name|aclconfctx
argument_list|,
name|ns_g_mctx
argument_list|,
operator|&
name|listenon
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|!
name|ns_g_lwresdonly
condition|)
block|{
comment|/* 			 * Not specified, use default. 			 */
name|CHECK
argument_list|(
name|ns_listenlist_default
argument_list|(
name|ns_g_mctx
argument_list|,
name|listen_port
argument_list|,
name|ISC_FALSE
argument_list|,
operator|&
name|listenon
argument_list|)
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|listenon
operator|!=
name|NULL
condition|)
block|{
name|ns_interfacemgr_setlistenon6
argument_list|(
name|server
operator|->
name|interfacemgr
argument_list|,
name|listenon
argument_list|)
expr_stmt|;
name|ns_listenlist_detach
argument_list|(
operator|&
name|listenon
argument_list|)
expr_stmt|;
block|}
block|}
comment|/* 	 * Rescan the interface list to pick up changes in the 	 * listen-on option.  It's important that we do this before we try 	 * to configure the query source, since the dispatcher we use might 	 * be shared with an interface. 	 */
name|scan_interfaces
argument_list|(
name|server
argument_list|,
name|ISC_TRUE
argument_list|)
expr_stmt|;
comment|/* 	 * Arrange for further interface scanning to occur periodically 	 * as specified by the "interface-interval" option. 	 */
name|obj
operator|=
name|NULL
expr_stmt|;
name|result
operator|=
name|ns_config_get
argument_list|(
name|maps
argument_list|,
literal|"interface-interval"
argument_list|,
operator|&
name|obj
argument_list|)
expr_stmt|;
name|INSIST
argument_list|(
name|result
operator|==
name|ISC_R_SUCCESS
argument_list|)
expr_stmt|;
name|interface_interval
operator|=
name|cfg_obj_asuint32
argument_list|(
name|obj
argument_list|)
operator|*
literal|60
expr_stmt|;
if|if
condition|(
name|interface_interval
operator|==
literal|0
condition|)
block|{
name|CHECK
argument_list|(
name|isc_timer_reset
argument_list|(
name|server
operator|->
name|interface_timer
argument_list|,
name|isc_timertype_inactive
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|ISC_TRUE
argument_list|)
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|server
operator|->
name|interface_interval
operator|!=
name|interface_interval
condition|)
block|{
name|isc_interval_t
name|interval
decl_stmt|;
name|isc_interval_set
argument_list|(
operator|&
name|interval
argument_list|,
name|interface_interval
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|CHECK
argument_list|(
name|isc_timer_reset
argument_list|(
name|server
operator|->
name|interface_timer
argument_list|,
name|isc_timertype_ticker
argument_list|,
name|NULL
argument_list|,
operator|&
name|interval
argument_list|,
name|ISC_FALSE
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|server
operator|->
name|interface_interval
operator|=
name|interface_interval
expr_stmt|;
comment|/* 	 * Configure the dialup heartbeat timer. 	 */
name|obj
operator|=
name|NULL
expr_stmt|;
name|result
operator|=
name|ns_config_get
argument_list|(
name|maps
argument_list|,
literal|"heartbeat-interval"
argument_list|,
operator|&
name|obj
argument_list|)
expr_stmt|;
name|INSIST
argument_list|(
name|result
operator|==
name|ISC_R_SUCCESS
argument_list|)
expr_stmt|;
name|heartbeat_interval
operator|=
name|cfg_obj_asuint32
argument_list|(
name|obj
argument_list|)
operator|*
literal|60
expr_stmt|;
if|if
condition|(
name|heartbeat_interval
operator|==
literal|0
condition|)
block|{
name|CHECK
argument_list|(
name|isc_timer_reset
argument_list|(
name|server
operator|->
name|heartbeat_timer
argument_list|,
name|isc_timertype_inactive
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|ISC_TRUE
argument_list|)
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|server
operator|->
name|heartbeat_interval
operator|!=
name|heartbeat_interval
condition|)
block|{
name|isc_interval_t
name|interval
decl_stmt|;
name|isc_interval_set
argument_list|(
operator|&
name|interval
argument_list|,
name|heartbeat_interval
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|CHECK
argument_list|(
name|isc_timer_reset
argument_list|(
name|server
operator|->
name|heartbeat_timer
argument_list|,
name|isc_timertype_ticker
argument_list|,
name|NULL
argument_list|,
operator|&
name|interval
argument_list|,
name|ISC_FALSE
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|server
operator|->
name|heartbeat_interval
operator|=
name|heartbeat_interval
expr_stmt|;
comment|/* 	 * Configure and freeze all explicit views.  Explicit 	 * views that have zones were already created at parsing 	 * time, but views with no zones must be created here. 	 */
name|views
operator|=
name|NULL
expr_stmt|;
operator|(
name|void
operator|)
name|cfg_map_get
argument_list|(
name|config
argument_list|,
literal|"view"
argument_list|,
operator|&
name|views
argument_list|)
expr_stmt|;
for|for
control|(
name|element
operator|=
name|cfg_list_first
argument_list|(
name|views
argument_list|)
init|;
name|element
operator|!=
name|NULL
condition|;
name|element
operator|=
name|cfg_list_next
argument_list|(
name|element
argument_list|)
control|)
block|{
specifier|const
name|cfg_obj_t
modifier|*
name|vconfig
init|=
name|cfg_listelt_value
argument_list|(
name|element
argument_list|)
decl_stmt|;
name|view
operator|=
name|NULL
expr_stmt|;
name|CHECK
argument_list|(
name|create_view
argument_list|(
name|vconfig
argument_list|,
operator|&
name|viewlist
argument_list|,
operator|&
name|view
argument_list|)
argument_list|)
expr_stmt|;
name|INSIST
argument_list|(
name|view
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|CHECK
argument_list|(
name|configure_view
argument_list|(
name|view
argument_list|,
name|config
argument_list|,
name|vconfig
argument_list|,
name|ns_g_mctx
argument_list|,
operator|&
name|aclconfctx
argument_list|,
name|ISC_TRUE
argument_list|)
argument_list|)
expr_stmt|;
name|dns_view_freeze
argument_list|(
name|view
argument_list|)
expr_stmt|;
name|dns_view_detach
argument_list|(
operator|&
name|view
argument_list|)
expr_stmt|;
block|}
comment|/* 	 * Make sure we have a default view if and only if there 	 * were no explicit views. 	 */
if|if
condition|(
name|views
operator|==
name|NULL
condition|)
block|{
comment|/* 		 * No explicit views; there ought to be a default view. 		 * There may already be one created as a side effect 		 * of zone statements, or we may have to create one. 		 * In either case, we need to configure and freeze it. 		 */
name|CHECK
argument_list|(
name|create_view
argument_list|(
name|NULL
argument_list|,
operator|&
name|viewlist
argument_list|,
operator|&
name|view
argument_list|)
argument_list|)
expr_stmt|;
name|CHECK
argument_list|(
name|configure_view
argument_list|(
name|view
argument_list|,
name|config
argument_list|,
name|NULL
argument_list|,
name|ns_g_mctx
argument_list|,
operator|&
name|aclconfctx
argument_list|,
name|ISC_TRUE
argument_list|)
argument_list|)
expr_stmt|;
name|dns_view_freeze
argument_list|(
name|view
argument_list|)
expr_stmt|;
name|dns_view_detach
argument_list|(
operator|&
name|view
argument_list|)
expr_stmt|;
block|}
comment|/* 	 * Create (or recreate) the built-in views.  Currently 	 * there is only one, the _bind view. 	 */
name|builtin_views
operator|=
name|NULL
expr_stmt|;
name|RUNTIME_CHECK
argument_list|(
name|cfg_map_get
argument_list|(
name|ns_g_config
argument_list|,
literal|"view"
argument_list|,
operator|&
name|builtin_views
argument_list|)
operator|==
name|ISC_R_SUCCESS
argument_list|)
expr_stmt|;
for|for
control|(
name|element
operator|=
name|cfg_list_first
argument_list|(
name|builtin_views
argument_list|)
init|;
name|element
operator|!=
name|NULL
condition|;
name|element
operator|=
name|cfg_list_next
argument_list|(
name|element
argument_list|)
control|)
block|{
specifier|const
name|cfg_obj_t
modifier|*
name|vconfig
init|=
name|cfg_listelt_value
argument_list|(
name|element
argument_list|)
decl_stmt|;
name|CHECK
argument_list|(
name|create_view
argument_list|(
name|vconfig
argument_list|,
operator|&
name|viewlist
argument_list|,
operator|&
name|view
argument_list|)
argument_list|)
expr_stmt|;
name|CHECK
argument_list|(
name|configure_view
argument_list|(
name|view
argument_list|,
name|config
argument_list|,
name|vconfig
argument_list|,
name|ns_g_mctx
argument_list|,
operator|&
name|aclconfctx
argument_list|,
name|ISC_FALSE
argument_list|)
argument_list|)
expr_stmt|;
name|dns_view_freeze
argument_list|(
name|view
argument_list|)
expr_stmt|;
name|dns_view_detach
argument_list|(
operator|&
name|view
argument_list|)
expr_stmt|;
name|view
operator|=
name|NULL
expr_stmt|;
block|}
comment|/* 	 * Swap our new view list with the production one. 	 */
name|tmpviewlist
operator|=
name|server
operator|->
name|viewlist
expr_stmt|;
name|server
operator|->
name|viewlist
operator|=
name|viewlist
expr_stmt|;
name|viewlist
operator|=
name|tmpviewlist
expr_stmt|;
comment|/* 	 * Load the TKEY information from the configuration. 	 */
if|if
condition|(
name|options
operator|!=
name|NULL
condition|)
block|{
name|dns_tkeyctx_t
modifier|*
name|t
init|=
name|NULL
decl_stmt|;
name|CHECKM
argument_list|(
name|ns_tkeyctx_fromconfig
argument_list|(
name|options
argument_list|,
name|ns_g_mctx
argument_list|,
name|ns_g_entropy
argument_list|,
operator|&
name|t
argument_list|)
argument_list|,
literal|"configuring TKEY"
argument_list|)
expr_stmt|;
if|if
condition|(
name|server
operator|->
name|tkeyctx
operator|!=
name|NULL
condition|)
name|dns_tkeyctx_destroy
argument_list|(
operator|&
name|server
operator|->
name|tkeyctx
argument_list|)
expr_stmt|;
name|server
operator|->
name|tkeyctx
operator|=
name|t
expr_stmt|;
block|}
comment|/* 	 * Bind the control port(s). 	 */
name|CHECKM
argument_list|(
name|ns_controls_configure
argument_list|(
name|ns_g_server
operator|->
name|controls
argument_list|,
name|config
argument_list|,
operator|&
name|aclconfctx
argument_list|)
argument_list|,
literal|"binding control channel(s)"
argument_list|)
expr_stmt|;
comment|/* 	 * Bind the lwresd port(s). 	 */
name|CHECKM
argument_list|(
name|ns_lwresd_configure
argument_list|(
name|ns_g_mctx
argument_list|,
name|config
argument_list|)
argument_list|,
literal|"binding lightweight resolver ports"
argument_list|)
expr_stmt|;
comment|/* 	 * Open the source of entropy. 	 */
if|if
condition|(
name|first_time
condition|)
block|{
name|obj
operator|=
name|NULL
expr_stmt|;
name|result
operator|=
name|ns_config_get
argument_list|(
name|maps
argument_list|,
literal|"random-device"
argument_list|,
operator|&
name|obj
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
block|{
name|isc_log_write
argument_list|(
name|ns_g_lctx
argument_list|,
name|NS_LOGCATEGORY_GENERAL
argument_list|,
name|NS_LOGMODULE_SERVER
argument_list|,
name|ISC_LOG_INFO
argument_list|,
literal|"no source of entropy found"
argument_list|)
expr_stmt|;
block|}
else|else
block|{
specifier|const
name|char
modifier|*
name|randomdev
init|=
name|cfg_obj_asstring
argument_list|(
name|obj
argument_list|)
decl_stmt|;
name|result
operator|=
name|isc_entropy_createfilesource
argument_list|(
name|ns_g_entropy
argument_list|,
name|randomdev
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
name|isc_log_write
argument_list|(
name|ns_g_lctx
argument_list|,
name|NS_LOGCATEGORY_GENERAL
argument_list|,
name|NS_LOGMODULE_SERVER
argument_list|,
name|ISC_LOG_INFO
argument_list|,
literal|"could not open entropy source "
literal|"%s: %s"
argument_list|,
name|randomdev
argument_list|,
name|isc_result_totext
argument_list|(
name|result
argument_list|)
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|PATH_RANDOMDEV
if|if
condition|(
name|ns_g_fallbackentropy
operator|!=
name|NULL
condition|)
block|{
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
block|{
name|isc_log_write
argument_list|(
name|ns_g_lctx
argument_list|,
name|NS_LOGCATEGORY_GENERAL
argument_list|,
name|NS_LOGMODULE_SERVER
argument_list|,
name|ISC_LOG_INFO
argument_list|,
literal|"using pre-chroot entropy source "
literal|"%s"
argument_list|,
name|PATH_RANDOMDEV
argument_list|)
expr_stmt|;
name|isc_entropy_detach
argument_list|(
operator|&
name|ns_g_entropy
argument_list|)
expr_stmt|;
name|isc_entropy_attach
argument_list|(
name|ns_g_fallbackentropy
argument_list|,
operator|&
name|ns_g_entropy
argument_list|)
expr_stmt|;
block|}
name|isc_entropy_detach
argument_list|(
operator|&
name|ns_g_fallbackentropy
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
block|}
block|}
comment|/* 	 * Relinquish root privileges. 	 */
if|if
condition|(
name|first_time
condition|)
name|ns_os_changeuser
argument_list|()
expr_stmt|;
comment|/* 	 * Configure the logging system. 	 * 	 * Do this after changing UID to make sure that any log 	 * files specified in named.conf get created by the 	 * unprivileged user, not root. 	 */
if|if
condition|(
name|ns_g_logstderr
condition|)
block|{
name|isc_log_write
argument_list|(
name|ns_g_lctx
argument_list|,
name|NS_LOGCATEGORY_GENERAL
argument_list|,
name|NS_LOGMODULE_SERVER
argument_list|,
name|ISC_LOG_INFO
argument_list|,
literal|"ignoring config file logging "
literal|"statement due to -g option"
argument_list|)
expr_stmt|;
block|}
else|else
block|{
specifier|const
name|cfg_obj_t
modifier|*
name|logobj
init|=
name|NULL
decl_stmt|;
name|isc_logconfig_t
modifier|*
name|logc
init|=
name|NULL
decl_stmt|;
name|CHECKM
argument_list|(
name|isc_logconfig_create
argument_list|(
name|ns_g_lctx
argument_list|,
operator|&
name|logc
argument_list|)
argument_list|,
literal|"creating new logging configuration"
argument_list|)
expr_stmt|;
name|logobj
operator|=
name|NULL
expr_stmt|;
operator|(
name|void
operator|)
name|cfg_map_get
argument_list|(
name|config
argument_list|,
literal|"logging"
argument_list|,
operator|&
name|logobj
argument_list|)
expr_stmt|;
if|if
condition|(
name|logobj
operator|!=
name|NULL
condition|)
block|{
name|CHECKM
argument_list|(
name|ns_log_configure
argument_list|(
name|logc
argument_list|,
name|logobj
argument_list|)
argument_list|,
literal|"configuring logging"
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|CHECKM
argument_list|(
name|ns_log_setdefaultchannels
argument_list|(
name|logc
argument_list|)
argument_list|,
literal|"setting up default logging channels"
argument_list|)
expr_stmt|;
name|CHECKM
argument_list|(
name|ns_log_setunmatchedcategory
argument_list|(
name|logc
argument_list|)
argument_list|,
literal|"setting up default 'category unmatched'"
argument_list|)
expr_stmt|;
name|CHECKM
argument_list|(
name|ns_log_setdefaultcategory
argument_list|(
name|logc
argument_list|)
argument_list|,
literal|"setting up default 'category default'"
argument_list|)
expr_stmt|;
block|}
name|result
operator|=
name|isc_logconfig_use
argument_list|(
name|ns_g_lctx
argument_list|,
name|logc
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
block|{
name|isc_logconfig_destroy
argument_list|(
operator|&
name|logc
argument_list|)
expr_stmt|;
name|CHECKM
argument_list|(
name|result
argument_list|,
literal|"installing logging configuration"
argument_list|)
expr_stmt|;
block|}
name|isc_log_write
argument_list|(
name|ns_g_lctx
argument_list|,
name|NS_LOGCATEGORY_GENERAL
argument_list|,
name|NS_LOGMODULE_SERVER
argument_list|,
name|ISC_LOG_DEBUG
argument_list|(
literal|1
argument_list|)
argument_list|,
literal|"now using logging configuration from "
literal|"config file"
argument_list|)
expr_stmt|;
block|}
comment|/* 	 * Set the default value of the query logging flag depending 	 * whether a "queries" category has been defined.  This is 	 * a disgusting hack, but we need to do this for BIND 8 	 * compatibility. 	 */
if|if
condition|(
name|first_time
condition|)
block|{
specifier|const
name|cfg_obj_t
modifier|*
name|logobj
init|=
name|NULL
decl_stmt|;
specifier|const
name|cfg_obj_t
modifier|*
name|categories
init|=
name|NULL
decl_stmt|;
name|obj
operator|=
name|NULL
expr_stmt|;
if|if
condition|(
name|ns_config_get
argument_list|(
name|maps
argument_list|,
literal|"querylog"
argument_list|,
operator|&
name|obj
argument_list|)
operator|==
name|ISC_R_SUCCESS
condition|)
block|{
name|server
operator|->
name|log_queries
operator|=
name|cfg_obj_asboolean
argument_list|(
name|obj
argument_list|)
expr_stmt|;
block|}
else|else
block|{
operator|(
name|void
operator|)
name|cfg_map_get
argument_list|(
name|config
argument_list|,
literal|"logging"
argument_list|,
operator|&
name|logobj
argument_list|)
expr_stmt|;
if|if
condition|(
name|logobj
operator|!=
name|NULL
condition|)
operator|(
name|void
operator|)
name|cfg_map_get
argument_list|(
name|logobj
argument_list|,
literal|"category"
argument_list|,
operator|&
name|categories
argument_list|)
expr_stmt|;
if|if
condition|(
name|categories
operator|!=
name|NULL
condition|)
block|{
specifier|const
name|cfg_listelt_t
modifier|*
name|element
decl_stmt|;
for|for
control|(
name|element
operator|=
name|cfg_list_first
argument_list|(
name|categories
argument_list|)
init|;
name|element
operator|!=
name|NULL
condition|;
name|element
operator|=
name|cfg_list_next
argument_list|(
name|element
argument_list|)
control|)
block|{
specifier|const
name|cfg_obj_t
modifier|*
name|catobj
decl_stmt|;
specifier|const
name|char
modifier|*
name|str
decl_stmt|;
name|obj
operator|=
name|cfg_listelt_value
argument_list|(
name|element
argument_list|)
expr_stmt|;
name|catobj
operator|=
name|cfg_tuple_get
argument_list|(
name|obj
argument_list|,
literal|"name"
argument_list|)
expr_stmt|;
name|str
operator|=
name|cfg_obj_asstring
argument_list|(
name|catobj
argument_list|)
expr_stmt|;
if|if
condition|(
name|strcasecmp
argument_list|(
name|str
argument_list|,
literal|"queries"
argument_list|)
operator|==
literal|0
condition|)
name|server
operator|->
name|log_queries
operator|=
name|ISC_TRUE
expr_stmt|;
block|}
block|}
block|}
block|}
name|obj
operator|=
name|NULL
expr_stmt|;
if|if
condition|(
name|ns_config_get
argument_list|(
name|maps
argument_list|,
literal|"pid-file"
argument_list|,
operator|&
name|obj
argument_list|)
operator|==
name|ISC_R_SUCCESS
condition|)
if|if
condition|(
name|cfg_obj_isvoid
argument_list|(
name|obj
argument_list|)
condition|)
name|ns_os_writepidfile
argument_list|(
name|NULL
argument_list|,
name|first_time
argument_list|)
expr_stmt|;
else|else
name|ns_os_writepidfile
argument_list|(
name|cfg_obj_asstring
argument_list|(
name|obj
argument_list|)
argument_list|,
name|first_time
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|ns_g_lwresdonly
condition|)
name|ns_os_writepidfile
argument_list|(
name|lwresd_g_defaultpidfile
argument_list|,
name|first_time
argument_list|)
expr_stmt|;
else|else
name|ns_os_writepidfile
argument_list|(
name|ns_g_defaultpidfile
argument_list|,
name|first_time
argument_list|)
expr_stmt|;
name|obj
operator|=
name|NULL
expr_stmt|;
if|if
condition|(
name|options
operator|!=
name|NULL
operator|&&
name|cfg_map_get
argument_list|(
name|options
argument_list|,
literal|"memstatistics-file"
argument_list|,
operator|&
name|obj
argument_list|)
operator|==
name|ISC_R_SUCCESS
condition|)
name|ns_main_setmemstats
argument_list|(
name|cfg_obj_asstring
argument_list|(
name|obj
argument_list|)
argument_list|)
expr_stmt|;
else|else
name|ns_main_setmemstats
argument_list|(
name|NULL
argument_list|)
expr_stmt|;
name|obj
operator|=
name|NULL
expr_stmt|;
name|result
operator|=
name|ns_config_get
argument_list|(
name|maps
argument_list|,
literal|"statistics-file"
argument_list|,
operator|&
name|obj
argument_list|)
expr_stmt|;
name|INSIST
argument_list|(
name|result
operator|==
name|ISC_R_SUCCESS
argument_list|)
expr_stmt|;
name|CHECKM
argument_list|(
name|setstring
argument_list|(
name|server
argument_list|,
operator|&
name|server
operator|->
name|statsfile
argument_list|,
name|cfg_obj_asstring
argument_list|(
name|obj
argument_list|)
argument_list|)
argument_list|,
literal|"strdup"
argument_list|)
expr_stmt|;
name|obj
operator|=
name|NULL
expr_stmt|;
name|result
operator|=
name|ns_config_get
argument_list|(
name|maps
argument_list|,
literal|"dump-file"
argument_list|,
operator|&
name|obj
argument_list|)
expr_stmt|;
name|INSIST
argument_list|(
name|result
operator|==
name|ISC_R_SUCCESS
argument_list|)
expr_stmt|;
name|CHECKM
argument_list|(
name|setstring
argument_list|(
name|server
argument_list|,
operator|&
name|server
operator|->
name|dumpfile
argument_list|,
name|cfg_obj_asstring
argument_list|(
name|obj
argument_list|)
argument_list|)
argument_list|,
literal|"strdup"
argument_list|)
expr_stmt|;
name|obj
operator|=
name|NULL
expr_stmt|;
name|result
operator|=
name|ns_config_get
argument_list|(
name|maps
argument_list|,
literal|"recursing-file"
argument_list|,
operator|&
name|obj
argument_list|)
expr_stmt|;
name|INSIST
argument_list|(
name|result
operator|==
name|ISC_R_SUCCESS
argument_list|)
expr_stmt|;
name|CHECKM
argument_list|(
name|setstring
argument_list|(
name|server
argument_list|,
operator|&
name|server
operator|->
name|recfile
argument_list|,
name|cfg_obj_asstring
argument_list|(
name|obj
argument_list|)
argument_list|)
argument_list|,
literal|"strdup"
argument_list|)
expr_stmt|;
name|obj
operator|=
name|NULL
expr_stmt|;
name|result
operator|=
name|ns_config_get
argument_list|(
name|maps
argument_list|,
literal|"version"
argument_list|,
operator|&
name|obj
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|==
name|ISC_R_SUCCESS
condition|)
block|{
name|CHECKM
argument_list|(
name|setoptstring
argument_list|(
name|server
argument_list|,
operator|&
name|server
operator|->
name|version
argument_list|,
name|obj
argument_list|)
argument_list|,
literal|"strdup"
argument_list|)
expr_stmt|;
name|server
operator|->
name|version_set
operator|=
name|ISC_TRUE
expr_stmt|;
block|}
else|else
block|{
name|server
operator|->
name|version_set
operator|=
name|ISC_FALSE
expr_stmt|;
block|}
name|obj
operator|=
name|NULL
expr_stmt|;
name|result
operator|=
name|ns_config_get
argument_list|(
name|maps
argument_list|,
literal|"hostname"
argument_list|,
operator|&
name|obj
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|==
name|ISC_R_SUCCESS
condition|)
block|{
name|CHECKM
argument_list|(
name|setoptstring
argument_list|(
name|server
argument_list|,
operator|&
name|server
operator|->
name|hostname
argument_list|,
name|obj
argument_list|)
argument_list|,
literal|"strdup"
argument_list|)
expr_stmt|;
name|server
operator|->
name|hostname_set
operator|=
name|ISC_TRUE
expr_stmt|;
block|}
else|else
block|{
name|server
operator|->
name|hostname_set
operator|=
name|ISC_FALSE
expr_stmt|;
block|}
name|obj
operator|=
name|NULL
expr_stmt|;
name|result
operator|=
name|ns_config_get
argument_list|(
name|maps
argument_list|,
literal|"server-id"
argument_list|,
operator|&
name|obj
argument_list|)
expr_stmt|;
name|server
operator|->
name|server_usehostname
operator|=
name|ISC_FALSE
expr_stmt|;
if|if
condition|(
name|result
operator|==
name|ISC_R_SUCCESS
operator|&&
name|cfg_obj_isboolean
argument_list|(
name|obj
argument_list|)
condition|)
block|{
name|server
operator|->
name|server_usehostname
operator|=
name|ISC_TRUE
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|result
operator|==
name|ISC_R_SUCCESS
condition|)
block|{
name|CHECKM
argument_list|(
name|setoptstring
argument_list|(
name|server
argument_list|,
operator|&
name|server
operator|->
name|server_id
argument_list|,
name|obj
argument_list|)
argument_list|,
literal|"strdup"
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|result
operator|=
name|setoptstring
argument_list|(
name|server
argument_list|,
operator|&
name|server
operator|->
name|server_id
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|RUNTIME_CHECK
argument_list|(
name|result
operator|==
name|ISC_R_SUCCESS
argument_list|)
expr_stmt|;
block|}
name|obj
operator|=
name|NULL
expr_stmt|;
name|result
operator|=
name|ns_config_get
argument_list|(
name|maps
argument_list|,
literal|"flush-zones-on-shutdown"
argument_list|,
operator|&
name|obj
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|==
name|ISC_R_SUCCESS
condition|)
block|{
name|server
operator|->
name|flushonshutdown
operator|=
name|cfg_obj_asboolean
argument_list|(
name|obj
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|server
operator|->
name|flushonshutdown
operator|=
name|ISC_FALSE
expr_stmt|;
block|}
name|result
operator|=
name|ISC_R_SUCCESS
expr_stmt|;
name|cleanup
label|:
name|ns_aclconfctx_destroy
argument_list|(
operator|&
name|aclconfctx
argument_list|)
expr_stmt|;
if|if
condition|(
name|parser
operator|!=
name|NULL
condition|)
block|{
if|if
condition|(
name|config
operator|!=
name|NULL
condition|)
name|cfg_obj_destroy
argument_list|(
name|parser
argument_list|,
operator|&
name|config
argument_list|)
expr_stmt|;
name|cfg_parser_destroy
argument_list|(
operator|&
name|parser
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|view
operator|!=
name|NULL
condition|)
name|dns_view_detach
argument_list|(
operator|&
name|view
argument_list|)
expr_stmt|;
comment|/* 	 * This cleans up either the old production view list 	 * or our temporary list depending on whether they 	 * were swapped above or not. 	 */
for|for
control|(
name|view
operator|=
name|ISC_LIST_HEAD
argument_list|(
name|viewlist
argument_list|)
init|;
name|view
operator|!=
name|NULL
condition|;
name|view
operator|=
name|view_next
control|)
block|{
name|view_next
operator|=
name|ISC_LIST_NEXT
argument_list|(
name|view
argument_list|,
name|link
argument_list|)
expr_stmt|;
name|ISC_LIST_UNLINK
argument_list|(
name|viewlist
argument_list|,
name|view
argument_list|,
name|link
argument_list|)
expr_stmt|;
name|dns_view_detach
argument_list|(
operator|&
name|view
argument_list|)
expr_stmt|;
block|}
comment|/* 	 * Adjust the listening interfaces in accordance with the source 	 * addresses specified in views and zones. 	 */
if|if
condition|(
name|isc_net_probeipv6
argument_list|()
operator|==
name|ISC_R_SUCCESS
condition|)
name|adjust_interfaces
argument_list|(
name|server
argument_list|,
name|ns_g_mctx
argument_list|)
expr_stmt|;
comment|/* Relinquish exclusive access to configuration data. */
name|isc_task_endexclusive
argument_list|(
name|server
operator|->
name|task
argument_list|)
expr_stmt|;
name|isc_log_write
argument_list|(
name|ns_g_lctx
argument_list|,
name|NS_LOGCATEGORY_GENERAL
argument_list|,
name|NS_LOGMODULE_SERVER
argument_list|,
name|ISC_LOG_DEBUG
argument_list|(
literal|1
argument_list|)
argument_list|,
literal|"load_configuration: %s"
argument_list|,
name|isc_result_totext
argument_list|(
name|result
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|(
name|result
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|isc_result_t
name|load_zones
parameter_list|(
name|ns_server_t
modifier|*
name|server
parameter_list|,
name|isc_boolean_t
name|stop
parameter_list|)
block|{
name|isc_result_t
name|result
decl_stmt|;
name|dns_view_t
modifier|*
name|view
decl_stmt|;
name|result
operator|=
name|isc_task_beginexclusive
argument_list|(
name|server
operator|->
name|task
argument_list|)
expr_stmt|;
name|RUNTIME_CHECK
argument_list|(
name|result
operator|==
name|ISC_R_SUCCESS
argument_list|)
expr_stmt|;
comment|/* 	 * Load zone data from disk. 	 */
for|for
control|(
name|view
operator|=
name|ISC_LIST_HEAD
argument_list|(
name|server
operator|->
name|viewlist
argument_list|)
init|;
name|view
operator|!=
name|NULL
condition|;
name|view
operator|=
name|ISC_LIST_NEXT
argument_list|(
name|view
argument_list|,
name|link
argument_list|)
control|)
block|{
name|CHECK
argument_list|(
name|dns_view_load
argument_list|(
name|view
argument_list|,
name|stop
argument_list|)
argument_list|)
expr_stmt|;
block|}
comment|/* 	 * Force zone maintenance.  Do this after loading 	 * so that we know when we need to force AXFR of 	 * slave zones whose master files are missing. 	 */
name|CHECK
argument_list|(
name|dns_zonemgr_forcemaint
argument_list|(
name|server
operator|->
name|zonemgr
argument_list|)
argument_list|)
expr_stmt|;
name|cleanup
label|:
name|isc_task_endexclusive
argument_list|(
name|server
operator|->
name|task
argument_list|)
expr_stmt|;
return|return
operator|(
name|result
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|isc_result_t
name|load_new_zones
parameter_list|(
name|ns_server_t
modifier|*
name|server
parameter_list|,
name|isc_boolean_t
name|stop
parameter_list|)
block|{
name|isc_result_t
name|result
decl_stmt|;
name|dns_view_t
modifier|*
name|view
decl_stmt|;
name|result
operator|=
name|isc_task_beginexclusive
argument_list|(
name|server
operator|->
name|task
argument_list|)
expr_stmt|;
name|RUNTIME_CHECK
argument_list|(
name|result
operator|==
name|ISC_R_SUCCESS
argument_list|)
expr_stmt|;
comment|/* 	 * Load zone data from disk. 	 */
for|for
control|(
name|view
operator|=
name|ISC_LIST_HEAD
argument_list|(
name|server
operator|->
name|viewlist
argument_list|)
init|;
name|view
operator|!=
name|NULL
condition|;
name|view
operator|=
name|ISC_LIST_NEXT
argument_list|(
name|view
argument_list|,
name|link
argument_list|)
control|)
block|{
name|CHECK
argument_list|(
name|dns_view_loadnew
argument_list|(
name|view
argument_list|,
name|stop
argument_list|)
argument_list|)
expr_stmt|;
block|}
comment|/* 	 * Force zone maintenance.  Do this after loading 	 * so that we know when we need to force AXFR of 	 * slave zones whose master files are missing. 	 */
name|dns_zonemgr_resumexfrs
argument_list|(
name|server
operator|->
name|zonemgr
argument_list|)
expr_stmt|;
name|cleanup
label|:
name|isc_task_endexclusive
argument_list|(
name|server
operator|->
name|task
argument_list|)
expr_stmt|;
return|return
operator|(
name|result
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|run_server
parameter_list|(
name|isc_task_t
modifier|*
name|task
parameter_list|,
name|isc_event_t
modifier|*
name|event
parameter_list|)
block|{
name|isc_result_t
name|result
decl_stmt|;
name|ns_server_t
modifier|*
name|server
init|=
operator|(
name|ns_server_t
operator|*
operator|)
name|event
operator|->
name|ev_arg
decl_stmt|;
name|INSIST
argument_list|(
name|task
operator|==
name|server
operator|->
name|task
argument_list|)
expr_stmt|;
name|isc_event_free
argument_list|(
operator|&
name|event
argument_list|)
expr_stmt|;
name|CHECKFATAL
argument_list|(
name|dns_dispatchmgr_create
argument_list|(
name|ns_g_mctx
argument_list|,
name|ns_g_entropy
argument_list|,
operator|&
name|ns_g_dispatchmgr
argument_list|)
argument_list|,
literal|"creating dispatch manager"
argument_list|)
expr_stmt|;
name|CHECKFATAL
argument_list|(
name|ns_interfacemgr_create
argument_list|(
name|ns_g_mctx
argument_list|,
name|ns_g_taskmgr
argument_list|,
name|ns_g_socketmgr
argument_list|,
name|ns_g_dispatchmgr
argument_list|,
operator|&
name|server
operator|->
name|interfacemgr
argument_list|)
argument_list|,
literal|"creating interface manager"
argument_list|)
expr_stmt|;
name|CHECKFATAL
argument_list|(
name|isc_timer_create
argument_list|(
name|ns_g_timermgr
argument_list|,
name|isc_timertype_inactive
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|server
operator|->
name|task
argument_list|,
name|interface_timer_tick
argument_list|,
name|server
argument_list|,
operator|&
name|server
operator|->
name|interface_timer
argument_list|)
argument_list|,
literal|"creating interface timer"
argument_list|)
expr_stmt|;
name|CHECKFATAL
argument_list|(
name|isc_timer_create
argument_list|(
name|ns_g_timermgr
argument_list|,
name|isc_timertype_inactive
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|server
operator|->
name|task
argument_list|,
name|heartbeat_timer_tick
argument_list|,
name|server
argument_list|,
operator|&
name|server
operator|->
name|heartbeat_timer
argument_list|)
argument_list|,
literal|"creating heartbeat timer"
argument_list|)
expr_stmt|;
name|CHECKFATAL
argument_list|(
name|cfg_parser_create
argument_list|(
name|ns_g_mctx
argument_list|,
name|NULL
argument_list|,
operator|&
name|ns_g_parser
argument_list|)
argument_list|,
literal|"creating default configuration parser"
argument_list|)
expr_stmt|;
if|if
condition|(
name|ns_g_lwresdonly
condition|)
name|CHECKFATAL
argument_list|(
name|load_configuration
argument_list|(
name|lwresd_g_conffile
argument_list|,
name|server
argument_list|,
name|ISC_TRUE
argument_list|)
argument_list|,
literal|"loading configuration"
argument_list|)
expr_stmt|;
else|else
name|CHECKFATAL
argument_list|(
name|load_configuration
argument_list|(
name|ns_g_conffile
argument_list|,
name|server
argument_list|,
name|ISC_TRUE
argument_list|)
argument_list|,
literal|"loading configuration"
argument_list|)
expr_stmt|;
name|isc_hash_init
argument_list|()
expr_stmt|;
name|CHECKFATAL
argument_list|(
name|load_zones
argument_list|(
name|server
argument_list|,
name|ISC_FALSE
argument_list|)
argument_list|,
literal|"loading zones"
argument_list|)
expr_stmt|;
name|ns_os_started
argument_list|()
expr_stmt|;
name|isc_log_write
argument_list|(
name|ns_g_lctx
argument_list|,
name|NS_LOGCATEGORY_GENERAL
argument_list|,
name|NS_LOGMODULE_SERVER
argument_list|,
name|ISC_LOG_NOTICE
argument_list|,
literal|"running"
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|ns_server_flushonshutdown
parameter_list|(
name|ns_server_t
modifier|*
name|server
parameter_list|,
name|isc_boolean_t
name|flush
parameter_list|)
block|{
name|REQUIRE
argument_list|(
name|NS_SERVER_VALID
argument_list|(
name|server
argument_list|)
argument_list|)
expr_stmt|;
name|server
operator|->
name|flushonshutdown
operator|=
name|flush
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|shutdown_server
parameter_list|(
name|isc_task_t
modifier|*
name|task
parameter_list|,
name|isc_event_t
modifier|*
name|event
parameter_list|)
block|{
name|isc_result_t
name|result
decl_stmt|;
name|dns_view_t
modifier|*
name|view
decl_stmt|,
modifier|*
name|view_next
decl_stmt|;
name|ns_server_t
modifier|*
name|server
init|=
operator|(
name|ns_server_t
operator|*
operator|)
name|event
operator|->
name|ev_arg
decl_stmt|;
name|isc_boolean_t
name|flush
init|=
name|server
operator|->
name|flushonshutdown
decl_stmt|;
name|UNUSED
argument_list|(
name|task
argument_list|)
expr_stmt|;
name|INSIST
argument_list|(
name|task
operator|==
name|server
operator|->
name|task
argument_list|)
expr_stmt|;
name|result
operator|=
name|isc_task_beginexclusive
argument_list|(
name|server
operator|->
name|task
argument_list|)
expr_stmt|;
name|RUNTIME_CHECK
argument_list|(
name|result
operator|==
name|ISC_R_SUCCESS
argument_list|)
expr_stmt|;
name|isc_log_write
argument_list|(
name|ns_g_lctx
argument_list|,
name|NS_LOGCATEGORY_GENERAL
argument_list|,
name|NS_LOGMODULE_SERVER
argument_list|,
name|ISC_LOG_INFO
argument_list|,
literal|"shutting down%s"
argument_list|,
name|flush
condition|?
literal|": flushing changes"
else|:
literal|""
argument_list|)
expr_stmt|;
name|ns_controls_shutdown
argument_list|(
name|server
operator|->
name|controls
argument_list|)
expr_stmt|;
name|end_reserved_dispatches
argument_list|(
name|server
argument_list|,
name|ISC_TRUE
argument_list|)
expr_stmt|;
name|cfg_obj_destroy
argument_list|(
name|ns_g_parser
argument_list|,
operator|&
name|ns_g_config
argument_list|)
expr_stmt|;
name|cfg_parser_destroy
argument_list|(
operator|&
name|ns_g_parser
argument_list|)
expr_stmt|;
for|for
control|(
name|view
operator|=
name|ISC_LIST_HEAD
argument_list|(
name|server
operator|->
name|viewlist
argument_list|)
init|;
name|view
operator|!=
name|NULL
condition|;
name|view
operator|=
name|view_next
control|)
block|{
name|view_next
operator|=
name|ISC_LIST_NEXT
argument_list|(
name|view
argument_list|,
name|link
argument_list|)
expr_stmt|;
name|ISC_LIST_UNLINK
argument_list|(
name|server
operator|->
name|viewlist
argument_list|,
name|view
argument_list|,
name|link
argument_list|)
expr_stmt|;
if|if
condition|(
name|flush
condition|)
name|dns_view_flushanddetach
argument_list|(
operator|&
name|view
argument_list|)
expr_stmt|;
else|else
name|dns_view_detach
argument_list|(
operator|&
name|view
argument_list|)
expr_stmt|;
block|}
name|isc_timer_detach
argument_list|(
operator|&
name|server
operator|->
name|interface_timer
argument_list|)
expr_stmt|;
name|isc_timer_detach
argument_list|(
operator|&
name|server
operator|->
name|heartbeat_timer
argument_list|)
expr_stmt|;
name|ns_interfacemgr_shutdown
argument_list|(
name|server
operator|->
name|interfacemgr
argument_list|)
expr_stmt|;
name|ns_interfacemgr_detach
argument_list|(
operator|&
name|server
operator|->
name|interfacemgr
argument_list|)
expr_stmt|;
name|dns_dispatchmgr_destroy
argument_list|(
operator|&
name|ns_g_dispatchmgr
argument_list|)
expr_stmt|;
name|dns_zonemgr_shutdown
argument_list|(
name|server
operator|->
name|zonemgr
argument_list|)
expr_stmt|;
if|if
condition|(
name|server
operator|->
name|blackholeacl
operator|!=
name|NULL
condition|)
name|dns_acl_detach
argument_list|(
operator|&
name|server
operator|->
name|blackholeacl
argument_list|)
expr_stmt|;
name|dns_db_detach
argument_list|(
operator|&
name|server
operator|->
name|in_roothints
argument_list|)
expr_stmt|;
name|isc_task_endexclusive
argument_list|(
name|server
operator|->
name|task
argument_list|)
expr_stmt|;
name|isc_task_detach
argument_list|(
operator|&
name|server
operator|->
name|task
argument_list|)
expr_stmt|;
name|isc_event_free
argument_list|(
operator|&
name|event
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|ns_server_create
parameter_list|(
name|isc_mem_t
modifier|*
name|mctx
parameter_list|,
name|ns_server_t
modifier|*
modifier|*
name|serverp
parameter_list|)
block|{
name|isc_result_t
name|result
decl_stmt|;
name|ns_server_t
modifier|*
name|server
init|=
name|isc_mem_get
argument_list|(
name|mctx
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|server
argument_list|)
argument_list|)
decl_stmt|;
if|if
condition|(
name|server
operator|==
name|NULL
condition|)
name|fatal
argument_list|(
literal|"allocating server object"
argument_list|,
name|ISC_R_NOMEMORY
argument_list|)
expr_stmt|;
name|server
operator|->
name|mctx
operator|=
name|mctx
expr_stmt|;
name|server
operator|->
name|task
operator|=
name|NULL
expr_stmt|;
comment|/* Initialize configuration data with default values. */
name|result
operator|=
name|isc_quota_init
argument_list|(
operator|&
name|server
operator|->
name|xfroutquota
argument_list|,
literal|10
argument_list|)
expr_stmt|;
name|RUNTIME_CHECK
argument_list|(
name|result
operator|==
name|ISC_R_SUCCESS
argument_list|)
expr_stmt|;
name|result
operator|=
name|isc_quota_init
argument_list|(
operator|&
name|server
operator|->
name|tcpquota
argument_list|,
literal|10
argument_list|)
expr_stmt|;
name|RUNTIME_CHECK
argument_list|(
name|result
operator|==
name|ISC_R_SUCCESS
argument_list|)
expr_stmt|;
name|result
operator|=
name|isc_quota_init
argument_list|(
operator|&
name|server
operator|->
name|recursionquota
argument_list|,
literal|100
argument_list|)
expr_stmt|;
name|RUNTIME_CHECK
argument_list|(
name|result
operator|==
name|ISC_R_SUCCESS
argument_list|)
expr_stmt|;
name|result
operator|=
name|dns_aclenv_init
argument_list|(
name|mctx
argument_list|,
operator|&
name|server
operator|->
name|aclenv
argument_list|)
expr_stmt|;
name|RUNTIME_CHECK
argument_list|(
name|result
operator|==
name|ISC_R_SUCCESS
argument_list|)
expr_stmt|;
comment|/* Initialize server data structures. */
name|server
operator|->
name|zonemgr
operator|=
name|NULL
expr_stmt|;
name|server
operator|->
name|interfacemgr
operator|=
name|NULL
expr_stmt|;
name|ISC_LIST_INIT
argument_list|(
name|server
operator|->
name|viewlist
argument_list|)
expr_stmt|;
name|server
operator|->
name|in_roothints
operator|=
name|NULL
expr_stmt|;
name|server
operator|->
name|blackholeacl
operator|=
name|NULL
expr_stmt|;
name|CHECKFATAL
argument_list|(
name|dns_rootns_create
argument_list|(
name|mctx
argument_list|,
name|dns_rdataclass_in
argument_list|,
name|NULL
argument_list|,
operator|&
name|server
operator|->
name|in_roothints
argument_list|)
argument_list|,
literal|"setting up root hints"
argument_list|)
expr_stmt|;
name|CHECKFATAL
argument_list|(
name|isc_mutex_init
argument_list|(
operator|&
name|server
operator|->
name|reload_event_lock
argument_list|)
argument_list|,
literal|"initializing reload event lock"
argument_list|)
expr_stmt|;
name|server
operator|->
name|reload_event
operator|=
name|isc_event_allocate
argument_list|(
name|ns_g_mctx
argument_list|,
name|server
argument_list|,
name|NS_EVENT_RELOAD
argument_list|,
name|ns_server_reload
argument_list|,
name|server
argument_list|,
sizeof|sizeof
argument_list|(
name|isc_event_t
argument_list|)
argument_list|)
expr_stmt|;
name|CHECKFATAL
argument_list|(
name|server
operator|->
name|reload_event
operator|==
name|NULL
condition|?
name|ISC_R_NOMEMORY
else|:
name|ISC_R_SUCCESS
argument_list|,
literal|"allocating reload event"
argument_list|)
expr_stmt|;
name|CHECKFATAL
argument_list|(
name|dst_lib_init
argument_list|(
name|ns_g_mctx
argument_list|,
name|ns_g_entropy
argument_list|,
name|ISC_ENTROPY_GOODONLY
argument_list|)
argument_list|,
literal|"initializing DST"
argument_list|)
expr_stmt|;
name|server
operator|->
name|tkeyctx
operator|=
name|NULL
expr_stmt|;
name|CHECKFATAL
argument_list|(
name|dns_tkeyctx_create
argument_list|(
name|ns_g_mctx
argument_list|,
name|ns_g_entropy
argument_list|,
operator|&
name|server
operator|->
name|tkeyctx
argument_list|)
argument_list|,
literal|"creating TKEY context"
argument_list|)
expr_stmt|;
comment|/* 	 * Setup the server task, which is responsible for coordinating 	 * startup and shutdown of the server. 	 */
name|CHECKFATAL
argument_list|(
name|isc_task_create
argument_list|(
name|ns_g_taskmgr
argument_list|,
literal|0
argument_list|,
operator|&
name|server
operator|->
name|task
argument_list|)
argument_list|,
literal|"creating server task"
argument_list|)
expr_stmt|;
name|isc_task_setname
argument_list|(
name|server
operator|->
name|task
argument_list|,
literal|"server"
argument_list|,
name|server
argument_list|)
expr_stmt|;
name|CHECKFATAL
argument_list|(
name|isc_task_onshutdown
argument_list|(
name|server
operator|->
name|task
argument_list|,
name|shutdown_server
argument_list|,
name|server
argument_list|)
argument_list|,
literal|"isc_task_onshutdown"
argument_list|)
expr_stmt|;
name|CHECKFATAL
argument_list|(
name|isc_app_onrun
argument_list|(
name|ns_g_mctx
argument_list|,
name|server
operator|->
name|task
argument_list|,
name|run_server
argument_list|,
name|server
argument_list|)
argument_list|,
literal|"isc_app_onrun"
argument_list|)
expr_stmt|;
name|server
operator|->
name|interface_timer
operator|=
name|NULL
expr_stmt|;
name|server
operator|->
name|heartbeat_timer
operator|=
name|NULL
expr_stmt|;
name|server
operator|->
name|interface_interval
operator|=
literal|0
expr_stmt|;
name|server
operator|->
name|heartbeat_interval
operator|=
literal|0
expr_stmt|;
name|CHECKFATAL
argument_list|(
name|dns_zonemgr_create
argument_list|(
name|ns_g_mctx
argument_list|,
name|ns_g_taskmgr
argument_list|,
name|ns_g_timermgr
argument_list|,
name|ns_g_socketmgr
argument_list|,
operator|&
name|server
operator|->
name|zonemgr
argument_list|)
argument_list|,
literal|"dns_zonemgr_create"
argument_list|)
expr_stmt|;
name|server
operator|->
name|statsfile
operator|=
name|isc_mem_strdup
argument_list|(
name|server
operator|->
name|mctx
argument_list|,
literal|"named.stats"
argument_list|)
expr_stmt|;
name|CHECKFATAL
argument_list|(
name|server
operator|->
name|statsfile
operator|==
name|NULL
condition|?
name|ISC_R_NOMEMORY
else|:
name|ISC_R_SUCCESS
argument_list|,
literal|"isc_mem_strdup"
argument_list|)
expr_stmt|;
name|server
operator|->
name|querystats
operator|=
name|NULL
expr_stmt|;
name|server
operator|->
name|dumpfile
operator|=
name|isc_mem_strdup
argument_list|(
name|server
operator|->
name|mctx
argument_list|,
literal|"named_dump.db"
argument_list|)
expr_stmt|;
name|CHECKFATAL
argument_list|(
name|server
operator|->
name|dumpfile
operator|==
name|NULL
condition|?
name|ISC_R_NOMEMORY
else|:
name|ISC_R_SUCCESS
argument_list|,
literal|"isc_mem_strdup"
argument_list|)
expr_stmt|;
name|server
operator|->
name|recfile
operator|=
name|isc_mem_strdup
argument_list|(
name|server
operator|->
name|mctx
argument_list|,
literal|"named.recursing"
argument_list|)
expr_stmt|;
name|CHECKFATAL
argument_list|(
name|server
operator|->
name|recfile
operator|==
name|NULL
condition|?
name|ISC_R_NOMEMORY
else|:
name|ISC_R_SUCCESS
argument_list|,
literal|"isc_mem_strdup"
argument_list|)
expr_stmt|;
name|server
operator|->
name|hostname_set
operator|=
name|ISC_FALSE
expr_stmt|;
name|server
operator|->
name|hostname
operator|=
name|NULL
expr_stmt|;
name|server
operator|->
name|version_set
operator|=
name|ISC_FALSE
expr_stmt|;
name|server
operator|->
name|version
operator|=
name|NULL
expr_stmt|;
name|server
operator|->
name|server_usehostname
operator|=
name|ISC_FALSE
expr_stmt|;
name|server
operator|->
name|server_id
operator|=
name|NULL
expr_stmt|;
name|CHECKFATAL
argument_list|(
name|dns_stats_alloccounters
argument_list|(
name|ns_g_mctx
argument_list|,
operator|&
name|server
operator|->
name|querystats
argument_list|)
argument_list|,
literal|"dns_stats_alloccounters"
argument_list|)
expr_stmt|;
name|server
operator|->
name|flushonshutdown
operator|=
name|ISC_FALSE
expr_stmt|;
name|server
operator|->
name|log_queries
operator|=
name|ISC_FALSE
expr_stmt|;
name|server
operator|->
name|controls
operator|=
name|NULL
expr_stmt|;
name|CHECKFATAL
argument_list|(
name|ns_controls_create
argument_list|(
name|server
argument_list|,
operator|&
name|server
operator|->
name|controls
argument_list|)
argument_list|,
literal|"ns_controls_create"
argument_list|)
expr_stmt|;
name|server
operator|->
name|dispatchgen
operator|=
literal|0
expr_stmt|;
name|ISC_LIST_INIT
argument_list|(
name|server
operator|->
name|dispatches
argument_list|)
expr_stmt|;
name|server
operator|->
name|magic
operator|=
name|NS_SERVER_MAGIC
expr_stmt|;
operator|*
name|serverp
operator|=
name|server
expr_stmt|;
block|}
end_function

begin_function
name|void
name|ns_server_destroy
parameter_list|(
name|ns_server_t
modifier|*
modifier|*
name|serverp
parameter_list|)
block|{
name|ns_server_t
modifier|*
name|server
init|=
operator|*
name|serverp
decl_stmt|;
name|REQUIRE
argument_list|(
name|NS_SERVER_VALID
argument_list|(
name|server
argument_list|)
argument_list|)
expr_stmt|;
name|ns_controls_destroy
argument_list|(
operator|&
name|server
operator|->
name|controls
argument_list|)
expr_stmt|;
name|dns_stats_freecounters
argument_list|(
name|server
operator|->
name|mctx
argument_list|,
operator|&
name|server
operator|->
name|querystats
argument_list|)
expr_stmt|;
name|isc_mem_free
argument_list|(
name|server
operator|->
name|mctx
argument_list|,
name|server
operator|->
name|statsfile
argument_list|)
expr_stmt|;
name|isc_mem_free
argument_list|(
name|server
operator|->
name|mctx
argument_list|,
name|server
operator|->
name|dumpfile
argument_list|)
expr_stmt|;
name|isc_mem_free
argument_list|(
name|server
operator|->
name|mctx
argument_list|,
name|server
operator|->
name|recfile
argument_list|)
expr_stmt|;
if|if
condition|(
name|server
operator|->
name|version
operator|!=
name|NULL
condition|)
name|isc_mem_free
argument_list|(
name|server
operator|->
name|mctx
argument_list|,
name|server
operator|->
name|version
argument_list|)
expr_stmt|;
if|if
condition|(
name|server
operator|->
name|hostname
operator|!=
name|NULL
condition|)
name|isc_mem_free
argument_list|(
name|server
operator|->
name|mctx
argument_list|,
name|server
operator|->
name|hostname
argument_list|)
expr_stmt|;
if|if
condition|(
name|server
operator|->
name|server_id
operator|!=
name|NULL
condition|)
name|isc_mem_free
argument_list|(
name|server
operator|->
name|mctx
argument_list|,
name|server
operator|->
name|server_id
argument_list|)
expr_stmt|;
name|dns_zonemgr_detach
argument_list|(
operator|&
name|server
operator|->
name|zonemgr
argument_list|)
expr_stmt|;
if|if
condition|(
name|server
operator|->
name|tkeyctx
operator|!=
name|NULL
condition|)
name|dns_tkeyctx_destroy
argument_list|(
operator|&
name|server
operator|->
name|tkeyctx
argument_list|)
expr_stmt|;
name|dst_lib_destroy
argument_list|()
expr_stmt|;
name|isc_event_free
argument_list|(
operator|&
name|server
operator|->
name|reload_event
argument_list|)
expr_stmt|;
name|INSIST
argument_list|(
name|ISC_LIST_EMPTY
argument_list|(
name|server
operator|->
name|viewlist
argument_list|)
argument_list|)
expr_stmt|;
name|dns_aclenv_destroy
argument_list|(
operator|&
name|server
operator|->
name|aclenv
argument_list|)
expr_stmt|;
name|isc_quota_destroy
argument_list|(
operator|&
name|server
operator|->
name|recursionquota
argument_list|)
expr_stmt|;
name|isc_quota_destroy
argument_list|(
operator|&
name|server
operator|->
name|tcpquota
argument_list|)
expr_stmt|;
name|isc_quota_destroy
argument_list|(
operator|&
name|server
operator|->
name|xfroutquota
argument_list|)
expr_stmt|;
name|server
operator|->
name|magic
operator|=
literal|0
expr_stmt|;
name|isc_mem_put
argument_list|(
name|server
operator|->
name|mctx
argument_list|,
name|server
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|server
argument_list|)
argument_list|)
expr_stmt|;
operator|*
name|serverp
operator|=
name|NULL
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|fatal
parameter_list|(
specifier|const
name|char
modifier|*
name|msg
parameter_list|,
name|isc_result_t
name|result
parameter_list|)
block|{
name|isc_log_write
argument_list|(
name|ns_g_lctx
argument_list|,
name|NS_LOGCATEGORY_GENERAL
argument_list|,
name|NS_LOGMODULE_SERVER
argument_list|,
name|ISC_LOG_CRITICAL
argument_list|,
literal|"%s: %s"
argument_list|,
name|msg
argument_list|,
name|isc_result_totext
argument_list|(
name|result
argument_list|)
argument_list|)
expr_stmt|;
name|isc_log_write
argument_list|(
name|ns_g_lctx
argument_list|,
name|NS_LOGCATEGORY_GENERAL
argument_list|,
name|NS_LOGMODULE_SERVER
argument_list|,
name|ISC_LOG_CRITICAL
argument_list|,
literal|"exiting (due to fatal error)"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|start_reserved_dispatches
parameter_list|(
name|ns_server_t
modifier|*
name|server
parameter_list|)
block|{
name|REQUIRE
argument_list|(
name|NS_SERVER_VALID
argument_list|(
name|server
argument_list|)
argument_list|)
expr_stmt|;
name|server
operator|->
name|dispatchgen
operator|++
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|end_reserved_dispatches
parameter_list|(
name|ns_server_t
modifier|*
name|server
parameter_list|,
name|isc_boolean_t
name|all
parameter_list|)
block|{
name|ns_dispatch_t
modifier|*
name|dispatch
decl_stmt|,
modifier|*
name|nextdispatch
decl_stmt|;
name|REQUIRE
argument_list|(
name|NS_SERVER_VALID
argument_list|(
name|server
argument_list|)
argument_list|)
expr_stmt|;
for|for
control|(
name|dispatch
operator|=
name|ISC_LIST_HEAD
argument_list|(
name|server
operator|->
name|dispatches
argument_list|)
init|;
name|dispatch
operator|!=
name|NULL
condition|;
name|dispatch
operator|=
name|nextdispatch
control|)
block|{
name|nextdispatch
operator|=
name|ISC_LIST_NEXT
argument_list|(
name|dispatch
argument_list|,
name|link
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|all
operator|&&
name|server
operator|->
name|dispatchgen
operator|==
name|dispatch
operator|->
name|dispatchgen
condition|)
continue|continue;
name|ISC_LIST_UNLINK
argument_list|(
name|server
operator|->
name|dispatches
argument_list|,
name|dispatch
argument_list|,
name|link
argument_list|)
expr_stmt|;
name|dns_dispatch_detach
argument_list|(
operator|&
name|dispatch
operator|->
name|dispatch
argument_list|)
expr_stmt|;
name|isc_mem_put
argument_list|(
name|server
operator|->
name|mctx
argument_list|,
name|dispatch
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|dispatch
argument_list|)
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
name|void
name|ns_add_reserved_dispatch
parameter_list|(
name|ns_server_t
modifier|*
name|server
parameter_list|,
specifier|const
name|isc_sockaddr_t
modifier|*
name|addr
parameter_list|)
block|{
name|ns_dispatch_t
modifier|*
name|dispatch
decl_stmt|;
name|in_port_t
name|port
decl_stmt|;
name|char
name|addrbuf
index|[
name|ISC_SOCKADDR_FORMATSIZE
index|]
decl_stmt|;
name|isc_result_t
name|result
decl_stmt|;
name|unsigned
name|int
name|attrs
decl_stmt|,
name|attrmask
decl_stmt|;
name|REQUIRE
argument_list|(
name|NS_SERVER_VALID
argument_list|(
name|server
argument_list|)
argument_list|)
expr_stmt|;
name|port
operator|=
name|isc_sockaddr_getport
argument_list|(
name|addr
argument_list|)
expr_stmt|;
if|if
condition|(
name|port
operator|==
literal|0
operator|||
name|port
operator|>=
literal|1024
condition|)
return|return;
for|for
control|(
name|dispatch
operator|=
name|ISC_LIST_HEAD
argument_list|(
name|server
operator|->
name|dispatches
argument_list|)
init|;
name|dispatch
operator|!=
name|NULL
condition|;
name|dispatch
operator|=
name|ISC_LIST_NEXT
argument_list|(
name|dispatch
argument_list|,
name|link
argument_list|)
control|)
block|{
if|if
condition|(
name|isc_sockaddr_equal
argument_list|(
operator|&
name|dispatch
operator|->
name|addr
argument_list|,
name|addr
argument_list|)
condition|)
break|break;
block|}
if|if
condition|(
name|dispatch
operator|!=
name|NULL
condition|)
block|{
name|dispatch
operator|->
name|dispatchgen
operator|=
name|server
operator|->
name|dispatchgen
expr_stmt|;
return|return;
block|}
name|dispatch
operator|=
name|isc_mem_get
argument_list|(
name|server
operator|->
name|mctx
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|dispatch
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|dispatch
operator|==
name|NULL
condition|)
block|{
name|result
operator|=
name|ISC_R_NOMEMORY
expr_stmt|;
goto|goto
name|cleanup
goto|;
block|}
name|dispatch
operator|->
name|addr
operator|=
operator|*
name|addr
expr_stmt|;
name|dispatch
operator|->
name|dispatchgen
operator|=
name|server
operator|->
name|dispatchgen
expr_stmt|;
name|dispatch
operator|->
name|dispatch
operator|=
name|NULL
expr_stmt|;
name|attrs
operator|=
literal|0
expr_stmt|;
name|attrs
operator||=
name|DNS_DISPATCHATTR_UDP
expr_stmt|;
switch|switch
condition|(
name|isc_sockaddr_pf
argument_list|(
name|addr
argument_list|)
condition|)
block|{
case|case
name|AF_INET
case|:
name|attrs
operator||=
name|DNS_DISPATCHATTR_IPV4
expr_stmt|;
break|break;
case|case
name|AF_INET6
case|:
name|attrs
operator||=
name|DNS_DISPATCHATTR_IPV6
expr_stmt|;
break|break;
default|default:
name|result
operator|=
name|ISC_R_NOTIMPLEMENTED
expr_stmt|;
goto|goto
name|cleanup
goto|;
block|}
name|attrmask
operator|=
literal|0
expr_stmt|;
name|attrmask
operator||=
name|DNS_DISPATCHATTR_UDP
expr_stmt|;
name|attrmask
operator||=
name|DNS_DISPATCHATTR_TCP
expr_stmt|;
name|attrmask
operator||=
name|DNS_DISPATCHATTR_IPV4
expr_stmt|;
name|attrmask
operator||=
name|DNS_DISPATCHATTR_IPV6
expr_stmt|;
name|result
operator|=
name|dns_dispatch_getudp
argument_list|(
name|ns_g_dispatchmgr
argument_list|,
name|ns_g_socketmgr
argument_list|,
name|ns_g_taskmgr
argument_list|,
operator|&
name|dispatch
operator|->
name|addr
argument_list|,
literal|4096
argument_list|,
literal|1000
argument_list|,
literal|32768
argument_list|,
literal|16411
argument_list|,
literal|16433
argument_list|,
name|attrs
argument_list|,
name|attrmask
argument_list|,
operator|&
name|dispatch
operator|->
name|dispatch
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
goto|goto
name|cleanup
goto|;
name|ISC_LIST_INITANDPREPEND
argument_list|(
name|server
operator|->
name|dispatches
argument_list|,
name|dispatch
argument_list|,
name|link
argument_list|)
expr_stmt|;
return|return;
name|cleanup
label|:
if|if
condition|(
name|dispatch
operator|!=
name|NULL
condition|)
name|isc_mem_put
argument_list|(
name|server
operator|->
name|mctx
argument_list|,
name|dispatch
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|dispatch
argument_list|)
argument_list|)
expr_stmt|;
name|isc_sockaddr_format
argument_list|(
name|addr
argument_list|,
name|addrbuf
argument_list|,
sizeof|sizeof
argument_list|(
name|addrbuf
argument_list|)
argument_list|)
expr_stmt|;
name|isc_log_write
argument_list|(
name|ns_g_lctx
argument_list|,
name|NS_LOGCATEGORY_GENERAL
argument_list|,
name|NS_LOGMODULE_SERVER
argument_list|,
name|ISC_LOG_WARNING
argument_list|,
literal|"unable to create dispatch for reserved port %s: %s"
argument_list|,
name|addrbuf
argument_list|,
name|isc_result_totext
argument_list|(
name|result
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|isc_result_t
name|loadconfig
parameter_list|(
name|ns_server_t
modifier|*
name|server
parameter_list|)
block|{
name|isc_result_t
name|result
decl_stmt|;
name|start_reserved_dispatches
argument_list|(
name|server
argument_list|)
expr_stmt|;
name|result
operator|=
name|load_configuration
argument_list|(
name|ns_g_lwresdonly
condition|?
name|lwresd_g_conffile
else|:
name|ns_g_conffile
argument_list|,
name|server
argument_list|,
name|ISC_FALSE
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|==
name|ISC_R_SUCCESS
condition|)
name|end_reserved_dispatches
argument_list|(
name|server
argument_list|,
name|ISC_FALSE
argument_list|)
expr_stmt|;
else|else
name|isc_log_write
argument_list|(
name|ns_g_lctx
argument_list|,
name|NS_LOGCATEGORY_GENERAL
argument_list|,
name|NS_LOGMODULE_SERVER
argument_list|,
name|ISC_LOG_ERROR
argument_list|,
literal|"reloading configuration failed: %s"
argument_list|,
name|isc_result_totext
argument_list|(
name|result
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|(
name|result
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|isc_result_t
name|reload
parameter_list|(
name|ns_server_t
modifier|*
name|server
parameter_list|)
block|{
name|isc_result_t
name|result
decl_stmt|;
name|CHECK
argument_list|(
name|loadconfig
argument_list|(
name|server
argument_list|)
argument_list|)
expr_stmt|;
name|result
operator|=
name|load_zones
argument_list|(
name|server
argument_list|,
name|ISC_FALSE
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
block|{
name|isc_log_write
argument_list|(
name|ns_g_lctx
argument_list|,
name|NS_LOGCATEGORY_GENERAL
argument_list|,
name|NS_LOGMODULE_SERVER
argument_list|,
name|ISC_LOG_ERROR
argument_list|,
literal|"reloading zones failed: %s"
argument_list|,
name|isc_result_totext
argument_list|(
name|result
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|cleanup
label|:
return|return
operator|(
name|result
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|reconfig
parameter_list|(
name|ns_server_t
modifier|*
name|server
parameter_list|)
block|{
name|isc_result_t
name|result
decl_stmt|;
name|CHECK
argument_list|(
name|loadconfig
argument_list|(
name|server
argument_list|)
argument_list|)
expr_stmt|;
name|result
operator|=
name|load_new_zones
argument_list|(
name|server
argument_list|,
name|ISC_FALSE
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
block|{
name|isc_log_write
argument_list|(
name|ns_g_lctx
argument_list|,
name|NS_LOGCATEGORY_GENERAL
argument_list|,
name|NS_LOGMODULE_SERVER
argument_list|,
name|ISC_LOG_ERROR
argument_list|,
literal|"loading new zones failed: %s"
argument_list|,
name|isc_result_totext
argument_list|(
name|result
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|cleanup
label|:
empty_stmt|;
block|}
end_function

begin_comment
comment|/*  * Handle a reload event (from SIGHUP).  */
end_comment

begin_function
specifier|static
name|void
name|ns_server_reload
parameter_list|(
name|isc_task_t
modifier|*
name|task
parameter_list|,
name|isc_event_t
modifier|*
name|event
parameter_list|)
block|{
name|ns_server_t
modifier|*
name|server
init|=
operator|(
name|ns_server_t
operator|*
operator|)
name|event
operator|->
name|ev_arg
decl_stmt|;
name|INSIST
argument_list|(
name|task
operator|=
name|server
operator|->
name|task
argument_list|)
expr_stmt|;
name|UNUSED
argument_list|(
name|task
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|reload
argument_list|(
name|server
argument_list|)
expr_stmt|;
name|LOCK
argument_list|(
operator|&
name|server
operator|->
name|reload_event_lock
argument_list|)
expr_stmt|;
name|INSIST
argument_list|(
name|server
operator|->
name|reload_event
operator|==
name|NULL
argument_list|)
expr_stmt|;
name|server
operator|->
name|reload_event
operator|=
name|event
expr_stmt|;
name|UNLOCK
argument_list|(
operator|&
name|server
operator|->
name|reload_event_lock
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|ns_server_reloadwanted
parameter_list|(
name|ns_server_t
modifier|*
name|server
parameter_list|)
block|{
name|LOCK
argument_list|(
operator|&
name|server
operator|->
name|reload_event_lock
argument_list|)
expr_stmt|;
if|if
condition|(
name|server
operator|->
name|reload_event
operator|!=
name|NULL
condition|)
name|isc_task_send
argument_list|(
name|server
operator|->
name|task
argument_list|,
operator|&
name|server
operator|->
name|reload_event
argument_list|)
expr_stmt|;
name|UNLOCK
argument_list|(
operator|&
name|server
operator|->
name|reload_event_lock
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|char
modifier|*
name|next_token
parameter_list|(
name|char
modifier|*
modifier|*
name|stringp
parameter_list|,
specifier|const
name|char
modifier|*
name|delim
parameter_list|)
block|{
name|char
modifier|*
name|res
decl_stmt|;
do|do
block|{
name|res
operator|=
name|strsep
argument_list|(
name|stringp
argument_list|,
name|delim
argument_list|)
expr_stmt|;
if|if
condition|(
name|res
operator|==
name|NULL
condition|)
break|break;
block|}
do|while
condition|(
operator|*
name|res
operator|==
literal|'\0'
condition|)
do|;
return|return
operator|(
name|res
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Find the zone specified in the control channel command 'args',  * if any.  If a zone is specified, point '*zonep' at it, otherwise  * set '*zonep' to NULL.  */
end_comment

begin_function
specifier|static
name|isc_result_t
name|zone_from_args
parameter_list|(
name|ns_server_t
modifier|*
name|server
parameter_list|,
name|char
modifier|*
name|args
parameter_list|,
name|dns_zone_t
modifier|*
modifier|*
name|zonep
parameter_list|)
block|{
name|char
modifier|*
name|input
decl_stmt|,
modifier|*
name|ptr
decl_stmt|;
specifier|const
name|char
modifier|*
name|zonetxt
decl_stmt|;
name|char
modifier|*
name|classtxt
decl_stmt|;
specifier|const
name|char
modifier|*
name|viewtxt
init|=
name|NULL
decl_stmt|;
name|dns_fixedname_t
name|name
decl_stmt|;
name|isc_result_t
name|result
decl_stmt|;
name|isc_buffer_t
name|buf
decl_stmt|;
name|dns_view_t
modifier|*
name|view
init|=
name|NULL
decl_stmt|;
name|dns_rdataclass_t
name|rdclass
decl_stmt|;
name|REQUIRE
argument_list|(
name|zonep
operator|!=
name|NULL
operator|&&
operator|*
name|zonep
operator|==
name|NULL
argument_list|)
expr_stmt|;
name|input
operator|=
name|args
expr_stmt|;
comment|/* Skip the command name. */
name|ptr
operator|=
name|next_token
argument_list|(
operator|&
name|input
argument_list|,
literal|" \t"
argument_list|)
expr_stmt|;
if|if
condition|(
name|ptr
operator|==
name|NULL
condition|)
return|return
operator|(
name|ISC_R_UNEXPECTEDEND
operator|)
return|;
comment|/* Look for the zone name. */
name|zonetxt
operator|=
name|next_token
argument_list|(
operator|&
name|input
argument_list|,
literal|" \t"
argument_list|)
expr_stmt|;
if|if
condition|(
name|zonetxt
operator|==
name|NULL
condition|)
return|return
operator|(
name|ISC_R_SUCCESS
operator|)
return|;
comment|/* Look for the optional class name. */
name|classtxt
operator|=
name|next_token
argument_list|(
operator|&
name|input
argument_list|,
literal|" \t"
argument_list|)
expr_stmt|;
if|if
condition|(
name|classtxt
operator|!=
name|NULL
condition|)
block|{
comment|/* Look for the optional view name. */
name|viewtxt
operator|=
name|next_token
argument_list|(
operator|&
name|input
argument_list|,
literal|" \t"
argument_list|)
expr_stmt|;
block|}
name|isc_buffer_init
argument_list|(
operator|&
name|buf
argument_list|,
name|zonetxt
argument_list|,
name|strlen
argument_list|(
name|zonetxt
argument_list|)
argument_list|)
expr_stmt|;
name|isc_buffer_add
argument_list|(
operator|&
name|buf
argument_list|,
name|strlen
argument_list|(
name|zonetxt
argument_list|)
argument_list|)
expr_stmt|;
name|dns_fixedname_init
argument_list|(
operator|&
name|name
argument_list|)
expr_stmt|;
name|result
operator|=
name|dns_name_fromtext
argument_list|(
name|dns_fixedname_name
argument_list|(
operator|&
name|name
argument_list|)
argument_list|,
operator|&
name|buf
argument_list|,
name|dns_rootname
argument_list|,
name|ISC_FALSE
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
goto|goto
name|fail1
goto|;
if|if
condition|(
name|classtxt
operator|!=
name|NULL
condition|)
block|{
name|isc_textregion_t
name|r
decl_stmt|;
name|r
operator|.
name|base
operator|=
name|classtxt
expr_stmt|;
name|r
operator|.
name|length
operator|=
name|strlen
argument_list|(
name|classtxt
argument_list|)
expr_stmt|;
name|result
operator|=
name|dns_rdataclass_fromtext
argument_list|(
operator|&
name|rdclass
argument_list|,
operator|&
name|r
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
goto|goto
name|fail1
goto|;
block|}
else|else
block|{
name|rdclass
operator|=
name|dns_rdataclass_in
expr_stmt|;
block|}
if|if
condition|(
name|viewtxt
operator|==
name|NULL
condition|)
name|viewtxt
operator|=
literal|"_default"
expr_stmt|;
name|result
operator|=
name|dns_viewlist_find
argument_list|(
operator|&
name|server
operator|->
name|viewlist
argument_list|,
name|viewtxt
argument_list|,
name|rdclass
argument_list|,
operator|&
name|view
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
goto|goto
name|fail1
goto|;
name|result
operator|=
name|dns_zt_find
argument_list|(
name|view
operator|->
name|zonetable
argument_list|,
name|dns_fixedname_name
argument_list|(
operator|&
name|name
argument_list|)
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|,
name|zonep
argument_list|)
expr_stmt|;
comment|/* Partial match? */
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
operator|&&
operator|*
name|zonep
operator|!=
name|NULL
condition|)
name|dns_zone_detach
argument_list|(
name|zonep
argument_list|)
expr_stmt|;
name|dns_view_detach
argument_list|(
operator|&
name|view
argument_list|)
expr_stmt|;
name|fail1
label|:
return|return
operator|(
name|result
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Act on a "retransfer" command from the command channel.  */
end_comment

begin_function
name|isc_result_t
name|ns_server_retransfercommand
parameter_list|(
name|ns_server_t
modifier|*
name|server
parameter_list|,
name|char
modifier|*
name|args
parameter_list|)
block|{
name|isc_result_t
name|result
decl_stmt|;
name|dns_zone_t
modifier|*
name|zone
init|=
name|NULL
decl_stmt|;
name|dns_zonetype_t
name|type
decl_stmt|;
name|result
operator|=
name|zone_from_args
argument_list|(
name|server
argument_list|,
name|args
argument_list|,
operator|&
name|zone
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
return|return
operator|(
name|result
operator|)
return|;
if|if
condition|(
name|zone
operator|==
name|NULL
condition|)
return|return
operator|(
name|ISC_R_UNEXPECTEDEND
operator|)
return|;
name|type
operator|=
name|dns_zone_gettype
argument_list|(
name|zone
argument_list|)
expr_stmt|;
if|if
condition|(
name|type
operator|==
name|dns_zone_slave
operator|||
name|type
operator|==
name|dns_zone_stub
condition|)
name|dns_zone_forcereload
argument_list|(
name|zone
argument_list|)
expr_stmt|;
else|else
name|result
operator|=
name|ISC_R_NOTFOUND
expr_stmt|;
name|dns_zone_detach
argument_list|(
operator|&
name|zone
argument_list|)
expr_stmt|;
return|return
operator|(
name|result
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Act on a "reload" command from the command channel.  */
end_comment

begin_function
name|isc_result_t
name|ns_server_reloadcommand
parameter_list|(
name|ns_server_t
modifier|*
name|server
parameter_list|,
name|char
modifier|*
name|args
parameter_list|,
name|isc_buffer_t
modifier|*
name|text
parameter_list|)
block|{
name|isc_result_t
name|result
decl_stmt|;
name|dns_zone_t
modifier|*
name|zone
init|=
name|NULL
decl_stmt|;
name|dns_zonetype_t
name|type
decl_stmt|;
specifier|const
name|char
modifier|*
name|msg
init|=
name|NULL
decl_stmt|;
name|result
operator|=
name|zone_from_args
argument_list|(
name|server
argument_list|,
name|args
argument_list|,
operator|&
name|zone
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
return|return
operator|(
name|result
operator|)
return|;
if|if
condition|(
name|zone
operator|==
name|NULL
condition|)
block|{
name|result
operator|=
name|reload
argument_list|(
name|server
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|==
name|ISC_R_SUCCESS
condition|)
name|msg
operator|=
literal|"server reload successful"
expr_stmt|;
block|}
else|else
block|{
name|type
operator|=
name|dns_zone_gettype
argument_list|(
name|zone
argument_list|)
expr_stmt|;
if|if
condition|(
name|type
operator|==
name|dns_zone_slave
operator|||
name|type
operator|==
name|dns_zone_stub
condition|)
block|{
name|dns_zone_refresh
argument_list|(
name|zone
argument_list|)
expr_stmt|;
name|dns_zone_detach
argument_list|(
operator|&
name|zone
argument_list|)
expr_stmt|;
name|msg
operator|=
literal|"zone refresh queued"
expr_stmt|;
block|}
else|else
block|{
name|result
operator|=
name|dns_zone_load
argument_list|(
name|zone
argument_list|)
expr_stmt|;
name|dns_zone_detach
argument_list|(
operator|&
name|zone
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|result
condition|)
block|{
case|case
name|ISC_R_SUCCESS
case|:
name|msg
operator|=
literal|"zone reload successful"
expr_stmt|;
break|break;
case|case
name|DNS_R_CONTINUE
case|:
name|msg
operator|=
literal|"zone reload queued"
expr_stmt|;
name|result
operator|=
name|ISC_R_SUCCESS
expr_stmt|;
break|break;
case|case
name|DNS_R_UPTODATE
case|:
name|msg
operator|=
literal|"zone reload up-to-date"
expr_stmt|;
name|result
operator|=
name|ISC_R_SUCCESS
expr_stmt|;
break|break;
default|default:
comment|/* failure message will be generated by rndc */
break|break;
block|}
block|}
block|}
if|if
condition|(
name|msg
operator|!=
name|NULL
operator|&&
name|strlen
argument_list|(
name|msg
argument_list|)
operator|<
name|isc_buffer_availablelength
argument_list|(
name|text
argument_list|)
condition|)
name|isc_buffer_putmem
argument_list|(
name|text
argument_list|,
operator|(
specifier|const
name|unsigned
name|char
operator|*
operator|)
name|msg
argument_list|,
name|strlen
argument_list|(
name|msg
argument_list|)
operator|+
literal|1
argument_list|)
expr_stmt|;
return|return
operator|(
name|result
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Act on a "reconfig" command from the command channel.  */
end_comment

begin_function
name|isc_result_t
name|ns_server_reconfigcommand
parameter_list|(
name|ns_server_t
modifier|*
name|server
parameter_list|,
name|char
modifier|*
name|args
parameter_list|)
block|{
name|UNUSED
argument_list|(
name|args
argument_list|)
expr_stmt|;
name|reconfig
argument_list|(
name|server
argument_list|)
expr_stmt|;
return|return
operator|(
name|ISC_R_SUCCESS
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Act on a "refresh" command from the command channel.  */
end_comment

begin_function
name|isc_result_t
name|ns_server_refreshcommand
parameter_list|(
name|ns_server_t
modifier|*
name|server
parameter_list|,
name|char
modifier|*
name|args
parameter_list|,
name|isc_buffer_t
modifier|*
name|text
parameter_list|)
block|{
name|isc_result_t
name|result
decl_stmt|;
name|dns_zone_t
modifier|*
name|zone
init|=
name|NULL
decl_stmt|;
specifier|const
name|unsigned
name|char
name|msg1
index|[]
init|=
literal|"zone refresh queued"
decl_stmt|;
specifier|const
name|unsigned
name|char
name|msg2
index|[]
init|=
literal|"not a slave or stub zone"
decl_stmt|;
name|dns_zonetype_t
name|type
decl_stmt|;
name|result
operator|=
name|zone_from_args
argument_list|(
name|server
argument_list|,
name|args
argument_list|,
operator|&
name|zone
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
return|return
operator|(
name|result
operator|)
return|;
if|if
condition|(
name|zone
operator|==
name|NULL
condition|)
return|return
operator|(
name|ISC_R_UNEXPECTEDEND
operator|)
return|;
name|type
operator|=
name|dns_zone_gettype
argument_list|(
name|zone
argument_list|)
expr_stmt|;
if|if
condition|(
name|type
operator|==
name|dns_zone_slave
operator|||
name|type
operator|==
name|dns_zone_stub
condition|)
block|{
name|dns_zone_refresh
argument_list|(
name|zone
argument_list|)
expr_stmt|;
name|dns_zone_detach
argument_list|(
operator|&
name|zone
argument_list|)
expr_stmt|;
if|if
condition|(
sizeof|sizeof
argument_list|(
name|msg1
argument_list|)
operator|<=
name|isc_buffer_availablelength
argument_list|(
name|text
argument_list|)
condition|)
name|isc_buffer_putmem
argument_list|(
name|text
argument_list|,
name|msg1
argument_list|,
sizeof|sizeof
argument_list|(
name|msg1
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|(
name|ISC_R_SUCCESS
operator|)
return|;
block|}
name|dns_zone_detach
argument_list|(
operator|&
name|zone
argument_list|)
expr_stmt|;
if|if
condition|(
sizeof|sizeof
argument_list|(
name|msg2
argument_list|)
operator|<=
name|isc_buffer_availablelength
argument_list|(
name|text
argument_list|)
condition|)
name|isc_buffer_putmem
argument_list|(
name|text
argument_list|,
name|msg2
argument_list|,
sizeof|sizeof
argument_list|(
name|msg2
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|(
name|ISC_R_FAILURE
operator|)
return|;
block|}
end_function

begin_function
name|isc_result_t
name|ns_server_togglequerylog
parameter_list|(
name|ns_server_t
modifier|*
name|server
parameter_list|)
block|{
name|server
operator|->
name|log_queries
operator|=
name|server
operator|->
name|log_queries
condition|?
name|ISC_FALSE
else|:
name|ISC_TRUE
expr_stmt|;
name|isc_log_write
argument_list|(
name|ns_g_lctx
argument_list|,
name|NS_LOGCATEGORY_GENERAL
argument_list|,
name|NS_LOGMODULE_SERVER
argument_list|,
name|ISC_LOG_INFO
argument_list|,
literal|"query logging is now %s"
argument_list|,
name|server
operator|->
name|log_queries
condition|?
literal|"on"
else|:
literal|"off"
argument_list|)
expr_stmt|;
return|return
operator|(
name|ISC_R_SUCCESS
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|isc_result_t
name|ns_listenlist_fromconfig
parameter_list|(
specifier|const
name|cfg_obj_t
modifier|*
name|listenlist
parameter_list|,
specifier|const
name|cfg_obj_t
modifier|*
name|config
parameter_list|,
name|ns_aclconfctx_t
modifier|*
name|actx
parameter_list|,
name|isc_mem_t
modifier|*
name|mctx
parameter_list|,
name|ns_listenlist_t
modifier|*
modifier|*
name|target
parameter_list|)
block|{
name|isc_result_t
name|result
decl_stmt|;
specifier|const
name|cfg_listelt_t
modifier|*
name|element
decl_stmt|;
name|ns_listenlist_t
modifier|*
name|dlist
init|=
name|NULL
decl_stmt|;
name|REQUIRE
argument_list|(
name|target
operator|!=
name|NULL
operator|&&
operator|*
name|target
operator|==
name|NULL
argument_list|)
expr_stmt|;
name|result
operator|=
name|ns_listenlist_create
argument_list|(
name|mctx
argument_list|,
operator|&
name|dlist
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
return|return
operator|(
name|result
operator|)
return|;
for|for
control|(
name|element
operator|=
name|cfg_list_first
argument_list|(
name|listenlist
argument_list|)
init|;
name|element
operator|!=
name|NULL
condition|;
name|element
operator|=
name|cfg_list_next
argument_list|(
name|element
argument_list|)
control|)
block|{
name|ns_listenelt_t
modifier|*
name|delt
init|=
name|NULL
decl_stmt|;
specifier|const
name|cfg_obj_t
modifier|*
name|listener
init|=
name|cfg_listelt_value
argument_list|(
name|element
argument_list|)
decl_stmt|;
name|result
operator|=
name|ns_listenelt_fromconfig
argument_list|(
name|listener
argument_list|,
name|config
argument_list|,
name|actx
argument_list|,
name|mctx
argument_list|,
operator|&
name|delt
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
goto|goto
name|cleanup
goto|;
name|ISC_LIST_APPEND
argument_list|(
name|dlist
operator|->
name|elts
argument_list|,
name|delt
argument_list|,
name|link
argument_list|)
expr_stmt|;
block|}
operator|*
name|target
operator|=
name|dlist
expr_stmt|;
return|return
operator|(
name|ISC_R_SUCCESS
operator|)
return|;
name|cleanup
label|:
name|ns_listenlist_detach
argument_list|(
operator|&
name|dlist
argument_list|)
expr_stmt|;
return|return
operator|(
name|result
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Create a listen list from the corresponding configuration  * data structure.  */
end_comment

begin_function
specifier|static
name|isc_result_t
name|ns_listenelt_fromconfig
parameter_list|(
specifier|const
name|cfg_obj_t
modifier|*
name|listener
parameter_list|,
specifier|const
name|cfg_obj_t
modifier|*
name|config
parameter_list|,
name|ns_aclconfctx_t
modifier|*
name|actx
parameter_list|,
name|isc_mem_t
modifier|*
name|mctx
parameter_list|,
name|ns_listenelt_t
modifier|*
modifier|*
name|target
parameter_list|)
block|{
name|isc_result_t
name|result
decl_stmt|;
specifier|const
name|cfg_obj_t
modifier|*
name|portobj
decl_stmt|;
name|in_port_t
name|port
decl_stmt|;
name|ns_listenelt_t
modifier|*
name|delt
init|=
name|NULL
decl_stmt|;
name|REQUIRE
argument_list|(
name|target
operator|!=
name|NULL
operator|&&
operator|*
name|target
operator|==
name|NULL
argument_list|)
expr_stmt|;
name|portobj
operator|=
name|cfg_tuple_get
argument_list|(
name|listener
argument_list|,
literal|"port"
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|cfg_obj_isuint32
argument_list|(
name|portobj
argument_list|)
condition|)
block|{
if|if
condition|(
name|ns_g_port
operator|!=
literal|0
condition|)
block|{
name|port
operator|=
name|ns_g_port
expr_stmt|;
block|}
else|else
block|{
name|result
operator|=
name|ns_config_getport
argument_list|(
name|config
argument_list|,
operator|&
name|port
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
return|return
operator|(
name|result
operator|)
return|;
block|}
block|}
else|else
block|{
if|if
condition|(
name|cfg_obj_asuint32
argument_list|(
name|portobj
argument_list|)
operator|>=
name|ISC_UINT16_MAX
condition|)
block|{
name|cfg_obj_log
argument_list|(
name|portobj
argument_list|,
name|ns_g_lctx
argument_list|,
name|ISC_LOG_ERROR
argument_list|,
literal|"port value '%u' is out of range"
argument_list|,
name|cfg_obj_asuint32
argument_list|(
name|portobj
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|(
name|ISC_R_RANGE
operator|)
return|;
block|}
name|port
operator|=
operator|(
name|in_port_t
operator|)
name|cfg_obj_asuint32
argument_list|(
name|portobj
argument_list|)
expr_stmt|;
block|}
name|result
operator|=
name|ns_listenelt_create
argument_list|(
name|mctx
argument_list|,
name|port
argument_list|,
name|NULL
argument_list|,
operator|&
name|delt
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
return|return
operator|(
name|result
operator|)
return|;
name|result
operator|=
name|ns_acl_fromconfig
argument_list|(
name|cfg_tuple_get
argument_list|(
name|listener
argument_list|,
literal|"acl"
argument_list|)
argument_list|,
name|config
argument_list|,
name|actx
argument_list|,
name|mctx
argument_list|,
operator|&
name|delt
operator|->
name|acl
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
block|{
name|ns_listenelt_destroy
argument_list|(
name|delt
argument_list|)
expr_stmt|;
return|return
operator|(
name|result
operator|)
return|;
block|}
operator|*
name|target
operator|=
name|delt
expr_stmt|;
return|return
operator|(
name|ISC_R_SUCCESS
operator|)
return|;
block|}
end_function

begin_function
name|isc_result_t
name|ns_server_dumpstats
parameter_list|(
name|ns_server_t
modifier|*
name|server
parameter_list|)
block|{
name|isc_result_t
name|result
decl_stmt|;
name|dns_zone_t
modifier|*
name|zone
decl_stmt|,
modifier|*
name|next
decl_stmt|;
name|isc_stdtime_t
name|now
decl_stmt|;
name|FILE
modifier|*
name|fp
init|=
name|NULL
decl_stmt|;
name|int
name|i
decl_stmt|;
name|int
name|ncounters
decl_stmt|;
name|isc_stdtime_get
argument_list|(
operator|&
name|now
argument_list|)
expr_stmt|;
name|CHECKMF
argument_list|(
name|isc_stdio_open
argument_list|(
name|server
operator|->
name|statsfile
argument_list|,
literal|"a"
argument_list|,
operator|&
name|fp
argument_list|)
argument_list|,
literal|"could not open statistics dump file"
argument_list|,
name|server
operator|->
name|statsfile
argument_list|)
expr_stmt|;
name|ncounters
operator|=
name|DNS_STATS_NCOUNTERS
expr_stmt|;
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"+++ Statistics Dump +++ (%lu)\n"
argument_list|,
operator|(
name|unsigned
name|long
operator|)
name|now
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|ncounters
condition|;
name|i
operator|++
control|)
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"%s %"
name|ISC_PRINT_QUADFORMAT
literal|"u\n"
argument_list|,
name|dns_statscounter_names
index|[
name|i
index|]
argument_list|,
name|server
operator|->
name|querystats
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|zone
operator|=
name|NULL
expr_stmt|;
for|for
control|(
name|result
operator|=
name|dns_zone_first
argument_list|(
name|server
operator|->
name|zonemgr
argument_list|,
operator|&
name|zone
argument_list|)
init|;
name|result
operator|==
name|ISC_R_SUCCESS
condition|;
name|next
operator|=
name|NULL
operator|,
name|result
operator|=
name|dns_zone_next
argument_list|(
name|zone
argument_list|,
operator|&
name|next
argument_list|)
operator|,
name|zone
operator|=
name|next
control|)
block|{
name|isc_uint64_t
modifier|*
name|zonestats
init|=
name|dns_zone_getstatscounters
argument_list|(
name|zone
argument_list|)
decl_stmt|;
if|if
condition|(
name|zonestats
operator|!=
name|NULL
condition|)
block|{
name|char
name|zonename
index|[
name|DNS_NAME_FORMATSIZE
index|]
decl_stmt|;
name|dns_view_t
modifier|*
name|view
decl_stmt|;
name|char
modifier|*
name|viewname
decl_stmt|;
name|dns_name_format
argument_list|(
name|dns_zone_getorigin
argument_list|(
name|zone
argument_list|)
argument_list|,
name|zonename
argument_list|,
sizeof|sizeof
argument_list|(
name|zonename
argument_list|)
argument_list|)
expr_stmt|;
name|view
operator|=
name|dns_zone_getview
argument_list|(
name|zone
argument_list|)
expr_stmt|;
name|viewname
operator|=
name|view
operator|->
name|name
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|ncounters
condition|;
name|i
operator|++
control|)
block|{
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"%s %"
name|ISC_PRINT_QUADFORMAT
literal|"u %s"
argument_list|,
name|dns_statscounter_names
index|[
name|i
index|]
argument_list|,
name|zonestats
index|[
name|i
index|]
argument_list|,
name|zonename
argument_list|)
expr_stmt|;
if|if
condition|(
name|strcmp
argument_list|(
name|viewname
argument_list|,
literal|"_default"
argument_list|)
operator|!=
literal|0
condition|)
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|" %s"
argument_list|,
name|viewname
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"\n"
argument_list|)
expr_stmt|;
block|}
block|}
block|}
if|if
condition|(
name|result
operator|==
name|ISC_R_NOMORE
condition|)
name|result
operator|=
name|ISC_R_SUCCESS
expr_stmt|;
name|CHECK
argument_list|(
name|result
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"--- Statistics Dump --- (%lu)\n"
argument_list|,
operator|(
name|unsigned
name|long
operator|)
name|now
argument_list|)
expr_stmt|;
name|cleanup
label|:
if|if
condition|(
name|fp
operator|!=
name|NULL
condition|)
operator|(
name|void
operator|)
name|isc_stdio_close
argument_list|(
name|fp
argument_list|)
expr_stmt|;
return|return
operator|(
name|result
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|isc_result_t
name|add_zone_tolist
parameter_list|(
name|dns_zone_t
modifier|*
name|zone
parameter_list|,
name|void
modifier|*
name|uap
parameter_list|)
block|{
name|struct
name|dumpcontext
modifier|*
name|dctx
init|=
name|uap
decl_stmt|;
name|struct
name|zonelistentry
modifier|*
name|zle
decl_stmt|;
name|zle
operator|=
name|isc_mem_get
argument_list|(
name|dctx
operator|->
name|mctx
argument_list|,
sizeof|sizeof
expr|*
name|zle
argument_list|)
expr_stmt|;
if|if
condition|(
name|zle
operator|==
name|NULL
condition|)
return|return
operator|(
name|ISC_R_NOMEMORY
operator|)
return|;
name|zle
operator|->
name|zone
operator|=
name|NULL
expr_stmt|;
name|dns_zone_attach
argument_list|(
name|zone
argument_list|,
operator|&
name|zle
operator|->
name|zone
argument_list|)
expr_stmt|;
name|ISC_LINK_INIT
argument_list|(
name|zle
argument_list|,
name|link
argument_list|)
expr_stmt|;
name|ISC_LIST_APPEND
argument_list|(
name|ISC_LIST_TAIL
argument_list|(
name|dctx
operator|->
name|viewlist
argument_list|)
operator|->
name|zonelist
argument_list|,
name|zle
argument_list|,
name|link
argument_list|)
expr_stmt|;
return|return
operator|(
name|ISC_R_SUCCESS
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|isc_result_t
name|add_view_tolist
parameter_list|(
name|struct
name|dumpcontext
modifier|*
name|dctx
parameter_list|,
name|dns_view_t
modifier|*
name|view
parameter_list|)
block|{
name|struct
name|viewlistentry
modifier|*
name|vle
decl_stmt|;
name|isc_result_t
name|result
init|=
name|ISC_R_SUCCESS
decl_stmt|;
comment|/* 	 * Prevent duplicate views. 	 */
for|for
control|(
name|vle
operator|=
name|ISC_LIST_HEAD
argument_list|(
name|dctx
operator|->
name|viewlist
argument_list|)
init|;
name|vle
operator|!=
name|NULL
condition|;
name|vle
operator|=
name|ISC_LIST_NEXT
argument_list|(
name|vle
argument_list|,
name|link
argument_list|)
control|)
if|if
condition|(
name|vle
operator|->
name|view
operator|==
name|view
condition|)
return|return
operator|(
name|ISC_R_SUCCESS
operator|)
return|;
name|vle
operator|=
name|isc_mem_get
argument_list|(
name|dctx
operator|->
name|mctx
argument_list|,
sizeof|sizeof
expr|*
name|vle
argument_list|)
expr_stmt|;
if|if
condition|(
name|vle
operator|==
name|NULL
condition|)
return|return
operator|(
name|ISC_R_NOMEMORY
operator|)
return|;
name|vle
operator|->
name|view
operator|=
name|NULL
expr_stmt|;
name|dns_view_attach
argument_list|(
name|view
argument_list|,
operator|&
name|vle
operator|->
name|view
argument_list|)
expr_stmt|;
name|ISC_LINK_INIT
argument_list|(
name|vle
argument_list|,
name|link
argument_list|)
expr_stmt|;
name|ISC_LIST_INIT
argument_list|(
name|vle
operator|->
name|zonelist
argument_list|)
expr_stmt|;
name|ISC_LIST_APPEND
argument_list|(
name|dctx
operator|->
name|viewlist
argument_list|,
name|vle
argument_list|,
name|link
argument_list|)
expr_stmt|;
if|if
condition|(
name|dctx
operator|->
name|dumpzones
condition|)
name|result
operator|=
name|dns_zt_apply
argument_list|(
name|view
operator|->
name|zonetable
argument_list|,
name|ISC_TRUE
argument_list|,
name|add_zone_tolist
argument_list|,
name|dctx
argument_list|)
expr_stmt|;
return|return
operator|(
name|result
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|dumpcontext_destroy
parameter_list|(
name|struct
name|dumpcontext
modifier|*
name|dctx
parameter_list|)
block|{
name|struct
name|viewlistentry
modifier|*
name|vle
decl_stmt|;
name|struct
name|zonelistentry
modifier|*
name|zle
decl_stmt|;
name|vle
operator|=
name|ISC_LIST_HEAD
argument_list|(
name|dctx
operator|->
name|viewlist
argument_list|)
expr_stmt|;
while|while
condition|(
name|vle
operator|!=
name|NULL
condition|)
block|{
name|ISC_LIST_UNLINK
argument_list|(
name|dctx
operator|->
name|viewlist
argument_list|,
name|vle
argument_list|,
name|link
argument_list|)
expr_stmt|;
name|zle
operator|=
name|ISC_LIST_HEAD
argument_list|(
name|vle
operator|->
name|zonelist
argument_list|)
expr_stmt|;
while|while
condition|(
name|zle
operator|!=
name|NULL
condition|)
block|{
name|ISC_LIST_UNLINK
argument_list|(
name|vle
operator|->
name|zonelist
argument_list|,
name|zle
argument_list|,
name|link
argument_list|)
expr_stmt|;
name|dns_zone_detach
argument_list|(
operator|&
name|zle
operator|->
name|zone
argument_list|)
expr_stmt|;
name|isc_mem_put
argument_list|(
name|dctx
operator|->
name|mctx
argument_list|,
name|zle
argument_list|,
sizeof|sizeof
expr|*
name|zle
argument_list|)
expr_stmt|;
name|zle
operator|=
name|ISC_LIST_HEAD
argument_list|(
name|vle
operator|->
name|zonelist
argument_list|)
expr_stmt|;
block|}
name|dns_view_detach
argument_list|(
operator|&
name|vle
operator|->
name|view
argument_list|)
expr_stmt|;
name|isc_mem_put
argument_list|(
name|dctx
operator|->
name|mctx
argument_list|,
name|vle
argument_list|,
sizeof|sizeof
expr|*
name|vle
argument_list|)
expr_stmt|;
name|vle
operator|=
name|ISC_LIST_HEAD
argument_list|(
name|dctx
operator|->
name|viewlist
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|dctx
operator|->
name|version
operator|!=
name|NULL
condition|)
name|dns_db_closeversion
argument_list|(
name|dctx
operator|->
name|db
argument_list|,
operator|&
name|dctx
operator|->
name|version
argument_list|,
name|ISC_FALSE
argument_list|)
expr_stmt|;
if|if
condition|(
name|dctx
operator|->
name|db
operator|!=
name|NULL
condition|)
name|dns_db_detach
argument_list|(
operator|&
name|dctx
operator|->
name|db
argument_list|)
expr_stmt|;
if|if
condition|(
name|dctx
operator|->
name|cache
operator|!=
name|NULL
condition|)
name|dns_db_detach
argument_list|(
operator|&
name|dctx
operator|->
name|cache
argument_list|)
expr_stmt|;
if|if
condition|(
name|dctx
operator|->
name|task
operator|!=
name|NULL
condition|)
name|isc_task_detach
argument_list|(
operator|&
name|dctx
operator|->
name|task
argument_list|)
expr_stmt|;
if|if
condition|(
name|dctx
operator|->
name|fp
operator|!=
name|NULL
condition|)
operator|(
name|void
operator|)
name|isc_stdio_close
argument_list|(
name|dctx
operator|->
name|fp
argument_list|)
expr_stmt|;
if|if
condition|(
name|dctx
operator|->
name|mdctx
operator|!=
name|NULL
condition|)
name|dns_dumpctx_detach
argument_list|(
operator|&
name|dctx
operator|->
name|mdctx
argument_list|)
expr_stmt|;
name|isc_mem_put
argument_list|(
name|dctx
operator|->
name|mctx
argument_list|,
name|dctx
argument_list|,
sizeof|sizeof
expr|*
name|dctx
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|dumpdone
parameter_list|(
name|void
modifier|*
name|arg
parameter_list|,
name|isc_result_t
name|result
parameter_list|)
block|{
name|struct
name|dumpcontext
modifier|*
name|dctx
init|=
name|arg
decl_stmt|;
name|char
name|buf
index|[
literal|1024
operator|+
literal|32
index|]
decl_stmt|;
specifier|const
name|dns_master_style_t
modifier|*
name|style
decl_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
goto|goto
name|cleanup
goto|;
if|if
condition|(
name|dctx
operator|->
name|mdctx
operator|!=
name|NULL
condition|)
name|dns_dumpctx_detach
argument_list|(
operator|&
name|dctx
operator|->
name|mdctx
argument_list|)
expr_stmt|;
if|if
condition|(
name|dctx
operator|->
name|view
operator|==
name|NULL
condition|)
block|{
name|dctx
operator|->
name|view
operator|=
name|ISC_LIST_HEAD
argument_list|(
name|dctx
operator|->
name|viewlist
argument_list|)
expr_stmt|;
if|if
condition|(
name|dctx
operator|->
name|view
operator|==
name|NULL
condition|)
goto|goto
name|done
goto|;
name|INSIST
argument_list|(
name|dctx
operator|->
name|zone
operator|==
name|NULL
argument_list|)
expr_stmt|;
block|}
else|else
goto|goto
name|resume
goto|;
name|nextview
label|:
name|fprintf
argument_list|(
name|dctx
operator|->
name|fp
argument_list|,
literal|";\n; Start view %s\n;\n"
argument_list|,
name|dctx
operator|->
name|view
operator|->
name|view
operator|->
name|name
argument_list|)
expr_stmt|;
name|resume
label|:
if|if
condition|(
name|dctx
operator|->
name|zone
operator|==
name|NULL
operator|&&
name|dctx
operator|->
name|cache
operator|==
name|NULL
operator|&&
name|dctx
operator|->
name|dumpcache
condition|)
block|{
name|style
operator|=
operator|&
name|dns_master_style_cache
expr_stmt|;
comment|/* start cache dump */
if|if
condition|(
name|dctx
operator|->
name|view
operator|->
name|view
operator|->
name|cachedb
operator|!=
name|NULL
condition|)
name|dns_db_attach
argument_list|(
name|dctx
operator|->
name|view
operator|->
name|view
operator|->
name|cachedb
argument_list|,
operator|&
name|dctx
operator|->
name|cache
argument_list|)
expr_stmt|;
if|if
condition|(
name|dctx
operator|->
name|cache
operator|!=
name|NULL
condition|)
block|{
name|fprintf
argument_list|(
name|dctx
operator|->
name|fp
argument_list|,
literal|";\n; Cache dump of view '%s'\n;\n"
argument_list|,
name|dctx
operator|->
name|view
operator|->
name|view
operator|->
name|name
argument_list|)
expr_stmt|;
name|result
operator|=
name|dns_master_dumptostreaminc
argument_list|(
name|dctx
operator|->
name|mctx
argument_list|,
name|dctx
operator|->
name|cache
argument_list|,
name|NULL
argument_list|,
name|style
argument_list|,
name|dctx
operator|->
name|fp
argument_list|,
name|dctx
operator|->
name|task
argument_list|,
name|dumpdone
argument_list|,
name|dctx
argument_list|,
operator|&
name|dctx
operator|->
name|mdctx
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|==
name|DNS_R_CONTINUE
condition|)
return|return;
if|if
condition|(
name|result
operator|==
name|ISC_R_NOTIMPLEMENTED
condition|)
name|fprintf
argument_list|(
name|dctx
operator|->
name|fp
argument_list|,
literal|"; %s\n"
argument_list|,
name|dns_result_totext
argument_list|(
name|result
argument_list|)
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
goto|goto
name|cleanup
goto|;
block|}
block|}
if|if
condition|(
name|dctx
operator|->
name|cache
operator|!=
name|NULL
condition|)
block|{
name|dns_adb_dump
argument_list|(
name|dctx
operator|->
name|view
operator|->
name|view
operator|->
name|adb
argument_list|,
name|dctx
operator|->
name|fp
argument_list|)
expr_stmt|;
name|dns_db_detach
argument_list|(
operator|&
name|dctx
operator|->
name|cache
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|dctx
operator|->
name|dumpzones
condition|)
block|{
name|style
operator|=
operator|&
name|dns_master_style_full
expr_stmt|;
name|nextzone
label|:
if|if
condition|(
name|dctx
operator|->
name|version
operator|!=
name|NULL
condition|)
name|dns_db_closeversion
argument_list|(
name|dctx
operator|->
name|db
argument_list|,
operator|&
name|dctx
operator|->
name|version
argument_list|,
name|ISC_FALSE
argument_list|)
expr_stmt|;
if|if
condition|(
name|dctx
operator|->
name|db
operator|!=
name|NULL
condition|)
name|dns_db_detach
argument_list|(
operator|&
name|dctx
operator|->
name|db
argument_list|)
expr_stmt|;
if|if
condition|(
name|dctx
operator|->
name|zone
operator|==
name|NULL
condition|)
name|dctx
operator|->
name|zone
operator|=
name|ISC_LIST_HEAD
argument_list|(
name|dctx
operator|->
name|view
operator|->
name|zonelist
argument_list|)
expr_stmt|;
else|else
name|dctx
operator|->
name|zone
operator|=
name|ISC_LIST_NEXT
argument_list|(
name|dctx
operator|->
name|zone
argument_list|,
name|link
argument_list|)
expr_stmt|;
if|if
condition|(
name|dctx
operator|->
name|zone
operator|!=
name|NULL
condition|)
block|{
comment|/* start zone dump */
name|dns_zone_name
argument_list|(
name|dctx
operator|->
name|zone
operator|->
name|zone
argument_list|,
name|buf
argument_list|,
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|dctx
operator|->
name|fp
argument_list|,
literal|";\n; Zone dump of '%s'\n;\n"
argument_list|,
name|buf
argument_list|)
expr_stmt|;
name|result
operator|=
name|dns_zone_getdb
argument_list|(
name|dctx
operator|->
name|zone
operator|->
name|zone
argument_list|,
operator|&
name|dctx
operator|->
name|db
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
block|{
name|fprintf
argument_list|(
name|dctx
operator|->
name|fp
argument_list|,
literal|"; %s\n"
argument_list|,
name|dns_result_totext
argument_list|(
name|result
argument_list|)
argument_list|)
expr_stmt|;
goto|goto
name|nextzone
goto|;
block|}
name|dns_db_currentversion
argument_list|(
name|dctx
operator|->
name|db
argument_list|,
operator|&
name|dctx
operator|->
name|version
argument_list|)
expr_stmt|;
name|result
operator|=
name|dns_master_dumptostreaminc
argument_list|(
name|dctx
operator|->
name|mctx
argument_list|,
name|dctx
operator|->
name|db
argument_list|,
name|dctx
operator|->
name|version
argument_list|,
name|style
argument_list|,
name|dctx
operator|->
name|fp
argument_list|,
name|dctx
operator|->
name|task
argument_list|,
name|dumpdone
argument_list|,
name|dctx
argument_list|,
operator|&
name|dctx
operator|->
name|mdctx
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|==
name|DNS_R_CONTINUE
condition|)
return|return;
if|if
condition|(
name|result
operator|==
name|ISC_R_NOTIMPLEMENTED
condition|)
block|{
name|fprintf
argument_list|(
name|dctx
operator|->
name|fp
argument_list|,
literal|"; %s\n"
argument_list|,
name|dns_result_totext
argument_list|(
name|result
argument_list|)
argument_list|)
expr_stmt|;
name|result
operator|=
name|ISC_R_SUCCESS
expr_stmt|;
goto|goto
name|nextzone
goto|;
block|}
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
goto|goto
name|cleanup
goto|;
block|}
block|}
if|if
condition|(
name|dctx
operator|->
name|view
operator|!=
name|NULL
condition|)
name|dctx
operator|->
name|view
operator|=
name|ISC_LIST_NEXT
argument_list|(
name|dctx
operator|->
name|view
argument_list|,
name|link
argument_list|)
expr_stmt|;
if|if
condition|(
name|dctx
operator|->
name|view
operator|!=
name|NULL
condition|)
goto|goto
name|nextview
goto|;
name|done
label|:
name|fprintf
argument_list|(
name|dctx
operator|->
name|fp
argument_list|,
literal|"; Dump complete\n"
argument_list|)
expr_stmt|;
name|result
operator|=
name|isc_stdio_flush
argument_list|(
name|dctx
operator|->
name|fp
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|==
name|ISC_R_SUCCESS
condition|)
name|isc_log_write
argument_list|(
name|ns_g_lctx
argument_list|,
name|NS_LOGCATEGORY_GENERAL
argument_list|,
name|NS_LOGMODULE_SERVER
argument_list|,
name|ISC_LOG_INFO
argument_list|,
literal|"dumpdb complete"
argument_list|)
expr_stmt|;
name|cleanup
label|:
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
name|isc_log_write
argument_list|(
name|ns_g_lctx
argument_list|,
name|NS_LOGCATEGORY_GENERAL
argument_list|,
name|NS_LOGMODULE_SERVER
argument_list|,
name|ISC_LOG_INFO
argument_list|,
literal|"dumpdb failed: %s"
argument_list|,
name|dns_result_totext
argument_list|(
name|result
argument_list|)
argument_list|)
expr_stmt|;
name|dumpcontext_destroy
argument_list|(
name|dctx
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|isc_result_t
name|ns_server_dumpdb
parameter_list|(
name|ns_server_t
modifier|*
name|server
parameter_list|,
name|char
modifier|*
name|args
parameter_list|)
block|{
name|struct
name|dumpcontext
modifier|*
name|dctx
init|=
name|NULL
decl_stmt|;
name|dns_view_t
modifier|*
name|view
decl_stmt|;
name|isc_result_t
name|result
decl_stmt|;
name|char
modifier|*
name|ptr
decl_stmt|;
specifier|const
name|char
modifier|*
name|sep
decl_stmt|;
comment|/* Skip the command name. */
name|ptr
operator|=
name|next_token
argument_list|(
operator|&
name|args
argument_list|,
literal|" \t"
argument_list|)
expr_stmt|;
if|if
condition|(
name|ptr
operator|==
name|NULL
condition|)
return|return
operator|(
name|ISC_R_UNEXPECTEDEND
operator|)
return|;
name|dctx
operator|=
name|isc_mem_get
argument_list|(
name|server
operator|->
name|mctx
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|dctx
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|dctx
operator|==
name|NULL
condition|)
return|return
operator|(
name|ISC_R_NOMEMORY
operator|)
return|;
name|dctx
operator|->
name|mctx
operator|=
name|server
operator|->
name|mctx
expr_stmt|;
name|dctx
operator|->
name|dumpcache
operator|=
name|ISC_TRUE
expr_stmt|;
name|dctx
operator|->
name|dumpzones
operator|=
name|ISC_FALSE
expr_stmt|;
name|dctx
operator|->
name|fp
operator|=
name|NULL
expr_stmt|;
name|ISC_LIST_INIT
argument_list|(
name|dctx
operator|->
name|viewlist
argument_list|)
expr_stmt|;
name|dctx
operator|->
name|view
operator|=
name|NULL
expr_stmt|;
name|dctx
operator|->
name|zone
operator|=
name|NULL
expr_stmt|;
name|dctx
operator|->
name|cache
operator|=
name|NULL
expr_stmt|;
name|dctx
operator|->
name|mdctx
operator|=
name|NULL
expr_stmt|;
name|dctx
operator|->
name|db
operator|=
name|NULL
expr_stmt|;
name|dctx
operator|->
name|cache
operator|=
name|NULL
expr_stmt|;
name|dctx
operator|->
name|task
operator|=
name|NULL
expr_stmt|;
name|dctx
operator|->
name|version
operator|=
name|NULL
expr_stmt|;
name|isc_task_attach
argument_list|(
name|server
operator|->
name|task
argument_list|,
operator|&
name|dctx
operator|->
name|task
argument_list|)
expr_stmt|;
name|CHECKMF
argument_list|(
name|isc_stdio_open
argument_list|(
name|server
operator|->
name|dumpfile
argument_list|,
literal|"w"
argument_list|,
operator|&
name|dctx
operator|->
name|fp
argument_list|)
argument_list|,
literal|"could not open dump file"
argument_list|,
name|server
operator|->
name|dumpfile
argument_list|)
expr_stmt|;
name|sep
operator|=
operator|(
name|args
operator|==
name|NULL
operator|)
condition|?
literal|""
else|:
literal|": "
expr_stmt|;
name|isc_log_write
argument_list|(
name|ns_g_lctx
argument_list|,
name|NS_LOGCATEGORY_GENERAL
argument_list|,
name|NS_LOGMODULE_SERVER
argument_list|,
name|ISC_LOG_INFO
argument_list|,
literal|"dumpdb started%s%s"
argument_list|,
name|sep
argument_list|,
operator|(
name|args
operator|!=
name|NULL
operator|)
condition|?
name|args
else|:
literal|""
argument_list|)
expr_stmt|;
name|ptr
operator|=
name|next_token
argument_list|(
operator|&
name|args
argument_list|,
literal|" \t"
argument_list|)
expr_stmt|;
if|if
condition|(
name|ptr
operator|!=
name|NULL
operator|&&
name|strcmp
argument_list|(
name|ptr
argument_list|,
literal|"-all"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|dctx
operator|->
name|dumpzones
operator|=
name|ISC_TRUE
expr_stmt|;
name|dctx
operator|->
name|dumpcache
operator|=
name|ISC_TRUE
expr_stmt|;
name|ptr
operator|=
name|next_token
argument_list|(
operator|&
name|args
argument_list|,
literal|" \t"
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|ptr
operator|!=
name|NULL
operator|&&
name|strcmp
argument_list|(
name|ptr
argument_list|,
literal|"-cache"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|dctx
operator|->
name|dumpzones
operator|=
name|ISC_FALSE
expr_stmt|;
name|dctx
operator|->
name|dumpcache
operator|=
name|ISC_TRUE
expr_stmt|;
name|ptr
operator|=
name|next_token
argument_list|(
operator|&
name|args
argument_list|,
literal|" \t"
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|ptr
operator|!=
name|NULL
operator|&&
name|strcmp
argument_list|(
name|ptr
argument_list|,
literal|"-zones"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|dctx
operator|->
name|dumpzones
operator|=
name|ISC_TRUE
expr_stmt|;
name|dctx
operator|->
name|dumpcache
operator|=
name|ISC_FALSE
expr_stmt|;
name|ptr
operator|=
name|next_token
argument_list|(
operator|&
name|args
argument_list|,
literal|" \t"
argument_list|)
expr_stmt|;
block|}
name|nextview
label|:
for|for
control|(
name|view
operator|=
name|ISC_LIST_HEAD
argument_list|(
name|server
operator|->
name|viewlist
argument_list|)
init|;
name|view
operator|!=
name|NULL
condition|;
name|view
operator|=
name|ISC_LIST_NEXT
argument_list|(
name|view
argument_list|,
name|link
argument_list|)
control|)
block|{
if|if
condition|(
name|ptr
operator|!=
name|NULL
operator|&&
name|strcmp
argument_list|(
name|view
operator|->
name|name
argument_list|,
name|ptr
argument_list|)
operator|!=
literal|0
condition|)
continue|continue;
name|CHECK
argument_list|(
name|add_view_tolist
argument_list|(
name|dctx
argument_list|,
name|view
argument_list|)
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|ptr
operator|!=
name|NULL
condition|)
block|{
name|ptr
operator|=
name|next_token
argument_list|(
operator|&
name|args
argument_list|,
literal|" \t"
argument_list|)
expr_stmt|;
if|if
condition|(
name|ptr
operator|!=
name|NULL
condition|)
goto|goto
name|nextview
goto|;
block|}
name|dumpdone
argument_list|(
name|dctx
argument_list|,
name|ISC_R_SUCCESS
argument_list|)
expr_stmt|;
return|return
operator|(
name|ISC_R_SUCCESS
operator|)
return|;
name|cleanup
label|:
if|if
condition|(
name|dctx
operator|!=
name|NULL
condition|)
name|dumpcontext_destroy
argument_list|(
name|dctx
argument_list|)
expr_stmt|;
return|return
operator|(
name|result
operator|)
return|;
block|}
end_function

begin_function
name|isc_result_t
name|ns_server_dumprecursing
parameter_list|(
name|ns_server_t
modifier|*
name|server
parameter_list|)
block|{
name|FILE
modifier|*
name|fp
init|=
name|NULL
decl_stmt|;
name|isc_result_t
name|result
decl_stmt|;
name|CHECKMF
argument_list|(
name|isc_stdio_open
argument_list|(
name|server
operator|->
name|recfile
argument_list|,
literal|"w"
argument_list|,
operator|&
name|fp
argument_list|)
argument_list|,
literal|"could not open dump file"
argument_list|,
name|server
operator|->
name|recfile
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|";\n; Recursing Queries\n;\n"
argument_list|)
expr_stmt|;
name|ns_interfacemgr_dumprecursing
argument_list|(
name|fp
argument_list|,
name|server
operator|->
name|interfacemgr
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"; Dump complete\n"
argument_list|)
expr_stmt|;
name|cleanup
label|:
if|if
condition|(
name|fp
operator|!=
name|NULL
condition|)
name|result
operator|=
name|isc_stdio_close
argument_list|(
name|fp
argument_list|)
expr_stmt|;
return|return
operator|(
name|result
operator|)
return|;
block|}
end_function

begin_function
name|isc_result_t
name|ns_server_setdebuglevel
parameter_list|(
name|ns_server_t
modifier|*
name|server
parameter_list|,
name|char
modifier|*
name|args
parameter_list|)
block|{
name|char
modifier|*
name|ptr
decl_stmt|;
name|char
modifier|*
name|levelstr
decl_stmt|;
name|char
modifier|*
name|endp
decl_stmt|;
name|long
name|newlevel
decl_stmt|;
name|UNUSED
argument_list|(
name|server
argument_list|)
expr_stmt|;
comment|/* Skip the command name. */
name|ptr
operator|=
name|next_token
argument_list|(
operator|&
name|args
argument_list|,
literal|" \t"
argument_list|)
expr_stmt|;
if|if
condition|(
name|ptr
operator|==
name|NULL
condition|)
return|return
operator|(
name|ISC_R_UNEXPECTEDEND
operator|)
return|;
comment|/* Look for the new level name. */
name|levelstr
operator|=
name|next_token
argument_list|(
operator|&
name|args
argument_list|,
literal|" \t"
argument_list|)
expr_stmt|;
if|if
condition|(
name|levelstr
operator|==
name|NULL
condition|)
block|{
if|if
condition|(
name|ns_g_debuglevel
operator|<
literal|99
condition|)
name|ns_g_debuglevel
operator|++
expr_stmt|;
block|}
else|else
block|{
name|newlevel
operator|=
name|strtol
argument_list|(
name|levelstr
argument_list|,
operator|&
name|endp
argument_list|,
literal|10
argument_list|)
expr_stmt|;
if|if
condition|(
operator|*
name|endp
operator|!=
literal|'\0'
operator|||
name|newlevel
operator|<
literal|0
operator|||
name|newlevel
operator|>
literal|99
condition|)
return|return
operator|(
name|ISC_R_RANGE
operator|)
return|;
name|ns_g_debuglevel
operator|=
operator|(
name|unsigned
name|int
operator|)
name|newlevel
expr_stmt|;
block|}
name|isc_log_setdebuglevel
argument_list|(
name|ns_g_lctx
argument_list|,
name|ns_g_debuglevel
argument_list|)
expr_stmt|;
return|return
operator|(
name|ISC_R_SUCCESS
operator|)
return|;
block|}
end_function

begin_function
name|isc_result_t
name|ns_server_flushcache
parameter_list|(
name|ns_server_t
modifier|*
name|server
parameter_list|,
name|char
modifier|*
name|args
parameter_list|)
block|{
name|char
modifier|*
name|ptr
decl_stmt|,
modifier|*
name|viewname
decl_stmt|;
name|dns_view_t
modifier|*
name|view
decl_stmt|;
name|isc_boolean_t
name|flushed
decl_stmt|;
name|isc_boolean_t
name|found
decl_stmt|;
name|isc_result_t
name|result
decl_stmt|;
comment|/* Skip the command name. */
name|ptr
operator|=
name|next_token
argument_list|(
operator|&
name|args
argument_list|,
literal|" \t"
argument_list|)
expr_stmt|;
if|if
condition|(
name|ptr
operator|==
name|NULL
condition|)
return|return
operator|(
name|ISC_R_UNEXPECTEDEND
operator|)
return|;
comment|/* Look for the view name. */
name|viewname
operator|=
name|next_token
argument_list|(
operator|&
name|args
argument_list|,
literal|" \t"
argument_list|)
expr_stmt|;
name|result
operator|=
name|isc_task_beginexclusive
argument_list|(
name|server
operator|->
name|task
argument_list|)
expr_stmt|;
name|RUNTIME_CHECK
argument_list|(
name|result
operator|==
name|ISC_R_SUCCESS
argument_list|)
expr_stmt|;
name|flushed
operator|=
name|ISC_TRUE
expr_stmt|;
name|found
operator|=
name|ISC_FALSE
expr_stmt|;
for|for
control|(
name|view
operator|=
name|ISC_LIST_HEAD
argument_list|(
name|server
operator|->
name|viewlist
argument_list|)
init|;
name|view
operator|!=
name|NULL
condition|;
name|view
operator|=
name|ISC_LIST_NEXT
argument_list|(
name|view
argument_list|,
name|link
argument_list|)
control|)
block|{
if|if
condition|(
name|viewname
operator|!=
name|NULL
operator|&&
name|strcasecmp
argument_list|(
name|viewname
argument_list|,
name|view
operator|->
name|name
argument_list|)
operator|!=
literal|0
condition|)
continue|continue;
name|found
operator|=
name|ISC_TRUE
expr_stmt|;
name|result
operator|=
name|dns_view_flushcache
argument_list|(
name|view
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
name|flushed
operator|=
name|ISC_FALSE
expr_stmt|;
block|}
if|if
condition|(
name|flushed
operator|&&
name|found
condition|)
block|{
name|result
operator|=
name|ISC_R_SUCCESS
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
operator|!
name|found
condition|)
name|result
operator|=
name|ISC_R_NOTFOUND
expr_stmt|;
else|else
name|result
operator|=
name|ISC_R_FAILURE
expr_stmt|;
block|}
name|isc_task_endexclusive
argument_list|(
name|server
operator|->
name|task
argument_list|)
expr_stmt|;
return|return
operator|(
name|result
operator|)
return|;
block|}
end_function

begin_function
name|isc_result_t
name|ns_server_flushname
parameter_list|(
name|ns_server_t
modifier|*
name|server
parameter_list|,
name|char
modifier|*
name|args
parameter_list|)
block|{
name|char
modifier|*
name|ptr
decl_stmt|,
modifier|*
name|target
decl_stmt|,
modifier|*
name|viewname
decl_stmt|;
name|dns_view_t
modifier|*
name|view
decl_stmt|;
name|isc_boolean_t
name|flushed
decl_stmt|;
name|isc_boolean_t
name|found
decl_stmt|;
name|isc_result_t
name|result
decl_stmt|;
name|isc_buffer_t
name|b
decl_stmt|;
name|dns_fixedname_t
name|fixed
decl_stmt|;
name|dns_name_t
modifier|*
name|name
decl_stmt|;
comment|/* Skip the command name. */
name|ptr
operator|=
name|next_token
argument_list|(
operator|&
name|args
argument_list|,
literal|" \t"
argument_list|)
expr_stmt|;
if|if
condition|(
name|ptr
operator|==
name|NULL
condition|)
return|return
operator|(
name|ISC_R_UNEXPECTEDEND
operator|)
return|;
comment|/* Find the domain name to flush. */
name|target
operator|=
name|next_token
argument_list|(
operator|&
name|args
argument_list|,
literal|" \t"
argument_list|)
expr_stmt|;
if|if
condition|(
name|target
operator|==
name|NULL
condition|)
return|return
operator|(
name|ISC_R_UNEXPECTEDEND
operator|)
return|;
name|isc_buffer_init
argument_list|(
operator|&
name|b
argument_list|,
name|target
argument_list|,
name|strlen
argument_list|(
name|target
argument_list|)
argument_list|)
expr_stmt|;
name|isc_buffer_add
argument_list|(
operator|&
name|b
argument_list|,
name|strlen
argument_list|(
name|target
argument_list|)
argument_list|)
expr_stmt|;
name|dns_fixedname_init
argument_list|(
operator|&
name|fixed
argument_list|)
expr_stmt|;
name|name
operator|=
name|dns_fixedname_name
argument_list|(
operator|&
name|fixed
argument_list|)
expr_stmt|;
name|result
operator|=
name|dns_name_fromtext
argument_list|(
name|name
argument_list|,
operator|&
name|b
argument_list|,
name|dns_rootname
argument_list|,
name|ISC_FALSE
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
return|return
operator|(
name|result
operator|)
return|;
comment|/* Look for the view name. */
name|viewname
operator|=
name|next_token
argument_list|(
operator|&
name|args
argument_list|,
literal|" \t"
argument_list|)
expr_stmt|;
name|result
operator|=
name|isc_task_beginexclusive
argument_list|(
name|server
operator|->
name|task
argument_list|)
expr_stmt|;
name|RUNTIME_CHECK
argument_list|(
name|result
operator|==
name|ISC_R_SUCCESS
argument_list|)
expr_stmt|;
name|flushed
operator|=
name|ISC_TRUE
expr_stmt|;
name|found
operator|=
name|ISC_FALSE
expr_stmt|;
for|for
control|(
name|view
operator|=
name|ISC_LIST_HEAD
argument_list|(
name|server
operator|->
name|viewlist
argument_list|)
init|;
name|view
operator|!=
name|NULL
condition|;
name|view
operator|=
name|ISC_LIST_NEXT
argument_list|(
name|view
argument_list|,
name|link
argument_list|)
control|)
block|{
if|if
condition|(
name|viewname
operator|!=
name|NULL
operator|&&
name|strcasecmp
argument_list|(
name|viewname
argument_list|,
name|view
operator|->
name|name
argument_list|)
operator|!=
literal|0
condition|)
continue|continue;
name|found
operator|=
name|ISC_TRUE
expr_stmt|;
name|result
operator|=
name|dns_view_flushname
argument_list|(
name|view
argument_list|,
name|name
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
name|flushed
operator|=
name|ISC_FALSE
expr_stmt|;
block|}
if|if
condition|(
name|flushed
operator|&&
name|found
condition|)
name|result
operator|=
name|ISC_R_SUCCESS
expr_stmt|;
elseif|else
if|if
condition|(
operator|!
name|found
condition|)
name|result
operator|=
name|ISC_R_NOTFOUND
expr_stmt|;
else|else
name|result
operator|=
name|ISC_R_FAILURE
expr_stmt|;
name|isc_task_endexclusive
argument_list|(
name|server
operator|->
name|task
argument_list|)
expr_stmt|;
return|return
operator|(
name|result
operator|)
return|;
block|}
end_function

begin_function
name|isc_result_t
name|ns_server_status
parameter_list|(
name|ns_server_t
modifier|*
name|server
parameter_list|,
name|isc_buffer_t
modifier|*
name|text
parameter_list|)
block|{
name|int
name|zonecount
decl_stmt|,
name|xferrunning
decl_stmt|,
name|xferdeferred
decl_stmt|,
name|soaqueries
decl_stmt|;
name|unsigned
name|int
name|n
decl_stmt|;
name|zonecount
operator|=
name|dns_zonemgr_getcount
argument_list|(
name|server
operator|->
name|zonemgr
argument_list|,
name|DNS_ZONESTATE_ANY
argument_list|)
expr_stmt|;
name|xferrunning
operator|=
name|dns_zonemgr_getcount
argument_list|(
name|server
operator|->
name|zonemgr
argument_list|,
name|DNS_ZONESTATE_XFERRUNNING
argument_list|)
expr_stmt|;
name|xferdeferred
operator|=
name|dns_zonemgr_getcount
argument_list|(
name|server
operator|->
name|zonemgr
argument_list|,
name|DNS_ZONESTATE_XFERDEFERRED
argument_list|)
expr_stmt|;
name|soaqueries
operator|=
name|dns_zonemgr_getcount
argument_list|(
name|server
operator|->
name|zonemgr
argument_list|,
name|DNS_ZONESTATE_SOAQUERY
argument_list|)
expr_stmt|;
name|n
operator|=
name|snprintf
argument_list|(
operator|(
name|char
operator|*
operator|)
name|isc_buffer_used
argument_list|(
name|text
argument_list|)
argument_list|,
name|isc_buffer_availablelength
argument_list|(
name|text
argument_list|)
argument_list|,
literal|"number of zones: %u\n"
literal|"debug level: %d\n"
literal|"xfers running: %u\n"
literal|"xfers deferred: %u\n"
literal|"soa queries in progress: %u\n"
literal|"query logging is %s\n"
literal|"recursive clients: %d/%d\n"
literal|"tcp clients: %d/%d\n"
literal|"server is up and running"
argument_list|,
name|zonecount
argument_list|,
name|ns_g_debuglevel
argument_list|,
name|xferrunning
argument_list|,
name|xferdeferred
argument_list|,
name|soaqueries
argument_list|,
name|server
operator|->
name|log_queries
condition|?
literal|"ON"
else|:
literal|"OFF"
argument_list|,
name|server
operator|->
name|recursionquota
operator|.
name|used
argument_list|,
name|server
operator|->
name|recursionquota
operator|.
name|max
argument_list|,
name|server
operator|->
name|tcpquota
operator|.
name|used
argument_list|,
name|server
operator|->
name|tcpquota
operator|.
name|max
argument_list|)
expr_stmt|;
if|if
condition|(
name|n
operator|>=
name|isc_buffer_availablelength
argument_list|(
name|text
argument_list|)
condition|)
return|return
operator|(
name|ISC_R_NOSPACE
operator|)
return|;
name|isc_buffer_add
argument_list|(
name|text
argument_list|,
name|n
argument_list|)
expr_stmt|;
return|return
operator|(
name|ISC_R_SUCCESS
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Act on a "freeze" or "unfreeze" command from the command channel.  */
end_comment

begin_function
name|isc_result_t
name|ns_server_freeze
parameter_list|(
name|ns_server_t
modifier|*
name|server
parameter_list|,
name|isc_boolean_t
name|freeze
parameter_list|,
name|char
modifier|*
name|args
parameter_list|)
block|{
name|isc_result_t
name|result
decl_stmt|;
name|dns_zone_t
modifier|*
name|zone
init|=
name|NULL
decl_stmt|;
name|dns_zonetype_t
name|type
decl_stmt|;
name|char
name|classstr
index|[
name|DNS_RDATACLASS_FORMATSIZE
index|]
decl_stmt|;
name|char
name|zonename
index|[
name|DNS_NAME_FORMATSIZE
index|]
decl_stmt|;
name|dns_view_t
modifier|*
name|view
decl_stmt|;
name|char
modifier|*
name|journal
decl_stmt|;
specifier|const
name|char
modifier|*
name|vname
decl_stmt|,
modifier|*
name|sep
decl_stmt|;
name|isc_boolean_t
name|frozen
decl_stmt|;
name|result
operator|=
name|zone_from_args
argument_list|(
name|server
argument_list|,
name|args
argument_list|,
operator|&
name|zone
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
return|return
operator|(
name|result
operator|)
return|;
if|if
condition|(
name|zone
operator|==
name|NULL
condition|)
return|return
operator|(
name|ISC_R_UNEXPECTEDEND
operator|)
return|;
name|type
operator|=
name|dns_zone_gettype
argument_list|(
name|zone
argument_list|)
expr_stmt|;
if|if
condition|(
name|type
operator|!=
name|dns_zone_master
condition|)
block|{
name|dns_zone_detach
argument_list|(
operator|&
name|zone
argument_list|)
expr_stmt|;
return|return
operator|(
name|ISC_R_NOTFOUND
operator|)
return|;
block|}
name|frozen
operator|=
name|dns_zone_getupdatedisabled
argument_list|(
name|zone
argument_list|)
expr_stmt|;
if|if
condition|(
name|freeze
condition|)
block|{
if|if
condition|(
name|frozen
condition|)
name|result
operator|=
name|DNS_R_FROZEN
expr_stmt|;
if|if
condition|(
name|result
operator|==
name|ISC_R_SUCCESS
condition|)
name|result
operator|=
name|dns_zone_flush
argument_list|(
name|zone
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|==
name|ISC_R_SUCCESS
condition|)
block|{
name|journal
operator|=
name|dns_zone_getjournal
argument_list|(
name|zone
argument_list|)
expr_stmt|;
if|if
condition|(
name|journal
operator|!=
name|NULL
condition|)
operator|(
name|void
operator|)
name|isc_file_remove
argument_list|(
name|journal
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
if|if
condition|(
name|frozen
condition|)
block|{
name|result
operator|=
name|dns_zone_load
argument_list|(
name|zone
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|==
name|DNS_R_CONTINUE
operator|||
name|result
operator|==
name|DNS_R_UPTODATE
condition|)
name|result
operator|=
name|ISC_R_SUCCESS
expr_stmt|;
block|}
block|}
if|if
condition|(
name|result
operator|==
name|ISC_R_SUCCESS
condition|)
name|dns_zone_setupdatedisabled
argument_list|(
name|zone
argument_list|,
name|freeze
argument_list|)
expr_stmt|;
name|view
operator|=
name|dns_zone_getview
argument_list|(
name|zone
argument_list|)
expr_stmt|;
if|if
condition|(
name|strcmp
argument_list|(
name|view
operator|->
name|name
argument_list|,
literal|"_bind"
argument_list|)
operator|==
literal|0
operator|||
name|strcmp
argument_list|(
name|view
operator|->
name|name
argument_list|,
literal|"_default"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|vname
operator|=
literal|""
expr_stmt|;
name|sep
operator|=
literal|""
expr_stmt|;
block|}
else|else
block|{
name|vname
operator|=
name|view
operator|->
name|name
expr_stmt|;
name|sep
operator|=
literal|" "
expr_stmt|;
block|}
name|dns_rdataclass_format
argument_list|(
name|dns_zone_getclass
argument_list|(
name|zone
argument_list|)
argument_list|,
name|classstr
argument_list|,
sizeof|sizeof
argument_list|(
name|classstr
argument_list|)
argument_list|)
expr_stmt|;
name|dns_name_format
argument_list|(
name|dns_zone_getorigin
argument_list|(
name|zone
argument_list|)
argument_list|,
name|zonename
argument_list|,
sizeof|sizeof
argument_list|(
name|zonename
argument_list|)
argument_list|)
expr_stmt|;
name|isc_log_write
argument_list|(
name|ns_g_lctx
argument_list|,
name|NS_LOGCATEGORY_GENERAL
argument_list|,
name|NS_LOGMODULE_SERVER
argument_list|,
name|ISC_LOG_INFO
argument_list|,
literal|"%s zone '%s/%s'%s%s: %s"
argument_list|,
name|freeze
condition|?
literal|"freezing"
else|:
literal|"unfreezing"
argument_list|,
name|zonename
argument_list|,
name|classstr
argument_list|,
name|sep
argument_list|,
name|vname
argument_list|,
name|isc_result_totext
argument_list|(
name|result
argument_list|)
argument_list|)
expr_stmt|;
name|dns_zone_detach
argument_list|(
operator|&
name|zone
argument_list|)
expr_stmt|;
return|return
operator|(
name|result
operator|)
return|;
block|}
end_function

begin_ifdef
ifdef|#
directive|ifdef
name|HAVE_LIBSCF
end_ifdef

begin_comment
comment|/*  * This function adds a message for rndc to echo if named  * is managed by smf and is also running chroot.  */
end_comment

begin_function
name|isc_result_t
name|ns_smf_add_message
parameter_list|(
name|isc_buffer_t
modifier|*
name|text
parameter_list|)
block|{
name|unsigned
name|int
name|n
decl_stmt|;
name|n
operator|=
name|snprintf
argument_list|(
operator|(
name|char
operator|*
operator|)
name|isc_buffer_used
argument_list|(
name|text
argument_list|)
argument_list|,
name|isc_buffer_availablelength
argument_list|(
name|text
argument_list|)
argument_list|,
literal|"use svcadm(1M) to manage named"
argument_list|)
expr_stmt|;
if|if
condition|(
name|n
operator|>=
name|isc_buffer_availablelength
argument_list|(
name|text
argument_list|)
condition|)
return|return
operator|(
name|ISC_R_NOSPACE
operator|)
return|;
name|isc_buffer_add
argument_list|(
name|text
argument_list|,
name|n
argument_list|)
expr_stmt|;
return|return
operator|(
name|ISC_R_SUCCESS
operator|)
return|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* HAVE_LIBSCF */
end_comment

end_unit


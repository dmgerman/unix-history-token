begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/* Copyright (C) 1998, 2001 Free Software Foundation, Inc.     This program is free software; you can redistribute it and/or modify it    under the terms of the GNU General Public License as published by the    Free Software Foundation; either version 2, or (at your option) any    later version.     This program is distributed in the hope that it will be useful,    but WITHOUT ANY WARRANTY; without even the implied warranty of    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the    GNU General Public License for more details.     You should have received a copy of the GNU General Public License    along with this program; if not, write to the Free Software Foundation,    Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.  */
end_comment

begin_comment
comment|/* derived from a function in touch.c */
end_comment

begin_ifdef
ifdef|#
directive|ifdef
name|HAVE_CONFIG_H
end_ifdef

begin_include
include|#
directive|include
file|<config.h>
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_undef
undef|#
directive|undef
name|utime
end_undef

begin_include
include|#
directive|include
file|<sys/types.h>
end_include

begin_ifdef
ifdef|#
directive|ifdef
name|HAVE_UTIME_H
end_ifdef

begin_include
include|#
directive|include
file|<utime.h>
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_include
include|#
directive|include
file|"full-write.h"
end_include

begin_include
include|#
directive|include
file|"safe-read.h"
end_include

begin_comment
comment|/* Some systems (even some that do have<utime.h>) don't declare this    structure anywhere.  */
end_comment

begin_ifndef
ifndef|#
directive|ifndef
name|HAVE_STRUCT_UTIMBUF
end_ifndef

begin_struct
struct|struct
name|utimbuf
block|{
name|long
name|actime
decl_stmt|;
name|long
name|modtime
decl_stmt|;
block|}
struct|;
end_struct

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* Emulate utime (file, NULL) for systems (like 4.3BSD) that do not    interpret it to set the access and modification times of FILE to    the current time.  Return 0 if successful, -1 if not. */
end_comment

begin_function
specifier|static
name|int
name|utime_null
parameter_list|(
specifier|const
name|char
modifier|*
name|file
parameter_list|)
block|{
if|#
directive|if
name|HAVE_UTIMES_NULL
return|return
name|utimes
argument_list|(
name|file
argument_list|,
literal|0
argument_list|)
return|;
else|#
directive|else
name|int
name|fd
decl_stmt|;
name|char
name|c
decl_stmt|;
name|int
name|status
init|=
literal|0
decl_stmt|;
name|struct
name|stat
name|sb
decl_stmt|;
name|fd
operator|=
name|open
argument_list|(
name|file
argument_list|,
name|O_RDWR
argument_list|)
expr_stmt|;
if|if
condition|(
name|fd
operator|<
literal|0
operator|||
name|fstat
argument_list|(
name|fd
argument_list|,
operator|&
name|sb
argument_list|)
operator|<
literal|0
operator|||
name|safe_read
argument_list|(
name|fd
argument_list|,
operator|&
name|c
argument_list|,
sizeof|sizeof
name|c
argument_list|)
operator|<
literal|0
operator|||
name|lseek
argument_list|(
name|fd
argument_list|,
operator|(
name|off_t
operator|)
literal|0
argument_list|,
name|SEEK_SET
argument_list|)
operator|<
literal|0
operator|||
name|full_write
argument_list|(
name|fd
argument_list|,
operator|&
name|c
argument_list|,
sizeof|sizeof
name|c
argument_list|)
operator|!=
sizeof|sizeof
name|c
comment|/* Maybe do this -- it's necessary on SunOS4.1.3 with some combination 	 of patches, but that system doesn't use this code: it has utimes. 	 || fsync (fd)< 0       */
operator|||
name|ftruncate
argument_list|(
name|fd
argument_list|,
name|st
operator|.
name|st_size
argument_list|)
operator|<
literal|0
operator|||
name|close
argument_list|(
name|fd
argument_list|)
operator|<
literal|0
condition|)
name|status
operator|=
operator|-
literal|1
expr_stmt|;
return|return
name|status
return|;
endif|#
directive|endif
block|}
end_function

begin_function
name|int
name|rpl_utime
parameter_list|(
specifier|const
name|char
modifier|*
name|file
parameter_list|,
specifier|const
name|struct
name|utimbuf
modifier|*
name|times
parameter_list|)
block|{
if|if
condition|(
name|times
condition|)
return|return
name|utime
argument_list|(
name|file
argument_list|,
name|times
argument_list|)
return|;
return|return
name|utime_null
argument_list|(
name|file
argument_list|)
return|;
block|}
end_function

end_unit


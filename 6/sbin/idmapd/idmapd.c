begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/* $FreeBSD$ */
end_comment

begin_comment
comment|/* $Id: idmapd.c,v 1.5 2003/11/05 14:58:58 rees Exp $ */
end_comment

begin_comment
comment|/*  * copyright (c) 2003  * the regents of the university of michigan  * all rights reserved  *   * permission is granted to use, copy, create derivative works and redistribute  * this software and such derivative works for any purpose, so long as the name  * of the university of michigan is not used in any advertising or publicity  * pertaining to the use or distribution of this software without specific,  * written prior authorization.  if the above copyright notice or any other  * identification of the university of michigan is included in any copy of any  * portion of this software, then the disclaimer below must also be included.  *   * this software is provided as is, without representation from the university  * of michigan as to its fitness for any purpose, and without warranty by the  * university of michigan of any kind, either express or implied, including  * without limitation the implied warranties of merchantability and fitness for  * a particular purpose. the regents of the university of michigan shall not be  * liable for any damages, including special, indirect, incidental, or  * consequential damages, with respect to any claim arising out of or in  * connection with the use of the software, even if it has been or is hereafter  * advised of the possibility of such damages.  */
end_comment

begin_comment
comment|/* XXX ignores the domain of received names. */
end_comment

begin_include
include|#
directive|include
file|<sys/types.h>
end_include

begin_include
include|#
directive|include
file|<sys/ioctl.h>
end_include

begin_include
include|#
directive|include
file|<sys/syscall.h>
end_include

begin_include
include|#
directive|include
file|<sys/errno.h>
end_include

begin_include
include|#
directive|include
file|<sys/stat.h>
end_include

begin_include
include|#
directive|include
file|<sys/time.h>
end_include

begin_include
include|#
directive|include
file|<sys/queue.h>
end_include

begin_include
include|#
directive|include
file|<nfs4client/nfs4_dev.h>
end_include

begin_include
include|#
directive|include
file|<nfs4client/nfs4_idmap.h>
end_include

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_include
include|#
directive|include
file|<fcntl.h>
end_include

begin_include
include|#
directive|include
file|<assert.h>
end_include

begin_include
include|#
directive|include
file|<string.h>
end_include

begin_include
include|#
directive|include
file|<stdlib.h>
end_include

begin_include
include|#
directive|include
file|<unistd.h>
end_include

begin_include
include|#
directive|include
file|<pwd.h>
end_include

begin_include
include|#
directive|include
file|<grp.h>
end_include

begin_define
define|#
directive|define
name|DEV_PATH
value|"/dev/nfs4"
end_define

begin_define
define|#
directive|define
name|DOMAIN
value|"@FreeBSD.org"
end_define

begin_define
define|#
directive|define
name|BADUSER
value|"nobody"
end_define

begin_define
define|#
directive|define
name|BADGROUP
value|"nogroup"
end_define

begin_define
define|#
directive|define
name|BADUID
value|65534
end_define

begin_define
define|#
directive|define
name|BADGID
value|65533
end_define

begin_struct
struct|struct
name|idmap_e
block|{
name|struct
name|nfs4dev_msg
name|msg
decl_stmt|;
name|TAILQ_ENTRY
argument_list|(
argument|idmap_e
argument_list|)
name|next
expr_stmt|;
block|}
struct|;
end_struct

begin_decl_stmt
name|int
name|fd
decl_stmt|,
name|verbose
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|char
modifier|*
name|domain
init|=
name|DOMAIN
decl_stmt|;
end_decl_stmt

begin_macro
name|TAILQ_HEAD
argument_list|(
argument_list|,
argument|idmap_e
argument_list|)
end_macro

begin_expr_stmt
name|upcall_q
expr_stmt|;
end_expr_stmt

begin_define
define|#
directive|define
name|add_idmap_e
parameter_list|(
name|E
parameter_list|)
value|do {	\   	assert(E != NULL);	\ 	TAILQ_INSERT_TAIL(&upcall_q, E, next); \ } while(0)
end_define

begin_define
define|#
directive|define
name|remove_idmap_e
parameter_list|(
name|E
parameter_list|)
value|do {	\   	assert(E != NULL&& !TAILQ_EMPTY(&upcall_q));	\ 	E = TAILQ_FIRST(&upcall_q);	\ 	TAILQ_REMOVE(&upcall_q, E, next); \ } while(0)
end_define

begin_define
define|#
directive|define
name|get_idmap_e
parameter_list|(
name|E
parameter_list|)
value|do {	\   	if ((E = (struct idmap_e *) malloc(sizeof(struct idmap_e))) == NULL) {\ 		fprintf(stderr, "get_idmap_e(): error in malloc\n");\ 	} } while(0)
end_define

begin_define
define|#
directive|define
name|put_idmap_e
parameter_list|(
name|E
parameter_list|)
value|free(E)
end_define

begin_comment
comment|/* from marius */
end_comment

begin_function
name|int
name|validateascii
parameter_list|(
name|char
modifier|*
name|string
parameter_list|,
name|u_int32_t
name|len
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|len
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|string
index|[
name|i
index|]
operator|==
literal|'\0'
condition|)
break|break;
if|if
condition|(
name|string
index|[
name|i
index|]
operator|&
literal|0x80
condition|)
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
if|if
condition|(
name|string
index|[
name|i
index|]
operator|!=
literal|'\0'
condition|)
return|return
operator|(
operator|-
literal|1
operator|)
return|;
return|return
operator|(
name|i
operator|+
literal|1
operator|)
return|;
block|}
end_function

begin_function
name|char
modifier|*
name|idmap_prune_domain
parameter_list|(
name|struct
name|idmap_msg
modifier|*
name|m
parameter_list|)
block|{
name|size_t
name|i
decl_stmt|;
name|size_t
name|len
decl_stmt|;
name|char
modifier|*
name|ret
init|=
name|NULL
decl_stmt|;
if|if
condition|(
name|m
operator|==
name|NULL
condition|)
return|return
name|NULL
return|;
name|len
operator|=
name|m
operator|->
name|id_namelen
expr_stmt|;
if|if
condition|(
name|validateascii
argument_list|(
name|m
operator|->
name|id_name
argument_list|,
name|len
argument_list|)
operator|<
literal|0
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"msg has invalid ascii\n"
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|len
operator|&&
name|m
operator|->
name|id_name
index|[
name|i
index|]
operator|!=
literal|'@'
condition|;
name|i
operator|++
control|)
empty_stmt|;
name|ret
operator|=
operator|(
name|char
operator|*
operator|)
name|malloc
argument_list|(
name|i
operator|+
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|==
name|NULL
condition|)
return|return
name|NULL
return|;
name|bcopy
argument_list|(
name|m
operator|->
name|id_name
argument_list|,
name|ret
argument_list|,
name|i
argument_list|)
expr_stmt|;
name|ret
index|[
name|i
index|]
operator|=
literal|'\0'
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_function
name|int
name|idmap_add_domain
parameter_list|(
name|struct
name|idmap_msg
modifier|*
name|m
parameter_list|,
name|char
modifier|*
name|name
parameter_list|)
block|{
name|size_t
name|len
decl_stmt|,
name|nlen
decl_stmt|;
if|if
condition|(
name|m
operator|==
name|NULL
operator|||
name|name
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
name|len
operator|=
name|strlen
argument_list|(
name|name
argument_list|)
expr_stmt|;
name|nlen
operator|=
name|len
operator|+
name|strlen
argument_list|(
name|domain
argument_list|)
expr_stmt|;
if|if
condition|(
name|nlen
operator|>
name|IDMAP_MAXNAMELEN
condition|)
return|return
operator|-
literal|1
return|;
name|bcopy
argument_list|(
name|name
argument_list|,
operator|&
name|m
operator|->
name|id_name
index|[
literal|0
index|]
argument_list|,
name|len
argument_list|)
expr_stmt|;
name|bcopy
argument_list|(
name|domain
argument_list|,
operator|&
name|m
operator|->
name|id_name
index|[
name|len
index|]
argument_list|,
name|strlen
argument_list|(
name|domain
argument_list|)
argument_list|)
expr_stmt|;
name|m
operator|->
name|id_name
index|[
name|nlen
index|]
operator|=
literal|'\0'
expr_stmt|;
name|m
operator|->
name|id_namelen
operator|=
name|nlen
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|int
name|idmap_name
parameter_list|(
name|struct
name|idmap_msg
modifier|*
name|m
parameter_list|,
name|char
modifier|*
name|name
parameter_list|)
block|{
if|if
condition|(
name|m
operator|==
name|NULL
operator|||
name|name
operator|==
name|NULL
operator|||
name|m
operator|->
name|id_namelen
operator|!=
literal|0
condition|)
return|return
operator|-
literal|1
return|;
if|if
condition|(
name|idmap_add_domain
argument_list|(
name|m
argument_list|,
name|name
argument_list|)
condition|)
return|return
operator|-
literal|1
return|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|int
name|idmap_id
parameter_list|(
name|struct
name|idmap_msg
modifier|*
name|m
parameter_list|,
name|ident_t
name|id
parameter_list|)
block|{
if|if
condition|(
name|m
operator|==
name|NULL
operator|||
name|m
operator|->
name|id_namelen
operator|==
literal|0
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"idmap_id: bad msg\n"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
switch|switch
condition|(
name|m
operator|->
name|id_type
condition|)
block|{
case|case
name|IDMAP_TYPE_UID
case|:
name|m
operator|->
name|id_id
operator|.
name|uid
operator|=
name|id
operator|.
name|uid
expr_stmt|;
break|break;
case|case
name|IDMAP_TYPE_GID
case|:
name|m
operator|->
name|id_id
operator|.
name|gid
operator|=
name|id
operator|.
name|gid
expr_stmt|;
break|break;
default|default:
return|return
operator|-
literal|1
return|;
break|break;
block|}
empty_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|int
name|idmap_service
parameter_list|(
name|struct
name|idmap_e
modifier|*
name|e
parameter_list|)
block|{
name|struct
name|idmap_msg
modifier|*
name|m
decl_stmt|;
name|struct
name|passwd
modifier|*
name|pwd
decl_stmt|;
name|struct
name|group
modifier|*
name|grp
decl_stmt|;
name|ident_t
name|id
decl_stmt|;
name|char
modifier|*
name|name
decl_stmt|;
if|if
condition|(
name|e
operator|==
name|NULL
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"bad entry\n"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
if|if
condition|(
name|e
operator|->
name|msg
operator|.
name|msg_vers
operator|!=
name|NFS4DEV_VERSION
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"kernel/userland version mismatch! %d/%d\n"
argument_list|,
name|e
operator|->
name|msg
operator|.
name|msg_vers
argument_list|,
name|NFS4DEV_VERSION
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
if|if
condition|(
name|e
operator|->
name|msg
operator|.
name|msg_type
operator|!=
name|NFS4DEV_TYPE_IDMAP
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"bad type!\n"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
if|if
condition|(
name|e
operator|->
name|msg
operator|.
name|msg_len
operator|!=
sizeof|sizeof
argument_list|(
expr|struct
name|idmap_msg
argument_list|)
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"bad message length: %zu/%zu\n"
argument_list|,
name|e
operator|->
name|msg
operator|.
name|msg_len
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|idmap_msg
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
if|if
condition|(
name|verbose
condition|)
name|printf
argument_list|(
literal|"servicing msg xid: %x\n"
argument_list|,
name|e
operator|->
name|msg
operator|.
name|msg_xid
argument_list|)
expr_stmt|;
name|m
operator|=
operator|(
expr|struct
name|idmap_msg
operator|*
operator|)
name|e
operator|->
name|msg
operator|.
name|msg_data
expr_stmt|;
if|if
condition|(
name|m
operator|->
name|id_namelen
operator|!=
literal|0
operator|&&
name|m
operator|->
name|id_namelen
operator|!=
name|strlen
argument_list|(
name|m
operator|->
name|id_name
argument_list|)
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"bad name length in idmap_msg\n"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
switch|switch
condition|(
name|m
operator|->
name|id_type
condition|)
block|{
case|case
name|IDMAP_TYPE_UID
case|:
if|if
condition|(
name|m
operator|->
name|id_namelen
operator|==
literal|0
condition|)
block|{
comment|/* id to name */
name|pwd
operator|=
name|getpwuid
argument_list|(
name|m
operator|->
name|id_id
operator|.
name|uid
argument_list|)
expr_stmt|;
if|if
condition|(
name|pwd
operator|==
name|NULL
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"unknown uid %d!\n"
argument_list|,
operator|(
name|uint32_t
operator|)
name|m
operator|->
name|id_id
operator|.
name|uid
argument_list|)
expr_stmt|;
name|name
operator|=
name|BADUSER
expr_stmt|;
block|}
else|else
name|name
operator|=
name|pwd
operator|->
name|pw_name
expr_stmt|;
if|if
condition|(
name|idmap_name
argument_list|(
name|m
argument_list|,
name|name
argument_list|)
condition|)
return|return
operator|-
literal|1
return|;
block|}
else|else
block|{
comment|/* name to id */
name|name
operator|=
name|idmap_prune_domain
argument_list|(
name|m
argument_list|)
expr_stmt|;
if|if
condition|(
name|name
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
name|pwd
operator|=
name|getpwnam
argument_list|(
name|name
argument_list|)
expr_stmt|;
if|if
condition|(
name|pwd
operator|==
name|NULL
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"unknown username %s!\n"
argument_list|,
name|name
argument_list|)
expr_stmt|;
name|id
operator|.
name|uid
operator|=
operator|(
name|uid_t
operator|)
name|BADUID
expr_stmt|;
block|}
else|else
name|id
operator|.
name|uid
operator|=
name|pwd
operator|->
name|pw_uid
expr_stmt|;
name|free
argument_list|(
name|name
argument_list|)
expr_stmt|;
if|if
condition|(
name|idmap_id
argument_list|(
name|m
argument_list|,
name|id
argument_list|)
condition|)
return|return
operator|-
literal|1
return|;
block|}
break|break;
case|case
name|IDMAP_TYPE_GID
case|:
if|if
condition|(
name|m
operator|->
name|id_namelen
operator|==
literal|0
condition|)
block|{
comment|/* id to name */
name|grp
operator|=
name|getgrgid
argument_list|(
name|m
operator|->
name|id_id
operator|.
name|gid
argument_list|)
expr_stmt|;
if|if
condition|(
name|grp
operator|==
name|NULL
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"unknown gid %d!\n"
argument_list|,
operator|(
name|uint32_t
operator|)
name|m
operator|->
name|id_id
operator|.
name|gid
argument_list|)
expr_stmt|;
name|name
operator|=
name|BADGROUP
expr_stmt|;
block|}
else|else
name|name
operator|=
name|grp
operator|->
name|gr_name
expr_stmt|;
if|if
condition|(
name|idmap_name
argument_list|(
name|m
argument_list|,
name|name
argument_list|)
condition|)
return|return
operator|-
literal|1
return|;
block|}
else|else
block|{
comment|/* name to id */
name|name
operator|=
name|idmap_prune_domain
argument_list|(
name|m
argument_list|)
expr_stmt|;
if|if
condition|(
name|name
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
name|grp
operator|=
name|getgrnam
argument_list|(
name|name
argument_list|)
expr_stmt|;
if|if
condition|(
name|grp
operator|==
name|NULL
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"unknown groupname %s!\n"
argument_list|,
name|name
argument_list|)
expr_stmt|;
name|id
operator|.
name|gid
operator|=
operator|(
name|gid_t
operator|)
name|BADGID
expr_stmt|;
block|}
else|else
name|id
operator|.
name|gid
operator|=
name|grp
operator|->
name|gr_gid
expr_stmt|;
name|free
argument_list|(
name|name
argument_list|)
expr_stmt|;
if|if
condition|(
name|idmap_id
argument_list|(
name|m
argument_list|,
name|id
argument_list|)
condition|)
return|return
operator|-
literal|1
return|;
block|}
break|break;
default|default:
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"bad idmap type: %d\n"
argument_list|,
name|m
operator|->
name|id_type
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
break|break;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
name|int
name|main
parameter_list|(
name|int
name|argc
parameter_list|,
name|char
modifier|*
modifier|*
name|argv
parameter_list|)
block|{
name|int
name|error
init|=
literal|0
decl_stmt|;
name|struct
name|idmap_e
modifier|*
name|entry
decl_stmt|;
name|fd_set
name|read_fds
decl_stmt|,
name|write_fds
decl_stmt|;
name|int
name|maxfd
decl_stmt|;
name|int
name|ret
decl_stmt|,
name|ch
decl_stmt|;
while|while
condition|(
operator|(
name|ch
operator|=
name|getopt
argument_list|(
name|argc
argument_list|,
name|argv
argument_list|,
literal|"d:v"
argument_list|)
operator|)
operator|!=
operator|-
literal|1
condition|)
block|{
switch|switch
condition|(
name|ch
condition|)
block|{
case|case
literal|'d'
case|:
name|domain
operator|=
name|optarg
expr_stmt|;
break|break;
case|case
literal|'v'
case|:
name|verbose
operator|=
literal|1
expr_stmt|;
break|break;
default|default:
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"usage: %s [-v] [-d domain]\n"
argument_list|,
name|argv
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
name|TAILQ_INIT
argument_list|(
operator|&
name|upcall_q
argument_list|)
expr_stmt|;
name|fd
operator|=
name|open
argument_list|(
name|DEV_PATH
argument_list|,
name|O_RDWR
argument_list|,
name|S_IRUSR
operator||
name|S_IWUSR
argument_list|)
expr_stmt|;
if|if
condition|(
name|fd
operator|<
literal|0
condition|)
block|{
name|perror
argument_list|(
name|DEV_PATH
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|verbose
condition|)
name|daemon
argument_list|(
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|maxfd
operator|=
name|fd
expr_stmt|;
for|for
control|(
init|;
condition|;
control|)
block|{
name|struct
name|timeval
name|timo
init|=
block|{
literal|1
block|,
literal|0
block|}
decl_stmt|;
do|do
block|{
name|FD_ZERO
argument_list|(
operator|&
name|read_fds
argument_list|)
expr_stmt|;
name|FD_ZERO
argument_list|(
operator|&
name|write_fds
argument_list|)
expr_stmt|;
name|FD_SET
argument_list|(
name|fd
argument_list|,
operator|&
name|read_fds
argument_list|)
expr_stmt|;
name|FD_SET
argument_list|(
name|fd
argument_list|,
operator|&
name|write_fds
argument_list|)
expr_stmt|;
name|ret
operator|=
name|select
argument_list|(
name|maxfd
operator|+
literal|1
argument_list|,
operator|&
name|read_fds
argument_list|,
operator|&
name|write_fds
argument_list|,
name|NULL
argument_list|,
operator|&
name|timo
argument_list|)
expr_stmt|;
block|}
do|while
condition|(
name|ret
operator|<
literal|0
operator|&&
name|errno
operator|==
name|EINTR
condition|)
do|;
if|if
condition|(
name|ret
operator|<=
literal|0
condition|)
block|{
if|if
condition|(
name|ret
operator|!=
literal|0
condition|)
name|perror
argument_list|(
literal|"select"
argument_list|)
expr_stmt|;
continue|continue;
block|}
if|if
condition|(
name|FD_ISSET
argument_list|(
name|fd
argument_list|,
operator|&
name|read_fds
argument_list|)
condition|)
block|{
for|for
control|(
init|;
condition|;
control|)
block|{
name|get_idmap_e
argument_list|(
name|entry
argument_list|)
expr_stmt|;
name|error
operator|=
name|ioctl
argument_list|(
name|fd
argument_list|,
name|NFS4DEVIOCGET
argument_list|,
operator|&
name|entry
operator|->
name|msg
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|==
operator|-
literal|1
condition|)
block|{
if|if
condition|(
name|errno
operator|!=
name|EAGAIN
condition|)
name|perror
argument_list|(
literal|"get ioctl:"
argument_list|)
expr_stmt|;
name|put_idmap_e
argument_list|(
name|entry
argument_list|)
expr_stmt|;
break|break;
block|}
switch|switch
condition|(
name|entry
operator|->
name|msg
operator|.
name|msg_type
condition|)
block|{
case|case
name|NFS4DEV_TYPE_IDMAP
case|:
if|if
condition|(
name|idmap_service
argument_list|(
name|entry
argument_list|)
condition|)
name|entry
operator|->
name|msg
operator|.
name|msg_error
operator|=
name|EIO
expr_stmt|;
break|break;
default|default:
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"unknown nfs4dev_msg type\n"
argument_list|)
expr_stmt|;
name|entry
operator|->
name|msg
operator|.
name|msg_error
operator|=
name|EIO
expr_stmt|;
break|break;
block|}
name|add_idmap_e
argument_list|(
name|entry
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
name|FD_ISSET
argument_list|(
name|fd
argument_list|,
operator|&
name|write_fds
argument_list|)
condition|)
block|{
while|while
condition|(
operator|!
name|TAILQ_EMPTY
argument_list|(
operator|&
name|upcall_q
argument_list|)
condition|)
block|{
name|remove_idmap_e
argument_list|(
name|entry
argument_list|)
expr_stmt|;
name|error
operator|=
name|ioctl
argument_list|(
name|fd
argument_list|,
name|NFS4DEVIOCPUT
argument_list|,
operator|&
name|entry
operator|->
name|msg
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|==
operator|-
literal|1
condition|)
block|{
if|if
condition|(
name|errno
operator|!=
name|EAGAIN
condition|)
name|perror
argument_list|(
literal|"put ioctl"
argument_list|)
expr_stmt|;
break|break;
block|}
name|put_idmap_e
argument_list|(
name|entry
argument_list|)
expr_stmt|;
block|}
block|}
block|}
comment|/* never reached */
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
end_function

end_unit


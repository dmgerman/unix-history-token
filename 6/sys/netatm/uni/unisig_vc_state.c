begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*-  * ===================================  * HARP  |  Host ATM Research Platform  * ===================================  *  *  * This Host ATM Research Platform ("HARP") file (the "Software") is  * made available by Network Computing Services, Inc. ("NetworkCS")  * "AS IS".  NetworkCS does not provide maintenance, improvements or  * support of any kind.  *  * NETWORKCS MAKES NO WARRANTIES OR REPRESENTATIONS, EXPRESS OR IMPLIED,  * INCLUDING, BUT NOT LIMITED TO, IMPLIED WARRANTIES OF MERCHANTABILITY  * AND FITNESS FOR A PARTICULAR PURPOSE, AS TO ANY ELEMENT OF THE  * SOFTWARE OR ANY SUPPORT PROVIDED IN CONNECTION WITH THIS SOFTWARE.  * In no event shall NetworkCS be responsible for any damages, including  * but not limited to consequential damages, arising from or relating to  * any use of the Software or related support.  *  * Copyright 1994-1998 Network Computing Services, Inc.  *  * Copies of this Software may be made, however, the above copyright  * notice must be reproduced on all copies.  */
end_comment

begin_comment
comment|/*  * ATM Forum UNI 3.0/3.1 Signalling Manager  * ----------------------------------------  *  * VC state machine  */
end_comment

begin_include
include|#
directive|include
file|<sys/cdefs.h>
end_include

begin_expr_stmt
name|__FBSDID
argument_list|(
literal|"$FreeBSD$"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_include
include|#
directive|include
file|<sys/param.h>
end_include

begin_include
include|#
directive|include
file|<sys/systm.h>
end_include

begin_include
include|#
directive|include
file|<sys/types.h>
end_include

begin_include
include|#
directive|include
file|<sys/errno.h>
end_include

begin_include
include|#
directive|include
file|<sys/time.h>
end_include

begin_include
include|#
directive|include
file|<sys/socket.h>
end_include

begin_include
include|#
directive|include
file|<sys/socketvar.h>
end_include

begin_include
include|#
directive|include
file|<sys/syslog.h>
end_include

begin_include
include|#
directive|include
file|<net/if.h>
end_include

begin_include
include|#
directive|include
file|<netatm/port.h>
end_include

begin_include
include|#
directive|include
file|<netatm/queue.h>
end_include

begin_include
include|#
directive|include
file|<netatm/atm.h>
end_include

begin_include
include|#
directive|include
file|<netatm/atm_sys.h>
end_include

begin_include
include|#
directive|include
file|<netatm/atm_sap.h>
end_include

begin_include
include|#
directive|include
file|<netatm/atm_cm.h>
end_include

begin_include
include|#
directive|include
file|<netatm/atm_if.h>
end_include

begin_include
include|#
directive|include
file|<netatm/atm_vc.h>
end_include

begin_include
include|#
directive|include
file|<netatm/atm_sigmgr.h>
end_include

begin_include
include|#
directive|include
file|<netatm/atm_stack.h>
end_include

begin_include
include|#
directive|include
file|<netatm/atm_pcb.h>
end_include

begin_include
include|#
directive|include
file|<netatm/atm_var.h>
end_include

begin_include
include|#
directive|include
file|<netatm/uni/unisig_var.h>
end_include

begin_include
include|#
directive|include
file|<netatm/uni/unisig_msg.h>
end_include

begin_comment
comment|/*  * Local functions  */
end_comment

begin_function_decl
specifier|static
name|int
name|unisig_vc_invalid
parameter_list|(
name|struct
name|unisig
modifier|*
parameter_list|,
name|struct
name|unisig_vccb
modifier|*
parameter_list|,
name|struct
name|unisig_msg
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|unisig_vc_act01
parameter_list|(
name|struct
name|unisig
modifier|*
parameter_list|,
name|struct
name|unisig_vccb
modifier|*
parameter_list|,
name|struct
name|unisig_msg
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|unisig_vc_act02
parameter_list|(
name|struct
name|unisig
modifier|*
parameter_list|,
name|struct
name|unisig_vccb
modifier|*
parameter_list|,
name|struct
name|unisig_msg
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|unisig_vc_act03
parameter_list|(
name|struct
name|unisig
modifier|*
parameter_list|,
name|struct
name|unisig_vccb
modifier|*
parameter_list|,
name|struct
name|unisig_msg
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|unisig_vc_act04
parameter_list|(
name|struct
name|unisig
modifier|*
parameter_list|,
name|struct
name|unisig_vccb
modifier|*
parameter_list|,
name|struct
name|unisig_msg
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|unisig_vc_act05
parameter_list|(
name|struct
name|unisig
modifier|*
parameter_list|,
name|struct
name|unisig_vccb
modifier|*
parameter_list|,
name|struct
name|unisig_msg
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|unisig_vc_act06
parameter_list|(
name|struct
name|unisig
modifier|*
parameter_list|,
name|struct
name|unisig_vccb
modifier|*
parameter_list|,
name|struct
name|unisig_msg
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|unisig_vc_act07
parameter_list|(
name|struct
name|unisig
modifier|*
parameter_list|,
name|struct
name|unisig_vccb
modifier|*
parameter_list|,
name|struct
name|unisig_msg
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|unisig_vc_act08
parameter_list|(
name|struct
name|unisig
modifier|*
parameter_list|,
name|struct
name|unisig_vccb
modifier|*
parameter_list|,
name|struct
name|unisig_msg
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|unisig_vc_act09
parameter_list|(
name|struct
name|unisig
modifier|*
parameter_list|,
name|struct
name|unisig_vccb
modifier|*
parameter_list|,
name|struct
name|unisig_msg
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|unisig_vc_act10
parameter_list|(
name|struct
name|unisig
modifier|*
parameter_list|,
name|struct
name|unisig_vccb
modifier|*
parameter_list|,
name|struct
name|unisig_msg
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|unisig_vc_act11
parameter_list|(
name|struct
name|unisig
modifier|*
parameter_list|,
name|struct
name|unisig_vccb
modifier|*
parameter_list|,
name|struct
name|unisig_msg
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|unisig_vc_act12
parameter_list|(
name|struct
name|unisig
modifier|*
parameter_list|,
name|struct
name|unisig_vccb
modifier|*
parameter_list|,
name|struct
name|unisig_msg
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|unisig_vc_act13
parameter_list|(
name|struct
name|unisig
modifier|*
parameter_list|,
name|struct
name|unisig_vccb
modifier|*
parameter_list|,
name|struct
name|unisig_msg
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|unisig_vc_act14
parameter_list|(
name|struct
name|unisig
modifier|*
parameter_list|,
name|struct
name|unisig_vccb
modifier|*
parameter_list|,
name|struct
name|unisig_msg
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|unisig_vc_act15
parameter_list|(
name|struct
name|unisig
modifier|*
parameter_list|,
name|struct
name|unisig_vccb
modifier|*
parameter_list|,
name|struct
name|unisig_msg
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|unisig_vc_act16
parameter_list|(
name|struct
name|unisig
modifier|*
parameter_list|,
name|struct
name|unisig_vccb
modifier|*
parameter_list|,
name|struct
name|unisig_msg
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|unisig_vc_act17
parameter_list|(
name|struct
name|unisig
modifier|*
parameter_list|,
name|struct
name|unisig_vccb
modifier|*
parameter_list|,
name|struct
name|unisig_msg
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|unisig_vc_act18
parameter_list|(
name|struct
name|unisig
modifier|*
parameter_list|,
name|struct
name|unisig_vccb
modifier|*
parameter_list|,
name|struct
name|unisig_msg
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|unisig_vc_act19
parameter_list|(
name|struct
name|unisig
modifier|*
parameter_list|,
name|struct
name|unisig_vccb
modifier|*
parameter_list|,
name|struct
name|unisig_msg
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|unisig_vc_act20
parameter_list|(
name|struct
name|unisig
modifier|*
parameter_list|,
name|struct
name|unisig_vccb
modifier|*
parameter_list|,
name|struct
name|unisig_msg
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|unisig_vc_act21
parameter_list|(
name|struct
name|unisig
modifier|*
parameter_list|,
name|struct
name|unisig_vccb
modifier|*
parameter_list|,
name|struct
name|unisig_msg
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|unisig_vc_act22
parameter_list|(
name|struct
name|unisig
modifier|*
parameter_list|,
name|struct
name|unisig_vccb
modifier|*
parameter_list|,
name|struct
name|unisig_msg
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|unisig_vc_act23
parameter_list|(
name|struct
name|unisig
modifier|*
parameter_list|,
name|struct
name|unisig_vccb
modifier|*
parameter_list|,
name|struct
name|unisig_msg
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|unisig_vc_act24
parameter_list|(
name|struct
name|unisig
modifier|*
parameter_list|,
name|struct
name|unisig_vccb
modifier|*
parameter_list|,
name|struct
name|unisig_msg
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|unisig_vc_act25
parameter_list|(
name|struct
name|unisig
modifier|*
parameter_list|,
name|struct
name|unisig_vccb
modifier|*
parameter_list|,
name|struct
name|unisig_msg
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|unisig_vc_act26
parameter_list|(
name|struct
name|unisig
modifier|*
parameter_list|,
name|struct
name|unisig_vccb
modifier|*
parameter_list|,
name|struct
name|unisig_msg
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|unisig_vc_act27
parameter_list|(
name|struct
name|unisig
modifier|*
parameter_list|,
name|struct
name|unisig_vccb
modifier|*
parameter_list|,
name|struct
name|unisig_msg
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|unisig_vc_act28
parameter_list|(
name|struct
name|unisig
modifier|*
parameter_list|,
name|struct
name|unisig_vccb
modifier|*
parameter_list|,
name|struct
name|unisig_msg
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|unisig_vc_act29
parameter_list|(
name|struct
name|unisig
modifier|*
parameter_list|,
name|struct
name|unisig_vccb
modifier|*
parameter_list|,
name|struct
name|unisig_msg
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|unisig_vc_act30
parameter_list|(
name|struct
name|unisig
modifier|*
parameter_list|,
name|struct
name|unisig_vccb
modifier|*
parameter_list|,
name|struct
name|unisig_msg
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|unisig_vc_act31
parameter_list|(
name|struct
name|unisig
modifier|*
parameter_list|,
name|struct
name|unisig_vccb
modifier|*
parameter_list|,
name|struct
name|unisig_msg
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|unisig_vc_clear_call
parameter_list|(
name|struct
name|unisig
modifier|*
parameter_list|,
name|struct
name|unisig_vccb
modifier|*
parameter_list|,
name|struct
name|unisig_msg
modifier|*
parameter_list|,
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_comment
comment|/*  * State table  */
end_comment

begin_decl_stmt
specifier|static
name|int
name|unisig_vc_states
index|[
literal|21
index|]
index|[
literal|17
index|]
init|=
block|{
comment|/* 0   1   2   3   4   5   6   7   8   9  10  11  12  13  14  15  16 */
block|{
literal|0
block|,
literal|2
block|,
literal|99
block|,
literal|5
block|,
literal|99
block|,
literal|99
block|,
literal|0
block|,
literal|99
block|,
literal|12
block|,
literal|99
block|,
literal|0
block|,
literal|14
block|,
literal|0
block|,
literal|3
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|}
block|,
block|{
literal|29
block|,
literal|4
block|,
literal|99
block|,
literal|17
block|,
literal|99
block|,
literal|99
block|,
literal|17
block|,
literal|99
block|,
literal|17
block|,
literal|99
block|,
literal|17
block|,
literal|17
block|,
literal|17
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|}
block|,
block|{
literal|29
block|,
literal|6
block|,
literal|99
block|,
literal|6
block|,
literal|99
block|,
literal|99
block|,
literal|17
block|,
literal|99
block|,
literal|17
block|,
literal|99
block|,
literal|17
block|,
literal|17
block|,
literal|17
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|}
block|,
block|{
literal|29
block|,
literal|17
block|,
literal|99
block|,
literal|17
block|,
literal|99
block|,
literal|99
block|,
literal|17
block|,
literal|99
block|,
literal|10
block|,
literal|99
block|,
literal|17
block|,
literal|17
block|,
literal|17
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|}
block|,
block|{
literal|8
block|,
literal|17
block|,
literal|99
block|,
literal|17
block|,
literal|99
block|,
literal|99
block|,
literal|17
block|,
literal|99
block|,
literal|17
block|,
literal|99
block|,
literal|17
block|,
literal|17
block|,
literal|17
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|}
block|,
block|{
literal|29
block|,
literal|7
block|,
literal|99
block|,
literal|15
block|,
literal|99
block|,
literal|99
block|,
literal|15
block|,
literal|99
block|,
literal|15
block|,
literal|99
block|,
literal|15
block|,
literal|16
block|,
literal|17
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|}
block|,
block|{
literal|19
block|,
literal|3
block|,
literal|99
block|,
literal|3
block|,
literal|99
block|,
literal|99
block|,
literal|3
block|,
literal|99
block|,
literal|3
block|,
literal|99
block|,
literal|3
block|,
literal|13
block|,
literal|3
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|}
block|,
block|{
literal|21
block|,
literal|21
block|,
literal|99
block|,
literal|21
block|,
literal|99
block|,
literal|99
block|,
literal|21
block|,
literal|99
block|,
literal|21
block|,
literal|99
block|,
literal|21
block|,
literal|21
block|,
literal|21
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|}
block|,
block|{
literal|22
block|,
literal|22
block|,
literal|99
block|,
literal|22
block|,
literal|99
block|,
literal|99
block|,
literal|22
block|,
literal|99
block|,
literal|22
block|,
literal|99
block|,
literal|22
block|,
literal|22
block|,
literal|22
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|}
block|,
block|{
literal|29
block|,
literal|17
block|,
literal|99
block|,
literal|17
block|,
literal|99
block|,
literal|99
block|,
literal|17
block|,
literal|99
block|,
literal|17
block|,
literal|99
block|,
literal|23
block|,
literal|17
block|,
literal|17
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|}
block|,
block|{
literal|29
block|,
literal|17
block|,
literal|99
block|,
literal|17
block|,
literal|99
block|,
literal|99
block|,
literal|17
block|,
literal|99
block|,
literal|17
block|,
literal|99
block|,
literal|17
block|,
literal|17
block|,
literal|17
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|}
block|,
block|{
literal|29
block|,
literal|17
block|,
literal|99
block|,
literal|17
block|,
literal|99
block|,
literal|99
block|,
literal|17
block|,
literal|99
block|,
literal|17
block|,
literal|99
block|,
literal|17
block|,
literal|17
block|,
literal|17
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|}
block|,
block|{
literal|29
block|,
literal|17
block|,
literal|99
block|,
literal|17
block|,
literal|99
block|,
literal|99
block|,
literal|17
block|,
literal|99
block|,
literal|17
block|,
literal|99
block|,
literal|17
block|,
literal|17
block|,
literal|17
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|}
block|,
block|{
literal|29
block|,
literal|17
block|,
literal|99
block|,
literal|17
block|,
literal|99
block|,
literal|99
block|,
literal|17
block|,
literal|99
block|,
literal|17
block|,
literal|99
block|,
literal|17
block|,
literal|17
block|,
literal|17
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|}
block|,
block|{
literal|1
block|,
literal|99
block|,
literal|99
block|,
literal|99
block|,
literal|99
block|,
literal|99
block|,
literal|99
block|,
literal|99
block|,
literal|99
block|,
literal|99
block|,
literal|99
block|,
literal|99
block|,
literal|99
block|,
literal|99
block|,
literal|99
block|,
literal|99
block|,
literal|99
block|}
block|,
block|{
literal|99
block|,
literal|25
block|,
literal|99
block|,
literal|25
block|,
literal|99
block|,
literal|99
block|,
literal|9
block|,
literal|99
block|,
literal|25
block|,
literal|99
block|,
literal|25
block|,
literal|25
block|,
literal|25
block|,
literal|25
block|,
literal|31
block|,
literal|25
block|,
literal|25
block|}
block|,
block|{
literal|99
block|,
literal|25
block|,
literal|99
block|,
literal|25
block|,
literal|99
block|,
literal|99
block|,
literal|11
block|,
literal|99
block|,
literal|25
block|,
literal|99
block|,
literal|25
block|,
literal|25
block|,
literal|25
block|,
literal|25
block|,
literal|19
block|,
literal|25
block|,
literal|25
block|}
block|,
block|{
literal|99
block|,
literal|12
block|,
literal|99
block|,
literal|12
block|,
literal|99
block|,
literal|99
block|,
literal|25
block|,
literal|99
block|,
literal|12
block|,
literal|99
block|,
literal|12
block|,
literal|19
block|,
literal|19
block|,
literal|30
block|,
literal|19
block|,
literal|99
block|,
literal|99
block|}
block|,
block|{
literal|99
block|,
literal|12
block|,
literal|99
block|,
literal|12
block|,
literal|99
block|,
literal|99
block|,
literal|12
block|,
literal|99
block|,
literal|12
block|,
literal|99
block|,
literal|12
block|,
literal|3
block|,
literal|3
block|,
literal|3
block|,
literal|24
block|,
literal|26
block|,
literal|26
block|}
block|,
block|{
literal|99
block|,
literal|3
block|,
literal|99
block|,
literal|3
block|,
literal|99
block|,
literal|99
block|,
literal|30
block|,
literal|99
block|,
literal|3
block|,
literal|99
block|,
literal|18
block|,
literal|3
block|,
literal|3
block|,
literal|0
block|,
literal|19
block|,
literal|27
block|,
literal|19
block|}
block|,
block|{
literal|99
block|,
literal|7
block|,
literal|99
block|,
literal|7
block|,
literal|99
block|,
literal|99
block|,
literal|30
block|,
literal|99
block|,
literal|7
block|,
literal|99
block|,
literal|19
block|,
literal|19
block|,
literal|19
block|,
literal|20
block|,
literal|19
block|,
literal|19
block|,
literal|28
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_comment
comment|/*  * Action vector  *  * A given state, action pair selects an action number from the  * state table.  This vector holds the address of the action routine  * for each action number.  */
end_comment

begin_define
define|#
directive|define
name|MAX_ACTION
value|32
end_define

begin_function_decl
specifier|static
name|int
function_decl|(
modifier|*
name|unisig_vc_act_vec
index|[
name|MAX_ACTION
index|]
function_decl|)
parameter_list|(
name|struct
name|unisig
modifier|*
parameter_list|,
name|struct
name|unisig_vccb
modifier|*
parameter_list|,
name|struct
name|unisig_msg
modifier|*
parameter_list|)
init|=
block|{
name|unisig_vc_invalid
operator|,
function_decl|unisig_vc_act01
operator|,
function_decl|unisig_vc_act02
operator|,
function_decl|unisig_vc_act03
operator|,
function_decl|unisig_vc_act04
operator|,
function_decl|unisig_vc_act05
operator|,
function_decl|unisig_vc_act06
operator|,
function_decl|unisig_vc_act07
operator|,
function_decl|unisig_vc_act08
operator|,
function_decl|unisig_vc_act09
operator|,
function_decl|unisig_vc_act10
operator|,
function_decl|unisig_vc_act11
operator|,
function_decl|unisig_vc_act12
operator|,
function_decl|unisig_vc_act13
operator|,
function_decl|unisig_vc_act14
operator|,
function_decl|unisig_vc_act15
operator|,
function_decl|unisig_vc_act16
operator|,
function_decl|unisig_vc_act17
operator|,
function_decl|unisig_vc_act18
operator|,
function_decl|unisig_vc_act19
operator|,
function_decl|unisig_vc_act20
operator|,
function_decl|unisig_vc_act21
operator|,
function_decl|unisig_vc_act22
operator|,
function_decl|unisig_vc_act23
operator|,
function_decl|unisig_vc_act24
operator|,
function_decl|unisig_vc_act25
operator|,
function_decl|unisig_vc_act26
operator|,
function_decl|unisig_vc_act27
operator|,
function_decl|unisig_vc_act28
operator|,
function_decl|unisig_vc_act29
operator|,
function_decl|unisig_vc_act30
operator|,
function_decl|unisig_vc_act31
end_function_decl

begin_comment
unit|};
comment|/*  * Process an event on a VC  *  * Arguments:  *	usp	pointer to the UNISIG instance  *	uvp	pointer to the VCCB for the affected VCC  *	event	a numeric indication of which event has occured  *	msg	pointer to a signalling message structure  *  * Returns:  *	0	success  *	errno	error encountered  *  */
end_comment

begin_function
name|int
name|unisig_vc_state
parameter_list|(
name|usp
parameter_list|,
name|uvp
parameter_list|,
name|event
parameter_list|,
name|msg
parameter_list|)
name|struct
name|unisig
modifier|*
name|usp
decl_stmt|;
name|struct
name|unisig_vccb
modifier|*
name|uvp
decl_stmt|;
name|int
name|event
decl_stmt|;
name|struct
name|unisig_msg
modifier|*
name|msg
decl_stmt|;
block|{
name|int
name|action
decl_stmt|,
name|rc
decl_stmt|,
name|state
decl_stmt|;
comment|/* 	 * Select an action from the state table 	 */
if|if
condition|(
name|uvp
condition|)
name|state
operator|=
name|uvp
operator|->
name|uv_sstate
expr_stmt|;
else|else
name|state
operator|=
name|UNI_NULL
expr_stmt|;
name|action
operator|=
name|unisig_vc_states
index|[
name|event
index|]
index|[
name|state
index|]
expr_stmt|;
if|if
condition|(
name|action
operator|>=
name|MAX_ACTION
operator|||
name|action
operator|<
literal|0
condition|)
name|panic
argument_list|(
literal|"unisig_vc_state: invalid action\n"
argument_list|)
expr_stmt|;
comment|/* 	 * Perform the requested action 	 */
name|ATM_DEBUG4
argument_list|(
literal|"unisig_vc_state: uvp=%p, state=%d, event=%d, action=%d\n"
argument_list|,
name|uvp
argument_list|,
name|state
argument_list|,
name|event
argument_list|,
name|action
argument_list|)
expr_stmt|;
name|rc
operator|=
name|unisig_vc_act_vec
index|[
name|action
index|]
operator|(
name|usp
operator|,
name|uvp
operator|,
name|msg
operator|)
expr_stmt|;
return|return
operator|(
name|rc
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * VC state machine action 0  * Unexpected action - log an error message  *  * Arguments:  *	usp	pointer to protocol instance block  *	uvp	pointer to the VCCB for the affected connection (may 		be null)  *	msg	pointer to a UNISIG message structure  *  * Returns:  *	0	success  *	errno	error encountered  *  */
end_comment

begin_function
specifier|static
name|int
name|unisig_vc_invalid
parameter_list|(
name|usp
parameter_list|,
name|uvp
parameter_list|,
name|msg
parameter_list|)
name|struct
name|unisig
modifier|*
name|usp
decl_stmt|;
name|struct
name|unisig_vccb
modifier|*
name|uvp
decl_stmt|;
name|struct
name|unisig_msg
modifier|*
name|msg
decl_stmt|;
block|{
name|log
argument_list|(
name|LOG_ERR
argument_list|,
literal|"unisig_vc_state: unexpected action\n"
argument_list|)
expr_stmt|;
return|return
operator|(
name|EINVAL
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * VC state machine action 1  * Setup handler called  *  * Send SETUP, start timer T303, go to UNI_CALL_INITIATED state  *  * Arguments:  *	usp	pointer to protocol instance block  *	uvp	pointer to the VCCB for the affected connection  *	msg	pointer to a UNISIG message structure  *  * Returns:  *	0	success  *	errno	error encountered  *  */
end_comment

begin_function
specifier|static
name|int
name|unisig_vc_act01
parameter_list|(
name|usp
parameter_list|,
name|uvp
parameter_list|,
name|msg
parameter_list|)
name|struct
name|unisig
modifier|*
name|usp
decl_stmt|;
name|struct
name|unisig_vccb
modifier|*
name|uvp
decl_stmt|;
name|struct
name|unisig_msg
modifier|*
name|msg
decl_stmt|;
block|{
name|int
name|rc
decl_stmt|;
comment|/* 	 * Send the setup message 	 */
name|rc
operator|=
name|unisig_send_setup
argument_list|(
name|usp
argument_list|,
name|uvp
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
condition|)
return|return
operator|(
name|rc
operator|)
return|;
comment|/* 	 * Set timer T303 	 */
name|uvp
operator|->
name|uv_retry
operator|=
literal|0
expr_stmt|;
name|UNISIG_VC_TIMER
argument_list|(
operator|(
expr|struct
name|vccb
operator|*
operator|)
name|uvp
argument_list|,
name|UNI_T303
argument_list|)
expr_stmt|;
comment|/* 	 * Set the new state 	 */
name|uvp
operator|->
name|uv_sstate
operator|=
name|UNI_CALL_INITIATED
expr_stmt|;
comment|/* 	 * Mark the time 	 */
name|uvp
operator|->
name|uv_tstamp
operator|=
name|time_second
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * VC state machine action 2  * Timeout while waiting for CALL PROCEEDING or CONNECT  *  * If this is the second expiration, clear the call.  Otherwise,  * retransmit the SETUP message and restart T303.  *  * Arguments:  *	usp	pointer to protocol instance block  *	uvp	pointer to the VCCB for the affected connection  *	msg	pointer to a UNISIG message structure  *  * Returns:  *	0	success  *	errno	error encountered  *  */
end_comment

begin_function
specifier|static
name|int
name|unisig_vc_act02
parameter_list|(
name|usp
parameter_list|,
name|uvp
parameter_list|,
name|msg
parameter_list|)
name|struct
name|unisig
modifier|*
name|usp
decl_stmt|;
name|struct
name|unisig_vccb
modifier|*
name|uvp
decl_stmt|;
name|struct
name|unisig_msg
modifier|*
name|msg
decl_stmt|;
block|{
name|int
name|rc
init|=
literal|0
decl_stmt|;
if|if
condition|(
name|uvp
operator|->
name|uv_retry
condition|)
block|{
comment|/* 		 * Clear the call 		 */
name|rc
operator|=
name|unisig_clear_vcc
argument_list|(
name|usp
argument_list|,
name|uvp
argument_list|,
name|T_ATM_CAUSE_NO_ROUTE_TO_DESTINATION
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|uvp
operator|->
name|uv_retry
operator|++
expr_stmt|;
operator|(
name|void
operator|)
name|unisig_send_setup
argument_list|(
name|usp
argument_list|,
name|uvp
argument_list|)
expr_stmt|;
name|UNISIG_VC_TIMER
argument_list|(
operator|(
expr|struct
name|vccb
operator|*
operator|)
name|uvp
argument_list|,
name|UNI_T303
argument_list|)
expr_stmt|;
block|}
return|return
operator|(
name|rc
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * VC state machine action 3  *  * Clear the call internally  *  * Arguments:  *	usp	pointer to protocol instance block  *	uvp	pointer to the VCCB for the affected connection  *	msg	pointer to a UNISIG message structure  *  * Returns:  *	0	success  *	errno	error encountered  *  */
end_comment

begin_function
specifier|static
name|int
name|unisig_vc_act03
parameter_list|(
name|usp
parameter_list|,
name|uvp
parameter_list|,
name|msg
parameter_list|)
name|struct
name|unisig
modifier|*
name|usp
decl_stmt|;
name|struct
name|unisig_vccb
modifier|*
name|uvp
decl_stmt|;
name|struct
name|unisig_msg
modifier|*
name|msg
decl_stmt|;
block|{
name|int
name|rc
decl_stmt|,
name|cause
decl_stmt|;
comment|/* 	 * Set cause code 	 */
if|if
condition|(
operator|(
name|msg
operator|!=
name|NULL
operator|)
operator|&&
operator|(
name|msg
operator|->
name|msg_ie_caus
operator|!=
name|NULL
operator|)
condition|)
block|{
name|unisig_cause_attr_from_ie
argument_list|(
operator|&
name|uvp
operator|->
name|uv_connvc
operator|->
name|cvc_attr
argument_list|,
name|msg
operator|->
name|msg_ie_caus
argument_list|)
expr_stmt|;
name|cause
operator|=
name|T_ATM_ABSENT
expr_stmt|;
block|}
else|else
name|cause
operator|=
name|T_ATM_CAUSE_DESTINATION_OUT_OF_ORDER
expr_stmt|;
comment|/* 	 * Clear the VCCB 	 */
name|rc
operator|=
name|unisig_clear_vcc
argument_list|(
name|usp
argument_list|,
name|uvp
argument_list|,
name|cause
argument_list|)
expr_stmt|;
return|return
operator|(
name|rc
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * VC state machine action 4  * Received CALL PROCEEDING  *  * Start timer T310, go to UNI_CALL_OUT_PROC  *  * Arguments:  *	usp	pointer to protocol instance block  *	uvp	pointer to the VCCB for the affected connection  *	msg	pointer to a UNISIG message structure  *  * Returns:  *	0	success  *	errno	error encountered  *  */
end_comment

begin_function
specifier|static
name|int
name|unisig_vc_act04
parameter_list|(
name|usp
parameter_list|,
name|uvp
parameter_list|,
name|msg
parameter_list|)
name|struct
name|unisig
modifier|*
name|usp
decl_stmt|;
name|struct
name|unisig_vccb
modifier|*
name|uvp
decl_stmt|;
name|struct
name|unisig_msg
modifier|*
name|msg
decl_stmt|;
block|{
name|int
name|cause
decl_stmt|,
name|rc
decl_stmt|,
name|vpi
decl_stmt|,
name|vci
decl_stmt|;
name|struct
name|atm_pif
modifier|*
name|pip
init|=
name|usp
operator|->
name|us_pif
decl_stmt|;
name|struct
name|ie_generic
modifier|*
name|iep
decl_stmt|;
comment|/* 	 * Clear any running timer 	 */
name|UNISIG_VC_CANCEL
argument_list|(
operator|(
expr|struct
name|vccb
operator|*
operator|)
name|uvp
argument_list|)
expr_stmt|;
comment|/* 	 * Make sure a Connection ID is part of the message 	 */
if|if
condition|(
name|msg
operator|->
name|msg_ie_cnid
condition|)
block|{
name|vpi
operator|=
name|msg
operator|->
name|msg_ie_cnid
operator|->
name|ie_cnid_vpci
expr_stmt|;
name|vci
operator|=
name|msg
operator|->
name|msg_ie_cnid
operator|->
name|ie_cnid_vci
expr_stmt|;
block|}
else|else
block|{
name|iep
operator|=
name|uma_zalloc
argument_list|(
name|unisig_ie_zone
argument_list|,
name|M_WAITOK
argument_list|)
expr_stmt|;
if|if
condition|(
name|iep
operator|==
name|NULL
condition|)
return|return
operator|(
name|ENOMEM
operator|)
return|;
name|iep
operator|->
name|ie_ident
operator|=
name|UNI_IE_CNID
expr_stmt|;
name|iep
operator|->
name|ie_err_cause
operator|=
name|UNI_IE_CAUS_MISSING
expr_stmt|;
name|MSG_IE_ADD
argument_list|(
name|msg
argument_list|,
name|iep
argument_list|,
name|UNI_MSG_IE_ERR
argument_list|)
expr_stmt|;
name|cause
operator|=
name|UNI_IE_CAUS_MISSING
expr_stmt|;
name|ATM_DEBUG0
argument_list|(
literal|"unisig_vc_act04: no CNID in Call Proc\n"
argument_list|)
expr_stmt|;
goto|goto
name|response04
goto|;
block|}
comment|/* 	 * Make sure we can handle the specified VPI and VCI 	 */
if|if
condition|(
name|vpi
operator|>
name|pip
operator|->
name|pif_maxvpi
operator|||
name|vci
operator|>
name|pip
operator|->
name|pif_maxvci
operator|||
name|vci
operator|<
name|UNI_IE_CNID_MIN_VCI
condition|)
block|{
name|cause
operator|=
name|UNI_IE_CAUS_BAD_VCC
expr_stmt|;
name|ATM_DEBUG0
argument_list|(
literal|"unisig_vc_act04: VPI/VCI invalid\n"
argument_list|)
expr_stmt|;
goto|goto
name|response04
goto|;
block|}
comment|/* 	 * Make sure the specified VPI and VCI are not in use 	 */
if|if
condition|(
name|unisig_find_vpvc
argument_list|(
name|usp
argument_list|,
name|vpi
argument_list|,
name|vci
argument_list|,
name|VCC_OUT
argument_list|)
condition|)
block|{
name|cause
operator|=
name|UNI_IE_CAUS_NA_VCC
expr_stmt|;
name|ATM_DEBUG0
argument_list|(
literal|"unisig_vc_act04: VPI/VCI in use\n"
argument_list|)
expr_stmt|;
goto|goto
name|response04
goto|;
block|}
comment|/* 	 * Start timer T310 	 */
name|UNISIG_VC_TIMER
argument_list|(
operator|(
expr|struct
name|vccb
operator|*
operator|)
name|uvp
argument_list|,
name|UNI_T310
argument_list|)
expr_stmt|;
comment|/* 	 * Save the specified VPI and VCI 	 */
name|uvp
operator|->
name|uv_vpi
operator|=
name|vpi
expr_stmt|;
name|uvp
operator|->
name|uv_vci
operator|=
name|vci
expr_stmt|;
comment|/* 	 * Set the state 	 */
name|uvp
operator|->
name|uv_sstate
operator|=
name|UNI_CALL_OUT_PROC
expr_stmt|;
comment|/* 	 * Mark the time 	 */
name|uvp
operator|->
name|uv_tstamp
operator|=
name|time_second
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
name|response04
label|:
comment|/* 	 * Initiate call clearing 	 */
name|rc
operator|=
name|unisig_vc_clear_call
argument_list|(
name|usp
argument_list|,
name|uvp
argument_list|,
name|msg
argument_list|,
name|cause
argument_list|)
expr_stmt|;
return|return
operator|(
name|rc
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * VC state machine action 5  * Timeout in UNI_CALL_OUT_PROC  *   * Clear call towards network  *  * Arguments:  *	usp	pointer to protocol instance block  *	uvp	pointer to the VCCB for the affected connection  *	msg	pointer to a UNISIG message structure  *  * Returns:  *	0	success  *	errno	error encountered  *  */
end_comment

begin_function
specifier|static
name|int
name|unisig_vc_act05
parameter_list|(
name|usp
parameter_list|,
name|uvp
parameter_list|,
name|msg
parameter_list|)
name|struct
name|unisig
modifier|*
name|usp
decl_stmt|;
name|struct
name|unisig_vccb
modifier|*
name|uvp
decl_stmt|;
name|struct
name|unisig_msg
modifier|*
name|msg
decl_stmt|;
block|{
name|int
name|rc
decl_stmt|;
name|struct
name|unisig_msg
modifier|*
name|rls_msg
decl_stmt|;
name|struct
name|ie_generic
modifier|*
name|cause_ie
decl_stmt|;
comment|/* 	 * Send a RELEASE message 	 */
name|rls_msg
operator|=
name|uma_zalloc
argument_list|(
name|unisig_msg_zone
argument_list|,
name|M_WAITOK
operator||
name|M_ZERO
argument_list|)
expr_stmt|;
if|if
condition|(
name|rls_msg
operator|==
name|NULL
condition|)
return|return
operator|(
name|ENOMEM
operator|)
return|;
name|cause_ie
operator|=
name|uma_zalloc
argument_list|(
name|unisig_ie_zone
argument_list|,
name|M_WAITOK
operator||
name|M_ZERO
argument_list|)
expr_stmt|;
if|if
condition|(
name|cause_ie
operator|==
name|NULL
condition|)
block|{
name|uma_zfree
argument_list|(
name|unisig_msg_zone
argument_list|,
name|rls_msg
argument_list|)
expr_stmt|;
return|return
operator|(
name|ENOMEM
operator|)
return|;
block|}
comment|/* 	 * Fill out the RELEASE message 	 */
name|rls_msg
operator|->
name|msg_call_ref
operator|=
name|uvp
operator|->
name|uv_call_ref
expr_stmt|;
name|rls_msg
operator|->
name|msg_type
operator|=
name|UNI_MSG_RLSE
expr_stmt|;
name|rls_msg
operator|->
name|msg_type_flag
operator|=
literal|0
expr_stmt|;
name|rls_msg
operator|->
name|msg_type_action
operator|=
literal|0
expr_stmt|;
name|rls_msg
operator|->
name|msg_ie_caus
operator|=
name|cause_ie
expr_stmt|;
comment|/* 	 * Fill out the cause IE 	 */
name|cause_ie
operator|->
name|ie_caus_loc
operator|=
name|UNI_IE_CAUS_LOC_USER
expr_stmt|;
name|cause_ie
operator|->
name|ie_caus_cause
operator|=
name|UNI_IE_CAUS_TIMER
expr_stmt|;
name|bcopy
argument_list|(
literal|"310"
argument_list|,
name|cause_ie
operator|->
name|ie_caus_diagnostic
argument_list|,
literal|3
argument_list|)
expr_stmt|;
comment|/* 	 * Send the RELEASE message. 	 */
name|rc
operator|=
name|unisig_send_msg
argument_list|(
name|usp
argument_list|,
name|rls_msg
argument_list|)
expr_stmt|;
name|unisig_free_msg
argument_list|(
name|rls_msg
argument_list|)
expr_stmt|;
comment|/* 	 * Start timer T308 	 */
name|UNISIG_VC_TIMER
argument_list|(
operator|(
expr|struct
name|vccb
operator|*
operator|)
name|uvp
argument_list|,
name|UNI_T308
argument_list|)
expr_stmt|;
comment|/* 	 * Set the new state 	 */
name|uvp
operator|->
name|uv_sstate
operator|=
name|UNI_RELEASE_REQUEST
expr_stmt|;
name|uvp
operator|->
name|uv_ustate
operator|=
name|VCCU_CLOSED
expr_stmt|;
comment|/* 	 * Mark the time 	 */
name|uvp
operator|->
name|uv_tstamp
operator|=
name|time_second
expr_stmt|;
return|return
operator|(
name|rc
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * VC state machine action 6  * Received CONNECT  *  * Send CONNECT ACK, go to UNI_ACTIVE state  *  * Arguments:  *	usp	pointer to protocol instance block  *	uvp	pointer to the VCCB for the affected connection  *	msg	pointer to a UNISIG message structure  *  * Returns:  *	0	success  *	errno	error encountered  *  */
end_comment

begin_function
specifier|static
name|int
name|unisig_vc_act06
parameter_list|(
name|usp
parameter_list|,
name|uvp
parameter_list|,
name|msg
parameter_list|)
name|struct
name|unisig
modifier|*
name|usp
decl_stmt|;
name|struct
name|unisig_vccb
modifier|*
name|uvp
decl_stmt|;
name|struct
name|unisig_msg
modifier|*
name|msg
decl_stmt|;
block|{
name|int
name|cause
decl_stmt|,
name|rc
decl_stmt|,
name|vci
decl_stmt|,
name|vpi
decl_stmt|;
name|struct
name|atm_pif
modifier|*
name|pip
init|=
name|usp
operator|->
name|us_pif
decl_stmt|;
name|struct
name|unisig_msg
modifier|*
name|cack_msg
decl_stmt|;
name|struct
name|ie_generic
modifier|*
name|iep
decl_stmt|;
name|Atm_attributes
modifier|*
name|ap
decl_stmt|;
comment|/* 	 * Clear any running timer 	 */
name|UNISIG_VC_CANCEL
argument_list|(
operator|(
expr|struct
name|vccb
operator|*
operator|)
name|uvp
argument_list|)
expr_stmt|;
name|ap
operator|=
operator|&
name|uvp
operator|->
name|uv_connvc
operator|->
name|cvc_attr
expr_stmt|;
comment|/* 	 * See if a VPI/VCI is specified 	 */
if|if
condition|(
name|msg
operator|->
name|msg_ie_cnid
condition|)
block|{
comment|/* 		 * Yes--VPI/VCI must be the first specification or must 		 * match what was specified before 		 */
name|vpi
operator|=
name|msg
operator|->
name|msg_ie_cnid
operator|->
name|ie_cnid_vpci
expr_stmt|;
name|vci
operator|=
name|msg
operator|->
name|msg_ie_cnid
operator|->
name|ie_cnid_vci
expr_stmt|;
if|if
condition|(
operator|(
name|uvp
operator|->
name|uv_vpi
operator|||
name|uvp
operator|->
name|uv_vci
operator|)
operator|&&
operator|(
name|vpi
operator|!=
name|uvp
operator|->
name|uv_vpi
operator|||
name|vci
operator|!=
name|uvp
operator|->
name|uv_vci
operator|)
condition|)
block|{
name|cause
operator|=
name|UNI_IE_CAUS_BAD_VCC
expr_stmt|;
name|ATM_DEBUG0
argument_list|(
literal|"unisig_vc_act06: VPI/VCI invalid\n"
argument_list|)
expr_stmt|;
goto|goto
name|response06
goto|;
block|}
comment|/* 		 * Specified VPI/VCI must be within range 		 */
if|if
condition|(
name|vpi
operator|>
name|pip
operator|->
name|pif_maxvpi
operator|||
name|vci
operator|>
name|pip
operator|->
name|pif_maxvci
operator|||
name|vci
operator|<
name|UNI_IE_CNID_MIN_VCI
condition|)
block|{
name|cause
operator|=
name|UNI_IE_CAUS_BAD_VCC
expr_stmt|;
name|ATM_DEBUG0
argument_list|(
literal|"unisig_vc_act06: VPI/VCI invalid\n"
argument_list|)
expr_stmt|;
goto|goto
name|response06
goto|;
block|}
name|uvp
operator|->
name|uv_vpi
operator|=
name|vpi
expr_stmt|;
name|uvp
operator|->
name|uv_vci
operator|=
name|vci
expr_stmt|;
block|}
else|else
block|{
comment|/* 		 * No--VCI must have been specified earlier 		 * May be called from netisr - don't wait. 		 */
if|if
condition|(
operator|!
name|uvp
operator|->
name|uv_vci
condition|)
block|{
name|iep
operator|=
name|uma_zalloc
argument_list|(
name|unisig_ie_zone
argument_list|,
name|M_NOWAIT
argument_list|)
expr_stmt|;
if|if
condition|(
name|iep
operator|==
name|NULL
condition|)
return|return
operator|(
name|ENOMEM
operator|)
return|;
name|iep
operator|->
name|ie_ident
operator|=
name|UNI_IE_CNID
expr_stmt|;
name|iep
operator|->
name|ie_err_cause
operator|=
name|UNI_IE_CAUS_MISSING
expr_stmt|;
name|MSG_IE_ADD
argument_list|(
name|msg
argument_list|,
name|iep
argument_list|,
name|UNI_MSG_IE_ERR
argument_list|)
expr_stmt|;
name|cause
operator|=
name|UNI_IE_CAUS_MISSING
expr_stmt|;
name|ATM_DEBUG0
argument_list|(
literal|"unisig_vc_act06: CNID missing\n"
argument_list|)
expr_stmt|;
goto|goto
name|response06
goto|;
block|}
block|}
comment|/* 	 * Handle AAL parameters negotiation 	 */
if|if
condition|(
name|msg
operator|->
name|msg_ie_aalp
condition|)
block|{
name|struct
name|ie_generic
modifier|*
name|aalp
init|=
name|msg
operator|->
name|msg_ie_aalp
decl_stmt|;
comment|/* 		 * AAL parameters must have been sent in SETUP 		 */
if|if
condition|(
operator|(
name|ap
operator|->
name|aal
operator|.
name|tag
operator|!=
name|T_ATM_PRESENT
operator|)
operator|||
operator|(
name|ap
operator|->
name|aal
operator|.
name|type
operator|!=
name|aalp
operator|->
name|ie_aalp_aal_type
operator|)
condition|)
block|{
name|cause
operator|=
name|UNI_IE_CAUS_IECONTENT
expr_stmt|;
goto|goto
name|response06
goto|;
block|}
switch|switch
condition|(
name|aalp
operator|->
name|ie_aalp_aal_type
condition|)
block|{
case|case
name|UNI_IE_AALP_AT_AAL3
case|:
comment|/* 			 * Maximum SDU size negotiation 			 */
if|if
condition|(
name|aalp
operator|->
name|ie_aalp_4_fwd_max_sdu
operator|==
name|T_ATM_ABSENT
condition|)
break|break;
if|if
condition|(
operator|(
name|ap
operator|->
name|aal
operator|.
name|v
operator|.
name|aal4
operator|.
name|forward_max_SDU_size
operator|<
name|aalp
operator|->
name|ie_aalp_4_fwd_max_sdu
operator|)
operator|||
operator|(
name|ap
operator|->
name|aal
operator|.
name|v
operator|.
name|aal4
operator|.
name|backward_max_SDU_size
operator|<
name|aalp
operator|->
name|ie_aalp_4_bkwd_max_sdu
operator|)
condition|)
block|{
name|cause
operator|=
name|UNI_IE_CAUS_IECONTENT
expr_stmt|;
goto|goto
name|response06
goto|;
block|}
else|else
block|{
name|ap
operator|->
name|aal
operator|.
name|v
operator|.
name|aal4
operator|.
name|forward_max_SDU_size
operator|=
name|aalp
operator|->
name|ie_aalp_4_fwd_max_sdu
expr_stmt|;
name|ap
operator|->
name|aal
operator|.
name|v
operator|.
name|aal4
operator|.
name|backward_max_SDU_size
operator|=
name|aalp
operator|->
name|ie_aalp_4_bkwd_max_sdu
expr_stmt|;
block|}
break|break;
case|case
name|UNI_IE_AALP_AT_AAL5
case|:
comment|/* 			 * Maximum SDU size negotiation 			 */
if|if
condition|(
name|aalp
operator|->
name|ie_aalp_5_fwd_max_sdu
operator|==
name|T_ATM_ABSENT
condition|)
break|break;
if|if
condition|(
operator|(
name|ap
operator|->
name|aal
operator|.
name|v
operator|.
name|aal5
operator|.
name|forward_max_SDU_size
operator|<
name|aalp
operator|->
name|ie_aalp_5_fwd_max_sdu
operator|)
operator|||
operator|(
name|ap
operator|->
name|aal
operator|.
name|v
operator|.
name|aal5
operator|.
name|backward_max_SDU_size
operator|<
name|aalp
operator|->
name|ie_aalp_5_bkwd_max_sdu
operator|)
condition|)
block|{
name|cause
operator|=
name|UNI_IE_CAUS_IECONTENT
expr_stmt|;
goto|goto
name|response06
goto|;
block|}
else|else
block|{
name|ap
operator|->
name|aal
operator|.
name|v
operator|.
name|aal5
operator|.
name|forward_max_SDU_size
operator|=
name|aalp
operator|->
name|ie_aalp_5_fwd_max_sdu
expr_stmt|;
name|ap
operator|->
name|aal
operator|.
name|v
operator|.
name|aal5
operator|.
name|backward_max_SDU_size
operator|=
name|aalp
operator|->
name|ie_aalp_5_bkwd_max_sdu
expr_stmt|;
block|}
break|break;
block|}
block|}
comment|/* 	 * Get memory for a CONNECT ACK message 	 * May be called from netisr. 	 */
name|cack_msg
operator|=
name|uma_zalloc
argument_list|(
name|unisig_msg_zone
argument_list|,
name|M_NOWAIT
argument_list|)
expr_stmt|;
if|if
condition|(
name|cack_msg
operator|==
name|NULL
condition|)
return|return
operator|(
name|ENOMEM
operator|)
return|;
comment|/* 	 * Fill out the CONNECT ACK message 	 */
name|cack_msg
operator|->
name|msg_call_ref
operator|=
name|uvp
operator|->
name|uv_call_ref
expr_stmt|;
name|cack_msg
operator|->
name|msg_type
operator|=
name|UNI_MSG_CACK
expr_stmt|;
name|cack_msg
operator|->
name|msg_type_flag
operator|=
literal|0
expr_stmt|;
name|cack_msg
operator|->
name|msg_type_action
operator|=
literal|0
expr_stmt|;
comment|/* 	 * Send the CONNECT ACK message 	 */
name|rc
operator|=
name|unisig_send_msg
argument_list|(
name|usp
argument_list|,
name|cack_msg
argument_list|)
expr_stmt|;
name|unisig_free_msg
argument_list|(
name|cack_msg
argument_list|)
expr_stmt|;
comment|/* 	 * Set the new state 	 */
name|uvp
operator|->
name|uv_sstate
operator|=
name|UNI_ACTIVE
expr_stmt|;
name|uvp
operator|->
name|uv_ustate
operator|=
name|VCCU_OPEN
expr_stmt|;
comment|/* 	 * Mark the time 	 */
name|uvp
operator|->
name|uv_tstamp
operator|=
name|time_second
expr_stmt|;
comment|/* 	 * Notify the user that the connection is now active 	 */
name|atm_cm_connected
argument_list|(
name|uvp
operator|->
name|uv_connvc
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
name|response06
label|:
comment|/* 	 * Initiate call clearing 	 */
name|rc
operator|=
name|unisig_vc_clear_call
argument_list|(
name|usp
argument_list|,
name|uvp
argument_list|,
name|msg
argument_list|,
name|cause
argument_list|)
expr_stmt|;
return|return
operator|(
name|rc
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * VC state machine action 7  * Abort routine called or signalling SAAL session reset while in  * one of the call setup states  *  * Clear the call, send RELEASE COMPLETE, notify the user.  *  * Arguments:  *	usp	pointer to protocol instance block  *	uvp	pointer to the VCCB for the affected connection  *	msg	pointer to a UNISIG message structure  *  * Returns:  *	0	success  *	errno	error encountered  *  */
end_comment

begin_function
specifier|static
name|int
name|unisig_vc_act07
parameter_list|(
name|usp
parameter_list|,
name|uvp
parameter_list|,
name|msg
parameter_list|)
name|struct
name|unisig
modifier|*
name|usp
decl_stmt|;
name|struct
name|unisig_vccb
modifier|*
name|uvp
decl_stmt|;
name|struct
name|unisig_msg
modifier|*
name|msg
decl_stmt|;
block|{
name|int
name|rc
decl_stmt|;
comment|/* 	 * Clear any running timer 	 */
name|UNISIG_VC_CANCEL
argument_list|(
operator|(
expr|struct
name|vccb
operator|*
operator|)
name|uvp
argument_list|)
expr_stmt|;
comment|/* 	 * Send a RELEASE COMPLETE message rejecting the connection 	 */
name|rc
operator|=
name|unisig_send_release_complete
argument_list|(
name|usp
argument_list|,
name|uvp
argument_list|,
name|msg
argument_list|,
name|UNI_IE_CAUS_TEMP
argument_list|)
expr_stmt|;
comment|/* 	 * Clear the call VCCB 	 */
name|uvp
operator|->
name|uv_sstate
operator|=
name|UNI_FREE
expr_stmt|;
name|uvp
operator|->
name|uv_ustate
operator|=
name|VCCU_CLOSED
expr_stmt|;
comment|/* 	 * Mark the time 	 */
name|uvp
operator|->
name|uv_tstamp
operator|=
name|time_second
expr_stmt|;
comment|/* 	 * Notify the user 	 */
if|if
condition|(
operator|(
name|msg
operator|!=
name|NULL
operator|)
operator|&&
operator|(
name|msg
operator|->
name|msg_ie_caus
operator|!=
name|NULL
operator|)
condition|)
name|unisig_cause_attr_from_ie
argument_list|(
operator|&
name|uvp
operator|->
name|uv_connvc
operator|->
name|cvc_attr
argument_list|,
name|msg
operator|->
name|msg_ie_caus
argument_list|)
expr_stmt|;
else|else
name|unisig_cause_attr_from_user
argument_list|(
operator|&
name|uvp
operator|->
name|uv_connvc
operator|->
name|cvc_attr
argument_list|,
name|T_ATM_CAUSE_NORMAL_CALL_CLEARING
argument_list|)
expr_stmt|;
name|atm_cm_cleared
argument_list|(
name|uvp
operator|->
name|uv_connvc
argument_list|)
expr_stmt|;
return|return
operator|(
name|rc
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * VC state machine action 8  * Received SETUP  *  * Check call paramaters, notify user that a call has been received,  * set UNI_CALL_PRESENT state  *  * Arguments:  *	usp	pointer to protocol instance block  *	uvp	pointer to the VCCB for the affected connection  *	msg	pointer to a UNISIG message structure  *  * Returns:  *	0	success  *	errno	error encountered  *  */
end_comment

begin_function
specifier|static
name|int
name|unisig_vc_act08
parameter_list|(
name|usp
parameter_list|,
name|uvp
parameter_list|,
name|msg
parameter_list|)
name|struct
name|unisig
modifier|*
name|usp
decl_stmt|;
name|struct
name|unisig_vccb
modifier|*
name|uvp
decl_stmt|;
name|struct
name|unisig_msg
modifier|*
name|msg
decl_stmt|;
block|{
name|int
name|cause
init|=
literal|0
decl_stmt|,
name|rc
decl_stmt|,
name|vpi
decl_stmt|,
name|vci
decl_stmt|;
name|struct
name|atm_pif
modifier|*
name|pip
init|=
name|usp
operator|->
name|us_pif
decl_stmt|;
name|struct
name|atm_nif
modifier|*
name|nip
decl_stmt|;
name|Atm_addr_nsap
modifier|*
name|nap
decl_stmt|;
name|Atm_attributes
name|attr
decl_stmt|;
name|ATM_DEBUG3
argument_list|(
literal|"unisig_vc_act08: usp=%p, uvp=%p, msg=%p\n"
argument_list|,
name|usp
argument_list|,
name|uvp
argument_list|,
name|msg
argument_list|)
expr_stmt|;
comment|/* 	 * Make sure that the called address is the right format 	 */
if|if
condition|(
name|msg
operator|->
name|msg_ie_cdad
operator|->
name|ie_cdad_plan
operator|!=
name|UNI_IE_CDAD_PLAN_NSAP
condition|)
block|{
name|cause
operator|=
name|UNI_IE_CAUS_IECONTENT
expr_stmt|;
name|ATM_DEBUG0
argument_list|(
literal|"unisig_vc_act08: bad address format\n"
argument_list|)
expr_stmt|;
goto|goto
name|response08
goto|;
block|}
comment|/* 	 * Make sure that the called address is ours 	 */
name|nap
operator|=
operator|(
name|Atm_addr_nsap
operator|*
operator|)
name|msg
operator|->
name|msg_ie_cdad
operator|->
name|ie_cdad_addr
operator|.
name|address
expr_stmt|;
if|if
condition|(
name|bcmp
argument_list|(
name|usp
operator|->
name|us_addr
operator|.
name|address
argument_list|,
name|nap
argument_list|,
comment|/* XXX */
sizeof|sizeof
argument_list|(
name|Atm_addr_nsap
argument_list|)
operator|-
literal|1
argument_list|)
condition|)
block|{
name|cause
operator|=
name|UNI_IE_CAUS_IECONTENT
expr_stmt|;
name|ATM_DEBUG0
argument_list|(
literal|"unisig_vc_act08: address not mine\n"
argument_list|)
expr_stmt|;
goto|goto
name|response08
goto|;
block|}
comment|/* 	 * Find the right NIF for the given selector byte 	 */
name|nip
operator|=
name|pip
operator|->
name|pif_nif
expr_stmt|;
while|while
condition|(
name|nip
operator|&&
name|nip
operator|->
name|nif_sel
operator|!=
name|nap
operator|->
name|aan_sel
condition|)
block|{
name|nip
operator|=
name|nip
operator|->
name|nif_pnext
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|nip
condition|)
block|{
name|cause
operator|=
name|UNI_IE_CAUS_IECONTENT
expr_stmt|;
name|ATM_DEBUG0
argument_list|(
literal|"unisig_vc_act08: bad selector byte\n"
argument_list|)
expr_stmt|;
goto|goto
name|response08
goto|;
block|}
comment|/* 	 * See if we recognize the specified AAL 	 */
if|if
condition|(
name|msg
operator|->
name|msg_ie_aalp
operator|->
name|ie_aalp_aal_type
operator|!=
name|UNI_IE_AALP_AT_AAL3
operator|&&
name|msg
operator|->
name|msg_ie_aalp
operator|->
name|ie_aalp_aal_type
operator|!=
name|UNI_IE_AALP_AT_AAL5
condition|)
block|{
name|cause
operator|=
name|UNI_IE_CAUS_UAAL
expr_stmt|;
name|ATM_DEBUG0
argument_list|(
literal|"unisig_vc_act08: bad AAL\n"
argument_list|)
expr_stmt|;
goto|goto
name|response08
goto|;
block|}
comment|/* 	 * Should verify that we can handle requested 	 * connection QOS 	 */
comment|/* 	 * Make sure the specified VPI/VCI is valid 	 */
name|vpi
operator|=
name|msg
operator|->
name|msg_ie_cnid
operator|->
name|ie_cnid_vpci
expr_stmt|;
name|vci
operator|=
name|msg
operator|->
name|msg_ie_cnid
operator|->
name|ie_cnid_vci
expr_stmt|;
if|if
condition|(
name|vpi
operator|>
name|pip
operator|->
name|pif_maxvpi
operator|||
name|vci
operator|>
name|pip
operator|->
name|pif_maxvci
operator|||
name|vci
operator|<
name|UNI_IE_CNID_MIN_VCI
condition|)
block|{
name|cause
operator|=
name|UNI_IE_CAUS_BAD_VCC
expr_stmt|;
name|ATM_DEBUG0
argument_list|(
literal|"unisig_vc_act08: VPI/VCI invalid\n"
argument_list|)
expr_stmt|;
goto|goto
name|response08
goto|;
block|}
comment|/* 	 * Make sure the specified VPI/VCI isn't in use already 	 */
if|if
condition|(
name|unisig_find_vpvc
argument_list|(
name|usp
argument_list|,
name|vpi
argument_list|,
name|vci
argument_list|,
name|VCC_IN
argument_list|)
condition|)
block|{
name|cause
operator|=
name|UNI_IE_CAUS_NA_VCC
expr_stmt|;
name|ATM_DEBUG0
argument_list|(
literal|"unisig_vc_act08: VPI/VCI in use\n"
argument_list|)
expr_stmt|;
goto|goto
name|response08
goto|;
block|}
comment|/* 	 * Make sure it's a point-to-point connection 	 */
if|if
condition|(
name|msg
operator|->
name|msg_ie_bbcp
operator|->
name|ie_bbcp_conn_config
operator|!=
name|UNI_IE_BBCP_CC_PP
condition|)
block|{
name|cause
operator|=
name|UNI_IE_CAUS_NI_BC
expr_stmt|;
name|ATM_DEBUG0
argument_list|(
literal|"unisig_vc_act08: conn not pt-pt\n"
argument_list|)
expr_stmt|;
goto|goto
name|response08
goto|;
block|}
comment|/* 	 * Fill in the VCCB fields that we can at this point 	 */
name|uvp
operator|->
name|uv_type
operator|=
name|VCC_SVC
operator||
name|VCC_IN
operator||
name|VCC_OUT
expr_stmt|;
name|uvp
operator|->
name|uv_proto
operator|=
name|pip
operator|->
name|pif_sigmgr
operator|->
name|sm_proto
expr_stmt|;
name|uvp
operator|->
name|uv_sstate
operator|=
name|UNI_CALL_PRESENT
expr_stmt|;
name|uvp
operator|->
name|uv_ustate
operator|=
name|VCCU_POPEN
expr_stmt|;
name|uvp
operator|->
name|uv_pif
operator|=
name|pip
expr_stmt|;
name|uvp
operator|->
name|uv_nif
operator|=
name|nip
expr_stmt|;
name|uvp
operator|->
name|uv_vpi
operator|=
name|msg
operator|->
name|msg_ie_cnid
operator|->
name|ie_cnid_vpci
expr_stmt|;
name|uvp
operator|->
name|uv_vci
operator|=
name|msg
operator|->
name|msg_ie_cnid
operator|->
name|ie_cnid_vci
expr_stmt|;
name|uvp
operator|->
name|uv_tstamp
operator|=
name|time_second
expr_stmt|;
comment|/* 	 * Copy the connection attributes from the SETUP message 	 * to an attribute block 	 */
name|bzero
argument_list|(
operator|&
name|attr
argument_list|,
sizeof|sizeof
argument_list|(
name|attr
argument_list|)
argument_list|)
expr_stmt|;
name|attr
operator|.
name|nif
operator|=
name|nip
expr_stmt|;
name|attr
operator|.
name|aal
operator|.
name|tag
operator|=
name|T_ATM_ABSENT
expr_stmt|;
name|attr
operator|.
name|traffic
operator|.
name|tag
operator|=
name|T_ATM_ABSENT
expr_stmt|;
name|attr
operator|.
name|bearer
operator|.
name|tag
operator|=
name|T_ATM_ABSENT
expr_stmt|;
name|attr
operator|.
name|bhli
operator|.
name|tag
operator|=
name|T_ATM_ABSENT
expr_stmt|;
name|attr
operator|.
name|blli
operator|.
name|tag_l2
operator|=
name|T_ATM_ABSENT
expr_stmt|;
name|attr
operator|.
name|blli
operator|.
name|tag_l3
operator|=
name|T_ATM_ABSENT
expr_stmt|;
name|attr
operator|.
name|llc
operator|.
name|tag
operator|=
name|T_ATM_ABSENT
expr_stmt|;
name|attr
operator|.
name|called
operator|.
name|tag
operator|=
name|T_ATM_ABSENT
expr_stmt|;
name|attr
operator|.
name|calling
operator|.
name|tag
operator|=
name|T_ATM_ABSENT
expr_stmt|;
name|attr
operator|.
name|qos
operator|.
name|tag
operator|=
name|T_ATM_ABSENT
expr_stmt|;
name|attr
operator|.
name|transit
operator|.
name|tag
operator|=
name|T_ATM_ABSENT
expr_stmt|;
name|attr
operator|.
name|cause
operator|.
name|tag
operator|=
name|T_ATM_ABSENT
expr_stmt|;
name|unisig_save_attrs
argument_list|(
name|usp
argument_list|,
name|msg
argument_list|,
operator|&
name|attr
argument_list|)
expr_stmt|;
comment|/* 	 * Notify the connection manager of the new VCC 	 */
name|ATM_DEBUG0
argument_list|(
literal|"unisig_vc_act08: notifying user of connection\n"
argument_list|)
expr_stmt|;
name|rc
operator|=
name|atm_cm_incoming
argument_list|(
operator|(
expr|struct
name|vccb
operator|*
operator|)
name|uvp
argument_list|,
operator|&
name|attr
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
condition|)
goto|goto
name|response08
goto|;
comment|/* 	 * Wait for the connection recipient to issue an accept 	 * or reject 	 */
return|return
operator|(
literal|0
operator|)
return|;
name|response08
label|:
name|ATM_DEBUG1
argument_list|(
literal|"unisig_vc_act08: reject with cause=%d\n"
argument_list|,
name|cause
argument_list|)
expr_stmt|;
comment|/* 	 * Clear the VCCB state 	 */
name|uvp
operator|->
name|uv_sstate
operator|=
name|UNI_NULL
expr_stmt|;
comment|/* 	 * Mark the time 	 */
name|uvp
operator|->
name|uv_tstamp
operator|=
name|time_second
expr_stmt|;
comment|/* 	 * Some problem was detected with the request.  Send a Q.2931 	 * message rejecting the connection. 	 */
name|rc
operator|=
name|unisig_send_release_complete
argument_list|(
name|usp
argument_list|,
name|uvp
argument_list|,
name|msg
argument_list|,
name|cause
argument_list|)
expr_stmt|;
return|return
operator|(
name|rc
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * VC state machine action 9  * Accept routine called by user  *  * Send CONNECT, start timer T313, go to UNI_CONNECT_REQUEST state  *  * Arguments:  *	usp	pointer to protocol instance block  *	uvp	pointer to the VCCB for the affected connection  *	msg	pointer to a UNISIG message structure  *  * Returns:  *	0	success  *	errno	error encountered  *  */
end_comment

begin_function
specifier|static
name|int
name|unisig_vc_act09
parameter_list|(
name|usp
parameter_list|,
name|uvp
parameter_list|,
name|msg
parameter_list|)
name|struct
name|unisig
modifier|*
name|usp
decl_stmt|;
name|struct
name|unisig_vccb
modifier|*
name|uvp
decl_stmt|;
name|struct
name|unisig_msg
modifier|*
name|msg
decl_stmt|;
block|{
name|int
name|rc
decl_stmt|;
name|struct
name|unisig_msg
modifier|*
name|conn_msg
decl_stmt|;
comment|/* may be called from timeout - don't wait */
name|conn_msg
operator|=
name|uma_zalloc
argument_list|(
name|unisig_msg_zone
argument_list|,
name|M_NOWAIT
argument_list|)
expr_stmt|;
if|if
condition|(
name|conn_msg
operator|==
name|NULL
condition|)
return|return
operator|(
name|ENOMEM
operator|)
return|;
comment|/* 	 * Fill out the response 	 */
name|conn_msg
operator|->
name|msg_call_ref
operator|=
name|uvp
operator|->
name|uv_call_ref
expr_stmt|;
name|conn_msg
operator|->
name|msg_type
operator|=
name|UNI_MSG_CONN
expr_stmt|;
name|conn_msg
operator|->
name|msg_type_flag
operator|=
literal|0
expr_stmt|;
name|conn_msg
operator|->
name|msg_type_action
operator|=
literal|0
expr_stmt|;
comment|/* 	 * Send the CONNECT message.  If the send fails, the other 	 * side will eventually time out and close the connection. 	 */
name|rc
operator|=
name|unisig_send_msg
argument_list|(
name|usp
argument_list|,
name|conn_msg
argument_list|)
expr_stmt|;
name|unisig_free_msg
argument_list|(
name|conn_msg
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
condition|)
block|{
return|return
operator|(
name|rc
operator|)
return|;
block|}
comment|/* 	 * Start timer T313 	 */
name|UNISIG_VC_TIMER
argument_list|(
operator|(
expr|struct
name|vccb
operator|*
operator|)
name|uvp
argument_list|,
name|UNI_T313
argument_list|)
expr_stmt|;
comment|/* 	 * Set the new state 	 */
name|uvp
operator|->
name|uv_sstate
operator|=
name|UNI_CONNECT_REQUEST
expr_stmt|;
comment|/* 	 * Mark the time 	 */
name|uvp
operator|->
name|uv_tstamp
operator|=
name|time_second
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * VC state machine action 10  * Received CONNECT ACK  *  * Go to UNI_ACTIVE state  *  * Arguments:  *	usp	pointer to protocol instance block  *	uvp	pointer to the VCCB for the affected connection  *	msg	pointer to a UNISIG message structure  *  * Returns:  *	0	success  *	errno	error encountered  *  */
end_comment

begin_function
specifier|static
name|int
name|unisig_vc_act10
parameter_list|(
name|usp
parameter_list|,
name|uvp
parameter_list|,
name|msg
parameter_list|)
name|struct
name|unisig
modifier|*
name|usp
decl_stmt|;
name|struct
name|unisig_vccb
modifier|*
name|uvp
decl_stmt|;
name|struct
name|unisig_msg
modifier|*
name|msg
decl_stmt|;
block|{
comment|/* 	 * Clear any running timer 	 */
name|UNISIG_VC_CANCEL
argument_list|(
operator|(
expr|struct
name|vccb
operator|*
operator|)
name|uvp
argument_list|)
expr_stmt|;
comment|/* 	 * Set the state 	 */
name|uvp
operator|->
name|uv_sstate
operator|=
name|UNI_ACTIVE
expr_stmt|;
name|uvp
operator|->
name|uv_ustate
operator|=
name|VCCU_OPEN
expr_stmt|;
comment|/* 	 * Mark the time 	 */
name|uvp
operator|->
name|uv_tstamp
operator|=
name|time_second
expr_stmt|;
comment|/* 	 * Notify the user that the call is up 	 */
name|atm_cm_connected
argument_list|(
name|uvp
operator|->
name|uv_connvc
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * VC state machine action 11  * Reject handler called  *  * Send RELEASE COMPLETE, clear the call  *  * Arguments:  *	usp	pointer to protocol instance block  *	uvp	pointer to the VCCB for the affected connection  *	msg	pointer to a UNISIG message structure  *  * Returns:  *	0	success  *	errno	error encountered  *  */
end_comment

begin_function
specifier|static
name|int
name|unisig_vc_act11
parameter_list|(
name|usp
parameter_list|,
name|uvp
parameter_list|,
name|msg
parameter_list|)
name|struct
name|unisig
modifier|*
name|usp
decl_stmt|;
name|struct
name|unisig_vccb
modifier|*
name|uvp
decl_stmt|;
name|struct
name|unisig_msg
modifier|*
name|msg
decl_stmt|;
block|{
name|int
name|rc
decl_stmt|,
name|cause
decl_stmt|;
comment|/* 	 * Send generic cause code if one is not already set 	 */
if|if
condition|(
name|uvp
operator|->
name|uv_connvc
operator|->
name|cvc_attr
operator|.
name|cause
operator|.
name|tag
operator|==
name|T_ATM_PRESENT
condition|)
name|cause
operator|=
name|T_ATM_ABSENT
expr_stmt|;
else|else
name|cause
operator|=
name|T_ATM_CAUSE_CALL_REJECTED
expr_stmt|;
comment|/* 	 * Send a RELEASE COMPLETE message 	 */
name|rc
operator|=
name|unisig_send_release_complete
argument_list|(
name|usp
argument_list|,
name|uvp
argument_list|,
name|msg
argument_list|,
name|cause
argument_list|)
expr_stmt|;
comment|/* 	 * Clear the call VCCB 	 */
name|uvp
operator|->
name|uv_sstate
operator|=
name|UNI_FREE
expr_stmt|;
name|uvp
operator|->
name|uv_ustate
operator|=
name|VCCU_CLOSED
expr_stmt|;
comment|/* 	 * Mark the time 	 */
name|uvp
operator|->
name|uv_tstamp
operator|=
name|time_second
expr_stmt|;
return|return
operator|(
name|rc
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * VC state machine action 12  * Release or abort routine called  *  * Send RELEASE, start timer T308, go to UNI_RELEASE_REQUEST state  *  * Arguments:  *	usp	pointer to protocol instance block  *	uvp	pointer to the VCCB for the affected connection  *	msg	pointer to a UNISIG message structure  *  * Returns:  *	0	success  *	errno	error encountered  *  */
end_comment

begin_function
specifier|static
name|int
name|unisig_vc_act12
parameter_list|(
name|usp
parameter_list|,
name|uvp
parameter_list|,
name|msg
parameter_list|)
name|struct
name|unisig
modifier|*
name|usp
decl_stmt|;
name|struct
name|unisig_vccb
modifier|*
name|uvp
decl_stmt|;
name|struct
name|unisig_msg
modifier|*
name|msg
decl_stmt|;
block|{
name|int
name|rc
decl_stmt|;
comment|/* 	 * Clear any running timer 	 */
name|UNISIG_VC_CANCEL
argument_list|(
operator|(
expr|struct
name|vccb
operator|*
operator|)
name|uvp
argument_list|)
expr_stmt|;
comment|/* 	 * Send the RELEASE message 	 */
name|rc
operator|=
name|unisig_vc_clear_call
argument_list|(
name|usp
argument_list|,
name|uvp
argument_list|,
operator|(
expr|struct
name|unisig_msg
operator|*
operator|)
name|NULL
argument_list|,
name|T_ATM_ABSENT
argument_list|)
expr_stmt|;
return|return
operator|(
name|rc
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * VC state machine action 13  * RELEASE COMPLETE received  *  * Clear the call  *  * Arguments:  *	usp	pointer to protocol instance block  *	uvp	pointer to the VCCB for the affected connection  *	msg	pointer to a UNISIG message structure  *  * Returns:  *	0	success  *	errno	error encountered  *  */
end_comment

begin_function
specifier|static
name|int
name|unisig_vc_act13
parameter_list|(
name|usp
parameter_list|,
name|uvp
parameter_list|,
name|msg
parameter_list|)
name|struct
name|unisig
modifier|*
name|usp
decl_stmt|;
name|struct
name|unisig_vccb
modifier|*
name|uvp
decl_stmt|;
name|struct
name|unisig_msg
modifier|*
name|msg
decl_stmt|;
block|{
comment|/* 	 * Clear any running timer 	 */
name|UNISIG_VC_CANCEL
argument_list|(
operator|(
expr|struct
name|vccb
operator|*
operator|)
name|uvp
argument_list|)
expr_stmt|;
comment|/* 	 * Set the state 	 */
name|uvp
operator|->
name|uv_sstate
operator|=
name|UNI_FREE
expr_stmt|;
if|if
condition|(
name|uvp
operator|->
name|uv_ustate
operator|!=
name|VCCU_ABORT
condition|)
name|uvp
operator|->
name|uv_ustate
operator|=
name|VCCU_CLOSED
expr_stmt|;
comment|/* 	 * Mark the time 	 */
name|uvp
operator|->
name|uv_tstamp
operator|=
name|time_second
expr_stmt|;
comment|/* 	 * Notify the user that the call is now closed 	 */
if|if
condition|(
name|msg
operator|->
name|msg_ie_caus
operator|!=
name|NULL
condition|)
name|unisig_cause_attr_from_ie
argument_list|(
operator|&
name|uvp
operator|->
name|uv_connvc
operator|->
name|cvc_attr
argument_list|,
name|msg
operator|->
name|msg_ie_caus
argument_list|)
expr_stmt|;
name|atm_cm_cleared
argument_list|(
name|uvp
operator|->
name|uv_connvc
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * VC state machine action 14  * Timer expired while waiting for RELEASE COMPLETE  *  * If this is the second expiration, just clear the call.  Otherwise,  * retransmit the RELEASE message and restart timer T308.  *  * Arguments:  *	usp	pointer to protocol instance block  *	uvp	pointer to the VCCB for the affected connection  *	msg	pointer to a UNISIG message structure  *  * Returns:  *	0	success  *	errno	error encountered  *  */
end_comment

begin_function
specifier|static
name|int
name|unisig_vc_act14
parameter_list|(
name|usp
parameter_list|,
name|uvp
parameter_list|,
name|msg
parameter_list|)
name|struct
name|unisig
modifier|*
name|usp
decl_stmt|;
name|struct
name|unisig_vccb
modifier|*
name|uvp
decl_stmt|;
name|struct
name|unisig_msg
modifier|*
name|msg
decl_stmt|;
block|{
name|int
name|rc
decl_stmt|;
comment|/* 	 * Check the retry count 	 */
if|if
condition|(
name|uvp
operator|->
name|uv_retry
condition|)
block|{
comment|/* 		 * Clear the connection 		 */
name|rc
operator|=
name|unisig_clear_vcc
argument_list|(
name|usp
argument_list|,
name|uvp
argument_list|,
name|T_ATM_CAUSE_NORMAL_CALL_CLEARING
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|/* 		 * Increment the retry count 		 */
name|uvp
operator|->
name|uv_retry
operator|++
expr_stmt|;
comment|/* 		 * Resend the RELEASE message 		 */
name|rc
operator|=
name|unisig_send_release
argument_list|(
name|usp
argument_list|,
name|uvp
argument_list|,
operator|(
expr|struct
name|unisig_msg
operator|*
operator|)
literal|0
argument_list|,
name|T_ATM_ABSENT
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
condition|)
return|return
operator|(
name|rc
operator|)
return|;
comment|/* 		 * Restart timer T308 		 */
name|UNISIG_VC_TIMER
argument_list|(
operator|(
expr|struct
name|vccb
operator|*
operator|)
name|uvp
argument_list|,
name|UNI_T308
argument_list|)
expr_stmt|;
block|}
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * VC state machine action 15  * RELEASE received in UNI_ACTIVE state  *  * Send RELEASE COMPLETE, go to UNI_FREE, notify the user  *  * Arguments:  *	usp	pointer to protocol instance block  *	uvp	pointer to the VCCB for the affected connection  *	msg	pointer to a UNISIG message structure  *  * Returns:  *	0	success  *	errno	error encountered  *  */
end_comment

begin_function
specifier|static
name|int
name|unisig_vc_act15
parameter_list|(
name|usp
parameter_list|,
name|uvp
parameter_list|,
name|msg
parameter_list|)
name|struct
name|unisig
modifier|*
name|usp
decl_stmt|;
name|struct
name|unisig_vccb
modifier|*
name|uvp
decl_stmt|;
name|struct
name|unisig_msg
modifier|*
name|msg
decl_stmt|;
block|{
name|int
name|cause
decl_stmt|,
name|rc
decl_stmt|;
name|struct
name|ie_generic
modifier|*
name|iep
decl_stmt|;
comment|/* 	 * Clear any running timer 	 */
name|UNISIG_VC_CANCEL
argument_list|(
operator|(
expr|struct
name|vccb
operator|*
operator|)
name|uvp
argument_list|)
expr_stmt|;
comment|/* 	 * If there was no Cause IE, flag an error 	 */
if|if
condition|(
operator|!
name|msg
operator|->
name|msg_ie_caus
condition|)
block|{
name|cause
operator|=
name|UNI_IE_CAUS_MISSING
expr_stmt|;
for|for
control|(
name|iep
operator|=
name|msg
operator|->
name|msg_ie_err
init|;
name|iep
condition|;
name|iep
operator|=
name|iep
operator|->
name|ie_next
control|)
block|{
if|if
condition|(
name|iep
operator|->
name|ie_ident
operator|==
name|UNI_IE_CAUS
operator|&&
name|iep
operator|->
name|ie_err_cause
operator|==
name|UNI_IE_CAUS_IECONTENT
condition|)
block|{
name|cause
operator|=
name|UNI_IE_CAUS_IECONTENT
expr_stmt|;
block|}
block|}
if|if
condition|(
name|cause
operator|==
name|UNI_IE_CAUS_MISSING
condition|)
block|{
name|iep
operator|=
name|uma_zalloc
argument_list|(
name|unisig_ie_zone
argument_list|,
name|M_WAITOK
argument_list|)
expr_stmt|;
if|if
condition|(
name|iep
operator|==
name|NULL
condition|)
return|return
operator|(
name|ENOMEM
operator|)
return|;
name|iep
operator|->
name|ie_ident
operator|=
name|UNI_IE_CNID
expr_stmt|;
name|iep
operator|->
name|ie_err_cause
operator|=
name|UNI_IE_CAUS_MISSING
expr_stmt|;
name|MSG_IE_ADD
argument_list|(
name|msg
argument_list|,
name|iep
argument_list|,
name|UNI_MSG_IE_ERR
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
name|cause
operator|=
name|UNI_IE_CAUS_NORM_UNSP
expr_stmt|;
block|}
comment|/* 	 * Send a RELEASE COMPLETE message 	 */
name|rc
operator|=
name|unisig_send_release_complete
argument_list|(
name|usp
argument_list|,
name|uvp
argument_list|,
name|msg
argument_list|,
name|cause
argument_list|)
expr_stmt|;
comment|/* 	 * Set the state 	 */
name|uvp
operator|->
name|uv_sstate
operator|=
name|UNI_FREE
expr_stmt|;
name|uvp
operator|->
name|uv_ustate
operator|=
name|VCCU_CLOSED
expr_stmt|;
comment|/* 	 * Mark the time 	 */
name|uvp
operator|->
name|uv_tstamp
operator|=
name|time_second
expr_stmt|;
comment|/* 	 * Notify the user that the call is cleared 	 */
if|if
condition|(
name|msg
operator|->
name|msg_ie_caus
operator|!=
name|NULL
condition|)
name|unisig_cause_attr_from_ie
argument_list|(
operator|&
name|uvp
operator|->
name|uv_connvc
operator|->
name|cvc_attr
argument_list|,
name|msg
operator|->
name|msg_ie_caus
argument_list|)
expr_stmt|;
else|else
name|unisig_cause_attr_from_user
argument_list|(
operator|&
name|uvp
operator|->
name|uv_connvc
operator|->
name|cvc_attr
argument_list|,
name|T_ATM_CAUSE_UNSPECIFIED_NORMAL
argument_list|)
expr_stmt|;
name|atm_cm_cleared
argument_list|(
name|uvp
operator|->
name|uv_connvc
argument_list|)
expr_stmt|;
return|return
operator|(
name|rc
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * VC state machine action 16  * RELEASE received in UNI_RELEASE_REQUEST state  *  * Clear the call  *  * Arguments:  *	usp	pointer to protocol instance block  *	uvp	pointer to the VCCB for the affected connection  *	msg	pointer to a UNISIG message structure  *  * Returns:  *	0	success  *	errno	error encountered  *  */
end_comment

begin_function
specifier|static
name|int
name|unisig_vc_act16
parameter_list|(
name|usp
parameter_list|,
name|uvp
parameter_list|,
name|msg
parameter_list|)
name|struct
name|unisig
modifier|*
name|usp
decl_stmt|;
name|struct
name|unisig_vccb
modifier|*
name|uvp
decl_stmt|;
name|struct
name|unisig_msg
modifier|*
name|msg
decl_stmt|;
block|{
name|int
name|rc
decl_stmt|;
comment|/* 	 * Clear any running timer 	 */
name|UNISIG_VC_CANCEL
argument_list|(
operator|(
expr|struct
name|vccb
operator|*
operator|)
name|uvp
argument_list|)
expr_stmt|;
comment|/* 	 * Clear the VCCB 	 */
name|rc
operator|=
name|unisig_clear_vcc
argument_list|(
name|usp
argument_list|,
name|uvp
argument_list|,
name|T_ATM_ABSENT
argument_list|)
expr_stmt|;
return|return
operator|(
name|rc
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * VC state machine action 17  * Protocol error  *  * Send a STATUS message with cause 101, "message not compatible with  * call state"  *  * Arguments:  *	usp	pointer to protocol instance block  *	uvp	pointer to the VCCB for the affected connection  *	msg	pointer to a UNISIG message structure  *  * Returns:  *	0	success  *	errno	error encountered  *  */
end_comment

begin_function
specifier|static
name|int
name|unisig_vc_act17
parameter_list|(
name|usp
parameter_list|,
name|uvp
parameter_list|,
name|msg
parameter_list|)
name|struct
name|unisig
modifier|*
name|usp
decl_stmt|;
name|struct
name|unisig_vccb
modifier|*
name|uvp
decl_stmt|;
name|struct
name|unisig_msg
modifier|*
name|msg
decl_stmt|;
block|{
name|int
name|rc
decl_stmt|;
name|ATM_DEBUG3
argument_list|(
literal|"unisig_vc_perror: usp=%p, uvp=%p, msg=%p\n"
argument_list|,
name|usp
argument_list|,
name|uvp
argument_list|,
name|msg
argument_list|)
expr_stmt|;
comment|/* 	 * Clear any running timer 	 */
name|UNISIG_VC_CANCEL
argument_list|(
operator|(
expr|struct
name|vccb
operator|*
operator|)
name|uvp
argument_list|)
expr_stmt|;
comment|/* 	 * Send a STATUS message 	 */
name|rc
operator|=
name|unisig_send_status
argument_list|(
name|usp
argument_list|,
name|uvp
argument_list|,
name|msg
argument_list|,
name|UNI_IE_CAUS_STATE
argument_list|)
expr_stmt|;
return|return
operator|(
name|rc
condition|?
name|rc
else|:
name|EINVAL
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * VC state machine action 18  * Signalling AAL connection has been lost  *  * Start timer T309.  If the timer expires before the SAAL connection  * comes back, the VCC will be cleared.  *  * Arguments:  *	usp	pointer to protocol instance block  *	uvp	pointer to the VCCB for the affected connection  *	msg	pointer to a UNISIG message structure  *  * Returns:  *	0	success  *	errno	error encountered  *  */
end_comment

begin_function
specifier|static
name|int
name|unisig_vc_act18
parameter_list|(
name|usp
parameter_list|,
name|uvp
parameter_list|,
name|msg
parameter_list|)
name|struct
name|unisig
modifier|*
name|usp
decl_stmt|;
name|struct
name|unisig_vccb
modifier|*
name|uvp
decl_stmt|;
name|struct
name|unisig_msg
modifier|*
name|msg
decl_stmt|;
block|{
comment|/* 	 * Clear any running timer 	 */
name|UNISIG_VC_CANCEL
argument_list|(
operator|(
expr|struct
name|vccb
operator|*
operator|)
name|uvp
argument_list|)
expr_stmt|;
comment|/* 	 * Start timer T309 	 */
name|UNISIG_VC_TIMER
argument_list|(
operator|(
expr|struct
name|vccb
operator|*
operator|)
name|uvp
argument_list|,
name|UNI_T309
argument_list|)
expr_stmt|;
comment|/* 	 * Set new state 	 */
name|uvp
operator|->
name|uv_sstate
operator|=
name|UNI_SSCF_RECOV
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * VC state machine action 19  * Ignore the event  *  * Arguments:  *	usp	pointer to protocol instance block  *	uvp	pointer to the VCCB for the affected connection  *	msg	pointer to a UNISIG message structure  *  * Returns:  *	0	success  *	errno	error encountered  *  */
end_comment

begin_function
specifier|static
name|int
name|unisig_vc_act19
parameter_list|(
name|usp
parameter_list|,
name|uvp
parameter_list|,
name|msg
parameter_list|)
name|struct
name|unisig
modifier|*
name|usp
decl_stmt|;
name|struct
name|unisig_vccb
modifier|*
name|uvp
decl_stmt|;
name|struct
name|unisig_msg
modifier|*
name|msg
decl_stmt|;
block|{
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * VC state machine action 20  * SSCF establish indication in UNI_SSCF_RECOV state -- signalling  * AAL has come up after an outage  *  * Send STATUS ENQ to make sure we're in compatible state with other end  *  * Arguments:  *	usp	pointer to protocol instance block  *	uvp	pointer to the VCCB for the affected connection  *	msg	pointer to a UNISIG message structure  *  * Returns:  *	0	success  *	errno	error encountered  *  */
end_comment

begin_function
specifier|static
name|int
name|unisig_vc_act20
parameter_list|(
name|usp
parameter_list|,
name|uvp
parameter_list|,
name|msg
parameter_list|)
name|struct
name|unisig
modifier|*
name|usp
decl_stmt|;
name|struct
name|unisig_vccb
modifier|*
name|uvp
decl_stmt|;
name|struct
name|unisig_msg
modifier|*
name|msg
decl_stmt|;
block|{
name|int
name|rc
decl_stmt|;
name|struct
name|unisig_msg
modifier|*
name|stat_msg
decl_stmt|;
comment|/* 	 * Clear any running timer 	 */
name|UNISIG_VC_CANCEL
argument_list|(
operator|(
expr|struct
name|vccb
operator|*
operator|)
name|uvp
argument_list|)
expr_stmt|;
comment|/* 	 * Get memory for a STATUS ENQUIRY message 	 * May be called from netisr - don't wait. 	 */
name|stat_msg
operator|=
name|uma_zalloc
argument_list|(
name|unisig_msg_zone
argument_list|,
name|M_NOWAIT
argument_list|)
expr_stmt|;
if|if
condition|(
name|stat_msg
operator|==
name|NULL
condition|)
return|return
operator|(
name|ENOMEM
operator|)
return|;
comment|/* 	 * Fill out the message 	 */
name|stat_msg
operator|->
name|msg_call_ref
operator|=
name|uvp
operator|->
name|uv_call_ref
expr_stmt|;
name|stat_msg
operator|->
name|msg_type
operator|=
name|UNI_MSG_SENQ
expr_stmt|;
name|stat_msg
operator|->
name|msg_type_flag
operator|=
literal|0
expr_stmt|;
name|stat_msg
operator|->
name|msg_type_action
operator|=
literal|0
expr_stmt|;
comment|/* 	 * Send the STATUS ENQUIRY message 	 */
name|rc
operator|=
name|unisig_send_msg
argument_list|(
name|usp
argument_list|,
name|stat_msg
argument_list|)
expr_stmt|;
name|unisig_free_msg
argument_list|(
name|stat_msg
argument_list|)
expr_stmt|;
comment|/* 	 * Return to active state 	 */
name|uvp
operator|->
name|uv_sstate
operator|=
name|UNI_ACTIVE
expr_stmt|;
return|return
operator|(
name|rc
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * VC state machine action 21  * STATUS received  *  * Arguments:  *	usp	pointer to protocol instance block  *	uvp	pointer to the VCCB for the affected connection (may  *		be NULL)  *	msg	pointer to a UNISIG message structure  *  * Returns:  *	0	success  *	errno	error encountered  *  */
end_comment

begin_function
specifier|static
name|int
name|unisig_vc_act21
parameter_list|(
name|usp
parameter_list|,
name|uvp
parameter_list|,
name|msg
parameter_list|)
name|struct
name|unisig
modifier|*
name|usp
decl_stmt|;
name|struct
name|unisig_vccb
modifier|*
name|uvp
decl_stmt|;
name|struct
name|unisig_msg
modifier|*
name|msg
decl_stmt|;
block|{
name|int
name|cause
decl_stmt|,
name|rc
decl_stmt|;
comment|/* 	 * Ignore a STATUS message with the global call reference 	 */
if|if
condition|(
name|GLOBAL_CREF
argument_list|(
name|msg
operator|->
name|msg_call_ref
argument_list|)
condition|)
block|{
return|return
operator|(
literal|0
operator|)
return|;
block|}
comment|/* 	 * If the network thinks we're in NULL state, clear the VCC 	 */
if|if
condition|(
name|msg
operator|->
name|msg_ie_clst
operator|->
name|ie_clst_state
operator|==
name|UNI_NULL
condition|)
block|{
if|if
condition|(
name|uvp
condition|)
block|{
operator|(
name|void
operator|)
name|unisig_clear_vcc
argument_list|(
name|usp
argument_list|,
name|uvp
argument_list|,
name|T_ATM_CAUSE_DESTINATION_OUT_OF_ORDER
argument_list|)
expr_stmt|;
block|}
return|return
operator|(
literal|0
operator|)
return|;
block|}
comment|/* 	 * If we are in NULL state, send a RELEASE COMPLETE 	 */
if|if
condition|(
operator|!
name|uvp
operator|||
operator|(
name|uvp
operator|->
name|uv_sstate
operator|==
name|UNI_FREE
operator|)
operator|||
operator|(
name|uvp
operator|->
name|uv_sstate
operator|==
name|UNI_NULL
operator|)
condition|)
block|{
name|rc
operator|=
name|unisig_send_release_complete
argument_list|(
name|usp
argument_list|,
name|uvp
argument_list|,
name|msg
argument_list|,
name|UNI_IE_CAUS_STATE
argument_list|)
expr_stmt|;
return|return
operator|(
name|rc
operator|)
return|;
block|}
comment|/* 	 * If the reported state doesn't match our state, close the VCC 	 * unless we're in UNI_RELEASE_REQUEST or UNI_RELEASE_IND 	 */
if|if
condition|(
name|msg
operator|->
name|msg_ie_clst
operator|->
name|ie_clst_state
operator|!=
name|uvp
operator|->
name|uv_sstate
condition|)
block|{
if|if
condition|(
name|uvp
operator|->
name|uv_sstate
operator|==
name|UNI_RELEASE_REQUEST
operator|||
name|uvp
operator|->
name|uv_sstate
operator|==
name|UNI_RELEASE_IND
condition|)
block|{
return|return
operator|(
literal|0
operator|)
return|;
block|}
name|rc
operator|=
name|unisig_clear_vcc
argument_list|(
name|usp
argument_list|,
name|uvp
argument_list|,
name|T_ATM_CAUSE_MESSAGE_INCOMPATIBLE_WITH_CALL_STATE
argument_list|)
expr_stmt|;
block|}
comment|/* 	 * States match, check for an error on one of our messages 	 */
name|cause
operator|=
name|msg
operator|->
name|msg_ie_caus
operator|->
name|ie_caus_cause
expr_stmt|;
if|if
condition|(
name|cause
operator|==
name|UNI_IE_CAUS_MISSING
operator|||
name|cause
operator|==
name|UNI_IE_CAUS_MTEXIST
operator|||
name|cause
operator|==
name|UNI_IE_CAUS_IEEXIST
operator|||
name|cause
operator|==
name|UNI_IE_CAUS_IECONTENT
operator|||
name|cause
operator|==
name|UNI_IE_CAUS_STATE
condition|)
block|{
name|ATM_DEBUG2
argument_list|(
literal|"unisig_vc_act21: error %d on message 0x%x\n"
argument_list|,
name|cause
argument_list|,
name|msg
operator|->
name|msg_ie_caus
operator|->
name|ie_caus_diagnostic
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|uvp
condition|)
block|{
operator|(
name|void
operator|)
name|unisig_clear_vcc
argument_list|(
name|usp
argument_list|,
name|uvp
argument_list|,
name|cause
argument_list|)
expr_stmt|;
block|}
block|}
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * VC state machine action 22  * Received STATUS ENQ  *  * Send STATUS with cause 30 "response to STATUS ENQUIRY" and  * current state  *  * Arguments:  *	usp	pointer to protocol instance block  *	uvp	pointer to the VCCB for the affected connection (may  *		be NULL)  *	msg	pointer to a UNISIG message structure  *  * Returns:  *	0	success  *	errno	error encountered  *  */
end_comment

begin_function
specifier|static
name|int
name|unisig_vc_act22
parameter_list|(
name|usp
parameter_list|,
name|uvp
parameter_list|,
name|msg
parameter_list|)
name|struct
name|unisig
modifier|*
name|usp
decl_stmt|;
name|struct
name|unisig_vccb
modifier|*
name|uvp
decl_stmt|;
name|struct
name|unisig_msg
modifier|*
name|msg
decl_stmt|;
block|{
name|int
name|rc
decl_stmt|;
name|struct
name|unisig_msg
modifier|*
name|status
decl_stmt|;
name|struct
name|ie_generic
modifier|*
name|callst_ie
decl_stmt|,
modifier|*
name|cause_ie
decl_stmt|;
name|ATM_DEBUG3
argument_list|(
literal|"unisig_vc_perror: usp=%p, uvp=%p, msg=%p\n"
argument_list|,
name|usp
argument_list|,
name|uvp
argument_list|,
name|msg
argument_list|)
expr_stmt|;
comment|/* 	 * Get memory for a STATUS message 	 */
name|status
operator|=
name|uma_zalloc
argument_list|(
name|unisig_msg_zone
argument_list|,
name|M_WAITOK
operator||
name|M_ZERO
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|==
name|NULL
condition|)
return|return
operator|(
name|ENOMEM
operator|)
return|;
name|callst_ie
operator|=
name|uma_zalloc
argument_list|(
name|unisig_ie_zone
argument_list|,
name|M_WAITOK
operator||
name|M_ZERO
argument_list|)
expr_stmt|;
if|if
condition|(
name|callst_ie
operator|==
name|NULL
condition|)
block|{
name|uma_zfree
argument_list|(
name|unisig_msg_zone
argument_list|,
name|status
argument_list|)
expr_stmt|;
return|return
operator|(
name|ENOMEM
operator|)
return|;
block|}
name|cause_ie
operator|=
name|uma_zalloc
argument_list|(
name|unisig_ie_zone
argument_list|,
name|M_WAITOK
operator||
name|M_ZERO
argument_list|)
expr_stmt|;
if|if
condition|(
name|cause_ie
operator|==
name|NULL
condition|)
block|{
name|uma_zfree
argument_list|(
name|unisig_msg_zone
argument_list|,
name|status
argument_list|)
expr_stmt|;
name|uma_zfree
argument_list|(
name|unisig_ie_zone
argument_list|,
name|callst_ie
argument_list|)
expr_stmt|;
return|return
operator|(
name|ENOMEM
operator|)
return|;
block|}
comment|/* 	 * Fill out the response 	 */
if|if
condition|(
name|uvp
condition|)
block|{
name|status
operator|->
name|msg_call_ref
operator|=
name|uvp
operator|->
name|uv_call_ref
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|msg
condition|)
block|{
if|if
condition|(
name|msg
operator|->
name|msg_call_ref
operator|&
name|UNI_MSG_CALL_REF_RMT
condition|)
name|status
operator|->
name|msg_call_ref
operator|=
name|msg
operator|->
name|msg_call_ref
operator|&
name|UNI_MSG_CALL_REF_MASK
expr_stmt|;
else|else
name|status
operator|->
name|msg_call_ref
operator|=
name|msg
operator|->
name|msg_call_ref
operator||
name|UNI_MSG_CALL_REF_RMT
expr_stmt|;
block|}
else|else
block|{
name|status
operator|->
name|msg_call_ref
operator|=
name|UNI_MSG_CALL_REF_GLOBAL
expr_stmt|;
block|}
name|status
operator|->
name|msg_type
operator|=
name|UNI_MSG_STAT
expr_stmt|;
name|status
operator|->
name|msg_type_flag
operator|=
literal|0
expr_stmt|;
name|status
operator|->
name|msg_type_action
operator|=
literal|0
expr_stmt|;
name|status
operator|->
name|msg_ie_clst
operator|=
name|callst_ie
expr_stmt|;
name|status
operator|->
name|msg_ie_caus
operator|=
name|cause_ie
expr_stmt|;
comment|/* 	 * Fill out the call state IE 	 */
name|callst_ie
operator|->
name|ie_ident
operator|=
name|UNI_IE_CLST
expr_stmt|;
name|callst_ie
operator|->
name|ie_coding
operator|=
literal|0
expr_stmt|;
name|callst_ie
operator|->
name|ie_flag
operator|=
literal|0
expr_stmt|;
name|callst_ie
operator|->
name|ie_action
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|uvp
condition|)
block|{
switch|switch
condition|(
name|uvp
operator|->
name|uv_sstate
condition|)
block|{
case|case
name|UNI_FREE
case|:
name|callst_ie
operator|->
name|ie_clst_state
operator|=
name|UNI_NULL
expr_stmt|;
break|break;
default|default:
name|callst_ie
operator|->
name|ie_clst_state
operator|=
name|uvp
operator|->
name|uv_sstate
expr_stmt|;
block|}
block|}
else|else
block|{
name|callst_ie
operator|->
name|ie_clst_state
operator|=
name|UNI_NULL
expr_stmt|;
block|}
comment|/* 	 * Fill out the cause IE 	 */
name|cause_ie
operator|->
name|ie_ident
operator|=
name|UNI_IE_CAUS
expr_stmt|;
name|cause_ie
operator|->
name|ie_coding
operator|=
literal|0
expr_stmt|;
name|cause_ie
operator|->
name|ie_flag
operator|=
literal|0
expr_stmt|;
name|cause_ie
operator|->
name|ie_action
operator|=
literal|0
expr_stmt|;
name|cause_ie
operator|->
name|ie_caus_loc
operator|=
name|UNI_IE_CAUS_LOC_USER
expr_stmt|;
name|cause_ie
operator|->
name|ie_caus_cause
operator|=
name|UNI_IE_CAUS_SENQ
expr_stmt|;
comment|/* 	 * Send the STATUS message 	 */
name|rc
operator|=
name|unisig_send_msg
argument_list|(
name|usp
argument_list|,
name|status
argument_list|)
expr_stmt|;
name|unisig_free_msg
argument_list|(
name|status
argument_list|)
expr_stmt|;
return|return
operator|(
name|rc
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * VC state machine action 23  * Received ADD PARTY  *  * We don't support multipoint connections, so send an ADD PARTY REJECT  *  * Arguments:  *	usp	pointer to protocol instance block  *	uvp	pointer to the VCCB for the affected connection  *	msg	pointer to a UNISIG message structure  *  * Returns:  *	0	success  *	errno	error encountered  *  */
end_comment

begin_function
specifier|static
name|int
name|unisig_vc_act23
parameter_list|(
name|usp
parameter_list|,
name|uvp
parameter_list|,
name|msg
parameter_list|)
name|struct
name|unisig
modifier|*
name|usp
decl_stmt|;
name|struct
name|unisig_vccb
modifier|*
name|uvp
decl_stmt|;
name|struct
name|unisig_msg
modifier|*
name|msg
decl_stmt|;
block|{
name|int
name|rc
decl_stmt|;
name|struct
name|unisig_msg
modifier|*
name|apr_msg
decl_stmt|;
comment|/* 	 * Get memory for the ADD PARTY REJECT message 	 */
name|apr_msg
operator|=
name|uma_zalloc
argument_list|(
name|unisig_msg_zone
argument_list|,
name|M_WAITOK
operator||
name|M_ZERO
argument_list|)
expr_stmt|;
if|if
condition|(
name|apr_msg
operator|==
name|NULL
condition|)
return|return
operator|(
name|ENOMEM
operator|)
return|;
comment|/* 	 * Fill out the message 	 */
if|if
condition|(
name|msg
operator|->
name|msg_call_ref
operator|&
name|UNI_MSG_CALL_REF_RMT
condition|)
name|apr_msg
operator|->
name|msg_call_ref
operator|=
name|msg
operator|->
name|msg_call_ref
operator|&
name|UNI_MSG_CALL_REF_MASK
expr_stmt|;
else|else
name|apr_msg
operator|->
name|msg_call_ref
operator|=
name|msg
operator|->
name|msg_call_ref
operator||
name|UNI_MSG_CALL_REF_RMT
expr_stmt|;
name|apr_msg
operator|->
name|msg_type
operator|=
name|UNI_MSG_ADPR
expr_stmt|;
name|apr_msg
operator|->
name|msg_type_flag
operator|=
literal|0
expr_stmt|;
name|apr_msg
operator|->
name|msg_type_action
operator|=
literal|0
expr_stmt|;
comment|/* 	 * Use the endpoint reference IE from the received message 	 */
name|apr_msg
operator|->
name|msg_ie_eprf
operator|=
name|msg
operator|->
name|msg_ie_eprf
expr_stmt|;
comment|/* 	 * Send the ADD PARTY REJECT message 	 */
name|rc
operator|=
name|unisig_send_msg
argument_list|(
name|usp
argument_list|,
name|apr_msg
argument_list|)
expr_stmt|;
name|apr_msg
operator|->
name|msg_ie_eprf
operator|=
name|NULL
expr_stmt|;
name|unisig_free_msg
argument_list|(
name|apr_msg
argument_list|)
expr_stmt|;
return|return
operator|(
name|rc
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * VC state machine action 24  * User error  *  * Return EALREADY  *  * Arguments:  *	usp	pointer to protocol instance block  *	uvp	pointer to the VCCB for the affected connection  *	msg	pointer to a UNISIG message structure  *  * Returns:  *	0	success  *	errno	error encountered  *  */
end_comment

begin_function
specifier|static
name|int
name|unisig_vc_act24
parameter_list|(
name|usp
parameter_list|,
name|uvp
parameter_list|,
name|msg
parameter_list|)
name|struct
name|unisig
modifier|*
name|usp
decl_stmt|;
name|struct
name|unisig_vccb
modifier|*
name|uvp
decl_stmt|;
name|struct
name|unisig_msg
modifier|*
name|msg
decl_stmt|;
block|{
return|return
operator|(
name|EALREADY
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * VC state machine action 25  * User error  *  * Return EINVAL  *  * Arguments:  *	usp	pointer to protocol instance block  *	uvp	pointer to the VCCB for the affected connection  *	msg	pointer to a UNISIG message structure  *  * Returns:  *	0	success  *	errno	error encountered  *  */
end_comment

begin_function
specifier|static
name|int
name|unisig_vc_act25
parameter_list|(
name|usp
parameter_list|,
name|uvp
parameter_list|,
name|msg
parameter_list|)
name|struct
name|unisig
modifier|*
name|usp
decl_stmt|;
name|struct
name|unisig_vccb
modifier|*
name|uvp
decl_stmt|;
name|struct
name|unisig_msg
modifier|*
name|msg
decl_stmt|;
block|{
return|return
operator|(
name|EINVAL
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * VC state machine action 26  * PVC abort  *  * The abort handler was called to abort a PVC.  Clear the VCCB and  * notify the user.  *  * Arguments:  *	usp	pointer to protocol instance block  *	uvp	pointer to the VCCB for the affected connection  *	msg	pointer to a UNISIG message structure  *  * Returns:  *	0	success  *	errno	error encountered  *  */
end_comment

begin_function
specifier|static
name|int
name|unisig_vc_act26
parameter_list|(
name|usp
parameter_list|,
name|uvp
parameter_list|,
name|msg
parameter_list|)
name|struct
name|unisig
modifier|*
name|usp
decl_stmt|;
name|struct
name|unisig_vccb
modifier|*
name|uvp
decl_stmt|;
name|struct
name|unisig_msg
modifier|*
name|msg
decl_stmt|;
block|{
name|int
name|rc
decl_stmt|;
comment|/* 	 * Clear any running timer 	 */
name|UNISIG_VC_CANCEL
argument_list|(
operator|(
expr|struct
name|vccb
operator|*
operator|)
name|uvp
argument_list|)
expr_stmt|;
comment|/* 	 * Close the VCCB 	 */
name|rc
operator|=
name|unisig_close_vcc
argument_list|(
name|usp
argument_list|,
name|uvp
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
condition|)
return|return
operator|(
name|rc
operator|)
return|;
comment|/* 	 * Notify the user 	 */
if|if
condition|(
name|uvp
operator|->
name|uv_connvc
operator|->
name|cvc_attr
operator|.
name|cause
operator|.
name|tag
operator|!=
name|T_ATM_PRESENT
condition|)
name|unisig_cause_attr_from_user
argument_list|(
operator|&
name|uvp
operator|->
name|uv_connvc
operator|->
name|cvc_attr
argument_list|,
name|T_ATM_CAUSE_NORMAL_CALL_CLEARING
argument_list|)
expr_stmt|;
name|atm_cm_cleared
argument_list|(
name|uvp
operator|->
name|uv_connvc
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * VC state machine action 27  * Signalling AAL failure  *  * Change PVC state to UNI_PVC_ACT_DOWN.  *  * Arguments:  *	usp	pointer to protocol instance block  *	uvp	pointer to the VCCB for the affected connection  *	msg	pointer to a UNISIG message structure  *  * Returns:  *	0	success  *	errno	error encountered  *  */
end_comment

begin_function
specifier|static
name|int
name|unisig_vc_act27
parameter_list|(
name|usp
parameter_list|,
name|uvp
parameter_list|,
name|msg
parameter_list|)
name|struct
name|unisig
modifier|*
name|usp
decl_stmt|;
name|struct
name|unisig_vccb
modifier|*
name|uvp
decl_stmt|;
name|struct
name|unisig_msg
modifier|*
name|msg
decl_stmt|;
block|{
comment|/* 	 * Set the state 	 */
name|uvp
operator|->
name|uv_sstate
operator|=
name|UNI_PVC_ACT_DOWN
expr_stmt|;
comment|/* 	 * Mark the time 	 */
name|uvp
operator|->
name|uv_tstamp
operator|=
name|time_second
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * VC state machine action 28  * Signalling AAL established  *  * Set PVC state to UNI_PVC_ACTIVE.  *  * Arguments:  *	usp	pointer to protocol instance block  *	uvp	pointer to the VCCB for the affected connection  *	msg	pointer to a UNISIG message structure  *  * Returns:  *	0	success  *	errno	error encountered  *  */
end_comment

begin_function
specifier|static
name|int
name|unisig_vc_act28
parameter_list|(
name|usp
parameter_list|,
name|uvp
parameter_list|,
name|msg
parameter_list|)
name|struct
name|unisig
modifier|*
name|usp
decl_stmt|;
name|struct
name|unisig_vccb
modifier|*
name|uvp
decl_stmt|;
name|struct
name|unisig_msg
modifier|*
name|msg
decl_stmt|;
block|{
comment|/* 	 * Set the state 	 */
name|uvp
operator|->
name|uv_sstate
operator|=
name|UNI_PVC_ACTIVE
expr_stmt|;
comment|/* 	 * Mark the time 	 */
name|uvp
operator|->
name|uv_tstamp
operator|=
name|time_second
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * VC state machine action 29  * Protocol error  *  * Send a RELEASE COMPLETE message with cause 81, "invalid call  * reference value"  *  * Arguments:  *	usp	pointer to protocol instance block  *	uvp	pointer to the VCCB for the affected connection (may  *		be NULL)  *	msg	pointer to a UNISIG message structure  *  * Returns:  *	0	success  *	errno	error encountered  *  */
end_comment

begin_function
specifier|static
name|int
name|unisig_vc_act29
parameter_list|(
name|usp
parameter_list|,
name|uvp
parameter_list|,
name|msg
parameter_list|)
name|struct
name|unisig
modifier|*
name|usp
decl_stmt|;
name|struct
name|unisig_vccb
modifier|*
name|uvp
decl_stmt|;
name|struct
name|unisig_msg
modifier|*
name|msg
decl_stmt|;
block|{
name|int
name|rc
decl_stmt|;
comment|/* 	 * Send a RELEASE COMPLETE message 	 */
name|rc
operator|=
name|unisig_send_release_complete
argument_list|(
name|usp
argument_list|,
name|uvp
argument_list|,
name|msg
argument_list|,
name|UNI_IE_CAUS_CREF
argument_list|)
expr_stmt|;
return|return
operator|(
name|rc
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * VC state machine action 30  * Release routine called while SSCF session down, or SSCF session  * reset or lost while in UNI_CALL_PRESENT  *  * Go to UNI_FREE state  *  * Arguments:  *	usp	pointer to protocol instance block  *	uvp	pointer to the VCCB for the affected connection  *	msg	pointer to a UNISIG message structure  *  * Returns:  *	0	success  *	errno	error encountered  *  */
end_comment

begin_function
specifier|static
name|int
name|unisig_vc_act30
parameter_list|(
name|usp
parameter_list|,
name|uvp
parameter_list|,
name|msg
parameter_list|)
name|struct
name|unisig
modifier|*
name|usp
decl_stmt|;
name|struct
name|unisig_vccb
modifier|*
name|uvp
decl_stmt|;
name|struct
name|unisig_msg
modifier|*
name|msg
decl_stmt|;
block|{
comment|/* 	 * Clear any running timer 	 */
name|UNISIG_VC_CANCEL
argument_list|(
operator|(
expr|struct
name|vccb
operator|*
operator|)
name|uvp
argument_list|)
expr_stmt|;
comment|/* 	 * Clear the call state 	 */
name|uvp
operator|->
name|uv_sstate
operator|=
name|UNI_FREE
expr_stmt|;
name|uvp
operator|->
name|uv_ustate
operator|=
name|VCCU_CLOSED
expr_stmt|;
comment|/* 	 * Mark the time 	 */
name|uvp
operator|->
name|uv_tstamp
operator|=
name|time_second
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * VC state machine action 31  * Accept handler called in UNI_FREE state.  *  * The call was in UNI_CALL_PRESENT state when it was closed because  * of an SSCF failure.  Return an error indication.  The accept  * handler will free the VCCB and return the proper code to the  * caller.  *  * Arguments:  *	usp	pointer to protocol instance block  *	uvp	pointer to the VCCB for the affected connection  *	msg	pointer to a UNISIG message structure  *  * Returns:  *	0	success  *	errno	error encountered  *  */
end_comment

begin_function
specifier|static
name|int
name|unisig_vc_act31
parameter_list|(
name|usp
parameter_list|,
name|uvp
parameter_list|,
name|msg
parameter_list|)
name|struct
name|unisig
modifier|*
name|usp
decl_stmt|;
name|struct
name|unisig_vccb
modifier|*
name|uvp
decl_stmt|;
name|struct
name|unisig_msg
modifier|*
name|msg
decl_stmt|;
block|{
return|return
operator|(
name|ENETDOWN
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Initiate clearing a call by sending a RELEASE message.  *  * Arguments:  *	usp	pointer to protocol instance block  *	uvp	pointer to the VCCB for the affected connection  *	msg	pointer to UNI signalling message that the RELEASE  *		responds to (may be NULL)  *	cause	the reason for clearing the call;  a value of  *		T_ATM_ABSENT indicates that the cause code is  *		in the VCC's ATM attributes block  *  * Returns:  *	0	success  *	errno	error encountered  *  */
end_comment

begin_function
specifier|static
name|int
name|unisig_vc_clear_call
parameter_list|(
name|usp
parameter_list|,
name|uvp
parameter_list|,
name|msg
parameter_list|,
name|cause
parameter_list|)
name|struct
name|unisig
modifier|*
name|usp
decl_stmt|;
name|struct
name|unisig_vccb
modifier|*
name|uvp
decl_stmt|;
name|struct
name|unisig_msg
modifier|*
name|msg
decl_stmt|;
name|int
name|cause
decl_stmt|;
block|{
name|int
name|rc
decl_stmt|;
comment|/* 	 * Clear the retry count 	 */
name|uvp
operator|->
name|uv_retry
operator|=
literal|0
expr_stmt|;
comment|/* 	 * Make sure the ATM attributes block has a valid cause code, 	 * if needed 	 */
if|if
condition|(
name|cause
operator|==
name|T_ATM_ABSENT
operator|&&
name|uvp
operator|->
name|uv_connvc
operator|->
name|cvc_attr
operator|.
name|cause
operator|.
name|tag
operator|!=
name|T_ATM_PRESENT
condition|)
block|{
name|uvp
operator|->
name|uv_connvc
operator|->
name|cvc_attr
operator|.
name|cause
operator|.
name|tag
operator|=
name|T_ATM_PRESENT
expr_stmt|;
name|uvp
operator|->
name|uv_connvc
operator|->
name|cvc_attr
operator|.
name|cause
operator|.
name|v
operator|.
name|coding_standard
operator|=
name|T_ATM_ITU_CODING
expr_stmt|;
name|uvp
operator|->
name|uv_connvc
operator|->
name|cvc_attr
operator|.
name|cause
operator|.
name|v
operator|.
name|location
operator|=
name|T_ATM_LOC_USER
expr_stmt|;
name|uvp
operator|->
name|uv_connvc
operator|->
name|cvc_attr
operator|.
name|cause
operator|.
name|v
operator|.
name|cause_value
operator|=
name|usp
operator|->
name|us_proto
operator|==
name|ATM_SIG_UNI30
condition|?
name|T_ATM_CAUSE_UNSPECIFIED_NORMAL
else|:
name|T_ATM_CAUSE_NORMAL_CALL_CLEARING
expr_stmt|;
block|}
comment|/* 	 * Send a RELEASE message 	 */
name|rc
operator|=
name|unisig_send_release
argument_list|(
name|usp
argument_list|,
name|uvp
argument_list|,
name|msg
argument_list|,
name|cause
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
condition|)
return|return
operator|(
name|rc
operator|)
return|;
comment|/* 	 * Start timer T308 	 */
name|UNISIG_VC_TIMER
argument_list|(
operator|(
expr|struct
name|vccb
operator|*
operator|)
name|uvp
argument_list|,
name|UNI_T308
argument_list|)
expr_stmt|;
comment|/* 	 * Set the VCCB state 	 */
name|uvp
operator|->
name|uv_sstate
operator|=
name|UNI_RELEASE_REQUEST
expr_stmt|;
if|if
condition|(
name|uvp
operator|->
name|uv_ustate
operator|!=
name|VCCU_ABORT
condition|)
name|uvp
operator|->
name|uv_ustate
operator|=
name|VCCU_CLOSED
expr_stmt|;
comment|/* 	 * Mark the time 	 */
name|uvp
operator|->
name|uv_tstamp
operator|=
name|time_second
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

end_unit


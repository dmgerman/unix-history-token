begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * The mrouted program is covered by the license in the accompanying file  * named "LICENSE".  Use of the mrouted program represents acceptance of  * the terms and conditions listed in that file.  *  * The mrouted program is COPYRIGHT 1989 by The Board of Trustees of  * Leland Stanford Junior University.  *  *  * $Id: kern.c,v 1.3 1993/05/30 01:36:38 deering Exp $  */
end_comment

begin_include
include|#
directive|include
file|"defs.h"
end_include

begin_function
name|void
name|k_set_rcvbuf
parameter_list|(
name|bufsize
parameter_list|)
name|int
name|bufsize
decl_stmt|;
block|{
if|if
condition|(
name|setsockopt
argument_list|(
name|igmp_socket
argument_list|,
name|SOL_SOCKET
argument_list|,
name|SO_RCVBUF
argument_list|,
operator|(
name|char
operator|*
operator|)
operator|&
name|bufsize
argument_list|,
sizeof|sizeof
argument_list|(
name|bufsize
argument_list|)
argument_list|)
operator|<
literal|0
condition|)
name|log
argument_list|(
name|LOG_ERR
argument_list|,
name|errno
argument_list|,
literal|"setsockopt SO_RCVBUF %u"
argument_list|,
name|bufsize
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|k_hdr_include
parameter_list|(
name|bool
parameter_list|)
name|int
name|bool
decl_stmt|;
block|{
ifdef|#
directive|ifdef
name|IP_HDRINCL
if|if
condition|(
name|setsockopt
argument_list|(
name|igmp_socket
argument_list|,
name|IPPROTO_IP
argument_list|,
name|IP_HDRINCL
argument_list|,
operator|(
name|char
operator|*
operator|)
operator|&
name|bool
argument_list|,
sizeof|sizeof
argument_list|(
name|bool
argument_list|)
argument_list|)
operator|<
literal|0
condition|)
name|log
argument_list|(
name|LOG_ERR
argument_list|,
name|errno
argument_list|,
literal|"setsockopt IP_HDRINCL %u"
argument_list|,
name|bool
argument_list|)
expr_stmt|;
endif|#
directive|endif
block|}
end_function

begin_function
name|void
name|k_set_ttl
parameter_list|(
name|t
parameter_list|)
name|int
name|t
decl_stmt|;
block|{
name|u_char
name|ttl
decl_stmt|;
name|ttl
operator|=
name|t
expr_stmt|;
if|if
condition|(
name|setsockopt
argument_list|(
name|igmp_socket
argument_list|,
name|IPPROTO_IP
argument_list|,
name|IP_MULTICAST_TTL
argument_list|,
operator|(
name|char
operator|*
operator|)
operator|&
name|ttl
argument_list|,
sizeof|sizeof
argument_list|(
name|ttl
argument_list|)
argument_list|)
operator|<
literal|0
condition|)
name|log
argument_list|(
name|LOG_ERR
argument_list|,
name|errno
argument_list|,
literal|"setsockopt IP_MULTICAST_TTL %u"
argument_list|,
name|ttl
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|k_set_loop
parameter_list|(
name|l
parameter_list|)
name|int
name|l
decl_stmt|;
block|{
name|u_char
name|loop
decl_stmt|;
name|loop
operator|=
name|l
expr_stmt|;
if|if
condition|(
name|setsockopt
argument_list|(
name|igmp_socket
argument_list|,
name|IPPROTO_IP
argument_list|,
name|IP_MULTICAST_LOOP
argument_list|,
operator|(
name|char
operator|*
operator|)
operator|&
name|loop
argument_list|,
sizeof|sizeof
argument_list|(
name|loop
argument_list|)
argument_list|)
operator|<
literal|0
condition|)
name|log
argument_list|(
name|LOG_ERR
argument_list|,
name|errno
argument_list|,
literal|"setsockopt IP_MULTICAST_LOOP %u"
argument_list|,
name|loop
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|k_set_if
parameter_list|(
name|ifa
parameter_list|)
name|u_long
name|ifa
decl_stmt|;
block|{
name|struct
name|in_addr
name|adr
decl_stmt|;
name|adr
operator|.
name|s_addr
operator|=
name|ifa
expr_stmt|;
if|if
condition|(
name|setsockopt
argument_list|(
name|igmp_socket
argument_list|,
name|IPPROTO_IP
argument_list|,
name|IP_MULTICAST_IF
argument_list|,
operator|(
name|char
operator|*
operator|)
operator|&
name|adr
argument_list|,
sizeof|sizeof
argument_list|(
name|adr
argument_list|)
argument_list|)
operator|<
literal|0
condition|)
name|log
argument_list|(
name|LOG_ERR
argument_list|,
name|errno
argument_list|,
literal|"setsockopt IP_MULTICAST_IF %s"
argument_list|,
name|inet_fmt
argument_list|(
name|ifa
argument_list|,
name|s1
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|k_join
parameter_list|(
name|grp
parameter_list|,
name|ifa
parameter_list|)
name|u_long
name|grp
decl_stmt|;
name|u_long
name|ifa
decl_stmt|;
block|{
name|struct
name|ip_mreq
name|mreq
decl_stmt|;
name|mreq
operator|.
name|imr_multiaddr
operator|.
name|s_addr
operator|=
name|grp
expr_stmt|;
name|mreq
operator|.
name|imr_interface
operator|.
name|s_addr
operator|=
name|ifa
expr_stmt|;
if|if
condition|(
name|setsockopt
argument_list|(
name|igmp_socket
argument_list|,
name|IPPROTO_IP
argument_list|,
name|IP_ADD_MEMBERSHIP
argument_list|,
operator|(
name|char
operator|*
operator|)
operator|&
name|mreq
argument_list|,
sizeof|sizeof
argument_list|(
name|mreq
argument_list|)
argument_list|)
operator|<
literal|0
condition|)
name|log
argument_list|(
name|LOG_WARNING
argument_list|,
name|errno
argument_list|,
literal|"can't join group %s on interface %s"
argument_list|,
name|inet_fmt
argument_list|(
name|grp
argument_list|,
name|s1
argument_list|)
argument_list|,
name|inet_fmt
argument_list|(
name|ifa
argument_list|,
name|s2
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|k_leave
parameter_list|(
name|grp
parameter_list|,
name|ifa
parameter_list|)
name|u_long
name|grp
decl_stmt|;
name|u_long
name|ifa
decl_stmt|;
block|{
name|struct
name|ip_mreq
name|mreq
decl_stmt|;
name|mreq
operator|.
name|imr_multiaddr
operator|.
name|s_addr
operator|=
name|grp
expr_stmt|;
name|mreq
operator|.
name|imr_interface
operator|.
name|s_addr
operator|=
name|ifa
expr_stmt|;
if|if
condition|(
name|setsockopt
argument_list|(
name|igmp_socket
argument_list|,
name|IPPROTO_IP
argument_list|,
name|IP_DROP_MEMBERSHIP
argument_list|,
operator|(
name|char
operator|*
operator|)
operator|&
name|mreq
argument_list|,
sizeof|sizeof
argument_list|(
name|mreq
argument_list|)
argument_list|)
operator|<
literal|0
condition|)
name|log
argument_list|(
name|LOG_WARNING
argument_list|,
name|errno
argument_list|,
literal|"can't leave group %s on interface %s"
argument_list|,
name|inet_fmt
argument_list|(
name|grp
argument_list|,
name|s1
argument_list|)
argument_list|,
name|inet_fmt
argument_list|(
name|ifa
argument_list|,
name|s2
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|k_init_dvmrp
parameter_list|()
block|{
if|if
condition|(
name|setsockopt
argument_list|(
name|igmp_socket
argument_list|,
name|IPPROTO_IP
argument_list|,
name|DVMRP_INIT
argument_list|,
operator|(
name|char
operator|*
operator|)
name|NULL
argument_list|,
literal|0
argument_list|)
operator|<
literal|0
condition|)
name|log
argument_list|(
name|LOG_ERR
argument_list|,
name|errno
argument_list|,
literal|"can't enable DVMRP routing in kernel"
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|k_stop_dvmrp
parameter_list|()
block|{
if|if
condition|(
name|setsockopt
argument_list|(
name|igmp_socket
argument_list|,
name|IPPROTO_IP
argument_list|,
name|DVMRP_DONE
argument_list|,
operator|(
name|char
operator|*
operator|)
name|NULL
argument_list|,
literal|0
argument_list|)
operator|<
literal|0
condition|)
name|log
argument_list|(
name|LOG_WARNING
argument_list|,
name|errno
argument_list|,
literal|"can't disable DVMRP routing in kernel"
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|k_add_vif
parameter_list|(
name|vifi
parameter_list|,
name|v
parameter_list|)
name|vifi_t
name|vifi
decl_stmt|;
name|struct
name|uvif
modifier|*
name|v
decl_stmt|;
block|{
name|struct
name|vifctl
name|vc
decl_stmt|;
name|vc
operator|.
name|vifc_vifi
operator|=
name|vifi
expr_stmt|;
name|vc
operator|.
name|vifc_flags
operator|=
name|v
operator|->
name|uv_flags
operator|&
name|VIFF_KERNEL_FLAGS
expr_stmt|;
name|vc
operator|.
name|vifc_threshold
operator|=
name|v
operator|->
name|uv_threshold
expr_stmt|;
name|vc
operator|.
name|vifc_lcl_addr
operator|.
name|s_addr
operator|=
name|v
operator|->
name|uv_lcl_addr
expr_stmt|;
name|vc
operator|.
name|vifc_rmt_addr
operator|.
name|s_addr
operator|=
name|v
operator|->
name|uv_rmt_addr
expr_stmt|;
if|if
condition|(
name|setsockopt
argument_list|(
name|igmp_socket
argument_list|,
name|IPPROTO_IP
argument_list|,
name|DVMRP_ADD_VIF
argument_list|,
operator|(
name|char
operator|*
operator|)
operator|&
name|vc
argument_list|,
sizeof|sizeof
argument_list|(
name|vc
argument_list|)
argument_list|)
operator|<
literal|0
condition|)
name|log
argument_list|(
name|LOG_ERR
argument_list|,
name|errno
argument_list|,
literal|"setsockopt DVMRP_ADD_VIF"
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|k_del_vif
parameter_list|(
name|vifi
parameter_list|)
name|vifi_t
name|vifi
decl_stmt|;
block|{
if|if
condition|(
name|setsockopt
argument_list|(
name|igmp_socket
argument_list|,
name|IPPROTO_IP
argument_list|,
name|DVMRP_DEL_VIF
argument_list|,
operator|(
name|char
operator|*
operator|)
operator|&
name|vifi
argument_list|,
sizeof|sizeof
argument_list|(
name|vifi
argument_list|)
argument_list|)
operator|<
literal|0
condition|)
name|log
argument_list|(
name|LOG_ERR
argument_list|,
name|errno
argument_list|,
literal|"setsockopt DVMRP_DEL_VIF"
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|k_add_group
parameter_list|(
name|vifi
parameter_list|,
name|group
parameter_list|)
name|vifi_t
name|vifi
decl_stmt|;
name|u_long
name|group
decl_stmt|;
block|{
name|struct
name|lgrplctl
name|lc
decl_stmt|;
name|lc
operator|.
name|lgc_vifi
operator|=
name|vifi
expr_stmt|;
name|lc
operator|.
name|lgc_gaddr
operator|.
name|s_addr
operator|=
name|group
expr_stmt|;
if|if
condition|(
name|setsockopt
argument_list|(
name|igmp_socket
argument_list|,
name|IPPROTO_IP
argument_list|,
name|DVMRP_ADD_LGRP
argument_list|,
operator|(
name|char
operator|*
operator|)
operator|&
name|lc
argument_list|,
sizeof|sizeof
argument_list|(
name|lc
argument_list|)
argument_list|)
operator|<
literal|0
condition|)
name|log
argument_list|(
name|LOG_WARNING
argument_list|,
name|errno
argument_list|,
literal|"setsockopt DVMRP_ADD_LGRP"
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|k_del_group
parameter_list|(
name|vifi
parameter_list|,
name|group
parameter_list|)
name|vifi_t
name|vifi
decl_stmt|;
name|u_long
name|group
decl_stmt|;
block|{
name|struct
name|lgrplctl
name|lc
decl_stmt|;
name|lc
operator|.
name|lgc_vifi
operator|=
name|vifi
expr_stmt|;
name|lc
operator|.
name|lgc_gaddr
operator|.
name|s_addr
operator|=
name|group
expr_stmt|;
if|if
condition|(
name|setsockopt
argument_list|(
name|igmp_socket
argument_list|,
name|IPPROTO_IP
argument_list|,
name|DVMRP_DEL_LGRP
argument_list|,
operator|(
name|char
operator|*
operator|)
operator|&
name|lc
argument_list|,
sizeof|sizeof
argument_list|(
name|lc
argument_list|)
argument_list|)
operator|<
literal|0
condition|)
name|log
argument_list|(
name|LOG_WARNING
argument_list|,
name|errno
argument_list|,
literal|"setsockopt DVMRP_DEL_LGRP"
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|k_add_route
parameter_list|(
name|r
parameter_list|)
name|struct
name|rtentry
modifier|*
name|r
decl_stmt|;
block|{
name|struct
name|mrtctl
name|mc
decl_stmt|;
name|mc
operator|.
name|mrtc_origin
operator|.
name|s_addr
operator|=
name|r
operator|->
name|rt_origin
expr_stmt|;
name|mc
operator|.
name|mrtc_originmask
operator|.
name|s_addr
operator|=
name|r
operator|->
name|rt_originmask
expr_stmt|;
name|mc
operator|.
name|mrtc_parent
operator|=
name|r
operator|->
name|rt_parent
expr_stmt|;
name|VIFM_COPY
argument_list|(
name|r
operator|->
name|rt_children
argument_list|,
name|mc
operator|.
name|mrtc_children
argument_list|)
expr_stmt|;
name|VIFM_COPY
argument_list|(
name|r
operator|->
name|rt_leaves
argument_list|,
name|mc
operator|.
name|mrtc_leaves
argument_list|)
expr_stmt|;
if|if
condition|(
name|setsockopt
argument_list|(
name|igmp_socket
argument_list|,
name|IPPROTO_IP
argument_list|,
name|DVMRP_ADD_MRT
argument_list|,
operator|(
name|char
operator|*
operator|)
operator|&
name|mc
argument_list|,
sizeof|sizeof
argument_list|(
name|mc
argument_list|)
argument_list|)
operator|<
literal|0
condition|)
name|log
argument_list|(
name|LOG_WARNING
argument_list|,
name|errno
argument_list|,
literal|"setsockopt DVMRP_ADD_MRT"
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|k_update_route
parameter_list|(
name|r
parameter_list|)
name|struct
name|rtentry
modifier|*
name|r
decl_stmt|;
block|{
name|k_add_route
argument_list|(
name|r
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|k_del_route
parameter_list|(
name|r
parameter_list|)
name|struct
name|rtentry
modifier|*
name|r
decl_stmt|;
block|{
name|struct
name|in_addr
name|orig
decl_stmt|;
name|orig
operator|.
name|s_addr
operator|=
name|r
operator|->
name|rt_origin
expr_stmt|;
if|if
condition|(
name|setsockopt
argument_list|(
name|igmp_socket
argument_list|,
name|IPPROTO_IP
argument_list|,
name|DVMRP_DEL_MRT
argument_list|,
operator|(
name|char
operator|*
operator|)
operator|&
name|orig
argument_list|,
sizeof|sizeof
argument_list|(
name|orig
argument_list|)
argument_list|)
operator|<
literal|0
condition|)
name|log
argument_list|(
name|LOG_WARNING
argument_list|,
name|errno
argument_list|,
literal|"setsockopt DVMRP_DEL_MRT"
argument_list|)
expr_stmt|;
block|}
end_function

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Warning: extremely XXX  * fake syslog to write to stderr, for standalone test version of init  */
end_comment

begin_ifdef
ifdef|#
directive|ifdef
name|FAKE_SYSLOG
end_ifdef

begin_include
include|#
directive|include
file|<unistd.h>
end_include

begin_include
include|#
directive|include
file|<string.h>
end_include

begin_include
include|#
directive|include
file|<stdarg.h>
end_include

begin_include
include|#
directive|include
file|<errno.h>
end_include

begin_include
include|#
directive|include
file|<sys/file.h>
end_include

begin_ifdef
ifdef|#
directive|ifdef
name|TESTRUN
end_ifdef

begin_define
define|#
directive|define
name|FAKE_LOGFILE
value|"/dev/tty"
end_define

begin_else
else|#
directive|else
end_else

begin_define
define|#
directive|define
name|FAKE_LOGFILE
value|"/dev/console"
end_define

begin_endif
endif|#
directive|endif
end_endif

begin_function
specifier|static
name|char
modifier|*
name|itoa
parameter_list|(
name|i
parameter_list|)
name|int
name|i
decl_stmt|;
block|{
specifier|static
name|char
name|buf
index|[
literal|12
index|]
decl_stmt|;
name|char
modifier|*
name|s
decl_stmt|;
name|int
name|minflg
init|=
literal|0
decl_stmt|;
name|s
operator|=
operator|&
name|buf
index|[
literal|11
index|]
expr_stmt|;
operator|*
name|s
operator|=
literal|'\0'
expr_stmt|;
if|if
condition|(
name|i
operator|<
literal|0
condition|)
name|minflg
operator|=
literal|1
operator|,
name|i
operator|=
operator|-
name|i
expr_stmt|;
do|do
block|{
operator|*
operator|(
operator|--
name|s
operator|)
operator|=
operator|(
name|i
operator|%
literal|10
operator|)
operator|+
literal|'0'
expr_stmt|;
name|i
operator|/=
literal|10
expr_stmt|;
block|}
do|while
condition|(
name|i
condition|)
do|;
if|if
condition|(
name|minflg
condition|)
operator|*
operator|(
operator|--
name|s
operator|)
operator|=
literal|'-'
expr_stmt|;
return|return
operator|(
name|s
operator|)
return|;
block|}
end_function

begin_decl_stmt
specifier|static
name|int
name|_log_fd
init|=
literal|2
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
specifier|const
name|char
modifier|*
name|_log_id
init|=
literal|""
decl_stmt|;
end_decl_stmt

begin_function
name|void
name|openlog
parameter_list|(
name|ident
parameter_list|,
name|logopt
parameter_list|,
name|facility
parameter_list|)
specifier|const
name|char
modifier|*
name|ident
decl_stmt|;
name|int
name|logopt
decl_stmt|,
name|facility
decl_stmt|;
block|{
if|if
condition|(
name|ident
condition|)
name|_log_id
operator|=
name|ident
expr_stmt|;
if|if
condition|(
name|_log_fd
operator|>=
literal|0
condition|)
name|close
argument_list|(
name|_log_fd
argument_list|)
expr_stmt|;
name|_log_fd
operator|=
name|open
argument_list|(
name|FAKE_LOGFILE
argument_list|,
name|O_WRONLY
operator||
name|O_NONBLOCK
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|vsyslog
parameter_list|(
name|int
name|pri
parameter_list|,
specifier|const
name|char
modifier|*
name|fmt
parameter_list|,
name|va_list
name|ap
parameter_list|)
block|{
specifier|const
name|char
modifier|*
name|s
decl_stmt|,
modifier|*
name|t
decl_stmt|;
name|int
name|saved_errno
init|=
name|errno
decl_stmt|;
if|if
condition|(
name|write
argument_list|(
name|_log_fd
argument_list|,
literal|""
argument_list|,
literal|0
argument_list|)
operator|<
literal|0
condition|)
name|openlog
argument_list|(
name|NULL
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|write
argument_list|(
name|_log_fd
argument_list|,
name|_log_id
argument_list|,
name|strlen
argument_list|(
name|_log_id
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|*
name|_log_id
condition|)
name|write
argument_list|(
name|_log_fd
argument_list|,
literal|": "
argument_list|,
literal|2
argument_list|)
expr_stmt|;
for|for
control|(
name|s
operator|=
name|fmt
init|;
operator|*
name|s
condition|;
name|s
operator|++
control|)
if|if
condition|(
operator|*
name|s
operator|==
literal|'%'
condition|)
switch|switch
condition|(
operator|*
operator|(
operator|++
name|s
operator|)
condition|)
block|{
case|case
literal|'\0'
case|:
name|s
operator|--
expr_stmt|;
break|break;
case|case
literal|'%'
case|:
name|write
argument_list|(
name|_log_fd
argument_list|,
name|s
argument_list|,
literal|1
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'s'
case|:
name|t
operator|=
name|va_arg
argument_list|(
name|ap
argument_list|,
name|char
operator|*
argument_list|)
expr_stmt|;
name|write
argument_list|(
name|_log_fd
argument_list|,
name|t
argument_list|,
name|strlen
argument_list|(
name|t
argument_list|)
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'m'
case|:
ifdef|#
directive|ifdef
name|SMALL
name|write
argument_list|(
name|_log_fd
argument_list|,
literal|"Error "
argument_list|,
literal|6
argument_list|)
expr_stmt|;
name|t
operator|=
name|itoa
argument_list|(
name|saved_errno
argument_list|)
expr_stmt|;
else|#
directive|else
name|t
operator|=
name|strerror
argument_list|(
name|saved_errno
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|write
argument_list|(
name|_log_fd
argument_list|,
name|t
argument_list|,
name|strlen
argument_list|(
name|t
argument_list|)
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'d'
case|:
name|t
operator|=
name|itoa
argument_list|(
name|va_arg
argument_list|(
name|ap
argument_list|,
name|int
argument_list|)
argument_list|)
expr_stmt|;
name|write
argument_list|(
name|_log_fd
argument_list|,
name|t
argument_list|,
name|strlen
argument_list|(
name|t
argument_list|)
argument_list|)
expr_stmt|;
break|break;
default|default:
name|write
argument_list|(
name|_log_fd
argument_list|,
name|s
operator|-
literal|1
argument_list|,
literal|2
argument_list|)
expr_stmt|;
block|}
else|else
name|write
argument_list|(
name|_log_fd
argument_list|,
name|s
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|write
argument_list|(
name|_log_fd
argument_list|,
literal|"\n"
argument_list|,
literal|1
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|syslog
parameter_list|(
name|int
name|pri
parameter_list|,
specifier|const
name|char
modifier|*
name|fmt
parameter_list|,
modifier|...
parameter_list|)
block|{
name|va_list
name|ap
decl_stmt|;
name|va_start
argument_list|(
name|ap
argument_list|,
name|fmt
argument_list|)
expr_stmt|;
name|vsyslog
argument_list|(
name|pri
argument_list|,
name|fmt
argument_list|,
name|ap
argument_list|)
expr_stmt|;
name|va_end
argument_list|(
name|ap
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|closelog
parameter_list|(
name|void
parameter_list|)
block|{
name|close
argument_list|(
name|_log_fd
argument_list|)
expr_stmt|;
name|_log_fd
operator|=
operator|-
literal|1
expr_stmt|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

end_unit


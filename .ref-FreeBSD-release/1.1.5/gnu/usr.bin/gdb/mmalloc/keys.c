begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/* Access for application keys in mmap'd malloc managed region.    Copyright 1992 Free Software Foundation, Inc.     Contributed by Fred Fish at Cygnus Support.   fnf@cygnus.com  This file is part of the GNU C Library.  The GNU C Library is free software; you can redistribute it and/or modify it under the terms of the GNU Library General Public License as published by the Free Software Foundation; either version 2 of the License, or (at your option) any later version.  The GNU C Library is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU Library General Public License for more details.  You should have received a copy of the GNU Library General Public License along with the GNU C Library; see the file COPYING.LIB.  If not, write to the Free Software Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.  */
end_comment

begin_comment
comment|/* This module provides access to some keys that the application can use to    provide persistent access to locations in the mapped memory section.    The intent is that these keys are to be used sparingly as sort of    persistent global variables which the application can use to reinitialize    access to data in the mapped region.     For the moment, these keys are simply stored in the malloc descriptor    itself, in an array of fixed length.  This should be fixed so that there    can be an unlimited number of keys, possibly using a multilevel access    scheme of some sort. */
end_comment

begin_include
include|#
directive|include
file|"mmalloc.h"
end_include

begin_function
name|int
name|mmalloc_setkey
parameter_list|(
name|md
parameter_list|,
name|keynum
parameter_list|,
name|key
parameter_list|)
name|PTR
name|md
decl_stmt|;
name|int
name|keynum
decl_stmt|;
name|PTR
name|key
decl_stmt|;
block|{
name|struct
name|mdesc
modifier|*
name|mdp
init|=
operator|(
expr|struct
name|mdesc
operator|*
operator|)
name|md
decl_stmt|;
name|int
name|result
init|=
literal|0
decl_stmt|;
if|if
condition|(
operator|(
name|mdp
operator|!=
name|NULL
operator|)
operator|&&
operator|(
name|keynum
operator|>=
literal|0
operator|)
operator|&&
operator|(
name|keynum
operator|<
name|MMALLOC_KEYS
operator|)
condition|)
block|{
name|mdp
operator|->
name|keys
index|[
name|keynum
index|]
operator|=
name|key
expr_stmt|;
name|result
operator|++
expr_stmt|;
block|}
return|return
operator|(
name|result
operator|)
return|;
block|}
end_function

begin_function
name|PTR
name|mmalloc_getkey
parameter_list|(
name|md
parameter_list|,
name|keynum
parameter_list|)
name|PTR
name|md
decl_stmt|;
name|int
name|keynum
decl_stmt|;
block|{
name|struct
name|mdesc
modifier|*
name|mdp
init|=
operator|(
expr|struct
name|mdesc
operator|*
operator|)
name|md
decl_stmt|;
name|PTR
name|keyval
init|=
name|NULL
decl_stmt|;
if|if
condition|(
operator|(
name|mdp
operator|!=
name|NULL
operator|)
operator|&&
operator|(
name|keynum
operator|>=
literal|0
operator|)
operator|&&
operator|(
name|keynum
operator|<
name|MMALLOC_KEYS
operator|)
condition|)
block|{
name|keyval
operator|=
name|mdp
operator|->
name|keys
index|[
name|keynum
index|]
expr_stmt|;
block|}
return|return
operator|(
name|keyval
operator|)
return|;
block|}
end_function

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/* Functions for memory limit warnings.    Copyright (C) 1990, 1992 Free Software Foundation, Inc.   This file is part of the GNU C Library.  The GNU C Library is free software; you can redistribute it and/or modify it under the terms of the GNU Library General Public License as published by the Free Software Foundation; either version 2 of the License, or (at your option) any later version.  The GNU C Library is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU Library General Public License for more details.  You should have received a copy of the GNU Library General Public License along with the GNU C Library; see the file COPYING.LIB.  If not, write to the Free Software Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.  */
end_comment

begin_ifdef
ifdef|#
directive|ifdef
name|emacs
end_ifdef

begin_include
include|#
directive|include
file|"config.h"
end_include

begin_include
include|#
directive|include
file|"lisp.h"
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_ifndef
ifndef|#
directive|ifndef
name|emacs
end_ifndef

begin_include
include|#
directive|include
file|<stddef.h>
end_include

begin_typedef
typedef|typedef
name|size_t
name|SIZE
typedef|;
end_typedef

begin_typedef
typedef|typedef
name|void
modifier|*
name|POINTER
typedef|;
end_typedef

begin_define
define|#
directive|define
name|EXCEEDS_LISP_PTR
parameter_list|(
name|x
parameter_list|)
value|0
end_define

begin_endif
endif|#
directive|endif
end_endif

begin_include
include|#
directive|include
file|"mem-limits.h"
end_include

begin_comment
comment|/*   Level number of warnings already issued.   0 -- no warnings issued.   1 -- 75% warning already issued.   2 -- 85% warning already issued.   3 -- 95% warning issued; keep warning frequently. */
end_comment

begin_decl_stmt
specifier|static
name|int
name|warnlevel
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* Function to call to issue a warning;    0 means don't issue them.  */
end_comment

begin_function_decl
specifier|static
name|void
function_decl|(
modifier|*
name|warn_function
function_decl|)
parameter_list|()
function_decl|;
end_function_decl

begin_comment
comment|/* Get more memory space, complaining if we're near the end. */
end_comment

begin_function
specifier|static
name|void
name|check_memory_limits
parameter_list|()
block|{
specifier|extern
name|POINTER
function_decl|(
modifier|*
name|__morecore
function_decl|)
parameter_list|()
function_decl|;
specifier|register
name|POINTER
name|cp
decl_stmt|;
name|int
name|five_percent
decl_stmt|;
name|int
name|data_size
decl_stmt|;
if|if
condition|(
name|lim_data
operator|==
literal|0
condition|)
name|get_lim_data
argument_list|()
expr_stmt|;
name|five_percent
operator|=
name|lim_data
operator|/
literal|20
expr_stmt|;
comment|/* Find current end of memory and issue warning if getting near max */
name|cp
operator|=
operator|(
name|char
operator|*
operator|)
call|(
modifier|*
name|__morecore
call|)
argument_list|(
literal|0
argument_list|)
expr_stmt|;
name|data_size
operator|=
operator|(
name|char
operator|*
operator|)
name|cp
operator|-
operator|(
name|char
operator|*
operator|)
name|data_space_start
expr_stmt|;
if|if
condition|(
name|warn_function
condition|)
switch|switch
condition|(
name|warnlevel
condition|)
block|{
case|case
literal|0
case|:
if|if
condition|(
name|data_size
operator|>
name|five_percent
operator|*
literal|15
condition|)
block|{
name|warnlevel
operator|++
expr_stmt|;
call|(
modifier|*
name|warn_function
call|)
argument_list|(
literal|"Warning: past 75% of memory limit"
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
literal|1
case|:
if|if
condition|(
name|data_size
operator|>
name|five_percent
operator|*
literal|17
condition|)
block|{
name|warnlevel
operator|++
expr_stmt|;
call|(
modifier|*
name|warn_function
call|)
argument_list|(
literal|"Warning: past 85% of memory limit"
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
literal|2
case|:
if|if
condition|(
name|data_size
operator|>
name|five_percent
operator|*
literal|19
condition|)
block|{
name|warnlevel
operator|++
expr_stmt|;
call|(
modifier|*
name|warn_function
call|)
argument_list|(
literal|"Warning: past 95% of memory limit"
argument_list|)
expr_stmt|;
block|}
break|break;
default|default:
call|(
modifier|*
name|warn_function
call|)
argument_list|(
literal|"Warning: past acceptable memory limits"
argument_list|)
expr_stmt|;
break|break;
block|}
comment|/* If we go down below 70% full, issue another 75% warning      when we go up again.  */
if|if
condition|(
name|data_size
operator|<
name|five_percent
operator|*
literal|14
condition|)
name|warnlevel
operator|=
literal|0
expr_stmt|;
comment|/* If we go down below 80% full, issue another 85% warning      when we go up again.  */
elseif|else
if|if
condition|(
name|warnlevel
operator|>
literal|1
operator|&&
name|data_size
operator|<
name|five_percent
operator|*
literal|16
condition|)
name|warnlevel
operator|=
literal|1
expr_stmt|;
comment|/* If we go down below 90% full, issue another 95% warning      when we go up again.  */
elseif|else
if|if
condition|(
name|warnlevel
operator|>
literal|2
operator|&&
name|data_size
operator|<
name|five_percent
operator|*
literal|18
condition|)
name|warnlevel
operator|=
literal|2
expr_stmt|;
if|if
condition|(
name|EXCEEDS_LISP_PTR
argument_list|(
name|cp
argument_list|)
condition|)
call|(
modifier|*
name|warn_function
call|)
argument_list|(
literal|"Warning: memory in use exceeds lisp pointer size"
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* Cause reinitialization based on job parameters;    also declare where the end of pure storage is. */
end_comment

begin_decl_stmt
name|void
name|memory_warnings
argument_list|(
name|start
argument_list|,
name|warnfun
argument_list|)
name|POINTER
name|start
decl_stmt|;
end_decl_stmt

begin_function_decl
name|void
function_decl|(
modifier|*
name|warnfun
function_decl|)
parameter_list|()
function_decl|;
end_function_decl

begin_block
block|{
specifier|extern
name|void
function_decl|(
modifier|*
name|__after_morecore_hook
function_decl|)
parameter_list|()
function_decl|;
comment|/* From gmalloc.c */
if|if
condition|(
name|start
condition|)
name|data_space_start
operator|=
name|start
expr_stmt|;
else|else
name|data_space_start
operator|=
name|start_of_data
argument_list|()
expr_stmt|;
name|warn_function
operator|=
name|warnfun
expr_stmt|;
name|__after_morecore_hook
operator|=
name|check_memory_limits
expr_stmt|;
block|}
end_block

end_unit


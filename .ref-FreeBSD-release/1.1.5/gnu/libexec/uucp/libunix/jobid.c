begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/* jobid.c    Convert file names to jobids and vice versa.     Copyright (C) 1991, 1992 Ian Lance Taylor     This file is part of the Taylor UUCP package.     This program is free software; you can redistribute it and/or    modify it under the terms of the GNU General Public License as    published by the Free Software Foundation; either version 2 of the    License, or (at your option) any later version.     This program is distributed in the hope that it will be useful, but    WITHOUT ANY WARRANTY; without even the implied warranty of    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU    General Public License for more details.     You should have received a copy of the GNU General Public License    along with this program; if not, write to the Free Software    Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.     The author of the program may be contacted at ian@airs.com or    c/o Cygnus Support, Building 200, 1 Kendall Square, Cambridge, MA 02139.    */
end_comment

begin_include
include|#
directive|include
file|"uucp.h"
end_include

begin_include
include|#
directive|include
file|"uuconf.h"
end_include

begin_include
include|#
directive|include
file|"uudefs.h"
end_include

begin_include
include|#
directive|include
file|"sysdep.h"
end_include

begin_include
include|#
directive|include
file|"system.h"
end_include

begin_escape
end_escape

begin_comment
comment|/* Translate a file name and an associated system into a job id.    These job ids are used by uustat.  We use the system name attached    to the grade and sequence number.  This won't work correctly if the    file name was actually created by some other version of uucp that    uses a different length for the sequence number.  Too bad.  */
end_comment

begin_function
name|char
modifier|*
name|zsfile_to_jobid
parameter_list|(
name|qsys
parameter_list|,
name|zfile
parameter_list|,
name|bgrade
parameter_list|)
specifier|const
name|struct
name|uuconf_system
modifier|*
name|qsys
decl_stmt|;
specifier|const
name|char
modifier|*
name|zfile
decl_stmt|;
name|int
name|bgrade
decl_stmt|;
block|{
name|size_t
name|clen
decl_stmt|;
name|char
modifier|*
name|zret
decl_stmt|;
name|clen
operator|=
name|strlen
argument_list|(
name|qsys
operator|->
name|uuconf_zname
argument_list|)
expr_stmt|;
name|zret
operator|=
name|zbufalc
argument_list|(
name|clen
operator|+
name|CSEQLEN
operator|+
literal|2
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
name|zret
argument_list|,
name|qsys
operator|->
name|uuconf_zname
argument_list|,
name|clen
argument_list|)
expr_stmt|;
name|zret
index|[
name|clen
index|]
operator|=
name|bgrade
expr_stmt|;
name|memcpy
argument_list|(
name|zret
operator|+
name|clen
operator|+
literal|1
argument_list|,
name|zfile
operator|+
name|strlen
argument_list|(
name|zfile
argument_list|)
operator|-
name|CSEQLEN
argument_list|,
name|CSEQLEN
operator|+
literal|1
argument_list|)
expr_stmt|;
return|return
name|zret
return|;
block|}
end_function

begin_comment
comment|/* Turn a job id back into a file name.  */
end_comment

begin_function
name|char
modifier|*
name|zsjobid_to_file
parameter_list|(
name|zid
parameter_list|,
name|pzsystem
parameter_list|,
name|pbgrade
parameter_list|)
specifier|const
name|char
modifier|*
name|zid
decl_stmt|;
name|char
modifier|*
modifier|*
name|pzsystem
decl_stmt|;
name|char
modifier|*
name|pbgrade
decl_stmt|;
block|{
name|size_t
name|clen
decl_stmt|;
specifier|const
name|char
modifier|*
name|zend
decl_stmt|;
name|char
modifier|*
name|zsys
decl_stmt|;
name|char
name|abname
index|[
name|CSEQLEN
operator|+
literal|11
index|]
decl_stmt|;
name|char
modifier|*
name|zret
decl_stmt|;
name|clen
operator|=
name|strlen
argument_list|(
name|zid
argument_list|)
expr_stmt|;
if|if
condition|(
name|clen
operator|<=
name|CSEQLEN
condition|)
block|{
name|ulog
argument_list|(
name|LOG_ERROR
argument_list|,
literal|"%s: Bad job id"
argument_list|,
name|zid
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|zend
operator|=
name|zid
operator|+
name|clen
operator|-
name|CSEQLEN
operator|-
literal|1
expr_stmt|;
name|zsys
operator|=
name|zbufalc
argument_list|(
name|clen
operator|-
name|CSEQLEN
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
name|zsys
argument_list|,
name|zid
argument_list|,
name|clen
operator|-
name|CSEQLEN
operator|-
literal|1
argument_list|)
expr_stmt|;
name|zsys
index|[
name|clen
operator|-
name|CSEQLEN
operator|-
literal|1
index|]
operator|=
literal|'\0'
expr_stmt|;
comment|/* This must correspond to zsfile_name.  */
if|#
directive|if
operator|!
name|SPOOLDIR_TAYLOR
name|sprintf
argument_list|(
name|abname
argument_list|,
literal|"C.%.7s%s"
argument_list|,
name|zsys
argument_list|,
name|zend
argument_list|)
expr_stmt|;
else|#
directive|else
name|sprintf
argument_list|(
name|abname
argument_list|,
literal|"C.%s"
argument_list|,
name|zend
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|zret
operator|=
name|zsfind_file
argument_list|(
name|abname
argument_list|,
name|zsys
argument_list|,
operator|*
name|zend
argument_list|)
expr_stmt|;
if|if
condition|(
name|zret
operator|!=
name|NULL
operator|&&
name|pzsystem
operator|!=
name|NULL
condition|)
operator|*
name|pzsystem
operator|=
name|zsys
expr_stmt|;
else|else
name|ubuffree
argument_list|(
name|zsys
argument_list|)
expr_stmt|;
if|if
condition|(
name|pbgrade
operator|!=
name|NULL
condition|)
operator|*
name|pbgrade
operator|=
operator|*
name|zend
expr_stmt|;
return|return
name|zret
return|;
block|}
end_function

end_unit


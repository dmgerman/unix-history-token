begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/************************************************************************** NETBOOT -  BOOTP/TFTP Bootstrap Program  Author: Martin Renters   Date: May/94   This code is based heavily on David Greenman's if_ed.c driver   Copyright (C) 1993-1994, David Greenman, Martin Renters.   This software may be used, modified, copied, distributed, and sold, in   both source and binary form provided that the above copyright and these   terms are retained. Under no circumstances are the authors responsible for   the proper functioning of this software, nor do the authors assume any   responsibility for damages incurred with its use.   **************************************************************************/
end_comment

begin_include
include|#
directive|include
file|"netboot.h"
end_include

begin_include
include|#
directive|include
file|"ether.h"
end_include

begin_decl_stmt
name|unsigned
name|short
name|eth_nic_base
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|unsigned
name|short
name|eth_asic_base
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|unsigned
name|char
name|eth_tx_start
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|unsigned
name|char
name|eth_laar
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|unsigned
name|char
name|eth_flags
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|unsigned
name|char
name|eth_vendor
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|unsigned
name|char
name|eth_memsize
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|unsigned
name|char
modifier|*
name|eth_bmem
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|unsigned
name|char
modifier|*
name|eth_node_addr
decl_stmt|;
end_decl_stmt

begin_comment
comment|/************************************************************************** The following two variables are used externally **************************************************************************/
end_comment

begin_decl_stmt
name|char
name|packet
index|[
name|ETH_MAX_PACKET
index|]
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|packetlen
decl_stmt|;
end_decl_stmt

begin_comment
comment|/************************************************************************** ETH_PROBE - Look for an adapter **************************************************************************/
end_comment

begin_macro
name|eth_probe
argument_list|()
end_macro

begin_block
block|{
name|int
name|i
decl_stmt|;
name|struct
name|wd_board
modifier|*
name|brd
decl_stmt|;
name|char
modifier|*
name|name
decl_stmt|;
name|unsigned
name|short
name|chksum
decl_stmt|;
name|unsigned
name|char
name|c
decl_stmt|;
name|eth_vendor
operator|=
name|VENDOR_NONE
expr_stmt|;
ifdef|#
directive|ifdef
name|INCLUDE_WD
comment|/****************************************************************** 	Search for WD/SMC cards 	******************************************************************/
for|for
control|(
name|eth_asic_base
operator|=
name|WD_LOW_BASE
init|;
name|eth_asic_base
operator|<=
name|WD_HIGH_BASE
condition|;
name|eth_asic_base
operator|+=
literal|0x20
control|)
block|{
name|chksum
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|8
init|;
name|i
operator|<
literal|16
condition|;
name|i
operator|++
control|)
name|chksum
operator|+=
name|inb
argument_list|(
name|i
operator|+
name|eth_asic_base
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|chksum
operator|&
literal|0x00FF
operator|)
operator|==
literal|0x00FF
condition|)
break|break;
block|}
if|if
condition|(
name|eth_asic_base
operator|<=
name|WD_HIGH_BASE
condition|)
block|{
comment|/* We've found a board */
name|eth_vendor
operator|=
name|VENDOR_WD
expr_stmt|;
name|eth_nic_base
operator|=
name|eth_asic_base
operator|+
name|WD_NIC_ADDR
expr_stmt|;
name|c
operator|=
name|inb
argument_list|(
name|eth_asic_base
operator|+
name|WD_BID
argument_list|)
expr_stmt|;
comment|/* Get board id */
for|for
control|(
name|brd
operator|=
name|wd_boards
init|;
name|brd
operator|->
name|name
condition|;
name|brd
operator|++
control|)
if|if
condition|(
name|brd
operator|->
name|id
operator|==
name|c
condition|)
break|break;
if|if
condition|(
operator|!
name|brd
operator|->
name|name
condition|)
block|{
name|printf
argument_list|(
literal|"\r\nUnknown Ethernet type %x\r\n"
argument_list|,
name|c
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
comment|/* Unknown type */
block|}
name|eth_flags
operator|=
name|brd
operator|->
name|flags
expr_stmt|;
name|eth_memsize
operator|=
name|brd
operator|->
name|memsize
expr_stmt|;
name|eth_tx_start
operator|=
literal|0
expr_stmt|;
if|if
condition|(
operator|(
name|c
operator|==
name|TYPE_WD8013EP
operator|)
operator|&&
operator|(
name|inb
argument_list|(
name|eth_asic_base
operator|+
name|WD_ICR
argument_list|)
operator|&
name|WD_ICR_16BIT
operator|)
condition|)
block|{
name|eth_flags
operator|=
name|FLAG_16BIT
expr_stmt|;
name|eth_memsize
operator|=
name|MEM_16384
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|c
operator|&
name|WD_SOFTCONFIG
operator|)
operator|&&
operator|(
operator|!
operator|(
name|eth_flags
operator|&
name|FLAG_790
operator|)
operator|)
condition|)
block|{
name|eth_bmem
operator|=
operator|(
name|char
operator|*
operator|)
operator|(
literal|0x80000
operator||
operator|(
operator|(
name|inb
argument_list|(
name|eth_asic_base
operator|+
name|WD_MSR
argument_list|)
operator|&
literal|0x3F
operator|)
operator|<<
literal|13
operator|)
operator|)
expr_stmt|;
block|}
else|else
name|eth_bmem
operator|=
operator|(
name|char
operator|*
operator|)
name|WD_DEFAULT_MEM
expr_stmt|;
name|outb
argument_list|(
name|eth_asic_base
operator|+
name|WD_MSR
argument_list|,
literal|0x80
argument_list|)
expr_stmt|;
comment|/* Reset */
name|printf
argument_list|(
literal|"\r\n%s base 0x%x, memory 0x%X, addr "
argument_list|,
name|brd
operator|->
name|name
argument_list|,
name|eth_asic_base
argument_list|,
name|eth_bmem
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|6
condition|;
name|i
operator|++
control|)
name|printhb
argument_list|(
call|(
name|int
call|)
argument_list|(
name|arptable
index|[
name|ARP_CLIENT
index|]
operator|.
name|node
index|[
name|i
index|]
operator|=
name|inb
argument_list|(
name|i
operator|+
name|eth_asic_base
operator|+
name|WD_LAR
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|eth_flags
operator|&
name|FLAG_790
condition|)
block|{
name|outb
argument_list|(
name|eth_asic_base
operator|+
name|WD_MSR
argument_list|,
name|WD_MSR_MENB
argument_list|)
expr_stmt|;
name|outb
argument_list|(
name|eth_asic_base
operator|+
literal|0x04
argument_list|,
operator|(
name|inb
argument_list|(
name|eth_asic_base
operator|+
literal|0x04
argument_list|)
operator||
literal|0x80
operator|)
argument_list|)
expr_stmt|;
name|outb
argument_list|(
name|eth_asic_base
operator|+
literal|0x0B
argument_list|,
operator|(
operator|(
operator|(
name|unsigned
operator|)
name|eth_bmem
operator|>>
literal|13
operator|)
operator|&
literal|0x0F
operator|)
operator||
operator|(
operator|(
operator|(
name|unsigned
operator|)
name|eth_bmem
operator|>>
literal|11
operator|)
operator|&
literal|0x40
operator|)
operator||
operator|(
name|inb
argument_list|(
name|eth_asic_base
operator|+
literal|0x0B
argument_list|)
operator|&
literal|0x0B
operator|)
argument_list|)
expr_stmt|;
name|outb
argument_list|(
name|eth_asic_base
operator|+
literal|0x04
argument_list|,
operator|(
name|inb
argument_list|(
name|eth_asic_base
operator|+
literal|0x04
argument_list|)
operator|&
operator|~
literal|0x80
operator|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|outb
argument_list|(
name|eth_asic_base
operator|+
name|WD_MSR
argument_list|,
operator|(
operator|(
operator|(
name|unsigned
operator|)
name|eth_bmem
operator|>>
literal|13
operator|)
operator|&
literal|0x3F
operator|)
operator||
literal|0x40
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|eth_flags
operator|&
name|FLAG_16BIT
condition|)
block|{
if|if
condition|(
name|eth_flags
operator|&
name|FLAG_790
condition|)
block|{
name|eth_laar
operator|=
name|inb
argument_list|(
name|eth_asic_base
operator|+
name|WD_LAAR
argument_list|)
expr_stmt|;
name|outb
argument_list|(
name|eth_asic_base
operator|+
name|WD_LAAR
argument_list|,
name|WD_LAAR_M16EN
argument_list|)
expr_stmt|;
name|inb
argument_list|(
literal|0x84
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|outb
argument_list|(
name|eth_asic_base
operator|+
name|WD_LAAR
argument_list|,
operator|(
name|eth_laar
operator|=
name|WD_LAAR_M16EN
operator||
name|WD_LAAR_L16EN
operator||
literal|1
operator|)
argument_list|)
expr_stmt|;
block|}
block|}
name|printf
argument_list|(
literal|"\r\n"
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
ifdef|#
directive|ifdef
name|INCLUDE_NE
comment|/****************************************************************** 	Search for NE1000/2000 if no WD/SMC cards 	******************************************************************/
if|if
condition|(
name|eth_vendor
operator|!=
name|VENDOR_WD
condition|)
block|{
name|char
name|romdata
index|[
literal|16
index|]
decl_stmt|,
name|testbuf
index|[
literal|32
index|]
decl_stmt|;
name|char
name|test
index|[]
init|=
literal|"NE1000/2000 memory"
decl_stmt|;
name|eth_bmem
operator|=
operator|(
name|char
operator|*
operator|)
literal|0
expr_stmt|;
comment|/* No shared memory */
name|eth_asic_base
operator|=
name|NE_BASE
operator|+
name|NE_ASIC_OFFSET
expr_stmt|;
name|eth_nic_base
operator|=
name|NE_BASE
expr_stmt|;
name|eth_vendor
operator|=
name|VENDOR_NOVELL
expr_stmt|;
name|eth_flags
operator|=
name|FLAG_PIO
expr_stmt|;
name|eth_memsize
operator|=
name|MEM_16384
expr_stmt|;
name|eth_tx_start
operator|=
literal|32
expr_stmt|;
name|c
operator|=
name|inb
argument_list|(
name|eth_asic_base
operator|+
name|NE_RESET
argument_list|)
expr_stmt|;
name|outb
argument_list|(
name|eth_asic_base
operator|+
name|NE_RESET
argument_list|,
name|c
argument_list|)
expr_stmt|;
name|inb
argument_list|(
literal|0x84
argument_list|)
expr_stmt|;
name|outb
argument_list|(
name|eth_nic_base
operator|+
name|D8390_P0_COMMAND
argument_list|,
name|D8390_COMMAND_STP
operator||
name|D8390_COMMAND_RD2
argument_list|)
expr_stmt|;
name|outb
argument_list|(
name|eth_nic_base
operator|+
name|D8390_P0_RCR
argument_list|,
name|D8390_RCR_MON
argument_list|)
expr_stmt|;
name|outb
argument_list|(
name|eth_nic_base
operator|+
name|D8390_P0_DCR
argument_list|,
name|D8390_DCR_FT1
operator||
name|D8390_DCR_LS
argument_list|)
expr_stmt|;
name|outb
argument_list|(
name|eth_nic_base
operator|+
name|D8390_P0_PSTART
argument_list|,
name|MEM_8192
argument_list|)
expr_stmt|;
name|outb
argument_list|(
name|eth_nic_base
operator|+
name|D8390_P0_PSTOP
argument_list|,
name|MEM_16384
argument_list|)
expr_stmt|;
name|eth_pio_write
argument_list|(
name|test
argument_list|,
literal|8192
argument_list|,
sizeof|sizeof
argument_list|(
name|test
argument_list|)
argument_list|)
expr_stmt|;
name|eth_pio_read
argument_list|(
literal|8192
argument_list|,
name|testbuf
argument_list|,
sizeof|sizeof
argument_list|(
name|test
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|bcompare
argument_list|(
name|test
argument_list|,
name|testbuf
argument_list|,
sizeof|sizeof
argument_list|(
name|test
argument_list|)
argument_list|)
condition|)
block|{
name|eth_flags
operator||=
name|FLAG_16BIT
expr_stmt|;
name|eth_memsize
operator|=
name|MEM_32768
expr_stmt|;
name|eth_tx_start
operator|=
literal|64
expr_stmt|;
name|outb
argument_list|(
name|eth_nic_base
operator|+
name|D8390_P0_DCR
argument_list|,
name|D8390_DCR_WTS
operator||
name|D8390_DCR_FT1
operator||
name|D8390_DCR_LS
argument_list|)
expr_stmt|;
name|outb
argument_list|(
name|eth_nic_base
operator|+
name|D8390_P0_PSTART
argument_list|,
name|MEM_16384
argument_list|)
expr_stmt|;
name|outb
argument_list|(
name|eth_nic_base
operator|+
name|D8390_P0_PSTOP
argument_list|,
name|MEM_32768
argument_list|)
expr_stmt|;
name|eth_pio_write
argument_list|(
name|test
argument_list|,
literal|16384
argument_list|,
sizeof|sizeof
argument_list|(
name|test
argument_list|)
argument_list|)
expr_stmt|;
name|eth_pio_read
argument_list|(
literal|16384
argument_list|,
name|testbuf
argument_list|,
sizeof|sizeof
argument_list|(
name|test
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|bcompare
argument_list|(
name|testbuf
argument_list|,
name|test
argument_list|,
sizeof|sizeof
argument_list|(
name|test
argument_list|)
argument_list|)
condition|)
return|return
operator|(
literal|0
operator|)
return|;
block|}
name|eth_pio_read
argument_list|(
literal|0
argument_list|,
name|romdata
argument_list|,
literal|16
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\r\nNE1000/NE2000 base 0x%x, addr "
argument_list|,
name|eth_nic_base
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|6
condition|;
name|i
operator|++
control|)
name|printhb
argument_list|(
call|(
name|int
call|)
argument_list|(
name|arptable
index|[
name|ARP_CLIENT
index|]
operator|.
name|node
index|[
name|i
index|]
operator|=
name|romdata
index|[
name|i
operator|+
operator|(
operator|(
name|eth_flags
operator|&
name|FLAG_16BIT
operator|)
condition|?
name|i
else|:
literal|0
operator|)
index|]
argument_list|)
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\r\n"
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
if|if
condition|(
name|eth_vendor
operator|==
name|VENDOR_NONE
condition|)
return|return
operator|(
literal|0
operator|)
return|;
name|eth_node_addr
operator|=
name|arptable
index|[
name|ARP_CLIENT
index|]
operator|.
name|node
expr_stmt|;
name|eth_reset
argument_list|()
expr_stmt|;
return|return
operator|(
name|eth_vendor
operator|)
return|;
block|}
end_block

begin_comment
comment|/************************************************************************** ETH_RESET - Reset adapter **************************************************************************/
end_comment

begin_macro
name|eth_reset
argument_list|()
end_macro

begin_block
block|{
name|int
name|i
decl_stmt|;
if|if
condition|(
name|eth_flags
operator|&
name|FLAG_790
condition|)
name|outb
argument_list|(
name|eth_nic_base
operator|+
name|D8390_P0_COMMAND
argument_list|,
name|D8390_COMMAND_PS0
operator||
name|D8390_COMMAND_STP
argument_list|)
expr_stmt|;
else|else
name|outb
argument_list|(
name|eth_nic_base
operator|+
name|D8390_P0_COMMAND
argument_list|,
name|D8390_COMMAND_PS0
operator||
name|D8390_COMMAND_RD2
operator||
name|D8390_COMMAND_STP
argument_list|)
expr_stmt|;
if|if
condition|(
name|eth_flags
operator|&
name|FLAG_16BIT
condition|)
name|outb
argument_list|(
name|eth_nic_base
operator|+
name|D8390_P0_DCR
argument_list|,
literal|0x49
argument_list|)
expr_stmt|;
else|else
name|outb
argument_list|(
name|eth_nic_base
operator|+
name|D8390_P0_DCR
argument_list|,
literal|0x48
argument_list|)
expr_stmt|;
name|outb
argument_list|(
name|eth_nic_base
operator|+
name|D8390_P0_RBCR0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|outb
argument_list|(
name|eth_nic_base
operator|+
name|D8390_P0_RBCR1
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|outb
argument_list|(
name|eth_nic_base
operator|+
name|D8390_P0_RCR
argument_list|,
literal|4
argument_list|)
expr_stmt|;
comment|/* allow broadcast frames */
name|outb
argument_list|(
name|eth_nic_base
operator|+
name|D8390_P0_TCR
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|outb
argument_list|(
name|eth_nic_base
operator|+
name|D8390_P0_TPSR
argument_list|,
name|eth_tx_start
argument_list|)
expr_stmt|;
name|outb
argument_list|(
name|eth_nic_base
operator|+
name|D8390_P0_PSTART
argument_list|,
name|eth_tx_start
operator|+
name|D8390_TXBUF_SIZE
argument_list|)
expr_stmt|;
if|if
condition|(
name|eth_flags
operator|&
name|FLAG_790
condition|)
name|outb
argument_list|(
name|eth_nic_base
operator|+
literal|0x09
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|outb
argument_list|(
name|eth_nic_base
operator|+
name|D8390_P0_PSTOP
argument_list|,
name|eth_memsize
argument_list|)
expr_stmt|;
name|outb
argument_list|(
name|eth_nic_base
operator|+
name|D8390_P0_BOUND
argument_list|,
name|eth_tx_start
operator|+
name|D8390_TXBUF_SIZE
argument_list|)
expr_stmt|;
name|outb
argument_list|(
name|eth_nic_base
operator|+
name|D8390_P0_ISR
argument_list|,
literal|0xFF
argument_list|)
expr_stmt|;
name|outb
argument_list|(
name|eth_nic_base
operator|+
name|D8390_P0_IMR
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|eth_flags
operator|&
name|FLAG_790
condition|)
name|outb
argument_list|(
name|eth_nic_base
operator|+
name|D8390_P0_COMMAND
argument_list|,
name|D8390_COMMAND_PS1
operator||
name|D8390_COMMAND_STP
argument_list|)
expr_stmt|;
else|else
name|outb
argument_list|(
name|eth_nic_base
operator|+
name|D8390_P0_COMMAND
argument_list|,
name|D8390_COMMAND_PS1
operator||
name|D8390_COMMAND_RD2
operator||
name|D8390_COMMAND_STP
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|6
condition|;
name|i
operator|++
control|)
name|outb
argument_list|(
name|eth_nic_base
operator|+
name|D8390_P1_PAR0
operator|+
name|i
argument_list|,
name|eth_node_addr
index|[
name|i
index|]
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|6
condition|;
name|i
operator|++
control|)
name|outb
argument_list|(
name|eth_nic_base
operator|+
name|D8390_P1_MAR0
operator|+
name|i
argument_list|,
literal|0xFF
argument_list|)
expr_stmt|;
name|outb
argument_list|(
name|eth_nic_base
operator|+
name|D8390_P1_CURR
argument_list|,
name|eth_tx_start
operator|+
name|D8390_TXBUF_SIZE
operator|+
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|eth_flags
operator|&
name|FLAG_790
condition|)
name|outb
argument_list|(
name|eth_nic_base
operator|+
name|D8390_P0_COMMAND
argument_list|,
name|D8390_COMMAND_PS0
operator||
name|D8390_COMMAND_STA
argument_list|)
expr_stmt|;
else|else
name|outb
argument_list|(
name|eth_nic_base
operator|+
name|D8390_P0_COMMAND
argument_list|,
name|D8390_COMMAND_PS0
operator||
name|D8390_COMMAND_RD2
operator||
name|D8390_COMMAND_STA
argument_list|)
expr_stmt|;
name|outb
argument_list|(
name|eth_nic_base
operator|+
name|D8390_P0_ISR
argument_list|,
literal|0xFF
argument_list|)
expr_stmt|;
name|outb
argument_list|(
name|eth_nic_base
operator|+
name|D8390_P0_TCR
argument_list|,
literal|0
argument_list|)
expr_stmt|;
return|return
operator|(
literal|1
operator|)
return|;
block|}
end_block

begin_comment
comment|/************************************************************************** ETH_TRANSMIT - Transmit a frame **************************************************************************/
end_comment

begin_macro
name|eth_transmit
argument_list|(
argument|d
argument_list|,
argument|t
argument_list|,
argument|s
argument_list|,
argument|p
argument_list|)
end_macro

begin_decl_stmt
name|char
modifier|*
name|d
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* Destination */
end_comment

begin_decl_stmt
name|unsigned
name|short
name|t
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* Type */
end_comment

begin_decl_stmt
name|unsigned
name|short
name|s
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* size */
end_comment

begin_decl_stmt
name|char
modifier|*
name|p
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* Packet */
end_comment

begin_block
block|{
name|unsigned
name|char
name|c
decl_stmt|;
ifdef|#
directive|ifdef
name|INCLUDE_WD
if|if
condition|(
name|eth_vendor
operator|==
name|VENDOR_WD
condition|)
block|{
comment|/* Memory interface */
if|if
condition|(
name|eth_flags
operator|&
name|FLAG_16BIT
condition|)
block|{
name|outb
argument_list|(
name|eth_asic_base
operator|+
name|WD_LAAR
argument_list|,
name|eth_laar
operator||
name|WD_LAAR_M16EN
argument_list|)
expr_stmt|;
name|inb
argument_list|(
literal|0x84
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|eth_flags
operator|&
name|FLAG_790
condition|)
block|{
name|outb
argument_list|(
name|eth_asic_base
operator|+
name|WD_MSR
argument_list|,
name|WD_MSR_MENB
argument_list|)
expr_stmt|;
name|inb
argument_list|(
literal|0x84
argument_list|)
expr_stmt|;
block|}
name|inb
argument_list|(
literal|0x84
argument_list|)
expr_stmt|;
name|bcopy
argument_list|(
name|d
argument_list|,
name|eth_bmem
argument_list|,
literal|6
argument_list|)
expr_stmt|;
comment|/* dst */
name|bcopy
argument_list|(
name|eth_node_addr
argument_list|,
name|eth_bmem
operator|+
literal|6
argument_list|,
name|ETHER_ADDR_SIZE
argument_list|)
expr_stmt|;
comment|/* src */
operator|*
operator|(
name|eth_bmem
operator|+
literal|12
operator|)
operator|=
name|t
operator|>>
literal|8
expr_stmt|;
comment|/* type */
operator|*
operator|(
name|eth_bmem
operator|+
literal|13
operator|)
operator|=
name|t
expr_stmt|;
name|bcopy
argument_list|(
name|p
argument_list|,
name|eth_bmem
operator|+
literal|14
argument_list|,
name|s
argument_list|)
expr_stmt|;
name|s
operator|+=
literal|14
expr_stmt|;
while|while
condition|(
name|s
operator|<
name|ETH_MIN_PACKET
condition|)
operator|*
operator|(
name|eth_bmem
operator|+
operator|(
name|s
operator|++
operator|)
operator|)
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|eth_flags
operator|&
name|FLAG_790
condition|)
block|{
name|outb
argument_list|(
name|eth_asic_base
operator|+
name|WD_MSR
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|inb
argument_list|(
literal|0x84
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|eth_flags
operator|&
name|FLAG_16BIT
condition|)
block|{
name|outb
argument_list|(
name|eth_asic_base
operator|+
name|WD_LAAR
argument_list|,
name|eth_laar
operator|&
operator|~
name|WD_LAAR_M16EN
argument_list|)
expr_stmt|;
name|inb
argument_list|(
literal|0x84
argument_list|)
expr_stmt|;
block|}
block|}
endif|#
directive|endif
ifdef|#
directive|ifdef
name|INCLUDE_NE
if|if
condition|(
name|eth_vendor
operator|==
name|VENDOR_NOVELL
condition|)
block|{
comment|/* Programmed I/O */
name|unsigned
name|short
name|type
decl_stmt|;
name|type
operator|=
operator|(
name|t
operator|>>
literal|8
operator|)
operator||
operator|(
name|t
operator|<<
literal|8
operator|)
expr_stmt|;
name|eth_pio_write
argument_list|(
name|d
argument_list|,
name|eth_tx_start
operator|<<
literal|8
argument_list|,
literal|6
argument_list|)
expr_stmt|;
name|eth_pio_write
argument_list|(
name|eth_node_addr
argument_list|,
operator|(
name|eth_tx_start
operator|<<
literal|8
operator|)
operator|+
literal|6
argument_list|,
literal|6
argument_list|)
expr_stmt|;
name|eth_pio_write
argument_list|(
operator|&
name|type
argument_list|,
operator|(
name|eth_tx_start
operator|<<
literal|8
operator|)
operator|+
literal|12
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|eth_pio_write
argument_list|(
name|p
argument_list|,
operator|(
name|eth_tx_start
operator|<<
literal|8
operator|)
operator|+
literal|14
argument_list|,
name|s
argument_list|)
expr_stmt|;
name|s
operator|+=
literal|14
expr_stmt|;
if|if
condition|(
name|s
operator|<
name|ETH_MIN_PACKET
condition|)
name|s
operator|=
name|ETH_MIN_PACKET
expr_stmt|;
block|}
endif|#
directive|endif
name|twiddle
argument_list|()
expr_stmt|;
if|if
condition|(
name|eth_flags
operator|&
name|FLAG_790
condition|)
name|outb
argument_list|(
name|eth_nic_base
operator|+
name|D8390_P0_COMMAND
argument_list|,
name|D8390_COMMAND_PS0
operator||
name|D8390_COMMAND_STA
argument_list|)
expr_stmt|;
else|else
name|outb
argument_list|(
name|eth_nic_base
operator|+
name|D8390_P0_COMMAND
argument_list|,
name|D8390_COMMAND_PS0
operator||
name|D8390_COMMAND_RD2
operator||
name|D8390_COMMAND_STA
argument_list|)
expr_stmt|;
name|outb
argument_list|(
name|eth_nic_base
operator|+
name|D8390_P0_TPSR
argument_list|,
name|eth_tx_start
argument_list|)
expr_stmt|;
name|outb
argument_list|(
name|eth_nic_base
operator|+
name|D8390_P0_TBCR0
argument_list|,
name|s
argument_list|)
expr_stmt|;
name|outb
argument_list|(
name|eth_nic_base
operator|+
name|D8390_P0_TBCR1
argument_list|,
name|s
operator|>>
literal|8
argument_list|)
expr_stmt|;
if|if
condition|(
name|eth_flags
operator|&
name|FLAG_790
condition|)
name|outb
argument_list|(
name|eth_nic_base
operator|+
name|D8390_P0_COMMAND
argument_list|,
name|D8390_COMMAND_PS0
operator||
name|D8390_COMMAND_TXP
operator||
name|D8390_COMMAND_STA
argument_list|)
expr_stmt|;
else|else
name|outb
argument_list|(
name|eth_nic_base
operator|+
name|D8390_P0_COMMAND
argument_list|,
name|D8390_COMMAND_PS0
operator||
name|D8390_COMMAND_TXP
operator||
name|D8390_COMMAND_RD2
operator||
name|D8390_COMMAND_STA
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_block

begin_comment
comment|/************************************************************************** ETH_POLL - Wait for a frame **************************************************************************/
end_comment

begin_macro
name|eth_poll
argument_list|()
end_macro

begin_block
block|{
name|int
name|ret
init|=
literal|0
decl_stmt|;
name|unsigned
name|short
name|type
init|=
literal|0
decl_stmt|;
name|unsigned
name|char
name|bound
decl_stmt|,
name|curr
decl_stmt|,
name|rstat
decl_stmt|;
name|unsigned
name|short
name|len
decl_stmt|;
name|unsigned
name|short
name|pktoff
decl_stmt|;
name|unsigned
name|char
modifier|*
name|p
decl_stmt|;
name|struct
name|ringbuffer
name|pkthdr
decl_stmt|;
name|rstat
operator|=
name|inb
argument_list|(
name|eth_nic_base
operator|+
name|D8390_P0_RSR
argument_list|)
expr_stmt|;
if|if
condition|(
name|rstat
operator|&
name|D8390_RSTAT_OVER
condition|)
block|{
name|eth_reset
argument_list|()
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
if|if
condition|(
operator|!
operator|(
name|rstat
operator|&
name|D8390_RSTAT_PRX
operator|)
condition|)
return|return
operator|(
literal|0
operator|)
return|;
name|bound
operator|=
name|inb
argument_list|(
name|eth_nic_base
operator|+
name|D8390_P0_BOUND
argument_list|)
operator|+
literal|1
expr_stmt|;
if|if
condition|(
name|bound
operator|==
name|eth_memsize
condition|)
name|bound
operator|=
name|eth_tx_start
operator|+
name|D8390_TXBUF_SIZE
expr_stmt|;
name|outb
argument_list|(
name|eth_nic_base
operator|+
name|D8390_P0_COMMAND
argument_list|,
name|D8390_COMMAND_PS1
argument_list|)
expr_stmt|;
name|curr
operator|=
name|inb
argument_list|(
name|eth_nic_base
operator|+
name|D8390_P1_CURR
argument_list|)
expr_stmt|;
name|outb
argument_list|(
name|eth_nic_base
operator|+
name|D8390_P0_COMMAND
argument_list|,
name|D8390_COMMAND_PS0
argument_list|)
expr_stmt|;
if|if
condition|(
name|curr
operator|==
name|eth_memsize
condition|)
name|curr
operator|=
name|eth_tx_start
operator|+
name|D8390_TXBUF_SIZE
expr_stmt|;
if|if
condition|(
name|curr
operator|==
name|bound
condition|)
return|return
operator|(
literal|0
operator|)
return|;
if|if
condition|(
name|eth_vendor
operator|==
name|VENDOR_WD
condition|)
block|{
if|if
condition|(
name|eth_flags
operator|&
name|FLAG_16BIT
condition|)
block|{
name|outb
argument_list|(
name|eth_asic_base
operator|+
name|WD_LAAR
argument_list|,
name|eth_laar
operator||
name|WD_LAAR_M16EN
argument_list|)
expr_stmt|;
name|inb
argument_list|(
literal|0x84
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|eth_flags
operator|&
name|FLAG_790
condition|)
block|{
name|outb
argument_list|(
name|eth_asic_base
operator|+
name|WD_MSR
argument_list|,
name|WD_MSR_MENB
argument_list|)
expr_stmt|;
name|inb
argument_list|(
literal|0x84
argument_list|)
expr_stmt|;
block|}
name|inb
argument_list|(
literal|0x84
argument_list|)
expr_stmt|;
block|}
name|pktoff
operator|=
operator|(
name|bound
operator|<<
literal|8
operator|)
expr_stmt|;
if|if
condition|(
name|eth_flags
operator|&
name|FLAG_PIO
condition|)
name|eth_pio_read
argument_list|(
name|pktoff
argument_list|,
operator|&
name|pkthdr
argument_list|,
literal|4
argument_list|)
expr_stmt|;
else|else
name|bcopy
argument_list|(
name|eth_bmem
operator|+
name|pktoff
argument_list|,
operator|&
name|pkthdr
argument_list|,
literal|4
argument_list|)
expr_stmt|;
name|len
operator|=
name|pkthdr
operator|.
name|len
operator|-
literal|4
expr_stmt|;
comment|/* sub CRC */
name|pktoff
operator|+=
literal|4
expr_stmt|;
if|if
condition|(
name|len
operator|>
literal|1514
condition|)
name|len
operator|=
literal|1514
expr_stmt|;
name|bound
operator|=
name|pkthdr
operator|.
name|bound
expr_stmt|;
comment|/* New bound ptr */
if|if
condition|(
operator|(
name|pkthdr
operator|.
name|status
operator|&
name|D8390_RSTAT_PRX
operator|)
operator|&&
operator|(
name|len
operator|>
literal|14
operator|)
operator|&&
operator|(
name|len
operator|<
literal|1518
operator|)
condition|)
block|{
name|p
operator|=
name|packet
expr_stmt|;
name|packetlen
operator|=
name|len
expr_stmt|;
name|len
operator|=
operator|(
name|eth_memsize
operator|<<
literal|8
operator|)
operator|-
name|pktoff
expr_stmt|;
if|if
condition|(
name|packetlen
operator|>
name|len
condition|)
block|{
comment|/* We have a wrap-around */
if|if
condition|(
name|eth_flags
operator|&
name|FLAG_PIO
condition|)
name|eth_pio_read
argument_list|(
name|pktoff
argument_list|,
name|p
argument_list|,
name|len
argument_list|)
expr_stmt|;
else|else
name|bcopy
argument_list|(
name|eth_bmem
operator|+
name|pktoff
argument_list|,
name|p
argument_list|,
name|len
argument_list|)
expr_stmt|;
name|pktoff
operator|=
operator|(
name|eth_tx_start
operator|+
name|D8390_TXBUF_SIZE
operator|)
operator|<<
literal|8
expr_stmt|;
name|p
operator|+=
name|len
expr_stmt|;
name|packetlen
operator|-=
name|len
expr_stmt|;
block|}
if|if
condition|(
name|eth_flags
operator|&
name|FLAG_PIO
condition|)
name|eth_pio_read
argument_list|(
name|pktoff
argument_list|,
name|p
argument_list|,
name|packetlen
argument_list|)
expr_stmt|;
else|else
name|bcopy
argument_list|(
name|eth_bmem
operator|+
name|pktoff
argument_list|,
name|p
argument_list|,
name|packetlen
argument_list|)
expr_stmt|;
name|type
operator|=
operator|(
name|packet
index|[
literal|12
index|]
operator|<<
literal|8
operator|)
operator||
name|packet
index|[
literal|13
index|]
expr_stmt|;
name|ret
operator|=
literal|1
expr_stmt|;
block|}
if|if
condition|(
name|eth_vendor
operator|==
name|VENDOR_WD
condition|)
block|{
if|if
condition|(
name|eth_flags
operator|&
name|FLAG_790
condition|)
block|{
name|outb
argument_list|(
name|eth_asic_base
operator|+
name|WD_MSR
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|inb
argument_list|(
literal|0x84
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|eth_flags
operator|&
name|FLAG_16BIT
condition|)
block|{
name|outb
argument_list|(
name|eth_asic_base
operator|+
name|WD_LAAR
argument_list|,
name|eth_laar
operator|&
operator|~
name|WD_LAAR_M16EN
argument_list|)
expr_stmt|;
name|inb
argument_list|(
literal|0x84
argument_list|)
expr_stmt|;
block|}
name|inb
argument_list|(
literal|0x84
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|bound
operator|==
operator|(
name|eth_tx_start
operator|+
name|D8390_TXBUF_SIZE
operator|)
condition|)
name|bound
operator|=
name|eth_memsize
expr_stmt|;
name|outb
argument_list|(
name|eth_nic_base
operator|+
name|D8390_P0_BOUND
argument_list|,
name|bound
operator|-
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|&&
operator|(
name|type
operator|==
name|ARP
operator|)
condition|)
block|{
name|struct
name|arprequest
modifier|*
name|arpreq
decl_stmt|;
name|unsigned
name|long
name|reqip
decl_stmt|;
name|arpreq
operator|=
operator|(
expr|struct
name|arprequest
operator|*
operator|)
operator|&
name|packet
index|[
name|ETHER_HDR_SIZE
index|]
expr_stmt|;
name|convert_ipaddr
argument_list|(
operator|&
name|reqip
argument_list|,
name|arpreq
operator|->
name|tipaddr
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|ntohs
argument_list|(
name|arpreq
operator|->
name|opcode
argument_list|)
operator|==
name|ARP_REQUEST
operator|)
operator|&&
operator|(
name|reqip
operator|==
name|arptable
index|[
name|ARP_CLIENT
index|]
operator|.
name|ipaddr
operator|)
condition|)
block|{
name|arpreq
operator|->
name|opcode
operator|=
name|htons
argument_list|(
name|ARP_REPLY
argument_list|)
expr_stmt|;
name|bcopy
argument_list|(
name|arpreq
operator|->
name|sipaddr
argument_list|,
name|arpreq
operator|->
name|tipaddr
argument_list|,
literal|4
argument_list|)
expr_stmt|;
name|bcopy
argument_list|(
name|arpreq
operator|->
name|shwaddr
argument_list|,
name|arpreq
operator|->
name|thwaddr
argument_list|,
literal|6
argument_list|)
expr_stmt|;
name|bcopy
argument_list|(
name|arptable
index|[
name|ARP_CLIENT
index|]
operator|.
name|node
argument_list|,
name|arpreq
operator|->
name|shwaddr
argument_list|,
literal|6
argument_list|)
expr_stmt|;
name|convert_ipaddr
argument_list|(
name|arpreq
operator|->
name|sipaddr
argument_list|,
operator|&
name|reqip
argument_list|)
expr_stmt|;
name|eth_transmit
argument_list|(
name|arpreq
operator|->
name|thwaddr
argument_list|,
name|ARP
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|arprequest
argument_list|)
argument_list|,
name|arpreq
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
block|}
return|return
operator|(
name|ret
operator|)
return|;
block|}
end_block

begin_ifdef
ifdef|#
directive|ifdef
name|INCLUDE_NE
end_ifdef

begin_comment
comment|/************************************************************************** NE1000/NE2000 Support Routines **************************************************************************/
end_comment

begin_function
specifier|static
specifier|inline
name|unsigned
name|short
name|inw
parameter_list|(
name|unsigned
name|short
name|a
parameter_list|)
block|{
name|unsigned
name|short
name|d
decl_stmt|;
asm|asm
specifier|volatile
asm|( "inw %1, %0" : "=a" (d) : "d" (a));
return|return
name|d
return|;
block|}
end_function

begin_function
specifier|static
specifier|inline
name|void
name|outw
parameter_list|(
name|unsigned
name|short
name|a
parameter_list|,
name|unsigned
name|short
name|d
parameter_list|)
block|{
asm|asm
specifier|volatile
asm|( "outw %0, %1" : : "a" (d), "d" (a));
block|}
end_function

begin_comment
comment|/************************************************************************** ETH_PIO_READ - Read a frame via Programmed I/O **************************************************************************/
end_comment

begin_macro
name|eth_pio_read
argument_list|(
argument|src
argument_list|,
argument|dst
argument_list|,
argument|cnt
argument_list|,
argument|init
argument_list|)
end_macro

begin_decl_stmt
name|unsigned
name|short
name|src
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|unsigned
name|char
modifier|*
name|dst
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|unsigned
name|short
name|cnt
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|init
decl_stmt|;
end_decl_stmt

begin_block
block|{
if|if
condition|(
name|cnt
operator|&
literal|1
condition|)
name|cnt
operator|++
expr_stmt|;
name|outb
argument_list|(
name|eth_nic_base
operator|+
name|D8390_P0_COMMAND
argument_list|,
name|D8390_COMMAND_RD2
operator||
name|D8390_COMMAND_STA
argument_list|)
expr_stmt|;
name|outb
argument_list|(
name|eth_nic_base
operator|+
name|D8390_P0_RBCR0
argument_list|,
name|cnt
argument_list|)
expr_stmt|;
name|outb
argument_list|(
name|eth_nic_base
operator|+
name|D8390_P0_RBCR1
argument_list|,
name|cnt
operator|>>
literal|8
argument_list|)
expr_stmt|;
name|outb
argument_list|(
name|eth_nic_base
operator|+
name|D8390_P0_RSAR0
argument_list|,
name|src
argument_list|)
expr_stmt|;
name|outb
argument_list|(
name|eth_nic_base
operator|+
name|D8390_P0_RSAR1
argument_list|,
name|src
operator|>>
literal|8
argument_list|)
expr_stmt|;
name|outb
argument_list|(
name|eth_nic_base
operator|+
name|D8390_P0_COMMAND
argument_list|,
name|D8390_COMMAND_RD0
operator||
name|D8390_COMMAND_STA
argument_list|)
expr_stmt|;
if|if
condition|(
name|eth_flags
operator|&
name|FLAG_16BIT
condition|)
block|{
while|while
condition|(
name|cnt
condition|)
block|{
operator|*
operator|(
operator|(
name|unsigned
name|short
operator|*
operator|)
name|dst
operator|)
operator|=
name|inw
argument_list|(
name|eth_asic_base
operator|+
name|NE_DATA
argument_list|)
expr_stmt|;
name|dst
operator|+=
literal|2
expr_stmt|;
name|cnt
operator|-=
literal|2
expr_stmt|;
block|}
block|}
else|else
block|{
while|while
condition|(
name|cnt
operator|--
condition|)
operator|*
operator|(
name|dst
operator|++
operator|)
operator|=
name|inb
argument_list|(
name|eth_asic_base
operator|+
name|NE_DATA
argument_list|)
expr_stmt|;
block|}
block|}
end_block

begin_comment
comment|/************************************************************************** ETH_PIO_WRITE - Write a frame via Programmed I/O **************************************************************************/
end_comment

begin_macro
name|eth_pio_write
argument_list|(
argument|src
argument_list|,
argument|dst
argument_list|,
argument|cnt
argument_list|,
argument|init
argument_list|)
end_macro

begin_decl_stmt
name|unsigned
name|char
modifier|*
name|src
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|unsigned
name|short
name|dst
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|unsigned
name|short
name|cnt
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|init
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|outb
argument_list|(
name|eth_nic_base
operator|+
name|D8390_P0_COMMAND
argument_list|,
name|D8390_COMMAND_RD2
operator||
name|D8390_COMMAND_STA
argument_list|)
expr_stmt|;
name|outb
argument_list|(
name|eth_nic_base
operator|+
name|D8390_P0_ISR
argument_list|,
name|D8390_ISR_RDC
argument_list|)
expr_stmt|;
name|outb
argument_list|(
name|eth_nic_base
operator|+
name|D8390_P0_RBCR0
argument_list|,
name|cnt
argument_list|)
expr_stmt|;
name|outb
argument_list|(
name|eth_nic_base
operator|+
name|D8390_P0_RBCR1
argument_list|,
name|cnt
operator|>>
literal|8
argument_list|)
expr_stmt|;
name|outb
argument_list|(
name|eth_nic_base
operator|+
name|D8390_P0_RSAR0
argument_list|,
name|dst
argument_list|)
expr_stmt|;
name|outb
argument_list|(
name|eth_nic_base
operator|+
name|D8390_P0_RSAR1
argument_list|,
name|dst
operator|>>
literal|8
argument_list|)
expr_stmt|;
name|outb
argument_list|(
name|eth_nic_base
operator|+
name|D8390_P0_COMMAND
argument_list|,
name|D8390_COMMAND_RD1
operator||
name|D8390_COMMAND_STA
argument_list|)
expr_stmt|;
if|if
condition|(
name|eth_flags
operator|&
name|FLAG_16BIT
condition|)
block|{
if|if
condition|(
name|cnt
operator|&
literal|1
condition|)
name|cnt
operator|++
expr_stmt|;
comment|/* Round up */
while|while
condition|(
name|cnt
condition|)
block|{
name|outw
argument_list|(
name|eth_asic_base
operator|+
name|NE_DATA
argument_list|,
operator|*
operator|(
operator|(
name|unsigned
name|short
operator|*
operator|)
name|src
operator|)
argument_list|)
expr_stmt|;
name|src
operator|+=
literal|2
expr_stmt|;
name|cnt
operator|-=
literal|2
expr_stmt|;
block|}
block|}
else|else
block|{
while|while
condition|(
name|cnt
operator|--
condition|)
name|outb
argument_list|(
name|eth_asic_base
operator|+
name|NE_DATA
argument_list|,
operator|*
operator|(
name|src
operator|++
operator|)
argument_list|)
expr_stmt|;
block|}
while|while
condition|(
operator|(
name|inb
argument_list|(
name|eth_nic_base
operator|+
name|D8390_P0_ISR
argument_list|)
operator|&
name|D8390_ISR_RDC
operator|)
operator|!=
name|D8390_ISR_RDC
condition|)
empty_stmt|;
block|}
end_block

begin_else
else|#
directive|else
end_else

begin_comment
comment|/************************************************************************** ETH_PIO_READ - Dummy routine when NE2000 not compiled in **************************************************************************/
end_comment

begin_macro
name|eth_pio_read
argument_list|()
end_macro

begin_block
block|{}
end_block

begin_endif
endif|#
directive|endif
end_endif

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Copyright (C) 1984-2017  Mark Nudelman  *  * You may distribute under the terms of either the GNU General Public  * License or the Less License, as specified in the README file.  *  * For more information, see the README file.  */
end_comment

begin_comment
comment|/*  * Routines to convert text in various ways.  Used by search.  */
end_comment

begin_include
include|#
directive|include
file|"less.h"
end_include

begin_include
include|#
directive|include
file|"charset.h"
end_include

begin_decl_stmt
specifier|extern
name|int
name|utf_mode
decl_stmt|;
end_decl_stmt

begin_comment
comment|/*  * Get the length of a buffer needed to convert a string.  */
end_comment

begin_function
name|public
name|int
name|cvt_length
parameter_list|(
name|len
parameter_list|,
name|ops
parameter_list|)
name|int
name|len
decl_stmt|;
name|int
name|ops
decl_stmt|;
block|{
if|if
condition|(
name|utf_mode
condition|)
comment|/* 		 * Just copying a string in UTF-8 mode can cause it to grow  		 * in length. 		 * Four output bytes for one input byte is the worst case. 		 */
name|len
operator|*=
literal|4
expr_stmt|;
return|return
operator|(
name|len
operator|+
literal|1
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Allocate a chpos array for use by cvt_text.  */
end_comment

begin_function
name|public
name|int
modifier|*
name|cvt_alloc_chpos
parameter_list|(
name|len
parameter_list|)
name|int
name|len
decl_stmt|;
block|{
name|int
name|i
decl_stmt|;
name|int
modifier|*
name|chpos
init|=
operator|(
name|int
operator|*
operator|)
name|ecalloc
argument_list|(
sizeof|sizeof
argument_list|(
name|int
argument_list|)
argument_list|,
name|len
argument_list|)
decl_stmt|;
comment|/* Initialize all entries to an invalid position. */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|len
condition|;
name|i
operator|++
control|)
name|chpos
index|[
name|i
index|]
operator|=
operator|-
literal|1
expr_stmt|;
return|return
operator|(
name|chpos
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Convert text.  Perform the transformations specified by ops.  * Returns converted text in odst.  The original offset of each  * odst character (when it was in osrc) is returned in the chpos array.  */
end_comment

begin_function
name|public
name|void
name|cvt_text
parameter_list|(
name|odst
parameter_list|,
name|osrc
parameter_list|,
name|chpos
parameter_list|,
name|lenp
parameter_list|,
name|ops
parameter_list|)
name|char
modifier|*
name|odst
decl_stmt|;
name|char
modifier|*
name|osrc
decl_stmt|;
name|int
modifier|*
name|chpos
decl_stmt|;
name|int
modifier|*
name|lenp
decl_stmt|;
name|int
name|ops
decl_stmt|;
block|{
name|char
modifier|*
name|dst
decl_stmt|;
name|char
modifier|*
name|edst
init|=
name|odst
decl_stmt|;
name|char
modifier|*
name|src
decl_stmt|;
name|char
modifier|*
name|src_end
decl_stmt|;
name|LWCHAR
name|ch
decl_stmt|;
if|if
condition|(
name|lenp
operator|!=
name|NULL
condition|)
name|src_end
operator|=
name|osrc
operator|+
operator|*
name|lenp
expr_stmt|;
else|else
name|src_end
operator|=
name|osrc
operator|+
name|strlen
argument_list|(
name|osrc
argument_list|)
expr_stmt|;
for|for
control|(
name|src
operator|=
name|osrc
operator|,
name|dst
operator|=
name|odst
init|;
name|src
operator|<
name|src_end
condition|;
control|)
block|{
name|int
name|src_pos
init|=
call|(
name|int
call|)
argument_list|(
name|src
operator|-
name|osrc
argument_list|)
decl_stmt|;
name|int
name|dst_pos
init|=
call|(
name|int
call|)
argument_list|(
name|dst
operator|-
name|odst
argument_list|)
decl_stmt|;
name|ch
operator|=
name|step_char
argument_list|(
operator|&
name|src
argument_list|,
operator|+
literal|1
argument_list|,
name|src_end
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|ops
operator|&
name|CVT_BS
operator|)
operator|&&
name|ch
operator|==
literal|'\b'
operator|&&
name|dst
operator|>
name|odst
condition|)
block|{
comment|/* Delete backspace and preceding char. */
do|do
block|{
name|dst
operator|--
expr_stmt|;
block|}
do|while
condition|(
name|dst
operator|>
name|odst
operator|&&
operator|!
name|IS_ASCII_OCTET
argument_list|(
operator|*
name|dst
argument_list|)
operator|&&
operator|!
name|IS_UTF8_LEAD
argument_list|(
operator|*
name|dst
argument_list|)
condition|)
do|;
block|}
elseif|else
if|if
condition|(
operator|(
name|ops
operator|&
name|CVT_ANSI
operator|)
operator|&&
name|IS_CSI_START
argument_list|(
name|ch
argument_list|)
condition|)
block|{
comment|/* Skip to end of ANSI escape sequence. */
name|src
operator|++
expr_stmt|;
comment|/* skip the CSI start char */
while|while
condition|(
name|src
operator|<
name|src_end
condition|)
if|if
condition|(
operator|!
name|is_ansi_middle
argument_list|(
operator|*
name|src
operator|++
argument_list|)
condition|)
break|break;
block|}
else|else
block|{
comment|/* Just copy the char to the destination buffer. */
if|if
condition|(
operator|(
name|ops
operator|&
name|CVT_TO_LC
operator|)
operator|&&
name|IS_UPPER
argument_list|(
name|ch
argument_list|)
condition|)
name|ch
operator|=
name|TO_LOWER
argument_list|(
name|ch
argument_list|)
expr_stmt|;
name|put_wchar
argument_list|(
operator|&
name|dst
argument_list|,
name|ch
argument_list|)
expr_stmt|;
comment|/* Record the original position of the char. */
if|if
condition|(
name|chpos
operator|!=
name|NULL
condition|)
name|chpos
index|[
name|dst_pos
index|]
operator|=
name|src_pos
expr_stmt|;
block|}
if|if
condition|(
name|dst
operator|>
name|edst
condition|)
name|edst
operator|=
name|dst
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|ops
operator|&
name|CVT_CRLF
operator|)
operator|&&
name|edst
operator|>
name|odst
operator|&&
name|edst
index|[
operator|-
literal|1
index|]
operator|==
literal|'\r'
condition|)
name|edst
operator|--
expr_stmt|;
operator|*
name|edst
operator|=
literal|'\0'
expr_stmt|;
if|if
condition|(
name|lenp
operator|!=
name|NULL
condition|)
operator|*
name|lenp
operator|=
call|(
name|int
call|)
argument_list|(
name|edst
operator|-
name|odst
argument_list|)
expr_stmt|;
comment|/* FIXME: why was this here?  if (chpos != NULL) chpos[dst - odst] = src - osrc; */
block|}
end_function

end_unit


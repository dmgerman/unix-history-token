begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_include
include|#
directive|include
file|"jove.h"
end_include

begin_include
include|#
directive|include
file|<signal.h>
end_include

begin_include
include|#
directive|include
file|<errno.h>
end_include

begin_ifdef
ifdef|#
directive|ifdef
name|BSD_SIGS
end_ifdef

begin_define
define|#
directive|define
name|pause
parameter_list|()
value|sigpause(0L)
end_define

begin_endif
endif|#
directive|endif
end_endif

begin_struct
struct|struct
name|header
block|{
name|int
name|pid
decl_stmt|,
name|nbytes
decl_stmt|;
name|char
name|buf
index|[
literal|10
index|]
decl_stmt|;
block|}
struct|;
end_struct

begin_define
define|#
directive|define
name|HEADER_SIZE
value|(2 * sizeof (int))
end_define

begin_comment
comment|/* JOVE sends SIGQUIT whenever it wants the kbd process (this program)    to stop competing for input from the keyboard.  JOVE does this when    JOVE realizes that there are no more interactive processes running.    The reason we go through all this trouble is that JOVE slows down    a lot when it's getting its keyboard input via a pipe. */
end_comment

begin_decl_stmt
specifier|static
name|SIGRESULT
name|strt_read
name|proto
argument_list|(
operator|(
name|int
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_function
specifier|static
name|SIGRESULT
name|hold_read
parameter_list|(
name|junk
parameter_list|)
name|int
name|junk
decl_stmt|;
comment|/* passed in when invoked by a signal; of no interest */
block|{
name|signal
argument_list|(
name|SIGQUIT
argument_list|,
name|strt_read
argument_list|)
expr_stmt|;
name|pause
argument_list|()
expr_stmt|;
name|SIGRETURN
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|SIGRESULT
name|strt_read
parameter_list|(
name|junk
parameter_list|)
name|int
name|junk
decl_stmt|;
block|{
name|signal
argument_list|(
name|SIGQUIT
argument_list|,
name|hold_read
argument_list|)
expr_stmt|;
name|SIGRETURN
expr_stmt|;
block|}
end_function

begin_function
name|int
name|main
parameter_list|(
name|argc
parameter_list|,
name|argv
parameter_list|)
name|int
name|argc
decl_stmt|;
name|char
modifier|*
modifier|*
name|argv
decl_stmt|;
block|{
name|struct
name|header
name|header
decl_stmt|;
name|int
name|pid
decl_stmt|,
name|n
decl_stmt|;
name|signal
argument_list|(
name|SIGINT
argument_list|,
name|SIG_IGN
argument_list|)
expr_stmt|;
name|pid
operator|=
name|getpid
argument_list|()
expr_stmt|;
name|header
operator|.
name|pid
operator|=
name|pid
expr_stmt|;
name|hold_read
argument_list|(
literal|0
argument_list|)
expr_stmt|;
for|for
control|(
init|;
condition|;
control|)
block|{
name|n
operator|=
name|read
argument_list|(
literal|0
argument_list|,
name|header
operator|.
name|buf
argument_list|,
sizeof|sizeof
argument_list|(
name|header
operator|.
name|buf
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|n
operator|==
operator|-
literal|1
condition|)
block|{
if|if
condition|(
name|errno
operator|!=
name|EINTR
condition|)
break|break;
continue|continue;
block|}
name|header
operator|.
name|nbytes
operator|=
name|n
expr_stmt|;
name|write
argument_list|(
literal|1
argument_list|,
operator|(
name|UnivPtr
operator|)
operator|&
name|header
argument_list|,
name|HEADER_SIZE
operator|+
name|n
argument_list|)
expr_stmt|;
block|}
return|return
literal|0
return|;
block|}
end_function

end_unit


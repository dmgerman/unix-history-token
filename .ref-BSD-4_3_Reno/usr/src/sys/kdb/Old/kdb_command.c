begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Copyright (c) 1986 Regents of the University of California.  * All rights reserved.  The Berkeley software License Agreement  * specifies the terms and conditions for redistribution.  *  *	@(#)kdb_command.c	7.3 (Berkeley) 12/15/86  */
end_comment

begin_include
include|#
directive|include
file|"../kdb/defs.h"
end_include

begin_decl_stmt
name|char
modifier|*
name|BADEQ
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|char
modifier|*
name|NOMATCH
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|char
modifier|*
name|BADVAR
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|char
modifier|*
name|BADCOM
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|executing
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|char
modifier|*
name|lp
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|char
name|lastc
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|char
name|eqformat
index|[
literal|512
index|]
init|=
literal|"z"
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|char
name|stformat
index|[
literal|512
index|]
init|=
literal|"X\"= \"^i"
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|long
name|ditto
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|lastcom
init|=
literal|'='
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|long
name|locval
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|long
name|locmsk
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|long
name|expv
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* command decoding */
end_comment

begin_macro
name|command
argument_list|(
argument|buf
argument_list|,
argument|defcom
argument_list|)
end_macro

begin_decl_stmt
name|char
modifier|*
name|buf
decl_stmt|,
name|defcom
decl_stmt|;
end_decl_stmt

begin_block
block|{
specifier|register
name|itype
operator|,
name|ptype
operator|,
name|modifier
operator|,
name|regptr
expr_stmt|;
name|int
name|longpr
decl_stmt|,
name|eqcom
decl_stmt|;
name|char
name|wformat
index|[
literal|1
index|]
decl_stmt|,
name|savc
decl_stmt|;
specifier|register
name|long
name|w
decl_stmt|,
name|savdot
decl_stmt|;
name|char
modifier|*
name|savlp
init|=
name|lp
decl_stmt|;
if|if
condition|(
name|buf
condition|)
block|{
if|if
condition|(
operator|*
name|buf
operator|==
name|EOR
condition|)
return|return
operator|(
literal|0
operator|)
return|;
name|lp
operator|=
name|buf
expr_stmt|;
block|}
do|do
block|{
if|if
condition|(
name|adrflg
operator|=
name|expr
argument_list|(
literal|0
argument_list|)
condition|)
block|{
name|dot
operator|=
name|expv
expr_stmt|;
name|ditto
operator|=
name|dot
expr_stmt|;
block|}
name|adrval
operator|=
name|dot
expr_stmt|;
name|cntflg
operator|=
operator|(
name|rdc
argument_list|()
operator|==
literal|','
operator|&&
name|expr
argument_list|(
literal|0
argument_list|)
operator|)
expr_stmt|;
if|if
condition|(
name|cntflg
condition|)
name|cntval
operator|=
name|expv
expr_stmt|;
else|else
name|cntval
operator|=
literal|1
operator|,
name|lp
operator|--
expr_stmt|;
if|if
condition|(
name|eol
argument_list|(
name|rdc
argument_list|()
argument_list|)
condition|)
block|{
if|if
condition|(
operator|!
name|adrflg
condition|)
name|dot
operator|=
name|inkdot
argument_list|(
name|dotinc
argument_list|)
expr_stmt|;
name|lp
operator|--
expr_stmt|;
name|lastcom
operator|=
name|defcom
expr_stmt|;
block|}
else|else
name|lastcom
operator|=
name|lastc
expr_stmt|;
switch|switch
condition|(
name|lastcom
operator|&
name|STRIP
condition|)
block|{
case|case
literal|'/'
case|:
name|itype
operator|=
name|DSP
expr_stmt|;
name|ptype
operator|=
name|DSYM
expr_stmt|;
goto|goto
name|trystar
goto|;
case|case
literal|'='
case|:
name|itype
operator|=
name|NSP
expr_stmt|;
name|ptype
operator|=
literal|0
expr_stmt|;
goto|goto
name|trypr
goto|;
case|case
literal|'?'
case|:
name|itype
operator|=
name|ISP
expr_stmt|;
name|ptype
operator|=
name|ISYM
expr_stmt|;
goto|goto
name|trystar
goto|;
name|trystar
label|:
if|if
condition|(
name|rdc
argument_list|()
operator|==
literal|'*'
condition|)
name|lastcom
operator||=
name|QUOTE
expr_stmt|;
else|else
name|lp
operator|--
expr_stmt|;
if|if
condition|(
name|lastcom
operator|&
name|QUOTE
condition|)
block|{
name|itype
operator||=
name|STAR
expr_stmt|;
name|ptype
operator|=
operator|(
name|DSYM
operator|+
name|ISYM
operator|)
operator|-
name|ptype
expr_stmt|;
block|}
name|trypr
label|:
name|longpr
operator|=
literal|0
expr_stmt|;
name|eqcom
operator|=
name|lastcom
operator|==
literal|'='
expr_stmt|;
switch|switch
condition|(
name|rdc
argument_list|()
condition|)
block|{
case|case
literal|'L'
case|:
name|longpr
operator|=
literal|1
expr_stmt|;
case|case
literal|'l'
case|:
comment|/*search for exp*/
if|if
condition|(
name|eqcom
condition|)
name|error
argument_list|(
name|BADEQ
argument_list|)
expr_stmt|;
name|dotinc
operator|=
operator|(
name|longpr
condition|?
literal|4
else|:
literal|2
operator|)
expr_stmt|;
name|savdot
operator|=
name|dot
expr_stmt|;
operator|(
name|void
operator|)
name|expr
argument_list|(
literal|1
argument_list|)
expr_stmt|;
name|locval
operator|=
name|expv
expr_stmt|;
if|if
condition|(
name|expr
argument_list|(
literal|0
argument_list|)
condition|)
name|locmsk
operator|=
name|expv
expr_stmt|;
else|else
name|locmsk
operator|=
operator|-
literal|1L
expr_stmt|;
if|if
condition|(
operator|!
name|longpr
condition|)
block|{
name|locmsk
operator|&=
literal|0xFFFF
expr_stmt|;
name|locval
operator|&=
literal|0xFFFF
expr_stmt|;
block|}
for|for
control|(
init|;
condition|;
control|)
block|{
name|w
operator|=
name|get
argument_list|(
name|dot
argument_list|,
name|itype
argument_list|)
expr_stmt|;
if|if
condition|(
name|errflg
operator|||
name|mkfault
operator|||
operator|(
name|w
operator|&
name|locmsk
operator|)
operator|==
name|locval
condition|)
break|break;
name|dot
operator|=
name|inkdot
argument_list|(
name|dotinc
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|errflg
condition|)
block|{
name|dot
operator|=
name|savdot
expr_stmt|;
name|errflg
operator|=
name|NOMATCH
expr_stmt|;
block|}
name|psymoff
argument_list|(
name|dot
argument_list|,
name|ptype
argument_list|,
literal|""
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'W'
case|:
name|longpr
operator|=
literal|1
expr_stmt|;
case|case
literal|'w'
case|:
if|if
condition|(
name|eqcom
condition|)
name|error
argument_list|(
name|BADEQ
argument_list|)
expr_stmt|;
name|wformat
index|[
literal|0
index|]
operator|=
name|lastc
expr_stmt|;
operator|(
name|void
operator|)
name|expr
argument_list|(
literal|1
argument_list|)
expr_stmt|;
do|do
block|{
name|savdot
operator|=
name|dot
expr_stmt|;
name|psymoff
argument_list|(
name|dot
argument_list|,
name|ptype
argument_list|,
literal|":%16t"
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|exform
argument_list|(
literal|1
argument_list|,
name|wformat
argument_list|,
name|itype
argument_list|,
name|ptype
argument_list|)
expr_stmt|;
name|errflg
operator|=
literal|0
expr_stmt|;
name|dot
operator|=
name|savdot
expr_stmt|;
if|if
condition|(
name|longpr
condition|)
name|put
argument_list|(
name|dot
argument_list|,
name|itype
argument_list|,
name|expv
argument_list|)
expr_stmt|;
else|else
name|put
argument_list|(
name|dot
argument_list|,
name|itype
argument_list|,
name|itol
argument_list|(
name|expv
argument_list|,
name|get
argument_list|(
name|dot
argument_list|,
name|itype
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
name|savdot
operator|=
name|dot
expr_stmt|;
name|printf
argument_list|(
literal|"=%8t"
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|exform
argument_list|(
literal|1
argument_list|,
name|wformat
argument_list|,
name|itype
argument_list|,
name|ptype
argument_list|)
expr_stmt|;
name|printc
argument_list|(
name|EOR
argument_list|)
expr_stmt|;
block|}
do|while
condition|(
name|expr
argument_list|(
literal|0
argument_list|)
operator|&&
name|errflg
operator|==
literal|0
condition|)
do|;
name|dot
operator|=
name|savdot
expr_stmt|;
name|chkerr
argument_list|()
expr_stmt|;
break|break;
default|default:
name|lp
operator|--
expr_stmt|;
name|getformat
argument_list|(
name|eqcom
condition|?
name|eqformat
else|:
name|stformat
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|eqcom
condition|)
name|psymoff
argument_list|(
name|dot
argument_list|,
name|ptype
argument_list|,
literal|":%16t"
argument_list|)
expr_stmt|;
name|scanform
argument_list|(
name|cntval
argument_list|,
operator|(
name|eqcom
condition|?
name|eqformat
else|:
name|stformat
operator|)
argument_list|,
name|itype
argument_list|,
name|ptype
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
literal|'>'
case|:
name|lastcom
operator|=
literal|0
expr_stmt|;
name|savc
operator|=
name|rdc
argument_list|()
expr_stmt|;
if|if
condition|(
operator|(
name|regptr
operator|=
name|getreg
argument_list|(
name|savc
argument_list|)
operator|)
operator|!=
operator|-
literal|1
condition|)
operator|*
operator|(
name|int
operator|*
operator|)
name|regptr
operator|=
name|dot
expr_stmt|;
elseif|else
if|if
condition|(
operator|(
name|modifier
operator|=
name|varchk
argument_list|(
name|savc
argument_list|)
operator|)
operator|!=
operator|-
literal|1
condition|)
name|var
index|[
name|modifier
index|]
operator|=
name|dot
expr_stmt|;
else|else
name|error
argument_list|(
name|BADVAR
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'$'
case|:
name|lastcom
operator|=
literal|0
expr_stmt|;
name|printtrace
argument_list|(
name|nextchar
argument_list|()
argument_list|)
expr_stmt|;
break|break;
case|case
literal|':'
case|:
if|if
condition|(
name|executing
condition|)
break|break;
name|executing
operator|=
literal|1
expr_stmt|;
name|subpcs
argument_list|(
name|nextchar
argument_list|()
argument_list|)
expr_stmt|;
name|executing
operator|=
literal|0
expr_stmt|;
name|lastcom
operator|=
literal|0
expr_stmt|;
break|break;
case|case
literal|'\0'
case|:
break|break;
default|default:
name|error
argument_list|(
name|BADCOM
argument_list|)
expr_stmt|;
block|}
name|flushbuf
argument_list|()
expr_stmt|;
block|}
do|while
condition|(
name|rdc
argument_list|()
operator|==
literal|';'
condition|)
do|;
if|if
condition|(
name|buf
condition|)
name|lp
operator|=
name|savlp
expr_stmt|;
else|else
name|lp
operator|--
expr_stmt|;
return|return
operator|(
name|adrflg
operator|&&
name|dot
operator|!=
literal|0
operator|)
return|;
block|}
end_block

end_unit


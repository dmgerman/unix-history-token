begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  ******************************************************************************  *  * Module: bb_codata.c  *  * Description:   *  * Functions:   *	    bb_put_codata()	- Place a company data entry in the structure.  *	    bb_get_codata()	- Get a company data entry from the structure.  *	    bb_get_imp_cnt()	- Return the number of implementations.  *	    bb_read_companies()	- Read the company data file.  *	    bb_read_1_codata()	- Read a single company data from the file.  *  *  ******************************************************************************  */
end_comment

begin_comment
comment|/*  ******************************************************************************  * Include Files  ******************************************************************************  */
end_comment

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_include
include|#
directive|include
file|<rpc/rpc.h>
end_include

begin_include
include|#
directive|include
file|"common.h"
end_include

begin_include
include|#
directive|include
file|"protocol.h"
end_include

begin_include
include|#
directive|include
file|"server.h"
end_include

begin_decl_stmt
specifier|static
name|int
name|co_cnt
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* The number of company data entries.	*/
end_comment

begin_decl_stmt
specifier|static
name|BB_co_data
name|codata
index|[
name|BB_MAX_IMP
index|]
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* The company data records.	*/
end_comment

begin_function_decl
name|void
name|bb_get_ip_lines
parameter_list|()
function_decl|;
end_function_decl

begin_function_decl
name|char
modifier|*
name|strtok
parameter_list|()
function_decl|;
end_function_decl

begin_function
name|int
name|bb_put_codata
parameter_list|(
name|p_codata
parameter_list|)
name|BB_co_data
modifier|*
name|p_codata
decl_stmt|;
comment|/* The company data to put in the table	*/
block|{
if|if
condition|(
name|co_cnt
operator|+
literal|1
operator|>=
name|BB_MAX_IMP
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"FAILURE can't install company data record: %s.\n"
argument_list|,
name|p_codata
operator|->
name|company
argument_list|)
expr_stmt|;
return|return
name|BB_FAILURE
return|;
block|}
name|memcpy
argument_list|(
operator|&
name|codata
index|[
name|co_cnt
index|]
argument_list|,
name|p_codata
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|p_codata
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|co_cnt
operator|++
return|;
block|}
end_function

begin_function
name|int
name|bb_get_codata
parameter_list|(
name|index
parameter_list|,
name|p_codata
parameter_list|)
name|int
name|index
decl_stmt|;
comment|/* The index of the data to retrieve.	*/
name|BB_co_data
modifier|*
name|p_codata
decl_stmt|;
comment|/* Space to put the data.		*/
block|{
if|if
condition|(
name|index
operator|>=
name|co_cnt
condition|)
block|{
return|return
name|BB_FAILURE
return|;
block|}
name|memcpy
argument_list|(
name|p_codata
argument_list|,
operator|&
name|codata
index|[
name|index
index|]
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|p_codata
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|BB_SUCCESS
return|;
block|}
end_function

begin_function
name|int
name|bb_get_imp_cnt
parameter_list|()
block|{
return|return
name|co_cnt
return|;
block|}
end_function

begin_escape
end_escape

begin_comment
comment|/************************************************************************* **									** **  bb_read_companies() - Read the file containing the company data.	** **  For each entry create a company data record, and add an entry in the** **  hash table.  The company data file also contains IP addresses, which** **  are stored in the ip_table.						** **									** *************************************************************************/
end_comment

begin_function
name|int
name|bb_read_companies
parameter_list|()
block|{
name|int
name|status
decl_stmt|;
comment|/* Status of function call returns.	*/
name|int
name|index
decl_stmt|;
comment|/* Index of the company data record.	*/
name|BB_co_data
name|cdata
decl_stmt|;
comment|/* Space for the readding of records.	*/
while|while
condition|(
operator|(
name|status
operator|=
name|bb_read_1_codata
argument_list|(
operator|&
name|cdata
argument_list|)
operator|)
operator|!=
name|BB_END_OF_FILE
condition|)
block|{
comment|/* 	**  If the read was not successful exit. 	*/
if|if
condition|(
name|status
operator|!=
name|BB_SUCCESS
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"ABORTING: Can't read company data file.\n"
argument_list|)
expr_stmt|;
return|return
name|BB_FAILURE
return|;
block|}
comment|/* 	**  Put the company data record in the array. 	*/
if|if
condition|(
operator|(
name|index
operator|=
name|bb_put_codata
argument_list|(
operator|&
name|cdata
argument_list|)
operator|)
operator|==
name|BB_FAILURE
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"ABORTING: Not enough company data space.\n"
argument_list|)
expr_stmt|;
return|return
name|BB_FAILURE
return|;
block|}
comment|/* 	**  Fill in the hash record for the company data record. 	*/
if|if
condition|(
name|bb_put_hash
argument_list|(
name|codata
index|[
name|index
index|]
operator|.
name|id
argument_list|,
name|index
argument_list|)
operator|!=
name|BB_SUCCESS
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"ABORTING: Unable to hash company: %s.\n"
argument_list|,
name|cdata
operator|.
name|company
argument_list|)
expr_stmt|;
return|return
name|BB_FAILURE
return|;
block|}
block|}
comment|/*     **  Read all of the company data with no problems.     */
return|return
name|BB_SUCCESS
return|;
block|}
end_function

begin_escape
end_escape

begin_comment
comment|/************************************************************************* **									** **  bb_read_1_codata() - Read one company data record from the co data	** **  file.  If the file is not open then open it and start readding. The	** **  file is ordered in the same manner as the BB_co_data structure.  IP	** **  means a set of internet addresses are on the same line.  Each of	** **  these addresses belongs to the companies that follow up to the next	** **  IP specification.							** **									** *************************************************************************/
end_comment

begin_decl_stmt
specifier|static
name|FILE
modifier|*
name|file
init|=
name|NULL
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* File pointer to company data file.	*/
end_comment

begin_function
name|int
name|bb_read_1_codata
parameter_list|(
name|p_codata
parameter_list|)
name|BB_co_data
modifier|*
name|p_codata
decl_stmt|;
comment|/* Output a company data record.	*/
block|{
specifier|static
name|int
name|ip_count
decl_stmt|;
comment|/* Number of IP addresses for company.	*/
specifier|static
name|int
name|ip_index
decl_stmt|;
comment|/* Place where IP addresses start.	*/
name|bool_t
name|done
init|=
name|FALSE
decl_stmt|;
comment|/* Done readding this codata record.	*/
name|char
name|line
index|[
name|BB_MAX_LINE_LEN
index|]
decl_stmt|;
comment|/* Input line buffer.		*/
comment|/*     **  If the file is not open then it neads to be.     */
if|if
condition|(
name|file
operator|==
name|NULL
condition|)
block|{
if|if
condition|(
operator|(
name|file
operator|=
name|fopen
argument_list|(
name|BB_CODATA_FILE
argument_list|,
literal|"r"
argument_list|)
operator|)
operator|==
name|NULL
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"FAILED opening the company data file '%s'.\n"
argument_list|,
name|BB_CODATA_FILE
argument_list|)
expr_stmt|;
return|return
name|BB_FAILURE
return|;
block|}
name|ip_count
operator|=
name|ip_index
operator|=
literal|0
expr_stmt|;
block|}
while|while
condition|(
name|done
operator|!=
name|TRUE
condition|)
block|{
do|do
block|{
if|if
condition|(
name|fgets
argument_list|(
name|line
argument_list|,
name|BB_MAX_LINE_LEN
argument_list|,
name|file
argument_list|)
operator|==
name|NULL
condition|)
block|{
return|return
name|BB_END_OF_FILE
return|;
block|}
block|}
do|while
condition|(
name|line
index|[
literal|0
index|]
operator|==
name|BB_COMMENT_DESIGNATOR
condition|)
do|;
switch|switch
condition|(
name|line
index|[
name|BB_DES_CHAR
index|]
condition|)
block|{
case|case
name|BB_IP_DESIGNATOR
case|:
name|bb_get_ip_lines
argument_list|(
operator|&
name|line
index|[
name|BB_DES_START
index|]
argument_list|,
operator|&
name|ip_count
argument_list|,
operator|&
name|ip_index
argument_list|)
expr_stmt|;
break|break;
case|case
name|BB_CO_DESIGNATOR
case|:
name|line
index|[
name|strlen
argument_list|(
name|line
argument_list|)
operator|-
literal|1
index|]
operator|=
name|NUL
expr_stmt|;
name|strncpy
argument_list|(
name|p_codata
operator|->
name|company
argument_list|,
operator|&
name|line
index|[
name|BB_DES_START
index|]
argument_list|,
name|BB_COMPANY_NAME_LEN
argument_list|)
expr_stmt|;
break|break;
case|case
name|BB_IMP_DESIGNATOR
case|:
name|line
index|[
name|strlen
argument_list|(
name|line
argument_list|)
operator|-
literal|1
index|]
operator|=
name|NUL
expr_stmt|;
name|strncpy
argument_list|(
name|p_codata
operator|->
name|imp
argument_list|,
operator|&
name|line
index|[
name|BB_DES_START
index|]
argument_list|,
name|BB_IMP_NAME_LEN
argument_list|)
expr_stmt|;
break|break;
case|case
name|BB_ID_DESIGNATOR
case|:
name|line
index|[
name|strlen
argument_list|(
name|line
argument_list|)
operator|-
literal|1
index|]
operator|=
name|NUL
expr_stmt|;
name|strncpy
argument_list|(
name|p_codata
operator|->
name|id
argument_list|,
operator|&
name|line
index|[
name|BB_DES_START
index|]
argument_list|,
name|BB_ID_NAME_LEN
argument_list|)
expr_stmt|;
break|break;
case|case
name|BB_BOOTH_DESIGNATOR
case|:
name|p_codata
operator|->
name|booth
operator|=
name|atoi
argument_list|(
operator|&
name|line
index|[
name|BB_DES_START
index|]
argument_list|)
expr_stmt|;
break|break;
case|case
name|BB_FLAGS_DESIGNATOR
case|:
name|p_codata
operator|->
name|flags
operator|=
name|atoi
argument_list|(
operator|&
name|line
index|[
name|BB_DES_START
index|]
argument_list|)
expr_stmt|;
break|break;
case|case
name|BB_END_DESIGNATOR
case|:
name|done
operator|=
name|TRUE
expr_stmt|;
break|break;
default|default :
if|if
condition|(
name|line
index|[
literal|0
index|]
operator|!=
literal|'\n'
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"ERROR: Invalid field designator '%s'.\n"
argument_list|,
name|line
argument_list|)
expr_stmt|;
block|}
break|break;
block|}
block|}
name|p_codata
operator|->
name|ip_cnt
operator|=
name|ip_count
expr_stmt|;
name|p_codata
operator|->
name|ip_idx
operator|=
name|ip_index
expr_stmt|;
return|return
name|BB_SUCCESS
return|;
block|}
end_function

end_unit


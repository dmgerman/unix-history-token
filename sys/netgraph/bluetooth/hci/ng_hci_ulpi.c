begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * ng_hci_ulpi.c  */
end_comment

begin_comment
comment|/*-  * Copyright (c) Maksim Yevmenkin<m_evmenkin@yahoo.com>  * All rights reserved.  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions  * are met:  * 1. Redistributions of source code must retain the above copyright  *    notice, this list of conditions and the following disclaimer.  * 2. Redistributions in binary form must reproduce the above copyright  *    notice, this list of conditions and the following disclaimer in the  *    documentation and/or other materials provided with the distribution.  *  * THIS SOFTWARE IS PROVIDED BY THE AUTHOR AND CONTRIBUTORS ``AS IS'' AND  * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE  * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE  * ARE DISCLAIMED. IN NO EVENT SHALL THE AUTHOR OR CONTRIBUTORS BE LIABLE  * FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL  * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS  * OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)  * HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT  * LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY  * OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF  * SUCH DAMAGE.  *  * $Id: ng_hci_ulpi.c,v 1.7 2003/09/08 18:57:51 max Exp $  * $FreeBSD$  */
end_comment

begin_include
include|#
directive|include
file|<sys/param.h>
end_include

begin_include
include|#
directive|include
file|<sys/systm.h>
end_include

begin_include
include|#
directive|include
file|<sys/kernel.h>
end_include

begin_include
include|#
directive|include
file|<sys/endian.h>
end_include

begin_include
include|#
directive|include
file|<sys/malloc.h>
end_include

begin_include
include|#
directive|include
file|<sys/mbuf.h>
end_include

begin_include
include|#
directive|include
file|<sys/queue.h>
end_include

begin_include
include|#
directive|include
file|<netgraph/ng_message.h>
end_include

begin_include
include|#
directive|include
file|<netgraph/netgraph.h>
end_include

begin_include
include|#
directive|include
file|<netgraph/bluetooth/include/ng_bluetooth.h>
end_include

begin_include
include|#
directive|include
file|<netgraph/bluetooth/include/ng_hci.h>
end_include

begin_include
include|#
directive|include
file|<netgraph/bluetooth/hci/ng_hci_var.h>
end_include

begin_include
include|#
directive|include
file|<netgraph/bluetooth/hci/ng_hci_cmds.h>
end_include

begin_include
include|#
directive|include
file|<netgraph/bluetooth/hci/ng_hci_evnt.h>
end_include

begin_include
include|#
directive|include
file|<netgraph/bluetooth/hci/ng_hci_ulpi.h>
end_include

begin_include
include|#
directive|include
file|<netgraph/bluetooth/hci/ng_hci_misc.h>
end_include

begin_comment
comment|/******************************************************************************  ******************************************************************************  **                 Upper Layer Protocol Interface module  ******************************************************************************  ******************************************************************************/
end_comment

begin_function_decl
specifier|static
name|int
name|ng_hci_lp_acl_con_req
parameter_list|(
name|ng_hci_unit_p
parameter_list|,
name|item_p
parameter_list|,
name|hook_p
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|ng_hci_lp_sco_con_req
parameter_list|(
name|ng_hci_unit_p
parameter_list|,
name|item_p
parameter_list|,
name|hook_p
parameter_list|)
function_decl|;
end_function_decl

begin_comment
comment|/*  * Process LP_ConnectReq event from the upper layer protocol  */
end_comment

begin_function
name|int
name|ng_hci_lp_con_req
parameter_list|(
name|ng_hci_unit_p
name|unit
parameter_list|,
name|item_p
name|item
parameter_list|,
name|hook_p
name|hook
parameter_list|)
block|{
if|if
condition|(
operator|(
name|unit
operator|->
name|state
operator|&
name|NG_HCI_UNIT_READY
operator|)
operator|!=
name|NG_HCI_UNIT_READY
condition|)
block|{
name|NG_HCI_WARN
argument_list|(
literal|"%s: %s - unit is not ready, state=%#x\n"
argument_list|,
name|__func__
argument_list|,
name|NG_NODE_NAME
argument_list|(
name|unit
operator|->
name|node
argument_list|)
argument_list|,
name|unit
operator|->
name|state
argument_list|)
expr_stmt|;
name|NG_FREE_ITEM
argument_list|(
name|item
argument_list|)
expr_stmt|;
return|return
operator|(
name|ENXIO
operator|)
return|;
block|}
if|if
condition|(
name|NGI_MSG
argument_list|(
name|item
argument_list|)
operator|->
name|header
operator|.
name|arglen
operator|!=
sizeof|sizeof
argument_list|(
name|ng_hci_lp_con_req_ep
argument_list|)
condition|)
block|{
name|NG_HCI_ALERT
argument_list|(
literal|"%s: %s - invalid LP_ConnectReq message size=%d\n"
argument_list|,
name|__func__
argument_list|,
name|NG_NODE_NAME
argument_list|(
name|unit
operator|->
name|node
argument_list|)
argument_list|,
name|NGI_MSG
argument_list|(
name|item
argument_list|)
operator|->
name|header
operator|.
name|arglen
argument_list|)
expr_stmt|;
name|NG_FREE_ITEM
argument_list|(
name|item
argument_list|)
expr_stmt|;
return|return
operator|(
name|EMSGSIZE
operator|)
return|;
block|}
if|if
condition|(
operator|(
operator|(
name|ng_hci_lp_con_req_ep
operator|*
operator|)
operator|(
name|NGI_MSG
argument_list|(
name|item
argument_list|)
operator|->
name|data
operator|)
operator|)
operator|->
name|link_type
operator|==
name|NG_HCI_LINK_ACL
condition|)
return|return
operator|(
name|ng_hci_lp_acl_con_req
argument_list|(
name|unit
argument_list|,
name|item
argument_list|,
name|hook
argument_list|)
operator|)
return|;
if|if
condition|(
name|hook
operator|!=
name|unit
operator|->
name|sco
condition|)
block|{
name|NG_HCI_WARN
argument_list|(
literal|"%s: %s - LP_ConnectReq for SCO connection came from wrong hook=%p\n"
argument_list|,
name|__func__
argument_list|,
name|NG_NODE_NAME
argument_list|(
name|unit
operator|->
name|node
argument_list|)
argument_list|,
name|hook
argument_list|)
expr_stmt|;
name|NG_FREE_ITEM
argument_list|(
name|item
argument_list|)
expr_stmt|;
return|return
operator|(
name|EINVAL
operator|)
return|;
block|}
return|return
operator|(
name|ng_hci_lp_sco_con_req
argument_list|(
name|unit
argument_list|,
name|item
argument_list|,
name|hook
argument_list|)
operator|)
return|;
block|}
end_function

begin_comment
comment|/* ng_hci_lp_con_req */
end_comment

begin_comment
comment|/*  * Request to create new ACL connection  */
end_comment

begin_function
specifier|static
name|int
name|ng_hci_lp_acl_con_req
parameter_list|(
name|ng_hci_unit_p
name|unit
parameter_list|,
name|item_p
name|item
parameter_list|,
name|hook_p
name|hook
parameter_list|)
block|{
struct|struct
name|acl_con_req
block|{
name|ng_hci_cmd_pkt_t
name|hdr
decl_stmt|;
name|ng_hci_create_con_cp
name|cp
decl_stmt|;
block|}
name|__attribute__
argument_list|(
operator|(
name|packed
operator|)
argument_list|)
modifier|*
name|req
init|=
name|NULL
struct|;
name|ng_hci_lp_con_req_ep
modifier|*
name|ep
init|=
name|NULL
decl_stmt|;
name|ng_hci_unit_con_p
name|con
init|=
name|NULL
decl_stmt|;
name|ng_hci_neighbor_t
modifier|*
name|n
init|=
name|NULL
decl_stmt|;
name|struct
name|mbuf
modifier|*
name|m
init|=
name|NULL
decl_stmt|;
name|int
name|error
init|=
literal|0
decl_stmt|;
name|ep
operator|=
operator|(
name|ng_hci_lp_con_req_ep
operator|*
operator|)
operator|(
name|NGI_MSG
argument_list|(
name|item
argument_list|)
operator|->
name|data
operator|)
expr_stmt|;
comment|/* 	 * Only one ACL connection can exist between each pair of units. 	 * So try to find ACL connection descriptor (in any state) that 	 * has requested remote BD_ADDR. 	 * 	 * Two cases: 	 * 	 * 1) We do not have connection to the remote unit. This is simple. 	 *    Just create new connection descriptor and send HCI command to 	 *    create new connection. 	 * 	 * 2) We do have connection descriptor. We need to check connection 	 *    state: 	 *  	 * 2.1) NG_HCI_CON_W4_LP_CON_RSP means that we are in the middle of 	 *      accepting connection from the remote unit. This is a race 	 *      condition. We will ignore this message. 	 * 	 * 2.2) NG_HCI_CON_W4_CONN_COMPLETE means that upper layer already 	 *      requested connection or we just accepted it. In any case 	 *      all we need to do here is set appropriate notification bit 	 *      and wait. 	 *	 	 * 2.3) NG_HCI_CON_OPEN means connection is open. Just reply back 	 *      and let upper layer know that we have connection already. 	 */
name|con
operator|=
name|ng_hci_con_by_bdaddr
argument_list|(
name|unit
argument_list|,
operator|&
name|ep
operator|->
name|bdaddr
argument_list|,
name|NG_HCI_LINK_ACL
argument_list|)
expr_stmt|;
if|if
condition|(
name|con
operator|!=
name|NULL
condition|)
block|{
switch|switch
condition|(
name|con
operator|->
name|state
condition|)
block|{
case|case
name|NG_HCI_CON_W4_LP_CON_RSP
case|:
comment|/* XXX */
name|error
operator|=
name|EALREADY
expr_stmt|;
break|break;
case|case
name|NG_HCI_CON_W4_CONN_COMPLETE
case|:
if|if
condition|(
name|hook
operator|==
name|unit
operator|->
name|acl
condition|)
name|con
operator|->
name|flags
operator||=
name|NG_HCI_CON_NOTIFY_ACL
expr_stmt|;
else|else
name|con
operator|->
name|flags
operator||=
name|NG_HCI_CON_NOTIFY_SCO
expr_stmt|;
break|break;
case|case
name|NG_HCI_CON_OPEN
case|:
block|{
name|struct
name|ng_mesg
modifier|*
name|msg
init|=
name|NULL
decl_stmt|;
name|ng_hci_lp_con_cfm_ep
modifier|*
name|cfm
init|=
name|NULL
decl_stmt|;
if|if
condition|(
name|hook
operator|!=
name|NULL
operator|&&
name|NG_HOOK_IS_VALID
argument_list|(
name|hook
argument_list|)
condition|)
block|{
name|NGI_GET_MSG
argument_list|(
name|item
argument_list|,
name|msg
argument_list|)
expr_stmt|;
name|NG_FREE_MSG
argument_list|(
name|msg
argument_list|)
expr_stmt|;
name|NG_MKMESSAGE
argument_list|(
name|msg
argument_list|,
name|NGM_HCI_COOKIE
argument_list|,
name|NGM_HCI_LP_CON_CFM
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|cfm
argument_list|)
argument_list|,
name|M_NOWAIT
argument_list|)
expr_stmt|;
if|if
condition|(
name|msg
operator|!=
name|NULL
condition|)
block|{
name|cfm
operator|=
operator|(
name|ng_hci_lp_con_cfm_ep
operator|*
operator|)
name|msg
operator|->
name|data
expr_stmt|;
name|cfm
operator|->
name|status
operator|=
literal|0
expr_stmt|;
name|cfm
operator|->
name|link_type
operator|=
name|con
operator|->
name|link_type
expr_stmt|;
name|cfm
operator|->
name|con_handle
operator|=
name|con
operator|->
name|con_handle
expr_stmt|;
name|bcopy
argument_list|(
operator|&
name|con
operator|->
name|bdaddr
argument_list|,
operator|&
name|cfm
operator|->
name|bdaddr
argument_list|,
sizeof|sizeof
argument_list|(
name|cfm
operator|->
name|bdaddr
argument_list|)
argument_list|)
expr_stmt|;
comment|/* 					 * This will forward item back to 					 * sender and set item to NULL 					 */
name|_NGI_MSG
argument_list|(
name|item
argument_list|)
operator|=
name|msg
expr_stmt|;
name|NG_FWD_ITEM_HOOK
argument_list|(
name|error
argument_list|,
name|item
argument_list|,
name|hook
argument_list|)
expr_stmt|;
block|}
else|else
name|error
operator|=
name|ENOMEM
expr_stmt|;
block|}
else|else
name|NG_HCI_INFO
argument_list|(
literal|"%s: %s - Source hook is not valid, hook=%p\n"
argument_list|,
name|__func__
argument_list|,
name|NG_NODE_NAME
argument_list|(
name|unit
operator|->
name|node
argument_list|)
argument_list|,
name|hook
argument_list|)
expr_stmt|;
block|}
break|break;
default|default:
name|panic
argument_list|(
literal|"%s: %s - Invalid connection state=%d\n"
argument_list|,
name|__func__
argument_list|,
name|NG_NODE_NAME
argument_list|(
name|unit
operator|->
name|node
argument_list|)
argument_list|,
name|con
operator|->
name|state
argument_list|)
expr_stmt|;
break|break;
block|}
goto|goto
name|out
goto|;
block|}
comment|/* 	 * If we got here then we need to create new ACL connection descriptor 	 * and submit HCI command. First create new connection desriptor, set 	 * bdaddr and notification flags. 	 */
name|con
operator|=
name|ng_hci_new_con
argument_list|(
name|unit
argument_list|,
name|NG_HCI_LINK_ACL
argument_list|)
expr_stmt|;
if|if
condition|(
name|con
operator|==
name|NULL
condition|)
block|{
name|error
operator|=
name|ENOMEM
expr_stmt|;
goto|goto
name|out
goto|;
block|}
name|bcopy
argument_list|(
operator|&
name|ep
operator|->
name|bdaddr
argument_list|,
operator|&
name|con
operator|->
name|bdaddr
argument_list|,
sizeof|sizeof
argument_list|(
name|con
operator|->
name|bdaddr
argument_list|)
argument_list|)
expr_stmt|;
comment|/*  	 * Create HCI command  	 */
name|MGETHDR
argument_list|(
name|m
argument_list|,
name|M_DONTWAIT
argument_list|,
name|MT_DATA
argument_list|)
expr_stmt|;
if|if
condition|(
name|m
operator|==
name|NULL
condition|)
block|{
name|ng_hci_free_con
argument_list|(
name|con
argument_list|)
expr_stmt|;
name|error
operator|=
name|ENOBUFS
expr_stmt|;
goto|goto
name|out
goto|;
block|}
name|m
operator|->
name|m_pkthdr
operator|.
name|len
operator|=
name|m
operator|->
name|m_len
operator|=
sizeof|sizeof
argument_list|(
operator|*
name|req
argument_list|)
expr_stmt|;
name|req
operator|=
name|mtod
argument_list|(
name|m
argument_list|,
expr|struct
name|acl_con_req
operator|*
argument_list|)
expr_stmt|;
name|req
operator|->
name|hdr
operator|.
name|type
operator|=
name|NG_HCI_CMD_PKT
expr_stmt|;
name|req
operator|->
name|hdr
operator|.
name|length
operator|=
sizeof|sizeof
argument_list|(
name|req
operator|->
name|cp
argument_list|)
expr_stmt|;
name|req
operator|->
name|hdr
operator|.
name|opcode
operator|=
name|htole16
argument_list|(
name|NG_HCI_OPCODE
argument_list|(
name|NG_HCI_OGF_LINK_CONTROL
argument_list|,
name|NG_HCI_OCF_CREATE_CON
argument_list|)
argument_list|)
expr_stmt|;
name|bcopy
argument_list|(
operator|&
name|ep
operator|->
name|bdaddr
argument_list|,
operator|&
name|req
operator|->
name|cp
operator|.
name|bdaddr
argument_list|,
sizeof|sizeof
argument_list|(
name|req
operator|->
name|cp
operator|.
name|bdaddr
argument_list|)
argument_list|)
expr_stmt|;
name|req
operator|->
name|cp
operator|.
name|pkt_type
operator|=
operator|(
name|NG_HCI_PKT_DM1
operator||
name|NG_HCI_PKT_DH1
operator|)
expr_stmt|;
if|if
condition|(
name|unit
operator|->
name|features
index|[
literal|0
index|]
operator|&
name|NG_HCI_LMP_3SLOT
condition|)
name|req
operator|->
name|cp
operator|.
name|pkt_type
operator||=
operator|(
name|NG_HCI_PKT_DM3
operator||
name|NG_HCI_PKT_DH3
operator|)
expr_stmt|;
if|if
condition|(
name|unit
operator|->
name|features
index|[
literal|0
index|]
operator|&
name|NG_HCI_LMP_5SLOT
condition|)
name|req
operator|->
name|cp
operator|.
name|pkt_type
operator||=
operator|(
name|NG_HCI_PKT_DM5
operator||
name|NG_HCI_PKT_DH5
operator|)
expr_stmt|;
name|req
operator|->
name|cp
operator|.
name|pkt_type
operator|&=
name|unit
operator|->
name|packet_mask
expr_stmt|;
if|if
condition|(
operator|(
name|req
operator|->
name|cp
operator|.
name|pkt_type
operator|&
operator|(
name|NG_HCI_PKT_DM1
operator||
name|NG_HCI_PKT_DH1
operator||
name|NG_HCI_PKT_DM3
operator||
name|NG_HCI_PKT_DH3
operator||
name|NG_HCI_PKT_DM5
operator||
name|NG_HCI_PKT_DH5
operator|)
operator|)
operator|==
literal|0
condition|)
name|req
operator|->
name|cp
operator|.
name|pkt_type
operator|=
operator|(
name|NG_HCI_PKT_DM1
operator||
name|NG_HCI_PKT_DH1
operator|)
expr_stmt|;
name|req
operator|->
name|cp
operator|.
name|pkt_type
operator|=
name|htole16
argument_list|(
name|req
operator|->
name|cp
operator|.
name|pkt_type
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|unit
operator|->
name|features
index|[
literal|0
index|]
operator|&
name|NG_HCI_LMP_SWITCH
operator|)
operator|&&
name|unit
operator|->
name|role_switch
condition|)
name|req
operator|->
name|cp
operator|.
name|accept_role_switch
operator|=
literal|1
expr_stmt|;
else|else
name|req
operator|->
name|cp
operator|.
name|accept_role_switch
operator|=
literal|0
expr_stmt|;
comment|/* 	 * We may speed up connect by specifying valid parameters.  	 * So check the neighbor cache. 	 */
name|n
operator|=
name|ng_hci_get_neighbor
argument_list|(
name|unit
argument_list|,
operator|&
name|ep
operator|->
name|bdaddr
argument_list|)
expr_stmt|;
if|if
condition|(
name|n
operator|==
name|NULL
condition|)
block|{
name|req
operator|->
name|cp
operator|.
name|page_scan_rep_mode
operator|=
literal|0
expr_stmt|;
name|req
operator|->
name|cp
operator|.
name|page_scan_mode
operator|=
literal|0
expr_stmt|;
name|req
operator|->
name|cp
operator|.
name|clock_offset
operator|=
literal|0
expr_stmt|;
block|}
else|else
block|{
name|req
operator|->
name|cp
operator|.
name|page_scan_rep_mode
operator|=
name|n
operator|->
name|page_scan_rep_mode
expr_stmt|;
name|req
operator|->
name|cp
operator|.
name|page_scan_mode
operator|=
name|n
operator|->
name|page_scan_mode
expr_stmt|;
name|req
operator|->
name|cp
operator|.
name|clock_offset
operator|=
name|htole16
argument_list|(
name|n
operator|->
name|clock_offset
argument_list|)
expr_stmt|;
block|}
comment|/*  	 * Adust connection state  	 */
if|if
condition|(
name|hook
operator|==
name|unit
operator|->
name|acl
condition|)
name|con
operator|->
name|flags
operator||=
name|NG_HCI_CON_NOTIFY_ACL
expr_stmt|;
else|else
name|con
operator|->
name|flags
operator||=
name|NG_HCI_CON_NOTIFY_SCO
expr_stmt|;
name|con
operator|->
name|state
operator|=
name|NG_HCI_CON_W4_CONN_COMPLETE
expr_stmt|;
name|ng_hci_con_timeout
argument_list|(
name|con
argument_list|)
expr_stmt|;
comment|/*  	 * Queue and send HCI command  	 */
name|NG_BT_MBUFQ_ENQUEUE
argument_list|(
operator|&
name|unit
operator|->
name|cmdq
argument_list|,
name|m
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|unit
operator|->
name|state
operator|&
name|NG_HCI_UNIT_COMMAND_PENDING
operator|)
condition|)
name|error
operator|=
name|ng_hci_send_command
argument_list|(
name|unit
argument_list|)
expr_stmt|;
name|out
label|:
if|if
condition|(
name|item
operator|!=
name|NULL
condition|)
name|NG_FREE_ITEM
argument_list|(
name|item
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
end_function

begin_comment
comment|/* ng_hci_lp_acl_con_req */
end_comment

begin_comment
comment|/*  * Request to create new SCO connection  */
end_comment

begin_function
specifier|static
name|int
name|ng_hci_lp_sco_con_req
parameter_list|(
name|ng_hci_unit_p
name|unit
parameter_list|,
name|item_p
name|item
parameter_list|,
name|hook_p
name|hook
parameter_list|)
block|{
struct|struct
name|sco_con_req
block|{
name|ng_hci_cmd_pkt_t
name|hdr
decl_stmt|;
name|ng_hci_add_sco_con_cp
name|cp
decl_stmt|;
block|}
name|__attribute__
argument_list|(
operator|(
name|packed
operator|)
argument_list|)
modifier|*
name|req
init|=
name|NULL
struct|;
name|ng_hci_lp_con_req_ep
modifier|*
name|ep
init|=
name|NULL
decl_stmt|;
name|ng_hci_unit_con_p
name|acl_con
init|=
name|NULL
decl_stmt|,
name|sco_con
init|=
name|NULL
decl_stmt|;
name|struct
name|mbuf
modifier|*
name|m
init|=
name|NULL
decl_stmt|;
name|int
name|error
init|=
literal|0
decl_stmt|;
name|ep
operator|=
operator|(
name|ng_hci_lp_con_req_ep
operator|*
operator|)
operator|(
name|NGI_MSG
argument_list|(
name|item
argument_list|)
operator|->
name|data
operator|)
expr_stmt|;
comment|/* 	 * SCO connection without ACL link 	 * 	 * If upper layer requests SCO connection and there is no open ACL  	 * connection to the desired remote unit, we will reject the request. 	 */
name|LIST_FOREACH
argument_list|(
argument|acl_con
argument_list|,
argument|&unit->con_list
argument_list|,
argument|next
argument_list|)
if|if
condition|(
name|acl_con
operator|->
name|link_type
operator|==
name|NG_HCI_LINK_ACL
operator|&&
name|acl_con
operator|->
name|state
operator|==
name|NG_HCI_CON_OPEN
operator|&&
name|bcmp
argument_list|(
operator|&
name|acl_con
operator|->
name|bdaddr
argument_list|,
operator|&
name|ep
operator|->
name|bdaddr
argument_list|,
sizeof|sizeof
argument_list|(
name|bdaddr_t
argument_list|)
argument_list|)
operator|==
literal|0
condition|)
break|break;
if|if
condition|(
name|acl_con
operator|==
name|NULL
condition|)
block|{
name|NG_HCI_INFO
argument_list|(
literal|"%s: %s - No open ACL connection to bdaddr=%x:%x:%x:%x:%x:%x\n"
argument_list|,
name|__func__
argument_list|,
name|NG_NODE_NAME
argument_list|(
name|unit
operator|->
name|node
argument_list|)
argument_list|,
name|ep
operator|->
name|bdaddr
operator|.
name|b
index|[
literal|5
index|]
argument_list|,
name|ep
operator|->
name|bdaddr
operator|.
name|b
index|[
literal|4
index|]
argument_list|,
name|ep
operator|->
name|bdaddr
operator|.
name|b
index|[
literal|3
index|]
argument_list|,
name|ep
operator|->
name|bdaddr
operator|.
name|b
index|[
literal|2
index|]
argument_list|,
name|ep
operator|->
name|bdaddr
operator|.
name|b
index|[
literal|1
index|]
argument_list|,
name|ep
operator|->
name|bdaddr
operator|.
name|b
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
name|error
operator|=
name|ENOENT
expr_stmt|;
goto|goto
name|out
goto|;
block|}
comment|/* 	 * Multiple SCO connections can exist between the same pair of units. 	 * We assume that multiple SCO connections have to be opened one after  	 * another.  	 * 	 * Try to find SCO connection descriptor that matches the following: 	 * 	 * 1) sco_con->link_type == NG_HCI_LINK_SCO 	 *  	 * 2) sco_con->state == NG_HCI_CON_W4_LP_CON_RSP || 	 *    sco_con->state == NG_HCI_CON_W4_CONN_COMPLETE 	 *  	 * 3) sco_con->bdaddr == ep->bdaddr 	 * 	 * Two cases: 	 * 	 * 1) We do not have connection descriptor. This is simple. Just  	 *    create new connection and submit Add_SCO_Connection command. 	 * 	 * 2) We do have connection descriptor. We need to check the state. 	 * 	 * 2.1) NG_HCI_CON_W4_LP_CON_RSP means we in the middle of accepting 	 *      connection from the remote unit. This is a race condition and 	 *      we will ignore the request. 	 * 	 * 2.2) NG_HCI_CON_W4_CONN_COMPLETE means upper layer already requested 	 *      connection or we just accepted it. 	 */
name|LIST_FOREACH
argument_list|(
argument|sco_con
argument_list|,
argument|&unit->con_list
argument_list|,
argument|next
argument_list|)
if|if
condition|(
name|sco_con
operator|->
name|link_type
operator|==
name|NG_HCI_LINK_SCO
operator|&&
operator|(
name|sco_con
operator|->
name|state
operator|==
name|NG_HCI_CON_W4_LP_CON_RSP
operator|||
name|sco_con
operator|->
name|state
operator|==
name|NG_HCI_CON_W4_CONN_COMPLETE
operator|)
operator|&&
name|bcmp
argument_list|(
operator|&
name|sco_con
operator|->
name|bdaddr
argument_list|,
operator|&
name|ep
operator|->
name|bdaddr
argument_list|,
sizeof|sizeof
argument_list|(
name|bdaddr_t
argument_list|)
argument_list|)
operator|==
literal|0
condition|)
break|break;
if|if
condition|(
name|sco_con
operator|!=
name|NULL
condition|)
block|{
switch|switch
condition|(
name|sco_con
operator|->
name|state
condition|)
block|{
case|case
name|NG_HCI_CON_W4_LP_CON_RSP
case|:
comment|/* XXX */
name|error
operator|=
name|EALREADY
expr_stmt|;
break|break;
case|case
name|NG_HCI_CON_W4_CONN_COMPLETE
case|:
name|sco_con
operator|->
name|flags
operator||=
name|NG_HCI_CON_NOTIFY_SCO
expr_stmt|;
break|break;
default|default:
name|panic
argument_list|(
literal|"%s: %s - Inavalid connection state=%d\n"
argument_list|,
name|__func__
argument_list|,
name|NG_NODE_NAME
argument_list|(
name|unit
operator|->
name|node
argument_list|)
argument_list|,
name|sco_con
operator|->
name|state
argument_list|)
expr_stmt|;
break|break;
block|}
goto|goto
name|out
goto|;
block|}
comment|/* 	 * If we got here then we need to create new SCO connection descriptor 	 * and submit HCI command. 	 */
name|sco_con
operator|=
name|ng_hci_new_con
argument_list|(
name|unit
argument_list|,
name|NG_HCI_LINK_SCO
argument_list|)
expr_stmt|;
if|if
condition|(
name|sco_con
operator|==
name|NULL
condition|)
block|{
name|error
operator|=
name|ENOMEM
expr_stmt|;
goto|goto
name|out
goto|;
block|}
name|bcopy
argument_list|(
operator|&
name|ep
operator|->
name|bdaddr
argument_list|,
operator|&
name|sco_con
operator|->
name|bdaddr
argument_list|,
sizeof|sizeof
argument_list|(
name|sco_con
operator|->
name|bdaddr
argument_list|)
argument_list|)
expr_stmt|;
comment|/*  	 * Create HCI command  	 */
name|MGETHDR
argument_list|(
name|m
argument_list|,
name|M_DONTWAIT
argument_list|,
name|MT_DATA
argument_list|)
expr_stmt|;
if|if
condition|(
name|m
operator|==
name|NULL
condition|)
block|{
name|ng_hci_free_con
argument_list|(
name|sco_con
argument_list|)
expr_stmt|;
name|error
operator|=
name|ENOBUFS
expr_stmt|;
goto|goto
name|out
goto|;
block|}
name|m
operator|->
name|m_pkthdr
operator|.
name|len
operator|=
name|m
operator|->
name|m_len
operator|=
sizeof|sizeof
argument_list|(
operator|*
name|req
argument_list|)
expr_stmt|;
name|req
operator|=
name|mtod
argument_list|(
name|m
argument_list|,
expr|struct
name|sco_con_req
operator|*
argument_list|)
expr_stmt|;
name|req
operator|->
name|hdr
operator|.
name|type
operator|=
name|NG_HCI_CMD_PKT
expr_stmt|;
name|req
operator|->
name|hdr
operator|.
name|length
operator|=
sizeof|sizeof
argument_list|(
name|req
operator|->
name|cp
argument_list|)
expr_stmt|;
name|req
operator|->
name|hdr
operator|.
name|opcode
operator|=
name|htole16
argument_list|(
name|NG_HCI_OPCODE
argument_list|(
name|NG_HCI_OGF_LINK_CONTROL
argument_list|,
name|NG_HCI_OCF_ADD_SCO_CON
argument_list|)
argument_list|)
expr_stmt|;
name|req
operator|->
name|cp
operator|.
name|con_handle
operator|=
name|htole16
argument_list|(
name|acl_con
operator|->
name|con_handle
argument_list|)
expr_stmt|;
name|req
operator|->
name|cp
operator|.
name|pkt_type
operator|=
name|NG_HCI_PKT_HV1
expr_stmt|;
if|if
condition|(
name|unit
operator|->
name|features
index|[
literal|1
index|]
operator|&
name|NG_HCI_LMP_HV2_PKT
condition|)
name|req
operator|->
name|cp
operator|.
name|pkt_type
operator||=
name|NG_HCI_PKT_HV2
expr_stmt|;
if|if
condition|(
name|unit
operator|->
name|features
index|[
literal|1
index|]
operator|&
name|NG_HCI_LMP_HV3_PKT
condition|)
name|req
operator|->
name|cp
operator|.
name|pkt_type
operator||=
name|NG_HCI_PKT_HV3
expr_stmt|;
name|req
operator|->
name|cp
operator|.
name|pkt_type
operator|&=
name|unit
operator|->
name|packet_mask
expr_stmt|;
if|if
condition|(
operator|(
name|req
operator|->
name|cp
operator|.
name|pkt_type
operator|&
operator|(
name|NG_HCI_PKT_HV1
operator||
name|NG_HCI_PKT_HV2
operator||
name|NG_HCI_PKT_HV3
operator|)
operator|)
operator|==
literal|0
condition|)
name|req
operator|->
name|cp
operator|.
name|pkt_type
operator|=
name|NG_HCI_PKT_HV1
expr_stmt|;
name|req
operator|->
name|cp
operator|.
name|pkt_type
operator|=
name|htole16
argument_list|(
name|req
operator|->
name|cp
operator|.
name|pkt_type
argument_list|)
expr_stmt|;
comment|/*  	 * Adust connection state 	 */
name|sco_con
operator|->
name|flags
operator||=
name|NG_HCI_CON_NOTIFY_SCO
expr_stmt|;
name|sco_con
operator|->
name|state
operator|=
name|NG_HCI_CON_W4_CONN_COMPLETE
expr_stmt|;
name|ng_hci_con_timeout
argument_list|(
name|sco_con
argument_list|)
expr_stmt|;
comment|/*  	 * Queue and send HCI command 	 */
name|NG_BT_MBUFQ_ENQUEUE
argument_list|(
operator|&
name|unit
operator|->
name|cmdq
argument_list|,
name|m
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|unit
operator|->
name|state
operator|&
name|NG_HCI_UNIT_COMMAND_PENDING
operator|)
condition|)
name|error
operator|=
name|ng_hci_send_command
argument_list|(
name|unit
argument_list|)
expr_stmt|;
name|out
label|:
name|NG_FREE_ITEM
argument_list|(
name|item
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
end_function

begin_comment
comment|/* ng_hci_lp_sco_con_req */
end_comment

begin_comment
comment|/*  * Process LP_DisconnectReq event from the upper layer protocol  */
end_comment

begin_function
name|int
name|ng_hci_lp_discon_req
parameter_list|(
name|ng_hci_unit_p
name|unit
parameter_list|,
name|item_p
name|item
parameter_list|,
name|hook_p
name|hook
parameter_list|)
block|{
struct|struct
name|discon_req
block|{
name|ng_hci_cmd_pkt_t
name|hdr
decl_stmt|;
name|ng_hci_discon_cp
name|cp
decl_stmt|;
block|}
name|__attribute__
argument_list|(
operator|(
name|packed
operator|)
argument_list|)
modifier|*
name|req
init|=
name|NULL
struct|;
name|ng_hci_lp_discon_req_ep
modifier|*
name|ep
init|=
name|NULL
decl_stmt|;
name|ng_hci_unit_con_p
name|con
init|=
name|NULL
decl_stmt|;
name|struct
name|mbuf
modifier|*
name|m
init|=
name|NULL
decl_stmt|;
name|int
name|error
init|=
literal|0
decl_stmt|;
comment|/* Check if unit is ready */
if|if
condition|(
operator|(
name|unit
operator|->
name|state
operator|&
name|NG_HCI_UNIT_READY
operator|)
operator|!=
name|NG_HCI_UNIT_READY
condition|)
block|{
name|NG_HCI_WARN
argument_list|(
literal|"%s: %s - unit is not ready, state=%#x\n"
argument_list|,
name|__func__
argument_list|,
name|NG_NODE_NAME
argument_list|(
name|unit
operator|->
name|node
argument_list|)
argument_list|,
name|unit
operator|->
name|state
argument_list|)
expr_stmt|;
name|error
operator|=
name|ENXIO
expr_stmt|;
goto|goto
name|out
goto|;
block|}
if|if
condition|(
name|NGI_MSG
argument_list|(
name|item
argument_list|)
operator|->
name|header
operator|.
name|arglen
operator|!=
sizeof|sizeof
argument_list|(
operator|*
name|ep
argument_list|)
condition|)
block|{
name|NG_HCI_ALERT
argument_list|(
literal|"%s: %s - invalid LP_DisconnectReq message size=%d\n"
argument_list|,
name|__func__
argument_list|,
name|NG_NODE_NAME
argument_list|(
name|unit
operator|->
name|node
argument_list|)
argument_list|,
name|NGI_MSG
argument_list|(
name|item
argument_list|)
operator|->
name|header
operator|.
name|arglen
argument_list|)
expr_stmt|;
name|error
operator|=
name|EMSGSIZE
expr_stmt|;
goto|goto
name|out
goto|;
block|}
name|ep
operator|=
operator|(
name|ng_hci_lp_discon_req_ep
operator|*
operator|)
operator|(
name|NGI_MSG
argument_list|(
name|item
argument_list|)
operator|->
name|data
operator|)
expr_stmt|;
name|con
operator|=
name|ng_hci_con_by_handle
argument_list|(
name|unit
argument_list|,
name|ep
operator|->
name|con_handle
argument_list|)
expr_stmt|;
if|if
condition|(
name|con
operator|==
name|NULL
condition|)
block|{
name|NG_HCI_ERR
argument_list|(
literal|"%s: %s - invalid connection handle=%d\n"
argument_list|,
name|__func__
argument_list|,
name|NG_NODE_NAME
argument_list|(
name|unit
operator|->
name|node
argument_list|)
argument_list|,
name|ep
operator|->
name|con_handle
argument_list|)
expr_stmt|;
name|error
operator|=
name|ENOENT
expr_stmt|;
goto|goto
name|out
goto|;
block|}
if|if
condition|(
name|con
operator|->
name|state
operator|!=
name|NG_HCI_CON_OPEN
condition|)
block|{
name|NG_HCI_ERR
argument_list|(
literal|"%s: %s - invalid connection state=%d, handle=%d\n"
argument_list|,
name|__func__
argument_list|,
name|NG_NODE_NAME
argument_list|(
name|unit
operator|->
name|node
argument_list|)
argument_list|,
name|con
operator|->
name|state
argument_list|,
name|ep
operator|->
name|con_handle
argument_list|)
expr_stmt|;
name|error
operator|=
name|EINVAL
expr_stmt|;
goto|goto
name|out
goto|;
block|}
comment|/*  	 * Create HCI command 	 */
name|MGETHDR
argument_list|(
name|m
argument_list|,
name|M_DONTWAIT
argument_list|,
name|MT_DATA
argument_list|)
expr_stmt|;
if|if
condition|(
name|m
operator|==
name|NULL
condition|)
block|{
name|error
operator|=
name|ENOBUFS
expr_stmt|;
goto|goto
name|out
goto|;
block|}
name|m
operator|->
name|m_pkthdr
operator|.
name|len
operator|=
name|m
operator|->
name|m_len
operator|=
sizeof|sizeof
argument_list|(
operator|*
name|req
argument_list|)
expr_stmt|;
name|req
operator|=
name|mtod
argument_list|(
name|m
argument_list|,
expr|struct
name|discon_req
operator|*
argument_list|)
expr_stmt|;
name|req
operator|->
name|hdr
operator|.
name|type
operator|=
name|NG_HCI_CMD_PKT
expr_stmt|;
name|req
operator|->
name|hdr
operator|.
name|length
operator|=
sizeof|sizeof
argument_list|(
name|req
operator|->
name|cp
argument_list|)
expr_stmt|;
name|req
operator|->
name|hdr
operator|.
name|opcode
operator|=
name|htole16
argument_list|(
name|NG_HCI_OPCODE
argument_list|(
name|NG_HCI_OGF_LINK_CONTROL
argument_list|,
name|NG_HCI_OCF_DISCON
argument_list|)
argument_list|)
expr_stmt|;
name|req
operator|->
name|cp
operator|.
name|con_handle
operator|=
name|htole16
argument_list|(
name|ep
operator|->
name|con_handle
argument_list|)
expr_stmt|;
name|req
operator|->
name|cp
operator|.
name|reason
operator|=
name|ep
operator|->
name|reason
expr_stmt|;
comment|/*  	 * Queue and send HCI command  	 */
name|NG_BT_MBUFQ_ENQUEUE
argument_list|(
operator|&
name|unit
operator|->
name|cmdq
argument_list|,
name|m
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|unit
operator|->
name|state
operator|&
name|NG_HCI_UNIT_COMMAND_PENDING
operator|)
condition|)
name|error
operator|=
name|ng_hci_send_command
argument_list|(
name|unit
argument_list|)
expr_stmt|;
name|out
label|:
name|NG_FREE_ITEM
argument_list|(
name|item
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
end_function

begin_comment
comment|/* ng_hci_lp_discon_req */
end_comment

begin_comment
comment|/*  * Send LP_ConnectCfm event to the upper layer protocol  */
end_comment

begin_function
name|int
name|ng_hci_lp_con_cfm
parameter_list|(
name|ng_hci_unit_con_p
name|con
parameter_list|,
name|int
name|status
parameter_list|)
block|{
name|ng_hci_unit_p
name|unit
init|=
name|con
operator|->
name|unit
decl_stmt|;
name|struct
name|ng_mesg
modifier|*
name|msg
init|=
name|NULL
decl_stmt|;
name|ng_hci_lp_con_cfm_ep
modifier|*
name|ep
init|=
name|NULL
decl_stmt|;
name|int
name|error
decl_stmt|;
comment|/* 	 * Check who wants to be notified. For ACL links both ACL and SCO 	 * upstream hooks will be notified (if required). For SCO links 	 * only SCO upstream hook will receive notification 	 */
if|if
condition|(
name|con
operator|->
name|link_type
operator|==
name|NG_HCI_LINK_ACL
operator|&&
name|con
operator|->
name|flags
operator|&
name|NG_HCI_CON_NOTIFY_ACL
condition|)
block|{
if|if
condition|(
name|unit
operator|->
name|acl
operator|!=
name|NULL
operator|&&
name|NG_HOOK_IS_VALID
argument_list|(
name|unit
operator|->
name|acl
argument_list|)
condition|)
block|{
name|NG_MKMESSAGE
argument_list|(
name|msg
argument_list|,
name|NGM_HCI_COOKIE
argument_list|,
name|NGM_HCI_LP_CON_CFM
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|ep
argument_list|)
argument_list|,
name|M_NOWAIT
argument_list|)
expr_stmt|;
if|if
condition|(
name|msg
operator|!=
name|NULL
condition|)
block|{
name|ep
operator|=
operator|(
name|ng_hci_lp_con_cfm_ep
operator|*
operator|)
name|msg
operator|->
name|data
expr_stmt|;
name|ep
operator|->
name|status
operator|=
name|status
expr_stmt|;
name|ep
operator|->
name|link_type
operator|=
name|con
operator|->
name|link_type
expr_stmt|;
name|ep
operator|->
name|con_handle
operator|=
name|con
operator|->
name|con_handle
expr_stmt|;
name|bcopy
argument_list|(
operator|&
name|con
operator|->
name|bdaddr
argument_list|,
operator|&
name|ep
operator|->
name|bdaddr
argument_list|,
sizeof|sizeof
argument_list|(
name|ep
operator|->
name|bdaddr
argument_list|)
argument_list|)
expr_stmt|;
name|NG_SEND_MSG_HOOK
argument_list|(
name|error
argument_list|,
name|unit
operator|->
name|node
argument_list|,
name|msg
argument_list|,
name|unit
operator|->
name|acl
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
block|}
else|else
name|NG_HCI_INFO
argument_list|(
literal|"%s: %s - ACL hook not valid, hook=%p\n"
argument_list|,
name|__func__
argument_list|,
name|NG_NODE_NAME
argument_list|(
name|unit
operator|->
name|node
argument_list|)
argument_list|,
name|unit
operator|->
name|acl
argument_list|)
expr_stmt|;
name|con
operator|->
name|flags
operator|&=
operator|~
name|NG_HCI_CON_NOTIFY_ACL
expr_stmt|;
block|}
if|if
condition|(
name|con
operator|->
name|flags
operator|&
name|NG_HCI_CON_NOTIFY_SCO
condition|)
block|{
if|if
condition|(
name|unit
operator|->
name|sco
operator|!=
name|NULL
operator|&&
name|NG_HOOK_IS_VALID
argument_list|(
name|unit
operator|->
name|sco
argument_list|)
condition|)
block|{
name|NG_MKMESSAGE
argument_list|(
name|msg
argument_list|,
name|NGM_HCI_COOKIE
argument_list|,
name|NGM_HCI_LP_CON_CFM
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|ep
argument_list|)
argument_list|,
name|M_NOWAIT
argument_list|)
expr_stmt|;
if|if
condition|(
name|msg
operator|!=
name|NULL
condition|)
block|{
name|ep
operator|=
operator|(
name|ng_hci_lp_con_cfm_ep
operator|*
operator|)
name|msg
operator|->
name|data
expr_stmt|;
name|ep
operator|->
name|status
operator|=
name|status
expr_stmt|;
name|ep
operator|->
name|link_type
operator|=
name|con
operator|->
name|link_type
expr_stmt|;
name|ep
operator|->
name|con_handle
operator|=
name|con
operator|->
name|con_handle
expr_stmt|;
name|bcopy
argument_list|(
operator|&
name|con
operator|->
name|bdaddr
argument_list|,
operator|&
name|ep
operator|->
name|bdaddr
argument_list|,
sizeof|sizeof
argument_list|(
name|ep
operator|->
name|bdaddr
argument_list|)
argument_list|)
expr_stmt|;
name|NG_SEND_MSG_HOOK
argument_list|(
name|error
argument_list|,
name|unit
operator|->
name|node
argument_list|,
name|msg
argument_list|,
name|unit
operator|->
name|sco
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
block|}
else|else
name|NG_HCI_INFO
argument_list|(
literal|"%s: %s - SCO hook not valid, hook=%p\n"
argument_list|,
name|__func__
argument_list|,
name|NG_NODE_NAME
argument_list|(
name|unit
operator|->
name|node
argument_list|)
argument_list|,
name|unit
operator|->
name|acl
argument_list|)
expr_stmt|;
name|con
operator|->
name|flags
operator|&=
operator|~
name|NG_HCI_CON_NOTIFY_SCO
expr_stmt|;
block|}
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_comment
comment|/* ng_hci_lp_con_cfm */
end_comment

begin_comment
comment|/*  * Send LP_ConnectInd event to the upper layer protocol  */
end_comment

begin_function
name|int
name|ng_hci_lp_con_ind
parameter_list|(
name|ng_hci_unit_con_p
name|con
parameter_list|,
name|u_int8_t
modifier|*
name|uclass
parameter_list|)
block|{
name|ng_hci_unit_p
name|unit
init|=
name|con
operator|->
name|unit
decl_stmt|;
name|struct
name|ng_mesg
modifier|*
name|msg
init|=
name|NULL
decl_stmt|;
name|ng_hci_lp_con_ind_ep
modifier|*
name|ep
init|=
name|NULL
decl_stmt|;
name|hook_p
name|hook
init|=
name|NULL
decl_stmt|;
name|int
name|error
init|=
literal|0
decl_stmt|;
comment|/* 	 * Connection_Request event is generated for specific link type. 	 * Use link_type to select upstream hook. 	 */
if|if
condition|(
name|con
operator|->
name|link_type
operator|==
name|NG_HCI_LINK_ACL
condition|)
name|hook
operator|=
name|unit
operator|->
name|acl
expr_stmt|;
else|else
name|hook
operator|=
name|unit
operator|->
name|sco
expr_stmt|;
if|if
condition|(
name|hook
operator|!=
name|NULL
operator|&&
name|NG_HOOK_IS_VALID
argument_list|(
name|hook
argument_list|)
condition|)
block|{
name|NG_MKMESSAGE
argument_list|(
name|msg
argument_list|,
name|NGM_HCI_COOKIE
argument_list|,
name|NGM_HCI_LP_CON_IND
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|ep
argument_list|)
argument_list|,
name|M_NOWAIT
argument_list|)
expr_stmt|;
if|if
condition|(
name|msg
operator|==
name|NULL
condition|)
return|return
operator|(
name|ENOMEM
operator|)
return|;
name|ep
operator|=
operator|(
name|ng_hci_lp_con_ind_ep
operator|*
operator|)
operator|(
name|msg
operator|->
name|data
operator|)
expr_stmt|;
name|ep
operator|->
name|link_type
operator|=
name|con
operator|->
name|link_type
expr_stmt|;
name|bcopy
argument_list|(
name|uclass
argument_list|,
name|ep
operator|->
name|uclass
argument_list|,
sizeof|sizeof
argument_list|(
name|ep
operator|->
name|uclass
argument_list|)
argument_list|)
expr_stmt|;
name|bcopy
argument_list|(
operator|&
name|con
operator|->
name|bdaddr
argument_list|,
operator|&
name|ep
operator|->
name|bdaddr
argument_list|,
sizeof|sizeof
argument_list|(
name|ep
operator|->
name|bdaddr
argument_list|)
argument_list|)
expr_stmt|;
name|NG_SEND_MSG_HOOK
argument_list|(
name|error
argument_list|,
name|unit
operator|->
name|node
argument_list|,
name|msg
argument_list|,
name|hook
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|NG_HCI_WARN
argument_list|(
literal|"%s: %s - Upstream hook is not connected or not valid, hook=%p\n"
argument_list|,
name|__func__
argument_list|,
name|NG_NODE_NAME
argument_list|(
name|unit
operator|->
name|node
argument_list|)
argument_list|,
name|hook
argument_list|)
expr_stmt|;
name|error
operator|=
name|ENOTCONN
expr_stmt|;
block|}
return|return
operator|(
name|error
operator|)
return|;
block|}
end_function

begin_comment
comment|/* ng_hci_lp_con_ind */
end_comment

begin_comment
comment|/*  * Process LP_ConnectRsp event from the upper layer protocol  */
end_comment

begin_function
name|int
name|ng_hci_lp_con_rsp
parameter_list|(
name|ng_hci_unit_p
name|unit
parameter_list|,
name|item_p
name|item
parameter_list|,
name|hook_p
name|hook
parameter_list|)
block|{
struct|struct
name|con_rsp_req
block|{
name|ng_hci_cmd_pkt_t
name|hdr
decl_stmt|;
union|union
block|{
name|ng_hci_accept_con_cp
name|acc
decl_stmt|;
name|ng_hci_reject_con_cp
name|rej
decl_stmt|;
block|}
name|__attribute__
argument_list|(
operator|(
name|packed
operator|)
argument_list|)
name|cp
union|;
block|}
name|__attribute__
argument_list|(
operator|(
name|packed
operator|)
argument_list|)
modifier|*
name|req
init|=
name|NULL
struct|;
name|ng_hci_lp_con_rsp_ep
modifier|*
name|ep
init|=
name|NULL
decl_stmt|;
name|ng_hci_unit_con_p
name|con
init|=
name|NULL
decl_stmt|;
name|struct
name|mbuf
modifier|*
name|m
init|=
name|NULL
decl_stmt|;
name|int
name|error
init|=
literal|0
decl_stmt|;
comment|/* Check if unit is ready */
if|if
condition|(
operator|(
name|unit
operator|->
name|state
operator|&
name|NG_HCI_UNIT_READY
operator|)
operator|!=
name|NG_HCI_UNIT_READY
condition|)
block|{
name|NG_HCI_WARN
argument_list|(
literal|"%s: %s - unit is not ready, state=%#x\n"
argument_list|,
name|__func__
argument_list|,
name|NG_NODE_NAME
argument_list|(
name|unit
operator|->
name|node
argument_list|)
argument_list|,
name|unit
operator|->
name|state
argument_list|)
expr_stmt|;
name|error
operator|=
name|ENXIO
expr_stmt|;
goto|goto
name|out
goto|;
block|}
if|if
condition|(
name|NGI_MSG
argument_list|(
name|item
argument_list|)
operator|->
name|header
operator|.
name|arglen
operator|!=
sizeof|sizeof
argument_list|(
operator|*
name|ep
argument_list|)
condition|)
block|{
name|NG_HCI_ALERT
argument_list|(
literal|"%s: %s - invalid LP_ConnectRsp message size=%d\n"
argument_list|,
name|__func__
argument_list|,
name|NG_NODE_NAME
argument_list|(
name|unit
operator|->
name|node
argument_list|)
argument_list|,
name|NGI_MSG
argument_list|(
name|item
argument_list|)
operator|->
name|header
operator|.
name|arglen
argument_list|)
expr_stmt|;
name|error
operator|=
name|EMSGSIZE
expr_stmt|;
goto|goto
name|out
goto|;
block|}
name|ep
operator|=
operator|(
name|ng_hci_lp_con_rsp_ep
operator|*
operator|)
operator|(
name|NGI_MSG
argument_list|(
name|item
argument_list|)
operator|->
name|data
operator|)
expr_stmt|;
comment|/* 	 * Here we have to deal with race. Upper layers might send conflicting 	 * requests. One might send Accept and other Reject. We will not try 	 * to solve all the problems, so first request will always win. 	 * 	 * Try to find connection that matches the following: 	 * 	 * 1) con->link_type == ep->link_type 	 * 	 * 2) con->state == NG_HCI_CON_W4_LP_CON_RSP || 	 *    con->state == NG_HCI_CON_W4_CONN_COMPLETE 	 * 	 * 3) con->bdaddr == ep->bdaddr 	 * 	 * Two cases: 	 * 	 * 1) We do not have connection descriptor. Could be bogus request or 	 *    we have rejected connection already. 	 * 	 * 2) We do have connection descriptor. Then we need to check state: 	 * 	 * 2.1) NG_HCI_CON_W4_LP_CON_RSP means upper layer has requested  	 *      connection and it is a first response from the upper layer. 	 *      if "status == 0" (Accept) then we will send Accept_Connection 	 *      command and change connection state to W4_CONN_COMPLETE, else 	 *      send reject and delete connection. 	 * 	 * 2.2) NG_HCI_CON_W4_CONN_COMPLETE means that we already accepted  	 *      connection. If "status == 0" we just need to link request 	 *      and wait, else ignore Reject request. 	 */
name|LIST_FOREACH
argument_list|(
argument|con
argument_list|,
argument|&unit->con_list
argument_list|,
argument|next
argument_list|)
if|if
condition|(
name|con
operator|->
name|link_type
operator|==
name|ep
operator|->
name|link_type
operator|&&
operator|(
name|con
operator|->
name|state
operator|==
name|NG_HCI_CON_W4_LP_CON_RSP
operator|||
name|con
operator|->
name|state
operator|==
name|NG_HCI_CON_W4_CONN_COMPLETE
operator|)
operator|&&
name|bcmp
argument_list|(
operator|&
name|con
operator|->
name|bdaddr
argument_list|,
operator|&
name|ep
operator|->
name|bdaddr
argument_list|,
sizeof|sizeof
argument_list|(
name|bdaddr_t
argument_list|)
argument_list|)
operator|==
literal|0
condition|)
break|break;
if|if
condition|(
name|con
operator|==
name|NULL
condition|)
block|{
comment|/* Reject for non-existing connection is fine */
name|error
operator|=
operator|(
name|ep
operator|->
name|status
operator|==
literal|0
operator|)
condition|?
name|ENOENT
else|:
literal|0
expr_stmt|;
goto|goto
name|out
goto|;
block|}
comment|/*  	 * Remove connection timeout and check connection state. 	 * Note: if ng_hci_con_untimeout() fails (returns non-zero value) then 	 * timeout already happened and event went into node's queue. 	 */
if|if
condition|(
operator|(
name|error
operator|=
name|ng_hci_con_untimeout
argument_list|(
name|con
argument_list|)
operator|)
operator|!=
literal|0
condition|)
goto|goto
name|out
goto|;
switch|switch
condition|(
name|con
operator|->
name|state
condition|)
block|{
case|case
name|NG_HCI_CON_W4_LP_CON_RSP
case|:
comment|/*  		 * Create HCI command  		 */
name|MGETHDR
argument_list|(
name|m
argument_list|,
name|M_DONTWAIT
argument_list|,
name|MT_DATA
argument_list|)
expr_stmt|;
if|if
condition|(
name|m
operator|==
name|NULL
condition|)
block|{
name|error
operator|=
name|ENOBUFS
expr_stmt|;
goto|goto
name|out
goto|;
block|}
name|req
operator|=
name|mtod
argument_list|(
name|m
argument_list|,
expr|struct
name|con_rsp_req
operator|*
argument_list|)
expr_stmt|;
name|req
operator|->
name|hdr
operator|.
name|type
operator|=
name|NG_HCI_CMD_PKT
expr_stmt|;
if|if
condition|(
name|ep
operator|->
name|status
operator|==
literal|0
condition|)
block|{
name|req
operator|->
name|hdr
operator|.
name|length
operator|=
sizeof|sizeof
argument_list|(
name|req
operator|->
name|cp
operator|.
name|acc
argument_list|)
expr_stmt|;
name|req
operator|->
name|hdr
operator|.
name|opcode
operator|=
name|htole16
argument_list|(
name|NG_HCI_OPCODE
argument_list|(
name|NG_HCI_OGF_LINK_CONTROL
argument_list|,
name|NG_HCI_OCF_ACCEPT_CON
argument_list|)
argument_list|)
expr_stmt|;
name|bcopy
argument_list|(
operator|&
name|ep
operator|->
name|bdaddr
argument_list|,
operator|&
name|req
operator|->
name|cp
operator|.
name|acc
operator|.
name|bdaddr
argument_list|,
sizeof|sizeof
argument_list|(
name|req
operator|->
name|cp
operator|.
name|acc
operator|.
name|bdaddr
argument_list|)
argument_list|)
expr_stmt|;
comment|/* 			 * We are accepting connection, so if we support role  			 * switch and role switch was enabled then set role to  			 * NG_HCI_ROLE_MASTER and let LM peform role switch. 			 * Otherwise we remain slave. In this case LM WILL NOT 			 * perform role switch. 			 */
if|if
condition|(
operator|(
name|unit
operator|->
name|features
index|[
literal|0
index|]
operator|&
name|NG_HCI_LMP_SWITCH
operator|)
operator|&&
name|unit
operator|->
name|role_switch
condition|)
name|req
operator|->
name|cp
operator|.
name|acc
operator|.
name|role
operator|=
name|NG_HCI_ROLE_MASTER
expr_stmt|;
else|else
name|req
operator|->
name|cp
operator|.
name|acc
operator|.
name|role
operator|=
name|NG_HCI_ROLE_SLAVE
expr_stmt|;
comment|/*  			 * Adjust connection state  			 */
if|if
condition|(
name|hook
operator|==
name|unit
operator|->
name|acl
condition|)
name|con
operator|->
name|flags
operator||=
name|NG_HCI_CON_NOTIFY_ACL
expr_stmt|;
else|else
name|con
operator|->
name|flags
operator||=
name|NG_HCI_CON_NOTIFY_SCO
expr_stmt|;
name|con
operator|->
name|state
operator|=
name|NG_HCI_CON_W4_CONN_COMPLETE
expr_stmt|;
name|ng_hci_con_timeout
argument_list|(
name|con
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|req
operator|->
name|hdr
operator|.
name|length
operator|=
sizeof|sizeof
argument_list|(
name|req
operator|->
name|cp
operator|.
name|rej
argument_list|)
expr_stmt|;
name|req
operator|->
name|hdr
operator|.
name|opcode
operator|=
name|htole16
argument_list|(
name|NG_HCI_OPCODE
argument_list|(
name|NG_HCI_OGF_LINK_CONTROL
argument_list|,
name|NG_HCI_OCF_REJECT_CON
argument_list|)
argument_list|)
expr_stmt|;
name|bcopy
argument_list|(
operator|&
name|ep
operator|->
name|bdaddr
argument_list|,
operator|&
name|req
operator|->
name|cp
operator|.
name|rej
operator|.
name|bdaddr
argument_list|,
sizeof|sizeof
argument_list|(
name|req
operator|->
name|cp
operator|.
name|rej
operator|.
name|bdaddr
argument_list|)
argument_list|)
expr_stmt|;
name|req
operator|->
name|cp
operator|.
name|rej
operator|.
name|reason
operator|=
name|ep
operator|->
name|status
expr_stmt|;
comment|/* 			 * Free connection descritor 			 * Item will be deleted just before return. 			 */
name|ng_hci_free_con
argument_list|(
name|con
argument_list|)
expr_stmt|;
block|}
name|m
operator|->
name|m_pkthdr
operator|.
name|len
operator|=
name|m
operator|->
name|m_len
operator|=
sizeof|sizeof
argument_list|(
name|req
operator|->
name|hdr
argument_list|)
operator|+
name|req
operator|->
name|hdr
operator|.
name|length
expr_stmt|;
comment|/* Queue and send HCI command */
name|NG_BT_MBUFQ_ENQUEUE
argument_list|(
operator|&
name|unit
operator|->
name|cmdq
argument_list|,
name|m
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|unit
operator|->
name|state
operator|&
name|NG_HCI_UNIT_COMMAND_PENDING
operator|)
condition|)
name|error
operator|=
name|ng_hci_send_command
argument_list|(
name|unit
argument_list|)
expr_stmt|;
break|break;
case|case
name|NG_HCI_CON_W4_CONN_COMPLETE
case|:
if|if
condition|(
name|ep
operator|->
name|status
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|hook
operator|==
name|unit
operator|->
name|acl
condition|)
name|con
operator|->
name|flags
operator||=
name|NG_HCI_CON_NOTIFY_ACL
expr_stmt|;
else|else
name|con
operator|->
name|flags
operator||=
name|NG_HCI_CON_NOTIFY_SCO
expr_stmt|;
block|}
else|else
name|error
operator|=
name|EPERM
expr_stmt|;
break|break;
default|default:
name|panic
argument_list|(
literal|"%s: %s - Invalid connection state=%d\n"
argument_list|,
name|__func__
argument_list|,
name|NG_NODE_NAME
argument_list|(
name|unit
operator|->
name|node
argument_list|)
argument_list|,
name|con
operator|->
name|state
argument_list|)
expr_stmt|;
break|break;
block|}
name|out
label|:
name|NG_FREE_ITEM
argument_list|(
name|item
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
end_function

begin_comment
comment|/* ng_hci_lp_con_rsp */
end_comment

begin_comment
comment|/*  * Send LP_DisconnectInd to the upper layer protocol  */
end_comment

begin_function
name|int
name|ng_hci_lp_discon_ind
parameter_list|(
name|ng_hci_unit_con_p
name|con
parameter_list|,
name|int
name|reason
parameter_list|)
block|{
name|ng_hci_unit_p
name|unit
init|=
name|con
operator|->
name|unit
decl_stmt|;
name|struct
name|ng_mesg
modifier|*
name|msg
init|=
name|NULL
decl_stmt|;
name|ng_hci_lp_discon_ind_ep
modifier|*
name|ep
init|=
name|NULL
decl_stmt|;
name|int
name|error
init|=
literal|0
decl_stmt|;
comment|/* 	 * Disconnect_Complete event is generated for specific connection 	 * handle. For ACL connection handles both ACL and SCO upstream 	 * hooks will receive notification. For SCO connection handles 	 * only SCO upstream hook will receive notification. 	 */
if|if
condition|(
name|con
operator|->
name|link_type
operator|==
name|NG_HCI_LINK_ACL
condition|)
block|{
if|if
condition|(
name|unit
operator|->
name|acl
operator|!=
name|NULL
operator|&&
name|NG_HOOK_IS_VALID
argument_list|(
name|unit
operator|->
name|acl
argument_list|)
condition|)
block|{
name|NG_MKMESSAGE
argument_list|(
name|msg
argument_list|,
name|NGM_HCI_COOKIE
argument_list|,
name|NGM_HCI_LP_DISCON_IND
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|ep
argument_list|)
argument_list|,
name|M_NOWAIT
argument_list|)
expr_stmt|;
if|if
condition|(
name|msg
operator|==
name|NULL
condition|)
return|return
operator|(
name|ENOMEM
operator|)
return|;
name|ep
operator|=
operator|(
name|ng_hci_lp_discon_ind_ep
operator|*
operator|)
name|msg
operator|->
name|data
expr_stmt|;
name|ep
operator|->
name|reason
operator|=
name|reason
expr_stmt|;
name|ep
operator|->
name|link_type
operator|=
name|con
operator|->
name|link_type
expr_stmt|;
name|ep
operator|->
name|con_handle
operator|=
name|con
operator|->
name|con_handle
expr_stmt|;
name|NG_SEND_MSG_HOOK
argument_list|(
name|error
argument_list|,
name|unit
operator|->
name|node
argument_list|,
name|msg
argument_list|,
name|unit
operator|->
name|acl
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
else|else
name|NG_HCI_INFO
argument_list|(
literal|"%s: %s - ACL hook is not connected or not valid, hook=%p\n"
argument_list|,
name|__func__
argument_list|,
name|NG_NODE_NAME
argument_list|(
name|unit
operator|->
name|node
argument_list|)
argument_list|,
name|unit
operator|->
name|acl
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|unit
operator|->
name|sco
operator|!=
name|NULL
operator|&&
name|NG_HOOK_IS_VALID
argument_list|(
name|unit
operator|->
name|sco
argument_list|)
condition|)
block|{
name|NG_MKMESSAGE
argument_list|(
name|msg
argument_list|,
name|NGM_HCI_COOKIE
argument_list|,
name|NGM_HCI_LP_DISCON_IND
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|ep
argument_list|)
argument_list|,
name|M_NOWAIT
argument_list|)
expr_stmt|;
if|if
condition|(
name|msg
operator|==
name|NULL
condition|)
return|return
operator|(
name|ENOMEM
operator|)
return|;
name|ep
operator|=
operator|(
name|ng_hci_lp_discon_ind_ep
operator|*
operator|)
name|msg
operator|->
name|data
expr_stmt|;
name|ep
operator|->
name|reason
operator|=
name|reason
expr_stmt|;
name|ep
operator|->
name|link_type
operator|=
name|con
operator|->
name|link_type
expr_stmt|;
name|ep
operator|->
name|con_handle
operator|=
name|con
operator|->
name|con_handle
expr_stmt|;
name|NG_SEND_MSG_HOOK
argument_list|(
name|error
argument_list|,
name|unit
operator|->
name|node
argument_list|,
name|msg
argument_list|,
name|unit
operator|->
name|sco
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
else|else
name|NG_HCI_INFO
argument_list|(
literal|"%s: %s - SCO hook is not connected or not valid, hook=%p\n"
argument_list|,
name|__func__
argument_list|,
name|NG_NODE_NAME
argument_list|(
name|unit
operator|->
name|node
argument_list|)
argument_list|,
name|unit
operator|->
name|sco
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_comment
comment|/* ng_hci_lp_discon_ind */
end_comment

begin_comment
comment|/*  * Process LP_QoSReq action from the upper layer protocol  */
end_comment

begin_function
name|int
name|ng_hci_lp_qos_req
parameter_list|(
name|ng_hci_unit_p
name|unit
parameter_list|,
name|item_p
name|item
parameter_list|,
name|hook_p
name|hook
parameter_list|)
block|{
struct|struct
name|qos_setup_req
block|{
name|ng_hci_cmd_pkt_t
name|hdr
decl_stmt|;
name|ng_hci_qos_setup_cp
name|cp
decl_stmt|;
block|}
name|__attribute__
argument_list|(
operator|(
name|packed
operator|)
argument_list|)
modifier|*
name|req
init|=
name|NULL
struct|;
name|ng_hci_lp_qos_req_ep
modifier|*
name|ep
init|=
name|NULL
decl_stmt|;
name|ng_hci_unit_con_p
name|con
init|=
name|NULL
decl_stmt|;
name|struct
name|mbuf
modifier|*
name|m
init|=
name|NULL
decl_stmt|;
name|int
name|error
init|=
literal|0
decl_stmt|;
comment|/* Check if unit is ready */
if|if
condition|(
operator|(
name|unit
operator|->
name|state
operator|&
name|NG_HCI_UNIT_READY
operator|)
operator|!=
name|NG_HCI_UNIT_READY
condition|)
block|{
name|NG_HCI_WARN
argument_list|(
literal|"%s: %s - unit is not ready, state=%#x\n"
argument_list|,
name|__func__
argument_list|,
name|NG_NODE_NAME
argument_list|(
name|unit
operator|->
name|node
argument_list|)
argument_list|,
name|unit
operator|->
name|state
argument_list|)
expr_stmt|;
name|error
operator|=
name|ENXIO
expr_stmt|;
goto|goto
name|out
goto|;
block|}
if|if
condition|(
name|NGI_MSG
argument_list|(
name|item
argument_list|)
operator|->
name|header
operator|.
name|arglen
operator|!=
sizeof|sizeof
argument_list|(
operator|*
name|ep
argument_list|)
condition|)
block|{
name|NG_HCI_ALERT
argument_list|(
literal|"%s: %s - invalid LP_QoSSetupReq message size=%d\n"
argument_list|,
name|__func__
argument_list|,
name|NG_NODE_NAME
argument_list|(
name|unit
operator|->
name|node
argument_list|)
argument_list|,
name|NGI_MSG
argument_list|(
name|item
argument_list|)
operator|->
name|header
operator|.
name|arglen
argument_list|)
expr_stmt|;
name|error
operator|=
name|EMSGSIZE
expr_stmt|;
goto|goto
name|out
goto|;
block|}
name|ep
operator|=
operator|(
name|ng_hci_lp_qos_req_ep
operator|*
operator|)
operator|(
name|NGI_MSG
argument_list|(
name|item
argument_list|)
operator|->
name|data
operator|)
expr_stmt|;
name|con
operator|=
name|ng_hci_con_by_handle
argument_list|(
name|unit
argument_list|,
name|ep
operator|->
name|con_handle
argument_list|)
expr_stmt|;
if|if
condition|(
name|con
operator|==
name|NULL
condition|)
block|{
name|NG_HCI_ERR
argument_list|(
literal|"%s: %s - invalid connection handle=%d\n"
argument_list|,
name|__func__
argument_list|,
name|NG_NODE_NAME
argument_list|(
name|unit
operator|->
name|node
argument_list|)
argument_list|,
name|ep
operator|->
name|con_handle
argument_list|)
expr_stmt|;
name|error
operator|=
name|EINVAL
expr_stmt|;
goto|goto
name|out
goto|;
block|}
if|if
condition|(
name|con
operator|->
name|link_type
operator|!=
name|NG_HCI_LINK_ACL
condition|)
block|{
name|NG_HCI_ERR
argument_list|(
literal|"%s: %s - invalid link type=%d\n"
argument_list|,
name|__func__
argument_list|,
name|NG_NODE_NAME
argument_list|(
name|unit
operator|->
name|node
argument_list|)
argument_list|,
name|con
operator|->
name|link_type
argument_list|)
expr_stmt|;
name|error
operator|=
name|EINVAL
expr_stmt|;
goto|goto
name|out
goto|;
block|}
if|if
condition|(
name|con
operator|->
name|state
operator|!=
name|NG_HCI_CON_OPEN
condition|)
block|{
name|NG_HCI_ERR
argument_list|(
literal|"%s: %s - invalid connection state=%d, handle=%d\n"
argument_list|,
name|__func__
argument_list|,
name|NG_NODE_NAME
argument_list|(
name|unit
operator|->
name|node
argument_list|)
argument_list|,
name|con
operator|->
name|state
argument_list|,
name|con
operator|->
name|con_handle
argument_list|)
expr_stmt|;
name|error
operator|=
name|EINVAL
expr_stmt|;
goto|goto
name|out
goto|;
block|}
comment|/*  	 * Create HCI command  	 */
name|MGETHDR
argument_list|(
name|m
argument_list|,
name|M_DONTWAIT
argument_list|,
name|MT_DATA
argument_list|)
expr_stmt|;
if|if
condition|(
name|m
operator|==
name|NULL
condition|)
block|{
name|error
operator|=
name|ENOBUFS
expr_stmt|;
goto|goto
name|out
goto|;
block|}
name|m
operator|->
name|m_pkthdr
operator|.
name|len
operator|=
name|m
operator|->
name|m_len
operator|=
sizeof|sizeof
argument_list|(
operator|*
name|req
argument_list|)
expr_stmt|;
name|req
operator|=
name|mtod
argument_list|(
name|m
argument_list|,
expr|struct
name|qos_setup_req
operator|*
argument_list|)
expr_stmt|;
name|req
operator|->
name|hdr
operator|.
name|type
operator|=
name|NG_HCI_CMD_PKT
expr_stmt|;
name|req
operator|->
name|hdr
operator|.
name|length
operator|=
sizeof|sizeof
argument_list|(
name|req
operator|->
name|cp
argument_list|)
expr_stmt|;
name|req
operator|->
name|hdr
operator|.
name|opcode
operator|=
name|htole16
argument_list|(
name|NG_HCI_OPCODE
argument_list|(
name|NG_HCI_OGF_LINK_POLICY
argument_list|,
name|NG_HCI_OCF_QOS_SETUP
argument_list|)
argument_list|)
expr_stmt|;
name|req
operator|->
name|cp
operator|.
name|con_handle
operator|=
name|htole16
argument_list|(
name|ep
operator|->
name|con_handle
argument_list|)
expr_stmt|;
name|req
operator|->
name|cp
operator|.
name|flags
operator|=
name|ep
operator|->
name|flags
expr_stmt|;
name|req
operator|->
name|cp
operator|.
name|service_type
operator|=
name|ep
operator|->
name|service_type
expr_stmt|;
name|req
operator|->
name|cp
operator|.
name|token_rate
operator|=
name|htole32
argument_list|(
name|ep
operator|->
name|token_rate
argument_list|)
expr_stmt|;
name|req
operator|->
name|cp
operator|.
name|peak_bandwidth
operator|=
name|htole32
argument_list|(
name|ep
operator|->
name|peak_bandwidth
argument_list|)
expr_stmt|;
name|req
operator|->
name|cp
operator|.
name|latency
operator|=
name|htole32
argument_list|(
name|ep
operator|->
name|latency
argument_list|)
expr_stmt|;
name|req
operator|->
name|cp
operator|.
name|delay_variation
operator|=
name|htole32
argument_list|(
name|ep
operator|->
name|delay_variation
argument_list|)
expr_stmt|;
comment|/*  	 * Adjust connection state   	 */
if|if
condition|(
name|hook
operator|==
name|unit
operator|->
name|acl
condition|)
name|con
operator|->
name|flags
operator||=
name|NG_HCI_CON_NOTIFY_ACL
expr_stmt|;
else|else
name|con
operator|->
name|flags
operator||=
name|NG_HCI_CON_NOTIFY_SCO
expr_stmt|;
comment|/*  	 * Queue and send HCI command  	 */
name|NG_BT_MBUFQ_ENQUEUE
argument_list|(
operator|&
name|unit
operator|->
name|cmdq
argument_list|,
name|m
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|unit
operator|->
name|state
operator|&
name|NG_HCI_UNIT_COMMAND_PENDING
operator|)
condition|)
name|error
operator|=
name|ng_hci_send_command
argument_list|(
name|unit
argument_list|)
expr_stmt|;
name|out
label|:
name|NG_FREE_ITEM
argument_list|(
name|item
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
end_function

begin_comment
comment|/* ng_hci_lp_qos_req */
end_comment

begin_comment
comment|/*  * Send LP_QoSCfm event to the upper layer protocol  */
end_comment

begin_function
name|int
name|ng_hci_lp_qos_cfm
parameter_list|(
name|ng_hci_unit_con_p
name|con
parameter_list|,
name|int
name|status
parameter_list|)
block|{
name|ng_hci_unit_p
name|unit
init|=
name|con
operator|->
name|unit
decl_stmt|;
name|struct
name|ng_mesg
modifier|*
name|msg
init|=
name|NULL
decl_stmt|;
name|ng_hci_lp_qos_cfm_ep
modifier|*
name|ep
init|=
name|NULL
decl_stmt|;
name|int
name|error
decl_stmt|;
if|if
condition|(
name|con
operator|->
name|flags
operator|&
name|NG_HCI_CON_NOTIFY_ACL
condition|)
block|{
if|if
condition|(
name|unit
operator|->
name|acl
operator|!=
name|NULL
operator|&&
name|NG_HOOK_IS_VALID
argument_list|(
name|unit
operator|->
name|acl
argument_list|)
condition|)
block|{
name|NG_MKMESSAGE
argument_list|(
name|msg
argument_list|,
name|NGM_HCI_COOKIE
argument_list|,
name|NGM_HCI_LP_QOS_CFM
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|ep
argument_list|)
argument_list|,
name|M_NOWAIT
argument_list|)
expr_stmt|;
if|if
condition|(
name|msg
operator|!=
name|NULL
condition|)
block|{
name|ep
operator|=
operator|(
name|ng_hci_lp_qos_cfm_ep
operator|*
operator|)
name|msg
operator|->
name|data
expr_stmt|;
name|ep
operator|->
name|status
operator|=
name|status
expr_stmt|;
name|ep
operator|->
name|con_handle
operator|=
name|con
operator|->
name|con_handle
expr_stmt|;
name|NG_SEND_MSG_HOOK
argument_list|(
name|error
argument_list|,
name|unit
operator|->
name|node
argument_list|,
name|msg
argument_list|,
name|unit
operator|->
name|acl
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
block|}
else|else
name|NG_HCI_INFO
argument_list|(
literal|"%s: %s - ACL hook not valid, hook=%p\n"
argument_list|,
name|__func__
argument_list|,
name|NG_NODE_NAME
argument_list|(
name|unit
operator|->
name|node
argument_list|)
argument_list|,
name|unit
operator|->
name|acl
argument_list|)
expr_stmt|;
name|con
operator|->
name|flags
operator|&=
operator|~
name|NG_HCI_CON_NOTIFY_ACL
expr_stmt|;
block|}
if|if
condition|(
name|con
operator|->
name|flags
operator|&
name|NG_HCI_CON_NOTIFY_SCO
condition|)
block|{
if|if
condition|(
name|unit
operator|->
name|sco
operator|!=
name|NULL
operator|&&
name|NG_HOOK_IS_VALID
argument_list|(
name|unit
operator|->
name|sco
argument_list|)
condition|)
block|{
name|NG_MKMESSAGE
argument_list|(
name|msg
argument_list|,
name|NGM_HCI_COOKIE
argument_list|,
name|NGM_HCI_LP_QOS_CFM
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|ep
argument_list|)
argument_list|,
name|M_NOWAIT
argument_list|)
expr_stmt|;
if|if
condition|(
name|msg
operator|!=
name|NULL
condition|)
block|{
name|ep
operator|=
operator|(
name|ng_hci_lp_qos_cfm_ep
operator|*
operator|)
name|msg
operator|->
name|data
expr_stmt|;
name|ep
operator|->
name|status
operator|=
name|status
expr_stmt|;
name|ep
operator|->
name|con_handle
operator|=
name|con
operator|->
name|con_handle
expr_stmt|;
name|NG_SEND_MSG_HOOK
argument_list|(
name|error
argument_list|,
name|unit
operator|->
name|node
argument_list|,
name|msg
argument_list|,
name|unit
operator|->
name|sco
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
block|}
else|else
name|NG_HCI_INFO
argument_list|(
literal|"%s: %s - SCO hook not valid, hook=%p\n"
argument_list|,
name|__func__
argument_list|,
name|NG_NODE_NAME
argument_list|(
name|unit
operator|->
name|node
argument_list|)
argument_list|,
name|unit
operator|->
name|sco
argument_list|)
expr_stmt|;
name|con
operator|->
name|flags
operator|&=
operator|~
name|NG_HCI_CON_NOTIFY_SCO
expr_stmt|;
block|}
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_comment
comment|/* ng_hci_lp_qos_cfm */
end_comment

begin_comment
comment|/*  * Send LP_QoSViolationInd event to the upper layer protocol  */
end_comment

begin_function
name|int
name|ng_hci_lp_qos_ind
parameter_list|(
name|ng_hci_unit_con_p
name|con
parameter_list|)
block|{
name|ng_hci_unit_p
name|unit
init|=
name|con
operator|->
name|unit
decl_stmt|;
name|struct
name|ng_mesg
modifier|*
name|msg
init|=
name|NULL
decl_stmt|;
name|ng_hci_lp_qos_ind_ep
modifier|*
name|ep
init|=
name|NULL
decl_stmt|;
name|int
name|error
decl_stmt|;
comment|/*  	 * QoS Violation can only be generated for ACL connection handles. 	 * Both ACL and SCO upstream hooks will receive notification. 	 */
if|if
condition|(
name|unit
operator|->
name|acl
operator|!=
name|NULL
operator|&&
name|NG_HOOK_IS_VALID
argument_list|(
name|unit
operator|->
name|acl
argument_list|)
condition|)
block|{
name|NG_MKMESSAGE
argument_list|(
name|msg
argument_list|,
name|NGM_HCI_COOKIE
argument_list|,
name|NGM_HCI_LP_QOS_IND
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|ep
argument_list|)
argument_list|,
name|M_NOWAIT
argument_list|)
expr_stmt|;
if|if
condition|(
name|msg
operator|==
name|NULL
condition|)
return|return
operator|(
name|ENOMEM
operator|)
return|;
name|ep
operator|=
operator|(
name|ng_hci_lp_qos_ind_ep
operator|*
operator|)
name|msg
operator|->
name|data
expr_stmt|;
name|ep
operator|->
name|con_handle
operator|=
name|con
operator|->
name|con_handle
expr_stmt|;
name|NG_SEND_MSG_HOOK
argument_list|(
name|error
argument_list|,
name|unit
operator|->
name|node
argument_list|,
name|msg
argument_list|,
name|unit
operator|->
name|acl
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
else|else
name|NG_HCI_INFO
argument_list|(
literal|"%s: %s - ACL hook is not connected or not valid, hook=%p\n"
argument_list|,
name|__func__
argument_list|,
name|NG_NODE_NAME
argument_list|(
name|unit
operator|->
name|node
argument_list|)
argument_list|,
name|unit
operator|->
name|acl
argument_list|)
expr_stmt|;
if|if
condition|(
name|unit
operator|->
name|sco
operator|!=
name|NULL
operator|&&
name|NG_HOOK_IS_VALID
argument_list|(
name|unit
operator|->
name|sco
argument_list|)
condition|)
block|{
name|NG_MKMESSAGE
argument_list|(
name|msg
argument_list|,
name|NGM_HCI_COOKIE
argument_list|,
name|NGM_HCI_LP_QOS_IND
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|ep
argument_list|)
argument_list|,
name|M_NOWAIT
argument_list|)
expr_stmt|;
if|if
condition|(
name|msg
operator|==
name|NULL
condition|)
return|return
operator|(
name|ENOMEM
operator|)
return|;
name|ep
operator|=
operator|(
name|ng_hci_lp_qos_ind_ep
operator|*
operator|)
name|msg
operator|->
name|data
expr_stmt|;
name|ep
operator|->
name|con_handle
operator|=
name|con
operator|->
name|con_handle
expr_stmt|;
name|NG_SEND_MSG_HOOK
argument_list|(
name|error
argument_list|,
name|unit
operator|->
name|node
argument_list|,
name|msg
argument_list|,
name|unit
operator|->
name|sco
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
else|else
name|NG_HCI_INFO
argument_list|(
literal|"%s: %s - SCO hook is not connected or not valid, hook=%p\n"
argument_list|,
name|__func__
argument_list|,
name|NG_NODE_NAME
argument_list|(
name|unit
operator|->
name|node
argument_list|)
argument_list|,
name|unit
operator|->
name|sco
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_comment
comment|/* ng_hci_lp_qos_ind */
end_comment

begin_comment
comment|/*  * Process connection timeout  */
end_comment

begin_function
name|void
name|ng_hci_process_con_timeout
parameter_list|(
name|node_p
name|node
parameter_list|,
name|hook_p
name|hook
parameter_list|,
name|void
modifier|*
name|arg1
parameter_list|,
name|int
name|con_handle
parameter_list|)
block|{
name|ng_hci_unit_p
name|unit
init|=
name|NULL
decl_stmt|;
name|ng_hci_unit_con_p
name|con
init|=
name|NULL
decl_stmt|;
if|if
condition|(
name|NG_NODE_NOT_VALID
argument_list|(
name|node
argument_list|)
condition|)
block|{
name|printf
argument_list|(
literal|"%s: Netgraph node is not valid\n"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
return|return;
block|}
name|unit
operator|=
operator|(
name|ng_hci_unit_p
operator|)
name|NG_NODE_PRIVATE
argument_list|(
name|node
argument_list|)
expr_stmt|;
name|con
operator|=
name|ng_hci_con_by_handle
argument_list|(
name|unit
argument_list|,
name|con_handle
argument_list|)
expr_stmt|;
if|if
condition|(
name|con
operator|==
name|NULL
condition|)
block|{
name|NG_HCI_ALERT
argument_list|(
literal|"%s: %s - could not find connection, handle=%d\n"
argument_list|,
name|__func__
argument_list|,
name|NG_NODE_NAME
argument_list|(
name|node
argument_list|)
argument_list|,
name|con_handle
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
operator|!
operator|(
name|con
operator|->
name|flags
operator|&
name|NG_HCI_CON_TIMEOUT_PENDING
operator|)
condition|)
block|{
name|NG_HCI_ALERT
argument_list|(
literal|"%s: %s - no pending connection timeout, handle=%d, state=%d, flags=%#x\n"
argument_list|,
name|__func__
argument_list|,
name|NG_NODE_NAME
argument_list|(
name|node
argument_list|)
argument_list|,
name|con_handle
argument_list|,
name|con
operator|->
name|state
argument_list|,
name|con
operator|->
name|flags
argument_list|)
expr_stmt|;
return|return;
block|}
name|con
operator|->
name|flags
operator|&=
operator|~
name|NG_HCI_CON_TIMEOUT_PENDING
expr_stmt|;
comment|/* 	 * We expect to receive connection timeout in one of the following 	 * states: 	 * 	 * 1) NG_HCI_CON_W4_LP_CON_RSP means that upper layer has not responded 	 *    to our LP_CON_IND. Do nothing and destroy connection. Remote peer 	 *    most likely already gave up on us. 	 *  	 * 2) NG_HCI_CON_W4_CONN_COMPLETE means upper layer requested connection 	 *    (or we in the process of accepting it) and baseband has timedout 	 *    on us. Inform upper layers and send LP_CON_CFM. 	 */
switch|switch
condition|(
name|con
operator|->
name|state
condition|)
block|{
case|case
name|NG_HCI_CON_W4_LP_CON_RSP
case|:
break|break;
case|case
name|NG_HCI_CON_W4_CONN_COMPLETE
case|:
name|ng_hci_lp_con_cfm
argument_list|(
name|con
argument_list|,
literal|0xee
argument_list|)
expr_stmt|;
break|break;
default|default:
name|panic
argument_list|(
literal|"%s: %s - Invalid connection state=%d\n"
argument_list|,
name|__func__
argument_list|,
name|NG_NODE_NAME
argument_list|(
name|node
argument_list|)
argument_list|,
name|con
operator|->
name|state
argument_list|)
expr_stmt|;
break|break;
block|}
name|ng_hci_free_con
argument_list|(
name|con
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* ng_hci_process_con_timeout */
end_comment

end_unit


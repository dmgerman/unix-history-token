begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * ng_hci_evnt.c  *  * Copyright (c) Maksim Yevmenkin<m_evmenkin@yahoo.com>  * All rights reserved.  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions  * are met:  * 1. Redistributions of source code must retain the above copyright  *    notice, this list of conditions and the following disclaimer.  * 2. Redistributions in binary form must reproduce the above copyright  *    notice, this list of conditions and the following disclaimer in the  *    documentation and/or other materials provided with the distribution.  *  * THIS SOFTWARE IS PROVIDED BY THE AUTHOR AND CONTRIBUTORS ``AS IS'' AND  * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE  * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE  * ARE DISCLAIMED. IN NO EVENT SHALL THE AUTHOR OR CONTRIBUTORS BE LIABLE  * FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL  * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS  * OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)  * HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT  * LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY  * OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF  * SUCH DAMAGE.  *  * $Id: ng_hci_evnt.c,v 1.18 2002/11/12 22:35:39 max Exp $  * $FreeBSD$  */
end_comment

begin_include
include|#
directive|include
file|<sys/param.h>
end_include

begin_include
include|#
directive|include
file|<sys/systm.h>
end_include

begin_include
include|#
directive|include
file|<sys/kernel.h>
end_include

begin_include
include|#
directive|include
file|<sys/endian.h>
end_include

begin_include
include|#
directive|include
file|<sys/malloc.h>
end_include

begin_include
include|#
directive|include
file|<sys/mbuf.h>
end_include

begin_include
include|#
directive|include
file|<sys/queue.h>
end_include

begin_include
include|#
directive|include
file|<netgraph/ng_message.h>
end_include

begin_include
include|#
directive|include
file|<netgraph/netgraph.h>
end_include

begin_include
include|#
directive|include
file|"ng_bluetooth.h"
end_include

begin_include
include|#
directive|include
file|"ng_hci.h"
end_include

begin_include
include|#
directive|include
file|"ng_hci_var.h"
end_include

begin_include
include|#
directive|include
file|"ng_hci_cmds.h"
end_include

begin_include
include|#
directive|include
file|"ng_hci_evnt.h"
end_include

begin_include
include|#
directive|include
file|"ng_hci_ulpi.h"
end_include

begin_include
include|#
directive|include
file|"ng_hci_misc.h"
end_include

begin_comment
comment|/******************************************************************************  ******************************************************************************  **                     HCI event processing module  ******************************************************************************  ******************************************************************************/
end_comment

begin_comment
comment|/*   * Event processing routines   */
end_comment

begin_function_decl
specifier|static
name|int
name|inquiry_result
parameter_list|(
name|ng_hci_unit_p
parameter_list|,
name|struct
name|mbuf
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|con_compl
parameter_list|(
name|ng_hci_unit_p
parameter_list|,
name|struct
name|mbuf
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|con_req
parameter_list|(
name|ng_hci_unit_p
parameter_list|,
name|struct
name|mbuf
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|discon_compl
parameter_list|(
name|ng_hci_unit_p
parameter_list|,
name|struct
name|mbuf
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|read_remote_features_compl
parameter_list|(
name|ng_hci_unit_p
parameter_list|,
name|struct
name|mbuf
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|qos_setup_compl
parameter_list|(
name|ng_hci_unit_p
parameter_list|,
name|struct
name|mbuf
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|hardware_error
parameter_list|(
name|ng_hci_unit_p
parameter_list|,
name|struct
name|mbuf
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|role_change
parameter_list|(
name|ng_hci_unit_p
parameter_list|,
name|struct
name|mbuf
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|num_compl_pkts
parameter_list|(
name|ng_hci_unit_p
parameter_list|,
name|struct
name|mbuf
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|mode_change
parameter_list|(
name|ng_hci_unit_p
parameter_list|,
name|struct
name|mbuf
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|data_buffer_overflow
parameter_list|(
name|ng_hci_unit_p
parameter_list|,
name|struct
name|mbuf
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|read_clock_offset_compl
parameter_list|(
name|ng_hci_unit_p
parameter_list|,
name|struct
name|mbuf
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|qos_violation
parameter_list|(
name|ng_hci_unit_p
parameter_list|,
name|struct
name|mbuf
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|page_scan_mode_change
parameter_list|(
name|ng_hci_unit_p
parameter_list|,
name|struct
name|mbuf
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|page_scan_rep_mode_change
parameter_list|(
name|ng_hci_unit_p
parameter_list|,
name|struct
name|mbuf
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|sync_con_queue
parameter_list|(
name|ng_hci_unit_p
parameter_list|,
name|ng_hci_unit_con_p
parameter_list|,
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|send_data_packets
parameter_list|(
name|ng_hci_unit_p
parameter_list|,
name|int
parameter_list|,
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_comment
comment|/*  * Process HCI event packet  */
end_comment

begin_function
name|int
name|ng_hci_process_event
parameter_list|(
name|ng_hci_unit_p
name|unit
parameter_list|,
name|struct
name|mbuf
modifier|*
name|event
parameter_list|)
block|{
name|ng_hci_event_pkt_t
modifier|*
name|hdr
init|=
name|NULL
decl_stmt|;
name|int
name|error
init|=
literal|0
decl_stmt|;
comment|/* Get event packet header */
name|NG_HCI_M_PULLUP
argument_list|(
name|event
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|hdr
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|event
operator|==
name|NULL
condition|)
return|return
operator|(
name|ENOBUFS
operator|)
return|;
name|hdr
operator|=
name|mtod
argument_list|(
name|event
argument_list|,
name|ng_hci_event_pkt_t
operator|*
argument_list|)
expr_stmt|;
name|NG_HCI_INFO
argument_list|(
literal|"%s: %s - got HCI event=%#x, length=%d\n"
argument_list|,
name|__func__
argument_list|,
name|NG_NODE_NAME
argument_list|(
name|unit
operator|->
name|node
argument_list|)
argument_list|,
name|hdr
operator|->
name|event
argument_list|,
name|hdr
operator|->
name|length
argument_list|)
expr_stmt|;
comment|/* Get rid of event header and process event */
name|m_adj
argument_list|(
name|event
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|hdr
argument_list|)
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|hdr
operator|->
name|event
condition|)
block|{
case|case
name|NG_HCI_EVENT_INQUIRY_COMPL
case|:
comment|/*	case NG_HCI_EVENT_MODE_CHANGE: */
case|case
name|NG_HCI_EVENT_RETURN_LINK_KEYS
case|:
case|case
name|NG_HCI_EVENT_PIN_CODE_REQ
case|:
case|case
name|NG_HCI_EVENT_LINK_KEY_REQ
case|:
case|case
name|NG_HCI_EVENT_LINK_KEY_NOTIFICATION
case|:
case|case
name|NG_HCI_EVENT_LOOPBACK_COMMAND
case|:
case|case
name|NG_HCI_EVENT_AUTH_COMPL
case|:
case|case
name|NG_HCI_EVENT_ENCRYPTION_CHANGE
case|:
case|case
name|NG_HCI_EVENT_CHANGE_CON_LINK_KEY_COMPL
case|:
case|case
name|NG_HCI_EVENT_MASTER_LINK_KEY_COMPL
case|:
case|case
name|NG_HCI_EVENT_FLUSH_OCCUR
case|:
comment|/* XXX Do we have to handle it? */
comment|/*	case NG_HCI_EVENT_ROLE_CHANGE: */
case|case
name|NG_HCI_EVENT_MAX_SLOT_CHANGE
case|:
case|case
name|NG_HCI_EVENT_CON_PKT_TYPE_CHANGED
case|:
case|case
name|NG_HCI_EVENT_BT_LOGO
case|:
case|case
name|NG_HCI_EVENT_VENDOR
case|:
case|case
name|NG_HCI_EVENT_REMOTE_NAME_REQ_COMPL
case|:
case|case
name|NG_HCI_EVENT_READ_REMOTE_VER_INFO_COMPL
case|:
comment|/* These do not need post processing */
name|NG_FREE_M
argument_list|(
name|event
argument_list|)
expr_stmt|;
break|break;
case|case
name|NG_HCI_EVENT_INQUIRY_RESULT
case|:
name|error
operator|=
name|inquiry_result
argument_list|(
name|unit
argument_list|,
name|event
argument_list|)
expr_stmt|;
break|break;
case|case
name|NG_HCI_EVENT_CON_COMPL
case|:
name|error
operator|=
name|con_compl
argument_list|(
name|unit
argument_list|,
name|event
argument_list|)
expr_stmt|;
break|break;
case|case
name|NG_HCI_EVENT_CON_REQ
case|:
name|error
operator|=
name|con_req
argument_list|(
name|unit
argument_list|,
name|event
argument_list|)
expr_stmt|;
break|break;
case|case
name|NG_HCI_EVENT_DISCON_COMPL
case|:
name|error
operator|=
name|discon_compl
argument_list|(
name|unit
argument_list|,
name|event
argument_list|)
expr_stmt|;
break|break;
case|case
name|NG_HCI_EVENT_READ_REMOTE_FEATURES_COMPL
case|:
name|error
operator|=
name|read_remote_features_compl
argument_list|(
name|unit
argument_list|,
name|event
argument_list|)
expr_stmt|;
break|break;
case|case
name|NG_HCI_EVENT_QOS_SETUP_COMPL
case|:
name|error
operator|=
name|qos_setup_compl
argument_list|(
name|unit
argument_list|,
name|event
argument_list|)
expr_stmt|;
break|break;
case|case
name|NG_HCI_EVENT_COMMAND_COMPL
case|:
name|error
operator|=
name|ng_hci_process_command_complete
argument_list|(
name|unit
argument_list|,
name|event
argument_list|)
expr_stmt|;
break|break;
case|case
name|NG_HCI_EVENT_COMMAND_STATUS
case|:
name|error
operator|=
name|ng_hci_process_command_status
argument_list|(
name|unit
argument_list|,
name|event
argument_list|)
expr_stmt|;
break|break;
case|case
name|NG_HCI_EVENT_HARDWARE_ERROR
case|:
name|error
operator|=
name|hardware_error
argument_list|(
name|unit
argument_list|,
name|event
argument_list|)
expr_stmt|;
break|break;
case|case
name|NG_HCI_EVENT_ROLE_CHANGE
case|:
name|error
operator|=
name|role_change
argument_list|(
name|unit
argument_list|,
name|event
argument_list|)
expr_stmt|;
break|break;
case|case
name|NG_HCI_EVENT_NUM_COMPL_PKTS
case|:
name|error
operator|=
name|num_compl_pkts
argument_list|(
name|unit
argument_list|,
name|event
argument_list|)
expr_stmt|;
break|break;
case|case
name|NG_HCI_EVENT_MODE_CHANGE
case|:
name|error
operator|=
name|mode_change
argument_list|(
name|unit
argument_list|,
name|event
argument_list|)
expr_stmt|;
break|break;
case|case
name|NG_HCI_EVENT_DATA_BUFFER_OVERFLOW
case|:
name|error
operator|=
name|data_buffer_overflow
argument_list|(
name|unit
argument_list|,
name|event
argument_list|)
expr_stmt|;
break|break;
case|case
name|NG_HCI_EVENT_READ_CLOCK_OFFSET_COMPL
case|:
name|error
operator|=
name|read_clock_offset_compl
argument_list|(
name|unit
argument_list|,
name|event
argument_list|)
expr_stmt|;
break|break;
case|case
name|NG_HCI_EVENT_QOS_VIOLATION
case|:
name|error
operator|=
name|qos_violation
argument_list|(
name|unit
argument_list|,
name|event
argument_list|)
expr_stmt|;
break|break;
case|case
name|NG_HCI_EVENT_PAGE_SCAN_MODE_CHANGE
case|:
name|error
operator|=
name|page_scan_mode_change
argument_list|(
name|unit
argument_list|,
name|event
argument_list|)
expr_stmt|;
break|break;
case|case
name|NG_HCI_EVENT_PAGE_SCAN_REP_MODE_CHANGE
case|:
name|error
operator|=
name|page_scan_rep_mode_change
argument_list|(
name|unit
argument_list|,
name|event
argument_list|)
expr_stmt|;
break|break;
default|default:
name|NG_FREE_M
argument_list|(
name|event
argument_list|)
expr_stmt|;
name|error
operator|=
name|EINVAL
expr_stmt|;
break|break;
block|}
return|return
operator|(
name|error
operator|)
return|;
block|}
end_function

begin_comment
comment|/* ng_hci_process_event */
end_comment

begin_comment
comment|/*  * Send ACL and/or SCO data to the unit driver  */
end_comment

begin_function
name|void
name|ng_hci_send_data
parameter_list|(
name|ng_hci_unit_p
name|unit
parameter_list|)
block|{
name|int
name|count
decl_stmt|;
comment|/* Send ACL data */
name|NG_HCI_BUFF_ACL_AVAIL
argument_list|(
name|unit
operator|->
name|buffer
argument_list|,
name|count
argument_list|)
expr_stmt|;
name|NG_HCI_INFO
argument_list|(
literal|"%s: %s - sending ACL data packets, count=%d\n"
argument_list|,
name|__func__
argument_list|,
name|NG_NODE_NAME
argument_list|(
name|unit
operator|->
name|node
argument_list|)
argument_list|,
name|count
argument_list|)
expr_stmt|;
if|if
condition|(
name|count
operator|>
literal|0
condition|)
block|{
name|count
operator|=
name|send_data_packets
argument_list|(
name|unit
argument_list|,
name|NG_HCI_LINK_ACL
argument_list|,
name|count
argument_list|)
expr_stmt|;
name|NG_HCI_STAT_ACL_SENT
argument_list|(
name|unit
operator|->
name|stat
argument_list|,
name|count
argument_list|)
expr_stmt|;
name|NG_HCI_BUFF_ACL_USE
argument_list|(
name|unit
operator|->
name|buffer
argument_list|,
name|count
argument_list|)
expr_stmt|;
block|}
comment|/* Send SCO data */
name|NG_HCI_BUFF_SCO_AVAIL
argument_list|(
name|unit
operator|->
name|buffer
argument_list|,
name|count
argument_list|)
expr_stmt|;
name|NG_HCI_INFO
argument_list|(
literal|"%s: %s - sending SCO data packets, count=%d\n"
argument_list|,
name|__func__
argument_list|,
name|NG_NODE_NAME
argument_list|(
name|unit
operator|->
name|node
argument_list|)
argument_list|,
name|count
argument_list|)
expr_stmt|;
if|if
condition|(
name|count
operator|>
literal|0
condition|)
block|{
name|count
operator|=
name|send_data_packets
argument_list|(
name|unit
argument_list|,
name|NG_HCI_LINK_SCO
argument_list|,
name|count
argument_list|)
expr_stmt|;
name|NG_HCI_STAT_SCO_SENT
argument_list|(
name|unit
operator|->
name|stat
argument_list|,
name|count
argument_list|)
expr_stmt|;
name|NG_HCI_BUFF_SCO_USE
argument_list|(
name|unit
operator|->
name|buffer
argument_list|,
name|count
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/* ng_hci_send_data */
end_comment

begin_comment
comment|/*  * Send data packets to the lower layer.  */
end_comment

begin_function
specifier|static
name|int
name|send_data_packets
parameter_list|(
name|ng_hci_unit_p
name|unit
parameter_list|,
name|int
name|link_type
parameter_list|,
name|int
name|limit
parameter_list|)
block|{
name|ng_hci_unit_con_p
name|con
init|=
name|NULL
decl_stmt|,
name|winner
init|=
name|NULL
decl_stmt|;
name|item_p
name|item
init|=
name|NULL
decl_stmt|;
name|int
name|min_pending
decl_stmt|,
name|total_sent
decl_stmt|,
name|sent
decl_stmt|,
name|error
decl_stmt|,
name|v
decl_stmt|;
for|for
control|(
name|total_sent
operator|=
literal|0
init|;
name|limit
operator|>
literal|0
condition|;
control|)
block|{
name|min_pending
operator|=
literal|0x0fffffff
expr_stmt|;
name|winner
operator|=
name|NULL
expr_stmt|;
comment|/* 		 * Find the connection that has has data to send  		 * and the smallest number of pending packets 		 */
name|LIST_FOREACH
argument_list|(
argument|con
argument_list|,
argument|&unit->con_list
argument_list|,
argument|next
argument_list|)
block|{
if|if
condition|(
name|con
operator|->
name|link_type
operator|!=
name|link_type
condition|)
continue|continue;
if|if
condition|(
name|NG_BT_ITEMQ_LEN
argument_list|(
operator|&
name|con
operator|->
name|conq
argument_list|)
operator|==
literal|0
condition|)
continue|continue;
if|if
condition|(
name|con
operator|->
name|pending
operator|<
name|min_pending
condition|)
block|{
name|winner
operator|=
name|con
expr_stmt|;
name|min_pending
operator|=
name|con
operator|->
name|pending
expr_stmt|;
block|}
block|}
if|if
condition|(
name|winner
operator|==
name|NULL
condition|)
break|break;
comment|/*  		 * OK, we have a winner now send as much packets as we can 		 * Count the number of packets we have sent and then sync 		 * winner connection queue. 		 */
for|for
control|(
name|sent
operator|=
literal|0
init|;
name|limit
operator|>
literal|0
condition|;
name|limit
operator|--
operator|,
name|total_sent
operator|++
operator|,
name|sent
operator|++
control|)
block|{
name|NG_BT_ITEMQ_DEQUEUE
argument_list|(
operator|&
name|winner
operator|->
name|conq
argument_list|,
name|item
argument_list|)
expr_stmt|;
if|if
condition|(
name|item
operator|==
name|NULL
condition|)
break|break;
name|NG_HCI_INFO
argument_list|(
literal|"%s: %s - sending data packet, handle=%d, len=%d\n"
argument_list|,
name|__func__
argument_list|,
name|NG_NODE_NAME
argument_list|(
name|unit
operator|->
name|node
argument_list|)
argument_list|,
name|winner
operator|->
name|con_handle
argument_list|,
name|NGI_M
argument_list|(
name|item
argument_list|)
operator|->
name|m_pkthdr
operator|.
name|len
argument_list|)
expr_stmt|;
comment|/* Check if driver hook still there */
name|v
operator|=
operator|(
name|unit
operator|->
name|drv
operator|!=
name|NULL
operator|&&
name|NG_HOOK_IS_VALID
argument_list|(
name|unit
operator|->
name|drv
argument_list|)
operator|)
expr_stmt|;
if|if
condition|(
operator|!
name|v
operator|||
operator|(
name|unit
operator|->
name|state
operator|&
name|NG_HCI_UNIT_READY
operator|)
operator|!=
name|NG_HCI_UNIT_READY
condition|)
block|{
name|NG_HCI_ERR
argument_list|(
literal|"%s: %s - could not send data. Hook \"%s\" is %svalid, state=%#x\n"
argument_list|,
name|__func__
argument_list|,
name|NG_NODE_NAME
argument_list|(
name|unit
operator|->
name|node
argument_list|)
argument_list|,
name|NG_HCI_HOOK_DRV
argument_list|,
operator|(
operator|(
name|v
operator|)
condition|?
literal|""
else|:
literal|"not "
operator|)
argument_list|,
name|unit
operator|->
name|state
argument_list|)
expr_stmt|;
name|NG_FREE_ITEM
argument_list|(
name|item
argument_list|)
expr_stmt|;
name|error
operator|=
name|ENOTCONN
expr_stmt|;
block|}
else|else
block|{
name|v
operator|=
name|NGI_M
argument_list|(
name|item
argument_list|)
operator|->
name|m_pkthdr
operator|.
name|len
expr_stmt|;
comment|/* Give packet to raw hook */
name|ng_hci_mtap
argument_list|(
name|unit
argument_list|,
name|NGI_M
argument_list|(
name|item
argument_list|)
argument_list|)
expr_stmt|;
comment|/* ... and forward item to the driver */
name|NG_FWD_ITEM_HOOK
argument_list|(
name|error
argument_list|,
name|item
argument_list|,
name|unit
operator|->
name|drv
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|error
operator|!=
literal|0
condition|)
block|{
name|NG_HCI_ERR
argument_list|(
literal|"%s: %s - could not send data packet, handle=%d, error=%d\n"
argument_list|,
name|__func__
argument_list|,
name|NG_NODE_NAME
argument_list|(
name|unit
operator|->
name|node
argument_list|)
argument_list|,
name|winner
operator|->
name|con_handle
argument_list|,
name|error
argument_list|)
expr_stmt|;
break|break;
block|}
name|winner
operator|->
name|pending
operator|++
expr_stmt|;
name|NG_HCI_STAT_BYTES_SENT
argument_list|(
name|unit
operator|->
name|stat
argument_list|,
name|v
argument_list|)
expr_stmt|;
block|}
comment|/* 		 * Sync connection queue for the winner 		 */
name|sync_con_queue
argument_list|(
name|unit
argument_list|,
name|winner
argument_list|,
name|sent
argument_list|)
expr_stmt|;
block|}
return|return
operator|(
name|total_sent
operator|)
return|;
block|}
end_function

begin_comment
comment|/* send_data_packets */
end_comment

begin_comment
comment|/*  * Send flow control messages to the upper layer  */
end_comment

begin_function
specifier|static
name|int
name|sync_con_queue
parameter_list|(
name|ng_hci_unit_p
name|unit
parameter_list|,
name|ng_hci_unit_con_p
name|con
parameter_list|,
name|int
name|completed
parameter_list|)
block|{
name|hook_p
name|hook
init|=
name|NULL
decl_stmt|;
name|struct
name|ng_mesg
modifier|*
name|msg
init|=
name|NULL
decl_stmt|;
name|ng_hci_sync_con_queue_ep
modifier|*
name|state
init|=
name|NULL
decl_stmt|;
name|int
name|error
decl_stmt|;
name|hook
operator|=
operator|(
name|con
operator|->
name|link_type
operator|==
name|NG_HCI_LINK_ACL
operator|)
condition|?
name|unit
operator|->
name|acl
else|:
name|unit
operator|->
name|sco
expr_stmt|;
if|if
condition|(
name|hook
operator|==
name|NULL
operator|||
name|NG_HOOK_NOT_VALID
argument_list|(
name|hook
argument_list|)
condition|)
return|return
operator|(
name|ENOTCONN
operator|)
return|;
name|NG_MKMESSAGE
argument_list|(
name|msg
argument_list|,
name|NGM_HCI_COOKIE
argument_list|,
name|NGM_HCI_SYNC_CON_QUEUE
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|state
argument_list|)
argument_list|,
name|M_NOWAIT
argument_list|)
expr_stmt|;
if|if
condition|(
name|msg
operator|==
name|NULL
condition|)
return|return
operator|(
name|ENOMEM
operator|)
return|;
name|state
operator|=
operator|(
name|ng_hci_sync_con_queue_ep
operator|*
operator|)
operator|(
name|msg
operator|->
name|data
operator|)
expr_stmt|;
name|state
operator|->
name|con_handle
operator|=
name|con
operator|->
name|con_handle
expr_stmt|;
name|state
operator|->
name|completed
operator|=
name|completed
expr_stmt|;
name|NG_SEND_MSG_HOOK
argument_list|(
name|error
argument_list|,
name|unit
operator|->
name|node
argument_list|,
name|msg
argument_list|,
name|hook
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
end_function

begin_comment
comment|/* sync_con_queue */
end_comment

begin_comment
comment|/* Inquiry result event */
end_comment

begin_function
specifier|static
name|int
name|inquiry_result
parameter_list|(
name|ng_hci_unit_p
name|unit
parameter_list|,
name|struct
name|mbuf
modifier|*
name|event
parameter_list|)
block|{
name|ng_hci_inquiry_result_ep
modifier|*
name|ep
init|=
name|NULL
decl_stmt|;
name|ng_hci_neighbor_p
name|n
init|=
name|NULL
decl_stmt|;
name|bdaddr_t
name|bdaddr
decl_stmt|;
name|int
name|error
init|=
literal|0
decl_stmt|;
name|NG_HCI_M_PULLUP
argument_list|(
name|event
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|ep
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|event
operator|==
name|NULL
condition|)
return|return
operator|(
name|ENOBUFS
operator|)
return|;
name|ep
operator|=
name|mtod
argument_list|(
name|event
argument_list|,
name|ng_hci_inquiry_result_ep
operator|*
argument_list|)
expr_stmt|;
name|m_adj
argument_list|(
name|event
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|ep
argument_list|)
argument_list|)
expr_stmt|;
for|for
control|(
init|;
name|ep
operator|->
name|num_responses
operator|>
literal|0
condition|;
name|ep
operator|->
name|num_responses
operator|--
control|)
block|{
comment|/* Get remote unit address */
name|m_copydata
argument_list|(
name|event
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|bdaddr
argument_list|)
argument_list|,
operator|(
name|caddr_t
operator|)
operator|&
name|bdaddr
argument_list|)
expr_stmt|;
name|m_adj
argument_list|(
name|event
argument_list|,
sizeof|sizeof
argument_list|(
name|bdaddr
argument_list|)
argument_list|)
expr_stmt|;
comment|/* Lookup entry in the cache */
name|n
operator|=
name|ng_hci_get_neighbor
argument_list|(
name|unit
argument_list|,
operator|&
name|bdaddr
argument_list|)
expr_stmt|;
if|if
condition|(
name|n
operator|==
name|NULL
condition|)
block|{
comment|/* Create new entry */
name|n
operator|=
name|ng_hci_new_neighbor
argument_list|(
name|unit
argument_list|)
expr_stmt|;
if|if
condition|(
name|n
operator|==
name|NULL
condition|)
block|{
name|error
operator|=
name|ENOMEM
expr_stmt|;
break|break;
block|}
block|}
else|else
name|getmicrotime
argument_list|(
operator|&
name|n
operator|->
name|updated
argument_list|)
expr_stmt|;
name|bcopy
argument_list|(
operator|&
name|bdaddr
argument_list|,
operator|&
name|n
operator|->
name|bdaddr
argument_list|,
sizeof|sizeof
argument_list|(
name|n
operator|->
name|bdaddr
argument_list|)
argument_list|)
expr_stmt|;
comment|/* XXX call m_pullup here? */
name|n
operator|->
name|page_scan_rep_mode
operator|=
operator|*
name|mtod
argument_list|(
name|event
argument_list|,
name|u_int8_t
operator|*
argument_list|)
expr_stmt|;
name|m_adj
argument_list|(
name|event
argument_list|,
sizeof|sizeof
argument_list|(
name|u_int8_t
argument_list|)
argument_list|)
expr_stmt|;
comment|/* page_scan_period_mode */
name|m_adj
argument_list|(
name|event
argument_list|,
sizeof|sizeof
argument_list|(
name|u_int8_t
argument_list|)
argument_list|)
expr_stmt|;
name|n
operator|->
name|page_scan_mode
operator|=
operator|*
name|mtod
argument_list|(
name|event
argument_list|,
name|u_int8_t
operator|*
argument_list|)
expr_stmt|;
name|m_adj
argument_list|(
name|event
argument_list|,
sizeof|sizeof
argument_list|(
name|u_int8_t
argument_list|)
argument_list|)
expr_stmt|;
comment|/* class */
name|m_adj
argument_list|(
name|event
argument_list|,
name|NG_HCI_CLASS_SIZE
argument_list|)
expr_stmt|;
comment|/* clock offset */
name|m_copydata
argument_list|(
name|event
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|n
operator|->
name|clock_offset
argument_list|)
argument_list|,
operator|(
name|caddr_t
operator|)
operator|&
name|n
operator|->
name|clock_offset
argument_list|)
expr_stmt|;
name|n
operator|->
name|clock_offset
operator|=
name|le16toh
argument_list|(
name|n
operator|->
name|clock_offset
argument_list|)
expr_stmt|;
block|}
name|NG_FREE_M
argument_list|(
name|event
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
end_function

begin_comment
comment|/* inquiry_result */
end_comment

begin_comment
comment|/* Connection complete event */
end_comment

begin_function
specifier|static
name|int
name|con_compl
parameter_list|(
name|ng_hci_unit_p
name|unit
parameter_list|,
name|struct
name|mbuf
modifier|*
name|event
parameter_list|)
block|{
name|ng_hci_con_compl_ep
modifier|*
name|ep
init|=
name|NULL
decl_stmt|;
name|ng_hci_unit_con_p
name|con
init|=
name|NULL
decl_stmt|;
name|int
name|error
init|=
literal|0
decl_stmt|;
name|NG_HCI_M_PULLUP
argument_list|(
name|event
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|ep
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|event
operator|==
name|NULL
condition|)
return|return
operator|(
name|ENOBUFS
operator|)
return|;
name|ep
operator|=
name|mtod
argument_list|(
name|event
argument_list|,
name|ng_hci_con_compl_ep
operator|*
argument_list|)
expr_stmt|;
comment|/* 	 * Find the first connection descriptor that matches the following: 	 * 	 * 1) con->link_type == ep->link_type 	 * 2) con->state == NG_HCI_CON_W4_CONN_COMPLETE 	 * 3) con->bdaddr == ep->bdaddr 	 */
name|LIST_FOREACH
argument_list|(
argument|con
argument_list|,
argument|&unit->con_list
argument_list|,
argument|next
argument_list|)
if|if
condition|(
name|con
operator|->
name|link_type
operator|==
name|ep
operator|->
name|link_type
operator|&&
name|con
operator|->
name|state
operator|==
name|NG_HCI_CON_W4_CONN_COMPLETE
operator|&&
name|bcmp
argument_list|(
operator|&
name|con
operator|->
name|bdaddr
argument_list|,
operator|&
name|ep
operator|->
name|bdaddr
argument_list|,
sizeof|sizeof
argument_list|(
name|bdaddr_t
argument_list|)
argument_list|)
operator|==
literal|0
condition|)
break|break;
comment|/* 	 * Two possible cases: 	 * 	 * 1) We have found connection descriptor. That means upper layer has 	 *    requested this connection via LP_CON_REQ message 	 * 	 * 2) We do not have connection descriptor. That means upper layer 	 *    nas not requested this connection or (less likely) we gave up 	 *    on this connection (timeout). The most likely scenario is that 	 *    we have received Create_Connection/Add_SCO_Connection command  	 *    from the RAW hook 	 */
if|if
condition|(
name|con
operator|==
name|NULL
condition|)
block|{
if|if
condition|(
name|ep
operator|->
name|status
operator|!=
literal|0
condition|)
goto|goto
name|out
goto|;
name|con
operator|=
name|ng_hci_new_con
argument_list|(
name|unit
argument_list|,
name|ep
operator|->
name|link_type
argument_list|)
expr_stmt|;
if|if
condition|(
name|con
operator|==
name|NULL
condition|)
block|{
name|error
operator|=
name|ENOMEM
expr_stmt|;
goto|goto
name|out
goto|;
block|}
name|bcopy
argument_list|(
operator|&
name|ep
operator|->
name|bdaddr
argument_list|,
operator|&
name|con
operator|->
name|bdaddr
argument_list|,
sizeof|sizeof
argument_list|(
name|con
operator|->
name|bdaddr
argument_list|)
argument_list|)
expr_stmt|;
block|}
else|else
name|ng_hci_con_untimeout
argument_list|(
name|con
argument_list|)
expr_stmt|;
comment|/* 	 * Update connection descriptor and send notification  	 * to the upper layers. 	 */
name|con
operator|->
name|con_handle
operator|=
name|NG_HCI_CON_HANDLE
argument_list|(
name|le16toh
argument_list|(
name|ep
operator|->
name|con_handle
argument_list|)
argument_list|)
expr_stmt|;
name|con
operator|->
name|encryption_mode
operator|=
name|ep
operator|->
name|encryption_mode
expr_stmt|;
name|ng_hci_lp_con_cfm
argument_list|(
name|con
argument_list|,
name|ep
operator|->
name|status
argument_list|)
expr_stmt|;
comment|/* Adjust connection state */
if|if
condition|(
name|ep
operator|->
name|status
operator|!=
literal|0
condition|)
name|ng_hci_free_con
argument_list|(
name|con
argument_list|)
expr_stmt|;
else|else
block|{
name|con
operator|->
name|state
operator|=
name|NG_HCI_CON_OPEN
expr_stmt|;
comment|/*	 		 * Change link policy for the ACL connections. Enable all  		 * supported link modes. Enable Role switch as well if 		 * device supports it. 		 */
if|if
condition|(
name|ep
operator|->
name|link_type
operator|==
name|NG_HCI_LINK_ACL
condition|)
block|{
struct|struct
name|__link_policy
block|{
name|ng_hci_cmd_pkt_t
name|hdr
decl_stmt|;
name|ng_hci_write_link_policy_settings_cp
name|cp
decl_stmt|;
block|}
name|__attribute__
argument_list|(
operator|(
name|packed
operator|)
argument_list|)
modifier|*
name|lp
struct|;
name|struct
name|mbuf
modifier|*
name|m
decl_stmt|;
name|MGETHDR
argument_list|(
name|m
argument_list|,
name|M_NOWAIT
argument_list|,
name|MT_DATA
argument_list|)
expr_stmt|;
if|if
condition|(
name|m
operator|!=
name|NULL
condition|)
block|{
name|m
operator|->
name|m_pkthdr
operator|.
name|len
operator|=
name|m
operator|->
name|m_len
operator|=
sizeof|sizeof
argument_list|(
operator|*
name|lp
argument_list|)
expr_stmt|;
name|lp
operator|=
name|mtod
argument_list|(
name|m
argument_list|,
expr|struct
name|__link_policy
operator|*
argument_list|)
expr_stmt|;
name|lp
operator|->
name|hdr
operator|.
name|type
operator|=
name|NG_HCI_CMD_PKT
expr_stmt|;
name|lp
operator|->
name|hdr
operator|.
name|opcode
operator|=
name|htole16
argument_list|(
name|NG_HCI_OPCODE
argument_list|(
name|NG_HCI_OGF_LINK_POLICY
argument_list|,
name|NG_HCI_OCF_WRITE_LINK_POLICY_SETTINGS
argument_list|)
argument_list|)
expr_stmt|;
name|lp
operator|->
name|hdr
operator|.
name|length
operator|=
sizeof|sizeof
argument_list|(
name|lp
operator|->
name|cp
argument_list|)
expr_stmt|;
name|lp
operator|->
name|cp
operator|.
name|con_handle
operator|=
name|ep
operator|->
name|con_handle
expr_stmt|;
name|lp
operator|->
name|cp
operator|.
name|settings
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|unit
operator|->
name|features
index|[
literal|0
index|]
operator|&
name|NG_HCI_LMP_SWITCH
condition|)
name|lp
operator|->
name|cp
operator|.
name|settings
operator||=
literal|0x1
expr_stmt|;
if|if
condition|(
name|unit
operator|->
name|features
index|[
literal|0
index|]
operator|&
name|NG_HCI_LMP_HOLD_MODE
condition|)
name|lp
operator|->
name|cp
operator|.
name|settings
operator||=
literal|0x2
expr_stmt|;
if|if
condition|(
name|unit
operator|->
name|features
index|[
literal|0
index|]
operator|&
name|NG_HCI_LMP_SNIFF_MODE
condition|)
name|lp
operator|->
name|cp
operator|.
name|settings
operator||=
literal|0x4
expr_stmt|;
if|if
condition|(
name|unit
operator|->
name|features
index|[
literal|1
index|]
operator|&
name|NG_HCI_LMP_PARK_MODE
condition|)
name|lp
operator|->
name|cp
operator|.
name|settings
operator||=
literal|0x8
expr_stmt|;
name|lp
operator|->
name|cp
operator|.
name|settings
operator|&=
name|unit
operator|->
name|link_policy_mask
expr_stmt|;
name|lp
operator|->
name|cp
operator|.
name|settings
operator|=
name|htole16
argument_list|(
name|lp
operator|->
name|cp
operator|.
name|settings
argument_list|)
expr_stmt|;
name|NG_BT_MBUFQ_ENQUEUE
argument_list|(
operator|&
name|unit
operator|->
name|cmdq
argument_list|,
name|m
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|unit
operator|->
name|state
operator|&
name|NG_HCI_UNIT_COMMAND_PENDING
operator|)
condition|)
name|ng_hci_send_command
argument_list|(
name|unit
argument_list|)
expr_stmt|;
block|}
block|}
block|}
name|out
label|:
name|NG_FREE_M
argument_list|(
name|event
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
end_function

begin_comment
comment|/* com_compl */
end_comment

begin_comment
comment|/* Connection request event */
end_comment

begin_function
specifier|static
name|int
name|con_req
parameter_list|(
name|ng_hci_unit_p
name|unit
parameter_list|,
name|struct
name|mbuf
modifier|*
name|event
parameter_list|)
block|{
name|ng_hci_con_req_ep
modifier|*
name|ep
init|=
name|NULL
decl_stmt|;
name|ng_hci_unit_con_p
name|con
init|=
name|NULL
decl_stmt|;
name|int
name|error
init|=
literal|0
decl_stmt|;
name|NG_HCI_M_PULLUP
argument_list|(
name|event
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|ep
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|event
operator|==
name|NULL
condition|)
return|return
operator|(
name|ENOBUFS
operator|)
return|;
name|ep
operator|=
name|mtod
argument_list|(
name|event
argument_list|,
name|ng_hci_con_req_ep
operator|*
argument_list|)
expr_stmt|;
comment|/* 	 * Find the first connection descriptor that matches the following: 	 * 	 * 1) con->link_type == ep->link_type 	 * 	 * 2) con->state == NG_HCI_CON_W4_LP_CON_RSP || 	 *    con->state == NG_HCI_CON_W4_CONN_COMPL 	 *  	 * 3) con->bdaddr == ep->bdaddr 	 * 	 * Possible cases: 	 * 	 * 1) We do not have connection descriptor. This is simple. Create 	 *    new fresh connection descriptor and send notification to the 	 *    appropriate upstream hook (based on link_type). 	 * 	 * 2) We found connection handle. This is more complicated. 	 *  	 * 2.1) ACL links 	 * 	 *      Since only one ACL link can exist between each pair of 	 *      units then we have a race. Our upper layer has requested  	 *      an ACL connection to the remote unit, but we did not send  	 *      command yet. At the same time the remote unit has requested 	 *      an ACL connection from us. In this case we will ignore  	 *	Connection_Request event. This probably will cause connect 	 *      failure	on both units. 	 * 	 * 2.2) SCO links 	 * 	 *      The spec on page 45 says : 	 * 	 *      "The master can support up to three SCO links to the same  	 *       slave or to different slaves. A slave can support up to  	 *       three SCO links from the same master, or two SCO links if  	 *       the links originate from different masters." 	 * 	 *      The only problem is how to handle multiple SCO links between 	 *      matster and slave. For now we will assume that multiple SCO 	 *      links MUST be opened one after another.  	 */
name|LIST_FOREACH
argument_list|(
argument|con
argument_list|,
argument|&unit->con_list
argument_list|,
argument|next
argument_list|)
if|if
condition|(
name|con
operator|->
name|link_type
operator|==
name|ep
operator|->
name|link_type
operator|&&
operator|(
name|con
operator|->
name|state
operator|==
name|NG_HCI_CON_W4_LP_CON_RSP
operator|||
name|con
operator|->
name|state
operator|==
name|NG_HCI_CON_W4_CONN_COMPLETE
operator|)
operator|&&
name|bcmp
argument_list|(
operator|&
name|con
operator|->
name|bdaddr
argument_list|,
operator|&
name|ep
operator|->
name|bdaddr
argument_list|,
sizeof|sizeof
argument_list|(
name|bdaddr_t
argument_list|)
argument_list|)
operator|==
literal|0
condition|)
break|break;
if|if
condition|(
name|con
operator|==
name|NULL
condition|)
block|{
name|con
operator|=
name|ng_hci_new_con
argument_list|(
name|unit
argument_list|,
name|ep
operator|->
name|link_type
argument_list|)
expr_stmt|;
if|if
condition|(
name|con
operator|!=
name|NULL
condition|)
block|{
name|bcopy
argument_list|(
operator|&
name|ep
operator|->
name|bdaddr
argument_list|,
operator|&
name|con
operator|->
name|bdaddr
argument_list|,
sizeof|sizeof
argument_list|(
name|con
operator|->
name|bdaddr
argument_list|)
argument_list|)
expr_stmt|;
name|con
operator|->
name|state
operator|=
name|NG_HCI_CON_W4_LP_CON_RSP
expr_stmt|;
name|ng_hci_con_timeout
argument_list|(
name|con
argument_list|)
expr_stmt|;
name|error
operator|=
name|ng_hci_lp_con_ind
argument_list|(
name|con
argument_list|,
name|ep
operator|->
name|uclass
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|!=
literal|0
condition|)
name|ng_hci_free_con
argument_list|(
name|con
argument_list|)
expr_stmt|;
block|}
else|else
name|error
operator|=
name|ENOMEM
expr_stmt|;
block|}
name|NG_FREE_M
argument_list|(
name|event
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
end_function

begin_comment
comment|/* con_req */
end_comment

begin_comment
comment|/* Disconnect complete event */
end_comment

begin_function
specifier|static
name|int
name|discon_compl
parameter_list|(
name|ng_hci_unit_p
name|unit
parameter_list|,
name|struct
name|mbuf
modifier|*
name|event
parameter_list|)
block|{
name|ng_hci_discon_compl_ep
modifier|*
name|ep
init|=
name|NULL
decl_stmt|;
name|ng_hci_unit_con_p
name|con
init|=
name|NULL
decl_stmt|;
name|int
name|error
init|=
literal|0
decl_stmt|;
name|u_int16_t
name|h
decl_stmt|;
name|NG_HCI_M_PULLUP
argument_list|(
name|event
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|ep
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|event
operator|==
name|NULL
condition|)
return|return
operator|(
name|ENOBUFS
operator|)
return|;
name|ep
operator|=
name|mtod
argument_list|(
name|event
argument_list|,
name|ng_hci_discon_compl_ep
operator|*
argument_list|)
expr_stmt|;
comment|/*  	 * XXX  	 * Do we have to send notification if ep->status != 0?  	 * For now we will send notification for both ACL and SCO connections 	 * ONLY if ep->status == 0. 	 */
if|if
condition|(
name|ep
operator|->
name|status
operator|==
literal|0
condition|)
block|{
name|h
operator|=
name|NG_HCI_CON_HANDLE
argument_list|(
name|le16toh
argument_list|(
name|ep
operator|->
name|con_handle
argument_list|)
argument_list|)
expr_stmt|;
name|con
operator|=
name|ng_hci_con_by_handle
argument_list|(
name|unit
argument_list|,
name|h
argument_list|)
expr_stmt|;
if|if
condition|(
name|con
operator|!=
name|NULL
condition|)
block|{
name|error
operator|=
name|ng_hci_lp_discon_ind
argument_list|(
name|con
argument_list|,
name|ep
operator|->
name|reason
argument_list|)
expr_stmt|;
name|ng_hci_free_con
argument_list|(
name|con
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|NG_HCI_ALERT
argument_list|(
literal|"%s: %s - invalid connection handle=%d\n"
argument_list|,
name|__func__
argument_list|,
name|NG_NODE_NAME
argument_list|(
name|unit
operator|->
name|node
argument_list|)
argument_list|,
name|h
argument_list|)
expr_stmt|;
name|error
operator|=
name|ENOENT
expr_stmt|;
block|}
block|}
name|NG_FREE_M
argument_list|(
name|event
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
end_function

begin_comment
comment|/* discon_compl */
end_comment

begin_comment
comment|/* Read remote feature complete event */
end_comment

begin_function
specifier|static
name|int
name|read_remote_features_compl
parameter_list|(
name|ng_hci_unit_p
name|unit
parameter_list|,
name|struct
name|mbuf
modifier|*
name|event
parameter_list|)
block|{
name|ng_hci_read_remote_features_compl_ep
modifier|*
name|ep
init|=
name|NULL
decl_stmt|;
name|ng_hci_unit_con_p
name|con
init|=
name|NULL
decl_stmt|;
name|ng_hci_neighbor_p
name|n
init|=
name|NULL
decl_stmt|;
name|u_int16_t
name|h
decl_stmt|;
name|int
name|error
init|=
literal|0
decl_stmt|;
name|NG_HCI_M_PULLUP
argument_list|(
name|event
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|ep
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|event
operator|==
name|NULL
condition|)
return|return
operator|(
name|ENOBUFS
operator|)
return|;
name|ep
operator|=
name|mtod
argument_list|(
name|event
argument_list|,
name|ng_hci_read_remote_features_compl_ep
operator|*
argument_list|)
expr_stmt|;
if|if
condition|(
name|ep
operator|->
name|status
operator|==
literal|0
condition|)
block|{
comment|/* Check if we have this connection handle */
name|h
operator|=
name|NG_HCI_CON_HANDLE
argument_list|(
name|le16toh
argument_list|(
name|ep
operator|->
name|con_handle
argument_list|)
argument_list|)
expr_stmt|;
name|con
operator|=
name|ng_hci_con_by_handle
argument_list|(
name|unit
argument_list|,
name|h
argument_list|)
expr_stmt|;
if|if
condition|(
name|con
operator|==
name|NULL
condition|)
block|{
name|NG_HCI_ALERT
argument_list|(
literal|"%s: %s - invalid connection handle=%d\n"
argument_list|,
name|__func__
argument_list|,
name|NG_NODE_NAME
argument_list|(
name|unit
operator|->
name|node
argument_list|)
argument_list|,
name|h
argument_list|)
expr_stmt|;
name|error
operator|=
name|ENOENT
expr_stmt|;
goto|goto
name|out
goto|;
block|}
comment|/* Update cache entry */
name|n
operator|=
name|ng_hci_get_neighbor
argument_list|(
name|unit
argument_list|,
operator|&
name|con
operator|->
name|bdaddr
argument_list|)
expr_stmt|;
if|if
condition|(
name|n
operator|==
name|NULL
condition|)
block|{
name|n
operator|=
name|ng_hci_new_neighbor
argument_list|(
name|unit
argument_list|)
expr_stmt|;
if|if
condition|(
name|n
operator|==
name|NULL
condition|)
block|{
name|error
operator|=
name|ENOMEM
expr_stmt|;
goto|goto
name|out
goto|;
block|}
name|bcopy
argument_list|(
operator|&
name|con
operator|->
name|bdaddr
argument_list|,
operator|&
name|n
operator|->
name|bdaddr
argument_list|,
sizeof|sizeof
argument_list|(
name|n
operator|->
name|bdaddr
argument_list|)
argument_list|)
expr_stmt|;
block|}
else|else
name|getmicrotime
argument_list|(
operator|&
name|n
operator|->
name|updated
argument_list|)
expr_stmt|;
name|bcopy
argument_list|(
name|ep
operator|->
name|features
argument_list|,
name|n
operator|->
name|features
argument_list|,
sizeof|sizeof
argument_list|(
name|n
operator|->
name|features
argument_list|)
argument_list|)
expr_stmt|;
block|}
else|else
name|NG_HCI_ERR
argument_list|(
literal|"%s: %s - failed to read remote unit features, status=%d\n"
argument_list|,
name|__func__
argument_list|,
name|NG_NODE_NAME
argument_list|(
name|unit
operator|->
name|node
argument_list|)
argument_list|,
name|ep
operator|->
name|status
argument_list|)
expr_stmt|;
name|out
label|:
name|NG_FREE_M
argument_list|(
name|event
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
end_function

begin_comment
comment|/* read_remote_features_compl */
end_comment

begin_comment
comment|/* QoS setup complete event */
end_comment

begin_function
specifier|static
name|int
name|qos_setup_compl
parameter_list|(
name|ng_hci_unit_p
name|unit
parameter_list|,
name|struct
name|mbuf
modifier|*
name|event
parameter_list|)
block|{
name|ng_hci_qos_setup_compl_ep
modifier|*
name|ep
init|=
name|NULL
decl_stmt|;
name|ng_hci_unit_con_p
name|con
init|=
name|NULL
decl_stmt|;
name|u_int16_t
name|h
decl_stmt|;
name|int
name|error
init|=
literal|0
decl_stmt|;
name|NG_HCI_M_PULLUP
argument_list|(
name|event
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|ep
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|event
operator|==
name|NULL
condition|)
return|return
operator|(
name|ENOBUFS
operator|)
return|;
name|ep
operator|=
name|mtod
argument_list|(
name|event
argument_list|,
name|ng_hci_qos_setup_compl_ep
operator|*
argument_list|)
expr_stmt|;
comment|/* Check if we have this connection handle */
name|h
operator|=
name|NG_HCI_CON_HANDLE
argument_list|(
name|le16toh
argument_list|(
name|ep
operator|->
name|con_handle
argument_list|)
argument_list|)
expr_stmt|;
name|con
operator|=
name|ng_hci_con_by_handle
argument_list|(
name|unit
argument_list|,
name|h
argument_list|)
expr_stmt|;
if|if
condition|(
name|con
operator|==
name|NULL
condition|)
block|{
name|NG_HCI_ALERT
argument_list|(
literal|"%s: %s - invalid connection handle=%d\n"
argument_list|,
name|__func__
argument_list|,
name|NG_NODE_NAME
argument_list|(
name|unit
operator|->
name|node
argument_list|)
argument_list|,
name|h
argument_list|)
expr_stmt|;
name|error
operator|=
name|ENOENT
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|con
operator|->
name|link_type
operator|!=
name|NG_HCI_LINK_ACL
condition|)
block|{
name|NG_HCI_ALERT
argument_list|(
literal|"%s: %s - invalid link type=%d, handle=%d\n"
argument_list|,
name|__func__
argument_list|,
name|NG_NODE_NAME
argument_list|(
name|unit
operator|->
name|node
argument_list|)
argument_list|,
name|con
operator|->
name|link_type
argument_list|,
name|h
argument_list|)
expr_stmt|;
name|error
operator|=
name|EINVAL
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|con
operator|->
name|state
operator|!=
name|NG_HCI_CON_OPEN
condition|)
block|{
name|NG_HCI_ALERT
argument_list|(
literal|"%s: %s - invalid connection state=%d, handle=%d\n"
argument_list|,
name|__func__
argument_list|,
name|NG_NODE_NAME
argument_list|(
name|unit
operator|->
name|node
argument_list|)
argument_list|,
name|con
operator|->
name|state
argument_list|,
name|h
argument_list|)
expr_stmt|;
name|error
operator|=
name|EINVAL
expr_stmt|;
block|}
else|else
comment|/* Notify upper layer */
name|error
operator|=
name|ng_hci_lp_qos_cfm
argument_list|(
name|con
argument_list|,
name|ep
operator|->
name|status
argument_list|)
expr_stmt|;
name|NG_FREE_M
argument_list|(
name|event
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
end_function

begin_comment
comment|/* qos_setup_compl */
end_comment

begin_comment
comment|/* Hardware error event */
end_comment

begin_function
specifier|static
name|int
name|hardware_error
parameter_list|(
name|ng_hci_unit_p
name|unit
parameter_list|,
name|struct
name|mbuf
modifier|*
name|event
parameter_list|)
block|{
name|NG_HCI_ALERT
argument_list|(
literal|"%s: %s - hardware error %#x\n"
argument_list|,
name|__func__
argument_list|,
name|NG_NODE_NAME
argument_list|(
name|unit
operator|->
name|node
argument_list|)
argument_list|,
operator|*
name|mtod
argument_list|(
name|event
argument_list|,
name|u_int8_t
operator|*
argument_list|)
argument_list|)
expr_stmt|;
name|NG_FREE_M
argument_list|(
name|event
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_comment
comment|/* hardware_error */
end_comment

begin_comment
comment|/* Role change event */
end_comment

begin_function
specifier|static
name|int
name|role_change
parameter_list|(
name|ng_hci_unit_p
name|unit
parameter_list|,
name|struct
name|mbuf
modifier|*
name|event
parameter_list|)
block|{
name|ng_hci_role_change_ep
modifier|*
name|ep
init|=
name|NULL
decl_stmt|;
name|ng_hci_unit_con_p
name|con
init|=
name|NULL
decl_stmt|;
name|NG_HCI_M_PULLUP
argument_list|(
name|event
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|ep
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|event
operator|==
name|NULL
condition|)
return|return
operator|(
name|ENOBUFS
operator|)
return|;
name|ep
operator|=
name|mtod
argument_list|(
name|event
argument_list|,
name|ng_hci_role_change_ep
operator|*
argument_list|)
expr_stmt|;
if|if
condition|(
name|ep
operator|->
name|status
operator|==
literal|0
condition|)
block|{
comment|/* XXX shoud we also change "role" for SCO connections? */
name|con
operator|=
name|ng_hci_con_by_bdaddr
argument_list|(
name|unit
argument_list|,
operator|&
name|ep
operator|->
name|bdaddr
argument_list|,
name|NG_HCI_LINK_ACL
argument_list|)
expr_stmt|;
if|if
condition|(
name|con
operator|!=
name|NULL
condition|)
name|con
operator|->
name|role
operator|=
name|ep
operator|->
name|role
expr_stmt|;
else|else
name|NG_HCI_ALERT
argument_list|(
literal|"%s: %s - ACL connection does not exist, bdaddr=%x:%x:%x:%x:%x:%x\n"
argument_list|,
name|__func__
argument_list|,
name|NG_NODE_NAME
argument_list|(
name|unit
operator|->
name|node
argument_list|)
argument_list|,
name|ep
operator|->
name|bdaddr
operator|.
name|b
index|[
literal|5
index|]
argument_list|,
name|ep
operator|->
name|bdaddr
operator|.
name|b
index|[
literal|4
index|]
argument_list|,
name|ep
operator|->
name|bdaddr
operator|.
name|b
index|[
literal|3
index|]
argument_list|,
name|ep
operator|->
name|bdaddr
operator|.
name|b
index|[
literal|2
index|]
argument_list|,
name|ep
operator|->
name|bdaddr
operator|.
name|b
index|[
literal|1
index|]
argument_list|,
name|ep
operator|->
name|bdaddr
operator|.
name|b
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
block|}
else|else
name|NG_HCI_ERR
argument_list|(
literal|"%s: %s - failed to change role, status=%d, bdaddr=%x:%x:%x:%x:%x:%x\n"
argument_list|,
name|__func__
argument_list|,
name|NG_NODE_NAME
argument_list|(
name|unit
operator|->
name|node
argument_list|)
argument_list|,
name|ep
operator|->
name|status
argument_list|,
name|ep
operator|->
name|bdaddr
operator|.
name|b
index|[
literal|5
index|]
argument_list|,
name|ep
operator|->
name|bdaddr
operator|.
name|b
index|[
literal|4
index|]
argument_list|,
name|ep
operator|->
name|bdaddr
operator|.
name|b
index|[
literal|3
index|]
argument_list|,
name|ep
operator|->
name|bdaddr
operator|.
name|b
index|[
literal|2
index|]
argument_list|,
name|ep
operator|->
name|bdaddr
operator|.
name|b
index|[
literal|1
index|]
argument_list|,
name|ep
operator|->
name|bdaddr
operator|.
name|b
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
name|NG_FREE_M
argument_list|(
name|event
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_comment
comment|/* role_change */
end_comment

begin_comment
comment|/* Number of completed packets event */
end_comment

begin_function
specifier|static
name|int
name|num_compl_pkts
parameter_list|(
name|ng_hci_unit_p
name|unit
parameter_list|,
name|struct
name|mbuf
modifier|*
name|event
parameter_list|)
block|{
name|ng_hci_num_compl_pkts_ep
modifier|*
name|ep
init|=
name|NULL
decl_stmt|;
name|ng_hci_unit_con_p
name|con
init|=
name|NULL
decl_stmt|;
name|u_int16_t
name|h
decl_stmt|,
name|p
decl_stmt|;
name|NG_HCI_M_PULLUP
argument_list|(
name|event
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|ep
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|event
operator|==
name|NULL
condition|)
return|return
operator|(
name|ENOBUFS
operator|)
return|;
name|ep
operator|=
name|mtod
argument_list|(
name|event
argument_list|,
name|ng_hci_num_compl_pkts_ep
operator|*
argument_list|)
expr_stmt|;
name|m_adj
argument_list|(
name|event
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|ep
argument_list|)
argument_list|)
expr_stmt|;
for|for
control|(
init|;
name|ep
operator|->
name|num_con_handles
operator|>
literal|0
condition|;
name|ep
operator|->
name|num_con_handles
operator|--
control|)
block|{
comment|/* Get connection handle */
name|m_copydata
argument_list|(
name|event
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|h
argument_list|)
argument_list|,
operator|(
name|caddr_t
operator|)
operator|&
name|h
argument_list|)
expr_stmt|;
name|m_adj
argument_list|(
name|event
argument_list|,
sizeof|sizeof
argument_list|(
name|h
argument_list|)
argument_list|)
expr_stmt|;
name|h
operator|=
name|NG_HCI_CON_HANDLE
argument_list|(
name|le16toh
argument_list|(
name|h
argument_list|)
argument_list|)
expr_stmt|;
comment|/* Get number of completed packets */
name|m_copydata
argument_list|(
name|event
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|p
argument_list|)
argument_list|,
operator|(
name|caddr_t
operator|)
operator|&
name|p
argument_list|)
expr_stmt|;
name|m_adj
argument_list|(
name|event
argument_list|,
sizeof|sizeof
argument_list|(
name|p
argument_list|)
argument_list|)
expr_stmt|;
name|p
operator|=
name|le16toh
argument_list|(
name|p
argument_list|)
expr_stmt|;
comment|/* Check if we have this connection handle */
name|con
operator|=
name|ng_hci_con_by_handle
argument_list|(
name|unit
argument_list|,
name|h
argument_list|)
expr_stmt|;
if|if
condition|(
name|con
operator|!=
name|NULL
condition|)
block|{
name|con
operator|->
name|pending
operator|-=
name|p
expr_stmt|;
if|if
condition|(
name|con
operator|->
name|pending
operator|<
literal|0
condition|)
block|{
name|NG_HCI_WARN
argument_list|(
literal|"%s: %s - pending packet counter is out of sync! "
expr|\
literal|"handle=%d, pending=%d, ncp=%d\n"
argument_list|,
name|__func__
argument_list|,
name|NG_NODE_NAME
argument_list|(
name|unit
operator|->
name|node
argument_list|)
argument_list|,
name|con
operator|->
name|con_handle
argument_list|,
name|con
operator|->
name|pending
argument_list|,
name|p
argument_list|)
expr_stmt|;
name|con
operator|->
name|pending
operator|=
literal|0
expr_stmt|;
block|}
comment|/* Update buffer descriptor */
if|if
condition|(
name|con
operator|->
name|link_type
operator|==
name|NG_HCI_LINK_ACL
condition|)
name|NG_HCI_BUFF_ACL_FREE
argument_list|(
name|unit
operator|->
name|buffer
argument_list|,
name|p
argument_list|)
expr_stmt|;
else|else
name|NG_HCI_BUFF_SCO_FREE
argument_list|(
name|unit
operator|->
name|buffer
argument_list|,
name|p
argument_list|)
expr_stmt|;
block|}
else|else
name|NG_HCI_ALERT
argument_list|(
literal|"%s: %s - invalid connection handle=%d\n"
argument_list|,
name|__func__
argument_list|,
name|NG_NODE_NAME
argument_list|(
name|unit
operator|->
name|node
argument_list|)
argument_list|,
name|h
argument_list|)
expr_stmt|;
block|}
name|NG_FREE_M
argument_list|(
name|event
argument_list|)
expr_stmt|;
comment|/* Send more data */
name|ng_hci_send_data
argument_list|(
name|unit
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_comment
comment|/* num_compl_pkts */
end_comment

begin_comment
comment|/* Mode change event */
end_comment

begin_function
specifier|static
name|int
name|mode_change
parameter_list|(
name|ng_hci_unit_p
name|unit
parameter_list|,
name|struct
name|mbuf
modifier|*
name|event
parameter_list|)
block|{
name|ng_hci_mode_change_ep
modifier|*
name|ep
init|=
name|NULL
decl_stmt|;
name|ng_hci_unit_con_p
name|con
init|=
name|NULL
decl_stmt|;
name|int
name|error
init|=
literal|0
decl_stmt|;
name|NG_HCI_M_PULLUP
argument_list|(
name|event
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|ep
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|event
operator|==
name|NULL
condition|)
return|return
operator|(
name|ENOBUFS
operator|)
return|;
name|ep
operator|=
name|mtod
argument_list|(
name|event
argument_list|,
name|ng_hci_mode_change_ep
operator|*
argument_list|)
expr_stmt|;
if|if
condition|(
name|ep
operator|->
name|status
operator|==
literal|0
condition|)
block|{
name|u_int16_t
name|h
init|=
name|NG_HCI_CON_HANDLE
argument_list|(
name|le16toh
argument_list|(
name|ep
operator|->
name|con_handle
argument_list|)
argument_list|)
decl_stmt|;
name|con
operator|=
name|ng_hci_con_by_handle
argument_list|(
name|unit
argument_list|,
name|h
argument_list|)
expr_stmt|;
if|if
condition|(
name|con
operator|==
name|NULL
condition|)
block|{
name|NG_HCI_ALERT
argument_list|(
literal|"%s: %s - invalid connection handle=%d\n"
argument_list|,
name|__func__
argument_list|,
name|NG_NODE_NAME
argument_list|(
name|unit
operator|->
name|node
argument_list|)
argument_list|,
name|h
argument_list|)
expr_stmt|;
name|error
operator|=
name|ENOENT
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|con
operator|->
name|link_type
operator|!=
name|NG_HCI_LINK_ACL
condition|)
block|{
name|NG_HCI_ALERT
argument_list|(
literal|"%s: %s - invalid link type=%d\n"
argument_list|,
name|__func__
argument_list|,
name|NG_NODE_NAME
argument_list|(
name|unit
operator|->
name|node
argument_list|)
argument_list|,
name|con
operator|->
name|link_type
argument_list|)
expr_stmt|;
name|error
operator|=
name|EINVAL
expr_stmt|;
block|}
else|else
name|con
operator|->
name|mode
operator|=
name|ep
operator|->
name|unit_mode
expr_stmt|;
block|}
else|else
name|NG_HCI_ERR
argument_list|(
literal|"%s: %s - failed to change mode, status=%d\n"
argument_list|,
name|__func__
argument_list|,
name|NG_NODE_NAME
argument_list|(
name|unit
operator|->
name|node
argument_list|)
argument_list|,
name|ep
operator|->
name|status
argument_list|)
expr_stmt|;
name|NG_FREE_M
argument_list|(
name|event
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
end_function

begin_comment
comment|/* mode_change */
end_comment

begin_comment
comment|/* Data buffer overflow event */
end_comment

begin_function
specifier|static
name|int
name|data_buffer_overflow
parameter_list|(
name|ng_hci_unit_p
name|unit
parameter_list|,
name|struct
name|mbuf
modifier|*
name|event
parameter_list|)
block|{
name|NG_HCI_ALERT
argument_list|(
literal|"%s: %s - %s data buffer overflow\n"
argument_list|,
name|__func__
argument_list|,
name|NG_NODE_NAME
argument_list|(
name|unit
operator|->
name|node
argument_list|)
argument_list|,
operator|(
operator|*
name|mtod
argument_list|(
name|event
argument_list|,
name|u_int8_t
operator|*
argument_list|)
operator|==
name|NG_HCI_LINK_ACL
operator|)
condition|?
literal|"ACL"
else|:
literal|"SCO"
argument_list|)
expr_stmt|;
name|NG_FREE_M
argument_list|(
name|event
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_comment
comment|/* data_buffer_overflow */
end_comment

begin_comment
comment|/* Read clock offset complete event */
end_comment

begin_function
specifier|static
name|int
name|read_clock_offset_compl
parameter_list|(
name|ng_hci_unit_p
name|unit
parameter_list|,
name|struct
name|mbuf
modifier|*
name|event
parameter_list|)
block|{
name|ng_hci_read_clock_offset_compl_ep
modifier|*
name|ep
init|=
name|NULL
decl_stmt|;
name|ng_hci_unit_con_p
name|con
init|=
name|NULL
decl_stmt|;
name|ng_hci_neighbor_p
name|n
init|=
name|NULL
decl_stmt|;
name|int
name|error
init|=
literal|0
decl_stmt|;
name|NG_HCI_M_PULLUP
argument_list|(
name|event
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|ep
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|event
operator|==
name|NULL
condition|)
return|return
operator|(
name|ENOBUFS
operator|)
return|;
name|ep
operator|=
name|mtod
argument_list|(
name|event
argument_list|,
name|ng_hci_read_clock_offset_compl_ep
operator|*
argument_list|)
expr_stmt|;
if|if
condition|(
name|ep
operator|->
name|status
operator|==
literal|0
condition|)
block|{
name|u_int16_t
name|h
init|=
name|NG_HCI_CON_HANDLE
argument_list|(
name|le16toh
argument_list|(
name|ep
operator|->
name|con_handle
argument_list|)
argument_list|)
decl_stmt|;
name|con
operator|=
name|ng_hci_con_by_handle
argument_list|(
name|unit
argument_list|,
name|h
argument_list|)
expr_stmt|;
if|if
condition|(
name|con
operator|==
name|NULL
condition|)
block|{
name|NG_HCI_ALERT
argument_list|(
literal|"%s: %s - invalid connection handle=%d\n"
argument_list|,
name|__func__
argument_list|,
name|NG_NODE_NAME
argument_list|(
name|unit
operator|->
name|node
argument_list|)
argument_list|,
name|h
argument_list|)
expr_stmt|;
name|error
operator|=
name|ENOENT
expr_stmt|;
goto|goto
name|out
goto|;
block|}
comment|/* Update cache entry */
name|n
operator|=
name|ng_hci_get_neighbor
argument_list|(
name|unit
argument_list|,
operator|&
name|con
operator|->
name|bdaddr
argument_list|)
expr_stmt|;
if|if
condition|(
name|n
operator|==
name|NULL
condition|)
block|{
name|n
operator|=
name|ng_hci_new_neighbor
argument_list|(
name|unit
argument_list|)
expr_stmt|;
if|if
condition|(
name|n
operator|==
name|NULL
condition|)
block|{
name|error
operator|=
name|ENOMEM
expr_stmt|;
goto|goto
name|out
goto|;
block|}
name|bcopy
argument_list|(
operator|&
name|con
operator|->
name|bdaddr
argument_list|,
operator|&
name|n
operator|->
name|bdaddr
argument_list|,
sizeof|sizeof
argument_list|(
name|n
operator|->
name|bdaddr
argument_list|)
argument_list|)
expr_stmt|;
block|}
else|else
name|getmicrotime
argument_list|(
operator|&
name|n
operator|->
name|updated
argument_list|)
expr_stmt|;
name|n
operator|->
name|clock_offset
operator|=
name|le16toh
argument_list|(
name|ep
operator|->
name|clock_offset
argument_list|)
expr_stmt|;
block|}
else|else
name|NG_HCI_ERR
argument_list|(
literal|"%s: %s - failed to Read Remote Clock Offset, status=%d\n"
argument_list|,
name|__func__
argument_list|,
name|NG_NODE_NAME
argument_list|(
name|unit
operator|->
name|node
argument_list|)
argument_list|,
name|ep
operator|->
name|status
argument_list|)
expr_stmt|;
name|out
label|:
name|NG_FREE_M
argument_list|(
name|event
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
end_function

begin_comment
comment|/* read_clock_offset_compl */
end_comment

begin_comment
comment|/* QoS violation event */
end_comment

begin_function
specifier|static
name|int
name|qos_violation
parameter_list|(
name|ng_hci_unit_p
name|unit
parameter_list|,
name|struct
name|mbuf
modifier|*
name|event
parameter_list|)
block|{
name|ng_hci_qos_violation_ep
modifier|*
name|ep
init|=
name|NULL
decl_stmt|;
name|ng_hci_unit_con_p
name|con
init|=
name|NULL
decl_stmt|;
name|u_int16_t
name|h
decl_stmt|;
name|int
name|error
init|=
literal|0
decl_stmt|;
name|NG_HCI_M_PULLUP
argument_list|(
name|event
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|ep
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|event
operator|==
name|NULL
condition|)
return|return
operator|(
name|ENOBUFS
operator|)
return|;
name|ep
operator|=
name|mtod
argument_list|(
name|event
argument_list|,
name|ng_hci_qos_violation_ep
operator|*
argument_list|)
expr_stmt|;
comment|/* Check if we have this connection handle */
name|h
operator|=
name|NG_HCI_CON_HANDLE
argument_list|(
name|le16toh
argument_list|(
name|ep
operator|->
name|con_handle
argument_list|)
argument_list|)
expr_stmt|;
name|con
operator|=
name|ng_hci_con_by_handle
argument_list|(
name|unit
argument_list|,
name|h
argument_list|)
expr_stmt|;
if|if
condition|(
name|con
operator|==
name|NULL
condition|)
block|{
name|NG_HCI_ALERT
argument_list|(
literal|"%s: %s - invalid connection handle=%d\n"
argument_list|,
name|__func__
argument_list|,
name|NG_NODE_NAME
argument_list|(
name|unit
operator|->
name|node
argument_list|)
argument_list|,
name|h
argument_list|)
expr_stmt|;
name|error
operator|=
name|ENOENT
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|con
operator|->
name|link_type
operator|!=
name|NG_HCI_LINK_ACL
condition|)
block|{
name|NG_HCI_ALERT
argument_list|(
literal|"%s: %s - invalid link type=%d\n"
argument_list|,
name|__func__
argument_list|,
name|NG_NODE_NAME
argument_list|(
name|unit
operator|->
name|node
argument_list|)
argument_list|,
name|con
operator|->
name|link_type
argument_list|)
expr_stmt|;
name|error
operator|=
name|EINVAL
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|con
operator|->
name|state
operator|!=
name|NG_HCI_CON_OPEN
condition|)
block|{
name|NG_HCI_ALERT
argument_list|(
literal|"%s: %s - invalid connection state=%d, handle=%d\n"
argument_list|,
name|__func__
argument_list|,
name|NG_NODE_NAME
argument_list|(
name|unit
operator|->
name|node
argument_list|)
argument_list|,
name|con
operator|->
name|state
argument_list|,
name|h
argument_list|)
expr_stmt|;
name|error
operator|=
name|EINVAL
expr_stmt|;
block|}
else|else
comment|/* Notify upper layer */
name|error
operator|=
name|ng_hci_lp_qos_ind
argument_list|(
name|con
argument_list|)
expr_stmt|;
name|NG_FREE_M
argument_list|(
name|event
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
end_function

begin_comment
comment|/* qos_violation */
end_comment

begin_comment
comment|/* Page scan mode change event */
end_comment

begin_function
specifier|static
name|int
name|page_scan_mode_change
parameter_list|(
name|ng_hci_unit_p
name|unit
parameter_list|,
name|struct
name|mbuf
modifier|*
name|event
parameter_list|)
block|{
name|ng_hci_page_scan_mode_change_ep
modifier|*
name|ep
init|=
name|NULL
decl_stmt|;
name|ng_hci_neighbor_p
name|n
init|=
name|NULL
decl_stmt|;
name|int
name|error
init|=
literal|0
decl_stmt|;
name|NG_HCI_M_PULLUP
argument_list|(
name|event
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|ep
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|event
operator|==
name|NULL
condition|)
return|return
operator|(
name|ENOBUFS
operator|)
return|;
name|ep
operator|=
name|mtod
argument_list|(
name|event
argument_list|,
name|ng_hci_page_scan_mode_change_ep
operator|*
argument_list|)
expr_stmt|;
comment|/* Update cache entry */
name|n
operator|=
name|ng_hci_get_neighbor
argument_list|(
name|unit
argument_list|,
operator|&
name|ep
operator|->
name|bdaddr
argument_list|)
expr_stmt|;
if|if
condition|(
name|n
operator|==
name|NULL
condition|)
block|{
name|n
operator|=
name|ng_hci_new_neighbor
argument_list|(
name|unit
argument_list|)
expr_stmt|;
if|if
condition|(
name|n
operator|==
name|NULL
condition|)
block|{
name|error
operator|=
name|ENOMEM
expr_stmt|;
goto|goto
name|out
goto|;
block|}
name|bcopy
argument_list|(
operator|&
name|ep
operator|->
name|bdaddr
argument_list|,
operator|&
name|n
operator|->
name|bdaddr
argument_list|,
sizeof|sizeof
argument_list|(
name|n
operator|->
name|bdaddr
argument_list|)
argument_list|)
expr_stmt|;
block|}
else|else
name|getmicrotime
argument_list|(
operator|&
name|n
operator|->
name|updated
argument_list|)
expr_stmt|;
name|n
operator|->
name|page_scan_mode
operator|=
name|ep
operator|->
name|page_scan_mode
expr_stmt|;
name|out
label|:
name|NG_FREE_M
argument_list|(
name|event
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
end_function

begin_comment
comment|/* page_scan_mode_change */
end_comment

begin_comment
comment|/* Page scan repetition mode change event */
end_comment

begin_function
specifier|static
name|int
name|page_scan_rep_mode_change
parameter_list|(
name|ng_hci_unit_p
name|unit
parameter_list|,
name|struct
name|mbuf
modifier|*
name|event
parameter_list|)
block|{
name|ng_hci_page_scan_rep_mode_change_ep
modifier|*
name|ep
init|=
name|NULL
decl_stmt|;
name|ng_hci_neighbor_p
name|n
init|=
name|NULL
decl_stmt|;
name|int
name|error
init|=
literal|0
decl_stmt|;
name|NG_HCI_M_PULLUP
argument_list|(
name|event
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|ep
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|event
operator|==
name|NULL
condition|)
return|return
operator|(
name|ENOBUFS
operator|)
return|;
name|ep
operator|=
name|mtod
argument_list|(
name|event
argument_list|,
name|ng_hci_page_scan_rep_mode_change_ep
operator|*
argument_list|)
expr_stmt|;
comment|/* Update cache entry */
name|n
operator|=
name|ng_hci_get_neighbor
argument_list|(
name|unit
argument_list|,
operator|&
name|ep
operator|->
name|bdaddr
argument_list|)
expr_stmt|;
if|if
condition|(
name|n
operator|==
name|NULL
condition|)
block|{
name|n
operator|=
name|ng_hci_new_neighbor
argument_list|(
name|unit
argument_list|)
expr_stmt|;
if|if
condition|(
name|n
operator|==
name|NULL
condition|)
block|{
name|error
operator|=
name|ENOMEM
expr_stmt|;
goto|goto
name|out
goto|;
block|}
name|bcopy
argument_list|(
operator|&
name|ep
operator|->
name|bdaddr
argument_list|,
operator|&
name|n
operator|->
name|bdaddr
argument_list|,
sizeof|sizeof
argument_list|(
name|n
operator|->
name|bdaddr
argument_list|)
argument_list|)
expr_stmt|;
block|}
else|else
name|getmicrotime
argument_list|(
operator|&
name|n
operator|->
name|updated
argument_list|)
expr_stmt|;
name|n
operator|->
name|page_scan_rep_mode
operator|=
name|ep
operator|->
name|page_scan_rep_mode
expr_stmt|;
name|out
label|:
name|NG_FREE_M
argument_list|(
name|event
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
end_function

begin_comment
comment|/* page_scan_rep_mode_change */
end_comment

end_unit


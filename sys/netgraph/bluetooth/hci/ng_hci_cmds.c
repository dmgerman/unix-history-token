begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * ng_hci_cmds.c  */
end_comment

begin_comment
comment|/*-  * Copyright (c) Maksim Yevmenkin<m_evmenkin@yahoo.com>  * All rights reserved.  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions  * are met:  * 1. Redistributions of source code must retain the above copyright  *    notice, this list of conditions and the following disclaimer.  * 2. Redistributions in binary form must reproduce the above copyright  *    notice, this list of conditions and the following disclaimer in the  *    documentation and/or other materials provided with the distribution.  *  * THIS SOFTWARE IS PROVIDED BY THE AUTHOR AND CONTRIBUTORS ``AS IS'' AND  * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE  * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE  * ARE DISCLAIMED. IN NO EVENT SHALL THE AUTHOR OR CONTRIBUTORS BE LIABLE  * FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL  * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS  * OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)  * HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT  * LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY  * OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF  * SUCH DAMAGE.  *  * $Id: ng_hci_cmds.c,v 1.4 2003/09/08 18:57:51 max Exp $  * $FreeBSD$  */
end_comment

begin_include
include|#
directive|include
file|<sys/param.h>
end_include

begin_include
include|#
directive|include
file|<sys/systm.h>
end_include

begin_include
include|#
directive|include
file|<sys/kernel.h>
end_include

begin_include
include|#
directive|include
file|<sys/endian.h>
end_include

begin_include
include|#
directive|include
file|<sys/malloc.h>
end_include

begin_include
include|#
directive|include
file|<sys/mbuf.h>
end_include

begin_include
include|#
directive|include
file|<sys/queue.h>
end_include

begin_include
include|#
directive|include
file|<netgraph/ng_message.h>
end_include

begin_include
include|#
directive|include
file|<netgraph/netgraph.h>
end_include

begin_include
include|#
directive|include
file|<netgraph/bluetooth/include/ng_bluetooth.h>
end_include

begin_include
include|#
directive|include
file|<netgraph/bluetooth/include/ng_hci.h>
end_include

begin_include
include|#
directive|include
file|<netgraph/bluetooth/hci/ng_hci_var.h>
end_include

begin_include
include|#
directive|include
file|<netgraph/bluetooth/hci/ng_hci_cmds.h>
end_include

begin_include
include|#
directive|include
file|<netgraph/bluetooth/hci/ng_hci_evnt.h>
end_include

begin_include
include|#
directive|include
file|<netgraph/bluetooth/hci/ng_hci_ulpi.h>
end_include

begin_include
include|#
directive|include
file|<netgraph/bluetooth/hci/ng_hci_misc.h>
end_include

begin_comment
comment|/******************************************************************************  ******************************************************************************  **                     HCI commands processing module  ******************************************************************************  ******************************************************************************/
end_comment

begin_undef
undef|#
directive|undef
name|min
end_undef

begin_define
define|#
directive|define
name|min
parameter_list|(
name|a
parameter_list|,
name|b
parameter_list|)
value|((a)< (b))? (a) : (b)
end_define

begin_function_decl
specifier|static
name|int
name|complete_command
parameter_list|(
name|ng_hci_unit_p
parameter_list|,
name|int
parameter_list|,
name|struct
name|mbuf
modifier|*
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|process_link_control_params
parameter_list|(
name|ng_hci_unit_p
parameter_list|,
name|u_int16_t
parameter_list|,
name|struct
name|mbuf
modifier|*
parameter_list|,
name|struct
name|mbuf
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|process_link_policy_params
parameter_list|(
name|ng_hci_unit_p
parameter_list|,
name|u_int16_t
parameter_list|,
name|struct
name|mbuf
modifier|*
parameter_list|,
name|struct
name|mbuf
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|process_hc_baseband_params
parameter_list|(
name|ng_hci_unit_p
parameter_list|,
name|u_int16_t
parameter_list|,
name|struct
name|mbuf
modifier|*
parameter_list|,
name|struct
name|mbuf
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|process_info_params
parameter_list|(
name|ng_hci_unit_p
parameter_list|,
name|u_int16_t
parameter_list|,
name|struct
name|mbuf
modifier|*
parameter_list|,
name|struct
name|mbuf
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|process_status_params
parameter_list|(
name|ng_hci_unit_p
parameter_list|,
name|u_int16_t
parameter_list|,
name|struct
name|mbuf
modifier|*
parameter_list|,
name|struct
name|mbuf
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|process_testing_params
parameter_list|(
name|ng_hci_unit_p
parameter_list|,
name|u_int16_t
parameter_list|,
name|struct
name|mbuf
modifier|*
parameter_list|,
name|struct
name|mbuf
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|process_link_control_status
parameter_list|(
name|ng_hci_unit_p
parameter_list|,
name|ng_hci_command_status_ep
modifier|*
parameter_list|,
name|struct
name|mbuf
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|process_link_policy_status
parameter_list|(
name|ng_hci_unit_p
parameter_list|,
name|ng_hci_command_status_ep
modifier|*
parameter_list|,
name|struct
name|mbuf
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_comment
comment|/*  * Send HCI command to the driver.  */
end_comment

begin_function
name|int
name|ng_hci_send_command
parameter_list|(
name|ng_hci_unit_p
name|unit
parameter_list|)
block|{
name|struct
name|mbuf
modifier|*
name|m0
init|=
name|NULL
decl_stmt|,
modifier|*
name|m
init|=
name|NULL
decl_stmt|;
name|int
name|free
decl_stmt|,
name|error
init|=
literal|0
decl_stmt|;
comment|/* Check if other command is pending */
if|if
condition|(
name|unit
operator|->
name|state
operator|&
name|NG_HCI_UNIT_COMMAND_PENDING
condition|)
return|return
operator|(
literal|0
operator|)
return|;
comment|/* Check if unit can accept our command */
name|NG_HCI_BUFF_CMD_GET
argument_list|(
name|unit
operator|->
name|buffer
argument_list|,
name|free
argument_list|)
expr_stmt|;
if|if
condition|(
name|free
operator|==
literal|0
condition|)
return|return
operator|(
literal|0
operator|)
return|;
comment|/* Check if driver hook is still ok */
if|if
condition|(
name|unit
operator|->
name|drv
operator|==
name|NULL
operator|||
name|NG_HOOK_NOT_VALID
argument_list|(
name|unit
operator|->
name|drv
argument_list|)
condition|)
block|{
name|NG_HCI_WARN
argument_list|(
literal|"%s: %s - hook \"%s\" is not connected or valid\n"
argument_list|,
name|__func__
argument_list|,
name|NG_NODE_NAME
argument_list|(
name|unit
operator|->
name|node
argument_list|)
argument_list|,
name|NG_HCI_HOOK_DRV
argument_list|)
expr_stmt|;
name|NG_BT_MBUFQ_DRAIN
argument_list|(
operator|&
name|unit
operator|->
name|cmdq
argument_list|)
expr_stmt|;
return|return
operator|(
name|ENOTCONN
operator|)
return|;
block|}
comment|/*  	 * Get first command from queue, give it to RAW hook then  	 * make copy of it and send it to the driver 	 */
name|m0
operator|=
name|NG_BT_MBUFQ_FIRST
argument_list|(
operator|&
name|unit
operator|->
name|cmdq
argument_list|)
expr_stmt|;
if|if
condition|(
name|m0
operator|==
name|NULL
condition|)
return|return
operator|(
literal|0
operator|)
return|;
name|ng_hci_mtap
argument_list|(
name|unit
argument_list|,
name|m0
argument_list|)
expr_stmt|;
name|m
operator|=
name|m_dup
argument_list|(
name|m0
argument_list|,
name|M_DONTWAIT
argument_list|)
expr_stmt|;
if|if
condition|(
name|m
operator|!=
name|NULL
condition|)
name|NG_SEND_DATA_ONLY
argument_list|(
name|error
argument_list|,
name|unit
operator|->
name|drv
argument_list|,
name|m
argument_list|)
expr_stmt|;
else|else
name|error
operator|=
name|ENOBUFS
expr_stmt|;
if|if
condition|(
name|error
operator|!=
literal|0
condition|)
name|NG_HCI_ERR
argument_list|(
literal|"%s: %s - could not send HCI command, error=%d\n"
argument_list|,
name|__func__
argument_list|,
name|NG_NODE_NAME
argument_list|(
name|unit
operator|->
name|node
argument_list|)
argument_list|,
name|error
argument_list|)
expr_stmt|;
comment|/* 	 * Even if we were not able to send command we still pretend 	 * that everything is OK and let timeout handle that. 	 */
name|NG_HCI_BUFF_CMD_USE
argument_list|(
name|unit
operator|->
name|buffer
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|NG_HCI_STAT_CMD_SENT
argument_list|(
name|unit
operator|->
name|stat
argument_list|)
expr_stmt|;
name|NG_HCI_STAT_BYTES_SENT
argument_list|(
name|unit
operator|->
name|stat
argument_list|,
name|m0
operator|->
name|m_pkthdr
operator|.
name|len
argument_list|)
expr_stmt|;
comment|/* 	 * Note: ng_hci_command_timeout() will set  	 * NG_HCI_UNIT_COMMAND_PENDING flag 	 */
name|ng_hci_command_timeout
argument_list|(
name|unit
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_comment
comment|/* ng_hci_send_command */
end_comment

begin_comment
comment|/*  * Process HCI Command_Compete event. Complete HCI command, and do post   * processing on the command parameters (cp) and command return parameters  * (e) if required (for example adjust state).  */
end_comment

begin_function
name|int
name|ng_hci_process_command_complete
parameter_list|(
name|ng_hci_unit_p
name|unit
parameter_list|,
name|struct
name|mbuf
modifier|*
name|e
parameter_list|)
block|{
name|ng_hci_command_compl_ep
modifier|*
name|ep
init|=
name|NULL
decl_stmt|;
name|struct
name|mbuf
modifier|*
name|cp
init|=
name|NULL
decl_stmt|;
name|int
name|error
init|=
literal|0
decl_stmt|;
comment|/* Get event packet and update command buffer info */
name|NG_HCI_M_PULLUP
argument_list|(
name|e
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|ep
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|e
operator|==
name|NULL
condition|)
return|return
operator|(
name|ENOBUFS
operator|)
return|;
comment|/* XXX this is bad */
name|ep
operator|=
name|mtod
argument_list|(
name|e
argument_list|,
name|ng_hci_command_compl_ep
operator|*
argument_list|)
expr_stmt|;
name|NG_HCI_BUFF_CMD_SET
argument_list|(
name|unit
operator|->
name|buffer
argument_list|,
name|ep
operator|->
name|num_cmd_pkts
argument_list|)
expr_stmt|;
comment|/* Check for special NOOP command */
if|if
condition|(
name|ep
operator|->
name|opcode
operator|==
literal|0x0000
condition|)
block|{
name|NG_FREE_M
argument_list|(
name|e
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
comment|/* Try to match first command item in the queue */
name|error
operator|=
name|complete_command
argument_list|(
name|unit
argument_list|,
name|ep
operator|->
name|opcode
argument_list|,
operator|&
name|cp
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|!=
literal|0
condition|)
block|{
name|NG_FREE_M
argument_list|(
name|e
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
comment|/*  	 * Perform post processing on command parameters and return parameters 	 * do it only if status is OK (status == 0). Status is the first byte 	 * of any command return parameters. 	 */
name|ep
operator|->
name|opcode
operator|=
name|le16toh
argument_list|(
name|ep
operator|->
name|opcode
argument_list|)
expr_stmt|;
name|m_adj
argument_list|(
name|e
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|ep
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|*
name|mtod
argument_list|(
name|e
argument_list|,
name|u_int8_t
operator|*
argument_list|)
operator|==
literal|0
condition|)
block|{
comment|/* XXX m_pullup here? */
switch|switch
condition|(
name|NG_HCI_OGF
argument_list|(
name|ep
operator|->
name|opcode
argument_list|)
condition|)
block|{
case|case
name|NG_HCI_OGF_LINK_CONTROL
case|:
name|error
operator|=
name|process_link_control_params
argument_list|(
name|unit
argument_list|,
name|NG_HCI_OCF
argument_list|(
name|ep
operator|->
name|opcode
argument_list|)
argument_list|,
name|cp
argument_list|,
name|e
argument_list|)
expr_stmt|;
break|break;
case|case
name|NG_HCI_OGF_LINK_POLICY
case|:
name|error
operator|=
name|process_link_policy_params
argument_list|(
name|unit
argument_list|,
name|NG_HCI_OCF
argument_list|(
name|ep
operator|->
name|opcode
argument_list|)
argument_list|,
name|cp
argument_list|,
name|e
argument_list|)
expr_stmt|;
break|break;
case|case
name|NG_HCI_OGF_HC_BASEBAND
case|:
name|error
operator|=
name|process_hc_baseband_params
argument_list|(
name|unit
argument_list|,
name|NG_HCI_OCF
argument_list|(
name|ep
operator|->
name|opcode
argument_list|)
argument_list|,
name|cp
argument_list|,
name|e
argument_list|)
expr_stmt|;
break|break;
case|case
name|NG_HCI_OGF_INFO
case|:
name|error
operator|=
name|process_info_params
argument_list|(
name|unit
argument_list|,
name|NG_HCI_OCF
argument_list|(
name|ep
operator|->
name|opcode
argument_list|)
argument_list|,
name|cp
argument_list|,
name|e
argument_list|)
expr_stmt|;
break|break;
case|case
name|NG_HCI_OGF_STATUS
case|:
name|error
operator|=
name|process_status_params
argument_list|(
name|unit
argument_list|,
name|NG_HCI_OCF
argument_list|(
name|ep
operator|->
name|opcode
argument_list|)
argument_list|,
name|cp
argument_list|,
name|e
argument_list|)
expr_stmt|;
break|break;
case|case
name|NG_HCI_OGF_TESTING
case|:
name|error
operator|=
name|process_testing_params
argument_list|(
name|unit
argument_list|,
name|NG_HCI_OCF
argument_list|(
name|ep
operator|->
name|opcode
argument_list|)
argument_list|,
name|cp
argument_list|,
name|e
argument_list|)
expr_stmt|;
break|break;
case|case
name|NG_HCI_OGF_BT_LOGO
case|:
case|case
name|NG_HCI_OGF_VENDOR
case|:
name|NG_FREE_M
argument_list|(
name|cp
argument_list|)
expr_stmt|;
name|NG_FREE_M
argument_list|(
name|e
argument_list|)
expr_stmt|;
break|break;
default|default:
name|NG_FREE_M
argument_list|(
name|cp
argument_list|)
expr_stmt|;
name|NG_FREE_M
argument_list|(
name|e
argument_list|)
expr_stmt|;
name|error
operator|=
name|EINVAL
expr_stmt|;
break|break;
block|}
block|}
else|else
block|{
name|NG_HCI_ERR
argument_list|(
literal|"%s: %s - HCI command failed, OGF=%#x, OCF=%#x, status=%#x\n"
argument_list|,
name|__func__
argument_list|,
name|NG_NODE_NAME
argument_list|(
name|unit
operator|->
name|node
argument_list|)
argument_list|,
name|NG_HCI_OGF
argument_list|(
name|ep
operator|->
name|opcode
argument_list|)
argument_list|,
name|NG_HCI_OCF
argument_list|(
name|ep
operator|->
name|opcode
argument_list|)
argument_list|,
operator|*
name|mtod
argument_list|(
name|e
argument_list|,
name|u_int8_t
operator|*
argument_list|)
argument_list|)
expr_stmt|;
name|NG_FREE_M
argument_list|(
name|cp
argument_list|)
expr_stmt|;
name|NG_FREE_M
argument_list|(
name|e
argument_list|)
expr_stmt|;
block|}
name|out
label|:
name|ng_hci_send_command
argument_list|(
name|unit
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
end_function

begin_comment
comment|/* ng_hci_process_command_complete */
end_comment

begin_comment
comment|/*  * Process HCI Command_Status event. Check the status (mst) and do post   * processing (if required).  */
end_comment

begin_function
name|int
name|ng_hci_process_command_status
parameter_list|(
name|ng_hci_unit_p
name|unit
parameter_list|,
name|struct
name|mbuf
modifier|*
name|e
parameter_list|)
block|{
name|ng_hci_command_status_ep
modifier|*
name|ep
init|=
name|NULL
decl_stmt|;
name|struct
name|mbuf
modifier|*
name|cp
init|=
name|NULL
decl_stmt|;
name|int
name|error
init|=
literal|0
decl_stmt|;
comment|/* Update command buffer info */
name|NG_HCI_M_PULLUP
argument_list|(
name|e
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|ep
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|e
operator|==
name|NULL
condition|)
return|return
operator|(
name|ENOBUFS
operator|)
return|;
comment|/* XXX this is bad */
name|ep
operator|=
name|mtod
argument_list|(
name|e
argument_list|,
name|ng_hci_command_status_ep
operator|*
argument_list|)
expr_stmt|;
name|NG_HCI_BUFF_CMD_SET
argument_list|(
name|unit
operator|->
name|buffer
argument_list|,
name|ep
operator|->
name|num_cmd_pkts
argument_list|)
expr_stmt|;
comment|/* Check for special NOOP command */
if|if
condition|(
name|ep
operator|->
name|opcode
operator|==
literal|0x0000
condition|)
goto|goto
name|out
goto|;
comment|/* Try to match first command item in the queue */
name|error
operator|=
name|complete_command
argument_list|(
name|unit
argument_list|,
name|ep
operator|->
name|opcode
argument_list|,
operator|&
name|cp
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|!=
literal|0
condition|)
goto|goto
name|out
goto|;
comment|/*  	 * Perform post processing on HCI Command_Status event 	 */
name|ep
operator|->
name|opcode
operator|=
name|le16toh
argument_list|(
name|ep
operator|->
name|opcode
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|NG_HCI_OGF
argument_list|(
name|ep
operator|->
name|opcode
argument_list|)
condition|)
block|{
case|case
name|NG_HCI_OGF_LINK_CONTROL
case|:
name|error
operator|=
name|process_link_control_status
argument_list|(
name|unit
argument_list|,
name|ep
argument_list|,
name|cp
argument_list|)
expr_stmt|;
break|break;
case|case
name|NG_HCI_OGF_LINK_POLICY
case|:
name|error
operator|=
name|process_link_policy_status
argument_list|(
name|unit
argument_list|,
name|ep
argument_list|,
name|cp
argument_list|)
expr_stmt|;
break|break;
case|case
name|NG_HCI_OGF_BT_LOGO
case|:
case|case
name|NG_HCI_OGF_VENDOR
case|:
name|NG_FREE_M
argument_list|(
name|cp
argument_list|)
expr_stmt|;
break|break;
case|case
name|NG_HCI_OGF_HC_BASEBAND
case|:
case|case
name|NG_HCI_OGF_INFO
case|:
case|case
name|NG_HCI_OGF_STATUS
case|:
case|case
name|NG_HCI_OGF_TESTING
case|:
default|default:
name|NG_FREE_M
argument_list|(
name|cp
argument_list|)
expr_stmt|;
name|error
operator|=
name|EINVAL
expr_stmt|;
break|break;
block|}
name|out
label|:
name|NG_FREE_M
argument_list|(
name|e
argument_list|)
expr_stmt|;
name|ng_hci_send_command
argument_list|(
name|unit
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
end_function

begin_comment
comment|/* ng_hci_process_command_status */
end_comment

begin_comment
comment|/*  * Complete queued HCI command.   */
end_comment

begin_function
specifier|static
name|int
name|complete_command
parameter_list|(
name|ng_hci_unit_p
name|unit
parameter_list|,
name|int
name|opcode
parameter_list|,
name|struct
name|mbuf
modifier|*
modifier|*
name|cp
parameter_list|)
block|{
name|struct
name|mbuf
modifier|*
name|m
init|=
name|NULL
decl_stmt|;
comment|/* Check unit state */
if|if
condition|(
operator|!
operator|(
name|unit
operator|->
name|state
operator|&
name|NG_HCI_UNIT_COMMAND_PENDING
operator|)
condition|)
block|{
name|NG_HCI_ALERT
argument_list|(
literal|"%s: %s - no pending command, state=%#x\n"
argument_list|,
name|__func__
argument_list|,
name|NG_NODE_NAME
argument_list|(
name|unit
operator|->
name|node
argument_list|)
argument_list|,
name|unit
operator|->
name|state
argument_list|)
expr_stmt|;
return|return
operator|(
name|EINVAL
operator|)
return|;
block|}
comment|/* Get first command in the queue */
name|m
operator|=
name|NG_BT_MBUFQ_FIRST
argument_list|(
operator|&
name|unit
operator|->
name|cmdq
argument_list|)
expr_stmt|;
if|if
condition|(
name|m
operator|==
name|NULL
condition|)
block|{
name|NG_HCI_ALERT
argument_list|(
literal|"%s: %s - empty command queue?!\n"
argument_list|,
name|__func__
argument_list|,
name|NG_NODE_NAME
argument_list|(
name|unit
operator|->
name|node
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|(
name|EINVAL
operator|)
return|;
block|}
comment|/* 	 * Match command opcode, if does not match - do nothing and  	 * let timeout handle that. 	 */
if|if
condition|(
name|mtod
argument_list|(
name|m
argument_list|,
name|ng_hci_cmd_pkt_t
operator|*
argument_list|)
operator|->
name|opcode
operator|!=
name|opcode
condition|)
block|{
name|NG_HCI_ALERT
argument_list|(
literal|"%s: %s - command queue is out of sync\n"
argument_list|,
name|__func__
argument_list|,
name|NG_NODE_NAME
argument_list|(
name|unit
operator|->
name|node
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|(
name|EINVAL
operator|)
return|;
block|}
comment|/*  	 * Now we can remove command timeout, dequeue completed command 	 * and return command parameters. ng_hci_command_untimeout will 	 * drop NG_HCI_UNIT_COMMAND_PENDING flag. 	 * Note: if ng_hci_command_untimeout() fails (returns non-zero) 	 * then timeout aready happened and timeout message went info node 	 * queue. In this case we ignore command completion and pretend 	 * there is a timeout. 	 */
if|if
condition|(
name|ng_hci_command_untimeout
argument_list|(
name|unit
argument_list|)
operator|!=
literal|0
condition|)
return|return
operator|(
name|ETIMEDOUT
operator|)
return|;
name|NG_BT_MBUFQ_DEQUEUE
argument_list|(
operator|&
name|unit
operator|->
name|cmdq
argument_list|,
operator|*
name|cp
argument_list|)
expr_stmt|;
name|m_adj
argument_list|(
operator|*
name|cp
argument_list|,
sizeof|sizeof
argument_list|(
name|ng_hci_cmd_pkt_t
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_comment
comment|/* complete_command */
end_comment

begin_comment
comment|/*  * Process HCI command timeout  */
end_comment

begin_function
name|void
name|ng_hci_process_command_timeout
parameter_list|(
name|node_p
name|node
parameter_list|,
name|hook_p
name|hook
parameter_list|,
name|void
modifier|*
name|arg1
parameter_list|,
name|int
name|arg2
parameter_list|)
block|{
name|ng_hci_unit_p
name|unit
init|=
name|NULL
decl_stmt|;
name|struct
name|mbuf
modifier|*
name|m
init|=
name|NULL
decl_stmt|;
name|u_int16_t
name|opcode
decl_stmt|;
if|if
condition|(
name|NG_NODE_NOT_VALID
argument_list|(
name|node
argument_list|)
condition|)
block|{
name|printf
argument_list|(
literal|"%s: Netgraph node is not valid\n"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
return|return;
block|}
name|unit
operator|=
operator|(
name|ng_hci_unit_p
operator|)
name|NG_NODE_PRIVATE
argument_list|(
name|node
argument_list|)
expr_stmt|;
if|if
condition|(
name|unit
operator|->
name|state
operator|&
name|NG_HCI_UNIT_COMMAND_PENDING
condition|)
block|{
name|unit
operator|->
name|state
operator|&=
operator|~
name|NG_HCI_UNIT_COMMAND_PENDING
expr_stmt|;
name|NG_BT_MBUFQ_DEQUEUE
argument_list|(
operator|&
name|unit
operator|->
name|cmdq
argument_list|,
name|m
argument_list|)
expr_stmt|;
if|if
condition|(
name|m
operator|==
name|NULL
condition|)
block|{
name|NG_HCI_ALERT
argument_list|(
literal|"%s: %s - command queue is out of sync!\n"
argument_list|,
name|__func__
argument_list|,
name|NG_NODE_NAME
argument_list|(
name|unit
operator|->
name|node
argument_list|)
argument_list|)
expr_stmt|;
return|return;
block|}
name|opcode
operator|=
name|le16toh
argument_list|(
name|mtod
argument_list|(
name|m
argument_list|,
name|ng_hci_cmd_pkt_t
operator|*
argument_list|)
operator|->
name|opcode
argument_list|)
expr_stmt|;
name|NG_FREE_M
argument_list|(
name|m
argument_list|)
expr_stmt|;
name|NG_HCI_ERR
argument_list|(
literal|"%s: %s - unable to complete HCI command OGF=%#x, OCF=%#x. Timeout\n"
argument_list|,
name|__func__
argument_list|,
name|NG_NODE_NAME
argument_list|(
name|unit
operator|->
name|node
argument_list|)
argument_list|,
name|NG_HCI_OGF
argument_list|(
name|opcode
argument_list|)
argument_list|,
name|NG_HCI_OCF
argument_list|(
name|opcode
argument_list|)
argument_list|)
expr_stmt|;
comment|/* Try to send more commands */
name|NG_HCI_BUFF_CMD_SET
argument_list|(
name|unit
operator|->
name|buffer
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|ng_hci_send_command
argument_list|(
name|unit
argument_list|)
expr_stmt|;
block|}
else|else
name|NG_HCI_ALERT
argument_list|(
literal|"%s: %s - no pending command\n"
argument_list|,
name|__func__
argument_list|,
name|NG_NODE_NAME
argument_list|(
name|unit
operator|->
name|node
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* ng_hci_process_command_timeout */
end_comment

begin_comment
comment|/*   * Process link command return parameters  */
end_comment

begin_function
specifier|static
name|int
name|process_link_control_params
parameter_list|(
name|ng_hci_unit_p
name|unit
parameter_list|,
name|u_int16_t
name|ocf
parameter_list|,
name|struct
name|mbuf
modifier|*
name|mcp
parameter_list|,
name|struct
name|mbuf
modifier|*
name|mrp
parameter_list|)
block|{
name|int
name|error
init|=
literal|0
decl_stmt|;
switch|switch
condition|(
name|ocf
condition|)
block|{
case|case
name|NG_HCI_OCF_INQUIRY_CANCEL
case|:
case|case
name|NG_HCI_OCF_PERIODIC_INQUIRY
case|:
case|case
name|NG_HCI_OCF_EXIT_PERIODIC_INQUIRY
case|:
case|case
name|NG_HCI_OCF_LINK_KEY_REP
case|:
case|case
name|NG_HCI_OCF_LINK_KEY_NEG_REP
case|:
case|case
name|NG_HCI_OCF_PIN_CODE_REP
case|:
case|case
name|NG_HCI_OCF_PIN_CODE_NEG_REP
case|:
comment|/* These do not need post processing */
break|break;
case|case
name|NG_HCI_OCF_INQUIRY
case|:
case|case
name|NG_HCI_OCF_CREATE_CON
case|:
case|case
name|NG_HCI_OCF_DISCON
case|:
case|case
name|NG_HCI_OCF_ADD_SCO_CON
case|:
case|case
name|NG_HCI_OCF_ACCEPT_CON
case|:
case|case
name|NG_HCI_OCF_REJECT_CON
case|:
case|case
name|NG_HCI_OCF_CHANGE_CON_PKT_TYPE
case|:
case|case
name|NG_HCI_OCF_AUTH_REQ
case|:
case|case
name|NG_HCI_OCF_SET_CON_ENCRYPTION
case|:
case|case
name|NG_HCI_OCF_CHANGE_CON_LINK_KEY
case|:
case|case
name|NG_HCI_OCF_MASTER_LINK_KEY
case|:
case|case
name|NG_HCI_OCF_REMOTE_NAME_REQ
case|:
case|case
name|NG_HCI_OCF_READ_REMOTE_FEATURES
case|:
case|case
name|NG_HCI_OCF_READ_REMOTE_VER_INFO
case|:
case|case
name|NG_HCI_OCF_READ_CLOCK_OFFSET
case|:
default|default:
comment|/* 		 * None of these command was supposed to generate  		 * Command_Complete event. Instead Command_Status event  		 * should have been generated and then appropriate event  		 * should have been sent to indicate the final result. 		 */
name|error
operator|=
name|EINVAL
expr_stmt|;
break|break;
block|}
name|NG_FREE_M
argument_list|(
name|mcp
argument_list|)
expr_stmt|;
name|NG_FREE_M
argument_list|(
name|mrp
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
end_function

begin_comment
comment|/* process_link_control_params */
end_comment

begin_comment
comment|/*   * Process link policy command return parameters  */
end_comment

begin_function
specifier|static
name|int
name|process_link_policy_params
parameter_list|(
name|ng_hci_unit_p
name|unit
parameter_list|,
name|u_int16_t
name|ocf
parameter_list|,
name|struct
name|mbuf
modifier|*
name|mcp
parameter_list|,
name|struct
name|mbuf
modifier|*
name|mrp
parameter_list|)
block|{
name|int
name|error
init|=
literal|0
decl_stmt|;
switch|switch
condition|(
name|ocf
condition|)
block|{
case|case
name|NG_HCI_OCF_ROLE_DISCOVERY
case|:
block|{
name|ng_hci_role_discovery_rp
modifier|*
name|rp
init|=
name|NULL
decl_stmt|;
name|ng_hci_unit_con_t
modifier|*
name|con
init|=
name|NULL
decl_stmt|;
name|u_int16_t
name|h
decl_stmt|;
name|NG_HCI_M_PULLUP
argument_list|(
name|mrp
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|rp
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|mrp
operator|!=
name|NULL
condition|)
block|{
name|rp
operator|=
name|mtod
argument_list|(
name|mrp
argument_list|,
name|ng_hci_role_discovery_rp
operator|*
argument_list|)
expr_stmt|;
name|h
operator|=
name|NG_HCI_CON_HANDLE
argument_list|(
name|le16toh
argument_list|(
name|rp
operator|->
name|con_handle
argument_list|)
argument_list|)
expr_stmt|;
name|con
operator|=
name|ng_hci_con_by_handle
argument_list|(
name|unit
argument_list|,
name|h
argument_list|)
expr_stmt|;
if|if
condition|(
name|con
operator|==
name|NULL
condition|)
block|{
name|NG_HCI_ALERT
argument_list|(
literal|"%s: %s - invalid connection handle=%d\n"
argument_list|,
name|__func__
argument_list|,
name|NG_NODE_NAME
argument_list|(
name|unit
operator|->
name|node
argument_list|)
argument_list|,
name|h
argument_list|)
expr_stmt|;
name|error
operator|=
name|ENOENT
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|con
operator|->
name|link_type
operator|!=
name|NG_HCI_LINK_ACL
condition|)
block|{
name|NG_HCI_ALERT
argument_list|(
literal|"%s: %s - invalid link type=%d\n"
argument_list|,
name|__func__
argument_list|,
name|NG_NODE_NAME
argument_list|(
name|unit
operator|->
name|node
argument_list|)
argument_list|,
name|con
operator|->
name|link_type
argument_list|)
expr_stmt|;
name|error
operator|=
name|EINVAL
expr_stmt|;
block|}
else|else
name|con
operator|->
name|role
operator|=
name|rp
operator|->
name|role
expr_stmt|;
block|}
else|else
name|error
operator|=
name|ENOBUFS
expr_stmt|;
block|}
break|break;
case|case
name|NG_HCI_OCF_READ_LINK_POLICY_SETTINGS
case|:
case|case
name|NG_HCI_OCF_WRITE_LINK_POLICY_SETTINGS
case|:
comment|/* These do not need post processing */
break|break;
case|case
name|NG_HCI_OCF_HOLD_MODE
case|:
case|case
name|NG_HCI_OCF_SNIFF_MODE
case|:
case|case
name|NG_HCI_OCF_EXIT_SNIFF_MODE
case|:
case|case
name|NG_HCI_OCF_PARK_MODE
case|:
case|case
name|NG_HCI_OCF_EXIT_PARK_MODE
case|:
case|case
name|NG_HCI_OCF_QOS_SETUP
case|:
case|case
name|NG_HCI_OCF_SWITCH_ROLE
case|:
default|default:
comment|/* 		 * None of these command was supposed to generate  		 * Command_Complete event. Instead Command_Status event  		 * should have been generated and then appropriate event 		 * should have been sent to indicate the final result. 		 */
name|error
operator|=
name|EINVAL
expr_stmt|;
break|break;
block|}
name|NG_FREE_M
argument_list|(
name|mcp
argument_list|)
expr_stmt|;
name|NG_FREE_M
argument_list|(
name|mrp
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
end_function

begin_comment
comment|/* process_link_policy_params */
end_comment

begin_comment
comment|/*   * Process HC and baseband command return parameters  */
end_comment

begin_function
name|int
name|process_hc_baseband_params
parameter_list|(
name|ng_hci_unit_p
name|unit
parameter_list|,
name|u_int16_t
name|ocf
parameter_list|,
name|struct
name|mbuf
modifier|*
name|mcp
parameter_list|,
name|struct
name|mbuf
modifier|*
name|mrp
parameter_list|)
block|{
name|int
name|error
init|=
literal|0
decl_stmt|;
switch|switch
condition|(
name|ocf
condition|)
block|{
case|case
name|NG_HCI_OCF_SET_EVENT_MASK
case|:
case|case
name|NG_HCI_OCF_SET_EVENT_FILTER
case|:
case|case
name|NG_HCI_OCF_FLUSH
case|:
comment|/* XXX Do we need to handle that? */
case|case
name|NG_HCI_OCF_READ_PIN_TYPE
case|:
case|case
name|NG_HCI_OCF_WRITE_PIN_TYPE
case|:
case|case
name|NG_HCI_OCF_CREATE_NEW_UNIT_KEY
case|:
case|case
name|NG_HCI_OCF_WRITE_STORED_LINK_KEY
case|:
case|case
name|NG_HCI_OCF_WRITE_CON_ACCEPT_TIMO
case|:
case|case
name|NG_HCI_OCF_WRITE_PAGE_TIMO
case|:
case|case
name|NG_HCI_OCF_READ_SCAN_ENABLE
case|:
case|case
name|NG_HCI_OCF_WRITE_SCAN_ENABLE
case|:
case|case
name|NG_HCI_OCF_WRITE_PAGE_SCAN_ACTIVITY
case|:
case|case
name|NG_HCI_OCF_WRITE_INQUIRY_SCAN_ACTIVITY
case|:
case|case
name|NG_HCI_OCF_READ_AUTH_ENABLE
case|:
case|case
name|NG_HCI_OCF_WRITE_AUTH_ENABLE
case|:
case|case
name|NG_HCI_OCF_READ_ENCRYPTION_MODE
case|:
case|case
name|NG_HCI_OCF_WRITE_ENCRYPTION_MODE
case|:
case|case
name|NG_HCI_OCF_WRITE_VOICE_SETTINGS
case|:
case|case
name|NG_HCI_OCF_READ_NUM_BROADCAST_RETRANS
case|:
case|case
name|NG_HCI_OCF_WRITE_NUM_BROADCAST_RETRANS
case|:
case|case
name|NG_HCI_OCF_READ_HOLD_MODE_ACTIVITY
case|:
case|case
name|NG_HCI_OCF_WRITE_HOLD_MODE_ACTIVITY
case|:
case|case
name|NG_HCI_OCF_READ_SCO_FLOW_CONTROL
case|:
case|case
name|NG_HCI_OCF_WRITE_SCO_FLOW_CONTROL
case|:
case|case
name|NG_HCI_OCF_H2HC_FLOW_CONTROL
case|:
comment|/* XXX Not supported this time */
case|case
name|NG_HCI_OCF_HOST_BUFFER_SIZE
case|:
case|case
name|NG_HCI_OCF_READ_IAC_LAP
case|:
case|case
name|NG_HCI_OCF_WRITE_IAC_LAP
case|:
case|case
name|NG_HCI_OCF_READ_PAGE_SCAN_PERIOD
case|:
case|case
name|NG_HCI_OCF_WRITE_PAGE_SCAN_PERIOD
case|:
case|case
name|NG_HCI_OCF_READ_PAGE_SCAN
case|:
case|case
name|NG_HCI_OCF_WRITE_PAGE_SCAN
case|:
case|case
name|NG_HCI_OCF_READ_LINK_SUPERVISION_TIMO
case|:
case|case
name|NG_HCI_OCF_WRITE_LINK_SUPERVISION_TIMO
case|:
case|case
name|NG_HCI_OCF_READ_SUPPORTED_IAC_NUM
case|:
case|case
name|NG_HCI_OCF_READ_STORED_LINK_KEY
case|:
case|case
name|NG_HCI_OCF_DELETE_STORED_LINK_KEY
case|:
case|case
name|NG_HCI_OCF_READ_CON_ACCEPT_TIMO
case|:
case|case
name|NG_HCI_OCF_READ_PAGE_TIMO
case|:
case|case
name|NG_HCI_OCF_READ_PAGE_SCAN_ACTIVITY
case|:
case|case
name|NG_HCI_OCF_READ_INQUIRY_SCAN_ACTIVITY
case|:
case|case
name|NG_HCI_OCF_READ_VOICE_SETTINGS
case|:
case|case
name|NG_HCI_OCF_READ_AUTO_FLUSH_TIMO
case|:
case|case
name|NG_HCI_OCF_WRITE_AUTO_FLUSH_TIMO
case|:
case|case
name|NG_HCI_OCF_READ_XMIT_LEVEL
case|:
case|case
name|NG_HCI_OCF_HOST_NUM_COMPL_PKTS
case|:
comment|/* XXX Can get here? */
case|case
name|NG_HCI_OCF_CHANGE_LOCAL_NAME
case|:
case|case
name|NG_HCI_OCF_READ_LOCAL_NAME
case|:
case|case
name|NG_HCI_OCF_READ_UNIT_CLASS
case|:
case|case
name|NG_HCI_OCF_WRITE_UNIT_CLASS
case|:
comment|/* These do not need post processing */
break|break;
case|case
name|NG_HCI_OCF_RESET
case|:
block|{
name|ng_hci_unit_con_p
name|con
init|=
name|NULL
decl_stmt|;
name|int
name|size
decl_stmt|;
comment|/* 		 * XXX  		 * 		 * After RESET command unit goes into standby mode 		 * and all operational state is lost. Host controller 		 * will revert to default values for all parameters. 		 *  		 * For now we shall terminate all connections and drop 		 * inited bit. After RESET unit must be re-initialized. 		 */
while|while
condition|(
operator|!
name|LIST_EMPTY
argument_list|(
operator|&
name|unit
operator|->
name|con_list
argument_list|)
condition|)
block|{
name|con
operator|=
name|LIST_FIRST
argument_list|(
operator|&
name|unit
operator|->
name|con_list
argument_list|)
expr_stmt|;
comment|/* Remove all timeouts (if any) */
if|if
condition|(
name|con
operator|->
name|flags
operator|&
name|NG_HCI_CON_TIMEOUT_PENDING
condition|)
name|ng_hci_con_untimeout
argument_list|(
name|con
argument_list|)
expr_stmt|;
comment|/* Connection terminated by local host */
name|ng_hci_lp_discon_ind
argument_list|(
name|con
argument_list|,
literal|0x16
argument_list|)
expr_stmt|;
name|ng_hci_free_con
argument_list|(
name|con
argument_list|)
expr_stmt|;
block|}
name|NG_HCI_BUFF_ACL_TOTAL
argument_list|(
name|unit
operator|->
name|buffer
argument_list|,
name|size
argument_list|)
expr_stmt|;
name|NG_HCI_BUFF_ACL_FREE
argument_list|(
name|unit
operator|->
name|buffer
argument_list|,
name|size
argument_list|)
expr_stmt|;
name|NG_HCI_BUFF_SCO_TOTAL
argument_list|(
name|unit
operator|->
name|buffer
argument_list|,
name|size
argument_list|)
expr_stmt|;
name|NG_HCI_BUFF_SCO_FREE
argument_list|(
name|unit
operator|->
name|buffer
argument_list|,
name|size
argument_list|)
expr_stmt|;
name|unit
operator|->
name|state
operator|&=
operator|~
name|NG_HCI_UNIT_INITED
expr_stmt|;
block|}
break|break;
default|default:
name|error
operator|=
name|EINVAL
expr_stmt|;
break|break;
block|}
name|NG_FREE_M
argument_list|(
name|mcp
argument_list|)
expr_stmt|;
name|NG_FREE_M
argument_list|(
name|mrp
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
end_function

begin_comment
comment|/* process_hc_baseband_params */
end_comment

begin_comment
comment|/*   * Process info command return parameters  */
end_comment

begin_function
specifier|static
name|int
name|process_info_params
parameter_list|(
name|ng_hci_unit_p
name|unit
parameter_list|,
name|u_int16_t
name|ocf
parameter_list|,
name|struct
name|mbuf
modifier|*
name|mcp
parameter_list|,
name|struct
name|mbuf
modifier|*
name|mrp
parameter_list|)
block|{
name|int
name|error
init|=
literal|0
decl_stmt|,
name|len
decl_stmt|;
switch|switch
condition|(
name|ocf
condition|)
block|{
case|case
name|NG_HCI_OCF_READ_LOCAL_VER
case|:
case|case
name|NG_HCI_OCF_READ_COUNTRY_CODE
case|:
break|break;
case|case
name|NG_HCI_OCF_READ_LOCAL_FEATURES
case|:
name|m_adj
argument_list|(
name|mrp
argument_list|,
sizeof|sizeof
argument_list|(
name|u_int8_t
argument_list|)
argument_list|)
expr_stmt|;
name|len
operator|=
name|min
argument_list|(
name|mrp
operator|->
name|m_pkthdr
operator|.
name|len
argument_list|,
sizeof|sizeof
argument_list|(
name|unit
operator|->
name|features
argument_list|)
argument_list|)
expr_stmt|;
name|m_copydata
argument_list|(
name|mrp
argument_list|,
literal|0
argument_list|,
name|len
argument_list|,
operator|(
name|caddr_t
operator|)
name|unit
operator|->
name|features
argument_list|)
expr_stmt|;
break|break;
case|case
name|NG_HCI_OCF_READ_BUFFER_SIZE
case|:
block|{
name|ng_hci_read_buffer_size_rp
modifier|*
name|rp
init|=
name|NULL
decl_stmt|;
comment|/* Do not update buffer descriptor if node was initialized */
if|if
condition|(
operator|(
name|unit
operator|->
name|state
operator|&
name|NG_HCI_UNIT_READY
operator|)
operator|==
name|NG_HCI_UNIT_READY
condition|)
break|break;
name|NG_HCI_M_PULLUP
argument_list|(
name|mrp
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|rp
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|mrp
operator|!=
name|NULL
condition|)
block|{
name|rp
operator|=
name|mtod
argument_list|(
name|mrp
argument_list|,
name|ng_hci_read_buffer_size_rp
operator|*
argument_list|)
expr_stmt|;
name|NG_HCI_BUFF_ACL_SET
argument_list|(
name|unit
operator|->
name|buffer
argument_list|,
name|le16toh
argument_list|(
name|rp
operator|->
name|num_acl_pkt
argument_list|)
argument_list|,
comment|/* number */
name|le16toh
argument_list|(
name|rp
operator|->
name|max_acl_size
argument_list|)
argument_list|,
comment|/* size */
name|le16toh
argument_list|(
name|rp
operator|->
name|num_acl_pkt
argument_list|)
comment|/* free */
argument_list|)
expr_stmt|;
name|NG_HCI_BUFF_SCO_SET
argument_list|(
name|unit
operator|->
name|buffer
argument_list|,
name|le16toh
argument_list|(
name|rp
operator|->
name|num_sco_pkt
argument_list|)
argument_list|,
comment|/* number */
name|rp
operator|->
name|max_sco_size
argument_list|,
comment|/* size */
name|le16toh
argument_list|(
name|rp
operator|->
name|num_sco_pkt
argument_list|)
comment|/* free */
argument_list|)
expr_stmt|;
comment|/* Let upper layers know */
name|ng_hci_node_is_up
argument_list|(
name|unit
operator|->
name|node
argument_list|,
name|unit
operator|->
name|acl
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|ng_hci_node_is_up
argument_list|(
name|unit
operator|->
name|node
argument_list|,
name|unit
operator|->
name|sco
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
else|else
name|error
operator|=
name|ENOBUFS
expr_stmt|;
block|}
break|break;
case|case
name|NG_HCI_OCF_READ_BDADDR
case|:
comment|/* Do not update BD_ADDR if node was initialized */
if|if
condition|(
operator|(
name|unit
operator|->
name|state
operator|&
name|NG_HCI_UNIT_READY
operator|)
operator|==
name|NG_HCI_UNIT_READY
condition|)
break|break;
name|m_adj
argument_list|(
name|mrp
argument_list|,
sizeof|sizeof
argument_list|(
name|u_int8_t
argument_list|)
argument_list|)
expr_stmt|;
name|len
operator|=
name|min
argument_list|(
name|mrp
operator|->
name|m_pkthdr
operator|.
name|len
argument_list|,
sizeof|sizeof
argument_list|(
name|unit
operator|->
name|bdaddr
argument_list|)
argument_list|)
expr_stmt|;
name|m_copydata
argument_list|(
name|mrp
argument_list|,
literal|0
argument_list|,
name|len
argument_list|,
operator|(
name|caddr_t
operator|)
operator|&
name|unit
operator|->
name|bdaddr
argument_list|)
expr_stmt|;
comment|/* Let upper layers know */
name|ng_hci_node_is_up
argument_list|(
name|unit
operator|->
name|node
argument_list|,
name|unit
operator|->
name|acl
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|ng_hci_node_is_up
argument_list|(
name|unit
operator|->
name|node
argument_list|,
name|unit
operator|->
name|sco
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
break|break;
default|default:
name|error
operator|=
name|EINVAL
expr_stmt|;
break|break;
block|}
name|NG_FREE_M
argument_list|(
name|mcp
argument_list|)
expr_stmt|;
name|NG_FREE_M
argument_list|(
name|mrp
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
end_function

begin_comment
comment|/* process_info_params */
end_comment

begin_comment
comment|/*   * Process status command return parameters  */
end_comment

begin_function
specifier|static
name|int
name|process_status_params
parameter_list|(
name|ng_hci_unit_p
name|unit
parameter_list|,
name|u_int16_t
name|ocf
parameter_list|,
name|struct
name|mbuf
modifier|*
name|mcp
parameter_list|,
name|struct
name|mbuf
modifier|*
name|mrp
parameter_list|)
block|{
name|int
name|error
init|=
literal|0
decl_stmt|;
switch|switch
condition|(
name|ocf
condition|)
block|{
case|case
name|NG_HCI_OCF_READ_FAILED_CONTACT_CNTR
case|:
case|case
name|NG_HCI_OCF_RESET_FAILED_CONTACT_CNTR
case|:
case|case
name|NG_HCI_OCF_GET_LINK_QUALITY
case|:
case|case
name|NG_HCI_OCF_READ_RSSI
case|:
comment|/* These do not need post processing */
break|break;
default|default:
name|error
operator|=
name|EINVAL
expr_stmt|;
break|break;
block|}
name|NG_FREE_M
argument_list|(
name|mcp
argument_list|)
expr_stmt|;
name|NG_FREE_M
argument_list|(
name|mrp
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
end_function

begin_comment
comment|/* process_status_params */
end_comment

begin_comment
comment|/*   * Process testing command return parameters  */
end_comment

begin_function
name|int
name|process_testing_params
parameter_list|(
name|ng_hci_unit_p
name|unit
parameter_list|,
name|u_int16_t
name|ocf
parameter_list|,
name|struct
name|mbuf
modifier|*
name|mcp
parameter_list|,
name|struct
name|mbuf
modifier|*
name|mrp
parameter_list|)
block|{
name|int
name|error
init|=
literal|0
decl_stmt|;
switch|switch
condition|(
name|ocf
condition|)
block|{
comment|/* 	 * XXX FIXME 	 * We do not support these features at this time. However, 	 * HCI node could support this and do something smart. At least 	 * node can change unit state. 	 */
case|case
name|NG_HCI_OCF_READ_LOOPBACK_MODE
case|:
case|case
name|NG_HCI_OCF_WRITE_LOOPBACK_MODE
case|:
case|case
name|NG_HCI_OCF_ENABLE_UNIT_UNDER_TEST
case|:
break|break;
default|default:
name|error
operator|=
name|EINVAL
expr_stmt|;
break|break;
block|}
name|NG_FREE_M
argument_list|(
name|mcp
argument_list|)
expr_stmt|;
name|NG_FREE_M
argument_list|(
name|mrp
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
end_function

begin_comment
comment|/* process_testing_params */
end_comment

begin_comment
comment|/*  * Process link control command status  */
end_comment

begin_function
specifier|static
name|int
name|process_link_control_status
parameter_list|(
name|ng_hci_unit_p
name|unit
parameter_list|,
name|ng_hci_command_status_ep
modifier|*
name|ep
parameter_list|,
name|struct
name|mbuf
modifier|*
name|mcp
parameter_list|)
block|{
name|int
name|error
init|=
literal|0
decl_stmt|;
switch|switch
condition|(
name|NG_HCI_OCF
argument_list|(
name|ep
operator|->
name|opcode
argument_list|)
condition|)
block|{
case|case
name|NG_HCI_OCF_INQUIRY
case|:
case|case
name|NG_HCI_OCF_DISCON
case|:
comment|/* XXX */
case|case
name|NG_HCI_OCF_REJECT_CON
case|:
comment|/* XXX */
case|case
name|NG_HCI_OCF_CHANGE_CON_PKT_TYPE
case|:
case|case
name|NG_HCI_OCF_AUTH_REQ
case|:
case|case
name|NG_HCI_OCF_SET_CON_ENCRYPTION
case|:
case|case
name|NG_HCI_OCF_CHANGE_CON_LINK_KEY
case|:
case|case
name|NG_HCI_OCF_MASTER_LINK_KEY
case|:
case|case
name|NG_HCI_OCF_REMOTE_NAME_REQ
case|:
case|case
name|NG_HCI_OCF_READ_REMOTE_FEATURES
case|:
case|case
name|NG_HCI_OCF_READ_REMOTE_VER_INFO
case|:
case|case
name|NG_HCI_OCF_READ_CLOCK_OFFSET
case|:
comment|/* These do not need post processing */
break|break;
case|case
name|NG_HCI_OCF_CREATE_CON
case|:
break|break;
case|case
name|NG_HCI_OCF_ADD_SCO_CON
case|:
break|break;
case|case
name|NG_HCI_OCF_ACCEPT_CON
case|:
break|break;
case|case
name|NG_HCI_OCF_INQUIRY_CANCEL
case|:
case|case
name|NG_HCI_OCF_PERIODIC_INQUIRY
case|:
case|case
name|NG_HCI_OCF_EXIT_PERIODIC_INQUIRY
case|:
case|case
name|NG_HCI_OCF_LINK_KEY_REP
case|:
case|case
name|NG_HCI_OCF_LINK_KEY_NEG_REP
case|:
case|case
name|NG_HCI_OCF_PIN_CODE_REP
case|:
case|case
name|NG_HCI_OCF_PIN_CODE_NEG_REP
case|:
default|default:
comment|/* 		 * None of these command was supposed to generate  		 * Command_Status event. Instead Command_Complete event  		 * should have been sent. 		 */
name|error
operator|=
name|EINVAL
expr_stmt|;
break|break;
block|}
name|NG_FREE_M
argument_list|(
name|mcp
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
end_function

begin_comment
comment|/* process_link_control_status */
end_comment

begin_comment
comment|/*  * Process link policy command status  */
end_comment

begin_function
specifier|static
name|int
name|process_link_policy_status
parameter_list|(
name|ng_hci_unit_p
name|unit
parameter_list|,
name|ng_hci_command_status_ep
modifier|*
name|ep
parameter_list|,
name|struct
name|mbuf
modifier|*
name|mcp
parameter_list|)
block|{
name|int
name|error
init|=
literal|0
decl_stmt|;
switch|switch
condition|(
name|NG_HCI_OCF
argument_list|(
name|ep
operator|->
name|opcode
argument_list|)
condition|)
block|{
case|case
name|NG_HCI_OCF_HOLD_MODE
case|:
case|case
name|NG_HCI_OCF_SNIFF_MODE
case|:
case|case
name|NG_HCI_OCF_EXIT_SNIFF_MODE
case|:
case|case
name|NG_HCI_OCF_PARK_MODE
case|:
case|case
name|NG_HCI_OCF_EXIT_PARK_MODE
case|:
case|case
name|NG_HCI_OCF_SWITCH_ROLE
case|:
comment|/* These do not need post processing */
break|break;
case|case
name|NG_HCI_OCF_QOS_SETUP
case|:
break|break;
case|case
name|NG_HCI_OCF_ROLE_DISCOVERY
case|:
case|case
name|NG_HCI_OCF_READ_LINK_POLICY_SETTINGS
case|:
case|case
name|NG_HCI_OCF_WRITE_LINK_POLICY_SETTINGS
case|:
default|default:
comment|/* 		 * None of these command was supposed to generate  		 * Command_Status event. Instead Command_Complete event  		 * should have been sent. 		 */
name|error
operator|=
name|EINVAL
expr_stmt|;
break|break;
block|}
name|NG_FREE_M
argument_list|(
name|mcp
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
end_function

begin_comment
comment|/* process_link_policy_status */
end_comment

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * ng_hci_main.c  */
end_comment

begin_comment
comment|/*-  * Copyright (c) Maksim Yevmenkin<m_evmenkin@yahoo.com>  * All rights reserved.  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions  * are met:  * 1. Redistributions of source code must retain the above copyright  *    notice, this list of conditions and the following disclaimer.  * 2. Redistributions in binary form must reproduce the above copyright  *    notice, this list of conditions and the following disclaimer in the  *    documentation and/or other materials provided with the distribution.  *  * THIS SOFTWARE IS PROVIDED BY THE AUTHOR AND CONTRIBUTORS ``AS IS'' AND  * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE  * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE  * ARE DISCLAIMED. IN NO EVENT SHALL THE AUTHOR OR CONTRIBUTORS BE LIABLE  * FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL  * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS  * OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)  * HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT  * LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY  * OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF  * SUCH DAMAGE.  *  * $Id: ng_hci_main.c,v 1.2 2003/03/18 00:09:36 max Exp $  * $FreeBSD$  */
end_comment

begin_include
include|#
directive|include
file|<sys/param.h>
end_include

begin_include
include|#
directive|include
file|<sys/systm.h>
end_include

begin_include
include|#
directive|include
file|<sys/kernel.h>
end_include

begin_include
include|#
directive|include
file|<sys/endian.h>
end_include

begin_include
include|#
directive|include
file|<sys/malloc.h>
end_include

begin_include
include|#
directive|include
file|<sys/mbuf.h>
end_include

begin_include
include|#
directive|include
file|<sys/queue.h>
end_include

begin_include
include|#
directive|include
file|<netgraph/ng_message.h>
end_include

begin_include
include|#
directive|include
file|<netgraph/netgraph.h>
end_include

begin_include
include|#
directive|include
file|<netgraph/ng_parse.h>
end_include

begin_include
include|#
directive|include
file|<netgraph/bluetooth/include/ng_bluetooth.h>
end_include

begin_include
include|#
directive|include
file|<netgraph/bluetooth/include/ng_hci.h>
end_include

begin_include
include|#
directive|include
file|<netgraph/bluetooth/hci/ng_hci_var.h>
end_include

begin_include
include|#
directive|include
file|<netgraph/bluetooth/hci/ng_hci_prse.h>
end_include

begin_include
include|#
directive|include
file|<netgraph/bluetooth/hci/ng_hci_cmds.h>
end_include

begin_include
include|#
directive|include
file|<netgraph/bluetooth/hci/ng_hci_evnt.h>
end_include

begin_include
include|#
directive|include
file|<netgraph/bluetooth/hci/ng_hci_ulpi.h>
end_include

begin_include
include|#
directive|include
file|<netgraph/bluetooth/hci/ng_hci_misc.h>
end_include

begin_comment
comment|/******************************************************************************  ******************************************************************************  **     This node implements Bluetooth Host Controller Interface (HCI)  ******************************************************************************  ******************************************************************************/
end_comment

begin_comment
comment|/* MALLOC define */
end_comment

begin_ifdef
ifdef|#
directive|ifdef
name|NG_SEPARATE_MALLOC
end_ifdef

begin_expr_stmt
name|MALLOC_DEFINE
argument_list|(
name|M_NETGRAPH_HCI
argument_list|,
literal|"netgraph_hci"
argument_list|,
literal|"Netgraph Bluetooth HCI node"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_else
else|#
directive|else
end_else

begin_define
define|#
directive|define
name|M_NETGRAPH_HCI
value|M_NETGRAPH
end_define

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* NG_SEPARATE_MALLOC */
end_comment

begin_comment
comment|/* Netgraph node methods */
end_comment

begin_decl_stmt
specifier|static
name|ng_constructor_t
name|ng_hci_constructor
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|ng_shutdown_t
name|ng_hci_shutdown
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|ng_newhook_t
name|ng_hci_newhook
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|ng_connect_t
name|ng_hci_connect
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|ng_disconnect_t
name|ng_hci_disconnect
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|ng_rcvmsg_t
name|ng_hci_default_rcvmsg
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|ng_rcvmsg_t
name|ng_hci_upper_rcvmsg
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|ng_rcvdata_t
name|ng_hci_drv_rcvdata
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|ng_rcvdata_t
name|ng_hci_acl_rcvdata
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|ng_rcvdata_t
name|ng_hci_sco_rcvdata
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|ng_rcvdata_t
name|ng_hci_raw_rcvdata
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* Netgraph node type descriptor */
end_comment

begin_decl_stmt
specifier|static
name|struct
name|ng_type
name|typestruct
init|=
block|{
operator|.
name|version
operator|=
name|NG_ABI_VERSION
block|,
operator|.
name|name
operator|=
name|NG_HCI_NODE_TYPE
block|,
operator|.
name|constructor
operator|=
name|ng_hci_constructor
block|,
operator|.
name|rcvmsg
operator|=
name|ng_hci_default_rcvmsg
block|,
operator|.
name|shutdown
operator|=
name|ng_hci_shutdown
block|,
operator|.
name|newhook
operator|=
name|ng_hci_newhook
block|,
operator|.
name|connect
operator|=
name|ng_hci_connect
block|,
operator|.
name|rcvdata
operator|=
name|ng_hci_drv_rcvdata
block|,
operator|.
name|disconnect
operator|=
name|ng_hci_disconnect
block|,
operator|.
name|cmdlist
operator|=
name|ng_hci_cmdlist
block|, }
decl_stmt|;
end_decl_stmt

begin_expr_stmt
name|NETGRAPH_INIT
argument_list|(
name|hci
argument_list|,
operator|&
name|typestruct
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|MODULE_VERSION
argument_list|(
name|ng_hci
argument_list|,
name|NG_BLUETOOTH_VERSION
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|MODULE_DEPEND
argument_list|(
name|ng_hci
argument_list|,
name|ng_bluetooth
argument_list|,
name|NG_BLUETOOTH_VERSION
argument_list|,
name|NG_BLUETOOTH_VERSION
argument_list|,
name|NG_BLUETOOTH_VERSION
argument_list|)
expr_stmt|;
end_expr_stmt

begin_comment
comment|/*****************************************************************************  *****************************************************************************  **                   Netgraph methods implementation  *****************************************************************************  *****************************************************************************/
end_comment

begin_comment
comment|/*  * Create new instance of HCI node (new unit)  */
end_comment

begin_function
specifier|static
name|int
name|ng_hci_constructor
parameter_list|(
name|node_p
name|node
parameter_list|)
block|{
name|ng_hci_unit_p
name|unit
init|=
name|NULL
decl_stmt|;
name|unit
operator|=
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|unit
argument_list|)
argument_list|,
name|M_NETGRAPH_HCI
argument_list|,
name|M_NOWAIT
operator||
name|M_ZERO
argument_list|)
expr_stmt|;
if|if
condition|(
name|unit
operator|==
name|NULL
condition|)
return|return
operator|(
name|ENOMEM
operator|)
return|;
name|unit
operator|->
name|node
operator|=
name|node
expr_stmt|;
name|unit
operator|->
name|debug
operator|=
name|NG_HCI_WARN_LEVEL
expr_stmt|;
name|unit
operator|->
name|link_policy_mask
operator|=
literal|0xffff
expr_stmt|;
comment|/* Enable all supported modes */
name|unit
operator|->
name|packet_mask
operator|=
literal|0xffff
expr_stmt|;
comment|/* Enable all packet types */
name|unit
operator|->
name|role_switch
operator|=
literal|1
expr_stmt|;
comment|/* Enable role switch (if device supports it) */
comment|/* 	 * Set default buffer info 	 * 	 * One HCI command 	 * One ACL packet with max. size of 17 bytes (1 DM1 packet) 	 * One SCO packet with max. size of 10 bytes (1 HV1 packet) 	 */
name|NG_HCI_BUFF_CMD_SET
argument_list|(
name|unit
operator|->
name|buffer
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|NG_HCI_BUFF_ACL_SET
argument_list|(
name|unit
operator|->
name|buffer
argument_list|,
literal|1
argument_list|,
literal|17
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|NG_HCI_BUFF_SCO_SET
argument_list|(
name|unit
operator|->
name|buffer
argument_list|,
literal|1
argument_list|,
literal|10
argument_list|,
literal|1
argument_list|)
expr_stmt|;
comment|/* Init command queue& command timeout handler */
name|ng_callout_init
argument_list|(
operator|&
name|unit
operator|->
name|cmd_timo
argument_list|)
expr_stmt|;
name|NG_BT_MBUFQ_INIT
argument_list|(
operator|&
name|unit
operator|->
name|cmdq
argument_list|,
name|NG_HCI_CMD_QUEUE_LEN
argument_list|)
expr_stmt|;
comment|/* Init lists */
name|LIST_INIT
argument_list|(
operator|&
name|unit
operator|->
name|con_list
argument_list|)
expr_stmt|;
name|LIST_INIT
argument_list|(
operator|&
name|unit
operator|->
name|neighbors
argument_list|)
expr_stmt|;
comment|/* 	 * This node has to be a WRITER because both data and messages 	 * can change node state.  	 */
name|NG_NODE_FORCE_WRITER
argument_list|(
name|node
argument_list|)
expr_stmt|;
name|NG_NODE_SET_PRIVATE
argument_list|(
name|node
argument_list|,
name|unit
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_comment
comment|/* ng_hci_constructor */
end_comment

begin_comment
comment|/*  * Destroy the node  */
end_comment

begin_function
specifier|static
name|int
name|ng_hci_shutdown
parameter_list|(
name|node_p
name|node
parameter_list|)
block|{
name|ng_hci_unit_p
name|unit
init|=
operator|(
name|ng_hci_unit_p
operator|)
name|NG_NODE_PRIVATE
argument_list|(
name|node
argument_list|)
decl_stmt|;
name|NG_NODE_SET_PRIVATE
argument_list|(
name|node
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|NG_NODE_UNREF
argument_list|(
name|node
argument_list|)
expr_stmt|;
name|unit
operator|->
name|node
operator|=
name|NULL
expr_stmt|;
name|ng_hci_unit_clean
argument_list|(
name|unit
argument_list|,
literal|0x16
comment|/* Connection terminated by local host */
argument_list|)
expr_stmt|;
name|NG_BT_MBUFQ_DESTROY
argument_list|(
operator|&
name|unit
operator|->
name|cmdq
argument_list|)
expr_stmt|;
name|bzero
argument_list|(
name|unit
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|unit
argument_list|)
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|unit
argument_list|,
name|M_NETGRAPH_HCI
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_comment
comment|/* ng_hci_shutdown */
end_comment

begin_comment
comment|/*  * Give our OK for a hook to be added. Unit driver is connected to the driver   * (NG_HCI_HOOK_DRV) hook. Upper layer protocols are connected to appropriate  * (NG_HCI_HOOK_ACL or NG_HCI_HOOK_SCO) hooks.  */
end_comment

begin_function
specifier|static
name|int
name|ng_hci_newhook
parameter_list|(
name|node_p
name|node
parameter_list|,
name|hook_p
name|hook
parameter_list|,
name|char
specifier|const
modifier|*
name|name
parameter_list|)
block|{
name|ng_hci_unit_p
name|unit
init|=
operator|(
name|ng_hci_unit_p
operator|)
name|NG_NODE_PRIVATE
argument_list|(
name|node
argument_list|)
decl_stmt|;
name|hook_p
modifier|*
name|h
init|=
name|NULL
decl_stmt|;
if|if
condition|(
name|strcmp
argument_list|(
name|name
argument_list|,
name|NG_HCI_HOOK_DRV
argument_list|)
operator|==
literal|0
condition|)
name|h
operator|=
operator|&
name|unit
operator|->
name|drv
expr_stmt|;
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|name
argument_list|,
name|NG_HCI_HOOK_ACL
argument_list|)
operator|==
literal|0
condition|)
name|h
operator|=
operator|&
name|unit
operator|->
name|acl
expr_stmt|;
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|name
argument_list|,
name|NG_HCI_HOOK_SCO
argument_list|)
operator|==
literal|0
condition|)
name|h
operator|=
operator|&
name|unit
operator|->
name|sco
expr_stmt|;
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|name
argument_list|,
name|NG_HCI_HOOK_RAW
argument_list|)
operator|==
literal|0
condition|)
name|h
operator|=
operator|&
name|unit
operator|->
name|raw
expr_stmt|;
else|else
return|return
operator|(
name|EINVAL
operator|)
return|;
if|if
condition|(
operator|*
name|h
operator|!=
name|NULL
condition|)
return|return
operator|(
name|EISCONN
operator|)
return|;
operator|*
name|h
operator|=
name|hook
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_comment
comment|/* ng_hci_newhook */
end_comment

begin_comment
comment|/*  * Give our final OK to connect hook  */
end_comment

begin_function
specifier|static
name|int
name|ng_hci_connect
parameter_list|(
name|hook_p
name|hook
parameter_list|)
block|{
name|ng_hci_unit_p
name|unit
init|=
operator|(
name|ng_hci_unit_p
operator|)
name|NG_NODE_PRIVATE
argument_list|(
name|NG_HOOK_NODE
argument_list|(
name|hook
argument_list|)
argument_list|)
decl_stmt|;
if|if
condition|(
name|hook
operator|!=
name|unit
operator|->
name|drv
condition|)
block|{
if|if
condition|(
name|hook
operator|==
name|unit
operator|->
name|acl
condition|)
block|{
name|NG_HOOK_SET_RCVMSG
argument_list|(
name|hook
argument_list|,
name|ng_hci_upper_rcvmsg
argument_list|)
expr_stmt|;
name|NG_HOOK_SET_RCVDATA
argument_list|(
name|hook
argument_list|,
name|ng_hci_acl_rcvdata
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|hook
operator|==
name|unit
operator|->
name|sco
condition|)
block|{
name|NG_HOOK_SET_RCVMSG
argument_list|(
name|hook
argument_list|,
name|ng_hci_upper_rcvmsg
argument_list|)
expr_stmt|;
name|NG_HOOK_SET_RCVDATA
argument_list|(
name|hook
argument_list|,
name|ng_hci_sco_rcvdata
argument_list|)
expr_stmt|;
block|}
else|else
name|NG_HOOK_SET_RCVDATA
argument_list|(
name|hook
argument_list|,
name|ng_hci_raw_rcvdata
argument_list|)
expr_stmt|;
comment|/* Send delayed notification to the upper layers */
if|if
condition|(
name|hook
operator|!=
name|unit
operator|->
name|raw
condition|)
name|ng_send_fn
argument_list|(
name|unit
operator|->
name|node
argument_list|,
name|hook
argument_list|,
name|ng_hci_node_is_up
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
else|else
name|unit
operator|->
name|state
operator||=
name|NG_HCI_UNIT_CONNECTED
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_comment
comment|/* ng_hci_connect */
end_comment

begin_comment
comment|/*  * Disconnect the hook  */
end_comment

begin_function
specifier|static
name|int
name|ng_hci_disconnect
parameter_list|(
name|hook_p
name|hook
parameter_list|)
block|{
name|ng_hci_unit_p
name|unit
init|=
operator|(
name|ng_hci_unit_p
operator|)
name|NG_NODE_PRIVATE
argument_list|(
name|NG_HOOK_NODE
argument_list|(
name|hook
argument_list|)
argument_list|)
decl_stmt|;
if|if
condition|(
name|hook
operator|==
name|unit
operator|->
name|acl
condition|)
name|unit
operator|->
name|acl
operator|=
name|NULL
expr_stmt|;
elseif|else
if|if
condition|(
name|hook
operator|==
name|unit
operator|->
name|sco
condition|)
name|unit
operator|->
name|sco
operator|=
name|NULL
expr_stmt|;
elseif|else
if|if
condition|(
name|hook
operator|==
name|unit
operator|->
name|raw
condition|)
name|unit
operator|->
name|raw
operator|=
name|NULL
expr_stmt|;
elseif|else
if|if
condition|(
name|hook
operator|==
name|unit
operator|->
name|drv
condition|)
block|{
name|unit
operator|->
name|drv
operator|=
name|NULL
expr_stmt|;
comment|/* Connection terminated by local host */
name|ng_hci_unit_clean
argument_list|(
name|unit
argument_list|,
literal|0x16
argument_list|)
expr_stmt|;
name|unit
operator|->
name|state
operator|&=
operator|~
operator|(
name|NG_HCI_UNIT_CONNECTED
operator||
name|NG_HCI_UNIT_INITED
operator|)
expr_stmt|;
block|}
else|else
return|return
operator|(
name|EINVAL
operator|)
return|;
comment|/* Shutdown when all hooks are disconnected */
if|if
condition|(
operator|(
name|NG_NODE_NUMHOOKS
argument_list|(
name|NG_HOOK_NODE
argument_list|(
name|hook
argument_list|)
argument_list|)
operator|==
literal|0
operator|)
operator|&&
operator|(
name|NG_NODE_IS_VALID
argument_list|(
name|NG_HOOK_NODE
argument_list|(
name|hook
argument_list|)
argument_list|)
operator|)
condition|)
name|ng_rmnode_self
argument_list|(
name|NG_HOOK_NODE
argument_list|(
name|hook
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_comment
comment|/* ng_hci_disconnect */
end_comment

begin_comment
comment|/*  * Default control message processing routine. Control message could be:  *  * 1) GENERIC Netgraph messages  *  * 2) Control message directed to the node itself.  */
end_comment

begin_function
specifier|static
name|int
name|ng_hci_default_rcvmsg
parameter_list|(
name|node_p
name|node
parameter_list|,
name|item_p
name|item
parameter_list|,
name|hook_p
name|lasthook
parameter_list|)
block|{
name|ng_hci_unit_p
name|unit
init|=
operator|(
name|ng_hci_unit_p
operator|)
name|NG_NODE_PRIVATE
argument_list|(
name|node
argument_list|)
decl_stmt|;
name|struct
name|ng_mesg
modifier|*
name|msg
init|=
name|NULL
decl_stmt|,
modifier|*
name|rsp
init|=
name|NULL
decl_stmt|;
name|int
name|error
init|=
literal|0
decl_stmt|;
name|NGI_GET_MSG
argument_list|(
name|item
argument_list|,
name|msg
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|msg
operator|->
name|header
operator|.
name|typecookie
condition|)
block|{
case|case
name|NGM_GENERIC_COOKIE
case|:
switch|switch
condition|(
name|msg
operator|->
name|header
operator|.
name|cmd
condition|)
block|{
case|case
name|NGM_TEXT_STATUS
case|:
block|{
name|int
name|cmd_avail
decl_stmt|,
name|acl_total
decl_stmt|,
name|acl_avail
decl_stmt|,
name|acl_size
decl_stmt|,
name|sco_total
decl_stmt|,
name|sco_avail
decl_stmt|,
name|sco_size
decl_stmt|;
name|NG_MKRESPONSE
argument_list|(
name|rsp
argument_list|,
name|msg
argument_list|,
name|NG_TEXTRESPONSE
argument_list|,
name|M_NOWAIT
argument_list|)
expr_stmt|;
if|if
condition|(
name|rsp
operator|==
name|NULL
condition|)
block|{
name|error
operator|=
name|ENOMEM
expr_stmt|;
break|break;
block|}
name|NG_HCI_BUFF_CMD_GET
argument_list|(
name|unit
operator|->
name|buffer
argument_list|,
name|cmd_avail
argument_list|)
expr_stmt|;
name|NG_HCI_BUFF_ACL_AVAIL
argument_list|(
name|unit
operator|->
name|buffer
argument_list|,
name|acl_avail
argument_list|)
expr_stmt|;
name|NG_HCI_BUFF_ACL_TOTAL
argument_list|(
name|unit
operator|->
name|buffer
argument_list|,
name|acl_total
argument_list|)
expr_stmt|;
name|NG_HCI_BUFF_ACL_SIZE
argument_list|(
name|unit
operator|->
name|buffer
argument_list|,
name|acl_size
argument_list|)
expr_stmt|;
name|NG_HCI_BUFF_SCO_AVAIL
argument_list|(
name|unit
operator|->
name|buffer
argument_list|,
name|sco_avail
argument_list|)
expr_stmt|;
name|NG_HCI_BUFF_SCO_TOTAL
argument_list|(
name|unit
operator|->
name|buffer
argument_list|,
name|sco_total
argument_list|)
expr_stmt|;
name|NG_HCI_BUFF_SCO_SIZE
argument_list|(
name|unit
operator|->
name|buffer
argument_list|,
name|sco_size
argument_list|)
expr_stmt|;
name|snprintf
argument_list|(
name|rsp
operator|->
name|data
argument_list|,
name|NG_TEXTRESPONSE
argument_list|,
literal|"bdaddr %x:%x:%x:%x:%x:%x\n"
expr|\
literal|"Hooks  %s %s %s %s\n"
expr|\
literal|"State  %#x\n"
expr|\
literal|"Queue  cmd:%d\n"
expr|\
literal|"Buffer cmd:%d,acl:%d,%d,%d,sco:%d,%d,%d"
argument_list|,
name|unit
operator|->
name|bdaddr
operator|.
name|b
index|[
literal|5
index|]
argument_list|,
name|unit
operator|->
name|bdaddr
operator|.
name|b
index|[
literal|4
index|]
argument_list|,
name|unit
operator|->
name|bdaddr
operator|.
name|b
index|[
literal|3
index|]
argument_list|,
name|unit
operator|->
name|bdaddr
operator|.
name|b
index|[
literal|2
index|]
argument_list|,
name|unit
operator|->
name|bdaddr
operator|.
name|b
index|[
literal|1
index|]
argument_list|,
name|unit
operator|->
name|bdaddr
operator|.
name|b
index|[
literal|0
index|]
argument_list|,
operator|(
name|unit
operator|->
name|drv
operator|!=
name|NULL
operator|)
condition|?
name|NG_HCI_HOOK_DRV
else|:
literal|""
argument_list|,
operator|(
name|unit
operator|->
name|acl
operator|!=
name|NULL
operator|)
condition|?
name|NG_HCI_HOOK_ACL
else|:
literal|""
argument_list|,
operator|(
name|unit
operator|->
name|sco
operator|!=
name|NULL
operator|)
condition|?
name|NG_HCI_HOOK_SCO
else|:
literal|""
argument_list|,
operator|(
name|unit
operator|->
name|raw
operator|!=
name|NULL
operator|)
condition|?
name|NG_HCI_HOOK_RAW
else|:
literal|""
argument_list|,
name|unit
operator|->
name|state
argument_list|,
name|NG_BT_MBUFQ_LEN
argument_list|(
operator|&
name|unit
operator|->
name|cmdq
argument_list|)
argument_list|,
name|cmd_avail
argument_list|,
name|acl_avail
argument_list|,
name|acl_total
argument_list|,
name|acl_size
argument_list|,
name|sco_avail
argument_list|,
name|sco_total
argument_list|,
name|sco_size
argument_list|)
expr_stmt|;
block|}
break|break;
default|default:
name|error
operator|=
name|EINVAL
expr_stmt|;
break|break;
block|}
break|break;
case|case
name|NGM_HCI_COOKIE
case|:
switch|switch
condition|(
name|msg
operator|->
name|header
operator|.
name|cmd
condition|)
block|{
comment|/* Get current node state */
case|case
name|NGM_HCI_NODE_GET_STATE
case|:
name|NG_MKRESPONSE
argument_list|(
name|rsp
argument_list|,
name|msg
argument_list|,
sizeof|sizeof
argument_list|(
name|unit
operator|->
name|state
argument_list|)
argument_list|,
name|M_NOWAIT
argument_list|)
expr_stmt|;
if|if
condition|(
name|rsp
operator|==
name|NULL
condition|)
block|{
name|error
operator|=
name|ENOMEM
expr_stmt|;
break|break;
block|}
operator|*
operator|(
operator|(
name|ng_hci_node_state_ep
operator|*
operator|)
operator|(
name|rsp
operator|->
name|data
operator|)
operator|)
operator|=
name|unit
operator|->
name|state
expr_stmt|;
break|break;
comment|/* Turn INITED bit - node initialized */
case|case
name|NGM_HCI_NODE_INIT
case|:
if|if
condition|(
name|bcmp
argument_list|(
operator|&
name|unit
operator|->
name|bdaddr
argument_list|,
name|NG_HCI_BDADDR_ANY
argument_list|,
sizeof|sizeof
argument_list|(
name|bdaddr_t
argument_list|)
argument_list|)
operator|==
literal|0
condition|)
block|{
name|error
operator|=
name|ENXIO
expr_stmt|;
break|break;
block|}
name|unit
operator|->
name|state
operator||=
name|NG_HCI_UNIT_INITED
expr_stmt|;
name|ng_hci_node_is_up
argument_list|(
name|unit
operator|->
name|node
argument_list|,
name|unit
operator|->
name|acl
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|ng_hci_node_is_up
argument_list|(
name|unit
operator|->
name|node
argument_list|,
name|unit
operator|->
name|sco
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
break|break;
comment|/* Get node debug level */
case|case
name|NGM_HCI_NODE_GET_DEBUG
case|:
name|NG_MKRESPONSE
argument_list|(
name|rsp
argument_list|,
name|msg
argument_list|,
sizeof|sizeof
argument_list|(
name|unit
operator|->
name|debug
argument_list|)
argument_list|,
name|M_NOWAIT
argument_list|)
expr_stmt|;
if|if
condition|(
name|rsp
operator|==
name|NULL
condition|)
block|{
name|error
operator|=
name|ENOMEM
expr_stmt|;
break|break;
block|}
operator|*
operator|(
operator|(
name|ng_hci_node_debug_ep
operator|*
operator|)
operator|(
name|rsp
operator|->
name|data
operator|)
operator|)
operator|=
name|unit
operator|->
name|debug
expr_stmt|;
break|break;
comment|/* Set node debug level */
case|case
name|NGM_HCI_NODE_SET_DEBUG
case|:
if|if
condition|(
name|msg
operator|->
name|header
operator|.
name|arglen
operator|!=
sizeof|sizeof
argument_list|(
name|ng_hci_node_debug_ep
argument_list|)
condition|)
block|{
name|error
operator|=
name|EMSGSIZE
expr_stmt|;
break|break;
block|}
name|unit
operator|->
name|debug
operator|=
operator|*
operator|(
operator|(
name|ng_hci_node_debug_ep
operator|*
operator|)
operator|(
name|msg
operator|->
name|data
operator|)
operator|)
expr_stmt|;
break|break;
comment|/* Get buffer info */
case|case
name|NGM_HCI_NODE_GET_BUFFER
case|:
block|{
name|ng_hci_node_buffer_ep
modifier|*
name|ep
init|=
name|NULL
decl_stmt|;
name|NG_MKRESPONSE
argument_list|(
name|rsp
argument_list|,
name|msg
argument_list|,
sizeof|sizeof
argument_list|(
name|ng_hci_node_buffer_ep
argument_list|)
argument_list|,
name|M_NOWAIT
argument_list|)
expr_stmt|;
if|if
condition|(
name|rsp
operator|==
name|NULL
condition|)
block|{
name|error
operator|=
name|ENOMEM
expr_stmt|;
break|break;
block|}
name|ep
operator|=
operator|(
name|ng_hci_node_buffer_ep
operator|*
operator|)
operator|(
name|rsp
operator|->
name|data
operator|)
expr_stmt|;
name|NG_HCI_BUFF_CMD_GET
argument_list|(
name|unit
operator|->
name|buffer
argument_list|,
name|ep
operator|->
name|cmd_free
argument_list|)
expr_stmt|;
name|NG_HCI_BUFF_ACL_AVAIL
argument_list|(
name|unit
operator|->
name|buffer
argument_list|,
name|ep
operator|->
name|acl_free
argument_list|)
expr_stmt|;
name|NG_HCI_BUFF_ACL_TOTAL
argument_list|(
name|unit
operator|->
name|buffer
argument_list|,
name|ep
operator|->
name|acl_pkts
argument_list|)
expr_stmt|;
name|NG_HCI_BUFF_ACL_SIZE
argument_list|(
name|unit
operator|->
name|buffer
argument_list|,
name|ep
operator|->
name|acl_size
argument_list|)
expr_stmt|;
name|NG_HCI_BUFF_SCO_AVAIL
argument_list|(
name|unit
operator|->
name|buffer
argument_list|,
name|ep
operator|->
name|sco_free
argument_list|)
expr_stmt|;
name|NG_HCI_BUFF_SCO_TOTAL
argument_list|(
name|unit
operator|->
name|buffer
argument_list|,
name|ep
operator|->
name|sco_pkts
argument_list|)
expr_stmt|;
name|NG_HCI_BUFF_SCO_SIZE
argument_list|(
name|unit
operator|->
name|buffer
argument_list|,
name|ep
operator|->
name|sco_size
argument_list|)
expr_stmt|;
block|}
break|break;
comment|/* Get BDADDR */
case|case
name|NGM_HCI_NODE_GET_BDADDR
case|:
name|NG_MKRESPONSE
argument_list|(
name|rsp
argument_list|,
name|msg
argument_list|,
sizeof|sizeof
argument_list|(
name|bdaddr_t
argument_list|)
argument_list|,
name|M_NOWAIT
argument_list|)
expr_stmt|;
if|if
condition|(
name|rsp
operator|==
name|NULL
condition|)
block|{
name|error
operator|=
name|ENOMEM
expr_stmt|;
break|break;
block|}
name|bcopy
argument_list|(
operator|&
name|unit
operator|->
name|bdaddr
argument_list|,
name|rsp
operator|->
name|data
argument_list|,
sizeof|sizeof
argument_list|(
name|bdaddr_t
argument_list|)
argument_list|)
expr_stmt|;
break|break;
comment|/* Get features */
case|case
name|NGM_HCI_NODE_GET_FEATURES
case|:
name|NG_MKRESPONSE
argument_list|(
name|rsp
argument_list|,
name|msg
argument_list|,
sizeof|sizeof
argument_list|(
name|unit
operator|->
name|features
argument_list|)
argument_list|,
name|M_NOWAIT
argument_list|)
expr_stmt|;
if|if
condition|(
name|rsp
operator|==
name|NULL
condition|)
block|{
name|error
operator|=
name|ENOMEM
expr_stmt|;
break|break;
block|}
name|bcopy
argument_list|(
operator|&
name|unit
operator|->
name|features
argument_list|,
name|rsp
operator|->
name|data
argument_list|,
sizeof|sizeof
argument_list|(
name|unit
operator|->
name|features
argument_list|)
argument_list|)
expr_stmt|;
break|break;
comment|/* Get stat */
case|case
name|NGM_HCI_NODE_GET_STAT
case|:
name|NG_MKRESPONSE
argument_list|(
name|rsp
argument_list|,
name|msg
argument_list|,
sizeof|sizeof
argument_list|(
name|unit
operator|->
name|stat
argument_list|)
argument_list|,
name|M_NOWAIT
argument_list|)
expr_stmt|;
if|if
condition|(
name|rsp
operator|==
name|NULL
condition|)
block|{
name|error
operator|=
name|ENOMEM
expr_stmt|;
break|break;
block|}
name|bcopy
argument_list|(
operator|&
name|unit
operator|->
name|stat
argument_list|,
name|rsp
operator|->
name|data
argument_list|,
sizeof|sizeof
argument_list|(
name|unit
operator|->
name|stat
argument_list|)
argument_list|)
expr_stmt|;
break|break;
comment|/* Reset stat */
case|case
name|NGM_HCI_NODE_RESET_STAT
case|:
name|NG_HCI_STAT_RESET
argument_list|(
name|unit
operator|->
name|stat
argument_list|)
expr_stmt|;
break|break;
comment|/* Clean up neighbors list */
case|case
name|NGM_HCI_NODE_FLUSH_NEIGHBOR_CACHE
case|:
name|ng_hci_flush_neighbor_cache
argument_list|(
name|unit
argument_list|)
expr_stmt|;
break|break;
comment|/* Get neighbor cache entries */
case|case
name|NGM_HCI_NODE_GET_NEIGHBOR_CACHE
case|:
block|{
name|ng_hci_neighbor_p
name|n
init|=
name|NULL
decl_stmt|;
name|ng_hci_node_get_neighbor_cache_ep
modifier|*
name|e1
init|=
name|NULL
decl_stmt|;
name|ng_hci_node_neighbor_cache_entry_ep
modifier|*
name|e2
init|=
name|NULL
decl_stmt|;
name|int
name|s
init|=
literal|0
decl_stmt|;
comment|/* Look for the fresh entries in the cache */
for|for
control|(
name|n
operator|=
name|LIST_FIRST
argument_list|(
operator|&
name|unit
operator|->
name|neighbors
argument_list|)
init|;
name|n
operator|!=
name|NULL
condition|;
control|)
block|{
name|ng_hci_neighbor_p
name|nn
init|=
name|LIST_NEXT
argument_list|(
name|n
argument_list|,
name|next
argument_list|)
decl_stmt|;
if|if
condition|(
name|ng_hci_neighbor_stale
argument_list|(
name|n
argument_list|)
condition|)
name|ng_hci_free_neighbor
argument_list|(
name|n
argument_list|)
expr_stmt|;
else|else
name|s
operator|++
expr_stmt|;
name|n
operator|=
name|nn
expr_stmt|;
block|}
if|if
condition|(
name|s
operator|>
name|NG_HCI_MAX_NEIGHBOR_NUM
condition|)
name|s
operator|=
name|NG_HCI_MAX_NEIGHBOR_NUM
expr_stmt|;
comment|/* Prepare response */
name|NG_MKRESPONSE
argument_list|(
name|rsp
argument_list|,
name|msg
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|e1
argument_list|)
operator|+
name|s
operator|*
sizeof|sizeof
argument_list|(
operator|*
name|e2
argument_list|)
argument_list|,
name|M_NOWAIT
argument_list|)
expr_stmt|;
if|if
condition|(
name|rsp
operator|==
name|NULL
condition|)
block|{
name|error
operator|=
name|ENOMEM
expr_stmt|;
break|break;
block|}
name|e1
operator|=
operator|(
name|ng_hci_node_get_neighbor_cache_ep
operator|*
operator|)
operator|(
name|rsp
operator|->
name|data
operator|)
expr_stmt|;
name|e2
operator|=
operator|(
name|ng_hci_node_neighbor_cache_entry_ep
operator|*
operator|)
operator|(
name|e1
operator|+
literal|1
operator|)
expr_stmt|;
name|e1
operator|->
name|num_entries
operator|=
name|s
expr_stmt|;
name|LIST_FOREACH
argument_list|(
argument|n
argument_list|,
argument|&unit->neighbors
argument_list|,
argument|next
argument_list|)
block|{
name|e2
operator|->
name|page_scan_rep_mode
operator|=
name|n
operator|->
name|page_scan_rep_mode
expr_stmt|;
name|e2
operator|->
name|page_scan_mode
operator|=
name|n
operator|->
name|page_scan_mode
expr_stmt|;
name|e2
operator|->
name|clock_offset
operator|=
name|n
operator|->
name|clock_offset
expr_stmt|;
name|bcopy
argument_list|(
operator|&
name|n
operator|->
name|bdaddr
argument_list|,
operator|&
name|e2
operator|->
name|bdaddr
argument_list|,
sizeof|sizeof
argument_list|(
name|e2
operator|->
name|bdaddr
argument_list|)
argument_list|)
expr_stmt|;
name|bcopy
argument_list|(
operator|&
name|n
operator|->
name|features
argument_list|,
operator|&
name|e2
operator|->
name|features
argument_list|,
sizeof|sizeof
argument_list|(
name|e2
operator|->
name|features
argument_list|)
argument_list|)
expr_stmt|;
name|e2
operator|++
expr_stmt|;
if|if
condition|(
operator|--
name|s
operator|<=
literal|0
condition|)
break|break;
block|}
block|}
break|break;
comment|/* Get connection list */
case|case
name|NGM_HCI_NODE_GET_CON_LIST
case|:
block|{
name|ng_hci_unit_con_p
name|c
init|=
name|NULL
decl_stmt|;
name|ng_hci_node_con_list_ep
modifier|*
name|e1
init|=
name|NULL
decl_stmt|;
name|ng_hci_node_con_ep
modifier|*
name|e2
init|=
name|NULL
decl_stmt|;
name|int
name|s
init|=
literal|0
decl_stmt|;
comment|/* Count number of connections in the list */
name|LIST_FOREACH
argument_list|(
argument|c
argument_list|,
argument|&unit->con_list
argument_list|,
argument|next
argument_list|)
name|s
operator|++
expr_stmt|;
if|if
condition|(
name|s
operator|>
name|NG_HCI_MAX_CON_NUM
condition|)
name|s
operator|=
name|NG_HCI_MAX_CON_NUM
expr_stmt|;
comment|/* Prepare response */
name|NG_MKRESPONSE
argument_list|(
name|rsp
argument_list|,
name|msg
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|e1
argument_list|)
operator|+
name|s
operator|*
sizeof|sizeof
argument_list|(
operator|*
name|e2
argument_list|)
argument_list|,
name|M_NOWAIT
argument_list|)
expr_stmt|;
if|if
condition|(
name|rsp
operator|==
name|NULL
condition|)
block|{
name|error
operator|=
name|ENOMEM
expr_stmt|;
break|break;
block|}
name|e1
operator|=
operator|(
name|ng_hci_node_con_list_ep
operator|*
operator|)
operator|(
name|rsp
operator|->
name|data
operator|)
expr_stmt|;
name|e2
operator|=
operator|(
name|ng_hci_node_con_ep
operator|*
operator|)
operator|(
name|e1
operator|+
literal|1
operator|)
expr_stmt|;
name|e1
operator|->
name|num_connections
operator|=
name|s
expr_stmt|;
name|LIST_FOREACH
argument_list|(
argument|c
argument_list|,
argument|&unit->con_list
argument_list|,
argument|next
argument_list|)
block|{
name|e2
operator|->
name|link_type
operator|=
name|c
operator|->
name|link_type
expr_stmt|;
name|e2
operator|->
name|encryption_mode
operator|=
name|c
operator|->
name|encryption_mode
expr_stmt|;
name|e2
operator|->
name|mode
operator|=
name|c
operator|->
name|mode
expr_stmt|;
name|e2
operator|->
name|role
operator|=
name|c
operator|->
name|role
expr_stmt|;
name|e2
operator|->
name|state
operator|=
name|c
operator|->
name|state
expr_stmt|;
name|e2
operator|->
name|pending
operator|=
name|c
operator|->
name|pending
expr_stmt|;
name|e2
operator|->
name|queue_len
operator|=
name|NG_BT_ITEMQ_LEN
argument_list|(
operator|&
name|c
operator|->
name|conq
argument_list|)
expr_stmt|;
name|e2
operator|->
name|con_handle
operator|=
name|c
operator|->
name|con_handle
expr_stmt|;
name|bcopy
argument_list|(
operator|&
name|c
operator|->
name|bdaddr
argument_list|,
operator|&
name|e2
operator|->
name|bdaddr
argument_list|,
sizeof|sizeof
argument_list|(
name|e2
operator|->
name|bdaddr
argument_list|)
argument_list|)
expr_stmt|;
name|e2
operator|++
expr_stmt|;
if|if
condition|(
operator|--
name|s
operator|<=
literal|0
condition|)
break|break;
block|}
block|}
break|break;
comment|/* Get link policy settings mask */
case|case
name|NGM_HCI_NODE_GET_LINK_POLICY_SETTINGS_MASK
case|:
name|NG_MKRESPONSE
argument_list|(
name|rsp
argument_list|,
name|msg
argument_list|,
sizeof|sizeof
argument_list|(
name|unit
operator|->
name|link_policy_mask
argument_list|)
argument_list|,
name|M_NOWAIT
argument_list|)
expr_stmt|;
if|if
condition|(
name|rsp
operator|==
name|NULL
condition|)
block|{
name|error
operator|=
name|ENOMEM
expr_stmt|;
break|break;
block|}
operator|*
operator|(
operator|(
name|ng_hci_node_link_policy_mask_ep
operator|*
operator|)
operator|(
name|rsp
operator|->
name|data
operator|)
operator|)
operator|=
name|unit
operator|->
name|link_policy_mask
expr_stmt|;
break|break;
comment|/* Set link policy settings mask */
case|case
name|NGM_HCI_NODE_SET_LINK_POLICY_SETTINGS_MASK
case|:
if|if
condition|(
name|msg
operator|->
name|header
operator|.
name|arglen
operator|!=
sizeof|sizeof
argument_list|(
name|ng_hci_node_link_policy_mask_ep
argument_list|)
condition|)
block|{
name|error
operator|=
name|EMSGSIZE
expr_stmt|;
break|break;
block|}
name|unit
operator|->
name|link_policy_mask
operator|=
operator|*
operator|(
operator|(
name|ng_hci_node_link_policy_mask_ep
operator|*
operator|)
operator|(
name|msg
operator|->
name|data
operator|)
operator|)
expr_stmt|;
break|break;
comment|/* Get packet mask */
case|case
name|NGM_HCI_NODE_GET_PACKET_MASK
case|:
name|NG_MKRESPONSE
argument_list|(
name|rsp
argument_list|,
name|msg
argument_list|,
sizeof|sizeof
argument_list|(
name|unit
operator|->
name|packet_mask
argument_list|)
argument_list|,
name|M_NOWAIT
argument_list|)
expr_stmt|;
if|if
condition|(
name|rsp
operator|==
name|NULL
condition|)
block|{
name|error
operator|=
name|ENOMEM
expr_stmt|;
break|break;
block|}
operator|*
operator|(
operator|(
name|ng_hci_node_packet_mask_ep
operator|*
operator|)
operator|(
name|rsp
operator|->
name|data
operator|)
operator|)
operator|=
name|unit
operator|->
name|packet_mask
expr_stmt|;
break|break;
comment|/* Set packet mask */
case|case
name|NGM_HCI_NODE_SET_PACKET_MASK
case|:
if|if
condition|(
name|msg
operator|->
name|header
operator|.
name|arglen
operator|!=
sizeof|sizeof
argument_list|(
name|ng_hci_node_packet_mask_ep
argument_list|)
condition|)
block|{
name|error
operator|=
name|EMSGSIZE
expr_stmt|;
break|break;
block|}
name|unit
operator|->
name|packet_mask
operator|=
operator|*
operator|(
operator|(
name|ng_hci_node_packet_mask_ep
operator|*
operator|)
operator|(
name|msg
operator|->
name|data
operator|)
operator|)
expr_stmt|;
break|break;
comment|/* Get role switch */
case|case
name|NGM_HCI_NODE_GET_ROLE_SWITCH
case|:
name|NG_MKRESPONSE
argument_list|(
name|rsp
argument_list|,
name|msg
argument_list|,
sizeof|sizeof
argument_list|(
name|unit
operator|->
name|role_switch
argument_list|)
argument_list|,
name|M_NOWAIT
argument_list|)
expr_stmt|;
if|if
condition|(
name|rsp
operator|==
name|NULL
condition|)
block|{
name|error
operator|=
name|ENOMEM
expr_stmt|;
break|break;
block|}
operator|*
operator|(
operator|(
name|ng_hci_node_role_switch_ep
operator|*
operator|)
operator|(
name|rsp
operator|->
name|data
operator|)
operator|)
operator|=
name|unit
operator|->
name|role_switch
expr_stmt|;
break|break;
comment|/* Set role switch */
case|case
name|NGM_HCI_NODE_SET_ROLE_SWITCH
case|:
if|if
condition|(
name|msg
operator|->
name|header
operator|.
name|arglen
operator|!=
sizeof|sizeof
argument_list|(
name|ng_hci_node_role_switch_ep
argument_list|)
condition|)
block|{
name|error
operator|=
name|EMSGSIZE
expr_stmt|;
break|break;
block|}
name|unit
operator|->
name|role_switch
operator|=
operator|*
operator|(
operator|(
name|ng_hci_node_role_switch_ep
operator|*
operator|)
operator|(
name|msg
operator|->
name|data
operator|)
operator|)
expr_stmt|;
break|break;
default|default:
name|error
operator|=
name|EINVAL
expr_stmt|;
break|break;
block|}
break|break;
default|default:
name|error
operator|=
name|EINVAL
expr_stmt|;
break|break;
block|}
comment|/* NG_RESPOND_MSG should take care of "item" and "rsp" */
name|NG_RESPOND_MSG
argument_list|(
name|error
argument_list|,
name|node
argument_list|,
name|item
argument_list|,
name|rsp
argument_list|)
expr_stmt|;
name|NG_FREE_MSG
argument_list|(
name|msg
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
end_function

begin_comment
comment|/* ng_hci_default_rcvmsg */
end_comment

begin_comment
comment|/*  * Process control message from upstream hooks (ACL and SCO).  * Handle LP_xxx messages here, give everything else to default routine.  */
end_comment

begin_function
specifier|static
name|int
name|ng_hci_upper_rcvmsg
parameter_list|(
name|node_p
name|node
parameter_list|,
name|item_p
name|item
parameter_list|,
name|hook_p
name|lasthook
parameter_list|)
block|{
name|ng_hci_unit_p
name|unit
init|=
operator|(
name|ng_hci_unit_p
operator|)
name|NG_NODE_PRIVATE
argument_list|(
name|node
argument_list|)
decl_stmt|;
name|int
name|error
init|=
literal|0
decl_stmt|;
switch|switch
condition|(
name|NGI_MSG
argument_list|(
name|item
argument_list|)
operator|->
name|header
operator|.
name|typecookie
condition|)
block|{
case|case
name|NGM_HCI_COOKIE
case|:
switch|switch
condition|(
name|NGI_MSG
argument_list|(
name|item
argument_list|)
operator|->
name|header
operator|.
name|cmd
condition|)
block|{
case|case
name|NGM_HCI_LP_CON_REQ
case|:
name|error
operator|=
name|ng_hci_lp_con_req
argument_list|(
name|unit
argument_list|,
name|item
argument_list|,
name|lasthook
argument_list|)
expr_stmt|;
break|break;
case|case
name|NGM_HCI_LP_DISCON_REQ
case|:
comment|/* XXX not defined by specs */
name|error
operator|=
name|ng_hci_lp_discon_req
argument_list|(
name|unit
argument_list|,
name|item
argument_list|,
name|lasthook
argument_list|)
expr_stmt|;
break|break;
case|case
name|NGM_HCI_LP_CON_RSP
case|:
name|error
operator|=
name|ng_hci_lp_con_rsp
argument_list|(
name|unit
argument_list|,
name|item
argument_list|,
name|lasthook
argument_list|)
expr_stmt|;
break|break;
case|case
name|NGM_HCI_LP_QOS_REQ
case|:
name|error
operator|=
name|ng_hci_lp_qos_req
argument_list|(
name|unit
argument_list|,
name|item
argument_list|,
name|lasthook
argument_list|)
expr_stmt|;
break|break;
default|default:
name|error
operator|=
name|ng_hci_default_rcvmsg
argument_list|(
name|node
argument_list|,
name|item
argument_list|,
name|lasthook
argument_list|)
expr_stmt|;
break|break;
block|}
break|break;
default|default:
name|error
operator|=
name|ng_hci_default_rcvmsg
argument_list|(
name|node
argument_list|,
name|item
argument_list|,
name|lasthook
argument_list|)
expr_stmt|;
break|break;
block|}
return|return
operator|(
name|error
operator|)
return|;
block|}
end_function

begin_comment
comment|/* ng_hci_upper_rcvmsg */
end_comment

begin_comment
comment|/*  * Process data packet from the driver hook.   * We expect HCI events, ACL or SCO data packets.  */
end_comment

begin_function
specifier|static
name|int
name|ng_hci_drv_rcvdata
parameter_list|(
name|hook_p
name|hook
parameter_list|,
name|item_p
name|item
parameter_list|)
block|{
name|ng_hci_unit_p
name|unit
init|=
operator|(
name|ng_hci_unit_p
operator|)
name|NG_NODE_PRIVATE
argument_list|(
name|NG_HOOK_NODE
argument_list|(
name|hook
argument_list|)
argument_list|)
decl_stmt|;
name|struct
name|mbuf
modifier|*
name|m
init|=
name|NULL
decl_stmt|;
name|int
name|error
init|=
literal|0
decl_stmt|;
comment|/* Process packet */
name|m
operator|=
name|NGI_M
argument_list|(
name|item
argument_list|)
expr_stmt|;
comment|/* item still has mbuf, just peeking */
name|m
operator|->
name|m_flags
operator||=
name|M_PROTO1
expr_stmt|;
comment|/* mark as incoming packet */
name|NG_HCI_STAT_BYTES_RECV
argument_list|(
name|unit
operator|->
name|stat
argument_list|,
name|m
operator|->
name|m_pkthdr
operator|.
name|len
argument_list|)
expr_stmt|;
comment|/* Give copy packet to RAW hook */
name|ng_hci_mtap
argument_list|(
name|unit
argument_list|,
name|m
argument_list|)
expr_stmt|;
comment|/* 	 * XXX XXX XXX 	 * Lower layer drivers MUST NOT send mbuf chain with empty mbuf at 	 * the beginning of the chain. HCI layer WILL NOT call m_pullup() here. 	 */
switch|switch
condition|(
operator|*
name|mtod
argument_list|(
name|m
argument_list|,
name|u_int8_t
operator|*
argument_list|)
condition|)
block|{
case|case
name|NG_HCI_ACL_DATA_PKT
case|:
name|NG_HCI_STAT_ACL_RECV
argument_list|(
name|unit
operator|->
name|stat
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|unit
operator|->
name|state
operator|&
name|NG_HCI_UNIT_READY
operator|)
operator|!=
name|NG_HCI_UNIT_READY
operator|||
name|unit
operator|->
name|acl
operator|==
name|NULL
operator|||
name|NG_HOOK_NOT_VALID
argument_list|(
name|unit
operator|->
name|acl
argument_list|)
condition|)
block|{
name|NG_HCI_WARN
argument_list|(
literal|"%s: %s - could not forward HCI ACL data packet, state=%#x, hook=%p\n"
argument_list|,
name|__func__
argument_list|,
name|NG_NODE_NAME
argument_list|(
name|unit
operator|->
name|node
argument_list|)
argument_list|,
name|unit
operator|->
name|state
argument_list|,
name|unit
operator|->
name|acl
argument_list|)
expr_stmt|;
name|NG_FREE_ITEM
argument_list|(
name|item
argument_list|)
expr_stmt|;
block|}
else|else
name|NG_FWD_ITEM_HOOK
argument_list|(
name|error
argument_list|,
name|item
argument_list|,
name|unit
operator|->
name|acl
argument_list|)
expr_stmt|;
break|break;
case|case
name|NG_HCI_SCO_DATA_PKT
case|:
name|NG_HCI_STAT_SCO_RECV
argument_list|(
name|unit
operator|->
name|stat
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|unit
operator|->
name|state
operator|&
name|NG_HCI_UNIT_READY
operator|)
operator|!=
name|NG_HCI_UNIT_READY
operator|||
name|unit
operator|->
name|sco
operator|==
name|NULL
operator|||
name|NG_HOOK_NOT_VALID
argument_list|(
name|unit
operator|->
name|sco
argument_list|)
condition|)
block|{
name|NG_HCI_WARN
argument_list|(
literal|"%s: %s - could not forward HCI SCO data packet, state=%#x, hook=%p\n"
argument_list|,
name|__func__
argument_list|,
name|NG_NODE_NAME
argument_list|(
name|unit
operator|->
name|node
argument_list|)
argument_list|,
name|unit
operator|->
name|state
argument_list|,
name|unit
operator|->
name|sco
argument_list|)
expr_stmt|;
name|NG_FREE_ITEM
argument_list|(
name|item
argument_list|)
expr_stmt|;
block|}
else|else
name|NG_FWD_ITEM_HOOK
argument_list|(
name|error
argument_list|,
name|item
argument_list|,
name|unit
operator|->
name|sco
argument_list|)
expr_stmt|;
break|break;
case|case
name|NG_HCI_EVENT_PKT
case|:
name|NG_HCI_STAT_EVNT_RECV
argument_list|(
name|unit
operator|->
name|stat
argument_list|)
expr_stmt|;
comment|/* Detach mbuf, discard item and process event */
name|NGI_GET_M
argument_list|(
name|item
argument_list|,
name|m
argument_list|)
expr_stmt|;
name|NG_FREE_ITEM
argument_list|(
name|item
argument_list|)
expr_stmt|;
name|error
operator|=
name|ng_hci_process_event
argument_list|(
name|unit
argument_list|,
name|m
argument_list|)
expr_stmt|;
break|break;
default|default:
name|NG_HCI_ALERT
argument_list|(
literal|"%s: %s - got unknown HCI packet type=%#x\n"
argument_list|,
name|__func__
argument_list|,
name|NG_NODE_NAME
argument_list|(
name|unit
operator|->
name|node
argument_list|)
argument_list|,
operator|*
name|mtod
argument_list|(
name|m
argument_list|,
name|u_int8_t
operator|*
argument_list|)
argument_list|)
expr_stmt|;
name|NG_FREE_ITEM
argument_list|(
name|item
argument_list|)
expr_stmt|;
name|error
operator|=
name|EINVAL
expr_stmt|;
break|break;
block|}
return|return
operator|(
name|error
operator|)
return|;
block|}
end_function

begin_comment
comment|/* ng_hci_drv_rcvdata */
end_comment

begin_comment
comment|/*  * Process data packet from ACL upstream hook.  * We expect valid HCI ACL data packets.  */
end_comment

begin_function
specifier|static
name|int
name|ng_hci_acl_rcvdata
parameter_list|(
name|hook_p
name|hook
parameter_list|,
name|item_p
name|item
parameter_list|)
block|{
name|ng_hci_unit_p
name|unit
init|=
operator|(
name|ng_hci_unit_p
operator|)
name|NG_NODE_PRIVATE
argument_list|(
name|NG_HOOK_NODE
argument_list|(
name|hook
argument_list|)
argument_list|)
decl_stmt|;
name|struct
name|mbuf
modifier|*
name|m
init|=
name|NULL
decl_stmt|;
name|ng_hci_unit_con_p
name|con
init|=
name|NULL
decl_stmt|;
name|u_int16_t
name|con_handle
decl_stmt|;
name|int
name|size
decl_stmt|,
name|error
init|=
literal|0
decl_stmt|;
name|NG_HCI_BUFF_ACL_SIZE
argument_list|(
name|unit
operator|->
name|buffer
argument_list|,
name|size
argument_list|)
expr_stmt|;
comment|/* Check packet */
name|NGI_GET_M
argument_list|(
name|item
argument_list|,
name|m
argument_list|)
expr_stmt|;
if|if
condition|(
operator|*
name|mtod
argument_list|(
name|m
argument_list|,
name|u_int8_t
operator|*
argument_list|)
operator|!=
name|NG_HCI_ACL_DATA_PKT
condition|)
block|{
name|NG_HCI_ALERT
argument_list|(
literal|"%s: %s - invalid HCI data packet type=%#x\n"
argument_list|,
name|__func__
argument_list|,
name|NG_NODE_NAME
argument_list|(
name|unit
operator|->
name|node
argument_list|)
argument_list|,
operator|*
name|mtod
argument_list|(
name|m
argument_list|,
name|u_int8_t
operator|*
argument_list|)
argument_list|)
expr_stmt|;
name|error
operator|=
name|EINVAL
expr_stmt|;
goto|goto
name|drop
goto|;
block|}
if|if
condition|(
name|m
operator|->
name|m_pkthdr
operator|.
name|len
operator|<
sizeof|sizeof
argument_list|(
name|ng_hci_acldata_pkt_t
argument_list|)
operator|||
name|m
operator|->
name|m_pkthdr
operator|.
name|len
operator|>
sizeof|sizeof
argument_list|(
name|ng_hci_acldata_pkt_t
argument_list|)
operator|+
name|size
condition|)
block|{
name|NG_HCI_ALERT
argument_list|(
literal|"%s: %s - invalid HCI ACL data packet, len=%d, mtu=%d\n"
argument_list|,
name|__func__
argument_list|,
name|NG_NODE_NAME
argument_list|(
name|unit
operator|->
name|node
argument_list|)
argument_list|,
name|m
operator|->
name|m_pkthdr
operator|.
name|len
argument_list|,
name|size
argument_list|)
expr_stmt|;
name|error
operator|=
name|EMSGSIZE
expr_stmt|;
goto|goto
name|drop
goto|;
block|}
name|NG_HCI_M_PULLUP
argument_list|(
name|m
argument_list|,
sizeof|sizeof
argument_list|(
name|ng_hci_acldata_pkt_t
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|m
operator|==
name|NULL
condition|)
block|{
name|error
operator|=
name|ENOBUFS
expr_stmt|;
goto|goto
name|drop
goto|;
block|}
name|con_handle
operator|=
name|NG_HCI_CON_HANDLE
argument_list|(
name|le16toh
argument_list|(
name|mtod
argument_list|(
name|m
argument_list|,
name|ng_hci_acldata_pkt_t
operator|*
argument_list|)
operator|->
name|con_handle
argument_list|)
argument_list|)
expr_stmt|;
name|size
operator|=
name|le16toh
argument_list|(
name|mtod
argument_list|(
name|m
argument_list|,
name|ng_hci_acldata_pkt_t
operator|*
argument_list|)
operator|->
name|length
argument_list|)
expr_stmt|;
if|if
condition|(
name|m
operator|->
name|m_pkthdr
operator|.
name|len
operator|!=
sizeof|sizeof
argument_list|(
name|ng_hci_acldata_pkt_t
argument_list|)
operator|+
name|size
condition|)
block|{
name|NG_HCI_ALERT
argument_list|(
literal|"%s: %s - invalid HCI ACL data packet size, len=%d, length=%d\n"
argument_list|,
name|__func__
argument_list|,
name|NG_NODE_NAME
argument_list|(
name|unit
operator|->
name|node
argument_list|)
argument_list|,
name|m
operator|->
name|m_pkthdr
operator|.
name|len
argument_list|,
name|size
argument_list|)
expr_stmt|;
name|error
operator|=
name|EMSGSIZE
expr_stmt|;
goto|goto
name|drop
goto|;
block|}
comment|/* Queue packet */
name|con
operator|=
name|ng_hci_con_by_handle
argument_list|(
name|unit
argument_list|,
name|con_handle
argument_list|)
expr_stmt|;
if|if
condition|(
name|con
operator|==
name|NULL
condition|)
block|{
name|NG_HCI_ERR
argument_list|(
literal|"%s: %s - unexpected HCI ACL data packet. Connection does not exists, "
expr|\
literal|"con_handle=%d\n"
argument_list|,
name|__func__
argument_list|,
name|NG_NODE_NAME
argument_list|(
name|unit
operator|->
name|node
argument_list|)
argument_list|,
name|con_handle
argument_list|)
expr_stmt|;
name|error
operator|=
name|ENOENT
expr_stmt|;
goto|goto
name|drop
goto|;
block|}
if|if
condition|(
name|con
operator|->
name|link_type
operator|!=
name|NG_HCI_LINK_ACL
condition|)
block|{
name|NG_HCI_ERR
argument_list|(
literal|"%s: %s - unexpected HCI ACL data packet. Not ACL link, con_handle=%d, "
expr|\
literal|"link_type=%d\n"
argument_list|,
name|__func__
argument_list|,
name|NG_NODE_NAME
argument_list|(
name|unit
operator|->
name|node
argument_list|)
argument_list|,
name|con_handle
argument_list|,
name|con
operator|->
name|link_type
argument_list|)
expr_stmt|;
name|error
operator|=
name|EINVAL
expr_stmt|;
goto|goto
name|drop
goto|;
block|}
if|if
condition|(
name|con
operator|->
name|state
operator|!=
name|NG_HCI_CON_OPEN
condition|)
block|{
name|NG_HCI_ERR
argument_list|(
literal|"%s: %s - unexpected HCI ACL data packet. Invalid connection state=%d, "
expr|\
literal|"con_handle=%d\n"
argument_list|,
name|__func__
argument_list|,
name|NG_NODE_NAME
argument_list|(
name|unit
operator|->
name|node
argument_list|)
argument_list|,
name|con
operator|->
name|state
argument_list|,
name|con_handle
argument_list|)
expr_stmt|;
name|error
operator|=
name|EHOSTDOWN
expr_stmt|;
goto|goto
name|drop
goto|;
block|}
if|if
condition|(
name|NG_BT_ITEMQ_FULL
argument_list|(
operator|&
name|con
operator|->
name|conq
argument_list|)
condition|)
block|{
name|NG_HCI_ALERT
argument_list|(
literal|"%s: %s - dropping HCI ACL data packet, con_handle=%d, len=%d, queue_len=%d\n"
argument_list|,
name|__func__
argument_list|,
name|NG_NODE_NAME
argument_list|(
name|unit
operator|->
name|node
argument_list|)
argument_list|,
name|con_handle
argument_list|,
name|m
operator|->
name|m_pkthdr
operator|.
name|len
argument_list|,
name|NG_BT_ITEMQ_LEN
argument_list|(
operator|&
name|con
operator|->
name|conq
argument_list|)
argument_list|)
expr_stmt|;
name|NG_BT_ITEMQ_DROP
argument_list|(
operator|&
name|con
operator|->
name|conq
argument_list|)
expr_stmt|;
name|error
operator|=
name|ENOBUFS
expr_stmt|;
goto|goto
name|drop
goto|;
block|}
comment|/* Queue item and schedule data transfer */
name|NGI_M
argument_list|(
name|item
argument_list|)
operator|=
name|m
expr_stmt|;
name|NG_BT_ITEMQ_ENQUEUE
argument_list|(
operator|&
name|con
operator|->
name|conq
argument_list|,
name|item
argument_list|)
expr_stmt|;
name|item
operator|=
name|NULL
expr_stmt|;
name|m
operator|=
name|NULL
expr_stmt|;
name|ng_hci_send_data
argument_list|(
name|unit
argument_list|)
expr_stmt|;
name|drop
label|:
if|if
condition|(
name|item
operator|!=
name|NULL
condition|)
name|NG_FREE_ITEM
argument_list|(
name|item
argument_list|)
expr_stmt|;
name|NG_FREE_M
argument_list|(
name|m
argument_list|)
expr_stmt|;
comment|/* NG_FREE_M() checks for m != NULL */
return|return
operator|(
name|error
operator|)
return|;
block|}
end_function

begin_comment
comment|/* ng_hci_acl_rcvdata */
end_comment

begin_comment
comment|/*  * Process data packet from SCO upstream hook.  * We expect valid HCI SCO data packets  */
end_comment

begin_function
specifier|static
name|int
name|ng_hci_sco_rcvdata
parameter_list|(
name|hook_p
name|hook
parameter_list|,
name|item_p
name|item
parameter_list|)
block|{
name|ng_hci_unit_p
name|unit
init|=
operator|(
name|ng_hci_unit_p
operator|)
name|NG_NODE_PRIVATE
argument_list|(
name|NG_HOOK_NODE
argument_list|(
name|hook
argument_list|)
argument_list|)
decl_stmt|;
name|struct
name|mbuf
modifier|*
name|m
init|=
name|NULL
decl_stmt|;
name|ng_hci_unit_con_p
name|con
init|=
name|NULL
decl_stmt|;
name|u_int16_t
name|con_handle
decl_stmt|;
name|int
name|size
decl_stmt|,
name|error
init|=
literal|0
decl_stmt|;
name|NG_HCI_BUFF_SCO_SIZE
argument_list|(
name|unit
operator|->
name|buffer
argument_list|,
name|size
argument_list|)
expr_stmt|;
comment|/* Check packet */
name|NGI_GET_M
argument_list|(
name|item
argument_list|,
name|m
argument_list|)
expr_stmt|;
if|if
condition|(
operator|*
name|mtod
argument_list|(
name|m
argument_list|,
name|u_int8_t
operator|*
argument_list|)
operator|!=
name|NG_HCI_SCO_DATA_PKT
condition|)
block|{
name|NG_HCI_ALERT
argument_list|(
literal|"%s: %s - invalid HCI data packet type=%#x\n"
argument_list|,
name|__func__
argument_list|,
name|NG_NODE_NAME
argument_list|(
name|unit
operator|->
name|node
argument_list|)
argument_list|,
operator|*
name|mtod
argument_list|(
name|m
argument_list|,
name|u_int8_t
operator|*
argument_list|)
argument_list|)
expr_stmt|;
name|error
operator|=
name|EINVAL
expr_stmt|;
goto|goto
name|drop
goto|;
block|}
if|if
condition|(
name|m
operator|->
name|m_pkthdr
operator|.
name|len
operator|<
sizeof|sizeof
argument_list|(
name|ng_hci_scodata_pkt_t
argument_list|)
operator|||
name|m
operator|->
name|m_pkthdr
operator|.
name|len
operator|>
sizeof|sizeof
argument_list|(
name|ng_hci_scodata_pkt_t
argument_list|)
operator|+
name|size
condition|)
block|{
name|NG_HCI_ALERT
argument_list|(
literal|"%s: %s - invalid HCI SCO data packet, len=%d, mtu=%d\n"
argument_list|,
name|__func__
argument_list|,
name|NG_NODE_NAME
argument_list|(
name|unit
operator|->
name|node
argument_list|)
argument_list|,
name|m
operator|->
name|m_pkthdr
operator|.
name|len
argument_list|,
name|size
argument_list|)
expr_stmt|;
name|error
operator|=
name|EMSGSIZE
expr_stmt|;
goto|goto
name|drop
goto|;
block|}
name|NG_HCI_M_PULLUP
argument_list|(
name|m
argument_list|,
sizeof|sizeof
argument_list|(
name|ng_hci_scodata_pkt_t
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|m
operator|==
name|NULL
condition|)
block|{
name|error
operator|=
name|ENOBUFS
expr_stmt|;
goto|goto
name|drop
goto|;
block|}
name|con_handle
operator|=
name|NG_HCI_CON_HANDLE
argument_list|(
name|le16toh
argument_list|(
name|mtod
argument_list|(
name|m
argument_list|,
name|ng_hci_scodata_pkt_t
operator|*
argument_list|)
operator|->
name|con_handle
argument_list|)
argument_list|)
expr_stmt|;
name|size
operator|=
name|mtod
argument_list|(
name|m
argument_list|,
name|ng_hci_scodata_pkt_t
operator|*
argument_list|)
operator|->
name|length
expr_stmt|;
if|if
condition|(
name|m
operator|->
name|m_pkthdr
operator|.
name|len
operator|!=
sizeof|sizeof
argument_list|(
name|ng_hci_scodata_pkt_t
argument_list|)
operator|+
name|size
condition|)
block|{
name|NG_HCI_ALERT
argument_list|(
literal|"%s: %s - invalid HCI SCO data packet size, len=%d, length=%d\n"
argument_list|,
name|__func__
argument_list|,
name|NG_NODE_NAME
argument_list|(
name|unit
operator|->
name|node
argument_list|)
argument_list|,
name|m
operator|->
name|m_pkthdr
operator|.
name|len
argument_list|,
name|size
argument_list|)
expr_stmt|;
name|error
operator|=
name|EMSGSIZE
expr_stmt|;
goto|goto
name|drop
goto|;
block|}
comment|/* Queue packet */
name|con
operator|=
name|ng_hci_con_by_handle
argument_list|(
name|unit
argument_list|,
name|con_handle
argument_list|)
expr_stmt|;
if|if
condition|(
name|con
operator|==
name|NULL
condition|)
block|{
name|NG_HCI_ERR
argument_list|(
literal|"%s: %s - unexpected HCI SCO data packet. Connection does not exists, "
expr|\
literal|"con_handle=%d\n"
argument_list|,
name|__func__
argument_list|,
name|NG_NODE_NAME
argument_list|(
name|unit
operator|->
name|node
argument_list|)
argument_list|,
name|con_handle
argument_list|)
expr_stmt|;
name|error
operator|=
name|ENOENT
expr_stmt|;
goto|goto
name|drop
goto|;
block|}
if|if
condition|(
name|con
operator|->
name|link_type
operator|!=
name|NG_HCI_LINK_SCO
condition|)
block|{
name|NG_HCI_ERR
argument_list|(
literal|"%s: %s - unexpected HCI SCO data packet. Not SCO link, con_handle=%d, "
expr|\
literal|"link_type=%d\n"
argument_list|,
name|__func__
argument_list|,
name|NG_NODE_NAME
argument_list|(
name|unit
operator|->
name|node
argument_list|)
argument_list|,
name|con_handle
argument_list|,
name|con
operator|->
name|link_type
argument_list|)
expr_stmt|;
name|error
operator|=
name|EINVAL
expr_stmt|;
goto|goto
name|drop
goto|;
block|}
if|if
condition|(
name|con
operator|->
name|state
operator|!=
name|NG_HCI_CON_OPEN
condition|)
block|{
name|NG_HCI_ERR
argument_list|(
literal|"%s: %s - unexpected HCI SCO data packet. Invalid connection state=%d, "
expr|\
literal|"con_handle=%d\n"
argument_list|,
name|__func__
argument_list|,
name|NG_NODE_NAME
argument_list|(
name|unit
operator|->
name|node
argument_list|)
argument_list|,
name|con
operator|->
name|state
argument_list|,
name|con_handle
argument_list|)
expr_stmt|;
name|error
operator|=
name|EHOSTDOWN
expr_stmt|;
goto|goto
name|drop
goto|;
block|}
if|if
condition|(
name|NG_BT_ITEMQ_FULL
argument_list|(
operator|&
name|con
operator|->
name|conq
argument_list|)
condition|)
block|{
name|NG_HCI_ALERT
argument_list|(
literal|"%s: %s - dropping HCI SCO data packet, con_handle=%d, len=%d, queue_len=%d\n"
argument_list|,
name|__func__
argument_list|,
name|NG_NODE_NAME
argument_list|(
name|unit
operator|->
name|node
argument_list|)
argument_list|,
name|con_handle
argument_list|,
name|m
operator|->
name|m_pkthdr
operator|.
name|len
argument_list|,
name|NG_BT_ITEMQ_LEN
argument_list|(
operator|&
name|con
operator|->
name|conq
argument_list|)
argument_list|)
expr_stmt|;
name|NG_BT_ITEMQ_DROP
argument_list|(
operator|&
name|con
operator|->
name|conq
argument_list|)
expr_stmt|;
name|error
operator|=
name|ENOBUFS
expr_stmt|;
goto|goto
name|drop
goto|;
block|}
comment|/* Queue item and schedule data transfer */
name|NGI_M
argument_list|(
name|item
argument_list|)
operator|=
name|m
expr_stmt|;
name|NG_BT_ITEMQ_ENQUEUE
argument_list|(
operator|&
name|con
operator|->
name|conq
argument_list|,
name|item
argument_list|)
expr_stmt|;
name|item
operator|=
name|NULL
expr_stmt|;
name|m
operator|=
name|NULL
expr_stmt|;
name|ng_hci_send_data
argument_list|(
name|unit
argument_list|)
expr_stmt|;
name|drop
label|:
if|if
condition|(
name|item
operator|!=
name|NULL
condition|)
name|NG_FREE_ITEM
argument_list|(
name|item
argument_list|)
expr_stmt|;
name|NG_FREE_M
argument_list|(
name|m
argument_list|)
expr_stmt|;
comment|/* NG_FREE_M() checks for m != NULL */
return|return
operator|(
name|error
operator|)
return|;
block|}
end_function

begin_comment
comment|/* ng_hci_sco_rcvdata */
end_comment

begin_comment
comment|/*  * Process data packet from uptream RAW hook.  * We expect valid HCI command packets.  */
end_comment

begin_function
specifier|static
name|int
name|ng_hci_raw_rcvdata
parameter_list|(
name|hook_p
name|hook
parameter_list|,
name|item_p
name|item
parameter_list|)
block|{
name|ng_hci_unit_p
name|unit
init|=
operator|(
name|ng_hci_unit_p
operator|)
name|NG_NODE_PRIVATE
argument_list|(
name|NG_HOOK_NODE
argument_list|(
name|hook
argument_list|)
argument_list|)
decl_stmt|;
name|struct
name|mbuf
modifier|*
name|m
init|=
name|NULL
decl_stmt|;
name|int
name|error
init|=
literal|0
decl_stmt|;
name|NGI_GET_M
argument_list|(
name|item
argument_list|,
name|m
argument_list|)
expr_stmt|;
name|NG_FREE_ITEM
argument_list|(
name|item
argument_list|)
expr_stmt|;
comment|/* Check packet */
if|if
condition|(
operator|*
name|mtod
argument_list|(
name|m
argument_list|,
name|u_int8_t
operator|*
argument_list|)
operator|!=
name|NG_HCI_CMD_PKT
condition|)
block|{
name|NG_HCI_ALERT
argument_list|(
literal|"%s: %s - invalid HCI command packet type=%#x\n"
argument_list|,
name|__func__
argument_list|,
name|NG_NODE_NAME
argument_list|(
name|unit
operator|->
name|node
argument_list|)
argument_list|,
operator|*
name|mtod
argument_list|(
name|m
argument_list|,
name|u_int8_t
operator|*
argument_list|)
argument_list|)
expr_stmt|;
name|error
operator|=
name|EINVAL
expr_stmt|;
goto|goto
name|drop
goto|;
block|}
if|if
condition|(
name|m
operator|->
name|m_pkthdr
operator|.
name|len
operator|<
sizeof|sizeof
argument_list|(
name|ng_hci_cmd_pkt_t
argument_list|)
condition|)
block|{
name|NG_HCI_ALERT
argument_list|(
literal|"%s: %s - invalid HCI command packet len=%d\n"
argument_list|,
name|__func__
argument_list|,
name|NG_NODE_NAME
argument_list|(
name|unit
operator|->
name|node
argument_list|)
argument_list|,
name|m
operator|->
name|m_pkthdr
operator|.
name|len
argument_list|)
expr_stmt|;
name|error
operator|=
name|EMSGSIZE
expr_stmt|;
goto|goto
name|drop
goto|;
block|}
name|NG_HCI_M_PULLUP
argument_list|(
name|m
argument_list|,
sizeof|sizeof
argument_list|(
name|ng_hci_cmd_pkt_t
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|m
operator|==
name|NULL
condition|)
block|{
name|error
operator|=
name|ENOBUFS
expr_stmt|;
goto|goto
name|drop
goto|;
block|}
if|if
condition|(
name|m
operator|->
name|m_pkthdr
operator|.
name|len
operator|!=
name|mtod
argument_list|(
name|m
argument_list|,
name|ng_hci_cmd_pkt_t
operator|*
argument_list|)
operator|->
name|length
operator|+
sizeof|sizeof
argument_list|(
name|ng_hci_cmd_pkt_t
argument_list|)
condition|)
block|{
name|NG_HCI_ALERT
argument_list|(
literal|"%s: %s - invalid HCI command packet size, len=%d, length=%d\n"
argument_list|,
name|__func__
argument_list|,
name|NG_NODE_NAME
argument_list|(
name|unit
operator|->
name|node
argument_list|)
argument_list|,
name|m
operator|->
name|m_pkthdr
operator|.
name|len
argument_list|,
name|mtod
argument_list|(
name|m
argument_list|,
name|ng_hci_cmd_pkt_t
operator|*
argument_list|)
operator|->
name|length
argument_list|)
expr_stmt|;
name|error
operator|=
name|EMSGSIZE
expr_stmt|;
goto|goto
name|drop
goto|;
block|}
if|if
condition|(
name|mtod
argument_list|(
name|m
argument_list|,
name|ng_hci_cmd_pkt_t
operator|*
argument_list|)
operator|->
name|opcode
operator|==
literal|0
condition|)
block|{
name|NG_HCI_ALERT
argument_list|(
literal|"%s: %s - invalid HCI command opcode\n"
argument_list|,
name|__func__
argument_list|,
name|NG_NODE_NAME
argument_list|(
name|unit
operator|->
name|node
argument_list|)
argument_list|)
expr_stmt|;
name|error
operator|=
name|EINVAL
expr_stmt|;
goto|goto
name|drop
goto|;
block|}
if|if
condition|(
name|NG_BT_MBUFQ_FULL
argument_list|(
operator|&
name|unit
operator|->
name|cmdq
argument_list|)
condition|)
block|{
name|NG_HCI_ALERT
argument_list|(
literal|"%s: %s - dropping HCI command packet, len=%d, queue_len=%d\n"
argument_list|,
name|__func__
argument_list|,
name|NG_NODE_NAME
argument_list|(
name|unit
operator|->
name|node
argument_list|)
argument_list|,
name|m
operator|->
name|m_pkthdr
operator|.
name|len
argument_list|,
name|NG_BT_MBUFQ_LEN
argument_list|(
operator|&
name|unit
operator|->
name|cmdq
argument_list|)
argument_list|)
expr_stmt|;
name|NG_BT_MBUFQ_DROP
argument_list|(
operator|&
name|unit
operator|->
name|cmdq
argument_list|)
expr_stmt|;
name|error
operator|=
name|ENOBUFS
expr_stmt|;
goto|goto
name|drop
goto|;
block|}
comment|/* Queue and send command */
name|NG_BT_MBUFQ_ENQUEUE
argument_list|(
operator|&
name|unit
operator|->
name|cmdq
argument_list|,
name|m
argument_list|)
expr_stmt|;
name|m
operator|=
name|NULL
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|unit
operator|->
name|state
operator|&
name|NG_HCI_UNIT_COMMAND_PENDING
operator|)
condition|)
name|error
operator|=
name|ng_hci_send_command
argument_list|(
name|unit
argument_list|)
expr_stmt|;
name|drop
label|:
name|NG_FREE_M
argument_list|(
name|m
argument_list|)
expr_stmt|;
comment|/* NG_FREE_M() checks for m != NULL */
return|return
operator|(
name|error
operator|)
return|;
block|}
end_function

begin_comment
comment|/* ng_hci_raw_rcvdata */
end_comment

end_unit


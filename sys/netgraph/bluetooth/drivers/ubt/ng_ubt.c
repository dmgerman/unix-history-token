begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * ng_ubt.c  */
end_comment

begin_comment
comment|/*-  * Copyright (c) 2001-2002 Maksim Yevmenkin<m_evmenkin@yahoo.com>  * All rights reserved.  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions  * are met:  * 1. Redistributions of source code must retain the above copyright  *    notice, this list of conditions and the following disclaimer.  * 2. Redistributions in binary form must reproduce the above copyright  *    notice, this list of conditions and the following disclaimer in the  *    documentation and/or other materials provided with the distribution.  *  * THIS SOFTWARE IS PROVIDED BY THE AUTHOR AND CONTRIBUTORS ``AS IS'' AND  * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE  * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE  * ARE DISCLAIMED. IN NO EVENT SHALL THE AUTHOR OR CONTRIBUTORS BE LIABLE  * FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL  * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS  * OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)  * HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT  * LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY  * OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF  * SUCH DAMAGE.  *  * $Id: ng_ubt.c,v 1.16 2003/10/10 19:15:06 max Exp $  * $FreeBSD$  */
end_comment

begin_include
include|#
directive|include
file|<sys/param.h>
end_include

begin_include
include|#
directive|include
file|<sys/systm.h>
end_include

begin_include
include|#
directive|include
file|<sys/bus.h>
end_include

begin_include
include|#
directive|include
file|<sys/conf.h>
end_include

begin_include
include|#
directive|include
file|<sys/endian.h>
end_include

begin_include
include|#
directive|include
file|<sys/filio.h>
end_include

begin_include
include|#
directive|include
file|<sys/fcntl.h>
end_include

begin_include
include|#
directive|include
file|<sys/mbuf.h>
end_include

begin_include
include|#
directive|include
file|<sys/malloc.h>
end_include

begin_include
include|#
directive|include
file|<sys/kernel.h>
end_include

begin_include
include|#
directive|include
file|<sys/module.h>
end_include

begin_include
include|#
directive|include
file|<sys/poll.h>
end_include

begin_include
include|#
directive|include
file|<sys/uio.h>
end_include

begin_include
include|#
directive|include
file|<machine/bus.h>
end_include

begin_include
include|#
directive|include
file|<dev/usb/usb.h>
end_include

begin_include
include|#
directive|include
file|<dev/usb/usbdi.h>
end_include

begin_include
include|#
directive|include
file|<dev/usb/usbdi_util.h>
end_include

begin_include
include|#
directive|include
file|<dev/usb/usbdivar.h>
end_include

begin_include
include|#
directive|include
file|<netgraph/ng_message.h>
end_include

begin_include
include|#
directive|include
file|<netgraph/netgraph.h>
end_include

begin_include
include|#
directive|include
file|<netgraph/ng_parse.h>
end_include

begin_include
include|#
directive|include
file|<netgraph/bluetooth/include/ng_bluetooth.h>
end_include

begin_include
include|#
directive|include
file|<netgraph/bluetooth/include/ng_hci.h>
end_include

begin_include
include|#
directive|include
file|<netgraph/bluetooth/include/ng_ubt.h>
end_include

begin_include
include|#
directive|include
file|<netgraph/bluetooth/drivers/ubt/ng_ubt_var.h>
end_include

begin_include
include|#
directive|include
file|"usbdevs.h"
end_include

begin_comment
comment|/*  * USB methods  */
end_comment

begin_expr_stmt
name|USB_DECLARE_DRIVER
argument_list|(
name|ubt
argument_list|)
expr_stmt|;
end_expr_stmt

begin_function_decl
name|Static
name|int
name|ubt_modevent
parameter_list|(
name|module_t
parameter_list|,
name|int
parameter_list|,
name|void
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|Static
name|usbd_status
name|ubt_request_start
parameter_list|(
name|ubt_softc_p
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|Static
name|void
name|ubt_request_complete
parameter_list|(
name|usbd_xfer_handle
parameter_list|,
name|usbd_private_handle
parameter_list|,
name|usbd_status
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|Static
name|void
name|ubt_request_complete2
parameter_list|(
name|node_p
parameter_list|,
name|hook_p
parameter_list|,
name|void
modifier|*
parameter_list|,
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|Static
name|usbd_status
name|ubt_intr_start
parameter_list|(
name|ubt_softc_p
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|Static
name|void
name|ubt_intr_complete
parameter_list|(
name|usbd_xfer_handle
parameter_list|,
name|usbd_private_handle
parameter_list|,
name|usbd_status
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|Static
name|void
name|ubt_intr_complete2
parameter_list|(
name|node_p
parameter_list|,
name|hook_p
parameter_list|,
name|void
modifier|*
parameter_list|,
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|Static
name|usbd_status
name|ubt_bulk_in_start
parameter_list|(
name|ubt_softc_p
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|Static
name|void
name|ubt_bulk_in_complete
parameter_list|(
name|usbd_xfer_handle
parameter_list|,
name|usbd_private_handle
parameter_list|,
name|usbd_status
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|Static
name|void
name|ubt_bulk_in_complete2
parameter_list|(
name|node_p
parameter_list|,
name|hook_p
parameter_list|,
name|void
modifier|*
parameter_list|,
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|Static
name|usbd_status
name|ubt_bulk_out_start
parameter_list|(
name|ubt_softc_p
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|Static
name|void
name|ubt_bulk_out_complete
parameter_list|(
name|usbd_xfer_handle
parameter_list|,
name|usbd_private_handle
parameter_list|,
name|usbd_status
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|Static
name|void
name|ubt_bulk_out_complete2
parameter_list|(
name|node_p
parameter_list|,
name|hook_p
parameter_list|,
name|void
modifier|*
parameter_list|,
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|Static
name|usbd_status
name|ubt_isoc_in_start
parameter_list|(
name|ubt_softc_p
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|Static
name|void
name|ubt_isoc_in_complete
parameter_list|(
name|usbd_xfer_handle
parameter_list|,
name|usbd_private_handle
parameter_list|,
name|usbd_status
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|Static
name|void
name|ubt_isoc_in_complete2
parameter_list|(
name|node_p
parameter_list|,
name|hook_p
parameter_list|,
name|void
modifier|*
parameter_list|,
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|Static
name|usbd_status
name|ubt_isoc_out_start
parameter_list|(
name|ubt_softc_p
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|Static
name|void
name|ubt_isoc_out_complete
parameter_list|(
name|usbd_xfer_handle
parameter_list|,
name|usbd_private_handle
parameter_list|,
name|usbd_status
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|Static
name|void
name|ubt_isoc_out_complete2
parameter_list|(
name|node_p
parameter_list|,
name|hook_p
parameter_list|,
name|void
modifier|*
parameter_list|,
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|Static
name|void
name|ubt_reset
parameter_list|(
name|ubt_softc_p
parameter_list|)
function_decl|;
end_function_decl

begin_comment
comment|/*  * Netgraph methods  */
end_comment

begin_decl_stmt
name|Static
name|ng_constructor_t
name|ng_ubt_constructor
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|Static
name|ng_shutdown_t
name|ng_ubt_shutdown
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|Static
name|ng_newhook_t
name|ng_ubt_newhook
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|Static
name|ng_connect_t
name|ng_ubt_connect
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|Static
name|ng_disconnect_t
name|ng_ubt_disconnect
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|Static
name|ng_rcvmsg_t
name|ng_ubt_rcvmsg
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|Static
name|ng_rcvdata_t
name|ng_ubt_rcvdata
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* Queue length */
end_comment

begin_expr_stmt
name|Static
specifier|const
expr|struct
name|ng_parse_struct_field
name|ng_ubt_node_qlen_type_fields
index|[]
operator|=
block|{
block|{
literal|"queue"
block|,
operator|&
name|ng_parse_int32_type
block|, }
block|,
block|{
literal|"qlen"
block|,
operator|&
name|ng_parse_int32_type
block|, }
block|,
block|{
name|NULL
block|, }
block|}
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|Static
specifier|const
expr|struct
name|ng_parse_type
name|ng_ubt_node_qlen_type
operator|=
block|{
operator|&
name|ng_parse_struct_type
block|,
operator|&
name|ng_ubt_node_qlen_type_fields
block|}
expr_stmt|;
end_expr_stmt

begin_comment
comment|/* Stat info */
end_comment

begin_expr_stmt
name|Static
specifier|const
expr|struct
name|ng_parse_struct_field
name|ng_ubt_node_stat_type_fields
index|[]
operator|=
block|{
block|{
literal|"pckts_recv"
block|,
operator|&
name|ng_parse_uint32_type
block|, }
block|,
block|{
literal|"bytes_recv"
block|,
operator|&
name|ng_parse_uint32_type
block|, }
block|,
block|{
literal|"pckts_sent"
block|,
operator|&
name|ng_parse_uint32_type
block|, }
block|,
block|{
literal|"bytes_sent"
block|,
operator|&
name|ng_parse_uint32_type
block|, }
block|,
block|{
literal|"oerrors"
block|,
operator|&
name|ng_parse_uint32_type
block|, }
block|,
block|{
literal|"ierrors"
block|,
operator|&
name|ng_parse_uint32_type
block|, }
block|,
block|{
name|NULL
block|, }
block|}
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|Static
specifier|const
expr|struct
name|ng_parse_type
name|ng_ubt_node_stat_type
operator|=
block|{
operator|&
name|ng_parse_struct_type
block|,
operator|&
name|ng_ubt_node_stat_type_fields
block|}
expr_stmt|;
end_expr_stmt

begin_comment
comment|/* Netgraph node command list */
end_comment

begin_expr_stmt
name|Static
specifier|const
expr|struct
name|ng_cmdlist
name|ng_ubt_cmdlist
index|[]
operator|=
block|{
block|{
name|NGM_UBT_COOKIE
block|,
name|NGM_UBT_NODE_SET_DEBUG
block|,
literal|"set_debug"
block|,
operator|&
name|ng_parse_uint16_type
block|,
name|NULL
block|}
block|,
block|{
name|NGM_UBT_COOKIE
block|,
name|NGM_UBT_NODE_GET_DEBUG
block|,
literal|"get_debug"
block|,
name|NULL
block|,
operator|&
name|ng_parse_uint16_type
block|}
block|,
block|{
name|NGM_UBT_COOKIE
block|,
name|NGM_UBT_NODE_SET_QLEN
block|,
literal|"set_qlen"
block|,
operator|&
name|ng_ubt_node_qlen_type
block|,
name|NULL
block|}
block|,
block|{
name|NGM_UBT_COOKIE
block|,
name|NGM_UBT_NODE_GET_QLEN
block|,
literal|"get_qlen"
block|,
operator|&
name|ng_ubt_node_qlen_type
block|,
operator|&
name|ng_ubt_node_qlen_type
block|}
block|,
block|{
name|NGM_UBT_COOKIE
block|,
name|NGM_UBT_NODE_GET_STAT
block|,
literal|"get_stat"
block|,
name|NULL
block|,
operator|&
name|ng_ubt_node_stat_type
block|}
block|,
block|{
name|NGM_UBT_COOKIE
block|,
name|NGM_UBT_NODE_RESET_STAT
block|,
literal|"reset_stat"
block|,
name|NULL
block|,
name|NULL
block|}
block|,
block|{
literal|0
block|, }
block|}
expr_stmt|;
end_expr_stmt

begin_comment
comment|/* Netgraph node type */
end_comment

begin_decl_stmt
name|Static
name|struct
name|ng_type
name|typestruct
init|=
block|{
operator|.
name|version
operator|=
name|NG_ABI_VERSION
block|,
operator|.
name|name
operator|=
name|NG_UBT_NODE_TYPE
block|,
operator|.
name|constructor
operator|=
name|ng_ubt_constructor
block|,
operator|.
name|rcvmsg
operator|=
name|ng_ubt_rcvmsg
block|,
operator|.
name|shutdown
operator|=
name|ng_ubt_shutdown
block|,
operator|.
name|newhook
operator|=
name|ng_ubt_newhook
block|,
operator|.
name|connect
operator|=
name|ng_ubt_connect
block|,
operator|.
name|rcvdata
operator|=
name|ng_ubt_rcvdata
block|,
operator|.
name|disconnect
operator|=
name|ng_ubt_disconnect
block|,
operator|.
name|cmdlist
operator|=
name|ng_ubt_cmdlist
block|}
decl_stmt|;
end_decl_stmt

begin_comment
comment|/*  * Module  */
end_comment

begin_expr_stmt
name|DRIVER_MODULE
argument_list|(
name|ubt
argument_list|,
name|uhub
argument_list|,
name|ubt_driver
argument_list|,
name|ubt_devclass
argument_list|,
name|ubt_modevent
argument_list|,
literal|0
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|MODULE_VERSION
argument_list|(
name|ng_ubt
argument_list|,
name|NG_BLUETOOTH_VERSION
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|MODULE_DEPEND
argument_list|(
name|ng_ubt
argument_list|,
name|netgraph
argument_list|,
name|NG_ABI_VERSION
argument_list|,
name|NG_ABI_VERSION
argument_list|,
name|NG_ABI_VERSION
argument_list|)
expr_stmt|;
end_expr_stmt

begin_comment
comment|/****************************************************************************  ****************************************************************************  **                              USB specific  ****************************************************************************  ****************************************************************************/
end_comment

begin_comment
comment|/*  * Load/Unload the driver module  */
end_comment

begin_function
name|Static
name|int
name|ubt_modevent
parameter_list|(
name|module_t
name|mod
parameter_list|,
name|int
name|event
parameter_list|,
name|void
modifier|*
name|data
parameter_list|)
block|{
name|int
name|error
decl_stmt|;
switch|switch
condition|(
name|event
condition|)
block|{
case|case
name|MOD_LOAD
case|:
name|error
operator|=
name|ng_newtype
argument_list|(
operator|&
name|typestruct
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|!=
literal|0
condition|)
name|printf
argument_list|(
literal|"%s: Could not register Netgraph node type, error=%d\n"
argument_list|,
name|NG_UBT_NODE_TYPE
argument_list|,
name|error
argument_list|)
expr_stmt|;
else|else
name|error
operator|=
name|usbd_driver_load
argument_list|(
name|mod
argument_list|,
name|event
argument_list|,
name|data
argument_list|)
expr_stmt|;
break|break;
case|case
name|MOD_UNLOAD
case|:
name|error
operator|=
name|ng_rmtype
argument_list|(
operator|&
name|typestruct
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|==
literal|0
condition|)
name|error
operator|=
name|usbd_driver_load
argument_list|(
name|mod
argument_list|,
name|event
argument_list|,
name|data
argument_list|)
expr_stmt|;
break|break;
default|default:
name|error
operator|=
name|EOPNOTSUPP
expr_stmt|;
break|break;
block|}
return|return
operator|(
name|error
operator|)
return|;
block|}
end_function

begin_comment
comment|/* ubt_modevent */
end_comment

begin_comment
comment|/*  * Probe for a USB Bluetooth device  */
end_comment

begin_macro
name|USB_MATCH
argument_list|(
argument|ubt
argument_list|)
end_macro

begin_block
block|{
comment|/* 	 * If for some reason device should not be attached then put 	 * VendorID/ProductID pair into the list below. The format is 	 * as follows: 	 * 	 *	{ VENDOR_ID, PRODUCT_ID }, 	 * 	 * where VENDOR_ID and PRODUCT_ID are hex numbers. 	 */
name|Static
name|struct
name|usb_devno
specifier|const
name|ubt_ignored_devices
index|[]
init|=
block|{
block|{
name|USB_VENDOR_AVM
block|,
literal|0x2200
block|}
block|,
comment|/* AVM USB Bluetooth-Adapter BlueFritz! v1.0 */
block|{
literal|0
block|,
literal|0
block|}
comment|/* This should be the last item in the list */
block|}
decl_stmt|;
comment|/* 	 * If device violates Bluetooth specification and has bDeviceClass, 	 * bDeviceSubClass and bDeviceProtocol set to wrong values then you 	 * could try to put VendorID/ProductID pair into the list below. 	 * Adding VendorID/ProductID pair into this list forces ng_ubt(4) 	 * to attach to the broken device. 	 */
name|Static
name|struct
name|usb_devno
specifier|const
name|ubt_broken_devices
index|[]
init|=
block|{
block|{
name|USB_VENDOR_AVM
block|,
literal|0x3800
block|}
block|,
comment|/* AVM USB Bluetooth-Adapter BlueFritz! v2.0 */
block|{
literal|0
block|,
literal|0
block|}
comment|/* This should be the last item in the list */
block|}
decl_stmt|;
name|USB_MATCH_START
argument_list|(
name|ubt
argument_list|,
name|uaa
argument_list|)
expr_stmt|;
name|usb_device_descriptor_t
modifier|*
name|dd
init|=
name|usbd_get_device_descriptor
argument_list|(
name|uaa
operator|->
name|device
argument_list|)
decl_stmt|;
if|if
condition|(
name|uaa
operator|->
name|iface
operator|==
name|NULL
operator|||
name|usb_lookup
argument_list|(
name|ubt_ignored_devices
argument_list|,
name|uaa
operator|->
name|vendor
argument_list|,
name|uaa
operator|->
name|product
argument_list|)
condition|)
return|return
operator|(
name|UMATCH_NONE
operator|)
return|;
if|if
condition|(
name|dd
operator|->
name|bDeviceClass
operator|==
name|UDCLASS_WIRELESS
operator|&&
name|dd
operator|->
name|bDeviceSubClass
operator|==
name|UDSUBCLASS_RF
operator|&&
name|dd
operator|->
name|bDeviceProtocol
operator|==
name|UDPROTO_BLUETOOTH
condition|)
return|return
operator|(
name|UMATCH_DEVCLASS_DEVSUBCLASS
operator|)
return|;
if|if
condition|(
name|usb_lookup
argument_list|(
name|ubt_broken_devices
argument_list|,
name|uaa
operator|->
name|vendor
argument_list|,
name|uaa
operator|->
name|product
argument_list|)
condition|)
return|return
operator|(
name|UMATCH_VENDOR_PRODUCT
operator|)
return|;
return|return
operator|(
name|UMATCH_NONE
operator|)
return|;
block|}
end_block

begin_comment
comment|/* USB_MATCH(ubt) */
end_comment

begin_comment
comment|/*  * Attach the device  */
end_comment

begin_macro
name|USB_ATTACH
argument_list|(
argument|ubt
argument_list|)
end_macro

begin_block
block|{
name|USB_ATTACH_START
argument_list|(
name|ubt
argument_list|,
name|sc
argument_list|,
name|uaa
argument_list|)
expr_stmt|;
name|usb_config_descriptor_t
modifier|*
name|cd
init|=
name|NULL
decl_stmt|;
name|usb_interface_descriptor_t
modifier|*
name|id
init|=
name|NULL
decl_stmt|;
name|usb_endpoint_descriptor_t
modifier|*
name|ed
init|=
name|NULL
decl_stmt|;
name|char
name|devinfo
index|[
literal|1024
index|]
decl_stmt|;
name|usbd_status
name|error
decl_stmt|;
name|int
name|i
decl_stmt|,
name|ai
decl_stmt|,
name|alt_no
decl_stmt|,
name|isoc_in
decl_stmt|,
name|isoc_out
decl_stmt|,
name|isoc_isize
decl_stmt|,
name|isoc_osize
decl_stmt|;
comment|/* Get USB device info */
name|sc
operator|->
name|sc_udev
operator|=
name|uaa
operator|->
name|device
expr_stmt|;
name|usbd_devinfo
argument_list|(
name|sc
operator|->
name|sc_udev
argument_list|,
literal|0
argument_list|,
name|devinfo
argument_list|)
expr_stmt|;
name|USB_ATTACH_SETUP
expr_stmt|;
name|printf
argument_list|(
literal|"%s: %s\n"
argument_list|,
name|USBDEVNAME
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|)
argument_list|,
name|devinfo
argument_list|)
expr_stmt|;
comment|/*  	 * Initialize device softc structure 	 */
comment|/* State */
name|sc
operator|->
name|sc_debug
operator|=
name|NG_UBT_WARN_LEVEL
expr_stmt|;
name|sc
operator|->
name|sc_flags
operator|=
literal|0
expr_stmt|;
name|NG_UBT_STAT_RESET
argument_list|(
name|sc
operator|->
name|sc_stat
argument_list|)
expr_stmt|;
comment|/* Interfaces */
name|sc
operator|->
name|sc_iface0
operator|=
name|sc
operator|->
name|sc_iface1
operator|=
name|NULL
expr_stmt|;
comment|/* Interrupt pipe */
name|sc
operator|->
name|sc_intr_ep
operator|=
operator|-
literal|1
expr_stmt|;
name|sc
operator|->
name|sc_intr_pipe
operator|=
name|NULL
expr_stmt|;
name|sc
operator|->
name|sc_intr_xfer
operator|=
name|NULL
expr_stmt|;
name|sc
operator|->
name|sc_intr_buffer
operator|=
name|NULL
expr_stmt|;
comment|/* Control pipe */
name|sc
operator|->
name|sc_ctrl_xfer
operator|=
name|NULL
expr_stmt|;
name|sc
operator|->
name|sc_ctrl_buffer
operator|=
name|NULL
expr_stmt|;
name|NG_BT_MBUFQ_INIT
argument_list|(
operator|&
name|sc
operator|->
name|sc_cmdq
argument_list|,
name|UBT_DEFAULT_QLEN
argument_list|)
expr_stmt|;
comment|/* Bulk-in pipe */
name|sc
operator|->
name|sc_bulk_in_ep
operator|=
operator|-
literal|1
expr_stmt|;
name|sc
operator|->
name|sc_bulk_in_pipe
operator|=
name|NULL
expr_stmt|;
name|sc
operator|->
name|sc_bulk_in_xfer
operator|=
name|NULL
expr_stmt|;
name|sc
operator|->
name|sc_bulk_in_buffer
operator|=
name|NULL
expr_stmt|;
comment|/* Bulk-out pipe */
name|sc
operator|->
name|sc_bulk_out_ep
operator|=
operator|-
literal|1
expr_stmt|;
name|sc
operator|->
name|sc_bulk_out_pipe
operator|=
name|NULL
expr_stmt|;
name|sc
operator|->
name|sc_bulk_out_xfer
operator|=
name|NULL
expr_stmt|;
name|sc
operator|->
name|sc_bulk_out_buffer
operator|=
name|NULL
expr_stmt|;
name|NG_BT_MBUFQ_INIT
argument_list|(
operator|&
name|sc
operator|->
name|sc_aclq
argument_list|,
name|UBT_DEFAULT_QLEN
argument_list|)
expr_stmt|;
comment|/* Isoc-in pipe */
name|sc
operator|->
name|sc_isoc_in_ep
operator|=
operator|-
literal|1
expr_stmt|;
name|sc
operator|->
name|sc_isoc_in_pipe
operator|=
name|NULL
expr_stmt|;
name|sc
operator|->
name|sc_isoc_in_xfer
operator|=
name|NULL
expr_stmt|;
comment|/* Isoc-out pipe */
name|sc
operator|->
name|sc_isoc_out_ep
operator|=
operator|-
literal|1
expr_stmt|;
name|sc
operator|->
name|sc_isoc_out_pipe
operator|=
name|NULL
expr_stmt|;
name|sc
operator|->
name|sc_isoc_out_xfer
operator|=
name|NULL
expr_stmt|;
name|sc
operator|->
name|sc_isoc_size
operator|=
operator|-
literal|1
expr_stmt|;
name|NG_BT_MBUFQ_INIT
argument_list|(
operator|&
name|sc
operator|->
name|sc_scoq
argument_list|,
name|UBT_DEFAULT_QLEN
argument_list|)
expr_stmt|;
comment|/* Netgraph part */
name|sc
operator|->
name|sc_node
operator|=
name|NULL
expr_stmt|;
name|sc
operator|->
name|sc_hook
operator|=
name|NULL
expr_stmt|;
comment|/* 	 * XXX set configuration? 	 * 	 * Configure Bluetooth USB device. Discover all required USB interfaces 	 * and endpoints. 	 * 	 * USB device must present two interfaces: 	 * 1) Interface 0 that has 3 endpoints 	 *	1) Interrupt endpoint to receive HCI events 	 *	2) Bulk IN endpoint to receive ACL data 	 *	3) Bulk OUT endpoint to send ACL data 	 * 	 * 2) Interface 1 then has 2 endpoints 	 *	1) Isochronous IN endpoint to receive SCO data  	 *	2) Isochronous OUT endpoint to send SCO data 	 * 	 * Interface 1 (with isochronous endpoints) has several alternate  	 * configurations with different packet size. 	 */
comment|/* 	 * Interface 0 	 */
name|error
operator|=
name|usbd_device2interface_handle
argument_list|(
name|sc
operator|->
name|sc_udev
argument_list|,
literal|0
argument_list|,
operator|&
name|sc
operator|->
name|sc_iface0
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|||
name|sc
operator|->
name|sc_iface0
operator|==
name|NULL
condition|)
block|{
name|printf
argument_list|(
literal|"%s: Could not get interface 0 handle. %s (%d), "
expr|\
literal|"handle=%p\n"
argument_list|,
name|USBDEVNAME
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|)
argument_list|,
name|usbd_errstr
argument_list|(
name|error
argument_list|)
argument_list|,
name|error
argument_list|,
name|sc
operator|->
name|sc_iface0
argument_list|)
expr_stmt|;
goto|goto
name|bad
goto|;
block|}
name|id
operator|=
name|usbd_get_interface_descriptor
argument_list|(
name|sc
operator|->
name|sc_iface0
argument_list|)
expr_stmt|;
if|if
condition|(
name|id
operator|==
name|NULL
condition|)
block|{
name|printf
argument_list|(
literal|"%s: Could not get interface 0 descriptor\n"
argument_list|,
name|USBDEVNAME
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|)
argument_list|)
expr_stmt|;
goto|goto
name|bad
goto|;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|id
operator|->
name|bNumEndpoints
condition|;
name|i
operator|++
control|)
block|{
name|ed
operator|=
name|usbd_interface2endpoint_descriptor
argument_list|(
name|sc
operator|->
name|sc_iface0
argument_list|,
name|i
argument_list|)
expr_stmt|;
if|if
condition|(
name|ed
operator|==
name|NULL
condition|)
block|{
name|printf
argument_list|(
literal|"%s: Could not read endpoint descriptor for "
expr|\
literal|"interface 0, i=%d\n"
argument_list|,
name|USBDEVNAME
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|)
argument_list|,
name|i
argument_list|)
expr_stmt|;
goto|goto
name|bad
goto|;
block|}
switch|switch
condition|(
name|UE_GET_XFERTYPE
argument_list|(
name|ed
operator|->
name|bmAttributes
argument_list|)
condition|)
block|{
case|case
name|UE_BULK
case|:
if|if
condition|(
name|UE_GET_DIR
argument_list|(
name|ed
operator|->
name|bEndpointAddress
argument_list|)
operator|==
name|UE_DIR_IN
condition|)
name|sc
operator|->
name|sc_bulk_in_ep
operator|=
name|ed
operator|->
name|bEndpointAddress
expr_stmt|;
else|else
name|sc
operator|->
name|sc_bulk_out_ep
operator|=
name|ed
operator|->
name|bEndpointAddress
expr_stmt|;
break|break;
case|case
name|UE_INTERRUPT
case|:
name|sc
operator|->
name|sc_intr_ep
operator|=
name|ed
operator|->
name|bEndpointAddress
expr_stmt|;
break|break;
block|}
block|}
comment|/* Check if we got everything we wanted on Interface 0 */
if|if
condition|(
name|sc
operator|->
name|sc_intr_ep
operator|==
operator|-
literal|1
condition|)
block|{
name|printf
argument_list|(
literal|"%s: Could not detect interrupt endpoint\n"
argument_list|,
name|USBDEVNAME
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|)
argument_list|)
expr_stmt|;
goto|goto
name|bad
goto|;
block|}
if|if
condition|(
name|sc
operator|->
name|sc_bulk_in_ep
operator|==
operator|-
literal|1
condition|)
block|{
name|printf
argument_list|(
literal|"%s: Could not detect bulk-in endpoint\n"
argument_list|,
name|USBDEVNAME
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|)
argument_list|)
expr_stmt|;
goto|goto
name|bad
goto|;
block|}
if|if
condition|(
name|sc
operator|->
name|sc_bulk_out_ep
operator|==
operator|-
literal|1
condition|)
block|{
name|printf
argument_list|(
literal|"%s: Could not detect bulk-out endpoint\n"
argument_list|,
name|USBDEVNAME
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|)
argument_list|)
expr_stmt|;
goto|goto
name|bad
goto|;
block|}
name|printf
argument_list|(
literal|"%s: Interface 0 endpoints: interrupt=%#x, bulk-in=%#x, "
expr|\
literal|"bulk-out=%#x\n"
argument_list|,
name|USBDEVNAME
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|)
argument_list|,
name|sc
operator|->
name|sc_intr_ep
argument_list|,
name|sc
operator|->
name|sc_bulk_in_ep
argument_list|,
name|sc
operator|->
name|sc_bulk_out_ep
argument_list|)
expr_stmt|;
comment|/* 	 * Interface 1 	 */
name|cd
operator|=
name|usbd_get_config_descriptor
argument_list|(
name|sc
operator|->
name|sc_udev
argument_list|)
expr_stmt|;
if|if
condition|(
name|cd
operator|==
name|NULL
condition|)
block|{
name|printf
argument_list|(
literal|"%s: Could not get device configuration descriptor\n"
argument_list|,
name|USBDEVNAME
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|)
argument_list|)
expr_stmt|;
goto|goto
name|bad
goto|;
block|}
name|error
operator|=
name|usbd_device2interface_handle
argument_list|(
name|sc
operator|->
name|sc_udev
argument_list|,
literal|1
argument_list|,
operator|&
name|sc
operator|->
name|sc_iface1
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|||
name|sc
operator|->
name|sc_iface1
operator|==
name|NULL
condition|)
block|{
name|printf
argument_list|(
literal|"%s: Could not get interface 1 handle. %s (%d), "
expr|\
literal|"handle=%p\n"
argument_list|,
name|USBDEVNAME
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|)
argument_list|,
name|usbd_errstr
argument_list|(
name|error
argument_list|)
argument_list|,
name|error
argument_list|,
name|sc
operator|->
name|sc_iface1
argument_list|)
expr_stmt|;
goto|goto
name|bad
goto|;
block|}
name|id
operator|=
name|usbd_get_interface_descriptor
argument_list|(
name|sc
operator|->
name|sc_iface1
argument_list|)
expr_stmt|;
if|if
condition|(
name|id
operator|==
name|NULL
condition|)
block|{
name|printf
argument_list|(
literal|"%s: Could not get interface 1 descriptor\n"
argument_list|,
name|USBDEVNAME
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|)
argument_list|)
expr_stmt|;
goto|goto
name|bad
goto|;
block|}
comment|/* 	 * Scan all alternate configurations for interface 1 	 */
name|alt_no
operator|=
operator|-
literal|1
expr_stmt|;
for|for
control|(
name|ai
operator|=
literal|0
init|;
name|ai
operator|<
name|usbd_get_no_alts
argument_list|(
name|cd
argument_list|,
literal|1
argument_list|)
condition|;
name|ai
operator|++
control|)
block|{
name|error
operator|=
name|usbd_set_interface
argument_list|(
name|sc
operator|->
name|sc_iface1
argument_list|,
name|ai
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
block|{
name|printf
argument_list|(
literal|"%s: [SCAN] Could not set alternate "
expr|\
literal|"configuration %d for interface 1. %s (%d)\n"
argument_list|,
name|USBDEVNAME
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|)
argument_list|,
name|ai
argument_list|,
name|usbd_errstr
argument_list|(
name|error
argument_list|)
argument_list|,
name|error
argument_list|)
expr_stmt|;
goto|goto
name|bad
goto|;
block|}
name|id
operator|=
name|usbd_get_interface_descriptor
argument_list|(
name|sc
operator|->
name|sc_iface1
argument_list|)
expr_stmt|;
if|if
condition|(
name|id
operator|==
name|NULL
condition|)
block|{
name|printf
argument_list|(
literal|"%s: Could not get interface 1 descriptor for "
expr|\
literal|"alternate configuration %d\n"
argument_list|,
name|USBDEVNAME
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|)
argument_list|,
name|ai
argument_list|)
expr_stmt|;
goto|goto
name|bad
goto|;
block|}
name|isoc_in
operator|=
name|isoc_out
operator|=
operator|-
literal|1
expr_stmt|;
name|isoc_isize
operator|=
name|isoc_osize
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|id
operator|->
name|bNumEndpoints
condition|;
name|i
operator|++
control|)
block|{
name|ed
operator|=
name|usbd_interface2endpoint_descriptor
argument_list|(
name|sc
operator|->
name|sc_iface1
argument_list|,
name|i
argument_list|)
expr_stmt|;
if|if
condition|(
name|ed
operator|==
name|NULL
condition|)
block|{
name|printf
argument_list|(
literal|"%s: Could not read endpoint "
expr|\
literal|"descriptor for interface 1, "
expr|\
literal|"alternate configuration %d, i=%d\n"
argument_list|,
name|USBDEVNAME
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|)
argument_list|,
name|ai
argument_list|,
name|i
argument_list|)
expr_stmt|;
goto|goto
name|bad
goto|;
block|}
if|if
condition|(
name|UE_GET_XFERTYPE
argument_list|(
name|ed
operator|->
name|bmAttributes
argument_list|)
operator|!=
name|UE_ISOCHRONOUS
condition|)
continue|continue;
if|if
condition|(
name|UE_GET_DIR
argument_list|(
name|ed
operator|->
name|bEndpointAddress
argument_list|)
operator|==
name|UE_DIR_IN
condition|)
block|{
name|isoc_in
operator|=
name|ed
operator|->
name|bEndpointAddress
expr_stmt|;
name|isoc_isize
operator|=
name|UGETW
argument_list|(
name|ed
operator|->
name|wMaxPacketSize
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|isoc_out
operator|=
name|ed
operator|->
name|bEndpointAddress
expr_stmt|;
name|isoc_osize
operator|=
name|UGETW
argument_list|(
name|ed
operator|->
name|wMaxPacketSize
argument_list|)
expr_stmt|;
block|}
block|}
comment|/* 		 * Make sure that configuration looks sane and if so 		 * update current settings 		 */
if|if
condition|(
name|isoc_in
operator|!=
operator|-
literal|1
operator|&&
name|isoc_out
operator|!=
operator|-
literal|1
operator|&&
name|isoc_isize
operator|>
literal|0
operator|&&
name|isoc_osize
operator|>
literal|0
operator|&&
name|isoc_isize
operator|==
name|isoc_osize
operator|&&
name|isoc_isize
operator|>
name|sc
operator|->
name|sc_isoc_size
condition|)
block|{
name|sc
operator|->
name|sc_isoc_in_ep
operator|=
name|isoc_in
expr_stmt|;
name|sc
operator|->
name|sc_isoc_out_ep
operator|=
name|isoc_out
expr_stmt|;
name|sc
operator|->
name|sc_isoc_size
operator|=
name|isoc_isize
expr_stmt|;
name|alt_no
operator|=
name|ai
expr_stmt|;
block|}
block|}
comment|/* Check if we got everything we wanted on Interface 0 */
if|if
condition|(
name|sc
operator|->
name|sc_isoc_in_ep
operator|==
operator|-
literal|1
condition|)
block|{
name|printf
argument_list|(
literal|"%s: Could not detect isoc-in endpoint\n"
argument_list|,
name|USBDEVNAME
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|)
argument_list|)
expr_stmt|;
goto|goto
name|bad
goto|;
block|}
if|if
condition|(
name|sc
operator|->
name|sc_isoc_out_ep
operator|==
operator|-
literal|1
condition|)
block|{
name|printf
argument_list|(
literal|"%s: Could not detect isoc-out endpoint\n"
argument_list|,
name|USBDEVNAME
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|)
argument_list|)
expr_stmt|;
goto|goto
name|bad
goto|;
block|}
if|if
condition|(
name|sc
operator|->
name|sc_isoc_size
operator|<=
literal|0
condition|)
block|{
name|printf
argument_list|(
literal|"%s: Invalid isoc. packet size=%d\n"
argument_list|,
name|USBDEVNAME
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|)
argument_list|,
name|sc
operator|->
name|sc_isoc_size
argument_list|)
expr_stmt|;
goto|goto
name|bad
goto|;
block|}
name|error
operator|=
name|usbd_set_interface
argument_list|(
name|sc
operator|->
name|sc_iface1
argument_list|,
name|alt_no
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
block|{
name|printf
argument_list|(
literal|"%s: Could not set alternate configuration "
expr|\
literal|"%d for interface 1. %s (%d)\n"
argument_list|,
name|USBDEVNAME
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|)
argument_list|,
name|alt_no
argument_list|,
name|usbd_errstr
argument_list|(
name|error
argument_list|)
argument_list|,
name|error
argument_list|)
expr_stmt|;
goto|goto
name|bad
goto|;
block|}
comment|/* Allocate USB transfer handles and buffers */
name|sc
operator|->
name|sc_ctrl_xfer
operator|=
name|usbd_alloc_xfer
argument_list|(
name|sc
operator|->
name|sc_udev
argument_list|)
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|sc_ctrl_xfer
operator|==
name|NULL
condition|)
block|{
name|printf
argument_list|(
literal|"%s: Could not allocate control xfer handle\n"
argument_list|,
name|USBDEVNAME
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|)
argument_list|)
expr_stmt|;
goto|goto
name|bad
goto|;
block|}
name|sc
operator|->
name|sc_ctrl_buffer
operator|=
name|usbd_alloc_buffer
argument_list|(
name|sc
operator|->
name|sc_ctrl_xfer
argument_list|,
name|UBT_CTRL_BUFFER_SIZE
argument_list|)
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|sc_ctrl_buffer
operator|==
name|NULL
condition|)
block|{
name|printf
argument_list|(
literal|"%s: Could not allocate control buffer\n"
argument_list|,
name|USBDEVNAME
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|)
argument_list|)
expr_stmt|;
goto|goto
name|bad
goto|;
block|}
name|sc
operator|->
name|sc_intr_xfer
operator|=
name|usbd_alloc_xfer
argument_list|(
name|sc
operator|->
name|sc_udev
argument_list|)
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|sc_intr_xfer
operator|==
name|NULL
condition|)
block|{
name|printf
argument_list|(
literal|"%s: Could not allocate interrupt xfer handle\n"
argument_list|,
name|USBDEVNAME
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|)
argument_list|)
expr_stmt|;
goto|goto
name|bad
goto|;
block|}
name|sc
operator|->
name|sc_bulk_in_xfer
operator|=
name|usbd_alloc_xfer
argument_list|(
name|sc
operator|->
name|sc_udev
argument_list|)
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|sc_bulk_in_xfer
operator|==
name|NULL
condition|)
block|{
name|printf
argument_list|(
literal|"%s: Could not allocate bulk-in xfer handle\n"
argument_list|,
name|USBDEVNAME
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|)
argument_list|)
expr_stmt|;
goto|goto
name|bad
goto|;
block|}
name|sc
operator|->
name|sc_bulk_out_xfer
operator|=
name|usbd_alloc_xfer
argument_list|(
name|sc
operator|->
name|sc_udev
argument_list|)
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|sc_bulk_out_xfer
operator|==
name|NULL
condition|)
block|{
name|printf
argument_list|(
literal|"%s: Could not allocate bulk-out xfer handle\n"
argument_list|,
name|USBDEVNAME
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|)
argument_list|)
expr_stmt|;
goto|goto
name|bad
goto|;
block|}
name|sc
operator|->
name|sc_bulk_out_buffer
operator|=
name|usbd_alloc_buffer
argument_list|(
name|sc
operator|->
name|sc_bulk_out_xfer
argument_list|,
name|UBT_BULK_BUFFER_SIZE
argument_list|)
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|sc_bulk_out_buffer
operator|==
name|NULL
condition|)
block|{
name|printf
argument_list|(
literal|"%s: Could not allocate bulk-out buffer\n"
argument_list|,
name|USBDEVNAME
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|)
argument_list|)
expr_stmt|;
goto|goto
name|bad
goto|;
block|}
comment|/* 	 * Allocate buffers for isoc. transfers 	 */
name|sc
operator|->
name|sc_isoc_nframes
operator|=
operator|(
name|UBT_ISOC_BUFFER_SIZE
operator|/
name|sc
operator|->
name|sc_isoc_size
operator|)
operator|+
literal|1
expr_stmt|;
name|sc
operator|->
name|sc_isoc_in_xfer
operator|=
name|usbd_alloc_xfer
argument_list|(
name|sc
operator|->
name|sc_udev
argument_list|)
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|sc_isoc_in_xfer
operator|==
name|NULL
condition|)
block|{
name|printf
argument_list|(
literal|"%s: Could not allocate isoc-in xfer handle\n"
argument_list|,
name|USBDEVNAME
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|)
argument_list|)
expr_stmt|;
goto|goto
name|bad
goto|;
block|}
name|sc
operator|->
name|sc_isoc_in_buffer
operator|=
name|usbd_alloc_buffer
argument_list|(
name|sc
operator|->
name|sc_isoc_in_xfer
argument_list|,
name|sc
operator|->
name|sc_isoc_nframes
operator|*
name|sc
operator|->
name|sc_isoc_size
argument_list|)
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|sc_isoc_in_buffer
operator|==
name|NULL
condition|)
block|{
name|printf
argument_list|(
literal|"%s: Could not allocate isoc-in buffer\n"
argument_list|,
name|USBDEVNAME
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|)
argument_list|)
expr_stmt|;
goto|goto
name|bad
goto|;
block|}
name|sc
operator|->
name|sc_isoc_in_frlen
operator|=
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
name|u_int16_t
argument_list|)
operator|*
name|sc
operator|->
name|sc_isoc_nframes
argument_list|,
name|M_USBDEV
argument_list|,
name|M_NOWAIT
argument_list|)
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|sc_isoc_in_frlen
operator|==
name|NULL
condition|)
block|{
name|printf
argument_list|(
literal|"%s: Could not allocate isoc-in frame sizes buffer\n"
argument_list|,
name|USBDEVNAME
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|)
argument_list|)
expr_stmt|;
goto|goto
name|bad
goto|;
block|}
name|sc
operator|->
name|sc_isoc_out_xfer
operator|=
name|usbd_alloc_xfer
argument_list|(
name|sc
operator|->
name|sc_udev
argument_list|)
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|sc_isoc_out_xfer
operator|==
name|NULL
condition|)
block|{
name|printf
argument_list|(
literal|"%s: Could not allocate isoc-out xfer handle\n"
argument_list|,
name|USBDEVNAME
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|)
argument_list|)
expr_stmt|;
goto|goto
name|bad
goto|;
block|}
name|sc
operator|->
name|sc_isoc_out_buffer
operator|=
name|usbd_alloc_buffer
argument_list|(
name|sc
operator|->
name|sc_isoc_out_xfer
argument_list|,
name|sc
operator|->
name|sc_isoc_nframes
operator|*
name|sc
operator|->
name|sc_isoc_size
argument_list|)
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|sc_isoc_out_buffer
operator|==
name|NULL
condition|)
block|{
name|printf
argument_list|(
literal|"%s: Could not allocate isoc-out buffer\n"
argument_list|,
name|USBDEVNAME
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|)
argument_list|)
expr_stmt|;
goto|goto
name|bad
goto|;
block|}
name|sc
operator|->
name|sc_isoc_out_frlen
operator|=
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
name|u_int16_t
argument_list|)
operator|*
name|sc
operator|->
name|sc_isoc_nframes
argument_list|,
name|M_USBDEV
argument_list|,
name|M_NOWAIT
argument_list|)
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|sc_isoc_out_frlen
operator|==
name|NULL
condition|)
block|{
name|printf
argument_list|(
literal|"%s: Could not allocate isoc-out frame sizes buffer\n"
argument_list|,
name|USBDEVNAME
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|)
argument_list|)
expr_stmt|;
goto|goto
name|bad
goto|;
block|}
name|printf
argument_list|(
literal|"%s: Interface 1 (alt.config %d) endpoints: isoc-in=%#x, "
expr|\
literal|"isoc-out=%#x; wMaxPacketSize=%d; nframes=%d, buffer size=%d\n"
argument_list|,
name|USBDEVNAME
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|)
argument_list|,
name|alt_no
argument_list|,
name|sc
operator|->
name|sc_isoc_in_ep
argument_list|,
name|sc
operator|->
name|sc_isoc_out_ep
argument_list|,
name|sc
operator|->
name|sc_isoc_size
argument_list|,
name|sc
operator|->
name|sc_isoc_nframes
argument_list|,
operator|(
name|sc
operator|->
name|sc_isoc_nframes
operator|*
name|sc
operator|->
name|sc_isoc_size
operator|)
argument_list|)
expr_stmt|;
comment|/* 	 * Open pipes 	 */
comment|/* Interrupt */
name|error
operator|=
name|usbd_open_pipe
argument_list|(
name|sc
operator|->
name|sc_iface0
argument_list|,
name|sc
operator|->
name|sc_intr_ep
argument_list|,
name|USBD_EXCLUSIVE_USE
argument_list|,
operator|&
name|sc
operator|->
name|sc_intr_pipe
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|!=
name|USBD_NORMAL_COMPLETION
condition|)
block|{
name|printf
argument_list|(
literal|"%s: %s - Could not open interrupt pipe. %s (%d)\n"
argument_list|,
name|__func__
argument_list|,
name|USBDEVNAME
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|)
argument_list|,
name|usbd_errstr
argument_list|(
name|error
argument_list|)
argument_list|,
name|error
argument_list|)
expr_stmt|;
goto|goto
name|bad
goto|;
block|}
comment|/* Bulk-in */
name|error
operator|=
name|usbd_open_pipe
argument_list|(
name|sc
operator|->
name|sc_iface0
argument_list|,
name|sc
operator|->
name|sc_bulk_in_ep
argument_list|,
name|USBD_EXCLUSIVE_USE
argument_list|,
operator|&
name|sc
operator|->
name|sc_bulk_in_pipe
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|!=
name|USBD_NORMAL_COMPLETION
condition|)
block|{
name|printf
argument_list|(
literal|"%s: %s - Could not open bulk-in pipe. %s (%d)\n"
argument_list|,
name|__func__
argument_list|,
name|USBDEVNAME
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|)
argument_list|,
name|usbd_errstr
argument_list|(
name|error
argument_list|)
argument_list|,
name|error
argument_list|)
expr_stmt|;
goto|goto
name|bad
goto|;
block|}
comment|/* Bulk-out */
name|error
operator|=
name|usbd_open_pipe
argument_list|(
name|sc
operator|->
name|sc_iface0
argument_list|,
name|sc
operator|->
name|sc_bulk_out_ep
argument_list|,
name|USBD_EXCLUSIVE_USE
argument_list|,
operator|&
name|sc
operator|->
name|sc_bulk_out_pipe
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|!=
name|USBD_NORMAL_COMPLETION
condition|)
block|{
name|printf
argument_list|(
literal|"%s: %s - Could not open bulk-out pipe. %s (%d)\n"
argument_list|,
name|__func__
argument_list|,
name|USBDEVNAME
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|)
argument_list|,
name|usbd_errstr
argument_list|(
name|error
argument_list|)
argument_list|,
name|error
argument_list|)
expr_stmt|;
goto|goto
name|bad
goto|;
block|}
if|#
directive|if
name|__broken__
comment|/* XXX FIXME */
comment|/* Isoc-in */
name|error
operator|=
name|usbd_open_pipe
argument_list|(
name|sc
operator|->
name|sc_iface1
argument_list|,
name|sc
operator|->
name|sc_isoc_in_ep
argument_list|,
name|USBD_EXCLUSIVE_USE
argument_list|,
operator|&
name|sc
operator|->
name|sc_isoc_in_pipe
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|!=
name|USBD_NORMAL_COMPLETION
condition|)
block|{
name|printf
argument_list|(
literal|"%s: %s - Could not open isoc-in pipe. %s (%d)\n"
argument_list|,
name|__func__
argument_list|,
name|USBDEVNAME
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|)
argument_list|,
name|usbd_errstr
argument_list|(
name|error
argument_list|)
argument_list|,
name|error
argument_list|)
expr_stmt|;
goto|goto
name|bad
goto|;
block|}
comment|/* Isoc-out */
name|error
operator|=
name|usbd_open_pipe
argument_list|(
name|sc
operator|->
name|sc_iface1
argument_list|,
name|sc
operator|->
name|sc_isoc_out_ep
argument_list|,
name|USBD_EXCLUSIVE_USE
argument_list|,
operator|&
name|sc
operator|->
name|sc_isoc_out_pipe
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|!=
name|USBD_NORMAL_COMPLETION
condition|)
block|{
name|printf
argument_list|(
literal|"%s: %s - Could not open isoc-out pipe. %s (%d)\n"
argument_list|,
name|__func__
argument_list|,
name|USBDEVNAME
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|)
argument_list|,
name|usbd_errstr
argument_list|(
name|error
argument_list|)
argument_list|,
name|error
argument_list|)
expr_stmt|;
goto|goto
name|bad
goto|;
block|}
endif|#
directive|endif
comment|/* __broken__ */
comment|/* Create Netgraph node */
if|if
condition|(
name|ng_make_node_common
argument_list|(
operator|&
name|typestruct
argument_list|,
operator|&
name|sc
operator|->
name|sc_node
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|printf
argument_list|(
literal|"%s: Could not create Netgraph node\n"
argument_list|,
name|USBDEVNAME
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|)
argument_list|)
expr_stmt|;
name|sc
operator|->
name|sc_node
operator|=
name|NULL
expr_stmt|;
goto|goto
name|bad
goto|;
block|}
comment|/* Name node */
if|if
condition|(
name|ng_name_node
argument_list|(
name|sc
operator|->
name|sc_node
argument_list|,
name|USBDEVNAME
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|)
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|printf
argument_list|(
literal|"%s: Could not name Netgraph node\n"
argument_list|,
name|USBDEVNAME
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|)
argument_list|)
expr_stmt|;
name|NG_NODE_UNREF
argument_list|(
name|sc
operator|->
name|sc_node
argument_list|)
expr_stmt|;
name|sc
operator|->
name|sc_node
operator|=
name|NULL
expr_stmt|;
goto|goto
name|bad
goto|;
block|}
name|NG_NODE_SET_PRIVATE
argument_list|(
name|sc
operator|->
name|sc_node
argument_list|,
name|sc
argument_list|)
expr_stmt|;
name|NG_NODE_FORCE_WRITER
argument_list|(
name|sc
operator|->
name|sc_node
argument_list|)
expr_stmt|;
comment|/* Claim all interfaces on the device */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|uaa
operator|->
name|nifaces
condition|;
name|i
operator|++
control|)
name|uaa
operator|->
name|ifaces
index|[
name|i
index|]
operator|=
name|NULL
expr_stmt|;
name|usbd_add_drv_event
argument_list|(
name|USB_EVENT_DRIVER_ATTACH
argument_list|,
name|sc
operator|->
name|sc_udev
argument_list|,
name|USBDEV
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|)
argument_list|)
expr_stmt|;
name|USB_ATTACH_SUCCESS_RETURN
expr_stmt|;
name|bad
label|:
name|ubt_detach
argument_list|(
name|self
argument_list|)
expr_stmt|;
name|USB_ATTACH_ERROR_RETURN
expr_stmt|;
block|}
end_block

begin_comment
comment|/* USB_ATTACH(ubt) */
end_comment

begin_comment
comment|/*  * Detach the device  */
end_comment

begin_macro
name|USB_DETACH
argument_list|(
argument|ubt
argument_list|)
end_macro

begin_block
block|{
name|USB_DETACH_START
argument_list|(
name|ubt
argument_list|,
name|sc
argument_list|)
expr_stmt|;
comment|/* Destroy Netgraph node */
if|if
condition|(
name|sc
operator|->
name|sc_node
operator|!=
name|NULL
condition|)
block|{
name|NG_NODE_SET_PRIVATE
argument_list|(
name|sc
operator|->
name|sc_node
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|ng_rmnode_self
argument_list|(
name|sc
operator|->
name|sc_node
argument_list|)
expr_stmt|;
name|sc
operator|->
name|sc_node
operator|=
name|NULL
expr_stmt|;
block|}
comment|/* Close pipes */
if|if
condition|(
name|sc
operator|->
name|sc_intr_pipe
operator|!=
name|NULL
condition|)
block|{
name|usbd_close_pipe
argument_list|(
name|sc
operator|->
name|sc_intr_pipe
argument_list|)
expr_stmt|;
name|sc
operator|->
name|sc_intr_pipe
operator|=
name|NULL
expr_stmt|;
block|}
if|if
condition|(
name|sc
operator|->
name|sc_bulk_in_pipe
operator|!=
name|NULL
condition|)
block|{
name|usbd_close_pipe
argument_list|(
name|sc
operator|->
name|sc_bulk_in_pipe
argument_list|)
expr_stmt|;
name|sc
operator|->
name|sc_bulk_in_pipe
operator|=
name|NULL
expr_stmt|;
block|}
if|if
condition|(
name|sc
operator|->
name|sc_bulk_out_pipe
operator|!=
name|NULL
condition|)
block|{
name|usbd_close_pipe
argument_list|(
name|sc
operator|->
name|sc_bulk_out_pipe
argument_list|)
expr_stmt|;
name|sc
operator|->
name|sc_bulk_out_pipe
operator|=
name|NULL
expr_stmt|;
block|}
if|if
condition|(
name|sc
operator|->
name|sc_isoc_in_pipe
operator|!=
name|NULL
condition|)
block|{
name|usbd_close_pipe
argument_list|(
name|sc
operator|->
name|sc_isoc_in_pipe
argument_list|)
expr_stmt|;
name|sc
operator|->
name|sc_isoc_in_pipe
operator|=
name|NULL
expr_stmt|;
block|}
if|if
condition|(
name|sc
operator|->
name|sc_isoc_out_pipe
operator|!=
name|NULL
condition|)
block|{
name|usbd_close_pipe
argument_list|(
name|sc
operator|->
name|sc_isoc_out_pipe
argument_list|)
expr_stmt|;
name|sc
operator|->
name|sc_isoc_out_pipe
operator|=
name|NULL
expr_stmt|;
block|}
comment|/* Destroy USB transfer handles */
if|if
condition|(
name|sc
operator|->
name|sc_ctrl_xfer
operator|!=
name|NULL
condition|)
block|{
name|usbd_free_xfer
argument_list|(
name|sc
operator|->
name|sc_ctrl_xfer
argument_list|)
expr_stmt|;
name|sc
operator|->
name|sc_ctrl_xfer
operator|=
name|NULL
expr_stmt|;
block|}
if|if
condition|(
name|sc
operator|->
name|sc_intr_xfer
operator|!=
name|NULL
condition|)
block|{
name|usbd_free_xfer
argument_list|(
name|sc
operator|->
name|sc_intr_xfer
argument_list|)
expr_stmt|;
name|sc
operator|->
name|sc_intr_xfer
operator|=
name|NULL
expr_stmt|;
block|}
if|if
condition|(
name|sc
operator|->
name|sc_bulk_in_xfer
operator|!=
name|NULL
condition|)
block|{
name|usbd_free_xfer
argument_list|(
name|sc
operator|->
name|sc_bulk_in_xfer
argument_list|)
expr_stmt|;
name|sc
operator|->
name|sc_bulk_in_xfer
operator|=
name|NULL
expr_stmt|;
block|}
if|if
condition|(
name|sc
operator|->
name|sc_bulk_out_xfer
operator|!=
name|NULL
condition|)
block|{
name|usbd_free_xfer
argument_list|(
name|sc
operator|->
name|sc_bulk_out_xfer
argument_list|)
expr_stmt|;
name|sc
operator|->
name|sc_bulk_out_xfer
operator|=
name|NULL
expr_stmt|;
block|}
if|if
condition|(
name|sc
operator|->
name|sc_isoc_in_xfer
operator|!=
name|NULL
condition|)
block|{
name|usbd_free_xfer
argument_list|(
name|sc
operator|->
name|sc_isoc_in_xfer
argument_list|)
expr_stmt|;
name|sc
operator|->
name|sc_isoc_in_xfer
operator|=
name|NULL
expr_stmt|;
block|}
if|if
condition|(
name|sc
operator|->
name|sc_isoc_out_xfer
operator|!=
name|NULL
condition|)
block|{
name|usbd_free_xfer
argument_list|(
name|sc
operator|->
name|sc_isoc_out_xfer
argument_list|)
expr_stmt|;
name|sc
operator|->
name|sc_isoc_out_xfer
operator|=
name|NULL
expr_stmt|;
block|}
comment|/* Destroy isoc. frame size buffers */
if|if
condition|(
name|sc
operator|->
name|sc_isoc_in_frlen
operator|!=
name|NULL
condition|)
block|{
name|free
argument_list|(
name|sc
operator|->
name|sc_isoc_in_frlen
argument_list|,
name|M_USBDEV
argument_list|)
expr_stmt|;
name|sc
operator|->
name|sc_isoc_in_frlen
operator|=
name|NULL
expr_stmt|;
block|}
if|if
condition|(
name|sc
operator|->
name|sc_isoc_out_frlen
operator|!=
name|NULL
condition|)
block|{
name|free
argument_list|(
name|sc
operator|->
name|sc_isoc_out_frlen
argument_list|,
name|M_USBDEV
argument_list|)
expr_stmt|;
name|sc
operator|->
name|sc_isoc_out_frlen
operator|=
name|NULL
expr_stmt|;
block|}
comment|/* Destroy queues */
name|NG_BT_MBUFQ_DRAIN
argument_list|(
operator|&
name|sc
operator|->
name|sc_cmdq
argument_list|)
expr_stmt|;
name|NG_BT_MBUFQ_DRAIN
argument_list|(
operator|&
name|sc
operator|->
name|sc_aclq
argument_list|)
expr_stmt|;
name|NG_BT_MBUFQ_DRAIN
argument_list|(
operator|&
name|sc
operator|->
name|sc_scoq
argument_list|)
expr_stmt|;
name|usbd_add_drv_event
argument_list|(
name|USB_EVENT_DRIVER_DETACH
argument_list|,
name|sc
operator|->
name|sc_udev
argument_list|,
name|USBDEV
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_block

begin_comment
comment|/* USB_DETACH(ubt) */
end_comment

begin_comment
comment|/*  * Start USB control request (HCI command). Must be called with node locked  */
end_comment

begin_function
name|Static
name|usbd_status
name|ubt_request_start
parameter_list|(
name|ubt_softc_p
name|sc
parameter_list|)
block|{
name|usb_device_request_t
name|req
decl_stmt|;
name|struct
name|mbuf
modifier|*
name|m
init|=
name|NULL
decl_stmt|;
name|usbd_status
name|status
decl_stmt|;
name|KASSERT
argument_list|(
operator|!
operator|(
name|sc
operator|->
name|sc_flags
operator|&
name|UBT_CMD_XMIT
operator|)
argument_list|,
operator|(
literal|"%s: %s - Another control request is pending\n"
operator|,
name|__func__
operator|,
name|USBDEVNAME
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|NG_BT_MBUFQ_DEQUEUE
argument_list|(
operator|&
name|sc
operator|->
name|sc_cmdq
argument_list|,
name|m
argument_list|)
expr_stmt|;
if|if
condition|(
name|m
operator|==
name|NULL
condition|)
block|{
name|NG_UBT_INFO
argument_list|(
literal|"%s: %s - HCI command queue is empty\n"
argument_list|,
name|__func__
argument_list|,
name|USBDEVNAME
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|(
name|USBD_NORMAL_COMPLETION
operator|)
return|;
block|}
comment|/* 	 * Check HCI command frame size and copy it back to  	 * linear USB transfer buffer. 	 */
if|if
condition|(
name|m
operator|->
name|m_pkthdr
operator|.
name|len
operator|>
name|UBT_CTRL_BUFFER_SIZE
condition|)
name|panic
argument_list|(
literal|"%s: %s - HCI command frame too big, size=%zd, len=%d\n"
argument_list|,
name|__func__
argument_list|,
name|USBDEVNAME
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|)
argument_list|,
name|UBT_CTRL_BUFFER_SIZE
argument_list|,
name|m
operator|->
name|m_pkthdr
operator|.
name|len
argument_list|)
expr_stmt|;
name|m_copydata
argument_list|(
name|m
argument_list|,
literal|0
argument_list|,
name|m
operator|->
name|m_pkthdr
operator|.
name|len
argument_list|,
name|sc
operator|->
name|sc_ctrl_buffer
argument_list|)
expr_stmt|;
comment|/* Initialize a USB control request and then schedule it */
name|bzero
argument_list|(
operator|&
name|req
argument_list|,
sizeof|sizeof
argument_list|(
name|req
argument_list|)
argument_list|)
expr_stmt|;
name|req
operator|.
name|bmRequestType
operator|=
name|UBT_HCI_REQUEST
expr_stmt|;
name|USETW
argument_list|(
name|req
operator|.
name|wLength
argument_list|,
name|m
operator|->
name|m_pkthdr
operator|.
name|len
argument_list|)
expr_stmt|;
name|NG_UBT_INFO
argument_list|(
literal|"%s: %s - Sending control request, bmRequestType=%#x, wLength=%d\n"
argument_list|,
name|__func__
argument_list|,
name|USBDEVNAME
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|)
argument_list|,
name|req
operator|.
name|bmRequestType
argument_list|,
name|UGETW
argument_list|(
name|req
operator|.
name|wLength
argument_list|)
argument_list|)
expr_stmt|;
name|usbd_setup_default_xfer
argument_list|(
name|sc
operator|->
name|sc_ctrl_xfer
argument_list|,
name|sc
operator|->
name|sc_udev
argument_list|,
operator|(
name|usbd_private_handle
operator|)
name|sc
operator|->
name|sc_node
argument_list|,
name|USBD_DEFAULT_TIMEOUT
argument_list|,
comment|/* XXX */
operator|&
name|req
argument_list|,
name|sc
operator|->
name|sc_ctrl_buffer
argument_list|,
name|m
operator|->
name|m_pkthdr
operator|.
name|len
argument_list|,
name|USBD_NO_COPY
argument_list|,
name|ubt_request_complete
argument_list|)
expr_stmt|;
name|NG_NODE_REF
argument_list|(
name|sc
operator|->
name|sc_node
argument_list|)
expr_stmt|;
name|status
operator|=
name|usbd_transfer
argument_list|(
name|sc
operator|->
name|sc_ctrl_xfer
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|USBD_NORMAL_COMPLETION
operator|&&
name|status
operator|!=
name|USBD_IN_PROGRESS
condition|)
block|{
name|NG_UBT_ERR
argument_list|(
literal|"%s: %s - Could not start control request. %s (%d)\n"
argument_list|,
name|__func__
argument_list|,
name|USBDEVNAME
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|)
argument_list|,
name|usbd_errstr
argument_list|(
name|status
argument_list|)
argument_list|,
name|status
argument_list|)
expr_stmt|;
name|NG_NODE_UNREF
argument_list|(
name|sc
operator|->
name|sc_node
argument_list|)
expr_stmt|;
name|NG_BT_MBUFQ_DROP
argument_list|(
operator|&
name|sc
operator|->
name|sc_cmdq
argument_list|)
expr_stmt|;
name|NG_UBT_STAT_OERROR
argument_list|(
name|sc
operator|->
name|sc_stat
argument_list|)
expr_stmt|;
comment|/* XXX FIXME should we try to resubmit another request? */
block|}
else|else
block|{
name|NG_UBT_INFO
argument_list|(
literal|"%s: %s - Control request has been started\n"
argument_list|,
name|__func__
argument_list|,
name|USBDEVNAME
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|)
argument_list|)
expr_stmt|;
name|sc
operator|->
name|sc_flags
operator||=
name|UBT_CMD_XMIT
expr_stmt|;
name|status
operator|=
name|USBD_NORMAL_COMPLETION
expr_stmt|;
block|}
name|NG_FREE_M
argument_list|(
name|m
argument_list|)
expr_stmt|;
return|return
operator|(
name|status
operator|)
return|;
block|}
end_function

begin_comment
comment|/* ubt_request_start */
end_comment

begin_comment
comment|/*  * USB control request callback  */
end_comment

begin_function
name|Static
name|void
name|ubt_request_complete
parameter_list|(
name|usbd_xfer_handle
name|h
parameter_list|,
name|usbd_private_handle
name|p
parameter_list|,
name|usbd_status
name|s
parameter_list|)
block|{
name|ng_send_fn
argument_list|(
operator|(
name|node_p
operator|)
name|p
argument_list|,
name|NULL
argument_list|,
name|ubt_request_complete2
argument_list|,
operator|(
name|void
operator|*
operator|)
name|h
argument_list|,
name|s
argument_list|)
expr_stmt|;
name|NG_NODE_UNREF
argument_list|(
operator|(
name|node_p
operator|)
name|p
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* ubt_request_complete */
end_comment

begin_function
name|Static
name|void
name|ubt_request_complete2
parameter_list|(
name|node_p
name|node
parameter_list|,
name|hook_p
name|hook
parameter_list|,
name|void
modifier|*
name|arg1
parameter_list|,
name|int
name|arg2
parameter_list|)
block|{
name|ubt_softc_p
name|sc
init|=
operator|(
name|ubt_softc_p
operator|)
name|NG_NODE_PRIVATE
argument_list|(
name|node
argument_list|)
decl_stmt|;
name|usbd_xfer_handle
name|h
init|=
operator|(
name|usbd_xfer_handle
operator|)
name|arg1
decl_stmt|;
name|usbd_status
name|s
init|=
operator|(
name|usbd_status
operator|)
name|arg2
decl_stmt|;
if|if
condition|(
name|sc
operator|==
name|NULL
condition|)
return|return;
name|KASSERT
argument_list|(
operator|(
name|sc
operator|->
name|sc_flags
operator|&
name|UBT_CMD_XMIT
operator|)
argument_list|,
operator|(
literal|"%s: %s - No control request is pending\n"
operator|,
name|__func__
operator|,
name|USBDEVNAME
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|sc
operator|->
name|sc_flags
operator|&=
operator|~
name|UBT_CMD_XMIT
expr_stmt|;
if|if
condition|(
name|s
operator|==
name|USBD_CANCELLED
condition|)
block|{
name|NG_UBT_INFO
argument_list|(
literal|"%s: %s - Control request cancelled\n"
argument_list|,
name|__func__
argument_list|,
name|USBDEVNAME
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|)
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|s
operator|!=
name|USBD_NORMAL_COMPLETION
condition|)
block|{
name|NG_UBT_ERR
argument_list|(
literal|"%s: %s - Control request failed. %s (%d)\n"
argument_list|,
name|__func__
argument_list|,
name|USBDEVNAME
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|)
argument_list|,
name|usbd_errstr
argument_list|(
name|s
argument_list|)
argument_list|,
name|s
argument_list|)
expr_stmt|;
if|if
condition|(
name|s
operator|==
name|USBD_STALLED
condition|)
name|usbd_clear_endpoint_stall_async
argument_list|(
name|h
operator|->
name|pipe
argument_list|)
expr_stmt|;
name|NG_UBT_STAT_OERROR
argument_list|(
name|sc
operator|->
name|sc_stat
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|NG_UBT_INFO
argument_list|(
literal|"%s: %s - Sent %d bytes to control pipe\n"
argument_list|,
name|__func__
argument_list|,
name|USBDEVNAME
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|)
argument_list|,
name|h
operator|->
name|actlen
argument_list|)
expr_stmt|;
name|NG_UBT_STAT_BYTES_SENT
argument_list|(
name|sc
operator|->
name|sc_stat
argument_list|,
name|h
operator|->
name|actlen
argument_list|)
expr_stmt|;
name|NG_UBT_STAT_PCKTS_SENT
argument_list|(
name|sc
operator|->
name|sc_stat
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|NG_BT_MBUFQ_LEN
argument_list|(
operator|&
name|sc
operator|->
name|sc_cmdq
argument_list|)
operator|>
literal|0
condition|)
name|ubt_request_start
argument_list|(
name|sc
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* ubt_request_complete2 */
end_comment

begin_comment
comment|/*  * Start interrupt transfer. Must be called when node is locked  */
end_comment

begin_function
name|Static
name|usbd_status
name|ubt_intr_start
parameter_list|(
name|ubt_softc_p
name|sc
parameter_list|)
block|{
name|struct
name|mbuf
modifier|*
name|m
init|=
name|NULL
decl_stmt|;
name|usbd_status
name|status
decl_stmt|;
name|KASSERT
argument_list|(
operator|!
operator|(
name|sc
operator|->
name|sc_flags
operator|&
name|UBT_EVT_RECV
operator|)
argument_list|,
operator|(
literal|"%s: %s - Another interrupt request is pending\n"
operator|,
name|__func__
operator|,
name|USBDEVNAME
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|)
operator|)
argument_list|)
expr_stmt|;
comment|/* Allocate new mbuf cluster */
name|MGETHDR
argument_list|(
name|m
argument_list|,
name|M_DONTWAIT
argument_list|,
name|MT_DATA
argument_list|)
expr_stmt|;
if|if
condition|(
name|m
operator|==
name|NULL
condition|)
return|return
operator|(
name|USBD_NOMEM
operator|)
return|;
name|MCLGET
argument_list|(
name|m
argument_list|,
name|M_DONTWAIT
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|m
operator|->
name|m_flags
operator|&
name|M_EXT
operator|)
condition|)
block|{
name|NG_FREE_M
argument_list|(
name|m
argument_list|)
expr_stmt|;
return|return
operator|(
name|USBD_NOMEM
operator|)
return|;
block|}
if|if
condition|(
operator|!
operator|(
name|sc
operator|->
name|sc_flags
operator|&
name|UBT_HAVE_FRAME_TYPE
operator|)
condition|)
block|{
operator|*
name|mtod
argument_list|(
name|m
argument_list|,
name|u_int8_t
operator|*
argument_list|)
operator|=
name|NG_HCI_EVENT_PKT
expr_stmt|;
name|m
operator|->
name|m_pkthdr
operator|.
name|len
operator|=
name|m
operator|->
name|m_len
operator|=
literal|1
expr_stmt|;
block|}
else|else
name|m
operator|->
name|m_pkthdr
operator|.
name|len
operator|=
name|m
operator|->
name|m_len
operator|=
literal|0
expr_stmt|;
comment|/* Initialize a USB transfer and then schedule it */
name|usbd_setup_xfer
argument_list|(
name|sc
operator|->
name|sc_intr_xfer
argument_list|,
name|sc
operator|->
name|sc_intr_pipe
argument_list|,
operator|(
name|usbd_private_handle
operator|)
name|sc
operator|->
name|sc_node
argument_list|,
operator|(
name|void
operator|*
operator|)
operator|(
name|mtod
argument_list|(
name|m
argument_list|,
name|u_int8_t
operator|*
argument_list|)
operator|+
name|m
operator|->
name|m_len
operator|)
argument_list|,
name|MCLBYTES
operator|-
name|m
operator|->
name|m_len
argument_list|,
name|USBD_SHORT_XFER_OK
argument_list|,
name|USBD_NO_TIMEOUT
argument_list|,
name|ubt_intr_complete
argument_list|)
expr_stmt|;
name|NG_NODE_REF
argument_list|(
name|sc
operator|->
name|sc_node
argument_list|)
expr_stmt|;
name|status
operator|=
name|usbd_transfer
argument_list|(
name|sc
operator|->
name|sc_intr_xfer
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|USBD_NORMAL_COMPLETION
operator|&&
name|status
operator|!=
name|USBD_IN_PROGRESS
condition|)
block|{
name|NG_UBT_ERR
argument_list|(
literal|"%s: %s - Failed to start intrerrupt transfer. %s (%d)\n"
argument_list|,
name|__func__
argument_list|,
name|USBDEVNAME
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|)
argument_list|,
name|usbd_errstr
argument_list|(
name|status
argument_list|)
argument_list|,
name|status
argument_list|)
expr_stmt|;
name|NG_NODE_UNREF
argument_list|(
name|sc
operator|->
name|sc_node
argument_list|)
expr_stmt|;
name|NG_FREE_M
argument_list|(
name|m
argument_list|)
expr_stmt|;
return|return
operator|(
name|status
operator|)
return|;
block|}
name|sc
operator|->
name|sc_flags
operator||=
name|UBT_EVT_RECV
expr_stmt|;
name|sc
operator|->
name|sc_intr_buffer
operator|=
name|m
expr_stmt|;
return|return
operator|(
name|USBD_NORMAL_COMPLETION
operator|)
return|;
block|}
end_function

begin_comment
comment|/* ubt_intr_start */
end_comment

begin_comment
comment|/*  * Process interrupt from USB device (We got data from interrupt pipe)  */
end_comment

begin_function
name|Static
name|void
name|ubt_intr_complete
parameter_list|(
name|usbd_xfer_handle
name|h
parameter_list|,
name|usbd_private_handle
name|p
parameter_list|,
name|usbd_status
name|s
parameter_list|)
block|{
name|ng_send_fn
argument_list|(
operator|(
name|node_p
operator|)
name|p
argument_list|,
name|NULL
argument_list|,
name|ubt_intr_complete2
argument_list|,
operator|(
name|void
operator|*
operator|)
name|h
argument_list|,
name|s
argument_list|)
expr_stmt|;
name|NG_NODE_UNREF
argument_list|(
operator|(
name|node_p
operator|)
name|p
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* ubt_intr_complete */
end_comment

begin_function
name|Static
name|void
name|ubt_intr_complete2
parameter_list|(
name|node_p
name|node
parameter_list|,
name|hook_p
name|hook
parameter_list|,
name|void
modifier|*
name|arg1
parameter_list|,
name|int
name|arg2
parameter_list|)
block|{
name|ubt_softc_p
name|sc
init|=
operator|(
name|ubt_softc_p
operator|)
name|NG_NODE_PRIVATE
argument_list|(
name|node
argument_list|)
decl_stmt|;
name|usbd_xfer_handle
name|h
init|=
operator|(
name|usbd_xfer_handle
operator|)
name|arg1
decl_stmt|;
name|usbd_status
name|s
init|=
operator|(
name|usbd_status
operator|)
name|arg2
decl_stmt|;
name|struct
name|mbuf
modifier|*
name|m
init|=
name|NULL
decl_stmt|;
name|ng_hci_event_pkt_t
modifier|*
name|hdr
init|=
name|NULL
decl_stmt|;
name|int
name|error
decl_stmt|;
if|if
condition|(
name|sc
operator|==
name|NULL
condition|)
return|return;
name|KASSERT
argument_list|(
operator|(
name|sc
operator|->
name|sc_flags
operator|&
name|UBT_EVT_RECV
operator|)
argument_list|,
operator|(
literal|"%s: %s - No interrupt request is pending\n"
operator|,
name|__func__
operator|,
name|USBDEVNAME
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|sc
operator|->
name|sc_flags
operator|&=
operator|~
name|UBT_EVT_RECV
expr_stmt|;
name|m
operator|=
name|sc
operator|->
name|sc_intr_buffer
expr_stmt|;
name|sc
operator|->
name|sc_intr_buffer
operator|=
name|NULL
expr_stmt|;
name|hdr
operator|=
name|mtod
argument_list|(
name|m
argument_list|,
name|ng_hci_event_pkt_t
operator|*
argument_list|)
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|sc_hook
operator|==
name|NULL
operator|||
name|NG_HOOK_NOT_VALID
argument_list|(
name|sc
operator|->
name|sc_hook
argument_list|)
condition|)
block|{
name|NG_UBT_INFO
argument_list|(
literal|"%s: %s - No upstream hook\n"
argument_list|,
name|__func__
argument_list|,
name|USBDEVNAME
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|)
argument_list|)
expr_stmt|;
name|NG_FREE_M
argument_list|(
name|m
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|s
operator|==
name|USBD_CANCELLED
condition|)
block|{
name|NG_UBT_INFO
argument_list|(
literal|"%s: %s - Interrupt xfer cancelled\n"
argument_list|,
name|__func__
argument_list|,
name|USBDEVNAME
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|)
argument_list|)
expr_stmt|;
name|NG_FREE_M
argument_list|(
name|m
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|s
operator|!=
name|USBD_NORMAL_COMPLETION
condition|)
block|{
name|NG_UBT_WARN
argument_list|(
literal|"%s: %s - Interrupt xfer failed, %s (%d). No new xfer will be submitted!\n"
argument_list|,
name|__func__
argument_list|,
name|USBDEVNAME
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|)
argument_list|,
name|usbd_errstr
argument_list|(
name|s
argument_list|)
argument_list|,
name|s
argument_list|)
expr_stmt|;
if|if
condition|(
name|s
operator|==
name|USBD_STALLED
condition|)
name|usbd_clear_endpoint_stall_async
argument_list|(
name|sc
operator|->
name|sc_intr_pipe
argument_list|)
expr_stmt|;
name|NG_UBT_STAT_IERROR
argument_list|(
name|sc
operator|->
name|sc_stat
argument_list|)
expr_stmt|;
name|NG_FREE_M
argument_list|(
name|m
argument_list|)
expr_stmt|;
return|return;
comment|/* XXX FIXME we should restart after some delay */
block|}
name|NG_UBT_STAT_BYTES_RECV
argument_list|(
name|sc
operator|->
name|sc_stat
argument_list|,
name|h
operator|->
name|actlen
argument_list|)
expr_stmt|;
name|m
operator|->
name|m_pkthdr
operator|.
name|len
operator|+=
name|h
operator|->
name|actlen
expr_stmt|;
name|m
operator|->
name|m_len
operator|+=
name|h
operator|->
name|actlen
expr_stmt|;
name|NG_UBT_INFO
argument_list|(
literal|"%s: %s - Got %d bytes from interrupt pipe\n"
argument_list|,
name|__func__
argument_list|,
name|USBDEVNAME
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|)
argument_list|,
name|h
operator|->
name|actlen
argument_list|)
expr_stmt|;
if|if
condition|(
name|m
operator|->
name|m_pkthdr
operator|.
name|len
operator|<
sizeof|sizeof
argument_list|(
operator|*
name|hdr
argument_list|)
condition|)
block|{
name|NG_FREE_M
argument_list|(
name|m
argument_list|)
expr_stmt|;
goto|goto
name|done
goto|;
block|}
if|if
condition|(
name|hdr
operator|->
name|length
operator|==
name|m
operator|->
name|m_pkthdr
operator|.
name|len
operator|-
sizeof|sizeof
argument_list|(
operator|*
name|hdr
argument_list|)
condition|)
block|{
name|NG_UBT_INFO
argument_list|(
literal|"%s: %s - Got complete HCI event frame, pktlen=%d, length=%d\n"
argument_list|,
name|__func__
argument_list|,
name|USBDEVNAME
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|)
argument_list|,
name|m
operator|->
name|m_pkthdr
operator|.
name|len
argument_list|,
name|hdr
operator|->
name|length
argument_list|)
expr_stmt|;
name|NG_UBT_STAT_PCKTS_RECV
argument_list|(
name|sc
operator|->
name|sc_stat
argument_list|)
expr_stmt|;
name|NG_SEND_DATA_ONLY
argument_list|(
name|error
argument_list|,
name|sc
operator|->
name|sc_hook
argument_list|,
name|m
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|!=
literal|0
condition|)
name|NG_UBT_STAT_IERROR
argument_list|(
name|sc
operator|->
name|sc_stat
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|NG_UBT_ERR
argument_list|(
literal|"%s: %s - Invalid HCI event frame size, length=%d, pktlen=%d\n"
argument_list|,
name|__func__
argument_list|,
name|USBDEVNAME
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|)
argument_list|,
name|hdr
operator|->
name|length
argument_list|,
name|m
operator|->
name|m_pkthdr
operator|.
name|len
argument_list|)
expr_stmt|;
name|NG_UBT_STAT_IERROR
argument_list|(
name|sc
operator|->
name|sc_stat
argument_list|)
expr_stmt|;
name|NG_FREE_M
argument_list|(
name|m
argument_list|)
expr_stmt|;
block|}
name|done
label|:
name|ubt_intr_start
argument_list|(
name|sc
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* ubt_intr_complete2 */
end_comment

begin_comment
comment|/*  * Start bulk-in USB transfer (ACL data). Must be called when node is locked  */
end_comment

begin_function
name|Static
name|usbd_status
name|ubt_bulk_in_start
parameter_list|(
name|ubt_softc_p
name|sc
parameter_list|)
block|{
name|struct
name|mbuf
modifier|*
name|m
init|=
name|NULL
decl_stmt|;
name|usbd_status
name|status
decl_stmt|;
name|KASSERT
argument_list|(
operator|!
operator|(
name|sc
operator|->
name|sc_flags
operator|&
name|UBT_ACL_RECV
operator|)
argument_list|,
operator|(
literal|"%s: %s - Another bulk-in request is pending\n"
operator|,
name|__func__
operator|,
name|USBDEVNAME
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|)
operator|)
argument_list|)
expr_stmt|;
comment|/* Allocate new mbuf cluster */
name|MGETHDR
argument_list|(
name|m
argument_list|,
name|M_DONTWAIT
argument_list|,
name|MT_DATA
argument_list|)
expr_stmt|;
if|if
condition|(
name|m
operator|==
name|NULL
condition|)
return|return
operator|(
name|USBD_NOMEM
operator|)
return|;
name|MCLGET
argument_list|(
name|m
argument_list|,
name|M_DONTWAIT
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|m
operator|->
name|m_flags
operator|&
name|M_EXT
operator|)
condition|)
block|{
name|NG_FREE_M
argument_list|(
name|m
argument_list|)
expr_stmt|;
return|return
operator|(
name|USBD_NOMEM
operator|)
return|;
block|}
if|if
condition|(
operator|!
operator|(
name|sc
operator|->
name|sc_flags
operator|&
name|UBT_HAVE_FRAME_TYPE
operator|)
condition|)
block|{
operator|*
name|mtod
argument_list|(
name|m
argument_list|,
name|u_int8_t
operator|*
argument_list|)
operator|=
name|NG_HCI_ACL_DATA_PKT
expr_stmt|;
name|m
operator|->
name|m_pkthdr
operator|.
name|len
operator|=
name|m
operator|->
name|m_len
operator|=
literal|1
expr_stmt|;
block|}
else|else
name|m
operator|->
name|m_pkthdr
operator|.
name|len
operator|=
name|m
operator|->
name|m_len
operator|=
literal|0
expr_stmt|;
comment|/* Initialize a bulk-in USB transfer and then schedule it */
name|usbd_setup_xfer
argument_list|(
name|sc
operator|->
name|sc_bulk_in_xfer
argument_list|,
name|sc
operator|->
name|sc_bulk_in_pipe
argument_list|,
operator|(
name|usbd_private_handle
operator|)
name|sc
operator|->
name|sc_node
argument_list|,
operator|(
name|void
operator|*
operator|)
operator|(
name|mtod
argument_list|(
name|m
argument_list|,
name|u_int8_t
operator|*
argument_list|)
operator|+
name|m
operator|->
name|m_len
operator|)
argument_list|,
name|MCLBYTES
operator|-
name|m
operator|->
name|m_len
argument_list|,
name|USBD_SHORT_XFER_OK
argument_list|,
name|USBD_NO_TIMEOUT
argument_list|,
name|ubt_bulk_in_complete
argument_list|)
expr_stmt|;
name|NG_NODE_REF
argument_list|(
name|sc
operator|->
name|sc_node
argument_list|)
expr_stmt|;
name|status
operator|=
name|usbd_transfer
argument_list|(
name|sc
operator|->
name|sc_bulk_in_xfer
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|USBD_NORMAL_COMPLETION
operator|&&
name|status
operator|!=
name|USBD_IN_PROGRESS
condition|)
block|{
name|NG_UBT_ERR
argument_list|(
literal|"%s: %s - Failed to start bulk-in transfer. %s (%d)\n"
argument_list|,
name|__func__
argument_list|,
name|USBDEVNAME
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|)
argument_list|,
name|usbd_errstr
argument_list|(
name|status
argument_list|)
argument_list|,
name|status
argument_list|)
expr_stmt|;
name|NG_NODE_UNREF
argument_list|(
name|sc
operator|->
name|sc_node
argument_list|)
expr_stmt|;
name|NG_FREE_M
argument_list|(
name|m
argument_list|)
expr_stmt|;
return|return
operator|(
name|status
operator|)
return|;
block|}
name|sc
operator|->
name|sc_flags
operator||=
name|UBT_ACL_RECV
expr_stmt|;
name|sc
operator|->
name|sc_bulk_in_buffer
operator|=
name|m
expr_stmt|;
return|return
operator|(
name|USBD_NORMAL_COMPLETION
operator|)
return|;
block|}
end_function

begin_comment
comment|/* ubt_bulk_in_start */
end_comment

begin_comment
comment|/*  * USB bulk-in transfer callback  */
end_comment

begin_function
name|Static
name|void
name|ubt_bulk_in_complete
parameter_list|(
name|usbd_xfer_handle
name|h
parameter_list|,
name|usbd_private_handle
name|p
parameter_list|,
name|usbd_status
name|s
parameter_list|)
block|{
name|ng_send_fn
argument_list|(
operator|(
name|node_p
operator|)
name|p
argument_list|,
name|NULL
argument_list|,
name|ubt_bulk_in_complete2
argument_list|,
operator|(
name|void
operator|*
operator|)
name|h
argument_list|,
name|s
argument_list|)
expr_stmt|;
name|NG_NODE_UNREF
argument_list|(
operator|(
name|node_p
operator|)
name|p
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* ubt_bulk_in_complete */
end_comment

begin_function
name|Static
name|void
name|ubt_bulk_in_complete2
parameter_list|(
name|node_p
name|node
parameter_list|,
name|hook_p
name|hook
parameter_list|,
name|void
modifier|*
name|arg1
parameter_list|,
name|int
name|arg2
parameter_list|)
block|{
name|ubt_softc_p
name|sc
init|=
operator|(
name|ubt_softc_p
operator|)
name|NG_NODE_PRIVATE
argument_list|(
name|node
argument_list|)
decl_stmt|;
name|usbd_xfer_handle
name|h
init|=
operator|(
name|usbd_xfer_handle
operator|)
name|arg1
decl_stmt|;
name|usbd_status
name|s
init|=
operator|(
name|usbd_status
operator|)
name|arg2
decl_stmt|;
name|struct
name|mbuf
modifier|*
name|m
init|=
name|NULL
decl_stmt|;
name|ng_hci_acldata_pkt_t
modifier|*
name|hdr
init|=
name|NULL
decl_stmt|;
name|int
name|len
decl_stmt|;
if|if
condition|(
name|sc
operator|==
name|NULL
condition|)
return|return;
name|KASSERT
argument_list|(
operator|(
name|sc
operator|->
name|sc_flags
operator|&
name|UBT_ACL_RECV
operator|)
argument_list|,
operator|(
literal|"%s: %s - No bulk-in request is pending\n"
operator|,
name|__func__
operator|,
name|USBDEVNAME
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|sc
operator|->
name|sc_flags
operator|&=
operator|~
name|UBT_ACL_RECV
expr_stmt|;
name|m
operator|=
name|sc
operator|->
name|sc_bulk_in_buffer
expr_stmt|;
name|sc
operator|->
name|sc_bulk_in_buffer
operator|=
name|NULL
expr_stmt|;
name|hdr
operator|=
name|mtod
argument_list|(
name|m
argument_list|,
name|ng_hci_acldata_pkt_t
operator|*
argument_list|)
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|sc_hook
operator|==
name|NULL
operator|||
name|NG_HOOK_NOT_VALID
argument_list|(
name|sc
operator|->
name|sc_hook
argument_list|)
condition|)
block|{
name|NG_UBT_INFO
argument_list|(
literal|"%s: %s - No upstream hook\n"
argument_list|,
name|__func__
argument_list|,
name|USBDEVNAME
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|)
argument_list|)
expr_stmt|;
name|NG_FREE_M
argument_list|(
name|m
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|s
operator|==
name|USBD_CANCELLED
condition|)
block|{
name|NG_UBT_INFO
argument_list|(
literal|"%s: %s - Bulk-in xfer cancelled, pipe=%p\n"
argument_list|,
name|__func__
argument_list|,
name|USBDEVNAME
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|)
argument_list|,
name|sc
operator|->
name|sc_bulk_in_pipe
argument_list|)
expr_stmt|;
name|NG_FREE_M
argument_list|(
name|m
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|s
operator|!=
name|USBD_NORMAL_COMPLETION
condition|)
block|{
name|NG_UBT_WARN
argument_list|(
literal|"%s: %s - Bulk-in xfer failed, %s (%d). No new xfer will be submitted!\n"
argument_list|,
name|__func__
argument_list|,
name|USBDEVNAME
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|)
argument_list|,
name|usbd_errstr
argument_list|(
name|s
argument_list|)
argument_list|,
name|s
argument_list|)
expr_stmt|;
if|if
condition|(
name|s
operator|==
name|USBD_STALLED
condition|)
name|usbd_clear_endpoint_stall_async
argument_list|(
name|sc
operator|->
name|sc_bulk_in_pipe
argument_list|)
expr_stmt|;
name|NG_UBT_STAT_IERROR
argument_list|(
name|sc
operator|->
name|sc_stat
argument_list|)
expr_stmt|;
name|NG_FREE_M
argument_list|(
name|m
argument_list|)
expr_stmt|;
return|return;
comment|/* XXX FIXME we should restart after some delay */
block|}
name|NG_UBT_STAT_BYTES_RECV
argument_list|(
name|sc
operator|->
name|sc_stat
argument_list|,
name|h
operator|->
name|actlen
argument_list|)
expr_stmt|;
name|m
operator|->
name|m_pkthdr
operator|.
name|len
operator|+=
name|h
operator|->
name|actlen
expr_stmt|;
name|m
operator|->
name|m_len
operator|+=
name|h
operator|->
name|actlen
expr_stmt|;
name|NG_UBT_INFO
argument_list|(
literal|"%s: %s - Got %d bytes from bulk-in pipe\n"
argument_list|,
name|__func__
argument_list|,
name|USBDEVNAME
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|)
argument_list|,
name|h
operator|->
name|actlen
argument_list|)
expr_stmt|;
if|if
condition|(
name|m
operator|->
name|m_pkthdr
operator|.
name|len
operator|<
sizeof|sizeof
argument_list|(
operator|*
name|hdr
argument_list|)
condition|)
block|{
name|NG_FREE_M
argument_list|(
name|m
argument_list|)
expr_stmt|;
goto|goto
name|done
goto|;
block|}
name|len
operator|=
name|le16toh
argument_list|(
name|hdr
operator|->
name|length
argument_list|)
expr_stmt|;
if|if
condition|(
name|len
operator|==
name|m
operator|->
name|m_pkthdr
operator|.
name|len
operator|-
sizeof|sizeof
argument_list|(
operator|*
name|hdr
argument_list|)
condition|)
block|{
name|NG_UBT_INFO
argument_list|(
literal|"%s: %s - Got complete ACL data frame, pktlen=%d, length=%d\n"
argument_list|,
name|__func__
argument_list|,
name|USBDEVNAME
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|)
argument_list|,
name|m
operator|->
name|m_pkthdr
operator|.
name|len
argument_list|,
name|len
argument_list|)
expr_stmt|;
name|NG_UBT_STAT_PCKTS_RECV
argument_list|(
name|sc
operator|->
name|sc_stat
argument_list|)
expr_stmt|;
name|NG_SEND_DATA_ONLY
argument_list|(
name|len
argument_list|,
name|sc
operator|->
name|sc_hook
argument_list|,
name|m
argument_list|)
expr_stmt|;
if|if
condition|(
name|len
operator|!=
literal|0
condition|)
name|NG_UBT_STAT_IERROR
argument_list|(
name|sc
operator|->
name|sc_stat
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|NG_UBT_ERR
argument_list|(
literal|"%s: %s - Invalid ACL frame size, length=%d, pktlen=%d\n"
argument_list|,
name|__func__
argument_list|,
name|USBDEVNAME
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|)
argument_list|,
name|len
argument_list|,
name|m
operator|->
name|m_pkthdr
operator|.
name|len
argument_list|)
expr_stmt|;
name|NG_UBT_STAT_IERROR
argument_list|(
name|sc
operator|->
name|sc_stat
argument_list|)
expr_stmt|;
name|NG_FREE_M
argument_list|(
name|m
argument_list|)
expr_stmt|;
block|}
name|done
label|:
name|ubt_bulk_in_start
argument_list|(
name|sc
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* ubt_bulk_in_complete2 */
end_comment

begin_comment
comment|/*  * Start bulk-out USB transfer. Must be called with node locked  */
end_comment

begin_function
name|Static
name|usbd_status
name|ubt_bulk_out_start
parameter_list|(
name|ubt_softc_p
name|sc
parameter_list|)
block|{
name|struct
name|mbuf
modifier|*
name|m
init|=
name|NULL
decl_stmt|;
name|usbd_status
name|status
decl_stmt|;
name|KASSERT
argument_list|(
operator|!
operator|(
name|sc
operator|->
name|sc_flags
operator|&
name|UBT_ACL_XMIT
operator|)
argument_list|,
operator|(
literal|"%s: %s - Another bulk-out request is pending\n"
operator|,
name|__func__
operator|,
name|USBDEVNAME
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|NG_BT_MBUFQ_DEQUEUE
argument_list|(
operator|&
name|sc
operator|->
name|sc_aclq
argument_list|,
name|m
argument_list|)
expr_stmt|;
if|if
condition|(
name|m
operator|==
name|NULL
condition|)
block|{
name|NG_UBT_INFO
argument_list|(
literal|"%s: %s - ACL data queue is empty\n"
argument_list|,
name|__func__
argument_list|,
name|USBDEVNAME
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|(
name|USBD_NORMAL_COMPLETION
operator|)
return|;
block|}
comment|/* 	 * Check ACL data frame size and copy it back to linear USB  	 * transfer buffer. 	 */
if|if
condition|(
name|m
operator|->
name|m_pkthdr
operator|.
name|len
operator|>
name|UBT_BULK_BUFFER_SIZE
condition|)
name|panic
argument_list|(
literal|"%s: %s - ACL data frame too big, size=%d, len=%d\n"
argument_list|,
name|__func__
argument_list|,
name|USBDEVNAME
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|)
argument_list|,
name|UBT_BULK_BUFFER_SIZE
argument_list|,
name|m
operator|->
name|m_pkthdr
operator|.
name|len
argument_list|)
expr_stmt|;
name|m_copydata
argument_list|(
name|m
argument_list|,
literal|0
argument_list|,
name|m
operator|->
name|m_pkthdr
operator|.
name|len
argument_list|,
name|sc
operator|->
name|sc_bulk_out_buffer
argument_list|)
expr_stmt|;
comment|/* Initialize a bulk-out USB transfer and then schedule it */
name|usbd_setup_xfer
argument_list|(
name|sc
operator|->
name|sc_bulk_out_xfer
argument_list|,
name|sc
operator|->
name|sc_bulk_out_pipe
argument_list|,
operator|(
name|usbd_private_handle
operator|)
name|sc
operator|->
name|sc_node
argument_list|,
name|sc
operator|->
name|sc_bulk_out_buffer
argument_list|,
name|m
operator|->
name|m_pkthdr
operator|.
name|len
argument_list|,
name|USBD_NO_COPY
argument_list|,
name|USBD_DEFAULT_TIMEOUT
argument_list|,
comment|/* XXX */
name|ubt_bulk_out_complete
argument_list|)
expr_stmt|;
name|NG_NODE_REF
argument_list|(
name|sc
operator|->
name|sc_node
argument_list|)
expr_stmt|;
name|status
operator|=
name|usbd_transfer
argument_list|(
name|sc
operator|->
name|sc_bulk_out_xfer
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|USBD_NORMAL_COMPLETION
operator|&&
name|status
operator|!=
name|USBD_IN_PROGRESS
condition|)
block|{
name|NG_UBT_ERR
argument_list|(
literal|"%s: %s - Could not start bulk-out transfer. %s (%d)\n"
argument_list|,
name|__func__
argument_list|,
name|USBDEVNAME
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|)
argument_list|,
name|usbd_errstr
argument_list|(
name|status
argument_list|)
argument_list|,
name|status
argument_list|)
expr_stmt|;
name|NG_NODE_UNREF
argument_list|(
name|sc
operator|->
name|sc_node
argument_list|)
expr_stmt|;
name|NG_BT_MBUFQ_DROP
argument_list|(
operator|&
name|sc
operator|->
name|sc_aclq
argument_list|)
expr_stmt|;
name|NG_UBT_STAT_OERROR
argument_list|(
name|sc
operator|->
name|sc_stat
argument_list|)
expr_stmt|;
comment|/* XXX FIXME should we try to start another transfer? */
block|}
else|else
block|{
name|NG_UBT_INFO
argument_list|(
literal|"%s: %s - Bulk-out transfer has been started, len=%d\n"
argument_list|,
name|__func__
argument_list|,
name|USBDEVNAME
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|)
argument_list|,
name|m
operator|->
name|m_pkthdr
operator|.
name|len
argument_list|)
expr_stmt|;
name|sc
operator|->
name|sc_flags
operator||=
name|UBT_ACL_XMIT
expr_stmt|;
name|status
operator|=
name|USBD_NORMAL_COMPLETION
expr_stmt|;
block|}
name|NG_FREE_M
argument_list|(
name|m
argument_list|)
expr_stmt|;
return|return
operator|(
name|status
operator|)
return|;
block|}
end_function

begin_comment
comment|/* ubt_bulk_out_start */
end_comment

begin_comment
comment|/*  * USB bulk-out transfer callback  */
end_comment

begin_function
name|Static
name|void
name|ubt_bulk_out_complete
parameter_list|(
name|usbd_xfer_handle
name|h
parameter_list|,
name|usbd_private_handle
name|p
parameter_list|,
name|usbd_status
name|s
parameter_list|)
block|{
name|ng_send_fn
argument_list|(
operator|(
name|node_p
operator|)
name|p
argument_list|,
name|NULL
argument_list|,
name|ubt_bulk_out_complete2
argument_list|,
operator|(
name|void
operator|*
operator|)
name|h
argument_list|,
name|s
argument_list|)
expr_stmt|;
name|NG_NODE_UNREF
argument_list|(
operator|(
name|node_p
operator|)
name|p
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* ubt_bulk_out_complete */
end_comment

begin_function
name|Static
name|void
name|ubt_bulk_out_complete2
parameter_list|(
name|node_p
name|node
parameter_list|,
name|hook_p
name|hook
parameter_list|,
name|void
modifier|*
name|arg1
parameter_list|,
name|int
name|arg2
parameter_list|)
block|{
name|ubt_softc_p
name|sc
init|=
operator|(
name|ubt_softc_p
operator|)
name|NG_NODE_PRIVATE
argument_list|(
name|node
argument_list|)
decl_stmt|;
name|usbd_xfer_handle
name|h
init|=
operator|(
name|usbd_xfer_handle
operator|)
name|arg1
decl_stmt|;
name|usbd_status
name|s
init|=
operator|(
name|usbd_status
operator|)
name|arg2
decl_stmt|;
if|if
condition|(
name|sc
operator|==
name|NULL
condition|)
return|return;
name|KASSERT
argument_list|(
operator|(
name|sc
operator|->
name|sc_flags
operator|&
name|UBT_ACL_XMIT
operator|)
argument_list|,
operator|(
literal|"%s: %s - No bulk-out request is pending\n"
operator|,
name|__func__
operator|,
name|USBDEVNAME
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|sc
operator|->
name|sc_flags
operator|&=
operator|~
name|UBT_ACL_XMIT
expr_stmt|;
if|if
condition|(
name|s
operator|==
name|USBD_CANCELLED
condition|)
block|{
name|NG_UBT_INFO
argument_list|(
literal|"%s: %s - Bulk-out xfer cancelled, pipe=%p\n"
argument_list|,
name|__func__
argument_list|,
name|USBDEVNAME
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|)
argument_list|,
name|sc
operator|->
name|sc_bulk_out_pipe
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|s
operator|!=
name|USBD_NORMAL_COMPLETION
condition|)
block|{
name|NG_UBT_WARN
argument_list|(
literal|"%s: %s - Bulk-out xfer failed. %s (%d)\n"
argument_list|,
name|__func__
argument_list|,
name|USBDEVNAME
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|)
argument_list|,
name|usbd_errstr
argument_list|(
name|s
argument_list|)
argument_list|,
name|s
argument_list|)
expr_stmt|;
if|if
condition|(
name|s
operator|==
name|USBD_STALLED
condition|)
name|usbd_clear_endpoint_stall_async
argument_list|(
name|sc
operator|->
name|sc_bulk_out_pipe
argument_list|)
expr_stmt|;
name|NG_UBT_STAT_OERROR
argument_list|(
name|sc
operator|->
name|sc_stat
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|NG_UBT_INFO
argument_list|(
literal|"%s: %s - Sent %d bytes to bulk-out pipe\n"
argument_list|,
name|__func__
argument_list|,
name|USBDEVNAME
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|)
argument_list|,
name|h
operator|->
name|actlen
argument_list|)
expr_stmt|;
name|NG_UBT_STAT_BYTES_SENT
argument_list|(
name|sc
operator|->
name|sc_stat
argument_list|,
name|h
operator|->
name|actlen
argument_list|)
expr_stmt|;
name|NG_UBT_STAT_PCKTS_SENT
argument_list|(
name|sc
operator|->
name|sc_stat
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|NG_BT_MBUFQ_LEN
argument_list|(
operator|&
name|sc
operator|->
name|sc_aclq
argument_list|)
operator|>
literal|0
condition|)
name|ubt_bulk_out_start
argument_list|(
name|sc
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* ubt_bulk_out_complete2 */
end_comment

begin_comment
comment|/*  * Start Isochronous-in USB transfer. Must be called with node locked  */
end_comment

begin_function
name|Static
name|usbd_status
name|ubt_isoc_in_start
parameter_list|(
name|ubt_softc_p
name|sc
parameter_list|)
block|{
name|usbd_status
name|status
decl_stmt|;
name|int
name|i
decl_stmt|;
name|KASSERT
argument_list|(
operator|!
operator|(
name|sc
operator|->
name|sc_flags
operator|&
name|UBT_SCO_RECV
operator|)
argument_list|,
operator|(
literal|"%s: %s - Another isoc-in request is pending\n"
operator|,
name|__func__
operator|,
name|USBDEVNAME
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|)
operator|)
argument_list|)
expr_stmt|;
comment|/* Initialize a isoc-in USB transfer and then schedule it */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|sc
operator|->
name|sc_isoc_nframes
condition|;
name|i
operator|++
control|)
name|sc
operator|->
name|sc_isoc_in_frlen
index|[
name|i
index|]
operator|=
name|sc
operator|->
name|sc_isoc_size
expr_stmt|;
name|usbd_setup_isoc_xfer
argument_list|(
name|sc
operator|->
name|sc_isoc_in_xfer
argument_list|,
name|sc
operator|->
name|sc_isoc_in_pipe
argument_list|,
operator|(
name|usbd_private_handle
operator|)
name|sc
operator|->
name|sc_node
argument_list|,
name|sc
operator|->
name|sc_isoc_in_frlen
argument_list|,
name|sc
operator|->
name|sc_isoc_nframes
argument_list|,
name|USBD_NO_COPY
argument_list|,
comment|/* XXX flags */
name|ubt_isoc_in_complete
argument_list|)
expr_stmt|;
name|NG_NODE_REF
argument_list|(
name|sc
operator|->
name|sc_node
argument_list|)
expr_stmt|;
name|status
operator|=
name|usbd_transfer
argument_list|(
name|sc
operator|->
name|sc_isoc_in_xfer
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|USBD_NORMAL_COMPLETION
operator|&&
name|status
operator|!=
name|USBD_IN_PROGRESS
condition|)
block|{
name|NG_UBT_ERR
argument_list|(
literal|"%s: %s - Failed to start isoc-in transfer. %s (%d)\n"
argument_list|,
name|__func__
argument_list|,
name|USBDEVNAME
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|)
argument_list|,
name|usbd_errstr
argument_list|(
name|status
argument_list|)
argument_list|,
name|status
argument_list|)
expr_stmt|;
name|NG_NODE_UNREF
argument_list|(
name|sc
operator|->
name|sc_node
argument_list|)
expr_stmt|;
return|return
operator|(
name|status
operator|)
return|;
block|}
name|sc
operator|->
name|sc_flags
operator||=
name|UBT_SCO_RECV
expr_stmt|;
return|return
operator|(
name|USBD_NORMAL_COMPLETION
operator|)
return|;
block|}
end_function

begin_comment
comment|/* ubt_isoc_in_start */
end_comment

begin_comment
comment|/*  * USB isochronous transfer callback  */
end_comment

begin_function
name|Static
name|void
name|ubt_isoc_in_complete
parameter_list|(
name|usbd_xfer_handle
name|h
parameter_list|,
name|usbd_private_handle
name|p
parameter_list|,
name|usbd_status
name|s
parameter_list|)
block|{
name|ng_send_fn
argument_list|(
operator|(
name|node_p
operator|)
name|p
argument_list|,
name|NULL
argument_list|,
name|ubt_isoc_in_complete2
argument_list|,
operator|(
name|void
operator|*
operator|)
name|h
argument_list|,
name|s
argument_list|)
expr_stmt|;
name|NG_NODE_UNREF
argument_list|(
operator|(
name|node_p
operator|)
name|p
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* ubt_isoc_in_complete */
end_comment

begin_function
name|Static
name|void
name|ubt_isoc_in_complete2
parameter_list|(
name|node_p
name|node
parameter_list|,
name|hook_p
name|hook
parameter_list|,
name|void
modifier|*
name|arg1
parameter_list|,
name|int
name|arg2
parameter_list|)
block|{
name|ubt_softc_p
name|sc
init|=
operator|(
name|ubt_softc_p
operator|)
name|NG_NODE_PRIVATE
argument_list|(
name|node
argument_list|)
decl_stmt|;
name|usbd_xfer_handle
name|h
init|=
operator|(
name|usbd_xfer_handle
operator|)
name|arg1
decl_stmt|;
name|usbd_status
name|s
init|=
operator|(
name|usbd_status
operator|)
name|arg2
decl_stmt|;
name|struct
name|mbuf
modifier|*
name|m
init|=
name|NULL
decl_stmt|;
name|ng_hci_scodata_pkt_t
modifier|*
name|hdr
init|=
name|NULL
decl_stmt|;
name|u_int8_t
modifier|*
name|b
init|=
name|NULL
decl_stmt|;
name|int
name|i
decl_stmt|;
if|if
condition|(
name|sc
operator|==
name|NULL
condition|)
return|return;
name|KASSERT
argument_list|(
operator|(
name|sc
operator|->
name|sc_flags
operator|&
name|UBT_SCO_RECV
operator|)
argument_list|,
operator|(
literal|"%s: %s - No isoc-in request is pending\n"
operator|,
name|__func__
operator|,
name|USBDEVNAME
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|sc
operator|->
name|sc_flags
operator|&=
operator|~
name|UBT_SCO_RECV
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|sc_hook
operator|==
name|NULL
operator|||
name|NG_HOOK_NOT_VALID
argument_list|(
name|sc
operator|->
name|sc_hook
argument_list|)
condition|)
block|{
name|NG_UBT_INFO
argument_list|(
literal|"%s: %s - No upstream hook\n"
argument_list|,
name|__func__
argument_list|,
name|USBDEVNAME
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|)
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|s
operator|==
name|USBD_CANCELLED
condition|)
block|{
name|NG_UBT_INFO
argument_list|(
literal|"%s: %s - Isoc-in xfer cancelled, pipe=%p\n"
argument_list|,
name|__func__
argument_list|,
name|USBDEVNAME
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|)
argument_list|,
name|sc
operator|->
name|sc_isoc_in_pipe
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|s
operator|!=
name|USBD_NORMAL_COMPLETION
condition|)
block|{
name|NG_UBT_WARN
argument_list|(
literal|"%s: %s - Isoc-in xfer failed, %s (%d). No new xfer will be submitted!\n"
argument_list|,
name|__func__
argument_list|,
name|USBDEVNAME
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|)
argument_list|,
name|usbd_errstr
argument_list|(
name|s
argument_list|)
argument_list|,
name|s
argument_list|)
expr_stmt|;
if|if
condition|(
name|s
operator|==
name|USBD_STALLED
condition|)
name|usbd_clear_endpoint_stall_async
argument_list|(
name|sc
operator|->
name|sc_isoc_in_pipe
argument_list|)
expr_stmt|;
name|NG_UBT_STAT_IERROR
argument_list|(
name|sc
operator|->
name|sc_stat
argument_list|)
expr_stmt|;
return|return;
comment|/* XXX FIXME we should restart after some delay */
block|}
name|NG_UBT_STAT_BYTES_RECV
argument_list|(
name|sc
operator|->
name|sc_stat
argument_list|,
name|h
operator|->
name|actlen
argument_list|)
expr_stmt|;
name|NG_UBT_INFO
argument_list|(
literal|"%s: %s - Got %d bytes from isoc-in pipe\n"
argument_list|,
name|__func__
argument_list|,
name|USBDEVNAME
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|)
argument_list|,
name|h
operator|->
name|actlen
argument_list|)
expr_stmt|;
comment|/* Copy SCO data frame to mbuf */
name|MGETHDR
argument_list|(
name|m
argument_list|,
name|M_DONTWAIT
argument_list|,
name|MT_DATA
argument_list|)
expr_stmt|;
if|if
condition|(
name|m
operator|==
name|NULL
condition|)
block|{
name|NG_UBT_ALERT
argument_list|(
literal|"%s: %s - Could not allocate mbuf\n"
argument_list|,
name|__func__
argument_list|,
name|USBDEVNAME
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|)
argument_list|)
expr_stmt|;
name|NG_UBT_STAT_IERROR
argument_list|(
name|sc
operator|->
name|sc_stat
argument_list|)
expr_stmt|;
goto|goto
name|done
goto|;
block|}
comment|/* Fix SCO data frame header if required */
if|if
condition|(
operator|!
operator|(
name|sc
operator|->
name|sc_flags
operator|&
name|UBT_HAVE_FRAME_TYPE
operator|)
condition|)
block|{
operator|*
name|mtod
argument_list|(
name|m
argument_list|,
name|u_int8_t
operator|*
argument_list|)
operator|=
name|NG_HCI_SCO_DATA_PKT
expr_stmt|;
name|m
operator|->
name|m_pkthdr
operator|.
name|len
operator|=
literal|1
expr_stmt|;
name|m
operator|->
name|m_len
operator|=
name|min
argument_list|(
name|MHLEN
argument_list|,
name|h
operator|->
name|actlen
operator|+
literal|1
argument_list|)
expr_stmt|;
comment|/* XXX m_copyback */
block|}
else|else
block|{
name|m
operator|->
name|m_pkthdr
operator|.
name|len
operator|=
literal|0
expr_stmt|;
name|m
operator|->
name|m_len
operator|=
name|min
argument_list|(
name|MHLEN
argument_list|,
name|h
operator|->
name|actlen
argument_list|)
expr_stmt|;
comment|/* XXX m_copyback */
block|}
comment|/* 	 * XXX FIXME how do we know how many frames we have received? 	 * XXX use frlen for now. is that correct? 	 */
name|b
operator|=
operator|(
name|u_int8_t
operator|*
operator|)
name|sc
operator|->
name|sc_isoc_in_buffer
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|sc
operator|->
name|sc_isoc_nframes
condition|;
name|i
operator|++
control|)
block|{
name|b
operator|+=
operator|(
name|i
operator|*
name|sc
operator|->
name|sc_isoc_size
operator|)
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|sc_isoc_in_frlen
index|[
name|i
index|]
operator|>
literal|0
condition|)
name|m_copyback
argument_list|(
name|m
argument_list|,
name|m
operator|->
name|m_pkthdr
operator|.
name|len
argument_list|,
name|sc
operator|->
name|sc_isoc_in_frlen
index|[
name|i
index|]
argument_list|,
name|b
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|m
operator|->
name|m_pkthdr
operator|.
name|len
operator|<
sizeof|sizeof
argument_list|(
operator|*
name|hdr
argument_list|)
condition|)
goto|goto
name|done
goto|;
name|hdr
operator|=
name|mtod
argument_list|(
name|m
argument_list|,
name|ng_hci_scodata_pkt_t
operator|*
argument_list|)
expr_stmt|;
if|if
condition|(
name|hdr
operator|->
name|length
operator|==
name|m
operator|->
name|m_pkthdr
operator|.
name|len
operator|-
sizeof|sizeof
argument_list|(
operator|*
name|hdr
argument_list|)
condition|)
block|{
name|NG_UBT_INFO
argument_list|(
literal|"%s: %s - Got complete SCO data frame, pktlen=%d, length=%d\n"
argument_list|,
name|__func__
argument_list|,
name|USBDEVNAME
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|)
argument_list|,
name|m
operator|->
name|m_pkthdr
operator|.
name|len
argument_list|,
name|hdr
operator|->
name|length
argument_list|)
expr_stmt|;
name|NG_UBT_STAT_PCKTS_RECV
argument_list|(
name|sc
operator|->
name|sc_stat
argument_list|)
expr_stmt|;
name|NG_SEND_DATA_ONLY
argument_list|(
name|i
argument_list|,
name|sc
operator|->
name|sc_hook
argument_list|,
name|m
argument_list|)
expr_stmt|;
if|if
condition|(
name|i
operator|!=
literal|0
condition|)
name|NG_UBT_STAT_IERROR
argument_list|(
name|sc
operator|->
name|sc_stat
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|NG_UBT_ERR
argument_list|(
literal|"%s: %s - Invalid SCO frame size, length=%d, pktlen=%d\n"
argument_list|,
name|__func__
argument_list|,
name|USBDEVNAME
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|)
argument_list|,
name|hdr
operator|->
name|length
argument_list|,
name|m
operator|->
name|m_pkthdr
operator|.
name|len
argument_list|)
expr_stmt|;
name|NG_UBT_STAT_IERROR
argument_list|(
name|sc
operator|->
name|sc_stat
argument_list|)
expr_stmt|;
name|NG_FREE_M
argument_list|(
name|m
argument_list|)
expr_stmt|;
block|}
name|done
label|:
name|ubt_isoc_in_start
argument_list|(
name|sc
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* ubt_isoc_in_complete2 */
end_comment

begin_comment
comment|/*  * Start isochronous-out USB transfer. Must be called with node locked  */
end_comment

begin_function
name|Static
name|usbd_status
name|ubt_isoc_out_start
parameter_list|(
name|ubt_softc_p
name|sc
parameter_list|)
block|{
name|struct
name|mbuf
modifier|*
name|m
init|=
name|NULL
decl_stmt|;
name|u_int8_t
modifier|*
name|b
init|=
name|NULL
decl_stmt|;
name|int
name|i
decl_stmt|,
name|len
decl_stmt|,
name|nframes
decl_stmt|;
name|usbd_status
name|status
decl_stmt|;
name|KASSERT
argument_list|(
operator|!
operator|(
name|sc
operator|->
name|sc_flags
operator|&
name|UBT_SCO_XMIT
operator|)
argument_list|,
operator|(
literal|"%s: %s - Another isoc-out request is pending\n"
operator|,
name|__func__
operator|,
name|USBDEVNAME
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|NG_BT_MBUFQ_DEQUEUE
argument_list|(
operator|&
name|sc
operator|->
name|sc_scoq
argument_list|,
name|m
argument_list|)
expr_stmt|;
if|if
condition|(
name|m
operator|==
name|NULL
condition|)
block|{
name|NG_UBT_INFO
argument_list|(
literal|"%s: %s - SCO data queue is empty\n"
argument_list|,
name|__func__
argument_list|,
name|USBDEVNAME
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|(
name|USBD_NORMAL_COMPLETION
operator|)
return|;
block|}
comment|/* Copy entire SCO frame into USB transfer buffer and start transfer */
name|b
operator|=
operator|(
name|u_int8_t
operator|*
operator|)
name|sc
operator|->
name|sc_isoc_out_buffer
expr_stmt|;
name|nframes
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|sc
operator|->
name|sc_isoc_nframes
condition|;
name|i
operator|++
control|)
block|{
name|b
operator|+=
operator|(
name|i
operator|*
name|sc
operator|->
name|sc_isoc_size
operator|)
expr_stmt|;
name|len
operator|=
name|min
argument_list|(
name|m
operator|->
name|m_pkthdr
operator|.
name|len
argument_list|,
name|sc
operator|->
name|sc_isoc_size
argument_list|)
expr_stmt|;
if|if
condition|(
name|len
operator|>
literal|0
condition|)
block|{
name|m_copydata
argument_list|(
name|m
argument_list|,
literal|0
argument_list|,
name|len
argument_list|,
name|b
argument_list|)
expr_stmt|;
name|m_adj
argument_list|(
name|m
argument_list|,
name|len
argument_list|)
expr_stmt|;
name|nframes
operator|++
expr_stmt|;
block|}
name|sc
operator|->
name|sc_isoc_out_frlen
index|[
name|i
index|]
operator|=
name|len
expr_stmt|;
block|}
if|if
condition|(
name|m
operator|->
name|m_pkthdr
operator|.
name|len
operator|>
literal|0
condition|)
name|panic
argument_list|(
literal|"%s: %s - SCO data frame is too big, nframes=%d, size=%d, len=%d\n"
argument_list|,
name|__func__
argument_list|,
name|USBDEVNAME
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|)
argument_list|,
name|sc
operator|->
name|sc_isoc_nframes
argument_list|,
name|sc
operator|->
name|sc_isoc_size
argument_list|,
name|m
operator|->
name|m_pkthdr
operator|.
name|len
argument_list|)
expr_stmt|;
name|NG_FREE_M
argument_list|(
name|m
argument_list|)
expr_stmt|;
comment|/* Initialize a isoc-out USB transfer and then schedule it */
name|usbd_setup_isoc_xfer
argument_list|(
name|sc
operator|->
name|sc_isoc_out_xfer
argument_list|,
name|sc
operator|->
name|sc_isoc_out_pipe
argument_list|,
operator|(
name|usbd_private_handle
operator|)
name|sc
operator|->
name|sc_node
argument_list|,
name|sc
operator|->
name|sc_isoc_out_frlen
argument_list|,
name|nframes
argument_list|,
name|USBD_NO_COPY
argument_list|,
name|ubt_isoc_out_complete
argument_list|)
expr_stmt|;
name|NG_NODE_REF
argument_list|(
name|sc
operator|->
name|sc_node
argument_list|)
expr_stmt|;
name|status
operator|=
name|usbd_transfer
argument_list|(
name|sc
operator|->
name|sc_isoc_out_xfer
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|USBD_NORMAL_COMPLETION
operator|&&
name|status
operator|!=
name|USBD_IN_PROGRESS
condition|)
block|{
name|NG_UBT_ERR
argument_list|(
literal|"%s: %s - Could not start isoc-out transfer. %s (%d)\n"
argument_list|,
name|__func__
argument_list|,
name|USBDEVNAME
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|)
argument_list|,
name|usbd_errstr
argument_list|(
name|status
argument_list|)
argument_list|,
name|status
argument_list|)
expr_stmt|;
name|NG_NODE_UNREF
argument_list|(
name|sc
operator|->
name|sc_node
argument_list|)
expr_stmt|;
name|NG_BT_MBUFQ_DROP
argument_list|(
operator|&
name|sc
operator|->
name|sc_scoq
argument_list|)
expr_stmt|;
name|NG_UBT_STAT_OERROR
argument_list|(
name|sc
operator|->
name|sc_stat
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|NG_UBT_INFO
argument_list|(
literal|"%s: %s - Isoc-out transfer has been started, nframes=%d, size=%d\n"
argument_list|,
name|__func__
argument_list|,
name|USBDEVNAME
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|)
argument_list|,
name|nframes
argument_list|,
name|sc
operator|->
name|sc_isoc_size
argument_list|)
expr_stmt|;
name|sc
operator|->
name|sc_flags
operator||=
name|UBT_SCO_XMIT
expr_stmt|;
name|status
operator|=
name|USBD_NORMAL_COMPLETION
expr_stmt|;
block|}
return|return
operator|(
name|status
operator|)
return|;
block|}
end_function

begin_comment
comment|/* ubt_isoc_out_start */
end_comment

begin_comment
comment|/*  * USB isoc-out. transfer callback  */
end_comment

begin_function
name|Static
name|void
name|ubt_isoc_out_complete
parameter_list|(
name|usbd_xfer_handle
name|h
parameter_list|,
name|usbd_private_handle
name|p
parameter_list|,
name|usbd_status
name|s
parameter_list|)
block|{
name|ng_send_fn
argument_list|(
operator|(
name|node_p
operator|)
name|p
argument_list|,
name|NULL
argument_list|,
name|ubt_isoc_out_complete2
argument_list|,
operator|(
name|void
operator|*
operator|)
name|h
argument_list|,
name|s
argument_list|)
expr_stmt|;
name|NG_NODE_UNREF
argument_list|(
operator|(
name|node_p
operator|)
name|p
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* ubt_isoc_out_complete */
end_comment

begin_function
name|Static
name|void
name|ubt_isoc_out_complete2
parameter_list|(
name|node_p
name|node
parameter_list|,
name|hook_p
name|hook
parameter_list|,
name|void
modifier|*
name|arg1
parameter_list|,
name|int
name|arg2
parameter_list|)
block|{
name|ubt_softc_p
name|sc
init|=
operator|(
name|ubt_softc_p
operator|)
name|NG_NODE_PRIVATE
argument_list|(
name|node
argument_list|)
decl_stmt|;
name|usbd_xfer_handle
name|h
init|=
operator|(
name|usbd_xfer_handle
operator|)
name|arg1
decl_stmt|;
name|usbd_status
name|s
init|=
operator|(
name|usbd_status
operator|)
name|arg2
decl_stmt|;
if|if
condition|(
name|sc
operator|==
name|NULL
condition|)
return|return;
name|KASSERT
argument_list|(
operator|(
name|sc
operator|->
name|sc_flags
operator|&
name|UBT_SCO_XMIT
operator|)
argument_list|,
operator|(
literal|"%s: %s - No isoc-out request is pending\n"
operator|,
name|__func__
operator|,
name|USBDEVNAME
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|sc
operator|->
name|sc_flags
operator|&=
operator|~
name|UBT_SCO_XMIT
expr_stmt|;
if|if
condition|(
name|s
operator|==
name|USBD_CANCELLED
condition|)
block|{
name|NG_UBT_INFO
argument_list|(
literal|"%s: %s - Isoc-out xfer cancelled, pipe=%p\n"
argument_list|,
name|__func__
argument_list|,
name|USBDEVNAME
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|)
argument_list|,
name|sc
operator|->
name|sc_isoc_out_pipe
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|s
operator|!=
name|USBD_NORMAL_COMPLETION
condition|)
block|{
name|NG_UBT_WARN
argument_list|(
literal|"%s: %s - Isoc-out xfer failed. %s (%d)\n"
argument_list|,
name|__func__
argument_list|,
name|USBDEVNAME
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|)
argument_list|,
name|usbd_errstr
argument_list|(
name|s
argument_list|)
argument_list|,
name|s
argument_list|)
expr_stmt|;
if|if
condition|(
name|s
operator|==
name|USBD_STALLED
condition|)
name|usbd_clear_endpoint_stall_async
argument_list|(
name|sc
operator|->
name|sc_isoc_out_pipe
argument_list|)
expr_stmt|;
name|NG_UBT_STAT_OERROR
argument_list|(
name|sc
operator|->
name|sc_stat
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|NG_UBT_INFO
argument_list|(
literal|"%s: %s - Sent %d bytes to isoc-out pipe\n"
argument_list|,
name|__func__
argument_list|,
name|USBDEVNAME
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|)
argument_list|,
name|h
operator|->
name|actlen
argument_list|)
expr_stmt|;
name|NG_UBT_STAT_BYTES_SENT
argument_list|(
name|sc
operator|->
name|sc_stat
argument_list|,
name|h
operator|->
name|actlen
argument_list|)
expr_stmt|;
name|NG_UBT_STAT_PCKTS_SENT
argument_list|(
name|sc
operator|->
name|sc_stat
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|NG_BT_MBUFQ_LEN
argument_list|(
operator|&
name|sc
operator|->
name|sc_scoq
argument_list|)
operator|>
literal|0
condition|)
name|ubt_isoc_out_start
argument_list|(
name|sc
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* ubt_isoc_out_complete2 */
end_comment

begin_comment
comment|/*  * Abort transfers on all USB pipes  */
end_comment

begin_function
name|Static
name|void
name|ubt_reset
parameter_list|(
name|ubt_softc_p
name|sc
parameter_list|)
block|{
comment|/* Interrupt */
if|if
condition|(
name|sc
operator|->
name|sc_intr_pipe
operator|!=
name|NULL
condition|)
name|usbd_abort_pipe
argument_list|(
name|sc
operator|->
name|sc_intr_pipe
argument_list|)
expr_stmt|;
comment|/* Bulk-in/out */
if|if
condition|(
name|sc
operator|->
name|sc_bulk_in_pipe
operator|!=
name|NULL
condition|)
name|usbd_abort_pipe
argument_list|(
name|sc
operator|->
name|sc_bulk_in_pipe
argument_list|)
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|sc_bulk_out_pipe
operator|!=
name|NULL
condition|)
name|usbd_abort_pipe
argument_list|(
name|sc
operator|->
name|sc_bulk_out_pipe
argument_list|)
expr_stmt|;
comment|/* Isoc-in/out */
if|if
condition|(
name|sc
operator|->
name|sc_isoc_in_pipe
operator|!=
name|NULL
condition|)
name|usbd_abort_pipe
argument_list|(
name|sc
operator|->
name|sc_isoc_in_pipe
argument_list|)
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|sc_isoc_out_pipe
operator|!=
name|NULL
condition|)
name|usbd_abort_pipe
argument_list|(
name|sc
operator|->
name|sc_isoc_out_pipe
argument_list|)
expr_stmt|;
comment|/* Cleanup queues */
name|NG_BT_MBUFQ_DRAIN
argument_list|(
operator|&
name|sc
operator|->
name|sc_cmdq
argument_list|)
expr_stmt|;
name|NG_BT_MBUFQ_DRAIN
argument_list|(
operator|&
name|sc
operator|->
name|sc_aclq
argument_list|)
expr_stmt|;
name|NG_BT_MBUFQ_DRAIN
argument_list|(
operator|&
name|sc
operator|->
name|sc_scoq
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* ubt_reset */
end_comment

begin_comment
comment|/****************************************************************************  ****************************************************************************  **                        Netgraph specific  ****************************************************************************  ****************************************************************************/
end_comment

begin_comment
comment|/*  * Netgraph node constructor. Do not allow to create node of this type.  */
end_comment

begin_function
name|Static
name|int
name|ng_ubt_constructor
parameter_list|(
name|node_p
name|node
parameter_list|)
block|{
return|return
operator|(
name|EINVAL
operator|)
return|;
block|}
end_function

begin_comment
comment|/* ng_ubt_constructor */
end_comment

begin_comment
comment|/*  * Netgraph node destructor. Destroy node only when device has been detached  */
end_comment

begin_function
name|Static
name|int
name|ng_ubt_shutdown
parameter_list|(
name|node_p
name|node
parameter_list|)
block|{
name|ubt_softc_p
name|sc
init|=
operator|(
name|ubt_softc_p
operator|)
name|NG_NODE_PRIVATE
argument_list|(
name|node
argument_list|)
decl_stmt|;
comment|/* Let old node go */
name|NG_NODE_SET_PRIVATE
argument_list|(
name|node
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|NG_NODE_UNREF
argument_list|(
name|node
argument_list|)
expr_stmt|;
if|if
condition|(
name|sc
operator|==
name|NULL
condition|)
goto|goto
name|done
goto|;
comment|/* Create Netgraph node */
if|if
condition|(
name|ng_make_node_common
argument_list|(
operator|&
name|typestruct
argument_list|,
operator|&
name|sc
operator|->
name|sc_node
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|printf
argument_list|(
literal|"%s: Could not create Netgraph node\n"
argument_list|,
name|USBDEVNAME
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|)
argument_list|)
expr_stmt|;
name|sc
operator|->
name|sc_node
operator|=
name|NULL
expr_stmt|;
goto|goto
name|done
goto|;
block|}
comment|/* Name node */
if|if
condition|(
name|ng_name_node
argument_list|(
name|sc
operator|->
name|sc_node
argument_list|,
name|USBDEVNAME
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|)
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|printf
argument_list|(
literal|"%s: Could not name Netgraph node\n"
argument_list|,
name|USBDEVNAME
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|)
argument_list|)
expr_stmt|;
name|NG_NODE_UNREF
argument_list|(
name|sc
operator|->
name|sc_node
argument_list|)
expr_stmt|;
name|sc
operator|->
name|sc_node
operator|=
name|NULL
expr_stmt|;
goto|goto
name|done
goto|;
block|}
name|NG_NODE_SET_PRIVATE
argument_list|(
name|sc
operator|->
name|sc_node
argument_list|,
name|sc
argument_list|)
expr_stmt|;
name|NG_NODE_FORCE_WRITER
argument_list|(
name|sc
operator|->
name|sc_node
argument_list|)
expr_stmt|;
name|done
label|:
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_comment
comment|/* ng_ubt_shutdown */
end_comment

begin_comment
comment|/*  * Create new hook. There can only be one.  */
end_comment

begin_function
name|Static
name|int
name|ng_ubt_newhook
parameter_list|(
name|node_p
name|node
parameter_list|,
name|hook_p
name|hook
parameter_list|,
name|char
specifier|const
modifier|*
name|name
parameter_list|)
block|{
name|ubt_softc_p
name|sc
init|=
operator|(
name|ubt_softc_p
operator|)
name|NG_NODE_PRIVATE
argument_list|(
name|node
argument_list|)
decl_stmt|;
if|if
condition|(
name|strcmp
argument_list|(
name|name
argument_list|,
name|NG_UBT_HOOK
argument_list|)
operator|!=
literal|0
condition|)
return|return
operator|(
name|EINVAL
operator|)
return|;
if|if
condition|(
name|sc
operator|->
name|sc_hook
operator|!=
name|NULL
condition|)
return|return
operator|(
name|EISCONN
operator|)
return|;
name|sc
operator|->
name|sc_hook
operator|=
name|hook
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_comment
comment|/* ng_ubt_newhook */
end_comment

begin_comment
comment|/*  * Connect hook. Start incoming USB transfers  */
end_comment

begin_function
name|Static
name|int
name|ng_ubt_connect
parameter_list|(
name|hook_p
name|hook
parameter_list|)
block|{
name|ubt_softc_p
name|sc
init|=
operator|(
name|ubt_softc_p
operator|)
name|NG_NODE_PRIVATE
argument_list|(
name|NG_HOOK_NODE
argument_list|(
name|hook
argument_list|)
argument_list|)
decl_stmt|;
name|usbd_status
name|status
decl_stmt|;
name|NG_HOOK_FORCE_QUEUE
argument_list|(
name|NG_HOOK_PEER
argument_list|(
name|hook
argument_list|)
argument_list|)
expr_stmt|;
comment|/* Start intr transfer */
name|status
operator|=
name|ubt_intr_start
argument_list|(
name|sc
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|USBD_NORMAL_COMPLETION
condition|)
block|{
name|NG_UBT_ALERT
argument_list|(
literal|"%s: %s - Could not start interrupt transfer. %s (%d)\n"
argument_list|,
name|__func__
argument_list|,
name|USBDEVNAME
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|)
argument_list|,
name|usbd_errstr
argument_list|(
name|status
argument_list|)
argument_list|,
name|status
argument_list|)
expr_stmt|;
goto|goto
name|fail
goto|;
block|}
comment|/* Start bulk-in transfer */
name|status
operator|=
name|ubt_bulk_in_start
argument_list|(
name|sc
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|USBD_NORMAL_COMPLETION
condition|)
block|{
name|NG_UBT_ALERT
argument_list|(
literal|"%s: %s - Could not start bulk-in transfer. %s (%d)\n"
argument_list|,
name|__func__
argument_list|,
name|USBDEVNAME
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|)
argument_list|,
name|usbd_errstr
argument_list|(
name|status
argument_list|)
argument_list|,
name|status
argument_list|)
expr_stmt|;
goto|goto
name|fail
goto|;
block|}
if|#
directive|if
name|__broken__
comment|/* XXX FIXME */
comment|/* Start isoc-in transfer */
name|status
operator|=
name|ubt_isoc_in_start
argument_list|(
name|sc
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|USBD_NORMAL_COMPLETION
condition|)
block|{
name|NG_UBT_ALERT
argument_list|(
literal|"%s: %s - Could not start isoc-in transfer. %s (%d)\n"
argument_list|,
name|__func__
argument_list|,
name|USBDEVNAME
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|)
argument_list|,
name|usbd_errstr
argument_list|(
name|status
argument_list|)
argument_list|,
name|status
argument_list|)
expr_stmt|;
goto|goto
name|fail
goto|;
block|}
endif|#
directive|endif
comment|/* __broken__ */
return|return
operator|(
literal|0
operator|)
return|;
name|fail
label|:
name|ubt_reset
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|sc
operator|->
name|sc_hook
operator|=
name|NULL
expr_stmt|;
return|return
operator|(
name|ENXIO
operator|)
return|;
block|}
end_function

begin_comment
comment|/* ng_ubt_connect */
end_comment

begin_comment
comment|/*  * Disconnect hook  */
end_comment

begin_function
name|Static
name|int
name|ng_ubt_disconnect
parameter_list|(
name|hook_p
name|hook
parameter_list|)
block|{
name|ubt_softc_p
name|sc
init|=
operator|(
name|ubt_softc_p
operator|)
name|NG_NODE_PRIVATE
argument_list|(
name|NG_HOOK_NODE
argument_list|(
name|hook
argument_list|)
argument_list|)
decl_stmt|;
if|if
condition|(
name|sc
operator|!=
name|NULL
condition|)
block|{
if|if
condition|(
name|hook
operator|!=
name|sc
operator|->
name|sc_hook
condition|)
return|return
operator|(
name|EINVAL
operator|)
return|;
name|ubt_reset
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|sc
operator|->
name|sc_hook
operator|=
name|NULL
expr_stmt|;
block|}
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_comment
comment|/* ng_ubt_disconnect */
end_comment

begin_comment
comment|/*  * Process control message  */
end_comment

begin_function
name|Static
name|int
name|ng_ubt_rcvmsg
parameter_list|(
name|node_p
name|node
parameter_list|,
name|item_p
name|item
parameter_list|,
name|hook_p
name|lasthook
parameter_list|)
block|{
name|ubt_softc_p
name|sc
init|=
operator|(
name|ubt_softc_p
operator|)
name|NG_NODE_PRIVATE
argument_list|(
name|node
argument_list|)
decl_stmt|;
name|struct
name|ng_mesg
modifier|*
name|msg
init|=
name|NULL
decl_stmt|,
modifier|*
name|rsp
init|=
name|NULL
decl_stmt|;
name|struct
name|ng_bt_mbufq
modifier|*
name|q
init|=
name|NULL
decl_stmt|;
name|int
name|error
init|=
literal|0
decl_stmt|,
name|queue
decl_stmt|,
name|qlen
decl_stmt|;
if|if
condition|(
name|sc
operator|==
name|NULL
condition|)
block|{
name|NG_FREE_ITEM
argument_list|(
name|item
argument_list|)
expr_stmt|;
return|return
operator|(
name|EHOSTDOWN
operator|)
return|;
block|}
name|NGI_GET_MSG
argument_list|(
name|item
argument_list|,
name|msg
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|msg
operator|->
name|header
operator|.
name|typecookie
condition|)
block|{
case|case
name|NGM_GENERIC_COOKIE
case|:
switch|switch
condition|(
name|msg
operator|->
name|header
operator|.
name|cmd
condition|)
block|{
case|case
name|NGM_TEXT_STATUS
case|:
name|NG_MKRESPONSE
argument_list|(
name|rsp
argument_list|,
name|msg
argument_list|,
name|NG_TEXTRESPONSE
argument_list|,
name|M_NOWAIT
argument_list|)
expr_stmt|;
if|if
condition|(
name|rsp
operator|==
name|NULL
condition|)
name|error
operator|=
name|ENOMEM
expr_stmt|;
else|else
name|snprintf
argument_list|(
name|rsp
operator|->
name|data
argument_list|,
name|NG_TEXTRESPONSE
argument_list|,
literal|"Hook: %s\n"
expr|\
literal|"Flags: %#x\n"
expr|\
literal|"Debug: %d\n"
expr|\
literal|"CMD queue: [have:%d,max:%d]\n"
expr|\
literal|"ACL queue: [have:%d,max:%d]\n"
expr|\
literal|"SCO queue: [have:%d,max:%d]"
argument_list|,
operator|(
name|sc
operator|->
name|sc_hook
operator|!=
name|NULL
operator|)
condition|?
name|NG_UBT_HOOK
else|:
literal|""
argument_list|,
name|sc
operator|->
name|sc_flags
argument_list|,
name|sc
operator|->
name|sc_debug
argument_list|,
name|NG_BT_MBUFQ_LEN
argument_list|(
operator|&
name|sc
operator|->
name|sc_cmdq
argument_list|)
argument_list|,
name|sc
operator|->
name|sc_cmdq
operator|.
name|maxlen
argument_list|,
name|NG_BT_MBUFQ_LEN
argument_list|(
operator|&
name|sc
operator|->
name|sc_aclq
argument_list|)
argument_list|,
name|sc
operator|->
name|sc_aclq
operator|.
name|maxlen
argument_list|,
name|NG_BT_MBUFQ_LEN
argument_list|(
operator|&
name|sc
operator|->
name|sc_scoq
argument_list|)
argument_list|,
name|sc
operator|->
name|sc_scoq
operator|.
name|maxlen
argument_list|)
expr_stmt|;
break|break;
default|default:
name|error
operator|=
name|EINVAL
expr_stmt|;
break|break;
block|}
break|break;
case|case
name|NGM_UBT_COOKIE
case|:
switch|switch
condition|(
name|msg
operator|->
name|header
operator|.
name|cmd
condition|)
block|{
case|case
name|NGM_UBT_NODE_SET_DEBUG
case|:
if|if
condition|(
name|msg
operator|->
name|header
operator|.
name|arglen
operator|!=
sizeof|sizeof
argument_list|(
name|ng_ubt_node_debug_ep
argument_list|)
condition|)
name|error
operator|=
name|EMSGSIZE
expr_stmt|;
else|else
name|sc
operator|->
name|sc_debug
operator|=
operator|*
operator|(
operator|(
name|ng_ubt_node_debug_ep
operator|*
operator|)
operator|(
name|msg
operator|->
name|data
operator|)
operator|)
expr_stmt|;
break|break;
case|case
name|NGM_UBT_NODE_GET_DEBUG
case|:
name|NG_MKRESPONSE
argument_list|(
name|rsp
argument_list|,
name|msg
argument_list|,
sizeof|sizeof
argument_list|(
name|ng_ubt_node_debug_ep
argument_list|)
argument_list|,
name|M_NOWAIT
argument_list|)
expr_stmt|;
if|if
condition|(
name|rsp
operator|==
name|NULL
condition|)
name|error
operator|=
name|ENOMEM
expr_stmt|;
else|else
operator|*
operator|(
operator|(
name|ng_ubt_node_debug_ep
operator|*
operator|)
operator|(
name|rsp
operator|->
name|data
operator|)
operator|)
operator|=
name|sc
operator|->
name|sc_debug
expr_stmt|;
break|break;
case|case
name|NGM_UBT_NODE_SET_QLEN
case|:
if|if
condition|(
name|msg
operator|->
name|header
operator|.
name|arglen
operator|!=
sizeof|sizeof
argument_list|(
name|ng_ubt_node_qlen_ep
argument_list|)
condition|)
name|error
operator|=
name|EMSGSIZE
expr_stmt|;
else|else
block|{
name|queue
operator|=
operator|(
operator|(
name|ng_ubt_node_qlen_ep
operator|*
operator|)
operator|(
name|msg
operator|->
name|data
operator|)
operator|)
operator|->
name|queue
expr_stmt|;
name|qlen
operator|=
operator|(
operator|(
name|ng_ubt_node_qlen_ep
operator|*
operator|)
operator|(
name|msg
operator|->
name|data
operator|)
operator|)
operator|->
name|qlen
expr_stmt|;
if|if
condition|(
name|qlen
operator|<=
literal|0
condition|)
block|{
name|error
operator|=
name|EINVAL
expr_stmt|;
break|break;
block|}
switch|switch
condition|(
name|queue
condition|)
block|{
case|case
name|NGM_UBT_NODE_QUEUE_CMD
case|:
name|q
operator|=
operator|&
name|sc
operator|->
name|sc_cmdq
expr_stmt|;
break|break;
case|case
name|NGM_UBT_NODE_QUEUE_ACL
case|:
name|q
operator|=
operator|&
name|sc
operator|->
name|sc_aclq
expr_stmt|;
break|break;
case|case
name|NGM_UBT_NODE_QUEUE_SCO
case|:
name|q
operator|=
operator|&
name|sc
operator|->
name|sc_scoq
expr_stmt|;
break|break;
default|default:
name|q
operator|=
name|NULL
expr_stmt|;
name|error
operator|=
name|EINVAL
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|q
operator|!=
name|NULL
condition|)
name|q
operator|->
name|maxlen
operator|=
name|qlen
expr_stmt|;
block|}
break|break;
case|case
name|NGM_UBT_NODE_GET_QLEN
case|:
if|if
condition|(
name|msg
operator|->
name|header
operator|.
name|arglen
operator|!=
sizeof|sizeof
argument_list|(
name|ng_ubt_node_qlen_ep
argument_list|)
condition|)
block|{
name|error
operator|=
name|EMSGSIZE
expr_stmt|;
break|break;
block|}
name|queue
operator|=
operator|(
operator|(
name|ng_ubt_node_qlen_ep
operator|*
operator|)
operator|(
name|msg
operator|->
name|data
operator|)
operator|)
operator|->
name|queue
expr_stmt|;
switch|switch
condition|(
name|queue
condition|)
block|{
case|case
name|NGM_UBT_NODE_QUEUE_CMD
case|:
name|q
operator|=
operator|&
name|sc
operator|->
name|sc_cmdq
expr_stmt|;
break|break;
case|case
name|NGM_UBT_NODE_QUEUE_ACL
case|:
name|q
operator|=
operator|&
name|sc
operator|->
name|sc_aclq
expr_stmt|;
break|break;
case|case
name|NGM_UBT_NODE_QUEUE_SCO
case|:
name|q
operator|=
operator|&
name|sc
operator|->
name|sc_scoq
expr_stmt|;
break|break;
default|default:
name|q
operator|=
name|NULL
expr_stmt|;
name|error
operator|=
name|EINVAL
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|q
operator|!=
name|NULL
condition|)
block|{
name|NG_MKRESPONSE
argument_list|(
name|rsp
argument_list|,
name|msg
argument_list|,
sizeof|sizeof
argument_list|(
name|ng_ubt_node_qlen_ep
argument_list|)
argument_list|,
name|M_NOWAIT
argument_list|)
expr_stmt|;
if|if
condition|(
name|rsp
operator|==
name|NULL
condition|)
block|{
name|error
operator|=
name|ENOMEM
expr_stmt|;
break|break;
block|}
operator|(
operator|(
name|ng_ubt_node_qlen_ep
operator|*
operator|)
operator|(
name|rsp
operator|->
name|data
operator|)
operator|)
operator|->
name|queue
operator|=
name|queue
expr_stmt|;
operator|(
operator|(
name|ng_ubt_node_qlen_ep
operator|*
operator|)
operator|(
name|rsp
operator|->
name|data
operator|)
operator|)
operator|->
name|qlen
operator|=
name|q
operator|->
name|maxlen
expr_stmt|;
block|}
break|break;
case|case
name|NGM_UBT_NODE_GET_STAT
case|:
name|NG_MKRESPONSE
argument_list|(
name|rsp
argument_list|,
name|msg
argument_list|,
sizeof|sizeof
argument_list|(
name|ng_ubt_node_stat_ep
argument_list|)
argument_list|,
name|M_NOWAIT
argument_list|)
expr_stmt|;
if|if
condition|(
name|rsp
operator|==
name|NULL
condition|)
name|error
operator|=
name|ENOMEM
expr_stmt|;
else|else
name|bcopy
argument_list|(
operator|&
name|sc
operator|->
name|sc_stat
argument_list|,
name|rsp
operator|->
name|data
argument_list|,
sizeof|sizeof
argument_list|(
name|ng_ubt_node_stat_ep
argument_list|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|NGM_UBT_NODE_RESET_STAT
case|:
name|NG_UBT_STAT_RESET
argument_list|(
name|sc
operator|->
name|sc_stat
argument_list|)
expr_stmt|;
break|break;
default|default:
name|error
operator|=
name|EINVAL
expr_stmt|;
break|break;
block|}
break|break;
default|default:
name|error
operator|=
name|EINVAL
expr_stmt|;
break|break;
block|}
name|NG_RESPOND_MSG
argument_list|(
name|error
argument_list|,
name|node
argument_list|,
name|item
argument_list|,
name|rsp
argument_list|)
expr_stmt|;
name|NG_FREE_MSG
argument_list|(
name|msg
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
end_function

begin_comment
comment|/* ng_ubt_rcvmsg */
end_comment

begin_comment
comment|/*  * Process data  */
end_comment

begin_function
name|Static
name|int
name|ng_ubt_rcvdata
parameter_list|(
name|hook_p
name|hook
parameter_list|,
name|item_p
name|item
parameter_list|)
block|{
name|ubt_softc_p
name|sc
init|=
operator|(
name|ubt_softc_p
operator|)
name|NG_NODE_PRIVATE
argument_list|(
name|NG_HOOK_NODE
argument_list|(
name|hook
argument_list|)
argument_list|)
decl_stmt|;
name|struct
name|mbuf
modifier|*
name|m
init|=
name|NULL
decl_stmt|;
name|usbd_status
function_decl|(
modifier|*
name|f
function_decl|)
parameter_list|(
name|ubt_softc_p
parameter_list|)
init|=
name|NULL
function_decl|;
name|struct
name|ng_bt_mbufq
modifier|*
name|q
init|=
name|NULL
decl_stmt|;
name|int
name|b
decl_stmt|,
name|error
init|=
literal|0
decl_stmt|;
if|if
condition|(
name|sc
operator|==
name|NULL
condition|)
block|{
name|error
operator|=
name|EHOSTDOWN
expr_stmt|;
goto|goto
name|done
goto|;
block|}
if|if
condition|(
name|hook
operator|!=
name|sc
operator|->
name|sc_hook
condition|)
block|{
name|error
operator|=
name|EINVAL
expr_stmt|;
goto|goto
name|done
goto|;
block|}
comment|/* Deatch mbuf and get HCI frame type */
name|NGI_GET_M
argument_list|(
name|item
argument_list|,
name|m
argument_list|)
expr_stmt|;
comment|/* Process HCI frame */
switch|switch
condition|(
operator|*
name|mtod
argument_list|(
name|m
argument_list|,
name|u_int8_t
operator|*
argument_list|)
condition|)
block|{
comment|/* XXX call m_pullup ? */
case|case
name|NG_HCI_CMD_PKT
case|:
name|f
operator|=
name|ubt_request_start
expr_stmt|;
name|q
operator|=
operator|&
name|sc
operator|->
name|sc_cmdq
expr_stmt|;
name|b
operator|=
name|UBT_CMD_XMIT
expr_stmt|;
break|break;
case|case
name|NG_HCI_ACL_DATA_PKT
case|:
name|f
operator|=
name|ubt_bulk_out_start
expr_stmt|;
name|q
operator|=
operator|&
name|sc
operator|->
name|sc_aclq
expr_stmt|;
name|b
operator|=
name|UBT_ACL_XMIT
expr_stmt|;
break|break;
if|#
directive|if
name|__broken__
comment|/* XXX FIXME */
case|case
name|NG_HCI_SCO_DATA_PKT
case|:
name|f
operator|=
name|ubt_isoc_out_start
expr_stmt|;
name|q
operator|=
operator|&
name|sc
operator|->
name|sc_scoq
expr_stmt|;
name|b
operator|=
name|UBT_SCO_XMIT
expr_stmt|;
break|break;
endif|#
directive|endif
comment|/* __broken__ */
default|default:
name|NG_UBT_ERR
argument_list|(
literal|"%s: %s - Dropping unknown/unsupported HCI frame, type=%d, pktlen=%d\n"
argument_list|,
name|__func__
argument_list|,
name|USBDEVNAME
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|)
argument_list|,
operator|*
name|mtod
argument_list|(
name|m
argument_list|,
name|u_int8_t
operator|*
argument_list|)
argument_list|,
name|m
operator|->
name|m_pkthdr
operator|.
name|len
argument_list|)
expr_stmt|;
name|NG_FREE_M
argument_list|(
name|m
argument_list|)
expr_stmt|;
name|error
operator|=
name|EINVAL
expr_stmt|;
goto|goto
name|done
goto|;
comment|/* NOT REACHED */
block|}
comment|/* Loose frame type, if required */
if|if
condition|(
operator|!
operator|(
name|sc
operator|->
name|sc_flags
operator|&
name|UBT_NEED_FRAME_TYPE
operator|)
condition|)
name|m_adj
argument_list|(
name|m
argument_list|,
sizeof|sizeof
argument_list|(
name|u_int8_t
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|NG_BT_MBUFQ_FULL
argument_list|(
name|q
argument_list|)
condition|)
block|{
name|NG_UBT_ERR
argument_list|(
literal|"%s: %s - Dropping HCI frame %#x, len=%d. Queue full\n"
argument_list|,
name|__func__
argument_list|,
name|USBDEVNAME
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|)
argument_list|,
operator|*
name|mtod
argument_list|(
name|m
argument_list|,
name|u_int8_t
operator|*
argument_list|)
argument_list|,
name|m
operator|->
name|m_pkthdr
operator|.
name|len
argument_list|)
expr_stmt|;
name|NG_FREE_M
argument_list|(
name|m
argument_list|)
expr_stmt|;
block|}
else|else
name|NG_BT_MBUFQ_ENQUEUE
argument_list|(
name|q
argument_list|,
name|m
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|sc
operator|->
name|sc_flags
operator|&
name|b
operator|)
condition|)
if|if
condition|(
call|(
modifier|*
name|f
call|)
argument_list|(
name|sc
argument_list|)
operator|!=
name|USBD_NORMAL_COMPLETION
condition|)
name|error
operator|=
name|EIO
expr_stmt|;
name|done
label|:
name|NG_FREE_ITEM
argument_list|(
name|item
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
end_function

begin_comment
comment|/* ng_ubt_rcvdata */
end_comment

end_unit


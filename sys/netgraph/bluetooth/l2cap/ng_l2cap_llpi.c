begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * ng_l2cap_llpi.c  */
end_comment

begin_comment
comment|/*-  * Copyright (c) Maksim Yevmenkin<m_evmenkin@yahoo.com>  * All rights reserved.  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions  * are met:  * 1. Redistributions of source code must retain the above copyright  *    notice, this list of conditions and the following disclaimer.  * 2. Redistributions in binary form must reproduce the above copyright  *    notice, this list of conditions and the following disclaimer in the  *    documentation and/or other materials provided with the distribution.  *  * THIS SOFTWARE IS PROVIDED BY THE AUTHOR AND CONTRIBUTORS ``AS IS'' AND  * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE  * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE  * ARE DISCLAIMED. IN NO EVENT SHALL THE AUTHOR OR CONTRIBUTORS BE LIABLE  * FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL  * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS  * OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)  * HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT  * LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY  * OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF  * SUCH DAMAGE.  *  * $Id: ng_l2cap_llpi.c,v 1.5 2003/09/08 19:11:45 max Exp $  * $FreeBSD$  */
end_comment

begin_include
include|#
directive|include
file|<sys/param.h>
end_include

begin_include
include|#
directive|include
file|<sys/systm.h>
end_include

begin_include
include|#
directive|include
file|<sys/kernel.h>
end_include

begin_include
include|#
directive|include
file|<sys/endian.h>
end_include

begin_include
include|#
directive|include
file|<sys/malloc.h>
end_include

begin_include
include|#
directive|include
file|<sys/mbuf.h>
end_include

begin_include
include|#
directive|include
file|<sys/queue.h>
end_include

begin_include
include|#
directive|include
file|<netgraph/ng_message.h>
end_include

begin_include
include|#
directive|include
file|<netgraph/netgraph.h>
end_include

begin_include
include|#
directive|include
file|<netgraph/bluetooth/include/ng_bluetooth.h>
end_include

begin_include
include|#
directive|include
file|<netgraph/bluetooth/include/ng_hci.h>
end_include

begin_include
include|#
directive|include
file|<netgraph/bluetooth/include/ng_l2cap.h>
end_include

begin_include
include|#
directive|include
file|<netgraph/bluetooth/l2cap/ng_l2cap_var.h>
end_include

begin_include
include|#
directive|include
file|<netgraph/bluetooth/l2cap/ng_l2cap_cmds.h>
end_include

begin_include
include|#
directive|include
file|<netgraph/bluetooth/l2cap/ng_l2cap_evnt.h>
end_include

begin_include
include|#
directive|include
file|<netgraph/bluetooth/l2cap/ng_l2cap_llpi.h>
end_include

begin_include
include|#
directive|include
file|<netgraph/bluetooth/l2cap/ng_l2cap_ulpi.h>
end_include

begin_include
include|#
directive|include
file|<netgraph/bluetooth/l2cap/ng_l2cap_misc.h>
end_include

begin_comment
comment|/******************************************************************************  ******************************************************************************  **                 Lower Layer Protocol (HCI) Interface module  ******************************************************************************  ******************************************************************************/
end_comment

begin_comment
comment|/*  * Send LP_ConnectReq event to the lower layer protocol. Create new connection  * descriptor and initialize it. Create LP_ConnectReq event and send it to the  * lower layer, then adjust connection state and start timer. The function WILL  * FAIL if connection to the remote unit already exists.  */
end_comment

begin_function
name|int
name|ng_l2cap_lp_con_req
parameter_list|(
name|ng_l2cap_p
name|l2cap
parameter_list|,
name|bdaddr_p
name|bdaddr
parameter_list|)
block|{
name|struct
name|ng_mesg
modifier|*
name|msg
init|=
name|NULL
decl_stmt|;
name|ng_hci_lp_con_req_ep
modifier|*
name|ep
init|=
name|NULL
decl_stmt|;
name|ng_l2cap_con_p
name|con
init|=
name|NULL
decl_stmt|;
name|int
name|error
init|=
literal|0
decl_stmt|;
comment|/* Verify that we DO NOT have connection to the remote unit */
name|con
operator|=
name|ng_l2cap_con_by_addr
argument_list|(
name|l2cap
argument_list|,
name|bdaddr
argument_list|)
expr_stmt|;
if|if
condition|(
name|con
operator|!=
name|NULL
condition|)
block|{
name|NG_L2CAP_ALERT
argument_list|(
literal|"%s: %s - unexpected LP_ConnectReq event. "
expr|\
literal|"Connection already exists, state=%d, con_handle=%d\n"
argument_list|,
name|__func__
argument_list|,
name|NG_NODE_NAME
argument_list|(
name|l2cap
operator|->
name|node
argument_list|)
argument_list|,
name|con
operator|->
name|state
argument_list|,
name|con
operator|->
name|con_handle
argument_list|)
expr_stmt|;
return|return
operator|(
name|EEXIST
operator|)
return|;
block|}
comment|/* Check if lower layer protocol is still connected */
if|if
condition|(
name|l2cap
operator|->
name|hci
operator|==
name|NULL
operator|||
name|NG_HOOK_NOT_VALID
argument_list|(
name|l2cap
operator|->
name|hci
argument_list|)
condition|)
block|{
name|NG_L2CAP_ERR
argument_list|(
literal|"%s: %s - hook \"%s\" is not connected or valid\n"
argument_list|,
name|__func__
argument_list|,
name|NG_NODE_NAME
argument_list|(
name|l2cap
operator|->
name|node
argument_list|)
argument_list|,
name|NG_L2CAP_HOOK_HCI
argument_list|)
expr_stmt|;
return|return
operator|(
name|ENOTCONN
operator|)
return|;
block|}
comment|/* Create and intialize new connection descriptor */
name|con
operator|=
name|ng_l2cap_new_con
argument_list|(
name|l2cap
argument_list|,
name|bdaddr
argument_list|)
expr_stmt|;
if|if
condition|(
name|con
operator|==
name|NULL
condition|)
return|return
operator|(
name|ENOMEM
operator|)
return|;
comment|/* Create and send LP_ConnectReq event */
name|NG_MKMESSAGE
argument_list|(
name|msg
argument_list|,
name|NGM_HCI_COOKIE
argument_list|,
name|NGM_HCI_LP_CON_REQ
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|ep
argument_list|)
argument_list|,
name|M_NOWAIT
argument_list|)
expr_stmt|;
if|if
condition|(
name|msg
operator|==
name|NULL
condition|)
block|{
name|ng_l2cap_free_con
argument_list|(
name|con
argument_list|)
expr_stmt|;
return|return
operator|(
name|ENOMEM
operator|)
return|;
block|}
name|ep
operator|=
operator|(
name|ng_hci_lp_con_req_ep
operator|*
operator|)
operator|(
name|msg
operator|->
name|data
operator|)
expr_stmt|;
name|bcopy
argument_list|(
name|bdaddr
argument_list|,
operator|&
name|ep
operator|->
name|bdaddr
argument_list|,
sizeof|sizeof
argument_list|(
name|ep
operator|->
name|bdaddr
argument_list|)
argument_list|)
expr_stmt|;
name|ep
operator|->
name|link_type
operator|=
name|NG_HCI_LINK_ACL
expr_stmt|;
name|con
operator|->
name|flags
operator||=
name|NG_L2CAP_CON_OUTGOING
expr_stmt|;
name|con
operator|->
name|state
operator|=
name|NG_L2CAP_W4_LP_CON_CFM
expr_stmt|;
name|ng_l2cap_lp_timeout
argument_list|(
name|con
argument_list|)
expr_stmt|;
name|NG_SEND_MSG_HOOK
argument_list|(
name|error
argument_list|,
name|l2cap
operator|->
name|node
argument_list|,
name|msg
argument_list|,
name|l2cap
operator|->
name|hci
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|!=
literal|0
condition|)
block|{
if|if
condition|(
operator|(
name|error
operator|=
name|ng_l2cap_lp_untimeout
argument_list|(
name|con
argument_list|)
operator|)
operator|!=
literal|0
condition|)
return|return
operator|(
name|error
operator|)
return|;
name|ng_l2cap_free_con
argument_list|(
name|con
argument_list|)
expr_stmt|;
block|}
return|return
operator|(
name|error
operator|)
return|;
block|}
end_function

begin_comment
comment|/* ng_l2cap_lp_con_req */
end_comment

begin_comment
comment|/*  * Process LP_ConnectCfm event from the lower layer protocol. It could be   * positive or negative. Verify remote unit address then stop the timer and   * process event.  */
end_comment

begin_function
name|int
name|ng_l2cap_lp_con_cfm
parameter_list|(
name|ng_l2cap_p
name|l2cap
parameter_list|,
name|struct
name|ng_mesg
modifier|*
name|msg
parameter_list|)
block|{
name|ng_hci_lp_con_cfm_ep
modifier|*
name|ep
init|=
name|NULL
decl_stmt|;
name|ng_l2cap_con_p
name|con
init|=
name|NULL
decl_stmt|;
name|int
name|error
init|=
literal|0
decl_stmt|;
comment|/* Check message */
if|if
condition|(
name|msg
operator|->
name|header
operator|.
name|arglen
operator|!=
sizeof|sizeof
argument_list|(
operator|*
name|ep
argument_list|)
condition|)
block|{
name|NG_L2CAP_ALERT
argument_list|(
literal|"%s: %s - invalid LP_ConnectCfm[Neg] message size\n"
argument_list|,
name|__func__
argument_list|,
name|NG_NODE_NAME
argument_list|(
name|l2cap
operator|->
name|node
argument_list|)
argument_list|)
expr_stmt|;
name|error
operator|=
name|EMSGSIZE
expr_stmt|;
goto|goto
name|out
goto|;
block|}
name|ep
operator|=
operator|(
name|ng_hci_lp_con_cfm_ep
operator|*
operator|)
operator|(
name|msg
operator|->
name|data
operator|)
expr_stmt|;
comment|/* Check if we have requested/accepted this connection */
name|con
operator|=
name|ng_l2cap_con_by_addr
argument_list|(
name|l2cap
argument_list|,
operator|&
name|ep
operator|->
name|bdaddr
argument_list|)
expr_stmt|;
if|if
condition|(
name|con
operator|==
name|NULL
condition|)
block|{
name|NG_L2CAP_ERR
argument_list|(
literal|"%s: %s - unexpected LP_ConnectCfm event. Connection does not exist\n"
argument_list|,
name|__func__
argument_list|,
name|NG_NODE_NAME
argument_list|(
name|l2cap
operator|->
name|node
argument_list|)
argument_list|)
expr_stmt|;
name|error
operator|=
name|ENOENT
expr_stmt|;
goto|goto
name|out
goto|;
block|}
comment|/* Check connection state */
if|if
condition|(
name|con
operator|->
name|state
operator|!=
name|NG_L2CAP_W4_LP_CON_CFM
condition|)
block|{
name|NG_L2CAP_ALERT
argument_list|(
literal|"%s: %s - unexpected LP_ConnectCfm event. "
expr|\
literal|"Invalid connection state, state=%d, con_handle=%d\n"
argument_list|,
name|__func__
argument_list|,
name|NG_NODE_NAME
argument_list|(
name|l2cap
operator|->
name|node
argument_list|)
argument_list|,
name|con
operator|->
name|state
argument_list|,
name|con
operator|->
name|con_handle
argument_list|)
expr_stmt|;
name|error
operator|=
name|EINVAL
expr_stmt|;
goto|goto
name|out
goto|;
block|}
comment|/* 	 * Looks like it is our confirmation. It is safe now to cancel  	 * connection timer and notify upper layer. If timeout already 	 * happened then ignore connection confirmation and let timeout 	 * handle that.  	 */
if|if
condition|(
operator|(
name|error
operator|=
name|ng_l2cap_lp_untimeout
argument_list|(
name|con
argument_list|)
operator|)
operator|!=
literal|0
condition|)
goto|goto
name|out
goto|;
if|if
condition|(
name|ep
operator|->
name|status
operator|==
literal|0
condition|)
block|{
name|con
operator|->
name|state
operator|=
name|NG_L2CAP_CON_OPEN
expr_stmt|;
name|con
operator|->
name|con_handle
operator|=
name|ep
operator|->
name|con_handle
expr_stmt|;
name|ng_l2cap_lp_deliver
argument_list|(
name|con
argument_list|)
expr_stmt|;
block|}
else|else
comment|/* Negative confirmation - remove connection descriptor */
name|ng_l2cap_con_fail
argument_list|(
name|con
argument_list|,
name|ep
operator|->
name|status
argument_list|)
expr_stmt|;
name|out
label|:
return|return
operator|(
name|error
operator|)
return|;
block|}
end_function

begin_comment
comment|/* ng_l2cap_lp_con_cfm */
end_comment

begin_comment
comment|/*  * Process LP_ConnectInd event from the lower layer protocol. This is a good   * place to put some extra check on remote unit address and/or class. We could  * even forward this information to control hook (or check against internal  * black list) and thus implement some kind of firewall. But for now be simple   * and create new connection descriptor, start timer and send LP_ConnectRsp   * event (i.e. accept connection).  */
end_comment

begin_function
name|int
name|ng_l2cap_lp_con_ind
parameter_list|(
name|ng_l2cap_p
name|l2cap
parameter_list|,
name|struct
name|ng_mesg
modifier|*
name|msg
parameter_list|)
block|{
name|ng_hci_lp_con_ind_ep
modifier|*
name|ep
init|=
name|NULL
decl_stmt|;
name|ng_hci_lp_con_rsp_ep
modifier|*
name|rp
init|=
name|NULL
decl_stmt|;
name|struct
name|ng_mesg
modifier|*
name|rsp
init|=
name|NULL
decl_stmt|;
name|ng_l2cap_con_p
name|con
init|=
name|NULL
decl_stmt|;
name|int
name|error
init|=
literal|0
decl_stmt|;
comment|/* Check message */
if|if
condition|(
name|msg
operator|->
name|header
operator|.
name|arglen
operator|!=
sizeof|sizeof
argument_list|(
operator|*
name|ep
argument_list|)
condition|)
block|{
name|NG_L2CAP_ALERT
argument_list|(
literal|"%s: %s - invalid LP_ConnectInd message size\n"
argument_list|,
name|__func__
argument_list|,
name|NG_NODE_NAME
argument_list|(
name|l2cap
operator|->
name|node
argument_list|)
argument_list|)
expr_stmt|;
name|error
operator|=
name|EMSGSIZE
expr_stmt|;
goto|goto
name|out
goto|;
block|}
name|ep
operator|=
operator|(
name|ng_hci_lp_con_ind_ep
operator|*
operator|)
operator|(
name|msg
operator|->
name|data
operator|)
expr_stmt|;
comment|/* Make sure we have only one connection to the remote unit */
name|con
operator|=
name|ng_l2cap_con_by_addr
argument_list|(
name|l2cap
argument_list|,
operator|&
name|ep
operator|->
name|bdaddr
argument_list|)
expr_stmt|;
if|if
condition|(
name|con
operator|!=
name|NULL
condition|)
block|{
name|NG_L2CAP_ALERT
argument_list|(
literal|"%s: %s - unexpected LP_ConnectInd event. "
expr|\
literal|"Connection already exists, state=%d, con_handle=%d\n"
argument_list|,
name|__func__
argument_list|,
name|NG_NODE_NAME
argument_list|(
name|l2cap
operator|->
name|node
argument_list|)
argument_list|,
name|con
operator|->
name|state
argument_list|,
name|con
operator|->
name|con_handle
argument_list|)
expr_stmt|;
name|error
operator|=
name|EEXIST
expr_stmt|;
goto|goto
name|out
goto|;
block|}
comment|/* Check if lower layer protocol is still connected */
if|if
condition|(
name|l2cap
operator|->
name|hci
operator|==
name|NULL
operator|||
name|NG_HOOK_NOT_VALID
argument_list|(
name|l2cap
operator|->
name|hci
argument_list|)
condition|)
block|{
name|NG_L2CAP_ERR
argument_list|(
literal|"%s: %s - hook \"%s\" is not connected or valid"
argument_list|,
name|__func__
argument_list|,
name|NG_NODE_NAME
argument_list|(
name|l2cap
operator|->
name|node
argument_list|)
argument_list|,
name|NG_L2CAP_HOOK_HCI
argument_list|)
expr_stmt|;
name|error
operator|=
name|ENOTCONN
expr_stmt|;
goto|goto
name|out
goto|;
block|}
comment|/* Create and intialize new connection descriptor */
name|con
operator|=
name|ng_l2cap_new_con
argument_list|(
name|l2cap
argument_list|,
operator|&
name|ep
operator|->
name|bdaddr
argument_list|)
expr_stmt|;
if|if
condition|(
name|con
operator|==
name|NULL
condition|)
block|{
name|error
operator|=
name|ENOMEM
expr_stmt|;
goto|goto
name|out
goto|;
block|}
comment|/* Create and send LP_ConnectRsp event */
name|NG_MKMESSAGE
argument_list|(
name|rsp
argument_list|,
name|NGM_HCI_COOKIE
argument_list|,
name|NGM_HCI_LP_CON_RSP
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|rp
argument_list|)
argument_list|,
name|M_NOWAIT
argument_list|)
expr_stmt|;
if|if
condition|(
name|rsp
operator|==
name|NULL
condition|)
block|{
name|ng_l2cap_free_con
argument_list|(
name|con
argument_list|)
expr_stmt|;
name|error
operator|=
name|ENOMEM
expr_stmt|;
goto|goto
name|out
goto|;
block|}
name|rp
operator|=
operator|(
name|ng_hci_lp_con_rsp_ep
operator|*
operator|)
operator|(
name|rsp
operator|->
name|data
operator|)
expr_stmt|;
name|rp
operator|->
name|status
operator|=
literal|0x00
expr_stmt|;
comment|/* accept connection */
name|rp
operator|->
name|link_type
operator|=
name|NG_HCI_LINK_ACL
expr_stmt|;
name|bcopy
argument_list|(
operator|&
name|ep
operator|->
name|bdaddr
argument_list|,
operator|&
name|rp
operator|->
name|bdaddr
argument_list|,
sizeof|sizeof
argument_list|(
name|rp
operator|->
name|bdaddr
argument_list|)
argument_list|)
expr_stmt|;
name|con
operator|->
name|state
operator|=
name|NG_L2CAP_W4_LP_CON_CFM
expr_stmt|;
name|ng_l2cap_lp_timeout
argument_list|(
name|con
argument_list|)
expr_stmt|;
name|NG_SEND_MSG_HOOK
argument_list|(
name|error
argument_list|,
name|l2cap
operator|->
name|node
argument_list|,
name|rsp
argument_list|,
name|l2cap
operator|->
name|hci
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|!=
literal|0
condition|)
block|{
if|if
condition|(
operator|(
name|error
operator|=
name|ng_l2cap_lp_untimeout
argument_list|(
name|con
argument_list|)
operator|)
operator|!=
literal|0
condition|)
goto|goto
name|out
goto|;
name|ng_l2cap_free_con
argument_list|(
name|con
argument_list|)
expr_stmt|;
block|}
name|out
label|:
return|return
operator|(
name|error
operator|)
return|;
block|}
end_function

begin_comment
comment|/* ng_hci_lp_con_ind */
end_comment

begin_comment
comment|/*  * Process LP_DisconnectInd event from the lower layer protocol. We have been  * disconnected from the remote unit. So notify the upper layer protocol.  */
end_comment

begin_function
name|int
name|ng_l2cap_lp_discon_ind
parameter_list|(
name|ng_l2cap_p
name|l2cap
parameter_list|,
name|struct
name|ng_mesg
modifier|*
name|msg
parameter_list|)
block|{
name|ng_hci_lp_discon_ind_ep
modifier|*
name|ep
init|=
name|NULL
decl_stmt|;
name|ng_l2cap_con_p
name|con
init|=
name|NULL
decl_stmt|;
name|int
name|error
init|=
literal|0
decl_stmt|;
comment|/* Check message */
if|if
condition|(
name|msg
operator|->
name|header
operator|.
name|arglen
operator|!=
sizeof|sizeof
argument_list|(
operator|*
name|ep
argument_list|)
condition|)
block|{
name|NG_L2CAP_ALERT
argument_list|(
literal|"%s: %s - invalid LP_DisconnectInd message size\n"
argument_list|,
name|__func__
argument_list|,
name|NG_NODE_NAME
argument_list|(
name|l2cap
operator|->
name|node
argument_list|)
argument_list|)
expr_stmt|;
name|error
operator|=
name|EMSGSIZE
expr_stmt|;
goto|goto
name|out
goto|;
block|}
name|ep
operator|=
operator|(
name|ng_hci_lp_discon_ind_ep
operator|*
operator|)
operator|(
name|msg
operator|->
name|data
operator|)
expr_stmt|;
comment|/* Check if we have this connection */
name|con
operator|=
name|ng_l2cap_con_by_handle
argument_list|(
name|l2cap
argument_list|,
name|ep
operator|->
name|con_handle
argument_list|)
expr_stmt|;
if|if
condition|(
name|con
operator|==
name|NULL
condition|)
block|{
name|NG_L2CAP_ERR
argument_list|(
literal|"%s: %s - unexpected LP_DisconnectInd event. "
expr|\
literal|"Connection does not exist, con_handle=%d\n"
argument_list|,
name|__func__
argument_list|,
name|NG_NODE_NAME
argument_list|(
name|l2cap
operator|->
name|node
argument_list|)
argument_list|,
name|ep
operator|->
name|con_handle
argument_list|)
expr_stmt|;
name|error
operator|=
name|ENOENT
expr_stmt|;
goto|goto
name|out
goto|;
block|}
comment|/* XXX Verify connection state -- do we need to check this? */
if|if
condition|(
name|con
operator|->
name|state
operator|!=
name|NG_L2CAP_CON_OPEN
condition|)
block|{
name|NG_L2CAP_ERR
argument_list|(
literal|"%s: %s - unexpected LP_DisconnectInd event. "
expr|\
literal|"Invalid connection state, state=%d, con_handle=%d\n"
argument_list|,
name|__func__
argument_list|,
name|NG_NODE_NAME
argument_list|(
name|l2cap
operator|->
name|node
argument_list|)
argument_list|,
name|con
operator|->
name|state
argument_list|,
name|con
operator|->
name|con_handle
argument_list|)
expr_stmt|;
name|error
operator|=
name|EINVAL
expr_stmt|;
goto|goto
name|out
goto|;
block|}
comment|/* 	 * Notify upper layer and remove connection 	 * Note: The connection could have auto disconnect timeout set. Try 	 * to remove it. If auto disconnect timeout happened then ignore 	 * disconnect indication and let timeout handle that. 	 */
if|if
condition|(
name|con
operator|->
name|flags
operator|&
name|NG_L2CAP_CON_AUTO_DISCON_TIMO
condition|)
if|if
condition|(
operator|(
name|error
operator|=
name|ng_l2cap_discon_untimeout
argument_list|(
name|con
argument_list|)
operator|)
operator|!=
literal|0
condition|)
return|return
operator|(
name|error
operator|)
return|;
name|ng_l2cap_con_fail
argument_list|(
name|con
argument_list|,
name|ep
operator|->
name|reason
argument_list|)
expr_stmt|;
name|out
label|:
return|return
operator|(
name|error
operator|)
return|;
block|}
end_function

begin_comment
comment|/* ng_l2cap_lp_discon_ind */
end_comment

begin_comment
comment|/*  * Send LP_QoSSetupReq event to the lower layer protocol  */
end_comment

begin_function
name|int
name|ng_l2cap_lp_qos_req
parameter_list|(
name|ng_l2cap_p
name|l2cap
parameter_list|,
name|u_int16_t
name|con_handle
parameter_list|,
name|ng_l2cap_flow_p
name|flow
parameter_list|)
block|{
name|struct
name|ng_mesg
modifier|*
name|msg
init|=
name|NULL
decl_stmt|;
name|ng_hci_lp_qos_req_ep
modifier|*
name|ep
init|=
name|NULL
decl_stmt|;
name|ng_l2cap_con_p
name|con
init|=
name|NULL
decl_stmt|;
name|int
name|error
init|=
literal|0
decl_stmt|;
comment|/* Verify that we have this connection */
name|con
operator|=
name|ng_l2cap_con_by_handle
argument_list|(
name|l2cap
argument_list|,
name|con_handle
argument_list|)
expr_stmt|;
if|if
condition|(
name|con
operator|==
name|NULL
condition|)
block|{
name|NG_L2CAP_ERR
argument_list|(
literal|"%s: %s - unexpected LP_QoSSetupReq event. "
expr|\
literal|"Connection does not exist, con_handle=%d\n"
argument_list|,
name|__func__
argument_list|,
name|NG_NODE_NAME
argument_list|(
name|l2cap
operator|->
name|node
argument_list|)
argument_list|,
name|con_handle
argument_list|)
expr_stmt|;
return|return
operator|(
name|ENOENT
operator|)
return|;
block|}
comment|/* Verify connection state */
if|if
condition|(
name|con
operator|->
name|state
operator|!=
name|NG_L2CAP_CON_OPEN
condition|)
block|{
name|NG_L2CAP_ERR
argument_list|(
literal|"%s: %s - unexpected LP_QoSSetupReq event. "
expr|\
literal|"Invalid connection state, state=%d, con_handle=%d\n"
argument_list|,
name|__func__
argument_list|,
name|NG_NODE_NAME
argument_list|(
name|l2cap
operator|->
name|node
argument_list|)
argument_list|,
name|con
operator|->
name|state
argument_list|,
name|con
operator|->
name|con_handle
argument_list|)
expr_stmt|;
return|return
operator|(
name|EINVAL
operator|)
return|;
block|}
comment|/* Check if lower layer protocol is still connected */
if|if
condition|(
name|l2cap
operator|->
name|hci
operator|==
name|NULL
operator|||
name|NG_HOOK_NOT_VALID
argument_list|(
name|l2cap
operator|->
name|hci
argument_list|)
condition|)
block|{
name|NG_L2CAP_ERR
argument_list|(
literal|"%s: %s - hook \"%s\" is not connected or valid"
argument_list|,
name|__func__
argument_list|,
name|NG_NODE_NAME
argument_list|(
name|l2cap
operator|->
name|node
argument_list|)
argument_list|,
name|NG_L2CAP_HOOK_HCI
argument_list|)
expr_stmt|;
return|return
operator|(
name|ENOTCONN
operator|)
return|;
block|}
comment|/* Create and send LP_QoSSetupReq event */
name|NG_MKMESSAGE
argument_list|(
name|msg
argument_list|,
name|NGM_HCI_COOKIE
argument_list|,
name|NGM_HCI_LP_QOS_REQ
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|ep
argument_list|)
argument_list|,
name|M_NOWAIT
argument_list|)
expr_stmt|;
if|if
condition|(
name|msg
operator|==
name|NULL
condition|)
return|return
operator|(
name|ENOMEM
operator|)
return|;
name|ep
operator|=
operator|(
name|ng_hci_lp_qos_req_ep
operator|*
operator|)
operator|(
name|msg
operator|->
name|data
operator|)
expr_stmt|;
name|ep
operator|->
name|con_handle
operator|=
name|con_handle
expr_stmt|;
name|ep
operator|->
name|flags
operator|=
name|flow
operator|->
name|flags
expr_stmt|;
name|ep
operator|->
name|service_type
operator|=
name|flow
operator|->
name|service_type
expr_stmt|;
name|ep
operator|->
name|token_rate
operator|=
name|flow
operator|->
name|token_rate
expr_stmt|;
name|ep
operator|->
name|peak_bandwidth
operator|=
name|flow
operator|->
name|peak_bandwidth
expr_stmt|;
name|ep
operator|->
name|latency
operator|=
name|flow
operator|->
name|latency
expr_stmt|;
name|ep
operator|->
name|delay_variation
operator|=
name|flow
operator|->
name|delay_variation
expr_stmt|;
name|NG_SEND_MSG_HOOK
argument_list|(
name|error
argument_list|,
name|l2cap
operator|->
name|node
argument_list|,
name|msg
argument_list|,
name|l2cap
operator|->
name|hci
argument_list|,
literal|0
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
end_function

begin_comment
comment|/* ng_l2cap_lp_con_req */
end_comment

begin_comment
comment|/*  * Process LP_QoSSetupCfm from the lower layer protocol  */
end_comment

begin_function
name|int
name|ng_l2cap_lp_qos_cfm
parameter_list|(
name|ng_l2cap_p
name|l2cap
parameter_list|,
name|struct
name|ng_mesg
modifier|*
name|msg
parameter_list|)
block|{
name|ng_hci_lp_qos_cfm_ep
modifier|*
name|ep
init|=
name|NULL
decl_stmt|;
name|int
name|error
init|=
literal|0
decl_stmt|;
comment|/* Check message */
if|if
condition|(
name|msg
operator|->
name|header
operator|.
name|arglen
operator|!=
sizeof|sizeof
argument_list|(
operator|*
name|ep
argument_list|)
condition|)
block|{
name|NG_L2CAP_ALERT
argument_list|(
literal|"%s: %s - invalid LP_QoSSetupCfm[Neg] message size\n"
argument_list|,
name|__func__
argument_list|,
name|NG_NODE_NAME
argument_list|(
name|l2cap
operator|->
name|node
argument_list|)
argument_list|)
expr_stmt|;
name|error
operator|=
name|EMSGSIZE
expr_stmt|;
goto|goto
name|out
goto|;
block|}
name|ep
operator|=
operator|(
name|ng_hci_lp_qos_cfm_ep
operator|*
operator|)
operator|(
name|msg
operator|->
name|data
operator|)
expr_stmt|;
comment|/* XXX FIXME do something */
name|out
label|:
return|return
operator|(
name|error
operator|)
return|;
block|}
end_function

begin_comment
comment|/* ng_l2cap_lp_qos_cfm */
end_comment

begin_comment
comment|/*  * Process LP_QoSViolationInd event from the lower layer protocol. Lower   * layer protocol has detected QoS Violation, so we MUST notify the   * upper layer.  */
end_comment

begin_function
name|int
name|ng_l2cap_lp_qos_ind
parameter_list|(
name|ng_l2cap_p
name|l2cap
parameter_list|,
name|struct
name|ng_mesg
modifier|*
name|msg
parameter_list|)
block|{
name|ng_hci_lp_qos_ind_ep
modifier|*
name|ep
init|=
name|NULL
decl_stmt|;
name|ng_l2cap_con_p
name|con
init|=
name|NULL
decl_stmt|;
name|int
name|error
init|=
literal|0
decl_stmt|;
comment|/* Check message */
if|if
condition|(
name|msg
operator|->
name|header
operator|.
name|arglen
operator|!=
sizeof|sizeof
argument_list|(
operator|*
name|ep
argument_list|)
condition|)
block|{
name|NG_L2CAP_ALERT
argument_list|(
literal|"%s: %s - invalid LP_QoSViolation message size\n"
argument_list|,
name|__func__
argument_list|,
name|NG_NODE_NAME
argument_list|(
name|l2cap
operator|->
name|node
argument_list|)
argument_list|)
expr_stmt|;
name|error
operator|=
name|EMSGSIZE
expr_stmt|;
goto|goto
name|out
goto|;
block|}
name|ep
operator|=
operator|(
name|ng_hci_lp_qos_ind_ep
operator|*
operator|)
operator|(
name|msg
operator|->
name|data
operator|)
expr_stmt|;
comment|/* Check if we have this connection */
name|con
operator|=
name|ng_l2cap_con_by_handle
argument_list|(
name|l2cap
argument_list|,
name|ep
operator|->
name|con_handle
argument_list|)
expr_stmt|;
if|if
condition|(
name|con
operator|==
name|NULL
condition|)
block|{
name|NG_L2CAP_ERR
argument_list|(
literal|"%s: %s - unexpected LP_QoSViolationInd event. "
expr|\
literal|"Connection does not exist, con_handle=%d\n"
argument_list|,
name|__func__
argument_list|,
name|NG_NODE_NAME
argument_list|(
name|l2cap
operator|->
name|node
argument_list|)
argument_list|,
name|ep
operator|->
name|con_handle
argument_list|)
expr_stmt|;
name|error
operator|=
name|ENOENT
expr_stmt|;
goto|goto
name|out
goto|;
block|}
comment|/* Verify connection state */
if|if
condition|(
name|con
operator|->
name|state
operator|!=
name|NG_L2CAP_CON_OPEN
condition|)
block|{
name|NG_L2CAP_ERR
argument_list|(
literal|"%s: %s - unexpected LP_QoSViolationInd event. "
expr|\
literal|"Invalid connection state, state=%d, con_handle=%d\n"
argument_list|,
name|__func__
argument_list|,
name|NG_NODE_NAME
argument_list|(
name|l2cap
operator|->
name|node
argument_list|)
argument_list|,
name|con
operator|->
name|state
argument_list|,
name|con
operator|->
name|con_handle
argument_list|)
expr_stmt|;
name|error
operator|=
name|EINVAL
expr_stmt|;
goto|goto
name|out
goto|;
block|}
comment|/* XXX FIXME Notify upper layer and terminate channels if required */
name|out
label|:
return|return
operator|(
name|error
operator|)
return|;
block|}
end_function

begin_comment
comment|/* ng_l2cap_qos_ind */
end_comment

begin_comment
comment|/*  * Prepare L2CAP packet. Prepend packet with L2CAP packet header and then   * segment it according to HCI MTU.  */
end_comment

begin_function
name|int
name|ng_l2cap_lp_send
parameter_list|(
name|ng_l2cap_con_p
name|con
parameter_list|,
name|u_int16_t
name|dcid
parameter_list|,
name|struct
name|mbuf
modifier|*
name|m0
parameter_list|)
block|{
name|ng_l2cap_p
name|l2cap
init|=
name|con
operator|->
name|l2cap
decl_stmt|;
name|ng_l2cap_hdr_t
modifier|*
name|l2cap_hdr
init|=
name|NULL
decl_stmt|;
name|ng_hci_acldata_pkt_t
modifier|*
name|acl_hdr
init|=
name|NULL
decl_stmt|;
name|struct
name|mbuf
modifier|*
name|m_last
init|=
name|NULL
decl_stmt|,
modifier|*
name|m
init|=
name|NULL
decl_stmt|;
name|int
name|len
decl_stmt|,
name|flag
init|=
name|NG_HCI_PACKET_START
decl_stmt|;
name|KASSERT
argument_list|(
operator|(
name|con
operator|->
name|tx_pkt
operator|==
name|NULL
operator|)
argument_list|,
operator|(
literal|"%s: %s - another packet pending?!\n"
operator|,
name|__func__
operator|,
name|NG_NODE_NAME
argument_list|(
name|l2cap
operator|->
name|node
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|KASSERT
argument_list|(
operator|(
name|l2cap
operator|->
name|pkt_size
operator|>
literal|0
operator|)
argument_list|,
operator|(
literal|"%s: %s - invalid l2cap->pkt_size?!\n"
operator|,
name|__func__
operator|,
name|NG_NODE_NAME
argument_list|(
name|l2cap
operator|->
name|node
argument_list|)
operator|)
argument_list|)
expr_stmt|;
comment|/* Prepend mbuf with L2CAP header */
name|m0
operator|=
name|ng_l2cap_prepend
argument_list|(
name|m0
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|l2cap_hdr
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|m0
operator|==
name|NULL
condition|)
block|{
name|NG_L2CAP_ALERT
argument_list|(
literal|"%s: %s - ng_l2cap_prepend(%zd) failed\n"
argument_list|,
name|__func__
argument_list|,
name|NG_NODE_NAME
argument_list|(
name|l2cap
operator|->
name|node
argument_list|)
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|l2cap_hdr
argument_list|)
argument_list|)
expr_stmt|;
goto|goto
name|fail
goto|;
block|}
name|l2cap_hdr
operator|=
name|mtod
argument_list|(
name|m0
argument_list|,
name|ng_l2cap_hdr_t
operator|*
argument_list|)
expr_stmt|;
name|l2cap_hdr
operator|->
name|length
operator|=
name|htole16
argument_list|(
name|m0
operator|->
name|m_pkthdr
operator|.
name|len
operator|-
sizeof|sizeof
argument_list|(
operator|*
name|l2cap_hdr
argument_list|)
argument_list|)
expr_stmt|;
name|l2cap_hdr
operator|->
name|dcid
operator|=
name|htole16
argument_list|(
name|dcid
argument_list|)
expr_stmt|;
comment|/* 	 * Segment single L2CAP packet according to the HCI layer MTU. Convert  	 * each segment into ACL data packet and prepend it with ACL data packet 	 * header. Link all segments together via m_nextpkt link.   	 * 	 * XXX BC (Broadcast flag) will always be 0 (zero). 	 */
while|while
condition|(
name|m0
operator|!=
name|NULL
condition|)
block|{
comment|/* Check length of the packet against HCI MTU */
name|len
operator|=
name|m0
operator|->
name|m_pkthdr
operator|.
name|len
expr_stmt|;
if|if
condition|(
name|len
operator|>
name|l2cap
operator|->
name|pkt_size
condition|)
block|{
name|m
operator|=
name|m_split
argument_list|(
name|m0
argument_list|,
name|l2cap
operator|->
name|pkt_size
argument_list|,
name|M_DONTWAIT
argument_list|)
expr_stmt|;
if|if
condition|(
name|m
operator|==
name|NULL
condition|)
block|{
name|NG_L2CAP_ALERT
argument_list|(
literal|"%s: %s - m_split(%d) failed\n"
argument_list|,
name|__func__
argument_list|,
name|NG_NODE_NAME
argument_list|(
name|l2cap
operator|->
name|node
argument_list|)
argument_list|,
name|l2cap
operator|->
name|pkt_size
argument_list|)
expr_stmt|;
goto|goto
name|fail
goto|;
block|}
name|len
operator|=
name|l2cap
operator|->
name|pkt_size
expr_stmt|;
block|}
comment|/* Convert packet fragment into ACL data packet */
name|m0
operator|=
name|ng_l2cap_prepend
argument_list|(
name|m0
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|acl_hdr
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|m0
operator|==
name|NULL
condition|)
block|{
name|NG_L2CAP_ALERT
argument_list|(
literal|"%s: %s - ng_l2cap_prepend(%zd) failed\n"
argument_list|,
name|__func__
argument_list|,
name|NG_NODE_NAME
argument_list|(
name|l2cap
operator|->
name|node
argument_list|)
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|acl_hdr
argument_list|)
argument_list|)
expr_stmt|;
goto|goto
name|fail
goto|;
block|}
name|acl_hdr
operator|=
name|mtod
argument_list|(
name|m0
argument_list|,
name|ng_hci_acldata_pkt_t
operator|*
argument_list|)
expr_stmt|;
name|acl_hdr
operator|->
name|type
operator|=
name|NG_HCI_ACL_DATA_PKT
expr_stmt|;
name|acl_hdr
operator|->
name|length
operator|=
name|htole16
argument_list|(
name|len
argument_list|)
expr_stmt|;
name|acl_hdr
operator|->
name|con_handle
operator|=
name|htole16
argument_list|(
name|NG_HCI_MK_CON_HANDLE
argument_list|(
name|con
operator|->
name|con_handle
argument_list|,
name|flag
argument_list|,
literal|0
argument_list|)
argument_list|)
expr_stmt|;
comment|/* Add fragment to the chain */
name|m0
operator|->
name|m_nextpkt
operator|=
name|NULL
expr_stmt|;
if|if
condition|(
name|con
operator|->
name|tx_pkt
operator|==
name|NULL
condition|)
name|con
operator|->
name|tx_pkt
operator|=
name|m_last
operator|=
name|m0
expr_stmt|;
else|else
block|{
name|m_last
operator|->
name|m_nextpkt
operator|=
name|m0
expr_stmt|;
name|m_last
operator|=
name|m0
expr_stmt|;
block|}
name|NG_L2CAP_INFO
argument_list|(
literal|"%s: %s - attaching ACL packet, con_handle=%d, PB=%#x, length=%d\n"
argument_list|,
name|__func__
argument_list|,
name|NG_NODE_NAME
argument_list|(
name|l2cap
operator|->
name|node
argument_list|)
argument_list|,
name|con
operator|->
name|con_handle
argument_list|,
name|flag
argument_list|,
name|len
argument_list|)
expr_stmt|;
name|m0
operator|=
name|m
expr_stmt|;
name|m
operator|=
name|NULL
expr_stmt|;
name|flag
operator|=
name|NG_HCI_PACKET_FRAGMENT
expr_stmt|;
block|}
return|return
operator|(
literal|0
operator|)
return|;
name|fail
label|:
name|NG_FREE_M
argument_list|(
name|m0
argument_list|)
expr_stmt|;
name|NG_FREE_M
argument_list|(
name|m
argument_list|)
expr_stmt|;
while|while
condition|(
name|con
operator|->
name|tx_pkt
operator|!=
name|NULL
condition|)
block|{
name|m
operator|=
name|con
operator|->
name|tx_pkt
operator|->
name|m_nextpkt
expr_stmt|;
name|m_freem
argument_list|(
name|con
operator|->
name|tx_pkt
argument_list|)
expr_stmt|;
name|con
operator|->
name|tx_pkt
operator|=
name|m
expr_stmt|;
block|}
return|return
operator|(
name|ENOBUFS
operator|)
return|;
block|}
end_function

begin_comment
comment|/* ng_l2cap_lp_send */
end_comment

begin_comment
comment|/*  * Receive ACL data packet from the HCI layer. First strip ACL packet header  * and get connection handle, PB (Packet Boundary) flag and payload length.  * Then find connection descriptor and verify its state. Then process ACL   * packet as follows.  *   * 1) If we got first segment (pb == NG_HCI_PACKET_START) then extract L2CAP   *    header and get total length of the L2CAP packet. Then start new L2CAP   *    packet.  *  * 2) If we got other (then first :) segment (pb == NG_HCI_PACKET_FRAGMENT)  *    then add segment to the packet.  */
end_comment

begin_function
name|int
name|ng_l2cap_lp_receive
parameter_list|(
name|ng_l2cap_p
name|l2cap
parameter_list|,
name|struct
name|mbuf
modifier|*
name|m
parameter_list|)
block|{
name|ng_hci_acldata_pkt_t
modifier|*
name|acl_hdr
init|=
name|NULL
decl_stmt|;
name|ng_l2cap_hdr_t
modifier|*
name|l2cap_hdr
init|=
name|NULL
decl_stmt|;
name|ng_l2cap_con_p
name|con
init|=
name|NULL
decl_stmt|;
name|u_int16_t
name|con_handle
decl_stmt|,
name|length
decl_stmt|,
name|pb
decl_stmt|;
name|int
name|error
init|=
literal|0
decl_stmt|;
comment|/* Check ACL data packet */
if|if
condition|(
name|m
operator|->
name|m_pkthdr
operator|.
name|len
operator|<
sizeof|sizeof
argument_list|(
operator|*
name|acl_hdr
argument_list|)
condition|)
block|{
name|NG_L2CAP_ERR
argument_list|(
literal|"%s: %s - invalid ACL data packet. Packet too small, length=%d\n"
argument_list|,
name|__func__
argument_list|,
name|NG_NODE_NAME
argument_list|(
name|l2cap
operator|->
name|node
argument_list|)
argument_list|,
name|m
operator|->
name|m_pkthdr
operator|.
name|len
argument_list|)
expr_stmt|;
name|error
operator|=
name|EMSGSIZE
expr_stmt|;
goto|goto
name|drop
goto|;
block|}
comment|/* Strip ACL data packet header */
name|NG_L2CAP_M_PULLUP
argument_list|(
name|m
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|acl_hdr
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|m
operator|==
name|NULL
condition|)
return|return
operator|(
name|ENOBUFS
operator|)
return|;
name|acl_hdr
operator|=
name|mtod
argument_list|(
name|m
argument_list|,
name|ng_hci_acldata_pkt_t
operator|*
argument_list|)
expr_stmt|;
name|m_adj
argument_list|(
name|m
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|acl_hdr
argument_list|)
argument_list|)
expr_stmt|;
comment|/* Get ACL connection handle, PB flag and payload length */
name|acl_hdr
operator|->
name|con_handle
operator|=
name|le16toh
argument_list|(
name|acl_hdr
operator|->
name|con_handle
argument_list|)
expr_stmt|;
name|con_handle
operator|=
name|NG_HCI_CON_HANDLE
argument_list|(
name|acl_hdr
operator|->
name|con_handle
argument_list|)
expr_stmt|;
name|pb
operator|=
name|NG_HCI_PB_FLAG
argument_list|(
name|acl_hdr
operator|->
name|con_handle
argument_list|)
expr_stmt|;
name|length
operator|=
name|le16toh
argument_list|(
name|acl_hdr
operator|->
name|length
argument_list|)
expr_stmt|;
name|NG_L2CAP_INFO
argument_list|(
literal|"%s: %s - got ACL data packet, con_handle=%d, PB=%#x, length=%d\n"
argument_list|,
name|__func__
argument_list|,
name|NG_NODE_NAME
argument_list|(
name|l2cap
operator|->
name|node
argument_list|)
argument_list|,
name|con_handle
argument_list|,
name|pb
argument_list|,
name|length
argument_list|)
expr_stmt|;
comment|/* Get connection descriptor */
name|con
operator|=
name|ng_l2cap_con_by_handle
argument_list|(
name|l2cap
argument_list|,
name|con_handle
argument_list|)
expr_stmt|;
if|if
condition|(
name|con
operator|==
name|NULL
condition|)
block|{
name|NG_L2CAP_ERR
argument_list|(
literal|"%s: %s - unexpected ACL data packet. "
expr|\
literal|"Connection does not exist, con_handle=%d\n"
argument_list|,
name|__func__
argument_list|,
name|NG_NODE_NAME
argument_list|(
name|l2cap
operator|->
name|node
argument_list|)
argument_list|,
name|con_handle
argument_list|)
expr_stmt|;
name|error
operator|=
name|ENOENT
expr_stmt|;
goto|goto
name|drop
goto|;
block|}
comment|/* Verify connection state */
if|if
condition|(
name|con
operator|->
name|state
operator|!=
name|NG_L2CAP_CON_OPEN
condition|)
block|{
name|NG_L2CAP_ERR
argument_list|(
literal|"%s: %s - unexpected ACL data packet. Invalid connection state=%d\n"
argument_list|,
name|__func__
argument_list|,
name|NG_NODE_NAME
argument_list|(
name|l2cap
operator|->
name|node
argument_list|)
argument_list|,
name|con
operator|->
name|state
argument_list|)
expr_stmt|;
name|error
operator|=
name|EHOSTDOWN
expr_stmt|;
goto|goto
name|drop
goto|;
block|}
comment|/* Process packet */
if|if
condition|(
name|pb
operator|==
name|NG_HCI_PACKET_START
condition|)
block|{
if|if
condition|(
name|con
operator|->
name|rx_pkt
operator|!=
name|NULL
condition|)
block|{
name|NG_L2CAP_ERR
argument_list|(
literal|"%s: %s - dropping incomplete L2CAP packet, got %d bytes, want %d bytes\n"
argument_list|,
name|__func__
argument_list|,
name|NG_NODE_NAME
argument_list|(
name|l2cap
operator|->
name|node
argument_list|)
argument_list|,
name|con
operator|->
name|rx_pkt
operator|->
name|m_pkthdr
operator|.
name|len
argument_list|,
name|con
operator|->
name|rx_pkt_len
argument_list|)
expr_stmt|;
name|NG_FREE_M
argument_list|(
name|con
operator|->
name|rx_pkt
argument_list|)
expr_stmt|;
name|con
operator|->
name|rx_pkt_len
operator|=
literal|0
expr_stmt|;
block|}
comment|/* Get L2CAP header */
if|if
condition|(
name|m
operator|->
name|m_pkthdr
operator|.
name|len
operator|<
sizeof|sizeof
argument_list|(
operator|*
name|l2cap_hdr
argument_list|)
condition|)
block|{
name|NG_L2CAP_ERR
argument_list|(
literal|"%s: %s - invalid L2CAP packet start fragment. Packet too small, length=%d\n"
argument_list|,
name|__func__
argument_list|,
name|NG_NODE_NAME
argument_list|(
name|l2cap
operator|->
name|node
argument_list|)
argument_list|,
name|m
operator|->
name|m_pkthdr
operator|.
name|len
argument_list|)
expr_stmt|;
name|error
operator|=
name|EMSGSIZE
expr_stmt|;
goto|goto
name|drop
goto|;
block|}
name|NG_L2CAP_M_PULLUP
argument_list|(
name|m
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|l2cap_hdr
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|m
operator|==
name|NULL
condition|)
return|return
operator|(
name|ENOBUFS
operator|)
return|;
name|l2cap_hdr
operator|=
name|mtod
argument_list|(
name|m
argument_list|,
name|ng_l2cap_hdr_t
operator|*
argument_list|)
expr_stmt|;
name|NG_L2CAP_INFO
argument_list|(
literal|"%s: %s - staring new L2CAP packet, con_handle=%d, length=%d\n"
argument_list|,
name|__func__
argument_list|,
name|NG_NODE_NAME
argument_list|(
name|l2cap
operator|->
name|node
argument_list|)
argument_list|,
name|con_handle
argument_list|,
name|le16toh
argument_list|(
name|l2cap_hdr
operator|->
name|length
argument_list|)
argument_list|)
expr_stmt|;
comment|/* Start new L2CAP packet */
name|con
operator|->
name|rx_pkt
operator|=
name|m
expr_stmt|;
name|con
operator|->
name|rx_pkt_len
operator|=
name|le16toh
argument_list|(
name|l2cap_hdr
operator|->
name|length
argument_list|)
operator|+
sizeof|sizeof
argument_list|(
operator|*
name|l2cap_hdr
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|pb
operator|==
name|NG_HCI_PACKET_FRAGMENT
condition|)
block|{
if|if
condition|(
name|con
operator|->
name|rx_pkt
operator|==
name|NULL
condition|)
block|{
name|NG_L2CAP_ERR
argument_list|(
literal|"%s: %s - unexpected ACL data packet fragment, con_handle=%d\n"
argument_list|,
name|__func__
argument_list|,
name|NG_NODE_NAME
argument_list|(
name|l2cap
operator|->
name|node
argument_list|)
argument_list|,
name|con
operator|->
name|con_handle
argument_list|)
expr_stmt|;
goto|goto
name|drop
goto|;
block|}
comment|/* Add fragment to the L2CAP packet */
name|m_cat
argument_list|(
name|con
operator|->
name|rx_pkt
argument_list|,
name|m
argument_list|)
expr_stmt|;
name|con
operator|->
name|rx_pkt
operator|->
name|m_pkthdr
operator|.
name|len
operator|+=
name|length
expr_stmt|;
block|}
else|else
block|{
name|NG_L2CAP_ERR
argument_list|(
literal|"%s: %s - invalid ACL data packet. Invalid PB flag=%#x\n"
argument_list|,
name|__func__
argument_list|,
name|NG_NODE_NAME
argument_list|(
name|l2cap
operator|->
name|node
argument_list|)
argument_list|,
name|pb
argument_list|)
expr_stmt|;
name|error
operator|=
name|EINVAL
expr_stmt|;
goto|goto
name|drop
goto|;
block|}
name|con
operator|->
name|rx_pkt_len
operator|-=
name|length
expr_stmt|;
if|if
condition|(
name|con
operator|->
name|rx_pkt_len
operator|<
literal|0
condition|)
block|{
name|NG_L2CAP_ALERT
argument_list|(
literal|"%s: %s - packet length mismatch. Got %d bytes, offset %d bytes\n"
argument_list|,
name|__func__
argument_list|,
name|NG_NODE_NAME
argument_list|(
name|l2cap
operator|->
name|node
argument_list|)
argument_list|,
name|con
operator|->
name|rx_pkt
operator|->
name|m_pkthdr
operator|.
name|len
argument_list|,
name|con
operator|->
name|rx_pkt_len
argument_list|)
expr_stmt|;
name|NG_FREE_M
argument_list|(
name|con
operator|->
name|rx_pkt
argument_list|)
expr_stmt|;
name|con
operator|->
name|rx_pkt_len
operator|=
literal|0
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|con
operator|->
name|rx_pkt_len
operator|==
literal|0
condition|)
block|{
comment|/* OK, we have got complete L2CAP packet, so process it */
name|error
operator|=
name|ng_l2cap_receive
argument_list|(
name|con
argument_list|)
expr_stmt|;
name|con
operator|->
name|rx_pkt
operator|=
name|NULL
expr_stmt|;
name|con
operator|->
name|rx_pkt_len
operator|=
literal|0
expr_stmt|;
block|}
return|return
operator|(
name|error
operator|)
return|;
name|drop
label|:
name|NG_FREE_M
argument_list|(
name|m
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
end_function

begin_comment
comment|/* ng_l2cap_lp_receive */
end_comment

begin_comment
comment|/*  * Send queued ACL packets to the HCI layer  */
end_comment

begin_function
name|void
name|ng_l2cap_lp_deliver
parameter_list|(
name|ng_l2cap_con_p
name|con
parameter_list|)
block|{
name|ng_l2cap_p
name|l2cap
init|=
name|con
operator|->
name|l2cap
decl_stmt|;
name|struct
name|mbuf
modifier|*
name|m
init|=
name|NULL
decl_stmt|;
name|int
name|error
decl_stmt|;
comment|/* Check connection */
if|if
condition|(
name|con
operator|->
name|state
operator|!=
name|NG_L2CAP_CON_OPEN
condition|)
return|return;
if|if
condition|(
name|con
operator|->
name|tx_pkt
operator|==
name|NULL
condition|)
name|ng_l2cap_con_wakeup
argument_list|(
name|con
argument_list|)
expr_stmt|;
if|if
condition|(
name|con
operator|->
name|tx_pkt
operator|==
name|NULL
condition|)
return|return;
comment|/* Check if lower layer protocol is still connected */
if|if
condition|(
name|l2cap
operator|->
name|hci
operator|==
name|NULL
operator|||
name|NG_HOOK_NOT_VALID
argument_list|(
name|l2cap
operator|->
name|hci
argument_list|)
condition|)
block|{
name|NG_L2CAP_ERR
argument_list|(
literal|"%s: %s - hook \"%s\" is not connected or valid"
argument_list|,
name|__func__
argument_list|,
name|NG_NODE_NAME
argument_list|(
name|l2cap
operator|->
name|node
argument_list|)
argument_list|,
name|NG_L2CAP_HOOK_HCI
argument_list|)
expr_stmt|;
goto|goto
name|drop
goto|;
comment|/* XXX what to do with "pending"? */
block|}
comment|/* Send ACL data packets */
while|while
condition|(
name|con
operator|->
name|pending
operator|<
name|con
operator|->
name|l2cap
operator|->
name|num_pkts
operator|&&
name|con
operator|->
name|tx_pkt
operator|!=
name|NULL
condition|)
block|{
name|m
operator|=
name|con
operator|->
name|tx_pkt
expr_stmt|;
name|con
operator|->
name|tx_pkt
operator|=
name|con
operator|->
name|tx_pkt
operator|->
name|m_nextpkt
expr_stmt|;
name|m
operator|->
name|m_nextpkt
operator|=
name|NULL
expr_stmt|;
name|NG_L2CAP_INFO
argument_list|(
literal|"%s: %s - sending ACL packet, con_handle=%d, len=%d\n"
argument_list|,
name|__func__
argument_list|,
name|NG_NODE_NAME
argument_list|(
name|l2cap
operator|->
name|node
argument_list|)
argument_list|,
name|con
operator|->
name|con_handle
argument_list|,
name|m
operator|->
name|m_pkthdr
operator|.
name|len
argument_list|)
expr_stmt|;
name|NG_SEND_DATA_ONLY
argument_list|(
name|error
argument_list|,
name|l2cap
operator|->
name|hci
argument_list|,
name|m
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|!=
literal|0
condition|)
block|{
name|NG_L2CAP_ERR
argument_list|(
literal|"%s: %s - could not send ACL data packet, con_handle=%d, error=%d\n"
argument_list|,
name|__func__
argument_list|,
name|NG_NODE_NAME
argument_list|(
name|l2cap
operator|->
name|node
argument_list|)
argument_list|,
name|con
operator|->
name|con_handle
argument_list|,
name|error
argument_list|)
expr_stmt|;
goto|goto
name|drop
goto|;
comment|/* XXX what to do with "pending"? */
block|}
name|con
operator|->
name|pending
operator|++
expr_stmt|;
block|}
name|NG_L2CAP_INFO
argument_list|(
literal|"%s: %s - %d ACL packets have been sent, con_handle=%d\n"
argument_list|,
name|__func__
argument_list|,
name|NG_NODE_NAME
argument_list|(
name|l2cap
operator|->
name|node
argument_list|)
argument_list|,
name|con
operator|->
name|pending
argument_list|,
name|con
operator|->
name|con_handle
argument_list|)
expr_stmt|;
return|return;
name|drop
label|:
while|while
condition|(
name|con
operator|->
name|tx_pkt
operator|!=
name|NULL
condition|)
block|{
name|m
operator|=
name|con
operator|->
name|tx_pkt
operator|->
name|m_nextpkt
expr_stmt|;
name|m_freem
argument_list|(
name|con
operator|->
name|tx_pkt
argument_list|)
expr_stmt|;
name|con
operator|->
name|tx_pkt
operator|=
name|m
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/* ng_l2cap_lp_deliver */
end_comment

begin_comment
comment|/*  * Process connection timeout. Remove connection from the list. If there  * are any channels that wait for the connection then notify them. Free   * connection descriptor.  */
end_comment

begin_function
name|void
name|ng_l2cap_process_lp_timeout
parameter_list|(
name|node_p
name|node
parameter_list|,
name|hook_p
name|hook
parameter_list|,
name|void
modifier|*
name|arg1
parameter_list|,
name|int
name|con_handle
parameter_list|)
block|{
name|ng_l2cap_p
name|l2cap
init|=
name|NULL
decl_stmt|;
name|ng_l2cap_con_p
name|con
init|=
name|NULL
decl_stmt|;
if|if
condition|(
name|NG_NODE_NOT_VALID
argument_list|(
name|node
argument_list|)
condition|)
block|{
name|printf
argument_list|(
literal|"%s: Netgraph node is not valid\n"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
return|return;
block|}
name|l2cap
operator|=
operator|(
name|ng_l2cap_p
operator|)
name|NG_NODE_PRIVATE
argument_list|(
name|node
argument_list|)
expr_stmt|;
name|con
operator|=
name|ng_l2cap_con_by_handle
argument_list|(
name|l2cap
argument_list|,
name|con_handle
argument_list|)
expr_stmt|;
if|if
condition|(
name|con
operator|==
name|NULL
condition|)
block|{
name|NG_L2CAP_ALERT
argument_list|(
literal|"%s: %s - could not find connection, con_handle=%d\n"
argument_list|,
name|__func__
argument_list|,
name|NG_NODE_NAME
argument_list|(
name|node
argument_list|)
argument_list|,
name|con_handle
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
operator|!
operator|(
name|con
operator|->
name|flags
operator|&
name|NG_L2CAP_CON_LP_TIMO
operator|)
condition|)
block|{
name|NG_L2CAP_ALERT
argument_list|(
literal|"%s: %s - no pending LP timeout, con_handle=%d, state=%d, flags=%#x\n"
argument_list|,
name|__func__
argument_list|,
name|NG_NODE_NAME
argument_list|(
name|node
argument_list|)
argument_list|,
name|con_handle
argument_list|,
name|con
operator|->
name|state
argument_list|,
name|con
operator|->
name|flags
argument_list|)
expr_stmt|;
return|return;
block|}
comment|/* 	 * Notify channels that connection has timed out. This will remove  	 * connection, channels and pending commands. 	 */
name|con
operator|->
name|flags
operator|&=
operator|~
name|NG_L2CAP_CON_LP_TIMO
expr_stmt|;
name|ng_l2cap_con_fail
argument_list|(
name|con
argument_list|,
name|NG_L2CAP_TIMEOUT
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* ng_l2cap_process_lp_timeout */
end_comment

begin_comment
comment|/*  * Process auto disconnect timeout and send LP_DisconReq event to the   * lower layer protocol  */
end_comment

begin_function
name|void
name|ng_l2cap_process_discon_timeout
parameter_list|(
name|node_p
name|node
parameter_list|,
name|hook_p
name|hook
parameter_list|,
name|void
modifier|*
name|arg1
parameter_list|,
name|int
name|con_handle
parameter_list|)
block|{
name|ng_l2cap_p
name|l2cap
init|=
name|NULL
decl_stmt|;
name|ng_l2cap_con_p
name|con
init|=
name|NULL
decl_stmt|;
name|struct
name|ng_mesg
modifier|*
name|msg
init|=
name|NULL
decl_stmt|;
name|ng_hci_lp_discon_req_ep
modifier|*
name|ep
init|=
name|NULL
decl_stmt|;
name|int
name|error
decl_stmt|;
if|if
condition|(
name|NG_NODE_NOT_VALID
argument_list|(
name|node
argument_list|)
condition|)
block|{
name|printf
argument_list|(
literal|"%s: Netgraph node is not valid\n"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
return|return;
block|}
name|l2cap
operator|=
operator|(
name|ng_l2cap_p
operator|)
name|NG_NODE_PRIVATE
argument_list|(
name|node
argument_list|)
expr_stmt|;
name|con
operator|=
name|ng_l2cap_con_by_handle
argument_list|(
name|l2cap
argument_list|,
name|con_handle
argument_list|)
expr_stmt|;
if|if
condition|(
name|con
operator|==
name|NULL
condition|)
block|{
name|NG_L2CAP_ALERT
argument_list|(
literal|"%s: %s - could not find connection, con_handle=%d\n"
argument_list|,
name|__func__
argument_list|,
name|NG_NODE_NAME
argument_list|(
name|node
argument_list|)
argument_list|,
name|con_handle
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
operator|!
operator|(
name|con
operator|->
name|flags
operator|&
name|NG_L2CAP_CON_AUTO_DISCON_TIMO
operator|)
condition|)
block|{
name|NG_L2CAP_ALERT
argument_list|(
literal|"%s: %s - no pending disconnect timeout, con_handle=%d, state=%d, flags=%#x\n"
argument_list|,
name|__func__
argument_list|,
name|NG_NODE_NAME
argument_list|(
name|node
argument_list|)
argument_list|,
name|con_handle
argument_list|,
name|con
operator|->
name|state
argument_list|,
name|con
operator|->
name|flags
argument_list|)
expr_stmt|;
return|return;
block|}
name|con
operator|->
name|flags
operator|&=
operator|~
name|NG_L2CAP_CON_AUTO_DISCON_TIMO
expr_stmt|;
comment|/* Check if lower layer protocol is still connected */
if|if
condition|(
name|l2cap
operator|->
name|hci
operator|==
name|NULL
operator|||
name|NG_HOOK_NOT_VALID
argument_list|(
name|l2cap
operator|->
name|hci
argument_list|)
condition|)
block|{
name|NG_L2CAP_ERR
argument_list|(
literal|"%s: %s - hook \"%s\" is not connected or valid\n"
argument_list|,
name|__func__
argument_list|,
name|NG_NODE_NAME
argument_list|(
name|l2cap
operator|->
name|node
argument_list|)
argument_list|,
name|NG_L2CAP_HOOK_HCI
argument_list|)
expr_stmt|;
return|return;
block|}
comment|/* Create and send LP_DisconReq event */
name|NG_MKMESSAGE
argument_list|(
name|msg
argument_list|,
name|NGM_HCI_COOKIE
argument_list|,
name|NGM_HCI_LP_DISCON_REQ
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|ep
argument_list|)
argument_list|,
name|M_NOWAIT
argument_list|)
expr_stmt|;
if|if
condition|(
name|msg
operator|==
name|NULL
condition|)
return|return;
name|ep
operator|=
operator|(
name|ng_hci_lp_discon_req_ep
operator|*
operator|)
operator|(
name|msg
operator|->
name|data
operator|)
expr_stmt|;
name|ep
operator|->
name|con_handle
operator|=
name|con
operator|->
name|con_handle
expr_stmt|;
name|ep
operator|->
name|reason
operator|=
literal|0x13
expr_stmt|;
comment|/* User Ended Connection */
name|NG_SEND_MSG_HOOK
argument_list|(
name|error
argument_list|,
name|l2cap
operator|->
name|node
argument_list|,
name|msg
argument_list|,
name|l2cap
operator|->
name|hci
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* ng_l2cap_process_discon_timeout */
end_comment

end_unit


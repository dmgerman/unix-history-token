begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * ng_l2cap_evnt.c  */
end_comment

begin_comment
comment|/*-  * Copyright (c) Maksim Yevmenkin<m_evmenkin@yahoo.com>  * All rights reserved.  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions  * are met:  * 1. Redistributions of source code must retain the above copyright  *    notice, this list of conditions and the following disclaimer.  * 2. Redistributions in binary form must reproduce the above copyright  *    notice, this list of conditions and the following disclaimer in the  *    documentation and/or other materials provided with the distribution.  *  * THIS SOFTWARE IS PROVIDED BY THE AUTHOR AND CONTRIBUTORS ``AS IS'' AND  * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE  * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE  * ARE DISCLAIMED. IN NO EVENT SHALL THE AUTHOR OR CONTRIBUTORS BE LIABLE  * FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL  * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS  * OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)  * HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT  * LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY  * OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF  * SUCH DAMAGE.  *  * $Id: ng_l2cap_evnt.c,v 1.5 2003/09/08 19:11:45 max Exp $  * $FreeBSD$  */
end_comment

begin_include
include|#
directive|include
file|<sys/param.h>
end_include

begin_include
include|#
directive|include
file|<sys/systm.h>
end_include

begin_include
include|#
directive|include
file|<sys/kernel.h>
end_include

begin_include
include|#
directive|include
file|<sys/endian.h>
end_include

begin_include
include|#
directive|include
file|<sys/malloc.h>
end_include

begin_include
include|#
directive|include
file|<sys/mbuf.h>
end_include

begin_include
include|#
directive|include
file|<sys/queue.h>
end_include

begin_include
include|#
directive|include
file|<netgraph/ng_message.h>
end_include

begin_include
include|#
directive|include
file|<netgraph/netgraph.h>
end_include

begin_include
include|#
directive|include
file|<netgraph/bluetooth/include/ng_bluetooth.h>
end_include

begin_include
include|#
directive|include
file|<netgraph/bluetooth/include/ng_hci.h>
end_include

begin_include
include|#
directive|include
file|<netgraph/bluetooth/include/ng_l2cap.h>
end_include

begin_include
include|#
directive|include
file|<netgraph/bluetooth/l2cap/ng_l2cap_var.h>
end_include

begin_include
include|#
directive|include
file|<netgraph/bluetooth/l2cap/ng_l2cap_cmds.h>
end_include

begin_include
include|#
directive|include
file|<netgraph/bluetooth/l2cap/ng_l2cap_evnt.h>
end_include

begin_include
include|#
directive|include
file|<netgraph/bluetooth/l2cap/ng_l2cap_llpi.h>
end_include

begin_include
include|#
directive|include
file|<netgraph/bluetooth/l2cap/ng_l2cap_ulpi.h>
end_include

begin_include
include|#
directive|include
file|<netgraph/bluetooth/l2cap/ng_l2cap_misc.h>
end_include

begin_comment
comment|/******************************************************************************  ******************************************************************************  **                    L2CAP events processing module  ******************************************************************************  ******************************************************************************/
end_comment

begin_function_decl
specifier|static
name|int
name|ng_l2cap_process_signal_cmd
parameter_list|(
name|ng_l2cap_con_p
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|ng_l2cap_process_cmd_rej
parameter_list|(
name|ng_l2cap_con_p
parameter_list|,
name|u_int8_t
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|ng_l2cap_process_con_req
parameter_list|(
name|ng_l2cap_con_p
parameter_list|,
name|u_int8_t
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|ng_l2cap_process_con_rsp
parameter_list|(
name|ng_l2cap_con_p
parameter_list|,
name|u_int8_t
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|ng_l2cap_process_cfg_req
parameter_list|(
name|ng_l2cap_con_p
parameter_list|,
name|u_int8_t
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|ng_l2cap_process_cfg_rsp
parameter_list|(
name|ng_l2cap_con_p
parameter_list|,
name|u_int8_t
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|ng_l2cap_process_discon_req
parameter_list|(
name|ng_l2cap_con_p
parameter_list|,
name|u_int8_t
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|ng_l2cap_process_discon_rsp
parameter_list|(
name|ng_l2cap_con_p
parameter_list|,
name|u_int8_t
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|ng_l2cap_process_echo_req
parameter_list|(
name|ng_l2cap_con_p
parameter_list|,
name|u_int8_t
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|ng_l2cap_process_echo_rsp
parameter_list|(
name|ng_l2cap_con_p
parameter_list|,
name|u_int8_t
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|ng_l2cap_process_info_req
parameter_list|(
name|ng_l2cap_con_p
parameter_list|,
name|u_int8_t
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|ng_l2cap_process_info_rsp
parameter_list|(
name|ng_l2cap_con_p
parameter_list|,
name|u_int8_t
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|send_l2cap_reject
parameter_list|(
name|ng_l2cap_con_p
parameter_list|,
name|u_int8_t
parameter_list|,
name|u_int16_t
parameter_list|,
name|u_int16_t
parameter_list|,
name|u_int16_t
parameter_list|,
name|u_int16_t
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|send_l2cap_con_rej
parameter_list|(
name|ng_l2cap_con_p
parameter_list|,
name|u_int8_t
parameter_list|,
name|u_int16_t
parameter_list|,
name|u_int16_t
parameter_list|,
name|u_int16_t
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|send_l2cap_cfg_rsp
parameter_list|(
name|ng_l2cap_con_p
parameter_list|,
name|u_int8_t
parameter_list|,
name|u_int16_t
parameter_list|,
name|u_int16_t
parameter_list|,
name|struct
name|mbuf
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|get_next_l2cap_opt
parameter_list|(
name|struct
name|mbuf
modifier|*
parameter_list|,
name|int
modifier|*
parameter_list|,
name|ng_l2cap_cfg_opt_p
parameter_list|,
name|ng_l2cap_cfg_opt_val_p
parameter_list|)
function_decl|;
end_function_decl

begin_comment
comment|/*  * Receive L2CAP packet. First get L2CAP header and verify packet. Than  * get destination channel and process packet.  */
end_comment

begin_function
name|int
name|ng_l2cap_receive
parameter_list|(
name|ng_l2cap_con_p
name|con
parameter_list|)
block|{
name|ng_l2cap_p
name|l2cap
init|=
name|con
operator|->
name|l2cap
decl_stmt|;
name|ng_l2cap_hdr_t
modifier|*
name|hdr
init|=
name|NULL
decl_stmt|;
name|int
name|error
init|=
literal|0
decl_stmt|;
comment|/* Check packet */
if|if
condition|(
name|con
operator|->
name|rx_pkt
operator|->
name|m_pkthdr
operator|.
name|len
operator|<
sizeof|sizeof
argument_list|(
operator|*
name|hdr
argument_list|)
condition|)
block|{
name|NG_L2CAP_ERR
argument_list|(
literal|"%s: %s - invalid L2CAP packet. Packet too small, len=%d\n"
argument_list|,
name|__func__
argument_list|,
name|NG_NODE_NAME
argument_list|(
name|l2cap
operator|->
name|node
argument_list|)
argument_list|,
name|con
operator|->
name|rx_pkt
operator|->
name|m_pkthdr
operator|.
name|len
argument_list|)
expr_stmt|;
name|error
operator|=
name|EMSGSIZE
expr_stmt|;
goto|goto
name|drop
goto|;
block|}
comment|/* Get L2CAP header */
name|NG_L2CAP_M_PULLUP
argument_list|(
name|con
operator|->
name|rx_pkt
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|hdr
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|con
operator|->
name|rx_pkt
operator|==
name|NULL
condition|)
return|return
operator|(
name|ENOBUFS
operator|)
return|;
name|hdr
operator|=
name|mtod
argument_list|(
name|con
operator|->
name|rx_pkt
argument_list|,
name|ng_l2cap_hdr_t
operator|*
argument_list|)
expr_stmt|;
name|hdr
operator|->
name|length
operator|=
name|le16toh
argument_list|(
name|hdr
operator|->
name|length
argument_list|)
expr_stmt|;
name|hdr
operator|->
name|dcid
operator|=
name|le16toh
argument_list|(
name|hdr
operator|->
name|dcid
argument_list|)
expr_stmt|;
comment|/* Check payload size */
if|if
condition|(
name|hdr
operator|->
name|length
operator|!=
name|con
operator|->
name|rx_pkt
operator|->
name|m_pkthdr
operator|.
name|len
operator|-
sizeof|sizeof
argument_list|(
operator|*
name|hdr
argument_list|)
condition|)
block|{
name|NG_L2CAP_ERR
argument_list|(
literal|"%s: %s - invalid L2CAP packet. Payload length mismatch, length=%d, len=%zd\n"
argument_list|,
name|__func__
argument_list|,
name|NG_NODE_NAME
argument_list|(
name|l2cap
operator|->
name|node
argument_list|)
argument_list|,
name|hdr
operator|->
name|length
argument_list|,
name|con
operator|->
name|rx_pkt
operator|->
name|m_pkthdr
operator|.
name|len
operator|-
sizeof|sizeof
argument_list|(
operator|*
name|hdr
argument_list|)
argument_list|)
expr_stmt|;
name|error
operator|=
name|EMSGSIZE
expr_stmt|;
goto|goto
name|drop
goto|;
block|}
comment|/* Process packet */
switch|switch
condition|(
name|hdr
operator|->
name|dcid
condition|)
block|{
case|case
name|NG_L2CAP_SIGNAL_CID
case|:
comment|/* L2CAP command */
name|m_adj
argument_list|(
name|con
operator|->
name|rx_pkt
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|hdr
argument_list|)
argument_list|)
expr_stmt|;
name|error
operator|=
name|ng_l2cap_process_signal_cmd
argument_list|(
name|con
argument_list|)
expr_stmt|;
break|break;
case|case
name|NG_L2CAP_CLT_CID
case|:
comment|/* Connectionless packet */
name|error
operator|=
name|ng_l2cap_l2ca_clt_receive
argument_list|(
name|con
argument_list|)
expr_stmt|;
break|break;
default|default:
comment|/* Data packet */
name|error
operator|=
name|ng_l2cap_l2ca_receive
argument_list|(
name|con
argument_list|)
expr_stmt|;
break|break;
block|}
return|return
operator|(
name|error
operator|)
return|;
name|drop
label|:
name|NG_FREE_M
argument_list|(
name|con
operator|->
name|rx_pkt
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
end_function

begin_comment
comment|/* ng_l2cap_receive */
end_comment

begin_comment
comment|/*  * Process L2CAP signaling command. We already know that destination channel ID  * is 0x1 that means we have received signaling command from peer's L2CAP layer.  * So get command header, decode and process it.  *  * XXX do we need to check signaling MTU here?  */
end_comment

begin_function
specifier|static
name|int
name|ng_l2cap_process_signal_cmd
parameter_list|(
name|ng_l2cap_con_p
name|con
parameter_list|)
block|{
name|ng_l2cap_p
name|l2cap
init|=
name|con
operator|->
name|l2cap
decl_stmt|;
name|ng_l2cap_cmd_hdr_t
modifier|*
name|hdr
init|=
name|NULL
decl_stmt|;
name|struct
name|mbuf
modifier|*
name|m
init|=
name|NULL
decl_stmt|;
while|while
condition|(
name|con
operator|->
name|rx_pkt
operator|!=
name|NULL
condition|)
block|{
comment|/* Verify packet length */
if|if
condition|(
name|con
operator|->
name|rx_pkt
operator|->
name|m_pkthdr
operator|.
name|len
operator|<
sizeof|sizeof
argument_list|(
operator|*
name|hdr
argument_list|)
condition|)
block|{
name|NG_L2CAP_ERR
argument_list|(
literal|"%s: %s - invalid L2CAP signaling command. Packet too small, len=%d\n"
argument_list|,
name|__func__
argument_list|,
name|NG_NODE_NAME
argument_list|(
name|l2cap
operator|->
name|node
argument_list|)
argument_list|,
name|con
operator|->
name|rx_pkt
operator|->
name|m_pkthdr
operator|.
name|len
argument_list|)
expr_stmt|;
name|NG_FREE_M
argument_list|(
name|con
operator|->
name|rx_pkt
argument_list|)
expr_stmt|;
return|return
operator|(
name|EMSGSIZE
operator|)
return|;
block|}
comment|/* Get signaling command */
name|NG_L2CAP_M_PULLUP
argument_list|(
name|con
operator|->
name|rx_pkt
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|hdr
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|con
operator|->
name|rx_pkt
operator|==
name|NULL
condition|)
return|return
operator|(
name|ENOBUFS
operator|)
return|;
name|hdr
operator|=
name|mtod
argument_list|(
name|con
operator|->
name|rx_pkt
argument_list|,
name|ng_l2cap_cmd_hdr_t
operator|*
argument_list|)
expr_stmt|;
name|hdr
operator|->
name|length
operator|=
name|le16toh
argument_list|(
name|hdr
operator|->
name|length
argument_list|)
expr_stmt|;
name|m_adj
argument_list|(
name|con
operator|->
name|rx_pkt
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|hdr
argument_list|)
argument_list|)
expr_stmt|;
comment|/* Verify command length */
if|if
condition|(
name|con
operator|->
name|rx_pkt
operator|->
name|m_pkthdr
operator|.
name|len
operator|<
name|hdr
operator|->
name|length
condition|)
block|{
name|NG_L2CAP_ERR
argument_list|(
literal|"%s: %s - invalid L2CAP signaling command, code=%#x, ident=%d. "
expr|\
literal|"Invalid command length=%d, m_pkthdr.len=%d\n"
argument_list|,
name|__func__
argument_list|,
name|NG_NODE_NAME
argument_list|(
name|l2cap
operator|->
name|node
argument_list|)
argument_list|,
name|hdr
operator|->
name|code
argument_list|,
name|hdr
operator|->
name|ident
argument_list|,
name|hdr
operator|->
name|length
argument_list|,
name|con
operator|->
name|rx_pkt
operator|->
name|m_pkthdr
operator|.
name|len
argument_list|)
expr_stmt|;
name|NG_FREE_M
argument_list|(
name|con
operator|->
name|rx_pkt
argument_list|)
expr_stmt|;
return|return
operator|(
name|EMSGSIZE
operator|)
return|;
block|}
comment|/* Get the command, save the rest (if any) */
if|if
condition|(
name|con
operator|->
name|rx_pkt
operator|->
name|m_pkthdr
operator|.
name|len
operator|>
name|hdr
operator|->
name|length
condition|)
name|m
operator|=
name|m_split
argument_list|(
name|con
operator|->
name|rx_pkt
argument_list|,
name|hdr
operator|->
name|length
argument_list|,
name|M_DONTWAIT
argument_list|)
expr_stmt|;
else|else
name|m
operator|=
name|NULL
expr_stmt|;
comment|/* Process command */
switch|switch
condition|(
name|hdr
operator|->
name|code
condition|)
block|{
case|case
name|NG_L2CAP_CMD_REJ
case|:
name|ng_l2cap_process_cmd_rej
argument_list|(
name|con
argument_list|,
name|hdr
operator|->
name|ident
argument_list|)
expr_stmt|;
break|break;
case|case
name|NG_L2CAP_CON_REQ
case|:
name|ng_l2cap_process_con_req
argument_list|(
name|con
argument_list|,
name|hdr
operator|->
name|ident
argument_list|)
expr_stmt|;
break|break;
case|case
name|NG_L2CAP_CON_RSP
case|:
name|ng_l2cap_process_con_rsp
argument_list|(
name|con
argument_list|,
name|hdr
operator|->
name|ident
argument_list|)
expr_stmt|;
break|break;
case|case
name|NG_L2CAP_CFG_REQ
case|:
name|ng_l2cap_process_cfg_req
argument_list|(
name|con
argument_list|,
name|hdr
operator|->
name|ident
argument_list|)
expr_stmt|;
break|break;
case|case
name|NG_L2CAP_CFG_RSP
case|:
name|ng_l2cap_process_cfg_rsp
argument_list|(
name|con
argument_list|,
name|hdr
operator|->
name|ident
argument_list|)
expr_stmt|;
break|break;
case|case
name|NG_L2CAP_DISCON_REQ
case|:
name|ng_l2cap_process_discon_req
argument_list|(
name|con
argument_list|,
name|hdr
operator|->
name|ident
argument_list|)
expr_stmt|;
break|break;
case|case
name|NG_L2CAP_DISCON_RSP
case|:
name|ng_l2cap_process_discon_rsp
argument_list|(
name|con
argument_list|,
name|hdr
operator|->
name|ident
argument_list|)
expr_stmt|;
break|break;
case|case
name|NG_L2CAP_ECHO_REQ
case|:
name|ng_l2cap_process_echo_req
argument_list|(
name|con
argument_list|,
name|hdr
operator|->
name|ident
argument_list|)
expr_stmt|;
break|break;
case|case
name|NG_L2CAP_ECHO_RSP
case|:
name|ng_l2cap_process_echo_rsp
argument_list|(
name|con
argument_list|,
name|hdr
operator|->
name|ident
argument_list|)
expr_stmt|;
break|break;
case|case
name|NG_L2CAP_INFO_REQ
case|:
name|ng_l2cap_process_info_req
argument_list|(
name|con
argument_list|,
name|hdr
operator|->
name|ident
argument_list|)
expr_stmt|;
break|break;
case|case
name|NG_L2CAP_INFO_RSP
case|:
name|ng_l2cap_process_info_rsp
argument_list|(
name|con
argument_list|,
name|hdr
operator|->
name|ident
argument_list|)
expr_stmt|;
break|break;
default|default:
name|NG_L2CAP_ERR
argument_list|(
literal|"%s: %s - unknown L2CAP signaling command, code=%#x, ident=%d, length=%d\n"
argument_list|,
name|__func__
argument_list|,
name|NG_NODE_NAME
argument_list|(
name|l2cap
operator|->
name|node
argument_list|)
argument_list|,
name|hdr
operator|->
name|code
argument_list|,
name|hdr
operator|->
name|ident
argument_list|,
name|hdr
operator|->
name|length
argument_list|)
expr_stmt|;
comment|/* 			 * Send L2CAP_CommandRej. Do not really care  			 * about the result 			 */
name|send_l2cap_reject
argument_list|(
name|con
argument_list|,
name|hdr
operator|->
name|ident
argument_list|,
name|NG_L2CAP_REJ_NOT_UNDERSTOOD
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|NG_FREE_M
argument_list|(
name|con
operator|->
name|rx_pkt
argument_list|)
expr_stmt|;
break|break;
block|}
name|con
operator|->
name|rx_pkt
operator|=
name|m
expr_stmt|;
block|}
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_comment
comment|/* ng_l2cap_process_signal_cmd */
end_comment

begin_comment
comment|/*  * Process L2CAP_CommandRej command  */
end_comment

begin_function
specifier|static
name|int
name|ng_l2cap_process_cmd_rej
parameter_list|(
name|ng_l2cap_con_p
name|con
parameter_list|,
name|u_int8_t
name|ident
parameter_list|)
block|{
name|ng_l2cap_p
name|l2cap
init|=
name|con
operator|->
name|l2cap
decl_stmt|;
name|ng_l2cap_cmd_rej_cp
modifier|*
name|cp
init|=
name|NULL
decl_stmt|;
name|ng_l2cap_cmd_p
name|cmd
init|=
name|NULL
decl_stmt|;
comment|/* Get command parameters */
name|NG_L2CAP_M_PULLUP
argument_list|(
name|con
operator|->
name|rx_pkt
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|cp
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|con
operator|->
name|rx_pkt
operator|==
name|NULL
condition|)
return|return
operator|(
name|ENOBUFS
operator|)
return|;
name|cp
operator|=
name|mtod
argument_list|(
name|con
operator|->
name|rx_pkt
argument_list|,
name|ng_l2cap_cmd_rej_cp
operator|*
argument_list|)
expr_stmt|;
name|cp
operator|->
name|reason
operator|=
name|le16toh
argument_list|(
name|cp
operator|->
name|reason
argument_list|)
expr_stmt|;
comment|/* Check if we have pending command descriptor */
name|cmd
operator|=
name|ng_l2cap_cmd_by_ident
argument_list|(
name|con
argument_list|,
name|ident
argument_list|)
expr_stmt|;
if|if
condition|(
name|cmd
operator|!=
name|NULL
condition|)
block|{
comment|/* If command timeout already happened then ignore reject */
if|if
condition|(
name|ng_l2cap_command_untimeout
argument_list|(
name|cmd
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|NG_FREE_M
argument_list|(
name|con
operator|->
name|rx_pkt
argument_list|)
expr_stmt|;
return|return
operator|(
name|ETIMEDOUT
operator|)
return|;
block|}
name|ng_l2cap_unlink_cmd
argument_list|(
name|cmd
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|cmd
operator|->
name|code
condition|)
block|{
case|case
name|NG_L2CAP_CON_REQ
case|:
name|ng_l2cap_l2ca_con_rsp
argument_list|(
name|cmd
operator|->
name|ch
argument_list|,
name|cmd
operator|->
name|token
argument_list|,
name|cp
operator|->
name|reason
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|ng_l2cap_free_chan
argument_list|(
name|cmd
operator|->
name|ch
argument_list|)
expr_stmt|;
break|break;
case|case
name|NG_L2CAP_CFG_REQ
case|:
name|ng_l2cap_l2ca_cfg_rsp
argument_list|(
name|cmd
operator|->
name|ch
argument_list|,
name|cmd
operator|->
name|token
argument_list|,
name|cp
operator|->
name|reason
argument_list|)
expr_stmt|;
break|break;
case|case
name|NG_L2CAP_DISCON_REQ
case|:
name|ng_l2cap_l2ca_discon_rsp
argument_list|(
name|cmd
operator|->
name|ch
argument_list|,
name|cmd
operator|->
name|token
argument_list|,
name|cp
operator|->
name|reason
argument_list|)
expr_stmt|;
name|ng_l2cap_free_chan
argument_list|(
name|cmd
operator|->
name|ch
argument_list|)
expr_stmt|;
comment|/* XXX free channel */
break|break;
case|case
name|NG_L2CAP_ECHO_REQ
case|:
name|ng_l2cap_l2ca_ping_rsp
argument_list|(
name|cmd
operator|->
name|con
argument_list|,
name|cmd
operator|->
name|token
argument_list|,
name|cp
operator|->
name|reason
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
break|break;
case|case
name|NG_L2CAP_INFO_REQ
case|:
name|ng_l2cap_l2ca_get_info_rsp
argument_list|(
name|cmd
operator|->
name|con
argument_list|,
name|cmd
operator|->
name|token
argument_list|,
name|cp
operator|->
name|reason
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
break|break;
default|default:
name|NG_L2CAP_ALERT
argument_list|(
literal|"%s: %s - unexpected L2CAP_CommandRej. Unexpected L2CAP command opcode=%d\n"
argument_list|,
name|__func__
argument_list|,
name|NG_NODE_NAME
argument_list|(
name|l2cap
operator|->
name|node
argument_list|)
argument_list|,
name|cmd
operator|->
name|code
argument_list|)
expr_stmt|;
break|break;
block|}
name|ng_l2cap_free_cmd
argument_list|(
name|cmd
argument_list|)
expr_stmt|;
block|}
else|else
name|NG_L2CAP_ERR
argument_list|(
literal|"%s: %s - unexpected L2CAP_CommandRej command. "
expr|\
literal|"Requested ident does not exist, ident=%d\n"
argument_list|,
name|__func__
argument_list|,
name|NG_NODE_NAME
argument_list|(
name|l2cap
operator|->
name|node
argument_list|)
argument_list|,
name|ident
argument_list|)
expr_stmt|;
name|NG_FREE_M
argument_list|(
name|con
operator|->
name|rx_pkt
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_comment
comment|/* ng_l2cap_process_cmd_rej */
end_comment

begin_comment
comment|/*  * Process L2CAP_ConnectReq command  */
end_comment

begin_function
specifier|static
name|int
name|ng_l2cap_process_con_req
parameter_list|(
name|ng_l2cap_con_p
name|con
parameter_list|,
name|u_int8_t
name|ident
parameter_list|)
block|{
name|ng_l2cap_p
name|l2cap
init|=
name|con
operator|->
name|l2cap
decl_stmt|;
name|struct
name|mbuf
modifier|*
name|m
init|=
name|con
operator|->
name|rx_pkt
decl_stmt|;
name|ng_l2cap_con_req_cp
modifier|*
name|cp
init|=
name|NULL
decl_stmt|;
name|ng_l2cap_chan_p
name|ch
init|=
name|NULL
decl_stmt|;
name|int
name|error
init|=
literal|0
decl_stmt|;
name|u_int16_t
name|dcid
decl_stmt|,
name|psm
decl_stmt|;
comment|/* Get command parameters */
name|NG_L2CAP_M_PULLUP
argument_list|(
name|m
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|cp
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|m
operator|==
name|NULL
condition|)
return|return
operator|(
name|ENOBUFS
operator|)
return|;
name|cp
operator|=
name|mtod
argument_list|(
name|m
argument_list|,
name|ng_l2cap_con_req_cp
operator|*
argument_list|)
expr_stmt|;
name|psm
operator|=
name|le16toh
argument_list|(
name|cp
operator|->
name|psm
argument_list|)
expr_stmt|;
name|dcid
operator|=
name|le16toh
argument_list|(
name|cp
operator|->
name|scid
argument_list|)
expr_stmt|;
name|NG_FREE_M
argument_list|(
name|m
argument_list|)
expr_stmt|;
name|con
operator|->
name|rx_pkt
operator|=
name|NULL
expr_stmt|;
comment|/* 	 * Create new channel and send L2CA_ConnectInd notification  	 * to the upper layer protocol. 	 */
name|ch
operator|=
name|ng_l2cap_new_chan
argument_list|(
name|l2cap
argument_list|,
name|con
argument_list|,
name|psm
argument_list|)
expr_stmt|;
if|if
condition|(
name|ch
operator|==
name|NULL
condition|)
return|return
operator|(
name|send_l2cap_con_rej
argument_list|(
name|con
argument_list|,
name|ident
argument_list|,
literal|0
argument_list|,
name|dcid
argument_list|,
name|NG_L2CAP_NO_RESOURCES
argument_list|)
operator|)
return|;
comment|/* Update channel IDs */
name|ch
operator|->
name|dcid
operator|=
name|dcid
expr_stmt|;
comment|/* Sent L2CA_ConnectInd notification to the upper layer */
name|ch
operator|->
name|ident
operator|=
name|ident
expr_stmt|;
name|ch
operator|->
name|state
operator|=
name|NG_L2CAP_W4_L2CA_CON_RSP
expr_stmt|;
name|error
operator|=
name|ng_l2cap_l2ca_con_ind
argument_list|(
name|ch
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|!=
literal|0
condition|)
block|{
name|send_l2cap_con_rej
argument_list|(
name|con
argument_list|,
name|ident
argument_list|,
name|ch
operator|->
name|scid
argument_list|,
name|dcid
argument_list|,
operator|(
name|error
operator|==
name|ENOMEM
operator|)
condition|?
name|NG_L2CAP_NO_RESOURCES
else|:
name|NG_L2CAP_PSM_NOT_SUPPORTED
argument_list|)
expr_stmt|;
name|ng_l2cap_free_chan
argument_list|(
name|ch
argument_list|)
expr_stmt|;
block|}
return|return
operator|(
name|error
operator|)
return|;
block|}
end_function

begin_comment
comment|/* ng_l2cap_process_con_req */
end_comment

begin_comment
comment|/*  * Process L2CAP_ConnectRsp command  */
end_comment

begin_function
specifier|static
name|int
name|ng_l2cap_process_con_rsp
parameter_list|(
name|ng_l2cap_con_p
name|con
parameter_list|,
name|u_int8_t
name|ident
parameter_list|)
block|{
name|ng_l2cap_p
name|l2cap
init|=
name|con
operator|->
name|l2cap
decl_stmt|;
name|struct
name|mbuf
modifier|*
name|m
init|=
name|con
operator|->
name|rx_pkt
decl_stmt|;
name|ng_l2cap_con_rsp_cp
modifier|*
name|cp
init|=
name|NULL
decl_stmt|;
name|ng_l2cap_cmd_p
name|cmd
init|=
name|NULL
decl_stmt|;
name|u_int16_t
name|scid
decl_stmt|,
name|dcid
decl_stmt|,
name|result
decl_stmt|,
name|status
decl_stmt|;
name|int
name|error
init|=
literal|0
decl_stmt|;
comment|/* Get command parameters */
name|NG_L2CAP_M_PULLUP
argument_list|(
name|m
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|cp
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|m
operator|==
name|NULL
condition|)
return|return
operator|(
name|ENOBUFS
operator|)
return|;
name|cp
operator|=
name|mtod
argument_list|(
name|m
argument_list|,
name|ng_l2cap_con_rsp_cp
operator|*
argument_list|)
expr_stmt|;
name|dcid
operator|=
name|le16toh
argument_list|(
name|cp
operator|->
name|dcid
argument_list|)
expr_stmt|;
name|scid
operator|=
name|le16toh
argument_list|(
name|cp
operator|->
name|scid
argument_list|)
expr_stmt|;
name|result
operator|=
name|le16toh
argument_list|(
name|cp
operator|->
name|result
argument_list|)
expr_stmt|;
name|status
operator|=
name|le16toh
argument_list|(
name|cp
operator|->
name|status
argument_list|)
expr_stmt|;
name|NG_FREE_M
argument_list|(
name|m
argument_list|)
expr_stmt|;
name|con
operator|->
name|rx_pkt
operator|=
name|NULL
expr_stmt|;
comment|/* Check if we have pending command descriptor */
name|cmd
operator|=
name|ng_l2cap_cmd_by_ident
argument_list|(
name|con
argument_list|,
name|ident
argument_list|)
expr_stmt|;
if|if
condition|(
name|cmd
operator|==
name|NULL
condition|)
block|{
name|NG_L2CAP_ERR
argument_list|(
literal|"%s: %s - unexpected L2CAP_ConnectRsp command. ident=%d, con_handle=%d\n"
argument_list|,
name|__func__
argument_list|,
name|NG_NODE_NAME
argument_list|(
name|l2cap
operator|->
name|node
argument_list|)
argument_list|,
name|ident
argument_list|,
name|con
operator|->
name|con_handle
argument_list|)
expr_stmt|;
return|return
operator|(
name|ENOENT
operator|)
return|;
block|}
comment|/* Verify channel state, if invalid - do nothing */
if|if
condition|(
name|cmd
operator|->
name|ch
operator|->
name|state
operator|!=
name|NG_L2CAP_W4_L2CAP_CON_RSP
condition|)
block|{
name|NG_L2CAP_ERR
argument_list|(
literal|"%s: %s - unexpected L2CAP_ConnectRsp. "
expr|\
literal|"Invalid channel state, cid=%d, state=%d\n"
argument_list|,
name|__func__
argument_list|,
name|NG_NODE_NAME
argument_list|(
name|l2cap
operator|->
name|node
argument_list|)
argument_list|,
name|scid
argument_list|,
name|cmd
operator|->
name|ch
operator|->
name|state
argument_list|)
expr_stmt|;
goto|goto
name|reject
goto|;
block|}
comment|/* Verify CIDs and send reject if does not match */
if|if
condition|(
name|cmd
operator|->
name|ch
operator|->
name|scid
operator|!=
name|scid
condition|)
block|{
name|NG_L2CAP_ERR
argument_list|(
literal|"%s: %s - unexpected L2CAP_ConnectRsp. Channel IDs do not match, scid=%d(%d)\n"
argument_list|,
name|__func__
argument_list|,
name|NG_NODE_NAME
argument_list|(
name|l2cap
operator|->
name|node
argument_list|)
argument_list|,
name|cmd
operator|->
name|ch
operator|->
name|scid
argument_list|,
name|scid
argument_list|)
expr_stmt|;
goto|goto
name|reject
goto|;
block|}
comment|/* 	 * Looks good. We got confirmation from our peer. Now process 	 * it. First disable RTX timer. Then check the result and send  	 * notification to the upper layer. If command timeout already 	 * happened then ignore response. 	 */
if|if
condition|(
operator|(
name|error
operator|=
name|ng_l2cap_command_untimeout
argument_list|(
name|cmd
argument_list|)
operator|)
operator|!=
literal|0
condition|)
return|return
operator|(
name|error
operator|)
return|;
if|if
condition|(
name|result
operator|==
name|NG_L2CAP_PENDING
condition|)
block|{
comment|/* 		 * Our peer wants more time to complete connection. We shall  		 * start ERTX timer and wait. Keep command in the list. 		 */
name|cmd
operator|->
name|ch
operator|->
name|dcid
operator|=
name|dcid
expr_stmt|;
name|ng_l2cap_command_timeout
argument_list|(
name|cmd
argument_list|,
name|bluetooth_l2cap_ertx_timeout
argument_list|()
argument_list|)
expr_stmt|;
name|error
operator|=
name|ng_l2cap_l2ca_con_rsp
argument_list|(
name|cmd
operator|->
name|ch
argument_list|,
name|cmd
operator|->
name|token
argument_list|,
name|result
argument_list|,
name|status
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|!=
literal|0
condition|)
name|ng_l2cap_free_chan
argument_list|(
name|cmd
operator|->
name|ch
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|ng_l2cap_unlink_cmd
argument_list|(
name|cmd
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|==
name|NG_L2CAP_SUCCESS
condition|)
block|{
comment|/* 			 * Channel is open. Complete command and move to CONFIG 			 * state. Since we have sent positive confirmation we  			 * expect to receive L2CA_Config request from the upper 			 * layer protocol. 			 */
name|cmd
operator|->
name|ch
operator|->
name|dcid
operator|=
name|dcid
expr_stmt|;
name|cmd
operator|->
name|ch
operator|->
name|state
operator|=
name|NG_L2CAP_CONFIG
expr_stmt|;
block|}
else|else
comment|/* There was an error, so close the channel */
name|NG_L2CAP_INFO
argument_list|(
literal|"%s: %s - failed to open L2CAP channel, result=%d, status=%d\n"
argument_list|,
name|__func__
argument_list|,
name|NG_NODE_NAME
argument_list|(
name|l2cap
operator|->
name|node
argument_list|)
argument_list|,
name|result
argument_list|,
name|status
argument_list|)
expr_stmt|;
name|error
operator|=
name|ng_l2cap_l2ca_con_rsp
argument_list|(
name|cmd
operator|->
name|ch
argument_list|,
name|cmd
operator|->
name|token
argument_list|,
name|result
argument_list|,
name|status
argument_list|)
expr_stmt|;
comment|/* XXX do we have to remove the channel on error? */
if|if
condition|(
name|error
operator|!=
literal|0
operator|||
name|result
operator|!=
name|NG_L2CAP_SUCCESS
condition|)
name|ng_l2cap_free_chan
argument_list|(
name|cmd
operator|->
name|ch
argument_list|)
expr_stmt|;
name|ng_l2cap_free_cmd
argument_list|(
name|cmd
argument_list|)
expr_stmt|;
block|}
return|return
operator|(
name|error
operator|)
return|;
name|reject
label|:
comment|/* Send reject. Do not really care about the result */
name|send_l2cap_reject
argument_list|(
name|con
argument_list|,
name|ident
argument_list|,
name|NG_L2CAP_REJ_INVALID_CID
argument_list|,
literal|0
argument_list|,
name|scid
argument_list|,
name|dcid
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_comment
comment|/* ng_l2cap_process_con_rsp */
end_comment

begin_comment
comment|/*  * Process L2CAP_ConfigReq command  */
end_comment

begin_function
specifier|static
name|int
name|ng_l2cap_process_cfg_req
parameter_list|(
name|ng_l2cap_con_p
name|con
parameter_list|,
name|u_int8_t
name|ident
parameter_list|)
block|{
name|ng_l2cap_p
name|l2cap
init|=
name|con
operator|->
name|l2cap
decl_stmt|;
name|struct
name|mbuf
modifier|*
name|m
init|=
name|con
operator|->
name|rx_pkt
decl_stmt|;
name|ng_l2cap_cfg_req_cp
modifier|*
name|cp
init|=
name|NULL
decl_stmt|;
name|ng_l2cap_chan_p
name|ch
init|=
name|NULL
decl_stmt|;
name|u_int16_t
name|dcid
decl_stmt|,
name|respond
decl_stmt|,
name|result
decl_stmt|;
name|ng_l2cap_cfg_opt_t
name|hdr
decl_stmt|;
name|ng_l2cap_cfg_opt_val_t
name|val
decl_stmt|;
name|int
name|off
decl_stmt|,
name|error
init|=
literal|0
decl_stmt|;
comment|/* Get command parameters */
name|con
operator|->
name|rx_pkt
operator|=
name|NULL
expr_stmt|;
name|NG_L2CAP_M_PULLUP
argument_list|(
name|m
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|cp
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|m
operator|==
name|NULL
condition|)
return|return
operator|(
name|ENOBUFS
operator|)
return|;
name|cp
operator|=
name|mtod
argument_list|(
name|m
argument_list|,
name|ng_l2cap_cfg_req_cp
operator|*
argument_list|)
expr_stmt|;
name|dcid
operator|=
name|le16toh
argument_list|(
name|cp
operator|->
name|dcid
argument_list|)
expr_stmt|;
name|respond
operator|=
name|NG_L2CAP_OPT_CFLAG
argument_list|(
name|le16toh
argument_list|(
name|cp
operator|->
name|flags
argument_list|)
argument_list|)
expr_stmt|;
name|m_adj
argument_list|(
name|m
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|cp
argument_list|)
argument_list|)
expr_stmt|;
comment|/* Check if we have this channel and it is in valid state */
name|ch
operator|=
name|ng_l2cap_chan_by_scid
argument_list|(
name|l2cap
argument_list|,
name|dcid
argument_list|)
expr_stmt|;
if|if
condition|(
name|ch
operator|==
name|NULL
condition|)
block|{
name|NG_L2CAP_ERR
argument_list|(
literal|"%s: %s - unexpected L2CAP_ConfigReq command. "
expr|\
literal|"Channel does not exist, cid=%d\n"
argument_list|,
name|__func__
argument_list|,
name|NG_NODE_NAME
argument_list|(
name|l2cap
operator|->
name|node
argument_list|)
argument_list|,
name|dcid
argument_list|)
expr_stmt|;
goto|goto
name|reject
goto|;
block|}
comment|/* Verify channel state */
if|if
condition|(
name|ch
operator|->
name|state
operator|!=
name|NG_L2CAP_CONFIG
operator|&&
name|ch
operator|->
name|state
operator|!=
name|NG_L2CAP_OPEN
condition|)
block|{
name|NG_L2CAP_ERR
argument_list|(
literal|"%s: %s - unexpected L2CAP_ConfigReq. "
expr|\
literal|"Invalid channel state, cid=%d, state=%d\n"
argument_list|,
name|__func__
argument_list|,
name|NG_NODE_NAME
argument_list|(
name|l2cap
operator|->
name|node
argument_list|)
argument_list|,
name|dcid
argument_list|,
name|ch
operator|->
name|state
argument_list|)
expr_stmt|;
goto|goto
name|reject
goto|;
block|}
if|if
condition|(
name|ch
operator|->
name|state
operator|==
name|NG_L2CAP_OPEN
condition|)
block|{
comment|/* Re-configuration */
name|ch
operator|->
name|cfg_state
operator|=
literal|0
expr_stmt|;
name|ch
operator|->
name|state
operator|=
name|NG_L2CAP_CONFIG
expr_stmt|;
block|}
for|for
control|(
name|result
operator|=
literal|0
operator|,
name|off
operator|=
literal|0
init|;
condition|;
control|)
block|{
name|error
operator|=
name|get_next_l2cap_opt
argument_list|(
name|m
argument_list|,
operator|&
name|off
argument_list|,
operator|&
name|hdr
argument_list|,
operator|&
name|val
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|==
literal|0
condition|)
block|{
comment|/* We done with this packet */
name|NG_FREE_M
argument_list|(
name|m
argument_list|)
expr_stmt|;
break|break;
block|}
elseif|else
if|if
condition|(
name|error
operator|>
literal|0
condition|)
block|{
comment|/* Got option */
switch|switch
condition|(
name|hdr
operator|.
name|type
condition|)
block|{
case|case
name|NG_L2CAP_OPT_MTU
case|:
name|ch
operator|->
name|omtu
operator|=
name|val
operator|.
name|mtu
expr_stmt|;
break|break;
case|case
name|NG_L2CAP_OPT_FLUSH_TIMO
case|:
name|ch
operator|->
name|flush_timo
operator|=
name|val
operator|.
name|flush_timo
expr_stmt|;
break|break;
case|case
name|NG_L2CAP_OPT_QOS
case|:
name|bcopy
argument_list|(
operator|&
name|val
operator|.
name|flow
argument_list|,
operator|&
name|ch
operator|->
name|iflow
argument_list|,
sizeof|sizeof
argument_list|(
name|ch
operator|->
name|iflow
argument_list|)
argument_list|)
expr_stmt|;
break|break;
default|default:
comment|/* Ignore unknown hint option */
break|break;
block|}
block|}
else|else
block|{
comment|/* Oops, something is wrong */
name|respond
operator|=
literal|1
expr_stmt|;
if|if
condition|(
name|error
operator|==
operator|-
literal|3
condition|)
block|{
comment|/* 				 * Adjust mbuf so we can get to the start 				 * of the first option we did not like. 				 */
name|m_adj
argument_list|(
name|m
argument_list|,
name|off
operator|-
sizeof|sizeof
argument_list|(
name|hdr
argument_list|)
argument_list|)
expr_stmt|;
name|m
operator|->
name|m_pkthdr
operator|.
name|len
operator|=
sizeof|sizeof
argument_list|(
name|hdr
argument_list|)
operator|+
name|hdr
operator|.
name|length
expr_stmt|;
name|result
operator|=
name|NG_L2CAP_UNKNOWN_OPTION
expr_stmt|;
block|}
else|else
block|{
comment|/* XXX FIXME Send other reject codes? */
name|NG_FREE_M
argument_list|(
name|m
argument_list|)
expr_stmt|;
name|result
operator|=
name|NG_L2CAP_REJECT
expr_stmt|;
block|}
break|break;
block|}
block|}
comment|/* 	 * Now check and see if we have to respond. If everything was OK then  	 * respond contain "C flag" and (if set) we will respond with empty  	 * packet and will wait for more options.  	 *  	 * Other case is that we did not like peer's options and will respond  	 * with L2CAP_Config response command with Reject error code.  	 *  	 * When "respond == 0" than we have received all options and we will  	 * sent L2CA_ConfigInd event to the upper layer protocol. 	 */
if|if
condition|(
name|respond
condition|)
block|{
name|error
operator|=
name|send_l2cap_cfg_rsp
argument_list|(
name|con
argument_list|,
name|ident
argument_list|,
name|ch
operator|->
name|dcid
argument_list|,
name|result
argument_list|,
name|m
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|!=
literal|0
condition|)
block|{
name|ng_l2cap_l2ca_discon_ind
argument_list|(
name|ch
argument_list|)
expr_stmt|;
name|ng_l2cap_free_chan
argument_list|(
name|ch
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
comment|/* Send L2CA_ConfigInd event to the upper layer protocol */
name|ch
operator|->
name|ident
operator|=
name|ident
expr_stmt|;
name|error
operator|=
name|ng_l2cap_l2ca_cfg_ind
argument_list|(
name|ch
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|!=
literal|0
condition|)
name|ng_l2cap_free_chan
argument_list|(
name|ch
argument_list|)
expr_stmt|;
block|}
return|return
operator|(
name|error
operator|)
return|;
name|reject
label|:
comment|/* Send reject. Do not really care about the result */
name|NG_FREE_M
argument_list|(
name|m
argument_list|)
expr_stmt|;
name|send_l2cap_reject
argument_list|(
name|con
argument_list|,
name|ident
argument_list|,
name|NG_L2CAP_REJ_INVALID_CID
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
name|dcid
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_comment
comment|/* ng_l2cap_process_cfg_req */
end_comment

begin_comment
comment|/*  * Process L2CAP_ConfigRsp command  */
end_comment

begin_function
specifier|static
name|int
name|ng_l2cap_process_cfg_rsp
parameter_list|(
name|ng_l2cap_con_p
name|con
parameter_list|,
name|u_int8_t
name|ident
parameter_list|)
block|{
name|ng_l2cap_p
name|l2cap
init|=
name|con
operator|->
name|l2cap
decl_stmt|;
name|struct
name|mbuf
modifier|*
name|m
init|=
name|con
operator|->
name|rx_pkt
decl_stmt|;
name|ng_l2cap_cfg_rsp_cp
modifier|*
name|cp
init|=
name|NULL
decl_stmt|;
name|ng_l2cap_cmd_p
name|cmd
init|=
name|NULL
decl_stmt|;
name|u_int16_t
name|scid
decl_stmt|,
name|cflag
decl_stmt|,
name|result
decl_stmt|;
name|ng_l2cap_cfg_opt_t
name|hdr
decl_stmt|;
name|ng_l2cap_cfg_opt_val_t
name|val
decl_stmt|;
name|int
name|off
decl_stmt|,
name|error
init|=
literal|0
decl_stmt|;
comment|/* Get command parameters */
name|con
operator|->
name|rx_pkt
operator|=
name|NULL
expr_stmt|;
name|NG_L2CAP_M_PULLUP
argument_list|(
name|m
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|cp
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|m
operator|==
name|NULL
condition|)
return|return
operator|(
name|ENOBUFS
operator|)
return|;
name|cp
operator|=
name|mtod
argument_list|(
name|m
argument_list|,
name|ng_l2cap_cfg_rsp_cp
operator|*
argument_list|)
expr_stmt|;
name|scid
operator|=
name|le16toh
argument_list|(
name|cp
operator|->
name|scid
argument_list|)
expr_stmt|;
name|cflag
operator|=
name|NG_L2CAP_OPT_CFLAG
argument_list|(
name|le16toh
argument_list|(
name|cp
operator|->
name|flags
argument_list|)
argument_list|)
expr_stmt|;
name|result
operator|=
name|le16toh
argument_list|(
name|cp
operator|->
name|result
argument_list|)
expr_stmt|;
name|m_adj
argument_list|(
name|m
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|cp
argument_list|)
argument_list|)
expr_stmt|;
comment|/* Check if we have this command */
name|cmd
operator|=
name|ng_l2cap_cmd_by_ident
argument_list|(
name|con
argument_list|,
name|ident
argument_list|)
expr_stmt|;
if|if
condition|(
name|cmd
operator|==
name|NULL
condition|)
block|{
name|NG_L2CAP_ERR
argument_list|(
literal|"%s: %s - unexpected L2CAP_ConfigRsp command. ident=%d, con_handle=%d\n"
argument_list|,
name|__func__
argument_list|,
name|NG_NODE_NAME
argument_list|(
name|l2cap
operator|->
name|node
argument_list|)
argument_list|,
name|ident
argument_list|,
name|con
operator|->
name|con_handle
argument_list|)
expr_stmt|;
name|NG_FREE_M
argument_list|(
name|m
argument_list|)
expr_stmt|;
return|return
operator|(
name|ENOENT
operator|)
return|;
block|}
comment|/* Verify CIDs and send reject if does not match */
if|if
condition|(
name|cmd
operator|->
name|ch
operator|->
name|scid
operator|!=
name|scid
condition|)
block|{
name|NG_L2CAP_ERR
argument_list|(
literal|"%s: %s - unexpected L2CAP_ConfigRsp. "
expr|\
literal|"Channel ID does not match, scid=%d(%d)\n"
argument_list|,
name|__func__
argument_list|,
name|NG_NODE_NAME
argument_list|(
name|l2cap
operator|->
name|node
argument_list|)
argument_list|,
name|cmd
operator|->
name|ch
operator|->
name|scid
argument_list|,
name|scid
argument_list|)
expr_stmt|;
goto|goto
name|reject
goto|;
block|}
comment|/* Verify channel state and reject if invalid */
if|if
condition|(
name|cmd
operator|->
name|ch
operator|->
name|state
operator|!=
name|NG_L2CAP_CONFIG
condition|)
block|{
name|NG_L2CAP_ERR
argument_list|(
literal|"%s: %s - unexpected L2CAP_ConfigRsp. "
expr|\
literal|"Invalid channel state, scid=%d, state=%d\n"
argument_list|,
name|__func__
argument_list|,
name|NG_NODE_NAME
argument_list|(
name|l2cap
operator|->
name|node
argument_list|)
argument_list|,
name|cmd
operator|->
name|ch
operator|->
name|scid
argument_list|,
name|cmd
operator|->
name|ch
operator|->
name|state
argument_list|)
expr_stmt|;
goto|goto
name|reject
goto|;
block|}
comment|/* 	 * Looks like it is our response, so process it. First parse options, 	 * then verify C flag. If it is set then we shall expect more  	 * configuration options from the peer and we will wait. Otherwise we  	 * have received all options and we will send L2CA_ConfigRsp event to 	 * the upper layer protocol. If command timeout already happened then 	 * ignore response. 	 */
if|if
condition|(
operator|(
name|error
operator|=
name|ng_l2cap_command_untimeout
argument_list|(
name|cmd
argument_list|)
operator|)
operator|!=
literal|0
condition|)
block|{
name|NG_FREE_M
argument_list|(
name|m
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
for|for
control|(
name|off
operator|=
literal|0
init|;
condition|;
control|)
block|{
name|error
operator|=
name|get_next_l2cap_opt
argument_list|(
name|m
argument_list|,
operator|&
name|off
argument_list|,
operator|&
name|hdr
argument_list|,
operator|&
name|val
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|==
literal|0
condition|)
comment|/* We done with this packet */
break|break;
elseif|else
if|if
condition|(
name|error
operator|>
literal|0
condition|)
block|{
comment|/* Got option */
switch|switch
condition|(
name|hdr
operator|.
name|type
condition|)
block|{
case|case
name|NG_L2CAP_OPT_MTU
case|:
name|cmd
operator|->
name|ch
operator|->
name|imtu
operator|=
name|val
operator|.
name|mtu
expr_stmt|;
break|break;
case|case
name|NG_L2CAP_OPT_FLUSH_TIMO
case|:
name|cmd
operator|->
name|ch
operator|->
name|flush_timo
operator|=
name|val
operator|.
name|flush_timo
expr_stmt|;
break|break;
case|case
name|NG_L2CAP_OPT_QOS
case|:
name|bcopy
argument_list|(
operator|&
name|val
operator|.
name|flow
argument_list|,
operator|&
name|cmd
operator|->
name|ch
operator|->
name|oflow
argument_list|,
sizeof|sizeof
argument_list|(
name|cmd
operator|->
name|ch
operator|->
name|oflow
argument_list|)
argument_list|)
expr_stmt|;
break|break;
default|default:
comment|/* Ignore unknown hint option */
break|break;
block|}
block|}
else|else
block|{
comment|/* 			 * XXX FIXME What to do here? 			 * 			 * This is really BAD :( options packet was broken, or  			 * peer sent us option that we did not understand. Let  			 * upper layer know and do not wait for more options. 			 */
name|NG_L2CAP_ALERT
argument_list|(
literal|"%s: %s - failed to parse configuration options, error=%d\n"
argument_list|,
name|__func__
argument_list|,
name|NG_NODE_NAME
argument_list|(
name|l2cap
operator|->
name|node
argument_list|)
argument_list|,
name|error
argument_list|)
expr_stmt|;
name|result
operator|=
name|NG_L2CAP_UNKNOWN
expr_stmt|;
name|cflag
operator|=
literal|0
expr_stmt|;
break|break;
block|}
block|}
name|NG_FREE_M
argument_list|(
name|m
argument_list|)
expr_stmt|;
if|if
condition|(
name|cflag
condition|)
comment|/* Restart timer and wait for more options */
name|ng_l2cap_command_timeout
argument_list|(
name|cmd
argument_list|,
name|bluetooth_l2cap_rtx_timeout
argument_list|()
argument_list|)
expr_stmt|;
else|else
block|{
name|ng_l2cap_unlink_cmd
argument_list|(
name|cmd
argument_list|)
expr_stmt|;
comment|/* Send L2CA_Config response to the upper layer protocol */
name|error
operator|=
name|ng_l2cap_l2ca_cfg_rsp
argument_list|(
name|cmd
operator|->
name|ch
argument_list|,
name|cmd
operator|->
name|token
argument_list|,
name|result
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|!=
literal|0
condition|)
block|{
comment|/* 			 * XXX FIXME what to do here? we were not able to send 			 * response to the upper layer protocol, so for now  			 * just close the channel. Send L2CAP_Disconnect to  			 * remote peer? 			 */
name|NG_L2CAP_ERR
argument_list|(
literal|"%s: %s - failed to send L2CA_Config response, error=%d\n"
argument_list|,
name|__func__
argument_list|,
name|NG_NODE_NAME
argument_list|(
name|l2cap
operator|->
name|node
argument_list|)
argument_list|,
name|error
argument_list|)
expr_stmt|;
name|ng_l2cap_free_chan
argument_list|(
name|cmd
operator|->
name|ch
argument_list|)
expr_stmt|;
block|}
name|ng_l2cap_free_cmd
argument_list|(
name|cmd
argument_list|)
expr_stmt|;
block|}
return|return
operator|(
name|error
operator|)
return|;
name|reject
label|:
comment|/* Send reject. Do not really care about the result */
name|NG_FREE_M
argument_list|(
name|m
argument_list|)
expr_stmt|;
name|send_l2cap_reject
argument_list|(
name|con
argument_list|,
name|ident
argument_list|,
name|NG_L2CAP_REJ_INVALID_CID
argument_list|,
literal|0
argument_list|,
name|scid
argument_list|,
literal|0
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_comment
comment|/* ng_l2cap_process_cfg_rsp */
end_comment

begin_comment
comment|/*  * Process L2CAP_DisconnectReq command  */
end_comment

begin_function
specifier|static
name|int
name|ng_l2cap_process_discon_req
parameter_list|(
name|ng_l2cap_con_p
name|con
parameter_list|,
name|u_int8_t
name|ident
parameter_list|)
block|{
name|ng_l2cap_p
name|l2cap
init|=
name|con
operator|->
name|l2cap
decl_stmt|;
name|ng_l2cap_discon_req_cp
modifier|*
name|cp
init|=
name|NULL
decl_stmt|;
name|ng_l2cap_chan_p
name|ch
init|=
name|NULL
decl_stmt|;
name|ng_l2cap_cmd_p
name|cmd
init|=
name|NULL
decl_stmt|;
name|u_int16_t
name|scid
decl_stmt|,
name|dcid
decl_stmt|;
comment|/* Get command parameters */
name|NG_L2CAP_M_PULLUP
argument_list|(
name|con
operator|->
name|rx_pkt
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|cp
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|con
operator|->
name|rx_pkt
operator|==
name|NULL
condition|)
return|return
operator|(
name|ENOBUFS
operator|)
return|;
name|cp
operator|=
name|mtod
argument_list|(
name|con
operator|->
name|rx_pkt
argument_list|,
name|ng_l2cap_discon_req_cp
operator|*
argument_list|)
expr_stmt|;
name|dcid
operator|=
name|le16toh
argument_list|(
name|cp
operator|->
name|dcid
argument_list|)
expr_stmt|;
name|scid
operator|=
name|le16toh
argument_list|(
name|cp
operator|->
name|scid
argument_list|)
expr_stmt|;
name|NG_FREE_M
argument_list|(
name|con
operator|->
name|rx_pkt
argument_list|)
expr_stmt|;
comment|/* Check if we have this channel and it is in valid state */
name|ch
operator|=
name|ng_l2cap_chan_by_scid
argument_list|(
name|l2cap
argument_list|,
name|dcid
argument_list|)
expr_stmt|;
if|if
condition|(
name|ch
operator|==
name|NULL
condition|)
block|{
name|NG_L2CAP_ERR
argument_list|(
literal|"%s: %s - unexpected L2CAP_DisconnectReq message. "
expr|\
literal|"Channel does not exist, cid=%d\n"
argument_list|,
name|__func__
argument_list|,
name|NG_NODE_NAME
argument_list|(
name|l2cap
operator|->
name|node
argument_list|)
argument_list|,
name|dcid
argument_list|)
expr_stmt|;
goto|goto
name|reject
goto|;
block|}
comment|/* XXX Verify channel state and reject if invalid -- is that true? */
if|if
condition|(
name|ch
operator|->
name|state
operator|!=
name|NG_L2CAP_OPEN
operator|&&
name|ch
operator|->
name|state
operator|!=
name|NG_L2CAP_CONFIG
operator|&&
name|ch
operator|->
name|state
operator|!=
name|NG_L2CAP_W4_L2CAP_DISCON_RSP
condition|)
block|{
name|NG_L2CAP_ERR
argument_list|(
literal|"%s: %s - unexpected L2CAP_DisconnectReq. "
expr|\
literal|"Invalid channel state, cid=%d, state=%d\n"
argument_list|,
name|__func__
argument_list|,
name|NG_NODE_NAME
argument_list|(
name|l2cap
operator|->
name|node
argument_list|)
argument_list|,
name|dcid
argument_list|,
name|ch
operator|->
name|state
argument_list|)
expr_stmt|;
goto|goto
name|reject
goto|;
block|}
comment|/* Match destination channel ID */
if|if
condition|(
name|ch
operator|->
name|dcid
operator|!=
name|scid
operator|||
name|ch
operator|->
name|scid
operator|!=
name|dcid
condition|)
block|{
name|NG_L2CAP_ERR
argument_list|(
literal|"%s: %s - unexpected L2CAP_DisconnectReq. "
expr|\
literal|"Channel IDs does not match, channel: scid=%d, dcid=%d, "
expr|\
literal|"request: scid=%d, dcid=%d\n"
argument_list|,
name|__func__
argument_list|,
name|NG_NODE_NAME
argument_list|(
name|l2cap
operator|->
name|node
argument_list|)
argument_list|,
name|ch
operator|->
name|scid
argument_list|,
name|ch
operator|->
name|dcid
argument_list|,
name|scid
argument_list|,
name|dcid
argument_list|)
expr_stmt|;
goto|goto
name|reject
goto|;
block|}
comment|/* 	 * Looks good, so notify upper layer protocol that channel is about  	 * to be disconnected and send L2CA_DisconnectInd message. Then respond 	 * with L2CAP_DisconnectRsp. 	 */
if|if
condition|(
name|ch
operator|->
name|state
operator|!=
name|NG_L2CAP_W4_L2CAP_DISCON_RSP
condition|)
block|{
name|ng_l2cap_l2ca_discon_ind
argument_list|(
name|ch
argument_list|)
expr_stmt|;
comment|/* do not care about result */
name|ng_l2cap_free_chan
argument_list|(
name|ch
argument_list|)
expr_stmt|;
block|}
comment|/* Send L2CAP_DisconnectRsp */
name|cmd
operator|=
name|ng_l2cap_new_cmd
argument_list|(
name|con
argument_list|,
name|NULL
argument_list|,
name|ident
argument_list|,
name|NG_L2CAP_DISCON_RSP
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|cmd
operator|==
name|NULL
condition|)
return|return
operator|(
name|ENOMEM
operator|)
return|;
name|_ng_l2cap_discon_rsp
argument_list|(
name|cmd
operator|->
name|aux
argument_list|,
name|ident
argument_list|,
name|dcid
argument_list|,
name|scid
argument_list|)
expr_stmt|;
if|if
condition|(
name|cmd
operator|->
name|aux
operator|==
name|NULL
condition|)
block|{
name|ng_l2cap_free_cmd
argument_list|(
name|cmd
argument_list|)
expr_stmt|;
return|return
operator|(
name|ENOBUFS
operator|)
return|;
block|}
comment|/* Link command to the queue */
name|ng_l2cap_link_cmd
argument_list|(
name|con
argument_list|,
name|cmd
argument_list|)
expr_stmt|;
name|ng_l2cap_lp_deliver
argument_list|(
name|con
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
name|reject
label|:
comment|/* Send reject. Do not really care about the result */
name|send_l2cap_reject
argument_list|(
name|con
argument_list|,
name|ident
argument_list|,
name|NG_L2CAP_REJ_INVALID_CID
argument_list|,
literal|0
argument_list|,
name|scid
argument_list|,
name|dcid
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_comment
comment|/* ng_l2cap_process_discon_req */
end_comment

begin_comment
comment|/*  * Process L2CAP_DisconnectRsp command  */
end_comment

begin_function
specifier|static
name|int
name|ng_l2cap_process_discon_rsp
parameter_list|(
name|ng_l2cap_con_p
name|con
parameter_list|,
name|u_int8_t
name|ident
parameter_list|)
block|{
name|ng_l2cap_p
name|l2cap
init|=
name|con
operator|->
name|l2cap
decl_stmt|;
name|ng_l2cap_discon_rsp_cp
modifier|*
name|cp
init|=
name|NULL
decl_stmt|;
name|ng_l2cap_cmd_p
name|cmd
init|=
name|NULL
decl_stmt|;
name|u_int16_t
name|scid
decl_stmt|,
name|dcid
decl_stmt|;
name|int
name|error
init|=
literal|0
decl_stmt|;
comment|/* Get command parameters */
name|NG_L2CAP_M_PULLUP
argument_list|(
name|con
operator|->
name|rx_pkt
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|cp
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|con
operator|->
name|rx_pkt
operator|==
name|NULL
condition|)
return|return
operator|(
name|ENOBUFS
operator|)
return|;
name|cp
operator|=
name|mtod
argument_list|(
name|con
operator|->
name|rx_pkt
argument_list|,
name|ng_l2cap_discon_rsp_cp
operator|*
argument_list|)
expr_stmt|;
name|dcid
operator|=
name|le16toh
argument_list|(
name|cp
operator|->
name|dcid
argument_list|)
expr_stmt|;
name|scid
operator|=
name|le16toh
argument_list|(
name|cp
operator|->
name|scid
argument_list|)
expr_stmt|;
name|NG_FREE_M
argument_list|(
name|con
operator|->
name|rx_pkt
argument_list|)
expr_stmt|;
comment|/* Check if we have pending command descriptor */
name|cmd
operator|=
name|ng_l2cap_cmd_by_ident
argument_list|(
name|con
argument_list|,
name|ident
argument_list|)
expr_stmt|;
if|if
condition|(
name|cmd
operator|==
name|NULL
condition|)
block|{
name|NG_L2CAP_ERR
argument_list|(
literal|"%s: %s - unexpected L2CAP_DisconnectRsp command. ident=%d, con_handle=%d\n"
argument_list|,
name|__func__
argument_list|,
name|NG_NODE_NAME
argument_list|(
name|l2cap
operator|->
name|node
argument_list|)
argument_list|,
name|ident
argument_list|,
name|con
operator|->
name|con_handle
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
comment|/* Verify channel state, do nothing if invalid */
if|if
condition|(
name|cmd
operator|->
name|ch
operator|->
name|state
operator|!=
name|NG_L2CAP_W4_L2CAP_DISCON_RSP
condition|)
block|{
name|NG_L2CAP_ERR
argument_list|(
literal|"%s: %s - unexpected L2CAP_DisconnectRsp. "
expr|\
literal|"Invalid channel state, cid=%d, state=%d\n"
argument_list|,
name|__func__
argument_list|,
name|NG_NODE_NAME
argument_list|(
name|l2cap
operator|->
name|node
argument_list|)
argument_list|,
name|scid
argument_list|,
name|cmd
operator|->
name|ch
operator|->
name|state
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
comment|/* Verify CIDs and send reject if does not match */
if|if
condition|(
name|cmd
operator|->
name|ch
operator|->
name|scid
operator|!=
name|scid
operator|||
name|cmd
operator|->
name|ch
operator|->
name|dcid
operator|!=
name|dcid
condition|)
block|{
name|NG_L2CAP_ERR
argument_list|(
literal|"%s: %s - unexpected L2CAP_DisconnectRsp. "
expr|\
literal|"Channel IDs do not match, scid=%d(%d), dcid=%d(%d)\n"
argument_list|,
name|__func__
argument_list|,
name|NG_NODE_NAME
argument_list|(
name|l2cap
operator|->
name|node
argument_list|)
argument_list|,
name|cmd
operator|->
name|ch
operator|->
name|scid
argument_list|,
name|scid
argument_list|,
name|cmd
operator|->
name|ch
operator|->
name|dcid
argument_list|,
name|dcid
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
comment|/* 	 * Looks like we have successfuly disconnected channel, so notify  	 * upper layer. If command timeout already happened then ignore 	 * response. 	 */
if|if
condition|(
operator|(
name|error
operator|=
name|ng_l2cap_command_untimeout
argument_list|(
name|cmd
argument_list|)
operator|)
operator|!=
literal|0
condition|)
goto|goto
name|out
goto|;
name|error
operator|=
name|ng_l2cap_l2ca_discon_rsp
argument_list|(
name|cmd
operator|->
name|ch
argument_list|,
name|cmd
operator|->
name|token
argument_list|,
name|NG_L2CAP_SUCCESS
argument_list|)
expr_stmt|;
name|ng_l2cap_free_chan
argument_list|(
name|cmd
operator|->
name|ch
argument_list|)
expr_stmt|;
comment|/* this will free commands too */
name|out
label|:
return|return
operator|(
name|error
operator|)
return|;
block|}
end_function

begin_comment
comment|/* ng_l2cap_process_discon_rsp */
end_comment

begin_comment
comment|/*  * Process L2CAP_EchoReq command  */
end_comment

begin_function
specifier|static
name|int
name|ng_l2cap_process_echo_req
parameter_list|(
name|ng_l2cap_con_p
name|con
parameter_list|,
name|u_int8_t
name|ident
parameter_list|)
block|{
name|ng_l2cap_p
name|l2cap
init|=
name|con
operator|->
name|l2cap
decl_stmt|;
name|ng_l2cap_cmd_hdr_t
modifier|*
name|hdr
init|=
name|NULL
decl_stmt|;
name|ng_l2cap_cmd_p
name|cmd
init|=
name|NULL
decl_stmt|;
name|con
operator|->
name|rx_pkt
operator|=
name|ng_l2cap_prepend
argument_list|(
name|con
operator|->
name|rx_pkt
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|hdr
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|con
operator|->
name|rx_pkt
operator|==
name|NULL
condition|)
block|{
name|NG_L2CAP_ALERT
argument_list|(
literal|"%s: %s - ng_l2cap_prepend() failed, size=%zd\n"
argument_list|,
name|__func__
argument_list|,
name|NG_NODE_NAME
argument_list|(
name|l2cap
operator|->
name|node
argument_list|)
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|hdr
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|(
name|ENOBUFS
operator|)
return|;
block|}
name|hdr
operator|=
name|mtod
argument_list|(
name|con
operator|->
name|rx_pkt
argument_list|,
name|ng_l2cap_cmd_hdr_t
operator|*
argument_list|)
expr_stmt|;
name|hdr
operator|->
name|code
operator|=
name|NG_L2CAP_ECHO_RSP
expr_stmt|;
name|hdr
operator|->
name|ident
operator|=
name|ident
expr_stmt|;
name|hdr
operator|->
name|length
operator|=
name|htole16
argument_list|(
name|con
operator|->
name|rx_pkt
operator|->
name|m_pkthdr
operator|.
name|len
operator|-
sizeof|sizeof
argument_list|(
operator|*
name|hdr
argument_list|)
argument_list|)
expr_stmt|;
name|cmd
operator|=
name|ng_l2cap_new_cmd
argument_list|(
name|con
argument_list|,
name|NULL
argument_list|,
name|ident
argument_list|,
name|NG_L2CAP_ECHO_RSP
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|cmd
operator|==
name|NULL
condition|)
block|{
name|NG_FREE_M
argument_list|(
name|con
operator|->
name|rx_pkt
argument_list|)
expr_stmt|;
return|return
operator|(
name|ENOBUFS
operator|)
return|;
block|}
comment|/* Attach data and link command to the queue */
name|cmd
operator|->
name|aux
operator|=
name|con
operator|->
name|rx_pkt
expr_stmt|;
name|con
operator|->
name|rx_pkt
operator|=
name|NULL
expr_stmt|;
name|ng_l2cap_link_cmd
argument_list|(
name|con
argument_list|,
name|cmd
argument_list|)
expr_stmt|;
name|ng_l2cap_lp_deliver
argument_list|(
name|con
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_comment
comment|/* ng_l2cap_process_echo_req */
end_comment

begin_comment
comment|/*  * Process L2CAP_EchoRsp command  */
end_comment

begin_function
specifier|static
name|int
name|ng_l2cap_process_echo_rsp
parameter_list|(
name|ng_l2cap_con_p
name|con
parameter_list|,
name|u_int8_t
name|ident
parameter_list|)
block|{
name|ng_l2cap_p
name|l2cap
init|=
name|con
operator|->
name|l2cap
decl_stmt|;
name|ng_l2cap_cmd_p
name|cmd
init|=
name|NULL
decl_stmt|;
name|int
name|error
init|=
literal|0
decl_stmt|;
comment|/* Check if we have this command */
name|cmd
operator|=
name|ng_l2cap_cmd_by_ident
argument_list|(
name|con
argument_list|,
name|ident
argument_list|)
expr_stmt|;
if|if
condition|(
name|cmd
operator|!=
name|NULL
condition|)
block|{
comment|/* If command timeout already happened then ignore response */
if|if
condition|(
operator|(
name|error
operator|=
name|ng_l2cap_command_untimeout
argument_list|(
name|cmd
argument_list|)
operator|)
operator|!=
literal|0
condition|)
block|{
name|NG_FREE_M
argument_list|(
name|con
operator|->
name|rx_pkt
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
name|ng_l2cap_unlink_cmd
argument_list|(
name|cmd
argument_list|)
expr_stmt|;
name|error
operator|=
name|ng_l2cap_l2ca_ping_rsp
argument_list|(
name|cmd
operator|->
name|con
argument_list|,
name|cmd
operator|->
name|token
argument_list|,
name|NG_L2CAP_SUCCESS
argument_list|,
name|con
operator|->
name|rx_pkt
argument_list|)
expr_stmt|;
name|ng_l2cap_free_cmd
argument_list|(
name|cmd
argument_list|)
expr_stmt|;
name|con
operator|->
name|rx_pkt
operator|=
name|NULL
expr_stmt|;
block|}
else|else
block|{
name|NG_L2CAP_ERR
argument_list|(
literal|"%s: %s - unexpected L2CAP_EchoRsp command. "
expr|\
literal|"Requested ident does not exist, ident=%d\n"
argument_list|,
name|__func__
argument_list|,
name|NG_NODE_NAME
argument_list|(
name|l2cap
operator|->
name|node
argument_list|)
argument_list|,
name|ident
argument_list|)
expr_stmt|;
name|NG_FREE_M
argument_list|(
name|con
operator|->
name|rx_pkt
argument_list|)
expr_stmt|;
block|}
return|return
operator|(
name|error
operator|)
return|;
block|}
end_function

begin_comment
comment|/* ng_l2cap_process_echo_rsp */
end_comment

begin_comment
comment|/*  * Process L2CAP_InfoReq command  */
end_comment

begin_function
specifier|static
name|int
name|ng_l2cap_process_info_req
parameter_list|(
name|ng_l2cap_con_p
name|con
parameter_list|,
name|u_int8_t
name|ident
parameter_list|)
block|{
name|ng_l2cap_p
name|l2cap
init|=
name|con
operator|->
name|l2cap
decl_stmt|;
name|ng_l2cap_cmd_p
name|cmd
init|=
name|NULL
decl_stmt|;
name|u_int16_t
name|type
decl_stmt|;
comment|/* Get command parameters */
name|NG_L2CAP_M_PULLUP
argument_list|(
name|con
operator|->
name|rx_pkt
argument_list|,
sizeof|sizeof
argument_list|(
name|ng_l2cap_info_req_cp
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|con
operator|->
name|rx_pkt
operator|==
name|NULL
condition|)
return|return
operator|(
name|ENOBUFS
operator|)
return|;
name|type
operator|=
name|le16toh
argument_list|(
name|mtod
argument_list|(
name|con
operator|->
name|rx_pkt
argument_list|,
name|ng_l2cap_info_req_cp
operator|*
argument_list|)
operator|->
name|type
argument_list|)
expr_stmt|;
name|NG_FREE_M
argument_list|(
name|con
operator|->
name|rx_pkt
argument_list|)
expr_stmt|;
name|cmd
operator|=
name|ng_l2cap_new_cmd
argument_list|(
name|con
argument_list|,
name|NULL
argument_list|,
name|ident
argument_list|,
name|NG_L2CAP_INFO_RSP
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|cmd
operator|==
name|NULL
condition|)
return|return
operator|(
name|ENOMEM
operator|)
return|;
switch|switch
condition|(
name|type
condition|)
block|{
case|case
name|NG_L2CAP_CONNLESS_MTU
case|:
name|_ng_l2cap_info_rsp
argument_list|(
name|cmd
operator|->
name|aux
argument_list|,
name|ident
argument_list|,
name|NG_L2CAP_CONNLESS_MTU
argument_list|,
name|NG_L2CAP_SUCCESS
argument_list|,
name|NG_L2CAP_MTU_DEFAULT
argument_list|)
expr_stmt|;
break|break;
default|default:
name|_ng_l2cap_info_rsp
argument_list|(
name|cmd
operator|->
name|aux
argument_list|,
name|ident
argument_list|,
name|type
argument_list|,
name|NG_L2CAP_NOT_SUPPORTED
argument_list|,
literal|0
argument_list|)
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|cmd
operator|->
name|aux
operator|==
name|NULL
condition|)
block|{
name|ng_l2cap_free_cmd
argument_list|(
name|cmd
argument_list|)
expr_stmt|;
return|return
operator|(
name|ENOBUFS
operator|)
return|;
block|}
comment|/* Link command to the queue */
name|ng_l2cap_link_cmd
argument_list|(
name|con
argument_list|,
name|cmd
argument_list|)
expr_stmt|;
name|ng_l2cap_lp_deliver
argument_list|(
name|con
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_comment
comment|/* ng_l2cap_process_info_req */
end_comment

begin_comment
comment|/*  * Process L2CAP_InfoRsp command  */
end_comment

begin_function
specifier|static
name|int
name|ng_l2cap_process_info_rsp
parameter_list|(
name|ng_l2cap_con_p
name|con
parameter_list|,
name|u_int8_t
name|ident
parameter_list|)
block|{
name|ng_l2cap_p
name|l2cap
init|=
name|con
operator|->
name|l2cap
decl_stmt|;
name|ng_l2cap_info_rsp_cp
modifier|*
name|cp
init|=
name|NULL
decl_stmt|;
name|ng_l2cap_cmd_p
name|cmd
init|=
name|NULL
decl_stmt|;
name|int
name|error
init|=
literal|0
decl_stmt|;
comment|/* Get command parameters */
name|NG_L2CAP_M_PULLUP
argument_list|(
name|con
operator|->
name|rx_pkt
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|cp
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|con
operator|->
name|rx_pkt
operator|==
name|NULL
condition|)
return|return
operator|(
name|ENOBUFS
operator|)
return|;
name|cp
operator|=
name|mtod
argument_list|(
name|con
operator|->
name|rx_pkt
argument_list|,
name|ng_l2cap_info_rsp_cp
operator|*
argument_list|)
expr_stmt|;
name|cp
operator|->
name|type
operator|=
name|le16toh
argument_list|(
name|cp
operator|->
name|type
argument_list|)
expr_stmt|;
name|cp
operator|->
name|result
operator|=
name|le16toh
argument_list|(
name|cp
operator|->
name|result
argument_list|)
expr_stmt|;
name|m_adj
argument_list|(
name|con
operator|->
name|rx_pkt
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|cp
argument_list|)
argument_list|)
expr_stmt|;
comment|/* Check if we have pending command descriptor */
name|cmd
operator|=
name|ng_l2cap_cmd_by_ident
argument_list|(
name|con
argument_list|,
name|ident
argument_list|)
expr_stmt|;
if|if
condition|(
name|cmd
operator|==
name|NULL
condition|)
block|{
name|NG_L2CAP_ERR
argument_list|(
literal|"%s: %s - unexpected L2CAP_InfoRsp command. "
expr|\
literal|"Requested ident does not exist, ident=%d\n"
argument_list|,
name|__func__
argument_list|,
name|NG_NODE_NAME
argument_list|(
name|l2cap
operator|->
name|node
argument_list|)
argument_list|,
name|ident
argument_list|)
expr_stmt|;
name|NG_FREE_M
argument_list|(
name|con
operator|->
name|rx_pkt
argument_list|)
expr_stmt|;
return|return
operator|(
name|ENOENT
operator|)
return|;
block|}
comment|/* If command timeout already happened then ignore response */
if|if
condition|(
operator|(
name|error
operator|=
name|ng_l2cap_command_untimeout
argument_list|(
name|cmd
argument_list|)
operator|)
operator|!=
literal|0
condition|)
block|{
name|NG_FREE_M
argument_list|(
name|con
operator|->
name|rx_pkt
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
name|ng_l2cap_unlink_cmd
argument_list|(
name|cmd
argument_list|)
expr_stmt|;
if|if
condition|(
name|cp
operator|->
name|result
operator|==
name|NG_L2CAP_SUCCESS
condition|)
block|{
switch|switch
condition|(
name|cp
operator|->
name|type
condition|)
block|{
case|case
name|NG_L2CAP_CONNLESS_MTU
case|:
if|if
condition|(
name|con
operator|->
name|rx_pkt
operator|->
name|m_pkthdr
operator|.
name|len
operator|==
sizeof|sizeof
argument_list|(
name|u_int16_t
argument_list|)
condition|)
operator|*
name|mtod
argument_list|(
name|con
operator|->
name|rx_pkt
argument_list|,
name|u_int16_t
operator|*
argument_list|)
operator|=
name|le16toh
argument_list|(
operator|*
name|mtod
argument_list|(
name|con
operator|->
name|rx_pkt
argument_list|,
name|u_int16_t
operator|*
argument_list|)
argument_list|)
expr_stmt|;
else|else
block|{
name|cp
operator|->
name|result
operator|=
name|NG_L2CAP_UNKNOWN
expr_stmt|;
comment|/* XXX */
name|NG_L2CAP_ERR
argument_list|(
literal|"%s: %s - invalid L2CAP_InfoRsp command. "
expr|\
literal|"Bad connectionless MTU parameter, len=%d\n"
argument_list|,
name|__func__
argument_list|,
name|NG_NODE_NAME
argument_list|(
name|l2cap
operator|->
name|node
argument_list|)
argument_list|,
name|con
operator|->
name|rx_pkt
operator|->
name|m_pkthdr
operator|.
name|len
argument_list|)
expr_stmt|;
block|}
break|break;
default|default:
name|NG_L2CAP_WARN
argument_list|(
literal|"%s: %s - invalid L2CAP_InfoRsp command. Unknown info type=%d\n"
argument_list|,
name|__func__
argument_list|,
name|NG_NODE_NAME
argument_list|(
name|l2cap
operator|->
name|node
argument_list|)
argument_list|,
name|cp
operator|->
name|type
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
name|error
operator|=
name|ng_l2cap_l2ca_get_info_rsp
argument_list|(
name|cmd
operator|->
name|con
argument_list|,
name|cmd
operator|->
name|token
argument_list|,
name|cp
operator|->
name|result
argument_list|,
name|con
operator|->
name|rx_pkt
argument_list|)
expr_stmt|;
name|ng_l2cap_free_cmd
argument_list|(
name|cmd
argument_list|)
expr_stmt|;
name|con
operator|->
name|rx_pkt
operator|=
name|NULL
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
end_function

begin_comment
comment|/* ng_l2cap_process_info_rsp */
end_comment

begin_comment
comment|/*  * Send L2CAP reject  */
end_comment

begin_function
specifier|static
name|int
name|send_l2cap_reject
parameter_list|(
name|ng_l2cap_con_p
name|con
parameter_list|,
name|u_int8_t
name|ident
parameter_list|,
name|u_int16_t
name|reason
parameter_list|,
name|u_int16_t
name|mtu
parameter_list|,
name|u_int16_t
name|scid
parameter_list|,
name|u_int16_t
name|dcid
parameter_list|)
block|{
name|ng_l2cap_cmd_p
name|cmd
init|=
name|NULL
decl_stmt|;
name|cmd
operator|=
name|ng_l2cap_new_cmd
argument_list|(
name|con
argument_list|,
name|NULL
argument_list|,
name|ident
argument_list|,
name|NG_L2CAP_CMD_REJ
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|cmd
operator|==
name|NULL
condition|)
return|return
operator|(
name|ENOMEM
operator|)
return|;
name|_ng_l2cap_cmd_rej
argument_list|(
name|cmd
operator|->
name|aux
argument_list|,
name|cmd
operator|->
name|ident
argument_list|,
name|reason
argument_list|,
name|mtu
argument_list|,
name|scid
argument_list|,
name|dcid
argument_list|)
expr_stmt|;
if|if
condition|(
name|cmd
operator|->
name|aux
operator|==
name|NULL
condition|)
block|{
name|ng_l2cap_free_cmd
argument_list|(
name|cmd
argument_list|)
expr_stmt|;
return|return
operator|(
name|ENOBUFS
operator|)
return|;
block|}
comment|/* Link command to the queue */
name|ng_l2cap_link_cmd
argument_list|(
name|con
argument_list|,
name|cmd
argument_list|)
expr_stmt|;
name|ng_l2cap_lp_deliver
argument_list|(
name|con
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_comment
comment|/* send_l2cap_reject */
end_comment

begin_comment
comment|/*  * Send L2CAP connection reject  */
end_comment

begin_function
specifier|static
name|int
name|send_l2cap_con_rej
parameter_list|(
name|ng_l2cap_con_p
name|con
parameter_list|,
name|u_int8_t
name|ident
parameter_list|,
name|u_int16_t
name|scid
parameter_list|,
name|u_int16_t
name|dcid
parameter_list|,
name|u_int16_t
name|result
parameter_list|)
block|{
name|ng_l2cap_cmd_p
name|cmd
init|=
name|NULL
decl_stmt|;
name|cmd
operator|=
name|ng_l2cap_new_cmd
argument_list|(
name|con
argument_list|,
name|NULL
argument_list|,
name|ident
argument_list|,
name|NG_L2CAP_CON_RSP
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|cmd
operator|==
name|NULL
condition|)
return|return
operator|(
name|ENOMEM
operator|)
return|;
name|_ng_l2cap_con_rsp
argument_list|(
name|cmd
operator|->
name|aux
argument_list|,
name|cmd
operator|->
name|ident
argument_list|,
name|scid
argument_list|,
name|dcid
argument_list|,
name|result
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|cmd
operator|->
name|aux
operator|==
name|NULL
condition|)
block|{
name|ng_l2cap_free_cmd
argument_list|(
name|cmd
argument_list|)
expr_stmt|;
return|return
operator|(
name|ENOBUFS
operator|)
return|;
block|}
comment|/* Link command to the queue */
name|ng_l2cap_link_cmd
argument_list|(
name|con
argument_list|,
name|cmd
argument_list|)
expr_stmt|;
name|ng_l2cap_lp_deliver
argument_list|(
name|con
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_comment
comment|/* send_l2cap_con_rej */
end_comment

begin_comment
comment|/*  * Send L2CAP config response  */
end_comment

begin_function
specifier|static
name|int
name|send_l2cap_cfg_rsp
parameter_list|(
name|ng_l2cap_con_p
name|con
parameter_list|,
name|u_int8_t
name|ident
parameter_list|,
name|u_int16_t
name|scid
parameter_list|,
name|u_int16_t
name|result
parameter_list|,
name|struct
name|mbuf
modifier|*
name|opt
parameter_list|)
block|{
name|ng_l2cap_cmd_p
name|cmd
init|=
name|NULL
decl_stmt|;
name|cmd
operator|=
name|ng_l2cap_new_cmd
argument_list|(
name|con
argument_list|,
name|NULL
argument_list|,
name|ident
argument_list|,
name|NG_L2CAP_CFG_RSP
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|cmd
operator|==
name|NULL
condition|)
block|{
name|NG_FREE_M
argument_list|(
name|opt
argument_list|)
expr_stmt|;
return|return
operator|(
name|ENOMEM
operator|)
return|;
block|}
name|_ng_l2cap_cfg_rsp
argument_list|(
name|cmd
operator|->
name|aux
argument_list|,
name|cmd
operator|->
name|ident
argument_list|,
name|scid
argument_list|,
literal|0
argument_list|,
name|result
argument_list|,
name|opt
argument_list|)
expr_stmt|;
if|if
condition|(
name|cmd
operator|->
name|aux
operator|==
name|NULL
condition|)
block|{
name|ng_l2cap_free_cmd
argument_list|(
name|cmd
argument_list|)
expr_stmt|;
return|return
operator|(
name|ENOBUFS
operator|)
return|;
block|}
comment|/* Link command to the queue */
name|ng_l2cap_link_cmd
argument_list|(
name|con
argument_list|,
name|cmd
argument_list|)
expr_stmt|;
name|ng_l2cap_lp_deliver
argument_list|(
name|con
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_comment
comment|/* send_l2cap_cfg_rsp */
end_comment

begin_comment
comment|/*  * Get next L2CAP configuration option  *  * Return codes:  *  0   no option  *  1   we have got option  * -1   header too short  * -2   bad option value or length  * -3   unknown option  */
end_comment

begin_function
specifier|static
name|int
name|get_next_l2cap_opt
parameter_list|(
name|struct
name|mbuf
modifier|*
name|m
parameter_list|,
name|int
modifier|*
name|off
parameter_list|,
name|ng_l2cap_cfg_opt_p
name|hdr
parameter_list|,
name|ng_l2cap_cfg_opt_val_p
name|val
parameter_list|)
block|{
name|int
name|hint
decl_stmt|,
name|len
init|=
name|m
operator|->
name|m_pkthdr
operator|.
name|len
operator|-
operator|(
operator|*
name|off
operator|)
decl_stmt|;
if|if
condition|(
name|len
operator|==
literal|0
condition|)
return|return
operator|(
literal|0
operator|)
return|;
if|if
condition|(
name|len
operator|<
literal|0
operator|||
name|len
operator|<
sizeof|sizeof
argument_list|(
operator|*
name|hdr
argument_list|)
condition|)
return|return
operator|(
operator|-
literal|1
operator|)
return|;
name|m_copydata
argument_list|(
name|m
argument_list|,
operator|*
name|off
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|hdr
argument_list|)
argument_list|,
operator|(
name|caddr_t
operator|)
name|hdr
argument_list|)
expr_stmt|;
operator|*
name|off
operator|+=
sizeof|sizeof
argument_list|(
operator|*
name|hdr
argument_list|)
expr_stmt|;
name|len
operator|-=
sizeof|sizeof
argument_list|(
operator|*
name|hdr
argument_list|)
expr_stmt|;
name|hint
operator|=
name|NG_L2CAP_OPT_HINT
argument_list|(
name|hdr
operator|->
name|type
argument_list|)
expr_stmt|;
name|hdr
operator|->
name|type
operator|&=
name|NG_L2CAP_OPT_HINT_MASK
expr_stmt|;
switch|switch
condition|(
name|hdr
operator|->
name|type
condition|)
block|{
case|case
name|NG_L2CAP_OPT_MTU
case|:
if|if
condition|(
name|hdr
operator|->
name|length
operator|!=
name|NG_L2CAP_OPT_MTU_SIZE
operator|||
name|len
operator|<
name|hdr
operator|->
name|length
condition|)
return|return
operator|(
operator|-
literal|2
operator|)
return|;
name|m_copydata
argument_list|(
name|m
argument_list|,
operator|*
name|off
argument_list|,
name|NG_L2CAP_OPT_MTU_SIZE
argument_list|,
operator|(
name|caddr_t
operator|)
name|val
argument_list|)
expr_stmt|;
name|val
operator|->
name|mtu
operator|=
name|le16toh
argument_list|(
name|val
operator|->
name|mtu
argument_list|)
expr_stmt|;
operator|*
name|off
operator|+=
name|NG_L2CAP_OPT_MTU_SIZE
expr_stmt|;
break|break;
case|case
name|NG_L2CAP_OPT_FLUSH_TIMO
case|:
if|if
condition|(
name|hdr
operator|->
name|length
operator|!=
name|NG_L2CAP_OPT_FLUSH_TIMO_SIZE
operator|||
name|len
operator|<
name|hdr
operator|->
name|length
condition|)
return|return
operator|(
operator|-
literal|2
operator|)
return|;
name|m_copydata
argument_list|(
name|m
argument_list|,
operator|*
name|off
argument_list|,
name|NG_L2CAP_OPT_FLUSH_TIMO_SIZE
argument_list|,
operator|(
name|caddr_t
operator|)
name|val
argument_list|)
expr_stmt|;
name|val
operator|->
name|flush_timo
operator|=
name|le16toh
argument_list|(
name|val
operator|->
name|flush_timo
argument_list|)
expr_stmt|;
operator|*
name|off
operator|+=
name|NG_L2CAP_OPT_FLUSH_TIMO_SIZE
expr_stmt|;
break|break;
case|case
name|NG_L2CAP_OPT_QOS
case|:
if|if
condition|(
name|hdr
operator|->
name|length
operator|!=
name|NG_L2CAP_OPT_QOS_SIZE
operator|||
name|len
operator|<
name|hdr
operator|->
name|length
condition|)
return|return
operator|(
operator|-
literal|2
operator|)
return|;
name|m_copydata
argument_list|(
name|m
argument_list|,
operator|*
name|off
argument_list|,
name|NG_L2CAP_OPT_QOS_SIZE
argument_list|,
operator|(
name|caddr_t
operator|)
name|val
argument_list|)
expr_stmt|;
name|val
operator|->
name|flow
operator|.
name|token_rate
operator|=
name|le32toh
argument_list|(
name|val
operator|->
name|flow
operator|.
name|token_rate
argument_list|)
expr_stmt|;
name|val
operator|->
name|flow
operator|.
name|token_bucket_size
operator|=
name|le32toh
argument_list|(
name|val
operator|->
name|flow
operator|.
name|token_bucket_size
argument_list|)
expr_stmt|;
name|val
operator|->
name|flow
operator|.
name|peak_bandwidth
operator|=
name|le32toh
argument_list|(
name|val
operator|->
name|flow
operator|.
name|peak_bandwidth
argument_list|)
expr_stmt|;
name|val
operator|->
name|flow
operator|.
name|latency
operator|=
name|le32toh
argument_list|(
name|val
operator|->
name|flow
operator|.
name|latency
argument_list|)
expr_stmt|;
name|val
operator|->
name|flow
operator|.
name|delay_variation
operator|=
name|le32toh
argument_list|(
name|val
operator|->
name|flow
operator|.
name|delay_variation
argument_list|)
expr_stmt|;
operator|*
name|off
operator|+=
name|NG_L2CAP_OPT_QOS_SIZE
expr_stmt|;
break|break;
default|default:
if|if
condition|(
name|hint
condition|)
operator|*
name|off
operator|+=
name|hdr
operator|->
name|length
expr_stmt|;
else|else
return|return
operator|(
operator|-
literal|3
operator|)
return|;
break|break;
block|}
return|return
operator|(
literal|1
operator|)
return|;
block|}
end_function

begin_comment
comment|/* get_next_l2cap_opt */
end_comment

end_unit


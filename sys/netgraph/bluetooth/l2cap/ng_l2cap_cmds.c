begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * ng_l2cap_cmds.c  */
end_comment

begin_comment
comment|/*-  * Copyright (c) Maksim Yevmenkin<m_evmenkin@yahoo.com>  * All rights reserved.  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions  * are met:  * 1. Redistributions of source code must retain the above copyright  *    notice, this list of conditions and the following disclaimer.  * 2. Redistributions in binary form must reproduce the above copyright  *    notice, this list of conditions and the following disclaimer in the  *    documentation and/or other materials provided with the distribution.  *  * THIS SOFTWARE IS PROVIDED BY THE AUTHOR AND CONTRIBUTORS ``AS IS'' AND  * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE  * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE  * ARE DISCLAIMED. IN NO EVENT SHALL THE AUTHOR OR CONTRIBUTORS BE LIABLE  * FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL  * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS  * OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)  * HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT  * LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY  * OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF  * SUCH DAMAGE.  *  * $Id: ng_l2cap_cmds.c,v 1.2 2003/09/08 19:11:45 max Exp $  * $FreeBSD$  */
end_comment

begin_include
include|#
directive|include
file|<sys/param.h>
end_include

begin_include
include|#
directive|include
file|<sys/systm.h>
end_include

begin_include
include|#
directive|include
file|<sys/kernel.h>
end_include

begin_include
include|#
directive|include
file|<sys/endian.h>
end_include

begin_include
include|#
directive|include
file|<sys/malloc.h>
end_include

begin_include
include|#
directive|include
file|<sys/mbuf.h>
end_include

begin_include
include|#
directive|include
file|<sys/queue.h>
end_include

begin_include
include|#
directive|include
file|<netgraph/ng_message.h>
end_include

begin_include
include|#
directive|include
file|<netgraph/netgraph.h>
end_include

begin_include
include|#
directive|include
file|<netgraph/bluetooth/include/ng_bluetooth.h>
end_include

begin_include
include|#
directive|include
file|<netgraph/bluetooth/include/ng_hci.h>
end_include

begin_include
include|#
directive|include
file|<netgraph/bluetooth/include/ng_l2cap.h>
end_include

begin_include
include|#
directive|include
file|<netgraph/bluetooth/l2cap/ng_l2cap_var.h>
end_include

begin_include
include|#
directive|include
file|<netgraph/bluetooth/l2cap/ng_l2cap_cmds.h>
end_include

begin_include
include|#
directive|include
file|<netgraph/bluetooth/l2cap/ng_l2cap_evnt.h>
end_include

begin_include
include|#
directive|include
file|<netgraph/bluetooth/l2cap/ng_l2cap_llpi.h>
end_include

begin_include
include|#
directive|include
file|<netgraph/bluetooth/l2cap/ng_l2cap_ulpi.h>
end_include

begin_include
include|#
directive|include
file|<netgraph/bluetooth/l2cap/ng_l2cap_misc.h>
end_include

begin_comment
comment|/******************************************************************************  ******************************************************************************  **                    L2CAP commands processing module  ******************************************************************************  ******************************************************************************/
end_comment

begin_comment
comment|/*  * Process L2CAP command queue on connection  */
end_comment

begin_function
name|void
name|ng_l2cap_con_wakeup
parameter_list|(
name|ng_l2cap_con_p
name|con
parameter_list|)
block|{
name|ng_l2cap_cmd_p
name|cmd
init|=
name|NULL
decl_stmt|;
name|struct
name|mbuf
modifier|*
name|m
init|=
name|NULL
decl_stmt|;
name|int
name|error
init|=
literal|0
decl_stmt|;
comment|/* Find first non-pending command in the queue */
name|TAILQ_FOREACH
argument_list|(
argument|cmd
argument_list|,
argument|&con->cmd_list
argument_list|,
argument|next
argument_list|)
block|{
name|KASSERT
argument_list|(
operator|(
name|cmd
operator|->
name|con
operator|==
name|con
operator|)
argument_list|,
operator|(
literal|"%s: %s - invalid connection pointer!\n"
operator|,
name|__func__
operator|,
name|NG_NODE_NAME
argument_list|(
name|con
operator|->
name|l2cap
operator|->
name|node
argument_list|)
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|cmd
operator|->
name|flags
operator|&
name|NG_L2CAP_CMD_PENDING
operator|)
condition|)
break|break;
block|}
if|if
condition|(
name|cmd
operator|==
name|NULL
condition|)
return|return;
comment|/* Detach command packet */
name|m
operator|=
name|cmd
operator|->
name|aux
expr_stmt|;
name|cmd
operator|->
name|aux
operator|=
name|NULL
expr_stmt|;
comment|/* Process command */
switch|switch
condition|(
name|cmd
operator|->
name|code
condition|)
block|{
case|case
name|NG_L2CAP_DISCON_RSP
case|:
case|case
name|NG_L2CAP_ECHO_RSP
case|:
case|case
name|NG_L2CAP_INFO_RSP
case|:
comment|/* 		 * Do not check return ng_l2cap_lp_send() value, because 		 * in these cases we do not really have a graceful way out. 		 * ECHO and INFO responses are internal to the stack and not 		 * visible to user. REJect is just being nice to remote end 		 * (otherwise remote end will timeout anyway). DISCON is 		 * probably most interesting here, however, if it fails 		 * there is nothing we can do anyway. 		 */
operator|(
name|void
operator|)
name|ng_l2cap_lp_send
argument_list|(
name|con
argument_list|,
name|NG_L2CAP_SIGNAL_CID
argument_list|,
name|m
argument_list|)
expr_stmt|;
name|ng_l2cap_unlink_cmd
argument_list|(
name|cmd
argument_list|)
expr_stmt|;
name|ng_l2cap_free_cmd
argument_list|(
name|cmd
argument_list|)
expr_stmt|;
break|break;
case|case
name|NG_L2CAP_CMD_REJ
case|:
operator|(
name|void
operator|)
name|ng_l2cap_lp_send
argument_list|(
name|con
argument_list|,
operator|(
name|con
operator|->
name|linktype
operator|==
name|NG_HCI_LINK_ACL
operator|)
condition|?
name|NG_L2CAP_SIGNAL_CID
else|:
name|NG_L2CAP_LESIGNAL_CID
argument_list|,
name|m
argument_list|)
expr_stmt|;
name|ng_l2cap_unlink_cmd
argument_list|(
name|cmd
argument_list|)
expr_stmt|;
name|ng_l2cap_free_cmd
argument_list|(
name|cmd
argument_list|)
expr_stmt|;
break|break;
case|case
name|NG_L2CAP_CON_REQ
case|:
name|error
operator|=
name|ng_l2cap_lp_send
argument_list|(
name|con
argument_list|,
name|NG_L2CAP_SIGNAL_CID
argument_list|,
name|m
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|!=
literal|0
condition|)
block|{
name|ng_l2cap_l2ca_con_rsp
argument_list|(
name|cmd
operator|->
name|ch
argument_list|,
name|cmd
operator|->
name|token
argument_list|,
name|NG_L2CAP_NO_RESOURCES
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|ng_l2cap_free_chan
argument_list|(
name|cmd
operator|->
name|ch
argument_list|)
expr_stmt|;
comment|/* will free commands */
block|}
else|else
name|ng_l2cap_command_timeout
argument_list|(
name|cmd
argument_list|,
name|bluetooth_l2cap_rtx_timeout
argument_list|()
argument_list|)
expr_stmt|;
break|break;
case|case
name|NG_L2CAP_CON_RSP
case|:
name|error
operator|=
name|ng_l2cap_lp_send
argument_list|(
name|con
argument_list|,
name|NG_L2CAP_SIGNAL_CID
argument_list|,
name|m
argument_list|)
expr_stmt|;
name|ng_l2cap_unlink_cmd
argument_list|(
name|cmd
argument_list|)
expr_stmt|;
if|if
condition|(
name|cmd
operator|->
name|ch
operator|!=
name|NULL
condition|)
block|{
name|ng_l2cap_l2ca_con_rsp_rsp
argument_list|(
name|cmd
operator|->
name|ch
argument_list|,
name|cmd
operator|->
name|token
argument_list|,
operator|(
name|error
operator|==
literal|0
operator|)
condition|?
name|NG_L2CAP_SUCCESS
else|:
name|NG_L2CAP_NO_RESOURCES
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|!=
literal|0
condition|)
name|ng_l2cap_free_chan
argument_list|(
name|cmd
operator|->
name|ch
argument_list|)
expr_stmt|;
block|}
name|ng_l2cap_free_cmd
argument_list|(
name|cmd
argument_list|)
expr_stmt|;
break|break;
case|case
name|NG_L2CAP_CFG_REQ
case|:
name|error
operator|=
name|ng_l2cap_lp_send
argument_list|(
name|con
argument_list|,
name|NG_L2CAP_SIGNAL_CID
argument_list|,
name|m
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|!=
literal|0
condition|)
block|{
name|ng_l2cap_l2ca_cfg_rsp
argument_list|(
name|cmd
operator|->
name|ch
argument_list|,
name|cmd
operator|->
name|token
argument_list|,
name|NG_L2CAP_NO_RESOURCES
argument_list|)
expr_stmt|;
name|ng_l2cap_unlink_cmd
argument_list|(
name|cmd
argument_list|)
expr_stmt|;
name|ng_l2cap_free_cmd
argument_list|(
name|cmd
argument_list|)
expr_stmt|;
block|}
else|else
name|ng_l2cap_command_timeout
argument_list|(
name|cmd
argument_list|,
name|bluetooth_l2cap_rtx_timeout
argument_list|()
argument_list|)
expr_stmt|;
break|break;
case|case
name|NG_L2CAP_CFG_RSP
case|:
name|error
operator|=
name|ng_l2cap_lp_send
argument_list|(
name|con
argument_list|,
name|NG_L2CAP_SIGNAL_CID
argument_list|,
name|m
argument_list|)
expr_stmt|;
name|ng_l2cap_unlink_cmd
argument_list|(
name|cmd
argument_list|)
expr_stmt|;
if|if
condition|(
name|cmd
operator|->
name|ch
operator|!=
name|NULL
condition|)
name|ng_l2cap_l2ca_cfg_rsp_rsp
argument_list|(
name|cmd
operator|->
name|ch
argument_list|,
name|cmd
operator|->
name|token
argument_list|,
operator|(
name|error
operator|==
literal|0
operator|)
condition|?
name|NG_L2CAP_SUCCESS
else|:
name|NG_L2CAP_NO_RESOURCES
argument_list|)
expr_stmt|;
name|ng_l2cap_free_cmd
argument_list|(
name|cmd
argument_list|)
expr_stmt|;
break|break;
case|case
name|NG_L2CAP_DISCON_REQ
case|:
name|error
operator|=
name|ng_l2cap_lp_send
argument_list|(
name|con
argument_list|,
name|NG_L2CAP_SIGNAL_CID
argument_list|,
name|m
argument_list|)
expr_stmt|;
name|ng_l2cap_l2ca_discon_rsp
argument_list|(
name|cmd
operator|->
name|ch
argument_list|,
name|cmd
operator|->
name|token
argument_list|,
operator|(
name|error
operator|==
literal|0
operator|)
condition|?
name|NG_L2CAP_SUCCESS
else|:
name|NG_L2CAP_NO_RESOURCES
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|!=
literal|0
condition|)
name|ng_l2cap_free_chan
argument_list|(
name|cmd
operator|->
name|ch
argument_list|)
expr_stmt|;
comment|/* XXX free channel */
else|else
name|ng_l2cap_command_timeout
argument_list|(
name|cmd
argument_list|,
name|bluetooth_l2cap_rtx_timeout
argument_list|()
argument_list|)
expr_stmt|;
break|break;
case|case
name|NG_L2CAP_ECHO_REQ
case|:
name|error
operator|=
name|ng_l2cap_lp_send
argument_list|(
name|con
argument_list|,
name|NG_L2CAP_SIGNAL_CID
argument_list|,
name|m
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|!=
literal|0
condition|)
block|{
name|ng_l2cap_l2ca_ping_rsp
argument_list|(
name|con
argument_list|,
name|cmd
operator|->
name|token
argument_list|,
name|NG_L2CAP_NO_RESOURCES
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|ng_l2cap_unlink_cmd
argument_list|(
name|cmd
argument_list|)
expr_stmt|;
name|ng_l2cap_free_cmd
argument_list|(
name|cmd
argument_list|)
expr_stmt|;
block|}
else|else
name|ng_l2cap_command_timeout
argument_list|(
name|cmd
argument_list|,
name|bluetooth_l2cap_rtx_timeout
argument_list|()
argument_list|)
expr_stmt|;
break|break;
case|case
name|NG_L2CAP_INFO_REQ
case|:
name|error
operator|=
name|ng_l2cap_lp_send
argument_list|(
name|con
argument_list|,
name|NG_L2CAP_SIGNAL_CID
argument_list|,
name|m
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|!=
literal|0
condition|)
block|{
name|ng_l2cap_l2ca_get_info_rsp
argument_list|(
name|con
argument_list|,
name|cmd
operator|->
name|token
argument_list|,
name|NG_L2CAP_NO_RESOURCES
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|ng_l2cap_unlink_cmd
argument_list|(
name|cmd
argument_list|)
expr_stmt|;
name|ng_l2cap_free_cmd
argument_list|(
name|cmd
argument_list|)
expr_stmt|;
block|}
else|else
name|ng_l2cap_command_timeout
argument_list|(
name|cmd
argument_list|,
name|bluetooth_l2cap_rtx_timeout
argument_list|()
argument_list|)
expr_stmt|;
break|break;
case|case
name|NGM_L2CAP_L2CA_WRITE
case|:
block|{
name|int
name|length
init|=
name|m
operator|->
name|m_pkthdr
operator|.
name|len
decl_stmt|;
if|if
condition|(
name|cmd
operator|->
name|ch
operator|->
name|dcid
operator|==
name|NG_L2CAP_CLT_CID
condition|)
block|{
name|m
operator|=
name|ng_l2cap_prepend
argument_list|(
name|m
argument_list|,
sizeof|sizeof
argument_list|(
name|ng_l2cap_clt_hdr_t
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|m
operator|==
name|NULL
condition|)
name|error
operator|=
name|ENOBUFS
expr_stmt|;
else|else
name|mtod
argument_list|(
name|m
argument_list|,
name|ng_l2cap_clt_hdr_t
operator|*
argument_list|)
operator|->
name|psm
operator|=
name|htole16
argument_list|(
name|cmd
operator|->
name|ch
operator|->
name|psm
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|error
operator|==
literal|0
condition|)
name|error
operator|=
name|ng_l2cap_lp_send
argument_list|(
name|con
argument_list|,
name|cmd
operator|->
name|ch
operator|->
name|dcid
argument_list|,
name|m
argument_list|)
expr_stmt|;
name|ng_l2cap_l2ca_write_rsp
argument_list|(
name|cmd
operator|->
name|ch
argument_list|,
name|cmd
operator|->
name|token
argument_list|,
operator|(
name|error
operator|==
literal|0
operator|)
condition|?
name|NG_L2CAP_SUCCESS
else|:
name|NG_L2CAP_NO_RESOURCES
argument_list|,
name|length
argument_list|)
expr_stmt|;
name|ng_l2cap_unlink_cmd
argument_list|(
name|cmd
argument_list|)
expr_stmt|;
name|ng_l2cap_free_cmd
argument_list|(
name|cmd
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
name|NG_L2CAP_CMD_PARAM_UPDATE_RESPONSE
case|:
name|error
operator|=
name|ng_l2cap_lp_send
argument_list|(
name|con
argument_list|,
name|NG_L2CAP_LESIGNAL_CID
argument_list|,
name|m
argument_list|)
expr_stmt|;
name|ng_l2cap_unlink_cmd
argument_list|(
name|cmd
argument_list|)
expr_stmt|;
name|ng_l2cap_free_cmd
argument_list|(
name|cmd
argument_list|)
expr_stmt|;
break|break;
case|case
name|NG_L2CAP_CMD_PARAM_UPDATE_REQUEST
case|:
comment|/*TBD.*/
comment|/* XXX FIXME add other commands */
default|default:
name|panic
argument_list|(
literal|"%s: %s - unknown command code=%d\n"
argument_list|,
name|__func__
argument_list|,
name|NG_NODE_NAME
argument_list|(
name|con
operator|->
name|l2cap
operator|->
name|node
argument_list|)
argument_list|,
name|cmd
operator|->
name|code
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
end_function

begin_comment
comment|/* ng_l2cap_con_wakeup */
end_comment

begin_comment
comment|/*  * We have failed to open ACL connection to the remote unit. Could be negative  * confirmation or timeout. So fail any "delayed" commands, notify upper layer,  * remove all channels and remove connection descriptor.  */
end_comment

begin_function
name|void
name|ng_l2cap_con_fail
parameter_list|(
name|ng_l2cap_con_p
name|con
parameter_list|,
name|u_int16_t
name|result
parameter_list|)
block|{
name|ng_l2cap_p
name|l2cap
init|=
name|con
operator|->
name|l2cap
decl_stmt|;
name|ng_l2cap_cmd_p
name|cmd
init|=
name|NULL
decl_stmt|;
name|ng_l2cap_chan_p
name|ch
init|=
name|NULL
decl_stmt|;
name|NG_L2CAP_INFO
argument_list|(
literal|"%s: %s - ACL connection failed, result=%d\n"
argument_list|,
name|__func__
argument_list|,
name|NG_NODE_NAME
argument_list|(
name|l2cap
operator|->
name|node
argument_list|)
argument_list|,
name|result
argument_list|)
expr_stmt|;
comment|/* Connection is dying */
name|con
operator|->
name|flags
operator||=
name|NG_L2CAP_CON_DYING
expr_stmt|;
comment|/* Clean command queue */
while|while
condition|(
operator|!
name|TAILQ_EMPTY
argument_list|(
operator|&
name|con
operator|->
name|cmd_list
argument_list|)
condition|)
block|{
name|cmd
operator|=
name|TAILQ_FIRST
argument_list|(
operator|&
name|con
operator|->
name|cmd_list
argument_list|)
expr_stmt|;
name|ng_l2cap_unlink_cmd
argument_list|(
name|cmd
argument_list|)
expr_stmt|;
if|if
condition|(
name|cmd
operator|->
name|flags
operator|&
name|NG_L2CAP_CMD_PENDING
condition|)
name|ng_l2cap_command_untimeout
argument_list|(
name|cmd
argument_list|)
expr_stmt|;
name|KASSERT
argument_list|(
operator|(
name|cmd
operator|->
name|con
operator|==
name|con
operator|)
argument_list|,
operator|(
literal|"%s: %s - invalid connection pointer!\n"
operator|,
name|__func__
operator|,
name|NG_NODE_NAME
argument_list|(
name|l2cap
operator|->
name|node
argument_list|)
operator|)
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|cmd
operator|->
name|code
condition|)
block|{
case|case
name|NG_L2CAP_CMD_REJ
case|:
case|case
name|NG_L2CAP_DISCON_RSP
case|:
case|case
name|NG_L2CAP_ECHO_RSP
case|:
case|case
name|NG_L2CAP_INFO_RSP
case|:
case|case
name|NG_L2CAP_CMD_PARAM_UPDATE_RESPONSE
case|:
break|break;
case|case
name|NG_L2CAP_CON_REQ
case|:
name|ng_l2cap_l2ca_con_rsp
argument_list|(
name|cmd
operator|->
name|ch
argument_list|,
name|cmd
operator|->
name|token
argument_list|,
name|result
argument_list|,
literal|0
argument_list|)
expr_stmt|;
break|break;
case|case
name|NG_L2CAP_CON_RSP
case|:
if|if
condition|(
name|cmd
operator|->
name|ch
operator|!=
name|NULL
condition|)
name|ng_l2cap_l2ca_con_rsp_rsp
argument_list|(
name|cmd
operator|->
name|ch
argument_list|,
name|cmd
operator|->
name|token
argument_list|,
name|result
argument_list|)
expr_stmt|;
break|break;
case|case
name|NG_L2CAP_CFG_REQ
case|:
case|case
name|NG_L2CAP_CFG_RSP
case|:
case|case
name|NGM_L2CAP_L2CA_WRITE
case|:
name|ng_l2cap_l2ca_discon_ind
argument_list|(
name|cmd
operator|->
name|ch
argument_list|)
expr_stmt|;
break|break;
case|case
name|NG_L2CAP_DISCON_REQ
case|:
name|ng_l2cap_l2ca_discon_rsp
argument_list|(
name|cmd
operator|->
name|ch
argument_list|,
name|cmd
operator|->
name|token
argument_list|,
name|NG_L2CAP_SUCCESS
argument_list|)
expr_stmt|;
break|break;
case|case
name|NG_L2CAP_ECHO_REQ
case|:
name|ng_l2cap_l2ca_ping_rsp
argument_list|(
name|cmd
operator|->
name|con
argument_list|,
name|cmd
operator|->
name|token
argument_list|,
name|result
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
break|break;
case|case
name|NG_L2CAP_INFO_REQ
case|:
name|ng_l2cap_l2ca_get_info_rsp
argument_list|(
name|cmd
operator|->
name|con
argument_list|,
name|cmd
operator|->
name|token
argument_list|,
name|result
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
break|break;
comment|/* XXX FIXME add other commands */
default|default:
name|panic
argument_list|(
literal|"%s: %s - unexpected command code=%d\n"
argument_list|,
name|__func__
argument_list|,
name|NG_NODE_NAME
argument_list|(
name|l2cap
operator|->
name|node
argument_list|)
argument_list|,
name|cmd
operator|->
name|code
argument_list|)
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|cmd
operator|->
name|ch
operator|!=
name|NULL
condition|)
name|ng_l2cap_free_chan
argument_list|(
name|cmd
operator|->
name|ch
argument_list|)
expr_stmt|;
name|ng_l2cap_free_cmd
argument_list|(
name|cmd
argument_list|)
expr_stmt|;
block|}
comment|/* 	 * There still might be channels (in OPEN state?) that 	 * did not submit any commands, so disconnect them 	 */
name|LIST_FOREACH
argument_list|(
argument|ch
argument_list|,
argument|&l2cap->chan_list
argument_list|,
argument|next
argument_list|)
if|if
condition|(
name|ch
operator|->
name|con
operator|==
name|con
condition|)
name|ng_l2cap_l2ca_discon_ind
argument_list|(
name|ch
argument_list|)
expr_stmt|;
comment|/* Free connection descriptor */
name|ng_l2cap_free_con
argument_list|(
name|con
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* ng_l2cap_con_fail */
end_comment

begin_comment
comment|/*  * Process L2CAP command timeout. In general - notify upper layer and destroy  * channel. Do not pay much attention to return code, just do our best.  */
end_comment

begin_function
name|void
name|ng_l2cap_process_command_timeout
parameter_list|(
name|node_p
name|node
parameter_list|,
name|hook_p
name|hook
parameter_list|,
name|void
modifier|*
name|arg1
parameter_list|,
name|int
name|arg2
parameter_list|)
block|{
name|ng_l2cap_p
name|l2cap
init|=
name|NULL
decl_stmt|;
name|ng_l2cap_con_p
name|con
init|=
name|NULL
decl_stmt|;
name|ng_l2cap_cmd_p
name|cmd
init|=
name|NULL
decl_stmt|;
name|u_int16_t
name|con_handle
init|=
operator|(
name|arg2
operator|&
literal|0x0ffff
operator|)
decl_stmt|;
name|u_int8_t
name|ident
init|=
operator|(
operator|(
name|arg2
operator|>>
literal|16
operator|)
operator|&
literal|0xff
operator|)
decl_stmt|;
if|if
condition|(
name|NG_NODE_NOT_VALID
argument_list|(
name|node
argument_list|)
condition|)
block|{
name|printf
argument_list|(
literal|"%s: Netgraph node is not valid\n"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
return|return;
block|}
name|l2cap
operator|=
operator|(
name|ng_l2cap_p
operator|)
name|NG_NODE_PRIVATE
argument_list|(
name|node
argument_list|)
expr_stmt|;
name|con
operator|=
name|ng_l2cap_con_by_handle
argument_list|(
name|l2cap
argument_list|,
name|con_handle
argument_list|)
expr_stmt|;
if|if
condition|(
name|con
operator|==
name|NULL
condition|)
block|{
name|NG_L2CAP_ALERT
argument_list|(
literal|"%s: %s - could not find connection, con_handle=%d\n"
argument_list|,
name|__func__
argument_list|,
name|NG_NODE_NAME
argument_list|(
name|node
argument_list|)
argument_list|,
name|con_handle
argument_list|)
expr_stmt|;
return|return;
block|}
name|cmd
operator|=
name|ng_l2cap_cmd_by_ident
argument_list|(
name|con
argument_list|,
name|ident
argument_list|)
expr_stmt|;
if|if
condition|(
name|cmd
operator|==
name|NULL
condition|)
block|{
name|NG_L2CAP_ALERT
argument_list|(
literal|"%s: %s - could not find command, con_handle=%d, ident=%d\n"
argument_list|,
name|__func__
argument_list|,
name|NG_NODE_NAME
argument_list|(
name|node
argument_list|)
argument_list|,
name|con_handle
argument_list|,
name|ident
argument_list|)
expr_stmt|;
return|return;
block|}
name|cmd
operator|->
name|flags
operator|&=
operator|~
name|NG_L2CAP_CMD_PENDING
expr_stmt|;
name|ng_l2cap_unlink_cmd
argument_list|(
name|cmd
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|cmd
operator|->
name|code
condition|)
block|{
case|case
name|NG_L2CAP_CON_REQ
case|:
name|ng_l2cap_l2ca_con_rsp
argument_list|(
name|cmd
operator|->
name|ch
argument_list|,
name|cmd
operator|->
name|token
argument_list|,
name|NG_L2CAP_TIMEOUT
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|ng_l2cap_free_chan
argument_list|(
name|cmd
operator|->
name|ch
argument_list|)
expr_stmt|;
break|break;
case|case
name|NG_L2CAP_CFG_REQ
case|:
name|ng_l2cap_l2ca_cfg_rsp
argument_list|(
name|cmd
operator|->
name|ch
argument_list|,
name|cmd
operator|->
name|token
argument_list|,
name|NG_L2CAP_TIMEOUT
argument_list|)
expr_stmt|;
break|break;
case|case
name|NG_L2CAP_DISCON_REQ
case|:
name|ng_l2cap_l2ca_discon_rsp
argument_list|(
name|cmd
operator|->
name|ch
argument_list|,
name|cmd
operator|->
name|token
argument_list|,
name|NG_L2CAP_TIMEOUT
argument_list|)
expr_stmt|;
name|ng_l2cap_free_chan
argument_list|(
name|cmd
operator|->
name|ch
argument_list|)
expr_stmt|;
comment|/* XXX free channel */
break|break;
case|case
name|NG_L2CAP_ECHO_REQ
case|:
comment|/* Echo request timed out. Let the upper layer know */
name|ng_l2cap_l2ca_ping_rsp
argument_list|(
name|cmd
operator|->
name|con
argument_list|,
name|cmd
operator|->
name|token
argument_list|,
name|NG_L2CAP_TIMEOUT
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
break|break;
case|case
name|NG_L2CAP_INFO_REQ
case|:
comment|/* Info request timed out. Let the upper layer know */
name|ng_l2cap_l2ca_get_info_rsp
argument_list|(
name|cmd
operator|->
name|con
argument_list|,
name|cmd
operator|->
name|token
argument_list|,
name|NG_L2CAP_TIMEOUT
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
break|break;
comment|/* XXX FIXME add other commands */
default|default:
name|panic
argument_list|(
literal|"%s: %s - unexpected command code=%d\n"
argument_list|,
name|__func__
argument_list|,
name|NG_NODE_NAME
argument_list|(
name|l2cap
operator|->
name|node
argument_list|)
argument_list|,
name|cmd
operator|->
name|code
argument_list|)
expr_stmt|;
break|break;
block|}
name|ng_l2cap_free_cmd
argument_list|(
name|cmd
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* ng_l2cap_process_command_timeout */
end_comment

end_unit


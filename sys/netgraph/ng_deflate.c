begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*-  * Copyright (c) 2006 Alexander Motin<mav@alkar.net>  * All rights reserved.  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions  * are met:  * 1. Redistributions of source code must retain the above copyright  *    notice unmodified, this list of conditions, and the following  *    disclaimer.  * 2. Redistributions in binary form must reproduce the above copyright  *    notice, this list of conditions and the following disclaimer in the  *    documentation and/or other materials provided with the distribution.  *  * THIS SOFTWARE IS PROVIDED BY THE AUTHOR AND CONTRIBUTORS ``AS IS'' AND  * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE  * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE  * ARE DISCLAIMED.  IN NO EVENT SHALL THE AUTHOR OR CONTRIBUTORS BE LIABLE  * FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL  * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS  * OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)  * HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT  * LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY  * OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF  * SUCH DAMAGE.  *  * $FreeBSD$  */
end_comment

begin_comment
comment|/*  * Deflate PPP compression netgraph node type.  */
end_comment

begin_include
include|#
directive|include
file|<sys/param.h>
end_include

begin_include
include|#
directive|include
file|<sys/systm.h>
end_include

begin_include
include|#
directive|include
file|<sys/kernel.h>
end_include

begin_include
include|#
directive|include
file|<sys/mbuf.h>
end_include

begin_include
include|#
directive|include
file|<sys/malloc.h>
end_include

begin_include
include|#
directive|include
file|<sys/endian.h>
end_include

begin_include
include|#
directive|include
file|<sys/errno.h>
end_include

begin_include
include|#
directive|include
file|<sys/syslog.h>
end_include

begin_include
include|#
directive|include
file|<net/zlib.h>
end_include

begin_include
include|#
directive|include
file|<netgraph/ng_message.h>
end_include

begin_include
include|#
directive|include
file|<netgraph/netgraph.h>
end_include

begin_include
include|#
directive|include
file|<netgraph/ng_parse.h>
end_include

begin_include
include|#
directive|include
file|<netgraph/ng_deflate.h>
end_include

begin_include
include|#
directive|include
file|"opt_netgraph.h"
end_include

begin_expr_stmt
name|MALLOC_DEFINE
argument_list|(
name|M_NETGRAPH_DEFLATE
argument_list|,
literal|"netgraph_deflate"
argument_list|,
literal|"netgraph deflate node "
argument_list|)
expr_stmt|;
end_expr_stmt

begin_comment
comment|/* DEFLATE header length */
end_comment

begin_define
define|#
directive|define
name|DEFLATE_HDRLEN
value|2
end_define

begin_define
define|#
directive|define
name|PROT_COMPD
value|0x00fd
end_define

begin_define
define|#
directive|define
name|DEFLATE_BUF_SIZE
value|4096
end_define

begin_comment
comment|/* Node private data */
end_comment

begin_struct
struct|struct
name|ng_deflate_private
block|{
name|struct
name|ng_deflate_config
name|cfg
decl_stmt|;
comment|/* configuration */
name|u_char
name|inbuf
index|[
name|DEFLATE_BUF_SIZE
index|]
decl_stmt|;
comment|/* input buffer */
name|u_char
name|outbuf
index|[
name|DEFLATE_BUF_SIZE
index|]
decl_stmt|;
comment|/* output buffer */
name|z_stream
name|cx
decl_stmt|;
comment|/* compression context */
name|struct
name|ng_deflate_stats
name|stats
decl_stmt|;
comment|/* statistics */
name|ng_ID_t
name|ctrlnode
decl_stmt|;
comment|/* path to controlling node */
name|uint16_t
name|seqnum
decl_stmt|;
comment|/* sequence number */
name|u_char
name|compress
decl_stmt|;
comment|/* compress/decompress flag */
block|}
struct|;
end_struct

begin_typedef
typedef|typedef
name|struct
name|ng_deflate_private
modifier|*
name|priv_p
typedef|;
end_typedef

begin_comment
comment|/* Netgraph node methods */
end_comment

begin_decl_stmt
specifier|static
name|ng_constructor_t
name|ng_deflate_constructor
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|ng_rcvmsg_t
name|ng_deflate_rcvmsg
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|ng_shutdown_t
name|ng_deflate_shutdown
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|ng_newhook_t
name|ng_deflate_newhook
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|ng_rcvdata_t
name|ng_deflate_rcvdata
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|ng_disconnect_t
name|ng_deflate_disconnect
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* Helper functions */
end_comment

begin_function_decl
specifier|static
name|void
modifier|*
name|z_alloc
parameter_list|(
name|void
modifier|*
parameter_list|,
name|u_int
name|items
parameter_list|,
name|u_int
name|size
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|z_free
parameter_list|(
name|void
modifier|*
parameter_list|,
name|void
modifier|*
name|ptr
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|ng_deflate_compress
parameter_list|(
name|node_p
name|node
parameter_list|,
name|struct
name|mbuf
modifier|*
name|m
parameter_list|,
name|struct
name|mbuf
modifier|*
modifier|*
name|resultp
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|ng_deflate_decompress
parameter_list|(
name|node_p
name|node
parameter_list|,
name|struct
name|mbuf
modifier|*
name|m
parameter_list|,
name|struct
name|mbuf
modifier|*
modifier|*
name|resultp
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|ng_deflate_reset_req
parameter_list|(
name|node_p
name|node
parameter_list|)
function_decl|;
end_function_decl

begin_comment
comment|/* Parse type for struct ng_deflate_config. */
end_comment

begin_decl_stmt
specifier|static
specifier|const
name|struct
name|ng_parse_struct_field
name|ng_deflate_config_type_fields
index|[]
init|=
name|NG_DEFLATE_CONFIG_INFO
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
specifier|const
name|struct
name|ng_parse_type
name|ng_deflate_config_type
init|=
block|{
operator|&
name|ng_parse_struct_type
block|,
name|ng_deflate_config_type_fields
block|}
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* Parse type for struct ng_deflate_stat. */
end_comment

begin_decl_stmt
specifier|static
specifier|const
name|struct
name|ng_parse_struct_field
name|ng_deflate_stats_type_fields
index|[]
init|=
name|NG_DEFLATE_STATS_INFO
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
specifier|const
name|struct
name|ng_parse_type
name|ng_deflate_stat_type
init|=
block|{
operator|&
name|ng_parse_struct_type
block|,
name|ng_deflate_stats_type_fields
block|}
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* List of commands and how to convert arguments to/from ASCII. */
end_comment

begin_decl_stmt
specifier|static
specifier|const
name|struct
name|ng_cmdlist
name|ng_deflate_cmds
index|[]
init|=
block|{
block|{
name|NGM_DEFLATE_COOKIE
block|,
name|NGM_DEFLATE_CONFIG
block|,
literal|"config"
block|,
operator|&
name|ng_deflate_config_type
block|,
name|NULL
block|}
block|,
block|{
name|NGM_DEFLATE_COOKIE
block|,
name|NGM_DEFLATE_RESETREQ
block|,
literal|"resetreq"
block|,
name|NULL
block|,
name|NULL
block|}
block|,
block|{
name|NGM_DEFLATE_COOKIE
block|,
name|NGM_DEFLATE_GET_STATS
block|,
literal|"getstats"
block|,
name|NULL
block|,
operator|&
name|ng_deflate_stat_type
block|}
block|,
block|{
name|NGM_DEFLATE_COOKIE
block|,
name|NGM_DEFLATE_CLR_STATS
block|,
literal|"clrstats"
block|,
name|NULL
block|,
name|NULL
block|}
block|,
block|{
name|NGM_DEFLATE_COOKIE
block|,
name|NGM_DEFLATE_GETCLR_STATS
block|,
literal|"getclrstats"
block|,
name|NULL
block|,
operator|&
name|ng_deflate_stat_type
block|}
block|,
block|{
literal|0
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* Node type descriptor */
end_comment

begin_decl_stmt
specifier|static
name|struct
name|ng_type
name|ng_deflate_typestruct
init|=
block|{
operator|.
name|version
operator|=
name|NG_ABI_VERSION
block|,
operator|.
name|name
operator|=
name|NG_DEFLATE_NODE_TYPE
block|,
operator|.
name|constructor
operator|=
name|ng_deflate_constructor
block|,
operator|.
name|rcvmsg
operator|=
name|ng_deflate_rcvmsg
block|,
operator|.
name|shutdown
operator|=
name|ng_deflate_shutdown
block|,
operator|.
name|newhook
operator|=
name|ng_deflate_newhook
block|,
operator|.
name|rcvdata
operator|=
name|ng_deflate_rcvdata
block|,
operator|.
name|disconnect
operator|=
name|ng_deflate_disconnect
block|,
operator|.
name|cmdlist
operator|=
name|ng_deflate_cmds
block|, }
decl_stmt|;
end_decl_stmt

begin_expr_stmt
name|NETGRAPH_INIT
argument_list|(
name|deflate
argument_list|,
operator|&
name|ng_deflate_typestruct
argument_list|)
expr_stmt|;
end_expr_stmt

begin_comment
comment|/* Depend on separate zlib module. */
end_comment

begin_expr_stmt
name|MODULE_DEPEND
argument_list|(
name|ng_deflate
argument_list|,
name|zlib
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|)
expr_stmt|;
end_expr_stmt

begin_define
define|#
directive|define
name|ERROUT
parameter_list|(
name|x
parameter_list|)
value|do { error = (x); goto done; } while (0)
end_define

begin_comment
comment|/************************************************************************ 			NETGRAPH NODE STUFF  ************************************************************************/
end_comment

begin_comment
comment|/*  * Node type constructor  */
end_comment

begin_function
specifier|static
name|int
name|ng_deflate_constructor
parameter_list|(
name|node_p
name|node
parameter_list|)
block|{
name|priv_p
name|priv
decl_stmt|;
comment|/* Allocate private structure. */
name|priv
operator|=
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|priv
argument_list|)
argument_list|,
name|M_NETGRAPH_DEFLATE
argument_list|,
name|M_WAITOK
operator||
name|M_ZERO
argument_list|)
expr_stmt|;
name|NG_NODE_SET_PRIVATE
argument_list|(
name|node
argument_list|,
name|priv
argument_list|)
expr_stmt|;
comment|/* This node is not thread safe. */
name|NG_NODE_FORCE_WRITER
argument_list|(
name|node
argument_list|)
expr_stmt|;
comment|/* Done */
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Give our OK for a hook to be added.  */
end_comment

begin_function
specifier|static
name|int
name|ng_deflate_newhook
parameter_list|(
name|node_p
name|node
parameter_list|,
name|hook_p
name|hook
parameter_list|,
specifier|const
name|char
modifier|*
name|name
parameter_list|)
block|{
specifier|const
name|priv_p
name|priv
init|=
name|NG_NODE_PRIVATE
argument_list|(
name|node
argument_list|)
decl_stmt|;
if|if
condition|(
name|NG_NODE_NUMHOOKS
argument_list|(
name|node
argument_list|)
operator|>
literal|0
condition|)
return|return
operator|(
name|EINVAL
operator|)
return|;
if|if
condition|(
name|strcmp
argument_list|(
name|name
argument_list|,
name|NG_DEFLATE_HOOK_COMP
argument_list|)
operator|==
literal|0
condition|)
name|priv
operator|->
name|compress
operator|=
literal|1
expr_stmt|;
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|name
argument_list|,
name|NG_DEFLATE_HOOK_DECOMP
argument_list|)
operator|==
literal|0
condition|)
name|priv
operator|->
name|compress
operator|=
literal|0
expr_stmt|;
else|else
return|return
operator|(
name|EINVAL
operator|)
return|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Receive a control message  */
end_comment

begin_function
specifier|static
name|int
name|ng_deflate_rcvmsg
parameter_list|(
name|node_p
name|node
parameter_list|,
name|item_p
name|item
parameter_list|,
name|hook_p
name|lasthook
parameter_list|)
block|{
specifier|const
name|priv_p
name|priv
init|=
name|NG_NODE_PRIVATE
argument_list|(
name|node
argument_list|)
decl_stmt|;
name|struct
name|ng_mesg
modifier|*
name|resp
init|=
name|NULL
decl_stmt|;
name|int
name|error
init|=
literal|0
decl_stmt|;
name|struct
name|ng_mesg
modifier|*
name|msg
decl_stmt|;
name|NGI_GET_MSG
argument_list|(
name|item
argument_list|,
name|msg
argument_list|)
expr_stmt|;
if|if
condition|(
name|msg
operator|->
name|header
operator|.
name|typecookie
operator|!=
name|NGM_DEFLATE_COOKIE
condition|)
name|ERROUT
argument_list|(
name|EINVAL
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|msg
operator|->
name|header
operator|.
name|cmd
condition|)
block|{
case|case
name|NGM_DEFLATE_CONFIG
case|:
block|{
name|struct
name|ng_deflate_config
modifier|*
specifier|const
name|cfg
init|=
operator|(
expr|struct
name|ng_deflate_config
operator|*
operator|)
name|msg
operator|->
name|data
decl_stmt|;
comment|/* Check configuration. */
if|if
condition|(
name|msg
operator|->
name|header
operator|.
name|arglen
operator|!=
sizeof|sizeof
argument_list|(
operator|*
name|cfg
argument_list|)
condition|)
name|ERROUT
argument_list|(
name|EINVAL
argument_list|)
expr_stmt|;
if|if
condition|(
name|cfg
operator|->
name|enable
condition|)
block|{
if|if
condition|(
name|cfg
operator|->
name|windowBits
operator|<
literal|8
operator|||
name|cfg
operator|->
name|windowBits
operator|>
literal|15
condition|)
name|ERROUT
argument_list|(
name|EINVAL
argument_list|)
expr_stmt|;
block|}
else|else
name|cfg
operator|->
name|windowBits
operator|=
literal|0
expr_stmt|;
comment|/* Clear previous state. */
if|if
condition|(
name|priv
operator|->
name|cfg
operator|.
name|enable
condition|)
block|{
if|if
condition|(
name|priv
operator|->
name|compress
condition|)
name|deflateEnd
argument_list|(
operator|&
name|priv
operator|->
name|cx
argument_list|)
expr_stmt|;
else|else
name|inflateEnd
argument_list|(
operator|&
name|priv
operator|->
name|cx
argument_list|)
expr_stmt|;
name|priv
operator|->
name|cfg
operator|.
name|enable
operator|=
literal|0
expr_stmt|;
block|}
comment|/* Configuration is OK, reset to it. */
name|priv
operator|->
name|cfg
operator|=
operator|*
name|cfg
expr_stmt|;
if|if
condition|(
name|priv
operator|->
name|cfg
operator|.
name|enable
condition|)
block|{
name|priv
operator|->
name|cx
operator|.
name|next_in
operator|=
name|NULL
expr_stmt|;
name|priv
operator|->
name|cx
operator|.
name|zalloc
operator|=
name|z_alloc
expr_stmt|;
name|priv
operator|->
name|cx
operator|.
name|zfree
operator|=
name|z_free
expr_stmt|;
name|int
name|res
decl_stmt|;
if|if
condition|(
name|priv
operator|->
name|compress
condition|)
block|{
if|if
condition|(
operator|(
name|res
operator|=
name|deflateInit2
argument_list|(
operator|&
name|priv
operator|->
name|cx
argument_list|,
name|Z_DEFAULT_COMPRESSION
argument_list|,
name|Z_DEFLATED
argument_list|,
operator|-
name|cfg
operator|->
name|windowBits
argument_list|,
literal|8
argument_list|,
name|Z_DEFAULT_STRATEGY
argument_list|)
operator|)
operator|!=
name|Z_OK
condition|)
block|{
name|log
argument_list|(
name|LOG_NOTICE
argument_list|,
literal|"deflateInit2: error %d, %s\n"
argument_list|,
name|res
argument_list|,
name|priv
operator|->
name|cx
operator|.
name|msg
argument_list|)
expr_stmt|;
name|priv
operator|->
name|cfg
operator|.
name|enable
operator|=
literal|0
expr_stmt|;
name|ERROUT
argument_list|(
name|ENOMEM
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
if|if
condition|(
operator|(
name|res
operator|=
name|inflateInit2
argument_list|(
operator|&
name|priv
operator|->
name|cx
argument_list|,
operator|-
name|cfg
operator|->
name|windowBits
argument_list|)
operator|)
operator|!=
name|Z_OK
condition|)
block|{
name|log
argument_list|(
name|LOG_NOTICE
argument_list|,
literal|"inflateInit2: error %d, %s\n"
argument_list|,
name|res
argument_list|,
name|priv
operator|->
name|cx
operator|.
name|msg
argument_list|)
expr_stmt|;
name|priv
operator|->
name|cfg
operator|.
name|enable
operator|=
literal|0
expr_stmt|;
name|ERROUT
argument_list|(
name|ENOMEM
argument_list|)
expr_stmt|;
block|}
block|}
block|}
comment|/* Initialize other state. */
name|priv
operator|->
name|seqnum
operator|=
literal|0
expr_stmt|;
comment|/* Save return address so we can send reset-req's */
name|priv
operator|->
name|ctrlnode
operator|=
name|NGI_RETADDR
argument_list|(
name|item
argument_list|)
expr_stmt|;
break|break;
block|}
case|case
name|NGM_DEFLATE_RESETREQ
case|:
name|ng_deflate_reset_req
argument_list|(
name|node
argument_list|)
expr_stmt|;
break|break;
case|case
name|NGM_DEFLATE_GET_STATS
case|:
case|case
name|NGM_DEFLATE_CLR_STATS
case|:
case|case
name|NGM_DEFLATE_GETCLR_STATS
case|:
comment|/* Create response if requested. */
if|if
condition|(
name|msg
operator|->
name|header
operator|.
name|cmd
operator|!=
name|NGM_DEFLATE_CLR_STATS
condition|)
block|{
name|NG_MKRESPONSE
argument_list|(
name|resp
argument_list|,
name|msg
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|ng_deflate_stats
argument_list|)
argument_list|,
name|M_NOWAIT
argument_list|)
expr_stmt|;
if|if
condition|(
name|resp
operator|==
name|NULL
condition|)
name|ERROUT
argument_list|(
name|ENOMEM
argument_list|)
expr_stmt|;
name|bcopy
argument_list|(
operator|&
name|priv
operator|->
name|stats
argument_list|,
name|resp
operator|->
name|data
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|ng_deflate_stats
argument_list|)
argument_list|)
expr_stmt|;
block|}
comment|/* Clear stats if requested. */
if|if
condition|(
name|msg
operator|->
name|header
operator|.
name|cmd
operator|!=
name|NGM_DEFLATE_GET_STATS
condition|)
name|bzero
argument_list|(
operator|&
name|priv
operator|->
name|stats
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|ng_deflate_stats
argument_list|)
argument_list|)
expr_stmt|;
break|break;
default|default:
name|error
operator|=
name|EINVAL
expr_stmt|;
break|break;
block|}
name|done
label|:
name|NG_RESPOND_MSG
argument_list|(
name|error
argument_list|,
name|node
argument_list|,
name|item
argument_list|,
name|resp
argument_list|)
expr_stmt|;
name|NG_FREE_MSG
argument_list|(
name|msg
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Receive incoming data on our hook.  */
end_comment

begin_function
specifier|static
name|int
name|ng_deflate_rcvdata
parameter_list|(
name|hook_p
name|hook
parameter_list|,
name|item_p
name|item
parameter_list|)
block|{
specifier|const
name|node_p
name|node
init|=
name|NG_HOOK_NODE
argument_list|(
name|hook
argument_list|)
decl_stmt|;
specifier|const
name|priv_p
name|priv
init|=
name|NG_NODE_PRIVATE
argument_list|(
name|node
argument_list|)
decl_stmt|;
name|struct
name|mbuf
modifier|*
name|m
decl_stmt|,
modifier|*
name|out
decl_stmt|;
name|int
name|error
decl_stmt|;
if|if
condition|(
operator|!
name|priv
operator|->
name|cfg
operator|.
name|enable
condition|)
block|{
name|NG_FREE_ITEM
argument_list|(
name|item
argument_list|)
expr_stmt|;
return|return
operator|(
name|ENXIO
operator|)
return|;
block|}
name|NGI_GET_M
argument_list|(
name|item
argument_list|,
name|m
argument_list|)
expr_stmt|;
comment|/* Compress */
if|if
condition|(
name|priv
operator|->
name|compress
condition|)
block|{
if|if
condition|(
operator|(
name|error
operator|=
name|ng_deflate_compress
argument_list|(
name|node
argument_list|,
name|m
argument_list|,
operator|&
name|out
argument_list|)
operator|)
operator|!=
literal|0
condition|)
block|{
name|NG_FREE_ITEM
argument_list|(
name|item
argument_list|)
expr_stmt|;
name|log
argument_list|(
name|LOG_NOTICE
argument_list|,
literal|"%s: error: %d\n"
argument_list|,
name|__func__
argument_list|,
name|error
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
block|}
else|else
block|{
comment|/* Decompress */
if|if
condition|(
operator|(
name|error
operator|=
name|ng_deflate_decompress
argument_list|(
name|node
argument_list|,
name|m
argument_list|,
operator|&
name|out
argument_list|)
operator|)
operator|!=
literal|0
condition|)
block|{
name|NG_FREE_ITEM
argument_list|(
name|item
argument_list|)
expr_stmt|;
name|log
argument_list|(
name|LOG_NOTICE
argument_list|,
literal|"%s: error: %d\n"
argument_list|,
name|__func__
argument_list|,
name|error
argument_list|)
expr_stmt|;
if|if
condition|(
name|priv
operator|->
name|ctrlnode
operator|!=
literal|0
condition|)
block|{
name|struct
name|ng_mesg
modifier|*
name|msg
decl_stmt|;
comment|/* Need to send a reset-request. */
name|NG_MKMESSAGE
argument_list|(
name|msg
argument_list|,
name|NGM_DEFLATE_COOKIE
argument_list|,
name|NGM_DEFLATE_RESETREQ
argument_list|,
literal|0
argument_list|,
name|M_NOWAIT
argument_list|)
expr_stmt|;
if|if
condition|(
name|msg
operator|==
name|NULL
condition|)
return|return
operator|(
name|error
operator|)
return|;
name|NG_SEND_MSG_ID
argument_list|(
name|error
argument_list|,
name|node
argument_list|,
name|msg
argument_list|,
name|priv
operator|->
name|ctrlnode
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
return|return
operator|(
name|error
operator|)
return|;
block|}
block|}
name|NG_FWD_NEW_DATA
argument_list|(
name|error
argument_list|,
name|item
argument_list|,
name|hook
argument_list|,
name|out
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Destroy node.  */
end_comment

begin_function
specifier|static
name|int
name|ng_deflate_shutdown
parameter_list|(
name|node_p
name|node
parameter_list|)
block|{
specifier|const
name|priv_p
name|priv
init|=
name|NG_NODE_PRIVATE
argument_list|(
name|node
argument_list|)
decl_stmt|;
comment|/* Take down netgraph node. */
if|if
condition|(
name|priv
operator|->
name|cfg
operator|.
name|enable
condition|)
block|{
if|if
condition|(
name|priv
operator|->
name|compress
condition|)
name|deflateEnd
argument_list|(
operator|&
name|priv
operator|->
name|cx
argument_list|)
expr_stmt|;
else|else
name|inflateEnd
argument_list|(
operator|&
name|priv
operator|->
name|cx
argument_list|)
expr_stmt|;
block|}
name|free
argument_list|(
name|priv
argument_list|,
name|M_NETGRAPH_DEFLATE
argument_list|)
expr_stmt|;
name|NG_NODE_SET_PRIVATE
argument_list|(
name|node
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|NG_NODE_UNREF
argument_list|(
name|node
argument_list|)
expr_stmt|;
comment|/* let the node escape */
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Hook disconnection  */
end_comment

begin_function
specifier|static
name|int
name|ng_deflate_disconnect
parameter_list|(
name|hook_p
name|hook
parameter_list|)
block|{
specifier|const
name|node_p
name|node
init|=
name|NG_HOOK_NODE
argument_list|(
name|hook
argument_list|)
decl_stmt|;
specifier|const
name|priv_p
name|priv
init|=
name|NG_NODE_PRIVATE
argument_list|(
name|node
argument_list|)
decl_stmt|;
if|if
condition|(
name|priv
operator|->
name|cfg
operator|.
name|enable
condition|)
block|{
if|if
condition|(
name|priv
operator|->
name|compress
condition|)
name|deflateEnd
argument_list|(
operator|&
name|priv
operator|->
name|cx
argument_list|)
expr_stmt|;
else|else
name|inflateEnd
argument_list|(
operator|&
name|priv
operator|->
name|cx
argument_list|)
expr_stmt|;
name|priv
operator|->
name|cfg
operator|.
name|enable
operator|=
literal|0
expr_stmt|;
block|}
comment|/* Go away if no longer connected. */
if|if
condition|(
operator|(
name|NG_NODE_NUMHOOKS
argument_list|(
name|node
argument_list|)
operator|==
literal|0
operator|)
operator|&&
name|NG_NODE_IS_VALID
argument_list|(
name|node
argument_list|)
condition|)
name|ng_rmnode_self
argument_list|(
name|node
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_comment
comment|/************************************************************************ 			HELPER STUFF  ************************************************************************/
end_comment

begin_comment
comment|/*  * Space allocation and freeing routines for use by zlib routines.  */
end_comment

begin_function
specifier|static
name|void
modifier|*
name|z_alloc
parameter_list|(
name|void
modifier|*
name|notused
parameter_list|,
name|u_int
name|items
parameter_list|,
name|u_int
name|size
parameter_list|)
block|{
return|return
operator|(
name|malloc
argument_list|(
name|items
operator|*
name|size
argument_list|,
name|M_NETGRAPH_DEFLATE
argument_list|,
name|M_NOWAIT
argument_list|)
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|z_free
parameter_list|(
name|void
modifier|*
name|notused
parameter_list|,
name|void
modifier|*
name|ptr
parameter_list|)
block|{
name|free
argument_list|(
name|ptr
argument_list|,
name|M_NETGRAPH_DEFLATE
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * Compress/encrypt a packet and put the result in a new mbuf at *resultp.  * The original mbuf is not free'd.  */
end_comment

begin_function
specifier|static
name|int
name|ng_deflate_compress
parameter_list|(
name|node_p
name|node
parameter_list|,
name|struct
name|mbuf
modifier|*
name|m
parameter_list|,
name|struct
name|mbuf
modifier|*
modifier|*
name|resultp
parameter_list|)
block|{
specifier|const
name|priv_p
name|priv
init|=
name|NG_NODE_PRIVATE
argument_list|(
name|node
argument_list|)
decl_stmt|;
name|int
name|outlen
decl_stmt|,
name|inlen
decl_stmt|;
name|int
name|rtn
decl_stmt|;
comment|/* Initialize. */
operator|*
name|resultp
operator|=
name|NULL
expr_stmt|;
name|inlen
operator|=
name|m
operator|->
name|m_pkthdr
operator|.
name|len
expr_stmt|;
name|priv
operator|->
name|stats
operator|.
name|FramesPlain
operator|++
expr_stmt|;
name|priv
operator|->
name|stats
operator|.
name|InOctets
operator|+=
name|inlen
expr_stmt|;
if|if
condition|(
name|inlen
operator|>
name|DEFLATE_BUF_SIZE
condition|)
block|{
name|priv
operator|->
name|stats
operator|.
name|Errors
operator|++
expr_stmt|;
name|NG_FREE_M
argument_list|(
name|m
argument_list|)
expr_stmt|;
return|return
operator|(
name|ENOMEM
operator|)
return|;
block|}
comment|/* We must own the mbuf chain exclusively to modify it. */
name|m
operator|=
name|m_unshare
argument_list|(
name|m
argument_list|,
name|M_DONTWAIT
argument_list|)
expr_stmt|;
if|if
condition|(
name|m
operator|==
name|NULL
condition|)
block|{
name|priv
operator|->
name|stats
operator|.
name|Errors
operator|++
expr_stmt|;
return|return
operator|(
name|ENOMEM
operator|)
return|;
block|}
comment|/* Work with contiguous regions of memory. */
name|m_copydata
argument_list|(
name|m
argument_list|,
literal|0
argument_list|,
name|inlen
argument_list|,
operator|(
name|caddr_t
operator|)
name|priv
operator|->
name|inbuf
argument_list|)
expr_stmt|;
name|outlen
operator|=
name|DEFLATE_BUF_SIZE
expr_stmt|;
comment|/* Compress "inbuf" into "outbuf". */
comment|/* Prepare to compress. */
if|if
condition|(
name|priv
operator|->
name|inbuf
index|[
literal|0
index|]
operator|!=
literal|0
condition|)
block|{
name|priv
operator|->
name|cx
operator|.
name|next_in
operator|=
name|priv
operator|->
name|inbuf
expr_stmt|;
name|priv
operator|->
name|cx
operator|.
name|avail_in
operator|=
name|inlen
expr_stmt|;
block|}
else|else
block|{
name|priv
operator|->
name|cx
operator|.
name|next_in
operator|=
name|priv
operator|->
name|inbuf
operator|+
literal|1
expr_stmt|;
comment|/* compress protocol */
name|priv
operator|->
name|cx
operator|.
name|avail_in
operator|=
name|inlen
operator|-
literal|1
expr_stmt|;
block|}
name|priv
operator|->
name|cx
operator|.
name|next_out
operator|=
name|priv
operator|->
name|outbuf
operator|+
literal|2
operator|+
name|DEFLATE_HDRLEN
expr_stmt|;
name|priv
operator|->
name|cx
operator|.
name|avail_out
operator|=
name|outlen
operator|-
literal|2
operator|-
name|DEFLATE_HDRLEN
expr_stmt|;
comment|/* Compress. */
name|rtn
operator|=
name|deflate
argument_list|(
operator|&
name|priv
operator|->
name|cx
argument_list|,
name|Z_PACKET_FLUSH
argument_list|)
expr_stmt|;
comment|/* Check return value. */
if|if
condition|(
name|rtn
operator|!=
name|Z_OK
condition|)
block|{
name|priv
operator|->
name|stats
operator|.
name|Errors
operator|++
expr_stmt|;
name|log
argument_list|(
name|LOG_NOTICE
argument_list|,
literal|"ng_deflate: compression error: %d (%s)\n"
argument_list|,
name|rtn
argument_list|,
name|priv
operator|->
name|cx
operator|.
name|msg
argument_list|)
expr_stmt|;
name|NG_FREE_M
argument_list|(
name|m
argument_list|)
expr_stmt|;
return|return
operator|(
name|EINVAL
operator|)
return|;
block|}
comment|/* Calculate resulting size. */
name|outlen
operator|-=
name|priv
operator|->
name|cx
operator|.
name|avail_out
expr_stmt|;
comment|/* If we can't compress this packet, send it as-is. */
if|if
condition|(
name|outlen
operator|>
name|inlen
condition|)
block|{
comment|/* Return original packet uncompressed. */
operator|*
name|resultp
operator|=
name|m
expr_stmt|;
name|priv
operator|->
name|stats
operator|.
name|FramesUncomp
operator|++
expr_stmt|;
name|priv
operator|->
name|stats
operator|.
name|OutOctets
operator|+=
name|inlen
expr_stmt|;
block|}
else|else
block|{
comment|/* Install header. */
name|be16enc
argument_list|(
name|priv
operator|->
name|outbuf
argument_list|,
name|PROT_COMPD
argument_list|)
expr_stmt|;
name|be16enc
argument_list|(
name|priv
operator|->
name|outbuf
operator|+
literal|2
argument_list|,
name|priv
operator|->
name|seqnum
argument_list|)
expr_stmt|;
comment|/* Return packet in an mbuf. */
name|m_copyback
argument_list|(
name|m
argument_list|,
literal|0
argument_list|,
name|outlen
argument_list|,
operator|(
name|caddr_t
operator|)
name|priv
operator|->
name|outbuf
argument_list|)
expr_stmt|;
if|if
condition|(
name|m
operator|->
name|m_pkthdr
operator|.
name|len
operator|<
name|outlen
condition|)
block|{
name|m_freem
argument_list|(
name|m
argument_list|)
expr_stmt|;
name|priv
operator|->
name|stats
operator|.
name|Errors
operator|++
expr_stmt|;
return|return
operator|(
name|ENOMEM
operator|)
return|;
block|}
elseif|else
if|if
condition|(
name|outlen
operator|<
name|m
operator|->
name|m_pkthdr
operator|.
name|len
condition|)
name|m_adj
argument_list|(
name|m
argument_list|,
name|outlen
operator|-
name|m
operator|->
name|m_pkthdr
operator|.
name|len
argument_list|)
expr_stmt|;
operator|*
name|resultp
operator|=
name|m
expr_stmt|;
name|priv
operator|->
name|stats
operator|.
name|FramesComp
operator|++
expr_stmt|;
name|priv
operator|->
name|stats
operator|.
name|OutOctets
operator|+=
name|outlen
expr_stmt|;
block|}
comment|/* Update sequence number. */
name|priv
operator|->
name|seqnum
operator|++
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Decompress/decrypt packet and put the result in a new mbuf at *resultp.  * The original mbuf is not free'd.  */
end_comment

begin_function
specifier|static
name|int
name|ng_deflate_decompress
parameter_list|(
name|node_p
name|node
parameter_list|,
name|struct
name|mbuf
modifier|*
name|m
parameter_list|,
name|struct
name|mbuf
modifier|*
modifier|*
name|resultp
parameter_list|)
block|{
specifier|const
name|priv_p
name|priv
init|=
name|NG_NODE_PRIVATE
argument_list|(
name|node
argument_list|)
decl_stmt|;
name|int
name|outlen
decl_stmt|,
name|inlen
decl_stmt|;
name|int
name|rtn
decl_stmt|;
name|uint16_t
name|proto
decl_stmt|;
name|int
name|offset
decl_stmt|;
name|uint16_t
name|rseqnum
decl_stmt|;
comment|/* Initialize. */
operator|*
name|resultp
operator|=
name|NULL
expr_stmt|;
name|inlen
operator|=
name|m
operator|->
name|m_pkthdr
operator|.
name|len
expr_stmt|;
if|if
condition|(
name|inlen
operator|>
name|DEFLATE_BUF_SIZE
condition|)
block|{
name|priv
operator|->
name|stats
operator|.
name|Errors
operator|++
expr_stmt|;
name|NG_FREE_M
argument_list|(
name|m
argument_list|)
expr_stmt|;
name|priv
operator|->
name|seqnum
operator|=
literal|0
expr_stmt|;
return|return
operator|(
name|ENOMEM
operator|)
return|;
block|}
comment|/* We must own the mbuf chain exclusively to modify it. */
name|m
operator|=
name|m_unshare
argument_list|(
name|m
argument_list|,
name|M_DONTWAIT
argument_list|)
expr_stmt|;
if|if
condition|(
name|m
operator|==
name|NULL
condition|)
block|{
name|priv
operator|->
name|stats
operator|.
name|Errors
operator|++
expr_stmt|;
return|return
operator|(
name|ENOMEM
operator|)
return|;
block|}
comment|/* Work with contiguous regions of memory. */
name|m_copydata
argument_list|(
name|m
argument_list|,
literal|0
argument_list|,
name|inlen
argument_list|,
operator|(
name|caddr_t
operator|)
name|priv
operator|->
name|inbuf
argument_list|)
expr_stmt|;
comment|/* Separate proto. */
if|if
condition|(
operator|(
name|priv
operator|->
name|inbuf
index|[
literal|0
index|]
operator|&
literal|0x01
operator|)
operator|!=
literal|0
condition|)
block|{
name|proto
operator|=
name|priv
operator|->
name|inbuf
index|[
literal|0
index|]
expr_stmt|;
name|offset
operator|=
literal|1
expr_stmt|;
block|}
else|else
block|{
name|proto
operator|=
name|be16dec
argument_list|(
name|priv
operator|->
name|inbuf
argument_list|)
expr_stmt|;
name|offset
operator|=
literal|2
expr_stmt|;
block|}
name|priv
operator|->
name|stats
operator|.
name|InOctets
operator|+=
name|inlen
expr_stmt|;
comment|/* Packet is compressed, so decompress. */
if|if
condition|(
name|proto
operator|==
name|PROT_COMPD
condition|)
block|{
name|priv
operator|->
name|stats
operator|.
name|FramesComp
operator|++
expr_stmt|;
comment|/* Check sequence number. */
name|rseqnum
operator|=
name|be16dec
argument_list|(
name|priv
operator|->
name|inbuf
operator|+
name|offset
argument_list|)
expr_stmt|;
name|offset
operator|+=
literal|2
expr_stmt|;
if|if
condition|(
name|rseqnum
operator|!=
name|priv
operator|->
name|seqnum
condition|)
block|{
name|priv
operator|->
name|stats
operator|.
name|Errors
operator|++
expr_stmt|;
name|log
argument_list|(
name|LOG_NOTICE
argument_list|,
literal|"ng_deflate: wrong sequence: %u "
literal|"instead of %u\n"
argument_list|,
name|rseqnum
argument_list|,
name|priv
operator|->
name|seqnum
argument_list|)
expr_stmt|;
name|NG_FREE_M
argument_list|(
name|m
argument_list|)
expr_stmt|;
name|priv
operator|->
name|seqnum
operator|=
literal|0
expr_stmt|;
return|return
operator|(
name|EPIPE
operator|)
return|;
block|}
name|outlen
operator|=
name|DEFLATE_BUF_SIZE
expr_stmt|;
comment|/* Decompress "inbuf" into "outbuf". */
comment|/* Prepare to decompress. */
name|priv
operator|->
name|cx
operator|.
name|next_in
operator|=
name|priv
operator|->
name|inbuf
operator|+
name|offset
expr_stmt|;
name|priv
operator|->
name|cx
operator|.
name|avail_in
operator|=
name|inlen
operator|-
name|offset
expr_stmt|;
comment|/* Reserve space for protocol decompression. */
name|priv
operator|->
name|cx
operator|.
name|next_out
operator|=
name|priv
operator|->
name|outbuf
operator|+
literal|1
expr_stmt|;
name|priv
operator|->
name|cx
operator|.
name|avail_out
operator|=
name|outlen
operator|-
literal|1
expr_stmt|;
comment|/* Decompress. */
name|rtn
operator|=
name|inflate
argument_list|(
operator|&
name|priv
operator|->
name|cx
argument_list|,
name|Z_PACKET_FLUSH
argument_list|)
expr_stmt|;
comment|/* Check return value. */
if|if
condition|(
name|rtn
operator|!=
name|Z_OK
operator|&&
name|rtn
operator|!=
name|Z_STREAM_END
condition|)
block|{
name|priv
operator|->
name|stats
operator|.
name|Errors
operator|++
expr_stmt|;
name|NG_FREE_M
argument_list|(
name|m
argument_list|)
expr_stmt|;
name|priv
operator|->
name|seqnum
operator|=
literal|0
expr_stmt|;
name|log
argument_list|(
name|LOG_NOTICE
argument_list|,
literal|"%s: decompression error: %d (%s)\n"
argument_list|,
name|__func__
argument_list|,
name|rtn
argument_list|,
name|priv
operator|->
name|cx
operator|.
name|msg
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|rtn
condition|)
block|{
case|case
name|Z_MEM_ERROR
case|:
return|return
operator|(
name|ENOMEM
operator|)
return|;
case|case
name|Z_DATA_ERROR
case|:
return|return
operator|(
name|EIO
operator|)
return|;
default|default:
return|return
operator|(
name|EINVAL
operator|)
return|;
block|}
block|}
comment|/* Calculate resulting size. */
name|outlen
operator|-=
name|priv
operator|->
name|cx
operator|.
name|avail_out
expr_stmt|;
comment|/* Decompress protocol. */
if|if
condition|(
operator|(
name|priv
operator|->
name|outbuf
index|[
literal|1
index|]
operator|&
literal|0x01
operator|)
operator|!=
literal|0
condition|)
block|{
name|priv
operator|->
name|outbuf
index|[
literal|0
index|]
operator|=
literal|0
expr_stmt|;
comment|/* Return packet in an mbuf. */
name|m_copyback
argument_list|(
name|m
argument_list|,
literal|0
argument_list|,
name|outlen
argument_list|,
operator|(
name|caddr_t
operator|)
name|priv
operator|->
name|outbuf
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|outlen
operator|--
expr_stmt|;
comment|/* Return packet in an mbuf. */
name|m_copyback
argument_list|(
name|m
argument_list|,
literal|0
argument_list|,
name|outlen
argument_list|,
call|(
name|caddr_t
call|)
argument_list|(
name|priv
operator|->
name|outbuf
operator|+
literal|1
argument_list|)
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|m
operator|->
name|m_pkthdr
operator|.
name|len
operator|<
name|outlen
condition|)
block|{
name|m_freem
argument_list|(
name|m
argument_list|)
expr_stmt|;
name|priv
operator|->
name|stats
operator|.
name|Errors
operator|++
expr_stmt|;
name|priv
operator|->
name|seqnum
operator|=
literal|0
expr_stmt|;
return|return
operator|(
name|ENOMEM
operator|)
return|;
block|}
elseif|else
if|if
condition|(
name|outlen
operator|<
name|m
operator|->
name|m_pkthdr
operator|.
name|len
condition|)
name|m_adj
argument_list|(
name|m
argument_list|,
name|outlen
operator|-
name|m
operator|->
name|m_pkthdr
operator|.
name|len
argument_list|)
expr_stmt|;
operator|*
name|resultp
operator|=
name|m
expr_stmt|;
name|priv
operator|->
name|stats
operator|.
name|FramesPlain
operator|++
expr_stmt|;
name|priv
operator|->
name|stats
operator|.
name|OutOctets
operator|+=
name|outlen
expr_stmt|;
block|}
else|else
block|{
comment|/* Packet is not compressed, just update dictionary. */
name|priv
operator|->
name|stats
operator|.
name|FramesUncomp
operator|++
expr_stmt|;
if|if
condition|(
name|priv
operator|->
name|inbuf
index|[
literal|0
index|]
operator|==
literal|0
condition|)
block|{
name|priv
operator|->
name|cx
operator|.
name|next_in
operator|=
name|priv
operator|->
name|inbuf
operator|+
literal|1
expr_stmt|;
comment|/* compress protocol */
name|priv
operator|->
name|cx
operator|.
name|avail_in
operator|=
name|inlen
operator|-
literal|1
expr_stmt|;
block|}
else|else
block|{
name|priv
operator|->
name|cx
operator|.
name|next_in
operator|=
name|priv
operator|->
name|inbuf
expr_stmt|;
name|priv
operator|->
name|cx
operator|.
name|avail_in
operator|=
name|inlen
expr_stmt|;
block|}
name|rtn
operator|=
name|inflateIncomp
argument_list|(
operator|&
name|priv
operator|->
name|cx
argument_list|)
expr_stmt|;
comment|/* Check return value */
if|if
condition|(
name|rtn
operator|!=
name|Z_OK
condition|)
block|{
name|priv
operator|->
name|stats
operator|.
name|Errors
operator|++
expr_stmt|;
name|log
argument_list|(
name|LOG_NOTICE
argument_list|,
literal|"%s: inflateIncomp error: %d (%s)\n"
argument_list|,
name|__func__
argument_list|,
name|rtn
argument_list|,
name|priv
operator|->
name|cx
operator|.
name|msg
argument_list|)
expr_stmt|;
name|NG_FREE_M
argument_list|(
name|m
argument_list|)
expr_stmt|;
name|priv
operator|->
name|seqnum
operator|=
literal|0
expr_stmt|;
return|return
operator|(
name|EINVAL
operator|)
return|;
block|}
operator|*
name|resultp
operator|=
name|m
expr_stmt|;
name|priv
operator|->
name|stats
operator|.
name|FramesPlain
operator|++
expr_stmt|;
name|priv
operator|->
name|stats
operator|.
name|OutOctets
operator|+=
name|inlen
expr_stmt|;
block|}
comment|/* Update sequence number. */
name|priv
operator|->
name|seqnum
operator|++
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * The peer has sent us a CCP ResetRequest, so reset our transmit state.  */
end_comment

begin_function
specifier|static
name|void
name|ng_deflate_reset_req
parameter_list|(
name|node_p
name|node
parameter_list|)
block|{
specifier|const
name|priv_p
name|priv
init|=
name|NG_NODE_PRIVATE
argument_list|(
name|node
argument_list|)
decl_stmt|;
name|priv
operator|->
name|seqnum
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|priv
operator|->
name|cfg
operator|.
name|enable
condition|)
block|{
if|if
condition|(
name|priv
operator|->
name|compress
condition|)
name|deflateReset
argument_list|(
operator|&
name|priv
operator|->
name|cx
argument_list|)
expr_stmt|;
else|else
name|inflateReset
argument_list|(
operator|&
name|priv
operator|->
name|cx
argument_list|)
expr_stmt|;
block|}
block|}
end_function

end_unit


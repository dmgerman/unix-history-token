begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*-  * Copyright (c) 2001-2002  *	Fraunhofer Institute for Open Communication Systems (FhG Fokus).  *	All rights reserved.  * Copyright (c) 2003-2004  *	Hartmut Brandt  *	All rights reserved.  *  * Author: Harti Brandt<harti@freebsd.org>  *  * Redistribution of this software and documentation and use in source and  * binary forms, with or without modification, are permitted provided that  * the following conditions are met:  *  * 1. Redistributions of source code or documentation must retain the above  *    copyright notice, this list of conditions and the following disclaimer.  * 2. Redistributions in binary form must reproduce the above copyright  *    notice, this list of conditions and the following disclaimer in the  *    documentation and/or other materials provided with the distribution.  *  * THIS SOFTWARE AND DOCUMENTATION IS PROVIDED BY THE AUTHOR  * AND ITS CONTRIBUTORS ``AS IS'' AND ANY EXPRESS OR IMPLIED WARRANTIES,  * INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND  * FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED.  IN NO EVENT SHALL  * THE AUTHOR OR ITS CONTRIBUTORS  BE LIABLE FOR ANY DIRECT, INDIRECT,  * INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT  * LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA,  * OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF  * LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING  * NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE,  * EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.  *  * $FreeBSD$  *  * ATM call control and API  */
end_comment

begin_include
include|#
directive|include
file|<sys/cdefs.h>
end_include

begin_expr_stmt
name|__FBSDID
argument_list|(
literal|"$FreeBSD$"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_include
include|#
directive|include
file|<sys/param.h>
end_include

begin_include
include|#
directive|include
file|<sys/systm.h>
end_include

begin_include
include|#
directive|include
file|<sys/kernel.h>
end_include

begin_include
include|#
directive|include
file|<sys/malloc.h>
end_include

begin_include
include|#
directive|include
file|<sys/mbuf.h>
end_include

begin_include
include|#
directive|include
file|<sys/errno.h>
end_include

begin_include
include|#
directive|include
file|<sys/socket.h>
end_include

begin_include
include|#
directive|include
file|<sys/socketvar.h>
end_include

begin_include
include|#
directive|include
file|<sys/sbuf.h>
end_include

begin_include
include|#
directive|include
file|<machine/stdarg.h>
end_include

begin_include
include|#
directive|include
file|<netgraph/ng_message.h>
end_include

begin_include
include|#
directive|include
file|<netgraph/netgraph.h>
end_include

begin_include
include|#
directive|include
file|<netgraph/ng_parse.h>
end_include

begin_include
include|#
directive|include
file|<netnatm/unimsg.h>
end_include

begin_include
include|#
directive|include
file|<netnatm/msg/unistruct.h>
end_include

begin_include
include|#
directive|include
file|<netnatm/api/unisap.h>
end_include

begin_include
include|#
directive|include
file|<netnatm/sig/unidef.h>
end_include

begin_include
include|#
directive|include
file|<netgraph/atm/ngatmbase.h>
end_include

begin_include
include|#
directive|include
file|<netgraph/atm/ng_uni.h>
end_include

begin_include
include|#
directive|include
file|<netnatm/api/atmapi.h>
end_include

begin_include
include|#
directive|include
file|<netgraph/atm/ng_ccatm.h>
end_include

begin_include
include|#
directive|include
file|<netnatm/api/ccatm.h>
end_include

begin_expr_stmt
name|MODULE_DEPEND
argument_list|(
name|ng_ccatm
argument_list|,
name|ngatmbase
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|MALLOC_DEFINE
argument_list|(
name|M_NG_CCATM
argument_list|,
literal|"ng_ccatm"
argument_list|,
literal|"netgraph uni api node"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_comment
comment|/*  * Command structure parsing  */
end_comment

begin_comment
comment|/* ESI */
end_comment

begin_decl_stmt
specifier|static
specifier|const
name|struct
name|ng_parse_fixedarray_info
name|ng_ccatm_esi_type_info
init|=
name|NGM_CCATM_ESI_INFO
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
specifier|const
name|struct
name|ng_parse_type
name|ng_ccatm_esi_type
init|=
block|{
operator|&
name|ng_parse_fixedarray_type
block|,
operator|&
name|ng_ccatm_esi_type_info
block|}
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* PORT PARAMETERS */
end_comment

begin_decl_stmt
specifier|static
specifier|const
name|struct
name|ng_parse_struct_field
name|ng_ccatm_atm_port_type_info
index|[]
init|=
name|NGM_CCATM_ATM_PORT_INFO
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
specifier|const
name|struct
name|ng_parse_type
name|ng_ccatm_atm_port_type
init|=
block|{
operator|&
name|ng_parse_struct_type
block|,
name|ng_ccatm_atm_port_type_info
block|}
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* PORT structure */
end_comment

begin_decl_stmt
specifier|static
specifier|const
name|struct
name|ng_parse_struct_field
name|ng_ccatm_port_type_info
index|[]
init|=
name|NGM_CCATM_PORT_INFO
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
specifier|const
name|struct
name|ng_parse_type
name|ng_ccatm_port_type
init|=
block|{
operator|&
name|ng_parse_struct_type
block|,
name|ng_ccatm_port_type_info
block|}
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* the ADDRESS array itself */
end_comment

begin_decl_stmt
specifier|static
specifier|const
name|struct
name|ng_parse_fixedarray_info
name|ng_ccatm_addr_array_type_info
init|=
name|NGM_CCATM_ADDR_ARRAY_INFO
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
specifier|const
name|struct
name|ng_parse_type
name|ng_ccatm_addr_array_type
init|=
block|{
operator|&
name|ng_parse_fixedarray_type
block|,
operator|&
name|ng_ccatm_addr_array_type_info
block|}
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* one ADDRESS */
end_comment

begin_decl_stmt
specifier|static
specifier|const
name|struct
name|ng_parse_struct_field
name|ng_ccatm_uni_addr_type_info
index|[]
init|=
name|NGM_CCATM_UNI_ADDR_INFO
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
specifier|const
name|struct
name|ng_parse_type
name|ng_ccatm_uni_addr_type
init|=
block|{
operator|&
name|ng_parse_struct_type
block|,
name|ng_ccatm_uni_addr_type_info
block|}
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* ADDRESS request */
end_comment

begin_decl_stmt
specifier|static
specifier|const
name|struct
name|ng_parse_struct_field
name|ng_ccatm_addr_req_type_info
index|[]
init|=
name|NGM_CCATM_ADDR_REQ_INFO
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
specifier|const
name|struct
name|ng_parse_type
name|ng_ccatm_addr_req_type
init|=
block|{
operator|&
name|ng_parse_struct_type
block|,
name|ng_ccatm_addr_req_type_info
block|}
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* ADDRESS var-array */
end_comment

begin_function
specifier|static
name|int
name|ng_ccatm_addr_req_array_getlen
parameter_list|(
specifier|const
name|struct
name|ng_parse_type
modifier|*
name|type
parameter_list|,
specifier|const
name|u_char
modifier|*
name|start
parameter_list|,
specifier|const
name|u_char
modifier|*
name|buf
parameter_list|)
block|{
specifier|const
name|struct
name|ngm_ccatm_get_addresses
modifier|*
name|p
decl_stmt|;
name|p
operator|=
operator|(
specifier|const
expr|struct
name|ngm_ccatm_get_addresses
operator|*
operator|)
operator|(
name|buf
operator|-
name|offsetof
argument_list|(
expr|struct
name|ngm_ccatm_get_addresses
argument_list|,
name|addr
argument_list|)
operator|)
expr_stmt|;
return|return
operator|(
name|p
operator|->
name|count
operator|)
return|;
block|}
end_function

begin_decl_stmt
specifier|static
specifier|const
name|struct
name|ng_parse_array_info
name|ng_ccatm_addr_req_array_type_info
init|=
name|NGM_CCATM_ADDR_REQ_ARRAY_INFO
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
specifier|const
name|struct
name|ng_parse_type
name|ng_ccatm_addr_req_array_type
init|=
block|{
operator|&
name|ng_parse_array_type
block|,
operator|&
name|ng_ccatm_addr_req_array_type_info
block|}
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* Outer get_ADDRESSes structure */
end_comment

begin_decl_stmt
specifier|static
specifier|const
name|struct
name|ng_parse_struct_field
name|ng_ccatm_get_addresses_type_info
index|[]
init|=
name|NGM_CCATM_GET_ADDRESSES_INFO
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
specifier|const
name|struct
name|ng_parse_type
name|ng_ccatm_get_addresses_type
init|=
block|{
operator|&
name|ng_parse_struct_type
block|,
name|ng_ccatm_get_addresses_type_info
block|}
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* Port array */
end_comment

begin_function
specifier|static
name|int
name|ng_ccatm_port_array_getlen
parameter_list|(
specifier|const
name|struct
name|ng_parse_type
modifier|*
name|type
parameter_list|,
specifier|const
name|u_char
modifier|*
name|start
parameter_list|,
specifier|const
name|u_char
modifier|*
name|buf
parameter_list|)
block|{
specifier|const
name|struct
name|ngm_ccatm_portlist
modifier|*
name|p
decl_stmt|;
name|p
operator|=
operator|(
specifier|const
expr|struct
name|ngm_ccatm_portlist
operator|*
operator|)
operator|(
name|buf
operator|-
name|offsetof
argument_list|(
expr|struct
name|ngm_ccatm_portlist
argument_list|,
name|ports
argument_list|)
operator|)
expr_stmt|;
return|return
operator|(
name|p
operator|->
name|nports
operator|)
return|;
block|}
end_function

begin_decl_stmt
specifier|static
specifier|const
name|struct
name|ng_parse_array_info
name|ng_ccatm_port_array_type_info
init|=
name|NGM_CCATM_PORT_ARRAY_INFO
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
specifier|const
name|struct
name|ng_parse_type
name|ng_ccatm_port_array_type
init|=
block|{
operator|&
name|ng_parse_array_type
block|,
operator|&
name|ng_ccatm_port_array_type_info
block|}
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* Portlist structure */
end_comment

begin_decl_stmt
specifier|static
specifier|const
name|struct
name|ng_parse_struct_field
name|ng_ccatm_portlist_type_info
index|[]
init|=
name|NGM_CCATM_PORTLIST_INFO
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
specifier|const
name|struct
name|ng_parse_type
name|ng_ccatm_portlist_type
init|=
block|{
operator|&
name|ng_parse_struct_type
block|,
name|ng_ccatm_portlist_type_info
block|}
decl_stmt|;
end_decl_stmt

begin_comment
comment|/*  * Command list  */
end_comment

begin_decl_stmt
specifier|static
specifier|const
name|struct
name|ng_cmdlist
name|ng_ccatm_cmdlist
index|[]
init|=
block|{
block|{
name|NGM_CCATM_COOKIE
block|,
name|NGM_CCATM_DUMP
block|,
literal|"dump"
block|,
name|NULL
block|,
name|NULL
block|}
block|,
block|{
name|NGM_CCATM_COOKIE
block|,
name|NGM_CCATM_STOP
block|,
literal|"stop"
block|,
operator|&
name|ng_ccatm_port_type
block|,
name|NULL
block|}
block|,
block|{
name|NGM_CCATM_COOKIE
block|,
name|NGM_CCATM_START
block|,
literal|"start"
block|,
operator|&
name|ng_ccatm_port_type
block|,
name|NULL
block|}
block|,
block|{
name|NGM_CCATM_COOKIE
block|,
name|NGM_CCATM_GETSTATE
block|,
literal|"getstate"
block|,
operator|&
name|ng_ccatm_port_type
block|,
operator|&
name|ng_parse_uint32_type
block|}
block|,
block|{
name|NGM_CCATM_COOKIE
block|,
name|NGM_CCATM_GET_ADDRESSES
block|,
literal|"get_addresses"
block|,
operator|&
name|ng_ccatm_port_type
block|,
operator|&
name|ng_ccatm_get_addresses_type
block|}
block|,
block|{
name|NGM_CCATM_COOKIE
block|,
name|NGM_CCATM_CLEAR
block|,
literal|"clear"
block|,
operator|&
name|ng_ccatm_port_type
block|,
name|NULL
block|}
block|,
block|{
name|NGM_CCATM_COOKIE
block|,
name|NGM_CCATM_ADDRESS_REGISTERED
block|,
literal|"address_reg"
block|,
operator|&
name|ng_ccatm_addr_req_type
block|,
name|NULL
block|}
block|,
block|{
name|NGM_CCATM_COOKIE
block|,
name|NGM_CCATM_ADDRESS_UNREGISTERED
block|,
literal|"address_unreg"
block|,
operator|&
name|ng_ccatm_addr_req_type
block|,
name|NULL
block|}
block|,
block|{
name|NGM_CCATM_COOKIE
block|,
name|NGM_CCATM_SET_PORT_PARAM
block|,
literal|"set_port_param"
block|,
operator|&
name|ng_ccatm_atm_port_type
block|,
name|NULL
block|}
block|,
block|{
name|NGM_CCATM_COOKIE
block|,
name|NGM_CCATM_GET_PORT_PARAM
block|,
literal|"get_port_param"
block|,
operator|&
name|ng_ccatm_port_type
block|,
operator|&
name|ng_ccatm_atm_port_type
block|, 	}
block|,
block|{
name|NGM_CCATM_COOKIE
block|,
name|NGM_CCATM_GET_PORTLIST
block|,
literal|"get_portlist"
block|,
name|NULL
block|,
operator|&
name|ng_ccatm_portlist_type
block|, 	}
block|,
block|{
name|NGM_CCATM_COOKIE
block|,
name|NGM_CCATM_SETLOG
block|,
literal|"setlog"
block|,
operator|&
name|ng_parse_hint32_type
block|,
operator|&
name|ng_parse_hint32_type
block|, 	}
block|,
block|{
name|NGM_CCATM_COOKIE
block|,
name|NGM_CCATM_RESET
block|,
literal|"reset"
block|,
name|NULL
block|,
name|NULL
block|, 	}
block|,
block|{
literal|0
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_comment
comment|/*  * Module data  */
end_comment

begin_decl_stmt
specifier|static
name|ng_constructor_t
name|ng_ccatm_constructor
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|ng_rcvmsg_t
name|ng_ccatm_rcvmsg
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|ng_shutdown_t
name|ng_ccatm_shutdown
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|ng_newhook_t
name|ng_ccatm_newhook
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|ng_rcvdata_t
name|ng_ccatm_rcvdata
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|ng_disconnect_t
name|ng_ccatm_disconnect
decl_stmt|;
end_decl_stmt

begin_function_decl
specifier|static
name|int
name|ng_ccatm_mod_event
parameter_list|(
name|module_t
parameter_list|,
name|int
parameter_list|,
name|void
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_decl_stmt
specifier|static
name|struct
name|ng_type
name|ng_ccatm_typestruct
init|=
block|{
operator|.
name|version
operator|=
name|NG_ABI_VERSION
block|,
operator|.
name|name
operator|=
name|NG_CCATM_NODE_TYPE
block|,
operator|.
name|mod_event
operator|=
name|ng_ccatm_mod_event
block|,
operator|.
name|constructor
operator|=
name|ng_ccatm_constructor
block|,
comment|/* Node constructor */
operator|.
name|rcvmsg
operator|=
name|ng_ccatm_rcvmsg
block|,
comment|/* Control messages */
operator|.
name|shutdown
operator|=
name|ng_ccatm_shutdown
block|,
comment|/* Node destructor */
operator|.
name|newhook
operator|=
name|ng_ccatm_newhook
block|,
comment|/* Arrival of new hook */
operator|.
name|rcvdata
operator|=
name|ng_ccatm_rcvdata
block|,
comment|/* receive data */
operator|.
name|disconnect
operator|=
name|ng_ccatm_disconnect
block|,
comment|/* disconnect a hook */
operator|.
name|cmdlist
operator|=
name|ng_ccatm_cmdlist
block|, }
decl_stmt|;
end_decl_stmt

begin_expr_stmt
name|NETGRAPH_INIT
argument_list|(
name|ccatm
argument_list|,
operator|&
name|ng_ccatm_typestruct
argument_list|)
expr_stmt|;
end_expr_stmt

begin_decl_stmt
specifier|static
name|ng_rcvdata_t
name|ng_ccatm_rcvuni
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|ng_rcvdata_t
name|ng_ccatm_rcvdump
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|ng_rcvdata_t
name|ng_ccatm_rcvmanage
decl_stmt|;
end_decl_stmt

begin_comment
comment|/*  * Private node data.  */
end_comment

begin_struct
struct|struct
name|ccnode
block|{
name|node_p
name|node
decl_stmt|;
comment|/* the owning node */
name|hook_p
name|dump
decl_stmt|;
comment|/* dump hook */
name|hook_p
name|manage
decl_stmt|;
comment|/* hook to ILMI */
name|struct
name|ccdata
modifier|*
name|data
decl_stmt|;
name|struct
name|mbuf
modifier|*
name|dump_first
decl_stmt|;
name|struct
name|mbuf
modifier|*
name|dump_last
decl_stmt|;
comment|/* first and last mbuf when dumping */
name|u_int
name|hook_cnt
decl_stmt|;
comment|/* count user and port hooks */
block|}
struct|;
end_struct

begin_comment
comment|/*  * Private UNI hook data  */
end_comment

begin_struct
struct|struct
name|cchook
block|{
name|int
name|is_uni
decl_stmt|;
comment|/* true if uni hook, user otherwise */
name|struct
name|ccnode
modifier|*
name|node
decl_stmt|;
comment|/* the owning node */
name|hook_p
name|hook
decl_stmt|;
name|void
modifier|*
name|inst
decl_stmt|;
comment|/* port or user */
block|}
struct|;
end_struct

begin_function_decl
specifier|static
name|void
name|ng_ccatm_send_user
parameter_list|(
name|struct
name|ccuser
modifier|*
parameter_list|,
name|void
modifier|*
parameter_list|,
name|u_int
parameter_list|,
name|void
modifier|*
parameter_list|,
name|size_t
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|ng_ccatm_respond_user
parameter_list|(
name|struct
name|ccuser
modifier|*
parameter_list|,
name|void
modifier|*
parameter_list|,
name|int
parameter_list|,
name|u_int
parameter_list|,
name|void
modifier|*
parameter_list|,
name|size_t
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|ng_ccatm_send_uni
parameter_list|(
name|struct
name|ccconn
modifier|*
parameter_list|,
name|void
modifier|*
parameter_list|,
name|u_int
parameter_list|,
name|u_int
parameter_list|,
name|struct
name|uni_msg
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|ng_ccatm_send_uni_glob
parameter_list|(
name|struct
name|ccport
modifier|*
parameter_list|,
name|void
modifier|*
parameter_list|,
name|u_int
parameter_list|,
name|u_int
parameter_list|,
name|struct
name|uni_msg
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|ng_ccatm_log
parameter_list|(
specifier|const
name|char
modifier|*
parameter_list|,
modifier|...
parameter_list|)
function_decl|__printflike
parameter_list|(
function_decl|1
operator|,
function_decl|2
end_function_decl

begin_empty_stmt
unit|)
empty_stmt|;
end_empty_stmt

begin_decl_stmt
specifier|static
specifier|const
name|struct
name|cc_funcs
name|cc_funcs
init|=
block|{
operator|.
name|send_user
operator|=
name|ng_ccatm_send_user
block|,
operator|.
name|respond_user
operator|=
name|ng_ccatm_respond_user
block|,
operator|.
name|send_uni
operator|=
name|ng_ccatm_send_uni
block|,
operator|.
name|send_uni_glob
operator|=
name|ng_ccatm_send_uni_glob
block|,
operator|.
name|log
operator|=
name|ng_ccatm_log
block|, }
decl_stmt|;
end_decl_stmt

begin_comment
comment|/************************************************************  *  * Create a new node  */
end_comment

begin_function
specifier|static
name|int
name|ng_ccatm_constructor
parameter_list|(
name|node_p
name|node
parameter_list|)
block|{
name|struct
name|ccnode
modifier|*
name|priv
decl_stmt|;
name|priv
operator|=
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|priv
argument_list|)
argument_list|,
name|M_NG_CCATM
argument_list|,
name|M_NOWAIT
operator||
name|M_ZERO
argument_list|)
expr_stmt|;
if|if
condition|(
name|priv
operator|==
name|NULL
condition|)
return|return
operator|(
name|ENOMEM
operator|)
return|;
name|priv
operator|->
name|node
operator|=
name|node
expr_stmt|;
name|priv
operator|->
name|data
operator|=
name|cc_create
argument_list|(
operator|&
name|cc_funcs
argument_list|)
expr_stmt|;
if|if
condition|(
name|priv
operator|->
name|data
operator|==
name|NULL
condition|)
block|{
name|free
argument_list|(
name|priv
argument_list|,
name|M_NG_CCATM
argument_list|)
expr_stmt|;
return|return
operator|(
name|ENOMEM
operator|)
return|;
block|}
name|NG_NODE_SET_PRIVATE
argument_list|(
name|node
argument_list|,
name|priv
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Destroy a node. The user list is empty here, because all hooks are  * previously disconnected. The connection lists may not be empty, because  * connections may be waiting for responses from the stack. This also means,  * that no orphaned connections will be made by the port_destroy routine.  */
end_comment

begin_function
specifier|static
name|int
name|ng_ccatm_shutdown
parameter_list|(
name|node_p
name|node
parameter_list|)
block|{
name|struct
name|ccnode
modifier|*
name|priv
init|=
name|NG_NODE_PRIVATE
argument_list|(
name|node
argument_list|)
decl_stmt|;
name|cc_destroy
argument_list|(
name|priv
operator|->
name|data
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|priv
argument_list|,
name|M_NG_CCATM
argument_list|)
expr_stmt|;
name|NG_NODE_SET_PRIVATE
argument_list|(
name|node
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|NG_NODE_UNREF
argument_list|(
name|node
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Retrieve the registered addresses for one port or all ports.  * Returns an error code or 0 on success.  */
end_comment

begin_function
specifier|static
name|int
name|ng_ccatm_get_addresses
parameter_list|(
name|node_p
name|node
parameter_list|,
name|uint32_t
name|portno
parameter_list|,
name|struct
name|ng_mesg
modifier|*
name|msg
parameter_list|,
name|struct
name|ng_mesg
modifier|*
modifier|*
name|resp
parameter_list|)
block|{
name|struct
name|ccnode
modifier|*
name|priv
init|=
name|NG_NODE_PRIVATE
argument_list|(
name|node
argument_list|)
decl_stmt|;
name|struct
name|uni_addr
modifier|*
name|addrs
decl_stmt|;
name|u_int
modifier|*
name|ports
decl_stmt|;
name|struct
name|ngm_ccatm_get_addresses
modifier|*
name|list
decl_stmt|;
name|u_int
name|count
decl_stmt|,
name|i
decl_stmt|;
name|size_t
name|len
decl_stmt|;
name|int
name|err
decl_stmt|;
name|err
operator|=
name|cc_get_addrs
argument_list|(
name|priv
operator|->
name|data
argument_list|,
name|portno
argument_list|,
operator|&
name|addrs
argument_list|,
operator|&
name|ports
argument_list|,
operator|&
name|count
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
operator|!=
literal|0
condition|)
return|return
operator|(
name|err
operator|)
return|;
name|len
operator|=
sizeof|sizeof
argument_list|(
operator|*
name|list
argument_list|)
operator|+
name|count
operator|*
sizeof|sizeof
argument_list|(
name|list
operator|->
name|addr
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
name|NG_MKRESPONSE
argument_list|(
operator|*
name|resp
argument_list|,
name|msg
argument_list|,
name|len
argument_list|,
name|M_NOWAIT
argument_list|)
expr_stmt|;
if|if
condition|(
operator|*
name|resp
operator|==
name|NULL
condition|)
block|{
name|free
argument_list|(
name|addrs
argument_list|,
name|M_NG_CCATM
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|ports
argument_list|,
name|M_NG_CCATM
argument_list|)
expr_stmt|;
return|return
operator|(
name|ENOMEM
operator|)
return|;
block|}
name|list
operator|=
operator|(
expr|struct
name|ngm_ccatm_get_addresses
operator|*
operator|)
operator|(
operator|*
name|resp
operator|)
operator|->
name|data
expr_stmt|;
name|list
operator|->
name|count
operator|=
name|count
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|count
condition|;
name|i
operator|++
control|)
block|{
name|list
operator|->
name|addr
index|[
name|i
index|]
operator|.
name|port
operator|=
name|ports
index|[
name|i
index|]
expr_stmt|;
name|list
operator|->
name|addr
index|[
name|i
index|]
operator|.
name|addr
operator|=
name|addrs
index|[
name|i
index|]
expr_stmt|;
block|}
name|free
argument_list|(
name|addrs
argument_list|,
name|M_NG_CCATM
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|ports
argument_list|,
name|M_NG_CCATM
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Dumper function. Pack the data into an mbuf chain.  */
end_comment

begin_function
specifier|static
name|int
name|send_dump
parameter_list|(
name|struct
name|ccdata
modifier|*
name|data
parameter_list|,
name|void
modifier|*
name|uarg
parameter_list|,
specifier|const
name|char
modifier|*
name|buf
parameter_list|)
block|{
name|struct
name|mbuf
modifier|*
name|m
decl_stmt|;
name|struct
name|ccnode
modifier|*
name|priv
init|=
name|uarg
decl_stmt|;
if|if
condition|(
name|priv
operator|->
name|dump
operator|==
name|NULL
condition|)
block|{
name|m
operator|=
name|m_getcl
argument_list|(
name|M_DONTWAIT
argument_list|,
name|MT_DATA
argument_list|,
name|M_PKTHDR
argument_list|)
expr_stmt|;
if|if
condition|(
name|m
operator|==
name|NULL
condition|)
return|return
operator|(
name|ENOBUFS
operator|)
return|;
name|priv
operator|->
name|dump_first
operator|=
name|priv
operator|->
name|dump_last
operator|=
name|m
expr_stmt|;
name|m
operator|->
name|m_pkthdr
operator|.
name|len
operator|=
literal|0
expr_stmt|;
block|}
else|else
block|{
name|m
operator|=
name|m_getcl
argument_list|(
name|M_DONTWAIT
argument_list|,
name|MT_DATA
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|m
operator|==
literal|0
condition|)
block|{
name|m_freem
argument_list|(
name|priv
operator|->
name|dump_first
argument_list|)
expr_stmt|;
return|return
operator|(
name|ENOBUFS
operator|)
return|;
block|}
name|priv
operator|->
name|dump_last
operator|->
name|m_next
operator|=
name|m
expr_stmt|;
name|priv
operator|->
name|dump_last
operator|=
name|m
expr_stmt|;
block|}
name|strcpy
argument_list|(
name|m
operator|->
name|m_data
argument_list|,
name|buf
argument_list|)
expr_stmt|;
name|priv
operator|->
name|dump_first
operator|->
name|m_pkthdr
operator|.
name|len
operator|+=
operator|(
name|m
operator|->
name|m_len
operator|=
name|strlen
argument_list|(
name|buf
argument_list|)
operator|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Dump current status to dump hook  */
end_comment

begin_function
specifier|static
name|int
name|ng_ccatm_dump
parameter_list|(
name|node_p
name|node
parameter_list|)
block|{
name|struct
name|ccnode
modifier|*
name|priv
init|=
name|NG_NODE_PRIVATE
argument_list|(
name|node
argument_list|)
decl_stmt|;
name|struct
name|mbuf
modifier|*
name|m
decl_stmt|;
name|int
name|error
decl_stmt|;
name|priv
operator|->
name|dump_first
operator|=
name|priv
operator|->
name|dump_last
operator|=
name|NULL
expr_stmt|;
name|error
operator|=
name|cc_dump
argument_list|(
name|priv
operator|->
name|data
argument_list|,
name|MCLBYTES
argument_list|,
name|send_dump
argument_list|,
name|priv
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|!=
literal|0
condition|)
return|return
operator|(
name|error
operator|)
return|;
if|if
condition|(
operator|(
name|m
operator|=
name|priv
operator|->
name|dump_first
operator|)
operator|!=
name|NULL
condition|)
block|{
name|priv
operator|->
name|dump_first
operator|=
name|priv
operator|->
name|dump_last
operator|=
name|NULL
expr_stmt|;
name|NG_SEND_DATA_ONLY
argument_list|(
name|error
argument_list|,
name|priv
operator|->
name|dump
argument_list|,
name|m
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Control message  */
end_comment

begin_function
specifier|static
name|int
name|ng_ccatm_rcvmsg
parameter_list|(
name|node_p
name|node
parameter_list|,
name|item_p
name|item
parameter_list|,
name|hook_p
name|lasthook
parameter_list|)
block|{
name|struct
name|ng_mesg
modifier|*
name|resp
init|=
name|NULL
decl_stmt|;
name|struct
name|ng_mesg
modifier|*
name|msg
decl_stmt|;
name|struct
name|ccnode
modifier|*
name|priv
init|=
name|NG_NODE_PRIVATE
argument_list|(
name|node
argument_list|)
decl_stmt|;
name|int
name|error
init|=
literal|0
decl_stmt|;
name|NGI_GET_MSG
argument_list|(
name|item
argument_list|,
name|msg
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|msg
operator|->
name|header
operator|.
name|typecookie
condition|)
block|{
case|case
name|NGM_CCATM_COOKIE
case|:
switch|switch
condition|(
name|msg
operator|->
name|header
operator|.
name|cmd
condition|)
block|{
case|case
name|NGM_CCATM_DUMP
case|:
if|if
condition|(
name|priv
operator|->
name|dump
condition|)
name|error
operator|=
name|ng_ccatm_dump
argument_list|(
name|node
argument_list|)
expr_stmt|;
else|else
name|error
operator|=
name|ENOTCONN
expr_stmt|;
break|break;
case|case
name|NGM_CCATM_STOP
case|:
block|{
name|struct
name|ngm_ccatm_port
modifier|*
name|arg
decl_stmt|;
if|if
condition|(
name|msg
operator|->
name|header
operator|.
name|arglen
operator|!=
sizeof|sizeof
argument_list|(
operator|*
name|arg
argument_list|)
condition|)
block|{
name|error
operator|=
name|EINVAL
expr_stmt|;
break|break;
block|}
name|arg
operator|=
operator|(
expr|struct
name|ngm_ccatm_port
operator|*
operator|)
name|msg
operator|->
name|data
expr_stmt|;
name|error
operator|=
name|cc_port_stop
argument_list|(
name|priv
operator|->
name|data
argument_list|,
name|arg
operator|->
name|port
argument_list|)
expr_stmt|;
break|break;
block|}
case|case
name|NGM_CCATM_START
case|:
block|{
name|struct
name|ngm_ccatm_port
modifier|*
name|arg
decl_stmt|;
if|if
condition|(
name|msg
operator|->
name|header
operator|.
name|arglen
operator|!=
sizeof|sizeof
argument_list|(
operator|*
name|arg
argument_list|)
condition|)
block|{
name|error
operator|=
name|EINVAL
expr_stmt|;
break|break;
block|}
name|arg
operator|=
operator|(
expr|struct
name|ngm_ccatm_port
operator|*
operator|)
name|msg
operator|->
name|data
expr_stmt|;
name|error
operator|=
name|cc_port_start
argument_list|(
name|priv
operator|->
name|data
argument_list|,
name|arg
operator|->
name|port
argument_list|)
expr_stmt|;
break|break;
block|}
case|case
name|NGM_CCATM_GETSTATE
case|:
block|{
name|struct
name|ngm_ccatm_port
modifier|*
name|arg
decl_stmt|;
name|int
name|state
decl_stmt|;
if|if
condition|(
name|msg
operator|->
name|header
operator|.
name|arglen
operator|!=
sizeof|sizeof
argument_list|(
operator|*
name|arg
argument_list|)
condition|)
block|{
name|error
operator|=
name|EINVAL
expr_stmt|;
break|break;
block|}
name|arg
operator|=
operator|(
expr|struct
name|ngm_ccatm_port
operator|*
operator|)
name|msg
operator|->
name|data
expr_stmt|;
name|error
operator|=
name|cc_port_isrunning
argument_list|(
name|priv
operator|->
name|data
argument_list|,
name|arg
operator|->
name|port
argument_list|,
operator|&
name|state
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|==
literal|0
condition|)
block|{
name|NG_MKRESPONSE
argument_list|(
name|resp
argument_list|,
name|msg
argument_list|,
sizeof|sizeof
argument_list|(
name|uint32_t
argument_list|)
argument_list|,
name|M_NOWAIT
argument_list|)
expr_stmt|;
if|if
condition|(
name|resp
operator|==
name|NULL
condition|)
block|{
name|error
operator|=
name|ENOMEM
expr_stmt|;
break|break;
block|}
operator|*
operator|(
name|uint32_t
operator|*
operator|)
name|resp
operator|->
name|data
operator|=
name|state
expr_stmt|;
block|}
break|break;
block|}
case|case
name|NGM_CCATM_GET_ADDRESSES
case|:
block|{
name|struct
name|ngm_ccatm_port
modifier|*
name|arg
decl_stmt|;
if|if
condition|(
name|msg
operator|->
name|header
operator|.
name|arglen
operator|!=
sizeof|sizeof
argument_list|(
operator|*
name|arg
argument_list|)
condition|)
block|{
name|error
operator|=
name|EINVAL
expr_stmt|;
break|break;
block|}
name|arg
operator|=
operator|(
expr|struct
name|ngm_ccatm_port
operator|*
operator|)
name|msg
operator|->
name|data
expr_stmt|;
name|error
operator|=
name|ng_ccatm_get_addresses
argument_list|(
name|node
argument_list|,
name|arg
operator|->
name|port
argument_list|,
name|msg
argument_list|,
operator|&
name|resp
argument_list|)
expr_stmt|;
break|break;
block|}
case|case
name|NGM_CCATM_CLEAR
case|:
block|{
name|struct
name|ngm_ccatm_port
modifier|*
name|arg
decl_stmt|;
if|if
condition|(
name|msg
operator|->
name|header
operator|.
name|arglen
operator|!=
sizeof|sizeof
argument_list|(
operator|*
name|arg
argument_list|)
condition|)
block|{
name|error
operator|=
name|EINVAL
expr_stmt|;
break|break;
block|}
name|arg
operator|=
operator|(
expr|struct
name|ngm_ccatm_port
operator|*
operator|)
name|msg
operator|->
name|data
expr_stmt|;
name|error
operator|=
name|cc_port_clear
argument_list|(
name|priv
operator|->
name|data
argument_list|,
name|arg
operator|->
name|port
argument_list|)
expr_stmt|;
break|break;
block|}
case|case
name|NGM_CCATM_ADDRESS_REGISTERED
case|:
block|{
name|struct
name|ngm_ccatm_addr_req
modifier|*
name|arg
decl_stmt|;
if|if
condition|(
name|msg
operator|->
name|header
operator|.
name|arglen
operator|!=
sizeof|sizeof
argument_list|(
operator|*
name|arg
argument_list|)
condition|)
block|{
name|error
operator|=
name|EINVAL
expr_stmt|;
break|break;
block|}
name|arg
operator|=
operator|(
expr|struct
name|ngm_ccatm_addr_req
operator|*
operator|)
name|msg
operator|->
name|data
expr_stmt|;
name|error
operator|=
name|cc_addr_register
argument_list|(
name|priv
operator|->
name|data
argument_list|,
name|arg
operator|->
name|port
argument_list|,
operator|&
name|arg
operator|->
name|addr
argument_list|)
expr_stmt|;
break|break;
block|}
case|case
name|NGM_CCATM_ADDRESS_UNREGISTERED
case|:
block|{
name|struct
name|ngm_ccatm_addr_req
modifier|*
name|arg
decl_stmt|;
if|if
condition|(
name|msg
operator|->
name|header
operator|.
name|arglen
operator|!=
sizeof|sizeof
argument_list|(
operator|*
name|arg
argument_list|)
condition|)
block|{
name|error
operator|=
name|EINVAL
expr_stmt|;
break|break;
block|}
name|arg
operator|=
operator|(
expr|struct
name|ngm_ccatm_addr_req
operator|*
operator|)
name|msg
operator|->
name|data
expr_stmt|;
name|error
operator|=
name|cc_addr_unregister
argument_list|(
name|priv
operator|->
name|data
argument_list|,
name|arg
operator|->
name|port
argument_list|,
operator|&
name|arg
operator|->
name|addr
argument_list|)
expr_stmt|;
break|break;
block|}
case|case
name|NGM_CCATM_GET_PORT_PARAM
case|:
block|{
name|struct
name|ngm_ccatm_port
modifier|*
name|arg
decl_stmt|;
if|if
condition|(
name|msg
operator|->
name|header
operator|.
name|arglen
operator|!=
sizeof|sizeof
argument_list|(
operator|*
name|arg
argument_list|)
condition|)
block|{
name|error
operator|=
name|EINVAL
expr_stmt|;
break|break;
block|}
name|arg
operator|=
operator|(
expr|struct
name|ngm_ccatm_port
operator|*
operator|)
name|msg
operator|->
name|data
expr_stmt|;
name|NG_MKRESPONSE
argument_list|(
name|resp
argument_list|,
name|msg
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|atm_port_info
argument_list|)
argument_list|,
name|M_NOWAIT
argument_list|)
expr_stmt|;
if|if
condition|(
name|resp
operator|==
name|NULL
condition|)
block|{
name|error
operator|=
name|ENOMEM
expr_stmt|;
break|break;
block|}
name|error
operator|=
name|cc_port_get_param
argument_list|(
name|priv
operator|->
name|data
argument_list|,
name|arg
operator|->
name|port
argument_list|,
operator|(
expr|struct
name|atm_port_info
operator|*
operator|)
name|resp
operator|->
name|data
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|!=
literal|0
condition|)
block|{
name|free
argument_list|(
name|resp
argument_list|,
name|M_NETGRAPH_MSG
argument_list|)
expr_stmt|;
name|resp
operator|=
name|NULL
expr_stmt|;
block|}
break|break;
block|}
case|case
name|NGM_CCATM_SET_PORT_PARAM
case|:
block|{
name|struct
name|atm_port_info
modifier|*
name|arg
decl_stmt|;
if|if
condition|(
name|msg
operator|->
name|header
operator|.
name|arglen
operator|!=
sizeof|sizeof
argument_list|(
operator|*
name|arg
argument_list|)
condition|)
block|{
name|error
operator|=
name|EINVAL
expr_stmt|;
break|break;
block|}
name|arg
operator|=
operator|(
expr|struct
name|atm_port_info
operator|*
operator|)
name|msg
operator|->
name|data
expr_stmt|;
name|error
operator|=
name|cc_port_set_param
argument_list|(
name|priv
operator|->
name|data
argument_list|,
name|arg
argument_list|)
expr_stmt|;
break|break;
block|}
case|case
name|NGM_CCATM_GET_PORTLIST
case|:
block|{
name|struct
name|ngm_ccatm_portlist
modifier|*
name|arg
decl_stmt|;
name|u_int
name|n
decl_stmt|,
modifier|*
name|ports
decl_stmt|;
if|if
condition|(
name|msg
operator|->
name|header
operator|.
name|arglen
operator|!=
literal|0
condition|)
block|{
name|error
operator|=
name|EINVAL
expr_stmt|;
break|break;
block|}
name|error
operator|=
name|cc_port_getlist
argument_list|(
name|priv
operator|->
name|data
argument_list|,
operator|&
name|n
argument_list|,
operator|&
name|ports
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|!=
literal|0
condition|)
break|break;
name|NG_MKRESPONSE
argument_list|(
name|resp
argument_list|,
name|msg
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|arg
argument_list|)
operator|+
name|n
operator|*
sizeof|sizeof
argument_list|(
name|arg
operator|->
name|ports
index|[
literal|0
index|]
argument_list|)
argument_list|,
name|M_NOWAIT
argument_list|)
expr_stmt|;
if|if
condition|(
name|resp
operator|==
name|NULL
condition|)
block|{
name|free
argument_list|(
name|ports
argument_list|,
name|M_NG_CCATM
argument_list|)
expr_stmt|;
name|error
operator|=
name|ENOMEM
expr_stmt|;
break|break;
block|}
name|arg
operator|=
operator|(
expr|struct
name|ngm_ccatm_portlist
operator|*
operator|)
name|resp
operator|->
name|data
expr_stmt|;
name|arg
operator|->
name|nports
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|arg
operator|->
name|nports
operator|=
literal|0
init|;
name|arg
operator|->
name|nports
operator|<
name|n
condition|;
name|arg
operator|->
name|nports
operator|++
control|)
name|arg
operator|->
name|ports
index|[
name|arg
operator|->
name|nports
index|]
operator|=
name|ports
index|[
name|arg
operator|->
name|nports
index|]
expr_stmt|;
name|free
argument_list|(
name|ports
argument_list|,
name|M_NG_CCATM
argument_list|)
expr_stmt|;
break|break;
block|}
case|case
name|NGM_CCATM_SETLOG
case|:
block|{
name|uint32_t
name|log_level
decl_stmt|;
name|log_level
operator|=
name|cc_get_log
argument_list|(
name|priv
operator|->
name|data
argument_list|)
expr_stmt|;
if|if
condition|(
name|msg
operator|->
name|header
operator|.
name|arglen
operator|!=
literal|0
condition|)
block|{
if|if
condition|(
name|msg
operator|->
name|header
operator|.
name|arglen
operator|!=
sizeof|sizeof
argument_list|(
name|log_level
argument_list|)
condition|)
block|{
name|error
operator|=
name|EINVAL
expr_stmt|;
break|break;
block|}
name|cc_set_log
argument_list|(
name|priv
operator|->
name|data
argument_list|,
operator|*
operator|(
name|uint32_t
operator|*
operator|)
name|msg
operator|->
name|data
argument_list|)
expr_stmt|;
block|}
name|NG_MKRESPONSE
argument_list|(
name|resp
argument_list|,
name|msg
argument_list|,
sizeof|sizeof
argument_list|(
name|uint32_t
argument_list|)
argument_list|,
name|M_NOWAIT
argument_list|)
expr_stmt|;
if|if
condition|(
name|resp
operator|==
name|NULL
condition|)
block|{
name|error
operator|=
name|ENOMEM
expr_stmt|;
if|if
condition|(
name|msg
operator|->
name|header
operator|.
name|arglen
operator|!=
literal|0
condition|)
name|cc_set_log
argument_list|(
name|priv
operator|->
name|data
argument_list|,
name|log_level
argument_list|)
expr_stmt|;
break|break;
block|}
operator|*
operator|(
name|uint32_t
operator|*
operator|)
name|resp
operator|->
name|data
operator|=
name|log_level
expr_stmt|;
break|break;
block|}
case|case
name|NGM_CCATM_RESET
case|:
if|if
condition|(
name|msg
operator|->
name|header
operator|.
name|arglen
operator|!=
literal|0
condition|)
block|{
name|error
operator|=
name|EINVAL
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|priv
operator|->
name|hook_cnt
operator|!=
literal|0
condition|)
block|{
name|error
operator|=
name|EBUSY
expr_stmt|;
break|break;
block|}
name|cc_reset
argument_list|(
name|priv
operator|->
name|data
argument_list|)
expr_stmt|;
break|break;
case|case
name|NGM_CCATM_GET_EXSTAT
case|:
block|{
name|struct
name|atm_exstatus
name|s
decl_stmt|;
name|struct
name|atm_exstatus_ep
modifier|*
name|eps
decl_stmt|;
name|struct
name|atm_exstatus_port
modifier|*
name|ports
decl_stmt|;
name|struct
name|atm_exstatus_conn
modifier|*
name|conns
decl_stmt|;
name|struct
name|atm_exstatus_party
modifier|*
name|parties
decl_stmt|;
name|size_t
name|offs
decl_stmt|;
if|if
condition|(
name|msg
operator|->
name|header
operator|.
name|arglen
operator|!=
literal|0
condition|)
block|{
name|error
operator|=
name|EINVAL
expr_stmt|;
break|break;
block|}
name|error
operator|=
name|cc_get_extended_status
argument_list|(
name|priv
operator|->
name|data
argument_list|,
operator|&
name|s
argument_list|,
operator|&
name|eps
argument_list|,
operator|&
name|ports
argument_list|,
operator|&
name|conns
argument_list|,
operator|&
name|parties
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|!=
literal|0
condition|)
break|break;
name|offs
operator|=
sizeof|sizeof
argument_list|(
name|s
argument_list|)
operator|+
name|s
operator|.
name|neps
operator|*
sizeof|sizeof
argument_list|(
operator|*
name|eps
argument_list|)
operator|+
name|s
operator|.
name|nports
operator|*
sizeof|sizeof
argument_list|(
operator|*
name|ports
argument_list|)
operator|+
name|s
operator|.
name|nconns
operator|*
sizeof|sizeof
argument_list|(
operator|*
name|conns
argument_list|)
operator|+
name|s
operator|.
name|nparties
operator|*
sizeof|sizeof
argument_list|(
operator|*
name|parties
argument_list|)
expr_stmt|;
name|NG_MKRESPONSE
argument_list|(
name|resp
argument_list|,
name|msg
argument_list|,
name|offs
argument_list|,
name|M_NOWAIT
argument_list|)
expr_stmt|;
if|if
condition|(
name|resp
operator|==
name|NULL
condition|)
block|{
name|error
operator|=
name|ENOMEM
expr_stmt|;
break|break;
block|}
name|memcpy
argument_list|(
name|resp
operator|->
name|data
argument_list|,
operator|&
name|s
argument_list|,
sizeof|sizeof
argument_list|(
name|s
argument_list|)
argument_list|)
expr_stmt|;
name|offs
operator|=
sizeof|sizeof
argument_list|(
name|s
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
name|resp
operator|->
name|data
operator|+
name|offs
argument_list|,
name|eps
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|eps
argument_list|)
operator|*
name|s
operator|.
name|neps
argument_list|)
expr_stmt|;
name|offs
operator|+=
sizeof|sizeof
argument_list|(
operator|*
name|eps
argument_list|)
operator|*
name|s
operator|.
name|neps
expr_stmt|;
name|memcpy
argument_list|(
name|resp
operator|->
name|data
operator|+
name|offs
argument_list|,
name|ports
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|ports
argument_list|)
operator|*
name|s
operator|.
name|nports
argument_list|)
expr_stmt|;
name|offs
operator|+=
sizeof|sizeof
argument_list|(
operator|*
name|ports
argument_list|)
operator|*
name|s
operator|.
name|nports
expr_stmt|;
name|memcpy
argument_list|(
name|resp
operator|->
name|data
operator|+
name|offs
argument_list|,
name|conns
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|conns
argument_list|)
operator|*
name|s
operator|.
name|nconns
argument_list|)
expr_stmt|;
name|offs
operator|+=
sizeof|sizeof
argument_list|(
operator|*
name|conns
argument_list|)
operator|*
name|s
operator|.
name|nconns
expr_stmt|;
name|memcpy
argument_list|(
name|resp
operator|->
name|data
operator|+
name|offs
argument_list|,
name|parties
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|parties
argument_list|)
operator|*
name|s
operator|.
name|nparties
argument_list|)
expr_stmt|;
name|offs
operator|+=
sizeof|sizeof
argument_list|(
operator|*
name|parties
argument_list|)
operator|*
name|s
operator|.
name|nparties
expr_stmt|;
name|free
argument_list|(
name|eps
argument_list|,
name|M_NG_CCATM
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|ports
argument_list|,
name|M_NG_CCATM
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|conns
argument_list|,
name|M_NG_CCATM
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|parties
argument_list|,
name|M_NG_CCATM
argument_list|)
expr_stmt|;
break|break;
block|}
default|default:
name|error
operator|=
name|EINVAL
expr_stmt|;
break|break;
block|}
break|break;
default|default:
name|error
operator|=
name|EINVAL
expr_stmt|;
break|break;
block|}
name|NG_RESPOND_MSG
argument_list|(
name|error
argument_list|,
name|node
argument_list|,
name|item
argument_list|,
name|resp
argument_list|)
expr_stmt|;
name|NG_FREE_MSG
argument_list|(
name|msg
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
end_function

begin_comment
comment|/************************************************************  *  * New hook arrival  */
end_comment

begin_function
specifier|static
name|int
name|ng_ccatm_newhook
parameter_list|(
name|node_p
name|node
parameter_list|,
name|hook_p
name|hook
parameter_list|,
specifier|const
name|char
modifier|*
name|name
parameter_list|)
block|{
name|struct
name|ccnode
modifier|*
name|priv
init|=
name|NG_NODE_PRIVATE
argument_list|(
name|node
argument_list|)
decl_stmt|;
name|struct
name|ccport
modifier|*
name|port
decl_stmt|;
name|struct
name|ccuser
modifier|*
name|user
decl_stmt|;
name|struct
name|cchook
modifier|*
name|hd
decl_stmt|;
name|u_long
name|lport
decl_stmt|;
name|char
modifier|*
name|end
decl_stmt|;
if|if
condition|(
name|strncmp
argument_list|(
name|name
argument_list|,
literal|"uni"
argument_list|,
literal|3
argument_list|)
operator|==
literal|0
condition|)
block|{
comment|/* 		 * This is a UNI hook. Should be a new port. 		 */
if|if
condition|(
name|name
index|[
literal|3
index|]
operator|==
literal|'\0'
condition|)
return|return
operator|(
name|EINVAL
operator|)
return|;
name|lport
operator|=
name|strtoul
argument_list|(
name|name
operator|+
literal|3
argument_list|,
operator|&
name|end
argument_list|,
literal|10
argument_list|)
expr_stmt|;
if|if
condition|(
operator|*
name|end
operator|!=
literal|'\0'
operator|||
name|lport
operator|==
literal|0
operator|||
name|lport
operator|>
literal|0xffffffff
condition|)
return|return
operator|(
name|EINVAL
operator|)
return|;
name|hd
operator|=
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|hd
argument_list|)
argument_list|,
name|M_NG_CCATM
argument_list|,
name|M_NOWAIT
argument_list|)
expr_stmt|;
if|if
condition|(
name|hd
operator|==
name|NULL
condition|)
return|return
operator|(
name|ENOMEM
operator|)
return|;
name|hd
operator|->
name|is_uni
operator|=
literal|1
expr_stmt|;
name|hd
operator|->
name|node
operator|=
name|priv
expr_stmt|;
name|hd
operator|->
name|hook
operator|=
name|hook
expr_stmt|;
name|port
operator|=
name|cc_port_create
argument_list|(
name|priv
operator|->
name|data
argument_list|,
name|hd
argument_list|,
operator|(
name|u_int
operator|)
name|lport
argument_list|)
expr_stmt|;
if|if
condition|(
name|port
operator|==
name|NULL
condition|)
block|{
name|free
argument_list|(
name|hd
argument_list|,
name|M_NG_CCATM
argument_list|)
expr_stmt|;
return|return
operator|(
name|ENOMEM
operator|)
return|;
block|}
name|hd
operator|->
name|inst
operator|=
name|port
expr_stmt|;
name|NG_HOOK_SET_PRIVATE
argument_list|(
name|hook
argument_list|,
name|hd
argument_list|)
expr_stmt|;
name|NG_HOOK_SET_RCVDATA
argument_list|(
name|hook
argument_list|,
name|ng_ccatm_rcvuni
argument_list|)
expr_stmt|;
name|NG_HOOK_FORCE_QUEUE
argument_list|(
name|hook
argument_list|)
expr_stmt|;
name|priv
operator|->
name|hook_cnt
operator|++
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
if|if
condition|(
name|strcmp
argument_list|(
name|name
argument_list|,
literal|"dump"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|priv
operator|->
name|dump
operator|=
name|hook
expr_stmt|;
name|NG_HOOK_SET_RCVDATA
argument_list|(
name|hook
argument_list|,
name|ng_ccatm_rcvdump
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
if|if
condition|(
name|strcmp
argument_list|(
name|name
argument_list|,
literal|"manage"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|priv
operator|->
name|manage
operator|=
name|hook
expr_stmt|;
name|NG_HOOK_SET_RCVDATA
argument_list|(
name|hook
argument_list|,
name|ng_ccatm_rcvmanage
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
comment|/* 	 * User hook 	 */
name|hd
operator|=
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|hd
argument_list|)
argument_list|,
name|M_NG_CCATM
argument_list|,
name|M_NOWAIT
argument_list|)
expr_stmt|;
if|if
condition|(
name|hd
operator|==
name|NULL
condition|)
return|return
operator|(
name|ENOMEM
operator|)
return|;
name|hd
operator|->
name|is_uni
operator|=
literal|0
expr_stmt|;
name|hd
operator|->
name|node
operator|=
name|priv
expr_stmt|;
name|hd
operator|->
name|hook
operator|=
name|hook
expr_stmt|;
name|user
operator|=
name|cc_user_create
argument_list|(
name|priv
operator|->
name|data
argument_list|,
name|hd
argument_list|,
name|NG_HOOK_NAME
argument_list|(
name|hook
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|user
operator|==
name|NULL
condition|)
block|{
name|free
argument_list|(
name|hd
argument_list|,
name|M_NG_CCATM
argument_list|)
expr_stmt|;
return|return
operator|(
name|ENOMEM
operator|)
return|;
block|}
name|hd
operator|->
name|inst
operator|=
name|user
expr_stmt|;
name|NG_HOOK_SET_PRIVATE
argument_list|(
name|hook
argument_list|,
name|hd
argument_list|)
expr_stmt|;
name|NG_HOOK_FORCE_QUEUE
argument_list|(
name|hook
argument_list|)
expr_stmt|;
name|priv
operator|->
name|hook_cnt
operator|++
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Disconnect a hook  */
end_comment

begin_function
specifier|static
name|int
name|ng_ccatm_disconnect
parameter_list|(
name|hook_p
name|hook
parameter_list|)
block|{
name|node_p
name|node
init|=
name|NG_HOOK_NODE
argument_list|(
name|hook
argument_list|)
decl_stmt|;
name|struct
name|ccnode
modifier|*
name|priv
init|=
name|NG_NODE_PRIVATE
argument_list|(
name|node
argument_list|)
decl_stmt|;
name|struct
name|cchook
modifier|*
name|hd
init|=
name|NG_HOOK_PRIVATE
argument_list|(
name|hook
argument_list|)
decl_stmt|;
if|if
condition|(
name|hook
operator|==
name|priv
operator|->
name|dump
condition|)
block|{
name|priv
operator|->
name|dump
operator|=
name|NULL
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|hook
operator|==
name|priv
operator|->
name|manage
condition|)
block|{
name|priv
operator|->
name|manage
operator|=
name|NULL
expr_stmt|;
name|cc_unmanage
argument_list|(
name|priv
operator|->
name|data
argument_list|)
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|hd
operator|->
name|is_uni
condition|)
name|cc_port_destroy
argument_list|(
name|hd
operator|->
name|inst
argument_list|,
literal|0
argument_list|)
expr_stmt|;
else|else
name|cc_user_destroy
argument_list|(
name|hd
operator|->
name|inst
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|hd
argument_list|,
name|M_NG_CCATM
argument_list|)
expr_stmt|;
name|NG_HOOK_SET_PRIVATE
argument_list|(
name|hook
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|priv
operator|->
name|hook_cnt
operator|--
expr_stmt|;
name|cc_work
argument_list|(
name|hd
operator|->
name|node
operator|->
name|data
argument_list|)
expr_stmt|;
block|}
comment|/* 	 * When the number of hooks drops to zero, delete the node. 	 */
if|if
condition|(
name|NG_NODE_NUMHOOKS
argument_list|(
name|node
argument_list|)
operator|==
literal|0
operator|&&
name|NG_NODE_IS_VALID
argument_list|(
name|node
argument_list|)
condition|)
name|ng_rmnode_self
argument_list|(
name|node
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_comment
comment|/************************************************************  *  * Receive data from user hook  */
end_comment

begin_function
specifier|static
name|int
name|ng_ccatm_rcvdata
parameter_list|(
name|hook_p
name|hook
parameter_list|,
name|item_p
name|item
parameter_list|)
block|{
name|struct
name|cchook
modifier|*
name|hd
init|=
name|NG_HOOK_PRIVATE
argument_list|(
name|hook
argument_list|)
decl_stmt|;
name|struct
name|uni_msg
modifier|*
name|msg
decl_stmt|;
name|struct
name|mbuf
modifier|*
name|m
decl_stmt|;
name|struct
name|ccatm_op
name|op
decl_stmt|;
name|int
name|err
decl_stmt|;
name|NGI_GET_M
argument_list|(
name|item
argument_list|,
name|m
argument_list|)
expr_stmt|;
name|NG_FREE_ITEM
argument_list|(
name|item
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|err
operator|=
name|uni_msg_unpack_mbuf
argument_list|(
name|m
argument_list|,
operator|&
name|msg
argument_list|)
operator|)
operator|!=
literal|0
condition|)
block|{
name|m_freem
argument_list|(
name|m
argument_list|)
expr_stmt|;
return|return
operator|(
name|err
operator|)
return|;
block|}
name|m_freem
argument_list|(
name|m
argument_list|)
expr_stmt|;
if|if
condition|(
name|uni_msg_len
argument_list|(
name|msg
argument_list|)
operator|<
sizeof|sizeof
argument_list|(
name|op
argument_list|)
condition|)
block|{
name|printf
argument_list|(
literal|"%s: packet too short\n"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
name|uni_msg_destroy
argument_list|(
name|msg
argument_list|)
expr_stmt|;
return|return
operator|(
name|EINVAL
operator|)
return|;
block|}
name|bcopy
argument_list|(
name|msg
operator|->
name|b_rptr
argument_list|,
operator|&
name|op
argument_list|,
sizeof|sizeof
argument_list|(
name|op
argument_list|)
argument_list|)
expr_stmt|;
name|msg
operator|->
name|b_rptr
operator|+=
sizeof|sizeof
argument_list|(
name|op
argument_list|)
expr_stmt|;
name|err
operator|=
name|cc_user_signal
argument_list|(
name|hd
operator|->
name|inst
argument_list|,
name|op
operator|.
name|op
argument_list|,
name|msg
argument_list|)
expr_stmt|;
name|cc_work
argument_list|(
name|hd
operator|->
name|node
operator|->
name|data
argument_list|)
expr_stmt|;
return|return
operator|(
name|err
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Pack a header and a data area into an mbuf chain  */
end_comment

begin_function
specifier|static
name|struct
name|mbuf
modifier|*
name|pack_buf
parameter_list|(
name|void
modifier|*
name|h
parameter_list|,
name|size_t
name|hlen
parameter_list|,
name|void
modifier|*
name|t
parameter_list|,
name|size_t
name|tlen
parameter_list|)
block|{
name|struct
name|mbuf
modifier|*
name|m
decl_stmt|,
modifier|*
name|m0
decl_stmt|,
modifier|*
name|last
decl_stmt|;
name|u_char
modifier|*
name|buf
init|=
operator|(
name|u_char
operator|*
operator|)
name|t
decl_stmt|;
name|size_t
name|n
decl_stmt|;
comment|/* header should fit into a normal mbuf */
name|MGETHDR
argument_list|(
name|m0
argument_list|,
name|M_NOWAIT
argument_list|,
name|MT_DATA
argument_list|)
expr_stmt|;
if|if
condition|(
name|m0
operator|==
name|NULL
condition|)
return|return
name|NULL
return|;
name|KASSERT
argument_list|(
name|hlen
operator|<=
name|MHLEN
argument_list|,
operator|(
literal|"hlen> MHLEN"
operator|)
argument_list|)
expr_stmt|;
name|bcopy
argument_list|(
name|h
argument_list|,
name|m0
operator|->
name|m_data
argument_list|,
name|hlen
argument_list|)
expr_stmt|;
name|m0
operator|->
name|m_len
operator|=
name|hlen
expr_stmt|;
name|m0
operator|->
name|m_pkthdr
operator|.
name|len
operator|=
name|hlen
expr_stmt|;
name|last
operator|=
name|m0
expr_stmt|;
while|while
condition|(
operator|(
name|n
operator|=
name|tlen
operator|)
operator|!=
literal|0
condition|)
block|{
if|if
condition|(
name|n
operator|>
name|MLEN
condition|)
block|{
name|m
operator|=
name|m_getcl
argument_list|(
name|M_NOWAIT
argument_list|,
name|MT_DATA
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|n
operator|>
name|MCLBYTES
condition|)
name|n
operator|=
name|MCLBYTES
expr_stmt|;
block|}
else|else
name|MGET
argument_list|(
name|m
argument_list|,
name|M_NOWAIT
argument_list|,
name|MT_DATA
argument_list|)
expr_stmt|;
if|if
condition|(
name|m
operator|==
name|NULL
condition|)
goto|goto
name|drop
goto|;
name|last
operator|->
name|m_next
operator|=
name|m
expr_stmt|;
name|last
operator|=
name|m
expr_stmt|;
name|bcopy
argument_list|(
name|buf
argument_list|,
name|m
operator|->
name|m_data
argument_list|,
name|n
argument_list|)
expr_stmt|;
name|buf
operator|+=
name|n
expr_stmt|;
name|tlen
operator|-=
name|n
expr_stmt|;
name|m
operator|->
name|m_len
operator|=
name|n
expr_stmt|;
name|m0
operator|->
name|m_pkthdr
operator|.
name|len
operator|+=
name|n
expr_stmt|;
block|}
return|return
operator|(
name|m0
operator|)
return|;
name|drop
label|:
name|m_freem
argument_list|(
name|m0
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
end_function

begin_comment
comment|/*  * Send an indication to the user.  */
end_comment

begin_function
specifier|static
name|void
name|ng_ccatm_send_user
parameter_list|(
name|struct
name|ccuser
modifier|*
name|user
parameter_list|,
name|void
modifier|*
name|uarg
parameter_list|,
name|u_int
name|op
parameter_list|,
name|void
modifier|*
name|val
parameter_list|,
name|size_t
name|len
parameter_list|)
block|{
name|struct
name|cchook
modifier|*
name|hd
init|=
name|uarg
decl_stmt|;
name|struct
name|mbuf
modifier|*
name|m
decl_stmt|;
name|struct
name|ccatm_op
name|h
decl_stmt|;
name|int
name|error
decl_stmt|;
name|h
operator|.
name|op
operator|=
name|op
expr_stmt|;
name|m
operator|=
name|pack_buf
argument_list|(
operator|&
name|h
argument_list|,
sizeof|sizeof
argument_list|(
name|h
argument_list|)
argument_list|,
name|val
argument_list|,
name|len
argument_list|)
expr_stmt|;
if|if
condition|(
name|m
operator|==
name|NULL
condition|)
return|return;
name|NG_SEND_DATA_ONLY
argument_list|(
name|error
argument_list|,
name|hd
operator|->
name|hook
argument_list|,
name|m
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|!=
literal|0
condition|)
name|printf
argument_list|(
literal|"%s: error=%d\n"
argument_list|,
name|__func__
argument_list|,
name|error
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * Send a response to the user.  */
end_comment

begin_function
specifier|static
name|void
name|ng_ccatm_respond_user
parameter_list|(
name|struct
name|ccuser
modifier|*
name|user
parameter_list|,
name|void
modifier|*
name|uarg
parameter_list|,
name|int
name|err
parameter_list|,
name|u_int
name|data
parameter_list|,
name|void
modifier|*
name|val
parameter_list|,
name|size_t
name|len
parameter_list|)
block|{
name|struct
name|cchook
modifier|*
name|hd
init|=
name|uarg
decl_stmt|;
name|struct
name|mbuf
modifier|*
name|m
decl_stmt|;
struct|struct
block|{
name|struct
name|ccatm_op
name|op
decl_stmt|;
name|struct
name|atm_resp
name|resp
decl_stmt|;
block|}
name|resp
struct|;
name|int
name|error
decl_stmt|;
name|resp
operator|.
name|op
operator|.
name|op
operator|=
name|ATMOP_RESP
expr_stmt|;
name|resp
operator|.
name|resp
operator|.
name|resp
operator|=
name|err
expr_stmt|;
name|resp
operator|.
name|resp
operator|.
name|data
operator|=
name|data
expr_stmt|;
name|m
operator|=
name|pack_buf
argument_list|(
operator|&
name|resp
argument_list|,
sizeof|sizeof
argument_list|(
name|resp
argument_list|)
argument_list|,
name|val
argument_list|,
name|len
argument_list|)
expr_stmt|;
if|if
condition|(
name|m
operator|==
name|NULL
condition|)
return|return;
name|NG_SEND_DATA_ONLY
argument_list|(
name|error
argument_list|,
name|hd
operator|->
name|hook
argument_list|,
name|m
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|!=
literal|0
condition|)
name|printf
argument_list|(
literal|"%s: error=%d\n"
argument_list|,
name|__func__
argument_list|,
name|error
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * Receive data from UNI.  */
end_comment

begin_function
specifier|static
name|int
name|ng_ccatm_rcvuni
parameter_list|(
name|hook_p
name|hook
parameter_list|,
name|item_p
name|item
parameter_list|)
block|{
name|struct
name|cchook
modifier|*
name|hd
init|=
name|NG_HOOK_PRIVATE
argument_list|(
name|hook
argument_list|)
decl_stmt|;
name|struct
name|uni_msg
modifier|*
name|msg
decl_stmt|;
name|struct
name|uni_arg
name|arg
decl_stmt|;
name|struct
name|mbuf
modifier|*
name|m
decl_stmt|;
name|int
name|err
decl_stmt|;
name|NGI_GET_M
argument_list|(
name|item
argument_list|,
name|m
argument_list|)
expr_stmt|;
name|NG_FREE_ITEM
argument_list|(
name|item
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|err
operator|=
name|uni_msg_unpack_mbuf
argument_list|(
name|m
argument_list|,
operator|&
name|msg
argument_list|)
operator|)
operator|!=
literal|0
condition|)
block|{
name|m_freem
argument_list|(
name|m
argument_list|)
expr_stmt|;
return|return
operator|(
name|err
operator|)
return|;
block|}
name|m_freem
argument_list|(
name|m
argument_list|)
expr_stmt|;
if|if
condition|(
name|uni_msg_len
argument_list|(
name|msg
argument_list|)
operator|<
sizeof|sizeof
argument_list|(
name|arg
argument_list|)
condition|)
block|{
name|printf
argument_list|(
literal|"%s: packet too short\n"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
name|uni_msg_destroy
argument_list|(
name|msg
argument_list|)
expr_stmt|;
return|return
operator|(
name|EINVAL
operator|)
return|;
block|}
name|bcopy
argument_list|(
name|msg
operator|->
name|b_rptr
argument_list|,
operator|&
name|arg
argument_list|,
sizeof|sizeof
argument_list|(
name|arg
argument_list|)
argument_list|)
expr_stmt|;
name|msg
operator|->
name|b_rptr
operator|+=
sizeof|sizeof
argument_list|(
name|arg
argument_list|)
expr_stmt|;
if|if
condition|(
name|arg
operator|.
name|sig
operator|==
name|UNIAPI_ERROR
condition|)
block|{
if|if
condition|(
name|uni_msg_len
argument_list|(
name|msg
argument_list|)
operator|!=
sizeof|sizeof
argument_list|(
expr|struct
name|uniapi_error
argument_list|)
condition|)
block|{
name|printf
argument_list|(
literal|"%s: bad UNIAPI_ERROR size %zu\n"
argument_list|,
name|__func__
argument_list|,
name|uni_msg_len
argument_list|(
name|msg
argument_list|)
argument_list|)
expr_stmt|;
name|uni_msg_destroy
argument_list|(
name|msg
argument_list|)
expr_stmt|;
return|return
operator|(
name|EINVAL
operator|)
return|;
block|}
name|err
operator|=
name|cc_uni_response
argument_list|(
name|hd
operator|->
name|inst
argument_list|,
name|arg
operator|.
name|cookie
argument_list|,
operator|(
operator|(
expr|struct
name|uniapi_error
operator|*
operator|)
name|msg
operator|->
name|b_rptr
operator|)
operator|->
name|reason
argument_list|,
operator|(
operator|(
expr|struct
name|uniapi_error
operator|*
operator|)
name|msg
operator|->
name|b_rptr
operator|)
operator|->
name|state
argument_list|)
expr_stmt|;
name|uni_msg_destroy
argument_list|(
name|msg
argument_list|)
expr_stmt|;
block|}
else|else
name|err
operator|=
name|cc_uni_signal
argument_list|(
name|hd
operator|->
name|inst
argument_list|,
name|arg
operator|.
name|cookie
argument_list|,
name|arg
operator|.
name|sig
argument_list|,
name|msg
argument_list|)
expr_stmt|;
name|cc_work
argument_list|(
name|hd
operator|->
name|node
operator|->
name|data
argument_list|)
expr_stmt|;
return|return
operator|(
name|err
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Uarg is the port's uarg.  */
end_comment

begin_function
specifier|static
name|void
name|ng_ccatm_send_uni
parameter_list|(
name|struct
name|ccconn
modifier|*
name|conn
parameter_list|,
name|void
modifier|*
name|uarg
parameter_list|,
name|u_int
name|op
parameter_list|,
name|u_int
name|cookie
parameter_list|,
name|struct
name|uni_msg
modifier|*
name|msg
parameter_list|)
block|{
name|struct
name|cchook
modifier|*
name|hd
init|=
name|uarg
decl_stmt|;
name|struct
name|uni_arg
name|arg
decl_stmt|;
name|struct
name|mbuf
modifier|*
name|m
decl_stmt|;
name|int
name|error
decl_stmt|;
name|arg
operator|.
name|sig
operator|=
name|op
expr_stmt|;
name|arg
operator|.
name|cookie
operator|=
name|cookie
expr_stmt|;
name|m
operator|=
name|uni_msg_pack_mbuf
argument_list|(
name|msg
argument_list|,
operator|&
name|arg
argument_list|,
sizeof|sizeof
argument_list|(
name|arg
argument_list|)
argument_list|)
expr_stmt|;
name|uni_msg_destroy
argument_list|(
name|msg
argument_list|)
expr_stmt|;
if|if
condition|(
name|m
operator|==
name|NULL
condition|)
return|return;
name|NG_SEND_DATA_ONLY
argument_list|(
name|error
argument_list|,
name|hd
operator|->
name|hook
argument_list|,
name|m
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|!=
literal|0
condition|)
name|printf
argument_list|(
literal|"%s: error=%d\n"
argument_list|,
name|__func__
argument_list|,
name|error
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * Send a global message to the UNI  */
end_comment

begin_function
specifier|static
name|void
name|ng_ccatm_send_uni_glob
parameter_list|(
name|struct
name|ccport
modifier|*
name|port
parameter_list|,
name|void
modifier|*
name|uarg
parameter_list|,
name|u_int
name|op
parameter_list|,
name|u_int
name|cookie
parameter_list|,
name|struct
name|uni_msg
modifier|*
name|msg
parameter_list|)
block|{
name|struct
name|cchook
modifier|*
name|hd
init|=
name|uarg
decl_stmt|;
name|struct
name|uni_arg
name|arg
decl_stmt|;
name|struct
name|mbuf
modifier|*
name|m
decl_stmt|;
name|int
name|error
decl_stmt|;
name|arg
operator|.
name|sig
operator|=
name|op
expr_stmt|;
name|arg
operator|.
name|cookie
operator|=
name|cookie
expr_stmt|;
name|m
operator|=
name|uni_msg_pack_mbuf
argument_list|(
name|msg
argument_list|,
operator|&
name|arg
argument_list|,
sizeof|sizeof
argument_list|(
name|arg
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|msg
operator|!=
name|NULL
condition|)
name|uni_msg_destroy
argument_list|(
name|msg
argument_list|)
expr_stmt|;
if|if
condition|(
name|m
operator|==
name|NULL
condition|)
return|return;
name|NG_SEND_DATA_ONLY
argument_list|(
name|error
argument_list|,
name|hd
operator|->
name|hook
argument_list|,
name|m
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|!=
literal|0
condition|)
name|printf
argument_list|(
literal|"%s: error=%d\n"
argument_list|,
name|__func__
argument_list|,
name|error
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * Receive from ILMID  */
end_comment

begin_function
specifier|static
name|int
name|ng_ccatm_rcvmanage
parameter_list|(
name|hook_p
name|hook
parameter_list|,
name|item_p
name|item
parameter_list|)
block|{
name|NG_FREE_ITEM
argument_list|(
name|item
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|ng_ccatm_rcvdump
parameter_list|(
name|hook_p
name|hook
parameter_list|,
name|item_p
name|item
parameter_list|)
block|{
name|NG_FREE_ITEM
argument_list|(
name|item
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|ng_ccatm_log
parameter_list|(
specifier|const
name|char
modifier|*
name|fmt
parameter_list|,
modifier|...
parameter_list|)
block|{
name|va_list
name|ap
decl_stmt|;
name|va_start
argument_list|(
name|ap
argument_list|,
name|fmt
argument_list|)
expr_stmt|;
name|vprintf
argument_list|(
name|fmt
argument_list|,
name|ap
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
name|va_end
argument_list|(
name|ap
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * Loading and unloading of node type  */
end_comment

begin_function
specifier|static
name|int
name|ng_ccatm_mod_event
parameter_list|(
name|module_t
name|mod
parameter_list|,
name|int
name|event
parameter_list|,
name|void
modifier|*
name|data
parameter_list|)
block|{
name|int
name|s
decl_stmt|;
name|int
name|error
init|=
literal|0
decl_stmt|;
name|s
operator|=
name|splnet
argument_list|()
expr_stmt|;
switch|switch
condition|(
name|event
condition|)
block|{
case|case
name|MOD_LOAD
case|:
break|break;
case|case
name|MOD_UNLOAD
case|:
break|break;
default|default:
name|error
operator|=
name|EOPNOTSUPP
expr_stmt|;
break|break;
block|}
name|splx
argument_list|(
name|s
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
end_function

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*	$FreeBSD$	*/
end_comment

begin_comment
comment|/*	$KAME: in6_prefix.c,v 1.47 2001/03/25 08:41:39 itojun Exp $	*/
end_comment

begin_comment
comment|/*  * Copyright (C) 1995, 1996, 1997, and 1998 WIDE Project.  * All rights reserved.  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions  * are met:  * 1. Redistributions of source code must retain the above copyright  *    notice, this list of conditions and the following disclaimer.  * 2. Redistributions in binary form must reproduce the above copyright  *    notice, this list of conditions and the following disclaimer in the  *    documentation and/or other materials provided with the distribution.  * 3. Neither the name of the project nor the names of its contributors  *    may be used to endorse or promote products derived from this software  *    without specific prior written permission.  *  * THIS SOFTWARE IS PROVIDED BY THE PROJECT AND CONTRIBUTORS ``AS IS'' AND  * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE  * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE  * ARE DISCLAIMED.  IN NO EVENT SHALL THE PROJECT OR CONTRIBUTORS BE LIABLE  * FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL  * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS  * OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)  * HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT  * LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY  * OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF  * SUCH DAMAGE.  */
end_comment

begin_comment
comment|/*  * Copyright (c) 1982, 1986, 1991, 1993  *	The Regents of the University of California.  All rights reserved.  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions  * are met:  * 1. Redistributions of source code must retain the above copyright  *    notice, this list of conditions and the following disclaimer.  * 2. Redistributions in binary form must reproduce the above copyright  *    notice, this list of conditions and the following disclaimer in the  *    documentation and/or other materials provided with the distribution.  * 3. All advertising materials mentioning features or use of this software  *    must display the following acknowledgement:  *	This product includes software developed by the University of  *	California, Berkeley and its contributors.  * 4. Neither the name of the University nor the names of its contributors  *    may be used to endorse or promote products derived from this software  *    without specific prior written permission.  *  * THIS SOFTWARE IS PROVIDED BY THE REGENTS AND CONTRIBUTORS ``AS IS'' AND  * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE  * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE  * ARE DISCLAIMED.  IN NO EVENT SHALL THE REGENTS OR CONTRIBUTORS BE LIABLE  * FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL  * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS  * OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)  * HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT  * LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY  * OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF  * SUCH DAMAGE.  *  *	@(#)in.c	8.2 (Berkeley) 11/15/93  */
end_comment

begin_include
include|#
directive|include
file|<sys/param.h>
end_include

begin_include
include|#
directive|include
file|<sys/malloc.h>
end_include

begin_include
include|#
directive|include
file|<sys/kernel.h>
end_include

begin_include
include|#
directive|include
file|<sys/socket.h>
end_include

begin_include
include|#
directive|include
file|<sys/socketvar.h>
end_include

begin_include
include|#
directive|include
file|<sys/sockio.h>
end_include

begin_include
include|#
directive|include
file|<sys/systm.h>
end_include

begin_include
include|#
directive|include
file|<sys/syslog.h>
end_include

begin_include
include|#
directive|include
file|<sys/proc.h>
end_include

begin_include
include|#
directive|include
file|<net/if.h>
end_include

begin_include
include|#
directive|include
file|<netinet/in.h>
end_include

begin_include
include|#
directive|include
file|<netinet/in_var.h>
end_include

begin_include
include|#
directive|include
file|<netinet/ip6.h>
end_include

begin_include
include|#
directive|include
file|<netinet6/in6_prefix.h>
end_include

begin_include
include|#
directive|include
file|<netinet6/ip6_var.h>
end_include

begin_expr_stmt
specifier|static
name|MALLOC_DEFINE
argument_list|(
name|M_IP6RR
argument_list|,
literal|"ip6rr"
argument_list|,
literal|"IPv6 Router Renumbering Prefix"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
specifier|static
name|MALLOC_DEFINE
argument_list|(
name|M_RR_ADDR
argument_list|,
literal|"rp_addr"
argument_list|,
literal|"IPv6 Router Renumbering Ifid"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_decl_stmt
name|struct
name|rr_prhead
name|rr_prefix
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|struct
name|callout
name|in6_rr_timer_ch
decl_stmt|;
end_decl_stmt

begin_include
include|#
directive|include
file|<net/net_osdep.h>
end_include

begin_decl_stmt
specifier|static
name|void
name|add_each_addr
name|__P
argument_list|(
operator|(
expr|struct
name|socket
operator|*
name|so
operator|,
expr|struct
name|rr_prefix
operator|*
name|rpp
operator|,
expr|struct
name|rp_addr
operator|*
name|rap
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|create_ra_entry
name|__P
argument_list|(
operator|(
expr|struct
name|rp_addr
operator|*
operator|*
name|rapp
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|add_each_prefix
name|__P
argument_list|(
operator|(
expr|struct
name|socket
operator|*
name|so
operator|,
expr|struct
name|rr_prefix
operator|*
name|rpp
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|void
name|free_rp_entries
name|__P
argument_list|(
operator|(
expr|struct
name|rr_prefix
operator|*
name|rpp
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|link_stray_ia6s
name|__P
argument_list|(
operator|(
expr|struct
name|rr_prefix
operator|*
name|rpp
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|void
name|rp_remove
name|__P
argument_list|(
operator|(
expr|struct
name|rr_prefix
operator|*
name|rpp
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_comment
comment|/*  * Copy bits from src to tgt, from off bit for len bits.  * Caller must specify collect tgtsize and srcsize.  */
end_comment

begin_function
specifier|static
name|void
name|bit_copy
parameter_list|(
name|char
modifier|*
name|tgt
parameter_list|,
name|u_int
name|tgtsize
parameter_list|,
name|char
modifier|*
name|src
parameter_list|,
name|u_int
name|srcsize
parameter_list|,
name|u_int
name|off
parameter_list|,
name|u_int
name|len
parameter_list|)
block|{
name|char
modifier|*
name|sp
decl_stmt|,
modifier|*
name|tp
decl_stmt|;
comment|/* arg values check */
if|if
condition|(
name|srcsize
operator|<
name|off
operator|||
name|srcsize
operator|<
operator|(
name|off
operator|+
name|len
operator|)
operator|||
name|tgtsize
operator|<
name|off
operator|||
name|tgtsize
operator|<
operator|(
name|off
operator|+
name|len
operator|)
condition|)
block|{
name|log
argument_list|(
name|LOG_ERR
argument_list|,
literal|"in6_prefix.c: bit_copy: invalid args: srcsize %d,\n"
literal|"tgtsize %d, off %d, len %d\n"
argument_list|,
name|srcsize
argument_list|,
name|tgtsize
argument_list|,
name|off
argument_list|,
name|len
argument_list|)
expr_stmt|;
return|return;
block|}
comment|/* search start point */
for|for
control|(
name|sp
operator|=
name|src
operator|,
name|tp
operator|=
name|tgt
init|;
name|off
operator|>=
literal|8
condition|;
name|sp
operator|++
operator|,
name|tp
operator|++
control|)
name|off
operator|-=
literal|8
expr_stmt|;
comment|/* copy starting bits */
if|if
condition|(
name|off
condition|)
block|{
name|char
name|setbit
decl_stmt|;
name|int
name|startbits
decl_stmt|;
name|startbits
operator|=
name|min
argument_list|(
operator|(
literal|8
operator|-
name|off
operator|)
argument_list|,
name|len
argument_list|)
expr_stmt|;
for|for
control|(
name|setbit
operator|=
operator|(
literal|0x80
operator|>>
name|off
operator|)
init|;
name|startbits
condition|;
name|setbit
operator|>>=
literal|1
operator|,
name|startbits
operator|--
operator|,
name|len
operator|--
control|)
operator|*
name|tp
operator||=
operator|(
name|setbit
operator|&
operator|*
name|sp
operator|)
expr_stmt|;
name|tp
operator|++
expr_stmt|;
name|sp
operator|++
expr_stmt|;
block|}
comment|/* copy midium bits */
for|for
control|(
init|;
name|len
operator|>=
literal|8
condition|;
name|sp
operator|++
operator|,
name|tp
operator|++
control|)
block|{
operator|*
name|tp
operator|=
operator|*
name|sp
expr_stmt|;
name|len
operator|-=
literal|8
expr_stmt|;
block|}
comment|/* copy ending bits */
if|if
condition|(
name|len
condition|)
block|{
name|char
name|setbit
decl_stmt|;
for|for
control|(
name|setbit
operator|=
literal|0x80
init|;
name|len
condition|;
name|setbit
operator|>>=
literal|1
operator|,
name|len
operator|--
control|)
operator|*
name|tp
operator||=
operator|(
name|setbit
operator|&
operator|*
name|sp
operator|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|struct
name|ifprefix
modifier|*
name|in6_prefixwithifp
parameter_list|(
name|struct
name|ifnet
modifier|*
name|ifp
parameter_list|,
name|int
name|plen
parameter_list|,
name|struct
name|in6_addr
modifier|*
name|dst
parameter_list|)
block|{
name|struct
name|ifprefix
modifier|*
name|ifpr
decl_stmt|;
comment|/* search matched prefix */
for|for
control|(
name|ifpr
operator|=
name|TAILQ_FIRST
argument_list|(
operator|&
name|ifp
operator|->
name|if_prefixhead
argument_list|)
init|;
name|ifpr
condition|;
name|ifpr
operator|=
name|TAILQ_NEXT
argument_list|(
name|ifpr
argument_list|,
name|ifpr_list
argument_list|)
control|)
block|{
if|if
condition|(
name|ifpr
operator|->
name|ifpr_prefix
operator|->
name|sa_family
operator|!=
name|AF_INET6
operator|||
name|ifpr
operator|->
name|ifpr_type
operator|!=
name|IN6_PREFIX_RR
condition|)
continue|continue;
if|if
condition|(
name|plen
operator|<=
name|in6_matchlen
argument_list|(
name|dst
argument_list|,
name|IFPR_IN6
argument_list|(
name|ifpr
argument_list|)
argument_list|)
condition|)
break|break;
block|}
return|return
operator|(
name|ifpr
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Search prefix which matches arg prefix as specified in  * draft-ietf-ipngwg-router-renum-08.txt  */
end_comment

begin_function
specifier|static
name|struct
name|rr_prefix
modifier|*
name|search_matched_prefix
parameter_list|(
name|struct
name|ifnet
modifier|*
name|ifp
parameter_list|,
name|struct
name|in6_prefixreq
modifier|*
name|ipr
parameter_list|)
block|{
name|struct
name|ifprefix
modifier|*
name|ifpr
decl_stmt|;
name|struct
name|ifaddr
modifier|*
name|ifa
decl_stmt|;
name|struct
name|rr_prefix
modifier|*
name|rpp
decl_stmt|;
comment|/* search matched prefix */
name|ifpr
operator|=
name|in6_prefixwithifp
argument_list|(
name|ifp
argument_list|,
name|ipr
operator|->
name|ipr_plen
argument_list|,
operator|&
name|ipr
operator|->
name|ipr_prefix
operator|.
name|sin6_addr
argument_list|)
expr_stmt|;
if|if
condition|(
name|ifpr
operator|!=
name|NULL
condition|)
return|return
name|ifpr2rp
argument_list|(
name|ifpr
argument_list|)
return|;
comment|/* 	 * search matched addr, and then search prefix 	 * which matches the addr 	 */
name|TAILQ_FOREACH
argument_list|(
argument|ifa
argument_list|,
argument|&ifp->if_addrlist
argument_list|,
argument|ifa_list
argument_list|)
block|{
if|if
condition|(
name|ifa
operator|->
name|ifa_addr
operator|->
name|sa_family
operator|!=
name|AF_INET6
condition|)
continue|continue;
if|if
condition|(
name|ipr
operator|->
name|ipr_plen
operator|<=
name|in6_matchlen
argument_list|(
operator|&
name|ipr
operator|->
name|ipr_prefix
operator|.
name|sin6_addr
argument_list|,
name|IFA_IN6
argument_list|(
name|ifa
argument_list|)
argument_list|)
condition|)
break|break;
block|}
if|if
condition|(
name|ifa
operator|==
name|NULL
condition|)
return|return
name|NULL
return|;
name|rpp
operator|=
name|ifpr2rp
argument_list|(
operator|(
operator|(
expr|struct
name|in6_ifaddr
operator|*
operator|)
name|ifa
operator|)
operator|->
name|ia6_ifpr
argument_list|)
expr_stmt|;
if|if
condition|(
name|rpp
operator|!=
literal|0
condition|)
return|return
name|rpp
return|;
for|for
control|(
name|ifpr
operator|=
name|TAILQ_FIRST
argument_list|(
operator|&
name|ifp
operator|->
name|if_prefixhead
argument_list|)
init|;
name|ifpr
condition|;
name|ifpr
operator|=
name|TAILQ_NEXT
argument_list|(
name|ifpr
argument_list|,
name|ifpr_list
argument_list|)
control|)
block|{
if|if
condition|(
name|ifpr
operator|->
name|ifpr_prefix
operator|->
name|sa_family
operator|!=
name|AF_INET6
operator|||
name|ifpr
operator|->
name|ifpr_type
operator|!=
name|IN6_PREFIX_RR
condition|)
continue|continue;
if|if
condition|(
name|ifpr
operator|->
name|ifpr_plen
operator|<=
name|in6_matchlen
argument_list|(
name|IFA_IN6
argument_list|(
name|ifa
argument_list|)
argument_list|,
name|IFPR_IN6
argument_list|(
name|ifpr
argument_list|)
argument_list|)
condition|)
break|break;
block|}
if|if
condition|(
name|ifpr
operator|!=
name|NULL
condition|)
name|log
argument_list|(
name|LOG_ERR
argument_list|,
literal|"in6_prefix.c: search_matched_prefix: addr %s"
literal|"has no pointer to prefix %s\n"
argument_list|,
name|ip6_sprintf
argument_list|(
name|IFA_IN6
argument_list|(
name|ifa
argument_list|)
argument_list|)
argument_list|,
name|ip6_sprintf
argument_list|(
name|IFPR_IN6
argument_list|(
name|ifpr
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|ifpr2rp
argument_list|(
name|ifpr
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/*  * Search prefix which matches arg prefix as specified in  * draft-ietf-ipngwg-router-renum-08.txt, and mark it if exists.  * Return 1 if anything matched, and 0 if nothing matched.  */
end_comment

begin_function
specifier|static
name|int
name|mark_matched_prefixes
parameter_list|(
name|u_long
name|cmd
parameter_list|,
name|struct
name|ifnet
modifier|*
name|ifp
parameter_list|,
name|struct
name|in6_rrenumreq
modifier|*
name|irr
parameter_list|)
block|{
name|struct
name|ifprefix
modifier|*
name|ifpr
decl_stmt|;
name|struct
name|ifaddr
modifier|*
name|ifa
decl_stmt|;
name|int
name|matchlen
decl_stmt|,
name|matched
init|=
literal|0
decl_stmt|;
comment|/* search matched prefixes */
for|for
control|(
name|ifpr
operator|=
name|TAILQ_FIRST
argument_list|(
operator|&
name|ifp
operator|->
name|if_prefixhead
argument_list|)
init|;
name|ifpr
condition|;
name|ifpr
operator|=
name|TAILQ_NEXT
argument_list|(
name|ifpr
argument_list|,
name|ifpr_list
argument_list|)
control|)
block|{
if|if
condition|(
name|ifpr
operator|->
name|ifpr_prefix
operator|->
name|sa_family
operator|!=
name|AF_INET6
operator|||
name|ifpr
operator|->
name|ifpr_type
operator|!=
name|IN6_PREFIX_RR
condition|)
continue|continue;
name|matchlen
operator|=
name|in6_matchlen
argument_list|(
operator|&
name|irr
operator|->
name|irr_matchprefix
operator|.
name|sin6_addr
argument_list|,
name|IFPR_IN6
argument_list|(
name|ifpr
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|irr
operator|->
name|irr_m_minlen
operator|>
name|ifpr
operator|->
name|ifpr_plen
operator|||
name|irr
operator|->
name|irr_m_maxlen
operator|<
name|ifpr
operator|->
name|ifpr_plen
operator|||
name|irr
operator|->
name|irr_m_len
operator|>
name|matchlen
condition|)
continue|continue;
name|matched
operator|=
literal|1
expr_stmt|;
name|ifpr2rp
argument_list|(
name|ifpr
argument_list|)
operator|->
name|rp_statef_addmark
operator|=
literal|1
expr_stmt|;
if|if
condition|(
name|cmd
operator|==
name|SIOCCIFPREFIX_IN6
condition|)
name|ifpr2rp
argument_list|(
name|ifpr
argument_list|)
operator|->
name|rp_statef_delmark
operator|=
literal|1
expr_stmt|;
block|}
comment|/* 	 * search matched addr, and then search prefixes 	 * which matche the addr 	 */
name|TAILQ_FOREACH
argument_list|(
argument|ifa
argument_list|,
argument|&ifp->if_addrlist
argument_list|,
argument|ifa_list
argument_list|)
block|{
name|struct
name|rr_prefix
modifier|*
name|rpp
decl_stmt|;
if|if
condition|(
name|ifa
operator|->
name|ifa_addr
operator|->
name|sa_family
operator|!=
name|AF_INET6
condition|)
continue|continue;
name|matchlen
operator|=
name|in6_matchlen
argument_list|(
operator|&
name|irr
operator|->
name|irr_matchprefix
operator|.
name|sin6_addr
argument_list|,
name|IFA_IN6
argument_list|(
name|ifa
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|irr
operator|->
name|irr_m_minlen
operator|>
name|matchlen
operator|||
name|irr
operator|->
name|irr_m_maxlen
operator|<
name|matchlen
operator|||
name|irr
operator|->
name|irr_m_len
operator|>
name|matchlen
condition|)
continue|continue;
name|rpp
operator|=
name|ifpr2rp
argument_list|(
operator|(
operator|(
expr|struct
name|in6_ifaddr
operator|*
operator|)
name|ifa
operator|)
operator|->
name|ia6_ifpr
argument_list|)
expr_stmt|;
if|if
condition|(
name|rpp
operator|!=
literal|0
condition|)
block|{
name|matched
operator|=
literal|1
expr_stmt|;
name|rpp
operator|->
name|rp_statef_addmark
operator|=
literal|1
expr_stmt|;
if|if
condition|(
name|cmd
operator|==
name|SIOCCIFPREFIX_IN6
condition|)
name|rpp
operator|->
name|rp_statef_delmark
operator|=
literal|1
expr_stmt|;
block|}
else|else
name|log
argument_list|(
name|LOG_WARNING
argument_list|,
literal|"in6_prefix.c: mark_matched_prefixes:"
literal|"no back pointer to ifprefix for %s. "
literal|"ND autoconfigured addr?\n"
argument_list|,
name|ip6_sprintf
argument_list|(
name|IFA_IN6
argument_list|(
name|ifa
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
block|}
return|return
name|matched
return|;
block|}
end_function

begin_comment
comment|/*  * Mark global prefixes as to be deleted.  */
end_comment

begin_function
specifier|static
name|void
name|delmark_global_prefixes
parameter_list|(
name|struct
name|ifnet
modifier|*
name|ifp
parameter_list|,
name|struct
name|in6_rrenumreq
modifier|*
name|irr
parameter_list|)
block|{
name|struct
name|ifprefix
modifier|*
name|ifpr
decl_stmt|;
comment|/* search matched prefixes */
for|for
control|(
name|ifpr
operator|=
name|TAILQ_FIRST
argument_list|(
operator|&
name|ifp
operator|->
name|if_prefixhead
argument_list|)
init|;
name|ifpr
condition|;
name|ifpr
operator|=
name|TAILQ_NEXT
argument_list|(
name|ifpr
argument_list|,
name|ifpr_list
argument_list|)
control|)
block|{
if|if
condition|(
name|ifpr
operator|->
name|ifpr_prefix
operator|->
name|sa_family
operator|!=
name|AF_INET6
operator|||
name|ifpr
operator|->
name|ifpr_type
operator|!=
name|IN6_PREFIX_RR
condition|)
continue|continue;
comment|/* mark delete global prefix */
if|if
condition|(
name|in6_addrscope
argument_list|(
name|RP_IN6
argument_list|(
name|ifpr2rp
argument_list|(
name|ifpr
argument_list|)
argument_list|)
argument_list|)
operator|==
name|IPV6_ADDR_SCOPE_GLOBAL
condition|)
name|ifpr2rp
argument_list|(
name|ifpr
argument_list|)
operator|->
name|rp_statef_delmark
operator|=
literal|1
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/* Unmark prefixes */
end_comment

begin_function
specifier|static
name|void
name|unmark_prefixes
parameter_list|(
name|struct
name|ifnet
modifier|*
name|ifp
parameter_list|)
block|{
name|struct
name|ifprefix
modifier|*
name|ifpr
decl_stmt|;
comment|/* unmark all prefix */
for|for
control|(
name|ifpr
operator|=
name|TAILQ_FIRST
argument_list|(
operator|&
name|ifp
operator|->
name|if_prefixhead
argument_list|)
init|;
name|ifpr
condition|;
name|ifpr
operator|=
name|TAILQ_NEXT
argument_list|(
name|ifpr
argument_list|,
name|ifpr_list
argument_list|)
control|)
block|{
if|if
condition|(
name|ifpr
operator|->
name|ifpr_prefix
operator|->
name|sa_family
operator|!=
name|AF_INET6
operator|||
name|ifpr
operator|->
name|ifpr_type
operator|!=
name|IN6_PREFIX_RR
condition|)
continue|continue;
comment|/* unmark prefix */
name|ifpr2rp
argument_list|(
name|ifpr
argument_list|)
operator|->
name|rp_statef_addmark
operator|=
literal|0
expr_stmt|;
name|ifpr2rp
argument_list|(
name|ifpr
argument_list|)
operator|->
name|rp_statef_delmark
operator|=
literal|0
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|init_prefix_ltimes
parameter_list|(
name|struct
name|rr_prefix
modifier|*
name|rpp
parameter_list|)
block|{
if|if
condition|(
name|rpp
operator|->
name|rp_pltime
operator|==
name|RR_INFINITE_LIFETIME
operator|||
name|rpp
operator|->
name|rp_rrf_decrprefd
operator|==
literal|0
condition|)
name|rpp
operator|->
name|rp_preferred
operator|=
literal|0
expr_stmt|;
else|else
name|rpp
operator|->
name|rp_preferred
operator|=
name|time_second
operator|+
name|rpp
operator|->
name|rp_pltime
expr_stmt|;
if|if
condition|(
name|rpp
operator|->
name|rp_vltime
operator|==
name|RR_INFINITE_LIFETIME
operator|||
name|rpp
operator|->
name|rp_rrf_decrvalid
operator|==
literal|0
condition|)
name|rpp
operator|->
name|rp_expire
operator|=
literal|0
expr_stmt|;
else|else
name|rpp
operator|->
name|rp_expire
operator|=
name|time_second
operator|+
name|rpp
operator|->
name|rp_vltime
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|rr_are_ifid_equal
parameter_list|(
name|struct
name|in6_addr
modifier|*
name|ii1
parameter_list|,
name|struct
name|in6_addr
modifier|*
name|ii2
parameter_list|,
name|int
name|ii_len
parameter_list|)
block|{
name|int
name|ii_bytelen
decl_stmt|,
name|ii_bitlen
decl_stmt|;
name|int
name|p_bytelen
decl_stmt|,
name|p_bitlen
decl_stmt|;
comment|/* sanity check */
if|if
condition|(
literal|1
operator|>
name|ii_len
operator|||
name|ii_len
operator|>
literal|124
condition|)
block|{
comment|/* as RFC2373, prefix is at least 4 bit */
name|log
argument_list|(
name|LOG_ERR
argument_list|,
literal|"rr_are_ifid_equal: invalid ifid length(%d)\n"
argument_list|,
name|ii_len
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
name|ii_bytelen
operator|=
name|ii_len
operator|/
literal|8
expr_stmt|;
name|ii_bitlen
operator|=
name|ii_len
operator|%
literal|8
expr_stmt|;
name|p_bytelen
operator|=
sizeof|sizeof
argument_list|(
expr|struct
name|in6_addr
argument_list|)
operator|-
name|ii_bytelen
operator|-
literal|1
expr_stmt|;
name|p_bitlen
operator|=
literal|8
operator|-
name|ii_bitlen
expr_stmt|;
if|if
condition|(
name|bcmp
argument_list|(
name|ii1
operator|->
name|s6_addr
operator|+
name|p_bytelen
operator|+
literal|1
argument_list|,
name|ii2
operator|->
name|s6_addr
operator|+
name|p_bytelen
operator|+
literal|1
argument_list|,
name|ii_bytelen
argument_list|)
condition|)
return|return
operator|(
literal|0
operator|)
return|;
if|if
condition|(
operator|(
operator|(
name|ii1
operator|->
name|s6_addr
index|[
name|p_bytelen
index|]
operator|<<
name|p_bitlen
operator|)
operator|&
literal|0xff
operator|)
operator|!=
operator|(
operator|(
name|ii2
operator|->
name|s6_addr
index|[
name|p_bytelen
index|]
operator|<<
name|p_bitlen
operator|)
operator|&
literal|0xff
operator|)
condition|)
return|return
operator|(
literal|0
operator|)
return|;
return|return
operator|(
literal|1
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|struct
name|rp_addr
modifier|*
name|search_ifidwithprefix
parameter_list|(
name|struct
name|rr_prefix
modifier|*
name|rpp
parameter_list|,
name|struct
name|in6_addr
modifier|*
name|ifid
parameter_list|)
block|{
name|struct
name|rp_addr
modifier|*
name|rap
decl_stmt|;
name|LIST_FOREACH
argument_list|(
argument|rap
argument_list|,
argument|&rpp->rp_addrhead
argument_list|,
argument|ra_entry
argument_list|)
block|{
if|if
condition|(
name|rr_are_ifid_equal
argument_list|(
name|ifid
argument_list|,
operator|&
name|rap
operator|->
name|ra_ifid
argument_list|,
operator|(
sizeof|sizeof
argument_list|(
expr|struct
name|in6_addr
argument_list|)
operator|<<
literal|3
operator|)
operator|-
name|rpp
operator|->
name|rp_plen
argument_list|)
condition|)
break|break;
block|}
return|return
name|rap
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|assign_ra_entry
parameter_list|(
name|struct
name|rr_prefix
modifier|*
name|rpp
parameter_list|,
name|int
name|iilen
parameter_list|,
name|struct
name|in6_ifaddr
modifier|*
name|ia
parameter_list|)
block|{
name|int
name|error
init|=
literal|0
decl_stmt|;
name|struct
name|rp_addr
modifier|*
name|rap
decl_stmt|;
name|int
name|s
decl_stmt|;
if|if
condition|(
operator|(
name|error
operator|=
name|create_ra_entry
argument_list|(
operator|&
name|rap
argument_list|)
operator|)
operator|!=
literal|0
condition|)
return|return
name|error
return|;
comment|/* copy interface id part */
name|bit_copy
argument_list|(
operator|(
name|caddr_t
operator|)
operator|&
name|rap
operator|->
name|ra_ifid
argument_list|,
sizeof|sizeof
argument_list|(
name|rap
operator|->
name|ra_ifid
argument_list|)
operator|<<
literal|3
argument_list|,
operator|(
name|caddr_t
operator|)
name|IA6_IN6
argument_list|(
name|ia
argument_list|)
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|IA6_IN6
argument_list|(
name|ia
argument_list|)
argument_list|)
operator|<<
literal|3
argument_list|,
name|rpp
operator|->
name|rp_plen
argument_list|,
name|iilen
argument_list|)
expr_stmt|;
comment|/* link to ia, and put into list */
name|rap
operator|->
name|ra_addr
operator|=
name|ia
expr_stmt|;
name|IFAREF
argument_list|(
operator|&
name|rap
operator|->
name|ra_addr
operator|->
name|ia_ifa
argument_list|)
expr_stmt|;
if|#
directive|if
literal|0
comment|/* Can't do this now, because rpp may be on th stack. should fix it? */
block|ia->ia6_ifpr = rp2ifpr(rpp);
endif|#
directive|endif
name|s
operator|=
name|splnet
argument_list|()
expr_stmt|;
name|LIST_INSERT_HEAD
argument_list|(
operator|&
name|rpp
operator|->
name|rp_addrhead
argument_list|,
name|rap
argument_list|,
name|ra_entry
argument_list|)
expr_stmt|;
name|splx
argument_list|(
name|s
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/*  * add a link-local address to an interface.  we will add new interface address  * (prefix database + new interface id).  */
end_comment

begin_function
specifier|static
name|int
name|in6_prefix_add_llifid
parameter_list|(
name|int
name|iilen
parameter_list|,
name|struct
name|in6_ifaddr
modifier|*
name|ia
parameter_list|)
block|{
name|struct
name|rr_prefix
modifier|*
name|rpp
decl_stmt|;
name|struct
name|rp_addr
modifier|*
name|rap
decl_stmt|;
name|struct
name|socket
name|so
decl_stmt|;
name|int
name|error
decl_stmt|,
name|s
decl_stmt|;
if|if
condition|(
operator|(
name|error
operator|=
name|create_ra_entry
argument_list|(
operator|&
name|rap
argument_list|)
operator|)
operator|!=
literal|0
condition|)
return|return
operator|(
name|error
operator|)
return|;
comment|/* copy interface id part */
name|bit_copy
argument_list|(
operator|(
name|caddr_t
operator|)
operator|&
name|rap
operator|->
name|ra_ifid
argument_list|,
sizeof|sizeof
argument_list|(
name|rap
operator|->
name|ra_ifid
argument_list|)
operator|<<
literal|3
argument_list|,
operator|(
name|caddr_t
operator|)
name|IA6_IN6
argument_list|(
name|ia
argument_list|)
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|IA6_IN6
argument_list|(
name|ia
argument_list|)
argument_list|)
operator|<<
literal|3
argument_list|,
literal|64
argument_list|,
operator|(
sizeof|sizeof
argument_list|(
name|rap
operator|->
name|ra_ifid
argument_list|)
operator|<<
literal|3
operator|)
operator|-
literal|64
argument_list|)
expr_stmt|;
comment|/* XXX: init dummy so */
name|bzero
argument_list|(
operator|&
name|so
argument_list|,
sizeof|sizeof
argument_list|(
name|so
argument_list|)
argument_list|)
expr_stmt|;
comment|/* insert into list */
name|LIST_FOREACH
argument_list|(
argument|rpp
argument_list|,
argument|&rr_prefix
argument_list|,
argument|rp_entry
argument_list|)
block|{
comment|/* 		 * do not attempt to add an address, if ifp does not match 		 */
if|if
condition|(
name|rpp
operator|->
name|rp_ifp
operator|!=
name|ia
operator|->
name|ia_ifp
condition|)
continue|continue;
name|s
operator|=
name|splnet
argument_list|()
expr_stmt|;
name|LIST_INSERT_HEAD
argument_list|(
operator|&
name|rpp
operator|->
name|rp_addrhead
argument_list|,
name|rap
argument_list|,
name|ra_entry
argument_list|)
expr_stmt|;
name|splx
argument_list|(
name|s
argument_list|)
expr_stmt|;
name|add_each_addr
argument_list|(
operator|&
name|so
argument_list|,
name|rpp
argument_list|,
name|rap
argument_list|)
expr_stmt|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/*  * add an address to an interface.  if the interface id portion is new,  * we will add new interface address (prefix database + new interface id).  */
end_comment

begin_function
name|int
name|in6_prefix_add_ifid
parameter_list|(
name|int
name|iilen
parameter_list|,
name|struct
name|in6_ifaddr
modifier|*
name|ia
parameter_list|)
block|{
name|int
name|plen
init|=
operator|(
sizeof|sizeof
argument_list|(
operator|*
name|IA6_IN6
argument_list|(
name|ia
argument_list|)
argument_list|)
operator|<<
literal|3
operator|)
operator|-
name|iilen
decl_stmt|;
name|struct
name|ifprefix
modifier|*
name|ifpr
decl_stmt|;
name|struct
name|rp_addr
modifier|*
name|rap
decl_stmt|;
name|int
name|error
init|=
literal|0
decl_stmt|;
if|if
condition|(
name|IN6_IS_ADDR_LINKLOCAL
argument_list|(
name|IA6_IN6
argument_list|(
name|ia
argument_list|)
argument_list|)
condition|)
return|return
operator|(
name|in6_prefix_add_llifid
argument_list|(
name|iilen
argument_list|,
name|ia
argument_list|)
operator|)
return|;
name|ifpr
operator|=
name|in6_prefixwithifp
argument_list|(
name|ia
operator|->
name|ia_ifp
argument_list|,
name|plen
argument_list|,
name|IA6_IN6
argument_list|(
name|ia
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|ifpr
operator|==
name|NULL
condition|)
block|{
name|struct
name|rr_prefix
name|rp
decl_stmt|;
name|struct
name|socket
name|so
decl_stmt|;
name|int
name|pplen
init|=
operator|(
name|plen
operator|==
literal|128
operator|)
condition|?
literal|64
else|:
name|plen
decl_stmt|;
comment|/* XXX hardcoded 64 is bad */
comment|/* allocate a prefix for ia, with default properties */
comment|/* init rp */
name|bzero
argument_list|(
operator|&
name|rp
argument_list|,
sizeof|sizeof
argument_list|(
name|rp
argument_list|)
argument_list|)
expr_stmt|;
name|rp
operator|.
name|rp_type
operator|=
name|IN6_PREFIX_RR
expr_stmt|;
name|rp
operator|.
name|rp_ifp
operator|=
name|ia
operator|->
name|ia_ifp
expr_stmt|;
name|rp
operator|.
name|rp_plen
operator|=
name|pplen
expr_stmt|;
name|rp
operator|.
name|rp_prefix
operator|.
name|sin6_len
operator|=
sizeof|sizeof
argument_list|(
name|rp
operator|.
name|rp_prefix
argument_list|)
expr_stmt|;
name|rp
operator|.
name|rp_prefix
operator|.
name|sin6_family
operator|=
name|AF_INET6
expr_stmt|;
name|bit_copy
argument_list|(
operator|(
name|char
operator|*
operator|)
name|RP_IN6
argument_list|(
operator|&
name|rp
argument_list|)
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|RP_IN6
argument_list|(
operator|&
name|rp
argument_list|)
argument_list|)
operator|<<
literal|3
argument_list|,
operator|(
name|char
operator|*
operator|)
operator|&
name|ia
operator|->
name|ia_addr
operator|.
name|sin6_addr
argument_list|,
sizeof|sizeof
argument_list|(
name|ia
operator|->
name|ia_addr
operator|.
name|sin6_addr
argument_list|)
operator|<<
literal|3
argument_list|,
literal|0
argument_list|,
name|pplen
argument_list|)
expr_stmt|;
name|rp
operator|.
name|rp_vltime
operator|=
name|rp
operator|.
name|rp_pltime
operator|=
name|RR_INFINITE_LIFETIME
expr_stmt|;
name|rp
operator|.
name|rp_raf_onlink
operator|=
literal|1
expr_stmt|;
name|rp
operator|.
name|rp_raf_auto
operator|=
literal|1
expr_stmt|;
comment|/* Is some FlagMasks for rrf necessary? */
name|rp
operator|.
name|rp_rrf_decrvalid
operator|=
name|rp
operator|.
name|rp_rrf_decrprefd
operator|=
literal|0
expr_stmt|;
name|rp
operator|.
name|rp_origin
operator|=
name|PR_ORIG_RR
expr_stmt|;
comment|/* can be renumbered */
comment|/* create ra_entry */
name|error
operator|=
name|link_stray_ia6s
argument_list|(
operator|&
name|rp
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|!=
literal|0
condition|)
block|{
name|free_rp_entries
argument_list|(
operator|&
name|rp
argument_list|)
expr_stmt|;
return|return
name|error
return|;
block|}
comment|/* XXX: init dummy so */
name|bzero
argument_list|(
operator|&
name|so
argument_list|,
sizeof|sizeof
argument_list|(
name|so
argument_list|)
argument_list|)
expr_stmt|;
name|error
operator|=
name|add_each_prefix
argument_list|(
operator|&
name|so
argument_list|,
operator|&
name|rp
argument_list|)
expr_stmt|;
comment|/* free each rp_addr entry */
name|free_rp_entries
argument_list|(
operator|&
name|rp
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|!=
literal|0
condition|)
return|return
name|error
return|;
comment|/* search again */
name|ifpr
operator|=
name|in6_prefixwithifp
argument_list|(
name|ia
operator|->
name|ia_ifp
argument_list|,
name|pplen
argument_list|,
name|IA6_IN6
argument_list|(
name|ia
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|ifpr
operator|==
name|NULL
condition|)
return|return
literal|0
return|;
block|}
name|rap
operator|=
name|search_ifidwithprefix
argument_list|(
name|ifpr2rp
argument_list|(
name|ifpr
argument_list|)
argument_list|,
name|IA6_IN6
argument_list|(
name|ia
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|rap
operator|!=
name|NULL
condition|)
block|{
if|if
condition|(
name|rap
operator|->
name|ra_addr
operator|==
name|NULL
condition|)
block|{
name|rap
operator|->
name|ra_addr
operator|=
name|ia
expr_stmt|;
name|IFAREF
argument_list|(
operator|&
name|rap
operator|->
name|ra_addr
operator|->
name|ia_ifa
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|rap
operator|->
name|ra_addr
operator|!=
name|ia
condition|)
block|{
comment|/* There may be some inconsistencies between addrs. */
name|log
argument_list|(
name|LOG_ERR
argument_list|,
literal|"ip6_prefix.c: addr %s/%d matched prefix"
literal|" already has another ia %p(%s) on its ifid list\n"
argument_list|,
name|ip6_sprintf
argument_list|(
name|IA6_IN6
argument_list|(
name|ia
argument_list|)
argument_list|)
argument_list|,
name|plen
argument_list|,
name|rap
operator|->
name|ra_addr
argument_list|,
name|ip6_sprintf
argument_list|(
name|IA6_IN6
argument_list|(
name|rap
operator|->
name|ra_addr
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|EADDRINUSE
comment|/* XXX */
return|;
block|}
name|ia
operator|->
name|ia6_ifpr
operator|=
name|ifpr
expr_stmt|;
return|return
literal|0
return|;
block|}
name|error
operator|=
name|assign_ra_entry
argument_list|(
name|ifpr2rp
argument_list|(
name|ifpr
argument_list|)
argument_list|,
name|iilen
argument_list|,
name|ia
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|==
literal|0
condition|)
name|ia
operator|->
name|ia6_ifpr
operator|=
name|ifpr
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
end_function

begin_function
name|void
name|in6_prefix_remove_ifid
parameter_list|(
name|int
name|iilen
parameter_list|,
name|struct
name|in6_ifaddr
modifier|*
name|ia
parameter_list|)
block|{
name|struct
name|rp_addr
modifier|*
name|rap
decl_stmt|;
if|if
condition|(
name|ia
operator|->
name|ia6_ifpr
operator|==
name|NULL
condition|)
return|return;
name|rap
operator|=
name|search_ifidwithprefix
argument_list|(
name|ifpr2rp
argument_list|(
name|ia
operator|->
name|ia6_ifpr
argument_list|)
argument_list|,
name|IA6_IN6
argument_list|(
name|ia
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|rap
operator|!=
name|NULL
condition|)
block|{
name|int
name|s
init|=
name|splnet
argument_list|()
decl_stmt|;
name|LIST_REMOVE
argument_list|(
name|rap
argument_list|,
name|ra_entry
argument_list|)
expr_stmt|;
name|splx
argument_list|(
name|s
argument_list|)
expr_stmt|;
if|if
condition|(
name|rap
operator|->
name|ra_addr
condition|)
name|IFAFREE
argument_list|(
operator|&
name|rap
operator|->
name|ra_addr
operator|->
name|ia_ifa
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|rap
argument_list|,
name|M_RR_ADDR
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|LIST_EMPTY
argument_list|(
operator|&
name|ifpr2rp
argument_list|(
name|ia
operator|->
name|ia6_ifpr
argument_list|)
operator|->
name|rp_addrhead
argument_list|)
condition|)
name|rp_remove
argument_list|(
name|ifpr2rp
argument_list|(
name|ia
operator|->
name|ia6_ifpr
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|in6_purgeprefix
parameter_list|(
name|ifp
parameter_list|)
name|struct
name|ifnet
modifier|*
name|ifp
decl_stmt|;
block|{
name|struct
name|ifprefix
modifier|*
name|ifpr
decl_stmt|,
modifier|*
name|nextifpr
decl_stmt|;
comment|/* delete prefixes before ifnet goes away */
for|for
control|(
name|ifpr
operator|=
name|TAILQ_FIRST
argument_list|(
operator|&
name|ifp
operator|->
name|if_prefixhead
argument_list|)
init|;
name|ifpr
condition|;
name|ifpr
operator|=
name|nextifpr
control|)
block|{
name|nextifpr
operator|=
name|TAILQ_NEXT
argument_list|(
name|ifpr
argument_list|,
name|ifpr_list
argument_list|)
expr_stmt|;
if|if
condition|(
name|ifpr
operator|->
name|ifpr_prefix
operator|->
name|sa_family
operator|!=
name|AF_INET6
operator|||
name|ifpr
operator|->
name|ifpr_type
operator|!=
name|IN6_PREFIX_RR
condition|)
continue|continue;
operator|(
name|void
operator|)
name|delete_each_prefix
argument_list|(
name|ifpr2rp
argument_list|(
name|ifpr
argument_list|)
argument_list|,
name|PR_ORIG_KERNEL
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|add_each_addr
parameter_list|(
name|struct
name|socket
modifier|*
name|so
parameter_list|,
name|struct
name|rr_prefix
modifier|*
name|rpp
parameter_list|,
name|struct
name|rp_addr
modifier|*
name|rap
parameter_list|)
block|{
name|struct
name|in6_ifaddr
modifier|*
name|ia6
decl_stmt|;
name|struct
name|in6_aliasreq
name|ifra
decl_stmt|;
name|int
name|error
decl_stmt|;
comment|/* init ifra */
name|bzero
argument_list|(
operator|&
name|ifra
argument_list|,
sizeof|sizeof
argument_list|(
name|ifra
argument_list|)
argument_list|)
expr_stmt|;
name|strncpy
argument_list|(
name|ifra
operator|.
name|ifra_name
argument_list|,
name|if_name
argument_list|(
name|rpp
operator|->
name|rp_ifp
argument_list|)
argument_list|,
sizeof|sizeof
argument_list|(
name|ifra
operator|.
name|ifra_name
argument_list|)
argument_list|)
expr_stmt|;
name|ifra
operator|.
name|ifra_addr
operator|.
name|sin6_family
operator|=
name|ifra
operator|.
name|ifra_prefixmask
operator|.
name|sin6_family
operator|=
name|AF_INET6
expr_stmt|;
name|ifra
operator|.
name|ifra_addr
operator|.
name|sin6_len
operator|=
name|ifra
operator|.
name|ifra_prefixmask
operator|.
name|sin6_len
operator|=
sizeof|sizeof
argument_list|(
name|ifra
operator|.
name|ifra_addr
argument_list|)
expr_stmt|;
comment|/* copy prefix part */
name|bit_copy
argument_list|(
operator|(
name|char
operator|*
operator|)
operator|&
name|ifra
operator|.
name|ifra_addr
operator|.
name|sin6_addr
argument_list|,
sizeof|sizeof
argument_list|(
name|ifra
operator|.
name|ifra_addr
operator|.
name|sin6_addr
argument_list|)
operator|<<
literal|3
argument_list|,
operator|(
name|char
operator|*
operator|)
name|RP_IN6
argument_list|(
name|rpp
argument_list|)
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|RP_IN6
argument_list|(
name|rpp
argument_list|)
argument_list|)
operator|<<
literal|3
argument_list|,
literal|0
argument_list|,
name|rpp
operator|->
name|rp_plen
argument_list|)
expr_stmt|;
comment|/* copy interface id part */
name|bit_copy
argument_list|(
operator|(
name|char
operator|*
operator|)
operator|&
name|ifra
operator|.
name|ifra_addr
operator|.
name|sin6_addr
argument_list|,
sizeof|sizeof
argument_list|(
name|ifra
operator|.
name|ifra_addr
operator|.
name|sin6_addr
argument_list|)
operator|<<
literal|3
argument_list|,
operator|(
name|char
operator|*
operator|)
operator|&
name|rap
operator|->
name|ra_ifid
argument_list|,
sizeof|sizeof
argument_list|(
name|rap
operator|->
name|ra_ifid
argument_list|)
operator|<<
literal|3
argument_list|,
name|rpp
operator|->
name|rp_plen
argument_list|,
operator|(
sizeof|sizeof
argument_list|(
name|rap
operator|->
name|ra_ifid
argument_list|)
operator|<<
literal|3
operator|)
operator|-
name|rpp
operator|->
name|rp_plen
argument_list|)
expr_stmt|;
name|in6_prefixlen2mask
argument_list|(
operator|&
name|ifra
operator|.
name|ifra_prefixmask
operator|.
name|sin6_addr
argument_list|,
name|rpp
operator|->
name|rp_plen
argument_list|)
expr_stmt|;
comment|/* don't care ifra_flags for now */
comment|/* 	 * XXX: if we did this with finite lifetime values, the lifetimes would 	 *      decrese in time and never incremented. 	 *      we should need more clarifications on the prefix mechanism... 	 */
name|ifra
operator|.
name|ifra_lifetime
operator|.
name|ia6t_vltime
operator|=
name|rpp
operator|->
name|rp_vltime
expr_stmt|;
name|ifra
operator|.
name|ifra_lifetime
operator|.
name|ia6t_pltime
operator|=
name|rpp
operator|->
name|rp_pltime
expr_stmt|;
name|ia6
operator|=
name|in6ifa_ifpwithaddr
argument_list|(
name|rpp
operator|->
name|rp_ifp
argument_list|,
operator|&
name|ifra
operator|.
name|ifra_addr
operator|.
name|sin6_addr
argument_list|)
expr_stmt|;
if|if
condition|(
name|ia6
operator|!=
name|NULL
condition|)
block|{
if|if
condition|(
name|ia6
operator|->
name|ia6_ifpr
operator|==
name|NULL
condition|)
block|{
comment|/* link this addr and the prefix each other */
if|if
condition|(
name|rap
operator|->
name|ra_addr
condition|)
name|IFAFREE
argument_list|(
operator|&
name|rap
operator|->
name|ra_addr
operator|->
name|ia_ifa
argument_list|)
expr_stmt|;
name|rap
operator|->
name|ra_addr
operator|=
name|ia6
expr_stmt|;
name|IFAREF
argument_list|(
operator|&
name|rap
operator|->
name|ra_addr
operator|->
name|ia_ifa
argument_list|)
expr_stmt|;
name|ia6
operator|->
name|ia6_ifpr
operator|=
name|rp2ifpr
argument_list|(
name|rpp
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|ia6
operator|->
name|ia6_ifpr
operator|==
name|rp2ifpr
argument_list|(
name|rpp
argument_list|)
condition|)
block|{
if|if
condition|(
name|rap
operator|->
name|ra_addr
condition|)
name|IFAFREE
argument_list|(
operator|&
name|rap
operator|->
name|ra_addr
operator|->
name|ia_ifa
argument_list|)
expr_stmt|;
name|rap
operator|->
name|ra_addr
operator|=
name|ia6
expr_stmt|;
name|IFAREF
argument_list|(
operator|&
name|rap
operator|->
name|ra_addr
operator|->
name|ia_ifa
argument_list|)
expr_stmt|;
return|return;
block|}
comment|/* 		 * The addr is already assigned to other 		 * prefix. 		 * There may be some inconsistencies between 		 * prefixes. 		 * e.g. overraped prefixes with common starting 		 *      part and different plefixlen. 		 *      Or, completely duplicated prefixes? 		 * log it and return. 		 */
name|log
argument_list|(
name|LOG_ERR
argument_list|,
literal|"in6_prefix.c: add_each_addr: addition of an addr %s/%d "
literal|"failed because there is already another addr %s/%d\n"
argument_list|,
name|ip6_sprintf
argument_list|(
operator|&
name|ifra
operator|.
name|ifra_addr
operator|.
name|sin6_addr
argument_list|)
argument_list|,
name|rpp
operator|->
name|rp_plen
argument_list|,
name|ip6_sprintf
argument_list|(
name|IA6_IN6
argument_list|(
name|ia6
argument_list|)
argument_list|)
argument_list|,
name|in6_mask2len
argument_list|(
operator|&
name|ia6
operator|->
name|ia_prefixmask
operator|.
name|sin6_addr
argument_list|,
name|NULL
argument_list|)
argument_list|)
expr_stmt|;
return|return;
block|}
comment|/* propagate ANYCAST flag if it is set for ancestor addr */
if|if
condition|(
name|rap
operator|->
name|ra_flags
operator|.
name|anycast
operator|!=
literal|0
condition|)
name|ifra
operator|.
name|ifra_flags
operator||=
name|IN6_IFF_ANYCAST
expr_stmt|;
name|error
operator|=
name|in6_control
argument_list|(
name|so
argument_list|,
name|SIOCAIFADDR_IN6
argument_list|,
operator|(
name|caddr_t
operator|)
operator|&
name|ifra
argument_list|,
name|rpp
operator|->
name|rp_ifp
argument_list|,
name|curproc
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|!=
literal|0
condition|)
block|{
name|log
argument_list|(
name|LOG_ERR
argument_list|,
literal|"in6_prefix.c: add_each_addr: addition of an addr"
literal|"%s/%d failed because in6_control failed for error %d\n"
argument_list|,
name|ip6_sprintf
argument_list|(
operator|&
name|ifra
operator|.
name|ifra_addr
operator|.
name|sin6_addr
argument_list|)
argument_list|,
name|rpp
operator|->
name|rp_plen
argument_list|,
name|error
argument_list|)
expr_stmt|;
return|return;
block|}
comment|/* 	 * link beween this addr and the prefix will be done 	 * in in6_prefix_add_ifid 	 */
block|}
end_function

begin_function
specifier|static
name|int
name|rrpr_update
parameter_list|(
name|struct
name|socket
modifier|*
name|so
parameter_list|,
name|struct
name|rr_prefix
modifier|*
name|new
parameter_list|)
block|{
name|struct
name|rr_prefix
modifier|*
name|rpp
decl_stmt|;
name|struct
name|ifprefix
modifier|*
name|ifpr
decl_stmt|;
name|struct
name|rp_addr
modifier|*
name|rap
decl_stmt|;
name|int
name|s
decl_stmt|;
comment|/* search existing prefix */
for|for
control|(
name|ifpr
operator|=
name|TAILQ_FIRST
argument_list|(
operator|&
name|new
operator|->
name|rp_ifp
operator|->
name|if_prefixhead
argument_list|)
init|;
name|ifpr
condition|;
name|ifpr
operator|=
name|TAILQ_NEXT
argument_list|(
name|ifpr
argument_list|,
name|ifpr_list
argument_list|)
control|)
block|{
if|if
condition|(
name|ifpr
operator|->
name|ifpr_prefix
operator|->
name|sa_family
operator|!=
name|AF_INET6
operator|||
name|ifpr
operator|->
name|ifpr_type
operator|!=
name|IN6_PREFIX_RR
condition|)
continue|continue;
if|if
condition|(
name|ifpr
operator|->
name|ifpr_plen
operator|==
name|new
operator|->
name|rp_plen
operator|&&
name|in6_are_prefix_equal
argument_list|(
name|IFPR_IN6
argument_list|(
name|ifpr
argument_list|)
argument_list|,
name|RP_IN6
argument_list|(
name|new
argument_list|)
argument_list|,
name|ifpr
operator|->
name|ifpr_plen
argument_list|)
condition|)
break|break;
block|}
name|rpp
operator|=
name|ifpr2rp
argument_list|(
name|ifpr
argument_list|)
expr_stmt|;
if|if
condition|(
name|rpp
operator|!=
name|NULL
condition|)
block|{
comment|/* 		 * We got a prefix which we have seen in the past. 		 */
comment|/* 		 * If the origin of the already-installed prefix is more 		 * preferable than the new one, ignore installation request. 		 */
if|if
condition|(
name|rpp
operator|->
name|rp_origin
operator|>
name|new
operator|->
name|rp_origin
condition|)
return|return
operator|(
name|EPERM
operator|)
return|;
comment|/* update prefix information */
name|rpp
operator|->
name|rp_flags
operator|.
name|prf_ra
operator|=
name|new
operator|->
name|rp_flags
operator|.
name|prf_ra
expr_stmt|;
if|if
condition|(
name|rpp
operator|->
name|rp_origin
operator|>=
name|PR_ORIG_RR
condition|)
name|rpp
operator|->
name|rp_flags
operator|.
name|prf_rr
operator|=
name|new
operator|->
name|rp_flags
operator|.
name|prf_rr
expr_stmt|;
name|rpp
operator|->
name|rp_vltime
operator|=
name|new
operator|->
name|rp_vltime
expr_stmt|;
name|rpp
operator|->
name|rp_pltime
operator|=
name|new
operator|->
name|rp_pltime
expr_stmt|;
name|rpp
operator|->
name|rp_expire
operator|=
name|new
operator|->
name|rp_expire
expr_stmt|;
name|rpp
operator|->
name|rp_preferred
operator|=
name|new
operator|->
name|rp_preferred
expr_stmt|;
name|rpp
operator|->
name|rp_statef_delmark
operator|=
literal|0
expr_stmt|;
comment|/* cancel deletion */
comment|/* 		 * Interface id related update. 		 *  add rp_addr entries in new into rpp, if they have not 		 *  been already included in rpp. 		 */
while|while
condition|(
operator|!
name|LIST_EMPTY
argument_list|(
operator|&
name|new
operator|->
name|rp_addrhead
argument_list|)
condition|)
block|{
name|rap
operator|=
name|LIST_FIRST
argument_list|(
operator|&
name|new
operator|->
name|rp_addrhead
argument_list|)
expr_stmt|;
name|LIST_REMOVE
argument_list|(
name|rap
argument_list|,
name|ra_entry
argument_list|)
expr_stmt|;
if|if
condition|(
name|search_ifidwithprefix
argument_list|(
name|rpp
argument_list|,
operator|&
name|rap
operator|->
name|ra_ifid
argument_list|)
operator|!=
name|NULL
condition|)
block|{
if|if
condition|(
name|rap
operator|->
name|ra_addr
condition|)
name|IFAFREE
argument_list|(
operator|&
name|rap
operator|->
name|ra_addr
operator|->
name|ia_ifa
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|rap
argument_list|,
name|M_RR_ADDR
argument_list|)
expr_stmt|;
continue|continue;
block|}
name|s
operator|=
name|splnet
argument_list|()
expr_stmt|;
name|LIST_INSERT_HEAD
argument_list|(
operator|&
name|rpp
operator|->
name|rp_addrhead
argument_list|,
name|rap
argument_list|,
name|ra_entry
argument_list|)
expr_stmt|;
name|splx
argument_list|(
name|s
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
comment|/* 		 * We got a fresh prefix. 		 */
comment|/* create new prefix */
name|rpp
operator|=
operator|(
expr|struct
name|rr_prefix
operator|*
operator|)
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|rpp
argument_list|)
argument_list|,
name|M_IP6RR
argument_list|,
name|M_NOWAIT
argument_list|)
expr_stmt|;
if|if
condition|(
name|rpp
operator|==
name|NULL
condition|)
block|{
name|log
argument_list|(
name|LOG_ERR
argument_list|,
literal|"in6_prefix.c: rrpr_update:%d"
literal|": ENOBUFS for rr_prefix\n"
argument_list|,
name|__LINE__
argument_list|)
expr_stmt|;
return|return
operator|(
name|ENOBUFS
operator|)
return|;
block|}
comment|/* initilization */
operator|*
name|rpp
operator|=
operator|*
name|new
expr_stmt|;
name|LIST_INIT
argument_list|(
operator|&
name|rpp
operator|->
name|rp_addrhead
argument_list|)
expr_stmt|;
comment|/*  move rp_addr entries of new to rpp */
while|while
condition|(
operator|!
name|LIST_EMPTY
argument_list|(
operator|&
name|new
operator|->
name|rp_addrhead
argument_list|)
condition|)
block|{
name|rap
operator|=
name|LIST_FIRST
argument_list|(
operator|&
name|new
operator|->
name|rp_addrhead
argument_list|)
expr_stmt|;
name|LIST_REMOVE
argument_list|(
name|rap
argument_list|,
name|ra_entry
argument_list|)
expr_stmt|;
name|LIST_INSERT_HEAD
argument_list|(
operator|&
name|rpp
operator|->
name|rp_addrhead
argument_list|,
name|rap
argument_list|,
name|ra_entry
argument_list|)
expr_stmt|;
block|}
comment|/* let rp_ifpr.ifpr_prefix point rr_prefix. */
name|rpp
operator|->
name|rp_ifpr
operator|.
name|ifpr_prefix
operator|=
operator|(
expr|struct
name|sockaddr
operator|*
operator|)
operator|&
name|rpp
operator|->
name|rp_prefix
expr_stmt|;
comment|/* link rr_prefix entry to if_prefixlist */
block|{
name|struct
name|ifnet
modifier|*
name|ifp
init|=
name|rpp
operator|->
name|rp_ifp
decl_stmt|;
name|struct
name|ifprefix
modifier|*
name|ifpr
decl_stmt|;
if|if
condition|(
operator|(
name|ifpr
operator|=
name|TAILQ_FIRST
argument_list|(
operator|&
name|ifp
operator|->
name|if_prefixhead
argument_list|)
operator|)
operator|!=
name|NULL
condition|)
block|{
for|for
control|(
init|;
name|TAILQ_NEXT
argument_list|(
name|ifpr
argument_list|,
name|ifpr_list
argument_list|)
condition|;
name|ifpr
operator|=
name|TAILQ_NEXT
argument_list|(
name|ifpr
argument_list|,
name|ifpr_list
argument_list|)
control|)
continue|continue;
name|TAILQ_NEXT
argument_list|(
name|ifpr
argument_list|,
name|ifpr_list
argument_list|)
operator|=
name|rp2ifpr
argument_list|(
name|rpp
argument_list|)
expr_stmt|;
block|}
else|else
name|TAILQ_FIRST
argument_list|(
operator|&
name|ifp
operator|->
name|if_prefixhead
argument_list|)
operator|=
name|rp2ifpr
argument_list|(
name|rpp
argument_list|)
expr_stmt|;
name|rp2ifpr
argument_list|(
name|rpp
argument_list|)
operator|->
name|ifpr_type
operator|=
name|IN6_PREFIX_RR
expr_stmt|;
block|}
comment|/* link rr_prefix entry to rr_prefix list */
name|s
operator|=
name|splnet
argument_list|()
expr_stmt|;
name|LIST_INSERT_HEAD
argument_list|(
operator|&
name|rr_prefix
argument_list|,
name|rpp
argument_list|,
name|rp_entry
argument_list|)
expr_stmt|;
name|splx
argument_list|(
name|s
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|new
operator|->
name|rp_raf_auto
condition|)
return|return
literal|0
return|;
comment|/* 	 * Add an address for each interface id, if it is not yet 	 * If it existed but not pointing to the prefix yet, 	 * init the prefix pointer. 	 */
name|LIST_FOREACH
argument_list|(
argument|rap
argument_list|,
argument|&rpp->rp_addrhead
argument_list|,
argument|ra_entry
argument_list|)
block|{
if|if
condition|(
name|rap
operator|->
name|ra_addr
operator|!=
name|NULL
condition|)
block|{
if|if
condition|(
name|rap
operator|->
name|ra_addr
operator|->
name|ia6_ifpr
operator|==
name|NULL
condition|)
name|rap
operator|->
name|ra_addr
operator|->
name|ia6_ifpr
operator|=
name|rp2ifpr
argument_list|(
name|rpp
argument_list|)
expr_stmt|;
continue|continue;
block|}
name|add_each_addr
argument_list|(
name|so
argument_list|,
name|rpp
argument_list|,
name|rap
argument_list|)
expr_stmt|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|add_each_prefix
parameter_list|(
name|struct
name|socket
modifier|*
name|so
parameter_list|,
name|struct
name|rr_prefix
modifier|*
name|rpp
parameter_list|)
block|{
name|init_prefix_ltimes
argument_list|(
name|rpp
argument_list|)
expr_stmt|;
return|return
operator|(
name|rrpr_update
argument_list|(
name|so
argument_list|,
name|rpp
argument_list|)
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|rp_remove
parameter_list|(
name|struct
name|rr_prefix
modifier|*
name|rpp
parameter_list|)
block|{
name|int
name|s
decl_stmt|;
name|s
operator|=
name|splnet
argument_list|()
expr_stmt|;
comment|/* unlink rp_entry from if_prefixlist */
block|{
name|struct
name|ifnet
modifier|*
name|ifp
init|=
name|rpp
operator|->
name|rp_ifp
decl_stmt|;
name|struct
name|ifprefix
modifier|*
name|ifpr
decl_stmt|;
if|if
condition|(
operator|(
name|ifpr
operator|=
name|TAILQ_FIRST
argument_list|(
operator|&
name|ifp
operator|->
name|if_prefixhead
argument_list|)
operator|)
operator|==
name|rp2ifpr
argument_list|(
name|rpp
argument_list|)
condition|)
name|TAILQ_FIRST
argument_list|(
operator|&
name|ifp
operator|->
name|if_prefixhead
argument_list|)
operator|=
name|TAILQ_NEXT
argument_list|(
name|ifpr
argument_list|,
name|ifpr_list
argument_list|)
expr_stmt|;
else|else
block|{
while|while
condition|(
name|TAILQ_NEXT
argument_list|(
name|ifpr
argument_list|,
name|ifpr_list
argument_list|)
operator|!=
name|NULL
operator|&&
operator|(
name|TAILQ_NEXT
argument_list|(
name|ifpr
argument_list|,
name|ifpr_list
argument_list|)
operator|!=
name|rp2ifpr
argument_list|(
name|rpp
argument_list|)
operator|)
condition|)
name|ifpr
operator|=
name|TAILQ_NEXT
argument_list|(
name|ifpr
argument_list|,
name|ifpr_list
argument_list|)
expr_stmt|;
if|if
condition|(
name|TAILQ_NEXT
argument_list|(
name|ifpr
argument_list|,
name|ifpr_list
argument_list|)
condition|)
name|TAILQ_NEXT
argument_list|(
name|ifpr
argument_list|,
name|ifpr_list
argument_list|)
operator|=
name|TAILQ_NEXT
argument_list|(
name|rp2ifpr
argument_list|(
name|rpp
argument_list|)
argument_list|,
name|ifpr_list
argument_list|)
expr_stmt|;
else|else
name|printf
argument_list|(
literal|"Couldn't unlink rr_prefix from ifp\n"
argument_list|)
expr_stmt|;
block|}
block|}
comment|/* unlink rp_entry from rr_prefix list */
name|LIST_REMOVE
argument_list|(
name|rpp
argument_list|,
name|rp_entry
argument_list|)
expr_stmt|;
name|splx
argument_list|(
name|s
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|rpp
argument_list|,
name|M_IP6RR
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|create_ra_entry
parameter_list|(
name|struct
name|rp_addr
modifier|*
modifier|*
name|rapp
parameter_list|)
block|{
operator|*
name|rapp
operator|=
operator|(
expr|struct
name|rp_addr
operator|*
operator|)
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
expr|struct
name|rp_addr
argument_list|)
argument_list|,
name|M_RR_ADDR
argument_list|,
name|M_NOWAIT
argument_list|)
expr_stmt|;
if|if
condition|(
operator|*
name|rapp
operator|==
name|NULL
condition|)
block|{
name|log
argument_list|(
name|LOG_ERR
argument_list|,
literal|"in6_prefix.c: init_newprefix:%d: ENOBUFS"
literal|"for rp_addr\n"
argument_list|,
name|__LINE__
argument_list|)
expr_stmt|;
return|return
name|ENOBUFS
return|;
block|}
name|bzero
argument_list|(
operator|*
name|rapp
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
operator|(
operator|*
name|rapp
operator|)
argument_list|)
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|init_newprefix
parameter_list|(
name|struct
name|in6_rrenumreq
modifier|*
name|irr
parameter_list|,
name|struct
name|ifprefix
modifier|*
name|ifpr
parameter_list|,
name|struct
name|rr_prefix
modifier|*
name|rpp
parameter_list|)
block|{
name|struct
name|rp_addr
modifier|*
name|orap
decl_stmt|;
comment|/* init rp */
name|bzero
argument_list|(
name|rpp
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|rpp
argument_list|)
argument_list|)
expr_stmt|;
name|rpp
operator|->
name|rp_type
operator|=
name|IN6_PREFIX_RR
expr_stmt|;
name|rpp
operator|->
name|rp_ifp
operator|=
name|ifpr
operator|->
name|ifpr_ifp
expr_stmt|;
name|rpp
operator|->
name|rp_plen
operator|=
name|ifpr
operator|->
name|ifpr_plen
expr_stmt|;
name|rpp
operator|->
name|rp_prefix
operator|.
name|sin6_len
operator|=
sizeof|sizeof
argument_list|(
name|rpp
operator|->
name|rp_prefix
argument_list|)
expr_stmt|;
name|rpp
operator|->
name|rp_prefix
operator|.
name|sin6_family
operator|=
name|AF_INET6
expr_stmt|;
name|bit_copy
argument_list|(
operator|(
name|char
operator|*
operator|)
name|RP_IN6
argument_list|(
name|rpp
argument_list|)
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|RP_IN6
argument_list|(
name|rpp
argument_list|)
argument_list|)
operator|<<
literal|3
argument_list|,
operator|(
name|char
operator|*
operator|)
operator|&
name|irr
operator|->
name|irr_useprefix
operator|.
name|sin6_addr
argument_list|,
sizeof|sizeof
argument_list|(
name|irr
operator|->
name|irr_useprefix
operator|.
name|sin6_addr
argument_list|)
operator|<<
literal|3
argument_list|,
literal|0
argument_list|,
name|irr
operator|->
name|irr_u_uselen
argument_list|)
expr_stmt|;
comment|/* copy keeplen part if necessary as necessary len */
if|if
condition|(
name|irr
operator|->
name|irr_u_uselen
operator|<
name|ifpr
operator|->
name|ifpr_plen
condition|)
name|bit_copy
argument_list|(
operator|(
name|char
operator|*
operator|)
name|RP_IN6
argument_list|(
name|rpp
argument_list|)
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|RP_IN6
argument_list|(
name|rpp
argument_list|)
argument_list|)
operator|<<
literal|3
argument_list|,
operator|(
name|char
operator|*
operator|)
name|IFPR_IN6
argument_list|(
name|ifpr
argument_list|)
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|IFPR_IN6
argument_list|(
name|ifpr
argument_list|)
argument_list|)
operator|<<
literal|3
argument_list|,
name|irr
operator|->
name|irr_u_uselen
argument_list|,
name|min
argument_list|(
name|ifpr
operator|->
name|ifpr_plen
operator|-
name|irr
operator|->
name|irr_u_uselen
argument_list|,
name|irr
operator|->
name|irr_u_keeplen
argument_list|)
argument_list|)
expr_stmt|;
name|LIST_FOREACH
argument_list|(
argument|orap
argument_list|,
argument|&(ifpr2rp(ifpr)->rp_addrhead)
argument_list|,
argument|ra_entry
argument_list|)
block|{
name|struct
name|rp_addr
modifier|*
name|rap
decl_stmt|;
name|int
name|error
init|=
literal|0
decl_stmt|;
if|if
condition|(
operator|(
name|error
operator|=
name|create_ra_entry
argument_list|(
operator|&
name|rap
argument_list|)
operator|)
operator|!=
literal|0
condition|)
return|return
name|error
return|;
name|rap
operator|->
name|ra_ifid
operator|=
name|orap
operator|->
name|ra_ifid
expr_stmt|;
name|rap
operator|->
name|ra_flags
operator|.
name|anycast
operator|=
operator|(
name|orap
operator|->
name|ra_addr
operator|!=
name|NULL
operator|&&
operator|(
name|orap
operator|->
name|ra_addr
operator|->
name|ia6_flags
operator|&
name|IN6_IFF_ANYCAST
operator|)
operator|!=
literal|0
operator|)
condition|?
literal|1
else|:
literal|0
expr_stmt|;
name|LIST_INSERT_HEAD
argument_list|(
operator|&
name|rpp
operator|->
name|rp_addrhead
argument_list|,
name|rap
argument_list|,
name|ra_entry
argument_list|)
expr_stmt|;
block|}
name|rpp
operator|->
name|rp_vltime
operator|=
name|irr
operator|->
name|irr_vltime
expr_stmt|;
name|rpp
operator|->
name|rp_pltime
operator|=
name|irr
operator|->
name|irr_pltime
expr_stmt|;
name|rpp
operator|->
name|rp_raf_onlink
operator|=
name|irr
operator|->
name|irr_raf_mask_onlink
condition|?
name|irr
operator|->
name|irr_raf_onlink
else|:
name|ifpr2rp
argument_list|(
name|ifpr
argument_list|)
operator|->
name|rp_raf_onlink
expr_stmt|;
name|rpp
operator|->
name|rp_raf_auto
operator|=
name|irr
operator|->
name|irr_raf_mask_auto
condition|?
name|irr
operator|->
name|irr_raf_auto
else|:
name|ifpr2rp
argument_list|(
name|ifpr
argument_list|)
operator|->
name|rp_raf_auto
expr_stmt|;
comment|/* Is some FlagMasks for rrf necessary? */
name|rpp
operator|->
name|rp_rrf
operator|=
name|irr
operator|->
name|irr_rrf
expr_stmt|;
name|rpp
operator|->
name|rp_origin
operator|=
name|irr
operator|->
name|irr_origin
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|free_rp_entries
parameter_list|(
name|struct
name|rr_prefix
modifier|*
name|rpp
parameter_list|)
block|{
comment|/* 	 * This func is only called with rpp on stack(not on list). 	 * So no splnet() here 	 */
while|while
condition|(
operator|!
name|LIST_EMPTY
argument_list|(
operator|&
name|rpp
operator|->
name|rp_addrhead
argument_list|)
condition|)
block|{
name|struct
name|rp_addr
modifier|*
name|rap
decl_stmt|;
name|rap
operator|=
name|LIST_FIRST
argument_list|(
operator|&
name|rpp
operator|->
name|rp_addrhead
argument_list|)
expr_stmt|;
name|LIST_REMOVE
argument_list|(
name|rap
argument_list|,
name|ra_entry
argument_list|)
expr_stmt|;
if|if
condition|(
name|rap
operator|->
name|ra_addr
condition|)
name|IFAFREE
argument_list|(
operator|&
name|rap
operator|->
name|ra_addr
operator|->
name|ia_ifa
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|rap
argument_list|,
name|M_RR_ADDR
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|int
name|add_useprefixes
parameter_list|(
name|struct
name|socket
modifier|*
name|so
parameter_list|,
name|struct
name|ifnet
modifier|*
name|ifp
parameter_list|,
name|struct
name|in6_rrenumreq
modifier|*
name|irr
parameter_list|)
block|{
name|struct
name|ifprefix
modifier|*
name|ifpr
decl_stmt|,
modifier|*
name|nextifpr
decl_stmt|;
name|struct
name|rr_prefix
name|rp
decl_stmt|;
name|int
name|error
init|=
literal|0
decl_stmt|;
comment|/* add prefixes to each of marked prefix */
for|for
control|(
name|ifpr
operator|=
name|TAILQ_FIRST
argument_list|(
operator|&
name|ifp
operator|->
name|if_prefixhead
argument_list|)
init|;
name|ifpr
condition|;
name|ifpr
operator|=
name|nextifpr
control|)
block|{
name|nextifpr
operator|=
name|TAILQ_NEXT
argument_list|(
name|ifpr
argument_list|,
name|ifpr_list
argument_list|)
expr_stmt|;
if|if
condition|(
name|ifpr
operator|->
name|ifpr_prefix
operator|->
name|sa_family
operator|!=
name|AF_INET6
operator|||
name|ifpr
operator|->
name|ifpr_type
operator|!=
name|IN6_PREFIX_RR
condition|)
continue|continue;
if|if
condition|(
name|ifpr2rp
argument_list|(
name|ifpr
argument_list|)
operator|->
name|rp_statef_addmark
condition|)
block|{
if|if
condition|(
operator|(
name|error
operator|=
name|init_newprefix
argument_list|(
name|irr
argument_list|,
name|ifpr
argument_list|,
operator|&
name|rp
argument_list|)
operator|)
operator|!=
literal|0
condition|)
break|break;
name|error
operator|=
name|add_each_prefix
argument_list|(
name|so
argument_list|,
operator|&
name|rp
argument_list|)
expr_stmt|;
block|}
block|}
comment|/* free each rp_addr entry */
name|free_rp_entries
argument_list|(
operator|&
name|rp
argument_list|)
expr_stmt|;
return|return
name|error
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|unprefer_prefix
parameter_list|(
name|struct
name|rr_prefix
modifier|*
name|rpp
parameter_list|)
block|{
name|struct
name|rp_addr
modifier|*
name|rap
decl_stmt|;
for|for
control|(
name|rap
operator|=
name|rpp
operator|->
name|rp_addrhead
operator|.
name|lh_first
init|;
name|rap
operator|!=
name|NULL
condition|;
name|rap
operator|=
name|rap
operator|->
name|ra_entry
operator|.
name|le_next
control|)
block|{
if|if
condition|(
name|rap
operator|->
name|ra_addr
operator|==
name|NULL
condition|)
continue|continue;
name|rap
operator|->
name|ra_addr
operator|->
name|ia6_lifetime
operator|.
name|ia6t_preferred
operator|=
name|time_second
expr_stmt|;
name|rap
operator|->
name|ra_addr
operator|->
name|ia6_lifetime
operator|.
name|ia6t_pltime
operator|=
literal|0
expr_stmt|;
block|}
block|}
end_function

begin_function
name|int
name|delete_each_prefix
parameter_list|(
name|struct
name|rr_prefix
modifier|*
name|rpp
parameter_list|,
name|u_char
name|origin
parameter_list|)
block|{
name|int
name|error
init|=
literal|0
decl_stmt|;
if|if
condition|(
name|rpp
operator|->
name|rp_origin
operator|>
name|origin
condition|)
return|return
operator|(
name|EPERM
operator|)
return|;
while|while
condition|(
name|rpp
operator|->
name|rp_addrhead
operator|.
name|lh_first
operator|!=
name|NULL
condition|)
block|{
name|struct
name|rp_addr
modifier|*
name|rap
decl_stmt|;
name|int
name|s
decl_stmt|;
name|s
operator|=
name|splnet
argument_list|()
expr_stmt|;
name|rap
operator|=
name|LIST_FIRST
argument_list|(
operator|&
name|rpp
operator|->
name|rp_addrhead
argument_list|)
expr_stmt|;
if|if
condition|(
name|rap
operator|==
name|NULL
condition|)
block|{
name|splx
argument_list|(
name|s
argument_list|)
expr_stmt|;
break|break;
block|}
name|LIST_REMOVE
argument_list|(
name|rap
argument_list|,
name|ra_entry
argument_list|)
expr_stmt|;
name|splx
argument_list|(
name|s
argument_list|)
expr_stmt|;
if|if
condition|(
name|rap
operator|->
name|ra_addr
operator|==
name|NULL
condition|)
block|{
name|free
argument_list|(
name|rap
argument_list|,
name|M_RR_ADDR
argument_list|)
expr_stmt|;
continue|continue;
block|}
name|rap
operator|->
name|ra_addr
operator|->
name|ia6_ifpr
operator|=
name|NULL
expr_stmt|;
name|in6_purgeaddr
argument_list|(
operator|&
name|rap
operator|->
name|ra_addr
operator|->
name|ia_ifa
argument_list|)
expr_stmt|;
name|IFAFREE
argument_list|(
operator|&
name|rap
operator|->
name|ra_addr
operator|->
name|ia_ifa
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|rap
argument_list|,
name|M_RR_ADDR
argument_list|)
expr_stmt|;
block|}
name|rp_remove
argument_list|(
name|rpp
argument_list|)
expr_stmt|;
return|return
name|error
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|delete_prefixes
parameter_list|(
name|struct
name|ifnet
modifier|*
name|ifp
parameter_list|,
name|u_char
name|origin
parameter_list|)
block|{
name|struct
name|ifprefix
modifier|*
name|ifpr
decl_stmt|,
modifier|*
name|nextifpr
decl_stmt|;
comment|/* delete prefixes marked as tobe deleted */
for|for
control|(
name|ifpr
operator|=
name|TAILQ_FIRST
argument_list|(
operator|&
name|ifp
operator|->
name|if_prefixhead
argument_list|)
init|;
name|ifpr
condition|;
name|ifpr
operator|=
name|nextifpr
control|)
block|{
name|nextifpr
operator|=
name|TAILQ_NEXT
argument_list|(
name|ifpr
argument_list|,
name|ifpr_list
argument_list|)
expr_stmt|;
if|if
condition|(
name|ifpr
operator|->
name|ifpr_prefix
operator|->
name|sa_family
operator|!=
name|AF_INET6
operator|||
name|ifpr
operator|->
name|ifpr_type
operator|!=
name|IN6_PREFIX_RR
condition|)
continue|continue;
if|if
condition|(
name|ifpr2rp
argument_list|(
name|ifpr
argument_list|)
operator|->
name|rp_statef_delmark
condition|)
operator|(
name|void
operator|)
name|delete_each_prefix
argument_list|(
name|ifpr2rp
argument_list|(
name|ifpr
argument_list|)
argument_list|,
name|origin
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|int
name|link_stray_ia6s
parameter_list|(
name|struct
name|rr_prefix
modifier|*
name|rpp
parameter_list|)
block|{
name|struct
name|ifaddr
modifier|*
name|ifa
decl_stmt|;
for|for
control|(
name|ifa
operator|=
name|rpp
operator|->
name|rp_ifp
operator|->
name|if_addrlist
operator|.
name|tqh_first
init|;
name|ifa
condition|;
name|ifa
operator|=
name|ifa
operator|->
name|ifa_list
operator|.
name|tqe_next
control|)
block|{
name|struct
name|rp_addr
modifier|*
name|rap
decl_stmt|;
name|struct
name|rr_prefix
modifier|*
name|orpp
decl_stmt|;
name|int
name|error
init|=
literal|0
decl_stmt|;
if|if
condition|(
name|ifa
operator|->
name|ifa_addr
operator|->
name|sa_family
operator|!=
name|AF_INET6
condition|)
continue|continue;
if|if
condition|(
name|rpp
operator|->
name|rp_plen
operator|>
name|in6_matchlen
argument_list|(
name|RP_IN6
argument_list|(
name|rpp
argument_list|)
argument_list|,
name|IFA_IN6
argument_list|(
name|ifa
argument_list|)
argument_list|)
condition|)
continue|continue;
name|orpp
operator|=
name|ifpr2rp
argument_list|(
operator|(
operator|(
expr|struct
name|in6_ifaddr
operator|*
operator|)
name|ifa
operator|)
operator|->
name|ia6_ifpr
argument_list|)
expr_stmt|;
if|if
condition|(
name|orpp
operator|!=
name|NULL
condition|)
block|{
if|if
condition|(
operator|!
name|in6_are_prefix_equal
argument_list|(
name|RP_IN6
argument_list|(
name|orpp
argument_list|)
argument_list|,
name|RP_IN6
argument_list|(
name|rpp
argument_list|)
argument_list|,
name|rpp
operator|->
name|rp_plen
argument_list|)
condition|)
name|log
argument_list|(
name|LOG_ERR
argument_list|,
literal|"in6_prefix.c: link_stray_ia6s:"
literal|"addr %s/%d already linked to a prefix"
literal|"and it matches also %s/%d\n"
argument_list|,
name|ip6_sprintf
argument_list|(
name|IFA_IN6
argument_list|(
name|ifa
argument_list|)
argument_list|)
argument_list|,
name|orpp
operator|->
name|rp_plen
argument_list|,
name|ip6_sprintf
argument_list|(
name|RP_IN6
argument_list|(
name|rpp
argument_list|)
argument_list|)
argument_list|,
name|rpp
operator|->
name|rp_plen
argument_list|)
expr_stmt|;
continue|continue;
block|}
if|if
condition|(
operator|(
name|error
operator|=
name|assign_ra_entry
argument_list|(
name|rpp
argument_list|,
operator|(
sizeof|sizeof
argument_list|(
name|rap
operator|->
name|ra_ifid
argument_list|)
operator|<<
literal|3
operator|)
operator|-
name|rpp
operator|->
name|rp_plen
argument_list|,
operator|(
expr|struct
name|in6_ifaddr
operator|*
operator|)
name|ifa
argument_list|)
operator|)
operator|!=
literal|0
condition|)
return|return
name|error
return|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/* XXX assumes that permission is already checked by the caller */
end_comment

begin_function
name|int
name|in6_prefix_ioctl
parameter_list|(
name|struct
name|socket
modifier|*
name|so
parameter_list|,
name|u_long
name|cmd
parameter_list|,
name|caddr_t
name|data
parameter_list|,
name|struct
name|ifnet
modifier|*
name|ifp
parameter_list|)
block|{
name|struct
name|rr_prefix
modifier|*
name|rpp
decl_stmt|,
name|rp_tmp
decl_stmt|;
name|struct
name|rp_addr
modifier|*
name|rap
decl_stmt|;
name|struct
name|in6_prefixreq
modifier|*
name|ipr
init|=
operator|(
expr|struct
name|in6_prefixreq
operator|*
operator|)
name|data
decl_stmt|;
name|struct
name|in6_rrenumreq
modifier|*
name|irr
init|=
operator|(
expr|struct
name|in6_rrenumreq
operator|*
operator|)
name|data
decl_stmt|;
name|struct
name|ifaddr
modifier|*
name|ifa
decl_stmt|;
name|int
name|error
init|=
literal|0
decl_stmt|;
comment|/* 	 * Failsafe for errneous address config program. 	 * Let's hope rrenumd don't make a mistakes. 	 */
if|if
condition|(
name|ipr
operator|->
name|ipr_origin
operator|<=
name|PR_ORIG_RA
condition|)
name|ipr
operator|->
name|ipr_origin
operator|=
name|PR_ORIG_STATIC
expr_stmt|;
switch|switch
condition|(
name|cmd
condition|)
block|{
case|case
name|SIOCSGIFPREFIX_IN6
case|:
name|delmark_global_prefixes
argument_list|(
name|ifp
argument_list|,
name|irr
argument_list|)
expr_stmt|;
comment|/* FALL THROUGH */
case|case
name|SIOCAIFPREFIX_IN6
case|:
case|case
name|SIOCCIFPREFIX_IN6
case|:
comment|/* check if preferred lifetime> valid lifetime */
if|if
condition|(
name|irr
operator|->
name|irr_pltime
operator|>
name|irr
operator|->
name|irr_vltime
condition|)
block|{
name|log
argument_list|(
name|LOG_NOTICE
argument_list|,
literal|"in6_prefix_ioctl: preferred lifetime"
literal|"(%ld) is greater than valid lifetime(%ld)\n"
argument_list|,
operator|(
name|u_long
operator|)
name|irr
operator|->
name|irr_pltime
argument_list|,
operator|(
name|u_long
operator|)
name|irr
operator|->
name|irr_vltime
argument_list|)
expr_stmt|;
name|error
operator|=
name|EINVAL
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|mark_matched_prefixes
argument_list|(
name|cmd
argument_list|,
name|ifp
argument_list|,
name|irr
argument_list|)
condition|)
block|{
if|if
condition|(
name|irr
operator|->
name|irr_u_uselen
operator|!=
literal|0
condition|)
if|if
condition|(
operator|(
name|error
operator|=
name|add_useprefixes
argument_list|(
name|so
argument_list|,
name|ifp
argument_list|,
name|irr
argument_list|)
operator|)
operator|!=
literal|0
condition|)
goto|goto
name|failed
goto|;
if|if
condition|(
name|cmd
operator|!=
name|SIOCAIFPREFIX_IN6
condition|)
name|delete_prefixes
argument_list|(
name|ifp
argument_list|,
name|irr
operator|->
name|irr_origin
argument_list|)
expr_stmt|;
block|}
else|else
return|return
operator|(
name|EADDRNOTAVAIL
operator|)
return|;
name|failed
label|:
name|unmark_prefixes
argument_list|(
name|ifp
argument_list|)
expr_stmt|;
break|break;
case|case
name|SIOCGIFPREFIX_IN6
case|:
name|rpp
operator|=
name|search_matched_prefix
argument_list|(
name|ifp
argument_list|,
name|ipr
argument_list|)
expr_stmt|;
if|if
condition|(
name|rpp
operator|==
name|NULL
operator|||
name|ifp
operator|!=
name|rpp
operator|->
name|rp_ifp
condition|)
return|return
operator|(
name|EADDRNOTAVAIL
operator|)
return|;
name|ipr
operator|->
name|ipr_origin
operator|=
name|rpp
operator|->
name|rp_origin
expr_stmt|;
name|ipr
operator|->
name|ipr_plen
operator|=
name|rpp
operator|->
name|rp_plen
expr_stmt|;
name|ipr
operator|->
name|ipr_vltime
operator|=
name|rpp
operator|->
name|rp_vltime
expr_stmt|;
name|ipr
operator|->
name|ipr_pltime
operator|=
name|rpp
operator|->
name|rp_pltime
expr_stmt|;
name|ipr
operator|->
name|ipr_flags
operator|=
name|rpp
operator|->
name|rp_flags
expr_stmt|;
name|ipr
operator|->
name|ipr_prefix
operator|=
name|rpp
operator|->
name|rp_prefix
expr_stmt|;
break|break;
case|case
name|SIOCSIFPREFIX_IN6
case|:
comment|/* check if preferred lifetime> valid lifetime */
if|if
condition|(
name|ipr
operator|->
name|ipr_pltime
operator|>
name|ipr
operator|->
name|ipr_vltime
condition|)
block|{
name|log
argument_list|(
name|LOG_NOTICE
argument_list|,
literal|"in6_prefix_ioctl: preferred lifetime"
literal|"(%ld) is greater than valid lifetime(%ld)\n"
argument_list|,
operator|(
name|u_long
operator|)
name|ipr
operator|->
name|ipr_pltime
argument_list|,
operator|(
name|u_long
operator|)
name|ipr
operator|->
name|ipr_vltime
argument_list|)
expr_stmt|;
name|error
operator|=
name|EINVAL
expr_stmt|;
break|break;
block|}
comment|/* init rp_tmp */
name|bzero
argument_list|(
operator|(
name|caddr_t
operator|)
operator|&
name|rp_tmp
argument_list|,
sizeof|sizeof
argument_list|(
name|rp_tmp
argument_list|)
argument_list|)
expr_stmt|;
name|rp_tmp
operator|.
name|rp_ifp
operator|=
name|ifp
expr_stmt|;
name|rp_tmp
operator|.
name|rp_plen
operator|=
name|ipr
operator|->
name|ipr_plen
expr_stmt|;
name|rp_tmp
operator|.
name|rp_prefix
operator|=
name|ipr
operator|->
name|ipr_prefix
expr_stmt|;
name|rp_tmp
operator|.
name|rp_vltime
operator|=
name|ipr
operator|->
name|ipr_vltime
expr_stmt|;
name|rp_tmp
operator|.
name|rp_pltime
operator|=
name|ipr
operator|->
name|ipr_pltime
expr_stmt|;
name|rp_tmp
operator|.
name|rp_flags
operator|=
name|ipr
operator|->
name|ipr_flags
expr_stmt|;
name|rp_tmp
operator|.
name|rp_origin
operator|=
name|ipr
operator|->
name|ipr_origin
expr_stmt|;
comment|/* create rp_addr entries, usually at least for lladdr */
if|if
condition|(
operator|(
name|error
operator|=
name|link_stray_ia6s
argument_list|(
operator|&
name|rp_tmp
argument_list|)
operator|)
operator|!=
literal|0
condition|)
block|{
name|free_rp_entries
argument_list|(
operator|&
name|rp_tmp
argument_list|)
expr_stmt|;
break|break;
block|}
for|for
control|(
name|ifa
operator|=
name|ifp
operator|->
name|if_addrlist
operator|.
name|tqh_first
init|;
name|ifa
condition|;
name|ifa
operator|=
name|ifa
operator|->
name|ifa_list
operator|.
name|tqe_next
control|)
block|{
if|if
condition|(
name|ifa
operator|->
name|ifa_addr
operator|==
name|NULL
condition|)
continue|continue;
comment|/* just for safety */
if|if
condition|(
name|ifa
operator|->
name|ifa_addr
operator|->
name|sa_family
operator|!=
name|AF_INET6
condition|)
continue|continue;
if|if
condition|(
name|IN6_IS_ADDR_LINKLOCAL
argument_list|(
name|IFA_IN6
argument_list|(
name|ifa
argument_list|)
argument_list|)
operator|==
literal|0
condition|)
continue|continue;
if|if
condition|(
operator|(
name|error
operator|=
name|create_ra_entry
argument_list|(
operator|&
name|rap
argument_list|)
operator|)
operator|!=
literal|0
condition|)
block|{
name|free_rp_entries
argument_list|(
operator|&
name|rp_tmp
argument_list|)
expr_stmt|;
goto|goto
name|bad
goto|;
block|}
comment|/* copy interface id part */
name|bit_copy
argument_list|(
operator|(
name|caddr_t
operator|)
operator|&
name|rap
operator|->
name|ra_ifid
argument_list|,
sizeof|sizeof
argument_list|(
name|rap
operator|->
name|ra_ifid
argument_list|)
operator|<<
literal|3
argument_list|,
operator|(
name|caddr_t
operator|)
name|IFA_IN6
argument_list|(
name|ifa
argument_list|)
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|IFA_IN6
argument_list|(
name|ifa
argument_list|)
argument_list|)
operator|<<
literal|3
argument_list|,
name|rp_tmp
operator|.
name|rp_plen
argument_list|,
operator|(
sizeof|sizeof
argument_list|(
name|rap
operator|->
name|ra_ifid
argument_list|)
operator|<<
literal|3
operator|)
operator|-
name|rp_tmp
operator|.
name|rp_plen
argument_list|)
expr_stmt|;
comment|/* insert into list */
name|LIST_INSERT_HEAD
argument_list|(
operator|&
name|rp_tmp
operator|.
name|rp_addrhead
argument_list|,
name|rap
argument_list|,
name|ra_entry
argument_list|)
expr_stmt|;
block|}
name|error
operator|=
name|add_each_prefix
argument_list|(
name|so
argument_list|,
operator|&
name|rp_tmp
argument_list|)
expr_stmt|;
comment|/* free each rp_addr entry */
name|free_rp_entries
argument_list|(
operator|&
name|rp_tmp
argument_list|)
expr_stmt|;
break|break;
case|case
name|SIOCDIFPREFIX_IN6
case|:
name|rpp
operator|=
name|search_matched_prefix
argument_list|(
name|ifp
argument_list|,
name|ipr
argument_list|)
expr_stmt|;
if|if
condition|(
name|rpp
operator|==
name|NULL
operator|||
name|ifp
operator|!=
name|rpp
operator|->
name|rp_ifp
condition|)
return|return
operator|(
name|EADDRNOTAVAIL
operator|)
return|;
name|error
operator|=
name|delete_each_prefix
argument_list|(
name|rpp
argument_list|,
name|ipr
operator|->
name|ipr_origin
argument_list|)
expr_stmt|;
break|break;
block|}
name|bad
label|:
return|return
name|error
return|;
block|}
end_function

begin_function
name|void
name|in6_rr_timer
parameter_list|(
name|void
modifier|*
name|ignored_arg
parameter_list|)
block|{
name|int
name|s
decl_stmt|;
name|struct
name|rr_prefix
modifier|*
name|rpp
decl_stmt|;
name|callout_reset
argument_list|(
operator|&
name|in6_rr_timer_ch
argument_list|,
name|ip6_rr_prune
operator|*
name|hz
argument_list|,
name|in6_rr_timer
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|s
operator|=
name|splnet
argument_list|()
expr_stmt|;
comment|/* expire */
name|rpp
operator|=
name|LIST_FIRST
argument_list|(
operator|&
name|rr_prefix
argument_list|)
expr_stmt|;
while|while
condition|(
name|rpp
condition|)
block|{
if|if
condition|(
name|rpp
operator|->
name|rp_expire
operator|&&
name|rpp
operator|->
name|rp_expire
operator|<
name|time_second
condition|)
block|{
name|struct
name|rr_prefix
modifier|*
name|next_rpp
decl_stmt|;
name|next_rpp
operator|=
name|LIST_NEXT
argument_list|(
name|rpp
argument_list|,
name|rp_entry
argument_list|)
expr_stmt|;
name|delete_each_prefix
argument_list|(
name|rpp
argument_list|,
name|PR_ORIG_KERNEL
argument_list|)
expr_stmt|;
name|rpp
operator|=
name|next_rpp
expr_stmt|;
continue|continue;
block|}
if|if
condition|(
name|rpp
operator|->
name|rp_preferred
operator|&&
name|rpp
operator|->
name|rp_preferred
operator|<
name|time_second
condition|)
name|unprefer_prefix
argument_list|(
name|rpp
argument_list|)
expr_stmt|;
name|rpp
operator|=
name|LIST_NEXT
argument_list|(
name|rpp
argument_list|,
name|rp_entry
argument_list|)
expr_stmt|;
block|}
name|splx
argument_list|(
name|s
argument_list|)
expr_stmt|;
block|}
end_function

end_unit


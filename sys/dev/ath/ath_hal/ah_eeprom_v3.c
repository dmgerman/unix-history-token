begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Copyright (c) 2002-2008 Sam Leffler, Errno Consulting  * Copyright (c) 2002-2008 Atheros Communications, Inc.  *  * Permission to use, copy, modify, and/or distribute this software for any  * purpose with or without fee is hereby granted, provided that the above  * copyright notice and this permission notice appear in all copies.  *  * THE SOFTWARE IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL WARRANTIES  * WITH REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF  * MERCHANTABILITY AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR  * ANY SPECIAL, DIRECT, INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES  * WHATSOEVER RESULTING FROM LOSS OF USE, DATA OR PROFITS, WHETHER IN AN  * ACTION OF CONTRACT, NEGLIGENCE OR OTHER TORTIOUS ACTION, ARISING OUT OF  * OR IN CONNECTION WITH THE USE OR PERFORMANCE OF THIS SOFTWARE.  *  * $FreeBSD$  */
end_comment

begin_include
include|#
directive|include
file|"opt_ah.h"
end_include

begin_include
include|#
directive|include
file|"ah.h"
end_include

begin_include
include|#
directive|include
file|"ah_internal.h"
end_include

begin_include
include|#
directive|include
file|"ah_eeprom_v3.h"
end_include

begin_function
specifier|static
name|void
name|getPcdacInterceptsFromPcdacMinMax
parameter_list|(
name|HAL_EEPROM
modifier|*
name|ee
parameter_list|,
name|uint16_t
name|pcdacMin
parameter_list|,
name|uint16_t
name|pcdacMax
parameter_list|,
name|uint16_t
modifier|*
name|vp
parameter_list|)
block|{
specifier|static
specifier|const
name|uint16_t
name|intercepts3
index|[]
init|=
block|{
literal|0
block|,
literal|5
block|,
literal|10
block|,
literal|20
block|,
literal|30
block|,
literal|50
block|,
literal|70
block|,
literal|85
block|,
literal|90
block|,
literal|95
block|,
literal|100
block|}
decl_stmt|;
specifier|static
specifier|const
name|uint16_t
name|intercepts3_2
index|[]
init|=
block|{
literal|0
block|,
literal|10
block|,
literal|20
block|,
literal|30
block|,
literal|40
block|,
literal|50
block|,
literal|60
block|,
literal|70
block|,
literal|80
block|,
literal|90
block|,
literal|100
block|}
decl_stmt|;
specifier|const
name|uint16_t
modifier|*
name|ip
init|=
name|ee
operator|->
name|ee_version
operator|<
name|AR_EEPROM_VER3_2
condition|?
name|intercepts3
else|:
name|intercepts3_2
decl_stmt|;
name|int
name|i
decl_stmt|;
comment|/* loop for the percentages in steps or 5 */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|NUM_INTERCEPTS
condition|;
name|i
operator|++
control|)
operator|*
name|vp
operator|++
operator|=
operator|(
name|ip
index|[
name|i
index|]
operator|*
name|pcdacMax
operator|+
operator|(
literal|100
operator|-
name|ip
index|[
name|i
index|]
operator|)
operator|*
name|pcdacMin
operator|)
operator|/
literal|100
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * Get channel value from binary representation held in eeprom  */
end_comment

begin_function
specifier|static
name|uint16_t
name|fbin2freq
parameter_list|(
name|HAL_EEPROM
modifier|*
name|ee
parameter_list|,
name|uint16_t
name|fbin
parameter_list|)
block|{
if|if
condition|(
name|fbin
operator|==
name|CHANNEL_UNUSED
condition|)
comment|/* reserved value, don't convert */
return|return
name|fbin
return|;
return|return
name|ee
operator|->
name|ee_version
operator|<=
name|AR_EEPROM_VER3_2
condition|?
operator|(
name|fbin
operator|>
literal|62
condition|?
literal|5100
operator|+
literal|10
operator|*
literal|62
operator|+
literal|5
operator|*
operator|(
name|fbin
operator|-
literal|62
operator|)
else|:
literal|5100
operator|+
literal|10
operator|*
name|fbin
operator|)
else|:
literal|4800
operator|+
literal|5
operator|*
name|fbin
return|;
block|}
end_function

begin_function
specifier|static
name|uint16_t
name|fbin2freq_2p4
parameter_list|(
name|HAL_EEPROM
modifier|*
name|ee
parameter_list|,
name|uint16_t
name|fbin
parameter_list|)
block|{
if|if
condition|(
name|fbin
operator|==
name|CHANNEL_UNUSED
condition|)
comment|/* reserved value, don't convert */
return|return
name|fbin
return|;
return|return
name|ee
operator|->
name|ee_version
operator|<=
name|AR_EEPROM_VER3_2
condition|?
literal|2400
operator|+
name|fbin
else|:
literal|2300
operator|+
name|fbin
return|;
block|}
end_function

begin_comment
comment|/*  * Now copy EEPROM frequency pier contents into the allocated space  */
end_comment

begin_function
specifier|static
name|HAL_BOOL
name|readEepromFreqPierInfo
parameter_list|(
name|struct
name|ath_hal
modifier|*
name|ah
parameter_list|,
name|HAL_EEPROM
modifier|*
name|ee
parameter_list|)
block|{
define|#
directive|define
name|EEREAD
parameter_list|(
name|_off
parameter_list|)
value|do {				\ 	if (!ath_hal_eepromRead(ah, _off,&eeval))	\ 		return AH_FALSE;			\ } while (0)
name|uint16_t
name|eeval
decl_stmt|,
name|off
decl_stmt|;
name|int
name|i
decl_stmt|;
if|if
condition|(
name|ee
operator|->
name|ee_version
operator|>=
name|AR_EEPROM_VER4_0
operator|&&
name|ee
operator|->
name|ee_eepMap
operator|&&
operator|!
name|ee
operator|->
name|ee_Amode
condition|)
block|{
comment|/* 		 * V4.0 EEPROMs with map type 1 have frequency pier 		 * data only when 11a mode is supported. 		 */
return|return
name|AH_TRUE
return|;
block|}
if|if
condition|(
name|ee
operator|->
name|ee_version
operator|>=
name|AR_EEPROM_VER3_3
condition|)
block|{
name|off
operator|=
name|GROUPS_OFFSET3_3
operator|+
name|GROUP1_OFFSET
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|ee
operator|->
name|ee_numChannels11a
condition|;
name|i
operator|+=
literal|2
control|)
block|{
name|EEREAD
argument_list|(
name|off
operator|++
argument_list|)
expr_stmt|;
name|ee
operator|->
name|ee_channels11a
index|[
name|i
index|]
operator|=
operator|(
name|eeval
operator|>>
literal|8
operator|)
operator|&
name|FREQ_MASK_3_3
expr_stmt|;
name|ee
operator|->
name|ee_channels11a
index|[
name|i
operator|+
literal|1
index|]
operator|=
name|eeval
operator|&
name|FREQ_MASK_3_3
expr_stmt|;
block|}
block|}
else|else
block|{
name|off
operator|=
name|GROUPS_OFFSET3_2
operator|+
name|GROUP1_OFFSET
expr_stmt|;
name|EEREAD
argument_list|(
name|off
operator|++
argument_list|)
expr_stmt|;
name|ee
operator|->
name|ee_channels11a
index|[
literal|0
index|]
operator|=
operator|(
name|eeval
operator|>>
literal|9
operator|)
operator|&
name|FREQ_MASK
expr_stmt|;
name|ee
operator|->
name|ee_channels11a
index|[
literal|1
index|]
operator|=
operator|(
name|eeval
operator|>>
literal|2
operator|)
operator|&
name|FREQ_MASK
expr_stmt|;
name|ee
operator|->
name|ee_channels11a
index|[
literal|2
index|]
operator|=
operator|(
name|eeval
operator|<<
literal|5
operator|)
operator|&
name|FREQ_MASK
expr_stmt|;
name|EEREAD
argument_list|(
name|off
operator|++
argument_list|)
expr_stmt|;
name|ee
operator|->
name|ee_channels11a
index|[
literal|2
index|]
operator||=
operator|(
name|eeval
operator|>>
literal|11
operator|)
operator|&
literal|0x1f
expr_stmt|;
name|ee
operator|->
name|ee_channels11a
index|[
literal|3
index|]
operator|=
operator|(
name|eeval
operator|>>
literal|4
operator|)
operator|&
name|FREQ_MASK
expr_stmt|;
name|ee
operator|->
name|ee_channels11a
index|[
literal|4
index|]
operator|=
operator|(
name|eeval
operator|<<
literal|3
operator|)
operator|&
name|FREQ_MASK
expr_stmt|;
name|EEREAD
argument_list|(
name|off
operator|++
argument_list|)
expr_stmt|;
name|ee
operator|->
name|ee_channels11a
index|[
literal|4
index|]
operator||=
operator|(
name|eeval
operator|>>
literal|13
operator|)
operator|&
literal|0x7
expr_stmt|;
name|ee
operator|->
name|ee_channels11a
index|[
literal|5
index|]
operator|=
operator|(
name|eeval
operator|>>
literal|6
operator|)
operator|&
name|FREQ_MASK
expr_stmt|;
name|ee
operator|->
name|ee_channels11a
index|[
literal|6
index|]
operator|=
operator|(
name|eeval
operator|<<
literal|1
operator|)
operator|&
name|FREQ_MASK
expr_stmt|;
name|EEREAD
argument_list|(
name|off
operator|++
argument_list|)
expr_stmt|;
name|ee
operator|->
name|ee_channels11a
index|[
literal|6
index|]
operator||=
operator|(
name|eeval
operator|>>
literal|15
operator|)
operator|&
literal|0x1
expr_stmt|;
name|ee
operator|->
name|ee_channels11a
index|[
literal|7
index|]
operator|=
operator|(
name|eeval
operator|>>
literal|8
operator|)
operator|&
name|FREQ_MASK
expr_stmt|;
name|ee
operator|->
name|ee_channels11a
index|[
literal|8
index|]
operator|=
operator|(
name|eeval
operator|>>
literal|1
operator|)
operator|&
name|FREQ_MASK
expr_stmt|;
name|ee
operator|->
name|ee_channels11a
index|[
literal|9
index|]
operator|=
operator|(
name|eeval
operator|<<
literal|6
operator|)
operator|&
name|FREQ_MASK
expr_stmt|;
name|EEREAD
argument_list|(
name|off
operator|++
argument_list|)
expr_stmt|;
name|ee
operator|->
name|ee_channels11a
index|[
literal|9
index|]
operator||=
operator|(
name|eeval
operator|>>
literal|10
operator|)
operator|&
literal|0x3f
expr_stmt|;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|ee
operator|->
name|ee_numChannels11a
condition|;
name|i
operator|++
control|)
name|ee
operator|->
name|ee_channels11a
index|[
name|i
index|]
operator|=
name|fbin2freq
argument_list|(
name|ee
argument_list|,
name|ee
operator|->
name|ee_channels11a
index|[
name|i
index|]
argument_list|)
expr_stmt|;
return|return
name|AH_TRUE
return|;
undef|#
directive|undef
name|EEREAD
block|}
end_function

begin_comment
comment|/*  * Rev 4 Eeprom 5112 Power Extract Functions  */
end_comment

begin_comment
comment|/*  * Allocate the power information based on the number of channels  * recorded by the calibration.  These values are then initialized.  */
end_comment

begin_function
specifier|static
name|HAL_BOOL
name|eepromAllocExpnPower5112
parameter_list|(
name|struct
name|ath_hal
modifier|*
name|ah
parameter_list|,
specifier|const
name|EEPROM_POWER_5112
modifier|*
name|pCalDataset
parameter_list|,
name|EEPROM_POWER_EXPN_5112
modifier|*
name|pPowerExpn
parameter_list|)
block|{
name|uint16_t
name|numChannels
init|=
name|pCalDataset
operator|->
name|numChannels
decl_stmt|;
specifier|const
name|uint16_t
modifier|*
name|pChanList
init|=
name|pCalDataset
operator|->
name|pChannels
decl_stmt|;
name|void
modifier|*
name|data
decl_stmt|;
name|int
name|i
decl_stmt|,
name|j
decl_stmt|;
comment|/* Allocate the channel and Power Data arrays together */
name|data
operator|=
name|ath_hal_malloc
argument_list|(
name|roundup
argument_list|(
sizeof|sizeof
argument_list|(
name|uint16_t
argument_list|)
operator|*
name|numChannels
argument_list|,
sizeof|sizeof
argument_list|(
name|uint32_t
argument_list|)
argument_list|)
operator|+
sizeof|sizeof
argument_list|(
name|EXPN_DATA_PER_CHANNEL_5112
argument_list|)
operator|*
name|numChannels
argument_list|)
expr_stmt|;
if|if
condition|(
name|data
operator|==
name|AH_NULL
condition|)
block|{
name|HALDEBUG
argument_list|(
name|ah
argument_list|,
name|HAL_DEBUG_ANY
argument_list|,
literal|"%s unable to allocate raw data struct (gen3)\n"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
return|return
name|AH_FALSE
return|;
block|}
name|pPowerExpn
operator|->
name|pChannels
operator|=
name|data
expr_stmt|;
name|pPowerExpn
operator|->
name|pDataPerChannel
operator|=
operator|(
name|void
operator|*
operator|)
operator|(
operator|(
operator|(
name|char
operator|*
operator|)
name|data
operator|)
operator|+
name|roundup
argument_list|(
sizeof|sizeof
argument_list|(
name|uint16_t
argument_list|)
operator|*
name|numChannels
argument_list|,
sizeof|sizeof
argument_list|(
name|uint32_t
argument_list|)
argument_list|)
operator|)
expr_stmt|;
name|pPowerExpn
operator|->
name|numChannels
operator|=
name|numChannels
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|numChannels
condition|;
name|i
operator|++
control|)
block|{
name|pPowerExpn
operator|->
name|pChannels
index|[
name|i
index|]
operator|=
name|pPowerExpn
operator|->
name|pDataPerChannel
index|[
name|i
index|]
operator|.
name|channelValue
operator|=
name|pChanList
index|[
name|i
index|]
expr_stmt|;
for|for
control|(
name|j
operator|=
literal|0
init|;
name|j
operator|<
name|NUM_XPD_PER_CHANNEL
condition|;
name|j
operator|++
control|)
block|{
name|pPowerExpn
operator|->
name|pDataPerChannel
index|[
name|i
index|]
operator|.
name|pDataPerXPD
index|[
name|j
index|]
operator|.
name|xpd_gain
operator|=
name|j
expr_stmt|;
name|pPowerExpn
operator|->
name|pDataPerChannel
index|[
name|i
index|]
operator|.
name|pDataPerXPD
index|[
name|j
index|]
operator|.
name|numPcdacs
operator|=
literal|0
expr_stmt|;
block|}
name|pPowerExpn
operator|->
name|pDataPerChannel
index|[
name|i
index|]
operator|.
name|pDataPerXPD
index|[
literal|0
index|]
operator|.
name|numPcdacs
operator|=
literal|4
expr_stmt|;
name|pPowerExpn
operator|->
name|pDataPerChannel
index|[
name|i
index|]
operator|.
name|pDataPerXPD
index|[
literal|3
index|]
operator|.
name|numPcdacs
operator|=
literal|3
expr_stmt|;
block|}
return|return
name|AH_TRUE
return|;
block|}
end_function

begin_comment
comment|/*  * Expand the dataSet from the calibration information into the  * final power structure for 5112  */
end_comment

begin_function
specifier|static
name|HAL_BOOL
name|eepromExpandPower5112
parameter_list|(
name|struct
name|ath_hal
modifier|*
name|ah
parameter_list|,
specifier|const
name|EEPROM_POWER_5112
modifier|*
name|pCalDataset
parameter_list|,
name|EEPROM_POWER_EXPN_5112
modifier|*
name|pPowerExpn
parameter_list|)
block|{
name|int
name|ii
decl_stmt|,
name|jj
decl_stmt|,
name|kk
decl_stmt|;
name|int16_t
name|maxPower_t4
decl_stmt|;
name|EXPN_DATA_PER_XPD_5112
modifier|*
name|pExpnXPD
decl_stmt|;
comment|/* ptr to array of info held per channel */
specifier|const
name|EEPROM_DATA_PER_CHANNEL_5112
modifier|*
name|pCalCh
decl_stmt|;
name|uint16_t
name|xgainList
index|[
literal|2
index|]
decl_stmt|,
name|xpdMask
decl_stmt|;
name|pPowerExpn
operator|->
name|xpdMask
operator|=
name|pCalDataset
operator|->
name|xpdMask
expr_stmt|;
name|xgainList
index|[
literal|0
index|]
operator|=
literal|0xDEAD
expr_stmt|;
name|xgainList
index|[
literal|1
index|]
operator|=
literal|0xDEAD
expr_stmt|;
name|kk
operator|=
literal|0
expr_stmt|;
name|xpdMask
operator|=
name|pPowerExpn
operator|->
name|xpdMask
expr_stmt|;
for|for
control|(
name|jj
operator|=
literal|0
init|;
name|jj
operator|<
name|NUM_XPD_PER_CHANNEL
condition|;
name|jj
operator|++
control|)
block|{
if|if
condition|(
operator|(
operator|(
name|xpdMask
operator|>>
name|jj
operator|)
operator|&
literal|1
operator|)
operator|>
literal|0
condition|)
block|{
if|if
condition|(
name|kk
operator|>
literal|1
condition|)
block|{
name|HALDEBUG
argument_list|(
name|ah
argument_list|,
name|HAL_DEBUG_ANY
argument_list|,
literal|"%s: too many xpdGains in dataset: %u\n"
argument_list|,
name|__func__
argument_list|,
name|kk
argument_list|)
expr_stmt|;
return|return
name|AH_FALSE
return|;
block|}
name|xgainList
index|[
name|kk
operator|++
index|]
operator|=
name|jj
expr_stmt|;
block|}
block|}
name|pPowerExpn
operator|->
name|numChannels
operator|=
name|pCalDataset
operator|->
name|numChannels
expr_stmt|;
if|if
condition|(
name|pPowerExpn
operator|->
name|numChannels
operator|==
literal|0
condition|)
block|{
name|HALDEBUG
argument_list|(
name|ah
argument_list|,
name|HAL_DEBUG_ANY
argument_list|,
literal|"%s: no channels\n"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
return|return
name|AH_FALSE
return|;
block|}
for|for
control|(
name|ii
operator|=
literal|0
init|;
name|ii
operator|<
name|pPowerExpn
operator|->
name|numChannels
condition|;
name|ii
operator|++
control|)
block|{
name|pCalCh
operator|=
operator|&
name|pCalDataset
operator|->
name|pDataPerChannel
index|[
name|ii
index|]
expr_stmt|;
name|pPowerExpn
operator|->
name|pDataPerChannel
index|[
name|ii
index|]
operator|.
name|channelValue
operator|=
name|pCalCh
operator|->
name|channelValue
expr_stmt|;
name|pPowerExpn
operator|->
name|pDataPerChannel
index|[
name|ii
index|]
operator|.
name|maxPower_t4
operator|=
name|pCalCh
operator|->
name|maxPower_t4
expr_stmt|;
name|maxPower_t4
operator|=
name|pPowerExpn
operator|->
name|pDataPerChannel
index|[
name|ii
index|]
operator|.
name|maxPower_t4
expr_stmt|;
for|for
control|(
name|jj
operator|=
literal|0
init|;
name|jj
operator|<
name|NUM_XPD_PER_CHANNEL
condition|;
name|jj
operator|++
control|)
name|pPowerExpn
operator|->
name|pDataPerChannel
index|[
name|ii
index|]
operator|.
name|pDataPerXPD
index|[
name|jj
index|]
operator|.
name|numPcdacs
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|xgainList
index|[
literal|1
index|]
operator|==
literal|0xDEAD
condition|)
block|{
name|jj
operator|=
name|xgainList
index|[
literal|0
index|]
expr_stmt|;
name|pExpnXPD
operator|=
operator|&
name|pPowerExpn
operator|->
name|pDataPerChannel
index|[
name|ii
index|]
operator|.
name|pDataPerXPD
index|[
name|jj
index|]
expr_stmt|;
name|pExpnXPD
operator|->
name|numPcdacs
operator|=
literal|4
expr_stmt|;
name|pExpnXPD
operator|->
name|pcdac
index|[
literal|0
index|]
operator|=
name|pCalCh
operator|->
name|pcd1_xg0
expr_stmt|;
name|pExpnXPD
operator|->
name|pcdac
index|[
literal|1
index|]
operator|=
call|(
name|uint16_t
call|)
argument_list|(
name|pExpnXPD
operator|->
name|pcdac
index|[
literal|0
index|]
operator|+
name|pCalCh
operator|->
name|pcd2_delta_xg0
argument_list|)
expr_stmt|;
name|pExpnXPD
operator|->
name|pcdac
index|[
literal|2
index|]
operator|=
call|(
name|uint16_t
call|)
argument_list|(
name|pExpnXPD
operator|->
name|pcdac
index|[
literal|1
index|]
operator|+
name|pCalCh
operator|->
name|pcd3_delta_xg0
argument_list|)
expr_stmt|;
name|pExpnXPD
operator|->
name|pcdac
index|[
literal|3
index|]
operator|=
call|(
name|uint16_t
call|)
argument_list|(
name|pExpnXPD
operator|->
name|pcdac
index|[
literal|2
index|]
operator|+
name|pCalCh
operator|->
name|pcd4_delta_xg0
argument_list|)
expr_stmt|;
name|pExpnXPD
operator|->
name|pwr_t4
index|[
literal|0
index|]
operator|=
name|pCalCh
operator|->
name|pwr1_xg0
expr_stmt|;
name|pExpnXPD
operator|->
name|pwr_t4
index|[
literal|1
index|]
operator|=
name|pCalCh
operator|->
name|pwr2_xg0
expr_stmt|;
name|pExpnXPD
operator|->
name|pwr_t4
index|[
literal|2
index|]
operator|=
name|pCalCh
operator|->
name|pwr3_xg0
expr_stmt|;
name|pExpnXPD
operator|->
name|pwr_t4
index|[
literal|3
index|]
operator|=
name|pCalCh
operator|->
name|pwr4_xg0
expr_stmt|;
block|}
else|else
block|{
name|pPowerExpn
operator|->
name|pDataPerChannel
index|[
name|ii
index|]
operator|.
name|pDataPerXPD
index|[
name|xgainList
index|[
literal|0
index|]
index|]
operator|.
name|pcdac
index|[
literal|0
index|]
operator|=
name|pCalCh
operator|->
name|pcd1_xg0
expr_stmt|;
name|pPowerExpn
operator|->
name|pDataPerChannel
index|[
name|ii
index|]
operator|.
name|pDataPerXPD
index|[
name|xgainList
index|[
literal|1
index|]
index|]
operator|.
name|pcdac
index|[
literal|0
index|]
operator|=
literal|20
expr_stmt|;
name|pPowerExpn
operator|->
name|pDataPerChannel
index|[
name|ii
index|]
operator|.
name|pDataPerXPD
index|[
name|xgainList
index|[
literal|1
index|]
index|]
operator|.
name|pcdac
index|[
literal|1
index|]
operator|=
literal|35
expr_stmt|;
name|pPowerExpn
operator|->
name|pDataPerChannel
index|[
name|ii
index|]
operator|.
name|pDataPerXPD
index|[
name|xgainList
index|[
literal|1
index|]
index|]
operator|.
name|pcdac
index|[
literal|2
index|]
operator|=
literal|63
expr_stmt|;
name|jj
operator|=
name|xgainList
index|[
literal|0
index|]
expr_stmt|;
name|pExpnXPD
operator|=
operator|&
name|pPowerExpn
operator|->
name|pDataPerChannel
index|[
name|ii
index|]
operator|.
name|pDataPerXPD
index|[
name|jj
index|]
expr_stmt|;
name|pExpnXPD
operator|->
name|numPcdacs
operator|=
literal|4
expr_stmt|;
name|pExpnXPD
operator|->
name|pcdac
index|[
literal|1
index|]
operator|=
call|(
name|uint16_t
call|)
argument_list|(
name|pExpnXPD
operator|->
name|pcdac
index|[
literal|0
index|]
operator|+
name|pCalCh
operator|->
name|pcd2_delta_xg0
argument_list|)
expr_stmt|;
name|pExpnXPD
operator|->
name|pcdac
index|[
literal|2
index|]
operator|=
call|(
name|uint16_t
call|)
argument_list|(
name|pExpnXPD
operator|->
name|pcdac
index|[
literal|1
index|]
operator|+
name|pCalCh
operator|->
name|pcd3_delta_xg0
argument_list|)
expr_stmt|;
name|pExpnXPD
operator|->
name|pcdac
index|[
literal|3
index|]
operator|=
call|(
name|uint16_t
call|)
argument_list|(
name|pExpnXPD
operator|->
name|pcdac
index|[
literal|2
index|]
operator|+
name|pCalCh
operator|->
name|pcd4_delta_xg0
argument_list|)
expr_stmt|;
name|pExpnXPD
operator|->
name|pwr_t4
index|[
literal|0
index|]
operator|=
name|pCalCh
operator|->
name|pwr1_xg0
expr_stmt|;
name|pExpnXPD
operator|->
name|pwr_t4
index|[
literal|1
index|]
operator|=
name|pCalCh
operator|->
name|pwr2_xg0
expr_stmt|;
name|pExpnXPD
operator|->
name|pwr_t4
index|[
literal|2
index|]
operator|=
name|pCalCh
operator|->
name|pwr3_xg0
expr_stmt|;
name|pExpnXPD
operator|->
name|pwr_t4
index|[
literal|3
index|]
operator|=
name|pCalCh
operator|->
name|pwr4_xg0
expr_stmt|;
name|jj
operator|=
name|xgainList
index|[
literal|1
index|]
expr_stmt|;
name|pExpnXPD
operator|=
operator|&
name|pPowerExpn
operator|->
name|pDataPerChannel
index|[
name|ii
index|]
operator|.
name|pDataPerXPD
index|[
name|jj
index|]
expr_stmt|;
name|pExpnXPD
operator|->
name|numPcdacs
operator|=
literal|3
expr_stmt|;
name|pExpnXPD
operator|->
name|pwr_t4
index|[
literal|0
index|]
operator|=
name|pCalCh
operator|->
name|pwr1_xg3
expr_stmt|;
name|pExpnXPD
operator|->
name|pwr_t4
index|[
literal|1
index|]
operator|=
name|pCalCh
operator|->
name|pwr2_xg3
expr_stmt|;
name|pExpnXPD
operator|->
name|pwr_t4
index|[
literal|2
index|]
operator|=
name|pCalCh
operator|->
name|pwr3_xg3
expr_stmt|;
block|}
block|}
return|return
name|AH_TRUE
return|;
block|}
end_function

begin_function
specifier|static
name|HAL_BOOL
name|readEepromRawPowerCalInfo5112
parameter_list|(
name|struct
name|ath_hal
modifier|*
name|ah
parameter_list|,
name|HAL_EEPROM
modifier|*
name|ee
parameter_list|)
block|{
define|#
directive|define
name|EEREAD
parameter_list|(
name|_off
parameter_list|)
value|do {				\ 	if (!ath_hal_eepromRead(ah, _off,&eeval))	\ 		return AH_FALSE;			\ } while (0)
specifier|const
name|uint16_t
name|dbmmask
init|=
literal|0xff
decl_stmt|;
specifier|const
name|uint16_t
name|pcdac_delta_mask
init|=
literal|0x1f
decl_stmt|;
specifier|const
name|uint16_t
name|pcdac_mask
init|=
literal|0x3f
decl_stmt|;
specifier|const
name|uint16_t
name|freqmask
init|=
literal|0xff
decl_stmt|;
name|int
name|i
decl_stmt|,
name|mode
decl_stmt|,
name|numPiers
decl_stmt|;
name|uint32_t
name|off
decl_stmt|;
name|uint16_t
name|eeval
decl_stmt|;
name|uint16_t
name|freq
index|[
name|NUM_11A_EEPROM_CHANNELS
index|]
decl_stmt|;
name|EEPROM_POWER_5112
name|eePower
decl_stmt|;
name|HALASSERT
argument_list|(
name|ee
operator|->
name|ee_version
operator|>=
name|AR_EEPROM_VER4_0
argument_list|)
expr_stmt|;
name|off
operator|=
name|GROUPS_OFFSET3_3
expr_stmt|;
for|for
control|(
name|mode
operator|=
name|headerInfo11A
init|;
name|mode
operator|<=
name|headerInfo11G
condition|;
name|mode
operator|++
control|)
block|{
name|numPiers
operator|=
literal|0
expr_stmt|;
switch|switch
condition|(
name|mode
condition|)
block|{
case|case
name|headerInfo11A
case|:
if|if
condition|(
operator|!
name|ee
operator|->
name|ee_Amode
condition|)
comment|/* no 11a calibration data */
continue|continue;
while|while
condition|(
name|numPiers
operator|<
name|NUM_11A_EEPROM_CHANNELS
condition|)
block|{
name|EEREAD
argument_list|(
name|off
operator|++
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|eeval
operator|&
name|freqmask
operator|)
operator|==
literal|0
condition|)
break|break;
name|freq
index|[
name|numPiers
operator|++
index|]
operator|=
name|fbin2freq
argument_list|(
name|ee
argument_list|,
name|eeval
operator|&
name|freqmask
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
operator|(
name|eeval
operator|>>
literal|8
operator|)
operator|&
name|freqmask
operator|)
operator|==
literal|0
condition|)
break|break;
name|freq
index|[
name|numPiers
operator|++
index|]
operator|=
name|fbin2freq
argument_list|(
name|ee
argument_list|,
operator|(
name|eeval
operator|>>
literal|8
operator|)
operator|&
name|freqmask
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
name|headerInfo11B
case|:
if|if
condition|(
operator|!
name|ee
operator|->
name|ee_Bmode
condition|)
comment|/* no 11b calibration data */
continue|continue;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|NUM_2_4_EEPROM_CHANNELS
condition|;
name|i
operator|++
control|)
if|if
condition|(
name|ee
operator|->
name|ee_calPier11b
index|[
name|i
index|]
operator|!=
name|CHANNEL_UNUSED
condition|)
name|freq
index|[
name|numPiers
operator|++
index|]
operator|=
name|ee
operator|->
name|ee_calPier11b
index|[
name|i
index|]
expr_stmt|;
break|break;
case|case
name|headerInfo11G
case|:
if|if
condition|(
operator|!
name|ee
operator|->
name|ee_Gmode
condition|)
comment|/* no 11g calibration data */
continue|continue;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|NUM_2_4_EEPROM_CHANNELS
condition|;
name|i
operator|++
control|)
if|if
condition|(
name|ee
operator|->
name|ee_calPier11g
index|[
name|i
index|]
operator|!=
name|CHANNEL_UNUSED
condition|)
name|freq
index|[
name|numPiers
operator|++
index|]
operator|=
name|ee
operator|->
name|ee_calPier11g
index|[
name|i
index|]
expr_stmt|;
break|break;
default|default:
name|HALDEBUG
argument_list|(
name|ah
argument_list|,
name|HAL_DEBUG_ANY
argument_list|,
literal|"%s: invalid mode 0x%x\n"
argument_list|,
name|__func__
argument_list|,
name|mode
argument_list|)
expr_stmt|;
return|return
name|AH_FALSE
return|;
block|}
name|OS_MEMZERO
argument_list|(
operator|&
name|eePower
argument_list|,
sizeof|sizeof
argument_list|(
name|eePower
argument_list|)
argument_list|)
expr_stmt|;
name|eePower
operator|.
name|numChannels
operator|=
name|numPiers
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|numPiers
condition|;
name|i
operator|++
control|)
block|{
name|eePower
operator|.
name|pChannels
index|[
name|i
index|]
operator|=
name|freq
index|[
name|i
index|]
expr_stmt|;
name|eePower
operator|.
name|pDataPerChannel
index|[
name|i
index|]
operator|.
name|channelValue
operator|=
name|freq
index|[
name|i
index|]
expr_stmt|;
name|EEREAD
argument_list|(
name|off
operator|++
argument_list|)
expr_stmt|;
name|eePower
operator|.
name|pDataPerChannel
index|[
name|i
index|]
operator|.
name|pwr1_xg0
operator|=
call|(
name|int16_t
call|)
argument_list|(
operator|(
name|eeval
operator|&
name|dbmmask
operator|)
operator|-
operator|(
operator|(
name|eeval
operator|>>
literal|7
operator|)
operator|&
literal|0x1
operator|)
operator|*
literal|256
argument_list|)
expr_stmt|;
name|eePower
operator|.
name|pDataPerChannel
index|[
name|i
index|]
operator|.
name|pwr2_xg0
operator|=
call|(
name|int16_t
call|)
argument_list|(
operator|(
operator|(
name|eeval
operator|>>
literal|8
operator|)
operator|&
name|dbmmask
operator|)
operator|-
operator|(
operator|(
name|eeval
operator|>>
literal|15
operator|)
operator|&
literal|0x1
operator|)
operator|*
literal|256
argument_list|)
expr_stmt|;
name|EEREAD
argument_list|(
name|off
operator|++
argument_list|)
expr_stmt|;
name|eePower
operator|.
name|pDataPerChannel
index|[
name|i
index|]
operator|.
name|pwr3_xg0
operator|=
call|(
name|int16_t
call|)
argument_list|(
operator|(
name|eeval
operator|&
name|dbmmask
operator|)
operator|-
operator|(
operator|(
name|eeval
operator|>>
literal|7
operator|)
operator|&
literal|0x1
operator|)
operator|*
literal|256
argument_list|)
expr_stmt|;
name|eePower
operator|.
name|pDataPerChannel
index|[
name|i
index|]
operator|.
name|pwr4_xg0
operator|=
call|(
name|int16_t
call|)
argument_list|(
operator|(
operator|(
name|eeval
operator|>>
literal|8
operator|)
operator|&
name|dbmmask
operator|)
operator|-
operator|(
operator|(
name|eeval
operator|>>
literal|15
operator|)
operator|&
literal|0x1
operator|)
operator|*
literal|256
argument_list|)
expr_stmt|;
name|EEREAD
argument_list|(
name|off
operator|++
argument_list|)
expr_stmt|;
name|eePower
operator|.
name|pDataPerChannel
index|[
name|i
index|]
operator|.
name|pcd2_delta_xg0
operator|=
call|(
name|uint16_t
call|)
argument_list|(
name|eeval
operator|&
name|pcdac_delta_mask
argument_list|)
expr_stmt|;
name|eePower
operator|.
name|pDataPerChannel
index|[
name|i
index|]
operator|.
name|pcd3_delta_xg0
operator|=
call|(
name|uint16_t
call|)
argument_list|(
operator|(
name|eeval
operator|>>
literal|5
operator|)
operator|&
name|pcdac_delta_mask
argument_list|)
expr_stmt|;
name|eePower
operator|.
name|pDataPerChannel
index|[
name|i
index|]
operator|.
name|pcd4_delta_xg0
operator|=
call|(
name|uint16_t
call|)
argument_list|(
operator|(
name|eeval
operator|>>
literal|10
operator|)
operator|&
name|pcdac_delta_mask
argument_list|)
expr_stmt|;
name|EEREAD
argument_list|(
name|off
operator|++
argument_list|)
expr_stmt|;
name|eePower
operator|.
name|pDataPerChannel
index|[
name|i
index|]
operator|.
name|pwr1_xg3
operator|=
call|(
name|int16_t
call|)
argument_list|(
operator|(
name|eeval
operator|&
name|dbmmask
operator|)
operator|-
operator|(
operator|(
name|eeval
operator|>>
literal|7
operator|)
operator|&
literal|0x1
operator|)
operator|*
literal|256
argument_list|)
expr_stmt|;
name|eePower
operator|.
name|pDataPerChannel
index|[
name|i
index|]
operator|.
name|pwr2_xg3
operator|=
call|(
name|int16_t
call|)
argument_list|(
operator|(
operator|(
name|eeval
operator|>>
literal|8
operator|)
operator|&
name|dbmmask
operator|)
operator|-
operator|(
operator|(
name|eeval
operator|>>
literal|15
operator|)
operator|&
literal|0x1
operator|)
operator|*
literal|256
argument_list|)
expr_stmt|;
name|EEREAD
argument_list|(
name|off
operator|++
argument_list|)
expr_stmt|;
name|eePower
operator|.
name|pDataPerChannel
index|[
name|i
index|]
operator|.
name|pwr3_xg3
operator|=
call|(
name|int16_t
call|)
argument_list|(
operator|(
name|eeval
operator|&
name|dbmmask
operator|)
operator|-
operator|(
operator|(
name|eeval
operator|>>
literal|7
operator|)
operator|&
literal|0x1
operator|)
operator|*
literal|256
argument_list|)
expr_stmt|;
if|if
condition|(
name|ee
operator|->
name|ee_version
operator|>=
name|AR_EEPROM_VER4_3
condition|)
block|{
name|eePower
operator|.
name|pDataPerChannel
index|[
name|i
index|]
operator|.
name|maxPower_t4
operator|=
name|eePower
operator|.
name|pDataPerChannel
index|[
name|i
index|]
operator|.
name|pwr4_xg0
expr_stmt|;
name|eePower
operator|.
name|pDataPerChannel
index|[
name|i
index|]
operator|.
name|pcd1_xg0
operator|=
call|(
name|uint16_t
call|)
argument_list|(
operator|(
name|eeval
operator|>>
literal|8
operator|)
operator|&
name|pcdac_mask
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|eePower
operator|.
name|pDataPerChannel
index|[
name|i
index|]
operator|.
name|maxPower_t4
operator|=
call|(
name|int16_t
call|)
argument_list|(
operator|(
operator|(
name|eeval
operator|>>
literal|8
operator|)
operator|&
name|dbmmask
operator|)
operator|-
operator|(
operator|(
name|eeval
operator|>>
literal|15
operator|)
operator|&
literal|0x1
operator|)
operator|*
literal|256
argument_list|)
expr_stmt|;
name|eePower
operator|.
name|pDataPerChannel
index|[
name|i
index|]
operator|.
name|pcd1_xg0
operator|=
literal|1
expr_stmt|;
block|}
block|}
name|eePower
operator|.
name|xpdMask
operator|=
name|ee
operator|->
name|ee_xgain
index|[
name|mode
index|]
expr_stmt|;
if|if
condition|(
operator|!
name|eepromAllocExpnPower5112
argument_list|(
name|ah
argument_list|,
operator|&
name|eePower
argument_list|,
operator|&
name|ee
operator|->
name|ee_modePowerArray5112
index|[
name|mode
index|]
argument_list|)
condition|)
block|{
name|HALDEBUG
argument_list|(
name|ah
argument_list|,
name|HAL_DEBUG_ANY
argument_list|,
literal|"%s: did not allocate power struct\n"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
return|return
name|AH_FALSE
return|;
block|}
if|if
condition|(
operator|!
name|eepromExpandPower5112
argument_list|(
name|ah
argument_list|,
operator|&
name|eePower
argument_list|,
operator|&
name|ee
operator|->
name|ee_modePowerArray5112
index|[
name|mode
index|]
argument_list|)
condition|)
block|{
name|HALDEBUG
argument_list|(
name|ah
argument_list|,
name|HAL_DEBUG_ANY
argument_list|,
literal|"%s: did not expand power struct\n"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
return|return
name|AH_FALSE
return|;
block|}
block|}
return|return
name|AH_TRUE
return|;
undef|#
directive|undef
name|EEREAD
block|}
end_function

begin_function
specifier|static
name|void
name|freeEepromRawPowerCalInfo5112
parameter_list|(
name|struct
name|ath_hal
modifier|*
name|ah
parameter_list|,
name|HAL_EEPROM
modifier|*
name|ee
parameter_list|)
block|{
name|int
name|mode
decl_stmt|;
name|void
modifier|*
name|data
decl_stmt|;
for|for
control|(
name|mode
operator|=
name|headerInfo11A
init|;
name|mode
operator|<=
name|headerInfo11G
condition|;
name|mode
operator|++
control|)
block|{
name|EEPROM_POWER_EXPN_5112
modifier|*
name|pPowerExpn
init|=
operator|&
name|ee
operator|->
name|ee_modePowerArray5112
index|[
name|mode
index|]
decl_stmt|;
name|data
operator|=
name|pPowerExpn
operator|->
name|pChannels
expr_stmt|;
if|if
condition|(
name|data
operator|!=
name|AH_NULL
condition|)
block|{
name|pPowerExpn
operator|->
name|pChannels
operator|=
name|AH_NULL
expr_stmt|;
name|ath_hal_free
argument_list|(
name|data
argument_list|)
expr_stmt|;
block|}
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|ar2413SetupEEPROMDataset
parameter_list|(
name|EEPROM_DATA_STRUCT_2413
modifier|*
name|pEEPROMDataset2413
parameter_list|,
name|uint16_t
name|myNumRawChannels
parameter_list|,
name|uint16_t
modifier|*
name|pMyRawChanList
parameter_list|)
block|{
name|uint16_t
name|i
decl_stmt|,
name|channelValue
decl_stmt|;
name|uint32_t
name|xpd_mask
decl_stmt|;
name|uint16_t
name|numPdGainsUsed
decl_stmt|;
name|pEEPROMDataset2413
operator|->
name|numChannels
operator|=
name|myNumRawChannels
expr_stmt|;
name|xpd_mask
operator|=
name|pEEPROMDataset2413
operator|->
name|xpd_mask
expr_stmt|;
name|numPdGainsUsed
operator|=
literal|0
expr_stmt|;
if|if
condition|(
operator|(
name|xpd_mask
operator|>>
literal|0
operator|)
operator|&
literal|0x1
condition|)
name|numPdGainsUsed
operator|++
expr_stmt|;
if|if
condition|(
operator|(
name|xpd_mask
operator|>>
literal|1
operator|)
operator|&
literal|0x1
condition|)
name|numPdGainsUsed
operator|++
expr_stmt|;
if|if
condition|(
operator|(
name|xpd_mask
operator|>>
literal|2
operator|)
operator|&
literal|0x1
condition|)
name|numPdGainsUsed
operator|++
expr_stmt|;
if|if
condition|(
operator|(
name|xpd_mask
operator|>>
literal|3
operator|)
operator|&
literal|0x1
condition|)
name|numPdGainsUsed
operator|++
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|myNumRawChannels
condition|;
name|i
operator|++
control|)
block|{
name|channelValue
operator|=
name|pMyRawChanList
index|[
name|i
index|]
expr_stmt|;
name|pEEPROMDataset2413
operator|->
name|pChannels
index|[
name|i
index|]
operator|=
name|channelValue
expr_stmt|;
name|pEEPROMDataset2413
operator|->
name|pDataPerChannel
index|[
name|i
index|]
operator|.
name|channelValue
operator|=
name|channelValue
expr_stmt|;
name|pEEPROMDataset2413
operator|->
name|pDataPerChannel
index|[
name|i
index|]
operator|.
name|numPdGains
operator|=
name|numPdGainsUsed
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|HAL_BOOL
name|ar2413ReadCalDataset
parameter_list|(
name|struct
name|ath_hal
modifier|*
name|ah
parameter_list|,
name|HAL_EEPROM
modifier|*
name|ee
parameter_list|,
name|EEPROM_DATA_STRUCT_2413
modifier|*
name|pCalDataset
parameter_list|,
name|uint32_t
name|start_offset
parameter_list|,
name|uint32_t
name|maxPiers
parameter_list|,
name|uint8_t
name|mode
parameter_list|)
block|{
define|#
directive|define
name|EEREAD
parameter_list|(
name|_off
parameter_list|)
value|do {				\ 	if (!ath_hal_eepromRead(ah, _off,&eeval))	\ 		return AH_FALSE;			\ } while (0)
specifier|const
name|uint16_t
name|dbm_I_mask
init|=
literal|0x1F
decl_stmt|;
comment|/* 5-bits. 1dB step. */
specifier|const
name|uint16_t
name|dbm_delta_mask
init|=
literal|0xF
decl_stmt|;
comment|/* 4-bits. 0.5dB step. */
specifier|const
name|uint16_t
name|Vpd_I_mask
init|=
literal|0x7F
decl_stmt|;
comment|/* 7-bits. 0-128 */
specifier|const
name|uint16_t
name|Vpd_delta_mask
init|=
literal|0x3F
decl_stmt|;
comment|/* 6-bits. 0-63 */
specifier|const
name|uint16_t
name|freqmask
init|=
literal|0xff
decl_stmt|;
name|uint16_t
name|ii
decl_stmt|,
name|eeval
decl_stmt|;
name|uint16_t
name|idx
decl_stmt|,
name|numPiers
decl_stmt|;
name|uint16_t
name|freq
index|[
name|NUM_11A_EEPROM_CHANNELS
index|]
decl_stmt|;
name|idx
operator|=
name|start_offset
expr_stmt|;
for|for
control|(
name|numPiers
operator|=
literal|0
init|;
name|numPiers
operator|<
name|maxPiers
condition|;
control|)
block|{
name|EEREAD
argument_list|(
name|idx
operator|++
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|eeval
operator|&
name|freqmask
operator|)
operator|==
literal|0
condition|)
break|break;
if|if
condition|(
name|mode
operator|==
name|headerInfo11A
condition|)
name|freq
index|[
name|numPiers
operator|++
index|]
operator|=
name|fbin2freq
argument_list|(
name|ee
argument_list|,
operator|(
name|eeval
operator|&
name|freqmask
operator|)
argument_list|)
expr_stmt|;
else|else
name|freq
index|[
name|numPiers
operator|++
index|]
operator|=
name|fbin2freq_2p4
argument_list|(
name|ee
argument_list|,
operator|(
name|eeval
operator|&
name|freqmask
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
operator|(
name|eeval
operator|>>
literal|8
operator|)
operator|&
name|freqmask
operator|)
operator|==
literal|0
condition|)
break|break;
if|if
condition|(
name|mode
operator|==
name|headerInfo11A
condition|)
name|freq
index|[
name|numPiers
operator|++
index|]
operator|=
name|fbin2freq
argument_list|(
name|ee
argument_list|,
operator|(
name|eeval
operator|>>
literal|8
operator|)
operator|&
name|freqmask
argument_list|)
expr_stmt|;
else|else
name|freq
index|[
name|numPiers
operator|++
index|]
operator|=
name|fbin2freq_2p4
argument_list|(
name|ee
argument_list|,
operator|(
name|eeval
operator|>>
literal|8
operator|)
operator|&
name|freqmask
argument_list|)
expr_stmt|;
block|}
name|ar2413SetupEEPROMDataset
argument_list|(
name|pCalDataset
argument_list|,
name|numPiers
argument_list|,
operator|&
name|freq
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
name|idx
operator|=
name|start_offset
operator|+
operator|(
name|maxPiers
operator|/
literal|2
operator|)
expr_stmt|;
for|for
control|(
name|ii
operator|=
literal|0
init|;
name|ii
operator|<
name|pCalDataset
operator|->
name|numChannels
condition|;
name|ii
operator|++
control|)
block|{
name|EEPROM_DATA_PER_CHANNEL_2413
modifier|*
name|currCh
init|=
operator|&
operator|(
name|pCalDataset
operator|->
name|pDataPerChannel
index|[
name|ii
index|]
operator|)
decl_stmt|;
if|if
condition|(
name|currCh
operator|->
name|numPdGains
operator|>
literal|0
condition|)
block|{
comment|/* 			 * Read the first NUM_POINTS_OTHER_PDGAINS pwr 			 * and Vpd values for pdgain_0 			 */
name|EEREAD
argument_list|(
name|idx
operator|++
argument_list|)
expr_stmt|;
name|currCh
operator|->
name|pwr_I
index|[
literal|0
index|]
operator|=
name|eeval
operator|&
name|dbm_I_mask
expr_stmt|;
name|currCh
operator|->
name|Vpd_I
index|[
literal|0
index|]
operator|=
operator|(
name|eeval
operator|>>
literal|5
operator|)
operator|&
name|Vpd_I_mask
expr_stmt|;
name|currCh
operator|->
name|pwr_delta_t2
index|[
literal|0
index|]
index|[
literal|0
index|]
operator|=
operator|(
name|eeval
operator|>>
literal|12
operator|)
operator|&
name|dbm_delta_mask
expr_stmt|;
name|EEREAD
argument_list|(
name|idx
operator|++
argument_list|)
expr_stmt|;
name|currCh
operator|->
name|Vpd_delta
index|[
literal|0
index|]
index|[
literal|0
index|]
operator|=
name|eeval
operator|&
name|Vpd_delta_mask
expr_stmt|;
name|currCh
operator|->
name|pwr_delta_t2
index|[
literal|1
index|]
index|[
literal|0
index|]
operator|=
operator|(
name|eeval
operator|>>
literal|6
operator|)
operator|&
name|dbm_delta_mask
expr_stmt|;
name|currCh
operator|->
name|Vpd_delta
index|[
literal|1
index|]
index|[
literal|0
index|]
operator|=
operator|(
name|eeval
operator|>>
literal|10
operator|)
operator|&
name|Vpd_delta_mask
expr_stmt|;
name|EEREAD
argument_list|(
name|idx
operator|++
argument_list|)
expr_stmt|;
name|currCh
operator|->
name|pwr_delta_t2
index|[
literal|2
index|]
index|[
literal|0
index|]
operator|=
name|eeval
operator|&
name|dbm_delta_mask
expr_stmt|;
name|currCh
operator|->
name|Vpd_delta
index|[
literal|2
index|]
index|[
literal|0
index|]
operator|=
operator|(
name|eeval
operator|>>
literal|4
operator|)
operator|&
name|Vpd_delta_mask
expr_stmt|;
block|}
if|if
condition|(
name|currCh
operator|->
name|numPdGains
operator|>
literal|1
condition|)
block|{
comment|/* 			 * Read the first NUM_POINTS_OTHER_PDGAINS pwr 			 * and Vpd values for pdgain_1 			 */
name|currCh
operator|->
name|pwr_I
index|[
literal|1
index|]
operator|=
operator|(
name|eeval
operator|>>
literal|10
operator|)
operator|&
name|dbm_I_mask
expr_stmt|;
name|currCh
operator|->
name|Vpd_I
index|[
literal|1
index|]
operator|=
operator|(
name|eeval
operator|>>
literal|15
operator|)
operator|&
literal|0x1
expr_stmt|;
name|EEREAD
argument_list|(
name|idx
operator|++
argument_list|)
expr_stmt|;
comment|/* upper 6 bits */
name|currCh
operator|->
name|Vpd_I
index|[
literal|1
index|]
operator||=
operator|(
name|eeval
operator|&
literal|0x3F
operator|)
operator|<<
literal|1
expr_stmt|;
name|currCh
operator|->
name|pwr_delta_t2
index|[
literal|0
index|]
index|[
literal|1
index|]
operator|=
operator|(
name|eeval
operator|>>
literal|6
operator|)
operator|&
name|dbm_delta_mask
expr_stmt|;
name|currCh
operator|->
name|Vpd_delta
index|[
literal|0
index|]
index|[
literal|1
index|]
operator|=
operator|(
name|eeval
operator|>>
literal|10
operator|)
operator|&
name|Vpd_delta_mask
expr_stmt|;
name|EEREAD
argument_list|(
name|idx
operator|++
argument_list|)
expr_stmt|;
name|currCh
operator|->
name|pwr_delta_t2
index|[
literal|1
index|]
index|[
literal|1
index|]
operator|=
name|eeval
operator|&
name|dbm_delta_mask
expr_stmt|;
name|currCh
operator|->
name|Vpd_delta
index|[
literal|1
index|]
index|[
literal|1
index|]
operator|=
operator|(
name|eeval
operator|>>
literal|4
operator|)
operator|&
name|Vpd_delta_mask
expr_stmt|;
name|currCh
operator|->
name|pwr_delta_t2
index|[
literal|2
index|]
index|[
literal|1
index|]
operator|=
operator|(
name|eeval
operator|>>
literal|10
operator|)
operator|&
name|dbm_delta_mask
expr_stmt|;
name|currCh
operator|->
name|Vpd_delta
index|[
literal|2
index|]
index|[
literal|1
index|]
operator|=
operator|(
name|eeval
operator|>>
literal|14
operator|)
operator|&
literal|0x3
expr_stmt|;
name|EEREAD
argument_list|(
name|idx
operator|++
argument_list|)
expr_stmt|;
comment|/* upper 4 bits */
name|currCh
operator|->
name|Vpd_delta
index|[
literal|2
index|]
index|[
literal|1
index|]
operator||=
operator|(
name|eeval
operator|&
literal|0xF
operator|)
operator|<<
literal|2
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|currCh
operator|->
name|numPdGains
operator|==
literal|1
condition|)
block|{
comment|/* 			 * Read the last pwr and Vpd values for pdgain_0 			 */
name|currCh
operator|->
name|pwr_delta_t2
index|[
literal|3
index|]
index|[
literal|0
index|]
operator|=
operator|(
name|eeval
operator|>>
literal|10
operator|)
operator|&
name|dbm_delta_mask
expr_stmt|;
name|currCh
operator|->
name|Vpd_delta
index|[
literal|3
index|]
index|[
literal|0
index|]
operator|=
operator|(
name|eeval
operator|>>
literal|14
operator|)
operator|&
literal|0x3
expr_stmt|;
name|EEREAD
argument_list|(
name|idx
operator|++
argument_list|)
expr_stmt|;
comment|/* upper 4 bits */
name|currCh
operator|->
name|Vpd_delta
index|[
literal|3
index|]
index|[
literal|0
index|]
operator||=
operator|(
name|eeval
operator|&
literal|0xF
operator|)
operator|<<
literal|2
expr_stmt|;
comment|/* 4 words if numPdGains == 1 */
block|}
if|if
condition|(
name|currCh
operator|->
name|numPdGains
operator|>
literal|2
condition|)
block|{
comment|/* 			 * Read the first NUM_POINTS_OTHER_PDGAINS pwr 			 * and Vpd values for pdgain_2 			 */
name|currCh
operator|->
name|pwr_I
index|[
literal|2
index|]
operator|=
operator|(
name|eeval
operator|>>
literal|4
operator|)
operator|&
name|dbm_I_mask
expr_stmt|;
name|currCh
operator|->
name|Vpd_I
index|[
literal|2
index|]
operator|=
operator|(
name|eeval
operator|>>
literal|9
operator|)
operator|&
name|Vpd_I_mask
expr_stmt|;
name|EEREAD
argument_list|(
name|idx
operator|++
argument_list|)
expr_stmt|;
name|currCh
operator|->
name|pwr_delta_t2
index|[
literal|0
index|]
index|[
literal|2
index|]
operator|=
operator|(
name|eeval
operator|>>
literal|0
operator|)
operator|&
name|dbm_delta_mask
expr_stmt|;
name|currCh
operator|->
name|Vpd_delta
index|[
literal|0
index|]
index|[
literal|2
index|]
operator|=
operator|(
name|eeval
operator|>>
literal|4
operator|)
operator|&
name|Vpd_delta_mask
expr_stmt|;
name|currCh
operator|->
name|pwr_delta_t2
index|[
literal|1
index|]
index|[
literal|2
index|]
operator|=
operator|(
name|eeval
operator|>>
literal|10
operator|)
operator|&
name|dbm_delta_mask
expr_stmt|;
name|currCh
operator|->
name|Vpd_delta
index|[
literal|1
index|]
index|[
literal|2
index|]
operator|=
operator|(
name|eeval
operator|>>
literal|14
operator|)
operator|&
literal|0x3
expr_stmt|;
name|EEREAD
argument_list|(
name|idx
operator|++
argument_list|)
expr_stmt|;
comment|/* upper 4 bits */
name|currCh
operator|->
name|Vpd_delta
index|[
literal|1
index|]
index|[
literal|2
index|]
operator||=
operator|(
name|eeval
operator|&
literal|0xF
operator|)
operator|<<
literal|2
expr_stmt|;
name|currCh
operator|->
name|pwr_delta_t2
index|[
literal|2
index|]
index|[
literal|2
index|]
operator|=
operator|(
name|eeval
operator|>>
literal|4
operator|)
operator|&
name|dbm_delta_mask
expr_stmt|;
name|currCh
operator|->
name|Vpd_delta
index|[
literal|2
index|]
index|[
literal|2
index|]
operator|=
operator|(
name|eeval
operator|>>
literal|8
operator|)
operator|&
name|Vpd_delta_mask
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|currCh
operator|->
name|numPdGains
operator|==
literal|2
condition|)
block|{
comment|/* 			 * Read the last pwr and Vpd values for pdgain_1 			 */
name|currCh
operator|->
name|pwr_delta_t2
index|[
literal|3
index|]
index|[
literal|1
index|]
operator|=
operator|(
name|eeval
operator|>>
literal|4
operator|)
operator|&
name|dbm_delta_mask
expr_stmt|;
name|currCh
operator|->
name|Vpd_delta
index|[
literal|3
index|]
index|[
literal|1
index|]
operator|=
operator|(
name|eeval
operator|>>
literal|8
operator|)
operator|&
name|Vpd_delta_mask
expr_stmt|;
comment|/* 6 words if numPdGains == 2 */
block|}
if|if
condition|(
name|currCh
operator|->
name|numPdGains
operator|>
literal|3
condition|)
block|{
comment|/* 			 * Read the first NUM_POINTS_OTHER_PDGAINS pwr 			 * and Vpd values for pdgain_3 			 */
name|currCh
operator|->
name|pwr_I
index|[
literal|3
index|]
operator|=
operator|(
name|eeval
operator|>>
literal|14
operator|)
operator|&
literal|0x3
expr_stmt|;
name|EEREAD
argument_list|(
name|idx
operator|++
argument_list|)
expr_stmt|;
comment|/* upper 3 bits */
name|currCh
operator|->
name|pwr_I
index|[
literal|3
index|]
operator||=
operator|(
operator|(
name|eeval
operator|>>
literal|0
operator|)
operator|&
literal|0x7
operator|)
operator|<<
literal|2
expr_stmt|;
name|currCh
operator|->
name|Vpd_I
index|[
literal|3
index|]
operator|=
operator|(
name|eeval
operator|>>
literal|3
operator|)
operator|&
name|Vpd_I_mask
expr_stmt|;
name|currCh
operator|->
name|pwr_delta_t2
index|[
literal|0
index|]
index|[
literal|3
index|]
operator|=
operator|(
name|eeval
operator|>>
literal|10
operator|)
operator|&
name|dbm_delta_mask
expr_stmt|;
name|currCh
operator|->
name|Vpd_delta
index|[
literal|0
index|]
index|[
literal|3
index|]
operator|=
operator|(
name|eeval
operator|>>
literal|14
operator|)
operator|&
literal|0x3
expr_stmt|;
name|EEREAD
argument_list|(
name|idx
operator|++
argument_list|)
expr_stmt|;
comment|/* upper 4 bits */
name|currCh
operator|->
name|Vpd_delta
index|[
literal|0
index|]
index|[
literal|3
index|]
operator||=
operator|(
name|eeval
operator|&
literal|0xF
operator|)
operator|<<
literal|2
expr_stmt|;
name|currCh
operator|->
name|pwr_delta_t2
index|[
literal|1
index|]
index|[
literal|3
index|]
operator|=
operator|(
name|eeval
operator|>>
literal|4
operator|)
operator|&
name|dbm_delta_mask
expr_stmt|;
name|currCh
operator|->
name|Vpd_delta
index|[
literal|1
index|]
index|[
literal|3
index|]
operator|=
operator|(
name|eeval
operator|>>
literal|8
operator|)
operator|&
name|Vpd_delta_mask
expr_stmt|;
name|currCh
operator|->
name|pwr_delta_t2
index|[
literal|2
index|]
index|[
literal|3
index|]
operator|=
operator|(
name|eeval
operator|>>
literal|14
operator|)
operator|&
literal|0x3
expr_stmt|;
name|EEREAD
argument_list|(
name|idx
operator|++
argument_list|)
expr_stmt|;
comment|/* upper 2 bits */
name|currCh
operator|->
name|pwr_delta_t2
index|[
literal|2
index|]
index|[
literal|3
index|]
operator||=
operator|(
operator|(
name|eeval
operator|>>
literal|0
operator|)
operator|&
literal|0x3
operator|)
operator|<<
literal|2
expr_stmt|;
name|currCh
operator|->
name|Vpd_delta
index|[
literal|2
index|]
index|[
literal|3
index|]
operator|=
operator|(
name|eeval
operator|>>
literal|2
operator|)
operator|&
name|Vpd_delta_mask
expr_stmt|;
name|currCh
operator|->
name|pwr_delta_t2
index|[
literal|3
index|]
index|[
literal|3
index|]
operator|=
operator|(
name|eeval
operator|>>
literal|8
operator|)
operator|&
name|dbm_delta_mask
expr_stmt|;
name|currCh
operator|->
name|Vpd_delta
index|[
literal|3
index|]
index|[
literal|3
index|]
operator|=
operator|(
name|eeval
operator|>>
literal|12
operator|)
operator|&
literal|0xF
expr_stmt|;
name|EEREAD
argument_list|(
name|idx
operator|++
argument_list|)
expr_stmt|;
comment|/* upper 2 bits */
name|currCh
operator|->
name|Vpd_delta
index|[
literal|3
index|]
index|[
literal|3
index|]
operator||=
operator|(
operator|(
name|eeval
operator|>>
literal|0
operator|)
operator|&
literal|0x3
operator|)
operator|<<
literal|4
expr_stmt|;
comment|/* 12 words if numPdGains == 4 */
block|}
elseif|else
if|if
condition|(
name|currCh
operator|->
name|numPdGains
operator|==
literal|3
condition|)
block|{
comment|/* read the last pwr and Vpd values for pdgain_2 */
name|currCh
operator|->
name|pwr_delta_t2
index|[
literal|3
index|]
index|[
literal|2
index|]
operator|=
operator|(
name|eeval
operator|>>
literal|14
operator|)
operator|&
literal|0x3
expr_stmt|;
name|EEREAD
argument_list|(
name|idx
operator|++
argument_list|)
expr_stmt|;
comment|/* upper 2 bits */
name|currCh
operator|->
name|pwr_delta_t2
index|[
literal|3
index|]
index|[
literal|2
index|]
operator||=
operator|(
operator|(
name|eeval
operator|>>
literal|0
operator|)
operator|&
literal|0x3
operator|)
operator|<<
literal|2
expr_stmt|;
name|currCh
operator|->
name|Vpd_delta
index|[
literal|3
index|]
index|[
literal|2
index|]
operator|=
operator|(
name|eeval
operator|>>
literal|2
operator|)
operator|&
name|Vpd_delta_mask
expr_stmt|;
comment|/* 9 words if numPdGains == 3 */
block|}
block|}
return|return
name|AH_TRUE
return|;
undef|#
directive|undef
name|EEREAD
block|}
end_function

begin_function
specifier|static
name|void
name|ar2413SetupRawDataset
parameter_list|(
name|RAW_DATA_STRUCT_2413
modifier|*
name|pRaw
parameter_list|,
name|EEPROM_DATA_STRUCT_2413
modifier|*
name|pCal
parameter_list|)
block|{
name|uint16_t
name|i
decl_stmt|,
name|j
decl_stmt|,
name|kk
decl_stmt|,
name|channelValue
decl_stmt|;
name|uint16_t
name|xpd_mask
decl_stmt|;
name|uint16_t
name|numPdGainsUsed
decl_stmt|;
name|pRaw
operator|->
name|numChannels
operator|=
name|pCal
operator|->
name|numChannels
expr_stmt|;
name|xpd_mask
operator|=
name|pRaw
operator|->
name|xpd_mask
expr_stmt|;
name|numPdGainsUsed
operator|=
literal|0
expr_stmt|;
if|if
condition|(
operator|(
name|xpd_mask
operator|>>
literal|0
operator|)
operator|&
literal|0x1
condition|)
name|numPdGainsUsed
operator|++
expr_stmt|;
if|if
condition|(
operator|(
name|xpd_mask
operator|>>
literal|1
operator|)
operator|&
literal|0x1
condition|)
name|numPdGainsUsed
operator|++
expr_stmt|;
if|if
condition|(
operator|(
name|xpd_mask
operator|>>
literal|2
operator|)
operator|&
literal|0x1
condition|)
name|numPdGainsUsed
operator|++
expr_stmt|;
if|if
condition|(
operator|(
name|xpd_mask
operator|>>
literal|3
operator|)
operator|&
literal|0x1
condition|)
name|numPdGainsUsed
operator|++
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|pCal
operator|->
name|numChannels
condition|;
name|i
operator|++
control|)
block|{
name|channelValue
operator|=
name|pCal
operator|->
name|pChannels
index|[
name|i
index|]
expr_stmt|;
name|pRaw
operator|->
name|pChannels
index|[
name|i
index|]
operator|=
name|channelValue
expr_stmt|;
name|pRaw
operator|->
name|pDataPerChannel
index|[
name|i
index|]
operator|.
name|channelValue
operator|=
name|channelValue
expr_stmt|;
name|pRaw
operator|->
name|pDataPerChannel
index|[
name|i
index|]
operator|.
name|numPdGains
operator|=
name|numPdGainsUsed
expr_stmt|;
name|kk
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|j
operator|=
literal|0
init|;
name|j
operator|<
name|MAX_NUM_PDGAINS_PER_CHANNEL
condition|;
name|j
operator|++
control|)
block|{
name|pRaw
operator|->
name|pDataPerChannel
index|[
name|i
index|]
operator|.
name|pDataPerPDGain
index|[
name|j
index|]
operator|.
name|pd_gain
operator|=
name|j
expr_stmt|;
if|if
condition|(
operator|(
name|xpd_mask
operator|>>
name|j
operator|)
operator|&
literal|0x1
condition|)
block|{
name|pRaw
operator|->
name|pDataPerChannel
index|[
name|i
index|]
operator|.
name|pDataPerPDGain
index|[
name|j
index|]
operator|.
name|numVpd
operator|=
name|NUM_POINTS_OTHER_PDGAINS
expr_stmt|;
name|kk
operator|++
expr_stmt|;
if|if
condition|(
name|kk
operator|==
literal|1
condition|)
block|{
comment|/*  					 * lowest pd_gain corresponds 					 *  to highest power and thus, 					 *  has one more point 					 */
name|pRaw
operator|->
name|pDataPerChannel
index|[
name|i
index|]
operator|.
name|pDataPerPDGain
index|[
name|j
index|]
operator|.
name|numVpd
operator|=
name|NUM_POINTS_LAST_PDGAIN
expr_stmt|;
block|}
block|}
else|else
block|{
name|pRaw
operator|->
name|pDataPerChannel
index|[
name|i
index|]
operator|.
name|pDataPerPDGain
index|[
name|j
index|]
operator|.
name|numVpd
operator|=
literal|0
expr_stmt|;
block|}
block|}
block|}
block|}
end_function

begin_function
specifier|static
name|HAL_BOOL
name|ar2413EepromToRawDataset
parameter_list|(
name|struct
name|ath_hal
modifier|*
name|ah
parameter_list|,
name|EEPROM_DATA_STRUCT_2413
modifier|*
name|pCal
parameter_list|,
name|RAW_DATA_STRUCT_2413
modifier|*
name|pRaw
parameter_list|)
block|{
name|uint16_t
name|ii
decl_stmt|,
name|jj
decl_stmt|,
name|kk
decl_stmt|,
name|ss
decl_stmt|;
name|RAW_DATA_PER_PDGAIN_2413
modifier|*
name|pRawXPD
decl_stmt|;
comment|/* ptr to array of info held per channel */
name|EEPROM_DATA_PER_CHANNEL_2413
modifier|*
name|pCalCh
decl_stmt|;
name|uint16_t
name|xgain_list
index|[
name|MAX_NUM_PDGAINS_PER_CHANNEL
index|]
decl_stmt|;
name|uint16_t
name|xpd_mask
decl_stmt|;
name|uint32_t
name|numPdGainsUsed
decl_stmt|;
name|HALASSERT
argument_list|(
name|pRaw
operator|->
name|xpd_mask
operator|==
name|pCal
operator|->
name|xpd_mask
argument_list|)
expr_stmt|;
name|xgain_list
index|[
literal|0
index|]
operator|=
literal|0xDEAD
expr_stmt|;
name|xgain_list
index|[
literal|1
index|]
operator|=
literal|0xDEAD
expr_stmt|;
name|xgain_list
index|[
literal|2
index|]
operator|=
literal|0xDEAD
expr_stmt|;
name|xgain_list
index|[
literal|3
index|]
operator|=
literal|0xDEAD
expr_stmt|;
name|numPdGainsUsed
operator|=
literal|0
expr_stmt|;
name|xpd_mask
operator|=
name|pRaw
operator|->
name|xpd_mask
expr_stmt|;
for|for
control|(
name|jj
operator|=
literal|0
init|;
name|jj
operator|<
name|MAX_NUM_PDGAINS_PER_CHANNEL
condition|;
name|jj
operator|++
control|)
block|{
if|if
condition|(
operator|(
name|xpd_mask
operator|>>
operator|(
name|MAX_NUM_PDGAINS_PER_CHANNEL
operator|-
name|jj
operator|-
literal|1
operator|)
operator|)
operator|&
literal|1
condition|)
name|xgain_list
index|[
name|numPdGainsUsed
operator|++
index|]
operator|=
name|MAX_NUM_PDGAINS_PER_CHANNEL
operator|-
name|jj
operator|-
literal|1
expr_stmt|;
block|}
name|pRaw
operator|->
name|numChannels
operator|=
name|pCal
operator|->
name|numChannels
expr_stmt|;
for|for
control|(
name|ii
operator|=
literal|0
init|;
name|ii
operator|<
name|pRaw
operator|->
name|numChannels
condition|;
name|ii
operator|++
control|)
block|{
name|pCalCh
operator|=
operator|&
operator|(
name|pCal
operator|->
name|pDataPerChannel
index|[
name|ii
index|]
operator|)
expr_stmt|;
name|pRaw
operator|->
name|pDataPerChannel
index|[
name|ii
index|]
operator|.
name|channelValue
operator|=
name|pCalCh
operator|->
name|channelValue
expr_stmt|;
comment|/* numVpd has already been setup appropriately for the relevant pdGains */
for|for
control|(
name|jj
operator|=
literal|0
init|;
name|jj
operator|<
name|numPdGainsUsed
condition|;
name|jj
operator|++
control|)
block|{
comment|/* use jj for calDataset and ss for rawDataset */
name|ss
operator|=
name|xgain_list
index|[
name|jj
index|]
expr_stmt|;
name|pRawXPD
operator|=
operator|&
operator|(
name|pRaw
operator|->
name|pDataPerChannel
index|[
name|ii
index|]
operator|.
name|pDataPerPDGain
index|[
name|ss
index|]
operator|)
expr_stmt|;
name|HALASSERT
argument_list|(
name|pRawXPD
operator|->
name|numVpd
operator|>=
literal|1
argument_list|)
expr_stmt|;
name|pRawXPD
operator|->
name|pwr_t4
index|[
literal|0
index|]
operator|=
call|(
name|uint16_t
call|)
argument_list|(
literal|4
operator|*
name|pCalCh
operator|->
name|pwr_I
index|[
name|jj
index|]
argument_list|)
expr_stmt|;
name|pRawXPD
operator|->
name|Vpd
index|[
literal|0
index|]
operator|=
name|pCalCh
operator|->
name|Vpd_I
index|[
name|jj
index|]
expr_stmt|;
for|for
control|(
name|kk
operator|=
literal|1
init|;
name|kk
operator|<
name|pRawXPD
operator|->
name|numVpd
condition|;
name|kk
operator|++
control|)
block|{
name|pRawXPD
operator|->
name|pwr_t4
index|[
name|kk
index|]
operator|=
call|(
name|int16_t
call|)
argument_list|(
name|pRawXPD
operator|->
name|pwr_t4
index|[
name|kk
operator|-
literal|1
index|]
operator|+
literal|2
operator|*
name|pCalCh
operator|->
name|pwr_delta_t2
index|[
name|kk
operator|-
literal|1
index|]
index|[
name|jj
index|]
argument_list|)
expr_stmt|;
name|pRawXPD
operator|->
name|Vpd
index|[
name|kk
index|]
operator|=
call|(
name|uint16_t
call|)
argument_list|(
name|pRawXPD
operator|->
name|Vpd
index|[
name|kk
operator|-
literal|1
index|]
operator|+
name|pCalCh
operator|->
name|Vpd_delta
index|[
name|kk
operator|-
literal|1
index|]
index|[
name|jj
index|]
argument_list|)
expr_stmt|;
block|}
comment|/* loop over Vpds */
block|}
comment|/* loop over pd_gains */
block|}
comment|/* loop over channels */
return|return
name|AH_TRUE
return|;
block|}
end_function

begin_function
specifier|static
name|HAL_BOOL
name|readEepromRawPowerCalInfo2413
parameter_list|(
name|struct
name|ath_hal
modifier|*
name|ah
parameter_list|,
name|HAL_EEPROM
modifier|*
name|ee
parameter_list|)
block|{
comment|/* NB: index is 1 less than numPdgains */
specifier|static
specifier|const
name|uint16_t
name|wordsForPdgains
index|[]
init|=
block|{
literal|4
block|,
literal|6
block|,
literal|9
block|,
literal|12
block|}
decl_stmt|;
name|EEPROM_DATA_STRUCT_2413
modifier|*
name|pCal
init|=
name|AH_NULL
decl_stmt|;
name|RAW_DATA_STRUCT_2413
modifier|*
name|pRaw
decl_stmt|;
name|int
name|numEEPROMWordsPerChannel
decl_stmt|;
name|uint32_t
name|off
decl_stmt|;
name|HAL_BOOL
name|ret
init|=
name|AH_FALSE
decl_stmt|;
name|HALASSERT
argument_list|(
name|ee
operator|->
name|ee_version
operator|>=
name|AR_EEPROM_VER5_0
argument_list|)
expr_stmt|;
name|HALASSERT
argument_list|(
name|ee
operator|->
name|ee_eepMap
operator|==
literal|2
argument_list|)
expr_stmt|;
name|pCal
operator|=
name|ath_hal_malloc
argument_list|(
sizeof|sizeof
argument_list|(
name|EEPROM_DATA_STRUCT_2413
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|pCal
operator|==
name|AH_NULL
condition|)
goto|goto
name|exit
goto|;
name|off
operator|=
name|ee
operator|->
name|ee_eepMap2PowerCalStart
expr_stmt|;
if|if
condition|(
name|ee
operator|->
name|ee_Amode
condition|)
block|{
name|OS_MEMZERO
argument_list|(
name|pCal
argument_list|,
sizeof|sizeof
argument_list|(
name|EEPROM_DATA_STRUCT_2413
argument_list|)
argument_list|)
expr_stmt|;
name|pCal
operator|->
name|xpd_mask
operator|=
name|ee
operator|->
name|ee_xgain
index|[
name|headerInfo11A
index|]
expr_stmt|;
if|if
condition|(
operator|!
name|ar2413ReadCalDataset
argument_list|(
name|ah
argument_list|,
name|ee
argument_list|,
name|pCal
argument_list|,
name|off
argument_list|,
name|NUM_11A_EEPROM_CHANNELS_2413
argument_list|,
name|headerInfo11A
argument_list|)
condition|)
block|{
goto|goto
name|exit
goto|;
block|}
name|pRaw
operator|=
operator|&
name|ee
operator|->
name|ee_rawDataset2413
index|[
name|headerInfo11A
index|]
expr_stmt|;
name|pRaw
operator|->
name|xpd_mask
operator|=
name|ee
operator|->
name|ee_xgain
index|[
name|headerInfo11A
index|]
expr_stmt|;
name|ar2413SetupRawDataset
argument_list|(
name|pRaw
argument_list|,
name|pCal
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|ar2413EepromToRawDataset
argument_list|(
name|ah
argument_list|,
name|pCal
argument_list|,
name|pRaw
argument_list|)
condition|)
block|{
goto|goto
name|exit
goto|;
block|}
comment|/* setup offsets for mode_11a next */
name|numEEPROMWordsPerChannel
operator|=
name|wordsForPdgains
index|[
name|pCal
operator|->
name|pDataPerChannel
index|[
literal|0
index|]
operator|.
name|numPdGains
operator|-
literal|1
index|]
expr_stmt|;
name|off
operator|+=
name|pCal
operator|->
name|numChannels
operator|*
name|numEEPROMWordsPerChannel
operator|+
literal|5
expr_stmt|;
block|}
if|if
condition|(
name|ee
operator|->
name|ee_Bmode
condition|)
block|{
name|OS_MEMZERO
argument_list|(
name|pCal
argument_list|,
sizeof|sizeof
argument_list|(
name|EEPROM_DATA_STRUCT_2413
argument_list|)
argument_list|)
expr_stmt|;
name|pCal
operator|->
name|xpd_mask
operator|=
name|ee
operator|->
name|ee_xgain
index|[
name|headerInfo11B
index|]
expr_stmt|;
if|if
condition|(
operator|!
name|ar2413ReadCalDataset
argument_list|(
name|ah
argument_list|,
name|ee
argument_list|,
name|pCal
argument_list|,
name|off
argument_list|,
name|NUM_2_4_EEPROM_CHANNELS_2413
argument_list|,
name|headerInfo11B
argument_list|)
condition|)
block|{
goto|goto
name|exit
goto|;
block|}
name|pRaw
operator|=
operator|&
name|ee
operator|->
name|ee_rawDataset2413
index|[
name|headerInfo11B
index|]
expr_stmt|;
name|pRaw
operator|->
name|xpd_mask
operator|=
name|ee
operator|->
name|ee_xgain
index|[
name|headerInfo11B
index|]
expr_stmt|;
name|ar2413SetupRawDataset
argument_list|(
name|pRaw
argument_list|,
name|pCal
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|ar2413EepromToRawDataset
argument_list|(
name|ah
argument_list|,
name|pCal
argument_list|,
name|pRaw
argument_list|)
condition|)
block|{
goto|goto
name|exit
goto|;
block|}
comment|/* setup offsets for mode_11g next */
name|numEEPROMWordsPerChannel
operator|=
name|wordsForPdgains
index|[
name|pCal
operator|->
name|pDataPerChannel
index|[
literal|0
index|]
operator|.
name|numPdGains
operator|-
literal|1
index|]
expr_stmt|;
name|off
operator|+=
name|pCal
operator|->
name|numChannels
operator|*
name|numEEPROMWordsPerChannel
operator|+
literal|2
expr_stmt|;
block|}
if|if
condition|(
name|ee
operator|->
name|ee_Gmode
condition|)
block|{
name|OS_MEMZERO
argument_list|(
name|pCal
argument_list|,
sizeof|sizeof
argument_list|(
name|EEPROM_DATA_STRUCT_2413
argument_list|)
argument_list|)
expr_stmt|;
name|pCal
operator|->
name|xpd_mask
operator|=
name|ee
operator|->
name|ee_xgain
index|[
name|headerInfo11G
index|]
expr_stmt|;
if|if
condition|(
operator|!
name|ar2413ReadCalDataset
argument_list|(
name|ah
argument_list|,
name|ee
argument_list|,
name|pCal
argument_list|,
name|off
argument_list|,
name|NUM_2_4_EEPROM_CHANNELS_2413
argument_list|,
name|headerInfo11G
argument_list|)
condition|)
block|{
goto|goto
name|exit
goto|;
block|}
name|pRaw
operator|=
operator|&
name|ee
operator|->
name|ee_rawDataset2413
index|[
name|headerInfo11G
index|]
expr_stmt|;
name|pRaw
operator|->
name|xpd_mask
operator|=
name|ee
operator|->
name|ee_xgain
index|[
name|headerInfo11G
index|]
expr_stmt|;
name|ar2413SetupRawDataset
argument_list|(
name|pRaw
argument_list|,
name|pCal
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|ar2413EepromToRawDataset
argument_list|(
name|ah
argument_list|,
name|pCal
argument_list|,
name|pRaw
argument_list|)
condition|)
block|{
goto|goto
name|exit
goto|;
block|}
block|}
name|ret
operator|=
name|AH_TRUE
expr_stmt|;
name|exit
label|:
if|if
condition|(
name|pCal
operator|!=
name|AH_NULL
condition|)
name|ath_hal_free
argument_list|(
name|pCal
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_comment
comment|/*  * Now copy EEPROM Raw Power Calibration per frequency contents   * into the allocated space  */
end_comment

begin_function
specifier|static
name|HAL_BOOL
name|readEepromRawPowerCalInfo
parameter_list|(
name|struct
name|ath_hal
modifier|*
name|ah
parameter_list|,
name|HAL_EEPROM
modifier|*
name|ee
parameter_list|)
block|{
define|#
directive|define
name|EEREAD
parameter_list|(
name|_off
parameter_list|)
value|do {				\ 	if (!ath_hal_eepromRead(ah, _off,&eeval))	\ 		return AH_FALSE;			\ } while (0)
name|uint16_t
name|eeval
decl_stmt|,
name|nchan
decl_stmt|;
name|uint32_t
name|off
decl_stmt|;
name|int
name|i
decl_stmt|,
name|j
decl_stmt|,
name|mode
decl_stmt|;
if|if
condition|(
name|ee
operator|->
name|ee_version
operator|>=
name|AR_EEPROM_VER4_0
operator|&&
name|ee
operator|->
name|ee_eepMap
operator|==
literal|1
condition|)
return|return
name|readEepromRawPowerCalInfo5112
argument_list|(
name|ah
argument_list|,
name|ee
argument_list|)
return|;
if|if
condition|(
name|ee
operator|->
name|ee_version
operator|>=
name|AR_EEPROM_VER5_0
operator|&&
name|ee
operator|->
name|ee_eepMap
operator|==
literal|2
condition|)
return|return
name|readEepromRawPowerCalInfo2413
argument_list|(
name|ah
argument_list|,
name|ee
argument_list|)
return|;
comment|/* 	 * Group 2:  read raw power data for all frequency piers 	 * 	 * NOTE: Group 2 contains the raw power calibration 	 *	 information for each of the channels that 	 *	 we recorded above. 	 */
for|for
control|(
name|mode
operator|=
name|headerInfo11A
init|;
name|mode
operator|<=
name|headerInfo11G
condition|;
name|mode
operator|++
control|)
block|{
name|uint16_t
modifier|*
name|pChannels
init|=
name|AH_NULL
decl_stmt|;
name|DATA_PER_CHANNEL
modifier|*
name|pChannelData
init|=
name|AH_NULL
decl_stmt|;
name|off
operator|=
name|ee
operator|->
name|ee_version
operator|>=
name|AR_EEPROM_VER3_3
condition|?
name|GROUPS_OFFSET3_3
else|:
name|GROUPS_OFFSET3_2
expr_stmt|;
switch|switch
condition|(
name|mode
condition|)
block|{
case|case
name|headerInfo11A
case|:
name|off
operator|+=
name|GROUP2_OFFSET
expr_stmt|;
name|nchan
operator|=
name|ee
operator|->
name|ee_numChannels11a
expr_stmt|;
name|pChannelData
operator|=
name|ee
operator|->
name|ee_dataPerChannel11a
expr_stmt|;
name|pChannels
operator|=
name|ee
operator|->
name|ee_channels11a
expr_stmt|;
break|break;
case|case
name|headerInfo11B
case|:
if|if
condition|(
operator|!
name|ee
operator|->
name|ee_Bmode
condition|)
continue|continue;
name|off
operator|+=
name|GROUP3_OFFSET
expr_stmt|;
name|nchan
operator|=
name|ee
operator|->
name|ee_numChannels2_4
expr_stmt|;
name|pChannelData
operator|=
name|ee
operator|->
name|ee_dataPerChannel11b
expr_stmt|;
name|pChannels
operator|=
name|ee
operator|->
name|ee_channels11b
expr_stmt|;
break|break;
case|case
name|headerInfo11G
case|:
if|if
condition|(
operator|!
name|ee
operator|->
name|ee_Gmode
condition|)
continue|continue;
name|off
operator|+=
name|GROUP4_OFFSET
expr_stmt|;
name|nchan
operator|=
name|ee
operator|->
name|ee_numChannels2_4
expr_stmt|;
name|pChannelData
operator|=
name|ee
operator|->
name|ee_dataPerChannel11g
expr_stmt|;
name|pChannels
operator|=
name|ee
operator|->
name|ee_channels11g
expr_stmt|;
break|break;
default|default:
name|HALDEBUG
argument_list|(
name|ah
argument_list|,
name|HAL_DEBUG_ANY
argument_list|,
literal|"%s: invalid mode 0x%x\n"
argument_list|,
name|__func__
argument_list|,
name|mode
argument_list|)
expr_stmt|;
return|return
name|AH_FALSE
return|;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|nchan
condition|;
name|i
operator|++
control|)
block|{
name|pChannelData
operator|->
name|channelValue
operator|=
name|pChannels
index|[
name|i
index|]
expr_stmt|;
name|EEREAD
argument_list|(
name|off
operator|++
argument_list|)
expr_stmt|;
name|pChannelData
operator|->
name|pcdacMax
operator|=
call|(
name|uint16_t
call|)
argument_list|(
operator|(
name|eeval
operator|>>
literal|10
operator|)
operator|&
name|PCDAC_MASK
argument_list|)
expr_stmt|;
name|pChannelData
operator|->
name|pcdacMin
operator|=
call|(
name|uint16_t
call|)
argument_list|(
operator|(
name|eeval
operator|>>
literal|4
operator|)
operator|&
name|PCDAC_MASK
argument_list|)
expr_stmt|;
name|pChannelData
operator|->
name|PwrValues
index|[
literal|0
index|]
operator|=
call|(
name|uint16_t
call|)
argument_list|(
operator|(
name|eeval
operator|<<
literal|2
operator|)
operator|&
name|POWER_MASK
argument_list|)
expr_stmt|;
name|EEREAD
argument_list|(
name|off
operator|++
argument_list|)
expr_stmt|;
name|pChannelData
operator|->
name|PwrValues
index|[
literal|0
index|]
operator||=
call|(
name|uint16_t
call|)
argument_list|(
operator|(
name|eeval
operator|>>
literal|14
operator|)
operator|&
literal|0x3
argument_list|)
expr_stmt|;
name|pChannelData
operator|->
name|PwrValues
index|[
literal|1
index|]
operator|=
call|(
name|uint16_t
call|)
argument_list|(
operator|(
name|eeval
operator|>>
literal|8
operator|)
operator|&
name|POWER_MASK
argument_list|)
expr_stmt|;
name|pChannelData
operator|->
name|PwrValues
index|[
literal|2
index|]
operator|=
call|(
name|uint16_t
call|)
argument_list|(
operator|(
name|eeval
operator|>>
literal|2
operator|)
operator|&
name|POWER_MASK
argument_list|)
expr_stmt|;
name|pChannelData
operator|->
name|PwrValues
index|[
literal|3
index|]
operator|=
call|(
name|uint16_t
call|)
argument_list|(
operator|(
name|eeval
operator|<<
literal|4
operator|)
operator|&
name|POWER_MASK
argument_list|)
expr_stmt|;
name|EEREAD
argument_list|(
name|off
operator|++
argument_list|)
expr_stmt|;
name|pChannelData
operator|->
name|PwrValues
index|[
literal|3
index|]
operator||=
call|(
name|uint16_t
call|)
argument_list|(
operator|(
name|eeval
operator|>>
literal|12
operator|)
operator|&
literal|0xf
argument_list|)
expr_stmt|;
name|pChannelData
operator|->
name|PwrValues
index|[
literal|4
index|]
operator|=
call|(
name|uint16_t
call|)
argument_list|(
operator|(
name|eeval
operator|>>
literal|6
operator|)
operator|&
name|POWER_MASK
argument_list|)
expr_stmt|;
name|pChannelData
operator|->
name|PwrValues
index|[
literal|5
index|]
operator|=
call|(
name|uint16_t
call|)
argument_list|(
name|eeval
operator|&
name|POWER_MASK
argument_list|)
expr_stmt|;
name|EEREAD
argument_list|(
name|off
operator|++
argument_list|)
expr_stmt|;
name|pChannelData
operator|->
name|PwrValues
index|[
literal|6
index|]
operator|=
call|(
name|uint16_t
call|)
argument_list|(
operator|(
name|eeval
operator|>>
literal|10
operator|)
operator|&
name|POWER_MASK
argument_list|)
expr_stmt|;
name|pChannelData
operator|->
name|PwrValues
index|[
literal|7
index|]
operator|=
call|(
name|uint16_t
call|)
argument_list|(
operator|(
name|eeval
operator|>>
literal|4
operator|)
operator|&
name|POWER_MASK
argument_list|)
expr_stmt|;
name|pChannelData
operator|->
name|PwrValues
index|[
literal|8
index|]
operator|=
call|(
name|uint16_t
call|)
argument_list|(
operator|(
name|eeval
operator|<<
literal|2
operator|)
operator|&
name|POWER_MASK
argument_list|)
expr_stmt|;
name|EEREAD
argument_list|(
name|off
operator|++
argument_list|)
expr_stmt|;
name|pChannelData
operator|->
name|PwrValues
index|[
literal|8
index|]
operator||=
call|(
name|uint16_t
call|)
argument_list|(
operator|(
name|eeval
operator|>>
literal|14
operator|)
operator|&
literal|0x3
argument_list|)
expr_stmt|;
name|pChannelData
operator|->
name|PwrValues
index|[
literal|9
index|]
operator|=
call|(
name|uint16_t
call|)
argument_list|(
operator|(
name|eeval
operator|>>
literal|8
operator|)
operator|&
name|POWER_MASK
argument_list|)
expr_stmt|;
name|pChannelData
operator|->
name|PwrValues
index|[
literal|10
index|]
operator|=
call|(
name|uint16_t
call|)
argument_list|(
operator|(
name|eeval
operator|>>
literal|2
operator|)
operator|&
name|POWER_MASK
argument_list|)
expr_stmt|;
name|getPcdacInterceptsFromPcdacMinMax
argument_list|(
name|ee
argument_list|,
name|pChannelData
operator|->
name|pcdacMin
argument_list|,
name|pChannelData
operator|->
name|pcdacMax
argument_list|,
name|pChannelData
operator|->
name|PcdacValues
argument_list|)
expr_stmt|;
for|for
control|(
name|j
operator|=
literal|0
init|;
name|j
operator|<
name|pChannelData
operator|->
name|numPcdacValues
condition|;
name|j
operator|++
control|)
block|{
name|pChannelData
operator|->
name|PwrValues
index|[
name|j
index|]
operator|=
call|(
name|uint16_t
call|)
argument_list|(
name|PWR_STEP
operator|*
name|pChannelData
operator|->
name|PwrValues
index|[
name|j
index|]
argument_list|)
expr_stmt|;
comment|/* Note these values are scaled up. */
block|}
name|pChannelData
operator|++
expr_stmt|;
block|}
block|}
return|return
name|AH_TRUE
return|;
undef|#
directive|undef
name|EEREAD
block|}
end_function

begin_comment
comment|/*  * Copy EEPROM Target Power Calbration per rate contents   * into the allocated space  */
end_comment

begin_function
specifier|static
name|HAL_BOOL
name|readEepromTargetPowerCalInfo
parameter_list|(
name|struct
name|ath_hal
modifier|*
name|ah
parameter_list|,
name|HAL_EEPROM
modifier|*
name|ee
parameter_list|)
block|{
define|#
directive|define
name|EEREAD
parameter_list|(
name|_off
parameter_list|)
value|do {				\ 	if (!ath_hal_eepromRead(ah, _off,&eeval))	\ 		return AH_FALSE;			\ } while (0)
name|uint16_t
name|eeval
decl_stmt|,
name|enable24
decl_stmt|;
name|uint32_t
name|off
decl_stmt|;
name|int
name|i
decl_stmt|,
name|mode
decl_stmt|,
name|nchan
decl_stmt|;
name|enable24
operator|=
name|ee
operator|->
name|ee_Bmode
operator|||
name|ee
operator|->
name|ee_Gmode
expr_stmt|;
for|for
control|(
name|mode
operator|=
name|headerInfo11A
init|;
name|mode
operator|<=
name|headerInfo11G
condition|;
name|mode
operator|++
control|)
block|{
name|TRGT_POWER_INFO
modifier|*
name|pPowerInfo
decl_stmt|;
name|uint16_t
modifier|*
name|pNumTrgtChannels
decl_stmt|;
name|off
operator|=
name|ee
operator|->
name|ee_version
operator|>=
name|AR_EEPROM_VER4_0
condition|?
name|ee
operator|->
name|ee_targetPowersStart
operator|-
name|GROUP5_OFFSET
else|:
name|ee
operator|->
name|ee_version
operator|>=
name|AR_EEPROM_VER3_3
condition|?
name|GROUPS_OFFSET3_3
else|:
name|GROUPS_OFFSET3_2
expr_stmt|;
switch|switch
condition|(
name|mode
condition|)
block|{
case|case
name|headerInfo11A
case|:
name|off
operator|+=
name|GROUP5_OFFSET
expr_stmt|;
name|nchan
operator|=
name|NUM_TEST_FREQUENCIES
expr_stmt|;
name|pPowerInfo
operator|=
name|ee
operator|->
name|ee_trgtPwr_11a
expr_stmt|;
name|pNumTrgtChannels
operator|=
operator|&
name|ee
operator|->
name|ee_numTargetPwr_11a
expr_stmt|;
break|break;
case|case
name|headerInfo11B
case|:
if|if
condition|(
operator|!
name|enable24
condition|)
continue|continue;
name|off
operator|+=
name|GROUP6_OFFSET
expr_stmt|;
name|nchan
operator|=
literal|2
expr_stmt|;
name|pPowerInfo
operator|=
name|ee
operator|->
name|ee_trgtPwr_11b
expr_stmt|;
name|pNumTrgtChannels
operator|=
operator|&
name|ee
operator|->
name|ee_numTargetPwr_11b
expr_stmt|;
break|break;
case|case
name|headerInfo11G
case|:
if|if
condition|(
operator|!
name|enable24
condition|)
continue|continue;
name|off
operator|+=
name|GROUP7_OFFSET
expr_stmt|;
name|nchan
operator|=
literal|3
expr_stmt|;
name|pPowerInfo
operator|=
name|ee
operator|->
name|ee_trgtPwr_11g
expr_stmt|;
name|pNumTrgtChannels
operator|=
operator|&
name|ee
operator|->
name|ee_numTargetPwr_11g
expr_stmt|;
break|break;
default|default:
name|HALDEBUG
argument_list|(
name|ah
argument_list|,
name|HAL_DEBUG_ANY
argument_list|,
literal|"%s: invalid mode 0x%x\n"
argument_list|,
name|__func__
argument_list|,
name|mode
argument_list|)
expr_stmt|;
return|return
name|AH_FALSE
return|;
block|}
operator|*
name|pNumTrgtChannels
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|nchan
condition|;
name|i
operator|++
control|)
block|{
name|EEREAD
argument_list|(
name|off
operator|++
argument_list|)
expr_stmt|;
if|if
condition|(
name|ee
operator|->
name|ee_version
operator|>=
name|AR_EEPROM_VER3_3
condition|)
block|{
name|pPowerInfo
operator|->
name|testChannel
operator|=
operator|(
name|eeval
operator|>>
literal|8
operator|)
operator|&
literal|0xff
expr_stmt|;
block|}
else|else
block|{
name|pPowerInfo
operator|->
name|testChannel
operator|=
operator|(
name|eeval
operator|>>
literal|9
operator|)
operator|&
literal|0x7f
expr_stmt|;
block|}
if|if
condition|(
name|pPowerInfo
operator|->
name|testChannel
operator|!=
literal|0
condition|)
block|{
comment|/* get the channel value and read rest of info */
if|if
condition|(
name|mode
operator|==
name|headerInfo11A
condition|)
block|{
name|pPowerInfo
operator|->
name|testChannel
operator|=
name|fbin2freq
argument_list|(
name|ee
argument_list|,
name|pPowerInfo
operator|->
name|testChannel
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|pPowerInfo
operator|->
name|testChannel
operator|=
name|fbin2freq_2p4
argument_list|(
name|ee
argument_list|,
name|pPowerInfo
operator|->
name|testChannel
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|ee
operator|->
name|ee_version
operator|>=
name|AR_EEPROM_VER3_3
condition|)
block|{
name|pPowerInfo
operator|->
name|twicePwr6_24
operator|=
operator|(
name|eeval
operator|>>
literal|2
operator|)
operator|&
name|POWER_MASK
expr_stmt|;
name|pPowerInfo
operator|->
name|twicePwr36
operator|=
operator|(
name|eeval
operator|<<
literal|4
operator|)
operator|&
name|POWER_MASK
expr_stmt|;
block|}
else|else
block|{
name|pPowerInfo
operator|->
name|twicePwr6_24
operator|=
operator|(
name|eeval
operator|>>
literal|3
operator|)
operator|&
name|POWER_MASK
expr_stmt|;
name|pPowerInfo
operator|->
name|twicePwr36
operator|=
operator|(
name|eeval
operator|<<
literal|3
operator|)
operator|&
name|POWER_MASK
expr_stmt|;
block|}
name|EEREAD
argument_list|(
name|off
operator|++
argument_list|)
expr_stmt|;
if|if
condition|(
name|ee
operator|->
name|ee_version
operator|>=
name|AR_EEPROM_VER3_3
condition|)
block|{
name|pPowerInfo
operator|->
name|twicePwr36
operator||=
operator|(
name|eeval
operator|>>
literal|12
operator|)
operator|&
literal|0xf
expr_stmt|;
name|pPowerInfo
operator|->
name|twicePwr48
operator|=
operator|(
name|eeval
operator|>>
literal|6
operator|)
operator|&
name|POWER_MASK
expr_stmt|;
name|pPowerInfo
operator|->
name|twicePwr54
operator|=
name|eeval
operator|&
name|POWER_MASK
expr_stmt|;
block|}
else|else
block|{
name|pPowerInfo
operator|->
name|twicePwr36
operator||=
operator|(
name|eeval
operator|>>
literal|13
operator|)
operator|&
literal|0x7
expr_stmt|;
name|pPowerInfo
operator|->
name|twicePwr48
operator|=
operator|(
name|eeval
operator|>>
literal|7
operator|)
operator|&
name|POWER_MASK
expr_stmt|;
name|pPowerInfo
operator|->
name|twicePwr54
operator|=
operator|(
name|eeval
operator|>>
literal|1
operator|)
operator|&
name|POWER_MASK
expr_stmt|;
block|}
operator|(
operator|*
name|pNumTrgtChannels
operator|)
operator|++
expr_stmt|;
block|}
name|pPowerInfo
operator|++
expr_stmt|;
block|}
block|}
return|return
name|AH_TRUE
return|;
undef|#
directive|undef
name|EEREAD
block|}
end_function

begin_comment
comment|/*  * Now copy EEPROM Coformance Testing Limits contents   * into the allocated space  */
end_comment

begin_function
specifier|static
name|HAL_BOOL
name|readEepromCTLInfo
parameter_list|(
name|struct
name|ath_hal
modifier|*
name|ah
parameter_list|,
name|HAL_EEPROM
modifier|*
name|ee
parameter_list|)
block|{
define|#
directive|define
name|EEREAD
parameter_list|(
name|_off
parameter_list|)
value|do {				\ 	if (!ath_hal_eepromRead(ah, _off,&eeval))	\ 		return AH_FALSE;			\ } while (0)
name|RD_EDGES_POWER
modifier|*
name|rep
decl_stmt|;
name|uint16_t
name|eeval
decl_stmt|;
name|uint32_t
name|off
decl_stmt|;
name|int
name|i
decl_stmt|,
name|j
decl_stmt|;
name|rep
operator|=
name|ee
operator|->
name|ee_rdEdgesPower
expr_stmt|;
name|off
operator|=
name|GROUP8_OFFSET
operator|+
operator|(
name|ee
operator|->
name|ee_version
operator|>=
name|AR_EEPROM_VER4_0
condition|?
name|ee
operator|->
name|ee_targetPowersStart
operator|-
name|GROUP5_OFFSET
else|:
name|ee
operator|->
name|ee_version
operator|>=
name|AR_EEPROM_VER3_3
condition|?
name|GROUPS_OFFSET3_3
else|:
name|GROUPS_OFFSET3_2
operator|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|ee
operator|->
name|ee_numCtls
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|ee
operator|->
name|ee_ctl
index|[
name|i
index|]
operator|==
literal|0
condition|)
block|{
comment|/* Move offset and edges */
name|off
operator|+=
operator|(
name|ee
operator|->
name|ee_version
operator|>=
name|AR_EEPROM_VER3_3
condition|?
literal|8
else|:
literal|7
operator|)
expr_stmt|;
name|rep
operator|+=
name|NUM_EDGES
expr_stmt|;
continue|continue;
block|}
if|if
condition|(
name|ee
operator|->
name|ee_version
operator|>=
name|AR_EEPROM_VER3_3
condition|)
block|{
for|for
control|(
name|j
operator|=
literal|0
init|;
name|j
operator|<
name|NUM_EDGES
condition|;
name|j
operator|+=
literal|2
control|)
block|{
name|EEREAD
argument_list|(
name|off
operator|++
argument_list|)
expr_stmt|;
name|rep
index|[
name|j
index|]
operator|.
name|rdEdge
operator|=
operator|(
name|eeval
operator|>>
literal|8
operator|)
operator|&
name|FREQ_MASK_3_3
expr_stmt|;
name|rep
index|[
name|j
operator|+
literal|1
index|]
operator|.
name|rdEdge
operator|=
name|eeval
operator|&
name|FREQ_MASK_3_3
expr_stmt|;
block|}
for|for
control|(
name|j
operator|=
literal|0
init|;
name|j
operator|<
name|NUM_EDGES
condition|;
name|j
operator|+=
literal|2
control|)
block|{
name|EEREAD
argument_list|(
name|off
operator|++
argument_list|)
expr_stmt|;
name|rep
index|[
name|j
index|]
operator|.
name|twice_rdEdgePower
operator|=
operator|(
name|eeval
operator|>>
literal|8
operator|)
operator|&
name|POWER_MASK
expr_stmt|;
name|rep
index|[
name|j
index|]
operator|.
name|flag
operator|=
operator|(
name|eeval
operator|>>
literal|14
operator|)
operator|&
literal|1
expr_stmt|;
name|rep
index|[
name|j
operator|+
literal|1
index|]
operator|.
name|twice_rdEdgePower
operator|=
name|eeval
operator|&
name|POWER_MASK
expr_stmt|;
name|rep
index|[
name|j
operator|+
literal|1
index|]
operator|.
name|flag
operator|=
operator|(
name|eeval
operator|>>
literal|6
operator|)
operator|&
literal|1
expr_stmt|;
block|}
block|}
else|else
block|{
name|EEREAD
argument_list|(
name|off
operator|++
argument_list|)
expr_stmt|;
name|rep
index|[
literal|0
index|]
operator|.
name|rdEdge
operator|=
operator|(
name|eeval
operator|>>
literal|9
operator|)
operator|&
name|FREQ_MASK
expr_stmt|;
name|rep
index|[
literal|1
index|]
operator|.
name|rdEdge
operator|=
operator|(
name|eeval
operator|>>
literal|2
operator|)
operator|&
name|FREQ_MASK
expr_stmt|;
name|rep
index|[
literal|2
index|]
operator|.
name|rdEdge
operator|=
operator|(
name|eeval
operator|<<
literal|5
operator|)
operator|&
name|FREQ_MASK
expr_stmt|;
name|EEREAD
argument_list|(
name|off
operator|++
argument_list|)
expr_stmt|;
name|rep
index|[
literal|2
index|]
operator|.
name|rdEdge
operator||=
operator|(
name|eeval
operator|>>
literal|11
operator|)
operator|&
literal|0x1f
expr_stmt|;
name|rep
index|[
literal|3
index|]
operator|.
name|rdEdge
operator|=
operator|(
name|eeval
operator|>>
literal|4
operator|)
operator|&
name|FREQ_MASK
expr_stmt|;
name|rep
index|[
literal|4
index|]
operator|.
name|rdEdge
operator|=
operator|(
name|eeval
operator|<<
literal|3
operator|)
operator|&
name|FREQ_MASK
expr_stmt|;
name|EEREAD
argument_list|(
name|off
operator|++
argument_list|)
expr_stmt|;
name|rep
index|[
literal|4
index|]
operator|.
name|rdEdge
operator||=
operator|(
name|eeval
operator|>>
literal|13
operator|)
operator|&
literal|0x7
expr_stmt|;
name|rep
index|[
literal|5
index|]
operator|.
name|rdEdge
operator|=
operator|(
name|eeval
operator|>>
literal|6
operator|)
operator|&
name|FREQ_MASK
expr_stmt|;
name|rep
index|[
literal|6
index|]
operator|.
name|rdEdge
operator|=
operator|(
name|eeval
operator|<<
literal|1
operator|)
operator|&
name|FREQ_MASK
expr_stmt|;
name|EEREAD
argument_list|(
name|off
operator|++
argument_list|)
expr_stmt|;
name|rep
index|[
literal|6
index|]
operator|.
name|rdEdge
operator||=
operator|(
name|eeval
operator|>>
literal|15
operator|)
operator|&
literal|0x1
expr_stmt|;
name|rep
index|[
literal|7
index|]
operator|.
name|rdEdge
operator|=
operator|(
name|eeval
operator|>>
literal|8
operator|)
operator|&
name|FREQ_MASK
expr_stmt|;
name|rep
index|[
literal|0
index|]
operator|.
name|twice_rdEdgePower
operator|=
operator|(
name|eeval
operator|>>
literal|2
operator|)
operator|&
name|POWER_MASK
expr_stmt|;
name|rep
index|[
literal|1
index|]
operator|.
name|twice_rdEdgePower
operator|=
operator|(
name|eeval
operator|<<
literal|4
operator|)
operator|&
name|POWER_MASK
expr_stmt|;
name|EEREAD
argument_list|(
name|off
operator|++
argument_list|)
expr_stmt|;
name|rep
index|[
literal|1
index|]
operator|.
name|twice_rdEdgePower
operator||=
operator|(
name|eeval
operator|>>
literal|12
operator|)
operator|&
literal|0xf
expr_stmt|;
name|rep
index|[
literal|2
index|]
operator|.
name|twice_rdEdgePower
operator|=
operator|(
name|eeval
operator|>>
literal|6
operator|)
operator|&
name|POWER_MASK
expr_stmt|;
name|rep
index|[
literal|3
index|]
operator|.
name|twice_rdEdgePower
operator|=
name|eeval
operator|&
name|POWER_MASK
expr_stmt|;
name|EEREAD
argument_list|(
name|off
operator|++
argument_list|)
expr_stmt|;
name|rep
index|[
literal|4
index|]
operator|.
name|twice_rdEdgePower
operator|=
operator|(
name|eeval
operator|>>
literal|10
operator|)
operator|&
name|POWER_MASK
expr_stmt|;
name|rep
index|[
literal|5
index|]
operator|.
name|twice_rdEdgePower
operator|=
operator|(
name|eeval
operator|>>
literal|4
operator|)
operator|&
name|POWER_MASK
expr_stmt|;
name|rep
index|[
literal|6
index|]
operator|.
name|twice_rdEdgePower
operator|=
operator|(
name|eeval
operator|<<
literal|2
operator|)
operator|&
name|POWER_MASK
expr_stmt|;
name|EEREAD
argument_list|(
name|off
operator|++
argument_list|)
expr_stmt|;
name|rep
index|[
literal|6
index|]
operator|.
name|twice_rdEdgePower
operator||=
operator|(
name|eeval
operator|>>
literal|14
operator|)
operator|&
literal|0x3
expr_stmt|;
name|rep
index|[
literal|7
index|]
operator|.
name|twice_rdEdgePower
operator|=
operator|(
name|eeval
operator|>>
literal|8
operator|)
operator|&
name|POWER_MASK
expr_stmt|;
block|}
for|for
control|(
name|j
operator|=
literal|0
init|;
name|j
operator|<
name|NUM_EDGES
condition|;
name|j
operator|++
control|)
block|{
if|if
condition|(
name|rep
index|[
name|j
index|]
operator|.
name|rdEdge
operator|!=
literal|0
operator|||
name|rep
index|[
name|j
index|]
operator|.
name|twice_rdEdgePower
operator|!=
literal|0
condition|)
block|{
if|if
condition|(
operator|(
name|ee
operator|->
name|ee_ctl
index|[
name|i
index|]
operator|&
name|CTL_MODE_M
operator|)
operator|==
name|CTL_11A
operator|||
operator|(
name|ee
operator|->
name|ee_ctl
index|[
name|i
index|]
operator|&
name|CTL_MODE_M
operator|)
operator|==
name|CTL_TURBO
condition|)
block|{
name|rep
index|[
name|j
index|]
operator|.
name|rdEdge
operator|=
name|fbin2freq
argument_list|(
name|ee
argument_list|,
name|rep
index|[
name|j
index|]
operator|.
name|rdEdge
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|rep
index|[
name|j
index|]
operator|.
name|rdEdge
operator|=
name|fbin2freq_2p4
argument_list|(
name|ee
argument_list|,
name|rep
index|[
name|j
index|]
operator|.
name|rdEdge
argument_list|)
expr_stmt|;
block|}
block|}
block|}
name|rep
operator|+=
name|NUM_EDGES
expr_stmt|;
block|}
return|return
name|AH_TRUE
return|;
undef|#
directive|undef
name|EEREAD
block|}
end_function

begin_comment
comment|/*  * Read the individual header fields for a Rev 3 EEPROM  */
end_comment

begin_function
specifier|static
name|HAL_BOOL
name|readHeaderInfo
parameter_list|(
name|struct
name|ath_hal
modifier|*
name|ah
parameter_list|,
name|HAL_EEPROM
modifier|*
name|ee
parameter_list|)
block|{
define|#
directive|define
name|EEREAD
parameter_list|(
name|_off
parameter_list|)
value|do {				\ 	if (!ath_hal_eepromRead(ah, _off,&eeval))	\ 		return AH_FALSE;			\ } while (0)
specifier|static
specifier|const
name|uint32_t
name|headerOffset3_0
index|[]
init|=
block|{
literal|0x00C2
block|,
comment|/* 0 - Mode bits, device type, max turbo power */
literal|0x00C4
block|,
comment|/* 1 - 2.4 and 5 antenna gain */
literal|0x00C5
block|,
comment|/* 2 - Begin 11A modal section */
literal|0x00D0
block|,
comment|/* 3 - Begin 11B modal section */
literal|0x00DA
block|,
comment|/* 4 - Begin 11G modal section */
literal|0x00E4
comment|/* 5 - Begin CTL section */
block|}
decl_stmt|;
specifier|static
specifier|const
name|uint32_t
name|headerOffset3_3
index|[]
init|=
block|{
literal|0x00C2
block|,
comment|/* 0 - Mode bits, device type, max turbo power */
literal|0x00C3
block|,
comment|/* 1 - 2.4 and 5 antenna gain */
literal|0x00D4
block|,
comment|/* 2 - Begin 11A modal section */
literal|0x00F2
block|,
comment|/* 3 - Begin 11B modal section */
literal|0x010D
block|,
comment|/* 4 - Begin 11G modal section */
literal|0x0128
comment|/* 5 - Begin CTL section */
block|}
decl_stmt|;
specifier|static
specifier|const
name|uint32_t
name|regCapOffsetPre4_0
init|=
literal|0x00CF
decl_stmt|;
specifier|static
specifier|const
name|uint32_t
name|regCapOffsetPost4_0
init|=
literal|0x00CA
decl_stmt|;
specifier|const
name|uint32_t
modifier|*
name|header
decl_stmt|;
name|uint32_t
name|off
decl_stmt|;
name|uint16_t
name|eeval
decl_stmt|;
name|int
name|i
decl_stmt|;
comment|/* initialize cckOfdmGainDelta for< 4.2 eeprom */
name|ee
operator|->
name|ee_cckOfdmGainDelta
operator|=
name|CCK_OFDM_GAIN_DELTA
expr_stmt|;
name|ee
operator|->
name|ee_scaledCh14FilterCckDelta
operator|=
name|TENX_CH14_FILTER_CCK_DELTA_INIT
expr_stmt|;
if|if
condition|(
name|ee
operator|->
name|ee_version
operator|>=
name|AR_EEPROM_VER3_3
condition|)
block|{
name|header
operator|=
name|headerOffset3_3
expr_stmt|;
name|ee
operator|->
name|ee_numCtls
operator|=
name|NUM_CTLS_3_3
expr_stmt|;
block|}
else|else
block|{
name|header
operator|=
name|headerOffset3_0
expr_stmt|;
name|ee
operator|->
name|ee_numCtls
operator|=
name|NUM_CTLS
expr_stmt|;
block|}
name|HALASSERT
argument_list|(
name|ee
operator|->
name|ee_numCtls
operator|<=
name|NUM_CTLS_MAX
argument_list|)
expr_stmt|;
name|EEREAD
argument_list|(
name|header
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
name|ee
operator|->
name|ee_turbo5Disable
operator|=
operator|(
name|eeval
operator|>>
literal|15
operator|)
operator|&
literal|0x01
expr_stmt|;
name|ee
operator|->
name|ee_rfKill
operator|=
operator|(
name|eeval
operator|>>
literal|14
operator|)
operator|&
literal|0x01
expr_stmt|;
name|ee
operator|->
name|ee_deviceType
operator|=
operator|(
name|eeval
operator|>>
literal|11
operator|)
operator|&
literal|0x07
expr_stmt|;
name|ee
operator|->
name|ee_turbo2WMaxPower5
operator|=
operator|(
name|eeval
operator|>>
literal|4
operator|)
operator|&
literal|0x7F
expr_stmt|;
if|if
condition|(
name|ee
operator|->
name|ee_version
operator|>=
name|AR_EEPROM_VER4_0
condition|)
name|ee
operator|->
name|ee_turbo2Disable
operator|=
operator|(
name|eeval
operator|>>
literal|3
operator|)
operator|&
literal|0x01
expr_stmt|;
else|else
name|ee
operator|->
name|ee_turbo2Disable
operator|=
literal|1
expr_stmt|;
name|ee
operator|->
name|ee_Gmode
operator|=
operator|(
name|eeval
operator|>>
literal|2
operator|)
operator|&
literal|0x01
expr_stmt|;
name|ee
operator|->
name|ee_Bmode
operator|=
operator|(
name|eeval
operator|>>
literal|1
operator|)
operator|&
literal|0x01
expr_stmt|;
name|ee
operator|->
name|ee_Amode
operator|=
operator|(
name|eeval
operator|&
literal|0x01
operator|)
expr_stmt|;
name|off
operator|=
name|header
index|[
literal|1
index|]
expr_stmt|;
name|EEREAD
argument_list|(
name|off
operator|++
argument_list|)
expr_stmt|;
name|ee
operator|->
name|ee_antennaGainMax
index|[
literal|0
index|]
operator|=
call|(
name|int8_t
call|)
argument_list|(
operator|(
name|eeval
operator|>>
literal|8
operator|)
operator|&
literal|0xFF
argument_list|)
expr_stmt|;
name|ee
operator|->
name|ee_antennaGainMax
index|[
literal|1
index|]
operator|=
call|(
name|int8_t
call|)
argument_list|(
name|eeval
operator|&
literal|0xFF
argument_list|)
expr_stmt|;
if|if
condition|(
name|ee
operator|->
name|ee_version
operator|>=
name|AR_EEPROM_VER4_0
condition|)
block|{
name|EEREAD
argument_list|(
name|off
operator|++
argument_list|)
expr_stmt|;
name|ee
operator|->
name|ee_eepMap
operator|=
operator|(
name|eeval
operator|>>
literal|14
operator|)
operator|&
literal|0x3
expr_stmt|;
name|ee
operator|->
name|ee_disableXr5
operator|=
operator|(
name|eeval
operator|>>
literal|13
operator|)
operator|&
literal|0x1
expr_stmt|;
name|ee
operator|->
name|ee_disableXr2
operator|=
operator|(
name|eeval
operator|>>
literal|12
operator|)
operator|&
literal|0x1
expr_stmt|;
name|ee
operator|->
name|ee_earStart
operator|=
name|eeval
operator|&
literal|0xfff
expr_stmt|;
name|EEREAD
argument_list|(
name|off
operator|++
argument_list|)
expr_stmt|;
name|ee
operator|->
name|ee_targetPowersStart
operator|=
name|eeval
operator|&
literal|0xfff
expr_stmt|;
name|ee
operator|->
name|ee_exist32kHzCrystal
operator|=
operator|(
name|eeval
operator|>>
literal|14
operator|)
operator|&
literal|0x1
expr_stmt|;
if|if
condition|(
name|ee
operator|->
name|ee_version
operator|>=
name|AR_EEPROM_VER5_0
condition|)
block|{
name|off
operator|+=
literal|2
expr_stmt|;
name|EEREAD
argument_list|(
name|off
argument_list|)
expr_stmt|;
name|ee
operator|->
name|ee_eepMap2PowerCalStart
operator|=
operator|(
name|eeval
operator|>>
literal|4
operator|)
operator|&
literal|0xfff
expr_stmt|;
comment|/* Properly cal'ed 5.0 devices should be non-zero */
block|}
block|}
comment|/* Read the moded sections of the EEPROM header in the order A, B, G */
for|for
control|(
name|i
operator|=
name|headerInfo11A
init|;
name|i
operator|<=
name|headerInfo11G
condition|;
name|i
operator|++
control|)
block|{
comment|/* Set the offset via the index */
name|off
operator|=
name|header
index|[
literal|2
operator|+
name|i
index|]
expr_stmt|;
name|EEREAD
argument_list|(
name|off
operator|++
argument_list|)
expr_stmt|;
name|ee
operator|->
name|ee_switchSettling
index|[
name|i
index|]
operator|=
operator|(
name|eeval
operator|>>
literal|8
operator|)
operator|&
literal|0x7f
expr_stmt|;
name|ee
operator|->
name|ee_txrxAtten
index|[
name|i
index|]
operator|=
operator|(
name|eeval
operator|>>
literal|2
operator|)
operator|&
literal|0x3f
expr_stmt|;
name|ee
operator|->
name|ee_antennaControl
index|[
literal|0
index|]
index|[
name|i
index|]
operator|=
operator|(
name|eeval
operator|<<
literal|4
operator|)
operator|&
literal|0x3f
expr_stmt|;
name|EEREAD
argument_list|(
name|off
operator|++
argument_list|)
expr_stmt|;
name|ee
operator|->
name|ee_antennaControl
index|[
literal|0
index|]
index|[
name|i
index|]
operator||=
operator|(
name|eeval
operator|>>
literal|12
operator|)
operator|&
literal|0x0f
expr_stmt|;
name|ee
operator|->
name|ee_antennaControl
index|[
literal|1
index|]
index|[
name|i
index|]
operator|=
operator|(
name|eeval
operator|>>
literal|6
operator|)
operator|&
literal|0x3f
expr_stmt|;
name|ee
operator|->
name|ee_antennaControl
index|[
literal|2
index|]
index|[
name|i
index|]
operator|=
name|eeval
operator|&
literal|0x3f
expr_stmt|;
name|EEREAD
argument_list|(
name|off
operator|++
argument_list|)
expr_stmt|;
name|ee
operator|->
name|ee_antennaControl
index|[
literal|3
index|]
index|[
name|i
index|]
operator|=
operator|(
name|eeval
operator|>>
literal|10
operator|)
operator|&
literal|0x3f
expr_stmt|;
name|ee
operator|->
name|ee_antennaControl
index|[
literal|4
index|]
index|[
name|i
index|]
operator|=
operator|(
name|eeval
operator|>>
literal|4
operator|)
operator|&
literal|0x3f
expr_stmt|;
name|ee
operator|->
name|ee_antennaControl
index|[
literal|5
index|]
index|[
name|i
index|]
operator|=
operator|(
name|eeval
operator|<<
literal|2
operator|)
operator|&
literal|0x3f
expr_stmt|;
name|EEREAD
argument_list|(
name|off
operator|++
argument_list|)
expr_stmt|;
name|ee
operator|->
name|ee_antennaControl
index|[
literal|5
index|]
index|[
name|i
index|]
operator||=
operator|(
name|eeval
operator|>>
literal|14
operator|)
operator|&
literal|0x03
expr_stmt|;
name|ee
operator|->
name|ee_antennaControl
index|[
literal|6
index|]
index|[
name|i
index|]
operator|=
operator|(
name|eeval
operator|>>
literal|8
operator|)
operator|&
literal|0x3f
expr_stmt|;
name|ee
operator|->
name|ee_antennaControl
index|[
literal|7
index|]
index|[
name|i
index|]
operator|=
operator|(
name|eeval
operator|>>
literal|2
operator|)
operator|&
literal|0x3f
expr_stmt|;
name|ee
operator|->
name|ee_antennaControl
index|[
literal|8
index|]
index|[
name|i
index|]
operator|=
operator|(
name|eeval
operator|<<
literal|4
operator|)
operator|&
literal|0x3f
expr_stmt|;
name|EEREAD
argument_list|(
name|off
operator|++
argument_list|)
expr_stmt|;
name|ee
operator|->
name|ee_antennaControl
index|[
literal|8
index|]
index|[
name|i
index|]
operator||=
operator|(
name|eeval
operator|>>
literal|12
operator|)
operator|&
literal|0x0f
expr_stmt|;
name|ee
operator|->
name|ee_antennaControl
index|[
literal|9
index|]
index|[
name|i
index|]
operator|=
operator|(
name|eeval
operator|>>
literal|6
operator|)
operator|&
literal|0x3f
expr_stmt|;
name|ee
operator|->
name|ee_antennaControl
index|[
literal|10
index|]
index|[
name|i
index|]
operator|=
name|eeval
operator|&
literal|0x3f
expr_stmt|;
name|EEREAD
argument_list|(
name|off
operator|++
argument_list|)
expr_stmt|;
name|ee
operator|->
name|ee_adcDesiredSize
index|[
name|i
index|]
operator|=
call|(
name|int8_t
call|)
argument_list|(
operator|(
name|eeval
operator|>>
literal|8
operator|)
operator|&
literal|0xff
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|i
condition|)
block|{
case|case
name|headerInfo11A
case|:
name|ee
operator|->
name|ee_ob4
operator|=
operator|(
name|eeval
operator|>>
literal|5
operator|)
operator|&
literal|0x07
expr_stmt|;
name|ee
operator|->
name|ee_db4
operator|=
operator|(
name|eeval
operator|>>
literal|2
operator|)
operator|&
literal|0x07
expr_stmt|;
name|ee
operator|->
name|ee_ob3
operator|=
operator|(
name|eeval
operator|<<
literal|1
operator|)
operator|&
literal|0x07
expr_stmt|;
break|break;
case|case
name|headerInfo11B
case|:
name|ee
operator|->
name|ee_obFor24
operator|=
operator|(
name|eeval
operator|>>
literal|4
operator|)
operator|&
literal|0x07
expr_stmt|;
name|ee
operator|->
name|ee_dbFor24
operator|=
name|eeval
operator|&
literal|0x07
expr_stmt|;
break|break;
case|case
name|headerInfo11G
case|:
name|ee
operator|->
name|ee_obFor24g
operator|=
operator|(
name|eeval
operator|>>
literal|4
operator|)
operator|&
literal|0x07
expr_stmt|;
name|ee
operator|->
name|ee_dbFor24g
operator|=
name|eeval
operator|&
literal|0x07
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|i
operator|==
name|headerInfo11A
condition|)
block|{
name|EEREAD
argument_list|(
name|off
operator|++
argument_list|)
expr_stmt|;
name|ee
operator|->
name|ee_ob3
operator||=
operator|(
name|eeval
operator|>>
literal|15
operator|)
operator|&
literal|0x01
expr_stmt|;
name|ee
operator|->
name|ee_db3
operator|=
operator|(
name|eeval
operator|>>
literal|12
operator|)
operator|&
literal|0x07
expr_stmt|;
name|ee
operator|->
name|ee_ob2
operator|=
operator|(
name|eeval
operator|>>
literal|9
operator|)
operator|&
literal|0x07
expr_stmt|;
name|ee
operator|->
name|ee_db2
operator|=
operator|(
name|eeval
operator|>>
literal|6
operator|)
operator|&
literal|0x07
expr_stmt|;
name|ee
operator|->
name|ee_ob1
operator|=
operator|(
name|eeval
operator|>>
literal|3
operator|)
operator|&
literal|0x07
expr_stmt|;
name|ee
operator|->
name|ee_db1
operator|=
name|eeval
operator|&
literal|0x07
expr_stmt|;
block|}
name|EEREAD
argument_list|(
name|off
operator|++
argument_list|)
expr_stmt|;
name|ee
operator|->
name|ee_txEndToXLNAOn
index|[
name|i
index|]
operator|=
operator|(
name|eeval
operator|>>
literal|8
operator|)
operator|&
literal|0xff
expr_stmt|;
name|ee
operator|->
name|ee_thresh62
index|[
name|i
index|]
operator|=
name|eeval
operator|&
literal|0xff
expr_stmt|;
name|EEREAD
argument_list|(
name|off
operator|++
argument_list|)
expr_stmt|;
name|ee
operator|->
name|ee_txEndToXPAOff
index|[
name|i
index|]
operator|=
operator|(
name|eeval
operator|>>
literal|8
operator|)
operator|&
literal|0xff
expr_stmt|;
name|ee
operator|->
name|ee_txFrameToXPAOn
index|[
name|i
index|]
operator|=
name|eeval
operator|&
literal|0xff
expr_stmt|;
name|EEREAD
argument_list|(
name|off
operator|++
argument_list|)
expr_stmt|;
name|ee
operator|->
name|ee_pgaDesiredSize
index|[
name|i
index|]
operator|=
call|(
name|int8_t
call|)
argument_list|(
operator|(
name|eeval
operator|>>
literal|8
operator|)
operator|&
literal|0xff
argument_list|)
expr_stmt|;
name|ee
operator|->
name|ee_noiseFloorThresh
index|[
name|i
index|]
operator|=
name|eeval
operator|&
literal|0xff
expr_stmt|;
if|if
condition|(
name|ee
operator|->
name|ee_noiseFloorThresh
index|[
name|i
index|]
operator|&
literal|0x80
condition|)
block|{
name|ee
operator|->
name|ee_noiseFloorThresh
index|[
name|i
index|]
operator|=
literal|0
operator|-
operator|(
operator|(
name|ee
operator|->
name|ee_noiseFloorThresh
index|[
name|i
index|]
operator|^
literal|0xff
operator|)
operator|+
literal|1
operator|)
expr_stmt|;
block|}
name|EEREAD
argument_list|(
name|off
operator|++
argument_list|)
expr_stmt|;
name|ee
operator|->
name|ee_xlnaGain
index|[
name|i
index|]
operator|=
operator|(
name|eeval
operator|>>
literal|5
operator|)
operator|&
literal|0xff
expr_stmt|;
name|ee
operator|->
name|ee_xgain
index|[
name|i
index|]
operator|=
operator|(
name|eeval
operator|>>
literal|1
operator|)
operator|&
literal|0x0f
expr_stmt|;
name|ee
operator|->
name|ee_xpd
index|[
name|i
index|]
operator|=
name|eeval
operator|&
literal|0x01
expr_stmt|;
if|if
condition|(
name|ee
operator|->
name|ee_version
operator|>=
name|AR_EEPROM_VER4_0
condition|)
block|{
switch|switch
condition|(
name|i
condition|)
block|{
case|case
name|headerInfo11A
case|:
name|ee
operator|->
name|ee_fixedBias5
operator|=
operator|(
name|eeval
operator|>>
literal|13
operator|)
operator|&
literal|0x1
expr_stmt|;
break|break;
case|case
name|headerInfo11G
case|:
name|ee
operator|->
name|ee_fixedBias2
operator|=
operator|(
name|eeval
operator|>>
literal|13
operator|)
operator|&
literal|0x1
expr_stmt|;
break|break;
block|}
block|}
if|if
condition|(
name|ee
operator|->
name|ee_version
operator|>=
name|AR_EEPROM_VER3_3
condition|)
block|{
name|EEREAD
argument_list|(
name|off
operator|++
argument_list|)
expr_stmt|;
name|ee
operator|->
name|ee_falseDetectBackoff
index|[
name|i
index|]
operator|=
operator|(
name|eeval
operator|>>
literal|6
operator|)
operator|&
literal|0x7F
expr_stmt|;
switch|switch
condition|(
name|i
condition|)
block|{
case|case
name|headerInfo11B
case|:
name|ee
operator|->
name|ee_ob2GHz
index|[
literal|0
index|]
operator|=
name|eeval
operator|&
literal|0x7
expr_stmt|;
name|ee
operator|->
name|ee_db2GHz
index|[
literal|0
index|]
operator|=
operator|(
name|eeval
operator|>>
literal|3
operator|)
operator|&
literal|0x7
expr_stmt|;
break|break;
case|case
name|headerInfo11G
case|:
name|ee
operator|->
name|ee_ob2GHz
index|[
literal|1
index|]
operator|=
name|eeval
operator|&
literal|0x7
expr_stmt|;
name|ee
operator|->
name|ee_db2GHz
index|[
literal|1
index|]
operator|=
operator|(
name|eeval
operator|>>
literal|3
operator|)
operator|&
literal|0x7
expr_stmt|;
break|break;
case|case
name|headerInfo11A
case|:
name|ee
operator|->
name|ee_xrTargetPower5
operator|=
name|eeval
operator|&
literal|0x3f
expr_stmt|;
break|break;
block|}
block|}
if|if
condition|(
name|ee
operator|->
name|ee_version
operator|>=
name|AR_EEPROM_VER3_4
condition|)
block|{
name|ee
operator|->
name|ee_gainI
index|[
name|i
index|]
operator|=
operator|(
name|eeval
operator|>>
literal|13
operator|)
operator|&
literal|0x07
expr_stmt|;
name|EEREAD
argument_list|(
name|off
operator|++
argument_list|)
expr_stmt|;
name|ee
operator|->
name|ee_gainI
index|[
name|i
index|]
operator||=
operator|(
name|eeval
operator|<<
literal|3
operator|)
operator|&
literal|0x38
expr_stmt|;
if|if
condition|(
name|i
operator|==
name|headerInfo11G
condition|)
block|{
name|ee
operator|->
name|ee_cckOfdmPwrDelta
operator|=
operator|(
name|eeval
operator|>>
literal|3
operator|)
operator|&
literal|0xFF
expr_stmt|;
if|if
condition|(
name|ee
operator|->
name|ee_version
operator|>=
name|AR_EEPROM_VER4_6
condition|)
name|ee
operator|->
name|ee_scaledCh14FilterCckDelta
operator|=
operator|(
name|eeval
operator|>>
literal|11
operator|)
operator|&
literal|0x1f
expr_stmt|;
block|}
if|if
condition|(
name|i
operator|==
name|headerInfo11A
operator|&&
name|ee
operator|->
name|ee_version
operator|>=
name|AR_EEPROM_VER4_0
condition|)
block|{
name|ee
operator|->
name|ee_iqCalI
index|[
literal|0
index|]
operator|=
operator|(
name|eeval
operator|>>
literal|8
operator|)
operator|&
literal|0x3f
expr_stmt|;
name|ee
operator|->
name|ee_iqCalQ
index|[
literal|0
index|]
operator|=
operator|(
name|eeval
operator|>>
literal|3
operator|)
operator|&
literal|0x1f
expr_stmt|;
block|}
block|}
else|else
block|{
name|ee
operator|->
name|ee_gainI
index|[
name|i
index|]
operator|=
literal|10
expr_stmt|;
name|ee
operator|->
name|ee_cckOfdmPwrDelta
operator|=
name|TENX_OFDM_CCK_DELTA_INIT
expr_stmt|;
block|}
if|if
condition|(
name|ee
operator|->
name|ee_version
operator|>=
name|AR_EEPROM_VER4_0
condition|)
block|{
switch|switch
condition|(
name|i
condition|)
block|{
case|case
name|headerInfo11B
case|:
name|EEREAD
argument_list|(
name|off
operator|++
argument_list|)
expr_stmt|;
name|ee
operator|->
name|ee_calPier11b
index|[
literal|0
index|]
operator|=
name|fbin2freq_2p4
argument_list|(
name|ee
argument_list|,
name|eeval
operator|&
literal|0xff
argument_list|)
expr_stmt|;
name|ee
operator|->
name|ee_calPier11b
index|[
literal|1
index|]
operator|=
name|fbin2freq_2p4
argument_list|(
name|ee
argument_list|,
operator|(
name|eeval
operator|>>
literal|8
operator|)
operator|&
literal|0xff
argument_list|)
expr_stmt|;
name|EEREAD
argument_list|(
name|off
operator|++
argument_list|)
expr_stmt|;
name|ee
operator|->
name|ee_calPier11b
index|[
literal|2
index|]
operator|=
name|fbin2freq_2p4
argument_list|(
name|ee
argument_list|,
name|eeval
operator|&
literal|0xff
argument_list|)
expr_stmt|;
if|if
condition|(
name|ee
operator|->
name|ee_version
operator|>=
name|AR_EEPROM_VER4_1
condition|)
name|ee
operator|->
name|ee_rxtxMargin
index|[
name|headerInfo11B
index|]
operator|=
operator|(
name|eeval
operator|>>
literal|8
operator|)
operator|&
literal|0x3f
expr_stmt|;
break|break;
case|case
name|headerInfo11G
case|:
name|EEREAD
argument_list|(
name|off
operator|++
argument_list|)
expr_stmt|;
name|ee
operator|->
name|ee_calPier11g
index|[
literal|0
index|]
operator|=
name|fbin2freq_2p4
argument_list|(
name|ee
argument_list|,
name|eeval
operator|&
literal|0xff
argument_list|)
expr_stmt|;
name|ee
operator|->
name|ee_calPier11g
index|[
literal|1
index|]
operator|=
name|fbin2freq_2p4
argument_list|(
name|ee
argument_list|,
operator|(
name|eeval
operator|>>
literal|8
operator|)
operator|&
literal|0xff
argument_list|)
expr_stmt|;
name|EEREAD
argument_list|(
name|off
operator|++
argument_list|)
expr_stmt|;
name|ee
operator|->
name|ee_turbo2WMaxPower2
operator|=
name|eeval
operator|&
literal|0x7F
expr_stmt|;
name|ee
operator|->
name|ee_xrTargetPower2
operator|=
operator|(
name|eeval
operator|>>
literal|7
operator|)
operator|&
literal|0x3f
expr_stmt|;
name|EEREAD
argument_list|(
name|off
operator|++
argument_list|)
expr_stmt|;
name|ee
operator|->
name|ee_calPier11g
index|[
literal|2
index|]
operator|=
name|fbin2freq_2p4
argument_list|(
name|ee
argument_list|,
name|eeval
operator|&
literal|0xff
argument_list|)
expr_stmt|;
if|if
condition|(
name|ee
operator|->
name|ee_version
operator|>=
name|AR_EEPROM_VER4_1
condition|)
name|ee
operator|->
name|ee_rxtxMargin
index|[
name|headerInfo11G
index|]
operator|=
operator|(
name|eeval
operator|>>
literal|8
operator|)
operator|&
literal|0x3f
expr_stmt|;
name|EEREAD
argument_list|(
name|off
operator|++
argument_list|)
expr_stmt|;
name|ee
operator|->
name|ee_iqCalI
index|[
literal|1
index|]
operator|=
operator|(
name|eeval
operator|>>
literal|5
operator|)
operator|&
literal|0x3F
expr_stmt|;
name|ee
operator|->
name|ee_iqCalQ
index|[
literal|1
index|]
operator|=
name|eeval
operator|&
literal|0x1F
expr_stmt|;
if|if
condition|(
name|ee
operator|->
name|ee_version
operator|>=
name|AR_EEPROM_VER4_2
condition|)
block|{
name|EEREAD
argument_list|(
name|off
operator|++
argument_list|)
expr_stmt|;
name|ee
operator|->
name|ee_cckOfdmGainDelta
operator|=
call|(
name|uint8_t
call|)
argument_list|(
name|eeval
operator|&
literal|0xFF
argument_list|)
expr_stmt|;
if|if
condition|(
name|ee
operator|->
name|ee_version
operator|>=
name|AR_EEPROM_VER5_0
condition|)
block|{
name|ee
operator|->
name|ee_switchSettlingTurbo
index|[
literal|1
index|]
operator|=
operator|(
name|eeval
operator|>>
literal|8
operator|)
operator|&
literal|0x7f
expr_stmt|;
name|ee
operator|->
name|ee_txrxAttenTurbo
index|[
literal|1
index|]
operator|=
operator|(
name|eeval
operator|>>
literal|15
operator|)
operator|&
literal|0x1
expr_stmt|;
name|EEREAD
argument_list|(
name|off
operator|++
argument_list|)
expr_stmt|;
name|ee
operator|->
name|ee_txrxAttenTurbo
index|[
literal|1
index|]
operator||=
operator|(
name|eeval
operator|&
literal|0x1F
operator|)
operator|<<
literal|1
expr_stmt|;
name|ee
operator|->
name|ee_rxtxMarginTurbo
index|[
literal|1
index|]
operator|=
operator|(
name|eeval
operator|>>
literal|5
operator|)
operator|&
literal|0x3F
expr_stmt|;
name|ee
operator|->
name|ee_adcDesiredSizeTurbo
index|[
literal|1
index|]
operator|=
operator|(
name|eeval
operator|>>
literal|11
operator|)
operator|&
literal|0x1F
expr_stmt|;
name|EEREAD
argument_list|(
name|off
operator|++
argument_list|)
expr_stmt|;
name|ee
operator|->
name|ee_adcDesiredSizeTurbo
index|[
literal|1
index|]
operator||=
operator|(
name|eeval
operator|&
literal|0x7
operator|)
operator|<<
literal|5
expr_stmt|;
name|ee
operator|->
name|ee_pgaDesiredSizeTurbo
index|[
literal|1
index|]
operator|=
operator|(
name|eeval
operator|>>
literal|3
operator|)
operator|&
literal|0xFF
expr_stmt|;
block|}
block|}
break|break;
case|case
name|headerInfo11A
case|:
if|if
condition|(
name|ee
operator|->
name|ee_version
operator|>=
name|AR_EEPROM_VER4_1
condition|)
block|{
name|EEREAD
argument_list|(
name|off
operator|++
argument_list|)
expr_stmt|;
name|ee
operator|->
name|ee_rxtxMargin
index|[
name|headerInfo11A
index|]
operator|=
name|eeval
operator|&
literal|0x3f
expr_stmt|;
if|if
condition|(
name|ee
operator|->
name|ee_version
operator|>=
name|AR_EEPROM_VER5_0
condition|)
block|{
name|ee
operator|->
name|ee_switchSettlingTurbo
index|[
literal|0
index|]
operator|=
operator|(
name|eeval
operator|>>
literal|6
operator|)
operator|&
literal|0x7f
expr_stmt|;
name|ee
operator|->
name|ee_txrxAttenTurbo
index|[
literal|0
index|]
operator|=
operator|(
name|eeval
operator|>>
literal|13
operator|)
operator|&
literal|0x7
expr_stmt|;
name|EEREAD
argument_list|(
name|off
operator|++
argument_list|)
expr_stmt|;
name|ee
operator|->
name|ee_txrxAttenTurbo
index|[
literal|0
index|]
operator||=
operator|(
name|eeval
operator|&
literal|0x7
operator|)
operator|<<
literal|3
expr_stmt|;
name|ee
operator|->
name|ee_rxtxMarginTurbo
index|[
literal|0
index|]
operator|=
operator|(
name|eeval
operator|>>
literal|3
operator|)
operator|&
literal|0x3F
expr_stmt|;
name|ee
operator|->
name|ee_adcDesiredSizeTurbo
index|[
literal|0
index|]
operator|=
operator|(
name|eeval
operator|>>
literal|9
operator|)
operator|&
literal|0x7F
expr_stmt|;
name|EEREAD
argument_list|(
name|off
operator|++
argument_list|)
expr_stmt|;
name|ee
operator|->
name|ee_adcDesiredSizeTurbo
index|[
literal|0
index|]
operator||=
operator|(
name|eeval
operator|&
literal|0x1
operator|)
operator|<<
literal|7
expr_stmt|;
name|ee
operator|->
name|ee_pgaDesiredSizeTurbo
index|[
literal|0
index|]
operator|=
operator|(
name|eeval
operator|>>
literal|1
operator|)
operator|&
literal|0xFF
expr_stmt|;
block|}
block|}
break|break;
block|}
block|}
block|}
if|if
condition|(
name|ee
operator|->
name|ee_version
operator|<
name|AR_EEPROM_VER3_3
condition|)
block|{
comment|/* Version 3.1+ specific parameters */
name|EEREAD
argument_list|(
literal|0xec
argument_list|)
expr_stmt|;
name|ee
operator|->
name|ee_ob2GHz
index|[
literal|0
index|]
operator|=
name|eeval
operator|&
literal|0x7
expr_stmt|;
name|ee
operator|->
name|ee_db2GHz
index|[
literal|0
index|]
operator|=
operator|(
name|eeval
operator|>>
literal|3
operator|)
operator|&
literal|0x7
expr_stmt|;
name|EEREAD
argument_list|(
literal|0xed
argument_list|)
expr_stmt|;
name|ee
operator|->
name|ee_ob2GHz
index|[
literal|1
index|]
operator|=
name|eeval
operator|&
literal|0x7
expr_stmt|;
name|ee
operator|->
name|ee_db2GHz
index|[
literal|1
index|]
operator|=
operator|(
name|eeval
operator|>>
literal|3
operator|)
operator|&
literal|0x7
expr_stmt|;
block|}
comment|/* Initialize corner cal (thermal tx gain adjust parameters) */
name|ee
operator|->
name|ee_cornerCal
operator|.
name|clip
operator|=
literal|4
expr_stmt|;
name|ee
operator|->
name|ee_cornerCal
operator|.
name|pd90
operator|=
literal|1
expr_stmt|;
name|ee
operator|->
name|ee_cornerCal
operator|.
name|pd84
operator|=
literal|1
expr_stmt|;
name|ee
operator|->
name|ee_cornerCal
operator|.
name|gSel
operator|=
literal|0
expr_stmt|;
comment|/* 	* Read the conformance test limit identifiers 	* These are used to match regulatory domain testing needs with 	* the RD-specific tests that have been calibrated in the EEPROM. 	*/
name|off
operator|=
name|header
index|[
literal|5
index|]
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|ee
operator|->
name|ee_numCtls
condition|;
name|i
operator|+=
literal|2
control|)
block|{
name|EEREAD
argument_list|(
name|off
operator|++
argument_list|)
expr_stmt|;
name|ee
operator|->
name|ee_ctl
index|[
name|i
index|]
operator|=
operator|(
name|eeval
operator|>>
literal|8
operator|)
operator|&
literal|0xff
expr_stmt|;
name|ee
operator|->
name|ee_ctl
index|[
name|i
operator|+
literal|1
index|]
operator|=
name|eeval
operator|&
literal|0xff
expr_stmt|;
block|}
if|if
condition|(
name|ee
operator|->
name|ee_version
operator|<
name|AR_EEPROM_VER5_3
condition|)
block|{
comment|/* XXX only for 5413? */
name|ee
operator|->
name|ee_spurChans
index|[
literal|0
index|]
index|[
literal|1
index|]
operator|=
name|AR_SPUR_5413_1
expr_stmt|;
name|ee
operator|->
name|ee_spurChans
index|[
literal|1
index|]
index|[
literal|1
index|]
operator|=
name|AR_SPUR_5413_2
expr_stmt|;
name|ee
operator|->
name|ee_spurChans
index|[
literal|2
index|]
index|[
literal|1
index|]
operator|=
name|AR_NO_SPUR
expr_stmt|;
name|ee
operator|->
name|ee_spurChans
index|[
literal|0
index|]
index|[
literal|0
index|]
operator|=
name|AR_NO_SPUR
expr_stmt|;
block|}
else|else
block|{
comment|/* Read spur mitigation data */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|AR_EEPROM_MODAL_SPURS
condition|;
name|i
operator|++
control|)
block|{
name|EEREAD
argument_list|(
name|off
argument_list|)
expr_stmt|;
name|ee
operator|->
name|ee_spurChans
index|[
name|i
index|]
index|[
literal|0
index|]
operator|=
name|eeval
expr_stmt|;
name|EEREAD
argument_list|(
name|off
operator|+
name|AR_EEPROM_MODAL_SPURS
argument_list|)
expr_stmt|;
name|ee
operator|->
name|ee_spurChans
index|[
name|i
index|]
index|[
literal|1
index|]
operator|=
name|eeval
expr_stmt|;
name|off
operator|++
expr_stmt|;
block|}
block|}
comment|/* for recent changes to NF scale */
if|if
condition|(
name|ee
operator|->
name|ee_version
operator|<=
name|AR_EEPROM_VER3_2
condition|)
block|{
name|ee
operator|->
name|ee_noiseFloorThresh
index|[
name|headerInfo11A
index|]
operator|=
operator|-
literal|54
expr_stmt|;
name|ee
operator|->
name|ee_noiseFloorThresh
index|[
name|headerInfo11B
index|]
operator|=
operator|-
literal|1
expr_stmt|;
name|ee
operator|->
name|ee_noiseFloorThresh
index|[
name|headerInfo11G
index|]
operator|=
operator|-
literal|1
expr_stmt|;
block|}
comment|/* to override thresh62 for better 2.4 and 5 operation */
if|if
condition|(
name|ee
operator|->
name|ee_version
operator|<=
name|AR_EEPROM_VER3_2
condition|)
block|{
name|ee
operator|->
name|ee_thresh62
index|[
name|headerInfo11A
index|]
operator|=
literal|15
expr_stmt|;
comment|/* 11A */
name|ee
operator|->
name|ee_thresh62
index|[
name|headerInfo11B
index|]
operator|=
literal|28
expr_stmt|;
comment|/* 11B */
name|ee
operator|->
name|ee_thresh62
index|[
name|headerInfo11G
index|]
operator|=
literal|28
expr_stmt|;
comment|/* 11G */
block|}
comment|/* Check for regulatory capabilities */
if|if
condition|(
name|ee
operator|->
name|ee_version
operator|>=
name|AR_EEPROM_VER4_0
condition|)
block|{
name|EEREAD
argument_list|(
name|regCapOffsetPost4_0
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|EEREAD
argument_list|(
name|regCapOffsetPre4_0
argument_list|)
expr_stmt|;
block|}
name|ee
operator|->
name|ee_regCap
operator|=
name|eeval
expr_stmt|;
if|if
condition|(
name|ee
operator|->
name|ee_Amode
operator|==
literal|0
condition|)
block|{
comment|/* Check for valid Amode in upgraded h/w */
if|if
condition|(
name|ee
operator|->
name|ee_version
operator|>=
name|AR_EEPROM_VER4_0
condition|)
block|{
name|ee
operator|->
name|ee_Amode
operator|=
operator|(
name|ee
operator|->
name|ee_regCap
operator|&
name|AR_EEPROM_EEREGCAP_EN_KK_NEW_11A
operator|)
condition|?
literal|1
else|:
literal|0
expr_stmt|;
block|}
else|else
block|{
name|ee
operator|->
name|ee_Amode
operator|=
operator|(
name|ee
operator|->
name|ee_regCap
operator|&
name|AR_EEPROM_EEREGCAP_EN_KK_NEW_11A_PRE4_0
operator|)
condition|?
literal|1
else|:
literal|0
expr_stmt|;
block|}
block|}
if|if
condition|(
name|ee
operator|->
name|ee_version
operator|>=
name|AR_EEPROM_VER5_1
condition|)
name|EEREAD
argument_list|(
name|AR_EEPROM_CAPABILITIES_OFFSET
argument_list|)
expr_stmt|;
else|else
name|eeval
operator|=
literal|0
expr_stmt|;
name|ee
operator|->
name|ee_opCap
operator|=
name|eeval
expr_stmt|;
name|EEREAD
argument_list|(
name|AR_EEPROM_REG_DOMAIN
argument_list|)
expr_stmt|;
name|ee
operator|->
name|ee_regdomain
operator|=
name|eeval
expr_stmt|;
return|return
name|AH_TRUE
return|;
undef|#
directive|undef
name|EEREAD
block|}
end_function

begin_comment
comment|/*  * Now verify and copy EEPROM contents into the allocated space  */
end_comment

begin_function
specifier|static
name|HAL_BOOL
name|legacyEepromReadContents
parameter_list|(
name|struct
name|ath_hal
modifier|*
name|ah
parameter_list|,
name|HAL_EEPROM
modifier|*
name|ee
parameter_list|)
block|{
comment|/* Read the header information here */
if|if
condition|(
operator|!
name|readHeaderInfo
argument_list|(
name|ah
argument_list|,
name|ee
argument_list|)
condition|)
return|return
name|AH_FALSE
return|;
if|#
directive|if
literal|0
comment|/* Require 5112 devices to have EEPROM 4.0 EEP_MAP set */
block|if (IS_5112(ah)&& !ee->ee_eepMap) { 		HALDEBUG(ah, HAL_DEBUG_ANY, 		    "%s: 5112 devices must have EEPROM 4.0 with the " 		    "EEP_MAP set\n", __func__); 		return AH_FALSE; 	}
endif|#
directive|endif
comment|/* 	 * Group 1: frequency pier locations readback 	 * check that the structure has been populated 	 * with enough space to hold the channels 	 * 	 * NOTE: Group 1 contains the 5 GHz channel numbers 	 *	 that have dBm->pcdac calibrated information. 	 */
if|if
condition|(
operator|!
name|readEepromFreqPierInfo
argument_list|(
name|ah
argument_list|,
name|ee
argument_list|)
condition|)
return|return
name|AH_FALSE
return|;
comment|/* 	 * Group 2:  readback data for all frequency piers 	 * 	 * NOTE: Group 2 contains the raw power calibration 	 *	 information for each of the channels that we 	 *	 recorded above. 	 */
if|if
condition|(
operator|!
name|readEepromRawPowerCalInfo
argument_list|(
name|ah
argument_list|,
name|ee
argument_list|)
condition|)
return|return
name|AH_FALSE
return|;
comment|/* 	 * Group 5: target power values per rate 	 * 	 * NOTE: Group 5 contains the recorded maximum power 	 *	 in dB that can be attained for the given rate. 	 */
comment|/* Read the power per rate info for test channels */
if|if
condition|(
operator|!
name|readEepromTargetPowerCalInfo
argument_list|(
name|ah
argument_list|,
name|ee
argument_list|)
condition|)
return|return
name|AH_FALSE
return|;
comment|/* 	 * Group 8: Conformance Test Limits information 	 * 	 * NOTE: Group 8 contains the values to limit the 	 *	 maximum transmit power value based on any 	 *	 band edge violations. 	 */
comment|/* Read the RD edge power limits */
return|return
name|readEepromCTLInfo
argument_list|(
name|ah
argument_list|,
name|ee
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|HAL_STATUS
name|legacyEepromGet
parameter_list|(
name|struct
name|ath_hal
modifier|*
name|ah
parameter_list|,
name|int
name|param
parameter_list|,
name|void
modifier|*
name|val
parameter_list|)
block|{
name|HAL_EEPROM
modifier|*
name|ee
init|=
name|AH_PRIVATE
argument_list|(
name|ah
argument_list|)
operator|->
name|ah_eeprom
decl_stmt|;
name|uint8_t
modifier|*
name|macaddr
decl_stmt|;
name|uint16_t
name|eeval
decl_stmt|;
name|uint32_t
name|sum
decl_stmt|;
name|int
name|i
decl_stmt|;
switch|switch
condition|(
name|param
condition|)
block|{
case|case
name|AR_EEP_OPCAP
case|:
operator|*
operator|(
name|uint16_t
operator|*
operator|)
name|val
operator|=
name|ee
operator|->
name|ee_opCap
expr_stmt|;
return|return
name|HAL_OK
return|;
case|case
name|AR_EEP_REGDMN_0
case|:
operator|*
operator|(
name|uint16_t
operator|*
operator|)
name|val
operator|=
name|ee
operator|->
name|ee_regdomain
expr_stmt|;
return|return
name|HAL_OK
return|;
case|case
name|AR_EEP_RFSILENT
case|:
if|if
condition|(
operator|!
name|ath_hal_eepromRead
argument_list|(
name|ah
argument_list|,
name|AR_EEPROM_RFSILENT
argument_list|,
operator|&
name|eeval
argument_list|)
condition|)
return|return
name|HAL_EEREAD
return|;
operator|*
operator|(
name|uint16_t
operator|*
operator|)
name|val
operator|=
name|eeval
expr_stmt|;
return|return
name|HAL_OK
return|;
case|case
name|AR_EEP_MACADDR
case|:
name|sum
operator|=
literal|0
expr_stmt|;
name|macaddr
operator|=
name|val
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|3
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
operator|!
name|ath_hal_eepromRead
argument_list|(
name|ah
argument_list|,
name|AR_EEPROM_MAC
argument_list|(
literal|2
operator|-
name|i
argument_list|)
argument_list|,
operator|&
name|eeval
argument_list|)
condition|)
block|{
name|HALDEBUG
argument_list|(
name|ah
argument_list|,
name|HAL_DEBUG_ANY
argument_list|,
literal|"%s: cannot read EEPROM location %u\n"
argument_list|,
name|__func__
argument_list|,
name|i
argument_list|)
expr_stmt|;
return|return
name|HAL_EEREAD
return|;
block|}
name|sum
operator|+=
name|eeval
expr_stmt|;
name|macaddr
index|[
literal|2
operator|*
name|i
index|]
operator|=
name|eeval
operator|>>
literal|8
expr_stmt|;
name|macaddr
index|[
literal|2
operator|*
name|i
operator|+
literal|1
index|]
operator|=
name|eeval
operator|&
literal|0xff
expr_stmt|;
block|}
if|if
condition|(
name|sum
operator|==
literal|0
operator|||
name|sum
operator|==
literal|0xffff
operator|*
literal|3
condition|)
block|{
name|HALDEBUG
argument_list|(
name|ah
argument_list|,
name|HAL_DEBUG_ANY
argument_list|,
literal|"%s: mac address read failed: %s\n"
argument_list|,
name|__func__
argument_list|,
name|ath_hal_ether_sprintf
argument_list|(
name|macaddr
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|HAL_EEBADMAC
return|;
block|}
return|return
name|HAL_OK
return|;
case|case
name|AR_EEP_RFKILL
case|:
name|HALASSERT
argument_list|(
name|val
operator|==
name|AH_NULL
argument_list|)
expr_stmt|;
return|return
name|ee
operator|->
name|ee_rfKill
condition|?
name|HAL_OK
else|:
name|HAL_EIO
return|;
case|case
name|AR_EEP_AMODE
case|:
name|HALASSERT
argument_list|(
name|val
operator|==
name|AH_NULL
argument_list|)
expr_stmt|;
return|return
name|ee
operator|->
name|ee_Amode
condition|?
name|HAL_OK
else|:
name|HAL_EIO
return|;
case|case
name|AR_EEP_BMODE
case|:
name|HALASSERT
argument_list|(
name|val
operator|==
name|AH_NULL
argument_list|)
expr_stmt|;
return|return
name|ee
operator|->
name|ee_Bmode
condition|?
name|HAL_OK
else|:
name|HAL_EIO
return|;
case|case
name|AR_EEP_GMODE
case|:
name|HALASSERT
argument_list|(
name|val
operator|==
name|AH_NULL
argument_list|)
expr_stmt|;
return|return
name|ee
operator|->
name|ee_Gmode
condition|?
name|HAL_OK
else|:
name|HAL_EIO
return|;
case|case
name|AR_EEP_TURBO5DISABLE
case|:
name|HALASSERT
argument_list|(
name|val
operator|==
name|AH_NULL
argument_list|)
expr_stmt|;
return|return
name|ee
operator|->
name|ee_turbo5Disable
condition|?
name|HAL_OK
else|:
name|HAL_EIO
return|;
case|case
name|AR_EEP_TURBO2DISABLE
case|:
name|HALASSERT
argument_list|(
name|val
operator|==
name|AH_NULL
argument_list|)
expr_stmt|;
return|return
name|ee
operator|->
name|ee_turbo2Disable
condition|?
name|HAL_OK
else|:
name|HAL_EIO
return|;
case|case
name|AR_EEP_ISTALON
case|:
comment|/* Talon detect */
name|HALASSERT
argument_list|(
name|val
operator|==
name|AH_NULL
argument_list|)
expr_stmt|;
return|return
operator|(
name|ee
operator|->
name|ee_version
operator|>=
name|AR_EEPROM_VER5_4
operator|&&
name|ath_hal_eepromRead
argument_list|(
name|ah
argument_list|,
literal|0x0b
argument_list|,
operator|&
name|eeval
argument_list|)
operator|&&
name|eeval
operator|==
literal|1
operator|)
condition|?
name|HAL_OK
else|:
name|HAL_EIO
return|;
case|case
name|AR_EEP_32KHZCRYSTAL
case|:
name|HALASSERT
argument_list|(
name|val
operator|==
name|AH_NULL
argument_list|)
expr_stmt|;
return|return
name|ee
operator|->
name|ee_exist32kHzCrystal
condition|?
name|HAL_OK
else|:
name|HAL_EIO
return|;
case|case
name|AR_EEP_COMPRESS
case|:
name|HALASSERT
argument_list|(
name|val
operator|==
name|AH_NULL
argument_list|)
expr_stmt|;
return|return
operator|(
name|ee
operator|->
name|ee_opCap
operator|&
name|AR_EEPROM_EEPCAP_COMPRESS_DIS
operator|)
operator|==
literal|0
condition|?
name|HAL_OK
else|:
name|HAL_EIO
return|;
case|case
name|AR_EEP_FASTFRAME
case|:
name|HALASSERT
argument_list|(
name|val
operator|==
name|AH_NULL
argument_list|)
expr_stmt|;
return|return
operator|(
name|ee
operator|->
name|ee_opCap
operator|&
name|AR_EEPROM_EEPCAP_FASTFRAME_DIS
operator|)
operator|==
literal|0
condition|?
name|HAL_OK
else|:
name|HAL_EIO
return|;
case|case
name|AR_EEP_AES
case|:
name|HALASSERT
argument_list|(
name|val
operator|==
name|AH_NULL
argument_list|)
expr_stmt|;
return|return
operator|(
name|ee
operator|->
name|ee_opCap
operator|&
name|AR_EEPROM_EEPCAP_AES_DIS
operator|)
operator|==
literal|0
condition|?
name|HAL_OK
else|:
name|HAL_EIO
return|;
case|case
name|AR_EEP_BURST
case|:
name|HALASSERT
argument_list|(
name|val
operator|==
name|AH_NULL
argument_list|)
expr_stmt|;
return|return
operator|(
name|ee
operator|->
name|ee_opCap
operator|&
name|AR_EEPROM_EEPCAP_BURST_DIS
operator|)
operator|==
literal|0
condition|?
name|HAL_OK
else|:
name|HAL_EIO
return|;
case|case
name|AR_EEP_MAXQCU
case|:
if|if
condition|(
name|ee
operator|->
name|ee_opCap
operator|&
name|AR_EEPROM_EEPCAP_MAXQCU
condition|)
block|{
operator|*
operator|(
name|uint16_t
operator|*
operator|)
name|val
operator|=
name|MS
argument_list|(
name|ee
operator|->
name|ee_opCap
argument_list|,
name|AR_EEPROM_EEPCAP_MAXQCU
argument_list|)
expr_stmt|;
return|return
name|HAL_OK
return|;
block|}
else|else
return|return
name|HAL_EIO
return|;
case|case
name|AR_EEP_KCENTRIES
case|:
if|if
condition|(
name|ee
operator|->
name|ee_opCap
operator|&
name|AR_EEPROM_EEPCAP_KC_ENTRIES
condition|)
block|{
operator|*
operator|(
name|uint16_t
operator|*
operator|)
name|val
operator|=
literal|1
operator|<<
name|MS
argument_list|(
name|ee
operator|->
name|ee_opCap
argument_list|,
name|AR_EEPROM_EEPCAP_KC_ENTRIES
argument_list|)
expr_stmt|;
return|return
name|HAL_OK
return|;
block|}
else|else
return|return
name|HAL_EIO
return|;
case|case
name|AR_EEP_ANTGAINMAX_5
case|:
operator|*
operator|(
name|int8_t
operator|*
operator|)
name|val
operator|=
name|ee
operator|->
name|ee_antennaGainMax
index|[
literal|0
index|]
expr_stmt|;
return|return
name|HAL_OK
return|;
case|case
name|AR_EEP_ANTGAINMAX_2
case|:
operator|*
operator|(
name|int8_t
operator|*
operator|)
name|val
operator|=
name|ee
operator|->
name|ee_antennaGainMax
index|[
literal|1
index|]
expr_stmt|;
return|return
name|HAL_OK
return|;
case|case
name|AR_EEP_WRITEPROTECT
case|:
name|HALASSERT
argument_list|(
name|val
operator|==
name|AH_NULL
argument_list|)
expr_stmt|;
return|return
operator|(
name|ee
operator|->
name|ee_protect
operator|&
name|AR_EEPROM_PROTECT_WP_128_191
operator|)
condition|?
name|HAL_OK
else|:
name|HAL_EIO
return|;
block|}
return|return
name|HAL_EINVAL
return|;
block|}
end_function

begin_function
specifier|static
name|HAL_BOOL
name|legacyEepromSet
parameter_list|(
name|struct
name|ath_hal
modifier|*
name|ah
parameter_list|,
name|int
name|param
parameter_list|,
name|int
name|v
parameter_list|)
block|{
name|HAL_EEPROM
modifier|*
name|ee
init|=
name|AH_PRIVATE
argument_list|(
name|ah
argument_list|)
operator|->
name|ah_eeprom
decl_stmt|;
switch|switch
condition|(
name|param
condition|)
block|{
case|case
name|AR_EEP_AMODE
case|:
name|ee
operator|->
name|ee_Amode
operator|=
name|v
expr_stmt|;
return|return
name|HAL_OK
return|;
case|case
name|AR_EEP_BMODE
case|:
name|ee
operator|->
name|ee_Bmode
operator|=
name|v
expr_stmt|;
return|return
name|HAL_OK
return|;
case|case
name|AR_EEP_GMODE
case|:
name|ee
operator|->
name|ee_Gmode
operator|=
name|v
expr_stmt|;
return|return
name|HAL_OK
return|;
case|case
name|AR_EEP_TURBO5DISABLE
case|:
name|ee
operator|->
name|ee_turbo5Disable
operator|=
name|v
expr_stmt|;
return|return
name|HAL_OK
return|;
case|case
name|AR_EEP_TURBO2DISABLE
case|:
name|ee
operator|->
name|ee_turbo2Disable
operator|=
name|v
expr_stmt|;
return|return
name|HAL_OK
return|;
case|case
name|AR_EEP_COMPRESS
case|:
if|if
condition|(
name|v
condition|)
name|ee
operator|->
name|ee_opCap
operator|&=
operator|~
name|AR_EEPROM_EEPCAP_COMPRESS_DIS
expr_stmt|;
else|else
name|ee
operator|->
name|ee_opCap
operator||=
name|AR_EEPROM_EEPCAP_COMPRESS_DIS
expr_stmt|;
return|return
name|HAL_OK
return|;
case|case
name|AR_EEP_FASTFRAME
case|:
if|if
condition|(
name|v
condition|)
name|ee
operator|->
name|ee_opCap
operator|&=
operator|~
name|AR_EEPROM_EEPCAP_FASTFRAME_DIS
expr_stmt|;
else|else
name|ee
operator|->
name|ee_opCap
operator||=
name|AR_EEPROM_EEPCAP_FASTFRAME_DIS
expr_stmt|;
return|return
name|HAL_OK
return|;
case|case
name|AR_EEP_AES
case|:
if|if
condition|(
name|v
condition|)
name|ee
operator|->
name|ee_opCap
operator|&=
operator|~
name|AR_EEPROM_EEPCAP_AES_DIS
expr_stmt|;
else|else
name|ee
operator|->
name|ee_opCap
operator||=
name|AR_EEPROM_EEPCAP_AES_DIS
expr_stmt|;
return|return
name|HAL_OK
return|;
case|case
name|AR_EEP_BURST
case|:
if|if
condition|(
name|v
condition|)
name|ee
operator|->
name|ee_opCap
operator|&=
operator|~
name|AR_EEPROM_EEPCAP_BURST_DIS
expr_stmt|;
else|else
name|ee
operator|->
name|ee_opCap
operator||=
name|AR_EEPROM_EEPCAP_BURST_DIS
expr_stmt|;
return|return
name|HAL_OK
return|;
block|}
return|return
name|HAL_EINVAL
return|;
block|}
end_function

begin_function
specifier|static
name|HAL_BOOL
name|legacyEepromDiag
parameter_list|(
name|struct
name|ath_hal
modifier|*
name|ah
parameter_list|,
name|int
name|request
parameter_list|,
specifier|const
name|void
modifier|*
name|args
parameter_list|,
name|uint32_t
name|argsize
parameter_list|,
name|void
modifier|*
modifier|*
name|result
parameter_list|,
name|uint32_t
modifier|*
name|resultsize
parameter_list|)
block|{
name|HAL_EEPROM
modifier|*
name|ee
init|=
name|AH_PRIVATE
argument_list|(
name|ah
argument_list|)
operator|->
name|ah_eeprom
decl_stmt|;
specifier|const
name|EEPROM_POWER_EXPN_5112
modifier|*
name|pe
decl_stmt|;
switch|switch
condition|(
name|request
condition|)
block|{
case|case
name|HAL_DIAG_EEPROM
case|:
operator|*
name|result
operator|=
name|ee
expr_stmt|;
operator|*
name|resultsize
operator|=
sizeof|sizeof
argument_list|(
operator|*
name|ee
argument_list|)
expr_stmt|;
return|return
name|AH_TRUE
return|;
case|case
name|HAL_DIAG_EEPROM_EXP_11A
case|:
case|case
name|HAL_DIAG_EEPROM_EXP_11B
case|:
case|case
name|HAL_DIAG_EEPROM_EXP_11G
case|:
name|pe
operator|=
operator|&
name|ee
operator|->
name|ee_modePowerArray5112
index|[
name|request
operator|-
name|HAL_DIAG_EEPROM_EXP_11A
index|]
expr_stmt|;
operator|*
name|result
operator|=
name|pe
operator|->
name|pChannels
expr_stmt|;
operator|*
name|resultsize
operator|=
operator|(
operator|*
name|result
operator|==
name|AH_NULL
operator|)
condition|?
literal|0
else|:
name|roundup
argument_list|(
sizeof|sizeof
argument_list|(
name|uint16_t
argument_list|)
operator|*
name|pe
operator|->
name|numChannels
argument_list|,
sizeof|sizeof
argument_list|(
name|uint32_t
argument_list|)
argument_list|)
operator|+
sizeof|sizeof
argument_list|(
name|EXPN_DATA_PER_CHANNEL_5112
argument_list|)
operator|*
name|pe
operator|->
name|numChannels
expr_stmt|;
return|return
name|AH_TRUE
return|;
block|}
return|return
name|AH_FALSE
return|;
block|}
end_function

begin_function
specifier|static
name|uint16_t
name|legacyEepromGetSpurChan
parameter_list|(
name|struct
name|ath_hal
modifier|*
name|ah
parameter_list|,
name|int
name|ix
parameter_list|,
name|HAL_BOOL
name|is2GHz
parameter_list|)
block|{
name|HAL_EEPROM
modifier|*
name|ee
init|=
name|AH_PRIVATE
argument_list|(
name|ah
argument_list|)
operator|->
name|ah_eeprom
decl_stmt|;
name|HALASSERT
argument_list|(
literal|0
operator|<=
name|ix
operator|&&
name|ix
operator|<
name|AR_EEPROM_MODAL_SPURS
argument_list|)
expr_stmt|;
return|return
name|ee
operator|->
name|ee_spurChans
index|[
name|ix
index|]
index|[
name|is2GHz
index|]
return|;
block|}
end_function

begin_comment
comment|/*  * Reclaim any EEPROM-related storage.  */
end_comment

begin_function
specifier|static
name|void
name|legacyEepromDetach
parameter_list|(
name|struct
name|ath_hal
modifier|*
name|ah
parameter_list|)
block|{
name|HAL_EEPROM
modifier|*
name|ee
init|=
name|AH_PRIVATE
argument_list|(
name|ah
argument_list|)
operator|->
name|ah_eeprom
decl_stmt|;
if|if
condition|(
name|ee
operator|->
name|ee_version
operator|>=
name|AR_EEPROM_VER4_0
operator|&&
name|ee
operator|->
name|ee_eepMap
operator|==
literal|1
condition|)
return|return
name|freeEepromRawPowerCalInfo5112
argument_list|(
name|ah
argument_list|,
name|ee
argument_list|)
return|;
name|ath_hal_free
argument_list|(
name|ee
argument_list|)
expr_stmt|;
name|AH_PRIVATE
argument_list|(
name|ah
argument_list|)
operator|->
name|ah_eeprom
operator|=
name|AH_NULL
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * These are not valid 2.4 channels, either we change 'em  * or we need to change the coding to accept them.  */
end_comment

begin_decl_stmt
specifier|static
specifier|const
name|uint16_t
name|channels11b
index|[]
init|=
block|{
literal|2412
block|,
literal|2447
block|,
literal|2484
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
specifier|const
name|uint16_t
name|channels11g
index|[]
init|=
block|{
literal|2312
block|,
literal|2412
block|,
literal|2484
block|}
decl_stmt|;
end_decl_stmt

begin_function
name|HAL_STATUS
name|ath_hal_legacyEepromAttach
parameter_list|(
name|struct
name|ath_hal
modifier|*
name|ah
parameter_list|)
block|{
name|HAL_EEPROM
modifier|*
name|ee
init|=
name|AH_PRIVATE
argument_list|(
name|ah
argument_list|)
operator|->
name|ah_eeprom
decl_stmt|;
name|uint32_t
name|sum
decl_stmt|,
name|eepMax
decl_stmt|;
name|uint16_t
name|eeversion
decl_stmt|,
name|eeprotect
decl_stmt|,
name|eeval
decl_stmt|;
name|u_int
name|i
decl_stmt|;
name|HALASSERT
argument_list|(
name|ee
operator|==
name|AH_NULL
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|ath_hal_eepromRead
argument_list|(
name|ah
argument_list|,
name|AR_EEPROM_VERSION
argument_list|,
operator|&
name|eeversion
argument_list|)
condition|)
block|{
name|HALDEBUG
argument_list|(
name|ah
argument_list|,
name|HAL_DEBUG_ANY
argument_list|,
literal|"%s: unable to read EEPROM version\n"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
return|return
name|HAL_EEREAD
return|;
block|}
if|if
condition|(
name|eeversion
operator|<
name|AR_EEPROM_VER3
condition|)
block|{
name|HALDEBUG
argument_list|(
name|ah
argument_list|,
name|HAL_DEBUG_ANY
argument_list|,
literal|"%s: unsupported EEPROM version "
literal|"%u (0x%x) found\n"
argument_list|,
name|__func__
argument_list|,
name|eeversion
argument_list|,
name|eeversion
argument_list|)
expr_stmt|;
return|return
name|HAL_EEVERSION
return|;
block|}
if|if
condition|(
operator|!
name|ath_hal_eepromRead
argument_list|(
name|ah
argument_list|,
name|AR_EEPROM_PROTECT
argument_list|,
operator|&
name|eeprotect
argument_list|)
condition|)
block|{
name|HALDEBUG
argument_list|(
name|ah
argument_list|,
name|HAL_DEBUG_ANY
argument_list|,
literal|"%s: cannot read EEPROM protection "
literal|"bits; read locked?\n"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
return|return
name|HAL_EEREAD
return|;
block|}
name|HALDEBUG
argument_list|(
name|ah
argument_list|,
name|HAL_DEBUG_ATTACH
argument_list|,
literal|"EEPROM protect 0x%x\n"
argument_list|,
name|eeprotect
argument_list|)
expr_stmt|;
comment|/* XXX check proper access before continuing */
comment|/* 	 * Read the Atheros EEPROM entries and calculate the checksum. 	 */
if|if
condition|(
operator|!
name|ath_hal_eepromRead
argument_list|(
name|ah
argument_list|,
name|AR_EEPROM_SIZE_UPPER
argument_list|,
operator|&
name|eeval
argument_list|)
condition|)
block|{
name|HALDEBUG
argument_list|(
name|ah
argument_list|,
name|HAL_DEBUG_ANY
argument_list|,
literal|"%s: cannot read EEPROM upper size\n"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
return|return
name|HAL_EEREAD
return|;
block|}
if|if
condition|(
name|eeval
operator|!=
literal|0
condition|)
block|{
name|eepMax
operator|=
operator|(
name|eeval
operator|&
name|AR_EEPROM_SIZE_UPPER_MASK
operator|)
operator|<<
name|AR_EEPROM_SIZE_ENDLOC_SHIFT
expr_stmt|;
if|if
condition|(
operator|!
name|ath_hal_eepromRead
argument_list|(
name|ah
argument_list|,
name|AR_EEPROM_SIZE_LOWER
argument_list|,
operator|&
name|eeval
argument_list|)
condition|)
block|{
name|HALDEBUG
argument_list|(
name|ah
argument_list|,
name|HAL_DEBUG_ANY
argument_list|,
literal|"%s: cannot read EEPROM lower size\n"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
return|return
name|HAL_EEREAD
return|;
block|}
name|eepMax
operator|=
operator|(
name|eepMax
operator||
name|eeval
operator|)
operator|-
name|AR_EEPROM_ATHEROS_BASE
expr_stmt|;
block|}
else|else
name|eepMax
operator|=
name|AR_EEPROM_ATHEROS_MAX
expr_stmt|;
name|sum
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|eepMax
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
operator|!
name|ath_hal_eepromRead
argument_list|(
name|ah
argument_list|,
name|AR_EEPROM_ATHEROS
argument_list|(
name|i
argument_list|)
argument_list|,
operator|&
name|eeval
argument_list|)
condition|)
block|{
return|return
name|HAL_EEREAD
return|;
block|}
name|sum
operator|^=
name|eeval
expr_stmt|;
block|}
if|if
condition|(
name|sum
operator|!=
literal|0xffff
condition|)
block|{
name|HALDEBUG
argument_list|(
name|ah
argument_list|,
name|HAL_DEBUG_ANY
argument_list|,
literal|"%s: bad EEPROM checksum 0x%x\n"
argument_list|,
name|__func__
argument_list|,
name|sum
argument_list|)
expr_stmt|;
return|return
name|HAL_EEBADSUM
return|;
block|}
name|ee
operator|=
name|ath_hal_malloc
argument_list|(
sizeof|sizeof
argument_list|(
name|HAL_EEPROM
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|ee
operator|==
name|AH_NULL
condition|)
block|{
comment|/* XXX message */
return|return
name|HAL_ENOMEM
return|;
block|}
name|ee
operator|->
name|ee_protect
operator|=
name|eeprotect
expr_stmt|;
name|ee
operator|->
name|ee_version
operator|=
name|eeversion
expr_stmt|;
name|ee
operator|->
name|ee_numChannels11a
operator|=
name|NUM_11A_EEPROM_CHANNELS
expr_stmt|;
name|ee
operator|->
name|ee_numChannels2_4
operator|=
name|NUM_2_4_EEPROM_CHANNELS
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|NUM_11A_EEPROM_CHANNELS
condition|;
name|i
operator|++
control|)
name|ee
operator|->
name|ee_dataPerChannel11a
index|[
name|i
index|]
operator|.
name|numPcdacValues
operator|=
name|NUM_PCDAC_VALUES
expr_stmt|;
comment|/* the channel list for 2.4 is fixed, fill this in here */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|NUM_2_4_EEPROM_CHANNELS
condition|;
name|i
operator|++
control|)
block|{
name|ee
operator|->
name|ee_channels11b
index|[
name|i
index|]
operator|=
name|channels11b
index|[
name|i
index|]
expr_stmt|;
comment|/* XXX 5211 requires a hack though we don't support 11g */
if|if
condition|(
name|ah
operator|->
name|ah_magic
operator|==
literal|0x19570405
condition|)
name|ee
operator|->
name|ee_channels11g
index|[
name|i
index|]
operator|=
name|channels11b
index|[
name|i
index|]
expr_stmt|;
else|else
name|ee
operator|->
name|ee_channels11g
index|[
name|i
index|]
operator|=
name|channels11g
index|[
name|i
index|]
expr_stmt|;
name|ee
operator|->
name|ee_dataPerChannel11b
index|[
name|i
index|]
operator|.
name|numPcdacValues
operator|=
name|NUM_PCDAC_VALUES
expr_stmt|;
name|ee
operator|->
name|ee_dataPerChannel11g
index|[
name|i
index|]
operator|.
name|numPcdacValues
operator|=
name|NUM_PCDAC_VALUES
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|legacyEepromReadContents
argument_list|(
name|ah
argument_list|,
name|ee
argument_list|)
condition|)
block|{
comment|/* XXX message */
name|ath_hal_free
argument_list|(
name|ee
argument_list|)
expr_stmt|;
return|return
name|HAL_EEREAD
return|;
comment|/* XXX */
block|}
name|AH_PRIVATE
argument_list|(
name|ah
argument_list|)
operator|->
name|ah_eeprom
operator|=
name|ee
expr_stmt|;
name|AH_PRIVATE
argument_list|(
name|ah
argument_list|)
operator|->
name|ah_eeversion
operator|=
name|eeversion
expr_stmt|;
name|AH_PRIVATE
argument_list|(
name|ah
argument_list|)
operator|->
name|ah_eepromDetach
operator|=
name|legacyEepromDetach
expr_stmt|;
name|AH_PRIVATE
argument_list|(
name|ah
argument_list|)
operator|->
name|ah_eepromGet
operator|=
name|legacyEepromGet
expr_stmt|;
name|AH_PRIVATE
argument_list|(
name|ah
argument_list|)
operator|->
name|ah_eepromSet
operator|=
name|legacyEepromSet
expr_stmt|;
name|AH_PRIVATE
argument_list|(
name|ah
argument_list|)
operator|->
name|ah_getSpurChan
operator|=
name|legacyEepromGetSpurChan
expr_stmt|;
name|AH_PRIVATE
argument_list|(
name|ah
argument_list|)
operator|->
name|ah_eepromDiag
operator|=
name|legacyEepromDiag
expr_stmt|;
return|return
name|HAL_OK
return|;
block|}
end_function

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Copyright (c) 2002-2008 Sam Leffler, Errno Consulting  * Copyright (c) 2002-2008 Atheros Communications, Inc.  *  * Permission to use, copy, modify, and/or distribute this software for any  * purpose with or without fee is hereby granted, provided that the above  * copyright notice and this permission notice appear in all copies.  *  * THE SOFTWARE IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL WARRANTIES  * WITH REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF  * MERCHANTABILITY AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR  * ANY SPECIAL, DIRECT, INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES  * WHATSOEVER RESULTING FROM LOSS OF USE, DATA OR PROFITS, WHETHER IN AN  * ACTION OF CONTRACT, NEGLIGENCE OR OTHER TORTIOUS ACTION, ARISING OUT OF  * OR IN CONNECTION WITH THE USE OR PERFORMANCE OF THIS SOFTWARE.  *  * $FreeBSD$  */
end_comment

begin_include
include|#
directive|include
file|"opt_ah.h"
end_include

begin_include
include|#
directive|include
file|"ah.h"
end_include

begin_include
include|#
directive|include
file|"ah_internal.h"
end_include

begin_include
include|#
directive|include
file|"ah_devid.h"
end_include

begin_include
include|#
directive|include
file|"ar5212/ar5212.h"
end_include

begin_include
include|#
directive|include
file|"ar5212/ar5212reg.h"
end_include

begin_include
include|#
directive|include
file|"ar5212/ar5212phy.h"
end_include

begin_include
include|#
directive|include
file|"ah_eeprom_v3.h"
end_include

begin_decl_stmt
specifier|static
specifier|const
name|GAIN_OPTIMIZATION_LADDER
name|gainLadder
init|=
block|{
literal|9
block|,
comment|/* numStepsInLadder */
literal|4
block|,
comment|/* defaultStepNum */
block|{
block|{
block|{
literal|4
block|,
literal|1
block|,
literal|1
block|,
literal|1
block|}
block|,
literal|6
block|,
literal|"FG8"
block|}
block|,
block|{
block|{
literal|4
block|,
literal|0
block|,
literal|1
block|,
literal|1
block|}
block|,
literal|4
block|,
literal|"FG7"
block|}
block|,
block|{
block|{
literal|3
block|,
literal|1
block|,
literal|1
block|,
literal|1
block|}
block|,
literal|3
block|,
literal|"FG6"
block|}
block|,
block|{
block|{
literal|4
block|,
literal|0
block|,
literal|0
block|,
literal|1
block|}
block|,
literal|1
block|,
literal|"FG5"
block|}
block|,
block|{
block|{
literal|4
block|,
literal|1
block|,
literal|1
block|,
literal|0
block|}
block|,
literal|0
block|,
literal|"FG4"
block|}
block|,
comment|/* noJack */
block|{
block|{
literal|4
block|,
literal|0
block|,
literal|1
block|,
literal|0
block|}
block|,
operator|-
literal|2
block|,
literal|"FG3"
block|}
block|,
comment|/* halfJack */
block|{
block|{
literal|3
block|,
literal|1
block|,
literal|1
block|,
literal|0
block|}
block|,
operator|-
literal|3
block|,
literal|"FG2"
block|}
block|,
comment|/* clip3 */
block|{
block|{
literal|4
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|}
block|,
operator|-
literal|4
block|,
literal|"FG1"
block|}
block|,
comment|/* noJack */
block|{
block|{
literal|2
block|,
literal|1
block|,
literal|1
block|,
literal|0
block|}
block|,
operator|-
literal|6
block|,
literal|"FG0"
block|}
comment|/* clip2 */
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
specifier|const
name|GAIN_OPTIMIZATION_LADDER
name|gainLadder5112
init|=
block|{
literal|8
block|,
comment|/* numStepsInLadder */
literal|1
block|,
comment|/* defaultStepNum */
block|{
block|{
block|{
literal|3
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|}
block|,
literal|6
block|,
literal|"FG7"
block|}
block|,
comment|/* most fixed gain */
block|{
block|{
literal|2
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|}
block|,
literal|0
block|,
literal|"FG6"
block|}
block|,
block|{
block|{
literal|1
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|}
block|,
operator|-
literal|3
block|,
literal|"FG5"
block|}
block|,
block|{
block|{
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|}
block|,
operator|-
literal|6
block|,
literal|"FG4"
block|}
block|,
block|{
block|{
literal|0
block|,
literal|1
block|,
literal|1
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|}
block|,
operator|-
literal|8
block|,
literal|"FG3"
block|}
block|,
block|{
block|{
literal|0
block|,
literal|1
block|,
literal|1
block|,
literal|0
block|,
literal|1
block|,
literal|1
block|,
literal|0
block|}
block|,
operator|-
literal|10
block|,
literal|"FG2"
block|}
block|,
block|{
block|{
literal|0
block|,
literal|1
block|,
literal|0
block|,
literal|1
block|,
literal|1
block|,
literal|1
block|,
literal|0
block|}
block|,
operator|-
literal|13
block|,
literal|"FG1"
block|}
block|,
block|{
block|{
literal|0
block|,
literal|1
block|,
literal|0
block|,
literal|1
block|,
literal|1
block|,
literal|0
block|,
literal|1
block|}
block|,
operator|-
literal|16
block|,
literal|"FG0"
block|}
block|,
comment|/* least fixed gain */
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_comment
comment|/*  * Initialize the gain structure to good values  */
end_comment

begin_function
name|void
name|ar5212InitializeGainValues
parameter_list|(
name|struct
name|ath_hal
modifier|*
name|ah
parameter_list|)
block|{
name|struct
name|ath_hal_5212
modifier|*
name|ahp
init|=
name|AH5212
argument_list|(
name|ah
argument_list|)
decl_stmt|;
name|GAIN_VALUES
modifier|*
name|gv
init|=
operator|&
name|ahp
operator|->
name|ah_gainValues
decl_stmt|;
comment|/* initialize gain optimization values */
if|if
condition|(
name|IS_RAD5112_ANY
argument_list|(
name|ah
argument_list|)
condition|)
block|{
name|gv
operator|->
name|currStepNum
operator|=
name|gainLadder5112
operator|.
name|defaultStepNum
expr_stmt|;
name|gv
operator|->
name|currStep
operator|=
operator|&
name|gainLadder5112
operator|.
name|optStep
index|[
name|gainLadder5112
operator|.
name|defaultStepNum
index|]
expr_stmt|;
name|gv
operator|->
name|active
operator|=
name|AH_TRUE
expr_stmt|;
name|gv
operator|->
name|loTrig
operator|=
literal|20
expr_stmt|;
name|gv
operator|->
name|hiTrig
operator|=
literal|85
expr_stmt|;
block|}
else|else
block|{
name|gv
operator|->
name|currStepNum
operator|=
name|gainLadder
operator|.
name|defaultStepNum
expr_stmt|;
name|gv
operator|->
name|currStep
operator|=
operator|&
name|gainLadder
operator|.
name|optStep
index|[
name|gainLadder
operator|.
name|defaultStepNum
index|]
expr_stmt|;
name|gv
operator|->
name|active
operator|=
name|AH_TRUE
expr_stmt|;
name|gv
operator|->
name|loTrig
operator|=
literal|20
expr_stmt|;
name|gv
operator|->
name|hiTrig
operator|=
literal|35
expr_stmt|;
block|}
block|}
end_function

begin_define
define|#
directive|define
name|MAX_ANALOG_START
value|319
end_define

begin_comment
comment|/* XXX */
end_comment

begin_comment
comment|/*  * Find analog bits of given parameter data and return a reversed value  */
end_comment

begin_function
specifier|static
name|uint32_t
name|ar5212GetRfField
parameter_list|(
name|uint32_t
modifier|*
name|rfBuf
parameter_list|,
name|uint32_t
name|numBits
parameter_list|,
name|uint32_t
name|firstBit
parameter_list|,
name|uint32_t
name|column
parameter_list|)
block|{
name|uint32_t
name|reg32
init|=
literal|0
decl_stmt|,
name|mask
decl_stmt|,
name|arrayEntry
decl_stmt|,
name|lastBit
decl_stmt|;
name|uint32_t
name|bitPosition
decl_stmt|,
name|bitsShifted
decl_stmt|;
name|int32_t
name|bitsLeft
decl_stmt|;
name|HALASSERT
argument_list|(
name|column
operator|<=
literal|3
argument_list|)
expr_stmt|;
name|HALASSERT
argument_list|(
name|numBits
operator|<=
literal|32
argument_list|)
expr_stmt|;
name|HALASSERT
argument_list|(
name|firstBit
operator|+
name|numBits
operator|<=
name|MAX_ANALOG_START
argument_list|)
expr_stmt|;
name|arrayEntry
operator|=
operator|(
name|firstBit
operator|-
literal|1
operator|)
operator|/
literal|8
expr_stmt|;
name|bitPosition
operator|=
operator|(
name|firstBit
operator|-
literal|1
operator|)
operator|%
literal|8
expr_stmt|;
name|bitsLeft
operator|=
name|numBits
expr_stmt|;
name|bitsShifted
operator|=
literal|0
expr_stmt|;
while|while
condition|(
name|bitsLeft
operator|>
literal|0
condition|)
block|{
name|lastBit
operator|=
operator|(
name|bitPosition
operator|+
name|bitsLeft
operator|>
literal|8
operator|)
condition|?
operator|(
literal|8
operator|)
else|:
operator|(
name|bitPosition
operator|+
name|bitsLeft
operator|)
expr_stmt|;
name|mask
operator|=
operator|(
operator|(
operator|(
literal|1
operator|<<
name|lastBit
operator|)
operator|-
literal|1
operator|)
operator|^
operator|(
operator|(
literal|1
operator|<<
name|bitPosition
operator|)
operator|-
literal|1
operator|)
operator|)
operator|<<
operator|(
name|column
operator|*
literal|8
operator|)
expr_stmt|;
name|reg32
operator||=
operator|(
operator|(
operator|(
name|rfBuf
index|[
name|arrayEntry
index|]
operator|&
name|mask
operator|)
operator|>>
operator|(
name|column
operator|*
literal|8
operator|)
operator|)
operator|>>
name|bitPosition
operator|)
operator|<<
name|bitsShifted
expr_stmt|;
name|bitsShifted
operator|+=
name|lastBit
operator|-
name|bitPosition
expr_stmt|;
name|bitsLeft
operator|-=
operator|(
literal|8
operator|-
name|bitPosition
operator|)
expr_stmt|;
name|bitPosition
operator|=
literal|0
expr_stmt|;
name|arrayEntry
operator|++
expr_stmt|;
block|}
name|reg32
operator|=
name|ath_hal_reverseBits
argument_list|(
name|reg32
argument_list|,
name|numBits
argument_list|)
expr_stmt|;
return|return
name|reg32
return|;
block|}
end_function

begin_function
specifier|static
name|HAL_BOOL
name|ar5212InvalidGainReadback
parameter_list|(
name|struct
name|ath_hal
modifier|*
name|ah
parameter_list|,
name|GAIN_VALUES
modifier|*
name|gv
parameter_list|)
block|{
name|uint32_t
name|gStep
decl_stmt|,
name|g
decl_stmt|,
name|mixOvr
decl_stmt|;
name|uint32_t
name|L1
decl_stmt|,
name|L2
decl_stmt|,
name|L3
decl_stmt|,
name|L4
decl_stmt|;
if|if
condition|(
name|IS_RAD5112_ANY
argument_list|(
name|ah
argument_list|)
condition|)
block|{
name|mixOvr
operator|=
name|ar5212GetRfField
argument_list|(
name|ar5212GetRfBank
argument_list|(
name|ah
argument_list|,
literal|7
argument_list|)
argument_list|,
literal|1
argument_list|,
literal|36
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|L1
operator|=
literal|0
expr_stmt|;
name|L2
operator|=
literal|107
expr_stmt|;
name|L3
operator|=
literal|0
expr_stmt|;
name|L4
operator|=
literal|107
expr_stmt|;
if|if
condition|(
name|mixOvr
operator|==
literal|1
condition|)
block|{
name|L2
operator|=
literal|83
expr_stmt|;
name|L4
operator|=
literal|83
expr_stmt|;
name|gv
operator|->
name|hiTrig
operator|=
literal|55
expr_stmt|;
block|}
block|}
else|else
block|{
name|gStep
operator|=
name|ar5212GetRfField
argument_list|(
name|ar5212GetRfBank
argument_list|(
name|ah
argument_list|,
literal|7
argument_list|)
argument_list|,
literal|6
argument_list|,
literal|37
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|L1
operator|=
literal|0
expr_stmt|;
name|L2
operator|=
operator|(
name|gStep
operator|==
literal|0x3f
operator|)
condition|?
literal|50
else|:
name|gStep
operator|+
literal|4
expr_stmt|;
name|L3
operator|=
operator|(
name|gStep
operator|!=
literal|0x3f
operator|)
condition|?
literal|0x40
else|:
name|L1
expr_stmt|;
name|L4
operator|=
name|L3
operator|+
literal|50
expr_stmt|;
name|gv
operator|->
name|loTrig
operator|=
name|L1
operator|+
operator|(
name|gStep
operator|==
literal|0x3f
condition|?
name|DYN_ADJ_LO_MARGIN
else|:
literal|0
operator|)
expr_stmt|;
comment|/* never adjust if != 0x3f */
name|gv
operator|->
name|hiTrig
operator|=
name|L4
operator|-
operator|(
name|gStep
operator|==
literal|0x3f
condition|?
name|DYN_ADJ_UP_MARGIN
else|:
operator|-
literal|5
operator|)
expr_stmt|;
block|}
name|g
operator|=
name|gv
operator|->
name|currGain
expr_stmt|;
return|return
operator|!
operator|(
operator|(
name|g
operator|>=
name|L1
operator|&&
name|g
operator|<=
name|L2
operator|)
operator|||
operator|(
name|g
operator|>=
name|L3
operator|&&
name|g
operator|<=
name|L4
operator|)
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Enable the probe gain check on the next packet  */
end_comment

begin_function
name|void
name|ar5212RequestRfgain
parameter_list|(
name|struct
name|ath_hal
modifier|*
name|ah
parameter_list|)
block|{
name|struct
name|ath_hal_5212
modifier|*
name|ahp
init|=
name|AH5212
argument_list|(
name|ah
argument_list|)
decl_stmt|;
name|uint32_t
name|probePowerIndex
decl_stmt|;
comment|/* Enable the gain readback probe */
name|probePowerIndex
operator|=
name|ahp
operator|->
name|ah_ofdmTxPower
operator|+
name|ahp
operator|->
name|ah_txPowerIndexOffset
expr_stmt|;
name|OS_REG_WRITE
argument_list|(
name|ah
argument_list|,
name|AR_PHY_PAPD_PROBE
argument_list|,
name|SM
argument_list|(
name|probePowerIndex
argument_list|,
name|AR_PHY_PAPD_PROBE_POWERTX
argument_list|)
operator||
name|AR_PHY_PAPD_PROBE_NEXT_TX
argument_list|)
expr_stmt|;
name|ahp
operator|->
name|ah_rfgainState
operator|=
name|HAL_RFGAIN_READ_REQUESTED
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * Check to see if our readback gain level sits within the linear  * region of our current variable attenuation window  */
end_comment

begin_function
specifier|static
name|HAL_BOOL
name|ar5212IsGainAdjustNeeded
parameter_list|(
name|struct
name|ath_hal
modifier|*
name|ah
parameter_list|,
specifier|const
name|GAIN_VALUES
modifier|*
name|gv
parameter_list|)
block|{
return|return
operator|(
name|gv
operator|->
name|currGain
operator|<=
name|gv
operator|->
name|loTrig
operator|||
name|gv
operator|->
name|currGain
operator|>=
name|gv
operator|->
name|hiTrig
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Move the rabbit ears in the correct direction.  */
end_comment

begin_function
specifier|static
name|int32_t
name|ar5212AdjustGain
parameter_list|(
name|struct
name|ath_hal
modifier|*
name|ah
parameter_list|,
name|GAIN_VALUES
modifier|*
name|gv
parameter_list|)
block|{
specifier|const
name|GAIN_OPTIMIZATION_LADDER
modifier|*
name|gl
decl_stmt|;
if|if
condition|(
name|IS_RAD5112_ANY
argument_list|(
name|ah
argument_list|)
condition|)
name|gl
operator|=
operator|&
name|gainLadder5112
expr_stmt|;
else|else
name|gl
operator|=
operator|&
name|gainLadder
expr_stmt|;
name|gv
operator|->
name|currStep
operator|=
operator|&
name|gl
operator|->
name|optStep
index|[
name|gv
operator|->
name|currStepNum
index|]
expr_stmt|;
if|if
condition|(
name|gv
operator|->
name|currGain
operator|>=
name|gv
operator|->
name|hiTrig
condition|)
block|{
if|if
condition|(
name|gv
operator|->
name|currStepNum
operator|==
literal|0
condition|)
block|{
name|HALDEBUG
argument_list|(
name|ah
argument_list|,
name|HAL_DEBUG_ANY
argument_list|,
literal|"%s: Max gain limit.\n"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|HALDEBUG
argument_list|(
name|ah
argument_list|,
name|HAL_DEBUG_RFPARAM
argument_list|,
literal|"%s: Adding gain: currG=%d [%s] --> "
argument_list|,
name|__func__
argument_list|,
name|gv
operator|->
name|currGain
argument_list|,
name|gv
operator|->
name|currStep
operator|->
name|stepName
argument_list|)
expr_stmt|;
name|gv
operator|->
name|targetGain
operator|=
name|gv
operator|->
name|currGain
expr_stmt|;
while|while
condition|(
name|gv
operator|->
name|targetGain
operator|>=
name|gv
operator|->
name|hiTrig
operator|&&
name|gv
operator|->
name|currStepNum
operator|>
literal|0
condition|)
block|{
name|gv
operator|->
name|targetGain
operator|-=
literal|2
operator|*
operator|(
name|gl
operator|->
name|optStep
index|[
operator|--
operator|(
name|gv
operator|->
name|currStepNum
operator|)
index|]
operator|.
name|stepGain
operator|-
name|gv
operator|->
name|currStep
operator|->
name|stepGain
operator|)
expr_stmt|;
name|gv
operator|->
name|currStep
operator|=
operator|&
name|gl
operator|->
name|optStep
index|[
name|gv
operator|->
name|currStepNum
index|]
expr_stmt|;
block|}
name|HALDEBUG
argument_list|(
name|ah
argument_list|,
name|HAL_DEBUG_RFPARAM
argument_list|,
literal|"targG=%d [%s]\n"
argument_list|,
name|gv
operator|->
name|targetGain
argument_list|,
name|gv
operator|->
name|currStep
operator|->
name|stepName
argument_list|)
expr_stmt|;
return|return
literal|1
return|;
block|}
if|if
condition|(
name|gv
operator|->
name|currGain
operator|<=
name|gv
operator|->
name|loTrig
condition|)
block|{
if|if
condition|(
name|gv
operator|->
name|currStepNum
operator|==
name|gl
operator|->
name|numStepsInLadder
operator|-
literal|1
condition|)
block|{
name|HALDEBUG
argument_list|(
name|ah
argument_list|,
name|HAL_DEBUG_RFPARAM
argument_list|,
literal|"%s: Min gain limit.\n"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
return|return
operator|-
literal|2
return|;
block|}
name|HALDEBUG
argument_list|(
name|ah
argument_list|,
name|HAL_DEBUG_RFPARAM
argument_list|,
literal|"%s: Deducting gain: currG=%d [%s] --> "
argument_list|,
name|__func__
argument_list|,
name|gv
operator|->
name|currGain
argument_list|,
name|gv
operator|->
name|currStep
operator|->
name|stepName
argument_list|)
expr_stmt|;
name|gv
operator|->
name|targetGain
operator|=
name|gv
operator|->
name|currGain
expr_stmt|;
while|while
condition|(
name|gv
operator|->
name|targetGain
operator|<=
name|gv
operator|->
name|loTrig
operator|&&
name|gv
operator|->
name|currStepNum
operator|<
operator|(
name|gl
operator|->
name|numStepsInLadder
operator|-
literal|1
operator|)
condition|)
block|{
name|gv
operator|->
name|targetGain
operator|-=
literal|2
operator|*
operator|(
name|gl
operator|->
name|optStep
index|[
operator|++
operator|(
name|gv
operator|->
name|currStepNum
operator|)
index|]
operator|.
name|stepGain
operator|-
name|gv
operator|->
name|currStep
operator|->
name|stepGain
operator|)
expr_stmt|;
name|gv
operator|->
name|currStep
operator|=
operator|&
name|gl
operator|->
name|optStep
index|[
name|gv
operator|->
name|currStepNum
index|]
expr_stmt|;
block|}
name|HALDEBUG
argument_list|(
name|ah
argument_list|,
name|HAL_DEBUG_RFPARAM
argument_list|,
literal|"targG=%d [%s]\n"
argument_list|,
name|gv
operator|->
name|targetGain
argument_list|,
name|gv
operator|->
name|currStep
operator|->
name|stepName
argument_list|)
expr_stmt|;
return|return
literal|2
return|;
block|}
return|return
literal|0
return|;
comment|/* caller didn't call needAdjGain first */
block|}
end_function

begin_comment
comment|/*  * Read rf register to determine if gainF needs correction  */
end_comment

begin_function
specifier|static
name|void
name|ar5212GetGainFCorrection
parameter_list|(
name|struct
name|ath_hal
modifier|*
name|ah
parameter_list|)
block|{
name|struct
name|ath_hal_5212
modifier|*
name|ahp
init|=
name|AH5212
argument_list|(
name|ah
argument_list|)
decl_stmt|;
name|GAIN_VALUES
modifier|*
name|gv
init|=
operator|&
name|ahp
operator|->
name|ah_gainValues
decl_stmt|;
name|HALASSERT
argument_list|(
name|IS_RADX112_REV2
argument_list|(
name|ah
argument_list|)
argument_list|)
expr_stmt|;
name|gv
operator|->
name|gainFCorrection
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|ar5212GetRfField
argument_list|(
name|ar5212GetRfBank
argument_list|(
name|ah
argument_list|,
literal|7
argument_list|)
argument_list|,
literal|1
argument_list|,
literal|36
argument_list|,
literal|0
argument_list|)
operator|==
literal|1
condition|)
block|{
name|uint32_t
name|mixGain
init|=
name|gv
operator|->
name|currStep
operator|->
name|paramVal
index|[
literal|0
index|]
decl_stmt|;
name|uint32_t
name|gainStep
init|=
name|ar5212GetRfField
argument_list|(
name|ar5212GetRfBank
argument_list|(
name|ah
argument_list|,
literal|7
argument_list|)
argument_list|,
literal|4
argument_list|,
literal|32
argument_list|,
literal|0
argument_list|)
decl_stmt|;
switch|switch
condition|(
name|mixGain
condition|)
block|{
case|case
literal|0
case|:
name|gv
operator|->
name|gainFCorrection
operator|=
literal|0
expr_stmt|;
break|break;
case|case
literal|1
case|:
name|gv
operator|->
name|gainFCorrection
operator|=
name|gainStep
expr_stmt|;
break|break;
case|case
literal|2
case|:
name|gv
operator|->
name|gainFCorrection
operator|=
literal|2
operator|*
name|gainStep
operator|-
literal|5
expr_stmt|;
break|break;
case|case
literal|3
case|:
name|gv
operator|->
name|gainFCorrection
operator|=
literal|2
operator|*
name|gainStep
expr_stmt|;
break|break;
block|}
block|}
block|}
end_function

begin_comment
comment|/*  * Exported call to check for a recent gain reading and return  * the current state of the thermal calibration gain engine.  */
end_comment

begin_function
name|HAL_RFGAIN
name|ar5212GetRfgain
parameter_list|(
name|struct
name|ath_hal
modifier|*
name|ah
parameter_list|)
block|{
name|struct
name|ath_hal_5212
modifier|*
name|ahp
init|=
name|AH5212
argument_list|(
name|ah
argument_list|)
decl_stmt|;
name|GAIN_VALUES
modifier|*
name|gv
init|=
operator|&
name|ahp
operator|->
name|ah_gainValues
decl_stmt|;
name|uint32_t
name|rddata
decl_stmt|,
name|probeType
decl_stmt|;
comment|/* NB: beware of touching the BB when PHY is powered down */
if|if
condition|(
operator|!
name|gv
operator|->
name|active
operator|||
operator|!
name|ahp
operator|->
name|ah_phyPowerOn
condition|)
return|return
name|HAL_RFGAIN_INACTIVE
return|;
if|if
condition|(
name|ahp
operator|->
name|ah_rfgainState
operator|==
name|HAL_RFGAIN_READ_REQUESTED
condition|)
block|{
comment|/* Caller had asked to setup a new reading. Check it. */
name|rddata
operator|=
name|OS_REG_READ
argument_list|(
name|ah
argument_list|,
name|AR_PHY_PAPD_PROBE
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|rddata
operator|&
name|AR_PHY_PAPD_PROBE_NEXT_TX
operator|)
operator|==
literal|0
condition|)
block|{
comment|/* bit got cleared, we have a new reading. */
name|gv
operator|->
name|currGain
operator|=
name|rddata
operator|>>
name|AR_PHY_PAPD_PROBE_GAINF_S
expr_stmt|;
name|probeType
operator|=
name|MS
argument_list|(
name|rddata
argument_list|,
name|AR_PHY_PAPD_PROBE_TYPE
argument_list|)
expr_stmt|;
if|if
condition|(
name|probeType
operator|==
name|AR_PHY_PAPD_PROBE_TYPE_CCK
condition|)
block|{
specifier|const
name|HAL_EEPROM
modifier|*
name|ee
init|=
name|AH_PRIVATE
argument_list|(
name|ah
argument_list|)
operator|->
name|ah_eeprom
decl_stmt|;
name|HALASSERT
argument_list|(
name|IS_RAD5112_ANY
argument_list|(
name|ah
argument_list|)
argument_list|)
expr_stmt|;
name|HALASSERT
argument_list|(
name|ah
operator|->
name|ah_magic
operator|==
name|AR5212_MAGIC
argument_list|)
expr_stmt|;
if|if
condition|(
name|AH_PRIVATE
argument_list|(
name|ah
argument_list|)
operator|->
name|ah_phyRev
operator|>=
name|AR_PHY_CHIP_ID_REV_2
condition|)
name|gv
operator|->
name|currGain
operator|+=
name|ee
operator|->
name|ee_cckOfdmGainDelta
expr_stmt|;
else|else
name|gv
operator|->
name|currGain
operator|+=
name|PHY_PROBE_CCK_CORRECTION
expr_stmt|;
block|}
if|if
condition|(
name|IS_RADX112_REV2
argument_list|(
name|ah
argument_list|)
condition|)
block|{
name|ar5212GetGainFCorrection
argument_list|(
name|ah
argument_list|)
expr_stmt|;
if|if
condition|(
name|gv
operator|->
name|currGain
operator|>=
name|gv
operator|->
name|gainFCorrection
condition|)
name|gv
operator|->
name|currGain
operator|-=
name|gv
operator|->
name|gainFCorrection
expr_stmt|;
else|else
name|gv
operator|->
name|currGain
operator|=
literal|0
expr_stmt|;
block|}
comment|/* inactive by default */
name|ahp
operator|->
name|ah_rfgainState
operator|=
name|HAL_RFGAIN_INACTIVE
expr_stmt|;
if|if
condition|(
operator|!
name|ar5212InvalidGainReadback
argument_list|(
name|ah
argument_list|,
name|gv
argument_list|)
operator|&&
name|ar5212IsGainAdjustNeeded
argument_list|(
name|ah
argument_list|,
name|gv
argument_list|)
operator|&&
name|ar5212AdjustGain
argument_list|(
name|ah
argument_list|,
name|gv
argument_list|)
operator|>
literal|0
condition|)
block|{
comment|/* 				 * Change needed. Copy ladder info 				 * into eeprom info. 				 */
name|ahp
operator|->
name|ah_rfgainState
operator|=
name|HAL_RFGAIN_NEED_CHANGE
expr_stmt|;
comment|/* for ap51 */
name|ahp
operator|->
name|ah_cwCalRequire
operator|=
name|AH_TRUE
expr_stmt|;
comment|/* Request IQ recalibration for temperature chang */
name|ahp
operator|->
name|ah_bIQCalibration
operator|=
name|IQ_CAL_INACTIVE
expr_stmt|;
block|}
block|}
block|}
return|return
name|ahp
operator|->
name|ah_rfgainState
return|;
block|}
end_function

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Copyright (c) 2002-2008 Sam Leffler, Errno Consulting  * Copyright (c) 2002-2008 Atheros Communications, Inc.  *  * Permission to use, copy, modify, and/or distribute this software for any  * purpose with or without fee is hereby granted, provided that the above  * copyright notice and this permission notice appear in all copies.  *  * THE SOFTWARE IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL WARRANTIES  * WITH REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF  * MERCHANTABILITY AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR  * ANY SPECIAL, DIRECT, INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES  * WHATSOEVER RESULTING FROM LOSS OF USE, DATA OR PROFITS, WHETHER IN AN  * ACTION OF CONTRACT, NEGLIGENCE OR OTHER TORTIOUS ACTION, ARISING OUT OF  * OR IN CONNECTION WITH THE USE OR PERFORMANCE OF THIS SOFTWARE.  *  * $FreeBSD$  */
end_comment

begin_include
include|#
directive|include
file|"opt_ah.h"
end_include

begin_include
include|#
directive|include
file|"ah.h"
end_include

begin_include
include|#
directive|include
file|"ah_internal.h"
end_include

begin_include
include|#
directive|include
file|"ah_devid.h"
end_include

begin_include
include|#
directive|include
file|"ar5416/ar5416.h"
end_include

begin_include
include|#
directive|include
file|"ar5416/ar5416reg.h"
end_include

begin_include
include|#
directive|include
file|"ar5416/ar5416phy.h"
end_include

begin_include
include|#
directive|include
file|"ar5416/ar5416.ini"
end_include

begin_function
specifier|static
name|void
name|ar5416AniSetup
parameter_list|(
name|struct
name|ath_hal
modifier|*
name|ah
parameter_list|)
block|{
specifier|static
specifier|const
name|struct
name|ar5212AniParams
name|aniparams
init|=
block|{
operator|.
name|maxNoiseImmunityLevel
operator|=
literal|4
block|,
comment|/* levels 0..4 */
operator|.
name|totalSizeDesired
operator|=
block|{
operator|-
literal|55
block|,
operator|-
literal|55
block|,
operator|-
literal|55
block|,
operator|-
literal|55
block|,
operator|-
literal|62
block|}
block|,
operator|.
name|coarseHigh
operator|=
block|{
operator|-
literal|14
block|,
operator|-
literal|14
block|,
operator|-
literal|14
block|,
operator|-
literal|14
block|,
operator|-
literal|12
block|}
block|,
operator|.
name|coarseLow
operator|=
block|{
operator|-
literal|64
block|,
operator|-
literal|64
block|,
operator|-
literal|64
block|,
operator|-
literal|64
block|,
operator|-
literal|70
block|}
block|,
operator|.
name|firpwr
operator|=
block|{
operator|-
literal|78
block|,
operator|-
literal|78
block|,
operator|-
literal|78
block|,
operator|-
literal|78
block|,
operator|-
literal|80
block|}
block|,
operator|.
name|maxSpurImmunityLevel
operator|=
literal|2
block|,
operator|.
name|cycPwrThr1
operator|=
block|{
literal|2
block|,
literal|4
block|,
literal|6
block|}
block|,
operator|.
name|maxFirstepLevel
operator|=
literal|2
block|,
comment|/* levels 0..2 */
operator|.
name|firstep
operator|=
block|{
literal|0
block|,
literal|4
block|,
literal|8
block|}
block|,
operator|.
name|ofdmTrigHigh
operator|=
literal|500
block|,
operator|.
name|ofdmTrigLow
operator|=
literal|200
block|,
operator|.
name|cckTrigHigh
operator|=
literal|200
block|,
operator|.
name|cckTrigLow
operator|=
literal|100
block|,
operator|.
name|rssiThrHigh
operator|=
literal|40
block|,
operator|.
name|rssiThrLow
operator|=
literal|7
block|,
operator|.
name|period
operator|=
literal|100
block|, 	}
decl_stmt|;
comment|/* NB: ANI is not enabled yet */
name|ar5212AniAttach
argument_list|(
name|ah
argument_list|,
operator|&
name|aniparams
argument_list|,
operator|&
name|aniparams
argument_list|,
name|AH_FALSE
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * Attach for an AR5416 part.  */
end_comment

begin_function
name|void
name|ar5416InitState
parameter_list|(
name|struct
name|ath_hal_5416
modifier|*
name|ahp5416
parameter_list|,
name|uint16_t
name|devid
parameter_list|,
name|HAL_SOFTC
name|sc
parameter_list|,
name|HAL_BUS_TAG
name|st
parameter_list|,
name|HAL_BUS_HANDLE
name|sh
parameter_list|,
name|HAL_STATUS
modifier|*
name|status
parameter_list|)
block|{
name|struct
name|ath_hal_5212
modifier|*
name|ahp
decl_stmt|;
name|struct
name|ath_hal
modifier|*
name|ah
decl_stmt|;
name|ahp
operator|=
operator|&
name|ahp5416
operator|->
name|ah_5212
expr_stmt|;
name|ar5212InitState
argument_list|(
name|ahp
argument_list|,
name|devid
argument_list|,
name|sc
argument_list|,
name|st
argument_list|,
name|sh
argument_list|,
name|status
argument_list|)
expr_stmt|;
name|ah
operator|=
operator|&
name|ahp
operator|->
name|ah_priv
operator|.
name|h
expr_stmt|;
comment|/* override 5212 methods for our needs */
name|ah
operator|->
name|ah_magic
operator|=
name|AR5416_MAGIC
expr_stmt|;
name|ah
operator|->
name|ah_getRateTable
operator|=
name|ar5416GetRateTable
expr_stmt|;
name|ah
operator|->
name|ah_detach
operator|=
name|ar5416Detach
expr_stmt|;
comment|/* Reset functions */
name|ah
operator|->
name|ah_reset
operator|=
name|ar5416Reset
expr_stmt|;
name|ah
operator|->
name|ah_phyDisable
operator|=
name|ar5416PhyDisable
expr_stmt|;
name|ah
operator|->
name|ah_disable
operator|=
name|ar5416Disable
expr_stmt|;
name|ah
operator|->
name|ah_perCalibration
operator|=
name|ar5416PerCalibration
expr_stmt|;
name|ah
operator|->
name|ah_perCalibrationN
operator|=
name|ar5416PerCalibrationN
operator|,
name|ah
operator|->
name|ah_resetCalValid
operator|=
name|ar5416ResetCalValid
operator|,
name|ah
operator|->
name|ah_setTxPowerLimit
operator|=
name|ar5416SetTxPowerLimit
expr_stmt|;
comment|/* Transmit functions */
name|ah
operator|->
name|ah_stopTxDma
operator|=
name|ar5416StopTxDma
expr_stmt|;
name|ah
operator|->
name|ah_setupTxDesc
operator|=
name|ar5416SetupTxDesc
expr_stmt|;
name|ah
operator|->
name|ah_setupXTxDesc
operator|=
name|ar5416SetupXTxDesc
expr_stmt|;
name|ah
operator|->
name|ah_fillTxDesc
operator|=
name|ar5416FillTxDesc
expr_stmt|;
name|ah
operator|->
name|ah_procTxDesc
operator|=
name|ar5416ProcTxDesc
expr_stmt|;
comment|/* Receive Functions */
name|ah
operator|->
name|ah_startPcuReceive
operator|=
name|ar5416StartPcuReceive
expr_stmt|;
name|ah
operator|->
name|ah_stopPcuReceive
operator|=
name|ar5416StopPcuReceive
expr_stmt|;
name|ah
operator|->
name|ah_setupRxDesc
operator|=
name|ar5416SetupRxDesc
expr_stmt|;
name|ah
operator|->
name|ah_procRxDesc
operator|=
name|ar5416ProcRxDesc
expr_stmt|;
name|ah
operator|->
name|ah_rxMonitor
operator|=
name|ar5416AniPoll
operator|,
name|ah
operator|->
name|ah_procMibEvent
operator|=
name|ar5416ProcessMibIntr
operator|,
comment|/* Misc Functions */
name|ah
operator|->
name|ah_getDiagState
operator|=
name|ar5416GetDiagState
expr_stmt|;
name|ah
operator|->
name|ah_setLedState
operator|=
name|ar5416SetLedState
expr_stmt|;
name|ah
operator|->
name|ah_gpioCfgOutput
operator|=
name|ar5416GpioCfgOutput
expr_stmt|;
name|ah
operator|->
name|ah_gpioCfgInput
operator|=
name|ar5416GpioCfgInput
expr_stmt|;
name|ah
operator|->
name|ah_gpioGet
operator|=
name|ar5416GpioGet
expr_stmt|;
name|ah
operator|->
name|ah_gpioSet
operator|=
name|ar5416GpioSet
expr_stmt|;
name|ah
operator|->
name|ah_gpioSetIntr
operator|=
name|ar5416GpioSetIntr
expr_stmt|;
name|ah
operator|->
name|ah_resetTsf
operator|=
name|ar5416ResetTsf
expr_stmt|;
name|ah
operator|->
name|ah_getRfGain
operator|=
name|ar5416GetRfgain
expr_stmt|;
name|ah
operator|->
name|ah_setAntennaSwitch
operator|=
name|ar5416SetAntennaSwitch
expr_stmt|;
name|ah
operator|->
name|ah_setDecompMask
operator|=
name|ar5416SetDecompMask
expr_stmt|;
name|ah
operator|->
name|ah_setCoverageClass
operator|=
name|ar5416SetCoverageClass
expr_stmt|;
name|ah
operator|->
name|ah_resetKeyCacheEntry
operator|=
name|ar5416ResetKeyCacheEntry
expr_stmt|;
name|ah
operator|->
name|ah_setKeyCacheEntry
operator|=
name|ar5416SetKeyCacheEntry
expr_stmt|;
comment|/* Power Management Functions */
name|ah
operator|->
name|ah_setPowerMode
operator|=
name|ar5416SetPowerMode
expr_stmt|;
comment|/* Beacon Management Functions */
name|ah
operator|->
name|ah_setBeaconTimers
operator|=
name|ar5416SetBeaconTimers
expr_stmt|;
name|ah
operator|->
name|ah_beaconInit
operator|=
name|ar5416BeaconInit
expr_stmt|;
name|ah
operator|->
name|ah_setStationBeaconTimers
operator|=
name|ar5416SetStaBeaconTimers
expr_stmt|;
name|ah
operator|->
name|ah_resetStationBeaconTimers
operator|=
name|ar5416ResetStaBeaconTimers
expr_stmt|;
comment|/* XXX 802.11n Functions */
if|#
directive|if
literal|0
block|ah->ah_chainTxDesc		= ar5416ChainTxDesc; 	ah->ah_setupFirstTxDesc		= ar5416SetupFirstTxDesc; 	ah->ah_setupLastTxDesc		= ar5416SetupLastTxDesc; 	ah->ah_set11nRateScenario	= ar5416Set11nRateScenario; 	ah->ah_set11nAggrMiddle		= ar5416Set11nAggrMiddle; 	ah->ah_clr11nAggr		= ar5416Clr11nAggr; 	ah->ah_set11nBurstDuration	= ar5416Set11nBurstDuration; 	ah->ah_get11nExtBusy		= ar5416Get11nExtBusy; 	ah->ah_set11nMac2040		= ar5416Set11nMac2040; 	ah->ah_get11nRxClear		= ar5416Get11nRxClear; 	ah->ah_set11nRxClear		= ar5416Set11nRxClear;
endif|#
directive|endif
comment|/* Interrupt functions */
name|ah
operator|->
name|ah_isInterruptPending
operator|=
name|ar5416IsInterruptPending
expr_stmt|;
name|ah
operator|->
name|ah_getPendingInterrupts
operator|=
name|ar5416GetPendingInterrupts
expr_stmt|;
name|ah
operator|->
name|ah_setInterrupts
operator|=
name|ar5416SetInterrupts
expr_stmt|;
name|ahp
operator|->
name|ah_priv
operator|.
name|ah_getWirelessModes
operator|=
name|ar5416GetWirelessModes
expr_stmt|;
name|ahp
operator|->
name|ah_priv
operator|.
name|ah_eepromRead
operator|=
name|ar5416EepromRead
expr_stmt|;
ifdef|#
directive|ifdef
name|AH_SUPPORT_WRITE_EEPROM
name|ahp
operator|->
name|ah_priv
operator|.
name|ah_eepromWrite
operator|=
name|ar5416EepromWrite
expr_stmt|;
endif|#
directive|endif
name|ahp
operator|->
name|ah_priv
operator|.
name|ah_getChipPowerLimits
operator|=
name|ar5416GetChipPowerLimits
expr_stmt|;
comment|/* 	 * Start by setting all Owl devices to 2x2 	 */
name|AH5416
argument_list|(
name|ah
argument_list|)
operator|->
name|ah_rx_chainmask
operator|=
name|AR5416_DEFAULT_RXCHAINMASK
expr_stmt|;
name|AH5416
argument_list|(
name|ah
argument_list|)
operator|->
name|ah_tx_chainmask
operator|=
name|AR5416_DEFAULT_TXCHAINMASK
expr_stmt|;
block|}
end_function

begin_function
name|uint32_t
name|ar5416GetRadioRev
parameter_list|(
name|struct
name|ath_hal
modifier|*
name|ah
parameter_list|)
block|{
name|uint32_t
name|val
decl_stmt|;
name|int
name|i
decl_stmt|;
comment|/* Read Radio Chip Rev Extract */
name|OS_REG_WRITE
argument_list|(
name|ah
argument_list|,
name|AR_PHY
argument_list|(
literal|0x36
argument_list|)
argument_list|,
literal|0x00007058
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|8
condition|;
name|i
operator|++
control|)
name|OS_REG_WRITE
argument_list|(
name|ah
argument_list|,
name|AR_PHY
argument_list|(
literal|0x20
argument_list|)
argument_list|,
literal|0x00010000
argument_list|)
expr_stmt|;
name|val
operator|=
operator|(
name|OS_REG_READ
argument_list|(
name|ah
argument_list|,
name|AR_PHY
argument_list|(
literal|256
argument_list|)
argument_list|)
operator|>>
literal|24
operator|)
operator|&
literal|0xff
expr_stmt|;
name|val
operator|=
operator|(
operator|(
name|val
operator|&
literal|0xf0
operator|)
operator|>>
literal|4
operator|)
operator||
operator|(
operator|(
name|val
operator|&
literal|0x0f
operator|)
operator|<<
literal|4
operator|)
expr_stmt|;
return|return
name|ath_hal_reverseBits
argument_list|(
name|val
argument_list|,
literal|8
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/*  * Attach for an AR5416 part.  */
end_comment

begin_function
name|struct
name|ath_hal
modifier|*
name|ar5416Attach
parameter_list|(
name|uint16_t
name|devid
parameter_list|,
name|HAL_SOFTC
name|sc
parameter_list|,
name|HAL_BUS_TAG
name|st
parameter_list|,
name|HAL_BUS_HANDLE
name|sh
parameter_list|,
name|HAL_STATUS
modifier|*
name|status
parameter_list|)
block|{
name|struct
name|ath_hal_5416
modifier|*
name|ahp5416
decl_stmt|;
name|struct
name|ath_hal_5212
modifier|*
name|ahp
decl_stmt|;
name|struct
name|ath_hal
modifier|*
name|ah
decl_stmt|;
name|uint32_t
name|val
decl_stmt|;
name|HAL_STATUS
name|ecode
decl_stmt|;
name|HAL_BOOL
name|rfStatus
decl_stmt|;
name|HALDEBUG
argument_list|(
name|AH_NULL
argument_list|,
name|HAL_DEBUG_ATTACH
argument_list|,
literal|"%s: sc %p st %p sh %p\n"
argument_list|,
name|__func__
argument_list|,
name|sc
argument_list|,
operator|(
name|void
operator|*
operator|)
name|st
argument_list|,
operator|(
name|void
operator|*
operator|)
name|sh
argument_list|)
expr_stmt|;
comment|/* NB: memory is returned zero'd */
name|ahp5416
operator|=
name|ath_hal_malloc
argument_list|(
sizeof|sizeof
argument_list|(
expr|struct
name|ath_hal_5416
argument_list|)
operator|+
comment|/* extra space for Owl 2.1/2.2 WAR */
sizeof|sizeof
argument_list|(
name|ar5416Addac
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|ahp5416
operator|==
name|AH_NULL
condition|)
block|{
name|HALDEBUG
argument_list|(
name|AH_NULL
argument_list|,
name|HAL_DEBUG_ANY
argument_list|,
literal|"%s: cannot allocate memory for state block\n"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
operator|*
name|status
operator|=
name|HAL_ENOMEM
expr_stmt|;
return|return
name|AH_NULL
return|;
block|}
name|ar5416InitState
argument_list|(
name|ahp5416
argument_list|,
name|devid
argument_list|,
name|sc
argument_list|,
name|st
argument_list|,
name|sh
argument_list|,
name|status
argument_list|)
expr_stmt|;
name|ahp
operator|=
operator|&
name|ahp5416
operator|->
name|ah_5212
expr_stmt|;
name|ah
operator|=
operator|&
name|ahp
operator|->
name|ah_priv
operator|.
name|h
expr_stmt|;
if|if
condition|(
operator|!
name|ar5416SetResetReg
argument_list|(
name|ah
argument_list|,
name|HAL_RESET_POWER_ON
argument_list|)
condition|)
block|{
comment|/* reset chip */
name|HALDEBUG
argument_list|(
name|ah
argument_list|,
name|HAL_DEBUG_ANY
argument_list|,
literal|"%s: couldn't reset chip\n"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
name|ecode
operator|=
name|HAL_EIO
expr_stmt|;
goto|goto
name|bad
goto|;
block|}
if|if
condition|(
operator|!
name|ar5416SetPowerMode
argument_list|(
name|ah
argument_list|,
name|HAL_PM_AWAKE
argument_list|,
name|AH_TRUE
argument_list|)
condition|)
block|{
name|HALDEBUG
argument_list|(
name|ah
argument_list|,
name|HAL_DEBUG_ANY
argument_list|,
literal|"%s: couldn't wakeup chip\n"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
name|ecode
operator|=
name|HAL_EIO
expr_stmt|;
goto|goto
name|bad
goto|;
block|}
comment|/* Read Revisions from Chips before taking out of reset */
name|val
operator|=
name|OS_REG_READ
argument_list|(
name|ah
argument_list|,
name|AR_SREV
argument_list|)
operator|&
name|AR_SREV_ID
expr_stmt|;
name|AH_PRIVATE
argument_list|(
name|ah
argument_list|)
operator|->
name|ah_macVersion
operator|=
name|val
operator|>>
name|AR_SREV_ID_S
expr_stmt|;
name|AH_PRIVATE
argument_list|(
name|ah
argument_list|)
operator|->
name|ah_macRev
operator|=
name|val
operator|&
name|AR_SREV_REVISION
expr_stmt|;
comment|/* setup common ini data; rf backends handle remainder */
name|HAL_INI_INIT
argument_list|(
operator|&
name|ahp
operator|->
name|ah_ini_modes
argument_list|,
name|ar5416Modes
argument_list|,
literal|6
argument_list|)
expr_stmt|;
name|HAL_INI_INIT
argument_list|(
operator|&
name|ahp
operator|->
name|ah_ini_common
argument_list|,
name|ar5416Common
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|HAL_INI_INIT
argument_list|(
operator|&
name|AH5416
argument_list|(
name|ah
argument_list|)
operator|->
name|ah_ini_bb_rfgain
argument_list|,
name|ar5416BB_RfGain
argument_list|,
literal|3
argument_list|)
expr_stmt|;
name|HAL_INI_INIT
argument_list|(
operator|&
name|AH5416
argument_list|(
name|ah
argument_list|)
operator|->
name|ah_ini_bank0
argument_list|,
name|ar5416Bank0
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|HAL_INI_INIT
argument_list|(
operator|&
name|AH5416
argument_list|(
name|ah
argument_list|)
operator|->
name|ah_ini_bank1
argument_list|,
name|ar5416Bank1
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|HAL_INI_INIT
argument_list|(
operator|&
name|AH5416
argument_list|(
name|ah
argument_list|)
operator|->
name|ah_ini_bank2
argument_list|,
name|ar5416Bank2
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|HAL_INI_INIT
argument_list|(
operator|&
name|AH5416
argument_list|(
name|ah
argument_list|)
operator|->
name|ah_ini_bank3
argument_list|,
name|ar5416Bank3
argument_list|,
literal|3
argument_list|)
expr_stmt|;
name|HAL_INI_INIT
argument_list|(
operator|&
name|AH5416
argument_list|(
name|ah
argument_list|)
operator|->
name|ah_ini_bank6
argument_list|,
name|ar5416Bank6
argument_list|,
literal|3
argument_list|)
expr_stmt|;
name|HAL_INI_INIT
argument_list|(
operator|&
name|AH5416
argument_list|(
name|ah
argument_list|)
operator|->
name|ah_ini_bank7
argument_list|,
name|ar5416Bank7
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|HAL_INI_INIT
argument_list|(
operator|&
name|AH5416
argument_list|(
name|ah
argument_list|)
operator|->
name|ah_ini_addac
argument_list|,
name|ar5416Addac
argument_list|,
literal|2
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|IS_5416V2_2
argument_list|(
name|ah
argument_list|)
condition|)
block|{
comment|/* Owl 2.1/2.0 */
struct|struct
name|ini
block|{
name|uint32_t
modifier|*
name|data
decl_stmt|;
comment|/* NB: !const */
name|int
name|rows
decl_stmt|,
name|cols
decl_stmt|;
block|}
struct|;
comment|/* override CLKDRV value */
name|OS_MEMCPY
argument_list|(
operator|&
name|AH5416
argument_list|(
name|ah
argument_list|)
index|[
literal|1
index|]
argument_list|,
name|ar5416Addac
argument_list|,
sizeof|sizeof
argument_list|(
name|ar5416Addac
argument_list|)
argument_list|)
expr_stmt|;
name|AH5416
argument_list|(
name|ah
argument_list|)
operator|->
name|ah_ini_addac
operator|.
name|data
operator|=
operator|(
name|uint32_t
operator|*
operator|)
operator|&
name|AH5416
argument_list|(
name|ah
argument_list|)
index|[
literal|1
index|]
expr_stmt|;
name|HAL_INI_VAL
argument_list|(
operator|(
expr|struct
name|ini
operator|*
operator|)
operator|&
name|AH5416
argument_list|(
name|ah
argument_list|)
operator|->
name|ah_ini_addac
argument_list|,
literal|31
argument_list|,
literal|1
argument_list|)
operator|=
literal|0
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|ar5416ChipReset
argument_list|(
name|ah
argument_list|,
name|AH_NULL
argument_list|)
condition|)
block|{
comment|/* reset chip */
name|HALDEBUG
argument_list|(
name|ah
argument_list|,
name|HAL_DEBUG_ANY
argument_list|,
literal|"%s: chip reset failed\n"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
name|ecode
operator|=
name|HAL_EIO
expr_stmt|;
goto|goto
name|bad
goto|;
block|}
name|AH_PRIVATE
argument_list|(
name|ah
argument_list|)
operator|->
name|ah_phyRev
operator|=
name|OS_REG_READ
argument_list|(
name|ah
argument_list|,
name|AR_PHY_CHIP_ID
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|ar5212ChipTest
argument_list|(
name|ah
argument_list|)
condition|)
block|{
name|HALDEBUG
argument_list|(
name|ah
argument_list|,
name|HAL_DEBUG_ANY
argument_list|,
literal|"%s: hardware self-test failed\n"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
name|ecode
operator|=
name|HAL_ESELFTEST
expr_stmt|;
goto|goto
name|bad
goto|;
block|}
comment|/* 	 * Set correct Baseband to analog shift 	 * setting to access analog chips. 	 */
name|OS_REG_WRITE
argument_list|(
name|ah
argument_list|,
name|AR_PHY
argument_list|(
literal|0
argument_list|)
argument_list|,
literal|0x00000007
argument_list|)
expr_stmt|;
comment|/* Read Radio Chip Rev Extract */
name|AH_PRIVATE
argument_list|(
name|ah
argument_list|)
operator|->
name|ah_analog5GhzRev
operator|=
name|ar5212GetRadioRev
argument_list|(
name|ah
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|AH_PRIVATE
argument_list|(
name|ah
argument_list|)
operator|->
name|ah_analog5GhzRev
operator|&
name|AR_RADIO_SREV_MAJOR
condition|)
block|{
case|case
name|AR_RAD5122_SREV_MAJOR
case|:
comment|/* Fowl: 5G/2x2 */
case|case
name|AR_RAD2122_SREV_MAJOR
case|:
comment|/* Fowl: 2+5G/2x2 */
case|case
name|AR_RAD2133_SREV_MAJOR
case|:
comment|/* Fowl: 2G/3x3 */
case|case
name|AR_RAD5133_SREV_MAJOR
case|:
comment|/* Fowl: 2+5G/3x3 */
break|break;
default|default:
if|if
condition|(
name|AH_PRIVATE
argument_list|(
name|ah
argument_list|)
operator|->
name|ah_analog5GhzRev
operator|==
literal|0
condition|)
block|{
comment|/* 			 * When RF_Silen is used the analog chip is reset. 			 * So when the system boots with radio switch off 			 * the RF chip rev reads back as zero and we need 			 * to use the mac+phy revs to set the radio rev. 			 */
name|AH_PRIVATE
argument_list|(
name|ah
argument_list|)
operator|->
name|ah_analog5GhzRev
operator|=
name|AR_RAD5133_SREV_MAJOR
expr_stmt|;
break|break;
block|}
comment|/* NB: silently accept anything in release code per Atheros */
ifdef|#
directive|ifdef
name|AH_DEBUG
name|HALDEBUG
argument_list|(
name|ah
argument_list|,
name|HAL_DEBUG_ANY
argument_list|,
literal|"%s: 5G Radio Chip Rev 0x%02X is not supported by "
literal|"this driver\n"
argument_list|,
name|__func__
argument_list|,
name|AH_PRIVATE
argument_list|(
name|ah
argument_list|)
operator|->
name|ah_analog5GhzRev
argument_list|)
expr_stmt|;
name|ecode
operator|=
name|HAL_ENOTSUPP
expr_stmt|;
goto|goto
name|bad
goto|;
endif|#
directive|endif
block|}
name|ecode
operator|=
name|ath_hal_v14EepromAttach
argument_list|(
name|ah
argument_list|)
expr_stmt|;
if|if
condition|(
name|ecode
operator|!=
name|HAL_OK
condition|)
goto|goto
name|bad
goto|;
comment|/* 	 * Got everything we need now to setup the capabilities. 	 */
if|if
condition|(
operator|!
name|ar5416FillCapabilityInfo
argument_list|(
name|ah
argument_list|)
condition|)
block|{
name|ecode
operator|=
name|HAL_EEREAD
expr_stmt|;
goto|goto
name|bad
goto|;
block|}
name|ecode
operator|=
name|ath_hal_eepromGet
argument_list|(
name|ah
argument_list|,
name|AR_EEP_MACADDR
argument_list|,
name|ahp
operator|->
name|ah_macaddr
argument_list|)
expr_stmt|;
if|if
condition|(
name|ecode
operator|!=
name|HAL_OK
condition|)
block|{
name|HALDEBUG
argument_list|(
name|ah
argument_list|,
name|HAL_DEBUG_ANY
argument_list|,
literal|"%s: error getting mac address from EEPROM\n"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
goto|goto
name|bad
goto|;
block|}
comment|/* XXX How about the serial number ? */
comment|/* Read Reg Domain */
name|AH_PRIVATE
argument_list|(
name|ah
argument_list|)
operator|->
name|ah_currentRD
operator|=
name|ath_hal_eepromGet
argument_list|(
name|ah
argument_list|,
name|AR_EEP_REGDMN_0
argument_list|,
name|AH_NULL
argument_list|)
expr_stmt|;
comment|/* 	 * ah_miscMode is populated by ar5416FillCapabilityInfo() 	 * starting from griffin. Set here to make sure that 	 * AR_MISC_MODE_MIC_NEW_LOC_ENABLE is set before a GTK is 	 * placed into hardware. 	 */
if|if
condition|(
name|ahp
operator|->
name|ah_miscMode
operator|!=
literal|0
condition|)
name|OS_REG_WRITE
argument_list|(
name|ah
argument_list|,
name|AR_MISC_MODE
argument_list|,
name|ahp
operator|->
name|ah_miscMode
argument_list|)
expr_stmt|;
name|HALDEBUG
argument_list|(
name|ah
argument_list|,
name|HAL_DEBUG_ATTACH
argument_list|,
literal|"%s: Attaching AR2133 radio\n"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
name|rfStatus
operator|=
name|ar2133RfAttach
argument_list|(
name|ah
argument_list|,
operator|&
name|ecode
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|rfStatus
condition|)
block|{
name|HALDEBUG
argument_list|(
name|ah
argument_list|,
name|HAL_DEBUG_ANY
argument_list|,
literal|"%s: RF setup failed, status %u\n"
argument_list|,
name|__func__
argument_list|,
name|ecode
argument_list|)
expr_stmt|;
goto|goto
name|bad
goto|;
block|}
name|ar5416AniSetup
argument_list|(
name|ah
argument_list|)
expr_stmt|;
comment|/* Anti Noise Immunity */
name|ar5416InitNfHistBuff
argument_list|(
name|AH5416
argument_list|(
name|ah
argument_list|)
operator|->
name|ah_cal
operator|.
name|nfCalHist
argument_list|)
expr_stmt|;
name|HALDEBUG
argument_list|(
name|ah
argument_list|,
name|HAL_DEBUG_ATTACH
argument_list|,
literal|"%s: return\n"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
return|return
name|ah
return|;
name|bad
label|:
if|if
condition|(
name|ahp
condition|)
name|ar5416Detach
argument_list|(
operator|(
expr|struct
name|ath_hal
operator|*
operator|)
name|ahp
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
condition|)
operator|*
name|status
operator|=
name|ecode
expr_stmt|;
return|return
name|AH_NULL
return|;
block|}
end_function

begin_function
name|void
name|ar5416Detach
parameter_list|(
name|struct
name|ath_hal
modifier|*
name|ah
parameter_list|)
block|{
name|HALDEBUG
argument_list|(
name|ah
argument_list|,
name|HAL_DEBUG_ATTACH
argument_list|,
literal|"%s:\n"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
name|HALASSERT
argument_list|(
name|ah
operator|!=
name|AH_NULL
argument_list|)
expr_stmt|;
name|HALASSERT
argument_list|(
name|ah
operator|->
name|ah_magic
operator|==
name|AR5416_MAGIC
argument_list|)
expr_stmt|;
name|ar5416AniDetach
argument_list|(
name|ah
argument_list|)
expr_stmt|;
name|ar5212RfDetach
argument_list|(
name|ah
argument_list|)
expr_stmt|;
name|ah
operator|->
name|ah_disable
argument_list|(
name|ah
argument_list|)
expr_stmt|;
name|ar5416SetPowerMode
argument_list|(
name|ah
argument_list|,
name|HAL_PM_FULL_SLEEP
argument_list|,
name|AH_TRUE
argument_list|)
expr_stmt|;
name|ath_hal_eepromDetach
argument_list|(
name|ah
argument_list|)
expr_stmt|;
name|ath_hal_free
argument_list|(
name|ah
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * Fill all software cached or static hardware state information.  * Return failure if capabilities are to come from EEPROM and  * cannot be read.  */
end_comment

begin_function
name|HAL_BOOL
name|ar5416FillCapabilityInfo
parameter_list|(
name|struct
name|ath_hal
modifier|*
name|ah
parameter_list|)
block|{
name|struct
name|ath_hal_private
modifier|*
name|ahpriv
init|=
name|AH_PRIVATE
argument_list|(
name|ah
argument_list|)
decl_stmt|;
name|HAL_CAPABILITIES
modifier|*
name|pCap
init|=
operator|&
name|ahpriv
operator|->
name|ah_caps
decl_stmt|;
name|uint16_t
name|val
decl_stmt|;
comment|/* Construct wireless mode from EEPROM */
name|pCap
operator|->
name|halWirelessModes
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|ath_hal_eepromGetFlag
argument_list|(
name|ah
argument_list|,
name|AR_EEP_AMODE
argument_list|)
condition|)
block|{
name|pCap
operator|->
name|halWirelessModes
operator||=
name|HAL_MODE_11A
operator||
name|HAL_MODE_11NA_HT20
operator||
name|HAL_MODE_11NA_HT40PLUS
operator||
name|HAL_MODE_11NA_HT40MINUS
expr_stmt|;
block|}
if|if
condition|(
name|ath_hal_eepromGetFlag
argument_list|(
name|ah
argument_list|,
name|AR_EEP_GMODE
argument_list|)
condition|)
block|{
name|pCap
operator|->
name|halWirelessModes
operator||=
name|HAL_MODE_11G
operator||
name|HAL_MODE_11NG_HT20
operator||
name|HAL_MODE_11NG_HT40PLUS
operator||
name|HAL_MODE_11NG_HT40MINUS
expr_stmt|;
name|pCap
operator|->
name|halWirelessModes
operator||=
name|HAL_MODE_11A
operator||
name|HAL_MODE_11NA_HT20
operator||
name|HAL_MODE_11NA_HT40PLUS
operator||
name|HAL_MODE_11NA_HT40MINUS
expr_stmt|;
block|}
name|pCap
operator|->
name|halLow2GhzChan
operator|=
literal|2312
expr_stmt|;
name|pCap
operator|->
name|halHigh2GhzChan
operator|=
literal|2732
expr_stmt|;
name|pCap
operator|->
name|halLow5GhzChan
operator|=
literal|4915
expr_stmt|;
name|pCap
operator|->
name|halHigh5GhzChan
operator|=
literal|6100
expr_stmt|;
name|pCap
operator|->
name|halCipherCkipSupport
operator|=
name|AH_FALSE
expr_stmt|;
name|pCap
operator|->
name|halCipherTkipSupport
operator|=
name|AH_TRUE
expr_stmt|;
name|pCap
operator|->
name|halCipherAesCcmSupport
operator|=
name|ath_hal_eepromGetFlag
argument_list|(
name|ah
argument_list|,
name|AR_EEP_AES
argument_list|)
expr_stmt|;
name|pCap
operator|->
name|halMicCkipSupport
operator|=
name|AH_FALSE
expr_stmt|;
name|pCap
operator|->
name|halMicTkipSupport
operator|=
name|AH_TRUE
expr_stmt|;
name|pCap
operator|->
name|halMicAesCcmSupport
operator|=
name|ath_hal_eepromGetFlag
argument_list|(
name|ah
argument_list|,
name|AR_EEP_AES
argument_list|)
expr_stmt|;
comment|/* 	 * Starting with Griffin TX+RX mic keys can be combined 	 * in one key cache slot. 	 */
name|pCap
operator|->
name|halTkipMicTxRxKeySupport
operator|=
name|AH_TRUE
expr_stmt|;
name|pCap
operator|->
name|halChanSpreadSupport
operator|=
name|AH_TRUE
expr_stmt|;
name|pCap
operator|->
name|halSleepAfterBeaconBroken
operator|=
name|AH_TRUE
expr_stmt|;
name|pCap
operator|->
name|halCompressSupport
operator|=
name|AH_FALSE
expr_stmt|;
name|pCap
operator|->
name|halBurstSupport
operator|=
name|AH_TRUE
expr_stmt|;
name|pCap
operator|->
name|halFastFramesSupport
operator|=
name|AH_FALSE
expr_stmt|;
comment|/* XXX? */
name|pCap
operator|->
name|halChapTuningSupport
operator|=
name|AH_TRUE
expr_stmt|;
name|pCap
operator|->
name|halTurboPrimeSupport
operator|=
name|AH_TRUE
expr_stmt|;
name|pCap
operator|->
name|halTurboGSupport
operator|=
name|pCap
operator|->
name|halWirelessModes
operator|&
name|HAL_MODE_108G
expr_stmt|;
name|pCap
operator|->
name|halPSPollBroken
operator|=
name|AH_TRUE
expr_stmt|;
comment|/* XXX fixed in later revs? */
name|pCap
operator|->
name|halVEOLSupport
operator|=
name|AH_TRUE
expr_stmt|;
name|pCap
operator|->
name|halBssIdMaskSupport
operator|=
name|AH_TRUE
expr_stmt|;
name|pCap
operator|->
name|halMcastKeySrchSupport
operator|=
name|AH_FALSE
expr_stmt|;
name|pCap
operator|->
name|halTsfAddSupport
operator|=
name|AH_TRUE
expr_stmt|;
if|if
condition|(
name|ath_hal_eepromGet
argument_list|(
name|ah
argument_list|,
name|AR_EEP_MAXQCU
argument_list|,
operator|&
name|val
argument_list|)
operator|==
name|HAL_OK
condition|)
name|pCap
operator|->
name|halTotalQueues
operator|=
name|val
expr_stmt|;
else|else
name|pCap
operator|->
name|halTotalQueues
operator|=
name|HAL_NUM_TX_QUEUES
expr_stmt|;
if|if
condition|(
name|ath_hal_eepromGet
argument_list|(
name|ah
argument_list|,
name|AR_EEP_KCENTRIES
argument_list|,
operator|&
name|val
argument_list|)
operator|==
name|HAL_OK
condition|)
name|pCap
operator|->
name|halKeyCacheSize
operator|=
name|val
expr_stmt|;
else|else
name|pCap
operator|->
name|halKeyCacheSize
operator|=
name|AR5416_KEYTABLE_SIZE
expr_stmt|;
comment|/* XXX not needed */
name|pCap
operator|->
name|halChanHalfRate
operator|=
name|AH_FALSE
expr_stmt|;
comment|/* XXX ? */
name|pCap
operator|->
name|halChanQuarterRate
operator|=
name|AH_FALSE
expr_stmt|;
comment|/* XXX ? */
name|pCap
operator|->
name|halTstampPrecision
operator|=
literal|32
expr_stmt|;
name|pCap
operator|->
name|halHwPhyCounterSupport
operator|=
name|AH_TRUE
expr_stmt|;
name|pCap
operator|->
name|halFastCCSupport
operator|=
name|AH_TRUE
expr_stmt|;
name|pCap
operator|->
name|halNumGpioPins
operator|=
literal|6
expr_stmt|;
name|pCap
operator|->
name|halWowSupport
operator|=
name|AH_FALSE
expr_stmt|;
name|pCap
operator|->
name|halWowMatchPatternExact
operator|=
name|AH_FALSE
expr_stmt|;
name|pCap
operator|->
name|halBtCoexSupport
operator|=
name|AH_FALSE
expr_stmt|;
comment|/* XXX need support */
name|pCap
operator|->
name|halAutoSleepSupport
operator|=
name|AH_FALSE
expr_stmt|;
if|#
directive|if
literal|0
comment|/* XXX not yet */
block|pCap->halNumAntCfg2GHz = ar5416GetNumAntConfig(ahp, HAL_FREQ_BAND_2GHZ); 	pCap->halNumAntCfg5GHz = ar5416GetNumAntConfig(ahp, HAL_FREQ_BAND_5GHZ);
endif|#
directive|endif
name|pCap
operator|->
name|halHTSupport
operator|=
name|AH_TRUE
expr_stmt|;
name|pCap
operator|->
name|halTxChainMask
operator|=
name|ath_hal_eepromGet
argument_list|(
name|ah
argument_list|,
name|AR_EEP_TXMASK
argument_list|,
name|AH_NULL
argument_list|)
expr_stmt|;
comment|/* XXX CB71 uses GPIO 0 to indicate 3 rx chains */
name|pCap
operator|->
name|halRxChainMask
operator|=
name|ath_hal_eepromGet
argument_list|(
name|ah
argument_list|,
name|AR_EEP_RXMASK
argument_list|,
name|AH_NULL
argument_list|)
expr_stmt|;
name|pCap
operator|->
name|halRtsAggrLimit
operator|=
literal|8
operator|*
literal|1024
expr_stmt|;
comment|/* Owl 2.0 limit */
name|pCap
operator|->
name|halMbssidAggrSupport
operator|=
name|AH_TRUE
expr_stmt|;
name|pCap
operator|->
name|halForcePpmSupport
operator|=
name|AH_TRUE
expr_stmt|;
name|pCap
operator|->
name|halEnhancedPmSupport
operator|=
name|AH_TRUE
expr_stmt|;
if|if
condition|(
name|ath_hal_eepromGetFlag
argument_list|(
name|ah
argument_list|,
name|AR_EEP_RFKILL
argument_list|)
operator|&&
name|ath_hal_eepromGet
argument_list|(
name|ah
argument_list|,
name|AR_EEP_RFSILENT
argument_list|,
operator|&
name|ahpriv
operator|->
name|ah_rfsilent
argument_list|)
operator|==
name|HAL_OK
condition|)
block|{
comment|/* NB: enabled by default */
name|ahpriv
operator|->
name|ah_rfkillEnabled
operator|=
name|AH_TRUE
expr_stmt|;
name|pCap
operator|->
name|halRfSilentSupport
operator|=
name|AH_TRUE
expr_stmt|;
block|}
name|ahpriv
operator|->
name|ah_rxornIsFatal
operator|=
name|AH_FALSE
expr_stmt|;
return|return
name|AH_TRUE
return|;
block|}
end_function

begin_function
specifier|static
specifier|const
name|char
modifier|*
name|ar5416Probe
parameter_list|(
name|uint16_t
name|vendorid
parameter_list|,
name|uint16_t
name|devid
parameter_list|)
block|{
if|if
condition|(
name|vendorid
operator|==
name|ATHEROS_VENDOR_ID
operator|&&
operator|(
name|devid
operator|==
name|AR5416_DEVID_PCI
operator|||
name|devid
operator|==
name|AR5416_DEVID_PCIE
operator|)
condition|)
return|return
literal|"Atheros 5416"
return|;
return|return
name|AH_NULL
return|;
block|}
end_function

begin_expr_stmt
name|AH_CHIP
argument_list|(
name|AR5416
argument_list|,
name|ar5416Probe
argument_list|,
name|ar5416Attach
argument_list|)
expr_stmt|;
end_expr_stmt

end_unit


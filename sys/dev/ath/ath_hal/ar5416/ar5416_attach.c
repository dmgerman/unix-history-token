begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Copyright (c) 2002-2008 Sam Leffler, Errno Consulting  * Copyright (c) 2002-2008 Atheros Communications, Inc.  *  * Permission to use, copy, modify, and/or distribute this software for any  * purpose with or without fee is hereby granted, provided that the above  * copyright notice and this permission notice appear in all copies.  *  * THE SOFTWARE IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL WARRANTIES  * WITH REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF  * MERCHANTABILITY AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR  * ANY SPECIAL, DIRECT, INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES  * WHATSOEVER RESULTING FROM LOSS OF USE, DATA OR PROFITS, WHETHER IN AN  * ACTION OF CONTRACT, NEGLIGENCE OR OTHER TORTIOUS ACTION, ARISING OUT OF  * OR IN CONNECTION WITH THE USE OR PERFORMANCE OF THIS SOFTWARE.  *  * $FreeBSD$  */
end_comment

begin_include
include|#
directive|include
file|"opt_ah.h"
end_include

begin_include
include|#
directive|include
file|"ah.h"
end_include

begin_include
include|#
directive|include
file|"ah_internal.h"
end_include

begin_include
include|#
directive|include
file|"ah_devid.h"
end_include

begin_include
include|#
directive|include
file|"ah_eeprom_v14.h"
end_include

begin_include
include|#
directive|include
file|"ar5416/ar5416.h"
end_include

begin_include
include|#
directive|include
file|"ar5416/ar5416reg.h"
end_include

begin_include
include|#
directive|include
file|"ar5416/ar5416phy.h"
end_include

begin_include
include|#
directive|include
file|"ar5416/ar5416.ini"
end_include

begin_function_decl
specifier|static
name|void
name|ar5416ConfigPCIE
parameter_list|(
name|struct
name|ath_hal
modifier|*
name|ah
parameter_list|,
name|HAL_BOOL
name|restore
parameter_list|,
name|HAL_BOOL
name|power_off
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|ar5416DisablePCIE
parameter_list|(
name|struct
name|ath_hal
modifier|*
name|ah
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|ar5416WriteIni
parameter_list|(
name|struct
name|ath_hal
modifier|*
name|ah
parameter_list|,
specifier|const
name|struct
name|ieee80211_channel
modifier|*
name|chan
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|ar5416SpurMitigate
parameter_list|(
name|struct
name|ath_hal
modifier|*
name|ah
parameter_list|,
specifier|const
name|struct
name|ieee80211_channel
modifier|*
name|chan
parameter_list|)
function_decl|;
end_function_decl

begin_function
specifier|static
name|void
name|ar5416AniSetup
parameter_list|(
name|struct
name|ath_hal
modifier|*
name|ah
parameter_list|)
block|{
specifier|static
specifier|const
name|struct
name|ar5212AniParams
name|aniparams
init|=
block|{
operator|.
name|maxNoiseImmunityLevel
operator|=
literal|4
block|,
comment|/* levels 0..4 */
operator|.
name|totalSizeDesired
operator|=
block|{
operator|-
literal|55
block|,
operator|-
literal|55
block|,
operator|-
literal|55
block|,
operator|-
literal|55
block|,
operator|-
literal|62
block|}
block|,
operator|.
name|coarseHigh
operator|=
block|{
operator|-
literal|14
block|,
operator|-
literal|14
block|,
operator|-
literal|14
block|,
operator|-
literal|14
block|,
operator|-
literal|12
block|}
block|,
operator|.
name|coarseLow
operator|=
block|{
operator|-
literal|64
block|,
operator|-
literal|64
block|,
operator|-
literal|64
block|,
operator|-
literal|64
block|,
operator|-
literal|70
block|}
block|,
operator|.
name|firpwr
operator|=
block|{
operator|-
literal|78
block|,
operator|-
literal|78
block|,
operator|-
literal|78
block|,
operator|-
literal|78
block|,
operator|-
literal|80
block|}
block|,
operator|.
name|maxSpurImmunityLevel
operator|=
literal|2
block|,
operator|.
name|cycPwrThr1
operator|=
block|{
literal|2
block|,
literal|4
block|,
literal|6
block|}
block|,
operator|.
name|maxFirstepLevel
operator|=
literal|2
block|,
comment|/* levels 0..2 */
operator|.
name|firstep
operator|=
block|{
literal|0
block|,
literal|4
block|,
literal|8
block|}
block|,
operator|.
name|ofdmTrigHigh
operator|=
literal|500
block|,
operator|.
name|ofdmTrigLow
operator|=
literal|200
block|,
operator|.
name|cckTrigHigh
operator|=
literal|200
block|,
operator|.
name|cckTrigLow
operator|=
literal|100
block|,
operator|.
name|rssiThrHigh
operator|=
literal|40
block|,
operator|.
name|rssiThrLow
operator|=
literal|7
block|,
operator|.
name|period
operator|=
literal|100
block|, 	}
decl_stmt|;
comment|/* NB: disable ANI noise immmunity for reliable RIFS rx */
name|AH5416
argument_list|(
name|ah
argument_list|)
operator|->
name|ah_ani_function
operator|&=
operator|~
operator|(
literal|1
operator|<<
name|HAL_ANI_NOISE_IMMUNITY_LEVEL
operator|)
expr_stmt|;
name|ar5416AniAttach
argument_list|(
name|ah
argument_list|,
operator|&
name|aniparams
argument_list|,
operator|&
name|aniparams
argument_list|,
name|AH_TRUE
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * AR5416 doesn't do OLC or temperature compensation.  */
end_comment

begin_function
specifier|static
name|void
name|ar5416olcInit
parameter_list|(
name|struct
name|ath_hal
modifier|*
name|ah
parameter_list|)
block|{ }
end_function

begin_function
specifier|static
name|void
name|ar5416olcTempCompensation
parameter_list|(
name|struct
name|ath_hal
modifier|*
name|ah
parameter_list|)
block|{ }
end_function

begin_comment
comment|/*  * Attach for an AR5416 part.  */
end_comment

begin_function
name|void
name|ar5416InitState
parameter_list|(
name|struct
name|ath_hal_5416
modifier|*
name|ahp5416
parameter_list|,
name|uint16_t
name|devid
parameter_list|,
name|HAL_SOFTC
name|sc
parameter_list|,
name|HAL_BUS_TAG
name|st
parameter_list|,
name|HAL_BUS_HANDLE
name|sh
parameter_list|,
name|HAL_STATUS
modifier|*
name|status
parameter_list|)
block|{
name|struct
name|ath_hal_5212
modifier|*
name|ahp
decl_stmt|;
name|struct
name|ath_hal
modifier|*
name|ah
decl_stmt|;
name|ahp
operator|=
operator|&
name|ahp5416
operator|->
name|ah_5212
expr_stmt|;
name|ar5212InitState
argument_list|(
name|ahp
argument_list|,
name|devid
argument_list|,
name|sc
argument_list|,
name|st
argument_list|,
name|sh
argument_list|,
name|status
argument_list|)
expr_stmt|;
name|ah
operator|=
operator|&
name|ahp
operator|->
name|ah_priv
operator|.
name|h
expr_stmt|;
comment|/* override 5212 methods for our needs */
name|ah
operator|->
name|ah_magic
operator|=
name|AR5416_MAGIC
expr_stmt|;
name|ah
operator|->
name|ah_getRateTable
operator|=
name|ar5416GetRateTable
expr_stmt|;
name|ah
operator|->
name|ah_detach
operator|=
name|ar5416Detach
expr_stmt|;
comment|/* Reset functions */
name|ah
operator|->
name|ah_reset
operator|=
name|ar5416Reset
expr_stmt|;
name|ah
operator|->
name|ah_phyDisable
operator|=
name|ar5416PhyDisable
expr_stmt|;
name|ah
operator|->
name|ah_disable
operator|=
name|ar5416Disable
expr_stmt|;
name|ah
operator|->
name|ah_configPCIE
operator|=
name|ar5416ConfigPCIE
expr_stmt|;
name|ah
operator|->
name|ah_disablePCIE
operator|=
name|ar5416DisablePCIE
expr_stmt|;
name|ah
operator|->
name|ah_perCalibration
operator|=
name|ar5416PerCalibration
expr_stmt|;
name|ah
operator|->
name|ah_perCalibrationN
operator|=
name|ar5416PerCalibrationN
operator|,
name|ah
operator|->
name|ah_resetCalValid
operator|=
name|ar5416ResetCalValid
operator|,
name|ah
operator|->
name|ah_setTxPowerLimit
operator|=
name|ar5416SetTxPowerLimit
expr_stmt|;
name|ah
operator|->
name|ah_setTxPower
operator|=
name|ar5416SetTransmitPower
expr_stmt|;
name|ah
operator|->
name|ah_setBoardValues
operator|=
name|ar5416SetBoardValues
expr_stmt|;
comment|/* Transmit functions */
name|ah
operator|->
name|ah_stopTxDma
operator|=
name|ar5416StopTxDma
expr_stmt|;
name|ah
operator|->
name|ah_setupTxDesc
operator|=
name|ar5416SetupTxDesc
expr_stmt|;
name|ah
operator|->
name|ah_setupXTxDesc
operator|=
name|ar5416SetupXTxDesc
expr_stmt|;
name|ah
operator|->
name|ah_fillTxDesc
operator|=
name|ar5416FillTxDesc
expr_stmt|;
name|ah
operator|->
name|ah_procTxDesc
operator|=
name|ar5416ProcTxDesc
expr_stmt|;
name|ah
operator|->
name|ah_getTxCompletionRates
operator|=
name|ar5416GetTxCompletionRates
expr_stmt|;
name|ah
operator|->
name|ah_setupTxQueue
operator|=
name|ar5416SetupTxQueue
expr_stmt|;
name|ah
operator|->
name|ah_resetTxQueue
operator|=
name|ar5416ResetTxQueue
expr_stmt|;
comment|/* Receive Functions */
name|ah
operator|->
name|ah_getRxFilter
operator|=
name|ar5416GetRxFilter
expr_stmt|;
name|ah
operator|->
name|ah_setRxFilter
operator|=
name|ar5416SetRxFilter
expr_stmt|;
name|ah
operator|->
name|ah_stopDmaReceive
operator|=
name|ar5416StopDmaReceive
expr_stmt|;
name|ah
operator|->
name|ah_startPcuReceive
operator|=
name|ar5416StartPcuReceive
expr_stmt|;
name|ah
operator|->
name|ah_stopPcuReceive
operator|=
name|ar5416StopPcuReceive
expr_stmt|;
name|ah
operator|->
name|ah_setupRxDesc
operator|=
name|ar5416SetupRxDesc
expr_stmt|;
name|ah
operator|->
name|ah_procRxDesc
operator|=
name|ar5416ProcRxDesc
expr_stmt|;
name|ah
operator|->
name|ah_rxMonitor
operator|=
name|ar5416RxMonitor
expr_stmt|;
name|ah
operator|->
name|ah_aniPoll
operator|=
name|ar5416AniPoll
expr_stmt|;
name|ah
operator|->
name|ah_procMibEvent
operator|=
name|ar5416ProcessMibIntr
expr_stmt|;
comment|/* Misc Functions */
name|ah
operator|->
name|ah_getCapability
operator|=
name|ar5416GetCapability
expr_stmt|;
name|ah
operator|->
name|ah_setCapability
operator|=
name|ar5416SetCapability
expr_stmt|;
name|ah
operator|->
name|ah_getDiagState
operator|=
name|ar5416GetDiagState
expr_stmt|;
name|ah
operator|->
name|ah_setLedState
operator|=
name|ar5416SetLedState
expr_stmt|;
name|ah
operator|->
name|ah_gpioCfgOutput
operator|=
name|ar5416GpioCfgOutput
expr_stmt|;
name|ah
operator|->
name|ah_gpioCfgInput
operator|=
name|ar5416GpioCfgInput
expr_stmt|;
name|ah
operator|->
name|ah_gpioGet
operator|=
name|ar5416GpioGet
expr_stmt|;
name|ah
operator|->
name|ah_gpioSet
operator|=
name|ar5416GpioSet
expr_stmt|;
name|ah
operator|->
name|ah_gpioSetIntr
operator|=
name|ar5416GpioSetIntr
expr_stmt|;
name|ah
operator|->
name|ah_getTsf64
operator|=
name|ar5416GetTsf64
expr_stmt|;
name|ah
operator|->
name|ah_resetTsf
operator|=
name|ar5416ResetTsf
expr_stmt|;
name|ah
operator|->
name|ah_getRfGain
operator|=
name|ar5416GetRfgain
expr_stmt|;
name|ah
operator|->
name|ah_setAntennaSwitch
operator|=
name|ar5416SetAntennaSwitch
expr_stmt|;
name|ah
operator|->
name|ah_setDecompMask
operator|=
name|ar5416SetDecompMask
expr_stmt|;
name|ah
operator|->
name|ah_setCoverageClass
operator|=
name|ar5416SetCoverageClass
expr_stmt|;
name|ah
operator|->
name|ah_setQuiet
operator|=
name|ar5416SetQuiet
expr_stmt|;
name|ah
operator|->
name|ah_getMibCycleCounts
operator|=
name|ar5416GetMibCycleCounts
expr_stmt|;
name|ah
operator|->
name|ah_resetKeyCacheEntry
operator|=
name|ar5416ResetKeyCacheEntry
expr_stmt|;
name|ah
operator|->
name|ah_setKeyCacheEntry
operator|=
name|ar5416SetKeyCacheEntry
expr_stmt|;
comment|/* DFS Functions */
name|ah
operator|->
name|ah_enableDfs
operator|=
name|ar5416EnableDfs
expr_stmt|;
name|ah
operator|->
name|ah_getDfsThresh
operator|=
name|ar5416GetDfsThresh
expr_stmt|;
name|ah
operator|->
name|ah_procRadarEvent
operator|=
name|ar5416ProcessRadarEvent
expr_stmt|;
name|ah
operator|->
name|ah_isFastClockEnabled
operator|=
name|ar5416IsFastClockEnabled
expr_stmt|;
comment|/* Power Management Functions */
name|ah
operator|->
name|ah_setPowerMode
operator|=
name|ar5416SetPowerMode
expr_stmt|;
comment|/* Beacon Management Functions */
name|ah
operator|->
name|ah_setBeaconTimers
operator|=
name|ar5416SetBeaconTimers
expr_stmt|;
name|ah
operator|->
name|ah_beaconInit
operator|=
name|ar5416BeaconInit
expr_stmt|;
name|ah
operator|->
name|ah_setStationBeaconTimers
operator|=
name|ar5416SetStaBeaconTimers
expr_stmt|;
name|ah
operator|->
name|ah_resetStationBeaconTimers
operator|=
name|ar5416ResetStaBeaconTimers
expr_stmt|;
name|ah
operator|->
name|ah_getNextTBTT
operator|=
name|ar5416GetNextTBTT
expr_stmt|;
comment|/* 802.11n Functions */
name|ah
operator|->
name|ah_chainTxDesc
operator|=
name|ar5416ChainTxDesc
expr_stmt|;
name|ah
operator|->
name|ah_setupFirstTxDesc
operator|=
name|ar5416SetupFirstTxDesc
expr_stmt|;
name|ah
operator|->
name|ah_setupLastTxDesc
operator|=
name|ar5416SetupLastTxDesc
expr_stmt|;
name|ah
operator|->
name|ah_set11nRateScenario
operator|=
name|ar5416Set11nRateScenario
expr_stmt|;
name|ah
operator|->
name|ah_set11nAggrFirst
operator|=
name|ar5416Set11nAggrFirst
expr_stmt|;
name|ah
operator|->
name|ah_set11nAggrMiddle
operator|=
name|ar5416Set11nAggrMiddle
expr_stmt|;
name|ah
operator|->
name|ah_set11nAggrLast
operator|=
name|ar5416Set11nAggrLast
expr_stmt|;
name|ah
operator|->
name|ah_clr11nAggr
operator|=
name|ar5416Clr11nAggr
expr_stmt|;
name|ah
operator|->
name|ah_set11nBurstDuration
operator|=
name|ar5416Set11nBurstDuration
expr_stmt|;
name|ah
operator|->
name|ah_get11nExtBusy
operator|=
name|ar5416Get11nExtBusy
expr_stmt|;
name|ah
operator|->
name|ah_set11nMac2040
operator|=
name|ar5416Set11nMac2040
expr_stmt|;
name|ah
operator|->
name|ah_get11nRxClear
operator|=
name|ar5416Get11nRxClear
expr_stmt|;
name|ah
operator|->
name|ah_set11nRxClear
operator|=
name|ar5416Set11nRxClear
expr_stmt|;
comment|/* Interrupt functions */
name|ah
operator|->
name|ah_isInterruptPending
operator|=
name|ar5416IsInterruptPending
expr_stmt|;
name|ah
operator|->
name|ah_getPendingInterrupts
operator|=
name|ar5416GetPendingInterrupts
expr_stmt|;
name|ah
operator|->
name|ah_setInterrupts
operator|=
name|ar5416SetInterrupts
expr_stmt|;
name|ahp
operator|->
name|ah_priv
operator|.
name|ah_getWirelessModes
operator|=
name|ar5416GetWirelessModes
expr_stmt|;
name|ahp
operator|->
name|ah_priv
operator|.
name|ah_eepromRead
operator|=
name|ar5416EepromRead
expr_stmt|;
ifdef|#
directive|ifdef
name|AH_SUPPORT_WRITE_EEPROM
name|ahp
operator|->
name|ah_priv
operator|.
name|ah_eepromWrite
operator|=
name|ar5416EepromWrite
expr_stmt|;
endif|#
directive|endif
name|ahp
operator|->
name|ah_priv
operator|.
name|ah_getChipPowerLimits
operator|=
name|ar5416GetChipPowerLimits
expr_stmt|;
comment|/* Internal ops */
name|AH5416
argument_list|(
name|ah
argument_list|)
operator|->
name|ah_writeIni
operator|=
name|ar5416WriteIni
expr_stmt|;
name|AH5416
argument_list|(
name|ah
argument_list|)
operator|->
name|ah_spurMitigate
operator|=
name|ar5416SpurMitigate
expr_stmt|;
comment|/* Internal baseband ops */
name|AH5416
argument_list|(
name|ah
argument_list|)
operator|->
name|ah_initPLL
operator|=
name|ar5416InitPLL
expr_stmt|;
comment|/* Internal calibration ops */
name|AH5416
argument_list|(
name|ah
argument_list|)
operator|->
name|ah_cal_initcal
operator|=
name|ar5416InitCalHardware
expr_stmt|;
comment|/* Internal TX power control related operations */
name|AH5416
argument_list|(
name|ah
argument_list|)
operator|->
name|ah_olcInit
operator|=
name|ar5416olcInit
expr_stmt|;
name|AH5416
argument_list|(
name|ah
argument_list|)
operator|->
name|ah_olcTempCompensation
operator|=
name|ar5416olcTempCompensation
expr_stmt|;
name|AH5416
argument_list|(
name|ah
argument_list|)
operator|->
name|ah_setPowerCalTable
operator|=
name|ar5416SetPowerCalTable
expr_stmt|;
comment|/* 	 * Start by setting all Owl devices to 2x2 	 */
name|AH5416
argument_list|(
name|ah
argument_list|)
operator|->
name|ah_rx_chainmask
operator|=
name|AR5416_DEFAULT_RXCHAINMASK
expr_stmt|;
name|AH5416
argument_list|(
name|ah
argument_list|)
operator|->
name|ah_tx_chainmask
operator|=
name|AR5416_DEFAULT_TXCHAINMASK
expr_stmt|;
comment|/* Enable all ANI functions to begin with */
name|AH5416
argument_list|(
name|ah
argument_list|)
operator|->
name|ah_ani_function
operator|=
literal|0xffffffff
expr_stmt|;
comment|/* Set overridable ANI methods */
name|AH5212
argument_list|(
name|ah
argument_list|)
operator|->
name|ah_aniControl
operator|=
name|ar5416AniControl
expr_stmt|;
block|}
end_function

begin_function
name|uint32_t
name|ar5416GetRadioRev
parameter_list|(
name|struct
name|ath_hal
modifier|*
name|ah
parameter_list|)
block|{
name|uint32_t
name|val
decl_stmt|;
name|int
name|i
decl_stmt|;
comment|/* Read Radio Chip Rev Extract */
name|OS_REG_WRITE
argument_list|(
name|ah
argument_list|,
name|AR_PHY
argument_list|(
literal|0x36
argument_list|)
argument_list|,
literal|0x00007058
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|8
condition|;
name|i
operator|++
control|)
name|OS_REG_WRITE
argument_list|(
name|ah
argument_list|,
name|AR_PHY
argument_list|(
literal|0x20
argument_list|)
argument_list|,
literal|0x00010000
argument_list|)
expr_stmt|;
name|val
operator|=
operator|(
name|OS_REG_READ
argument_list|(
name|ah
argument_list|,
name|AR_PHY
argument_list|(
literal|256
argument_list|)
argument_list|)
operator|>>
literal|24
operator|)
operator|&
literal|0xff
expr_stmt|;
name|val
operator|=
operator|(
operator|(
name|val
operator|&
literal|0xf0
operator|)
operator|>>
literal|4
operator|)
operator||
operator|(
operator|(
name|val
operator|&
literal|0x0f
operator|)
operator|<<
literal|4
operator|)
expr_stmt|;
return|return
name|ath_hal_reverseBits
argument_list|(
name|val
argument_list|,
literal|8
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/*  * Attach for an AR5416 part.  */
end_comment

begin_function
specifier|static
name|struct
name|ath_hal
modifier|*
name|ar5416Attach
parameter_list|(
name|uint16_t
name|devid
parameter_list|,
name|HAL_SOFTC
name|sc
parameter_list|,
name|HAL_BUS_TAG
name|st
parameter_list|,
name|HAL_BUS_HANDLE
name|sh
parameter_list|,
name|uint16_t
modifier|*
name|eepromdata
parameter_list|,
name|HAL_STATUS
modifier|*
name|status
parameter_list|)
block|{
name|struct
name|ath_hal_5416
modifier|*
name|ahp5416
decl_stmt|;
name|struct
name|ath_hal_5212
modifier|*
name|ahp
decl_stmt|;
name|struct
name|ath_hal
modifier|*
name|ah
decl_stmt|;
name|uint32_t
name|val
decl_stmt|;
name|HAL_STATUS
name|ecode
decl_stmt|;
name|HAL_BOOL
name|rfStatus
decl_stmt|;
name|HALDEBUG
argument_list|(
name|AH_NULL
argument_list|,
name|HAL_DEBUG_ATTACH
argument_list|,
literal|"%s: sc %p st %p sh %p\n"
argument_list|,
name|__func__
argument_list|,
name|sc
argument_list|,
operator|(
name|void
operator|*
operator|)
name|st
argument_list|,
operator|(
name|void
operator|*
operator|)
name|sh
argument_list|)
expr_stmt|;
comment|/* NB: memory is returned zero'd */
name|ahp5416
operator|=
name|ath_hal_malloc
argument_list|(
sizeof|sizeof
argument_list|(
expr|struct
name|ath_hal_5416
argument_list|)
operator|+
comment|/* extra space for Owl 2.1/2.2 WAR */
sizeof|sizeof
argument_list|(
name|ar5416Addac
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|ahp5416
operator|==
name|AH_NULL
condition|)
block|{
name|HALDEBUG
argument_list|(
name|AH_NULL
argument_list|,
name|HAL_DEBUG_ANY
argument_list|,
literal|"%s: cannot allocate memory for state block\n"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
operator|*
name|status
operator|=
name|HAL_ENOMEM
expr_stmt|;
return|return
name|AH_NULL
return|;
block|}
name|ar5416InitState
argument_list|(
name|ahp5416
argument_list|,
name|devid
argument_list|,
name|sc
argument_list|,
name|st
argument_list|,
name|sh
argument_list|,
name|status
argument_list|)
expr_stmt|;
name|ahp
operator|=
operator|&
name|ahp5416
operator|->
name|ah_5212
expr_stmt|;
name|ah
operator|=
operator|&
name|ahp
operator|->
name|ah_priv
operator|.
name|h
expr_stmt|;
if|if
condition|(
operator|!
name|ar5416SetResetReg
argument_list|(
name|ah
argument_list|,
name|HAL_RESET_POWER_ON
argument_list|)
condition|)
block|{
comment|/* reset chip */
name|HALDEBUG
argument_list|(
name|ah
argument_list|,
name|HAL_DEBUG_ANY
argument_list|,
literal|"%s: couldn't reset chip\n"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
name|ecode
operator|=
name|HAL_EIO
expr_stmt|;
goto|goto
name|bad
goto|;
block|}
if|if
condition|(
operator|!
name|ar5416SetPowerMode
argument_list|(
name|ah
argument_list|,
name|HAL_PM_AWAKE
argument_list|,
name|AH_TRUE
argument_list|)
condition|)
block|{
name|HALDEBUG
argument_list|(
name|ah
argument_list|,
name|HAL_DEBUG_ANY
argument_list|,
literal|"%s: couldn't wakeup chip\n"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
name|ecode
operator|=
name|HAL_EIO
expr_stmt|;
goto|goto
name|bad
goto|;
block|}
comment|/* Read Revisions from Chips before taking out of reset */
name|val
operator|=
name|OS_REG_READ
argument_list|(
name|ah
argument_list|,
name|AR_SREV
argument_list|)
operator|&
name|AR_SREV_ID
expr_stmt|;
name|AH_PRIVATE
argument_list|(
name|ah
argument_list|)
operator|->
name|ah_macVersion
operator|=
name|val
operator|>>
name|AR_SREV_ID_S
expr_stmt|;
name|AH_PRIVATE
argument_list|(
name|ah
argument_list|)
operator|->
name|ah_macRev
operator|=
name|val
operator|&
name|AR_SREV_REVISION
expr_stmt|;
name|AH_PRIVATE
argument_list|(
name|ah
argument_list|)
operator|->
name|ah_ispcie
operator|=
operator|(
name|devid
operator|==
name|AR5416_DEVID_PCIE
operator|)
expr_stmt|;
comment|/* setup common ini data; rf backends handle remainder */
name|HAL_INI_INIT
argument_list|(
operator|&
name|ahp
operator|->
name|ah_ini_modes
argument_list|,
name|ar5416Modes
argument_list|,
literal|6
argument_list|)
expr_stmt|;
name|HAL_INI_INIT
argument_list|(
operator|&
name|ahp
operator|->
name|ah_ini_common
argument_list|,
name|ar5416Common
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|HAL_INI_INIT
argument_list|(
operator|&
name|AH5416
argument_list|(
name|ah
argument_list|)
operator|->
name|ah_ini_bb_rfgain
argument_list|,
name|ar5416BB_RfGain
argument_list|,
literal|3
argument_list|)
expr_stmt|;
name|HAL_INI_INIT
argument_list|(
operator|&
name|AH5416
argument_list|(
name|ah
argument_list|)
operator|->
name|ah_ini_bank0
argument_list|,
name|ar5416Bank0
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|HAL_INI_INIT
argument_list|(
operator|&
name|AH5416
argument_list|(
name|ah
argument_list|)
operator|->
name|ah_ini_bank1
argument_list|,
name|ar5416Bank1
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|HAL_INI_INIT
argument_list|(
operator|&
name|AH5416
argument_list|(
name|ah
argument_list|)
operator|->
name|ah_ini_bank2
argument_list|,
name|ar5416Bank2
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|HAL_INI_INIT
argument_list|(
operator|&
name|AH5416
argument_list|(
name|ah
argument_list|)
operator|->
name|ah_ini_bank3
argument_list|,
name|ar5416Bank3
argument_list|,
literal|3
argument_list|)
expr_stmt|;
name|HAL_INI_INIT
argument_list|(
operator|&
name|AH5416
argument_list|(
name|ah
argument_list|)
operator|->
name|ah_ini_bank6
argument_list|,
name|ar5416Bank6
argument_list|,
literal|3
argument_list|)
expr_stmt|;
name|HAL_INI_INIT
argument_list|(
operator|&
name|AH5416
argument_list|(
name|ah
argument_list|)
operator|->
name|ah_ini_bank7
argument_list|,
name|ar5416Bank7
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|HAL_INI_INIT
argument_list|(
operator|&
name|AH5416
argument_list|(
name|ah
argument_list|)
operator|->
name|ah_ini_addac
argument_list|,
name|ar5416Addac
argument_list|,
literal|2
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|IS_5416V2_2
argument_list|(
name|ah
argument_list|)
condition|)
block|{
comment|/* Owl 2.1/2.0 */
name|ath_hal_printf
argument_list|(
name|ah
argument_list|,
literal|"[ath] Enabling CLKDRV workaround for AR5416< v2.2\n"
argument_list|)
expr_stmt|;
struct|struct
name|ini
block|{
name|uint32_t
modifier|*
name|data
decl_stmt|;
comment|/* NB: !const */
name|int
name|rows
decl_stmt|,
name|cols
decl_stmt|;
block|}
struct|;
comment|/* override CLKDRV value */
name|OS_MEMCPY
argument_list|(
operator|&
name|AH5416
argument_list|(
name|ah
argument_list|)
index|[
literal|1
index|]
argument_list|,
name|ar5416Addac
argument_list|,
sizeof|sizeof
argument_list|(
name|ar5416Addac
argument_list|)
argument_list|)
expr_stmt|;
name|AH5416
argument_list|(
name|ah
argument_list|)
operator|->
name|ah_ini_addac
operator|.
name|data
operator|=
operator|(
name|uint32_t
operator|*
operator|)
operator|&
name|AH5416
argument_list|(
name|ah
argument_list|)
index|[
literal|1
index|]
expr_stmt|;
name|HAL_INI_VAL
argument_list|(
operator|(
expr|struct
name|ini
operator|*
operator|)
operator|&
name|AH5416
argument_list|(
name|ah
argument_list|)
operator|->
name|ah_ini_addac
argument_list|,
literal|31
argument_list|,
literal|1
argument_list|)
operator|=
literal|0
expr_stmt|;
block|}
name|HAL_INI_INIT
argument_list|(
operator|&
name|AH5416
argument_list|(
name|ah
argument_list|)
operator|->
name|ah_ini_pcieserdes
argument_list|,
name|ar5416PciePhy
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|ar5416AttachPCIE
argument_list|(
name|ah
argument_list|)
expr_stmt|;
name|ecode
operator|=
name|ath_hal_v14EepromAttach
argument_list|(
name|ah
argument_list|)
expr_stmt|;
if|if
condition|(
name|ecode
operator|!=
name|HAL_OK
condition|)
goto|goto
name|bad
goto|;
if|if
condition|(
operator|!
name|ar5416ChipReset
argument_list|(
name|ah
argument_list|,
name|AH_NULL
argument_list|)
condition|)
block|{
comment|/* reset chip */
name|HALDEBUG
argument_list|(
name|ah
argument_list|,
name|HAL_DEBUG_ANY
argument_list|,
literal|"%s: chip reset failed\n"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
name|ecode
operator|=
name|HAL_EIO
expr_stmt|;
goto|goto
name|bad
goto|;
block|}
name|AH_PRIVATE
argument_list|(
name|ah
argument_list|)
operator|->
name|ah_phyRev
operator|=
name|OS_REG_READ
argument_list|(
name|ah
argument_list|,
name|AR_PHY_CHIP_ID
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|ar5212ChipTest
argument_list|(
name|ah
argument_list|)
condition|)
block|{
name|HALDEBUG
argument_list|(
name|ah
argument_list|,
name|HAL_DEBUG_ANY
argument_list|,
literal|"%s: hardware self-test failed\n"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
name|ecode
operator|=
name|HAL_ESELFTEST
expr_stmt|;
goto|goto
name|bad
goto|;
block|}
comment|/* 	 * Set correct Baseband to analog shift 	 * setting to access analog chips. 	 */
name|OS_REG_WRITE
argument_list|(
name|ah
argument_list|,
name|AR_PHY
argument_list|(
literal|0
argument_list|)
argument_list|,
literal|0x00000007
argument_list|)
expr_stmt|;
comment|/* Read Radio Chip Rev Extract */
name|AH_PRIVATE
argument_list|(
name|ah
argument_list|)
operator|->
name|ah_analog5GhzRev
operator|=
name|ar5416GetRadioRev
argument_list|(
name|ah
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|AH_PRIVATE
argument_list|(
name|ah
argument_list|)
operator|->
name|ah_analog5GhzRev
operator|&
name|AR_RADIO_SREV_MAJOR
condition|)
block|{
case|case
name|AR_RAD5122_SREV_MAJOR
case|:
comment|/* Fowl: 5G/2x2 */
case|case
name|AR_RAD2122_SREV_MAJOR
case|:
comment|/* Fowl: 2+5G/2x2 */
case|case
name|AR_RAD2133_SREV_MAJOR
case|:
comment|/* Fowl: 2G/3x3 */
case|case
name|AR_RAD5133_SREV_MAJOR
case|:
comment|/* Fowl: 2+5G/3x3 */
break|break;
default|default:
if|if
condition|(
name|AH_PRIVATE
argument_list|(
name|ah
argument_list|)
operator|->
name|ah_analog5GhzRev
operator|==
literal|0
condition|)
block|{
comment|/* 			 * When RF_Silen is used the analog chip is reset. 			 * So when the system boots with radio switch off 			 * the RF chip rev reads back as zero and we need 			 * to use the mac+phy revs to set the radio rev. 			 */
name|AH_PRIVATE
argument_list|(
name|ah
argument_list|)
operator|->
name|ah_analog5GhzRev
operator|=
name|AR_RAD5133_SREV_MAJOR
expr_stmt|;
break|break;
block|}
comment|/* NB: silently accept anything in release code per Atheros */
ifdef|#
directive|ifdef
name|AH_DEBUG
name|HALDEBUG
argument_list|(
name|ah
argument_list|,
name|HAL_DEBUG_ANY
argument_list|,
literal|"%s: 5G Radio Chip Rev 0x%02X is not supported by "
literal|"this driver\n"
argument_list|,
name|__func__
argument_list|,
name|AH_PRIVATE
argument_list|(
name|ah
argument_list|)
operator|->
name|ah_analog5GhzRev
argument_list|)
expr_stmt|;
name|ecode
operator|=
name|HAL_ENOTSUPP
expr_stmt|;
goto|goto
name|bad
goto|;
endif|#
directive|endif
block|}
comment|/* 	 * Got everything we need now to setup the capabilities. 	 */
if|if
condition|(
operator|!
name|ar5416FillCapabilityInfo
argument_list|(
name|ah
argument_list|)
condition|)
block|{
name|ecode
operator|=
name|HAL_EEREAD
expr_stmt|;
goto|goto
name|bad
goto|;
block|}
name|ecode
operator|=
name|ath_hal_eepromGet
argument_list|(
name|ah
argument_list|,
name|AR_EEP_MACADDR
argument_list|,
name|ahp
operator|->
name|ah_macaddr
argument_list|)
expr_stmt|;
if|if
condition|(
name|ecode
operator|!=
name|HAL_OK
condition|)
block|{
name|HALDEBUG
argument_list|(
name|ah
argument_list|,
name|HAL_DEBUG_ANY
argument_list|,
literal|"%s: error getting mac address from EEPROM\n"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
goto|goto
name|bad
goto|;
block|}
comment|/* XXX How about the serial number ? */
comment|/* Read Reg Domain */
name|AH_PRIVATE
argument_list|(
name|ah
argument_list|)
operator|->
name|ah_currentRD
operator|=
name|ath_hal_eepromGet
argument_list|(
name|ah
argument_list|,
name|AR_EEP_REGDMN_0
argument_list|,
name|AH_NULL
argument_list|)
expr_stmt|;
name|AH_PRIVATE
argument_list|(
name|ah
argument_list|)
operator|->
name|ah_currentRDext
operator|=
name|ath_hal_eepromGet
argument_list|(
name|ah
argument_list|,
name|AR_EEP_REGDMN_1
argument_list|,
name|AH_NULL
argument_list|)
expr_stmt|;
comment|/* 	 * ah_miscMode is populated by ar5416FillCapabilityInfo() 	 * starting from griffin. Set here to make sure that 	 * AR_MISC_MODE_MIC_NEW_LOC_ENABLE is set before a GTK is 	 * placed into hardware. 	 */
if|if
condition|(
name|ahp
operator|->
name|ah_miscMode
operator|!=
literal|0
condition|)
name|OS_REG_WRITE
argument_list|(
name|ah
argument_list|,
name|AR_MISC_MODE
argument_list|,
name|OS_REG_READ
argument_list|(
name|ah
argument_list|,
name|AR_MISC_MODE
argument_list|)
operator||
name|ahp
operator|->
name|ah_miscMode
argument_list|)
expr_stmt|;
name|rfStatus
operator|=
name|ar2133RfAttach
argument_list|(
name|ah
argument_list|,
operator|&
name|ecode
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|rfStatus
condition|)
block|{
name|HALDEBUG
argument_list|(
name|ah
argument_list|,
name|HAL_DEBUG_ANY
argument_list|,
literal|"%s: RF setup failed, status %u\n"
argument_list|,
name|__func__
argument_list|,
name|ecode
argument_list|)
expr_stmt|;
goto|goto
name|bad
goto|;
block|}
name|ar5416AniSetup
argument_list|(
name|ah
argument_list|)
expr_stmt|;
comment|/* Anti Noise Immunity */
name|AH5416
argument_list|(
name|ah
argument_list|)
operator|->
name|nf_2g
operator|.
name|max
operator|=
name|AR_PHY_CCA_MAX_GOOD_VAL_5416_2GHZ
expr_stmt|;
name|AH5416
argument_list|(
name|ah
argument_list|)
operator|->
name|nf_2g
operator|.
name|min
operator|=
name|AR_PHY_CCA_MIN_GOOD_VAL_5416_2GHZ
expr_stmt|;
name|AH5416
argument_list|(
name|ah
argument_list|)
operator|->
name|nf_2g
operator|.
name|nominal
operator|=
name|AR_PHY_CCA_NOM_VAL_5416_2GHZ
expr_stmt|;
name|AH5416
argument_list|(
name|ah
argument_list|)
operator|->
name|nf_5g
operator|.
name|max
operator|=
name|AR_PHY_CCA_MAX_GOOD_VAL_5416_5GHZ
expr_stmt|;
name|AH5416
argument_list|(
name|ah
argument_list|)
operator|->
name|nf_5g
operator|.
name|min
operator|=
name|AR_PHY_CCA_MIN_GOOD_VAL_5416_5GHZ
expr_stmt|;
name|AH5416
argument_list|(
name|ah
argument_list|)
operator|->
name|nf_5g
operator|.
name|nominal
operator|=
name|AR_PHY_CCA_NOM_VAL_5416_5GHZ
expr_stmt|;
name|ar5416InitNfHistBuff
argument_list|(
name|AH5416
argument_list|(
name|ah
argument_list|)
operator|->
name|ah_cal
operator|.
name|nfCalHist
argument_list|)
expr_stmt|;
name|HALDEBUG
argument_list|(
name|ah
argument_list|,
name|HAL_DEBUG_ATTACH
argument_list|,
literal|"%s: return\n"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
return|return
name|ah
return|;
name|bad
label|:
if|if
condition|(
name|ahp
condition|)
name|ar5416Detach
argument_list|(
operator|(
expr|struct
name|ath_hal
operator|*
operator|)
name|ahp
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
condition|)
operator|*
name|status
operator|=
name|ecode
expr_stmt|;
return|return
name|AH_NULL
return|;
block|}
end_function

begin_function
name|void
name|ar5416Detach
parameter_list|(
name|struct
name|ath_hal
modifier|*
name|ah
parameter_list|)
block|{
name|HALDEBUG
argument_list|(
name|ah
argument_list|,
name|HAL_DEBUG_ATTACH
argument_list|,
literal|"%s:\n"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
name|HALASSERT
argument_list|(
name|ah
operator|!=
name|AH_NULL
argument_list|)
expr_stmt|;
name|HALASSERT
argument_list|(
name|ah
operator|->
name|ah_magic
operator|==
name|AR5416_MAGIC
argument_list|)
expr_stmt|;
comment|/* Make sure that chip is awake before writing to it */
if|if
condition|(
operator|!
name|ar5416SetPowerMode
argument_list|(
name|ah
argument_list|,
name|HAL_PM_AWAKE
argument_list|,
name|AH_TRUE
argument_list|)
condition|)
name|HALDEBUG
argument_list|(
name|ah
argument_list|,
name|HAL_DEBUG_UNMASKABLE
argument_list|,
literal|"%s: failed to wake up chip\n"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
name|ar5416AniDetach
argument_list|(
name|ah
argument_list|)
expr_stmt|;
name|ar5212RfDetach
argument_list|(
name|ah
argument_list|)
expr_stmt|;
name|ah
operator|->
name|ah_disable
argument_list|(
name|ah
argument_list|)
expr_stmt|;
name|ar5416SetPowerMode
argument_list|(
name|ah
argument_list|,
name|HAL_PM_FULL_SLEEP
argument_list|,
name|AH_TRUE
argument_list|)
expr_stmt|;
name|ath_hal_eepromDetach
argument_list|(
name|ah
argument_list|)
expr_stmt|;
name|ath_hal_free
argument_list|(
name|ah
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|ar5416AttachPCIE
parameter_list|(
name|struct
name|ath_hal
modifier|*
name|ah
parameter_list|)
block|{
if|if
condition|(
name|AH_PRIVATE
argument_list|(
name|ah
argument_list|)
operator|->
name|ah_ispcie
condition|)
name|ath_hal_configPCIE
argument_list|(
name|ah
argument_list|,
name|AH_FALSE
argument_list|,
name|AH_FALSE
argument_list|)
expr_stmt|;
else|else
name|ath_hal_disablePCIE
argument_list|(
name|ah
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|ar5416ConfigPCIE
parameter_list|(
name|struct
name|ath_hal
modifier|*
name|ah
parameter_list|,
name|HAL_BOOL
name|restore
parameter_list|,
name|HAL_BOOL
name|power_off
parameter_list|)
block|{
comment|/* This is only applicable for AR5418 (AR5416 PCIe) */
if|if
condition|(
operator|!
name|AH_PRIVATE
argument_list|(
name|ah
argument_list|)
operator|->
name|ah_ispcie
condition|)
return|return;
if|if
condition|(
operator|!
name|restore
condition|)
block|{
name|ath_hal_ini_write
argument_list|(
name|ah
argument_list|,
operator|&
name|AH5416
argument_list|(
name|ah
argument_list|)
operator|->
name|ah_ini_pcieserdes
argument_list|,
literal|1
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|OS_DELAY
argument_list|(
literal|1000
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|power_off
condition|)
block|{
comment|/* Power-off */
comment|/* clear bit 19 to disable L1 */
name|OS_REG_CLR_BIT
argument_list|(
name|ah
argument_list|,
name|AR_PCIE_PM_CTRL
argument_list|,
name|AR_PCIE_PM_CTRL_ENA
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|/* Power-on */
comment|/* Set default WAR values for Owl */
name|OS_REG_WRITE
argument_list|(
name|ah
argument_list|,
name|AR_WA
argument_list|,
name|AR_WA_DEFAULT
argument_list|)
expr_stmt|;
comment|/* set bit 19 to allow forcing of pcie core into L1 state */
name|OS_REG_SET_BIT
argument_list|(
name|ah
argument_list|,
name|AR_PCIE_PM_CTRL
argument_list|,
name|AR_PCIE_PM_CTRL_ENA
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/*  * Disable PCIe PHY if PCIe isn't used.  */
end_comment

begin_function
specifier|static
name|void
name|ar5416DisablePCIE
parameter_list|(
name|struct
name|ath_hal
modifier|*
name|ah
parameter_list|)
block|{
comment|/* PCIe? Don't */
if|if
condition|(
name|AH_PRIVATE
argument_list|(
name|ah
argument_list|)
operator|->
name|ah_ispcie
condition|)
return|return;
comment|/* .. Only applicable for AR5416v2 or later */
if|if
condition|(
operator|!
operator|(
name|AR_SREV_OWL
argument_list|(
name|ah
argument_list|)
operator|&&
name|AR_SREV_OWL_20_OR_LATER
argument_list|(
name|ah
argument_list|)
operator|)
condition|)
return|return;
name|OS_REG_WRITE_BUFFER_ENABLE
argument_list|(
name|ah
argument_list|)
expr_stmt|;
comment|/* 	 * Disable the PCIe PHY. 	 */
name|OS_REG_WRITE
argument_list|(
name|ah
argument_list|,
name|AR_PCIE_SERDES
argument_list|,
literal|0x9248fc00
argument_list|)
expr_stmt|;
name|OS_REG_WRITE
argument_list|(
name|ah
argument_list|,
name|AR_PCIE_SERDES
argument_list|,
literal|0x24924924
argument_list|)
expr_stmt|;
name|OS_REG_WRITE
argument_list|(
name|ah
argument_list|,
name|AR_PCIE_SERDES
argument_list|,
literal|0x28000029
argument_list|)
expr_stmt|;
name|OS_REG_WRITE
argument_list|(
name|ah
argument_list|,
name|AR_PCIE_SERDES
argument_list|,
literal|0x57160824
argument_list|)
expr_stmt|;
name|OS_REG_WRITE
argument_list|(
name|ah
argument_list|,
name|AR_PCIE_SERDES
argument_list|,
literal|0x25980579
argument_list|)
expr_stmt|;
name|OS_REG_WRITE
argument_list|(
name|ah
argument_list|,
name|AR_PCIE_SERDES
argument_list|,
literal|0x00000000
argument_list|)
expr_stmt|;
name|OS_REG_WRITE
argument_list|(
name|ah
argument_list|,
name|AR_PCIE_SERDES
argument_list|,
literal|0x1aaabe40
argument_list|)
expr_stmt|;
name|OS_REG_WRITE
argument_list|(
name|ah
argument_list|,
name|AR_PCIE_SERDES
argument_list|,
literal|0xbe105554
argument_list|)
expr_stmt|;
name|OS_REG_WRITE
argument_list|(
name|ah
argument_list|,
name|AR_PCIE_SERDES
argument_list|,
literal|0x000e1007
argument_list|)
expr_stmt|;
comment|/* Load the new settings */
name|OS_REG_WRITE
argument_list|(
name|ah
argument_list|,
name|AR_PCIE_SERDES2
argument_list|,
literal|0x00000000
argument_list|)
expr_stmt|;
name|OS_REG_WRITE_BUFFER_FLUSH
argument_list|(
name|ah
argument_list|)
expr_stmt|;
name|OS_REG_WRITE_BUFFER_DISABLE
argument_list|(
name|ah
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|ar5416WriteIni
parameter_list|(
name|struct
name|ath_hal
modifier|*
name|ah
parameter_list|,
specifier|const
name|struct
name|ieee80211_channel
modifier|*
name|chan
parameter_list|)
block|{
name|u_int
name|modesIndex
decl_stmt|,
name|freqIndex
decl_stmt|;
name|int
name|regWrites
init|=
literal|0
decl_stmt|;
comment|/* Setup the indices for the next set of register array writes */
comment|/* XXX Ignore 11n dynamic mode on the AR5416 for the moment */
if|if
condition|(
name|IEEE80211_IS_CHAN_2GHZ
argument_list|(
name|chan
argument_list|)
condition|)
block|{
name|freqIndex
operator|=
literal|2
expr_stmt|;
if|if
condition|(
name|IEEE80211_IS_CHAN_HT40
argument_list|(
name|chan
argument_list|)
condition|)
name|modesIndex
operator|=
literal|3
expr_stmt|;
elseif|else
if|if
condition|(
name|IEEE80211_IS_CHAN_108G
argument_list|(
name|chan
argument_list|)
condition|)
name|modesIndex
operator|=
literal|5
expr_stmt|;
else|else
name|modesIndex
operator|=
literal|4
expr_stmt|;
block|}
else|else
block|{
name|freqIndex
operator|=
literal|1
expr_stmt|;
if|if
condition|(
name|IEEE80211_IS_CHAN_HT40
argument_list|(
name|chan
argument_list|)
operator|||
name|IEEE80211_IS_CHAN_TURBO
argument_list|(
name|chan
argument_list|)
condition|)
name|modesIndex
operator|=
literal|2
expr_stmt|;
else|else
name|modesIndex
operator|=
literal|1
expr_stmt|;
block|}
comment|/* Set correct Baseband to analog shift setting to access analog chips. */
name|OS_REG_WRITE
argument_list|(
name|ah
argument_list|,
name|AR_PHY
argument_list|(
literal|0
argument_list|)
argument_list|,
literal|0x00000007
argument_list|)
expr_stmt|;
comment|/* 	 * Write addac shifts 	 */
name|OS_REG_WRITE
argument_list|(
name|ah
argument_list|,
name|AR_PHY_ADC_SERIAL_CTL
argument_list|,
name|AR_PHY_SEL_EXTERNAL_RADIO
argument_list|)
expr_stmt|;
comment|/* NB: only required for Sowl */
if|if
condition|(
name|AR_SREV_SOWL
argument_list|(
name|ah
argument_list|)
condition|)
name|ar5416EepromSetAddac
argument_list|(
name|ah
argument_list|,
name|chan
argument_list|)
expr_stmt|;
name|regWrites
operator|=
name|ath_hal_ini_write
argument_list|(
name|ah
argument_list|,
operator|&
name|AH5416
argument_list|(
name|ah
argument_list|)
operator|->
name|ah_ini_addac
argument_list|,
literal|1
argument_list|,
name|regWrites
argument_list|)
expr_stmt|;
name|OS_REG_WRITE
argument_list|(
name|ah
argument_list|,
name|AR_PHY_ADC_SERIAL_CTL
argument_list|,
name|AR_PHY_SEL_INTERNAL_ADDAC
argument_list|)
expr_stmt|;
name|regWrites
operator|=
name|ath_hal_ini_write
argument_list|(
name|ah
argument_list|,
operator|&
name|AH5212
argument_list|(
name|ah
argument_list|)
operator|->
name|ah_ini_modes
argument_list|,
name|modesIndex
argument_list|,
name|regWrites
argument_list|)
expr_stmt|;
name|regWrites
operator|=
name|ath_hal_ini_write
argument_list|(
name|ah
argument_list|,
operator|&
name|AH5212
argument_list|(
name|ah
argument_list|)
operator|->
name|ah_ini_common
argument_list|,
literal|1
argument_list|,
name|regWrites
argument_list|)
expr_stmt|;
comment|/* XXX updated regWrites? */
name|AH5212
argument_list|(
name|ah
argument_list|)
operator|->
name|ah_rfHal
operator|->
name|writeRegs
argument_list|(
name|ah
argument_list|,
name|modesIndex
argument_list|,
name|freqIndex
argument_list|,
name|regWrites
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * Convert to baseband spur frequency given input channel frequency   * and compute register settings below.  */
end_comment

begin_function
specifier|static
name|void
name|ar5416SpurMitigate
parameter_list|(
name|struct
name|ath_hal
modifier|*
name|ah
parameter_list|,
specifier|const
name|struct
name|ieee80211_channel
modifier|*
name|chan
parameter_list|)
block|{
name|uint16_t
name|freq
init|=
name|ath_hal_gethwchannel
argument_list|(
name|ah
argument_list|,
name|chan
argument_list|)
decl_stmt|;
specifier|static
specifier|const
name|int
name|pilot_mask_reg
index|[
literal|4
index|]
init|=
block|{
name|AR_PHY_TIMING7
block|,
name|AR_PHY_TIMING8
block|,
name|AR_PHY_PILOT_MASK_01_30
block|,
name|AR_PHY_PILOT_MASK_31_60
block|}
decl_stmt|;
specifier|static
specifier|const
name|int
name|chan_mask_reg
index|[
literal|4
index|]
init|=
block|{
name|AR_PHY_TIMING9
block|,
name|AR_PHY_TIMING10
block|,
name|AR_PHY_CHANNEL_MASK_01_30
block|,
name|AR_PHY_CHANNEL_MASK_31_60
block|}
decl_stmt|;
specifier|static
specifier|const
name|int
name|inc
index|[
literal|4
index|]
init|=
block|{
literal|0
block|,
literal|100
block|,
literal|0
block|,
literal|0
block|}
decl_stmt|;
name|int
name|bb_spur
init|=
name|AR_NO_SPUR
decl_stmt|;
name|int
name|bin
decl_stmt|,
name|cur_bin
decl_stmt|;
name|int
name|spur_freq_sd
decl_stmt|;
name|int
name|spur_delta_phase
decl_stmt|;
name|int
name|denominator
decl_stmt|;
name|int
name|upper
decl_stmt|,
name|lower
decl_stmt|,
name|cur_vit_mask
decl_stmt|;
name|int
name|tmp
decl_stmt|,
name|new
decl_stmt|;
name|int
name|i
decl_stmt|;
name|int8_t
name|mask_m
index|[
literal|123
index|]
decl_stmt|;
name|int8_t
name|mask_p
index|[
literal|123
index|]
decl_stmt|;
name|int8_t
name|mask_amt
decl_stmt|;
name|int
name|tmp_mask
decl_stmt|;
name|int
name|cur_bb_spur
decl_stmt|;
name|HAL_BOOL
name|is2GHz
init|=
name|IEEE80211_IS_CHAN_2GHZ
argument_list|(
name|chan
argument_list|)
decl_stmt|;
name|OS_MEMZERO
argument_list|(
name|mask_m
argument_list|,
sizeof|sizeof
argument_list|(
name|mask_m
argument_list|)
argument_list|)
expr_stmt|;
name|OS_MEMZERO
argument_list|(
name|mask_p
argument_list|,
sizeof|sizeof
argument_list|(
name|mask_p
argument_list|)
argument_list|)
expr_stmt|;
comment|/*      * Need to verify range +/- 9.5 for static ht20, otherwise spur      * is out-of-band and can be ignored.      */
comment|/* XXX ath9k changes */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|AR5416_EEPROM_MODAL_SPURS
condition|;
name|i
operator|++
control|)
block|{
name|cur_bb_spur
operator|=
name|ath_hal_getSpurChan
argument_list|(
name|ah
argument_list|,
name|i
argument_list|,
name|is2GHz
argument_list|)
expr_stmt|;
if|if
condition|(
name|AR_NO_SPUR
operator|==
name|cur_bb_spur
condition|)
break|break;
name|cur_bb_spur
operator|=
name|cur_bb_spur
operator|-
operator|(
name|freq
operator|*
literal|10
operator|)
expr_stmt|;
if|if
condition|(
operator|(
name|cur_bb_spur
operator|>
operator|-
literal|95
operator|)
operator|&&
operator|(
name|cur_bb_spur
operator|<
literal|95
operator|)
condition|)
block|{
name|bb_spur
operator|=
name|cur_bb_spur
expr_stmt|;
break|break;
block|}
block|}
if|if
condition|(
name|AR_NO_SPUR
operator|==
name|bb_spur
condition|)
return|return;
name|bin
operator|=
name|bb_spur
operator|*
literal|32
expr_stmt|;
name|tmp
operator|=
name|OS_REG_READ
argument_list|(
name|ah
argument_list|,
name|AR_PHY_TIMING_CTRL4_CHAIN
argument_list|(
literal|0
argument_list|)
argument_list|)
expr_stmt|;
name|new
operator|=
name|tmp
operator||
operator|(
name|AR_PHY_TIMING_CTRL4_ENABLE_SPUR_RSSI
operator||
name|AR_PHY_TIMING_CTRL4_ENABLE_SPUR_FILTER
operator||
name|AR_PHY_TIMING_CTRL4_ENABLE_CHAN_MASK
operator||
name|AR_PHY_TIMING_CTRL4_ENABLE_PILOT_MASK
operator|)
expr_stmt|;
name|OS_REG_WRITE_BUFFER_ENABLE
argument_list|(
name|ah
argument_list|)
expr_stmt|;
name|OS_REG_WRITE
argument_list|(
name|ah
argument_list|,
name|AR_PHY_TIMING_CTRL4_CHAIN
argument_list|(
literal|0
argument_list|)
argument_list|,
name|new
argument_list|)
expr_stmt|;
name|new
operator|=
operator|(
name|AR_PHY_SPUR_REG_MASK_RATE_CNTL
operator||
name|AR_PHY_SPUR_REG_ENABLE_MASK_PPM
operator||
name|AR_PHY_SPUR_REG_MASK_RATE_SELECT
operator||
name|AR_PHY_SPUR_REG_ENABLE_VIT_SPUR_RSSI
operator||
name|SM
argument_list|(
name|AR5416_SPUR_RSSI_THRESH
argument_list|,
name|AR_PHY_SPUR_REG_SPUR_RSSI_THRESH
argument_list|)
operator|)
expr_stmt|;
name|OS_REG_WRITE
argument_list|(
name|ah
argument_list|,
name|AR_PHY_SPUR_REG
argument_list|,
name|new
argument_list|)
expr_stmt|;
comment|/*      * Should offset bb_spur by +/- 10 MHz for dynamic 2040 MHz      * config, no offset for HT20.      * spur_delta_phase = bb_spur/40 * 2**21 for static ht20,      * /80 for dyn2040.      */
name|spur_delta_phase
operator|=
operator|(
operator|(
name|bb_spur
operator|*
literal|524288
operator|)
operator|/
literal|100
operator|)
operator|&
name|AR_PHY_TIMING11_SPUR_DELTA_PHASE
expr_stmt|;
comment|/*      * in 11A mode the denominator of spur_freq_sd should be 40 and      * it should be 44 in 11G      */
name|denominator
operator|=
name|IEEE80211_IS_CHAN_2GHZ
argument_list|(
name|chan
argument_list|)
condition|?
literal|440
else|:
literal|400
expr_stmt|;
name|spur_freq_sd
operator|=
operator|(
operator|(
name|bb_spur
operator|*
literal|2048
operator|)
operator|/
name|denominator
operator|)
operator|&
literal|0x3ff
expr_stmt|;
name|new
operator|=
operator|(
name|AR_PHY_TIMING11_USE_SPUR_IN_AGC
operator||
name|SM
argument_list|(
name|spur_freq_sd
argument_list|,
name|AR_PHY_TIMING11_SPUR_FREQ_SD
argument_list|)
operator||
name|SM
argument_list|(
name|spur_delta_phase
argument_list|,
name|AR_PHY_TIMING11_SPUR_DELTA_PHASE
argument_list|)
operator|)
expr_stmt|;
name|OS_REG_WRITE
argument_list|(
name|ah
argument_list|,
name|AR_PHY_TIMING11
argument_list|,
name|new
argument_list|)
expr_stmt|;
comment|/*      * ============================================      * pilot mask 1 [31:0] = +6..-26, no 0 bin      * pilot mask 2 [19:0] = +26..+7      *      * channel mask 1 [31:0] = +6..-26, no 0 bin      * channel mask 2 [19:0] = +26..+7      */
comment|//cur_bin = -26;
name|cur_bin
operator|=
operator|-
literal|6000
expr_stmt|;
name|upper
operator|=
name|bin
operator|+
literal|100
expr_stmt|;
name|lower
operator|=
name|bin
operator|-
literal|100
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|4
condition|;
name|i
operator|++
control|)
block|{
name|int
name|pilot_mask
init|=
literal|0
decl_stmt|;
name|int
name|chan_mask
init|=
literal|0
decl_stmt|;
name|int
name|bp
init|=
literal|0
decl_stmt|;
for|for
control|(
name|bp
operator|=
literal|0
init|;
name|bp
operator|<
literal|30
condition|;
name|bp
operator|++
control|)
block|{
if|if
condition|(
operator|(
name|cur_bin
operator|>
name|lower
operator|)
operator|&&
operator|(
name|cur_bin
operator|<
name|upper
operator|)
condition|)
block|{
name|pilot_mask
operator|=
name|pilot_mask
operator||
literal|0x1
operator|<<
name|bp
expr_stmt|;
name|chan_mask
operator|=
name|chan_mask
operator||
literal|0x1
operator|<<
name|bp
expr_stmt|;
block|}
name|cur_bin
operator|+=
literal|100
expr_stmt|;
block|}
name|cur_bin
operator|+=
name|inc
index|[
name|i
index|]
expr_stmt|;
name|OS_REG_WRITE
argument_list|(
name|ah
argument_list|,
name|pilot_mask_reg
index|[
name|i
index|]
argument_list|,
name|pilot_mask
argument_list|)
expr_stmt|;
name|OS_REG_WRITE
argument_list|(
name|ah
argument_list|,
name|chan_mask_reg
index|[
name|i
index|]
argument_list|,
name|chan_mask
argument_list|)
expr_stmt|;
block|}
comment|/* =================================================      * viterbi mask 1 based on channel magnitude      * four levels 0-3      *  - mask (-27 to 27) (reg 64,0x9900 to 67,0x990c)      *      [1 2 2 1] for -9.6 or [1 2 1] for +16      *  - enable_mask_ppm, all bins move with freq      *      *  - mask_select,    8 bits for rates (reg 67,0x990c)      *  - mask_rate_cntl, 8 bits for rates (reg 67,0x990c)      *      choose which mask to use mask or mask2      */
comment|/*      * viterbi mask 2  2nd set for per data rate puncturing      * four levels 0-3      *  - mask_select, 8 bits for rates (reg 67)      *  - mask (-27 to 27) (reg 98,0x9988 to 101,0x9994)      *      [1 2 2 1] for -9.6 or [1 2 1] for +16      */
name|cur_vit_mask
operator|=
literal|6100
expr_stmt|;
name|upper
operator|=
name|bin
operator|+
literal|120
expr_stmt|;
name|lower
operator|=
name|bin
operator|-
literal|120
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|123
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
operator|(
name|cur_vit_mask
operator|>
name|lower
operator|)
operator|&&
operator|(
name|cur_vit_mask
operator|<
name|upper
operator|)
condition|)
block|{
if|if
condition|(
operator|(
name|abs
argument_list|(
name|cur_vit_mask
operator|-
name|bin
argument_list|)
operator|)
operator|<
literal|75
condition|)
block|{
name|mask_amt
operator|=
literal|1
expr_stmt|;
block|}
else|else
block|{
name|mask_amt
operator|=
literal|0
expr_stmt|;
block|}
if|if
condition|(
name|cur_vit_mask
operator|<
literal|0
condition|)
block|{
name|mask_m
index|[
name|abs
argument_list|(
name|cur_vit_mask
operator|/
literal|100
argument_list|)
index|]
operator|=
name|mask_amt
expr_stmt|;
block|}
else|else
block|{
name|mask_p
index|[
name|cur_vit_mask
operator|/
literal|100
index|]
operator|=
name|mask_amt
expr_stmt|;
block|}
block|}
name|cur_vit_mask
operator|-=
literal|100
expr_stmt|;
block|}
name|tmp_mask
operator|=
operator|(
name|mask_m
index|[
literal|46
index|]
operator|<<
literal|30
operator|)
operator||
operator|(
name|mask_m
index|[
literal|47
index|]
operator|<<
literal|28
operator|)
operator||
operator|(
name|mask_m
index|[
literal|48
index|]
operator|<<
literal|26
operator|)
operator||
operator|(
name|mask_m
index|[
literal|49
index|]
operator|<<
literal|24
operator|)
operator||
operator|(
name|mask_m
index|[
literal|50
index|]
operator|<<
literal|22
operator|)
operator||
operator|(
name|mask_m
index|[
literal|51
index|]
operator|<<
literal|20
operator|)
operator||
operator|(
name|mask_m
index|[
literal|52
index|]
operator|<<
literal|18
operator|)
operator||
operator|(
name|mask_m
index|[
literal|53
index|]
operator|<<
literal|16
operator|)
operator||
operator|(
name|mask_m
index|[
literal|54
index|]
operator|<<
literal|14
operator|)
operator||
operator|(
name|mask_m
index|[
literal|55
index|]
operator|<<
literal|12
operator|)
operator||
operator|(
name|mask_m
index|[
literal|56
index|]
operator|<<
literal|10
operator|)
operator||
operator|(
name|mask_m
index|[
literal|57
index|]
operator|<<
literal|8
operator|)
operator||
operator|(
name|mask_m
index|[
literal|58
index|]
operator|<<
literal|6
operator|)
operator||
operator|(
name|mask_m
index|[
literal|59
index|]
operator|<<
literal|4
operator|)
operator||
operator|(
name|mask_m
index|[
literal|60
index|]
operator|<<
literal|2
operator|)
operator||
operator|(
name|mask_m
index|[
literal|61
index|]
operator|<<
literal|0
operator|)
expr_stmt|;
name|OS_REG_WRITE
argument_list|(
name|ah
argument_list|,
name|AR_PHY_BIN_MASK_1
argument_list|,
name|tmp_mask
argument_list|)
expr_stmt|;
name|OS_REG_WRITE
argument_list|(
name|ah
argument_list|,
name|AR_PHY_VIT_MASK2_M_46_61
argument_list|,
name|tmp_mask
argument_list|)
expr_stmt|;
name|tmp_mask
operator|=
operator|(
name|mask_m
index|[
literal|31
index|]
operator|<<
literal|28
operator|)
operator||
operator|(
name|mask_m
index|[
literal|32
index|]
operator|<<
literal|26
operator|)
operator||
operator|(
name|mask_m
index|[
literal|33
index|]
operator|<<
literal|24
operator|)
operator||
operator|(
name|mask_m
index|[
literal|34
index|]
operator|<<
literal|22
operator|)
operator||
operator|(
name|mask_m
index|[
literal|35
index|]
operator|<<
literal|20
operator|)
operator||
operator|(
name|mask_m
index|[
literal|36
index|]
operator|<<
literal|18
operator|)
operator||
operator|(
name|mask_m
index|[
literal|37
index|]
operator|<<
literal|16
operator|)
operator||
operator|(
name|mask_m
index|[
literal|48
index|]
operator|<<
literal|14
operator|)
operator||
operator|(
name|mask_m
index|[
literal|39
index|]
operator|<<
literal|12
operator|)
operator||
operator|(
name|mask_m
index|[
literal|40
index|]
operator|<<
literal|10
operator|)
operator||
operator|(
name|mask_m
index|[
literal|41
index|]
operator|<<
literal|8
operator|)
operator||
operator|(
name|mask_m
index|[
literal|42
index|]
operator|<<
literal|6
operator|)
operator||
operator|(
name|mask_m
index|[
literal|43
index|]
operator|<<
literal|4
operator|)
operator||
operator|(
name|mask_m
index|[
literal|44
index|]
operator|<<
literal|2
operator|)
operator||
operator|(
name|mask_m
index|[
literal|45
index|]
operator|<<
literal|0
operator|)
expr_stmt|;
name|OS_REG_WRITE
argument_list|(
name|ah
argument_list|,
name|AR_PHY_BIN_MASK_2
argument_list|,
name|tmp_mask
argument_list|)
expr_stmt|;
name|OS_REG_WRITE
argument_list|(
name|ah
argument_list|,
name|AR_PHY_MASK2_M_31_45
argument_list|,
name|tmp_mask
argument_list|)
expr_stmt|;
name|tmp_mask
operator|=
operator|(
name|mask_m
index|[
literal|16
index|]
operator|<<
literal|30
operator|)
operator||
operator|(
name|mask_m
index|[
literal|16
index|]
operator|<<
literal|28
operator|)
operator||
operator|(
name|mask_m
index|[
literal|18
index|]
operator|<<
literal|26
operator|)
operator||
operator|(
name|mask_m
index|[
literal|18
index|]
operator|<<
literal|24
operator|)
operator||
operator|(
name|mask_m
index|[
literal|20
index|]
operator|<<
literal|22
operator|)
operator||
operator|(
name|mask_m
index|[
literal|20
index|]
operator|<<
literal|20
operator|)
operator||
operator|(
name|mask_m
index|[
literal|22
index|]
operator|<<
literal|18
operator|)
operator||
operator|(
name|mask_m
index|[
literal|22
index|]
operator|<<
literal|16
operator|)
operator||
operator|(
name|mask_m
index|[
literal|24
index|]
operator|<<
literal|14
operator|)
operator||
operator|(
name|mask_m
index|[
literal|24
index|]
operator|<<
literal|12
operator|)
operator||
operator|(
name|mask_m
index|[
literal|25
index|]
operator|<<
literal|10
operator|)
operator||
operator|(
name|mask_m
index|[
literal|26
index|]
operator|<<
literal|8
operator|)
operator||
operator|(
name|mask_m
index|[
literal|27
index|]
operator|<<
literal|6
operator|)
operator||
operator|(
name|mask_m
index|[
literal|28
index|]
operator|<<
literal|4
operator|)
operator||
operator|(
name|mask_m
index|[
literal|29
index|]
operator|<<
literal|2
operator|)
operator||
operator|(
name|mask_m
index|[
literal|30
index|]
operator|<<
literal|0
operator|)
expr_stmt|;
name|OS_REG_WRITE
argument_list|(
name|ah
argument_list|,
name|AR_PHY_BIN_MASK_3
argument_list|,
name|tmp_mask
argument_list|)
expr_stmt|;
name|OS_REG_WRITE
argument_list|(
name|ah
argument_list|,
name|AR_PHY_MASK2_M_16_30
argument_list|,
name|tmp_mask
argument_list|)
expr_stmt|;
name|tmp_mask
operator|=
operator|(
name|mask_m
index|[
literal|0
index|]
operator|<<
literal|30
operator|)
operator||
operator|(
name|mask_m
index|[
literal|1
index|]
operator|<<
literal|28
operator|)
operator||
operator|(
name|mask_m
index|[
literal|2
index|]
operator|<<
literal|26
operator|)
operator||
operator|(
name|mask_m
index|[
literal|3
index|]
operator|<<
literal|24
operator|)
operator||
operator|(
name|mask_m
index|[
literal|4
index|]
operator|<<
literal|22
operator|)
operator||
operator|(
name|mask_m
index|[
literal|5
index|]
operator|<<
literal|20
operator|)
operator||
operator|(
name|mask_m
index|[
literal|6
index|]
operator|<<
literal|18
operator|)
operator||
operator|(
name|mask_m
index|[
literal|7
index|]
operator|<<
literal|16
operator|)
operator||
operator|(
name|mask_m
index|[
literal|8
index|]
operator|<<
literal|14
operator|)
operator||
operator|(
name|mask_m
index|[
literal|9
index|]
operator|<<
literal|12
operator|)
operator||
operator|(
name|mask_m
index|[
literal|10
index|]
operator|<<
literal|10
operator|)
operator||
operator|(
name|mask_m
index|[
literal|11
index|]
operator|<<
literal|8
operator|)
operator||
operator|(
name|mask_m
index|[
literal|12
index|]
operator|<<
literal|6
operator|)
operator||
operator|(
name|mask_m
index|[
literal|13
index|]
operator|<<
literal|4
operator|)
operator||
operator|(
name|mask_m
index|[
literal|14
index|]
operator|<<
literal|2
operator|)
operator||
operator|(
name|mask_m
index|[
literal|15
index|]
operator|<<
literal|0
operator|)
expr_stmt|;
name|OS_REG_WRITE
argument_list|(
name|ah
argument_list|,
name|AR_PHY_MASK_CTL
argument_list|,
name|tmp_mask
argument_list|)
expr_stmt|;
name|OS_REG_WRITE
argument_list|(
name|ah
argument_list|,
name|AR_PHY_MASK2_M_00_15
argument_list|,
name|tmp_mask
argument_list|)
expr_stmt|;
name|tmp_mask
operator|=
operator|(
name|mask_p
index|[
literal|15
index|]
operator|<<
literal|28
operator|)
operator||
operator|(
name|mask_p
index|[
literal|14
index|]
operator|<<
literal|26
operator|)
operator||
operator|(
name|mask_p
index|[
literal|13
index|]
operator|<<
literal|24
operator|)
operator||
operator|(
name|mask_p
index|[
literal|12
index|]
operator|<<
literal|22
operator|)
operator||
operator|(
name|mask_p
index|[
literal|11
index|]
operator|<<
literal|20
operator|)
operator||
operator|(
name|mask_p
index|[
literal|10
index|]
operator|<<
literal|18
operator|)
operator||
operator|(
name|mask_p
index|[
literal|9
index|]
operator|<<
literal|16
operator|)
operator||
operator|(
name|mask_p
index|[
literal|8
index|]
operator|<<
literal|14
operator|)
operator||
operator|(
name|mask_p
index|[
literal|7
index|]
operator|<<
literal|12
operator|)
operator||
operator|(
name|mask_p
index|[
literal|6
index|]
operator|<<
literal|10
operator|)
operator||
operator|(
name|mask_p
index|[
literal|5
index|]
operator|<<
literal|8
operator|)
operator||
operator|(
name|mask_p
index|[
literal|4
index|]
operator|<<
literal|6
operator|)
operator||
operator|(
name|mask_p
index|[
literal|3
index|]
operator|<<
literal|4
operator|)
operator||
operator|(
name|mask_p
index|[
literal|2
index|]
operator|<<
literal|2
operator|)
operator||
operator|(
name|mask_p
index|[
literal|1
index|]
operator|<<
literal|0
operator|)
expr_stmt|;
name|OS_REG_WRITE
argument_list|(
name|ah
argument_list|,
name|AR_PHY_BIN_MASK2_1
argument_list|,
name|tmp_mask
argument_list|)
expr_stmt|;
name|OS_REG_WRITE
argument_list|(
name|ah
argument_list|,
name|AR_PHY_MASK2_P_15_01
argument_list|,
name|tmp_mask
argument_list|)
expr_stmt|;
name|tmp_mask
operator|=
operator|(
name|mask_p
index|[
literal|30
index|]
operator|<<
literal|28
operator|)
operator||
operator|(
name|mask_p
index|[
literal|29
index|]
operator|<<
literal|26
operator|)
operator||
operator|(
name|mask_p
index|[
literal|28
index|]
operator|<<
literal|24
operator|)
operator||
operator|(
name|mask_p
index|[
literal|27
index|]
operator|<<
literal|22
operator|)
operator||
operator|(
name|mask_p
index|[
literal|26
index|]
operator|<<
literal|20
operator|)
operator||
operator|(
name|mask_p
index|[
literal|25
index|]
operator|<<
literal|18
operator|)
operator||
operator|(
name|mask_p
index|[
literal|24
index|]
operator|<<
literal|16
operator|)
operator||
operator|(
name|mask_p
index|[
literal|23
index|]
operator|<<
literal|14
operator|)
operator||
operator|(
name|mask_p
index|[
literal|22
index|]
operator|<<
literal|12
operator|)
operator||
operator|(
name|mask_p
index|[
literal|21
index|]
operator|<<
literal|10
operator|)
operator||
operator|(
name|mask_p
index|[
literal|20
index|]
operator|<<
literal|8
operator|)
operator||
operator|(
name|mask_p
index|[
literal|19
index|]
operator|<<
literal|6
operator|)
operator||
operator|(
name|mask_p
index|[
literal|18
index|]
operator|<<
literal|4
operator|)
operator||
operator|(
name|mask_p
index|[
literal|17
index|]
operator|<<
literal|2
operator|)
operator||
operator|(
name|mask_p
index|[
literal|16
index|]
operator|<<
literal|0
operator|)
expr_stmt|;
name|OS_REG_WRITE
argument_list|(
name|ah
argument_list|,
name|AR_PHY_BIN_MASK2_2
argument_list|,
name|tmp_mask
argument_list|)
expr_stmt|;
name|OS_REG_WRITE
argument_list|(
name|ah
argument_list|,
name|AR_PHY_MASK2_P_30_16
argument_list|,
name|tmp_mask
argument_list|)
expr_stmt|;
name|tmp_mask
operator|=
operator|(
name|mask_p
index|[
literal|45
index|]
operator|<<
literal|28
operator|)
operator||
operator|(
name|mask_p
index|[
literal|44
index|]
operator|<<
literal|26
operator|)
operator||
operator|(
name|mask_p
index|[
literal|43
index|]
operator|<<
literal|24
operator|)
operator||
operator|(
name|mask_p
index|[
literal|42
index|]
operator|<<
literal|22
operator|)
operator||
operator|(
name|mask_p
index|[
literal|41
index|]
operator|<<
literal|20
operator|)
operator||
operator|(
name|mask_p
index|[
literal|40
index|]
operator|<<
literal|18
operator|)
operator||
operator|(
name|mask_p
index|[
literal|39
index|]
operator|<<
literal|16
operator|)
operator||
operator|(
name|mask_p
index|[
literal|38
index|]
operator|<<
literal|14
operator|)
operator||
operator|(
name|mask_p
index|[
literal|37
index|]
operator|<<
literal|12
operator|)
operator||
operator|(
name|mask_p
index|[
literal|36
index|]
operator|<<
literal|10
operator|)
operator||
operator|(
name|mask_p
index|[
literal|35
index|]
operator|<<
literal|8
operator|)
operator||
operator|(
name|mask_p
index|[
literal|34
index|]
operator|<<
literal|6
operator|)
operator||
operator|(
name|mask_p
index|[
literal|33
index|]
operator|<<
literal|4
operator|)
operator||
operator|(
name|mask_p
index|[
literal|32
index|]
operator|<<
literal|2
operator|)
operator||
operator|(
name|mask_p
index|[
literal|31
index|]
operator|<<
literal|0
operator|)
expr_stmt|;
name|OS_REG_WRITE
argument_list|(
name|ah
argument_list|,
name|AR_PHY_BIN_MASK2_3
argument_list|,
name|tmp_mask
argument_list|)
expr_stmt|;
name|OS_REG_WRITE
argument_list|(
name|ah
argument_list|,
name|AR_PHY_MASK2_P_45_31
argument_list|,
name|tmp_mask
argument_list|)
expr_stmt|;
name|tmp_mask
operator|=
operator|(
name|mask_p
index|[
literal|61
index|]
operator|<<
literal|30
operator|)
operator||
operator|(
name|mask_p
index|[
literal|60
index|]
operator|<<
literal|28
operator|)
operator||
operator|(
name|mask_p
index|[
literal|59
index|]
operator|<<
literal|26
operator|)
operator||
operator|(
name|mask_p
index|[
literal|58
index|]
operator|<<
literal|24
operator|)
operator||
operator|(
name|mask_p
index|[
literal|57
index|]
operator|<<
literal|22
operator|)
operator||
operator|(
name|mask_p
index|[
literal|56
index|]
operator|<<
literal|20
operator|)
operator||
operator|(
name|mask_p
index|[
literal|55
index|]
operator|<<
literal|18
operator|)
operator||
operator|(
name|mask_p
index|[
literal|54
index|]
operator|<<
literal|16
operator|)
operator||
operator|(
name|mask_p
index|[
literal|53
index|]
operator|<<
literal|14
operator|)
operator||
operator|(
name|mask_p
index|[
literal|52
index|]
operator|<<
literal|12
operator|)
operator||
operator|(
name|mask_p
index|[
literal|51
index|]
operator|<<
literal|10
operator|)
operator||
operator|(
name|mask_p
index|[
literal|50
index|]
operator|<<
literal|8
operator|)
operator||
operator|(
name|mask_p
index|[
literal|49
index|]
operator|<<
literal|6
operator|)
operator||
operator|(
name|mask_p
index|[
literal|48
index|]
operator|<<
literal|4
operator|)
operator||
operator|(
name|mask_p
index|[
literal|47
index|]
operator|<<
literal|2
operator|)
operator||
operator|(
name|mask_p
index|[
literal|46
index|]
operator|<<
literal|0
operator|)
expr_stmt|;
name|OS_REG_WRITE
argument_list|(
name|ah
argument_list|,
name|AR_PHY_BIN_MASK2_4
argument_list|,
name|tmp_mask
argument_list|)
expr_stmt|;
name|OS_REG_WRITE
argument_list|(
name|ah
argument_list|,
name|AR_PHY_MASK2_P_61_45
argument_list|,
name|tmp_mask
argument_list|)
expr_stmt|;
name|OS_REG_WRITE_BUFFER_FLUSH
argument_list|(
name|ah
argument_list|)
expr_stmt|;
name|OS_REG_WRITE_BUFFER_DISABLE
argument_list|(
name|ah
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * Fill all software cached or static hardware state information.  * Return failure if capabilities are to come from EEPROM and  * cannot be read.  */
end_comment

begin_function
name|HAL_BOOL
name|ar5416FillCapabilityInfo
parameter_list|(
name|struct
name|ath_hal
modifier|*
name|ah
parameter_list|)
block|{
name|struct
name|ath_hal_private
modifier|*
name|ahpriv
init|=
name|AH_PRIVATE
argument_list|(
name|ah
argument_list|)
decl_stmt|;
name|HAL_CAPABILITIES
modifier|*
name|pCap
init|=
operator|&
name|ahpriv
operator|->
name|ah_caps
decl_stmt|;
name|uint16_t
name|val
decl_stmt|;
comment|/* Construct wireless mode from EEPROM */
name|pCap
operator|->
name|halWirelessModes
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|ath_hal_eepromGetFlag
argument_list|(
name|ah
argument_list|,
name|AR_EEP_AMODE
argument_list|)
condition|)
block|{
name|pCap
operator|->
name|halWirelessModes
operator||=
name|HAL_MODE_11A
operator||
name|HAL_MODE_11NA_HT20
operator||
name|HAL_MODE_11NA_HT40PLUS
operator||
name|HAL_MODE_11NA_HT40MINUS
expr_stmt|;
block|}
if|if
condition|(
name|ath_hal_eepromGetFlag
argument_list|(
name|ah
argument_list|,
name|AR_EEP_GMODE
argument_list|)
condition|)
block|{
name|pCap
operator|->
name|halWirelessModes
operator||=
name|HAL_MODE_11G
operator||
name|HAL_MODE_11NG_HT20
operator||
name|HAL_MODE_11NG_HT40PLUS
operator||
name|HAL_MODE_11NG_HT40MINUS
expr_stmt|;
name|pCap
operator|->
name|halWirelessModes
operator||=
name|HAL_MODE_11A
operator||
name|HAL_MODE_11NA_HT20
operator||
name|HAL_MODE_11NA_HT40PLUS
operator||
name|HAL_MODE_11NA_HT40MINUS
expr_stmt|;
block|}
name|pCap
operator|->
name|halLow2GhzChan
operator|=
literal|2312
expr_stmt|;
name|pCap
operator|->
name|halHigh2GhzChan
operator|=
literal|2732
expr_stmt|;
name|pCap
operator|->
name|halLow5GhzChan
operator|=
literal|4915
expr_stmt|;
name|pCap
operator|->
name|halHigh5GhzChan
operator|=
literal|6100
expr_stmt|;
name|pCap
operator|->
name|halCipherCkipSupport
operator|=
name|AH_FALSE
expr_stmt|;
name|pCap
operator|->
name|halCipherTkipSupport
operator|=
name|AH_TRUE
expr_stmt|;
name|pCap
operator|->
name|halCipherAesCcmSupport
operator|=
name|ath_hal_eepromGetFlag
argument_list|(
name|ah
argument_list|,
name|AR_EEP_AES
argument_list|)
expr_stmt|;
name|pCap
operator|->
name|halMicCkipSupport
operator|=
name|AH_FALSE
expr_stmt|;
name|pCap
operator|->
name|halMicTkipSupport
operator|=
name|AH_TRUE
expr_stmt|;
name|pCap
operator|->
name|halMicAesCcmSupport
operator|=
name|ath_hal_eepromGetFlag
argument_list|(
name|ah
argument_list|,
name|AR_EEP_AES
argument_list|)
expr_stmt|;
comment|/* 	 * Starting with Griffin TX+RX mic keys can be combined 	 * in one key cache slot. 	 */
name|pCap
operator|->
name|halTkipMicTxRxKeySupport
operator|=
name|AH_TRUE
expr_stmt|;
name|pCap
operator|->
name|halChanSpreadSupport
operator|=
name|AH_TRUE
expr_stmt|;
name|pCap
operator|->
name|halSleepAfterBeaconBroken
operator|=
name|AH_TRUE
expr_stmt|;
name|pCap
operator|->
name|halCompressSupport
operator|=
name|AH_FALSE
expr_stmt|;
name|pCap
operator|->
name|halBurstSupport
operator|=
name|AH_TRUE
expr_stmt|;
name|pCap
operator|->
name|halFastFramesSupport
operator|=
name|AH_FALSE
expr_stmt|;
comment|/* XXX? */
name|pCap
operator|->
name|halChapTuningSupport
operator|=
name|AH_TRUE
expr_stmt|;
name|pCap
operator|->
name|halTurboPrimeSupport
operator|=
name|AH_TRUE
expr_stmt|;
name|pCap
operator|->
name|halTurboGSupport
operator|=
name|pCap
operator|->
name|halWirelessModes
operator|&
name|HAL_MODE_108G
expr_stmt|;
name|pCap
operator|->
name|halPSPollBroken
operator|=
name|AH_TRUE
expr_stmt|;
comment|/* XXX fixed in later revs? */
name|pCap
operator|->
name|halNumMRRetries
operator|=
literal|4
expr_stmt|;
comment|/* Hardware supports 4 MRR */
name|pCap
operator|->
name|halVEOLSupport
operator|=
name|AH_TRUE
expr_stmt|;
name|pCap
operator|->
name|halBssIdMaskSupport
operator|=
name|AH_TRUE
expr_stmt|;
name|pCap
operator|->
name|halMcastKeySrchSupport
operator|=
name|AH_TRUE
expr_stmt|;
comment|/* Works on AR5416 and later */
name|pCap
operator|->
name|halTsfAddSupport
operator|=
name|AH_TRUE
expr_stmt|;
name|pCap
operator|->
name|hal4AddrAggrSupport
operator|=
name|AH_FALSE
expr_stmt|;
comment|/* Broken in Owl */
if|if
condition|(
name|ath_hal_eepromGet
argument_list|(
name|ah
argument_list|,
name|AR_EEP_MAXQCU
argument_list|,
operator|&
name|val
argument_list|)
operator|==
name|HAL_OK
condition|)
name|pCap
operator|->
name|halTotalQueues
operator|=
name|val
expr_stmt|;
else|else
name|pCap
operator|->
name|halTotalQueues
operator|=
name|HAL_NUM_TX_QUEUES
expr_stmt|;
if|if
condition|(
name|ath_hal_eepromGet
argument_list|(
name|ah
argument_list|,
name|AR_EEP_KCENTRIES
argument_list|,
operator|&
name|val
argument_list|)
operator|==
name|HAL_OK
condition|)
name|pCap
operator|->
name|halKeyCacheSize
operator|=
name|val
expr_stmt|;
else|else
name|pCap
operator|->
name|halKeyCacheSize
operator|=
name|AR5416_KEYTABLE_SIZE
expr_stmt|;
comment|/* XXX not needed */
name|pCap
operator|->
name|halChanHalfRate
operator|=
name|AH_FALSE
expr_stmt|;
comment|/* XXX ? */
name|pCap
operator|->
name|halChanQuarterRate
operator|=
name|AH_FALSE
expr_stmt|;
comment|/* XXX ? */
name|pCap
operator|->
name|halTstampPrecision
operator|=
literal|32
expr_stmt|;
name|pCap
operator|->
name|halHwPhyCounterSupport
operator|=
name|AH_TRUE
expr_stmt|;
name|pCap
operator|->
name|halIntrMask
operator|=
name|HAL_INT_COMMON
operator||
name|HAL_INT_RX
operator||
name|HAL_INT_TX
operator||
name|HAL_INT_FATAL
operator||
name|HAL_INT_BNR
operator||
name|HAL_INT_BMISC
operator||
name|HAL_INT_DTIMSYNC
operator||
name|HAL_INT_TSFOOR
operator||
name|HAL_INT_CST
operator||
name|HAL_INT_GTT
expr_stmt|;
name|pCap
operator|->
name|halFastCCSupport
operator|=
name|AH_TRUE
expr_stmt|;
name|pCap
operator|->
name|halNumGpioPins
operator|=
literal|14
expr_stmt|;
name|pCap
operator|->
name|halWowSupport
operator|=
name|AH_FALSE
expr_stmt|;
name|pCap
operator|->
name|halWowMatchPatternExact
operator|=
name|AH_FALSE
expr_stmt|;
name|pCap
operator|->
name|halBtCoexSupport
operator|=
name|AH_FALSE
expr_stmt|;
comment|/* XXX need support */
name|pCap
operator|->
name|halAutoSleepSupport
operator|=
name|AH_FALSE
expr_stmt|;
name|pCap
operator|->
name|hal4kbSplitTransSupport
operator|=
name|AH_TRUE
expr_stmt|;
comment|/* Disable this so Block-ACK works correctly */
name|pCap
operator|->
name|halHasRxSelfLinkedTail
operator|=
name|AH_FALSE
expr_stmt|;
if|#
directive|if
literal|0
comment|/* XXX not yet */
block|pCap->halNumAntCfg2GHz = ar5416GetNumAntConfig(ahp, HAL_FREQ_BAND_2GHZ); 	pCap->halNumAntCfg5GHz = ar5416GetNumAntConfig(ahp, HAL_FREQ_BAND_5GHZ);
endif|#
directive|endif
name|pCap
operator|->
name|halHTSupport
operator|=
name|AH_TRUE
expr_stmt|;
name|pCap
operator|->
name|halTxChainMask
operator|=
name|ath_hal_eepromGet
argument_list|(
name|ah
argument_list|,
name|AR_EEP_TXMASK
argument_list|,
name|AH_NULL
argument_list|)
expr_stmt|;
comment|/* XXX CB71 uses GPIO 0 to indicate 3 rx chains */
name|pCap
operator|->
name|halRxChainMask
operator|=
name|ath_hal_eepromGet
argument_list|(
name|ah
argument_list|,
name|AR_EEP_RXMASK
argument_list|,
name|AH_NULL
argument_list|)
expr_stmt|;
comment|/* AR5416 may have 3 antennas but is a 2x2 stream device */
name|pCap
operator|->
name|halTxStreams
operator|=
literal|2
expr_stmt|;
name|pCap
operator|->
name|halRxStreams
operator|=
literal|2
expr_stmt|;
comment|/* 	 * If the TX or RX chainmask has less than 2 chains active, 	 * mark it as a 1-stream device for the relevant stream. 	 */
if|if
condition|(
name|owl_get_ntxchains
argument_list|(
name|pCap
operator|->
name|halTxChainMask
argument_list|)
operator|==
literal|1
condition|)
name|pCap
operator|->
name|halTxStreams
operator|=
literal|1
expr_stmt|;
comment|/* XXX Eww */
if|if
condition|(
name|owl_get_ntxchains
argument_list|(
name|pCap
operator|->
name|halRxChainMask
argument_list|)
operator|==
literal|1
condition|)
name|pCap
operator|->
name|halRxStreams
operator|=
literal|1
expr_stmt|;
name|pCap
operator|->
name|halRtsAggrLimit
operator|=
literal|8
operator|*
literal|1024
expr_stmt|;
comment|/* Owl 2.0 limit */
name|pCap
operator|->
name|halMbssidAggrSupport
operator|=
name|AH_FALSE
expr_stmt|;
comment|/* Broken on Owl */
name|pCap
operator|->
name|halForcePpmSupport
operator|=
name|AH_TRUE
expr_stmt|;
name|pCap
operator|->
name|halEnhancedPmSupport
operator|=
name|AH_TRUE
expr_stmt|;
name|pCap
operator|->
name|halBssidMatchSupport
operator|=
name|AH_TRUE
expr_stmt|;
name|pCap
operator|->
name|halGTTSupport
operator|=
name|AH_TRUE
expr_stmt|;
name|pCap
operator|->
name|halCSTSupport
operator|=
name|AH_TRUE
expr_stmt|;
name|pCap
operator|->
name|halEnhancedDfsSupport
operator|=
name|AH_FALSE
expr_stmt|;
comment|/* Hardware supports 32 bit TSF values in the RX descriptor */
name|pCap
operator|->
name|halHasLongRxDescTsf
operator|=
name|AH_TRUE
expr_stmt|;
comment|/* 	 * BB Read WAR: this is only for AR5008/AR9001 NICs 	 * It is also set individually in the AR91xx attach functions. 	 */
if|if
condition|(
name|AR_SREV_OWL
argument_list|(
name|ah
argument_list|)
condition|)
name|pCap
operator|->
name|halHasBBReadWar
operator|=
name|AH_TRUE
expr_stmt|;
if|if
condition|(
name|ath_hal_eepromGetFlag
argument_list|(
name|ah
argument_list|,
name|AR_EEP_RFKILL
argument_list|)
operator|&&
name|ath_hal_eepromGet
argument_list|(
name|ah
argument_list|,
name|AR_EEP_RFSILENT
argument_list|,
operator|&
name|ahpriv
operator|->
name|ah_rfsilent
argument_list|)
operator|==
name|HAL_OK
condition|)
block|{
comment|/* NB: enabled by default */
name|ahpriv
operator|->
name|ah_rfkillEnabled
operator|=
name|AH_TRUE
expr_stmt|;
name|pCap
operator|->
name|halRfSilentSupport
operator|=
name|AH_TRUE
expr_stmt|;
block|}
comment|/* 	 * The MAC will mark frames as RXed if there's a descriptor 	 * to write them to. So if it hits a self-linked final descriptor, 	 * it'll keep ACKing frames even though they're being silently 	 * dropped. Thus, this particular feature of the driver can't 	 * be used for 802.11n devices. 	 */
name|ahpriv
operator|->
name|ah_rxornIsFatal
operator|=
name|AH_FALSE
expr_stmt|;
comment|/* 	 * If it's a PCI NIC, ask the HAL OS layer to serialise 	 * register access, or SMP machines may cause the hardware 	 * to hang. This is applicable to AR5416 and AR9220; I'm not 	 * sure about AR9160 or AR9227. 	 */
if|if
condition|(
operator|!
name|AH_PRIVATE
argument_list|(
name|ah
argument_list|)
operator|->
name|ah_ispcie
condition|)
name|pCap
operator|->
name|halSerialiseRegWar
operator|=
literal|1
expr_stmt|;
return|return
name|AH_TRUE
return|;
block|}
end_function

begin_function
specifier|static
specifier|const
name|char
modifier|*
name|ar5416Probe
parameter_list|(
name|uint16_t
name|vendorid
parameter_list|,
name|uint16_t
name|devid
parameter_list|)
block|{
if|if
condition|(
name|vendorid
operator|==
name|ATHEROS_VENDOR_ID
condition|)
block|{
if|if
condition|(
name|devid
operator|==
name|AR5416_DEVID_PCI
condition|)
return|return
literal|"Atheros 5416"
return|;
if|if
condition|(
name|devid
operator|==
name|AR5416_DEVID_PCIE
condition|)
return|return
literal|"Atheros 5418"
return|;
block|}
return|return
name|AH_NULL
return|;
block|}
end_function

begin_expr_stmt
name|AH_CHIP
argument_list|(
name|AR5416
argument_list|,
name|ar5416Probe
argument_list|,
name|ar5416Attach
argument_list|)
expr_stmt|;
end_expr_stmt

end_unit


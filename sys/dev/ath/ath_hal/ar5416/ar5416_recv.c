begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Copyright (c) 2002-2008 Sam Leffler, Errno Consulting  * Copyright (c) 2002-2008 Atheros Communications, Inc.  *  * Permission to use, copy, modify, and/or distribute this software for any  * purpose with or without fee is hereby granted, provided that the above  * copyright notice and this permission notice appear in all copies.  *  * THE SOFTWARE IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL WARRANTIES  * WITH REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF  * MERCHANTABILITY AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR  * ANY SPECIAL, DIRECT, INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES  * WHATSOEVER RESULTING FROM LOSS OF USE, DATA OR PROFITS, WHETHER IN AN  * ACTION OF CONTRACT, NEGLIGENCE OR OTHER TORTIOUS ACTION, ARISING OUT OF  * OR IN CONNECTION WITH THE USE OR PERFORMANCE OF THIS SOFTWARE.  *  * $FreeBSD$  */
end_comment

begin_include
include|#
directive|include
file|"opt_ah.h"
end_include

begin_include
include|#
directive|include
file|"ah.h"
end_include

begin_include
include|#
directive|include
file|"ah_desc.h"
end_include

begin_include
include|#
directive|include
file|"ah_internal.h"
end_include

begin_include
include|#
directive|include
file|"ar5416/ar5416.h"
end_include

begin_include
include|#
directive|include
file|"ar5416/ar5416reg.h"
end_include

begin_include
include|#
directive|include
file|"ar5416/ar5416desc.h"
end_include

begin_comment
comment|/*  * Start receive at the PCU engine  */
end_comment

begin_function
name|void
name|ar5416StartPcuReceive
parameter_list|(
name|struct
name|ath_hal
modifier|*
name|ah
parameter_list|)
block|{
name|struct
name|ath_hal_private
modifier|*
name|ahp
init|=
name|AH_PRIVATE
argument_list|(
name|ah
argument_list|)
decl_stmt|;
name|HALDEBUG
argument_list|(
name|ah
argument_list|,
name|HAL_DEBUG_RX
argument_list|,
literal|"%s: Start PCU Receive \n"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
name|ar5212EnableMibCounters
argument_list|(
name|ah
argument_list|)
expr_stmt|;
comment|/* NB: restore current settings */
name|ar5416AniReset
argument_list|(
name|ah
argument_list|,
name|ahp
operator|->
name|ah_curchan
argument_list|,
name|ahp
operator|->
name|ah_opmode
argument_list|,
name|AH_TRUE
argument_list|)
expr_stmt|;
comment|/* 	 * NB: must do after enabling phy errors to avoid rx 	 *     frames w/ corrupted descriptor status. 	 */
name|OS_REG_CLR_BIT
argument_list|(
name|ah
argument_list|,
name|AR_DIAG_SW
argument_list|,
name|AR_DIAG_RX_DIS
operator||
name|AR_DIAG_RX_ABORT
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * Stop receive at the PCU engine  * and abort current frame in PCU  */
end_comment

begin_function
name|void
name|ar5416StopPcuReceive
parameter_list|(
name|struct
name|ath_hal
modifier|*
name|ah
parameter_list|)
block|{
name|OS_REG_SET_BIT
argument_list|(
name|ah
argument_list|,
name|AR_DIAG_SW
argument_list|,
name|AR_DIAG_RX_DIS
operator||
name|AR_DIAG_RX_ABORT
argument_list|)
expr_stmt|;
name|HALDEBUG
argument_list|(
name|ah
argument_list|,
name|HAL_DEBUG_RX
argument_list|,
literal|"%s: Stop PCU Receive \n"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
name|ar5212DisableMibCounters
argument_list|(
name|ah
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * Initialize RX descriptor, by clearing the status and setting  * the size (and any other flags).  */
end_comment

begin_function
name|HAL_BOOL
name|ar5416SetupRxDesc
parameter_list|(
name|struct
name|ath_hal
modifier|*
name|ah
parameter_list|,
name|struct
name|ath_desc
modifier|*
name|ds
parameter_list|,
name|uint32_t
name|size
parameter_list|,
name|u_int
name|flags
parameter_list|)
block|{
name|struct
name|ar5416_desc
modifier|*
name|ads
init|=
name|AR5416DESC
argument_list|(
name|ds
argument_list|)
decl_stmt|;
name|HALASSERT
argument_list|(
operator|(
name|size
operator|&
operator|~
name|AR_BufLen
operator|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|ads
operator|->
name|ds_ctl1
operator|=
name|size
operator|&
name|AR_BufLen
expr_stmt|;
if|if
condition|(
name|flags
operator|&
name|HAL_RXDESC_INTREQ
condition|)
name|ads
operator|->
name|ds_ctl1
operator||=
name|AR_RxIntrReq
expr_stmt|;
comment|/* this should be enough */
name|ads
operator|->
name|ds_rxstatus8
operator|&=
operator|~
name|AR_RxDone
expr_stmt|;
return|return
name|AH_TRUE
return|;
block|}
end_function

begin_comment
comment|/*  * Process an RX descriptor, and return the status to the caller.  * Copy some hardware specific items into the software portion  * of the descriptor.  *  * NB: the caller is responsible for validating the memory contents  *     of the descriptor (e.g. flushing any cached copy).  */
end_comment

begin_function
name|HAL_STATUS
name|ar5416ProcRxDesc
parameter_list|(
name|struct
name|ath_hal
modifier|*
name|ah
parameter_list|,
name|struct
name|ath_desc
modifier|*
name|ds
parameter_list|,
name|uint32_t
name|pa
parameter_list|,
name|struct
name|ath_desc
modifier|*
name|nds
parameter_list|,
name|uint64_t
name|tsf
parameter_list|,
name|struct
name|ath_rx_status
modifier|*
name|rs
parameter_list|)
block|{
name|struct
name|ar5416_desc
modifier|*
name|ads
init|=
name|AR5416DESC
argument_list|(
name|ds
argument_list|)
decl_stmt|;
name|struct
name|ar5416_desc
modifier|*
name|ands
init|=
name|AR5416DESC
argument_list|(
name|nds
argument_list|)
decl_stmt|;
if|if
condition|(
operator|(
name|ads
operator|->
name|ds_rxstatus8
operator|&
name|AR_RxDone
operator|)
operator|==
literal|0
condition|)
return|return
name|HAL_EINPROGRESS
return|;
comment|/* 	 * Given the use of a self-linked tail be very sure that the hw is 	 * done with this descriptor; the hw may have done this descriptor 	 * once and picked it up again...make sure the hw has moved on. 	 */
if|if
condition|(
operator|(
name|ands
operator|->
name|ds_rxstatus8
operator|&
name|AR_RxDone
operator|)
operator|==
literal|0
operator|&&
name|OS_REG_READ
argument_list|(
name|ah
argument_list|,
name|AR_RXDP
argument_list|)
operator|==
name|pa
condition|)
return|return
name|HAL_EINPROGRESS
return|;
name|rs
operator|->
name|rs_status
operator|=
literal|0
expr_stmt|;
name|rs
operator|->
name|rs_flags
operator|=
literal|0
expr_stmt|;
name|rs
operator|->
name|rs_datalen
operator|=
name|ads
operator|->
name|ds_rxstatus1
operator|&
name|AR_DataLen
expr_stmt|;
name|rs
operator|->
name|rs_tstamp
operator|=
name|ads
operator|->
name|AR_RcvTimestamp
expr_stmt|;
comment|/* XXX what about KeyCacheMiss? */
name|rs
operator|->
name|rs_rssi
operator|=
name|MS
argument_list|(
name|ads
operator|->
name|ds_rxstatus4
argument_list|,
name|AR_RxRSSICombined
argument_list|)
expr_stmt|;
name|rs
operator|->
name|rs_rssi_ctl
index|[
literal|0
index|]
operator|=
name|MS
argument_list|(
name|ads
operator|->
name|ds_rxstatus0
argument_list|,
name|AR_RxRSSIAnt00
argument_list|)
expr_stmt|;
name|rs
operator|->
name|rs_rssi_ctl
index|[
literal|1
index|]
operator|=
name|MS
argument_list|(
name|ads
operator|->
name|ds_rxstatus0
argument_list|,
name|AR_RxRSSIAnt01
argument_list|)
expr_stmt|;
name|rs
operator|->
name|rs_rssi_ctl
index|[
literal|2
index|]
operator|=
name|MS
argument_list|(
name|ads
operator|->
name|ds_rxstatus0
argument_list|,
name|AR_RxRSSIAnt02
argument_list|)
expr_stmt|;
name|rs
operator|->
name|rs_rssi_ext
index|[
literal|0
index|]
operator|=
name|MS
argument_list|(
name|ads
operator|->
name|ds_rxstatus4
argument_list|,
name|AR_RxRSSIAnt10
argument_list|)
expr_stmt|;
name|rs
operator|->
name|rs_rssi_ext
index|[
literal|1
index|]
operator|=
name|MS
argument_list|(
name|ads
operator|->
name|ds_rxstatus4
argument_list|,
name|AR_RxRSSIAnt11
argument_list|)
expr_stmt|;
name|rs
operator|->
name|rs_rssi_ext
index|[
literal|2
index|]
operator|=
name|MS
argument_list|(
name|ads
operator|->
name|ds_rxstatus4
argument_list|,
name|AR_RxRSSIAnt12
argument_list|)
expr_stmt|;
if|if
condition|(
name|ads
operator|->
name|ds_rxstatus8
operator|&
name|AR_RxKeyIdxValid
condition|)
name|rs
operator|->
name|rs_keyix
operator|=
name|MS
argument_list|(
name|ads
operator|->
name|ds_rxstatus8
argument_list|,
name|AR_KeyIdx
argument_list|)
expr_stmt|;
else|else
name|rs
operator|->
name|rs_keyix
operator|=
name|HAL_RXKEYIX_INVALID
expr_stmt|;
comment|/* NB: caller expected to do rate table mapping */
name|rs
operator|->
name|rs_rate
operator|=
name|RXSTATUS_RATE
argument_list|(
name|ah
argument_list|,
name|ads
argument_list|)
expr_stmt|;
name|rs
operator|->
name|rs_more
operator|=
operator|(
name|ads
operator|->
name|ds_rxstatus1
operator|&
name|AR_RxMore
operator|)
condition|?
literal|1
else|:
literal|0
expr_stmt|;
name|rs
operator|->
name|rs_isaggr
operator|=
operator|(
name|ads
operator|->
name|ds_rxstatus8
operator|&
name|AR_RxAggr
operator|)
condition|?
literal|1
else|:
literal|0
expr_stmt|;
name|rs
operator|->
name|rs_moreaggr
operator|=
operator|(
name|ads
operator|->
name|ds_rxstatus8
operator|&
name|AR_RxMoreAggr
operator|)
condition|?
literal|1
else|:
literal|0
expr_stmt|;
name|rs
operator|->
name|rs_antenna
operator|=
name|MS
argument_list|(
name|ads
operator|->
name|ds_rxstatus3
argument_list|,
name|AR_RxAntenna
argument_list|)
expr_stmt|;
if|if
condition|(
name|ads
operator|->
name|ds_rxstatus3
operator|&
name|AR_GI
condition|)
name|rs
operator|->
name|rs_flags
operator||=
name|HAL_RX_GI
expr_stmt|;
if|if
condition|(
name|ads
operator|->
name|ds_rxstatus3
operator|&
name|AR_2040
condition|)
name|rs
operator|->
name|rs_flags
operator||=
name|HAL_RX_2040
expr_stmt|;
if|if
condition|(
name|ads
operator|->
name|ds_rxstatus8
operator|&
name|AR_PreDelimCRCErr
condition|)
name|rs
operator|->
name|rs_flags
operator||=
name|HAL_RX_DELIM_CRC_PRE
expr_stmt|;
if|if
condition|(
name|ads
operator|->
name|ds_rxstatus8
operator|&
name|AR_PostDelimCRCErr
condition|)
name|rs
operator|->
name|rs_flags
operator||=
name|HAL_RX_DELIM_CRC_POST
expr_stmt|;
if|if
condition|(
name|ads
operator|->
name|ds_rxstatus8
operator|&
name|AR_DecryptBusyErr
condition|)
name|rs
operator|->
name|rs_flags
operator||=
name|HAL_RX_DECRYPT_BUSY
expr_stmt|;
if|if
condition|(
name|ads
operator|->
name|ds_rxstatus8
operator|&
name|AR_HiRxChain
condition|)
name|rs
operator|->
name|rs_flags
operator||=
name|HAL_RX_HI_RX_CHAIN
expr_stmt|;
if|if
condition|(
operator|(
name|ads
operator|->
name|ds_rxstatus8
operator|&
name|AR_RxFrameOK
operator|)
operator|==
literal|0
condition|)
block|{
comment|/* 		 * These four bits should not be set together.  The 		 * 5416 spec states a Michael error can only occur if 		 * DecryptCRCErr not set (and TKIP is used).  Experience 		 * indicates however that you can also get Michael errors 		 * when a CRC error is detected, but these are specious. 		 * Consequently we filter them out here so we don't 		 * confuse and/or complicate drivers. 		 */
if|if
condition|(
name|ads
operator|->
name|ds_rxstatus8
operator|&
name|AR_CRCErr
condition|)
name|rs
operator|->
name|rs_status
operator||=
name|HAL_RXERR_CRC
expr_stmt|;
elseif|else
if|if
condition|(
name|ads
operator|->
name|ds_rxstatus8
operator|&
name|AR_PHYErr
condition|)
block|{
name|u_int
name|phyerr
decl_stmt|;
name|rs
operator|->
name|rs_status
operator||=
name|HAL_RXERR_PHY
expr_stmt|;
name|phyerr
operator|=
name|MS
argument_list|(
name|ads
operator|->
name|ds_rxstatus8
argument_list|,
name|AR_PHYErrCode
argument_list|)
expr_stmt|;
name|rs
operator|->
name|rs_phyerr
operator|=
name|phyerr
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|ads
operator|->
name|ds_rxstatus8
operator|&
name|AR_DecryptCRCErr
condition|)
name|rs
operator|->
name|rs_status
operator||=
name|HAL_RXERR_DECRYPT
expr_stmt|;
elseif|else
if|if
condition|(
name|ads
operator|->
name|ds_rxstatus8
operator|&
name|AR_MichaelErr
condition|)
name|rs
operator|->
name|rs_status
operator||=
name|HAL_RXERR_MIC
expr_stmt|;
block|}
return|return
name|HAL_OK
return|;
block|}
end_function

end_unit


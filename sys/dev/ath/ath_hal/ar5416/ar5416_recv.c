begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Copyright (c) 2002-2008 Sam Leffler, Errno Consulting  * Copyright (c) 2002-2008 Atheros Communications, Inc.  *  * Permission to use, copy, modify, and/or distribute this software for any  * purpose with or without fee is hereby granted, provided that the above  * copyright notice and this permission notice appear in all copies.  *  * THE SOFTWARE IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL WARRANTIES  * WITH REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF  * MERCHANTABILITY AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR  * ANY SPECIAL, DIRECT, INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES  * WHATSOEVER RESULTING FROM LOSS OF USE, DATA OR PROFITS, WHETHER IN AN  * ACTION OF CONTRACT, NEGLIGENCE OR OTHER TORTIOUS ACTION, ARISING OUT OF  * OR IN CONNECTION WITH THE USE OR PERFORMANCE OF THIS SOFTWARE.  *  * $FreeBSD$  */
end_comment

begin_include
include|#
directive|include
file|"opt_ah.h"
end_include

begin_include
include|#
directive|include
file|"ah.h"
end_include

begin_include
include|#
directive|include
file|"ah_desc.h"
end_include

begin_include
include|#
directive|include
file|"ah_internal.h"
end_include

begin_include
include|#
directive|include
file|"ar5416/ar5416.h"
end_include

begin_include
include|#
directive|include
file|"ar5416/ar5416reg.h"
end_include

begin_include
include|#
directive|include
file|"ar5416/ar5416desc.h"
end_include

begin_comment
comment|/*  * Get the receive filter.  */
end_comment

begin_function
name|uint32_t
name|ar5416GetRxFilter
parameter_list|(
name|struct
name|ath_hal
modifier|*
name|ah
parameter_list|)
block|{
name|uint32_t
name|bits
init|=
name|OS_REG_READ
argument_list|(
name|ah
argument_list|,
name|AR_RX_FILTER
argument_list|)
decl_stmt|;
name|uint32_t
name|phybits
init|=
name|OS_REG_READ
argument_list|(
name|ah
argument_list|,
name|AR_PHY_ERR
argument_list|)
decl_stmt|;
if|if
condition|(
name|phybits
operator|&
name|AR_PHY_ERR_RADAR
condition|)
name|bits
operator||=
name|HAL_RX_FILTER_PHYRADAR
expr_stmt|;
if|if
condition|(
name|phybits
operator|&
operator|(
name|AR_PHY_ERR_OFDM_TIMING
operator||
name|AR_PHY_ERR_CCK_TIMING
operator|)
condition|)
name|bits
operator||=
name|HAL_RX_FILTER_PHYERR
expr_stmt|;
return|return
name|bits
return|;
block|}
end_function

begin_comment
comment|/*  * Set the receive filter.  */
end_comment

begin_function
name|void
name|ar5416SetRxFilter
parameter_list|(
name|struct
name|ath_hal
modifier|*
name|ah
parameter_list|,
name|u_int32_t
name|bits
parameter_list|)
block|{
name|uint32_t
name|phybits
decl_stmt|;
name|OS_REG_WRITE
argument_list|(
name|ah
argument_list|,
name|AR_RX_FILTER
argument_list|,
operator|(
name|bits
operator|&
literal|0xffff
operator|)
argument_list|)
expr_stmt|;
name|phybits
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|bits
operator|&
name|HAL_RX_FILTER_PHYRADAR
condition|)
name|phybits
operator||=
name|AR_PHY_ERR_RADAR
expr_stmt|;
if|if
condition|(
name|bits
operator|&
name|HAL_RX_FILTER_PHYERR
condition|)
name|phybits
operator||=
name|AR_PHY_ERR_OFDM_TIMING
operator||
name|AR_PHY_ERR_CCK_TIMING
expr_stmt|;
name|OS_REG_WRITE
argument_list|(
name|ah
argument_list|,
name|AR_PHY_ERR
argument_list|,
name|phybits
argument_list|)
expr_stmt|;
if|if
condition|(
name|phybits
condition|)
block|{
name|OS_REG_WRITE
argument_list|(
name|ah
argument_list|,
name|AR_RXCFG
argument_list|,
name|OS_REG_READ
argument_list|(
name|ah
argument_list|,
name|AR_RXCFG
argument_list|)
operator||
name|AR_RXCFG_ZLFDMA
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|OS_REG_WRITE
argument_list|(
name|ah
argument_list|,
name|AR_RXCFG
argument_list|,
name|OS_REG_READ
argument_list|(
name|ah
argument_list|,
name|AR_RXCFG
argument_list|)
operator|&
operator|~
name|AR_RXCFG_ZLFDMA
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/*  * Stop Receive at the DMA engine  */
end_comment

begin_function
name|HAL_BOOL
name|ar5416StopDmaReceive
parameter_list|(
name|struct
name|ath_hal
modifier|*
name|ah
parameter_list|)
block|{
name|HAL_BOOL
name|status
decl_stmt|;
name|OS_MARK
argument_list|(
name|ah
argument_list|,
name|AH_MARK_RX_CTL
argument_list|,
name|AH_MARK_RX_CTL_DMA_STOP
argument_list|)
expr_stmt|;
name|OS_REG_WRITE
argument_list|(
name|ah
argument_list|,
name|AR_CR
argument_list|,
name|AR_CR_RXD
argument_list|)
expr_stmt|;
comment|/* Set receive disable bit */
if|if
condition|(
operator|!
name|ath_hal_wait
argument_list|(
name|ah
argument_list|,
name|AR_CR
argument_list|,
name|AR_CR_RXE
argument_list|,
literal|0
argument_list|)
condition|)
block|{
name|OS_MARK
argument_list|(
name|ah
argument_list|,
name|AH_MARK_RX_CTL
argument_list|,
name|AH_MARK_RX_CTL_DMA_STOP_ERR
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|AH_DEBUG
name|ath_hal_printf
argument_list|(
name|ah
argument_list|,
literal|"%s: dma failed to stop in 10ms\n"
literal|"AR_CR=0x%08x\nAR_DIAG_SW=0x%08x\n"
argument_list|,
name|__func__
argument_list|,
name|OS_REG_READ
argument_list|(
name|ah
argument_list|,
name|AR_CR
argument_list|)
argument_list|,
name|OS_REG_READ
argument_list|(
name|ah
argument_list|,
name|AR_DIAG_SW
argument_list|)
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|status
operator|=
name|AH_FALSE
expr_stmt|;
block|}
else|else
block|{
name|status
operator|=
name|AH_TRUE
expr_stmt|;
block|}
comment|/* 	 * XXX Is this to flush whatever is in a FIFO somewhere? 	 * XXX If so, what should the correct behaviour should be? 	 */
if|if
condition|(
name|AR_SREV_9100
argument_list|(
name|ah
argument_list|)
condition|)
name|OS_DELAY
argument_list|(
literal|3000
argument_list|)
expr_stmt|;
return|return
operator|(
name|status
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Start receive at the PCU engine  */
end_comment

begin_function
name|void
name|ar5416StartPcuReceive
parameter_list|(
name|struct
name|ath_hal
modifier|*
name|ah
parameter_list|)
block|{
name|struct
name|ath_hal_private
modifier|*
name|ahp
init|=
name|AH_PRIVATE
argument_list|(
name|ah
argument_list|)
decl_stmt|;
name|HALDEBUG
argument_list|(
name|ah
argument_list|,
name|HAL_DEBUG_RX
argument_list|,
literal|"%s: Start PCU Receive \n"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
name|ar5212EnableMibCounters
argument_list|(
name|ah
argument_list|)
expr_stmt|;
comment|/* NB: restore current settings */
name|ar5416AniReset
argument_list|(
name|ah
argument_list|,
name|ahp
operator|->
name|ah_curchan
argument_list|,
name|ahp
operator|->
name|ah_opmode
argument_list|,
name|AH_TRUE
argument_list|)
expr_stmt|;
comment|/* 	 * NB: must do after enabling phy errors to avoid rx 	 *     frames w/ corrupted descriptor status. 	 */
name|OS_REG_CLR_BIT
argument_list|(
name|ah
argument_list|,
name|AR_DIAG_SW
argument_list|,
name|AR_DIAG_RX_DIS
operator||
name|AR_DIAG_RX_ABORT
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * Stop receive at the PCU engine  * and abort current frame in PCU  */
end_comment

begin_function
name|void
name|ar5416StopPcuReceive
parameter_list|(
name|struct
name|ath_hal
modifier|*
name|ah
parameter_list|)
block|{
name|OS_REG_SET_BIT
argument_list|(
name|ah
argument_list|,
name|AR_DIAG_SW
argument_list|,
name|AR_DIAG_RX_DIS
operator||
name|AR_DIAG_RX_ABORT
argument_list|)
expr_stmt|;
name|HALDEBUG
argument_list|(
name|ah
argument_list|,
name|HAL_DEBUG_RX
argument_list|,
literal|"%s: Stop PCU Receive \n"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
name|ar5212DisableMibCounters
argument_list|(
name|ah
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * Initialize RX descriptor, by clearing the status and setting  * the size (and any other flags).  */
end_comment

begin_function
name|HAL_BOOL
name|ar5416SetupRxDesc
parameter_list|(
name|struct
name|ath_hal
modifier|*
name|ah
parameter_list|,
name|struct
name|ath_desc
modifier|*
name|ds
parameter_list|,
name|uint32_t
name|size
parameter_list|,
name|u_int
name|flags
parameter_list|)
block|{
name|struct
name|ar5416_desc
modifier|*
name|ads
init|=
name|AR5416DESC
argument_list|(
name|ds
argument_list|)
decl_stmt|;
name|HALASSERT
argument_list|(
operator|(
name|size
operator|&
operator|~
name|AR_BufLen
operator|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|ads
operator|->
name|ds_ctl1
operator|=
name|size
operator|&
name|AR_BufLen
expr_stmt|;
if|if
condition|(
name|flags
operator|&
name|HAL_RXDESC_INTREQ
condition|)
name|ads
operator|->
name|ds_ctl1
operator||=
name|AR_RxIntrReq
expr_stmt|;
comment|/* this should be enough */
name|ads
operator|->
name|ds_rxstatus8
operator|&=
operator|~
name|AR_RxDone
expr_stmt|;
comment|/* clear the rest of the status fields */
name|OS_MEMZERO
argument_list|(
operator|&
operator|(
name|ads
operator|->
name|u
operator|)
argument_list|,
sizeof|sizeof
argument_list|(
name|ads
operator|->
name|u
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|AH_TRUE
return|;
block|}
end_function

begin_comment
comment|/*  * Process an RX descriptor, and return the status to the caller.  * Copy some hardware specific items into the software portion  * of the descriptor.  *  * NB: the caller is responsible for validating the memory contents  *     of the descriptor (e.g. flushing any cached copy).  */
end_comment

begin_function
name|HAL_STATUS
name|ar5416ProcRxDesc
parameter_list|(
name|struct
name|ath_hal
modifier|*
name|ah
parameter_list|,
name|struct
name|ath_desc
modifier|*
name|ds
parameter_list|,
name|uint32_t
name|pa
parameter_list|,
name|struct
name|ath_desc
modifier|*
name|nds
parameter_list|,
name|uint64_t
name|tsf
parameter_list|,
name|struct
name|ath_rx_status
modifier|*
name|rs
parameter_list|)
block|{
name|struct
name|ar5416_desc
modifier|*
name|ads
init|=
name|AR5416DESC
argument_list|(
name|ds
argument_list|)
decl_stmt|;
if|if
condition|(
operator|(
name|ads
operator|->
name|ds_rxstatus8
operator|&
name|AR_RxDone
operator|)
operator|==
literal|0
condition|)
return|return
name|HAL_EINPROGRESS
return|;
name|rs
operator|->
name|rs_status
operator|=
literal|0
expr_stmt|;
name|rs
operator|->
name|rs_flags
operator|=
literal|0
expr_stmt|;
name|rs
operator|->
name|rs_datalen
operator|=
name|ads
operator|->
name|ds_rxstatus1
operator|&
name|AR_DataLen
expr_stmt|;
name|rs
operator|->
name|rs_tstamp
operator|=
name|ads
operator|->
name|AR_RcvTimestamp
expr_stmt|;
comment|/* XXX what about KeyCacheMiss? */
name|rs
operator|->
name|rs_rssi
operator|=
name|MS
argument_list|(
name|ads
operator|->
name|ds_rxstatus4
argument_list|,
name|AR_RxRSSICombined
argument_list|)
expr_stmt|;
name|rs
operator|->
name|rs_rssi_ctl
index|[
literal|0
index|]
operator|=
name|MS
argument_list|(
name|ads
operator|->
name|ds_rxstatus0
argument_list|,
name|AR_RxRSSIAnt00
argument_list|)
expr_stmt|;
name|rs
operator|->
name|rs_rssi_ctl
index|[
literal|1
index|]
operator|=
name|MS
argument_list|(
name|ads
operator|->
name|ds_rxstatus0
argument_list|,
name|AR_RxRSSIAnt01
argument_list|)
expr_stmt|;
name|rs
operator|->
name|rs_rssi_ctl
index|[
literal|2
index|]
operator|=
name|MS
argument_list|(
name|ads
operator|->
name|ds_rxstatus0
argument_list|,
name|AR_RxRSSIAnt02
argument_list|)
expr_stmt|;
name|rs
operator|->
name|rs_rssi_ext
index|[
literal|0
index|]
operator|=
name|MS
argument_list|(
name|ads
operator|->
name|ds_rxstatus4
argument_list|,
name|AR_RxRSSIAnt10
argument_list|)
expr_stmt|;
name|rs
operator|->
name|rs_rssi_ext
index|[
literal|1
index|]
operator|=
name|MS
argument_list|(
name|ads
operator|->
name|ds_rxstatus4
argument_list|,
name|AR_RxRSSIAnt11
argument_list|)
expr_stmt|;
name|rs
operator|->
name|rs_rssi_ext
index|[
literal|2
index|]
operator|=
name|MS
argument_list|(
name|ads
operator|->
name|ds_rxstatus4
argument_list|,
name|AR_RxRSSIAnt12
argument_list|)
expr_stmt|;
if|if
condition|(
name|ads
operator|->
name|ds_rxstatus8
operator|&
name|AR_RxKeyIdxValid
condition|)
name|rs
operator|->
name|rs_keyix
operator|=
name|MS
argument_list|(
name|ads
operator|->
name|ds_rxstatus8
argument_list|,
name|AR_KeyIdx
argument_list|)
expr_stmt|;
else|else
name|rs
operator|->
name|rs_keyix
operator|=
name|HAL_RXKEYIX_INVALID
expr_stmt|;
comment|/* NB: caller expected to do rate table mapping */
name|rs
operator|->
name|rs_rate
operator|=
name|RXSTATUS_RATE
argument_list|(
name|ah
argument_list|,
name|ads
argument_list|)
expr_stmt|;
name|rs
operator|->
name|rs_more
operator|=
operator|(
name|ads
operator|->
name|ds_rxstatus1
operator|&
name|AR_RxMore
operator|)
condition|?
literal|1
else|:
literal|0
expr_stmt|;
name|rs
operator|->
name|rs_isaggr
operator|=
operator|(
name|ads
operator|->
name|ds_rxstatus8
operator|&
name|AR_RxAggr
operator|)
condition|?
literal|1
else|:
literal|0
expr_stmt|;
name|rs
operator|->
name|rs_moreaggr
operator|=
operator|(
name|ads
operator|->
name|ds_rxstatus8
operator|&
name|AR_RxMoreAggr
operator|)
condition|?
literal|1
else|:
literal|0
expr_stmt|;
name|rs
operator|->
name|rs_antenna
operator|=
name|MS
argument_list|(
name|ads
operator|->
name|ds_rxstatus3
argument_list|,
name|AR_RxAntenna
argument_list|)
expr_stmt|;
if|if
condition|(
name|ads
operator|->
name|ds_rxstatus3
operator|&
name|AR_GI
condition|)
name|rs
operator|->
name|rs_flags
operator||=
name|HAL_RX_GI
expr_stmt|;
if|if
condition|(
name|ads
operator|->
name|ds_rxstatus3
operator|&
name|AR_2040
condition|)
name|rs
operator|->
name|rs_flags
operator||=
name|HAL_RX_2040
expr_stmt|;
comment|/* 	 * Only the AR9280 and later chips support STBC RX, so 	 * ensure we only set this bit for those chips. 	 */
if|if
condition|(
name|AR_SREV_MERLIN_10_OR_LATER
argument_list|(
name|ah
argument_list|)
operator|&&
name|ads
operator|->
name|ds_rxstatus3
operator|&
name|AR_STBCFrame
condition|)
name|rs
operator|->
name|rs_flags
operator||=
name|HAL_RX_STBC
expr_stmt|;
if|if
condition|(
name|ads
operator|->
name|ds_rxstatus8
operator|&
name|AR_PreDelimCRCErr
condition|)
name|rs
operator|->
name|rs_flags
operator||=
name|HAL_RX_DELIM_CRC_PRE
expr_stmt|;
if|if
condition|(
name|ads
operator|->
name|ds_rxstatus8
operator|&
name|AR_PostDelimCRCErr
condition|)
name|rs
operator|->
name|rs_flags
operator||=
name|HAL_RX_DELIM_CRC_POST
expr_stmt|;
if|if
condition|(
name|ads
operator|->
name|ds_rxstatus8
operator|&
name|AR_DecryptBusyErr
condition|)
name|rs
operator|->
name|rs_flags
operator||=
name|HAL_RX_DECRYPT_BUSY
expr_stmt|;
if|if
condition|(
name|ads
operator|->
name|ds_rxstatus8
operator|&
name|AR_HiRxChain
condition|)
name|rs
operator|->
name|rs_flags
operator||=
name|HAL_RX_HI_RX_CHAIN
expr_stmt|;
if|if
condition|(
operator|(
name|ads
operator|->
name|ds_rxstatus8
operator|&
name|AR_RxFrameOK
operator|)
operator|==
literal|0
condition|)
block|{
comment|/* 		 * These four bits should not be set together.  The 		 * 5416 spec states a Michael error can only occur if 		 * DecryptCRCErr not set (and TKIP is used).  Experience 		 * indicates however that you can also get Michael errors 		 * when a CRC error is detected, but these are specious. 		 * Consequently we filter them out here so we don't 		 * confuse and/or complicate drivers. 		 */
comment|/* 		 * The AR5416 sometimes sets both AR_CRCErr and AR_PHYErr 		 * when reporting radar pulses.  In this instance 		 * set HAL_RXERR_PHY as well as HAL_RXERR_CRC and 		 * let the driver layer figure out what to do. 		 * 		 * See PR kern/169362. 		 */
if|if
condition|(
name|ads
operator|->
name|ds_rxstatus8
operator|&
name|AR_PHYErr
condition|)
block|{
name|u_int
name|phyerr
decl_stmt|;
comment|/* 			 * Packets with OFDM_RESTART on post delimiter are CRC OK and 			 * usable and MAC ACKs them. 			 * To avoid packet from being lost, we remove the PHY Err flag 			 * so that driver layer does not drop them. 			 */
name|phyerr
operator|=
name|MS
argument_list|(
name|ads
operator|->
name|ds_rxstatus8
argument_list|,
name|AR_PHYErrCode
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|phyerr
operator|==
name|HAL_PHYERR_OFDM_RESTART
operator|)
operator|&&
operator|(
name|ads
operator|->
name|ds_rxstatus8
operator|&
name|AR_PostDelimCRCErr
operator|)
condition|)
block|{
name|ath_hal_printf
argument_list|(
name|ah
argument_list|,
literal|"%s: OFDM_RESTART on post-delim CRC error\n"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
name|rs
operator|->
name|rs_phyerr
operator|=
literal|0
expr_stmt|;
block|}
else|else
block|{
name|rs
operator|->
name|rs_status
operator||=
name|HAL_RXERR_PHY
expr_stmt|;
name|rs
operator|->
name|rs_phyerr
operator|=
name|phyerr
expr_stmt|;
block|}
block|}
if|if
condition|(
name|ads
operator|->
name|ds_rxstatus8
operator|&
name|AR_CRCErr
condition|)
name|rs
operator|->
name|rs_status
operator||=
name|HAL_RXERR_CRC
expr_stmt|;
elseif|else
if|if
condition|(
name|ads
operator|->
name|ds_rxstatus8
operator|&
name|AR_DecryptCRCErr
condition|)
name|rs
operator|->
name|rs_status
operator||=
name|HAL_RXERR_DECRYPT
expr_stmt|;
elseif|else
if|if
condition|(
name|ads
operator|->
name|ds_rxstatus8
operator|&
name|AR_MichaelErr
condition|)
name|rs
operator|->
name|rs_status
operator||=
name|HAL_RXERR_MIC
expr_stmt|;
block|}
return|return
name|HAL_OK
return|;
block|}
end_function

end_unit


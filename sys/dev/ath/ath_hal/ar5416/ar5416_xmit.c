begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Copyright (c) 2002-2009 Sam Leffler, Errno Consulting  * Copyright (c) 2002-2008 Atheros Communications, Inc.  *  * Permission to use, copy, modify, and/or distribute this software for any  * purpose with or without fee is hereby granted, provided that the above  * copyright notice and this permission notice appear in all copies.  *  * THE SOFTWARE IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL WARRANTIES  * WITH REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF  * MERCHANTABILITY AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR  * ANY SPECIAL, DIRECT, INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES  * WHATSOEVER RESULTING FROM LOSS OF USE, DATA OR PROFITS, WHETHER IN AN  * ACTION OF CONTRACT, NEGLIGENCE OR OTHER TORTIOUS ACTION, ARISING OUT OF  * OR IN CONNECTION WITH THE USE OR PERFORMANCE OF THIS SOFTWARE.  *  * $FreeBSD$  */
end_comment

begin_include
include|#
directive|include
file|"opt_ah.h"
end_include

begin_include
include|#
directive|include
file|"ah.h"
end_include

begin_include
include|#
directive|include
file|"ah_desc.h"
end_include

begin_include
include|#
directive|include
file|"ah_internal.h"
end_include

begin_include
include|#
directive|include
file|"ar5416/ar5416.h"
end_include

begin_include
include|#
directive|include
file|"ar5416/ar5416reg.h"
end_include

begin_include
include|#
directive|include
file|"ar5416/ar5416phy.h"
end_include

begin_include
include|#
directive|include
file|"ar5416/ar5416desc.h"
end_include

begin_comment
comment|/*  * Stop transmit on the specified queue  */
end_comment

begin_function
name|HAL_BOOL
name|ar5416StopTxDma
parameter_list|(
name|struct
name|ath_hal
modifier|*
name|ah
parameter_list|,
name|u_int
name|q
parameter_list|)
block|{
define|#
directive|define
name|STOP_DMA_TIMEOUT
value|4000
comment|/* us */
define|#
directive|define
name|STOP_DMA_ITER
value|100
comment|/* us */
name|u_int
name|i
decl_stmt|;
name|HALASSERT
argument_list|(
name|q
operator|<
name|AH_PRIVATE
argument_list|(
name|ah
argument_list|)
operator|->
name|ah_caps
operator|.
name|halTotalQueues
argument_list|)
expr_stmt|;
name|HALASSERT
argument_list|(
name|AH5212
argument_list|(
name|ah
argument_list|)
operator|->
name|ah_txq
index|[
name|q
index|]
operator|.
name|tqi_type
operator|!=
name|HAL_TX_QUEUE_INACTIVE
argument_list|)
expr_stmt|;
name|OS_REG_WRITE
argument_list|(
name|ah
argument_list|,
name|AR_Q_TXD
argument_list|,
literal|1
operator|<<
name|q
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
name|STOP_DMA_TIMEOUT
operator|/
name|STOP_DMA_ITER
init|;
name|i
operator|!=
literal|0
condition|;
name|i
operator|--
control|)
block|{
if|if
condition|(
name|ar5212NumTxPending
argument_list|(
name|ah
argument_list|,
name|q
argument_list|)
operator|==
literal|0
condition|)
break|break;
name|OS_DELAY
argument_list|(
name|STOP_DMA_ITER
argument_list|)
expr_stmt|;
block|}
ifdef|#
directive|ifdef
name|AH_DEBUG
if|if
condition|(
name|i
operator|==
literal|0
condition|)
block|{
name|HALDEBUG
argument_list|(
name|ah
argument_list|,
name|HAL_DEBUG_ANY
argument_list|,
literal|"%s: queue %u DMA did not stop in 400 msec\n"
argument_list|,
name|__func__
argument_list|,
name|q
argument_list|)
expr_stmt|;
name|HALDEBUG
argument_list|(
name|ah
argument_list|,
name|HAL_DEBUG_ANY
argument_list|,
literal|"%s: QSTS 0x%x Q_TXE 0x%x Q_TXD 0x%x Q_CBR 0x%x\n"
argument_list|,
name|__func__
argument_list|,
name|OS_REG_READ
argument_list|(
name|ah
argument_list|,
name|AR_QSTS
argument_list|(
name|q
argument_list|)
argument_list|)
argument_list|,
name|OS_REG_READ
argument_list|(
name|ah
argument_list|,
name|AR_Q_TXE
argument_list|)
argument_list|,
name|OS_REG_READ
argument_list|(
name|ah
argument_list|,
name|AR_Q_TXD
argument_list|)
argument_list|,
name|OS_REG_READ
argument_list|(
name|ah
argument_list|,
name|AR_QCBRCFG
argument_list|(
name|q
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
name|HALDEBUG
argument_list|(
name|ah
argument_list|,
name|HAL_DEBUG_ANY
argument_list|,
literal|"%s: Q_MISC 0x%x Q_RDYTIMECFG 0x%x Q_RDYTIMESHDN 0x%x\n"
argument_list|,
name|__func__
argument_list|,
name|OS_REG_READ
argument_list|(
name|ah
argument_list|,
name|AR_QMISC
argument_list|(
name|q
argument_list|)
argument_list|)
argument_list|,
name|OS_REG_READ
argument_list|(
name|ah
argument_list|,
name|AR_QRDYTIMECFG
argument_list|(
name|q
argument_list|)
argument_list|)
argument_list|,
name|OS_REG_READ
argument_list|(
name|ah
argument_list|,
name|AR_Q_RDYTIMESHDN
argument_list|)
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
comment|/* AH_DEBUG */
comment|/* ar5416 and up can kill packets at the PCU level */
if|if
condition|(
name|ar5212NumTxPending
argument_list|(
name|ah
argument_list|,
name|q
argument_list|)
condition|)
block|{
name|uint32_t
name|j
decl_stmt|;
name|HALDEBUG
argument_list|(
name|ah
argument_list|,
name|HAL_DEBUG_TXQUEUE
argument_list|,
literal|"%s: Num of pending TX Frames %d on Q %d\n"
argument_list|,
name|__func__
argument_list|,
name|ar5212NumTxPending
argument_list|(
name|ah
argument_list|,
name|q
argument_list|)
argument_list|,
name|q
argument_list|)
expr_stmt|;
comment|/* Kill last PCU Tx Frame */
comment|/* TODO - save off and restore current values of Q1/Q2? */
for|for
control|(
name|j
operator|=
literal|0
init|;
name|j
operator|<
literal|2
condition|;
name|j
operator|++
control|)
block|{
name|uint32_t
name|tsfLow
init|=
name|OS_REG_READ
argument_list|(
name|ah
argument_list|,
name|AR_TSF_L32
argument_list|)
decl_stmt|;
name|OS_REG_WRITE
argument_list|(
name|ah
argument_list|,
name|AR_QUIET2
argument_list|,
name|SM
argument_list|(
literal|10
argument_list|,
name|AR_QUIET2_QUIET_DUR
argument_list|)
argument_list|)
expr_stmt|;
name|OS_REG_WRITE
argument_list|(
name|ah
argument_list|,
name|AR_QUIET_PERIOD
argument_list|,
literal|100
argument_list|)
expr_stmt|;
name|OS_REG_WRITE
argument_list|(
name|ah
argument_list|,
name|AR_NEXT_QUIET
argument_list|,
name|tsfLow
operator|>>
literal|10
argument_list|)
expr_stmt|;
name|OS_REG_SET_BIT
argument_list|(
name|ah
argument_list|,
name|AR_TIMER_MODE
argument_list|,
name|AR_TIMER_MODE_QUIET
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|OS_REG_READ
argument_list|(
name|ah
argument_list|,
name|AR_TSF_L32
argument_list|)
operator|>>
literal|10
operator|)
operator|==
operator|(
name|tsfLow
operator|>>
literal|10
operator|)
condition|)
break|break;
name|HALDEBUG
argument_list|(
name|ah
argument_list|,
name|HAL_DEBUG_ANY
argument_list|,
literal|"%s: TSF moved while trying to set quiet time "
literal|"TSF: 0x%08x\n"
argument_list|,
name|__func__
argument_list|,
name|tsfLow
argument_list|)
expr_stmt|;
name|HALASSERT
argument_list|(
name|j
operator|<
literal|1
argument_list|)
expr_stmt|;
comment|/* TSF shouldn't count twice or reg access is taking forever */
block|}
name|OS_REG_SET_BIT
argument_list|(
name|ah
argument_list|,
name|AR_DIAG_SW
argument_list|,
name|AR_DIAG_CHAN_IDLE
argument_list|)
expr_stmt|;
comment|/* Allow the quiet mechanism to do its work */
name|OS_DELAY
argument_list|(
literal|200
argument_list|)
expr_stmt|;
name|OS_REG_CLR_BIT
argument_list|(
name|ah
argument_list|,
name|AR_TIMER_MODE
argument_list|,
name|AR_TIMER_MODE_QUIET
argument_list|)
expr_stmt|;
comment|/* Verify the transmit q is empty */
for|for
control|(
name|i
operator|=
name|STOP_DMA_TIMEOUT
operator|/
name|STOP_DMA_ITER
init|;
name|i
operator|!=
literal|0
condition|;
name|i
operator|--
control|)
block|{
if|if
condition|(
name|ar5212NumTxPending
argument_list|(
name|ah
argument_list|,
name|q
argument_list|)
operator|==
literal|0
condition|)
break|break;
name|OS_DELAY
argument_list|(
name|STOP_DMA_ITER
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|i
operator|==
literal|0
condition|)
block|{
name|HALDEBUG
argument_list|(
name|ah
argument_list|,
name|HAL_DEBUG_ANY
argument_list|,
literal|"%s: Failed to stop Tx DMA in %d msec after killing"
literal|" last frame\n"
argument_list|,
name|__func__
argument_list|,
name|STOP_DMA_TIMEOUT
operator|/
literal|1000
argument_list|)
expr_stmt|;
block|}
name|OS_REG_CLR_BIT
argument_list|(
name|ah
argument_list|,
name|AR_DIAG_SW
argument_list|,
name|AR_DIAG_CHAN_IDLE
argument_list|)
expr_stmt|;
block|}
name|OS_REG_WRITE
argument_list|(
name|ah
argument_list|,
name|AR_Q_TXD
argument_list|,
literal|0
argument_list|)
expr_stmt|;
return|return
operator|(
name|i
operator|!=
literal|0
operator|)
return|;
undef|#
directive|undef
name|STOP_DMA_ITER
undef|#
directive|undef
name|STOP_DMA_TIMEOUT
block|}
end_function

begin_define
define|#
directive|define
name|VALID_KEY_TYPES
define|\
value|((1<< HAL_KEY_TYPE_CLEAR) | (1<< HAL_KEY_TYPE_WEP)|\          (1<< HAL_KEY_TYPE_AES)   | (1<< HAL_KEY_TYPE_TKIP))
end_define

begin_define
define|#
directive|define
name|isValidKeyType
parameter_list|(
name|_t
parameter_list|)
value|((1<< (_t))& VALID_KEY_TYPES)
end_define

begin_define
define|#
directive|define
name|set11nTries
parameter_list|(
name|_series
parameter_list|,
name|_index
parameter_list|)
define|\
value|(SM((_series)[_index].Tries, AR_XmitDataTries##_index))
end_define

begin_define
define|#
directive|define
name|set11nRate
parameter_list|(
name|_series
parameter_list|,
name|_index
parameter_list|)
define|\
value|(SM((_series)[_index].Rate, AR_XmitRate##_index))
end_define

begin_define
define|#
directive|define
name|set11nPktDurRTSCTS
parameter_list|(
name|_series
parameter_list|,
name|_index
parameter_list|)
define|\
value|(SM((_series)[_index].PktDuration, AR_PacketDur##_index) |\          ((_series)[_index].RateFlags& HAL_RATESERIES_RTS_CTS   ?\          AR_RTSCTSQual##_index : 0))
end_define

begin_define
define|#
directive|define
name|set11nRateFlags
parameter_list|(
name|_series
parameter_list|,
name|_index
parameter_list|)
define|\
value|((_series)[_index].RateFlags& HAL_RATESERIES_2040 ? AR_2040_##_index : 0) \         |((_series)[_index].RateFlags& HAL_RATESERIES_HALFGI ? AR_GI##_index : 0) \         |SM((_series)[_index].ChSel, AR_ChainSel##_index)
end_define

begin_comment
comment|/*  * Descriptor Access Functions  */
end_comment

begin_define
define|#
directive|define
name|VALID_PKT_TYPES
define|\
value|((1<<HAL_PKT_TYPE_NORMAL)|(1<<HAL_PKT_TYPE_ATIM)|\          (1<<HAL_PKT_TYPE_PSPOLL)|(1<<HAL_PKT_TYPE_PROBE_RESP)|\          (1<<HAL_PKT_TYPE_BEACON)|(1<<HAL_PKT_TYPE_AMPDU))
end_define

begin_define
define|#
directive|define
name|isValidPktType
parameter_list|(
name|_t
parameter_list|)
value|((1<<(_t))& VALID_PKT_TYPES)
end_define

begin_define
define|#
directive|define
name|VALID_TX_RATES
define|\
value|((1<<0x0b)|(1<<0x0f)|(1<<0x0a)|(1<<0x0e)|(1<<0x09)|(1<<0x0d)|\          (1<<0x08)|(1<<0x0c)|(1<<0x1b)|(1<<0x1a)|(1<<0x1e)|(1<<0x19)|\          (1<<0x1d)|(1<<0x18)|(1<<0x1c))
end_define

begin_define
define|#
directive|define
name|isValidTxRate
parameter_list|(
name|_r
parameter_list|)
value|((1<<(_r))& VALID_TX_RATES)
end_define

begin_function
name|HAL_BOOL
name|ar5416SetupTxDesc
parameter_list|(
name|struct
name|ath_hal
modifier|*
name|ah
parameter_list|,
name|struct
name|ath_desc
modifier|*
name|ds
parameter_list|,
name|u_int
name|pktLen
parameter_list|,
name|u_int
name|hdrLen
parameter_list|,
name|HAL_PKT_TYPE
name|type
parameter_list|,
name|u_int
name|txPower
parameter_list|,
name|u_int
name|txRate0
parameter_list|,
name|u_int
name|txTries0
parameter_list|,
name|u_int
name|keyIx
parameter_list|,
name|u_int
name|antMode
parameter_list|,
name|u_int
name|flags
parameter_list|,
name|u_int
name|rtsctsRate
parameter_list|,
name|u_int
name|rtsctsDuration
parameter_list|,
name|u_int
name|compicvLen
parameter_list|,
name|u_int
name|compivLen
parameter_list|,
name|u_int
name|comp
parameter_list|)
block|{
define|#
directive|define
name|RTSCTS
value|(HAL_TXDESC_RTSENA|HAL_TXDESC_CTSENA)
name|struct
name|ar5416_desc
modifier|*
name|ads
init|=
name|AR5416DESC
argument_list|(
name|ds
argument_list|)
decl_stmt|;
name|struct
name|ath_hal_5416
modifier|*
name|ahp
init|=
name|AH5416
argument_list|(
name|ah
argument_list|)
decl_stmt|;
operator|(
name|void
operator|)
name|hdrLen
expr_stmt|;
name|HALASSERT
argument_list|(
name|txTries0
operator|!=
literal|0
argument_list|)
expr_stmt|;
name|HALASSERT
argument_list|(
name|isValidPktType
argument_list|(
name|type
argument_list|)
argument_list|)
expr_stmt|;
name|HALASSERT
argument_list|(
name|isValidTxRate
argument_list|(
name|txRate0
argument_list|)
argument_list|)
expr_stmt|;
name|HALASSERT
argument_list|(
operator|(
name|flags
operator|&
name|RTSCTS
operator|)
operator|!=
name|RTSCTS
argument_list|)
expr_stmt|;
comment|/* XXX validate antMode */
name|txPower
operator|=
operator|(
name|txPower
operator|+
name|AH5212
argument_list|(
name|ah
argument_list|)
operator|->
name|ah_txPowerIndexOffset
operator|)
expr_stmt|;
if|if
condition|(
name|txPower
operator|>
literal|63
condition|)
name|txPower
operator|=
literal|63
expr_stmt|;
name|ads
operator|->
name|ds_ctl0
operator|=
operator|(
name|pktLen
operator|&
name|AR_FrameLen
operator|)
operator||
operator|(
name|txPower
operator|<<
name|AR_XmitPower_S
operator|)
operator||
operator|(
name|flags
operator|&
name|HAL_TXDESC_VEOL
condition|?
name|AR_VEOL
else|:
literal|0
operator|)
operator||
operator|(
name|flags
operator|&
name|HAL_TXDESC_CLRDMASK
condition|?
name|AR_ClrDestMask
else|:
literal|0
operator|)
operator||
operator|(
name|flags
operator|&
name|HAL_TXDESC_INTREQ
condition|?
name|AR_TxIntrReq
else|:
literal|0
operator|)
expr_stmt|;
name|ads
operator|->
name|ds_ctl1
operator|=
operator|(
name|type
operator|<<
name|AR_FrameType_S
operator|)
operator||
operator|(
name|flags
operator|&
name|HAL_TXDESC_NOACK
condition|?
name|AR_NoAck
else|:
literal|0
operator|)
expr_stmt|;
name|ads
operator|->
name|ds_ctl2
operator|=
name|SM
argument_list|(
name|txTries0
argument_list|,
name|AR_XmitDataTries0
argument_list|)
operator||
operator|(
name|flags
operator|&
name|HAL_TXDESC_DURENA
condition|?
name|AR_DurUpdateEn
else|:
literal|0
operator|)
expr_stmt|;
name|ads
operator|->
name|ds_ctl3
operator|=
operator|(
name|txRate0
operator|<<
name|AR_XmitRate0_S
operator|)
expr_stmt|;
name|ads
operator|->
name|ds_ctl4
operator|=
literal|0
expr_stmt|;
name|ads
operator|->
name|ds_ctl5
operator|=
literal|0
expr_stmt|;
name|ads
operator|->
name|ds_ctl6
operator|=
literal|0
expr_stmt|;
name|ads
operator|->
name|ds_ctl7
operator|=
name|SM
argument_list|(
name|ahp
operator|->
name|ah_tx_chainmask
argument_list|,
name|AR_ChainSel0
argument_list|)
operator||
name|SM
argument_list|(
name|ahp
operator|->
name|ah_tx_chainmask
argument_list|,
name|AR_ChainSel1
argument_list|)
operator||
name|SM
argument_list|(
name|ahp
operator|->
name|ah_tx_chainmask
argument_list|,
name|AR_ChainSel2
argument_list|)
operator||
name|SM
argument_list|(
name|ahp
operator|->
name|ah_tx_chainmask
argument_list|,
name|AR_ChainSel3
argument_list|)
expr_stmt|;
name|ads
operator|->
name|ds_ctl8
operator|=
literal|0
expr_stmt|;
name|ads
operator|->
name|ds_ctl9
operator|=
operator|(
name|txPower
operator|<<
literal|24
operator|)
expr_stmt|;
comment|/* XXX? */
name|ads
operator|->
name|ds_ctl10
operator|=
operator|(
name|txPower
operator|<<
literal|24
operator|)
expr_stmt|;
comment|/* XXX? */
name|ads
operator|->
name|ds_ctl11
operator|=
operator|(
name|txPower
operator|<<
literal|24
operator|)
expr_stmt|;
comment|/* XXX? */
if|if
condition|(
name|keyIx
operator|!=
name|HAL_TXKEYIX_INVALID
condition|)
block|{
comment|/* XXX validate key index */
name|ads
operator|->
name|ds_ctl1
operator||=
name|SM
argument_list|(
name|keyIx
argument_list|,
name|AR_DestIdx
argument_list|)
expr_stmt|;
name|ads
operator|->
name|ds_ctl0
operator||=
name|AR_DestIdxValid
expr_stmt|;
name|ads
operator|->
name|ds_ctl6
operator||=
name|SM
argument_list|(
name|ahp
operator|->
name|ah_keytype
index|[
name|keyIx
index|]
argument_list|,
name|AR_EncrType
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|flags
operator|&
name|RTSCTS
condition|)
block|{
if|if
condition|(
operator|!
name|isValidTxRate
argument_list|(
name|rtsctsRate
argument_list|)
condition|)
block|{
name|HALDEBUG
argument_list|(
name|ah
argument_list|,
name|HAL_DEBUG_ANY
argument_list|,
literal|"%s: invalid rts/cts rate 0x%x\n"
argument_list|,
name|__func__
argument_list|,
name|rtsctsRate
argument_list|)
expr_stmt|;
return|return
name|AH_FALSE
return|;
block|}
comment|/* XXX validate rtsctsDuration */
name|ads
operator|->
name|ds_ctl0
operator||=
operator|(
name|flags
operator|&
name|HAL_TXDESC_CTSENA
condition|?
name|AR_CTSEnable
else|:
literal|0
operator|)
operator||
operator|(
name|flags
operator|&
name|HAL_TXDESC_RTSENA
condition|?
name|AR_RTSEnable
else|:
literal|0
operator|)
expr_stmt|;
name|ads
operator|->
name|ds_ctl7
operator||=
operator|(
name|rtsctsRate
operator|<<
name|AR_RTSCTSRate_S
operator|)
expr_stmt|;
block|}
if|if
condition|(
name|AR_SREV_KITE
argument_list|(
name|ah
argument_list|)
condition|)
block|{
name|ads
operator|->
name|ds_ctl8
operator|=
literal|0
expr_stmt|;
name|ads
operator|->
name|ds_ctl9
operator|=
literal|0
expr_stmt|;
name|ads
operator|->
name|ds_ctl10
operator|=
literal|0
expr_stmt|;
name|ads
operator|->
name|ds_ctl11
operator|=
literal|0
expr_stmt|;
block|}
return|return
name|AH_TRUE
return|;
undef|#
directive|undef
name|RTSCTS
block|}
end_function

begin_function
name|HAL_BOOL
name|ar5416SetupXTxDesc
parameter_list|(
name|struct
name|ath_hal
modifier|*
name|ah
parameter_list|,
name|struct
name|ath_desc
modifier|*
name|ds
parameter_list|,
name|u_int
name|txRate1
parameter_list|,
name|u_int
name|txTries1
parameter_list|,
name|u_int
name|txRate2
parameter_list|,
name|u_int
name|txTries2
parameter_list|,
name|u_int
name|txRate3
parameter_list|,
name|u_int
name|txTries3
parameter_list|)
block|{
name|struct
name|ar5416_desc
modifier|*
name|ads
init|=
name|AR5416DESC
argument_list|(
name|ds
argument_list|)
decl_stmt|;
if|if
condition|(
name|txTries1
condition|)
block|{
name|HALASSERT
argument_list|(
name|isValidTxRate
argument_list|(
name|txRate1
argument_list|)
argument_list|)
expr_stmt|;
name|ads
operator|->
name|ds_ctl2
operator||=
name|SM
argument_list|(
name|txTries1
argument_list|,
name|AR_XmitDataTries1
argument_list|)
expr_stmt|;
name|ads
operator|->
name|ds_ctl3
operator||=
operator|(
name|txRate1
operator|<<
name|AR_XmitRate1_S
operator|)
expr_stmt|;
block|}
if|if
condition|(
name|txTries2
condition|)
block|{
name|HALASSERT
argument_list|(
name|isValidTxRate
argument_list|(
name|txRate2
argument_list|)
argument_list|)
expr_stmt|;
name|ads
operator|->
name|ds_ctl2
operator||=
name|SM
argument_list|(
name|txTries2
argument_list|,
name|AR_XmitDataTries2
argument_list|)
expr_stmt|;
name|ads
operator|->
name|ds_ctl3
operator||=
operator|(
name|txRate2
operator|<<
name|AR_XmitRate2_S
operator|)
expr_stmt|;
block|}
if|if
condition|(
name|txTries3
condition|)
block|{
name|HALASSERT
argument_list|(
name|isValidTxRate
argument_list|(
name|txRate3
argument_list|)
argument_list|)
expr_stmt|;
name|ads
operator|->
name|ds_ctl2
operator||=
name|SM
argument_list|(
name|txTries3
argument_list|,
name|AR_XmitDataTries3
argument_list|)
expr_stmt|;
name|ads
operator|->
name|ds_ctl3
operator||=
operator|(
name|txRate3
operator|<<
name|AR_XmitRate3_S
operator|)
expr_stmt|;
block|}
return|return
name|AH_TRUE
return|;
block|}
end_function

begin_function
name|HAL_BOOL
name|ar5416FillTxDesc
parameter_list|(
name|struct
name|ath_hal
modifier|*
name|ah
parameter_list|,
name|struct
name|ath_desc
modifier|*
name|ds
parameter_list|,
name|u_int
name|segLen
parameter_list|,
name|HAL_BOOL
name|firstSeg
parameter_list|,
name|HAL_BOOL
name|lastSeg
parameter_list|,
specifier|const
name|struct
name|ath_desc
modifier|*
name|ds0
parameter_list|)
block|{
name|struct
name|ar5416_desc
modifier|*
name|ads
init|=
name|AR5416DESC
argument_list|(
name|ds
argument_list|)
decl_stmt|;
name|HALASSERT
argument_list|(
operator|(
name|segLen
operator|&
operator|~
name|AR_BufLen
operator|)
operator|==
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|firstSeg
condition|)
block|{
comment|/* 		 * First descriptor, don't clobber xmit control data 		 * setup by ar5212SetupTxDesc. 		 */
name|ads
operator|->
name|ds_ctl1
operator||=
name|segLen
operator||
operator|(
name|lastSeg
condition|?
literal|0
else|:
name|AR_TxMore
operator|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|lastSeg
condition|)
block|{
comment|/* !firstSeg&& lastSeg */
comment|/* 		 * Last descriptor in a multi-descriptor frame, 		 * copy the multi-rate transmit parameters from 		 * the first frame for processing on completion.  		 */
name|ads
operator|->
name|ds_ctl0
operator|=
literal|0
expr_stmt|;
name|ads
operator|->
name|ds_ctl1
operator|=
name|segLen
expr_stmt|;
ifdef|#
directive|ifdef
name|AH_NEED_DESC_SWAP
name|ads
operator|->
name|ds_ctl2
operator|=
name|__bswap32
argument_list|(
name|AR5416DESC_CONST
argument_list|(
name|ds0
argument_list|)
operator|->
name|ds_ctl2
argument_list|)
expr_stmt|;
name|ads
operator|->
name|ds_ctl3
operator|=
name|__bswap32
argument_list|(
name|AR5416DESC_CONST
argument_list|(
name|ds0
argument_list|)
operator|->
name|ds_ctl3
argument_list|)
expr_stmt|;
else|#
directive|else
name|ads
operator|->
name|ds_ctl2
operator|=
name|AR5416DESC_CONST
argument_list|(
name|ds0
argument_list|)
operator|->
name|ds_ctl2
expr_stmt|;
name|ads
operator|->
name|ds_ctl3
operator|=
name|AR5416DESC_CONST
argument_list|(
name|ds0
argument_list|)
operator|->
name|ds_ctl3
expr_stmt|;
endif|#
directive|endif
block|}
else|else
block|{
comment|/* !firstSeg&& !lastSeg */
comment|/* 		 * Intermediate descriptor in a multi-descriptor frame. 		 */
name|ads
operator|->
name|ds_ctl0
operator|=
literal|0
expr_stmt|;
name|ads
operator|->
name|ds_ctl1
operator|=
name|segLen
operator||
name|AR_TxMore
expr_stmt|;
name|ads
operator|->
name|ds_ctl2
operator|=
literal|0
expr_stmt|;
name|ads
operator|->
name|ds_ctl3
operator|=
literal|0
expr_stmt|;
block|}
comment|/* XXX only on last descriptor? */
name|OS_MEMZERO
argument_list|(
name|ads
operator|->
name|u
operator|.
name|tx
operator|.
name|status
argument_list|,
sizeof|sizeof
argument_list|(
name|ads
operator|->
name|u
operator|.
name|tx
operator|.
name|status
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|AH_TRUE
return|;
block|}
end_function

begin_function
name|HAL_BOOL
name|ar5416ChainTxDesc
parameter_list|(
name|struct
name|ath_hal
modifier|*
name|ah
parameter_list|,
name|struct
name|ath_desc
modifier|*
name|ds
parameter_list|,
name|u_int
name|pktLen
parameter_list|,
name|u_int
name|hdrLen
parameter_list|,
name|HAL_PKT_TYPE
name|type
parameter_list|,
name|u_int
name|keyIx
parameter_list|,
name|HAL_CIPHER
name|cipher
parameter_list|,
name|uint8_t
name|delims
parameter_list|,
name|u_int
name|segLen
parameter_list|,
name|HAL_BOOL
name|firstSeg
parameter_list|,
name|HAL_BOOL
name|lastSeg
parameter_list|)
block|{
name|struct
name|ar5416_desc
modifier|*
name|ads
init|=
name|AR5416DESC
argument_list|(
name|ds
argument_list|)
decl_stmt|;
name|uint32_t
modifier|*
name|ds_txstatus
init|=
name|AR5416_DS_TXSTATUS
argument_list|(
name|ah
argument_list|,
name|ads
argument_list|)
decl_stmt|;
name|struct
name|ath_hal_5416
modifier|*
name|ahp
init|=
name|AH5416
argument_list|(
name|ah
argument_list|)
decl_stmt|;
name|int
name|isaggr
init|=
literal|0
decl_stmt|;
operator|(
name|void
operator|)
name|hdrLen
expr_stmt|;
operator|(
name|void
operator|)
name|ah
expr_stmt|;
name|HALASSERT
argument_list|(
operator|(
name|segLen
operator|&
operator|~
name|AR_BufLen
operator|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|HALASSERT
argument_list|(
name|isValidPktType
argument_list|(
name|type
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|type
operator|==
name|HAL_PKT_TYPE_AMPDU
condition|)
block|{
name|type
operator|=
name|HAL_PKT_TYPE_NORMAL
expr_stmt|;
name|isaggr
operator|=
literal|1
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|firstSeg
condition|)
block|{
name|OS_MEMZERO
argument_list|(
name|ds
operator|->
name|ds_hw
argument_list|,
name|AR5416_DESC_TX_CTL_SZ
argument_list|)
expr_stmt|;
block|}
name|ads
operator|->
name|ds_ctl0
operator|=
operator|(
name|pktLen
operator|&
name|AR_FrameLen
operator|)
expr_stmt|;
name|ads
operator|->
name|ds_ctl1
operator|=
operator|(
name|type
operator|<<
name|AR_FrameType_S
operator|)
operator||
operator|(
name|isaggr
condition|?
operator|(
name|AR_IsAggr
operator||
name|AR_MoreAggr
operator|)
else|:
literal|0
operator|)
expr_stmt|;
name|ads
operator|->
name|ds_ctl2
operator|=
literal|0
expr_stmt|;
name|ads
operator|->
name|ds_ctl3
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|keyIx
operator|!=
name|HAL_TXKEYIX_INVALID
condition|)
block|{
comment|/* XXX validate key index */
name|ads
operator|->
name|ds_ctl1
operator||=
name|SM
argument_list|(
name|keyIx
argument_list|,
name|AR_DestIdx
argument_list|)
expr_stmt|;
name|ads
operator|->
name|ds_ctl0
operator||=
name|AR_DestIdxValid
expr_stmt|;
block|}
name|ads
operator|->
name|ds_ctl6
operator|=
name|SM
argument_list|(
name|ahp
operator|->
name|ah_keytype
index|[
name|cipher
index|]
argument_list|,
name|AR_EncrType
argument_list|)
expr_stmt|;
if|if
condition|(
name|isaggr
condition|)
block|{
name|ads
operator|->
name|ds_ctl6
operator||=
name|SM
argument_list|(
name|delims
argument_list|,
name|AR_PadDelim
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|firstSeg
condition|)
block|{
name|ads
operator|->
name|ds_ctl1
operator||=
name|segLen
operator||
operator|(
name|lastSeg
condition|?
literal|0
else|:
name|AR_TxMore
operator|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|lastSeg
condition|)
block|{
comment|/* !firstSeg&& lastSeg */
name|ads
operator|->
name|ds_ctl0
operator|=
literal|0
expr_stmt|;
name|ads
operator|->
name|ds_ctl1
operator||=
name|segLen
expr_stmt|;
block|}
else|else
block|{
comment|/* !firstSeg&& !lastSeg */
comment|/* 		 * Intermediate descriptor in a multi-descriptor frame. 		 */
name|ads
operator|->
name|ds_ctl0
operator|=
literal|0
expr_stmt|;
name|ads
operator|->
name|ds_ctl1
operator||=
name|segLen
operator||
name|AR_TxMore
expr_stmt|;
block|}
name|ds_txstatus
index|[
literal|0
index|]
operator|=
name|ds_txstatus
index|[
literal|1
index|]
operator|=
literal|0
expr_stmt|;
name|ds_txstatus
index|[
literal|9
index|]
operator|&=
operator|~
name|AR_TxDone
expr_stmt|;
return|return
name|AH_TRUE
return|;
block|}
end_function

begin_function
name|HAL_BOOL
name|ar5416SetupFirstTxDesc
parameter_list|(
name|struct
name|ath_hal
modifier|*
name|ah
parameter_list|,
name|struct
name|ath_desc
modifier|*
name|ds
parameter_list|,
name|u_int
name|aggrLen
parameter_list|,
name|u_int
name|flags
parameter_list|,
name|u_int
name|txPower
parameter_list|,
name|u_int
name|txRate0
parameter_list|,
name|u_int
name|txTries0
parameter_list|,
name|u_int
name|antMode
parameter_list|,
name|u_int
name|rtsctsRate
parameter_list|,
name|u_int
name|rtsctsDuration
parameter_list|)
block|{
define|#
directive|define
name|RTSCTS
value|(HAL_TXDESC_RTSENA|HAL_TXDESC_CTSENA)
name|struct
name|ar5416_desc
modifier|*
name|ads
init|=
name|AR5416DESC
argument_list|(
name|ds
argument_list|)
decl_stmt|;
name|struct
name|ath_hal_5212
modifier|*
name|ahp
init|=
name|AH5212
argument_list|(
name|ah
argument_list|)
decl_stmt|;
name|HALASSERT
argument_list|(
name|txTries0
operator|!=
literal|0
argument_list|)
expr_stmt|;
name|HALASSERT
argument_list|(
name|isValidTxRate
argument_list|(
name|txRate0
argument_list|)
argument_list|)
expr_stmt|;
name|HALASSERT
argument_list|(
operator|(
name|flags
operator|&
name|RTSCTS
operator|)
operator|!=
name|RTSCTS
argument_list|)
expr_stmt|;
comment|/* XXX validate antMode */
name|txPower
operator|=
operator|(
name|txPower
operator|+
name|ahp
operator|->
name|ah_txPowerIndexOffset
operator|)
expr_stmt|;
if|if
condition|(
name|txPower
operator|>
literal|63
condition|)
name|txPower
operator|=
literal|63
expr_stmt|;
name|ads
operator|->
name|ds_ctl0
operator||=
operator|(
name|txPower
operator|<<
name|AR_XmitPower_S
operator|)
operator||
operator|(
name|flags
operator|&
name|HAL_TXDESC_VEOL
condition|?
name|AR_VEOL
else|:
literal|0
operator|)
operator||
operator|(
name|flags
operator|&
name|HAL_TXDESC_CLRDMASK
condition|?
name|AR_ClrDestMask
else|:
literal|0
operator|)
operator||
operator|(
name|flags
operator|&
name|HAL_TXDESC_INTREQ
condition|?
name|AR_TxIntrReq
else|:
literal|0
operator|)
expr_stmt|;
name|ads
operator|->
name|ds_ctl1
operator||=
operator|(
name|flags
operator|&
name|HAL_TXDESC_NOACK
condition|?
name|AR_NoAck
else|:
literal|0
operator|)
expr_stmt|;
name|ads
operator|->
name|ds_ctl2
operator||=
name|SM
argument_list|(
name|txTries0
argument_list|,
name|AR_XmitDataTries0
argument_list|)
expr_stmt|;
name|ads
operator|->
name|ds_ctl3
operator||=
operator|(
name|txRate0
operator|<<
name|AR_XmitRate0_S
operator|)
expr_stmt|;
name|ads
operator|->
name|ds_ctl7
operator|=
name|SM
argument_list|(
name|AH5416
argument_list|(
name|ah
argument_list|)
operator|->
name|ah_tx_chainmask
argument_list|,
name|AR_ChainSel0
argument_list|)
operator||
name|SM
argument_list|(
name|AH5416
argument_list|(
name|ah
argument_list|)
operator|->
name|ah_tx_chainmask
argument_list|,
name|AR_ChainSel1
argument_list|)
operator||
name|SM
argument_list|(
name|AH5416
argument_list|(
name|ah
argument_list|)
operator|->
name|ah_tx_chainmask
argument_list|,
name|AR_ChainSel2
argument_list|)
operator||
name|SM
argument_list|(
name|AH5416
argument_list|(
name|ah
argument_list|)
operator|->
name|ah_tx_chainmask
argument_list|,
name|AR_ChainSel3
argument_list|)
expr_stmt|;
comment|/* NB: no V1 WAR */
name|ads
operator|->
name|ds_ctl8
operator|=
literal|0
expr_stmt|;
name|ads
operator|->
name|ds_ctl9
operator|=
operator|(
name|txPower
operator|<<
literal|24
operator|)
expr_stmt|;
name|ads
operator|->
name|ds_ctl10
operator|=
operator|(
name|txPower
operator|<<
literal|24
operator|)
expr_stmt|;
name|ads
operator|->
name|ds_ctl11
operator|=
operator|(
name|txPower
operator|<<
literal|24
operator|)
expr_stmt|;
name|ads
operator|->
name|ds_ctl6
operator|&=
operator|~
operator|(
literal|0xffff
operator|)
expr_stmt|;
name|ads
operator|->
name|ds_ctl6
operator||=
name|SM
argument_list|(
name|aggrLen
argument_list|,
name|AR_AggrLen
argument_list|)
expr_stmt|;
if|if
condition|(
name|flags
operator|&
name|RTSCTS
condition|)
block|{
comment|/* XXX validate rtsctsDuration */
name|ads
operator|->
name|ds_ctl0
operator||=
operator|(
name|flags
operator|&
name|HAL_TXDESC_CTSENA
condition|?
name|AR_CTSEnable
else|:
literal|0
operator|)
operator||
operator|(
name|flags
operator|&
name|HAL_TXDESC_RTSENA
condition|?
name|AR_RTSEnable
else|:
literal|0
operator|)
expr_stmt|;
block|}
if|if
condition|(
name|AR_SREV_KITE
argument_list|(
name|ah
argument_list|)
condition|)
block|{
name|ads
operator|->
name|ds_ctl8
operator|=
literal|0
expr_stmt|;
name|ads
operator|->
name|ds_ctl9
operator|=
literal|0
expr_stmt|;
name|ads
operator|->
name|ds_ctl10
operator|=
literal|0
expr_stmt|;
name|ads
operator|->
name|ds_ctl11
operator|=
literal|0
expr_stmt|;
block|}
return|return
name|AH_TRUE
return|;
undef|#
directive|undef
name|RTSCTS
block|}
end_function

begin_function
name|HAL_BOOL
name|ar5416SetupLastTxDesc
parameter_list|(
name|struct
name|ath_hal
modifier|*
name|ah
parameter_list|,
name|struct
name|ath_desc
modifier|*
name|ds
parameter_list|,
specifier|const
name|struct
name|ath_desc
modifier|*
name|ds0
parameter_list|)
block|{
name|struct
name|ar5416_desc
modifier|*
name|ads
init|=
name|AR5416DESC
argument_list|(
name|ds
argument_list|)
decl_stmt|;
name|ads
operator|->
name|ds_ctl1
operator|&=
operator|~
name|AR_MoreAggr
expr_stmt|;
name|ads
operator|->
name|ds_ctl6
operator|&=
operator|~
name|AR_PadDelim
expr_stmt|;
comment|/* hack to copy rate info to last desc for later processing */
ifdef|#
directive|ifdef
name|AH_NEED_DESC_SWAP
name|ads
operator|->
name|ds_ctl2
operator|=
name|__bswap32
argument_list|(
name|AR5416DESC_CONST
argument_list|(
name|ds0
argument_list|)
operator|->
name|ds_ctl2
argument_list|)
expr_stmt|;
name|ads
operator|->
name|ds_ctl3
operator|=
name|__bswap32
argument_list|(
name|AR5416DESC_CONST
argument_list|(
name|ds0
argument_list|)
operator|->
name|ds_ctl3
argument_list|)
expr_stmt|;
else|#
directive|else
name|ads
operator|->
name|ds_ctl2
operator|=
name|AR5416DESC_CONST
argument_list|(
name|ds0
argument_list|)
operator|->
name|ds_ctl2
expr_stmt|;
name|ads
operator|->
name|ds_ctl3
operator|=
name|AR5416DESC_CONST
argument_list|(
name|ds0
argument_list|)
operator|->
name|ds_ctl3
expr_stmt|;
endif|#
directive|endif
return|return
name|AH_TRUE
return|;
block|}
end_function

begin_ifdef
ifdef|#
directive|ifdef
name|AH_NEED_DESC_SWAP
end_ifdef

begin_comment
comment|/* Swap transmit descriptor */
end_comment

begin_function
specifier|static
name|__inline
name|void
name|ar5416SwapTxDesc
parameter_list|(
name|struct
name|ath_desc
modifier|*
name|ds
parameter_list|)
block|{
name|ds
operator|->
name|ds_data
operator|=
name|__bswap32
argument_list|(
name|ds
operator|->
name|ds_data
argument_list|)
expr_stmt|;
name|ds
operator|->
name|ds_ctl0
operator|=
name|__bswap32
argument_list|(
name|ds
operator|->
name|ds_ctl0
argument_list|)
expr_stmt|;
name|ds
operator|->
name|ds_ctl1
operator|=
name|__bswap32
argument_list|(
name|ds
operator|->
name|ds_ctl1
argument_list|)
expr_stmt|;
name|ds
operator|->
name|ds_hw
index|[
literal|0
index|]
operator|=
name|__bswap32
argument_list|(
name|ds
operator|->
name|ds_hw
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
name|ds
operator|->
name|ds_hw
index|[
literal|1
index|]
operator|=
name|__bswap32
argument_list|(
name|ds
operator|->
name|ds_hw
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
name|ds
operator|->
name|ds_hw
index|[
literal|2
index|]
operator|=
name|__bswap32
argument_list|(
name|ds
operator|->
name|ds_hw
index|[
literal|2
index|]
argument_list|)
expr_stmt|;
name|ds
operator|->
name|ds_hw
index|[
literal|3
index|]
operator|=
name|__bswap32
argument_list|(
name|ds
operator|->
name|ds_hw
index|[
literal|3
index|]
argument_list|)
expr_stmt|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/*  * Processing of HW TX descriptor.  */
end_comment

begin_function
name|HAL_STATUS
name|ar5416ProcTxDesc
parameter_list|(
name|struct
name|ath_hal
modifier|*
name|ah
parameter_list|,
name|struct
name|ath_desc
modifier|*
name|ds
parameter_list|,
name|struct
name|ath_tx_status
modifier|*
name|ts
parameter_list|)
block|{
name|struct
name|ar5416_desc
modifier|*
name|ads
init|=
name|AR5416DESC
argument_list|(
name|ds
argument_list|)
decl_stmt|;
name|uint32_t
modifier|*
name|ds_txstatus
init|=
name|AR5416_DS_TXSTATUS
argument_list|(
name|ah
argument_list|,
name|ads
argument_list|)
decl_stmt|;
ifdef|#
directive|ifdef
name|AH_NEED_DESC_SWAP
if|if
condition|(
operator|(
name|ds_txstatus
index|[
literal|9
index|]
operator|&
name|__bswap32
argument_list|(
name|AR_TxDone
argument_list|)
operator|)
operator|==
literal|0
condition|)
return|return
name|HAL_EINPROGRESS
return|;
name|ar5416SwapTxDesc
argument_list|(
name|ds
argument_list|)
expr_stmt|;
else|#
directive|else
if|if
condition|(
operator|(
name|ds_txstatus
index|[
literal|9
index|]
operator|&
name|AR_TxDone
operator|)
operator|==
literal|0
condition|)
return|return
name|HAL_EINPROGRESS
return|;
endif|#
directive|endif
comment|/* Update software copies of the HW status */
name|ts
operator|->
name|ts_seqnum
operator|=
name|MS
argument_list|(
name|ds_txstatus
index|[
literal|9
index|]
argument_list|,
name|AR_SeqNum
argument_list|)
expr_stmt|;
name|ts
operator|->
name|ts_tstamp
operator|=
name|AR_SendTimestamp
argument_list|(
name|ds_txstatus
argument_list|)
expr_stmt|;
name|ts
operator|->
name|ts_status
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|ds_txstatus
index|[
literal|1
index|]
operator|&
name|AR_ExcessiveRetries
condition|)
name|ts
operator|->
name|ts_status
operator||=
name|HAL_TXERR_XRETRY
expr_stmt|;
if|if
condition|(
name|ds_txstatus
index|[
literal|1
index|]
operator|&
name|AR_Filtered
condition|)
name|ts
operator|->
name|ts_status
operator||=
name|HAL_TXERR_FILT
expr_stmt|;
if|if
condition|(
name|ds_txstatus
index|[
literal|1
index|]
operator|&
name|AR_FIFOUnderrun
condition|)
name|ts
operator|->
name|ts_status
operator||=
name|HAL_TXERR_FIFO
expr_stmt|;
if|if
condition|(
name|ds_txstatus
index|[
literal|9
index|]
operator|&
name|AR_TxOpExceeded
condition|)
name|ts
operator|->
name|ts_status
operator||=
name|HAL_TXERR_XTXOP
expr_stmt|;
if|if
condition|(
name|ds_txstatus
index|[
literal|1
index|]
operator|&
name|AR_TxTimerExpired
condition|)
name|ts
operator|->
name|ts_status
operator||=
name|HAL_TXERR_TIMER_EXPIRED
expr_stmt|;
name|ts
operator|->
name|ts_flags
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|ds_txstatus
index|[
literal|0
index|]
operator|&
name|AR_TxBaStatus
condition|)
block|{
name|ts
operator|->
name|ts_flags
operator||=
name|HAL_TX_BA
expr_stmt|;
name|ts
operator|->
name|ts_ba_low
operator|=
name|AR_BaBitmapLow
argument_list|(
name|ds_txstatus
argument_list|)
expr_stmt|;
name|ts
operator|->
name|ts_ba_high
operator|=
name|AR_BaBitmapHigh
argument_list|(
name|ds_txstatus
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|ds
operator|->
name|ds_ctl1
operator|&
name|AR_IsAggr
condition|)
name|ts
operator|->
name|ts_flags
operator||=
name|HAL_TX_AGGR
expr_stmt|;
if|if
condition|(
name|ds_txstatus
index|[
literal|1
index|]
operator|&
name|AR_DescCfgErr
condition|)
name|ts
operator|->
name|ts_flags
operator||=
name|HAL_TX_DESC_CFG_ERR
expr_stmt|;
if|if
condition|(
name|ds_txstatus
index|[
literal|1
index|]
operator|&
name|AR_TxDataUnderrun
condition|)
name|ts
operator|->
name|ts_flags
operator||=
name|HAL_TX_DATA_UNDERRUN
expr_stmt|;
if|if
condition|(
name|ds_txstatus
index|[
literal|1
index|]
operator|&
name|AR_TxDelimUnderrun
condition|)
name|ts
operator|->
name|ts_flags
operator||=
name|HAL_TX_DELIM_UNDERRUN
expr_stmt|;
comment|/* 	 * Extract the transmit rate used and mark the rate as 	 * ``alternate'' if it wasn't the series 0 rate. 	 */
name|ts
operator|->
name|ts_finaltsi
operator|=
name|MS
argument_list|(
name|ds_txstatus
index|[
literal|9
index|]
argument_list|,
name|AR_FinalTxIdx
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|ts
operator|->
name|ts_finaltsi
condition|)
block|{
case|case
literal|0
case|:
name|ts
operator|->
name|ts_rate
operator|=
name|MS
argument_list|(
name|ads
operator|->
name|ds_ctl3
argument_list|,
name|AR_XmitRate0
argument_list|)
expr_stmt|;
break|break;
case|case
literal|1
case|:
name|ts
operator|->
name|ts_rate
operator|=
name|MS
argument_list|(
name|ads
operator|->
name|ds_ctl3
argument_list|,
name|AR_XmitRate1
argument_list|)
expr_stmt|;
break|break;
case|case
literal|2
case|:
name|ts
operator|->
name|ts_rate
operator|=
name|MS
argument_list|(
name|ads
operator|->
name|ds_ctl3
argument_list|,
name|AR_XmitRate2
argument_list|)
expr_stmt|;
break|break;
case|case
literal|3
case|:
name|ts
operator|->
name|ts_rate
operator|=
name|MS
argument_list|(
name|ads
operator|->
name|ds_ctl3
argument_list|,
name|AR_XmitRate3
argument_list|)
expr_stmt|;
break|break;
block|}
name|ts
operator|->
name|ts_rssi
operator|=
name|MS
argument_list|(
name|ds_txstatus
index|[
literal|5
index|]
argument_list|,
name|AR_TxRSSICombined
argument_list|)
expr_stmt|;
name|ts
operator|->
name|ts_rssi_ctl
index|[
literal|0
index|]
operator|=
name|MS
argument_list|(
name|ds_txstatus
index|[
literal|0
index|]
argument_list|,
name|AR_TxRSSIAnt00
argument_list|)
expr_stmt|;
name|ts
operator|->
name|ts_rssi_ctl
index|[
literal|1
index|]
operator|=
name|MS
argument_list|(
name|ds_txstatus
index|[
literal|0
index|]
argument_list|,
name|AR_TxRSSIAnt01
argument_list|)
expr_stmt|;
name|ts
operator|->
name|ts_rssi_ctl
index|[
literal|2
index|]
operator|=
name|MS
argument_list|(
name|ds_txstatus
index|[
literal|0
index|]
argument_list|,
name|AR_TxRSSIAnt02
argument_list|)
expr_stmt|;
name|ts
operator|->
name|ts_rssi_ext
index|[
literal|0
index|]
operator|=
name|MS
argument_list|(
name|ds_txstatus
index|[
literal|5
index|]
argument_list|,
name|AR_TxRSSIAnt10
argument_list|)
expr_stmt|;
name|ts
operator|->
name|ts_rssi_ext
index|[
literal|1
index|]
operator|=
name|MS
argument_list|(
name|ds_txstatus
index|[
literal|5
index|]
argument_list|,
name|AR_TxRSSIAnt11
argument_list|)
expr_stmt|;
name|ts
operator|->
name|ts_rssi_ext
index|[
literal|2
index|]
operator|=
name|MS
argument_list|(
name|ds_txstatus
index|[
literal|5
index|]
argument_list|,
name|AR_TxRSSIAnt12
argument_list|)
expr_stmt|;
name|ts
operator|->
name|ts_evm0
operator|=
name|AR_TxEVM0
argument_list|(
name|ds_txstatus
argument_list|)
expr_stmt|;
name|ts
operator|->
name|ts_evm1
operator|=
name|AR_TxEVM1
argument_list|(
name|ds_txstatus
argument_list|)
expr_stmt|;
name|ts
operator|->
name|ts_evm2
operator|=
name|AR_TxEVM2
argument_list|(
name|ds_txstatus
argument_list|)
expr_stmt|;
name|ts
operator|->
name|ts_shortretry
operator|=
name|MS
argument_list|(
name|ds_txstatus
index|[
literal|1
index|]
argument_list|,
name|AR_RTSFailCnt
argument_list|)
expr_stmt|;
name|ts
operator|->
name|ts_longretry
operator|=
name|MS
argument_list|(
name|ds_txstatus
index|[
literal|1
index|]
argument_list|,
name|AR_DataFailCnt
argument_list|)
expr_stmt|;
comment|/* 	 * The retry count has the number of un-acked tries for the 	 * final series used.  When doing multi-rate retry we must 	 * fixup the retry count by adding in the try counts for 	 * each series that was fully-processed.  Beware that this 	 * takes values from the try counts in the final descriptor. 	 * These are not required by the hardware.  We assume they 	 * are placed there by the driver as otherwise we have no 	 * access and the driver can't do the calculation because it 	 * doesn't know the descriptor format. 	 */
switch|switch
condition|(
name|ts
operator|->
name|ts_finaltsi
condition|)
block|{
case|case
literal|3
case|:
name|ts
operator|->
name|ts_longretry
operator|+=
name|MS
argument_list|(
name|ads
operator|->
name|ds_ctl2
argument_list|,
name|AR_XmitDataTries2
argument_list|)
expr_stmt|;
case|case
literal|2
case|:
name|ts
operator|->
name|ts_longretry
operator|+=
name|MS
argument_list|(
name|ads
operator|->
name|ds_ctl2
argument_list|,
name|AR_XmitDataTries1
argument_list|)
expr_stmt|;
case|case
literal|1
case|:
name|ts
operator|->
name|ts_longretry
operator|+=
name|MS
argument_list|(
name|ads
operator|->
name|ds_ctl2
argument_list|,
name|AR_XmitDataTries0
argument_list|)
expr_stmt|;
block|}
comment|/* 	 * These fields are not used. Zero these to preserve compatability 	 * with existing drivers. 	 */
name|ts
operator|->
name|ts_virtcol
operator|=
name|MS
argument_list|(
name|ads
operator|->
name|ds_ctl1
argument_list|,
name|AR_VirtRetryCnt
argument_list|)
expr_stmt|;
name|ts
operator|->
name|ts_antenna
operator|=
literal|0
expr_stmt|;
comment|/* We don't switch antennas on Owl*/
comment|/* handle tx trigger level changes internally */
if|if
condition|(
operator|(
name|ts
operator|->
name|ts_status
operator|&
name|HAL_TXERR_FIFO
operator|)
operator|||
operator|(
name|ts
operator|->
name|ts_flags
operator|&
operator|(
name|HAL_TX_DATA_UNDERRUN
operator||
name|HAL_TX_DELIM_UNDERRUN
operator|)
operator|)
condition|)
name|ar5212UpdateTxTrigLevel
argument_list|(
name|ah
argument_list|,
name|AH_TRUE
argument_list|)
expr_stmt|;
return|return
name|HAL_OK
return|;
block|}
end_function

begin_function
name|HAL_BOOL
name|ar5416SetGlobalTxTimeout
parameter_list|(
name|struct
name|ath_hal
modifier|*
name|ah
parameter_list|,
name|u_int
name|tu
parameter_list|)
block|{
name|struct
name|ath_hal_5416
modifier|*
name|ahp
init|=
name|AH5416
argument_list|(
name|ah
argument_list|)
decl_stmt|;
if|if
condition|(
name|tu
operator|>
literal|0xFFFF
condition|)
block|{
name|HALDEBUG
argument_list|(
name|ah
argument_list|,
name|HAL_DEBUG_ANY
argument_list|,
literal|"%s: bad global tx timeout %u\n"
argument_list|,
name|__func__
argument_list|,
name|tu
argument_list|)
expr_stmt|;
comment|/* restore default handling */
name|ahp
operator|->
name|ah_globaltxtimeout
operator|=
operator|(
name|u_int
operator|)
operator|-
literal|1
expr_stmt|;
return|return
name|AH_FALSE
return|;
block|}
name|OS_REG_RMW_FIELD
argument_list|(
name|ah
argument_list|,
name|AR_GTXTO
argument_list|,
name|AR_GTXTO_TIMEOUT_LIMIT
argument_list|,
name|tu
argument_list|)
expr_stmt|;
name|ahp
operator|->
name|ah_globaltxtimeout
operator|=
name|tu
expr_stmt|;
return|return
name|AH_TRUE
return|;
block|}
end_function

begin_function
name|u_int
name|ar5416GetGlobalTxTimeout
parameter_list|(
name|struct
name|ath_hal
modifier|*
name|ah
parameter_list|)
block|{
return|return
name|MS
argument_list|(
name|OS_REG_READ
argument_list|(
name|ah
argument_list|,
name|AR_GTXTO
argument_list|)
argument_list|,
name|AR_GTXTO_TIMEOUT_LIMIT
argument_list|)
return|;
block|}
end_function

begin_function
name|void
name|ar5416Set11nRateScenario
parameter_list|(
name|struct
name|ath_hal
modifier|*
name|ah
parameter_list|,
name|struct
name|ath_desc
modifier|*
name|ds
parameter_list|,
name|u_int
name|durUpdateEn
parameter_list|,
name|u_int
name|rtsctsRate
parameter_list|,
name|HAL_11N_RATE_SERIES
name|series
index|[]
parameter_list|,
name|u_int
name|nseries
parameter_list|,
name|u_int
name|flags
parameter_list|)
block|{
name|struct
name|ar5416_desc
modifier|*
name|ads
init|=
name|AR5416DESC
argument_list|(
name|ds
argument_list|)
decl_stmt|;
name|uint32_t
name|ds_ctl0
decl_stmt|;
name|HALASSERT
argument_list|(
name|nseries
operator|==
literal|4
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|nseries
expr_stmt|;
comment|/* 	 * Only one of RTS and CTS enable must be set. 	 * If a frame has both set, just do RTS protection - 	 * that's enough to satisfy legacy protection. 	 */
if|if
condition|(
name|flags
operator|&
operator|(
name|HAL_TXDESC_RTSENA
operator||
name|HAL_TXDESC_CTSENA
operator|)
condition|)
block|{
name|ds_ctl0
operator|=
name|ads
operator|->
name|ds_ctl0
expr_stmt|;
if|if
condition|(
name|flags
operator|&
name|HAL_TXDESC_RTSENA
condition|)
block|{
name|ds_ctl0
operator|&=
operator|~
name|AR_CTSEnable
expr_stmt|;
name|ds_ctl0
operator||=
name|AR_RTSEnable
expr_stmt|;
block|}
else|else
block|{
name|ds_ctl0
operator|&=
operator|~
name|AR_RTSEnable
expr_stmt|;
name|ds_ctl0
operator||=
name|AR_CTSEnable
expr_stmt|;
block|}
name|ads
operator|->
name|ds_ctl0
operator|=
name|ds_ctl0
expr_stmt|;
block|}
else|else
block|{
name|ads
operator|->
name|ds_ctl0
operator|=
operator|(
name|ads
operator|->
name|ds_ctl0
operator|&
operator|~
operator|(
name|AR_RTSEnable
operator||
name|AR_CTSEnable
operator|)
operator|)
expr_stmt|;
block|}
name|ads
operator|->
name|ds_ctl2
operator|=
name|set11nTries
argument_list|(
name|series
argument_list|,
literal|0
argument_list|)
operator||
name|set11nTries
argument_list|(
name|series
argument_list|,
literal|1
argument_list|)
operator||
name|set11nTries
argument_list|(
name|series
argument_list|,
literal|2
argument_list|)
operator||
name|set11nTries
argument_list|(
name|series
argument_list|,
literal|3
argument_list|)
operator||
operator|(
name|durUpdateEn
condition|?
name|AR_DurUpdateEn
else|:
literal|0
operator|)
expr_stmt|;
name|ads
operator|->
name|ds_ctl3
operator|=
name|set11nRate
argument_list|(
name|series
argument_list|,
literal|0
argument_list|)
operator||
name|set11nRate
argument_list|(
name|series
argument_list|,
literal|1
argument_list|)
operator||
name|set11nRate
argument_list|(
name|series
argument_list|,
literal|2
argument_list|)
operator||
name|set11nRate
argument_list|(
name|series
argument_list|,
literal|3
argument_list|)
expr_stmt|;
name|ads
operator|->
name|ds_ctl4
operator|=
name|set11nPktDurRTSCTS
argument_list|(
name|series
argument_list|,
literal|0
argument_list|)
operator||
name|set11nPktDurRTSCTS
argument_list|(
name|series
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|ads
operator|->
name|ds_ctl5
operator|=
name|set11nPktDurRTSCTS
argument_list|(
name|series
argument_list|,
literal|2
argument_list|)
operator||
name|set11nPktDurRTSCTS
argument_list|(
name|series
argument_list|,
literal|3
argument_list|)
expr_stmt|;
name|ads
operator|->
name|ds_ctl7
operator|=
name|set11nRateFlags
argument_list|(
name|series
argument_list|,
literal|0
argument_list|)
operator||
name|set11nRateFlags
argument_list|(
name|series
argument_list|,
literal|1
argument_list|)
operator||
name|set11nRateFlags
argument_list|(
name|series
argument_list|,
literal|2
argument_list|)
operator||
name|set11nRateFlags
argument_list|(
name|series
argument_list|,
literal|3
argument_list|)
operator||
name|SM
argument_list|(
name|rtsctsRate
argument_list|,
name|AR_RTSCTSRate
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|ar5416Set11nAggrMiddle
parameter_list|(
name|struct
name|ath_hal
modifier|*
name|ah
parameter_list|,
name|struct
name|ath_desc
modifier|*
name|ds
parameter_list|,
name|u_int
name|numDelims
parameter_list|)
block|{
name|struct
name|ar5416_desc
modifier|*
name|ads
init|=
name|AR5416DESC
argument_list|(
name|ds
argument_list|)
decl_stmt|;
name|uint32_t
modifier|*
name|ds_txstatus
init|=
name|AR5416_DS_TXSTATUS
argument_list|(
name|ah
argument_list|,
name|ads
argument_list|)
decl_stmt|;
name|ads
operator|->
name|ds_ctl1
operator||=
operator|(
name|AR_IsAggr
operator||
name|AR_MoreAggr
operator|)
expr_stmt|;
name|ads
operator|->
name|ds_ctl6
operator|&=
operator|~
name|AR_PadDelim
expr_stmt|;
name|ads
operator|->
name|ds_ctl6
operator||=
name|SM
argument_list|(
name|numDelims
argument_list|,
name|AR_PadDelim
argument_list|)
expr_stmt|;
name|ads
operator|->
name|ds_ctl6
operator|&=
operator|~
name|AR_AggrLen
expr_stmt|;
comment|/* 	 * Clear the TxDone status here, may need to change 	 * func name to reflect this 	 */
name|ds_txstatus
index|[
literal|9
index|]
operator|&=
operator|~
name|AR_TxDone
expr_stmt|;
block|}
end_function

begin_function
name|void
name|ar5416Clr11nAggr
parameter_list|(
name|struct
name|ath_hal
modifier|*
name|ah
parameter_list|,
name|struct
name|ath_desc
modifier|*
name|ds
parameter_list|)
block|{
name|struct
name|ar5416_desc
modifier|*
name|ads
init|=
name|AR5416DESC
argument_list|(
name|ds
argument_list|)
decl_stmt|;
name|ads
operator|->
name|ds_ctl1
operator|&=
operator|(
operator|~
name|AR_IsAggr
operator|&
operator|~
name|AR_MoreAggr
operator|)
expr_stmt|;
name|ads
operator|->
name|ds_ctl6
operator|&=
operator|~
name|AR_PadDelim
expr_stmt|;
name|ads
operator|->
name|ds_ctl6
operator|&=
operator|~
name|AR_AggrLen
expr_stmt|;
block|}
end_function

begin_function
name|void
name|ar5416Set11nBurstDuration
parameter_list|(
name|struct
name|ath_hal
modifier|*
name|ah
parameter_list|,
name|struct
name|ath_desc
modifier|*
name|ds
parameter_list|,
name|u_int
name|burstDuration
parameter_list|)
block|{
name|struct
name|ar5416_desc
modifier|*
name|ads
init|=
name|AR5416DESC
argument_list|(
name|ds
argument_list|)
decl_stmt|;
name|ads
operator|->
name|ds_ctl2
operator|&=
operator|~
name|AR_BurstDur
expr_stmt|;
name|ads
operator|->
name|ds_ctl2
operator||=
name|SM
argument_list|(
name|burstDuration
argument_list|,
name|AR_BurstDur
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * Retrieve the rate table from the given TX completion descriptor  */
end_comment

begin_function
name|HAL_BOOL
name|ar5416GetTxCompletionRates
parameter_list|(
name|struct
name|ath_hal
modifier|*
name|ah
parameter_list|,
specifier|const
name|struct
name|ath_desc
modifier|*
name|ds0
parameter_list|,
name|int
modifier|*
name|rates
parameter_list|,
name|int
modifier|*
name|tries
parameter_list|)
block|{
specifier|const
name|struct
name|ar5416_desc
modifier|*
name|ads
init|=
name|AR5416DESC_CONST
argument_list|(
name|ds0
argument_list|)
decl_stmt|;
name|rates
index|[
literal|0
index|]
operator|=
name|MS
argument_list|(
name|ads
operator|->
name|ds_ctl3
argument_list|,
name|AR_XmitRate0
argument_list|)
expr_stmt|;
name|rates
index|[
literal|1
index|]
operator|=
name|MS
argument_list|(
name|ads
operator|->
name|ds_ctl3
argument_list|,
name|AR_XmitRate1
argument_list|)
expr_stmt|;
name|rates
index|[
literal|2
index|]
operator|=
name|MS
argument_list|(
name|ads
operator|->
name|ds_ctl3
argument_list|,
name|AR_XmitRate2
argument_list|)
expr_stmt|;
name|rates
index|[
literal|3
index|]
operator|=
name|MS
argument_list|(
name|ads
operator|->
name|ds_ctl3
argument_list|,
name|AR_XmitRate3
argument_list|)
expr_stmt|;
name|tries
index|[
literal|0
index|]
operator|=
name|MS
argument_list|(
name|ads
operator|->
name|ds_ctl2
argument_list|,
name|AR_XmitDataTries0
argument_list|)
expr_stmt|;
name|tries
index|[
literal|1
index|]
operator|=
name|MS
argument_list|(
name|ads
operator|->
name|ds_ctl2
argument_list|,
name|AR_XmitDataTries1
argument_list|)
expr_stmt|;
name|tries
index|[
literal|2
index|]
operator|=
name|MS
argument_list|(
name|ads
operator|->
name|ds_ctl2
argument_list|,
name|AR_XmitDataTries2
argument_list|)
expr_stmt|;
name|tries
index|[
literal|3
index|]
operator|=
name|MS
argument_list|(
name|ads
operator|->
name|ds_ctl2
argument_list|,
name|AR_XmitDataTries3
argument_list|)
expr_stmt|;
return|return
name|AH_TRUE
return|;
block|}
end_function

end_unit


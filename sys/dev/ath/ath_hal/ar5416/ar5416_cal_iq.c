begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Copyright (c) 2002-2008 Sam Leffler, Errno Consulting  * Copyright (c) 2002-2008 Atheros Communications, Inc.  *  * Permission to use, copy, modify, and/or distribute this software for any  * purpose with or without fee is hereby granted, provided that the above  * copyright notice and this permission notice appear in all copies.  *  * THE SOFTWARE IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL WARRANTIES  * WITH REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF  * MERCHANTABILITY AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR  * ANY SPECIAL, DIRECT, INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES  * WHATSOEVER RESULTING FROM LOSS OF USE, DATA OR PROFITS, WHETHER IN AN  * ACTION OF CONTRACT, NEGLIGENCE OR OTHER TORTIOUS ACTION, ARISING OUT OF  * OR IN CONNECTION WITH THE USE OR PERFORMANCE OF THIS SOFTWARE.  *  * $FreeBSD$  */
end_comment

begin_include
include|#
directive|include
file|"opt_ah.h"
end_include

begin_include
include|#
directive|include
file|"ah.h"
end_include

begin_include
include|#
directive|include
file|"ah_internal.h"
end_include

begin_include
include|#
directive|include
file|"ah_devid.h"
end_include

begin_include
include|#
directive|include
file|"ar5416/ar5416.h"
end_include

begin_include
include|#
directive|include
file|"ar5416/ar5416reg.h"
end_include

begin_include
include|#
directive|include
file|"ar5416/ar5416phy.h"
end_include

begin_comment
comment|/* IQ Cal aliases */
end_comment

begin_define
define|#
directive|define
name|totalPowerMeasI
parameter_list|(
name|i
parameter_list|)
value|caldata[0][i].u
end_define

begin_define
define|#
directive|define
name|totalPowerMeasQ
parameter_list|(
name|i
parameter_list|)
value|caldata[1][i].u
end_define

begin_define
define|#
directive|define
name|totalIqCorrMeas
parameter_list|(
name|i
parameter_list|)
value|caldata[2][i].s
end_define

begin_comment
comment|/*  * Collect data from HW to later perform IQ Mismatch Calibration  */
end_comment

begin_function
name|void
name|ar5416IQCalCollect
parameter_list|(
name|struct
name|ath_hal
modifier|*
name|ah
parameter_list|)
block|{
name|struct
name|ar5416PerCal
modifier|*
name|cal
init|=
operator|&
name|AH5416
argument_list|(
name|ah
argument_list|)
operator|->
name|ah_cal
decl_stmt|;
name|int
name|i
decl_stmt|;
comment|/*  	 * Accumulate IQ cal measures for active chains 	 */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|AR5416_MAX_CHAINS
condition|;
name|i
operator|++
control|)
block|{
name|cal
operator|->
name|totalPowerMeasI
argument_list|(
name|i
argument_list|)
operator|+=
name|OS_REG_READ
argument_list|(
name|ah
argument_list|,
name|AR_PHY_CAL_MEAS_0
argument_list|(
name|i
argument_list|)
argument_list|)
expr_stmt|;
name|cal
operator|->
name|totalPowerMeasQ
argument_list|(
name|i
argument_list|)
operator|+=
name|OS_REG_READ
argument_list|(
name|ah
argument_list|,
name|AR_PHY_CAL_MEAS_1
argument_list|(
name|i
argument_list|)
argument_list|)
expr_stmt|;
name|cal
operator|->
name|totalIqCorrMeas
argument_list|(
name|i
argument_list|)
operator|+=
operator|(
name|int32_t
operator|)
name|OS_REG_READ
argument_list|(
name|ah
argument_list|,
name|AR_PHY_CAL_MEAS_2
argument_list|(
name|i
argument_list|)
argument_list|)
expr_stmt|;
name|HALDEBUG
argument_list|(
name|ah
argument_list|,
name|HAL_DEBUG_PERCAL
argument_list|,
literal|"%d: Chn %d pmi=0x%08x;pmq=0x%08x;iqcm=0x%08x;\n"
argument_list|,
name|cal
operator|->
name|calSamples
argument_list|,
name|i
argument_list|,
name|cal
operator|->
name|totalPowerMeasI
argument_list|(
name|i
argument_list|)
argument_list|,
name|cal
operator|->
name|totalPowerMeasQ
argument_list|(
name|i
argument_list|)
argument_list|,
name|cal
operator|->
name|totalIqCorrMeas
argument_list|(
name|i
argument_list|)
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/*  * Use HW data to do IQ Mismatch Calibration  */
end_comment

begin_function
name|void
name|ar5416IQCalibration
parameter_list|(
name|struct
name|ath_hal
modifier|*
name|ah
parameter_list|,
name|uint8_t
name|numChains
parameter_list|)
block|{
name|struct
name|ar5416PerCal
modifier|*
name|cal
init|=
operator|&
name|AH5416
argument_list|(
name|ah
argument_list|)
operator|->
name|ah_cal
decl_stmt|;
name|int
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|numChains
condition|;
name|i
operator|++
control|)
block|{
name|uint32_t
name|powerMeasI
init|=
name|cal
operator|->
name|totalPowerMeasI
argument_list|(
name|i
argument_list|)
decl_stmt|;
name|uint32_t
name|powerMeasQ
init|=
name|cal
operator|->
name|totalPowerMeasQ
argument_list|(
name|i
argument_list|)
decl_stmt|;
name|uint32_t
name|iqCorrMeas
init|=
name|cal
operator|->
name|totalIqCorrMeas
argument_list|(
name|i
argument_list|)
decl_stmt|;
name|uint32_t
name|qCoffDenom
decl_stmt|,
name|iCoffDenom
decl_stmt|;
name|int
name|iqCorrNeg
decl_stmt|;
name|HALDEBUG
argument_list|(
name|ah
argument_list|,
name|HAL_DEBUG_PERCAL
argument_list|,
literal|"Start IQ Cal and Correction for Chain %d\n"
argument_list|,
name|i
argument_list|)
expr_stmt|;
name|HALDEBUG
argument_list|(
name|ah
argument_list|,
name|HAL_DEBUG_PERCAL
argument_list|,
literal|"Orignal: iq_corr_meas = 0x%08x\n"
argument_list|,
name|iqCorrMeas
argument_list|)
expr_stmt|;
name|iqCorrNeg
operator|=
literal|0
expr_stmt|;
comment|/* iqCorrMeas is always negative. */
if|if
condition|(
name|iqCorrMeas
operator|>
literal|0x80000000
condition|)
block|{
name|iqCorrMeas
operator|=
operator|(
literal|0xffffffff
operator|-
name|iqCorrMeas
operator|)
operator|+
literal|1
expr_stmt|;
name|iqCorrNeg
operator|=
literal|1
expr_stmt|;
block|}
name|HALDEBUG
argument_list|(
name|ah
argument_list|,
name|HAL_DEBUG_PERCAL
argument_list|,
literal|" pwr_meas_i = 0x%08x\n"
argument_list|,
name|powerMeasI
argument_list|)
expr_stmt|;
name|HALDEBUG
argument_list|(
name|ah
argument_list|,
name|HAL_DEBUG_PERCAL
argument_list|,
literal|" pwr_meas_q = 0x%08x\n"
argument_list|,
name|powerMeasQ
argument_list|)
expr_stmt|;
name|HALDEBUG
argument_list|(
name|ah
argument_list|,
name|HAL_DEBUG_PERCAL
argument_list|,
literal|" iqCorrNeg is 0x%08x\n"
argument_list|,
name|iqCorrNeg
argument_list|)
expr_stmt|;
name|iCoffDenom
operator|=
operator|(
name|powerMeasI
operator|/
literal|2
operator|+
name|powerMeasQ
operator|/
literal|2
operator|)
operator|/
literal|128
expr_stmt|;
name|qCoffDenom
operator|=
name|powerMeasQ
operator|/
literal|64
expr_stmt|;
comment|/* Protect against divide-by-0 */
if|if
condition|(
name|powerMeasQ
operator|!=
literal|0
condition|)
block|{
comment|/* IQ corr_meas is already negated if iqcorr_neg == 1 */
name|int32_t
name|iCoff
init|=
name|iqCorrMeas
operator|/
name|iCoffDenom
decl_stmt|;
name|int32_t
name|qCoff
init|=
name|powerMeasI
operator|/
name|qCoffDenom
operator|-
literal|64
decl_stmt|;
name|HALDEBUG
argument_list|(
name|ah
argument_list|,
name|HAL_DEBUG_PERCAL
argument_list|,
literal|" iCoff = 0x%08x\n"
argument_list|,
name|iCoff
argument_list|)
expr_stmt|;
name|HALDEBUG
argument_list|(
name|ah
argument_list|,
name|HAL_DEBUG_PERCAL
argument_list|,
literal|" qCoff = 0x%08x\n"
argument_list|,
name|qCoff
argument_list|)
expr_stmt|;
comment|/* Negate iCoff if iqCorrNeg == 0 */
name|iCoff
operator|=
name|iCoff
operator|&
literal|0x3f
expr_stmt|;
name|HALDEBUG
argument_list|(
name|ah
argument_list|,
name|HAL_DEBUG_PERCAL
argument_list|,
literal|"New:  iCoff = 0x%08x\n"
argument_list|,
name|iCoff
argument_list|)
expr_stmt|;
if|if
condition|(
name|iqCorrNeg
operator|==
literal|0x0
condition|)
name|iCoff
operator|=
literal|0x40
operator|-
name|iCoff
expr_stmt|;
if|if
condition|(
name|qCoff
operator|>
literal|15
condition|)
name|qCoff
operator|=
literal|15
expr_stmt|;
elseif|else
if|if
condition|(
name|qCoff
operator|<=
operator|-
literal|16
condition|)
name|qCoff
operator|=
literal|16
expr_stmt|;
name|HALDEBUG
argument_list|(
name|ah
argument_list|,
name|HAL_DEBUG_PERCAL
argument_list|,
literal|" : iCoff = 0x%x  qCoff = 0x%x\n"
argument_list|,
name|iCoff
argument_list|,
name|qCoff
argument_list|)
expr_stmt|;
name|OS_REG_RMW_FIELD
argument_list|(
name|ah
argument_list|,
name|AR_PHY_TIMING_CTRL4_CHAIN
argument_list|(
name|i
argument_list|)
argument_list|,
name|AR_PHY_TIMING_CTRL4_IQCORR_Q_I_COFF
argument_list|,
name|iCoff
argument_list|)
expr_stmt|;
name|OS_REG_RMW_FIELD
argument_list|(
name|ah
argument_list|,
name|AR_PHY_TIMING_CTRL4_CHAIN
argument_list|(
name|i
argument_list|)
argument_list|,
name|AR_PHY_TIMING_CTRL4_IQCORR_Q_Q_COFF
argument_list|,
name|qCoff
argument_list|)
expr_stmt|;
name|HALDEBUG
argument_list|(
name|ah
argument_list|,
name|HAL_DEBUG_PERCAL
argument_list|,
literal|"IQ Cal and Correction done for Chain %d\n"
argument_list|,
name|i
argument_list|)
expr_stmt|;
block|}
block|}
name|OS_REG_SET_BIT
argument_list|(
name|ah
argument_list|,
name|AR_PHY_TIMING_CTRL4
argument_list|,
name|AR_PHY_TIMING_CTRL4_IQCORR_ENABLE
argument_list|)
expr_stmt|;
block|}
end_function

end_unit


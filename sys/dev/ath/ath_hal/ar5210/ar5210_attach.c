begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Copyright (c) 2002-2009 Sam Leffler, Errno Consulting  * Copyright (c) 2002-2004 Atheros Communications, Inc.  *  * Permission to use, copy, modify, and/or distribute this software for any  * purpose with or without fee is hereby granted, provided that the above  * copyright notice and this permission notice appear in all copies.  *  * THE SOFTWARE IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL WARRANTIES  * WITH REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF  * MERCHANTABILITY AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR  * ANY SPECIAL, DIRECT, INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES  * WHATSOEVER RESULTING FROM LOSS OF USE, DATA OR PROFITS, WHETHER IN AN  * ACTION OF CONTRACT, NEGLIGENCE OR OTHER TORTIOUS ACTION, ARISING OUT OF  * OR IN CONNECTION WITH THE USE OR PERFORMANCE OF THIS SOFTWARE.  *  * $FreeBSD$  */
end_comment

begin_include
include|#
directive|include
file|"opt_ah.h"
end_include

begin_include
include|#
directive|include
file|"ah.h"
end_include

begin_include
include|#
directive|include
file|"ah_internal.h"
end_include

begin_include
include|#
directive|include
file|"ah_devid.h"
end_include

begin_include
include|#
directive|include
file|"ar5210/ar5210.h"
end_include

begin_include
include|#
directive|include
file|"ar5210/ar5210reg.h"
end_include

begin_include
include|#
directive|include
file|"ar5210/ar5210phy.h"
end_include

begin_include
include|#
directive|include
file|"ah_eeprom_v1.h"
end_include

begin_function_decl
specifier|static
name|HAL_BOOL
name|ar5210GetChannelEdges
parameter_list|(
name|struct
name|ath_hal
modifier|*
parameter_list|,
name|uint16_t
name|flags
parameter_list|,
name|uint16_t
modifier|*
name|low
parameter_list|,
name|uint16_t
modifier|*
name|high
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|HAL_BOOL
name|ar5210GetChipPowerLimits
parameter_list|(
name|struct
name|ath_hal
modifier|*
name|ah
parameter_list|,
name|struct
name|ieee80211_channel
modifier|*
name|chan
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|ar5210ConfigPCIE
parameter_list|(
name|struct
name|ath_hal
modifier|*
name|ah
parameter_list|,
name|HAL_BOOL
name|restore
parameter_list|,
name|HAL_BOOL
name|power_on
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|ar5210DisablePCIE
parameter_list|(
name|struct
name|ath_hal
modifier|*
name|ah
parameter_list|)
function_decl|;
end_function_decl

begin_decl_stmt
specifier|static
specifier|const
name|struct
name|ath_hal_private
name|ar5210hal
init|=
block|{
block|{
operator|.
name|ah_magic
operator|=
name|AR5210_MAGIC
block|,
operator|.
name|ah_getRateTable
operator|=
name|ar5210GetRateTable
block|,
operator|.
name|ah_detach
operator|=
name|ar5210Detach
block|,
comment|/* Reset Functions */
operator|.
name|ah_reset
operator|=
name|ar5210Reset
block|,
operator|.
name|ah_phyDisable
operator|=
name|ar5210PhyDisable
block|,
operator|.
name|ah_disable
operator|=
name|ar5210Disable
block|,
operator|.
name|ah_configPCIE
operator|=
name|ar5210ConfigPCIE
block|,
operator|.
name|ah_disablePCIE
operator|=
name|ar5210DisablePCIE
block|,
operator|.
name|ah_setPCUConfig
operator|=
name|ar5210SetPCUConfig
block|,
operator|.
name|ah_perCalibration
operator|=
name|ar5210PerCalibration
block|,
operator|.
name|ah_perCalibrationN
operator|=
name|ar5210PerCalibrationN
block|,
operator|.
name|ah_resetCalValid
operator|=
name|ar5210ResetCalValid
block|,
operator|.
name|ah_setTxPowerLimit
operator|=
name|ar5210SetTxPowerLimit
block|,
operator|.
name|ah_getChanNoise
operator|=
name|ath_hal_getChanNoise
block|,
comment|/* Transmit functions */
operator|.
name|ah_updateTxTrigLevel
operator|=
name|ar5210UpdateTxTrigLevel
block|,
operator|.
name|ah_setupTxQueue
operator|=
name|ar5210SetupTxQueue
block|,
operator|.
name|ah_setTxQueueProps
operator|=
name|ar5210SetTxQueueProps
block|,
operator|.
name|ah_getTxQueueProps
operator|=
name|ar5210GetTxQueueProps
block|,
operator|.
name|ah_releaseTxQueue
operator|=
name|ar5210ReleaseTxQueue
block|,
operator|.
name|ah_resetTxQueue
operator|=
name|ar5210ResetTxQueue
block|,
operator|.
name|ah_getTxDP
operator|=
name|ar5210GetTxDP
block|,
operator|.
name|ah_setTxDP
operator|=
name|ar5210SetTxDP
block|,
operator|.
name|ah_numTxPending
operator|=
name|ar5210NumTxPending
block|,
operator|.
name|ah_startTxDma
operator|=
name|ar5210StartTxDma
block|,
operator|.
name|ah_stopTxDma
operator|=
name|ar5210StopTxDma
block|,
operator|.
name|ah_setupTxDesc
operator|=
name|ar5210SetupTxDesc
block|,
operator|.
name|ah_setupXTxDesc
operator|=
name|ar5210SetupXTxDesc
block|,
operator|.
name|ah_fillTxDesc
operator|=
name|ar5210FillTxDesc
block|,
operator|.
name|ah_procTxDesc
operator|=
name|ar5210ProcTxDesc
block|,
operator|.
name|ah_getTxIntrQueue
operator|=
name|ar5210GetTxIntrQueue
block|,
operator|.
name|ah_reqTxIntrDesc
operator|=
name|ar5210IntrReqTxDesc
block|,
operator|.
name|ah_getTxCompletionRates
operator|=
name|ar5210GetTxCompletionRates
block|,
operator|.
name|ah_setTxDescLink
operator|=
name|ar5210SetTxDescLink
block|,
operator|.
name|ah_getTxDescLink
operator|=
name|ar5210GetTxDescLink
block|,
operator|.
name|ah_getTxDescLinkPtr
operator|=
name|ar5210GetTxDescLinkPtr
block|,
comment|/* RX Functions */
operator|.
name|ah_getRxDP
operator|=
name|ar5210GetRxDP
block|,
operator|.
name|ah_setRxDP
operator|=
name|ar5210SetRxDP
block|,
operator|.
name|ah_enableReceive
operator|=
name|ar5210EnableReceive
block|,
operator|.
name|ah_stopDmaReceive
operator|=
name|ar5210StopDmaReceive
block|,
operator|.
name|ah_startPcuReceive
operator|=
name|ar5210StartPcuReceive
block|,
operator|.
name|ah_stopPcuReceive
operator|=
name|ar5210StopPcuReceive
block|,
operator|.
name|ah_setMulticastFilter
operator|=
name|ar5210SetMulticastFilter
block|,
operator|.
name|ah_setMulticastFilterIndex
operator|=
name|ar5210SetMulticastFilterIndex
block|,
operator|.
name|ah_clrMulticastFilterIndex
operator|=
name|ar5210ClrMulticastFilterIndex
block|,
operator|.
name|ah_getRxFilter
operator|=
name|ar5210GetRxFilter
block|,
operator|.
name|ah_setRxFilter
operator|=
name|ar5210SetRxFilter
block|,
operator|.
name|ah_setupRxDesc
operator|=
name|ar5210SetupRxDesc
block|,
operator|.
name|ah_procRxDesc
operator|=
name|ar5210ProcRxDesc
block|,
operator|.
name|ah_rxMonitor
operator|=
name|ar5210RxMonitor
block|,
operator|.
name|ah_aniPoll
operator|=
name|ar5210AniPoll
block|,
operator|.
name|ah_procMibEvent
operator|=
name|ar5210MibEvent
block|,
comment|/* Misc Functions */
operator|.
name|ah_getCapability
operator|=
name|ar5210GetCapability
block|,
operator|.
name|ah_setCapability
operator|=
name|ar5210SetCapability
block|,
operator|.
name|ah_getDiagState
operator|=
name|ar5210GetDiagState
block|,
operator|.
name|ah_getMacAddress
operator|=
name|ar5210GetMacAddress
block|,
operator|.
name|ah_setMacAddress
operator|=
name|ar5210SetMacAddress
block|,
operator|.
name|ah_getBssIdMask
operator|=
name|ar5210GetBssIdMask
block|,
operator|.
name|ah_setBssIdMask
operator|=
name|ar5210SetBssIdMask
block|,
operator|.
name|ah_setRegulatoryDomain
operator|=
name|ar5210SetRegulatoryDomain
block|,
operator|.
name|ah_setLedState
operator|=
name|ar5210SetLedState
block|,
operator|.
name|ah_writeAssocid
operator|=
name|ar5210WriteAssocid
block|,
operator|.
name|ah_gpioCfgInput
operator|=
name|ar5210GpioCfgInput
block|,
operator|.
name|ah_gpioCfgOutput
operator|=
name|ar5210GpioCfgOutput
block|,
operator|.
name|ah_gpioGet
operator|=
name|ar5210GpioGet
block|,
operator|.
name|ah_gpioSet
operator|=
name|ar5210GpioSet
block|,
operator|.
name|ah_gpioSetIntr
operator|=
name|ar5210Gpio0SetIntr
block|,
operator|.
name|ah_getTsf32
operator|=
name|ar5210GetTsf32
block|,
operator|.
name|ah_getTsf64
operator|=
name|ar5210GetTsf64
block|,
operator|.
name|ah_resetTsf
operator|=
name|ar5210ResetTsf
block|,
operator|.
name|ah_detectCardPresent
operator|=
name|ar5210DetectCardPresent
block|,
operator|.
name|ah_updateMibCounters
operator|=
name|ar5210UpdateMibCounters
block|,
operator|.
name|ah_getRfGain
operator|=
name|ar5210GetRfgain
block|,
operator|.
name|ah_getDefAntenna
operator|=
name|ar5210GetDefAntenna
block|,
operator|.
name|ah_setDefAntenna
operator|=
name|ar5210SetDefAntenna
block|,
operator|.
name|ah_getAntennaSwitch
operator|=
name|ar5210GetAntennaSwitch
block|,
operator|.
name|ah_setAntennaSwitch
operator|=
name|ar5210SetAntennaSwitch
block|,
operator|.
name|ah_setSifsTime
operator|=
name|ar5210SetSifsTime
block|,
operator|.
name|ah_getSifsTime
operator|=
name|ar5210GetSifsTime
block|,
operator|.
name|ah_setSlotTime
operator|=
name|ar5210SetSlotTime
block|,
operator|.
name|ah_getSlotTime
operator|=
name|ar5210GetSlotTime
block|,
operator|.
name|ah_setAckTimeout
operator|=
name|ar5210SetAckTimeout
block|,
operator|.
name|ah_getAckTimeout
operator|=
name|ar5210GetAckTimeout
block|,
operator|.
name|ah_setAckCTSRate
operator|=
name|ar5210SetAckCTSRate
block|,
operator|.
name|ah_getAckCTSRate
operator|=
name|ar5210GetAckCTSRate
block|,
operator|.
name|ah_setCTSTimeout
operator|=
name|ar5210SetCTSTimeout
block|,
operator|.
name|ah_getCTSTimeout
operator|=
name|ar5210GetCTSTimeout
block|,
operator|.
name|ah_setDecompMask
operator|=
name|ar5210SetDecompMask
block|,
operator|.
name|ah_setCoverageClass
operator|=
name|ar5210SetCoverageClass
block|,
operator|.
name|ah_get11nExtBusy
operator|=
name|ar5210Get11nExtBusy
block|,
operator|.
name|ah_getMibCycleCounts
operator|=
name|ar5210GetMibCycleCounts
block|,
operator|.
name|ah_setChainMasks
operator|=
name|ar5210SetChainMasks
block|,
operator|.
name|ah_enableDfs
operator|=
name|ar5210EnableDfs
block|,
operator|.
name|ah_getDfsThresh
operator|=
name|ar5210GetDfsThresh
block|,
comment|/* XXX procRadarEvent */
comment|/* XXX isFastClockEnabled */
comment|/* Key Cache Functions */
operator|.
name|ah_getKeyCacheSize
operator|=
name|ar5210GetKeyCacheSize
block|,
operator|.
name|ah_resetKeyCacheEntry
operator|=
name|ar5210ResetKeyCacheEntry
block|,
operator|.
name|ah_isKeyCacheEntryValid
operator|=
name|ar5210IsKeyCacheEntryValid
block|,
operator|.
name|ah_setKeyCacheEntry
operator|=
name|ar5210SetKeyCacheEntry
block|,
operator|.
name|ah_setKeyCacheEntryMac
operator|=
name|ar5210SetKeyCacheEntryMac
block|,
comment|/* Power Management Functions */
operator|.
name|ah_setPowerMode
operator|=
name|ar5210SetPowerMode
block|,
operator|.
name|ah_getPowerMode
operator|=
name|ar5210GetPowerMode
block|,
comment|/* Beacon Functions */
operator|.
name|ah_setBeaconTimers
operator|=
name|ar5210SetBeaconTimers
block|,
operator|.
name|ah_beaconInit
operator|=
name|ar5210BeaconInit
block|,
operator|.
name|ah_setStationBeaconTimers
operator|=
name|ar5210SetStaBeaconTimers
block|,
operator|.
name|ah_resetStationBeaconTimers
operator|=
name|ar5210ResetStaBeaconTimers
block|,
operator|.
name|ah_getNextTBTT
operator|=
name|ar5210GetNextTBTT
block|,
comment|/* Interrupt Functions */
operator|.
name|ah_isInterruptPending
operator|=
name|ar5210IsInterruptPending
block|,
operator|.
name|ah_getPendingInterrupts
operator|=
name|ar5210GetPendingInterrupts
block|,
operator|.
name|ah_getInterrupts
operator|=
name|ar5210GetInterrupts
block|,
operator|.
name|ah_setInterrupts
operator|=
name|ar5210SetInterrupts
block|}
block|,
operator|.
name|ah_getChannelEdges
operator|=
name|ar5210GetChannelEdges
block|,
operator|.
name|ah_getWirelessModes
operator|=
name|ar5210GetWirelessModes
block|,
operator|.
name|ah_eepromRead
operator|=
name|ar5210EepromRead
block|,
ifdef|#
directive|ifdef
name|AH_SUPPORT_WRITE_EEPROM
operator|.
name|ah_eepromWrite
operator|=
name|ar5210EepromWrite
block|,
endif|#
directive|endif
operator|.
name|ah_getChipPowerLimits
operator|=
name|ar5210GetChipPowerLimits
block|, }
decl_stmt|;
end_decl_stmt

begin_function_decl
specifier|static
name|HAL_BOOL
name|ar5210FillCapabilityInfo
parameter_list|(
name|struct
name|ath_hal
modifier|*
name|ah
parameter_list|)
function_decl|;
end_function_decl

begin_comment
comment|/*  * Attach for an AR5210 part.  */
end_comment

begin_function
specifier|static
name|struct
name|ath_hal
modifier|*
name|ar5210Attach
parameter_list|(
name|uint16_t
name|devid
parameter_list|,
name|HAL_SOFTC
name|sc
parameter_list|,
name|HAL_BUS_TAG
name|st
parameter_list|,
name|HAL_BUS_HANDLE
name|sh
parameter_list|,
name|uint16_t
modifier|*
name|eepromdata
parameter_list|,
name|HAL_OPS_CONFIG
modifier|*
name|ah_config
parameter_list|,
name|HAL_STATUS
modifier|*
name|status
parameter_list|)
block|{
define|#
directive|define
name|N
parameter_list|(
name|a
parameter_list|)
value|(sizeof(a)/sizeof(a[0]))
name|struct
name|ath_hal_5210
modifier|*
name|ahp
decl_stmt|;
name|struct
name|ath_hal
modifier|*
name|ah
decl_stmt|;
name|uint32_t
name|revid
decl_stmt|,
name|pcicfg
decl_stmt|;
name|uint16_t
name|eeval
decl_stmt|;
name|HAL_STATUS
name|ecode
decl_stmt|;
name|int
name|i
decl_stmt|;
name|HALDEBUG
argument_list|(
name|AH_NULL
argument_list|,
name|HAL_DEBUG_ATTACH
argument_list|,
literal|"%s: devid 0x%x sc %p st %p sh %p\n"
argument_list|,
name|__func__
argument_list|,
name|devid
argument_list|,
name|sc
argument_list|,
operator|(
name|void
operator|*
operator|)
name|st
argument_list|,
operator|(
name|void
operator|*
operator|)
name|sh
argument_list|)
expr_stmt|;
comment|/* NB: memory is returned zero'd */
name|ahp
operator|=
name|ath_hal_malloc
argument_list|(
sizeof|sizeof
argument_list|(
expr|struct
name|ath_hal_5210
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|ahp
operator|==
name|AH_NULL
condition|)
block|{
name|HALDEBUG
argument_list|(
name|AH_NULL
argument_list|,
name|HAL_DEBUG_ANY
argument_list|,
literal|"%s: no memory for state block\n"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
name|ecode
operator|=
name|HAL_ENOMEM
expr_stmt|;
goto|goto
name|bad
goto|;
block|}
name|ah
operator|=
operator|&
name|ahp
operator|->
name|ah_priv
operator|.
name|h
expr_stmt|;
comment|/* set initial values */
name|OS_MEMCPY
argument_list|(
operator|&
name|ahp
operator|->
name|ah_priv
argument_list|,
operator|&
name|ar5210hal
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|ath_hal_private
argument_list|)
argument_list|)
expr_stmt|;
name|ah
operator|->
name|ah_sc
operator|=
name|sc
expr_stmt|;
name|ah
operator|->
name|ah_st
operator|=
name|st
expr_stmt|;
name|ah
operator|->
name|ah_sh
operator|=
name|sh
expr_stmt|;
name|ah
operator|->
name|ah_devid
operator|=
name|devid
expr_stmt|;
comment|/* NB: for AH_DEBUG_ALQ */
name|AH_PRIVATE
argument_list|(
name|ah
argument_list|)
operator|->
name|ah_devid
operator|=
name|devid
expr_stmt|;
name|AH_PRIVATE
argument_list|(
name|ah
argument_list|)
operator|->
name|ah_subvendorid
operator|=
literal|0
expr_stmt|;
comment|/* XXX */
name|AH_PRIVATE
argument_list|(
name|ah
argument_list|)
operator|->
name|ah_powerLimit
operator|=
name|AR5210_MAX_RATE_POWER
expr_stmt|;
name|AH_PRIVATE
argument_list|(
name|ah
argument_list|)
operator|->
name|ah_tpScale
operator|=
name|HAL_TP_SCALE_MAX
expr_stmt|;
comment|/* no scaling */
name|ah
operator|->
name|ah_powerMode
operator|=
name|HAL_PM_UNDEFINED
expr_stmt|;
name|ahp
operator|->
name|ah_staId1Defaults
operator|=
literal|0
expr_stmt|;
name|ahp
operator|->
name|ah_rssiThr
operator|=
name|INIT_RSSI_THR
expr_stmt|;
name|ahp
operator|->
name|ah_sifstime
operator|=
operator|(
name|u_int
operator|)
operator|-
literal|1
expr_stmt|;
name|ahp
operator|->
name|ah_slottime
operator|=
operator|(
name|u_int
operator|)
operator|-
literal|1
expr_stmt|;
name|ahp
operator|->
name|ah_acktimeout
operator|=
operator|(
name|u_int
operator|)
operator|-
literal|1
expr_stmt|;
name|ahp
operator|->
name|ah_ctstimeout
operator|=
operator|(
name|u_int
operator|)
operator|-
literal|1
expr_stmt|;
if|if
condition|(
operator|!
name|ar5210ChipReset
argument_list|(
name|ah
argument_list|,
name|AH_NULL
argument_list|)
condition|)
block|{
comment|/* reset chip */
name|HALDEBUG
argument_list|(
name|ah
argument_list|,
name|HAL_DEBUG_ANY
argument_list|,
literal|"%s: chip reset failed\n"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
name|ecode
operator|=
name|HAL_EIO
expr_stmt|;
goto|goto
name|bad
goto|;
block|}
comment|/* Read Revisions from Chips */
name|AH_PRIVATE
argument_list|(
name|ah
argument_list|)
operator|->
name|ah_macVersion
operator|=
literal|1
expr_stmt|;
name|AH_PRIVATE
argument_list|(
name|ah
argument_list|)
operator|->
name|ah_macRev
operator|=
name|OS_REG_READ
argument_list|(
name|ah
argument_list|,
name|AR_SREV
argument_list|)
operator|&
literal|0xff
expr_stmt|;
name|AH_PRIVATE
argument_list|(
name|ah
argument_list|)
operator|->
name|ah_phyRev
operator|=
name|OS_REG_READ
argument_list|(
name|ah
argument_list|,
name|AR_PHY_CHIPID
argument_list|)
expr_stmt|;
name|AH_PRIVATE
argument_list|(
name|ah
argument_list|)
operator|->
name|ah_analog2GhzRev
operator|=
literal|0
expr_stmt|;
comment|/* Read Radio Chip Rev Extract */
name|OS_REG_WRITE
argument_list|(
name|ah
argument_list|,
operator|(
name|AR_PHY_BASE
operator|+
operator|(
literal|0x34
operator|<<
literal|2
operator|)
operator|)
argument_list|,
literal|0x00001c16
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|4
condition|;
name|i
operator|++
control|)
name|OS_REG_WRITE
argument_list|(
name|ah
argument_list|,
operator|(
name|AR_PHY_BASE
operator|+
operator|(
literal|0x20
operator|<<
literal|2
operator|)
operator|)
argument_list|,
literal|0x00010000
argument_list|)
expr_stmt|;
name|revid
operator|=
operator|(
name|OS_REG_READ
argument_list|(
name|ah
argument_list|,
name|AR_PHY_BASE
operator|+
operator|(
literal|256
operator|<<
literal|2
operator|)
argument_list|)
operator|>>
literal|28
operator|)
operator|&
literal|0xf
expr_stmt|;
comment|/* Chip labelling is 1 greater than revision register for AR5110 */
name|AH_PRIVATE
argument_list|(
name|ah
argument_list|)
operator|->
name|ah_analog5GhzRev
operator|=
name|ath_hal_reverseBits
argument_list|(
name|revid
argument_list|,
literal|4
argument_list|)
operator|+
literal|1
expr_stmt|;
comment|/* 	 * Read all the settings from the EEPROM and stash 	 * ones we'll use later. 	 */
name|pcicfg
operator|=
name|OS_REG_READ
argument_list|(
name|ah
argument_list|,
name|AR_PCICFG
argument_list|)
expr_stmt|;
name|OS_REG_WRITE
argument_list|(
name|ah
argument_list|,
name|AR_PCICFG
argument_list|,
name|pcicfg
operator||
name|AR_PCICFG_EEPROMSEL
argument_list|)
expr_stmt|;
name|ecode
operator|=
name|ath_hal_v1EepromAttach
argument_list|(
name|ah
argument_list|)
expr_stmt|;
if|if
condition|(
name|ecode
operator|!=
name|HAL_OK
condition|)
block|{
goto|goto
name|eebad
goto|;
block|}
name|ecode
operator|=
name|ath_hal_eepromGet
argument_list|(
name|ah
argument_list|,
name|AR_EEP_REGDMN_0
argument_list|,
operator|&
name|eeval
argument_list|)
expr_stmt|;
if|if
condition|(
name|ecode
operator|!=
name|HAL_OK
condition|)
block|{
name|HALDEBUG
argument_list|(
name|ah
argument_list|,
name|HAL_DEBUG_ANY
argument_list|,
literal|"%s: cannot read regulatory domain from EEPROM\n"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
goto|goto
name|eebad
goto|;
block|}
name|AH_PRIVATE
argument_list|(
name|ah
argument_list|)
operator|->
name|ah_currentRD
operator|=
name|eeval
expr_stmt|;
name|ecode
operator|=
name|ath_hal_eepromGet
argument_list|(
name|ah
argument_list|,
name|AR_EEP_MACADDR
argument_list|,
name|ahp
operator|->
name|ah_macaddr
argument_list|)
expr_stmt|;
if|if
condition|(
name|ecode
operator|!=
name|HAL_OK
condition|)
block|{
name|HALDEBUG
argument_list|(
name|ah
argument_list|,
name|HAL_DEBUG_ANY
argument_list|,
literal|"%s: error getting mac address from EEPROM\n"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
goto|goto
name|eebad
goto|;
block|}
name|OS_REG_WRITE
argument_list|(
name|ah
argument_list|,
name|AR_PCICFG
argument_list|,
name|pcicfg
argument_list|)
expr_stmt|;
comment|/* disable EEPROM access */
name|AH_PRIVATE
argument_list|(
name|ah
argument_list|)
operator|->
name|ah_getNfAdjust
operator|=
name|ar5210GetNfAdjust
expr_stmt|;
comment|/* 	 * Got everything we need now to setup the capabilities. 	 */
operator|(
name|void
operator|)
name|ar5210FillCapabilityInfo
argument_list|(
name|ah
argument_list|)
expr_stmt|;
name|HALDEBUG
argument_list|(
name|ah
argument_list|,
name|HAL_DEBUG_ATTACH
argument_list|,
literal|"%s: return\n"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
return|return
name|ah
return|;
name|eebad
label|:
name|OS_REG_WRITE
argument_list|(
name|ah
argument_list|,
name|AR_PCICFG
argument_list|,
name|pcicfg
argument_list|)
expr_stmt|;
comment|/* disable EEPROM access */
name|bad
label|:
if|if
condition|(
name|ahp
condition|)
name|ath_hal_free
argument_list|(
name|ahp
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
condition|)
operator|*
name|status
operator|=
name|ecode
expr_stmt|;
return|return
name|AH_NULL
return|;
undef|#
directive|undef
name|N
block|}
end_function

begin_function
name|void
name|ar5210Detach
parameter_list|(
name|struct
name|ath_hal
modifier|*
name|ah
parameter_list|)
block|{
name|HALDEBUG
argument_list|(
name|ah
argument_list|,
name|HAL_DEBUG_ATTACH
argument_list|,
literal|"%s:\n"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
name|HALASSERT
argument_list|(
name|ah
operator|!=
name|AH_NULL
argument_list|)
expr_stmt|;
name|HALASSERT
argument_list|(
name|ah
operator|->
name|ah_magic
operator|==
name|AR5210_MAGIC
argument_list|)
expr_stmt|;
name|ath_hal_eepromDetach
argument_list|(
name|ah
argument_list|)
expr_stmt|;
name|ath_hal_free
argument_list|(
name|ah
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * Store the channel edges for the requested operational mode  */
end_comment

begin_function
specifier|static
name|HAL_BOOL
name|ar5210GetChannelEdges
parameter_list|(
name|struct
name|ath_hal
modifier|*
name|ah
parameter_list|,
name|uint16_t
name|flags
parameter_list|,
name|uint16_t
modifier|*
name|low
parameter_list|,
name|uint16_t
modifier|*
name|high
parameter_list|)
block|{
if|if
condition|(
name|flags
operator|&
name|IEEE80211_CHAN_5GHZ
condition|)
block|{
operator|*
name|low
operator|=
literal|5120
expr_stmt|;
operator|*
name|high
operator|=
literal|5430
expr_stmt|;
return|return
name|AH_TRUE
return|;
block|}
else|else
block|{
return|return
name|AH_FALSE
return|;
block|}
block|}
end_function

begin_function
specifier|static
name|HAL_BOOL
name|ar5210GetChipPowerLimits
parameter_list|(
name|struct
name|ath_hal
modifier|*
name|ah
parameter_list|,
name|struct
name|ieee80211_channel
modifier|*
name|chan
parameter_list|)
block|{
comment|/* XXX fill in, this is just a placeholder */
name|HALDEBUG
argument_list|(
name|ah
argument_list|,
name|HAL_DEBUG_ATTACH
argument_list|,
literal|"%s: no min/max power for %u/0x%x\n"
argument_list|,
name|__func__
argument_list|,
name|chan
operator|->
name|ic_freq
argument_list|,
name|chan
operator|->
name|ic_flags
argument_list|)
expr_stmt|;
name|chan
operator|->
name|ic_maxpower
operator|=
name|AR5210_MAX_RATE_POWER
expr_stmt|;
name|chan
operator|->
name|ic_minpower
operator|=
literal|0
expr_stmt|;
return|return
name|AH_TRUE
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|ar5210ConfigPCIE
parameter_list|(
name|struct
name|ath_hal
modifier|*
name|ah
parameter_list|,
name|HAL_BOOL
name|restore
parameter_list|,
name|HAL_BOOL
name|power_off
parameter_list|)
block|{ }
end_function

begin_function
specifier|static
name|void
name|ar5210DisablePCIE
parameter_list|(
name|struct
name|ath_hal
modifier|*
name|ah
parameter_list|)
block|{ }
end_function

begin_comment
comment|/*  * Fill all software cached or static hardware state information.  */
end_comment

begin_function
specifier|static
name|HAL_BOOL
name|ar5210FillCapabilityInfo
parameter_list|(
name|struct
name|ath_hal
modifier|*
name|ah
parameter_list|)
block|{
name|struct
name|ath_hal_private
modifier|*
name|ahpriv
init|=
name|AH_PRIVATE
argument_list|(
name|ah
argument_list|)
decl_stmt|;
name|HAL_CAPABILITIES
modifier|*
name|pCap
init|=
operator|&
name|ahpriv
operator|->
name|ah_caps
decl_stmt|;
name|pCap
operator|->
name|halWirelessModes
operator||=
name|HAL_MODE_11A
expr_stmt|;
name|pCap
operator|->
name|halLow5GhzChan
operator|=
literal|5120
expr_stmt|;
name|pCap
operator|->
name|halHigh5GhzChan
operator|=
literal|5430
expr_stmt|;
name|pCap
operator|->
name|halSleepAfterBeaconBroken
operator|=
name|AH_TRUE
expr_stmt|;
name|pCap
operator|->
name|halPSPollBroken
operator|=
name|AH_FALSE
expr_stmt|;
name|pCap
operator|->
name|halNumMRRetries
operator|=
literal|1
expr_stmt|;
comment|/* No hardware MRR support */
name|pCap
operator|->
name|halNumTxMaps
operator|=
literal|1
expr_stmt|;
comment|/* Single TX ptr per descr */
name|pCap
operator|->
name|halTotalQueues
operator|=
name|HAL_NUM_TX_QUEUES
expr_stmt|;
name|pCap
operator|->
name|halKeyCacheSize
operator|=
literal|64
expr_stmt|;
comment|/* XXX not needed */
name|pCap
operator|->
name|halChanHalfRate
operator|=
name|AH_FALSE
expr_stmt|;
name|pCap
operator|->
name|halChanQuarterRate
operator|=
name|AH_FALSE
expr_stmt|;
comment|/* 	 * RSSI uses the combined field; some 11n NICs may use 	 * the control chain RSSI. 	 */
name|pCap
operator|->
name|halUseCombinedRadarRssi
operator|=
name|AH_TRUE
expr_stmt|;
if|if
condition|(
name|ath_hal_eepromGetFlag
argument_list|(
name|ah
argument_list|,
name|AR_EEP_RFKILL
argument_list|)
condition|)
block|{
comment|/* 		 * Setup initial rfsilent settings based on the EEPROM 		 * contents.  Pin 0, polarity 0 is fixed; record this 		 * using the EEPROM format found in later parts. 		 */
name|ahpriv
operator|->
name|ah_rfsilent
operator|=
name|SM
argument_list|(
literal|0
argument_list|,
name|AR_EEPROM_RFSILENT_GPIO_SEL
argument_list|)
operator||
name|SM
argument_list|(
literal|0
argument_list|,
name|AR_EEPROM_RFSILENT_POLARITY
argument_list|)
expr_stmt|;
name|ahpriv
operator|->
name|ah_rfkillEnabled
operator|=
name|AH_TRUE
expr_stmt|;
name|pCap
operator|->
name|halRfSilentSupport
operator|=
name|AH_TRUE
expr_stmt|;
block|}
name|pCap
operator|->
name|halTstampPrecision
operator|=
literal|15
expr_stmt|;
comment|/* NB: s/w extended from 13 */
name|pCap
operator|->
name|halIntrMask
operator|=
operator|(
name|HAL_INT_COMMON
operator|-
name|HAL_INT_BNR
operator|)
operator||
name|HAL_INT_RX
operator||
name|HAL_INT_TX
operator||
name|HAL_INT_FATAL
expr_stmt|;
name|pCap
operator|->
name|hal4kbSplitTransSupport
operator|=
name|AH_TRUE
expr_stmt|;
name|pCap
operator|->
name|halHasRxSelfLinkedTail
operator|=
name|AH_TRUE
expr_stmt|;
name|ahpriv
operator|->
name|ah_rxornIsFatal
operator|=
name|AH_TRUE
expr_stmt|;
return|return
name|AH_TRUE
return|;
block|}
end_function

begin_function
specifier|static
specifier|const
name|char
modifier|*
name|ar5210Probe
parameter_list|(
name|uint16_t
name|vendorid
parameter_list|,
name|uint16_t
name|devid
parameter_list|)
block|{
if|if
condition|(
name|vendorid
operator|==
name|ATHEROS_VENDOR_ID
operator|&&
operator|(
name|devid
operator|==
name|AR5210_PROD
operator|||
name|devid
operator|==
name|AR5210_DEFAULT
operator|)
condition|)
return|return
literal|"Atheros 5210"
return|;
return|return
name|AH_NULL
return|;
block|}
end_function

begin_expr_stmt
name|AH_CHIP
argument_list|(
name|AR5210
argument_list|,
name|ar5210Probe
argument_list|,
name|ar5210Attach
argument_list|)
expr_stmt|;
end_expr_stmt

end_unit


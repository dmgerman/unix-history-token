begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Copyright (c) 2002-2009 Sam Leffler, Errno Consulting  * Copyright (c) 2002-2004 Atheros Communications, Inc.  *  * Permission to use, copy, modify, and/or distribute this software for any  * purpose with or without fee is hereby granted, provided that the above  * copyright notice and this permission notice appear in all copies.  *  * THE SOFTWARE IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL WARRANTIES  * WITH REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF  * MERCHANTABILITY AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR  * ANY SPECIAL, DIRECT, INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES  * WHATSOEVER RESULTING FROM LOSS OF USE, DATA OR PROFITS, WHETHER IN AN  * ACTION OF CONTRACT, NEGLIGENCE OR OTHER TORTIOUS ACTION, ARISING OUT OF  * OR IN CONNECTION WITH THE USE OR PERFORMANCE OF THIS SOFTWARE.  *  * $FreeBSD$  */
end_comment

begin_include
include|#
directive|include
file|"opt_ah.h"
end_include

begin_include
include|#
directive|include
file|"ah.h"
end_include

begin_include
include|#
directive|include
file|"ah_internal.h"
end_include

begin_include
include|#
directive|include
file|"ah_desc.h"
end_include

begin_include
include|#
directive|include
file|"ar5210/ar5210.h"
end_include

begin_include
include|#
directive|include
file|"ar5210/ar5210reg.h"
end_include

begin_include
include|#
directive|include
file|"ar5210/ar5210phy.h"
end_include

begin_include
include|#
directive|include
file|"ar5210/ar5210desc.h"
end_include

begin_comment
comment|/*  * Set the properties of the tx queue with the parameters  * from qInfo.  The queue must previously have been setup  * with a call to ar5210SetupTxQueue.  */
end_comment

begin_function
name|HAL_BOOL
name|ar5210SetTxQueueProps
parameter_list|(
name|struct
name|ath_hal
modifier|*
name|ah
parameter_list|,
name|int
name|q
parameter_list|,
specifier|const
name|HAL_TXQ_INFO
modifier|*
name|qInfo
parameter_list|)
block|{
name|struct
name|ath_hal_5210
modifier|*
name|ahp
init|=
name|AH5210
argument_list|(
name|ah
argument_list|)
decl_stmt|;
if|if
condition|(
name|q
operator|>=
name|HAL_NUM_TX_QUEUES
condition|)
block|{
name|HALDEBUG
argument_list|(
name|ah
argument_list|,
name|HAL_DEBUG_ANY
argument_list|,
literal|"%s: invalid queue num %u\n"
argument_list|,
name|__func__
argument_list|,
name|q
argument_list|)
expr_stmt|;
return|return
name|AH_FALSE
return|;
block|}
return|return
name|ath_hal_setTxQProps
argument_list|(
name|ah
argument_list|,
operator|&
name|ahp
operator|->
name|ah_txq
index|[
name|q
index|]
argument_list|,
name|qInfo
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/*  * Return the properties for the specified tx queue.  */
end_comment

begin_function
name|HAL_BOOL
name|ar5210GetTxQueueProps
parameter_list|(
name|struct
name|ath_hal
modifier|*
name|ah
parameter_list|,
name|int
name|q
parameter_list|,
name|HAL_TXQ_INFO
modifier|*
name|qInfo
parameter_list|)
block|{
name|struct
name|ath_hal_5210
modifier|*
name|ahp
init|=
name|AH5210
argument_list|(
name|ah
argument_list|)
decl_stmt|;
if|if
condition|(
name|q
operator|>=
name|HAL_NUM_TX_QUEUES
condition|)
block|{
name|HALDEBUG
argument_list|(
name|ah
argument_list|,
name|HAL_DEBUG_ANY
argument_list|,
literal|"%s: invalid queue num %u\n"
argument_list|,
name|__func__
argument_list|,
name|q
argument_list|)
expr_stmt|;
return|return
name|AH_FALSE
return|;
block|}
return|return
name|ath_hal_getTxQProps
argument_list|(
name|ah
argument_list|,
name|qInfo
argument_list|,
operator|&
name|ahp
operator|->
name|ah_txq
index|[
name|q
index|]
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/*  * Allocate and initialize a tx DCU/QCU combination.  */
end_comment

begin_function
name|int
name|ar5210SetupTxQueue
parameter_list|(
name|struct
name|ath_hal
modifier|*
name|ah
parameter_list|,
name|HAL_TX_QUEUE
name|type
parameter_list|,
specifier|const
name|HAL_TXQ_INFO
modifier|*
name|qInfo
parameter_list|)
block|{
name|struct
name|ath_hal_5210
modifier|*
name|ahp
init|=
name|AH5210
argument_list|(
name|ah
argument_list|)
decl_stmt|;
name|HAL_TX_QUEUE_INFO
modifier|*
name|qi
decl_stmt|;
name|int
name|q
decl_stmt|;
switch|switch
condition|(
name|type
condition|)
block|{
case|case
name|HAL_TX_QUEUE_BEACON
case|:
name|q
operator|=
literal|2
expr_stmt|;
break|break;
case|case
name|HAL_TX_QUEUE_CAB
case|:
name|q
operator|=
literal|1
expr_stmt|;
break|break;
case|case
name|HAL_TX_QUEUE_DATA
case|:
name|q
operator|=
literal|0
expr_stmt|;
break|break;
default|default:
name|HALDEBUG
argument_list|(
name|ah
argument_list|,
name|HAL_DEBUG_ANY
argument_list|,
literal|"%s: bad tx queue type %u\n"
argument_list|,
name|__func__
argument_list|,
name|type
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|HALDEBUG
argument_list|(
name|ah
argument_list|,
name|HAL_DEBUG_TXQUEUE
argument_list|,
literal|"%s: queue %u\n"
argument_list|,
name|__func__
argument_list|,
name|q
argument_list|)
expr_stmt|;
name|qi
operator|=
operator|&
name|ahp
operator|->
name|ah_txq
index|[
name|q
index|]
expr_stmt|;
if|if
condition|(
name|qi
operator|->
name|tqi_type
operator|!=
name|HAL_TX_QUEUE_INACTIVE
condition|)
block|{
name|HALDEBUG
argument_list|(
name|ah
argument_list|,
name|HAL_DEBUG_ANY
argument_list|,
literal|"%s: tx queue %u already active\n"
argument_list|,
name|__func__
argument_list|,
name|q
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|OS_MEMZERO
argument_list|(
name|qi
argument_list|,
sizeof|sizeof
argument_list|(
name|HAL_TX_QUEUE_INFO
argument_list|)
argument_list|)
expr_stmt|;
name|qi
operator|->
name|tqi_type
operator|=
name|type
expr_stmt|;
if|if
condition|(
name|qInfo
operator|==
name|AH_NULL
condition|)
block|{
comment|/* by default enable OK+ERR+DESC+URN interrupts */
name|qi
operator|->
name|tqi_qflags
operator|=
name|HAL_TXQ_TXOKINT_ENABLE
operator||
name|HAL_TXQ_TXERRINT_ENABLE
operator||
name|HAL_TXQ_TXDESCINT_ENABLE
operator||
name|HAL_TXQ_TXURNINT_ENABLE
expr_stmt|;
name|qi
operator|->
name|tqi_aifs
operator|=
name|INIT_AIFS
expr_stmt|;
name|qi
operator|->
name|tqi_cwmin
operator|=
name|HAL_TXQ_USEDEFAULT
expr_stmt|;
comment|/* NB: do at reset */
name|qi
operator|->
name|tqi_shretry
operator|=
name|INIT_SH_RETRY
expr_stmt|;
name|qi
operator|->
name|tqi_lgretry
operator|=
name|INIT_LG_RETRY
expr_stmt|;
block|}
else|else
operator|(
name|void
operator|)
name|ar5210SetTxQueueProps
argument_list|(
name|ah
argument_list|,
name|q
argument_list|,
name|qInfo
argument_list|)
expr_stmt|;
comment|/* NB: must be followed by ar5210ResetTxQueue */
return|return
name|q
return|;
block|}
end_function

begin_comment
comment|/*  * Free a tx DCU/QCU combination.  */
end_comment

begin_function
name|HAL_BOOL
name|ar5210ReleaseTxQueue
parameter_list|(
name|struct
name|ath_hal
modifier|*
name|ah
parameter_list|,
name|u_int
name|q
parameter_list|)
block|{
name|struct
name|ath_hal_5210
modifier|*
name|ahp
init|=
name|AH5210
argument_list|(
name|ah
argument_list|)
decl_stmt|;
name|HAL_TX_QUEUE_INFO
modifier|*
name|qi
decl_stmt|;
if|if
condition|(
name|q
operator|>=
name|HAL_NUM_TX_QUEUES
condition|)
block|{
name|HALDEBUG
argument_list|(
name|ah
argument_list|,
name|HAL_DEBUG_ANY
argument_list|,
literal|"%s: invalid queue num %u\n"
argument_list|,
name|__func__
argument_list|,
name|q
argument_list|)
expr_stmt|;
return|return
name|AH_FALSE
return|;
block|}
name|qi
operator|=
operator|&
name|ahp
operator|->
name|ah_txq
index|[
name|q
index|]
expr_stmt|;
if|if
condition|(
name|qi
operator|->
name|tqi_type
operator|==
name|HAL_TX_QUEUE_INACTIVE
condition|)
block|{
name|HALDEBUG
argument_list|(
name|ah
argument_list|,
name|HAL_DEBUG_TXQUEUE
argument_list|,
literal|"%s: inactive queue %u\n"
argument_list|,
name|__func__
argument_list|,
name|q
argument_list|)
expr_stmt|;
return|return
name|AH_FALSE
return|;
block|}
name|HALDEBUG
argument_list|(
name|ah
argument_list|,
name|HAL_DEBUG_TXQUEUE
argument_list|,
literal|"%s: release queue %u\n"
argument_list|,
name|__func__
argument_list|,
name|q
argument_list|)
expr_stmt|;
name|qi
operator|->
name|tqi_type
operator|=
name|HAL_TX_QUEUE_INACTIVE
expr_stmt|;
name|ahp
operator|->
name|ah_txOkInterruptMask
operator|&=
operator|~
operator|(
literal|1
operator|<<
name|q
operator|)
expr_stmt|;
name|ahp
operator|->
name|ah_txErrInterruptMask
operator|&=
operator|~
operator|(
literal|1
operator|<<
name|q
operator|)
expr_stmt|;
name|ahp
operator|->
name|ah_txDescInterruptMask
operator|&=
operator|~
operator|(
literal|1
operator|<<
name|q
operator|)
expr_stmt|;
name|ahp
operator|->
name|ah_txEolInterruptMask
operator|&=
operator|~
operator|(
literal|1
operator|<<
name|q
operator|)
expr_stmt|;
name|ahp
operator|->
name|ah_txUrnInterruptMask
operator|&=
operator|~
operator|(
literal|1
operator|<<
name|q
operator|)
expr_stmt|;
return|return
name|AH_TRUE
return|;
undef|#
directive|undef
name|N
block|}
end_function

begin_function
name|HAL_BOOL
name|ar5210ResetTxQueue
parameter_list|(
name|struct
name|ath_hal
modifier|*
name|ah
parameter_list|,
name|u_int
name|q
parameter_list|)
block|{
name|struct
name|ath_hal_5210
modifier|*
name|ahp
init|=
name|AH5210
argument_list|(
name|ah
argument_list|)
decl_stmt|;
specifier|const
name|struct
name|ieee80211_channel
modifier|*
name|chan
init|=
name|AH_PRIVATE
argument_list|(
name|ah
argument_list|)
operator|->
name|ah_curchan
decl_stmt|;
name|HAL_TX_QUEUE_INFO
modifier|*
name|qi
decl_stmt|;
name|uint32_t
name|cwMin
decl_stmt|;
if|if
condition|(
name|q
operator|>=
name|HAL_NUM_TX_QUEUES
condition|)
block|{
name|HALDEBUG
argument_list|(
name|ah
argument_list|,
name|HAL_DEBUG_ANY
argument_list|,
literal|"%s: invalid queue num %u\n"
argument_list|,
name|__func__
argument_list|,
name|q
argument_list|)
expr_stmt|;
return|return
name|AH_FALSE
return|;
block|}
name|qi
operator|=
operator|&
name|ahp
operator|->
name|ah_txq
index|[
name|q
index|]
expr_stmt|;
if|if
condition|(
name|qi
operator|->
name|tqi_type
operator|==
name|HAL_TX_QUEUE_INACTIVE
condition|)
block|{
name|HALDEBUG
argument_list|(
name|ah
argument_list|,
name|HAL_DEBUG_TXQUEUE
argument_list|,
literal|"%s: inactive queue %u\n"
argument_list|,
name|__func__
argument_list|,
name|q
argument_list|)
expr_stmt|;
return|return
name|AH_FALSE
return|;
block|}
comment|/* 	 * Ignore any non-data queue(s). 	 */
if|if
condition|(
name|qi
operator|->
name|tqi_type
operator|!=
name|HAL_TX_QUEUE_DATA
condition|)
return|return
name|AH_TRUE
return|;
comment|/* Set turbo mode / base mode parameters on or off */
if|if
condition|(
name|IEEE80211_IS_CHAN_TURBO
argument_list|(
name|chan
argument_list|)
condition|)
block|{
name|OS_REG_WRITE
argument_list|(
name|ah
argument_list|,
name|AR_SLOT_TIME
argument_list|,
name|INIT_SLOT_TIME_TURBO
argument_list|)
expr_stmt|;
name|OS_REG_WRITE
argument_list|(
name|ah
argument_list|,
name|AR_TIME_OUT
argument_list|,
name|INIT_ACK_CTS_TIMEOUT_TURBO
argument_list|)
expr_stmt|;
name|OS_REG_WRITE
argument_list|(
name|ah
argument_list|,
name|AR_USEC
argument_list|,
name|INIT_TRANSMIT_LATENCY_TURBO
argument_list|)
expr_stmt|;
name|OS_REG_WRITE
argument_list|(
name|ah
argument_list|,
name|AR_IFS0
argument_list|,
operator|(
operator|(
name|INIT_SIFS_TURBO
operator|+
name|qi
operator|->
name|tqi_aifs
operator|*
name|INIT_SLOT_TIME_TURBO
operator|)
operator|<<
name|AR_IFS0_DIFS_S
operator|)
operator||
name|INIT_SIFS_TURBO
argument_list|)
expr_stmt|;
name|OS_REG_WRITE
argument_list|(
name|ah
argument_list|,
name|AR_IFS1
argument_list|,
name|INIT_PROTO_TIME_CNTRL_TURBO
argument_list|)
expr_stmt|;
name|OS_REG_WRITE
argument_list|(
name|ah
argument_list|,
name|AR_PHY
argument_list|(
literal|17
argument_list|)
argument_list|,
operator|(
name|OS_REG_READ
argument_list|(
name|ah
argument_list|,
name|AR_PHY
argument_list|(
literal|17
argument_list|)
argument_list|)
operator|&
operator|~
literal|0x7F
operator|)
operator||
literal|0x38
argument_list|)
expr_stmt|;
name|OS_REG_WRITE
argument_list|(
name|ah
argument_list|,
name|AR_PHY_FRCTL
argument_list|,
name|AR_PHY_SERVICE_ERR
operator||
name|AR_PHY_TXURN_ERR
operator||
name|AR_PHY_ILLLEN_ERR
operator||
name|AR_PHY_ILLRATE_ERR
operator||
name|AR_PHY_PARITY_ERR
operator||
name|AR_PHY_TIMING_ERR
operator||
literal|0x2020
operator||
name|AR_PHY_TURBO_MODE
operator||
name|AR_PHY_TURBO_SHORT
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|OS_REG_WRITE
argument_list|(
name|ah
argument_list|,
name|AR_SLOT_TIME
argument_list|,
name|INIT_SLOT_TIME
argument_list|)
expr_stmt|;
name|OS_REG_WRITE
argument_list|(
name|ah
argument_list|,
name|AR_TIME_OUT
argument_list|,
name|INIT_ACK_CTS_TIMEOUT
argument_list|)
expr_stmt|;
name|OS_REG_WRITE
argument_list|(
name|ah
argument_list|,
name|AR_USEC
argument_list|,
name|INIT_TRANSMIT_LATENCY
argument_list|)
expr_stmt|;
name|OS_REG_WRITE
argument_list|(
name|ah
argument_list|,
name|AR_IFS0
argument_list|,
operator|(
operator|(
name|INIT_SIFS
operator|+
name|qi
operator|->
name|tqi_aifs
operator|*
name|INIT_SLOT_TIME
operator|)
operator|<<
name|AR_IFS0_DIFS_S
operator|)
operator||
name|INIT_SIFS
argument_list|)
expr_stmt|;
name|OS_REG_WRITE
argument_list|(
name|ah
argument_list|,
name|AR_IFS1
argument_list|,
name|INIT_PROTO_TIME_CNTRL
argument_list|)
expr_stmt|;
name|OS_REG_WRITE
argument_list|(
name|ah
argument_list|,
name|AR_PHY
argument_list|(
literal|17
argument_list|)
argument_list|,
operator|(
name|OS_REG_READ
argument_list|(
name|ah
argument_list|,
name|AR_PHY
argument_list|(
literal|17
argument_list|)
argument_list|)
operator|&
operator|~
literal|0x7F
operator|)
operator||
literal|0x1C
argument_list|)
expr_stmt|;
name|OS_REG_WRITE
argument_list|(
name|ah
argument_list|,
name|AR_PHY_FRCTL
argument_list|,
name|AR_PHY_SERVICE_ERR
operator||
name|AR_PHY_TXURN_ERR
operator||
name|AR_PHY_ILLLEN_ERR
operator||
name|AR_PHY_ILLRATE_ERR
operator||
name|AR_PHY_PARITY_ERR
operator||
name|AR_PHY_TIMING_ERR
operator||
literal|0x1020
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|qi
operator|->
name|tqi_cwmin
operator|==
name|HAL_TXQ_USEDEFAULT
condition|)
name|cwMin
operator|=
name|INIT_CWMIN
expr_stmt|;
else|else
name|cwMin
operator|=
name|qi
operator|->
name|tqi_cwmin
expr_stmt|;
comment|/* Set cwmin and retry limit values */
name|OS_REG_WRITE
argument_list|(
name|ah
argument_list|,
name|AR_RETRY_LMT
argument_list|,
operator|(
name|cwMin
operator|<<
name|AR_RETRY_LMT_CW_MIN_S
operator|)
operator||
name|SM
argument_list|(
name|INIT_SLG_RETRY
argument_list|,
name|AR_RETRY_LMT_SLG_RETRY
argument_list|)
operator||
name|SM
argument_list|(
name|INIT_SSH_RETRY
argument_list|,
name|AR_RETRY_LMT_SSH_RETRY
argument_list|)
operator||
name|SM
argument_list|(
name|qi
operator|->
name|tqi_lgretry
argument_list|,
name|AR_RETRY_LMT_LG_RETRY
argument_list|)
operator||
name|SM
argument_list|(
name|qi
operator|->
name|tqi_shretry
argument_list|,
name|AR_RETRY_LMT_SH_RETRY
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|qi
operator|->
name|tqi_qflags
operator|&
name|HAL_TXQ_TXOKINT_ENABLE
condition|)
name|ahp
operator|->
name|ah_txOkInterruptMask
operator||=
literal|1
operator|<<
name|q
expr_stmt|;
else|else
name|ahp
operator|->
name|ah_txOkInterruptMask
operator|&=
operator|~
operator|(
literal|1
operator|<<
name|q
operator|)
expr_stmt|;
if|if
condition|(
name|qi
operator|->
name|tqi_qflags
operator|&
name|HAL_TXQ_TXERRINT_ENABLE
condition|)
name|ahp
operator|->
name|ah_txErrInterruptMask
operator||=
literal|1
operator|<<
name|q
expr_stmt|;
else|else
name|ahp
operator|->
name|ah_txErrInterruptMask
operator|&=
operator|~
operator|(
literal|1
operator|<<
name|q
operator|)
expr_stmt|;
if|if
condition|(
name|qi
operator|->
name|tqi_qflags
operator|&
name|HAL_TXQ_TXDESCINT_ENABLE
condition|)
name|ahp
operator|->
name|ah_txDescInterruptMask
operator||=
literal|1
operator|<<
name|q
expr_stmt|;
else|else
name|ahp
operator|->
name|ah_txDescInterruptMask
operator|&=
operator|~
operator|(
literal|1
operator|<<
name|q
operator|)
expr_stmt|;
if|if
condition|(
name|qi
operator|->
name|tqi_qflags
operator|&
name|HAL_TXQ_TXEOLINT_ENABLE
condition|)
name|ahp
operator|->
name|ah_txEolInterruptMask
operator||=
literal|1
operator|<<
name|q
expr_stmt|;
else|else
name|ahp
operator|->
name|ah_txEolInterruptMask
operator|&=
operator|~
operator|(
literal|1
operator|<<
name|q
operator|)
expr_stmt|;
if|if
condition|(
name|qi
operator|->
name|tqi_qflags
operator|&
name|HAL_TXQ_TXURNINT_ENABLE
condition|)
name|ahp
operator|->
name|ah_txUrnInterruptMask
operator||=
literal|1
operator|<<
name|q
expr_stmt|;
else|else
name|ahp
operator|->
name|ah_txUrnInterruptMask
operator|&=
operator|~
operator|(
literal|1
operator|<<
name|q
operator|)
expr_stmt|;
return|return
name|AH_TRUE
return|;
block|}
end_function

begin_comment
comment|/*  * Get the TXDP for the "main" data queue.  Needs to be extended  * for multiple Q functionality  */
end_comment

begin_function
name|uint32_t
name|ar5210GetTxDP
parameter_list|(
name|struct
name|ath_hal
modifier|*
name|ah
parameter_list|,
name|u_int
name|q
parameter_list|)
block|{
name|struct
name|ath_hal_5210
modifier|*
name|ahp
init|=
name|AH5210
argument_list|(
name|ah
argument_list|)
decl_stmt|;
name|HAL_TX_QUEUE_INFO
modifier|*
name|qi
decl_stmt|;
name|HALASSERT
argument_list|(
name|q
operator|<
name|HAL_NUM_TX_QUEUES
argument_list|)
expr_stmt|;
name|qi
operator|=
operator|&
name|ahp
operator|->
name|ah_txq
index|[
name|q
index|]
expr_stmt|;
switch|switch
condition|(
name|qi
operator|->
name|tqi_type
condition|)
block|{
case|case
name|HAL_TX_QUEUE_DATA
case|:
return|return
name|OS_REG_READ
argument_list|(
name|ah
argument_list|,
name|AR_TXDP0
argument_list|)
return|;
case|case
name|HAL_TX_QUEUE_INACTIVE
case|:
name|HALDEBUG
argument_list|(
name|ah
argument_list|,
name|HAL_DEBUG_ANY
argument_list|,
literal|"%s: inactive queue %u\n"
argument_list|,
name|__func__
argument_list|,
name|q
argument_list|)
expr_stmt|;
comment|/* fall thru... */
default|default:
break|break;
block|}
return|return
literal|0xffffffff
return|;
block|}
end_function

begin_comment
comment|/*  * Set the TxDP for the "main" data queue.  */
end_comment

begin_function
name|HAL_BOOL
name|ar5210SetTxDP
parameter_list|(
name|struct
name|ath_hal
modifier|*
name|ah
parameter_list|,
name|u_int
name|q
parameter_list|,
name|uint32_t
name|txdp
parameter_list|)
block|{
name|struct
name|ath_hal_5210
modifier|*
name|ahp
init|=
name|AH5210
argument_list|(
name|ah
argument_list|)
decl_stmt|;
name|HAL_TX_QUEUE_INFO
modifier|*
name|qi
decl_stmt|;
name|HALASSERT
argument_list|(
name|q
operator|<
name|HAL_NUM_TX_QUEUES
argument_list|)
expr_stmt|;
name|HALDEBUG
argument_list|(
name|ah
argument_list|,
name|HAL_DEBUG_TXQUEUE
argument_list|,
literal|"%s: queue %u 0x%x\n"
argument_list|,
name|__func__
argument_list|,
name|q
argument_list|,
name|txdp
argument_list|)
expr_stmt|;
name|qi
operator|=
operator|&
name|ahp
operator|->
name|ah_txq
index|[
name|q
index|]
expr_stmt|;
switch|switch
condition|(
name|qi
operator|->
name|tqi_type
condition|)
block|{
case|case
name|HAL_TX_QUEUE_DATA
case|:
ifdef|#
directive|ifdef
name|AH_DEBUG
comment|/* 		 * Make sure that TXE is deasserted before setting the 		 * TXDP.  If TXE is still asserted, setting TXDP will 		 * have no effect. 		 */
if|if
condition|(
name|OS_REG_READ
argument_list|(
name|ah
argument_list|,
name|AR_CR
argument_list|)
operator|&
name|AR_CR_TXE0
condition|)
name|ath_hal_printf
argument_list|(
name|ah
argument_list|,
literal|"%s: TXE asserted; AR_CR=0x%x\n"
argument_list|,
name|__func__
argument_list|,
name|OS_REG_READ
argument_list|(
name|ah
argument_list|,
name|AR_CR
argument_list|)
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|OS_REG_WRITE
argument_list|(
name|ah
argument_list|,
name|AR_TXDP0
argument_list|,
name|txdp
argument_list|)
expr_stmt|;
break|break;
case|case
name|HAL_TX_QUEUE_BEACON
case|:
case|case
name|HAL_TX_QUEUE_CAB
case|:
name|OS_REG_WRITE
argument_list|(
name|ah
argument_list|,
name|AR_TXDP1
argument_list|,
name|txdp
argument_list|)
expr_stmt|;
break|break;
case|case
name|HAL_TX_QUEUE_INACTIVE
case|:
name|HALDEBUG
argument_list|(
name|ah
argument_list|,
name|HAL_DEBUG_TXQUEUE
argument_list|,
literal|"%s: inactive queue %u\n"
argument_list|,
name|__func__
argument_list|,
name|q
argument_list|)
expr_stmt|;
comment|/* fall thru... */
default|default:
return|return
name|AH_FALSE
return|;
block|}
return|return
name|AH_TRUE
return|;
block|}
end_function

begin_comment
comment|/*  * Update Tx FIFO trigger level.  *  * Set bIncTrigLevel to TRUE to increase the trigger level.  * Set bIncTrigLevel to FALSE to decrease the trigger level.  *  * Returns TRUE if the trigger level was updated  */
end_comment

begin_function
name|HAL_BOOL
name|ar5210UpdateTxTrigLevel
parameter_list|(
name|struct
name|ath_hal
modifier|*
name|ah
parameter_list|,
name|HAL_BOOL
name|bIncTrigLevel
parameter_list|)
block|{
name|uint32_t
name|curTrigLevel
decl_stmt|;
name|HAL_INT
name|ints
init|=
name|ar5210GetInterrupts
argument_list|(
name|ah
argument_list|)
decl_stmt|;
comment|/* 	 * Disable chip interrupts. This is because halUpdateTxTrigLevel 	 * is called from both ISR and non-ISR contexts. 	 */
operator|(
name|void
operator|)
name|ar5210SetInterrupts
argument_list|(
name|ah
argument_list|,
name|ints
operator|&
operator|~
name|HAL_INT_GLOBAL
argument_list|)
expr_stmt|;
name|curTrigLevel
operator|=
name|OS_REG_READ
argument_list|(
name|ah
argument_list|,
name|AR_TRIG_LEV
argument_list|)
expr_stmt|;
if|if
condition|(
name|bIncTrigLevel
condition|)
block|{
comment|/* increase the trigger level */
name|curTrigLevel
operator|=
name|curTrigLevel
operator|+
operator|(
operator|(
name|MAX_TX_FIFO_THRESHOLD
operator|-
name|curTrigLevel
operator|)
operator|/
literal|2
operator|)
expr_stmt|;
block|}
else|else
block|{
comment|/* decrease the trigger level if not already at the minimum */
if|if
condition|(
name|curTrigLevel
operator|>
name|MIN_TX_FIFO_THRESHOLD
condition|)
block|{
comment|/* decrease the trigger level */
name|curTrigLevel
operator|--
expr_stmt|;
block|}
else|else
block|{
comment|/* no update to the trigger level */
comment|/* re-enable chip interrupts */
name|ar5210SetInterrupts
argument_list|(
name|ah
argument_list|,
name|ints
argument_list|)
expr_stmt|;
return|return
name|AH_FALSE
return|;
block|}
block|}
comment|/* Update the trigger level */
name|OS_REG_WRITE
argument_list|(
name|ah
argument_list|,
name|AR_TRIG_LEV
argument_list|,
name|curTrigLevel
argument_list|)
expr_stmt|;
comment|/* re-enable chip interrupts */
name|ar5210SetInterrupts
argument_list|(
name|ah
argument_list|,
name|ints
argument_list|)
expr_stmt|;
return|return
name|AH_TRUE
return|;
block|}
end_function

begin_comment
comment|/*  * Set Transmit Enable bits for the specified queues.  */
end_comment

begin_function
name|HAL_BOOL
name|ar5210StartTxDma
parameter_list|(
name|struct
name|ath_hal
modifier|*
name|ah
parameter_list|,
name|u_int
name|q
parameter_list|)
block|{
name|struct
name|ath_hal_5210
modifier|*
name|ahp
init|=
name|AH5210
argument_list|(
name|ah
argument_list|)
decl_stmt|;
name|HAL_TX_QUEUE_INFO
modifier|*
name|qi
decl_stmt|;
name|HALASSERT
argument_list|(
name|q
operator|<
name|HAL_NUM_TX_QUEUES
argument_list|)
expr_stmt|;
name|HALDEBUG
argument_list|(
name|ah
argument_list|,
name|HAL_DEBUG_TXQUEUE
argument_list|,
literal|"%s: queue %u\n"
argument_list|,
name|__func__
argument_list|,
name|q
argument_list|)
expr_stmt|;
name|qi
operator|=
operator|&
name|ahp
operator|->
name|ah_txq
index|[
name|q
index|]
expr_stmt|;
switch|switch
condition|(
name|qi
operator|->
name|tqi_type
condition|)
block|{
case|case
name|HAL_TX_QUEUE_DATA
case|:
name|OS_REG_WRITE
argument_list|(
name|ah
argument_list|,
name|AR_CR
argument_list|,
name|AR_CR_TXE0
argument_list|)
expr_stmt|;
break|break;
case|case
name|HAL_TX_QUEUE_CAB
case|:
name|OS_REG_WRITE
argument_list|(
name|ah
argument_list|,
name|AR_CR
argument_list|,
name|AR_CR_TXE1
argument_list|)
expr_stmt|;
comment|/* enable altq xmit */
name|OS_REG_WRITE
argument_list|(
name|ah
argument_list|,
name|AR_BCR
argument_list|,
name|AR_BCR_TQ1V
operator||
name|AR_BCR_BDMAE
operator||
name|AR_BCR_TQ1FV
argument_list|)
expr_stmt|;
break|break;
case|case
name|HAL_TX_QUEUE_BEACON
case|:
comment|/* XXX add CR_BCR_BCMD if IBSS mode */
name|OS_REG_WRITE
argument_list|(
name|ah
argument_list|,
name|AR_BCR
argument_list|,
name|AR_BCR_TQ1V
operator||
name|AR_BCR_BDMAE
argument_list|)
expr_stmt|;
break|break;
case|case
name|HAL_TX_QUEUE_INACTIVE
case|:
name|HALDEBUG
argument_list|(
name|ah
argument_list|,
name|HAL_DEBUG_ANY
argument_list|,
literal|"%s: inactive queue %u\n"
argument_list|,
name|__func__
argument_list|,
name|q
argument_list|)
expr_stmt|;
comment|/* fal thru... */
default|default:
return|return
name|AH_FALSE
return|;
block|}
return|return
name|AH_TRUE
return|;
block|}
end_function

begin_function
name|uint32_t
name|ar5210NumTxPending
parameter_list|(
name|struct
name|ath_hal
modifier|*
name|ah
parameter_list|,
name|u_int
name|q
parameter_list|)
block|{
name|struct
name|ath_hal_5210
modifier|*
name|ahp
init|=
name|AH5210
argument_list|(
name|ah
argument_list|)
decl_stmt|;
name|HAL_TX_QUEUE_INFO
modifier|*
name|qi
decl_stmt|;
name|uint32_t
name|v
decl_stmt|;
name|HALASSERT
argument_list|(
name|q
operator|<
name|HAL_NUM_TX_QUEUES
argument_list|)
expr_stmt|;
name|HALDEBUG
argument_list|(
name|ah
argument_list|,
name|HAL_DEBUG_TXQUEUE
argument_list|,
literal|"%s: queue %u\n"
argument_list|,
name|__func__
argument_list|,
name|q
argument_list|)
expr_stmt|;
name|qi
operator|=
operator|&
name|ahp
operator|->
name|ah_txq
index|[
name|q
index|]
expr_stmt|;
switch|switch
condition|(
name|qi
operator|->
name|tqi_type
condition|)
block|{
case|case
name|HAL_TX_QUEUE_DATA
case|:
name|v
operator|=
name|OS_REG_READ
argument_list|(
name|ah
argument_list|,
name|AR_CFG
argument_list|)
expr_stmt|;
return|return
name|MS
argument_list|(
name|v
argument_list|,
name|AR_CFG_TXCNT
argument_list|)
return|;
case|case
name|HAL_TX_QUEUE_INACTIVE
case|:
name|HALDEBUG
argument_list|(
name|ah
argument_list|,
name|HAL_DEBUG_ANY
argument_list|,
literal|"%s: inactive queue %u\n"
argument_list|,
name|__func__
argument_list|,
name|q
argument_list|)
expr_stmt|;
comment|/* fall thru... */
default|default:
break|break;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/*  * Stop transmit on the specified queue  */
end_comment

begin_function
name|HAL_BOOL
name|ar5210StopTxDma
parameter_list|(
name|struct
name|ath_hal
modifier|*
name|ah
parameter_list|,
name|u_int
name|q
parameter_list|)
block|{
name|struct
name|ath_hal_5210
modifier|*
name|ahp
init|=
name|AH5210
argument_list|(
name|ah
argument_list|)
decl_stmt|;
name|HAL_TX_QUEUE_INFO
modifier|*
name|qi
decl_stmt|;
name|HALASSERT
argument_list|(
name|q
operator|<
name|HAL_NUM_TX_QUEUES
argument_list|)
expr_stmt|;
name|HALDEBUG
argument_list|(
name|ah
argument_list|,
name|HAL_DEBUG_TXQUEUE
argument_list|,
literal|"%s: queue %u\n"
argument_list|,
name|__func__
argument_list|,
name|q
argument_list|)
expr_stmt|;
name|qi
operator|=
operator|&
name|ahp
operator|->
name|ah_txq
index|[
name|q
index|]
expr_stmt|;
switch|switch
condition|(
name|qi
operator|->
name|tqi_type
condition|)
block|{
case|case
name|HAL_TX_QUEUE_DATA
case|:
block|{
name|int
name|i
decl_stmt|;
name|OS_REG_WRITE
argument_list|(
name|ah
argument_list|,
name|AR_CR
argument_list|,
name|AR_CR_TXD0
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|1000
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
operator|(
name|OS_REG_READ
argument_list|(
name|ah
argument_list|,
name|AR_CFG
argument_list|)
operator|&
name|AR_CFG_TXCNT
operator|)
operator|==
literal|0
condition|)
break|break;
name|OS_DELAY
argument_list|(
literal|10
argument_list|)
expr_stmt|;
block|}
name|OS_REG_WRITE
argument_list|(
name|ah
argument_list|,
name|AR_CR
argument_list|,
literal|0
argument_list|)
expr_stmt|;
return|return
operator|(
name|i
operator|<
literal|1000
operator|)
return|;
block|}
case|case
name|HAL_TX_QUEUE_BEACON
case|:
return|return
name|ath_hal_wait
argument_list|(
name|ah
argument_list|,
name|AR_BSR
argument_list|,
name|AR_BSR_TXQ1F
argument_list|,
literal|0
argument_list|)
return|;
case|case
name|HAL_TX_QUEUE_INACTIVE
case|:
name|HALDEBUG
argument_list|(
name|ah
argument_list|,
name|HAL_DEBUG_ANY
argument_list|,
literal|"%s: inactive queue %u\n"
argument_list|,
name|__func__
argument_list|,
name|q
argument_list|)
expr_stmt|;
comment|/* fall thru... */
default|default:
break|break;
block|}
return|return
name|AH_FALSE
return|;
block|}
end_function

begin_comment
comment|/*  * Descriptor Access Functions  */
end_comment

begin_define
define|#
directive|define
name|VALID_PKT_TYPES
define|\
value|((1<<HAL_PKT_TYPE_NORMAL)|(1<<HAL_PKT_TYPE_ATIM)|\ 	 (1<<HAL_PKT_TYPE_PSPOLL)|(1<<HAL_PKT_TYPE_PROBE_RESP)|\ 	 (1<<HAL_PKT_TYPE_BEACON))
end_define

begin_define
define|#
directive|define
name|isValidPktType
parameter_list|(
name|_t
parameter_list|)
value|((1<<(_t))& VALID_PKT_TYPES)
end_define

begin_define
define|#
directive|define
name|VALID_TX_RATES
define|\
value|((1<<0x0b)|(1<<0x0f)|(1<<0x0a)|(1<<0x0e)|(1<<0x09)|(1<<0x0d)|\ 	 (1<<0x08)|(1<<0x0c)|(1<<0x1b)|(1<<0x1a)|(1<<0x1e)|(1<<0x19)|\ 	 (1<<0x1d)|(1<<0x18)|(1<<0x1c))
end_define

begin_define
define|#
directive|define
name|isValidTxRate
parameter_list|(
name|_r
parameter_list|)
value|((1<<(_r))& VALID_TX_RATES)
end_define

begin_function
name|HAL_BOOL
name|ar5210SetupTxDesc
parameter_list|(
name|struct
name|ath_hal
modifier|*
name|ah
parameter_list|,
name|struct
name|ath_desc
modifier|*
name|ds
parameter_list|,
name|u_int
name|pktLen
parameter_list|,
name|u_int
name|hdrLen
parameter_list|,
name|HAL_PKT_TYPE
name|type
parameter_list|,
name|u_int
name|txPower
parameter_list|,
name|u_int
name|txRate0
parameter_list|,
name|u_int
name|txTries0
parameter_list|,
name|u_int
name|keyIx
parameter_list|,
name|u_int
name|antMode
parameter_list|,
name|u_int
name|flags
parameter_list|,
name|u_int
name|rtsctsRate
parameter_list|,
name|u_int
name|rtsctsDuration
parameter_list|,
name|u_int
name|compicvLen
parameter_list|,
name|u_int
name|compivLen
parameter_list|,
name|u_int
name|comp
parameter_list|)
block|{
name|struct
name|ar5210_desc
modifier|*
name|ads
init|=
name|AR5210DESC
argument_list|(
name|ds
argument_list|)
decl_stmt|;
name|uint32_t
name|frtype
decl_stmt|;
operator|(
name|void
operator|)
name|txPower
expr_stmt|;
operator|(
name|void
operator|)
name|rtsctsDuration
expr_stmt|;
name|HALASSERT
argument_list|(
name|txTries0
operator|!=
literal|0
argument_list|)
expr_stmt|;
name|HALASSERT
argument_list|(
name|isValidPktType
argument_list|(
name|type
argument_list|)
argument_list|)
expr_stmt|;
name|HALASSERT
argument_list|(
name|isValidTxRate
argument_list|(
name|txRate0
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|type
operator|==
name|HAL_PKT_TYPE_BEACON
operator|||
name|type
operator|==
name|HAL_PKT_TYPE_PROBE_RESP
condition|)
name|frtype
operator|=
name|AR_Frm_NoDelay
expr_stmt|;
else|else
name|frtype
operator|=
name|type
operator|<<
literal|26
expr_stmt|;
name|ads
operator|->
name|ds_ctl0
operator|=
operator|(
name|pktLen
operator|&
name|AR_FrameLen
operator|)
operator||
operator|(
name|txRate0
operator|<<
name|AR_XmitRate_S
operator|)
operator||
operator|(
operator|(
name|hdrLen
operator|<<
name|AR_HdrLen_S
operator|)
operator|&
name|AR_HdrLen
operator|)
operator||
name|frtype
operator||
operator|(
name|flags
operator|&
name|HAL_TXDESC_CLRDMASK
condition|?
name|AR_ClearDestMask
else|:
literal|0
operator|)
operator||
operator|(
name|flags
operator|&
name|HAL_TXDESC_INTREQ
condition|?
name|AR_TxInterReq
else|:
literal|0
operator|)
operator||
operator|(
name|antMode
condition|?
name|AR_AntModeXmit
else|:
literal|0
operator|)
expr_stmt|;
if|if
condition|(
name|keyIx
operator|!=
name|HAL_TXKEYIX_INVALID
condition|)
block|{
name|ads
operator|->
name|ds_ctl1
operator|=
operator|(
name|keyIx
operator|<<
name|AR_EncryptKeyIdx_S
operator|)
operator|&
name|AR_EncryptKeyIdx
expr_stmt|;
name|ads
operator|->
name|ds_ctl0
operator||=
name|AR_EncryptKeyValid
expr_stmt|;
block|}
else|else
name|ads
operator|->
name|ds_ctl1
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|flags
operator|&
name|HAL_TXDESC_RTSENA
condition|)
block|{
name|ads
operator|->
name|ds_ctl0
operator||=
name|AR_RTSCTSEnable
expr_stmt|;
name|ads
operator|->
name|ds_ctl1
operator||=
name|rtsctsDuration
operator|&
name|AR_RTSDuration
expr_stmt|;
block|}
return|return
name|AH_TRUE
return|;
block|}
end_function

begin_function
name|HAL_BOOL
name|ar5210SetupXTxDesc
parameter_list|(
name|struct
name|ath_hal
modifier|*
name|ah
parameter_list|,
name|struct
name|ath_desc
modifier|*
name|ds
parameter_list|,
name|u_int
name|txRate1
parameter_list|,
name|u_int
name|txTries1
parameter_list|,
name|u_int
name|txRate2
parameter_list|,
name|u_int
name|txTries2
parameter_list|,
name|u_int
name|txRate3
parameter_list|,
name|u_int
name|txTries3
parameter_list|)
block|{
operator|(
name|void
operator|)
name|ah
expr_stmt|;
operator|(
name|void
operator|)
name|ds
expr_stmt|;
operator|(
name|void
operator|)
name|txRate1
expr_stmt|;
operator|(
name|void
operator|)
name|txTries1
expr_stmt|;
operator|(
name|void
operator|)
name|txRate2
expr_stmt|;
operator|(
name|void
operator|)
name|txTries2
expr_stmt|;
operator|(
name|void
operator|)
name|txRate3
expr_stmt|;
operator|(
name|void
operator|)
name|txTries3
expr_stmt|;
return|return
name|AH_FALSE
return|;
block|}
end_function

begin_function
name|void
name|ar5210IntrReqTxDesc
parameter_list|(
name|struct
name|ath_hal
modifier|*
name|ah
parameter_list|,
name|struct
name|ath_desc
modifier|*
name|ds
parameter_list|)
block|{
name|struct
name|ar5210_desc
modifier|*
name|ads
init|=
name|AR5210DESC
argument_list|(
name|ds
argument_list|)
decl_stmt|;
name|ads
operator|->
name|ds_ctl0
operator||=
name|AR_TxInterReq
expr_stmt|;
block|}
end_function

begin_function
name|HAL_BOOL
name|ar5210FillTxDesc
parameter_list|(
name|struct
name|ath_hal
modifier|*
name|ah
parameter_list|,
name|struct
name|ath_desc
modifier|*
name|ds
parameter_list|,
name|u_int
name|segLen
parameter_list|,
name|HAL_BOOL
name|firstSeg
parameter_list|,
name|HAL_BOOL
name|lastSeg
parameter_list|,
specifier|const
name|struct
name|ath_desc
modifier|*
name|ds0
parameter_list|)
block|{
name|struct
name|ar5210_desc
modifier|*
name|ads
init|=
name|AR5210DESC
argument_list|(
name|ds
argument_list|)
decl_stmt|;
name|HALASSERT
argument_list|(
operator|(
name|segLen
operator|&
operator|~
name|AR_BufLen
operator|)
operator|==
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|firstSeg
condition|)
block|{
comment|/* 		 * First descriptor, don't clobber xmit control data 		 * setup by ar5210SetupTxDesc. 		 */
name|ads
operator|->
name|ds_ctl1
operator||=
name|segLen
operator||
operator|(
name|lastSeg
condition|?
literal|0
else|:
name|AR_More
operator|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|lastSeg
condition|)
block|{
comment|/* !firstSeg&& lastSeg */
comment|/* 		 * Last descriptor in a multi-descriptor frame, 		 * copy the transmit parameters from the first 		 * frame for processing on completion.  		 */
name|ads
operator|->
name|ds_ctl0
operator|=
name|AR5210DESC_CONST
argument_list|(
name|ds0
argument_list|)
operator|->
name|ds_ctl0
expr_stmt|;
name|ads
operator|->
name|ds_ctl1
operator|=
name|segLen
expr_stmt|;
block|}
else|else
block|{
comment|/* !firstSeg&& !lastSeg */
comment|/* 		 * Intermediate descriptor in a multi-descriptor frame. 		 */
name|ads
operator|->
name|ds_ctl0
operator|=
literal|0
expr_stmt|;
name|ads
operator|->
name|ds_ctl1
operator|=
name|segLen
operator||
name|AR_More
expr_stmt|;
block|}
name|ads
operator|->
name|ds_status0
operator|=
name|ads
operator|->
name|ds_status1
operator|=
literal|0
expr_stmt|;
return|return
name|AH_TRUE
return|;
block|}
end_function

begin_comment
comment|/*  * Processing of HW TX descriptor.  */
end_comment

begin_function
name|HAL_STATUS
name|ar5210ProcTxDesc
parameter_list|(
name|struct
name|ath_hal
modifier|*
name|ah
parameter_list|,
name|struct
name|ath_desc
modifier|*
name|ds
parameter_list|,
name|struct
name|ath_tx_status
modifier|*
name|ts
parameter_list|)
block|{
name|struct
name|ar5210_desc
modifier|*
name|ads
init|=
name|AR5210DESC
argument_list|(
name|ds
argument_list|)
decl_stmt|;
if|if
condition|(
operator|(
name|ads
operator|->
name|ds_status1
operator|&
name|AR_Done
operator|)
operator|==
literal|0
condition|)
return|return
name|HAL_EINPROGRESS
return|;
comment|/* Update software copies of the HW status */
name|ts
operator|->
name|ts_seqnum
operator|=
name|ads
operator|->
name|ds_status1
operator|&
name|AR_SeqNum
expr_stmt|;
name|ts
operator|->
name|ts_tstamp
operator|=
name|MS
argument_list|(
name|ads
operator|->
name|ds_status0
argument_list|,
name|AR_SendTimestamp
argument_list|)
expr_stmt|;
name|ts
operator|->
name|ts_status
operator|=
literal|0
expr_stmt|;
if|if
condition|(
operator|(
name|ads
operator|->
name|ds_status0
operator|&
name|AR_FrmXmitOK
operator|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|ads
operator|->
name|ds_status0
operator|&
name|AR_ExcessiveRetries
condition|)
name|ts
operator|->
name|ts_status
operator||=
name|HAL_TXERR_XRETRY
expr_stmt|;
if|if
condition|(
name|ads
operator|->
name|ds_status0
operator|&
name|AR_Filtered
condition|)
name|ts
operator|->
name|ts_status
operator||=
name|HAL_TXERR_FILT
expr_stmt|;
if|if
condition|(
name|ads
operator|->
name|ds_status0
operator|&
name|AR_FIFOUnderrun
condition|)
name|ts
operator|->
name|ts_status
operator||=
name|HAL_TXERR_FIFO
expr_stmt|;
block|}
name|ts
operator|->
name|ts_rate
operator|=
name|MS
argument_list|(
name|ads
operator|->
name|ds_ctl0
argument_list|,
name|AR_XmitRate
argument_list|)
expr_stmt|;
name|ts
operator|->
name|ts_rssi
operator|=
name|MS
argument_list|(
name|ads
operator|->
name|ds_status1
argument_list|,
name|AR_AckSigStrength
argument_list|)
expr_stmt|;
name|ts
operator|->
name|ts_shortretry
operator|=
name|MS
argument_list|(
name|ads
operator|->
name|ds_status0
argument_list|,
name|AR_ShortRetryCnt
argument_list|)
expr_stmt|;
name|ts
operator|->
name|ts_longretry
operator|=
name|MS
argument_list|(
name|ads
operator|->
name|ds_status0
argument_list|,
name|AR_LongRetryCnt
argument_list|)
expr_stmt|;
name|ts
operator|->
name|ts_antenna
operator|=
literal|0
expr_stmt|;
comment|/* NB: don't know */
name|ts
operator|->
name|ts_finaltsi
operator|=
literal|0
expr_stmt|;
return|return
name|HAL_OK
return|;
block|}
end_function

begin_comment
comment|/*  * Determine which tx queues need interrupt servicing.  * STUB.  */
end_comment

begin_function
name|void
name|ar5210GetTxIntrQueue
parameter_list|(
name|struct
name|ath_hal
modifier|*
name|ah
parameter_list|,
name|uint32_t
modifier|*
name|txqs
parameter_list|)
block|{
return|return;
block|}
end_function

begin_comment
comment|/*  * Retrieve the rate table from the given TX completion descriptor  */
end_comment

begin_function
name|HAL_BOOL
name|ar5210GetTxCompletionRates
parameter_list|(
name|struct
name|ath_hal
modifier|*
name|ah
parameter_list|,
specifier|const
name|struct
name|ath_desc
modifier|*
name|ds0
parameter_list|,
name|int
modifier|*
name|rates
parameter_list|,
name|int
modifier|*
name|tries
parameter_list|)
block|{
return|return
name|AH_FALSE
return|;
block|}
end_function

begin_comment
comment|/*  * Set the TX descriptor link pointer  */
end_comment

begin_function
name|void
name|ar5210SetTxDescLink
parameter_list|(
name|struct
name|ath_hal
modifier|*
name|ah
parameter_list|,
name|void
modifier|*
name|ds
parameter_list|,
name|uint32_t
name|link
parameter_list|)
block|{
name|struct
name|ar5210_desc
modifier|*
name|ads
init|=
name|AR5210DESC
argument_list|(
name|ds
argument_list|)
decl_stmt|;
name|ads
operator|->
name|ds_link
operator|=
name|link
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * Get the TX descriptor link pointer  */
end_comment

begin_function
name|void
name|ar5210GetTxDescLink
parameter_list|(
name|struct
name|ath_hal
modifier|*
name|ah
parameter_list|,
name|void
modifier|*
name|ds
parameter_list|,
name|uint32_t
modifier|*
name|link
parameter_list|)
block|{
name|struct
name|ar5210_desc
modifier|*
name|ads
init|=
name|AR5210DESC
argument_list|(
name|ds
argument_list|)
decl_stmt|;
operator|*
name|link
operator|=
name|ads
operator|->
name|ds_link
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * Get a pointer to the TX descriptor link pointer  */
end_comment

begin_function
name|void
name|ar5210GetTxDescLinkPtr
parameter_list|(
name|struct
name|ath_hal
modifier|*
name|ah
parameter_list|,
name|void
modifier|*
name|ds
parameter_list|,
name|uint32_t
modifier|*
modifier|*
name|linkptr
parameter_list|)
block|{
name|struct
name|ar5210_desc
modifier|*
name|ads
init|=
name|AR5210DESC
argument_list|(
name|ds
argument_list|)
decl_stmt|;
operator|*
name|linkptr
operator|=
operator|&
name|ads
operator|->
name|ds_link
expr_stmt|;
block|}
end_function

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Copyright (c) 2008-2010 Atheros Communications Inc.  * Copyright (c) 2011 Adrian Chadd, Xenion Pty Ltd.  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions  * are met:  * 1. Redistributions of source code must retain the above copyright  *    notice, this list of conditions and the following disclaimer.  * 2. Redistributions in binary form must reproduce the above copyright  *    notice, this list of conditions and the following disclaimer in the  *    documentation and/or other materials provided with the distribution.  *  * THIS SOFTWARE IS PROVIDED BY THE AUTHOR AND CONTRIBUTORS ``AS IS'' AND  * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE  * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE  * ARE DISCLAIMED.  IN NO EVENT SHALL THE AUTHOR OR CONTRIBUTORS BE LIABLE  * FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL  * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS  * OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)  * HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT  * LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY  * OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF  * SUCH DAMAGE.  *  * $FreeBSD$  */
end_comment

begin_include
include|#
directive|include
file|"opt_ah.h"
end_include

begin_include
include|#
directive|include
file|"ah.h"
end_include

begin_include
include|#
directive|include
file|"ah_internal.h"
end_include

begin_include
include|#
directive|include
file|"ah_eeprom_v4k.h"
end_include

begin_include
include|#
directive|include
file|"ar9002/ar9285.h"
end_include

begin_include
include|#
directive|include
file|"ar5416/ar5416reg.h"
end_include

begin_include
include|#
directive|include
file|"ar5416/ar5416phy.h"
end_include

begin_include
include|#
directive|include
file|"ar9002/ar9002phy.h"
end_include

begin_include
include|#
directive|include
file|"ar9002/ar9285phy.h"
end_include

begin_include
include|#
directive|include
file|"ar9002/ar9285an.h"
end_include

begin_include
include|#
directive|include
file|"ar9002/ar9285_cal.h"
end_include

begin_define
define|#
directive|define
name|AR9285_CLCAL_REDO_THRESH
value|1
end_define

begin_define
define|#
directive|define
name|MAX_PACAL_SKIPCOUNT
value|8
end_define

begin_define
define|#
directive|define
name|N
parameter_list|(
name|a
parameter_list|)
value|(sizeof (a) / sizeof (a[0]))
end_define

begin_function
specifier|static
name|void
name|ar9285_hw_pa_cal
parameter_list|(
name|struct
name|ath_hal
modifier|*
name|ah
parameter_list|,
name|HAL_BOOL
name|is_reset
parameter_list|)
block|{
name|uint32_t
name|regVal
decl_stmt|;
name|int
name|i
decl_stmt|,
name|offset
decl_stmt|,
name|offs_6_1
decl_stmt|,
name|offs_0
decl_stmt|;
name|uint32_t
name|ccomp_org
decl_stmt|,
name|reg_field
decl_stmt|;
name|uint32_t
name|regList
index|[]
index|[
literal|2
index|]
init|=
block|{
block|{
literal|0x786c
block|,
literal|0
block|}
block|,
block|{
literal|0x7854
block|,
literal|0
block|}
block|,
block|{
literal|0x7820
block|,
literal|0
block|}
block|,
block|{
literal|0x7824
block|,
literal|0
block|}
block|,
block|{
literal|0x7868
block|,
literal|0
block|}
block|,
block|{
literal|0x783c
block|,
literal|0
block|}
block|,
block|{
literal|0x7838
block|,
literal|0
block|}
block|, 	}
decl_stmt|;
comment|/* PA CAL is not needed for high power solution */
if|if
condition|(
name|ath_hal_eepromGet
argument_list|(
name|ah
argument_list|,
name|AR_EEP_TXGAIN_TYPE
argument_list|,
name|AH_NULL
argument_list|)
operator|==
name|AR5416_EEP_TXGAIN_HIGH_POWER
condition|)
return|return;
name|HALDEBUG
argument_list|(
name|ah
argument_list|,
name|HAL_DEBUG_PERCAL
argument_list|,
literal|"Running PA Calibration\n"
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|N
argument_list|(
name|regList
argument_list|)
condition|;
name|i
operator|++
control|)
name|regList
index|[
name|i
index|]
index|[
literal|1
index|]
operator|=
name|OS_REG_READ
argument_list|(
name|ah
argument_list|,
name|regList
index|[
name|i
index|]
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
name|regVal
operator|=
name|OS_REG_READ
argument_list|(
name|ah
argument_list|,
literal|0x7834
argument_list|)
expr_stmt|;
name|regVal
operator|&=
operator|(
operator|~
operator|(
literal|0x1
operator|)
operator|)
expr_stmt|;
name|OS_REG_WRITE
argument_list|(
name|ah
argument_list|,
literal|0x7834
argument_list|,
name|regVal
argument_list|)
expr_stmt|;
name|regVal
operator|=
name|OS_REG_READ
argument_list|(
name|ah
argument_list|,
literal|0x9808
argument_list|)
expr_stmt|;
name|regVal
operator||=
operator|(
literal|0x1
operator|<<
literal|27
operator|)
expr_stmt|;
name|OS_REG_WRITE
argument_list|(
name|ah
argument_list|,
literal|0x9808
argument_list|,
name|regVal
argument_list|)
expr_stmt|;
name|OS_REG_RMW_FIELD
argument_list|(
name|ah
argument_list|,
name|AR9285_AN_TOP3
argument_list|,
name|AR9285_AN_TOP3_PWDDAC
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|OS_REG_RMW_FIELD
argument_list|(
name|ah
argument_list|,
name|AR9285_AN_RXTXBB1
argument_list|,
name|AR9285_AN_RXTXBB1_PDRXTXBB1
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|OS_REG_RMW_FIELD
argument_list|(
name|ah
argument_list|,
name|AR9285_AN_RXTXBB1
argument_list|,
name|AR9285_AN_RXTXBB1_PDV2I
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|OS_REG_RMW_FIELD
argument_list|(
name|ah
argument_list|,
name|AR9285_AN_RXTXBB1
argument_list|,
name|AR9285_AN_RXTXBB1_PDDACIF
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|OS_REG_RMW_FIELD
argument_list|(
name|ah
argument_list|,
name|AR9285_AN_RF2G2
argument_list|,
name|AR9285_AN_RF2G2_OFFCAL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|OS_REG_RMW_FIELD
argument_list|(
name|ah
argument_list|,
name|AR9285_AN_RF2G7
argument_list|,
name|AR9285_AN_RF2G7_PWDDB
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|OS_REG_RMW_FIELD
argument_list|(
name|ah
argument_list|,
name|AR9285_AN_RF2G1
argument_list|,
name|AR9285_AN_RF2G1_ENPACAL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|OS_REG_RMW_FIELD
argument_list|(
name|ah
argument_list|,
name|AR9285_AN_RF2G1
argument_list|,
name|AR9285_AN_RF2G1_PDPADRV1
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|OS_REG_RMW_FIELD
argument_list|(
name|ah
argument_list|,
name|AR9285_AN_RF2G1
argument_list|,
name|AR9285_AN_RF2G1_PDPADRV2
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|OS_REG_RMW_FIELD
argument_list|(
name|ah
argument_list|,
name|AR9285_AN_RF2G1
argument_list|,
name|AR9285_AN_RF2G1_PDPAOUT
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|OS_REG_RMW_FIELD
argument_list|(
name|ah
argument_list|,
name|AR9285_AN_RF2G8
argument_list|,
name|AR9285_AN_RF2G8_PADRVGN2TAB0
argument_list|,
literal|7
argument_list|)
expr_stmt|;
name|OS_REG_RMW_FIELD
argument_list|(
name|ah
argument_list|,
name|AR9285_AN_RF2G7
argument_list|,
name|AR9285_AN_RF2G7_PADRVGN2TAB0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|ccomp_org
operator|=
name|MS
argument_list|(
name|OS_REG_READ
argument_list|(
name|ah
argument_list|,
name|AR9285_AN_RF2G6
argument_list|)
argument_list|,
name|AR9285_AN_RF2G6_CCOMP
argument_list|)
expr_stmt|;
name|OS_REG_RMW_FIELD
argument_list|(
name|ah
argument_list|,
name|AR9285_AN_RF2G6
argument_list|,
name|AR9285_AN_RF2G6_CCOMP
argument_list|,
literal|0xf
argument_list|)
expr_stmt|;
name|OS_REG_WRITE
argument_list|(
name|ah
argument_list|,
name|AR9285_AN_TOP2
argument_list|,
literal|0xca0358a0
argument_list|)
expr_stmt|;
name|OS_DELAY
argument_list|(
literal|30
argument_list|)
expr_stmt|;
name|OS_REG_RMW_FIELD
argument_list|(
name|ah
argument_list|,
name|AR9285_AN_RF2G6
argument_list|,
name|AR9285_AN_RF2G6_OFFS
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|OS_REG_RMW_FIELD
argument_list|(
name|ah
argument_list|,
name|AR9285_AN_RF2G3
argument_list|,
name|AR9285_AN_RF2G3_PDVCCOMP
argument_list|,
literal|0
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|6
init|;
name|i
operator|>
literal|0
condition|;
name|i
operator|--
control|)
block|{
name|regVal
operator|=
name|OS_REG_READ
argument_list|(
name|ah
argument_list|,
literal|0x7834
argument_list|)
expr_stmt|;
name|regVal
operator||=
operator|(
literal|1
operator|<<
operator|(
literal|19
operator|+
name|i
operator|)
operator|)
expr_stmt|;
name|OS_REG_WRITE
argument_list|(
name|ah
argument_list|,
literal|0x7834
argument_list|,
name|regVal
argument_list|)
expr_stmt|;
name|OS_DELAY
argument_list|(
literal|1
argument_list|)
expr_stmt|;
name|regVal
operator|=
name|OS_REG_READ
argument_list|(
name|ah
argument_list|,
literal|0x7834
argument_list|)
expr_stmt|;
name|regVal
operator|&=
operator|(
operator|~
operator|(
literal|0x1
operator|<<
operator|(
literal|19
operator|+
name|i
operator|)
operator|)
operator|)
expr_stmt|;
name|reg_field
operator|=
name|MS
argument_list|(
name|OS_REG_READ
argument_list|(
name|ah
argument_list|,
literal|0x7840
argument_list|)
argument_list|,
name|AR9285_AN_RXTXBB1_SPARE9
argument_list|)
expr_stmt|;
name|regVal
operator||=
operator|(
name|reg_field
operator|<<
operator|(
literal|19
operator|+
name|i
operator|)
operator|)
expr_stmt|;
name|OS_REG_WRITE
argument_list|(
name|ah
argument_list|,
literal|0x7834
argument_list|,
name|regVal
argument_list|)
expr_stmt|;
block|}
name|OS_REG_RMW_FIELD
argument_list|(
name|ah
argument_list|,
name|AR9285_AN_RF2G3
argument_list|,
name|AR9285_AN_RF2G3_PDVCCOMP
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|OS_DELAY
argument_list|(
literal|1
argument_list|)
expr_stmt|;
name|reg_field
operator|=
name|MS
argument_list|(
name|OS_REG_READ
argument_list|(
name|ah
argument_list|,
name|AR9285_AN_RF2G9
argument_list|)
argument_list|,
name|AR9285_AN_RXTXBB1_SPARE9
argument_list|)
expr_stmt|;
name|OS_REG_RMW_FIELD
argument_list|(
name|ah
argument_list|,
name|AR9285_AN_RF2G3
argument_list|,
name|AR9285_AN_RF2G3_PDVCCOMP
argument_list|,
name|reg_field
argument_list|)
expr_stmt|;
name|offs_6_1
operator|=
name|MS
argument_list|(
name|OS_REG_READ
argument_list|(
name|ah
argument_list|,
name|AR9285_AN_RF2G6
argument_list|)
argument_list|,
name|AR9285_AN_RF2G6_OFFS
argument_list|)
expr_stmt|;
name|offs_0
operator|=
name|MS
argument_list|(
name|OS_REG_READ
argument_list|(
name|ah
argument_list|,
name|AR9285_AN_RF2G3
argument_list|)
argument_list|,
name|AR9285_AN_RF2G3_PDVCCOMP
argument_list|)
expr_stmt|;
name|offset
operator|=
operator|(
name|offs_6_1
operator|<<
literal|1
operator|)
operator||
name|offs_0
expr_stmt|;
name|offset
operator|=
name|offset
operator|-
literal|0
expr_stmt|;
name|offs_6_1
operator|=
name|offset
operator|>>
literal|1
expr_stmt|;
name|offs_0
operator|=
name|offset
operator|&
literal|1
expr_stmt|;
if|if
condition|(
operator|(
operator|!
name|is_reset
operator|)
operator|&&
operator|(
name|AH9285
argument_list|(
name|ah
argument_list|)
operator|->
name|pacal_info
operator|.
name|prev_offset
operator|==
name|offset
operator|)
condition|)
block|{
if|if
condition|(
name|AH9285
argument_list|(
name|ah
argument_list|)
operator|->
name|pacal_info
operator|.
name|max_skipcount
operator|<
name|MAX_PACAL_SKIPCOUNT
condition|)
name|AH9285
argument_list|(
name|ah
argument_list|)
operator|->
name|pacal_info
operator|.
name|max_skipcount
operator|=
literal|2
operator|*
name|AH9285
argument_list|(
name|ah
argument_list|)
operator|->
name|pacal_info
operator|.
name|max_skipcount
expr_stmt|;
name|AH9285
argument_list|(
name|ah
argument_list|)
operator|->
name|pacal_info
operator|.
name|skipcount
operator|=
name|AH9285
argument_list|(
name|ah
argument_list|)
operator|->
name|pacal_info
operator|.
name|max_skipcount
expr_stmt|;
block|}
else|else
block|{
name|AH9285
argument_list|(
name|ah
argument_list|)
operator|->
name|pacal_info
operator|.
name|max_skipcount
operator|=
literal|1
expr_stmt|;
name|AH9285
argument_list|(
name|ah
argument_list|)
operator|->
name|pacal_info
operator|.
name|skipcount
operator|=
literal|0
expr_stmt|;
name|AH9285
argument_list|(
name|ah
argument_list|)
operator|->
name|pacal_info
operator|.
name|prev_offset
operator|=
name|offset
expr_stmt|;
block|}
name|OS_REG_RMW_FIELD
argument_list|(
name|ah
argument_list|,
name|AR9285_AN_RF2G6
argument_list|,
name|AR9285_AN_RF2G6_OFFS
argument_list|,
name|offs_6_1
argument_list|)
expr_stmt|;
name|OS_REG_RMW_FIELD
argument_list|(
name|ah
argument_list|,
name|AR9285_AN_RF2G3
argument_list|,
name|AR9285_AN_RF2G3_PDVCCOMP
argument_list|,
name|offs_0
argument_list|)
expr_stmt|;
name|regVal
operator|=
name|OS_REG_READ
argument_list|(
name|ah
argument_list|,
literal|0x7834
argument_list|)
expr_stmt|;
name|regVal
operator||=
literal|0x1
expr_stmt|;
name|OS_REG_WRITE
argument_list|(
name|ah
argument_list|,
literal|0x7834
argument_list|,
name|regVal
argument_list|)
expr_stmt|;
name|regVal
operator|=
name|OS_REG_READ
argument_list|(
name|ah
argument_list|,
literal|0x9808
argument_list|)
expr_stmt|;
name|regVal
operator|&=
operator|(
operator|~
operator|(
literal|0x1
operator|<<
literal|27
operator|)
operator|)
expr_stmt|;
name|OS_REG_WRITE
argument_list|(
name|ah
argument_list|,
literal|0x9808
argument_list|,
name|regVal
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|N
argument_list|(
name|regList
argument_list|)
condition|;
name|i
operator|++
control|)
name|OS_REG_WRITE
argument_list|(
name|ah
argument_list|,
name|regList
index|[
name|i
index|]
index|[
literal|0
index|]
argument_list|,
name|regList
index|[
name|i
index|]
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
name|OS_REG_RMW_FIELD
argument_list|(
name|ah
argument_list|,
name|AR9285_AN_RF2G6
argument_list|,
name|AR9285_AN_RF2G6_CCOMP
argument_list|,
name|ccomp_org
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|ar9002_hw_pa_cal
parameter_list|(
name|struct
name|ath_hal
modifier|*
name|ah
parameter_list|,
name|HAL_BOOL
name|is_reset
parameter_list|)
block|{
if|if
condition|(
name|AR_SREV_KITE_11_OR_LATER
argument_list|(
name|ah
argument_list|)
condition|)
block|{
if|if
condition|(
name|is_reset
operator|||
operator|!
name|AH9285
argument_list|(
name|ah
argument_list|)
operator|->
name|pacal_info
operator|.
name|skipcount
condition|)
name|ar9285_hw_pa_cal
argument_list|(
name|ah
argument_list|,
name|is_reset
argument_list|)
expr_stmt|;
else|else
name|AH9285
argument_list|(
name|ah
argument_list|)
operator|->
name|pacal_info
operator|.
name|skipcount
operator|--
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/* Carrier leakage Calibration fix */
end_comment

begin_function
specifier|static
name|HAL_BOOL
name|ar9285_hw_cl_cal
parameter_list|(
name|struct
name|ath_hal
modifier|*
name|ah
parameter_list|,
specifier|const
name|struct
name|ieee80211_channel
modifier|*
name|chan
parameter_list|)
block|{
name|OS_REG_SET_BIT
argument_list|(
name|ah
argument_list|,
name|AR_PHY_CL_CAL_CTL
argument_list|,
name|AR_PHY_CL_CAL_ENABLE
argument_list|)
expr_stmt|;
if|if
condition|(
name|IEEE80211_IS_CHAN_HT20
argument_list|(
name|chan
argument_list|)
condition|)
block|{
name|OS_REG_SET_BIT
argument_list|(
name|ah
argument_list|,
name|AR_PHY_CL_CAL_CTL
argument_list|,
name|AR_PHY_PARALLEL_CAL_ENABLE
argument_list|)
expr_stmt|;
name|OS_REG_SET_BIT
argument_list|(
name|ah
argument_list|,
name|AR_PHY_TURBO
argument_list|,
name|AR_PHY_FC_DYN2040_EN
argument_list|)
expr_stmt|;
name|OS_REG_CLR_BIT
argument_list|(
name|ah
argument_list|,
name|AR_PHY_AGC_CONTROL
argument_list|,
name|AR_PHY_AGC_CONTROL_FLTR_CAL
argument_list|)
expr_stmt|;
name|OS_REG_CLR_BIT
argument_list|(
name|ah
argument_list|,
name|AR_PHY_TPCRG1
argument_list|,
name|AR_PHY_TPCRG1_PD_CAL_ENABLE
argument_list|)
expr_stmt|;
name|OS_REG_SET_BIT
argument_list|(
name|ah
argument_list|,
name|AR_PHY_AGC_CONTROL
argument_list|,
name|AR_PHY_AGC_CONTROL_CAL
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|ath_hal_wait
argument_list|(
name|ah
argument_list|,
name|AR_PHY_AGC_CONTROL
argument_list|,
name|AR_PHY_AGC_CONTROL_CAL
argument_list|,
literal|0
argument_list|)
condition|)
block|{
name|HALDEBUG
argument_list|(
name|ah
argument_list|,
name|HAL_DEBUG_PERCAL
argument_list|,
literal|"offset calibration failed to complete in 1ms; noisy environment?\n"
argument_list|)
expr_stmt|;
return|return
name|AH_FALSE
return|;
block|}
name|OS_REG_CLR_BIT
argument_list|(
name|ah
argument_list|,
name|AR_PHY_TURBO
argument_list|,
name|AR_PHY_FC_DYN2040_EN
argument_list|)
expr_stmt|;
name|OS_REG_CLR_BIT
argument_list|(
name|ah
argument_list|,
name|AR_PHY_CL_CAL_CTL
argument_list|,
name|AR_PHY_PARALLEL_CAL_ENABLE
argument_list|)
expr_stmt|;
name|OS_REG_CLR_BIT
argument_list|(
name|ah
argument_list|,
name|AR_PHY_CL_CAL_CTL
argument_list|,
name|AR_PHY_CL_CAL_ENABLE
argument_list|)
expr_stmt|;
block|}
name|OS_REG_CLR_BIT
argument_list|(
name|ah
argument_list|,
name|AR_PHY_ADC_CTL
argument_list|,
name|AR_PHY_ADC_CTL_OFF_PWDADC
argument_list|)
expr_stmt|;
name|OS_REG_SET_BIT
argument_list|(
name|ah
argument_list|,
name|AR_PHY_AGC_CONTROL
argument_list|,
name|AR_PHY_AGC_CONTROL_FLTR_CAL
argument_list|)
expr_stmt|;
name|OS_REG_SET_BIT
argument_list|(
name|ah
argument_list|,
name|AR_PHY_TPCRG1
argument_list|,
name|AR_PHY_TPCRG1_PD_CAL_ENABLE
argument_list|)
expr_stmt|;
name|OS_REG_SET_BIT
argument_list|(
name|ah
argument_list|,
name|AR_PHY_AGC_CONTROL
argument_list|,
name|AR_PHY_AGC_CONTROL_CAL
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|ath_hal_wait
argument_list|(
name|ah
argument_list|,
name|AR_PHY_AGC_CONTROL
argument_list|,
name|AR_PHY_AGC_CONTROL_CAL
argument_list|,
literal|0
argument_list|)
condition|)
block|{
name|HALDEBUG
argument_list|(
name|ah
argument_list|,
name|HAL_DEBUG_PERCAL
argument_list|,
literal|"offset calibration failed to complete in 1ms; noisy environment?\n"
argument_list|)
expr_stmt|;
return|return
name|AH_FALSE
return|;
block|}
name|OS_REG_SET_BIT
argument_list|(
name|ah
argument_list|,
name|AR_PHY_ADC_CTL
argument_list|,
name|AR_PHY_ADC_CTL_OFF_PWDADC
argument_list|)
expr_stmt|;
name|OS_REG_CLR_BIT
argument_list|(
name|ah
argument_list|,
name|AR_PHY_CL_CAL_CTL
argument_list|,
name|AR_PHY_CL_CAL_ENABLE
argument_list|)
expr_stmt|;
name|OS_REG_CLR_BIT
argument_list|(
name|ah
argument_list|,
name|AR_PHY_AGC_CONTROL
argument_list|,
name|AR_PHY_AGC_CONTROL_FLTR_CAL
argument_list|)
expr_stmt|;
return|return
name|AH_TRUE
return|;
block|}
end_function

begin_function
specifier|static
name|HAL_BOOL
name|ar9285_hw_clc
parameter_list|(
name|struct
name|ath_hal
modifier|*
name|ah
parameter_list|,
specifier|const
name|struct
name|ieee80211_channel
modifier|*
name|chan
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
name|uint32_t
name|txgain_max
decl_stmt|;
name|uint32_t
name|clc_gain
decl_stmt|,
name|gain_mask
init|=
literal|0
decl_stmt|,
name|clc_num
init|=
literal|0
decl_stmt|;
name|uint32_t
name|reg_clc_I0
decl_stmt|,
name|reg_clc_Q0
decl_stmt|;
name|uint32_t
name|i0_num
init|=
literal|0
decl_stmt|;
name|uint32_t
name|q0_num
init|=
literal|0
decl_stmt|;
name|uint32_t
name|total_num
init|=
literal|0
decl_stmt|;
name|uint32_t
name|reg_rf2g5_org
decl_stmt|;
name|HAL_BOOL
name|retv
init|=
name|AH_TRUE
decl_stmt|;
if|if
condition|(
operator|!
operator|(
name|ar9285_hw_cl_cal
argument_list|(
name|ah
argument_list|,
name|chan
argument_list|)
operator|)
condition|)
return|return
name|AH_FALSE
return|;
name|txgain_max
operator|=
name|MS
argument_list|(
name|OS_REG_READ
argument_list|(
name|ah
argument_list|,
name|AR_PHY_TX_PWRCTRL7
argument_list|)
argument_list|,
name|AR_PHY_TX_PWRCTRL_TX_GAIN_TAB_MAX
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
operator|(
name|txgain_max
operator|+
literal|1
operator|)
condition|;
name|i
operator|++
control|)
block|{
name|clc_gain
operator|=
operator|(
name|OS_REG_READ
argument_list|(
name|ah
argument_list|,
operator|(
name|AR_PHY_TX_GAIN_TBL1
operator|+
operator|(
name|i
operator|<<
literal|2
operator|)
operator|)
argument_list|)
operator|&
name|AR_PHY_TX_GAIN_CLC
operator|)
operator|>>
name|AR_PHY_TX_GAIN_CLC_S
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|gain_mask
operator|&
operator|(
literal|1
operator|<<
name|clc_gain
operator|)
operator|)
condition|)
block|{
name|gain_mask
operator||=
operator|(
literal|1
operator|<<
name|clc_gain
operator|)
expr_stmt|;
name|clc_num
operator|++
expr_stmt|;
block|}
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|clc_num
condition|;
name|i
operator|++
control|)
block|{
name|reg_clc_I0
operator|=
operator|(
name|OS_REG_READ
argument_list|(
name|ah
argument_list|,
operator|(
name|AR_PHY_CLC_TBL1
operator|+
operator|(
name|i
operator|<<
literal|2
operator|)
operator|)
argument_list|)
operator|&
name|AR_PHY_CLC_I0
operator|)
operator|>>
name|AR_PHY_CLC_I0_S
expr_stmt|;
name|reg_clc_Q0
operator|=
operator|(
name|OS_REG_READ
argument_list|(
name|ah
argument_list|,
operator|(
name|AR_PHY_CLC_TBL1
operator|+
operator|(
name|i
operator|<<
literal|2
operator|)
operator|)
argument_list|)
operator|&
name|AR_PHY_CLC_Q0
operator|)
operator|>>
name|AR_PHY_CLC_Q0_S
expr_stmt|;
if|if
condition|(
name|reg_clc_I0
operator|==
literal|0
condition|)
name|i0_num
operator|++
expr_stmt|;
if|if
condition|(
name|reg_clc_Q0
operator|==
literal|0
condition|)
name|q0_num
operator|++
expr_stmt|;
block|}
name|total_num
operator|=
name|i0_num
operator|+
name|q0_num
expr_stmt|;
if|if
condition|(
name|total_num
operator|>
name|AR9285_CLCAL_REDO_THRESH
condition|)
block|{
name|reg_rf2g5_org
operator|=
name|OS_REG_READ
argument_list|(
name|ah
argument_list|,
name|AR9285_RF2G5
argument_list|)
expr_stmt|;
if|if
condition|(
name|AR_SREV_9285E_20
argument_list|(
name|ah
argument_list|)
condition|)
block|{
name|OS_REG_WRITE
argument_list|(
name|ah
argument_list|,
name|AR9285_RF2G5
argument_list|,
operator|(
name|reg_rf2g5_org
operator|&
name|AR9285_RF2G5_IC50TX
operator|)
operator||
name|AR9285_RF2G5_IC50TX_XE_SET
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|OS_REG_WRITE
argument_list|(
name|ah
argument_list|,
name|AR9285_RF2G5
argument_list|,
operator|(
name|reg_rf2g5_org
operator|&
name|AR9285_RF2G5_IC50TX
operator|)
operator||
name|AR9285_RF2G5_IC50TX_SET
argument_list|)
expr_stmt|;
block|}
name|retv
operator|=
name|ar9285_hw_cl_cal
argument_list|(
name|ah
argument_list|,
name|chan
argument_list|)
expr_stmt|;
name|OS_REG_WRITE
argument_list|(
name|ah
argument_list|,
name|AR9285_RF2G5
argument_list|,
name|reg_rf2g5_org
argument_list|)
expr_stmt|;
block|}
return|return
name|retv
return|;
block|}
end_function

begin_function
name|HAL_BOOL
name|ar9285InitCalHardware
parameter_list|(
name|struct
name|ath_hal
modifier|*
name|ah
parameter_list|,
specifier|const
name|struct
name|ieee80211_channel
modifier|*
name|chan
parameter_list|)
block|{
if|if
condition|(
name|AR_SREV_KITE
argument_list|(
name|ah
argument_list|)
operator|&&
name|AR_SREV_KITE_10_OR_LATER
argument_list|(
name|ah
argument_list|)
operator|&&
operator|(
operator|!
name|ar9285_hw_clc
argument_list|(
name|ah
argument_list|,
name|chan
argument_list|)
operator|)
condition|)
return|return
name|AH_FALSE
return|;
return|return
name|AH_TRUE
return|;
block|}
end_function

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Copyright (c) 2002-2009 Sam Leffler, Errno Consulting  * Copyright (c) 2002-2006 Atheros Communications, Inc.  *  * Permission to use, copy, modify, and/or distribute this software for any  * purpose with or without fee is hereby granted, provided that the above  * copyright notice and this permission notice appear in all copies.  *  * THE SOFTWARE IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL WARRANTIES  * WITH REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF  * MERCHANTABILITY AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR  * ANY SPECIAL, DIRECT, INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES  * WHATSOEVER RESULTING FROM LOSS OF USE, DATA OR PROFITS, WHETHER IN AN  * ACTION OF CONTRACT, NEGLIGENCE OR OTHER TORTIOUS ACTION, ARISING OUT OF  * OR IN CONNECTION WITH THE USE OR PERFORMANCE OF THIS SOFTWARE.  *  * $FreeBSD$  */
end_comment

begin_include
include|#
directive|include
file|"opt_ah.h"
end_include

begin_include
include|#
directive|include
file|"ah.h"
end_include

begin_include
include|#
directive|include
file|"ah_internal.h"
end_include

begin_include
include|#
directive|include
file|"ah_devid.h"
end_include

begin_include
include|#
directive|include
file|"ar5211/ar5211.h"
end_include

begin_include
include|#
directive|include
file|"ar5211/ar5211reg.h"
end_include

begin_include
include|#
directive|include
file|"ar5211/ar5211phy.h"
end_include

begin_include
include|#
directive|include
file|"ah_eeprom_v3.h"
end_include

begin_function_decl
specifier|static
name|HAL_BOOL
name|ar5211GetChannelEdges
parameter_list|(
name|struct
name|ath_hal
modifier|*
name|ah
parameter_list|,
name|uint16_t
name|flags
parameter_list|,
name|uint16_t
modifier|*
name|low
parameter_list|,
name|uint16_t
modifier|*
name|high
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|HAL_BOOL
name|ar5211GetChipPowerLimits
parameter_list|(
name|struct
name|ath_hal
modifier|*
name|ah
parameter_list|,
name|struct
name|ieee80211_channel
modifier|*
name|chan
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|ar5211ConfigPCIE
parameter_list|(
name|struct
name|ath_hal
modifier|*
name|ah
parameter_list|,
name|HAL_BOOL
name|restore
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|ar5211DisablePCIE
parameter_list|(
name|struct
name|ath_hal
modifier|*
name|ah
parameter_list|)
function_decl|;
end_function_decl

begin_decl_stmt
specifier|static
specifier|const
name|struct
name|ath_hal_private
name|ar5211hal
init|=
block|{
block|{
operator|.
name|ah_magic
operator|=
name|AR5211_MAGIC
block|,
operator|.
name|ah_getRateTable
operator|=
name|ar5211GetRateTable
block|,
operator|.
name|ah_detach
operator|=
name|ar5211Detach
block|,
comment|/* Reset Functions */
operator|.
name|ah_reset
operator|=
name|ar5211Reset
block|,
operator|.
name|ah_phyDisable
operator|=
name|ar5211PhyDisable
block|,
operator|.
name|ah_disable
operator|=
name|ar5211Disable
block|,
operator|.
name|ah_configPCIE
operator|=
name|ar5211ConfigPCIE
block|,
operator|.
name|ah_disablePCIE
operator|=
name|ar5211DisablePCIE
block|,
operator|.
name|ah_setPCUConfig
operator|=
name|ar5211SetPCUConfig
block|,
operator|.
name|ah_perCalibration
operator|=
name|ar5211PerCalibration
block|,
operator|.
name|ah_perCalibrationN
operator|=
name|ar5211PerCalibrationN
block|,
operator|.
name|ah_resetCalValid
operator|=
name|ar5211ResetCalValid
block|,
operator|.
name|ah_setTxPowerLimit
operator|=
name|ar5211SetTxPowerLimit
block|,
operator|.
name|ah_getChanNoise
operator|=
name|ath_hal_getChanNoise
block|,
comment|/* Transmit functions */
operator|.
name|ah_updateTxTrigLevel
operator|=
name|ar5211UpdateTxTrigLevel
block|,
operator|.
name|ah_setupTxQueue
operator|=
name|ar5211SetupTxQueue
block|,
operator|.
name|ah_setTxQueueProps
operator|=
name|ar5211SetTxQueueProps
block|,
operator|.
name|ah_getTxQueueProps
operator|=
name|ar5211GetTxQueueProps
block|,
operator|.
name|ah_releaseTxQueue
operator|=
name|ar5211ReleaseTxQueue
block|,
operator|.
name|ah_resetTxQueue
operator|=
name|ar5211ResetTxQueue
block|,
operator|.
name|ah_getTxDP
operator|=
name|ar5211GetTxDP
block|,
operator|.
name|ah_setTxDP
operator|=
name|ar5211SetTxDP
block|,
operator|.
name|ah_numTxPending
operator|=
name|ar5211NumTxPending
block|,
operator|.
name|ah_startTxDma
operator|=
name|ar5211StartTxDma
block|,
operator|.
name|ah_stopTxDma
operator|=
name|ar5211StopTxDma
block|,
operator|.
name|ah_setupTxDesc
operator|=
name|ar5211SetupTxDesc
block|,
operator|.
name|ah_setupXTxDesc
operator|=
name|ar5211SetupXTxDesc
block|,
operator|.
name|ah_fillTxDesc
operator|=
name|ar5211FillTxDesc
block|,
operator|.
name|ah_procTxDesc
operator|=
name|ar5211ProcTxDesc
block|,
operator|.
name|ah_getTxIntrQueue
operator|=
name|ar5211GetTxIntrQueue
block|,
operator|.
name|ah_reqTxIntrDesc
operator|=
name|ar5211IntrReqTxDesc
block|,
operator|.
name|ah_getTxCompletionRates
operator|=
name|ar5211GetTxCompletionRates
block|,
comment|/* RX Functions */
operator|.
name|ah_getRxDP
operator|=
name|ar5211GetRxDP
block|,
operator|.
name|ah_setRxDP
operator|=
name|ar5211SetRxDP
block|,
operator|.
name|ah_enableReceive
operator|=
name|ar5211EnableReceive
block|,
operator|.
name|ah_stopDmaReceive
operator|=
name|ar5211StopDmaReceive
block|,
operator|.
name|ah_startPcuReceive
operator|=
name|ar5211StartPcuReceive
block|,
operator|.
name|ah_stopPcuReceive
operator|=
name|ar5211StopPcuReceive
block|,
operator|.
name|ah_setMulticastFilter
operator|=
name|ar5211SetMulticastFilter
block|,
operator|.
name|ah_setMulticastFilterIndex
operator|=
name|ar5211SetMulticastFilterIndex
block|,
operator|.
name|ah_clrMulticastFilterIndex
operator|=
name|ar5211ClrMulticastFilterIndex
block|,
operator|.
name|ah_getRxFilter
operator|=
name|ar5211GetRxFilter
block|,
operator|.
name|ah_setRxFilter
operator|=
name|ar5211SetRxFilter
block|,
operator|.
name|ah_setupRxDesc
operator|=
name|ar5211SetupRxDesc
block|,
operator|.
name|ah_procRxDesc
operator|=
name|ar5211ProcRxDesc
block|,
operator|.
name|ah_rxMonitor
operator|=
name|ar5211RxMonitor
block|,
operator|.
name|ah_aniPoll
operator|=
name|ar5211AniPoll
block|,
operator|.
name|ah_procMibEvent
operator|=
name|ar5211MibEvent
block|,
comment|/* Misc Functions */
operator|.
name|ah_getCapability
operator|=
name|ar5211GetCapability
block|,
operator|.
name|ah_setCapability
operator|=
name|ar5211SetCapability
block|,
operator|.
name|ah_getDiagState
operator|=
name|ar5211GetDiagState
block|,
operator|.
name|ah_getMacAddress
operator|=
name|ar5211GetMacAddress
block|,
operator|.
name|ah_setMacAddress
operator|=
name|ar5211SetMacAddress
block|,
operator|.
name|ah_getBssIdMask
operator|=
name|ar5211GetBssIdMask
block|,
operator|.
name|ah_setBssIdMask
operator|=
name|ar5211SetBssIdMask
block|,
operator|.
name|ah_setRegulatoryDomain
operator|=
name|ar5211SetRegulatoryDomain
block|,
operator|.
name|ah_setLedState
operator|=
name|ar5211SetLedState
block|,
operator|.
name|ah_writeAssocid
operator|=
name|ar5211WriteAssocid
block|,
operator|.
name|ah_gpioCfgInput
operator|=
name|ar5211GpioCfgInput
block|,
operator|.
name|ah_gpioCfgOutput
operator|=
name|ar5211GpioCfgOutput
block|,
operator|.
name|ah_gpioGet
operator|=
name|ar5211GpioGet
block|,
operator|.
name|ah_gpioSet
operator|=
name|ar5211GpioSet
block|,
operator|.
name|ah_gpioSetIntr
operator|=
name|ar5211GpioSetIntr
block|,
operator|.
name|ah_getTsf32
operator|=
name|ar5211GetTsf32
block|,
operator|.
name|ah_getTsf64
operator|=
name|ar5211GetTsf64
block|,
operator|.
name|ah_resetTsf
operator|=
name|ar5211ResetTsf
block|,
operator|.
name|ah_detectCardPresent
operator|=
name|ar5211DetectCardPresent
block|,
operator|.
name|ah_updateMibCounters
operator|=
name|ar5211UpdateMibCounters
block|,
operator|.
name|ah_getRfGain
operator|=
name|ar5211GetRfgain
block|,
operator|.
name|ah_getDefAntenna
operator|=
name|ar5211GetDefAntenna
block|,
operator|.
name|ah_setDefAntenna
operator|=
name|ar5211SetDefAntenna
block|,
operator|.
name|ah_getAntennaSwitch
operator|=
name|ar5211GetAntennaSwitch
block|,
operator|.
name|ah_setAntennaSwitch
operator|=
name|ar5211SetAntennaSwitch
block|,
operator|.
name|ah_setSifsTime
operator|=
name|ar5211SetSifsTime
block|,
operator|.
name|ah_getSifsTime
operator|=
name|ar5211GetSifsTime
block|,
operator|.
name|ah_setSlotTime
operator|=
name|ar5211SetSlotTime
block|,
operator|.
name|ah_getSlotTime
operator|=
name|ar5211GetSlotTime
block|,
operator|.
name|ah_setAckTimeout
operator|=
name|ar5211SetAckTimeout
block|,
operator|.
name|ah_getAckTimeout
operator|=
name|ar5211GetAckTimeout
block|,
operator|.
name|ah_setAckCTSRate
operator|=
name|ar5211SetAckCTSRate
block|,
operator|.
name|ah_getAckCTSRate
operator|=
name|ar5211GetAckCTSRate
block|,
operator|.
name|ah_setCTSTimeout
operator|=
name|ar5211SetCTSTimeout
block|,
operator|.
name|ah_getCTSTimeout
operator|=
name|ar5211GetCTSTimeout
block|,
operator|.
name|ah_setDecompMask
operator|=
name|ar5211SetDecompMask
block|,
operator|.
name|ah_setCoverageClass
operator|=
name|ar5211SetCoverageClass
block|,
comment|/* Key Cache Functions */
operator|.
name|ah_getKeyCacheSize
operator|=
name|ar5211GetKeyCacheSize
block|,
operator|.
name|ah_resetKeyCacheEntry
operator|=
name|ar5211ResetKeyCacheEntry
block|,
operator|.
name|ah_isKeyCacheEntryValid
operator|=
name|ar5211IsKeyCacheEntryValid
block|,
operator|.
name|ah_setKeyCacheEntry
operator|=
name|ar5211SetKeyCacheEntry
block|,
operator|.
name|ah_setKeyCacheEntryMac
operator|=
name|ar5211SetKeyCacheEntryMac
block|,
comment|/* Power Management Functions */
operator|.
name|ah_setPowerMode
operator|=
name|ar5211SetPowerMode
block|,
operator|.
name|ah_getPowerMode
operator|=
name|ar5211GetPowerMode
block|,
comment|/* Beacon Functions */
operator|.
name|ah_setBeaconTimers
operator|=
name|ar5211SetBeaconTimers
block|,
operator|.
name|ah_beaconInit
operator|=
name|ar5211BeaconInit
block|,
operator|.
name|ah_setStationBeaconTimers
operator|=
name|ar5211SetStaBeaconTimers
block|,
operator|.
name|ah_resetStationBeaconTimers
operator|=
name|ar5211ResetStaBeaconTimers
block|,
operator|.
name|ah_getNextTBTT
operator|=
name|ar5211GetNextTBTT
block|,
comment|/* Interrupt Functions */
operator|.
name|ah_isInterruptPending
operator|=
name|ar5211IsInterruptPending
block|,
operator|.
name|ah_getPendingInterrupts
operator|=
name|ar5211GetPendingInterrupts
block|,
operator|.
name|ah_getInterrupts
operator|=
name|ar5211GetInterrupts
block|,
operator|.
name|ah_setInterrupts
operator|=
name|ar5211SetInterrupts
block|}
block|,
operator|.
name|ah_getChannelEdges
operator|=
name|ar5211GetChannelEdges
block|,
operator|.
name|ah_getWirelessModes
operator|=
name|ar5211GetWirelessModes
block|,
operator|.
name|ah_eepromRead
operator|=
name|ar5211EepromRead
block|,
ifdef|#
directive|ifdef
name|AH_SUPPORT_WRITE_EEPROM
operator|.
name|ah_eepromWrite
operator|=
name|ar5211EepromWrite
block|,
endif|#
directive|endif
operator|.
name|ah_getChipPowerLimits
operator|=
name|ar5211GetChipPowerLimits
block|, }
decl_stmt|;
end_decl_stmt

begin_function_decl
specifier|static
name|HAL_BOOL
name|ar5211ChipTest
parameter_list|(
name|struct
name|ath_hal
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|HAL_BOOL
name|ar5211FillCapabilityInfo
parameter_list|(
name|struct
name|ath_hal
modifier|*
name|ah
parameter_list|)
function_decl|;
end_function_decl

begin_comment
comment|/*  * Return the revsion id for the radio chip.  This  * fetched via the PHY.  */
end_comment

begin_function
specifier|static
name|uint32_t
name|ar5211GetRadioRev
parameter_list|(
name|struct
name|ath_hal
modifier|*
name|ah
parameter_list|)
block|{
name|uint32_t
name|val
decl_stmt|;
name|int
name|i
decl_stmt|;
name|OS_REG_WRITE
argument_list|(
name|ah
argument_list|,
operator|(
name|AR_PHY_BASE
operator|+
operator|(
literal|0x34
operator|<<
literal|2
operator|)
operator|)
argument_list|,
literal|0x00001c16
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|8
condition|;
name|i
operator|++
control|)
name|OS_REG_WRITE
argument_list|(
name|ah
argument_list|,
operator|(
name|AR_PHY_BASE
operator|+
operator|(
literal|0x20
operator|<<
literal|2
operator|)
operator|)
argument_list|,
literal|0x00010000
argument_list|)
expr_stmt|;
name|val
operator|=
operator|(
name|OS_REG_READ
argument_list|(
name|ah
argument_list|,
name|AR_PHY_BASE
operator|+
operator|(
literal|256
operator|<<
literal|2
operator|)
argument_list|)
operator|>>
literal|24
operator|)
operator|&
literal|0xff
expr_stmt|;
name|val
operator|=
operator|(
operator|(
name|val
operator|&
literal|0xf0
operator|)
operator|>>
literal|4
operator|)
operator||
operator|(
operator|(
name|val
operator|&
literal|0x0f
operator|)
operator|<<
literal|4
operator|)
expr_stmt|;
return|return
name|ath_hal_reverseBits
argument_list|(
name|val
argument_list|,
literal|8
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/*  * Attach for an AR5211 part.  */
end_comment

begin_function
specifier|static
name|struct
name|ath_hal
modifier|*
name|ar5211Attach
parameter_list|(
name|uint16_t
name|devid
parameter_list|,
name|HAL_SOFTC
name|sc
parameter_list|,
name|HAL_BUS_TAG
name|st
parameter_list|,
name|HAL_BUS_HANDLE
name|sh
parameter_list|,
name|uint16_t
modifier|*
name|eepromdata
parameter_list|,
name|HAL_STATUS
modifier|*
name|status
parameter_list|)
block|{
define|#
directive|define
name|N
parameter_list|(
name|a
parameter_list|)
value|(sizeof(a)/sizeof(a[0]))
name|struct
name|ath_hal_5211
modifier|*
name|ahp
decl_stmt|;
name|struct
name|ath_hal
modifier|*
name|ah
decl_stmt|;
name|uint32_t
name|val
decl_stmt|;
name|uint16_t
name|eeval
decl_stmt|;
name|HAL_STATUS
name|ecode
decl_stmt|;
name|HALDEBUG
argument_list|(
name|AH_NULL
argument_list|,
name|HAL_DEBUG_ATTACH
argument_list|,
literal|"%s: sc %p st %p sh %p\n"
argument_list|,
name|__func__
argument_list|,
name|sc
argument_list|,
operator|(
name|void
operator|*
operator|)
name|st
argument_list|,
operator|(
name|void
operator|*
operator|)
name|sh
argument_list|)
expr_stmt|;
comment|/* NB: memory is returned zero'd */
name|ahp
operator|=
name|ath_hal_malloc
argument_list|(
sizeof|sizeof
argument_list|(
expr|struct
name|ath_hal_5211
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|ahp
operator|==
name|AH_NULL
condition|)
block|{
name|HALDEBUG
argument_list|(
name|AH_NULL
argument_list|,
name|HAL_DEBUG_ANY
argument_list|,
literal|"%s: cannot allocate memory for state block\n"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
name|ecode
operator|=
name|HAL_ENOMEM
expr_stmt|;
goto|goto
name|bad
goto|;
block|}
name|ah
operator|=
operator|&
name|ahp
operator|->
name|ah_priv
operator|.
name|h
expr_stmt|;
comment|/* set initial values */
name|OS_MEMCPY
argument_list|(
operator|&
name|ahp
operator|->
name|ah_priv
argument_list|,
operator|&
name|ar5211hal
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|ath_hal_private
argument_list|)
argument_list|)
expr_stmt|;
name|ah
operator|->
name|ah_sc
operator|=
name|sc
expr_stmt|;
name|ah
operator|->
name|ah_st
operator|=
name|st
expr_stmt|;
name|ah
operator|->
name|ah_sh
operator|=
name|sh
expr_stmt|;
name|ah
operator|->
name|ah_devid
operator|=
name|devid
expr_stmt|;
comment|/* NB: for AH_DEBUG_ALQ */
name|AH_PRIVATE
argument_list|(
name|ah
argument_list|)
operator|->
name|ah_devid
operator|=
name|devid
expr_stmt|;
name|AH_PRIVATE
argument_list|(
name|ah
argument_list|)
operator|->
name|ah_subvendorid
operator|=
literal|0
expr_stmt|;
comment|/* XXX */
name|AH_PRIVATE
argument_list|(
name|ah
argument_list|)
operator|->
name|ah_powerLimit
operator|=
name|MAX_RATE_POWER
expr_stmt|;
name|AH_PRIVATE
argument_list|(
name|ah
argument_list|)
operator|->
name|ah_tpScale
operator|=
name|HAL_TP_SCALE_MAX
expr_stmt|;
comment|/* no scaling */
name|ahp
operator|->
name|ah_diversityControl
operator|=
name|HAL_ANT_VARIABLE
expr_stmt|;
name|ahp
operator|->
name|ah_staId1Defaults
operator|=
literal|0
expr_stmt|;
name|ahp
operator|->
name|ah_rssiThr
operator|=
name|INIT_RSSI_THR
expr_stmt|;
name|ahp
operator|->
name|ah_sifstime
operator|=
operator|(
name|u_int
operator|)
operator|-
literal|1
expr_stmt|;
name|ahp
operator|->
name|ah_slottime
operator|=
operator|(
name|u_int
operator|)
operator|-
literal|1
expr_stmt|;
name|ahp
operator|->
name|ah_acktimeout
operator|=
operator|(
name|u_int
operator|)
operator|-
literal|1
expr_stmt|;
name|ahp
operator|->
name|ah_ctstimeout
operator|=
operator|(
name|u_int
operator|)
operator|-
literal|1
expr_stmt|;
if|if
condition|(
operator|!
name|ar5211ChipReset
argument_list|(
name|ah
argument_list|,
name|AH_NULL
argument_list|)
condition|)
block|{
comment|/* reset chip */
name|HALDEBUG
argument_list|(
name|ah
argument_list|,
name|HAL_DEBUG_ANY
argument_list|,
literal|"%s: chip reset failed\n"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
name|ecode
operator|=
name|HAL_EIO
expr_stmt|;
goto|goto
name|bad
goto|;
block|}
if|if
condition|(
name|AH_PRIVATE
argument_list|(
name|ah
argument_list|)
operator|->
name|ah_devid
operator|==
name|AR5211_FPGA11B
condition|)
block|{
comment|/* set it back to OFDM mode to be able to read analog rev id */
name|OS_REG_WRITE
argument_list|(
name|ah
argument_list|,
name|AR5211_PHY_MODE
argument_list|,
name|AR5211_PHY_MODE_OFDM
argument_list|)
expr_stmt|;
name|OS_REG_WRITE
argument_list|(
name|ah
argument_list|,
name|AR_PHY_PLL_CTL
argument_list|,
name|AR_PHY_PLL_CTL_44
argument_list|)
expr_stmt|;
name|OS_DELAY
argument_list|(
literal|1000
argument_list|)
expr_stmt|;
block|}
comment|/* Read Revisions from Chips */
name|val
operator|=
name|OS_REG_READ
argument_list|(
name|ah
argument_list|,
name|AR_SREV
argument_list|)
operator|&
name|AR_SREV_ID_M
expr_stmt|;
name|AH_PRIVATE
argument_list|(
name|ah
argument_list|)
operator|->
name|ah_macVersion
operator|=
name|val
operator|>>
name|AR_SREV_ID_S
expr_stmt|;
name|AH_PRIVATE
argument_list|(
name|ah
argument_list|)
operator|->
name|ah_macRev
operator|=
name|val
operator|&
name|AR_SREV_REVISION_M
expr_stmt|;
if|if
condition|(
name|AH_PRIVATE
argument_list|(
name|ah
argument_list|)
operator|->
name|ah_macVersion
operator|<
name|AR_SREV_VERSION_MAUI_2
operator|||
name|AH_PRIVATE
argument_list|(
name|ah
argument_list|)
operator|->
name|ah_macVersion
operator|>
name|AR_SREV_VERSION_OAHU
condition|)
block|{
name|HALDEBUG
argument_list|(
name|ah
argument_list|,
name|HAL_DEBUG_ANY
argument_list|,
literal|"%s: Mac Chip Rev 0x%x is not supported by this driver\n"
argument_list|,
name|__func__
argument_list|,
name|AH_PRIVATE
argument_list|(
name|ah
argument_list|)
operator|->
name|ah_macVersion
argument_list|)
expr_stmt|;
name|ecode
operator|=
name|HAL_ENOTSUPP
expr_stmt|;
goto|goto
name|bad
goto|;
block|}
name|AH_PRIVATE
argument_list|(
name|ah
argument_list|)
operator|->
name|ah_phyRev
operator|=
name|OS_REG_READ
argument_list|(
name|ah
argument_list|,
name|AR_PHY_CHIP_ID
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|ar5211ChipTest
argument_list|(
name|ah
argument_list|)
condition|)
block|{
name|HALDEBUG
argument_list|(
name|ah
argument_list|,
name|HAL_DEBUG_ANY
argument_list|,
literal|"%s: hardware self-test failed\n"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
name|ecode
operator|=
name|HAL_ESELFTEST
expr_stmt|;
goto|goto
name|bad
goto|;
block|}
comment|/* Set correct Baseband to analog shift setting to access analog chips. */
if|if
condition|(
name|AH_PRIVATE
argument_list|(
name|ah
argument_list|)
operator|->
name|ah_macVersion
operator|>=
name|AR_SREV_VERSION_OAHU
condition|)
block|{
name|OS_REG_WRITE
argument_list|(
name|ah
argument_list|,
name|AR_PHY_BASE
argument_list|,
literal|0x00000007
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|OS_REG_WRITE
argument_list|(
name|ah
argument_list|,
name|AR_PHY_BASE
argument_list|,
literal|0x00000047
argument_list|)
expr_stmt|;
block|}
name|OS_DELAY
argument_list|(
literal|2000
argument_list|)
expr_stmt|;
comment|/* Read Radio Chip Rev Extract */
name|AH_PRIVATE
argument_list|(
name|ah
argument_list|)
operator|->
name|ah_analog5GhzRev
operator|=
name|ar5211GetRadioRev
argument_list|(
name|ah
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|AH_PRIVATE
argument_list|(
name|ah
argument_list|)
operator|->
name|ah_analog5GhzRev
operator|&
literal|0xf0
operator|)
operator|!=
name|RAD5_SREV_MAJOR
condition|)
block|{
name|HALDEBUG
argument_list|(
name|ah
argument_list|,
name|HAL_DEBUG_ANY
argument_list|,
literal|"%s: 5G Radio Chip Rev 0x%02X is not supported by this "
literal|"driver\n"
argument_list|,
name|__func__
argument_list|,
name|AH_PRIVATE
argument_list|(
name|ah
argument_list|)
operator|->
name|ah_analog5GhzRev
argument_list|)
expr_stmt|;
name|ecode
operator|=
name|HAL_ENOTSUPP
expr_stmt|;
goto|goto
name|bad
goto|;
block|}
name|val
operator|=
operator|(
name|OS_REG_READ
argument_list|(
name|ah
argument_list|,
name|AR_PCICFG
argument_list|)
operator|&
name|AR_PCICFG_EEPROM_SIZE_M
operator|)
operator|>>
name|AR_PCICFG_EEPROM_SIZE_S
expr_stmt|;
if|if
condition|(
name|val
operator|!=
name|AR_PCICFG_EEPROM_SIZE_16K
condition|)
block|{
name|HALDEBUG
argument_list|(
name|ah
argument_list|,
name|HAL_DEBUG_ANY
argument_list|,
literal|"%s: unsupported EEPROM size "
literal|"%u (0x%x) found\n"
argument_list|,
name|__func__
argument_list|,
name|val
argument_list|,
name|val
argument_list|)
expr_stmt|;
name|ecode
operator|=
name|HAL_EESIZE
expr_stmt|;
goto|goto
name|bad
goto|;
block|}
name|ecode
operator|=
name|ath_hal_legacyEepromAttach
argument_list|(
name|ah
argument_list|)
expr_stmt|;
if|if
condition|(
name|ecode
operator|!=
name|HAL_OK
condition|)
block|{
goto|goto
name|bad
goto|;
block|}
comment|/* If Bmode and AR5211, verify 2.4 analog exists */
if|if
condition|(
name|AH_PRIVATE
argument_list|(
name|ah
argument_list|)
operator|->
name|ah_macVersion
operator|>=
name|AR_SREV_VERSION_OAHU
operator|&&
name|ath_hal_eepromGetFlag
argument_list|(
name|ah
argument_list|,
name|AR_EEP_BMODE
argument_list|)
condition|)
block|{
comment|/* Set correct Baseband to analog shift setting to access analog chips. */
name|OS_REG_WRITE
argument_list|(
name|ah
argument_list|,
name|AR_PHY_BASE
argument_list|,
literal|0x00004007
argument_list|)
expr_stmt|;
name|OS_DELAY
argument_list|(
literal|2000
argument_list|)
expr_stmt|;
name|AH_PRIVATE
argument_list|(
name|ah
argument_list|)
operator|->
name|ah_analog2GhzRev
operator|=
name|ar5211GetRadioRev
argument_list|(
name|ah
argument_list|)
expr_stmt|;
comment|/* Set baseband for 5GHz chip */
name|OS_REG_WRITE
argument_list|(
name|ah
argument_list|,
name|AR_PHY_BASE
argument_list|,
literal|0x00000007
argument_list|)
expr_stmt|;
name|OS_DELAY
argument_list|(
literal|2000
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|AH_PRIVATE
argument_list|(
name|ah
argument_list|)
operator|->
name|ah_analog2GhzRev
operator|&
literal|0xF0
operator|)
operator|!=
name|RAD2_SREV_MAJOR
condition|)
block|{
name|HALDEBUG
argument_list|(
name|ah
argument_list|,
name|HAL_DEBUG_ANY
argument_list|,
literal|"%s: 2G Radio Chip Rev 0x%x is not supported by "
literal|"this driver\n"
argument_list|,
name|__func__
argument_list|,
name|AH_PRIVATE
argument_list|(
name|ah
argument_list|)
operator|->
name|ah_analog2GhzRev
argument_list|)
expr_stmt|;
name|ecode
operator|=
name|HAL_ENOTSUPP
expr_stmt|;
goto|goto
name|bad
goto|;
block|}
block|}
else|else
block|{
name|ath_hal_eepromSet
argument_list|(
name|ah
argument_list|,
name|AR_EEP_BMODE
argument_list|,
name|AH_FALSE
argument_list|)
expr_stmt|;
block|}
name|ecode
operator|=
name|ath_hal_eepromGet
argument_list|(
name|ah
argument_list|,
name|AR_EEP_REGDMN_0
argument_list|,
operator|&
name|eeval
argument_list|)
expr_stmt|;
if|if
condition|(
name|ecode
operator|!=
name|HAL_OK
condition|)
block|{
name|HALDEBUG
argument_list|(
name|ah
argument_list|,
name|HAL_DEBUG_ANY
argument_list|,
literal|"%s: cannot read regulatory domain from EEPROM\n"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
goto|goto
name|bad
goto|;
block|}
name|AH_PRIVATE
argument_list|(
name|ah
argument_list|)
operator|->
name|ah_currentRD
operator|=
name|eeval
expr_stmt|;
name|AH_PRIVATE
argument_list|(
name|ah
argument_list|)
operator|->
name|ah_getNfAdjust
operator|=
name|ar5211GetNfAdjust
expr_stmt|;
comment|/* 	 * Got everything we need now to setup the capabilities. 	 */
operator|(
name|void
operator|)
name|ar5211FillCapabilityInfo
argument_list|(
name|ah
argument_list|)
expr_stmt|;
comment|/* Initialize gain ladder thermal calibration structure */
name|ar5211InitializeGainValues
argument_list|(
name|ah
argument_list|)
expr_stmt|;
name|ecode
operator|=
name|ath_hal_eepromGet
argument_list|(
name|ah
argument_list|,
name|AR_EEP_MACADDR
argument_list|,
name|ahp
operator|->
name|ah_macaddr
argument_list|)
expr_stmt|;
if|if
condition|(
name|ecode
operator|!=
name|HAL_OK
condition|)
block|{
name|HALDEBUG
argument_list|(
name|ah
argument_list|,
name|HAL_DEBUG_ANY
argument_list|,
literal|"%s: error getting mac address from EEPROM\n"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
goto|goto
name|bad
goto|;
block|}
name|HALDEBUG
argument_list|(
name|ah
argument_list|,
name|HAL_DEBUG_ATTACH
argument_list|,
literal|"%s: return\n"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
return|return
name|ah
return|;
name|bad
label|:
if|if
condition|(
name|ahp
condition|)
name|ar5211Detach
argument_list|(
operator|(
expr|struct
name|ath_hal
operator|*
operator|)
name|ahp
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
condition|)
operator|*
name|status
operator|=
name|ecode
expr_stmt|;
return|return
name|AH_NULL
return|;
undef|#
directive|undef
name|N
block|}
end_function

begin_function
name|void
name|ar5211Detach
parameter_list|(
name|struct
name|ath_hal
modifier|*
name|ah
parameter_list|)
block|{
name|HALDEBUG
argument_list|(
name|ah
argument_list|,
name|HAL_DEBUG_ATTACH
argument_list|,
literal|"%s:\n"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
name|HALASSERT
argument_list|(
name|ah
operator|!=
name|AH_NULL
argument_list|)
expr_stmt|;
name|HALASSERT
argument_list|(
name|ah
operator|->
name|ah_magic
operator|==
name|AR5211_MAGIC
argument_list|)
expr_stmt|;
name|ath_hal_eepromDetach
argument_list|(
name|ah
argument_list|)
expr_stmt|;
name|ath_hal_free
argument_list|(
name|ah
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|HAL_BOOL
name|ar5211ChipTest
parameter_list|(
name|struct
name|ath_hal
modifier|*
name|ah
parameter_list|)
block|{
name|uint32_t
name|regAddr
index|[
literal|2
index|]
init|=
block|{
name|AR_STA_ID0
block|,
name|AR_PHY_BASE
operator|+
operator|(
literal|8
operator|<<
literal|2
operator|)
block|}
decl_stmt|;
name|uint32_t
name|regHold
index|[
literal|2
index|]
decl_stmt|;
name|uint32_t
name|patternData
index|[
literal|4
index|]
init|=
block|{
literal|0x55555555
block|,
literal|0xaaaaaaaa
block|,
literal|0x66666666
block|,
literal|0x99999999
block|}
decl_stmt|;
name|int
name|i
decl_stmt|,
name|j
decl_stmt|;
comment|/* Test PHY& MAC registers */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|2
condition|;
name|i
operator|++
control|)
block|{
name|uint32_t
name|addr
init|=
name|regAddr
index|[
name|i
index|]
decl_stmt|;
name|uint32_t
name|wrData
decl_stmt|,
name|rdData
decl_stmt|;
name|regHold
index|[
name|i
index|]
operator|=
name|OS_REG_READ
argument_list|(
name|ah
argument_list|,
name|addr
argument_list|)
expr_stmt|;
for|for
control|(
name|j
operator|=
literal|0
init|;
name|j
operator|<
literal|0x100
condition|;
name|j
operator|++
control|)
block|{
name|wrData
operator|=
operator|(
name|j
operator|<<
literal|16
operator|)
operator||
name|j
expr_stmt|;
name|OS_REG_WRITE
argument_list|(
name|ah
argument_list|,
name|addr
argument_list|,
name|wrData
argument_list|)
expr_stmt|;
name|rdData
operator|=
name|OS_REG_READ
argument_list|(
name|ah
argument_list|,
name|addr
argument_list|)
expr_stmt|;
if|if
condition|(
name|rdData
operator|!=
name|wrData
condition|)
block|{
name|HALDEBUG
argument_list|(
name|ah
argument_list|,
name|HAL_DEBUG_ANY
argument_list|,
literal|"%s: address test failed addr: 0x%08x - wr:0x%08x != rd:0x%08x\n"
argument_list|,
name|__func__
argument_list|,
name|addr
argument_list|,
name|wrData
argument_list|,
name|rdData
argument_list|)
expr_stmt|;
return|return
name|AH_FALSE
return|;
block|}
block|}
for|for
control|(
name|j
operator|=
literal|0
init|;
name|j
operator|<
literal|4
condition|;
name|j
operator|++
control|)
block|{
name|wrData
operator|=
name|patternData
index|[
name|j
index|]
expr_stmt|;
name|OS_REG_WRITE
argument_list|(
name|ah
argument_list|,
name|addr
argument_list|,
name|wrData
argument_list|)
expr_stmt|;
name|rdData
operator|=
name|OS_REG_READ
argument_list|(
name|ah
argument_list|,
name|addr
argument_list|)
expr_stmt|;
if|if
condition|(
name|wrData
operator|!=
name|rdData
condition|)
block|{
name|HALDEBUG
argument_list|(
name|ah
argument_list|,
name|HAL_DEBUG_ANY
argument_list|,
literal|"%s: address test failed addr: 0x%08x - wr:0x%08x != rd:0x%08x\n"
argument_list|,
name|__func__
argument_list|,
name|addr
argument_list|,
name|wrData
argument_list|,
name|rdData
argument_list|)
expr_stmt|;
return|return
name|AH_FALSE
return|;
block|}
block|}
name|OS_REG_WRITE
argument_list|(
name|ah
argument_list|,
name|regAddr
index|[
name|i
index|]
argument_list|,
name|regHold
index|[
name|i
index|]
argument_list|)
expr_stmt|;
block|}
name|OS_DELAY
argument_list|(
literal|100
argument_list|)
expr_stmt|;
return|return
name|AH_TRUE
return|;
block|}
end_function

begin_comment
comment|/*  * Store the channel edges for the requested operational mode  */
end_comment

begin_function
specifier|static
name|HAL_BOOL
name|ar5211GetChannelEdges
parameter_list|(
name|struct
name|ath_hal
modifier|*
name|ah
parameter_list|,
name|uint16_t
name|flags
parameter_list|,
name|uint16_t
modifier|*
name|low
parameter_list|,
name|uint16_t
modifier|*
name|high
parameter_list|)
block|{
if|if
condition|(
name|flags
operator|&
name|IEEE80211_CHAN_5GHZ
condition|)
block|{
operator|*
name|low
operator|=
literal|4920
expr_stmt|;
operator|*
name|high
operator|=
literal|6100
expr_stmt|;
return|return
name|AH_TRUE
return|;
block|}
if|if
condition|(
name|flags
operator|&
name|IEEE80211_CHAN_2GHZ
operator|&&
name|ath_hal_eepromGetFlag
argument_list|(
name|ah
argument_list|,
name|AR_EEP_BMODE
argument_list|)
condition|)
block|{
operator|*
name|low
operator|=
literal|2312
expr_stmt|;
operator|*
name|high
operator|=
literal|2732
expr_stmt|;
return|return
name|AH_TRUE
return|;
block|}
return|return
name|AH_FALSE
return|;
block|}
end_function

begin_function
specifier|static
name|HAL_BOOL
name|ar5211GetChipPowerLimits
parameter_list|(
name|struct
name|ath_hal
modifier|*
name|ah
parameter_list|,
name|struct
name|ieee80211_channel
modifier|*
name|chan
parameter_list|)
block|{
comment|/* XXX fill in, this is just a placeholder */
name|HALDEBUG
argument_list|(
name|ah
argument_list|,
name|HAL_DEBUG_ATTACH
argument_list|,
literal|"%s: no min/max power for %u/0x%x\n"
argument_list|,
name|__func__
argument_list|,
name|chan
operator|->
name|ic_freq
argument_list|,
name|chan
operator|->
name|ic_flags
argument_list|)
expr_stmt|;
name|chan
operator|->
name|ic_maxpower
operator|=
name|MAX_RATE_POWER
expr_stmt|;
name|chan
operator|->
name|ic_minpower
operator|=
literal|0
expr_stmt|;
return|return
name|AH_TRUE
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|ar5211ConfigPCIE
parameter_list|(
name|struct
name|ath_hal
modifier|*
name|ah
parameter_list|,
name|HAL_BOOL
name|restore
parameter_list|)
block|{ }
end_function

begin_function
specifier|static
name|void
name|ar5211DisablePCIE
parameter_list|(
name|struct
name|ath_hal
modifier|*
name|ah
parameter_list|)
block|{ }
end_function

begin_comment
comment|/*  * Fill all software cached or static hardware state information.  */
end_comment

begin_function
specifier|static
name|HAL_BOOL
name|ar5211FillCapabilityInfo
parameter_list|(
name|struct
name|ath_hal
modifier|*
name|ah
parameter_list|)
block|{
name|struct
name|ath_hal_private
modifier|*
name|ahpriv
init|=
name|AH_PRIVATE
argument_list|(
name|ah
argument_list|)
decl_stmt|;
name|HAL_CAPABILITIES
modifier|*
name|pCap
init|=
operator|&
name|ahpriv
operator|->
name|ah_caps
decl_stmt|;
comment|/* Construct wireless mode from EEPROM */
name|pCap
operator|->
name|halWirelessModes
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|ath_hal_eepromGetFlag
argument_list|(
name|ah
argument_list|,
name|AR_EEP_AMODE
argument_list|)
condition|)
block|{
name|pCap
operator|->
name|halWirelessModes
operator||=
name|HAL_MODE_11A
expr_stmt|;
if|if
condition|(
operator|!
name|ath_hal_eepromGetFlag
argument_list|(
name|ah
argument_list|,
name|AR_EEP_TURBO5DISABLE
argument_list|)
condition|)
name|pCap
operator|->
name|halWirelessModes
operator||=
name|HAL_MODE_TURBO
expr_stmt|;
block|}
if|if
condition|(
name|ath_hal_eepromGetFlag
argument_list|(
name|ah
argument_list|,
name|AR_EEP_BMODE
argument_list|)
condition|)
name|pCap
operator|->
name|halWirelessModes
operator||=
name|HAL_MODE_11B
expr_stmt|;
name|pCap
operator|->
name|halLow2GhzChan
operator|=
literal|2312
expr_stmt|;
name|pCap
operator|->
name|halHigh2GhzChan
operator|=
literal|2732
expr_stmt|;
name|pCap
operator|->
name|halLow5GhzChan
operator|=
literal|4920
expr_stmt|;
name|pCap
operator|->
name|halHigh5GhzChan
operator|=
literal|6100
expr_stmt|;
name|pCap
operator|->
name|halChanSpreadSupport
operator|=
name|AH_TRUE
expr_stmt|;
name|pCap
operator|->
name|halSleepAfterBeaconBroken
operator|=
name|AH_TRUE
expr_stmt|;
name|pCap
operator|->
name|halPSPollBroken
operator|=
name|AH_TRUE
expr_stmt|;
name|pCap
operator|->
name|halVEOLSupport
operator|=
name|AH_TRUE
expr_stmt|;
name|pCap
operator|->
name|halTotalQueues
operator|=
name|HAL_NUM_TX_QUEUES
expr_stmt|;
name|pCap
operator|->
name|halKeyCacheSize
operator|=
literal|128
expr_stmt|;
comment|/* XXX not needed */
name|pCap
operator|->
name|halChanHalfRate
operator|=
name|AH_FALSE
expr_stmt|;
name|pCap
operator|->
name|halChanQuarterRate
operator|=
name|AH_FALSE
expr_stmt|;
comment|/* 	 * RSSI uses the combined field; some 11n NICs may use 	 * the control chain RSSI. 	 */
name|pCap
operator|->
name|halUseCombinedRadarRssi
operator|=
name|AH_TRUE
expr_stmt|;
if|if
condition|(
name|ath_hal_eepromGetFlag
argument_list|(
name|ah
argument_list|,
name|AR_EEP_RFKILL
argument_list|)
operator|&&
name|ath_hal_eepromGet
argument_list|(
name|ah
argument_list|,
name|AR_EEP_RFSILENT
argument_list|,
operator|&
name|ahpriv
operator|->
name|ah_rfsilent
argument_list|)
operator|==
name|HAL_OK
condition|)
block|{
comment|/* NB: enabled by default */
name|ahpriv
operator|->
name|ah_rfkillEnabled
operator|=
name|AH_TRUE
expr_stmt|;
name|pCap
operator|->
name|halRfSilentSupport
operator|=
name|AH_TRUE
expr_stmt|;
block|}
name|pCap
operator|->
name|halTstampPrecision
operator|=
literal|13
expr_stmt|;
name|pCap
operator|->
name|halIntrMask
operator|=
name|HAL_INT_COMMON
operator||
name|HAL_INT_RX
operator||
name|HAL_INT_TX
operator||
name|HAL_INT_FATAL
operator||
name|HAL_INT_BNR
operator||
name|HAL_INT_TIM
expr_stmt|;
name|pCap
operator|->
name|hal4kbSplitTransSupport
operator|=
name|AH_TRUE
expr_stmt|;
name|pCap
operator|->
name|halHasRxSelfLinkedTail
operator|=
name|AH_TRUE
expr_stmt|;
comment|/* XXX might be ok w/ some chip revs */
name|ahpriv
operator|->
name|ah_rxornIsFatal
operator|=
name|AH_TRUE
expr_stmt|;
return|return
name|AH_TRUE
return|;
block|}
end_function

begin_function
specifier|static
specifier|const
name|char
modifier|*
name|ar5211Probe
parameter_list|(
name|uint16_t
name|vendorid
parameter_list|,
name|uint16_t
name|devid
parameter_list|)
block|{
if|if
condition|(
name|vendorid
operator|==
name|ATHEROS_VENDOR_ID
condition|)
block|{
if|if
condition|(
name|devid
operator|==
name|AR5211_DEVID
operator|||
name|devid
operator|==
name|AR5311_DEVID
operator|||
name|devid
operator|==
name|AR5211_DEFAULT
condition|)
return|return
literal|"Atheros 5211"
return|;
if|if
condition|(
name|devid
operator|==
name|AR5211_FPGA11B
condition|)
return|return
literal|"Atheros 5211 (FPGA)"
return|;
block|}
return|return
name|AH_NULL
return|;
block|}
end_function

begin_expr_stmt
name|AH_CHIP
argument_list|(
name|AR5211
argument_list|,
name|ar5211Probe
argument_list|,
name|ar5211Attach
argument_list|)
expr_stmt|;
end_expr_stmt

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*-  * Copyright (c) 2015 Michael Gmelin<freebsd@grem.de>  * All rights reserved.  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions  * are met:  * 1. Redistributions of source code must retain the above copyright  *    notice, this list of conditions and the following disclaimer.  * 2. Redistributions in binary form must reproduce the above copyright  *    notice, this list of conditions and the following disclaimer in the  *    documentation and/or other materials provided with the distribution.  *  * THIS SOFTWARE IS PROVIDED BY THE AUTHOR AND CONTRIBUTORS ``AS IS'' AND  * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE  * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE  * ARE DISCLAIMED.  IN NO EVENT SHALL THE AUTHOR OR CONTRIBUTORS BE LIABLE  * FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL  * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS  * OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)  * HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT  * LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY  * OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF  * SUCH DAMAGE.  */
end_comment

begin_include
include|#
directive|include
file|<sys/cdefs.h>
end_include

begin_expr_stmt
name|__FBSDID
argument_list|(
literal|"$FreeBSD$"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_comment
comment|/*  * Driver for intersil I2C ISL29018 Digital Ambient Light Sensor and Proximity  * Sensor with Interrupt Function, only tested connected over SMBus (ig4iic).  *  * Datasheet:  * http://www.intersil.com/en/products/optoelectronics/ambient-light-and-proximity-sensors/light-to-digital-sensors/ISL29018.html  * http://www.intersil.com/content/dam/Intersil/documents/isl2/isl29018.pdf  */
end_comment

begin_include
include|#
directive|include
file|<sys/param.h>
end_include

begin_include
include|#
directive|include
file|<sys/bus.h>
end_include

begin_include
include|#
directive|include
file|<sys/conf.h>
end_include

begin_include
include|#
directive|include
file|<sys/event.h>
end_include

begin_include
include|#
directive|include
file|<sys/fcntl.h>
end_include

begin_include
include|#
directive|include
file|<sys/kernel.h>
end_include

begin_include
include|#
directive|include
file|<sys/lock.h>
end_include

begin_include
include|#
directive|include
file|<sys/lockmgr.h>
end_include

begin_include
include|#
directive|include
file|<sys/malloc.h>
end_include

begin_include
include|#
directive|include
file|<sys/mbuf.h>
end_include

begin_include
include|#
directive|include
file|<sys/module.h>
end_include

begin_include
include|#
directive|include
file|<sys/poll.h>
end_include

begin_include
include|#
directive|include
file|<sys/sx.h>
end_include

begin_include
include|#
directive|include
file|<sys/sysctl.h>
end_include

begin_include
include|#
directive|include
file|<sys/systm.h>
end_include

begin_include
include|#
directive|include
file|<sys/systm.h>
end_include

begin_include
include|#
directive|include
file|<sys/uio.h>
end_include

begin_include
include|#
directive|include
file|<sys/vnode.h>
end_include

begin_include
include|#
directive|include
file|<dev/smbus/smbconf.h>
end_include

begin_include
include|#
directive|include
file|<dev/smbus/smbus.h>
end_include

begin_include
include|#
directive|include
file|<dev/isl/isl.h>
end_include

begin_include
include|#
directive|include
file|"smbus_if.h"
end_include

begin_include
include|#
directive|include
file|"bus_if.h"
end_include

begin_include
include|#
directive|include
file|"device_if.h"
end_include

begin_define
define|#
directive|define
name|ISL_METHOD_ALS
value|0x10
end_define

begin_define
define|#
directive|define
name|ISL_METHOD_IR
value|0x11
end_define

begin_define
define|#
directive|define
name|ISL_METHOD_PROX
value|0x12
end_define

begin_define
define|#
directive|define
name|ISL_METHOD_RESOLUTION
value|0x13
end_define

begin_define
define|#
directive|define
name|ISL_METHOD_RANGE
value|0x14
end_define

begin_struct
struct|struct
name|isl_softc
block|{
name|device_t
name|dev
decl_stmt|;
name|int
name|addr
decl_stmt|;
name|struct
name|sx
name|isl_sx
decl_stmt|;
block|}
struct|;
end_struct

begin_comment
comment|/* Returns< 0 on problem. */
end_comment

begin_function_decl
specifier|static
name|int
name|isl_read_sensor
parameter_list|(
name|device_t
name|dev
parameter_list|,
name|int
name|addr
parameter_list|,
name|uint8_t
name|cmd_mask
parameter_list|)
function_decl|;
end_function_decl

begin_comment
comment|/*  * Initialize the device  */
end_comment

begin_function
specifier|static
name|int
name|init_device
parameter_list|(
name|device_t
name|dev
parameter_list|,
name|int
name|addr
parameter_list|,
name|int
name|probe
parameter_list|)
block|{
specifier|static
name|char
name|bl_init
index|[]
init|=
block|{
literal|0x00
block|}
decl_stmt|;
name|device_t
name|bus
decl_stmt|;
name|int
name|error
decl_stmt|;
name|bus
operator|=
name|device_get_parent
argument_list|(
name|dev
argument_list|)
expr_stmt|;
comment|/* smbus */
comment|/* 	 * init procedure: send 0x00 to test ref and cmd reg 1 	 */
name|error
operator|=
name|smbus_trans
argument_list|(
name|bus
argument_list|,
name|addr
argument_list|,
name|REG_TEST
argument_list|,
name|SMB_TRANS_NOCNT
operator||
name|SMB_TRANS_7BIT
argument_list|,
name|bl_init
argument_list|,
sizeof|sizeof
argument_list|(
name|bl_init
argument_list|)
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
goto|goto
name|done
goto|;
name|error
operator|=
name|smbus_trans
argument_list|(
name|bus
argument_list|,
name|addr
argument_list|,
name|REG_CMD1
argument_list|,
name|SMB_TRANS_NOCNT
operator||
name|SMB_TRANS_7BIT
argument_list|,
name|bl_init
argument_list|,
sizeof|sizeof
argument_list|(
name|bl_init
argument_list|)
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
goto|goto
name|done
goto|;
name|pause
argument_list|(
literal|"islinit"
argument_list|,
name|hz
operator|/
literal|100
argument_list|)
expr_stmt|;
name|done
label|:
if|if
condition|(
name|error
condition|)
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"Unable to initialize\n"
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
end_function

begin_function_decl
specifier|static
name|int
name|isl_probe
parameter_list|(
name|device_t
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|isl_attach
parameter_list|(
name|device_t
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|isl_detach
parameter_list|(
name|device_t
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|isl_sysctl
parameter_list|(
name|SYSCTL_HANDLER_ARGS
parameter_list|)
function_decl|;
end_function_decl

begin_decl_stmt
specifier|static
name|devclass_t
name|isl_devclass
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|device_method_t
name|isl_methods
index|[]
init|=
block|{
comment|/* device interface */
name|DEVMETHOD
argument_list|(
name|device_probe
argument_list|,
name|isl_probe
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|device_attach
argument_list|,
name|isl_attach
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|device_detach
argument_list|,
name|isl_detach
argument_list|)
block|,
name|DEVMETHOD_END
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|driver_t
name|isl_driver
init|=
block|{
literal|"isl"
block|,
name|isl_methods
block|,
sizeof|sizeof
argument_list|(
expr|struct
name|isl_softc
argument_list|)
block|, }
decl_stmt|;
end_decl_stmt

begin_function
specifier|static
name|int
name|isl_probe
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
name|int
name|addr
decl_stmt|;
name|int
name|error
decl_stmt|;
name|addr
operator|=
name|smbus_get_addr
argument_list|(
name|dev
argument_list|)
expr_stmt|;
comment|/* 	 * 0x44 - isl ambient light sensor on the acer c720. 	 * (other devices might use other ids). 	 */
if|if
condition|(
name|addr
operator|!=
literal|0x44
condition|)
return|return
operator|(
name|ENXIO
operator|)
return|;
name|error
operator|=
name|init_device
argument_list|(
name|dev
argument_list|,
name|addr
argument_list|,
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
return|return
operator|(
name|ENXIO
operator|)
return|;
name|device_set_desc
argument_list|(
name|dev
argument_list|,
literal|"ISL Digital Ambient Light Sensor"
argument_list|)
expr_stmt|;
return|return
operator|(
name|BUS_PROBE_VENDOR
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|isl_attach
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
name|struct
name|isl_softc
modifier|*
name|sc
decl_stmt|;
name|struct
name|sysctl_ctx_list
modifier|*
name|sysctl_ctx
decl_stmt|;
name|struct
name|sysctl_oid
modifier|*
name|sysctl_tree
decl_stmt|;
name|int
name|addr
decl_stmt|;
name|int
name|use_als
decl_stmt|;
name|int
name|use_ir
decl_stmt|;
name|int
name|use_prox
decl_stmt|;
name|sc
operator|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|sc
condition|)
return|return
operator|(
name|ENOMEM
operator|)
return|;
name|addr
operator|=
name|smbus_get_addr
argument_list|(
name|dev
argument_list|)
expr_stmt|;
if|if
condition|(
name|init_device
argument_list|(
name|dev
argument_list|,
name|addr
argument_list|,
literal|0
argument_list|)
condition|)
return|return
operator|(
name|ENXIO
operator|)
return|;
name|sx_init
argument_list|(
operator|&
name|sc
operator|->
name|isl_sx
argument_list|,
literal|"ISL read lock"
argument_list|)
expr_stmt|;
name|sc
operator|->
name|dev
operator|=
name|dev
expr_stmt|;
name|sc
operator|->
name|addr
operator|=
name|addr
expr_stmt|;
name|sysctl_ctx
operator|=
name|device_get_sysctl_ctx
argument_list|(
name|dev
argument_list|)
expr_stmt|;
name|sysctl_tree
operator|=
name|device_get_sysctl_tree
argument_list|(
name|dev
argument_list|)
expr_stmt|;
name|use_als
operator|=
name|isl_read_sensor
argument_list|(
name|dev
argument_list|,
name|addr
argument_list|,
name|CMD1_MASK_ALS_ONCE
argument_list|)
operator|>=
literal|0
expr_stmt|;
name|use_ir
operator|=
name|isl_read_sensor
argument_list|(
name|dev
argument_list|,
name|addr
argument_list|,
name|CMD1_MASK_IR_ONCE
argument_list|)
operator|>=
literal|0
expr_stmt|;
name|use_prox
operator|=
name|isl_read_sensor
argument_list|(
name|dev
argument_list|,
name|addr
argument_list|,
name|CMD1_MASK_PROX_ONCE
argument_list|)
operator|>=
literal|0
expr_stmt|;
if|if
condition|(
name|use_als
condition|)
block|{
name|SYSCTL_ADD_PROC
argument_list|(
name|sysctl_ctx
argument_list|,
name|SYSCTL_CHILDREN
argument_list|(
name|sysctl_tree
argument_list|)
argument_list|,
name|OID_AUTO
argument_list|,
literal|"als"
argument_list|,
name|CTLTYPE_INT
operator||
name|CTLFLAG_RD
argument_list|,
name|sc
argument_list|,
name|ISL_METHOD_ALS
argument_list|,
name|isl_sysctl
argument_list|,
literal|"I"
argument_list|,
literal|"Current ALS sensor read-out"
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|use_ir
condition|)
block|{
name|SYSCTL_ADD_PROC
argument_list|(
name|sysctl_ctx
argument_list|,
name|SYSCTL_CHILDREN
argument_list|(
name|sysctl_tree
argument_list|)
argument_list|,
name|OID_AUTO
argument_list|,
literal|"ir"
argument_list|,
name|CTLTYPE_INT
operator||
name|CTLFLAG_RD
argument_list|,
name|sc
argument_list|,
name|ISL_METHOD_IR
argument_list|,
name|isl_sysctl
argument_list|,
literal|"I"
argument_list|,
literal|"Current IR sensor read-out"
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|use_prox
condition|)
block|{
name|SYSCTL_ADD_PROC
argument_list|(
name|sysctl_ctx
argument_list|,
name|SYSCTL_CHILDREN
argument_list|(
name|sysctl_tree
argument_list|)
argument_list|,
name|OID_AUTO
argument_list|,
literal|"prox"
argument_list|,
name|CTLTYPE_INT
operator||
name|CTLFLAG_RD
argument_list|,
name|sc
argument_list|,
name|ISL_METHOD_PROX
argument_list|,
name|isl_sysctl
argument_list|,
literal|"I"
argument_list|,
literal|"Current proximity sensor read-out"
argument_list|)
expr_stmt|;
block|}
name|SYSCTL_ADD_PROC
argument_list|(
name|sysctl_ctx
argument_list|,
name|SYSCTL_CHILDREN
argument_list|(
name|sysctl_tree
argument_list|)
argument_list|,
name|OID_AUTO
argument_list|,
literal|"resolution"
argument_list|,
name|CTLTYPE_INT
operator||
name|CTLFLAG_RD
argument_list|,
name|sc
argument_list|,
name|ISL_METHOD_RESOLUTION
argument_list|,
name|isl_sysctl
argument_list|,
literal|"I"
argument_list|,
literal|"Current proximity sensor resolution"
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_PROC
argument_list|(
name|sysctl_ctx
argument_list|,
name|SYSCTL_CHILDREN
argument_list|(
name|sysctl_tree
argument_list|)
argument_list|,
name|OID_AUTO
argument_list|,
literal|"range"
argument_list|,
name|CTLTYPE_INT
operator||
name|CTLFLAG_RD
argument_list|,
name|sc
argument_list|,
name|ISL_METHOD_RANGE
argument_list|,
name|isl_sysctl
argument_list|,
literal|"I"
argument_list|,
literal|"Current proximity sensor range"
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|isl_detach
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
name|struct
name|isl_softc
modifier|*
name|sc
decl_stmt|;
name|sc
operator|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
expr_stmt|;
name|sx_destroy
argument_list|(
operator|&
name|sc
operator|->
name|isl_sx
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|isl_sysctl
parameter_list|(
name|SYSCTL_HANDLER_ARGS
parameter_list|)
block|{
specifier|static
name|int
name|resolutions
index|[]
init|=
block|{
literal|16
block|,
literal|12
block|,
literal|8
block|,
literal|4
block|}
decl_stmt|;
specifier|static
name|int
name|ranges
index|[]
init|=
block|{
literal|1000
block|,
literal|4000
block|,
literal|16000
block|,
literal|64000
block|}
decl_stmt|;
name|struct
name|isl_softc
modifier|*
name|sc
decl_stmt|;
name|device_t
name|bus
decl_stmt|;
name|uint8_t
name|rbyte
decl_stmt|;
name|int
name|arg
decl_stmt|;
name|int
name|resolution
decl_stmt|;
name|int
name|range
decl_stmt|;
name|sc
operator|=
operator|(
expr|struct
name|isl_softc
operator|*
operator|)
name|oidp
operator|->
name|oid_arg1
expr_stmt|;
name|arg
operator|=
operator|-
literal|1
expr_stmt|;
name|sx_xlock
argument_list|(
operator|&
name|sc
operator|->
name|isl_sx
argument_list|)
expr_stmt|;
name|bus
operator|=
name|device_get_parent
argument_list|(
name|sc
operator|->
name|dev
argument_list|)
expr_stmt|;
comment|/* smbus */
if|if
condition|(
name|smbus_trans
argument_list|(
name|bus
argument_list|,
name|sc
operator|->
name|addr
argument_list|,
name|REG_CMD2
argument_list|,
name|SMB_TRANS_NOCNT
operator||
name|SMB_TRANS_7BIT
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|,
operator|&
name|rbyte
argument_list|,
sizeof|sizeof
argument_list|(
name|rbyte
argument_list|)
argument_list|,
name|NULL
argument_list|)
condition|)
block|{
name|sx_xunlock
argument_list|(
operator|&
name|sc
operator|->
name|isl_sx
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
name|resolution
operator|=
name|resolutions
index|[
operator|(
name|rbyte
operator|&
name|CMD2_MASK_RESOLUTION
operator|)
operator|>>
name|CMD2_SHIFT_RESOLUTION
index|]
expr_stmt|;
name|range
operator|=
name|ranges
index|[
operator|(
name|rbyte
operator|&
name|CMD2_MASK_RANGE
operator|)
operator|>>
name|CMD2_SHIFT_RANGE
index|]
expr_stmt|;
switch|switch
condition|(
name|oidp
operator|->
name|oid_arg2
condition|)
block|{
case|case
name|ISL_METHOD_ALS
case|:
name|arg
operator|=
operator|(
name|isl_read_sensor
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
name|sc
operator|->
name|addr
argument_list|,
name|CMD1_MASK_ALS_ONCE
argument_list|)
operator|*
name|range
operator|)
operator|>>
name|resolution
expr_stmt|;
break|break;
case|case
name|ISL_METHOD_IR
case|:
name|arg
operator|=
name|isl_read_sensor
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
name|sc
operator|->
name|addr
argument_list|,
name|CMD1_MASK_IR_ONCE
argument_list|)
expr_stmt|;
break|break;
case|case
name|ISL_METHOD_PROX
case|:
name|arg
operator|=
name|isl_read_sensor
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
name|sc
operator|->
name|addr
argument_list|,
name|CMD1_MASK_PROX_ONCE
argument_list|)
expr_stmt|;
break|break;
case|case
name|ISL_METHOD_RESOLUTION
case|:
name|arg
operator|=
operator|(
literal|1
operator|<<
name|resolution
operator|)
expr_stmt|;
break|break;
case|case
name|ISL_METHOD_RANGE
case|:
name|arg
operator|=
name|range
expr_stmt|;
break|break;
block|}
name|sx_xunlock
argument_list|(
operator|&
name|sc
operator|->
name|isl_sx
argument_list|)
expr_stmt|;
name|SYSCTL_OUT
argument_list|(
name|req
argument_list|,
operator|&
name|arg
argument_list|,
sizeof|sizeof
argument_list|(
name|arg
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|isl_read_sensor
parameter_list|(
name|device_t
name|dev
parameter_list|,
name|int
name|addr
parameter_list|,
name|uint8_t
name|cmd_mask
parameter_list|)
block|{
name|device_t
name|bus
decl_stmt|;
name|uint8_t
name|rbyte
decl_stmt|;
name|uint8_t
name|cmd
decl_stmt|;
name|int
name|ret
decl_stmt|;
name|bus
operator|=
name|device_get_parent
argument_list|(
name|dev
argument_list|)
expr_stmt|;
comment|/* smbus */
if|if
condition|(
name|smbus_trans
argument_list|(
name|bus
argument_list|,
name|addr
argument_list|,
name|REG_CMD1
argument_list|,
name|SMB_TRANS_NOCNT
operator||
name|SMB_TRANS_7BIT
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|,
operator|&
name|rbyte
argument_list|,
sizeof|sizeof
argument_list|(
name|rbyte
argument_list|)
argument_list|,
name|NULL
argument_list|)
condition|)
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"Couldn't read first byte before issuing command %d\n"
argument_list|,
name|cmd_mask
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
name|cmd
operator|=
operator|(
name|rbyte
operator|&
literal|0x1f
operator|)
operator||
name|cmd_mask
expr_stmt|;
if|if
condition|(
name|smbus_trans
argument_list|(
name|bus
argument_list|,
name|addr
argument_list|,
name|REG_CMD1
argument_list|,
name|SMB_TRANS_NOCNT
operator||
name|SMB_TRANS_7BIT
argument_list|,
operator|&
name|cmd
argument_list|,
sizeof|sizeof
argument_list|(
name|cmd
argument_list|)
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|)
condition|)
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"Couldn't write command %d\n"
argument_list|,
name|cmd_mask
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
name|pause
argument_list|(
literal|"islconv"
argument_list|,
name|hz
operator|/
literal|10
argument_list|)
expr_stmt|;
if|if
condition|(
name|smbus_trans
argument_list|(
name|bus
argument_list|,
name|addr
argument_list|,
name|REG_DATA1
argument_list|,
name|SMB_TRANS_NOCNT
operator||
name|SMB_TRANS_7BIT
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|,
operator|&
name|rbyte
argument_list|,
sizeof|sizeof
argument_list|(
name|rbyte
argument_list|)
argument_list|,
name|NULL
argument_list|)
condition|)
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"Couldn't read first byte after command %d\n"
argument_list|,
name|cmd_mask
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
name|ret
operator|=
name|rbyte
expr_stmt|;
if|if
condition|(
name|smbus_trans
argument_list|(
name|bus
argument_list|,
name|addr
argument_list|,
name|REG_DATA2
argument_list|,
name|SMB_TRANS_NOCNT
operator||
name|SMB_TRANS_7BIT
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|,
operator|&
name|rbyte
argument_list|,
sizeof|sizeof
argument_list|(
name|rbyte
argument_list|)
argument_list|,
name|NULL
argument_list|)
condition|)
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"Couldn't read second byte after command %d\n"
argument_list|,
name|cmd_mask
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
name|ret
operator|+=
name|rbyte
operator|<<
literal|8
expr_stmt|;
return|return
operator|(
name|ret
operator|)
return|;
block|}
end_function

begin_expr_stmt
name|DRIVER_MODULE
argument_list|(
name|isl
argument_list|,
name|smbus
argument_list|,
name|isl_driver
argument_list|,
name|isl_devclass
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|MODULE_DEPEND
argument_list|(
name|isl
argument_list|,
name|smbus
argument_list|,
name|SMBUS_MINVER
argument_list|,
name|SMBUS_PREFVER
argument_list|,
name|SMBUS_MAXVER
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|MODULE_VERSION
argument_list|(
name|isl
argument_list|,
literal|1
argument_list|)
expr_stmt|;
end_expr_stmt

end_unit


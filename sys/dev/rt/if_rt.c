begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*-  * Copyright (c) 2015-2016, Stanislav Galabov  * Copyright (c) 2014, Aleksandr A. Mityaev  * Copyright (c) 2011, Aleksandr Rybalko  * based on hard work  * by Alexander Egorenkov<egorenar@gmail.com>  * and by Damien Bergamini<damien.bergamini@free.fr>  * All rights reserved.  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions  * are met:  * 1. Redistributions of source code must retain the above copyright  *    notice unmodified, this list of conditions, and the following  *    disclaimer.  * 2. Redistributions in binary form must reproduce the above copyright  *    notice, this list of conditions and the following disclaimer in the  *    documentation and/or other materials provided with the distribution.  *  * THIS SOFTWARE IS PROVIDED BY THE AUTHOR AND CONTRIBUTORS ``AS IS'' AND  * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE  * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE  * ARE DISCLAIMED.  IN NO EVENT SHALL THE AUTHOR OR CONTRIBUTORS BE LIABLE  * FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL  * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS  * OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)  * HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT  * LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY  * OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF  * SUCH DAMAGE.  */
end_comment

begin_include
include|#
directive|include
file|<sys/cdefs.h>
end_include

begin_expr_stmt
name|__FBSDID
argument_list|(
literal|"$FreeBSD$"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_include
include|#
directive|include
file|"if_rtvar.h"
end_include

begin_include
include|#
directive|include
file|"if_rtreg.h"
end_include

begin_include
include|#
directive|include
file|<net/if.h>
end_include

begin_include
include|#
directive|include
file|<net/if_var.h>
end_include

begin_include
include|#
directive|include
file|<net/if_arp.h>
end_include

begin_include
include|#
directive|include
file|<net/ethernet.h>
end_include

begin_include
include|#
directive|include
file|<net/if_dl.h>
end_include

begin_include
include|#
directive|include
file|<net/if_media.h>
end_include

begin_include
include|#
directive|include
file|<net/if_types.h>
end_include

begin_include
include|#
directive|include
file|<net/if_vlan_var.h>
end_include

begin_include
include|#
directive|include
file|<net/bpf.h>
end_include

begin_include
include|#
directive|include
file|<machine/bus.h>
end_include

begin_include
include|#
directive|include
file|<machine/cache.h>
end_include

begin_include
include|#
directive|include
file|<machine/cpufunc.h>
end_include

begin_include
include|#
directive|include
file|<machine/resource.h>
end_include

begin_include
include|#
directive|include
file|<vm/vm_param.h>
end_include

begin_include
include|#
directive|include
file|<vm/vm.h>
end_include

begin_include
include|#
directive|include
file|<vm/pmap.h>
end_include

begin_include
include|#
directive|include
file|<machine/pmap.h>
end_include

begin_include
include|#
directive|include
file|<sys/bus.h>
end_include

begin_include
include|#
directive|include
file|<sys/rman.h>
end_include

begin_include
include|#
directive|include
file|"opt_platform.h"
end_include

begin_include
include|#
directive|include
file|"opt_rt305x.h"
end_include

begin_ifdef
ifdef|#
directive|ifdef
name|FDT
end_ifdef

begin_include
include|#
directive|include
file|<dev/ofw/openfirm.h>
end_include

begin_include
include|#
directive|include
file|<dev/ofw/ofw_bus.h>
end_include

begin_include
include|#
directive|include
file|<dev/ofw/ofw_bus_subr.h>
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_include
include|#
directive|include
file|<dev/mii/mii.h>
end_include

begin_include
include|#
directive|include
file|<dev/mii/miivar.h>
end_include

begin_ifdef
ifdef|#
directive|ifdef
name|RT_MDIO
end_ifdef

begin_include
include|#
directive|include
file|<dev/mdio/mdio.h>
end_include

begin_include
include|#
directive|include
file|<dev/etherswitch/miiproxy.h>
end_include

begin_include
include|#
directive|include
file|"mdio_if.h"
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_if
if|#
directive|if
literal|0
end_if

begin_include
include|#
directive|include
file|<mips/rt305x/rt305x_sysctlvar.h>
end_include

begin_include
include|#
directive|include
file|<mips/rt305x/rt305xreg.h>
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_ifdef
ifdef|#
directive|ifdef
name|IF_RT_PHY_SUPPORT
end_ifdef

begin_include
include|#
directive|include
file|"miibus_if.h"
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/*  * Defines and macros  */
end_comment

begin_define
define|#
directive|define
name|RT_MAX_AGG_SIZE
value|3840
end_define

begin_define
define|#
directive|define
name|RT_TX_DATA_SEG0_SIZE
value|MJUMPAGESIZE
end_define

begin_define
define|#
directive|define
name|RT_MS
parameter_list|(
name|_v
parameter_list|,
name|_f
parameter_list|)
value|(((_v)& _f)>> _f##_S)
end_define

begin_define
define|#
directive|define
name|RT_SM
parameter_list|(
name|_v
parameter_list|,
name|_f
parameter_list|)
value|(((_v)<< _f##_S)& _f)
end_define

begin_define
define|#
directive|define
name|RT_TX_WATCHDOG_TIMEOUT
value|5
end_define

begin_define
define|#
directive|define
name|RT_CHIPID_RT2880
value|0x2880
end_define

begin_define
define|#
directive|define
name|RT_CHIPID_RT3050
value|0x3050
end_define

begin_define
define|#
directive|define
name|RT_CHIPID_RT5350
value|0x5350
end_define

begin_define
define|#
directive|define
name|RT_CHIPID_MT7620
value|0x7620
end_define

begin_define
define|#
directive|define
name|RT_CHIPID_MT7621
value|0x7621
end_define

begin_ifdef
ifdef|#
directive|ifdef
name|FDT
end_ifdef

begin_comment
comment|/* more specific and new models should go first */
end_comment

begin_decl_stmt
specifier|static
specifier|const
name|struct
name|ofw_compat_data
name|rt_compat_data
index|[]
init|=
block|{
block|{
literal|"ralink,rt2880-eth"
block|,
name|RT_CHIPID_RT2880
block|}
block|,
block|{
literal|"ralink,rt3050-eth"
block|,
name|RT_CHIPID_RT3050
block|}
block|,
block|{
literal|"ralink,rt3352-eth"
block|,
name|RT_CHIPID_RT3050
block|}
block|,
block|{
literal|"ralink,rt3883-eth"
block|,
name|RT_CHIPID_RT3050
block|}
block|,
block|{
literal|"ralink,rt5350-eth"
block|,
name|RT_CHIPID_RT5350
block|}
block|,
block|{
literal|"ralink,mt7620a-eth"
block|,
name|RT_CHIPID_MT7620
block|}
block|,
block|{
literal|"mediatek,mt7620-eth"
block|,
name|RT_CHIPID_MT7620
block|}
block|,
block|{
literal|"ralink,mt7621-eth"
block|,
name|RT_CHIPID_MT7621
block|}
block|,
block|{
literal|"mediatek,mt7621-eth"
block|,
name|RT_CHIPID_MT7621
block|}
block|,
block|{
name|NULL
block|,
literal|0
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/*  * Static function prototypes  */
end_comment

begin_function_decl
specifier|static
name|int
name|rt_probe
parameter_list|(
name|device_t
name|dev
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|rt_attach
parameter_list|(
name|device_t
name|dev
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|rt_detach
parameter_list|(
name|device_t
name|dev
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|rt_shutdown
parameter_list|(
name|device_t
name|dev
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|rt_suspend
parameter_list|(
name|device_t
name|dev
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|rt_resume
parameter_list|(
name|device_t
name|dev
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|rt_init_locked
parameter_list|(
name|void
modifier|*
name|priv
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|rt_init
parameter_list|(
name|void
modifier|*
name|priv
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|rt_stop_locked
parameter_list|(
name|void
modifier|*
name|priv
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|rt_stop
parameter_list|(
name|void
modifier|*
name|priv
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|rt_start
parameter_list|(
name|struct
name|ifnet
modifier|*
name|ifp
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|rt_ioctl
parameter_list|(
name|struct
name|ifnet
modifier|*
name|ifp
parameter_list|,
name|u_long
name|cmd
parameter_list|,
name|caddr_t
name|data
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|rt_periodic
parameter_list|(
name|void
modifier|*
name|arg
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|rt_tx_watchdog
parameter_list|(
name|void
modifier|*
name|arg
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|rt_intr
parameter_list|(
name|void
modifier|*
name|arg
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|rt_rt5350_intr
parameter_list|(
name|void
modifier|*
name|arg
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|rt_tx_coherent_intr
parameter_list|(
name|struct
name|rt_softc
modifier|*
name|sc
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|rt_rx_coherent_intr
parameter_list|(
name|struct
name|rt_softc
modifier|*
name|sc
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|rt_rx_delay_intr
parameter_list|(
name|struct
name|rt_softc
modifier|*
name|sc
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|rt_tx_delay_intr
parameter_list|(
name|struct
name|rt_softc
modifier|*
name|sc
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|rt_rx_intr
parameter_list|(
name|struct
name|rt_softc
modifier|*
name|sc
parameter_list|,
name|int
name|qid
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|rt_tx_intr
parameter_list|(
name|struct
name|rt_softc
modifier|*
name|sc
parameter_list|,
name|int
name|qid
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|rt_rx_done_task
parameter_list|(
name|void
modifier|*
name|context
parameter_list|,
name|int
name|pending
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|rt_tx_done_task
parameter_list|(
name|void
modifier|*
name|context
parameter_list|,
name|int
name|pending
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|rt_periodic_task
parameter_list|(
name|void
modifier|*
name|context
parameter_list|,
name|int
name|pending
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|rt_rx_eof
parameter_list|(
name|struct
name|rt_softc
modifier|*
name|sc
parameter_list|,
name|struct
name|rt_softc_rx_ring
modifier|*
name|ring
parameter_list|,
name|int
name|limit
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|rt_tx_eof
parameter_list|(
name|struct
name|rt_softc
modifier|*
name|sc
parameter_list|,
name|struct
name|rt_softc_tx_ring
modifier|*
name|ring
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|rt_update_stats
parameter_list|(
name|struct
name|rt_softc
modifier|*
name|sc
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|rt_watchdog
parameter_list|(
name|struct
name|rt_softc
modifier|*
name|sc
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|rt_update_raw_counters
parameter_list|(
name|struct
name|rt_softc
modifier|*
name|sc
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|rt_intr_enable
parameter_list|(
name|struct
name|rt_softc
modifier|*
name|sc
parameter_list|,
name|uint32_t
name|intr_mask
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|rt_intr_disable
parameter_list|(
name|struct
name|rt_softc
modifier|*
name|sc
parameter_list|,
name|uint32_t
name|intr_mask
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|rt_txrx_enable
parameter_list|(
name|struct
name|rt_softc
modifier|*
name|sc
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|rt_alloc_rx_ring
parameter_list|(
name|struct
name|rt_softc
modifier|*
name|sc
parameter_list|,
name|struct
name|rt_softc_rx_ring
modifier|*
name|ring
parameter_list|,
name|int
name|qid
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|rt_reset_rx_ring
parameter_list|(
name|struct
name|rt_softc
modifier|*
name|sc
parameter_list|,
name|struct
name|rt_softc_rx_ring
modifier|*
name|ring
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|rt_free_rx_ring
parameter_list|(
name|struct
name|rt_softc
modifier|*
name|sc
parameter_list|,
name|struct
name|rt_softc_rx_ring
modifier|*
name|ring
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|rt_alloc_tx_ring
parameter_list|(
name|struct
name|rt_softc
modifier|*
name|sc
parameter_list|,
name|struct
name|rt_softc_tx_ring
modifier|*
name|ring
parameter_list|,
name|int
name|qid
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|rt_reset_tx_ring
parameter_list|(
name|struct
name|rt_softc
modifier|*
name|sc
parameter_list|,
name|struct
name|rt_softc_tx_ring
modifier|*
name|ring
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|rt_free_tx_ring
parameter_list|(
name|struct
name|rt_softc
modifier|*
name|sc
parameter_list|,
name|struct
name|rt_softc_tx_ring
modifier|*
name|ring
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|rt_dma_map_addr
parameter_list|(
name|void
modifier|*
name|arg
parameter_list|,
name|bus_dma_segment_t
modifier|*
name|segs
parameter_list|,
name|int
name|nseg
parameter_list|,
name|int
name|error
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|rt_sysctl_attach
parameter_list|(
name|struct
name|rt_softc
modifier|*
name|sc
parameter_list|)
function_decl|;
end_function_decl

begin_ifdef
ifdef|#
directive|ifdef
name|IF_RT_PHY_SUPPORT
end_ifdef

begin_function_decl
name|void
name|rt_miibus_statchg
parameter_list|(
name|device_t
parameter_list|)
function_decl|;
end_function_decl

begin_endif
endif|#
directive|endif
end_endif

begin_if
if|#
directive|if
name|defined
argument_list|(
name|IF_RT_PHY_SUPPORT
argument_list|)
operator|||
name|defined
argument_list|(
name|RT_MDIO
argument_list|)
end_if

begin_function_decl
specifier|static
name|int
name|rt_miibus_readreg
parameter_list|(
name|device_t
parameter_list|,
name|int
parameter_list|,
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|rt_miibus_writereg
parameter_list|(
name|device_t
parameter_list|,
name|int
parameter_list|,
name|int
parameter_list|,
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_endif
endif|#
directive|endif
end_endif

begin_function_decl
specifier|static
name|int
name|rt_ifmedia_upd
parameter_list|(
name|struct
name|ifnet
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|rt_ifmedia_sts
parameter_list|(
name|struct
name|ifnet
modifier|*
parameter_list|,
name|struct
name|ifmediareq
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_expr_stmt
specifier|static
name|SYSCTL_NODE
argument_list|(
name|_hw
argument_list|,
name|OID_AUTO
argument_list|,
name|rt
argument_list|,
name|CTLFLAG_RD
argument_list|,
literal|0
argument_list|,
literal|"RT driver parameters"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_ifdef
ifdef|#
directive|ifdef
name|IF_RT_DEBUG
end_ifdef

begin_decl_stmt
specifier|static
name|int
name|rt_debug
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_expr_stmt
name|SYSCTL_INT
argument_list|(
name|_hw_rt
argument_list|,
name|OID_AUTO
argument_list|,
name|debug
argument_list|,
name|CTLFLAG_RWTUN
argument_list|,
operator|&
name|rt_debug
argument_list|,
literal|0
argument_list|,
literal|"RT debug level"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_endif
endif|#
directive|endif
end_endif

begin_function
specifier|static
name|int
name|rt_probe
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
name|struct
name|rt_softc
modifier|*
name|sc
init|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
decl_stmt|;
name|char
name|buf
index|[
literal|80
index|]
decl_stmt|;
ifdef|#
directive|ifdef
name|FDT
specifier|const
name|struct
name|ofw_compat_data
modifier|*
name|cd
decl_stmt|;
name|cd
operator|=
name|ofw_bus_search_compatible
argument_list|(
name|dev
argument_list|,
name|rt_compat_data
argument_list|)
expr_stmt|;
if|if
condition|(
name|cd
operator|->
name|ocd_data
operator|==
literal|0
condition|)
return|return
operator|(
name|ENXIO
operator|)
return|;
name|sc
operator|->
name|rt_chipid
operator|=
call|(
name|unsigned
name|int
call|)
argument_list|(
name|cd
operator|->
name|ocd_data
argument_list|)
expr_stmt|;
else|#
directive|else
if|#
directive|if
name|defined
argument_list|(
name|MT7620
argument_list|)
name|sc
operator|->
name|rt_chipid
operator|=
name|RT_CHIPID_MT7620
expr_stmt|;
elif|#
directive|elif
name|defined
argument_list|(
name|MT7621
argument_list|)
name|sc
operator|->
name|rt_chipid
operator|=
name|RT_CHIPID_MT7621
expr_stmt|;
elif|#
directive|elif
name|defined
argument_list|(
name|RT5350
argument_list|)
name|sc
operator|->
name|rt_chipid
operator|=
name|RT_CHIPID_RT5350
expr_stmt|;
else|#
directive|else
name|sc
operator|->
name|rt_chipid
operator|=
name|RT_CHIPID_RT3050
expr_stmt|;
endif|#
directive|endif
endif|#
directive|endif
name|snprintf
argument_list|(
name|buf
argument_list|,
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
argument_list|,
literal|"Ralink %cT%x onChip Ethernet driver"
argument_list|,
name|sc
operator|->
name|rt_chipid
operator|>=
literal|0x7600
condition|?
literal|'M'
else|:
literal|'R'
argument_list|,
name|sc
operator|->
name|rt_chipid
argument_list|)
expr_stmt|;
name|device_set_desc_copy
argument_list|(
name|dev
argument_list|,
name|buf
argument_list|)
expr_stmt|;
return|return
operator|(
name|BUS_PROBE_GENERIC
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * macaddr_atoi - translate string MAC address to uint8_t array  */
end_comment

begin_function
specifier|static
name|int
name|macaddr_atoi
parameter_list|(
specifier|const
name|char
modifier|*
name|str
parameter_list|,
name|uint8_t
modifier|*
name|mac
parameter_list|)
block|{
name|int
name|count
decl_stmt|,
name|i
decl_stmt|;
name|unsigned
name|int
name|amac
index|[
name|ETHER_ADDR_LEN
index|]
decl_stmt|;
comment|/* Aligned version */
name|count
operator|=
name|sscanf
argument_list|(
name|str
argument_list|,
literal|"%x%*c%x%*c%x%*c%x%*c%x%*c%x"
argument_list|,
operator|&
name|amac
index|[
literal|0
index|]
argument_list|,
operator|&
name|amac
index|[
literal|1
index|]
argument_list|,
operator|&
name|amac
index|[
literal|2
index|]
argument_list|,
operator|&
name|amac
index|[
literal|3
index|]
argument_list|,
operator|&
name|amac
index|[
literal|4
index|]
argument_list|,
operator|&
name|amac
index|[
literal|5
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|count
operator|<
name|ETHER_ADDR_LEN
condition|)
block|{
name|memset
argument_list|(
name|mac
argument_list|,
literal|0
argument_list|,
name|ETHER_ADDR_LEN
argument_list|)
expr_stmt|;
return|return
operator|(
literal|1
operator|)
return|;
block|}
comment|/* Copy aligned to result */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|ETHER_ADDR_LEN
condition|;
name|i
operator|++
control|)
name|mac
index|[
name|i
index|]
operator|=
operator|(
name|amac
index|[
name|i
index|]
operator|&
literal|0xff
operator|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_ifdef
ifdef|#
directive|ifdef
name|USE_GENERATED_MAC_ADDRESS
end_ifdef

begin_comment
comment|/*  * generate_mac(uin8_t *mac)  * This is MAC address generator for cases when real device MAC address  * unknown or not yet accessible.  * Use 'b','s','d' signature and 3 octets from CRC32 on kenv.  * MAC = 'b', 's', 'd', CRC[3]^CRC[2], CRC[1], CRC[0]  *  * Output - MAC address, that do not change between reboots, if hints or  * bootloader info unchange.  */
end_comment

begin_function
specifier|static
name|void
name|generate_mac
parameter_list|(
name|uint8_t
modifier|*
name|mac
parameter_list|)
block|{
name|unsigned
name|char
modifier|*
name|cp
decl_stmt|;
name|int
name|i
init|=
literal|0
decl_stmt|;
name|uint32_t
name|crc
init|=
literal|0xffffffff
decl_stmt|;
comment|/* Generate CRC32 on kenv */
for|for
control|(
name|cp
operator|=
name|kenvp
index|[
literal|0
index|]
init|;
name|cp
operator|!=
name|NULL
condition|;
name|cp
operator|=
name|kenvp
index|[
operator|++
name|i
index|]
control|)
block|{
name|crc
operator|=
name|calculate_crc32c
argument_list|(
name|crc
argument_list|,
name|cp
argument_list|,
name|strlen
argument_list|(
name|cp
argument_list|)
operator|+
literal|1
argument_list|)
expr_stmt|;
block|}
name|crc
operator|=
operator|~
name|crc
expr_stmt|;
name|mac
index|[
literal|0
index|]
operator|=
literal|'b'
expr_stmt|;
name|mac
index|[
literal|1
index|]
operator|=
literal|'s'
expr_stmt|;
name|mac
index|[
literal|2
index|]
operator|=
literal|'d'
expr_stmt|;
name|mac
index|[
literal|3
index|]
operator|=
operator|(
name|crc
operator|>>
literal|24
operator|)
operator|^
operator|(
operator|(
name|crc
operator|>>
literal|16
operator|)
operator|&
literal|0xff
operator|)
expr_stmt|;
name|mac
index|[
literal|4
index|]
operator|=
operator|(
name|crc
operator|>>
literal|8
operator|)
operator|&
literal|0xff
expr_stmt|;
name|mac
index|[
literal|5
index|]
operator|=
name|crc
operator|&
literal|0xff
expr_stmt|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/*  * ether_request_mac - try to find usable MAC address.  */
end_comment

begin_function
specifier|static
name|int
name|ether_request_mac
parameter_list|(
name|device_t
name|dev
parameter_list|,
name|uint8_t
modifier|*
name|mac
parameter_list|)
block|{
name|char
modifier|*
name|var
decl_stmt|;
comment|/* 	 * "ethaddr" is passed via envp on RedBoot platforms 	 * "kmac" is passed via argv on RouterBOOT platforms 	 */
if|#
directive|if
name|defined
argument_list|(
name|RT305X_UBOOT
argument_list|)
operator|||
name|defined
argument_list|(
name|__REDBOOT__
argument_list|)
operator|||
name|defined
argument_list|(
name|__ROUTERBOOT__
argument_list|)
if|if
condition|(
operator|(
name|var
operator|=
name|kern_getenv
argument_list|(
literal|"ethaddr"
argument_list|)
operator|)
operator|!=
name|NULL
operator|||
operator|(
name|var
operator|=
name|kern_getenv
argument_list|(
literal|"kmac"
argument_list|)
operator|)
operator|!=
name|NULL
condition|)
block|{
if|if
condition|(
operator|!
name|macaddr_atoi
argument_list|(
name|var
argument_list|,
name|mac
argument_list|)
condition|)
block|{
name|printf
argument_list|(
literal|"%s: use %s macaddr from KENV\n"
argument_list|,
name|device_get_nameunit
argument_list|(
name|dev
argument_list|)
argument_list|,
name|var
argument_list|)
expr_stmt|;
name|freeenv
argument_list|(
name|var
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
name|freeenv
argument_list|(
name|var
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
comment|/* 	 * Try from hints 	 * hint.[dev].[unit].macaddr 	 */
if|if
condition|(
operator|!
name|resource_string_value
argument_list|(
name|device_get_name
argument_list|(
name|dev
argument_list|)
argument_list|,
name|device_get_unit
argument_list|(
name|dev
argument_list|)
argument_list|,
literal|"macaddr"
argument_list|,
operator|(
specifier|const
name|char
operator|*
operator|*
operator|)
operator|&
name|var
argument_list|)
condition|)
block|{
if|if
condition|(
operator|!
name|macaddr_atoi
argument_list|(
name|var
argument_list|,
name|mac
argument_list|)
condition|)
block|{
name|printf
argument_list|(
literal|"%s: use %s macaddr from hints\n"
argument_list|,
name|device_get_nameunit
argument_list|(
name|dev
argument_list|)
argument_list|,
name|var
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
block|}
ifdef|#
directive|ifdef
name|USE_GENERATED_MAC_ADDRESS
name|generate_mac
argument_list|(
name|mac
argument_list|)
expr_stmt|;
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"use generated %02x:%02x:%02x:%02x:%02x:%02x "
literal|"macaddr\n"
argument_list|,
name|mac
index|[
literal|0
index|]
argument_list|,
name|mac
index|[
literal|1
index|]
argument_list|,
name|mac
index|[
literal|2
index|]
argument_list|,
name|mac
index|[
literal|3
index|]
argument_list|,
name|mac
index|[
literal|4
index|]
argument_list|,
name|mac
index|[
literal|5
index|]
argument_list|)
expr_stmt|;
else|#
directive|else
comment|/* Hardcoded */
name|mac
index|[
literal|0
index|]
operator|=
literal|0x00
expr_stmt|;
name|mac
index|[
literal|1
index|]
operator|=
literal|0x18
expr_stmt|;
name|mac
index|[
literal|2
index|]
operator|=
literal|0xe7
expr_stmt|;
name|mac
index|[
literal|3
index|]
operator|=
literal|0xd5
expr_stmt|;
name|mac
index|[
literal|4
index|]
operator|=
literal|0x83
expr_stmt|;
name|mac
index|[
literal|5
index|]
operator|=
literal|0x90
expr_stmt|;
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"use hardcoded 00:18:e7:d5:83:90 macaddr\n"
argument_list|)
expr_stmt|;
endif|#
directive|endif
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Reset hardware  */
end_comment

begin_function
specifier|static
name|void
name|reset_freng
parameter_list|(
name|struct
name|rt_softc
modifier|*
name|sc
parameter_list|)
block|{
comment|/* XXX hard reset kills everything so skip it ... */
return|return;
block|}
end_function

begin_function
specifier|static
name|int
name|rt_attach
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
name|struct
name|rt_softc
modifier|*
name|sc
decl_stmt|;
name|struct
name|ifnet
modifier|*
name|ifp
decl_stmt|;
name|int
name|error
decl_stmt|,
name|i
decl_stmt|;
name|sc
operator|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
expr_stmt|;
name|sc
operator|->
name|dev
operator|=
name|dev
expr_stmt|;
name|mtx_init
argument_list|(
operator|&
name|sc
operator|->
name|lock
argument_list|,
name|device_get_nameunit
argument_list|(
name|dev
argument_list|)
argument_list|,
name|MTX_NETWORK_LOCK
argument_list|,
name|MTX_DEF
operator||
name|MTX_RECURSE
argument_list|)
expr_stmt|;
name|sc
operator|->
name|mem_rid
operator|=
literal|0
expr_stmt|;
name|sc
operator|->
name|mem
operator|=
name|bus_alloc_resource_any
argument_list|(
name|dev
argument_list|,
name|SYS_RES_MEMORY
argument_list|,
operator|&
name|sc
operator|->
name|mem_rid
argument_list|,
name|RF_ACTIVE
operator||
name|RF_SHAREABLE
argument_list|)
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|mem
operator|==
name|NULL
condition|)
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"could not allocate memory resource\n"
argument_list|)
expr_stmt|;
name|error
operator|=
name|ENXIO
expr_stmt|;
goto|goto
name|fail
goto|;
block|}
name|sc
operator|->
name|bst
operator|=
name|rman_get_bustag
argument_list|(
name|sc
operator|->
name|mem
argument_list|)
expr_stmt|;
name|sc
operator|->
name|bsh
operator|=
name|rman_get_bushandle
argument_list|(
name|sc
operator|->
name|mem
argument_list|)
expr_stmt|;
name|sc
operator|->
name|irq_rid
operator|=
literal|0
expr_stmt|;
name|sc
operator|->
name|irq
operator|=
name|bus_alloc_resource_any
argument_list|(
name|dev
argument_list|,
name|SYS_RES_IRQ
argument_list|,
operator|&
name|sc
operator|->
name|irq_rid
argument_list|,
name|RF_ACTIVE
argument_list|)
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|irq
operator|==
name|NULL
condition|)
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"could not allocate interrupt resource\n"
argument_list|)
expr_stmt|;
name|error
operator|=
name|ENXIO
expr_stmt|;
goto|goto
name|fail
goto|;
block|}
ifdef|#
directive|ifdef
name|IF_RT_DEBUG
name|sc
operator|->
name|debug
operator|=
name|rt_debug
expr_stmt|;
name|SYSCTL_ADD_INT
argument_list|(
name|device_get_sysctl_ctx
argument_list|(
name|dev
argument_list|)
argument_list|,
name|SYSCTL_CHILDREN
argument_list|(
name|device_get_sysctl_tree
argument_list|(
name|dev
argument_list|)
argument_list|)
argument_list|,
name|OID_AUTO
argument_list|,
literal|"debug"
argument_list|,
name|CTLFLAG_RW
argument_list|,
operator|&
name|sc
operator|->
name|debug
argument_list|,
literal|0
argument_list|,
literal|"rt debug level"
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* Reset hardware */
name|reset_freng
argument_list|(
name|sc
argument_list|)
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|rt_chipid
operator|==
name|RT_CHIPID_MT7620
condition|)
block|{
name|sc
operator|->
name|csum_fail_ip
operator|=
name|MT7620_RXD_SRC_IP_CSUM_FAIL
expr_stmt|;
name|sc
operator|->
name|csum_fail_l4
operator|=
name|MT7620_RXD_SRC_L4_CSUM_FAIL
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|sc
operator|->
name|rt_chipid
operator|==
name|RT_CHIPID_MT7621
condition|)
block|{
name|sc
operator|->
name|csum_fail_ip
operator|=
name|MT7621_RXD_SRC_IP_CSUM_FAIL
expr_stmt|;
name|sc
operator|->
name|csum_fail_l4
operator|=
name|MT7621_RXD_SRC_L4_CSUM_FAIL
expr_stmt|;
block|}
else|else
block|{
name|sc
operator|->
name|csum_fail_ip
operator|=
name|RT305X_RXD_SRC_IP_CSUM_FAIL
expr_stmt|;
name|sc
operator|->
name|csum_fail_l4
operator|=
name|RT305X_RXD_SRC_L4_CSUM_FAIL
expr_stmt|;
block|}
comment|/* Fill in soc-specific registers map */
switch|switch
condition|(
name|sc
operator|->
name|rt_chipid
condition|)
block|{
case|case
name|RT_CHIPID_MT7620
case|:
case|case
name|RT_CHIPID_MT7621
case|:
name|sc
operator|->
name|gdma1_base
operator|=
name|MT7620_GDMA1_BASE
expr_stmt|;
comment|/* fallthrough */
case|case
name|RT_CHIPID_RT5350
case|:
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"%cT%x Ethernet MAC (rev 0x%08x)\n"
argument_list|,
name|sc
operator|->
name|rt_chipid
operator|>=
literal|0x7600
condition|?
literal|'M'
else|:
literal|'R'
argument_list|,
name|sc
operator|->
name|rt_chipid
argument_list|,
name|sc
operator|->
name|mac_rev
argument_list|)
expr_stmt|;
comment|/* RT5350: No GDMA, PSE, CDMA, PPE */
name|RT_WRITE
argument_list|(
name|sc
argument_list|,
name|GE_PORT_BASE
operator|+
literal|0x0C00
argument_list|,
comment|// UDPCS, TCPCS, IPCS=1
name|RT_READ
argument_list|(
name|sc
argument_list|,
name|GE_PORT_BASE
operator|+
literal|0x0C00
argument_list|)
operator||
operator|(
literal|0x7
operator|<<
literal|16
operator|)
argument_list|)
expr_stmt|;
name|sc
operator|->
name|delay_int_cfg
operator|=
name|RT5350_PDMA_BASE
operator|+
name|RT5350_DELAY_INT_CFG
expr_stmt|;
name|sc
operator|->
name|fe_int_status
operator|=
name|RT5350_FE_INT_STATUS
expr_stmt|;
name|sc
operator|->
name|fe_int_enable
operator|=
name|RT5350_FE_INT_ENABLE
expr_stmt|;
name|sc
operator|->
name|pdma_glo_cfg
operator|=
name|RT5350_PDMA_BASE
operator|+
name|RT5350_PDMA_GLO_CFG
expr_stmt|;
name|sc
operator|->
name|pdma_rst_idx
operator|=
name|RT5350_PDMA_BASE
operator|+
name|RT5350_PDMA_RST_IDX
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|RT_SOFTC_TX_RING_COUNT
condition|;
name|i
operator|++
control|)
block|{
name|sc
operator|->
name|tx_base_ptr
index|[
name|i
index|]
operator|=
name|RT5350_PDMA_BASE
operator|+
name|RT5350_TX_BASE_PTR
argument_list|(
name|i
argument_list|)
expr_stmt|;
name|sc
operator|->
name|tx_max_cnt
index|[
name|i
index|]
operator|=
name|RT5350_PDMA_BASE
operator|+
name|RT5350_TX_MAX_CNT
argument_list|(
name|i
argument_list|)
expr_stmt|;
name|sc
operator|->
name|tx_ctx_idx
index|[
name|i
index|]
operator|=
name|RT5350_PDMA_BASE
operator|+
name|RT5350_TX_CTX_IDX
argument_list|(
name|i
argument_list|)
expr_stmt|;
name|sc
operator|->
name|tx_dtx_idx
index|[
name|i
index|]
operator|=
name|RT5350_PDMA_BASE
operator|+
name|RT5350_TX_DTX_IDX
argument_list|(
name|i
argument_list|)
expr_stmt|;
block|}
name|sc
operator|->
name|rx_ring_count
operator|=
literal|2
expr_stmt|;
name|sc
operator|->
name|rx_base_ptr
index|[
literal|0
index|]
operator|=
name|RT5350_PDMA_BASE
operator|+
name|RT5350_RX_BASE_PTR0
expr_stmt|;
name|sc
operator|->
name|rx_max_cnt
index|[
literal|0
index|]
operator|=
name|RT5350_PDMA_BASE
operator|+
name|RT5350_RX_MAX_CNT0
expr_stmt|;
name|sc
operator|->
name|rx_calc_idx
index|[
literal|0
index|]
operator|=
name|RT5350_PDMA_BASE
operator|+
name|RT5350_RX_CALC_IDX0
expr_stmt|;
name|sc
operator|->
name|rx_drx_idx
index|[
literal|0
index|]
operator|=
name|RT5350_PDMA_BASE
operator|+
name|RT5350_RX_DRX_IDX0
expr_stmt|;
name|sc
operator|->
name|rx_base_ptr
index|[
literal|1
index|]
operator|=
name|RT5350_PDMA_BASE
operator|+
name|RT5350_RX_BASE_PTR1
expr_stmt|;
name|sc
operator|->
name|rx_max_cnt
index|[
literal|1
index|]
operator|=
name|RT5350_PDMA_BASE
operator|+
name|RT5350_RX_MAX_CNT1
expr_stmt|;
name|sc
operator|->
name|rx_calc_idx
index|[
literal|1
index|]
operator|=
name|RT5350_PDMA_BASE
operator|+
name|RT5350_RX_CALC_IDX1
expr_stmt|;
name|sc
operator|->
name|rx_drx_idx
index|[
literal|1
index|]
operator|=
name|RT5350_PDMA_BASE
operator|+
name|RT5350_RX_DRX_IDX1
expr_stmt|;
name|sc
operator|->
name|int_rx_done_mask
operator|=
name|RT5350_INT_RXQ0_DONE
expr_stmt|;
name|sc
operator|->
name|int_tx_done_mask
operator|=
name|RT5350_INT_TXQ0_DONE
expr_stmt|;
break|break;
default|default:
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"RT305XF Ethernet MAC (rev 0x%08x)\n"
argument_list|,
name|sc
operator|->
name|mac_rev
argument_list|)
expr_stmt|;
name|sc
operator|->
name|gdma1_base
operator|=
name|GDMA1_BASE
expr_stmt|;
name|sc
operator|->
name|delay_int_cfg
operator|=
name|PDMA_BASE
operator|+
name|DELAY_INT_CFG
expr_stmt|;
name|sc
operator|->
name|fe_int_status
operator|=
name|GE_PORT_BASE
operator|+
name|FE_INT_STATUS
expr_stmt|;
name|sc
operator|->
name|fe_int_enable
operator|=
name|GE_PORT_BASE
operator|+
name|FE_INT_ENABLE
expr_stmt|;
name|sc
operator|->
name|pdma_glo_cfg
operator|=
name|PDMA_BASE
operator|+
name|PDMA_GLO_CFG
expr_stmt|;
name|sc
operator|->
name|pdma_rst_idx
operator|=
name|PDMA_BASE
operator|+
name|PDMA_RST_IDX
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|RT_SOFTC_TX_RING_COUNT
condition|;
name|i
operator|++
control|)
block|{
name|sc
operator|->
name|tx_base_ptr
index|[
name|i
index|]
operator|=
name|PDMA_BASE
operator|+
name|TX_BASE_PTR
argument_list|(
name|i
argument_list|)
expr_stmt|;
name|sc
operator|->
name|tx_max_cnt
index|[
name|i
index|]
operator|=
name|PDMA_BASE
operator|+
name|TX_MAX_CNT
argument_list|(
name|i
argument_list|)
expr_stmt|;
name|sc
operator|->
name|tx_ctx_idx
index|[
name|i
index|]
operator|=
name|PDMA_BASE
operator|+
name|TX_CTX_IDX
argument_list|(
name|i
argument_list|)
expr_stmt|;
name|sc
operator|->
name|tx_dtx_idx
index|[
name|i
index|]
operator|=
name|PDMA_BASE
operator|+
name|TX_DTX_IDX
argument_list|(
name|i
argument_list|)
expr_stmt|;
block|}
name|sc
operator|->
name|rx_ring_count
operator|=
literal|1
expr_stmt|;
name|sc
operator|->
name|rx_base_ptr
index|[
literal|0
index|]
operator|=
name|PDMA_BASE
operator|+
name|RX_BASE_PTR0
expr_stmt|;
name|sc
operator|->
name|rx_max_cnt
index|[
literal|0
index|]
operator|=
name|PDMA_BASE
operator|+
name|RX_MAX_CNT0
expr_stmt|;
name|sc
operator|->
name|rx_calc_idx
index|[
literal|0
index|]
operator|=
name|PDMA_BASE
operator|+
name|RX_CALC_IDX0
expr_stmt|;
name|sc
operator|->
name|rx_drx_idx
index|[
literal|0
index|]
operator|=
name|PDMA_BASE
operator|+
name|RX_DRX_IDX0
expr_stmt|;
name|sc
operator|->
name|int_rx_done_mask
operator|=
name|INT_RX_DONE
expr_stmt|;
name|sc
operator|->
name|int_tx_done_mask
operator|=
name|INT_TXQ0_DONE
expr_stmt|;
block|}
if|if
condition|(
name|sc
operator|->
name|gdma1_base
operator|!=
literal|0
condition|)
name|RT_WRITE
argument_list|(
name|sc
argument_list|,
name|sc
operator|->
name|gdma1_base
operator|+
name|GDMA_FWD_CFG
argument_list|,
operator|(
name|GDM_ICS_EN
operator||
comment|/* Enable IP Csum */
name|GDM_TCS_EN
operator||
comment|/* Enable TCP Csum */
name|GDM_UCS_EN
operator||
comment|/* Enable UDP Csum */
name|GDM_STRPCRC
operator||
comment|/* Strip CRC from packet */
name|GDM_DST_PORT_CPU
operator|<<
name|GDM_UFRC_P_SHIFT
operator||
comment|/* fwd UCast to CPU */
name|GDM_DST_PORT_CPU
operator|<<
name|GDM_BFRC_P_SHIFT
operator||
comment|/* fwd BCast to CPU */
name|GDM_DST_PORT_CPU
operator|<<
name|GDM_MFRC_P_SHIFT
operator||
comment|/* fwd MCast to CPU */
name|GDM_DST_PORT_CPU
operator|<<
name|GDM_OFRC_P_SHIFT
comment|/* fwd Other to CPU */
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|rt_chipid
operator|==
name|RT_CHIPID_RT2880
condition|)
name|RT_WRITE
argument_list|(
name|sc
argument_list|,
name|MDIO_CFG
argument_list|,
name|MDIO_2880_100T_INIT
argument_list|)
expr_stmt|;
comment|/* allocate Tx and Rx rings */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|RT_SOFTC_TX_RING_COUNT
condition|;
name|i
operator|++
control|)
block|{
name|error
operator|=
name|rt_alloc_tx_ring
argument_list|(
name|sc
argument_list|,
operator|&
name|sc
operator|->
name|tx_ring
index|[
name|i
index|]
argument_list|,
name|i
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|!=
literal|0
condition|)
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"could not allocate Tx ring #%d\n"
argument_list|,
name|i
argument_list|)
expr_stmt|;
goto|goto
name|fail
goto|;
block|}
block|}
name|sc
operator|->
name|tx_ring_mgtqid
operator|=
literal|5
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|sc
operator|->
name|rx_ring_count
condition|;
name|i
operator|++
control|)
block|{
name|error
operator|=
name|rt_alloc_rx_ring
argument_list|(
name|sc
argument_list|,
operator|&
name|sc
operator|->
name|rx_ring
index|[
name|i
index|]
argument_list|,
name|i
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|!=
literal|0
condition|)
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"could not allocate Rx ring\n"
argument_list|)
expr_stmt|;
goto|goto
name|fail
goto|;
block|}
block|}
name|callout_init
argument_list|(
operator|&
name|sc
operator|->
name|periodic_ch
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|callout_init_mtx
argument_list|(
operator|&
name|sc
operator|->
name|tx_watchdog_ch
argument_list|,
operator|&
name|sc
operator|->
name|lock
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|ifp
operator|=
name|sc
operator|->
name|ifp
operator|=
name|if_alloc
argument_list|(
name|IFT_ETHER
argument_list|)
expr_stmt|;
if|if
condition|(
name|ifp
operator|==
name|NULL
condition|)
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"could not if_alloc()\n"
argument_list|)
expr_stmt|;
name|error
operator|=
name|ENOMEM
expr_stmt|;
goto|goto
name|fail
goto|;
block|}
name|ifp
operator|->
name|if_softc
operator|=
name|sc
expr_stmt|;
name|if_initname
argument_list|(
name|ifp
argument_list|,
name|device_get_name
argument_list|(
name|sc
operator|->
name|dev
argument_list|)
argument_list|,
name|device_get_unit
argument_list|(
name|sc
operator|->
name|dev
argument_list|)
argument_list|)
expr_stmt|;
name|ifp
operator|->
name|if_flags
operator|=
name|IFF_BROADCAST
operator||
name|IFF_SIMPLEX
operator||
name|IFF_MULTICAST
expr_stmt|;
name|ifp
operator|->
name|if_init
operator|=
name|rt_init
expr_stmt|;
name|ifp
operator|->
name|if_ioctl
operator|=
name|rt_ioctl
expr_stmt|;
name|ifp
operator|->
name|if_start
operator|=
name|rt_start
expr_stmt|;
define|#
directive|define
name|RT_TX_QLEN
value|256
name|IFQ_SET_MAXLEN
argument_list|(
operator|&
name|ifp
operator|->
name|if_snd
argument_list|,
name|RT_TX_QLEN
argument_list|)
expr_stmt|;
name|ifp
operator|->
name|if_snd
operator|.
name|ifq_drv_maxlen
operator|=
name|RT_TX_QLEN
expr_stmt|;
name|IFQ_SET_READY
argument_list|(
operator|&
name|ifp
operator|->
name|if_snd
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|IF_RT_PHY_SUPPORT
name|error
operator|=
name|mii_attach
argument_list|(
name|dev
argument_list|,
operator|&
name|sc
operator|->
name|rt_miibus
argument_list|,
name|ifp
argument_list|,
name|rt_ifmedia_upd
argument_list|,
name|rt_ifmedia_sts
argument_list|,
name|BMSR_DEFCAPMASK
argument_list|,
name|MII_PHY_ANY
argument_list|,
name|MII_OFFSET_ANY
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|!=
literal|0
condition|)
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"attaching PHYs failed\n"
argument_list|)
expr_stmt|;
name|error
operator|=
name|ENXIO
expr_stmt|;
goto|goto
name|fail
goto|;
block|}
else|#
directive|else
name|ifmedia_init
argument_list|(
operator|&
name|sc
operator|->
name|rt_ifmedia
argument_list|,
literal|0
argument_list|,
name|rt_ifmedia_upd
argument_list|,
name|rt_ifmedia_sts
argument_list|)
expr_stmt|;
name|ifmedia_add
argument_list|(
operator|&
name|sc
operator|->
name|rt_ifmedia
argument_list|,
name|IFM_ETHER
operator||
name|IFM_100_TX
operator||
name|IFM_FDX
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|ifmedia_set
argument_list|(
operator|&
name|sc
operator|->
name|rt_ifmedia
argument_list|,
name|IFM_ETHER
operator||
name|IFM_100_TX
operator||
name|IFM_FDX
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* IF_RT_PHY_SUPPORT */
name|ether_request_mac
argument_list|(
name|dev
argument_list|,
name|sc
operator|->
name|mac_addr
argument_list|)
expr_stmt|;
name|ether_ifattach
argument_list|(
name|ifp
argument_list|,
name|sc
operator|->
name|mac_addr
argument_list|)
expr_stmt|;
comment|/* 	 * Tell the upper layer(s) we support long frames. 	 */
name|ifp
operator|->
name|if_hdrlen
operator|=
sizeof|sizeof
argument_list|(
expr|struct
name|ether_vlan_header
argument_list|)
expr_stmt|;
name|ifp
operator|->
name|if_capabilities
operator||=
name|IFCAP_VLAN_MTU
expr_stmt|;
name|ifp
operator|->
name|if_capenable
operator||=
name|IFCAP_VLAN_MTU
expr_stmt|;
name|ifp
operator|->
name|if_capabilities
operator||=
name|IFCAP_RXCSUM
operator||
name|IFCAP_TXCSUM
expr_stmt|;
name|ifp
operator|->
name|if_capenable
operator||=
name|IFCAP_RXCSUM
operator||
name|IFCAP_TXCSUM
expr_stmt|;
comment|/* init task queue */
name|TASK_INIT
argument_list|(
operator|&
name|sc
operator|->
name|rx_done_task
argument_list|,
literal|0
argument_list|,
name|rt_rx_done_task
argument_list|,
name|sc
argument_list|)
expr_stmt|;
name|TASK_INIT
argument_list|(
operator|&
name|sc
operator|->
name|tx_done_task
argument_list|,
literal|0
argument_list|,
name|rt_tx_done_task
argument_list|,
name|sc
argument_list|)
expr_stmt|;
name|TASK_INIT
argument_list|(
operator|&
name|sc
operator|->
name|periodic_task
argument_list|,
literal|0
argument_list|,
name|rt_periodic_task
argument_list|,
name|sc
argument_list|)
expr_stmt|;
name|sc
operator|->
name|rx_process_limit
operator|=
literal|100
expr_stmt|;
name|sc
operator|->
name|taskqueue
operator|=
name|taskqueue_create
argument_list|(
literal|"rt_taskq"
argument_list|,
name|M_NOWAIT
argument_list|,
name|taskqueue_thread_enqueue
argument_list|,
operator|&
name|sc
operator|->
name|taskqueue
argument_list|)
expr_stmt|;
name|taskqueue_start_threads
argument_list|(
operator|&
name|sc
operator|->
name|taskqueue
argument_list|,
literal|1
argument_list|,
name|PI_NET
argument_list|,
literal|"%s taskq"
argument_list|,
name|device_get_nameunit
argument_list|(
name|sc
operator|->
name|dev
argument_list|)
argument_list|)
expr_stmt|;
name|rt_sysctl_attach
argument_list|(
name|sc
argument_list|)
expr_stmt|;
comment|/* set up interrupt */
name|error
operator|=
name|bus_setup_intr
argument_list|(
name|dev
argument_list|,
name|sc
operator|->
name|irq
argument_list|,
name|INTR_TYPE_NET
operator||
name|INTR_MPSAFE
argument_list|,
name|NULL
argument_list|,
operator|(
name|sc
operator|->
name|rt_chipid
operator|==
name|RT_CHIPID_RT5350
operator|||
name|sc
operator|->
name|rt_chipid
operator|==
name|RT_CHIPID_MT7620
operator|||
name|sc
operator|->
name|rt_chipid
operator|==
name|RT_CHIPID_MT7621
operator|)
condition|?
name|rt_rt5350_intr
else|:
name|rt_intr
argument_list|,
name|sc
argument_list|,
operator|&
name|sc
operator|->
name|irqh
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|!=
literal|0
condition|)
block|{
name|printf
argument_list|(
literal|"%s: could not set up interrupt\n"
argument_list|,
name|device_get_nameunit
argument_list|(
name|dev
argument_list|)
argument_list|)
expr_stmt|;
goto|goto
name|fail
goto|;
block|}
ifdef|#
directive|ifdef
name|IF_RT_DEBUG
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"debug var at %#08x\n"
argument_list|,
operator|(
name|u_int
operator|)
operator|&
operator|(
name|sc
operator|->
name|debug
operator|)
argument_list|)
expr_stmt|;
endif|#
directive|endif
return|return
operator|(
literal|0
operator|)
return|;
name|fail
label|:
comment|/* free Tx and Rx rings */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|RT_SOFTC_TX_RING_COUNT
condition|;
name|i
operator|++
control|)
name|rt_free_tx_ring
argument_list|(
name|sc
argument_list|,
operator|&
name|sc
operator|->
name|tx_ring
index|[
name|i
index|]
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|sc
operator|->
name|rx_ring_count
condition|;
name|i
operator|++
control|)
name|rt_free_rx_ring
argument_list|(
name|sc
argument_list|,
operator|&
name|sc
operator|->
name|rx_ring
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|mtx_destroy
argument_list|(
operator|&
name|sc
operator|->
name|lock
argument_list|)
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|mem
operator|!=
name|NULL
condition|)
name|bus_release_resource
argument_list|(
name|dev
argument_list|,
name|SYS_RES_MEMORY
argument_list|,
name|sc
operator|->
name|mem_rid
argument_list|,
name|sc
operator|->
name|mem
argument_list|)
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|irq
operator|!=
name|NULL
condition|)
name|bus_release_resource
argument_list|(
name|dev
argument_list|,
name|SYS_RES_IRQ
argument_list|,
name|sc
operator|->
name|irq_rid
argument_list|,
name|sc
operator|->
name|irq
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Set media options.  */
end_comment

begin_function
specifier|static
name|int
name|rt_ifmedia_upd
parameter_list|(
name|struct
name|ifnet
modifier|*
name|ifp
parameter_list|)
block|{
name|struct
name|rt_softc
modifier|*
name|sc
decl_stmt|;
ifdef|#
directive|ifdef
name|IF_RT_PHY_SUPPORT
name|struct
name|mii_data
modifier|*
name|mii
decl_stmt|;
name|struct
name|mii_softc
modifier|*
name|miisc
decl_stmt|;
name|int
name|error
init|=
literal|0
decl_stmt|;
name|sc
operator|=
name|ifp
operator|->
name|if_softc
expr_stmt|;
name|RT_SOFTC_LOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|mii
operator|=
name|device_get_softc
argument_list|(
name|sc
operator|->
name|rt_miibus
argument_list|)
expr_stmt|;
name|LIST_FOREACH
argument_list|(
argument|miisc
argument_list|,
argument|&mii->mii_phys
argument_list|,
argument|mii_list
argument_list|)
name|PHY_RESET
argument_list|(
name|miisc
argument_list|)
expr_stmt|;
name|error
operator|=
name|mii_mediachg
argument_list|(
name|mii
argument_list|)
expr_stmt|;
name|RT_SOFTC_UNLOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
else|#
directive|else
comment|/* !IF_RT_PHY_SUPPORT */
name|struct
name|ifmedia
modifier|*
name|ifm
decl_stmt|;
name|struct
name|ifmedia_entry
modifier|*
name|ife
decl_stmt|;
name|sc
operator|=
name|ifp
operator|->
name|if_softc
expr_stmt|;
name|ifm
operator|=
operator|&
name|sc
operator|->
name|rt_ifmedia
expr_stmt|;
name|ife
operator|=
name|ifm
operator|->
name|ifm_cur
expr_stmt|;
if|if
condition|(
name|IFM_TYPE
argument_list|(
name|ifm
operator|->
name|ifm_media
argument_list|)
operator|!=
name|IFM_ETHER
condition|)
return|return
operator|(
name|EINVAL
operator|)
return|;
if|if
condition|(
name|IFM_SUBTYPE
argument_list|(
name|ife
operator|->
name|ifm_media
argument_list|)
operator|==
name|IFM_AUTO
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
literal|"AUTO is not supported for multiphy MAC"
argument_list|)
expr_stmt|;
return|return
operator|(
name|EINVAL
operator|)
return|;
block|}
comment|/* 	 * Ignore everything 	 */
return|return
operator|(
literal|0
operator|)
return|;
endif|#
directive|endif
comment|/* IF_RT_PHY_SUPPORT */
block|}
end_function

begin_comment
comment|/*  * Report current media status.  */
end_comment

begin_function
specifier|static
name|void
name|rt_ifmedia_sts
parameter_list|(
name|struct
name|ifnet
modifier|*
name|ifp
parameter_list|,
name|struct
name|ifmediareq
modifier|*
name|ifmr
parameter_list|)
block|{
ifdef|#
directive|ifdef
name|IF_RT_PHY_SUPPORT
name|struct
name|rt_softc
modifier|*
name|sc
decl_stmt|;
name|struct
name|mii_data
modifier|*
name|mii
decl_stmt|;
name|sc
operator|=
name|ifp
operator|->
name|if_softc
expr_stmt|;
name|RT_SOFTC_LOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|mii
operator|=
name|device_get_softc
argument_list|(
name|sc
operator|->
name|rt_miibus
argument_list|)
expr_stmt|;
name|mii_pollstat
argument_list|(
name|mii
argument_list|)
expr_stmt|;
name|ifmr
operator|->
name|ifm_active
operator|=
name|mii
operator|->
name|mii_media_active
expr_stmt|;
name|ifmr
operator|->
name|ifm_status
operator|=
name|mii
operator|->
name|mii_media_status
expr_stmt|;
name|ifmr
operator|->
name|ifm_active
operator|=
name|IFM_ETHER
operator||
name|IFM_100_TX
operator||
name|IFM_FDX
expr_stmt|;
name|ifmr
operator|->
name|ifm_status
operator|=
name|IFM_AVALID
operator||
name|IFM_ACTIVE
expr_stmt|;
name|RT_SOFTC_UNLOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
else|#
directive|else
comment|/* !IF_RT_PHY_SUPPORT */
name|ifmr
operator|->
name|ifm_status
operator|=
name|IFM_AVALID
operator||
name|IFM_ACTIVE
expr_stmt|;
name|ifmr
operator|->
name|ifm_active
operator|=
name|IFM_ETHER
operator||
name|IFM_100_TX
operator||
name|IFM_FDX
expr_stmt|;
endif|#
directive|endif
comment|/* IF_RT_PHY_SUPPORT */
block|}
end_function

begin_function
specifier|static
name|int
name|rt_detach
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
name|struct
name|rt_softc
modifier|*
name|sc
decl_stmt|;
name|struct
name|ifnet
modifier|*
name|ifp
decl_stmt|;
name|int
name|i
decl_stmt|;
name|sc
operator|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
expr_stmt|;
name|ifp
operator|=
name|sc
operator|->
name|ifp
expr_stmt|;
name|RT_DPRINTF
argument_list|(
name|sc
argument_list|,
name|RT_DEBUG_ANY
argument_list|,
literal|"detaching\n"
argument_list|)
expr_stmt|;
name|RT_SOFTC_LOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|ifp
operator|->
name|if_drv_flags
operator|&=
operator|~
operator|(
name|IFF_DRV_RUNNING
operator||
name|IFF_DRV_OACTIVE
operator|)
expr_stmt|;
name|callout_stop
argument_list|(
operator|&
name|sc
operator|->
name|periodic_ch
argument_list|)
expr_stmt|;
name|callout_stop
argument_list|(
operator|&
name|sc
operator|->
name|tx_watchdog_ch
argument_list|)
expr_stmt|;
name|taskqueue_drain
argument_list|(
name|sc
operator|->
name|taskqueue
argument_list|,
operator|&
name|sc
operator|->
name|rx_done_task
argument_list|)
expr_stmt|;
name|taskqueue_drain
argument_list|(
name|sc
operator|->
name|taskqueue
argument_list|,
operator|&
name|sc
operator|->
name|tx_done_task
argument_list|)
expr_stmt|;
name|taskqueue_drain
argument_list|(
name|sc
operator|->
name|taskqueue
argument_list|,
operator|&
name|sc
operator|->
name|periodic_task
argument_list|)
expr_stmt|;
comment|/* free Tx and Rx rings */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|RT_SOFTC_TX_RING_COUNT
condition|;
name|i
operator|++
control|)
name|rt_free_tx_ring
argument_list|(
name|sc
argument_list|,
operator|&
name|sc
operator|->
name|tx_ring
index|[
name|i
index|]
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|sc
operator|->
name|rx_ring_count
condition|;
name|i
operator|++
control|)
name|rt_free_rx_ring
argument_list|(
name|sc
argument_list|,
operator|&
name|sc
operator|->
name|rx_ring
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|RT_SOFTC_UNLOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|IF_RT_PHY_SUPPORT
if|if
condition|(
name|sc
operator|->
name|rt_miibus
operator|!=
name|NULL
condition|)
name|device_delete_child
argument_list|(
name|dev
argument_list|,
name|sc
operator|->
name|rt_miibus
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|ether_ifdetach
argument_list|(
name|ifp
argument_list|)
expr_stmt|;
name|if_free
argument_list|(
name|ifp
argument_list|)
expr_stmt|;
name|taskqueue_free
argument_list|(
name|sc
operator|->
name|taskqueue
argument_list|)
expr_stmt|;
name|mtx_destroy
argument_list|(
operator|&
name|sc
operator|->
name|lock
argument_list|)
expr_stmt|;
name|bus_generic_detach
argument_list|(
name|dev
argument_list|)
expr_stmt|;
name|bus_teardown_intr
argument_list|(
name|dev
argument_list|,
name|sc
operator|->
name|irq
argument_list|,
name|sc
operator|->
name|irqh
argument_list|)
expr_stmt|;
name|bus_release_resource
argument_list|(
name|dev
argument_list|,
name|SYS_RES_IRQ
argument_list|,
name|sc
operator|->
name|irq_rid
argument_list|,
name|sc
operator|->
name|irq
argument_list|)
expr_stmt|;
name|bus_release_resource
argument_list|(
name|dev
argument_list|,
name|SYS_RES_MEMORY
argument_list|,
name|sc
operator|->
name|mem_rid
argument_list|,
name|sc
operator|->
name|mem
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|rt_shutdown
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
name|struct
name|rt_softc
modifier|*
name|sc
decl_stmt|;
name|sc
operator|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
expr_stmt|;
name|RT_DPRINTF
argument_list|(
name|sc
argument_list|,
name|RT_DEBUG_ANY
argument_list|,
literal|"shutting down\n"
argument_list|)
expr_stmt|;
name|rt_stop
argument_list|(
name|sc
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|rt_suspend
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
name|struct
name|rt_softc
modifier|*
name|sc
decl_stmt|;
name|sc
operator|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
expr_stmt|;
name|RT_DPRINTF
argument_list|(
name|sc
argument_list|,
name|RT_DEBUG_ANY
argument_list|,
literal|"suspending\n"
argument_list|)
expr_stmt|;
name|rt_stop
argument_list|(
name|sc
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|rt_resume
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
name|struct
name|rt_softc
modifier|*
name|sc
decl_stmt|;
name|struct
name|ifnet
modifier|*
name|ifp
decl_stmt|;
name|sc
operator|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
expr_stmt|;
name|ifp
operator|=
name|sc
operator|->
name|ifp
expr_stmt|;
name|RT_DPRINTF
argument_list|(
name|sc
argument_list|,
name|RT_DEBUG_ANY
argument_list|,
literal|"resuming\n"
argument_list|)
expr_stmt|;
if|if
condition|(
name|ifp
operator|->
name|if_flags
operator|&
name|IFF_UP
condition|)
name|rt_init
argument_list|(
name|sc
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * rt_init_locked - Run initialization process having locked mtx.  */
end_comment

begin_function
specifier|static
name|void
name|rt_init_locked
parameter_list|(
name|void
modifier|*
name|priv
parameter_list|)
block|{
name|struct
name|rt_softc
modifier|*
name|sc
decl_stmt|;
name|struct
name|ifnet
modifier|*
name|ifp
decl_stmt|;
ifdef|#
directive|ifdef
name|IF_RT_PHY_SUPPORT
name|struct
name|mii_data
modifier|*
name|mii
decl_stmt|;
endif|#
directive|endif
name|int
name|i
decl_stmt|,
name|ntries
decl_stmt|;
name|uint32_t
name|tmp
decl_stmt|;
name|sc
operator|=
name|priv
expr_stmt|;
name|ifp
operator|=
name|sc
operator|->
name|ifp
expr_stmt|;
ifdef|#
directive|ifdef
name|IF_RT_PHY_SUPPORT
name|mii
operator|=
name|device_get_softc
argument_list|(
name|sc
operator|->
name|rt_miibus
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|RT_DPRINTF
argument_list|(
name|sc
argument_list|,
name|RT_DEBUG_ANY
argument_list|,
literal|"initializing\n"
argument_list|)
expr_stmt|;
name|RT_SOFTC_ASSERT_LOCKED
argument_list|(
name|sc
argument_list|)
expr_stmt|;
comment|/* hardware reset */
comment|//RT_WRITE(sc, GE_PORT_BASE + FE_RST_GLO, PSE_RESET);
comment|//rt305x_sysctl_set(SYSCTL_RSTCTRL, SYSCTL_RSTCTRL_FRENG);
comment|/* Fwd to CPU (uni|broad|multi)cast and Unknown */
if|if
condition|(
name|sc
operator|->
name|gdma1_base
operator|!=
literal|0
condition|)
name|RT_WRITE
argument_list|(
name|sc
argument_list|,
name|sc
operator|->
name|gdma1_base
operator|+
name|GDMA_FWD_CFG
argument_list|,
operator|(
name|GDM_ICS_EN
operator||
comment|/* Enable IP Csum */
name|GDM_TCS_EN
operator||
comment|/* Enable TCP Csum */
name|GDM_UCS_EN
operator||
comment|/* Enable UDP Csum */
name|GDM_STRPCRC
operator||
comment|/* Strip CRC from packet */
name|GDM_DST_PORT_CPU
operator|<<
name|GDM_UFRC_P_SHIFT
operator||
comment|/* fwd UCast to CPU */
name|GDM_DST_PORT_CPU
operator|<<
name|GDM_BFRC_P_SHIFT
operator||
comment|/* fwd BCast to CPU */
name|GDM_DST_PORT_CPU
operator|<<
name|GDM_MFRC_P_SHIFT
operator||
comment|/* fwd MCast to CPU */
name|GDM_DST_PORT_CPU
operator|<<
name|GDM_OFRC_P_SHIFT
comment|/* fwd Other to CPU */
operator|)
argument_list|)
expr_stmt|;
comment|/* disable DMA engine */
name|RT_WRITE
argument_list|(
name|sc
argument_list|,
name|sc
operator|->
name|pdma_glo_cfg
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|RT_WRITE
argument_list|(
name|sc
argument_list|,
name|sc
operator|->
name|pdma_rst_idx
argument_list|,
literal|0xffffffff
argument_list|)
expr_stmt|;
comment|/* wait while DMA engine is busy */
for|for
control|(
name|ntries
operator|=
literal|0
init|;
name|ntries
operator|<
literal|100
condition|;
name|ntries
operator|++
control|)
block|{
name|tmp
operator|=
name|RT_READ
argument_list|(
name|sc
argument_list|,
name|sc
operator|->
name|pdma_glo_cfg
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|tmp
operator|&
operator|(
name|FE_TX_DMA_BUSY
operator||
name|FE_RX_DMA_BUSY
operator|)
operator|)
condition|)
break|break;
name|DELAY
argument_list|(
literal|1000
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|ntries
operator|==
literal|100
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
literal|"timeout waiting for DMA engine\n"
argument_list|)
expr_stmt|;
goto|goto
name|fail
goto|;
block|}
comment|/* reset Rx and Tx rings */
name|tmp
operator|=
name|FE_RST_DRX_IDX0
operator||
name|FE_RST_DTX_IDX3
operator||
name|FE_RST_DTX_IDX2
operator||
name|FE_RST_DTX_IDX1
operator||
name|FE_RST_DTX_IDX0
expr_stmt|;
name|RT_WRITE
argument_list|(
name|sc
argument_list|,
name|sc
operator|->
name|pdma_rst_idx
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
comment|/* XXX switch set mac address */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|RT_SOFTC_TX_RING_COUNT
condition|;
name|i
operator|++
control|)
name|rt_reset_tx_ring
argument_list|(
name|sc
argument_list|,
operator|&
name|sc
operator|->
name|tx_ring
index|[
name|i
index|]
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|RT_SOFTC_TX_RING_COUNT
condition|;
name|i
operator|++
control|)
block|{
comment|/* update TX_BASE_PTRx */
name|RT_WRITE
argument_list|(
name|sc
argument_list|,
name|sc
operator|->
name|tx_base_ptr
index|[
name|i
index|]
argument_list|,
name|sc
operator|->
name|tx_ring
index|[
name|i
index|]
operator|.
name|desc_phys_addr
argument_list|)
expr_stmt|;
name|RT_WRITE
argument_list|(
name|sc
argument_list|,
name|sc
operator|->
name|tx_max_cnt
index|[
name|i
index|]
argument_list|,
name|RT_SOFTC_TX_RING_DESC_COUNT
argument_list|)
expr_stmt|;
name|RT_WRITE
argument_list|(
name|sc
argument_list|,
name|sc
operator|->
name|tx_ctx_idx
index|[
name|i
index|]
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
comment|/* init Rx ring */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|sc
operator|->
name|rx_ring_count
condition|;
name|i
operator|++
control|)
name|rt_reset_rx_ring
argument_list|(
name|sc
argument_list|,
operator|&
name|sc
operator|->
name|rx_ring
index|[
name|i
index|]
argument_list|)
expr_stmt|;
comment|/* update RX_BASE_PTRx */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|sc
operator|->
name|rx_ring_count
condition|;
name|i
operator|++
control|)
block|{
name|RT_WRITE
argument_list|(
name|sc
argument_list|,
name|sc
operator|->
name|rx_base_ptr
index|[
name|i
index|]
argument_list|,
name|sc
operator|->
name|rx_ring
index|[
name|i
index|]
operator|.
name|desc_phys_addr
argument_list|)
expr_stmt|;
name|RT_WRITE
argument_list|(
name|sc
argument_list|,
name|sc
operator|->
name|rx_max_cnt
index|[
name|i
index|]
argument_list|,
name|RT_SOFTC_RX_RING_DATA_COUNT
argument_list|)
expr_stmt|;
name|RT_WRITE
argument_list|(
name|sc
argument_list|,
name|sc
operator|->
name|rx_calc_idx
index|[
name|i
index|]
argument_list|,
name|RT_SOFTC_RX_RING_DATA_COUNT
operator|-
literal|1
argument_list|)
expr_stmt|;
block|}
comment|/* write back DDONE, 16byte burst enable RX/TX DMA */
name|tmp
operator|=
name|FE_TX_WB_DDONE
operator||
name|FE_DMA_BT_SIZE16
operator||
name|FE_RX_DMA_EN
operator||
name|FE_TX_DMA_EN
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|rt_chipid
operator|==
name|RT_CHIPID_MT7620
operator|||
name|sc
operator|->
name|rt_chipid
operator|==
name|RT_CHIPID_MT7621
condition|)
name|tmp
operator||=
operator|(
literal|1
operator|<<
literal|31
operator|)
expr_stmt|;
name|RT_WRITE
argument_list|(
name|sc
argument_list|,
name|sc
operator|->
name|pdma_glo_cfg
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
comment|/* disable interrupts mitigation */
name|RT_WRITE
argument_list|(
name|sc
argument_list|,
name|sc
operator|->
name|delay_int_cfg
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* clear pending interrupts */
name|RT_WRITE
argument_list|(
name|sc
argument_list|,
name|sc
operator|->
name|fe_int_status
argument_list|,
literal|0xffffffff
argument_list|)
expr_stmt|;
comment|/* enable interrupts */
if|if
condition|(
name|sc
operator|->
name|rt_chipid
operator|==
name|RT_CHIPID_RT5350
operator|||
name|sc
operator|->
name|rt_chipid
operator|==
name|RT_CHIPID_MT7620
operator|||
name|sc
operator|->
name|rt_chipid
operator|==
name|RT_CHIPID_MT7621
condition|)
name|tmp
operator|=
name|RT5350_INT_TX_COHERENT
operator||
name|RT5350_INT_RX_COHERENT
operator||
name|RT5350_INT_TXQ3_DONE
operator||
name|RT5350_INT_TXQ2_DONE
operator||
name|RT5350_INT_TXQ1_DONE
operator||
name|RT5350_INT_TXQ0_DONE
operator||
name|RT5350_INT_RXQ1_DONE
operator||
name|RT5350_INT_RXQ0_DONE
expr_stmt|;
else|else
name|tmp
operator|=
name|CNT_PPE_AF
operator||
name|CNT_GDM_AF
operator||
name|PSE_P2_FC
operator||
name|GDM_CRC_DROP
operator||
name|PSE_BUF_DROP
operator||
name|GDM_OTHER_DROP
operator||
name|PSE_P1_FC
operator||
name|PSE_P0_FC
operator||
name|PSE_FQ_EMPTY
operator||
name|INT_TX_COHERENT
operator||
name|INT_RX_COHERENT
operator||
name|INT_TXQ3_DONE
operator||
name|INT_TXQ2_DONE
operator||
name|INT_TXQ1_DONE
operator||
name|INT_TXQ0_DONE
operator||
name|INT_RX_DONE
expr_stmt|;
name|sc
operator|->
name|intr_enable_mask
operator|=
name|tmp
expr_stmt|;
name|RT_WRITE
argument_list|(
name|sc
argument_list|,
name|sc
operator|->
name|fe_int_enable
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
if|if
condition|(
name|rt_txrx_enable
argument_list|(
name|sc
argument_list|)
operator|!=
literal|0
condition|)
goto|goto
name|fail
goto|;
ifdef|#
directive|ifdef
name|IF_RT_PHY_SUPPORT
if|if
condition|(
name|mii
condition|)
name|mii_mediachg
argument_list|(
name|mii
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* IF_RT_PHY_SUPPORT */
name|ifp
operator|->
name|if_drv_flags
operator|&=
operator|~
name|IFF_DRV_OACTIVE
expr_stmt|;
name|ifp
operator|->
name|if_drv_flags
operator||=
name|IFF_DRV_RUNNING
expr_stmt|;
name|sc
operator|->
name|periodic_round
operator|=
literal|0
expr_stmt|;
name|callout_reset
argument_list|(
operator|&
name|sc
operator|->
name|periodic_ch
argument_list|,
name|hz
operator|/
literal|10
argument_list|,
name|rt_periodic
argument_list|,
name|sc
argument_list|)
expr_stmt|;
return|return;
name|fail
label|:
name|rt_stop_locked
argument_list|(
name|sc
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * rt_init - lock and initialize device.  */
end_comment

begin_function
specifier|static
name|void
name|rt_init
parameter_list|(
name|void
modifier|*
name|priv
parameter_list|)
block|{
name|struct
name|rt_softc
modifier|*
name|sc
decl_stmt|;
name|sc
operator|=
name|priv
expr_stmt|;
name|RT_SOFTC_LOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|rt_init_locked
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|RT_SOFTC_UNLOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * rt_stop_locked - stop TX/RX w/ lock  */
end_comment

begin_function
specifier|static
name|void
name|rt_stop_locked
parameter_list|(
name|void
modifier|*
name|priv
parameter_list|)
block|{
name|struct
name|rt_softc
modifier|*
name|sc
decl_stmt|;
name|struct
name|ifnet
modifier|*
name|ifp
decl_stmt|;
name|sc
operator|=
name|priv
expr_stmt|;
name|ifp
operator|=
name|sc
operator|->
name|ifp
expr_stmt|;
name|RT_DPRINTF
argument_list|(
name|sc
argument_list|,
name|RT_DEBUG_ANY
argument_list|,
literal|"stopping\n"
argument_list|)
expr_stmt|;
name|RT_SOFTC_ASSERT_LOCKED
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|sc
operator|->
name|tx_timer
operator|=
literal|0
expr_stmt|;
name|ifp
operator|->
name|if_drv_flags
operator|&=
operator|~
operator|(
name|IFF_DRV_RUNNING
operator||
name|IFF_DRV_OACTIVE
operator|)
expr_stmt|;
name|callout_stop
argument_list|(
operator|&
name|sc
operator|->
name|periodic_ch
argument_list|)
expr_stmt|;
name|callout_stop
argument_list|(
operator|&
name|sc
operator|->
name|tx_watchdog_ch
argument_list|)
expr_stmt|;
name|RT_SOFTC_UNLOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|taskqueue_block
argument_list|(
name|sc
operator|->
name|taskqueue
argument_list|)
expr_stmt|;
comment|/* 	 * Sometime rt_stop_locked called from isr and we get panic 	 * When found, I fix it 	 */
ifdef|#
directive|ifdef
name|notyet
name|taskqueue_drain
argument_list|(
name|sc
operator|->
name|taskqueue
argument_list|,
operator|&
name|sc
operator|->
name|rx_done_task
argument_list|)
expr_stmt|;
name|taskqueue_drain
argument_list|(
name|sc
operator|->
name|taskqueue
argument_list|,
operator|&
name|sc
operator|->
name|tx_done_task
argument_list|)
expr_stmt|;
name|taskqueue_drain
argument_list|(
name|sc
operator|->
name|taskqueue
argument_list|,
operator|&
name|sc
operator|->
name|periodic_task
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|RT_SOFTC_LOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
comment|/* disable interrupts */
name|RT_WRITE
argument_list|(
name|sc
argument_list|,
name|sc
operator|->
name|fe_int_enable
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|rt_chipid
operator|!=
name|RT_CHIPID_RT5350
operator|&&
name|sc
operator|->
name|rt_chipid
operator|!=
name|RT_CHIPID_MT7620
operator|&&
name|sc
operator|->
name|rt_chipid
operator|!=
name|RT_CHIPID_MT7621
condition|)
block|{
comment|/* reset adapter */
name|RT_WRITE
argument_list|(
name|sc
argument_list|,
name|GE_PORT_BASE
operator|+
name|FE_RST_GLO
argument_list|,
name|PSE_RESET
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|sc
operator|->
name|gdma1_base
operator|!=
literal|0
condition|)
name|RT_WRITE
argument_list|(
name|sc
argument_list|,
name|sc
operator|->
name|gdma1_base
operator|+
name|GDMA_FWD_CFG
argument_list|,
operator|(
name|GDM_ICS_EN
operator||
comment|/* Enable IP Csum */
name|GDM_TCS_EN
operator||
comment|/* Enable TCP Csum */
name|GDM_UCS_EN
operator||
comment|/* Enable UDP Csum */
name|GDM_STRPCRC
operator||
comment|/* Strip CRC from packet */
name|GDM_DST_PORT_CPU
operator|<<
name|GDM_UFRC_P_SHIFT
operator||
comment|/* fwd UCast to CPU */
name|GDM_DST_PORT_CPU
operator|<<
name|GDM_BFRC_P_SHIFT
operator||
comment|/* fwd BCast to CPU */
name|GDM_DST_PORT_CPU
operator|<<
name|GDM_MFRC_P_SHIFT
operator||
comment|/* fwd MCast to CPU */
name|GDM_DST_PORT_CPU
operator|<<
name|GDM_OFRC_P_SHIFT
comment|/* fwd Other to CPU */
operator|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|rt_stop
parameter_list|(
name|void
modifier|*
name|priv
parameter_list|)
block|{
name|struct
name|rt_softc
modifier|*
name|sc
decl_stmt|;
name|sc
operator|=
name|priv
expr_stmt|;
name|RT_SOFTC_LOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|rt_stop_locked
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|RT_SOFTC_UNLOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * rt_tx_data - transmit packet.  */
end_comment

begin_function
specifier|static
name|int
name|rt_tx_data
parameter_list|(
name|struct
name|rt_softc
modifier|*
name|sc
parameter_list|,
name|struct
name|mbuf
modifier|*
name|m
parameter_list|,
name|int
name|qid
parameter_list|)
block|{
name|struct
name|ifnet
modifier|*
name|ifp
decl_stmt|;
name|struct
name|rt_softc_tx_ring
modifier|*
name|ring
decl_stmt|;
name|struct
name|rt_softc_tx_data
modifier|*
name|data
decl_stmt|;
name|struct
name|rt_txdesc
modifier|*
name|desc
decl_stmt|;
name|struct
name|mbuf
modifier|*
name|m_d
decl_stmt|;
name|bus_dma_segment_t
name|dma_seg
index|[
name|RT_SOFTC_MAX_SCATTER
index|]
decl_stmt|;
name|int
name|error
decl_stmt|,
name|ndmasegs
decl_stmt|,
name|ndescs
decl_stmt|,
name|i
decl_stmt|;
name|KASSERT
argument_list|(
name|qid
operator|>=
literal|0
operator|&&
name|qid
operator|<
name|RT_SOFTC_TX_RING_COUNT
argument_list|,
operator|(
literal|"%s: Tx data: invalid qid=%d\n"
operator|,
name|device_get_nameunit
argument_list|(
name|sc
operator|->
name|dev
argument_list|)
operator|,
name|qid
operator|)
argument_list|)
expr_stmt|;
name|RT_SOFTC_TX_RING_ASSERT_LOCKED
argument_list|(
operator|&
name|sc
operator|->
name|tx_ring
index|[
name|qid
index|]
argument_list|)
expr_stmt|;
name|ifp
operator|=
name|sc
operator|->
name|ifp
expr_stmt|;
name|ring
operator|=
operator|&
name|sc
operator|->
name|tx_ring
index|[
name|qid
index|]
expr_stmt|;
name|desc
operator|=
operator|&
name|ring
operator|->
name|desc
index|[
name|ring
operator|->
name|desc_cur
index|]
expr_stmt|;
name|data
operator|=
operator|&
name|ring
operator|->
name|data
index|[
name|ring
operator|->
name|data_cur
index|]
expr_stmt|;
name|error
operator|=
name|bus_dmamap_load_mbuf_sg
argument_list|(
name|ring
operator|->
name|data_dma_tag
argument_list|,
name|data
operator|->
name|dma_map
argument_list|,
name|m
argument_list|,
name|dma_seg
argument_list|,
operator|&
name|ndmasegs
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|!=
literal|0
condition|)
block|{
comment|/* too many fragments, linearize */
name|RT_DPRINTF
argument_list|(
name|sc
argument_list|,
name|RT_DEBUG_TX
argument_list|,
literal|"could not load mbuf DMA map, trying to linearize "
literal|"mbuf: ndmasegs=%d, len=%d, error=%d\n"
argument_list|,
name|ndmasegs
argument_list|,
name|m
operator|->
name|m_pkthdr
operator|.
name|len
argument_list|,
name|error
argument_list|)
expr_stmt|;
name|m_d
operator|=
name|m_collapse
argument_list|(
name|m
argument_list|,
name|M_NOWAIT
argument_list|,
literal|16
argument_list|)
expr_stmt|;
if|if
condition|(
name|m_d
operator|==
name|NULL
condition|)
block|{
name|m_freem
argument_list|(
name|m
argument_list|)
expr_stmt|;
name|m
operator|=
name|NULL
expr_stmt|;
return|return
operator|(
name|ENOMEM
operator|)
return|;
block|}
name|m
operator|=
name|m_d
expr_stmt|;
name|sc
operator|->
name|tx_defrag_packets
operator|++
expr_stmt|;
name|error
operator|=
name|bus_dmamap_load_mbuf_sg
argument_list|(
name|ring
operator|->
name|data_dma_tag
argument_list|,
name|data
operator|->
name|dma_map
argument_list|,
name|m
argument_list|,
name|dma_seg
argument_list|,
operator|&
name|ndmasegs
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|!=
literal|0
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
literal|"could not load mbuf DMA map: "
literal|"ndmasegs=%d, len=%d, error=%d\n"
argument_list|,
name|ndmasegs
argument_list|,
name|m
operator|->
name|m_pkthdr
operator|.
name|len
argument_list|,
name|error
argument_list|)
expr_stmt|;
name|m_freem
argument_list|(
name|m
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
block|}
if|if
condition|(
name|m
operator|->
name|m_pkthdr
operator|.
name|len
operator|==
literal|0
condition|)
name|ndmasegs
operator|=
literal|0
expr_stmt|;
comment|/* determine how many Tx descs are required */
name|ndescs
operator|=
literal|1
operator|+
name|ndmasegs
operator|/
literal|2
expr_stmt|;
if|if
condition|(
operator|(
name|ring
operator|->
name|desc_queued
operator|+
name|ndescs
operator|)
operator|>
operator|(
name|RT_SOFTC_TX_RING_DESC_COUNT
operator|-
literal|2
operator|)
condition|)
block|{
name|RT_DPRINTF
argument_list|(
name|sc
argument_list|,
name|RT_DEBUG_TX
argument_list|,
literal|"there are not enough Tx descs\n"
argument_list|)
expr_stmt|;
name|sc
operator|->
name|no_tx_desc_avail
operator|++
expr_stmt|;
name|bus_dmamap_unload
argument_list|(
name|ring
operator|->
name|data_dma_tag
argument_list|,
name|data
operator|->
name|dma_map
argument_list|)
expr_stmt|;
name|m_freem
argument_list|(
name|m
argument_list|)
expr_stmt|;
return|return
operator|(
name|EFBIG
operator|)
return|;
block|}
name|data
operator|->
name|m
operator|=
name|m
expr_stmt|;
comment|/* set up Tx descs */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|ndmasegs
condition|;
name|i
operator|+=
literal|2
control|)
block|{
comment|/* TODO: this needs to be refined as MT7620 for example has 		 * a different word3 layout than RT305x and RT5350 (the last 		 * one doesn't use word3 at all). And so does MT7621... 		 */
if|if
condition|(
name|sc
operator|->
name|rt_chipid
operator|!=
name|RT_CHIPID_MT7621
condition|)
block|{
comment|/* Set destination */
if|if
condition|(
name|sc
operator|->
name|rt_chipid
operator|!=
name|RT_CHIPID_MT7620
condition|)
name|desc
operator|->
name|dst
operator|=
operator|(
name|TXDSCR_DST_PORT_GDMA1
operator|)
expr_stmt|;
if|if
condition|(
operator|(
name|ifp
operator|->
name|if_capenable
operator|&
name|IFCAP_TXCSUM
operator|)
operator|!=
literal|0
condition|)
name|desc
operator|->
name|dst
operator||=
operator|(
name|TXDSCR_IP_CSUM_GEN
operator||
name|TXDSCR_UDP_CSUM_GEN
operator||
name|TXDSCR_TCP_CSUM_GEN
operator|)
expr_stmt|;
comment|/* Set queue id */
name|desc
operator|->
name|qn
operator|=
name|qid
expr_stmt|;
comment|/* No PPPoE */
name|desc
operator|->
name|pppoe
operator|=
literal|0
expr_stmt|;
comment|/* No VLAN */
name|desc
operator|->
name|vid
operator|=
literal|0
expr_stmt|;
block|}
else|else
block|{
name|desc
operator|->
name|vid
operator|=
literal|0
expr_stmt|;
name|desc
operator|->
name|pppoe
operator|=
literal|0
expr_stmt|;
name|desc
operator|->
name|qn
operator|=
literal|0
expr_stmt|;
name|desc
operator|->
name|dst
operator|=
literal|2
expr_stmt|;
block|}
name|desc
operator|->
name|sdp0
operator|=
name|htole32
argument_list|(
name|dma_seg
index|[
name|i
index|]
operator|.
name|ds_addr
argument_list|)
expr_stmt|;
name|desc
operator|->
name|sdl0
operator|=
name|htole16
argument_list|(
name|dma_seg
index|[
name|i
index|]
operator|.
name|ds_len
operator||
operator|(
operator|(
operator|(
name|i
operator|+
literal|1
operator|)
operator|==
name|ndmasegs
operator|)
condition|?
name|RT_TXDESC_SDL0_LASTSEG
else|:
literal|0
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|i
operator|+
literal|1
operator|)
operator|<
name|ndmasegs
condition|)
block|{
name|desc
operator|->
name|sdp1
operator|=
name|htole32
argument_list|(
name|dma_seg
index|[
name|i
operator|+
literal|1
index|]
operator|.
name|ds_addr
argument_list|)
expr_stmt|;
name|desc
operator|->
name|sdl1
operator|=
name|htole16
argument_list|(
name|dma_seg
index|[
name|i
operator|+
literal|1
index|]
operator|.
name|ds_len
operator||
operator|(
operator|(
operator|(
name|i
operator|+
literal|2
operator|)
operator|==
name|ndmasegs
operator|)
condition|?
name|RT_TXDESC_SDL1_LASTSEG
else|:
literal|0
operator|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|desc
operator|->
name|sdp1
operator|=
literal|0
expr_stmt|;
name|desc
operator|->
name|sdl1
operator|=
literal|0
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|i
operator|+
literal|2
operator|)
operator|<
name|ndmasegs
condition|)
block|{
name|ring
operator|->
name|desc_queued
operator|++
expr_stmt|;
name|ring
operator|->
name|desc_cur
operator|=
operator|(
name|ring
operator|->
name|desc_cur
operator|+
literal|1
operator|)
operator|%
name|RT_SOFTC_TX_RING_DESC_COUNT
expr_stmt|;
block|}
name|desc
operator|=
operator|&
name|ring
operator|->
name|desc
index|[
name|ring
operator|->
name|desc_cur
index|]
expr_stmt|;
block|}
name|RT_DPRINTF
argument_list|(
name|sc
argument_list|,
name|RT_DEBUG_TX
argument_list|,
literal|"sending data: len=%d, ndmasegs=%d, "
literal|"DMA ds_len=%d/%d/%d/%d/%d\n"
argument_list|,
name|m
operator|->
name|m_pkthdr
operator|.
name|len
argument_list|,
name|ndmasegs
argument_list|,
operator|(
name|int
operator|)
name|dma_seg
index|[
literal|0
index|]
operator|.
name|ds_len
argument_list|,
operator|(
name|int
operator|)
name|dma_seg
index|[
literal|1
index|]
operator|.
name|ds_len
argument_list|,
operator|(
name|int
operator|)
name|dma_seg
index|[
literal|2
index|]
operator|.
name|ds_len
argument_list|,
operator|(
name|int
operator|)
name|dma_seg
index|[
literal|3
index|]
operator|.
name|ds_len
argument_list|,
operator|(
name|int
operator|)
name|dma_seg
index|[
literal|4
index|]
operator|.
name|ds_len
argument_list|)
expr_stmt|;
name|bus_dmamap_sync
argument_list|(
name|ring
operator|->
name|seg0_dma_tag
argument_list|,
name|ring
operator|->
name|seg0_dma_map
argument_list|,
name|BUS_DMASYNC_PREWRITE
argument_list|)
expr_stmt|;
name|bus_dmamap_sync
argument_list|(
name|ring
operator|->
name|data_dma_tag
argument_list|,
name|data
operator|->
name|dma_map
argument_list|,
name|BUS_DMASYNC_PREWRITE
argument_list|)
expr_stmt|;
name|bus_dmamap_sync
argument_list|(
name|ring
operator|->
name|desc_dma_tag
argument_list|,
name|ring
operator|->
name|desc_dma_map
argument_list|,
name|BUS_DMASYNC_PREWRITE
argument_list|)
expr_stmt|;
name|ring
operator|->
name|desc_queued
operator|++
expr_stmt|;
name|ring
operator|->
name|desc_cur
operator|=
operator|(
name|ring
operator|->
name|desc_cur
operator|+
literal|1
operator|)
operator|%
name|RT_SOFTC_TX_RING_DESC_COUNT
expr_stmt|;
name|ring
operator|->
name|data_queued
operator|++
expr_stmt|;
name|ring
operator|->
name|data_cur
operator|=
operator|(
name|ring
operator|->
name|data_cur
operator|+
literal|1
operator|)
operator|%
name|RT_SOFTC_TX_RING_DATA_COUNT
expr_stmt|;
comment|/* kick Tx */
name|RT_WRITE
argument_list|(
name|sc
argument_list|,
name|sc
operator|->
name|tx_ctx_idx
index|[
name|qid
index|]
argument_list|,
name|ring
operator|->
name|desc_cur
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * rt_start - start Transmit/Receive  */
end_comment

begin_function
specifier|static
name|void
name|rt_start
parameter_list|(
name|struct
name|ifnet
modifier|*
name|ifp
parameter_list|)
block|{
name|struct
name|rt_softc
modifier|*
name|sc
decl_stmt|;
name|struct
name|mbuf
modifier|*
name|m
decl_stmt|;
name|int
name|qid
init|=
literal|0
comment|/* XXX must check QoS priority */
decl_stmt|;
name|sc
operator|=
name|ifp
operator|->
name|if_softc
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|ifp
operator|->
name|if_drv_flags
operator|&
name|IFF_DRV_RUNNING
operator|)
condition|)
return|return;
for|for
control|(
init|;
condition|;
control|)
block|{
name|IFQ_DRV_DEQUEUE
argument_list|(
operator|&
name|ifp
operator|->
name|if_snd
argument_list|,
name|m
argument_list|)
expr_stmt|;
if|if
condition|(
name|m
operator|==
name|NULL
condition|)
break|break;
name|m
operator|->
name|m_pkthdr
operator|.
name|rcvif
operator|=
name|NULL
expr_stmt|;
name|RT_SOFTC_TX_RING_LOCK
argument_list|(
operator|&
name|sc
operator|->
name|tx_ring
index|[
name|qid
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|tx_ring
index|[
name|qid
index|]
operator|.
name|data_queued
operator|>=
name|RT_SOFTC_TX_RING_DATA_COUNT
condition|)
block|{
name|RT_SOFTC_TX_RING_UNLOCK
argument_list|(
operator|&
name|sc
operator|->
name|tx_ring
index|[
name|qid
index|]
argument_list|)
expr_stmt|;
name|RT_DPRINTF
argument_list|(
name|sc
argument_list|,
name|RT_DEBUG_TX
argument_list|,
literal|"if_start: Tx ring with qid=%d is full\n"
argument_list|,
name|qid
argument_list|)
expr_stmt|;
name|m_freem
argument_list|(
name|m
argument_list|)
expr_stmt|;
name|ifp
operator|->
name|if_drv_flags
operator||=
name|IFF_DRV_OACTIVE
expr_stmt|;
name|if_inc_counter
argument_list|(
name|ifp
argument_list|,
name|IFCOUNTER_OERRORS
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|sc
operator|->
name|tx_data_queue_full
index|[
name|qid
index|]
operator|++
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|rt_tx_data
argument_list|(
name|sc
argument_list|,
name|m
argument_list|,
name|qid
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|RT_SOFTC_TX_RING_UNLOCK
argument_list|(
operator|&
name|sc
operator|->
name|tx_ring
index|[
name|qid
index|]
argument_list|)
expr_stmt|;
name|if_inc_counter
argument_list|(
name|ifp
argument_list|,
name|IFCOUNTER_OERRORS
argument_list|,
literal|1
argument_list|)
expr_stmt|;
break|break;
block|}
name|RT_SOFTC_TX_RING_UNLOCK
argument_list|(
operator|&
name|sc
operator|->
name|tx_ring
index|[
name|qid
index|]
argument_list|)
expr_stmt|;
name|sc
operator|->
name|tx_timer
operator|=
name|RT_TX_WATCHDOG_TIMEOUT
expr_stmt|;
name|callout_reset
argument_list|(
operator|&
name|sc
operator|->
name|tx_watchdog_ch
argument_list|,
name|hz
argument_list|,
name|rt_tx_watchdog
argument_list|,
name|sc
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/*  * rt_update_promisc - set/clear promiscuous mode. Unused yet, because  * filtering done by attached Ethernet switch.  */
end_comment

begin_function
specifier|static
name|void
name|rt_update_promisc
parameter_list|(
name|struct
name|ifnet
modifier|*
name|ifp
parameter_list|)
block|{
name|struct
name|rt_softc
modifier|*
name|sc
decl_stmt|;
name|sc
operator|=
name|ifp
operator|->
name|if_softc
expr_stmt|;
name|printf
argument_list|(
literal|"%s: %s promiscuous mode\n"
argument_list|,
name|device_get_nameunit
argument_list|(
name|sc
operator|->
name|dev
argument_list|)
argument_list|,
operator|(
name|ifp
operator|->
name|if_flags
operator|&
name|IFF_PROMISC
operator|)
condition|?
literal|"entering"
else|:
literal|"leaving"
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * rt_ioctl - ioctl handler.  */
end_comment

begin_function
specifier|static
name|int
name|rt_ioctl
parameter_list|(
name|struct
name|ifnet
modifier|*
name|ifp
parameter_list|,
name|u_long
name|cmd
parameter_list|,
name|caddr_t
name|data
parameter_list|)
block|{
name|struct
name|rt_softc
modifier|*
name|sc
decl_stmt|;
name|struct
name|ifreq
modifier|*
name|ifr
decl_stmt|;
ifdef|#
directive|ifdef
name|IF_RT_PHY_SUPPORT
name|struct
name|mii_data
modifier|*
name|mii
decl_stmt|;
endif|#
directive|endif
comment|/* IF_RT_PHY_SUPPORT */
name|int
name|error
decl_stmt|,
name|startall
decl_stmt|;
name|sc
operator|=
name|ifp
operator|->
name|if_softc
expr_stmt|;
name|ifr
operator|=
operator|(
expr|struct
name|ifreq
operator|*
operator|)
name|data
expr_stmt|;
name|error
operator|=
literal|0
expr_stmt|;
switch|switch
condition|(
name|cmd
condition|)
block|{
case|case
name|SIOCSIFFLAGS
case|:
name|startall
operator|=
literal|0
expr_stmt|;
name|RT_SOFTC_LOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
if|if
condition|(
name|ifp
operator|->
name|if_flags
operator|&
name|IFF_UP
condition|)
block|{
if|if
condition|(
name|ifp
operator|->
name|if_drv_flags
operator|&
name|IFF_DRV_RUNNING
condition|)
block|{
if|if
condition|(
operator|(
name|ifp
operator|->
name|if_flags
operator|^
name|sc
operator|->
name|if_flags
operator|)
operator|&
name|IFF_PROMISC
condition|)
name|rt_update_promisc
argument_list|(
name|ifp
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|rt_init_locked
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|startall
operator|=
literal|1
expr_stmt|;
block|}
block|}
else|else
block|{
if|if
condition|(
name|ifp
operator|->
name|if_drv_flags
operator|&
name|IFF_DRV_RUNNING
condition|)
name|rt_stop_locked
argument_list|(
name|sc
argument_list|)
expr_stmt|;
block|}
name|sc
operator|->
name|if_flags
operator|=
name|ifp
operator|->
name|if_flags
expr_stmt|;
name|RT_SOFTC_UNLOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
break|break;
case|case
name|SIOCGIFMEDIA
case|:
case|case
name|SIOCSIFMEDIA
case|:
ifdef|#
directive|ifdef
name|IF_RT_PHY_SUPPORT
name|mii
operator|=
name|device_get_softc
argument_list|(
name|sc
operator|->
name|rt_miibus
argument_list|)
expr_stmt|;
name|error
operator|=
name|ifmedia_ioctl
argument_list|(
name|ifp
argument_list|,
name|ifr
argument_list|,
operator|&
name|mii
operator|->
name|mii_media
argument_list|,
name|cmd
argument_list|)
expr_stmt|;
else|#
directive|else
name|error
operator|=
name|ifmedia_ioctl
argument_list|(
name|ifp
argument_list|,
name|ifr
argument_list|,
operator|&
name|sc
operator|->
name|rt_ifmedia
argument_list|,
name|cmd
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* IF_RT_PHY_SUPPORT */
break|break;
default|default:
name|error
operator|=
name|ether_ioctl
argument_list|(
name|ifp
argument_list|,
name|cmd
argument_list|,
name|data
argument_list|)
expr_stmt|;
break|break;
block|}
return|return
operator|(
name|error
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * rt_periodic - Handler of PERIODIC interrupt  */
end_comment

begin_function
specifier|static
name|void
name|rt_periodic
parameter_list|(
name|void
modifier|*
name|arg
parameter_list|)
block|{
name|struct
name|rt_softc
modifier|*
name|sc
decl_stmt|;
name|sc
operator|=
name|arg
expr_stmt|;
name|RT_DPRINTF
argument_list|(
name|sc
argument_list|,
name|RT_DEBUG_PERIODIC
argument_list|,
literal|"periodic\n"
argument_list|)
expr_stmt|;
name|taskqueue_enqueue
argument_list|(
name|sc
operator|->
name|taskqueue
argument_list|,
operator|&
name|sc
operator|->
name|periodic_task
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * rt_tx_watchdog - Handler of TX Watchdog  */
end_comment

begin_function
specifier|static
name|void
name|rt_tx_watchdog
parameter_list|(
name|void
modifier|*
name|arg
parameter_list|)
block|{
name|struct
name|rt_softc
modifier|*
name|sc
decl_stmt|;
name|struct
name|ifnet
modifier|*
name|ifp
decl_stmt|;
name|sc
operator|=
name|arg
expr_stmt|;
name|ifp
operator|=
name|sc
operator|->
name|ifp
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|tx_timer
operator|==
literal|0
condition|)
return|return;
if|if
condition|(
operator|--
name|sc
operator|->
name|tx_timer
operator|==
literal|0
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
literal|"Tx watchdog timeout: resetting\n"
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|notyet
comment|/* 		 * XXX: Commented out, because reset break input. 		 */
name|rt_stop_locked
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|rt_init_locked
argument_list|(
name|sc
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|if_inc_counter
argument_list|(
name|ifp
argument_list|,
name|IFCOUNTER_OERRORS
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|sc
operator|->
name|tx_watchdog_timeouts
operator|++
expr_stmt|;
block|}
name|callout_reset
argument_list|(
operator|&
name|sc
operator|->
name|tx_watchdog_ch
argument_list|,
name|hz
argument_list|,
name|rt_tx_watchdog
argument_list|,
name|sc
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * rt_cnt_ppe_af - Handler of PPE Counter Table Almost Full interrupt  */
end_comment

begin_function
specifier|static
name|void
name|rt_cnt_ppe_af
parameter_list|(
name|struct
name|rt_softc
modifier|*
name|sc
parameter_list|)
block|{
name|RT_DPRINTF
argument_list|(
name|sc
argument_list|,
name|RT_DEBUG_INTR
argument_list|,
literal|"PPE Counter Table Almost Full\n"
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * rt_cnt_gdm_af - Handler of GDMA 1& 2 Counter Table Almost Full interrupt  */
end_comment

begin_function
specifier|static
name|void
name|rt_cnt_gdm_af
parameter_list|(
name|struct
name|rt_softc
modifier|*
name|sc
parameter_list|)
block|{
name|RT_DPRINTF
argument_list|(
name|sc
argument_list|,
name|RT_DEBUG_INTR
argument_list|,
literal|"GDMA 1& 2 Counter Table Almost Full\n"
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * rt_pse_p2_fc - Handler of PSE port2 (GDMA 2) flow control interrupt  */
end_comment

begin_function
specifier|static
name|void
name|rt_pse_p2_fc
parameter_list|(
name|struct
name|rt_softc
modifier|*
name|sc
parameter_list|)
block|{
name|RT_DPRINTF
argument_list|(
name|sc
argument_list|,
name|RT_DEBUG_INTR
argument_list|,
literal|"PSE port2 (GDMA 2) flow control asserted.\n"
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * rt_gdm_crc_drop - Handler of GDMA 1/2 discard a packet due to CRC error  * interrupt  */
end_comment

begin_function
specifier|static
name|void
name|rt_gdm_crc_drop
parameter_list|(
name|struct
name|rt_softc
modifier|*
name|sc
parameter_list|)
block|{
name|RT_DPRINTF
argument_list|(
name|sc
argument_list|,
name|RT_DEBUG_INTR
argument_list|,
literal|"GDMA 1& 2 discard a packet due to CRC error\n"
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * rt_pse_buf_drop - Handler of buffer sharing limitation interrupt  */
end_comment

begin_function
specifier|static
name|void
name|rt_pse_buf_drop
parameter_list|(
name|struct
name|rt_softc
modifier|*
name|sc
parameter_list|)
block|{
name|RT_DPRINTF
argument_list|(
name|sc
argument_list|,
name|RT_DEBUG_INTR
argument_list|,
literal|"PSE discards a packet due to buffer sharing limitation\n"
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * rt_gdm_other_drop - Handler of discard on other reason interrupt  */
end_comment

begin_function
specifier|static
name|void
name|rt_gdm_other_drop
parameter_list|(
name|struct
name|rt_softc
modifier|*
name|sc
parameter_list|)
block|{
name|RT_DPRINTF
argument_list|(
name|sc
argument_list|,
name|RT_DEBUG_INTR
argument_list|,
literal|"GDMA 1& 2 discard a packet due to other reason\n"
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * rt_pse_p1_fc - Handler of PSE port1 (GDMA 1) flow control interrupt  */
end_comment

begin_function
specifier|static
name|void
name|rt_pse_p1_fc
parameter_list|(
name|struct
name|rt_softc
modifier|*
name|sc
parameter_list|)
block|{
name|RT_DPRINTF
argument_list|(
name|sc
argument_list|,
name|RT_DEBUG_INTR
argument_list|,
literal|"PSE port1 (GDMA 1) flow control asserted.\n"
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * rt_pse_p0_fc - Handler of PSE port0 (CDMA) flow control interrupt  */
end_comment

begin_function
specifier|static
name|void
name|rt_pse_p0_fc
parameter_list|(
name|struct
name|rt_softc
modifier|*
name|sc
parameter_list|)
block|{
name|RT_DPRINTF
argument_list|(
name|sc
argument_list|,
name|RT_DEBUG_INTR
argument_list|,
literal|"PSE port0 (CDMA) flow control asserted.\n"
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * rt_pse_fq_empty - Handler of PSE free Q empty threshold reached interrupt  */
end_comment

begin_function
specifier|static
name|void
name|rt_pse_fq_empty
parameter_list|(
name|struct
name|rt_softc
modifier|*
name|sc
parameter_list|)
block|{
name|RT_DPRINTF
argument_list|(
name|sc
argument_list|,
name|RT_DEBUG_INTR
argument_list|,
literal|"PSE free Q empty threshold reached& forced drop "
literal|"condition occurred.\n"
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * rt_intr - main ISR  */
end_comment

begin_function
specifier|static
name|void
name|rt_intr
parameter_list|(
name|void
modifier|*
name|arg
parameter_list|)
block|{
name|struct
name|rt_softc
modifier|*
name|sc
decl_stmt|;
name|struct
name|ifnet
modifier|*
name|ifp
decl_stmt|;
name|uint32_t
name|status
decl_stmt|;
name|sc
operator|=
name|arg
expr_stmt|;
name|ifp
operator|=
name|sc
operator|->
name|ifp
expr_stmt|;
comment|/* acknowledge interrupts */
name|status
operator|=
name|RT_READ
argument_list|(
name|sc
argument_list|,
name|sc
operator|->
name|fe_int_status
argument_list|)
expr_stmt|;
name|RT_WRITE
argument_list|(
name|sc
argument_list|,
name|sc
operator|->
name|fe_int_status
argument_list|,
name|status
argument_list|)
expr_stmt|;
name|RT_DPRINTF
argument_list|(
name|sc
argument_list|,
name|RT_DEBUG_INTR
argument_list|,
literal|"interrupt: status=0x%08x\n"
argument_list|,
name|status
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|==
literal|0xffffffff
operator|||
comment|/* device likely went away */
name|status
operator|==
literal|0
condition|)
comment|/* not for us */
return|return;
name|sc
operator|->
name|interrupts
operator|++
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|ifp
operator|->
name|if_drv_flags
operator|&
name|IFF_DRV_RUNNING
operator|)
condition|)
return|return;
if|if
condition|(
name|status
operator|&
name|CNT_PPE_AF
condition|)
name|rt_cnt_ppe_af
argument_list|(
name|sc
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|&
name|CNT_GDM_AF
condition|)
name|rt_cnt_gdm_af
argument_list|(
name|sc
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|&
name|PSE_P2_FC
condition|)
name|rt_pse_p2_fc
argument_list|(
name|sc
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|&
name|GDM_CRC_DROP
condition|)
name|rt_gdm_crc_drop
argument_list|(
name|sc
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|&
name|PSE_BUF_DROP
condition|)
name|rt_pse_buf_drop
argument_list|(
name|sc
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|&
name|GDM_OTHER_DROP
condition|)
name|rt_gdm_other_drop
argument_list|(
name|sc
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|&
name|PSE_P1_FC
condition|)
name|rt_pse_p1_fc
argument_list|(
name|sc
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|&
name|PSE_P0_FC
condition|)
name|rt_pse_p0_fc
argument_list|(
name|sc
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|&
name|PSE_FQ_EMPTY
condition|)
name|rt_pse_fq_empty
argument_list|(
name|sc
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|&
name|INT_TX_COHERENT
condition|)
name|rt_tx_coherent_intr
argument_list|(
name|sc
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|&
name|INT_RX_COHERENT
condition|)
name|rt_rx_coherent_intr
argument_list|(
name|sc
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|&
name|RX_DLY_INT
condition|)
name|rt_rx_delay_intr
argument_list|(
name|sc
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|&
name|TX_DLY_INT
condition|)
name|rt_tx_delay_intr
argument_list|(
name|sc
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|&
name|INT_RX_DONE
condition|)
name|rt_rx_intr
argument_list|(
name|sc
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|&
name|INT_TXQ3_DONE
condition|)
name|rt_tx_intr
argument_list|(
name|sc
argument_list|,
literal|3
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|&
name|INT_TXQ2_DONE
condition|)
name|rt_tx_intr
argument_list|(
name|sc
argument_list|,
literal|2
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|&
name|INT_TXQ1_DONE
condition|)
name|rt_tx_intr
argument_list|(
name|sc
argument_list|,
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|&
name|INT_TXQ0_DONE
condition|)
name|rt_tx_intr
argument_list|(
name|sc
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * rt_rt5350_intr - main ISR for Ralink 5350 SoC  */
end_comment

begin_function
specifier|static
name|void
name|rt_rt5350_intr
parameter_list|(
name|void
modifier|*
name|arg
parameter_list|)
block|{
name|struct
name|rt_softc
modifier|*
name|sc
decl_stmt|;
name|struct
name|ifnet
modifier|*
name|ifp
decl_stmt|;
name|uint32_t
name|status
decl_stmt|;
name|sc
operator|=
name|arg
expr_stmt|;
name|ifp
operator|=
name|sc
operator|->
name|ifp
expr_stmt|;
comment|/* acknowledge interrupts */
name|status
operator|=
name|RT_READ
argument_list|(
name|sc
argument_list|,
name|sc
operator|->
name|fe_int_status
argument_list|)
expr_stmt|;
name|RT_WRITE
argument_list|(
name|sc
argument_list|,
name|sc
operator|->
name|fe_int_status
argument_list|,
name|status
argument_list|)
expr_stmt|;
name|RT_DPRINTF
argument_list|(
name|sc
argument_list|,
name|RT_DEBUG_INTR
argument_list|,
literal|"interrupt: status=0x%08x\n"
argument_list|,
name|status
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|==
literal|0xffffffff
operator|||
comment|/* device likely went away */
name|status
operator|==
literal|0
condition|)
comment|/* not for us */
return|return;
name|sc
operator|->
name|interrupts
operator|++
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|ifp
operator|->
name|if_drv_flags
operator|&
name|IFF_DRV_RUNNING
operator|)
condition|)
return|return;
if|if
condition|(
name|status
operator|&
name|RT5350_INT_TX_COHERENT
condition|)
name|rt_tx_coherent_intr
argument_list|(
name|sc
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|&
name|RT5350_INT_RX_COHERENT
condition|)
name|rt_rx_coherent_intr
argument_list|(
name|sc
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|&
name|RT5350_RX_DLY_INT
condition|)
name|rt_rx_delay_intr
argument_list|(
name|sc
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|&
name|RT5350_TX_DLY_INT
condition|)
name|rt_tx_delay_intr
argument_list|(
name|sc
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|&
name|RT5350_INT_RXQ1_DONE
condition|)
name|rt_rx_intr
argument_list|(
name|sc
argument_list|,
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|&
name|RT5350_INT_RXQ0_DONE
condition|)
name|rt_rx_intr
argument_list|(
name|sc
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|&
name|RT5350_INT_TXQ3_DONE
condition|)
name|rt_tx_intr
argument_list|(
name|sc
argument_list|,
literal|3
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|&
name|RT5350_INT_TXQ2_DONE
condition|)
name|rt_tx_intr
argument_list|(
name|sc
argument_list|,
literal|2
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|&
name|RT5350_INT_TXQ1_DONE
condition|)
name|rt_tx_intr
argument_list|(
name|sc
argument_list|,
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|&
name|RT5350_INT_TXQ0_DONE
condition|)
name|rt_tx_intr
argument_list|(
name|sc
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|rt_tx_coherent_intr
parameter_list|(
name|struct
name|rt_softc
modifier|*
name|sc
parameter_list|)
block|{
name|uint32_t
name|tmp
decl_stmt|;
name|int
name|i
decl_stmt|;
name|RT_DPRINTF
argument_list|(
name|sc
argument_list|,
name|RT_DEBUG_INTR
argument_list|,
literal|"Tx coherent interrupt\n"
argument_list|)
expr_stmt|;
name|sc
operator|->
name|tx_coherent_interrupts
operator|++
expr_stmt|;
comment|/* restart DMA engine */
name|tmp
operator|=
name|RT_READ
argument_list|(
name|sc
argument_list|,
name|sc
operator|->
name|pdma_glo_cfg
argument_list|)
expr_stmt|;
name|tmp
operator|&=
operator|~
operator|(
name|FE_TX_WB_DDONE
operator||
name|FE_TX_DMA_EN
operator|)
expr_stmt|;
name|RT_WRITE
argument_list|(
name|sc
argument_list|,
name|sc
operator|->
name|pdma_glo_cfg
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|RT_SOFTC_TX_RING_COUNT
condition|;
name|i
operator|++
control|)
name|rt_reset_tx_ring
argument_list|(
name|sc
argument_list|,
operator|&
name|sc
operator|->
name|tx_ring
index|[
name|i
index|]
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|RT_SOFTC_TX_RING_COUNT
condition|;
name|i
operator|++
control|)
block|{
name|RT_WRITE
argument_list|(
name|sc
argument_list|,
name|sc
operator|->
name|tx_base_ptr
index|[
name|i
index|]
argument_list|,
name|sc
operator|->
name|tx_ring
index|[
name|i
index|]
operator|.
name|desc_phys_addr
argument_list|)
expr_stmt|;
name|RT_WRITE
argument_list|(
name|sc
argument_list|,
name|sc
operator|->
name|tx_max_cnt
index|[
name|i
index|]
argument_list|,
name|RT_SOFTC_TX_RING_DESC_COUNT
argument_list|)
expr_stmt|;
name|RT_WRITE
argument_list|(
name|sc
argument_list|,
name|sc
operator|->
name|tx_ctx_idx
index|[
name|i
index|]
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
name|rt_txrx_enable
argument_list|(
name|sc
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * rt_rx_coherent_intr  */
end_comment

begin_function
specifier|static
name|void
name|rt_rx_coherent_intr
parameter_list|(
name|struct
name|rt_softc
modifier|*
name|sc
parameter_list|)
block|{
name|uint32_t
name|tmp
decl_stmt|;
name|int
name|i
decl_stmt|;
name|RT_DPRINTF
argument_list|(
name|sc
argument_list|,
name|RT_DEBUG_INTR
argument_list|,
literal|"Rx coherent interrupt\n"
argument_list|)
expr_stmt|;
name|sc
operator|->
name|rx_coherent_interrupts
operator|++
expr_stmt|;
comment|/* restart DMA engine */
name|tmp
operator|=
name|RT_READ
argument_list|(
name|sc
argument_list|,
name|sc
operator|->
name|pdma_glo_cfg
argument_list|)
expr_stmt|;
name|tmp
operator|&=
operator|~
operator|(
name|FE_RX_DMA_EN
operator|)
expr_stmt|;
name|RT_WRITE
argument_list|(
name|sc
argument_list|,
name|sc
operator|->
name|pdma_glo_cfg
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
comment|/* init Rx ring */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|sc
operator|->
name|rx_ring_count
condition|;
name|i
operator|++
control|)
name|rt_reset_rx_ring
argument_list|(
name|sc
argument_list|,
operator|&
name|sc
operator|->
name|rx_ring
index|[
name|i
index|]
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|sc
operator|->
name|rx_ring_count
condition|;
name|i
operator|++
control|)
block|{
name|RT_WRITE
argument_list|(
name|sc
argument_list|,
name|sc
operator|->
name|rx_base_ptr
index|[
name|i
index|]
argument_list|,
name|sc
operator|->
name|rx_ring
index|[
name|i
index|]
operator|.
name|desc_phys_addr
argument_list|)
expr_stmt|;
name|RT_WRITE
argument_list|(
name|sc
argument_list|,
name|sc
operator|->
name|rx_max_cnt
index|[
name|i
index|]
argument_list|,
name|RT_SOFTC_RX_RING_DATA_COUNT
argument_list|)
expr_stmt|;
name|RT_WRITE
argument_list|(
name|sc
argument_list|,
name|sc
operator|->
name|rx_calc_idx
index|[
name|i
index|]
argument_list|,
name|RT_SOFTC_RX_RING_DATA_COUNT
operator|-
literal|1
argument_list|)
expr_stmt|;
block|}
name|rt_txrx_enable
argument_list|(
name|sc
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * rt_rx_intr - a packet received  */
end_comment

begin_function
specifier|static
name|void
name|rt_rx_intr
parameter_list|(
name|struct
name|rt_softc
modifier|*
name|sc
parameter_list|,
name|int
name|qid
parameter_list|)
block|{
name|KASSERT
argument_list|(
name|qid
operator|>=
literal|0
operator|&&
name|qid
operator|<
name|sc
operator|->
name|rx_ring_count
argument_list|,
operator|(
literal|"%s: Rx interrupt: invalid qid=%d\n"
operator|,
name|device_get_nameunit
argument_list|(
name|sc
operator|->
name|dev
argument_list|)
operator|,
name|qid
operator|)
argument_list|)
expr_stmt|;
name|RT_DPRINTF
argument_list|(
name|sc
argument_list|,
name|RT_DEBUG_INTR
argument_list|,
literal|"Rx interrupt\n"
argument_list|)
expr_stmt|;
name|sc
operator|->
name|rx_interrupts
index|[
name|qid
index|]
operator|++
expr_stmt|;
name|RT_SOFTC_LOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|sc
operator|->
name|intr_disable_mask
operator|&
operator|(
name|sc
operator|->
name|int_rx_done_mask
operator|<<
name|qid
operator|)
operator|)
condition|)
block|{
name|rt_intr_disable
argument_list|(
name|sc
argument_list|,
operator|(
name|sc
operator|->
name|int_rx_done_mask
operator|<<
name|qid
operator|)
argument_list|)
expr_stmt|;
name|taskqueue_enqueue
argument_list|(
name|sc
operator|->
name|taskqueue
argument_list|,
operator|&
name|sc
operator|->
name|rx_done_task
argument_list|)
expr_stmt|;
block|}
name|sc
operator|->
name|intr_pending_mask
operator||=
operator|(
name|sc
operator|->
name|int_rx_done_mask
operator|<<
name|qid
operator|)
expr_stmt|;
name|RT_SOFTC_UNLOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|rt_rx_delay_intr
parameter_list|(
name|struct
name|rt_softc
modifier|*
name|sc
parameter_list|)
block|{
name|RT_DPRINTF
argument_list|(
name|sc
argument_list|,
name|RT_DEBUG_INTR
argument_list|,
literal|"Rx delay interrupt\n"
argument_list|)
expr_stmt|;
name|sc
operator|->
name|rx_delay_interrupts
operator|++
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|rt_tx_delay_intr
parameter_list|(
name|struct
name|rt_softc
modifier|*
name|sc
parameter_list|)
block|{
name|RT_DPRINTF
argument_list|(
name|sc
argument_list|,
name|RT_DEBUG_INTR
argument_list|,
literal|"Tx delay interrupt\n"
argument_list|)
expr_stmt|;
name|sc
operator|->
name|tx_delay_interrupts
operator|++
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * rt_tx_intr - Transsmition of packet done  */
end_comment

begin_function
specifier|static
name|void
name|rt_tx_intr
parameter_list|(
name|struct
name|rt_softc
modifier|*
name|sc
parameter_list|,
name|int
name|qid
parameter_list|)
block|{
name|KASSERT
argument_list|(
name|qid
operator|>=
literal|0
operator|&&
name|qid
operator|<
name|RT_SOFTC_TX_RING_COUNT
argument_list|,
operator|(
literal|"%s: Tx interrupt: invalid qid=%d\n"
operator|,
name|device_get_nameunit
argument_list|(
name|sc
operator|->
name|dev
argument_list|)
operator|,
name|qid
operator|)
argument_list|)
expr_stmt|;
name|RT_DPRINTF
argument_list|(
name|sc
argument_list|,
name|RT_DEBUG_INTR
argument_list|,
literal|"Tx interrupt: qid=%d\n"
argument_list|,
name|qid
argument_list|)
expr_stmt|;
name|sc
operator|->
name|tx_interrupts
index|[
name|qid
index|]
operator|++
expr_stmt|;
name|RT_SOFTC_LOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|sc
operator|->
name|intr_disable_mask
operator|&
operator|(
name|sc
operator|->
name|int_tx_done_mask
operator|<<
name|qid
operator|)
operator|)
condition|)
block|{
name|rt_intr_disable
argument_list|(
name|sc
argument_list|,
operator|(
name|sc
operator|->
name|int_tx_done_mask
operator|<<
name|qid
operator|)
argument_list|)
expr_stmt|;
name|taskqueue_enqueue
argument_list|(
name|sc
operator|->
name|taskqueue
argument_list|,
operator|&
name|sc
operator|->
name|tx_done_task
argument_list|)
expr_stmt|;
block|}
name|sc
operator|->
name|intr_pending_mask
operator||=
operator|(
name|sc
operator|->
name|int_tx_done_mask
operator|<<
name|qid
operator|)
expr_stmt|;
name|RT_SOFTC_UNLOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * rt_rx_done_task - run RX task  */
end_comment

begin_function
specifier|static
name|void
name|rt_rx_done_task
parameter_list|(
name|void
modifier|*
name|context
parameter_list|,
name|int
name|pending
parameter_list|)
block|{
name|struct
name|rt_softc
modifier|*
name|sc
decl_stmt|;
name|struct
name|ifnet
modifier|*
name|ifp
decl_stmt|;
name|int
name|again
decl_stmt|;
name|sc
operator|=
name|context
expr_stmt|;
name|ifp
operator|=
name|sc
operator|->
name|ifp
expr_stmt|;
name|RT_DPRINTF
argument_list|(
name|sc
argument_list|,
name|RT_DEBUG_RX
argument_list|,
literal|"Rx done task\n"
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|ifp
operator|->
name|if_drv_flags
operator|&
name|IFF_DRV_RUNNING
operator|)
condition|)
return|return;
name|sc
operator|->
name|intr_pending_mask
operator|&=
operator|~
name|sc
operator|->
name|int_rx_done_mask
expr_stmt|;
name|again
operator|=
name|rt_rx_eof
argument_list|(
name|sc
argument_list|,
operator|&
name|sc
operator|->
name|rx_ring
index|[
literal|0
index|]
argument_list|,
name|sc
operator|->
name|rx_process_limit
argument_list|)
expr_stmt|;
name|RT_SOFTC_LOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|sc
operator|->
name|intr_pending_mask
operator|&
name|sc
operator|->
name|int_rx_done_mask
operator|)
operator|||
name|again
condition|)
block|{
name|RT_DPRINTF
argument_list|(
name|sc
argument_list|,
name|RT_DEBUG_RX
argument_list|,
literal|"Rx done task: scheduling again\n"
argument_list|)
expr_stmt|;
name|taskqueue_enqueue
argument_list|(
name|sc
operator|->
name|taskqueue
argument_list|,
operator|&
name|sc
operator|->
name|rx_done_task
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|rt_intr_enable
argument_list|(
name|sc
argument_list|,
name|sc
operator|->
name|int_rx_done_mask
argument_list|)
expr_stmt|;
block|}
name|RT_SOFTC_UNLOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * rt_tx_done_task - check for pending TX task in all queues  */
end_comment

begin_function
specifier|static
name|void
name|rt_tx_done_task
parameter_list|(
name|void
modifier|*
name|context
parameter_list|,
name|int
name|pending
parameter_list|)
block|{
name|struct
name|rt_softc
modifier|*
name|sc
decl_stmt|;
name|struct
name|ifnet
modifier|*
name|ifp
decl_stmt|;
name|uint32_t
name|intr_mask
decl_stmt|;
name|int
name|i
decl_stmt|;
name|sc
operator|=
name|context
expr_stmt|;
name|ifp
operator|=
name|sc
operator|->
name|ifp
expr_stmt|;
name|RT_DPRINTF
argument_list|(
name|sc
argument_list|,
name|RT_DEBUG_TX
argument_list|,
literal|"Tx done task\n"
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|ifp
operator|->
name|if_drv_flags
operator|&
name|IFF_DRV_RUNNING
operator|)
condition|)
return|return;
for|for
control|(
name|i
operator|=
name|RT_SOFTC_TX_RING_COUNT
operator|-
literal|1
init|;
name|i
operator|>=
literal|0
condition|;
name|i
operator|--
control|)
block|{
if|if
condition|(
name|sc
operator|->
name|intr_pending_mask
operator|&
operator|(
name|sc
operator|->
name|int_tx_done_mask
operator|<<
name|i
operator|)
condition|)
block|{
name|sc
operator|->
name|intr_pending_mask
operator|&=
operator|~
operator|(
name|sc
operator|->
name|int_tx_done_mask
operator|<<
name|i
operator|)
expr_stmt|;
name|rt_tx_eof
argument_list|(
name|sc
argument_list|,
operator|&
name|sc
operator|->
name|tx_ring
index|[
name|i
index|]
argument_list|)
expr_stmt|;
block|}
block|}
name|sc
operator|->
name|tx_timer
operator|=
literal|0
expr_stmt|;
name|ifp
operator|->
name|if_drv_flags
operator|&=
operator|~
name|IFF_DRV_OACTIVE
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|rt_chipid
operator|==
name|RT_CHIPID_RT5350
operator|||
name|sc
operator|->
name|rt_chipid
operator|==
name|RT_CHIPID_MT7620
operator|||
name|sc
operator|->
name|rt_chipid
operator|==
name|RT_CHIPID_MT7621
condition|)
name|intr_mask
operator|=
operator|(
name|RT5350_INT_TXQ3_DONE
operator||
name|RT5350_INT_TXQ2_DONE
operator||
name|RT5350_INT_TXQ1_DONE
operator||
name|RT5350_INT_TXQ0_DONE
operator|)
expr_stmt|;
else|else
name|intr_mask
operator|=
operator|(
name|INT_TXQ3_DONE
operator||
name|INT_TXQ2_DONE
operator||
name|INT_TXQ1_DONE
operator||
name|INT_TXQ0_DONE
operator|)
expr_stmt|;
name|RT_SOFTC_LOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|rt_intr_enable
argument_list|(
name|sc
argument_list|,
operator|~
name|sc
operator|->
name|intr_pending_mask
operator|&
operator|(
name|sc
operator|->
name|intr_disable_mask
operator|&
name|intr_mask
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|intr_pending_mask
operator|&
name|intr_mask
condition|)
block|{
name|RT_DPRINTF
argument_list|(
name|sc
argument_list|,
name|RT_DEBUG_TX
argument_list|,
literal|"Tx done task: scheduling again\n"
argument_list|)
expr_stmt|;
name|taskqueue_enqueue
argument_list|(
name|sc
operator|->
name|taskqueue
argument_list|,
operator|&
name|sc
operator|->
name|tx_done_task
argument_list|)
expr_stmt|;
block|}
name|RT_SOFTC_UNLOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|IFQ_IS_EMPTY
argument_list|(
operator|&
name|ifp
operator|->
name|if_snd
argument_list|)
condition|)
name|rt_start
argument_list|(
name|ifp
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * rt_periodic_task - run periodic task  */
end_comment

begin_function
specifier|static
name|void
name|rt_periodic_task
parameter_list|(
name|void
modifier|*
name|context
parameter_list|,
name|int
name|pending
parameter_list|)
block|{
name|struct
name|rt_softc
modifier|*
name|sc
decl_stmt|;
name|struct
name|ifnet
modifier|*
name|ifp
decl_stmt|;
name|sc
operator|=
name|context
expr_stmt|;
name|ifp
operator|=
name|sc
operator|->
name|ifp
expr_stmt|;
name|RT_DPRINTF
argument_list|(
name|sc
argument_list|,
name|RT_DEBUG_PERIODIC
argument_list|,
literal|"periodic task: round=%lu\n"
argument_list|,
name|sc
operator|->
name|periodic_round
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|ifp
operator|->
name|if_drv_flags
operator|&
name|IFF_DRV_RUNNING
operator|)
condition|)
return|return;
name|RT_SOFTC_LOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|sc
operator|->
name|periodic_round
operator|++
expr_stmt|;
name|rt_update_stats
argument_list|(
name|sc
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|sc
operator|->
name|periodic_round
operator|%
literal|10
operator|)
operator|==
literal|0
condition|)
block|{
name|rt_update_raw_counters
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|rt_watchdog
argument_list|(
name|sc
argument_list|)
expr_stmt|;
block|}
name|RT_SOFTC_UNLOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|callout_reset
argument_list|(
operator|&
name|sc
operator|->
name|periodic_ch
argument_list|,
name|hz
operator|/
literal|10
argument_list|,
name|rt_periodic
argument_list|,
name|sc
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * rt_rx_eof - check for frames that done by DMA engine and pass it into  * network subsystem.  */
end_comment

begin_function
specifier|static
name|int
name|rt_rx_eof
parameter_list|(
name|struct
name|rt_softc
modifier|*
name|sc
parameter_list|,
name|struct
name|rt_softc_rx_ring
modifier|*
name|ring
parameter_list|,
name|int
name|limit
parameter_list|)
block|{
name|struct
name|ifnet
modifier|*
name|ifp
decl_stmt|;
comment|/*	struct rt_softc_rx_ring *ring; */
name|struct
name|rt_rxdesc
modifier|*
name|desc
decl_stmt|;
name|struct
name|rt_softc_rx_data
modifier|*
name|data
decl_stmt|;
name|struct
name|mbuf
modifier|*
name|m
decl_stmt|,
modifier|*
name|mnew
decl_stmt|;
name|bus_dma_segment_t
name|segs
index|[
literal|1
index|]
decl_stmt|;
name|bus_dmamap_t
name|dma_map
decl_stmt|;
name|uint32_t
name|index
decl_stmt|,
name|desc_flags
decl_stmt|;
name|int
name|error
decl_stmt|,
name|nsegs
decl_stmt|,
name|len
decl_stmt|,
name|nframes
decl_stmt|;
name|ifp
operator|=
name|sc
operator|->
name|ifp
expr_stmt|;
comment|/*	ring =&sc->rx_ring[0]; */
name|nframes
operator|=
literal|0
expr_stmt|;
while|while
condition|(
name|limit
operator|!=
literal|0
condition|)
block|{
name|index
operator|=
name|RT_READ
argument_list|(
name|sc
argument_list|,
name|sc
operator|->
name|rx_drx_idx
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|ring
operator|->
name|cur
operator|==
name|index
condition|)
break|break;
name|desc
operator|=
operator|&
name|ring
operator|->
name|desc
index|[
name|ring
operator|->
name|cur
index|]
expr_stmt|;
name|data
operator|=
operator|&
name|ring
operator|->
name|data
index|[
name|ring
operator|->
name|cur
index|]
expr_stmt|;
name|bus_dmamap_sync
argument_list|(
name|ring
operator|->
name|desc_dma_tag
argument_list|,
name|ring
operator|->
name|desc_dma_map
argument_list|,
name|BUS_DMASYNC_POSTREAD
operator||
name|BUS_DMASYNC_POSTWRITE
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|IF_RT_DEBUG
if|if
condition|(
name|sc
operator|->
name|debug
operator|&
name|RT_DEBUG_RX
condition|)
block|{
name|printf
argument_list|(
literal|"\nRX Descriptor[%#08x] dump:\n"
argument_list|,
operator|(
name|u_int
operator|)
name|desc
argument_list|)
expr_stmt|;
name|hexdump
argument_list|(
name|desc
argument_list|,
literal|16
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"-----------------------------------\n"
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
comment|/* XXX Sometime device don`t set DDONE bit */
ifdef|#
directive|ifdef
name|DDONE_FIXED
if|if
condition|(
operator|!
operator|(
name|desc
operator|->
name|sdl0
operator|&
name|htole16
argument_list|(
name|RT_RXDESC_SDL0_DDONE
argument_list|)
operator|)
condition|)
block|{
name|RT_DPRINTF
argument_list|(
name|sc
argument_list|,
name|RT_DEBUG_RX
argument_list|,
literal|"DDONE=0, try next\n"
argument_list|)
expr_stmt|;
break|break;
block|}
endif|#
directive|endif
name|len
operator|=
name|le16toh
argument_list|(
name|desc
operator|->
name|sdl0
argument_list|)
operator|&
literal|0x3fff
expr_stmt|;
name|RT_DPRINTF
argument_list|(
name|sc
argument_list|,
name|RT_DEBUG_RX
argument_list|,
literal|"new frame len=%d\n"
argument_list|,
name|len
argument_list|)
expr_stmt|;
name|nframes
operator|++
expr_stmt|;
name|mnew
operator|=
name|m_getjcl
argument_list|(
name|M_NOWAIT
argument_list|,
name|MT_DATA
argument_list|,
name|M_PKTHDR
argument_list|,
name|MJUMPAGESIZE
argument_list|)
expr_stmt|;
if|if
condition|(
name|mnew
operator|==
name|NULL
condition|)
block|{
name|sc
operator|->
name|rx_mbuf_alloc_errors
operator|++
expr_stmt|;
name|if_inc_counter
argument_list|(
name|ifp
argument_list|,
name|IFCOUNTER_IERRORS
argument_list|,
literal|1
argument_list|)
expr_stmt|;
goto|goto
name|skip
goto|;
block|}
name|mnew
operator|->
name|m_len
operator|=
name|mnew
operator|->
name|m_pkthdr
operator|.
name|len
operator|=
name|MJUMPAGESIZE
expr_stmt|;
name|error
operator|=
name|bus_dmamap_load_mbuf_sg
argument_list|(
name|ring
operator|->
name|data_dma_tag
argument_list|,
name|ring
operator|->
name|spare_dma_map
argument_list|,
name|mnew
argument_list|,
name|segs
argument_list|,
operator|&
name|nsegs
argument_list|,
name|BUS_DMA_NOWAIT
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|!=
literal|0
condition|)
block|{
name|RT_DPRINTF
argument_list|(
name|sc
argument_list|,
name|RT_DEBUG_RX
argument_list|,
literal|"could not load Rx mbuf DMA map: "
literal|"error=%d, nsegs=%d\n"
argument_list|,
name|error
argument_list|,
name|nsegs
argument_list|)
expr_stmt|;
name|m_freem
argument_list|(
name|mnew
argument_list|)
expr_stmt|;
name|sc
operator|->
name|rx_mbuf_dmamap_errors
operator|++
expr_stmt|;
name|if_inc_counter
argument_list|(
name|ifp
argument_list|,
name|IFCOUNTER_IERRORS
argument_list|,
literal|1
argument_list|)
expr_stmt|;
goto|goto
name|skip
goto|;
block|}
name|KASSERT
argument_list|(
name|nsegs
operator|==
literal|1
argument_list|,
operator|(
literal|"%s: too many DMA segments"
operator|,
name|device_get_nameunit
argument_list|(
name|sc
operator|->
name|dev
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|bus_dmamap_sync
argument_list|(
name|ring
operator|->
name|data_dma_tag
argument_list|,
name|data
operator|->
name|dma_map
argument_list|,
name|BUS_DMASYNC_POSTREAD
argument_list|)
expr_stmt|;
name|bus_dmamap_unload
argument_list|(
name|ring
operator|->
name|data_dma_tag
argument_list|,
name|data
operator|->
name|dma_map
argument_list|)
expr_stmt|;
name|dma_map
operator|=
name|data
operator|->
name|dma_map
expr_stmt|;
name|data
operator|->
name|dma_map
operator|=
name|ring
operator|->
name|spare_dma_map
expr_stmt|;
name|ring
operator|->
name|spare_dma_map
operator|=
name|dma_map
expr_stmt|;
name|bus_dmamap_sync
argument_list|(
name|ring
operator|->
name|data_dma_tag
argument_list|,
name|data
operator|->
name|dma_map
argument_list|,
name|BUS_DMASYNC_PREREAD
argument_list|)
expr_stmt|;
name|m
operator|=
name|data
operator|->
name|m
expr_stmt|;
name|desc_flags
operator|=
name|desc
operator|->
name|word3
expr_stmt|;
name|data
operator|->
name|m
operator|=
name|mnew
expr_stmt|;
comment|/* Add 2 for proper align of RX IP header */
name|desc
operator|->
name|sdp0
operator|=
name|htole32
argument_list|(
name|segs
index|[
literal|0
index|]
operator|.
name|ds_addr
operator|+
literal|2
argument_list|)
expr_stmt|;
name|desc
operator|->
name|sdl0
operator|=
name|htole32
argument_list|(
name|segs
index|[
literal|0
index|]
operator|.
name|ds_len
operator|-
literal|2
argument_list|)
expr_stmt|;
name|desc
operator|->
name|word3
operator|=
literal|0
expr_stmt|;
name|RT_DPRINTF
argument_list|(
name|sc
argument_list|,
name|RT_DEBUG_RX
argument_list|,
literal|"Rx frame: rxdesc flags=0x%08x\n"
argument_list|,
name|desc_flags
argument_list|)
expr_stmt|;
name|m
operator|->
name|m_pkthdr
operator|.
name|rcvif
operator|=
name|ifp
expr_stmt|;
comment|/* Add 2 to fix data align, after sdp0 = addr + 2 */
name|m
operator|->
name|m_data
operator|+=
literal|2
expr_stmt|;
name|m
operator|->
name|m_pkthdr
operator|.
name|len
operator|=
name|m
operator|->
name|m_len
operator|=
name|len
expr_stmt|;
comment|/* check for crc errors */
if|if
condition|(
operator|(
name|ifp
operator|->
name|if_capenable
operator|&
name|IFCAP_RXCSUM
operator|)
operator|!=
literal|0
condition|)
block|{
comment|/*check for valid checksum*/
if|if
condition|(
name|desc_flags
operator|&
operator|(
name|sc
operator|->
name|csum_fail_ip
operator||
name|sc
operator|->
name|csum_fail_l4
operator|)
condition|)
block|{
name|RT_DPRINTF
argument_list|(
name|sc
argument_list|,
name|RT_DEBUG_RX
argument_list|,
literal|"rxdesc: crc error\n"
argument_list|)
expr_stmt|;
name|if_inc_counter
argument_list|(
name|ifp
argument_list|,
name|IFCOUNTER_IERRORS
argument_list|,
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|ifp
operator|->
name|if_flags
operator|&
name|IFF_PROMISC
operator|)
condition|)
block|{
name|m_freem
argument_list|(
name|m
argument_list|)
expr_stmt|;
goto|goto
name|skip
goto|;
block|}
block|}
if|if
condition|(
operator|(
name|desc_flags
operator|&
name|sc
operator|->
name|csum_fail_ip
operator|)
operator|==
literal|0
condition|)
block|{
name|m
operator|->
name|m_pkthdr
operator|.
name|csum_flags
operator||=
name|CSUM_IP_CHECKED
expr_stmt|;
name|m
operator|->
name|m_pkthdr
operator|.
name|csum_flags
operator||=
name|CSUM_IP_VALID
expr_stmt|;
name|m
operator|->
name|m_pkthdr
operator|.
name|csum_data
operator|=
literal|0xffff
expr_stmt|;
block|}
name|m
operator|->
name|m_flags
operator|&=
operator|~
name|M_HASFCS
expr_stmt|;
block|}
call|(
modifier|*
name|ifp
operator|->
name|if_input
call|)
argument_list|(
name|ifp
argument_list|,
name|m
argument_list|)
expr_stmt|;
name|skip
label|:
name|desc
operator|->
name|sdl0
operator|&=
operator|~
name|htole16
argument_list|(
name|RT_RXDESC_SDL0_DDONE
argument_list|)
expr_stmt|;
name|bus_dmamap_sync
argument_list|(
name|ring
operator|->
name|desc_dma_tag
argument_list|,
name|ring
operator|->
name|desc_dma_map
argument_list|,
name|BUS_DMASYNC_PREREAD
operator||
name|BUS_DMASYNC_PREWRITE
argument_list|)
expr_stmt|;
name|ring
operator|->
name|cur
operator|=
operator|(
name|ring
operator|->
name|cur
operator|+
literal|1
operator|)
operator|%
name|RT_SOFTC_RX_RING_DATA_COUNT
expr_stmt|;
name|limit
operator|--
expr_stmt|;
block|}
if|if
condition|(
name|ring
operator|->
name|cur
operator|==
literal|0
condition|)
name|RT_WRITE
argument_list|(
name|sc
argument_list|,
name|sc
operator|->
name|rx_calc_idx
index|[
literal|0
index|]
argument_list|,
name|RT_SOFTC_RX_RING_DATA_COUNT
operator|-
literal|1
argument_list|)
expr_stmt|;
else|else
name|RT_WRITE
argument_list|(
name|sc
argument_list|,
name|sc
operator|->
name|rx_calc_idx
index|[
literal|0
index|]
argument_list|,
name|ring
operator|->
name|cur
operator|-
literal|1
argument_list|)
expr_stmt|;
name|RT_DPRINTF
argument_list|(
name|sc
argument_list|,
name|RT_DEBUG_RX
argument_list|,
literal|"Rx eof: nframes=%d\n"
argument_list|,
name|nframes
argument_list|)
expr_stmt|;
name|sc
operator|->
name|rx_packets
operator|+=
name|nframes
expr_stmt|;
return|return
operator|(
name|limit
operator|==
literal|0
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * rt_tx_eof - check for successful transmitted frames and mark their  * descriptor as free.  */
end_comment

begin_function
specifier|static
name|void
name|rt_tx_eof
parameter_list|(
name|struct
name|rt_softc
modifier|*
name|sc
parameter_list|,
name|struct
name|rt_softc_tx_ring
modifier|*
name|ring
parameter_list|)
block|{
name|struct
name|ifnet
modifier|*
name|ifp
decl_stmt|;
name|struct
name|rt_txdesc
modifier|*
name|desc
decl_stmt|;
name|struct
name|rt_softc_tx_data
modifier|*
name|data
decl_stmt|;
name|uint32_t
name|index
decl_stmt|;
name|int
name|ndescs
decl_stmt|,
name|nframes
decl_stmt|;
name|ifp
operator|=
name|sc
operator|->
name|ifp
expr_stmt|;
name|ndescs
operator|=
literal|0
expr_stmt|;
name|nframes
operator|=
literal|0
expr_stmt|;
for|for
control|(
init|;
condition|;
control|)
block|{
name|index
operator|=
name|RT_READ
argument_list|(
name|sc
argument_list|,
name|sc
operator|->
name|tx_dtx_idx
index|[
name|ring
operator|->
name|qid
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|ring
operator|->
name|desc_next
operator|==
name|index
condition|)
break|break;
name|ndescs
operator|++
expr_stmt|;
name|desc
operator|=
operator|&
name|ring
operator|->
name|desc
index|[
name|ring
operator|->
name|desc_next
index|]
expr_stmt|;
name|bus_dmamap_sync
argument_list|(
name|ring
operator|->
name|desc_dma_tag
argument_list|,
name|ring
operator|->
name|desc_dma_map
argument_list|,
name|BUS_DMASYNC_POSTREAD
operator||
name|BUS_DMASYNC_POSTWRITE
argument_list|)
expr_stmt|;
if|if
condition|(
name|desc
operator|->
name|sdl0
operator|&
name|htole16
argument_list|(
name|RT_TXDESC_SDL0_LASTSEG
argument_list|)
operator|||
name|desc
operator|->
name|sdl1
operator|&
name|htole16
argument_list|(
name|RT_TXDESC_SDL1_LASTSEG
argument_list|)
condition|)
block|{
name|nframes
operator|++
expr_stmt|;
name|data
operator|=
operator|&
name|ring
operator|->
name|data
index|[
name|ring
operator|->
name|data_next
index|]
expr_stmt|;
name|bus_dmamap_sync
argument_list|(
name|ring
operator|->
name|data_dma_tag
argument_list|,
name|data
operator|->
name|dma_map
argument_list|,
name|BUS_DMASYNC_POSTWRITE
argument_list|)
expr_stmt|;
name|bus_dmamap_unload
argument_list|(
name|ring
operator|->
name|data_dma_tag
argument_list|,
name|data
operator|->
name|dma_map
argument_list|)
expr_stmt|;
name|m_freem
argument_list|(
name|data
operator|->
name|m
argument_list|)
expr_stmt|;
name|data
operator|->
name|m
operator|=
name|NULL
expr_stmt|;
name|if_inc_counter
argument_list|(
name|ifp
argument_list|,
name|IFCOUNTER_OPACKETS
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|RT_SOFTC_TX_RING_LOCK
argument_list|(
name|ring
argument_list|)
expr_stmt|;
name|ring
operator|->
name|data_queued
operator|--
expr_stmt|;
name|ring
operator|->
name|data_next
operator|=
operator|(
name|ring
operator|->
name|data_next
operator|+
literal|1
operator|)
operator|%
name|RT_SOFTC_TX_RING_DATA_COUNT
expr_stmt|;
name|RT_SOFTC_TX_RING_UNLOCK
argument_list|(
name|ring
argument_list|)
expr_stmt|;
block|}
name|desc
operator|->
name|sdl0
operator|&=
operator|~
name|htole16
argument_list|(
name|RT_TXDESC_SDL0_DDONE
argument_list|)
expr_stmt|;
name|bus_dmamap_sync
argument_list|(
name|ring
operator|->
name|desc_dma_tag
argument_list|,
name|ring
operator|->
name|desc_dma_map
argument_list|,
name|BUS_DMASYNC_PREREAD
operator||
name|BUS_DMASYNC_PREWRITE
argument_list|)
expr_stmt|;
name|RT_SOFTC_TX_RING_LOCK
argument_list|(
name|ring
argument_list|)
expr_stmt|;
name|ring
operator|->
name|desc_queued
operator|--
expr_stmt|;
name|ring
operator|->
name|desc_next
operator|=
operator|(
name|ring
operator|->
name|desc_next
operator|+
literal|1
operator|)
operator|%
name|RT_SOFTC_TX_RING_DESC_COUNT
expr_stmt|;
name|RT_SOFTC_TX_RING_UNLOCK
argument_list|(
name|ring
argument_list|)
expr_stmt|;
block|}
name|RT_DPRINTF
argument_list|(
name|sc
argument_list|,
name|RT_DEBUG_TX
argument_list|,
literal|"Tx eof: qid=%d, ndescs=%d, nframes=%d\n"
argument_list|,
name|ring
operator|->
name|qid
argument_list|,
name|ndescs
argument_list|,
name|nframes
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * rt_update_stats - query statistics counters and update related variables.  */
end_comment

begin_function
specifier|static
name|void
name|rt_update_stats
parameter_list|(
name|struct
name|rt_softc
modifier|*
name|sc
parameter_list|)
block|{
name|struct
name|ifnet
modifier|*
name|ifp
decl_stmt|;
name|ifp
operator|=
name|sc
operator|->
name|ifp
expr_stmt|;
name|RT_DPRINTF
argument_list|(
name|sc
argument_list|,
name|RT_DEBUG_STATS
argument_list|,
literal|"update statistic: \n"
argument_list|)
expr_stmt|;
comment|/* XXX do update stats here */
block|}
end_function

begin_comment
comment|/*  * rt_watchdog - reinit device on watchdog event.  */
end_comment

begin_function
specifier|static
name|void
name|rt_watchdog
parameter_list|(
name|struct
name|rt_softc
modifier|*
name|sc
parameter_list|)
block|{
name|uint32_t
name|tmp
decl_stmt|;
ifdef|#
directive|ifdef
name|notyet
name|int
name|ntries
decl_stmt|;
endif|#
directive|endif
if|if
condition|(
name|sc
operator|->
name|rt_chipid
operator|!=
name|RT_CHIPID_RT5350
operator|&&
name|sc
operator|->
name|rt_chipid
operator|!=
name|RT_CHIPID_MT7620
operator|&&
name|sc
operator|->
name|rt_chipid
operator|!=
name|RT_CHIPID_MT7621
condition|)
block|{
name|tmp
operator|=
name|RT_READ
argument_list|(
name|sc
argument_list|,
name|PSE_BASE
operator|+
name|CDMA_OQ_STA
argument_list|)
expr_stmt|;
name|RT_DPRINTF
argument_list|(
name|sc
argument_list|,
name|RT_DEBUG_WATCHDOG
argument_list|,
literal|"watchdog: PSE_IQ_STA=0x%08x\n"
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
block|}
comment|/* XXX: do not reset */
ifdef|#
directive|ifdef
name|notyet
if|if
condition|(
operator|(
operator|(
name|tmp
operator|>>
name|P0_IQ_PCNT_SHIFT
operator|)
operator|&
literal|0xff
operator|)
operator|!=
literal|0
condition|)
block|{
name|sc
operator|->
name|tx_queue_not_empty
index|[
literal|0
index|]
operator|++
expr_stmt|;
for|for
control|(
name|ntries
operator|=
literal|0
init|;
name|ntries
operator|<
literal|10
condition|;
name|ntries
operator|++
control|)
block|{
name|tmp
operator|=
name|RT_READ
argument_list|(
name|sc
argument_list|,
name|PSE_BASE
operator|+
name|PSE_IQ_STA
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
operator|(
name|tmp
operator|>>
name|P0_IQ_PCNT_SHIFT
operator|)
operator|&
literal|0xff
operator|)
operator|==
literal|0
condition|)
break|break;
name|DELAY
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
operator|(
operator|(
name|tmp
operator|>>
name|P1_IQ_PCNT_SHIFT
operator|)
operator|&
literal|0xff
operator|)
operator|!=
literal|0
condition|)
block|{
name|sc
operator|->
name|tx_queue_not_empty
index|[
literal|1
index|]
operator|++
expr_stmt|;
for|for
control|(
name|ntries
operator|=
literal|0
init|;
name|ntries
operator|<
literal|10
condition|;
name|ntries
operator|++
control|)
block|{
name|tmp
operator|=
name|RT_READ
argument_list|(
name|sc
argument_list|,
name|PSE_BASE
operator|+
name|PSE_IQ_STA
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
operator|(
name|tmp
operator|>>
name|P1_IQ_PCNT_SHIFT
operator|)
operator|&
literal|0xff
operator|)
operator|==
literal|0
condition|)
break|break;
name|DELAY
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
block|}
endif|#
directive|endif
block|}
end_function

begin_comment
comment|/*  * rt_update_raw_counters - update counters.  */
end_comment

begin_function
specifier|static
name|void
name|rt_update_raw_counters
parameter_list|(
name|struct
name|rt_softc
modifier|*
name|sc
parameter_list|)
block|{
name|sc
operator|->
name|tx_bytes
operator|+=
name|RT_READ
argument_list|(
name|sc
argument_list|,
name|CNTR_BASE
operator|+
name|GDMA_TX_GBCNT0
argument_list|)
expr_stmt|;
name|sc
operator|->
name|tx_packets
operator|+=
name|RT_READ
argument_list|(
name|sc
argument_list|,
name|CNTR_BASE
operator|+
name|GDMA_TX_GPCNT0
argument_list|)
expr_stmt|;
name|sc
operator|->
name|tx_skip
operator|+=
name|RT_READ
argument_list|(
name|sc
argument_list|,
name|CNTR_BASE
operator|+
name|GDMA_TX_SKIPCNT0
argument_list|)
expr_stmt|;
name|sc
operator|->
name|tx_collision
operator|+=
name|RT_READ
argument_list|(
name|sc
argument_list|,
name|CNTR_BASE
operator|+
name|GDMA_TX_COLCNT0
argument_list|)
expr_stmt|;
name|sc
operator|->
name|rx_bytes
operator|+=
name|RT_READ
argument_list|(
name|sc
argument_list|,
name|CNTR_BASE
operator|+
name|GDMA_RX_GBCNT0
argument_list|)
expr_stmt|;
name|sc
operator|->
name|rx_packets
operator|+=
name|RT_READ
argument_list|(
name|sc
argument_list|,
name|CNTR_BASE
operator|+
name|GDMA_RX_GPCNT0
argument_list|)
expr_stmt|;
name|sc
operator|->
name|rx_crc_err
operator|+=
name|RT_READ
argument_list|(
name|sc
argument_list|,
name|CNTR_BASE
operator|+
name|GDMA_RX_CSUM_ERCNT0
argument_list|)
expr_stmt|;
name|sc
operator|->
name|rx_short_err
operator|+=
name|RT_READ
argument_list|(
name|sc
argument_list|,
name|CNTR_BASE
operator|+
name|GDMA_RX_SHORT_ERCNT0
argument_list|)
expr_stmt|;
name|sc
operator|->
name|rx_long_err
operator|+=
name|RT_READ
argument_list|(
name|sc
argument_list|,
name|CNTR_BASE
operator|+
name|GDMA_RX_LONG_ERCNT0
argument_list|)
expr_stmt|;
name|sc
operator|->
name|rx_phy_err
operator|+=
name|RT_READ
argument_list|(
name|sc
argument_list|,
name|CNTR_BASE
operator|+
name|GDMA_RX_FERCNT0
argument_list|)
expr_stmt|;
name|sc
operator|->
name|rx_fifo_overflows
operator|+=
name|RT_READ
argument_list|(
name|sc
argument_list|,
name|CNTR_BASE
operator|+
name|GDMA_RX_OERCNT0
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|rt_intr_enable
parameter_list|(
name|struct
name|rt_softc
modifier|*
name|sc
parameter_list|,
name|uint32_t
name|intr_mask
parameter_list|)
block|{
name|uint32_t
name|tmp
decl_stmt|;
name|sc
operator|->
name|intr_disable_mask
operator|&=
operator|~
name|intr_mask
expr_stmt|;
name|tmp
operator|=
name|sc
operator|->
name|intr_enable_mask
operator|&
operator|~
name|sc
operator|->
name|intr_disable_mask
expr_stmt|;
name|RT_WRITE
argument_list|(
name|sc
argument_list|,
name|sc
operator|->
name|fe_int_enable
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|rt_intr_disable
parameter_list|(
name|struct
name|rt_softc
modifier|*
name|sc
parameter_list|,
name|uint32_t
name|intr_mask
parameter_list|)
block|{
name|uint32_t
name|tmp
decl_stmt|;
name|sc
operator|->
name|intr_disable_mask
operator||=
name|intr_mask
expr_stmt|;
name|tmp
operator|=
name|sc
operator|->
name|intr_enable_mask
operator|&
operator|~
name|sc
operator|->
name|intr_disable_mask
expr_stmt|;
name|RT_WRITE
argument_list|(
name|sc
argument_list|,
name|sc
operator|->
name|fe_int_enable
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * rt_txrx_enable - enable TX/RX DMA  */
end_comment

begin_function
specifier|static
name|int
name|rt_txrx_enable
parameter_list|(
name|struct
name|rt_softc
modifier|*
name|sc
parameter_list|)
block|{
name|struct
name|ifnet
modifier|*
name|ifp
decl_stmt|;
name|uint32_t
name|tmp
decl_stmt|;
name|int
name|ntries
decl_stmt|;
name|ifp
operator|=
name|sc
operator|->
name|ifp
expr_stmt|;
comment|/* enable Tx/Rx DMA engine */
for|for
control|(
name|ntries
operator|=
literal|0
init|;
name|ntries
operator|<
literal|200
condition|;
name|ntries
operator|++
control|)
block|{
name|tmp
operator|=
name|RT_READ
argument_list|(
name|sc
argument_list|,
name|sc
operator|->
name|pdma_glo_cfg
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|tmp
operator|&
operator|(
name|FE_TX_DMA_BUSY
operator||
name|FE_RX_DMA_BUSY
operator|)
operator|)
condition|)
break|break;
name|DELAY
argument_list|(
literal|1000
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|ntries
operator|==
literal|200
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
literal|"timeout waiting for DMA engine\n"
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
name|DELAY
argument_list|(
literal|50
argument_list|)
expr_stmt|;
name|tmp
operator||=
name|FE_TX_WB_DDONE
operator||
name|FE_RX_DMA_EN
operator||
name|FE_TX_DMA_EN
expr_stmt|;
name|RT_WRITE
argument_list|(
name|sc
argument_list|,
name|sc
operator|->
name|pdma_glo_cfg
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
comment|/* XXX set Rx filter */
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * rt_alloc_rx_ring - allocate RX DMA ring buffer  */
end_comment

begin_function
specifier|static
name|int
name|rt_alloc_rx_ring
parameter_list|(
name|struct
name|rt_softc
modifier|*
name|sc
parameter_list|,
name|struct
name|rt_softc_rx_ring
modifier|*
name|ring
parameter_list|,
name|int
name|qid
parameter_list|)
block|{
name|struct
name|rt_rxdesc
modifier|*
name|desc
decl_stmt|;
name|struct
name|rt_softc_rx_data
modifier|*
name|data
decl_stmt|;
name|bus_dma_segment_t
name|segs
index|[
literal|1
index|]
decl_stmt|;
name|int
name|i
decl_stmt|,
name|nsegs
decl_stmt|,
name|error
decl_stmt|;
name|error
operator|=
name|bus_dma_tag_create
argument_list|(
name|bus_get_dma_tag
argument_list|(
name|sc
operator|->
name|dev
argument_list|)
argument_list|,
name|PAGE_SIZE
argument_list|,
literal|0
argument_list|,
name|BUS_SPACE_MAXADDR_32BIT
argument_list|,
name|BUS_SPACE_MAXADDR
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|RT_SOFTC_RX_RING_DATA_COUNT
operator|*
sizeof|sizeof
argument_list|(
expr|struct
name|rt_rxdesc
argument_list|)
argument_list|,
literal|1
argument_list|,
name|RT_SOFTC_RX_RING_DATA_COUNT
operator|*
sizeof|sizeof
argument_list|(
expr|struct
name|rt_rxdesc
argument_list|)
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
operator|&
name|ring
operator|->
name|desc_dma_tag
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|!=
literal|0
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
literal|"could not create Rx desc DMA tag\n"
argument_list|)
expr_stmt|;
goto|goto
name|fail
goto|;
block|}
name|error
operator|=
name|bus_dmamem_alloc
argument_list|(
name|ring
operator|->
name|desc_dma_tag
argument_list|,
operator|(
name|void
operator|*
operator|*
operator|)
operator|&
name|ring
operator|->
name|desc
argument_list|,
name|BUS_DMA_NOWAIT
operator||
name|BUS_DMA_ZERO
argument_list|,
operator|&
name|ring
operator|->
name|desc_dma_map
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|!=
literal|0
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
literal|"could not allocate Rx desc DMA memory\n"
argument_list|)
expr_stmt|;
goto|goto
name|fail
goto|;
block|}
name|error
operator|=
name|bus_dmamap_load
argument_list|(
name|ring
operator|->
name|desc_dma_tag
argument_list|,
name|ring
operator|->
name|desc_dma_map
argument_list|,
name|ring
operator|->
name|desc
argument_list|,
name|RT_SOFTC_RX_RING_DATA_COUNT
operator|*
sizeof|sizeof
argument_list|(
expr|struct
name|rt_rxdesc
argument_list|)
argument_list|,
name|rt_dma_map_addr
argument_list|,
operator|&
name|ring
operator|->
name|desc_phys_addr
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|!=
literal|0
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
literal|"could not load Rx desc DMA map\n"
argument_list|)
expr_stmt|;
goto|goto
name|fail
goto|;
block|}
name|error
operator|=
name|bus_dma_tag_create
argument_list|(
name|bus_get_dma_tag
argument_list|(
name|sc
operator|->
name|dev
argument_list|)
argument_list|,
name|PAGE_SIZE
argument_list|,
literal|0
argument_list|,
name|BUS_SPACE_MAXADDR_32BIT
argument_list|,
name|BUS_SPACE_MAXADDR
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|MJUMPAGESIZE
argument_list|,
literal|1
argument_list|,
name|MJUMPAGESIZE
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
operator|&
name|ring
operator|->
name|data_dma_tag
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|!=
literal|0
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
literal|"could not create Rx data DMA tag\n"
argument_list|)
expr_stmt|;
goto|goto
name|fail
goto|;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|RT_SOFTC_RX_RING_DATA_COUNT
condition|;
name|i
operator|++
control|)
block|{
name|desc
operator|=
operator|&
name|ring
operator|->
name|desc
index|[
name|i
index|]
expr_stmt|;
name|data
operator|=
operator|&
name|ring
operator|->
name|data
index|[
name|i
index|]
expr_stmt|;
name|error
operator|=
name|bus_dmamap_create
argument_list|(
name|ring
operator|->
name|data_dma_tag
argument_list|,
literal|0
argument_list|,
operator|&
name|data
operator|->
name|dma_map
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|!=
literal|0
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
literal|"could not create Rx data DMA "
literal|"map\n"
argument_list|)
expr_stmt|;
goto|goto
name|fail
goto|;
block|}
name|data
operator|->
name|m
operator|=
name|m_getjcl
argument_list|(
name|M_NOWAIT
argument_list|,
name|MT_DATA
argument_list|,
name|M_PKTHDR
argument_list|,
name|MJUMPAGESIZE
argument_list|)
expr_stmt|;
if|if
condition|(
name|data
operator|->
name|m
operator|==
name|NULL
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
literal|"could not allocate Rx mbuf\n"
argument_list|)
expr_stmt|;
name|error
operator|=
name|ENOMEM
expr_stmt|;
goto|goto
name|fail
goto|;
block|}
name|data
operator|->
name|m
operator|->
name|m_len
operator|=
name|data
operator|->
name|m
operator|->
name|m_pkthdr
operator|.
name|len
operator|=
name|MJUMPAGESIZE
expr_stmt|;
name|error
operator|=
name|bus_dmamap_load_mbuf_sg
argument_list|(
name|ring
operator|->
name|data_dma_tag
argument_list|,
name|data
operator|->
name|dma_map
argument_list|,
name|data
operator|->
name|m
argument_list|,
name|segs
argument_list|,
operator|&
name|nsegs
argument_list|,
name|BUS_DMA_NOWAIT
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|!=
literal|0
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
literal|"could not load Rx mbuf DMA map\n"
argument_list|)
expr_stmt|;
goto|goto
name|fail
goto|;
block|}
name|KASSERT
argument_list|(
name|nsegs
operator|==
literal|1
argument_list|,
operator|(
literal|"%s: too many DMA segments"
operator|,
name|device_get_nameunit
argument_list|(
name|sc
operator|->
name|dev
argument_list|)
operator|)
argument_list|)
expr_stmt|;
comment|/* Add 2 for proper align of RX IP header */
name|desc
operator|->
name|sdp0
operator|=
name|htole32
argument_list|(
name|segs
index|[
literal|0
index|]
operator|.
name|ds_addr
operator|+
literal|2
argument_list|)
expr_stmt|;
name|desc
operator|->
name|sdl0
operator|=
name|htole32
argument_list|(
name|segs
index|[
literal|0
index|]
operator|.
name|ds_len
operator|-
literal|2
argument_list|)
expr_stmt|;
block|}
name|error
operator|=
name|bus_dmamap_create
argument_list|(
name|ring
operator|->
name|data_dma_tag
argument_list|,
literal|0
argument_list|,
operator|&
name|ring
operator|->
name|spare_dma_map
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|!=
literal|0
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
literal|"could not create Rx spare DMA map\n"
argument_list|)
expr_stmt|;
goto|goto
name|fail
goto|;
block|}
name|bus_dmamap_sync
argument_list|(
name|ring
operator|->
name|desc_dma_tag
argument_list|,
name|ring
operator|->
name|desc_dma_map
argument_list|,
name|BUS_DMASYNC_PREREAD
operator||
name|BUS_DMASYNC_PREWRITE
argument_list|)
expr_stmt|;
name|ring
operator|->
name|qid
operator|=
name|qid
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
name|fail
label|:
name|rt_free_rx_ring
argument_list|(
name|sc
argument_list|,
name|ring
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * rt_reset_rx_ring - reset RX ring buffer  */
end_comment

begin_function
specifier|static
name|void
name|rt_reset_rx_ring
parameter_list|(
name|struct
name|rt_softc
modifier|*
name|sc
parameter_list|,
name|struct
name|rt_softc_rx_ring
modifier|*
name|ring
parameter_list|)
block|{
name|struct
name|rt_rxdesc
modifier|*
name|desc
decl_stmt|;
name|int
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|RT_SOFTC_RX_RING_DATA_COUNT
condition|;
name|i
operator|++
control|)
block|{
name|desc
operator|=
operator|&
name|ring
operator|->
name|desc
index|[
name|i
index|]
expr_stmt|;
name|desc
operator|->
name|sdl0
operator|&=
operator|~
name|htole16
argument_list|(
name|RT_RXDESC_SDL0_DDONE
argument_list|)
expr_stmt|;
block|}
name|bus_dmamap_sync
argument_list|(
name|ring
operator|->
name|desc_dma_tag
argument_list|,
name|ring
operator|->
name|desc_dma_map
argument_list|,
name|BUS_DMASYNC_PREREAD
operator||
name|BUS_DMASYNC_PREWRITE
argument_list|)
expr_stmt|;
name|ring
operator|->
name|cur
operator|=
literal|0
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * rt_free_rx_ring - free memory used by RX ring buffer  */
end_comment

begin_function
specifier|static
name|void
name|rt_free_rx_ring
parameter_list|(
name|struct
name|rt_softc
modifier|*
name|sc
parameter_list|,
name|struct
name|rt_softc_rx_ring
modifier|*
name|ring
parameter_list|)
block|{
name|struct
name|rt_softc_rx_data
modifier|*
name|data
decl_stmt|;
name|int
name|i
decl_stmt|;
if|if
condition|(
name|ring
operator|->
name|desc
operator|!=
name|NULL
condition|)
block|{
name|bus_dmamap_sync
argument_list|(
name|ring
operator|->
name|desc_dma_tag
argument_list|,
name|ring
operator|->
name|desc_dma_map
argument_list|,
name|BUS_DMASYNC_POSTWRITE
argument_list|)
expr_stmt|;
name|bus_dmamap_unload
argument_list|(
name|ring
operator|->
name|desc_dma_tag
argument_list|,
name|ring
operator|->
name|desc_dma_map
argument_list|)
expr_stmt|;
name|bus_dmamem_free
argument_list|(
name|ring
operator|->
name|desc_dma_tag
argument_list|,
name|ring
operator|->
name|desc
argument_list|,
name|ring
operator|->
name|desc_dma_map
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|ring
operator|->
name|desc_dma_tag
operator|!=
name|NULL
condition|)
name|bus_dma_tag_destroy
argument_list|(
name|ring
operator|->
name|desc_dma_tag
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|RT_SOFTC_RX_RING_DATA_COUNT
condition|;
name|i
operator|++
control|)
block|{
name|data
operator|=
operator|&
name|ring
operator|->
name|data
index|[
name|i
index|]
expr_stmt|;
if|if
condition|(
name|data
operator|->
name|m
operator|!=
name|NULL
condition|)
block|{
name|bus_dmamap_sync
argument_list|(
name|ring
operator|->
name|data_dma_tag
argument_list|,
name|data
operator|->
name|dma_map
argument_list|,
name|BUS_DMASYNC_POSTREAD
argument_list|)
expr_stmt|;
name|bus_dmamap_unload
argument_list|(
name|ring
operator|->
name|data_dma_tag
argument_list|,
name|data
operator|->
name|dma_map
argument_list|)
expr_stmt|;
name|m_freem
argument_list|(
name|data
operator|->
name|m
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|data
operator|->
name|dma_map
operator|!=
name|NULL
condition|)
name|bus_dmamap_destroy
argument_list|(
name|ring
operator|->
name|data_dma_tag
argument_list|,
name|data
operator|->
name|dma_map
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|ring
operator|->
name|spare_dma_map
operator|!=
name|NULL
condition|)
name|bus_dmamap_destroy
argument_list|(
name|ring
operator|->
name|data_dma_tag
argument_list|,
name|ring
operator|->
name|spare_dma_map
argument_list|)
expr_stmt|;
if|if
condition|(
name|ring
operator|->
name|data_dma_tag
operator|!=
name|NULL
condition|)
name|bus_dma_tag_destroy
argument_list|(
name|ring
operator|->
name|data_dma_tag
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * rt_alloc_tx_ring - allocate TX ring buffer  */
end_comment

begin_function
specifier|static
name|int
name|rt_alloc_tx_ring
parameter_list|(
name|struct
name|rt_softc
modifier|*
name|sc
parameter_list|,
name|struct
name|rt_softc_tx_ring
modifier|*
name|ring
parameter_list|,
name|int
name|qid
parameter_list|)
block|{
name|struct
name|rt_softc_tx_data
modifier|*
name|data
decl_stmt|;
name|int
name|error
decl_stmt|,
name|i
decl_stmt|;
name|mtx_init
argument_list|(
operator|&
name|ring
operator|->
name|lock
argument_list|,
name|device_get_nameunit
argument_list|(
name|sc
operator|->
name|dev
argument_list|)
argument_list|,
name|NULL
argument_list|,
name|MTX_DEF
argument_list|)
expr_stmt|;
name|error
operator|=
name|bus_dma_tag_create
argument_list|(
name|bus_get_dma_tag
argument_list|(
name|sc
operator|->
name|dev
argument_list|)
argument_list|,
name|PAGE_SIZE
argument_list|,
literal|0
argument_list|,
name|BUS_SPACE_MAXADDR_32BIT
argument_list|,
name|BUS_SPACE_MAXADDR
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|RT_SOFTC_TX_RING_DESC_COUNT
operator|*
sizeof|sizeof
argument_list|(
expr|struct
name|rt_txdesc
argument_list|)
argument_list|,
literal|1
argument_list|,
name|RT_SOFTC_TX_RING_DESC_COUNT
operator|*
sizeof|sizeof
argument_list|(
expr|struct
name|rt_txdesc
argument_list|)
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
operator|&
name|ring
operator|->
name|desc_dma_tag
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|!=
literal|0
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
literal|"could not create Tx desc DMA tag\n"
argument_list|)
expr_stmt|;
goto|goto
name|fail
goto|;
block|}
name|error
operator|=
name|bus_dmamem_alloc
argument_list|(
name|ring
operator|->
name|desc_dma_tag
argument_list|,
operator|(
name|void
operator|*
operator|*
operator|)
operator|&
name|ring
operator|->
name|desc
argument_list|,
name|BUS_DMA_NOWAIT
operator||
name|BUS_DMA_ZERO
argument_list|,
operator|&
name|ring
operator|->
name|desc_dma_map
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|!=
literal|0
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
literal|"could not allocate Tx desc DMA memory\n"
argument_list|)
expr_stmt|;
goto|goto
name|fail
goto|;
block|}
name|error
operator|=
name|bus_dmamap_load
argument_list|(
name|ring
operator|->
name|desc_dma_tag
argument_list|,
name|ring
operator|->
name|desc_dma_map
argument_list|,
name|ring
operator|->
name|desc
argument_list|,
operator|(
name|RT_SOFTC_TX_RING_DESC_COUNT
operator|*
sizeof|sizeof
argument_list|(
expr|struct
name|rt_txdesc
argument_list|)
operator|)
argument_list|,
name|rt_dma_map_addr
argument_list|,
operator|&
name|ring
operator|->
name|desc_phys_addr
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|!=
literal|0
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
literal|"could not load Tx desc DMA map\n"
argument_list|)
expr_stmt|;
goto|goto
name|fail
goto|;
block|}
name|ring
operator|->
name|desc_queued
operator|=
literal|0
expr_stmt|;
name|ring
operator|->
name|desc_cur
operator|=
literal|0
expr_stmt|;
name|ring
operator|->
name|desc_next
operator|=
literal|0
expr_stmt|;
name|error
operator|=
name|bus_dma_tag_create
argument_list|(
name|bus_get_dma_tag
argument_list|(
name|sc
operator|->
name|dev
argument_list|)
argument_list|,
name|PAGE_SIZE
argument_list|,
literal|0
argument_list|,
name|BUS_SPACE_MAXADDR_32BIT
argument_list|,
name|BUS_SPACE_MAXADDR
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|RT_SOFTC_TX_RING_DATA_COUNT
operator|*
name|RT_TX_DATA_SEG0_SIZE
argument_list|,
literal|1
argument_list|,
name|RT_SOFTC_TX_RING_DATA_COUNT
operator|*
name|RT_TX_DATA_SEG0_SIZE
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
operator|&
name|ring
operator|->
name|seg0_dma_tag
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|!=
literal|0
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
literal|"could not create Tx seg0 DMA tag\n"
argument_list|)
expr_stmt|;
goto|goto
name|fail
goto|;
block|}
name|error
operator|=
name|bus_dmamem_alloc
argument_list|(
name|ring
operator|->
name|seg0_dma_tag
argument_list|,
operator|(
name|void
operator|*
operator|*
operator|)
operator|&
name|ring
operator|->
name|seg0
argument_list|,
name|BUS_DMA_NOWAIT
operator||
name|BUS_DMA_ZERO
argument_list|,
operator|&
name|ring
operator|->
name|seg0_dma_map
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|!=
literal|0
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
literal|"could not allocate Tx seg0 DMA memory\n"
argument_list|)
expr_stmt|;
goto|goto
name|fail
goto|;
block|}
name|error
operator|=
name|bus_dmamap_load
argument_list|(
name|ring
operator|->
name|seg0_dma_tag
argument_list|,
name|ring
operator|->
name|seg0_dma_map
argument_list|,
name|ring
operator|->
name|seg0
argument_list|,
name|RT_SOFTC_TX_RING_DATA_COUNT
operator|*
name|RT_TX_DATA_SEG0_SIZE
argument_list|,
name|rt_dma_map_addr
argument_list|,
operator|&
name|ring
operator|->
name|seg0_phys_addr
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|!=
literal|0
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
literal|"could not load Tx seg0 DMA map\n"
argument_list|)
expr_stmt|;
goto|goto
name|fail
goto|;
block|}
name|error
operator|=
name|bus_dma_tag_create
argument_list|(
name|bus_get_dma_tag
argument_list|(
name|sc
operator|->
name|dev
argument_list|)
argument_list|,
name|PAGE_SIZE
argument_list|,
literal|0
argument_list|,
name|BUS_SPACE_MAXADDR_32BIT
argument_list|,
name|BUS_SPACE_MAXADDR
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|MJUMPAGESIZE
argument_list|,
name|RT_SOFTC_MAX_SCATTER
argument_list|,
name|MJUMPAGESIZE
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
operator|&
name|ring
operator|->
name|data_dma_tag
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|!=
literal|0
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
literal|"could not create Tx data DMA tag\n"
argument_list|)
expr_stmt|;
goto|goto
name|fail
goto|;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|RT_SOFTC_TX_RING_DATA_COUNT
condition|;
name|i
operator|++
control|)
block|{
name|data
operator|=
operator|&
name|ring
operator|->
name|data
index|[
name|i
index|]
expr_stmt|;
name|error
operator|=
name|bus_dmamap_create
argument_list|(
name|ring
operator|->
name|data_dma_tag
argument_list|,
literal|0
argument_list|,
operator|&
name|data
operator|->
name|dma_map
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|!=
literal|0
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
literal|"could not create Tx data DMA "
literal|"map\n"
argument_list|)
expr_stmt|;
goto|goto
name|fail
goto|;
block|}
block|}
name|ring
operator|->
name|data_queued
operator|=
literal|0
expr_stmt|;
name|ring
operator|->
name|data_cur
operator|=
literal|0
expr_stmt|;
name|ring
operator|->
name|data_next
operator|=
literal|0
expr_stmt|;
name|ring
operator|->
name|qid
operator|=
name|qid
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
name|fail
label|:
name|rt_free_tx_ring
argument_list|(
name|sc
argument_list|,
name|ring
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * rt_reset_tx_ring - reset TX ring buffer to empty state  */
end_comment

begin_function
specifier|static
name|void
name|rt_reset_tx_ring
parameter_list|(
name|struct
name|rt_softc
modifier|*
name|sc
parameter_list|,
name|struct
name|rt_softc_tx_ring
modifier|*
name|ring
parameter_list|)
block|{
name|struct
name|rt_softc_tx_data
modifier|*
name|data
decl_stmt|;
name|struct
name|rt_txdesc
modifier|*
name|desc
decl_stmt|;
name|int
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|RT_SOFTC_TX_RING_DESC_COUNT
condition|;
name|i
operator|++
control|)
block|{
name|desc
operator|=
operator|&
name|ring
operator|->
name|desc
index|[
name|i
index|]
expr_stmt|;
name|desc
operator|->
name|sdl0
operator|=
literal|0
expr_stmt|;
name|desc
operator|->
name|sdl1
operator|=
literal|0
expr_stmt|;
block|}
name|ring
operator|->
name|desc_queued
operator|=
literal|0
expr_stmt|;
name|ring
operator|->
name|desc_cur
operator|=
literal|0
expr_stmt|;
name|ring
operator|->
name|desc_next
operator|=
literal|0
expr_stmt|;
name|bus_dmamap_sync
argument_list|(
name|ring
operator|->
name|desc_dma_tag
argument_list|,
name|ring
operator|->
name|desc_dma_map
argument_list|,
name|BUS_DMASYNC_PREWRITE
argument_list|)
expr_stmt|;
name|bus_dmamap_sync
argument_list|(
name|ring
operator|->
name|seg0_dma_tag
argument_list|,
name|ring
operator|->
name|seg0_dma_map
argument_list|,
name|BUS_DMASYNC_PREWRITE
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|RT_SOFTC_TX_RING_DATA_COUNT
condition|;
name|i
operator|++
control|)
block|{
name|data
operator|=
operator|&
name|ring
operator|->
name|data
index|[
name|i
index|]
expr_stmt|;
if|if
condition|(
name|data
operator|->
name|m
operator|!=
name|NULL
condition|)
block|{
name|bus_dmamap_sync
argument_list|(
name|ring
operator|->
name|data_dma_tag
argument_list|,
name|data
operator|->
name|dma_map
argument_list|,
name|BUS_DMASYNC_POSTWRITE
argument_list|)
expr_stmt|;
name|bus_dmamap_unload
argument_list|(
name|ring
operator|->
name|data_dma_tag
argument_list|,
name|data
operator|->
name|dma_map
argument_list|)
expr_stmt|;
name|m_freem
argument_list|(
name|data
operator|->
name|m
argument_list|)
expr_stmt|;
name|data
operator|->
name|m
operator|=
name|NULL
expr_stmt|;
block|}
block|}
name|ring
operator|->
name|data_queued
operator|=
literal|0
expr_stmt|;
name|ring
operator|->
name|data_cur
operator|=
literal|0
expr_stmt|;
name|ring
operator|->
name|data_next
operator|=
literal|0
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * rt_free_tx_ring - free RX ring buffer  */
end_comment

begin_function
specifier|static
name|void
name|rt_free_tx_ring
parameter_list|(
name|struct
name|rt_softc
modifier|*
name|sc
parameter_list|,
name|struct
name|rt_softc_tx_ring
modifier|*
name|ring
parameter_list|)
block|{
name|struct
name|rt_softc_tx_data
modifier|*
name|data
decl_stmt|;
name|int
name|i
decl_stmt|;
if|if
condition|(
name|ring
operator|->
name|desc
operator|!=
name|NULL
condition|)
block|{
name|bus_dmamap_sync
argument_list|(
name|ring
operator|->
name|desc_dma_tag
argument_list|,
name|ring
operator|->
name|desc_dma_map
argument_list|,
name|BUS_DMASYNC_POSTWRITE
argument_list|)
expr_stmt|;
name|bus_dmamap_unload
argument_list|(
name|ring
operator|->
name|desc_dma_tag
argument_list|,
name|ring
operator|->
name|desc_dma_map
argument_list|)
expr_stmt|;
name|bus_dmamem_free
argument_list|(
name|ring
operator|->
name|desc_dma_tag
argument_list|,
name|ring
operator|->
name|desc
argument_list|,
name|ring
operator|->
name|desc_dma_map
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|ring
operator|->
name|desc_dma_tag
operator|!=
name|NULL
condition|)
name|bus_dma_tag_destroy
argument_list|(
name|ring
operator|->
name|desc_dma_tag
argument_list|)
expr_stmt|;
if|if
condition|(
name|ring
operator|->
name|seg0
operator|!=
name|NULL
condition|)
block|{
name|bus_dmamap_sync
argument_list|(
name|ring
operator|->
name|seg0_dma_tag
argument_list|,
name|ring
operator|->
name|seg0_dma_map
argument_list|,
name|BUS_DMASYNC_POSTWRITE
argument_list|)
expr_stmt|;
name|bus_dmamap_unload
argument_list|(
name|ring
operator|->
name|seg0_dma_tag
argument_list|,
name|ring
operator|->
name|seg0_dma_map
argument_list|)
expr_stmt|;
name|bus_dmamem_free
argument_list|(
name|ring
operator|->
name|seg0_dma_tag
argument_list|,
name|ring
operator|->
name|seg0
argument_list|,
name|ring
operator|->
name|seg0_dma_map
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|ring
operator|->
name|seg0_dma_tag
operator|!=
name|NULL
condition|)
name|bus_dma_tag_destroy
argument_list|(
name|ring
operator|->
name|seg0_dma_tag
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|RT_SOFTC_TX_RING_DATA_COUNT
condition|;
name|i
operator|++
control|)
block|{
name|data
operator|=
operator|&
name|ring
operator|->
name|data
index|[
name|i
index|]
expr_stmt|;
if|if
condition|(
name|data
operator|->
name|m
operator|!=
name|NULL
condition|)
block|{
name|bus_dmamap_sync
argument_list|(
name|ring
operator|->
name|data_dma_tag
argument_list|,
name|data
operator|->
name|dma_map
argument_list|,
name|BUS_DMASYNC_POSTWRITE
argument_list|)
expr_stmt|;
name|bus_dmamap_unload
argument_list|(
name|ring
operator|->
name|data_dma_tag
argument_list|,
name|data
operator|->
name|dma_map
argument_list|)
expr_stmt|;
name|m_freem
argument_list|(
name|data
operator|->
name|m
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|data
operator|->
name|dma_map
operator|!=
name|NULL
condition|)
name|bus_dmamap_destroy
argument_list|(
name|ring
operator|->
name|data_dma_tag
argument_list|,
name|data
operator|->
name|dma_map
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|ring
operator|->
name|data_dma_tag
operator|!=
name|NULL
condition|)
name|bus_dma_tag_destroy
argument_list|(
name|ring
operator|->
name|data_dma_tag
argument_list|)
expr_stmt|;
name|mtx_destroy
argument_list|(
operator|&
name|ring
operator|->
name|lock
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * rt_dma_map_addr - get address of busdma segment  */
end_comment

begin_function
specifier|static
name|void
name|rt_dma_map_addr
parameter_list|(
name|void
modifier|*
name|arg
parameter_list|,
name|bus_dma_segment_t
modifier|*
name|segs
parameter_list|,
name|int
name|nseg
parameter_list|,
name|int
name|error
parameter_list|)
block|{
if|if
condition|(
name|error
operator|!=
literal|0
condition|)
return|return;
name|KASSERT
argument_list|(
name|nseg
operator|==
literal|1
argument_list|,
operator|(
literal|"too many DMA segments, %d should be 1"
operator|,
name|nseg
operator|)
argument_list|)
expr_stmt|;
operator|*
operator|(
name|bus_addr_t
operator|*
operator|)
name|arg
operator|=
name|segs
index|[
literal|0
index|]
operator|.
name|ds_addr
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * rt_sysctl_attach - attach sysctl nodes for NIC counters.  */
end_comment

begin_function
specifier|static
name|void
name|rt_sysctl_attach
parameter_list|(
name|struct
name|rt_softc
modifier|*
name|sc
parameter_list|)
block|{
name|struct
name|sysctl_ctx_list
modifier|*
name|ctx
decl_stmt|;
name|struct
name|sysctl_oid
modifier|*
name|tree
decl_stmt|;
name|struct
name|sysctl_oid
modifier|*
name|stats
decl_stmt|;
name|ctx
operator|=
name|device_get_sysctl_ctx
argument_list|(
name|sc
operator|->
name|dev
argument_list|)
expr_stmt|;
name|tree
operator|=
name|device_get_sysctl_tree
argument_list|(
name|sc
operator|->
name|dev
argument_list|)
expr_stmt|;
comment|/* statistic counters */
name|stats
operator|=
name|SYSCTL_ADD_NODE
argument_list|(
name|ctx
argument_list|,
name|SYSCTL_CHILDREN
argument_list|(
name|tree
argument_list|)
argument_list|,
name|OID_AUTO
argument_list|,
literal|"stats"
argument_list|,
name|CTLFLAG_RD
argument_list|,
literal|0
argument_list|,
literal|"statistic"
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_ULONG
argument_list|(
name|ctx
argument_list|,
name|SYSCTL_CHILDREN
argument_list|(
name|stats
argument_list|)
argument_list|,
name|OID_AUTO
argument_list|,
literal|"interrupts"
argument_list|,
name|CTLFLAG_RD
argument_list|,
operator|&
name|sc
operator|->
name|interrupts
argument_list|,
literal|"all interrupts"
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_ULONG
argument_list|(
name|ctx
argument_list|,
name|SYSCTL_CHILDREN
argument_list|(
name|stats
argument_list|)
argument_list|,
name|OID_AUTO
argument_list|,
literal|"tx_coherent_interrupts"
argument_list|,
name|CTLFLAG_RD
argument_list|,
operator|&
name|sc
operator|->
name|tx_coherent_interrupts
argument_list|,
literal|"Tx coherent interrupts"
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_ULONG
argument_list|(
name|ctx
argument_list|,
name|SYSCTL_CHILDREN
argument_list|(
name|stats
argument_list|)
argument_list|,
name|OID_AUTO
argument_list|,
literal|"rx_coherent_interrupts"
argument_list|,
name|CTLFLAG_RD
argument_list|,
operator|&
name|sc
operator|->
name|rx_coherent_interrupts
argument_list|,
literal|"Rx coherent interrupts"
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_ULONG
argument_list|(
name|ctx
argument_list|,
name|SYSCTL_CHILDREN
argument_list|(
name|stats
argument_list|)
argument_list|,
name|OID_AUTO
argument_list|,
literal|"rx_interrupts"
argument_list|,
name|CTLFLAG_RD
argument_list|,
operator|&
name|sc
operator|->
name|rx_interrupts
index|[
literal|0
index|]
argument_list|,
literal|"Rx interrupts"
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_ULONG
argument_list|(
name|ctx
argument_list|,
name|SYSCTL_CHILDREN
argument_list|(
name|stats
argument_list|)
argument_list|,
name|OID_AUTO
argument_list|,
literal|"rx_delay_interrupts"
argument_list|,
name|CTLFLAG_RD
argument_list|,
operator|&
name|sc
operator|->
name|rx_delay_interrupts
argument_list|,
literal|"Rx delay interrupts"
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_ULONG
argument_list|(
name|ctx
argument_list|,
name|SYSCTL_CHILDREN
argument_list|(
name|stats
argument_list|)
argument_list|,
name|OID_AUTO
argument_list|,
literal|"TXQ3_interrupts"
argument_list|,
name|CTLFLAG_RD
argument_list|,
operator|&
name|sc
operator|->
name|tx_interrupts
index|[
literal|3
index|]
argument_list|,
literal|"Tx AC3 interrupts"
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_ULONG
argument_list|(
name|ctx
argument_list|,
name|SYSCTL_CHILDREN
argument_list|(
name|stats
argument_list|)
argument_list|,
name|OID_AUTO
argument_list|,
literal|"TXQ2_interrupts"
argument_list|,
name|CTLFLAG_RD
argument_list|,
operator|&
name|sc
operator|->
name|tx_interrupts
index|[
literal|2
index|]
argument_list|,
literal|"Tx AC2 interrupts"
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_ULONG
argument_list|(
name|ctx
argument_list|,
name|SYSCTL_CHILDREN
argument_list|(
name|stats
argument_list|)
argument_list|,
name|OID_AUTO
argument_list|,
literal|"TXQ1_interrupts"
argument_list|,
name|CTLFLAG_RD
argument_list|,
operator|&
name|sc
operator|->
name|tx_interrupts
index|[
literal|1
index|]
argument_list|,
literal|"Tx AC1 interrupts"
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_ULONG
argument_list|(
name|ctx
argument_list|,
name|SYSCTL_CHILDREN
argument_list|(
name|stats
argument_list|)
argument_list|,
name|OID_AUTO
argument_list|,
literal|"TXQ0_interrupts"
argument_list|,
name|CTLFLAG_RD
argument_list|,
operator|&
name|sc
operator|->
name|tx_interrupts
index|[
literal|0
index|]
argument_list|,
literal|"Tx AC0 interrupts"
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_ULONG
argument_list|(
name|ctx
argument_list|,
name|SYSCTL_CHILDREN
argument_list|(
name|stats
argument_list|)
argument_list|,
name|OID_AUTO
argument_list|,
literal|"tx_delay_interrupts"
argument_list|,
name|CTLFLAG_RD
argument_list|,
operator|&
name|sc
operator|->
name|tx_delay_interrupts
argument_list|,
literal|"Tx delay interrupts"
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_INT
argument_list|(
name|ctx
argument_list|,
name|SYSCTL_CHILDREN
argument_list|(
name|stats
argument_list|)
argument_list|,
name|OID_AUTO
argument_list|,
literal|"TXQ3_desc_queued"
argument_list|,
name|CTLFLAG_RD
argument_list|,
operator|&
name|sc
operator|->
name|tx_ring
index|[
literal|3
index|]
operator|.
name|desc_queued
argument_list|,
literal|0
argument_list|,
literal|"Tx AC3 descriptors queued"
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_INT
argument_list|(
name|ctx
argument_list|,
name|SYSCTL_CHILDREN
argument_list|(
name|stats
argument_list|)
argument_list|,
name|OID_AUTO
argument_list|,
literal|"TXQ3_data_queued"
argument_list|,
name|CTLFLAG_RD
argument_list|,
operator|&
name|sc
operator|->
name|tx_ring
index|[
literal|3
index|]
operator|.
name|data_queued
argument_list|,
literal|0
argument_list|,
literal|"Tx AC3 data queued"
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_INT
argument_list|(
name|ctx
argument_list|,
name|SYSCTL_CHILDREN
argument_list|(
name|stats
argument_list|)
argument_list|,
name|OID_AUTO
argument_list|,
literal|"TXQ2_desc_queued"
argument_list|,
name|CTLFLAG_RD
argument_list|,
operator|&
name|sc
operator|->
name|tx_ring
index|[
literal|2
index|]
operator|.
name|desc_queued
argument_list|,
literal|0
argument_list|,
literal|"Tx AC2 descriptors queued"
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_INT
argument_list|(
name|ctx
argument_list|,
name|SYSCTL_CHILDREN
argument_list|(
name|stats
argument_list|)
argument_list|,
name|OID_AUTO
argument_list|,
literal|"TXQ2_data_queued"
argument_list|,
name|CTLFLAG_RD
argument_list|,
operator|&
name|sc
operator|->
name|tx_ring
index|[
literal|2
index|]
operator|.
name|data_queued
argument_list|,
literal|0
argument_list|,
literal|"Tx AC2 data queued"
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_INT
argument_list|(
name|ctx
argument_list|,
name|SYSCTL_CHILDREN
argument_list|(
name|stats
argument_list|)
argument_list|,
name|OID_AUTO
argument_list|,
literal|"TXQ1_desc_queued"
argument_list|,
name|CTLFLAG_RD
argument_list|,
operator|&
name|sc
operator|->
name|tx_ring
index|[
literal|1
index|]
operator|.
name|desc_queued
argument_list|,
literal|0
argument_list|,
literal|"Tx AC1 descriptors queued"
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_INT
argument_list|(
name|ctx
argument_list|,
name|SYSCTL_CHILDREN
argument_list|(
name|stats
argument_list|)
argument_list|,
name|OID_AUTO
argument_list|,
literal|"TXQ1_data_queued"
argument_list|,
name|CTLFLAG_RD
argument_list|,
operator|&
name|sc
operator|->
name|tx_ring
index|[
literal|1
index|]
operator|.
name|data_queued
argument_list|,
literal|0
argument_list|,
literal|"Tx AC1 data queued"
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_INT
argument_list|(
name|ctx
argument_list|,
name|SYSCTL_CHILDREN
argument_list|(
name|stats
argument_list|)
argument_list|,
name|OID_AUTO
argument_list|,
literal|"TXQ0_desc_queued"
argument_list|,
name|CTLFLAG_RD
argument_list|,
operator|&
name|sc
operator|->
name|tx_ring
index|[
literal|0
index|]
operator|.
name|desc_queued
argument_list|,
literal|0
argument_list|,
literal|"Tx AC0 descriptors queued"
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_INT
argument_list|(
name|ctx
argument_list|,
name|SYSCTL_CHILDREN
argument_list|(
name|stats
argument_list|)
argument_list|,
name|OID_AUTO
argument_list|,
literal|"TXQ0_data_queued"
argument_list|,
name|CTLFLAG_RD
argument_list|,
operator|&
name|sc
operator|->
name|tx_ring
index|[
literal|0
index|]
operator|.
name|data_queued
argument_list|,
literal|0
argument_list|,
literal|"Tx AC0 data queued"
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_ULONG
argument_list|(
name|ctx
argument_list|,
name|SYSCTL_CHILDREN
argument_list|(
name|stats
argument_list|)
argument_list|,
name|OID_AUTO
argument_list|,
literal|"TXQ3_data_queue_full"
argument_list|,
name|CTLFLAG_RD
argument_list|,
operator|&
name|sc
operator|->
name|tx_data_queue_full
index|[
literal|3
index|]
argument_list|,
literal|"Tx AC3 data queue full"
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_ULONG
argument_list|(
name|ctx
argument_list|,
name|SYSCTL_CHILDREN
argument_list|(
name|stats
argument_list|)
argument_list|,
name|OID_AUTO
argument_list|,
literal|"TXQ2_data_queue_full"
argument_list|,
name|CTLFLAG_RD
argument_list|,
operator|&
name|sc
operator|->
name|tx_data_queue_full
index|[
literal|2
index|]
argument_list|,
literal|"Tx AC2 data queue full"
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_ULONG
argument_list|(
name|ctx
argument_list|,
name|SYSCTL_CHILDREN
argument_list|(
name|stats
argument_list|)
argument_list|,
name|OID_AUTO
argument_list|,
literal|"TXQ1_data_queue_full"
argument_list|,
name|CTLFLAG_RD
argument_list|,
operator|&
name|sc
operator|->
name|tx_data_queue_full
index|[
literal|1
index|]
argument_list|,
literal|"Tx AC1 data queue full"
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_ULONG
argument_list|(
name|ctx
argument_list|,
name|SYSCTL_CHILDREN
argument_list|(
name|stats
argument_list|)
argument_list|,
name|OID_AUTO
argument_list|,
literal|"TXQ0_data_queue_full"
argument_list|,
name|CTLFLAG_RD
argument_list|,
operator|&
name|sc
operator|->
name|tx_data_queue_full
index|[
literal|0
index|]
argument_list|,
literal|"Tx AC0 data queue full"
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_ULONG
argument_list|(
name|ctx
argument_list|,
name|SYSCTL_CHILDREN
argument_list|(
name|stats
argument_list|)
argument_list|,
name|OID_AUTO
argument_list|,
literal|"tx_watchdog_timeouts"
argument_list|,
name|CTLFLAG_RD
argument_list|,
operator|&
name|sc
operator|->
name|tx_watchdog_timeouts
argument_list|,
literal|"Tx watchdog timeouts"
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_ULONG
argument_list|(
name|ctx
argument_list|,
name|SYSCTL_CHILDREN
argument_list|(
name|stats
argument_list|)
argument_list|,
name|OID_AUTO
argument_list|,
literal|"tx_defrag_packets"
argument_list|,
name|CTLFLAG_RD
argument_list|,
operator|&
name|sc
operator|->
name|tx_defrag_packets
argument_list|,
literal|"Tx defragmented packets"
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_ULONG
argument_list|(
name|ctx
argument_list|,
name|SYSCTL_CHILDREN
argument_list|(
name|stats
argument_list|)
argument_list|,
name|OID_AUTO
argument_list|,
literal|"no_tx_desc_avail"
argument_list|,
name|CTLFLAG_RD
argument_list|,
operator|&
name|sc
operator|->
name|no_tx_desc_avail
argument_list|,
literal|"no Tx descriptors available"
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_ULONG
argument_list|(
name|ctx
argument_list|,
name|SYSCTL_CHILDREN
argument_list|(
name|stats
argument_list|)
argument_list|,
name|OID_AUTO
argument_list|,
literal|"rx_mbuf_alloc_errors"
argument_list|,
name|CTLFLAG_RD
argument_list|,
operator|&
name|sc
operator|->
name|rx_mbuf_alloc_errors
argument_list|,
literal|"Rx mbuf allocation errors"
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_ULONG
argument_list|(
name|ctx
argument_list|,
name|SYSCTL_CHILDREN
argument_list|(
name|stats
argument_list|)
argument_list|,
name|OID_AUTO
argument_list|,
literal|"rx_mbuf_dmamap_errors"
argument_list|,
name|CTLFLAG_RD
argument_list|,
operator|&
name|sc
operator|->
name|rx_mbuf_dmamap_errors
argument_list|,
literal|"Rx mbuf DMA mapping errors"
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_ULONG
argument_list|(
name|ctx
argument_list|,
name|SYSCTL_CHILDREN
argument_list|(
name|stats
argument_list|)
argument_list|,
name|OID_AUTO
argument_list|,
literal|"tx_queue_0_not_empty"
argument_list|,
name|CTLFLAG_RD
argument_list|,
operator|&
name|sc
operator|->
name|tx_queue_not_empty
index|[
literal|0
index|]
argument_list|,
literal|"Tx queue 0 not empty"
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_ULONG
argument_list|(
name|ctx
argument_list|,
name|SYSCTL_CHILDREN
argument_list|(
name|stats
argument_list|)
argument_list|,
name|OID_AUTO
argument_list|,
literal|"tx_queue_1_not_empty"
argument_list|,
name|CTLFLAG_RD
argument_list|,
operator|&
name|sc
operator|->
name|tx_queue_not_empty
index|[
literal|1
index|]
argument_list|,
literal|"Tx queue 1 not empty"
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_ULONG
argument_list|(
name|ctx
argument_list|,
name|SYSCTL_CHILDREN
argument_list|(
name|stats
argument_list|)
argument_list|,
name|OID_AUTO
argument_list|,
literal|"rx_packets"
argument_list|,
name|CTLFLAG_RD
argument_list|,
operator|&
name|sc
operator|->
name|rx_packets
argument_list|,
literal|"Rx packets"
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_ULONG
argument_list|(
name|ctx
argument_list|,
name|SYSCTL_CHILDREN
argument_list|(
name|stats
argument_list|)
argument_list|,
name|OID_AUTO
argument_list|,
literal|"rx_crc_errors"
argument_list|,
name|CTLFLAG_RD
argument_list|,
operator|&
name|sc
operator|->
name|rx_crc_err
argument_list|,
literal|"Rx CRC errors"
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_ULONG
argument_list|(
name|ctx
argument_list|,
name|SYSCTL_CHILDREN
argument_list|(
name|stats
argument_list|)
argument_list|,
name|OID_AUTO
argument_list|,
literal|"rx_phy_errors"
argument_list|,
name|CTLFLAG_RD
argument_list|,
operator|&
name|sc
operator|->
name|rx_phy_err
argument_list|,
literal|"Rx PHY errors"
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_ULONG
argument_list|(
name|ctx
argument_list|,
name|SYSCTL_CHILDREN
argument_list|(
name|stats
argument_list|)
argument_list|,
name|OID_AUTO
argument_list|,
literal|"rx_dup_packets"
argument_list|,
name|CTLFLAG_RD
argument_list|,
operator|&
name|sc
operator|->
name|rx_dup_packets
argument_list|,
literal|"Rx duplicate packets"
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_ULONG
argument_list|(
name|ctx
argument_list|,
name|SYSCTL_CHILDREN
argument_list|(
name|stats
argument_list|)
argument_list|,
name|OID_AUTO
argument_list|,
literal|"rx_fifo_overflows"
argument_list|,
name|CTLFLAG_RD
argument_list|,
operator|&
name|sc
operator|->
name|rx_fifo_overflows
argument_list|,
literal|"Rx FIFO overflows"
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_ULONG
argument_list|(
name|ctx
argument_list|,
name|SYSCTL_CHILDREN
argument_list|(
name|stats
argument_list|)
argument_list|,
name|OID_AUTO
argument_list|,
literal|"rx_bytes"
argument_list|,
name|CTLFLAG_RD
argument_list|,
operator|&
name|sc
operator|->
name|rx_bytes
argument_list|,
literal|"Rx bytes"
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_ULONG
argument_list|(
name|ctx
argument_list|,
name|SYSCTL_CHILDREN
argument_list|(
name|stats
argument_list|)
argument_list|,
name|OID_AUTO
argument_list|,
literal|"rx_long_err"
argument_list|,
name|CTLFLAG_RD
argument_list|,
operator|&
name|sc
operator|->
name|rx_long_err
argument_list|,
literal|"Rx too long frame errors"
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_ULONG
argument_list|(
name|ctx
argument_list|,
name|SYSCTL_CHILDREN
argument_list|(
name|stats
argument_list|)
argument_list|,
name|OID_AUTO
argument_list|,
literal|"rx_short_err"
argument_list|,
name|CTLFLAG_RD
argument_list|,
operator|&
name|sc
operator|->
name|rx_short_err
argument_list|,
literal|"Rx too short frame errors"
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_ULONG
argument_list|(
name|ctx
argument_list|,
name|SYSCTL_CHILDREN
argument_list|(
name|stats
argument_list|)
argument_list|,
name|OID_AUTO
argument_list|,
literal|"tx_bytes"
argument_list|,
name|CTLFLAG_RD
argument_list|,
operator|&
name|sc
operator|->
name|tx_bytes
argument_list|,
literal|"Tx bytes"
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_ULONG
argument_list|(
name|ctx
argument_list|,
name|SYSCTL_CHILDREN
argument_list|(
name|stats
argument_list|)
argument_list|,
name|OID_AUTO
argument_list|,
literal|"tx_packets"
argument_list|,
name|CTLFLAG_RD
argument_list|,
operator|&
name|sc
operator|->
name|tx_packets
argument_list|,
literal|"Tx packets"
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_ULONG
argument_list|(
name|ctx
argument_list|,
name|SYSCTL_CHILDREN
argument_list|(
name|stats
argument_list|)
argument_list|,
name|OID_AUTO
argument_list|,
literal|"tx_skip"
argument_list|,
name|CTLFLAG_RD
argument_list|,
operator|&
name|sc
operator|->
name|tx_skip
argument_list|,
literal|"Tx skip count for GDMA ports"
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_ULONG
argument_list|(
name|ctx
argument_list|,
name|SYSCTL_CHILDREN
argument_list|(
name|stats
argument_list|)
argument_list|,
name|OID_AUTO
argument_list|,
literal|"tx_collision"
argument_list|,
name|CTLFLAG_RD
argument_list|,
operator|&
name|sc
operator|->
name|tx_collision
argument_list|,
literal|"Tx collision count for GDMA ports"
argument_list|)
expr_stmt|;
block|}
end_function

begin_if
if|#
directive|if
name|defined
argument_list|(
name|IF_RT_PHY_SUPPORT
argument_list|)
operator|||
name|defined
argument_list|(
name|RT_MDIO
argument_list|)
end_if

begin_comment
comment|/* This code is only work RT2880 and same chip. */
end_comment

begin_comment
comment|/* TODO: make RT3052 and later support code. But nobody need it? */
end_comment

begin_function
specifier|static
name|int
name|rt_miibus_readreg
parameter_list|(
name|device_t
name|dev
parameter_list|,
name|int
name|phy
parameter_list|,
name|int
name|reg
parameter_list|)
block|{
name|struct
name|rt_softc
modifier|*
name|sc
init|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
decl_stmt|;
name|int
name|dat
decl_stmt|;
comment|/* 	 * PSEUDO_PHYAD is a special value for indicate switch attached. 	 * No one PHY use PSEUDO_PHYAD (0x1e) address. 	 */
ifndef|#
directive|ifndef
name|RT_MDIO
if|if
condition|(
name|phy
operator|==
literal|31
condition|)
block|{
comment|/* Fake PHY ID for bfeswitch attach */
switch|switch
condition|(
name|reg
condition|)
block|{
case|case
name|MII_BMSR
case|:
return|return
operator|(
name|BMSR_EXTSTAT
operator||
name|BMSR_MEDIAMASK
operator|)
return|;
case|case
name|MII_PHYIDR1
case|:
return|return
operator|(
literal|0x40
operator|)
return|;
comment|/* As result of faking */
case|case
name|MII_PHYIDR2
case|:
comment|/* PHY will detect as */
return|return
operator|(
literal|0x6250
operator|)
return|;
comment|/* bfeswitch */
block|}
block|}
endif|#
directive|endif
comment|/* Wait prev command done if any */
while|while
condition|(
name|RT_READ
argument_list|(
name|sc
argument_list|,
name|MDIO_ACCESS
argument_list|)
operator|&
name|MDIO_CMD_ONGO
condition|)
empty_stmt|;
name|dat
operator|=
operator|(
operator|(
name|phy
operator|<<
name|MDIO_PHY_ADDR_SHIFT
operator|)
operator|&
name|MDIO_PHY_ADDR_MASK
operator|)
operator||
operator|(
operator|(
name|reg
operator|<<
name|MDIO_PHYREG_ADDR_SHIFT
operator|)
operator|&
name|MDIO_PHYREG_ADDR_MASK
operator|)
expr_stmt|;
name|RT_WRITE
argument_list|(
name|sc
argument_list|,
name|MDIO_ACCESS
argument_list|,
name|dat
argument_list|)
expr_stmt|;
name|RT_WRITE
argument_list|(
name|sc
argument_list|,
name|MDIO_ACCESS
argument_list|,
name|dat
operator||
name|MDIO_CMD_ONGO
argument_list|)
expr_stmt|;
while|while
condition|(
name|RT_READ
argument_list|(
name|sc
argument_list|,
name|MDIO_ACCESS
argument_list|)
operator|&
name|MDIO_CMD_ONGO
condition|)
empty_stmt|;
return|return
operator|(
name|RT_READ
argument_list|(
name|sc
argument_list|,
name|MDIO_ACCESS
argument_list|)
operator|&
name|MDIO_PHY_DATA_MASK
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|rt_miibus_writereg
parameter_list|(
name|device_t
name|dev
parameter_list|,
name|int
name|phy
parameter_list|,
name|int
name|reg
parameter_list|,
name|int
name|val
parameter_list|)
block|{
name|struct
name|rt_softc
modifier|*
name|sc
init|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
decl_stmt|;
name|int
name|dat
decl_stmt|;
comment|/* Wait prev command done if any */
while|while
condition|(
name|RT_READ
argument_list|(
name|sc
argument_list|,
name|MDIO_ACCESS
argument_list|)
operator|&
name|MDIO_CMD_ONGO
condition|)
empty_stmt|;
name|dat
operator|=
name|MDIO_CMD_WR
operator||
operator|(
operator|(
name|phy
operator|<<
name|MDIO_PHY_ADDR_SHIFT
operator|)
operator|&
name|MDIO_PHY_ADDR_MASK
operator|)
operator||
operator|(
operator|(
name|reg
operator|<<
name|MDIO_PHYREG_ADDR_SHIFT
operator|)
operator|&
name|MDIO_PHYREG_ADDR_MASK
operator|)
operator||
operator|(
name|val
operator|&
name|MDIO_PHY_DATA_MASK
operator|)
expr_stmt|;
name|RT_WRITE
argument_list|(
name|sc
argument_list|,
name|MDIO_ACCESS
argument_list|,
name|dat
argument_list|)
expr_stmt|;
name|RT_WRITE
argument_list|(
name|sc
argument_list|,
name|MDIO_ACCESS
argument_list|,
name|dat
operator||
name|MDIO_CMD_ONGO
argument_list|)
expr_stmt|;
while|while
condition|(
name|RT_READ
argument_list|(
name|sc
argument_list|,
name|MDIO_ACCESS
argument_list|)
operator|&
name|MDIO_CMD_ONGO
condition|)
empty_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_ifdef
ifdef|#
directive|ifdef
name|IF_RT_PHY_SUPPORT
end_ifdef

begin_function
name|void
name|rt_miibus_statchg
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
name|struct
name|rt_softc
modifier|*
name|sc
init|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
decl_stmt|;
name|struct
name|mii_data
modifier|*
name|mii
decl_stmt|;
name|mii
operator|=
name|device_get_softc
argument_list|(
name|sc
operator|->
name|rt_miibus
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|mii
operator|->
name|mii_media_status
operator|&
operator|(
name|IFM_ACTIVE
operator||
name|IFM_AVALID
operator|)
operator|)
operator|==
operator|(
name|IFM_ACTIVE
operator||
name|IFM_AVALID
operator|)
condition|)
block|{
switch|switch
condition|(
name|IFM_SUBTYPE
argument_list|(
name|mii
operator|->
name|mii_media_active
argument_list|)
condition|)
block|{
case|case
name|IFM_10_T
case|:
case|case
name|IFM_100_TX
case|:
comment|/* XXX check link here */
name|sc
operator|->
name|flags
operator||=
literal|1
expr_stmt|;
break|break;
default|default:
break|break;
block|}
block|}
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* IF_RT_PHY_SUPPORT */
end_comment

begin_decl_stmt
specifier|static
name|device_method_t
name|rt_dev_methods
index|[]
init|=
block|{
name|DEVMETHOD
argument_list|(
name|device_probe
argument_list|,
name|rt_probe
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|device_attach
argument_list|,
name|rt_attach
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|device_detach
argument_list|,
name|rt_detach
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|device_shutdown
argument_list|,
name|rt_shutdown
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|device_suspend
argument_list|,
name|rt_suspend
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|device_resume
argument_list|,
name|rt_resume
argument_list|)
block|,
ifdef|#
directive|ifdef
name|IF_RT_PHY_SUPPORT
comment|/* MII interface */
name|DEVMETHOD
argument_list|(
name|miibus_readreg
argument_list|,
name|rt_miibus_readreg
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|miibus_writereg
argument_list|,
name|rt_miibus_writereg
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|miibus_statchg
argument_list|,
name|rt_miibus_statchg
argument_list|)
block|,
endif|#
directive|endif
name|DEVMETHOD_END
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|driver_t
name|rt_driver
init|=
block|{
literal|"rt"
block|,
name|rt_dev_methods
block|,
expr|sizeof
operator|(
expr|struct
name|rt_softc
operator|)
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|devclass_t
name|rt_dev_class
decl_stmt|;
end_decl_stmt

begin_expr_stmt
name|DRIVER_MODULE
argument_list|(
name|rt
argument_list|,
name|nexus
argument_list|,
name|rt_driver
argument_list|,
name|rt_dev_class
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
end_expr_stmt

begin_ifdef
ifdef|#
directive|ifdef
name|FDT
end_ifdef

begin_expr_stmt
name|DRIVER_MODULE
argument_list|(
name|rt
argument_list|,
name|simplebus
argument_list|,
name|rt_driver
argument_list|,
name|rt_dev_class
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
end_expr_stmt

begin_endif
endif|#
directive|endif
end_endif

begin_expr_stmt
name|MODULE_DEPEND
argument_list|(
name|rt
argument_list|,
name|ether
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|MODULE_DEPEND
argument_list|(
name|rt
argument_list|,
name|miibus
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|)
expr_stmt|;
end_expr_stmt

begin_ifdef
ifdef|#
directive|ifdef
name|RT_MDIO
end_ifdef

begin_expr_stmt
name|MODULE_DEPEND
argument_list|(
name|rt
argument_list|,
name|mdio
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|)
expr_stmt|;
end_expr_stmt

begin_function_decl
specifier|static
name|int
name|rtmdio_probe
parameter_list|(
name|device_t
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|rtmdio_attach
parameter_list|(
name|device_t
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|rtmdio_detach
parameter_list|(
name|device_t
parameter_list|)
function_decl|;
end_function_decl

begin_decl_stmt
specifier|static
name|struct
name|mtx
name|miibus_mtx
decl_stmt|;
end_decl_stmt

begin_expr_stmt
name|MTX_SYSINIT
argument_list|(
name|miibus_mtx
argument_list|,
operator|&
name|miibus_mtx
argument_list|,
literal|"rt mii lock"
argument_list|,
name|MTX_DEF
argument_list|)
expr_stmt|;
end_expr_stmt

begin_comment
comment|/*  * Declare an additional, separate driver for accessing the MDIO bus.  */
end_comment

begin_decl_stmt
specifier|static
name|device_method_t
name|rtmdio_methods
index|[]
init|=
block|{
comment|/* Device interface */
name|DEVMETHOD
argument_list|(
name|device_probe
argument_list|,
name|rtmdio_probe
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|device_attach
argument_list|,
name|rtmdio_attach
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|device_detach
argument_list|,
name|rtmdio_detach
argument_list|)
block|,
comment|/* bus interface */
name|DEVMETHOD
argument_list|(
name|bus_add_child
argument_list|,
name|device_add_child_ordered
argument_list|)
block|,
comment|/* MDIO access */
name|DEVMETHOD
argument_list|(
name|mdio_readreg
argument_list|,
name|rt_miibus_readreg
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|mdio_writereg
argument_list|,
name|rt_miibus_writereg
argument_list|)
block|, }
decl_stmt|;
end_decl_stmt

begin_expr_stmt
name|DEFINE_CLASS_0
argument_list|(
name|rtmdio
argument_list|,
name|rtmdio_driver
argument_list|,
name|rtmdio_methods
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|rt_softc
argument_list|)
argument_list|)
expr_stmt|;
end_expr_stmt

begin_decl_stmt
specifier|static
name|devclass_t
name|rtmdio_devclass
decl_stmt|;
end_decl_stmt

begin_expr_stmt
name|DRIVER_MODULE
argument_list|(
name|miiproxy
argument_list|,
name|rt
argument_list|,
name|miiproxy_driver
argument_list|,
name|miiproxy_devclass
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|DRIVER_MODULE
argument_list|(
name|rtmdio
argument_list|,
name|simplebus
argument_list|,
name|rtmdio_driver
argument_list|,
name|rtmdio_devclass
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|DRIVER_MODULE
argument_list|(
name|mdio
argument_list|,
name|rtmdio
argument_list|,
name|mdio_driver
argument_list|,
name|mdio_devclass
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
end_expr_stmt

begin_function
specifier|static
name|int
name|rtmdio_probe
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
if|if
condition|(
operator|!
name|ofw_bus_status_okay
argument_list|(
name|dev
argument_list|)
condition|)
return|return
operator|(
name|ENXIO
operator|)
return|;
if|if
condition|(
operator|!
name|ofw_bus_is_compatible
argument_list|(
name|dev
argument_list|,
literal|"ralink,rt2880-mdio"
argument_list|)
condition|)
return|return
operator|(
name|ENXIO
operator|)
return|;
name|device_set_desc
argument_list|(
name|dev
argument_list|,
literal|"FV built-in ethernet interface, MDIO controller"
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|rtmdio_attach
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
name|struct
name|rt_softc
modifier|*
name|sc
decl_stmt|;
name|int
name|error
decl_stmt|;
name|sc
operator|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
expr_stmt|;
name|sc
operator|->
name|dev
operator|=
name|dev
expr_stmt|;
name|sc
operator|->
name|mem_rid
operator|=
literal|0
expr_stmt|;
name|sc
operator|->
name|mem
operator|=
name|bus_alloc_resource_any
argument_list|(
name|dev
argument_list|,
name|SYS_RES_MEMORY
argument_list|,
operator|&
name|sc
operator|->
name|mem_rid
argument_list|,
name|RF_ACTIVE
operator||
name|RF_SHAREABLE
argument_list|)
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|mem
operator|==
name|NULL
condition|)
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"couldn't map memory\n"
argument_list|)
expr_stmt|;
name|error
operator|=
name|ENXIO
expr_stmt|;
goto|goto
name|fail
goto|;
block|}
name|sc
operator|->
name|bst
operator|=
name|rman_get_bustag
argument_list|(
name|sc
operator|->
name|mem
argument_list|)
expr_stmt|;
name|sc
operator|->
name|bsh
operator|=
name|rman_get_bushandle
argument_list|(
name|sc
operator|->
name|mem
argument_list|)
expr_stmt|;
name|bus_generic_probe
argument_list|(
name|dev
argument_list|)
expr_stmt|;
name|bus_enumerate_hinted_children
argument_list|(
name|dev
argument_list|)
expr_stmt|;
name|error
operator|=
name|bus_generic_attach
argument_list|(
name|dev
argument_list|)
expr_stmt|;
name|fail
label|:
return|return
operator|(
name|error
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|rtmdio_detach
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

end_unit

